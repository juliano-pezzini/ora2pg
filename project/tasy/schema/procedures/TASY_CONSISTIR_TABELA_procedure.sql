-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE tasy_consistir_tabela ( nm_tabela_p text, ie_base_wheb_p text default 'N', nr_seq_versao_p bigint default 0) AS $body$
DECLARE


/*
ie_base_wheb_w
N - Impede a execução na base da Wheb. Na base do cliente consiste todas as tabelas do sistema
S - Irá consistir apenas as tabelas que o usuário alterou
T - Consiste todas as tabelas na base da WHEB.
*/
nm_tabela_w       varchar(50);
nm_objeto_w       varchar(50);
nm_usuario_w      varchar(50);
dt_atualizacao_w	timestamp;
ds_motivo_w       varchar(255);
ie_tipo_w	        varchar(10);
ds_erro_w         varchar(512);
ie_base_wheb_w		varchar(10)	:= coalesce(ie_base_wheb_p,'N');
dt_dia_anterior_w timestamp;
dt_janeiro_2012_w timestamp;
dt_julho_2012_w   timestamp;
/*Verificar tabelas que estão documentadas e não estão na base*/

C01 CURSOR FOR
	SELECT	a.nm_tabela,
		'',
		a.nm_usuario,
		a.dt_atualizacao,
		obter_desc_expressao(647305) --'Tabela inexistente'
	from	tabela_sistema a
	where	Gerar_Objeto_Aplicacao(a.ds_aplicacao) = 'S'
	and	ie_base_wheb_w = 'S'
	and	a.ie_sincronizar_wheb = 'S'
	and a.nm_tabela = nm_tabela_p
	and	not exists (SELECT 1
				from	user_tables b
				where	a.nm_tabela = b.table_name)
	
union

	select	a.nm_tabela,
		'',
		a.nm_usuario,
		a.dt_atualizacao,
		obter_desc_expressao(647305) --'Tabela inexistente'
	from	tabela_sistema a
	where	Gerar_Objeto_Aplicacao(a.ds_aplicacao) = 'S'
	and		ie_base_wheb_w IN ('N','T')
	and 	a.nm_tabela = nm_tabela_p
	and		not exists (	select 1
							from	user_tables b
							where	a.nm_tabela = b.table_name);

/*Verificar campos de tabelas que estão documentadas e não estão na base*/

C02 CURSOR FOR
	SELECT	a.nm_tabela,
		c.nm_atributo,
		c.nm_usuario,
		c.dt_atualizacao,
		obter_desc_expressao(786609) --'Campo inexistente'
	from	tabela_sistema a,
		tabela_atributo c
	where	a.nm_tabela = c.nm_tabela
	and	ie_base_wheb_w = 'S'
	and	a.ie_sincronizar_wheb = 'S'
	and	c.ie_tipo_atributo in ('LONG','LONG RAW','NUMBER','VARCHAR2','DATE','BLOB','CLOB')
	and	Gerar_Objeto_Aplicacao(a.ds_aplicacao) = 'S'
	and 	a.nm_tabela = nm_tabela_p
	and	not exists (SELECT 1
				from	user_tab_columns b
				where	a.nm_tabela = b.table_name
				and	b.table_name = c.nm_tabela
				and	b.column_name = c.nm_atributo)
	
union

	select	a.nm_tabela,
		c.nm_atributo,
		c.nm_usuario,
		c.dt_atualizacao,
		obter_desc_expressao(786609) --'Campo inexistente'
	from	tabela_sistema a,
		tabela_atributo c
	where	a.nm_tabela = c.nm_tabela
	and	ie_base_wheb_w IN ('N','T')
	and 	a.nm_tabela = nm_tabela_p
	and	c.ie_tipo_atributo in ('LONG','LONG RAW','NUMBER','VARCHAR2','DATE','BLOB','CLOB')
	and	Gerar_Objeto_Aplicacao(a.ds_aplicacao) = 'S'
	and	not exists (select 1
				from	user_tab_columns b
				where	a.nm_tabela = b.table_name
				and	b.table_name = c.nm_tabela
				and	b.column_name = c.nm_atributo);

/*Verificar diferença de tipos campos de tabelas que estão documentadas com os campos da base*/

C03 CURSOR FOR
	SELECT	a.nm_tabela,
		b.nm_atributo,
		b.nm_usuario,
		b.dt_atualizacao,
		obter_desc_expressao(786611) --'Tipo campo inconsistente'
	from	tabela_sistema a,
		tabela_atributo b,
		user_tab_columns c
	where	a.nm_tabela = b.nm_tabela
	and 	a.nm_tabela = nm_tabela_p
	and	ie_base_wheb_w = 'S'
	and	a.ie_sincronizar_wheb = 'S'
	and	b.ie_tipo_atributo in ('LONG','LONG RAW','NUMBER','VARCHAR2','DATE','BLOB','CLOB')
	and	Gerar_Objeto_Aplicacao(a.ds_aplicacao) = 'S'
	and	a.nm_tabela = c.table_name
	and	c.table_name = b.nm_tabela
	and	c.column_name = b.nm_atributo
	and	c.data_type <> b.ie_tipo_atributo
	
union

	SELECT	a.nm_tabela,
		b.nm_atributo,
		b.nm_usuario,
		b.dt_atualizacao,
		obter_desc_expressao(786611) --'Tipo campo inconsistente'
	from	tabela_sistema a,
		tabela_atributo b,
		user_tab_columns c
	where	a.nm_tabela = b.nm_tabela
	and 	a.nm_tabela = nm_tabela_p
	and	ie_base_wheb_w IN ('N','T')
	and	b.ie_tipo_atributo in ('LONG','LONG RAW','NUMBER','VARCHAR2','DATE','BLOB','CLOB')
	and	Gerar_Objeto_Aplicacao(a.ds_aplicacao) = 'S'
	and	a.nm_tabela = c.table_name
	and	c.table_name = b.nm_tabela
	and	c.column_name = b.nm_atributo
	and	c.data_type <> b.ie_tipo_atributo;


/*Verificar diferença de tamanho campos de tabelas que estão documentadas com os campos da base VARCHAR/NUMBER*/

C04 CURSOR FOR
	SELECT	a.nm_tabela,
		b.nm_atributo,
		b.nm_usuario,
		b.dt_atualizacao,
		obter_desc_expressao(786615) --'Tamanho/precisão do campo inconsistente'
	from	tabela_sistema a,
		tabela_atributo b,
		user_tab_columns c
	where	a.nm_tabela = b.nm_tabela
	and 	a.nm_tabela = nm_tabela_p
	and	ie_base_wheb_w = 'S'
	and	a.ie_sincronizar_wheb = 'S'
	and	b.ie_tipo_atributo = 'VARCHAR2'
	and	Gerar_Objeto_Aplicacao(a.ds_aplicacao) = 'S'
	and	a.nm_tabela = c.table_name
	and	c.table_name = b.nm_tabela
	and	c.column_name = b.nm_atributo
	and	c.data_type = b.ie_tipo_atributo
	and	c.char_length <> b.qt_tamanho
	
union

	SELECT	a.nm_tabela,
		b.nm_atributo,
		b.nm_usuario,
		b.dt_atualizacao,
		obter_desc_expressao(786615) --'Tamanho/precisão do campo inconsistente'
	from	tabela_sistema a,
		tabela_atributo b,
		user_tab_columns c
	where	a.nm_tabela = b.nm_tabela
	and 	a.nm_tabela = nm_tabela_p
	and	ie_base_wheb_w = 'S'
	and	a.ie_sincronizar_wheb = 'S'
	and	b.ie_tipo_atributo = 'NUMBER'
	and	Gerar_Objeto_Aplicacao(a.ds_aplicacao) = 'S'
	and	a.nm_tabela = c.table_name
	and	c.table_name = b.nm_tabela
	and	c.column_name = b.nm_atributo
	and	c.data_type = b.ie_tipo_atributo
	and (c.data_precision <> b.qt_tamanho or c.data_scale <> b.qt_decimais)
	
union

	select	a.nm_tabela,
		b.nm_atributo,
		b.nm_usuario,
		b.dt_atualizacao,
		obter_desc_expressao(786615) --'Tamanho/precisão do campo inconsistente'
	from	tabela_sistema a,
		tabela_atributo b,
		user_tab_columns c
	where	a.nm_tabela = b.nm_tabela
	and 	a.nm_tabela = nm_tabela_p
	and	ie_base_wheb_w IN ('N','T')
	and	b.ie_tipo_atributo = 'VARCHAR2'
	and	Gerar_Objeto_Aplicacao(a.ds_aplicacao) = 'S'
	and	a.nm_tabela = c.table_name
	and	c.table_name = b.nm_tabela
	and	c.column_name = b.nm_atributo
	and	c.data_type = b.ie_tipo_atributo
	and	c.char_length <> b.qt_tamanho
	
union

	select	a.nm_tabela,
		b.nm_atributo,
		b.nm_usuario,
		b.dt_atualizacao,
		obter_desc_expressao(786615) --'Tamanho/precisão do campo inconsistente'
	from	tabela_sistema a,
		tabela_atributo b,
		user_tab_columns c
	where	a.nm_tabela = b.nm_tabela
	and 	a.nm_tabela = nm_tabela_p
	and	ie_base_wheb_w IN ('N','T')
	and	b.ie_tipo_atributo = 'NUMBER'
	and	Gerar_Objeto_Aplicacao(a.ds_aplicacao) = 'S'
	and	a.nm_tabela = c.table_name
	and	c.table_name = b.nm_tabela
	and	c.column_name = b.nm_atributo
	and	c.data_type = b.ie_tipo_atributo
	and (c.data_precision <> b.qt_tamanho or c.data_scale <> b.qt_decimais);

/*Verificar diferença de obrigatoriedade entre campos de tabelas que estão documentadas com os campos da base*/

C05 CURSOR FOR
	SELECT	a.nm_tabela,
		b.nm_atributo,
		b.nm_usuario,
		b.dt_atualizacao,
		obter_desc_expressao(667859) --'Obrigatoriedade inconsistente'
	from	tabela_sistema a,
		tabela_atributo b,
		user_tab_columns c
	where	a.nm_tabela = b.nm_tabela
	and 	a.nm_tabela = nm_tabela_p
	and	ie_base_wheb_w = 'S'
	and	a.ie_sincronizar_wheb = 'S'
	and	Gerar_Objeto_Aplicacao(a.ds_aplicacao) = 'S'
	and	a.nm_tabela = c.table_name
	and	c.table_name = b.nm_tabela
	and	c.column_name = b.nm_atributo
	and	c.nullable  = 'N'
	and	b.ie_obrigatorio = 'N'
	
union

	SELECT	a.nm_tabela,
		b.nm_atributo,
		b.nm_usuario,
		b.dt_atualizacao,
		obter_desc_expressao(667859) --'Obrigatoriedade inconsistente'
	from	tabela_sistema a,
		tabela_atributo b,
		user_tab_columns c
	where	a.nm_tabela = b.nm_tabela
	and 	a.nm_tabela = nm_tabela_p
	and	ie_base_wheb_w IN ('N','T')
	and	Gerar_Objeto_Aplicacao(a.ds_aplicacao) = 'S'
	and	a.nm_tabela = c.table_name
	and	c.table_name = b.nm_tabela
	and	c.column_name = b.nm_atributo
	and	c.nullable  = 'N'
	and	b.ie_obrigatorio = 'N';

/*Verificar indices estão documentados e não estão na base*/

c06 CURSOR FOR
	SELECT	a.nm_tabela,
		b.nm_indice,
		b.nm_usuario,
		b.dt_atualizacao,
		obter_desc_expressao(308800), --'Indice inexistente',
		b.ie_tipo
	from	tabela_sistema a,
		indice b
	where	a.nm_tabela = b.nm_tabela
	and 	a.nm_tabela = nm_tabela_p
	and	ie_base_wheb_w = 'S'
	and	b.ie_classificacao <> 'IC'
	and	a.ie_sincronizar_wheb = 'S'
	and	Gerar_Objeto_Aplicacao(a.ds_aplicacao) = 'S'
	and	not exists (SELECT 1
				from	user_indexes c
				where	a.nm_tabela = c.table_name
				and	b.nm_indice = c.index_name)
	
union

	select	a.nm_tabela,
		b.nm_indice,
		b.nm_usuario,
		b.dt_atualizacao,
		obter_desc_expressao(308800), --'Indice inexistente',
		b.ie_tipo
	from	tabela_sistema a,
		indice b
	where	a.nm_tabela = b.nm_tabela
	and 	a.nm_tabela = nm_tabela_p
	and	ie_base_wheb_w IN ('N','T')
	and	b.ie_classificacao <> 'IC'
	and	Gerar_Objeto_Aplicacao(a.ds_aplicacao) = 'S'
	and	not exists (select 1
				from	user_indexes c
				where	a.nm_tabela = c.table_name
				and	b.nm_indice = c.index_name);
/*Verificar campos dos indices que estão documentados e não estão em conformidade com a base*/

c07 CURSOR FOR
	SELECT	a.nm_tabela,
		b.nm_indice,
		b.nm_usuario,
		b.dt_atualizacao,
		obter_desc_expressao(786617) --'Composição dos campos do indice'
	from	tabela_sistema a,
		indice_atributo b,
		indice d,
		user_indexes c
	where	a.nm_tabela = b.nm_tabela
	and 	a.nm_tabela = nm_tabela_p
	and	ie_base_wheb_w = 'S'
	and	d.ie_classificacao <> 'IC'
	and	a.ie_sincronizar_wheb = 'S'
	and	Gerar_Objeto_Aplicacao(a.ds_aplicacao) = 'S'
	and	a.nm_tabela = c.table_name
	and	b.nm_indice = c.index_name
	and	b.nm_indice = d.nm_indice
	and	d.nm_tabela = a.nm_tabela
	and	d.ie_tipo <> 'IF'
	and	not exists ( SELECT 1
				from 	user_ind_columns d
				where	d.table_name = c.table_name
				and	d.index_name = c.index_name
				and	d.column_name = b.nm_atributo)
	
union

	select	a.nm_tabela,
		b.nm_indice,
		b.nm_usuario,
		b.dt_atualizacao,
		obter_desc_expressao(786617) --'Composição dos campos do indice'
	from	tabela_sistema a,
		indice_atributo b,
		indice d,
		user_indexes c
	where	a.nm_tabela = b.nm_tabela
	and 	a.nm_tabela = nm_tabela_p
	and	ie_base_wheb_w IN ('N','T')
	and	d.ie_classificacao <> 'IC'
	and	Gerar_Objeto_Aplicacao(a.ds_aplicacao) = 'S'
	and	a.nm_tabela = c.table_name
	and	b.nm_indice = c.index_name
	and	b.nm_indice = d.nm_indice
	and	d.nm_tabela = a.nm_tabela
	and	d.ie_tipo <> 'IF'
	and	not exists ( select 1
				from 	user_ind_columns d
				where	d.table_name = c.table_name
				and	d.index_name = c.index_name
				and	d.column_name = b.nm_atributo)
	
union

 	select 	a.nm_tabela,
		d.nm_indice,
		d.nm_usuario,
		d.dt_atualizacao,
		obter_desc_expressao(786617) --'Composição dos campos do indice'
	 from 	tabela_sistema a,
		user_ind_columns b,
		indice d,
		user_indexes c
	 where 	a.nm_tabela = b.table_name
	 and 	a.nm_tabela = nm_tabela_p
	 and	ie_base_wheb_w = 'S'
	 and	d.ie_classificacao <> 'IC'
	 and	a.ie_sincronizar_wheb = 'S'
	 and	Gerar_Objeto_Aplicacao(a.ds_aplicacao) = 'S'
	 and 	a.nm_tabela = c.table_name
	 and 	b.index_name = c.index_name
	 and 	b.index_name = d.nm_indice
	 and 	d.nm_tabela = a.nm_tabela
	 and 	d.ie_tipo <> 'IF'
	 and 	not exists ( 	select	1
    				from  	indice_atributo d
				where 	d.nm_tabela = c.table_name
				and 	d.nm_indice = c.index_name
				and 	b.column_name = d.nm_atributo)
	
union

 	 select a.nm_tabela,
		d.nm_indice,
		d.nm_usuario,
		d.dt_atualizacao,
		obter_desc_expressao(786617) --'Composição dos campos do indice'
	 from 	tabela_sistema a,
		user_ind_columns b,
		indice d,
		user_indexes c
	 where 	a.nm_tabela = b.table_name
	 and 	a.nm_tabela = nm_tabela_p
	 and	d.ie_classificacao <> 'IC'
	 and	ie_base_wheb_w IN ('N','T')
 	 and	Gerar_Objeto_Aplicacao(a.ds_aplicacao) = 'S'
	 and 	a.nm_tabela = c.table_name
	 and 	b.index_name = c.index_name
	 and 	b.index_name = d.nm_indice
	 and 	d.nm_tabela = a.nm_tabela
	 and 	d.ie_tipo <> 'IF'
 	 and	b.column_name not like 'SYS%' -- tratamento adicionado para campos de índices customizados, não pode comparar com campos de tabela
	 and 	not exists ( 	select	1
    				from  	indice_atributo d
				where 	d.nm_tabela = c.table_name
				and 	d.nm_indice = c.index_name
				and 	b.column_name = d.nm_atributo);

/*Verificar se a ordem dos campos dos indices que estão documentados e não estão em conformidade com a base*/

c08 CURSOR FOR
	SELECT	a.nm_tabela,
		b.nm_indice,
		b.nm_usuario,
		b.dt_atualizacao,
		obter_desc_expressao(786621) --'Ordem dos campos do indice'
	from	tabela_sistema a,
		indice_atributo b,
		indice d,
		user_indexes c,
		user_ind_columns d
	where	a.nm_tabela = b.nm_tabela
	and 	a.nm_tabela = nm_tabela_p
	and	ie_base_wheb_w = 'S'
	and	d.ie_classificacao <> 'IC'
	and	a.ie_sincronizar_wheb = 'S'
	and	Gerar_Objeto_Aplicacao(a.ds_aplicacao) = 'S'
	and	a.nm_tabela = c.table_name
	and	b.nm_indice = c.index_name
	and	b.nm_indice = d.nm_indice
	and	d.nm_tabela = a.nm_tabela
	and	d.ie_tipo <> 'IF'
	and	d.table_name = c.table_name
	and	d.index_name = c.index_name
	and	d.column_name = b.nm_atributo
	and	d.column_position <> b.nr_sequencia
	
union

	SELECT	a.nm_tabela,
		b.nm_indice,
		b.nm_usuario,
		b.dt_atualizacao,
		obter_desc_expressao(786621) --'Ordem dos campos do indice'
	from	tabela_sistema a,
		indice_atributo b,
		indice d,
		user_indexes c,
		user_ind_columns d
	where	a.nm_tabela = b.nm_tabela
	and 	a.nm_tabela = nm_tabela_p
	and	d.ie_classificacao <> 'IC'
	and	ie_base_wheb_w IN ('N','T')
	and	Gerar_Objeto_Aplicacao(a.ds_aplicacao) = 'S'
	and	a.nm_tabela = c.table_name
	and	b.nm_indice = c.index_name
	and	b.nm_indice = d.nm_indice
	and	d.nm_tabela = a.nm_tabela
	and	d.ie_tipo <> 'IF'
	and	d.table_name = c.table_name
	and	d.index_name = c.index_name
	and	d.column_name = b.nm_atributo
	and	d.column_position <> b.nr_sequencia
	and	coalesce(b.ds_indice_function::text, '') = ''; -- tratamento adicionado para campos de índices customizados, não pode comparar com campos de tabela

/*Verificar integridades estão documentadas e não estão na base*/

c09 CURSOR FOR
	SELECT	a.nm_tabela,
		b.nm_integridade_referencial,
		b.nm_usuario,
		b.dt_atualizacao,
		obter_desc_expressao(786623) --'Integridade inexistente'
	from	tabela_sistema a,
		integridade_referencial b
	where	a.nm_tabela = b.nm_tabela
	and 	a.nm_tabela = nm_tabela_p
	and	ie_base_wheb_w = 'S'
	and	a.ie_sincronizar_wheb = 'S'
	and	Gerar_Objeto_Aplicacao(a.ds_aplicacao) = 'S'
	and	not exists (SELECT 1
				from	user_constraints c
				where	a.nm_tabela = c.table_name
				and	b.nm_integridade_referencial = c.constraint_name)
	
union

	select	a.nm_tabela,
		b.nm_integridade_referencial,
		b.nm_usuario,
		b.dt_atualizacao,
		obter_desc_expressao(786623) --'Integridade inexistente'
	from	tabela_sistema a,
		integridade_referencial b
	where	a.nm_tabela = b.nm_tabela
	and 	a.nm_tabela = nm_tabela_p
	and	ie_base_wheb_w IN ('N','T')
	and	Gerar_Objeto_Aplicacao(a.ds_aplicacao) = 'S'
	and	not exists (select 1
				from	user_constraints c
				where	a.nm_tabela = c.table_name
				and	b.nm_integridade_referencial = c.constraint_name)
	
union

	select	a.nm_tabela,
		b.nm_indice,
		b.nm_usuario,
		b.dt_atualizacao,
		obter_desc_expressao(786623) --'Integridade inexistente'
	from	tabela_sistema a,
		indice b
	where	a.nm_tabela = b.nm_tabela
	and 	a.nm_tabela = nm_tabela_p
	and	b.ie_classificacao <> 'IC'
	and	b.ie_tipo in ('PK','UK')
	and	ie_base_wheb_w = 'S'
	and	a.ie_sincronizar_wheb = 'S'
	and	Gerar_Objeto_Aplicacao(a.ds_aplicacao) = 'S'
	and	not exists (select 1
				from	user_constraints c
				where	a.nm_tabela = c.table_name
				and	b.nm_indice = c.constraint_name)
	
union

	select	a.nm_tabela,
		b.nm_indice,
		b.nm_usuario,
		b.dt_atualizacao,
		obter_desc_expressao(786623) --'Integridade inexistente'
	from	tabela_sistema a,
		indice b
	where	a.nm_tabela = b.nm_tabela
	and 	a.nm_tabela = nm_tabela_p
	and	b.ie_classificacao <> 'IC'
	and	b.ie_tipo in ('PK','UK')
	and	ie_base_wheb_w IN ('N','T')
	and	Gerar_Objeto_Aplicacao(a.ds_aplicacao) = 'S'
	and	not exists (select 1
				from	user_constraints c
				where	a.nm_tabela = c.table_name
				and	b.nm_indice = c.constraint_name);


/*Verificar a regra de deleção das integridades estão documentadas e não estão na base*/

c10 CURSOR FOR
	SELECT	a.nm_tabela,
		b.nm_integridade_referencial,
		b.nm_usuario,
		b.dt_atualizacao,
		obter_desc_expressao(786623) --'Integridade inexistente'
	from	tabela_sistema a,
		integridade_referencial b,
		user_constraints c
	where	a.nm_tabela = b.nm_tabela
	and 	a.nm_tabela = nm_tabela_p
	and	ie_base_wheb_w = 'S'
	and	a.ie_sincronizar_wheb = 'S'
	and	Gerar_Objeto_Aplicacao(a.ds_aplicacao) = 'S'
	and	a.nm_tabela = c.table_name
	and	b.nm_integridade_referencial = c.constraint_name
	and	b.ie_regra_delecao <> c.delete_rule
	
union

	SELECT	a.nm_tabela,
		b.nm_integridade_referencial,
		b.nm_usuario,
		b.dt_atualizacao,
		obter_desc_expressao(786623) --'Integridade inexistente'
	from	tabela_sistema a,
		integridade_referencial b,
		user_constraints c
	where	a.nm_tabela = b.nm_tabela
	and 	a.nm_tabela = nm_tabela_p
	and	ie_base_wheb_w IN ('N','T')
	and	Gerar_Objeto_Aplicacao(a.ds_aplicacao) = 'S'
	and	a.nm_tabela = c.table_name
	and	b.nm_integridade_referencial = c.constraint_name
	and	b.ie_regra_delecao <> c.delete_rule;

/*Verificar campos das integridades estão documentadas e não estão na base*/

c11 CURSOR FOR
	SELECT	a.nm_tabela,
		b.nm_integridade_referencial,
		b.nm_usuario,
		b.dt_atualizacao,
		obter_desc_expressao(786625) --'Composição dos campos da integridade'
	from	tabela_sistema a,
		integridade_atributo b,
		user_constraints c
	where	a.nm_tabela = b.nm_tabela
	and 	a.nm_tabela = nm_tabela_p
	and	ie_base_wheb_w = 'S'
	and	a.ie_sincronizar_wheb = 'S'
	and	Gerar_Objeto_Aplicacao(a.ds_aplicacao) = 'S'
	and	a.nm_tabela = c.table_name
	and	b.nm_integridade_referencial = c.constraint_name
	and	not exists (SELECT 1
				from 	user_cons_columns d
				where	c.constraint_name = d.constraint_name
				and	c.table_name = d.table_name
				and	b.nm_atributo = d.column_name)
	
union

	select	a.nm_tabela,
		b.nm_integridade_referencial,
		b.nm_usuario,
		b.dt_atualizacao,
		obter_desc_expressao(786625) --'Composição dos campos da integridade'
	from	tabela_sistema a,
		integridade_atributo b,
		user_constraints c
	where	a.nm_tabela = b.nm_tabela
	and 	a.nm_tabela = nm_tabela_p
	and	ie_base_wheb_w IN ('N','T')
	and	Gerar_Objeto_Aplicacao(a.ds_aplicacao) = 'S'
	and	a.nm_tabela = c.table_name
	and	b.nm_integridade_referencial = c.constraint_name
	and	not exists (select 1
				from 	user_cons_columns d
				where	c.constraint_name = d.constraint_name
				and	c.table_name = d.table_name
				and	b.nm_atributo = d.column_name);
/*Verificar se a ordem campos das integridades estão documentadas e não estão na base*/

c12 CURSOR FOR
	SELECT	a.nm_tabela,
		b.nm_integridade_referencial,
		b.nm_usuario,
		b.dt_atualizacao,
		obter_desc_expressao(786631) --'Ordem dos campos da integridade'
	from	tabela_sistema a,
		integridade_atributo b,
		user_constraints c,
		user_cons_columns d
	where	a.nm_tabela = b.nm_tabela
	and 	a.nm_tabela = nm_tabela_p
	and	ie_base_wheb_w = 'S'
	and	a.ie_sincronizar_wheb = 'S'
	and	Gerar_Objeto_Aplicacao(a.ds_aplicacao) = 'S'
	and	a.nm_tabela = c.table_name
	and	b.nm_integridade_referencial = c.constraint_name
	and	c.constraint_name = d.constraint_name
	and	c.table_name = d.table_name
	and	b.nm_atributo = d.column_name
	and	d.position <> b.ie_sequencia_criacao
	
union

	SELECT	a.nm_tabela,
		b.nm_integridade_referencial,
		b.nm_usuario,
		b.dt_atualizacao,
		obter_desc_expressao(786631) --'Ordem dos campos da integridade'
	from	tabela_sistema a,
		integridade_atributo b,
		user_constraints c,
		user_cons_columns d
	where	a.nm_tabela = b.nm_tabela
	and 	a.nm_tabela = nm_tabela_p
	and	ie_base_wheb_w IN ('N','T')
	and	Gerar_Objeto_Aplicacao(a.ds_aplicacao) = 'S'
	and	a.nm_tabela = c.table_name
	and	b.nm_integridade_referencial = c.constraint_name
	and	c.constraint_name = d.constraint_name
	and	c.table_name = d.table_name
	and	b.nm_atributo = d.column_name
	and	d.position <> b.ie_sequencia_criacao;

/*Verificar se o indice utilizado pela integridade está correto - PK e UK*/

c13 CURSOR FOR
	SELECT	a.nm_tabela,
		b.nm_indice,
		b.nm_usuario,
		b.dt_atualizacao,
		obter_desc_expressao(786633) --'Indice incorreto da integridade'
	from	tabela_sistema a,
		indice b,
		user_constraints c
	where	a.nm_tabela = b.nm_tabela
	and 	a.nm_tabela = nm_tabela_p
	and	ie_base_wheb_w = 'S'
	and	b.ie_classificacao <> 'IC'
	and	a.ie_sincronizar_wheb = 'S'
	and	Gerar_Objeto_Aplicacao(a.ds_aplicacao) = 'S'
	and	a.nm_tabela = c.table_name
	and	c.constraint_type in ('P','U')
	and	b.nm_indice = c.constraint_name
	and	b.nm_indice <> coalesce(c.index_name,'')
	
union

	SELECT	a.nm_tabela,
		b.nm_indice,
		b.nm_usuario,
		b.dt_atualizacao,
		obter_desc_expressao(786633) --'Indice incorreto da integridade'
	from	tabela_sistema a,
		indice b,
		user_constraints c
	where	a.nm_tabela = b.nm_tabela
	and 	a.nm_tabela = nm_tabela_p
	and	ie_base_wheb_w IN ('N','T')
	and	b.ie_classificacao <> 'IC'
	and	Gerar_Objeto_Aplicacao(a.ds_aplicacao) = 'S'
	and	a.nm_tabela = c.table_name
	and	c.constraint_type in ('P','U')
	and	b.nm_indice = c.constraint_name
	and	b.nm_indice <> coalesce(c.index_name,'');

/*Verificar objetos estão documentadas e não estão na base*/

C14 CURSOR FOR
	SELECT	a.ie_tipo_objeto,
		a.nm_objeto,
		a.nm_usuario,
		a.dt_atualizacao,
		obter_desc_expressao(786635) --'Objeto inexistente'
	from	objeto_sistema a
	where	a.ie_tipo_objeto in ('Procedure','View','Trigger','Function','Package','Base')
	and	ie_base_wheb_w = 'S'
  and	a.dt_atualizacao > dt_dia_anterior_w
	and	Gerar_Objeto_Aplicacao(a.ds_aplicacao) = 'S'
	and	not exists (SELECT 1
				from	user_objects b
				where	a.nm_objeto = b.object_name)
	
union

	select	a.ie_tipo_objeto,
		a.nm_objeto,
		a.nm_usuario,
		a.dt_atualizacao,
		obter_desc_expressao(786635) --'Objeto inexistente'
	from	objeto_sistema a
	where	a.ie_tipo_objeto in ('Procedure','View','Trigger','Function','Package','Base')
	and	ie_base_wheb_w IN ('N','T')
	and	Gerar_Objeto_Aplicacao(a.ds_aplicacao) = 'S'
	and	not exists (select 1
				from	user_objects b
				where	a.nm_objeto = b.object_name);

/*Verifica constraints desabilitadas no banco*/

C15 CURSOR FOR
	SELECT	a.table_name,
		a.constraint_name,
		c.nm_usuario,
		c.dt_atualizacao,
		obter_desc_expressao(308367) --'Integridades desabilitadas'
	from	user_constraints a,
		tabela_sistema b,
		integridade_referencial c
	where	c.nm_tabela = b.nm_tabela
	and 	b.nm_tabela = nm_tabela_p
	and	a.table_name = b.nm_tabela
	and	a.constraint_name = c.nm_integridade_referencial
	and	a.status = 'DISABLED'
	and	ie_base_wheb_w = 'S'
	and	b.ie_sincronizar_wheb = 'S'
	and	Gerar_Objeto_Aplicacao(b.ds_aplicacao) = 'S'
	
union

	SELECT	a.table_name,
		a.constraint_name,
		c.nm_usuario,
		c.dt_atualizacao,
		obter_desc_expressao(308367) --'Integridades desabilitadas'
	from	user_constraints a,
		tabela_sistema b,
		integridade_referencial c
	where	c.nm_tabela = b.nm_tabela
	and 	b.nm_tabela = nm_tabela_p
	and	a.table_name = b.nm_tabela
	and	a.constraint_name = c.nm_integridade_referencial
	and	a.status = 'DISABLED'
	and	ie_base_wheb_w IN ('N','T')
	and	Gerar_Objeto_Aplicacao(b.ds_aplicacao) = 'S';

/*Indices unicos criados na base sem a CONSTRAINT*/

C16 CURSOR FOR
	SELECT	a.table_name,
		a.index_name,
		b.nm_usuario,
		b.dt_atualizacao,
		obter_desc_expressao(786637) --'Indice único sem constraint'
	from	user_indexes a,
		indice b,
		tabela_sistema c
	where	a.table_name = c.nm_tabela
	and 	c.nm_tabela = nm_tabela_p
	and	c.nm_tabela  = b.nm_tabela
	and	a.index_name = b.nm_indice
	and	b.ie_classificacao <> 'IC'
	and	ie_base_wheb_w = 'S'
	and	c.ie_sincronizar_wheb = 'S'
	and	Gerar_Objeto_Aplicacao(c.ds_aplicacao) = 'S'
	and	b.ie_tipo <> 'I'
	and	b.ie_tipo <> 'IU'
	and (a.index_name like '%_PK' or
		a.index_name like '%_UK')
	and	not exists (	SELECT	1
				from	user_constraints b
				where	a.table_name = b.table_name
				and	a.index_name = b.constraint_name)
	
union

	select	a.table_name,
		a.index_name,
		b.nm_usuario,
		b.dt_atualizacao,
		obter_desc_expressao(786637) --'Indice único sem constraint'
	from	user_indexes a,
		indice b,
		tabela_sistema c
	where	a.table_name = c.nm_tabela
	and 	c.nm_tabela = nm_tabela_p
	and	c.nm_tabela  = b.nm_tabela
	and	b.ie_classificacao <> 'IC'
	and	a.index_name = b.nm_indice
	and	ie_base_wheb_w IN ('N','T')
	and	Gerar_Objeto_Aplicacao(c.ds_aplicacao) = 'S'
	and	b.ie_tipo <> 'I'
	and	b.ie_tipo <> 'IU'
	and (a.index_name like '%_PK' or
		a.index_name like '%_UK')
	and	not exists (	select	1
				from	user_constraints b
				where	a.table_name = b.table_name
				and	a.index_name = b.constraint_name);

/*Triggers desabilitadas*/

C17 CURSOR FOR
	SELECT	a.ie_tipo_objeto,
		a.nm_objeto,
		a.nm_usuario,
		a.dt_atualizacao,
		obter_desc_expressao(308368) --'Triggers desabilitadas'
	FROM	objeto_sistema a,
		user_triggers b
	WHERE	a.ie_tipo_objeto IN ('Trigger')
	AND	ie_base_wheb_w = 'S'
	AND	Gerar_Objeto_Aplicacao(a.ds_aplicacao) = 'S'
	AND	a.nm_objeto = b.trigger_name
	AND	b.status = 'DISABLED'
	
union

	SELECT	a.ie_tipo_objeto,
		a.nm_objeto,
		a.nm_usuario,
		a.dt_atualizacao,
		obter_desc_expressao(308368) --'Triggers desabilitadas'
	FROM	objeto_sistema a,
		user_triggers b
	WHERE	a.ie_tipo_objeto IN ('Trigger')
	AND	ie_base_wheb_w IN ('N','T')
	AND	Gerar_Objeto_Aplicacao(a.ds_aplicacao) = 'S'
	AND	a.nm_objeto = b.trigger_name
	AND	b.status = 'DISABLED';

/*Verificar objetos estão documentadas e não estão na base*/


/*Cursor C18 is
	select	a.nm_objeto
	from	objeto_sistema a,
		user_objects b
	where	a.ie_tipo_objeto in ('PROCEDURE','VIEW','TRIGGER','FUNCTION','PACKAGE','BASE')
	and	Gerar_Objeto_Aplicacao(a.ds_aplicacao) = 'S'
	and	a.nm_objeto = b.object_name;
select	a.argument_name,
	a.in_out,
	a.data_type,
	b.nm_objeto,
	c.object_type
from	user_arguments a,
	user_objects c,
	objeto_sistema b
where	a.object_name	= b.nm_objeto
and	c.object_name	= b.nm_objeto
and	c.object_type	in ('PROCEDURE','FUNCTION')
and	b.nr_sequencia	= nr_seq_objeto_p;

	*/



/*Verificar se a constraint _UK está pegando o indice certo*/

C19 CURSOR FOR
	SELECT 	distinct(b.nm_tabela),
		a.CONSTRAINT_NAME,
		max(b.nm_usuario),
		max(b.dt_atualizacao),
		obter_desc_expressao(786639) --'Contraint _UK com índice incorreto'
	from	USER_CONSTRAINTS a,
		integridade_referencial b
	where 	b.nm_tabela = a.table_name
	and	a.constraint_name like '%_UK'
	and	a.index_name not like '%_UK'
	and	a.index_name <> a.constraint_name
	and	b.nm_tabela = nm_tabela_p
	group by(b.nm_tabela), a.CONSTRAINT_NAME, 5;



/*Verificar se as constraint estão sem indices*/

C20 CURSOR FOR
SELECT  distinct a.nm_tabela,
		(a.NM_INTEGRIDADE_REFERENCIAL),
		(a.nm_usuario),
		max(a.dt_atualizacao),
		obter_desc_expressao(786643) --'Índices sem atributos'
	from    INTEGRIDADE_ATRIBUTO a
	where     ((not exists (  SELECT  1
					  from    INDICE_ATRIBUTO b
					  Where   B.Nm_Atributo = A.Nm_Atributo
                      and	  b.nm_tabela = a.nm_tabela
					  And     ((B.Nm_Indice like A.Nm_Integridade_Referencial||'_I%')
						   or (B.Nm_Indice like(select substr(A.Nm_Integridade_Referencial, 0, position('_' in A.Nm_Integridade_Referencial)) || 'PK'
                                                        )))
					  And     B.Nr_Sequencia = A.Ie_Sequencia_Criacao))
			and not exists (  select  1
						  from    INDICE_ATRIBUTO b
						  Where   B.Nm_Atributo = A.Nm_Atributo
						  and	  b.nm_tabela = a.nm_tabela
						  And     B.Nm_Indice like '%_UK'))
	and	a.dt_atualizacao > dt_janeiro_2012_w 
	and	a.nm_tabela = nm_tabela_p
	GROUP BY a.nm_tabela, (a.NM_INTEGRIDADE_REFERENCIAL), (a.nm_usuario), 5;


/*Verificar se as constraint e o indice estão utilizando os mesmos atributos*/

C21 CURSOR FOR
	SELECT	a.nm_tabela,
		b.nm_indice,
		a.nm_usuario,
		max(a.dt_atualizacao),
		obter_desc_expressao(786647) --'Ordem dos campos inconsistente (Integridade <-> Índice)'
	from    INTEGRIDADE_ATRIBUTO a,
		INDICE_ATRIBUTO b
	where   a.NM_INTEGRIDADE_REFERENCIAL||'_I' =  b.NM_INDICE
	and     b.nm_tabela = a.nm_tabela
	and		a.nm_tabela = nm_tabela_p
	and     b.nr_sequencia = a.ie_sequencia_criacao
	and     a.NM_ATRIBUTO <> b.NM_ATRIBUTO
	and	a.dt_atualizacao > dt_julho_2012_w
	GROUP BY a.nm_tabela, b.nm_indice, a.nm_usuario, 5;




BEGIN
/*INICIO ALTERAÇÃO COELHO -  IMPEDIR DUAS EXECUÇÕES DESTA PROCEDURE OU SIMULTÂNEA A VALIDA_OBJETOS_SISTEMA*/

CALL gravar_processo_longo('','TASY_CONSISTIR_BASE',null);
select clock_timestamp() - INTERVAL '1' DAY
into STRICT dt_dia_anterior_w
;

select TO_DATE('2012/01/01', 'yyyy/mm/dd')
into STRICT dt_janeiro_2012_w
;

select TO_DATE('2012/06/07', 'yyyy/mm/dd')
into STRICT dt_julho_2012_w
;

begin
	SELECT obter_desc_expressao(786650)/*'A procedure VALIDA_OBJETOS_SISTEMA está em execução.'*/
|| chr(10) ||
	    obter_desc_expressao(786652)/*'A execução da procedure TASY_CONSISTIR_BASE foi cancelada!!!'*/
|| chr(10) ||
		obter_desc_expressao(648224)/*'Programa   :'*/
 || program || chr(10) ||
		obter_desc_expressao(618748)/*'Sid/Serial :'*/
 || sid     || ',' || serial# || chr(10) ||
	   	obter_desc_expressao(328225)/*'Usuário    :'*/
 || osuser  || CHR(10) ||
	   	obter_desc_expressao(618750)/*'Estação    :'*/
 || machine
	INTO STRICT	ds_erro_w
	FROM 	v$session
	WHERE	audsid <> (SELECT userenv('sessionid') )
	AND	username = (select username from v$session where audsid = (select userenv('sessionid') ))
	AND	action like 'VALIDA_OBJETOS_SISTEMA%';
exception
when others then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(197652,'DS_ERRO_W='||DS_ERRO_W);
end;

begin
	SELECT obter_desc_expressao(786654)/*'A procedure TASY_SINCRONIZAR_BASE ja está em execução.'*/
|| chr(10) ||
		obter_desc_expressao(786652)/*'A execução da procedure TASY_CONSISTIR_BASE foi cancelada!!!'*/
|| chr(10) ||
		obter_desc_expressao(648224)/*'Programa   :'*/
 || program || chr(10) ||
		obter_desc_expressao(618748)/*'Sid/Serial :'*/
 || sid     || ',' || serial# || chr(10) ||
	   	obter_desc_expressao(328225)/*'Usuário    :'*/
 || osuser  || CHR(10) ||
	   	obter_desc_expressao(618750)/*'Estação    :'*/
 || machine
	INTO STRICT	ds_erro_w
	FROM 	v$session
	WHERE	audsid <> (SELECT userenv('sessionid') )
	AND	username = (select username from v$session where audsid = (select userenv('sessionid') ))
	AND	action like 'TASY_SINCRONIZAR_BASE%'
	OR 	action like 'TASY_AJUSTAR_COLUNAS%'
	OR	action like 'TASY_ALTERAR_COLUNA%'
	OR	action like 'TASY_CRIAR_INDICE%'
	OR	action like 'TASY_CRIAR_INTEGRIDADE%'
	OR	action like 'TASY_CRIAR_ALTERAR_TABELA%';
exception
when others then
	CALL gravar_processo_longo('','',0);
	CALL wheb_mensagem_pck.exibir_mensagem_abort(197652,'DS_ERRO_W='||DS_ERRO_W);
end;

begin
	SELECT	obter_desc_expressao(786672)/*'A procedure TASY_CONSISTIR_BASE está em execução. '*/
|| chr(10) ||
		obter_desc_expressao(648224)/*'Programa   :'*/
 || program || chr(10) ||
		obter_desc_expressao(618748)/*'Sid/Serial :'*/
 || sid     || ',' || serial# || chr(10) ||
	   	obter_desc_expressao(328225)/*'Usuário    :'*/
 || osuser  || CHR(10) ||
	   	obter_desc_expressao(618750)/*'Estação    :'*/
 || machine
	INTO STRICT	ds_erro_w
	FROM 	v$session
	WHERE	audsid <> (SELECT userenv('sessionid') )
	AND	username = (select username from v$session where audsid = (select userenv('sessionid') ))
	AND	action like 'TASY_CONSISTIR_BASE%';
exception
when others then
	CALL gravar_processo_longo('','',null);
	CALL wheb_mensagem_pck.exibir_mensagem_abort(197652,'DS_ERRO_W='||DS_ERRO_W);
end;

/*FIM ALTERAÇÃO COELHO*/



/*INICIO ALTERAÇÃO COELHO -  IMPEDIR DUAS EXECUÇÕES DESTA PROCEDURE OU SIMULTÂNEA A VALIDA_OBJETOS_SISTEMA*/

CALL gravar_processo_longo('','TASY_CONSISTIR_BASE',0);

if (coalesce(nr_seq_versao_p,0) = 0) then
	EXECUTE 'delete from w_inconsistencia_base where nm_tabela = :nm_tabela_p'
    using   nm_tabela_p;
end if;

CALL gravar_processo_longo('Tabelas','TASY_CONSISTIR_BASE',-1);
open C01;
loop
fetch C01 into
	nm_tabela_w,
	nm_objeto_w,
	nm_usuario_w,
	dt_atualizacao_w,
	ds_motivo_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	CALL gravar_inconsistencia_base(nm_tabela_w,nm_objeto_w,nm_usuario_w,dt_atualizacao_w,ds_motivo_w, 1, nr_seq_versao_p);
	end;
end loop;
close C01;

CALL gravar_processo_longo('Campos','TASY_CONSISTIR_BASE',-1);

open C02;
loop
fetch C02 into
	nm_tabela_w,
	nm_objeto_w,
	nm_usuario_w,
	dt_atualizacao_w,
	ds_motivo_w;
EXIT WHEN NOT FOUND; /* apply on C02 */
	begin
	CALL gravar_inconsistencia_base(nm_tabela_w,nm_objeto_w,nm_usuario_w,dt_atualizacao_w,ds_motivo_w, 2, nr_seq_versao_p);
	end;
end loop;
close C02;

CALL gravar_processo_longo('Tipos de campos','TASY_CONSISTIR_BASE',-1);

open C03;
loop
fetch C03 into
	nm_tabela_w,
	nm_objeto_w,
	nm_usuario_w,
	dt_atualizacao_w,
	ds_motivo_w;
EXIT WHEN NOT FOUND; /* apply on C03 */
	begin
	CALL gravar_inconsistencia_base(nm_tabela_w,nm_objeto_w,nm_usuario_w,dt_atualizacao_w,ds_motivo_w, 3, nr_seq_versao_p);
	end;
end loop;
close C03;

CALL gravar_processo_longo('Tamanho dos campos','TASY_CONSISTIR_BASE',-1);

open C04;
loop
fetch C04 into
	nm_tabela_w,
	nm_objeto_w,
	nm_usuario_w,
	dt_atualizacao_w,
	ds_motivo_w;
EXIT WHEN NOT FOUND; /* apply on C04 */
	begin
	CALL gravar_inconsistencia_base(nm_tabela_w,nm_objeto_w,nm_usuario_w,dt_atualizacao_w,ds_motivo_w, 4, nr_seq_versao_p);
	end;
end loop;
close C04;
CALL gravar_processo_longo('Obrig. dos campos','TASY_CONSISTIR_BASE',-1);
open C05;
loop
fetch C05 into
	nm_tabela_w,
	nm_objeto_w,
	nm_usuario_w,
	dt_atualizacao_w,
	ds_motivo_w;
EXIT WHEN NOT FOUND; /* apply on C05 */
	begin
	CALL gravar_inconsistencia_base(nm_tabela_w,nm_objeto_w,nm_usuario_w,dt_atualizacao_w,ds_motivo_w, 5, nr_seq_versao_p);
	end;
end loop;
close C05;
CALL gravar_processo_longo('Índices','TASY_CONSISTIR_BASE',-1);
open C06;
loop
fetch C06 into
	nm_tabela_w,
	nm_objeto_w,
	nm_usuario_w,
	dt_atualizacao_w,
	ds_motivo_w,
	ie_tipo_w;
EXIT WHEN NOT FOUND; /* apply on C06 */
	begin
	CALL gravar_inconsistencia_base(nm_tabela_w,nm_objeto_w,nm_usuario_w,dt_atualizacao_w,ds_motivo_w, 6, nr_seq_versao_p);
	end;
end loop;
close C06;
CALL gravar_processo_longo('Campos dos índices','TASY_CONSISTIR_BASE',-1);
open C07;
loop
fetch C07 into
	nm_tabela_w,
	nm_objeto_w,
	nm_usuario_w,
	dt_atualizacao_w,
	ds_motivo_w;
EXIT WHEN NOT FOUND; /* apply on C07 */
	begin
	CALL gravar_inconsistencia_base(nm_tabela_w,nm_objeto_w,nm_usuario_w,dt_atualizacao_w,ds_motivo_w, 7, nr_seq_versao_p);
	end;
end loop;
close C07;
CALL gravar_processo_longo('Ordem dos campos do índice','TASY_CONSISTIR_BASE',-1);
open C08;
loop
fetch C08 into
	nm_tabela_w,
	nm_objeto_w,
	nm_usuario_w,
	dt_atualizacao_w,
	ds_motivo_w;
EXIT WHEN NOT FOUND; /* apply on C08 */
	begin
	CALL gravar_inconsistencia_base(nm_tabela_w,nm_objeto_w,nm_usuario_w,dt_atualizacao_w,ds_motivo_w, 8, nr_seq_versao_p);
	end;
end loop;
close C08;
CALL gravar_processo_longo('Integridades','TASY_CONSISTIR_BASE',-1);
open C09;
loop
fetch C09 into
	nm_tabela_w,
	nm_objeto_w,
	nm_usuario_w,
	dt_atualizacao_w,
	ds_motivo_w;
EXIT WHEN NOT FOUND; /* apply on C09 */
	begin
	CALL gravar_inconsistencia_base(nm_tabela_w,nm_objeto_w,nm_usuario_w,dt_atualizacao_w,ds_motivo_w, 9, nr_seq_versao_p);
	end;
end loop;
close C09;
CALL gravar_processo_longo('Integridades','TASY_CONSISTIR_BASE',-1);
open C10;
loop
fetch C10 into
	nm_tabela_w,
	nm_objeto_w,
	nm_usuario_w,
	dt_atualizacao_w,
	ds_motivo_w;
EXIT WHEN NOT FOUND; /* apply on C10 */
	begin
	CALL gravar_inconsistencia_base(nm_tabela_w,nm_objeto_w,nm_usuario_w,dt_atualizacao_w,ds_motivo_w, 10, nr_seq_versao_p);
	end;
end loop;
close C10;
CALL gravar_processo_longo('Composição dos campos da integridade','TASY_CONSISTIR_BASE',-1);
open C11;
loop
fetch C11 into
	nm_tabela_w,
	nm_objeto_w,
	nm_usuario_w,
	dt_atualizacao_w,
	ds_motivo_w;
EXIT WHEN NOT FOUND; /* apply on C11 */
	begin
	CALL gravar_inconsistencia_base(nm_tabela_w,nm_objeto_w,nm_usuario_w,dt_atualizacao_w,ds_motivo_w, 11, nr_seq_versao_p);
	end;
end loop;
close C11;
CALL gravar_processo_longo('Ordem dos campos da integridade','TASY_CONSISTIR_BASE',-1);
open C12;
loop
fetch C12 into
	nm_tabela_w,
	nm_objeto_w,
	nm_usuario_w,
	dt_atualizacao_w,
	ds_motivo_w;
EXIT WHEN NOT FOUND; /* apply on C12 */
	begin
	CALL gravar_inconsistencia_base(nm_tabela_w,nm_objeto_w,nm_usuario_w,dt_atualizacao_w,ds_motivo_w, 12, nr_seq_versao_p);
	end;
end loop;
close C12;
CALL gravar_processo_longo('Índices da integridade','TASY_CONSISTIR_BASE',-1);
open C13;
loop
fetch C13 into
	nm_tabela_w,
	nm_objeto_w,
	nm_usuario_w,
	dt_atualizacao_w,
	ds_motivo_w;
EXIT WHEN NOT FOUND; /* apply on C13 */
	begin
	CALL gravar_inconsistencia_base(nm_tabela_w,nm_objeto_w,nm_usuario_w,dt_atualizacao_w,ds_motivo_w, 13, nr_seq_versao_p);
	end;
end loop;
close C13;
CALL gravar_processo_longo('Objetos','TASY_CONSISTIR_BASE',-1);
open C14;
loop
fetch C14 into
	nm_tabela_w,
	nm_objeto_w,
	nm_usuario_w,
	dt_atualizacao_w,
	ds_motivo_w;
EXIT WHEN NOT FOUND; /* apply on C14 */
	begin
	CALL gravar_inconsistencia_base(nm_tabela_w,nm_objeto_w,nm_usuario_w,dt_atualizacao_w,ds_motivo_w, 14, nr_seq_versao_p);
	end;
end loop;
close C14;
CALL gravar_processo_longo('Integridades','TASY_CONSISTIR_BASE',-1);
open C15;
loop
fetch C15 into
	nm_tabela_w,
	nm_objeto_w,
	nm_usuario_w,
	dt_atualizacao_w,
	ds_motivo_w;
EXIT WHEN NOT FOUND; /* apply on C15 */
	begin
	CALL gravar_inconsistencia_base(nm_tabela_w,nm_objeto_w,nm_usuario_w,dt_atualizacao_w,ds_motivo_w, 15, nr_seq_versao_p);
	end;
end loop;
close C15;
CALL gravar_processo_longo('Constraints dos índices','TASY_CONSISTIR_BASE',-1);
open C16;
loop
fetch C16 into
	nm_tabela_w,
	nm_objeto_w,
	nm_usuario_w,
	dt_atualizacao_w,
	ds_motivo_w;
EXIT WHEN NOT FOUND; /* apply on C16 */
	begin
	CALL gravar_inconsistencia_base(nm_tabela_w,nm_objeto_w,nm_usuario_w,dt_atualizacao_w,ds_motivo_w, 16, nr_seq_versao_p);
	end;
end loop;
close C16;
CALL gravar_processo_longo('Triggers','TASY_CONSISTIR_BASE',-1);
open C17;
loop
fetch C17 into
	nm_tabela_w,
	nm_objeto_w,
	nm_usuario_w,
	dt_atualizacao_w,
	ds_motivo_w;
EXIT WHEN NOT FOUND; /* apply on C17 */
	begin
	CALL gravar_inconsistencia_base(nm_tabela_w,nm_objeto_w,nm_usuario_w,dt_atualizacao_w,ds_motivo_w, 17, nr_seq_versao_p);
	end;
end loop;
close C17;
CALL gravar_processo_longo('Contraint _UK com índice incorreto','TASY_CONSISTIR_BASE',-1);
open C19;
loop
fetch C19 into
	nm_tabela_w,
	nm_objeto_w,
	nm_usuario_w,
	dt_atualizacao_w,
	ds_motivo_w;
EXIT WHEN NOT FOUND; /* apply on C19 */
	begin
	CALL gravar_inconsistencia_base(nm_tabela_w,nm_objeto_w,nm_usuario_w,dt_atualizacao_w,ds_motivo_w, 19, nr_seq_versao_p);
	end;
end loop;
close C19;
CALL gravar_processo_longo('Índices sem atributos','TASY_CONSISTIR_BASE',-1);
open C20;
loop
fetch C20 into
	nm_tabela_w,
	nm_objeto_w,
	nm_usuario_w,
	dt_atualizacao_w,
	ds_motivo_w;
EXIT WHEN NOT FOUND; /* apply on C20 */
	begin
	CALL gravar_inconsistencia_base(nm_tabela_w,nm_objeto_w,nm_usuario_w,dt_atualizacao_w,ds_motivo_w, 20, nr_seq_versao_p);
	end;
end loop;
close C20;
CALL gravar_processo_longo('Ordem dos campos inconsistente (Integridade <-> Índice)','TASY_CONSISTIR_BASE',-1);
open C21;
loop
fetch C21 into
	nm_tabela_w,
	nm_objeto_w,
	nm_usuario_w,
	dt_atualizacao_w,
	ds_motivo_w;
EXIT WHEN NOT FOUND; /* apply on C21 */
	begin
	CALL gravar_inconsistencia_base(nm_tabela_w,nm_objeto_w,nm_usuario_w,dt_atualizacao_w,ds_motivo_w, 21, nr_seq_versao_p);
	end;
end loop;
close C21;

commit;

CALL gravar_processo_longo('','',0);

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE tasy_consistir_tabela ( nm_tabela_p text, ie_base_wheb_p text default 'N', nr_seq_versao_p bigint default 0) FROM PUBLIC;

