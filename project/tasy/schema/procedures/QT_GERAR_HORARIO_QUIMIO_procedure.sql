-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE qt_gerar_horario_quimio ( dt_agenda_p timestamp, nm_usuario_p text, cd_estabelecimento_p bigint) AS $body$
DECLARE


nr_seq_local_w		bigint;
hr_atual_w		timestamp;
hr_final_dia_w		timestamp;
hr_inicial_dia_w	timestamp;
hr_inicial_truncada_w	timestamp;
ie_status_w		varchar(15);
qt_marcado_w		bigint;
ie_dia_Semana_w		integer;
nr_seq_pend_maracada_w	bigint;
nr_Seq_pend_agenda_w	bigint;
nr_seq_atend_marcado_w	bigint;
nr_seq_pend_agenda_marcado_w	bigint;
nr_minuto_aval_w	bigint;
nr_seq_agequi_w		bigint;
qt_pac_horario_w	bigint;
ie_horario_bloq_w	varchar(1);
nr_seq_agenda_w		bigint;
nr_seq_agenda_marcado_w	bigint;
qt_turno_w		bigint;
dt_agenda_w		timestamp;
nr_duracao_W		bigint;
qt_tempo_entre_hor_W	bigint;
ie_indice_w		integer;
ie_ind_w		integer;
nr_seq_prof_w		bigint;
dt_min_agendamento_w	timestamp;
dt_max_agendamento_w	timestamp;
hr_inicio_turno_w	timestamp;
hr_fim_turno_w		timestamp;
ie_possui_turno_w	varchar(1)	:= 'N';
qt_marcacao_w		bigint;
ie_feriado_w		varchar(1);
cd_estabelecimento_w	smallint;
nr_seq_atendimento_w	bigint;
ie_regra_bloq_medic_w	varchar(1);
cd_estab_pend_w		smallint;
nr_seq_ageint_item_w	bigint;
nr_seq_ageint_item_ww	bigint;
nr_seq_paciente_w	bigint;
nr_seq_atend_sim_w	bigint;
ie_gerado_w		varchar(1);
nr_seq_ageint_item_www	bigint;
ie_status_agenda_w	varchar(15);

hr_quebra_turno_w		varchar(05);
hr_quebra_turno_not_w		varchar(05);
cd_turno_w			bigint := 0;
nr_minuto_duracao_w		bigint;
qt_registros_ag_quimio		bigint;

qt_horario_w		bigint;
ie_Reserva_w		varchar(1);
cd_pac_agenda_w		varchar(10);
nr_sequencia_w		bigint;
ds_procedimento_w	varchar(255);
nr_seq_agenda_quimio_w bigint;


C04 CURSOR FOR
	SELECT	a.dt_agenda,
		a.nr_minuto_duracao,
		a.nr_seq_local,
		a.cd_pessoa_fisica,
		a.nr_seq_atendimento,
		SUBSTR(obter_valor_dominio(3117,IE_TIPO_PEND_AGENDA),1,240) ds_procedimento,
		a.nr_sequencia
	from	agenda_quimio a,
		qt_local b
	where	a.dt_agenda between trunc(dt_Agenda_p) and trunc(dt_Agenda_p) + 86399/86400
	and	a.nr_seq_local	= b.nr_sequencia
	and	a.ie_status_agenda	<> 'C'
	and	((b.cd_estabelecimento	= cd_estabelecimento_p) or (coalesce(cd_estabelecimento_p::text, '') = ''))
	order by dt_Agenda;


BEGIN

select	obter_cod_dia_semana(dt_agenda_p)
into STRICT	ie_dia_semana_w
;

delete
from 	mapa_ocupacao_quimio
where 	trunc(dt_mapa) between trunc(dt_Agenda_p) and trunc(dt_Agenda_p) + 86399/86400;

open C04;
loop
fetch C04 into
	dt_agenda_w,
	nr_minuto_duracao_w,
	nr_seq_local_w,
	cd_pac_agenda_w,
	nr_seq_atendimento_w,
	ds_procedimento_w,
	nr_seq_agenda_quimio_w;
EXIT WHEN NOT FOUND; /* apply on C04 */
	begin
	select 	nextval('mapa_ocupacao_quimio_seq')
	into STRICT	nr_sequencia_w
	;

	insert into mapa_ocupacao_quimio(nr_sequencia,
		nr_seq_local,
		dt_atualizacao,
		dt_mapa,
		nr_duracao,
		cd_pessoa_Fisica,
		nr_seq_atendimento,
		nm_usuario,
		nr_seq_agenda_quimio)
	values (nr_sequencia_w,
		nr_seq_local_w,
		clock_timestamp(),
		dt_agenda_w,
		nr_minuto_duracao_w,
		cd_pac_Agenda_w,
		nr_seq_atendimento_w,
		nm_usuario_p,
		nr_seq_agenda_quimio_w);
	end;
end loop;
close C04;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE qt_gerar_horario_quimio ( dt_agenda_p timestamp, nm_usuario_p text, cd_estabelecimento_p bigint) FROM PUBLIC;

