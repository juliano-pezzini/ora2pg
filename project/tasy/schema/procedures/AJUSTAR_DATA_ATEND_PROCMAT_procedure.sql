-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE ajustar_data_atend_procmat (nr_sequencia_p bigint, ie_proc_mat_p bigint, dt_ajuste_p timestamp, ie_opcao_p bigint, nm_usuario_p text, ds_observacao_P text, ds_erro_p INOUT text) AS $body$
DECLARE

 
 
/*	IE_PROC_MAT_P 
	2 - Procedimento 
	3 - Material 
	 
	IE_OPCAO_P 
	0-Data do atendimento e da conta do item 
	1-Data do atendimento do item 
	2-Data da conta do item 
*/
 
 
 
dt_entrada_unidade_w	timestamp;
dt_entrada_w		timestamp;
ie_ok_w			varchar(1):= 'S';
qt_erro_w		bigint;

 

BEGIN 
 
ie_ok_w		:= 'S';
qt_erro_w	:= 1;
 
if (ie_proc_mat_p	= 2) then 
 
	ie_ok_w:= 'S';
	 
	begin 
	select	a.dt_entrada_unidade, 
		b.dt_entrada 
	into STRICT	dt_entrada_unidade_w, 
		dt_entrada_w 
	from	atendimento_paciente	b, 
		procedimento_paciente	a 
	where	a.nr_atendimento	= b.nr_atendimento	 
	and	a.nr_sequencia		= nr_sequencia_p;
	exception 
		when others then 
		ie_ok_w		:= 'N';
	end;
	 
	if (dt_ajuste_p		>= dt_entrada_unidade_w) and (dt_ajuste_p		>= dt_entrada_w) and (ie_opcao_p		= 0) and (ie_ok_w = 'S') then 
		update	procedimento_paciente 
		set	dt_procedimento	= dt_ajuste_p, 
			dt_conta	= dt_ajuste_p, 
			nm_usuario	= nm_usuario_p, 
			dt_atualizacao = clock_timestamp(), 
			ds_just_alter_data = ds_observacao_p 
		where	nr_sequencia	= nr_sequencia_p;
		 
		qt_erro_w := 0;
	end if;
	if (dt_ajuste_p		>= dt_entrada_unidade_w) and (dt_ajuste_p		>= dt_entrada_w) and (ie_opcao_p		= 1) and (ie_ok_w = 'S') then 
		update	procedimento_paciente 
		set	dt_procedimento	= dt_ajuste_p, 
			nm_usuario	= nm_usuario_p, 
			dt_atualizacao = clock_timestamp(), 
			ds_just_alter_data = ds_observacao_p 
		where	nr_sequencia	= nr_sequencia_p;
		 
		qt_erro_w := 0;
	end if;
	if (dt_ajuste_p		>= dt_entrada_unidade_w) and (dt_ajuste_p		>= dt_entrada_w) and (ie_opcao_p		= 2) and (ie_ok_w = 'S') then 
		update	procedimento_paciente 
		set	dt_conta	= dt_ajuste_p, 
			nm_usuario	= nm_usuario_p, 
			dt_atualizacao = clock_timestamp(), 
			ds_just_alter_data = ds_observacao_p 
		where	nr_sequencia	= nr_sequencia_p;
		 
		qt_erro_w := 0;
	end if;
 
elsif (ie_proc_mat_p	= 3) then 
 
	ie_ok_w:= 'S';
	 
	begin 
	select	a.dt_entrada_unidade, 
		b.dt_entrada 
	into STRICT	dt_entrada_unidade_w, 
		dt_entrada_w 
	from	atendimento_paciente	b, 
		material_atend_paciente	a 
	where	a.nr_atendimento	= b.nr_atendimento 
	and	a.nr_sequencia		= nr_sequencia_p;
	exception 
		when others then 
		ie_ok_w:= 'N';
	end;
 
	if (dt_ajuste_p		>= dt_entrada_unidade_w) and (dt_ajuste_p		>= dt_entrada_w) and (ie_opcao_p		= 0) and (ie_ok_w = 'S') then 
		update	material_atend_paciente 
		set	dt_atendimento	= dt_ajuste_p, 
			dt_conta	= dt_ajuste_p, 
			nm_usuario	= nm_usuario_p, 
			dt_atualizacao = clock_timestamp(), 
			ds_just_alter_data = ds_observacao_p 
		where	nr_sequencia	= nr_sequencia_p;
		 
		qt_erro_w := 0;
	end if;
	if (dt_ajuste_p		>= dt_entrada_unidade_w) and (dt_ajuste_p		>= dt_entrada_w) and (ie_opcao_p		= 1) and (ie_ok_w = 'S') then 
		update	material_atend_paciente 
		set	dt_atendimento	= dt_ajuste_p, 
			nm_usuario	= nm_usuario_p, 
			dt_atualizacao = clock_timestamp(), 
			ds_just_alter_data = ds_observacao_p 
		where	nr_sequencia	= nr_sequencia_p;
		 
		qt_erro_w := 0;
	end if;
	if (dt_ajuste_p		>= dt_entrada_unidade_w) and (dt_ajuste_p		>= dt_entrada_w) and (ie_opcao_p		= 2) and (ie_ok_w = 'S') then 
		update	material_atend_paciente 
		set	dt_conta	= dt_ajuste_p, 
			nm_usuario	= nm_usuario_p, 
			dt_atualizacao = clock_timestamp(), 
			ds_just_alter_data = ds_observacao_p 
		where	nr_sequencia	= nr_sequencia_p;
		 
		qt_erro_w := 0;
	end if;
end if;
 
if (qt_erro_w > 0) then 
	--ds_erro_p	:= 'A data informada Ã© menor que a data de entrada na unidade.'; 
	ds_erro_p	:= wheb_mensagem_pck.get_texto(281136);
end if;
 
commit;
 
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ajustar_data_atend_procmat (nr_sequencia_p bigint, ie_proc_mat_p bigint, dt_ajuste_p timestamp, ie_opcao_p bigint, nm_usuario_p text, ds_observacao_P text, ds_erro_p INOUT text) FROM PUBLIC;

