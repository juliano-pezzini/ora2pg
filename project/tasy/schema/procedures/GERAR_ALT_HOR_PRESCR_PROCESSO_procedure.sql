-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_alt_hor_prescr_processo ( cd_estabelecimento_p bigint, nr_atendimento_p bigint, nr_seq_processo_p bigint, ie_administrar_p text, nm_usuario_p text, ds_justificativa_p text default null, nr_seq_assinatura_p text default null, ie_agrupador_p bigint default null, nr_seq_topo_lat_p topografia_lat_adm.nr_sequencia%type default null) AS $body$
DECLARE


ie_processo_valido_w		varchar(1);
nr_prescricao_w				bigint;
nr_seq_material_w			integer;
nr_seq_horario_w			bigint;
cd_material_w				integer;
cd_intervalo_w				varchar(7);
dt_horario_w				timestamp;
dt_paciente_w				timestamp;
dt_atend_lote_w				timestamp;
nr_seq_alteracao_w			bigint;
ie_regra_lanc_conta_w		varchar(1);
nr_seq_map_w				bigint;
varsql_row_count_w			bigint;
ie_gerar_estornar_w			varchar(1);
nr_sequencia_proc_w			bigint;
nr_sequencia_proc_ant_w		bigint;
ie_agrupador_w				bigint;
nr_seq_lote_w				bigint;
ie_tipo_item_w				varchar(15);
ie_acm_sn_w					varchar(1);
ie_atualiza_data_conta_w	varchar(1);
cd_motivo_baixa_w			smallint;
ie_impedir_w				varchar(2);
ie_somente_com_baixa_w		varchar(1);
qt_reg_conta_w				bigint;
nr_seq_hor_proc_w			prescr_proc_hor.nr_sequencia%type;
cd_procedimento_w			prescr_proc_hor.cd_procedimento%type;
nr_seq_proc_interno_w		prescr_procedimento.nr_seq_proc_interno%type;
nr_seq_procedimento_w		prescr_procedimento.nr_sequencia%type;
ie_lanc_conta_adm_w			varchar(1);
ie_gerou_alteracao_w		varchar(1)	:= 'N';
cd_um_dose_adm_w			prescr_mat_alteracao.cd_um_dose_adm%type;
qt_dose_adm_w				prescr_mat_alteracao.qt_dose_adm%type;
dt_entrega_setor_w			timestamp;
nr_etapa_atual_w			prescr_solucao.nr_etapas%type;
cd_pessoa_fisica_w			prescr_medica.cd_pessoa_fisica%type;
ie_gerar_pend_w				boolean;
VarIe_Cobra_Prim_hor_w varchar(1);
cd_setor_exec_w				prescr_procedimento.cd_setor_atendimento%type;
nr_seq_interno_w      prescr_procedimento.nr_seq_proc_interno%type;
ie_altera_status_pa_w		varchar(1);
ie_cobra_proc_hor_w			varchar(1);
nr_seq_exame_w				prescr_procedimento.nr_seq_exame%type;
ie_existe_w					char(1);
ie_cobrar_horario_w			varchar(1);
IE_COBRAR_HORARIOI_W		varchar(1);
ie_cobra_adep_w				char(1);
nr_seq_proc_princ_w			prescr_procedimento.nr_seq_proc_princ%type;
cd_proc_conta_w				bigint;
ie_origem_proc_conta_w		bigint;
ie_origem_proced_w			bigint;
qt_procedimento_w			double precision;
ie_regra_proc_conv_w		varchar(1);
ie_atualizou_w          boolean;
ie_gera_sem_certificado_w	varchar(1);
nr_seq_projeto_w			tasy_projeto_assinatura.nr_sequencia%type;
dt_recebimento_setor_w		ap_lote.dt_recebimento_setor%type;
nr_seq_alteracao_comp_w		prescr_mat_alteracao_comp.nr_sequencia%type;
ie_param8_cpoe_w			varchar(2);
ie_proc_w					varchar(2);
cd_funcao_origem_w			prescr_medica.cd_funcao_origem%type;
nr_seq_proc_cpoe_w			prescr_procedimento.nr_seq_proc_cpoe%type;
dt_fim_w					cpoe_procedimento.dt_fim%type;
nr_seq_mat_cpoe_w			prescr_material.nr_seq_mat_cpoe%type;
nr_seq_mat_hor_w            prescr_mat_hor.nr_sequencia%type;
ie_via_aplicacao_w			prescr_material.ie_via_aplicacao%type;
ds_material_w				material.ds_material%type;
cd_evolucao_w				evolucao_paciente.cd_evolucao%type;
ie_rastreabilidade_adep_w    varchar(1);

c01 CURSOR FOR
SELECT	*
from (
SELECT	b.nr_prescricao,
		b.nr_sequencia nr_seq,
		a.nr_sequencia,
		b.cd_material,
		a.dt_horario,
		b.nr_sequencia_proc,
		b.ie_agrupador,
		CASE WHEN b.ie_acm='N' THEN CASE WHEN b.ie_se_necessario='S' THEN 'S' END   ELSE 'S' END ,
		a.nr_seq_lote,
		CASE WHEN a.cd_motivo_baixa=0 THEN  b.cd_motivo_baixa  ELSE a.cd_motivo_baixa END ,
		b.nr_seq_mat_cpoe
from	prescr_material b,
		prescr_mat_hor a
where	b.nr_sequencia		= a.nr_seq_material
and		b.nr_prescricao		= a.nr_prescricao
and		a.nr_seq_processo	= nr_seq_processo_p
and		coalesce(a.dt_suspensao::text, '') = ''
and		Obter_se_horario_liberado(a.dt_lib_horario, a.dt_horario) = 'S'
and		((coalesce(ie_agrupador_p::text, '') = '') or (ie_agrupador_p = b.ie_agrupador))

union

select	b.nr_prescricao,
		b.nr_sequencia nr_seq,
		a.nr_sequencia,
		b.cd_material,
		a.dt_horario,
		b.nr_sequencia_proc,
		b.ie_agrupador,
		CASE WHEN b.ie_acm='N' THEN CASE WHEN b.ie_se_necessario='S' THEN 'S' END   ELSE 'S' END ,
		a.nr_seq_lote,
		CASE WHEN a.cd_motivo_baixa=0 THEN  b.cd_motivo_baixa  ELSE a.cd_motivo_baixa END ,
		b.nr_seq_mat_cpoe
from	prescr_material b,
		prescr_mat_hor a
where	b.nr_sequencia		= a.nr_seq_material
and		b.nr_prescricao		= a.nr_prescricao
and		a.nr_seq_processo	= nr_seq_processo_p
and		coalesce(a.dt_suspensao::text, '') = ''
and		Obter_se_horario_liberado(a.dt_lib_horario, a.dt_horario) = 'S'
and		(ie_agrupador_p IS NOT NULL AND ie_agrupador_p::text <> '')
and		b.nr_seq_kit in (	select 	c.nr_seq_material
														from	prescr_mat_hor c 					
														where	c.nr_seq_processo = nr_seq_processo_p
														and		c.ie_agrupador = ie_agrupador_p
														and		coalesce(c.dt_suspensao::text, '') = ''
														and		Obter_se_horario_liberado(c.dt_lib_horario, c.dt_horario) = 'S')

union

select	b.nr_prescricao,
		b.nr_sequencia nr_seq,
		a.nr_sequencia,
		b.cd_material,
		a.dt_horario,
		b.nr_sequencia_proc,
		b.ie_agrupador,
		CASE WHEN b.ie_acm='N' THEN CASE WHEN b.ie_se_necessario='S' THEN 'S' END   ELSE 'S' END ,
		a.nr_seq_lote,
		CASE WHEN a.cd_motivo_baixa=0 THEN  b.cd_motivo_baixa  ELSE a.cd_motivo_baixa END ,
		b.nr_seq_mat_cpoe
from	prescr_material b,
		prescr_mat_hor a
where	b.nr_sequencia		= a.nr_seq_material
and		b.nr_prescricao		= a.nr_prescricao
and		a.nr_seq_processo	= nr_seq_processo_p
and		coalesce(a.dt_suspensao::text, '') = ''
and		Obter_se_horario_liberado(a.dt_lib_horario, a.dt_horario) = 'S'
and		(ie_agrupador_p IS NOT NULL AND ie_agrupador_p::text <> '') 
and		nr_sequencia_diluicao in (	select 	c.nr_seq_material
														from	prescr_mat_hor c 					
														where	c.nr_seq_processo = nr_seq_processo_p
														and		c.ie_agrupador = ie_agrupador_p
														and		coalesce(c.dt_suspensao::text, '') = ''
														and		Obter_se_horario_liberado(c.dt_lib_horario, c.dt_horario) = 'S')	
and		b.ie_agrupador in (3,7,9)														
) tabela 							
order by
	nr_prescricao desc,
	nr_seq,
	nr_sequencia;


BEGIN

ie_rastreabilidade_adep_w := obter_rastreabilidade_adep(nr_seq_processo_p, 'AP');

if (ie_rastreabilidade_adep_w = 'S') then
    CALL adep_gerar_log_rastr('{'||chr(10)||
    '"'||$$plsql_unit||'" : "'||$$plsql_line||'",'||chr(10)||
    '"cd_estabelecimento_p" : "'||cd_estabelecimento_p||'",'||chr(10)||
    '"ds_justificativa_p" : "'||ds_justificativa_p||'",'||chr(10)||
    '"ie_administrar_p" : "'||ie_administrar_p||'",'||chr(10)||
    '"ie_agrupador_p" : "'||ie_agrupador_p||'",'||chr(10)||
    '"nm_usuario_p" : "'||nm_usuario_p||'",'||chr(10)||
    '"nr_atendimento_p" : "'||nr_atendimento_p||'",'||chr(10)||
    '"nr_seq_assinatura_p" : "'||nr_seq_assinatura_p||'",'||chr(10)||
    '"nr_seq_processo_p" : "'||nr_seq_processo_p||'",'||chr(10)||
    '"nr_seq_topo_lat_p" : "'||nr_seq_topo_lat_p||'"}', wheb_usuario_pck.get_ie_commit);
end if;

if (nr_atendimento_p IS NOT NULL AND nr_atendimento_p::text <> '') and (nr_seq_processo_p IS NOT NULL AND nr_seq_processo_p::text <> '') and (nm_usuario_p IS NOT NULL AND nm_usuario_p::text <> '') then
	
	select	validar_processo_atendimento(nr_atendimento_p, nr_seq_processo_p)
	into STRICT	ie_processo_valido_w
	;

	if (ie_processo_valido_w = 'S') then
	
		ie_gera_sem_certificado_w	:= 'N';

		if (wheb_assist_pck.get_gerar_sem_certificado = 'S') then
			if (ie_administrar_p = 'S') then
				nr_seq_projeto_w	:= 35007; --ADEP - ADL -  Administracao do item
			else
				nr_seq_projeto_w	:= 50573; --ADEP - Alteracao do item (suspensao/reversao/aprazamento)
			end if;

			ie_gera_sem_certificado_w := adep_obter_se_assin_perfil(nr_seq_projeto_w, obter_perfil_ativo);
		end if;
	
		ie_gerar_pend_w	:= (((wheb_assist_pck.get_cd_certificado IS NOT NULL AND wheb_assist_pck.get_cd_certificado::text <> '') OR (ie_gera_sem_certificado_w = 'S')) AND (coalesce(obter_data_assinatura_digital(nr_seq_assinatura_p)::text, '') = ''));
							
		select	max(cd_pessoa_fisica)
		into STRICT	cd_pessoa_fisica_w
		from	atendimento_paciente
		where	nr_atendimento = nr_atendimento_p;
	
		if (ie_administrar_p = 'S') then
			ie_gerar_estornar_w	:= 'G';
		else
			ie_gerar_estornar_w	:= 'E';
		end if;
		
		select	coalesce(max(dt_paciente),clock_timestamp()),
				max(nr_seq_material),
				max(nr_etapa)
		into STRICT	dt_paciente_w,
				nr_seq_material_w,
				nr_etapa_atual_w
		from	adep_processo
		where	nr_sequencia = nr_seq_processo_p;
	
		ie_regra_lanc_conta_w	:= obter_regra_lanc_conta_adep(cd_estabelecimento_p, obter_perfil_ativo, nm_usuario_p, 'AP');
		if (ie_regra_lanc_conta_w = 'N') then
			ie_regra_lanc_conta_w	:= obter_regra_lanc_conta_adep(cd_estabelecimento_p, obter_perfil_ativo, nm_usuario_p, 'CG');
		end if;
		
		ie_somente_com_baixa_w := obter_param_usuario(1113, 357, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_somente_com_baixa_w);
		ie_atualiza_data_conta_w := obter_param_usuario(1113, 628, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_atualiza_data_conta_w);
		ie_param8_cpoe_w := obter_param_usuario(2314, 8, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_param8_cpoe_w);

		nr_sequencia_proc_ant_w	:= 0;
				
        if (ie_rastreabilidade_adep_w = 'S') then
            CALL adep_gerar_log_rastr('{'||chr(10)||
            '"'||$$plsql_unit||'" : "'||$$plsql_line||'",'||chr(10)||
            '"ie_agrupador_p" : "'||ie_agrupador_p||'",'||chr(10)||
            '"nr_seq_processo_p" : "'||nr_seq_processo_p||'"}', wheb_usuario_pck.get_ie_commit);
        end if;

		open c01;
		loop
		fetch c01 into	nr_prescricao_w,
				nr_seq_material_w,
				nr_seq_horario_w,
				cd_material_w,
				dt_horario_w,
				nr_sequencia_proc_w,
				ie_agrupador_w,
				ie_acm_sn_w,
				nr_seq_lote_w,
				cd_motivo_baixa_w,
				nr_seq_mat_cpoe_w;
		EXIT WHEN NOT FOUND; /* apply on c01 */
			begin
			
			select 	max(cd_funcao_origem)
			into STRICT	cd_funcao_origem_w
			from 	prescr_medica
			where 	nr_prescricao = nr_prescricao_w;

			select	max(qt_dose),
					max(cd_unidade_medida_dose),
					max(ie_via_aplicacao),
					substr(obter_desc_material(max(cd_material)),1,255)
			into STRICT	qt_dose_adm_w,
					cd_um_dose_adm_w,
					ie_via_aplicacao_w,
					ds_material_w
			from	prescr_material
			where	nr_prescricao = nr_prescricao_w
			and		nr_sequencia = nr_seq_material_w;
			
			if (nr_sequencia_proc_ant_w <> nr_sequencia_proc_w) then
				ie_gerou_alteracao_w	:= 'N';			
			end if;
			
			if (ie_administrar_p = 'S') then
				if (coalesce(cd_motivo_baixa_w,0) = 0 or ie_somente_com_baixa_w <> 'N') then
					ie_impedir_w	:= obter_se_impede_adm(cd_material_w);
					if (ie_impedir_w = 'S') then
						if (ie_somente_com_baixa_w = 'S')  AND (coalesce(cd_motivo_baixa_w, 0) = 0) THEN
							--So e possivel administrar uma medicacao apos o atendimento da mesma no atendimento da prescricao/lote! Parametro [357]
							CALL atualiza_status_processo_adep(nr_seq_processo_p,0,'A','RA',clock_timestamp(),nm_usuario_p);
							CALL Wheb_mensagem_pck.Exibir_mensagem_abort(173406);
						elsif (ie_somente_com_baixa_w = 'L') and (nr_seq_lote_w IS NOT NULL AND nr_seq_lote_w::text <> '') then
							select	max(dt_atend_farmacia)
							into STRICT	dt_atend_lote_w
							from	ap_lote
							where	nr_sequencia = nr_seq_lote_w;
							if (coalesce(dt_atend_lote_w::text, '') = '') then
								--so e possivel administrar uma medicacao apos o atendimento da mesma no atendimento da prescricao/lote! parametro [357]
								CALL wheb_mensagem_pck.exibir_mensagem_abort(173406);
							end if;
						elsif (ie_somente_com_baixa_w = 'E') and (nr_seq_lote_w IS NOT NULL AND nr_seq_lote_w::text <> '') then
							select	max(dt_entrega_setor)
							into STRICT	dt_entrega_setor_w
							from	ap_lote
							where	nr_sequencia = nr_seq_lote_w;
							if (coalesce(dt_entrega_setor_w::text, '') = '') then
								--so e possivel administrar uma medicacao apos a entrega da mesma no atendimento da prescricao/lote! parametro [357]
								CALL wheb_mensagem_pck.exibir_mensagem_abort(472055);
							end if;
						elsif (ie_somente_com_baixa_w = 'R') and (nr_seq_lote_w IS NOT NULL AND nr_seq_lote_w::text <> '') then
							select	max(dt_recebimento_setor)
							into STRICT	dt_recebimento_setor_w
							from	ap_lote
							where	nr_sequencia = nr_seq_lote_w;
							if (coalesce(dt_recebimento_setor_w::text, '') = '') then
								--so e possivel administrar uma medicacao, apos o recebimento da mesma no atendimento da prescricao/lote!
								CALL wheb_mensagem_pck.exibir_mensagem_abort(819419);
							end if;
						end if;
					end if;
				end if;
			
				update	prescr_mat_hor
				set		dt_fim_horario	= dt_paciente_w,
						nm_usuario_adm	= nm_usuario_p
				where	nr_sequencia	= nr_seq_horario_w
				and		coalesce(dt_fim_horario::text, '') = ''
				and		coalesce(dt_suspensao::text, '') = '';

        		GET DIAGNOSTICS ie_atualizou_w = ROW_COUNT > 0;
							
				if (coalesce(ie_atualiza_data_conta_w,'N') = 'S') then
					update	material_atend_paciente
					set		dt_conta 	= clock_timestamp(),
							dt_atendimento = clock_timestamp()
					where	nr_prescricao = nr_prescricao_w
					and		nr_seq_lote_ap = nr_seq_lote_w;
				end if;

                if (ie_rastreabilidade_adep_w = 'S') then
                    CALL adep_gerar_log_rastr('{'||chr(10)||
                    '"'||$$plsql_unit||'" : "'||$$plsql_line||'",'||chr(10)||
                    '"nr_prescricao_w" : "'||nr_prescricao_w||'",'||chr(10)||
                    '"nr_seq_mat_hor_w" : "'||nr_seq_mat_hor_w||'",'||chr(10)||
                    '"nr_seq_processo_p" : "'||nr_seq_processo_p||'",'||chr(10)||
                    '"nr_sequencia_proc_ant_w" : "'||nr_sequencia_proc_ant_w||'",'||chr(10)||
                    '"nr_sequencia_proc_w" : "'||nr_sequencia_proc_w||'"}', wheb_usuario_pck.get_ie_commit);
                end if;

				if (coalesce(nr_sequencia_proc_w, 0) > 0) and (nr_sequencia_proc_ant_w <> nr_sequencia_proc_w) then

                    select  max(a.nr_sequencia)
                    into STRICT    nr_seq_mat_hor_w
                    from   	prescr_mat_hor a,
                            prescr_material b,
                            prescr_proc_hor c,
                            prescr_procedimento d
                    where  	a.nr_prescricao 	= b.nr_prescricao
                    and	   	a.nr_seq_material	= b.nr_sequencia
                    and	   	b.nr_sequencia_proc = c.nr_seq_procedimento
                    and	   	c.nr_prescricao 	= a.nr_prescricao
                    and	   	a.dt_horario	   	= c.dt_horario
                    and		c.nr_prescricao 	= d.nr_prescricao
                    and		c.nr_seq_procedimento = d.nr_sequencia
                    and	   	b.nr_prescricao		= nr_prescricao_w
                    and	   	a.nr_seq_processo 	= nr_seq_processo_p;

					select 	max(c.nr_sequencia),
                            max(c.cd_procedimento),
							max(d.nr_sequencia),
							max(d.nr_seq_proc_interno)
					into STRICT	nr_seq_hor_proc_w,
                            cd_procedimento_w,
							nr_seq_procedimento_w,
							nr_seq_proc_interno_w
					from   	prescr_mat_hor a,
							prescr_material b,
							prescr_proc_hor c,
							prescr_procedimento d
					where  	a.nr_prescricao 	= b.nr_prescricao
					and	   	a.nr_seq_material	= b.nr_sequencia
					and	   	b.nr_sequencia_proc = c.nr_seq_procedimento
					and	   	c.nr_prescricao 	= a.nr_prescricao
					and	   	a.dt_horario	   	= c.dt_horario
					and		c.nr_prescricao 	= d.nr_prescricao
					and		c.nr_seq_procedimento = d.nr_sequencia
                    and     a.nr_sequencia      = nr_seq_mat_hor_w
                    and	   	b.nr_prescricao		= nr_prescricao_w
                    and	   	a.nr_seq_processo 	= nr_seq_processo_p;
							
					update	prescr_proc_hor
					set		dt_fim_horario	= dt_paciente_w,
							nm_usuario_adm	= nm_usuario_p
					where	nr_sequencia	= nr_seq_hor_proc_w
					and		coalesce(dt_fim_horario::text, '') = ''
					and		coalesce(dt_suspensao::text, '') = '';
          					
					select	nextval('prescr_mat_alteracao_seq')
					into STRICT	nr_seq_alteracao_w
					;
										
					insert into prescr_mat_alteracao(
						nr_sequencia,
						dt_atualizacao,
						nm_usuario,
						dt_atualizacao_nrec,
						nm_usuario_nrec,
						nr_prescricao,
						nr_seq_procedimento,
						nr_seq_horario_proc,
						dt_alteracao,
						cd_pessoa_fisica,
						ie_alteracao,
						ds_justificativa,
						ie_tipo_item,
						dt_horario,
						nr_atendimento,
						cd_item,
						nr_seq_proc_interno,
						nr_seq_lote,
						nr_seq_assinatura
						)
					values (
						nr_seq_alteracao_w,
						dt_paciente_w,
						nm_usuario_p,
						dt_paciente_w,
						nm_usuario_p,
						nr_prescricao_w,
						nr_sequencia_proc_w,
						nr_seq_hor_proc_w,
						dt_paciente_w,
						obter_dados_usuario_opcao(nm_usuario_p,'C'),
						CASE WHEN ie_administrar_p='S' THEN 3  ELSE 4 END ,
						ds_justificativa_p,
						'P',
						dt_horario_w,
						nr_atendimento_p,
						cd_procedimento_w,
						nr_seq_proc_interno_w,
						nr_seq_lote_w,
						nr_seq_assinatura_p
						);

					ie_regra_proc_conv_w		:= Wheb_assist_pck.obterParametroFuncao(1113,669);
					
					if (Obter_Funcao_Ativa = 7044) then
						ie_altera_status_pa_w := obter_param_usuario(7044, 7, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_altera_status_pa_w);
						ie_cobra_proc_hor_w := obter_param_usuario(7044, 6, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_cobra_proc_hor_w);
					else
						ie_altera_status_pa_w	:= wheb_assist_pck.obterparametrofuncao(1113,203);
						ie_cobra_proc_hor_w		:= wheb_assist_pck.obterparametrofuncao(1113,246);
					end if;

					select	max(cd_setor_atendimento),
							coalesce(max(nr_seq_proc_interno),0),
							max(nr_seq_proc_princ),
							coalesce(max(qt_procedimento),0),
							coalesce(max(ie_origem_proced),0),
							max(nr_seq_exame),
							max(nr_seq_proc_cpoe)
					into STRICT	cd_setor_exec_w,
							nr_seq_interno_w,
							nr_seq_proc_princ_w,
							qt_procedimento_w,
							ie_origem_proced_w,
							nr_seq_exame_w,
							nr_seq_proc_cpoe_w
					from 	prescr_procedimento
					where	nr_prescricao	= nr_prescricao_w
					and		nr_sequencia	= nr_sequencia_proc_w;

					if (ie_altera_status_pa_w = 'S') or
						((ie_altera_status_pa_w = 'L') and (coalesce(nr_seq_exame_w::text, '') = '')) then
						begin
						ie_existe_w	:= 'N';

						select	coalesce(max(ie_cobrar_horario),'N')
						into STRICT	ie_cobrar_horario_w
						from	procedimento
						where	cd_procedimento		= cd_procedimento_w
						and		ie_origem_proced	= ie_origem_proced_w;

						select	coalesce(max(ie_cobrar_horario),'N')
						into STRICT	ie_cobrar_horarioI_w
						from	proc_interno
						where	nr_sequencia	= nr_seq_proc_interno_w;

						if (ie_cobrar_horario_w = 'S') or (ie_cobrar_horarioI_w = 'S')  then
							select	coalesce(max('S'),'N')
							into STRICT	ie_existe_w
							from	prescr_proc_hor a where		a.nr_prescricao	= nr_prescricao_w
							and		a.nr_seq_procedimento = nr_sequencia_proc_w
							and		a.nr_sequencia	<> nr_seq_horario_w
							and		PKG_DATE_UTILS.start_of(a.dt_horario,'dd',0) = PKG_DATE_UTILS.start_of(dt_horario_w,'dd',0)
							and		(a.dt_fim_horario IS NOT NULL AND a.dt_fim_horario::text <> '')
							and		exists (	SELECT	1
											from	procedimento_paciente b
											where	b.nr_prescricao		= nr_prescricao_w
											and		b.nr_sequencia_prescricao	= nr_sequencia_proc_w) LIMIT 1;

							if (ie_existe_w = 'N') then
								select	coalesce(max('S'),'N')
								into STRICT	ie_existe_w
								from	prescr_proc_hor	a,
										prescr_medica 	b where		a.nr_prescricao		= b.nr_prescricao
								and		b.nr_atendimento	= nr_atendimento_p
								and		a.cd_procedimento	= cd_procedimento_w
								and		a.ie_origem_proced	= ie_origem_proced_w
								and		a.nr_sequencia		<> nr_seq_horario_w
								and		PKG_DATE_UTILS.start_of(a.dt_horario,'dd',0) = PKG_DATE_UTILS.start_of(dt_horario_w,'dd',0)
								and		(a.dt_fim_horario IS NOT NULL AND a.dt_fim_horario::text <> '')
								and		exists (	SELECT	1
												from	procedimento_paciente x
												where	x.nr_prescricao		= a.nr_prescricao
												and		x.nr_sequencia_prescricao = a.nr_seq_procedimento) LIMIT 1;
							end if;

							if (ie_existe_w = 'S') then
								if (ie_cobrar_horario_w = 'N') and (coalesce(nr_seq_proc_interno_w,0) = 0) then
									ie_existe_w := 'N';
								elsif (coalesce(nr_seq_proc_interno_w,0) > 0) then
									if (ie_cobrar_horarioI_w = 'N') then
										ie_existe_w	:= 'N';
									end if;
								end if;
							end if;
						end if;

						select	coalesce(max(ie_cobra_adep),'S')
						into STRICT	ie_cobra_adep_w
						from	procedimento
						where	cd_procedimento		= cd_procedimento_w
						and		ie_origem_proced	= ie_origem_proced_w;

						if (ie_cobra_adep_w = 'S') and (ie_existe_w = 'N') and (coalesce(nr_seq_proc_princ_w::text, '') = '') then
							if (ie_cobra_proc_hor_w = 'N') then
								CALL gerar_proc_Pac_Prescricao(nr_prescricao_w, nr_sequencia_proc_w, obter_perfil_ativo, 1113, nm_usuario_p, '', '', '');
							else
								if (ie_regra_proc_conv_w	= 'S') then
									SELECT * FROM obter_proc_Tab_Interno(nr_seq_proc_interno_w, nr_prescricao_w, nr_atendimento_p, 0, cd_proc_conta_w, ie_origem_proc_conta_w, null, null) INTO STRICT cd_proc_conta_w, ie_origem_proc_conta_w;
								else
									cd_proc_conta_w			:= cd_procedimento_w;
									ie_origem_proc_conta_w	:= ie_origem_proced_w;
								end if;

								CALL gerar_proc_pac_item_prescr(	nr_prescricao_w,
															nr_sequencia_proc_w,
															null,
															null,
															nr_seq_proc_interno_w, 
															cd_proc_conta_w, 
															ie_origem_proc_conta_w, 
															qt_procedimento_w, 
															cd_setor_exec_w,
															1, 
															clock_timestamp(), 
															nm_usuario_p, 
															null, 
															nr_seq_exame_w, 
															null,
															null,
															null,
															null,
															null, 
															nr_seq_interno_w);
							end if;
						end if;
						end;
					end if;

					select	CASE WHEN coalesce(max(b.ie_ctrl_glic),'NC')='NC' THEN 'IA'  ELSE 'IAG' END
					into STRICT	ie_tipo_item_w
					from	prescr_procedimento a,
							proc_interno b
					where	a.nr_prescricao	= nr_prescricao_w
					and		a.nr_sequencia	= nr_sequencia_proc_w
					and		a.nr_seq_proc_interno = b.nr_sequencia;
					
					CALL gerar_alter_horario_item_assoc(nr_atendimento_p, ie_tipo_item_w, nr_prescricao_w, nr_sequencia_proc_w, 0, dt_horario_w, dt_paciente_w, 3, nm_usuario_p);
					
					ie_atualizou_w := false;
					
					nr_sequencia_proc_ant_w	:= nr_sequencia_proc_w;
					
					if	((ie_gerar_pend_w) and (coalesce(nr_seq_assinatura_p,0) = 0) and ie_agrupador_w in (1,5)) then
						CALL Gerar_registro_pendente_PEP('ADEP',nr_prescricao_w, cd_pessoa_fisica_w, nr_atendimento_p,nm_usuario_p, '', nr_seq_horario_w, ie_tipo_item_w,null,null,null,null,null,null,null,null,null,null,null,null,null,null,nr_seq_alteracao_w);
					end if;	
					
					if (coalesce(nr_seq_proc_cpoe_w,0) > 0) and (coalesce(cd_funcao_origem_w,0) = 2314) then

						dt_fim_w :=	dt_paciente_w;

						if (dt_fim_w < dt_horario_w) then	
							dt_fim_w :=	dt_horario_w;
						end if;

						select	max(coalesce('S','N'))
						into STRICT	ie_proc_w
						from	cpoe_procedimento
						where	nr_sequencia = nr_seq_proc_cpoe_w;

						if	((coalesce(ie_proc_w,'N') = 'S') and (ie_param8_cpoe_w = 'A')) then
							update	cpoe_procedimento
							set 	dt_fim =  trunc(dt_fim_w + 1/24,'hh24') - 1/1440,
									nm_usuario = nm_usuario_p,
									dt_atualizacao = clock_timestamp()
							where	nr_sequencia = nr_seq_proc_cpoe_w
							and 	coalesce(ie_evento_unico,'N') = 'S'
							and		ie_administracao = 'P';
						elsif (ie_param8_cpoe_w = 'A') then						
							update	cpoe_anatomia_patologica
							set 	dt_fim =  trunc(dt_fim_w + 1/24,'hh24') - 1/1440,
									nm_usuario = nm_usuario_p,
									dt_atualizacao = clock_timestamp()
							where	nr_sequencia = nr_seq_proc_cpoe_w
							and		ie_administracao = 'P';
						end if;						
					end if;	

				end if;

			elsif (ie_administrar_p = 'N') then
			
				update	prescr_mat_hor
				set	dt_fim_horario	 = NULL,
					nm_usuario_adm	 = NULL
				where	nr_sequencia	= nr_seq_horario_w
				and	(dt_fim_horario IS NOT NULL AND dt_fim_horario::text <> '');
			
			end if;

			if (ie_gerar_estornar_w = 'G') then
				select 	sum(qt_material)
				into STRICT	qt_reg_conta_w
				from	material_atend_paciente
				where	nr_sequencia_prescricao = nr_seq_material_w
				and		nr_prescricao = nr_prescricao_w
				and		((nr_seq_mat_hor = nr_seq_horario_w) or (nr_seq_processo = nr_seq_processo_p));
			else
				qt_reg_conta_w := 0;
			end if;
			
			if (ie_regra_lanc_conta_w = 'S') and (coalesce(qt_reg_conta_w,0) = 0) then
				nr_seq_map_w := gerar_estornar_adep_map(null, nr_seq_horario_w, null, ie_gerar_estornar_w, dt_paciente_w, nm_usuario_p, nr_seq_map_w, null, null, null);
			elsif (ie_regra_lanc_conta_w = 'L') and (obter_se_lote_hor_conta_pac(nr_seq_horario_w) = 'S') and (coalesce(qt_reg_conta_w,0) = 0) then
				nr_seq_map_w := gerar_estornar_adep_map(null, nr_seq_horario_w, null, ie_gerar_estornar_w, dt_paciente_w, nm_usuario_p, nr_seq_map_w, null, null, null);
			end if;
						
			if (ie_agrupador_w	= 2) then
				ie_tipo_item_w	:= 'MAT';
			elsif (ie_agrupador_w	= 8) then
				ie_tipo_item_w	:= 'SNE';	
			elsif (ie_agrupador_w	= 5) and (nr_sequencia_proc_w IS NOT NULL AND nr_sequencia_proc_w::text <> '')  then
				
				select	CASE WHEN coalesce(max(b.ie_ctrl_glic),'NC')='NC' THEN 'IA'  ELSE 'IAG' END
				into STRICT	ie_tipo_item_w
				from	prescr_procedimento a,
					proc_interno b
				where	a.nr_prescricao	= nr_prescricao_w
				and	a.nr_sequencia	= nr_sequencia_proc_w
				and	a.nr_seq_proc_interno = b.nr_sequencia;
			elsif (ie_agrupador_w	= 16) then
				ie_tipo_item_w	:= 'LD';		
			else
				ie_tipo_item_w	:= 'M';
			end if;
			
			if (ie_agrupador_w = 1) then
			
				if (coalesce(nr_sequencia_proc_w,0) = 0) then				
					CALL Gerar_proced_assoc_mat_conta(nr_prescricao_w, nr_seq_material_w, NULL, nm_usuario_p, ie_gerar_estornar_w, dt_paciente_w);				
				end if;
				
				cd_evolucao_w := Gerar_evolPaci_automa('M', nm_usuario_p, nr_atendimento_p, ds_material_w, nr_seq_horario_w, 'A', obter_expressao_idioma(488570), clock_timestamp(), nr_prescricao_w, qt_dose_adm_w, cd_um_dose_adm_w, ie_via_aplicacao_w, cd_evolucao_w, 'N');
				
			end if;

            if (ie_rastreabilidade_adep_w = 'S') then
                CALL adep_gerar_log_rastr('{'||chr(10)||
                '"'||$$plsql_unit||'" : "'||$$plsql_line||'",'||chr(10)||
                '"cd_evolucao_w" : "'||cd_evolucao_w||'",'||chr(10)||
                '"cd_um_dose_adm_w" : "'||cd_um_dose_adm_w||'",'||chr(10)||
                '"ds_material_w" : "'||ds_material_w||'",'||chr(10)||
                '"dt_paciente_w" : "'||to_char(dt_paciente_w, 'dd/mm/yyyy hh24:mi:ss')||'",'||chr(10)||
                '"ie_agrupador_w" : "'||ie_agrupador_w||'",'||chr(10)||
                '"ie_gerar_estornar_w" : "'||ie_gerar_estornar_w||'",'||chr(10)||
                '"ie_tipo_item_w" : "'||ie_tipo_item_w||'",'||chr(10)||
                '"ie_via_aplicacao_w" : "'||ie_via_aplicacao_w||'",'||chr(10)||
                '"nm_usuario_p" : "'||nm_usuario_p||'",'||chr(10)||
                '"nr_atendimento_p" : "'||nr_atendimento_p||'",'||chr(10)||
                '"nr_prescricao_w" : "'||nr_prescricao_w||'",'||chr(10)||
                '"nr_seq_horario_w" : "'||nr_seq_horario_w||'",'||chr(10)||
                '"nr_seq_material_w" : "'||nr_seq_material_w||'",'||chr(10)||
                '"nr_sequencia_proc_w" : "'||nr_sequencia_proc_w||'",'||chr(10)||
                '"qt_dose_adm_w" : "'||qt_dose_adm_w||'",'||chr(10)||
                '"sysdate" : "'||to_char(clock_timestamp(), 'dd/mm/yyyy hh24:mi:ss')||'"}', wheb_usuario_pck.get_ie_commit);
            end if;

			if ((ie_gerou_alteracao_w = 'N') and (ie_tipo_item_w <> 'SNE') and (ie_atualizou_w)) then
			
				select	nextval('prescr_mat_alteracao_seq')
				into STRICT	nr_seq_alteracao_w
				;

				insert	into	prescr_mat_alteracao(
								nr_sequencia,
								dt_atualizacao,
								nm_usuario,
								dt_atualizacao_nrec,
								nm_usuario_nrec,
								nr_prescricao,
								nr_seq_prescricao,
								nr_seq_horario,
								dt_alteracao,
								cd_pessoa_fisica,
								ie_alteracao,
								ds_justificativa,
								ie_tipo_item,
								dt_horario,
								nr_atendimento,
								cd_item,
								qt_dose_adm,
								cd_um_dose_adm,
								ie_acm_sn,
								nr_seq_assinatura,
								nr_seq_lote
								)
							values (
								nr_seq_alteracao_w,
								dt_paciente_w,
								nm_usuario_p,
								dt_paciente_w,
								nm_usuario_p,
								nr_prescricao_w,
								nr_seq_material_w,
								nr_seq_horario_w,
								dt_paciente_w,
								obter_dados_usuario_opcao(nm_usuario_p,'C'),
								CASE WHEN ie_administrar_p='S' THEN 3  ELSE 4 END ,
								ds_justificativa_p,								
								ie_tipo_item_w,
								dt_horario_w,
								nr_atendimento_p,
								cd_material_w,
								qt_dose_adm_w,
								cd_um_dose_adm_w,
								ie_acm_sn_w,
								nr_seq_assinatura_p,
								nr_seq_lote_w
								);
								
				if	((ie_gerar_pend_w) and (coalesce(nr_seq_assinatura_p,0) = 0)  and ie_agrupador_w in (1,5,8,16)) then
					CALL Gerar_registro_pendente_PEP('ADEP',nr_prescricao_w, cd_pessoa_fisica_w, nr_atendimento_p,nm_usuario_p, '', nr_seq_horario_w, ie_tipo_item_w,null,null,null,null,null,null,null,null,null,null,null,null,null,null,nr_seq_alteracao_w);
				end if;	

				if ((nr_seq_mat_cpoe_w IS NOT NULL AND nr_seq_mat_cpoe_w::text <> '') and
					 ie_param8_cpoe_w = 'A' and
					 cd_funcao_origem_w = 2314) then

					dt_fim_w :=	dt_paciente_w;

					if (dt_fim_w < dt_horario_w) then	
						dt_fim_w :=	dt_horario_w;
					end if;
					
					update	cpoe_material
					set 	dt_fim =  trunc(dt_fim_w + 1/24,'hh24') - 1/1440,
							nm_usuario = nm_usuario_p,
							dt_atualizacao = clock_timestamp()
					where	nr_sequencia = nr_seq_mat_cpoe_w
					and 	coalesce(ie_evento_unico,'N') = 'S'
					and		ie_administracao = 'P';
				end if;	

			elsif ((ie_gerou_alteracao_w = 'N') and (ie_tipo_item_w = 'SNE') and (ie_atualizou_w)) then
			
				select	nextval('prescr_solucao_evento_seq')
				into STRICT	nr_seq_alteracao_w
				;
				
				insert into prescr_solucao_evento(
					nr_sequencia,
					dt_atualizacao,
					nm_usuario,
					dt_atualizacao_nrec,
					nm_usuario_nrec,
					nr_prescricao,
					nr_seq_solucao,
					ie_forma_infusao,
					ie_tipo_dosagem,
					qt_dosagem,
					qt_vol_infundido,
					qt_vol_desprezado,
					cd_pessoa_fisica,
					ie_alteracao,
					dt_alteracao,
					dt_aprazamento,
					ie_evento_valido,
					nr_seq_motivo,
					ds_observacao,
					ie_tipo_solucao,
					nr_etapa_evento,
					nr_seq_assinatura,
					nr_seq_material)
			values (
					nr_seq_alteracao_w,
					clock_timestamp(),
					nm_usuario_p,
					clock_timestamp(),
					nm_usuario_p,
					nr_prescricao_w,
					null,
					null,
					null,
					null,
					null,
					null,
					obter_dados_usuario_opcao(nm_usuario_p, 'C'),
					35,
					clock_timestamp(),
					dt_horario_w,
					'S',
					null,
					'',
					2,
					nr_etapa_atual_w,
					CASE WHEN coalesce(nr_seq_assinatura_p,0)=0 THEN  null  ELSE nr_seq_assinatura_p END ,
					nr_seq_material_w);
					
			if	((ie_gerar_pend_w) and (coalesce(nr_seq_assinatura_p,0) = 0)  and ie_agrupador_w in (1,5,8,16)) then
				CALL Gerar_registro_pendente_PEP('ADEP',nr_prescricao_w, cd_pessoa_fisica_w, nr_atendimento_p,nm_usuario_p, '', nr_seq_horario_w, 'SNE',null,null,null,null,null,null,null,null,null,null,null,null,null,null,nr_seq_alteracao_w);
			end if;
				
			end if;

				SELECT	nextval('prescr_mat_alteracao_comp_seq')
				INTO STRICT	nr_seq_alteracao_comp_w
				;

      	INSERT INTO prescr_mat_alteracao_comp(nr_sequencia,
					dt_atualizacao, 
					cd_intervalo, 
					nm_usuario, 
					dt_atualizacao_nrec, 
					nm_usuario_nrec, 
					nr_sequencia_prescr,
					qt_dose,
					nr_seq_motivo_adm,
					cd_evolucao,
          nr_seq_topo_lat)
				VALUES (
					nr_seq_alteracao_comp_w,
					clock_timestamp(),
					null,
					nm_usuario_p,
					clock_timestamp(),
					nm_usuario_p,
					nr_seq_alteracao_w,
					null,
					null,
					null,
          nr_seq_topo_lat_p);
		end;
		end loop;
		close c01;
	else
		null;
	end if;
	
end if;

if (coalesce(wheb_usuario_pck.get_ie_commit, 'S') = 'S') then commit; end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_alt_hor_prescr_processo ( cd_estabelecimento_p bigint, nr_atendimento_p bigint, nr_seq_processo_p bigint, ie_administrar_p text, nm_usuario_p text, ds_justificativa_p text default null, nr_seq_assinatura_p text default null, ie_agrupador_p bigint default null, nr_seq_topo_lat_p topografia_lat_adm.nr_sequencia%type default null) FROM PUBLIC;

