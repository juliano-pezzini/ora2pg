-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE enviar_ci_dispositivo (nr_atendimento_p bigint, nr_seq_dispositivo_p bigint, nr_seq_proc_interno_p bigint, nm_usuario_p text, ie_acao_p text ) AS $body$
DECLARE

 
ds_titulo_w		varchar(255);
nm_paciente_w		varchar(255);
nm_medico_w		varchar(255);
ds_dispositivo_w	varchar(255);
ie_acao_w		varchar(255);
ds_comunicado_w		varchar(4000);
ds_texto_w		varchar(4000);
ds_lista_perfil_w	varchar(4000);
ds_cabecalho_w		varchar(4000);
nm_usuario_destino_w	varchar(2000);
cd_perfil_w		bigint;
nr_sequencia_w		bigint;
nr_seq_dispositivo_w	bigint;

c01 CURSOR FOR 
SELECT	a.ds_titulo, 
	a.ds_texto_comunic, 
	a.cd_perfil, 
	a.nm_usuario_destino 
from	regra_envio_ci_dispositivo a 
where	coalesce(nr_seq_proc_interno, nr_seq_proc_interno_p) = nr_seq_proc_interno_p 
and	coalesce(ie_acao, coalesce(ie_acao_p,'XPTO'))	= coalesce(ie_acao_p,'XPTO') 
and	nr_seq_dispositivo	= nr_seq_dispositivo_w;


BEGIN 
 
nr_seq_dispositivo_w	:= nr_seq_dispositivo_p;
select	max(ie_acao) 
into STRICT	ie_acao_w 
from	dispositivo_proc_interno 
where	nr_seq_dispositivo	= nr_seq_dispositivo_w 
and	nr_seq_proc_interno	= nr_seq_proc_interno_p;
 
select	substr(obter_descricao_padrao('DISPOSITIVO','DS_DISPOSITIVO',nr_seq_dispositivo_w),1,80) 
into STRICT	ds_dispositivo_w
;
 
if (coalesce(ds_dispositivo_w::text, '') = '') then 
	select	max(nr_seq_dispositivo) 
	into STRICT	nr_seq_dispositivo_w 
	from	atend_pac_dispositivo 
	where	nr_sequencia		=	nr_seq_dispositivo_p;
	 
	select	max(ie_acao) 
	into STRICT	ie_acao_w 
	from	dispositivo_proc_interno 
	where	nr_seq_dispositivo	= nr_seq_dispositivo_w 
	and	nr_seq_proc_interno	= nr_seq_proc_interno_p;
	 
	select	substr(obter_descricao_padrao('DISPOSITIVO','DS_DISPOSITIVO',nr_seq_dispositivo_w),1,80) 
	into STRICT	ds_dispositivo_w 
	;
end if;
 
select	min(nr_sequencia) 
into STRICT	nr_sequencia_w 
from	comunic_interna_classif 
where	ie_tipo	= 'F';
 
if (coalesce(nr_atendimento_p,0) > 0) then 
	ds_cabecalho_w	:= 	obter_texto_tasy(315886,null) || obter_pessoa_atendimento(nr_atendimento_p,'N') || chr(13) ||chr(10) || 
						obter_texto_tasy(315887, null) || obter_dados_pf(obter_pessoa_atendimento(nr_atendimento_p,'C'),'DN') || chr(13) ||chr(10) || 
						obter_texto_tasy(315888, null) || to_char(nr_atendimento_p) || chr(13) ||chr(10) || 
						obter_texto_tasy(315889, null) || Obter_Dados_Atendimento(nr_atendimento_p,'DE') || chr(13) ||chr(10) || 
						obter_texto_tasy(315890, null) || obter_nome_setor(obter_setor_atendimento(nr_atendimento_p)) || chr(13)|| chr(13)||chr(10);
end if;	
 
open C01;
loop 
fetch C01 into	 
	ds_titulo_w, 
	ds_texto_w, 
	cd_perfil_w, 
	nm_usuario_destino_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
 
	if (ds_titulo_w IS NOT NULL AND ds_titulo_w::text <> '') then 
		if (ds_lista_perfil_w IS NOT NULL AND ds_lista_perfil_w::text <> '') then	 
			ds_lista_perfil_w := substr(ds_lista_perfil_w || ', ',1,4000);
		end if;	
		 
		ds_lista_perfil_w	:= substr(ds_lista_perfil_w || cd_perfil_w,1,4000);	
		ds_comunicado_w		:= ds_comunicado_w || obter_texto_tasy(315891,null) || ds_dispositivo_w || chr(13) || ds_texto_w;
		 
		insert	into comunic_interna(	 
			dt_comunicado, 
			ds_titulo, 
			ds_comunicado, 
			nm_usuario, 
			dt_atualizacao, 
			ie_geral, 
			ie_gerencial, 
			ds_perfil_adicional, 
			nr_sequencia, 
			nr_seq_classif, 
			dt_liberacao, 
			nm_usuario_destino) 
		values ( 
			clock_timestamp(), 
			ds_titulo_w, 
			ds_cabecalho_w || ds_comunicado_w, 
			nm_usuario_p, 
			clock_timestamp(), 
			'N', 
			'N', 
			ds_lista_perfil_w, 
			nextval('comunic_interna_seq'), 
			nr_sequencia_w, 
			clock_timestamp(), 
			nm_usuario_destino_w);
		if (coalesce(wheb_usuario_pck.get_ie_commit, 'S') = 'S') then commit; end if;
		 
		ds_lista_perfil_w	:= '';
		ds_comunicado_w		:= '';
	 
	end if;
 
end loop;
close C01;
 
 
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE enviar_ci_dispositivo (nr_atendimento_p bigint, nr_seq_dispositivo_p bigint, nr_seq_proc_interno_p bigint, nm_usuario_p text, ie_acao_p text ) FROM PUBLIC;

