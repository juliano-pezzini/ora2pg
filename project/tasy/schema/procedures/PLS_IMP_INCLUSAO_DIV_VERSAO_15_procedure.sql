-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_imp_inclusao_div_versao_15 ( nr_seq_lote_inclusao_p bigint, nr_seq_contrato_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) AS $body$
DECLARE


ds_conteudo_w			varchar(4000);
nr_seq_inclusao_benef_w		bigint;
ds_valor_w			varchar(4000);
qt_registros_w			bigint;
dt_data_aux_w			varchar(100);
qt_beneficiarios_w		bigint;

-------------------------------------------------------------------------------------
ie_tipo_operacao_w		varchar(10);
nr_contrato_w			bigint;
nr_cpf_titular_w		varchar(20);
nr_cpf_dependente_w		varchar(20);
nm_beneficiario_w		varchar(255);
dt_nascimento_w			timestamp;
ie_sexo_w			varchar(10);
nm_pai_w			varchar(255);
nm_mae_w			varchar(255);
nr_seq_parentesco_w		bigint;
ie_estado_civil_w		varchar(10);
nr_cartao_sus_w			varchar(30);
nr_declaracao_nascido_vivo_w	varchar(30);
cd_usuario_plano_w		varchar(30);
cd_sistema_ant_w		varchar(30);
ds_observacao_w			varchar(255);
nr_seq_plano_w			bigint;
dt_adesao_plano_w		timestamp;
dt_admissao_w			timestamp;
cd_matricula_estipulante_w	varchar(30);
dt_cancelamento_w		timestamp;
nr_seq_motivo_cancelamento_w	bigint;
nr_ddi_telefone_w		varchar(10);
nr_ddd_telefone_w		varchar(10);
nr_telefone_w			varchar(20);
nr_ddi_celular_w		varchar(10);
nr_ddd_celular_w		varchar(10);
nr_celular_w			varchar(20);
nr_ddi_fax_w			varchar(10);
nr_ddd_fax_w			varchar(10);
nr_fax_w			varchar(20);
ds_email_w			varchar(255);
ds_pagina_web_w			varchar(255);
cd_cep_w			varchar(10);
ds_endereco_w			varchar(255);
ds_bairro_w			varchar(255);
ds_cidade_w			varchar(255);
sg_uf_w				pls_inclusao_beneficiario.sg_estado%type;
ds_pais_w			varchar(255);
nr_seq_canal_venda_w		bigint;
cd_cpf_vendedor_vinculado_w	varchar(255);
nr_seq_pagador_w		bigint;
cd_municipio_ibge_w		varchar(10);
nr_seq_vendedor_vinc_w		bigint;
nr_seq_motiv_can_aux_w		bigint;
NR_PIS_PASEP_W			varchar(15);
CD_NACIONALIDADE_w		varchar(10);
NR_SEQ_TITULAR_SOLIC_w		bigint;
nr_seq_segurado_w		bigint;
dt_suspensao_w			timestamp;
nr_seq_motivo_susp_w		bigint;
dt_solicitacao_w		timestamp;
dt_reativao_w			timestamp;
nr_seq_motivo_alt_prod_w	bigint;
dt_alteracao_prod_w		timestamp;


C01 CURSOR FOR
	SELECT	ds_conteudo
	from	w_pls_importacao;


BEGIN

CALL gravar_processo_longo('Inclusão de beneficiários','PLS_IMP_INCLUSAO_DIV_VERSAO_15',0);

qt_beneficiarios_w	:= 0;

select	max(cd_nacionalidade)
into STRICT	cd_nacionalidade_w
from	nacionalidade
where	ie_brasileiro	= 'S'
and	coalesce(ie_situacao,'A') = 'A';

open C01;
loop
fetch C01 into
	ds_conteudo_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	qt_beneficiarios_w	:= qt_beneficiarios_w + 1;

	CALL gravar_processo_longo('Beneficiários = ' || qt_beneficiarios_w,'PLS_IMP_INCLUSAO_DIV_VERSAO_15',-1);

	nr_cpf_titular_w			:= '';
	nr_cpf_dependente_w			:= '';
	nm_beneficiario_w			:= '';
	ie_sexo_w				:= '';
	nm_pai_w				:= '';
	nm_mae_w				:= '';
	nr_seq_parentesco_w			:= '';
	ie_estado_civil_w			:= '';
	nr_cartao_sus_w				:= '';
	nr_declaracao_nascido_vivo_w		:= null;
	cd_usuario_plano_w			:= '';
	ds_observacao_w				:= '';
	nr_seq_plano_w				:= null;
	dt_adesao_plano_w			:= null;
	dt_admissao_w				:= null;
	cd_matricula_estipulante_w		:= '';
	dt_cancelamento_w			:= null;
	nr_seq_motivo_cancelamento_w		:= null;
	nr_ddi_telefone_w			:= '';
	nr_ddd_telefone_w			:= '';
	nr_telefone_w				:= '';
	nr_ddi_celular_w			:= '';
	nr_ddd_celular_w			:= '';
	nr_celular_w				:= '';
	nr_ddd_fax_w				:= '';
	nr_fax_w				:= '';
	cd_cep_w				:= '';
	ds_endereco_w				:= '';
	ds_bairro_w				:= '';
	ds_cidade_w				:= '';
	cd_municipio_ibge_w			:= '';
	sg_uf_w					:= '';
	nr_seq_canal_venda_w			:= null;
	nr_seq_vendedor_vinc_w			:= null;
	nr_seq_vendedor_vinc_w			:= null;
	cd_municipio_ibge_w			:= null;
	qt_registros_w				:= 0;
	NR_SEQ_TITULAR_SOLIC_w			:= null;
	nr_seq_segurado_w			:= null;
	nr_seq_motivo_susp_w			:= null;
	dt_suspensao_w				:= null;
	dt_solicitacao_w			:= null;
	dt_reativao_w				:= null;
	nr_seq_motivo_alt_prod_w		:= null;
	dt_alteracao_prod_w			:= null;

	while(ds_conteudo_w IS NOT NULL AND ds_conteudo_w::text <> '') loop
		if (position(';' in ds_conteudo_w) = 0) then
			ds_valor_w	:= ds_conteudo_w;
			ds_conteudo_w	:= null;
		else
			ds_valor_w	:= substr(ds_conteudo_w,1,position(';' in ds_conteudo_w) - 1);
			ds_conteudo_w	:= substr(ds_conteudo_w,position(';' in ds_conteudo_w) + 1,length(ds_conteudo_w));
		end if;

		qt_registros_w := qt_registros_w + 1;

		/*Operação*/

		if (qt_registros_w = 1) then
			ie_tipo_operacao_w	:= ds_valor_w;
		/*Contrato*/

		elsif (qt_registros_w = 3) then
			nr_contrato_w		:= ds_valor_w;
		/*CPF Titular*/

		elsif (qt_registros_w = 5) then
			nr_cpf_titular_w	:= ds_valor_w;
		/*CPF Dependente*/

		elsif (qt_registros_w = 6) then
			nr_cpf_dependente_w	:= ds_valor_w;
		/*Nome beneficiario*/

		elsif (qt_registros_w = 8) then
			nm_beneficiario_w	:= ds_valor_w;
		/*Data nascimento*/

		elsif (qt_registros_w = 9) then
			dt_data_aux_w		:= ds_valor_w;
			dt_nascimento_w		:= to_date(dt_data_aux_w,'dd/mm/yyyy');
		/*Sexo*/

		elsif (qt_registros_w = 10) then
			ie_sexo_w		:= ds_valor_w;
		/*Nome pai*/

		elsif (qt_registros_w = 11) then
			nm_pai_w 		:= ds_valor_w;
		/*Nome mãe*/

		elsif (qt_registros_w = 12) then
			nm_mae_w		:= ds_valor_w;
		/*Grau parentesco*/

		elsif (qt_registros_w = 13) then
			nr_seq_parentesco_w	:= ds_valor_w;
		/*Estado civil*/

		elsif (qt_registros_w = 14) then
			ie_estado_civil_w	:= ds_valor_w;
		/*PIS-Pasep*/

		elsif (qt_registros_w = 15) then
			nr_pis_pasep_w		:= ds_valor_w;
		/*CARTAO SUS*/

		elsif (qt_registros_w = 16) then
			nr_cartao_sus_w 	:= ds_valor_w;
		/*Declaração nascido vivo*/

		elsif (qt_registros_w = 17) then
			nr_declaracao_nascido_vivo_w := ds_valor_w;
		/*Carteira do beneficiário*/

		elsif (qt_registros_w = 18) then
			cd_usuario_plano_w	:= ds_valor_w;
		/*Cod sistema anterior*/

		elsif (qt_registros_w = 19) then
			cd_sistema_ant_w	:= ds_valor_w;
		/*Observações*/

		elsif (qt_registros_w = 20) then
			ds_observacao_w		:= ds_valor_w;
		/*Produto*/

		elsif (qt_registros_w = 21) then
			nr_seq_plano_w		:= ds_valor_w;
		/*Data de adesão*/

		elsif (qt_registros_w = 25) then
			dt_data_aux_w		:= ds_valor_w;
			dt_adesao_plano_w	:= to_date(dt_data_aux_w,'dd/mm/yyyy');
		/*Data suspensão*/

		elsif (qt_registros_w = 26) then
			dt_data_aux_w		:= ds_valor_w;
			dt_suspensao_w		:= to_date(dt_data_aux_w,'dd/mm/yyyy');
		/*Data reativação*/

		elsif (qt_registros_w = 27) then
			dt_data_aux_w		:= ds_valor_w;
			dt_reativao_w		:= to_date(dt_data_aux_w,'dd/mm/yyyy');
		/*Data admissão*/

		elsif (qt_registros_w = 28) then
			dt_data_aux_w		:= ds_valor_w;
			dt_admissao_w		:= to_date(dt_data_aux_w,'dd/mm/yyyy');
		/*Data alteração produto*/

		elsif (qt_registros_w = 30) then
			dt_data_aux_w		:= ds_valor_w;
			dt_alteracao_prod_w	:= to_date(dt_data_aux_w,'dd/mm/yyyy');
		/*Matircula de estipulante*/

		elsif (qt_registros_w = 31) then
			cd_matricula_estipulante_w	:= ds_valor_w;
		/*Motivo suspensão*/

		elsif (qt_registros_w = 32) then
			nr_seq_motivo_susp_w	:= ds_valor_w;
		/*Motivo alteração produto*/

		elsif (qt_registros_w = 33) then
			nr_seq_motivo_alt_prod_w	:= ds_valor_w;
		/*Data cancelamento*/

		elsif (qt_registros_w = 34) then
			dt_data_aux_w		:= ds_valor_w;
			dt_cancelamento_w	:= to_date(dt_data_aux_w,'dd/mm/yyyy');
		/*Motivo cancelamento*/

		elsif (qt_registros_w = 35) then
			NR_SEQ_MOTIVO_CANCELAMENTO_w	:= ds_valor_w;
		/*DDI telefone*/

		elsif (qt_registros_w = 36) then
			nr_ddi_telefone_w	:= ds_valor_w;
		/*DDD telefone*/

		elsif (qt_registros_w = 37) then
			nr_ddd_telefone_w	:= ds_valor_w;
		/*Telefone*/

		elsif (qt_registros_w = 38) then
			nr_telefone_w		:= ds_valor_w;
		/*DDI celular*/

		elsif (qt_registros_w = 39) then
			nr_ddi_celular_w	:= ds_valor_w;
		/*DDD celular*/

		elsif (qt_registros_w = 40) then
			nr_ddd_celular_w	:= ds_valor_w;
		/*Celular*/

		elsif (qt_registros_w = 41) then
			nr_celular_w		:= ds_valor_w;
		/*DDI FAX*/

		elsif (qt_registros_w = 42) then
			nr_ddi_fax_w		:= ds_valor_w;
		/*DDD FAX*/

		elsif (qt_registros_w = 43) then
			nr_ddd_fax_w		:= ds_valor_w;
		/*FAX*/

		elsif (qt_registros_w = 44) then
			nr_fax_w		:= ds_valor_w;
		/*Email*/

		elsif (qt_registros_w = 45) then
			ds_email_w		:= ds_valor_w;
		/*Pagina Web*/

		elsif (qt_registros_w = 46) then
			ds_pagina_web_w		:= ds_valor_w;
		/*CEP*/

		elsif (qt_registros_w = 47) then
			cd_cep_w		:= ds_valor_w;
		/*Logradouro*/

		elsif (qt_registros_w = 48) then
			ds_endereco_w		:= ds_valor_w;
		/*Bairro*/

		elsif (qt_registros_w = 49) then
			ds_bairro_w		:= ds_valor_w;
		/*Cidade*/

		elsif (qt_registros_w = 50) then
			ds_cidade_w		:= ds_valor_w;
		/*Estado*/

		elsif (qt_registros_w = 51) then
			sg_uf_w			:= ds_valor_w;
		/*Pais*/

		elsif (qt_registros_w = 52) then
			ds_pais_w		:= ds_valor_w;
		/*Posicições de 53 há 59 não são usadadas*/

		/*Canal de venda*/

		elsif (qt_registros_w = 60) then
			nr_seq_canal_venda_w	:= ds_valor_w;
		/*CPF vendedor vinculado*/

		elsif (qt_registros_w = 61) then
			cd_cpf_vendedor_vinculado_w	:= ds_valor_w;
		/*Código do pagador*/

		elsif (qt_registros_w = 62) then
			nr_seq_pagador_w	:= ds_valor_w;
		end if;
	end loop;

	if (ie_tipo_operacao_w = 'I') then
		cd_usuario_plano_w	:= '';
	else
		select	max(nr_seq_segurado)
		into STRICT	nr_seq_segurado_w
		from	pls_segurado_carteira
		where	cd_usuario_plano	= cd_usuario_plano_w;
	end if;

	if (ie_tipo_operacao_w = 'C') then
		ie_tipo_operacao_w	:= 'E';
	end if;

	select	max(cd_municipio_ibge)
	into STRICT	cd_municipio_ibge_w
	from	sus_municipio
	where	upper(ds_municipio)	= upper(ds_cidade_w)
	and	ds_unidade_federacao	= sg_uf_w;

	if (cd_cpf_vendedor_vinculado_w IS NOT NULL AND cd_cpf_vendedor_vinculado_w::text <> '') then
		select	max(b.nr_sequencia)
		into STRICT	nr_seq_vendedor_vinc_w
		from	pessoa_fisica		a,
			pls_vendedor_vinculado	b
		where	b.cd_pessoa_fisica	= a.cd_pessoa_fisica
		and	b.nr_seq_vendedor	= nr_seq_canal_venda_w
		and	a.nr_cpf		= cd_cpf_vendedor_vinculado_w;
	end if;

	if (nr_cpf_dependente_w IS NOT NULL AND nr_cpf_dependente_w::text <> '') then
		select	max(nr_sequencia)
		into STRICT	nr_seq_titular_solic_w
		from	pls_inclusao_beneficiario
		where	nr_seq_lote_inclusao	= nr_seq_lote_inclusao_p
		and	nr_cpf			= nr_cpf_titular_w;

		nr_cpf_titular_w	:= nr_cpf_dependente_w;
	else
		nr_seq_parentesco_w	:= null;
	end if;

	if (ie_tipo_operacao_w	= 'E') then
		dt_solicitacao_w	:= dt_cancelamento_w;
	elsif (ie_tipo_operacao_w	= 'S') then
		dt_solicitacao_w	:= dt_suspensao_w;
	elsif (ie_tipo_operacao_w	= 'R') then
		dt_solicitacao_w	:= dt_reativao_w;
	elsif (ie_tipo_operacao_w	= 'P') then
		dt_solicitacao_w	:= dt_alteracao_prod_w;
	end if;

	select	nextval('pls_inclusao_beneficiario_seq')
	into STRICT	nr_seq_inclusao_benef_w
	;

	insert	into	pls_inclusao_beneficiario(	nr_sequencia,dt_atualizacao,nm_usuario,dt_atualizacao_nrec,nm_usuario_nrec,
			cd_estabelecimento,nr_seq_lote_inclusao,ie_tipo_operacao,nr_cpf,nm_pessoa_fisica,
			ie_sexo,nm_pai,nm_mae,nr_seq_parentesco,ie_estado_civil,
			nr_cartao_nac_sus,cd_declaracao_nasc_vivo,cd_usuario_plano,ds_observacao,nr_seq_plano,
			dt_contratacao,dt_admissao,cd_matricula_est,dt_solicitacao,nr_seq_motivo_cancelamento,
			nr_ddi_telefone,nr_ddd_telefone,nr_telefone,nr_ddd_celular,nr_telefone_celular,
			nr_ddd_fax,nr_fax,ds_email,cd_cep,ds_endereco,ds_bairro,
			ds_municipio,cd_municipio_ibge,sg_estado,nr_seq_vendedor_canal,nr_seq_vendedor_pf,
			nr_seq_contrato,ie_tipo_inclusao,ie_processo,ie_etapa_solicitacao,ie_status,
			dt_nascimento,nr_pis_pasep,cd_nacionalidade,nr_seq_pagador,nr_cpf_vendedor,
			cd_sistema_anterior,nr_seq_titular_solic,nr_seq_segurado,nr_seq_motivo_susp,nr_seq_motivo_alt_plano,
			ie_status_mov)
	values (	nr_seq_inclusao_benef_w,clock_timestamp(),nm_usuario_p,clock_timestamp(),nm_usuario_p,
			cd_estabelecimento_p,nr_seq_lote_inclusao_p,ie_tipo_operacao_w,nr_cpf_titular_w,nm_beneficiario_w,
			ie_sexo_w,nm_pai_w,nm_mae_w,nr_seq_parentesco_w,ie_estado_civil_w,
			nr_cartao_sus_w,nr_declaracao_nascido_vivo_w,cd_usuario_plano_w,ds_observacao_w,nr_seq_plano_w,
			dt_adesao_plano_w,dt_admissao_w,cd_matricula_estipulante_w,dt_solicitacao_w,nr_seq_motivo_cancelamento_w,
			nr_ddi_telefone_w,nr_ddd_telefone_w,nr_telefone_w,nr_ddd_celular_w,nr_celular_w,
			nr_ddd_fax_w,nr_fax_w,ds_email_w,cd_cep_w,ds_endereco_w,ds_bairro_w,
			ds_cidade_w,cd_municipio_ibge_w,sg_uf_w,nr_seq_canal_venda_w,nr_seq_vendedor_vinc_w,
			nr_seq_contrato_p,'P','M','CV','P',
			dt_nascimento_w,nr_pis_pasep_w,cd_nacionalidade_w,nr_seq_pagador_w,cd_cpf_vendedor_vinculado_w,
			cd_sistema_ant_w,nr_seq_titular_solic_w,nr_seq_segurado_w,nr_seq_motivo_susp_w,nr_seq_motivo_alt_prod_w,
			'1');

	if (coalesce(ie_tipo_operacao_w,'I') = 'I') then
		pls_gerar_homonimo_pf(nm_beneficiario_w,to_char(dt_nascimento_w, 'dd/mm/yyyy'),nr_cpf_titular_w,nr_seq_inclusao_benef_w,nm_usuario_p);
	elsif (ie_tipo_operacao_w = 'A') and (nr_seq_segurado_w IS NOT NULL AND nr_seq_segurado_w::text <> '') then
		CALL pls_gravar_alt_solic_alteracao(nr_seq_inclusao_benef_w,nm_usuario_p);
	end if;

	end;
end loop;
close C01;

update	pls_lote_inclusao_benef
set	ie_situacao		= 'P',
	dt_importacao_arquivo	 = NULL
where	nr_sequencia		= nr_seq_lote_inclusao_p;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_imp_inclusao_div_versao_15 ( nr_seq_lote_inclusao_p bigint, nr_seq_contrato_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) FROM PUBLIC;

