-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_lote_producao_comp_opme ( nr_lote_producao_p bigint, nm_usuario_p text) AS $body$
DECLARE


cd_material_w				integer;
cd_material_comp_w			integer;
qt_prevista_w				double precision;
qt_dose_w					double precision;
cd_unidade_medida_dose_w	varchar(30);
cd_local_estoque_w			smallint;
nr_sequencia_w				bigint;
qt_material_w				double precision;
ie_necessita_disp_w			varchar(1);
nr_seq_estagio_w			bigint;

c01 CURSOR FOR
SELECT	b.cd_material,
	b.cd_unidade_medida_dose,
	b.nr_seq_componente,
	b.qt_dose,
	b.ie_necessita_disp
from	material m,
    	ficha_tecnica_componente b,
    	ficha_tecnica a
where	a.nr_ficha_tecnica	= b.nr_ficha_tecnica
and 	b.ie_situacao          	= 'A'
and 	b.ie_tipo_componente   	= 1
and 	b.cd_material          	= m.cd_material
and 	a.cd_material          	= cd_material_w;


BEGIN

delete	from lote_producao_comp
where	nr_lote_producao = nr_lote_producao_p;

select	a.cd_material,
	a.qt_prevista,
	a.cd_local_estoque
into STRICT	cd_material_w,
	qt_prevista_w,
	cd_local_estoque_w
from	material m,
	lote_producao a
where	nr_lote_producao	= nr_lote_producao_p
and 	a.cd_material		= m.cd_material;

nr_seq_estagio_w := obter_param_usuario(10025, 13, obter_perfil_ativo, nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento, nr_seq_estagio_w);

open c01;
loop
	fetch c01 into
		cd_material_comp_w,
		cd_unidade_medida_dose_w,
		nr_sequencia_w,
		qt_dose_w,
		ie_necessita_disp_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
		begin

		insert into lote_producao_comp(nr_lote_producao,
			nr_sequencia,
			cd_material,
			cd_unidade_medida,
			cd_unid_med_etq,
			cd_local_estoque,
			dt_atualizacao,
			nm_usuario,
			qt_prevista_etq,
			qt_prevista,
			qt_real,
			qt_estoque,
			qt_perda,
			qt_perda_etq,
			qt_unitaria,
			qt_dose_ficha_tecnica,
			cd_unid_med_ficha_tecnica,
			ie_necessita_disp,
			nr_seq_estagio)
		values (nr_lote_producao_p,
			nr_sequencia_w,
			cd_material_comp_w,
			cd_unidade_medida_dose_w,
	    		null,
			cd_local_estoque_w,
			clock_timestamp(),
			nm_usuario_p,
			0,
			coalesce(qt_dose_w,0) * coalesce(qt_prevista_w,0),
			0, 0, 0, 0,
			qt_dose_w,
			qt_dose_w,
			cd_unidade_medida_dose_w,
			ie_necessita_disp_w,
			nr_seq_estagio_w);
		end;
end loop;
close c01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_lote_producao_comp_opme ( nr_lote_producao_p bigint, nm_usuario_p text) FROM PUBLIC;

