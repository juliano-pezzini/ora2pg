-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE consiste_autor_medico_ipe ( cd_medico_p text, nr_atendimento_p bigint, ds_retorno_p INOUT text) AS $body$
DECLARE



			
ie_tipo_atendimento_w		smallint;
cd_convenio_w			integer;
ie_medico_liberado_w		varchar(2);
ie_tipo_consistencia_w		integer;
nr_crm_medico_eup_w		varchar(20);
ds_retorno_w			varchar(255);
			

BEGIN

begin
	select	a.ie_tipo_atendimento,
		b.cd_convenio
	into STRICT	ie_tipo_atendimento_w,
		cd_convenio_w
	from	atendimento_paciente a,
		atend_categoria_convenio b
	where	a.nr_atendimento	=	b.nr_atendimento
	and	b.nr_seq_interno	=	obter_atecaco_atendimento(b.nr_atendimento)
	and	a.nr_atendimento	=	nr_atendimento_p;
exception
when others then
	ie_tipo_atendimento_w	:=	0;
	cd_convenio_w		:=	0;
end;

	


if (cd_convenio_w	> 0) and (ie_tipo_atendimento_w > 0) then
	
	select	coalesce(max(ie_tipo_consistencia),0)
	into STRICT	ie_tipo_consistencia_w
	from	regra_ipe_autorizacao
	where	cd_convenio	=	cd_convenio_w
	and	coalesce(ie_tipo_atendimento,ie_tipo_atendimento_w)	=	ie_tipo_atendimento_w;
	
	if (ie_tipo_consistencia_w = 1) then
		
		begin
		
		select	substr(obter_crm_medico(cd_pessoa_fisica), 1, 255) nr_crm
		into STRICT	nr_crm_medico_eup_w
		from	medico
		where	cd_pessoa_fisica	=	cd_medico_p;
			
			
		select	coalesce(max('S'),'N')
		into STRICT	ie_medico_liberado_w
		from	w_medico_ipe
		where	nr_crm	=	nr_crm_medico_eup_w;	
		
		exception
		when others then
			ie_medico_liberado_w	:=	'S';
		end;
				
	end if;	
	
end if;

if (ie_medico_liberado_w = 'N') then
	ds_retorno_w	:= OBTER_TEXTO_TASY(308356,null);
end if;

ds_retorno_p	:= ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE consiste_autor_medico_ipe ( cd_medico_p text, nr_atendimento_p bigint, ds_retorno_p INOUT text) FROM PUBLIC;

