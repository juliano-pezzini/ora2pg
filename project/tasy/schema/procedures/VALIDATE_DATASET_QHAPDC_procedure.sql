-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE validate_dataset_qhapdc ( nr_seq_dataset_p bigint, ie_dataset_p text, nm_usuario_p text, nr_atendimento_p bigint) AS $body$
DECLARE

  qt_rec_segmento_w   bigint;
  qt_erro_w           bigint;
  qt_alerta_w         bigint;
  nr_seq_estrut_arq_w bigint;
  c01 CURSOR FOR
    SELECT nr_sequencia,
      ie_segment,
      IE_MANDATORY
    FROM QHAPDC_SEGMENT_STRUCT

    WHERE ie_segment = ie_dataset_p;
  c01_w c01%rowtype;

BEGIN
  OPEN C01;
  LOOP
    FETCH C01 INTO c01_w;
    EXIT WHEN NOT FOUND; /* apply on C01 */

    qt_rec_segmento_w := Obter_valor_Dinamico( 'SELECT COUNT(*) QT FROM QHAPDC_SEGMENT_'|| c01_w.ie_segment || ' WHERE NR_DATASET = '|| nr_seq_dataset_p, qt_rec_segmento_w);

    IF (c01_w.IE_MANDATORY = 'S' AND qt_rec_segmento_w = 0) THEN
      --The segment # @ IE_SEGMENTO # @ is required for this dataset.
      CALL GENERATE_DATASET_INCONSISTENCY( nr_seq_dataset_p, 'E', wheb_mensagem_pck.GET_TEXTO(996261,'IE_SEGMENTO='||c01_w.ie_segment||';'), nm_usuario_p, c01_w.ie_segment, nr_atendimento_p);
    END IF;
    IF (qt_rec_segmento_w > 0) THEN
      CALL VALIDATE_SEGMENT_QHAPDC(c01_w.nr_sequencia,nr_seq_dataset_p,c01_w.ie_segment,nm_usuario_p, nr_atendimento_p);
    END IF;
  END LOOP;
  CLOSE C01;
  BEGIN
    SELECT 1
    INTO STRICT qt_erro_w
    FROM QHAPDC_INCONSISTENCY_DS
    WHERE nr_seq_dataset = nr_seq_dataset_p
    AND IE_TYPE          = 'E'  LIMIT 1;
  EXCEPTION
  WHEN OTHERS THEN
    qt_erro_w := 0;
  END;
  BEGIN
    SELECT 1
    INTO STRICT qt_alerta_w
    FROM QHAPDC_INCONSISTENCY_DS
    WHERE nr_seq_dataset = nr_seq_dataset_p
    AND IE_TYPE          = 'A'  LIMIT 1;
  EXCEPTION
  WHEN OTHERS THEN
    qt_alerta_w := 0;
  END;
  IF (qt_erro_w > 0) THEN
    UPDATE qhapdc_dataset_send
    SET IE_VALIDATION_STATUS = 'E'
    WHERE nr_sequencia       = nr_seq_dataset_p;
  elsif (qt_alerta_w         > 0) THEN
    UPDATE qhapdc_dataset_send
    SET IE_VALIDATION_STATUS = 'A'
    WHERE nr_sequencia       = nr_seq_dataset_p;
  ELSE
    UPDATE qhapdc_dataset_send
    SET IE_VALIDATION_STATUS = 'V',
      IE_SENDING_STATUS      = 'P'
    WHERE nr_sequencia       = nr_seq_dataset_p;
  END IF;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE validate_dataset_qhapdc ( nr_seq_dataset_p bigint, ie_dataset_p text, nm_usuario_p text, nr_atendimento_p bigint) FROM PUBLIC;

