-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE baca_custo_padrao_comp_pk () AS $body$
DECLARE



cd_estabelecimento_w		bigint;
cd_tabela_custo_w		bigint;
cd_tipo_gasto_w			varchar(10);
nr_ficha_tecnica_w		bigint;
nr_seq_componente_w		bigint;
cd_grupo_natureza_gasto_w	bigint;
ds_comando_w			varchar(2000);
ds_erro_w			varchar(1000);
ds_log_w			varchar(2000);
qt_commit_w			bigint	:= 0;
qt_registro_w			bigint;

c01 CURSOR FOR
SELECT	cd_estabelecimento,
	cd_tabela_custo,
	nr_ficha_tecnica,
	nr_seq_componente,
	cd_tipo_gasto,
	cd_grupo_natureza_gasto
from	custo_padrao_comp
where	coalesce(nr_sequencia::text, '') = '';



BEGIN

select	count(*)
into STRICT	qt_registro_w
from	custo_padrao_comp
where	coalesce(nr_sequencia::text, '') = '';

if (qt_registro_w > 0) then
	begin

	open C01;
	loop
	fetch C01 into
		cd_estabelecimento_w,
		cd_tabela_custo_w,
		nr_ficha_tecnica_w,
		nr_seq_componente_w,
		cd_tipo_gasto_w,
		cd_grupo_natureza_gasto_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin

		qt_commit_w	:= qt_commit_w + 1;
		begin
		update	custo_padrao_comp
		set	nr_sequencia		= nextval('custo_padrao_comp_seq')
		where	cd_estabelecimento	= cd_estabelecimento_w
		and	cd_tabela_custo		= cd_tabela_custo_w
		and	nr_ficha_tecnica	= nr_ficha_tecnica_w
		and	nr_seq_componente	= nr_seq_componente_w
		and	cd_tipo_gasto		= cd_tipo_gasto_w
		and	cd_grupo_natureza_gasto	= cd_grupo_natureza_gasto_w
		and	coalesce(nr_sequencia::text, '') = '';

		exception when others then
			ds_erro_w	:= sqlerrm(SQLSTATE);
			ds_log_w	:= substr('Erro ao atualizar NR_SEQUENCIA: ' || ds_erro_w,1,2000);

			/*insert into logxxxx_tasy(
				cd_log,
				ds_log,
				nm_usuario,
				dt_atualizacao)
			values(	944,
				ds_log_w,
				'CUSPACO_PK',
				sysdate);*/
		end;

		if (qt_commit_w >= 3000) then
			commit;
			qt_commit_w	:= 0;
		end if;
		end;
	end loop;
	close C01;
	commit;
	end;
end if;

select	count(*)
into STRICT	qt_registro_w
from	custo_padrao_comp
where	coalesce(nr_sequencia::text, '') = '';

if (qt_registro_w = 0) then
	begin
	select	count(*)
	into STRICT	qt_registro_w
	from	user_tab_columns
	where	table_name	= 'CUSTO_PADRAO_COMP'
	and	column_name	= 'NR_SEQUENCIA'
	and	nullable	= 'Y';

	if (qt_registro_w > 0) then
		CALL exec_sql_dinamico('Matheus','alter table CUSTO_PADRAO_COMP modify NR_SEQUENCIA number(10) not null');
	end if;

	select	count(*)
	into STRICT	qt_registro_w
	from	user_cons_columns
	where	constraint_name	= 'CUSPACO_PK'
	and	column_name	= 'NR_SEQUENCIA';

	if (qt_registro_w = 0) then
		CALL exec_sql_dinamico('Matheus','alter table CUSTO_PADRAO_COMP drop constraint CUSPACO_PK');
		CALL exec_sql_dinamico('Matheus','drop index CUSPACO_PK');
		ds_comando_w	:= 'alter table CUSTO_PADRAO_COMP modify CD_GRUPO_NATUREZA_GASTO null';
		CALL exec_sql_dinamico('Matheus',ds_comando_w);
		ds_comando_w	:= 'Alter Table CUSTO_PADRAO_COMP add ( Constraint CUSPACO_PK Primary Key (NR_SEQUENCIA) Using Index Tablespace TASY_INDEX)';
		CALL exec_sql_dinamico('Matheus',ds_comando_w);
	end if;
	end;
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE baca_custo_padrao_comp_pk () FROM PUBLIC;

