-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE consistir_regra_validade_mat ( cd_estabelecimento_p bigint, cd_material_p bigint, nr_documento_p bigint) AS $body$
DECLARE



cd_grupo_material_w			smallint;
cd_subgrupo_material_w			smallint;
cd_classe_material_w			integer;
nr_seq_familia_w				integer;
qt_dias_w				bigint;
dt_vencimento_w				timestamp;
qt_vencimento_w				bigint;
ie_retorno_w				varchar(1) := 'N';
cd_material_w				integer;
nr_sequencia_w				bigint;
ds_alerta_w				varchar(255);



c01 CURSOR FOR
SELECT	qt_dias
from	sup_consist_validade_lote a
where	cd_estabelecimento = cd_estabelecimento_p
and	coalesce(cd_grupo_material, cd_grupo_material_w)		= cd_grupo_material_w
and	coalesce(cd_subgrupo_material, cd_subgrupo_material_w)	= cd_subgrupo_material_w
and	coalesce(cd_classe_material, cd_classe_material_w)		= cd_classe_material_w
and (coalesce(cd_material, cd_material_p) 			= cd_material_p or cd_material_p = 0)
order by
	coalesce(cd_material, 0),
	coalesce(cd_classe_material, 0),
	coalesce(cd_subgrupo_material, 0),
	coalesce(cd_grupo_material, 0);


BEGIN

select	cd_grupo_material,
	cd_subgrupo_material,
	cd_classe_material,
	nr_seq_familia
into STRICT	cd_grupo_material_w,
	cd_subgrupo_material_w,
	cd_classe_material_w,
	nr_seq_familia_w
from	estrutura_material_v
where	cd_material = cd_material_p;

open C01;
loop
fetch C01 into
	qt_dias_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin

	select trunc(clock_timestamp()) + qt_dias_w
	into STRICT   dt_vencimento_w
	;



	select  count(*)
	into STRICT	qt_vencimento_w
	from 	ordem_compra_item
	where   trunc(dt_validade,'dd')  <  dt_vencimento_w
	and	nr_ordem_compra = nr_documento_p
	AND	(dt_validade IS NOT NULL AND dt_validade::text <> '')
	and	cd_material  	= cd_material_p;

	if (qt_vencimento_w > 0) then
		select 	coalesce(max(nr_sequencia),0) + 1
		into STRICT	nr_sequencia_w
		from 	w_consiste_dt_validade;

		select Wheb_mensagem_pck.get_Texto(301901, 'CD_MATERIAL_P='|| CD_MATERIAL_P) /*'O material '||cd_material_p||' Esta para vencer!'*/
		into STRICT	ds_alerta_w
		;


		INSERT INTO w_consiste_dt_validade(NR_SEQUENCIA,
						   CD_MATERIAL,
						   DS_ALERTA,
						   nr_documento)
		VALUES (				   nr_sequencia_w,
						   cd_material_p,
						   ds_alerta_w,
						   nr_documento_p);


	end if;
	end;
end loop;
close C01;


commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE consistir_regra_validade_mat ( cd_estabelecimento_p bigint, cd_material_p bigint, nr_documento_p bigint) FROM PUBLIC;

