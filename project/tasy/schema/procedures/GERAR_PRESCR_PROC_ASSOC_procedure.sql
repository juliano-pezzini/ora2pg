-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_prescr_proc_assoc ( nr_prescricao_p bigint, nr_sequencia_p bigint, nm_usuario_p text, ie_proced_vinculado_p text default 'T') AS $body$
DECLARE


-- OS 583829 // Somente ajustei a ordem das restricoes nos select's
nr_seq_acum_w			bigint;
nr_agrup_acum_w			double precision;
cd_estabelecimento_w	smallint;
dt_prescricao_w			timestamp;
cd_setor_atendimento_w	integer;
qt_idade_pac_w			double precision;
qt_idade_min_w			real;
qt_idade_max_w			real;
nr_seq_proc_int_adic_w 	bigint;
cd_proced_adic_w		bigint;
ie_origem_proc_adic_w 	bigint;
qt_proc_adic_w			double precision;
nm_usuario_w			varchar(15);
ie_agenda_integrada_w	varchar(7);
cd_intervalo_w			varchar(7);
ie_sem_usuario_w		varchar(2);
cd_intervalo_padr_w		varchar(7);
ds_dado_clinico_w		varchar(2000);
cd_material_exame_w		varchar(20);
cd_plano_w				varchar(20);
cd_prescritor_w			varchar(20);
ie_urgencia_w			varchar(20);
nr_seq_exame_w			bigint;
cd_edicao_amb_w			bigint;
ie_origem_inf_w			varchar(1);
nr_agrupamento_w		integer;
ds_horarios_w			varchar(2000);
nr_ocorrencia_w			bigint;
ie_cobra_paciente_w		varchar(1);
nr_atendimento_w		bigint;
cd_setor_proc_w			integer;
dt_prev_execucao_w		timestamp;
nr_sequencia_w			integer;
cd_convenio_w			integer;
ie_tipo_regra_w			varchar(1);
ie_origem_proc_filtro_w	bigint;
ie_tipo_atendimento_w	smallint;
ie_tipo_convenio_w		smallint;
cd_categoria_w			varchar(10);
cd_medico_exec_w		varchar(10);
cd_setor_prescr_proc_w	integer;
ie_proced_vinculado_w	varchar(1);
nr_seq_interno_w		bigint;
ie_gera_qt_proc_principal_w varchar(1);
nm_usuario_orig_w		varchar(15);
cd_perfil_orig_w		bigint;
ie_prescr_proc_sem_lib_w varchar(30);
cd_proc_adic_w			bigint;
nr_doc_convenio_w		varchar(255);
ie_guia_w				varchar(255);
nr_seq_regra_plano_w	bigint;
ie_regra_w				bigint;
ie_autorizacao_w		varchar(10);
ie_lado_w				varchar(10);
ds_observacao_w			varchar(2000);
nr_horas_validade_w		bigint;
nr_ocorrencia_proced_w	bigint;
ds_horarios_proced_w	varchar(2000);
ds_horarios_proced2_w	varchar(2000);
ie_sexo_prescr_w		varchar(1);
nr_seq_contraste_w		prescr_procedimento.nr_seq_contraste%type;
ds_resumo_clinico_w		prescr_procedimento.ds_resumo_clinico%type;
ds_justificativa_w		prescr_procedimento.ds_justificativa%type;
ie_anestesia_w			prescr_procedimento.ie_anestesia%type;
cd_funcao_ativa_w		bigint;
ie_utiliza_regra_medico_w varchar(1);
ie_medico_executor_w	varchar(1);
cd_cgc_w 				varchar(14);
cd_pessoa_fisica_w 		medico.cd_pessoa_fisica%type;
cd_medico_executor_w	medico.cd_pessoa_fisica%type;
ie_entrou_cursor_c01_w	varchar(1) := 'N';
ds_erro_w				varchar(255);
VarEliminaHorFinalVig_w	varchar(1);
dt_inicio_prescr_w		prescr_medica.dt_inicio_prescr%type;
ie_resp_autor_w			varchar(10);

C01 CURSOR FOR
	SELECT	nr_seq_acum_w + row_number() OVER () AS rownum,
			a.nr_seq_proc_int_adic,
			CASE WHEN coalesce(ie_gera_qt_proc_principal_w,'N')='S' THEN  p.qt_procedimento  ELSE coalesce(Obter_dose_W_item_prescr(a.nr_Sequencia, nr_prescricao_P, 'PVPi'), a.qt_proc_adic) END ,
			p.nm_usuario,
			p.cd_intervalo,
			p.ds_dado_clinico,
			m.cd_material_exame,
			a.nr_seq_exame,
			p.ie_origem_inf,
			nr_agrup_acum_w + rownum,
			p.ds_horarios,
			p.nr_ocorrencia,
			coalesce(a.ie_cobra_paciente,'S'),
			p.dt_prev_execucao,
			a.cd_procedimento,
			a.ie_origem_proced,
			a.ie_tipo_regra,
			p.cd_medico_exec,
			p.cd_setor_atendimento,
			a.ie_proced_vinculado,
			p.nr_seq_interno,
			p.ie_lado,
			substr(a.DS_OBSERVACAO || '  ' || p.ds_observacao,1,255),
			a.cd_intervalo,
			p.ie_urgencia,
			a.ie_agenda_integrada,
			p.nr_seq_contraste,
			p.ds_resumo_clinico,
			p.ds_justificativa,
			p.ie_anestesia
	FROM prescr_procedimento p, proc_int_proc_prescr a
LEFT OUTER JOIN material_exame_lab m ON (a.nr_seq_material = m.nr_sequencia)
WHERE 1 = 1  and ((coalesce(a.cd_estabelecimento::text, '') = '') or (cd_estabelecimento = cd_estabelecimento_w)) and ((coalesce(a.ie_permite_duplicado,'N')	= 'S') or
			 (not exists(	SELECT	1
							from	prescr_procedimento b
							where	1 = 1
							and		((coalesce(a.nr_seq_proc_int_adic,0) = 0) or (b.nr_seq_proc_interno = a.nr_seq_proc_int_adic))
							and		((coalesce(a.cd_procedimento,0) = 0) or (b.cd_procedimento = a.cd_procedimento))
							and		b.nr_prescricao	= nr_prescricao_p))) and (((coalesce(qt_idade_pac_w::text, '') = '') or (coalesce(a.qt_idade_min::text, '') = '' and coalesce(a.qt_idade_max::text, '') = '')) or
			 ((qt_idade_pac_w IS NOT NULL AND qt_idade_pac_w::text <> '') and (qt_idade_pac_w between coalesce(a.qt_idade_min,qt_idade_pac_w) and coalesce(a.qt_idade_max,qt_idade_pac_w)))) and ((coalesce(ie_proced_vinculado_p,'T') = 'T') or (a.ie_proced_vinculado = ie_proced_vinculado_p)) and ((ie_sexo = ie_sexo_prescr_w) or (coalesce(ie_sexo::text, '') = '')) and coalesce(a.cd_convenio,cd_convenio_w) = cd_convenio_w and ((coalesce(a.cd_edicao_amb::text, '') = '') or (a.cd_edicao_amb = cd_edicao_amb_w)) and ((coalesce(a.cd_convenio_excluir::text, '') = '') or (a.cd_convenio_excluir <> cd_convenio_w)) and ((coalesce(a.cd_categoria_convenio::text, '') = '') or (a.cd_categoria_convenio = cd_categoria_w)) and ((a.cd_plano_convenio	= cd_plano_w) or (coalesce(a.cd_plano_convenio::text, '') = '')) and ((coalesce(a.cd_medico_prescritor::text, '') = '') or (a.cd_medico_prescritor = p.cd_medico_exec)) and ((coalesce(a.cd_medico_excluir::text, '') = '') or (a.cd_medico_excluir <> p.cd_medico_exec)) and ((a.ie_origem_proc_filtro = ie_origem_proc_filtro_w) or (coalesce(a.ie_origem_proc_filtro::text, '') = '')) and obter_conv_excluir_proc_assoc(a.nr_sequencia, cd_convenio_w, cd_edicao_amb_w, ie_origem_proc_filtro_w) = 'S' and ((coalesce(cd_perfil::text, '') = '') or (cd_perfil = obter_perfil_ativo)) and coalesce(a.ie_situacao,'A')	= 'A' and coalesce(a.ie_somente_agenda_int,'N') = 'N' and coalesce(a.ie_somente_agenda_cir,'N') = 'N' and a.nr_seq_proc_interno	= p.nr_seq_proc_interno and p.nr_sequencia		= nr_sequencia_p and p.nr_prescricao		= nr_prescricao_p and coalesce(a.ie_tipo_convenio,ie_tipo_convenio_w)      = ie_tipo_convenio_w;

C02 CURSOR FOR
	SELECT	nr_seq_acum_w + row_number() OVER () AS rownum,
			a.cd_proc_adic,
			a.ie_orig_proced_adic,
			a.qt_proc_adic,
			p.nm_usuario,
			p.cd_intervalo,
			coalesce(Obter_setor_Atend_proc(cd_estabelecimento_w, a.cd_proc_adic,a.ie_orig_proced_adic, null, cd_setor_atendimento_w, p.nm_usuario,null,nr_atendimento_w,'N'),p.cd_setor_atendimento),
			p.ds_dado_clinico,
			Obter_data_prev_exec(dt_prescricao_w,p.dt_prev_execucao,Obter_setor_Atend_proc(cd_estabelecimento_w, a.cd_proc_adic,a.ie_orig_proced_adic, null, cd_setor_atendimento_w, p.nm_usuario,null,nr_atendimento_w,'N'), nr_prescricao_p, 'A'),
			m.cd_material_exame,
			a.nr_seq_exame,
			p.ie_origem_inf,
			nr_agrup_acum_w + rownum,
			p.ds_horarios,
			p.nr_ocorrencia,
			coalesce(a.ie_cobra_paciente,'S'),
			p.cd_medico_exec,
			p.nr_seq_interno
	FROM prescr_procedimento p, procedimento_proc_prescr a
LEFT OUTER JOIN material_exame_lab m ON (a.nr_seq_material = m.nr_sequencia)
WHERE 1 = 1  and not exists (	SELECT	1
						from	prescr_procedimento b
						where	b.cd_procedimento	= a.cd_proc_adic
						and		b.nr_prescricao	= nr_prescricao_p) and (((coalesce(qt_idade_pac_w::text, '') = '') or (coalesce(a.qt_idade_min::text, '') = '' and coalesce(a.qt_idade_max::text, '') = '')) or
			 ((qt_idade_pac_w IS NOT NULL AND qt_idade_pac_w::text <> '') and (qt_idade_pac_w between coalesce(a.qt_idade_min,qt_idade_pac_w) and coalesce(a.qt_idade_max,qt_idade_pac_w)))) and ((coalesce(a.nr_seq_Exame_filtro,0) = 0) or (a.nr_seq_Exame_filtro = p.nr_seq_exame)) and ((coalesce(a.cd_setor_atendimento::text, '') = '') or (a.cd_setor_atendimento = cd_setor_atendimento_w)) and a.ie_origem_proced	= p.ie_origem_proced and a.cd_procedimento 	= p.cd_procedimento and p.nr_sequencia		= nr_sequencia_p and p.nr_prescricao		= nr_prescricao_p;


BEGIN

if	((coalesce(nr_prescricao_p,0) > 0) and (coalesce(nr_sequencia_p,0) > 0)) then

	select	coalesce(cd_estabelecimento,1),
			dt_prescricao,
			cd_setor_atendimento,
			nr_atendimento,
			coalesce(cd_prescritor,cd_medico),
			nr_horas_validade,
			dt_inicio_prescr
	into STRICT	cd_estabelecimento_w,
			dt_prescricao_w,
			cd_setor_atendimento_w,
			nr_atendimento_w,
			cd_prescritor_w,
			nr_horas_validade_w,
			dt_inicio_prescr_w
	from	prescr_medica
	where	nr_prescricao	= nr_prescricao_p;


	select	wheb_usuario_pck.get_nm_usuario,
			wheb_usuario_pck.get_cd_perfil
	into STRICT	nm_usuario_orig_w,
			cd_perfil_orig_w
	;

	ie_gera_qt_proc_principal_w := obter_param_usuario(924, 517, cd_perfil_orig_w, coalesce(nm_usuario_orig_w, nm_usuario_p), 0, ie_gera_qt_proc_principal_w);
	ie_prescr_proc_sem_lib_w := Obter_Param_Usuario(924, 530, cd_perfil_orig_w, coalesce(nm_usuario_orig_w, nm_usuario_p), cd_estabelecimento_w, ie_prescr_proc_sem_lib_w);
	ie_sem_usuario_w := Obter_Param_Usuario(924, 658, cd_perfil_orig_w, coalesce(nm_usuario_orig_w, nm_usuario_p), cd_estabelecimento_w, ie_sem_usuario_w);
	ie_utiliza_regra_medico_w := Obter_Param_Usuario(916, 1104, cd_perfil_orig_w, coalesce(nm_usuario_orig_w, nm_usuario_p), cd_estabelecimento_w, ie_utiliza_regra_medico_w);
	VarEliminaHorFinalVig_w := Obter_Param_Usuario(924, 443, cd_perfil_orig_w, coalesce(nm_usuario_orig_w, nm_usuario_p), cd_estabelecimento_w, VarEliminaHorFinalVig_w);

	cd_funcao_ativa_w := Obter_Funcao_Ativa;

	select 	max(ie_tipo_atendimento)
	into STRICT	ie_tipo_atendimento_w
	from 	atendimento_paciente
	where 	nr_atendimento = nr_atendimento_w;

	select coalesce(max(nr_sequencia),0),
		coalesce(max(nr_agrupamento),0)
	into STRICT	nr_seq_acum_w,
		nr_agrup_acum_w
	from	prescr_procedimento
	where nr_prescricao		= nr_prescricao_p;

	select	obter_idade_pf(cd_pessoa_fisica, clock_timestamp(), 'A')
	into STRICT	qt_idade_pac_w
	from	prescr_medica
	where	nr_prescricao = nr_prescricao_p;

	select 	coalesce(max(obter_convenio_atendimento(nr_atendimento_w)),0),
		coalesce(max(obter_categoria_atendimento(nr_atendimento_w)),0)
	into STRICT	cd_convenio_w,
		cd_categoria_w
	;

	select	max(Obter_Plano_Atendimento(nr_atendimento_w,'C'))
	into STRICT	cd_plano_w
	;

	select 	max(ie_tipo_convenio)
	into STRICT	ie_tipo_convenio_w
	from 	convenio
	where 	cd_convenio = cd_convenio_w;

	ie_origem_proc_filtro_w:= Obter_Origem_Proced_Cat(cd_estabelecimento_w, ie_tipo_atendimento_w, ie_tipo_convenio_w, cd_convenio_w, cd_categoria_w);

	ie_sexo_prescr_w := Obter_Sexo_Prescricao(nr_prescricao_p);

	SELECT	coalesce(max(CD_EDICAO_AMB),0)
	INTO STRICT	CD_EDICAO_AMB_W
	FROM 	CONVENIO_AMB
	WHERE (CD_ESTABELECIMENTO     = cd_estabelecimento_w)
	AND (CD_CONVENIO            = cd_convenio_w)
	AND (coalesce(IE_SITUACAO,'A')   = 'A')
	and	((coalesce(cd_categoria_w,'0') = '0') or (cd_categoria = cd_categoria_w))
	AND 	(DT_INICIO_VIGENCIA     =
			(SELECT	MAX(DT_INICIO_VIGENCIA)
			FROM 	CONVENIO_AMB A
			WHERE (A.CD_ESTABELECIMENTO  	= cd_estabelecimento_w)
			AND (A.CD_CONVENIO         	= CD_CONVENIO_w)
			AND (coalesce(A.IE_SITUACAO,'A')	= 'A')
			and	((coalesce(cd_categoria_w,'0') = '0') or (a.cd_categoria = cd_categoria_w))
			AND (A.DT_INICIO_VIGENCIA 	<=  clock_timestamp())));

	ie_entrou_cursor_c01_w := 'N';
	open C01;
	loop
	fetch C01 into
		nr_sequencia_w,
		nr_seq_proc_int_adic_w,
		qt_proc_adic_w,
		nm_usuario_w,
		cd_intervalo_w,
		ds_dado_clinico_w,
		cd_material_exame_w,
		nr_seq_exame_w,
		ie_origem_inf_w,
		nr_agrupamento_w,
		ds_horarios_w,
		nr_ocorrencia_w,
		ie_cobra_paciente_w,
		dt_prev_execucao_w,
		cd_proced_adic_w,
		ie_origem_proc_adic_w,
		ie_tipo_regra_w,
		cd_medico_exec_w,
		cd_setor_prescr_proc_w,
		ie_proced_vinculado_w,
		nr_seq_interno_w,
		ie_lado_w,
		ds_observacao_w,
		cd_intervalo_padr_w,
		ie_urgencia_w,
		ie_agenda_integrada_w,
		nr_seq_contraste_w,
		ds_resumo_clinico_w,
		ds_justificativa_w,
		ie_anestesia_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin

		/*insert into junior(ds) values(cd_proced_adic_w);
		if (nvl(wheb_usuario_pck.get_ie_commit, 'S') = 'S') then commit; end if;*/
		if (ie_tipo_regra_w = 'I') then
			SELECT * FROM obter_proc_tab_interno(nr_seq_proc_int_adic_w, nr_prescricao_p, nr_atendimento_w, 0, cd_proced_adic_w, ie_origem_proc_adic_w, null, null) INTO STRICT cd_proced_adic_w, ie_origem_proc_adic_w;
		end if;

		if (nr_seq_exame_w IS NOT NULL AND nr_seq_exame_w::text <> '') then
			select	max(obter_setor_atend_proc_lab(cd_estabelecimento_w,cd_proced_adic_w,ie_origem_proc_adic_w, null,cd_setor_atendimento_w,null,nr_seq_exame_w,null,'N' ))
			into STRICT	cd_setor_proc_w
			;
		elsif (ie_sem_usuario_w = 'N') then
			select 	Obter_setor_Atend_proc(cd_estabelecimento_w, cd_proced_adic_w ,ie_origem_proc_adic_w , null, cd_setor_atendimento_w, nm_usuario_w, nr_seq_proc_int_adic_w,nr_atendimento_w,'N')
			into STRICT	cd_setor_proc_w
			;
		else
			select 	Obter_setor_Atend_proc(cd_estabelecimento_w, cd_proced_adic_w ,ie_origem_proc_adic_w , null, cd_setor_atendimento_w, null, nr_seq_proc_int_adic_w,nr_atendimento_w,'N')
			into STRICT	cd_setor_proc_w
			;
		end if;

		select 	Obter_data_prev_exec(dt_prescricao_w, dt_prev_execucao_w ,cd_setor_proc_w, nr_prescricao_p, 'A')
		into STRICT	dt_prev_execucao_w
		;

		nr_doc_convenio_w		:= null;
		SELECT * FROM tiss_obter_guia(4, null, nr_doc_convenio_w, 'N', null, null, null, null, null, ie_guia_w, null, nr_prescricao_p, null, cd_setor_proc_w, null, nr_prescricao_p, null, null, null, null, null, null, cd_proced_adic_w, ie_origem_proc_adic_w, null) INTO STRICT nr_doc_convenio_w, ie_guia_w;

		if (cd_intervalo_padr_w IS NOT NULL AND cd_intervalo_padr_w::text <> '') then
			SELECT * FROM Calcular_Horario_Prescricao(nr_prescricao_p, cd_intervalo_padr_w, dt_prescricao_w, coalesce(dt_prev_execucao_w,dt_prescricao_w), nr_horas_validade_w, cd_proced_adic_w, 0, 0, nr_ocorrencia_proced_w, ds_horarios_proced_w, ds_horarios_proced2_w, 'N', null) INTO STRICT nr_ocorrencia_proced_w, ds_horarios_proced_w, ds_horarios_proced2_w;

			nr_ocorrencia_w := nr_ocorrencia_proced_w;
			ds_horarios_w	:= ds_horarios_proced_w;

			if (vareliminahorfinalvig_w = 'S') and (ds_horarios_w IS NOT NULL AND ds_horarios_w::text <> '') then
				ds_horarios_w := Eliminar_hor_vigencia_proc(ds_horarios_w, cd_intervalo_padr_w, coalesce(dt_prev_execucao_w,dt_prescricao_w), dt_inicio_prescr_w, 0, 0, nr_prescricao_p, coalesce(ie_urgencia_w,'N'),dt_prev_execucao_w);
			end if;
		end if;

		if (cd_funcao_ativa_w = 916) and --OS 660969
			(ie_utiliza_regra_medico_w = 'S') then
            
			SELECT * FROM consiste_medico_executor(
						cd_estabelecimento_w, cd_convenio_w, cd_setor_atendimento_w, cd_proced_adic_w, ie_origem_proc_adic_w, Obter_Tipo_Atendimento(nr_atendimento_w), nr_seq_exame_w, nr_seq_proc_int_adic_w, ie_medico_executor_w, cd_cgc_w, cd_medico_executor_w, cd_pessoa_fisica_w, null, coalesce(dt_prev_execucao_w,dt_prescricao_w), Obter_Classificacao_Atend(nr_atendimento_w,'C'), 'N', null, null) INTO STRICT ie_medico_executor_w, cd_cgc_w, cd_medico_executor_w, cd_pessoa_fisica_w;

			if (ie_medico_executor_w = 'F') then
				cd_medico_exec_w	:= coalesce(cd_medico_executor_w,cd_medico_exec_w);
			end if;
		end if;

		Insert	into Prescr_Procedimento(
			nr_prescricao,
			nr_sequencia,
			nr_seq_proc_interno,
			cd_procedimento,
			ie_origem_proced,
			qt_procedimento,
			dt_atualizacao,
			nm_usuario,
			cd_motivo_baixa,
			cd_intervalo,
			ie_urgencia,
			cd_setor_atendimento,
			ds_dado_clinico,
			dt_prev_execucao,
			ie_suspenso,
			cd_material_exame,
			nr_seq_exame,
			ie_origem_inf,
			ie_amostra,
			ie_executar_leito,
			nr_agrupamento,
			ie_se_necessario,
			ie_acm,
			ds_horarios,
			nr_ocorrencia,
			nr_seq_interno,
			ie_avisar_result,
			ie_cobra_paciente,
			cd_medico_exec,
			nr_seq_proc_princ,
			nr_doc_convenio,
			ie_lado,
			ds_observacao,
			ie_exame_assoc,
			nr_seq_proc_excl,
			nr_seq_contraste,
			ds_resumo_clinico,
			ds_justificativa,
			ie_anestesia)
		values (nr_prescricao_p,
			nr_sequencia_w,
			nr_seq_proc_int_adic_w,
			cd_proced_adic_w,
			ie_origem_proc_adic_w,
			qt_proc_adic_w,
			clock_timestamp(),
			nm_usuario_w,
			0,
			coalesce(cd_intervalo_padr_w, cd_intervalo_w),
			coalesce(ie_urgencia_w,'N'),
			coalesce(cd_setor_proc_w,cd_setor_prescr_proc_w),
			ds_dado_clinico_w,
			dt_prev_execucao_w,
			'N',
			cd_material_exame_w,
			nr_seq_exame_w,
			ie_origem_inf_w,
			'N',
			'N',
			nr_agrupamento_w,
			'N',
			'N',
			ds_horarios_w,
			nr_ocorrencia_w,
			nextval('prescr_procedimento_seq'),
			'N',
			ie_cobra_paciente_w,
			cd_medico_exec_w,
			CASE WHEN ie_proced_vinculado_w='S' THEN nr_seq_interno_w  ELSE null END ,
			nr_doc_convenio_w,
			ie_lado_w,
			ds_observacao_w,
			CASE WHEN ie_agenda_integrada_w='S' THEN  'A'  ELSE 'S' END ,
			nr_seq_interno_w,
			nr_seq_contraste_w,
			ds_resumo_clinico_w,
			ds_justificativa_w,
			ie_anestesia_w);

		CALL Gerar_med_mat_assoc(nr_prescricao_p, nr_sequencia_w);
        
		if (ie_prescr_proc_sem_lib_w = 'S') then
			CALL Gerar_prescr_proc_sem_dt_lib(nr_prescricao_p,nr_Sequencia_w,cd_perfil_orig_w,'N', coalesce(nm_usuario_orig_w, nm_usuario_p));
		end if;

        if (cd_funcao_ativa_w	= 916) then
                CALL consistir_regra_prescr_proced(	nr_prescricao_p,
								nr_sequencia_w,
								cd_estabelecimento_w,
								cd_perfil_orig_w,
								coalesce(nm_usuario_orig_w, nm_usuario_p));

				select	max(nr_seq_regra_plano)
				into STRICT	nr_seq_regra_plano_w
				from	prescr_procedimento
				where	nr_prescricao	= nr_prescricao_p
				and	nr_sequencia	= nr_Sequencia_w;

				if (nr_seq_regra_plano_w IS NOT NULL AND nr_seq_regra_plano_w::text <> '') then

					select	max(ie_regra)
					into STRICT	ie_regra_w
					from	regra_convenio_plano
					where	nr_sequencia	= nr_seq_regra_plano_w;

					if (ie_regra_w in (1,2,5,8)) then
						ie_autorizacao_w	:= 'B';
                    elsif (ie_regra_w = 4) then
                        ie_autorizacao_w    := 'L';
					elsif (ie_regra_w in (3,6,7)) then
                        ie_autorizacao_w	:= 'PA';
                    end if;

					if (ie_autorizacao_w IS NOT NULL AND ie_autorizacao_w::text <> '') then
						CALL Atualizar_Aut_Prescr_Proc_EUP( nr_sequencia_w,
                                        nr_prescricao_p,
										ie_autorizacao_w,
										coalesce(nm_usuario_orig_w, nm_usuario_p));
					end if;
				end if;
			end if;
			
		nr_seq_acum_w:= nr_seq_acum_w + 1;
		ie_entrou_cursor_c01_w := 'S';

		ds_erro_w := consistir_prescr_procedimento(nr_prescricao_p, nr_sequencia_w, nm_usuario_p, obter_perfil_ativo, ds_erro_w);

		end;
	end loop;
	close C01;

	if (ie_entrou_cursor_c01_w = 'N') then
		select  coalesce(max(nr_sequencia),0),
				coalesce(max(nr_agrupamento),0)
		into STRICT	nr_seq_acum_w,
				nr_agrup_acum_w
		from	prescr_procedimento
		where 	nr_prescricao		= nr_prescricao_p;

		open C02;
		loop
		fetch C02 into
			nr_sequencia_w,
			cd_proc_adic_w,
			ie_origem_proc_adic_w,
			qt_proc_adic_w,
			nm_usuario_w,
			cd_intervalo_w,
			cd_setor_proc_w,
			ds_dado_clinico_w,
			dt_prev_execucao_w,
			cd_material_exame_w,
			nr_seq_exame_w,
			ie_origem_inf_w,
			nr_agrupamento_w,
			ds_horarios_w,
			nr_ocorrencia_w,
			ie_cobra_paciente_w,
			cd_medico_exec_w,
			nr_seq_interno_w;
		EXIT WHEN NOT FOUND; /* apply on C02 */
			begin

			Insert	into Prescr_Procedimento(
				nr_prescricao,
				nr_sequencia,
				cd_procedimento,
				ie_origem_proced,
				qt_procedimento,
				dt_atualizacao,
				nm_usuario,
				cd_motivo_baixa,
				cd_intervalo,
				ie_urgencia,
				cd_setor_atendimento,
				ds_dado_clinico,
				dt_prev_execucao,
				ie_suspenso,
				cd_material_exame,
				nr_seq_exame,
				ie_origem_inf,
				ie_amostra,
				ie_executar_leito,
				nr_agrupamento,
				ie_se_necessario,
				ie_acm,
				ds_horarios,
				nr_ocorrencia,
				nr_seq_interno,
				ie_avisar_result,
				ie_cobra_paciente,
				cd_medico_exec,
				nr_seq_proc_princ)
			values (nr_prescricao_p,
				nr_sequencia_w,
				cd_proc_adic_w,
				ie_origem_proc_adic_w,
				qt_proc_adic_w,
				clock_timestamp(),
				nm_usuario_w,
				0,
				cd_intervalo_w,
				'N',
				cd_setor_proc_w,
				ds_dado_clinico_w,
				dt_prev_execucao_w,
				'N',
				cd_material_exame_w,
				nr_seq_exame_w,
				ie_origem_inf_w,
				'N',
				'N',
				nr_agrupamento_w,
				'N',
				'N',
				ds_horarios_w,
				nr_ocorrencia_w,
				nextval('prescr_procedimento_seq'),
				'N',
				ie_cobra_paciente_w,
				cd_medico_exec_w,
				nr_seq_interno_w);

			CALL Gerar_med_mat_assoc(nr_prescricao_p, nr_sequencia_w);

			if (ie_prescr_proc_sem_lib_w = 'S') then
				CALL Gerar_prescr_proc_sem_dt_lib(nr_prescricao_p,nr_Sequencia_w,cd_perfil_orig_w,'N', coalesce(nm_usuario_orig_w, nm_usuario_p));
			end if;
			
			if (cd_funcao_ativa_w	= 916) then
				CALL consistir_regra_prescr_proced(	nr_prescricao_p,
								nr_sequencia_w,
								cd_estabelecimento_w,
								cd_perfil_orig_w,
								coalesce(nm_usuario_orig_w, nm_usuario_p));

				select	max(nr_seq_regra_plano)
				into STRICT	nr_seq_regra_plano_w
				from	prescr_procedimento
				where	nr_prescricao	= nr_prescricao_p
				and	nr_sequencia	= nr_Sequencia_w;

				if (nr_seq_regra_plano_w IS NOT NULL AND nr_seq_regra_plano_w::text <> '') then

					select	max(ie_regra)
					into STRICT	ie_regra_w
					from	regra_convenio_plano
					where	nr_sequencia	= nr_seq_regra_plano_w;

					if (ie_regra_w in (1,2,5,8)) then
						ie_autorizacao_w	:= 'B';
                    elsif (ie_regra_w = 4) then
                        ie_autorizacao_w    := 'L';
					elsif (ie_regra_w in (3,6,7)) then
                        ie_autorizacao_w	:= 'PA';
                    end if;

					if (ie_autorizacao_w IS NOT NULL AND ie_autorizacao_w::text <> '') then
						CALL Atualizar_Aut_Prescr_Proc_EUP(	nr_sequencia_w,
										nr_prescricao_p,
										ie_autorizacao_w,
										coalesce(nm_usuario_orig_w, nm_usuario_p));
					end if;
				end if;

			end if;

			nr_seq_acum_w:= nr_seq_acum_w + 1;

			end;
		end loop;
		close C02;
	end if;

end if;
if (coalesce(wheb_usuario_pck.get_ie_commit, 'S') = 'S') then commit; end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_prescr_proc_assoc ( nr_prescricao_p bigint, nr_sequencia_p bigint, nm_usuario_p text, ie_proced_vinculado_p text default 'T') FROM PUBLIC;

