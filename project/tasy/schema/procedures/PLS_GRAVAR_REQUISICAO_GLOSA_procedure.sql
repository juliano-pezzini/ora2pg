-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_gravar_requisicao_glosa ( cd_motivo_glosa_p text, nr_seq_requisicao_p bigint, nr_seq_req_proc_p bigint, nr_seq_req_mat_p bigint, ds_observacao_p text, nm_usuario_p text, nr_seq_prestador_p bigint, cd_estabelecimento_p bigint, nr_seq_ocorrencia_p bigint, nr_seq_execucao_p bigint, ie_evento_p text default 'CG') AS $body$
DECLARE


/* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Finalidade: Inserir as glosas geradas na requisiçao.
-------------------------------------------------------------------------------------------------------------------
Locais de chamada direta:
[  X]  Objetos do dicionário [ ] Tasy (Delphi/Java) [  ] Portal [  ]  Relatórios [ ] Outros:
 ------------------------------------------------------------------------------------------------------------------
Pontos de atenção:Performance.
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */
nr_seq_motivo_glosa_w		bigint;
qt_glosa_w			integer;
ie_consistir_w			varchar(1);
nr_seq_outorgante_w		bigint;
ie_acao_pls_w			varchar(10);
qt_registro_w			bigint	:= 0;
nr_seq_requisicao_w		bigint;
nr_seq_segurado_w		bigint;
ie_auditoria_w			varchar(1);
ie_nivel_liberacao_w		bigint;
nr_seq_ocorrencia_glosa_w	bigint;
ie_fechar_conta_w		varchar(1);
nr_seq_nivel_lib_w		bigint;
nr_seq_glosa_req_w		bigint;
nr_seq_ocor_benef_w		bigint;
ie_finalizar_analise_w		varchar(1);
ie_plano_w			pls_glosa_evento.ie_plano%type;
ie_origem_solic_w		pls_requisicao.ie_origem_solic%type;
ie_evento_w			pls_glosa_evento.ie_evento%type := ie_evento_p;
ie_ocorrencia_w			pls_controle_estab.ie_ocorrencia%type := 'N';
cd_estabelecimento_w		estabelecimento.cd_estabelecimento%type;

C01 CURSOR(	ie_ocorrencia_pc	pls_controle_estab.ie_ocorrencia%type,
		cd_estabelecimento_pc	estabelecimento.cd_estabelecimento%type) FOR
	SELECT	nr_sequencia
	from	pls_ocorrencia
	where	nr_seq_motivo_glosa		= nr_seq_motivo_glosa_w
	and	ie_glosa			= 'S'
	and	ie_situacao			= 'A'
	and	coalesce(nr_seq_ocorrencia_p,0)	= 0 --Gerar a ocorrêncioa da glosa internsa somente quando esta for disparada mas não quando for  gerada a partir de uma ocorrência normal com glosa vinculada.
	and	ie_ocorrencia_pc		= 'N'
	
union all

	SELECT	nr_sequencia
	from	pls_ocorrencia
	where	nr_seq_motivo_glosa		= nr_seq_motivo_glosa_w
	and	ie_glosa			= 'S'
	and	ie_situacao			= 'A'
	and	coalesce(nr_seq_ocorrencia_p,0)	= 0 --Gerar a ocorrêncioa da glosa internsa somente quando esta for disparada mas não quando for  gerada a partir de uma ocorrência normal com glosa vinculada.
	and	ie_ocorrencia_pc		= 'S'
	and	cd_estabelecimento		= cd_estabelecimento_pc
	order by 1;


BEGIN
ie_ocorrencia_w := pls_obter_se_controle_estab('GO');

if (nr_seq_requisicao_p IS NOT NULL AND nr_seq_requisicao_p::text <> '') then
	begin
		select	ie_origem_solic,
			cd_estabelecimento
		into STRICT	ie_origem_solic_w,
			cd_estabelecimento_w
		from	pls_requisicao
		where	nr_sequencia =	nr_seq_requisicao_p;
	exception
	when others then
		ie_origem_solic_w := null;
		cd_estabelecimento_w := wheb_usuario_pck.get_cd_estabelecimento;
	end;
elsif (nr_seq_req_mat_p IS NOT NULL AND nr_seq_req_mat_p::text <> '') then
	select	a.nr_sequencia
	into STRICT 	nr_seq_requisicao_w
	from	pls_requisicao a,
		pls_requisicao_mat b
	where b.nr_seq_requisicao = a.nr_sequencia
	and   b.nr_sequencia = nr_seq_req_mat_p;
	begin
		select	ie_origem_solic,
			cd_estabelecimento
		into STRICT	ie_origem_solic_w,
			cd_estabelecimento_w
		from	pls_requisicao
		where	nr_sequencia =	nr_seq_requisicao_w;
	exception
	when others then
		ie_origem_solic_w := null;
		cd_estabelecimento_w := wheb_usuario_pck.get_cd_estabelecimento;
	end;
elsif (nr_seq_req_proc_p IS NOT NULL AND nr_seq_req_proc_p::text <> '') then
	select	a.nr_sequencia
	into STRICT 	nr_seq_requisicao_w
	from	pls_requisicao a,
		pls_requisicao_proc b
	where b.nr_seq_requisicao = a.nr_sequencia
	and   b.nr_sequencia = nr_seq_req_proc_p;

	begin
		select	ie_origem_solic,
			cd_estabelecimento
		into STRICT	ie_origem_solic_w,
			cd_estabelecimento_w
		from	pls_requisicao
		where	nr_sequencia =	nr_seq_requisicao_w;
	exception
	when others then
		ie_origem_solic_w := null;
		cd_estabelecimento_w := wheb_usuario_pck.get_cd_estabelecimento;
	end;
end if;

if (coalesce(cd_estabelecimento_w::text, '') = '') then
	cd_estabelecimento_w := wheb_usuario_pck.get_cd_estabelecimento;
end if;

begin
select	coalesce(nr_sequencia,0),
	ie_acao_pls
into STRICT	nr_seq_motivo_glosa_w,
	ie_acao_pls_w
from	tiss_motivo_glosa
where	cd_motivo_tiss	= cd_motivo_glosa_p
and	coalesce(cd_convenio::text, '') = '';
exception
when others then
	nr_seq_motivo_glosa_w	:= 0;
end;

select 	max(nr_sequencia)
into STRICT	nr_seq_outorgante_w
from	pls_outorgante;

if (ie_origem_solic_w = 'E') then
	begin
		if (ie_ocorrencia_w = 'N') then
			select	ie_plano
			into STRICT	ie_plano_w
			from	pls_glosa_evento
			where	nr_seq_motivo_glosa = nr_seq_motivo_glosa_w
			and	ie_evento = 'IG';
		else
			select	ie_plano
			into STRICT	ie_plano_w
			from	pls_glosa_evento
			where	nr_seq_motivo_glosa = nr_seq_motivo_glosa_w
			and	ie_evento = 'IG'
			and	cd_estabelecimento = cd_estabelecimento_w;
		end if;
	exception
	when others then
		ie_plano_w	:= null;
	end;

	if (ie_plano_w in ('S', 'N')) then
		ie_evento_w := 'IG';
	else
		ie_evento_w := 'CG';
	end if;
end if;

if (nr_seq_motivo_glosa_w <> 0) then
	if (ie_acao_pls_w	= 'S') then

		if (ie_ocorrencia_w = 'N') then
			/* Verificar se a glosa está vinculada a uma ocorrência do tipo "Glosa interna" */

			select	count(*)
			into STRICT	qt_registro_w
			from	pls_ocorrencia
			where	nr_seq_motivo_glosa	= nr_seq_motivo_glosa_w
			and	ie_glosa		= 'S'
			and	ie_situacao		= 'A';
		else
			/* Verificar se a glosa está vinculada a uma ocorrência do tipo "Glosa interna" */

			select	count(*)
			into STRICT	qt_registro_w
			from	pls_ocorrencia
			where	nr_seq_motivo_glosa	= nr_seq_motivo_glosa_w
			and	ie_glosa		= 'S'
			and	ie_situacao		= 'A'
			and	cd_estabelecimento	= cd_estabelecimento_w;
		end if;

		if (qt_registro_w	> 0) then

			ie_consistir_w := pls_obter_se_evento_glosa(nr_seq_motivo_glosa_w, ie_evento_w, cd_estabelecimento_w);

			/*select  nvl(max('S'),'N')
			into	ie_consistir_w
			from	tiss_motivo_glosa 	a,
				pls_glosa_evento 	b
			where	a.nr_sequencia 		= b.nr_seq_motivo_glosa
			and	ie_evento		= ie_evento_w
			and	a.nr_sequencia	 	= nr_seq_motivo_glosa_w
			and	b.ie_plano		= 'S';*/
		end if;
	else
		begin
		if (ie_ocorrencia_w = 'N') then
			select  coalesce(c.ie_consistir,'S')
			into STRICT	ie_consistir_w
			from	tiss_motivo_glosa a,
				pls_glosa_evento b,
				pls_outorgante_glosa d,
				pls_prestador_glosa c
			where	a.nr_sequencia 		= b.nr_seq_motivo_glosa
			and	d.nr_sequencia		= c.nr_seq_outorg_glosa
			and	d.nr_seq_evento_glosa 	= b.nr_sequencia
			and	nr_seq_prestador	= nr_seq_prestador_p
			and	ie_evento		= ie_evento_w
			and	a.nr_sequencia	 	= nr_seq_motivo_glosa_w
			and	b.ie_plano		= 'S';
		else
			select  coalesce(c.ie_consistir,'S')
			into STRICT	ie_consistir_w
			from	tiss_motivo_glosa a,
				pls_glosa_evento b,
				pls_outorgante_glosa d,
				pls_prestador_glosa c
			where	a.nr_sequencia 		= b.nr_seq_motivo_glosa
			and	d.nr_sequencia		= c.nr_seq_outorg_glosa
			and	d.nr_seq_evento_glosa 	= b.nr_sequencia
			and	nr_seq_prestador	= nr_seq_prestador_p
			and	ie_evento		= ie_evento_w
			and	a.nr_sequencia	 	= nr_seq_motivo_glosa_w
			and	b.ie_plano		= 'S'
			and	b.cd_estabelecimento 	= cd_estabelecimento_w;
		end if;
		exception
		when others then
			begin
			if (ie_ocorrencia_w = 'N') then
				select  coalesce(d.ie_consistir,'S')
				into STRICT	ie_consistir_w
				from	tiss_motivo_glosa a,
					pls_glosa_evento b,
					pls_outorgante_glosa d
				where	a.nr_sequencia 		= b.nr_seq_motivo_glosa
				and	d.nr_seq_evento_glosa 	= b.nr_sequencia
				and	ie_evento		= ie_evento_w
				and	nr_seq_outorgante	= nr_seq_outorgante_w
				and	a.nr_sequencia	 	= nr_seq_motivo_glosa_w
				and	b.ie_plano		= 'S';
			else
				select  coalesce(d.ie_consistir,'S')
				into STRICT	ie_consistir_w
				from	tiss_motivo_glosa a,
					pls_glosa_evento b,
					pls_outorgante_glosa d
				where	a.nr_sequencia 		= b.nr_seq_motivo_glosa
				and	d.nr_seq_evento_glosa 	= b.nr_sequencia
				and	ie_evento		= ie_evento_w
				and	nr_seq_outorgante	= nr_seq_outorgante_w
				and	a.nr_sequencia	 	= nr_seq_motivo_glosa_w
				and	b.ie_plano		= 'S'
				and	b.cd_estabelecimento 	= cd_estabelecimento_w;
			end if;
			exception
			when others then
				begin
				ie_consistir_w := pls_obter_se_evento_glosa(nr_seq_motivo_glosa_w, ie_evento_w, cd_estabelecimento_w);

				/*select  'S'
				into	ie_consistir_w
				from	tiss_motivo_glosa 	a,
					pls_glosa_evento 	b
				where	a.nr_sequencia 		= b.nr_seq_motivo_glosa
				and	ie_evento		= ie_evento_w
				and	a.nr_sequencia	 	= nr_seq_motivo_glosa_w
				and	b.ie_plano		= 'S';*/
				exception
				when others then
					ie_consistir_w 		:= 'N'; /* Felipe - OS 283878 - Mudei para N e coloquei o select acima, pois quando NÃO tem evento estava gerando glosa */
				end;
			end;
		end;
	end if;

	if (coalesce(nr_seq_ocorrencia_p,0) > 0) then
		ie_consistir_w := 'S';
	end if;

        select  count(*)
        into STRICT    qt_glosa_w
        from    pls_requisicao_glosa
        where   nr_seq_motivo_glosa	= nr_seq_motivo_glosa_w
        and (nr_seq_requisicao	= nr_seq_requisicao_p
        or     	nr_seq_req_proc		= nr_seq_req_proc_p
        or      nr_seq_req_mat		= nr_seq_req_mat_p);

        if      (qt_glosa_w = 0 AND ie_consistir_w = 'S') then
		select	nextval('pls_requisicao_glosa_seq')
		into STRICT	nr_seq_glosa_req_w
		;

                insert into pls_requisicao_glosa(nr_sequencia, ds_observacao, dt_atualizacao,
                        dt_atualizacao_nrec, nm_usuario, nm_usuario_nrec,
                        nr_seq_motivo_glosa, nr_seq_req_mat, nr_seq_req_proc,
                        nr_seq_requisicao, nr_seq_ocorrencia, nr_seq_execucao)
                values (nr_seq_glosa_req_w, ds_observacao_p, clock_timestamp(),
                        clock_timestamp(), nm_usuario_p, nm_usuario_p,
                        nr_seq_motivo_glosa_w, nr_seq_req_mat_p, nr_seq_req_proc_p,
                        nr_seq_requisicao_p, nr_seq_ocorrencia_p, nr_seq_execucao_p);

		-- Atualiza a ocorrêcia com a glosa que a mesma gerou
		 if (coalesce(nr_seq_ocorrencia_p,0) > 0) then
			if (nr_seq_requisicao_p IS NOT NULL AND nr_seq_requisicao_p::text <> '') then
				select	max(nr_sequencia)
				into STRICT	nr_seq_ocor_benef_w
				from	pls_ocorrencia_benef
				where	nr_seq_ocorrencia = nr_seq_ocorrencia_p
				and	nr_seq_requisicao = nr_seq_requisicao_p;
			else
				select	max(nr_sequencia)
				into STRICT	nr_seq_ocor_benef_w
				from	pls_ocorrencia_benef
				where	nr_seq_ocorrencia = nr_seq_ocorrencia_p
				and (nr_seq_proc = nr_seq_req_proc_p
				or	nr_seq_mat = nr_seq_req_mat_p)
				and	(nr_seq_requisicao IS NOT NULL AND nr_seq_requisicao::text <> '');
			end if;

			if (nr_seq_ocor_benef_w IS NOT NULL AND nr_seq_ocor_benef_w::text <> '') then
				update	pls_ocorrencia_benef
				set	nr_seq_glosa_req 	= nr_seq_glosa_req_w
				where	nr_sequencia		= nr_seq_ocor_benef_w;
			end if;
		end if;

		/*Inserir as ocorrência de glosa interna*/

		open C01(ie_ocorrencia_w, cd_estabelecimento_w);
		loop
		fetch C01 into
			nr_seq_ocorrencia_glosa_w;
		EXIT WHEN NOT FOUND; /* apply on C01 */
			begin
			if (coalesce(nr_seq_req_proc_p,0) <> 0) then
				select	nr_seq_requisicao
				into STRICT	nr_seq_requisicao_w
				from	pls_requisicao_proc
				where	nr_sequencia = nr_seq_req_proc_p;
			elsif (coalesce(nr_seq_req_mat_p,0) <> 0) then
				select	nr_seq_requisicao
				into STRICT	nr_seq_requisicao_w
				from	pls_requisicao_mat
				where	nr_sequencia = nr_seq_req_mat_p;
			else
				nr_seq_requisicao_w := nr_seq_requisicao_p;
			end if;

			begin
			select	nr_seq_segurado
			into STRICT	nr_seq_segurado_w
			from	pls_requisicao
			where 	nr_sequencia = nr_seq_requisicao_w;
			exception
			when others then
				nr_seq_segurado_w := null;
			end;

			select	ie_auditoria_conta,
				nr_seq_nivel_lib,
				coalesce(ie_fechar_conta,'S'),
				coalesce(ie_finalizar_analise, 'S')
			into STRICT	ie_auditoria_w,
				nr_seq_nivel_lib_w,
				ie_fechar_conta_w,
				ie_finalizar_analise_w
			from	pls_ocorrencia
			where	nr_sequencia	= nr_seq_ocorrencia_glosa_w;

			select	max(nr_nivel_liberacao)
			into STRICT	ie_nivel_liberacao_w
			from	pls_nivel_liberacao
			where	nr_sequencia = nr_seq_nivel_lib_w;

			insert into pls_ocorrencia_benef(nr_sequencia,
				nr_seq_segurado,
				nr_seq_ocorrencia,
				dt_atualizacao,
				nm_usuario,
				dt_atualizacao_nrec,
				nm_usuario_nrec,
				nr_seq_requisicao,
				nr_seq_conta,
				nr_seq_proc,
				nr_seq_mat,
				nr_seq_regra,
				nr_seq_guia_plano,
				ie_auditoria,
				nr_nivel_liberacao,
				ds_observacao,
				ie_fechar_conta,
				nr_seq_glosa_req,
				ie_finalizar_analise)
			values (nextval('pls_ocorrencia_benef_seq'),
				nr_seq_segurado_w,
				nr_seq_ocorrencia_glosa_w,
				clock_timestamp(),
				nm_usuario_p,
				clock_timestamp(),
				nm_usuario_p,
				nr_seq_requisicao_w,
				null,
				nr_seq_req_proc_p,
				nr_seq_req_mat_p,
				null,
				null,
				ie_auditoria_w,
				ie_nivel_liberacao_w,
				'Ocorrência gerada através da glosa interna: ' || cd_motivo_glosa_p,
				ie_fechar_conta_w,
				nr_seq_glosa_req_w,
				ie_finalizar_analise_w);

			update	pls_requisicao_glosa
			set	nr_seq_ocorrencia	= nr_seq_ocorrencia_glosa_w
			where	nr_sequencia		= nr_seq_glosa_req_w;
			end;
		end loop;
		close C01;
        end if;
end if;

--Não é para commit em procedures intermediarias
--commit;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_gravar_requisicao_glosa ( cd_motivo_glosa_p text, nr_seq_requisicao_p bigint, nr_seq_req_proc_p bigint, nr_seq_req_mat_p bigint, ds_observacao_p text, nm_usuario_p text, nr_seq_prestador_p bigint, cd_estabelecimento_p bigint, nr_seq_ocorrencia_p bigint, nr_seq_execucao_p bigint, ie_evento_p text default 'CG') FROM PUBLIC;

