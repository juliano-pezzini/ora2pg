-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE suspende_todas_prescr_onco ( nr_seq_paciente_p bigint, nm_usuario_p text) AS $body$
DECLARE

nr_prescricao_w 		bigint;
nr_seq_atendimento_w 	bigint;
ie_libera_quimio_w		varchar(1);

C01 CURSOR FOR 
	SELECT 	nr_prescricao, 
			nr_seq_atendimento 
	from 	paciente_atendimento 
	where 	nr_seq_paciente = nr_seq_paciente_p 
	and		(nr_prescricao IS NOT NULL AND nr_prescricao::text <> '') 
	and		coalesce(nr_atendimento::text, '') = '' 
	and 	SUBSTR(Obter_status_Paciente_qt(nr_seq_atendimento, 
											dt_inicio_adm, 
											dt_fim_adm, 
											nr_seq_local, 
											ie_exige_liberacao, 
											dt_chegada, 
											'C'),1,60) <> '83';

BEGIN
 
ie_libera_quimio_w := Obter_Valor_Param_Usuario(3130,279,obter_perfil_ativo,nm_usuario_p,wheb_usuario_pck.get_cd_estabelecimento);
 
open C01;
loop 
fetch C01 into 
	nr_prescricao_w, 
	nr_seq_atendimento_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin 
		CALL suspender_prescricao(nr_prescricao_w,0,'',nm_usuario_p, 'N');
		update 	paciente_atendimento 
		set		nr_prescricao			=	'', 
				dt_geracao_prescricao	 = NULL 
		where 	nr_seq_atendimento			=	nr_seq_atendimento_w;
 
		if (ie_libera_quimio_w = 'S') then 
			CALL atualizar_data_quimio_liberada(nr_seq_atendimento_w,nm_usuario_p,'D');
		end if;
	end;
end loop;
close C01;	
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE suspende_todas_prescr_onco ( nr_seq_paciente_p bigint, nm_usuario_p text) FROM PUBLIC;

