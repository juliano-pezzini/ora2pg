-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE com_gerar_ordem_servico_js ( nr_seq_solic_p bigint, nm_usuario_p text, nr_sequencia_os_p INOUT bigint, cd_relatorio_p INOUT bigint) AS $body$
DECLARE


nr_sequencia_w		bigint;
nr_seq_w		bigint;

cd_pf_solic_w           varchar(10);

nr_seq_regra_w		bigint;
nr_seq_localizacao_w   	bigint;
nr_seq_equipamento_w    bigint;
ie_classificacao_w      varchar(1);
ie_status_ordem_w       varchar(1);
nr_seq_estagio_w        bigint;
nr_grupo_trabalho_w     bigint;
nr_grupo_planej_w       bigint;
ds_dano_breve_w         varchar(80);
ds_dano_w               varchar(4000);
ie_tipo_ordem_w         integer;

nm_usuario_exec_w       varchar(15);
nr_seq_tipo_exec_w	bigint;
qt_min_prev_w		bigint;

nm_usuario_param_w	varchar(15);

nr_seq_cliente_w        bigint;

ds_diretorio_anexo_os_w	varchar(255);

ds_mensagem_w		varchar(255);

C01 CURSOR FOR
	SELECT	nm_usuario_exec,
		nr_seq_tipo_exec,
		qt_min_prev
	from	regra_geracao_os_exec_sd
	where	nr_seq_regra = nr_seq_regra_w;


BEGIN

cd_relatorio_p := 0;


if (coalesce(nr_seq_solic_p,0) > 0) then

	select	cd_pf_solic,
		nr_seq_cliente
	into STRICT	cd_pf_solic_w,
		nr_seq_cliente_w
	from	com_solic_sd
	where	nr_sequencia = nr_seq_solic_p;

	ds_mensagem_w := com_consiste_dados_solic(nr_seq_solic_p, nr_seq_cliente_w);

	if (ds_mensagem_w IS NOT NULL AND ds_mensagem_w::text <> '') then
		CALL wheb_mensagem_pck.exibir_mensagem_abort(ds_mensagem_w);
	end if;

	select	max(nr_sequencia)
	into STRICT	nr_seq_regra_w
	from	regra_geracao_os_sd;

	if (coalesce(nr_seq_regra_w,0) > 0) then

		select	nr_seq_localizacao,
			nr_seq_equipamento,
			ie_classificacao,
			ie_status_ordem,
			nr_seq_estagio,
			nr_grupo_trabalho,
			nr_grupo_planej,
			ds_dano_breve,
			ds_dano,
			ie_tipo_ordem
		into STRICT	nr_seq_localizacao_w,
			nr_seq_equipamento_w,
			ie_classificacao_w,
			ie_status_ordem_w,
			nr_seq_estagio_w,
			nr_grupo_trabalho_w,
			nr_grupo_planej_w,
			ds_dano_breve_w,
			ds_dano_w,
			ie_tipo_ordem_w
		from	regra_geracao_os_sd
		where	nr_sequencia = nr_seq_regra_w;

		select	nextval('man_ordem_servico_seq')
		into STRICT	nr_sequencia_w
		;

		insert	into man_ordem_servico(
				nr_sequencia,
				nr_seq_localizacao,
				nr_seq_equipamento,
				cd_pessoa_solicitante,
				dt_ordem_servico,
				ie_prioridade,
				ie_parado,
				ds_dano_breve,
				dt_atualizacao,
				nm_usuario,
				dt_inicio_desejado,
				dt_conclusao_desejada,
				ds_dano,
				dt_inicio_previsto,
				dt_fim_previsto,
				dt_inicio_real,
				dt_fim_real,
				ie_tipo_ordem,
				ie_status_ordem,
				nr_grupo_planej,
				nr_grupo_trabalho,
				nr_seq_tipo_solucao,
				ds_solucao,
				nm_usuario_exec,
				qt_contador,
				nr_seq_planej,
				nr_seq_tipo_contador,
				nr_seq_estagio,
				cd_projeto,
				nr_seq_etapa_proj,
				dt_reabertura,
				cd_funcao,
				nm_tabela,
				ie_classificacao,
				nr_seq_origem,
				nr_seq_projeto,
				ie_grau_satisfacao,
				nr_seq_indicador,
				nr_seq_causa_dano,
				ie_forma_receb,
				nr_seq_cliente,
				nr_seq_grupo_des,
				nr_seq_grupo_sup,
				nr_seq_superior,
				ie_eficacia,
				dt_prev_eficacia,
				cd_pf_eficacia,
				nr_seq_nao_conform,
				nr_seq_complex,
				dt_atualizacao_nrec,
				nm_usuario_nrec,
				ie_obriga_news,
				nr_seq_meta_pe,
				nr_seq_classif,
				nr_seq_nivel_valor,
				nm_usuario_lib_news,
				dt_libera_news,
				dt_envio_wheb,
				ds_contato_solicitante,
				ie_prioridade_desen,
				ie_prioridade_sup,
				ie_prioridade_cliente,
				ie_origem_os)
			values (nr_sequencia_w,				-- nr_sequencia,
				nr_seq_localizacao_w,			-- nr_seq_localizacao,
				nr_seq_equipamento_w,			-- nr_seq_equipamento,
				cd_pf_solic_w,				-- cd_pessoa_solicitante,
				clock_timestamp(),				-- dt_ordem_servico,
				'M',					-- ie_prioridade,
				'N',					-- ie_parado,
				ds_dano_breve_w,			-- ds_dano_breve,
				clock_timestamp(),				-- dt_atualizacao,
				nm_usuario_p,				-- nm_usuario,
				clock_timestamp(),				-- dt_inicio_desejado,
				clock_timestamp(),				-- dt_conclusao_desejada,
				ds_dano_w,				-- ds_dano,
				clock_timestamp(),				-- dt_inicio_previsto,
				null,					-- dt_fim_previsto,
				clock_timestamp(),				-- dt_inicio_real,
				null,					-- dt_fim_real,
				ie_tipo_ordem_w,			-- ie_tipo_ordem,
				ie_status_ordem_w,	                -- ie_status_ordem,
				nr_grupo_planej_w,			-- nr_grupo_planej,
				nr_grupo_trabalho_w,			-- nr_grupo_trabalho,
				null,					-- nr_seq_tipo_solucao,
				null,					-- ds_solucao,
				nm_usuario_p, 				-- nm_usuario_exec,
				null,					-- qt_contador,
				null,					-- nr_seq_planej,
				null,					-- nr_seq_tipo_contador,
				nr_seq_estagio_w,			-- nr_seq_estagio,
				null,					-- cd_projeto,
				null,					-- nr_seq_etapa_proj,
				null,					-- dt_reabertura,
				null,					-- cd_funcao,
				null,					-- nm_tabela,
				ie_classificacao_w,			-- ie_classificacao,
				null,					-- nr_seq_origem,
				null,					-- nr_seq_projeto,
				null,					-- ie_grau_satisfacao,
				null,					-- nr_seq_indicador,
				null,					-- nr_seq_causa_dano,
				null,					-- ie_forma_receb,
				null,					-- nr_seq_cliente,
				null,					-- nr_seq_grupo_des,
				null,					-- nr_seq_grupo_sup,
				null,					-- nr_seq_superior,
				null,					-- ie_eficacia,
				null,					-- dt_prev_eficacia,
				null,					-- cd_pf_eficacia,
				null,					-- nr_seq_nao_conform,
				null,					-- nr_seq_complex,
				null,					-- dt_atualizacao_nrec,
				nm_usuario_p,				-- nm_usuario_nrec,
				null,					-- ie_obriga_news,
				null,					-- nr_seq_meta_pe,
				null,					-- nr_seq_classif,
				null,					-- nr_seq_nivel_valor,
				null,					-- nm_usuario_lib_news,
				null,					-- dt_libera_news,
				null,					-- dt_envio_wheb,
				null,					-- ds_contato_solicitante,
				null,					-- ie_prioridade_desen,
				null,					-- ie_prioridade_sup
				null,					-- ie_prioridade_cliente
				null);					-- ie_origem_os
		nr_sequencia_os_p := nr_sequencia_w;

		cd_relatorio_p := com_obter_rel_solic_sd(nr_seq_cliente_w);

		CALL com_atualizar_status_sd(nm_usuario_p, nr_sequencia_w, nr_seq_solic_p, 'S');

		update	com_solic_sd
		set	nr_ordem_servico = nr_sequencia_w,
			ie_status = 'S',
			nm_usuario = nm_usuario_p,
			dt_atualizacao = clock_timestamp()
		where	nr_sequencia = nr_seq_solic_p;

		open C01;
		loop
		fetch C01 into
			nm_usuario_exec_w,
			nr_seq_tipo_exec_w,
			qt_min_prev_w;
		EXIT WHEN NOT FOUND; /* apply on C01 */
			begin

			select	nextval('man_ordem_servico_exec_seq')
			into STRICT	nr_seq_w
			;

			insert into man_ordem_servico_exec(nr_sequencia,
				nr_seq_ordem,
				dt_atualizacao,
				nm_usuario,
				nm_usuario_exec,
				qt_min_prev,
				dt_ult_visao,
				dt_recebimento,
				nr_seq_tipo_exec)
			values (nr_seq_w,
				nr_sequencia_w,
				clock_timestamp(),
				nm_usuario_p,
				nm_usuario_exec_w,
				qt_min_prev_w,
				clock_timestamp(),
				clock_timestamp(),
				nr_seq_tipo_exec_w);
			end;
		end loop;
		close C01;

	end if;

end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE com_gerar_ordem_servico_js ( nr_seq_solic_p bigint, nm_usuario_p text, nr_sequencia_os_p INOUT bigint, cd_relatorio_p INOUT bigint) FROM PUBLIC;

