-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE desdobrar_bordero_recebimento (nr_bordero_p bigint, vl_abaixar_p bigint) AS $body$
DECLARE


nr_bordero_novo_w	bigint;
nr_titulo_w		bigint;
vl_abaixar_w		double precision;
/* Projeto Multimoeda - Variáveis */

vl_abaixar_estrang_w	double precision;
vl_cotacao_w		cotacao_moeda.vl_cotacao%type;
cd_moeda_w		integer;
ie_moeda_estrang_w	varchar(1) := 'N';

c01 CURSOR FOR
SELECT	nr_titulo,
	vl_abaixar_estrang,
	vl_cotacao,
	cd_moeda
from	bordero_tit_rec
where	nr_bordero	= nr_bordero_p;


BEGIN

select	nextval('bordero_recebimento_seq')
into STRICT	nr_bordero_novo_w
;

insert into bordero_recebimento(
	cd_cgc_pagamento,
	cd_estabelecimento,
	cd_pessoa_pagamento,
	cd_tipo_recebimento,
	ds_bordero,
	dt_atualizacao,
	dt_atualizacao_nrec,
	dt_bordero,
	dt_prev_receb,
	dt_recebimento,
	nm_usuario,
	nm_usuario_nrec,
	nr_bordero,
	nr_seq_conta_banco,
	nr_seq_trans_fin,
	cd_moeda,
	vl_cotacao)
SELECT	cd_cgc_pagamento,
	cd_estabelecimento,
	cd_pessoa_pagamento,
	cd_tipo_recebimento,
	wheb_mensagem_pck.get_texto(303606, 'DS_BORDERO=' || substr(ds_bordero,1,67)), -- #@DS_BORDERO#@ - desdobrado
	dt_atualizacao,
	dt_atualizacao_nrec,
	dt_bordero,
	dt_prev_receb,
	dt_recebimento,
	nm_usuario,
	nm_usuario_nrec,
	nr_bordero_novo_w,
	nr_seq_conta_banco,
	nr_seq_trans_fin,
	cd_moeda,
	CASE WHEN coalesce(vl_cotacao,0)=0 THEN null  ELSE vl_cotacao END
from	bordero_recebimento
where	nr_bordero	= nr_bordero_p;

select	sum(coalesce(vl_abaixar,0))
into STRICT	vl_abaixar_w
from	bordero_tit_rec
where	nr_bordero	= nr_bordero_p;

open c01;
loop
fetch c01 into
	nr_titulo_w,
	vl_abaixar_estrang_w,
	vl_cotacao_w,
	cd_moeda_w;
EXIT WHEN NOT FOUND; /* apply on c01 */

	/* Projeto Multimoeda - Verifica se o bordero é moeda estrangeira para calcular os valores em moeda estrangeira ao gravar os dados.*/

	if (coalesce(vl_abaixar_estrang_w,0) <> 0 and coalesce(vl_cotacao_w,0) <> 0) then
		ie_moeda_estrang_w := 'S';
	else
		ie_moeda_estrang_w := 'N';
	end if;

	insert into bordero_tit_rec(
		cd_centro_custo_desc,
		dt_atualizacao,
		dt_atualizacao_nrec,
		nm_usuario,
		nm_usuario_nrec,
		nr_bordero,
		nr_seq_motivo_desc,
		nr_titulo,
		vl_abaixar,
		vl_amenor,
		vl_desconto,
		vl_glosa,
		vl_juros,
		vl_multa,
		vl_perdas,
		vl_rec_maior,
		vl_abaixar_estrang,
		vl_cotacao,
		cd_moeda)
	SELECT	cd_centro_custo_desc,
		dt_atualizacao,
		dt_atualizacao_nrec,
		nm_usuario,
		nm_usuario_nrec,
		nr_bordero_novo_w,
		nr_seq_motivo_desc,
		nr_titulo,
		(vl_abaixar - dividir_sem_round((vl_abaixar * vl_abaixar_p), vl_abaixar_w)),
		0,
		0,
		0,
		0,
		0,
		0,
		0,
		CASE WHEN coalesce(ie_moeda_estrang_w,'N')='S' THEN  ((vl_abaixar - dividir_sem_round((vl_abaixar * vl_abaixar_p), vl_abaixar_w))/vl_cotacao_w)  ELSE null END ,
		CASE WHEN coalesce(ie_moeda_estrang_w,'N')='S' THEN  vl_cotacao_w  ELSE null END ,
		CASE WHEN coalesce(ie_moeda_estrang_w,'N')='S' THEN  cd_moeda_w  ELSE null END
	from	bordero_tit_rec
	where	nr_titulo	= nr_titulo_w
	and		nr_bordero	= nr_bordero_p;

	/* Projeto Multimoeda - Quando bordero em moeda estrangeira atualiza o valor do complemento para o título inserido. */

	if (coalesce(ie_moeda_estrang_w,'N') = 'S') then
		update	bordero_tit_rec
		set	vl_complemento = vl_abaixar - vl_abaixar_estrang
		where	nr_bordero = nr_bordero_novo_w
		and	nr_titulo = nr_titulo_w;
	end if;

	update	bordero_tit_rec
	set	vl_abaixar	= dividir_sem_round((vl_abaixar * vl_abaixar_p), vl_abaixar_w),
		vl_abaixar_estrang = CASE WHEN coalesce(ie_moeda_estrang_w,'N')='S' THEN (dividir_sem_round((vl_abaixar * vl_abaixar_p), vl_abaixar_w))/vl_cotacao_w  ELSE null END
	where	nr_bordero	= nr_bordero_p
	and	nr_titulo	= nr_titulo_w;

	/* Projeto Multimoeda - Quando bordero em moeda estrangeira atualiza o valor do complemento para o título no bordero antigo */

	if (coalesce(ie_moeda_estrang_w,'N') = 'S') then
		update	bordero_tit_rec
		set	vl_complemento = vl_abaixar - vl_abaixar_estrang
		where	nr_bordero = nr_bordero_p
		and	nr_titulo = nr_titulo_w;
	end if;

end loop;
close c01;

commit;

end	;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE desdobrar_bordero_recebimento (nr_bordero_p bigint, vl_abaixar_p bigint) FROM PUBLIC;

