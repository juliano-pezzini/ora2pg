-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE desfazer_cancelamento_titulo ( nr_titulo_p bigint, nm_usuario_p text) AS $body$
DECLARE

 
vl_titulo_w			double precision;
cd_moeda_w			integer;
nr_sequencia_w			integer;
vl_ultima_alteracao_w		double precision;
vl_saldo_w			double precision;


BEGIN 
 
select	vl_titulo, 
	cd_moeda, 
	vl_saldo_titulo 
into STRICT	vl_titulo_w, 
	cd_moeda_w, 
	vl_saldo_w 
from	titulo_receber 
where	nr_titulo = nr_titulo_p;
 
select	coalesce(max(nr_sequencia),0) + 1 
into STRICT	nr_sequencia_w 
from	alteracao_valor 
where	nr_titulo	= nr_titulo_p;
 
select	max(a.vl_alteracao) 
into STRICT	vl_ultima_alteracao_w 
from	alteracao_valor a 
where	a.nr_sequencia	= coalesce(nr_sequencia_w,0) - 2 
and	a.nr_titulo	= nr_titulo_p;
 
insert	into alteracao_valor(NR_TITULO, 
	DS_OBSERVACAO, 
	NR_SEQUENCIA, 
	DT_ALTERACAO, 
	VL_ANTERIOR, 
	VL_ALTERACAO, 
	CD_MOTIVO, 
	CD_MOEDA, 
	IE_AUMENTA_DIMINUI, 
	DT_ATUALIZACAO, 
	NM_USUARIO, 
	NR_LOTE_CONTABIL, 
	NR_SEQ_TRANS_FIN) 
values (nr_titulo_p, 
	substr(wheb_mensagem_pck.get_texto(303771),1,255), 
	nr_sequencia_w, 
	clock_timestamp(), 
	vl_saldo_w, 
	coalesce(vl_ultima_alteracao_w,vl_titulo_w), 
	3, 
	cd_moeda_w, 
	'D', 
	clock_timestamp(), 
	nm_usuario_p, 
	null, 
	null);
 
update	titulo_receber 
set	vl_saldo_titulo	= coalesce(vl_ultima_alteracao_w,vl_titulo_w), 
	dt_liquidacao	= clock_timestamp(), 
	ie_situacao	= '1', 
	nm_usuario	= nm_usuario_p, 
	dt_atualizacao	= clock_timestamp() 
where	nr_titulo		= nr_titulo_p;
 
CALL Atualizar_Saldo_Tit_Rec(nr_titulo_p, nm_usuario_p);
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE desfazer_cancelamento_titulo ( nr_titulo_p bigint, nm_usuario_p text) FROM PUBLIC;

