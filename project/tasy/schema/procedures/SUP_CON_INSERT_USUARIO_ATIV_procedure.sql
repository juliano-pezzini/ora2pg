-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE sup_con_insert_usuario_ativ ( nr_sequencia_p bigint, nm_usuario_p text, ie_opcao_p text, nr_seq_ativ_p INOUT bigint) AS $body$
DECLARE


nr_sequencia_w          bigint;
nr_seq_controle_w       bigint;
dt_atualizacao_w        timestamp;
nm_usuario_w            varchar(15);
dt_atividade_w          timestamp;
nr_seq_tipo_ativ_w      bigint;
qt_minuto_w             bigint;
ds_observacao_w         varchar(255);
dt_inicio_w             timestamp;
dt_fim_w                timestamp;
nr_seq_cliente_w        bigint;
ds_objetivo_w           varchar(80);
ds_cliente_w            pessoa_juridica.ds_razao_social%type;

/*
ie_opcao_p :
C = pasta conexao
V = pasta Versao
*/
BEGIN

if (ie_opcao_p = 'C') then
        select  dt_inicio,
                dt_fim,
                nr_seq_cliente,
                ds_objetivo,
                Obter_Min_Entre_Datas(dt_inicio,dt_fim,null)
        into STRICT    dt_inicio_w,
                dt_fim_w,
                nr_seq_cliente_w,
                ds_objetivo_w,
                qt_minuto_w
        from    sup_conexao
        where   nr_sequencia = nr_sequencia_p;
elsif (ie_opcao_p = 'V') then
        select  dt_inicio,
                dt_fim,
                nr_seq_cliente,
                ds_conclusao,
                Obter_Min_Entre_Datas(dt_inicio,dt_fim,null)
        into STRICT    dt_inicio_w,
                dt_fim_w,
                nr_seq_cliente_w,
                ds_objetivo_w,
                qt_minuto_w
        from    sup_versao
        where   nr_sequencia = nr_sequencia_p;
end if;

begin
select  nr_sequencia
into STRICT    nr_seq_controle_w
from    usuario_controle
where   trunc(dt_entrada,'dd')  = trunc(dt_inicio_w,'dd')
and     nm_usuario              = nm_usuario_p;
exception
        when others then
        nr_seq_controle_w := 0;
end;

Begin
select  b.ds_razao_social
into STRICT    ds_cliente_w
from    pessoa_juridica b,
        man_localizacao a
where   a.cd_cnpj = b.cd_cgc
and     a.nr_sequencia = nr_seq_cliente_w;
exception
        when others then
        --ds_cliente_w := 'Cliente nao Informado';
	ds_cliente_w := wheb_mensagem_pck.get_texto(303065);
end;

if (nr_seq_controle_w <> 0) then
        if (ie_opcao_p = 'C') then
                insert into usuario_atividade(
                                        nr_sequencia,
                                        nr_seq_controle,
                                        dt_atualizacao,
                                        nm_usuario,
                                        dt_atividade,
                                        nr_seq_tipo_ativ,
                                        qt_minuto,
                                        ds_observacao)
                                values ( nextval('usuario_atividade_seq'),
                                        nr_seq_controle_w,
                                        clock_timestamp(),
                                        nm_usuario_p,
                                        dt_inicio_w,
                                        172,
                                        qt_minuto_w,
                                        substr(ds_cliente_w||' - '||ds_objetivo_w,1,255));
        elsif (ie_opcao_p = 'V') then
                insert into usuario_atividade(
                                        nr_sequencia,
                                        nr_seq_controle,
                                        dt_atualizacao,
                                        nm_usuario,
                                        dt_atividade,
                                        nr_seq_tipo_ativ,
                                        qt_minuto,
                                        ds_observacao)
                                values ( nextval('usuario_atividade_seq'),
                                        nr_seq_controle_w,
                                        clock_timestamp(),
                                        nm_usuario_p,
                                        dt_inicio_w,
                                        171,
                                        qt_minuto_w,
                                        substr(ds_cliente_w||' - '||ds_objetivo_w,1,255));
        end if;
end if;

CALL Atualizar_Ativ_Usuario(nr_seq_controle_w);


commit;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE sup_con_insert_usuario_ativ ( nr_sequencia_p bigint, nm_usuario_p text, ie_opcao_p text, nr_seq_ativ_p INOUT bigint) FROM PUBLIC;

