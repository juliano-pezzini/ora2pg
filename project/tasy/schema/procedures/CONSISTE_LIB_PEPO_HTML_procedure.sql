-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE consiste_lib_pepo_html ( nr_cirurgia_p bigint, nr_seq_pepo_p bigint, ie_geral_permite_liberar_p INOUT text) AS $body$
DECLARE

 
ie_consistir_pepo_w  	varchar(1);
ie_parametro_158_w  	varchar(1);
ie_gerar_tempo_w  	varchar(1);
ie_possui_consistencia_w 	varchar(1) := 'N';
nr_prescricao_w  		bigint;
ie_geral_permite_liberar_w 	varchar(1) := 'L';
cd_perfil_w   		integer;
nm_usuario_w  		varchar(15);
cd_estabelecimento_w 	integer;


BEGIN 
cd_perfil_w  		:= wheb_usuario_pck.get_cd_perfil;
nm_usuario_w  		:= wheb_usuario_pck.get_nm_usuario;
cd_estabelecimento_w 	:= wheb_usuario_pck.get_cd_estabelecimento;
 
ie_consistir_pepo_w := obter_param_usuario(872, 117, cd_perfil_w, nm_usuario_w, cd_estabelecimento_w, ie_consistir_pepo_w);
 
if (ie_consistir_pepo_w = 'S') then 
	if (coalesce(nr_cirurgia_p,0) > 0) then 
		ie_geral_permite_liberar_w := Consiste_Liberacao_PEPO(nr_cirurgia_p, nm_usuario_w, NULL, 'S', ie_geral_permite_liberar_w);
	else 
		ie_geral_permite_liberar_w := Consiste_Liberacao_PEPO_SUP(nr_seq_pepo_p, nm_usuario_w, 'S', ie_geral_permite_liberar_w);
	end if;
 
	select 	coalesce(max('S'),'N') 
	into STRICT 	ie_possui_consistencia_w 
	from	consistencia_cirurgia a, 
		consistencia_lib_pepo b 
	where	a.nr_seq_consistencia  = b.nr_sequencia 
	and 	((b.cd_estabelecimento = cd_estabelecimento_w) or (coalesce(b.cd_estabelecimento::text, '') = '')) 
	and 	((a.nr_cirurgia = coalesce(nr_cirurgia_p,0)) or (coalesce(nr_seq_pepo_p,0) = a.nr_seq_pepo)) 
	and 	obter_se_cirurgia_cancelada(a.nr_cirurgia) = 'N';
end if;
 
if (ie_possui_consistencia_w = 'N') then 
	ie_geral_permite_liberar_w := 'L';
end if;
 
ie_geral_permite_liberar_p := ie_geral_permite_liberar_w;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE consiste_lib_pepo_html ( nr_cirurgia_p bigint, nr_seq_pepo_p bigint, ie_geral_permite_liberar_p INOUT text) FROM PUBLIC;

