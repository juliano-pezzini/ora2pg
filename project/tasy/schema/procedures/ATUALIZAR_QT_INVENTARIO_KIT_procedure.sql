-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE atualizar_qt_inventario_kit ( nr_seq_inventario_p bigint, cd_kit_material_p bigint, qt_kit_p bigint, ds_justificativa_p text, nm_usuario_p text, cd_estabelecimento_p bigint) AS $body$
DECLARE


cd_material_w	    	integer;
qt_atual_contagem_w 	double precision;
ie_contagem_w	    	varchar(15);
qt_material_w		double precision;
qt_contagem_inicial_w	double precision;
qt_recontagem_w		double precision;
qt_seg_recontagem_w	double precision;
qt_terc_recontagem_w	double precision;
nr_sequencia_w		bigint;
qt_componente_w	double precision;
qt_total_kit_w		double precision;
cd_kit_material_w	integer;
ds_contagem_txt_w	varchar(30) := wheb_mensagem_pck.get_texto(311640);
C01 CURSOR FOR
SELECT	a.ie_contagem_atual,
	b.cd_material,
	b.nr_sequencia,
	coalesce(b.qt_contagem,0),
	coalesce(b.qt_recontagem,0),
	coalesce(b.qt_seg_recontagem,0),
	coalesce(b.qt_terc_recontagem,0),
	d.qt_material,
	d.cd_kit_material
from	inventario a,
	inventario_material b,
	componente_kit d
where	a.nr_sequencia = b.nr_seq_inventario
and	b.cd_material = d.cd_material
and	d.cd_kit_material = cd_kit_material_p
and	a.nr_sequencia = nr_seq_inventario_p;


BEGIN

open C01;
loop
fetch C01 into
	ie_contagem_w,
	cd_material_w,
	nr_sequencia_w,
	qt_contagem_inicial_w,
	qt_recontagem_w,
	qt_seg_recontagem_w,
	qt_terc_recontagem_w,
	qt_componente_w,
	cd_kit_material_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	qt_total_kit_w := qt_componente_w * qt_kit_p;

	if (ie_contagem_w = '1') then
		begin
		update	inventario_material
		set	qt_contagem = qt_contagem_inicial_w + qt_total_kit_w,
			cd_kit_material = cd_kit_material_w,
			ds_justificativa   = substr(substr(ds_justificativa,1,1900) || chr(13) || chr(10) || substr( ie_contagem_w || 'ª' || ' '||ds_contagem_txt_w||' ' || ds_justificativa_p,1,1900),1,4000)
		where 	nr_seq_inventario = nr_seq_inventario_p
		and   	nr_sequencia = nr_sequencia_w;
		end;
	elsif (ie_contagem_w = '2') then
		begin
		update	inventario_material
		set   	qt_recontagem  = qt_recontagem_w + qt_total_kit_w,
			cd_kit_material = cd_kit_material_w,
			ds_justificativa   = substr(substr(ds_justificativa,1,1900) || chr(13) || chr(10) || substr( ie_contagem_w || 'ª' ||' '||ds_contagem_txt_w||' '|| ds_justificativa_p,1,1900),1,4000)
		where 	nr_seq_inventario = nr_seq_inventario_p
		and   	nr_sequencia = nr_sequencia_w;
		end;
	elsif (ie_contagem_w = '3') then
		begin
		update	inventario_material
		set   	qt_seg_recontagem  = qt_seg_recontagem_w + qt_total_kit_w,
			cd_kit_material = cd_kit_material_w,
			ds_justificativa   = substr(substr(ds_justificativa,1,1900) || chr(13) || chr(10) || substr( ie_contagem_w || 'ª' ||' '||ds_contagem_txt_w||' '|| ds_justificativa_p,1,1900),1,4000)
		where 	nr_seq_inventario = nr_seq_inventario_p
		and   	nr_sequencia = nr_sequencia_w;
		end;
	elsif (ie_contagem_w = '4') then
		begin
		update	inventario_material
		set   	qt_terc_recontagem = qt_terc_recontagem_w + qt_total_kit_w,
			cd_kit_material = cd_kit_material_w,
			ds_justificativa   = substr(substr(ds_justificativa,1,1900) || chr(13) || chr(10) || substr( ie_contagem_w || 'ª' || ' '||ds_contagem_txt_w||' ' || ds_justificativa_p,1,1900),1,4000)
		where 	nr_seq_inventario = nr_seq_inventario_p
		and   	nr_sequencia = nr_sequencia_w;
	end;
	end if;
	end;
end loop;
close C01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE atualizar_qt_inventario_kit ( nr_seq_inventario_p bigint, cd_kit_material_p bigint, qt_kit_p bigint, ds_justificativa_p text, nm_usuario_p text, cd_estabelecimento_p bigint) FROM PUBLIC;

