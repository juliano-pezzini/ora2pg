-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_item_autor_mat_especial ( nr_seq_material_p bigint, nm_usuario_p text) AS $body$
DECLARE


nr_sequencia_mat_w	bigint;
nr_seq_autor_cirurgia_w	bigint;
cd_material_w		integer;
qt_solicitada_w		bigint;
pr_adicional_w		bigint;
vl_unitario_w		bigint;
ie_valor_conta_w		varchar(1);
ds_observacao_w		varchar(2000);
ie_reducao_acrescimo_w	varchar(1);


BEGIN

begin

select	a.cd_material,
	a.qt_solicitada,
	a.pr_adicional,
	a.vl_unitario,
	a.ie_valor_conta,
	a.ds_observacao,
	a.ie_reducao_acrescimo,
	b.nr_seq_autor_cirurgia
into STRICT	cd_material_w,
	qt_solicitada_w,
	pr_adicional_w,
	vl_unitario_w,
	ie_valor_conta_w,
	ds_observacao_w,
	ie_reducao_acrescimo_w,
	nr_seq_autor_cirurgia_w
from 	material_autorizado a,
	autorizacao_convenio b
where	a.nr_sequencia_autor = b.nr_sequencia
and	a.nr_sequencia = nr_seq_material_p;

exception
when others then
	nr_seq_autor_cirurgia_w := 0;
end;

if (coalesce(nr_seq_material_p,0) > 0) and (coalesce(nr_seq_autor_cirurgia_w, 0) > 0) then

	select	nextval('material_autor_cirurgia_seq')
	into STRICT	nr_sequencia_mat_w
	;

	insert	into material_autor_cirurgia(nr_sequencia,
		nr_seq_autorizacao,
		nm_usuario,
		dt_atualizacao,
		nm_usuario_nrec,
		dt_atualizacao_nrec,
		cd_material,
		qt_solicitada,
		qt_material,
		vl_unitario_material,
		vl_material,
		ie_aprovacao,
		ie_valor_conta,
		ds_observacao,
		pr_adicional,
		ie_reducao_acrescimo)
	values (nr_sequencia_mat_w,
		nr_seq_autor_cirurgia_w,
		nm_usuario_p,
		clock_timestamp(),
		nm_usuario_p,
		clock_timestamp(),
		cd_material_w,
		qt_solicitada_w,
		0,
		0,
		0,
		'N',
		ie_valor_conta_w,
		ds_observacao_w,
		pr_adicional_w,
		ie_reducao_acrescimo_w);

	insert into material_autor_cir_cot(nr_sequencia,
		cd_cgc,
		dt_atualizacao,
		nm_usuario,
		dt_atualizacao_nrec,
		nm_usuario_nrec,
		ie_aprovacao,
		nr_orcamento,
		vl_unitario_cotado,
		vl_cotado)
	SELECT	nr_sequencia_mat_w,
		a.cd_cgc_fabricante,
		clock_timestamp(),
		nm_usuario_p,
		clock_timestamp(),
		nm_usuario_p,
		' ',
		a.nr_orcamento,
		coalesce(a.vl_cotado,0),
		(coalesce(a.vl_cotado,0) * a.qt_solicitada)
	from 	material_autorizado a
	where	a.nr_sequencia	    = nr_seq_material_p
	and	(a.cd_cgc_fabricante IS NOT NULL AND a.cd_cgc_fabricante::text <> '')
	and	not exists (	SELECT 1
				from 	material_autor_cir_cot x
				where	x.nr_sequencia = nr_seq_autor_cirurgia_w
				and	x.cd_cgc	= a.cd_cgc_fabricante
				and	coalesce(x.nr_orcamento,coalesce(a.nr_orcamento,'X')) = coalesce(a.nr_orcamento,'X'));


end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_item_autor_mat_especial ( nr_seq_material_p bigint, nm_usuario_p text) FROM PUBLIC;

