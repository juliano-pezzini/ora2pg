-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE aghos_solicitacao_internacao ( nr_atendimento_p bigint, nr_seq_laudo_p bigint, nm_usuario_p text) AS $body$
DECLARE



cd_pessoa_fisica_w		varchar(10);
cd_estabelecimento_w		bigint;

nr_seq_internacao_aghos_w 	bigint := 0;
ie_status_w 			varchar(1) := 'A';
ds_erro_w 			varchar(500);
dt_integracao_w			timestamp := clock_timestamp();
ds_usuario_w 			varchar(15);
cd_cnes_solicitante_w 		integer;
nr_prontuario_w			integer;
ds_nome_paciente_w 		varchar(60);
dt_nascimento_w			timestamp;
ie_sexo_w 			smallint;
ie_estado_civil_w 		smallint;
ds_nome_mae_w 			varchar(60);
ds_nome_pai_w 			varchar(60);
cd_cep_w 			integer;
nr_endereco_w			bigint;
ds_complemento_w		varchar(100);
cd_ocupacao_cbo_w		varchar(6);
ie_cor_raca_w 			smallint;
cd_naturalidade_w		integer;
cd_nacionalidade_w 		integer;
nr_identidade_w			varchar(20);
nr_cpf_w			bigint;
nr_cartao_sus_w			bigint;
nr_internacao_w			integer;
ie_prioridade_w			smallint;
nr_cpf_medico_solicitante_w 	bigint;
cd_procedimento_unificado_w 	bigint;
cd_cid_w			varchar(4);
ds_laudo_sinais_sintomas_w 	varchar(1000);
ds_laudo_justificativa_w	varchar(1000);
ds_laudo_result_diagnostico_w 	varchar(1000);
ie_uti_w 			smallint;
ds_prontuario_solicitante_w 	varchar(11);

ds_sep_bv_w			varchar(50);
ds_comando_w			varchar(2000);

--pragma autonomous_transaction;
BEGIN

/*  tabela      GSH_I_INTERN_SOLICI_ENT

IDF_GSH_I_INTERN_SOLICI_(ENT/SAI)	NUMBER			not null
TIP_STATUS 			VARCHAR2(1)		not null	A ¿ Aguardando (registro aguardando ser integrado) / P ¿ Processado (registro já integrado)   / E ¿ Erro (erro na integração)
DES_ERRO 			VARCHAR2(500)		null
DAT_INTEGRACAO 		DATE			not null
DES_USUARIO 			VARCHAR2(15)		not null
COD_CNES_SOLICITANTE 		NUMBER(7)		not null
IDF_PRONTUARIO 		NUMBER(9) 		null
DES_NOME_PACIENTE 		VARCHAR2(60) 		not null
DAT_NASCIMENTO 		DATE 			not null
IDF_SEXO 			NUMBER(2) 		not null     1 - M / 2 - F / 3 - Ambos
IDF_ESTADO_CIVIL 		NUMBER(2) 		null	1 - solteiro / 2 - casado / 3 - divorciado / 4 - viúva (o)
DES_NOME_MAE 			VARCHAR2(60) 		not null
DES_NOME_PAI 			VARCHAR2(60) 		null
COD_CEP 			NUMBER(8) 		not null
NUM_ENDERECO			NUMBER(10) 		not null
DES_COMPLEMENTO 		VARCHAR2(100) 		null
COD_OCUPACAO 			VARCHAR2(6) 		null
IDF_COR_RACA 			NUMBER(2) 		not null	0 ¿ nulo / 1 - branca / 2 - negra /  3 - amarela / 4 - parda / 5 ¿ indígena
COD_NATURALIDADE		NUMBER(7) 		null
COD_NACIONALIDADE 		NUMBER(5) 		null
NUM_IDENTIDADE 		VARCHAR2(20) 		null
NUM_CPF 			NUMBER(11) 		null
NUM_CARTAO_SUS		NUMBER(15) 		null
IDF_INTERNACAO 		NUMBER(9) 		null	retorno do aghos
IDF_PRIORIDADE 			NUMBER(2) 		not null	1 - urgência / 2 - emergência / 3 - eletiva
NUM_CPF_MEDICO_SOLICITANTE 	NUMBER(11) 		not null
COD_PROCEDIMENTO_UNIFICADO 	NUMBER(10) 		not null
COD_CID 			VARCHAR2(4) 		not null
DES_LAUDO_SINAIS_SINTOMAS 	VARCHAR2(1000) 		not null
DES_LAUDO_JUSTIFICATIVA 	VARCHAR2(1000) 		not null
DES_LAUDO_RESULT_DIAGNOSTICO 	VARCHAR2(1000) 		not null
TIP_UTI 				NUMBER(1) 		not null
DES_PRONTUARIO_SOLICITANTE 	VARCHAR2(11) 		null
*/
select	maX(cd_pessoa_fisica),
	max(cd_estabelecimento),
	max(CASE WHEN ie_tipo_atendimento=3 THEN  1 WHEN ie_tipo_atendimento=  -- Tipo atend. Pronto Socorro = Prioridade "urgência"
				    7 THEN  3 WHEN ie_tipo_atendimento=  -- Tipo atend. Externo = Prioridade "eletiva"
				    8 THEN  3 END ),  -- Tipo atend. Ambulatorial = Prioridade "eletiva",
	max(substr(obter_cnes_estab(cd_estabelecimento), 1, 7))
into STRICT	cd_pessoa_fisica_w,
	cd_estabelecimento_w,
	ie_prioridade_w,
	cd_cnes_solicitante_w
from	atendimento_paciente
where	nr_atendimento = nr_atendimento_p;

select	max(substr(obter_cpf_pessoa_fisica(cd_medico_requisitante), 1, 11)),
	max(cd_procedimento_solic),
	max(cd_cid_principal),
	max(ds_sinal_sintoma),
	max(ds_condicao_justifica),
	max(ds_result_prova)
into STRICT	nr_cpf_medico_solicitante_w,
	cd_procedimento_unificado_w,
	cd_cid_w,
	ds_laudo_sinais_sintomas_w,
	ds_laudo_justificativa_w,
	ds_laudo_result_diagnostico_w
from	sus_laudo_paciente
where	nr_atendimento = nr_atendimento_p
and	nr_seq_interno = nr_seq_laudo_p;

select	max(dt_nascimento),
	max(CASE WHEN ie_sexo='M' THEN  1 WHEN ie_sexo='F' THEN  2 WHEN ie_sexo='I' THEN  3 END ),
	max(CASE WHEN ie_estado_civil=1 THEN  1 WHEN ie_estado_civil=  -- Tasy: Solteiro / Aghos: Solteiro
				2 THEN  2 WHEN ie_estado_civil=  -- Tasy: Casado / Aghos: Casado
				3 THEN  3 WHEN ie_estado_civil=  -- Tasy: Divorciado / Aghos: Divorciado
				4 THEN  3 WHEN ie_estado_civil=  -- Tasy: Desquitado / Aghos: Divorciado
				5 THEN  4 WHEN ie_estado_civil=  -- Tasy: Viúvo / Aghos: Viúvo
				6 THEN  3 WHEN ie_estado_civil=  -- Tasy: Separado / Aghos: Divorciado
				7 THEN  1 WHEN ie_estado_civil=  -- Tasy: Concubinado / Aghos: Solteiro
				8 THEN  1 END ), -- Tasy: Outros / Aghos: Solteiro
	max(nm_pessoa_fisica),
	max(substr(obter_nome_mae_pf(cd_pessoa_fisica), 1, 60)),
	max(substr(obter_nome_pai_mae(cd_pessoa_fisica, 'P'), 1, 60)),
	max(substr(obter_compl_pf(cd_pessoa_fisica, 1, 'CEP'), 1, 8)),
	max(substr(obter_compl_pf(cd_pessoa_fisica, 1, 'NR'), 1, 10)),
	max(substr(obter_compl_pf(cd_pessoa_fisica, 1, 'CO'), 1, 60)),
	max(substr(obter_dados_pf(cd_pessoa_fisica, 'CBOS'), 1, 6)),
	max(substr(sus_obter_cor_pele(cd_pessoa_fisica, 'C'), 1, 2)),
	max(substr(obter_compl_pf(cd_pessoa_fisica, 1, 'CDM'), 1, 7)),
	max(substr(obter_compl_pf(cd_pessoa_fisica, 1, 'CBPAIS'), 1, 5)),
	max(substr(obter_dados_pf(cd_pessoa_fisica, 'RG'), 1, 20)),
	max(substr(obter_cpf_pessoa_fisica(cd_pessoa_fisica), 1, 11)),
	max(nr_cartao_nac_sus),
	max(substr(obter_prontuario_pf(cd_pessoa_fisica, cd_estabelecimento_w), 1, 9))
into STRICT	dt_nascimento_w,
	ie_sexo_w,
	ie_estado_civil_w,
	ds_nome_paciente_w,
	ds_nome_mae_w,
	ds_nome_pai_w,
	cd_cep_w,
	nr_endereco_w,
	ds_complemento_w,
	cd_ocupacao_cbo_w,
	ie_cor_raca_w,
	cd_naturalidade_w,
	cd_nacionalidade_w,
	nr_identidade_w,
	nr_cpf_w,
	nr_cartao_sus_w,
	ds_prontuario_solicitante_w
from	pessoa_fisica
where	cd_pessoa_fisica = cd_pessoa_fisica_w;

ds_sep_bv_w  := obter_separador_bv;

ds_comando_w :=	'declare '||
		'	ds_erro_ww	varchar2(500); '||
		'begin '||
		'	gsh_i_prc_intern_solici_ent@tasy_aghos(	0, '||
		'						''A'', '||
		'						ds_erro_ww, '||
		'						sysdate, '||
		'						''TREINA'', '||
		'						:cd_cnes_solicitante_p, '||
		'						:nr_prontuario_p, '||
		'						:ds_nome_paciente_p, '||
		'						''' || to_char(dt_nascimento_w, 'dd/mm/yyyy') || ''', '||
		'						:ie_sexo_p, '||
		'						:ie_estado_civil_p, '||
		'						:ds_nome_mae_p, '||
		'						:ds_nome_pai_p,  '||
		'						:cd_cep_p, '||
		'						:nr_endereco_p, '||
		'						:ds_complemento_p,  '||
		'						:cd_ocupacao_cbo_p, '||
		'						:ie_cor_raca_p, '||
		'						:cd_naturalidade_p,  '||
		'						:cd_nacionalidade_p,  '||
		'						:nr_identidade_p,  '||
		'						:nr_cpf_p,  '||
		'						:nr_cartao_sus_p,  '||
		'						:nr_internacao_p, '||
		'						:ie_prioridade_p, '||
		'						:nr_cpf_medico_solicitante_p,  '||
		'						:cd_procedimento_unificado_p, '||
		'						:cd_cid_p, '||
		'						:ds_laudo_sinais_sintomas_p, '||
		'						:ds_laudo_justificativa_p, '||
		'						:ds_laudo_result_diagnostico_p, '||
		'						0, '||
		'						:ds_prontuario_solicitante_p); '||
		' end;';

CALL exec_sql_dinamico_bv('AGHOS', ds_comando_w,	--'dt_integracao_p='		|| dt_integracao_w		|| ds_sep_bv_w ||
						'cd_cnes_solicitante_p='	|| cd_cnes_solicitante_w	|| ds_sep_bv_w ||
						'nr_prontuario_p=' 		|| nr_prontuario_w		|| ds_sep_bv_w ||
						'ds_nome_paciente_p=' 		|| ds_nome_paciente_w		|| ds_sep_bv_w ||
						--'dt_nascimento_p=' 		|| dt_nascimento_w		|| ds_sep_bv_w ||
						'ie_sexo_p=' 			|| ie_sexo_w			|| ds_sep_bv_w ||
						'ie_estado_civil_p=' 		|| ie_estado_civil_w		|| ds_sep_bv_w ||
						'ds_nome_mae_p=' 		|| ds_nome_mae_w		|| ds_sep_bv_w ||
						'ds_nome_pai_p=' 		|| ds_nome_pai_w		|| ds_sep_bv_w ||
						'cd_cep_p='			|| cd_cep_w			|| ds_sep_bv_w ||
						'nr_endereco_p=' 		|| nr_endereco_w		|| ds_sep_bv_w ||
						'ds_complemento_p=' 		|| ds_complemento_w		|| ds_sep_bv_w ||
						'cd_ocupacao_cbo_p=' 		|| cd_ocupacao_cbo_w		|| ds_sep_bv_w ||
						'ie_cor_raca_p=' 		|| ie_cor_raca_w		|| ds_sep_bv_w ||
						'cd_naturalidade_p=' 		|| cd_naturalidade_w		|| ds_sep_bv_w ||
						'cd_nacionalidade_p=' 		|| cd_nacionalidade_w		|| ds_sep_bv_w ||
						'nr_identidade_p=' 		|| nr_identidade_w		|| ds_sep_bv_w ||
						'nr_cpf_p=' 			|| nr_cpf_w			|| ds_sep_bv_w ||
						'nr_cartao_sus_p=' 		|| nr_cartao_sus_w		|| ds_sep_bv_w ||
						'nr_internacao_p=' 		|| nr_internacao_w		|| ds_sep_bv_w ||
						'ie_prioridade_p=' 		|| ie_prioridade_w		|| ds_sep_bv_w ||
						'nr_cpf_medico_solicitante_p='	|| nr_cpf_medico_solicitante_w	|| ds_sep_bv_w ||
						'cd_procedimento_unificado_p='	|| cd_procedimento_unificado_w	|| ds_sep_bv_w ||
						'cd_cid_p=' 			|| cd_cid_w			|| ds_sep_bv_w ||
						'ds_laudo_sinais_sintomas_p=' 	|| ds_laudo_sinais_sintomas_w	|| ds_sep_bv_w ||
						'ds_laudo_justificativa_p=' 	|| ds_laudo_justificativa_w	|| ds_sep_bv_w ||
						'ds_laudo_result_diagnostico_p='|| ds_laudo_result_diagnostico_w|| ds_sep_bv_w ||
						'ds_prontuario_solicitante_p='  || ds_prontuario_solicitante_w);

ds_comando_w := null;
ds_comando_w :=	'declare '||
		'	solici_sai gsh_i_pkg_integra_sai.solici_sai@tasy_aghos; '||
		'	ds_erro_ww	varchar2(500); '||
		'	cd_cgc_w	varchar2(14); '||
		'begin '||
		' '||
		'	gsh_i_pkg_integra_sai.gsh_i_prc_intern_solici_sai@tasy_aghos(solici_sai); '||
		' '||
		'	if	(solici_sai.first is not null) then '||
		'		for i in solici_sai.first..solici_sai.last loop '||
		' '||
		'			select	max(cd_cgc) '||
		'			into	cd_cgc_w '||
		'			from	pessoa_juridica '||
		'			where	nvl(cd_cnes, ''0'') = solici_sai(i).cod_cnes_solicitante; '||
		' '||
		'			if	(solici_sai(i).cod_cnes_solicitante = :cd_cnes_solicitante_p) then '||
		'				insert into solicitacao_tasy_aghos ( '||
		'					nr_sequencia, '||
		'					dt_atualizacao, '||
		'					nm_usuario, '||
		'					dt_atualizacao_nrec, '||
		'					nm_usuario_nrec, '||
		'					nr_internacao, '||
		'					ie_urgencia, '||
		'					nr_seq_laudo, '||
		'					nr_atend_original, '||
		'					ie_situacao , '||
		'					ie_motivo_rejeicao, '||
		'					nr_atendimento, '||
		'					ie_erro, '||
		'					ds_erro, '||
		'					ds_motivo_situacao, '||
		'					cd_cgc, '||
		'					nm_paciente) '||
		'				values	(solicitacao_tasy_aghos_seq.nextval, '||
		'					 sysdate, '||
		'					 :nm_usuario_p, '||
		'					 sysdate, '||
		'					 :nm_usuario_p, '||
		'					 solici_sai(i).idf_internacao, '||
		'					 solici_sai(i).idf_prioridade, '||
		'					 :nr_seq_laudo_p, '||
		'					 :nr_atendimento_p, '||
		'					 ''A'', '||
		'					 null, '||
		'					 null, '||
		'					 decode(solici_sai(i).des_erro, null, ''N'', ''S''), '||
		'					 solici_sai(i).des_erro, '||
		'					 ''Solicitação enviada ao Aghos'', '||
		'				 	cd_cgc_w, '||
		'				 	solici_sai(i).des_nome_paciente); '||
		' '||
		'			end if; '||
		' '||
		'			gsh_i_prc_intern_solici_s_u@tasy_aghos(	solici_sai(i).idf_gsh_i_intern_solici_sai,  '||
		'								''P'', '||
		'								ds_erro_ww); '||
		'		end loop; '||
		'	end if; '||
		'end;';

CALL exec_sql_dinamico_bv('AGHOS', ds_comando_w,	'nr_seq_laudo_p=' 		|| nr_seq_laudo_p 		|| ds_sep_bv_w ||
						'nr_atendimento_p=' 		|| nr_atendimento_p 		|| ds_sep_bv_w ||
						'nm_usuario_p=' 		|| nm_usuario_p 		|| ds_sep_bv_w ||
						'cd_cnes_solicitante_p='	|| cd_cnes_solicitante_w);

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE aghos_solicitacao_internacao ( nr_atendimento_p bigint, nr_seq_laudo_p bigint, nm_usuario_p text) FROM PUBLIC;

