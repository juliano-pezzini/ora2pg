-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE ctb_gerar_relat_aux_consumo ( nr_lote_contabil_p bigint, nm_usuario_p text, ie_exclusao_p text, ds_retorno_p INOUT text, dt_mesano_referencia_p timestamp, cd_estabelecimento_p bigint) AS $body$
DECLARE


cd_empresa_w				empresa.cd_empresa%type;
cd_estabelecimento_w			estabelecimento.cd_estabelecimento%type := cd_estabelecimento_p;
cd_material_w				material.cd_material%type;
cd_conta_contabil_w			conta_contabil.cd_conta_contabil%type;
cd_centro_custo_w			centro_custo.cd_centro_custo%type;
vl_movimento_w				double precision;
cd_historico_w         			historico_padrao.cd_historico%type;
cd_historico_ww         		bigint;
nr_sequencia_movto_w			integer;
dt_movimento_w				timestamp;
dt_mesano_referencia_w			timestamp := trunc(dt_mesano_referencia_p);
ds_compl_historico_w			varchar(255)	:= '';
ds_complemento_w			varchar(255)	:= '';
ds_doc_agrupamento_w			varchar(50)	:= '';
nr_seq_agrupamento_w			w_movimento_contabil.nr_seq_agrupamento%type;
ie_clinica_w				integer;
cd_local_estoque_w			smallint	:= Null;
cd_operacao_estoque_w			bigint;
cd_tipo_lote_contabil_w			bigint;
ds_local_estoque_w			local_estoque.ds_local_estoque%type;
ds_local_consumo_w			varchar(80);
ie_debito_credito_w			varchar(01);
cd_hist_transf_entrada_w		bigint;
cd_hist_transf_saida_w			bigint;
cd_hist_transf_w			bigint;
ie_mat_contab_cons_w			varchar(01);
ds_material_w				material.ds_material%type;
ie_mes_contab_w				varchar(03);
ie_compl_hist_w				varchar(1);
ds_conteudo_w				varchar(4000);
ds_mesano_referencia_w			varchar(30);
qt_lotes_gerados_w			bigint;
ie_compl_historico_w			varchar(1);
cd_conta_debito_w			varchar(20);
cd_conta_credito_w			varchar(20);
cd_historico_debito_w			bigint;
ds_operacao_estoque_w			varchar(40);
ie_resumo_movto_estoque_dia_w		varchar(1);
dt_dia_contabil_w			timestamp;
nm_estabelecimento_w			varchar(255);
cd_grupo_material_w			bigint;
cd_subgrupo_material_w			bigint;
cd_classe_material_w			bigint;
ds_classe_material_w			varchar(240);
ds_grupo_material_w			varchar(240);
ds_subgrupo_material_w			varchar(240);
cd_evento_w				bigint;
cd_historico_evento_w			bigint;
ie_historico_evento_oper_w		varchar(1);

/*gazimmermann 28/12/2011 OS 398666*/

cd_unidade_medida_consumo_w		varchar(30);
qt_consumo_w				double precision;
ie_permite_estab_dif_w			varchar(15);
cd_historico_ct_w			historico_padrao.cd_historico%type;
cd_conta_transitoria_w			conta_contabil.cd_conta_contabil%type;
/*gazimmermann 28/12/2011 OS 398666*/

ds_mes_ano_w				varchar(10);
ie_centro_custo_w			conta_contabil.ie_centro_custo%type;

--dt_mesano_referencia_w := to_date(dt_mesano_referencia_p);
/* Cursor para ler os Movimentos a serem contabilizados	*/

C000 CURSOR FOR
	SELECT	cd_material,
		cd_centro_custo,
		a.cd_local_estoque,
		a.cd_operacao_estoque,
		sum(CASE WHEN b.ie_entrada_saida='S' THEN  vl_estoque  ELSE vl_estoque * -1 END ),
		'',
		'',
		0,
		substr(obter_desc_local_estoque(a.cd_local_estoque),1,80),
		coalesce(sum(a.qt_consumo),0) qt_consumo
	from	Operacao_estoque b,
		resumo_movto_estoque a
	where	a.dt_mesano_referencia	= trunc(dt_mesano_referencia_w,'month')
	and	a.cd_estabelecimento		= cd_estabelecimento_w
	and	(a.cd_centro_custo IS NOT NULL AND a.cd_centro_custo::text <> '')
	and   	coalesce(a.ie_consignado,'N')	= 'N'
	and	a.cd_operacao_estoque	= b.cd_operacao_estoque
	group by
		cd_material,
		cd_centro_custo,
		a.cd_local_estoque,
		a.cd_operacao_estoque,
		substr(obter_desc_local_estoque(a.cd_local_estoque),1,80)
	
union all

	SELECT	cd_material,
		cd_centro_custo,
		a.cd_local_estoque,
		a.cd_operacao_estoque,
		sum(vl_estoque),
		substr(obter_desc_local_estoque(cd_local_destino),1,80),
		CASE WHEN b.ie_entrada_saida='S' THEN 'C'  ELSE 'D' END ,
		CASE WHEN b.ie_entrada_saida='S' THEN  cd_hist_transf_saida_w  ELSE cd_hist_transf_entrada_w END ,
		'',
		coalesce(sum(a.qt_consumo),0)
	from	Operacao_estoque b,
		resumo_movto_estoque a
	where	a.dt_mesano_referencia	= trunc(dt_mesano_referencia_w,'month')
	and	a.cd_estabelecimento		= cd_estabelecimento_w
	and	(a.cd_local_destino IS NOT NULL AND a.cd_local_destino::text <> '')
	and	coalesce(a.ie_consignado,'N')	= 'N'
	and	a.cd_operacao_estoque	= b.cd_operacao_estoque
	and	(cd_hist_transf_entrada_w IS NOT NULL AND cd_hist_transf_entrada_w::text <> '')
	and	(cd_hist_transf_saida_w IS NOT NULL AND cd_hist_transf_saida_w::text <> '')
	and	b.ie_tipo_requisicao	= '2'
	group by
		cd_material,
		cd_centro_custo,
		a.cd_local_estoque,
		a.cd_operacao_estoque,
		substr(obter_desc_local_estoque(cd_local_destino),1,80),
		b.ie_entrada_saida;


BEGIN

delete from w_ctb_livro_aux_consumo
where	nm_usuario = nm_usuario_p;

commit;

select	max(nm_fantasia_estab)
into STRICT	nm_estabelecimento_w
from	estabelecimento
where	cd_estabelecimento	= cd_estabelecimento_w;

cd_empresa_w		:= obter_empresa_estab(cd_estabelecimento_w);
dt_dia_contabil_w	:= trunc(dt_mesano_referencia_w,'dd');
dt_movimento_w		:= last_day(trunc(dt_mesano_referencia_p,'dd'));
Select	max(cd_historico)
into STRICT	cd_historico_w
from	evento_contabil_param_estab
where	cd_tipo_lote_contabil	= 3
and	cd_estabelecimento	= cd_estabelecimento_w;

cd_historico_ww	:= cd_historico_w;

ds_mesano_referencia_w	:= substr(obter_desc_mes_ano(dt_mesano_referencia_w, ie_mes_contab_w),1,30);
nr_sequencia_movto_w	:= 0;

OPEN C000;
LOOP
FETCH C000 INTO
	cd_material_w,
	cd_centro_custo_w,
	cd_local_estoque_w,
	cd_operacao_estoque_w,
	vl_movimento_w,
	ds_local_estoque_w,
	ie_debito_credito_w,
	cd_hist_transf_w,
	ds_local_consumo_w,
	qt_consumo_w;
EXIT WHEN NOT FOUND; /* apply on c000 */
	begin
	ds_compl_historico_w	:= ds_mesano_referencia_w;
	cd_historico_w		:= cd_historico_ww;


	select	max(ds_material)
	into STRICT	ds_material_w
	from	material
	where	cd_material		= cd_material_w;
	ds_operacao_estoque_w	:= substr(obter_desc_operacao_estoque(cd_operacao_estoque_w),1,40);


	begin
	select	cd_grupo_material,
		cd_subgrupo_material,
		cd_classe_material,
		ds_grupo_material,
		ds_subgrupo_material,
		ds_classe_material
	into STRICT	cd_grupo_material_w,
		cd_subgrupo_material_w,
		cd_classe_material_w,
		ds_grupo_material_w,
		ds_subgrupo_material_w,
		ds_classe_material_w
	from	estrutura_material_v
	where	cd_material	= cd_material_w;

	cd_unidade_medida_consumo_w	:= coalesce(substr(obter_dados_material(cd_material_w, 'UMC'),1,30),'');
	exception when others then
		cd_grupo_material_w	:= null;
		cd_subgrupo_material_w	:= null;
		cd_classe_material_w	:= null;
		ds_grupo_material_w	:= null;
		ds_subgrupo_material_w	:= null;
		ds_classe_material_w	:= null;
	end;


	if (coalesce(ie_historico_evento_oper_w,'N') = 'S') then
		begin
		select	max(cd_evento)
		into STRICT	cd_evento_w
		from	operacao_estoque
		where	cd_operacao_estoque 	= cd_operacao_estoque_w;

		select	max(cd_historico)
		into STRICT	cd_historico_evento_w
		from	evento_contabil_param_estab
		where	cd_evento 		= cd_evento_w
		and	cd_tipo_lote_contabil 	= cd_tipo_lote_contabil_w
		and	cd_estabelecimento 	= cd_estabelecimento_w;

		cd_historico_w		:= coalesce(cd_historico_evento_w, cd_historico_w);
		end;
	end if;



		SELECT * FROM define_conta_material(
			cd_estabelecimento_w, cd_material_w, 2, null, 0, '0', 0, null, null, null, cd_local_estoque_w, cd_operacao_estoque_w, dt_movimento_w, cd_conta_credito_w, cd_centro_custo_w, null) INTO STRICT cd_conta_credito_w, cd_centro_custo_w;

		SELECT * FROM define_conta_material(
			cd_estabelecimento_w, cd_material_w, 3, ie_clinica_w, 0, '0', 0, null, null, null, cd_local_estoque_w, cd_operacao_estoque_w, dt_movimento_w, cd_conta_debito_w, cd_centro_custo_w, null) INTO STRICT cd_conta_debito_w, cd_centro_custo_w;

		INSERT INTO w_ctb_livro_aux_consumo(
			nr_sequencia,
			cd_material,
			dt_atualizacao,
			nm_usuario,
			cd_local_estoque,
			cd_operacao_estoque,
			vl_movimento,
			ds_local_estoque_destino,
			cd_historico,
			ds_local_estoque,
			cd_conta_debito,
			cd_conta_credito,
			qt_consumo,
			ie_debito_credito)
		values (	nextval('w_ctb_livro_aux_consumo_seq'),
			cd_material_w,
			clock_timestamp(),
			nm_usuario_p,
			cd_local_estoque_w,
			cd_operacao_estoque_w,
			vl_movimento_w,
			null,
			cd_historico_w,
			ds_local_estoque_w,
			cd_conta_debito_w,
			cd_conta_credito_w,
			qt_consumo_w,
			ie_debito_credito_w);
	end;
END LOOP;
CLOSE C000;
commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ctb_gerar_relat_aux_consumo ( nr_lote_contabil_p bigint, nm_usuario_p text, ie_exclusao_p text, ds_retorno_p INOUT text, dt_mesano_referencia_p timestamp, cd_estabelecimento_p bigint) FROM PUBLIC;

