-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE define_convenio ( nr_prescricao_p bigint, nr_sequencia_p bigint, cd_convenio_p bigint, cd_categoria_p text, qt_material_p bigint default null) AS $body$
DECLARE


qt_material_w			double precision;
qt_material_prescr_w	 	double precision;
qt_material_dif_w		double precision;
nm_usuario_w			varchar(15);
nr_seq_material_w		bigint;


BEGIN

qt_material_w := qt_material_p;
nm_usuario_w := wheb_usuario_pck.get_nm_usuario;

Select  coalesce(qt_material,0)
into STRICT	qt_material_prescr_w
from	prescr_material
where	nr_sequencia 	= nr_sequencia_p
and 	nr_prescricao	= nr_prescricao_p;

if (coalesce(qt_material_w,0) > 0 ) and (qt_material_prescr_w <> qt_material_w) then

	if (qt_material_prescr_w > 0) then

		qt_material_dif_w := (qt_material_prescr_w - qt_material_w);

		update	prescr_material
		set		qt_material 	=  qt_material_dif_w,
				qt_total_dispensar = qt_material_dif_w
		where	nr_sequencia 	=  nr_sequencia_p
		and 	nr_prescricao	=  nr_prescricao_p
		and		cd_motivo_baixa =  0;

		commit;

		select	coalesce(max(nr_sequencia),0)
		into STRICT	nr_seq_material_w
		from	prescr_material
		where	nr_prescricao	= nr_prescricao_p;

		nr_seq_material_w	:= nr_seq_material_w + 1;

		insert into prescr_material(	nr_prescricao,
										nr_sequencia,
										ie_origem_inf,
										cd_material,
										cd_unidade_medida,
										qt_dose,
										qt_unitaria,
										qt_material,
										nm_usuario,
										nm_usuario_nrec,
										dt_atualizacao,
										dt_atualizacao_nrec,
										cd_intervalo,
										ie_via_aplicacao,
										nr_agrupamento,
										NR_RECEITA,
										IE_OBJETIVO,
										CD_MEDICO,
										CD_UNIDADE_MEDIDA_DOSE,
										CD_FORNEC_CONSIGNADO,
										CD_CONVENIO,
										CD_CATEGORIA,
										DS_OBSERVACAO,
										NR_DOC_INTERNO,
										cd_motivo_baixa,
										qt_total_dispensar,
										ie_status_cirurgia)
								SELECT  nr_prescricao,
										nr_seq_material_w,
										ie_origem_inf,
										cd_material,
										cd_unidade_medida,
										qt_dose,
										qt_unitaria,
										qt_material_w,
										nm_usuario_w,
										nm_usuario_w,
										clock_timestamp(),
										clock_timestamp(),
										cd_intervalo,
										ie_via_aplicacao,
										nr_agrupamento,
										NR_RECEITA,
										IE_OBJETIVO,
										CD_MEDICO,
										CD_UNIDADE_MEDIDA_DOSE,
										CD_FORNEC_CONSIGNADO,
										cd_convenio_p,
										cd_categoria_p,
										DS_OBSERVACAO,
										NR_DOC_INTERNO,
										cd_motivo_baixa,
										qt_material_p,
										ie_status_cirurgia
								from	prescr_material
								where	nr_sequencia 	= nr_sequencia_p
								and 	nr_prescricao	= nr_prescricao_p;

		commit;

	end if;


else

	update	prescr_material
	set		cd_convenio 	= cd_convenio_p,
			cd_categoria	= cd_categoria_p
	where	nr_sequencia 	= nr_sequencia_p
	and 	nr_prescricao	= nr_prescricao_p
	and		cd_motivo_baixa = 0;

	commit;

end if;

end	;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE define_convenio ( nr_prescricao_p bigint, nr_sequencia_p bigint, cd_convenio_p bigint, cd_categoria_p text, qt_material_p bigint default null) FROM PUBLIC;

