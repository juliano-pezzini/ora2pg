-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE liberar_estornar_contagem_insp ( nr_seq_contagem_p bigint, ie_opcao_p text, cd_estabelecimento_p bigint, nm_usuario_p text) AS $body$
DECLARE


/* ie_opcao_p
L -  Liberar;
E -  Estornar;
*/
ie_consiste_qtde_lote_w			varchar(1);
ie_exige_terceira_contagem_w		varchar(1);
qt_inspecao_w				double precision;
qt_lote_w					double precision;
nr_seq_inspecao_w				bigint;
nr_seq_contagem_w			bigint;
cd_perfil_w				bigint;
qt_consistencias_w				bigint;
ie_consiste_marca_insp_w			varchar(1);
cd_material_w				integer;
nr_seq_marca_w				bigint;
ds_marca_w				varchar(255);
ds_status_marca_w				varchar(255);
ie_libera_w				varchar(1);
ie_consiste_contrato_w			funcao_param_usuario.vl_parametro%type;
ie_avaliacao_registro_w			funcao_param_usuario.vl_parametro%type;
ie_exibe_mensagem_w				varchar(1);
ds_mensagem_w					varchar(255);
qt_existe_avaliacao_w			bigint;
qt_existe_contrato_w			bigint;
cd_cnpj_w						pessoa_juridica.cd_cgc%type;
nr_seq_registro_w				inspecao_contagem.nr_seq_registro%type;

c01 CURSOR FOR
SELECT	a.cd_material,
	b.nr_seq_marca,
	substr(obter_desc_marca(b.nr_seq_marca),1,255),
	substr(obter_desc_status_aval_marca(c.nr_seq_status_aval),1,255)
from	inspecao_contagem a,
	inspecao_receb_lote_cont b,
	material_marca c
where	a.nr_sequencia = b.nr_seq_contagem
and	a.cd_material = c.cd_material
and	b.nr_seq_marca = c.nr_sequencia
and	a.nr_sequencia = nr_seq_contagem_p
and	c.nr_seq_status_aval	> 0
and	obter_tipo_status_aval_marca(c.nr_seq_status_aval) <> 'A';



BEGIN

ie_libera_w := 'S';
cd_perfil_w	:= obter_perfil_ativo;

select (max(obter_valor_param_usuario(270, 52, cd_perfil_w, nm_usuario_p, cd_estabelecimento_p))),
	(max(obter_valor_param_usuario(270, 64, cd_perfil_w, nm_usuario_p, cd_estabelecimento_p))),
	(max(obter_valor_param_usuario(270, 76, cd_perfil_w, nm_usuario_p, cd_estabelecimento_p))),
	coalesce((max(obter_valor_param_usuario(270, 63, cd_perfil_w, nm_usuario_p, cd_estabelecimento_p))),'N'),
	coalesce((max(obter_valor_param_usuario(270, 66, cd_perfil_w, nm_usuario_p, cd_estabelecimento_p))),'N')
into STRICT	ie_consiste_qtde_lote_w,
	ie_exige_terceira_contagem_w,
	ie_consiste_marca_insp_w,
	ie_consiste_contrato_w,
	ie_avaliacao_registro_w
;

select	coalesce(max(nr_seq_inspecao),0)
into STRICT	nr_seq_inspecao_w
from	inspecao_contagem
where	nr_sequencia = nr_seq_contagem_p;

select	coalesce(max(qt_inspecao),0),
	coalesce(max(nr_seq_contagem),0)
into STRICT	qt_inspecao_w,
	nr_seq_contagem_w
from	inspecao_contagem
where	nr_sequencia = nr_seq_contagem_p;

if (ie_consiste_marca_insp_w = 'S') and (nr_seq_contagem_w = 1) then
		
	open c01;
	loop
	fetch c01 into
		cd_material_w,
		nr_seq_marca_w,
		ds_marca_w,
		ds_status_marca_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
		begin
		--A marca #@DS_MARCA_W#@ do material #@CD_MATERIAL_W#@ está #@DS_STATUS_MARCA_W#@.
		CALL wheb_mensagem_pck.exibir_mensagem_abort(220470,	'DS_MARCA_W=' 		|| DS_MARCA_W 		|| ';' ||
								'CD_MATERIAL_W='	|| CD_MATERIAL_W	|| ';' ||
								'DS_STATUS_MARCA_W='	|| DS_STATUS_MARCA_W);
		
		
		end;
	end loop;
	close c01;
end if;


if (ie_opcao_p = 'L') then


	if (ie_consiste_contrato_w = 'SC')then

		select	coalesce(max(nr_seq_registro),0)
			into STRICT	nr_seq_registro_w
			from	inspecao_contagem
			where	nr_sequencia = nr_seq_contagem_p;
			
		select	coalesce(max(cd_cnpj),0)
			into STRICT	cd_cnpj_w
			from	inspecao_registro
			where	nr_sequencia = nr_seq_registro_w;
		
		if (ie_avaliacao_registro_w  = 'S') then
			select	count(*)
				into STRICT	qt_existe_avaliacao_w
				from 	avf_resultado
				where 	nr_seq_registro = nr_seq_registro_w
				and 	(dt_aprovacao IS NOT NULL AND dt_aprovacao::text <> '');
		else
			select	count(*)
				into STRICT	qt_existe_avaliacao_w
				from 	avf_resultado
				where 	cd_cnpj = cd_cnpj_w
				and		(dt_aprovacao IS NOT NULL AND dt_aprovacao::text <> '') 
				and 	coalesce(ie_avaliado, 'F') = 'F';
		end if;
		
		select	count(*)
			into STRICT	qt_existe_contrato_w
			from	inspecao_recebimento a
			where	a.nr_sequencia = nr_seq_inspecao_w
			and	    (nr_seq_contrato IS NOT NULL AND nr_seq_contrato::text <> '');
				
	
		if (qt_existe_contrato_w > 0) and (qt_existe_avaliacao_w = 0) then
			ie_libera_w := 'N';
			ie_exibe_mensagem_w := 'S';
		end if;
	
	end if;
	
	if (ie_exige_terceira_contagem_w = 'N') and (nr_seq_contagem_w = 2) then
				
		select	count(*)
		into STRICT	qt_consistencias_w
		from	insp_contagem_consiste
		where	nr_seq_inspecao = nr_seq_inspecao_w
		and	nm_usuario_contagem = nm_usuario_p;
		
		if (qt_consistencias_w = 0) then
			delete from inspecao_contagem
			where	nr_seq_inspecao = nr_seq_inspecao_w
			and	nr_seq_contagem = 3;
		end if;
	end if;
	
	if (qt_inspecao_w > 0) then
		
		select	coalesce(sum(qt_material),0)
		into STRICT	qt_lote_w
		from	inspecao_receb_lote_cont
		where	nr_seq_contagem = nr_seq_contagem_p;
		
		if (qt_lote_w > 0) and (qt_lote_w <> qt_inspecao_w) then
			/*'A quantidade da contagem é diferente da soma das quantidades do lote.'*/

			CALL wheb_mensagem_pck.exibir_mensagem_abort(197749);
		end if;
	end if;
end if;

if (ie_opcao_p = 'E') and (nr_seq_inspecao_w > 0) then
	
	delete from insp_contagem_consiste
	where nr_Seq_inspecao = nr_seq_inspecao_w;
	
	delete from inspecao_contagem
	where	nr_seq_inspecao = nr_seq_inspecao_w
	and	nr_seq_contagem = 3;
	
end if;

if (coalesce(ie_libera_w,'N') = 'S')   then
	update	inspecao_contagem
	set	dt_liberacao = clock_timestamp(),
		nm_usuario_lib = nm_usuario_p
	where	nr_sequencia = nr_seq_contagem_p
	and	ie_opcao_p = 'L';

end if;
update	inspecao_contagem
set	dt_liberacao  = NULL,
	nm_usuario_lib  = NULL
where	nr_sequencia = nr_seq_contagem_p
and	ie_opcao_p = 'E';

commit;

if (coalesce(ie_exibe_mensagem_w,'N') = 'S') then
	ds_mensagem_w := substr(wheb_mensagem_pck.get_texto(236458),1,255);
	CALL wheb_mensagem_pck.exibir_mensagem_abort(ds_mensagem_w);
end if;


end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE liberar_estornar_contagem_insp ( nr_seq_contagem_p bigint, ie_opcao_p text, cd_estabelecimento_p bigint, nm_usuario_p text) FROM PUBLIC;

