-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE duplicar_indicador_gestao (nr_seq_origem_p bigint, nr_seq_destino_p bigint, nm_usuario_p text) AS $body$
DECLARE


    nr_seq_wheb_w               bigint;
    qt_registros_w              bigint;
    nr_seq_subindicador_w       bigint;
    nr_seq_subindicador_copia_w bigint;
    nr_seq_origem_w             bigint;

    c01 CURSOR FOR
        SELECT nr_sequencia from subindicador_gestao where nr_seq_indicador = nr_seq_origem_w;

    c02 CURSOR FOR
        SELECT nr_sequencia from subindicador_gestao where nr_seq_indicador = nr_seq_destino_p;


BEGIN
    select max(nr_seq_wheb) into STRICT nr_seq_wheb_w from indicador_gestao where nr_sequencia = nr_seq_destino_p;

    if (coalesce(nr_seq_origem_p::text, '') = '') then
        select max(nr_seq_indicador_gestao) into STRICT nr_seq_origem_w from indicador_gestao_copia where nm_usuario = nm_usuario_p;
    else
        nr_seq_origem_w := nr_seq_origem_p;
    end if;

    if (nr_seq_wheb_w > 0) then
        CALL wheb_mensagem_pck.exibir_mensagem_abort(281538);
    end if;

    if (nr_seq_origem_w > 0 AND nr_seq_destino_p > 0) then

        insert into indicador_gestao_atrib(nr_sequencia,
             nr_seq_ind_gestao,
             nm_atributo,
             dt_atualizacao,
             nm_usuario,
             ds_dimensao,
             nr_seq_dim,
             ds_informacao,
             nr_seq_inf,
             ds_filtro,
             ds_data,
             ie_data,
             nr_seq_data,
             ds_grid,
             nr_seq_grid,
             qt_tamanho_grid,
             ds_mascara_grid,
             nm_atributo_drill,
             ie_classificacao_ordem,
             ie_tipo_ordem_classif,
             ie_mostra_nulo,
             ds_sql_where,
             ds_filtro_padrao,
             nm_tabela_referencia,
             nm_atributo_referencia,
             ie_formato_tot_linha,
             ie_divisor,
             ie_dividendo,
             cd_exp_dimensao,
             cd_exp_grid,
             cd_exp_data,
             cd_exp_informacao)
            SELECT nextval('indicador_gestao_atrib_seq'),
                   nr_seq_destino_p,
                   nm_atributo,
                   dt_atualizacao,
                   'Teste_Copia_ind',
                   ds_dimensao,
                   nr_seq_dim,
                   ds_informacao,
                   nr_seq_inf,
                   ds_filtro,
                   ds_data,
                   ie_data,
                   nr_seq_data,
                   ds_grid,
                   nr_seq_grid,
                   qt_tamanho_grid,
                   ds_mascara_grid,
                   nm_atributo_drill,
                   ie_classificacao_ordem,
                   ie_tipo_ordem_classif,
                   ie_mostra_nulo,
                   ds_sql_where,
                   ds_filtro_padrao,
                   nm_tabela_referencia,
                   nm_atributo_referencia,
                   ie_formato_tot_linha,
                   ie_divisor,
                   ie_dividendo,
                   cd_exp_dimensao,
                   cd_exp_grid,
                   cd_exp_data,
                   cd_exp_informacao
              from indicador_gestao_atrib
             where nr_seq_ind_gestao = nr_seq_origem_w;
        commit;

        -- DUPLICAR OS REGISTROS RELATIVOS AOS SUBINDICADORES
        select count(*) into STRICT qt_registros_w from subindicador_gestao where nr_seq_indicador = nr_seq_origem_w;

        if (qt_registros_w > 0) then
        
            open c01;
            loop
                fetch c01
                    into nr_seq_subindicador_w;
                EXIT WHEN NOT FOUND; /* apply on c01 */
                begin

                    select nextval('subindicador_gestao_seq') into STRICT nr_seq_subindicador_copia_w;

                    insert into subindicador_gestao(nr_sequencia,
                         nr_seq_indicador,
                         ds_subindicador,
                         dt_atualizacao,
                         nm_usuario,
                         ds_sql,
                         nr_seq_apresent,
                         nr_seq_superior,
                         qt_tamanho,
                         ie_ativa_entrada,
                         ie_filho_grid_grafico,
                         nr_seq_wheb,
                         dt_atualizacao_nrec,
                         nm_usuario_nrec,
                         cd_exp_subindicador)
                        SELECT nr_seq_subindicador_copia_w,
                               nr_seq_destino_p,
                               ds_subindicador,
                               dt_atualizacao,
                               nm_usuario,
                               ds_sql,
                               nr_seq_apresent,
                               nr_seq_superior,
                               qt_tamanho,
                               ie_ativa_entrada,
                               ie_filho_grid_grafico,
                               nr_seq_wheb,
                               dt_atualizacao_nrec,
                               nm_usuario_nrec,
                               cd_exp_subindicador
                          from subindicador_gestao
                         where nr_sequencia = nr_seq_subindicador_w;

                    commit;

                    select count(*)
                      into STRICT qt_registros_w
                      from subindicador_gestao_atrib
                     where nr_seq_subindicador = nr_seq_subindicador_w;

                    if (qt_registros_w > 0) then
                    
                        insert into subindicador_gestao_atrib(nr_sequencia,
                             nr_seq_subindicador,
                             nm_atributo,
                             dt_atualizacao,
                             nm_usuario,
                             ie_tipo_filtro,
                             ds_filtro,
                             nr_seq_filtro,
                             ds_grid,
                             ds_mascara_grid,
                             nr_seq_grid,
                             qt_tamanho_grid,
                             qt_tamanho_filtro,
                             qt_esquerda_filtro,
                             qt_largura_filtro,
                             qt_coluna_filtro,
                             ds_cor_fonte_grid,
                             ds_cor_fundo_grid,
                             ds_estilo_fonte_grid,
                             ds_filtro_padrao,
                             ie_forma_passagem_filtro,
                             dt_atualizacao_nrec,
                             nm_usuario_nrec,
                             cd_exp_grid)
                            SELECT nextval('subindicador_gestao_atrib_seq'),
                                   nr_seq_subindicador_copia_w,
                                   nm_atributo,
                                   dt_atualizacao,
                                   nm_usuario,
                                   ie_tipo_filtro,
                                   ds_filtro,
                                   nr_seq_filtro,
                                   ds_grid,
                                   ds_mascara_grid,
                                   nr_seq_grid,
                                   qt_tamanho_grid,
                                   qt_tamanho_filtro,
                                   qt_esquerda_filtro,
                                   qt_largura_filtro,
                                   qt_coluna_filtro,
                                   ds_cor_fonte_grid,
                                   ds_cor_fundo_grid,
                                   ds_estilo_fonte_grid,
                                   ds_filtro_padrao,
                                   ie_forma_passagem_filtro,
                                   dt_atualizacao_nrec,
                                   nm_usuario_nrec,
                                   cd_exp_grid
                              from subindicador_gestao_atrib
                             where nr_seq_subindicador = nr_seq_subindicador_w;
                        commit;
                    end if;
                end;
            end loop;
            close c01;

        end if;
    end if;

    commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE duplicar_indicador_gestao (nr_seq_origem_p bigint, nr_seq_destino_p bigint, nm_usuario_p text) FROM PUBLIC;

