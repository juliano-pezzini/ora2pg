-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE baca_chave_pix () AS $body$
DECLARE


c_chaves_pf CURSOR FOR
SELECT a.ds_chave_pix,
       a.ie_tipo_chave_pix,
       a.cd_pessoa_fisica,
       a.cd_banco,
       a.cd_agencia_bancaria,
       a.nr_conta,
       a.nm_usuario
from   pessoa_fisica_conta a
where  (a.ds_chave_pix IS NOT NULL AND a.ds_chave_pix::text <> '')
and    (a.ie_tipo_chave_pix IS NOT NULL AND a.ie_tipo_chave_pix::text <> '');

c_chaves_pj CURSOR FOR
SELECT a.ds_chave_pix,
       a.ie_tipo_chave_pix,
       a.cd_cgc,
       a.cd_banco,
       a.cd_agencia_bancaria,
       a.nr_conta,
       a.nm_usuario
from   pessoa_juridica_conta a
where  (a.ds_chave_pix IS NOT NULL AND a.ds_chave_pix::text <> '')
and    (a.ie_tipo_chave_pix IS NOT NULL AND a.ie_tipo_chave_pix::text <> '');
BEGIN

    for chave_w in c_chaves_pf
    loop
        begin
        insert into
        PESSOA_FIS_CONTA_PIX(
            NR_SEQUENCIA,
            DT_ATUALIZACAO,
            NM_USUARIO,
            DT_ATUALIZACAO_NREC,
            NM_USUARIO_NREC,
            CD_PESSOA_FISICA,
            CD_BANCO,
            CD_AGENCIA_BANCARIA,
            NR_CONTA,
            DS_CHAVE,
            IE_TIPO_CHAVE,
            IE_PREFERENCIAL)
        values (
            nextval('pessoa_fis_conta_pix_seq'),
            clock_timestamp(),
            chave_w.NM_USUARIO,
            clock_timestamp(),
            chave_w.NM_USUARIO,
            chave_w.CD_PESSOA_FISICA,
            chave_w.CD_BANCO,
            chave_w.CD_AGENCIA_BANCARIA,
            chave_w.NR_CONTA,
            chave_w.DS_CHAVE_PIX,
            chave_w.IE_TIPO_CHAVE_PIX,
            'S');
        exception
        when others then
            null;
        end;
    end loop;

    for chave_w in c_chaves_pj
    loop
        begin
        insert into
        PESSOA_JUR_CONTA_PIX(
            NR_SEQUENCIA,
            DT_ATUALIZACAO,
            NM_USUARIO,
            DT_ATUALIZACAO_NREC,
            NM_USUARIO_NREC,
            CD_CGC,
            CD_BANCO,
            CD_AGENCIA_BANCARIA,
            NR_CONTA,
            DS_CHAVE,
            IE_TIPO_CHAVE,
            IE_PREFERENCIAL)
        values (
            nextval('pessoa_jur_conta_pix_seq'),
            clock_timestamp(),
            chave_w.NM_USUARIO,
            clock_timestamp(),
            chave_w.NM_USUARIO,
            chave_w.CD_CGC,
            chave_w.CD_BANCO,
            chave_w.CD_AGENCIA_BANCARIA,
            chave_w.NR_CONTA,
            chave_w.DS_CHAVE_PIX,
            chave_w.IE_TIPO_CHAVE_PIX,
            'S');
        exception
        when others then
            null;
        end;
    end loop;

    update pessoa_fisica_conta a
    set    a.ds_chave_pix  = NULL,
           a.ie_tipo_chave_pix  = NULL
    where  (a.ds_chave_pix IS NOT NULL AND a.ds_chave_pix::text <> '')
    and    (a.ie_tipo_chave_pix IS NOT NULL AND a.ie_tipo_chave_pix::text <> '')
    and exists (SELECT 1
                from   pessoa_fis_conta_pix b
                where  b.CD_PESSOA_FISICA = a.CD_PESSOA_FISICA
                and    b.CD_BANCO = a.CD_BANCO
                and    b.CD_AGENCIA_BANCARIA = a.CD_AGENCIA_BANCARIA
                and    b.NR_CONTA = a.NR_CONTA
                and    b.DS_CHAVE = a.DS_CHAVE_PIX
                and    b.IE_TIPO_CHAVE = a.IE_TIPO_CHAVE_PIX);

    update pessoa_juridica_conta a
    set    a.ds_chave_pix  = NULL,
           a.ie_tipo_chave_pix  = NULL
    where  (a.ds_chave_pix IS NOT NULL AND a.ds_chave_pix::text <> '')
    and    (a.ie_tipo_chave_pix IS NOT NULL AND a.ie_tipo_chave_pix::text <> '')
    and exists (SELECT 1
                from   pessoa_jur_conta_pix b
                where  b.CD_CGC = a.CD_CGC
                and    b.CD_BANCO = a.CD_BANCO
                and    b.CD_AGENCIA_BANCARIA = a.CD_AGENCIA_BANCARIA
                and    b.NR_CONTA = a.NR_CONTA
                and    b.DS_CHAVE = a.DS_CHAVE_PIX
                and    b.IE_TIPO_CHAVE = a.IE_TIPO_CHAVE_PIX);

    commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE baca_chave_pix () FROM PUBLIC;

