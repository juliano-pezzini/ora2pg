-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE ctb_gerar_planej_contrato ( nr_seq_planej_p ctb_orc_cenario.nr_sequencia%type, nm_usuario_p text) AS $body$
DECLARE


type v_ctb_planej_orc_material is table of ctb_planej_orc_material%rowtype index by integer;
type v_table_number is table of bigint;

vet_ctb_planej_orc_material_w    v_ctb_planej_orc_material;
ctb_orc_cenario_w                ctb_orc_cenario%rowtype;
dt_inicial_w                     ctb_mes_ref.dt_referencia%type;
dt_final_w                       ctb_mes_ref.dt_referencia%type;
dt_inicio_ww                     timestamp;
mes_w                            smallint;
vl_planej_w                      v_table_number;
qt_planej_w                      v_table_number;
count_w                          bigint;
vl_contrato_w                    ctb_planej_orc_valor.vl_planej_01%type;

c_contrato CURSOR FOR
SELECT a.nr_sequencia,
       a.cd_cgc_contratado,
       a.cd_estabelecimento,
       coalesce(b.dt_inicio_vigencia,a.dt_inicio) dt_inicio,
       coalesce(b.dt_fim_vigencia,a.dt_fim) dt_fim,
       b.cd_material,
       b.cd_conta_contabil,
       b.cd_centro_custo,
       b.nr_seq_crit_rateio,
       b.qt_material_fixa,
       b.vl_pagto
from   contrato          a,
       contrato_regra_nf b
where  a.nr_sequencia = b.nr_seq_contrato
and (coalesce(b.cd_centro_custo, 0) <> 0 or coalesce(b.nr_seq_crit_rateio, 0) <> 0)
and    ((coalesce(b.dt_inicio_vigencia, a.dt_inicio) between dt_inicial_w and dt_final_w or coalesce(b.dt_fim_vigencia,a.dt_fim) between dt_inicial_w and dt_final_w)
       or (coalesce(b.dt_inicio_vigencia,a.dt_inicio) < dt_inicial_w and coalesce(b.dt_fim_vigencia,a.dt_fim) > dt_final_w))
and    obter_empresa_estab(a.cd_estabelecimento) = ctb_orc_cenario_w.cd_empresa
and    a.cd_estabelecimento = coalesce(ctb_orc_cenario_w.cd_estab_exclusivo, a.cd_estabelecimento)
and    a.ie_situacao = 'A'
and (coalesce(b.ie_situacao::text, '') = '' or b.ie_situacao = 'A');

c_contrato_w c_contrato%rowtype;

c_criterio_rateio CURSOR FOR
SELECT a.cd_centro_custo,
       coalesce(a.cd_conta_contabil,c_contrato_w.cd_conta_contabil) cd_conta_contabil,
       a.pr_rateio
from   ctb_criterio_rateio_item a
where  a.nr_seq_criterio  = c_contrato_w.nr_seq_crit_rateio
and    obter_se_periodo_vigente(a.dt_inicio_vigencia, a.dt_fim_vigencia, dt_inicial_w) = 'S'
and    coalesce(a.cd_centro_custo,0) <> 0;

BEGIN

/*Buscar dados do planejamento */

select  a.*
into STRICT    ctb_orc_cenario_w
from    ctb_orc_cenario a
where   a.nr_sequencia  = nr_seq_planej_p;

/*Definir o periodo para buscar os materiais e consumo */

dt_inicial_w  := ctb_obter_mes_ref(ctb_orc_cenario_w.nr_seq_mes_inicio);
dt_final_w    := last_day(ctb_obter_mes_ref(ctb_orc_cenario_w.nr_seq_mes_fim));

count_w := 0;

delete FROM ctb_planej_orc_material
where  nr_seq_planej = nr_seq_planej_p
and    (nr_seq_contrato IS NOT NULL AND nr_seq_contrato::text <> '');
commit;

open c_contrato;
loop
  fetch c_contrato into
   c_contrato_w;
EXIT WHEN NOT FOUND; /* apply on c_contrato */
    begin
      vl_planej_w := v_table_number(0,0,0,0,0,0,0,0,0,0,0,0);
      qt_planej_w := v_table_number(0,0,0,0,0,0,0,0,0,0,0,0);

      vl_contrato_w     := c_contrato_w.vl_pagto * coalesce(c_contrato_w.qt_material_fixa,1);
      dt_inicio_ww      := c_contrato_w.dt_inicio;

      while(dt_inicio_ww <= dt_final_w and dt_inicio_ww <= c_contrato_w.dt_fim) loop
        begin
          if (dt_inicio_ww between dt_inicial_w and dt_final_w) then
            mes_w                  := (to_char(dt_inicio_ww, 'MM'))::numeric;
            vl_planej_w(mes_w)     := vl_contrato_w;
            qt_planej_w(mes_w)     := coalesce(c_contrato_w.qt_material_fixa,1);
          end if;
          dt_inicio_ww := add_months(dt_inicio_ww, 1);
        end;
      end loop;

      if (coalesce(c_contrato_w.nr_seq_crit_rateio::text, '') = '') and (c_contrato_w.cd_centro_custo <> 0) and (c_contrato_w.cd_conta_contabil != '0') then
                begin
                count_w := count_w + 1;

                select  nextval('ctb_planej_orc_material_seq')
                into STRICT    vet_ctb_planej_orc_material_w[count_w].nr_sequencia
;

                vet_ctb_planej_orc_material_w[count_w].cd_estabelecimento   := c_contrato_w.cd_estabelecimento;
                vet_ctb_planej_orc_material_w[count_w].cd_conta_financ      := ctb_obter_conta_fin(c_contrato_w.cd_conta_contabil, null, dt_inicial_w);
                vet_ctb_planej_orc_material_w[count_w].cd_material          := c_contrato_w.cd_material;
                vet_ctb_planej_orc_material_w[count_w].dt_atualizacao       := clock_timestamp();
                vet_ctb_planej_orc_material_w[count_w].nm_usuario           := nm_usuario_p;
                vet_ctb_planej_orc_material_w[count_w].dt_atualizacao_nrec  := clock_timestamp();
                vet_ctb_planej_orc_material_w[count_w].nm_usuario_nrec      := nm_usuario_p;
                vet_ctb_planej_orc_material_w[count_w].nr_seq_planej        := nr_seq_planej_p;
                vet_ctb_planej_orc_material_w[count_w].nr_seq_contrato      := c_contrato_w.nr_sequencia;
                vet_ctb_planej_orc_material_w[count_w].nr_seq_proj_gpi      := null;
                vet_ctb_planej_orc_material_w[count_w].cd_cnpj              := c_contrato_w.cd_cgc_contratado;
                vet_ctb_planej_orc_material_w[count_w].cd_centro_custo      := c_contrato_w.cd_centro_custo;
                vet_ctb_planej_orc_material_w[count_w].cd_conta_contabil    := c_contrato_w.cd_conta_contabil;

                vet_ctb_planej_orc_material_w[count_w].qt_planej_01         := qt_planej_w(1);
                vet_ctb_planej_orc_material_w[count_w].qt_planej_02         := qt_planej_w(2);
                vet_ctb_planej_orc_material_w[count_w].qt_planej_03         := qt_planej_w(3);
                vet_ctb_planej_orc_material_w[count_w].qt_planej_04         := qt_planej_w(4);
                vet_ctb_planej_orc_material_w[count_w].qt_planej_05         := qt_planej_w(5);
                vet_ctb_planej_orc_material_w[count_w].qt_planej_06         := qt_planej_w(6);
                vet_ctb_planej_orc_material_w[count_w].qt_planej_07         := qt_planej_w(7);
                vet_ctb_planej_orc_material_w[count_w].qt_planej_08         := qt_planej_w(8);
                vet_ctb_planej_orc_material_w[count_w].qt_planej_09         := qt_planej_w(9);
                vet_ctb_planej_orc_material_w[count_w].qt_planej_10         := qt_planej_w(10);
                vet_ctb_planej_orc_material_w[count_w].qt_planej_11         := qt_planej_w(11);
                vet_ctb_planej_orc_material_w[count_w].qt_planej_12         := qt_planej_w(12);

                vet_ctb_planej_orc_material_w[count_w].vl_planej_01         := vl_planej_w(1);
                vet_ctb_planej_orc_material_w[count_w].vl_planej_02         := vl_planej_w(2);
                vet_ctb_planej_orc_material_w[count_w].vl_planej_03         := vl_planej_w(3);
                vet_ctb_planej_orc_material_w[count_w].vl_planej_04         := vl_planej_w(4);
                vet_ctb_planej_orc_material_w[count_w].vl_planej_05         := vl_planej_w(5);
                vet_ctb_planej_orc_material_w[count_w].vl_planej_06         := vl_planej_w(6);
                vet_ctb_planej_orc_material_w[count_w].vl_planej_07         := vl_planej_w(7);
                vet_ctb_planej_orc_material_w[count_w].vl_planej_08         := vl_planej_w(8);
                vet_ctb_planej_orc_material_w[count_w].vl_planej_09         := vl_planej_w(9);
                vet_ctb_planej_orc_material_w[count_w].vl_planej_10         := vl_planej_w(10);
                vet_ctb_planej_orc_material_w[count_w].vl_planej_11         := vl_planej_w(11);
                vet_ctb_planej_orc_material_w[count_w].vl_planej_12         := vl_planej_w(12);
        end;
     elsif (coalesce(c_contrato_w.nr_seq_crit_rateio,0) <> 0) then
       begin
           for c_criterio_rateio_w in c_criterio_rateio loop
             begin
                count_w := count_w + 1;

                select  nextval('ctb_planej_orc_material_seq')
                into STRICT    vet_ctb_planej_orc_material_w[count_w].nr_sequencia
;

                vet_ctb_planej_orc_material_w[count_w].cd_estabelecimento   := c_contrato_w.cd_estabelecimento;
                vet_ctb_planej_orc_material_w[count_w].cd_conta_financ      := ctb_obter_conta_fin(c_contrato_w.cd_conta_contabil, null, dt_inicial_w);
                vet_ctb_planej_orc_material_w[count_w].cd_material          := c_contrato_w.cd_material;
                vet_ctb_planej_orc_material_w[count_w].dt_atualizacao       := clock_timestamp();
                vet_ctb_planej_orc_material_w[count_w].nm_usuario           := nm_usuario_p;
                vet_ctb_planej_orc_material_w[count_w].dt_atualizacao_nrec  := clock_timestamp();
                vet_ctb_planej_orc_material_w[count_w].nm_usuario_nrec      := nm_usuario_p;
                vet_ctb_planej_orc_material_w[count_w].nr_seq_planej        := nr_seq_planej_p;
                vet_ctb_planej_orc_material_w[count_w].nr_seq_contrato      := c_contrato_w.nr_sequencia;
                vet_ctb_planej_orc_material_w[count_w].nr_seq_proj_gpi      := null;
                vet_ctb_planej_orc_material_w[count_w].cd_cnpj              := c_contrato_w.cd_cgc_contratado;
                vet_ctb_planej_orc_material_w[count_w].cd_centro_custo      := c_criterio_rateio_w.cd_centro_custo;
                vet_ctb_planej_orc_material_w[count_w].cd_conta_contabil    := c_criterio_rateio_w.cd_conta_contabil;
                vet_ctb_planej_orc_material_w[count_w].qt_planej_01         := c_criterio_rateio_w.pr_rateio/100 * qt_planej_w(1);
                vet_ctb_planej_orc_material_w[count_w].qt_planej_02         := c_criterio_rateio_w.pr_rateio/100 * qt_planej_w(2);
                vet_ctb_planej_orc_material_w[count_w].qt_planej_03         := c_criterio_rateio_w.pr_rateio/100 * qt_planej_w(3);
                vet_ctb_planej_orc_material_w[count_w].qt_planej_04         := c_criterio_rateio_w.pr_rateio/100 * qt_planej_w(4);
                vet_ctb_planej_orc_material_w[count_w].qt_planej_05         := c_criterio_rateio_w.pr_rateio/100 * qt_planej_w(5);
                vet_ctb_planej_orc_material_w[count_w].qt_planej_06         := c_criterio_rateio_w.pr_rateio/100 * qt_planej_w(6);
                vet_ctb_planej_orc_material_w[count_w].qt_planej_07         := c_criterio_rateio_w.pr_rateio/100 * qt_planej_w(7);
                vet_ctb_planej_orc_material_w[count_w].qt_planej_08         := c_criterio_rateio_w.pr_rateio/100 * qt_planej_w(8);
                vet_ctb_planej_orc_material_w[count_w].qt_planej_09         := c_criterio_rateio_w.pr_rateio/100 * qt_planej_w(9);
                vet_ctb_planej_orc_material_w[count_w].qt_planej_10         := c_criterio_rateio_w.pr_rateio/100 * qt_planej_w(10);
                vet_ctb_planej_orc_material_w[count_w].qt_planej_11         := c_criterio_rateio_w.pr_rateio/100 * qt_planej_w(11);
                vet_ctb_planej_orc_material_w[count_w].qt_planej_12         := c_criterio_rateio_w.pr_rateio/100 * qt_planej_w(12);

                vet_ctb_planej_orc_material_w[count_w].vl_planej_01         := c_criterio_rateio_w.pr_rateio/100 * vl_planej_w(1);
                vet_ctb_planej_orc_material_w[count_w].vl_planej_02         := c_criterio_rateio_w.pr_rateio/100 * vl_planej_w(2);
                vet_ctb_planej_orc_material_w[count_w].vl_planej_03         := c_criterio_rateio_w.pr_rateio/100 * vl_planej_w(3);
                vet_ctb_planej_orc_material_w[count_w].vl_planej_04         := c_criterio_rateio_w.pr_rateio/100 * vl_planej_w(4);
                vet_ctb_planej_orc_material_w[count_w].vl_planej_05         := c_criterio_rateio_w.pr_rateio/100 * vl_planej_w(5);
                vet_ctb_planej_orc_material_w[count_w].vl_planej_06         := c_criterio_rateio_w.pr_rateio/100 * vl_planej_w(6);
                vet_ctb_planej_orc_material_w[count_w].vl_planej_07         := c_criterio_rateio_w.pr_rateio/100 * vl_planej_w(7);
                vet_ctb_planej_orc_material_w[count_w].vl_planej_08         := c_criterio_rateio_w.pr_rateio/100 * vl_planej_w(8);
                vet_ctb_planej_orc_material_w[count_w].vl_planej_09         := c_criterio_rateio_w.pr_rateio/100 * vl_planej_w(9);
                vet_ctb_planej_orc_material_w[count_w].vl_planej_10         := c_criterio_rateio_w.pr_rateio/100 * vl_planej_w(10);
                vet_ctb_planej_orc_material_w[count_w].vl_planej_11         := c_criterio_rateio_w.pr_rateio/100 * vl_planej_w(11);
                vet_ctb_planej_orc_material_w[count_w].vl_planej_12         := c_criterio_rateio_w.pr_rateio/100 * vl_planej_w(12);
             end;
           end loop;
       end;
     end if;

    if (count_w >= 1000) then
        forall i in vet_ctb_planej_orc_material_w.first .. vet_ctb_planej_orc_material_w.last
            insert into ctb_planej_orc_material values vet_ctb_planej_orc_material_w(i);
            count_w := 0;
            vet_ctb_planej_orc_material_w.delete;
            commit;
    end if;
   end;
end Loop;
close c_contrato;

if (vet_ctb_planej_orc_material_w.count > 0) then
    begin
    forall i in vet_ctb_planej_orc_material_w.first .. vet_ctb_planej_orc_material_w.last
        insert into ctb_planej_orc_material values vet_ctb_planej_orc_material_w(i);
        vet_ctb_planej_orc_material_w.delete;
        commit;
    end;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ctb_gerar_planej_contrato ( nr_seq_planej_p ctb_orc_cenario.nr_sequencia%type, nm_usuario_p text) FROM PUBLIC;

