-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE inserir_bomba_infusao ( nr_seq_equipamento_p bigint, ie_status_p text, ie_ativo_p text, nm_usuario_p text, nr_prescricao_p bigint, nr_atendimento_p bigint, nr_seq_equipamento_channel_p bigint default null, nr_seq_solucao_p bigint default null, flag_gera_evento_p text  DEFAULT NULL) AS $body$
DECLARE


ie_pump_current_status_w		bomba_infusao.ie_ativo%type;
nr_seq_mat_cpoe_v               prescr_material.nr_seq_mat_cpoe%type;
nr_seq_bomba_infusao_v          bomba_infusao.nr_sequencia%type;
nr_seq_prescr_solucao_evento_v  bigint := null;


BEGIN

if (coalesce(nr_seq_equipamento_p, 0) > 0) then

    select case when count(1) > 0 then 'S' else 'N' end QTD
      into STRICT ie_pump_current_status_w
      from bomba_infusao_uso bu
     where bu.NR_SEQ_EQUPAMENTO = nr_seq_equipamento_p
       and coalesce(bu.NR_SEQ_EQUIPAMENTO_BOMBA, 0) = coalesce(nr_seq_equipamento_channel_p, 0);
		
	if (ie_pump_current_status_w = 'N') then
     select coalesce(max(x.nr_seq_mat_cpoe), 0)
       into STRICT nr_seq_mat_cpoe_v
       from prescr_material x, prescr_mat_hor a
      where x.nr_prescricao = a.nr_prescricao
        and x.nr_sequencia = a.nr_seq_material
        and a.nr_prescricao = nr_prescricao_p
        and a.nr_seq_solucao = nr_seq_solucao_p;

        
      select nextval('bomba_infusao_seq')
		into STRICT nr_seq_bomba_infusao_v
		;

		insert into bomba_infusao(
			nr_sequencia,
			nr_seq_equipamento,
			ie_status,
			ie_ativo,
			dt_bomba_infusao,
			nm_usuario,
			nr_prescricao,
			nr_atendimento,
			nr_seq_canal_bomba,
            nr_seq_mat_cpoe
		) values (nr_seq_bomba_infusao_v,
			nr_seq_equipamento_p,
			ie_status_p,
			ie_ativo_p,
			clock_timestamp(),
			nm_usuario_p,
			nr_prescricao_p,
			nr_atendimento_p,
			(nr_seq_equipamento_channel_p)::numeric ,
            nr_seq_mat_cpoe_v
		);

        
        insert into bomba_infusao_uso(
            nr_sequencia,
            nr_seq_equpamento,
            nr_seq_bomba_infusao,
            nr_seq_equipamento_bomba,
            nr_atendimento
        ) values (nextval('bomba_infusao_uso_seq'),
            nr_seq_equipamento_p,
            nr_seq_bomba_infusao_v,
            (nr_seq_equipamento_channel_p)::numeric ,
            nr_atendimento_p
        );		

		CALL inserir_hist_bomba_infusao(	nr_sequencia_p      => nr_seq_equipamento_p,
							nm_usuario_p        => nm_usuario_p,
							ie_tipo_historico_p => 'AS',
							ie_commit           => 'N',
							nr_seq_canal_bomba_p => nr_seq_equipamento_channel_p);
		
--             begin
--     if (flag_gera_evento_p = 'S') then
--     begin
--     select pe.nr_sequencia
--       into nr_seq_prescr_solucao_evento_v
--       from prescr_solucao_evento pe
--      where pe.nr_prescricao = nr_prescricao_p;
--      exception
--            when no_data_found then 
--            nr_seq_prescr_solucao_evento_v := null;
--       end;
--       
--       if (nr_seq_prescr_solucao_evento_v is not null) then
--        
--            insert into bomba_infusao_evento(
--                nr_sequencia,
--                nr_seq_prescr_solucao_evento,
--                nr_seq_bomba_infusao
--            ) values(BOMBA_INFUSAO_EVENTO_SEQ.nextval,
--                nr_seq_prescr_solucao_evento_v,
--                nr_seq_bomba_infusao_v
--            );
--        end if;
--        end if;
--        end;
		
	else
		CALL wheb_mensagem_pck.exibir_mensagem_abort(1119224);
	end if;

end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE inserir_bomba_infusao ( nr_seq_equipamento_p bigint, ie_status_p text, ie_ativo_p text, nm_usuario_p text, nr_prescricao_p bigint, nr_atendimento_p bigint, nr_seq_equipamento_channel_p bigint default null, nr_seq_solucao_p bigint default null, flag_gera_evento_p text  DEFAULT NULL) FROM PUBLIC;

