-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE add_reg_program_prs_cts ( nr_seq_reg_program_p reg_program_prs_cts.nr_seq_reg_program%type, nr_product_requirement_p reg_caso_teste.nr_seq_product%type, nm_usuario_p reg_caso_teste.nm_usuario%type ) AS $body$
BEGIN
	if (nr_seq_reg_program_p IS NOT NULL AND nr_seq_reg_program_p::text <> '' AND nr_product_requirement_p IS NOT NULL AND nr_product_requirement_p::text <> '') then
		insert into reg_program_prs_cts(
			nr_sequencia,
			dt_atualizacao,
			nm_usuario,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			nr_seq_reg_program,
			nr_seq_caso_teste,
			ie_situacao )
		SELECT 	nextval('reg_program_prs_cts_seq'),
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			nr_seq_reg_program_p,
			a.nr_sequencia,
			'A'
		from 	reg_caso_teste a
		where 	a.nr_seq_product 		= nr_product_requirement_p
		and 	coalesce(a.ie_situacao, 'A') 	= 'A'
		and 	(a.dt_aprovacao IS NOT NULL AND a.dt_aprovacao::text <> '')
		and 	(a.dt_liberacao_vv IS NOT NULL AND a.dt_liberacao_vv::text <> '')
		and 	coalesce(a.dt_inativacao::text, '') = ''
		and 	not exists (
					SELECT 	1
					from 	reg_program_prs_cts b
					where 	b.nr_seq_reg_program 	= nr_seq_reg_program_p
					and 	b.nr_seq_caso_teste 	= a.nr_sequencia
					and     b.ie_situacao = 'A'
			);
		
		commit;
	end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE add_reg_program_prs_cts ( nr_seq_reg_program_p reg_program_prs_cts.nr_seq_reg_program%type, nr_product_requirement_p reg_caso_teste.nr_seq_product%type, nm_usuario_p reg_caso_teste.nm_usuario%type ) FROM PUBLIC;

