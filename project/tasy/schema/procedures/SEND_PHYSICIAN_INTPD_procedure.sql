-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';



--
-- dblink wrapper to call function send_physician_intpd as an autonomous transaction
--
CREATE EXTENSION IF NOT EXISTS dblink;

CREATE OR REPLACE PROCEDURE send_physician_intpd ( cd_physician_p text, nm_user_p text, cd_establishment_p bigint, ie_action_p text) AS $body$
DECLARE
	-- Change this to reflect the dblink connection string
	v_conn_str  text := format('port=%s dbname=%s user=%s', current_setting('port'), current_database(), current_user);
	v_query     text;

BEGIN
	v_query := 'CALL send_physician_intpd_atx ( ' || quote_nullable(cd_physician_p) || ',' || quote_nullable(nm_user_p) || ',' || quote_nullable(cd_establishment_p) || ',' || quote_nullable(ie_action_p) || ' )';
	PERFORM * FROM dblink(v_conn_str, v_query) AS p (ret boolean);

END;
$body$ LANGUAGE plpgsql SECURITY DEFINER;




CREATE OR REPLACE PROCEDURE send_physician_intpd_atx ( cd_physician_p text, nm_user_p text, cd_establishment_p bigint, ie_action_p text) AS $body$
DECLARE
ie_medico_w	bigint;
reg_integracao_w	gerar_int_padrao.reg_integracao;

BEGIN
if (cd_physician_p IS NOT NULL AND cd_physician_p::text <> '') and (nm_user_p IS NOT NULL AND nm_user_p::text <> '') then
	begin
	
	if (ie_action_p = 'I') then
		begin
		ie_medico_w := 1;
		end;
	else
		begin
		select	count(*)
		into STRICT	ie_medico_w
		from	medico
		where	cd_pessoa_fisica = cd_physician_p;
		end;
	end if;
	
	
	if (ie_medico_w > 0) then
		begin
		select 	CASE WHEN ie_action_p='U' THEN 'A' WHEN ie_action_p='D' THEN 'E'  ELSE ie_action_p END
		into STRICT	reg_integracao_w.ie_operacao
		;
		
		reg_integracao_w.cd_estab_documento			:= cd_establishment_p;
		reg_integracao_w.ie_status					:= 'P';
		reg_integracao_w.nr_seq_item_documento_p 	:= '5';
		reg_integracao_w.nr_seq_agrupador			:= null;
		reg_integracao_w := gerar_int_padrao.gravar_integracao('168', cd_physician_p, nm_user_p, reg_integracao_w);
		end;
	end if;		
	end;
end if;
commit;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE send_physician_intpd ( cd_physician_p text, nm_user_p text, cd_establishment_p bigint, ie_action_p text) FROM PUBLIC; -- REVOKE ALL ON PROCEDURE send_physician_intpd_atx ( cd_physician_p text, nm_user_p text, cd_establishment_p bigint, ie_action_p text) FROM PUBLIC;

