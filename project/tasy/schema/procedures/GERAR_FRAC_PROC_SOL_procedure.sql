-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_frac_proc_sol ( nr_seq_processo_p bigint, nr_prescricao_p bigint, nr_seq_solucao_p bigint, ie_acm_sn_p text, nm_usuario_p text, nr_seq_material_p bigint, ie_sup_oral_p text) AS $body$
DECLARE

					
nr_seq_pmh_w				bigint;
dt_horario_w				timestamp;
nr_prescricao_w				bigint;
nr_seq_material_w			integer;
nr_seq_solucao_w			integer;
nr_seq_fracionamento_w		bigint;
ds_erro_w					varchar(1800);
ie_grava_log_gedipa_w		varchar(1);
ie_gerar_proc_frac_sol_w 	varchar(1);	
qt_reg_cursor_w				bigint;
qt_reg_processo_w			bigint;
qt_reg_comp_sol_w			bigint;
qt_reg_solucao_w			bigint;
					
c01 CURSOR FOR
SELECT	nr_sequencia,
		dt_horario,
		nr_prescricao,
		nr_seq_material,
		nr_seq_solucao
from (		
SELECT	c.nr_sequencia,
		c.dt_horario,
		a.nr_prescricao,
		d.nr_sequencia nr_seq_material,
		b.nr_seq_solucao
from	prescr_material d,
		prescr_solucao b,	
		prescr_medica a,
		adep_regra_area_prep e,
		prescr_mat_hor c
where	d.nr_prescricao			= a.nr_prescricao
and		d.nr_sequencia_solucao	= b.nr_seq_solucao
and		d.nr_sequencia			= c.nr_seq_material
and		d.nr_prescricao			= c.nr_prescricao
and		c.nr_prescricao			= a.nr_prescricao
and		b.nr_prescricao			= a.nr_prescricao
and		e.nr_sequencia			= c.nr_seq_regra_area_prep
and		coalesce(e.ie_gerar_manip_frac,'N')	= 'S'
and		coalesce(e.ie_situacao,'A')		= 'A'
and		((ie_acm_sn_p = 'S') or
		 (((coalesce(c.ie_aprazado,'N') = 'S') and (b.nr_seq_dialise IS NOT NULL AND b.nr_seq_dialise::text <> '')) or (coalesce(b.ie_acm,'N')		<> 'S') or (coalesce(b.ie_se_necessario,'N')	<> 'S') or (coalesce(b.ie_etapa_especial,'N') = 'S')))
and		c.ie_agrupador			in (4,13)
and		d.ie_agrupador			in (4,13)
and		a.nr_prescricao			= nr_prescricao_p
and		b.nr_seq_solucao		= nr_seq_solucao_p
and		c.nr_seq_processo		= nr_seq_processo_p
and		coalesce(e.ie_exclusao,'N')		= 'N'

union

select	c.nr_sequencia,
		c.dt_horario,
		a.nr_prescricao,
		d.nr_sequencia nr_seq_material,
		b.nr_seq_solucao
from	prescr_material d,
		prescr_solucao b,	
		prescr_medica a,
		regra_local_dispensacao e,
		prescr_mat_hor c
where	d.nr_prescricao			= a.nr_prescricao
and		d.nr_sequencia_solucao	= b.nr_seq_solucao
and		d.nr_sequencia			= c.nr_seq_material
and		d.nr_prescricao			= c.nr_prescricao
and		c.nr_prescricao			= a.nr_prescricao
and		b.nr_prescricao			= a.nr_prescricao
and		e.nr_sequencia			= c.nr_regra_local_disp
and		coalesce(e.ie_gerar_manip_frac,'N')	= 'S'
and		((ie_acm_sn_p = 'S') or 
		 (((coalesce(c.ie_aprazado,'N') = 'S') and (b.nr_seq_dialise IS NOT NULL AND b.nr_seq_dialise::text <> '')) or (coalesce(b.ie_acm,'N')		<> 'S') or (coalesce(b.ie_se_necessario,'N')	<> 'S') or (coalesce(b.ie_etapa_especial,'N') = 'S')))
and		c.ie_agrupador			in (4,13)
and		d.ie_agrupador			in (4,13)
and		a.nr_prescricao			= nr_prescricao_p
and		b.nr_seq_solucao		= nr_seq_solucao_p
and		c.nr_seq_processo		= nr_seq_processo_p
) alias34 order by
		nr_prescricao,
		nr_seq_solucao,
		nr_sequencia;
	
c02 CURSOR FOR
SELECT  nr_sequencia,
		dt_horario,
		nr_prescricao,
		nr_seq_material
from	(		
SELECT	c.nr_sequencia,
		c.dt_horario,
		a.nr_prescricao,
		d.nr_sequencia	nr_seq_material
from	prescr_material d,	
		prescr_medica a,
		adep_regra_area_prep e,
		prescr_mat_hor c
where	d.nr_prescricao			= a.nr_prescricao
and		d.nr_sequencia			= c.nr_seq_material
and		d.nr_prescricao			= c.nr_prescricao
and		c.nr_prescricao			= a.nr_prescricao
and		e.nr_sequencia			= c.nr_seq_regra_area_prep
and		coalesce(e.ie_gerar_manip_frac,'N')	= 'S'
and		coalesce(e.ie_situacao,'A')		= 'A'
and		((ie_acm_sn_p = 'S') or (coalesce(d.ie_acm,'N')		<> 'S' and	coalesce(d.ie_se_necessario,'N')	<> 'S'))
and		c.ie_agrupador			= 8
and		d.ie_agrupador			= 8
and		a.nr_prescricao			= nr_prescricao_p
and		c.nr_seq_processo		= nr_seq_processo_p
and		d.nr_sequencia 			= nr_seq_material_p
and		coalesce(e.ie_exclusao,'N')		= 'N'

union

select	c.nr_sequencia,
		c.dt_horario,
		a.nr_prescricao,
		d.nr_sequencia nr_seq_material	
from	prescr_material d,	
		prescr_medica a,
		regra_local_dispensacao e,
		prescr_mat_hor c
where	d.nr_prescricao			= a.nr_prescricao
and		d.nr_sequencia			= c.nr_seq_material
and		d.nr_prescricao			= c.nr_prescricao
and		c.nr_prescricao			= a.nr_prescricao
and		e.nr_sequencia			= c.nr_regra_local_disp
and		coalesce(e.ie_gerar_manip_frac,'N')	= 'S'
and		((ie_acm_sn_p = 'S') or (coalesce(d.ie_acm,'N')		<> 'S' and	coalesce(d.ie_se_necessario,'N')	<> 'S'))
and		c.ie_agrupador			= 8
and		d.ie_agrupador			= 8
and		a.nr_prescricao			= nr_prescricao_p
and		c.nr_seq_processo		= nr_seq_processo_p
and		d.nr_sequencia 			= nr_seq_material_p
) alias14
order by
		nr_prescricao,
		nr_sequencia,
		nr_seq_material;
	
c03 CURSOR FOR
SELECT  nr_sequencia,
		dt_horario,
		nr_prescricao,
		nr_seq_material
from	(		
SELECT	c.nr_sequencia,
		c.dt_horario,
		a.nr_prescricao,
		d.nr_sequencia	nr_seq_material
from	prescr_material d,	
		prescr_medica a,
		adep_regra_area_prep e,
		prescr_mat_hor c
where	d.nr_prescricao			= a.nr_prescricao
and		d.nr_sequencia			= c.nr_seq_material
and		d.nr_prescricao			= c.nr_prescricao
and		c.nr_prescricao			= a.nr_prescricao
and		e.nr_sequencia			= c.nr_seq_regra_area_prep
and		coalesce(e.ie_gerar_manip_frac,'N')	= 'S'
and		coalesce(e.ie_situacao,'A')		= 'A'
and		((ie_acm_sn_p = 'S') or (coalesce(d.ie_acm,'N')		<> 'S' and	coalesce(d.ie_se_necessario,'N')	<> 'S'))
and		c.ie_agrupador			= 12
and		d.ie_agrupador			= 12
and		a.nr_prescricao			= nr_prescricao_p
and		c.nr_seq_processo		= nr_seq_processo_p
and		d.nr_sequencia 			= nr_seq_material_p
and		coalesce(e.ie_exclusao,'N')		= 'N'

union

select	c.nr_sequencia,
		c.dt_horario,
		a.nr_prescricao,
		d.nr_sequencia	nr_seq_material
from	prescr_material d,	
		prescr_medica a,
		regra_local_dispensacao e,
		prescr_mat_hor c
where	d.nr_prescricao			= a.nr_prescricao
and		d.nr_sequencia			= c.nr_seq_material
and		d.nr_prescricao			= c.nr_prescricao
and		c.nr_prescricao			= a.nr_prescricao
and		e.nr_sequencia			= c.nr_regra_local_disp
and		coalesce(e.ie_gerar_manip_frac,'N')	= 'S'
and		((ie_acm_sn_p = 'S') or (coalesce(d.ie_acm,'N')		<> 'S' and	coalesce(d.ie_se_necessario,'N')	<> 'S'))
and		c.ie_agrupador			= 12
and		d.ie_agrupador			= 12
and		a.nr_prescricao			= nr_prescricao_p
and		c.nr_seq_processo		= nr_seq_processo_p
and		d.nr_sequencia 			= nr_seq_material_p) alias14
order by
		nr_prescricao,
		nr_sequencia,
		nr_seq_material;
	
	

BEGIN

select	coalesce(max(ie_grava_log_gedipa),'S'),
		coalesce(max(ie_gerar_proc_frac_sol),'N')
into STRICT	ie_grava_log_gedipa_w,
		ie_gerar_proc_frac_sol_w
from	parametros_farmacia
where	cd_estabelecimento = coalesce(wheb_usuario_pck.get_cd_estabelecimento,1);

if (ie_grava_log_gedipa_w = 'S') then
	insert into log_gedipa(nr_sequencia, dt_log, nr_log, nm_objeto_execucao, nm_objeto_chamado, ds_parametros, ds_log, nr_seq_processo)
	values (obter_nextval_sequence('log_gedipa'), clock_timestamp(), 1105, 'GERAR_FRAC_PROC_SOL', null, 'nr_seq_processo_p='||to_char(nr_seq_processo_p)||'; nr_prescricao_p='||to_char(nr_prescricao_p)||'; nr_seq_solucao_p='||to_char(nr_seq_solucao_p)||'; nm_usuario_p='||nm_usuario_p, obter_desc_expressao(292013) || ' da procedure GERAR_FRAC_PROC_SOL'
,nr_seq_processo_p);
end if;

if (nr_seq_processo_p IS NOT NULL AND nr_seq_processo_p::text <> '') and (nr_seq_solucao_p IS NOT NULL AND nr_seq_solucao_p::text <> '') and (coalesce(nr_seq_material_p::text, '') = '') and (nm_usuario_p IS NOT NULL AND nm_usuario_p::text <> '') then
	begin
	
	if (ie_grava_log_gedipa_w = 'S') then

		select	count(*)
		into STRICT	qt_reg_processo_w
		from	prescr_mat_hor
		where	nr_seq_processo = nr_seq_processo_p
		and		nr_prescricao = nr_prescricao_p;

		select	count(*)
		into STRICT	qt_reg_comp_sol_w
		from	prescr_material
		where	nr_prescricao = nr_prescricao_p
		and		nr_sequencia_solucao = nr_seq_solucao_p;

		select	count(*)
		into STRICT	qt_reg_solucao_w
		from	prescr_solucao
		where	nr_prescricao = nr_prescricao_p
		and		nr_seq_solucao = nr_seq_solucao_p;


		select	count(*)
		into STRICT	qt_reg_cursor_w
		from	prescr_material d,
				prescr_solucao b,	
				prescr_medica a,
				adep_regra_area_prep e,
				prescr_mat_hor c
		where	d.nr_prescricao			= a.nr_prescricao
		and		d.nr_sequencia_solucao		= b.nr_seq_solucao
		and		d.nr_sequencia			= c.nr_seq_material
		and		d.nr_prescricao			= c.nr_prescricao
		and		c.nr_prescricao			= a.nr_prescricao
		and		b.nr_prescricao			= a.nr_prescricao
		and		e.nr_sequencia			= c.nr_seq_regra_area_prep
		and		coalesce(e.ie_gerar_manip_frac,'N')	= 'S'
		and		coalesce(e.ie_situacao,'A')		= 'A'
		and		((ie_acm_sn_p = 'S') or
				 ((((coalesce(c.ie_aprazado,'N') = 'S') and (b.nr_seq_dialise IS NOT NULL AND b.nr_seq_dialise::text <> '')) or (coalesce(b.ie_acm,'N')		<> 'S') or (coalesce(b.ie_etapa_especial,'N') = 'S')) and (coalesce(b.ie_se_necessario,'N')	<> 'S')))
		and		c.ie_agrupador			in (4,13)
		and		d.ie_agrupador			in (4,13)
		and		a.nr_prescricao			= nr_prescricao_p
		and		b.nr_seq_solucao		= nr_seq_solucao_p
		and		c.nr_seq_processo		= nr_seq_processo_p
		and		coalesce(e.ie_exclusao,'N')		= 'N';
	
		insert into log_gedipa(nr_sequencia, dt_log, nr_log, nm_objeto_execucao, nm_objeto_chamado, ds_parametros, ds_log, nr_seq_processo)
		values (obter_nextval_sequence('log_gedipa'), clock_timestamp(), 1110, 'GERAR_FRAC_PROC_SOL', null,'qt_reg_cursor_w='||qt_reg_cursor_w||' - qt_reg_processo_w='||qt_reg_processo_w||' - qt_reg_comp_sol_w='||qt_reg_comp_sol_w||' - qt_reg_solucao_w='||qt_reg_solucao_w, 'Open do cursor c01', nr_seq_processo_p);	
	end if;
	
	open c01;
	loop
	fetch c01 into	nr_seq_pmh_w,
			dt_horario_w,
			nr_prescricao_w,
			nr_seq_material_w,
			nr_seq_solucao_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
		begin
		
		if (ie_grava_log_gedipa_w = 'S') then		
			insert into log_gedipa(nr_sequencia, dt_log, nr_log, nm_objeto_execucao, nm_objeto_chamado, ds_parametros, ds_log, nr_seq_processo)
			values (obter_nextval_sequence('log_gedipa'), clock_timestamp(), 1115, 'GERAR_FRAC_PROC_SOL', null, null, obter_desc_expressao(781334, 'QT_VALOR')/*'Execucao do comando SQL 01'*/, nr_seq_processo_p);		
		end if;
		
		select	coalesce(max(nr_seq_etiqueta),0)
		into STRICT	nr_seq_fracionamento_w
		from	prescr_mat_hor
		where	nr_sequencia = nr_seq_pmh_w
		and	Obter_se_horario_liberado(dt_lib_horario, dt_horario) = 'S';
		
		if (nr_seq_fracionamento_w = 0) then
		
			if (ie_grava_log_gedipa_w = 'S') then		
				insert into log_gedipa(nr_sequencia, dt_log, nr_log, nm_objeto_execucao, nm_objeto_chamado, ds_parametros, ds_log, nr_seq_processo)
				values (obter_nextval_sequence('log_gedipa'), clock_timestamp(), 1120, 'GERAR_FRAC_PROC_SOL', null, null, obter_desc_expressao(781334, 'QT_VALOR')/*'Execucao do comando SQL 02'*/, nr_seq_processo_p);				
			end if;
			
			select	nextval('adep_processo_frac_seq')
			into STRICT	nr_seq_fracionamento_w
			;
			
			if (ie_grava_log_gedipa_w = 'S') then			
				insert into log_gedipa(nr_sequencia, dt_log, nr_log, nm_objeto_execucao, nm_objeto_chamado, ds_parametros, ds_log, nr_seq_processo)
				values (obter_nextval_sequence('log_gedipa'), clock_timestamp(), 1125, 'GERAR_FRAC_PROC_SOL', null, null, 'Insert na tabela ADEP_PROCESSO_FRAC; SEQ='||to_char(nr_seq_fracionamento_w), nr_seq_processo_p);
			end if;
			
			insert into adep_processo_frac(
				nr_sequencia,
				dt_atualizacao,
				nm_usuario,
				dt_atualizacao_nrec,
				nm_usuario_nrec,
				nr_seq_processo,
				dt_geracao,
				dt_preparo,
				nr_seq_digito)
			values (
				nr_seq_fracionamento_w,
				clock_timestamp(),
				nm_usuario_p,
				clock_timestamp(),
				nm_usuario_p,
				nr_seq_processo_p,
				clock_timestamp(),
				null,
				calcula_digito('MODULO11',nr_seq_fracionamento_w));
				
			if (ie_grava_log_gedipa_w = 'S') then
				insert into log_gedipa(nr_sequencia, dt_log, nr_log, nm_objeto_execucao, nm_objeto_chamado, ds_parametros, ds_log, nr_seq_processo)
				values (obter_nextval_sequence('log_gedipa'), clock_timestamp(), 1130, 'GERAR_FRAC_PROC_SOL', null, 'nr_seq_fracionamento_w='||to_char(nr_seq_fracionamento_w)||'; nr_seq_pmh_w='||to_char(nr_seq_pmh_w), 'Update 01 na tabela PRESCR_MAT_HOR', nr_seq_processo_p);												
			end if;	
			
			update	prescr_mat_hor
			set	nr_seq_etiqueta	= nr_seq_fracionamento_w
			where	nr_sequencia	= nr_seq_pmh_w;
			
			if (ie_grava_log_gedipa_w = 'S') then
				insert into log_gedipa(nr_sequencia, dt_log, nr_log, nm_objeto_execucao, nm_objeto_chamado, ds_parametros, ds_log, nr_seq_processo)
				values (obter_nextval_sequence('log_gedipa'), clock_timestamp(), 1135, 'GERAR_FRAC_PROC_SOL', null, 'nr_seq_fracionamento_w='||to_char(nr_seq_fracionamento_w)||'; nr_prescricao_w='||to_char(nr_prescricao_w)||'; nr_seq_solucao_w='||to_char(nr_seq_solucao_w)||'; dt_horario_w'||PKG_DATE_FORMATERS_TZ.TO_VARCHAR(dt_horario_w, 'timestamp', ESTABLISHMENT_TIMEZONE_UTILS.getTimeZone) , 'Update 02 na tabela PRESCR_MAT_HOR', nr_seq_processo_p);				
			end if;
				
			update	prescr_mat_hor a
			set	a.nr_seq_etiqueta	= nr_seq_fracionamento_w
			where	a.nr_seq_processo	= nr_seq_processo_p
			and	a.nr_prescricao		= nr_prescricao_w
			and	a.dt_horario		= dt_horario_w
			and	a.ie_agrupador		in (4,13)
			and 	exists (
					SELECT	1
					from	prescr_material b
					where	b.nr_prescricao		= a.nr_prescricao
					and	b.nr_sequencia		= a.nr_seq_material
					and	b.ie_agrupador		in (4,13)
					and	b.nr_sequencia_solucao	= nr_seq_solucao_w);

			if (ie_gerar_proc_frac_sol_w = 'S') then
				update	prescr_mat_hor a
				set		a.nr_seq_etiqueta	= nr_seq_fracionamento_w
				where	a.nr_seq_processo	= nr_seq_processo_p
				and		a.nr_prescricao		= nr_prescricao_w
				and		a.dt_horario		= dt_horario_w
				and		coalesce(ie_horario_especial,'N') <> 'S'
				and 	exists (
						SELECT	1
						from	prescr_material b
						where	b.nr_prescricao		= a.nr_prescricao
						and		b.nr_sequencia		= a.nr_seq_material
						and		b.nr_seq_kit		in (	SELECT	x.nr_sequencia 
															from	prescr_material x 
															where	x.nr_prescricao			= nr_prescricao_w
															and		x.nr_sequencia_solucao	= nr_seq_solucao_w));		
				/*update	prescr_mat_hor a
				set	a.nr_seq_etiqueta	= nr_seq_fracionamento_w
				where	a.nr_seq_processo	= nr_seq_processo_p
				and	a.nr_prescricao		= nr_prescricao_w
				and	a.dt_horario		= dt_horario_w
				and 	exists (
						select	1
						from	prescr_material b
						where	b.nr_prescricao		= a.nr_prescricao
						and	b.nr_sequencia		= a.nr_seq_material
						and	b.nr_seq_kit		= nr_seq_solucao_w); */
			end if;
			
		end if;
		
		if (ie_grava_log_gedipa_w = 'S') then
			insert into log_gedipa(nr_sequencia, dt_log, nr_log, nm_objeto_execucao, nm_objeto_chamado, ds_parametros, ds_log, nr_seq_processo)
			values (obter_nextval_sequence('log_gedipa'), clock_timestamp(), 1140, 'GERAR_FRAC_PROC_SOL', null, null, 'End fetch do cursor c01', nr_seq_processo_p);									
		end if;
		
		end;
	end loop;
	close c01;
	
	if (ie_grava_log_gedipa_w = 'S') then
		insert into log_gedipa(nr_sequencia, dt_log, nr_log, nm_objeto_execucao, nm_objeto_chamado, ds_parametros, ds_log, nr_seq_processo)
		values (obter_nextval_sequence('log_gedipa'), clock_timestamp(), 1145, 'GERAR_FRAC_PROC_SOL', null, null, 'Close do cursor c01', nr_seq_processo_p);				
	end if;
	
	end;
elsif (nr_seq_processo_p IS NOT NULL AND nr_seq_processo_p::text <> '') and (nr_seq_material_p IS NOT NULL AND nr_seq_material_p::text <> '') and (coalesce(nr_seq_solucao_p::text, '') = '') and (coalesce(ie_sup_oral_p,'N') = 'N') and (nm_usuario_p IS NOT NULL AND nm_usuario_p::text <> '') then
	begin
	
	if (ie_grava_log_gedipa_w = 'S') then
		insert into log_gedipa(nr_sequencia, dt_log, nr_log, nm_objeto_execucao, nm_objeto_chamado, ds_parametros, ds_log, nr_seq_processo)
		values (obter_nextval_sequence('log_gedipa'), clock_timestamp(), 1110, 'GERAR_FRAC_PROC_SOL', null, null, 'Open do cursor c02', nr_seq_processo_p);
	end if;
	
	open c02;
	loop
	fetch c02 into	nr_seq_pmh_w,
			dt_horario_w,
			nr_prescricao_w,
			nr_seq_material_w;			
	EXIT WHEN NOT FOUND; /* apply on c02 */
		begin
		
		if (ie_grava_log_gedipa_w = 'S') then
			insert into log_gedipa(nr_sequencia, dt_log, nr_log, nm_objeto_execucao, nm_objeto_chamado, ds_parametros, ds_log, nr_seq_processo)
			values (obter_nextval_sequence('log_gedipa'), clock_timestamp(), 1115, 'GERAR_FRAC_PROC_SOL', null, null, obter_desc_expressao(781334, 'QT_VALOR')/*'Execucao do comando SQL 01-2'*/, nr_seq_processo_p);				
		end if;
		
		select	coalesce(max(nr_seq_etiqueta),0)
		into STRICT	nr_seq_fracionamento_w
		from	prescr_mat_hor
		where	nr_sequencia = nr_seq_pmh_w
		and	Obter_se_horario_liberado(dt_lib_horario, dt_horario) = 'S';
		
		if (nr_seq_fracionamento_w = 0) then
		
			if (ie_grava_log_gedipa_w = 'S') then
				insert into log_gedipa(nr_sequencia, dt_log, nr_log, nm_objeto_execucao, nm_objeto_chamado, ds_parametros, ds_log, nr_seq_processo)
				values (obter_nextval_sequence('log_gedipa'), clock_timestamp(), 1120, 'GERAR_FRAC_PROC_SOL', null, null, obter_desc_expressao(781334, 'QT_VALOR')/*'Execuca do comando SQL 02-2'*/, nr_seq_processo_p);								
			end if;
			
			select	nextval('adep_processo_frac_seq')
			into STRICT	nr_seq_fracionamento_w
			;
			
			if (ie_grava_log_gedipa_w = 'S') then
				insert into log_gedipa(nr_sequencia, dt_log, nr_log, nm_objeto_execucao, nm_objeto_chamado, ds_parametros, ds_log, nr_seq_processo)
				values (obter_nextval_sequence('log_gedipa'), clock_timestamp(), 1125, 'GERAR_FRAC_PROC_SOL', null, null, 'Insert na tabela ADEP_PROCESSO_FRAC-2; SEQ='||to_char(nr_seq_fracionamento_w), nr_seq_processo_p);				
			end if;
			
			insert into adep_processo_frac(
				nr_sequencia,
				dt_atualizacao,
				nm_usuario,
				dt_atualizacao_nrec,
				nm_usuario_nrec,
				nr_seq_processo,
				dt_geracao,
				dt_preparo,
				nr_seq_digito)
			values (
				nr_seq_fracionamento_w,
				clock_timestamp(),
				nm_usuario_p,
				clock_timestamp(),
				nm_usuario_p,
				nr_seq_processo_p,
				clock_timestamp(),
				null,
				calcula_digito('MODULO11',nr_seq_fracionamento_w));
				
			if (ie_grava_log_gedipa_w = 'S') then
				insert into log_gedipa(nr_sequencia, dt_log, nr_log, nm_objeto_execucao, nm_objeto_chamado, ds_parametros, ds_log, nr_seq_processo)
				values (obter_nextval_sequence('log_gedipa'), clock_timestamp(), 1130, 'GERAR_FRAC_PROC_SOL', null, 'nr_seq_fracionamento_w='||to_char(nr_seq_fracionamento_w)||'; nr_seq_pmh_w='||to_char(nr_seq_pmh_w), 'Update 01 na tabela PRESCR_MAT_HOR-2', nr_seq_processo_p);												
			end if;
			
			update	prescr_mat_hor
			set	nr_seq_etiqueta	= nr_seq_fracionamento_w
			where	nr_sequencia	= nr_seq_pmh_w;
			
			if (ie_grava_log_gedipa_w = 'S') then
				insert into log_gedipa(nr_sequencia, dt_log, nr_log, nm_objeto_execucao, nm_objeto_chamado, ds_parametros, ds_log, nr_seq_processo)
				values (obter_nextval_sequence('log_gedipa'), clock_timestamp(), 1135, 'GERAR_FRAC_PROC_SOL', null, 'nr_seq_fracionamento_w='||to_char(nr_seq_fracionamento_w)||'; nr_prescricao_w='||to_char(nr_prescricao_w)||'; nr_seq_solucao_w='||to_char(nr_seq_solucao_w)||'; dt_horario_w'||PKG_DATE_FORMATERS_TZ.TO_VARCHAR(dt_horario_w, 'timestamp', ESTABLISHMENT_TIMEZONE_UTILS.getTimeZone) , 'Update 02 na tabela PRESCR_MAT_HOR-2', nr_seq_processo_p);				
			end if;
			
			update	prescr_mat_hor a
			set	a.nr_seq_etiqueta	= nr_seq_fracionamento_w
			where	a.nr_seq_processo	= nr_seq_processo_p
			and	a.nr_prescricao		= nr_prescricao_w
			and	a.dt_horario		= dt_horario_w
			and	a.ie_agrupador		= 8
			and 	exists (
					SELECT	1
					from	prescr_material b
					where	b.nr_prescricao		= a.nr_prescricao
					and	b.nr_sequencia		= a.nr_seq_material
					and	b.ie_agrupador		= 8
					and	b.nr_sequencia		= nr_seq_material_w);
			
		end if;
		if (ie_grava_log_gedipa_w = 'S') then		
			insert into log_gedipa(nr_sequencia, dt_log, nr_log, nm_objeto_execucao, nm_objeto_chamado, ds_parametros, ds_log, nr_seq_processo)
			values (obter_nextval_sequence('log_gedipa'), clock_timestamp(), 1140, 'GERAR_FRAC_PROC_SOL', null, null, 'End fetch do cursor c02', nr_seq_processo_p);						
		end if;
		
		end;
	end loop;
	close c02;
	if (ie_grava_log_gedipa_w = 'S') then	
		insert into log_gedipa(nr_sequencia, dt_log, nr_log, nm_objeto_execucao, nm_objeto_chamado, ds_parametros, ds_log, nr_seq_processo)
		values (obter_nextval_sequence('log_gedipa'), clock_timestamp(), 1145, 'GERAR_FRAC_PROC_SOL', null, null, 'Close do cursor c02', nr_seq_processo_p);							
	end if;
	
	end;
elsif (nr_seq_processo_p IS NOT NULL AND nr_seq_processo_p::text <> '') and (nr_seq_material_p IS NOT NULL AND nr_seq_material_p::text <> '') and (coalesce(nr_seq_solucao_p::text, '') = '') and (coalesce(ie_sup_oral_p,'N') = 'S') and (nm_usuario_p IS NOT NULL AND nm_usuario_p::text <> '') then
	begin
	
	if (ie_grava_log_gedipa_w = 'S') then	
		insert into log_gedipa(nr_sequencia, dt_log, nr_log, nm_objeto_execucao, nm_objeto_chamado, ds_parametros, ds_log, nr_seq_processo)
		values (obter_nextval_sequence('log_gedipa'), clock_timestamp(), 1110, 'GERAR_FRAC_PROC_SOL', null, null, 'Open do cursor c03', nr_seq_processo_p);	
	end if;
	
	open c03;
	loop
	fetch c03 into	nr_seq_pmh_w,
			dt_horario_w,
			nr_prescricao_w,
			nr_seq_material_w;			
	EXIT WHEN NOT FOUND; /* apply on c03 */
		begin
		
		if (ie_grava_log_gedipa_w = 'S') then
			insert into log_gedipa(nr_sequencia, dt_log, nr_log, nm_objeto_execucao, nm_objeto_chamado, ds_parametros, ds_log, nr_seq_processo)
			values (obter_nextval_sequence('log_gedipa'), clock_timestamp(), 1115, 'GERAR_FRAC_PROC_SOL', null, null, obter_desc_expressao(781334, 'QT_VALOR')/*'Execucao do comando SQL 01-3'*/, nr_seq_processo_p);		
		end if;
		
		select	coalesce(max(nr_seq_etiqueta),0)
		into STRICT	nr_seq_fracionamento_w
		from	prescr_mat_hor
		where	nr_sequencia = nr_seq_pmh_w
		and	Obter_se_horario_liberado(dt_lib_horario, dt_horario) = 'S';
		
		if (nr_seq_fracionamento_w = 0) then
		
			if (ie_grava_log_gedipa_w = 'S') then			
				insert into log_gedipa(nr_sequencia, dt_log, nr_log, nm_objeto_execucao, nm_objeto_chamado, ds_parametros, ds_log, nr_seq_processo)
				values (obter_nextval_sequence('log_gedipa'), clock_timestamp(), 1120, 'GERAR_FRAC_PROC_SOL', null, null, obter_desc_expressao(781334, 'QT_VALOR')/*'Execucao do comando SQL 02-2'*/, nr_seq_processo_p);				
			end if;
			
			select	nextval('adep_processo_frac_seq')
			into STRICT	nr_seq_fracionamento_w
			;
			
			if (ie_grava_log_gedipa_w = 'S') then			
				insert into log_gedipa(nr_sequencia, dt_log, nr_log, nm_objeto_execucao, nm_objeto_chamado, ds_parametros, ds_log, nr_seq_processo)
				values (obter_nextval_sequence('log_gedipa'), clock_timestamp(), 1125, 'GERAR_FRAC_PROC_SOL', null, null, 'Insert na tabela ADEP_PROCESSO_FRAC-2; SEQ='||to_char(nr_seq_fracionamento_w), nr_seq_processo_p);
			end if;
			
			insert into adep_processo_frac(
				nr_sequencia,
				dt_atualizacao,
				nm_usuario,
				dt_atualizacao_nrec,
				nm_usuario_nrec,
				nr_seq_processo,
				dt_geracao,
				dt_preparo,
				nr_seq_digito)
			values (
				nr_seq_fracionamento_w,
				clock_timestamp(),
				nm_usuario_p,
				clock_timestamp(),
				nm_usuario_p,
				nr_seq_processo_p,
				clock_timestamp(),
				null,
				calcula_digito('MODULO11',nr_seq_fracionamento_w));
				
			if (ie_grava_log_gedipa_w = 'S') then			
				insert into log_gedipa(nr_sequencia, dt_log, nr_log, nm_objeto_execucao, nm_objeto_chamado, ds_parametros, ds_log, nr_seq_processo)
				values (obter_nextval_sequence('log_gedipa'), clock_timestamp(), 1130, 'GERAR_FRAC_PROC_SOL', null, 'nr_seq_fracionamento_w='||to_char(nr_seq_fracionamento_w)||'; nr_seq_pmh_w='||to_char(nr_seq_pmh_w), 'Update 01 na tabela PRESCR_MAT_HOR-3', nr_seq_processo_p);								
			end if;
			
			update	prescr_mat_hor
			set	nr_seq_etiqueta	= nr_seq_fracionamento_w
			where	nr_sequencia	= nr_seq_pmh_w;
			
			if (ie_grava_log_gedipa_w = 'S') then			
				insert into log_gedipa(nr_sequencia, dt_log, nr_log, nm_objeto_execucao, nm_objeto_chamado, ds_parametros, ds_log, nr_seq_processo)
				values (obter_nextval_sequence('log_gedipa'), clock_timestamp(), 1135, 'GERAR_FRAC_PROC_SOL', null, 'nr_seq_fracionamento_w='||to_char(nr_seq_fracionamento_w)||'; nr_prescricao_w='||to_char(nr_prescricao_w)||'; nr_seq_solucao_w='||to_char(nr_seq_solucao_w)||'; dt_horario_w'||PKG_DATE_FORMATERS_TZ.TO_VARCHAR(dt_horario_w, 'timestamp', ESTABLISHMENT_TIMEZONE_UTILS.getTimeZone) , 'Update 02 na tabela PRESCR_MAT_HOR-3', nr_seq_processo_p);
			end if;
			
			update	prescr_mat_hor a
			set	a.nr_seq_etiqueta	= nr_seq_fracionamento_w
			where	a.nr_seq_processo	= nr_seq_processo_p
			and	a.nr_prescricao		= nr_prescricao_w
			and	a.dt_horario		= dt_horario_w
			and	a.ie_agrupador		= 12
			and 	exists (
					SELECT	1
					from	prescr_material b
					where	b.nr_prescricao		= a.nr_prescricao
					and	b.nr_sequencia		= a.nr_seq_material
					and	b.ie_agrupador		= 12
					and	b.nr_sequencia		= nr_seq_material_w);
			
		end if;
		
		if (ie_grava_log_gedipa_w = 'S') then		
			insert into log_gedipa(nr_sequencia, dt_log, nr_log, nm_objeto_execucao, nm_objeto_chamado, ds_parametros, ds_log, nr_seq_processo)
			values (obter_nextval_sequence('log_gedipa'), clock_timestamp(), 1140, 'GERAR_FRAC_PROC_SOL', null, null, 'End fetch do cursor c02', nr_seq_processo_p);						
		end if;
		
		end;
	end loop;
	close c02;
	
	if (ie_grava_log_gedipa_w = 'S') then	
		insert into log_gedipa(nr_sequencia, dt_log, nr_log, nm_objeto_execucao, nm_objeto_chamado, ds_parametros, ds_log, nr_seq_processo)
		values (obter_nextval_sequence('log_gedipa'), clock_timestamp(), 1145, 'GERAR_FRAC_PROC_SOL', null, null, 'Close do cursor c02', nr_seq_processo_p);							
	end if;
	
	end;

end if;

if (ie_grava_log_gedipa_w = 'S') then
	insert into log_gedipa(nr_sequencia, dt_log, nr_log, nm_objeto_execucao, nm_objeto_chamado, ds_parametros, ds_log, nr_seq_processo)
	values (obter_nextval_sequence('log_gedipa'), clock_timestamp(), 1150, 'GERAR_FRAC_PROC_SOL', null, 'nr_seq_processo_p='||to_char(nr_seq_processo_p)||'; nr_prescricao_p='||to_char(nr_prescricao_p)||'; nr_seq_solucao_p='||to_char(nr_seq_solucao_p)||'; nm_usuario_p='||nm_usuario_p, obter_desc_expressao(290116) || ' da procedure GERAR_FRAC_PROC_SOL'
, nr_seq_processo_p);
end if;
	
if (coalesce(wheb_usuario_pck.get_ie_commit, 'S') = 'S') then commit; end if;

exception
when others then
	ds_erro_w	:= substr(SQLERRM(SQLSTATE),1,1800);
	
	if (ie_grava_log_gedipa_w = 'S') then
		insert into log_gedipa(nr_sequencia, dt_log, nr_log, nm_objeto_execucao, nm_objeto_chamado, ds_parametros, ds_log, nr_seq_processo)
		values (obter_nextval_sequence('log_gedipa'), clock_timestamp(), 1155, 'GERAR_FRAC_PROC_SOL', null, 'nr_seq_processo_p='||to_char(nr_seq_processo_p)||'; nr_prescricao_p='||to_char(nr_prescricao_p)||'; nr_seq_solucao_p='||to_char(nr_seq_solucao_p)||'; nm_usuario_p='||nm_usuario_p, obter_desc_expressao(289744) || ' na ' || lower(obter_desc_expressao(308293)) || ' da procedure GERAR_FRAC_PROC_SOL'
, nr_seq_processo_p);		
	end if;
	if (coalesce(wheb_usuario_pck.get_ie_commit, 'S') = 'S') then commit; end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_frac_proc_sol ( nr_seq_processo_p bigint, nr_prescricao_p bigint, nr_seq_solucao_p bigint, ie_acm_sn_p text, nm_usuario_p text, nr_seq_material_p bigint, ie_sup_oral_p text) FROM PUBLIC;

