-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';



--
-- dblink wrapper to call function ish_validar_criacao_reg as an autonomous transaction
--
CREATE EXTENSION IF NOT EXISTS dblink;

CREATE OR REPLACE PROCEDURE ish_validar_criacao_reg (( reg_integracao_p INOUT gerar_int_padrao.reg_integracao, nr_seq_evento_sistema_p intpd_eventos_sistema.nr_sequencia%type, nr_seq_documento_p intpd_fila_transmissao.nr_seq_documento%type, ie_evento_p intpd_fila_transmissao.ie_evento%type, ie_operacao_p INOUT intpd_fila_transmissao.ie_operacao%type, ie_integra_p INOUT text, nr_seq_agrupador_p INOUT intpd_fila_transmissao.nr_seq_agrupador%type) is ie_operacao_w intpd_fila_transmissao.ie_operacao%type) AS $body$
DECLARE
	-- Change this to reflect the dblink connection string
	v_conn_str  text := format('port=%s dbname=%s user=%s', current_setting('port'), current_database(), current_user);
	v_query     text;

	v_ret	boolean;
BEGIN
	v_query := 'SELECT * FROM ish_validar_criacao_reg_atx ( ' || quote_nullable(reg_integracao_p) || ',' || quote_nullable(nr_seq_evento_sistema_p) || ',' || quote_nullable(nr_seq_documento_p) || ',' || quote_nullable(ie_evento_p) || ',' || quote_nullable(ie_operacao_p) || ',' || quote_nullable(ie_integra_p) || ',' || quote_nullable(nr_seq_agrupador_p) || ' )';
	SELECT * INTO v_ret FROM dblink(v_conn_str, v_query) AS p (ret boolean);
	RETURN v_ret;

END;
$body$ LANGUAGE plpgsql SECURITY DEFINER;




CREATE OR REPLACE PROCEDURE ish_validar_criacao_reg_atx (( reg_integracao_p INOUT gerar_int_padrao.reg_integracao, nr_seq_evento_sistema_p intpd_eventos_sistema.nr_sequencia%type, nr_seq_documento_p intpd_fila_transmissao.nr_seq_documento%type, ie_evento_p intpd_fila_transmissao.ie_evento%type, ie_operacao_p INOUT intpd_fila_transmissao.ie_operacao%type, ie_integra_p INOUT text, nr_seq_agrupador_p INOUT intpd_fila_transmissao.nr_seq_agrupador%type) is ie_operacao_w intpd_fila_transmissao.ie_operacao%type) AS $body$
DECLARE


nr_seq_interno_w	atend_paciente_unidade.nr_seq_interno%type;
BEGIN
select	coalesce(min(nr_seq_interno),0)
into STRICT	nr_seq_interno_w
from	atend_paciente_unidade
where	nr_atendimento	= nr_atendimento_p;

if	((somente_numero(nr_seq_documento_p) > nr_seq_interno_w) and (nr_seq_interno_w > 0)) then
	return;
else
	return;
end if;

end;

procedure get_case_data(
		nr_atendimento_p in number,
		nr_seq_episodio_p in out number,
		nr_episodio_p out varchar2) is
		
pragma autonomous_transaction;
begin

begin
select	nr_episodio,
	nr_sequencia
into STRICT	nr_episodio_p,
	nr_seq_episodio_p
from	episodio_paciente
where	nr_sequencia = nr_seq_episodio_p;
exception
when others then
	begin
	select	a.nr_episodio,
		a.nr_sequencia
	into STRICT	nr_episodio_p,
		nr_seq_episodio_p
	from	episodio_paciente a,
		atendimento_paciente b
	where	a.nr_sequencia = b.nr_seq_episodio
	and	b.nr_atendimento = nr_atendimento_p;	
	exception
	when others then
		nr_episodio_p	:=	null;
	end;
end;

end;

function is_case_integrated(
		nr_seq_episodio_p	number,
		nr_atendimento_p	number)
		return;
nr_seq_episodio_w	episodio_paciente.nr_sequencia%type;
nr_seq_interno_w	atend_paciente_unidade.nr_seq_interno%type;

ie_integrado_w		varchar2(1);
nr_seq_regra_conv_w	intpd_eventos_sistema.nr_seq_regra_conv%type;
nr_episodio_char_w	varchar2(10);

begin
ie_integrado_w	:=	'N';

begin
select	nr_seq_regra_conv
into STRICT	nr_seq_regra_conv_w
from	intpd_eventos_sistema
where	obter_se_integracao_ish(nr_seq_projeto_xml) = 'S'  LIMIT 1;
exception
when others then
	null;
end;

nr_seq_episodio_w	:=	nr_seq_episodio_p;
PERFORM get_case_data(nr_atendimento_p, nr_seq_episodio_w, nr_episodio_w);
nr_episodio_char_w := lpad(nr_episodio_w,10,0);

begin
select	coalesce(somente_numero(a.cd_interno),0)
into STRICT	nr_seq_interno_w
from	conversao_meio_externo a
where	a.nm_tabela = 'ATEND_PACIENTE_UNIDADE'
and	a.nm_atributo = 'NR_SEQ_INTERNO'
and	a.nr_seq_regra = nr_seq_regra_conv_w
and cd_externo like '%'||nr_episodio_char_w||'%'
and substr(cd_externo, 1, position(ish_param_pck.get_separador in cd_externo) - 1) like nr_episodio_char_w  LIMIT 1;
exception
when others then
	nr_seq_interno_w	:=	0;
end;

if (nr_seq_interno_w = 0) then
	begin	
	select	'S'
	into STRICT	ie_integrado_w
	from	intpd_fila_transmissao
	where	ie_evento = '106'
	and	coalesce(ie_envio_recebe, 'E') = 'E'
	and	ie_operacao = 'I'
	and	nr_seq_documento = nr_seq_episodio_w
	and	ie_status not in ('S')  LIMIT 1;
	exception
	when others then
		begin
		select	'S'
		into STRICT	ie_integrado_w
		from	intpd_fila_transmissao a,
			atendimento_paciente b
		where	a.nr_seq_documento = to_char(b.nr_atendimento)
		and	b.nr_seq_episodio = nr_seq_episodio_w
		and	a.ie_evento in ('120','127')
		and	coalesce(a.ie_envio_recebe, 'E') = 'E'
		and	a.ie_operacao = 'I'
		and	a.ie_status not in ('S')  LIMIT 1;
		exception
		when others then
			ie_integrado_w	:=	'N';
		end;		
	end;	
else
	ie_integrado_w	:=	'S';
end if;

return;

end;

function get_patno_ext(
		cd_pessoa_fisica_p	varchar)
		return;

pragma autonomous_transaction;
begin
begin
select	cd_pessoa_fisica_externo
into STRICT	cd_pessoa_fisica_externo_w
from	pf_codigo_externo
where	ie_tipo_codigo_externo = 'ISH'
and	cd_pessoa_fisica = cd_pessoa_fisica_p  LIMIT 1;
exception
when others then
	cd_pessoa_fisica_externo_w	:=	null;
end;

return;
end;

function get_insurance_code(nr_atendimento_p	number,
		nr_seq_interno_p	number)
		return;

pragma autonomous_transaction;	
begin

if (reg_integracao_p.cd_convenio IS NOT NULL AND reg_integracao_p.cd_convenio::text <> '') then
	cd_convenio_w := reg_integracao_p.cd_convenio;
else
	select	max(cd_convenio)
	into STRICT	cd_convenio_w
	from	atend_categoria_convenio
	where	nr_seq_interno	= nr_seq_interno_p
	and	nr_atendimento	= nr_atendimento_p;
end if;

return;

end;

procedure nr_seq_agrupador_p	in out 	number := get_agrupador(
	cd_pessoa_fisica_p		in	reg_integracao_p.cd_pessoa_fisica%type, nr_atendimento_p		in	reg_integracao_p.nr_atendimento%type, patientno_p		in	reg_integracao_p.patientno%type, caseno_p			in	reg_integracao_p.caseno%type, nr_seq_agrupador_p	in out 	number) is

pragma autonomous_transaction;
begin
nr_seq_agrupador_p := ish_patient_pck.get_agrupador(cd_pessoa_fisica_p, nr_atendimento_p, patientno_p, caseno_p, nr_seq_agrupador_p);
commit;
end;

procedure validar_criacao_reg_evento(nr_seq_sistema_w	intpd_eventos_sistema.nr_seq_sistema%type,
		nr_seq_documento_p			intpd_fila_transmissao.nr_seq_documento%type,
		ie_evento_p				intpd_fila_transmissao.ie_evento%type,
		nr_seq_agrupador_p			intpd_fila_transmissao.nr_seq_agrupador%type,
		ie_integra_p			in out	varchar2) is

nr_seq_fila_w	intpd_fila_transmissao.nr_sequencia%type;
ie_status_w	intpd_fila_transmissao.ie_status%type;

begin
select	max(a.nr_sequencia)
into STRICT	nr_seq_fila_w
from	intpd_fila_transmissao a,
	intpd_eventos_sistema b
where	a.nr_seq_evento_sistema	= b.nr_sequencia
and	b.nr_seq_sistema	= nr_seq_sistema_w
and	a.nr_seq_documento	= nr_seq_documento_p
and	a.ie_evento		= ie_evento_p
and	a.nr_seq_agrupador	= nr_seq_agrupador_p;

begin
select	a.ie_status
into STRICT	ie_status_w
from	intpd_fila_transmissao a
where	a.nr_sequencia	= nr_seq_fila_w;
exception
when others then
	ie_status_w	:=	null;
end;

if (ie_status_w = 'E') then
	CALL atualizar_status_reproc_intpd(
		nr_sequencia_p => nr_seq_fila_w,
		ie_status_p => 'P', 
		nm_usuario_p => obter_usuario_ativo, 
		ie_commit_p => 'N');
	ie_integra_p	:= 'N';
elsif (ie_status_w not in ('S','R')) then
	ie_integra_p	:= 'N';
end if;
end;

function get_seq_fila_tipo_case(nr_seq_documento_p	intpd_fila_transmissao.nr_seq_documento%type,
				ie_status_p		varchar2)
				return;

begin

if (ie_status_p IS NOT NULL AND ie_status_p::text <> '') then
	begin
	select	nr_sequencia
	into STRICT	nr_seq_retorno_w
	from	intpd_fila_transmissao
	where	nr_seq_documento	= nr_seq_documento_p
	and	ie_status		= ie_status_p
	and	ie_evento		= '220'  LIMIT 1;
	exception
	when others then
		nr_seq_retorno_w := null;
	end;
else
	begin
	select	nr_sequencia
	into STRICT	nr_seq_retorno_w
	from	intpd_fila_transmissao
	where	nr_seq_documento	= nr_seq_documento_p
	and	ie_evento		= '220'  LIMIT 1;
	exception
	when others then
		nr_seq_retorno_w := null;
	end;
end if;

return;

end;

function is_treat_integrated(
		nr_seq_documento_p	intpd_fila_transmissao.nr_seq_documento%type,
		nr_seq_regra_conv_p	intpd_eventos_sistema.nr_seq_regra_conv%type,
		ie_conversao_p		intpd_eventos_sistema.ie_conversao%type,
		ie_evento_p		intpd_fila_transmissao.ie_evento%type)
    	return;
qt_reg_w	number(10);
ie_integra_w	varchar2(1)	:= 'S';

pragma autonomous_transaction;
begin
begin
select	max(intpd_conv('ATENDIMENTO_PACIENTE_INF', 'NR_SEQUENCIA', a.nr_sequencia, nr_seq_regra_conv_p, ie_conversao_p, 'E'))
into STRICT	ds_atend_inf_w
from	atendimento_paciente_inf a
where	a.nr_atendimento = nr_seq_documento_p;

select	count(*)
into STRICT	qt_reg_w
from	intpd_fila_transmissao
where	ie_evento = ie_evento_p
and	ie_status not in ('S')
and	ie_operacao = 'I'
and	nr_seq_documento = nr_seq_documento_p;

if	((qt_reg_w = 0) and (coalesce(ds_atend_inf_w, 'NULL') = 'NULL')) then
	ie_integra_w	:= 'N';
end if;
exception
when others then
	ie_integra_w	:= 'N';
end;
return;

end;

--########################################################3
begin
select	ds_action,
	nr_seq_sistema,
	nr_seq_regra_conv,
	ie_conversao
into STRICT	ds_action_w,
	nr_seq_sistema_w,
	nr_seq_regra_conv_w,
	ie_conversao_w
from	intpd_eventos_sistema
where	nr_sequencia	= nr_seq_evento_sistema_p;

begin
if (reg_integracao_p.ie_geracao = 'U') then
	if (ds_action_w in ('PatientGetdetail')) then
		reg_integracao_p.patientno	:=	nr_seq_documento_p;
	elsif (ds_action_w like '%Get%') then
		reg_integracao_p.caseno		:=	nr_seq_documento_p;
	end if;
end if;

reg_integracao_p.cd_estab_documento	:=	coalesce(reg_integracao_p.cd_estab_documento, obter_estabelecimento_ativo);

nr_seq_agrupador_p := get_agrupador(
	reg_integracao_p.cd_pessoa_fisica, reg_integracao_p.nr_atendimento, reg_integracao_p.patientno, reg_integracao_p.caseno, nr_seq_agrupador_p);
exception
when others then
	null;
end;

ie_operacao_w	:= ie_operacao_p;
ie_integra_w	:= ie_integra_p;

if (ds_action_w in ('PatientCreate','PatientChange','PatientCancel', 'PatientMerge')) then
	begin	
	ie_evento_receb_w		:=	'81'; --consultar pessoa fisica
	ie_evento_envio_w		:=	'12'; --enviar pessoa fisica
	ie_evento_tratado_w	:=	'S';
	
	if (ds_action_w in ('PatientChange', 'PatientCancel')) and (coalesce(somente_numero(get_patno_ext(nr_seq_documento_p)), 0) = 0) then
		ie_integra_w	:=	'N';
	end if;
	end;	
elsif (ds_action_w in ('PatcaseAddinpatadmiss','PatcaseChangeinpatadmiss','PatcaseCancelinpatadmiss')) then
	begin		
	ie_evento_receb_w		:=	'104'; --consultar cases
	ie_evento_envio_w		:=	'106,127'; --enviar case
	ie_evento_tratado_w	:=	'S';
	
	if (ds_action_w in ('PatcaseChangeinpatadmiss','PatcaseCancelinpatadmiss')) and (is_case_integrated(nr_seq_documento_p, reg_integracao_p.nr_atendimento) = 'N') then
		ie_integra_w	:=	'N';
	end if;
	end;
elsif (ds_action_w in ('PatcaseAddoutpatvisitcas')) then
	begin		
	ie_evento_receb_w		:=	'117'; --consultar outpatient
	ie_evento_envio_w		:=	'127'; --enviar outpatient
	ie_evento_tratado_w		:=	'S';
	validar_criacao_reg_evento(nr_seq_sistema_w, nr_seq_documento_p, '127', nr_seq_agrupador_p, ie_integra_w);
	end;
elsif (ds_action_w in ('_-rzvish_-tableModify')) then
    begin
    ie_evento_receb_w	:=	'365'; --consultar outpatient
    ie_evento_envio_w	:=	'370'; --enviar outpatient
    ie_evento_tratado_w	:=	'S';
    end;
elsif (ds_action_w in ('PatcaseAddoutpatvisit','PatcaseChangeoutpatvisit','PatcaseCanceloutpatvisit')) then
	begin		
	ie_evento_receb_w		:=	'117'; --consultar outpatient
	ie_evento_envio_w		:=	'120,127'; --enviar outpatient
	ie_evento_tratado_w	:=	'S';
	
	if (ds_action_w in ('PatcaseChangeoutpatvisit','PatcaseCanceloutpatvisit')) and (is_case_integrated(null, reg_integracao_p.nr_atendimento) = 'N') then
		ie_integra_w	:=	'N';
	end if;
	
	if (ds_action_w in ('PatcaseAddoutpatvisit', 'PatcaseChangeoutpatvisit')) then
		validar_criacao_reg_evento(nr_seq_sistema_w, nr_seq_documento_p, '127', nr_seq_agrupador_p, ie_integra_w);
	end if;
	end;	
elsif (ie_evento_p = '114') and (ds_action_w in ('PatcaseAdddischarge','PatcaseChangedischarge','PatcaseCanceldischarge')) then
	begin		
	ie_evento_receb_w		:=	'119'; --consultar alta
	ie_evento_envio_w		:=	'114,402'; --enviar alta
	ie_evento_tratado_w	:=	'S';
	
	if (is_case_integrated(null, reg_integracao_p.nr_atendimento) = 'N') then
		ie_integra_w	:=	'N';
	end if;
	end;
elsif (ie_evento_p = '402') and (ds_action_w in ('PatcaseAdddischarge','PatcaseChangedischarge','PatcaseCanceldischarge')) then
	begin		
	ie_evento_receb_w		:=	'119'; --consultar alta
	ie_evento_envio_w		:=	'402'; --enviar alta
	ie_evento_tratado_w	:=	'S';
	
	if (is_case_integrated(null, reg_integracao_p.nr_atendimento) = 'N') then
		ie_integra_w	:=	'N';
	end if;
	end;
elsif (ds_action_w in ('_-rzvish_-assignment')) then
	begin	
	if (is_case_integrated(somente_numero(obter_valor_campo_separador(nr_seq_documento_p, 1, '|')), null) = 'N') then
		ie_integra_w	:=	'N';
	end if;
	end;
elsif (ds_action_w in ('PatcaseChangetransfer','PatcaseAddtransfer','PatcaseCanceltransfer')) then
	begin
	ie_evento_tratado_w	:=	'S';
	
	if	isprimeirosetor(reg_integracao_p.nr_atendimento, nr_seq_documento_p)	then
		ie_integra_w	:= 'N';
	else
		begin					
		ie_evento_receb_w	:=	'203'; --consultar movimentacao
		ie_evento_envio_w	:=	'118'; --enviar movimentacao do paciente
		end;
	end if;
	
	if (is_case_integrated(null, reg_integracao_p.nr_atendimento) = 'N') then
		ie_integra_w	:=	'N';
	end if;
	end;
elsif (ds_action_w in ('CaseprocedureCreatemult','CaseprocedureChangemult','CaseprocedureCancelmult',
			'CaseserviceCreatemult','CaseserviceChangemult','CaseserviceCancelmult')) then
	begin	
	ie_evento_envio_w		:=	'54'; --enviar procedimento
	ie_evento_receb_w		:=	'105'; --checked performed procedures
	ie_evento_tratado_w	:=	'S';
	
	if (is_case_integrated(null, reg_integracao_p.nr_atendimento) = 'N') then
		ie_integra_w	:=	'N';
	end if;
	end;
elsif (ds_action_w in ('_-rzvish_-insuranceCreate','_-rzvish_-insuranceChange','_-rzvish_-insuranceCancel','_-rzvish_-insuranceSwapInsprov')) then
	begin
	begin	
	ie_evento_envio_w		:=	'135'; --enviar dados do convenio do atendimento do paciente	
	ie_evento_tratado_w	:=	'S';
	
	ds_chave_w := obter_lista_string(nr_seq_documento_p, ds_separador_w);
	
	ds_conversao_w := obter_valor_campo_separador(intpd_conv('ATEND_CATEGORIA_CONVENIO', 'NR_SEQ_INTERNO', ds_chave_w(2), nr_seq_regra_conv_w, ie_conversao_w, 'E'),2,ds_separador_w);
	exception
	when others then
		begin
		ds_conversao_w	:=	null;
		end;
	end;
	
	if (is_case_integrated(null, reg_integracao_p.nr_atendimento) = 'N') then
		ie_integra_w	:=	'N';
	end if;
	end;
elsif (ds_action_w in ( 'CasediagnosisCreatemult','CasediagnosisDeletemult','CasediagnosisChangemult')) then
	begin
	begin
	ie_evento_envio_w		:=	'82'; --enviar dados do convenio do atendimento do paciente
	ie_evento_tratado_w	:=	'S';
	
	ds_chave_w := obter_lista_string(nr_seq_documento_p, ds_separador_w);		
	
	ds_conversao_w	:=	intpd_conv('DIAGNOSTICO_DOENCA', 'NR_SEQ_INTERNO', ds_chave_w(2), nr_seq_regra_conv_w, ie_conversao_w, 'E');
	exception
	when others then
		begin
		ds_conversao_w	:=	null;
		end;
	end;
	
	if (is_case_integrated(null, reg_integracao_p.nr_atendimento) = 'N') then
		ie_integra_w	:=	'N';
	end if;
	end;
elsif (ds_action_w in (	'PatcaseAddabsence',
				'PatcaseChangeAbsence',
				'_-rzvish_-casechangetypeCreate',
				'_-rzvish_-certificTreatmCreate',
				'_-rzvish_-certificTreatmChange',
				'_-rzvish_-egkCreate')) then
	if	((reg_integracao_p.nr_atendimento > 0) or (reg_integracao_p.nr_seq_episodio > 0)) and (is_case_integrated(reg_integracao_p.nr_seq_episodio, reg_integracao_p.nr_atendimento) = 'N') then
		ie_integra_w	:=	'N';
	end if;
elsif (ds_action_w in (	'_-rzvish_-certificTreatmCancel')) then
	if	((reg_integracao_p.nr_atendimento > 0) or (reg_integracao_p.nr_seq_episodio > 0)) and (is_case_integrated(reg_integracao_p.nr_seq_episodio, reg_integracao_p.nr_atendimento) = 'N') then
		ie_integra_w	:=	'N';
	elsif (is_treat_integrated(nr_seq_documento_p, nr_seq_regra_conv_w, ie_conversao_w, ie_evento_p) = 'N') then
		ie_integra_w	:=	'N';
	end if;
end if;

begin
select	max(a.nr_seq_episodio)
into STRICT	nr_seq_episodio_w
from	atendimento_paciente a
where	a.nr_atendimento = reg_integracao_p.nr_atendimento;	
exception
when others then
	nr_seq_episodio_w	:=	null;
end;

if (ie_evento_tratado_w = 'S') then
	begin
	if	((ie_evento_envio_w <> 'X') and (coalesce(ds_conversao_w, 'NULL') = 'NULL')) then
		
		SELECT * FROM intpd_obter_reg_fila(
			ie_evento_envio_w,  --ie_evento
			nr_seq_evento_sistema_p,  --nr_seq_evento_sistema
			nr_seq_documento_p,  --nr_seq_documento
			null,  --nr_doc_externo
			null,  --nr_seq_item_documento
			null,  --ds_parametros_adic
			'I') INTO STRICT  --ie_operacao
			nr_seq_fila_w,  --nr_seq_fila
			nr_seq_id_w; --nr_seq_id
			
		nr_seq_fila_w	:=	coalesce(nr_seq_fila_w, nr_seq_id_w);

	end if;
		
	if	((ie_evento_receb_w <> 'X') and (coalesce(nr_seq_fila_w::text, '') = '') and (coalesce(ds_conversao_w, 'NULL') = 'NULL')) then
		SELECT * FROM intpd_obter_reg_fila(
			ie_evento_receb_w,  --ie_evento
			nr_seq_evento_sistema_p,  --nr_seq_evento_sistema
			null,  --nr_seq_documento
			nr_seq_documento_p,  --nr_doc_externo
			null,  --nr_seq_item_documento
			null,  --ds_parametros_adic
			'I') INTO STRICT  --ie_operacao
			nr_seq_fila_w,  --nr_seq_fila
			nr_seq_id_w; --nr_seq_id
		
		nr_seq_fila_w	:=	coalesce(nr_seq_fila_w, nr_seq_id_w);
	end if;
	
	if (ie_evento_p = '106') then
		nr_seq_fila_tipo_case_w := get_seq_fila_tipo_case(nr_seq_documento_p,'A');		
	elsif (ie_evento_p = '370') and (nr_seq_fila_w IS NOT NULL AND nr_seq_fila_w::text <> '') and (ie_operacao_w = 'I') then
        ie_operacao_w	:=	'A';
	elsif (ie_evento_p = '135') then
		begin
			nr_atendimento_w	:= somente_numero(obter_valor_campo_separador(nr_seq_documento_p,1,ds_separador_w));
			nr_seq_interno_w	:= somente_numero(obter_valor_campo_separador(nr_seq_documento_p,2,ds_separador_w));
			nr_seq_episodio_w 	:= somente_numero(obter_valor_campo_separador(nr_seq_documento_p,3,ds_separador_w));

			if (coalesce(nr_seq_interno_w,0) > 0) then
				cd_convenio_w := get_insurance_code(nr_atendimento_w,nr_seq_interno_w);
			end if;

			if (ie_operacao_p <> 'E') then
				nr_seq_fila_tipo_case_w := get_seq_fila_tipo_case(nr_seq_episodio_w,'A');
			end if;
		end;
	end if;	
	
	if (ie_evento_p in ('106','135')) and (coalesce(nr_seq_fila_tipo_case_w,0) > 0) then
		ie_integra_w	:= 'N';	
	elsif	((coalesce(nr_seq_fila_w::text, '') = '') and (coalesce(ds_conversao_w, 'NULL') = 'NULL')) then	
	
		if (ie_operacao_w = 'A') then			
			if	(ie_evento_p = '135') then --Se for convenio e este ja foi integrado para o case, entao mantem como 'A'
				if (ISH_RZV_INSURANCE_PCK.get_se_conv_integrado_case(nr_seq_episodio_w, cd_convenio_w) = 'S') then						
					ie_operacao_w := 'A';
				else
					ie_operacao_w := 'I';
				end if;
			elsif (ie_evento_p = '106') then
				nr_seq_fila_tipo_case_w := get_seq_fila_tipo_case(nr_seq_documento_p,null);
				--Se e o envio de uma admissa, mas existe a troca de case enviada anteriormente, entao deve enviar como 'A' e nao alterar para I.
				if (coalesce(nr_seq_fila_tipo_case_w::text, '') = '') then
					ie_operacao_w 	:= 'I';
				end if;		
			else
				ie_operacao_w 	:= 'I';
			end if;
			
		elsif (ie_operacao_p = 'E') then
		
			if (ie_evento_p = '106') then
				--Se e o envio de uma admissao, mas existe a troca de case enviada anteriormente, entao pode ser enviado o cancelamento da admissao.			
				nr_seq_fila_tipo_case_w := get_seq_fila_tipo_case(nr_seq_documento_p,null);				
				if (coalesce(nr_seq_fila_tipo_case_w::text, '') = '') then
					ie_integra_w	:= 'N';
				end if;
			elsif (ie_evento_p = '135') and (ISH_RZV_INSURANCE_PCK.get_se_conv_integrado_case(nr_seq_episodio_w, cd_convenio_w) = 'S') then
				ie_integra_w	:= 'S';
			else		
				ie_integra_w	:= 'N';
			end if;
		end if;
		
	elsif	(ie_evento_p = '114') and --Se evento de alta, mas ja existe fila de insercao, altera para 'A-Alteracao'
		(ie_operacao_w = 'I') and (nr_seq_fila_w IS NOT NULL AND nr_seq_fila_w::text <> '') then
		
		--Verifica se existe uma msg de insert, mas que nao existe uma msg de estorno posteriori.

		--Se existir, mantem como insert, caso contrario, altera para Alteracao.
		begin
		select	'A'
		into STRICT	ie_operacao_w
		from	intpd_fila_transmissao a,
			intpd_eventos_sistema b
		where	a.nr_seq_evento_sistema	= b.nr_sequencia
		and	b.nr_seq_sistema	= nr_seq_sistema_w
		and	a.ie_evento		in ('114','402') --Alta ou alta estimada
		and	a.ie_operacao		= 'I'
		and	a.nr_seq_documento	= nr_seq_documento_p
		and	a.ie_status		= 'S'
		and	not exists --Se nao existe uma mensagem de estorno.
			(SELECT 1
			from	intpd_fila_transmissao x,
				intpd_eventos_sistema y
			where	x.nr_seq_evento_sistema	= y.nr_sequencia
			and	y.nr_seq_sistema	= nr_seq_sistema_w
			and	x.ie_evento		in ('114','402') --Alta ou alta estimada
			and	x.nr_seq_documento	= nr_seq_documento_p
			and	x.ie_operacao		= 'E'
			and	x.ie_status		in ('S','P','R','AP')
			and	x.nr_sequencia		> a.nr_sequencia)  LIMIT 1;
		exception
		when others then
			ie_operacao_w := 'I';
		end;	
		
	end if;
	
	end;
elsif (ds_action_w like '%Get%') then	
	ie_integra_w := ie_integra_p;
elsif (ie_operacao_w in ('A','E')) then
	begin
	SELECT * FROM intpd_validar_update_delete(nr_seq_evento_sistema_p, nr_seq_documento_p, ie_evento_p, null, null, ie_operacao_w, ie_integra_w) INTO STRICT ie_operacao_w, ie_integra_w;
	end;
end if;

if	((nr_seq_episodio_w IS NOT NULL AND nr_seq_episodio_w::text <> '') or (reg_integracao_p.nr_atendimento IS NOT NULL AND reg_integracao_p.nr_atendimento::text <> '')) and (obter_se_atend_finalizado(nr_seq_episodio_w, reg_integracao_p.nr_atendimento, reg_integracao_p.cd_pessoa_fisica) = 'N') then
	reg_integracao_p.ie_status	:= 'A';
end if;

ie_operacao_p	:= ie_operacao_w;
ie_integra_p	:= ie_integra_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ish_validar_criacao_reg (( reg_integracao_p INOUT gerar_int_padrao.reg_integracao, nr_seq_evento_sistema_p intpd_eventos_sistema.nr_sequencia%type, nr_seq_documento_p intpd_fila_transmissao.nr_seq_documento%type, ie_evento_p intpd_fila_transmissao.ie_evento%type, ie_operacao_p INOUT intpd_fila_transmissao.ie_operacao%type, ie_integra_p INOUT text, nr_seq_agrupador_p INOUT intpd_fila_transmissao.nr_seq_agrupador%type) is ie_operacao_w intpd_fila_transmissao.ie_operacao%type) FROM PUBLIC; -- REVOKE ALL ON PROCEDURE ish_validar_criacao_reg_atx (( reg_integracao_p INOUT gerar_int_padrao.reg_integracao, nr_seq_evento_sistema_p intpd_eventos_sistema.nr_sequencia%type, nr_seq_documento_p intpd_fila_transmissao.nr_seq_documento%type, ie_evento_p intpd_fila_transmissao.ie_evento%type, ie_operacao_p INOUT intpd_fila_transmissao.ie_operacao%type, ie_integra_p INOUT text, nr_seq_agrupador_p INOUT intpd_fila_transmissao.nr_seq_agrupador%type) is ie_operacao_w intpd_fila_transmissao.ie_operacao%type) FROM PUBLIC;

