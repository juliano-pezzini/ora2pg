-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_consistir_liberacao_defesa ( nr_seq_defesa_p bigint, nm_usuario_p text, ds_erro_p INOUT text) AS $body$
DECLARE


ds_erro_w			varchar(255);
qt_texto_defesa_w		bigint;
cont_pedido_w			bigint; -- os 778607
ie_persus_w			pls_processo.ie_persus%type;


BEGIN

select	d.ie_persus
into STRICT	ie_persus_w
from	pls_processo		d,
	pls_processo_conta	c,
	pls_impugnacao		b,
	pls_impugnacao_defesa	a
where	a.nr_seq_impugnacao	= b.nr_sequencia
and	b.nr_seq_conta		= c.nr_sequencia
and	c.nr_seq_processo	= d.nr_sequencia
and	a.nr_sequencia		= nr_seq_defesa_p;

select	count(*)
into STRICT	qt_texto_defesa_w
from	pls_texto_defesa
where	nr_seq_defesa	= nr_seq_defesa_p;

if (qt_texto_defesa_w = 0) and (ie_persus_w <> 'P') then
	ds_erro_w	:= wheb_mensagem_pck.get_texto(281065);
else -- os 778607 _ aldellandrea verificar se a defesa tem um pedido cadastrado
	select	count(1)
	into STRICT	cont_pedido_w
	from	pls_impugnacao a,
		pls_impugnacao_defesa b,
		pls_processo_conta c
	where	a.nr_sequencia = b.nr_seq_impugnacao
	and	c.nr_sequencia = a.nr_seq_conta
	and exists (	SELECT 	1
			from	pls_proc_conta_pedido x
			where	x.nr_seq_proc_conta = c.nr_sequencia)
	and	b.nr_sequencia = nr_seq_defesa_p;

	if (cont_pedido_w = 0)	then
		ds_erro_w	:= wheb_mensagem_pck.get_texto(317060);
	end if;
--fim alteracao os 778607
end if;

ds_erro_p	:= ds_erro_w;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_consistir_liberacao_defesa ( nr_seq_defesa_p bigint, nm_usuario_p text, ds_erro_p INOUT text) FROM PUBLIC;

