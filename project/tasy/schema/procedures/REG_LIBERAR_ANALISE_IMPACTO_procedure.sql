-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE reg_liberar_analise_impacto (nr_seq_ordem_serv_p bigint, nr_seq_impacto_p bigint, nm_usuario_p text) AS $body$
DECLARE


  ie_tipo_impacto_w         man_ordem_serv_impacto.ie_tipo_impacto%type;
  nr_seq_intencao_uso_w     man_ordem_serv_impacto.nr_seq_intencao_uso%type;
  nr_seq_intencao_uso_pai_w reg_intencao_uso.nr_seq_intencao_uso_pai%type;

  c01 CURSOR(nr_seq_int_uso_w  bigint) FOR
    SELECT distinct cc.nr_seq_equipe
      from ccb_regra_composicao rc, ccb_regra_comp_cargo cc
     where cc.nr_seq_regra_comp = rc.nr_sequencia
       and rc.nr_seq_intencao_uso = nr_seq_int_uso_w
       and rc.ie_tipo_documento = 'PRS'
       and rc.ie_tipo_alteracao in (SELECT distinct pr.ie_impacto_requisito
              from man_ordem_serv_imp_pr pr, man_ordem_serv_impacto ai
             where pr.nr_seq_impacto = ai.nr_sequencia
               and ai.nr_seq_intencao_uso = nr_seq_int_uso_w
               and ai.nr_sequencia = nr_seq_impacto_p);

  c02 CURSOR(nr_seq_int_uso_w  bigint) FOR
    SELECT distinct cc.nr_seq_equipe
      from ccb_regra_composicao rc, ccb_regra_comp_cargo cc
     where cc.nr_seq_regra_comp = rc.nr_sequencia
       and rc.nr_seq_intencao_uso = nr_seq_int_uso_w
       and rc.ie_tipo_documento = 'URS'
       and rc.ie_tipo_alteracao in (SELECT distinct cr.ie_impacto_requisito
              from man_ordem_serv_imp_cr cr, man_ordem_serv_impacto ai
             where cr.nr_seq_impacto = ai.nr_sequencia
               and ai.nr_seq_intencao_uso = nr_seq_int_uso_w
               and ai.nr_sequencia = nr_seq_impacto_p);

  r01 c01%rowtype;
  r02 c02%rowtype;


BEGIN

  select ai.ie_tipo_impacto,
         ai.nr_seq_intencao_uso,
         iu.nr_seq_intencao_uso_pai
    into STRICT ie_tipo_impacto_w,
         nr_seq_intencao_uso_w,
         nr_seq_intencao_uso_pai_w
    from man_ordem_serv_impacto ai, reg_intencao_uso iu
   where ai.nr_sequencia = nr_seq_impacto_p
     and ai.nr_seq_intencao_uso = iu.nr_sequencia;

  update man_ordem_serv_impacto
     set dt_liberacao = clock_timestamp(), nm_usuario = nm_usuario_p
   where nr_sequencia = nr_seq_impacto_p;

  if ((nr_seq_intencao_uso_w = 2 or nr_seq_intencao_uso_pai_w = 2) and
     ie_tipo_impacto_w = 'PRS') then

    CALL man_gerar_ccb_ordem_serv(nr_seq_ordem_serv_p,
                             nr_seq_impacto_p,
                             nm_usuario_p);

  else
  
    if ie_tipo_impacto_w = 'PRS' then
    
      for r01 in c01(nr_seq_intencao_uso_w) loop
      
        insert into man_ordem_serv_aprov_ccb(nr_sequencia,
           dt_atualizacao,
           dt_atualizacao_nrec,
           nm_usuario,
           nm_usuario_nrec,
           nr_seq_ordem_serv,
           nr_seq_equipe,
           nr_seq_impacto,
           ie_status,
           dt_aprovacao,
           nm_usuario_aprov)
        values (nextval('man_ordem_serv_aprov_ccb_seq'),
           clock_timestamp(),
           clock_timestamp(),
           nm_usuario_p,
           nm_usuario_p,
           nr_seq_ordem_serv_p,
           r01.nr_seq_equipe,
           nr_seq_impacto_p,
           'P',
           null,
           null);

      end loop;

    elsif ie_tipo_impacto_w = 'URS' then
    
      insert into man_ordem_serv_aprov_ccb(nr_sequencia,
         dt_atualizacao,
         dt_atualizacao_nrec,
         nm_usuario,
         nm_usuario_nrec,
         nr_seq_ordem_serv,
         nr_seq_equipe,
         nr_seq_impacto,
         ie_status,
         dt_aprovacao,
         nm_usuario_aprov)
      values (nextval('man_ordem_serv_aprov_ccb_seq'),
         clock_timestamp(),
         clock_timestamp(),
         nm_usuario_p,
         nm_usuario_p,
         nr_seq_ordem_serv_p,
         r01.nr_seq_equipe,
         nr_seq_impacto_p,
         'P',
         null,
         null);

    end if;

  end if;

  CALL avisar_aprovacao_ccb(nr_seq_impacto_p, 'A');

  commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE reg_liberar_analise_impacto (nr_seq_ordem_serv_p bigint, nr_seq_impacto_p bigint, nm_usuario_p text) FROM PUBLIC;

