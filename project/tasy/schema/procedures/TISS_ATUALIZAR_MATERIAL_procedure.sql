-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';



CREATE TYPE lista_regras AS (nr_seq_tiss_tabela	tiss_regra_tabela_mat.nr_seq_tiss_tabela%type,
		ie_cod_material		tiss_regra_tabela_mat.ie_cod_material%type,
		ie_conversao_externa	tiss_regra_tabela_mat.ie_conversao_externa%type,
		cd_adicional		tiss_regra_tabela_mat.cd_adicional%type,
		ie_desc_material	tiss_regra_tabela_mat.ie_desc_material%type,
		cd_material_tiss	tiss_regra_tabela_mat.cd_material_tiss%type,	
		ds_material_tiss	tiss_regra_tabela_mat.ds_material_tiss%type,	
		ie_registro_anvisa	tiss_regra_tabela_mat.ie_registro_anvisa%type,
		ie_prioridade		tiss_regra_tabela_mat.ie_prioridade%type);


CREATE OR REPLACE PROCEDURE tiss_atualizar_material (nr_seq_material_p text, ie_atualizar_todos_p text, nm_usuario_p text) AS $body$
DECLARE


ie_responsavel_credito_w			varchar(10) := 'X';
cd_estabelecimento_w			bigint;
cd_convenio_w				bigint;
cd_cgc_estab_w				varchar(100);
nr_interno_conta_w				bigint;
ie_tipo_atendimento_w			bigint;
ie_tipo_atend_conta_w			bigint;
cd_material_w				bigint;
ie_tipo_protocolo_w				bigint;
cd_cgc_prestador_tiss_w			varchar(100);
cd_cgc_prest_solic_tiss_w			varchar(100);
ie_tipo_guia_atend_w			varchar(50);
cd_medico_atend_w			varchar(255);
cd_tab_preco_material_w			bigint;
cd_material_brasindice_w			varchar(100);
cd_laboratorio_w				varchar(100);
cd_medicamento_w				varchar(100);
cd_apresentacao_w			varchar(100);
cd_material_convenio_w			varchar(100);
ie_origem_tiss_w				varchar(100);
cd_grupo_material_w			bigint;
cd_subgrupo_material_w			bigint;
cd_classe_material_w			bigint;
cd_setor_atendimento_w			bigint;
nr_seq_tiss_tabela_w			bigint;
ie_codigo_material_w			varchar(100);
ie_origem_preco_w				varchar(100);
cd_adicional_w				varchar(10);
ie_clinica_w				integer;
cd_categoria_w				varchar(100);
ie_cod_tiss_brasindice_w			varchar(100);
ie_conversao_externa_w			varchar(100);
cd_material_tiss_w				varchar(100);
CD_TABELA_XML_w			varchar(100);
cd_prestador_w				varchar(100);
ds_material_tiss_w				varchar(255);
ds_material_w				varchar(255);
ie_guia_honor_w				varchar(10);
ie_desc_material_w				varchar(10);
cd_interno_w				varchar(255);
ds_prestador_tiss_w			varchar(255);
cd_cgc_prestador_w			varchar(255);
dt_material_w				timestamp;
ds_campo_w				varchar(255) := '';
ds_OPM_regra_w				varchar(255) := '';
ds_desp_regra_w				varchar(255) := '';
ie_tipo_classe_w				varchar(255) := '';
cd_classif_setor_w				varchar(255) := '';
ds_material_original_w			varchar(255) := '';
nr_seq_regra_prestador_w			bigint;
cd_medico_exec_tiss_w			varchar(255);
ie_solicitante_w				varchar(255);
nr_prescricao_w				numeric(20);
nr_atendimento_w				numeric(20);
cd_cgc_solic_prest_w			varchar(255);
vl_mat_proc_princ_w			double precision;
nr_seq_proc_princ_w			bigint;
vl_material_w				double precision;
vl_material_tiss_w				double precision;
dt_entrada_w				timestamp;
ie_data_ref_tab_mat_w			varchar(255);
cd_mat_conv_regra_w				varchar(100);
ds_mat_conv_regra_w				varchar(255);
ie_medico_exec_w				varchar(255);
cd_prestador_solic_w			varchar(255);
ds_prestador_solic_w			varchar(255);
ds_material_convenio_w			varchar(255);
cd_senha_item_w				varchar(255) := null;
ie_atualiza_senha_conta_w		varchar(255);
cd_unidade_medida_consumo_w		varchar(30);
cd_medico_referiado_w			varchar(10);
nr_doc_convenio_w			varchar(20);
ie_guia_w				varchar(255);
ie_atualiza_nr_guia_w			varchar(255);
nr_seq_protocolo_w			bigint;
vl_unitario_w				double precision;
qt_material_w				double precision;
ie_resp_credito_mat_w			varchar(5);
ie_cod_tiss_simpro_w			varchar(255);
cd_tipo_acomodacao_w			bigint;
cd_procedencia_w			bigint;
cd_plano_w				varchar(10);
nr_seq_classificacao_atend_w		bigint;
ie_origem_preco_mat_w			bigint;
ie_status_acerto_w			bigint;
ie_digitos_desp_w			varchar(10);
ie_tipo_despesa_w			varchar(2);
nr_seq_proc_pacote_w			bigint;
ie_fixar_vig_brasindice_w		varchar(10);
dt_vigencia_tabela_w			timestamp;
dt_vigencia_mat_w			timestamp;
ie_material_exec_w			varchar(10);
nr_registro_anvisa_w			varchar(60);
vl_unitario_mat_w			double precision := 0;
cd_lab_brasindice_inf_w			varchar(100);
cd_med_brasindice_inf_w			varchar(100);
cd_apres_brasindice_inf_w		varchar(100);
ie_registro_anvisa_w			varchar(1);
ds_versao_w				varchar(20);
nr_registro_anvisa_tiss_w	material_atend_paciente.nr_registro_anvisa_tiss%type;
cd_material_tuss_w			bigint;
cd_material_tuss_conta_w		bigint;
cd_material_tuss_bras_w			bigint;
cd_material_tuss_simpro_w		bigint;
dt_conta_w				timestamp;
dt_preco_w				timestamp;
dt_altap_w				timestamp;
dt_alta_preco_w				timestamp;
dt_conta_definitiva_w			timestamp;
dt_periodo_inicial_w			timestamp;
dt_periodo_final_w			timestamp;
nr_seq_bras_preco_w			bigint;
cd_tab_preco_mat_regra_w		smallint;
qt_preco_mat_w				bigint;
ie_continua_w				varchar(1);
ds_material_tuss_w			varchar(255);
qt_mat_conversao_w			bigint;
ie_senha_mat_guia_proc_w		varchar(1);
count_param_w				bigint;
dt_mesano_referencia_w			timestamp;
ie_codigo_tuss_w			varchar(1) := 'N';
cd_mat_tiss_number_w 			numeric(20);
nr_seq_lote_fornec_w			material_lote_fornec.nr_sequencia%type;
nr_seq_marca_prescr_w			prescr_material.nr_seq_marca%type;
cd_cgc_consig_w				prescr_material.cd_fornec_consignado%type;
nr_seq_familia_w			material.nr_seq_familia%type;
nr_seq_marca_w 				material_lote_fornec.nr_seq_marca%type;
ie_tipo_material_w			material.ie_tipo_material%type;
nr_seq_conv_simp_w			convenio_simpro.nr_sequencia%type;
ie_prioridade_w				tiss_regra_tabela_mat.ie_prioridade%type;
ie_buscar_prior_tab_tiss_w		varchar(1) := 'N';
cd_grupo_w				tiss_regra_tabela_mat.cd_grupo%type;
cd_simpro_w				material_simpro.cd_simpro%type;
ds_material_esp_w       		material.ds_material%type;
nr_seq_mat_simp_w			material_atend_paciente.nr_seq_mat_simp%type;
nr_seq_simp_preco_w			material_atend_paciente.nr_seq_simp_preco%type;
cd_ref_fabricante_w         varchar(80);
ie_origem_codigo_w          varchar(1);
part_number_w               material.cd_fabricante%type;
ie_ref_fabric_opme_w		varchar(1) := 'N';
ie_mat_atend_pac_tiss_w     varchar(1) := 'N';
		
type lista_regras_vt is table of lista_regras index 	by integer;
lista_regras_w			lista_regras_vt;
i				integer;


c02 CURSOR FOR
SELECT	a.nr_seq_tiss_tabela,
	coalesce(a.ie_cod_material, 'T'),
	coalesce(a.ie_conversao_externa, 'S'),
	a.cd_adicional,
	coalesce(a.ie_desc_material, 'N'),
	a.cd_material_tiss,
	a.ds_material_tiss,
	coalesce(a.ie_registro_anvisa,'N')
from 	tiss_regra_tabela_mat a
where	a.cd_estabelecimento					= cd_estabelecimento_w
and	a.cd_convenio						= cd_convenio_w
and	coalesce(a.cd_categoria, cd_categoria_w)				= cd_categoria_w
and 	coalesce(a.ie_tipo_atendimento,ie_tipo_atendimento_w) 		= ie_tipo_atendimento_w 
and	coalesce(a.cd_material, cd_material_w)				= cd_material_w
and	coalesce(a.cd_grupo_material, cd_grupo_material_w)			= cd_grupo_material_w
and	coalesce(a.cd_subgrupo_material, cd_subgrupo_material_w)		= cd_subgrupo_material_w
and	coalesce(a.cd_classe_material, cd_classe_material_w)			= cd_classe_material_w
and	coalesce(CASE WHEN ie_data_ref_tab_mat_w='D' THEN  dt_material_w  ELSE dt_entrada_w END , clock_timestamp()) between establishment_timezone_utils.startofday(a.dt_inicio_vigencia) and establishment_timezone_utils.startofday(coalesce(a.dt_final_vigencia,coalesce(CASE WHEN ie_data_ref_tab_mat_w='D' THEN  dt_material_w  ELSE dt_entrada_w END , clock_timestamp())+1)) + 89399/89400
and	coalesce(a.ie_situacao,'A') = 'A'
and	((coalesce(cd_tab_preco_material, coalesce(cd_tab_preco_material_w,'00'))	= coalesce(cd_tab_preco_material_w,'00')) or
	 ((cd_tab_preco_material_w = '00') and (coalesce(cd_tab_preco_material::text, '') = '')))
and 	coalesce(a.cd_setor_atendimento, cd_setor_atendimento_w)		= cd_setor_atendimento_w
and	coalesce(a.ie_origem_preco, coalesce(ie_origem_preco_mat_w,0))		= coalesce(ie_origem_preco_mat_w,0)
and	coalesce(a.nr_seq_familia, coalesce(nr_seq_familia_w,0))			= coalesce(nr_seq_familia_w,0)
and	((coalesce(a.ie_material_tuss,'A') = 'A') or (coalesce(a.ie_material_tuss,'A') = 'S' and coalesce(cd_material_tuss_w,0) <> 0) or (coalesce(a.ie_material_tuss,'A') = 'N' and coalesce(cd_material_tuss_w,0) = 0))
and	((coalesce(ie_pacote, 'T') = 'T') or	 
	 ((coalesce(ie_pacote, 'T') = 'I') and (nr_seq_proc_pacote_w IS NOT NULL AND nr_seq_proc_pacote_w::text <> '')) or
	 ((coalesce(ie_pacote, 'T') = 'F') and (coalesce(nr_seq_proc_pacote_w::text, '') = '')))
and	((coalesce(vl_unitario_mat_w,0) >= coalesce(a.vl_inicial,0)) and (coalesce(vl_unitario_mat_w,0) <= coalesce(a.vl_final,999999999)))	 
and 	coalesce(a.ie_tipo_material, coalesce(ie_tipo_material_w , '0')) = coalesce(ie_tipo_material_w, '0')
and	((coalesce(cd_grupo::text, '') = '') or (cd_grupo = cd_grupo_w))
order	by ie_prioridade desc,
	coalesce(ie_tipo_atendimento,0),
	coalesce(cd_material, 0),
	coalesce(cd_classe_material, 0),
	coalesce(cd_subgrupo_material, 0),
	coalesce(cd_grupo_material, 0),
	coalesce(cd_grupo, 0),
	coalesce(a.cd_setor_atendimento, 0),
	coalesce(a.ie_origem_preco,0),
	coalesce(a.vl_inicial,0),
	a.dt_inicio_vigencia,
	coalesce(a.nr_seq_familia,0),
	coalesce(a.ie_tipo_material, '0');

c03 CURSOR FOR
SELECT	a.nr_seq_tiss_tabela,
	coalesce(a.ie_cod_material, 'T'),
	coalesce(a.ie_conversao_externa, 'S'),
	a.cd_adicional,
	coalesce(a.ie_desc_material, 'N'),
	a.cd_material_tiss,
	a.ds_material_tiss,
	coalesce(a.ie_registro_anvisa,'N'),
	ie_prioridade
from 	tiss_regra_tabela_mat a
where	a.cd_estabelecimento					= cd_estabelecimento_w
and	a.cd_convenio						= cd_convenio_w
and	coalesce(a.cd_categoria, cd_categoria_w)				= cd_categoria_w
and 	coalesce(a.ie_tipo_atendimento,ie_tipo_atendimento_w) 		= ie_tipo_atendimento_w 
and	coalesce(a.cd_material, cd_material_w)				= cd_material_w
and	coalesce(a.cd_grupo_material, cd_grupo_material_w)			= cd_grupo_material_w
and	coalesce(a.cd_subgrupo_material, cd_subgrupo_material_w)		= cd_subgrupo_material_w
and	coalesce(a.cd_classe_material, cd_classe_material_w)			= cd_classe_material_w
and	coalesce(CASE WHEN ie_data_ref_tab_mat_w='D' THEN  dt_material_w  ELSE dt_entrada_w END , clock_timestamp()) between establishment_timezone_utils.startofday(a.dt_inicio_vigencia) and establishment_timezone_utils.startofday(coalesce(a.dt_final_vigencia,coalesce(CASE WHEN ie_data_ref_tab_mat_w='D' THEN  dt_material_w  ELSE dt_entrada_w END , clock_timestamp())+1)) + 89399/89400
and	coalesce(a.ie_situacao,'A') = 'A'
and	((coalesce(cd_tab_preco_material, coalesce(cd_tab_preco_material_w,'00'))	= coalesce(cd_tab_preco_material_w,'00')) or
	 ((cd_tab_preco_material_w = '00') and (coalesce(cd_tab_preco_material::text, '') = '')))
and 	coalesce(a.cd_setor_atendimento, cd_setor_atendimento_w)		= cd_setor_atendimento_w
and	coalesce(a.ie_origem_preco, coalesce(ie_origem_preco_mat_w,0))		= coalesce(ie_origem_preco_mat_w,0)
and	coalesce(a.nr_seq_familia, coalesce(nr_seq_familia_w,0))			= coalesce(nr_seq_familia_w,0)
and	((coalesce(a.ie_material_tuss,'A') = 'A') or (coalesce(a.ie_material_tuss,'A') = 'S' and coalesce(cd_material_tuss_w,0) <> 0) or (coalesce(a.ie_material_tuss,'A') = 'N' and coalesce(cd_material_tuss_w,0) = 0))
and	((coalesce(ie_pacote, 'T') = 'T') or	 
	 ((coalesce(ie_pacote, 'T') = 'I') and (nr_seq_proc_pacote_w IS NOT NULL AND nr_seq_proc_pacote_w::text <> '')) or
	 ((coalesce(ie_pacote, 'T') = 'F') and (coalesce(nr_seq_proc_pacote_w::text, '') = '')))
and	((coalesce(vl_unitario_mat_w,0) >= coalesce(a.vl_inicial,0)) and (coalesce(vl_unitario_mat_w,0) <= coalesce(a.vl_final,999999999)))	 
and 	coalesce(a.ie_tipo_material, coalesce(ie_tipo_material_w , '0')) = coalesce(ie_tipo_material_w, '0')
and	((coalesce(cd_grupo::text, '') = '') or (cd_grupo = cd_grupo_w))
order  by cd_material,
       cd_classe_material,
       cd_subgrupo_material,
       cd_grupo_material,
       cd_grupo,
       ie_prioridade,
       a.cd_setor_atendimento,
       ie_tipo_atendimento,
       a.ie_origem_preco,
       a.vl_inicial,
       a.dt_inicio_vigencia,
       a.nr_seq_familia,
       a.ie_tipo_material;


BEGIN



update	material_atend_paciente
set	cd_cgc_prest_solic_tiss	 = NULL
where	nr_sequencia		= nr_seq_material_p;

select	max(b.cd_estabelecimento),
	max(b.cd_convenio_parametro),
	coalesce(max(a.vl_unitario),0),
	max(a.cd_laboratorio),
	max(a.cd_medicamento),
	max(a.cd_apresentacao),
	max(nr_seq_bras_preco),
	max(b.dt_mesano_referencia),
	max(a.nr_seq_lote_fornec),
	max(nr_seq_conv_simp),
    max(m.cd_fabricante)
into STRICT	cd_estabelecimento_w,
	cd_convenio_w,
	vl_unitario_mat_w,
	cd_lab_brasindice_inf_w,
	cd_med_brasindice_inf_w,
	cd_apres_brasindice_inf_w,
	nr_seq_bras_preco_w,
	dt_mesano_referencia_w,
	nr_seq_lote_fornec_w,
	nr_seq_conv_simp_w,
    part_number_w
from	material_atend_paciente a,
	conta_paciente b,
    material m
where	a.nr_interno_conta	= b.nr_interno_conta
and  m.cd_material = a.cd_material
and	a.nr_sequencia		= nr_seq_material_p;

select	count(*),
	coalesce(max(ie_cod_tiss_brasindice),'N'),
	coalesce(max(ie_data_ref_tab_mat),'D'),
	coalesce(max(ie_atualiza_senha_conta),'N'),
	coalesce(max(ie_atualiza_nr_guia),'N'),
	coalesce(max(ie_cod_tiss_simpro),'N'),
	coalesce(max(ie_digitos_desp), 'N'),
	coalesce(max(ie_material_exec),'N'),
	coalesce(max(ie_senha_mat_guia_proc),'N'),
	coalesce(max(ie_buscar_prioridade_tab_tiss),'N'),
    coalesce(max(ie_ref_fabric_opme),'N')
into STRICT	count_param_w,
	ie_cod_tiss_brasindice_w,
	ie_data_ref_tab_mat_w,
	ie_atualiza_senha_conta_w,
	ie_atualiza_nr_guia_w,
	ie_cod_tiss_simpro_w,
	ie_digitos_desp_w,
	ie_material_exec_w,
	ie_senha_mat_guia_proc_w,
	ie_buscar_prior_tab_tiss_w,
    ie_ref_fabric_opme_w
from	tiss_parametros_convenio
where	cd_convenio		= cd_convenio_w
and	cd_estabelecimento	= cd_estabelecimento_w;

nr_seq_marca_w := 0;
if (coalesce(nr_seq_lote_fornec_w,0) > 0) then
	select	max(nr_seq_marca)
	into STRICT	nr_seq_marca_w
	from	material_lote_fornec
	where	nr_sequencia = nr_seq_lote_fornec_w;
end if;

cd_interno_w	:= Obter_Valor_Conv_Estab(cd_convenio_w, cd_estabelecimento_w, 'CD_REGIONAL');

if (count_param_w = 1) then

	select	max(tiss_obter_versao(cd_convenio_w, cd_estabelecimento_w, dt_mesano_referencia_w))
	into STRICT	ds_versao_w
	;

	ie_continua_w	:= 'S';

	begin
	select	b.cd_estabelecimento,
		c.cd_cgc,
		b.nr_interno_conta,
		d.ie_tipo_atendimento,
		CASE WHEN ie_material_exec_w='S' THEN coalesce(a.cd_material_exec,a.cd_material)  ELSE a.cd_material END ,
		a.cd_material_convenio,
		a.ie_origem_preco,
		b.cd_convenio_parametro,
		b.cd_categoria_parametro,
		a.dt_conta,
		substr(TISS_ELIMINAR_CARACTERE(coalesce(f.ds_material,e.ds_material)),1,150),
		substr(e.ds_material,1,150),
		a.cd_setor_atendimento,
		d.ie_clinica,
		x.ie_tipo_guia,
		tiss_obter_origem_preco_mat(a.ie_origem_preco,
						CASE WHEN ie_material_exec_w='S' THEN coalesce(a.cd_material_exec,a.cd_material)  ELSE a.cd_material END ,
						b.cd_estabelecimento,
						b.cd_convenio_parametro,
						b.cd_categoria_parametro,
						a.cd_tab_preco_material,
						a.dt_conta,
						a.cd_setor_atendimento,
						'X',
						a.nr_seq_proc_pacote,
						a.nr_sequencia,
						a.cd_material_tuss),
		a.cd_cgc_prestador,
		cd_tab_preco_material,
		substr(TISS_ELIMINAR_CARACTERE(e.ds_material),1,150),
		d.cd_medico_resp,
		a.nr_prescricao,
		d.nr_atendimento,
		a.vl_material,
		a.nr_seq_proc_princ,
		d.dt_entrada,
		substr(TISS_ELIMINAR_CARACTERE(f.ds_material),1,150),
		d.cd_medico_referido,
		b.nr_seq_protocolo,
		a.vl_unitario,
		a.qt_material,
		a.ie_responsavel_credito,
		x.cd_tipo_acomodacao,
		d.cd_procedencia,
		a.nr_doc_convenio,
		x.cd_plano_convenio,
		d.nr_seq_classificacao,
		b.ie_status_acerto,
		a.ie_tiss_tipo_despesa,
		a.nr_seq_proc_pacote,
		a.dt_vigencia_tabela,
		b.ie_tipo_atend_conta,
		a.cd_material_tuss,
		coalesce(a.dt_conta, coalesce(a.dt_prescricao, a.dt_atendimento)),
		coalesce(d.dt_alta,clock_timestamp()),
		d.dt_alta,
		CASE WHEN b.ie_status_acerto=1 THEN coalesce(b.dt_conta_definitiva,clock_timestamp())  ELSE coalesce(b.dt_conta_definitiva,coalesce(a.dt_conta, coalesce(a.dt_prescricao, a.dt_atendimento))) END ,
		b.dt_periodo_inicial,
		b.dt_periodo_final,
		a.ds_material_tuss,
		e.nr_seq_familia,
		e.ie_tipo_material,
		f.cd_grupo,
		a.nr_seq_mat_simp,
		a.nr_seq_simp_preco
	into STRICT	cd_estabelecimento_w,
		cd_cgc_estab_w,
		nr_interno_conta_w,		
		ie_tipo_atendimento_w,
		cd_material_w,
		cd_material_convenio_w,
		ie_origem_preco_w,
		cd_convenio_w,
		cd_categoria_w,
		dt_material_w,
		ds_material_tiss_w,
		ds_material_w,
		cd_setor_atendimento_w,
		ie_clinica_w,
		ie_tipo_guia_atend_w,
		ie_origem_tiss_w,
		cd_cgc_prestador_w,
		cd_tab_preco_material_w,
		ds_material_original_w,
		cd_medico_atend_w,
		nr_prescricao_w,
		nr_atendimento_w,
		vl_material_w,
		nr_seq_proc_princ_w,
		dt_entrada_w,
		ds_material_convenio_w,
		cd_medico_referiado_w,
		nr_seq_protocolo_w,
		vl_unitario_w,
		qt_material_w,
		ie_resp_credito_mat_w,
		cd_tipo_acomodacao_w,
		cd_procedencia_w,
		nr_doc_convenio_w,
		cd_plano_w,
		nr_seq_classificacao_atend_w,
		ie_status_acerto_w,
		ie_tipo_despesa_w,
		nr_seq_proc_pacote_w,
		dt_vigencia_tabela_w,
		ie_tipo_atend_conta_w,
		cd_material_tuss_w,
		dt_conta_w,
		dt_altap_w,
		dt_alta_preco_w,
		dt_conta_definitiva_w,
		dt_periodo_inicial_w,
		dt_periodo_final_w,
		ds_material_tuss_w,
		nr_seq_familia_w,
		ie_tipo_material_w,
		cd_grupo_w,
		nr_seq_mat_simp_w,
		nr_seq_simp_preco_w
	FROM atend_categoria_convenio x, material e, atendimento_paciente d, estabelecimento c, conta_paciente b, material_atend_paciente a
LEFT OUTER JOIN mat_atend_pac_convenio f ON (a.nr_sequencia = f.nr_seq_material)
WHERE b.cd_estabelecimento	= c.cd_estabelecimento and a.nr_interno_conta	= b.nr_interno_conta and x.nr_atendimento	= d.nr_atendimento and b.nr_atendimento	= d.nr_atendimento  and ((a.cd_material		= e.cd_material and ie_material_exec_w = 'N') or (coalesce(a.cd_material_exec,a.cd_material)	= e.cd_material and ie_material_exec_w = 'S')) and a.nr_sequencia		= nr_seq_material_p   LIMIT 1;
	exception
	when others then
		ie_continua_w	:= 'N';
	end;

	if (ie_continua_w = 'S') then

		begin
		select 	b.cd_grupo_material,
			b.cd_subgrupo_material,
			b.cd_classe_material,
			a.ie_tipo_material,
			b.ie_tipo_classe,
			substr(obter_dados_material_estab(a.cd_material,cd_estabelecimento_w,'UMS'),1,30)
		into STRICT	cd_grupo_material_w,
			cd_subgrupo_material_w,
			cd_classe_material_w,
			ie_tipo_material_w,
			ie_tipo_classe_w,
			cd_unidade_medida_consumo_w
		from	estrutura_material_v b,
			material a
		where 	a.cd_material		= b.cd_material
		and	a.cd_material		= cd_material_w  LIMIT 1;
		exception
		when others then
			cd_grupo_material_w		:= null;
			cd_subgrupo_material_w		:= null;
			cd_classe_material_w		:= null;
			ie_tipo_material_w		:= null;
			ie_tipo_classe_w		:= null;
			cd_unidade_medida_consumo_w	:= null;
		end;

		begin
		select	coalesce(ie_fixar_vig_brasindice,'N')
		into STRICT	ie_fixar_vig_brasindice_w
		from	convenio_estabelecimento
		where	cd_convenio		= cd_convenio_w
		and	cd_estabelecimento	= cd_estabelecimento_w;	
		exception
		when others then
			ie_fixar_vig_brasindice_w	:= 'N';
		end;

		select 	coalesce(max(cd_tab_preco_mat),0)
		into STRICT	cd_tab_preco_mat_regra_w
		from 	regra_data_preco_mat
		where 	ie_situacao = 'A'
		and 	cd_convenio = cd_convenio_w
		and 	cd_estabelecimento = cd_estabelecimento_w;

		qt_preco_mat_w:= 0;
		if (cd_tab_preco_mat_regra_w > 0) then
			select 	count(*)
			into STRICT	qt_preco_mat_w
			from 	preco_material
			where 	cd_tab_preco_mat = cd_tab_preco_mat_regra_w
			and 	cd_estabelecimento    = cd_estabelecimento_w
			and 	cd_material	      = cd_material_w
			and	establishment_timezone_utils.startofday(dt_conta_w) between coalesce(establishment_timezone_utils.startofday(dt_inicio_vigencia), clock_timestamp() - interval '3650 days') and coalesce(dt_final_vigencia, dt_conta_w);
		end if;

		if (qt_preco_mat_w > 0) then

			dt_preco_w:= dt_conta_w;

		else

			select	obter_regra_data_preco('M',cd_convenio_w, dt_entrada_w, dt_conta_w, dt_alta_preco_w, dt_conta_definitiva_w, null, dt_periodo_inicial_w, dt_periodo_final_w)
			into STRICT	dt_preco_w
			;

		end if;

		dt_vigencia_mat_w	:= coalesce(dt_preco_w, clock_timestamp());
		if (ie_fixar_vig_brasindice_w = 'S') then
			dt_vigencia_mat_w	:= dt_vigencia_tabela_w;
		end if;

		if (ie_atualiza_senha_conta_w = 'S') then
			select	max(cd_senha)		
			into STRICT	cd_senha_item_w
			from	atend_categoria_convenio
			where	nr_atendimento	= nr_atendimento_w
			and	obter_atecaco_atendimento(nr_atendimento) = nr_seq_interno;
		end if;
		
		if (coalesce(ie_origem_preco_w, 0) <> 0) then
			if (ie_origem_preco_w not in (1,4)) then
				ie_origem_preco_mat_w	:= 2;			/*2- Tabela de preco*/
			
			else
				ie_origem_preco_mat_w	:= ie_origem_preco_w; 	/*1- Brasindice, 4-Simpro*/
			end if;
		end if;
		
		cd_material_tuss_conta_w := cd_material_tuss_w;
		
		if (ie_origem_preco_mat_w = 1) then --Braqsindice
			cd_material_brasindice_w		:= obter_codigo_brasindice(cd_estabelecimento_w, cd_material_w, dt_vigencia_mat_w,cd_convenio_w, nr_seq_marca_w);
			cd_laboratorio_w			:= obter_valor_separador(cd_material_brasindice_w,1,';');
			cd_medicamento_w			:= obter_valor_separador(cd_material_brasindice_w,2,';');
			cd_apresentacao_w			:= obter_valor_separador(cd_material_brasindice_w,3,';');
			
			if (nr_seq_bras_preco_w > 0) then
				
				select 	coalesce(max(cd_medicamento),cd_medicamento_w),
					coalesce(max(cd_laboratorio), cd_laboratorio_w),
					coalesce(max(cd_apresentacao), cd_apresentacao_w)
				into STRICT	cd_medicamento_w,
					cd_laboratorio_w,
					cd_apresentacao_w
				from 	brasindice_preco
				where 	nr_sequencia = nr_seq_bras_preco_w;
				
			end if;
			
			if (cd_lab_brasindice_inf_w IS NOT NULL AND cd_lab_brasindice_inf_w::text <> '') and (cd_med_brasindice_inf_w IS NOT NULL AND cd_med_brasindice_inf_w::text <> '') and (cd_apres_brasindice_inf_w IS NOT NULL AND cd_apres_brasindice_inf_w::text <> '') then
				cd_laboratorio_w := cd_lab_brasindice_inf_w;
				cd_medicamento_w := cd_med_brasindice_inf_w;
				cd_apresentacao_w:= cd_apres_brasindice_inf_w;
			end if;
			
			if (ie_fixar_vig_brasindice_w = 'S') then
				cd_material_tuss_bras_w	:= somente_numero(tiss_obter_cod_tuss_bras_vigen(cd_apresentacao_w, cd_laboratorio_w, cd_medicamento_w,dt_vigencia_tabela_w, nr_seq_bras_preco_w));
			else
				cd_material_tuss_bras_w	:= somente_numero(tiss_obter_cod_tuss_bras_vigen(cd_apresentacao_w, cd_laboratorio_w, cd_medicamento_w,null, nr_seq_bras_preco_w));
			end if;
			
			if (coalesce(cd_material_tuss_bras_w,0) > 0) then
				cd_material_tuss_w	:= cd_material_tuss_bras_w;
			end if;
			
			
			begin
				select	substr(a.ds_material,1,255)
				into STRICT	ds_material_tuss_w
				from	tuss_material_item a,
					tuss_material b
				where	a.nr_seq_carga_tuss	= b.nr_sequencia
				and	(b.dt_liberacao IS NOT NULL AND b.dt_liberacao::text <> '')
				and	a.cd_material_tuss	= cd_material_tuss_w  LIMIT 1;
			exception
			when others then
				ds_material_tuss_w		:= null;
			end;
			
		elsif (ie_origem_preco_mat_w = 4) then --Simpro
		
		
			if	coalesce(NR_SEQ_SIMP_PRECO_w,0) > 0  then
				
				select 	max(cd_tuss)
				into STRICT 	cd_material_tuss_simpro_w
				from	simpro_preco
				where 	nr_sequencia = NR_SEQ_SIMP_PRECO_w;
				
			else
			
				cd_material_tuss_simpro_w := TISS_OBTER_TUSS_SIMPRO(cd_material_w, cd_estabelecimento_w, cd_convenio_w, dt_material_w, nr_seq_marca_w);
								
			end if;
			
			if (coalesce(cd_material_tuss_simpro_w,0) > 0) then
				cd_material_tuss_w		:= cd_material_tuss_simpro_w;
			end if;
			
			begin
				select	substr(a.ds_material,1,255)
				into STRICT	ds_material_tuss_w
				from	tuss_material_item a,
					tuss_material b
				where	a.nr_seq_carga_tuss	= b.nr_sequencia
				and	(b.dt_liberacao IS NOT NULL AND b.dt_liberacao::text <> '')
				and	a.cd_material_tuss	= cd_material_tuss_w  LIMIT 1;
			exception
			when others then
				ds_material_tuss_w		:= null;
			end;
		end if;					

		nr_seq_tiss_tabela_w	:= null;
		
		select	count(1)
		into STRICT	qt_mat_conversao_w
		from	mat_atend_pac_convenio
		where	nr_seq_material = nr_seq_material_p
		and	(cd_material IS NOT NULL AND cd_material::text <> '')  LIMIT 1;
		
		ds_material_esp_w           := ds_material_tiss_w;
		cd_material_tiss_w			:= null;
		ds_material_tiss_w			:= null;
		
		i := 0;
		
		if (coalesce(ie_buscar_prior_tab_tiss_w,'N') = 'N') then
		
			open c02;
			loop
			fetch c02 into
				nr_seq_tiss_tabela_w,
				ie_codigo_material_w,
				ie_conversao_externa_w,
				cd_adicional_w,
				ie_desc_material_w,
				cd_mat_conv_regra_w,
				ds_mat_conv_regra_w,
				ie_registro_anvisa_w;
			EXIT WHEN NOT FOUND; /* apply on c02 */
				
			end loop;
			close c02;
			
			
			/*tiss_regra_tabela_mat_pck.gerar_regras(cd_convenio_w, cd_estabelecimento_w);
			tiss_regra_tabela_mat_pck.obter_regras(	cd_estabelecimento_w,
								cd_convenio_w,
								cd_categoria_w,
								ie_tipo_atendimento_w,
								cd_material_w,
								cd_grupo_material_w,
								cd_subgrupo_material_w,
								cd_classe_material_w,
								ie_data_ref_tab_mat_w,
								dt_material_w,
								dt_entrada_w,
								cd_tab_preco_material_w,
								cd_setor_atendimento_w,
								ie_origem_preco_mat_w,
								nr_seq_familia_w,
								cd_material_tuss_w,
								nr_seq_proc_pacote_w,
								vl_unitario_mat_w,
								ie_tipo_material_w,
								cd_grupo_w,
								nr_seq_tiss_tabela_w,
								ie_codigo_material_w,
								ie_conversao_externa_w,
								cd_adicional_w,
								ie_desc_material_w,
								cd_mat_conv_regra_w,
								ds_mat_conv_regra_w,
								ie_registro_anvisa_w);*/
			
			lista_regras_w[i].nr_seq_tiss_tabela	:= nr_seq_tiss_tabela_w;
			lista_regras_w[i].ie_cod_material	:= ie_codigo_material_w;	
			lista_regras_w[i].ie_conversao_externa	:= ie_conversao_externa_w;
			lista_regras_w[i].cd_adicional		:= cd_adicional_w;
			lista_regras_w[i].ie_desc_material	:= ie_desc_material_w;
			lista_regras_w[i].cd_material_tiss	:= cd_mat_conv_regra_w;
			lista_regras_w[i].ds_material_tiss	:= ds_mat_conv_regra_w;
			lista_regras_w[i].ie_registro_anvisa	:= ie_registro_anvisa_w;
			
			
		else
			open c03;
			loop
			fetch c03 into
				nr_seq_tiss_tabela_w,
				ie_codigo_material_w,
				ie_conversao_externa_w,
				cd_adicional_w,
				ie_desc_material_w,
				cd_mat_conv_regra_w,
				ds_mat_conv_regra_w,
				ie_registro_anvisa_w,
				ie_prioridade_w;
			EXIT WHEN NOT FOUND; /* apply on c03 */
			
			
			lista_regras_w[i].nr_seq_tiss_tabela	:= nr_seq_tiss_tabela_w;
			lista_regras_w[i].ie_cod_material	:= ie_codigo_material_w;	
			lista_regras_w[i].ie_conversao_externa	:= ie_conversao_externa_w;
			lista_regras_w[i].cd_adicional		:= cd_adicional_w;
			lista_regras_w[i].ie_desc_material	:= ie_desc_material_w;
			lista_regras_w[i].cd_material_tiss	:= cd_mat_conv_regra_w;
			lista_regras_w[i].ds_material_tiss	:= ds_mat_conv_regra_w;
			lista_regras_w[i].ie_registro_anvisa	:= ie_registro_anvisa_w;
			lista_regras_w[i].ie_prioridade		:= ie_prioridade_w;
			
			i := i + 1;
				
			end loop;
			close c03;
		end if;
		
		i	:= 0;
		for i in 0..lista_regras_w.count - 1 loop
		
			if (coalesce(cd_material_tiss_w,'0') = '0') then
			
				if (lista_regras_w[i]coalesce(.nr_seq_tiss_tabela::text, '') = '') then	
					if (ie_tipo_material_w = 1) then		/* Materiais */
						if (ie_origem_preco_w = 1) then	/* Brasindice */
							nr_seq_tiss_tabela_w	:= 4;
						elsif (ie_origem_preco_w = 4) then	/* Simpro */
							nr_seq_tiss_tabela_w	:= 11;
						elsif (ie_origem_preco_w = 2) then	/* Tabela preco */
							nr_seq_tiss_tabela_w	:= 15;
						end if;

					elsif (ie_tipo_material_w in (2,3)) then	/* Medicamentos */
						if (ie_origem_preco_w = 1) then	/* Brasindice */
							nr_seq_tiss_tabela_w	:= 4;
						elsif (ie_origem_preco_w = 4) then	/* Simpro */
							nr_seq_tiss_tabela_w	:= 11;
						elsif (ie_origem_preco_w = 2) then	/* Tabela preco */
							nr_seq_tiss_tabela_w	:= 16;
						end if;
						
					elsif (ie_tipo_material_w = 5) then	/* Generos Alimenticios */
					
						if (ie_origem_preco_w = 1) then	/* Brasindice */
							nr_seq_tiss_tabela_w	:= 4;
						elsif (ie_origem_preco_w = 4) then	/* Simpro */
							nr_seq_tiss_tabela_w	:= 11;
						elsif (ie_origem_preco_w = 2) then	/* Tabela preco */
							nr_seq_tiss_tabela_w	:= 15;
						end if;

					end if;
				else
					nr_seq_tiss_tabela_w := lista_regras_w[i].nr_seq_tiss_tabela;
				end if;
				
				
				cd_adicional_w		:= lista_regras_w[i].cd_adicional;
				/*cd_material_tiss_w			:= null;
				ds_material_tiss_w			:= null;*/
				if (coalesce(lista_regras_w[i].ie_conversao_externa, 'S') = 'S') then
					if	((cd_material_convenio_w IS NOT NULL AND cd_material_convenio_w::text <> '') and
						 ((cd_material_convenio_w <> to_char(cd_material_w)) or (qt_mat_conversao_w > 0))) then
						cd_material_tiss_w		:= cd_material_convenio_w;
					end if;
					if	((ds_material_convenio_w IS NOT NULL AND ds_material_convenio_w::text <> '') and (ds_material_convenio_w <> to_char(ds_material_w))) then
						ds_material_tiss_w		:= ds_material_convenio_w;
					end if;
				elsif (coalesce(lista_regras_w[i].ie_conversao_externa, 'N') = 'N') then
					if (lista_regras_w[i](.ds_material_tiss IS NOT NULL AND .ds_material_tiss::text <> ''))  then
						ds_material_tiss_w		:= lista_regras_w[i].ds_material_tiss;
					else
						ds_material_tiss_w		:= null; --lhalves 11/04/2012 - 435713 - Se esta para nao considerar a conversao, tem que ficar 'null' por causa do IF abaixo, senao nao pega o codigo TISS.
					end if;
					if (lista_regras_w[i](.cd_material_tiss IS NOT NULL AND .cd_material_tiss::text <> '')) then
						cd_material_tiss_w		:= lista_regras_w[i].cd_material_tiss;
					else
						cd_material_tiss_w		:= null; --lhalves 11/04/2012 - 435713 - Se esta para nao considerar a conversao, tem que ficar 'null' por causa do IF abaixo, senao nao pega o codigo TISS.
					end if;
				elsif (coalesce(lista_regras_w[i].ie_conversao_externa, 'N') = 'C') then --lhalves OS240565 em 02/09/2010
					if	((cd_material_convenio_w IS NOT NULL AND cd_material_convenio_w::text <> '') and
						 ((cd_material_convenio_w <> to_char(cd_material_w)) or (qt_mat_conversao_w > 0))) then
						cd_material_tiss_w		:= cd_material_convenio_w;
					end if;
				end if;

				/*Inicio lhalves OS240565 em 23/08/2010
				Separado a estrutura para setar o cd_material_tiss da estrutura do ds_material_tiss*/
				if (coalesce(cd_material_tiss_w,'0') = '0') then
					if (coalesce(lista_regras_w[i].ie_cod_material, 'O') = 'O') then	-- se nao tiver regra deve pegar o codigo da origem do valor
						if (ie_origem_preco_w	= 1) or (ie_origem_tiss_w	= '05') then
							cd_material_brasindice_w		:= obter_codigo_brasindice(cd_estabelecimento_w, cd_material_w, dt_vigencia_mat_w,cd_convenio_w, nr_seq_marca_w);
							cd_laboratorio_w			:= obter_valor_separador(cd_material_brasindice_w,1,';');
							cd_medicamento_w			:= obter_valor_separador(cd_material_brasindice_w,2,';');
							cd_apresentacao_w			:= obter_valor_separador(cd_material_brasindice_w,3,';');
							
							if (nr_seq_bras_preco_w > 0) then
								
								select 	coalesce(max(cd_medicamento),cd_medicamento_w),
									coalesce(max(cd_laboratorio), cd_laboratorio_w),
									coalesce(max(cd_apresentacao), cd_apresentacao_w)
								into STRICT	cd_medicamento_w,
									cd_laboratorio_w,
									cd_apresentacao_w
								from 	brasindice_preco
								where 	nr_sequencia = nr_seq_bras_preco_w;
								
							end if;
							
							if (cd_lab_brasindice_inf_w IS NOT NULL AND cd_lab_brasindice_inf_w::text <> '') and (cd_med_brasindice_inf_w IS NOT NULL AND cd_med_brasindice_inf_w::text <> '') and (cd_apres_brasindice_inf_w IS NOT NULL AND cd_apres_brasindice_inf_w::text <> '') then
								cd_laboratorio_w := cd_lab_brasindice_inf_w;
								cd_medicamento_w := cd_med_brasindice_inf_w;
								cd_apresentacao_w:= cd_apres_brasindice_inf_w;
							end if;			
							
							if (ie_cod_tiss_brasindice_w = 'N') then
								if (ie_fixar_vig_brasindice_w = 'S') then
									cd_material_tiss_w		:= tiss_obter_cod_bras_vigen(cd_apresentacao_w, cd_laboratorio_w, cd_medicamento_w,dt_vigencia_tabela_w);
								else				
									cd_material_tiss_w		:= tiss_obter_cod_brasindice(cd_apresentacao_w, cd_laboratorio_w, cd_medicamento_w);
								end if;
							elsif (ie_cod_tiss_brasindice_w = 'B') then
								cd_material_tiss_w		:= replace(obter_codigo_brasindice(cd_estabelecimento_w, cd_material_w, dt_vigencia_mat_w,cd_convenio_w, nr_seq_marca_w), ';','');
							end if;
							if (coalesce(cd_material_tiss_w,'0') = '0') then
								cd_material_tiss_w		:= replace(cd_medicamento_w,';','');
							end if;
						elsif (ie_origem_preco_w = 4) or (ie_origem_tiss_w  = '12') then			
							if (ie_cod_tiss_simpro_w = 'N') then
								select	max(TISS_OBTER_CODIGO_SIMPRO(cd_material_w, cd_estabelecimento_w, cd_convenio_w, dt_material_w,nr_seq_marca_w, nr_seq_mat_simp_w))
								into STRICT	cd_material_tiss_w				
								;			
							elsif (ie_cod_tiss_simpro_w = 'B') then														
								select	max(Obter_Codigo_Simpro2(cd_material_w,cd_convenio_w,cd_estabelecimento_w,dt_material_w, nr_seq_conv_simp_w, nr_seq_marca_w, nr_seq_mat_simp_w))
								into STRICT	cd_material_tiss_w
								;			
							end if;				
							
						end if;
					elsif (lista_regras_w[i].ie_cod_material = 'T') then

						select	max(CD_TABELA_XML)
						into STRICT	CD_TABELA_XML_w
						from	tiss_tipo_tabela
						where	nr_sequencia	= nr_seq_tiss_tabela_w;

						if (CD_TABELA_XML_w = '05') then
							cd_material_brasindice_w		:= obter_codigo_brasindice(cd_estabelecimento_w, cd_material_w, dt_vigencia_mat_w,cd_convenio_w, nr_seq_marca_w);
							cd_laboratorio_w			:= obter_valor_separador(cd_material_brasindice_w,1,';');
							cd_medicamento_w			:= obter_valor_separador(cd_material_brasindice_w,2,';');
							cd_apresentacao_w			:= obter_valor_separador(cd_material_brasindice_w,3,';');

							if (nr_seq_bras_preco_w > 0) then
								
								select 	coalesce(max(cd_medicamento),cd_medicamento_w),
									coalesce(max(cd_laboratorio), cd_laboratorio_w),
									coalesce(max(cd_apresentacao), cd_apresentacao_w)
								into STRICT	cd_medicamento_w,
									cd_laboratorio_w,
									cd_apresentacao_w
								from 	brasindice_preco
								where 	nr_sequencia = nr_seq_bras_preco_w;
								
							end if;
							
							if (cd_lab_brasindice_inf_w IS NOT NULL AND cd_lab_brasindice_inf_w::text <> '') and (cd_med_brasindice_inf_w IS NOT NULL AND cd_med_brasindice_inf_w::text <> '') and (cd_apres_brasindice_inf_w IS NOT NULL AND cd_apres_brasindice_inf_w::text <> '') then
								cd_laboratorio_w := cd_lab_brasindice_inf_w;
								cd_medicamento_w := cd_med_brasindice_inf_w;
								cd_apresentacao_w:= cd_apres_brasindice_inf_w;
							end if;
							
							if (ie_cod_tiss_brasindice_w = 'N') then
								if (ie_fixar_vig_brasindice_w = 'S') then
									cd_material_tiss_w		:= tiss_obter_cod_bras_vigen(cd_apresentacao_w, cd_laboratorio_w, cd_medicamento_w,dt_vigencia_tabela_w);
								else
									cd_material_tiss_w		:= tiss_obter_cod_brasindice(cd_apresentacao_w, cd_laboratorio_w, cd_medicamento_w);
								end if;
							elsif (ie_cod_tiss_brasindice_w = 'B') then
								cd_material_tiss_w		:= replace(obter_codigo_brasindice(cd_estabelecimento_w, cd_material_w, dt_vigencia_mat_w,cd_convenio_w, nr_seq_marca_w),';','');				
							end if;

							if (coalesce(cd_material_tiss_w, '0') = '0') then
								cd_material_tiss_w		:= replace(cd_medicamento_w, ';','');
							end if;
						elsif (CD_TABELA_XML_w = '12') then
							if (ie_cod_tiss_simpro_w = 'N') then
								select	max(TISS_OBTER_CODIGO_SIMPRO(cd_material_w, cd_estabelecimento_w, cd_convenio_w, dt_material_w,nr_seq_marca_w, nr_seq_mat_simp_w))
								into STRICT	cd_material_tiss_w				
								;			
							elsif (ie_cod_tiss_simpro_w = 'B') then								
								select	max(Obter_Codigo_Simpro2(cd_material_w,cd_convenio_w,cd_estabelecimento_w,dt_material_w, nr_seq_conv_simp_w, nr_seq_marca_w, nr_seq_mat_simp_w))
								into STRICT	cd_material_tiss_w
								;			
							end if;				
							
						end if;

					elsif (lista_regras_w[i].ie_cod_material = 'E') then /*lhalves OS214336 em 10/05/2010 - Gerar codigo EAN no brasindice(apenas 10 primeiros digitos)*/
					
						select	max(CD_TABELA_XML)
						into STRICT	CD_TABELA_XML_w
						from	tiss_tipo_tabela
						where	nr_sequencia	= nr_seq_tiss_tabela_w;		
					
						if (CD_TABELA_XML_w = '05') then
							cd_material_brasindice_w		:= obter_codigo_brasindice(cd_estabelecimento_w, cd_material_w, dt_vigencia_mat_w,cd_convenio_w, nr_seq_marca_w);
							cd_laboratorio_w			:= obter_valor_separador(cd_material_brasindice_w,1,';');
							cd_medicamento_w			:= obter_valor_separador(cd_material_brasindice_w,2,';');
							cd_apresentacao_w			:= obter_valor_separador(cd_material_brasindice_w,3,';');
							
							if (nr_seq_bras_preco_w > 0) then
								
								select 	coalesce(max(cd_medicamento),cd_medicamento_w),
									coalesce(max(cd_laboratorio), cd_laboratorio_w),
									coalesce(max(cd_apresentacao), cd_apresentacao_w)
								into STRICT	cd_medicamento_w,
									cd_laboratorio_w,
									cd_apresentacao_w
								from 	brasindice_preco
								where 	nr_sequencia = nr_seq_bras_preco_w;
								
							end if;
							
							if (cd_lab_brasindice_inf_w IS NOT NULL AND cd_lab_brasindice_inf_w::text <> '') and (cd_med_brasindice_inf_w IS NOT NULL AND cd_med_brasindice_inf_w::text <> '') and (cd_apres_brasindice_inf_w IS NOT NULL AND cd_apres_brasindice_inf_w::text <> '') then
								cd_laboratorio_w := cd_lab_brasindice_inf_w;
								cd_medicamento_w := cd_med_brasindice_inf_w;
								cd_apresentacao_w:= cd_apres_brasindice_inf_w;
							end if;

							if (ie_cod_tiss_brasindice_w = 'N') then				
								cd_material_tiss_w		:= substr(obter_ean_brasindice(cd_apresentacao_w, cd_laboratorio_w, cd_medicamento_w),1,10);
							elsif (ie_cod_tiss_brasindice_w = 'B') then
								cd_material_tiss_w		:= replace(obter_codigo_brasindice(cd_estabelecimento_w, cd_material_w, dt_vigencia_mat_w,cd_convenio_w, nr_seq_marca_w),';','');
							end if;

							if (coalesce(cd_material_tiss_w, '0') = '0') then
								cd_material_tiss_w		:= replace(cd_medicamento_w, ';','');
							end if;
						elsif (CD_TABELA_XML_w = '12') then
							if (ie_cod_tiss_simpro_w = 'N') then
								select	max(TISS_OBTER_CODIGO_SIMPRO(cd_material_w, cd_estabelecimento_w, cd_convenio_w, dt_material_w,nr_seq_marca_w, nr_seq_mat_simp_w))
								into STRICT	cd_material_tiss_w				
								;			
							elsif (ie_cod_tiss_simpro_w = 'B') then
								select	max(Obter_Codigo_Simpro2(cd_material_w,cd_convenio_w,cd_estabelecimento_w,dt_material_w, nr_seq_conv_simp_w, nr_seq_marca_w, nr_seq_mat_simp_w))
								into STRICT	cd_material_tiss_w
								;			
							end if;				
								
						end if;	
						
					elsif (lista_regras_w[i].ie_cod_material = 'A') then /*Registro Anvisa*/
					
						select	max(obter_reg_anvisa_mat(cd_estabelecimento_w,cd_material_w,nr_seq_marca_w,'RA'))
						into STRICT	nr_registro_anvisa_w
						;
						
						if (nr_registro_anvisa_w IS NOT NULL AND nr_registro_anvisa_w::text <> '') then
							cd_material_tiss_w	:= nr_registro_anvisa_w;
						end if;
						
					elsif (lista_regras_w[i].ie_cod_material = 'U') then /*Codigo TUSS do material na tabela origem do preco ou TUSS CONTA*/
					
						if (ie_origem_preco_w = 1) then --Brasindice
							
							if (coalesce(cd_material_tuss_bras_w,0) > 0) then
								cd_material_tiss_w	:= cd_material_tuss_bras_w;	
							end if;
							
							if (coalesce(cd_material_tiss_w, '0') = '0') then
								cd_material_tiss_w		:= cd_material_tuss_w;
							end if;	
						elsif (ie_origem_preco_w = 4) then --Simpro
							
							if (coalesce(cd_material_tuss_simpro_w,0) > 0) then
								cd_material_tiss_w	:= cd_material_tuss_simpro_w;	
							end if;	
							
							if (coalesce(cd_material_tiss_w, '0') = '0') then
								cd_material_tiss_w		:= cd_material_tuss_w;
							end if;	
						else
							cd_material_tiss_w	:= cd_material_tuss_w;		
						end if;
						
						
						
					elsif (lista_regras_w[i].ie_cod_material = 'UT') then /*Codigo TUSS do material na tabela origem do preco*/
					
						if (ie_origem_preco_w = 1) then --Brasindice
							
							if (coalesce(cd_material_tuss_bras_w,0) > 0) then
								cd_material_tiss_w	:= cd_material_tuss_bras_w;
							end if;
							
							
							if (coalesce(cd_material_tiss_w, '0') = '0') then
								cd_material_tiss_w		:= cd_material_tuss_w;
							end if;	
						elsif (ie_origem_preco_w = 4) then --Simpro
							if (coalesce(cd_material_tuss_simpro_w,0) > 0) then
								cd_material_tiss_w	:= cd_material_tuss_simpro_w;	
							end if;
						end if;
							
					elsif (lista_regras_w[i].ie_cod_material = 'UBS') then --Codigo TUSS do Brasindice ou Simpro
					
						if (coalesce(cd_material_tuss_bras_w,0) > 0) then
							cd_material_tiss_w	:= cd_material_tuss_bras_w;
						else			
							cd_material_brasindice_w	:= obter_codigo_brasindice(cd_estabelecimento_w, cd_material_w, dt_vigencia_mat_w,cd_convenio_w, nr_seq_marca_w);
							cd_laboratorio_w			:= obter_valor_separador(cd_material_brasindice_w,1,';');
							cd_medicamento_w			:= obter_valor_separador(cd_material_brasindice_w,2,';');
							cd_apresentacao_w			:= obter_valor_separador(cd_material_brasindice_w,3,';');			
							
							if (cd_lab_brasindice_inf_w IS NOT NULL AND cd_lab_brasindice_inf_w::text <> '') and (cd_med_brasindice_inf_w IS NOT NULL AND cd_med_brasindice_inf_w::text <> '') and (cd_apres_brasindice_inf_w IS NOT NULL AND cd_apres_brasindice_inf_w::text <> '') then
								cd_laboratorio_w := cd_lab_brasindice_inf_w;
								cd_medicamento_w := cd_med_brasindice_inf_w;
								cd_apresentacao_w:= cd_apres_brasindice_inf_w;
							end if;
							
							if (ie_fixar_vig_brasindice_w = 'S') then
								cd_material_tuss_bras_w	:= somente_numero(tiss_obter_cod_tuss_bras_vigen(cd_apresentacao_w, cd_laboratorio_w, cd_medicamento_w,dt_vigencia_tabela_w,nr_seq_bras_preco_w));
							else
								cd_material_tuss_bras_w	:= somente_numero(tiss_obter_cod_tuss_bras_vigen(cd_apresentacao_w, cd_laboratorio_w, cd_medicamento_w,null,nr_seq_bras_preco_w));
							end if;	

							if (coalesce(cd_material_tuss_bras_w,0) > 0) then					
								cd_material_tiss_w	:= cd_material_tuss_bras_w;
								
							else --Se nao encontrou no brasindice, envia do Simpro
							
								if (coalesce(cd_material_tuss_simpro_w,0) > 0) then
									cd_material_tiss_w	:= cd_material_tuss_simpro_w;	
								else
									cd_material_tuss_simpro_w	:= TISS_OBTER_TUSS_SIMPRO(cd_material_w, cd_estabelecimento_w, cd_convenio_w, dt_material_w, nr_seq_marca_w);
									if (coalesce(cd_material_tuss_simpro_w,0) > 0) then
										cd_material_tiss_w	:= cd_material_tuss_simpro_w;	
									/*else	(Nvl(cd_material_tuss_w,0) > 0) then
										cd_material_tiss_w := cd_material_tuss_w;*/
									end if;
								end if;							
							
							end if;	
							
						end if;	
					elsif (lista_regras_w[i].ie_cod_material = 'CBS') then --Codigo TUSS da conta, Brasindice ou Simpro
					
						if (coalesce(cd_material_tuss_conta_w,0) > 0) then
							cd_material_tiss_w := cd_material_tuss_conta_w;
						elsif (coalesce(cd_material_tuss_bras_w,0) > 0) then
							cd_material_tiss_w	:= cd_material_tuss_bras_w;
						else								
							cd_material_brasindice_w	:= obter_codigo_brasindice(cd_estabelecimento_w, cd_material_w, dt_vigencia_mat_w,cd_convenio_w, nr_seq_marca_w);
							cd_laboratorio_w			:= obter_valor_separador(cd_material_brasindice_w,1,';');
							cd_medicamento_w			:= obter_valor_separador(cd_material_brasindice_w,2,';');
							cd_apresentacao_w			:= obter_valor_separador(cd_material_brasindice_w,3,';');		
							
							if (cd_lab_brasindice_inf_w IS NOT NULL AND cd_lab_brasindice_inf_w::text <> '') and (cd_med_brasindice_inf_w IS NOT NULL AND cd_med_brasindice_inf_w::text <> '') and (cd_apres_brasindice_inf_w IS NOT NULL AND cd_apres_brasindice_inf_w::text <> '') then
								cd_laboratorio_w := cd_lab_brasindice_inf_w;
								cd_medicamento_w := cd_med_brasindice_inf_w;
								cd_apresentacao_w:= cd_apres_brasindice_inf_w;
							end if;
							
							if (ie_fixar_vig_brasindice_w = 'S') then
								cd_material_tuss_bras_w	:= somente_numero(tiss_obter_cod_tuss_bras_vigen(cd_apresentacao_w, cd_laboratorio_w, cd_medicamento_w,dt_vigencia_tabela_w,nr_seq_bras_preco_w));
							else
								cd_material_tuss_bras_w	:= somente_numero(tiss_obter_cod_tuss_bras_vigen(cd_apresentacao_w, cd_laboratorio_w, cd_medicamento_w,null,nr_seq_bras_preco_w));
							end if;	

							if (coalesce(cd_material_tuss_bras_w,0) > 0) then					
								cd_material_tiss_w	:= cd_material_tuss_bras_w;
								
							else --Se nao encontrou no brasindice, envia do Simpro
							
								if (coalesce(cd_material_tuss_simpro_w,0) > 0) then
									cd_material_tiss_w	:= cd_material_tuss_simpro_w;	
								else
									cd_material_tuss_simpro_w	:= TISS_OBTER_TUSS_SIMPRO(cd_material_w, cd_estabelecimento_w, cd_convenio_w, dt_material_w, nr_seq_marca_w);
									if (coalesce(cd_material_tuss_simpro_w,0) > 0) then
										cd_material_tiss_w	:= cd_material_tuss_simpro_w;	
									/*else	(Nvl(cd_material_tuss_w,0) > 0) then
										cd_material_tiss_w := cd_material_tuss_w;*/
									end if;
								end if;							
							
							end if;	
							
						end if;	
						
					elsif (lista_regras_w[i].ie_cod_material = 'UB') then --Codigo TUSS do Brasindice
					
						if (coalesce(cd_material_tuss_bras_w,0) > 0) then
							cd_material_tiss_w	:= cd_material_tuss_bras_w;
						else	
							cd_material_brasindice_w	:= obter_codigo_brasindice(cd_estabelecimento_w, cd_material_w, dt_vigencia_mat_w,cd_convenio_w, nr_seq_marca_w);
							cd_laboratorio_w			:= obter_valor_separador(cd_material_brasindice_w,1,';');
							cd_medicamento_w			:= obter_valor_separador(cd_material_brasindice_w,2,';');
							cd_apresentacao_w			:= obter_valor_separador(cd_material_brasindice_w,3,';');			
							
							if (cd_lab_brasindice_inf_w IS NOT NULL AND cd_lab_brasindice_inf_w::text <> '') and (cd_med_brasindice_inf_w IS NOT NULL AND cd_med_brasindice_inf_w::text <> '') and (cd_apres_brasindice_inf_w IS NOT NULL AND cd_apres_brasindice_inf_w::text <> '') then
								cd_laboratorio_w := cd_lab_brasindice_inf_w;
								cd_medicamento_w := cd_med_brasindice_inf_w;
								cd_apresentacao_w:= cd_apres_brasindice_inf_w;
							end if;
							
							if (ie_fixar_vig_brasindice_w = 'S') then
								cd_material_tuss_bras_w	:= somente_numero(tiss_obter_cod_tuss_bras_vigen(cd_apresentacao_w, cd_laboratorio_w, cd_medicamento_w,dt_vigencia_tabela_w,nr_seq_bras_preco_w));
							else
								cd_material_tuss_bras_w	:= somente_numero(tiss_obter_cod_tuss_bras_vigen(cd_apresentacao_w, cd_laboratorio_w, cd_medicamento_w,null,nr_seq_bras_preco_w));
							end if;	

							if (coalesce(cd_material_tuss_bras_w,0) > 0) then					
								cd_material_tiss_w	:= cd_material_tuss_bras_w;
							/*elsif	(Nvl(cd_material_tuss_w,0) > 0) then
								cd_material_tiss_w := cd_material_tuss_w;*/
							end if;
						end if;		
					elsif (lista_regras_w[i].ie_cod_material = 'UIB') then --Codigo TUSS ou TISS do Brasindice
					
						if (coalesce(cd_material_tuss_bras_w,0) > 0) then
							cd_material_tiss_w	:= cd_material_tuss_bras_w;
						else								
							cd_material_brasindice_w	:= obter_codigo_brasindice(cd_estabelecimento_w, cd_material_w, dt_vigencia_mat_w,cd_convenio_w, nr_seq_marca_w);
							cd_laboratorio_w			:= obter_valor_separador(cd_material_brasindice_w,1,';');
							cd_medicamento_w			:= obter_valor_separador(cd_material_brasindice_w,2,';');
							cd_apresentacao_w			:= obter_valor_separador(cd_material_brasindice_w,3,';');			
							
							if (cd_lab_brasindice_inf_w IS NOT NULL AND cd_lab_brasindice_inf_w::text <> '') and (cd_med_brasindice_inf_w IS NOT NULL AND cd_med_brasindice_inf_w::text <> '') and (cd_apres_brasindice_inf_w IS NOT NULL AND cd_apres_brasindice_inf_w::text <> '') then
								cd_laboratorio_w := cd_lab_brasindice_inf_w;
								cd_medicamento_w := cd_med_brasindice_inf_w;
								cd_apresentacao_w:= cd_apres_brasindice_inf_w;
							end if;
							
							if (ie_fixar_vig_brasindice_w = 'S') then
								cd_material_tuss_bras_w	:= somente_numero(tiss_obter_cod_tuss_bras_vigen(cd_apresentacao_w, cd_laboratorio_w, cd_medicamento_w,dt_vigencia_tabela_w,nr_seq_bras_preco_w));
							else
								cd_material_tuss_bras_w	:= somente_numero(tiss_obter_cod_tuss_bras_vigen(cd_apresentacao_w, cd_laboratorio_w, cd_medicamento_w,null,nr_seq_bras_preco_w));
							end if;	
							
						end if;	

						if (coalesce(cd_material_tuss_bras_w,0) > 0) then					
								cd_material_tiss_w	:= cd_material_tuss_bras_w;
						elsif (coalesce(cd_material_tuss_bras_w,0) = 0) then
						
							if (ie_fixar_vig_brasindice_w = 'S') then
								cd_material_tiss_w		:= tiss_obter_cod_bras_vigen(cd_apresentacao_w, cd_laboratorio_w, cd_medicamento_w,dt_vigencia_tabela_w);
							else				
								cd_material_tiss_w		:= tiss_obter_cod_brasindice(cd_apresentacao_w, cd_laboratorio_w, cd_medicamento_w);
							end if;
							
						end if;
					elsif (lista_regras_w[i].ie_cod_material = 'US') then --Codigo TUSS do Simpro			
						
						if (coalesce(cd_material_tuss_simpro_w,0) > 0) then
							cd_material_tiss_w	:= cd_material_tuss_simpro_w;	
						else
							cd_material_tuss_simpro_w	:= TISS_OBTER_TUSS_SIMPRO(cd_material_w, cd_estabelecimento_w, cd_convenio_w, dt_material_w, nr_seq_marca_w);
							if (coalesce(cd_material_tuss_simpro_w,0) > 0) then
								cd_material_tiss_w	:= cd_material_tuss_simpro_w;	
							end if;
						end if;
					elsif (lista_regras_w[i].ie_cod_material = 'MS') then -- Codigo do material no Simpro
					
						if (ie_cod_tiss_simpro_w = 'N') then
							select	max(TISS_OBTER_CODIGO_SIMPRO(cd_material_w, cd_estabelecimento_w, cd_convenio_w, dt_material_w,nr_seq_marca_w, nr_seq_mat_simp_w))
							into STRICT	cd_material_tiss_w				
							;			
						elsif (ie_cod_tiss_simpro_w = 'B') then							
							select	max(Obter_Codigo_Simpro2(cd_material_w,cd_convenio_w,cd_estabelecimento_w,dt_material_w, nr_seq_conv_simp_w, nr_seq_marca_w, nr_seq_mat_simp_w))
							into STRICT	cd_material_tiss_w
							;			
						end if;	
					elsif (lista_regras_w[i].ie_cod_material = 'TB') then -- Codigo TISS no Brasindice
					
							
							if (cd_lab_brasindice_inf_w IS NOT NULL AND cd_lab_brasindice_inf_w::text <> '') and (cd_med_brasindice_inf_w IS NOT NULL AND cd_med_brasindice_inf_w::text <> '') and (cd_apres_brasindice_inf_w IS NOT NULL AND cd_apres_brasindice_inf_w::text <> '') then
								
								cd_laboratorio_w := cd_lab_brasindice_inf_w;
								cd_medicamento_w := cd_med_brasindice_inf_w;
								cd_apresentacao_w:= cd_apres_brasindice_inf_w;
							
							elsif (nr_seq_bras_preco_w > 0) then
								
								select 	coalesce(max(cd_medicamento),cd_medicamento_w),
									coalesce(max(cd_laboratorio), cd_laboratorio_w),
									coalesce(max(cd_apresentacao), cd_apresentacao_w)
								into STRICT	cd_medicamento_w,
									cd_laboratorio_w,
									cd_apresentacao_w
								from 	brasindice_preco
								where 	nr_sequencia = nr_seq_bras_preco_w;
								
							else
								cd_material_brasindice_w		:= obter_codigo_brasindice(cd_estabelecimento_w, cd_material_w, dt_vigencia_mat_w,cd_convenio_w, nr_seq_marca_w);
								cd_laboratorio_w			:= obter_valor_separador(cd_material_brasindice_w,1,';');
								cd_medicamento_w			:= obter_valor_separador(cd_material_brasindice_w,2,';');
								cd_apresentacao_w			:= obter_valor_separador(cd_material_brasindice_w,3,';');
								
							end if;
							
					
						if (ie_fixar_vig_brasindice_w = 'S') then
							cd_material_tiss_w		:= tiss_obter_cod_bras_vigen(cd_apresentacao_w, cd_laboratorio_w, cd_medicamento_w,dt_vigencia_tabela_w);
						else				
							cd_material_tiss_w		:= tiss_obter_cod_brasindice(cd_apresentacao_w, cd_laboratorio_w, cd_medicamento_w);
						end if;
				
					end if;
				end if;
				
				--Para evitar que  codigo seja exportado zerado na guia e XML
											
				begin
					cd_mat_tiss_number_w := coalesce((cd_material_tiss_w)::numeric ,-1);
				exception
				when others then
					cd_mat_tiss_number_w := -1;
				end;								

				if (coalesce(cd_material_tuss_w,0) = cd_mat_tiss_number_w) then
					ie_origem_codigo_w := 'T'; --TUSS
				end if;

				/*Na versao 3.0 somente deve enviar o registro ANVISA se OPME que nao possuir codigo TUSS*/

				if (obter_se_projeto_versao(0,12,ds_versao_w,0) = 'S') and (ie_tipo_despesa_w = '8') then

				    if (lista_regras_w[i].ie_registro_anvisa = 'S') and (coalesce(cd_material_tuss_w,0) <> coalesce(cd_mat_tiss_number_w,-1)) then

						    select	tiss_obter_dados_marca(cd_estabelecimento_w,cd_material_w,nr_seq_marca_prescr_w,cd_cgc_consig_w,nr_seq_lote_fornec_w,nr_seq_material_p,'RA'),
							    substr(tiss_obter_dados_marca(cd_estabelecimento_w,cd_material_w,null,null,nr_seq_lote_fornec_w,nr_seq_material_p,'CF'),1,30)cd_ref_fabricante
						    into STRICT	nr_registro_anvisa_tiss_w,
							    cd_ref_fabricante_w
						;
				
				    end if;

				    if  coalesce(cd_ref_fabricante_w::text, '') = ''
					and (part_number_w IS NOT NULL AND part_number_w::text <> '')
					and (coalesce(ie_ref_fabric_opme_w,'N') = 'S') then 

					cd_ref_fabricante_w := part_number_w;
				    end if;
				end if;

				if (coalesce(ds_material_tiss_w::text, '') = '') then
					
					select	max(CD_TABELA_XML)
					into STRICT	CD_TABELA_XML_w
					from	tiss_tipo_tabela
					where	nr_sequencia	= nr_seq_tiss_tabela_w;									
										
					if (coalesce(lista_regras_w[i].ie_desc_material,'N') = 'N') then --  ( Descricao da tabela VALOR PADRAO PARA INICIALIZAR A BUSCA PELA DESCRICAO)
					
						if (CD_TABELA_XML_w = '05') then
						
							ds_material_tiss_w		:= Obter_Dados_Brasindice(cd_estabelecimento_w, cd_material_w, dt_vigencia_mat_w, cd_convenio_w, 'DMED');
							
						elsif (CD_TABELA_XML_w = '12') then
						
							select	max(Obter_Desc_Simpro(TISS_OBTER_CODIGO_SIMPRO(cd_material_w, cd_estabelecimento_w, cd_convenio_w, dt_material_w,nr_seq_marca_w, nr_seq_mat_simp_w)))
							into STRICT	ds_material_tiss_w
							;
							
						elsif (CD_TABELA_XML_w in ('95','96')) and
							((coalesce(ds_material_convenio_w::text, '') = '') or (ds_material_convenio_w = to_char(ds_material_w))) then	
							
							ds_material_tiss_w	:= Obter_Dados_Brasindice(cd_estabelecimento_w, cd_material_w, dt_vigencia_mat_w, cd_convenio_w, 'DMED');
							
						elsif (CD_TABELA_XML_w in ('19','20')) then
						
							if (coalesce(ie_origem_preco_mat_w,1) = 1) and ((Obter_Dados_Brasindice(cd_estabelecimento_w, cd_material_w, dt_vigencia_mat_w, cd_convenio_w, 'DMED') IS NOT NULL AND (Obter_Dados_Brasindice(cd_estabelecimento_w, cd_material_w, dt_vigencia_mat_w, cd_convenio_w, 'DMED'))::text <> '')) then
								ds_material_tiss_w		:= Obter_Dados_Brasindice(cd_estabelecimento_w, cd_material_w, dt_vigencia_mat_w, cd_convenio_w, 'DMED');
							elsif (coalesce(ie_origem_preco_mat_w,4) = 4) and (Obter_Desc_Simpro(TISS_OBTER_CODIGO_SIMPRO(cd_material_w, cd_estabelecimento_w, cd_convenio_w, dt_material_w,nr_seq_marca_w, nr_seq_mat_simp_w)) is not null) then
								
								ds_material_tiss_w := Obter_Desc_Simpro(TISS_OBTER_CODIGO_SIMPRO(cd_material_w, cd_estabelecimento_w, cd_convenio_w, dt_material_w,nr_seq_marca_w, nr_seq_mat_simp_w));
								
							end if;	
						/*else	
							if	(nvl(ie_origem_preco_mat_w,1) = 1) and
								(Obter_Dados_Brasindice(cd_estabelecimento_w, cd_material_w, dt_vigencia_mat_w, cd_convenio_w, 'DMED') is not null) then
								ds_material_tiss_w		:= Obter_Dados_Brasindice(cd_estabelecimento_w, cd_material_w, dt_vigencia_mat_w, cd_convenio_w, 'DMED');
							elsif 	(nvl(ie_origem_preco_mat_w,4) = 4) and 
								(Obter_Desc_Simpro(TISS_OBTER_CODIGO_SIMPRO(cd_material_w, cd_estabelecimento_w, cd_convenio_w, dt_material_w,nr_seq_marca_w)) is not null) then
								
								ds_material_tiss_w := Obter_Desc_Simpro(TISS_OBTER_CODIGO_SIMPRO(cd_material_w, cd_estabelecimento_w, cd_convenio_w, dt_material_w,nr_seq_marca_w));
							end if;	*/
							
						end if;
						
					elsif (coalesce(lista_regras_w[i].ie_desc_material,'N') = 'S') then --S - Descricao do cadastro de materiais
						/*if	(CD_TABELA_XML_w = '12') then 
							ds_material_tiss_w := null;
							O TRATAMENTO PARA ATRIBUIR NULL QUANDO FOR TABELA SIMPRO NAO SERA FEITO NESTE MOMENTO
							APENAS SE FOR EXIBIDO UMA JUSTIFICATIVA PARA ISSO (SITUACAO EM OS)
						end if; */
						ds_material_tiss_w	:= ds_material_w;
					elsif (coalesce(lista_regras_w[i].ie_desc_material,'N') = 'B') then -- B - Descricao da apresentacao (Somente p/ Brasindice) 
					
						cd_material_brasindice_w	:= obter_codigo_brasindice(cd_estabelecimento_w, cd_material_w, dt_vigencia_mat_w,cd_convenio_w, nr_seq_marca_w);
						cd_laboratorio_w		:= obter_valor_separador(cd_material_brasindice_w,1,';');
						cd_medicamento_w		:= obter_valor_separador(cd_material_brasindice_w,2,';');
						cd_apresentacao_w		:= obter_valor_separador(cd_material_brasindice_w,3,';');

						if (cd_lab_brasindice_inf_w IS NOT NULL AND cd_lab_brasindice_inf_w::text <> '') and (cd_med_brasindice_inf_w IS NOT NULL AND cd_med_brasindice_inf_w::text <> '') and (cd_apres_brasindice_inf_w IS NOT NULL AND cd_apres_brasindice_inf_w::text <> '') then
								cd_laboratorio_w := cd_lab_brasindice_inf_w;
								cd_medicamento_w := cd_med_brasindice_inf_w;
								cd_apresentacao_w:= cd_apres_brasindice_inf_w;
						end if;
										
						if (cd_laboratorio_w IS NOT NULL AND cd_laboratorio_w::text <> '') and (cd_medicamento_w IS NOT NULL AND cd_medicamento_w::text <> '') and (cd_apresentacao_w IS NOT NULL AND cd_apresentacao_w::text <> '') then	
							ds_material_tiss_w := obter_desc_brasindice(cd_laboratorio_w,cd_apresentacao_w,cd_medicamento_w,'A');	
						else
							ds_material_tiss_w := Obter_Dados_Brasindice(cd_estabelecimento_w, cd_material_w, dt_vigencia_mat_w, cd_convenio_w, 'DAPR');	
						end if;					
						
						
					elsif (coalesce(lista_regras_w[i].ie_desc_material,'N') = 'M') then -- M - Descricao da apresentacao e laboratorio
					
						cd_material_brasindice_w	:= obter_codigo_brasindice(cd_estabelecimento_w, cd_material_w, dt_vigencia_mat_w,cd_convenio_w, nr_seq_marca_w);
						cd_laboratorio_w		:= obter_valor_separador(cd_material_brasindice_w,1,';');
						cd_medicamento_w		:= obter_valor_separador(cd_material_brasindice_w,2,';');
						cd_apresentacao_w		:= obter_valor_separador(cd_material_brasindice_w,3,';');

						if (cd_lab_brasindice_inf_w IS NOT NULL AND cd_lab_brasindice_inf_w::text <> '') and (cd_med_brasindice_inf_w IS NOT NULL AND cd_med_brasindice_inf_w::text <> '') and (cd_apres_brasindice_inf_w IS NOT NULL AND cd_apres_brasindice_inf_w::text <> '') then
								cd_laboratorio_w := cd_lab_brasindice_inf_w;
								cd_medicamento_w := cd_med_brasindice_inf_w;
								cd_apresentacao_w:= cd_apres_brasindice_inf_w;
						end if;
										
						if (cd_laboratorio_w IS NOT NULL AND cd_laboratorio_w::text <> '') and (cd_medicamento_w IS NOT NULL AND cd_medicamento_w::text <> '') and (cd_apresentacao_w IS NOT NULL AND cd_apresentacao_w::text <> '') then	
							ds_material_tiss_w := obter_desc_brasindice(cd_laboratorio_w,cd_apresentacao_w,cd_medicamento_w,'L') ||' '||
										obter_desc_brasindice(cd_laboratorio_w,cd_apresentacao_w,cd_medicamento_w,'A');	
						else
							ds_material_tiss_w := Obter_Dados_Brasindice(cd_estabelecimento_w, cd_material_w, dt_vigencia_mat_w, cd_convenio_w, 'DLAB')||' '||
										Obter_Dados_Brasindice(cd_estabelecimento_w, cd_material_w, dt_vigencia_mat_w, cd_convenio_w, 'DAPR');	
						end if;	
									
					elsif (coalesce(lista_regras_w[i].ie_desc_material,'N') = 'L') then -- L - Descricao do medicamento no brasindice e laboratorio
					
						cd_material_brasindice_w	:= obter_codigo_brasindice(cd_estabelecimento_w, cd_material_w, dt_vigencia_mat_w,cd_convenio_w, nr_seq_marca_w);
						cd_laboratorio_w		:= obter_valor_separador(cd_material_brasindice_w,1,';');
						cd_medicamento_w		:= obter_valor_separador(cd_material_brasindice_w,2,';');
						cd_apresentacao_w		:= obter_valor_separador(cd_material_brasindice_w,3,';');

						if (cd_lab_brasindice_inf_w IS NOT NULL AND cd_lab_brasindice_inf_w::text <> '') and (cd_med_brasindice_inf_w IS NOT NULL AND cd_med_brasindice_inf_w::text <> '') and (cd_apres_brasindice_inf_w IS NOT NULL AND cd_apres_brasindice_inf_w::text <> '') then
								cd_laboratorio_w := cd_lab_brasindice_inf_w;
								cd_medicamento_w := cd_med_brasindice_inf_w;
								cd_apresentacao_w:= cd_apres_brasindice_inf_w;
						end if;
										
						if (cd_laboratorio_w IS NOT NULL AND cd_laboratorio_w::text <> '') and (cd_medicamento_w IS NOT NULL AND cd_medicamento_w::text <> '') and (cd_apresentacao_w IS NOT NULL AND cd_apresentacao_w::text <> '') then	
							ds_material_tiss_w := obter_desc_brasindice(cd_laboratorio_w,cd_apresentacao_w,cd_medicamento_w,'M') ||' '||
										obter_desc_brasindice(cd_laboratorio_w,cd_apresentacao_w,cd_medicamento_w,'L');	
						else
							ds_material_tiss_w := Obter_Dados_Brasindice(cd_estabelecimento_w, cd_material_w, dt_vigencia_mat_w, cd_convenio_w, 'DMED')||' '||
										Obter_Dados_Brasindice(cd_estabelecimento_w, cd_material_w, dt_vigencia_mat_w, cd_convenio_w, 'DLAB');	
						end if;
									
					elsif (coalesce(lista_regras_w[i].ie_desc_material,'N') = 'C') then --C - Descricao do cadastro de materiais e laboratorio Brasindice
								     
						cd_material_brasindice_w	:= obter_codigo_brasindice(cd_estabelecimento_w, cd_material_w, dt_vigencia_mat_w,cd_convenio_w, nr_seq_marca_w);
						cd_laboratorio_w		:= obter_valor_separador(cd_material_brasindice_w,1,';');
						cd_medicamento_w		:= obter_valor_separador(cd_material_brasindice_w,2,';');
						cd_apresentacao_w		:= obter_valor_separador(cd_material_brasindice_w,3,';');

						if (cd_lab_brasindice_inf_w IS NOT NULL AND cd_lab_brasindice_inf_w::text <> '') and (cd_med_brasindice_inf_w IS NOT NULL AND cd_med_brasindice_inf_w::text <> '') and (cd_apres_brasindice_inf_w IS NOT NULL AND cd_apres_brasindice_inf_w::text <> '') then
								cd_laboratorio_w := cd_lab_brasindice_inf_w;
								cd_medicamento_w := cd_med_brasindice_inf_w;
								cd_apresentacao_w:= cd_apres_brasindice_inf_w;
						end if;
										
						if (cd_laboratorio_w IS NOT NULL AND cd_laboratorio_w::text <> '') and (cd_medicamento_w IS NOT NULL AND cd_medicamento_w::text <> '') and (cd_apresentacao_w IS NOT NULL AND cd_apresentacao_w::text <> '') then	
							ds_material_tiss_w := ds_material_original_w || ' - ' || obter_desc_brasindice(cd_laboratorio_w,cd_apresentacao_w,cd_medicamento_w,'L');	
						else
							ds_material_tiss_w := ds_material_original_w || ' - ' || Obter_Dados_Brasindice(cd_estabelecimento_w, cd_material_w, dt_vigencia_mat_w, cd_convenio_w, 'DLAB');	
						end if;
									
									     
					elsif (coalesce(lista_regras_w[i].ie_desc_material,'N') = 'U') then -- U - Descricao do med + lab + apres + U.M. consumo (Brasindice)
						
						cd_material_brasindice_w	:= obter_codigo_brasindice(cd_estabelecimento_w, cd_material_w, dt_vigencia_mat_w,cd_convenio_w, nr_seq_marca_w);
						cd_laboratorio_w			:= obter_valor_separador(cd_material_brasindice_w,1,';');
						cd_medicamento_w			:= obter_valor_separador(cd_material_brasindice_w,2,';');
						cd_apresentacao_w			:= obter_valor_separador(cd_material_brasindice_w,3,';');

						if (cd_lab_brasindice_inf_w IS NOT NULL AND cd_lab_brasindice_inf_w::text <> '') and (cd_med_brasindice_inf_w IS NOT NULL AND cd_med_brasindice_inf_w::text <> '') and (cd_apres_brasindice_inf_w IS NOT NULL AND cd_apres_brasindice_inf_w::text <> '') then
								cd_laboratorio_w := cd_lab_brasindice_inf_w;
								cd_medicamento_w := cd_med_brasindice_inf_w;
								cd_apresentacao_w:= cd_apres_brasindice_inf_w;
						end if;
										
						if (cd_laboratorio_w IS NOT NULL AND cd_laboratorio_w::text <> '') and (cd_medicamento_w IS NOT NULL AND cd_medicamento_w::text <> '') and (cd_apresentacao_w IS NOT NULL AND cd_apresentacao_w::text <> '') then	
							ds_material_tiss_w := 	substr((obter_desc_brasindice(cd_laboratorio_w,cd_apresentacao_w,cd_medicamento_w,'M') ||' '||
										obter_desc_brasindice(cd_laboratorio_w,cd_apresentacao_w,cd_medicamento_w,'L') ||' '||
										obter_desc_brasindice(cd_laboratorio_w,cd_apresentacao_w,cd_medicamento_w,'A') ||' '||
										Obter_Desc_Unid_Med(cd_unidade_medida_consumo_w)),1,255);	
						else
							ds_material_tiss_w := 	substr((Obter_Dados_Brasindice(cd_estabelecimento_w, cd_material_w, dt_vigencia_mat_w, cd_convenio_w, 'DMED')||' '||
										Obter_Dados_Brasindice(cd_estabelecimento_w, cd_material_w, dt_vigencia_mat_w, cd_convenio_w, 'DLAB')||' '||
										Obter_Dados_Brasindice(cd_estabelecimento_w, cd_material_w, dt_vigencia_mat_w, cd_convenio_w, 'DAPR')),1,255);
										/*Se possuir descricao braindice + desc unidade,caso nao tenha enviar descricao mat/med*/

										if (trim(both coalesce(ds_material_tiss_w,'X')) <> 'X') then										
											ds_material_tiss_w  :=  substr(ds_material_tiss_w ||' '|| Obter_Desc_Unid_Med(cd_unidade_medida_consumo_w),1,255);	
										else
											 ds_material_tiss_w := ds_material_w;									
										end if;	
						end if;						

					elsif (coalesce(lista_regras_w[i].ie_desc_material,'N') = 'T') then -- T - Descricao do material + fabricante + U.M. consumo (Simpro)	
						cd_simpro_w := TISS_OBTER_CODIGO_SIMPRO(cd_material_w, cd_estabelecimento_w, cd_convenio_w, dt_material_w,nr_seq_marca_w, nr_seq_mat_simp_w);	
						
						if (cd_simpro_w IS NOT NULL AND cd_simpro_w::text <> '')then
							ds_material_tiss_w := substr((Obter_Desc_Simpro(cd_simpro_w) ||' '||obter_desc_fabric_simpro(cd_simpro_w) ||' '||Obter_Desc_Unid_Med(cd_unidade_medida_consumo_w)),1,255);
						end if;	
						
															
					elsif (coalesce(lista_regras_w[i].ie_desc_material,'N') = 'A') then -- A - Descricao do medicamento + apresentacao (Brasindice)
										
						cd_material_brasindice_w	:= obter_codigo_brasindice(cd_estabelecimento_w, cd_material_w, dt_vigencia_mat_w,cd_convenio_w, nr_seq_marca_w);
						cd_laboratorio_w			:= obter_valor_separador(cd_material_brasindice_w,1,';');
						cd_medicamento_w			:= obter_valor_separador(cd_material_brasindice_w,2,';');
						cd_apresentacao_w			:= obter_valor_separador(cd_material_brasindice_w,3,';');

						if (cd_lab_brasindice_inf_w IS NOT NULL AND cd_lab_brasindice_inf_w::text <> '') and (cd_med_brasindice_inf_w IS NOT NULL AND cd_med_brasindice_inf_w::text <> '') and (cd_apres_brasindice_inf_w IS NOT NULL AND cd_apres_brasindice_inf_w::text <> '') then
								cd_laboratorio_w := cd_lab_brasindice_inf_w;
								cd_medicamento_w := cd_med_brasindice_inf_w;
								cd_apresentacao_w:= cd_apres_brasindice_inf_w;
						end if;
										
						if (cd_laboratorio_w IS NOT NULL AND cd_laboratorio_w::text <> '') and (cd_medicamento_w IS NOT NULL AND cd_medicamento_w::text <> '') and (cd_apresentacao_w IS NOT NULL AND cd_apresentacao_w::text <> '') then	
							ds_material_tiss_w := obter_desc_brasindice(cd_laboratorio_w,cd_apresentacao_w,cd_medicamento_w,'M') ||' '|| obter_desc_brasindice(cd_laboratorio_w,cd_apresentacao_w,cd_medicamento_w,'A');	
						else
							ds_material_tiss_w:= substr((Obter_Dados_Brasindice(cd_estabelecimento_w, cd_material_w, dt_vigencia_mat_w, cd_convenio_w, 'DMED') || ' - ' ||
										Obter_Dados_Brasindice(cd_estabelecimento_w, cd_material_w, dt_vigencia_mat_w, cd_convenio_w, 'DAPR')),1,255);
						end if;
							
										
					elsif (coalesce(lista_regras_w[i].ie_desc_material,'N') = 'F') then -- F - Descricao do material + Fabricante (Simpro)
					
						ds_material_tiss_w := substr(coalesce(Obter_Desc_Simpro(TISS_OBTER_CODIGO_SIMPRO(cd_material_w, cd_estabelecimento_w, cd_convenio_w, dt_material_w,nr_seq_marca_w, nr_seq_mat_simp_w)),'')
									|| ' ' || coalesce(obter_desc_fabric_simpro(Obter_Codigo_Simpro(cd_material_w)),''),1,255);								
										
					elsif (coalesce(lista_regras_w[i].ie_desc_material,'N') = 'D') then -- D - Descricao conversao ou TUSS ou cadastro de materiais			
						ds_material_tiss_w	:= substr(coalesce(coalesce(ds_material_convenio_w,ds_material_tuss_w),ds_material_w),1,255);
					elsif (coalesce(lista_regras_w[i].ie_desc_material,'N') = 'E') then --Descricao TUSS
						ds_material_tiss_w	:= substr(coalesce(ds_material_tuss_w,ds_material_w),1,255);
						
					elsif (coalesce(lista_regras_w[i].ie_desc_material,'N') = 'P')  then		
					
						if (coalesce(ie_origem_preco_mat_w,1) = 1) and ((Obter_Dados_Brasindice(cd_estabelecimento_w, cd_material_w, dt_vigencia_mat_w, cd_convenio_w, 'DMED') IS NOT NULL AND (Obter_Dados_Brasindice(cd_estabelecimento_w, cd_material_w, dt_vigencia_mat_w, cd_convenio_w, 'DMED'))::text <> '')) then
							ds_material_tiss_w		:= Obter_Dados_Brasindice(cd_estabelecimento_w, cd_material_w, dt_vigencia_mat_w, cd_convenio_w, 'DMED');
						elsif (coalesce(ie_origem_preco_mat_w,4) = 4) and (Obter_Desc_Simpro(TISS_OBTER_CODIGO_SIMPRO(cd_material_w, cd_estabelecimento_w, cd_convenio_w, dt_material_w,nr_seq_marca_w, nr_seq_mat_simp_w)) is not null) then
							
							ds_material_tiss_w := Obter_Desc_Simpro(TISS_OBTER_CODIGO_SIMPRO(cd_material_w, cd_estabelecimento_w, cd_convenio_w, dt_material_w,nr_seq_marca_w, nr_seq_mat_simp_w));
						end if;	

					end if;
				end if;
			end if;
			
		end loop;
		
		if (coalesce(cd_material_tiss_w,'0') = '0') then
			cd_material_tiss_w	:= cd_material_w;
		end if;

		if (nr_prescricao_w IS NOT NULL AND nr_prescricao_w::text <> '') then
			select	max(cd_cgc_solic)
			into STRICT	cd_cgc_solic_prest_w
			from	prescr_medica
			where	nr_prescricao	= nr_prescricao_w;
		end if;

		select	max(ie_tipo_protocolo)
		into STRICT	ie_tipo_protocolo_w
		from	protocolo_convenio a,
			conta_paciente b
		where	a.nr_seq_protocolo	= b.nr_seq_protocolo
		and	b.nr_interno_conta	= nr_interno_conta_w;

		SELECT * FROM tiss_obter_regra_prestador(		cd_convenio_w, cd_estabelecimento_w, ie_tipo_atendimento_w, ie_responsavel_credito_w, ie_clinica_w, cd_cgc_prestador_w, cd_setor_atendimento_w, cd_medico_atend_w, cd_medico_atend_w, cd_categoria_w, null, null, 7, 'N', cd_cgc_prestador_tiss_w, cd_prestador_w, ds_prestador_tiss_w, cd_medico_exec_tiss_w, cd_cgc_prest_solic_tiss_w, nr_seq_regra_prestador_w, 'M', ie_solicitante_w, cd_cgc_solic_prest_w, ie_medico_exec_w, cd_prestador_solic_w, ds_prestador_solic_w, dt_material_w, 'N', cd_medico_referiado_w, cd_tipo_acomodacao_w, cd_procedencia_w, cd_plano_w, nr_seq_classificacao_atend_w, 'N', 'N', ie_tipo_atend_conta_w, ie_tipo_protocolo_w) INTO STRICT cd_cgc_prestador_tiss_w, cd_prestador_w, ds_prestador_tiss_w, cd_medico_exec_tiss_w, cd_cgc_prest_solic_tiss_w, nr_seq_regra_prestador_w, ie_solicitante_w, ie_medico_exec_w, cd_prestador_solic_w, ds_prestador_solic_w;

		/*dsantos em 15/09/2009 OS*/

		if (coalesce(ie_solicitante_w,'N') = 'S') then
			select	max(a.cd_cgc_solic)
			into STRICT	cd_cgc_prest_solic_tiss_w
			from	prescr_medica a
			where	a.nr_prescricao		= nr_prescricao_w
			and	a.nr_atendimento	= nr_atendimento_w;
		end if;

		ie_guia_honor_w := TISS_OBTER_REGRA_GUIA_DESP(cd_estabelecimento_w, cd_convenio_w, ie_tipo_atendimento_w, ie_guia_honor_w);

		if (ie_tipo_classe_w in ('O','P','M')) then
			ds_campo_w		:= 'DS_OPM';
			ds_OPM_regra_w		:= ds_material_tiss_w;
		else
			ds_campo_w		:= 'DS_DESPESA';
			ds_desp_regra_w		:= coalesce(ds_material_tiss_w, ds_material_esp_w);
		end if;

		select	max(cd_classif_setor)
		into STRICT	cd_classif_setor_w
		from	setor_atendimento
		where	cd_setor_atendimento	= cd_setor_atendimento_w;


		/*lhalves OS 482132 em 14/08/2012*/

		if (cd_adicional_w IS NOT NULL AND cd_adicional_w::text <> '') then
			if (cd_material_tiss_w IS NOT NULL AND cd_material_tiss_w::text <> '') then
				cd_material_tiss_w	:= cd_adicional_w || cd_material_tiss_w;
			else
				cd_material_tiss_w	:= cd_adicional_w || cd_material_w;	
			end if;
		end if;


		ds_material_tiss_w		:= coalesce(tiss_obter_campo_esp(cd_convenio_w,
								cd_estabelecimento_w,
								ds_campo_w,
								null,
								ds_desp_regra_w,
								ds_opm_regra_w,
								cd_classif_setor_w,
								null,
								null,
								null,
								ie_tipo_protocolo_w,
								ie_tipo_guia_atend_w,
								cd_interno_w,
								null,
								null,
								null,
								cd_setor_atendimento_w,
								ie_tipo_atendimento_w,
								cd_cgc_prestador_w,
								null,
								null,
								nr_interno_conta_w,
								nr_prescricao_w, 
								null, 
								null, 
								coalesce(cd_material_convenio_w,to_char(cd_material_w)),
								null,
								cd_material_w), ds_material_tiss_w);

		if (coalesce(nr_seq_proc_princ_w,0) > 0) then
			select	coalesce(a.vl_materiais,0)
			into STRICT	vl_mat_proc_princ_w
			from	procedimento_paciente a
			where	a.nr_sequencia	= nr_seq_proc_princ_w;
		end if;

		vl_material_tiss_w		:= tiss_obter_regra_valor_mat(	cd_estabelecimento_w,
									cd_convenio_w,
									cd_material_w,
									cd_grupo_material_w,
									cd_subgrupo_material_w,
									cd_classe_material_w,
									vl_material_w,
									vl_mat_proc_princ_w,
									cd_setor_atendimento_w,
									ie_resp_credito_mat_w,
									vl_unitario_w,
									qt_material_w,
									ie_tipo_atendimento_w);	

		/*Inicio lhalves OS 362868 em 16/09/2011 - Atualizar numeracao de guia ao atualizar conta TISS*/
							
		if 	((coalesce(ie_atualiza_nr_guia_w,'N') = 'S') or
			 ((coalesce(ie_atualiza_nr_guia_w,'N') = 'P') and (ie_status_acerto_w = 1)) or
			 ((coalesce(ie_atualiza_nr_guia_w,'N') = 'B') and (coalesce(nr_doc_convenio_w, wheb_mensagem_pck.get_texto(1097738)) = wheb_mensagem_pck.get_texto(1097738)))
			) and
			((coalesce(OBTER_TITULO_CONTA_PROTOCOLO(nr_seq_protocolo_w,nr_interno_conta_w)::text, '') = '') and (coalesce(OBTER_TITULO_CONTA(nr_interno_conta_w)::text, '') = '') and (coalesce(somente_numero(obter_nf_conta_protocolo(nr_seq_protocolo_w,nr_interno_conta_w)),0) = 0) ) then
			SELECT * FROM tiss_obter_guia('7', nr_interno_conta_w, nr_doc_convenio_w, 'N', null, cd_cgc_prestador_w, null, null, null, ie_guia_w, null, null, null, cd_setor_atendimento_w, null, null, null, dt_material_w, null, nr_seq_material_p, null, null, null, null, null) INTO STRICT nr_doc_convenio_w, ie_guia_w;
					
			update	material_atend_paciente
			set	nr_doc_convenio	= nr_doc_convenio_w
			where	nr_sequencia	= nr_seq_material_p;
		end if;
		/*Fim lhalves OS 362868*/

				
		if (ie_senha_mat_guia_proc_w = 'S') then
			begin
				select	cd_senha
				into STRICT	cd_senha_item_w
				from	procedimento_paciente
				where	nr_interno_conta	= nr_interno_conta_w
				and	nr_doc_convenio		= nr_doc_convenio_w
				and	coalesce(cd_motivo_exc_conta::text, '') = ''
				and	(cd_senha IS NOT NULL AND cd_senha::text <> '')  LIMIT 1;			
			exception
			when others then
				cd_senha_item_w	:= null;
			end;
		end if;		

		if (ie_digitos_desp_w = 'I') then
		
			if (coalesce(cd_material_tuss_w,0) > 0) then
				ie_codigo_tuss_w := 'S';
			end if;

			cd_material_tiss_w	:= TISS_OBTER_REGRA_CODIGO_DESP(cd_estabelecimento_w,cd_convenio_w,ie_tipo_despesa_w,cd_material_tiss_w,
									cd_material_w,ie_codigo_tuss_w,nr_seq_tiss_tabela_w,ie_origem_preco_mat_w);

		end if;

		update	material_atend_paciente
		set	cd_cgc_prestador_tiss	= coalesce(cd_cgc_prestador_tiss_w, coalesce(cd_cgc_prestador, cd_cgc_estab_w)),
			cd_prestador_tiss	= cd_prestador_w,
			cd_cgc_prest_solic_tiss	= coalesce(cd_cgc_prest_solic_tiss, cd_cgc_prest_solic_tiss_w),
			cd_medico_exec_tiss	= cd_medico_exec_tiss_w,
			nr_seq_tiss_tabela	= nr_seq_tiss_tabela_w,
			cd_material_tiss	= cd_material_tiss_w,
			ds_material_tiss	= substr(ds_material_tiss_w,1,200),
			ie_tiss_desp_honor	= ie_guia_honor_w,
			ds_prestador_tiss	= ds_prestador_tiss_w,
			vl_material_tiss	= vl_material_tiss_w,
			cd_prestador_solic_tiss	= cd_prestador_solic_w,
			ds_prestador_solic_tiss	= ds_prestador_solic_w,
			cd_senha		= coalesce(cd_senha_item_w, cd_senha),
			nr_registro_anvisa_tiss	= nr_registro_anvisa_tiss_w
		where	nr_sequencia		= nr_seq_material_p;

        begin
        select coalesce(max('S'), 'N')
        into STRICT  ie_mat_atend_pac_tiss_w
        from  MAT_ATEND_PAC_TISS
        where nr_seq_material = nr_seq_material_p;

        if (ie_mat_atend_pac_tiss_w = 'S') then
            update  MAT_ATEND_PAC_TISS
                set     dt_atualizacao          = clock_timestamp(),
                        nm_usuario              = nm_usuario_p,
                        IE_ORIGEM_COD_MAT_TISS  = ie_origem_codigo_w,
                        CD_MATERIAL_FABRICANTE  = cd_ref_fabricante_w
            where   nr_seq_material         = nr_seq_material_p;
        else
            insert into MAT_ATEND_PAC_TISS(NR_SEQUENCIA,dt_atualizacao,NM_USUARIO,DT_ATUALIZACAO_NREC,NM_USUARIO_NREC,NR_SEQ_MATERIAL,IE_ORIGEM_COD_MAT_TISS,CD_MATERIAL_FABRICANTE)
            values (nextval('mat_atend_pac_tiss_seq'),clock_timestamp(),nm_usuario_p,clock_timestamp(),nm_usuario_p, nr_seq_material_p, ie_origem_codigo_w,cd_ref_fabricante_w);
        end if;

        end;

	end if;
	
end if;
--if (nvl(wheb_usuario_pck.get_ie_commit, 'S') = 'S') then commit; end if; nao dar commit pois gera erro na trigger
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE tiss_atualizar_material (nr_seq_material_p text, ie_atualizar_todos_p text, nm_usuario_p text) FROM PUBLIC;

