-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE ins_or_upd_nursing_care_enc ( nr_seq_avaliacao_p nursing_care_enc_result.nr_seq_avaliacao%TYPE, nr_seq_item_result_p nursing_care_enc_result.nr_seq_item_result%TYPE, nr_seq_item_p nursing_care_enc_result.nr_seq_item%TYPE ) AS $body$
DECLARE


    nm_usuario_w nursing_care_enc_result.nm_usuario%type := wheb_usuario_pck.get_nm_usuario;
    inserting_w nursing_care_encounter.ie_situacao%type := 'S';
    qt_pontuacao_w           nursing_care_enc_result.qt_pontuacao%TYPE;
    nr_seq_classificacao_w   nursing_care_item.nr_seq_classificacao%TYPE;
    qt_pontuacao_aw          nursing_care_enc_result.qt_pontuacao%TYPE;
    qt_pontuacao_bw          nursing_care_enc_result.qt_pontuacao%TYPE;
    qt_pontuacao_cw          nursing_care_enc_result.qt_pontuacao%TYPE;

BEGIN
    SELECT DISTINCT
        coalesce(MAX(nci.nr_seq_classificacao), 0) classificacao
    INTO STRICT nr_seq_classificacao_w
    FROM
        nursing_care_item nci
    WHERE
        nci.nr_sequencia = nr_seq_item_p;

    SELECT DISTINCT
        coalesce(MAX('N'), 'S') TG_OP = 'INSERT'
    INTO STRICT inserting_w
    FROM
        nursing_care_enc_result ncer
    WHERE
        ncer.nr_seq_avaliacao = nr_seq_avaliacao_p
        AND ncer.nr_seq_item = nr_seq_item_p;

    SELECT
        coalesce(MAX(ncr.qt_ponto), 0) pontuacao
    INTO STRICT qt_pontuacao_w
    FROM
        nursing_care_result ncr
    WHERE
        ncr.nr_sequencia = nr_seq_item_result_p;

    SELECT
        max(qt_pontuacao_a),
        max(qt_pontuacao_b),
        max(qt_pontuacao_c)
    INTO STRICT
        qt_pontuacao_aw,
        qt_pontuacao_bw,
        qt_pontuacao_cw
    FROM
        nursing_care_encounter
    WHERE
        nr_sequencia = nr_seq_avaliacao_p;

    IF inserting_w = 'S' THEN
        INSERT INTO nursing_care_enc_result(
            nr_sequencia,
            dt_atualizacao,
            nm_usuario,
            qt_pontuacao,
            dt_atualizacao_nrec,
            nm_usuario_nrec,
            nr_seq_avaliacao,
            nr_seq_item,
            nr_seq_item_result
        ) VALUES (
            nextval('nursing_care_enc_result_seq'),
            clock_timestamp(),
            nm_usuario_w,
            qt_pontuacao_w,
            clock_timestamp(),
            nm_usuario_w,
            nr_seq_avaliacao_p,
            nr_seq_item_p,
            nr_seq_item_result_p
        );

    ELSE
        UPDATE nursing_care_enc_result
        SET
            nr_seq_item_result = nr_seq_item_result_p,
            qt_pontuacao = qt_pontuacao_w
        WHERE
            nr_seq_avaliacao = nr_seq_avaliacao_p
            AND nr_seq_item = nr_seq_item_p;

    END IF;

    UPDATE nursing_care_encounter
    SET
        qt_pontuacao_a = (
            SELECT
                coalesce(SUM(MAX(ncer.qt_pontuacao)), qt_pontuacao_aw)
            FROM
                nursing_care_enc_result   ncer,
                nursing_care_item         nci,
                nursing_care_result       ncr,
                nursing_care_encounter    nce
            WHERE
                nci.nr_sequencia = ncer.nr_seq_item
                AND ncer.nr_seq_avaliacao = nr_seq_avaliacao_p
                AND nci.nr_seq_classificacao = 'A'
                AND nce.nr_seq_nursing_care = nci.nr_seq_versao
                AND nci.nr_seq_result_default = ncr.nr_sequencia
            GROUP BY
                coalesce(nci.nr_seq_item_sup, nci.nr_sequencia)
        ),
        qt_pontuacao_b = (
            SELECT
                coalesce(SUM(MAX(ncer.qt_pontuacao)), qt_pontuacao_bw)
            FROM
                nursing_care_enc_result   ncer,
                nursing_care_item         nci,
                nursing_care_result       ncr,
                nursing_care_encounter    nce
            WHERE
                nci.nr_sequencia = ncer.nr_seq_item
                AND ncer.nr_seq_avaliacao = nr_seq_avaliacao_p
                AND nci.nr_seq_classificacao = 'B'
                AND nce.nr_seq_nursing_care = nci.nr_seq_versao
                AND nci.nr_seq_result_default = ncr.nr_sequencia
            GROUP BY
                coalesce(nci.nr_seq_item_sup, nci.nr_sequencia)
        ),
        qt_pontuacao_c = (
            SELECT
                coalesce(SUM(MAX(ncer.qt_pontuacao)), qt_pontuacao_cw)
            FROM
                nursing_care_enc_result   ncer,
                nursing_care_item         nci,
                nursing_care_result       ncr,
                nursing_care_encounter    nce
            WHERE
                nci.nr_sequencia = ncer.nr_seq_item
                AND ncer.nr_seq_avaliacao = nr_seq_avaliacao_p
                AND nci.nr_seq_classificacao = 'C'
                AND nce.nr_seq_nursing_care = nci.nr_seq_versao
                AND nci.nr_seq_result_default = ncr.nr_sequencia
            GROUP BY
                coalesce(nci.nr_seq_item_sup, nci.nr_sequencia)
        )
    WHERE
        nr_sequencia = nr_seq_avaliacao_p;

    COMMIT;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ins_or_upd_nursing_care_enc ( nr_seq_avaliacao_p nursing_care_enc_result.nr_seq_avaliacao%TYPE, nr_seq_item_result_p nursing_care_enc_result.nr_seq_item_result%TYPE, nr_seq_item_p nursing_care_enc_result.nr_seq_item%TYPE ) FROM PUBLIC;

