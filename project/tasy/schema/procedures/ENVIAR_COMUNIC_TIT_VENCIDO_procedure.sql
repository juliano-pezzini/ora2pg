-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE enviar_comunic_tit_vencido (cd_estabelecimento_p bigint, qt_venc_inicial_p bigint, ds_lista_perfil_p text, ds_lista_usuario_p text, ie_dia_util_p text, qt_dia_vencido_p bigint) AS $body$
DECLARE


nr_titulo_w			bigint;
ds_titulos_w			varchar(4000);
ds_lista_usuario_w		varchar(2000);
ds_lista_perfil_w		varchar(4000);

C01 CURSOR FOR
	SELECT	nr_titulo
	from	titulo_receber
	where	dt_vencimento	< (trunc(clock_timestamp()) - qt_dia_vencido_p)
	  and	vl_saldo_titulo	> 0
	  and	cd_estabelecimento = cd_estabelecimento_p
	  and	dt_vencimento	< clock_timestamp()
	  and	ie_situacao	= '1'
	  and	ie_dia_util_p	= 'N'
	  and	dt_vencimento	> (trunc(clock_timestamp()) - qt_venc_inicial_p)
	
union

	SELECT	nr_titulo
	from	titulo_receber
	where	obter_qt_dia_util_periodo(dt_vencimento,clock_timestamp(),cd_estabelecimento_p) > qt_dia_vencido_p
	  and	vl_saldo_titulo	> 0
	  and	cd_estabelecimento = cd_estabelecimento_p
	  and	dt_vencimento	< clock_timestamp()
	  and	ie_situacao	= '1'
	  and	ie_dia_util_p	= 'S'
	  and	dt_vencimento	> (trunc(clock_timestamp()) - qt_venc_inicial_p)
	order by nr_titulo desc;


BEGIN

ds_titulos_w		:= ' ';
ds_lista_usuario_w	:= coalesce(ds_lista_usuario_p,' ');
ds_lista_perfil_w	:= coalesce(ds_lista_perfil_p,' ');

open C01;
loop
fetch C01 into
	nr_titulo_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	if (length(coalesce(ds_titulos_w, '0')) < 3000) then
		ds_titulos_w	:= ds_titulos_w || to_char(nr_titulo_w) || ', ';
	end if;
end loop;
close C01;

if (length(ds_titulos_w) > 2) then
	ds_titulos_w	:= substr(ds_titulos_w, 1, length(ds_titulos_w) - 2);
end if;

if (ds_titulos_w <> ' ') then

	insert into comunic_interna(dt_comunicado,
		ds_titulo,
		ds_comunicado,
		nm_usuario,
		dt_atualizacao,
		ie_geral,
		nm_usuario_destino,
		cd_perfil,
		nr_sequencia,
		ie_gerencial,
		nr_seq_classif,
		ds_perfil_adicional,
		cd_setor_destino,
		cd_estab_destino,
		ds_setor_adicional,
		dt_liberacao,
		ds_grupo,
		nm_usuario_oculto)
	values (clock_timestamp(),
		'Comunicado de título a receber em atraso (Alerta Tasy).',
		'Existem títulos a receber vencidos a ' || qt_dia_vencido_p  || ' dias ' ||
		CASE WHEN ie_dia_util_p='S' THEN  'úteis '  ELSE '' END  || 'ou mais.' || chr(13) || 'Títulos: ' || ds_titulos_w,
		'Tasy',
		clock_timestamp(),
		'N',
		ds_lista_usuario_w,
		null,
		nextval('comunic_interna_seq'),
		'N',
		null,
		ds_lista_perfil_w,
		null,
		cd_estabelecimento_p,
		'',
		clock_timestamp(),
		'',
		'');
end if;
commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE enviar_comunic_tit_vencido (cd_estabelecimento_p bigint, qt_venc_inicial_p bigint, ds_lista_perfil_p text, ds_lista_usuario_p text, ie_dia_util_p text, qt_dia_vencido_p bigint) FROM PUBLIC;

