-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_w_eis_conta_consol (cd_procedimento_p bigint, ie_origem_proced_p bigint, dt_inicial_p text, dt_final_p text, ie_tipo_atendimento_p bigint, ie_pacote_p text, ie_definitiva_p text, ie_cancelada_p text, cd_conv_p bigint, cd_convenio_p text) AS $body$
DECLARE

 
nr_interno_conta_w	bigint;
ds_convenio_w		varchar(255);
ds_tipo_item_w		varchar(40);
ds_item_w		varchar(80);
cd_item_w		bigint;
qt_resumo_w		double precision;
vl_resumo_w		double precision;
qt_atendimento_w	bigint;
qt_proced_w		bigint;
qt_atend_w		bigint;

c01 CURSOR FOR 
	SELECT	x.nr_interno_conta 
	from	eis_conta_paciente x 
	where	x.cd_procedimento	= cd_procedimento_p 
	and	x.ie_origem_proced	= ie_origem_proced_p 
	and	x.ie_tipo_atendimento	= ie_tipo_atendimento_p 
	and	((cd_conv_p = 0) or (x.cd_convenio		in (cd_convenio_p))) 
	and	x.dt_referencia 	between to_date(dt_inicial_p, 'dd-mm-yy') and to_date(dt_final_p, 'dd-mm-yy');

c02 CURSOR FOR 
	SELECT	a.ds_convenio, 
		a.ds_tipo_item, 
		a.ds_item, 
		a.cd_item, 
		dividir(qt_atend_w * 100, qt_proced_w) qt_atendimento, 
		sum(a.qt_resumo) qt_resumo, 
		sum(a.vl_item) vl_item 
	from	conta_paciente_custo_v a 
	where	1 = 1 
/*	and	((ie_pacote_p  		= 'N')	or (a.nr_seq_proc_pacote is not null)) 
	and	((ie_definitiva_p	 	= 'N') 	or (b.ie_status_Acerto 	= 2)) 
	and	((ie_cancelada_p	 	= 'S') 	or (b.ie_cancelamento 	is null)) 
	and	((cd_conv_p	 		= 0) 	or (b.cd_convenio_parametro		in (cd_convenio_p)))*/
 
	and	a.nr_interno_conta = nr_interno_conta_w 
	group by	a.ds_convenio, 
			a.ds_tipo_item, 
			a.ds_item, 
			a.cd_item;

 

BEGIN 
 
delete from W_EIS_CONTA_CONSOLidada;
 
 
select	count(distinct(x.nr_interno_conta)) 
into STRICT 	qt_atend_w 
from	eis_conta_paciente x 
where	x.cd_procedimento	= cd_procedimento_p 
and	x.ie_origem_proced	= ie_origem_proced_p 
and	x.ie_tipo_atendimento	= ie_tipo_atendimento_p 
and	((cd_conv_p = 0) or (x.cd_convenio		in (cd_convenio_p))) 
and	x.dt_referencia 	between to_date(dt_inicial_p, 'dd-mm-yy') and to_date(dt_final_p, 'dd-mm-yy');
 
 
 
select	max(EIS_Obter_Atend_Periodo(cd_procedimento_p, ie_origem_proced_p, to_date(dt_inicial_p, 'dd/mm/yy'), 
							to_date(dt_final_p, 'dd/mm/yy'), ie_tipo_atendimento_p)) 
into STRICT	qt_proced_w
;
 
open	c01;
loop 
fetch	c01 into nr_interno_conta_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	begin 
 
	open	c02;
	loop 
	fetch	c02 into 
		ds_convenio_w, 
		ds_tipo_item_w, 
		ds_item_w, 
		cd_item_w, 
		qt_atendimento_w, 
		qt_resumo_w, 
		vl_resumo_w;
	EXIT WHEN NOT FOUND; /* apply on c02 */
		begin 
 
		insert into W_EIS_CONTA_CONSOLIDADA(DS_CONVENIO, 
			DS_TIPO_ITEM, 
			DS_ITEM, 
			CD_ITEM, 
			QT_RESUMO, 
			VL_ITEM, 
			QT_ATENDIMENTO) 
		values (ds_convenio_w,	 
			ds_tipo_item_w, 
			ds_item_w, 
			cd_item_w, 
			qt_resumo_w, 
			vl_resumo_w, 
			qt_atendimento_w);
 
		end;
	end loop;
	close	c02;
 
	end;
end loop;
close	c01;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_w_eis_conta_consol (cd_procedimento_p bigint, ie_origem_proced_p bigint, dt_inicial_p text, dt_final_p text, ie_tipo_atendimento_p bigint, ie_pacote_p text, ie_definitiva_p text, ie_cancelada_p text, cd_conv_p bigint, cd_convenio_p text) FROM PUBLIC;

