-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_lote_imp_exclusao_benef ( nr_contrato_p bigint, nr_intercambio_p bigint, cd_usuario_plano_p text, nr_seq_motivo_rescisao_p bigint, dt_inicial_rescisao_p text, ie_rescisao_tipo_p text, ie_devolucao_carteira_p text, ds_observacao_p text, nr_seq_lote_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint) AS $body$
DECLARE

 
 
/* Procedure utilizada no portal do plano de sa√∫de */
 
 
cd_usuario_plano_imp_w		varchar(30);
nr_seq_segurado_w		bigint;
nr_seq_contrato_w		bigint;
nr_seq_intercambio_w		bigint;
cd_pessoa_fisica_w		varchar(15);
nm_pessoa_fisica_w		varchar(255);
nr_seq_resc_prog_gerada_w	bigint;


BEGIN 
 
if (cd_usuario_plano_p IS NOT NULL AND cd_usuario_plano_p::text <> '') then 
	cd_usuario_plano_imp_w	:= elimina_caracteres_especiais(cd_usuario_plano_p);
	cd_usuario_plano_imp_w	:= somente_numero_char(cd_usuario_plano_imp_w);
	 
	select	coalesce(max(nr_seq_segurado),0) 
	into STRICT	nr_seq_segurado_w 
	from	pls_segurado_carteira 
	where	cd_usuario_plano	= cd_usuario_plano_imp_w;
	 
	if (nr_seq_segurado_w > 0 ) then 
		select	nr_seq_contrato, 
			cd_pessoa_fisica, 
			pls_obter_dados_segurado(nr_sequencia, 'N') 
		into STRICT	nr_seq_contrato_w, 
			cd_pessoa_fisica_w, 
			nm_pessoa_fisica_w 
		from	pls_segurado 
		where	nr_sequencia = nr_seq_segurado_w;
		 
		nr_seq_resc_prog_gerada_w := pls_gerar_rescisao_programada(	null, nr_seq_contrato_w, nr_seq_segurado_w, nr_seq_motivo_rescisao_p, null, to_date(dt_inicial_rescisao_p,'dd/mm/yyyy'), ie_rescisao_tipo_p, ie_devolucao_carteira_p, ds_observacao_p, nm_usuario_p, null, null, 0, null, 'S', nr_seq_resc_prog_gerada_w, null);
		 
		insert into pls_inclusao_beneficiario( 
			nr_sequencia, nm_pessoa_fisica, cd_estabelecimento, 
			ie_status, dt_solicitacao, nr_seq_contrato, 
			ie_tipo_inclusao, ie_tipo_operacao, dt_atualizacao, 
			nr_seq_lote_inclusao, ie_processo, nm_usuario, 
			dt_atualizacao_nrec, nm_usuario_nrec, nr_seq_segurado, 
			nr_seq_motivo_cancelamento, ie_status_mov) 
		values (	nextval('pls_inclusao_beneficiario_seq'), nm_pessoa_fisica_w, cd_estabelecimento_p, 
			'P', clock_timestamp(), nr_seq_contrato_w, 
			'P', 'E', clock_timestamp(), 
			nr_seq_lote_p, 'W', nm_usuario_p, 
			clock_timestamp(), nm_usuario_p, nr_seq_segurado_w, 
			nr_seq_motivo_rescisao_p, '1');
	end if;
end if;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_lote_imp_exclusao_benef ( nr_contrato_p bigint, nr_intercambio_p bigint, cd_usuario_plano_p text, nr_seq_motivo_rescisao_p bigint, dt_inicial_rescisao_p text, ie_rescisao_tipo_p text, ie_devolucao_carteira_p text, ds_observacao_p text, nr_seq_lote_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint) FROM PUBLIC;

