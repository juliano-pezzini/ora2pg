-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE set_main_disease_hosp ( nr_atendimento_p diagnostico_doenca.nr_atendimento%type, cd_pessoa_fisica_p atendimento_paciente.cd_pessoa_fisica%type, cd_doenca_p diagnostico_doenca.cd_doenca%type default null, nr_seq_interno_p diagnostico_doenca.nr_seq_interno%type default null) AS $body$
DECLARE


nr_quantidade_atendimento_w atendimento_paciente_aux.nr_atendimento%type := null;
nr_atendimento_w atendimento_paciente_aux.nr_atendimento%type := null;


BEGIN

    update  diagnostico_doenca
    set     ie_main_hospitalization = 'N'
    where   nr_atendimento in (
        SELECT 
            dd.nr_atendimento
        from 
            diagnostico_doenca dd, 
            atendimento_paciente ap
        where dd.nr_atendimento = ap.nr_atendimento
            and ap.cd_pessoa_fisica = cd_pessoa_fisica_p
    );

    if (cd_doenca_p IS NOT NULL AND cd_doenca_p::text <> '') then 
        update  diagnostico_doenca
        set     ie_main_hospitalization = 'S'
        where   nr_atendimento in (
            SELECT 
                dd.nr_atendimento
            from 
                diagnostico_doenca dd, 
                atendimento_paciente ap
            where dd.nr_atendimento = ap.nr_atendimento
                and ap.cd_pessoa_fisica = cd_pessoa_fisica_p
        ) and cd_doenca = cd_doenca_p and (nr_seq_interno = nr_seq_interno_p or coalesce(nr_seq_interno_p::text, '') = '');

        begin
            select nr_atendimento 
            into STRICT nr_quantidade_atendimento_w 
            from atendimento_paciente_aux 
            where nr_atendimento = nr_atendimento_p;

        exception
          when no_data_found then
            nr_quantidade_atendimento_w := null;
        end;

        if (coalesce(nr_atendimento_p::text, '') = '') then        
            select max(nr_atendimento)
            into STRICT nr_atendimento_w
            from atendimento_paciente
            where cd_pessoa_fisica = cd_pessoa_fisica_p
            order by nr_atendimento desc;
        else
            nr_atendimento_w := nr_atendimento_p;
        end if;

        if (nr_quantidade_atendimento_w IS NOT NULL AND nr_quantidade_atendimento_w::text <> '') then
            update atendimento_paciente_aux set
                DT_ATUALIZACAO = clock_timestamp(),
                NM_USUARIO = wheb_usuario_pck.get_nm_usuario,
                CD_CID_PRINCIPAL = cd_doenca_p,
				nr_seq_interno = nr_seq_interno_p
            where nr_atendimento = nr_atendimento_w;
        else
            insert into atendimento_paciente_aux(
                NR_SEQUENCIA,
                DT_ATUALIZACAO,
                NM_USUARIO,
                DT_ATUALIZACAO_NREC,
                NM_USUARIO_NREC,
                CD_CID_PRINCIPAL,
                NR_ATENDIMENTO,
				NR_SEQ_INTERNO)
            values (
                nextval('atendimento_paciente_aux_seq'),
                clock_timestamp(),
                wheb_usuario_pck.get_nm_usuario,
                clock_timestamp(),
                wheb_usuario_pck.get_nm_usuario,
                cd_doenca_p,
                nr_atendimento_w,
				nr_seq_interno_p
            );
        end if;
    end if;
commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE set_main_disease_hosp ( nr_atendimento_p diagnostico_doenca.nr_atendimento%type, cd_pessoa_fisica_p atendimento_paciente.cd_pessoa_fisica%type, cd_doenca_p diagnostico_doenca.cd_doenca%type default null, nr_seq_interno_p diagnostico_doenca.nr_seq_interno%type default null) FROM PUBLIC;

