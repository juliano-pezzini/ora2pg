-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_ordem_internacao_pa ( nr_seq_atend_alta_p text) AS $body$
DECLARE

			 
nr_ordem_servico_w 	bigint;
nr_seq_usu_w 		bigint;
nr_sequencia_w 		bigint;
cd_estabelecimento_w	smallint;
nr_seq_localizacao_w	bigint;
ie_classificacao_w	varchar(1);
ie_status_ordem_w	varchar(1);
nr_grupo_planej_w	bigint;
nr_grupo_trabalho_w	bigint;
nr_seq_tipo_solucao_w	bigint;
nr_seq_estagio_w	bigint;
nr_seq_equipamento_w	bigint;
IE_TIPO_ORDEM_w		bigint;
cd_pessoa_fisica_w	varchar(10);
nm_medico_solic_w	varchar(100);	
nr_atendimento_w	bigint;
cd_medico_dest_w	varchar(10);
nm_usuario_w		varchar(50);
cd_medico_resp_w	bigint;
ie_desfecho_w		varchar(10);
cd_medico_dest_ww	varchar(10);	
ie_medico_ciente_w	varchar(10);	
qt_reg_w		bigint;

BEGIN
 
 
select	count(*) 
into STRICT	qt_reg_w 
from	regra_padrao_ordem_servico 
	where	cd_estabelecimento	= wheb_usuario_pck.get_cd_estabelecimento 
	and	IE_TIPO = 'D';
	 
select	max(ie_desfecho), 
	max(cd_medico_dest), 
	max(ie_medico_ciente) 
into STRICT	ie_desfecho_w, 
	cd_medico_dest_ww, 
	ie_medico_ciente_w 
from	atendimento_alta 
where	nr_sequencia = nr_seq_atend_alta_p;
 
if (ie_desfecho_w = 'I') and (cd_medico_dest_ww IS NOT NULL AND cd_medico_dest_ww::text <> '') and (ie_medico_ciente_w = 'N') and (qt_reg_w	> 0)then 
 
	select	max(cd_estabelecimento), 
		max(nr_seq_localizacao), 
		max(ie_classificacao), 
		max(ie_status_ordem), 
		max(nr_grupo_planej), 
		max(nr_grupo_trabalho), 
		max(nr_seq_tipo_solucao), 
		max(nr_seq_estagio), 
		max(nr_seq_equipamento), 
		max(IE_TIPO_ORDEM) 
	into STRICT	cd_estabelecimento_w, 
		nr_seq_localizacao_w, 
		ie_classificacao_w, 
		ie_status_ordem_w, 
		nr_grupo_planej_w, 
		nr_grupo_trabalho_w, 
		nr_seq_tipo_solucao_w, 
		nr_seq_estagio_w, 
		nr_seq_equipamento_w, 
		IE_TIPO_ORDEM_w 
	from	regra_padrao_ordem_servico 
	where	cd_estabelecimento	= wheb_usuario_pck.get_cd_estabelecimento 
	and	IE_TIPO = 'D';
 
	select	max(nr_atendimento), 
		max(cd_medico_dest), 
		max(nm_usuario) 
	into STRICT	nr_atendimento_w, 
		cd_medico_dest_w, 
		nm_usuario_w 
	from	atendimento_alta 
	where	nr_sequencia = nr_seq_atend_alta_p;
 
	select	max(cd_pessoa_fisica), 
		max(cd_medico_resp) 
	into STRICT	cd_pessoa_fisica_w, 
		cd_medico_resp_w 
	from	atendimento_paciente 
	where	nr_atendimento = nr_atendimento_w;
 
	select max(SUBSTR(obter_nome_medico(cd_medico_resp,'G'),1,60)) 
	into STRICT	nm_medico_solic_w 
	from	atendimento_paciente 
	where	nr_Atendimento = nr_atendimento_w;
 
	man_gerar_ordem_servico(coalesce(nr_seq_localizacao_w, 1463),    		-- Número da localização - código do hospital - Pode procurar no campo 'Localização' da OS. 
	  coalesce(nr_seq_equipamento_w,42),  					-- Número do equipamento - Procurar no campo 'Equipamento' da OS.  Ex: procurar 'Sistema Tasy' e copiar o código. 
	  cd_medico_resp_w, 
	  clock_timestamp(), 
	  'M',  								-- 'B' - Baixa, 'M' - Média, 'A' - Alta, 'E' - Emergência, 'S' - Sem prioridade, 'U' - urgente 
	  'N', 
	  /* Tìtulo da OS - 80 caracteres */
 
	  'Aviso de Internação: ' || nr_atendimento_w|| '.', 
	   nm_usuario_w, 
	  obter_desc_expressao(295156) || ' ' || substr(obter_nome_pf(cd_pessoa_fisica_w), 1, 100)  ||CHR(13)|| 
	  'Leito / Unidade: ' || substr(obter_ult_unidade_atend(nr_atendimento_w, 'B')||' / '||obter_ult_unidade_atend(nr_atendimento_w, 'C'), 1, 100) ||CHR(13)||	 
	  obter_desc_expressao(293151) || ' ' || nm_medico_solic_w ||CHR(13)||   
	  'Serviço proposto: Aviso de Internação' ||CHR(13)|| 
	  obter_desc_expressao(295804) || ' ' || substr(obter_nome_pf(cd_medico_dest_w), 1, 100), 
	  coalesce(IE_TIPO_ORDEM_w,'3'), -- '0' - Cliente, '1' - Corretiva, '2' - Preventiva, '3' - Programada, '4' - Desenvolvimento, '5' - Calibração, '6' - Treinamento, '10' - Solicitação de versão extra 
	  coalesce(ie_status_ordem_w, '1'), -- '1' - Aberta, '2' - Processo, '3' - Encerrado 
	  coalesce(ie_classificacao_w, 's'), -- 'D' - Dúvida, 'E' - Erro, 'T' - Sugestão, 'S' - Solicitação 
	  coalesce(nr_seq_estagio_w, 21), -- Executar select no arquivo anexado 'OS247549_11_10_script.sql' 
	  coalesce(nr_grupo_planej_w, 29), -- Executar select no arquivo anexado 'OS247549_11_10_script_1.sql' lembrando de observar o estabelecimento 
	  coalesce(nr_grupo_trabalho_w, 42), -- Executar select no arquivo anexado 'OS247549_11_10_script_2.sql' lembrando de observar o estabelecimento 
	  nr_ordem_servico_w);
 
	select nextval('man_ordem_servico_exec_seq') 
	into STRICT 	nr_seq_usu_w 
	;
 
	insert into man_ordem_servico_exec( 
			nr_sequencia, 
			nr_seq_ordem, 
			dt_atualizacao, 
			nm_usuario, 
			nm_usuario_exec, 
			qt_min_prev, 
			nr_seq_funcao, 
			nr_seq_tipo_exec) 
	SELECT	nextval('man_ordem_servico_exec_seq'), 
		nr_ordem_servico_w, 
		clock_timestamp(), 
		nm_usuario_w, 
		a.nm_usuario_param, 
		60, 
		null, -- Informar o código da Função 
		null -- Informar o código do tipo de execução 
	from	MAN_GRUPO_TRAB_USUARIO a 
	where	a.NR_SEQ_GRUPO_TRAB	= nr_grupo_trabalho_w;
 
	select nextval('man_ordem_serv_tecnico_seq') 
	into STRICT nr_sequencia_w 
	;
 
	insert into man_ordem_serv_tecnico( 
	 nr_sequencia, 
	 nr_seq_ordem_serv, 
	 dt_atualizacao, 
	 nm_usuario, 
	 ds_relat_tecnico, 
	 dt_historico, 
	 ie_origem, 
	 dt_liberacao, 
	 nm_usuario_lib) 
	 values ( nr_sequencia_w, 
	 nr_ordem_servico_w, 
	 clock_timestamp(), 
	 nm_usuario_w, 
	 ' ', 
	 clock_timestamp(), 
	 'I', 
	 clock_timestamp(), 
	 nm_usuario_w);
	  
	CALL COPIA_CAMPO_LONG_DE_PARA('ATENDIMENTO_ALTA','DS_ORIENTACAO',' where NR_SEQUENCIA = :NR_SEQUENCIA ','NR_SEQUENCIA='||nr_seq_atend_alta_p, 
	'MAN_ORDEM_SERV_TECNICO','DS_RELAT_TECNICO','where nr_sequencia = :nr_sequencia ','nr_sequencia='||nr_sequencia_w);
 
	commit;
 
end if;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_ordem_internacao_pa ( nr_seq_atend_alta_p text) FROM PUBLIC;

