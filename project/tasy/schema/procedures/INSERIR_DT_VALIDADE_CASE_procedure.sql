-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE inserir_dt_validade_case (nr_atendimento_p bigint) AS $body$
DECLARE


dt_entrada_w                atendimento_paciente.dt_entrada%type;
nr_seq_tipo_admissao_fat_w  atendimento_paciente.nr_seq_tipo_admissao_fat%type;
nr_seq_episodio_w           atendimento_paciente.nr_seq_episodio%type;
dt_inicio_validade_w        atendimento_paciente_inf.dt_inicio_validade%type;
ie_kv_w                     varchar(3);


BEGIN

select  dt_entrada,
        nr_seq_tipo_admissao_fat,
        nr_seq_episodio
into STRICT    dt_entrada_w,
        nr_seq_tipo_admissao_fat_w,
        nr_seq_episodio_w
from    atendimento_paciente
where   nr_atendimento = nr_atendimento_p;

select  max('S')
into STRICT    ie_kv_w
from    tipo_admissao_fat
where   nr_sequencia = nr_seq_tipo_admissao_fat_w
and     ie_tipo_kv = 'S';


if (coalesce(ie_kv_w, 'N') = 'S'
    and (nr_seq_episodio_w IS NOT NULL AND nr_seq_episodio_w::text <> '')
    and (dt_entrada_w IS NOT NULL AND dt_entrada_w::text <> '')
    and (nr_seq_tipo_admissao_fat_w IS NOT NULL AND nr_seq_tipo_admissao_fat_w::text <> ''))then
    
    select  case ps_obter_forecasting_quarter(dt_entrada_w)
    when 1 then to_date('01/01'||to_char(dt_entrada_w,'yyyy'),'dd/MM/yyyy')
    when 2 then to_date('01/04'||to_char(dt_entrada_w,'yyyy'),'dd/MM/yyyy')
    when 3 then to_date('01/07'||to_char(dt_entrada_w,'yyyy'),'dd/MM/yyyy')
    else to_date('01/10'||to_char(dt_entrada_w,'yyyy'),'dd/MM/yyyy')
    end result
    into STRICT dt_inicio_validade_w
    
    where ( SELECT  coalesce(max('S'), 'N')
        from    tipo_admissao_fat taf
        where   taf.nr_sequencia= nr_seq_tipo_admissao_fat_w
        and     taf.ie_tipo_kv = 'S'
        and     taf.ie_situacao = 'A') = 'S';

    update  episodio_paciente
    set     dt_episodio = dt_inicio_validade_w
    where   nr_sequencia = nr_seq_episodio_w;

    commit;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE inserir_dt_validade_case (nr_atendimento_p bigint) FROM PUBLIC;

