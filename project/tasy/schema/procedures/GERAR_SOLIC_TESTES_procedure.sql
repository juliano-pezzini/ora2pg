-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_solic_testes ( nr_seq_derivado_p bigint, nr_prescricao_p bigint, nr_seq_solic_sangue_p bigint, nr_atendimento_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text, dt_prev_execucao_p timestamp, cd_intervalo_p text) AS $body$
DECLARE


nr_seq_w		bigint;
ie_tipo_conv_w		bigint;
nr_seq_exame_w		bigint;
cd_convenio_w		bigint;
cd_categoria_w		bigint;
ie_tipo_atendimento_w	bigint;
cd_setor_w		bigint;
cont_w			bigint;
cd_proced_w		bigint;
ie_origem_w		bigint;
nr_seq_proc_interno_w	bigint;
nr_sequencia_w		bigint;
nr_intervalos_w		bigint;
nr_horas_validade_w	integer;
ds_horarios_w		varchar(2000);
ds_horarios_2_w		varchar(2000);
dt_primeiro_horario_w	timestamp;
ds_exame_w		varchar(255);

c01 CURSOR FOR
SELECT	nr_seq_exame
from	san_regra_exame_cont_item
where	nr_seq_regra_exame = nr_seq_w;


BEGIN

select	max(nr_sequencia)
into STRICT	nr_seq_w
from	san_regra_exame_controle
where	nr_seq_derivado		= nr_seq_derivado_p
and	coalesce(ie_situacao,'A')	= 'A'
and	coalesce(ie_gerar_rep,'N')	= 'S';

select	max(dt_primeiro_horario),
	coalesce(max(nr_horas_validade),0)
into STRICT	dt_primeiro_horario_w,
	nr_horas_validade_w
from	prescr_medica
where	nr_prescricao = nr_prescricao_p;

open C01;
loop
fetch C01 into
	nr_seq_exame_w;
EXIT WHEN NOT FOUND; /* apply on C01 */

	select	obter_convenio_atendimento(nr_atendimento_p),
		Obter_Categoria_Atendimento(nr_atendimento_p),
		obter_tipo_atendimento(nr_atendimento_p)
	into STRICT	cd_convenio_w,
		cd_categoria_w,
		ie_tipo_atendimento_w
	;

	select	max(obter_tipo_convenio(cd_convenio_w))
	into STRICT	ie_tipo_conv_w
	;

	SELECT * FROM Obter_Proced_sangue(1, nr_seq_exame_w, cd_estabelecimento_p, ie_tipo_atendimento_w, ie_tipo_conv_w, cd_convenio_w, cd_categoria_w, cd_setor_w, cd_proced_w, ie_origem_w, nr_seq_proc_interno_w) INTO STRICT cd_setor_w, cd_proced_w, ie_origem_w, nr_seq_proc_interno_w;

	select	coalesce(max(nr_sequencia),0) + 1
	into STRICT	nr_sequencia_w
	from	prescr_procedimento
	where	nr_prescricao	= nr_prescricao_p;

	if (nr_seq_proc_interno_w IS NOT NULL AND nr_seq_proc_interno_w::text <> '') then
		SELECT * FROM Obter_Proc_Tab_Interno(nr_seq_proc_interno_w, nr_prescricao_p, nr_atendimento_p, 0, cd_proced_w, ie_origem_w, null, clock_timestamp()) INTO STRICT cd_proced_w, ie_origem_w;
	end if;

	SELECT * FROM Calcular_Horario_Prescricao(	nr_prescricao_p, cd_intervalo_p, dt_primeiro_horario_w, dt_prev_execucao_p, nr_horas_validade_w, cd_proced_w, 0, 0, nr_intervalos_w, ds_horarios_w, ds_horarios_2_w, 'N', null) INTO STRICT nr_intervalos_w, ds_horarios_w, ds_horarios_2_w;

	select	count(*)
	into STRICT	cont_w
	from	prescr_procedimento
	where	nr_prescricao		= nr_prescricao_p
	and	NR_SEQ_EXAME_SANGUE	= nr_seq_exame_w;

	if (cont_w = 0) then

		if (cd_proced_w IS NOT NULL AND cd_proced_w::text <> '') then

			insert into prescr_procedimento(ie_origem_inf,
				nr_prescricao,
				nr_sequencia,
				cd_procedimento,
				ie_origem_proced,
				qt_procedimento,
				dt_atualizacao,
				nm_usuario,
				nr_seq_proc_interno,
				cd_setor_atendimento,
				ie_tipo_proced,
				nr_seq_solic_sangue,
				NR_SEQ_EXAME_SANGUE,
				dt_prev_execucao,
				ds_horarios)
			values ( '1',
				nr_prescricao_p,
				nr_sequencia_w,
				cd_proced_w,
				ie_origem_w,
				1,
				clock_timestamp(),
				nm_usuario_p,
				nr_seq_proc_interno_w,
				cd_setor_w,
				'BSST',
				nr_seq_solic_sangue_p,
				nr_seq_exame_w,
				dt_prev_execucao_p,
				ds_horarios_w);
		else

			ds_exame_w	:= substr(obter_desc_san_exame(nr_seq_exame_w),1,250);
			CALL Wheb_mensagem_pck.exibir_mensagem_abort(193898,'DS_EXAME=' || ds_exame_w);

		end if;
	end if;
end loop;
close C01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_solic_testes ( nr_seq_derivado_p bigint, nr_prescricao_p bigint, nr_seq_solic_sangue_p bigint, nr_atendimento_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text, dt_prev_execucao_p timestamp, cd_intervalo_p text) FROM PUBLIC;

