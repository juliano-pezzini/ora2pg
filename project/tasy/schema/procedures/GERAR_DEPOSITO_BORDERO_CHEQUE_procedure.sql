-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_deposito_bordero_cheque ( nr_seq_bordero_p bigint, ie_acao_p text, nm_usuario_p text, dt_deposito_p timestamp) AS $body$
DECLARE

/*	ie_acao_p
	'G' - Gerar depósito
	'D' - Desfazer depósito */
ds_caixa_w			varchar(255);
vl_cheque_w			double precision;
nr_seq_deposito_w		bigint;
nr_seq_trans_financ_w		bigint;
nr_seq_conta_banco_w		bigint;
nr_seq_caixa_w			bigint;
nr_seq_trans_fin_w		bigint;
nr_seq_saldo_caixa_w		bigint;
cd_estabelecimento_w		smallint;
dt_deposito_w			timestamp;
ie_desc_bordero_deposito_w	varchar(15);
ds_deposito_w			varchar(4000)	:= '';
nr_seq_cheque_w			cheque_cr.nr_seq_cheque%type;
/* Projeto Multimoeda - Variáveis */

vl_cheque_estrang_w		double precision;
vl_complemento_w		double precision;
vl_cotacao_w			cotacao_moeda.vl_cotacao%type;
cd_moeda_w			integer;
qt_movto_bco_w		bigint;


BEGIN

select	max(a.nr_seq_deposito),
	max(a.cd_estabelecimento),
	max(a.nr_seq_trans_financ),
	max(a.nr_seq_conta_banco)
into STRICT	nr_seq_deposito_w,
	cd_estabelecimento_w,
	nr_seq_trans_financ_w,
	nr_seq_conta_banco_w
from	bordero_cheque a
where	a.nr_sequencia	= nr_seq_bordero_p;

if (ie_acao_p = 'G') then
	if (nr_seq_deposito_w IS NOT NULL AND nr_seq_deposito_w::text <> '') then
		CALL wheb_mensagem_pck.exibir_mensagem_abort(176670,'NR_BORDERO=' || nr_seq_bordero_p);
	end if;

	nr_seq_caixa_w := Obter_Param_Usuario(810, 48, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, nr_seq_caixa_w);

	nr_seq_trans_fin_w := Obter_Param_Usuario(810, 49, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, nr_seq_trans_fin_w);

	ie_desc_bordero_deposito_w	:= coalesce(obter_valor_param_usuario(810, 72, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w),'N');

	if (ie_desc_bordero_deposito_w = 'S') then
		begin
		select	max(ds_bordero)
		into STRICT	ds_deposito_w
		from	bordero_cheque
		where	nr_sequencia	= nr_seq_bordero_p;

		end;
	end if;

	if (nr_seq_caixa_w IS NOT NULL AND nr_seq_caixa_w::text <> '') and (nr_seq_trans_fin_w IS NOT NULL AND nr_seq_trans_fin_w::text <> '') then
		select	max(nr_sequencia)
		into STRICT	nr_seq_saldo_caixa_w
		from	caixa_saldo_diario
		where	nr_seq_caixa	= nr_seq_caixa_w
		and	coalesce(dt_fechamento::text, '') = '';

		if (coalesce(nr_seq_saldo_caixa_w,0) = 0) then
			ds_caixa_w	:= obter_desc_caixa(nr_seq_caixa_w);
			CALL wheb_mensagem_pck.exibir_mensagem_abort(176671,'DS_CAIXA=' || ds_caixa_w);
		end if;
	end if;

	select	coalesce(sum(b.vl_cheque),0),
		max(b.nr_seq_cheque),
		sum(b.vl_cheque_estrang),
		max(b.vl_cotacao),
		max(b.cd_moeda)
	into STRICT	vl_cheque_w,
		nr_seq_cheque_w,
		vl_cheque_estrang_w,
		vl_cotacao_w,
		cd_moeda_w
	from	cheque_cr b,
		cheque_bordero a
	where	a.nr_seq_cheque		= b.nr_seq_cheque
	and	a.nr_seq_bordero	= nr_seq_bordero_p;

	select	nextval('deposito_seq')
	into STRICT	nr_seq_deposito_w
	;

	/* Projeto Multimoeda - Verifica se os cheques são em moeda estrangeira, caso positivo calcula os valores para gravar no depósito,
			caso contrário limpa as variáveis antes de gravar o registro.*/
	if (coalesce(vl_cheque_estrang_w,0) <> 0 and coalesce(vl_cotacao_w,0) <> 0) then
		/* O valor da cotação deve ser buscado na data do depósito.*/

		begin
			select 	obter_cotacao_moeda_financ(cd_moeda_w,coalesce(dt_deposito_p,clock_timestamp()))
			into STRICT	vl_cotacao_w
			;
			vl_cheque_w	:= vl_cheque_estrang_w * vl_cotacao_w;
			vl_complemento_w := vl_cheque_w - vl_cheque_estrang_w;
		exception when others then
			vl_cheque_estrang_w := null;
			vl_complemento_w := null;
			vl_cotacao_w := null;
			cd_moeda_w := null;
		end;
	else
		vl_cheque_estrang_w := null;
		vl_complemento_w := null;
		vl_cotacao_w := null;
		cd_moeda_w := null;
	end if;

	insert	into deposito(cd_estabelecimento,
		dt_atualizacao,
		dt_atualizacao_nrec,
		dt_preparacao,
		nm_usuario,
		nm_usuario_nrec,
		nr_conta,
		nr_seq_trans_financ,
		nr_sequencia,
		vl_cheque,
		vl_especie,
		ds_deposito,
		dt_deposito,
		vl_cheque_estrang,
		vl_especie_estrang,
		vl_complemento,
		vl_cotacao,
		cd_moeda)
	values (cd_estabelecimento_w,
		clock_timestamp(),
		clock_timestamp(),
		clock_timestamp(),
		nm_usuario_p,
		nm_usuario_p,
		nr_seq_conta_banco_w,
		nr_seq_trans_financ_w,
		nr_seq_deposito_w,
		vl_cheque_w,
		0,
		substr(ds_deposito_w,1,255),
		coalesce(dt_deposito_p,clock_timestamp()),
		vl_cheque_estrang_w,
		CASE WHEN coalesce(vl_cheque_estrang_w::text, '') = '' THEN null  ELSE 0 END ,
		vl_complemento_w,
		vl_cotacao_w,
		cd_moeda_w);

	insert	into deposito_cheque(dt_atualizacao,
		dt_atualizacao_nrec,
		nm_usuario,
		nm_usuario_nrec,
		nr_seq_cheque,
		nr_seq_deposito,
		nr_sequencia)
	SELECT	clock_timestamp(),
		clock_timestamp(),
		nm_usuario_p,
		nm_usuario_p,
		a.nr_seq_cheque,
		nr_seq_deposito_w,
		nextval('deposito_cheque_seq')
	from	cheque_bordero a
	where	a.nr_seq_bordero	= nr_seq_bordero_p;

	update	bordero_cheque
	set	nr_seq_deposito	= nr_seq_deposito_w
	where	nr_sequencia	= nr_seq_bordero_p;

	CALL atualizar_deposito_cheque(nr_seq_deposito_w,coalesce(dt_deposito_p,clock_timestamp()),nm_usuario_p);
	CALL liberar_cheque_orgao_cobr(nr_seq_cheque_w,nm_usuario_p);

elsif (ie_acao_p = 'D') then

	select	max(a.dt_deposito)
	into STRICT	dt_deposito_w
	from	deposito a
	where	a.nr_sequencia	= nr_seq_deposito_w;

	if (dt_deposito_w IS NOT NULL AND dt_deposito_w::text <> '') then
		CALL desfazer_deposito(nr_seq_deposito_w,coalesce(dt_deposito_p,clock_timestamp()),nm_usuario_p);
	end if;

	/*OS 1290793 - Verificar se existem movimentos  no banco ou caixa para esse depósito. Se existir nao pode tentar excluir o depoisto, pois existem registros filhos vinculados ao deposito*/

	select	count(*)
	into STRICT	qt_movto_bco_w
	from	movto_trans_financ
	where	nr_seq_deposito = nr_seq_deposito_w;

	/*Se não existir movimentos no banco/caixa para esse deposito, entao faz o que fazia antes, que era excluir o cheque do deposito e depois excluir o deposito*/

	/*Precisa dessa verificação pois o sistema pode estar parametrizado para nao movimentar banco na baixa do deposito, ai pode excluir normalmente como antes*/

	if (qt_movto_bco_w = 0) then

		delete	from deposito_cheque
		where	nr_seq_deposito	= nr_seq_deposito_w;

		update	bordero_cheque
		set	nr_seq_deposito	 = NULL
		where	nr_sequencia	= nr_seq_bordero_p;

		delete	from deposito
		where	nr_sequencia	= nr_seq_deposito_w;

	else /*Se tiver moviemntos, apenas desvincula o deposito gerado do bordero de cheques.*/
		update	bordero_cheque
		set	nr_seq_deposito	 = NULL
		where	nr_sequencia	= nr_seq_bordero_p;

	end if;
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_deposito_bordero_cheque ( nr_seq_bordero_p bigint, ie_acao_p text, nm_usuario_p text, dt_deposito_p timestamp) FROM PUBLIC;

