-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE undo_nurse_ack (ie_suspensao_p text, ie_tipo_item_p text, nr_atendimento_p bigint, nr_seq_cpoe_p bigint, cd_item_p text) AS $body$
DECLARE


nr_prescricao_w prescr_medica.nr_prescricao%type;
nr_seq_item_w prescr_material.nr_sequencia%type;
nm_user_w usuario.nm_usuario%type;

nr_seq_worklist_w	wl_worklist.nr_sequencia%type;

c01 CURSOR FOR
SELECT	distinct a.nr_prescricao nr_prescricao, /* suplementos orais - medicamentos - materiais */
	b.nr_sequencia nr_seq_item
from	prescr_material b,
		prescr_medica a
where	b.nr_seq_mat_cpoe = nr_seq_cpoe_p
and b.nr_prescricao = a.nr_prescricao
and coalesce(b.nr_sequencia_diluicao::text, '') = ''
and b.ie_checar_adep = 'S';

c02 CURSOR FOR
SELECT	distinct a.nr_prescricao nr_prescricao, /* solucao */
	b.nr_sequencia_solucao nr_seq_item
from	prescr_material b,
		prescr_medica a
where	b.nr_seq_mat_cpoe = nr_seq_cpoe_p
and coalesce(b.nr_sequencia_diluicao::text, '') = ''
and b.nr_prescricao = a.nr_prescricao;

c03 CURSOR FOR
SELECT	min(a.nr_prescricao) nr_prescricao /* dieta */
from	prescr_dieta b,
		prescr_medica a
where	b.nr_seq_dieta_cpoe = nr_seq_cpoe_p
and b.nr_prescricao = a.nr_prescricao;

c04 CURSOR FOR
SELECT	distinct a.nr_prescricao nr_prescricao, /* recomendacao */
  b.nr_sequencia nr_seq_item
from	prescr_recomendacao b,
		prescr_medica a
where	b.nr_seq_rec_cpoe = nr_seq_cpoe_p
and b.nr_prescricao = a.nr_prescricao;

c05 CURSOR FOR
SELECT	distinct a.nr_prescricao nr_prescricao, /* exame procedimento */
  b.nr_sequencia nr_seq_item,
  b.nr_seq_proc_interno
from	prescr_procedimento b,
		prescr_medica a
where	b.nr_seq_proc_cpoe = nr_seq_cpoe_p
and coalesce(b.nr_seq_origem::text, '') = ''
and b.nr_prescricao = a.nr_prescricao;

c06 CURSOR FOR
SELECT	distinct a.nr_prescricao nr_prescricao, /* gasoterapia */
  b.nr_sequencia nr_seq_item
from	prescr_gasoterapia b,
		prescr_medica a
where	b.nr_seq_gas_cpoe = nr_seq_cpoe_p
and b.nr_prescricao = a.nr_prescricao;

c07 CURSOR FOR
SELECT	distinct a.nr_prescricao nr_prescricao, /* hemoterapia */
  b.nr_sequencia nr_seq_item,
  b.nr_seq_proc_interno
from	prescr_procedimento b,
		prescr_medica a
where	b.nr_seq_proc_cpoe = nr_seq_cpoe_p
and b.nr_prescricao = a.nr_prescricao;

c08 CURSOR FOR
SELECT	distinct a.nr_prescricao nr_prescricao, /* dialise */
  b.nr_seq_solucao nr_seq_item
from	prescr_solucao b,
		prescr_medica a
where (a.nr_prescricao, b.nr_seq_dialise) = (select c.nr_prescricao, c.nr_sequencia
                            from	hd_prescricao c
                            where	c.nr_seq_dialise_cpoe = nr_seq_cpoe_p)
and b.nr_prescricao = a.nr_prescricao;

c09 CURSOR FOR
SELECT	distinct a.nr_prescricao nr_prescricao, /* sne leite */
	b.nr_sequencia nr_seq_item
from	prescr_material b,
		prescr_medica a
where	b.nr_seq_dieta_cpoe = nr_seq_cpoe_p
and b.nr_prescricao = a.nr_prescricao;

c10 CURSOR FOR /* jejum */
SELECT  distinct a.nr_prescricao
from  rep_jejum b,
    prescr_medica a
where	b.nr_seq_dieta_cpoe = nr_seq_cpoe_p
and b.nr_prescricao = a.nr_prescricao;

c11 CURSOR FOR /* npt */
SELECT	distinct a.nr_prescricao nr_prescricao,
	b.nr_sequencia nr_seq_item
from	nut_pac b,
		prescr_medica a
where	b.nr_seq_npt_cpoe in nr_seq_cpoe_p
and b.nr_prescricao = a.nr_prescricao;
BEGIN

  nm_user_w := wheb_usuario_pck.get_nm_usuario;
  --cd_establishment_w := wheb_usuario_pck.get_cd_estabelecimento;
/*

Solutions:
PRESCR_SOLUCAO_EVENTO 
Gas therapy: 
PRESCR_GASOTERAPIA_EVENTO 
Dialysis: 
HD_PRESCRICAO_EVENTO 
Bladder irrigation: 
ADEP_IRRIGACAO_ETAPA 
Other items: 
PRESCR_MAT_ALTERACAO 



NR_SEQ_MAT_CPOE for materials, medicines and solutions 
NR_SEQ_DIET_CPOE for diets 
NR_SEQ_EXAM_CPOE for exams and procedures 
NR_SEQ_REC_CPOE for recomendations 
NR_SEQ_GASO_CPOE for gas therapy 
NR_SEQ_HEMO_CPOE for hemotherapy 
NR_SEQ_DIAL_CPOE for dialysis 

*/
  case
    when ie_tipo_item_p = 'M'
      or ie_tipo_item_p = 'MAT'
      or ie_tipo_item_p = 'S' then /* suplementos orais - medicamentos - materiais */
      if (ie_suspensao_p = 'N') then
        update cpoe_inf_adic
        set dt_ack_nurse  = NULL,
          nm_user_ack  = NULL
        where nr_seq_mat_cpoe = nr_seq_cpoe_p;
      else
        update cpoe_inf_adic
        set dt_ack_nurse_susp  = NULL,
          nm_user_ack_susp  = NULL
        where nr_seq_mat_cpoe = nr_seq_cpoe_p;
      end if;

      for c01_w in c01 loop
        insert into prescr_mat_alteracao(
                  nr_sequencia,
                  dt_atualizacao,
                  nm_usuario,
                  dt_atualizacao_nrec,
                  nm_usuario_nrec,
                  nr_prescricao,
                  nr_seq_prescricao,
                  dt_alteracao,
                  cd_pessoa_fisica,
                  ie_alteracao,
                  ie_tipo_item,
                  nr_atendimento,
                  cd_item)
        values (
                  nextval('prescr_mat_alteracao_seq'),
                  clock_timestamp(),
                  nm_user_w,
                  clock_timestamp(),
                  nm_user_w,
                  c01_w.nr_prescricao,
                  c01_w.nr_seq_item,
                  clock_timestamp(),
                  obter_dados_usuario_opcao(nm_user_w,'C'),
                  82,
                  ie_tipo_item_p,
                  nr_atendimento_p,
                  cd_item_p);
      end loop;

    when ie_tipo_item_p = 'SOL' then /* solucoes */
      if (ie_suspensao_p = 'N') then
        update cpoe_inf_adic
        set dt_ack_nurse  = NULL,
          nm_user_ack  = NULL
        where nr_seq_mat_cpoe = nr_seq_cpoe_p;
      else
        update cpoe_inf_adic
        set dt_ack_nurse_susp  = NULL,
          nm_user_ack_susp  = NULL
        where nr_seq_mat_cpoe = nr_seq_cpoe_p;
      end if;

      for c02_w in c02 loop
        insert into prescr_solucao_evento(
                  nr_sequencia,
                  dt_atualizacao,
                  nm_usuario,
                  dt_atualizacao_nrec,
                  nm_usuario_nrec,
                  nr_prescricao,
                  nr_seq_solucao,
                  ie_tipo_solucao,
                  cd_pessoa_fisica,
                  ie_alteracao,
                  dt_alteracao,
                  ie_evento_valido)
        values (
                  nextval('prescr_solucao_evento_seq'),
                  clock_timestamp(),
                  nm_user_w,
                  clock_timestamp(),
                  nm_user_w,
                  c02_w.nr_prescricao,
                  c02_w.nr_seq_item,
                  1,
                  obter_dados_usuario_opcao(nm_user_w, 'C'),
                  61,
                  clock_timestamp(),
                  'S');
      end loop;

    when ie_tipo_item_p = 'SNE' then /* sne */
      if (ie_suspensao_p = 'N') then
        update cpoe_inf_adic
        set dt_ack_nurse  = NULL,
          nm_user_ack  = NULL
        where nr_seq_diet_cpoe = nr_seq_cpoe_p;
      else
        update cpoe_inf_adic
        set dt_ack_nurse_susp  = NULL,
          nm_user_ack_susp  = NULL
        where nr_seq_diet_cpoe = nr_seq_cpoe_p;
      end if;

      for c09_w in c09 loop
        insert into prescr_solucao_evento(
                  nr_sequencia,
                  dt_atualizacao,
                  nm_usuario,
                  dt_atualizacao_nrec,
                  nm_usuario_nrec,
                  nr_prescricao,
                  nr_seq_material,
                  ie_tipo_solucao,
                  cd_pessoa_fisica,
                  ie_alteracao,
                  dt_alteracao,
                  ie_evento_valido)
        values (
                  nextval('prescr_solucao_evento_seq'),
                  clock_timestamp(),
                  nm_user_w,
                  clock_timestamp(),
                  nm_user_w,
                  c09_w.nr_prescricao,
                  c09_w.nr_seq_item,
                  2,
                  obter_dados_usuario_opcao(nm_user_w, 'C'),
                  61,
                  clock_timestamp(),
                  'S');
      end loop;

    when ie_tipo_item_p = 'LD' then /* Leite */
      if (ie_suspensao_p = 'N') then
        update cpoe_inf_adic
        set dt_ack_nurse  = NULL,
          nm_user_ack  = NULL
        where nr_seq_diet_cpoe = nr_seq_cpoe_p;
      else
        update cpoe_inf_adic
        set dt_ack_nurse_susp  = NULL,
          nm_user_ack_susp  = NULL
        where nr_seq_diet_cpoe = nr_seq_cpoe_p;
      end if;

      for c09_w in c09 loop
        insert into prescr_mat_alteracao(
                  nr_sequencia,
                  dt_atualizacao,
                  nm_usuario,
                  dt_atualizacao_nrec,
                  nm_usuario_nrec,
                  nr_prescricao,
                  dt_alteracao,
                  cd_pessoa_fisica,
                  ie_alteracao,
                  ie_tipo_item,
                  nr_atendimento,
                  cd_item)
        values (
                  nextval('prescr_mat_alteracao_seq'),
                  clock_timestamp(),
                  nm_user_w,
                  clock_timestamp(),
                  nm_user_w,
                  c09_w.nr_prescricao,
                  clock_timestamp(),
                  obter_dados_usuario_opcao(nm_user_w,'C'),
                  82,
                  ie_tipo_item_p,
                  nr_atendimento_p,
                  cd_item_p);
      end loop;

    when ie_tipo_item_p = 'NAN'
      or ie_tipo_item_p = 'NPN'
      or ie_tipo_item_p = 'NPP' then /* npt */
      if (ie_suspensao_p = 'N') then
        update cpoe_inf_adic
        set dt_ack_nurse  = NULL,
          nm_user_ack  = NULL
        where nr_seq_diet_cpoe = nr_seq_cpoe_p;
      else
        update cpoe_inf_adic
        set dt_ack_nurse_susp  = NULL,
          nm_user_ack_susp  = NULL
        where nr_seq_diet_cpoe = nr_seq_cpoe_p;
      end if;

      for c11_w in c11 loop
        insert into prescr_solucao_evento(
                  nr_sequencia,
                  dt_atualizacao,
                  nm_usuario,
                  dt_atualizacao_nrec,
                  nm_usuario_nrec,
                  nr_prescricao,
                  nr_seq_nut_neo,
                  ie_tipo_solucao,
                  cd_pessoa_fisica,
                  ie_alteracao,
                  dt_alteracao,
                  ie_evento_valido)
        values (
                  nextval('prescr_solucao_evento_seq'),
                  clock_timestamp(),
                  nm_user_w,
                  clock_timestamp(),
                  nm_user_w,
                  c11_w.nr_prescricao,
                  c11_w.nr_seq_item,
                  CASE WHEN ie_tipo_item_p='NAN' THEN  6 WHEN ie_tipo_item_p='NPN' THEN  5 WHEN ie_tipo_item_p='NPP' THEN  7  ELSE null END ,
                  obter_dados_usuario_opcao(nm_user_w, 'C'),
                  61,
                  clock_timestamp(),
                  'S');
      end loop;

    when ie_tipo_item_p = 'J' then /* jejum */
      if (ie_suspensao_p = 'N') then
        update cpoe_inf_adic
        set dt_ack_nurse  = NULL,
          nm_user_ack  = NULL
        where nr_seq_diet_cpoe = nr_seq_cpoe_p;
      else
        update cpoe_inf_adic
        set dt_ack_nurse_susp  = NULL,
          nm_user_ack_susp  = NULL
        where nr_seq_diet_cpoe = nr_seq_cpoe_p;
      end if;

      for c10_w in c10 loop
        insert into prescr_mat_alteracao(
                  nr_sequencia,
                  dt_atualizacao,
                  nm_usuario,
                  dt_atualizacao_nrec,
                  nm_usuario_nrec,
                  nr_prescricao,
                  dt_alteracao,
                  cd_pessoa_fisica,
                  ie_alteracao,
                  ie_tipo_item,
                  nr_atendimento,
                  cd_item)
        values (
                  nextval('prescr_mat_alteracao_seq'),
                  clock_timestamp(),
                  nm_user_w,
                  clock_timestamp(),
                  nm_user_w,
                  c10_w.nr_prescricao,
                  clock_timestamp(),
                  obter_dados_usuario_opcao(nm_user_w,'C'),
                  82,
                  ie_tipo_item_p,
                  nr_atendimento_p,
                  cd_item_p);
      end loop;

    when ie_tipo_item_p = 'HM' then /* hemoterapia */
      if (ie_suspensao_p = 'N') then
        update cpoe_inf_adic
        set dt_ack_nurse  = NULL,
          nm_user_ack  = NULL
        where nr_seq_hemo_cpoe = nr_seq_cpoe_p;
      else
        update cpoe_inf_adic
        set dt_ack_nurse_susp  = NULL,
          nm_user_ack_susp  = NULL
        where nr_seq_hemo_cpoe = nr_seq_cpoe_p;
      end if;

      for c07_w in c07 loop
        insert into prescr_solucao_evento(
                  nr_sequencia,
                  dt_atualizacao,
                  nm_usuario,
                  dt_atualizacao_nrec,
                  nm_usuario_nrec,
                  nr_prescricao,
                  nr_seq_procedimento,
                  ie_tipo_solucao,
                  cd_pessoa_fisica,
                  ie_alteracao,
                  dt_alteracao,
                  ie_evento_valido)
        values (
                  nextval('prescr_solucao_evento_seq'),
                  clock_timestamp(),
                  nm_user_w,
                  clock_timestamp(),
                  nm_user_w,
                  c07_w.nr_prescricao,
                  c07_w.nr_seq_item,
                  3,
                  obter_dados_usuario_opcao(nm_user_w, 'C'),
                  61,
                  clock_timestamp(),
                  'S');
      end loop;

    when ie_tipo_item_p = 'P'
      or ie_tipo_item_p = 'G'
      or ie_tipo_item_p = 'C'
      or ie_tipo_item_p = 'I'
      or ie_tipo_item_p = 'L' then /* procedimento - glicemia - ivc - coletas */
      if (ie_suspensao_p = 'N') then
        update cpoe_inf_adic
        set dt_ack_nurse  = NULL,
          nm_user_ack  = NULL
        where nr_seq_exam_cpoe = nr_seq_cpoe_p;
      else
        update cpoe_inf_adic
        set dt_ack_nurse_susp  = NULL,
          nm_user_ack_susp  = NULL
        where nr_seq_exam_cpoe = nr_seq_cpoe_p;
      end if;

      if (ie_tipo_item_p = 'L') then
	     if (ie_suspensao_p = 'N') then
		update cpoe_inf_adic
		set dt_ack_nurse  = NULL,
		  nm_user_ack  = NULL
		where nr_seq_anat_cpoe = nr_seq_cpoe_p;
	      else
		update cpoe_inf_adic
		set dt_ack_nurse_susp  = NULL,
		  nm_user_ack_susp  = NULL
		where nr_seq_anat_cpoe = nr_seq_cpoe_p;
	      end if;
      end if;

      for c05_w in c05 loop
        insert into prescr_mat_alteracao(
                  nr_sequencia,
                  dt_atualizacao,
                  nm_usuario,
                  dt_atualizacao_nrec,
                  nm_usuario_nrec,
                  nr_prescricao,
                  nr_seq_procedimento,
                  nr_seq_proc_interno,
                  dt_alteracao,
                  cd_pessoa_fisica,
                  ie_alteracao,
                  ie_tipo_item,
                  nr_atendimento,
                  cd_item)
        values (
                  nextval('prescr_mat_alteracao_seq'),
                  clock_timestamp(),
                  nm_user_w,
                  clock_timestamp(),
                  nm_user_w,
                  c05_w.nr_prescricao,
                  c05_w.nr_seq_item,
                  c05_w.nr_seq_proc_interno,
                  clock_timestamp(),
                  obter_dados_usuario_opcao(nm_user_w,'C'),
                  82,
                  CASE WHEN ie_tipo_item_p='L' THEN  'P'  ELSE ie_tipo_item_p END ,
                  nr_atendimento_p,
                  cd_item_p);
      end loop;

    when ie_tipo_item_p = 'D' then /* dieta oral */
      if (ie_suspensao_p = 'N') then
        update cpoe_inf_adic
        set dt_ack_nurse  = NULL,
          nm_user_ack  = NULL
        where nr_seq_diet_cpoe = nr_seq_cpoe_p;
      else
        update cpoe_inf_adic
        set dt_ack_nurse_susp  = NULL,
          nm_user_ack_susp  = NULL
        where nr_seq_diet_cpoe = nr_seq_cpoe_p;
      end if;

      for c03_w in c03 loop
        insert into prescr_mat_alteracao(
                  nr_sequencia,
                  dt_atualizacao,
                  nm_usuario,
                  dt_atualizacao_nrec,
                  nm_usuario_nrec,
                  nr_prescricao,
                  dt_alteracao,
                  cd_pessoa_fisica,
                  ie_alteracao,
                  ie_tipo_item,
                  nr_atendimento,
                  cd_item)
        values (
                  nextval('prescr_mat_alteracao_seq'),
                  clock_timestamp(),
                  nm_user_w,
                  clock_timestamp(),
                  nm_user_w,
                  c03_w.nr_prescricao,
                  clock_timestamp(),
                  obter_dados_usuario_opcao(nm_user_w,'C'),
                  82,
                  ie_tipo_item_p,
                  nr_atendimento_p,
                  cd_item_p);
      end loop;

    when ie_tipo_item_p = 'O' then /* gasoterapia */
      if (ie_suspensao_p = 'N') then
        update cpoe_inf_adic
        set dt_ack_nurse  = NULL,
          nm_user_ack  = NULL
        where nr_seq_gaso_cpoe = nr_seq_cpoe_p;
      else
        update cpoe_inf_adic
        set dt_ack_nurse_susp  = NULL,
          nm_user_ack_susp  = NULL
        where nr_seq_gaso_cpoe = nr_seq_cpoe_p;
      end if;

      for c06_w in c06 loop
        insert into prescr_gasoterapia_evento(
                  nr_sequencia,
                  dt_atualizacao,
                  nm_usuario,
                  dt_atualizacao_nrec,
                  nm_usuario_nrec,
                  nr_seq_gasoterapia,
                  nr_seq_gas_cpoe,
                  dt_evento,
                  ie_evento)
        values (
                  nextval('prescr_gasoterapia_evento_seq'),
                  clock_timestamp(),
                  nm_user_w,
                  clock_timestamp(),
                  nm_user_w,
                  c06_w.nr_seq_item,
                  nr_seq_cpoe_p,
                  clock_timestamp(),
                  'DA');
      end loop;

    when ie_tipo_item_p = 'R' then /* recomendacao */
      if (ie_suspensao_p = 'N') then
        update cpoe_inf_adic
        set dt_ack_nurse  = NULL,
          nm_user_ack  = NULL
        where nr_seq_rec_cpoe = nr_seq_cpoe_p;
      else
        update cpoe_inf_adic
        set dt_ack_nurse_susp  = NULL,
          nm_user_ack_susp  = NULL
        where nr_seq_rec_cpoe = nr_seq_cpoe_p;
      end if;

      for c04_w in c04 loop
        insert into prescr_mat_alteracao(
                  nr_sequencia,
                  dt_atualizacao,
                  nm_usuario,
                  dt_atualizacao_nrec,
                  nm_usuario_nrec,
                  nr_prescricao,
                  nr_seq_recomendacao,
                  dt_alteracao,
                  cd_pessoa_fisica,
                  ie_alteracao,
                  ie_tipo_item,
                  nr_atendimento,
                  cd_item)
        values (
                  nextval('prescr_mat_alteracao_seq'),
                  clock_timestamp(),
                  nm_user_w,
                  clock_timestamp(),
                  nm_user_w,
                  c04_w.nr_prescricao,
                  c04_w.nr_seq_item,
                  clock_timestamp(),
                  obter_dados_usuario_opcao(nm_user_w,'C'),
                  82,
                  ie_tipo_item_p,
                  nr_atendimento_p,
                  cd_item_p);
      end loop;

    when ie_tipo_item_p = 'DI' then /* dialise */
      if (ie_suspensao_p = 'N') then
        update cpoe_inf_adic
        set dt_ack_nurse  = NULL,
          nm_user_ack  = NULL
        where nr_seq_dial_cpoe = nr_seq_cpoe_p;
      else
        update cpoe_inf_adic
        set dt_ack_nurse_susp  = NULL,
          nm_user_ack_susp  = NULL
        where nr_seq_dial_cpoe = nr_seq_cpoe_p;
      end if;

      for c08_w in c08 loop

				insert into hd_prescricao_evento(
                  nr_sequencia,
                  dt_atualizacao_nrec,
                  nm_usuario_nrec,
                  dt_atualizacao,
                  nm_usuario,
                  nr_prescricao,
                  nr_seq_solucao,
                  nr_etapa_evento,
                  ie_evento,
                  dt_evento,
                  cd_pessoa_evento)
				values (
                  nextval('hd_prescricao_evento_seq'),
                  clock_timestamp(),
                  nm_user_w,
                  clock_timestamp(),
                  nm_user_w,
                  c08_w.nr_prescricao,
                  c08_w.nr_seq_item,
                  null,
                  'DA',
                  clock_timestamp(),
                  substr(obter_dados_usuario_opcao(nm_user_w,'C'),1,10));

      end loop;

  end case;

commit;

		
select max(nr_sequencia)
into STRICT	nr_seq_worklist_w
from	wl_worklist
where nr_seq_item_cpoe = nr_seq_cpoe_p
and	ie_tipo_item_cpoe = ie_tipo_item_p
and nr_seq_item = obter_se_worklist_lib_cat('RC');

CALL wl_alterar_fim_previsto(nr_seq_worklist_w,clock_timestamp() + interval '1 days', null, nm_user_w, obter_desc_expressao(1079600), null);

/*
exception
  when others then
    rollback;
    raise_application_error(SQLCODE, SQLERRM);
*/
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE undo_nurse_ack (ie_suspensao_p text, ie_tipo_item_p text, nr_atendimento_p bigint, nr_seq_cpoe_p bigint, cd_item_p text) FROM PUBLIC;

