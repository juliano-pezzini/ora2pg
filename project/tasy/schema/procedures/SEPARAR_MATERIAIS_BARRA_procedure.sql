-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE separar_materiais_barra (cd_mat_barra_p text, ie_tipo_barra_p text, nm_usuario_p text, nr_seq_ordem_p bigint, cd_estabelecimento_p bigint) AS $body$
DECLARE


nr_seq_loteagrup_w		bigint;
cd_kit_mat_w			integer;
ds_validade_w			varchar(10);
ds_material_w			varchar(255);
nr_etiqueta_lp_w		varchar(10);
ds_erro_w			varchar(255);
ie_existe_w			varchar(1) := 'N';
nr_seq_separacao_w		w_separacao_quimio.nr_sequencia%type;
nr_sequencia_w			w_separacao_quimio.nr_sequencia%type;

cd_material_w			material_cod_barra.cd_material%type;
qt_material_w			material_cod_barra.qt_material%type;
nr_seq_lote_w			material_cod_barra.nr_seq_lote_fornec%type;


cd_unid_med_w			unidade_medida.cd_unidade_medida%type;
cd_material_ww		 	material.cd_material%type;
cd_grupo_material_ww		grupo_material.cd_grupo_material%type;
cd_subgrupo_material_ww		subgrupo_material.cd_subgrupo_material%type;
cd_classe_material_ww		classe_material.cd_classe_material%type;

ie_permite_w			varchar(1);


BEGIN

if (cd_mat_barra_p IS NOT NULL AND cd_mat_barra_p::text <> '') and (nr_seq_ordem_p IS NOT NULL AND nr_seq_ordem_p::text <> '') then
    SELECT * FROM converte_codigo_barras(
		cd_mat_barra_p, cd_estabelecimento_p, null, ie_tipo_barra_p, cd_material_w, qt_material_w, nr_seq_lote_w, nr_seq_loteagrup_w, cd_kit_mat_w, ds_validade_w, ds_material_w, cd_unid_med_w, nr_etiqueta_lp_w, ds_erro_w) INTO STRICT cd_material_w, qt_material_w, nr_seq_lote_w, nr_seq_loteagrup_w, cd_kit_mat_w, ds_validade_w, ds_material_w, cd_unid_med_w, nr_etiqueta_lp_w, ds_erro_w;

    if (cd_material_w IS NOT NULL AND cd_material_w::text <> '') then

	select coalesce(max('S'),'N')
	into STRICT  ie_existe_w
	from  w_separacao_quimio
	where nr_seq_ordem = nr_seq_ordem_p
	and   cd_material = cd_material_w;

	if (ie_existe_w = 'S') then

	    select coalesce(min(nr_sequencia),0)
	    into STRICT  nr_seq_separacao_w
	    from  w_separacao_quimio
	    where nr_seq_ordem = nr_seq_ordem_p
	    and   cd_material  = cd_material_w
	    and	  coalesce(ie_checado,'N') = 'N';

	    if (nr_seq_separacao_w <> 0) then

		update w_separacao_quimio
		set    ie_checado  = 'S'
		where  nr_seq_ordem = nr_seq_ordem_p
		and    cd_material  = cd_material_w
		and    nr_sequencia = nr_seq_separacao_w;

	    end if;
	else

	   select max(cd_material),
		  max(cd_grupo_material),
		  max(cd_subgrupo_material),
		  max(cd_classe_material)
	   into STRICT  cd_material_ww,
		cd_grupo_material_ww,
		cd_subgrupo_material_ww,
		cd_classe_material_ww
	   from estrutura_material_v
	   where cd_material = cd_material_w;


	   select coalesce(max(ie_permite),'N')
	   into STRICT	  ie_permite_w
	   from	  material_separacao_quimio
	   where  (((cd_material = cd_material_ww) or (coalesce(cd_material::text, '') = '')) and
		   ((cd_grupo_material = cd_grupo_material_ww) or (coalesce(cd_grupo_material::text, '') = '')) and
		   ((cd_subgrupo_material = cd_subgrupo_material_ww) or (coalesce(cd_subgrupo_material::text, '') = '')) and
		   ((cd_classe_material = cd_classe_material_ww) or (coalesce(cd_classe_material::text, '') = '')))
	   and coalesce(ie_situacao,'I') = 'A';

	   if (ie_permite_w = 'S') then
	       select max(nr_sequencia)
	       into STRICT   nr_sequencia_w
	       from   w_separacao_quimio;

	        nr_sequencia_w := nr_sequencia_w +1;

	        insert into w_separacao_quimio(
			nr_sequencia,
			nr_seq_ordem,
			dt_atualizacao,
			dt_atualizacao_nrec,
			nm_usuario,
			nm_usuario_nrec,
			ie_tipo_item,
			cd_material,
			cd_unidade_medida,
			qt_dose,
			ie_checado)
	        values (nr_sequencia_w,
			nr_seq_ordem_p,
			clock_timestamp(),
			clock_timestamp(),
			nm_usuario_p,
			nm_usuario_p,
			'M',
			cd_material_ww,
			cd_unid_med_w,
			1,
			'S');

	        commit;
	   end if;

	end if;

    end if;

end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE separar_materiais_barra (cd_mat_barra_p text, ie_tipo_barra_p text, nm_usuario_p text, nr_seq_ordem_p bigint, cd_estabelecimento_p bigint) FROM PUBLIC;

