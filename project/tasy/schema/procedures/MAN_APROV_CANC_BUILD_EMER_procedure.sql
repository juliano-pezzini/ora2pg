-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE man_aprov_canc_build_emer ( ie_aprov_canc_p text, ds_motivo_aprov_canc_p text, nr_sequencia_p bigint, nm_usuario_p text) AS $body$
DECLARE


--Procedure responsável por aprovar ou reprovar solicitacoes de build emergencial através de OS de solicitação
ie_aplicacao_w		varchar(1);
ds_aplicacao_w		varchar(2000);
ds_tempo_esp_w		varchar(2000);
cd_versao_w		varchar(15);
ds_motivo_w		varchar(255);
ds_titulo_w		varchar(2000);
ds_mensagem_w		varchar(4000);
nr_seq_ordem_serv_w	bigint;
nr_seq_control_desc_w	bigint;
nr_seq_build_sol_w		bigint;
nm_usuario_solic_w		varchar(10);
cd_pessoa_fisica_w		varchar(10);
nm_pessoa_solic_w		varchar(200);
ds_email_origem_w		varchar(500);
ds_email_solic_w		varchar(500);
ds_email_destino_w		varchar(2000);
ds_email_copia_w		varchar(2000);


BEGIN

select	b.ie_aplicacao,
	a.ds_motivo_sol ds_motivo,
	b.nr_seq_ordem_serv,
	b.nr_sequencia nr_seq_control_desc,
	a.nr_sequencia nr_seq_build_sol,
	a.nm_usuario_nrec
into STRICT	ie_aplicacao_w,
	ds_motivo_w,
	nr_seq_ordem_serv_w,
	nr_seq_control_desc_w,
	nr_seq_build_sol_w,
	nm_usuario_solic_w
from	man_os_ctrl_build_sol a,
		man_os_ctrl_desc b
where	1 = 1
and	b.nr_sequencia = a.nr_man_os_ctrl_desc
and	a.nr_sequencia = nr_sequencia_p;

if ('R' = ie_aprov_canc_p) then

	update	man_os_ctrl_desc
	set 	dt_inativacao = clock_timestamp(),
		nm_usuario_inativ = nm_usuario_p
	where	nr_sequencia =	nr_seq_control_desc_w;

	update	man_os_ctrl_build_sol
	set	ie_status_solicit = 'R',
		nm_usuario_aprov = nm_usuario_p,
		dt_atualizacao	= clock_timestamp(),
		dt_liberacao = clock_timestamp(),
		ds_motivo = ds_motivo_aprov_canc_p
	where	nr_sequencia = nr_seq_build_sol_w;

elsif ('A' = ie_aprov_canc_p) then

	update	man_os_ctrl_desc
	set 	dt_liberacao = clock_timestamp(),
		nm_usuario_lib = nm_usuario_p
	where	nr_sequencia =	nr_seq_control_desc_w;

	update	man_os_ctrl_build_sol
	set	ie_status_solicit = 'A',
		nm_usuario_aprov = nm_usuario_p,
		dt_atualizacao	= clock_timestamp(),
		dt_liberacao = clock_timestamp(),
		ds_motivo = ds_motivo_aprov_canc_p
	where	nr_sequencia = nr_seq_build_sol_w;

	select	obter_pf_usuario(nm_usuario_solic_w,'C')
	into STRICT	cd_pessoa_fisica_w
	;

	select	obter_email_usuario(cd_pessoa_fisica_w,nm_usuario_solic_w,1),
			substr(obter_nome_pf(cd_pessoa_fisica_w),1,100)
	into STRICT	ds_email_solic_w,
			nm_pessoa_solic_w
	;

	ds_mensagem_w:=	'A análise da OS ' || to_char(nr_seq_ordem_serv_w) || ' foi aprovada para o próximo build.' || chr(10) || chr(13) ||
					'Solicitante: '|| nm_pessoa_solic_w	|| chr(10) || chr(13) ||
					'Status: Aprovada'|| chr(10) || chr(13) ||
					'Motivo: ' || ds_motivo_aprov_canc_p;

	ds_email_origem_w:= 'suporte@wheb.com.br';
	ds_email_destino_w:= ds_email_solic_w || ';' ||
						'daniela.alves@philips.com;' ||
						'Fernando.chen@philips.com;'||
						'julio.bandeira@philips.com;'||
						'patricia.burigo@philips.com';

	ds_email_copia_w:= 'johnny.fusinato@philips.com;leandro.dallarosa@philips.com;Joao.Weiss@philips.com;rafael.correa@philips.com';


	--Disparar CI para grupo ambientes
	CALL enviar_email(	'Sua solicitação foi aprovada',
			ds_mensagem_w,
			ds_email_origem_w,
			ds_email_destino_w,
			'Tasy',
			null,
			ds_email_copia_w);


end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE man_aprov_canc_build_emer ( ie_aprov_canc_p text, ds_motivo_aprov_canc_p text, nr_sequencia_p bigint, nm_usuario_p text) FROM PUBLIC;

