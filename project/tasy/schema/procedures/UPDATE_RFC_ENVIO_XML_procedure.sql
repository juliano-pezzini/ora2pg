-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE update_rfc_envio_xml (nr_sequencia_p bigint, ie_commit_p text) AS $body$
DECLARE


cd_cgc_w nota_fiscal.cd_cgc%type;
cd_cgc_emitente_w nota_fiscal.cd_cgc_emitente%type;
ie_tipo_nota_w nota_fiscal.ie_tipo_nota%type;
cd_rfc_w nota_fiscal.CD_RFC_ENVIO_XML%type;
cd_pessoa_fisica_w nota_fiscal.cd_pessoa_fisica%type;


BEGIN

    	SELECT 	
		max(IE_TIPO_NOTA),
		max(CD_PESSOA_FISICA),
		max(CD_CGC_EMITENTE),
		max(CD_CGC)
    	INTO STRICT 	
        	ie_tipo_nota_w,
		cd_pessoa_fisica_w,
		cd_cgc_emitente_w,
		cd_cgc_w
    	FROM
        	nota_fiscal
	WHERE
       		nr_sequencia = nr_sequencia_p;
	
	if (ie_tipo_nota_w in ('EN', 'EF', 'EP')) then

		if (cd_pessoa_fisica_w IS NOT NULL AND cd_pessoa_fisica_w::text <> '') then
			SELECT
				CD_RFC 
			INTO STRICT
				cd_rfc_w 	
			FROM
				pessoa_fisica 
			WHERE
				cd_pessoa_fisica = cd_pessoa_fisica_w;
		else
			SELECT
				CD_RFC 
			INTO STRICT
				cd_rfc_w
			FROM 
				pessoa_juridica
			WHERE 
				cd_cgc = cd_cgc_emitente_w;
		end if;

	elsif (ie_tipo_nota_w in ('SD', 'SF', 'SE')) then

		if (cd_pessoa_fisica_w IS NOT NULL AND cd_pessoa_fisica_w::text <> '') then
			SELECT
				CD_RFC 
			INTO STRICT
				cd_rfc_w 	
			FROM 
				pessoa_fisica 
			WHERE 
				cd_pessoa_fisica = cd_pessoa_fisica_w;
		else
            		SELECT
				CD_RFC
			INTO STRICT
				cd_rfc_w	
			FROM
				pessoa_juridica
			WHERE
				cd_cgc = cd_cgc_w;
		end if;

	end if;

        update nota_fiscal
        set CD_RFC_ENVIO_XML = cd_rfc_w
        where nr_sequencia = nr_sequencia_p;

	if (ie_commit_p = 'S') then
		commit;
	end if;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE update_rfc_envio_xml (nr_sequencia_p bigint, ie_commit_p text) FROM PUBLIC;

