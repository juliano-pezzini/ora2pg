-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pep_insert_proc_pac_descricao ( cd_procedimento_p proc_pac_descricao.cd_procedimento%type, nr_atendimento_p proc_pac_descricao.nr_atendimento%type, nr_seq_proc_interno_p proc_pac_descricao.nr_seq_proc_interno%type, nm_usuario_p proc_pac_descricao.nm_usuario%type default null, ie_origem_proced_p proc_pac_descricao.ie_origem_proced%type default 11, ie_liberar_informacao_p text default 'N') AS $body$
DECLARE


nr_sequencia_w			proc_pac_descricao.nr_sequencia%type;
cd_pessoa_fisica_w		proc_pac_descricao.cd_pessoa_fisica%type;
cd_procedimento_w		procedimento.cd_procedimento%type;
ie_origem_proced_w		procedimento.ie_origem_proced%type;
dt_liberacao_w          proc_pac_descricao.dt_liberacao%type;
cd_mensagem_w           dic_objeto.nr_sequencia%type := 1137761;


BEGIN

begin
select	nextval('proc_pac_descricao_seq')
into STRICT	nr_sequencia_w
;
exception
when program_error then
    CALL wheb_mensagem_pck.exibir_mensagem_abort(cd_mensagem_w);
when data_exception then
    CALL wheb_mensagem_pck.exibir_mensagem_abort(cd_mensagem_w);
when others then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(cd_mensagem_w);
end;

begin
select	cd_pessoa_fisica
into STRICT	cd_pessoa_fisica_w
from	atendimento_paciente
where	nr_atendimento = nr_atendimento_p;
exception
when too_many_rows then
    CALL wheb_mensagem_pck.exibir_mensagem_abort(cd_mensagem_w);
when no_data_found then
    CALL wheb_mensagem_pck.exibir_mensagem_abort(cd_mensagem_w);
when others then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(cd_mensagem_w);
end;

cd_procedimento_w 	:= cd_procedimento_p;
ie_origem_proced_w 	:= ie_origem_proced_p;

if (coalesce(nr_seq_proc_interno_p,0) > 0) then
	SELECT * FROM OBTER_PROC_TAB_INTERNO(nr_seq_proc_interno_p, null, nr_atendimento_p, null, cd_procedimento_w, ie_origem_proced_w, null, null, null) INTO STRICT cd_procedimento_w, ie_origem_proced_w;
	if (coalesce(cd_procedimento_w::text, '') = '') then
		cd_procedimento_w 	:= cd_procedimento_p;
		ie_origem_proced_w 	:= ie_origem_proced_p;
	end if;
end if;

if (coalesce(ie_liberar_informacao_p,'N') = 'S') then	
	dt_liberacao_w := clock_timestamp();	
end if;

insert into proc_pac_descricao(nr_sequencia,
	dt_atualizacao, 
	nm_usuario, 
	dt_atualizacao_nrec,
	nm_usuario_nrec,
	nr_atendimento, 
	ie_situacao, 
	cd_procedimento, 
	ie_origem_proced, 
	qt_procedimento,
	nr_seq_proc_interno,
    dt_liberacao)
values (nr_sequencia_w, 
	clock_timestamp(), 
	coalesce(nm_usuario_p,wheb_usuario_pck.get_nm_usuario()), 
	clock_timestamp(), 
	coalesce(nm_usuario_p,wheb_usuario_pck.get_nm_usuario()), 
	nr_atendimento_p, 
	'A', 			 
	cd_procedimento_w, 
	ie_origem_proced_w,   
	1,
	nr_seq_proc_interno_p,
    dt_liberacao_w);

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pep_insert_proc_pac_descricao ( cd_procedimento_p proc_pac_descricao.cd_procedimento%type, nr_atendimento_p proc_pac_descricao.nr_atendimento%type, nr_seq_proc_interno_p proc_pac_descricao.nr_seq_proc_interno%type, nm_usuario_p proc_pac_descricao.nm_usuario%type default null, ie_origem_proced_p proc_pac_descricao.ie_origem_proced%type default 11, ie_liberar_informacao_p text default 'N') FROM PUBLIC;

