-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pcs_gerar_table_lista ( cd_estabelecimento_p bigint, nr_seq_registro_p bigint, ie_possui_solic_p text, ie_possui_emprestimo_p text, ie_possui_transf_p text, cd_atributo_filtro_p text default null, vl_de_p bigint default 0, vl_ate_p bigint default 0, nm_usuario_p text DEFAULT NULL) AS $body$
DECLARE



ds_sql_where_w			varchar(4000);
nm_informacao_w			varchar(255);
vl_informacao_w			varchar(255);
cd_material_w			integer;
ds_comando1_w			varchar(4000);
ds_comando2_w			varchar(4000);
ds_comando3_w			varchar(4000);
qt_tamanho_w			bigint;
ds_material_w			varchar(255);
nr_ordenacao_w			integer;
nr_seq_reg_analise_w		bigint;
nr_reg_analise_item_w		bigint;
ie_status_analise_w		varchar(50);
nr_solic_compra_w		bigint;
nr_ordem_compra_w		bigint;
nr_emprestimo_w			bigint;
ds_insert_w  			varchar(4000);
ds_valor_w   			varchar(4000);
ds_comando_w 			varchar(4000);
ds_create_w  			varchar(4000);
qt_tabela_w  			bigint:=0;
nm_tabela_w 			varchar(60);
ds_erro_w			varchar(255);



i integer := 0;

c00 CURSOR FOR
	SELECT nm_informacao,
		nr_ordenacao
      from pcs_reg_analise a, pcs_reg_analise_itens b
     where a.nr_sequencia = b.nr_seq_registro
       and a.nr_sequencia = nr_seq_registro_p
     group by nm_informacao,nr_ordenacao
     order by 2;

  C01 CURSOR FOR
    SELECT b.cd_material,
	   b.ie_status_analise,
	   a.nr_sequencia,
	   b.nr_solic_compra,
	   b.nr_ordem_compra,
		b.nr_emprestimo
      from pcs_reg_analise a, pcs_reg_analise_itens b
     where a.nr_sequencia = b.nr_seq_registro
       and a.nr_sequencia = nr_seq_registro_p
	and	((((b.nr_solic_compra IS NOT NULL AND b.nr_solic_compra::text <> '') and ie_possui_solic_p = 'S')
	or ((b.nr_emprestimo IS NOT NULL AND b.nr_emprestimo::text <> '') and ie_possui_emprestimo_p = 'S')
	or ((b.nr_ordem_compra IS NOT NULL AND b.nr_ordem_compra::text <> '') and ie_possui_transf_p = 'S'))
	or (ie_possui_solic_p = 'N') and (ie_possui_transf_p = 'N') and (ie_possui_emprestimo_p = 'N'))
	and	((coalesce(cd_atributo_filtro_p::text, '') = '') or ((cd_atributo_filtro_p = nm_informacao) and (CASE WHEN vl_informacao='null' THEN '0'  ELSE vl_informacao END  >= vl_de_p) and (CASE WHEN vl_informacao='null' THEN '0'  ELSE vl_informacao END  <= vl_ate_p)))
     group by b.cd_material,
     b.ie_status_analise,
	a.nr_sequencia,
	   b.nr_solic_compra,
	   b.nr_ordem_compra,
		b.nr_emprestimo
     order by 1;

  c02 CURSOR(cd_material_p bigint) FOR
    SELECT nm_informacao, vl_informacao
      from pcs_reg_analise a, pcs_reg_analise_itens b
     where a.nr_sequencia = b.nr_seq_registro
       and a.nr_sequencia = nr_seq_registro_p
       and cd_material = cd_material_p
       and b.cd_estabelecimento = cd_estabelecimento_p
     order by 1;
BEGIN


  nm_tabela_w  := Elimina_Caracteres_Especiais('PCS_ANALISE_COL_W_'||upper(elimina_caracteres_especiais(nm_usuario_p)));

  select count(1)
    into STRICT qt_tabela_w
    from user_tables
   where table_name = nm_tabela_w;



  if qt_tabela_w > 0 then
     EXECUTE 'truncate table '||nm_tabela_w;
     EXECUTE 'drop table '||nm_tabela_w;
  end if;


  --criar tabela temporaria
  for r00 in c00 loop
	ds_comando_w := ds_comando_w || r00.nm_informacao ||' varchar2(255), ';
  end loop;
  ds_comando_w := ds_comando_w ||' NR_SEQ_REGISTRO VARCHAR2(10), NR_SOLIC_COMPRA NUMBER(10), NR_ORDEM_COMPRA NUMBER(10), NR_EMPRESTIMO NUMBER(10), IE_STATUS_ANALISE VARCHAR2(10) ';

  ds_create_w := 'create global temporary table '||nm_tabela_w||'(';
  ds_create_w := ds_create_w || ds_comando_w || ') on commit preserve rows';
  --ds_create_w := 'create table '||nm_tabela_w||'(';
  --ds_create_w := ds_create_w || ds_comando_w || ') ';
  EXECUTE ds_create_w;

  for r01 in c01 loop
    ds_comando_w := null;
    ds_insert_w  := null;
    ds_valor_w   := null;

    --insere os regisotros na tabela temporaria
    for r02 in c02(r01.cd_material) loop


        ds_insert_w := ds_insert_w|| r02.nm_informacao||','|| chr(13) || chr(10);
        ds_valor_w  := ds_valor_w || chr(39) || r02.vl_informacao ||chr(39) || ','||chr(13) || chr(10);

    end loop;

    ds_insert_w := ds_insert_w||'NR_SEQ_REGISTRO, NR_SOLIC_COMPRA, NR_ORDEM_COMPRA, NR_EMPRESTIMO, IE_STATUS_ANALISE ';
    ds_valor_w  := ds_valor_w||r01.nr_sequencia || ',' || coalesce(r01.nr_solic_compra,0) || ',' || coalesce(r01.nr_ordem_compra,0) || ',' ||  coalesce(r01.nr_emprestimo,0) || ',' || chr(39) || r01.ie_status_analise || chr(39);


    if (ds_insert_w IS NOT NULL AND ds_insert_w::text <> '') and (ds_valor_w IS NOT NULL AND ds_valor_w::text <> '') then
      ds_comando_w := 'insert into '||nm_tabela_w||'(' || ds_insert_w || ')' ||
                    chr(13) || chr(10) || 'values (' || ds_valor_w || ')';


    end if;

    EXECUTE ds_comando_w;
  end loop;

  commit;

  end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pcs_gerar_table_lista ( cd_estabelecimento_p bigint, nr_seq_registro_p bigint, ie_possui_solic_p text, ie_possui_emprestimo_p text, ie_possui_transf_p text, cd_atributo_filtro_p text default null, vl_de_p bigint default 0, vl_ate_p bigint default 0, nm_usuario_p text DEFAULT NULL) FROM PUBLIC;

