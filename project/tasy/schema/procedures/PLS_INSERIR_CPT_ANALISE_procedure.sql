-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_inserir_cpt_analise ( nr_seq_pessoa_proposta_p bigint, nr_seq_analise_adesao_p bigint, ds_lista_cpt_p text, nm_usuario_p text) AS $body$
DECLARE


ds_lista_cpt_w			varchar(4000);
nr_seq_cpt_w			bigint;
qt_dias_padrao_w		integer;
nr_seq_pessoa_proposta_w	pls_carencia.nr_seq_pessoa_proposta%type := null;
nr_seq_analise_adesao_w		pls_carencia.nr_seq_analise_adesao%type := null;


BEGIN
if (nr_seq_pessoa_proposta_p > 0) then -- Adicionado "IF" pra fazer no banco a validação e não na aplicação
	nr_seq_pessoa_proposta_w := nr_seq_pessoa_proposta_p;
else
	nr_seq_analise_adesao_w := nr_seq_analise_adesao_p;
end if;

ds_lista_cpt_w	:= ds_lista_cpt_p;

while(ds_lista_cpt_w IS NOT NULL AND ds_lista_cpt_w::text <> '') loop
	begin

	select  (substr(ds_lista_cpt_w,1,position(',' in ds_lista_cpt_w)))::numeric ,
		substr(ds_lista_cpt_w,position(',' in ds_lista_cpt_w) +1,length(ds_lista_cpt_w))
	into STRICT    nr_seq_cpt_w,
		ds_lista_cpt_w
	;

	select	coalesce(max(qt_dias_padrao),0)
	into STRICT	qt_dias_padrao_w
	from	pls_tipo_carencia
	where	nr_sequencia	= nr_seq_cpt_w;

	if (coalesce(nr_seq_cpt_w,0) <> 0) then
		insert into pls_carencia(	nr_sequencia,
						dt_atualizacao,
						nm_usuario,
						dt_atualizacao_nrec,
						nm_usuario_nrec,
						nr_seq_tipo_carencia,
						qt_dias,
						dt_inicio_vigencia,
						nr_seq_pessoa_proposta,
						nr_seq_analise_adesao)
					values (	nextval('pls_carencia_seq'),
						clock_timestamp(),
						nm_usuario_p,
						clock_timestamp(),
						nm_usuario_p,
						nr_seq_cpt_w,
						qt_dias_padrao_w,
						null,
						nr_seq_pessoa_proposta_w,
						nr_seq_analise_adesao_w);

	end if;
	end;
end loop;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_inserir_cpt_analise ( nr_seq_pessoa_proposta_p bigint, nr_seq_analise_adesao_p bigint, ds_lista_cpt_p text, nm_usuario_p text) FROM PUBLIC;

