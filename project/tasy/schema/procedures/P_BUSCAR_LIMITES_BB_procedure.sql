-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE p_buscar_limites_bb ( nr_atendimento_p atend_paciente_unidade.nr_atendimento%type, cd_setor_atendimento_p atend_paciente_unidade.cd_setor_atendimento%TYPE, cd_pessoa_fisica_p PESSOA_FISICA.cd_pessoa_fisica%TYPE, bb_nome_setor_p text default null, json_aux_bb INOUT text  DEFAULT NULL) AS $body$
DECLARE

  envio_integracao_bb philips_json;
  json_patient_bb philips_json;
  json_heart_rate_bb philips_json;
  json_blood_pressure_bb philips_json;
  json_respiratory_rate_bb philips_json;
  json_oxygen_saturation_bb philips_json;
  bb_nome_setor_w varchar(100);

  limit_items_c CURSOR FOR
    SELECT    r.nr_sequencia,
              r.nr_seq_sinal,
              r.nr_baixa_severa_sa,
              r.nr_baixa_moderada_sa,
              r.nr_alta_moderada_sa,
              r.nr_alta_severa_sa
    FROM      sinal_vital_regra r,
              sinal_vital sv,
              pessoa_fisica pf
    WHERE     sv.nr_sequencia IN (3, 6, 8, 9)
    AND       sv.nr_sequencia = r.nr_seq_sinal
    AND       pf.cd_pessoa_fisica = cd_pessoa_fisica_p
    AND       TRUNC(MONTHS_BETWEEN(clock_timestamp(), pf.dt_nascimento) / 12) between coalesce(r.qt_idade_min,0) and coalesce(r.qt_idade_max,9999999999)
    AND       TRUNC(clock_timestamp() - pf.dt_nascimento) between coalesce(r.qt_idade_min_dias,0) and coalesce(r.qt_idade_max_dias,9999999999)
    AND (
                r.cd_setor_atendimento = cd_setor_atendimento_p
                OR coalesce(r.cd_setor_atendimento::text, '') = ''
              )
    AND       coalesce(r.ie_sexo, pf.ie_sexo) = pf.ie_sexo
    ORDER BY  r.nr_sequencia ASC;

  limit_items_patient_c CURSOR FOR
    SELECT      nr_sequencia,
                nr_seq_sinal,
                nr_baixa_severa,
                nr_baixa_moderada,
                nr_alta_moderada,
                nr_alta_severa
      FROM      SMART_ALERT_REGRA_ATEND
      WHERE     nr_atendimento = nr_atendimento_p
      ORDER BY  nr_sequencia ASC;
BEGIN

  json_patient_bb := philips_json();
  envio_integracao_bb := philips_json();
  json_heart_rate_bb := philips_json();
  json_blood_pressure_bb := philips_json();
  json_respiratory_rate_bb := philips_json();
  json_oxygen_saturation_bb := philips_json();
  bb_nome_setor_w := bb_nome_setor_p;

  IF coalesce(bb_nome_setor_p::text, '') = '' THEN
      SELECT
          CASE
          WHEN cd_classif_setor = 4 AND coalesce(ie_semi_intensiva, 'N') = 'N'
          THEN 'ICU'
          WHEN cd_classif_setor = 4 AND coalesce(ie_semi_intensiva, 'N') = 'S'
          THEN 'Stepdown'
          WHEN cd_classif_setor = 1 OR cd_classif_setor = 3
          THEN 'Acute'
          ELSE ''
          END as bb_type
      INTO STRICT  bb_nome_setor_w
      FROM  setor_atendimento
      WHERE CD_SETOR_ATENDIMENTO = cd_setor_atendimento_p;
  END IF;

  envio_integracao_bb.put('messageDateTime', TO_CHAR((CURRENT_TIMESTAMP AT TIME ZONE 'UTC'), 'YYYY-MM-DD HH24:MI:SS.SSSSS'));
  envio_integracao_bb.put('patientHealthSystemStayID', LPAD(nr_atendimento_p, 32, 0));

  json_heart_rate_bb.put('rangeType', '34a34fc43eeb4f669bf2f8725be33b30');
  json_blood_pressure_bb.put('rangeType', '260c70dbb0ec4a40b0a25eb06b8fbe71');
  json_respiratory_rate_bb.put('rangeType', '9af6d32864024a69830d312eff161935');
  json_oxygen_saturation_bb.put('rangeType', 'd13012dc57ae4c4e8c8494936794c297');

  IF (bb_nome_setor_w = 'Acute') THEN
    envio_integracao_bb.put('type', 'Acute');
    json_heart_rate_bb.put('severeLow', 40);
    json_heart_rate_bb.put('moderateLow', 50);
    json_heart_rate_bb.put('moderateHigh', 129);
    json_heart_rate_bb.put('severeHigh', 135);
    json_blood_pressure_bb.put('severeLow', 60);
    json_blood_pressure_bb.put('moderateLow', 65);
    json_blood_pressure_bb.put('moderateHigh', 120);
    json_blood_pressure_bb.put('severeHigh', 130);
    json_respiratory_rate_bb.put('severeLow', 7);
    json_respiratory_rate_bb.put('moderateLow', 9);
    json_respiratory_rate_bb.put('moderateHigh', 30);
    json_respiratory_rate_bb.put('severeHigh', 35);
    json_oxygen_saturation_bb.put('severeLow', 85);
    json_oxygen_saturation_bb.put('moderateLow', 88);
  ELSIF (bb_nome_setor_w = 'ICU') THEN
    envio_integracao_bb.put('type', 'ICU');
    json_heart_rate_bb.put('severeLow', 40);
    json_heart_rate_bb.put('moderateLow', 50);
    json_heart_rate_bb.put('moderateHigh', 130);
    json_heart_rate_bb.put('severeHigh', 150);
    json_blood_pressure_bb.put('severeLow', 60);
    json_blood_pressure_bb.put('moderateLow', 70);
    json_blood_pressure_bb.put('moderateHigh', 120);
    json_blood_pressure_bb.put('severeHigh', 150);
    json_respiratory_rate_bb.put('severeLow', 7);
    json_respiratory_rate_bb.put('moderateLow', '');
    json_respiratory_rate_bb.put('moderateHigh', '');
    json_respiratory_rate_bb.put('severeHigh', 40);
    json_oxygen_saturation_bb.put('severeLow', 80);
    json_oxygen_saturation_bb.put('moderateLow', '');
  END IF;

  FOR item IN limit_items_c LOOP

    IF (item.nr_seq_sinal = 9) THEN

      IF (item.nr_baixa_severa_sa IS NOT NULL AND item.nr_baixa_severa_sa::text <> '') THEN
        json_heart_rate_bb.put('severeLow', item.nr_baixa_severa_sa);
      END IF;

      IF (item.nr_baixa_moderada_sa IS NOT NULL AND item.nr_baixa_moderada_sa::text <> '') THEN
        json_heart_rate_bb.put('moderateLow', item.nr_baixa_moderada_sa);
      END IF;

      IF (item.nr_alta_moderada_sa IS NOT NULL AND item.nr_alta_moderada_sa::text <> '') THEN
        json_heart_rate_bb.put('moderateHigh', item.nr_alta_moderada_sa);
      END IF;

      IF (item.nr_alta_severa_sa IS NOT NULL AND item.nr_alta_severa_sa::text <> '') THEN
        json_heart_rate_bb.put('severeHigh', item.nr_alta_severa_sa);
      END IF;

    END IF;

    IF (item.nr_seq_sinal = 8) THEN

      IF (item.nr_baixa_severa_sa IS NOT NULL AND item.nr_baixa_severa_sa::text <> '') THEN
        json_blood_pressure_bb.put('severeLow', item.nr_baixa_severa_sa);
      END IF;

      IF (item.nr_baixa_moderada_sa IS NOT NULL AND item.nr_baixa_moderada_sa::text <> '') THEN
        json_blood_pressure_bb.put('moderateLow', item.nr_baixa_moderada_sa);
      END IF;

      IF (item.nr_alta_moderada_sa IS NOT NULL AND item.nr_alta_moderada_sa::text <> '') THEN
        json_blood_pressure_bb.put('moderateHigh', item.nr_alta_moderada_sa);
      END IF;

      IF (item.nr_alta_severa_sa IS NOT NULL AND item.nr_alta_severa_sa::text <> '') THEN
        json_blood_pressure_bb.put('severeHigh', item.nr_alta_severa_sa);
      END IF;
    END IF;

    IF (item.nr_seq_sinal = 3) THEN

      IF (item.nr_baixa_severa_sa IS NOT NULL AND item.nr_baixa_severa_sa::text <> '') THEN
        json_respiratory_rate_bb.put('severeLow', item.nr_baixa_severa_sa);
      END IF;

      IF (item.nr_baixa_moderada_sa IS NOT NULL AND item.nr_baixa_moderada_sa::text <> '') THEN
        json_respiratory_rate_bb.put('moderateLow', item.nr_baixa_moderada_sa);
      END IF;

      IF (item.nr_alta_moderada_sa IS NOT NULL AND item.nr_alta_moderada_sa::text <> '') THEN
        json_respiratory_rate_bb.put('moderateHigh', item.nr_alta_moderada_sa);
      END IF;

      IF (item.nr_alta_severa_sa IS NOT NULL AND item.nr_alta_severa_sa::text <> '') THEN
        json_respiratory_rate_bb.put('severeHigh', item.nr_alta_severa_sa);
      END IF;
    END IF;

    IF (item.nr_seq_sinal = 6) THEN
      IF (item.nr_baixa_severa_sa IS NOT NULL AND item.nr_baixa_severa_sa::text <> '') THEN
        json_oxygen_saturation_bb.put('severeLow', item.nr_baixa_severa_sa);
      END IF;

      IF (item.nr_baixa_moderada_sa IS NOT NULL AND item.nr_baixa_moderada_sa::text <> '') THEN
        json_oxygen_saturation_bb.put('moderateLow', item.nr_baixa_moderada_sa);
      END IF;
    END IF;

  END LOOP;

  envio_integracao_bb.put('heartRate', json_heart_rate_bb);
  envio_integracao_bb.put('bloodPressure', json_blood_pressure_bb);
  envio_integracao_bb.put('respiratoryRate', json_respiratory_rate_bb);
  envio_integracao_bb.put('oxygenSaturation', json_oxygen_saturation_bb);

  FOR item IN limit_items_patient_c LOOP

    IF (item.nr_seq_sinal = 9) THEN

      IF (item.nr_baixa_severa IS NOT NULL AND item.nr_baixa_severa::text <> '') THEN
        json_heart_rate_bb.put('severeLow', item.nr_baixa_severa);
      END IF;

      IF (item.nr_baixa_moderada IS NOT NULL AND item.nr_baixa_moderada::text <> '') THEN
        json_heart_rate_bb.put('moderateLow', item.nr_baixa_moderada);
      END IF;

      IF (item.nr_alta_moderada IS NOT NULL AND item.nr_alta_moderada::text <> '') THEN
        json_heart_rate_bb.put('moderateHigh', item.nr_alta_moderada);
      END IF;

      IF (item.nr_alta_severa IS NOT NULL AND item.nr_alta_severa::text <> '') THEN
        json_heart_rate_bb.put('severeHigh', item.nr_alta_severa);
      END IF;

    END IF;

    IF (item.nr_seq_sinal = 8) THEN

      IF (item.nr_baixa_severa IS NOT NULL AND item.nr_baixa_severa::text <> '') THEN
        json_blood_pressure_bb.put('severeLow', item.nr_baixa_severa);
      END IF;

      IF (item.nr_baixa_moderada IS NOT NULL AND item.nr_baixa_moderada::text <> '') THEN
        json_blood_pressure_bb.put('moderateLow', item.nr_baixa_moderada);
      END IF;

      IF (item.nr_alta_moderada IS NOT NULL AND item.nr_alta_moderada::text <> '') THEN
        json_blood_pressure_bb.put('moderateHigh', item.nr_alta_moderada);
      END IF;

      IF (item.nr_alta_severa IS NOT NULL AND item.nr_alta_severa::text <> '') THEN
        json_blood_pressure_bb.put('severeHigh', item.nr_alta_severa);
      END IF;
    END IF;

    IF (item.nr_seq_sinal = 3) THEN
      
      IF (item.nr_baixa_severa IS NOT NULL AND item.nr_baixa_severa::text <> '') THEN
        json_respiratory_rate_bb.put('severeLow', item.nr_baixa_severa);
      END IF;

      IF (item.nr_baixa_moderada IS NOT NULL AND item.nr_baixa_moderada::text <> '') THEN
        json_respiratory_rate_bb.put('moderateLow', item.nr_baixa_moderada);
      END IF;

      IF (item.nr_alta_moderada IS NOT NULL AND item.nr_alta_moderada::text <> '') THEN
        json_respiratory_rate_bb.put('moderateHigh', item.nr_alta_moderada);
      END IF;

      IF (item.nr_alta_severa IS NOT NULL AND item.nr_alta_severa::text <> '') THEN
        json_respiratory_rate_bb.put('severeHigh', item.nr_alta_severa);
      END IF;
    END IF;

    IF (item.nr_seq_sinal = 6) THEN

      IF (item.nr_baixa_severa IS NOT NULL AND item.nr_baixa_severa::text <> '') THEN
        json_oxygen_saturation_bb.put('severeLow', item.nr_baixa_severa);
      END IF;

      IF (item.nr_baixa_moderada IS NOT NULL AND item.nr_baixa_moderada::text <> '') THEN
        json_oxygen_saturation_bb.put('moderateLow', item.nr_baixa_moderada);
      END IF;
    END IF;

  END LOOP;

  json_patient_bb.put('heartRate', json_heart_rate_bb);
  json_patient_bb.put('bloodPressure', json_blood_pressure_bb);
  json_patient_bb.put('respiratoryRate', json_respiratory_rate_bb);
  json_patient_bb.put('oxygenSaturation', json_oxygen_saturation_bb);

  envio_integracao_bb.put('patient', json_patient_bb);
  
  dbms_lob.createtemporary(json_aux_bb, TRUE);
  envio_integracao_bb.(json_aux_bb);

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE p_buscar_limites_bb ( nr_atendimento_p atend_paciente_unidade.nr_atendimento%type, cd_setor_atendimento_p atend_paciente_unidade.cd_setor_atendimento%TYPE, cd_pessoa_fisica_p PESSOA_FISICA.cd_pessoa_fisica%TYPE, bb_nome_setor_p text default null, json_aux_bb INOUT text  DEFAULT NULL) FROM PUBLIC;

