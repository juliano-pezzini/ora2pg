-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE fin_recuperar_perda ( nr_seq_movto_trans_p bigint, ie_acao_p text, ie_commit_p text, nm_usuario_p text) AS $body$
DECLARE


nr_seq_tipo_baixa_perda_w		bigint;
nr_seq_perda_w			bigint;
vl_saldo_perda_w			double precision;
vl_baixa_perda_w			double precision;
vl_juros_perda_w			double precision;
vl_transacao_w			double precision;
ie_tipo_perda_w			varchar(1);
nr_seq_movto_orig_w		bigint;
nr_seq_baixa_w			integer;
dt_transacao_w			timestamp;

c01 CURSOR FOR
SELECT	nr_seq_perda,
	nr_sequencia
from	perda_contas_receb_baixa
where	nr_seq_movto_trans_fin  = nr_seq_movto_orig_w;


BEGIN
select	a.vl_transacao,
	a.nr_seq_perda,
	b.nr_seq_tipo_baixa_perda,
	a.nr_seq_movto_orig,
	a.dt_transacao
into STRICT	vl_transacao_w,
	nr_seq_perda_w,
	nr_seq_tipo_baixa_perda_w,
	nr_seq_movto_orig_w,
	dt_transacao_w
from	movto_trans_financ a,
	transacao_financeira b
where	a.nr_seq_trans_financ = b.nr_sequencia
and	a.nr_sequencia = nr_seq_movto_trans_p;

if (ie_acao_p = 'I') then
	begin
	begin
	select	vl_saldo,
		coalesce(ie_tipo_perda,'R')
	into STRICT	vl_saldo_perda_w,
		ie_tipo_perda_w
	from	perda_contas_receber
	where	nr_sequencia = nr_seq_perda_w;
	exception
	when others then
		ie_tipo_perda_w := 'X';
	end;

	if (ie_tipo_perda_w = 'I') then
		CALL wheb_mensagem_pck.exibir_mensagem_abort(216749);
	elsif (ie_tipo_perda_w = 'R') then
		begin
		vl_baixa_perda_w	:= abs(vl_transacao_w);
		vl_juros_perda_w	:= 0;

		if (vl_saldo_perda_w < vl_baixa_perda_w) then
			begin
			vl_juros_perda_w 	:= abs(vl_saldo_perda_w - vl_baixa_perda_w);
			vl_baixa_perda_w	:= vl_saldo_perda_w;
			end;
		end if;

		if (coalesce(nr_seq_tipo_baixa_perda_w::text, '') = '') then
			CALL wheb_mensagem_pck.exibir_mensagem_abort(216751);
		end if;

		if (vl_baixa_perda_w > 0) then
			CALL fin_gerar_baixa_perda(nr_seq_perda_w, vl_baixa_perda_w, nr_seq_tipo_baixa_perda_w, '1', nr_seq_movto_trans_p, dt_transacao_w, nm_usuario_p);
		end if;

		if (vl_juros_perda_w > 0) then
			begin
			select	max(nr_sequencia)
			into STRICT	nr_seq_tipo_baixa_perda_w
			from	fin_tipo_baixa_perda
			where	ie_situacao = 'A'
			and	ie_tipo_consistencia = '3';

			if (coalesce(nr_seq_tipo_baixa_perda_w::text, '') = '') then
				CALL wheb_mensagem_pck.exibir_mensagem_abort(216750);
			end if;

			CALL fin_gerar_baixa_perda(nr_seq_perda_w, vl_juros_perda_w, nr_seq_tipo_baixa_perda_w, '1', nr_seq_movto_trans_p, dt_transacao_w, nm_usuario_p);
			end;
		end if;

		CALL fin_atualiza_cobranca_perda(nr_seq_perda_w, 'RP', 'N', nm_usuario_p);
		end;
	end if;
	end;
else
	begin
	open c01;
	loop
	fetch c01 into
		nr_seq_perda_w,
		nr_seq_baixa_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
		CALL fin_estornar_baixa_perda(nr_seq_perda_w, nr_seq_baixa_w, nr_seq_movto_trans_p, dt_transacao_w, nm_usuario_p);
	end loop;
	close c01;
	end;
end if;

if (ie_commit_p = 'S') then
	commit;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE fin_recuperar_perda ( nr_seq_movto_trans_p bigint, ie_acao_p text, ie_commit_p text, nm_usuario_p text) FROM PUBLIC;

