-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_evolucao_sae (( nr_sequencia_p bigint, nm_usuario_p text) is dt_liberacao_w timestamp) RETURNS varchar AS $body$
DECLARE

ie_alinhamento_w	varchar(1);
ds_conteudo_w	varchar(32000);
ds_retorno_w	varchar(32000);
qt_tamanho_w	smallint := qt_tamanho_p * 2;


BEGIN	


if (ie_alinhamento_p = 'E') then
	ie_alinhamento_w := 'l';
elsif (ie_alinhamento_p = 'D') then
	ie_alinhamento_w := 'r';
elsif (ie_alinhamento_p = 'C') then
	ie_alinhamento_w := 'c';
else	ie_alinhamento_w := 'j';
end if;

ds_conteudo_w := replace(ds_conteudo_p,chr(10),chr(13) || chr(10) || '\par ');

ds_retorno_w := '{\rtf1\ansi\ansicpg1252\deff0{\fonttbl{\f0\fnil\fcharset0 ' || ds_fonte_p || ';}}' 	|| chr(13) || chr(10) ||
		'{\colortbl ;\red0\green0\blue;}' 							|| chr(13) || chr(10) ||
			'\viewkind4\uc1\pard\q' || ie_alinhamento_w || '\cf1\lang1046\f0\fs' || qt_tamanho_w || ' ' ||
			ds_conteudo_w || ' \par }' || chr(13) || chr(10);
		
return	ds_retorno_w;

end;

begin

select coalesce(max('S'),'N')
into STRICT ie_evolucao_existe_w
from evolucao_paciente
where nr_seq_sae = nr_sequencia_p;

if (ie_evolucao_existe_w = 'S') then

	CALL gravar_log_tasy(4042, 'Finalizada gerar_evolucao_sae. Ja existe uma evolucao com nr_seq_sae: '|| nr_sequencia_p, nm_usuario_p);

else

cd_perfil_ativo_w := obter_perfil_ativo;

select	coalesce(max(nr_atendimento), 0)
into STRICT	nr_atendimento_w
from	pe_prescricao
where	nr_sequencia = nr_sequencia_p;

select	coalesce(max(cd_estabelecimento), 0)
into STRICT	cd_estabelecimento_w
from	atendimento_paciente
where	nr_atendimento = nr_atendimento_w;

ie_libera_sae_w := obter_param_usuario(281, 384, cd_perfil_ativo_w, nm_usuario_p, cd_estabelecimento_w, ie_libera_sae_w);
ie_gera_intervencao_w := obter_param_usuario(281, 835, cd_perfil_ativo_w, nm_usuario_p, cd_estabelecimento_w, ie_gera_intervencao_w);

select	max(cd_prescritor),
		max(cd_pessoa_fisica),
		max(CASE WHEN ie_libera_sae_w='S' THEN  coalesce(dt_liberacao, clock_timestamp())  ELSE null END ),
		max(ie_rn),
		max(nr_Seq_modelo),
		max(DT_PRESCRICAO),
		max(nr_seq_triagem)
into STRICT	cd_prescritor_w,
	cd_pessoa_fisica_w,
	dt_liberacao_w,
	ie_rn_w,
	nr_Seq_modelo_w,
	dt_sae_w,
	nr_seq_triagem_w
from	pe_prescricao
where	nr_sequencia = nr_sequencia_p;

select	count(*)
into STRICT	qt_registro_w
from	pe_prescr_item_result
where	nr_seq_prescr = nr_sequencia_p;

select	count(*)
into STRICT	qt_registro_interv_w
from	pe_prescr_proc
where	nr_seq_prescr = nr_sequencia_p;

if (qt_registro_w > 0) or (qt_registro_interv_w > 0 AND ie_gera_intervencao_w = 'S') then
	ie_gera_comentario_w := obter_param_usuario(281, 298, cd_perfil_ativo_w, nm_usuario_p, cd_estabelecimento_w, ie_gera_comentario_w);
	ie_gera_diagnostico_w := obter_param_usuario(281, 300, cd_perfil_ativo_w, nm_usuario_p, cd_estabelecimento_w, ie_gera_diagnostico_w);
	ie_gera_sinais_vitais_w := obter_param_usuario(281, 1350, cd_perfil_ativo_w, nm_usuario_p, cd_estabelecimento_w, ie_gera_sinais_vitais_w);
	ie_gera_aspecto_analisado_w := obter_param_usuario(281, 1457, cd_perfil_ativo_w, nm_usuario_p, cd_estabelecimento_w, ie_gera_aspecto_analisado_w);	
	ds_fonte_w := Obter_Param_Usuario(281, 5, cd_perfil_ativo_w, nm_usuario_p, cd_estabelecimento_w, ds_fonte_w);
	ds_tam_fonte_w := Obter_Param_Usuario(281, 6, cd_perfil_ativo_w, nm_usuario_p, cd_estabelecimento_w, ds_tam_fonte_w);
	ds_parametro_w := Obter_param_Usuario(281, 619, cd_perfil_ativo_w, nm_usuario_p, cd_estabelecimento_w, ds_parametro_w);
	ie_gera_alergias_w := obter_param_usuario(281, 1687, cd_perfil_ativo_w, nm_usuario_p, cd_estabelecimento_w, ie_gera_alergias_w);
	nr_tam_fonte_w := somente_numero(ds_tam_fonte_w) * 2;

	select	max(ie_tipo_evolucao)
	into STRICT	ie_tipo_evolucao_w
	from	usuario
	where	nm_usuario = nm_usuario_p;
	
	if (coalesce(ie_tipo_evolucao_w::text, '') = '') then
		-- Tipo de evolucao nao informado para este usuario. 
		CALL Wheb_mensagem_pck.exibir_mensagem_abort(264634);
	end if;
	
	/************************* executar cursor *************************/
	

	ds_modelo_w := substr(obter_desc_mod_sae(nr_Seq_modelo_w), 1, 250);
	
	if (ds_modelo_w IS NOT NULL AND ds_modelo_w::text <> '') then
		ds_modelo_w := '\b ' || '                                                                                  ' || ds_modelo_w || ' \b0 \par \par ';
	end if;
	
	if (nr_seq_triagem_w IS NOT NULL AND nr_seq_triagem_w::text <> '') then
				
		select	max(substr(ds_queixa_princ,1,255)),
				max(nr_seq_queixa)
		into STRICT	ds_queixa_princ_w,
				nr_seq_queixa_w
		from	triagem_pronto_atend a
		where	a.nr_sequencia = nr_seq_triagem_w;
		
		select	max(substr(ds_queixa,1,255))
		into STRICT	ds_queixa_w
		from	queixa_paciente
		where	nr_sequencia = coalesce(nr_seq_queixa_w,0);
		
		if ((trim(both ds_queixa_w) IS NOT NULL AND (trim(both ds_queixa_w))::text <> '')) then
			ds_evolucao_w := ds_evolucao_w || wheb_rtf_pck.get_negrito(true) || wheb_mensagem_pck.get_texto(450976) || ': ' || wheb_rtf_pck.get_negrito(false) || ds_queixa_w || chr(13) || chr(10);
		end if;
		
		if (ds_queixa_princ_w IS NOT NULL AND ds_queixa_princ_w::text <> '') then
			ds_evolucao_w := ds_evolucao_w || wheb_rtf_pck.get_negrito(true) || wheb_mensagem_pck.get_texto(450977) || ': ' || wheb_rtf_pck.get_negrito(false) || ds_queixa_princ_w || chr(13) || chr(10) || chr(13) || chr(10);
		end if;	
		
	end if;
	
	
	if (ie_gera_aspecto_analisado_w = 'S') then

		open c01;
		loop
			fetch c01 into
				nr_seq_w,
				ds_tipo_item_w,
				nr_seq_apres_w;
			EXIT WHEN NOT FOUND; /* apply on c01 */
				ds_aux_w := obter_resultados_concat(nr_seq_w, nr_sequencia_p);
				
				if (coalesce(ds_parametro_w, 'N') = 'S') then
					ds_evolucao_w := ds_evolucao_w || espacamento_w || wheb_rtf_pck.get_negrito(true) || ds_tipo_item_w || wheb_rtf_pck.get_negrito(false) || chr(13) || chr(10) || '	';
					
					if (ds_aux_w IS NOT NULL AND ds_aux_w::text <> '') then
						ds_evolucao_w := ds_evolucao_w || ds_aux_w || chr(13) || chr(10);
					end if;
					
					if (ds_observacao_w IS NOT NULL AND ds_observacao_w::text <> '') then
						ds_evolucao_w := ds_evolucao_w || ds_observacao_w || chr(13) || chr(10);
					end if;
					espacamento_w := chr(13) || chr(10);
				end if;
				
				if (coalesce(ds_parametro_w, 'N') = 'N') then
					ds_evolucao_w := ds_evolucao_w || wheb_rtf_pck.get_negrito(true) || ds_tipo_item_w || wheb_rtf_pck.get_negrito(false) || chr(13) || chr(10);
					
					if (ds_aux_w IS NOT NULL AND ds_aux_w::text <> '') then
						ds_evolucao_w := ds_evolucao_w || ds_aux_w || chr(13) || chr(10);
					end if;
					
					if (ds_observacao_w IS NOT NULL AND ds_observacao_w::text <> '') then
						ds_evolucao_w := ds_evolucao_w || ds_observacao_w || chr(13) || chr(10);
					end if;
				end if;	
				
				if (coalesce(ds_parametro_w, 'N') = 'T') then
					ds_evolucao_w := ds_evolucao_w || wheb_rtf_pck.get_negrito(true) || ds_tipo_item_w || wheb_rtf_pck.get_negrito(false) || chr(13) || chr(10) || '	';
					
					if (ds_aux_w IS NOT NULL AND ds_aux_w::text <> '') then
					 ds_evolucao_w := ds_evolucao_w || ds_aux_w || chr(13) || chr(10);
					end if;
					
					if (ds_observacao_w IS NOT NULL AND ds_observacao_w::text <> '') then
					 ds_evolucao_w := ds_evolucao_w || ds_observacao_w || chr(13) || chr(10);
					end if;
				end if;
				
				if (coalesce(ds_parametro_w, 'N') = 'C') then
					ds_evolucao_w := ds_evolucao_w || ds_tipo_item_w || chr(13) || chr(10) || '	';
					
					if (ds_aux_w IS NOT NULL AND ds_aux_w::text <> '') then
						ds_evolucao_w := ds_evolucao_w || ds_aux_w || chr(13) || chr(10);
					end if;
					
					if (ds_observacao_w IS NOT NULL AND ds_observacao_w::text <> '') then
						ds_evolucao_w := ds_evolucao_w || ds_observacao_w || chr(13) || chr(10);
					end if;	
				end if;
				
				if (coalesce(ds_parametro_w, 'N') = 'R') then

					ds_evolucao_w := ds_evolucao_w || ds_aux_w;
					
				end if;
				
				if (coalesce(ds_parametro_w, 'N') = 'O') then

					ds_evolucao_w := ds_evolucao_w || ds_aux_w;
					
					if (ds_observacao_w IS NOT NULL AND ds_observacao_w::text <> '') then
						ds_evolucao_w := ds_evolucao_w || ds_observacao_w || chr(13) || chr(10);
					end if;	
					
				end if;
				
				if (coalesce(ds_parametro_w, 'N') = 'G') then

					ds_evolucao_w := ds_evolucao_w || ds_aux_w;
					
					if (ds_observacao_w IS NOT NULL AND ds_observacao_w::text <> '') then
						ds_evolucao_w := ds_evolucao_w || ds_observacao_w || chr(13) || chr(10);
					end if;	
					
				end if;
				
		end loop;					
		close c01;
	
	end if;
	
	if (ie_gera_diagnostico_w = 'S') then
		open c02;
		loop
		fetch c02 into	
			ds_diagnostico_w,
			ds_evolucao_diag_w,
			nr_seq_diag_w;
		EXIT WHEN NOT FOUND; /* apply on c02 */
		begin
			if (ds_diagnosticos_w IS NOT NULL AND ds_diagnosticos_w::text <> '') then		
				ds_diagnosticos_w := ds_diagnosticos_w || ', ' || ds_diagnostico_w;
			else
				ds_diagnosticos_w := ds_diagnostico_w;
			end if;
			
			if (ds_evolucao_diag_w IS NOT NULL AND ds_evolucao_diag_w::text <> '') then
				ds_diagnosticos_w := ds_diagnosticos_w || ' - ' || ds_evolucao_diag_w;
			end if;
		end;
		end loop;
		close c02;
		ds_diagnosticos_w := ' \b ' || wheb_mensagem_pck.get_texto(340955) || ' : \b0' || ds_diagnosticos_w;
		ds_evolucao_w	  := ds_evolucao_w || ds_diagnosticos_w || chr(13) || chr(10);
		
	elsif (ie_gera_diagnostico_w = 'A') then
		open C02;
		loop
		fetch C02 into	
			ds_diagnostico_w,
			ds_evolucao_diag_w,
			nr_seq_diag_w;
		EXIT WHEN NOT FOUND; /* apply on C02 */
		begin
			if (ds_diagnostico_w IS NOT NULL AND ds_diagnostico_w::text <> '') then				
				ds_diagnosticos_w := ds_diagnosticos_w || chr(13) || chr(10) || '       ' || wheb_rtf_pck.get_negrito(true)  || ds_diagnostico_w || wheb_rtf_pck.get_negrito(false);

				if (ds_evolucao_diag_w IS NOT NULL AND ds_evolucao_diag_w::text <> '') then
					ds_diagnosticos_w := ds_diagnosticos_w || chr(13) || chr(10) || ' - ' || ds_evolucao_diag_w;
				end if;	
				
				if (nr_seq_diag_w > 0) then
					open C04;
					loop
					fetch C04 into	
						ds_fator_w;
					EXIT WHEN NOT FOUND; /* apply on C04 */
					begin
						if (coalesce(ds_relacionado_w::text, '') = '') then
							ds_relacionado_w := '	' || ' \b ' || wheb_mensagem_pck.get_texto(329048) || ' : \b0' || ds_relacionado_w;
						end if;
						
						ds_relacionado_w := ds_relacionado_w || chr(13) || chr(10) || '	' || '	' || ds_fator_w;
					end;
					end loop;
					close C04;
					if (ds_relacionado_w IS NOT NULL AND ds_relacionado_w::text <> '') then
						ds_diagnosticos_w := ds_diagnosticos_w || chr(13) || chr(10) || ds_relacionado_w || chr(13) || chr(10);
					else
						ds_diagnosticos_w := ds_diagnosticos_w || chr(13) || chr(10);
					end if;
					ds_relacionado_w  := '';
					
					select	count(*)
					into STRICT	qt_evid_w
					from	pe_item_examinar c,
						pe_item_resultado b,
						pe_result_item_diag a,
						pe_diagnostico d,
						pe_prescr_item_result e
					where	a.nr_seq_diag = nr_seq_diag_w
					and	a.nr_seq_result = b.nr_sequencia
					and	a.nr_seq_diag = d.nr_sequencia
					and	d.ie_caract_def <> 'N'
					and	b.nr_seq_item = c.nr_sequencia
					and	b.nr_sequencia = e.nr_seq_result
					and	e.nr_seq_prescr = nr_sequencia_p
					order by 1;					
					
					if (qt_evid_w > 0) then
						open C05;
						loop
						fetch C05 into	
							ds_fator_w,
							ds_observacao_evidencia_w;
						EXIT WHEN NOT FOUND; /* apply on C05 */
						begin
							if (coalesce(ds_evidenciado_w::text, '') = '') then
								ds_evidenciado_w := '	' || ' \b ' || wheb_mensagem_pck.get_texto(329047) || ' : \b0' || ds_evidenciado_w;
							end if;
							ds_evidenciado_w := ds_evidenciado_w || chr(13) || chr(10) || '	' || '	' || ds_fator_w;
							if (ds_observacao_evidencia_w IS NOT NULL AND ds_observacao_evidencia_w::text <> '') then
								ds_evidenciado_w := ds_evidenciado_w || ' - ' || wheb_mensagem_pck.get_texto(307186) || '.: ' || ds_observacao_evidencia_w;
							end if;
						end;
						end loop;
						close C05;
						
						if (ds_evidenciado_w IS NOT NULL AND ds_evidenciado_w::text <> '') then
							ds_diagnosticos_w := ds_diagnosticos_w || chr(13) || chr(10) || ds_evidenciado_w ||chr(13) || chr(10);
						else
							ds_diagnosticos_w := ds_diagnosticos_w || chr(13) || chr(10);
						end if;
						ds_evidenciado_w  := '';					
					end if;
				end if;
			end if;		

		end;
		end loop;
		close C02;
		ds_diagnosticos_w := chr(13) || chr(10) || ' \b ' || wheb_mensagem_pck.get_texto(340955) || ' : \b0' || ds_diagnosticos_w;
		ds_evolucao_w	  := ds_evolucao_w || ds_diagnosticos_w || chr(13) || chr(10);		
		
	end if;

	if (ie_gera_intervencao_w = 'S') then
		open c03;
		loop
		fetch c03 into	
			ds_intervencao_w;
		EXIT WHEN NOT FOUND; /* apply on c03 */
		begin
			if (ds_intervencoes_w IS NOT NULL AND ds_intervencoes_w::text <> '') then
				ds_intervencoes_w := ds_intervencoes_w || ', \par ' || ds_intervencao_w;
			else
				ds_intervencoes_w := ds_intervencao_w;
			end if;
		end;
		end loop;
		close c03;
		ds_intervencoes_w := ' \b ' || wheb_mensagem_pck.get_texto(340957) || ' : \b0' || ds_intervencoes_w;
		ds_evolucao_w	  := ds_evolucao_w || ds_intervencoes_w || chr(13) || chr(10);
	end if;

select max(a.nr_sequencia)
into STRICT nr_sequencia_sv_w
from atendimento_sinal_vital a
where a.nr_atendimento = nr_atendimento_w
order by a.dt_atualizacao desc;

	if (ie_gera_sinais_vitais_w = 'S' and (nr_atendimento_w IS NOT NULL AND nr_atendimento_w::text <> '') and (nr_sequencia_sv_w IS NOT NULL AND nr_sequencia_sv_w::text <> '')) then
		select
			obter_descricao_dominio(1303,IE_PRESSAO),
			obter_descricao_dominio(1304,IE_MEMBRO),
			obter_descricao_dominio(1305,IE_MANGUITO),
			obter_descricao_dominio(1306,IE_APARELHO_PA),
			obter_unidade_medida_sv(1,QT_PA_SISTOLICA,IE_UM_PA_SIST),
			obter_unidade_medida_sv(1,qt_pa_diastolica,IE_UM_PA_DIAST),
			obter_unidade_medida_sv(8,QT_PAM,IE_UM_PAM),
			a.ds_observacao,
			obter_unidade_medida_sv(4,qt_temp,ie_um_temp),
			obter_unidade_medida_sv(9,qt_freq_cardiaca,ie_um_fc),
			obter_unidade_medida_sv(9,qt_freq_resp,ie_um_fr),
			obter_descricao_dominio(1558,IE_SITIO),
			obter_unidade_medida_sv(12,QT_PESO_ATUAL,IE_UNID_MED_PESO),
			obter_unidade_medida_sv(13,qt_altura_cm,IE_UNID_MED_ALTURA),
			obter_unidade_medida_sv(14,qt_imc,IE_UM_IMC),
			obter_unidade_medida_sv(15,QT_SUPERF_CORPORIA,IE_UM_SC),
			substr(QT_SATURACAO_O2,1,255),
			obter_unidade_medida_sv(15,QT_GLICEMIA_CAPILAR,IE_UM_GC),
			obter_unidade_medida_sv(15,QT_PERIMITRO_ABDOMINAL,IE_UM_PA),
			obter_unidade_medida_sv(15,QT_PERIMETRO_CEFALICO,IE_UM_PC),
			QT_ESCALA_DOR,
			obter_desc_escala_dor(CD_ESCALA_DOR)
		into STRICT	
			ie_pressao_w,
			ie_membro_w,
			ie_manguito_w,
			ie_aparelho_pa_w,
			qt_pa_max_w,
			qt_pa_min_w,
			qt_pam_w,
			ds_obs_w,
			qt_temp_w,
			qt_freq_cardiaca_w,
			qt_freq_resp_w,
			ie_sitio_w,
			qt_peso_w,
			qt_altura_w,
			qt_imc_w,
			qt_superf_corporia_w,
			qt_saturacao_o2_w,
			qt_glicemia_capilar_w,
			qt_perimetro_abdominal_w,
			qt_perimetro_cefalico_w,
			qt_escala_w,
			ds_escala_dor_w
		from	atendimento_sinal_vital a
		where	a.nr_sequencia = nr_sequencia_sv_w;
		
		ds_sinais_vitais_w := ' \b ' || wheb_mensagem_pck.get_texto(303814) || ': \b0' 		|| ds_sinais_vitais_w 	|| chr(13) || chr(10);
	
	if (ie_pressao_w IS NOT NULL AND ie_pressao_w::text <> '') then
			ds_sinais_vitais_w := ds_sinais_vitais_w || obter_desc_expressao_idioma(296103, null, wheb_usuario_pck.get_nr_seq_idioma) || ': ' || ie_pressao_w 		|| chr(13) || chr(10);
		else
			ds_sinais_vitais_w := ds_sinais_vitais_w;
	end if;
		
	if (ie_membro_w IS NOT NULL AND ie_membro_w::text <> '') then
			ds_sinais_vitais_w := ds_sinais_vitais_w || obter_desc_expressao_idioma(293184, null, wheb_usuario_pck.get_nr_seq_idioma) || ': ' || ie_membro_w 		|| chr(13) || chr(10);
		else
			ds_sinais_vitais_w := ds_sinais_vitais_w;
	end if;
		
	if (ie_manguito_w IS NOT NULL AND ie_manguito_w::text <> '') then
			ds_sinais_vitais_w := ds_sinais_vitais_w || obter_desc_expressao_idioma(292850, null, wheb_usuario_pck.get_nr_seq_idioma) || ': ' || ie_manguito_w 		|| chr(13) || chr(10);
		else
			ds_sinais_vitais_w := ds_sinais_vitais_w;
	end if;
	
	if (ie_aparelho_pa_w IS NOT NULL AND ie_aparelho_pa_w::text <> '') then
			ds_sinais_vitais_w := ds_sinais_vitais_w || obter_desc_expressao_idioma(283583, null, wheb_usuario_pck.get_nr_seq_idioma) || ': ' || ie_aparelho_pa_w 		|| chr(13) || chr(10);
		else
			ds_sinais_vitais_w := ds_sinais_vitais_w;
	end if;
	
	if (qt_pa_max_w IS NOT NULL AND qt_pa_max_w::text <> '') then
			ds_sinais_vitais_w := ds_sinais_vitais_w || UPPER(wheb_mensagem_pck.get_texto(275630)) || ': '  || qt_pa_max_w 			|| chr(13) || chr(10);
		else
			ds_sinais_vitais_w := ds_sinais_vitais_w;
	end if;
	
	if (qt_pa_min_w IS NOT NULL AND qt_pa_min_w::text <> '') then
			ds_sinais_vitais_w := ds_sinais_vitais_w || UPPER(wheb_mensagem_pck.get_texto(340968)) || ': '  || qt_pa_min_w 			|| chr(13) || chr(10);
		else
			ds_sinais_vitais_w := ds_sinais_vitais_w;
	end if;
	
	if (qt_pam_w IS NOT NULL AND qt_pam_w::text <> '') then
			ds_sinais_vitais_w := ds_sinais_vitais_w || wheb_mensagem_pck.get_texto(275655) || ': ' 	|| qt_pam_w 			|| chr(13) || chr(10);
		else
			ds_sinais_vitais_w := ds_sinais_vitais_w;
	end if;
	
	if (ds_obs_w IS NOT NULL AND ds_obs_w::text <> '') then
			ds_sinais_vitais_w := ds_sinais_vitais_w || wheb_mensagem_pck.get_texto(307186) || '.: ' || ds_obs_w 			|| chr(13) || chr(10);
		else
			ds_sinais_vitais_w := ds_sinais_vitais_w;
	end if;
	
	if (qt_temp_w IS NOT NULL AND qt_temp_w::text <> '') then
			ds_sinais_vitais_w := ds_sinais_vitais_w || obter_desc_expressao_idioma(299180, null, wheb_usuario_pck.get_nr_seq_idioma) || ': '	|| qt_temp_w 			|| chr(13) || chr(10);
		else
			ds_sinais_vitais_w := ds_sinais_vitais_w;
	end if;	
	
	if (qt_freq_cardiaca_w IS NOT NULL AND qt_freq_cardiaca_w::text <> '') then
			ds_sinais_vitais_w := ds_sinais_vitais_w || obter_desc_expressao_idioma(311848, null, wheb_usuario_pck.get_nr_seq_idioma) || ': ' || qt_freq_cardiaca_w 	|| chr(13) || chr(10);
		else
			ds_sinais_vitais_w := ds_sinais_vitais_w;
	end if;		
	
	if (qt_freq_resp_w IS NOT NULL AND qt_freq_resp_w::text <> '') then
			ds_sinais_vitais_w := ds_sinais_vitais_w || obter_desc_expressao_idioma(558642, null, wheb_usuario_pck.get_nr_seq_idioma) || ': ' || qt_freq_resp_w 		|| chr(13) || chr(10);
		else
			ds_sinais_vitais_w := ds_sinais_vitais_w;
	end if;	
	
	if (ie_sitio_w IS NOT NULL AND ie_sitio_w::text <> '') then
			ds_sinais_vitais_w := ds_sinais_vitais_w || obter_desc_expressao_idioma(298560, null, wheb_usuario_pck.get_nr_seq_idioma) || ': ' || ie_sitio_w 		|| chr(13) || chr(10);
		else
			ds_sinais_vitais_w := ds_sinais_vitais_w;
	end if;
	
	if (qt_peso_w IS NOT NULL AND qt_peso_w::text <> '') then
			ds_sinais_vitais_w := ds_sinais_vitais_w || obter_desc_expressao_idioma(295698, null, wheb_usuario_pck.get_nr_seq_idioma) || ': ' || qt_peso_w 		|| chr(13) || chr(10);
		else
			ds_sinais_vitais_w := ds_sinais_vitais_w;
	end if;
	
	if (qt_altura_w IS NOT NULL AND qt_altura_w::text <> '') then
			ds_sinais_vitais_w := ds_sinais_vitais_w || obter_desc_expressao_idioma(283402, null, wheb_usuario_pck.get_nr_seq_idioma) || ': ' || qt_altura_w 		|| chr(13) || chr(10);
		else
			ds_sinais_vitais_w := ds_sinais_vitais_w;
	end if;
	
	if (qt_imc_w IS NOT NULL AND qt_imc_w::text <> '') then
			ds_sinais_vitais_w := ds_sinais_vitais_w || obter_desc_expressao_idioma(291697, null, wheb_usuario_pck.get_nr_seq_idioma) || ': ' || qt_imc_w 		|| chr(13) || chr(10);
		else
			ds_sinais_vitais_w := ds_sinais_vitais_w;
	end if;
	
	if (qt_superf_corporia_w IS NOT NULL AND qt_superf_corporia_w::text <> '') then
			ds_sinais_vitais_w := ds_sinais_vitais_w || obter_desc_expressao_idioma(971051, null, wheb_usuario_pck.get_nr_seq_idioma) || ': ' || qt_superf_corporia_w 		|| chr(13) || chr(10);
		else
			ds_sinais_vitais_w := ds_sinais_vitais_w;
	end if;
	
	if (qt_saturacao_o2_w IS NOT NULL AND qt_saturacao_o2_w::text <> '') then
			ds_sinais_vitais_w := ds_sinais_vitais_w || obter_desc_expressao_idioma(298050, null, wheb_usuario_pck.get_nr_seq_idioma) || ': ' || qt_saturacao_o2_w 		|| chr(13) || chr(10);
		else
			ds_sinais_vitais_w := ds_sinais_vitais_w;
	end if;
	
	if (qt_glicemia_capilar_w IS NOT NULL AND qt_glicemia_capilar_w::text <> '') then
			ds_sinais_vitais_w := ds_sinais_vitais_w || obter_desc_expressao_idioma(290914, null, wheb_usuario_pck.get_nr_seq_idioma) || ': ' || qt_glicemia_capilar_w 		|| chr(13) || chr(10);
		else
			ds_sinais_vitais_w := ds_sinais_vitais_w;
	end if;
	
	if (qt_perimetro_abdominal_w IS NOT NULL AND qt_perimetro_abdominal_w::text <> '') then
			ds_sinais_vitais_w := ds_sinais_vitais_w || obter_desc_expressao_idioma(1066952, null, wheb_usuario_pck.get_nr_seq_idioma) || ': ' || qt_perimetro_abdominal_w 		|| chr(13) || chr(10);
		else
			ds_sinais_vitais_w := ds_sinais_vitais_w;
	end if;
	
	if (qt_perimetro_cefalico_w IS NOT NULL AND qt_perimetro_cefalico_w::text <> '') then
			ds_sinais_vitais_w := ds_sinais_vitais_w || obter_desc_expressao_idioma(295495, null, wheb_usuario_pck.get_nr_seq_idioma) || ': ' || qt_perimetro_cefalico_w 		|| chr(13) || chr(10);
		else
			ds_sinais_vitais_w := ds_sinais_vitais_w;
	end if;
	
	
	if (ds_escala_dor_w IS NOT NULL AND ds_escala_dor_w::text <> '') then	
		if (qt_escala_w IS NOT NULL AND qt_escala_w::text <> '') then
				ds_sinais_vitais_w := ds_sinais_vitais_w || obter_desc_expressao_idioma(289379, null, wheb_usuario_pck.get_nr_seq_idioma) || ': ' || ds_escala_dor_w||' '||obter_desc_expressao_idioma(301251, null, wheb_usuario_pck.get_nr_seq_idioma) || ': '||qt_escala_w 		|| chr(13) || chr(10);
			else
				ds_sinais_vitais_w := ds_sinais_vitais_w || obter_desc_expressao_idioma(289379, null, wheb_usuario_pck.get_nr_seq_idioma) || ': ' || ds_escala_dor_w|| chr(13) || chr(10);
		end if;
	else
			ds_sinais_vitais_w := ds_sinais_vitais_w;	
	end if;	
		
		ds_evolucao_w	   := ds_evolucao_w || ds_sinais_vitais_w || chr(13) || chr(10);
	end if;	


	if (ie_gera_alergias_w = 'S') then		
		open c06;
		loop
		fetch c06 into	
			DS_MEDIC_GRID_W,
			DS_NEGA_ALERGIAS_W,
			DS_TIPO_W,
			DS_REACAO_W,
			DS_CONFIRMACAO_W,
			DS_INTENSIDADE_W,
			DS_ABORDAGEM_W,
			DS_OBSERVACAO_GRID_W,
			NM_PROFISSIONAL_W,
			DS_SETOR_ATENDIMENTO_W;
		EXIT WHEN NOT FOUND; /* apply on c06 */
	begin
	if (DS_MEDIC_GRID_W IS NOT NULL AND DS_MEDIC_GRID_W::text <> '') then
			ds_alergias_w := ds_alergias_w || obter_desc_expressao_idioma(283343, null, wheb_usuario_pck.get_nr_seq_idioma) || ': ' || DS_MEDIC_GRID_W 		|| chr(13) || chr(10);
	end if;

	if (DS_NEGA_ALERGIAS_W IS NOT NULL AND DS_NEGA_ALERGIAS_W::text <> '') then
			ds_alergias_w := ds_alergias_w || obter_desc_expressao_idioma(294051, null, wheb_usuario_pck.get_nr_seq_idioma) || ': ' || DS_NEGA_ALERGIAS_W 		|| chr(13) || chr(10);
	end if;

	if (DS_TIPO_W IS NOT NULL AND DS_TIPO_W::text <> '') then
			ds_alergias_w := ds_alergias_w || obter_desc_expressao_idioma(283253, null, wheb_usuario_pck.get_nr_seq_idioma) || ': ' || DS_TIPO_W 		|| chr(13) || chr(10);
	end if;

	if (DS_REACAO_W IS NOT NULL AND DS_REACAO_W::text <> '') then
			ds_alergias_w := ds_alergias_w || obter_desc_expressao_idioma(299695, null, wheb_usuario_pck.get_nr_seq_idioma) || ': ' || DS_REACAO_W 		|| chr(13) || chr(10);
	end if;

	if (DS_CONFIRMACAO_W IS NOT NULL AND DS_CONFIRMACAO_W::text <> '') then
			ds_alergias_w := ds_alergias_w || obter_desc_expressao_idioma(285645, null, wheb_usuario_pck.get_nr_seq_idioma) || ': ' || DS_CONFIRMACAO_W 		|| chr(13) || chr(10);
	end if;

	if (DS_INTENSIDADE_W IS NOT NULL AND DS_INTENSIDADE_W::text <> '') then
			ds_alergias_w := ds_alergias_w || obter_desc_expressao_idioma(292143, null, wheb_usuario_pck.get_nr_seq_idioma) || ': ' || DS_INTENSIDADE_W 		|| chr(13) || chr(10);
	end if;

	if (DS_ABORDAGEM_W IS NOT NULL AND DS_ABORDAGEM_W::text <> '') then
			ds_alergias_w := ds_alergias_w || obter_desc_expressao_idioma(283065, null, wheb_usuario_pck.get_nr_seq_idioma) || ': ' || DS_ABORDAGEM_W 		|| chr(13) || chr(10);
	end if;

	if (DS_OBSERVACAO_GRID_W IS NOT NULL AND DS_OBSERVACAO_GRID_W::text <> '') then
			ds_alergias_w := ds_alergias_w || obter_desc_expressao_idioma(294639, null, wheb_usuario_pck.get_nr_seq_idioma) || ': ' || DS_OBSERVACAO_GRID_W 		|| chr(13) || chr(10);
	end if;

	if (NM_PROFISSIONAL_W IS NOT NULL AND NM_PROFISSIONAL_W::text <> '') then
			ds_alergias_w := ds_alergias_w ||obter_desc_expressao_idioma(296509, null, wheb_usuario_pck.get_nr_seq_idioma) || ': ' || NM_PROFISSIONAL_W 		|| chr(13) || chr(10);
	end if;

	if (DS_SETOR_ATENDIMENTO_W IS NOT NULL AND DS_SETOR_ATENDIMENTO_W::text <> '') then
			ds_alergias_w := ds_alergias_w || obter_desc_expressao_idioma(298360, null, wheb_usuario_pck.get_nr_seq_idioma) || ': ' || DS_SETOR_ATENDIMENTO_W 		|| chr(13) || chr(10);
	end if;

	ds_alergias_w := ds_alergias_w || chr(13) || chr(10);

		end;
		end loop;
		close c06;		

	if (ds_alergias_w IS NOT NULL AND ds_alergias_w::text <> '') then
		
		ds_alergias_w := ' \b ' || wheb_mensagem_pck.get_texto(338412) || ': \b0' ||chr(13) || chr(10) || ds_alergias_w || chr(13) || chr(10);
		ds_evolucao_w	  := ds_evolucao_w || ds_alergias_w || chr(13) || chr(10);	
	
	end if;
	
end if;


	select	nextval('evolucao_paciente_seq')
	into STRICT	cd_evolucao_w
	;

	begin
	select	ds_comentario
	into STRICT	ds_comentario_w
	from	pe_prescr_comentario
	where	nr_seq_prescr = nr_sequencia_p;
	exception
	when others then
		ds_comentario_w := null;
	end;

	if (ie_gera_comentario_w = 'S') and (ds_comentario_w IS NOT NULL AND ds_comentario_w::text <> '') then
		begin
		/*inicio substituir os caracteres chr(13) e chr(10) pelo \par que que representa o enter no rtf*/

		qt_controle_chr_w :=0;
			
		while(position(chr(13) in ds_evolucao_w) > 0) and (qt_controle_chr_w < 100) loop
			ds_evolucao_w := replace(ds_evolucao_w, chr(13), '\par ');
			qt_controle_chr_w := qt_controle_chr_w + 1;
		end loop;
		qt_controle_chr_w := 0;

		while(position(chr(10) in ds_evolucao_w) > 0) and (qt_controle_chr_w < 100) loop
			ds_evolucao_w := replace(ds_evolucao_w, chr(10), '');
			qt_controle_chr_w := qt_controle_chr_w + 1;
		end loop;
		/*fim substituir os caracteres chr(13) e chr(10) pelo \par que que representa o enter no rtf*/


		/*pega o cabecalho do rtf*/

		ds_cabecalho_w := '{\rtf1\ansi\deff0{\fonttbl{\f0\fnil\fcharset0 Arial;}{\f1\fnil Arial;}}' ||
					'{\colortbl ;\red0\green0\blue0;}' ||
					'\viewkind4\uc1\pard\cf1\lang1046\fs20  \fs16 \f1 ';
		ds_pos_inicio_rtf_w := position('lang' in ds_cabecalho_w) + 8;
		ds_conteudo_w2 := substr(ds_cabecalho_w, 1, ds_pos_inicio_rtf_w) || 'fs20 ';
		
		/*acrecenta conteudo texto livre*/

		ds_conteudo_w2 := ds_conteudo_w2 || ds_modelo_w || ds_evolucao_w;
		
		/*acrecenta resto do conteudo do rtf*/

		ds_rodape_w    := '}';
		ds_conteudo_w2 := ds_conteudo_w2 || '\par ' || substr(ds_cabecalho_w, ds_pos_inicio_rtf_w, length(ds_cabecalho_w));
		
		if ((position('\fs20' in ds_comentario_w) > 0) and (position('\cell' in ds_comentario_w) > 0)) then
			ds_comentario_w := substr(ds_comentario_w,position('\fs20' in ds_comentario_w)+6);
			ds_comentario_w := substr(ds_comentario_w,1,instr(ds_comentario_w,'}',-1)-1);

			ds_conteudo_w  := ds_conteudo_w2 || '\par ' || obter_desc_expressao(285523) || ': \par ' || ds_comentario_w || ds_rodape_w;
		else
			nr_seq_texto_w := converte_rtf_string('select	ds_comentario from	pe_prescr_comentario where	nr_seq_prescr = :nr_sequencia_p', nr_sequencia_p, nm_usuario_p, nr_seq_texto_w);
			select ds_texto
			into STRICT ds_comentario_w
			from TASY_CONVERSAO_RTF
			where nr_sequencia = nr_seq_texto_w;

			ds_conteudo_w  := ds_conteudo_w2 || '\par ' || Obter_richtext_base_sae(obter_desc_expressao(285523) || ': \par ' || ds_comentario_w,'E', ds_fonte_w, dividir(nr_tam_fonte_w, 2)) || ds_rodape_w;
		end if;
		end;
	else
		ds_cabecalho_w := '{\rtf1\ansi\ansicpg1252\deff0\deflang1046{\fonttbl{\f0\fswiss\fcharset0 ' || ds_fonte_w || ';}}' ||
					'{\*\generator Msftedit 5.41.15.1507;}\viewkind4\uc1\pard\f0\fs' || nr_tam_fonte_w || ' ';
		ds_rodape_w    := '}';
		ds_evolucao_w  := replace(ds_evolucao_w, chr(13) || chr(10), ' \par ');
		ds_conteudo_w  := ds_cabecalho_w || ds_modelo_w || ds_evolucao_w || ds_rodape_w;
	end if;

	ie_gera_evolucao_w	:= length(ds_evolucao_w||ds_comentario_w);	
	
	select	coalesce(max(ie_situacao),'A')
	into STRICT	ie_situacao_w
	from	tipo_evolucao
	where	cd_tipo_evolucao = 'SAE';

	if (nr_atendimento_w <= 0) then
		nr_atendimento_w := null;
	end if;
	
	if (dt_sae_w > clock_timestamp()) then
		dt_sae_w := clock_timestamp();
	end if;

	if (ie_situacao_w = 'A') and /* Evitar que gere uma evolucao SAE quando a mesma esta inativa */
		(ie_gera_evolucao_w > 0) then
		insert into evolucao_paciente(
			cd_evolucao,
			dt_evolucao,
			ie_tipo_evolucao,
			cd_pessoa_fisica,
			dt_atualizacao,
			nm_usuario,
			nr_atendimento,
			ds_evolucao,
			cd_medico,
			dt_liberacao,
			ie_evolucao_clinica,
			ie_recem_nato,
			ie_situacao,
			nr_seq_sae,
			NM_USUARIO_NREC)
		values (cd_evolucao_w,
			dt_sae_w,
			ie_tipo_evolucao_w,
			cd_pessoa_fisica_w,
			clock_timestamp(),
			nm_usuario_p,
			nr_atendimento_w,
			ds_conteudo_w,
			cd_prescritor_w,
			dt_liberacao_w,
			'SAE',
			coalesce(ie_rn_w,'N'),
			'A',
			nr_sequencia_p,
			NM_USUARIO_P);
	end if;
end if;

commit;

select 	coalesce(max('S'),'N')
into STRICT	ie_medico_w
from	Medico
where 	cd_pessoa_fisica = cd_prescritor_w;

select 	coalesce(max(ie_regra_libera_evolucao),'M')
into STRICT	ie_regra_libera_evolucao_w
from 	parametro_faturamento
where 	cd_estabelecimento = wheb_usuario_pck.get_cd_estabelecimento;

select 	coalesce(max(ie_gera_lancto_auto),'N')
into STRICT	ie_gera_lancamento_w
from 	tipo_evolucao
where 	cd_tipo_evolucao = 'SAE';

if	((ie_regra_libera_evolucao_w = 'M' AND ie_medico_w = 'S') or
	 (ie_regra_libera_evolucao_w = 'R' AND ie_gera_lancamento_w = 'S')) then	 
	CALL gerar_lancamento_automatico(nr_atendimento_w, null, 123, 
		nm_usuario_p, cd_evolucao_w, cd_prescritor_w, null,null,null,null);
end if;

end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_evolucao_sae (( nr_sequencia_p bigint, nm_usuario_p text) is dt_liberacao_w timestamp) FROM PUBLIC;

