-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE cpoe_check_special_appproval ( nm_table_p text, nr_sequence_p bigint, nm_usuario_p text) AS $body$
DECLARE


ie_proc_special_approv_w	varchar(2);

c01 CURSOR FOR
	SELECT	a.nr_sequencia,
			b.ie_aprov_esp_cpoe
	from	proc_interno b,
			cpoe_procedimento a
	where	a.nr_seq_proc_interno = b.nr_sequencia
	and		a.nr_sequencia	= nr_sequence_p
	and		(b.ie_aprov_esp_cpoe IS NOT NULL AND b.ie_aprov_esp_cpoe::text <> '');
	
BEGIN

if (nm_table_p = 'CPOE_PROCEDIMENTO') then

	for r_c01_w in c01 loop
	
		update 	cpoe_procedimento
		set		si_special_approval = r_c01_w.ie_aprov_esp_cpoe
		where	nr_sequencia = nr_sequence_p;
	
		ie_proc_special_approv_w := cpoe_get_proc_spec_approval(r_c01_w.nr_sequencia, nm_usuario_p);
		if (ie_proc_special_approv_w = 'PA') then
		
			update	prescr_procedimento
			set		ie_status_execucao = 'ASA'
			where	nr_seq_proc_cpoe = nr_sequence_p;
			
		elsif (ie_proc_special_approv_w = 'A') then
		
			update	cpoe_procedimento
			set		dt_special_approval = clock_timestamp(),
					nm_usuario_approval = nm_usuario_p
			where	nr_sequencia = nr_sequence_p;
		
		end if;
		
	end loop;
	
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cpoe_check_special_appproval ( nm_table_p text, nr_sequence_p bigint, nm_usuario_p text) FROM PUBLIC;

