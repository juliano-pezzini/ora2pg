-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_w_itens_oc_contrato_sc ( nr_solic_compra_p bigint, nr_item_solic_compra_p bigint, nm_usuario_p text) AS $body$
DECLARE


	
nr_contrato_w		bigint;
vl_pagto_w		double precision;
ie_estoque_w		varchar(1);	
cd_estabelecimento_w	bigint;	
vl_desconto_w		contrato_regra_nf.vl_desconto%type;
pr_desconto_w		contrato_regra_nf.pr_desconto%type;

c01 CURSOR FOR
SELECT	a.nr_sequencia,
	a.vl_pagto,
	a.vl_desconto,
	a.pr_desconto
from(	select	b.nr_sequencia,
		a.cd_material,
		a.vl_pagto,
		a.vl_desconto,
		a.pr_desconto
	from	contrato_regra_nf a,
		contrato b
	where	a.nr_seq_contrato = b.nr_sequencia
	and	((b.cd_estabelecimento = cd_estabelecimento_w) or
		exists (select	1
			from	contrato_estab_adic c
			where	b.nr_sequencia = c.nr_seq_contrato
			and	c.cd_estab_adic = cd_estabelecimento_w))
	and	substr(obter_dados_pf_pj(null,b.cd_cgc_contratado,'S'),1,1) = 'A'
	and	((coalesce(a.dt_inicio_vigencia::text, '') = '') or (trunc(a.dt_inicio_vigencia,'dd') <= trunc(clock_timestamp(),'dd')))
	and	((coalesce(a.dt_fim_vigencia::text, '') = '') or (trunc(a.dt_fim_vigencia,'dd') >= trunc(clock_timestamp(),'dd')))
    and (coalesce(a.ie_situacao::text, '') = '' or a.ie_situacao = 'A')
	and	coalesce(cd_pessoa_contratada::text, '') = ''
	and	coalesce(b.ie_situacao,'A') = 'A'
	
union

	SELECT	b.nr_sequencia,
		a.cd_material,
		a.vl_pagto,
		a.vl_desconto,
		a.pr_desconto
	from	contrato_regra_nf a,
		contrato b
	where	a.nr_seq_contrato = b.nr_sequencia
	and	((b.cd_estabelecimento = cd_estabelecimento_w) or 
		exists (select	1
			from	contrato_estab_adic c
			where	b.nr_sequencia = c.nr_seq_contrato
			and	c.cd_estab_adic = cd_estabelecimento_w))
	and	substr(obter_dados_pf_pj(null,b.cd_cgc_contratado,'S'),1,1) = 'A'
	and	((coalesce(a.dt_inicio_vigencia::text, '') = '') or (trunc(a.dt_inicio_vigencia,'dd') <= trunc(clock_timestamp(),'dd')))
	and	((coalesce(a.dt_fim_vigencia::text, '') = '') or (trunc(a.dt_fim_vigencia,'dd') >= trunc(clock_timestamp(),'dd')))
    and (coalesce(a.ie_situacao::text, '') = '' or a.ie_situacao = 'A')
	and	(cd_pessoa_contratada IS NOT NULL AND cd_pessoa_contratada::text <> '')
	and	coalesce(b.ie_situacao,'A') = 'A') a,
	solic_compra_item b
where	((ie_estoque_w = 'N' AND a.cd_material = b.cd_material) or
	 ((ie_estoque_w = 'S') and (obter_dados_material(a.cd_material,'EST') = obter_dados_material(b.cd_material,'EST'))))
and	b.nr_item_solic_compra = nr_item_solic_compra_p
and	b.nr_solic_compra = nr_solic_compra_p
and	not exists (	select	1
			from	ordem_compra_item x
			where	x.nr_solic_compra = b.nr_solic_compra
			and	x.nr_item_solic_compra = b.nr_item_solic_compra)
order by	vl_pagto;/*Nao tirar esse order by, pois deve buscar do menor preco .... veja que quando abre o cursor ele acha o primeiro (mais barato) e ja sai do cursor*/
	

BEGIN

select	cd_estabelecimento
into STRICT	cd_estabelecimento_w
from	solic_compra
where	nr_solic_compra = nr_solic_compra_p;

select (max(obter_valor_param_usuario(913, 185, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w)))
into STRICT	ie_estoque_w
;

open C01;
loop
fetch C01 into	
	nr_contrato_w,
	vl_pagto_w,
	vl_desconto_w,
	pr_desconto_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	nr_contrato_w	:= nr_contrato_w;
	vl_pagto_w	:= vl_pagto_w;
	vl_desconto_w	:= vl_desconto_w;
	pr_desconto_w	:= pr_desconto_w;
	exit;
	end;
end loop;
close C01;

if (nr_contrato_w > 0) then			

	insert into w_itens_oc_contrato_sc(
		nr_solic_compra,
		nr_item_solic_compra,
		nr_contrato,
		vl_pagto,
		nm_usuario,
		vl_desconto,
		pr_desconto)
	values (	nr_solic_compra_p,
		nr_item_solic_compra_p,
		nr_contrato_w,
		vl_pagto_w,
		nm_usuario_p,
		vl_desconto_w,
		pr_desconto_w);
end if;
		
commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_w_itens_oc_contrato_sc ( nr_solic_compra_p bigint, nr_item_solic_compra_p bigint, nm_usuario_p text) FROM PUBLIC;

