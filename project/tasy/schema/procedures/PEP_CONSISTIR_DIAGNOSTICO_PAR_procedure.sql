-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pep_consistir_diagnostico_par ( nr_atendimento_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text, qt_existe_diag_p INOUT bigint, qt_sus_aih_unif_p INOUT bigint, cd_ultimo_cid_atend_pac_p INOUT text, ds_pac_nao_diag_p INOUT text, ds_conf_ult_diag_p INOUT text, ds_conf_ult_diag_02_p INOUT text) AS $body$
DECLARE

		 
qt_existe_diag_w		bigint;
cd_ultimo_cid_atend_pac_w	varchar(255);
ds_ultimo_cid_atend_pac_w	varchar(255);
			

BEGIN				 
if (nr_atendimento_p > 0) then 
	begin	 
	select	count(*) 
	into STRICT	qt_existe_diag_w 
	from	diagnostico_doenca 
	where  nr_atendimento = nr_atendimento_p;
	 
	cd_ultimo_cid_atend_pac_w := obter_ultimo_cid_atend_pac(nr_atendimento_p,'P','C');
	ds_ultimo_cid_atend_pac_w := obter_ultimo_cid_atend_pac(nr_atendimento_p,'P','D');
	end;
end if;
 
-- Descrição do texto: "O paciente selecionado não possui diagnóstico informado para este atendimento (Parâmetro 1341)." 
ds_pac_nao_diag_p		:= substr(obter_texto_tasy(317392, wheb_usuario_pck.get_nr_seq_idioma),1,255);
-- Descrição do texto: "O Atendimento selecionado não possui diagnóstico informado. Deseja copiar o último Diagnóstico do paciente para este Atendimento? (Parâmetro 1341)." 
ds_conf_ult_diag_p		:= substr(obter_texto_tasy(317393, wheb_usuario_pck.get_nr_seq_idioma),1,255);
ds_conf_ult_diag_02_p		:= substr('CID: '|| cd_ultimo_cid_atend_pac_w || ' - '|| ds_ultimo_cid_atend_pac_w,1,150);
qt_existe_diag_p		  := qt_existe_diag_w;
 
cd_ultimo_cid_atend_pac_p	:= cd_ultimo_cid_atend_pac_w;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pep_consistir_diagnostico_par ( nr_atendimento_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text, qt_existe_diag_p INOUT bigint, qt_sus_aih_unif_p INOUT bigint, cd_ultimo_cid_atend_pac_p INOUT text, ds_pac_nao_diag_p INOUT text, ds_conf_ult_diag_p INOUT text, ds_conf_ult_diag_02_p INOUT text) FROM PUBLIC;

