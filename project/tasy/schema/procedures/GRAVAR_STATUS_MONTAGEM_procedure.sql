-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gravar_status_montagem ( nr_seq_agenda_p bigint, ie_linha_coluna_p text, ie_coluna_p text, nr_seq_status_p bigint, ie_opcao_p text, nm_usuario_p text, cd_estabelecimento_p bigint) AS $body$
DECLARE


nr_seq_agenda_w			bigint;
ds_alteracao_w			varchar(4000);
ds_status_anterior_w	varchar(100);
ds_status_posterior_w	varchar(100);

/*
ie_opcao_p 			- (G) Geração do status/ (D) Desfazer geração do status
ie_linha_coluna_p	- (L) Linha / (C) Coluna
ie_coluna_p			- (E) Equipamento / (K) Kit / (C) CME / (F) Solicitação médica
*/
BEGIN

if (coalesce(nr_seq_agenda_p,0) > 0) then
	if (ie_linha_coluna_p = 'L') then
		if (coalesce(nr_seq_agenda_p,0) > 0) then
			SELECT 	max(SUBSTR(obter_ds_status_montagem(nr_seq_status),1,255))
			into STRICT   	ds_status_anterior_w
			FROM   	agenda_regra_cor_monta_cc
			WHERE  	nr_seq_agenda 	= nr_seq_agenda_p
			and		ie_linha_coluna = 'L'
			AND    	dt_atualizacao = (SELECT 	MAX(dt_atualizacao)
						  FROM	agenda_regra_cor_monta_cc
						  WHERE	nr_seq_agenda 	= nr_seq_agenda_p
						  and	ie_linha_coluna = 'L');
		end if;
	else
		if (coalesce(nr_seq_agenda_p,0) > 0) then
			SELECT 	max(SUBSTR(obter_ds_status_montagem(nr_seq_status),1,255))
			into STRICT   	ds_status_anterior_w
			FROM   	agenda_regra_cor_monta_cc
			WHERE  	nr_seq_agenda 	= nr_seq_agenda_p
			and		ie_coluna 	= ie_coluna_p
			AND    	dt_atualizacao = (SELECT 	MAX(dt_atualizacao)
						  FROM	agenda_regra_cor_monta_cc
						  WHERE	nr_seq_agenda	= nr_seq_agenda_p
						  and	ie_coluna 		= ie_coluna_p);
		end if;
	end if;

	select  max(SUBSTR(obter_ds_status_montagem(nr_seq_status_p),1,255))
	into STRICT	ds_status_posterior_w
	;

end if;

if (ie_opcao_p = 'G') then
	if (ie_linha_coluna_p = 'L') then --------------------------> STATUS DA LINHA
		if (coalesce(ds_status_anterior_w::text, '') = '') and (ds_status_posterior_w IS NOT NULL AND ds_status_posterior_w::text <> '') then
			ds_alteracao_w	:= substr(wheb_mensagem_pck.get_texto(300741, 'DS_STATUS_W=' || ds_status_posterior_w), 1, 4000);
				if (ds_alteracao_w IS NOT NULL AND ds_alteracao_w::text <> '') then
					CALL gravar_historico_montagem(nr_seq_agenda_p,'ISL',ds_alteracao_w,nm_usuario_p);
				end if;
		elsif    coalesce(ds_status_anterior_w,'XPTO') <> coalesce(ds_status_posterior_w,'XPTO') then
			     ds_alteracao_w	:= substr(wheb_mensagem_pck.get_texto(300742, 'DS_STATUS_W=' || ds_status_anterior_w || ';DS_STT_POSTERIOR_W=' || ds_status_posterior_w), 1, 4000);
				if (ds_alteracao_w IS NOT NULL AND ds_alteracao_w::text <> '') then
					CALL gravar_historico_montagem(nr_seq_agenda_p,'AIL',ds_alteracao_w,nm_usuario_p);
				end if;
		end if;
	else  -------------------------- > STATUS DA COLUNA
		if (coalesce(ds_status_anterior_w::text, '') = '') and (ds_status_posterior_w IS NOT NULL AND ds_status_posterior_w::text <> '') then
			if (ie_coluna_p = 'E') then --- Equipamento
				ds_alteracao_w	:= substr(wheb_mensagem_pck.get_texto(300743, 'DS_STATUS_POSTERIOR_W=' || ds_status_posterior_w), 1, 4000);

				if (ds_alteracao_w IS NOT NULL AND ds_alteracao_w::text <> '') then
					CALL gravar_historico_montagem(nr_seq_agenda_p,'ISC',ds_alteracao_w,nm_usuario_p);
				end if;
			elsif (ie_coluna_p = 'C') then -- CME
				ds_alteracao_w	:= substr(wheb_mensagem_pck.get_texto(300745, 'DS_STATUS_POSTERIOR_W=' || ds_status_posterior_w), 1, 4000);

				if (ds_alteracao_w IS NOT NULL AND ds_alteracao_w::text <> '') then
					CALL gravar_historico_montagem(nr_seq_agenda_p,'ISC',ds_alteracao_w,nm_usuario_p);
				end if;
			elsif (ie_coluna_p = 'K') then -- Coluna Kit
				ds_alteracao_w	:= substr(wheb_mensagem_pck.get_texto(300746, 'DS_STATUS_POSTERIOR_W=' || ds_status_posterior_w), 1, 4000);

				if (ds_alteracao_w IS NOT NULL AND ds_alteracao_w::text <> '') then
					CALL gravar_historico_montagem(nr_seq_agenda_p,'ISC',ds_alteracao_w,nm_usuario_p);
				end if;
			elsif (ie_coluna_p = 'F') then -- Coluna Fax
				ds_alteracao_w	:= substr(wheb_mensagem_pck.get_texto(300747, 'DS_STATUS_POSTERIOR_W=' || ds_status_posterior_w), 1, 4000);

				if (ds_alteracao_w IS NOT NULL AND ds_alteracao_w::text <> '') then
					CALL gravar_historico_montagem(nr_seq_agenda_p,'ISC',ds_alteracao_w,nm_usuario_p);
				end if;
			end if;
		elsif	coalesce(ds_status_anterior_w,'XPTO') <> coalesce(ds_status_posterior_w,'XPTO') then
			if (ie_coluna_p = 'E') then -- coluna Equipamento
				ds_alteracao_w	:= substr(wheb_mensagem_pck.get_texto(300748, 'DS_STATUS_ANTERIOR_W=' || ds_status_anterior_w ||
										';DS_STATUS_POSTERIOR_W=' || ds_status_posterior_w), 1, 4000);
				if (ds_alteracao_w IS NOT NULL AND ds_alteracao_w::text <> '') then
					CALL gravar_historico_montagem(nr_seq_agenda_p,'ASC',ds_alteracao_w,nm_usuario_p);
				end if;
			elsif (ie_coluna_p = 'C') then -- Coluna CME
				ds_alteracao_w	:= substr(wheb_mensagem_pck.get_texto(300751, 'DS_STATUS_ANTERIOR_W=' || ds_status_anterior_w ||
										';DS_STATUS_POSTERIOR_W=' || ds_status_posterior_w), 1, 4000);

				if (ds_alteracao_w IS NOT NULL AND ds_alteracao_w::text <> '') then
					CALL gravar_historico_montagem(nr_seq_agenda_p,'ASC',ds_alteracao_w,nm_usuario_p);
				end if;
			elsif (ie_coluna_p = 'K') then -- Coluna KIT
				ds_alteracao_w	:= substr(wheb_mensagem_pck.get_texto(300752, 'DS_STATUS_ANTERIOR_W=' || ds_status_anterior_w ||
										';DS_STATUS_POSTERIOR_W=' || ds_status_posterior_w), 1, 4000);

				if (ds_alteracao_w IS NOT NULL AND ds_alteracao_w::text <> '') then
					CALL gravar_historico_montagem(nr_seq_agenda_p,'ASC',ds_alteracao_w,nm_usuario_p);
				end if;
			elsif (ie_coluna_p = 'F') then -- Coluna FAX
				ds_alteracao_w	:= substr(wheb_mensagem_pck.get_texto(300753, 'DS_STATUS_ANTERIOR_W=' || ds_status_anterior_w ||
										';DS_STATUS_POSTERIOR_W=' || ds_status_posterior_w), 1, 4000);

				if (ds_alteracao_w IS NOT NULL AND ds_alteracao_w::text <> '') then
					CALL gravar_historico_montagem(nr_seq_agenda_p,'ASC',ds_alteracao_w,nm_usuario_p);
				end if;
			end if;
		end if;
	end if;
end if;

if (ie_opcao_p = 'D') then
	if (ie_linha_coluna_p = 'L') then
		delete from agenda_regra_cor_monta_cc where nr_seq_agenda = nr_seq_agenda_p and ie_linha_coluna = 'L';

		if (ds_status_anterior_w IS NOT NULL AND ds_status_anterior_w::text <> '') then --- somente irá gravar histórico de desfazer linha se possuir um status
			ds_alteracao_w	:= substr(wheb_mensagem_pck.get_texto(300754), 1, 4000);

			if (ds_alteracao_w IS NOT NULL AND ds_alteracao_w::text <> '') then
				CALL gravar_historico_montagem(nr_seq_agenda_p,'DSL',ds_alteracao_w,nm_usuario_p);
			end if;
		end if;
	else
		delete from agenda_regra_cor_monta_cc where nr_seq_agenda = nr_seq_agenda_p and ie_coluna = ie_coluna_p;

		if (ds_status_anterior_w IS NOT NULL AND ds_status_anterior_w::text <> '') then --- somente irá gravar histórico de desfazer coluna se possuir um status
			if (ie_coluna_p = 'E') then --- coluna Equipamento
				ds_alteracao_w	:= substr(wheb_mensagem_pck.get_texto(300755), 1, 4000);

				if (ds_alteracao_w IS NOT NULL AND ds_alteracao_w::text <> '') then
					CALL gravar_historico_montagem(nr_seq_agenda_p,'DSC',ds_alteracao_w,nm_usuario_p);
				end if;
			elsif (ie_coluna_p = 'C') then --- coluna CME
				ds_alteracao_w	:= substr(wheb_mensagem_pck.get_texto(300756), 1, 4000);

				if (ds_alteracao_w IS NOT NULL AND ds_alteracao_w::text <> '') then
					CALL gravar_historico_montagem(nr_seq_agenda_p,'DSC',ds_alteracao_w,nm_usuario_p);
				end if;
			elsif (ie_coluna_p = 'K') then --- coluna KIT
				ds_alteracao_w	:= substr(wheb_mensagem_pck.get_texto(300757), 1, 4000);

				if (ds_alteracao_w IS NOT NULL AND ds_alteracao_w::text <> '') then
					CALL gravar_historico_montagem(nr_seq_agenda_p,'DSC',ds_alteracao_w,nm_usuario_p);
				end if;
			elsif (ie_coluna_p = 'F') then --- coluna FAX
				ds_alteracao_w	:= substr(wheb_mensagem_pck.get_texto(300758), 1, 4000);

				if (ds_alteracao_w IS NOT NULL AND ds_alteracao_w::text <> '') then
					CALL gravar_historico_montagem(nr_seq_agenda_p,'DSC',ds_alteracao_w,nm_usuario_p);
				end if;
			end if;
		end if;
	end if;
else
	insert	into agenda_regra_cor_monta_cc(
			nr_sequencia,
			dt_atualizacao,
			nm_usuario,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			nr_seq_agenda,
			ie_linha_coluna,
			ie_coluna,
			nr_seq_status)
	values (	nextval('agenda_regra_cor_monta_cc_seq'),
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			nr_seq_agenda_p,
			ie_linha_coluna_p,
			ie_coluna_p,
			nr_seq_status_p);
end if;
commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gravar_status_montagem ( nr_seq_agenda_p bigint, ie_linha_coluna_p text, ie_coluna_p text, nr_seq_status_p bigint, ie_opcao_p text, nm_usuario_p text, cd_estabelecimento_p bigint) FROM PUBLIC;

