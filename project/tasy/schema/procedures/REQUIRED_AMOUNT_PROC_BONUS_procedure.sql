-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE required_amount_proc_bonus ( nr_atendimento_p ATENDIMENTO_PACIENTE.NR_ATENDIMENTO%type, cd_convenio_p REGRA_CONVENIO_PLANO.CD_CONVENIO%type, cd_procedimento_p REGRA_CONVENIO_PLANO.CD_PROCEDIMENTO%type default 0, ie_origem_proced_p REGRA_CONVENIO_PLANO.IE_ORIGEM_PROCED%type default 0, dt_procedimento_p PROCEDIMENTO_AUTORIZADO.DT_APROVACAO%type DEFAULT NULL, qt_procedimento_p PROCEDIMENTO_PACIENTE.QT_PROCEDIMENTO%type DEFAULT NULL, nr_seq_regra_p INOUT REGRA_CONVENIO_PLANO.NR_SEQUENCIA%type DEFAULT NULL, qt_bonus_p INOUT REGRA_CONVENIO_PLANO.QT_BONUS%type  DEFAULT NULL) AS $body$
DECLARE


ie_tipo_atendimento_w 		ATENDIMENTO_PACIENTE.IE_TIPO_ATENDIMENTO%type;
ie_clinica_w 			ATENDIMENTO_PACIENTE.IE_CLINICA%type;
cd_doenca_atend_w		DIAGNOSTICO_DOENCA.CD_DOENCA%type;
nr_seq_classif_atend_w		ATENDIMENTO_PACIENTE.NR_SEQ_CLASSIFICACAO%type;
cd_grupo_w 			PROCEDIMENTO.CD_GRUPO_PROC%type;
cd_especialidade_w 		ESPECIALIDADE_PROC.CD_ESPECIALIDADE%type;
cd_area_w 			ESPECIALIDADE_PROC.CD_AREA_PROCEDIMENTO%type;
cd_perfil_w 			REGRA_CONVENIO_PLANO.CD_PERFIL%type;
nr_seq_cobertura_w		AGENDA_INTEGRADA.NR_SEQ_COBERTURA%type;
cd_empresa_conv_w 		REGRA_CONVENIO_PLANO.CD_EMPRESA_CONV%type;
cd_setor_paciente_w 		REGRA_CONVENIO_PLANO.CD_SETOR_ATUAL%type;
cd_setor_atendimento_w  	REGRA_CONVENIO_PLANO.CD_SETOR_ATENDIMENTO%type;
cd_plano_w 			REGRA_CONVENIO_PLANO.CD_PLANO%type;
cd_tipo_acomodacao_w 		REGRA_CONVENIO_PLANO.CD_TIPO_ACOMODACAO%type;
qt_required_w			BONUS_QUANTITY_RULE.QT_REQUIRED_BONUS%type;

dt_initial_term_s 		REGRA_CONVENIO_PLANO_MAT.DT_INICIO_VIGENCIA%type := TO_DATE('01/01/1900 00:00:00', 'DD/MM/YYYY HH24:MI:SS');
dt_final_term_s 		REGRA_CONVENIO_PLANO_MAT.DT_FIM_VIGENCIA%type 	 := TO_DATE('31/12/2099 00:00:00', 'DD/MM/YYYY HH24:MI:SS');
dt_current_s			REGRA_CONVENIO_PLANO_MAT.DT_ATUALIZACAO%type 	 := clock_timestamp();
nr_seq_grupo_s 			SUS_GRUPO.NR_SEQUENCIA%type;
nr_seq_subgrupo_s		SUS_SUBGRUPO.NR_SEQUENCIA%type;
nr_seq_forma_organizacao_s	SUS_FORMA_ORGANIZACAO.NR_SEQUENCIA%type;


BEGIN
	IF (coalesce(nr_seq_regra_p::text, '') = '') THEN
		SELECT 	coalesce(SUBSTR((SELECT SUS_OBTER_SEQ_ESTRUT_PROC(a.CD_GRUPO, 'G') ), 1, 10), -1),
			coalesce(SUBSTR((SELECT SUS_OBTER_SEQ_ESTRUT_PROC(a.CD_SUBGRUPO, 'S') ), 1, 10), -1)
		INTO STRICT 	nr_seq_grupo_s,
			nr_seq_subgrupo_s
		FROM 	(
			SELECT (SELECT SUS_OBTER_ESTRUT_PROC(cd_procedimento_p, ie_origem_proced_p, 'C', 'G') ) CD_GRUPO,
				(SELECT SUS_OBTER_ESTRUT_PROC(cd_procedimento_p, ie_origem_proced_p, 'C', 'S') ) CD_SUBGRUPO
			
		) a;

		SELECT	coalesce(MAX(a.NR_SEQ_COBERTURA), 0)
		INTO STRICT	nr_seq_cobertura_w
		FROM	AGENDA_INTEGRADA a,
			AGENDA_INTEGRADA_ITEM b
		WHERE	a.NR_SEQUENCIA 		= b.NR_SEQ_AGENDA_INT
		AND	b.NR_SEQ_AGENDA_EXAME 	= (SELECT OBTER_AGENDA_ATENDIMENTO(nr_atendimento_p, 'S') )
		AND	b.NR_SEQ_PROC_INTERNO 	= (SELECT OBTER_NR_PROC_INTERNO(cd_procedimento_p, ie_origem_proced_p) );

		SELECT 	MAX(a.IE_TIPO_ATENDIMENTO),
		        coalesce(MAX(a.IE_CLINICA), 0),
		        coalesce(MAX(a.NR_SEQ_CLASSIFICACAO), 0),
		        MAX(a.CD_PERFIL_ATIVO),
		        coalesce(MAX((SELECT OBTER_CID_ATENDIMENTO(a.NR_ATENDIMENTO, 'P') )), 'X'),
		        coalesce(MAX((SELECT OBTER_SETOR_ATENDIMENTO(a.NR_ATENDIMENTO) )), 0),
		        coalesce(MAX((SELECT OBTER_EMPRESA_ATEND(a.NR_ATENDIMENTO, 'A', 'C') )), 0),
		        coalesce(MAX((SELECT OBTER_SETOR_ATUAL_PACIENTE(a.NR_ATENDIMENTO) )), 0),
		        coalesce(MAX((SELECT OBTER_PLANO_CONV_ATEND(a.NR_ATENDIMENTO) )), 0),
		        coalesce(MAX((SELECT OBTER_TIPO_ACOMOD_ATEND(a.NR_ATENDIMENTO, 'C') )), 0)
		INTO STRICT	ie_tipo_atendimento_w,
			ie_clinica_w,
			nr_seq_classif_atend_w,
			cd_perfil_w,
			cd_doenca_atend_w,
			cd_setor_atendimento_w,
			cd_empresa_conv_w,
			cd_setor_paciente_w,
			cd_plano_w,
			cd_tipo_acomodacao_w
		FROM	ATENDIMENTO_PACIENTE a,
			PESSOA_FISICA b
		WHERE 	a.CD_PESSOA_FISICA	= b.CD_PESSOA_FISICA
		AND	a.NR_ATENDIMENTO	= nr_atendimento_p;

		SELECT 	MAX(a.CD_GRUPO_PROC),
			MAX(a.CD_ESPECIALIDADE),
			coalesce(MAX(a.CD_AREA_PROCEDIMENTO), 0)
		INTO STRICT	cd_grupo_w,
			cd_especialidade_w,
			cd_area_w
		FROM 	ESTRUTURA_PROCEDIMENTO_V a
		WHERE 	a.CD_PROCEDIMENTO 	= cd_procedimento_p
		AND 	a.IE_ORIGEM_PROCED 	= ie_origem_proced_p
		AND 	(cd_procedimento_p IS NOT NULL AND cd_procedimento_p::text <> '');

		SELECT 	MAX(a.NR_SEQUENCIA),
			MAX(a.QT_BONUS)
		INTO STRICT 	nr_seq_regra_p,
			qt_bonus_p
		FROM (
			SELECT	a.NR_SEQUENCIA,
				a.QT_BONUS,
				(ROW_NUMBER() OVER (ORDER BY
					a.NR_SEQ_PROC_INTERNO,
				        a.CD_PROCEDIMENTO,
				        a.CD_GRUPO_PROC,
				        a.CD_ESPECIALIDADE_PROC,
				        a.CD_AREA_PROCEDIMENTO,
				        a.CD_CATEGORIA,
				        a.IE_TIPO_ATENDIMENTO
				)) NR_RULE
			FROM 	REGRA_CONVENIO_PLANO a
			WHERE	a.CD_CONVENIO 								= cd_convenio_p
			AND	coalesce(a.CD_PLANO, cd_plano_w) 						= cd_plano_w
			AND	coalesce(a.CD_PROCEDIMENTO, cd_procedimento_p)				= cd_procedimento_p
			AND	coalesce(a.CD_AREA_PROCEDIMENTO, cd_area_w) 					= cd_area_w
			AND	coalesce(a.CD_ESPECIALIDADE_PROC, cd_especialidade_w)			= cd_especialidade_w
			AND	coalesce(a.CD_GRUPO_PROC, cd_grupo_w)					= cd_grupo_w
			AND	coalesce(a.NR_SEQ_SUBGRUPO, nr_seq_subgrupo_s)				= nr_seq_subgrupo_s
			AND	coalesce(a.NR_SEQ_GRUPO, nr_seq_grupo_s) 					= nr_seq_grupo_s
			AND	coalesce(a.IE_TIPO_ATENDIMENTO, ie_tipo_atendimento_w) 			= ie_tipo_atendimento_w
			AND	coalesce(a.CD_TIPO_ACOMODACAO, cd_tipo_acomodacao_w) 			= cd_tipo_acomodacao_w
			AND	coalesce(a.CD_SETOR_ATENDIMENTO, cd_setor_atendimento_w) 			= cd_setor_atendimento_w
			AND	coalesce(a.IE_CLINICA, ie_clinica_w) 					= ie_clinica_w
			AND	coalesce(a.CD_DOENCA, cd_doenca_atend_w) 					= cd_doenca_atend_w
			AND 	coalesce(a.CD_SETOR_ATUAL, cd_setor_paciente_w) 				= cd_setor_paciente_w
			AND	coalesce(a.CD_EMPRESA_CONV, cd_empresa_conv_w)				= cd_empresa_conv_w
			AND	coalesce(a.NR_SEQ_CLASSIF_ATEND, nr_seq_classif_atend_w) 			= nr_seq_classif_atend_w
			AND	coalesce(a.NR_SEQ_COBERTURA, nr_seq_cobertura_w) 				= nr_seq_cobertura_w
			AND	coalesce(a.CD_PERFIL, cd_perfil_w) 						= cd_perfil_w
			AND	coalesce(a.IE_SITUACAO, 'A') 						= 'A'
			AND	coalesce(dt_procedimento_p, dt_current_s) BETWEEN coalesce(a.DT_INICIO_VIGENCIA, dt_initial_term_s) AND coalesce(a.DT_FIM_VIGENCIA, dt_final_term_s)
		) a
		WHERE 	a.NR_RULE = 1;
	ELSE
		SELECT	MAX(a.QT_BONUS)
		INTO STRICT 	qt_bonus_p
		FROM 	REGRA_CONVENIO_PLANO a
		WHERE	a.NR_SEQUENCIA = nr_seq_regra_p;
	END IF;

	SELECT	coalesce(SUM(a.QT_REQUIRED_BONUS), 0)
	INTO STRICT	qt_required_w
	FROM	BONUS_QUANTITY_RULE a
	WHERE	a.NR_SEQ_REGRA_PROC = nr_seq_regra_p
	AND	qt_procedimento_p BETWEEN a.QT_ITEM_FROM AND a.QT_ITEM_TO;

	IF (qt_required_w > 0) THEN
		qt_bonus_p := qt_required_w;
	END IF;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE required_amount_proc_bonus ( nr_atendimento_p ATENDIMENTO_PACIENTE.NR_ATENDIMENTO%type, cd_convenio_p REGRA_CONVENIO_PLANO.CD_CONVENIO%type, cd_procedimento_p REGRA_CONVENIO_PLANO.CD_PROCEDIMENTO%type default 0, ie_origem_proced_p REGRA_CONVENIO_PLANO.IE_ORIGEM_PROCED%type default 0, dt_procedimento_p PROCEDIMENTO_AUTORIZADO.DT_APROVACAO%type DEFAULT NULL, qt_procedimento_p PROCEDIMENTO_PACIENTE.QT_PROCEDIMENTO%type DEFAULT NULL, nr_seq_regra_p INOUT REGRA_CONVENIO_PLANO.NR_SEQUENCIA%type DEFAULT NULL, qt_bonus_p INOUT REGRA_CONVENIO_PLANO.QT_BONUS%type  DEFAULT NULL) FROM PUBLIC;

