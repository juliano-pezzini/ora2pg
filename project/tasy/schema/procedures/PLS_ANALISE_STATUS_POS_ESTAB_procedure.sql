-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_analise_status_pos_estab (nr_seq_analise_pos_p bigint, nr_seq_conta_p bigint, nr_seq_mat_p bigint, nr_seq_proc_p bigint, nr_seq_partic_p bigint, nr_seq_analise_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text ) AS $body$
DECLARE


nr_seq_proc_w			bigint;
nr_seq_mat_w			bigint;
qt_itens_w			double precision;
nr_seq_analise_pos_w		double precision;
vl_calculado_w			double precision;
ie_status_pagto_w			varchar(2);
nr_seq_item_analise_pagto_w		bigint;
nr_seq_analise_pgto_w		bigint;
ie_status_faturamento_w		varchar(1);
ie_glosa_w			varchar(1) := 'N';
ie_faturamento_w			varchar(1);
ie_faturamento_ww			varchar(2);
ie_origem_analise_w		varchar(1);


BEGIN
if (nr_seq_partic_p IS NOT NULL AND nr_seq_partic_p::text <> '') then
	begin
	select	ie_origem_analise
	into STRICT	ie_origem_analise_w
	from	pls_analise_conta
	where	nr_sequencia = nr_seq_analise_p;
	exception
	when others then
		ie_origem_analise_w	:= null;
	end;

	if (ie_origem_analise_w = '2') then
		/*Se for uma análse de pós.*/

		nr_seq_analise_pos_w := nr_seq_analise_p;

		begin
		select	nr_seq_analise_ref
		into STRICT	nr_seq_analise_pgto_w
		from	pls_analise_conta
		where	nr_sequencia = nr_seq_analise_p;
		exception
		when others then
			nr_seq_analise_pgto_w	:= null;
		end;
	else
		/*Se for uma análse de pagto.*/

		nr_seq_analise_pgto_w := nr_seq_analise_p;

		begin
		select	nr_sequencia
		into STRICT	nr_seq_analise_pos_w
		from	pls_analise_conta
		where	nr_seq_analise_ref = nr_seq_analise_p;
		exception
		when others then
			nr_seq_analise_pos_w	:= null;
		end;
	end if;

	select	max(ie_pagamento)
	into STRICT	ie_faturamento_ww
	from	w_pls_resumo_conta
	where	nr_sequencia 	= nr_seq_analise_pos_p
	and		ie_tipo_item 	= 'P';

	if (coalesce(nr_seq_analise_pos_p,0) > 0) then

		begin
		select	vl_calculado,
				ie_status,
				ie_pagamento
		into STRICT	vl_calculado_w,
				ie_status_pagto_w,
				ie_faturamento_w
		from	w_pls_resumo_conta
		where	nr_sequencia = nr_seq_analise_pos_p;
		exception
		when others then
			vl_calculado_w		:= null;
			ie_status_pagto_w	:= null;
			ie_faturamento_w	:= null;
		end;

		--	D	Amarelo	-	Pendente de análise
		--	N	Vermelho-	Não permite faturamento
		--	P	Verde	-	Permitido faturamento
		--	L	Azul	-	Liberado para faturamento
		--	U	Branco	-	Usuário (Aguardando Ação)
		if (ie_status_pagto_w in ('D','P','L','U')) then

			/* Tem valor calculado */

			if (coalesce(vl_calculado_w,0) > 0) then

				/* Status como glosado/parcil */

				if (ie_faturamento_w in ('G','P')) then
					update	w_pls_resumo_conta
					set		vl_total    	= vl_calculado,
							ie_status		= 'L',
							dt_atualizacao	= clock_timestamp(),
							ie_pagamento 	= ie_faturamento_ww,
							nm_usuario		= nm_usuario_p
					where	nr_sequencia	= nr_seq_analise_pos_p;
				else
					select	count(nr_sequencia)
					into STRICT	qt_itens_w
					from	(
							SELECT	nr_sequencia
							from	pls_analise_conta_item
							where	nr_seq_conta 	= nr_seq_conta_p
							and		(((coalesce(nr_seq_proc_partic,0) = 0) and (coalesce(nr_seq_conta_proc,0) = 0))
							or	 	((nr_seq_conta_proc = nr_seq_proc_p) or (nr_seq_proc_partic = nr_seq_partic_p)))
							and		ie_tipo_glosa in ('A','F')
							and 	coalesce(ie_status_faturamento, ie_status) in ('N', 'P')
							and		nr_seq_analise = nr_seq_analise_pgto_w
							
union

							SELECT	nr_sequencia
							from	pls_analise_conta_item
							where	((nr_seq_conta_proc = nr_seq_proc_p) or (nr_seq_proc_partic = nr_seq_partic_p))
							and		coalesce(ie_status_faturamento, ie_status)	in ('N', 'P')
							and		nr_seq_analise	= nr_seq_analise_pos_w) alias18;

					/*A não ser que possui ocorrências no pagamento que indicam que não deve ser realizado o faturamento.
						Não importa o status da ocorrência. Existindo não paga.*/
					if (qt_itens_w > 0) then
						 --Não permite faturamento
						update	w_pls_resumo_conta
						set		vl_total    	= 0,
								ie_status		= 'P',
								dt_atualizacao	= clock_timestamp(),
								ie_pagamento 	= ie_faturamento_ww,
								nm_usuario		= nm_usuario_p
						where	nr_sequencia	= nr_seq_analise_pos_p;
					else
						/*Verificar se existe ocorrências de pós. pendente*/

						select	count(nr_sequencia)
						into STRICT	qt_itens_w
						from	pls_analise_conta_item
						where	((nr_seq_conta_proc 	= nr_seq_proc_p) or (nr_seq_proc_partic = nr_seq_partic_p))
						and		coalesce(ie_status_faturamento, ie_status)	= 'P'
						and		nr_seq_analise		= nr_seq_analise_pos_w;

						if (qt_itens_w = 0) then

							update	w_pls_resumo_conta
							set		vl_total    	= vl_calculado,
									ie_status		= 'L',
									dt_atualizacao	= clock_timestamp(),
									ie_pagamento 	= ie_faturamento_ww,
									nm_usuario		= nm_usuario_p
							where	nr_sequencia	= nr_seq_analise_pos_p;
						else
							--Caso exista o item é mantido como pendente
							update	w_pls_resumo_conta
							set		vl_total    	= 0,
									ie_status		= 'P',
									dt_atualizacao	= clock_timestamp(),
									ie_pagamento 	= ie_faturamento_ww,
									nm_usuario		= nm_usuario_p
							where	nr_sequencia	= nr_seq_analise_pos_p;
						end if;
					end if;
				end if;
			else
				update	w_pls_resumo_conta
				set	vl_total    		= 0,
					ie_status			= 'D',
					ie_pagamento 		= ie_faturamento_ww,
					dt_atualizacao		= clock_timestamp(),
					nm_usuario			= nm_usuario_p
				where	nr_sequencia	= nr_seq_analise_pos_p;
			end if;
		else
			/*Se o item não estiver liberado */

			update	w_pls_resumo_conta
			set		vl_total    	= 0,
					ie_status		= 'U',
					ie_pagamento 	= ie_faturamento_ww,
					dt_atualizacao	= clock_timestamp(),
					nm_usuario		= nm_usuario_p
			where	nr_sequencia	= nr_seq_analise_pos_p;
		end if;
	end if;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_analise_status_pos_estab (nr_seq_analise_pos_p bigint, nr_seq_conta_p bigint, nr_seq_mat_p bigint, nr_seq_proc_p bigint, nr_seq_partic_p bigint, nr_seq_analise_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text ) FROM PUBLIC;

