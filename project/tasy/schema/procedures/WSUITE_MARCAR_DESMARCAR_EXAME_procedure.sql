-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE wsuite_marcar_desmarcar_exame (nr_seq_prescr_p bigint, nr_seq_prescr_item_p bigint, ds_login_p text, ie_tipo_item_p text, ie_exam_lido text) AS $body$
DECLARE


nr_seq_view_w	wsuite_result_view.nr_sequencia%type;


BEGIN

select 	coalesce(max(nr_sequencia),0)
into STRICT	nr_seq_view_w
from	wsuite_result_view
where 	nr_seq_prescr = nr_seq_prescr_p
and		nr_seq_prescr_item = nr_seq_prescr_item_p
and		ds_login = ds_login_p
and		ie_tipo_item = ie_tipo_item_p;
	
if (ie_exam_lido = 'R') then
	
	if (nr_seq_view_w = 0) then

		insert into wsuite_result_view(
			nr_sequencia,
			dt_visualizacao,
			nr_seq_prescr,
			nr_seq_prescr_item,
			ie_tipo_item,
			ds_login,
			nm_usuario,
			dt_atualizacao,
			nm_usuario_nrec,
			dt_atualizacao_nrec) 
		values (
			nextval('wsuite_result_view_seq'),
			clock_timestamp(),
			nr_seq_prescr_p,
			nr_seq_prescr_item_p,
			ie_tipo_item_p,
			ds_login_p,
			ds_login_p,
			clock_timestamp(),
			ds_login_p,
			clock_timestamp());
			
	else
	
		update 	wsuite_result_view
		set 	dt_visualizacao = clock_timestamp(),
				nm_usuario = ds_login_p,
				dt_atualizacao = clock_timestamp()
		where 	nr_sequencia = nr_seq_view_w;
		
	end if;
	
	commit;

elsif (ie_exam_lido = 'RN') and (nr_seq_view_w != 0) then
	
	delete 	FROM wsuite_result_view
	where 	nr_seq_prescr = nr_seq_prescr_p
	and		nr_seq_prescr_item = nr_seq_prescr_item_p
	and		ds_login = ds_login_p
	and		ie_tipo_item = ie_tipo_item_p;
	
	commit;
	
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE wsuite_marcar_desmarcar_exame (nr_seq_prescr_p bigint, nr_seq_prescr_item_p bigint, ds_login_p text, ie_tipo_item_p text, ie_exam_lido text) FROM PUBLIC;

