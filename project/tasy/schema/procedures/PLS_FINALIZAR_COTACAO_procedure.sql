-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_finalizar_cotacao ( nr_seq_cotacao_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint) AS $body$
DECLARE


/* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Finalidade: Finalizar a cotação e atualizar os valores dos itens na análise
-------------------------------------------------------------------------------------------------------------------
Locais de chamada direta:
[  ]  Objetos do dicionário [X] Tasy (Delphi/Java) [  ] Portal [  ]  Relatórios [ ] Outros:
 ------------------------------------------------------------------------------------------------------------------
Pontos de atenção:Performance.
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */
vl_unitario_w			pls_retorno_cotacao.vl_unitario%type;
cd_cgc_fornecedor_w		pls_retorno_cotacao.cd_cgc_fornecedor%type;
nr_seq_auditoria_w		pls_auditoria.nr_sequencia%type;
nr_seq_aud_item_w		pls_item_cotacao.nr_seq_aud_item%type;
ie_tipo_despesa_w		pls_material.ie_tipo_despesa%type;
nr_seq_item_w			pls_auditoria_item.nr_sequencia%type;

nr_seq_requisicao_w		pls_auditoria.nr_seq_requisicao%type;
nr_seq_guia_w			pls_auditoria.nr_seq_guia%type;
nr_seq_segurado_w		pls_auditoria.nr_seq_segurado%type;
nr_seq_grupo_w			bigint;
ds_item_w			varchar(255);
ds_historico_w			varchar(1000);

C01 CURSOR(nr_seq_cotacao_pc bigint) FOR
	SELECT	nr_sequencia,
		nr_seq_aud_item,
		nr_seq_material,
		qt_item,
		ie_status_analise
	from	pls_item_cotacao
	where	nr_seq_cotacao	= nr_seq_cotacao_pc;


BEGIN

select	nr_seq_auditoria
into STRICT	nr_seq_auditoria_w
from	pls_cotacao
where	nr_sequencia	= nr_seq_cotacao_p;

if (nr_seq_cotacao_p IS NOT NULL AND nr_seq_cotacao_p::text <> '') then

	-- Atualizar os itens da auditoria de acordo com as cotações selecionadas.
	for r_C01_w in C01(nr_seq_cotacao_p) loop
		begin

		begin
			select	vl_unitario,
				cd_cgc_fornecedor
			into STRICT	vl_unitario_w,
				cd_cgc_fornecedor_w
			from	pls_retorno_cotacao
			where	nr_seq_item_cotacao	= r_C01_w.nr_sequencia
			and	nr_seq_cotacao		= nr_seq_cotacao_p
			and	ie_selecionado		= 'S';
		exception
		when others then
			vl_unitario_w		:= 0;
			cd_cgc_fornecedor_w	:= null;
		end;

		if (r_C01_w.nr_seq_aud_item IS NOT NULL AND r_C01_w.nr_seq_aud_item::text <> '') then
			update	pls_auditoria_item
			set	vl_item			= vl_unitario_w,
				ie_status		= r_C01_w.ie_status_analise,
				nr_seq_material_forn	= cd_cgc_fornecedor_w,
				dt_atualizacao		= clock_timestamp(),
				nm_usuario		= nm_usuario_p
			where	nr_sequencia		= r_C01_w.nr_seq_aud_item;
		else

			select 	max(ie_tipo_despesa)
			into STRICT	ie_tipo_despesa_w
			from	pls_material
			where	nr_sequencia = r_C01_w.nr_seq_material;

			select	nextval('pls_auditoria_item_seq')
			into STRICT	nr_seq_item_w
			;

			insert into pls_auditoria_item(nr_sequencia, nr_seq_auditoria, nr_seq_material,
				qt_original, dt_atualizacao, nm_usuario,
				dt_atualizacao_nrec, nm_usuario_nrec, qt_ajuste,
				ie_status, ie_acao_auditor,ie_tipo_despesa,
				vl_item, ie_status_solicitacao, ie_tipo_anexo,
				ie_pacote_ptu, vl_original)
			values (nr_seq_item_w, nr_seq_auditoria_w, r_C01_w.nr_seq_material,
				r_C01_w.qt_item, clock_timestamp(), nm_usuario_p,
				clock_timestamp(), nm_usuario_p, r_C01_w.qt_item,
				'P', 'I',ie_tipo_despesa_w,
				vl_unitario_w, 'P', null,
				'N', vl_unitario_w);

			-- Atualizar o item da cotação com a sequencia do item que foi inserido na auditoria
			update	pls_item_cotacao
			set	nr_seq_aud_item	= nr_seq_item_w
			where	nr_sequencia	= r_C01_w.nr_sequencia;

			select	coalesce(a.nr_seq_requisicao,0),
				coalesce(a.nr_seq_guia,0),
				a.nr_seq_segurado
			into STRICT	nr_seq_requisicao_w,
				nr_seq_guia_w,
				nr_seq_segurado_w
			from	pls_auditoria		a
			where	a.nr_sequencia		= nr_seq_auditoria_w;

			ds_historico_w	:= 'O item '||substr(pls_obter_dados_material(r_C01_w.nr_seq_material,'CO'),1,20)|| ' - ' ||substr(pls_obter_desc_material(r_C01_w.nr_seq_material),1,255)||' foi incluido através da cotação de preços.';

			if (nr_seq_requisicao_w > 0) then
				insert into pls_requisicao_historico(nr_sequencia, nr_seq_requisicao, ie_tipo_historico,
					ds_historico , dt_atualizacao, nm_usuario,
					dt_atualizacao_nrec, nm_usuario_nrec, nr_seq_segurado,
					dt_historico, ie_origem_historico, nr_seq_item,
					ie_status_analise, nr_seq_grupo)
				values (nextval('pls_requisicao_historico_seq'), nr_seq_requisicao_w, 'L',
					ds_historico_w,clock_timestamp(),nm_usuario_p,
					clock_timestamp(),nm_usuario_p, nr_seq_segurado_w,
					clock_timestamp(), 'A', nr_seq_item_w,
					'', null);
			elsif (nr_seq_guia_w > 0) then
				insert into pls_guia_plano_historico(nr_sequencia, nr_seq_guia, ie_tipo_log,
					dt_historico, dt_atualizacao, nm_usuario,
					ds_observacao, ie_origem_historico, ie_tipo_historico,
					nr_seq_item,nr_seq_grupo)
				values (	nextval('pls_guia_plano_historico_seq'), nr_seq_guia_w, null,
					clock_timestamp(), clock_timestamp(), nm_usuario_p,
					ds_historico_w,'A','L',
					nr_seq_item_w,null);
			end if;
		end if;
		end;

	insert into pls_item_cotacao_hist(
			nr_sequencia, dt_atualizacao, ie_tipo_historico,
			nm_usuario, dt_atualizacao_nrec, nm_usuario_nrec,
			nr_seq_item_cotacao, ds_historico)
	values (
			nextval('pls_item_cotacao_hist_seq'), clock_timestamp(), 1,
			nm_usuario_p, clock_timestamp(), nm_usuario_p,
			r_C01_w.nr_sequencia, 'O usuário '||nm_usuario_p||' finalizou a cotação.');
	end loop;

	select	nr_seq_aud_item
	into STRICT	nr_seq_aud_item_w
	from	pls_item_cotacao
	where	nr_seq_cotacao	= nr_seq_cotacao_p
	and	(cd_procedimento IS NOT NULL AND cd_procedimento::text <> '');

	update	pls_auditoria_item
	set	ie_status		= 'P',
		dt_atualizacao		= clock_timestamp(),
		nm_usuario		= nm_usuario_p
	where	nr_sequencia		= nr_seq_aud_item_w;

	-- Alterar o status da cotação para Cotação Finalizada
	update	pls_cotacao
	set	ie_status	= 3,
		dt_atualizacao	= clock_timestamp(),
		nm_usuario	= nm_usuario_p
	where	nr_sequencia	= nr_seq_cotacao_p;

	-- Alterar o status da auditoria para Análise
	update	pls_auditoria
	set	ie_status	= 'A',
		dt_atualizacao	= clock_timestamp(),
		nm_usuario	= nm_usuario_p
	where	nr_sequencia	= nr_seq_auditoria_w;

end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_finalizar_cotacao ( nr_seq_cotacao_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint) FROM PUBLIC;

