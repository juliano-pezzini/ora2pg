-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_ordem_compra_viagem ( nm_usuario_p text, cd_estabelecimento_p bigint, nr_seq_via_fatura_p bigint, cd_cnpj_agencia_p text, nr_ordem_compra_p INOUT bigint) AS $body$
DECLARE
	
nr_ordem_compra_w		bigint;
cd_comprador_w			varchar(20);
cd_pessoa_comprador_w		varchar(20);
cd_moeda_padrao_w		bigint;
cd_pessoa_fisica_usu_w    	 	varchar(10);
qt_dia_prazo_entrega_w		bigint;


BEGIN 
 
select 	cd_comprador_padrao, 
	cd_moeda_padrao, 
	qt_dias_entrega_padrao 
into STRICT	cd_comprador_w, 
	cd_moeda_padrao_w, 
	qt_dia_prazo_entrega_w 
from 	parametro_compras 
where 	cd_estabelecimento = cd_estabelecimento_p;
 
select	obter_dados_usuario_opcao(nm_usuario_p,'C' ) 
into STRICT	cd_pessoa_fisica_usu_w
;
 
select 	coalesce(max(cd_pessoa_fisica),'X') 
into STRICT	cd_pessoa_comprador_w 
from	comprador 
where	cd_pessoa_fisica = cd_pessoa_fisica_usu_w;
 
if (cd_pessoa_comprador_w <> 'X' ) then 
	cd_comprador_w := cd_pessoa_comprador_w;
else 
	cd_comprador_w := cd_comprador_w;
end if;
 
select	nextval('ordem_compra_seq') 
into STRICT	nr_ordem_compra_w
;
 
insert into ordem_compra( 
	nr_ordem_compra,	 
	cd_estabelecimento, 
	cd_condicao_pagamento, 
	cd_comprador,		 
	dt_ordem_compra, 
	dt_atualizacao,		 
	nm_usuario, 
	cd_moeda, 
	ie_situacao, 
	dt_inclusao, 
	cd_pessoa_solicitante, 
	ie_frete, 
	dt_entrega, 
	ie_aviso_chegada, 
	ie_emite_obs, 
	ie_urgente, 
	cd_cgc_fornecedor, 
	cd_local_entrega, 
	nr_seq_via_fatura) 
values (nr_ordem_compra_w, 
	cd_estabelecimento_p, 
	'1', 
	cd_comprador_w, 
	clock_timestamp(), 
	clock_timestamp(), 
	nm_usuario_p, 
	cd_moeda_padrao_w, 
	'A', 
	clock_timestamp(), 
	cd_pessoa_fisica_usu_w, 
	'C', 
	clock_timestamp() + qt_dia_prazo_entrega_w, 
	'N', 
	'N', 
	'N', 
	cd_cnpj_agencia_p, 
	1, 
	nr_seq_via_fatura_p);
 
commit;
 
nr_ordem_compra_p := nr_ordem_compra_w;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_ordem_compra_viagem ( nm_usuario_p text, cd_estabelecimento_p bigint, nr_seq_via_fatura_p bigint, cd_cnpj_agencia_p text, nr_ordem_compra_p INOUT bigint) FROM PUBLIC;

