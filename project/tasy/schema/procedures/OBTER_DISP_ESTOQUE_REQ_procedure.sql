-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE obter_disp_estoque_req ( nr_requisicao_p bigint, cd_material_p bigint, cd_local_estoque_p bigint, qt_baixa_p bigint, ie_estoque_disp_p INOUT text) AS $body$
DECLARE


qt_estoque_w			double precision := 0;
qt_baixa_estoque_w		double precision := 0;
dt_mesano_referencia_w		timestamp;
dt_mesano_vigente_w		timestamp;
cd_estabelecimento_w		smallint;
ie_disp_req_trans_w		varchar(1);
qt_requisicao_transf_w		double precision;
ie_tipo_requisicao_w		varchar(3);
cd_material_w			integer;


BEGIN
select	round((dividir(qt_baixa_p, m.qt_conv_estoque_consumo))::numeric,4),
	cd_material_estoque
into STRICT	qt_baixa_estoque_w,
	cd_material_w
from	material m
where	m.cd_material = cd_material_p;

select	a.cd_estabelecimento,
	ie_tipo_requisicao
into STRICT	cd_estabelecimento_w,
	ie_tipo_requisicao_w
from	requisicao_material a,
	operacao_estoque b
where	a.cd_operacao_Estoque = b.cd_operacao_estoque
and	a.nr_requisicao = nr_requisicao_p;

begin
select	dt_mesano_vigente,
	ie_disp_req_trans
into STRICT	dt_mesano_vigente_w,
	ie_disp_req_trans_w
from	parametro_estoque
where	cd_estabelecimento	= cd_estabelecimento_w;
exception
	when no_data_found Then
		CALL wheb_mensagem_pck.exibir_mensagem_abort(265530);
		--'O estabelecimento não foi informado ou o parametro não está cadastrado'
end;

if (cd_local_estoque_p = 0) then
	select	/*+ index (s salesto_i2) */		coalesce(max(s.dt_mesano_referencia),trunc(clock_timestamp(), 'month'))
	into STRICT	dt_mesano_referencia_w
	from	saldo_estoque s
	where	s.cd_estabelecimento	= cd_estabelecimento_w
	and	s.cd_material		= cd_material_w
	and	s.dt_mesano_referencia	>= dt_mesano_vigente_w;
else
	select	/*+ index (s salesto_i2) */		coalesce(max(s.dt_mesano_referencia),trunc(clock_timestamp(), 'month'))
	into STRICT	dt_mesano_referencia_w
	from	saldo_estoque s
	where	s.cd_estabelecimento	= cd_estabelecimento_w
	and	s.cd_material		= cd_material_w
	and 	s.dt_mesano_referencia	>= dt_mesano_vigente_w
	and	s.cd_local_estoque	= cd_local_estoque_p;
end if;

ie_estoque_disp_p	:= 'S';
qt_estoque_w		:= 0;

qt_estoque_w	:= obter_saldo_disp_estoque(
			cd_estabelecimento_w,
			cd_material_p,
			cd_local_estoque_p,
			dt_mesano_referencia_w);

if (ie_disp_req_trans_w = 'S') and (ie_tipo_requisicao_w in ('2','21')) then
	begin
	/*Sidnei - 17/09/2011 - OS 353667
	Tratamento necessário, pois se for considerado a quantidade em requisição no disponíovel, esta quantidade será diminuida na function obter_saldo_disp_estoque.
	O local tem estoque disponível, mas foi diminuido para atender a requisição*/
	select	sum(coalesce(a.qt_estoque, 0)) - sum(coalesce(a.qt_material_atendida, 0)) qt_material
	into STRICT	qt_requisicao_transf_w
	from	operacao_estoque o,
		requisicao_material b,
		item_requisicao_material a
	where	a.nr_requisicao		= b.nr_requisicao
	and	b.cd_operacao_estoque	= o.cd_operacao_estoque
	and	b.cd_estabelecimento	= cd_estabelecimento_w
	and	b.cd_local_estoque	= cd_local_estoque_p
	and	o.ie_tipo_requisicao	= '2'
	and	obter_tipo_motivo_baixa_req(a.cd_motivo_baixa)		= 0
	and	(b.dt_liberacao IS NOT NULL AND b.dt_liberacao::text <> '')
	and	a.cd_material in (
		SELECT	x.cd_material
		from	material x
		where	x.cd_material_estoque = cd_material_w);

	qt_estoque_w := qt_estoque_w + qt_requisicao_transf_w;
	end;
end if;

if (qt_estoque_w < qt_baixa_estoque_w) then
	ie_estoque_disp_p := 'N';
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE obter_disp_estoque_req ( nr_requisicao_p bigint, cd_material_p bigint, cd_local_estoque_p bigint, qt_baixa_p bigint, ie_estoque_disp_p INOUT text) FROM PUBLIC;

