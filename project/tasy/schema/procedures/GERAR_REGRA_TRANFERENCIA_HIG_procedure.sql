-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_regra_tranferencia_hig (cd_estabelecimento_p bigint) AS $body$
DECLARE


cd_setor_Atendimento_w		bigint;
ie_tipo_atendimento_w		bigint;
ie_status_w			varchar(1);
ie_tipo_vaga_w			varchar(15);
ie_solicitacao_w		varchar(15);
qt_dia_leito_w			bigint;
nr_atendimento_w		bigint;
cd_pessoa_fisica_w		varchar(10);
nr_seq_motivo_transf_w		bigint;
cd_estabelecimento_w		bigint;
cd_convenio_w			bigint;
cd_categoria_w			varchar(15);
cd_tipo_acomodacao_w		bigint;
cd_setor_Atendimento_ww		bigint;
ie_tipo_atend_w			atendimento_paciente.ie_tipo_atendimento%type;
nr_seq_classif_atend_w		atendimento_paciente.nr_seq_classificacao%type;
cd_unid_basica_atual_w		gestao_vaga.cd_unid_basica_atual%type;
cd_unid_compl_atual_w		gestao_vaga.cd_unid_compl_atual%type;

C01 CURSOR FOR
	SELECT	cd_setor_atendimento,
		ie_tipo_atendimento,
		ie_status,
		ie_tipo_vaga,
		ie_solicitacao,
		qt_dia_leito,
		nr_seq_motivo_transf
	from	regra_tranferencia_hig
	where	ie_situacao	= 'A'
	and	coalesce(coalesce(cd_estabelecimento,cd_estabelecimento_p),0) = coalesce(cd_estabelecimento_p,0);


C02 CURSOR FOR
	SELECT	b.nr_atendimento,
		b.cd_pessoa_fisica,
		b.cd_estabelecimento,
		a.cd_tipo_acomodacao,
		b.ie_tipo_atendimento,
		b.nr_seq_classificacao
	from	unidade_atendimento a,
		atendimento_paciente b
	where	a.nr_atendimento	= b.nr_atendimento
	and	a.cd_setor_atendimento	= cd_setor_Atendimento_w
	and	((b.ie_tipo_atendimento	= ie_tipo_atendimento_w) or (coalesce(ie_tipo_atendimento_w::text, '') = ''))
	and	trunc(clock_timestamp() - a.dt_entrada_unidade, 0)	= qt_dia_leito_w
	and	coalesce(b.dt_alta::text, '') = '';


BEGIN

open C01;
loop
fetch C01 into	
	cd_setor_atendimento_w,
	ie_tipo_atendimento_w,
	ie_status_w,
	ie_tipo_vaga_w,
	ie_solicitacao_w,
	qt_dia_leito_w,
	nr_seq_motivo_transf_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	
	open C02;
	loop
	fetch C02 into	
		nr_atendimento_w,
		cd_pessoa_fisica_w,
		cd_estabelecimento_w,
		cd_tipo_acomodacao_w,
		ie_tipo_atend_w,
		nr_seq_classif_atend_w;
	EXIT WHEN NOT FOUND; /* apply on C02 */
		begin
		
		cd_categoria_w	:= obter_categoria_atendimento(nr_atendimento_w);
		cd_convenio_w	:= obter_convenio_atendimento(nr_atendimento_w);
		cd_setor_Atendimento_ww	:= obter_setor_atendimento(nr_atendimento_w);
		
	select substr(obter_unidade_atendimento(nr_atendimento_w,'IAA','UB'),1,40)
	into STRICT 	cd_unid_basica_atual_w
	;
				
	select substr(obter_unidade_atendimento(nr_atendimento_w,'IAA','UC'),1,40)
	into STRICT 	cd_unid_compl_atual_w
	;
		
		
		insert into GESTAO_VAGA(	nr_sequencia,
						cd_estabelecimento,
						cd_pessoa_fisica,
						dt_atualizacao,
						nm_usuario,
						dt_solicitacao,
						ie_solicitacao,
						cd_convenio,
						cd_categoria,
						ie_status,
						ie_tipo_vaga,
						dt_prevista,
						nr_seq_motivo_transf,
						CD_TIPO_ACOMOD_DESEJ,
						nr_atendimento,
						cd_setor_desejado,
						cd_setor_atual,
						ie_tipo_atendimento,
						nr_seq_classif_atend,
						cd_unid_basica_atual,
						cd_unid_compl_atual)
			values (	nextval('gestao_vaga_seq'),
						cd_estabelecimento_w,
						cd_pessoa_fisica_w,
						clock_timestamp(),
						'TASY',
						clock_timestamp(),
						ie_solicitacao_w,
						cd_convenio_w,
						cd_categoria_w,
						ie_status_w,
						ie_tipo_vaga_w,
						clock_timestamp(),
						nr_seq_motivo_transf_w,
						cd_tipo_acomodacao_w,
						nr_atendimento_w,
						cd_setor_Atendimento_ww,
						cd_setor_Atendimento_ww,
						ie_tipo_atend_w,
						nr_seq_classif_atend_w,
						cd_unid_basica_atual_w,
						cd_unid_compl_atual_w);
		
		
		end;
	end loop;
	close C02;
	
	end;
end loop;
close C01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_regra_tranferencia_hig (cd_estabelecimento_p bigint) FROM PUBLIC;

