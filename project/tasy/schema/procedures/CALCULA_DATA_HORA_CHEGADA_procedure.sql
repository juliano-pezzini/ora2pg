-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE calcula_data_hora_chegada (nr_seq_agenda_p bigint) AS $body$
DECLARE


qt_min_preparo_w		bigint:=0;
qt_min_preparo_aux_w	bigint;
ie_carater_cirurgia_w	varchar(15);
dt_agenda_w				timestamp;
dt_hora_chegada_w		timestamp;
ie_agenda_dia_seg_w		varchar(1);
hr_inicio_regra_w		timestamp;
hr_fim_regra_w			timestamp;
hr_alterar_w			timestamp;
dt_hora_calculada_w		timestamp;
ie_possui_calculo_w		varchar(1):= 'N';

C01 CURSOR FOR
SELECT b.qt_min_preparo
from   agenda_paciente a,
       proc_interno b
where  a.nr_seq_proc_interno 	= b.nr_sequencia
and    a.nr_sequencia 			= nr_seq_agenda_p

union

SELECT b.qt_min_preparo
from   agenda_paciente a,
       proc_interno b,
       agenda_paciente_proc c
where  a.nr_sequencia = c.nr_sequencia
and    b.nr_sequencia = c.nr_seq_proc_interno
and    a.nr_sequencia = nr_seq_agenda_p;

C02 CURSOR FOR
SELECT	hr_alterar,
	ie_agenda_dia_seg,
	hr_inicio,
	hr_fim
from 	regra_agenda_preparo_cir;


BEGIN

select 	coalesce(max(ie_carater_cirurgia),'U'),
	to_date(to_char(dt_agenda,'dd/mm/yyyy') || '' || to_char(hr_inicio,'hh24:mi:ss'),'dd/mm/yyyy hh24:mi:ss') dt_agenda
into STRICT	ie_carater_cirurgia_w,
	dt_agenda_w
from 	agenda_paciente
where	nr_sequencia = nr_seq_agenda_p
group by dt_agenda,hr_inicio;

if (ie_carater_cirurgia_w = 'E') then
	open C01;
	loop
	fetch C01 into
		qt_min_preparo_aux_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		if (qt_min_preparo_aux_w > qt_min_preparo_w) then
			qt_min_preparo_w := qt_min_preparo_aux_w;
		end if;
	end loop;
	close C01;

	if (qt_min_preparo_w > 0) then
		dt_hora_chegada_w := dt_agenda_w - (qt_min_preparo_w/1440);
	end if;
	dt_hora_calculada_w := dt_hora_chegada_w;
	
	if (dt_hora_chegada_w IS NOT NULL AND dt_hora_chegada_w::text <> '') then
		open C02;
		loop
		fetch C02 into
			hr_alterar_w,
			ie_agenda_dia_seg_w,
			hr_inicio_regra_w,
			hr_fim_regra_w;
		EXIT WHEN NOT FOUND; /* apply on C02 */
			hr_inicio_regra_w 	:= to_date(to_char(dt_hora_chegada_w,'dd/mm/yyyy') || ' ' || to_char(hr_inicio_regra_w,'hh24:mi:ss'),'dd/mm/yyyy hh24:mi:ss');
			hr_fim_regra_w 		:= to_date(to_char(dt_hora_chegada_w,'dd/mm/yyyy') || ' ' || to_char(hr_fim_regra_w,'hh24:mi:ss'),'dd/mm/yyyy hh24:mi:ss');
			
			if (ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_hora_chegada_w) <> ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_agenda_w)) then
				if (ie_agenda_dia_seg_w = 'S') then
					if	to_char(hr_inicio_regra_w,'hh24:mi:ss') >= to_char(hr_fim_regra_w,'hh24:mi:ss') then
						hr_fim_regra_w := hr_fim_regra_w + 1;
					end if;
					if (dt_hora_chegada_w >= hr_inicio_regra_w) and (dt_hora_chegada_w <= hr_fim_regra_w) then
						dt_hora_calculada_w := to_date(to_char(dt_hora_chegada_w,'dd/mm/yyyy') || to_char(hr_alterar_w,'hh24:mi:ss'),'dd/mm/yyyy hh24:mi:ss');
					end if;	
				end if;
			else
				if (ie_agenda_dia_seg_w = 'N') then
					if (hr_inicio_regra_w > dt_hora_chegada_w) then
						hr_inicio_regra_w := hr_inicio_regra_w - 1;
					end if;
					if (dt_hora_chegada_w >= hr_inicio_regra_w) and (dt_hora_chegada_w <= hr_fim_regra_w) then
						dt_hora_calculada_w := to_date(to_char(hr_inicio_regra_w,'dd/mm/yyyy') || to_char(hr_alterar_w,'hh24:mi:ss'),'dd/mm/yyyy hh24:mi:ss');
					end if;
				end if;
			end if;
		end loop;
		close C02;
	end if;

	if (dt_hora_calculada_w IS NOT NULL AND dt_hora_calculada_w::text <> '') then
		update 	agenda_paciente
		set		dt_chegada_prev = dt_hora_calculada_w
		where	nr_sequencia 	= nr_seq_agenda_p;
		commit;
	end if;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE calcula_data_hora_chegada (nr_seq_agenda_p bigint) FROM PUBLIC;

