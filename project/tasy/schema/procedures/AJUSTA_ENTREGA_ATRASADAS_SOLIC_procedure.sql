-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE ajusta_entrega_atrasadas_solic ( nr_solic_compra_p bigint, ie_utilizacao_p text, nm_usuario_p text) AS $body$
DECLARE


						
/*ie_utilizacao_p
C	- Utilizado no Cancelamento da ordem de compra*/
						
nr_item_solic_compra_w				bigint;
nr_item_solic_compra_entr_w				bigint;
qt_entrega_atrasada_w				double precision;
dt_entrega_solicitada_w				timestamp;
ds_historico_w					varchar(2000);
ds_titulo_w					varchar(255);

c01 CURSOR FOR
SELECT	nr_item_solic_compra
from	solic_compra_item
where	nr_solic_compra = nr_solic_compra_p
order by nr_item_solic_compra;

c02 CURSOR FOR
SELECT	dt_entrega_solicitada
from	solic_compra_item_entrega
where	nr_solic_compra = nr_solic_compra_p
and	nr_item_solic_compra = nr_item_solic_compra_w
and ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_entrega_solicitada) < ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(clock_timestamp());


BEGIN

open C01;
loop
fetch C01 into	
	nr_item_solic_compra_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	
	select	coalesce(sum(qt_entrega_solicitada),0)
	into STRICT	qt_entrega_atrasada_w
	from	solic_compra_item_entrega
	where	nr_solic_compra = nr_solic_compra_p
	and	nr_item_solic_compra = nr_item_solic_compra_w
	and ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_entrega_solicitada) < ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(clock_timestamp());
	
	if (qt_entrega_atrasada_w > 0) then
		
		select	coalesce(max(nr_item_solic_compra_entr),0)
		into STRICT	nr_item_solic_compra_entr_w
		from	solic_compra_item_entrega
		where	nr_solic_compra = nr_solic_compra_p
		and	nr_item_solic_compra = nr_item_solic_compra_w
	    and ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_entrega_solicitada) = ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(clock_timestamp());
	
		if (nr_item_solic_compra_entr_w > 0) then
			
			update	solic_compra_item_entrega
			set	qt_entrega_solicitada = qt_entrega_solicitada + qt_entrega_atrasada_w
			where	nr_solic_compra = nr_solic_compra_p
			and	nr_item_solic_compra = nr_item_solic_compra_w
			and	nr_item_solic_compra_entr = nr_item_solic_compra_entr_w;
		else
			select	coalesce(max(nr_item_solic_compra_entr),0) + 1
			into STRICT	nr_item_solic_compra_entr_w
			from	solic_compra_item_entrega
			where	nr_solic_compra = nr_solic_compra_p
			and	nr_item_solic_compra = nr_item_solic_compra_w;
			
			insert into solic_compra_item_entrega(
				nr_solic_compra,
				nr_item_solic_compra,
				nr_item_solic_compra_entr,
				qt_entrega_solicitada,
				dt_entrega_solicitada,
				dt_atualizacao,
				nm_usuario)
			values (	nr_solic_compra_p,
				nr_item_solic_compra_w,
				nr_item_solic_compra_entr_w,
				qt_entrega_atrasada_w,
                ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(clock_timestamp()),
				clock_timestamp(),
				nm_usuario_p);		
		end if;
	
	open C02;
	loop
	fetch C02 into	
		dt_entrega_solicitada_w;
	EXIT WHEN NOT FOUND; /* apply on C02 */
		begin


	
		if (ie_utilizacao_p = 'C') then
			ds_historico_w := Wheb_mensagem_pck.get_Texto(297034,
						'NR_ITEM_SOLIC_COMPRA_W='||nr_item_solic_compra_w||
						';DT_ENTREGA_SOLICITADA_W='||PKG_DATE_FORMATERS.TO_VARCHAR(
							dt_entrega_solicitada_w, 'shortDate', WHEB_USUARIO_PCK.GET_CD_ESTABELECIMENTO,
							WHEB_USUARIO_PCK.GET_NM_USUARIO)||
						';NM_USUARIO_W='||obter_nome_usuario(nm_usuario_p)||
						';DS_PROCEDURE_W='||'AJUSTA_ENTREGA_ATRASADAS_SOLIC'||
						';DT_ATUAL_W='||PKG_DATE_FORMATERS.TO_VARCHAR(
							clock_timestamp(), 'shortDate', WHEB_USUARIO_PCK.GET_CD_ESTABELECIMENTO, 
			            	WHEB_USUARIO_PCK.GET_NM_USUARIO));
			
			
		elsif (ie_utilizacao_p = 'A') then
			ds_historico_w	:= SUBSTR(Wheb_mensagem_pck.get_texto(297047,
						'NR_ITEM_SOLIC_COMPRA_W='||nr_item_solic_compra_w||
						';DT_ENTREGA_SOLICITADA_W='||PKG_DATE_FORMATERS.TO_VARCHAR(
							dt_entrega_solicitada_w, 'shortDate', WHEB_USUARIO_PCK.GET_CD_ESTABELECIMENTO,
							WHEB_USUARIO_PCK.GET_NM_USUARIO)||
						';NM_USUARIO_W='||obter_nome_usuario(nm_usuario_p)||
						';DS_PROCEDURE_W='||'AJUSTA_ENTREGA_ATRASADAS_SOLIC'||
						';DT_ATUAL_W='||PKG_DATE_FORMATERS.TO_VARCHAR(
							clock_timestamp(), 'shortDate', WHEB_USUARIO_PCK.GET_CD_ESTABELECIMENTO, 
			            	WHEB_USUARIO_PCK.GET_NM_USUARIO)),1,2000);

		end if;
		
		
		
		ds_titulo_w	:= wheb_mensagem_pck.get_texto(297039);
		CALL gerar_hist_solic_sem_commit(
				nr_solic_compra_p,
				ds_titulo_w,
				ds_historico_w,
				'ADE',
				nm_usuario_p);
		
		end;
	end loop;
	close C02;
	
	delete	from solic_compra_item_entrega
	where	nr_solic_compra = nr_solic_compra_p
	and	nr_item_solic_compra = nr_item_solic_compra_w
	and ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_entrega_solicitada) < ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(clock_timestamp());
		
	end if;
	end;
end loop;
close C01;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ajusta_entrega_atrasadas_solic ( nr_solic_compra_p bigint, ie_utilizacao_p text, nm_usuario_p text) FROM PUBLIC;

