-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE cpoe_suspender_etapas_prescr ( ie_tipo_item_p bigint, nr_prescricao_p bigint, nr_seq_item_p bigint, nr_seq_item_cpoe_p bigint, nr_atendimento_p bigint default null) AS $body$
DECLARE


nr_seq_gas_hor_w      prescr_gasoterapia_hor.nr_sequencia%type;
nr_seq_proc_cpoe_w    prescr_procedimento.nr_seq_proc_cpoe%type;
nr_etapa_sol_w        prescr_mat_hor.nr_etapa_sol%type;
nr_etapas_erro_w      varchar(4000);

C01 CURSOR FOR
SELECT	distinct c.nr_etapa_sol
from	prescr_solucao x,
        prescr_mat_hor c,
        prescr_medica a
where	x.nr_prescricao = c.nr_prescricao
and	    x.nr_prescricao = a.nr_prescricao
and	    c.nr_prescricao = a.nr_prescricao
and     a.nr_prescricao = nr_prescricao_p
and     coalesce(x.dt_suspensao::text, '') = ''
and	    coalesce(c.dt_fim_horario::text, '') = ''
and	    coalesce(c.dt_suspensao::text, '') = ''
and     coalesce(c.dt_inicio_horario::text, '') = ''
and	    x.nr_seq_solucao = c.nr_seq_solucao
and     x.nr_seq_solucao = nr_seq_item_p
and     coalesce(c.ie_horario_especial, 'N') <> 'S';

C02 CURSOR FOR
SELECT	b.nr_sequencia
from	prescr_medica a,
     	prescr_mat_hor b,
		prescr_material c,
		cpoe_dieta d
where	a.nr_prescricao = b.nr_prescricao
and		a.nr_prescricao = c.nr_prescricao
and		b.nr_seq_material = c.nr_sequencia
and		a.nr_prescricao = nr_prescricao_p
and		c.nr_seq_dieta_cpoe = nr_seq_item_cpoe_p
and		c.nr_seq_dieta_cpoe = d.nr_sequencia
and     coalesce(b.dt_inicio_horario::text, '') = ''
and		coalesce(b.dt_fim_horario::text, '') = ''
and		coalesce(b.dt_suspensao::text, '') = ''
and     coalesce(c.dt_suspensao::text, '') = '';

C03 CURSOR FOR
SELECT	x.nr_sequencia as nr_seq_proc_hor,
        b.nr_sequencia as nr_seq_procedimento
from	prescr_proc_hor x,
        prescr_medica a,
        prescr_solic_bco_sangue c,
        prescr_procedimento b
where	a.nr_prescricao	= c.nr_prescricao
and		c.nr_sequencia = b.nr_seq_solic_sangue
and     x.nr_prescricao = a.nr_prescricao
and     x.nr_seq_procedimento = b.nr_sequencia
and		a.nr_prescricao	= nr_prescricao_p
and		c.nr_seq_hemo_cpoe	= nr_seq_item_cpoe_p
and     coalesce(x.dt_inicio_horario::text, '') = ''
and     coalesce(x.dt_fim_horario::text, '') = ''
and     coalesce(x.dt_suspensao::text, '') = ''
and     coalesce(b.dt_suspensao::text, '') = '';

C05 CURSOR FOR
SELECT	b.nr_sequencia
from	nut_paciente_hor b,
        nut_pac x,
        prescr_medica a	
where	x.nr_prescricao = a.nr_prescricao
and     a.nr_prescricao = nr_prescricao_p
and     x.nr_seq_npt_cpoe = nr_seq_item_cpoe_p	
and		b.nr_seq_nut_protocolo	= x.nr_sequencia
and		coalesce(x.dt_suspensao::text, '') = ''
and		((coalesce(b.ie_horario_especial,'N') = 'N') or (b.dt_fim_horario IS NOT NULL AND b.dt_fim_horario::text <> ''))		
and     coalesce(b.dt_suspensao::text, '') = ''
and     coalesce(b.ie_status::text, '') = ''
and		coalesce(x.ie_npt_adulta, 'S') = 'P'				
and     x.ie_status = 'N';

C06 CURSOR FOR
SELECT	b.nr_sequencia
from	nut_paciente_hor b,
        nut_pac x,
        prescr_medica a	
where	x.nr_prescricao = a.nr_prescricao
and     a.nr_prescricao = nr_prescricao_p
and     x.nr_seq_npt_cpoe = nr_seq_item_cpoe_p	
and		b.nr_seq_nut_protocolo	= x.nr_sequencia
and		coalesce(x.dt_suspensao::text, '') = ''
and		((coalesce(b.ie_horario_especial,'N') = 'N') or (b.dt_fim_horario IS NOT NULL AND b.dt_fim_horario::text <> ''))		
and     coalesce(b.dt_suspensao::text, '') = ''
and     coalesce(b.ie_status::text, '') = ''
and		coalesce(x.ie_npt_adulta, 'S') = 'S'				
and     x.ie_status = 'N';

C09 CURSOR FOR
SELECT	nr_sequencia
from	prescr_gasoterapia_hor
where	nr_seq_gasoterapia	= nr_seq_item_p
and 	nr_prescricao		= nr_prescricao_p
and     coalesce(coalesce(dt_fim_horario, dt_interrupcao)::text, '') = ''
and 	coalesce(dt_suspensao::text, '') = ''
and     nr_sequencia not in (
   SELECT nr_seq_horario
   from prescr_gasoterapia_evento
   where nr_seq_gasoterapia = nr_seq_item_p
   and nr_prescricao = nr_prescricao_p
   and ie_evento in ('I','R')
   and ie_evento_valido = 'S'
);

BEGIN
if (ie_tipo_item_p IS NOT NULL AND ie_tipo_item_p::text <> '') and (nr_prescricao_p IS NOT NULL AND nr_prescricao_p::text <> '') and (nr_seq_item_p IS NOT NULL AND nr_seq_item_p::text <> '') then

	if (ie_tipo_item_p = 1) then -- solucao
		for c01_w in C01 loop
            nr_etapas_erro_w := suspender_etapa_solucao(1, nr_prescricao_p, nr_seq_item_p, null, 12, null, wheb_usuario_pck.get_nm_usuario, null, c01_w.nr_etapa_sol, c01_w.nr_etapa_sol, nr_etapas_erro_w, null, obter_perfil_ativo, null, 'S');
        end loop;

	elsif (ie_tipo_item_p = 2) then -- suporte nutricional enteral
       for c02_w in C02 loop
            CALL suspender_etapa_sne(c02_w.nr_sequencia,wheb_usuario_pck.get_nm_usuario, null, null );
        end loop;
	elsif (ie_tipo_item_p = 3) then -- hemocomponente
        for c03_w in C03 loop
            CALL suspender_etapa_hemoterapia(c03_w.nr_seq_procedimento, nr_prescricao_p, null, c03_w.nr_seq_proc_hor, wheb_usuario_pck.get_nm_usuario);
        end loop;

	elsif (ie_tipo_item_p in (5, 7)) then -- npt infantil (neo/pediatrica)
        for c05_w in C05 loop
            CALL suspender_etapa_npt(ie_tipo_item_p, nr_seq_item_p, c05_w.nr_sequencia, nr_prescricao_p, wheb_usuario_pck.get_nm_usuario);
        end loop;

	elsif (ie_tipo_item_p = 6) then -- npt Adulta 
        for c06_w in C06 loop
            CALL suspender_etapa_npt(ie_tipo_item_p, nr_seq_item_p, c06_w.nr_sequencia, nr_prescricao_p, wheb_usuario_pck.get_nm_usuario);
        end loop;

    elsif (ie_tipo_item_p = 8) then -- dialise
        CALL cpoe_suspender_hor_item_prescr(nr_prescricao_p, nr_seq_item_cpoe_p, 'D', nr_atendimento_p, wheb_usuario_pck.get_nm_usuario, null, 'N');

    elsif (ie_tipo_item_p = 9) then -- gasoterapia
        for c09_w in C09 loop
           CALL suspender_prescr_gas_hor(nr_prescricao_p, nr_seq_item_p, c09_w.nr_sequencia, wheb_usuario_pck.get_nm_usuario, 'S');
        end loop;

	end if;

end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cpoe_suspender_etapas_prescr ( ie_tipo_item_p bigint, nr_prescricao_p bigint, nr_seq_item_p bigint, nr_seq_item_cpoe_p bigint, nr_atendimento_p bigint default null) FROM PUBLIC;

