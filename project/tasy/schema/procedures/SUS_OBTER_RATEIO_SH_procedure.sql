-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE sus_obter_rateio_sh ( cd_estabelecimento_p bigint, cd_material_p bigint, cd_procedimento_p bigint, ie_origem_proced_p bigint, cd_setor_atendimento_p bigint, cd_convenio_p INOUT bigint, cd_categoria_p INOUT bigint, vl_fixo_p INOUT bigint, nr_seq_proc_interno_p bigint) AS $body$
DECLARE


cd_grupo_proc_w			bigint		:= 0;
cd_especial_proc_w		bigint		:= 0;
cd_area_proc_w			bigint		:= 0;
cd_procedimento_w		bigint		:= 0;
cd_grupo_mat_w			smallint		:= 0;
cd_subgrupo_mat_w		smallint		:= 0;
cd_classe_mat_w			integer		:= 0;
cd_material_w			bigint		:= 0;
vl_fixo_w				double precision		:= 0;
cd_convenio_w			integer		:= 0;
cd_categoria_w			integer		:= 0;
cd_setor_atendimento_w		integer		:= 0;
nr_seq_proc_interno_w		procedimento_paciente.nr_seq_proc_interno%type;

/* Leitura do cadastro da regra de SH de procedimentos*/

C02 CURSOR FOR
	SELECT	vl_fixo,
		cd_convenio,
		cd_categoria
	from	sus_regra_rateio_sh
	where	cd_estabelecimento			= cd_estabelecimento_p
	and	coalesce(ie_sus_unificado,'N')		= 'S'
	and	coalesce(cd_procedimento,cd_procedimento_w)	= cd_procedimento_w
	and	coalesce(cd_area_procedimento,cd_area_proc_w)= cd_area_proc_w
	and	coalesce(cd_especialidade,cd_especial_proc_w) = cd_especial_proc_w
	and	coalesce(cd_grupo_proc,cd_grupo_proc_w)	= cd_grupo_proc_w
	and	coalesce(nr_seq_proc_interno,nr_seq_proc_interno_w) = nr_seq_proc_interno_w
	and	coalesce(cd_setor_atendimento,cd_setor_atendimento_w) = cd_setor_atendimento_w
	and	coalesce(cd_material::text, '') = ''
	and	coalesce(cd_grupo_material::text, '') = ''
	and	coalesce(cd_subgrupo_material::text, '') = ''
	and	coalesce(cd_classe_material::text, '') = ''
	order by	coalesce(cd_procedimento,0),
			coalesce(cd_grupo_proc,0),
			coalesce(cd_especialidade,0),
			coalesce(cd_area_procedimento,0),
			coalesce(cd_setor_atendimento,0);

/* Leitura do cadastro da regra de SH de materiais*/

C03 CURSOR FOR
	SELECT	vl_fixo,
		cd_convenio,
		cd_categoria
	from	sus_regra_rateio_sh
	where	cd_estabelecimento			= cd_estabelecimento_p
	and	coalesce(ie_sus_unificado,'N')		= 'S'
	and	coalesce(cd_material,cd_material_w)		= cd_material_w
	and	coalesce(cd_grupo_material,cd_grupo_mat_w)	= cd_grupo_mat_w
	and	coalesce(cd_subgrupo_material,cd_subgrupo_mat_w) = cd_subgrupo_mat_w
	and	coalesce(cd_classe_material,cd_classe_mat_w)	= cd_classe_mat_w
	and	coalesce(cd_setor_atendimento,cd_setor_atendimento_w) = cd_setor_atendimento_w
	and	coalesce(cd_procedimento::text, '') = ''
	and	coalesce(cd_area_procedimento::text, '') = ''
	and	coalesce(cd_especialidade::text, '') = ''
	and	coalesce(cd_grupo_proc::text, '') = ''
	and	coalesce(nr_seq_proc_interno::text, '') = ''
	order by	coalesce(cd_material,0),
			coalesce(cd_classe_material,0),
			coalesce(cd_subgrupo_material,0),
			coalesce(cd_grupo_material,0),
			coalesce(cd_setor_atendimento,0);

C01 CURSOR FOR
	SELECT	vl_fixo,
		cd_convenio,
		cd_categoria
	from	sus_regra_rateio_sh
	where	cd_estabelecimento			= cd_estabelecimento_p
	and	coalesce(ie_sus_unificado,'N')		= 'S'
	and	coalesce(nr_seq_proc_interno,nr_seq_proc_interno_w) = nr_seq_proc_interno_w
	and	coalesce(cd_material::text, '') = ''
	and	coalesce(cd_grupo_material::text, '') = ''
	and	coalesce(cd_subgrupo_material::text, '') = ''
	and	coalesce(cd_classe_material::text, '') = ''
	and	coalesce(cd_procedimento::text, '') = ''
	and	coalesce(cd_area_procedimento::text, '') = ''
	and	coalesce(cd_especialidade::text, '') = ''
	and	coalesce(cd_especialidade::text, '') = ''
	and	coalesce(cd_grupo_proc::text, '') = ''
	order by	coalesce(nr_seq_proc_interno,0);


BEGIN

cd_procedimento_w	:= coalesce(cd_procedimento_p,0);
cd_material_w		:= coalesce(cd_material_p,0);
cd_setor_atendimento_w	:= coalesce(cd_setor_atendimento_p,0);
nr_seq_proc_interno_w	:= coalesce(nr_seq_proc_interno_p,0);

/* obter estrutura do procedimento */

if (coalesce(nr_seq_proc_interno_w,0) > 0) then
	begin

	open c01;
	loop
	fetch c01 into
		vl_fixo_w,
		cd_convenio_w,
		cd_categoria_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
		begin
		vl_fixo_p	:= vl_fixo_w;
		cd_convenio_p	:= cd_convenio_w;
		cd_categoria_p	:= cd_categoria_w;
		end;
	end loop;
	close c01;

	end;
end if;

if (cd_procedimento_w > 0) then
	begin

	begin
	select	coalesce(a.cd_grupo_proc,0),
		coalesce(b.cd_especialidade,0),
		coalesce(c.cd_area_procedimento,0)
	into STRICT	cd_grupo_proc_w,
		cd_especial_proc_w,
		cd_area_proc_w
	from	procedimento a,
		grupo_proc b,
		especialidade_proc c
	where	a.cd_grupo_proc		= b.cd_grupo_proc
	and	b.cd_especialidade	= c.cd_especialidade
	and	a.cd_procedimento 	= cd_procedimento_p
	and	a.ie_origem_proced	= ie_origem_proced_p  LIMIT 1;
	exception
	when others then
		cd_grupo_proc_w		:= 0;
		cd_especial_proc_w	:= 0;
		cd_area_proc_w		:= 0;
	end;

	open c02;
	loop
	fetch c02 into
		vl_fixo_w,
		cd_convenio_w,
		cd_categoria_w;
	EXIT WHEN NOT FOUND; /* apply on c02 */
		begin
		vl_fixo_p	:= vl_fixo_w;
		cd_convenio_p	:= cd_convenio_w;
		cd_categoria_p	:= cd_categoria_w;
		end;
	end loop;
	close c02;
	end;
end if;

/* obter estrutura do material */

if (cd_material_w > 0) then
	begin

	begin
	select	coalesce(d.cd_grupo_material,0),
		coalesce(c.cd_subgrupo_material,0),
		coalesce(b.cd_classe_material,0)
	into STRICT	cd_grupo_mat_w,
		cd_subgrupo_mat_w,
		cd_classe_mat_w
	from	Grupo_material d,
		SubGrupo_Material c,
		Classe_material b,
		Material a
	where	b.cd_subgrupo_material	= c.cd_subgrupo_material
	and 	c.cd_grupo_material	= d.cd_grupo_material
	and	a.cd_classe_material	= b.cd_classe_material
	and	a.cd_material		= cd_material_p  LIMIT 1;
	exception
	when others then
		cd_grupo_mat_w		:= 0;
		cd_subgrupo_mat_w	:= 0;
		cd_classe_mat_w		:= 0;
	end;

	open c03;
	loop
	fetch c03 into
		vl_fixo_w,
		cd_convenio_w,
		cd_categoria_w;
	EXIT WHEN NOT FOUND; /* apply on c03 */
		begin
		vl_fixo_p	:= vl_fixo_w;
		cd_convenio_p	:= cd_convenio_w;
		cd_categoria_p	:= cd_categoria_w;
		end;
	end loop;
	close c03;

	end;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE sus_obter_rateio_sh ( cd_estabelecimento_p bigint, cd_material_p bigint, cd_procedimento_p bigint, ie_origem_proced_p bigint, cd_setor_atendimento_p bigint, cd_convenio_p INOUT bigint, cd_categoria_p INOUT bigint, vl_fixo_p INOUT bigint, nr_seq_proc_interno_p bigint) FROM PUBLIC;

