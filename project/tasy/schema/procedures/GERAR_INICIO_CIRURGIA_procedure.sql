-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_inicio_cirurgia ( cd_setor_atendimento_p bigint, cd_unidade_basica_p text, cd_unidade_compl_p text, dt_entrada_unidade_p timestamp, dt_inicio_real_p timestamp, nm_usuario_p text, nr_atendimento_p bigint, nr_cirurgia_p bigint) AS $body$
DECLARE


cd_tipo_acomodacao_w		smallint 	:= 0;
nr_sequencia_w		integer	:= 0;
nr_seq_interno_w		bigint	:= 0;
qtd_registro_w		smallint	:=0;

/** Eder Jhoney da Silva - 09/11/2007
  * Gera o inicio da cirurgia. (Utilizada no Palm)
 */
BEGIN

select	cd_tipo_acomodacao
into STRICT	cd_tipo_acomodacao_w
from 	unidade_atendimento
where 	cd_setor_atendimento 	= cd_setor_atendimento_p
and 	cd_unidade_basica		= cd_unidade_basica_p
and 	cd_unidade_compl	 	= cd_unidade_compl_p;


select max(nr_sequencia)
into STRICT	nr_sequencia_w
from 	atend_paciente_unidade
where	nr_atendimento = nr_atendimento_p;


select nextval('atend_paciente_unidade_seq')
into STRICT	nr_seq_interno_w
;

select	count(*)
into STRICT	qtd_registro_w
from	atend_paciente_unidade
where	nr_atendimento = nr_atendimento_p
and	dt_entrada_unidade = dt_entrada_unidade_p;


if (qtd_registro_w = 0) then
	insert into atend_paciente_unidade(	nr_atendimento,
                	cd_setor_atendimento,
	             	cd_unidade_basica,
               	cd_unidade_compl,
                	dt_entrada_unidade,
	              dt_atualizacao,
                	nm_usuario,
			cd_tipo_acomodacao,
	              nr_sequencia,
                	nr_seq_interno,
                	ie_calcular_dif_diaria)
	values (	nr_atendimento_p,
  			cd_setor_atendimento_p,
     			cd_unidade_basica_p,
	              cd_unidade_compl_p,
                	dt_entrada_unidade_p,
                	clock_timestamp(),
	              nm_usuario_p,
			cd_tipo_acomodacao_w,
                	nr_sequencia_w,
	              nr_seq_interno_w,
                	'S');
end if;

update cirurgia
set 	nr_cirurgia 		= nr_cirurgia_p,
	dt_inicio_real  	= dt_inicio_real_p,
	nr_atendimento 	= nr_atendimento_p,
	dt_entrada_unidade	= dt_entrada_unidade_p,
	ie_status_cirurgia 	= 2,
	dt_atualizacao 	= clock_timestamp()
where 	nr_cirurgia 		= nr_cirurgia_p;

commit;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_inicio_cirurgia ( cd_setor_atendimento_p bigint, cd_unidade_basica_p text, cd_unidade_compl_p text, dt_entrada_unidade_p timestamp, dt_inicio_real_p timestamp, nm_usuario_p text, nr_atendimento_p bigint, nr_cirurgia_p bigint) FROM PUBLIC;

