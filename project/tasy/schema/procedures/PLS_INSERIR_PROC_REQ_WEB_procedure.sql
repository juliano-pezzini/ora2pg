-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_inserir_proc_req_web ( nr_seq_proc_p bigint, nr_seq_requisicao_p bigint, ie_origem_p bigint, cd_procedimento_p bigint, qt_procedimento_p bigint, ie_tipo_p text, cd_estabelecimento_p bigint, nm_usuario_p text, ie_opme_p text, ie_tipo_lanc_anexo_p text, ie_lanc_proc_auto_p INOUT text, ds_observacao_p text) AS $body$
DECLARE

 
/*++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ 
Finalidade:  Inserir os procedimentos da requisição para autorização 
---------------------------------------------------------------------------------------------------------------------------------------------------- 
Locais de chamada direta: 
[ ] Objetos do dicionário [ x ] Tasy (Delphi/Java) [ x ] Portal [ ] Relatórios [ ] Outros: 
 ---------------------------------------------------------------------------------------------------------------------------------------------------- 
Pontos de atenção:  
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ 
				 
	IE_TIPO_P 
	P - insert procedimeto padrão 
	M - insert procedimento manual 
*/ 
 
nr_seq_proc_w		bigint;
ie_lanc_proc_auto_w	varchar(2)	:= 'N';
ie_tipo_intercambio_w	varchar(10);
ie_tipo_processo_w	varchar(1);		
	 

BEGIN 
 
if (coalesce(cd_procedimento_p::text, '') = '') and (coalesce(ie_origem_p::text, '') = '') then 
	ie_lanc_proc_auto_w := pls_gerar_proced_autor_regra(null, nr_seq_requisicao_p, 9, nm_usuario_p, ie_lanc_proc_auto_w);
else 
 
--if	(ie_lanc_proc_auto_w	= 'N') then 
	if (ie_tipo_p = 'P') then 
		select 	nextval('pls_requisicao_proc_seq') 
		into STRICT	nr_seq_proc_w 
		;
	else	 
		nr_seq_proc_w		:= nr_seq_proc_p;
	end if;
 
	insert into pls_requisicao_proc(nr_sequencia, dt_atualizacao, dt_atualizacao_nrec, 
		nm_usuario, nm_usuario_nrec, ie_origem_proced,  
		cd_procedimento, qt_procedimento, ie_status,      
		ie_estagio, nr_seq_requisicao, qt_solicitado, 
		ie_utiliza_opme, qt_proc_executado, ie_origem_inclusao, 
		ds_observacao)  
	values (nr_seq_proc_w, clock_timestamp(), clock_timestamp(),       
		nm_usuario_p, nm_usuario_p, ie_origem_p,     
		cd_procedimento_p, 0,'U',         
		'AE', nr_seq_requisicao_p, qt_procedimento_p, 
		ie_opme_p, 0, 'P', 
		ds_observacao_p);
		 
	commit;
	 
	--Verifica se o item possui algum tipo de anexo, se possuir insere o tipo de anexo no item 
	/*pls_atualizar_tipo_anexo_item(	nr_seq_proc_w, null, null, 
					null, cd_procedimento_p, ie_origem_p, 
					null, nm_usuario_p);		*/
 
	 
end if;
 
if (coalesce(nr_seq_proc_w,0)	<> 0) then 
	CALL pls_atualiza_valor_proc_aut(nr_seq_proc_w, 'R', nm_usuario_p);
	CALL pls_lanc_auto_requisicao(nr_seq_requisicao_p, nr_seq_proc_w, null, 
				 nm_usuario_p, cd_estabelecimento_p, ie_tipo_lanc_anexo_p);
end if;
			 
 
begin 
	select	ie_tipo_intercambio, 
		ie_tipo_processo 
	into STRICT	ie_tipo_intercambio_w, 
		ie_tipo_processo_w 
	from	pls_requisicao 
	where 	nr_sequencia = nr_seq_requisicao_p;
exception 
when others then 
	ie_tipo_intercambio_w := null;
	ie_tipo_processo_w := null;
end;
 
if (ie_tipo_intercambio_w = 'I' and ie_tipo_processo_w = 'I') then 
	CALL pls_inserir_obs_regra_intercam(nr_seq_proc_w, null, 'P', nm_usuario_p);
	CALL pls_gerar_de_para_req_intercam( nr_seq_proc_w, null, null, 
					null, null, null, 
					null, cd_estabelecimento_p, nm_usuario_p);
end if;
 
ie_lanc_proc_auto_p	:= ie_lanc_proc_auto_w;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_inserir_proc_req_web ( nr_seq_proc_p bigint, nr_seq_requisicao_p bigint, ie_origem_p bigint, cd_procedimento_p bigint, qt_procedimento_p bigint, ie_tipo_p text, cd_estabelecimento_p bigint, nm_usuario_p text, ie_opme_p text, ie_tipo_lanc_anexo_p text, ie_lanc_proc_auto_p INOUT text, ds_observacao_p text) FROM PUBLIC;

