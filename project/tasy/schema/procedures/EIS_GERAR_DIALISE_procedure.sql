-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE eis_gerar_dialise (dt_parametro_p timestamp, nm_usuario_p text) AS $body$
DECLARE

dt_atual_w	timestamp;

qt_entrada_agudo_w  			bigint;
qt_entrada_cronico_w			bigint;
qt_obito_agudo_w				bigint;
qt_obito_cro_menos_90_dias_w		bigint;
qt_obito_cro_mais_90_dias_w			bigint;
qt_saida_tx_w				bigint;
qt_desistencia_w				bigint;
qt_transferencia_w				bigint;
qt_hd_hp_w				bigint;
qt_alta_cronico_w				bigint;
qt_alta_agudo_w				bigint;
qt_fim_dia_cronico_w			bigint;
--qt_cronicos_fim_mes_ant_w			number(10);

--qt_agudos_fim_mes_ant_w			number(10);
qt_fim_dia_agudo_w			bigint;
qt_pac_transito_w				bigint;
qt_sessoes_dialise_w			bigint;
qt_pac_diabeticos_w			bigint;
qt_acesso_adequado_w			bigint;
qt_acesso_inadequado_w			bigint;
qt_acesso_dl_w				bigint;
qt_acesso_permcath_w			bigint;
qt_acesso_protese_w			bigint;
qt_perdas_acessos_w			bigint;
qt_perdas_permcath_w			bigint;
qt_perdas_dl_w				bigint;
qt_novos_cateter_dl_w			bigint;
qt_novos_permcath_w			bigint;
qt_acessos_realizados_w			bigint;
qt_pirogenia_w				bigint;
qt_transfusoes_w				bigint;
qt_culturas_w				bigint;
qt_pressao_alta_pos_w			bigint;
qt_pressao_alta_pre_w			bigint;
qt_internados_w				bigint; -- faltante
qt_hipertensos_w			bigint;

nr_seq_unid_dialise_w			bigint;
nr_seq_unid_dialise_atual_w		bigint;
nr_seq_evento_pirogenia_w			bigint;
cd_pessoa_fisica_w			varchar(10);
vl_pressao_pres_med_w			real;
vl_pressao_pred_med_w			real;
vl_pressao_poss_med_w			real;
vl_pressao_posd_med_w			real;
nr_tipo_evento_internacao_w			bigint;
qt_mes_atual_w				bigint;
cd_cid_morte_w				varchar(10);
qt_sessoes_dialise_agudo_w			bigint;
qt_sessoes_dialise_cronico_w			bigint;
cd_estabelecimento_w			bigint;
cd_empresa_w				bigint;
nr_seq_dialisador_w			bigint;
cd_convenio_w				integer;


C01 CURSOR FOR
	SELECT	nr_sequencia,
		obter_empresa_estab(cd_estabelecimento),
		cd_estabelecimento
	from	hd_unidade_dialise;
C02 CURSOR FOR
	SELECT  	distinct cd_pessoa_fisica,
		substr(obter_cid_obito(nr_atendimento),1,10),
		substr(HD_OBTER_SEQ_DIALISADOR_ATUAL(nr_sequencia),1,10),
		substr(obter_convenio_atendimento(nr_atendimento),1,50)
	from	hd_dialise
	where	trunc(dt_dialise,'dd') = trunc(dt_atual_w,'dd')
	and	coalesce(dt_cancelamento::text, '') = ''
	and	(dt_fim_dialise IS NOT NULL AND dt_fim_dialise::text <> '')
	and	nr_seq_unid_dialise = nr_seq_unid_dialise_w;


BEGIN

dt_atual_w	:= trunc(dt_parametro_p,'dd');

select	trunc(months_between(dt_parametro_p,dt_parametro_p) + 1)
into STRICT	qt_mes_atual_w
;

delete  from eis_dialise
where	dt_referencia = dt_atual_w;

open C01;
loop
fetch C01 into
	nr_seq_unid_dialise_w,
	cd_empresa_w,
	cd_estabelecimento_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
begin
select  max(nr_seq_evento_pirogenia),
	max(nr_seq_tipo_evento)
into STRICT	nr_seq_evento_pirogenia_w,
	nr_tipo_evento_internacao_w
from	hd_parametro
where	cd_estabelecimento = HD_OBTER_ESTAB_UNIDADE(nr_seq_unid_dialise_w);

	open C02;
	loop
	fetch C02 into
		cd_pessoa_fisica_w,
		cd_cid_morte_w,
		nr_seq_dialisador_w,
		cd_convenio_w;
	EXIT WHEN NOT FOUND; /* apply on C02 */
	begin

		select 	count(*)
		into STRICT	qt_entrada_agudo_w
		from 	paciente_tratamento
		where	ie_tratamento in ('HD','PL','CH','CHD','CHDF','CHDI','PAF','SCUF','SLED','DDC','IHF','IHDF')
		and	trunc(dt_inicio_tratamento,'dd') = trunc(dt_atual_w,'dd')
		and	ie_paciente_agudo = 'S'
		and	nr_seq_unid_dialise = nr_seq_unid_dialise_w
		and		cd_pessoa_fisica = cd_pessoa_fisica_w;

		select 	count(*)
		into STRICT	qt_entrada_cronico_w
		from 	paciente_tratamento
		where	ie_tratamento in ('HD','PL','CH','CHD','CHDF','CHDI','PAF','SCUF','SLED','DDC','IHF','IHDF')
		and	trunc(dt_inicio_tratamento,'dd') = trunc(dt_atual_w,'dd')
		and	ie_paciente_agudo = 'N'
		and	nr_seq_unid_dialise = nr_seq_unid_dialise_w
		and		cd_pessoa_fisica = cd_pessoa_fisica_w;

		select 	count(*)
		into STRICT	qt_obito_agudo_w
		from 	paciente_tratamento a,
			motivo_fim b
		where	a.nr_seq_motivo_fim = b.nr_sequencia
		and	a.ie_tratamento in ('HD','PL','CH','CHD','CHDF','CHDI','PAF','SCUF','SLED','DDC','IHF','IHDF')
		and	trunc(a.dt_final_tratamento,'dd') = trunc(dt_atual_w,'dd')
		and	a.ie_paciente_agudo = 'S'
		and	b.ie_tipo_tratamento = 'O'
		and	nr_seq_unid_dialise = nr_seq_unid_dialise_w
		and	a.cd_pessoa_fisica = cd_pessoa_fisica_w;

		select 	count(*)
		into STRICT	qt_obito_cro_menos_90_dias_w
		from 	paciente_tratamento a,
			motivo_fim b
		where	a.nr_seq_motivo_fim = b.nr_sequencia
		and	a.ie_tratamento in ('HD','PL','CH','CHD','CHDF','CHDI','PAF','SCUF','SLED','DDC','IHF','IHDF')
		and	trunc(a.dt_final_tratamento,'dd') = trunc(dt_atual_w,'dd')
		and	a.ie_paciente_agudo = 'N'
		and	b.ie_tipo_tratamento = 'O'
		and (clock_timestamp() - a.dt_inicio_tratamento) < 90
		and	nr_seq_unid_dialise = nr_seq_unid_dialise_w
		and	a.cd_pessoa_fisica = cd_pessoa_fisica_w;

		select 	count(*)
		into STRICT	qt_obito_cro_mais_90_dias_w
		from 	paciente_tratamento a,
			motivo_fim b
		where	a.nr_seq_motivo_fim = b.nr_sequencia
		and	a.ie_tratamento in ('HD','PL','CH','CHD','CHDF','CHDI','PAF','SCUF','SLED','DDC','IHF','IHDF')
		and	trunc(a.dt_final_tratamento,'dd') = trunc(dt_atual_w,'dd')
		and	a.ie_paciente_agudo = 'N'
		and	b.ie_tipo_tratamento = 'O'
		and (clock_timestamp() - a.dt_inicio_tratamento) >= 90
		and	nr_seq_unid_dialise = nr_seq_unid_dialise_w
		and	a.cd_pessoa_fisica = cd_pessoa_fisica_w;

		select	count(*)
		into STRICT	qt_saida_tx_w
		from	hd_pac_renal_cronico a,
			tx_receptor b
		where	a.cd_pessoa_fisica = b.cd_pessoa_fisica
		and	trunc(b.dt_transplante,'dd') = trunc(dt_atual_w,'dd')
		and	tx_obter_estab_receptor(b.nr_sequencia) = 		HD_OBTER_ESTAB_UNIDADE(nr_seq_unid_dialise_w)
		and	a.cd_pessoa_fisica = cd_pessoa_fisica_w;

		select 	count(*)
		into STRICT	qt_desistencia_w
		from 	paciente_tratamento a,
			motivo_fim b
		where	a.nr_seq_motivo_fim = b.nr_sequencia
		and	a.ie_tratamento in ('HD','PL','CH','CHD','CHDF','CHDI','PAF','SCUF','SLED','DDC','IHF','IHDF')
		and	trunc(a.dt_final_tratamento,'dd') = trunc(dt_atual_w,'dd')
		and	b.ie_tipo_tratamento = 'D'
		and	nr_seq_unid_dialise = nr_seq_unid_dialise_w
		and	a.cd_pessoa_fisica = cd_pessoa_fisica_w;

		select 	count(*)
		into STRICT	qt_transferencia_w
		from 	paciente_tratamento a,
			motivo_fim b
		where	a.nr_seq_motivo_fim = b.nr_sequencia
		and	a.ie_tratamento in ('HD','PL','CH','CHD','CHDF','CHDI','PAF','SCUF','SLED','DDC','IHF','IHDF')
		and	trunc(a.dt_final_tratamento,'dd') = trunc(dt_atual_w,'dd')
		and	b.ie_tipo_tratamento = 'TU'
		and	nr_seq_unid_dialise = nr_seq_unid_dialise_w
		and	a.cd_pessoa_fisica = cd_pessoa_fisica_w;

		select 	count(*)
		into STRICT	qt_hd_hp_w
		from 	paciente_tratamento a,
			motivo_fim b
		where	a.nr_seq_motivo_fim = b.nr_sequencia
		and	a.ie_tratamento in ('HD','PL','CH','CHD','CHDF','CHDI','PAF','SCUF','SLED','DDC','IHF','IHDF')
		and	trunc(a.dt_final_tratamento,'dd') = trunc(dt_atual_w,'dd')
		and	b.ie_tipo_tratamento = 'TDP'
		and	nr_seq_unid_dialise = nr_seq_unid_dialise_w
		and	a.cd_pessoa_fisica = cd_pessoa_fisica_w;

		select 	count(*)
		into STRICT	qt_alta_agudo_w
		from 	paciente_tratamento a,
			motivo_fim b
		where	a.nr_seq_motivo_fim = b.nr_sequencia
		and	a.ie_tratamento in ('HD','PL','CH','CHD','CHDF','CHDI','PAF','SCUF','SLED','DDC','IHF','IHDF')
		and	trunc(a.dt_final_tratamento,'dd') = trunc(dt_atual_w,'dd')
		and	a.ie_paciente_agudo = 'S'
		and	b.ie_tipo_tratamento = 'A'
		and	nr_seq_unid_dialise = nr_seq_unid_dialise_w
		and	a.cd_pessoa_fisica = cd_pessoa_fisica_w;

		select 	count(*)
		into STRICT	qt_alta_cronico_w
		from 	paciente_tratamento a,
			motivo_fim b
		where	a.nr_seq_motivo_fim = b.nr_sequencia
		and	a.ie_tratamento in ('HD','PL','CH','CHD','CHDF','CHDI','PAF','SCUF','SLED','DDC','IHF','IHDF')
		and	trunc(a.dt_final_tratamento,'dd') = trunc(dt_atual_w,'dd')
		and	a.ie_paciente_agudo = 'N'
		and	b.ie_tipo_tratamento = 'A'
		and	nr_seq_unid_dialise = nr_seq_unid_dialise_w
		and	a.cd_pessoa_fisica = cd_pessoa_fisica_w;

		select 	count(*)
		into STRICT	qt_fim_dia_agudo_w
		from 	paciente_tratamento
		where	ie_tratamento in ('HD','PL','CH','CHD','CHDF','CHDI','PAF','SCUF','SLED','DDC','IHF','IHDF')
		and	ie_paciente_agudo = 'S'
		and	((trunc(dt_final_tratamento) >= trunc(dt_atual_w)) or (coalesce(dt_final_tratamento::text, '') = ''))
		and (trunc(dt_inicio_tratamento) <= trunc(dt_atual_w))
		and	nr_seq_unid_dialise = nr_seq_unid_dialise_w
		and	cd_pessoa_fisica = cd_pessoa_fisica_w;

		select 	count(*)
		into STRICT	qt_fim_dia_cronico_w
		from 	paciente_tratamento
		where	ie_tratamento in ('HD','PL','CH','CHD','CHDF','CHDI','PAF','SCUF','SLED','DDC','IHF','IHDF')
		and	ie_paciente_agudo = 'N'
		and	((trunc(dt_final_tratamento) >= trunc(dt_atual_w)) or (coalesce(dt_final_tratamento::text, '') = ''))
		and (trunc(dt_inicio_tratamento) <= trunc(dt_atual_w))
		and	nr_seq_unid_dialise = nr_seq_unid_dialise_w
		and	cd_pessoa_fisica = cd_pessoa_fisica_w;

		select	count(*)
		into STRICT	qt_pac_transito_w
		from	hd_pac_renal_cronico a,
			paciente_tratamento b
		where	a.cd_pessoa_fisica = b.cd_pessoa_fisica
		and	b.nr_seq_unid_dialise <> hd_obter_unid_dialise_data(a.cd_pessoa_fisica,dt_atual_w)
		and	b.ie_tratamento in ('HD','PL','CH','CHD','CHDF','CHDI','PAF','SCUF','SLED','DDC','IHF','IHDF')
		and	((trunc(b.dt_final_tratamento) >= trunc(dt_atual_w)) or (coalesce(b.dt_final_tratamento::text, '') = ''))
		and (trunc(b.dt_inicio_tratamento) <= trunc(dt_atual_w))
		and	b.nr_seq_unid_dialise = nr_seq_unid_dialise_w
		and	b.cd_pessoa_fisica = cd_pessoa_fisica_w;

		select 	count(*)
		into STRICT	qt_sessoes_dialise_w
		from 	hd_dialise
		where	trunc(dt_dialise,'dd') = trunc(dt_atual_w,'dd')
		and	coalesce(dt_cancelamento::text, '') = ''
		and	(dt_fim_dialise IS NOT NULL AND dt_fim_dialise::text <> '')
		and	nr_seq_unid_dialise = nr_seq_unid_dialise_w
		and	cd_pessoa_fisica	= cd_pessoa_fisica_w;

		select 	count(*)
		into STRICT	qt_sessoes_dialise_agudo_w
		from 	hd_dialise
		where	trunc(dt_dialise,'dd') = trunc(dt_atual_w,'dd')
		and	coalesce(dt_cancelamento::text, '') = ''
		and	(dt_fim_dialise IS NOT NULL AND dt_fim_dialise::text <> '')
		and	hd_obter_se_trat_ativo_agudo(cd_pessoa_fisica,dt_atual_w) = 'S'
		and	nr_seq_unid_dialise = nr_seq_unid_dialise_w
		and	cd_pessoa_fisica	= cd_pessoa_fisica_w;

		select 	count(*)
		into STRICT	qt_sessoes_dialise_cronico_w
		from 	hd_dialise
		where	trunc(dt_dialise,'dd') = trunc(dt_atual_w,'dd')
		and	coalesce(dt_cancelamento::text, '') = ''
		and	(dt_fim_dialise IS NOT NULL AND dt_fim_dialise::text <> '')
		and	hd_obter_se_trat_ativo_agudo(cd_pessoa_fisica,dt_atual_w) = 'N'
		and	nr_seq_unid_dialise = nr_seq_unid_dialise_w
		and	cd_pessoa_fisica	= cd_pessoa_fisica_w;

		select	count(distinct b.cd_pessoa_fisica) --671881
		into STRICT	qt_pac_diabeticos_w
		from	hd_pac_renal_cronico a,
			paciente_tratamento b
		where	a.cd_pessoa_fisica = b.cd_pessoa_fisica
		and	b.ie_tratamento in ('HD','PL','CH','CHD','CHDF','CHDI','PAF','SCUF','SLED','DDC','IHF','IHDF')
		and	a.ie_diabetico = 'S'
		and	((trunc(b.dt_final_tratamento) >= trunc(dt_atual_w)) or (coalesce(b.dt_final_tratamento::text, '') = ''))
		and (trunc(b.dt_inicio_tratamento) <= trunc(dt_atual_w))
		and	hd_obter_se_pac_ativo_data(a.cd_pessoa_fisica,dt_atual_w) = 'S'
		and	coalesce(hd_obter_unidade_prc(a.cd_pessoa_fisica,'C'),a.nr_seq_unid_dialise) = nr_seq_unid_dialise_w
		and	b.cd_pessoa_fisica = cd_pessoa_fisica_w;

		select 	count(*)
		into STRICT	qt_acesso_adequado_w
		from	hd_acesso a,
			hd_tecnica_acesso b,
			hd_pac_renal_cronico c
		where	a.nr_seq_tecnica = b.nr_sequencia
		and	c.cd_pessoa_fisica = a.cd_pessoa_fisica
		and	b.ie_tipo_acesso = 'FAV'
		and	ie_adequado = 'S'
		and (trunc(dt_instalacao) <= trunc(dt_atual_w))
		and	((trunc(dt_perda_retirada) >= trunc(dt_atual_w)) or (coalesce(dt_perda_retirada::text, '') = ''))
		and	hd_obter_se_pac_ativo_data(a.cd_pessoa_fisica,dt_atual_w) = 'S'
		and	hd_obter_unid_dialise_data(a.cd_pessoa_fisica,dt_atual_w) = nr_seq_unid_dialise_w
		and	c.cd_pessoa_fisica = cd_pessoa_fisica_w;

		select 	count(*)
		into STRICT	qt_acesso_inadequado_w
		from	hd_acesso a,
			hd_tecnica_acesso b,
			hd_pac_renal_cronico c
		where	a.nr_seq_tecnica = b.nr_sequencia
		and	c.cd_pessoa_fisica = a.cd_pessoa_fisica
		and	b.ie_tipo_acesso = 'FAV'
		and	ie_adequado = 'N'
		and (trunc(dt_instalacao) <= trunc(dt_atual_w))
		and	((trunc(dt_perda_retirada) >= trunc(dt_atual_w)) or (coalesce(dt_perda_retirada::text, '') = ''))
		and	hd_obter_se_pac_ativo_data(a.cd_pessoa_fisica,dt_atual_w) = 'S'
		and	hd_obter_unid_dialise_data(a.cd_pessoa_fisica,dt_atual_w) = nr_seq_unid_dialise_w
		and	c.cd_pessoa_fisica = cd_pessoa_fisica_w;

		select 	count(*)
		into STRICT	qt_acesso_dl_w
		from	hd_acesso a,
			hd_tecnica_acesso b,
			hd_pac_renal_cronico c
		where	a.nr_seq_tecnica = b.nr_sequencia
		and	c.cd_pessoa_fisica = a.cd_pessoa_fisica
		and	b.ie_tipo_acesso = 'DL'
		and (trunc(dt_instalacao) <= trunc(dt_atual_w))
		and	((trunc(dt_perda_retirada) >= trunc(dt_atual_w)) or (coalesce(dt_perda_retirada::text, '') = ''))
		and	hd_obter_se_pac_ativo_data(a.cd_pessoa_fisica,dt_atual_w) = 'S'
		and	hd_obter_unid_dialise_data(a.cd_pessoa_fisica,dt_atual_w) = nr_seq_unid_dialise_w
		and	c.cd_pessoa_fisica = cd_pessoa_fisica_w;

		select 	count(*)
		into STRICT	qt_acesso_permcath_w
		from	hd_acesso a,
			hd_tecnica_acesso b,
			hd_pac_renal_cronico c
		where	a.nr_seq_tecnica = b.nr_sequencia
		and	c.cd_pessoa_fisica = a.cd_pessoa_fisica
		and	b.ie_tipo_acesso = 'PE'
		and (trunc(dt_instalacao) <= trunc(dt_atual_w))
		and	((trunc(dt_perda_retirada) >= trunc(dt_atual_w)) or (coalesce(dt_perda_retirada::text, '') = ''))
		and	hd_obter_se_pac_ativo_data(a.cd_pessoa_fisica,dt_atual_w) = 'S'
		and	hd_obter_unid_dialise_data(a.cd_pessoa_fisica,dt_atual_w) = nr_seq_unid_dialise_w
		and	c.cd_pessoa_fisica = cd_pessoa_fisica_w;

		select 	count(*)
		into STRICT	qt_acesso_protese_w
		from	hd_acesso a,
			hd_tecnica_acesso b,
			hd_pac_renal_cronico c
		where	a.nr_seq_tecnica = b.nr_sequencia
		and	c.cd_pessoa_fisica = a.cd_pessoa_fisica
		and	b.ie_tipo_acesso = 'PR'
		and (trunc(dt_instalacao) <= trunc(dt_atual_w))
		and	((trunc(dt_perda_retirada) >= trunc(dt_atual_w)) or (coalesce(dt_perda_retirada::text, '') = ''))
		and	hd_obter_se_pac_ativo_data(a.cd_pessoa_fisica,dt_atual_w) = 'S'
		and	hd_obter_unid_dialise_data(a.cd_pessoa_fisica,dt_atual_w) = nr_seq_unid_dialise_w
		and	c.cd_pessoa_fisica = cd_pessoa_fisica_w;

		select 	count(*)
		into STRICT	qt_perdas_acessos_w
		from	hd_acesso a,
			hd_tecnica_acesso b,
			hd_pac_renal_cronico c
		where	a.nr_seq_tecnica = b.nr_sequencia
		and	c.cd_pessoa_fisica = a.cd_pessoa_fisica
		and	b.ie_tipo_acesso = 'FAV'
		and (trunc(dt_perda_retirada,'dd') >= trunc(dt_atual_w,'dd'))
		and	hd_obter_unid_dialise_data(a.cd_pessoa_fisica,dt_atual_w) = nr_seq_unid_dialise_w
		and	c.cd_pessoa_fisica = cd_pessoa_fisica_w;

		select 	count(*)
		into STRICT	qt_perdas_dl_w
		from	hd_acesso a,
			hd_tecnica_acesso b,
			hd_pac_renal_cronico c
		where	a.nr_seq_tecnica = b.nr_sequencia
		and	c.cd_pessoa_fisica = a.cd_pessoa_fisica
		and	b.ie_tipo_acesso = 'DL'
		and (trunc(dt_perda_retirada,'dd') >= trunc(dt_atual_w,'dd'))
		and	hd_obter_unid_dialise_data(a.cd_pessoa_fisica,dt_atual_w) = nr_seq_unid_dialise_w
		and	c.cd_pessoa_fisica = cd_pessoa_fisica_w;

		select 	count(*)
		into STRICT	qt_perdas_permcath_w
		from	hd_acesso a,
			hd_tecnica_acesso b,
			hd_pac_renal_cronico c
		where	a.nr_seq_tecnica = b.nr_sequencia
		and	c.cd_pessoa_fisica = a.cd_pessoa_fisica
		and	b.ie_tipo_acesso = 'PE'
		and (trunc(dt_perda_retirada,'dd') >= trunc(dt_atual_w,'dd'))
		and	hd_obter_unid_dialise_data(a.cd_pessoa_fisica,dt_atual_w) = nr_seq_unid_dialise_w
		and	c.cd_pessoa_fisica = cd_pessoa_fisica_w;


		select 	count(*)
		into STRICT	qt_acessos_realizados_w
		from	hd_acesso a,
			hd_tecnica_acesso b,
			hd_pac_renal_cronico c
		where	a.nr_seq_tecnica = b.nr_sequencia
		and	c.cd_pessoa_fisica = a.cd_pessoa_fisica
		and	b.ie_tipo_acesso = 'FAV'
		and (trunc(dt_instalacao,'dd') >= trunc(dt_atual_w,'dd'))
		and	hd_obter_unid_dialise_data(a.cd_pessoa_fisica,dt_atual_w) = nr_seq_unid_dialise_w
		and	c.cd_pessoa_fisica = cd_pessoa_fisica_w;

		select 	count(*)
		into STRICT	qt_novos_cateter_dl_w
		from	hd_acesso a,
			hd_tecnica_acesso b,
			hd_pac_renal_cronico c
		where	a.nr_seq_tecnica = b.nr_sequencia
		and	c.cd_pessoa_fisica = a.cd_pessoa_fisica
		and	b.ie_tipo_acesso = 'DL'
		and (trunc(dt_instalacao,'dd') >= trunc(dt_atual_w,'dd'))
		and	hd_obter_unid_dialise_data(a.cd_pessoa_fisica,dt_atual_w) = nr_seq_unid_dialise_w
		and	c.cd_pessoa_fisica = cd_pessoa_fisica_w;

		select 	count(*)
		into STRICT	qt_novos_permcath_w
		from	hd_acesso a,
			hd_tecnica_acesso b,
			hd_pac_renal_cronico c
		where	a.nr_seq_tecnica = b.nr_sequencia
		and	c.cd_pessoa_fisica = a.cd_pessoa_fisica
		and	b.ie_tipo_acesso = 'PE'
		and (trunc(dt_instalacao,'dd') >= trunc(dt_atual_w,'dd'))
		and	hd_obter_unid_dialise_data(a.cd_pessoa_fisica,dt_atual_w) = nr_seq_unid_dialise_w
		and	c.cd_pessoa_fisica = cd_pessoa_fisica_w;

		select	count(*)
		into STRICT	qt_pirogenia_w
		from	HD_DIALISE_EVENTO a,
			hd_dialise b
		where	a.nr_seq_dialise = b.nr_sequencia
		and	NR_SEQ_TIPO_EVENTO = nr_seq_evento_pirogenia_w
		and	trunc(dt_dialise,'dd') = trunc(dt_atual_w,'dd')
		and	coalesce(b.dt_cancelamento::text, '') = ''
		and	(b.dt_fim_dialise IS NOT NULL AND b.dt_fim_dialise::text <> '')
		and	b.nr_seq_unid_dialise = nr_seq_unid_dialise_w
		and	b.cd_pessoa_fisica	= cd_pessoa_fisica_w;

		select 	count(*)
		into STRICT	qt_transfusoes_w
		from	prescr_procedimento a,
			prescr_medica b
		where	a.nr_prescricao = b.nr_prescricao
		and	trunc(dt_prescricao,'dd') = trunc(dt_atual_w,'dd')
		and	(nr_seq_derivado IS NOT NULL AND nr_seq_derivado::text <> '')
		and	ie_suspenso = 'N'
		and	(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
		and	cd_estabelecimento = HD_OBTER_ESTAB_UNIDADE(nr_seq_unid_dialise_w)
		and	b.cd_pessoa_fisica	= cd_pessoa_fisica_w;

		select 	count(*)
		into STRICT	qt_culturas_w
		from	prescr_procedimento a,
			prescr_medica b,
			exame_laboratorio c
		where	a.nr_prescricao 		= b.nr_prescricao
		and	a.nr_seq_exame			= c.nr_seq_exame
		and	trunc(dt_prescricao,'dd') 	= trunc(dt_atual_w,'dd')
		and	(a.nr_seq_exame IS NOT NULL AND a.nr_seq_exame::text <> '')
		and	ie_suspenso = 'N'
		and	ie_formato_resultado in ('SDM','SM')
		and	(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
		and	b.cd_estabelecimento = HD_OBTER_ESTAB_UNIDADE(nr_seq_unid_dialise_w)
		and	b.cd_pessoa_fisica	= cd_pessoa_fisica_w;
		
		select	max(CASE WHEN hd_pac_possui_trat_pend(cd_pessoa_fisica_w)='N' THEN  null  ELSE coalesce(hd_obter_unidade_prc(cd_pessoa_fisica_w,'C'),nr_seq_unid_dialise_w) END )
		into STRICT	nr_seq_unid_dialise_atual_w
		;

		qt_pressao_alta_pre_w	:= 0;
		qt_pressao_alta_pos_w	:= 0;
		
		
			
			vl_pressao_pres_med_w	:=	round(((hd_obter_media_pressao_data(cd_pessoa_fisica_w,trunc(dt_atual_w,'month'),dt_atual_w,HD_OBTER_ESTAB_UNIDADE(nr_seq_unid_dialise_w),nr_seq_unid_dialise_w,'PRES'))::numeric )::numeric,2);
			vl_pressao_pred_med_w	:=	round(((hd_obter_media_pressao_data(cd_pessoa_fisica_w,trunc(dt_atual_w,'month'),dt_atual_w,HD_OBTER_ESTAB_UNIDADE(nr_seq_unid_dialise_w),nr_seq_unid_dialise_w,'PRED'))::numeric )::numeric,2);
			vl_pressao_poss_med_w	:=	round(((hd_obter_media_pressao_data(cd_pessoa_fisica_w,trunc(dt_atual_w,'month'),dt_atual_w,HD_OBTER_ESTAB_UNIDADE(nr_seq_unid_dialise_w),nr_seq_unid_dialise_w,'PROS'))::numeric )::numeric,2);
			vl_pressao_posd_med_w	:=	round(((hd_obter_media_pressao_data(cd_pessoa_fisica_w,trunc(dt_atual_w,'month'),dt_atual_w,HD_OBTER_ESTAB_UNIDADE(nr_seq_unid_dialise_w),nr_seq_unid_dialise_w,'PROD'))::numeric )::numeric,2);

			if (vl_pressao_pres_med_w > 140) or (vl_pressao_pred_med_w > 90) then
				qt_pressao_alta_pre_w	:= qt_pressao_alta_pre_w + 1;
			end if;

			if (vl_pressao_poss_med_w > 140) or (vl_pressao_posd_med_w > 90) then
				qt_pressao_alta_pos_w	:= qt_pressao_alta_pos_w + 1;
			end if;

		
	

			select	count(*)
			into STRICT	qt_internados_w
			from	QUA_EVENTO_PACIENTE a,
				atendimento_paciente b,
				qua_evento c
			where	a.nr_atendimento = b.nr_atendimento
			and	a.nr_seq_evento = c.nr_sequencia
			and	hd_obter_se_pac_ativo_data(b.cd_pessoa_fisica,dt_atual_w) = 'S'
			and	nr_seq_tipo = nr_tipo_evento_internacao_w
			and	trunc(dt_evento,'dd') = trunc(dt_atual_w,'dd')
			and	hd_obter_unid_dialise_data(b.cd_pessoa_fisica,dt_atual_w) = nr_seq_unid_dialise_w
			and	coalesce(ie_tipo_evento,'E') = 'E'
			and b.cd_pessoa_fisica = cd_pessoa_fisica_w;
			
			
			select	count(*)
			into STRICT	qt_hipertensos_w
			from	hd_pac_renal_cronico
			where	cd_pessoa_fisica = cd_pessoa_fisica_w
			and	ie_hipertenso = 'S'
			and	nr_seq_unid_dialise = nr_seq_unid_dialise_w;

		insert into eis_dialise(
				dt_atualizacao,
				nm_usuario,
				dt_atualizacao_nrec,
				nm_usuario_nrec,
				dt_referencia,
				nr_seq_unid_dialise,
				qt_entrada_agudo,
				qt_entrada_cronico,
				qt_obito_agudo,
				qt_obito_cronico_menos_90_dias,
				qt_obito_cronico_mais_90_dias,
				qt_saida_tx,
				qt_desistencia,
				qt_transferencia,
				qt_hd_hp,
				qt_alta_cronico,
				qt_alta_agudo,
				qt_agudos_fim_dia,
				qt_cronicos_fim_dia,
				qt_pac_transito,
				qt_sessoes_dialise,
				qt_acesso_adequado,
				qt_acesso_inadequado,
				qt_cateter_dl,
				qt_permcath,
				qt_protese,
				qt_acessos_realizados,
				qt_pressao_alta_pre,
				qt_pressao_alta_pos,
				qt_transfusoes,
				qt_culturas,
				qt_perdas_acessos,
				qt_perdas_dl,
				qt_perdas_permcath,
				qt_novos_cateter_dl,
				qt_novos_permcatch,
				qt_pirogenia,
				qt_internados,
				qt_pac_diabeticos,
				--qt_cronicos_fim_mes_ant,

				--qt_agudos_fim_mes_ant,
				qt_mes_atual,
				cd_cid_direta,
				qt_sessoes_dialise_agudo,
				qt_sessoes_dialise_cronico,
				cd_estabelecimento,
				cd_pessoa_fisica,
				cd_empresa,
				nr_seq_dialisador,
				cd_convenio,
				nr_seq_unid_dialise_atual,
				qt_hipertenso)
			values (	clock_timestamp(),
				nm_usuario_p,
				clock_timestamp(),
				nm_usuario_p,
				dt_atual_w,
				nr_seq_unid_dialise_w,
				qt_entrada_agudo_w,
				qt_entrada_cronico_w,
				qt_obito_agudo_w,
				qt_obito_cro_menos_90_dias_w,
				qt_obito_cro_mais_90_dias_w,
				qt_saida_tx_w,
				qt_desistencia_w,
				qt_transferencia_w,
				qt_hd_hp_w,
				qt_alta_cronico_w,
				qt_alta_agudo_w,
				qt_fim_dia_agudo_w,
				qt_fim_dia_cronico_w,
				qt_pac_transito_w,
				qt_sessoes_dialise_w,
				qt_acesso_adequado_w,
				qt_acesso_inadequado_w,
				qt_acesso_dl_w,
				qt_acesso_permcath_w,
				qt_acesso_protese_w,
				qt_acessos_realizados_w,
				qt_pressao_alta_pre_w,
				qt_pressao_alta_pos_w,
				qt_transfusoes_w,
				qt_culturas_w,
				qt_perdas_acessos_w,
				qt_perdas_dl_w,
				qt_perdas_permcath_w,
				qt_novos_cateter_dl_w,
				qt_novos_permcath_w,
				qt_pirogenia_w,
				qt_internados_w,
				qt_pac_diabeticos_w,
				--qt_cronicos_fim_mes_ant_w,

				--qt_agudos_fim_mes_ant_w,
				qt_mes_atual_w,
				cd_cid_morte_w,
				qt_sessoes_dialise_agudo_w,
				qt_sessoes_dialise_cronico_w,
				cd_estabelecimento_w,
				cd_pessoa_fisica_w,
				cd_empresa_w,
				nr_seq_dialisador_w,
				cd_convenio_w,
				nr_seq_unid_dialise_atual_w,
				qt_hipertensos_w);
		end;
	end loop;
close C02;	
	end;
end loop;
close C01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eis_gerar_dialise (dt_parametro_p timestamp, nm_usuario_p text) FROM PUBLIC;

