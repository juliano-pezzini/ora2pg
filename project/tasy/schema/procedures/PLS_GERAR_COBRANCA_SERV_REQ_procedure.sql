-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_gerar_cobranca_serv_req ( nr_seq_cobranca_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) AS $body$
DECLARE


nr_seq_segurado_w		bigint;
vl_procedimento_w		double precision;
vl_material_w			double precision;
vl_cobranca_w			double precision;
nr_titulo_w			bigint;
nr_seq_requisicao_w		bigint;
nr_nota_fiscal_w		varchar(255);
nr_seq_trans_fin_baixa_w	pls_param_requisicao.nr_seq_trans_fin_baixa%type;
nr_seq_trans_fin_contab_w	pls_param_requisicao.nr_seq_trans_fin_contab%type;
nr_seq_trans_fin_baixa_ww	parametro_contas_receber.nr_seq_trans_fin_baixa%type;
nr_seq_trans_fin_contab_ww	parametro_contas_receber.nr_seq_trans_fin_contab%type;


BEGIN

CALL pls_gerar_nota_cobran_prev(nr_seq_cobranca_p,cd_estabelecimento_p,nm_usuario_p);

CALL pls_gerar_titulo_cobran_prev(nr_seq_cobranca_p, cd_estabelecimento_p, nm_usuario_p);

update	pls_cobranca_previa_serv
set	ie_situacao	= 'A'
where	nr_sequencia	= nr_seq_cobranca_p;

select	coalesce(nr_seq_requisicao,0)
into STRICT	nr_seq_requisicao_w
from	pls_cobranca_previa_serv
where	nr_sequencia	= nr_seq_cobranca_p;

begin
	select	nr_nota_fiscal
	into STRICT	nr_nota_fiscal_w
	from	nota_fiscal
	where	nr_seq_cob_previa	= nr_seq_cobranca_p;
exception
when others then
	nr_nota_fiscal_w	:= '0';
end;

begin
	select	nr_titulo
	into STRICT	nr_titulo_w
	from	titulo_receber
	where	nr_seq_cob_previa	= nr_seq_cobranca_p;
exception
when others then
	nr_titulo_w	:= 0;
end;

select	nr_seq_trans_fin_baixa,
	nr_seq_trans_fin_contab
into STRICT	nr_seq_trans_fin_baixa_w,
	nr_seq_trans_fin_contab_w
from	pls_param_requisicao
where	cd_estabelecimento = cd_estabelecimento_p;

select	nr_seq_trans_fin_baixa,
	nr_seq_trans_fin_contab
into STRICT	nr_seq_trans_fin_baixa_ww,
	nr_seq_trans_fin_contab_ww
from	parametro_contas_receber
where	cd_estabelecimento = cd_estabelecimento_p;


if (nr_nota_fiscal_w <> '0') and (nr_titulo_w <> 0) then
	update	titulo_receber
	set	nr_nota_fiscal 		= nr_nota_fiscal_w,
		ds_observacao_titulo 	= 'Título gerado através da requisição ' || nr_seq_requisicao_w || '.',
		nr_seq_trans_fin_contab	= coalesce(nr_seq_trans_fin_contab_w, nr_seq_trans_fin_contab_ww),
		nr_seq_trans_fin_baixa	= coalesce(nr_seq_trans_fin_baixa_w, nr_seq_trans_fin_baixa_ww)
	where	nr_titulo		= nr_titulo_w;
end if;

if (nr_seq_requisicao_w	<> 0) then
	CALL pls_requisicao_gravar_hist(	nr_seq_requisicao_w,'L',
					'Gerada cobrança prévia dos itens. Nota Fiscal nº '||nr_nota_fiscal_w||' e Título nº '||nr_titulo_w||'. Aguardando baixa.',
					null,nm_usuario_p);
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_gerar_cobranca_serv_req ( nr_seq_cobranca_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) FROM PUBLIC;

