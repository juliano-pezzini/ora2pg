-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE calcular_perda_ganho_acum ( nr_sequencia_p bigint) AS $body$
DECLARE


dt_medida_w			timestamp;
nr_atendimento_w		bigint;
nr_sequencia_w			bigint;
qt_ganho_acum_w			double precision := 0;
qt_perda_acum_w			double precision := 0;
nr_seq_tipo_w			bigint;
qt_volume_w			double precision;
ie_perda_ganho_w		varchar(1);

c01 CURSOR FOR
	SELECT	c.nr_sequencia,
		c.nr_seq_tipo,
		c.qt_volume,
		a.ie_perda_ganho
	from	atendimento_perda_ganho c,
		tipo_perda_ganho b,
		grupo_perda_ganho a
	where	c.nr_atendimento = nr_atendimento_w
	and	b.nr_sequencia = c.nr_seq_tipo
	and	b.nr_seq_grupo = a.nr_sequencia
	and	coalesce(b.ie_soma_bh,'S')	= 'S'
	and	trunc(c.dt_medida) = trunc(dt_medida_w)
	and	coalesce(c.ie_situacao,'A') = 'A'
	order by c.dt_medida;


BEGIN

select	dt_medida,
	nr_atendimento
into STRICT	dt_medida_w,
	nr_atendimento_w
from	atendimento_perda_ganho
where	nr_sequencia = nr_sequencia_p;

/*

OPEN C01;
LOOP
FETCH C01 into
		nr_sequencia_w,
		nr_seq_tipo_w,
		qt_volume_w,
		ie_perda_ganho_w;
exit when c01%notfound;

	if	(ie_perda_ganho_w = 'G') then
		qt_ganho_acum_w := qt_ganho_acum_w + qt_volume_w;
	elsif	(ie_perda_ganho_w = 'P') then
		qt_perda_acum_w := qt_perda_acum_w + qt_volume_w;
	end if;
	update	atendimento_perda_ganho
	set	qt_ganho_acum	= qt_ganho_acum_w,
		qt_perda_acum	= qt_perda_acum_w,
		qt_diferenca	= qt_ganho_acum_w - qt_perda_acum_w
	where	nr_sequencia	= nr_sequencia_w;

END LOOP;
Close C01;

commit;  */
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE calcular_perda_ganho_acum ( nr_sequencia_p bigint) FROM PUBLIC;

