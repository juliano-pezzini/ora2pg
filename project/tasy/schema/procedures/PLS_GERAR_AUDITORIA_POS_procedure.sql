-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_gerar_auditoria_pos ( nr_seq_analise_p bigint, nr_seq_ocorrencia_p bigint, ie_reconsistencia_p text, cd_estabelecimento_p bigint, nm_usuario_p text ) AS $body$
DECLARE


dt_procedimento_w		timestamp;
dt_material_w			timestamp;				
				
nr_seq_conta_w			bigint;
nr_seq_conta_proc_w		bigint;
nr_seq_conta_mat_w		bigint;
nr_seq_segurado_w		bigint;
nr_seq_prestador_exec_w		bigint;
nr_seq_tipo_atendimento_w	bigint;
nr_seq_plano_w			bigint;
nr_seq_congenere_w		bigint;
nr_seq_protocolo_w		bigint;
nr_seq_prestador_w		bigint;
cd_procedimento_w		bigint;
ie_origem_proced_w		bigint;
nr_seq_material_w		bigint;
nr_seq_analise_w		bigint;
qt_itens_pendentes_w		bigint;
nr_seq_analise_ww		bigint;

ie_gerar_analise_audit_w	varchar(1);
ie_tipo_guia_w			varchar(2);
ie_origem_conta_w		varchar(5);
ie_conta_intercambio_w		varchar(10);
nr_seq_conta_pos_w		bigint;

ie_geracao_pos_estab_w		varchar(1);
ie_novo_pos_estab_w		pls_visible_false.ie_novo_pos_estab%type;
ds_observacao_w			pls_hist_analise_conta.ds_observacao%type;

C01 CURSOR FOR
	SELECT	x.nr_seq_analise
	from	pls_conta a,
		pls_conta_pos_estabelecido x
	where	x.nr_seq_conta		= a.nr_sequencia
	and	a.nr_seq_analise 	= nr_seq_analise_p
	and	(x.nr_seq_analise IS NOT NULL AND x.nr_seq_analise::text <> '')
	and	((x.ie_situacao	= 'A') or (coalesce(x.ie_situacao::text, '') = ''))
	group by x.nr_seq_analise
	order by 1;
	
C02 CURSOR(	nr_seq_analise_pc	pls_analise_conta.nr_sequencia%type) FOR
	SELECT	nr_seq_analise
	from (
		SELECT	a.nr_seq_analise
		from	pls_conta_pos_proc a,
			pls_conta b
		where	b.nr_sequencia = a.nr_seq_conta
		and	b.nr_seq_analise = nr_seq_analise_pc
		and	(a.nr_seq_analise IS NOT NULL AND a.nr_seq_analise::text <> '')
		
union all

		select	a.nr_seq_analise
		from	pls_conta_pos_mat a,
			pls_conta b
		where	b.nr_sequencia = a.nr_seq_conta
		and	b.nr_seq_analise = nr_seq_analise_pc
		and	(a.nr_seq_analise IS NOT NULL AND a.nr_seq_analise::text <> '')) alias3
	group by nr_seq_analise;
	
BEGIN

select	coalesce(max(ie_novo_pos_estab),'N')
into STRICT	ie_novo_pos_estab_w
from	pls_visible_false;

select	coalesce(max(ie_geracao_pos_estabelecido),'F')
into STRICT	ie_geracao_pos_estab_w
from	pls_parametros
where	cd_estabelecimento = cd_estabelecimento_p;

if (ie_geracao_pos_estab_w <> 'F') then
	/*Diego OS 435733 - Sera atualizado o faturamento de pos para pendente para que a modificacao ocorrida na pls_fechar_conta atualizando o status_fat para 'L' nao interfira no processo de analise*/

	update	pls_conta
	set	ie_status_fat 	= 'P'
	where	nr_seq_analise  = nr_seq_analise_p
	and	ie_status_fat <> 'N';
end if;

if (ie_novo_pos_estab_w = 'N') then
	for r_c01_w in C01() loop
		begin
		
		CALL pls_atualizar_grupo_penden(r_c01_w.nr_seq_analise, cd_estabelecimento_p, nm_usuario_p);

		select	count(1)
		into STRICT	qt_itens_pendentes_w
		from	pls_analise_glo_ocor_grupo	b,
			pls_ocorrencia_benef		c,
			pls_conta_pos_estabelecido	a
		where	a.nr_sequencia		= c.nr_seq_conta_pos_estab
		and	c.nr_sequencia		= b.nr_seq_ocor_benef
		and	a.nr_seq_analise	= r_c01_w.nr_seq_analise
		and	b.ie_status	 	= 'P'
		and	((a.ie_situacao	= 'A') or (coalesce(a.ie_situacao::text, '') = ''));

		
		

		if (qt_itens_pendentes_w = 0) then
			/*Se nao existir itens pendentes pode fechar a analise de pos. */

			CALL pls_fechar_conta_pos_estab(r_c01_w.nr_seq_analise , nm_usuario_p, cd_estabelecimento_p,'N', 'S');
			update	pls_conta
			set	ie_status_fat 	= 'L'
			where	nr_seq_analise  = nr_seq_analise_p;
		else
		
			ds_observacao_w := 'Quantidade de itens pendentes = '||qt_itens_pendentes_w;
		
			insert into pls_hist_analise_conta(	ds_observacao,dt_atualizacao, dt_atualizacao_nrec,
						ie_tipo_historico, ie_tipo_item, nm_usuario,
						nm_usuario_nrec, nr_seq_analise, nr_seq_conta,
						nr_seq_conta_glosa, nr_seq_conta_mat, nr_seq_conta_proc,
						nr_seq_glosa, nr_seq_grupo, nr_seq_item,nr_seq_ocor_benef,
						nr_seq_ocorrencia, nr_seq_proc_partic, nr_sequencia,
						ds_call_stack)
				values (	ds_observacao_w ,clock_timestamp(),clock_timestamp(),
						'10',null, nm_usuario_p,
						nm_usuario_p,r_c01_w.nr_seq_analise,null,
						null,null,null,
						null, null,null,null,
						null,null,nextval('pls_hist_analise_conta_seq'),
						'PLS_GERAR_AUDITORIA_POS');
		
		end if;
		
		end;
	end loop;
else
	for r_C02_w in C02(nr_seq_analise_p) loop
		
		CALL pls_atualizar_grupo_penden(r_C02_w.nr_seq_analise, cd_estabelecimento_p, nm_usuario_p);
		
		select	sum(qt_itens)
		into STRICT	qt_itens_pendentes_w
		from (
			SELECT	count(1) qt_itens
			from	pls_conta_pos_proc a,
				pls_ocorrencia_benef b,
				pls_analise_glo_ocor_grupo c
			where	a.nr_sequencia = b.nr_seq_conta_pos_proc
			and	b.nr_sequencia = c.nr_seq_ocor_benef
			and	a.nr_seq_analise = r_C02_w.nr_seq_analise
			and	c.ie_status = 'P'
			
union all

			SELECT	count(1) qt_itens
			from	pls_conta_pos_mat a,
				pls_ocorrencia_benef b,
				pls_analise_glo_ocor_grupo c
			where	a.nr_sequencia = b.nr_seq_conta_pos_mat
			and	b.nr_sequencia = c.nr_seq_ocor_benef
			and	a.nr_seq_analise = r_C02_w.nr_seq_analise
			and	c.ie_status = 'P') alias3;
		
		if (qt_itens_pendentes_w = 0) then
			/*Se nao existir itens pendentes pode fechar a analise de pos. */

			CALL pls_fechar_conta_pos_estab(r_C02_w.nr_seq_analise , nm_usuario_p, cd_estabelecimento_p,'N', 'S');
			update	pls_conta
			set	ie_status_fat 	= 'L'
			where	nr_seq_analise  = nr_seq_analise_p;
		end if;
	end loop;
end if;


end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_gerar_auditoria_pos ( nr_seq_analise_p bigint, nr_seq_ocorrencia_p bigint, ie_reconsistencia_p text, cd_estabelecimento_p bigint, nm_usuario_p text ) FROM PUBLIC;

