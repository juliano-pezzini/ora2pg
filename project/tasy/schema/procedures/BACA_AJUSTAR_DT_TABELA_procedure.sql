-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE baca_ajustar_dt_tabela () AS $body$
DECLARE


dt_contrato_w		timestamp;
nr_seq_contr_w		bigint;
nr_seq_contrato_w	bigint;
nr_seq_tabela_w		bigint;
qt_contratos_w		bigint;
nr_contrato_w		bigint;

c01 CURSOR FOR
	SELECT	nr_sequencia,
		dt_contrato
	from	pls_contrato
	where	(cd_cgc_estipulante IS NOT NULL AND cd_cgc_estipulante::text <> '')
	order by 1;

c02 CURSOR FOR
	SELECT	a.nr_seq_tabela
	from	pls_segurado a,
		pls_tabela_preco b
	where	a.nr_seq_contrato	= nr_seq_contrato_w
	and	a.nr_seq_tabela		= b.nr_sequencia
	and	(a.nr_seq_tabela IS NOT NULL AND a.nr_seq_tabela::text <> '')
	and	b.ie_tabela_base	= 'N'
	
union

	SELECT	a.nr_seq_tabela
	from	pls_contrato_plano a,
		pls_tabela_preco b
	where	a.nr_seq_contrato	= nr_seq_contrato_w
	and	a.nr_seq_tabela		= b.nr_sequencia
	and	(a.nr_seq_tabela IS NOT NULL AND a.nr_seq_tabela::text <> '')
	and	b.ie_tabela_base	= 'N'
	group by a.nr_seq_tabela;

c03 CURSOR FOR
	SELECT	nr_seq_contrato
	from	pls_segurado
	where	nr_seq_tabela	= nr_seq_tabela_w
	
union

	SELECT	nr_seq_contrato
	from	pls_contrato_plano
	where	nr_seq_tabela	= nr_seq_tabela_w
	group by nr_seq_contrato;


BEGIN

open c01;
loop
fetch c01 into	nr_seq_contrato_w,
		dt_contrato_w;
EXIT WHEN NOT FOUND; /* apply on c01 */

	open c02;
	loop
	fetch c02 into	nr_seq_tabela_w;
	EXIT WHEN NOT FOUND; /* apply on c02 */

		select	coalesce(nr_contrato,0)
		into STRICT	nr_contrato_w
		from	pls_tabela_preco
		where	nr_sequencia	= nr_seq_tabela_w;

		if (nr_contrato_w = 0) then
			qt_contratos_w	:= 0;
			open c03;
			loop
			fetch c03 into nr_seq_contr_w;
			EXIT WHEN NOT FOUND; /* apply on c03 */
				qt_contratos_w	:= qt_contratos_w + 1;
			end loop;
			close c03;

			if (qt_contratos_w = 1) then
				update	pls_tabela_preco
				set	dt_inicio_vigencia	= dt_contrato_w,
					nr_contrato		= nr_seq_contrato_w,
					dt_atualizacao		= clock_timestamp(),
					nm_usuario		= 'Tasy'
				where	nr_sequencia		= nr_seq_tabela_w;
			end if;
		end if;
	end loop;
	close c02;
end loop;
close c01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE baca_ajustar_dt_tabela () FROM PUBLIC;

