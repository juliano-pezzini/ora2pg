-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_consisitir_pag_info_fin_js ( nr_seq_pagador_p bigint, nr_seq_pagador_fin_p bigint, cd_condicacao_pag_p text, cd_tipo_portador_p text, cd_portador_p text, nr_seq_conta_banco_p text, dt_fim_vigencia_p timestamp, nr_seq_forma_cobranca_p bigint, cd_banco_p bigint, cd_agencia_bancaria_p text, cd_conta_p text, nr_seq_empresa_p bigint, cd_matricula_p text, nr_seq_carteira_cobr_p bigint, ie_geracao_nota_titulo_p text, cd_pagador_pf_p text, nr_seq_visao_p bigint, nr_seq_dia_vencimento_p INOUT bigint, dt_dia_vencimento_p INOUT bigint, nr_seq_regra_port_p INOUT bigint, ds_erro_p INOUT text, cd_tipo_portador_aux_p INOUT bigint, cd_portador_aux_p INOUT bigint, nr_seq_conta_banc_aux_p INOUT bigint, nr_seq_cart_cob_aux_p INOUT bigint, ie_gerar_nota_tit_aux_p INOUT text, cd_estabelecimento_p bigint, nm_usuario_p text) AS $body$
DECLARE

			 
ie_tipo_regra_vencimento_w				varchar(10);
ds_erro_w						varchar(255);
cd_tipo_portador_deb_aut_w	pls_regra_portador_mens.cd_tipo_portador_deb_aut%type;
cd_portador_deb_aut_w		pls_regra_portador_mens.cd_portador_deb_aut%type;
nr_seq_conta_banco_deb_aut_w	pls_regra_portador_mens.nr_seq_conta_banco_deb_aut%type;
nr_seq_classif_itens_w		pls_regra_portador_mens.nr_seq_classif_itens%type;
ie_portador_exclusivo_w		varchar(10);
ie_destacar_reajuste_w		varchar(10);
ie_gerar_cobr_escrit_w		varchar(10);
			

BEGIN 
 
 
if (nr_seq_visao_p	= 20220) then 
	select	max(dt_dia_vencimento) 
	into STRICT	dt_dia_vencimento_p 
	from	pls_regra_dia_vencimento 
	where	nr_sequencia	= nr_seq_dia_vencimento_p;
	 
	nr_seq_dia_vencimento_p	:= null;
elsif (nr_seq_visao_p	= 20221) then 
	select	CASE WHEN max(cd_cgc_estipulante)='' THEN 'I'  ELSE 'C' END , 
		max(a.nr_seq_classif_itens) 
	into STRICT	ie_tipo_regra_vencimento_w, 
		nr_seq_classif_itens_w 
	from	pls_contrato		b, 
		pls_contrato_pagador	a 
	where	a.nr_seq_contrato	= b.nr_sequencia 
	and	b.nr_sequencia		= nr_seq_pagador_p;
 
	select	max(b.nr_sequencia) 
	into STRICT	nr_seq_dia_vencimento_p 
	from	pls_regra_dia_vencimento	b, 
		pls_regra_portador_mens	a 
	where	b.nr_seq_regra_portador	= a.nr_sequencia 
	and	coalesce(a.dt_fim_vigencia,clock_timestamp()) 	<= clock_timestamp() 
	and	b.dt_dia_vencimento	= dt_dia_vencimento_p 
	and	((a.ie_tipo_contratacao = ie_tipo_regra_vencimento_w) or (a.ie_tipo_contratacao = 'T')) 
	and	((a.nr_seq_classif_itens = nr_seq_classif_itens_w) or (coalesce(a.nr_seq_classif_itens::text, '') = ''));
	 
	dt_dia_vencimento_p	:= null;
end if;
 
if (coalesce(dt_fim_vigencia_p::text, '') = '') then 
	if (pls_qt_info_pagador(nr_seq_pagador_p,nr_seq_pagador_fin_p) = 'S') then 
		ds_erro_w	:= substr(obter_texto_dic_objeto(241589,wheb_usuario_pck.GET_NR_SEQ_IDIOMA,''),1,255);
	end if;
end if;
 
if (coalesce(ds_erro_w::text, '') = '') then 
	SELECT * FROM pls_consisitir_pag_info_fin(	nr_seq_pagador_fin_p, null, cd_condicacao_pag_p, cd_tipo_portador_p, cd_portador_p, nr_seq_conta_banco_p, dt_fim_vigencia_p, nr_seq_forma_cobranca_p, cd_banco_p, cd_agencia_bancaria_p, cd_conta_p, nr_seq_empresa_p, cd_matricula_p, nr_seq_carteira_cobr_p, ie_geracao_nota_titulo_p, cd_pagador_pf_p, nr_seq_classif_itens_w, nr_seq_regra_port_p, ds_erro_w) INTO STRICT nr_seq_regra_port_p, ds_erro_w;
end if;
 
ds_erro_p	:= ds_erro_w;
 
if (nr_seq_regra_port_p = 0) then 
	nr_seq_regra_port_p	:= null;
end if;
 
if (coalesce(ds_erro_w::text, '') = '') and (nr_seq_regra_port_p IS NOT NULL AND nr_seq_regra_port_p::text <> '') then 
	SELECT * FROM pls_obter_inf_fin_pag_regra(	nr_seq_regra_port_p, cd_tipo_portador_aux_p, cd_portador_aux_p, nr_seq_conta_banc_aux_p, nr_seq_cart_cob_aux_p, ie_gerar_nota_tit_aux_p, cd_tipo_portador_deb_aut_w, cd_portador_deb_aut_w, nr_seq_conta_banco_deb_aut_w, ie_portador_exclusivo_w, ie_destacar_reajuste_w, ie_gerar_cobr_escrit_w, nm_usuario_p, cd_estabelecimento_p) INTO STRICT cd_tipo_portador_aux_p, cd_portador_aux_p, nr_seq_conta_banc_aux_p, nr_seq_cart_cob_aux_p, ie_gerar_nota_tit_aux_p, cd_tipo_portador_deb_aut_w, cd_portador_deb_aut_w, nr_seq_conta_banco_deb_aut_w, ie_portador_exclusivo_w, ie_destacar_reajuste_w, ie_gerar_cobr_escrit_w;
end if;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_consisitir_pag_info_fin_js ( nr_seq_pagador_p bigint, nr_seq_pagador_fin_p bigint, cd_condicacao_pag_p text, cd_tipo_portador_p text, cd_portador_p text, nr_seq_conta_banco_p text, dt_fim_vigencia_p timestamp, nr_seq_forma_cobranca_p bigint, cd_banco_p bigint, cd_agencia_bancaria_p text, cd_conta_p text, nr_seq_empresa_p bigint, cd_matricula_p text, nr_seq_carteira_cobr_p bigint, ie_geracao_nota_titulo_p text, cd_pagador_pf_p text, nr_seq_visao_p bigint, nr_seq_dia_vencimento_p INOUT bigint, dt_dia_vencimento_p INOUT bigint, nr_seq_regra_port_p INOUT bigint, ds_erro_p INOUT text, cd_tipo_portador_aux_p INOUT bigint, cd_portador_aux_p INOUT bigint, nr_seq_conta_banc_aux_p INOUT bigint, nr_seq_cart_cob_aux_p INOUT bigint, ie_gerar_nota_tit_aux_p INOUT text, cd_estabelecimento_p bigint, nm_usuario_p text) FROM PUBLIC;

