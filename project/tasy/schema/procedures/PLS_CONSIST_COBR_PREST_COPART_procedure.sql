-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_consist_cobr_prest_copart ( nr_seq_coparticipacao_p bigint, nr_seq_conta_p bigint, cd_procedimento_p bigint, ie_origem_proced_p bigint, nr_seq_prestador_exec_p bigint, dt_conta_p timestamp, ie_cobrar_copart_p INOUT text) AS $body$
DECLARE


qt_dias_retorno_w	bigint;
dt_inicial_w		timestamp;
dt_final_w		timestamp;
qt_registros_w		bigint;
nr_seq_segurado_w	bigint;


BEGIN

select	max(qt_dias_retorno)
into STRICT	qt_dias_retorno_w
from	PLS_REGRA_COPARTIC_RETORNO
where	NR_SEQ_REGRA_COPARTIC	= nr_seq_coparticipacao_p  LIMIT 1;

if (coalesce(qt_dias_retorno_w::text, '') = '') then
	ie_cobrar_copart_p	:= 'S';
else
	dt_inicial_w	:= trunc(dt_conta_p,'dd') - qt_dias_retorno_w;
	dt_final_w	:= trunc(dt_conta_p,'dd');

	select	nr_seq_segurado
	into STRICT	nr_seq_segurado_w
	from	pls_conta
	where	nr_sequencia	= nr_seq_conta_p;

	select	count(1)
	into STRICT	qt_registros_w
	from	pls_conta_proc			c,
		PLS_CONTA_COPARTICIPACAO	b,
		pls_conta			a
	where	b.nr_seq_conta			= a.nr_sequencia
	and	c.nr_seq_conta			= a.nr_sequencia
	and	a.nr_sequencia			<> nr_seq_conta_p
	and	c.cd_procedimento		= cd_procedimento_p
	and	a.nr_seq_segurado		= nr_seq_segurado_w
	and	c.ie_origem_proced		= ie_origem_proced_p
	and	trunc(a.dt_atendimento_referencia,'dd') between dt_inicial_w and dt_final_w
	and	a.NR_SEQ_PRESTADOR_EXEC		= nr_seq_prestador_exec_p  LIMIT 1;

	if (qt_registros_w > 0) then
		ie_cobrar_copart_p	:= 'N';
	else
		ie_cobrar_copart_p	:= 'S';
	end if;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_consist_cobr_prest_copart ( nr_seq_coparticipacao_p bigint, nr_seq_conta_p bigint, cd_procedimento_p bigint, ie_origem_proced_p bigint, nr_seq_prestador_exec_p bigint, dt_conta_p timestamp, ie_cobrar_copart_p INOUT text) FROM PUBLIC;

