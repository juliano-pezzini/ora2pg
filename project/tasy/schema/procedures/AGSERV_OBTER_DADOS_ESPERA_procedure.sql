-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE agserv_obter_dados_espera (cd_pessoa_fisica_p text, cd_estabelecimento_p bigint, nr_seq_agecons_p bigint, nr_seq_agenda_destino_p bigint, nm_usuario_p text) AS $body$
DECLARE

 
 
cd_senha_w		varchar(20);
cd_usuario_conv_w	varchar(30);
cd_medico_solic_w	varchar(10);
cd_medico_exec_w	varchar(10);
cd_procedimento_w	bigint;
ie_origem_proced_w	bigint;
nr_seq_proc_interno_w	bigint;
qt_total_sessoes_w	smallint;
nr_secao_atual_w	smallint;
cd_especialidade_w	bigint;
cd_procedencia_w	integer;
cd_cid_w		varchar(10);
ie_tipo_atendimento_w	smallint;
ie_carater_inter_sus_w	varchar(2);
nr_telefone_w		varchar(80);
ds_erro_w			varchar(255);

C01 CURSOR FOR 
	SELECT	max(a.cd_senha), 
			max(a.cd_usuario_convenio), 
			max(a.cd_medico_solic), 
			max(a.cd_medico), 
			max(a.cd_procedimento), 
			max(a.ie_origem_proced), 
			max(a.nr_seq_proc_interno), 
			max(a.qt_total_secao), 
			max(a.nr_secao), 
			max(a.cd_especialidade), 
			max(a.cd_procedencia), 
			max(a.cd_cid), 
			max(a.ie_tipo_atendimento), 
			max(a.ie_carater_inter_sus), 
			max(a.nr_telefone) 
	from	agenda_consulta a, 
			agenda b 
	where	a.cd_agenda		= b.cd_agenda 
	and		b.cd_tipo_agenda	= 5 
	and		b.cd_estabelecimento	= cd_estabelecimento_p 
	and		b.ie_situacao		= 'A'	 
	and		a.nr_sequencia		= nr_seq_agecons_p 
	order by 1;
	

BEGIN 
 
if (cd_pessoa_fisica_p IS NOT NULL AND cd_pessoa_fisica_p::text <> '') and (cd_estabelecimento_p IS NOT NULL AND cd_estabelecimento_p::text <> '') and (nr_seq_agecons_p IS NOT NULL AND nr_seq_agecons_p::text <> '') and (nr_seq_agenda_destino_p IS NOT NULL AND nr_seq_agenda_destino_p::text <> '')then 
	begin 
	 
	open C01;
	loop 
	fetch C01 into	 
		cd_senha_w, 
		cd_usuario_conv_w, 
		cd_medico_solic_w,	 
		cd_medico_exec_w,	 
		cd_procedimento_w,	 
		ie_origem_proced_w, 
		nr_seq_proc_interno_w, 
		qt_total_sessoes_w,	 
		nr_secao_atual_w,	 
		cd_especialidade_w, 
		cd_procedencia_w,	 
		cd_cid_w,	 
		ie_tipo_atendimento_w, 
		ie_carater_inter_sus_w, 
		nr_telefone_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
	 
	begin 
	 
	if (nr_secao_atual_w IS NOT NULL AND nr_secao_atual_w::text <> '') and (nr_secao_atual_w < qt_total_sessoes_w)then 
		nr_secao_atual_w	:= nr_secao_atual_w + 1;
	end if;
 
		 
	update	agenda_consulta 
	set		cd_senha				= cd_senha_w, 
			cd_usuario_convenio		= cd_usuario_conv_w, 
			cd_medico_solic 		=	cd_medico_solic_w, 
			cd_medico				= cd_medico_exec_w, 
			cd_procedimento			= cd_procedimento_w, 
			ie_origem_proced		= ie_origem_proced_w, 
			nr_seq_proc_interno		= nr_seq_proc_interno_w, 
			qt_total_secao			= qt_total_sessoes_w, 
			nr_secao				= nr_secao_atual_w, 
			cd_especialidade		= cd_especialidade_w, 
			cd_procedencia			= cd_procedencia_w, 
			cd_cid					= cd_cid_w, 
			ie_tipo_atendimento		= ie_tipo_atendimento_w, 
			ie_carater_inter_sus	= ie_carater_inter_sus_w, 
			nr_telefone				= nr_telefone_w				 
	where	nr_sequencia			= nr_seq_agenda_destino_p;
	 
	commit;	
	exception 
	when others then 
		ds_erro_w	:= '';
	end;
		 
	end loop;
	close C01;
	 
	end;
 
end if;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE agserv_obter_dados_espera (cd_pessoa_fisica_p text, cd_estabelecimento_p bigint, nr_seq_agecons_p bigint, nr_seq_agenda_destino_p bigint, nm_usuario_p text) FROM PUBLIC;

