-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE inserir_cheques_custodia (ds_lista_cheques_p text, nr_seq_trans_fin_p bigint, nr_seq_conta_p bigint, dt_transacao_p timestamp, nm_usuario_p text) AS $body$
DECLARE

 
nr_seq_cheque_w		cheque_cr.nr_seq_cheque%type;
vl_cheque_w			cheque_cr.vl_cheque%type;
cd_pessoa_fisica_w	cheque_cr.cd_pessoa_fisica%type;
cd_cgc_w			cheque_cr.cd_cgc%type;
nr_sequencia_w		movto_trans_financ.nr_sequencia%type;
cd_estabelecimento_w	cheque_cr.cd_estabelecimento%type;
								
C01 CURSOR FOR 
	SELECT	a.nr_seq_cheque, 
			a.vl_cheque, 
			a.cd_cgc, 
			a.cd_pessoa_fisica, 
			a.cd_estabelecimento 
	from	cheque_cr a 
	where (obter_se_contido(a.nr_seq_cheque,ds_lista_cheques_p) = 'S') 
	and (obter_status_cheque(a.nr_seq_cheque) not in (2,4,11,13) and (coalesce(a.dt_compensacao::text, '') = '')) 
	order by a.nr_seq_cheque;	
								  

BEGIN 
 
if (ds_lista_cheques_p IS NOT NULL AND ds_lista_cheques_p::text <> '') then 
 
	open C01;
	loop 
	fetch C01 into	 
		nr_seq_cheque_w, 
		vl_cheque_w, 
		cd_cgc_w, 
		cd_pessoa_fisica_w, 
		cd_estabelecimento_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin 
		/*Verificar novamente se os atributos não estão vazios. A transacao e a conta verifica no delphi também se está nulo antes de chamar essa proc, para garantir que não seja nulo*/
 
		if (nr_seq_cheque_w IS NOT NULL AND nr_seq_cheque_w::text <> '') and (nr_seq_trans_fin_p IS NOT NULL AND nr_seq_trans_fin_p::text <> '') and (nr_seq_conta_p IS NOT NULL AND nr_seq_conta_p::text <> '') then 
 
			select	nextval('movto_trans_financ_seq') 
			into STRICT	nr_sequencia_w 
			;
 
			insert into movto_trans_financ(	dt_atualizacao, 
												dt_transacao, 
												nm_usuario, 
												nr_lote_contabil, 
												nr_seq_banco, 
												nr_seq_cheque, 
												nr_seq_trans_financ, 
												nr_sequencia, 
												vl_transacao, 
												ie_conciliacao, 
												ds_historico, 
												cd_pessoa_fisica, 
												cd_cgc) 
									values (  clock_timestamp(), 
												coalesce(dt_transacao_p,clock_timestamp()), 
												nm_usuario_p, 
												0, 
												nr_seq_conta_p, 
												nr_seq_cheque_w, 
												nr_seq_trans_fin_p, 
												nr_sequencia_w, 
												vl_cheque_w, 
												'N', 
												wheb_mensagem_pck.get_texto(444980,null) || ' ' || nr_seq_cheque_w, --Movimentação gerada a partir do envio para custódia do cheque 
												cd_pessoa_fisica_w, 
												cd_cgc_w);
								 
			CALL atualizar_transacao_financeira(cd_estabelecimento_w, 
										  nr_sequencia_w, 
										  nm_usuario_p, 
										  'I');
		 
		end if;
		 
		end;
	end loop;
	close C01;
	 
end if;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE inserir_cheques_custodia (ds_lista_cheques_p text, nr_seq_trans_fin_p bigint, nr_seq_conta_p bigint, dt_transacao_p timestamp, nm_usuario_p text) FROM PUBLIC;

