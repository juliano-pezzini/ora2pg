-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE cpoe_liberacao (cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, cd_setor_atendimento_p setor_atendimento.cd_setor_atendimento%type, cd_perfil_p perfil.cd_perfil%type, nr_atendimento_p atendimento_paciente.nr_atendimento%type, itens_liberar_p text, nm_usuario_p usuario.nm_usuario%type, ds_itens_liberados_p INOUT text, ie_inconsistencia_out_p INOUT text, cd_pessoa_fisica_p pessoa_fisica.cd_pessoa_fisica%type default null, itens_recalcular_p text default null, ie_interv_farmacia_p text default 'N', ie_liberacao_ang_p text default 'N', ie_motivo_prescr_p text default null, cd_medico_p medico.cd_pessoa_fisica%type default null, nr_prescricao_out_p INOUT bigint DEFAULT NULL, ds_lista_proc_susp_out_p INOUT text DEFAULT NULL, ds_inconsist_lib_out_p INOUT text DEFAULT NULL, nr_prescricao_p bigint default null, nr_seq_consulta_oft_p bigint default null, nr_seq_pend_pac_acao_p bigint default null, ie_adep_p text default 'S', nr_seq_revalidation_rule_p bigint default null, cd_departamento_p bigint default null, ds_prescr_geradas_full_p INOUT text DEFAULT NULL, nm_usuario_validacao_p usuario.nm_usuario%type default null, ie_copia_diaria_p text default 'N', ie_prescr_adep_p text default null) AS $body$
DECLARE


nr_seq_reg_item_w      cpoe_dieta.nr_sequencia%type;
nr_seq_lista_espera_w            cpoe_procedimento.nr_seq_lista_espera%type;
nr_seq_agenda_w        cpoe_procedimento.nr_seq_agenda%type;
nr_atendimento_old_w        cpoe_procedimento.nr_atendimento%type := null;
nr_seq_status_w        agenda_integrada_status.nr_sequencia%type;
nr_seq_ageint_w        agenda_integrada.nr_sequencia%type;
nr_seq_cpoe_anterior_w      cpoe_dieta.nr_seq_cpoe_anterior%type;
ie_administracao_w       cpoe_dieta.ie_administracao%type;
nr_seq_receita_amb_w      cpoe_material.nr_seq_receita_amb%type;
cd_estabelecimento_w      bigint;
cd_setor_atendimento_w      setor_atendimento.cd_setor_atendimento%type;
cd_setor_atendimento_ww      setor_atendimento.cd_setor_atendimento%type;
cd_setor_atend_passagem_w    setor_atendimento.cd_setor_atendimento%type;
nr_prescricao_w        prescr_medica.nr_prescricao%type;
ie_opcao_prescr_ww      varchar(2000);
ie_opcao_prescr_w      varchar(255);
item_w          varchar(255);
ie_opcao_suspender_w      varchar(4000);
dt_referencia_w        timestamp;
ds_itens_liberados_w      varchar(2000);
ds_itens_liberados_ww      varchar(4000):=null;
ds_itens_rec_ambulatorial_ww    varchar(4000):=null;
ds_retorno_aux_w      varchar(2);
ds_exception_w        varchar(4000);
ie_possui_dialise_w      char(1);
nr_prescricao_alta_w      prescr_medica.nr_prescricao%type;
param_REP_580_w             varchar(1) := 'N';
param_REP_125_w              varchar(1) := 'N';
param_REP_11_w			     varchar(1) := 'N';
ds_lista_proc_susp_w      varchar(4000);
ie_usuario_medico_w          varchar(2):= 'N';
ie_origem_inf_w             varchar(2);
cd_pessoa_fisica_usuario_w    pessoa_fisica.cd_pessoa_fisica%type;
param_REP_42_w        varchar(1) := 'P';
param_REP_136_w        varchar(1) := 'N';
ie_urgencia_w        cpoe_material.ie_urgencia%type;
cd_convenio_w        atend_categoria_convenio.cd_convenio%type;
cd_material_w        prescr_material.cd_material%type;
ie_interv_farmacia_w    varchar(1);
cd_protocolo_w cpoe_material.cd_protocolo%type;
nr_seq_protocolo_w cpoe_material.nr_seq_protocolo%type;
ie_medico_lib_tudo_w	 varchar(1);
ds_prescr_geradas_w varchar(4000);
nr_seq_prescr_separada_w prescr_medica.nr_prescricao%type;
nr_seq_cpoe_cih_anterior_w	cpoe_dieta.nr_sequencia%type;
cd_setor_aten_cpoe_proced_w     cpoe_procedimento.cd_setor_atendimento%type;
ie_exige_ciencia_w		cpoe_material.ie_exige_ciencia%type;
nm_usuario_w			cpoe_material.nm_usuario%type;
nr_seq_reval_events_w	cpoe_revalidation_events.nr_sequencia%type;
si_same_dose_w		CPOE_ORDER_UNIT.si_same_dose%type;
si_drug_adjustment_w	CPOE_ORDER_UNIT.si_drug_adjustment%type;
nr_seq_order_unit_w	CPOE_ORDER_UNIT.nr_sequencia%type;
ie_adep_discharge_w	cpoe_material.ie_adep%type := 'N';
ds_locale_user_w	 establishment_locale.ds_locale%type;
si_type_of_prescription_w   cpoe_order_unit.si_type_of_prescription%type;
ie_adep_w   cpoe_material.ie_adep%type := ie_adep_p;
ie_item_alta_w  varchar(1) := 'N';
ie_param_46_w  varchar(1) := 'N';
nr_order_unit_w cpoe_order_unit.nr_order_unit%type;
si_release_order_unit_w	 varchar(1):= null;
cd_funcao_origem_w	cpoe_material.cd_funcao_origem%type;
dt_inicio_quimio_w		cpoe_material.dt_inicio%type;
ie_oncologia_w          cpoe_material.IE_ONCOLOGIA%type;
ie_psychotropic_w    cpoe_material.IE_ONCOLOGIA%type;
nm_maquina_w          cpoe_material.nm_maquina%type;
cd_maquina_ip_w      cpoe_material.cd_maquina_ip%type;
nr_seq_equipamento_w man_equipamento_terminal.nr_seq_equipamento%type;
nr_seq_terminal_w    man_equipamento_terminal.nr_sequencia%type;

dt_ciencia_medico_w 	cpoe_material.dt_ciencia_medico%type;
ie_prescritor_aux_w 	cpoe_material.ie_prescritor_aux%type;
ie_intervencao_farm_w 	cpoe_material.ie_intervencao_farm%type;
ie_ordered_on_behalf_w 	cpoe_material.ie_ordered_on_behalf%type;
nr_seq_wl_item_w		wl_perfil.nr_sequencia%type;
nr_seq_item_cpoe_w		cpoe_material.nr_sequencia%type;

nr_seq_worklist_w		wl_worklist.nr_sequencia%type;

C01 CURSOR FOR
  SELECT  max(a.cd_setor_atendimento)
  from  usuario_setor_v b,
    atend_paciente_unidade a
  where  a.nr_atendimento  = nr_atendimento_p
  and  a.cd_setor_atendimento  = b.cd_setor_atendimento
  and  b.nm_usuario    = nm_usuario_p
  order by a.dt_saida_unidade,
    a.dt_entrada_unidade;

procedure gera_retorno_liberados(ie_item_liberado_p text) is
;
BEGIN
    if (ie_item_liberado_p IS NOT NULL AND ie_item_liberado_p::text <> '') then
      if (coalesce(ds_itens_liberados_w::text, '') = '') then
        ds_itens_liberados_w := ie_item_liberado_p || ';';
      elsif (position(ie_item_liberado_p in ds_itens_liberados_w) = 0) then
        ds_itens_liberados_w := ds_itens_liberados_w||ie_item_liberado_p||';';
      end if;
    end if;
  end;

procedure set_alteracao_farmacia_angular(  nr_seq_reg_item_p  cpoe_material.nr_sequencia%type,
                      ie_opcao_prescr_p   varchar2 ) is
begin
  ie_interv_farmacia_w := ie_interv_farmacia_p;

  if ((coalesce(ie_liberacao_ang_p,'N') = 'S') and (cpoe_obter_seq_anterior(nr_seq_reg_item_p, ie_opcao_prescr_p) > 0) and (Obter_Profissional_Usuario(nm_usuario_p, 'C') = 'F')) then
      ie_interv_farmacia_w := 'S';
  end if;
end;

begin

begin

nm_maquina_w    := wheb_usuario_pck.get_nm_maquina();
cd_maquina_ip_w := wheb_usuario_pck.get_cd_maquina_ip();

CALL gravar_log_cpoe(substr('CPOE_LIBERACAO - INICIO DA LIBERACAO'||
				' nr_atendimento_p: '||nr_atendimento_p ||
				' cd_setor_atendimento_p: ' || cd_setor_atendimento_p ||
				' cd_perfil_p: ' || cd_perfil_p ||
				' nm_usuario_p: ' || nm_usuario_p ||
				' cd_setor_atendimento_w: ' || cd_setor_atendimento_w ||
				' itens_liberar_p: ' || itens_liberar_p ||
				' cd_estabelecimento_p: ' || cd_estabelecimento_p ||
				' nr_seq_revalidation_rule_p: ' || nr_seq_revalidation_rule_p ||
				' dt_inicio_liberacao: ' || to_char(clock_timestamp(),'dd/mm/yyyy hh24:mi:ss'),1,2000),
				nr_atendimento_p);

  ie_interv_farmacia_w := ie_interv_farmacia_p;


  if (coalesce(ie_liberacao_ang_p,'N') = 'S') and (cd_setor_atendimento_p IS NOT NULL AND cd_setor_atendimento_p::text <> '') then
    cd_setor_atendimento_w := cd_setor_atendimento_p;
  else
    param_REP_42_w := obter_param_usuario(924, 42, cd_perfil_p, nm_usuario_p, cd_estabelecimento_p, param_REP_42_w);
    param_REP_136_w := obter_param_usuario(924, 136, cd_perfil_p, nm_usuario_p, cd_estabelecimento_p, param_REP_136_w);
    cd_setor_atendimento_w := cpoe_obter_setor_prescricao(param_REP_42_w, param_REP_136_w, cd_setor_atendimento_p, nr_atendimento_p, cd_perfil_p, nm_usuario_p, cd_setor_atendimento_w);

    CALL gravar_log_cpoe(substr('CPOE_LIBERACAO LOG - 1 ALTERANDO_SETOR_PACIENTE :  '||
        ' nr_atendimento_p: '||nr_atendimento_p ||
        ' param_REP_42_w: ' || param_REP_42_w ||
        ' param_REP_136_w: ' || param_REP_136_w ||
        ' cd_setor_atendimento_p: ' || cd_setor_atendimento_p ||
        ' cd_perfil_p: ' || cd_perfil_p ||
        ' nm_usuario_p: ' || nm_usuario_p ||
        ' cd_setor_atendimento_w: ' || cd_setor_atendimento_w ||
        ' itens_liberar_p: ' || itens_liberar_p ||
        ' cd_estabelecimento_p: ' || cd_estabelecimento_p,1,2000),
        nr_atendimento_p);
    if (coalesce(cd_setor_atendimento_w::text, '') = '') then
      cd_setor_atendimento_w := cpoe_obter_setor_atend_prescr( nr_atendimento_p, cd_estabelecimento_p,cd_perfil_p, nm_usuario_p );

      CALL gravar_log_cpoe(substr('CPOE_LIBERACAO LOG - 2 ALTERANDO_SETOR_PACIENTE :  '||
          ' nr_atendimento_p: '||nr_atendimento_p ||
          ' param_REP_42_w: ' || param_REP_42_w ||
          ' param_REP_136_w: ' || param_REP_136_w ||
          ' cd_setor_atendimento_p: ' || cd_setor_atendimento_p ||
          ' cd_perfil_p: ' || cd_perfil_p ||
          ' nm_usuario_p: ' || nm_usuario_p ||
          ' cd_setor_atendimento_w: ' || cd_setor_atendimento_w ||
          ' itens_liberar_p: ' || itens_liberar_p ||
          ' cd_estabelecimento_p: ' || cd_estabelecimento_p,1,2000),
          nr_atendimento_p);
    end if;
  end if;

  cd_estabelecimento_w   := obter_estabelecimento_setor(cd_setor_atendimento_w);

  if (coalesce(cd_estabelecimento_w::text, '') = '') then
    select  max(cd_estabelecimento)
    into STRICT  cd_estabelecimento_w
    from  atendimento_paciente
    where  nr_atendimento = nr_atendimento_p;
  end if;

  if (coalesce(cd_estabelecimento_w::text, '') = '') then
    cd_estabelecimento_w := obter_estabelecimento_ativo;
  end if;

  if (coalesce(ie_liberacao_ang_p,'N') = 'S')  then --Parametros que devem se aplicar somente no angular
    param_REP_580_w := obter_param_usuario(924, 580, cd_perfil_p, nm_usuario_p, cd_estabelecimento_p, param_REP_580_w);
    param_REP_125_w := obter_param_usuario(924, 125, cd_perfil_p, nm_usuario_p, cd_estabelecimento_p, param_REP_125_w);

    open c01;
    loop
    fetch c01 into
      cd_setor_atend_passagem_w;
    EXIT WHEN NOT FOUND; /* apply on c01 */
    end loop;
    close c01;

    select   max(cd_pessoa_fisica)
    into STRICT   cd_pessoa_fisica_usuario_w
    from   usuario
    where   nm_usuario = nm_usuario_p;


    if (cd_pessoa_fisica_usuario_w IS NOT NULL AND cd_pessoa_fisica_usuario_w::text <> '') then
      select  coalesce(max('1'),'3')
      into STRICT  ie_origem_inf_w
      from  medico
      where  cd_pessoa_fisica = cd_pessoa_fisica_usuario_w
      and  coalesce(ie_situacao,'A') = 'A';
    end if;

    if (ie_origem_inf_w <> '1')  and   -- se nao e usuario medico
      (param_REP_580_w = 'N') AND (param_REP_125_w = 'N') AND (cd_setor_atend_passagem_w is  null) then
      ds_inconsist_lib_out_p := wheb_mensagem_pck.get_texto(278998); --O usuario nao tem o setor do paciente liberado!
      CALL wheb_mensagem_pck.exibir_mensagem_abort(278998);
    end if;

  end if;

  ds_locale_user_w := pkg_i18n.get_user_locale;
	if (ds_locale_user_w = 'ja_JP') then
		ie_param_46_w := obter_param_usuario(2314, 46, cd_perfil_p, nm_usuario_p, cd_estabelecimento_p, ie_param_46_w);
		if (ie_param_46_w = 'S') then
			si_release_order_unit_w := cpoe_order_unit_submit(nr_atendimento_p, itens_liberar_p, nm_usuario_p, si_release_order_unit_w);
			if (si_release_order_unit_w = 'N') then
				ds_inconsist_lib_out_p	:=  wheb_mensagem_pck.get_texto(1174874,'NR_ORDER_UNIT=' || nr_order_unit_w);
				CALL wheb_mensagem_pck.exibir_mensagem_abort(1174874,'NR_ORDER_UNIT=' || nr_order_unit_w);
			end if;
		end if;
	end if;

  ie_possui_dialise_w := 'N';
  ie_opcao_prescr_ww := itens_liberar_p;
  dt_referencia_w := trunc(clock_timestamp(),'mi') + 1/1440;

  param_REP_11_w := Obter_Param_Usuario(924, 11, obter_perfil_ativo, wheb_usuario_pck.get_nm_usuario, wheb_usuario_pck.get_cd_estabelecimento, param_REP_11_w);
  if (param_REP_11_w = 'D') then
	ie_medico_lib_tudo_w := CPOE_Obter_se_medico_lib_tudo(cd_setor_atendimento_w, ie_opcao_prescr_ww);	
  else
	ie_medico_lib_tudo_w :=  param_REP_11_w;
  end if;


  while(ie_opcao_prescr_ww IS NOT NULL AND ie_opcao_prescr_ww::text <> '') loop
    -- R,12;M,12345;D,1233;M,2312;
    if (position(';' in ie_opcao_prescr_ww) = 0) and (ie_opcao_prescr_ww IS NOT NULL AND ie_opcao_prescr_ww::text <> '') then
      ie_opcao_prescr_ww  := ie_opcao_prescr_ww||';';
    end if;
    item_w := substr(ie_opcao_prescr_ww, 1, position(';' in ie_opcao_prescr_ww) - 1);
    ie_opcao_prescr_w := substr(item_w, 1, position(',' in item_w) - 1);
    nr_seq_reg_item_w := (substr(item_w, position(',' in item_w) + 1, length(item_w)))::numeric;
    ie_opcao_prescr_ww := substr(ie_opcao_prescr_ww, position(';' in ie_opcao_prescr_ww) + 1, length(ie_opcao_prescr_ww));	

    /* Treatment for discharge prescriptions, to not enter eMar */

	  ie_adep_w := ie_adep_p;

    ds_locale_user_w := pkg_i18n.get_user_locale;
    if (ds_locale_user_w = 'ja_JP') then
      ie_param_46_w := obter_param_usuario(2314, 46, cd_perfil_p, nm_usuario_p, cd_estabelecimento_p, ie_param_46_w);
      if (ie_param_46_w = 'S' and ie_opcao_prescr_w = 'M') then
        select  b.nr_seq_cpoe_order_unit
        into STRICT    nr_seq_order_unit_w
        from    cpoe_material b
        where   b.nr_sequencia = nr_seq_reg_item_w;

        if (nr_seq_order_unit_w IS NOT NULL AND nr_seq_order_unit_w::text <> '') then
          select 	a.si_type_of_prescription
          into STRICT 		si_type_of_prescription_w
          from		cpoe_order_unit a
          where		nr_sequencia = nr_seq_order_unit_w;

          if (si_type_of_prescription_w = 'INPDP') then
              ie_adep_w := 'N';
              ie_item_alta_w := 'S';
          end if;
        end if;
      end if;
    end if;

	select	max(ie_exige_ciencia),
			max(nm_usuario)
	into STRICT	ie_exige_ciencia_w,
			nm_usuario_w
	from	cpoe_material
	where	nr_sequencia = nr_seq_reg_item_w;

	if (nm_usuario_p = nm_usuario_w) and (param_REP_580_w = 'N') and (ie_opcao_prescr_w = 'M') and (ie_exige_ciencia_w = 'V') then
      update	cpoe_material
	  set		dt_liberacao_aux = clock_timestamp(), ie_prescritor_aux = 'S'
	  where		nr_sequencia = nr_seq_reg_item_w;
	else
		if (itens_recalcular_p like '%'||item_w||'%') then
			RAISE NOTICE '% 2 : %', obter_desc_expressao(283211), ie_administracao_w;
			CALL cpoe_atualizar_data_agora( nr_atendimento_p, nr_seq_reg_item_w, ie_opcao_prescr_w, dt_referencia_w, cd_estabelecimento_w, cd_perfil_p, nm_usuario_p, cd_pessoa_fisica_p, 'N');
		else
			if (ie_opcao_prescr_w = 'M') then
				select   max(ie_urgencia)
				into STRICT  ie_urgencia_w
				from  cpoe_material
				where  nr_sequencia = nr_seq_reg_item_w
				and    dt_inicio < dt_referencia_w;	

				if (ie_urgencia_w IS NOT NULL AND ie_urgencia_w::text <> '') then
					CALL cpoe_atualizar_data_agora( nr_atendimento_p, nr_seq_reg_item_w, ie_opcao_prescr_w, dt_referencia_w, cd_estabelecimento_w, cd_perfil_p, nm_usuario_p, cd_pessoa_fisica_p, 'N');
				end if;
			elsif (cpoe_obter_se_incio_menor_lib(nr_seq_reg_item_w, ie_opcao_prescr_w, dt_referencia_w) = 'N') then
				CALL cpoe_atualizar_data_agora( nr_atendimento_p, nr_seq_reg_item_w, ie_opcao_prescr_w, dt_referencia_w, cd_estabelecimento_w, cd_perfil_p, nm_usuario_p, cd_pessoa_fisica_p, 'S');
			end if;
		end if;

		nr_seq_receita_amb_w := 0;
		if (ie_opcao_prescr_w = 'M') then
		select  coalesce(max(nr_seq_receita_amb),0)
		into STRICT  nr_seq_receita_amb_w
		from  cpoe_material
		where  nr_sequencia = nr_seq_reg_item_w;

		if (nr_seq_receita_amb_w > 0) then
        ds_itens_rec_ambulatorial_ww := ds_itens_rec_ambulatorial_ww || nr_seq_reg_item_w || ',';
		end if;
    end if;

	/* No momento somente para GWT e Dietas */

	if ((coalesce(ie_liberacao_ang_p, 'N') = 'N') and (ie_opcao_prescr_w = 'N')) then
		CALL cpoe_reproc_hor_dieta_enteral(nr_seq_reg_item_w, nr_atendimento_p, cd_estabelecimento_w, cd_perfil_p, nm_usuario_p);
	end if;

    if (cpoe_obter_se_incio_menor_lib(nr_seq_reg_item_w, ie_opcao_prescr_w) = 'S') and (cpoe_obter_se_item_valido_lib(nr_seq_reg_item_w, ie_opcao_prescr_w) = 'S') then

      if (ie_opcao_prescr_w IS NOT NULL AND ie_opcao_prescr_w::text <> '') and (coalesce(nr_seq_receita_amb_w,0) = 0 ) then

          --retirar dialise da tripe. Este atributo sera passada a procedure cpoe_Gerar_prescricao no fim desta procedure - OS 998979
          ds_itens_liberados_ww :=  ds_itens_liberados_ww || ie_opcao_prescr_w||','||nr_seq_reg_item_w||';';

      end if;

      if (ie_opcao_prescr_w IS NOT NULL AND ie_opcao_prescr_w::text <> '') then
        set_alteracao_farmacia_angular(nr_seq_reg_item_w, ie_opcao_prescr_w);
        if ((param_rep_580_w = 'N') or (ie_interv_farmacia_w = 'S')) then
		  if	((nr_atendimento_p > 0) and (Cpoe_obter_se_atend_valido(nr_seq_reg_item_w, ie_opcao_prescr_w, nr_atendimento_p) = 'N')) then				
				ds_inconsist_lib_out_p :=  wheb_mensagem_pck.get_texto(278998);
				CALL wheb_mensagem_pck.exibir_mensagem_abort( wheb_mensagem_pck.get_texto(278998));
		  end if;
          case ie_opcao_prescr_w
            when 'MA' then
              begin	

              update cpoe_material
              set     dt_liberacao = clock_timestamp(),
                cd_setor_atendimento = cd_setor_atendimento_w,
                ie_motivo_prescricao = ie_motivo_prescr_p,
                cd_medico = coalesce(cd_medico, cd_medico_p),
                ie_adep = ie_adep_p,
                nr_seq_pend_pac_acao = coalesce(nr_seq_pend_pac_acao_p, nr_seq_pend_pac_acao),
                cd_departamento = cd_departamento_p,
				nm_maquina = nm_maquina_w,
				cd_maquina_ip = cd_maquina_ip_w
              where   nr_sequencia = nr_seq_reg_item_w
              and  coalesce(nr_seq_procedimento::text, '') = '';
			  if (ie_medico_lib_tudo_w = 'S') then
				  update cpoe_material
				  set	dt_liberacao_enf = clock_timestamp(),
						nm_usuario_lib_enf	= nm_usuario_p
				  where nr_sequencia = nr_seq_reg_item_w
				  and	dt_inicio >= (clock_timestamp() + interval '1 days');
			  end if;

			  select	max(nr_seq_cpoe_anterior)
			  into STRICT		nr_seq_cpoe_cih_anterior_w
			  from		cpoe_material
			  where		nr_sequencia	=	nr_seq_reg_item_w
			  and		ie_modificado	=	'M';

			  if (nr_seq_cpoe_cih_anterior_w IS NOT NULL AND nr_seq_cpoe_cih_anterior_w::text <> '') then
				CALL CPOE_ALTERAR_SUBS_SUG_CIH(nr_seq_cpoe_cih_anterior_w, nm_usuario_p);

			  end if;


              select   max(cd_convenio)
              into STRICT  cd_convenio_w
              from   atend_categoria_convenio
              where  nr_atendimento = nr_atendimento_p;

            select  max(cd_material),
                       max(cd_funcao_origem),
                       max(dt_inicio),
                       max(ie_oncologia)
			 into STRICT     cd_material_w,
                       cd_funcao_origem_w,
                       dt_inicio_quimio_w,
                       ie_oncologia_w
             from    cpoe_material
             where  nr_sequencia = nr_seq_reg_item_w;

              if (cd_material_w IS NOT NULL AND cd_material_w::text <> '') then
                CALL evento_metas_medicamento(cd_convenio_w, cd_material_w, cd_medico_p, cd_medico_p, nr_atendimento_p, cd_estabelecimento_w, cd_perfil_p, cd_setor_atendimento_w, '', null);
              end if;

              select  max(nr_seq_cpoe_anterior)
              into STRICT    nr_seq_cpoe_anterior_w
              from    cpoe_material
              where   nr_sequencia = nr_seq_reg_item_w;

              if (nr_seq_revalidation_rule_p IS NOT NULL AND nr_seq_revalidation_rule_p::text <> '') then
                nr_seq_reval_events_w := cpoe_gerar_revalidation_events(nr_atendimento_p, nr_seq_reg_item_w, ie_opcao_prescr_w, nr_seq_revalidation_rule_p, 'S', nm_usuario_p, nr_seq_reval_events_w);
              end if;
              end;
			
            when 'M' then -- Materiais e medicamentos
              begin

				update  cpoe_material
				set     dt_liberacao = clock_timestamp(),
						cd_setor_atendimento = cd_setor_atendimento_w,
						ie_motivo_prescricao = ie_motivo_prescr_p,
						cd_medico = coalesce(cd_medico, cd_medico_p),
						ie_adep = ie_adep_w,
						ie_item_alta = CASE WHEN ie_item_alta_w='S' THEN  'S'  ELSE ie_item_alta END ,
						nr_seq_pend_pac_acao = coalesce(nr_seq_pend_pac_acao_p, nr_seq_pend_pac_acao),
						cd_departamento = cd_departamento_p,
						nm_maquina = nm_maquina_w,
						cd_maquina_ip = cd_maquina_ip_w
				where   nr_sequencia = nr_seq_reg_item_w
				and    coalesce(nr_seq_procedimento::text, '') = '';
			
				if (ie_medico_lib_tudo_w = 'S') then
					update cpoe_material
					set	dt_liberacao_enf = clock_timestamp(),
					nm_usuario_lib_enf	= nm_usuario_p
					where nr_sequencia = nr_seq_reg_item_w
					and	dt_inicio >= (clock_timestamp() + interval '1 days');
				end if;

				select   max(cd_convenio)
				into STRICT  cd_convenio_w
				from   atend_categoria_convenio
				where  nr_atendimento = nr_atendimento_p;

				select  max(cd_material),
						max(cd_funcao_origem),
						max(dt_inicio),
						max(ie_oncologia),
						max(nr_seq_cpoe_anterior),
						max(dt_ciencia_medico),
						coalesce(max(ie_prescritor_aux),'N'),
						coalesce(max(ie_intervencao_farm),'N'),
						coalesce(max(ie_ordered_on_behalf),'N'),
						max(nr_sequencia)
				into STRICT    cd_material_w,
						cd_funcao_origem_w,
						dt_inicio_quimio_w,
						ie_oncologia_w,
						nr_seq_cpoe_anterior_w,
						dt_ciencia_medico_w,
						ie_prescritor_aux_w,
						ie_intervencao_farm_w,
						ie_ordered_on_behalf_w,
						nr_seq_item_cpoe_w
				from    cpoe_material
				where  nr_sequencia = nr_seq_reg_item_w
				and    (cd_medico IS NOT NULL AND cd_medico::text <> '');

        select max(nr_sequencia)
        into STRICT	nr_seq_worklist_w
        from	wl_worklist
        where nr_seq_item_cpoe = nr_seq_reg_item_w
        and	ie_tipo_item_cpoe = 'M'
        and nr_seq_item = obter_se_worklist_lib_cat('VN');

        CALL wl_alterar_fim_previsto(nr_seq_worklist_w, clock_timestamp() + interval '1 days', clock_timestamp(), nm_usuario_p, obter_desc_expressao(1079600), null);

				if (cd_material_w IS NOT NULL AND cd_material_w::text <> '') then
					CALL evento_metas_medicamento(cd_convenio_w, cd_material_w, cd_medico_p, cd_medico_p, nr_atendimento_p, cd_estabelecimento_w, cd_perfil_p, cd_setor_atendimento_w, '', null);
				end if;

				update  med_avaliacao_paciente
				set  dt_liberacao = clock_timestamp(),
					cd_medico    = coalesce(cd_medico, cd_medico_p)
				where  coalesce(dt_liberacao::text, '') = ''
				and  nr_seq_mat_cpoe  = nr_seq_reg_item_w;

				if (nr_seq_revalidation_rule_p IS NOT NULL AND nr_seq_revalidation_rule_p::text <> '') then
					nr_seq_reval_events_w := cpoe_gerar_revalidation_events(nr_atendimento_p, nr_seq_reg_item_w, ie_opcao_prescr_w, nr_seq_revalidation_rule_p, 'S', nm_usuario_p, nr_seq_reval_events_w);
				end if;

				select  max(a.NR_SEQUENCIA),
						max(a.SI_SAME_DOSE),
						max(a.SI_DRUG_ADJUSTMENT),
						max(coalesce(c.ie_psychotropic,'N'))
				into STRICT    nr_seq_order_unit_w,
						si_same_dose_w,
						SI_DRUG_ADJUSTMENT_w,
						ie_psychotropic_w
				from    CPOE_ORDER_UNIT a,
						cpoe_material b,
						material c
				where   a.nr_sequencia = b.NR_SEQ_CPOE_ORDER_UNIT
				and     b.cd_material  = c.cd_material
				and     b.nr_sequencia = nr_seq_reg_item_w;

				if (si_same_dose_w = 'S' and ie_psychotropic_w = 'S') then
					begin
						CALL insert_med_guid_addition(nr_atendimento_p, 'APD', nr_seq_order_unit_w, cd_estabelecimento_p, nm_usuario_p,nr_seq_reg_item_w);
					end;
				end if;

				if (SI_DRUG_ADJUSTMENT_w = 'S' and ie_psychotropic_w = 'S') then
					begin
						CALL insert_med_guid_addition(nr_atendimento_p, 'SPD', nr_seq_order_unit_w, cd_estabelecimento_p, nm_usuario_p,nr_seq_reg_item_w);
					end;
				end if;
              end;
            when 'N' then --Nutricao
            begin

              update  cpoe_dieta
              set     dt_liberacao = clock_timestamp(),
                cd_setor_atendimento = cd_setor_atendimento_w,
                ie_motivo_prescricao = ie_motivo_prescr_p,
                cd_medico = coalesce(cd_medico, cd_medico_p),
                ie_adep = ie_adep_p,
                nr_seq_pend_pac_acao = coalesce(nr_seq_pend_pac_acao_p, nr_seq_pend_pac_acao),
                cd_departamento = cd_departamento_p,
				cd_perfil_ativo = cd_perfil_p,
				nm_maquina = nm_maquina_w,
				cd_maquina_ip = cd_maquina_ip_w
              where   nr_sequencia = nr_seq_reg_item_w;

			  if (ie_medico_lib_tudo_w = 'S') then
				  update cpoe_dieta
				  set	dt_liberacao_enf = clock_timestamp(),
						nm_usuario_lib_enf	= nm_usuario_p
				  where nr_sequencia = nr_seq_reg_item_w
				  and	dt_inicio >= (clock_timestamp() + interval '1 days');	
				end if;


              select  max(nr_seq_cpoe_anterior)
              into STRICT    nr_seq_cpoe_anterior_w
              from    cpoe_dieta
              where   nr_sequencia = nr_seq_reg_item_w;


              if (position('N' in ds_itens_liberados_w) = 0) then
                ds_itens_liberados_w := ds_itens_liberados_w||'N;';
              end if;

              if (nr_seq_revalidation_rule_p IS NOT NULL AND nr_seq_revalidation_rule_p::text <> '') then
                nr_seq_reval_events_w := cpoe_gerar_revalidation_events(nr_atendimento_p, nr_seq_reg_item_w, ie_opcao_prescr_w, nr_seq_revalidation_rule_p, 'S', nm_usuario_p, nr_seq_reval_events_w);
              end if;

            end;
            when 'P' then --Procedimentos
            begin
			  select max(cd_setor_atendimento)
			  into STRICT cd_setor_aten_cpoe_proced_w
			  from cpoe_procedimento
              where nr_sequencia = nr_seq_reg_item_w;

		if (coalesce(ie_liberacao_ang_p,'N') = 'N') then
			cd_setor_atendimento_ww := null;
		else
			cd_setor_atendimento_ww := coalesce(cd_setor_aten_cpoe_proced_w, cd_setor_atendimento_w);
		end if;

              update  cpoe_procedimento
              set     dt_liberacao = clock_timestamp(),
                cd_setor_atendimento = cd_setor_atendimento_ww,
				cd_setor_liberacao = cd_setor_atendimento_w,
                ie_motivo_prescricao = ie_motivo_prescr_p,
                cd_medico = coalesce(cd_medico, cd_medico_p),
                ie_adep = ie_adep_p,
                nr_seq_pend_pac_acao = coalesce(nr_seq_pend_pac_acao_p, nr_seq_pend_pac_acao),
                cd_departamento = cd_departamento_p,
				nm_maquina = nm_maquina_w,
				cd_maquina_ip = cd_maquina_ip_w
              where   nr_sequencia = nr_seq_reg_item_w;

			  if (ie_medico_lib_tudo_w = 'S') then
				  update cpoe_procedimento
				  set	dt_liberacao_enf = clock_timestamp(),
						nm_usuario_lib_enf	= nm_usuario_p
				  where nr_sequencia = nr_seq_reg_item_w
				  and	dt_inicio >= (clock_timestamp() + interval '1 days');	
				end if;

              select  max(nr_seq_cpoe_anterior)
                     ,max(nr_seq_lista_espera)
                   ,max(nr_seq_agenda)
              into STRICT    nr_seq_cpoe_anterior_w
                     ,nr_seq_lista_espera_w
                   ,nr_seq_agenda_w
              from    cpoe_procedimento
              where   nr_sequencia = nr_seq_reg_item_w;

			  if (nr_seq_cpoe_anterior_w IS NOT NULL AND nr_seq_cpoe_anterior_w::text <> '') then
				select	max(nr_atendimento)
				into STRICT	nr_atendimento_old_w
				from	cpoe_procedimento
				where	nr_sequencia = nr_seq_cpoe_anterior_w;
			  end if;

              if (cd_departamento_p IS NOT NULL AND cd_departamento_p::text <> '') then
                update agenda_lista_espera
                set    cd_setor_atendimento   = cd_setor_atendimento_w
                    ,cd_departamento_medico = cd_departamento_p
                where  nr_sequencia      = nr_seq_lista_espera_w;

                select  min(nr_sequencia)
                into STRICT  nr_seq_status_w
                from   agenda_integrada_status
                where   ie_situacao  = 'A'
                and   ie_status_tasy  = 'AG';

                select  max(nr_seq_agenda_int)
                into STRICT  nr_seq_ageint_w
                from  agenda_integrada_item
                where  nr_seq_agenda_exame    = nr_seq_agenda_w;

                if (coalesce(nr_seq_ageint_w, 0) > 0) then
                  update  agenda_integrada
                  set  nr_seq_status    = nr_seq_status_w
                  where  nr_sequencia    = nr_seq_ageint_w;
                end if;

              end if;

              ds_retorno_aux_w := cpoe_gerar_cpoe_mat_assoc_proc( nr_seq_reg_item_w, nm_usuario_p, cd_perfil_p, ds_retorno_aux_w);
              gera_retorno_liberados(ds_retorno_aux_w);

              if (nr_seq_revalidation_rule_p IS NOT NULL AND nr_seq_revalidation_rule_p::text <> '') then
                nr_seq_reval_events_w := cpoe_gerar_revalidation_events(nr_atendimento_p, nr_seq_reg_item_w, ie_opcao_prescr_w, nr_seq_revalidation_rule_p, 'S', nm_usuario_p, nr_seq_reval_events_w);
              end if;

            end;
            when 'G' then --Gasoterapia
            begin
              update  cpoe_gasoterapia
              set     dt_liberacao = clock_timestamp(),
                cd_setor_atendimento = cd_setor_atendimento_w,
                ie_motivo_prescricao = ie_motivo_prescr_p,
                cd_medico = coalesce(cd_medico, cd_medico_p),
                ie_adep = ie_adep_p,
                nr_seq_pend_pac_acao = coalesce(nr_seq_pend_pac_acao_p, nr_seq_pend_pac_acao),
                cd_departamento = cd_departamento_p,
				nm_maquina = nm_maquina_w,
				cd_maquina_ip = cd_maquina_ip_w
              where   nr_sequencia = nr_seq_reg_item_w;
			  if (ie_medico_lib_tudo_w = 'S') then
				  update cpoe_gasoterapia
				  set	dt_liberacao_enf = clock_timestamp(),
						nm_usuario_lib_enf	= nm_usuario_p
				  where nr_sequencia = nr_seq_reg_item_w
				  and	dt_inicio >= (clock_timestamp() + interval '1 days');	
			  end if;

              select  max(nr_seq_cpoe_anterior)
              into STRICT    nr_seq_cpoe_anterior_w
              from    cpoe_gasoterapia
              where   nr_sequencia = nr_seq_reg_item_w;

              if (nr_seq_revalidation_rule_p IS NOT NULL AND nr_seq_revalidation_rule_p::text <> '') then
                nr_seq_reval_events_w := cpoe_gerar_revalidation_events(nr_atendimento_p, nr_seq_reg_item_w, ie_opcao_prescr_w, nr_seq_revalidation_rule_p, 'S', nm_usuario_p, nr_seq_reval_events_w);
              end if;

            end;
            when 'R' then --Recomendacao
            begin
              update  cpoe_recomendacao
              set     dt_liberacao = clock_timestamp(),
                cd_setor_atendimento = cd_setor_atendimento_w,
                ie_motivo_prescricao = ie_motivo_prescr_p,
                cd_medico = coalesce(cd_medico, cd_medico_p),
                ie_adep = ie_adep_p,
                nr_seq_pend_pac_acao = coalesce(nr_seq_pend_pac_acao_p, nr_seq_pend_pac_acao),
                cd_departamento = cd_departamento_p,
				nm_maquina = nm_maquina_w,
				cd_maquina_ip = cd_maquina_ip_w
              where   nr_sequencia = nr_seq_reg_item_w;

			  if (ie_medico_lib_tudo_w = 'S') then
				  update cpoe_recomendacao
				  set	dt_liberacao_enf = clock_timestamp(),
						nm_usuario_lib_enf	= nm_usuario_p
				  where nr_sequencia = nr_seq_reg_item_w
				  and	dt_inicio >= (clock_timestamp() + interval '1 days');		
			  end if;

              select  max(nr_seq_cpoe_anterior)
              into STRICT    nr_seq_cpoe_anterior_w
              from    cpoe_recomendacao
              where   nr_sequencia = nr_seq_reg_item_w;

              if (nr_seq_revalidation_rule_p IS NOT NULL AND nr_seq_revalidation_rule_p::text <> '') then
                nr_seq_reval_events_w := cpoe_gerar_revalidation_events(nr_atendimento_p, nr_seq_reg_item_w, ie_opcao_prescr_w, nr_seq_revalidation_rule_p, 'S', nm_usuario_p, nr_seq_reval_events_w);
              end if;

            end;
            when 'H' then --Hemoterapia
            begin
              update  cpoe_hemoterapia
              set     dt_liberacao = clock_timestamp(),
                cd_setor_atendimento = cd_setor_atendimento_w,
                ie_motivo_prescricao = ie_motivo_prescr_p,
                cd_medico = coalesce(cd_medico, cd_medico_p),
                ie_adep = ie_adep_p,
                nr_seq_pend_pac_acao = coalesce(nr_seq_pend_pac_acao_p, nr_seq_pend_pac_acao),
                cd_departamento = cd_departamento_p,
				nm_maquina = nm_maquina_w,
				cd_maquina_ip = cd_maquina_ip_w
              where   nr_sequencia = nr_seq_reg_item_w;

			  if (ie_medico_lib_tudo_w = 'S') then
				  update cpoe_hemoterapia
				  set	dt_liberacao_enf = clock_timestamp(),
						nm_usuario_lib_enf	= nm_usuario_p
				  where nr_sequencia = nr_seq_reg_item_w
				  and	dt_inicio >= (clock_timestamp() + interval '1 days');	
			  end if;

              select  max(nr_seq_cpoe_anterior)
              into STRICT    nr_seq_cpoe_anterior_w
              from    cpoe_hemoterapia
              where   nr_sequencia = nr_seq_reg_item_w;

              ds_retorno_aux_w := cpoe_gerar_cpoe_mat_assoc_hemo( nr_seq_reg_item_w, nm_usuario_p, cd_perfil_p, ds_retorno_aux_w);
              gera_retorno_liberados(ds_retorno_aux_w);

              if (nr_seq_revalidation_rule_p IS NOT NULL AND nr_seq_revalidation_rule_p::text <> '') then
                nr_seq_reval_events_w := cpoe_gerar_revalidation_events(nr_atendimento_p, nr_seq_reg_item_w, ie_opcao_prescr_w, nr_seq_revalidation_rule_p, 'S', nm_usuario_p, nr_seq_reval_events_w);
              end if;

            end;
            when 'DI' then --Dialysis
              begin
                ie_possui_dialise_w := 'S';

                update  cpoe_dialise
                set     dt_liberacao = clock_timestamp(),
                  cd_setor_atendimento = cd_setor_atendimento_w,
                  ie_motivo_prescricao = ie_motivo_prescr_p,
                  cd_medico = coalesce(cd_medico, cd_medico_p),
                  ie_adep = ie_adep_p,
                nr_seq_pend_pac_acao = coalesce(nr_seq_pend_pac_acao_p, nr_seq_pend_pac_acao),
                  cd_departamento = cd_departamento_p,
				nm_maquina = nm_maquina_w,
				cd_maquina_ip = cd_maquina_ip_w
                where   nr_sequencia = nr_seq_reg_item_w;

				if (ie_medico_lib_tudo_w = 'S') then
					update cpoe_dialise
					set		dt_liberacao_enf = clock_timestamp(),
							nm_usuario_lib_enf	= nm_usuario_p
					where nr_sequencia = nr_seq_reg_item_w
					and	dt_inicio >= (clock_timestamp() + interval '1 days');	
				end if;

                select  max(nr_seq_cpoe_anterior)
                into STRICT    nr_seq_cpoe_anterior_w
                from    cpoe_dialise
                where   nr_sequencia = nr_seq_reg_item_w;
              end;


              if (nr_seq_revalidation_rule_p IS NOT NULL AND nr_seq_revalidation_rule_p::text <> '') then
                nr_seq_reval_events_w := cpoe_gerar_revalidation_events(nr_atendimento_p, nr_seq_reg_item_w, 'D', nr_seq_revalidation_rule_p, 'S', nm_usuario_p, nr_seq_reval_events_w);
              end if;

            when 'DP' then --Dialysis
            begin
              update  cpoe_dialise
              set     dt_liberacao = clock_timestamp(),
                cd_setor_atendimento = cd_setor_atendimento_w,
                ie_motivo_prescricao = ie_motivo_prescr_p,
                cd_medico = coalesce(cd_medico, cd_medico_p),
                ie_adep = ie_adep_p,
                nr_seq_pend_pac_acao = coalesce(nr_seq_pend_pac_acao_p, nr_seq_pend_pac_acao),
                cd_departamento = cd_departamento_p,
				nm_maquina = nm_maquina_w,
				cd_maquina_ip = cd_maquina_ip_w
              where   nr_sequencia = nr_seq_reg_item_w;

			if (ie_medico_lib_tudo_w = 'S') then
				update cpoe_dialise
				set		dt_liberacao_enf = clock_timestamp(),
						nm_usuario_lib_enf	= nm_usuario_p
				where nr_sequencia = nr_seq_reg_item_w
				and	dt_inicio >= (clock_timestamp() + interval '1 days');
			end if;


              select  max(nr_seq_cpoe_anterior)
              into STRICT    nr_seq_cpoe_anterior_w
              from    cpoe_dialise
              where   nr_sequencia = nr_seq_reg_item_w;

              if (nr_seq_revalidation_rule_p IS NOT NULL AND nr_seq_revalidation_rule_p::text <> '') then
                nr_seq_reval_events_w := cpoe_gerar_revalidation_events(nr_atendimento_p, nr_seq_reg_item_w, 'D', nr_seq_revalidation_rule_p, 'S', nm_usuario_p, nr_seq_reval_events_w);
              end if;

            end;
            when 'AP' then --Anatomia Patologica
            begin
              update  cpoe_anatomia_patologica
              set     dt_liberacao = clock_timestamp(),
                cd_setor_atendimento = cd_setor_atendimento_w,
                ie_motivo_prescricao = ie_motivo_prescr_p,
                cd_medico = coalesce(cd_medico, cd_medico_p),
                cd_departamento = cd_departamento_p,
				nm_maquina = nm_maquina_w,
				cd_maquina_ip = cd_maquina_ip_w
              where   nr_sequencia = nr_seq_reg_item_w;

			if (ie_medico_lib_tudo_w = 'S') then
				  update cpoe_anatomia_patologica
				  set	dt_liberacao_enf = clock_timestamp(),
						nm_usuario_lib_enf	= nm_usuario_p
				  where nr_sequencia = nr_seq_reg_item_w
				  and	dt_inicio >= (clock_timestamp() + interval '1 days');	
			end if;

              select  max(nr_seq_cpoe_anterior)
              into STRICT    nr_seq_cpoe_anterior_w
              from    cpoe_anatomia_patologica
              where   nr_sequencia = nr_seq_reg_item_w;
            end;

          end case;

        else
          -- #####################################################################################################################

          -- REP PARAM 580 = 'S' update DT_LIBERACAO_AUX and CD_MEDICO

          -- #####################################################################################################################
          case ie_opcao_prescr_w
            when 'MA' then
            begin

            update  cpoe_material
            set     dt_liberacao_aux = clock_timestamp(),
              cd_setor_atendimento = cd_setor_atendimento_w,
              ie_motivo_prescricao = ie_motivo_prescr_p,
              cd_medico = cd_medico_p,
              ie_adep = ie_adep_p,
				nm_maquina = nm_maquina_w,
				cd_maquina_ip = cd_maquina_ip_w
            where   nr_sequencia = nr_seq_reg_item_w;

			if (ie_medico_lib_tudo_w = 'S') then
				update	cpoe_material
				set		dt_liberacao_enf = clock_timestamp(),
						nm_usuario_lib_enf	= nm_usuario_p
				where	nr_sequencia = nr_seq_reg_item_w
				and		dt_inicio >= (clock_timestamp() + interval '1 days');
			end if;

            select   max(cd_convenio)
            into STRICT  cd_convenio_w
            from   atend_categoria_convenio
            where  nr_atendimento = nr_atendimento_p;

            select  max(cd_material)
            into STRICT  cd_material_w
            from   cpoe_material
            where   nr_sequencia = nr_seq_reg_item_w;

            if (cd_material_w IS NOT NULL AND cd_material_w::text <> '') then
              CALL evento_metas_medicamento(cd_convenio_w, cd_material_w, cd_medico_p, cd_medico_p, nr_atendimento_p, cd_estabelecimento_w, cd_perfil_p, cd_setor_atendimento_w, '', null);
            end if;

            select  max(nr_seq_cpoe_anterior)
            into STRICT    nr_seq_cpoe_anterior_w
            from    cpoe_material
            where   nr_sequencia = nr_seq_reg_item_w;
            end;
            when 'M' then
            begin

            update  cpoe_material
            set   dt_liberacao_aux = clock_timestamp(),
              cd_setor_atendimento = cd_setor_atendimento_w,
              ie_motivo_prescricao = ie_motivo_prescr_p,
              cd_medico = cd_medico_p,
              ie_adep = ie_adep_w,
              ie_item_alta = CASE WHEN ie_item_alta_w='S' THEN  'S'  ELSE ie_item_alta END ,
				nm_maquina = nm_maquina_w,
				cd_maquina_ip = cd_maquina_ip_w
            where   nr_sequencia = nr_seq_reg_item_w;

        nr_seq_wl_item_w := obter_se_worklist_lib_cat('VN');
        CALL gerar_registro_worklist(nr_atendimento_p,
                                clock_timestamp(),
                                wheb_usuario_pck.get_nm_usuario,
                                clock_timestamp(),
                                clock_timestamp() + interval '1 days',
                                cd_pessoa_fisica_p,
                                nr_seq_wl_item_w,
                                nr_seq_reg_item_w,
                                'M',
                                'N');

			if (ie_medico_lib_tudo_w = 'S') then
				update	cpoe_material
				set		dt_liberacao_enf = clock_timestamp(),
						nm_usuario_lib_enf	= nm_usuario_p
				where	nr_sequencia = nr_seq_reg_item_w
				and		dt_inicio >= (clock_timestamp() + interval '1 days');
			end if;

            select   max(cd_convenio)
            into STRICT  cd_convenio_w
            from   atend_categoria_convenio
            where  nr_atendimento = nr_atendimento_p;

            select  max(cd_material)
            into STRICT  cd_material_w
            from   cpoe_material
            where   nr_sequencia = nr_seq_reg_item_w;

            if (cd_material_w IS NOT NULL AND cd_material_w::text <> '') then
              CALL evento_metas_medicamento(cd_convenio_w, cd_material_w, cd_medico_p, cd_medico_p, nr_atendimento_p, cd_estabelecimento_w, cd_perfil_p, cd_setor_atendimento_w, '', null);
            end if;

            select  max(nr_seq_cpoe_anterior)
            into STRICT    nr_seq_cpoe_anterior_w
            from    cpoe_material
            where   nr_sequencia = nr_seq_reg_item_w;

            update  med_avaliacao_paciente
            set  dt_liberacao  = clock_timestamp()
            where  coalesce(dt_liberacao::text, '') = ''
            and  nr_seq_mat_cpoe  = nr_seq_reg_item_w;

            end;
            when 'N' then --Nutricao
            begin
            update  cpoe_dieta
            set     dt_liberacao_aux = clock_timestamp(),
              cd_setor_atendimento = cd_setor_atendimento_w,
              ie_motivo_prescricao = ie_motivo_prescr_p,
              cd_medico = cd_medico_p,
              ie_adep = ie_adep_p,
				nm_maquina = nm_maquina_w,
				cd_maquina_ip = cd_maquina_ip_w
            where   nr_sequencia = nr_seq_reg_item_w;

			if (ie_medico_lib_tudo_w = 'S') then
				update	cpoe_dieta
				set		dt_liberacao_enf = clock_timestamp(),
						nm_usuario_lib_enf	= nm_usuario_p
				where	nr_sequencia = nr_seq_reg_item_w
				and		dt_inicio >= (clock_timestamp() + interval '1 days');
			end if;


            select  max(nr_seq_cpoe_anterior)
            into STRICT    nr_seq_cpoe_anterior_w
            from    cpoe_dieta
            where   nr_sequencia = nr_seq_reg_item_w;

            if (position('N' in ds_itens_liberados_w) = 0) then
                ds_itens_liberados_w := ds_itens_liberados_w||'N;';
            end if;

            end;
            when 'P' then --Procedimentos
            begin
			select max(cd_setor_atendimento)
		    into STRICT cd_setor_aten_cpoe_proced_w
		    from cpoe_procedimento
		    where nr_sequencia = nr_seq_reg_item_w;

			update  cpoe_procedimento
            set     dt_liberacao_aux = clock_timestamp(),
              cd_setor_atendimento = coalesce(cd_setor_aten_cpoe_proced_w, cd_setor_atendimento_w),
			  cd_setor_liberacao = cd_setor_atendimento_w,
              ie_motivo_prescricao = ie_motivo_prescr_p,
              cd_medico = cd_medico_p,
              ie_adep = ie_adep_p,
				nm_maquina = nm_maquina_w,
				cd_maquina_ip = cd_maquina_ip_w
            where   nr_sequencia = nr_seq_reg_item_w;

			if (ie_medico_lib_tudo_w = 'S') then
				update	cpoe_procedimento
				set		dt_liberacao_enf = clock_timestamp(),
						nm_usuario_lib_enf	= nm_usuario_p
				where	nr_sequencia = nr_seq_reg_item_w
				and		dt_inicio >= (clock_timestamp() + interval '1 days');
			end if;

            select  max(nr_seq_cpoe_anterior)
            into STRICT    nr_seq_cpoe_anterior_w
            from    cpoe_procedimento
            where   nr_sequencia = nr_seq_reg_item_w;

            ds_retorno_aux_w := cpoe_gerar_cpoe_mat_assoc_proc( nr_seq_reg_item_w, nm_usuario_p, cd_perfil_p, ds_retorno_aux_w);
            gera_retorno_liberados(ds_retorno_aux_w);

            end;
            when 'G' then --Gasoterapia
            begin
            update  cpoe_gasoterapia
            set     dt_liberacao_aux = clock_timestamp(),
              cd_setor_atendimento = cd_setor_atendimento_w,
              ie_motivo_prescricao = ie_motivo_prescr_p,
              cd_medico = cd_medico_p,
              ie_adep = ie_adep_p,
				nm_maquina = nm_maquina_w,
				cd_maquina_ip = cd_maquina_ip_w
            where   nr_sequencia = nr_seq_reg_item_w;

			if (ie_medico_lib_tudo_w = 'S') then
				update	cpoe_gasoterapia
				set		dt_liberacao_enf = clock_timestamp(),
						nm_usuario_lib_enf	= nm_usuario_p
				where	nr_sequencia = nr_seq_reg_item_w
				and		dt_inicio >= (clock_timestamp() + interval '1 days');
			end if;


            select  max(nr_seq_cpoe_anterior)
            into STRICT    nr_seq_cpoe_anterior_w
            from    cpoe_gasoterapia
            where   nr_sequencia = nr_seq_reg_item_w;
            end;
            when 'R' then --Recomendacao
            begin
            update  cpoe_recomendacao
            set     dt_liberacao_aux = clock_timestamp(),
              cd_setor_atendimento = cd_setor_atendimento_w,
              ie_motivo_prescricao = ie_motivo_prescr_p,
              cd_medico = cd_medico_p,
              ie_adep = ie_adep_p,
				nm_maquina = nm_maquina_w,
				cd_maquina_ip = cd_maquina_ip_w
            where   nr_sequencia = nr_seq_reg_item_w;

			if (ie_medico_lib_tudo_w = 'S') then
				update	cpoe_recomendacao
				set		dt_liberacao_enf = clock_timestamp(),
						nm_usuario_lib_enf	= nm_usuario_p
				where	nr_sequencia = nr_seq_reg_item_w
				and		dt_inicio >= (clock_timestamp() + interval '1 days');		
			end if;

            select  max(nr_seq_cpoe_anterior)
            into STRICT    nr_seq_cpoe_anterior_w
            from    cpoe_recomendacao
            where   nr_sequencia = nr_seq_reg_item_w;
            end;

            when 'H' then --Hemoterapia
            begin
            update  cpoe_hemoterapia
            set     dt_liberacao_aux = clock_timestamp(),
              cd_setor_atendimento = cd_setor_atendimento_w,
              ie_motivo_prescricao = ie_motivo_prescr_p,
              cd_medico = cd_medico_p,
              ie_adep = ie_adep_p,
				nm_maquina = nm_maquina_w,
				cd_maquina_ip = cd_maquina_ip_w
            where   nr_sequencia = nr_seq_reg_item_w;

			if (ie_medico_lib_tudo_w = 'S') then
				update	cpoe_hemoterapia
				set		dt_liberacao_enf = clock_timestamp(),
						nm_usuario_lib_enf	= nm_usuario_p
				where	nr_sequencia = nr_seq_reg_item_w
				and		dt_inicio >= (clock_timestamp() + interval '1 days');		
			end if;

            select  max(nr_seq_cpoe_anterior)
            into STRICT    nr_seq_cpoe_anterior_w
            from    cpoe_hemoterapia
            where   nr_sequencia = nr_seq_reg_item_w;

            ds_retorno_aux_w := cpoe_gerar_cpoe_mat_assoc_hemo( nr_seq_reg_item_w, nm_usuario_p, cd_perfil_p, ds_retorno_aux_w);
            gera_retorno_liberados(ds_retorno_aux_w);

            end;
            when 'DI' then --Dialysis
            begin
            ie_possui_dialise_w := 'S';
            update  cpoe_dialise
            set     dt_liberacao_aux = clock_timestamp(),
              cd_setor_atendimento = cd_setor_atendimento_w,
              ie_motivo_prescricao = ie_motivo_prescr_p,
              cd_medico = cd_medico_p,
              ie_adep = ie_adep_p,
				nm_maquina = nm_maquina_w,
				cd_maquina_ip = cd_maquina_ip_w
            where   nr_sequencia = nr_seq_reg_item_w;

			if (ie_medico_lib_tudo_w = 'S') then
				update	cpoe_dialise
				set		dt_liberacao_enf = clock_timestamp(),
						nm_usuario_lib_enf	= nm_usuario_p
				where	nr_sequencia = nr_seq_reg_item_w
				and		dt_inicio >= (clock_timestamp() + interval '1 days');	
			end if;

            select  max(nr_seq_cpoe_anterior)
            into STRICT    nr_seq_cpoe_anterior_w
            from    cpoe_dialise
            where   nr_sequencia = nr_seq_reg_item_w;
            end;

            when 'DP' then --Dialysis
            begin
            update  cpoe_dialise
            set     dt_liberacao_aux = clock_timestamp(),
              cd_setor_atendimento = cd_setor_atendimento_w,
              ie_motivo_prescricao = ie_motivo_prescr_p,
              cd_medico = cd_medico_p,
              ie_adep = ie_adep_p,
				nm_maquina = nm_maquina_w,
				cd_maquina_ip = cd_maquina_ip_w
            where   nr_sequencia = nr_seq_reg_item_w;

			if (ie_medico_lib_tudo_w = 'S') then
				update	cpoe_dialise
				set		dt_liberacao_enf = clock_timestamp(),
						nm_usuario_lib_enf	= nm_usuario_p
				where	nr_sequencia = nr_seq_reg_item_w
				and		dt_inicio >= (clock_timestamp() + interval '1 days');
			end if;

            select  max(nr_seq_cpoe_anterior)
            into STRICT    nr_seq_cpoe_anterior_w
            from    cpoe_dialise
            where   nr_sequencia = nr_seq_reg_item_w;
            end;
            when 'AP' then --Anatomia Patologica
            begin
            update  cpoe_anatomia_patologica
            set     dt_liberacao_aux = clock_timestamp(),
              cd_setor_atendimento = cd_setor_atendimento_w,
              ie_motivo_prescricao = ie_motivo_prescr_p,
              cd_medico = cd_medico_p,
				nm_maquina = nm_maquina_w,
				cd_maquina_ip = cd_maquina_ip_w
            where   nr_sequencia = nr_seq_reg_item_w;

			if (ie_medico_lib_tudo_w = 'S') then
				update	cpoe_anatomia_patologica
				set		dt_liberacao_enf = clock_timestamp(),
						nm_usuario_lib_enf	= nm_usuario_p
				where	nr_sequencia = nr_seq_reg_item_w
				and		dt_inicio >= (clock_timestamp() + interval '1 days');
			end if;

            select  max(nr_seq_cpoe_anterior)
            into STRICT    nr_seq_cpoe_anterior_w
            from    cpoe_anatomia_patologica
            where   nr_sequencia = nr_seq_reg_item_w;
            end;
          end case;
        end if;

      end if;

      if (nr_seq_cpoe_anterior_w IS NOT NULL AND nr_seq_cpoe_anterior_w::text <> '') then
        --      ie_opcao_suspender_w        --------->           [254658;M;S,  456786;D;N,  15648;P;S,]
        ie_opcao_suspender_w := ie_opcao_suspender_w || nr_seq_cpoe_anterior_w || ';' || ie_opcao_prescr_w || ';' || 'S' || ', ';
      end if;
    else
      CALL gravar_log_cpoe(substr('CPOE_LIBERACAO DATA INICIO MENOR -' || obter_desc_expressao(712423)
        || '- nr_atendimento_p: ' || nr_atendimento_p
        || '- cd_pessoa_fisica_p: ' || cd_pessoa_fisica_p
        || '- nr_seq_reg_item_w: ' || nr_seq_reg_item_w
        || '- ie_opcao_prescr_w: ' || ie_opcao_prescr_w,1,2000),
        nr_atendimento_p);
    end if;
    end if;
  end loop;

  ds_itens_liberados_p := ds_itens_liberados_w;

  if (ds_itens_rec_ambulatorial_ww IS NOT NULL AND ds_itens_rec_ambulatorial_ww::text <> '') then
    CALL cpoe_generate_prescr_amb(nr_atendimento_p, ds_itens_rec_ambulatorial_ww, nm_usuario_p);
  end if;



  if ((param_rep_580_w = 'N') or (ie_interv_farmacia_w = 'S')) then -- If not prescribe as assistant can generate
    if (ie_opcao_suspender_w IS NOT NULL AND ie_opcao_suspender_w::text <> '') then
	  if ((nr_atendimento_old_w IS NOT NULL AND nr_atendimento_old_w::text <> '') and coalesce(pkg_i18n.get_user_locale, 'pt_BR') = 'de_DE') then
		ds_lista_proc_susp_w := cpoe_suspender_item_prescr('[' || ie_opcao_suspender_w || ']', nr_atendimento_old_w, nm_usuario_p, null, null, ie_interv_farmacia_w, ds_lista_proc_susp_w, ie_liberacao_ang_p, 'S');
	  else
		ds_lista_proc_susp_w := cpoe_suspender_item_prescr('[' || ie_opcao_suspender_w || ']', nr_atendimento_p, nm_usuario_p, null, null, ie_interv_farmacia_w, ds_lista_proc_susp_w, ie_liberacao_ang_p, 'S');
	  end if;
    end if;

    commit;
	
	if (cd_funcao_origem_w = 281) and (ie_copia_diaria_p = 'N') and (dt_inicio_quimio_w IS NOT NULL AND dt_inicio_quimio_w::text <> '') and (ie_oncologia_w = 'S') and
		(dt_inicio_quimio_w >  (dt_referencia_w + 3)) then
		
		if (nr_prescricao_p > 0) then
			select	max(dt_inicio_prescr)
			into STRICT		dt_inicio_quimio_w
			from		prescr_medica
			where	nr_prescricao = nr_prescricao_p;
		end if;	
			
		dt_referencia_w := dt_inicio_quimio_w;
	end if;

    SELECT * FROM cpoe_gerar_prescricao(  nr_atendimento_p, dt_referencia_w, cd_estabelecimento_w, cd_perfil_p, cd_setor_atendimento_w, nm_usuario_p, ds_itens_liberados_ww, cd_pessoa_fisica_p, ie_copia_diaria_p, ie_interv_farmacia_w, ie_motivo_prescr_p, ie_liberacao_ang_p, nr_prescricao_p, nr_seq_consulta_oft_p, nr_seq_pend_pac_acao_p, 'N', coalesce(ie_adep_p,'S'), nm_usuario_validacao_p, null, null, ie_prescr_adep_p) INTO STRICT ie_inconsistencia_out_p, nr_prescricao_w, ds_prescr_geradas_w;

  end if;




  commit;
    if (nm_usuario_validacao_p IS NOT NULL AND nm_usuario_validacao_p::text <> '') then
        cpoe_gerar_prescr_medica_compl(nr_prescricao_w,nm_usuario_p,nm_usuario_validacao_p);
    end if;

  nr_prescricao_out_p := nr_prescricao_w;
  ds_prescr_geradas_full_p := ds_prescr_geradas_w;

  if (coalesce(nr_prescricao_w::text, '') = '') then
    CALL cpoe_gerar_rollback_prescr(itens_liberar_p,nm_usuario_p);
	ds_prescr_geradas_full_p := null;
  end if;

  ds_lista_proc_susp_out_p := ds_lista_proc_susp_w;

exception when others then
	ds_exception_w  := to_char(sqlerrm);

	CALL gravar_log_cpoe(substr('CPOE_LIBERACAO EXCEPTION -'|| obter_desc_expressao(712423)
		|| chr(13) || 'cd_estabelecimento_w: ' || cd_estabelecimento_w
		|| chr(13) || 'cd_setor_atendimento_p: ' || cd_setor_atendimento_p
		|| chr(13) || 'cd_estabelecimento_p: '|| cd_estabelecimento_p
		|| chr(13) || 'cd_perfil_p: ' || cd_perfil_p
		|| chr(13) || 'nr_atendimento_p: ' || nr_atendimento_p
		|| chr(13) || 'itens_liberar_p: ' || itens_liberar_p			
		|| chr(13) || 'ds_prescr_geradas_w: ' || ds_prescr_geradas_w
		|| chr(13) || 'nm_usuario_p: ' || nm_usuario_p
		|| chr(13) || 'ds_itens_liberados_p: ' || ds_itens_liberados_p
		|| chr(13) || 'cd_pessoa_fisica_p: ' || cd_pessoa_fisica_p
		|| chr(13) || 'ie_liberacao_ang_p: ' || ie_liberacao_ang_p
		|| chr(13) || obter_desc_expressao(646385) ||': ' || to_char(dt_referencia_w, 'dd/mm/yyyy hh24:mi:ss')
		|| chr(13) || obter_desc_expressao(504115) || ds_exception_w,1,2000),
	  nr_atendimento_p);

end;

	CALL gravar_log_cpoe(substr('CPOE_LIBERACAO - FIM DA LIBERACAO'||
				' nr_atendimento_p: '||nr_atendimento_p ||
				' cd_setor_atendimento_p: ' || cd_setor_atendimento_p ||
				' cd_perfil_p: ' || cd_perfil_p ||
				' nm_usuario_p: ' || nm_usuario_p ||
				' cd_setor_atendimento_w: ' || cd_setor_atendimento_w ||
				' itens_liberar_p: ' || itens_liberar_p ||
				' ds_itens_liberados_p :' || ds_itens_liberados_p ||
				' cd_estabelecimento_p: ' || cd_estabelecimento_p ||
				' nr_prescricao_out_p: ' || nr_prescricao_out_p ||			
				' ds_prescr_geradas_w: ' || ds_prescr_geradas_w ||	
				' wheb_usuario_pck.get_cd_estabelecimento -  '||wheb_usuario_pck.get_cd_estabelecimento||
				' param_REP_11_w -  '|| param_REP_11_w ||
				' cd_setor_atendimento_w: ' || cd_setor_atendimento_w ||
				' wheb_usuario_pck.get_nm_usuario -  '||wheb_usuario_pck.get_nm_usuario||
				' obter_perfil_ativo -  '||obter_perfil_ativo||				
				' dt_fim_liberacao: ' || to_char(clock_timestamp(),'dd/mm/yyyy hh24:mi:ss'),1,2000),
				nr_atendimento_p);


end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cpoe_liberacao (cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, cd_setor_atendimento_p setor_atendimento.cd_setor_atendimento%type, cd_perfil_p perfil.cd_perfil%type, nr_atendimento_p atendimento_paciente.nr_atendimento%type, itens_liberar_p text, nm_usuario_p usuario.nm_usuario%type, ds_itens_liberados_p INOUT text, ie_inconsistencia_out_p INOUT text, cd_pessoa_fisica_p pessoa_fisica.cd_pessoa_fisica%type default null, itens_recalcular_p text default null, ie_interv_farmacia_p text default 'N', ie_liberacao_ang_p text default 'N', ie_motivo_prescr_p text default null, cd_medico_p medico.cd_pessoa_fisica%type default null, nr_prescricao_out_p INOUT bigint DEFAULT NULL, ds_lista_proc_susp_out_p INOUT text DEFAULT NULL, ds_inconsist_lib_out_p INOUT text DEFAULT NULL, nr_prescricao_p bigint default null, nr_seq_consulta_oft_p bigint default null, nr_seq_pend_pac_acao_p bigint default null, ie_adep_p text default 'S', nr_seq_revalidation_rule_p bigint default null, cd_departamento_p bigint default null, ds_prescr_geradas_full_p INOUT text DEFAULT NULL, nm_usuario_validacao_p usuario.nm_usuario%type default null, ie_copia_diaria_p text default 'N', ie_prescr_adep_p text default null) FROM PUBLIC;

