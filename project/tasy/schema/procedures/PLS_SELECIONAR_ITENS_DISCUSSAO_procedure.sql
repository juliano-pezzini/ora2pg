-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_selecionar_itens_discussao (nr_seq_lote_contest_p bigint, nr_seq_contestacao_p bigint, nr_seq_conta_proc_p bigint, nr_seq_conta_mat_p bigint, nm_usuario_p text) AS $body$
DECLARE


nr_seq_conta_w		bigint;
nr_seq_lote_w		bigint;
nr_seq_discussao_w	bigint;
qt_aceita_w		double precision;
qt_contestada_w		double precision;
qt_item_w		double precision;
vl_aceito_w		double precision;
vl_contestado_w		double precision;
vl_item_w		double precision;
vl_recurso_w		double precision;
qt_reg_proc_w		bigint := 0;
qt_reg_mat_w		bigint := 0;
vl_ndc_w		double precision:= 0;
qt_ndc_w		double precision:= 0;
vl_reconh_orig_w	double precision:= 0;
qt_reconh_orig_w	double precision:= 0;


BEGIN
select	max(nr_sequencia)
into STRICT	nr_seq_lote_w
from	pls_lote_discussao
where	nr_seq_lote_contest	= nr_seq_lote_contest_p
and	ie_status		= 'A';

if (coalesce(nr_seq_lote_w::text, '') = '') then          /* Verifica se ja existe lote */
	select	nextval('pls_lote_discussao_seq')
	into STRICT	nr_seq_lote_w
	;

	insert into pls_lote_discussao(nr_sequencia,
		dt_atualizacao,
		nm_usuario,
		dt_referencia,
		ie_status,
		nr_seq_lote_contest,
		nr_lote_contabil)
	values (nr_seq_lote_w,
		clock_timestamp(),
		nm_usuario_p,
		clock_timestamp(),
		'A',
		nr_seq_lote_contest_p,
		0);
end if;

select	max(nr_sequencia)
into STRICT	nr_seq_discussao_w
from	pls_contestacao_discussao
where	nr_seq_contestacao	= nr_seq_contestacao_p
and	nr_seq_lote		= nr_seq_lote_w
and	ie_status		= 'A';

if (coalesce(nr_seq_discussao_w::text, '') = '') then      /* Verifica se ja existe a conta em discussão */
	select	nextval('pls_contestacao_discussao_seq')
	into STRICT	nr_seq_discussao_w
	;

	select	coalesce(vl_conta,0)
	into STRICT	vl_recurso_w
	from	pls_contestacao
	where	nr_sequencia = nr_seq_contestacao_p;

	insert into pls_contestacao_discussao(nr_sequencia,
		dt_atualizacao,
		nm_usuario,
		ie_status,
		nr_seq_contestacao,
		nr_seq_lote,
		vl_negado,
		vl_recurso)
	values (nr_seq_discussao_w,
		clock_timestamp(),
		nm_usuario_p,
		'A',
		nr_seq_contestacao_p,
		nr_seq_lote_w,
		0,
		vl_recurso_w);
end if;

if (nr_seq_conta_proc_p IS NOT NULL AND nr_seq_conta_proc_p::text <> '') then  /* Insere procedimento selecionado */
	select	nr_seq_conta_proc
	into STRICT	nr_seq_conta_w
	from	pls_contestacao_proc
	where	nr_sequencia = nr_seq_conta_proc_p;

	select	count(*)
	into STRICT	qt_reg_proc_w
	from	pls_discussao_proc
	where	nr_seq_conta_proc = nr_seq_conta_w;

	if (qt_reg_proc_w = 0) then		/* Evitar a duplicação do procedimento */
		select	coalesce(qt_aceita,0),
			coalesce(qt_contestada,0),
			coalesce(qt_procedimento,0),
			coalesce(vl_aceito,0),
			coalesce(vl_contestado,0),
			coalesce(vl_procedimento,0)
		into STRICT	qt_aceita_w,
			qt_contestada_w,
			qt_item_w,
			vl_aceito_w,
			vl_contestado_w,
			vl_item_w
		from	pls_contestacao_proc
		where	nr_sequencia = nr_seq_conta_proc_p;

		if (vl_contestado_w > vl_item_w) then
			vl_reconh_orig_w := abs(vl_contestado_w - vl_item_w);
			qt_reconh_orig_w := qt_item_w;
			qt_item_w := 0;
		end if;

		insert into pls_discussao_proc(nr_sequencia,
			dt_atualizacao,
			nm_usuario,
			nr_seq_conta_proc,
			nr_seq_discussao,
			qt_aceita,
			qt_contestada,
			qt_negada,
			qt_recurso,
			vl_aceito,
			vl_contestado,
			vl_negado,
			vl_recurso,
			nr_lote_contabil,
			vl_ndc,
			qt_ndc,
			vl_reconh_orig,
			qt_reconh_orig)
		values (nextval('pls_discussao_proc_seq'),
			clock_timestamp(),
			nm_usuario_p,
			nr_seq_conta_w,
			nr_seq_discussao_w,
			0,--qt_aceita_w,
			qt_contestada_w,
			0,
			qt_item_w,
			0,--vl_aceito_w,
			vl_contestado_w,
			0,
			vl_item_w,
			0,
			vl_ndc_w,
			qt_ndc_w,
			vl_reconh_orig_w,
			qt_reconh_orig_w);
	end if;
end if;

if (nr_seq_conta_mat_p IS NOT NULL AND nr_seq_conta_mat_p::text <> '') then  /* Insere material selecionado */
	select	nr_seq_conta_mat
	into STRICT	nr_seq_conta_w
	from	pls_contestacao_mat
	where	nr_sequencia = nr_seq_conta_mat_p;

	select	count(*)
	into STRICT	qt_reg_mat_w
	from	pls_discussao_mat
	where	nr_seq_conta_mat = nr_seq_conta_w;

	if (qt_reg_mat_w = 0) then		/* Evitar a duplicação do material */
		select	coalesce(qt_aceita,0),
			coalesce(qt_contestada,0),
			coalesce(qt_material,0),
			coalesce(vl_aceito,0),
			coalesce(vl_contestado,0),
			coalesce(vl_material,0)
		into STRICT	qt_aceita_w,
			qt_contestada_w,
			qt_item_w,
			vl_aceito_w,
			vl_contestado_w,
			vl_item_w
		from	pls_contestacao_mat
		where	nr_sequencia = nr_seq_conta_mat_p;

		if (vl_contestado_w > vl_item_w) then
			vl_reconh_orig_w := abs(vl_contestado_w - vl_item_w);
			qt_reconh_orig_w := qt_item_w;
			qt_item_w := 0;
		end if;

		insert into pls_discussao_mat(nr_sequencia,
			dt_atualizacao,
			nm_usuario,
			nr_seq_conta_mat,
			nr_seq_discussao,
			qt_aceita,
			qt_contestada,
			qt_negada,
			qt_recurso,
			vl_aceito,
			vl_atual,
			vl_contestado,
			vl_material,
			vl_negado,
			vl_original,
			vl_recurso,
			nr_lote_contabil,
			vl_ndc,
			qt_ndc,
			vl_reconh_orig,
			qt_reconh_orig)
		values (nextval('pls_discussao_mat_seq'),
			clock_timestamp(),
			nm_usuario_p,
			nr_seq_conta_w,
			nr_seq_discussao_w,
			0,--qt_aceita_w,
			qt_contestada_w,
			0,
			qt_item_w,
			0,--vl_aceito_w,
			0,
			vl_contestado_w,
			vl_item_w,
			0,
			0,
			vl_item_w,
			0,
			vl_ndc_w,
			qt_ndc_w,
			vl_reconh_orig_w,
			qt_reconh_orig_w);
	end if;
end if;

commit;

if (qt_reg_proc_w = 0) and (qt_reg_mat_w = 0) then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(242493);
elsif (qt_reg_proc_w > 0) or (qt_reg_mat_w > 0) then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(242494);
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_selecionar_itens_discussao (nr_seq_lote_contest_p bigint, nr_seq_contestacao_p bigint, nr_seq_conta_proc_p bigint, nr_seq_conta_mat_p bigint, nm_usuario_p text) FROM PUBLIC;

