-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_gerar_ocorrencia_item ( ie_tipo_item_p text, ie_conta_medica_p text, cd_procedimento_p bigint, ie_origem_proced_p bigint, nr_seq_material_p bigint, ie_tipo_conta_web_p text, ie_autorizacao_p text, ie_tipo_conta_p text, nr_seq_segurado_p bigint, nr_seq_guia_plano_p bigint, nr_seq_requisicao_p bigint, nr_seq_conta_p bigint, nr_seq_proc_p bigint, nr_seq_mat_p bigint, ie_exige_medico_p text, nr_seq_grupo_contrato_p bigint, dt_referencia_p timestamp, qt_item_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text, ie_ocorrencia_p INOUT text, nr_seq_ocorrencia_p bigint, ie_reconsistencia_p text, ie_pagto_fat_p text, ie_sexo_p text, ie_tipo_segurado_p text, qt_idade_p text, qt_idade_meses_p bigint, nr_seq_tipo_acomodacao_p bigint, ie_calculo_coparticipacao_p text, nr_seq_plano_p bigint, nr_seq_motivo_glosa_p bigint, ie_auditoria_p text, nr_seq_prestador_exec_p bigint, cd_prestador_exec_p text, nr_seq_tipo_acomod_conta_p bigint, nr_seq_guia_p bigint, nr_seq_estrut_mat_p bigint, cd_area_procedimento_p bigint, cd_especialidade_p bigint, cd_grupo_proc_p bigint, nr_seq_grupo_rec_p bigint) AS $body$
DECLARE
 /*Definir se as ocorrências devem ser geradas para pagamento ou faturamento ( P | F )*/
 
nr_seq_regra_item_w		bigint;
ie_nao_informado_w		varchar(10);
nr_seq_ocorrencia_w		bigint;
nr_seq_ocorrencia_benef_w	bigint;
ie_tipo_item_w			varchar(10);
ie_tipo_conta_w			varchar(10);
vl_item_w			double precision;
ie_tipo_despesa_w		varchar(1)	:= null;
ie_nota_fiscal_w		varchar(1)	:= null;
ie_fornecedor_w			varchar(1)	:= null;
nr_seq_estrutura_w		bigint;
ie_estrutura_w			varchar(1)	:= 'S';
cd_procedimento_w		bigint;
nr_seq_restricao_w		bigint;
qt_minima_w			bigint;
qt_maxima_w			bigint;
ie_consiste_qtd_w		varchar(1)	:= 'N';
ie_consiste_sexo_w		varchar(1)	:= 'N';
ie_consiste_idade_w		varchar(1)	:= 'N';
ie_sexo_mat_w			varchar(2);
qt_idade_min_mat_w		integer;
qt_idade_max_mat_w		integer;
ie_bloqueia_custo_op_w		varchar(5)	:= 'N';
ie_bloqueia_pre_pag_w		varchar(5)	:= 'N';
ie_bloqueia_intercambio_w	varchar(5)	:= 'N';
ie_bloqueia_prod_nao_reg_w	varchar(5)	:= 'N';
ie_bloqueia_prod_reg_w		varchar(5)	:= 'N';
ie_classif_sip_w		varchar(5)	:= 'N';
ie_taxa_intercambio_w		varchar(5)	:= 'N';
ie_pacote_w			varchar(1);
nr_seq_conta_princ_w		bigint;
ie_gerar_oc_pacote_w		varchar(1)	:= 'N';
ie_nao_utilizado_w		varchar(1);
qt_item_autorizado_w		bigint;
qt_item_solic_w			double precision;
ds_observacao_w			varchar(4000)	:= '';
ie_autorizacao_especial_w	varchar(1)	:= 'N';
ie_mat_espec_aut_w		varchar(1);
ie_carater_internacao_w		varchar(2);
ie_tipo_internado_w		varchar(2);
ie_carater_regra_w		varchar(2);
ie_via_acesso_w			varchar(1);
ie_tipo_internado_regra_w	varchar(2);
nr_nota_fiscal_mat_w		numeric(20);
ie_coparticipacao_w		varchar(10);
ie_co_preco_operadora_w		varchar(10);
ie_tipo_conta_web_w		varchar(2);
vl_calculado_w			double precision;	
vl_apresentado_w		double precision;
vl_max_item_w			double precision;
vl_minimo_item_w		double precision;
ie_consistencia_valor_w		varchar(1);
qt_idade_min_w			integer;
qt_idade_max_w			integer;
ie_unid_tempo_idade_w		varchar(2);		
ie_sem_evento_w			varchar(2);
qt_eventos_pagto_w		bigint;
qt_ocorrencia_w			bigint;
qt_idade_minima_w		integer;
qt_idade_maxima_w		integer;
ie_sexo_exclusivo_w		varchar(1);
ie_ocorrencia_w			varchar(1) := 'N';
nr_seq_grupo_produto_w		integer;	
nr_seq_regra_duplic_w		bigint;
ie_duplicidade_out_w		varchar(2);
nr_seq_grupo_material_w		bigint;
ie_grupo_material_w		varchar(1)	:= 'S';

ie_exige_hora_item_w		varchar(1);
ie_exige_hora_final_w		varchar(1);
dt_inicio_proc_w		timestamp;
dt_fim_proc_w			timestamp;
ie_alterado_analise_w 		varchar(1) := 'N';
ie_grupo_produto_w		varchar(1) := 'S';
qt_procedimento_w		double precision := 0;
qt_material_w			double precision := 0;
ie_fracionado_w			varchar(1) := 'N';

ds_out_w				varchar(4000);
nr_seq_conta_duplic_out_w		bigint;
nr_seq_proc_partic_out_w		bigint;
tx_intercambio_w		double precision;
tx_intercambio_imp_w		double precision;
cd_guia_w			varchar(20);

cd_procedimento_regra_w		bigint;
ie_origem_proced_regra_w	bigint;

nr_seq_prest_fornec_w		bigint;
nr_seq_item_sip_w		bigint;
qt_solic_lib_mat_med_w		bigint;

nr_seq_estrut_regra_w		bigint;
ie_estrut_mat_w			varchar(1);
ie_retorno_w			varchar(1);
nr_seq_prestador_pag_w		bigint;

dt_inicio_vigencia_w		timestamp;
dt_fim_vigencia_w		timestamp;
ie_tipo_item_ww			varchar(10);
nr_seq_prestador_exec_w		bigint;
cd_prestador_exec_w		varchar(20);
ie_tipo_conta_ww		varchar(10);
ie_autorizacao_w		varchar(10);
ie_conta_medica_w		varchar(10);
ie_origem_proced_w		bigint;
cd_area_procedimento_w		bigint;
cd_especialidade_w		bigint;
cd_grupo_proc_w			bigint;
nr_seq_material_w		bigint;
ie_tipo_desp_proc_w		varchar(10);
ie_tipo_despesa_mat_w		varchar(10);
ie_exige_nf_w			varchar(10);
ie_exige_fornecedor_w		varchar(10);
ie_exige_medico_w		varchar(10);
nr_seq_grupo_contrato_w		bigint;
ie_consiste_qtd_ww		varchar(1)	:= 'N';
ie_consiste_sexo_ww		varchar(1)	:= 'N';
ie_consiste_idade_ww		varchar(1)	:= 'N';
ie_classif_sip_ww		varchar(5)	:= 'N';
ie_pacote_honorario_w		varchar(10);
ie_mat_autorizacao_esp_w	varchar(10);
nr_seq_grupo_rec_w		bigint;
ie_via_acesso_ww		varchar(1);
ie_tipo_segurado_w		varchar(10);
ie_sexo_w			varchar(10);
ie_bloqueio_mat_w		varchar(10);
ie_regra_valor_copartic_w	varchar(10);
ie_regra_valor_co_w		varchar(10);
nr_seq_plano_w			bigint;
nr_seq_tipo_acomod_conta_w	bigint;
nr_seq_tipo_acomodacao_w	bigint;
ie_qtd_item_fracionada_w	varchar(10);
ie_digitacao_portal_w		varchar(10);
ie_complemento_conta_w		varchar(10);
ie_internado_w			varchar(10);
ie_situacao_w			varchar(10);
ie_exige_autorizacao_w		varchar(1) := 'N';

C01 CURSOR FOR 
	SELECT	a.nr_sequencia, 
		a.ie_nao_informado, 
		a.nr_seq_ocorrencia, 
		nr_seq_estrutura, 
		a.vl_max_item, 
		coalesce(a.vl_minimo_item,0), 
		a.ie_consistencia_valor, 
		coalesce(a.ie_nao_utilizado,'N'), 
		a.qt_idade_min, 
		a.qt_idade_max, 
		a.ie_unid_tempo_idade, 
		ie_sem_evento, 
		nr_seq_regra_duplic, 
		a.nr_seq_grupo_material, 
		a.ie_exige_hora_item, 
		a.ie_exige_hora_final, 
		a.nr_seq_grupo_produto, 
		a.ie_taxa_intercambio, 
		a.cd_procedimento, 
		a.ie_origem_proced, 
		a.nr_seq_estrutura_mat, 
		a.nr_seq_prestador_pag, 
		a.dt_inicio_vigencia, 
		a.dt_fim_vigencia, 
		a.ie_tipo_item, 
		a.nr_seq_prestador_exec, 
		a.cd_prestador_exec, 
		a.ie_tipo_conta, 
		a.ie_autorizacao, 
		a.ie_conta_medica, 
		a.cd_procedimento, 
		a.ie_origem_proced, 
		a.cd_area_procedimento, 
		a.cd_especialidade, 
		a.cd_grupo_proc, 
		a.nr_seq_material, 
		a.ie_tipo_desp_proc, 
		a.ie_tipo_despesa_mat, 
		a.ie_exige_nf, 
		a.ie_exige_fornecedor, 
		a.ie_exige_medico, 
		a.nr_seq_grupo_contrato, 
		a.ie_consiste_qtd, 
		a.ie_consiste_sexo, 
		a.ie_consiste_idade, 
		a.ie_classif_sip, 
		a.ie_pacote_honorario, 
		a.ie_mat_autorizacao_esp, 
		a.nr_seq_grupo_rec, 
		a.ie_via_acesso, 
		a.ie_tipo_segurado, 
		a.ie_sexo, 
		a.ie_bloqueio_mat, 
		a.ie_regra_valor_copartic, 
		a.ie_regra_valor_co, 
		a.nr_seq_plano, 
		a.nr_seq_tipo_acomod_conta, 
		a.nr_seq_tipo_acomodacao, 
		a.ie_qtd_item_fracionada, 
		a.ie_digitacao_portal, 
		a.ie_complemento_conta, 
		a.ie_situacao, 
		a.ie_carater_internacao, 
		a.ie_tipo_internado 
	from	pls_ocorrencia_regra_item	a 
	where	a.nr_seq_ocorrencia	= nr_seq_ocorrencia_p;
	--and	a.ie_situacao = 'A' 
	/*and	trunc(dt_referencia_p) between trunc(nvl(a.dt_inicio_vigencia, sysdate)) and trunc(fim_dia(nvl(a.dt_fim_vigencia,dt_referencia_p))) 
	and	((a.ie_tipo_item = ie_tipo_item_w) or (ie_tipo_item = 'A')) 
	and	((a.nr_seq_prestador_exec is null) or (a.nr_seq_prestador_exec = nr_seq_prestador_exec_p)) 
	and	((a.cd_prestador_exec is null) or (a.cd_prestador_exec = nvl(cd_prestador_exec_p,'0'))) 
	and	((a.ie_tipo_conta = 'A') or (a.ie_tipo_conta = ie_tipo_conta_w)) 
	and	((nvl(a.ie_autorizacao,'N') = ie_autorizacao_p) or 
		(nvl(a.ie_conta_medica,'N') = ie_conta_medica_p)) 
	and	((a.cd_procedimento is null) or (a.cd_procedimento = nvl(cd_procedimento_p,0) 
	and	(a.ie_origem_proced = nvl(ie_origem_proced_p,0)))) 
	and	((a.cd_area_procedimento is null) or (a.cd_area_procedimento = nvl(cd_area_procedimento_p,0))) 
	and	((a.cd_especialidade is null) or (a.cd_especialidade = nvl(cd_especialidade_p,0))) 
	and	((a.cd_grupo_proc is null) or (a.cd_grupo_proc = nvl(cd_grupo_proc_p,0))) 
	and	((a.nr_seq_material is null) or (a.nr_seq_material = nvl(nr_seq_material_p,0))) 
	and	((ie_autorizacao_p = 'S') 
	or	((ie_tipo_despesa_w = nvl(ie_tipo_despesa_mat, ie_tipo_despesa_w) and (nvl(ie_tipo_desp_proc,0)=0) and (ie_tipo_item_w = 'M') and (nvl(nr_seq_conta_p,0) > 0)) 
	or	(ie_tipo_despesa_w = nvl(ie_tipo_desp_proc,  ie_tipo_despesa_w) and (nvl(ie_tipo_despesa_mat,0)=0) and (ie_tipo_item_w = 'P') and (nvl(nr_seq_conta_p,0) > 0)))) 
	and	((nvl(ie_tipo_item_w,'P') = 'P') or 		 
		((ie_tipo_item_w = 'M') and 
		((nvl(ie_exige_nf,'N') = 'N') or 
		(ie_exige_nf = 'S' and ie_nota_fiscal_w = 'S' and (nvl(nr_nota_fiscal_mat_w,0) = 0)) or 
		(ie_exige_nf = 'M' and (nvl(nr_nota_fiscal_mat_w,0) = 0))))) 
	and	((nvl(ie_exige_fornecedor,'N') = 'N')	or (nvl(ie_exige_fornecedor,'N') = nvl(ie_fornecedor_w,'N'))) 
	and	((nvl(ie_exige_medico,'N') = 'N')	or (nvl(ie_exige_medico,'N') <> ie_exige_medico_p)) 
	and	((nvl(nr_seq_grupo_contrato,0) = nvl(nr_seq_grupo_contrato_p,0))or (nr_seq_grupo_contrato is null)) 
	and	((a.ie_carater_internacao is null) or ((a.ie_carater_internacao = ie_carater_internacao_w) and (a.ie_carater_internacao is not null))) 
	and 	((a.ie_tipo_internado is null) or ((a.ie_tipo_internado = ie_tipo_internado_w) and (a.ie_tipo_internado is not null))) 
	and	((ie_consiste_qtd = 'N')  or (ie_consiste_qtd = ie_consiste_qtd_w)) 
	and	((ie_consiste_sexo = 'N') or (ie_consiste_sexo = ie_consiste_sexo_w)) 
	and	((ie_consiste_idade = 'N') or (ie_consiste_idade = ie_consiste_idade_w)) 
	and	((ie_classif_sip = 'N')  or (ie_classif_sip_w = 'N')) 
	and	(((nvl(ie_pacote_honorario,'N') = 'N')) or ((nvl(ie_pacote_honorario,'N') = 'S') and (nvl(ie_gerar_oc_pacote_w,'N') = 'S') and (ie_tipo_despesa_w <> 3))) 
	and	((nvl(ie_nao_utilizado,'N') = 'N') or (qt_item_solic_w < qt_item_autorizado_w)) 
	and	((nvl(ie_mat_autorizacao_esp,'N') = 'N') or (ie_mat_autorizacao_esp = 'S' and ie_autorizacao_especial_w = 'S' and ie_mat_espec_aut_w = 'N')) 
	and	((a.nr_seq_grupo_rec is null) or (a.nr_seq_grupo_rec = nr_seq_grupo_rec_p)) 
	and	((nvl(a.ie_via_acesso,'X') = 'X') or (nvl(a.ie_via_acesso,'X') = ie_via_acesso_w))	 
	and	((a.ie_tipo_segurado is null) or (a.ie_tipo_segurado = ie_tipo_segurado_p ))	 
	and	((a.ie_sexo is null) or	( a.ie_sexo = ie_sexo_p)) 
	and	((a.ie_bloqueio_mat is null) or (a.ie_bloqueio_mat in (	ie_bloqueia_custo_op_w, 
									ie_bloqueia_pre_pag_w, 
									ie_bloqueia_intercambio_w, 
									ie_bloqueia_prod_nao_reg_w, 
									ie_bloqueia_prod_reg_w ))) 
	and	((ie_calculo_coparticipacao_p	= 'O' and ((nvl(ie_regra_valor_copartic,'N') = 'N') or (nvl(ie_regra_valor_copartic,'N') = 'S' and nvl(ie_coparticipacao_w,'N') = 'N'))) or (ie_calculo_coparticipacao_p <> 'O')) 
	and	((nvl(ie_regra_valor_co,'N') = 'N') or nvl(ie_regra_valor_co,'N') = 'S' and nvl(ie_co_preco_operadora_w,'N') = 'N')	 
	and	((a.nr_seq_plano is null) or ( a.nr_seq_plano = nr_seq_plano_p )) 
	and	( (a.nr_seq_tipo_acomod_conta is null) or (a.nr_seq_tipo_acomod_conta = nr_seq_tipo_acomod_conta_p ) ) -- acomodacao da conta 
	and	((a.nr_seq_tipo_acomodacao is null) or (a.nr_seq_tipo_acomodacao = nr_seq_tipo_acomodacao_p )) --acomodacao do produto 
	and 	((nvl(a.ie_qtd_item_fracionada,'N') = 'N') or (( a.ie_qtd_item_fracionada = 'S') and (ie_fracionado_w = 'S'))) 
	and	((ie_tipo_conta_web_w = 'X') or 
		 (ie_tipo_conta_web_w = 'D' and a.ie_digitacao_portal = 'S') or 
		 (ie_tipo_conta_web_w = 'C' and a.ie_complemento_conta = 'S')) 
	/*and	(nvl(b.ie_situacao,'A') = 'A') 
	and	(((ie_tipo_glosa 	in ('A', 'P')) 		and (ie_pagto_fat_p = 'P')) or 
		 ((ie_tipo_glosa 	= 'F') 			and (ie_pagto_fat_p = 'F'))) 
	and	ie_glosa		= 'N'			--Não precisa consistir regras de glosa interna.*/ 
 
begin 
 
/* Parâmetro para definir o tipo de conta digitada no portal 
C - Complemento de contas web 
D - Digitação de contas web 
*/
 
ie_tipo_conta_web_w	:= coalesce(ie_tipo_conta_web_p, 'X');
qt_item_solic_w		:= 0;

/* Obter parâmetros da conta médica */
 
 
if (coalesce(nr_seq_proc_p,0) <> 0) then 
	ie_tipo_item_w	:= 'P';

	if (coalesce(nr_seq_conta_p,0) > 0) then 
		;
BEGIN
		select	ie_tipo_despesa, 
			ie_via_acesso, 
			ie_coparticipacao, 
			ie_co_preco_operadora, 
			qt_procedimento_imp, 
			tx_intercambio, 
			tx_intercambio_imp, 
			nr_seq_item_sip, 
			nr_seq_evento, 
			vl_procedimento, 
			vl_procedimento_imp, 
			dt_inicio_proc, 
			dt_fim_proc, 
			ie_exige_autorizacao 
		into STRICT	ie_tipo_despesa_w, 
			ie_via_acesso_w, 
			ie_coparticipacao_w, 
			ie_co_preco_operadora_w, 
			qt_procedimento_w, 
			tx_intercambio_w, 
			tx_intercambio_imp_w, 
			nr_seq_item_sip_w, 
			qt_eventos_pagto_w, 
			vl_calculado_w, 
			vl_apresentado_w, 
			dt_inicio_proc_w, 
			dt_fim_proc_w, 
			ie_exige_autorizacao_w 
		from	pls_conta_proc 
		where	nr_sequencia	= nr_seq_proc_p;
		exception 
		when others then 
			nr_seq_item_sip_w	:= 0;
			qt_eventos_pagto_w	:= null;
			dt_inicio_proc_w	:= null;
			dt_fim_proc_w		:= null;
		end;
		 
		if (coalesce(tx_intercambio_w::text, '') = '') then 
			tx_intercambio_w	:= 0;
		end if;	
		if (coalesce(tx_intercambio_imp_w::text, '') = '') then 
			tx_intercambio_imp_w	:= 0;
		end if;
		 
		if (coalesce(vl_calculado_w::text, '') = '') then 
			vl_calculado_w		:= 0;
		end if;
		 
		if (coalesce(vl_apresentado_w::text, '') = '') then 
			vl_apresentado_w	:= 0;
		end if;
		 
		/*OS - 283335 - Utilizado em ocorrências de SEM CLASSIFICAÇÃO SIP*/
 
		if (ie_conta_medica_p = 'S') then 
			ie_classif_sip_w	:= 'S';
			if (coalesce(nr_seq_item_sip_w,0) = 0) then 
				ie_classif_sip_w	:= 'N';
			end if;
		end if;
		begin 
		select	coalesce(cd_guia_referencia,cd_guia), 
			ie_carater_internacao			 
		into STRICT	cd_guia_w, 
			ie_carater_internacao_w			 
		from	pls_conta 
		where	nr_sequencia = nr_seq_conta_p;		
		exception 
		when others then 
			cd_guia_w		:= '';
			ie_carater_internacao_w := '';
		end;
		 
		ie_internado_w	:= pls_obter_se_internado(nr_seq_conta_p,'');
		 
		if (ie_internado_w = 'S') then 
			ie_tipo_internado_w	:= 'I';
		else 
			ie_tipo_internado_w	:= 'A';
		end if;
		 
		if (cd_guia_w IS NOT NULL AND cd_guia_w::text <> '') then 
			select	sum(a.qt_procedimento_imp) 
			into STRICT	qt_item_solic_w 
			from	pls_conta_proc	a, 
				pls_conta	b 
			where	b.nr_seq_segurado 	= nr_seq_segurado_p 
			and	a.cd_procedimento	= cd_procedimento_p 
			and	a.ie_origem_proced	= ie_origem_proced_p 
			and	a.nr_seq_conta		= b.nr_sequencia 
			and	(((b.cd_guia		= cd_guia_w) 
			and (coalesce(b.cd_guia_referencia::text, '') = '')) 
			or (b.cd_guia_referencia = cd_guia_w)) 
			and	(qt_procedimento_imp IS NOT NULL AND qt_procedimento_imp::text <> '');
			 
			select	sum(b.qt_autorizada) 
			into STRICT	qt_item_autorizado_w 
			from	pls_guia_plano_proc	b, 
				pls_guia_plano		a 
			where	a.nr_sequencia 		= b.nr_seq_guia 
			and	((a.cd_guia		= cd_guia_w) 
			or (a.cd_guia_principal 	= cd_guia_w)) 
			and	a.nr_seq_segurado	= nr_seq_segurado_p 
			and	b.cd_procedimento	= cd_procedimento_p 
			and	b.ie_origem_proced	= ie_origem_proced_p 
			and	(b.qt_autorizada IS NOT NULL AND b.qt_autorizada::text <> '');
		else 
			select	sum(qt_procedimento_imp) 
			into STRICT	qt_item_solic_w 
			from	pls_conta_proc 
			where	nr_seq_conta		= nr_seq_conta_p 
			and	cd_procedimento		= cd_procedimento_p 
			and	ie_origem_proced	= ie_origem_proced_p 
			and	(qt_procedimento_imp IS NOT NULL AND qt_procedimento_imp::text <> '');
		end if;
		 
		if (coalesce(qt_item_autorizado_w::text, '') = '') then 
			qt_item_autorizado_w	:= 0;
		end if;
		 
		/*Quando for pacote*/
 
		if (ie_tipo_despesa_w = '4') then					 
			/*Pacotes sem o procedimento origiário*/
 
			ie_gerar_oc_pacote_w := pls_obter_oc_pacote_conv(nr_seq_conta_p, nr_seq_proc_p, ie_gerar_oc_pacote_w, cd_estabelecimento_p, nm_usuario_p);		
		end if;
	elsif (coalesce(nr_seq_guia_plano_p,0) > 0) then	 
	 
		select	nr_seq_proc_princ, 
			coalesce(vl_procedimento,0), 
			CASE WHEN coalesce(nr_seq_pacote::text, '') = '' THEN 'N'  ELSE 'S' END 		 
		into STRICT	nr_seq_conta_princ_w, 
			vl_calculado_w, 
			ie_pacote_w 
		from	pls_guia_plano_proc 
		where	nr_sequencia = nr_seq_proc_p;	
		 
		if	((ie_pacote_w = 'S') and (coalesce(nr_seq_conta_princ_w,0) = 0)) then 
			ie_gerar_oc_pacote_w	:= 'S';
		end if;
	elsif (coalesce(nr_seq_requisicao_p,0) > 0) then 
		select	coalesce(vl_procedimento,0) 
		into STRICT	vl_calculado_w			 
		from	pls_requisicao_proc 
		where	nr_sequencia = nr_seq_proc_p;	
	end if;
	 
elsif (coalesce(nr_seq_mat_p,0) <> 0) then 
	ie_tipo_item_w	:= 'M';
	 
	if (coalesce(nr_seq_conta_p,0) > 0) then		 
		select	a.ie_tipo_despesa, 
			a.nr_nota_fiscal, 
			a.nr_seq_prest_fornec, 
			a.vl_material, 
			a.vl_material_imp, 
			a.nr_seq_item_sip, 
			a.nr_seq_evento, 
			a.qt_material_imp, 
			a.ie_exige_autorizacao 
		into STRICT	ie_tipo_despesa_w, 
			nr_nota_fiscal_mat_w, 
			nr_seq_prest_fornec_w, 
			vl_calculado_w, 
			vl_apresentado_w, 
			nr_seq_item_sip_w, 
			qt_eventos_pagto_w, 
			qt_material_w, 
			ie_exige_autorizacao_w 
		from	pls_conta_mat	a 
		where	a.nr_sequencia = nr_seq_mat_p;
		 
		ie_fornecedor_w		:= 'N';
		if (coalesce(nr_seq_prest_fornec_w::text, '') = '') then 
			ie_fornecedor_w		:= 'S';
		end if;
		 
		ie_classif_sip_w	:= 'S';
		if (coalesce(nr_seq_item_sip_w,0)	= 0) then 
			ie_classif_sip_w	:= 'N';
		end if;
		 
		if (coalesce(vl_calculado_w::text, '') = '') then 
			vl_calculado_w	:= 0;
		end if;
		 
		if (coalesce(vl_apresentado_w::text, '') = '') then 
			vl_apresentado_w	:= 0;
		end if;
		 
		begin 
		select	coalesce(cd_guia_referencia,cd_guia)			 
		into STRICT	cd_guia_w			 
		from	pls_conta 
		where	nr_sequencia = nr_seq_conta_p;		
		exception 
		when others then 
			cd_guia_w := '';
		end;		
		 
		if (cd_guia_w IS NOT NULL AND cd_guia_w::text <> '') then 
			select	sum(a.qt_material_imp) 
			into STRICT	qt_item_solic_w			 
			from	pls_conta_mat 	a, 
				pls_conta	b 
			where	a.nr_seq_conta	= b.nr_sequencia 
			and	(((b.cd_guia		= cd_guia_w) 
			and (coalesce(b.cd_guia_referencia::text, '') = '')) 
			or (b.cd_guia_referencia = cd_guia_w)) 
			and	a.nr_seq_material = nr_seq_material_p 
			and	b.nr_seq_segurado = nr_seq_segurado_p 
			and	(a.qt_material_imp IS NOT NULL AND a.qt_material_imp::text <> '');
			 
			select	sum(b.qt_autorizada) 
			into STRICT	qt_item_autorizado_w 
			from	pls_guia_plano_mat	b, 
				pls_guia_plano		a 
			where	a.nr_sequencia 		= b.nr_seq_guia 
			and	((a.cd_guia		= cd_guia_w) 
			or (a.cd_guia_principal 	= cd_guia_w)) 
			and	a.nr_seq_segurado	= nr_seq_segurado_p 
			and	b.nr_seq_material	= nr_seq_material_p 
			and	(b.qt_autorizada IS NOT NULL AND b.qt_autorizada::text <> '');
		else 
			select	sum(a.qt_material_imp) 
			into STRICT	qt_item_solic_w 
			from	pls_conta_mat 	a 
			where	a.nr_seq_conta	= nr_seq_conta_p 
			and	a.nr_seq_material = nr_seq_material_p 
			and	(a.qt_material_imp IS NOT NULL AND a.qt_material_imp::text <> '');
		end if;
		 
		if (coalesce(qt_item_autorizado_w::text, '') = '') then 
			qt_item_autorizado_w	:= 0;
		end if;
		/*select	max(nr_sequencia) 
		into	nr_seq_guia_w 
		from	pls_guia_plano 
		where	cd_guia 	= cd_guia_ref_p 
		and	nr_seq_segurado = nr_seq_segurado_p;*/
 
		ie_internado_w	:= pls_obter_se_internado(nr_seq_conta_p,'');
		 
		if (ie_internado_w = 'S') then 
			ie_tipo_internado_w	:= 'I';
		else 
			ie_tipo_internado_w	:= 'A';
		end if;
		 
		select	count(nr_sequencia) 
		into STRICT	qt_solic_lib_mat_med_w 
		from	pls_solic_lib_mat_med 
		where	nr_seq_segurado = nr_seq_segurado_p 
		and	nr_seq_material = nr_seq_material_p 
		and	nr_seq_guia	= nr_seq_guia_p 
		and	ie_status 	= 3  LIMIT 1;
		 
		ie_mat_espec_aut_w	:= 'S';
		if (qt_solic_lib_mat_med_w	= 0) then 
			ie_mat_espec_aut_w	:= 'N';
		end if;
		 
	elsif (coalesce(nr_seq_guia_plano_p,0) > 0) then		 
		select	coalesce(vl_material,0)			 
		into STRICT	vl_calculado_w			 
		from	pls_guia_plano_mat 
		where	nr_sequencia = nr_seq_mat_p;		
	elsif (coalesce(nr_seq_requisicao_p,0) > 0) then	 
		select	coalesce(vl_material,0)			 
		into STRICT	vl_calculado_w			 
		from	pls_requisicao_mat 
		where	nr_sequencia = nr_seq_mat_p;		
	end if;	
	 
	nr_seq_restricao_w := pls_obter_mat_restricao_data(nr_seq_material_p, dt_referencia_p, nr_seq_restricao_w);
 
	if (coalesce(nr_seq_restricao_w,0) > 0) then 
		 
		select	qt_minima, 
			qt_maxima, 
			CASE WHEN ie_bloqueia_custo_op='S' THEN 'BCO' END , 
			CASE WHEN ie_bloqueia_pre_pag='S' THEN 'BPP' END , 
			CASE WHEN ie_bloqueia_intercambio='S' THEN 'BI' END , 
			CASE WHEN ie_bloqueia_prod_nao_reg='S' THEN 'BNR' END , 
			CASE WHEN ie_bloqueia_prod_reg='S' THEN 'BR' END , 
			coalesce(ie_autorizacao,'N'), 
			coalesce(ie_nota_fiscal,'N'), 
			qt_idade_minima, 
			qt_idade_maxima, 
			ie_sexo_exclusivo 
		into STRICT	qt_minima_w, 
			qt_maxima_w, 
			ie_bloqueia_custo_op_w, 
			ie_bloqueia_pre_pag_w, 
			ie_bloqueia_intercambio_w, 
			ie_bloqueia_prod_nao_reg_w, 
			ie_bloqueia_prod_reg_w, 
			ie_autorizacao_especial_w, 
			ie_nota_fiscal_w, 
			qt_idade_minima_w, 
			qt_idade_maxima_w, 
			ie_sexo_exclusivo_w 
		from	pls_material_restricao 
		where	nr_sequencia	= nr_seq_restricao_w;
		 
		if	((qt_item_p <qt_minima_w) or (qt_item_p > qt_maxima_w)) then 
			ie_consiste_qtd_w	:= 'S';
		end if;		
	end if;
	 
	if (nr_seq_segurado_p IS NOT NULL AND nr_seq_segurado_p::text <> '') then			 
		/*select	ie_sexo_exclusivo, 
			qt_idade_minima, 
			qt_idade_maxima 
		into	ie_sexo_mat_w, 
			qt_idade_min_mat_w, 
			qt_idade_max_mat_w 
		from	pls_material 
		where	nr_sequencia	= nr_seq_material_p;*/
	 
 
		if (ie_sexo_p	<> ie_sexo_exclusivo_w /*ie_sexo_mat_w*/
) then 
			ie_consiste_sexo_w	:= 'S';
		end if;
		 
		if (qt_idade_p > qt_idade_maxima_w /*qt_idade_max_mat_w*/
 or qt_idade_p < qt_idade_minima_w /*qt_idade_min_mat_w*/
) then 
			ie_consiste_idade_w	:= 'S';
		end if;	
		 
	end if;
	 
end if;	
 
/*define se a conta é de intercâmbio ou é da operadora */
 
if (ie_tipo_conta_p = 'N') then 
	ie_tipo_conta_w := 'O';
else 
	ie_tipo_conta_w := 'I';
end if;
 
if (qt_procedimento_w > 0 ) then 
	if 	( (qt_procedimento_w mod 1) > 0 ) then 
		ie_fracionado_w := 'S';
	end if;
elsif (qt_material_w > 0 ) then 
	if	((qt_material_w mod 1) > 0) then 
		ie_fracionado_w := 'S';
	end if;
end if;
 
/* 
';ie_tipo_conta_web_w='||chr(39)||ie_tipo_conta_web_w||chr(39)|| 
';dt_referencia_p='||chr(39)||dt_referencia_p||chr(39)|| 
';ie_tipo_item_w='||chr(39)||ie_tipo_item_w||chr(39)|| 
';nr_seq_prestador_exec_p='||chr(39)||nr_seq_prestador_exec_p||chr(39)|| 
';cd_prestador_exec_p='||chr(39)||cd_prestador_exec_p||chr(39)|| 
';ie_tipo_conta_w='||chr(39)||ie_tipo_conta_w||chr(39)|| 
';ie_autorizacao_p='||chr(39)||ie_autorizacao_p||chr(39)|| 
';ie_conta_medica_p='||chr(39)||ie_conta_medica_p||chr(39)|| 
';cd_procedimento_p='||chr(39)||cd_procedimento_p||chr(39)|| 
';ie_origem_proced_p='||chr(39)||ie_origem_proced_p||chr(39)|| 
';cd_area_procedimento_p='||chr(39)||cd_area_procedimento_p||chr(39)|| 
';cd_especialidade_p='||chr(39)||cd_especialidade_p||chr(39)|| 
';cd_grupo_proc_p='||chr(39)||cd_grupo_proc_p||chr(39)|| 
';nr_seq_material_p='||chr(39)||nr_seq_material_p||chr(39)|| 
';nr_seq_estrut_mat_p='||chr(39)||nr_seq_estrut_mat_p||chr(39)|| 
';ie_tipo_despesa_w='||chr(39)||ie_tipo_despesa_w||chr(39)|| 
';nr_seq_conta_p='||chr(39)||nr_seq_conta_p||chr(39)|| 
';ie_nota_fiscal_w='||chr(39)||ie_nota_fiscal_w||chr(39)|| 
';nr_nota_fiscal_mat_w='||chr(39)||nr_nota_fiscal_mat_w||chr(39)|| 
';ie_fornecedor_w='||chr(39)||ie_fornecedor_w||chr(39)|| 
';ie_exige_medico_p='||chr(39)||ie_exige_medico_p||chr(39)|| 
';nr_seq_grupo_contrato_p='||chr(39)||nr_seq_grupo_contrato_p||chr(39)|| 
';ie_consiste_qtd_w='||chr(39)||ie_consiste_qtd_w||chr(39)|| 
';ie_consiste_sexo_w='||chr(39)||ie_consiste_sexo_w||chr(39)|| 
';ie_consiste_idade_w='||chr(39)||ie_consiste_idade_w||chr(39)|| 
';ie_classif_sip_w='||chr(39)||ie_classif_sip_w||chr(39)|| 
';ie_gerar_oc_pacote_w='||chr(39)||ie_gerar_oc_pacote_w||chr(39)|| 
';qt_item_solic_w='||chr(39)||qt_item_solic_w||chr(39)|| 
';qt_item_autorizado_w='||chr(39)||qt_item_autorizado_w||chr(39)|| 
';ie_autorizacao_especial_w='||chr(39)||ie_autorizacao_especial_w||chr(39)|| 
';ie_mat_espec_aut_w='||chr(39)||ie_mat_espec_aut_w||chr(39)|| 
';nr_seq_grupo_rec_p='||chr(39)||nr_seq_grupo_rec_p||chr(39)|| 
';ie_via_acesso_w='||chr(39)||ie_via_acesso_w||chr(39)|| 
';ie_tipo_segurado_p='||chr(39)||ie_tipo_segurado_p||chr(39)|| 
';ie_sexo_p='||chr(39)||ie_sexo_p||chr(39)|| 
';ie_bloqueia_custo_op_w='||chr(39)||ie_bloqueia_custo_op_w||chr(39)|| 
';ie_bloqueia_pre_pag_w='||chr(39)||ie_bloqueia_pre_pag_w||chr(39)|| 
';ie_bloqueia_intercambio_w='||chr(39)||ie_bloqueia_intercambio_w||chr(39)|| 
';ie_bloqueia_prod_nao_reg_w='||chr(39)||ie_bloqueia_prod_nao_reg_w||chr(39)|| 
';ie_bloqueia_prod_reg_w='||chr(39)||ie_bloqueia_prod_reg_w||chr(39)|| 
';ie_calculo_coparticipacao_p='||chr(39)||ie_calculo_coparticipacao_p||chr(39)|| 
';ie_coparticipacao_w='||chr(39)||ie_coparticipacao_w||chr(39)|| 
';ie_co_preco_operadora_w='||chr(39)||ie_co_preco_operadora_w||chr(39)|| 
';nr_seq_plano_p='||chr(39)||nr_seq_plano_p||chr(39)|| 
';nr_seq_tipo_acomod_conta_p='||chr(39)||nr_seq_tipo_acomod_conta_p||chr(39)|| 
';nr_seq_tipo_acomodacao_w='||chr(39)||nr_seq_tipo_acomodacao_w||chr(39)|| 
';nr_seq_ocorrencia_p='||chr(39)||nr_seq_ocorrencia_p||chr(39)|| 
';ie_fracionado_w='||chr(39)||ie_fracionado_w||chr(39);*/
 
open C01;
loop 
fetch C01 into	 
	nr_seq_regra_item_w, 
	ie_nao_informado_w, 
	nr_seq_ocorrencia_w, 
	nr_seq_estrutura_w, 
	vl_max_item_w, 
	vl_minimo_item_w, 
	ie_consistencia_valor_w, 
	ie_nao_utilizado_w, 
	qt_idade_min_w, 
	qt_idade_max_w, 
	ie_unid_tempo_idade_w, 
	ie_sem_evento_w, 
	nr_seq_regra_duplic_w, 
	nr_seq_grupo_material_w, 
	ie_exige_hora_item_w, 
	ie_exige_hora_final_w, 
	nr_seq_grupo_produto_w, 
	ie_taxa_intercambio_w, 
	cd_procedimento_regra_w, 
	ie_origem_proced_regra_w, 
	nr_seq_estrut_regra_w, 
	nr_seq_prestador_pag_w, 
	dt_inicio_vigencia_w, 
	dt_fim_vigencia_w, 
	ie_tipo_item_ww, 
	nr_seq_prestador_exec_w, 
	cd_prestador_exec_w, 
	ie_tipo_conta_ww, 
	ie_autorizacao_w, 
	ie_conta_medica_w, 
	cd_procedimento_w, 
	ie_origem_proced_w, 
	cd_area_procedimento_w, 
	cd_especialidade_w, 
	cd_grupo_proc_w, 
	nr_seq_material_w, 
	ie_tipo_desp_proc_w, 
	ie_tipo_despesa_mat_w, 
	ie_exige_nf_w, 
	ie_exige_fornecedor_w, 
	ie_exige_medico_w, 
	nr_seq_grupo_contrato_w, 
	ie_consiste_qtd_ww, 
	ie_consiste_sexo_ww, 
	ie_consiste_idade_ww, 
	ie_classif_sip_ww, 
	ie_pacote_honorario_w, 
	ie_mat_autorizacao_esp_w, 
	nr_seq_grupo_rec_w, 
	ie_via_acesso_ww, 
	ie_tipo_segurado_w, 
	ie_sexo_w, 
	ie_bloqueio_mat_w, 
	ie_regra_valor_copartic_w, 
	ie_regra_valor_co_w, 
	nr_seq_plano_w, 
	nr_seq_tipo_acomod_conta_w, 
	nr_seq_tipo_acomodacao_w, 
	ie_qtd_item_fracionada_w, 
	ie_digitacao_portal_w, 
	ie_complemento_conta_w, 
	ie_situacao_w, 
	ie_carater_regra_w, 
	ie_tipo_internado_regra_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin 
	if (ie_situacao_w <> 'A') then 
		goto final;
	end if;
	 
	qt_ocorrencia_w 	:= 0;
	ds_observacao_w 	:= '';	
	ie_grupo_produto_w	:= 'S';
	ie_estrutura_w		:= 'S';
	 
	if	not(trunc(dt_referencia_p) between trunc(coalesce(dt_inicio_vigencia_w, clock_timestamp())) and trunc(fim_dia(coalesce(dt_fim_vigencia_w,dt_referencia_p)))) then 
		goto final;
	end if;
 
	if	not ((ie_tipo_item_ww = ie_tipo_item_w) or (ie_tipo_item_ww = 'A')) then 
		goto final;
	end if;
 
	if	not ((coalesce(nr_seq_prestador_exec_w::text, '') = '') or (nr_seq_prestador_exec_w = nr_seq_prestador_exec_p)) then 
		goto final;
	end if;
 
	if	not ((coalesce(cd_prestador_exec_w::text, '') = '') or (cd_prestador_exec_w = coalesce(cd_prestador_exec_p,'0'))) then 
		goto final;
	end if;
 
	if	not ((ie_tipo_conta_ww = 'A') or (ie_tipo_conta_ww = ie_tipo_conta_w)) then 
		goto final;
	end if;
 
	if	not ((coalesce(ie_autorizacao_w,'N') = ie_autorizacao_p) 
		or (coalesce(ie_conta_medica_w,'N') = ie_conta_medica_p)) then 
		goto final;
	end if;
 
	if	not ((coalesce(cd_procedimento_w::text, '') = '') or (cd_procedimento_w = coalesce(cd_procedimento_p,0) 
		and (ie_origem_proced_w = coalesce(ie_origem_proced_p,0)))) then 
		goto final;
	end if;
 
	if	not ((coalesce(cd_area_procedimento_w::text, '') = '') or (cd_area_procedimento_w = coalesce(cd_area_procedimento_p,0))) then 
		goto final;
	end if;
 
	if	not ((coalesce(cd_especialidade_w::text, '') = '') or (cd_especialidade_w = coalesce(cd_especialidade_p,0))) then 
		goto final;
	end if;
 
	if	not ((coalesce(cd_grupo_proc_w::text, '') = '') or (cd_grupo_proc_w = coalesce(cd_grupo_proc_p,0))) then 
		goto final;
	end if;
 
	if	not ((coalesce(nr_seq_material_w::text, '') = '') or (nr_seq_material_w = coalesce(nr_seq_material_p,0))) then 
		goto final;
	end if;
	 
	if	not ((ie_autorizacao_p = 'S') 
		or	((ie_tipo_despesa_w = coalesce(ie_tipo_despesa_mat_w, ie_tipo_despesa_w) and (coalesce(ie_tipo_desp_proc_w,0)=0) and (coalesce(ie_tipo_item_w,'X') = 'M') and (coalesce(nr_seq_conta_p,0) > 0)) 
		or (ie_tipo_despesa_w = coalesce(ie_tipo_desp_proc_w,  ie_tipo_despesa_w) and (coalesce(ie_tipo_despesa_mat_w,0)=0) and (coalesce(ie_tipo_item_w,'X') = 'P') and (coalesce(nr_seq_conta_p,0) > 0)))) then/*Diego 27/06/2011 - A rotina estava considerando a necessidade de autorização junto com a de apresentação de NF. As duas são verificações separadas e não agregadas.*/
 
		goto final;
	end if;
	 
	if	not	((coalesce(ie_tipo_item_w,'P') = 'P') 
		or 	((ie_tipo_item_w = 'M') 
		and	((coalesce(ie_exige_nf_w,'N') = 'N') 
		or (ie_exige_nf_w = 'S' and ie_nota_fiscal_w = 'S' and (coalesce(nr_nota_fiscal_mat_w,0) = 0)) 
		or (ie_exige_nf_w = 'M' and (coalesce(nr_nota_fiscal_mat_w,0) = 0))))) then 
		goto final;
	end if;
 
	if	not ((coalesce(ie_exige_fornecedor_w,'N') = 'N')	or (coalesce(ie_exige_fornecedor_w,'N') = coalesce(ie_fornecedor_w,'N'))) then 
		goto final;
	end if;
 
	if	not ((coalesce(ie_exige_medico_w,'N') = 'N')	or (coalesce(ie_exige_medico_w,'N') <> ie_exige_medico_p)) then 
		goto final;
	end if;
 
	if	not ((coalesce(nr_seq_grupo_contrato_w,0) = coalesce(nr_seq_grupo_contrato_p,0))or (coalesce(nr_seq_grupo_contrato_w::text, '') = '')) then 
		goto final;
	end if;
 
	if	not ((ie_consiste_qtd_ww = 'N')  or (ie_consiste_qtd_ww = ie_consiste_qtd_w)) then 
		goto final;
	end if;
 
	if	not ((ie_consiste_sexo_ww = 'N') or (ie_consiste_sexo_ww = ie_consiste_sexo_w)) then 
		goto final;
	end if;
 
	if	not ((ie_consiste_idade_ww = 'N') or (ie_consiste_idade_ww = ie_consiste_idade_w)) then 
		goto final;
	end if;
 
	if	not ((ie_classif_sip_ww = 'N')  or (ie_classif_sip_w = 'N')) then 
		goto final;
	end if;
 
	if	not ((coalesce(ie_pacote_honorario_w,'N') = 'N') or ((coalesce(ie_pacote_honorario_w,'N') = 'S') and (coalesce(ie_gerar_oc_pacote_w,'N') = 'S') and (ie_tipo_despesa_w <> 3))) then 
		goto final;
	end if;
	 
	if	not ((coalesce(ie_carater_regra_w,'X') = 'X') or (coalesce(ie_carater_regra_w,'X') = ie_carater_internacao_w)) then 
		goto final;
	end if;
 
	if	not ((coalesce(ie_nao_utilizado_w,'N') = 'N') or (qt_item_solic_w < qt_item_autorizado_w) or (coalesce(ie_exige_autorizacao_w,'N') = 'N')) then 
		goto final;
	end if;
 
	if	not ((coalesce(ie_mat_autorizacao_esp_w,'N') = 'N') or (ie_mat_autorizacao_esp_w = 'S' and ie_autorizacao_especial_w = 'S' and ie_mat_espec_aut_w = 'N')) then /*Diego OS 319904 - Se o material exigir autorização especial e não possuir é gerada a ocorrência.*/
 
		goto final;
	end if;
 
	if	not ((coalesce(nr_seq_grupo_rec_w::text, '') = '') or (nr_seq_grupo_rec_w = nr_seq_grupo_rec_p)) then 
		goto final;
	end if;
 
	if	not ((coalesce(ie_via_acesso_ww,'X') = 'X') or (coalesce(ie_via_acesso_ww,'X') = ie_via_acesso_w)) then 
		goto final;
	end if;
 
	if	not ((coalesce(ie_tipo_segurado_w::text, '') = '') or (ie_tipo_segurado_w = ie_tipo_segurado_p )) then 
		goto final;
	end if;
 
	if	not ((coalesce(ie_sexo_w::text, '') = '') or ( ie_sexo_w = ie_sexo_p)) then 
		goto final;
	end if;
 
	if	not ((coalesce(ie_bloqueio_mat_w::text, '') = '') or (ie_bloqueio_mat_w in (	ie_bloqueia_custo_op_w, 
										ie_bloqueia_pre_pag_w, 
										ie_bloqueia_intercambio_w, 
										ie_bloqueia_prod_nao_reg_w, 
										ie_bloqueia_prod_reg_w ))) then 
		goto final;
	end if;
 
	if	not	((ie_calculo_coparticipacao_p	= 'O' and ((coalesce(ie_regra_valor_copartic_w,'N') = 'N') 
		or (coalesce(ie_regra_valor_copartic_w,'N') = 'S' and coalesce(ie_coparticipacao_w,'N') = 'N'))) 
		or (ie_calculo_coparticipacao_p <> 'O')) then 
		goto final;
	end if;
 
	if	not ((coalesce(ie_regra_valor_co_w,'N') = 'N') or coalesce(ie_regra_valor_co_w,'N') = 'S' and coalesce(ie_co_preco_operadora_w,'N') = 'N')	then 
		goto final;
	end if;
 
	if	not ((coalesce(nr_seq_plano_w::text, '') = '') or ( nr_seq_plano_w = nr_seq_plano_p )) then 
		goto final;
	end if;
 
	if	not ((coalesce(nr_seq_tipo_acomod_conta_w::text, '') = '') or (nr_seq_tipo_acomod_conta_w = nr_seq_tipo_acomod_conta_p )) then-- acomodacao da conta 
		goto final;
	end if;
 
	if	not ((coalesce(nr_seq_tipo_acomodacao_w::text, '') = '') or (nr_seq_tipo_acomodacao_w = nr_seq_tipo_acomodacao_p )) then--acomodacao do produto 
		goto final;
	end if;
 
	if	not ((coalesce(ie_qtd_item_fracionada_w,'N') = 'N') or ( ie_qtd_item_fracionada_w = 'S' AND ie_fracionado_w = 'S')) then 
		goto final;
	end if;
 
	if	not	((ie_tipo_conta_web_w = 'X') 
		or (ie_tipo_conta_web_w = 'D' and ie_digitacao_portal_w = 'S') 
		or (ie_tipo_conta_web_w = 'C' and ie_complemento_conta_w = 'S')) then 
		goto final;
	end if;
	 
	 
	 
	 
	 
	if (nr_seq_estrut_regra_w IS NOT NULL AND nr_seq_estrut_regra_w::text <> '') then 
		if (pls_obter_se_mat_estrutura(nr_seq_material_p, nr_seq_estrut_regra_w) = 'N') then 
			goto final;
		end if;
	end if;
	/* 
	if	(nr_seq_regra_item_w = 219) and (nm_usuario_p = 'askono') then 
		(-20011,'ie_tipo_conta= '||ie_tipo_conta_w|| 'tipo_conta_p='||ie_tipo_conta_p); 
	end if; 
	*/
 
	/*Taxa intercâmbio diferencte*/
 
	if (coalesce(ie_taxa_intercambio_w,'N')	= 'S') and (ie_tipo_conta_w = 'I') then 
		if (coalesce(tx_intercambio_w,0) = coalesce(tx_intercambio_imp_w,0) ) then 
			goto final;
		end if;
	end if;
	 
	 
	/* Grupo de produtos */
 
	if (coalesce(nr_seq_grupo_produto_w,0) > 0) then 
		ie_grupo_produto_w	:= pls_se_grupo_preco_produto(nr_seq_grupo_produto_w, nr_seq_plano_p);
	end if;
 
	if (ie_grupo_produto_w	= 'N') then 
		goto final;
	end if;
	 
	if	not ((coalesce(ie_tipo_internado_regra_w,'X') = 'X') or (coalesce(ie_tipo_internado_regra_w,'X') = ie_tipo_internado_w)) then 
		goto final;
	end if;
	/*Diego 02/05/2011 
	  Caso já tenha sido gerado a ocorrência da regra que se esta verificando não é necessário continuar as verificações das demais regras.*/
 
	if (nr_seq_conta_p IS NOT NULL AND nr_seq_conta_p::text <> '') then 
		if (ie_tipo_item_w = 'P') then 
			select	count(1) 
			into STRICT	qt_ocorrencia_w 
			from	pls_ocorrencia_benef 
			where	nr_seq_ocorrencia		= nr_seq_ocorrencia_w 
			and	nr_seq_conta			= nr_seq_conta_p 
			and	nr_seq_proc			= nr_seq_proc_p  LIMIT 1;
		elsif (ie_tipo_item_w = 'M') then 
			select	count(1) 
			into STRICT	qt_ocorrencia_w 
			from	pls_ocorrencia_benef 
			where	nr_seq_ocorrencia		= nr_seq_ocorrencia_w 
			and	nr_seq_conta			= nr_seq_conta_p 
			and	nr_seq_mat			= nr_seq_mat_p  LIMIT 1;
		end if;
	end if;
	 
	if (qt_ocorrencia_w > 0) and (coalesce(ie_reconsistencia_p,'N') = 'N') then 
		goto final;
	end if;	
	 
	/*askono 30/06/11	OS330239 	testa se o valor do item ( vl_min_item e vl_max_item) dos proc/materiais é comparado com o valor calculado ( vl_procedimento) ou valor apresentado ( vl_procedimento_imp ) . 
	Por padrão o valor é comparado com o valor calculado */
 
	if (coalesce(ie_consistencia_valor_w,'C')= 'C') then 
		if (vl_calculado_w > coalesce(vl_max_item_w, vl_calculado_w) or 
			vl_calculado_w < vl_minimo_item_w ) then 
			goto final;	
		end if;
	elsif (coalesce(ie_consistencia_valor_w,'C')= 'A') then 
		if (vl_apresentado_w > coalesce(vl_max_item_w,vl_apresentado_w) or 
			vl_apresentado_w < vl_minimo_item_w ) then 
			goto final;
		end if;
	end if;
	 
	if (coalesce(nr_seq_estrutura_w,0)	<> 0) then 
		ie_estrutura_w := pls_obter_se_estrutura(cd_procedimento_p, ie_origem_proced_p, nr_seq_mat_p, nr_seq_estrutura_w);
	end if;
	 
	if (ie_nao_utilizado_w = 'S') then 
		if (ie_tipo_despesa_w = 3) then --Não funciona em Diárias. 
			goto final;
		end if;
		ds_observacao_w := ds_observacao_w || ' A quantidade de itens autorizados é maior que a quantidade realizada.'||chr(13)||chr(10)|| 
						   chr(9)||'Qtd. autorizada: '||to_char(qt_item_autorizado_w)||' Qtd. realizada: '||to_char(qt_item_solic_w)||chr(13)||chr(10);
	end if;	
	 
	/* Verificar se for regra de quantidade de idade minima ou maxima da regra, sendo "A" por ano e "M" por meses*/
 
	if (ie_unid_tempo_idade_w = 'A') then 
		if	(qt_idade_min_w IS NOT NULL AND qt_idade_min_w::text <> '' AND qt_idade_min_w > qt_idade_p) or 
			(qt_idade_max_w IS NOT NULL AND qt_idade_max_w::text <> '' AND qt_idade_max_w < qt_idade_p) then 
			goto final;
		end if;
	elsif (ie_unid_tempo_idade_w = 'M') then 
		if	(qt_idade_min_w IS NOT NULL AND qt_idade_min_w::text <> '' AND qt_idade_min_w > qt_idade_meses_p) or 
			(qt_idade_max_w IS NOT NULL AND qt_idade_max_w::text <> '' AND qt_idade_max_w < qt_idade_meses_p) then 
			goto final;
		end if;		
	end if;	
	 
	/* Regra de prestador pagamento */
 
	if (coalesce(nr_seq_prestador_pag_w,0) > 0) then 
		ie_retorno_w := pls_consistir_prestador_pgto(	nr_seq_conta_p, nr_seq_mat_p, nr_seq_proc_p, nr_seq_prestador_pag_w, ie_retorno_w, nm_usuario_p);
		if (coalesce(ie_retorno_w,'N') = 'N') then 
			goto final;
		end if;
	end if;
	 
	/*Regra de duplicidade */
	 
	if (coalesce(nr_seq_regra_duplic_w,0) > 0) then 
		/*ie_duplicidade_out_w	:= pls_obter_se_regra_duplic ( nr_seq_regra_item_w, nm_usuario_p, nr_Seq_conta_p, 
									nr_seq_proc_p, nr_seq_mat_p );			 
		*/
		 
		SELECT * FROM pls_obter_se_regra_dup(	nr_seq_regra_item_w, nm_usuario_p, nr_Seq_conta_p, nr_seq_proc_p, nr_seq_mat_p, nr_seq_regra_duplic_w, nr_seq_estrutura_w, cd_procedimento_regra_w, ie_origem_proced_regra_w, ds_out_w, nr_seq_conta_duplic_out_w, nr_seq_proc_partic_out_w, ie_duplicidade_out_w, null, null, null, null) INTO STRICT ds_out_w, nr_seq_conta_duplic_out_w, nr_seq_proc_partic_out_w, ie_duplicidade_out_w;		
		if ( ie_duplicidade_out_w = 'N') then 
			goto final;
		end if;
		if (ie_duplicidade_out_w = 'S') and (ds_out_w IS NOT NULL AND ds_out_w::text <> '') then 
			ds_observacao_w	:= substr( ds_observacao_w ||chr(13)||chr(10)||'Contas em duplicidade: '||chr(13)||chr(10)||ds_out_w,1,4000);		
		end if;
	end if;		
	 
	/*Consiste se existe evento de pagamento - askono OS */
 
	 
	if ( coalesce(ie_sem_evento_w,'N') = 'S') then	 
		if ( coalesce(qt_eventos_pagto_w,0) > 0) then 
			goto final;
		end if;	
	end if;
	 
	/*Consistir se Hora inicio do procedimento está informado*/
 
	if ( coalesce(ie_exige_hora_item_w,'N') = 'S') and (ie_tipo_item_w = 'P') then 
		if (dt_inicio_proc_w IS NOT NULL AND dt_inicio_proc_w::text <> '') then	 
			goto final;
		end if;
	end if;
	 
	/*Consistir se Hora Fim do procedimento está informado*/
 
	if ( coalesce(ie_exige_hora_final_w,'N') = 'S') and (ie_tipo_item_w = 'P') then 
		if (dt_fim_proc_w IS NOT NULL AND dt_fim_proc_w::text <> '') then	 
			goto final;	
		end if;
	end if;	
	 
	/* Grupo de material */
 
	if (coalesce(nr_seq_grupo_material_w,0) > 0) and (coalesce(nr_seq_material_p,0) > 0) then 
		ie_grupo_material_w	:= pls_se_grupo_preco_material(nr_seq_grupo_material_w, nr_seq_material_p);
		 
		if (ie_grupo_material_w	= 'N') then 
			goto final;
		end if;	
	end if;
	 
	if (ie_estrutura_w <> 'N') then 
		if (ie_auditoria_p = 'S') then 
			ie_ocorrencia_w := 'S';
		end if;
		 
		if (coalesce(ie_reconsistencia_p,'N') = 'N') or (qt_ocorrencia_w = 0)	then 
			nr_seq_ocorrencia_benef_w := pls_inserir_ocorrencia(nr_seq_segurado_p, nr_seq_ocorrencia_w, nr_seq_requisicao_p, nr_seq_guia_plano_p, nr_seq_conta_p, nr_seq_proc_p, nr_seq_mat_p, '', nm_usuario_p, ds_observacao_w, nr_seq_motivo_glosa_p, ie_tipo_item_p, cd_estabelecimento_p, 'N', null, nr_seq_ocorrencia_benef_w, null, null, null, null);
		else 
			if (ie_tipo_item_w = 'P') then 
				update	pls_ocorrencia_benef 
				set	ie_situacao			= 'A' 
				where	nr_seq_ocorrencia		= nr_seq_ocorrencia_w 
				and	nr_seq_conta			= nr_seq_conta_p 
				and	nr_seq_proc			= nr_seq_proc_p;
			elsif (ie_tipo_item_w = 'M') then 
				update	pls_ocorrencia_benef	 
				set	ie_situacao			= 'A' 
				where	nr_seq_ocorrencia		= nr_seq_ocorrencia_w 
				and	nr_seq_conta			= nr_seq_conta_p 
				and	nr_seq_mat			= nr_seq_mat_p;
			end if;
		end if;
	end if;
	 
	<<final>> 
	null;
	end;
end loop;
close C01;
 
--Diego 11/05/2011 - Chamado dentro da consistir conta portanto não pode existir commit 
--commit; 
 
ie_ocorrencia_p := ie_ocorrencia_w;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_gerar_ocorrencia_item ( ie_tipo_item_p text, ie_conta_medica_p text, cd_procedimento_p bigint, ie_origem_proced_p bigint, nr_seq_material_p bigint, ie_tipo_conta_web_p text, ie_autorizacao_p text, ie_tipo_conta_p text, nr_seq_segurado_p bigint, nr_seq_guia_plano_p bigint, nr_seq_requisicao_p bigint, nr_seq_conta_p bigint, nr_seq_proc_p bigint, nr_seq_mat_p bigint, ie_exige_medico_p text, nr_seq_grupo_contrato_p bigint, dt_referencia_p timestamp, qt_item_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text, ie_ocorrencia_p INOUT text, nr_seq_ocorrencia_p bigint, ie_reconsistencia_p text, ie_pagto_fat_p text, ie_sexo_p text, ie_tipo_segurado_p text, qt_idade_p text, qt_idade_meses_p bigint, nr_seq_tipo_acomodacao_p bigint, ie_calculo_coparticipacao_p text, nr_seq_plano_p bigint, nr_seq_motivo_glosa_p bigint, ie_auditoria_p text, nr_seq_prestador_exec_p bigint, cd_prestador_exec_p text, nr_seq_tipo_acomod_conta_p bigint, nr_seq_guia_p bigint, nr_seq_estrut_mat_p bigint, cd_area_procedimento_p bigint, cd_especialidade_p bigint, cd_grupo_proc_p bigint, nr_seq_grupo_rec_p bigint) FROM PUBLIC;

