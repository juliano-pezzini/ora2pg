-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_d301_conteudo_mbeg ( nr_seq_dataset_p bigint, nm_usuario_p text) AS $body$
DECLARE


/*
Gerar e armazenar o conte√∫do (com separadores) deste dataset no campo DS_CONTEUDO da tabela D301_DATASET_CONTEUDO
*/
ds_segmento_w		varchar(4000);
ds_segmento_clob_w	text := '';


c01 CURSOR FOR
SELECT	'TXT+'||DS_JUSTIFICATIVA_MED||chr(39) ds
into STRICT	ds_segmento_w
from	D301_SEGMENTO_TXT
where	nr_seq_dataset	= nr_seq_dataset_p;

c01_w	c01%rowtype;


BEGIN

select	'UNH+'||
	NR_REF_SEGMENTO||'+'||
	IE_DATASET||':'||
	IE_VERSAO_DATASET||':'||
	NR_RELEASE_DATASET||':'||
	NR_VERSAO_ORGANIZ||chr(39)
into STRICT	ds_segmento_w
from	d301_segmento_unh
where	nr_seq_dataset	= nr_seq_dataset_p;

select	concat(ds_segmento_clob_w,ds_segmento_w)
into STRICT	ds_segmento_clob_w
;

/*select	'FKT+'||
	NR_SEQ_301_IDENT_PROCESSO||'+'||
	NR_TRANSACAO||'+'||
	NR_IK_ORIGEM||'+'||
	NR_IK_DESTINO||chr(39)
into	ds_segmento_w
from	D301_SEGMENTO_FKT
where	nr_seq_dataset	= nr_seq_dataset_p;*/
ds_segmento_w  := OBTER_CONTEUDO_SEG_FKT_301( nr_seq_dataset_p, ds_segmento_w );

select	concat(ds_segmento_clob_w, ds_segmento_w)
into STRICT	ds_segmento_clob_w
;

select	'INV+'||
	CD_USUARIO_CONVENIO||'+'||
	obter_descricao_padrao('C301_12_STATUS_SEGURADO','IE_STATUS',NR_SEQ_301_STATUS_SEGURADO)||'+'||
	obter_descricao_padrao('C301_12_DOENCA_CRONICA','IE_DOENCA',NR_SEQ_301_DOENCA_CRONICA)||'+'||
	obter_descricao_padrao('C301_12_GRUPO_PESSOA','IE_GRUPO',NR_SEQ_301_GRUPO_PESSOA)||'+'||
	DS_MESANO_VALIDADE_CART||'+'||
	NR_INTERNO_SEGURADO||'+'||
	NR_EPISODIO_CONVENIO||'+'||
	NR_ARQUIVO_CONVENIO||'+'||
	DS_DT_INICIO_COBERT_CONV||'+'||
	NR_CONTRATO_CONV||chr(39)
into STRICT	ds_segmento_w
from	D301_SEGMENTO_INV
where	nr_seq_dataset	= nr_seq_dataset_p;

select	concat(ds_segmento_clob_w, ds_segmento_w)
into STRICT	ds_segmento_clob_w
;

select	'NAD+'||
	NM_SOBRENOME||'+'||
	DS_NOME||'+'||
	obter_descricao_padrao('C301_21_SEXO','IE_SEXO',NR_SEQ_301_SEXO)||'+'||
	DS_DT_NASCIMENTO||'+'||
	DS_RUA_NUMERO||'+'||
	CD_POSTAL||'+'||
	DS_CIDADE||'+'||
	DS_TITULACAO||'+'||
	obter_descricao_padrao('C301_7_PAIS','IE_PAIS',NR_SEQ_301_PAIS)||'+'||
	DS_SUFIXO_NOME||'+'||
	DS_PREFIXO_SOBRENOME||'+'||
	DS_COMPL_ENDERECO||chr(39)
into STRICT	ds_segmento_w
from	D301_SEGMENTO_NAD
where	nr_seq_dataset	= nr_seq_dataset_p;

select	concat(ds_segmento_clob_w, ds_segmento_w)
into STRICT	ds_segmento_clob_w
;

open C01;
loop
fetch C01 into
	c01_w;
EXIT WHEN NOT FOUND; /* apply on C01 */

	select	concat(ds_segmento_clob_w, c01_w.ds)
	into STRICT	ds_segmento_clob_w
	;

end loop;
close C01;

select	'UNT+'||
	QT_SEGMENTO||'+'||
	NR_REF_SEGMENTO||chr(39)
into STRICT	ds_segmento_w
from	D301_SEGMENTO_UNT
where	nr_seq_dataset	= nr_seq_dataset_p;

select	concat(ds_segmento_clob_w, ds_segmento_w)
into STRICT	ds_segmento_clob_w
;

CALL INSERIR_D301_DATASET_CONTEUDO(nm_usuario_p, nr_seq_dataset_p, ds_segmento_clob_w);

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_d301_conteudo_mbeg ( nr_seq_dataset_p bigint, nm_usuario_p text) FROM PUBLIC;

