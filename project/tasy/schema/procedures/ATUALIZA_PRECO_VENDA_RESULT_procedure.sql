-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE atualiza_preco_venda_result ( CD_MATERIAL_PAI_P bigint, CD_ESTABELECIMENTO_P bigint, CD_TAB_PRECO_MAT_P bigint, DT_INICIO_VIGENCIA_P timestamp, VL_PRECO_VENDA_P bigint, CD_MOEDA_P bigint, IE_BRASINDICE_P text, CD_UNIDADE_MEDIDA_P text, IE_SITUACAO_P text, NR_SEQUENCIA_NF_P bigint, NR_ITEM_NF_P bigint, CD_CGC_FORNECEDOR_P text, NM_USUARIO_P text) AS $body$
DECLARE


dt_atualizacao_w        	timestamp 		:= clock_timestamp();
cd_material_w			bigint;
qt_conversao_w			double precision;


c01 CURSOR FOR
	SELECT	cd_material,
			CASE WHEN qt_conversao=0 THEN 1  ELSE qt_conversao END
	from		material_preco_nf
	where		cd_material_pai	= cd_material_pai_p;


BEGIN

open c01;
	loop
	fetch c01 into
		cd_material_w,
		qt_conversao_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
	begin
	if (IE_SITUACAO_P	= 'I') then
		begin
		update	preco_material
		set		ie_situacao = 'I'
		where		cd_estabelecimento	= cd_estabelecimento_p
		and		cd_tab_preco_mat		= cd_tab_preco_mat_p
		and		cd_material			= cd_material_w
		and		nr_sequencia_nf		= nr_sequencia_nf_p;
		exception
     				when others then
     				qt_conversao_w := qt_conversao_w;
		end;
	end if;



	if (ie_situacao_p	= 'A') then
		begin
		insert	into preco_material(cd_estabelecimento,cd_tab_preco_mat,cd_material,
				dt_inicio_vigencia,vl_preco_venda,cd_moeda,
				ie_brasindice,dt_atualizacao,nm_usuario,
				cd_unidade_medida,ie_situacao,
				nr_sequencia_nf,nr_item_nf,cd_cgc_fornecedor)
		values (cd_estabelecimento_p,cd_tab_preco_mat_p,cd_material_w,
				dt_inicio_vigencia_p,(vl_preco_venda_p / qt_conversao_w) ,cd_moeda_p,
				'N',clock_timestamp(),nm_usuario_p,cd_unidade_medida_p,ie_situacao_p,
				nr_sequencia_nf_p,nr_item_nf_p,cd_cgc_fornecedor_p);
          	exception
            when others then
				begin
				update	preco_material
				set		vl_preco_venda	= (vl_preco_venda_p / qt_conversao_w),
						dt_atualizacao	= clock_timestamp(),
						nr_sequencia_nf	= nr_sequencia_nf_p,
						nr_item_nf		= nr_item_nf_p,
						cd_cgc_fornecedor	= cd_cgc_fornecedor_p,
 						ie_situacao 	= 'A'
				where		cd_estabelecimento	= cd_estabelecimento_p
				and		cd_tab_preco_mat		= cd_tab_preco_mat_p
				and		cd_material			= cd_material_w
				and		dt_inicio_vigencia	= dt_inicio_vigencia_p;
				exception
      					when others then
           					qt_conversao_w := qt_conversao_w;
				end;
		end;
	end if;

	begin
	delete 	from material_preco_dia
	where		cd_material = cd_material_w;
	exception
      		when others then
			qt_conversao_w := qt_conversao_w;
	end;

	end;
	end loop;
close c01;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE atualiza_preco_venda_result ( CD_MATERIAL_PAI_P bigint, CD_ESTABELECIMENTO_P bigint, CD_TAB_PRECO_MAT_P bigint, DT_INICIO_VIGENCIA_P timestamp, VL_PRECO_VENDA_P bigint, CD_MOEDA_P bigint, IE_BRASINDICE_P text, CD_UNIDADE_MEDIDA_P text, IE_SITUACAO_P text, NR_SEQUENCIA_NF_P bigint, NR_ITEM_NF_P bigint, CD_CGC_FORNECEDOR_P text, NM_USUARIO_P text) FROM PUBLIC;

