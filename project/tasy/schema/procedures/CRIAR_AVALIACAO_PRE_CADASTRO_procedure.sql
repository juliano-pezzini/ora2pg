-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE criar_avaliacao_pre_cadastro (nr_seq_pre_cadastro_p bigint, ie_tipo_pre_cadastro_p text, ie_liberacao_precad_p text, cd_estabelecimento_p bigint, nm_usuario_p text) AS $body$
DECLARE


dt_liberacao_w 					timestamp := null;
nm_usuario_w 					varchar(255) := null;														
nm_tabela_pre_cadastro_w 		varchar(255) := null;													
nm_campo_tipo_processo_w		varchar(255) := null;
nr_seq_precad_pf_w				pre_cad_avaliacao.nr_seq_precad_pf%type := null;
nr_seq_precad_pj_w				pre_cad_avaliacao.nr_seq_precad_pj%type := null;
nr_seq_precad_mat_w				pre_cad_avaliacao.nr_seq_precad_mat%type := null;
nr_seq_tipo_avaliacao_w			pre_cad_avaliacao.nr_seq_tipo_avaliacao%type := null;
cd_tipo_pessoa_fisica_w			pessoa_fisica_precad.cd_tipo_pj%type	:= null;
nr_nivel_w						processo_avaliacao.nr_nivel%type;
ultimo_nivel_w					processo_avaliacao.nr_nivel%type	:=	0;
nr_processo_w					processo_pre_cadastro.nr_sequencia%type;
													

BEGIN							

	if (ie_tipo_pre_cadastro_p = 'FPF') then
		nr_seq_precad_pf_w	:=	nr_seq_pre_cadastro_p;
		
		select max(p.cd_tipo_pj)
		into STRICT cd_tipo_pessoa_fisica_w
		from pessoa_fisica_precad p
		where p.nr_sequencia = nr_seq_pre_cadastro_p;
		
		select nr_seq_processo
		into STRICT nr_processo_w
		from pessoa_fisica_precad p
		where p.nr_sequencia = nr_seq_pre_cadastro_p;
		
		if (ie_liberacao_precad_p = 'S') then
			select max(a.nr_tipo_avaliacao) nr_tipo_avaliacao,
				   max(a.nr_nivel)
			into STRICT nr_seq_tipo_avaliacao_w,
				 nr_nivel_w
			from processo_avaliacao a 
			where a.ie_tipo_processo = ie_tipo_pre_cadastro_p
			and coalesce(a.cd_tipo_pessoa, 0) = coalesce(cd_tipo_pessoa_fisica_w, 0)
			and a.nr_nivel = retorna_nivel_inicial_precad(a.ie_tipo_processo,
														  a.cd_tipo_pessoa,
														  nm_usuario_p);
		else
			select max(a.nr_tipo_avaliacao) nr_tipo_avaliacao,
				   max(a.nr_nivel)
			into STRICT nr_seq_tipo_avaliacao_w,
				 nr_nivel_w
			from processo_avaliacao a 
			where a.ie_tipo_processo = ie_tipo_pre_cadastro_p
			and coalesce(a.cd_tipo_pessoa, 0)  = coalesce(cd_tipo_pessoa_fisica_w, 0) 
			and a.nr_nivel = obter_proximo_nivel_dispo(nr_seq_pre_cadastro_p,
													   ie_tipo_pre_cadastro_p,
													   cd_tipo_pessoa_fisica_w,
													   nm_usuario_p);
			
		end if;
			
	elsif (ie_tipo_pre_cadastro_p = 'FPJ') then
	
		nr_seq_precad_pj_w := nr_seq_pre_cadastro_p;
	
		select nr_seq_processo
		into STRICT nr_processo_w
		from pessoa_juridica_precad j
		where j.nr_sequencia = nr_seq_pre_cadastro_p;
	
		select max(j.cd_tipo_pessoa)
		into STRICT cd_tipo_pessoa_fisica_w
		from pessoa_juridica_precad j
		where j.nr_sequencia = nr_seq_pre_cadastro_p;
		
		if (ie_liberacao_precad_p = 'S') then
			select max(a.nr_tipo_avaliacao) nr_tipo_avaliacao,
				   max(a.nr_nivel)
			into STRICT nr_seq_tipo_avaliacao_w,
				nr_nivel_w
			from processo_avaliacao a 
			where a.ie_tipo_processo = ie_tipo_pre_cadastro_p
			and coalesce(a.cd_tipo_pessoa, 0) = coalesce(cd_tipo_pessoa_fisica_w, 0) 
			and a.nr_nivel = retorna_nivel_inicial_precad(a.ie_tipo_processo,
														a.cd_tipo_pessoa,
														nm_usuario_p);
		else
			select max(a.nr_tipo_avaliacao) nr_tipo_avaliacao,
				   max(a.nr_nivel)
			into STRICT nr_seq_tipo_avaliacao_w,
				 nr_nivel_w
			from processo_avaliacao a 
			where a.ie_tipo_processo = ie_tipo_pre_cadastro_p
			and coalesce(a.cd_tipo_pessoa, 0) =  coalesce(cd_tipo_pessoa_fisica_w, 0) 
			and a.nr_nivel = obter_proximo_nivel_dispo(nr_seq_pre_cadastro_p,
													   ie_tipo_pre_cadastro_p,
													   cd_tipo_pessoa_fisica_w,
													   nm_usuario_p);
		end if;
			
	elsif (ie_tipo_pre_cadastro_p = 'MAT') then
		nr_seq_precad_mat_w := nr_seq_pre_cadastro_p;
		
		select nr_seq_processo
		into STRICT nr_processo_w
		from material_precad mat
		where mat.nr_sequencia = nr_seq_pre_cadastro_p;
		
		if (ie_liberacao_precad_p = 'S') then
			select max(a.nr_tipo_avaliacao) nr_tipo_avaliacao,
				   max(a.nr_nivel)
			into STRICT nr_seq_tipo_avaliacao_w,
				nr_nivel_w
			from processo_avaliacao a 
			where a.ie_tipo_processo = ie_tipo_pre_cadastro_p
			and a.nr_nivel = retorna_nivel_inicial_precad(a.ie_tipo_processo,
														a.cd_tipo_pessoa,
														nm_usuario_p);
		else
			select max(a.nr_tipo_avaliacao) nr_tipo_avaliacao,
				   max(a.nr_nivel)
			into STRICT nr_seq_tipo_avaliacao_w,
				 nr_nivel_w
			from processo_avaliacao a 
			where a.ie_tipo_processo = ie_tipo_pre_cadastro_p
			and a.nr_nivel = obter_proximo_nivel_dispo(nr_seq_pre_cadastro_p,
													   ie_tipo_pre_cadastro_p,
													   cd_tipo_pessoa_fisica_w,
													   nm_usuario_p);
		end if;
	end if;
	
	if (nr_seq_tipo_avaliacao_w IS NOT NULL AND nr_seq_tipo_avaliacao_w::text <> '') then
		
		insert into pre_cad_avaliacao(nr_sequencia,
									nm_usuario_nrec,
									dt_atualizacao_nrec,
									nm_usuario,
									dt_atualizacao,
									ie_situacao,
									cd_estabelecimento,
									nr_seq_precad_pf,
									nr_seq_precad_pj,
									nr_seq_precad_mat,
									nr_seq_tipo_avaliacao,
									nr_nivel
								  ) values (nextval('pre_cad_avaliacao_seq'),
									nm_usuario_p,
									clock_timestamp(),
									nm_usuario_p,
									clock_timestamp(),
									'A',
									cd_estabelecimento_p,
									nr_seq_precad_pf_w,
									nr_seq_precad_pj_w,
									nr_seq_precad_mat_w,
									nr_seq_tipo_avaliacao_w,
									nr_nivel_w
								  );
		CALL enviar_email_avaliacao_precad(nr_processo_w,nr_seq_tipo_avaliacao_w,nr_nivel_w,nm_usuario_p);						
		commit;
	end if;
		
		
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE criar_avaliacao_pre_cadastro (nr_seq_pre_cadastro_p bigint, ie_tipo_pre_cadastro_p text, ie_liberacao_precad_p text, cd_estabelecimento_p bigint, nm_usuario_p text) FROM PUBLIC;

