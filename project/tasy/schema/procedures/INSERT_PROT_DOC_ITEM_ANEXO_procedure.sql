-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE insert_prot_doc_item_anexo ( NR_SEQUENCIA_P PROTOCOLO_DOCUMENTO.NR_SEQUENCIA%TYPE, NR_ATENDIMENTO_P PROTOCOLO_DOC_ITEM.NR_DOCUMENTO%TYPE, NR_INTERNO_CONTA_P PROTOCOLO_DOC_ITEM.NR_SEQ_INTERNO%TYPE, NR_SEQ_RELATORIO_P RELATORIO.NR_SEQUENCIA%TYPE, DS_FILENAME_P PROTOCOLO_DOC_ANEXO.DS_ARQUIVO%TYPE) AS $body$
DECLARE


nr_seq_item_w		PROTOCOLO_DOC_ITEM.NR_SEQ_ITEM%TYPE;
ds_titulo_w		RELATORIO.DS_TITULO%TYPE;
nm_usuario_w		PROTOCOLO_DOCUMENTO.NM_USUARIO%TYPE := wheb_usuario_pck.get_nm_usuario;
dt_atual_s		CONSTANT PROTOCOLO_DOCUMENTO.DT_ATUALIZACAO%TYPE := clock_timestamp();


BEGIN

	SELECT coalesce(max(a.nr_seq_item),0) + 1
	INTO STRICT   nr_seq_item_w
	FROM   PROTOCOLO_DOC_ITEM a;
	
	SELECT max(a.ds_titulo)
	INTO STRICT   ds_titulo_w
	FROM   RELATORIO a
	WHERE  a.nr_sequencia = NR_SEQ_RELATORIO_P;
	
	INSERT INTO PROTOCOLO_DOC_ITEM(
		nr_sequencia,
		nr_documento,
		nm_usuario,
		dt_atualizacao,
		nr_seq_interno,
		ds_documento,
		nr_seq_item,
		nr_seq_relatorio
	) VALUES (
		NR_SEQUENCIA_P,
		NR_ATENDIMENTO_P,
		nm_usuario_w,
		dt_atual_s,
		NR_INTERNO_CONTA_P,
		ds_titulo_w,
		nr_seq_item_w,
		NR_SEQ_RELATORIO_P
	);
	
	INSERT INTO PROTOCOLO_DOC_ANEXO(
		ds_arquivo,
		nm_usuario,
		nm_usuario_nrec,
		dt_atualizacao,
		dt_atualizacao_nrec,
		nr_seq_protocolo,
		nr_sequencia
	) VALUES (
		DS_FILENAME_P,
		nm_usuario_w,
		nm_usuario_w,
		dt_atual_s,
		dt_atual_s,
		NR_SEQUENCIA_P,
		nr_seq_item_w
	);

COMMIT;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE insert_prot_doc_item_anexo ( NR_SEQUENCIA_P PROTOCOLO_DOCUMENTO.NR_SEQUENCIA%TYPE, NR_ATENDIMENTO_P PROTOCOLO_DOC_ITEM.NR_DOCUMENTO%TYPE, NR_INTERNO_CONTA_P PROTOCOLO_DOC_ITEM.NR_SEQ_INTERNO%TYPE, NR_SEQ_RELATORIO_P RELATORIO.NR_SEQUENCIA%TYPE, DS_FILENAME_P PROTOCOLO_DOC_ANEXO.DS_ARQUIVO%TYPE) FROM PUBLIC;

