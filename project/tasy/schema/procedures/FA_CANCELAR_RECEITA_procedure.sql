-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE fa_cancelar_receita ( nr_sequencia_p bigint, nm_usuario_p text, nr_seq_motivo_canc_p bigint default null) AS $body$
DECLARE


qtd_entrega_w			bigint;
VarIeConsisteCancel_w	varchar(1) := 'S';
nr_seq_regulacao_w		regulacao_atend.nr_sequencia%Type;
ie_integracao_w 		varchar(2);
nr_atendimento_w        FA_RECEITA_FARMACIA.NR_ATENDIMENTO%TYPE;


BEGIN

VarIeConsisteCancel_w := Obter_Param_Usuario(10015, 52, obter_perfil_ativo, nm_usuario_p, Wheb_Usuario_pck.Get_cd_estabelecimento, VarIeConsisteCancel_w);

if (nr_sequencia_p IS NOT NULL AND nr_sequencia_p::text <> '') then

	if (VarIeConsisteCancel_w = 'S') then
		select	count(*)
		into STRICT	qtd_entrega_w
		from	fa_entrega_medicacao
		where	nr_seq_receita_amb = nr_sequencia_p
		and	coalesce(dt_cancelamento::text, '') = '';
		
		if (qtd_entrega_w > 0) then
			-- Para cancelar a receita e necessario cancelar as entregas. Favor verificar
			CALL wheb_mensagem_pck.exibir_mensagem_abort(228528);
		end if;
		
	else
		-- Verificar se tem entrega vinculada a receita
		select	count(*)
		into STRICT	qtd_entrega_w
		from	fa_entrega_medicacao
		where	nr_seq_receita_amb = nr_sequencia_p;

		if (qtd_entrega_w > 0) then
			-- Nao e possivel cancelar uma receita que ja teve entrega. Favor verificar
			CALL wheb_mensagem_pck.exibir_mensagem_abort(228529);
		end if;
	end if;
	
	update	fa_receita_farmacia
	set	DT_CANCELAMENTO = clock_timestamp(),
		dt_atualizacao  = clock_timestamp(),
		nm_usuario	= nm_usuario_p,
		nm_usuario_canc	= nm_usuario_p,
		nr_seq_motivo_canc = nr_seq_motivo_canc_p
	where 	nr_sequencia 	= nr_sequencia_p;
	
	
	Select  max(nr_sequencia)
	into STRICT	nr_seq_regulacao_w
	from	regulacao_atend
	where 	nr_Seq_receita_amb = nr_sequencia_p;
	
	if ( coalesce(nr_seq_regulacao_w,0) > 0) then
	
		  select	coalesce(max('S'),'N')
			into STRICT	ie_integracao_w
			from	fa_receita_farmacia r
			where	r.nr_sequencia = nr_seq_regulacao_w
			and		(r.nr_seq_origem IS NOT NULL AND r.nr_seq_origem::text <> '');
	
			CALL alterar_status_regulacao(nr_seq_regulacao_w,'CA','',null,'S',null, null, ie_integracao_w);
			
	end if;

  if (coalesce(pkg_i18n.get_user_locale, 'pt_BR') = 'es_CO') then

    SELECT max(a.nr_atendimento)
    INTO STRICT   nr_atendimento_w
    FROM   FA_RECEITA_FARMACIA a
    WHERE  a.nr_sequencia = nr_sequencia_p;

    CALL suspender_prescr_mipres(
      nr_prescricao_p => null,
      nr_seq_item_cpoe_p => null,
      nr_atendimento_p => nr_atendimento_w,
      nr_seq_receita_amb_p => nr_sequencia_p,
      ie_funcao_origem_p => 'P');
  end if;
	
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE fa_cancelar_receita ( nr_sequencia_p bigint, nm_usuario_p text, nr_seq_motivo_canc_p bigint default null) FROM PUBLIC;

