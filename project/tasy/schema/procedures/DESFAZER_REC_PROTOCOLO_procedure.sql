-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE desfazer_rec_protocolo ( nr_seq_protocolo_p bigint) AS $body$
DECLARE

 
nm_usuario_w			usuario.nm_usuario%type	:= wheb_usuario_pck.get_nm_usuario;
cd_estabelecimento_w		estabelecimento.cd_estabelecimento%type	:= wheb_usuario_pck.get_cd_estabelecimento;
ie_exclui_etapa_conta_w		varchar(1);
ie_tipo_protocolo_w		protocolo_documento.ie_tipo_protocolo%type;
nr_interno_conta_w		protocolo_doc_item.nr_seq_interno%type;

C01 CURSOR FOR 
	SELECT	distinct a.nr_seq_interno 
	from	protocolo_doc_item a 
	where	a.nr_sequencia = nr_seq_protocolo_p 
	and	(a.nr_seq_interno IS NOT NULL AND a.nr_seq_interno::text <> '') 
	and	exists (SELECT 1 from conta_paciente x 
			where	x.nr_interno_conta = a.nr_seq_interno);

 

BEGIN 
 
ie_exclui_etapa_conta_w := obter_param_usuario(290, 111, obter_perfil_Ativo, nm_usuario_w, cd_estabelecimento_w, ie_exclui_etapa_conta_w);
 
select	max(ie_tipo_protocolo) 
into STRICT	ie_tipo_protocolo_w 
from	protocolo_documento 
where	nr_sequencia = nr_seq_protocolo_p;
 
update	protocolo_documento 
set	dt_fechamento		 = NULL, 
	dt_rec_destino		 = NULL, 
	nm_usuario_receb		 = NULL 
where	nr_sequencia		= nr_seq_protocolo_p;
 
update	protocolo_doc_item 
set	dt_recebimento		 = NULL, 
	nm_usuario_receb		 = NULL, 
	nr_seq_etapa_conta	 = NULL 
where	nr_sequencia		= nr_seq_protocolo_p 
and	coalesce(dt_entrega_pac::text, '') = '';
 
if (ie_exclui_etapa_conta_w = 'S') then 
 
	delete	FROM conta_paciente_etapa 
	where	nr_seq_prot_documento = nr_seq_protocolo_p;
 
end if;
 
 
if (ie_tipo_protocolo_w = '5') then 
	 
	open C01;
	loop 
	fetch C01 into	 
		nr_interno_conta_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin 
		CALL gerar_etapa_conta(nr_interno_conta_w,'2',nm_usuario_w);
		end;
	end loop;
	close C01;				
 
end if;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE desfazer_rec_protocolo ( nr_seq_protocolo_p bigint) FROM PUBLIC;

