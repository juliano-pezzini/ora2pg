-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_solucao_reposicao_he (nr_prescricao_p bigint, nr_sequencia_p bigint, nm_usuario_p text) AS $body$
DECLARE


nr_etapas_w					smallint;
cd_material_w				integer;
nr_seq_solucao_w			integer;
nr_agrupamento_w			integer;
qt_hora_validade_w			bigint;
nr_seq_w					bigint;
qt_hora_fase_w				double precision;
qt_dosagem_w				double precision;
qt_vol_etapa_w				double precision;
qt_solucao_total_w			double precision;
hr_prim_horario_w			varchar(5);
ie_bomba_infusao_w			varchar(50);
ds_horarios_w				varchar(2000);
ds_horarios_2w				varchar(2000);
dt_primeiro_horario_w		timestamp;

C01 CURSOR FOR
SELECT	d.cd_material,
	a.qt_vol_etapa
from	prescr_rep_he_elem_mat a,
	prescr_rep_he_elem b,
	prescr_rep_he c,
	nut_elem_material d
where	a.nr_seq_ele_rep = b.nr_sequencia
and	b.nr_seq_rep_he  = c.nr_sequencia
and	a.nr_seq_elem_mat = d.nr_sequencia
and	c.nr_sequencia = nr_sequencia_p
and	c.nr_prescricao = nr_prescricao_p
and	coalesce(a.qt_vol_etapa,0) > 0;


BEGIN

if (nr_prescricao_p IS NOT NULL AND nr_prescricao_p::text <> '') and (nr_sequencia_p IS NOT NULL AND nr_sequencia_p::text <> '') then

	select	nextval('prescr_solucao_seq')
	into STRICT	nr_seq_solucao_w
	;

	select	to_char(dt_primeiro_horario,'hh24:mi'),
			coalesce(dt_inicio_prescr,dt_primeiro_horario)
	into STRICT	hr_prim_horario_w,
			dt_primeiro_horario_w
	from	prescr_medica
	where	nr_prescricao = nr_prescricao_p;

	select	coalesce(max(nr_agrupamento),0) + 1
	into STRICT	nr_agrupamento_w
	from	prescr_solucao
	where	nr_prescricao = nr_prescricao_p;

	select	sum(a.qt_vol_etapa)
	into STRICT	qt_solucao_total_w
	from	prescr_rep_he_elem_mat a,
		prescr_rep_he_elem b,
		prescr_rep_he c
	where	a.nr_seq_ele_rep = b.nr_sequencia
	and	b.nr_seq_rep_he  = c.nr_sequencia
	and	c.nr_sequencia = nr_sequencia_p
	and	c.nr_prescricao = nr_prescricao_p;

	select	max(qt_hora_validade),
		max(qt_etapa),
		max(qt_hora_fase),
		max(ie_bomba_infusao)
	into STRICT	qt_hora_validade_w,
		nr_etapas_w,
		qt_hora_fase_w,
		ie_bomba_infusao_w
	from	prescr_rep_he
	where	nr_prescricao = nr_prescricao_p
	and	nr_sequencia  = nr_sequencia_p;

	SELECT * FROM Calcula_Horarios_Etapas(to_date(to_char(dt_primeiro_horario_w,'dd/mm/yyyy ')||hr_prim_horario_w,'dd/mm/yyyy hh24:mi'), nr_etapas_w, dividir(qt_hora_validade_w,nr_etapas_w), nm_usuario_p, 'N', qt_hora_validade_w, ds_horarios_w, ds_horarios_2w, null, 'N') INTO STRICT ds_horarios_w, ds_horarios_2w;

	insert into prescr_solucao(nr_prescricao,
							   nr_seq_solucao,
							   ie_via_aplicacao,
							   dt_atualizacao,
							   nm_usuario,
							   cd_unidade_medida,
							   ie_tipo_dosagem,
							   qt_dosagem,
							   qt_solucao_total,
							   qt_tempo_aplicacao,
							   qt_volume,
							   nr_etapas,
							   ie_bomba_infusao,
							   ie_suspenso,
							   ie_calc_aut,
							   ie_acm,
							   qt_hora_fase,
							   ds_horarios,
							   hr_prim_horario,
							   ie_urgencia,
							   ds_solucao,
							   ie_solucao_especial,
							   ie_se_necessario,
							   ds_orientacao,
							   ie_tipo_sol,
							   ie_esquema_alternado,
							   nr_agrupamento)
	(SELECT	nr_prescricao,
			nr_seq_solucao_w,
			OBTER_VIA_USUARIO('IV'),
			clock_timestamp(),
			nm_usuario_p,
			'mlh',
			'mlh',
			null,
			qt_solucao_total_w * qt_etapa,
			qt_hora_validade,
			null,
			qt_etapa,
			coalesce(ie_bomba_infusao_w,'N'),
			'N',
			'S',
			null,
			qt_hora_fase,
			ds_horarios_w,
			hr_prim_horario_w,
			'N',
			obter_desc_expressao(782498),--'Terapia de reidratação endovenosa (TREV)',
			'N',
			'N',
			null,
			null,
			'N',
			nr_agrupamento_w
	from		prescr_rep_he
	where	nr_prescricao = nr_prescricao_p
	and		nr_sequencia  = nr_sequencia_p);

	commit;

	open C01;
	loop
	fetch C01 into
		cd_material_w,
		qt_vol_etapa_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */

		select	coalesce(max(nr_sequencia),0) + 1
		into STRICT	nr_seq_w
		from	prescr_material
		where	nr_prescricao = nr_prescricao_p;

		insert into prescr_material(nr_sequencia,
									nr_prescricao,
									cd_material,
									ie_agrupador,
									cd_unidade_medida,
									cd_unidade_medida_dose,
									nr_sequencia_solucao,
									qt_dose,
									qt_unitaria,
									qt_material,
									qt_solucao,
									ie_origem_inf,
									dt_atualizacao,
									nm_usuario)
				values (nr_seq_w,
						nr_prescricao_p,
						cd_material_w,
						4,
						OBTER_UNID_MED_USUA('ml'),
						OBTER_UNID_MED_USUA('ml'),
						nr_seq_solucao_w,
						qt_vol_etapa_w,
						1,
						1,
						qt_vol_etapa_w,
						'N',
						clock_timestamp(),
						nm_usuario_p);

			commit;

	end loop;
	close C01;

	qt_dosagem_w := Calcular_Volume_Total_Solucao(OBTER_UNID_MED_USUA('ml'), qt_hora_validade_w, qt_solucao_total_w, null, nr_prescricao_p, nr_seq_solucao_w, 1, qt_dosagem_w, 'S', nr_etapas_w, 'N', qt_hora_fase_w);

	if (qt_dosagem_w IS NOT NULL AND qt_dosagem_w::text <> '') and (qt_dosagem_w > 0) then
		update	prescr_solucao
		set	qt_dosagem = qt_dosagem_w
		where	nr_prescricao = nr_prescricao_p
		and	nr_seq_solucao = nr_seq_solucao_w;
	end if;

end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_solucao_reposicao_he (nr_prescricao_p bigint, nr_sequencia_p bigint, nm_usuario_p text) FROM PUBLIC;

