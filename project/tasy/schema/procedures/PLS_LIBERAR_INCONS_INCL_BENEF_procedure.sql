-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_liberar_incons_incl_benef ( nr_seq_incon_inclusao_benef_p pls_inconsist_incl_benef.nr_sequencia%type, nm_usuario_p pls_inconsist_incl_benef.nm_usuario_liberacao%type) AS $body$
DECLARE


nr_seq_solic_inclusao_w       pls_inclusao_beneficiario.nr_sequencia%type;
qt_incons_solic_benef_w	      bigint;
ie_status_solic_w	      pls_inclusao_beneficiario.ie_status%type;
ie_status_intercambio_w	      pls_inclusao_beneficiario.ie_status_intercambio%type;
nr_seq_intercambio_w	      pls_inclusao_beneficiario.nr_seq_intercambio%type;	


BEGIN

select	nr_seq_solic_inclusao
into STRICT 	  nr_seq_solic_inclusao_w
from  	pls_inconsist_incl_benef
where 	nr_sequencia = nr_seq_incon_inclusao_benef_p;

select 	ie_status,
	      ie_status_intercambio,
	      nr_seq_intercambio
into STRICT    ie_status_solic_w,
	      ie_status_intercambio_w,
	      nr_seq_intercambio_w
from 	  pls_inclusao_beneficiario
where 	nr_sequencia = nr_seq_solic_inclusao_w;

if ((coalesce(nr_seq_intercambio_w::text, '') = '' and ie_status_solic_w = 'I')
     or ((nr_seq_intercambio_w IS NOT NULL AND nr_seq_intercambio_w::text <> '') and ie_status_intercambio_w = 'I')) then 
	
	update	pls_inconsist_incl_benef
	set 	  nm_usuario_liberacao = nm_usuario_p, 
		      dt_liberacao    = clock_timestamp(),
		      dt_atualizacao 	= clock_timestamp(),
		      nm_usuario    	= nm_usuario_p
	where 	nr_sequencia    = nr_seq_incon_inclusao_benef_p;

	select 	count(1)
	into STRICT	  qt_incons_solic_benef_w
	from 	  pls_inconsist_incl_benef
	where 	nr_seq_solic_inclusao = nr_seq_solic_inclusao_w
	and     coalesce(dt_liberacao::text, '') = '';

	if (qt_incons_solic_benef_w = 0) then
		if (coalesce(nr_seq_intercambio_w::text, '') = '') then
			update	pls_inclusao_beneficiario
			set 	  ie_status 	    = 'P',
				      dt_atualizacao 	= clock_timestamp(),
				      nm_usuario    	= nm_usuario_p
			where 	nr_sequencia 	  = nr_seq_solic_inclusao_w;
		else
			update	pls_inclusao_beneficiario
			set 	  ie_status_intercambio	= 'P',
				      ie_status 		        = 'P',
				      dt_atualizacao 		    = clock_timestamp(),
				      nm_usuario    	      = nm_usuario_p
			where 	nr_sequencia 		      = nr_seq_solic_inclusao_w;
		end if;
	end if;

  commit;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_liberar_incons_incl_benef ( nr_seq_incon_inclusao_benef_p pls_inconsist_incl_benef.nr_sequencia%type, nm_usuario_p pls_inconsist_incl_benef.nm_usuario_liberacao%type) FROM PUBLIC;

