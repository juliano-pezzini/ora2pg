-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_lote_exame_result ( nr_seq_lote_p bigint, ie_exames_sem_result_p text, nm_usuario_p text) AS $body$
DECLARE

nr_prescricao_w		bigint;
nr_seq_prescr_w		bigint;
nr_seq_exame_w		bigint;
nr_seq_material_w		bigint;
nr_prescricao_ant_w	bigint := 0;
nr_seq_resultado_w	bigint;
qt_idade_w			integer;
ie_sexo_w			varchar(1);
ie_exames_sem_result_w	varchar(10);

C01 CURSOR FOR 
	SELECT a.nr_prescricao, 
		 a.nr_seq_prescr, 
		 b.nr_seq_exame, 
		 c.nr_sequencia 
	from	material_exame_lab c, 
		prescr_procedimento b, 
		Lab_Lote_Exame_Item a 
	where 	a.nr_seq_lote = nr_seq_lote_p 
	 and 	a.nr_prescricao = b.nr_prescricao 
	 and 	a.nr_seq_prescr = b.nr_sequencia 
	 and 	b.cd_material_exame = c.cd_material_exame 
	 and	((ie_exames_sem_result_w = 'N') or (b.ie_status_atend >= 30));

BEGIN
ie_exames_sem_result_w := coalesce(ie_exames_sem_result_p,'N');
 
if (ie_exames_sem_result_w <> 'S') then 
	update prescr_procedimento 
	set	ie_amostra = 'S', 
		ie_status_atend = 30 
	where ie_status_atend < 30 
	 and (nr_prescricao,nr_sequencia) in (	SELECT nr_prescricao, nr_seq_prescr 
							from lab_lote_exame_item 
							where nr_seq_lote = nr_seq_lote_p);
end if;
 
open C01;
loop 
	fetch C01 into	nr_prescricao_w, 
				nr_seq_prescr_w, 
				nr_seq_exame_w, 
				nr_seq_material_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
	if (nr_prescricao_w <> nr_prescricao_ant_w) then 
		CALL gera_exame_result_lab(nr_prescricao_w, nr_seq_prescr_w, 'S', 'S', 'N', nm_usuario_p);
		select obter_idade(c.dt_nascimento, clock_timestamp(), 'A'), 
			 c.ie_sexo 
		into STRICT	qt_idade_w, 
			ie_sexo_w 
		from	pessoa_fisica c, 
			atendimento_paciente b, 
			prescr_medica a 
		where a.nr_atendimento = b.nr_atendimento 
		 and b.cd_pessoa_fisica = c.cd_pessoa_fisica 
		 and a.nr_prescricao = nr_prescricao_w;
	end if;
	select coalesce(max(nr_seq_resultado),0) 
	into STRICT nr_seq_resultado_w 
	from exame_lab_resultado 
	where nr_prescricao = nr_prescricao_w;
	if (nr_seq_resultado_w <> 0) then 
		CALL gera_resultado_lab(nr_seq_resultado_w, nr_prescricao_w, nr_seq_prescr_w, nr_seq_exame_w, 
					 nr_seq_material_w, qt_idade_w, ie_sexo_w, nm_usuario_p);
	end if;
end loop;
close C01;
 
update lab_lote_exame 
set ie_status = 'D' 
where nr_sequencia = nr_seq_lote_p;
 
commit;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_lote_exame_result ( nr_seq_lote_p bigint, ie_exames_sem_result_p text, nm_usuario_p text) FROM PUBLIC;

