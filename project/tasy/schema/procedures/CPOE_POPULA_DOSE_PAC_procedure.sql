-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE cpoe_popula_dose_pac ( cd_pessoa_fisica_p text, nm_usuario_p text) AS $body$
DECLARE





cd_pessoa_fisica_w		dbms_sql.varchar2_table;
nr_atendimento_w		dbms_sql.number_table;
cd_material_w			dbms_sql.number_table;
qt_dose_w				dbms_sql.number_table;
cd_unidade_medida_w		dbms_sql.varchar2_table;
i						integer;

c01 CURSOR FOR
SELECT	a.cd_pessoa_fisica,
		a.nr_atendimento,
		c.cd_material,
		d.cd_unidade_medida_consumo,
		sum(obter_dose_convertida(c.cd_material,coalesce(b.qt_dose,0),c.cd_unidade_medida_dose,d.cd_unidade_medida_consumo))
from	prescr_mat_hor c,
		prescr_material b,
		material d,
		prescr_medica a
where	a.nr_prescricao		= b.nr_prescricao
and		a.cd_pessoa_fisica	= cd_pessoa_fisica_p
and		b.nr_prescricao		= c.nr_prescricao
and		b.nr_sequencia		= c.nr_seq_material
and		b.cd_material		= d.cd_material
and		c.cd_material		= d.cd_material
and		coalesce(a.dt_suspensao::text, '') = ''
and		coalesce(b.ie_suspenso,'N')	= 'N'
and		coalesce(c.dt_suspensao::text, '') = ''
and		(c.dt_fim_horario IS NOT NULL AND c.dt_fim_horario::text <> '')
and		Obter_se_horario_liberado(c.dt_lib_horario, c.dt_horario) = 'S'
group by
		a.cd_pessoa_fisica,
		a.nr_atendimento,
		c.cd_material,
		d.cd_unidade_medida_consumo;


BEGIN

open c01;
loop
	fetch c01 bulk collect into 	cd_pessoa_fisica_w,
									nr_atendimento_w,
									cd_material_w,
									cd_unidade_medida_w,
									qt_dose_w
	limit 2000;
	exit when cd_pessoa_fisica_w.count = 0;

	forall i in cd_pessoa_fisica_w.first..cd_pessoa_fisica_w.last
	insert into	cpoe_pac_dose_material(
				nr_sequencia,
				nr_atendimento,
				cd_pessoa_fisica,
				cd_material,
				qt_dose,
				cd_unidade_medida,
				nm_usuario,
				nm_usuario_nrec,
				dt_atualizacao,
				dt_atualizacao_nrec)
			values (
				nextval('cpoe_pac_dose_material_seq'),
				nr_atendimento_w(i),
				cd_pessoa_fisica_w(i),
				cd_material_w(i),
				qt_dose_w(i),
				cd_unidade_medida_w(i),
				nm_usuario_p,
				nm_usuario_p,
				clock_timestamp(),
				clock_timestamp());

	commit;

end loop;
close c01;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cpoe_popula_dose_pac ( cd_pessoa_fisica_p text, nm_usuario_p text) FROM PUBLIC;

