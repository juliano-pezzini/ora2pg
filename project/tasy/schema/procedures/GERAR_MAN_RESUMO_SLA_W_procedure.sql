-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_man_resumo_sla_w ((dt_referencia_p timestamp) is man_resumo_sla_ww man_resumo_sla_w) RETURNS bigint AS $body$
DECLARE


	qt_meta_w		double precision;
	
BEGIN
	if (ie_tipo_sla_p = 'CSLA') then
		qt_meta_w	:= obter_meta_bsc_sla(nr_seq_indicador_p,dt_referencia_p);
	elsif (ie_tipo_sla_p = 'ALLDEF') then
		qt_meta_w	:= obter_meta_bsc_sla(852,dt_referencia_p);
	else
		qt_meta_w	:= 95;
	end if;
	return qt_meta_w;
	end;

begin

delete 	from man_resumo_sla_w
where	trunc(dt_referencia,'month') = dt_referencia_p;

man_resumo_sla_ww.dt_referencia	:= dt_referencia_p;
man_resumo_sla_ww.ie_informacao	:= 'T';

/*#################################################### SLA with penalty*/

man_resumo_sla_ww.ie_tipo_sla	:= 'SWP';

-- Buscar as OS's com estouro de resposta da gerência
select	count(distinct nr_seq_ordem_serv)
into STRICT	qt_atraso_resposta_w
from 	man_ordem_situacao_sla a
where	ie_interno				= 'N'
and	ie_tipo_sla				in ('CSFP', 'COSP')
and ((NR_SEQ_GER_DES_RESP IS NOT NULL AND NR_SEQ_GER_DES_RESP::text <> '') or (NR_SEQ_GER_SUP_RESP IS NOT NULL AND NR_SEQ_GER_SUP_RESP::text <> ''))
and	not exists (SELECT	1
		from	man_ordem_situacao_sla x
		where	x.nr_seq_ordem_serv 	= a.nr_seq_ordem_serv
		and	trunc(x.dt_situacao,'month') 	= man_resumo_sla_ww.dt_referencia
		and	x.ie_situacao_atual	= 'S'
		and	x.ie_classificacao	<> 'E')
and	trunc(dt_estouro_resposta,'month')	= man_resumo_sla_ww.dt_referencia;

-- Buscar as OS's com estouro de solução da gerência
select	count(distinct nr_seq_ordem_serv)
into STRICT	qt_atraso_solucao_w
from 	man_ordem_situacao_sla a
where	ie_interno	= 'N'
and ((NR_SEQ_GER_DES_SOLU IS NOT NULL AND NR_SEQ_GER_DES_SOLU::text <> '') or (NR_SEQ_GER_SUP_SOLU IS NOT NULL AND NR_SEQ_GER_SUP_SOLU::text <> ''))
and	not exists (SELECT	1
		from	man_ordem_situacao_sla x
		where	x.nr_seq_ordem_serv 	= a.nr_seq_ordem_serv
		and	trunc(x.dt_situacao,'month') 	= man_resumo_sla_ww.dt_referencia
		and	x.ie_situacao_atual	= 'S'
		and	x.ie_classificacao	<> 'E')
and	ie_tipo_sla	in ('CSFP', 'COSP')
and	trunc(dt_estouro_solucao,'month')	= man_resumo_sla_ww.dt_referencia;

select	count(distinct nr_seq_ordem_serv)
into STRICT	qt_recebidas_w
from 	man_ordem_situacao_sla a
where	ie_interno		= 'N'
and	trunc(a.dt_situacao,'month') 	= man_resumo_sla_ww.dt_referencia
and ((nr_seq_gerencia_des IS NOT NULL AND nr_seq_gerencia_des::text <> '') or (nr_seq_gerencia_sup IS NOT NULL AND nr_seq_gerencia_sup::text <> ''))
and	not exists (SELECT	1
		from	man_ordem_situacao_sla x
		where	x.nr_seq_ordem_serv 	= a.nr_seq_ordem_serv
		and	trunc(x.dt_situacao,'month') 	= man_resumo_sla_ww.dt_referencia
		and	x.ie_situacao_atual	= 'S'
		and	x.ie_classificacao	<> 'E')
and	ie_tipo_sla	in ('CSFP', 'COSP')
and	exists (select	1
	from	man_ordem_situacao_sla y
	where 	trunc(y.dt_situacao,'month') 	= man_resumo_sla_ww.dt_referencia
	and	y.nr_seq_ordem_serv		= a.nr_seq_ordem_serv
	and	y.ie_status_os			= 'A');

man_resumo_sla_ww.qt_atraso_resposta	:= qt_atraso_resposta_w;
man_resumo_sla_ww.qt_atraso_solucao	:= qt_atraso_solucao_w;
man_resumo_sla_ww.qt_sla		:= qt_recebidas_w;
man_resumo_sla_ww.qt_sla_calculo	:= qt_recebidas_w * 2;
man_resumo_sla_ww.pr_atingido		:= 100-(dividir((qt_atraso_resposta_w + qt_atraso_solucao_w),qt_recebidas_w * 2)*100);
man_resumo_sla_ww.qt_target		:= obter_meta_sla(null,man_resumo_sla_ww.dt_referencia,'SWP');

insert into man_resumo_sla_w values (man_resumo_sla_ww.*);

/*#################################################### SLA with contract*/

man_resumo_sla_ww.ie_tipo_sla	:= 'SWC';

-- Buscar as OS's com estouro de resposta da gerência
select	count(distinct nr_seq_ordem_serv)
into STRICT	qt_atraso_resposta_w
from 	man_ordem_situacao_sla a
where	ie_interno				= 'N'
and ((NR_SEQ_GER_DES_RESP IS NOT NULL AND NR_SEQ_GER_DES_RESP::text <> '') or (NR_SEQ_GER_SUP_RESP IS NOT NULL AND NR_SEQ_GER_SUP_RESP::text <> ''))
and	not exists (SELECT	1
		from	man_ordem_situacao_sla x
		where	x.nr_seq_ordem_serv 	= a.nr_seq_ordem_serv
		and	trunc(x.dt_situacao,'month') 	= man_resumo_sla_ww.dt_referencia
		and	x.ie_situacao_atual	= 'S'
		and	x.ie_classificacao	<> 'E')
and	ie_tipo_sla				in ('CSFNP', 'COSNP', 'CSFP', 'COSP')
and	trunc(dt_estouro_resposta,'month')	= man_resumo_sla_ww.dt_referencia;

-- Buscar as OS's com estouro de solução da gerência
select	count(distinct nr_seq_ordem_serv)
into STRICT	qt_atraso_solucao_w
from 	man_ordem_situacao_sla a
where	ie_interno	= 'N'
and ((NR_SEQ_GER_DES_SOLU IS NOT NULL AND NR_SEQ_GER_DES_SOLU::text <> '') or (NR_SEQ_GER_SUP_SOLU IS NOT NULL AND NR_SEQ_GER_SUP_SOLU::text <> ''))
and	not exists (SELECT	1
		from	man_ordem_situacao_sla x
		where	x.nr_seq_ordem_serv 	= a.nr_seq_ordem_serv
		and	trunc(x.dt_situacao,'month') 	= man_resumo_sla_ww.dt_referencia
		and	x.ie_situacao_atual	= 'S'
		and	x.ie_classificacao	<> 'E')
and	ie_tipo_sla	in ('CSFNP', 'COSNP', 'CSFP', 'COSP')
and	trunc(dt_estouro_solucao,'month')	= man_resumo_sla_ww.dt_referencia;

select	count(distinct nr_seq_ordem_serv)
into STRICT	qt_recebidas_w
from 	man_ordem_situacao_sla a
where	ie_interno		= 'N'
and	trunc(a.dt_situacao,'month') 	= man_resumo_sla_ww.dt_referencia
and ((nr_seq_gerencia_des IS NOT NULL AND nr_seq_gerencia_des::text <> '') or (nr_seq_gerencia_sup IS NOT NULL AND nr_seq_gerencia_sup::text <> ''))
and	not exists (SELECT	1
		from	man_ordem_situacao_sla x
		where	x.nr_seq_ordem_serv 	= a.nr_seq_ordem_serv
		and	trunc(x.dt_situacao,'month') 	= man_resumo_sla_ww.dt_referencia
		and	x.ie_situacao_atual	= 'S'
		and	x.ie_classificacao	<> 'E')
and	ie_tipo_sla	in ('CSFNP', 'COSNP', 'CSFP', 'COSP')
and	exists (select	1
	from	man_ordem_situacao_sla y
	where 	trunc(y.dt_situacao,'month') 	= man_resumo_sla_ww.dt_referencia
	and	y.nr_seq_ordem_serv		= a.nr_seq_ordem_serv
	and	y.ie_status_os			= 'A');

man_resumo_sla_ww.qt_atraso_resposta	:= qt_atraso_resposta_w;
man_resumo_sla_ww.qt_atraso_solucao	:= qt_atraso_solucao_w;
man_resumo_sla_ww.qt_sla		:= qt_recebidas_w;
man_resumo_sla_ww.qt_sla_calculo	:= qt_recebidas_w * 2;
man_resumo_sla_ww.pr_atingido		:= 100-(dividir((qt_atraso_resposta_w + qt_atraso_solucao_w),qt_recebidas_w * 2)*100);
man_resumo_sla_ww.qt_target		:= obter_meta_sla(null,man_resumo_sla_ww.dt_referencia,'SWC');

insert into man_resumo_sla_w values (man_resumo_sla_ww.*);
/*#################################################### Customer SLAs
*/
man_resumo_sla_ww.ie_tipo_sla	:= 'CSLA';

select	count(distinct nr_seq_ordem_serv)
into STRICT	qt_atraso_resposta_w
from 	man_ordem_situacao_sla a
where	ie_interno				= 'N'
and ((NR_SEQ_GER_DES_RESP IS NOT NULL AND NR_SEQ_GER_DES_RESP::text <> '') or (NR_SEQ_GER_SUP_RESP IS NOT NULL AND NR_SEQ_GER_SUP_RESP::text <> ''))
and	not exists (SELECT	1
		from	man_ordem_situacao_sla x
		where	x.nr_seq_ordem_serv 	= a.nr_seq_ordem_serv
		and	trunc(x.dt_situacao,'month') 	= man_resumo_sla_ww.dt_referencia
		and	x.ie_situacao_atual	= 'S'
		and	x.ie_classificacao	<> 'E')
and	trunc(dt_estouro_resposta,'month')	= man_resumo_sla_ww.dt_referencia;

-- Buscar as OS's com estouro de solução da gerência
select	count(distinct nr_seq_ordem_serv)
into STRICT	qt_atraso_solucao_w
from 	man_ordem_situacao_sla a
where	ie_interno	= 'N'
and ((NR_SEQ_GER_DES_SOLU IS NOT NULL AND NR_SEQ_GER_DES_SOLU::text <> '') or (NR_SEQ_GER_SUP_SOLU IS NOT NULL AND NR_SEQ_GER_SUP_SOLU::text <> ''))
and	not exists (SELECT	1
		from	man_ordem_situacao_sla x
		where	x.nr_seq_ordem_serv 	= a.nr_seq_ordem_serv
		and	trunc(x.dt_situacao,'month') 	= man_resumo_sla_ww.dt_referencia
		and	x.ie_situacao_atual	= 'S'
		and	x.ie_classificacao	<> 'E')
and	trunc(dt_estouro_solucao,'month')	= man_resumo_sla_ww.dt_referencia;

select	count(distinct nr_seq_ordem_serv)
into STRICT	qt_recebidas_w
from 	man_ordem_situacao_sla a
where	ie_interno		= 'N'
and	trunc(a.dt_situacao,'month') 	= man_resumo_sla_ww.dt_referencia
and ((nr_seq_gerencia_des IS NOT NULL AND nr_seq_gerencia_des::text <> '') or (nr_seq_gerencia_sup IS NOT NULL AND nr_seq_gerencia_sup::text <> ''))
and	not exists (SELECT	1
		from	man_ordem_situacao_sla x
		where	x.nr_seq_ordem_serv 	= a.nr_seq_ordem_serv
		and	trunc(x.dt_situacao,'month') 	= man_resumo_sla_ww.dt_referencia
		and	x.ie_situacao_atual	= 'S'
		and	x.ie_classificacao	<> 'E')
and	exists (select	1
	from	man_ordem_situacao_sla y
	where 	trunc(y.dt_situacao,'month') 	= man_resumo_sla_ww.dt_referencia
	and	y.nr_seq_ordem_serv		= a.nr_seq_ordem_serv
	and	y.ie_status_os			= 'A');

man_resumo_sla_ww.qt_atraso_resposta	:= qt_atraso_resposta_w;
man_resumo_sla_ww.qt_atraso_solucao	:= qt_atraso_solucao_w;
man_resumo_sla_ww.qt_sla		:= qt_recebidas_w;
man_resumo_sla_ww.qt_sla_calculo	:= qt_recebidas_w * 2;
man_resumo_sla_ww.pr_atingido		:= 100-(dividir((qt_atraso_resposta_w + qt_atraso_solucao_w),qt_recebidas_w * 2)*100);
man_resumo_sla_ww.qt_target		:= obter_meta_sla(852,man_resumo_sla_ww.dt_referencia,'CSLA');

insert into man_resumo_sla_w values (man_resumo_sla_ww.*);

/*#################################################### All defects
*/
man_resumo_sla_ww.ie_tipo_sla	:= 'ALLDEF';

select	count(distinct nr_seq_ordem_serv)
into STRICT	qt_atraso_resposta_w
from 	man_ordem_situacao_sla a
where	trunc(dt_estouro_resposta,'month')	= man_resumo_sla_ww.dt_referencia
and ((NR_SEQ_GER_DES_RESP IS NOT NULL AND NR_SEQ_GER_DES_RESP::text <> '') or (NR_SEQ_GER_SUP_RESP IS NOT NULL AND NR_SEQ_GER_SUP_RESP::text <> ''))
and	not exists (SELECT	1
		from	man_ordem_situacao_sla x
		where	x.nr_seq_ordem_serv 	= a.nr_seq_ordem_serv
		and	trunc(x.dt_situacao,'month') 	= man_resumo_sla_ww.dt_referencia
		and	x.ie_situacao_atual	= 'S'
		and	x.ie_classificacao	<> 'E');

-- Buscar as OS's com estouro de solução da gerência
select	count(distinct nr_seq_ordem_serv)
into STRICT	qt_atraso_solucao_w
from 	man_ordem_situacao_sla a
where	trunc(dt_estouro_solucao,'month')	= man_resumo_sla_ww.dt_referencia
and ((NR_SEQ_GER_DES_SOLU IS NOT NULL AND NR_SEQ_GER_DES_SOLU::text <> '') or (NR_SEQ_GER_SUP_SOLU IS NOT NULL AND NR_SEQ_GER_SUP_SOLU::text <> ''))
and	not exists (SELECT	1
		from	man_ordem_situacao_sla x
		where	x.nr_seq_ordem_serv 	= a.nr_seq_ordem_serv
		and	trunc(x.dt_situacao,'month') 	= man_resumo_sla_ww.dt_referencia
		and	x.ie_situacao_atual	= 'S'
		and	x.ie_classificacao	<> 'E')
and	exists (select	1
		from	man_ordem_situacao_sla x
		where	x.nr_seq_ordem_serv 	= a.nr_seq_ordem_serv
		and	trunc(x.dt_situacao,'month') 	= man_resumo_sla_ww.dt_referencia
		and	x.ie_status_os		= 'A');

select	count(distinct nr_seq_ordem_serv)
into STRICT	qt_recebidas_w
from 	man_ordem_situacao_sla a
where ((nr_seq_gerencia_des IS NOT NULL AND nr_seq_gerencia_des::text <> '') or (nr_seq_gerencia_sup IS NOT NULL AND nr_seq_gerencia_sup::text <> ''))
and	trunc(a.dt_situacao,'month') 	= man_resumo_sla_ww.dt_referencia
and	exists (SELECT	1
	from	man_ordem_situacao_sla y
	where 	trunc(y.dt_situacao,'month') 	= man_resumo_sla_ww.dt_referencia
	and	y.nr_seq_ordem_serv		= a.nr_seq_ordem_serv
	and	y.ie_status_os			= 'A')
and	not exists (select	1
		from	man_ordem_situacao_sla x
		where	x.nr_seq_ordem_serv 		= a.nr_seq_ordem_serv
		and	trunc(x.dt_situacao,'month') 	= man_resumo_sla_ww.dt_referencia
		and	x.ie_situacao_atual	= 'S'
		and	x.ie_classificacao	<> 'E');

man_resumo_sla_ww.qt_atraso_resposta	:= qt_atraso_resposta_w;
man_resumo_sla_ww.qt_atraso_solucao	:= qt_atraso_solucao_w;
man_resumo_sla_ww.qt_sla		:= qt_recebidas_w;
man_resumo_sla_ww.qt_sla_calculo	:= qt_recebidas_w * 2;
man_resumo_sla_ww.pr_atingido		:= 100-(dividir((qt_atraso_resposta_w + qt_atraso_solucao_w),qt_recebidas_w * 2)*100);
man_resumo_sla_ww.qt_target		:= obter_meta_sla(null,man_resumo_sla_ww.dt_referencia,'ALLDEF');

insert into man_resumo_sla_w values (man_resumo_sla_ww.*);

--#######################################################

--########  Gerar os resultados por gerência ############

--#######################################################
man_resumo_sla_ww.ie_informacao	:= 'G';

open C01;
loop
fetch C01 into
	nr_seq_gerencia_des_w,
	nr_seq_gerencia_sup_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	man_resumo_sla_ww.nr_seq_gerencia_des	:= nr_seq_gerencia_des_w;
	man_resumo_sla_ww.nr_seq_gerencia_sup	:= nr_seq_gerencia_sup_w;

	--############## SWP ##############

	-- Buscar as OS's com estouro de resposta da gerência
	select	count(distinct nr_seq_ordem_serv)
	into STRICT	qt_atraso_resposta_w
	from 	man_ordem_situacao_sla a
	where	ie_interno				= 'N'
	and	ie_tipo_sla				in ('CSFP', 'COSP')
	and	not exists (SELECT	1
		from	man_ordem_situacao_sla x
		where	x.nr_seq_ordem_serv 	= a.nr_seq_ordem_serv
		and	trunc(x.dt_situacao,'month') 	= man_resumo_sla_ww.dt_referencia
		and	x.ie_situacao_atual	= 'S'
		and	x.ie_classificacao	<> 'E')
	and	((nr_seq_ger_des_resp			= nr_seq_gerencia_des_w) or (coalesce(nr_seq_ger_des_resp::text, '') = '' and 	nr_seq_ger_sup_resp = nr_seq_gerencia_sup_w))
	and	trunc(dt_estouro_resposta,'month')	= man_resumo_sla_ww.dt_referencia;

	-- Buscar as OS's com estouro de solução da gerência
	select	count(distinct nr_seq_ordem_serv)
	into STRICT	qt_atraso_solucao_w
	from 	man_ordem_situacao_sla a
	where	ie_interno	= 'N'
	and	ie_tipo_sla	in ('CSFP', 'COSP')
	and	not exists (SELECT	1
		from	man_ordem_situacao_sla x
		where	x.nr_seq_ordem_serv 	= a.nr_seq_ordem_serv
		and	trunc(x.dt_situacao,'month') 	= man_resumo_sla_ww.dt_referencia
		and	x.ie_situacao_atual	= 'S'
		and	x.ie_classificacao	<> 'E')
	and	((nr_seq_ger_des_solu			= nr_seq_gerencia_des_w) or (coalesce(nr_seq_ger_des_solu::text, '') = '' and 	nr_seq_ger_sup_solu = nr_seq_gerencia_sup_w))
	and	trunc(dt_estouro_solucao,'month')	= man_resumo_sla_ww.dt_referencia;

	-- Buscar as recebidas no mês onde a OS esteve pelo menos 1 dia na Philips

	-- Para o suporte conta como recebida apenas se NÃO passou pelo desenvolvimento, caso contrário, conta para o desenvolvimento
	select	count(distinct nr_seq_ordem_serv)
	into STRICT	qt_recebidas_w
	from 	man_ordem_situacao_sla a
	where	trunc(a.dt_situacao,'month') 	= man_resumo_sla_ww.dt_referencia
	and	ie_interno		= 'N'
	and	not exists (SELECT	1
		from	man_ordem_situacao_sla x
		where	x.nr_seq_ordem_serv 	= a.nr_seq_ordem_serv
		and	trunc(x.dt_situacao,'month') 	= man_resumo_sla_ww.dt_referencia
		and	x.ie_situacao_atual	= 'S'
		and	x.ie_classificacao	<> 'E')
	and	((nr_seq_gerencia_des = nr_seq_gerencia_des_w) or (nr_seq_gerencia_sup = nr_seq_gerencia_sup_w))
	and	ie_tipo_sla	in ('CSFP', 'COSP')
	and	exists (select	1
		from	man_ordem_situacao_sla y
		where 	trunc(y.dt_situacao,'month') 	= man_resumo_sla_ww.dt_referencia
		and	y.nr_seq_ordem_serv		= a.nr_seq_ordem_serv
		and	y.ie_status_os			= 'A');

	qt_calculo_w	:= qt_recebidas_w * 2;

	if (qt_recebidas_w > 0 or qt_atraso_resposta_w > 0 or qt_atraso_solucao_w > 0) then

		man_resumo_sla_ww.ie_tipo_sla			:= 'SWP';
		man_resumo_sla_ww.pr_atingido			:= 100-(dividir((qt_atraso_resposta_w + qt_atraso_solucao_w),qt_calculo_w)*100);
		man_resumo_sla_ww.qt_sla			:= qt_recebidas_w;
		man_resumo_sla_ww.qt_sla_calculo		:= qt_calculo_w;
		man_resumo_sla_ww.qt_atraso_resposta		:= qt_atraso_resposta_w;
		man_resumo_sla_ww.qt_atraso_solucao		:= qt_atraso_solucao_w;
		man_resumo_sla_ww.qt_target			:= obter_meta_sla(0,man_resumo_sla_ww.dt_referencia,'SWP');

		insert into man_resumo_sla_w values (man_resumo_sla_ww.*);
	end if;

	--############## SWC ##############

	-- Buscar as OS's com estouro de resposta da gerência
	select	count(distinct nr_seq_ordem_serv)
	into STRICT	qt_atraso_resposta_w
	from 	man_ordem_situacao_sla a
	where	ie_interno	= 'N'
	and	not exists (SELECT	1
		from	man_ordem_situacao_sla x
		where	x.nr_seq_ordem_serv 	= a.nr_seq_ordem_serv
		and	trunc(x.dt_situacao,'month') 	= man_resumo_sla_ww.dt_referencia
		and	x.ie_situacao_atual	= 'S'
		and	x.ie_classificacao	<> 'E')
	and	ie_tipo_sla	in ('CSFNP', 'COSNP', 'CSFP', 'COSP')
	and	((nr_seq_ger_des_resp			= nr_seq_gerencia_des_w) or (coalesce(nr_seq_ger_des_resp::text, '') = '' and 	nr_seq_ger_sup_resp = nr_seq_gerencia_sup_w))
	and	trunc(dt_estouro_resposta,'month')	= man_resumo_sla_ww.dt_referencia;

	-- Buscar as OS's com estouro de solução da gerência
	select	count(distinct nr_seq_ordem_serv)
	into STRICT	qt_atraso_solucao_w
	from 	man_ordem_situacao_sla a
	where	ie_interno	= 'N'
	and	not exists (SELECT	1
		from	man_ordem_situacao_sla x
		where	x.nr_seq_ordem_serv 	= a.nr_seq_ordem_serv
		and	trunc(x.dt_situacao,'month') 	= man_resumo_sla_ww.dt_referencia
		and	x.ie_situacao_atual	= 'S'
		and	x.ie_classificacao	<> 'E')
	and	ie_tipo_sla	in ('CSFNP', 'COSNP', 'CSFP', 'COSP')
	and	((nr_seq_ger_des_solu			= nr_seq_gerencia_des_w) or (coalesce(nr_seq_ger_des_solu::text, '') = '' and 	nr_seq_ger_sup_solu = nr_seq_gerencia_sup_w))
	and	trunc(dt_estouro_solucao,'month')	= man_resumo_sla_ww.dt_referencia;

	-- Buscar as recebidas no mês onde a OS esteve pelo menos 1 dia na Philips

	-- Para o suporte conta como recebida apenas se NÃO passou pelo desenvolvimento, caso contrário, conta para o desenvolvimento
	select	count(distinct nr_seq_ordem_serv)
	into STRICT	qt_recebidas_w
	from	man_ordem_situacao_sla a
	where	trunc(a.dt_situacao,'month') 	= man_resumo_sla_ww.dt_referencia
	and	ie_interno		= 'N'
	and	not exists (SELECT	1
		from	man_ordem_situacao_sla x
		where	x.nr_seq_ordem_serv 	= a.nr_seq_ordem_serv
		and	trunc(x.dt_situacao,'month') 	= man_resumo_sla_ww.dt_referencia
		and	x.ie_situacao_atual	= 'S'
		and	x.ie_classificacao	<> 'E')
	and	((nr_seq_gerencia_des = nr_seq_gerencia_des_w) or (nr_seq_gerencia_sup = nr_seq_gerencia_sup_w))
	and	ie_tipo_sla	in ('CSFNP', 'COSNP', 'CSFP', 'COSP')
	and	exists (select	1
		from	man_ordem_situacao_sla y
		where 	trunc(y.dt_situacao,'month') 	= man_resumo_sla_ww.dt_referencia
		and	y.nr_seq_ordem_serv		= a.nr_seq_ordem_serv
		and	y.ie_status_os			= 'A');

	qt_calculo_w	:= qt_recebidas_w * 2;

	if (qt_recebidas_w > 0 or qt_atraso_resposta_w > 0 or qt_atraso_solucao_w > 0) then

		man_resumo_sla_ww.ie_tipo_sla			:= 'SWC';
		man_resumo_sla_ww.pr_atingido			:= 100-(dividir((qt_atraso_resposta_w + qt_atraso_solucao_w),qt_calculo_w)*100);
		man_resumo_sla_ww.qt_sla			:= qt_recebidas_w;
		man_resumo_sla_ww.qt_sla_calculo		:= qt_calculo_w;
		man_resumo_sla_ww.qt_atraso_resposta		:= qt_atraso_resposta_w;
		man_resumo_sla_ww.qt_atraso_solucao		:= qt_atraso_solucao_w;
		man_resumo_sla_ww.qt_target			:= obter_meta_sla(0,man_resumo_sla_ww.dt_referencia,'SWC');

		insert into man_resumo_sla_w values (man_resumo_sla_ww.*);
	end if;

	--############## CSLA ##############

	-- Buscar as OS's com estouro de resposta da gerência
	select	count(distinct nr_seq_ordem_serv)
	into STRICT	qt_atraso_resposta_w
	from 	man_ordem_situacao_sla a
	where	ie_interno	= 'N'
	and	not exists (SELECT	1
		from	man_ordem_situacao_sla x
		where	x.nr_seq_ordem_serv 	= a.nr_seq_ordem_serv
		and	trunc(x.dt_situacao,'month') 	= man_resumo_sla_ww.dt_referencia
		and	x.ie_situacao_atual	= 'S'
		and	x.ie_classificacao	<> 'E')
	and (nr_seq_ger_des_resp			= nr_seq_gerencia_des_w or
		nr_seq_ger_sup_resp			= nr_seq_gerencia_sup_w)
	and	trunc(dt_estouro_resposta,'month')	= man_resumo_sla_ww.dt_referencia;

	-- Buscar as OS's com estouro de solução da gerência
	select	count(distinct nr_seq_ordem_serv)
	into STRICT	qt_atraso_solucao_w
	from 	man_ordem_situacao_sla a
	where	ie_interno	= 'N'
	and	not exists (SELECT	1
		from	man_ordem_situacao_sla x
		where	x.nr_seq_ordem_serv 	= a.nr_seq_ordem_serv
		and	trunc(x.dt_situacao,'month') 	= man_resumo_sla_ww.dt_referencia
		and	x.ie_situacao_atual	= 'S'
		and	x.ie_classificacao	<> 'E')
	and (nr_seq_ger_des_solu			= nr_seq_gerencia_des_w or
		nr_seq_ger_sup_solu			= nr_seq_gerencia_sup_w)
	and	trunc(dt_estouro_solucao,'month')	= man_resumo_sla_ww.dt_referencia;

	-- Buscar as recebidas no mês onde a OS esteve pelo menos 1 dia na Philips

	-- Para o suporte conta como recebida apenas se NÃO passou pelo desenvolvimento, caso contrário, conta para o desenvolvimento
	select	count(distinct nr_seq_ordem_serv)
	into STRICT	qt_recebidas_w
	from 	man_ordem_situacao_sla a
	where	trunc(a.dt_situacao,'month') 	= man_resumo_sla_ww.dt_referencia
	and		ie_interno		= 'N'
	and	not exists (SELECT	1
		from	man_ordem_situacao_sla x
		where	x.nr_seq_ordem_serv 	= a.nr_seq_ordem_serv
		and	trunc(x.dt_situacao,'month') 	= man_resumo_sla_ww.dt_referencia
		and	x.ie_situacao_atual	= 'S'
		and	x.ie_classificacao	<> 'E')
	and	((nr_seq_gerencia_des = nr_seq_gerencia_des_w) or (nr_seq_gerencia_sup = nr_seq_gerencia_sup_w))
	and	exists (select	1
		from	man_ordem_situacao_sla y
		where 	trunc(y.dt_situacao,'month') 	= man_resumo_sla_ww.dt_referencia
		and	y.nr_seq_ordem_serv		= a.nr_seq_ordem_serv
		and	y.ie_status_os			= 'A');

	qt_calculo_w	:= qt_recebidas_w * 2;

	if (qt_recebidas_w > 0 or qt_atraso_resposta_w > 0 or qt_atraso_solucao_w > 0) then

		man_resumo_sla_ww.ie_tipo_sla			:= 'CSLA';
		man_resumo_sla_ww.pr_atingido			:= 100-(dividir((qt_atraso_resposta_w + qt_atraso_solucao_w),qt_calculo_w)*100);
		man_resumo_sla_ww.qt_sla			:= qt_recebidas_w;
		man_resumo_sla_ww.qt_sla_calculo		:= qt_calculo_w;
		man_resumo_sla_ww.qt_atraso_resposta		:= qt_atraso_resposta_w;
		man_resumo_sla_ww.qt_atraso_solucao		:= qt_atraso_solucao_w;
		man_resumo_sla_ww.qt_target			:= obter_meta_sla(0,man_resumo_sla_ww.dt_referencia,'CSLA');

		insert into man_resumo_sla_w values (man_resumo_sla_ww.*);
	end if;

	--############## ALLDEF ##############

	-- Buscar as OS's com estouro de resposta da gerência
	select	count(distinct nr_seq_ordem_serv)
	into STRICT	qt_atraso_resposta_w
	from 	man_ordem_situacao_sla a
	where (nr_seq_gerencia_des			= nr_seq_gerencia_des_w or
		nr_seq_gerencia_sup			= nr_seq_gerencia_sup_w)
	and	not exists (SELECT	1
		from	man_ordem_situacao_sla x
		where	x.nr_seq_ordem_serv 	= a.nr_seq_ordem_serv
		and	trunc(x.dt_situacao,'month') 	= man_resumo_sla_ww.dt_referencia
		and	x.ie_situacao_atual	= 'S'
		and	x.ie_classificacao	<> 'E')
	and	exists (select	1
		from	man_ordem_situacao_sla x
		where	x.nr_seq_ordem_serv 	= a.nr_seq_ordem_serv
		and	trunc(x.dt_situacao,'month') 	= man_resumo_sla_ww.dt_referencia
		and	x.ie_status_os		= 'A')
	--and	trunc(dt_estouro_resposta,'month')	= man_resumo_sla_ww.dt_referencia
	and	(dt_estouro_resposta IS NOT NULL AND dt_estouro_resposta::text <> '')
	and	trunc(dt_situacao,'month') 	= man_resumo_sla_ww.dt_referencia;

	-- Buscar as OS's com estouro de solução da gerência
	select	count(distinct nr_seq_ordem_serv)
	into STRICT	qt_atraso_solucao_w
	from 	man_ordem_situacao_sla a
	where (nr_seq_gerencia_des			= nr_seq_gerencia_des_w or
		nr_seq_gerencia_sup			= nr_seq_gerencia_sup_w)
	and	not exists (SELECT	1
		from	man_ordem_situacao_sla x
		where	x.nr_seq_ordem_serv 	= a.nr_seq_ordem_serv
		and	trunc(x.dt_situacao,'month') 	= man_resumo_sla_ww.dt_referencia
		and	x.ie_situacao_atual	= 'S'
		and	x.ie_classificacao	<> 'E')
	and	exists (select	1
		from	man_ordem_situacao_sla x
		where	x.nr_seq_ordem_serv 	= a.nr_seq_ordem_serv
		and	trunc(x.dt_situacao,'month') 	= man_resumo_sla_ww.dt_referencia
		and	x.ie_status_os		= 'A')
	--and	trunc(dt_estouro_solucao,'month')	= man_resumo_sla_ww.dt_referencia
	and	(dt_estouro_solucao IS NOT NULL AND dt_estouro_solucao::text <> '')
	and	trunc(dt_situacao,'month') 	= man_resumo_sla_ww.dt_referencia;

	-- Buscar as recebidas no mês onde a OS esteve pelo menos 1 dia na Philips

	-- Para o suporte conta como recebida apenas se NÃO passou pelo desenvolvimento, caso contrário, conta para o desenvolvimento
	select	count(distinct nr_seq_ordem_serv)
	into STRICT	qt_recebidas_w
	from 	man_ordem_situacao_sla a
	where	trunc(a.dt_situacao,'month') 	= man_resumo_sla_ww.dt_referencia
	and	((nr_seq_gerencia_des = nr_seq_gerencia_des_w) or (nr_seq_gerencia_sup = nr_seq_gerencia_sup_w))
	and	not exists (SELECT	1
		from	man_ordem_situacao_sla x
		where	x.nr_seq_ordem_serv 	= a.nr_seq_ordem_serv
		and	trunc(x.dt_situacao,'month') 	= man_resumo_sla_ww.dt_referencia
		and	x.ie_situacao_atual	= 'S'
		and	x.ie_classificacao	<> 'E')
	and	exists (select	1
		from	man_ordem_situacao_sla y
		where 	trunc(y.dt_situacao,'month') 	= man_resumo_sla_ww.dt_referencia
		and	y.nr_seq_ordem_serv		= a.nr_seq_ordem_serv
		and	y.ie_status_os			= 'A');

	qt_calculo_w	:= qt_recebidas_w * 2;

	if (qt_recebidas_w > 0 or qt_atraso_resposta_w > 0 or qt_atraso_solucao_w > 0) then

		man_resumo_sla_ww.ie_tipo_sla			:= 'ALLDEF';
		man_resumo_sla_ww.pr_atingido			:= 100-(dividir((qt_atraso_resposta_w + qt_atraso_solucao_w),qt_calculo_w)*100);
		man_resumo_sla_ww.qt_sla			:= qt_recebidas_w;
		man_resumo_sla_ww.qt_sla_calculo		:= qt_calculo_w;
		man_resumo_sla_ww.qt_atraso_resposta		:= qt_atraso_resposta_w;
		man_resumo_sla_ww.qt_atraso_solucao		:= qt_atraso_solucao_w;
		man_resumo_sla_ww.qt_target			:= obter_meta_sla(0,man_resumo_sla_ww.dt_referencia,'ALLDEF');

		insert into man_resumo_sla_w values (man_resumo_sla_ww.*);
	end if;

	end;
end loop;
close C01;

--#########################################################

--########  Gerar os resultados por prioridade ############

--#########################################################
man_resumo_sla_ww.ie_informacao	:= 'P';

open C02;
loop
fetch C02 into
	ie_prioridade_w;
EXIT WHEN NOT FOUND; /* apply on C02 */
	begin
	man_resumo_sla_ww.ie_prioridade	:= ie_prioridade_w;

	--############## SWP ##############

	-- Buscar as OS's com estouro de resposta da gerência
	select	count(distinct nr_seq_ordem_serv)
	into STRICT	qt_atraso_resposta_w
	from 	man_ordem_situacao_sla a
	where	ie_interno				= 'N'
	and ((NR_SEQ_GER_DES_RESP IS NOT NULL AND NR_SEQ_GER_DES_RESP::text <> '') or (NR_SEQ_GER_SUP_RESP IS NOT NULL AND NR_SEQ_GER_SUP_RESP::text <> ''))
	and	ie_tipo_sla				in ('CSFP', 'COSP')
	and	not exists (SELECT	1
		from	man_ordem_situacao_sla x
		where	x.nr_seq_ordem_serv 	= a.nr_seq_ordem_serv
		and	trunc(x.dt_situacao,'month') 	= man_resumo_sla_ww.dt_referencia
		and	x.ie_situacao_atual	= 'S'
		and	x.ie_classificacao	<> 'E')
	and	ie_prioridade				= ie_prioridade_w
	and	trunc(dt_estouro_resposta,'month')	= man_resumo_sla_ww.dt_referencia;

	-- Buscar as OS's com estouro de solução da gerência
	select	count(distinct nr_seq_ordem_serv)
	into STRICT	qt_atraso_solucao_w
	from 	man_ordem_situacao_sla a
	where	ie_interno	= 'N'
	and	ie_tipo_sla	in ('CSFP', 'COSP')
	and ((NR_SEQ_GER_DES_SOLU IS NOT NULL AND NR_SEQ_GER_DES_SOLU::text <> '') or (NR_SEQ_GER_SUP_SOLU IS NOT NULL AND NR_SEQ_GER_SUP_SOLU::text <> ''))
	and	not exists (SELECT	1
		from	man_ordem_situacao_sla x
		where	x.nr_seq_ordem_serv 	= a.nr_seq_ordem_serv
		and	trunc(x.dt_situacao,'month') 	= man_resumo_sla_ww.dt_referencia
		and	x.ie_situacao_atual	= 'S'
		and	x.ie_classificacao	<> 'E')
	and	ie_prioridade	= ie_prioridade_w
	and	trunc(dt_estouro_solucao,'month')	= man_resumo_sla_ww.dt_referencia;

	select	count(distinct nr_seq_ordem_serv)
	into STRICT	qt_recebidas_w
	from 	man_ordem_situacao_sla a
	where	ie_prioridade	= ie_prioridade_w
	and	trunc(a.dt_situacao,'month') 	= man_resumo_sla_ww.dt_referencia
	and	ie_interno		= 'N'
	and	ie_tipo_sla	in ('CSFP', 'COSP')
	and ((nr_seq_gerencia_des IS NOT NULL AND nr_seq_gerencia_des::text <> '') or (nr_seq_gerencia_sup IS NOT NULL AND nr_seq_gerencia_sup::text <> ''))
	and	not exists (SELECT	1
		from	man_ordem_situacao_sla x
		where	x.nr_seq_ordem_serv 	= a.nr_seq_ordem_serv
		and	trunc(x.dt_situacao,'month') 	= man_resumo_sla_ww.dt_referencia
		and	x.ie_situacao_atual	= 'S'
		and	x.ie_classificacao	<> 'E')
	and	exists (select	1
		from	man_ordem_situacao_sla y
		where 	trunc(y.dt_situacao,'month') 	= man_resumo_sla_ww.dt_referencia
		and	y.nr_seq_ordem_serv		= a.nr_seq_ordem_serv
		and	y.ie_status_os			= 'A');

	qt_calculo_w	:= qt_recebidas_w * 2;

	if (qt_recebidas_w > 0 or qt_atraso_resposta_w > 0 or qt_atraso_solucao_w > 0) then

		man_resumo_sla_ww.ie_tipo_sla			:= 'SWP';
		man_resumo_sla_ww.pr_atingido			:= 100-(dividir((qt_atraso_resposta_w + qt_atraso_solucao_w),qt_calculo_w)*100);
		man_resumo_sla_ww.qt_sla			:= qt_recebidas_w;
		man_resumo_sla_ww.qt_sla_calculo		:= qt_calculo_w;
		man_resumo_sla_ww.qt_atraso_resposta		:= qt_atraso_resposta_w;
		man_resumo_sla_ww.qt_atraso_solucao		:= qt_atraso_solucao_w;
		man_resumo_sla_ww.qt_target			:= obter_meta_sla(0,man_resumo_sla_ww.dt_referencia,'SWP');

		insert into man_resumo_sla_w values (man_resumo_sla_ww.*);
	end if;

	--############## SWC ##############

	-- Buscar as OS's com estouro de resposta da gerência
	select	count(distinct nr_seq_ordem_serv)
	into STRICT	qt_atraso_resposta_w
	from 	man_ordem_situacao_sla a
	where	ie_interno				= 'N'
	and ((NR_SEQ_GER_DES_RESP IS NOT NULL AND NR_SEQ_GER_DES_RESP::text <> '') or (NR_SEQ_GER_SUP_RESP IS NOT NULL AND NR_SEQ_GER_SUP_RESP::text <> ''))
	and	ie_tipo_sla				in ('CSFNP', 'COSNP', 'CSFP', 'COSP')
	and	not exists (SELECT	1
		from	man_ordem_situacao_sla x
		where	x.nr_seq_ordem_serv 	= a.nr_seq_ordem_serv
		and	trunc(x.dt_situacao,'month') 	= man_resumo_sla_ww.dt_referencia
		and	x.ie_situacao_atual	= 'S'
		and	x.ie_classificacao	<> 'E')
	and	ie_prioridade				= ie_prioridade_w
	and	trunc(dt_estouro_resposta,'month')	= man_resumo_sla_ww.dt_referencia;

	-- Buscar as OS's com estouro de solução da gerência
	select	count(distinct nr_seq_ordem_serv)
	into STRICT	qt_atraso_solucao_w
	from 	man_ordem_situacao_sla a
	where	ie_interno	= 'N'
	and	ie_tipo_sla	in ('CSFNP', 'COSNP', 'CSFP', 'COSP')
	and ((NR_SEQ_GER_DES_SOLU IS NOT NULL AND NR_SEQ_GER_DES_SOLU::text <> '') or (NR_SEQ_GER_SUP_SOLU IS NOT NULL AND NR_SEQ_GER_SUP_SOLU::text <> ''))
	and	not exists (SELECT	1
		from	man_ordem_situacao_sla x
		where	x.nr_seq_ordem_serv 	= a.nr_seq_ordem_serv
		and	trunc(x.dt_situacao,'month') 	= man_resumo_sla_ww.dt_referencia
		and	x.ie_situacao_atual	= 'S'
		and	x.ie_classificacao	<> 'E')
	and	ie_prioridade	= ie_prioridade_w
	and	trunc(dt_estouro_solucao,'month')	= man_resumo_sla_ww.dt_referencia;

	select	count(distinct nr_seq_ordem_serv)
	into STRICT	qt_recebidas_w
	from 	man_ordem_situacao_sla a
	where	ie_prioridade	= ie_prioridade_w
	and	trunc(a.dt_situacao,'month') 	= man_resumo_sla_ww.dt_referencia
	and	ie_interno		= 'N'
	and	ie_tipo_sla	in ('CSFNP', 'COSNP', 'CSFP', 'COSP')
	and ((nr_seq_gerencia_des IS NOT NULL AND nr_seq_gerencia_des::text <> '') or (nr_seq_gerencia_sup IS NOT NULL AND nr_seq_gerencia_sup::text <> ''))
	and	not exists (SELECT	1
		from	man_ordem_situacao_sla x
		where	x.nr_seq_ordem_serv 	= a.nr_seq_ordem_serv
		and	trunc(x.dt_situacao,'month') 	= man_resumo_sla_ww.dt_referencia
		and	x.ie_situacao_atual	= 'S'
		and	x.ie_classificacao	<> 'E')
	and	exists (select	1
		from	man_ordem_situacao_sla y
		where 	trunc(y.dt_situacao,'month') 	= man_resumo_sla_ww.dt_referencia
		and	y.nr_seq_ordem_serv		= a.nr_seq_ordem_serv
		and	y.ie_status_os			= 'A');

	qt_calculo_w	:= qt_recebidas_w * 2;

	if (qt_recebidas_w > 0 or qt_atraso_resposta_w > 0 or qt_atraso_solucao_w > 0) then

		man_resumo_sla_ww.ie_tipo_sla			:= 'SWC';
		man_resumo_sla_ww.pr_atingido			:= 100-(dividir((qt_atraso_resposta_w + qt_atraso_solucao_w),qt_calculo_w)*100);
		man_resumo_sla_ww.qt_sla			:= qt_recebidas_w;
		man_resumo_sla_ww.qt_sla_calculo		:= qt_calculo_w;
		man_resumo_sla_ww.qt_atraso_resposta		:= qt_atraso_resposta_w;
		man_resumo_sla_ww.qt_atraso_solucao		:= qt_atraso_solucao_w;
		man_resumo_sla_ww.qt_target			:= obter_meta_sla(0,man_resumo_sla_ww.dt_referencia,'SWC');

		insert into man_resumo_sla_w values (man_resumo_sla_ww.*);
	end if;

	--############## CSLA ##############

	-- Buscar as OS's com estouro de resposta da gerência
	select	count(distinct nr_seq_ordem_serv)
	into STRICT	qt_atraso_resposta_w
	from 	man_ordem_situacao_sla a
	where	ie_interno				= 'N'
	and ((NR_SEQ_GER_DES_RESP IS NOT NULL AND NR_SEQ_GER_DES_RESP::text <> '') or (NR_SEQ_GER_SUP_RESP IS NOT NULL AND NR_SEQ_GER_SUP_RESP::text <> ''))
	and	not exists (SELECT	1
		from	man_ordem_situacao_sla x
		where	x.nr_seq_ordem_serv 	= a.nr_seq_ordem_serv
		and	trunc(x.dt_situacao,'month') 	= man_resumo_sla_ww.dt_referencia
		and	x.ie_situacao_atual	= 'S'
		and	x.ie_classificacao	<> 'E')
	and	ie_prioridade				= ie_prioridade_w
	and	trunc(dt_estouro_resposta,'month')	= man_resumo_sla_ww.dt_referencia;

	-- Buscar as OS's com estouro de solução da gerência
	select	count(distinct nr_seq_ordem_serv)
	into STRICT	qt_atraso_solucao_w
	from 	man_ordem_situacao_sla a
	where	ie_interno	= 'N'
	and ((NR_SEQ_GER_DES_SOLU IS NOT NULL AND NR_SEQ_GER_DES_SOLU::text <> '') or (NR_SEQ_GER_SUP_SOLU IS NOT NULL AND NR_SEQ_GER_SUP_SOLU::text <> ''))
	and	not exists (SELECT	1
		from	man_ordem_situacao_sla x
		where	x.nr_seq_ordem_serv 	= a.nr_seq_ordem_serv
		and	trunc(x.dt_situacao,'month') 	= man_resumo_sla_ww.dt_referencia
		and	x.ie_situacao_atual	= 'S'
		and	x.ie_classificacao	<> 'E')
	and	ie_prioridade	= ie_prioridade_w
	and	trunc(dt_estouro_solucao,'month')	= man_resumo_sla_ww.dt_referencia;

	select	count(distinct nr_seq_ordem_serv)
	into STRICT	qt_recebidas_w
	from 	man_ordem_situacao_sla a
	where	ie_prioridade	= ie_prioridade_w
	and	trunc(a.dt_situacao,'month') 	= man_resumo_sla_ww.dt_referencia
	and	ie_interno		= 'N'
	and ((nr_seq_gerencia_des IS NOT NULL AND nr_seq_gerencia_des::text <> '') or (nr_seq_gerencia_sup IS NOT NULL AND nr_seq_gerencia_sup::text <> ''))
	and	not exists (SELECT	1
		from	man_ordem_situacao_sla x
		where	x.nr_seq_ordem_serv 	= a.nr_seq_ordem_serv
		and	trunc(x.dt_situacao,'month') 	= man_resumo_sla_ww.dt_referencia
		and	x.ie_situacao_atual	= 'S'
		and	x.ie_classificacao	<> 'E')
	and	exists (select	1
		from	man_ordem_situacao_sla y
		where 	trunc(y.dt_situacao,'month') 	= man_resumo_sla_ww.dt_referencia
		and	y.nr_seq_ordem_serv		= a.nr_seq_ordem_serv
		and	y.ie_status_os			= 'A');

	qt_calculo_w	:= qt_recebidas_w * 2;

	if (qt_recebidas_w > 0 or qt_atraso_resposta_w > 0 or qt_atraso_solucao_w > 0) then

		man_resumo_sla_ww.ie_tipo_sla			:= 'CSLA';
		man_resumo_sla_ww.pr_atingido			:= 100-(dividir((qt_atraso_resposta_w + qt_atraso_solucao_w),qt_calculo_w)*100);
		man_resumo_sla_ww.qt_sla			:= qt_recebidas_w;
		man_resumo_sla_ww.qt_sla_calculo		:= qt_calculo_w;
		man_resumo_sla_ww.qt_atraso_resposta		:= qt_atraso_resposta_w;
		man_resumo_sla_ww.qt_atraso_solucao		:= qt_atraso_solucao_w;
		man_resumo_sla_ww.qt_target			:= obter_meta_sla(0,man_resumo_sla_ww.dt_referencia,'CSLA');

		insert into man_resumo_sla_w values (man_resumo_sla_ww.*);
	end if;

	--############## ALLDEF ##############

	-- Buscar as OS's com estouro de resposta pela prioridade
	select	count(distinct nr_seq_ordem_serv)
	into STRICT	qt_atraso_resposta_w
	from 	man_ordem_situacao_sla a
	where	ie_prioridade				= ie_prioridade_w
	and ((NR_SEQ_GER_DES_RESP IS NOT NULL AND NR_SEQ_GER_DES_RESP::text <> '') or (NR_SEQ_GER_SUP_RESP IS NOT NULL AND NR_SEQ_GER_SUP_RESP::text <> ''))
	and	not exists (SELECT	1
		from	man_ordem_situacao_sla x
		where	x.nr_seq_ordem_serv 	= a.nr_seq_ordem_serv
		and	trunc(x.dt_situacao,'month') 	= man_resumo_sla_ww.dt_referencia
		and	x.ie_situacao_atual	= 'S'
		and	x.ie_classificacao	<> 'E')
	and	trunc(dt_estouro_resposta,'month')	= man_resumo_sla_ww.dt_referencia;

	-- Buscar as OS's com estouro de solução da gerência
	select	count(distinct nr_seq_ordem_serv)
	into STRICT	qt_atraso_solucao_w
	from 	man_ordem_situacao_sla a
	where	ie_prioridade	= ie_prioridade_w
	and ((NR_SEQ_GER_DES_SOLU IS NOT NULL AND NR_SEQ_GER_DES_SOLU::text <> '') or (NR_SEQ_GER_SUP_SOLU IS NOT NULL AND NR_SEQ_GER_SUP_SOLU::text <> ''))
	and	not exists (SELECT	1
		from	man_ordem_situacao_sla x
		where	x.nr_seq_ordem_serv 	= a.nr_seq_ordem_serv
		and	trunc(x.dt_situacao,'month') 	= man_resumo_sla_ww.dt_referencia
		and	x.ie_situacao_atual	= 'S'
		and	x.ie_classificacao	<> 'E')
	and	exists (select	1
		from	man_ordem_situacao_sla x
		where	x.nr_seq_ordem_serv 	= a.nr_seq_ordem_serv
		and	trunc(x.dt_situacao,'month') 	= man_resumo_sla_ww.dt_referencia
		and	x.ie_status_os		= 'A')
	and	trunc(dt_estouro_solucao,'month')	= man_resumo_sla_ww.dt_referencia;

	select	count(distinct nr_seq_ordem_serv)
	into STRICT	qt_recebidas_w
	from 	man_ordem_situacao_sla a
	where	ie_prioridade	= ie_prioridade_w
	and	trunc(a.dt_situacao,'month') 	= man_resumo_sla_ww.dt_referencia
	and ((nr_seq_gerencia_des IS NOT NULL AND nr_seq_gerencia_des::text <> '') or (nr_seq_gerencia_sup IS NOT NULL AND nr_seq_gerencia_sup::text <> ''))
	and	not exists (SELECT	1
		from	man_ordem_situacao_sla x
		where	x.nr_seq_ordem_serv 	= a.nr_seq_ordem_serv
		and	trunc(x.dt_situacao,'month') 	= man_resumo_sla_ww.dt_referencia
		and	x.ie_situacao_atual	= 'S'
		and	x.ie_classificacao	<> 'E')
	and	exists (select	1
		from	man_ordem_situacao_sla y
		where 	trunc(y.dt_situacao,'month') 	= man_resumo_sla_ww.dt_referencia
		and	y.nr_seq_ordem_serv		= a.nr_seq_ordem_serv
		and	y.ie_status_os			= 'A');

	qt_calculo_w	:= qt_recebidas_w * 2;

	if (qt_recebidas_w > 0 or qt_atraso_resposta_w > 0 or qt_atraso_solucao_w > 0) then

		man_resumo_sla_ww.ie_tipo_sla			:= 'ALLDEF';
		man_resumo_sla_ww.pr_atingido			:= 100-(dividir((qt_atraso_resposta_w + qt_atraso_solucao_w),qt_calculo_w)*100);
		man_resumo_sla_ww.qt_sla			:= qt_recebidas_w;
		man_resumo_sla_ww.qt_sla_calculo		:= qt_calculo_w;
		man_resumo_sla_ww.qt_atraso_resposta		:= qt_atraso_resposta_w;
		man_resumo_sla_ww.qt_atraso_solucao		:= qt_atraso_solucao_w;
		man_resumo_sla_ww.qt_target			:= obter_meta_sla(0,man_resumo_sla_ww.dt_referencia,'ALLDEF');

		insert into man_resumo_sla_w values (man_resumo_sla_ww.*);
	end if;

	end;
end loop;
close C02;

--#########################################################

--########  Gerar os resultados por localizacao ############

--#########################################################
man_resumo_sla_ww.ie_informacao	:= 'L';

open C03;
loop
fetch C03 into
	nr_seq_localizacao_w;
EXIT WHEN NOT FOUND; /* apply on C03 */
	begin
	man_resumo_sla_ww.nr_seq_localizacao	:= nr_seq_localizacao_w;

	-- SWP

	-- Buscar as OS's com estouro de resposta pela prioridade
	select	count(distinct nr_seq_ordem_serv)
	into STRICT	qt_atraso_resposta_w
	from 	man_ordem_situacao_sla a
	where	ie_interno				= 'N'
	and ((NR_SEQ_GER_DES_RESP IS NOT NULL AND NR_SEQ_GER_DES_RESP::text <> '') or (NR_SEQ_GER_SUP_RESP IS NOT NULL AND NR_SEQ_GER_SUP_RESP::text <> ''))
	and	not exists (SELECT	1
		from	man_ordem_situacao_sla x
		where	x.nr_seq_ordem_serv 	= a.nr_seq_ordem_serv
		and	trunc(x.dt_situacao,'month') 	= man_resumo_sla_ww.dt_referencia
		and	x.ie_situacao_atual	= 'S'
		and	x.ie_classificacao	<> 'E')
	and	ie_tipo_sla				in ('CSFP', 'COSP')
	and	nr_seq_localizacao	= nr_seq_localizacao_w
	and	trunc(dt_estouro_resposta,'month')	= man_resumo_sla_ww.dt_referencia;

	-- Buscar as OS's com estouro de solução da gerência
	select	count(distinct nr_seq_ordem_serv)
	into STRICT	qt_atraso_solucao_w
	from 	man_ordem_situacao_sla a
	where	ie_interno	= 'N'
	and ((NR_SEQ_GER_DES_SOLU IS NOT NULL AND NR_SEQ_GER_DES_SOLU::text <> '') or (NR_SEQ_GER_SUP_SOLU IS NOT NULL AND NR_SEQ_GER_SUP_SOLU::text <> ''))
	and	not exists (SELECT	1
		from	man_ordem_situacao_sla x
		where	x.nr_seq_ordem_serv 	= a.nr_seq_ordem_serv
		and	trunc(x.dt_situacao,'month') 	= man_resumo_sla_ww.dt_referencia
		and	x.ie_situacao_atual	= 'S'
		and	x.ie_classificacao	<> 'E')
	and	ie_tipo_sla	in ('CSFP', 'COSP')
	and	nr_seq_localizacao	= nr_seq_localizacao_w
	and	trunc(dt_estouro_solucao,'month')	= man_resumo_sla_ww.dt_referencia;

	select	count(distinct nr_seq_ordem_serv)
	into STRICT	qt_recebidas_w
	from 	man_ordem_situacao_sla a
	where	nr_seq_localizacao		= nr_seq_localizacao_w
	and	trunc(a.dt_situacao,'month') 	= man_resumo_sla_ww.dt_referencia
	and ((nr_seq_gerencia_des IS NOT NULL AND nr_seq_gerencia_des::text <> '') or (nr_seq_gerencia_sup IS NOT NULL AND nr_seq_gerencia_sup::text <> ''))
	and	not exists (SELECT	1
		from	man_ordem_situacao_sla x
		where	x.nr_seq_ordem_serv 	= a.nr_seq_ordem_serv
		and	trunc(x.dt_situacao,'month') 	= man_resumo_sla_ww.dt_referencia
		and	x.ie_situacao_atual	= 'S'
		and	x.ie_classificacao	<> 'E')
	and	ie_interno		= 'N'
	and	ie_tipo_sla	in ('CSFP', 'COSP')
	and	exists (select	1
		from	man_ordem_situacao_sla y
		where 	trunc(y.dt_situacao,'month') 	= man_resumo_sla_ww.dt_referencia
		and	y.nr_seq_ordem_serv		= a.nr_seq_ordem_serv
		and	y.ie_status_os			= 'A');

	qt_calculo_w	:= qt_recebidas_w * 2;

	if (qt_recebidas_w > 0 or qt_atraso_resposta_w > 0 or qt_atraso_solucao_w > 0) then

		man_resumo_sla_ww.ie_tipo_sla			:= 'SWP';
		man_resumo_sla_ww.pr_atingido			:= 100-(dividir((qt_atraso_resposta_w + qt_atraso_solucao_w),qt_calculo_w)*100);
		man_resumo_sla_ww.qt_sla			:= qt_recebidas_w;
		man_resumo_sla_ww.qt_sla_calculo		:= qt_calculo_w;
		man_resumo_sla_ww.qt_atraso_resposta		:= qt_atraso_resposta_w;
		man_resumo_sla_ww.qt_atraso_solucao		:= qt_atraso_solucao_w;
		man_resumo_sla_ww.qt_target			:= obter_meta_sla(0,man_resumo_sla_ww.dt_referencia,'SWP');

		insert into man_resumo_sla_w values (man_resumo_sla_ww.*);
	end if;

	--SWC

	-- Buscar as OS's com estouro de resposta pela prioridade
	select	count(distinct nr_seq_ordem_serv)
	into STRICT	qt_atraso_resposta_w
	from 	man_ordem_situacao_sla a
	where	ie_interno				= 'N'
	and ((NR_SEQ_GER_DES_RESP IS NOT NULL AND NR_SEQ_GER_DES_RESP::text <> '') or (NR_SEQ_GER_SUP_RESP IS NOT NULL AND NR_SEQ_GER_SUP_RESP::text <> ''))
	and	not exists (SELECT	1
		from	man_ordem_situacao_sla x
		where	x.nr_seq_ordem_serv 	= a.nr_seq_ordem_serv
		and	trunc(x.dt_situacao,'month') 	= man_resumo_sla_ww.dt_referencia
		and	x.ie_situacao_atual	= 'S'
		and	x.ie_classificacao	<> 'E')
	and	ie_tipo_sla				in ('CSFNP', 'COSNP', 'CSFP', 'COSP')
	and	nr_seq_localizacao	= nr_seq_localizacao_w
	and	trunc(dt_estouro_resposta,'month')	= man_resumo_sla_ww.dt_referencia;

	-- Buscar as OS's com estouro de solução da gerência
	select	count(distinct nr_seq_ordem_serv)
	into STRICT	qt_atraso_solucao_w
	from 	man_ordem_situacao_sla a
	where	ie_interno	= 'N'
	and ((NR_SEQ_GER_DES_SOLU IS NOT NULL AND NR_SEQ_GER_DES_SOLU::text <> '') or (NR_SEQ_GER_SUP_SOLU IS NOT NULL AND NR_SEQ_GER_SUP_SOLU::text <> ''))
	and	not exists (SELECT	1
		from	man_ordem_situacao_sla x
		where	x.nr_seq_ordem_serv 	= a.nr_seq_ordem_serv
		and	trunc(x.dt_situacao,'month') 	= man_resumo_sla_ww.dt_referencia
		and	x.ie_situacao_atual	= 'S'
		and	x.ie_classificacao	<> 'E')
	and	ie_tipo_sla	in ('CSFNP', 'COSNP', 'CSFP', 'COSP')
	and	nr_seq_localizacao	= nr_seq_localizacao_w
	and	trunc(dt_estouro_solucao,'month')	= man_resumo_sla_ww.dt_referencia;

	select	count(distinct nr_seq_ordem_serv)
	into STRICT	qt_recebidas_w
	from 	man_ordem_situacao_sla a
	where	nr_seq_localizacao	= nr_seq_localizacao_w
	and	trunc(a.dt_situacao,'month') 	= man_resumo_sla_ww.dt_referencia
	and ((nr_seq_gerencia_des IS NOT NULL AND nr_seq_gerencia_des::text <> '') or (nr_seq_gerencia_sup IS NOT NULL AND nr_seq_gerencia_sup::text <> ''))
	and	not exists (SELECT	1
		from	man_ordem_situacao_sla x
		where	x.nr_seq_ordem_serv 	= a.nr_seq_ordem_serv
		and	trunc(x.dt_situacao,'month') 	= man_resumo_sla_ww.dt_referencia
		and	x.ie_situacao_atual	= 'S'
		and	x.ie_classificacao	<> 'E')
	and	ie_interno		= 'N'
	and	ie_tipo_sla	in ('CSFNP', 'COSNP', 'CSFP', 'COSP')
	and	exists (select	1
		from	man_ordem_situacao_sla y
		where 	trunc(y.dt_situacao,'month') 	= man_resumo_sla_ww.dt_referencia
		and	y.nr_seq_ordem_serv		= a.nr_seq_ordem_serv
		and	y.ie_status_os			= 'A');

	qt_calculo_w	:= qt_recebidas_w * 2;

	if (qt_recebidas_w > 0 or qt_atraso_resposta_w > 0 or qt_atraso_solucao_w > 0) then

		man_resumo_sla_ww.ie_tipo_sla			:= 'SWC';
		man_resumo_sla_ww.pr_atingido			:= 100-(dividir((qt_atraso_resposta_w + qt_atraso_solucao_w),qt_calculo_w)*100);
		man_resumo_sla_ww.qt_sla			:= qt_recebidas_w;
		man_resumo_sla_ww.qt_sla_calculo		:= qt_calculo_w;
		man_resumo_sla_ww.qt_atraso_resposta		:= qt_atraso_resposta_w;
		man_resumo_sla_ww.qt_atraso_solucao		:= qt_atraso_solucao_w;
		man_resumo_sla_ww.qt_target			:= obter_meta_sla(0,man_resumo_sla_ww.dt_referencia,'SWC');

		insert into man_resumo_sla_w values (man_resumo_sla_ww.*);
	end if;

	--CSLA

	-- Buscar as OS's com estouro de resposta pela prioridade
	select	count(distinct nr_seq_ordem_serv)
	into STRICT	qt_atraso_resposta_w
	from 	man_ordem_situacao_sla a
	where	ie_interno				= 'N'
	and ((NR_SEQ_GER_DES_RESP IS NOT NULL AND NR_SEQ_GER_DES_RESP::text <> '') or (NR_SEQ_GER_SUP_RESP IS NOT NULL AND NR_SEQ_GER_SUP_RESP::text <> ''))
	and	not exists (SELECT	1
		from	man_ordem_situacao_sla x
		where	x.nr_seq_ordem_serv 	= a.nr_seq_ordem_serv
		and	trunc(x.dt_situacao,'month') 	= man_resumo_sla_ww.dt_referencia
		and	x.ie_situacao_atual	= 'S'
		and	x.ie_classificacao	<> 'E')
	and	nr_seq_localizacao		= nr_seq_localizacao_w
	and	trunc(dt_estouro_resposta,'month')	= man_resumo_sla_ww.dt_referencia;

	-- Buscar as OS's com estouro de solução da gerência
	select	count(distinct nr_seq_ordem_serv)
	into STRICT	qt_atraso_solucao_w
	from 	man_ordem_situacao_sla a
	where	ie_interno	= 'N'
	and ((NR_SEQ_GER_DES_SOLU IS NOT NULL AND NR_SEQ_GER_DES_SOLU::text <> '') or (NR_SEQ_GER_SUP_SOLU IS NOT NULL AND NR_SEQ_GER_SUP_SOLU::text <> ''))
	and	not exists (SELECT	1
		from	man_ordem_situacao_sla x
		where	x.nr_seq_ordem_serv 	= a.nr_seq_ordem_serv
		and	trunc(x.dt_situacao,'month') 	= man_resumo_sla_ww.dt_referencia
		and	x.ie_situacao_atual	= 'S'
		and	x.ie_classificacao	<> 'E')
	and	nr_seq_localizacao	= nr_seq_localizacao_w
	and	trunc(dt_estouro_solucao,'month')	= man_resumo_sla_ww.dt_referencia;

	select	count(distinct nr_seq_ordem_serv)
	into STRICT	qt_recebidas_w
	from 	man_ordem_situacao_sla a
	where	nr_seq_localizacao	= nr_seq_localizacao_w
	and	trunc(a.dt_situacao,'month') 	= man_resumo_sla_ww.dt_referencia
	and ((nr_seq_gerencia_des IS NOT NULL AND nr_seq_gerencia_des::text <> '') or (nr_seq_gerencia_sup IS NOT NULL AND nr_seq_gerencia_sup::text <> ''))
	and	ie_interno		= 'N'
	and	not exists (SELECT	1
		from	man_ordem_situacao_sla x
		where	x.nr_seq_ordem_serv 	= a.nr_seq_ordem_serv
		and	trunc(x.dt_situacao,'month') 	= man_resumo_sla_ww.dt_referencia
		and	x.ie_situacao_atual	= 'S'
		and	x.ie_classificacao	<> 'E')
	and	exists (select	1
		from	man_ordem_situacao_sla y
		where 	trunc(y.dt_situacao,'month') 	= man_resumo_sla_ww.dt_referencia
		and	y.nr_seq_ordem_serv		= a.nr_seq_ordem_serv
		and	y.ie_status_os			= 'A');

	qt_calculo_w	:= qt_recebidas_w * 2;

	if (qt_recebidas_w > 0 or qt_atraso_resposta_w > 0 or qt_atraso_solucao_w > 0) then

		man_resumo_sla_ww.ie_tipo_sla			:= 'CSLA';
		man_resumo_sla_ww.pr_atingido			:= 100-(dividir((qt_atraso_resposta_w + qt_atraso_solucao_w),qt_calculo_w)*100);
		man_resumo_sla_ww.qt_sla			:= qt_recebidas_w;
		man_resumo_sla_ww.qt_sla_calculo		:= qt_calculo_w;
		man_resumo_sla_ww.qt_atraso_resposta		:= qt_atraso_resposta_w;
		man_resumo_sla_ww.qt_atraso_solucao		:= qt_atraso_solucao_w;
		man_resumo_sla_ww.qt_target			:= obter_meta_sla(0,man_resumo_sla_ww.dt_referencia,'CSLA');

		insert into man_resumo_sla_w values (man_resumo_sla_ww.*);
	end if;

	--ALLDEF

	-- Buscar as OS's com estouro de resposta pela prioridade
	select	count(distinct nr_seq_ordem_serv)
	into STRICT	qt_atraso_resposta_w
	from 	man_ordem_situacao_sla a
	where	nr_seq_localizacao			= nr_seq_localizacao_w
	and ((NR_SEQ_GER_DES_RESP IS NOT NULL AND NR_SEQ_GER_DES_RESP::text <> '') or (NR_SEQ_GER_SUP_RESP IS NOT NULL AND NR_SEQ_GER_SUP_RESP::text <> ''))
	and	not exists (SELECT	1
		from	man_ordem_situacao_sla x
		where	x.nr_seq_ordem_serv 	= a.nr_seq_ordem_serv
		and	trunc(x.dt_situacao,'month') 	= man_resumo_sla_ww.dt_referencia
		and	x.ie_situacao_atual	= 'S'
		and	x.ie_classificacao	<> 'E')
	and	trunc(dt_estouro_resposta,'month')	= man_resumo_sla_ww.dt_referencia;

	-- Buscar as OS's com estouro de solução da gerência
	select	count(distinct nr_seq_ordem_serv)
	into STRICT	qt_atraso_solucao_w
	from 	man_ordem_situacao_sla a
	where	nr_seq_localizacao			= nr_seq_localizacao_w
	and ((NR_SEQ_GER_DES_SOLU IS NOT NULL AND NR_SEQ_GER_DES_SOLU::text <> '') or (NR_SEQ_GER_SUP_SOLU IS NOT NULL AND NR_SEQ_GER_SUP_SOLU::text <> ''))
	and	not exists (SELECT	1
		from	man_ordem_situacao_sla x
		where	x.nr_seq_ordem_serv 	= a.nr_seq_ordem_serv
		and	trunc(x.dt_situacao,'month') 	= man_resumo_sla_ww.dt_referencia
		and	x.ie_situacao_atual	= 'S'
		and	x.ie_classificacao	<> 'E')
	and	exists (select	1
		from	man_ordem_situacao_sla x
		where	x.nr_seq_ordem_serv 	= a.nr_seq_ordem_serv
		and	trunc(x.dt_situacao,'month') 	= man_resumo_sla_ww.dt_referencia
		and	x.ie_status_os		= 'A')
	and	trunc(dt_estouro_solucao,'month')	= man_resumo_sla_ww.dt_referencia;

	select	count(distinct nr_seq_ordem_serv)
	into STRICT	qt_recebidas_w
	from 	man_ordem_situacao_sla a
	where	nr_seq_localizacao	= nr_seq_localizacao_w
	and	trunc(a.dt_situacao,'month') 	= man_resumo_sla_ww.dt_referencia
	and ((nr_seq_gerencia_des IS NOT NULL AND nr_seq_gerencia_des::text <> '') or (nr_seq_gerencia_sup IS NOT NULL AND nr_seq_gerencia_sup::text <> ''))
	and	not exists (SELECT	1
		from	man_ordem_situacao_sla x
		where	x.nr_seq_ordem_serv 	= a.nr_seq_ordem_serv
		and	trunc(x.dt_situacao,'month') 	= man_resumo_sla_ww.dt_referencia
		and	x.ie_situacao_atual	= 'S'
		and	x.ie_classificacao	<> 'E')
	and	exists (select	1
		from	man_ordem_situacao_sla y
		where 	trunc(y.dt_situacao,'month') 	= man_resumo_sla_ww.dt_referencia
		and	y.nr_seq_ordem_serv		= a.nr_seq_ordem_serv
		and	y.ie_status_os			= 'A');

	qt_calculo_w	:= qt_recebidas_w * 2;

	if (qt_recebidas_w > 0 or qt_atraso_resposta_w > 0 or qt_atraso_solucao_w > 0) then

		man_resumo_sla_ww.ie_tipo_sla			:= 'ALLDEF';
		man_resumo_sla_ww.pr_atingido			:= 100-(dividir((qt_atraso_resposta_w + qt_atraso_solucao_w),qt_calculo_w)*100);
		man_resumo_sla_ww.qt_sla			:= qt_recebidas_w;
		man_resumo_sla_ww.qt_sla_calculo		:= qt_calculo_w;
		man_resumo_sla_ww.qt_atraso_resposta		:= qt_atraso_resposta_w;
		man_resumo_sla_ww.qt_atraso_solucao		:= qt_atraso_solucao_w;
		man_resumo_sla_ww.qt_target			:= obter_meta_sla(0,man_resumo_sla_ww.dt_referencia,'ALLDEF');

		insert into man_resumo_sla_w values (man_resumo_sla_ww.*);
	end if;

	end;
end loop;
close C03;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_man_resumo_sla_w ((dt_referencia_p timestamp) is man_resumo_sla_ww man_resumo_sla_w) FROM PUBLIC;

