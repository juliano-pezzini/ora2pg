-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE prorrogar_vencto_tit_rec ( nr_titulo_p bigint, dt_vencimento_p timestamp, cd_motivo_p bigint, ds_observacao_p text, ie_calc_p text, nm_usuario_p text, ie_dt_vecto_prorrog_p text default null) AS $body$
DECLARE


vl_juros_w		double precision;
vl_multa_w		double precision;
nr_sequencia_w		integer;
dt_venc_atual_w		timestamp;
dt_emissao_w		timestamp;
ie_zera_multa_juros_w	varchar(1);


BEGIN
if (nr_titulo_p IS NOT NULL AND nr_titulo_p::text <> '') and (dt_vencimento_p IS NOT NULL AND dt_vencimento_p::text <> '') and (cd_motivo_p IS NOT NULL AND cd_motivo_p::text <> '') then

	if (ie_dt_vecto_prorrog_p IS NOT NULL AND ie_dt_vecto_prorrog_p::text <> '') then
		CALL define_dt_juros_tit_rec(nr_titulo_p,ie_dt_vecto_prorrog_p);
	end if;

	select	coalesce(max(nr_sequencia),0) + 1
	into STRICT	nr_sequencia_w
	from	alteracao_vencimento
	where	nr_titulo = nr_titulo_p;

	select	dt_emissao,
		dt_pagamento_previsto
	into STRICT	dt_emissao_w,
		dt_venc_atual_w
	from	titulo_receber
	where	nr_titulo	= nr_titulo_p;

	if (ie_calc_p = 'S') then
		vl_juros_w	:= obter_juros_multa_titulo(nr_titulo_p, dt_vencimento_p, 'R', 'J');
		vl_multa_w	:= obter_juros_multa_titulo(nr_titulo_p, dt_vencimento_p, 'R', 'M');
	else
		vl_juros_w	:= 0;
		vl_multa_w	:= 0;
	end if;

	insert into alteracao_vencimento(nr_titulo,
		nr_sequencia,
		dt_anterior,
		dt_vencimento,
		cd_motivo,
		dt_atualizacao,
		nm_usuario,
		dt_alteracao,
		ds_observacao,
		vl_juros,
		vl_multa)
	values (nr_titulo_p,
		nr_sequencia_w,
		dt_venc_atual_w,
		dt_vencimento_p,
		cd_motivo_p,
		clock_timestamp(),
		nm_usuario_p,
		trunc(clock_timestamp(),'dd'),
		ds_observacao_p,
		vl_juros_w,
		vl_multa_w);

	if (dt_vencimento_p < dt_emissao_w) then
		CALL wheb_mensagem_pck.exibir_mensagem_abort(230346);
	else
		update	titulo_receber
		set	dt_pagamento_previsto	= dt_vencimento_p
		where	nr_titulo		= nr_titulo_p;

		ie_zera_multa_juros_w := Obter_Param_Usuario(801, 152, obter_perfil_ativo, nm_usuario_p, obter_estabelecimento_ativo, ie_zera_multa_juros_w);

		CALL atualiza_venc_jur_mult_cre(	nm_usuario_p,
									vl_juros_w,
									vl_multa_w,
									dt_vencimento_p,
									ie_zera_multa_juros_w,
									nr_titulo_p,
									'N');
	end if;

end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE prorrogar_vencto_tit_rec ( nr_titulo_p bigint, dt_vencimento_p timestamp, cd_motivo_p bigint, ds_observacao_p text, ie_calc_p text, nm_usuario_p text, ie_dt_vecto_prorrog_p text default null) FROM PUBLIC;

