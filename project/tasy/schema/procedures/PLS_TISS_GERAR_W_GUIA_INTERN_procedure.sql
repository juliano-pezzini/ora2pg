-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_tiss_gerar_w_guia_intern ( nr_sequencia_autor_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) AS $body$
DECLARE


cd_guia_w			pls_guia_plano.cd_guia%type;
cd_guia_principal_w		pls_guia_plano.cd_guia_principal%type;
cd_senha_w			pls_guia_plano.cd_senha%type;
dt_autorizacao_w		pls_guia_plano.dt_autorizacao%type;
dt_solicitacao_w		pls_guia_plano.dt_solicitacao%type;
dt_validade_senha_w		pls_guia_plano.dt_validade_senha%type;
dt_emissao_w			pls_guia_plano.dt_emissao%type;
dt_admissao_hosp_w		pls_guia_plano.dt_admissao_hosp%type;
nr_seq_plano_w			pls_guia_plano.nr_seq_plano%type;
nr_seq_segurado_w		pls_guia_plano.nr_seq_segurado%type;
cd_medico_solicitante_w		pls_guia_plano.cd_medico_solicitante%type;
nr_seq_prestador_w		pls_guia_plano.nr_seq_prestador%type;
cd_ans_w			varchar(20);--OS - 1289502
cd_usuario_plano_w		varchar(30);
dt_validade_carteira_w		timestamp;
dt_internacao_sugerida_w	timestamp;
cd_pessoa_fisica_w		pls_segurado.cd_pessoa_fisica%type;
ds_plano_w			varchar(255);
ie_carater_internacao_w		pls_guia_plano.ie_carater_internacao%type;
nr_seq_guia_w			w_tiss_guia.nr_sequencia%type;
ds_indicacao_w			pls_guia_plano.ds_indicacao_clinica%type;
ie_tipo_consulta_w		pls_guia_plano.ie_tipo_consulta%type;
ds_observacao_w			pls_guia_plano.ds_observacao%type;
ie_tipo_atend_tiss_w		pls_guia_plano.ie_tipo_atend_tiss%type;
cd_guia_manual_w		pls_guia_plano.cd_guia_manual%type;
ie_tipo_saida_w			pls_guia_plano.ie_tipo_saida%type;
cd_prestador_exec_w		pls_prestador.cd_prestador%type;
nr_sequencia_autor_w		bigint;
nr_seq_clinica_w		bigint;
qt_proc_guia_w			bigint;
cd_tabela_relat_w		varchar(2);
ie_tipo_item_w			varchar(1);
ie_origem_proced_w		bigint;
cd_procedimento_w		w_tiss_proc_solic.cd_procedimento%type;
cd_material_w			pls_guia_plano_mat.cd_material%type;
ds_procedimento_w		varchar(255);
qt_solicitada_w			double precision;
qt_autorizada_w			double precision;
qt_autorizada_guia_w		double precision;
nr_seq_apresentacao_w		bigint;
nm_pessoa_fisica_w		varchar(255);
nr_cartao_nac_sus_w		varchar(60);
nm_medico_solicitante_w		varchar(255);
sg_conselho_w			varchar(20);
uf_crm_w			medico.uf_crm%type;
ie_recem_nascido_w		varchar(3);
dt_admissao_w			pls_guia_plano.dt_admissao_hosp%type;
nm_contratado_w			w_tiss_autorizacao.nm_contratado%type;
cd_cnes_w			w_tiss_autorizacao.cd_cnes%type;
cd_cgc_w			w_tiss_autorizacao.cd_cgc%type;
ds_tipo_acomodacao_w		w_tiss_autorizacao.ds_tipo_acomodacao%type;
nm_fantasia_prestador_w		varchar(255);
cd_cbo_w			varchar(10);
ie_tipo_guia_w			pls_guia_plano.ie_tipo_guia%type;
cd_cgc_solic_w			pessoa_juridica.cd_cgc%type;
nm_contratado_solic_w		varchar(255);
nr_seq_prestador_solic_w	bigint;
nr_seq_requisicao_w		pls_requisicao.nr_sequencia%type;
cd_prestador_solic_w		pls_prestador.cd_prestador%type;
nr_crm_w			varchar(20);
cd_estabelecimento_w		estabelecimento.cd_estabelecimento%type; --OS - 1289502
c01 CURSOR FOR
	SELECT	to_char(cd_procedimento),
		to_char(0),		--CD_MATERIAL
		'P',
		ie_origem_proced,
		qt_solicitada,
		qt_autorizada,
		pls_obter_cod_tabela_tiss( cd_procedimento, ie_origem_proced, null),
		obter_descricao_procedimento(cd_procedimento,ie_origem_proced)
	from	pls_guia_plano_proc
	where	nr_seq_guia = nr_sequencia_autor_p
	and 	coalesce(nr_seq_motivo_exc::text, '') = ''
	
union	all

	PERFORM	coalesce(pls_obter_seq_codigo_material(nr_seq_material,''),nr_Sequencia),
		to_char(nr_seq_material),
		'M',
		0,
		qt_solicitada,
		qt_autorizada,
		pls_obter_cod_tabela_tiss( null, null, nr_seq_material),
		pls_obter_desc_material(nr_seq_material)
	from	pls_guia_plano_mat
	where	nr_seq_guia = nr_sequencia_autor_p
	and 	coalesce(nr_seq_motivo_exc::text, '') = '';



BEGIN

	delete	from w_tiss_guia
	where	nm_usuario		= nm_usuario_p;

	delete	from w_tiss_proc_solic
	where	nm_usuario		= nm_usuario_p;

	delete	from w_tiss_beneficiario
	where	nm_usuario		= nm_usuario_p;

	delete	from w_tiss_contratado_solic
	where	nm_usuario		= nm_usuario_p;

	delete	from w_tiss_autorizacao
	where	nm_usuario		= nm_usuario_p;

commit;

if (coalesce( nr_sequencia_autor_p,0) > 0) then

	select	a.cd_guia,
		coalesce(a.cd_senha,a.cd_senha_externa),
		a.dt_autorizacao,
		coalesce(a.dt_validade_senha,a.dt_valid_senha_ext),
		a.dt_emissao,
		a.nr_seq_plano,
		a.nr_seq_segurado,
		a.cd_medico_solicitante,
		a.nr_seq_prestador,
		substr(pls_obter_dados_segurado(a.nr_seq_segurado,'CR'),1,255),
		to_date(pls_obter_dados_cart_segurado(a.nr_seq_segurado,'V'),'dd/mm/yyyy'),
		b.cd_pessoa_fisica,
		(select max(c.ds_plano) from pls_plano c where c.nr_sequencia = a.nr_seq_plano) ds_plano,
		a.ie_carater_internacao,
		a.cd_guia_principal,
		a.ds_observacao,
		substr(a.ds_indicacao_clinica,1,255),
		ie_tipo_atend_tiss,
		a.dt_solicitacao,
		substr(a.cd_guia_manual,1,20),
		ie_tipo_saida,
		(select cd_prestador from pls_prestador where nr_sequencia = a.nr_seq_prestador) cd_prestador,
		ie_tipo_consulta,
		dt_internacao_sugerida,
		dt_admissao_hosp,
		ie_tipo_guia,
		(select	y.cd_cbo from cbo_saude y, pls_guia_plano z where z.nr_seq_cbo_saude = y.nr_sequencia and z.nr_sequencia = a.nr_sequencia) cd_cbo,
		a.cd_estabelecimento --OS - 1289502
	into STRICT	cd_guia_w,
		cd_senha_w,
		dt_autorizacao_w,
		dt_validade_senha_w,
		dt_emissao_w,
		nr_seq_plano_w,
		nr_seq_segurado_w,
		cd_medico_solicitante_w,
		nr_seq_prestador_w,
		cd_usuario_plano_w,
		dt_validade_carteira_w,
		cd_pessoa_fisica_w,
		ds_plano_w,
		ie_carater_internacao_w,
		cd_guia_principal_w,
		ds_observacao_w,
		ds_indicacao_w,
		ie_tipo_atend_tiss_w,
		dt_solicitacao_w,
		cd_guia_manual_w,
		ie_tipo_saida_w,
		cd_prestador_exec_w,
		ie_tipo_consulta_w,
		dt_internacao_sugerida_w,
		dt_admissao_hosp_w,
		ie_tipo_guia_w,
		cd_cbo_w,
		cd_estabelecimento_w --OS - 1289502
	from	pls_segurado b,
		pls_guia_plano a
	where	a.nr_seq_segurado	= b.nr_sequencia
	and	a.nr_sequencia		= nr_sequencia_autor_p;

	--Guia de Solicitação de Internação
	if (ie_tipo_guia_w <> '1') then
		goto final;
	end if;

	--OS - 1289502
	cd_ans_w	:= pls_obter_dados_outorgante(cd_estabelecimento_w,'ANS');

	if (coalesce(cd_ans_w::text, '') = '') then
		cd_ans_w	:= pls_obter_dados_outorgante(cd_estabelecimento_p,'ANS');
	end if;


	if (coalesce(cd_ans_w::text, '') = '') then
		select	max(cd_ans)
		into STRICT	cd_ans_w
		from	pls_outorgante
		where	(cd_ans IS NOT NULL AND cd_ans::text <> '');
	end if;
	--fim--OS - 1289502--
		select	a.dt_admissao_hosp,
			a.qt_dia_autorizado,
			pls_obter_dados_prestador(a.nr_seq_prestador,'NF'),
			pls_obter_cnes_prestador(a.nr_seq_prestador),
			a.ds_observacao,
			CASE WHEN b.cd_cgc='' THEN b.cd_pessoa_fisica  ELSE b.cd_cgc END ,
			pls_obter_cd_tiss_acomodacao(a.nr_seq_tipo_acomodacao)
		into STRICT	dt_admissao_w,
			qt_autorizada_guia_w,
			nm_contratado_w,
			cd_cnes_w,
			ds_observacao_w,
			cd_cgc_w,
			ds_tipo_acomodacao_w
		FROM pls_guia_plano a
LEFT OUTER JOIN pls_prestador b ON (a.nr_seq_prestador = b.nr_sequencia)
WHERE a.nr_sequencia	= nr_sequencia_autor_p;


		select	substr(pls_obter_dados_segurado(a.nr_seq_segurado,'CR'),1,255),
			c.dt_validade_carteira,
			substr(tws_get_name_person(d.cd_pessoa_fisica, d.cd_estabelecimento),1,255),
			d.nr_cartao_nac_sus,
			a.ie_recem_nascido
		into STRICT	cd_usuario_plano_w,
			dt_validade_carteira_w,
			nm_pessoa_fisica_w,
			nr_cartao_nac_sus_w,
			ie_recem_nascido_w
		from	pessoa_fisica d,
			pls_segurado_carteira c,
			pls_segurado b,
			pls_guia_plano a
		where	a.nr_sequencia = nr_sequencia_autor_p
		and	a.nr_seq_segurado	= b.nr_sequencia
		and	b.nr_sequencia	= c.nr_seq_segurado
		and	b.cd_pessoa_fisica	= d.cd_pessoa_fisica;

	qt_proc_guia_w 		:= 0;
	nr_seq_apresentacao_w	:= 0;

	open c01;
	loop
	fetch c01 into	cd_procedimento_w,
			cd_material_w,
			ie_tipo_item_w,
			ie_origem_proced_w,
			qt_solicitada_w,
			qt_autorizada_w,
			cd_tabela_relat_w,
			ds_procedimento_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */

		qt_proc_guia_w		:= qt_proc_guia_w + 1;

		if (qt_proc_guia_w = 1) then

			select	nextval('w_tiss_guia_seq')
			into STRICT	nr_seq_guia_w
			;

			select	coalesce(dt_emissao_w,clock_timestamp())
			into STRICT	dt_emissao_w
			;

			insert	into w_tiss_guia(nr_sequencia,
				dt_atualizacao,
				nm_usuario,
				nr_seq_guia,
				cd_ans, 	--OS - 1289502
				cd_autorizacao,
				dt_autorizacao,
				cd_senha,
				dt_validade_senha,
				dt_emissao_guia,
				nr_sequencia_autor,
				cd_autorizacao_princ,
				ds_observacao,
				ie_tiss_tipo_guia,
				dt_entrada,
				ds_assinatura_solic,-- utilizado para salvar o valor do campo CD_GUIA_MANUAL
				nr_guia_operadora,
				dt_internacao_sugerida)
			values (nr_seq_guia_w,
				clock_timestamp(),
				nm_usuario_p,
				nr_sequencia_autor_p,
				cd_ans_w, 	--OS - 1289502
				cd_guia_w,
				dt_autorizacao_w,
				cd_senha_w,
				dt_validade_senha_w,
				dt_emissao_w,
				nr_sequencia_autor_p,
				cd_guia_principal_w,
				ds_observacao_w,
				'2',
				null,
				cd_guia_manual_w,
				cd_guia_w,
				dt_internacao_sugerida_w);

			insert	into w_tiss_beneficiario(nr_sequencia,
				dt_atualizacao,
				nm_usuario,
				nr_seq_guia,
				cd_pessoa_fisica,
				nm_pessoa_fisica,
				nr_cartao_nac_sus,
				dt_validade_carteira,
				cd_usuario_convenio,
				ie_sexo)
			values (nextval('w_tiss_beneficiario_seq'),
				clock_timestamp(),
				nm_usuario_p,
				nr_seq_guia_w,
				cd_pessoa_fisica_w,
				nm_pessoa_fisica_w,
				nr_cartao_nac_sus_w,
				dt_validade_carteira_w,
				cd_usuario_plano_w,
				ie_recem_nascido_w);

			begin
				select	substr(obter_nome_pf(a.cd_pessoa_fisica),1,255),
					substr(obter_conselho_profissional(b.nr_seq_conselho,'S'),1,10),
					a.uf_crm,
					a.nr_crm
				into STRICT	nm_medico_solicitante_w,
					sg_conselho_w,
					uf_crm_w,
					nr_crm_w
				from	pessoa_fisica b,
					medico a
				where	a.cd_pessoa_fisica	= b.cd_pessoa_fisica
				and	a.cd_pessoa_fisica	= cd_medico_solicitante_w;
			exception
			when others then
				nm_medico_solicitante_w := null;
				sg_conselho_w := null;
				uf_crm_w := null;
			end;

			-- verifica se a guia foi gerada a partir de uma requisição
			begin
				select 	nr_seq_requisicao
				into STRICT	nr_seq_requisicao_w
				from 	pls_execucao_req_item
				where 	nr_seq_guia	= nr_sequencia_autor_p  LIMIT 1;
			exception
			when others then
				nr_seq_requisicao_w	:= null;
			end;

			if (nr_seq_requisicao_w IS NOT NULL AND nr_seq_requisicao_w::text <> '') then
				select	nr_seq_prestador,
					(select max(cd_prestador) from pls_prestador a where a.nr_sequencia = nr_seq_prestador) cd_prestador
				into STRICT	nr_seq_prestador_solic_w,
					cd_prestador_solic_w
				from 	pls_requisicao
				where 	nr_sequencia	= nr_seq_requisicao_w;

				cd_cgc_solic_w		:= pls_obter_dados_prestador(nr_seq_prestador_solic_w,'CGC');
				nm_contratado_solic_w	:= substr(pls_obter_dados_prestador(nr_seq_prestador_solic_w,'NF'),1,255);
			else
				cd_cgc_solic_w		:= pls_obter_dados_prestador(nr_seq_prestador_w,'CGC');
				nm_contratado_solic_w	:= substr(pls_obter_dados_prestador(nr_seq_prestador_w,'NF'),1,255);
				cd_prestador_solic_w	:= cd_prestador_exec_w;
			end if;

			insert 	into w_tiss_contratado_solic(nr_sequencia, dt_atualizacao, nm_usuario,
				nr_seq_guia, nm_contratado, nm_solicitante,
				cd_conselho_prof, uf_crm, cd_interno,  -- cd_pessoa_fisica
				cd_cgc,	cd_cbo_sus, sg_conselho,
				nr_crm)
			values (nextval('w_tiss_contratado_solic_seq'),clock_timestamp(), nm_usuario_p,
				nr_seq_guia_w,	nm_contratado_solic_w,nm_medico_solicitante_w,
				CASE WHEN sg_conselho_w='CRM' THEN '06' WHEN sg_conselho_w='CRN' THEN '07' WHEN sg_conselho_w='CRO' THEN '08' WHEN sg_conselho_w='CREFITO' THEN '05'  ELSE '10' END , uf_crm_w, coalesce(cd_prestador_solic_w, cd_cgc_solic_w),
				cd_cgc_solic_w, cd_cbo_w, sg_conselho_w,
				nr_crm_w);

			insert into w_tiss_autorizacao(nr_sequencia,
				dt_atualizacao,
				nm_usuario,
				nr_seq_guia,
				qt_dia_autorizado,
				nm_contratado,
				cd_cnes,
				ds_observacao,
				cd_interno, -- cd_pessoa_fisica
				cd_cgc,
				ds_tipo_acomodacao,
				dt_admissao)
			values (nextval('w_tiss_autorizacao_seq'),
				clock_timestamp(),
				nm_usuario_p,
				nr_seq_guia_w,
				qt_autorizada_guia_w,
				nm_contratado_w,
				cd_cnes_w,
				substr(ds_observacao_w,1,1000),
				coalesce(cd_prestador_exec_w, cd_cgc_w), -- VERIFICAR
				cd_cgc_w,
				ds_tipo_acomodacao_w,
				dt_admissao_hosp_w);

		end if;

		nr_seq_apresentacao_w    := nr_seq_apresentacao_w + 1;

		insert into w_tiss_proc_solic(nr_sequencia,
			dt_atualizacao,
			nm_usuario,
			nr_seq_guia,
			cd_procedimento,
			ds_procedimento,
			cd_edicao_amb,
			qt_solicitada,
			qt_autorizada,
			nr_seq_apresentacao)
		values (nextval('w_tiss_proc_solic_seq'),
			clock_timestamp(),
			nm_usuario_p,
			nr_seq_guia_w,
			cd_procedimento_w,
			ds_procedimento_w,
			cd_tabela_relat_w,
			qt_solicitada_w,
			qt_autorizada_w,
			nr_seq_apresentacao_w);

		if (nr_seq_apresentacao_w = 12) or ((nr_seq_apresentacao_w >12) and (mod(nr_seq_apresentacao_w,12) = 0))then
			qt_proc_guia_w	:= 0;
		end if;
	end loop;
	close c01;
end if;

<<final>>

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_tiss_gerar_w_guia_intern ( nr_sequencia_autor_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) FROM PUBLIC;

