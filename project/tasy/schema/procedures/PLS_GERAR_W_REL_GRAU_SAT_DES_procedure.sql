-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_gerar_w_rel_grau_sat_des ( dt_atual_p timestamp, nm_usuario_p text) AS $body$
DECLARE



nr_seq_gerencia_w       bigint;
nr_seq_grupo_w          bigint;
ie_grau_satisfacao_w    varchar(10);
nr_sequencia_w          bigint;
nm_usuario_exec_w       varchar(15);
dt_ref_mes_w            timestamp;
dt_fim_mes_w            timestamp;

C01 CURSOR FOR
      SELECT  a.nr_sequencia,
        a.nr_seq_grupo_des,
        a.ie_grau_satisfacao
from    man_ordem_servico a
where   a.dt_fim_real between dt_ref_mes_w and dt_fim_mes_w+1
and     (a.ie_grau_satisfacao IS NOT NULL AND a.ie_grau_satisfacao::text <> '')
and     (a.nr_seq_grupo_des IS NOT NULL AND a.nr_seq_grupo_des::text <> '')
and exists (    SELECT  1
                from    man_estagio_processo c,
                        man_ordem_serv_estagio b
                where   b.nr_seq_estagio        = c.nr_sequencia
                and     c.ie_desenv             = 'S'
                and     a.nr_sequencia          = b.nr_seq_ordem);


BEGIN

delete  FROM w_rel_grau_satisf_des
where   nm_usuario = nm_usuario_p;

dt_ref_mes_w                    := trunc(dt_atual_p,'month');
dt_fim_mes_w                    := last_day(dt_ref_mes_w) + 86399/86400;

open C01;
loop
fetch C01 into
        nr_sequencia_w,
        nr_seq_grupo_w,
        ie_grau_satisfacao_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
        begin

        select  max(a.nm_usuario_exec)
        into STRICT    nm_usuario_exec_w
        from    man_ordem_servico_exec a
        where   nr_seq_ordem    = nr_sequencia_w
        and exists (    SELECT  1
                        from    usuario_grupo_des b
                        where   a.nm_usuario_exec = b.nm_usuario_grupo);

        select  max(nr_seq_gerencia)
        into STRICT    nr_seq_gerencia_w
        from    grupo_desenvolvimento
        where   nr_sequencia    = nr_seq_grupo_w;

        insert into w_rel_grau_satisf_des(
                nr_seq_ordem,
                nr_seq_grupo_des,
                ie_grau_satisfacao,
                nr_seq_gerencia,
                nm_usuario,
                nm_usuario_exec)
        values ( nr_sequencia_w,
                nr_seq_grupo_w,
                ie_grau_satisfacao_w,
                nr_seq_gerencia_w,
                nm_usuario_p,
                nm_usuario_exec_w);

        end;
end loop;
close C01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_gerar_w_rel_grau_sat_des ( dt_atual_p timestamp, nm_usuario_p text) FROM PUBLIC;

