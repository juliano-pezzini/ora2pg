-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_reconst_diluicao_onc ( nr_seq_paciente_p bigint, nr_seq_material_p bigint, ie_opcao_p text, nm_usuario_p text) AS $body$
DECLARE



cd_material_w				integer;
cd_material_sem_apresent_w		integer;
cd_material_generico_w			integer;
cd_mat_generico_sem_apresent_w		integer;
cd_intervalo_w				varchar(7);
cd_intervalo_cad_w			varchar(7);
nr_agrupamento_w			double precision;
cd_unidade_medida_w			varchar(30);
nr_ocorrencia_w				double precision;
nr_seq_acum_w				bigint;
nr_agrup_acum_w				double precision;
nr_sequencia_w				bigint;
qt_conversao_w				double precision;
cd_dil_w				bigint;
nm_usuario_w				varchar(15);
ie_bomba_infusao_w			varchar(15);
ie_gerar_kit_w				varchar(15);
ie_gerar_reconstituicao_w		varchar(15);
ie_tipo_material_w			varchar(15);
nr_seq_ficha_tecnica_w			bigint;

cd_diluente_w				integer;
qt_diluicao_w				double precision;
cd_unid_med_diluente_w			varchar(30);
ie_reconstituicao_w			varchar(1);
ie_gera_dil_dose_w			varchar(5);
ie_via_aplicacao_w			varchar(5);
ie_priorizar_min_w			varchar(5);
ie_via_aplic_order_w			varchar(5);
qt_minuto_aplicacao_w			smallint;
qt_hora_aplicacao_w			smallint;
qt_material_w				double precision;
Qt_total_disp_w				double precision;
qt_unitaria_w				double precision;
qt_dose_w					double precision;
cd_unidade_medida_conv_w	varchar(30);

ie_gera_diluicao_w			varchar(1) := 'S';
Controle_w				smallint := 0;
Controle_ww				smallint := 0;
ie_regra_w				varchar(1) := 'N';
ie_diluente_w				varchar(1) := 'N';
ie_atualizar_horario_w			varchar(5);
nr_seq_prioridade_w			smallint;
cd_setor_atendimento_w			integer;
cd_setor_w				integer;
cd_estabelecimento_w			smallint;
qt_idade_w				double precision;
qt_idade_min_w				double precision;
qt_idade_max_w				double precision;

cd_motivo_baixa_w			smallint;/* Rafael em 17/11/2007 OS74014 */
ie_cobra_paciente_w			varchar(1);/* Rafael em 17/11/2007 OS74014 */
ds_dose_diferenciada_w			varchar(50);
qt_dispensar_w				double precision;
ie_regra_disp_w				varchar(1);
ds_erro_w				varchar(255);
cd_perfil_w				integer;
nm_usuario_original_w			varchar(15);
ie_atualiza_reconst_w			varchar(1);
qt_peso_w				real;
ie_gerar_diluicao_w			varchar(1);
qt_vol_adic_reconst_w			double precision;
ie_proporcao_w				varchar(15);
qt_referencia_w				double precision;
qt_referencia_aux_w			double precision;
qt_unitaria_medic_w			double precision;
qt_dose_medic_w				double precision;
qt_dose_aux_w				double precision;
cd_unidade_medida_dose_w		varchar(30);
qt_dose_diluicao_w			double precision;
nr_seq_via_acesso_w			bigint;
nr_seq_restricao_w			bigint;
cd_pessoa_fisica_w			varchar(30);
ds_lista_restricao_w			varchar(255);
qt_solucao_w				double precision;
nr_seq_interno_w			bigint;
cd_unid_med_reconst_w			varchar(30);
qt_dose_especial_w			double precision;
qt_dias_util_w				smallint;
ie_gerar_diluicao_ww			varchar(1);
ie_prescr_mat_sem_lib_w			varchar(30);
ie_calcula_volume_afterpost_w		varchar(1);
ie_substitui_tempo_Atual_w		varchar(1);
ie_ConsisteDoseConsumoMedic_w		varchar(1) := 'S';
ie_gerar_lote_w				varchar(1);
ds_dias_aplicacao_w			varchar(4000);
nr_seq_mat_diluicao_w			bigint;
qt_volume_medic_w				double precision;
nr_seq_agrupamento_w			bigint;
qt_conversao_dose_w				double precision;
qt_unitaria_medic_real_w		double precision;
ie_param_491_w					varchar(1);
qt_sobra                		double precision;

/*
ie_opcao_p
	D Diluição
	R Reconstituição
	A Ambos
*/
c01 CURSOR FOR
SELECT	coalesce(cd_diluente,0),
	coalesce(qt_diluicao,0),
	coalesce(cd_unid_med_diluente, obter_unid_med_usua('ml')),
	coalesce(ie_reconstituicao,'A'),
	ie_via_aplicacao,
	coalesce(qt_minuto_aplicacao,0),
	cd_intervalo,
	nr_seq_prioridade,
	cd_setor_atendimento,
	qt_idade_min,
	qt_idade_max,
	coalesce(cd_motivo_baixa,0),
	coalesce(ie_cobra_paciente,'S'),
	coalesce(ie_proporcao,'F'),
	qt_referencia,
	nr_seq_restricao,
	nr_seq_interno,
	ie_atualizar_tempo,
	IE_DILUIR_INTEIRO,
	coalesce(ie_gerar_lote,'S'),
	nr_seq_interno,
	qt_volume_medic
from	material_diluicao
where	ie_gera_diluicao_w = 'S'
and	ie_opcao_p in ('A','D')
and	((cd_setor_atendimento	= cd_setor_atendimento_w)
or (coalesce(cd_setor_atendimento::text, '') = ''))
and	((coalesce(cd_setor_excluir::text, '') = '') or (cd_setor_excluir <> cd_setor_atendimento_w))
and	obter_se_regra_diluicao_setor(nr_seq_interno, cd_setor_atendimento_w) = 'S'
and	((coalesce(nr_seq_via_acesso::text, '') = '') or (nr_seq_via_acesso = nr_seq_via_acesso_w))
and	((cd_estabelecimento	= cd_estabelecimento_w) or (coalesce(cd_estabelecimento::text, '') = ''))
and	((obter_se_contido(nr_seq_restricao, ds_lista_restricao_w) = 'S') or (coalesce(nr_seq_restricao::text, '') = ''))
and	ie_reconstituicao	= 'N'
and	cd_material		= coalesce(cd_material_sem_apresent_w, cd_material_w)
and	qt_idade_w between obter_idade_diluicao(cd_material,nr_sequencia,'MIN') and obter_idade_diluicao(cd_material,nr_sequencia,'MAX')
and	qt_peso_w  between coalesce(qt_peso_min,0) and coalesce(qt_peso_max,999999)
and	coalesce(cd_perfil,coalesce(obter_perfil_ativo,0)) = coalesce(obter_perfil_ativo,0)
and	((coalesce(cd_unidade_medida::text, '') = '') or (cd_unidade_medida	= cd_unidade_medida_dose_w))
and	coalesce(obter_conversao_unid_med_cons(cd_material_w,cd_unidade_medida_dose_w,qt_dose_medic_w),0) between
	coalesce(obter_conversao_unid_med_cons(cd_material_w,cd_unidade_medida,qt_dose_min),0) and
	coalesce(obter_conversao_unid_med_cons(cd_material_w,cd_unidade_medida,qt_dose_max),9999999)
and	((ie_via_excluir	<> ie_via_aplicacao_w) or (coalesce(ie_via_excluir::text, '') = ''))
and	((ie_via_aplicacao	= ie_via_aplicacao_w) or (coalesce(ie_via_aplicacao::text, '') = ''))
and 	coalesce(nr_seq_agrupamento,nr_seq_agrupamento_w) = nr_seq_agrupamento_w

union

select	coalesce(cd_diluente,0),
	coalesce(qt_diluicao,0),
	coalesce(cd_unid_med_diluente, obter_unid_med_usua('ml')),
	coalesce(ie_reconstituicao,'A'),
	ie_via_aplicacao,
	coalesce(qt_minuto_aplicacao,0),
	cd_intervalo,
	nr_seq_prioridade,
	cd_setor_atendimento,
	qt_idade_min,
	qt_idade_max,
	coalesce(cd_motivo_baixa,0),
	coalesce(ie_cobra_paciente,'S'),
	coalesce(ie_proporcao,'F'),
	qt_referencia,
	nr_seq_restricao,
	nr_seq_interno,
	ie_atualizar_tempo,
	IE_DILUIR_INTEIRO,
	coalesce(ie_gerar_lote,'S'),
	nr_seq_interno,
	qt_volume_medic
from	material_diluicao
where	ie_gera_diluicao_w	= 'S'
and	ie_opcao_p in ('A','D')
and	ie_reconstituicao	= 'N'
and	((cd_setor_atendimento	= cd_setor_atendimento_W)
or (coalesce(cd_setor_atendimento::text, '') = ''))
and	((coalesce(cd_setor_excluir::text, '') = '') or (cd_setor_excluir <> cd_setor_atendimento_w))
and	obter_se_regra_diluicao_setor(nr_seq_interno, cd_setor_atendimento_w) = 'S'
and	((coalesce(nr_seq_via_acesso::text, '') = '') or (nr_seq_via_acesso = nr_seq_via_acesso_w))
and	((obter_se_contido(nr_seq_restricao, ds_lista_restricao_w) = 'S') or (coalesce(nr_seq_restricao::text, '') = ''))
and	((cd_estabelecimento	= cd_estabelecimento_w) or (coalesce(cd_estabelecimento::text, '') = ''))
and	cd_material		= coalesce(cd_mat_generico_sem_apresent_w, cd_material_generico_w)
and	qt_idade_w between obter_idade_diluicao(cd_material,nr_sequencia,'MIN') and obter_idade_diluicao(cd_material,nr_sequencia,'MAX')
and	qt_peso_w  between coalesce(qt_peso_min,0) and coalesce(qt_peso_max,999999)
and	coalesce(cd_perfil,coalesce(obter_perfil_ativo,0)) = coalesce(obter_perfil_ativo,0)
and	((coalesce(cd_unidade_medida::text, '') = '') or (cd_unidade_medida	= cd_unidade_medida_dose_w))
and	coalesce(obter_conversao_unid_med_cons(cd_material_w,cd_unidade_medida_dose_w,qt_dose_medic_w),0) between
	coalesce(obter_conversao_unid_med_cons(cd_material_w,cd_unidade_medida,qt_dose_min),0) and
	coalesce(obter_conversao_unid_med_cons(cd_material_w,cd_unidade_medida,qt_dose_max),9999999)
and	ie_regra_w		= 'G'
and	((ie_via_excluir	<> ie_via_aplicacao_w) or (coalesce(ie_via_excluir::text, '') = ''))
and	((ie_via_aplicacao	= ie_via_aplicacao_w) or (coalesce(ie_via_aplicacao::text, '') = ''))
and 	coalesce(nr_seq_agrupamento,nr_seq_agrupamento_w) = nr_seq_agrupamento_w
order by 	ie_via_aplicacao desc,
		cd_setor_atendimento desc,
		qt_idade_min desc,
		qt_idade_max desc,
		nr_seq_prioridade desc,
		nr_seq_restricao desc;

c02 CURSOR FOR
SELECT	coalesce(cd_diluente,0),
	coalesce(qt_diluicao,0),
	coalesce(cd_unid_med_diluente, obter_unid_med_usua('ml')),
	coalesce(ie_reconstituicao,'A'),
	ie_via_aplicacao,
	cd_intervalo,
	nr_seq_prioridade,
	cd_setor_atendimento,
	qt_idade_min,
	qt_idade_max,
	coalesce(cd_motivo_baixa,0),
	coalesce(ie_cobra_paciente,'S'),
	coalesce(qt_minuto_aplicacao,0),
	qt_volume_adic,
	coalesce(ie_proporcao,'F'),
	qt_referencia,
	nr_seq_restricao,
	cd_unid_med_reconst,
	ie_atualizar_tempo,
	coalesce(ie_priorizar_min,'N'),
	coalesce(ie_gerar_lote,'S'),
	nr_seq_interno
from	material_diluicao
where	ie_opcao_p in ('A','R')
and	cd_material		= cd_material_w
and	ie_reconstituicao 	= 'S'
and	ie_gerar_reconstituicao_w	= 'S'
and	((cd_estabelecimento	= cd_estabelecimento_w) or (coalesce(cd_estabelecimento::text, '') = ''))
and	((obter_se_contido(nr_seq_restricao, ds_lista_restricao_w) = 'S') or (coalesce(nr_seq_restricao::text, '') = ''))
and	qt_idade_w between obter_idade_diluicao(cd_material,nr_sequencia,'MIN') and obter_idade_diluicao(cd_material,nr_sequencia,'MAX')
and	qt_peso_w  between coalesce(qt_peso_min,0) and coalesce(qt_peso_max,999999)
and	((cd_setor_atendimento	= cd_setor_atendimento_W) or (coalesce(cd_setor_atendimento::text, '') = ''))
and	((coalesce(cd_setor_excluir::text, '') = '') or (cd_setor_excluir <> cd_setor_atendimento_w))
and	obter_se_regra_diluicao_setor(nr_seq_interno, cd_setor_atendimento_w) = 'S'
and	coalesce(cd_perfil,coalesce(obter_perfil_ativo,0)) = coalesce(obter_perfil_ativo,0)
and	coalesce(obter_conversao_unid_med_cons(cd_material_w,cd_unidade_medida_dose_w, qt_dose_medic_w ),0) between
	coalesce(obter_conversao_unid_med_cons(cd_material_w,cd_unidade_medida,qt_dose_min),0) and
	coalesce(obter_conversao_unid_med_cons(cd_material_w,cd_unidade_medida,qt_dose_max),9999999)
and	((ie_via_aplicacao 	= ie_via_aplicacao_w) or (coalesce(ie_via_aplicacao::text, '') = ''))
and	((ie_via_excluir	<> ie_via_aplicacao_w) or (coalesce(ie_via_excluir::text, '') = ''))
and 	((coalesce(cd_unidade_medida::text, '') = '') or (cd_unidade_medida	= cd_unidade_medida_dose_w))

union

Select	coalesce(cd_diluente,0),
	coalesce(qt_diluicao,0),
	coalesce(cd_unid_med_diluente, obter_unid_med_usua('ml')),
	coalesce(ie_reconstituicao,'A'),
	ie_via_aplicacao,
	cd_intervalo,
	nr_seq_prioridade,
	cd_setor_atendimento,
	qt_idade_min,
	qt_idade_max,
	coalesce(cd_motivo_baixa,0),
	coalesce(ie_cobra_paciente,'S'),
	coalesce(qt_minuto_aplicacao,0),
	qt_volume_adic,
	coalesce(ie_proporcao,'F'),
	qt_referencia,
	nr_seq_restricao,
	cd_unid_med_reconst,
	ie_atualizar_tempo,
	coalesce(ie_priorizar_min,'N'),
	coalesce(ie_gerar_lote,'S'),
	nr_seq_interno
from	material_diluicao
where	ie_opcao_p in ('A','R')
and	cd_material 		= cd_material_generico_w
and	((cd_estabelecimento	= cd_estabelecimento_w) or (coalesce(cd_estabelecimento::text, '') = ''))
and	((obter_se_contido(nr_seq_restricao, ds_lista_restricao_w) = 'S') or (coalesce(nr_seq_restricao::text, '') = ''))
and	qt_idade_w between obter_idade_diluicao(cd_material,nr_sequencia,'MIN') and obter_idade_diluicao(cd_material,nr_sequencia,'MAX')
and	qt_peso_w  between coalesce(qt_peso_min,0) and coalesce(qt_peso_max,999999)
and	ie_reconstituicao	= 'S'
and	ie_gerar_reconstituicao_w	= 'S'
and	ie_regra_w		= 'G'
and	coalesce(cd_perfil,coalesce(obter_perfil_ativo,0)) = coalesce(obter_perfil_ativo,0)
and	((cd_setor_atendimento	= cd_setor_atendimento_W)
or (coalesce(cd_setor_atendimento::text, '') = ''))
and	((ie_via_excluir	<> ie_via_aplicacao_w) or (coalesce(ie_via_excluir::text, '') = ''))
and	((coalesce(cd_setor_excluir::text, '') = '') or (cd_setor_excluir <> cd_setor_atendimento_w))
and	obter_se_regra_diluicao_setor(nr_seq_interno, cd_setor_atendimento_w) = 'S'
and	coalesce(obter_conversao_unid_med_cons(cd_material_w,cd_unidade_medida_dose_w,qt_dose_medic_w),0) between
	coalesce(obter_conversao_unid_med_cons(cd_material_w,cd_unidade_medida,qt_dose_min),0) and
	coalesce(obter_conversao_unid_med_cons(cd_material_w,cd_unidade_medida,qt_dose_max),9999999)
and	((ie_via_aplicacao	= ie_via_aplicacao_w) or (coalesce(ie_via_aplicacao::text, '') = ''))
and 	((coalesce(cd_unidade_medida::text, '') = '') or (cd_unidade_medida	= cd_unidade_medida_dose_w))
order by	ie_via_aplicacao desc,
		cd_setor_atendimento desc,
		qt_idade_min desc,
		qt_idade_max desc,
		nr_seq_prioridade desc,
		nr_seq_restricao desc;

c04 CURSOR FOR
SELECT	coalesce(cd_diluente,0),
		coalesce(qt_diluicao,0),
		coalesce(cd_unid_med_diluente, obter_unid_med_usua('ml')),
		coalesce(ie_reconstituicao,'A'),
		ie_via_aplicacao,
		coalesce(qt_minuto_aplicacao,0),
		cd_intervalo,
		nr_seq_prioridade,
		cd_setor_atendimento,
		qt_idade_min,
		qt_idade_max,
		coalesce(cd_motivo_baixa,0),
		coalesce(ie_cobra_paciente,'S'),
		coalesce(ie_proporcao,'F'),
		qt_referencia,
		nr_seq_restricao,
		qt_volume,
		coalesce(ie_gerar_lote,'S')
from	material_diluicao
where	cd_material		= cd_material_w
and	((cd_estabelecimento	= cd_estabelecimento_w) or (coalesce(cd_estabelecimento::text, '') = ''))
and	qt_idade_w between obter_idade_diluicao(cd_material,nr_sequencia,'MIN') and obter_idade_diluicao(cd_material,nr_sequencia,'MAX')
and	qt_peso_w  between coalesce(qt_peso_min,0) and coalesce(qt_peso_max,999)
and	ie_reconstituicao	= 'R'
and	ie_gerar_rediluente	= 'S'
and	((ie_via_excluir	<> ie_via_aplicacao_w) or (coalesce(ie_via_excluir::text, '') = ''))
and	coalesce(cd_perfil,coalesce(obter_perfil_ativo,0)) = coalesce(obter_perfil_ativo,0)
and	(qt_volume IS NOT NULL AND qt_volume::text <> '')
and	((coalesce(ie_via_aplicacao::text, '') = '') or (ie_via_aplicacao = ie_via_aplicacao_w));

c03 CURSOR FOR
SELECT	nr_seq_restricao
from	paciente_rep_prescricao a
where	(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
and	cd_pessoa_fisica = cd_pessoa_fisica_w
and	coalesce(dt_inativacao::text, '') = ''
and	((coalesce(a.dt_fim::text, '') = '') or (clock_timestamp() between coalesce(a.dt_inicio,clock_timestamp() - interval '1 days') and a.dt_fim + 86399/86400));

c05 CURSOR FOR
SELECT	b.cd_material
FROM	material_estab c,
	material b,
	medic_ficha_tecnica a
WHERE	b.nr_seq_ficha_tecnica	= a.nr_sequencia
AND	c.cd_material		= b.cd_material
and	((cd_estabelecimento	= cd_estabelecimento_w) or (coalesce(cd_estabelecimento::text, '') = ''))
AND	a.nr_sequencia		= nr_seq_ficha_tecnica_w
AND	Obter_se_via_adm(b.cd_material, ie_via_aplicacao_w) = 'S'
AND	b.cd_material		<> cd_diluente_w
AND	coalesce(obter_conversao_unid_med_onc(b.cd_material, cd_unid_med_diluente_w),0) >= qt_dose_diluicao_w
AND	b.ie_situacao		= 'A'
AND	c.ie_prescricao		= 'S'
order by coalesce(obter_conversao_unid_med_onc(b.cd_material, cd_unid_med_diluente_w),0) desc;


BEGIN

/* Fernando */

/* Matheus OS 50978 20/03/07 coloquei cd_estabelecimento*/

select	max(a.cd_setor_atendimento),
	max(a.cd_estabelecimento),
	max(obter_idade(b.dt_nascimento,coalesce(b.dt_obito,clock_timestamp()),'DIA')),
	max(a.nm_usuario),
	coalesce(max(a.qt_peso),0),
	max(b.cd_pessoa_fisica)
into STRICT	cd_setor_atendimento_w,
	cd_estabelecimento_w,
	qt_idade_w,
	nm_usuario_original_w,
	qt_peso_w,
	cd_pessoa_fisica_w
from	pessoa_fisica b,
	paciente_setor a
where	a.nr_seq_paciente		= nr_seq_paciente_p
and	a.cd_pessoa_fisica	= b.cd_pessoa_fisica;


select	coalesce(obter_agrupamento_setor(cd_setor_atendimento_w),0)
into STRICT	nr_seq_agrupamento_w
;



cd_perfil_w	:= obter_perfil_ativo;
ie_regra_w := Obter_Param_Usuario(924, 78, cd_perfil_w, nm_usuario_original_w, cd_estabelecimento_w, ie_regra_w);
ie_atualiza_reconst_w := Obter_Param_Usuario(924, 214, cd_perfil_w, nm_usuario_original_w, cd_estabelecimento_w, ie_atualiza_reconst_w);
ie_gera_dil_dose_w := Obter_Param_Usuario(924, 347, cd_perfil_w, nm_usuario_original_w, cd_estabelecimento_w, ie_gera_dil_dose_w);
ie_prescr_mat_sem_lib_w := Obter_Param_Usuario(924, 530, cd_perfil_w, nm_usuario_original_w, cd_estabelecimento_w, ie_prescr_mat_sem_lib_w);
ie_calcula_volume_afterpost_w := Obter_Param_Usuario(924, 600, cd_perfil_w, nm_usuario_original_w, cd_estabelecimento_w, ie_calcula_volume_afterpost_w);
ie_gerar_kit_w := Obter_Param_Usuario(924, 702, cd_perfil_w, nm_usuario_original_w, cd_estabelecimento_w, ie_gerar_kit_w);
ie_param_491_w := Obter_Param_Usuario(3130, 491, cd_perfil_w, nm_usuario_original_w, cd_estabelecimento_w, ie_param_491_w);

select	coalesce(max(ie_gerar_diluicao),'S'),
	coalesce(max(ie_gerar_reconstituicao),'S')
into STRICT	ie_gerar_diluicao_ww,
	ie_gerar_reconstituicao_w
from	setor_atendimento
where	cd_setor_atendimento	= cd_setor_atendimento_w;



if (nr_seq_paciente_p > 0) and (nr_seq_material_p > 0) and
	((ie_gerar_diluicao_ww = 'S') or (ie_gerar_reconstituicao_w = 'S')) then

	select	coalesce(max(nr_seq_material),0),
		coalesce(max(nr_agrupamento),0)
	into STRICT	nr_seq_acum_w,
		nr_agrup_acum_w
	from	paciente_protocolo_medic
	where	nr_seq_paciente = nr_seq_paciente_p;


	/* Verificar aqui*/

	Select	coalesce(cd_material,0),
		cd_intervalo,
		coalesce(nr_agrupamento,0),
		coalesce(cd_unidade_medida, obter_unid_med_usua('ml')),
		1,
		coalesce(nm_usuario,'Tasy'),
		ie_via_aplicacao,
		QT_DOSE_PRESCR,
		QT_DOSE_PRESCR,
		QT_DOSE,
		QT_DOSE_PRESCR,
		null,
		'S',
		null,
		null,
		QT_DOSE_PRESCR,
		CD_UNID_MED_PRESCR,
		null,
		qt_dias_util,
		ie_bomba_infusao,
		ds_dias_aplicacao
	into STRICT	cd_material_w,
		cd_intervalo_w,
		nr_agrupamento_w,
		cd_unidade_medida_w,
		nr_ocorrencia_w,
		nm_usuario_w,
		ie_via_aplicacao_w,
		qt_material_w,
		Qt_total_disp_w,
		qt_dose_w,
		qt_unitaria_medic_w,
		cd_material_sem_apresent_w,
		ie_gerar_diluicao_w,
		ds_dose_diferenciada_w,
		nr_seq_via_acesso_w,
		qt_dose_medic_w,
		cd_unidade_medida_dose_w,
		qt_dose_especial_w,
		qt_dias_util_w,
		ie_bomba_infusao_w,
		ds_dias_aplicacao_w
	from	paciente_protocolo_medic
	where	nr_seq_paciente = nr_seq_paciente_p
	and	nr_seq_material  = nr_seq_material_p
	and	(cd_material IS NOT NULL AND cd_material::text <> '');

	open c03;
	loop
	fetch c03 into
		nr_seq_restricao_w;
	EXIT WHEN NOT FOUND; /* apply on c03 */
		ds_lista_restricao_w	:= nr_seq_restricao_w  || ',' || ds_lista_restricao_w;
	end loop;
	close c03;




	select	coalesce(max(cd_material_generico),cd_material_w)
	into STRICT	cd_material_generico_w
	from	material
	where	cd_material	= cd_material_w;

	select	coalesce(max(cd_material_generico),cd_material_sem_apresent_w)
	into STRICT	cd_mat_generico_sem_apresent_w
	from	material
	where	cd_material	= cd_material_sem_apresent_w;

	/* Inserir o reconstituinte */

	open C02;
	loop
	fetch c02 into
		cd_diluente_w,
		qt_diluicao_w,
		cd_unid_med_diluente_w,
		ie_reconstituicao_w,
		ie_via_aplic_order_w,
		cd_intervalo_cad_w,
		nr_seq_prioridade_w,
		cd_setor_w,
		qt_idade_min_w,
		qt_idade_max_w,
		cd_motivo_baixa_w,
		ie_cobra_paciente_w,
		qt_minuto_aplicacao_w,
		qt_vol_adic_reconst_w,
		ie_proporcao_w,
		qt_referencia_w,
		nr_seq_restricao_w,
		cd_unid_med_reconst_w,
		ie_substitui_tempo_Atual_w,
		ie_priorizar_min_w,
		ie_gerar_lote_w,
		nr_seq_mat_diluicao_w;
	EXIT WHEN NOT FOUND; /* apply on C02 */
		ie_diluente_w	:= 'S';
	end loop;
	close C02;

		if (ie_param_491_w = 'S') then
      		qt_sobra := 0;

			select 	coalesce(max(CASE WHEN cd_unidade_medida='FA' THEN  cd_unidade_medida  ELSE CASE WHEN cd_unidade_medida='AMP' THEN  cd_unidade_medida  ELSE cd_unid_med_diluente_w END  END ), cd_unid_med_diluente_w)
			into STRICT	cd_unidade_medida_conv_w
			from	material_conversao_unidade
			where	cd_material	= cd_material_w
			and		upper(cd_unidade_medida) in ('FA', 'AMP');

			if (cd_unidade_medida_w = cd_unidade_medida_conv_w) then
				qt_referencia_w := ceil(qt_dose_w);
			else
				qt_referencia_w :=  ceil(qt_dose_w * obter_conversao_unid_med_onc(cd_material_w, cd_unidade_medida_conv_w));
        		qt_sobra := mod(qt_referencia_w, qt_diluicao_w);
			end if;

			if (qt_referencia_w > 0) then
		        if (qt_sobra > 0) then
          			qt_diluicao_w := (qt_referencia_w - qt_sobra) + qt_diluicao_w;
        		else
          			qt_diluicao_w := qt_referencia_w;
        		end if;
			end if;
		end if;

	if (ie_diluente_w = 'S') and (coalesce(cd_diluente_w,0) > 0) then

		nr_sequencia_w	:= nr_seq_acum_w + 1;

		select	coalesce(max(qt_conversao),1)
		into STRICT	qt_conversao_w
		from	material_conversao_unidade
		where	cd_material		= cd_diluente_w
		and	cd_unidade_medida	= cd_unid_med_diluente_w;

		if (ie_atualiza_reconst_w = 'N') then
			begin
			delete	FROM paciente_protocolo_medic
			where	nr_seq_paciente = nr_seq_paciente_p
			and	ie_agrupador  = 9
			and	nr_seq_diluicao = nr_seq_material_p;
			end;
		end if;

		Select	count(*)
		into STRICT	Controle_w
		from	paciente_protocolo_medic
		where	nr_seq_paciente = nr_seq_paciente_p
		and	ie_agrupador  = 9
		and	nr_seq_diluicao = nr_seq_material_p;

		qt_unitaria_w	:= dividir(qt_diluicao_w,qt_conversao_w);



		if (Controle_w = 0) then
			begin

			Select	count(*)
			into STRICT	Controle_ww
			from	paciente_protocolo_medic
			where	nr_seq_paciente = nr_seq_paciente_p
			and	ie_agrupador  = 3
			and	nr_seq_diluicao = nr_seq_material_p;

			if (Controle_ww = 0) then
				begin
				if (qt_minuto_aplicacao_w > 0) then
					if (qt_minuto_aplicacao_w < 60) then
						qt_hora_aplicacao_w	:= null;
					elsif (qt_minuto_aplicacao_w = 60) then
						qt_hora_aplicacao_w	:= 1;
						qt_minuto_aplicacao_w	:= null;
					else
						qt_hora_aplicacao_w	:= trunc(dividir(qt_minuto_aplicacao_w,60));
						qt_minuto_aplicacao_w	:= (qt_minuto_aplicacao_w - (qt_hora_aplicacao_w * 60));
					end if;
				end if;

				if (qt_minuto_aplicacao_w = 0) then
					qt_minuto_aplicacao_w	:= null;
				end if;

				update	paciente_protocolo_medic
				set	qt_min_aplicacao	= qt_minuto_aplicacao_w,
					qt_hora_aplicacao	= qt_hora_aplicacao_w
				where	nr_seq_paciente 	= nr_seq_paciente_p
				and	nr_seq_material		= nr_seq_material_p
				and	ie_aplic_bolus		= 'N'
				and	ie_aplic_lenta		= 'N'
				and 	((coalesce(ie_substitui_tempo_Atual_w,'N') = 'S') or (coalesce(qt_min_aplicacao::text, '') = '' and coalesce(qt_hora_aplicacao::text, '') = ''));

				end;

			end if;






			INSERT INTO PACIENTE_PROTOCOLO_MEDIC( NR_SEQ_DILUICAO,
								NR_SEQ_MATERIAL,
								NR_AGRUPAMENTO,
								DS_RECOMENDACAO,
								NR_SEQ_PACIENTE,
								CD_MATERIAL,
								QT_DOSE,
								CD_UNIDADE_MEDIDA,
								DS_DIAS_APLICACAO,
								IE_VIA_APLICACAO,
								DT_ATUALIZACAO,
								NM_USUARIO,
								QT_MIN_APLICACAO,
								IE_BOMBA_INFUSAO,
								QT_HORA_APLICACAO,
								CD_INTERVALO,
								NR_SEQ_INTERNO,
								QT_DIAS_UTIL,
								IE_SE_NECESSARIO,
								DS_OBSERVACAO,
								IE_URGENCIA,
								IE_APLIC_BOLUS,
								IE_APLIC_LENTA,
								CD_PROTOCOLO,
								NR_SEQ_MEDICACAO,
								CD_UNID_MED_PRESCR,
								QT_DOSE_PRESCR,
								IE_PRE_MEDICACAO,
								IE_ALERTA_VIA_ADM,
								NR_SEQ_SOLUCAO,
								DS_CICLOS_APLICACAO,
								CD_PROTOCOLO_ADIC,
								NR_SEQ_MEDICACAO_ADIC,
								IE_GERAR_SOLUCAO,
								PR_REDUCAO,
								IE_TIPO_DOSAGEM,
								QT_DOSAGEM,
								NR_SEQ_RECONSTITUINTE,
								IE_AGRUPADOR,
								IE_APLICA_REDUCAO,
								IE_ZERADO,
								IE_REGRA_DILUICAO_CAD_MAT,
								nr_seq_mat_diluicao)
			 VALUES (
								nr_seq_material_p,
								nr_sequencia_w,
								0,
								null,
								nr_seq_paciente_p,
								cd_diluente_w,
								qt_diluicao_w,
								cd_unid_med_diluente_w,
								DS_DIAS_APLICACAO_w,
								ie_via_aplicacao_w,
								clock_timestamp(),
								nm_usuario_p,
								null,
								ie_bomba_infusao_w,
								null,
								null,
								nextval('paciente_protocolo_medic_seq'),
								null,
								null,
								null,
								null,
								null,
								null,
								null,
								null,
								cd_unid_med_diluente_w,
								qt_diluicao_w,
								'N',
								null,
								null,
								null,
								null,
								null,
								'N',
								null,
								null,
								qt_diluicao_w,
								null,
								9,
								'N',
								'N',
								'N' ,
								nr_seq_mat_diluicao_w);





			end;
		end if;
	end if;

	/* Inserir o Diluente */

	if (ie_gerar_diluicao_ww = 'S') then

		select	coalesce(max(nr_seq_material),0),
			coalesce(max(nr_agrupamento),0)
		into STRICT	nr_seq_acum_w,
			nr_agrup_acum_w
		from	paciente_protocolo_medic
		where	nr_seq_paciente = nr_seq_paciente_p;

		/*Select	nvl(cd_material,0),
			cd_intervalo,
			nvl(nr_agrupamento,0),
			nvl(cd_unidade_medida,'ml'),
			nvl(nr_ocorrencia,1),
			nvl(nm_usuario,'Tasy'),
			ie_via_aplicacao,
			ds_dose_diferenciada
		into	cd_material_w,
			cd_intervalo_w,
			nr_agrupamento_w,
			cd_unidade_medida_w,
			nr_ocorrencia_w,
			nm_usuario_w,
			ie_via_aplicacao_w,
			ds_dose_diferenciada_w
		from	prescr_material
		where	nr_prescricao = nr_prescricao_p
		and	nr_sequencia  = nr_sequencia_p
		and	cd_material is not null;
		*/
		if (ie_via_aplicacao_w IS NOT NULL AND ie_via_aplicacao_w::text <> '') then
			select	max(ie_gera_diluicao)
			into STRICT	ie_gera_diluicao_w
			from	via_aplicacao
			where	ie_via_aplicacao = ie_via_aplicacao_w;
		end if;

		ie_diluente_w	:= 'N';

		open C01;
		loop
		fetch C01 into
			cd_diluente_w,
			qt_diluicao_w,
			cd_unid_med_diluente_w,
			ie_reconstituicao_w,
			ie_via_aplic_order_w,
			qt_minuto_aplicacao_w,
			cd_intervalo_cad_w,
			nr_seq_prioridade_w,
			cd_setor_w,
			qt_idade_min_w,
			qt_idade_max_w,
			cd_motivo_baixa_w,
			ie_cobra_paciente_w,
			ie_proporcao_w,
			qt_referencia_w,
			nr_seq_restricao_w,
			nr_seq_interno_w,
			ie_substitui_tempo_Atual_w,
			ie_ConsisteDoseConsumoMedic_w,
			ie_gerar_lote_w,
			nr_seq_mat_diluicao_w,
			qt_volume_medic_w;
		EXIT WHEN NOT FOUND; /* apply on C01 */
			ie_diluente_w	:= 'S';
		end loop;
		close C01;


		if (ie_diluente_w = 'S') and (coalesce(cd_diluente_w,0) > 0) then

			select	max(ie_tipo_material),
				max(nr_seq_ficha_tecnica)
			into STRICT	ie_tipo_material_w,
				nr_seq_ficha_tecnica_w
			from	material
			where	cd_material	= cd_diluente_w;

			qt_dose_diluicao_w	:= qt_diluicao_w;
			qt_referencia_aux_w	:= qt_referencia_w;
			if (coalesce(qt_referencia_w,0) > 0) then
				qt_referencia_w	:= obter_conversao_unid_med_cons(cd_diluente_w,cd_unid_med_diluente_w,qt_referencia_w);
			end if;

			if (ie_tipo_material_w	= '6')	then

				open C05;
				loop
				fetch C05 into
					cd_dil_w;
				EXIT WHEN NOT FOUND; /* apply on C05 */
					cd_dil_w	:= cd_dil_w;
				end loop;
				close C05;

				if (cd_dil_w > 0) then
					cd_diluente_w	:= cd_dil_w;
				end if;
			end if;

			nr_sequencia_w	:= nr_seq_acum_w + 1;

			if (ie_proporcao_w = 'F') and (ie_ConsisteDoseConsumoMedic_w = 'N') and (coalesce(qt_volume_medic_w,0)	> 0) then
				qt_diluicao_w	:= obter_conversao_unid_med_cons(cd_material_w,obter_unid_med_usua('ml'),qt_volume_medic_w);
			elsif (coalesce(qt_referencia_w,0) > 0) then
				if (ie_proporcao_w = 'SC') then
					-- Convter a qt_unitaria_medic_w para a UM de consumo do item. Pois se o item é prescrito manualmente essa variável trás a qtde prescrita e não unitária realmente.
					begin
						qt_unitaria_medic_real_w := obter_conversao_unid_med_cons(cd_material_w,cd_unidade_medida_w,qt_unitaria_medic_w);

						if (ie_ConsisteDoseConsumoMedic_w = 'S') then
							qt_diluicao_w	:= ceil(qt_unitaria_medic_real_w) * qt_referencia_aux_w;
						else
							qt_diluicao_w	:= ceil(qt_unitaria_medic_real_w) * qt_referencia_aux_w;
						end if;

					exception when others then
						qt_diluicao_w := 0;
					end;

				elsif (ie_proporcao_w = 'ST') then
					if (ie_ConsisteDoseConsumoMedic_w = 'S') then
						qt_diluicao_w		:= ceil(qt_unitaria_medic_w) * qt_referencia_w;
					else
						qt_diluicao_w		:= qt_unitaria_medic_w * qt_referencia_w;
					end if;
					qt_dose_aux_w		:= obter_conversao_unid_med_cons(cd_material_w, cd_unidade_medida_dose_w, qt_dose_medic_w);
					--qt_referencia_aux_w	:= obter_conversao_unid_med_cons(cd_material_w, cd_unid_med_diluente_w, qt_referencia_aux_w);
					qt_minuto_aplicacao_w	:= trunc(qt_minuto_aplicacao_w * qt_dose_aux_w);
				end if;
			end if;

			select	coalesce(max(qt_conversao),1)
			into STRICT	qt_conversao_w
			from	material_conversao_unidade
			where	cd_material		= cd_diluente_w
			and	cd_unidade_medida	= cd_unid_med_diluente_w;

			Select	count(*)
			into STRICT	Controle_ww
			from	paciente_protocolo_medic
			where	nr_seq_paciente = nr_seq_paciente_p
			and	ie_agrupador  = 3
			and	nr_seq_diluicao = nr_seq_material_p;



			if (Controle_ww = 0) then

				if (qt_minuto_aplicacao_w > 0) then
					if (qt_minuto_aplicacao_w < 60) then
						qt_hora_aplicacao_w	:= null;
					elsif (qt_minuto_aplicacao_w = 60) then
						qt_hora_aplicacao_w	:= 1;
						qt_minuto_aplicacao_w	:= null;
					else
						qt_hora_aplicacao_w	:= trunc(dividir(qt_minuto_aplicacao_w,60));
						qt_minuto_aplicacao_w	:= (qt_minuto_aplicacao_w - (qt_hora_aplicacao_w * 60));
					end if;
				end if;

				if (qt_minuto_aplicacao_w = 0) then
					qt_minuto_aplicacao_w	:= null;
				end if;

				/* Ivan em 10/07/2007 OS62199 -
				Inclusão das restrições por bolus e lentamente para não desativar os dois campos ao mesmo tempo */
				update	paciente_protocolo_medic
				set	qt_min_aplicacao	= qt_minuto_aplicacao_w,
					qt_hora_aplicacao	= qt_hora_aplicacao_w
				where	nr_seq_paciente 	= nr_seq_paciente_p
				and	nr_seq_material		= nr_seq_material_p
				and	ie_aplic_bolus		= 'N'
				and	ie_aplic_lenta		= 'N'
				and	((ie_priorizar_min_w	= 'N') or (coalesce(qt_min_aplicacao::text, '') = '' and
					  coalesce(qt_hora_aplicacao::text, '') = ''))
				and 	((coalesce(ie_substitui_tempo_Atual_w,'N') = 'S' and
					 ie_proporcao_w <> 'ST') or (coalesce(qt_min_aplicacao::text, '') = '' and
					  coalesce(qt_hora_aplicacao::text, '') = ''));


				if (coalesce(qt_referencia_w,0) > 0) and (ie_proporcao_w = 'ST') then
					update	paciente_protocolo_medic
					set	qt_min_aplicacao	= qt_minuto_aplicacao_w,
						qt_hora_aplicacao	= qt_hora_aplicacao_w
					where	nr_seq_paciente 	= nr_seq_paciente_p
					and	nr_seq_material		= nr_seq_material_p
					and	ie_aplic_bolus		= 'N'
					and	ie_aplic_lenta		= 'N';
				end if;



			INSERT INTO PACIENTE_PROTOCOLO_MEDIC( NR_SEQ_DILUICAO,
								NR_SEQ_MATERIAL,
								NR_AGRUPAMENTO,
								DS_RECOMENDACAO,
								NR_SEQ_PACIENTE,
								CD_MATERIAL,
								QT_DOSE,
								CD_UNIDADE_MEDIDA,
								DS_DIAS_APLICACAO,
								IE_VIA_APLICACAO,
								DT_ATUALIZACAO,
								NM_USUARIO,
								QT_MIN_APLICACAO,
								IE_BOMBA_INFUSAO,
								QT_HORA_APLICACAO,
								CD_INTERVALO,
								NR_SEQ_INTERNO,
								QT_DIAS_UTIL,
								IE_SE_NECESSARIO,
								DS_OBSERVACAO,
								IE_URGENCIA,
								IE_APLIC_BOLUS,
								IE_APLIC_LENTA,
								CD_PROTOCOLO,
								NR_SEQ_MEDICACAO,
								CD_UNID_MED_PRESCR,
								QT_DOSE_PRESCR,
								IE_PRE_MEDICACAO,
								IE_ALERTA_VIA_ADM,
								NR_SEQ_SOLUCAO,
								DS_CICLOS_APLICACAO,
								CD_PROTOCOLO_ADIC,
								NR_SEQ_MEDICACAO_ADIC,
								IE_GERAR_SOLUCAO,
								PR_REDUCAO,
								IE_TIPO_DOSAGEM,
								QT_DOSAGEM,
								NR_SEQ_RECONSTITUINTE,
								IE_AGRUPADOR,
								IE_APLICA_REDUCAO,
								IE_ZERADO,
								IE_REGRA_DILUICAO_CAD_MAT,
								nr_seq_mat_diluicao)
			 VALUES (
								nr_seq_material_p,
								nr_sequencia_w,
								0,
								null,
								nr_seq_paciente_p,
								cd_diluente_w,
								qt_diluicao_w,
								cd_unid_med_diluente_w,
								DS_DIAS_APLICACAO_w,
								ie_via_aplicacao_w,
								clock_timestamp(),
								nm_usuario_p,
								null,
								ie_bomba_infusao_w,
								null,
								null,
								nextval('paciente_protocolo_medic_seq'),
								null,
								null,
								null,
								null,
								null,
								null,
								null,
								null,
								cd_unid_med_diluente_w,
								qt_diluicao_w,
								'N',
								null,
								null,
								null,
								null,
								null,
								'N',
								null,
								null,
								qt_diluicao_w,
								null,
								3,
								'N',
								'N',
								'N',
								nr_seq_mat_diluicao_w);


			elsif (ie_gera_dil_dose_w	= 'S') then
				null;
			end if;
		end if;
	end if;
	/* inserir o rediluente*/

	/* Inserir o Diluente */

	if (ie_gerar_diluicao_ww = 'S') then

		select	coalesce(max(nr_seq_material),0),
			coalesce(max(nr_agrupamento),0)
		into STRICT	nr_seq_acum_w,
			nr_agrup_acum_w
		from	paciente_protocolo_medic
		where	nr_seq_paciente = nr_seq_paciente_p;

		if (ie_via_aplicacao_w IS NOT NULL AND ie_via_aplicacao_w::text <> '') then
			select	max(ie_gera_diluicao)
			into STRICT	ie_gera_diluicao_w
			from	via_aplicacao
			where	ie_via_aplicacao = ie_via_aplicacao_w;
		end if;

		ie_diluente_w	:= 'N';

		open C04;
		loop
		fetch C04 into
			cd_diluente_w,
			qt_diluicao_w,
			cd_unid_med_diluente_w,
			ie_reconstituicao_w,
			ie_via_aplic_order_w,
			qt_minuto_aplicacao_w,
			cd_intervalo_cad_w,
			nr_seq_prioridade_w,
			cd_setor_w,
			qt_idade_min_w,
			qt_idade_max_w,
			cd_motivo_baixa_w,
			ie_cobra_paciente_w,
			ie_proporcao_w,
			qt_referencia_w,
			nr_seq_restricao_w,
			qt_solucao_w,
			ie_gerar_lote_w;
		EXIT WHEN NOT FOUND; /* apply on C04 */
			ie_diluente_w	:= 'S';
		end loop;
		close C04;

		if (ie_diluente_w = 'S')  and (coalesce(cd_diluente_w,0) > 0) then
				qt_dose_diluicao_w	:= qt_diluicao_w;
			if (coalesce(qt_referencia_w,0) > 0) then
				qt_referencia_w	:= obter_conversao_unid_med_cons(cd_diluente_w,cd_unid_med_diluente_w,qt_referencia_w);
			end if;

			nr_sequencia_w	:= nr_seq_acum_w + 1;

			if (coalesce(qt_referencia_w,0) > 0) then
				if (ie_proporcao_w = 'SC') then
					qt_diluicao_w	:= qt_unitaria_medic_w * qt_referencia_w;
				elsif (ie_proporcao_w = 'ST') then
					qt_diluicao_w		:= qt_unitaria_medic_w * qt_referencia_w;
					qt_minuto_aplicacao_w	:= qt_minuto_aplicacao_w * qt_referencia_w;
				end if;
			end if;

			select	coalesce(max(qt_conversao),1)
			into STRICT	qt_conversao_w
			from	material_conversao_unidade
			where	1 = 1
			and		cd_unidade_medida	= cd_unid_med_diluente_w
			and		cd_material		= cd_diluente_w;

			Select	count(*)
			into STRICT	Controle_ww
			from	paciente_protocolo_medic
			where	nr_seq_paciente = nr_seq_paciente_p
			and	ie_agrupador  = 7
			and	nr_seq_diluicao = nr_seq_material_p;



			if (Controle_w = 0) then

				if (qt_minuto_aplicacao_w > 0) then
					if (qt_minuto_aplicacao_w < 60) then
						qt_hora_aplicacao_w	:= null;
					elsif (qt_minuto_aplicacao_w = 60) then
						qt_hora_aplicacao_w	:= 1;
						qt_minuto_aplicacao_w	:= null;
					else
						qt_hora_aplicacao_w	:= trunc(dividir(qt_minuto_aplicacao_w,60));
						qt_minuto_aplicacao_w	:= (qt_minuto_aplicacao_w - (qt_hora_aplicacao_w * 60));
					end if;
				end if;

				if (qt_minuto_aplicacao_w = 0) then
					qt_minuto_aplicacao_w	:= null;
				end if;

				/* Ivan em 10/07/2007 OS62199 -
				Inclusão das restrições por bolus e lentamente para não desativar os dois campos ao mesmo tempo */
				update	paciente_protocolo_medic
				set	qt_min_aplicacao	= qt_minuto_aplicacao_w,
					qt_hora_aplicacao	= qt_hora_aplicacao_w
				where	nr_seq_paciente 	= nr_seq_paciente_p
				and	nr_seq_material		= nr_seq_material_p
				and	ie_aplic_bolus		= 'N'
				and	ie_aplic_lenta		= 'N'
				and	((ie_priorizar_min_w	= 'N') or (coalesce(qt_min_aplicacao::text, '') = '' and
					  coalesce(qt_hora_aplicacao::text, '') = ''))
				and 	((coalesce(ie_substitui_tempo_Atual_w,'N') = 'S' and
					 ie_proporcao_w <> 'ST') or (coalesce(qt_min_aplicacao::text, '') = '' and
					  coalesce(qt_hora_aplicacao::text, '') = ''));


				if (coalesce(qt_referencia_w,0) > 0) and (ie_proporcao_w = 'ST') then
					update	paciente_protocolo_medic
					set	qt_min_aplicacao	= qt_minuto_aplicacao_w,
						qt_hora_aplicacao	= qt_hora_aplicacao_w
					where	nr_seq_paciente 	= nr_seq_paciente_p
					and	nr_seq_material		= nr_seq_material_p
					and	ie_aplic_bolus		= 'N'
					and	ie_aplic_lenta		= 'N';
				end if;



			INSERT INTO PACIENTE_PROTOCOLO_MEDIC( NR_SEQ_DILUICAO,
								NR_SEQ_MATERIAL,
								NR_AGRUPAMENTO,
								DS_RECOMENDACAO,
								NR_SEQ_PACIENTE,
								CD_MATERIAL,
								QT_DOSE,
								CD_UNIDADE_MEDIDA,
								DS_DIAS_APLICACAO,
								IE_VIA_APLICACAO,
								DT_ATUALIZACAO,
								NM_USUARIO,
								QT_MIN_APLICACAO,
								IE_BOMBA_INFUSAO,
								QT_HORA_APLICACAO,
								CD_INTERVALO,
								NR_SEQ_INTERNO,
								QT_DIAS_UTIL,
								IE_SE_NECESSARIO,
								DS_OBSERVACAO,
								IE_URGENCIA,
								IE_APLIC_BOLUS,
								IE_APLIC_LENTA,
								CD_PROTOCOLO,
								NR_SEQ_MEDICACAO,
								CD_UNID_MED_PRESCR,
								QT_DOSE_PRESCR,
								IE_PRE_MEDICACAO,
								IE_ALERTA_VIA_ADM,
								NR_SEQ_SOLUCAO,
								DS_CICLOS_APLICACAO,
								CD_PROTOCOLO_ADIC,
								NR_SEQ_MEDICACAO_ADIC,
								IE_GERAR_SOLUCAO,
								PR_REDUCAO,
								IE_TIPO_DOSAGEM,
								QT_DOSAGEM,
								NR_SEQ_RECONSTITUINTE,
								IE_AGRUPADOR,
								IE_APLICA_REDUCAO,
								IE_ZERADO,
								IE_REGRA_DILUICAO_CAD_MAT)
			 VALUES (
								nr_seq_material_p,
								nr_sequencia_w,
								0,
								null,
								nr_seq_paciente_p,
								cd_diluente_w,
								qt_diluicao_w,
								cd_unid_med_diluente_w,
								DS_DIAS_APLICACAO_w,
								ie_via_aplicacao_w,
								clock_timestamp(),
								nm_usuario_p,
								null,
								ie_bomba_infusao_w,
								null,
								null,
								nextval('paciente_protocolo_medic_seq'),
								null,
								null,
								null,
								null,
								null,
								null,
								null,
								null,
								cd_unid_med_diluente_w,
								qt_diluicao_w,
								'N',
								null,
								null,
								null,
								null,
								null,
								'N',
								null,
								null,
								qt_diluicao_w,
								null,
								7,
								'N',
								'N',
								'N');

			elsif (ie_gera_dil_dose_w	= 'S') then
				null;
			end if;
		end if;
	end if;
	/* inserir o rediluente*/

end if;
/*
Ajustar_Dose_Diluente (nr_prescricao_p, nr_sequencia_p);


	calcular_vol_dil_Prescr_mat(nr_prescricao_p, nr_agrupamento_w, nm_usuario_original_w);
*/
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_reconst_diluicao_onc ( nr_seq_paciente_p bigint, nr_seq_material_p bigint, ie_opcao_p text, nm_usuario_p text) FROM PUBLIC;

