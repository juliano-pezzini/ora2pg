-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE atualizar_prescr_item_sae ( nr_prescr_sae_p bigint, nr_seq_item_p bigint, nm_usuario_p text) AS $body$
DECLARE

						
qt_reg_w			bigint := 0;
cd_intervalo_w		varchar(7);
ds_horarios_w		varchar(2000);
nr_prescricao_w		bigint;	
nr_ocorrencia_w		bigint;
qt_material_w		double precision;
ie_agora_w			varchar(1);
hr_prim_horario_w 	pe_prescr_proc.hr_prim_horario%type;
ie_se_necessario_w	pe_prescr_proc.ie_se_necessario%type;


BEGIN

if (nr_prescr_sae_p IS NOT NULL AND nr_prescr_sae_p::text <> '') and (nr_seq_item_p IS NOT NULL AND nr_seq_item_p::text <> '') and (nm_usuario_p IS NOT NULL AND nm_usuario_p::text <> '') then
	
	Select	max(nr_prescricao)
	into STRICT	nr_prescricao_w
	from	pe_prescricao
	where	nr_sequencia = nr_prescr_sae_p;
	
		
	if (nr_prescricao_w IS NOT NULL AND nr_prescricao_w::text <> '') then
	
		Select	count(*)
		into STRICT	qt_reg_w
		from	prescr_material	
		where	nr_prescricao		= nr_prescricao_w
		and	nr_seq_pe_proc		= nr_seq_item_p
		and	coalesce(dt_lib_enfermagem::text, '') = ''
		and	coalesce(dt_suspensao::text, '') = '';

		if (qt_reg_w > 0) then

			begin
			
			select	max(cd_intervalo),
				max(ds_horarios),
				max(coalesce(obter_ocorrencia_intervalo(cd_intervalo, 24, 'O'),1)),
				max(ie_agora),
				max(hr_prim_horario),
				max(ie_se_necessario)
			into STRICT	cd_intervalo_w,
				ds_horarios_w,
				nr_ocorrencia_w,
				ie_agora_w,
				hr_prim_horario_w,
				ie_se_necessario_w
			from	pe_prescr_proc
			where	nr_sequencia = nr_seq_item_p;
				
			update	prescr_material
			set	cd_intervalo = cd_intervalo_w,
				ds_horarios = ds_horarios_w,
				nm_usuario = nm_usuario_p,
				dt_atualizacao = clock_timestamp(),
				nr_ocorrencia = nr_ocorrencia_w,
				qt_material = coalesce(CASE WHEN nr_ocorrencia_w=0 THEN  1  ELSE nr_ocorrencia_w END  * qt_dose, 1),
				qt_total_dispensar = coalesce(CASE WHEN nr_ocorrencia_w=0 THEN  1  ELSE nr_ocorrencia_w END  * qt_dose, 1),
				ie_urgencia = ie_agora_w,
				hr_prim_horario = hr_prim_horario_w,
				ie_se_necessario = ie_se_necessario_w
			where	nr_prescricao		= nr_prescricao_w
			and	nr_seq_pe_proc		= nr_seq_item_p;	
			
			commit;
			
			exception when others then
			null;
			end;
			
		end if;
	
	end if;
	
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE atualizar_prescr_item_sae ( nr_prescr_sae_p bigint, nr_seq_item_p bigint, nm_usuario_p text) FROM PUBLIC;

