-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE agequi_gerar_consulta (cd_paciente_p text, cd_medico_p text, cd_estab_p bigint, ie_tipo_data_p bigint, ie_chegada_p bigint, ie_exibir_suspensos_p text default 'S', dt_inicial_p timestamp DEFAULT NULL, dt_final_p timestamp DEFAULT NULL, ie_status_p text DEFAULT NULL, cd_setor_realizacao_p bigint DEFAULT NULL, nr_seq_protocolo_p bigint DEFAULT NULL, nr_seq_prot_medic_p bigint DEFAULT NULL, nr_prontuario_p bigint DEFAULT NULL, ds_filtros_p text DEFAULT NULL, nm_usuario_p text DEFAULT NULL, ie_ignorar_datas_p text DEFAULT NULL, cd_estabelecimento_p bigint DEFAULT NULL, ds_estagio_status_p bigint default null) AS $body$
DECLARE


nr_seq_pend_agenda_w		qt_pendencia_agenda.nr_sequencia%type;	

dt_liberacao_w			qt_pendencia_agenda.dt_liberacao%type;
ds_tipo_pendencia_w		valor_dominio.ds_valor_dominio%type;
ie_pendencia_duplicada_w	qt_pendencia_agenda.ie_pendencia_duplicada%type;
cd_estab_pend_w			qt_pendencia_agenda.cd_estabelecimento%type;
ie_canc_agenda_w		qt_pendencia_agenda.ie_canc_agenda%type;
ds_observacao_w			qt_pendencia_agenda.ds_observacao%type;
ie_alt_enfermagem_w		qt_pendencia_agenda.ie_alt_enfermagem%type;
cd_paciente_w			qt_pendencia_agenda.cd_pessoa_fisica%type;
nr_prontuario_w			bigint;
nr_telefones_w			varchar(255);
ie_alt_medic_pend_w		qt_pendencia_agenda.ie_alt_medicamento%type;
ie_tipo_pendencia_w		qt_pendencia_agenda.ie_tipo_pendencia%type;
qt_dias_pendencia_w		bigint;	
qt_dias_w			bigint;
qt_dias_susp_medico_w		bigint;
ie_status_w			varchar(1);
nr_ordem_w			smallint;
cd_pessoa_fisica_w		pessoa_fisica.cd_pessoa_fisica%type;
nm_paciente_w			pessoa_fisica.nm_pessoa_fisica%type;
dt_nascimento_w			pessoa_fisica.dt_nascimento%type;
cd_medico_resp_w		paciente_setor.cd_medico_resp%type;
cd_protocolo_w			paciente_setor.cd_protocolo%type;
nr_seq_medicacao_w		paciente_setor.nr_seq_medicacao%type;
nr_seq_paciente_w		paciente_setor.nr_seq_paciente%type;
ie_protocolo_livre_w		paciente_setor.ie_protocolo_livre%type;
qt_tempo_agenda_w		paciente_atendimento.qt_tempo_agenda%type;
qt_tempo_medic_w		paciente_setor.qt_tempo_medic%type;
qt_dur_aplicacao_w		bigint;
qt_dias_intervalo_w		paciente_setor.qt_dias_intervalo%type;
cd_setor_realizacao_w		paciente_setor.cd_setor_atendimento%type;
nr_prescricao_w			paciente_atendimento.nr_prescricao%type;
nr_atendimento_w		paciente_atendimento.nr_atendimento%type;
ie_status_pac_setor_w			paciente_setor.ie_status%type;
ie_alt_medic_setor_w		paciente_setor.ie_alt_medicamento%type;
ds_protocolo_livre_w		paciente_setor.ds_protocolo_livre%type;
ie_agendamento_multiplo_w	paciente_setor.ie_agendamento_multiplo%type;
nr_grupo_agendamento_w		paciente_setor.nr_grupo_agendamento%type;
dt_chegada_w			timestamp;
dt_cancelamento_w		paciente_atendimento.dt_cancelamento%type;	
dt_interrompido_w		paciente_atendimento.dt_interrompido%type;

ie_inativo_w			varchar(1);
ds_convenio_w			convenio.ds_convenio%type;
nm_medico_resp_w		pessoa_fisica.nm_pessoa_fisica%type;
nr_duracao_w			bigint;
ds_protocolo_w			protocolo.nm_protocolo%type;
ds_prot_medic_w			varchar(255);
qt_marc_dia_agenda_w		smallint;
ds_estabelecimento_w		varchar(255);
ds_setor_realizacao_w		setor_atendimento.ds_setor_atendimento%type;
cd_doenca_cid_w			can_loco_regional.cd_doenca_cid%type;
ds_doenca_cid_w			varchar(255);
ie_protocolo_alt_w		varchar(1);

ds_erro_w			varchar(255);
ds_filtros_w		varchar(255);

ie_dias_pend_multi_w		varchar(1);
ie_agendado_multi_w		varchar(1);
ie_nao_agendado_multi_w		varchar(1);
ie_status_filtro_multi_w	varchar(5);
qt_commit_w			bigint := 0;
ie_mostra_inat_w		varchar(1);
qt_ciclo_susp_w		bigint;
qt_total_ciclos_w	bigint;

C01 CURSOR FOR
	SELECT	a.nr_sequencia
	from	qt_pendencia_agenda a
	where 	(((ie_ignorar_datas_p = 'N')
	and		exists(	SELECT	1
					from	paciente_atendimento x
					where	x.nr_seq_pend_agenda = a.nr_sequencia
                    and (coalesce(ds_estagio_status_p::text, '') = '' or qt_obter_cor_autor_pend(x.nr_seq_atendimento, 'N') = ds_estagio_status_p)
					and		coalesce(x.dt_real, x.dt_prevista) between trunc(dt_inicial_p) and trunc(dt_final_p) + 86399/86400
					and     ((ie_exibir_suspensos_p = 'N' and coalesce(x.dt_cancelamento::text, '') = '' and coalesce(x.dt_interrompido::text, '') = '')
					or (ie_exibir_suspensos_p = 'S'))))
	or		((ie_ignorar_datas_p = 'S')
	and		exists(	select	1  
					from	paciente_atendimento x,
							paciente_setor y
					where	x.nr_seq_pend_agenda = a.nr_sequencia
                    and (coalesce(ds_estagio_status_p::text, '') = '' or qt_obter_cor_autor_pend(x.nr_seq_atendimento, 'N') = ds_estagio_status_p)
					and		x.nr_seq_paciente = y.nr_seq_paciente
					and		((y.cd_pessoa_fisica = cd_paciente_p) or (substr(obter_prontuario_pf(cd_estabelecimento_p, obter_pf_pront(nr_prontuario_p, 'C', cd_estabelecimento_p, nm_usuario_p)),1,15) = nr_prontuario_p))
					and     ((ie_exibir_suspensos_p = 'N' and coalesce(x.dt_cancelamento::text, '') = '' and coalesce(x.dt_interrompido::text, '') = '')
					or (ie_exibir_suspensos_p = 'S')))))
	and	ie_tipo_data_p = 0
	
union

	select	a.nr_sequencia
	from	qt_pendencia_agenda a
	where 	(((ie_ignorar_datas_p = 'N')
	and		exists(	select	1  
					from	paciente_atendimento x
					where	x.nr_seq_pend_agenda = a.nr_sequencia
                    and (coalesce(ds_estagio_status_p::text, '') = '' or qt_obter_cor_autor_pend(x.nr_seq_atendimento, 'N') = ds_estagio_status_p)
					and		x.dt_real between trunc(dt_inicial_p) and trunc(dt_final_p) + 86399/86400
					and     ((ie_exibir_suspensos_p = 'N' and coalesce(x.dt_cancelamento::text, '') = '' and coalesce(x.dt_interrompido::text, '') = '')
					or (ie_exibir_suspensos_p = 'S'))))
	or		((ie_ignorar_datas_p = 'S')
	and		exists(	select	1  
					from	paciente_atendimento x,
							paciente_setor y
					where	x.nr_seq_pend_agenda = a.nr_sequencia
                    and (coalesce(ds_estagio_status_p::text, '') = '' or qt_obter_cor_autor_pend(x.nr_seq_atendimento, 'N') = ds_estagio_status_p)
					and		x.nr_seq_paciente = y.nr_seq_paciente
					and		((y.cd_pessoa_fisica = cd_paciente_p) or (substr(obter_prontuario_pf(cd_estabelecimento_p, obter_pf_pront(nr_prontuario_p, 'C', cd_estabelecimento_p, nm_usuario_p)),1,15) = nr_prontuario_p))
					and     ((ie_exibir_suspensos_p = 'N' and coalesce(x.dt_cancelamento::text, '') = '' and coalesce(x.dt_interrompido::text, '') = '')
					or (ie_exibir_suspensos_p = 'S')))))
	and	ie_tipo_data_p = 1
	
union
    
	select	a.nr_sequencia
	from	qt_pendencia_agenda a
	where 	(((ie_ignorar_datas_p = 'N')
	and		exists(	select	1  
					from	paciente_atendimento x
					where	x.nr_seq_pend_agenda = a.nr_sequencia
                    and (coalesce(ds_estagio_status_p::text, '') = '' or qt_obter_cor_autor_pend(x.nr_seq_atendimento, 'N') = ds_estagio_status_p)
					and		x.dt_prevista between trunc(dt_inicial_p) and trunc(dt_final_p) + 86399/86400
					and     ((ie_exibir_suspensos_p = 'N' and coalesce(x.dt_cancelamento::text, '') = '' and coalesce(x.dt_interrompido::text, '') = '')
					or (ie_exibir_suspensos_p = 'S'))))
	or		((ie_ignorar_datas_p = 'S')
	and		exists(	select	1  
					from	paciente_atendimento x,
							paciente_setor y
					where	x.nr_seq_pend_agenda = a.nr_sequencia
                    and (coalesce(ds_estagio_status_p::text, '') = '' or qt_obter_cor_autor_pend(x.nr_seq_atendimento, 'N') = ds_estagio_status_p)
					and		x.nr_seq_paciente = y.nr_seq_paciente
					and		((y.cd_pessoa_fisica = cd_paciente_p) or (substr(obter_prontuario_pf(cd_estabelecimento_p, obter_pf_pront(nr_prontuario_p, 'C', cd_estabelecimento_p, nm_usuario_p)),1,15) = nr_prontuario_p))
					and     ((ie_exibir_suspensos_p = 'N' and coalesce(x.dt_cancelamento::text, '') = '' and coalesce(x.dt_interrompido::text, '') = '')
					or (ie_exibir_suspensos_p = 'S')))))
	and	ie_tipo_data_p = 2
	
union

	select	a.nr_sequencia
	from	qt_pendencia_agenda a
	where 	(((ie_ignorar_datas_p = 'N')
	and		exists(	select	1
					from    paciente_setor x 
					where   x.nr_seq_paciente = (   select	max(y.nr_seq_paciente)
													from	paciente_atendimento y 
													where	y.nr_seq_pend_agenda = a.nr_sequencia
                                                    and (coalesce(ds_estagio_status_p::text, '') = '' or qt_obter_cor_autor_pend(y.nr_seq_atendimento, 'N') = ds_estagio_status_p)
													and     ((ie_exibir_suspensos_p = 'N' and coalesce(y.dt_cancelamento::text, '') = '' and coalesce(y.dt_interrompido::text, '') = '')
													or (ie_exibir_suspensos_p = 'S'))) 

	                and	x.dt_protocolo between trunc(dt_inicial_p) and trunc(dt_final_p) + 86399/86400))
	or		((ie_ignorar_datas_p = 'S')
	and		exists(	select	1  
					from	paciente_atendimento x,
							paciente_setor y
					where	x.nr_seq_pend_agenda = a.nr_sequencia
                    and (coalesce(ds_estagio_status_p::text, '') = '' or qt_obter_cor_autor_pend(x.nr_seq_atendimento, 'N') = ds_estagio_status_p)
					and		x.nr_seq_paciente = y.nr_seq_paciente
					and		((y.cd_pessoa_fisica = cd_paciente_p) or (substr(obter_prontuario_pf(cd_estabelecimento_p, obter_pf_pront(nr_prontuario_p, 'C', cd_estabelecimento_p, nm_usuario_p)),1,15) = nr_prontuario_p))
					and     ((ie_exibir_suspensos_p = 'N' and coalesce(x.dt_cancelamento::text, '') = '' and coalesce(x.dt_interrompido::text, '') = '')
					or (ie_exibir_suspensos_p = 'S')))))
	and	ie_tipo_data_p = 3;
				

BEGIN

ie_mostra_inat_w := obter_param_usuario(865, 206, obter_perfil_ativo, Wheb_usuario_pck.get_nm_usuario, wheb_usuario_pck.get_cd_estabelecimento, ie_mostra_inat_w);

delete 	FROM w_pendencia_agequi
where	nm_usuario = nm_usuario_p;
commit;

--Formatar ds_filtros_p, caso o SQL venha em uppercase
select	lower(substr(ds_filtros_p, 1, position('(' in ds_filtros_p) - 1)) || substr(ds_filtros_p, position('(' in ds_filtros_p), length(ds_filtros_p))
into STRICT	ds_filtros_w
;

open C01;
loop
fetch C01 into	
	nr_seq_pend_agenda_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	select	max(dt_liberacao),
			max(ie_tipo_pendencia),
			coalesce(max(ie_pendencia_duplicada),'N'),
			max(cd_estabelecimento),
			coalesce(max(ie_canc_agenda),'N'),
			max(substr(ds_observacao,1,255)),
			coalesce(max(ie_alt_enfermagem),'N'),
			coalesce(max(ie_alt_medicamento),'N')
	into STRICT	dt_liberacao_w,
			ie_tipo_pendencia_w,
			ie_pendencia_duplicada_w,
			cd_estab_pend_w,
			ie_canc_agenda_w,
			ds_observacao_w,
			ie_alt_enfermagem_w,		
			ie_alt_medic_pend_w
	from	qt_pendencia_agenda
	where	nr_sequencia = nr_seq_pend_agenda_w;

	
	if (cd_estab_p IS NOT NULL AND cd_estab_p::text <> '') and (cd_estab_pend_w IS NOT NULL AND cd_estab_pend_w::text <> '') and (cd_estab_pend_w <> cd_estab_p) then
		goto final;
	end if;
	
	select	max(a.cd_medico_resp),
		max(b.dt_chegada),
		max(a.cd_setor_atendimento),
		max(a.cd_protocolo),
		max(a.nr_seq_medicacao),
		max(a.cd_pessoa_fisica),		
		max(b.dt_cancelamento),
		max(b.dt_interrompido),
		max(a.nr_seq_paciente),
		max(a.ie_protocolo_livre),
		max(b.qt_tempo_agenda),
		max(a.qt_tempo_medic),
		max(qt_obter_dur_aplicacao(b.ds_dia_ciclo,a.nr_seq_medicacao,a.cd_protocolo,b.nr_seq_atendimento,coalesce(b.dt_real, b.dt_prevista),b.nr_seq_pend_agenda,b.nm_usuario,b.cd_estabelecimento)),
		max(a.qt_dias_intervalo),		
		max(b.nr_prescricao),
		max(b.nr_atendimento),
		max(a.ie_status),
		coalesce(max(a.ie_alt_medicamento),'N'),
		max(a.cd_pessoa_fisica),
		max(substr(a.ds_protocolo_livre,1,255)),
		coalesce(max(a.ie_agendamento_multiplo), 'N'),
		max(a.nr_grupo_agendamento)
	into STRICT	cd_medico_resp_w,		
		dt_chegada_w,
		cd_setor_realizacao_w,
		cd_protocolo_w,
		nr_seq_medicacao_w,
		cd_paciente_w,
		dt_cancelamento_w,
		dt_interrompido_w,
		nr_seq_paciente_w,
		ie_protocolo_livre_w,
		qt_tempo_agenda_w,
		qt_tempo_medic_w,
		qt_dur_aplicacao_w,
		qt_dias_intervalo_w,		
		nr_prescricao_w,
		nr_atendimento_w,
		ie_status_pac_setor_w,
		ie_alt_medic_setor_w,
		cd_pessoa_fisica_w,
		ds_protocolo_livre_w,
		ie_agendamento_multiplo_w,
		nr_grupo_agendamento_w
	from	paciente_setor a,
		paciente_atendimento b
	where	a.nr_seq_paciente 	= b.nr_seq_paciente	
	and	b.nr_seq_pend_agenda 	= nr_seq_pend_agenda_w  LIMIT 1;
	
	if (ie_exibir_suspensos_p = 'N') and
		((dt_cancelamento_w IS NOT NULL AND dt_cancelamento_w::text <> '') or (dt_interrompido_w IS NOT NULL AND dt_interrompido_w::text <> '')) then
		goto final;
	end if;
	
	if (cd_paciente_p IS NOT NULL AND cd_paciente_p::text <> '') and (cd_paciente_w <> cd_paciente_p) then
		goto final;
	end if;
		
	
	if (cd_medico_p IS NOT NULL AND cd_medico_p::text <> '') and (coalesce(cd_medico_resp_w,'0') <> cd_medico_p)then
		goto final;
	end if;
	
	if (cd_setor_realizacao_p IS NOT NULL AND cd_setor_realizacao_p::text <> '') and (cd_setor_realizacao_w <> cd_setor_realizacao_p) then
		goto final;
	end if;
	
	if (nr_seq_protocolo_p IS NOT NULL AND nr_seq_protocolo_p::text <> '') and (coalesce(cd_protocolo_w,0) <> nr_seq_protocolo_p) then
		goto final;
	end if;
	
	if (nr_seq_prot_medic_p IS NOT NULL AND nr_seq_prot_medic_p::text <> '') and (coalesce(nr_seq_medicacao_w,0) <> nr_seq_prot_medic_p) then
		goto final;
	end if;
	
	if (ie_chegada_p = 0) and (coalesce(dt_chegada_w::text, '') = '') then
		goto final;
	elsif (ie_chegada_p = 1) and (dt_chegada_w IS NOT NULL AND dt_chegada_w::text <> '') then
		goto final;
	end if;	
	
	select	max(substr(obter_prontuario_pf(cd_estabelecimento_p, h.cd_pessoa_fisica),1,15))	
	into STRICT	nr_prontuario_w
	from	pessoa_fisica h
	where 	h.cd_pessoa_fisica = cd_pessoa_fisica_w;

	if (nr_prontuario_p IS NOT NULL AND nr_prontuario_p::text <> '') and (nr_prontuario_w <> nr_prontuario_p) then
		goto final;
	end if;
	
	select	max(ds_valor_dominio)
	into STRICT	ds_tipo_pendencia_w
	from	valor_dominio_v
	where	cd_dominio = 3117
	and	vl_dominio = ie_tipo_pendencia_w;
	
	select	count(*)
	into STRICT	qt_dias_pendencia_w
	from	paciente_atendimento a,
		agenda_quimio b
	where	a.nr_seq_pend_agenda	= nr_seq_pend_agenda_w
	and	a.nr_Seq_Atendimento	= b.nr_Seq_Atendimento
	and	coalesce(b.ie_Status_agenda, 'X')	<> 'C'
	and	coalesce(a.dt_suspensao::text, '') = ''
	and	coalesce(a.dt_cancelamento::text, '') = ''
	and	trunc(b.dt_Agenda)	= trunc(coalesce(a.dt_prevista_agenda, coalesce(a.dt_real, a.dt_prevista)));
	
	if (qt_dias_pendencia_w	= 0) then
		ie_status_w	:= 'N';		
	else
		select	sum(CASE WHEN coalesce(dt_suspensao::text, '') = '' THEN  1  ELSE 0 END ),
				sum(CASE WHEN coalesce(dt_suspensao::text, '') = '' THEN  0  ELSE 1 END ),
				sum(CASE WHEN coalesce(dt_cancelamento::text, '') = '' THEN  0  ELSE 1 END ),
				sum(1)
		into STRICT	qt_dias_w,
				qt_dias_susp_medico_w,
				qt_ciclo_susp_w,
				qt_total_ciclos_w
		from	paciente_atendimento a
		where	a.nr_seq_pend_agenda	= nr_seq_pend_agenda_w;
		
		if (qt_dias_susp_medico_w	= qt_dias_w) or (qt_dias_pendencia_w	= qt_dias_w) or
			((qt_ciclo_susp_w + qt_dias_pendencia_w) 	= qt_total_ciclos_w) then
			ie_status_w	:= 'S';			
		elsif (qt_dias_w	> qt_dias_pendencia_w) and (qt_dias_pendencia_w	> 0) then
			ie_status_w	:= 'A';		
		elsif (qt_dias_pendencia_w = 0) then
			ie_status_w	:= 'N';			
		else
			ie_status_w	:= 'C';			
		end if;		
	end if;
	
	if (ie_status_p IS NOT NULL AND ie_status_p::text <> '') and (ie_status_w <> ie_status_p) then
		goto final;
	end if;
	
	if (ie_status_w = 'N') then
		nr_ordem_w := 1;
	elsif (ie_status_w = 'A') then
		nr_ordem_w := 2;
	else
		nr_ordem_w := 3;
	end if;
				
	if (position('and a.ie_status in' in ds_filtros_w) > 0) then
		if (position('not' in ds_filtros_w) = 0) and (position(ie_status_w in ds_filtros_w) = 0) then
			goto final;
		elsif (position('not' in ds_filtros_w) > 0) and (position(ie_status_w in ds_filtros_w) > 0) then
			goto final;
		end if;
	end if;	
		
	if (ie_status_pac_setor_w = 'I') then
		ie_inativo_w := 'S';
	else
		ie_inativo_w := 'N';
	end if;
	
	if (ie_mostra_inat_w = 'N') and (ie_inativo_w = 'S') then
		goto final;
	elsif (ie_inativo_w = 'S') and (ie_status_p IS NOT NULL AND ie_status_p::text <> '') then
		goto final;
	end if;
	
	select  max(b.ds_convenio)
	into STRICT	ds_convenio_w
	from	paciente_setor_convenio a,
		convenio b
	where	a.cd_convenio = b.cd_convenio
	and	nr_seq_paciente = nr_seq_paciente_w;
	
	select	max(nm_pessoa_fisica)
	into STRICT	nm_medico_resp_w
	from	pessoa_fisica
	where	cd_pessoa_fisica = cd_medico_resp_w;
	
  	if (qt_dur_aplicacao_w IS NOT NULL AND qt_dur_aplicacao_w::text <> '') then
  		nr_duracao_w := qt_dur_aplicacao_w;
  	elsif (qt_tempo_agenda_w IS NOT NULL AND qt_tempo_agenda_w::text <> '') then
  		nr_duracao_w := qt_tempo_agenda_w;
  	elsif (qt_tempo_medic_w IS NOT NULL AND qt_tempo_medic_w::text <> '') then
  		nr_duracao_w := qt_tempo_medic_w;
  	end if;
	
	select	max(nm_protocolo)
	into STRICT	ds_protocolo_w
	from	protocolo
	where	cd_protocolo = cd_protocolo_w;
	
  	select	max(nm_medicacao),
   	 	max(qt_marc_dia_agenda) qt_marc_dia_agenda
  	into STRICT	ds_prot_medic_w,
    		qt_marc_dia_agenda_w
	from	protocolo_medicacao
	where	cd_protocolo 	= cd_protocolo_w
	and	nr_sequencia	= nr_seq_medicacao_w;

    	if (ds_prot_medic_w IS NOT NULL AND ds_prot_medic_w::text <> '') then
      		ds_prot_medic_w := substr(ds_protocolo_w||' / '||ds_prot_medic_w,1,255);
    	end if;
	
	
	select	max(substr(coalesce(f.nm_fantasia_estab,CASE WHEN coalesce(f.ie_Razao_fantasia,'R')='R' THEN  j.ds_razao_Social WHEN coalesce(f.ie_Razao_fantasia,'R')='F' THEN  j.nm_fantasia WHEN coalesce(f.ie_Razao_fantasia,'R')='E' THEN  f.nm_fantasia_estab END ),1,255))
	into STRICT	ds_estabelecimento_w
	FROM estabelecimento f
LEFT OUTER JOIN pessoa_juridica j ON (f.cd_cgc = j.cd_cgc)
WHERE f.cd_estabelecimento = cd_estab_pend_w;
	
	select	substr(obter_desc_expressao(max(cd_exp_setor_atend),max(ds_setor_atendimento)),1,100)
	into STRICT	ds_setor_realizacao_w
	from	setor_atendimento
	where	cd_setor_atendimento = cd_setor_realizacao_w;
	
	select 	max(a.cd_doenca_cid)
	into STRICT	cd_doenca_cid_w
	from	can_loco_regional a
	where	a.cd_pessoa_fisica = cd_paciente_w
	and	a.nr_sequencia = (SELECT 	max(b.nr_sequencia)
				  from		can_loco_regional b
				  where		a.cd_pessoa_fisica = b.cd_pessoa_fisica
				  and		(b.dt_liberacao IS NOT NULL AND b.dt_liberacao::text <> ''));

	ds_doenca_cid_w := '';

	if (cd_doenca_cid_w IS NOT NULL AND cd_doenca_cid_w::text <> '') then
		ds_doenca_cid_w	:= cd_doenca_cid_w||' - '||substr(obter_desc_cid(cd_doenca_cid_w),1,255);
	end if;
	
	if (ie_alt_medic_pend_w = 'N') then
		ie_protocolo_alt_w	:= ie_alt_medic_setor_w;
	else
		ie_protocolo_alt_w	:= ie_alt_medic_pend_w;
	end if;
	
	select	max(substr(obter_nome_pf(h.cd_pessoa_fisica),1,60)),
		max(h.dt_nascimento),		
		max(substr(obter_fone_pac_agenda(h.cd_pessoa_fisica),1,255))		
	into STRICT	nm_paciente_w,
		dt_nascimento_w,		
		nr_telefones_w
	from	pessoa_fisica h
	where 	h.cd_pessoa_fisica = cd_pessoa_fisica_w;

	insert into w_pendencia_agequi(
		nr_seq_pendencia,
		ds_tipo_pendencia,
		dt_liberacao,
		ie_status,
		nr_ordem,
		nm_paciente,
		dt_nascimento,
		cd_medico_resp,
		ds_protocolo,
		qt_tempo_medic,
		nr_seq_paciente,
		ie_protocolo_livre,
		ie_pendencia_duplicada,
		ds_estabelecimento,
		ie_canc_agenda,
		nm_medico_resp,
		qt_dias_intervalo,
		ds_observacao,
		ie_alt_enfermagem,
		ds_protoc_medic,
		ds_setor_realizacao,
		ds_doenca_cid,
		nr_prontuario,
		ds_convenio,
		ie_inativo,
		nr_prescricao,
		nr_atendimento,
		cd_protocolo,
		nr_telefones,
		ie_protocolo_alt,
		cd_setor_realizacao,
		nm_usuario,
		cd_pessoa_fisica,
		ds_protocolo_livre,
		nr_seq_medicacao,
		qt_marc_dia_agenda,
		ie_agendamento_multiplo,
		nr_grupo_agendamento)
	values (nr_seq_pend_agenda_w,
		ds_tipo_pendencia_w,
		dt_liberacao_w,
		ie_status_w,
		nr_ordem_w,
		nm_paciente_w,
		dt_nascimento_w,
		cd_medico_resp_w,
		ds_protocolo_w,
		nr_duracao_w,
		nr_seq_paciente_w,
		ie_protocolo_livre_w,
		ie_pendencia_duplicada_w,
		ds_estabelecimento_w,
		ie_canc_agenda_W,
		nm_medico_resp_w,
		qt_dias_intervalo_w,
		ds_observacao_w,
		ie_alt_enfermagem_w,
		ds_prot_medic_w,
		ds_setor_realizacao_w,
		ds_doenca_cid_w,
		nr_prontuario_w,
		ds_convenio_w,
		ie_inativo_w,
		nr_prescricao_w,
		nr_atendimento_w,
		cd_protocolo_w,
		nr_telefones_w,
		ie_protocolo_alt_w,
		cd_setor_realizacao_w,
		nm_usuario_p,
		cd_pessoa_fisica_w,
		ds_protocolo_livre_w,
		nr_seq_medicacao_w,
		qt_marc_dia_agenda_w,
		ie_agendamento_multiplo_w,
		nr_grupo_agendamento_w);
	
	qt_commit_w := qt_commit_w + 1;
	
	if (coalesce(qt_commit_w,0) > 250) then
		qt_commit_w := 0;
		commit;
	end if;
	
	<<final>>
	ds_erro_w := '';
	
	end;
end loop;
close C01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE agequi_gerar_consulta (cd_paciente_p text, cd_medico_p text, cd_estab_p bigint, ie_tipo_data_p bigint, ie_chegada_p bigint, ie_exibir_suspensos_p text default 'S', dt_inicial_p timestamp DEFAULT NULL, dt_final_p timestamp DEFAULT NULL, ie_status_p text DEFAULT NULL, cd_setor_realizacao_p bigint DEFAULT NULL, nr_seq_protocolo_p bigint DEFAULT NULL, nr_seq_prot_medic_p bigint DEFAULT NULL, nr_prontuario_p bigint DEFAULT NULL, ds_filtros_p text DEFAULT NULL, nm_usuario_p text DEFAULT NULL, ie_ignorar_datas_p text DEFAULT NULL, cd_estabelecimento_p bigint DEFAULT NULL, ds_estagio_status_p bigint default null) FROM PUBLIC;

