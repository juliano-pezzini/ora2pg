-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_nome_arquivo_laudo ( nr_seq_proc_p bigint, nr_prescricao_p bigint, dir_padrao_p text, nm_usuario_p text, cd_estabelecimento_p bigint, ds_arquivo_p INOUT text, ds_arquivo_dir_p INOUT text) AS $body$
DECLARE


cd_pf_prescricao_w	varchar(10):= '';
ds_caminho_pdf_w		varchar(1000) := '';
cd_procedimento_w	bigint;
ie_origem_proced_w	varchar(10):= '';
cd_tipo_proced_w		smallint;
ds_sigla_w		varchar(100) := '';
ds_arquivo_w		varchar(200) := '';
ds_arquivo_dir_w		varchar(200) := '';


BEGIN

ds_caminho_pdf_w := obter_param_usuario(28, 141, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ds_caminho_pdf_w);

if (ds_caminho_pdf_w <> '') then
	begin
	select	cd_procedimento
	into STRICT	cd_procedimento_w
	from	procedimento_paciente
	where	nr_sequencia = nr_seq_proc_p;

	select	ie_origem_proced
	into STRICT	ie_origem_proced_w
	from	procedimento_paciente
	where	nr_sequencia = cd_procedimento_w;

	select	cd_tipo_procedimento
	into STRICT	cd_tipo_proced_w
	from	procedimento
	where	cd_procedimento = cd_procedimento_w
	and	ie_origem_proced = ie_origem_proced_w;

	ds_sigla_w := obter_regra_proc_sigla(cd_procedimento_w,ie_origem_proced_w,cd_tipo_proced_w);

	select	cd_pessoa_fisica
	into STRICT	cd_pf_prescricao_w
	from	prescr_medica
	where	nr_prescricao = nr_prescricao_p;


	if (ds_sigla_w <> '') then
		begin
		ds_arquivo_w :=  ds_caminho_pdf_w ||'\'|| ds_sigla_w ||''|| cd_pf_prescricao_w ||'_'|| nr_prescricao_p ||'.pdf';
		end;
	else
		begin
		ds_arquivo_dir_w :=  dir_padrao_p||'\'|| ds_sigla_w ||cd_pf_prescricao_w||'_'||nr_prescricao_p||'_.pdf';
		end;
	end if;


	end;
end if;

ds_arquivo_p := ds_arquivo_w;
ds_arquivo_dir_p := ds_arquivo_dir_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_nome_arquivo_laudo ( nr_seq_proc_p bigint, nr_prescricao_p bigint, dir_padrao_p text, nm_usuario_p text, cd_estabelecimento_p bigint, ds_arquivo_p INOUT text, ds_arquivo_dir_p INOUT text) FROM PUBLIC;

