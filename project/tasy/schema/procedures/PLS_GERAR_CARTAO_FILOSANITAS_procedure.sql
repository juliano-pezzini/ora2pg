-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_gerar_cartao_filosanitas ( nr_seq_lote_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) AS $body$
DECLARE

 
--Váriaveis 
cd_us_plano_mascara_w	varchar(250);
cd_usuario_plano_w	pls_segurado_carteira.cd_usuario_plano%type;
nm_estipulante_w	varchar(250);
nm_pessoa_fisica	pessoa_fisica.nm_pessoa_fisica%type;
dt_nascimento_w		varchar(250);
nm_acomodacao_w		varchar(250);
nm_contratacao_w	varchar(250);
nr_via_solicitacao_w	pls_segurado_carteira.nr_via_solicitacao%type;
nr_fixo_w		varchar(250) := '01'; -- Valor fixo para todos os bneficiários. 
cd_contador_w		varchar(250);

C01 CURSOR FOR 
	SELECT	b.nr_sequencia 
	from	pls_segurado_carteira	a, 
		pls_segurado		b, 
		pls_carteira_emissao	c, 
		pls_lote_carteira	d 
	where	a.nr_seq_segurado	= b.nr_sequencia 
	and	c.nr_seq_seg_carteira	= a.nr_sequencia 
	and	c.nr_seq_lote		= d.nr_sequencia 
	and	d.nr_sequencia		= nr_seq_lote_p;

BEGIN 
 
delete	FROM w_pls_interface_carteira 
where	nr_seq_lote	= nr_seq_lote_p;
 
for r_c01_w in C01 loop 
	begin 
	select	pls_obter_carteira_mascara(max(b.nr_sequencia)), 
		max(a.nm_pessoa_fisica), 
		CASE WHEN max(d.ie_tipo_contratacao)='I' THEN ''  ELSE pls_obter_dados_segurado(max(b.nr_sequencia),'ES') END , 
		to_char(max(a.dt_nascimento),'dd/mm/yyyy'), 
		CASE WHEN max(d.ie_tipo_contratacao)='I' THEN 'Familiar'  ELSE 'Empresarial' END , 
		'Enfermaria', 
		max(c.cd_usuario_plano), 
		coalesce(max(c.nr_via_solicitacao),0) 
	into STRICT	cd_us_plano_mascara_w, 
		nm_pessoa_fisica, 
		nm_estipulante_w, 
		dt_nascimento_w, 
		nm_contratacao_w, 
		nm_acomodacao_w, 
		cd_usuario_plano_w, 
		nr_via_solicitacao_w 
	from	pls_segurado_carteira	c, 
		pessoa_fisica		a, 
		pls_plano		d, 
		pls_segurado		b 
	where	c.nr_seq_segurado	= b.nr_sequencia 
	and	b.nr_seq_plano		= d.nr_sequencia 
	and	b.cd_pessoa_fisica	= a.cd_pessoa_fisica 
	and	b.nr_sequencia		= r_c01_w.nr_sequencia;
	 
	cd_contador_w := C01%rowCount;
	 
	insert into w_pls_interface_carteira(	nr_sequencia,dt_atualizacao,nm_usuario,nr_registro, 
			ds_observacao,nm_beneficiario, ds_estipulante, ds_dt_carencia, ds_abrangencia, 
			ds_acomodacao, cd_usuario_plano, nr_via_cartao, nr_seq_lote, ds_observacao_2) 
	values (	nextval('w_pls_interface_carteira_seq'),clock_timestamp(),nm_usuario_p, cd_contador_w, 
			cd_us_plano_mascara_w,nm_pessoa_fisica,nm_estipulante_w, dt_nascimento_w, nm_contratacao_w, 
			nm_acomodacao_w,cd_usuario_plano_w, nr_via_solicitacao_w, nr_seq_lote_p, nr_fixo_w);
	end;
end loop;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_gerar_cartao_filosanitas ( nr_seq_lote_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) FROM PUBLIC;

