-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_vincular_contas_pag_prod ( nr_seq_lote_pag_p pls_lote_pagamento.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type) AS $body$
DECLARE


ds_sql_w	varchar(32000);
ds_rest_w	varchar(15000);
ds_rest_cm_w	varchar(5000);
ds_rest_rg_it_w	varchar(5000);
ds_rest_rg_w	varchar(5000);
valor_bind_w	sql_pck.t_dado_bind;
cursor_w	sql_pck.t_cursor;

tb_nr_seq_conta_w	pls_util_cta_pck.t_number_table;
tb_nr_seq_conta_res_w	pls_util_cta_pck.t_number_table;
tb_ie_origem_w		pls_util_cta_pck.t_varchar2_table_10;

dt_mes_competencia_w		pls_lote_pagamento.dt_mes_competencia%type;
nr_seq_periodo_w		pls_lote_pagamento.nr_seq_periodo%type;
dt_fim_comp_w			pls_lote_pagamento.dt_fim_comp%type;
cd_estabelecimento_w		estabelecimento.cd_estabelecimento%type;
dt_mes_competencia_fim_w 	pls_lote_pagamento.dt_mes_competencia%type;
dt_inicio_comp_w		pls_lote_pagamento.dt_inicio_comp%type;
dt_mes_competencia_prot_w	pls_lote_pagamento.dt_mes_competencia_prot%type;
dt_mes_competencia_prot_fim_w	pls_lote_pagamento.dt_mes_competencia_prot%type;
ie_forma_pagamento_w		pls_parametro_pagamento.ie_forma_pagamento%type;
ie_prot_sem_pagto_w		pls_parametro_pagamento.ie_prot_sem_pagto%type;
dt_inicio_lib_pagamento_w	pls_lote_pagamento.dt_lib_pag_prot_inicial%type;
dt_fim_lib_pagamento_w		pls_lote_pagamento.dt_lib_pag_prot_final%type;
ie_analise_fechada_w		pls_parametro_pagamento.ie_analise_fechada%type;
ie_gerar_pgto_ajust_fat_w	pls_parametro_pagamento.ie_gerar_pgto_ajust_fat%type;

c01 CURSOR( nr_seq_periodo_cp	pls_periodo_pagamento.nr_sequencia%type) FOR
	SELECT	a.nr_seq_prestador,
		a.ie_tipo_guia,
		a.dt_inicio_vigencia,
		a.dt_fim_vigencia,
		a.qt_mes_deslocamento,
		a.nr_seq_tipo_prestador,
		a.nr_seq_classif_prestador,
		a.ie_conta_intercambio,
		a.nr_seq_contrato,
		a.nr_seq_plano,
		a.nr_seq_grupo_contrato,
		a.qt_mes_desloc_final,
		a.nr_seq_tipo_prest_prot,
		a.ie_apresentacao_prot,
		a.ie_origem_conta,
		a.cd_condicao_pagamento,
		coalesce(a.ie_tipo_pessoa_prest, 'A') ie_tipo_pessoa_prest,
		coalesce(a.ie_tipo_evento,'N') ie_tipo_evento,
		a.nr_seq_evento,
		coalesce(a.ie_profissional_exec, 'N') ie_profissional_exec
	from	pls_evento_regra a
	where	a.nr_seq_periodo = nr_seq_periodo_cp
	and	a.ie_situacao = 'A'
	and	coalesce(a.ie_incide_periodo, 'S') = 'S'
	and	dt_mes_competencia_w between a.dt_inicio_vigencia and coalesce(a.dt_fim_vigencia, dt_mes_competencia_w);

BEGIN

EXECUTE 'truncate table w_pls_conta_pag_prod';

select	nr_seq_periodo,
	trunc(dt_mes_competencia,'month'),
	fim_dia(last_day(dt_mes_competencia)),
	trunc(dt_inicio_comp,'dd'),
	fim_dia(dt_fim_comp),
	cd_estabelecimento,
	trunc(dt_mes_competencia_prot,'month'),
	fim_dia(last_day(dt_mes_competencia_prot)),
	trunc(dt_lib_pag_prot_inicial,'dd'),
	trunc(dt_lib_pag_prot_final,'dd')
into STRICT	nr_seq_periodo_w,
	dt_mes_competencia_w,
	dt_mes_competencia_fim_w,
	dt_inicio_comp_w,
	dt_fim_comp_w,
	cd_estabelecimento_w,
	dt_mes_competencia_prot_w,
	dt_mes_competencia_prot_fim_w,
	dt_inicio_lib_pagamento_w,
	dt_fim_lib_pagamento_w
from	pls_lote_pagamento
where	nr_sequencia = nr_seq_lote_pag_p;

select	coalesce(max(ie_forma_pagamento),'P'),
	coalesce(max(ie_prot_sem_pagto),'N'),
	coalesce(max(ie_analise_fechada),'N'),
	coalesce(max(ie_gerar_pgto_ajust_fat),'N')
into STRICT	ie_forma_pagamento_w,
	ie_prot_sem_pagto_w,
	ie_analise_fechada_w,
	ie_gerar_pgto_ajust_fat_w
from	pls_parametro_pagamento
where	cd_estabelecimento = cd_estabelecimento_w;

for	r_c01_w in c01(nr_seq_periodo_w) loop

	ds_rest_w := ''; -- filtros em comum
	ds_rest_cm_w := null; -- filtros conta medicas
	ds_rest_rg_it_w := ''; -- filtros recurso item
	ds_rest_rg_w := ''; -- filtros recurso

	--	Filtros de prestadores
	if (r_c01_w.nr_seq_prestador IS NOT NULL AND r_c01_w.nr_seq_prestador::text <> '') then

		ds_rest_w := ds_rest_w || ' and	prest.nr_sequencia = :nr_seq_prestador ' || pls_util_pck.enter_w;
		valor_bind_w := sql_pck.bind_variable(	':nr_seq_prestador', r_c01_w.nr_seq_prestador, valor_bind_w);
	end if;

	if (r_c01_w.nr_seq_classif_prestador IS NOT NULL AND r_c01_w.nr_seq_classif_prestador::text <> '') then

		ds_rest_w := ds_rest_w || ' and	prest.nr_seq_classificacao = :nr_seq_classif_prestador ' || pls_util_pck.enter_w;
		valor_bind_w := sql_pck.bind_variable(	':nr_seq_classif_prestador', r_c01_w.nr_seq_classif_prestador, valor_bind_w);
	end if;

	if (r_c01_w.nr_seq_tipo_prestador IS NOT NULL AND r_c01_w.nr_seq_tipo_prestador::text <> '') then

		ds_rest_w := ds_rest_w || ' and exists(	select	1 ' || pls_util_pck.enter_w ||
					'		from	pls_prestador p ' || pls_util_pck.enter_w ||
					'		where	p.nr_sequencia = a.nr_seq_prestador_pgto ' || pls_util_pck.enter_w ||
					'		and	p.nr_seq_tipo_prestador = :nr_seq_tipo_prestador ' || pls_util_pck.enter_w ||
					'		union all ' || pls_util_pck.enter_w ||
					'		select 	1 ' || pls_util_pck.enter_w ||
					'		from	pls_prestador_tipo tipo ' || pls_util_pck.enter_w ||
					'		where	tipo.nr_seq_prestador = a.nr_seq_prestador_pgto ' || pls_util_pck.enter_w ||
					'		and	tipo.nr_seq_tipo = :nr_seq_tipo_prestador ' || pls_util_pck.enter_w ||
					'		and	sysdate between tipo.dt_inicio_vigencia and tipo.dt_fim_vigencia_ref) ' || pls_util_pck.enter_w;
		valor_bind_w := sql_pck.bind_variable(	':nr_seq_tipo_prestador', r_c01_w.nr_seq_tipo_prestador, valor_bind_w);
	end if;

	if (r_c01_w.nr_seq_tipo_prest_prot IS NOT NULL AND r_c01_w.nr_seq_tipo_prest_prot::text <> '') then

		ds_rest_cm_w := ds_rest_cm_w || ' and	exists	(select	1 ' || pls_util_pck.enter_w ||
						'		from	pls_prestador_tipo y ' || pls_util_pck.enter_w ||
						'		where	y.nr_seq_prestador = prot.nr_seq_prestador ' || pls_util_pck.enter_w ||
						'		and	y.nr_seq_tipo = :nr_seq_tipo_prest_prot ' || pls_util_pck.enter_w ||
						'		and	prot.dt_mes_competencia between y.dt_inicio_vigencia_ref and y.dt_fim_vigencia_ref '|| pls_util_pck.enter_w ||
						'		union all ' || pls_util_pck.enter_w ||
						'		select	1 ' || pls_util_pck.enter_w ||
						'		from	pls_prestador y ' || pls_util_pck.enter_w ||
						'		where	y.nr_sequencia = prot.nr_seq_prestador ' || pls_util_pck.enter_w ||
						'		and	y.nr_seq_tipo_prestador = :nr_seq_tipo_prest_prot) ' || pls_util_pck.enter_w ||
						' and	prot.ie_status != ''4'' ' || pls_util_pck.enter_w;

		ds_rest_rg_it_w := ds_rest_rg_it_w || ' and	exists	(select	1 ' || pls_util_pck.enter_w ||
						'		from	pls_prestador_tipo y ' || pls_util_pck.enter_w ||
						'		where	y.nr_seq_prestador = prot.nr_seq_prestador ' || pls_util_pck.enter_w ||
						'		and	y.nr_seq_tipo = :nr_seq_tipo_prest_prot ' || pls_util_pck.enter_w ||
						'		and	prot.dt_mes_competencia between y.dt_inicio_vigencia_ref and y.dt_fim_vigencia_ref '|| pls_util_pck.enter_w ||
						'		union all ' || pls_util_pck.enter_w ||
						'		select	1 ' || pls_util_pck.enter_w ||
						'		from	pls_prestador y ' || pls_util_pck.enter_w ||
						'		where	y.nr_sequencia = prot.nr_seq_prestador ' || pls_util_pck.enter_w ||
						'		and	y.nr_seq_tipo_prestador = :nr_seq_tipo_prest_prot) ' || pls_util_pck.enter_w ||
						' and	prot.ie_status != ''4'' ' || pls_util_pck.enter_w;

		ds_rest_rg_w := ds_rest_rg_w || ' and	exists	(select	1 ' || pls_util_pck.enter_w ||
						'		from	pls_prestador_tipo y ' || pls_util_pck.enter_w ||
						'		where	y.nr_seq_prestador = prot.nr_seq_prestador ' || pls_util_pck.enter_w ||
						'		and	y.nr_seq_tipo = :nr_seq_tipo_prest_prot ' || pls_util_pck.enter_w ||
						'		and	prot.dt_apresentacao_lote between y.dt_inicio_vigencia_ref and y.dt_fim_vigencia_ref '|| pls_util_pck.enter_w ||
						'		union all ' || pls_util_pck.enter_w ||
						'		select	1 ' || pls_util_pck.enter_w ||
						'		from	pls_prestador y ' || pls_util_pck.enter_w ||
						'		where	y.nr_sequencia = prot.nr_seq_prestador ' || pls_util_pck.enter_w ||
						'		and	y.nr_seq_tipo_prestador = :nr_seq_tipo_prest_prot) ' || pls_util_pck.enter_w ||
						' and	prot.ie_status != ''4'' ' || pls_util_pck.enter_w;
		valor_bind_w := sql_pck.bind_variable(	':nr_seq_tipo_prest_prot', r_c01_w.nr_seq_tipo_prest_prot, valor_bind_w);
	end if;

	if (r_c01_w.cd_condicao_pagamento IS NOT NULL AND r_c01_w.cd_condicao_pagamento::text <> '') then

		ds_rest_w := ds_rest_w || ' and exists(	select	1 ' || pls_util_pck.enter_w ||
					'		from	pls_prestador_pagto y ' || pls_util_pck.enter_w ||
					'		where	y.nr_seq_prestador = prest.nr_sequencia ' || pls_util_pck.enter_w ||
					'		and	sysdate between y.dt_inicio_vigencia_ref and y.dt_fim_vigencia_ref ' || pls_util_pck.enter_w ||
					'		and	y.cd_condicao_pagamento = :cd_condicao_pagamento) ' || pls_util_pck.enter_w;

		valor_bind_w := sql_pck.bind_variable(	':cd_condicao_pagamento', r_c01_w.cd_condicao_pagamento, valor_bind_w);
	end if;

	if (r_c01_w.ie_tipo_pessoa_prest = 'PJ') then

		ds_rest_w := ds_rest_w || ' and	prest.cd_cgc is not null ' || pls_util_pck.enter_w;

	elsif (r_c01_w.ie_tipo_pessoa_prest = 'PF') then

		ds_rest_w := ds_rest_w || ' and	prest.cd_pessoa_fisica is not null ' || pls_util_pck.enter_w;
	end if;
	-- Fim filtro prestador


	-- Filtros de conta
	if (r_c01_w.ie_conta_intercambio = 'N') then

		ds_rest_w := ds_rest_w || ' and nvl(b.ie_tipo_conta,''N'') = ''O'' ' || pls_util_pck.enter_w;

	elsif (r_c01_w.ie_conta_intercambio = 'I') then

		ds_rest_w := ds_rest_w || ' and	nvl(b.ie_tipo_conta,''N'') in (''I'',''C'') ' || pls_util_pck.enter_w;
	end if;

	if (r_c01_w.ie_origem_conta IS NOT NULL AND r_c01_w.ie_origem_conta::text <> '') then

		ds_rest_w := ds_rest_w || ' and	b.ie_origem_conta = :ie_origem_conta ' || pls_util_pck.enter_w;
		valor_bind_w := sql_pck.bind_variable(	':ie_origem_conta', r_c01_w.ie_origem_conta, valor_bind_w);
	end if;
	-- Fim filtros conta


	-- Filtros do beneficiario
	if (r_c01_w.nr_seq_grupo_contrato IS NOT NULL AND r_c01_w.nr_seq_grupo_contrato::text <> '') then

		ds_rest_w := ds_rest_w || ' and exists(	select	1 ' || pls_util_pck.enter_w ||
					'		from	pls_preco_contrato z ' || pls_util_pck.enter_w ||
					'		where	z.nr_seq_contrato = seg.nr_seq_contrato ' || pls_util_pck.enter_w ||
					'		and	z.nr_seq_grupo = :nr_seq_grupo_contrato ' || pls_util_pck.enter_w ||
					'		union all ' || pls_util_pck.enter_w ||
					'		select	1 ' || pls_util_pck.enter_w ||
					'		from	pls_preco_contrato z ' || pls_util_pck.enter_w ||
					'		where	z.nr_seq_intercambio = seg.nr_seq_intercambio ' || pls_util_pck.enter_w ||
					'		and	z.nr_seq_grupo = :nr_seq_grupo_contrato) ' || pls_util_pck.enter_w;
		valor_bind_w := sql_pck.bind_variable(	':nr_seq_grupo_contrato', r_c01_w.nr_seq_grupo_contrato, valor_bind_w);
	end if;

	if (r_c01_w.nr_seq_contrato IS NOT NULL AND r_c01_w.nr_seq_contrato::text <> '') then

		ds_rest_w := ds_rest_w || ' and seg.nr_seq_contrato = :nr_seq_contrato ' || pls_util_pck.enter_w;
		valor_bind_w := sql_pck.bind_variable(	':nr_seq_contrato', r_c01_w.nr_seq_contrato, valor_bind_w);
	end if;

	if (r_c01_w.nr_seq_plano IS NOT NULL AND r_c01_w.nr_seq_plano::text <> '') then

		ds_rest_w := ds_rest_w || ' and	seg.nr_seq_plano = :nr_seq_plano ' || pls_util_pck.enter_w;
		valor_bind_w := sql_pck.bind_variable(	':nr_seq_plano', r_c01_w.nr_seq_plano, valor_bind_w);
	end if;
	-- Fim filtros beneficiario


	-- Filtros protocolo
	if (r_c01_w.ie_apresentacao_prot != 'T') then

		-- Para recurso de glosa nao precisa de restricao
		ds_rest_cm_w := ds_rest_cm_w || ' and	prot.ie_apresentacao = :ie_apresentacao_prot ' || pls_util_pck.enter_w;

		ds_rest_rg_it_w := ds_rest_rg_it_w || ' and	prot.ie_apresentacao = :ie_apresentacao_prot ' || pls_util_pck.enter_w;
		valor_bind_w := sql_pck.bind_variable(	':ie_apresentacao_prot', r_c01_w.ie_apresentacao_prot, valor_bind_w);

		if (ie_prot_sem_pagto_w = 'N')	then

			ds_rest_w := ds_rest_w || ' and	prot.ie_status <> ''4'' ' || pls_util_pck.enter_w;
		end if;
	end if;

	if (dt_mes_competencia_prot_w IS NOT NULL AND dt_mes_competencia_prot_w::text <> '') then

		ds_rest_cm_w := ds_rest_cm_w || ' and prot.dt_mes_competencia between :dt_mes_competencia_prot ' || pls_util_pck.enter_w ||
									' and nvl(:dt_mes_competencia_prot_fim, prot.dt_mes_competencia) ' || pls_util_pck.enter_w;

		ds_rest_rg_it_w := ds_rest_rg_it_w || ' and prot.dt_mes_competencia between :dt_mes_competencia_prot ' || pls_util_pck.enter_w ||
									' and nvl(:dt_mes_competencia_prot_fim, prot.dt_mes_competencia) ' || pls_util_pck.enter_w;

		ds_rest_rg_w := ds_rest_rg_w || ' and prot.dt_apresentacao_lote between :dt_mes_competencia_prot ' || pls_util_pck.enter_w ||
									' and nvl(:dt_mes_competencia_prot_fim, prot.dt_apresentacao_lote) ' || pls_util_pck.enter_w;

		valor_bind_w := sql_pck.bind_variable( ':dt_mes_competencia_prot', dt_mes_competencia_prot_w, valor_bind_w, sql_pck.b_data_hora);
		valor_bind_w := sql_pck.bind_variable( ':dt_mes_competencia_prot_fim', dt_mes_competencia_prot_fim_w, valor_bind_w, sql_pck.b_data_hora);
	end if;
	-- Fim filtros protocolo


	-- demais filtros
	if (ie_forma_pagamento_w = 'P') then

		if (ie_prot_sem_pagto_w = 'N') then

			ds_rest_cm_w := ds_rest_cm_w || ' and 	a.ie_status_protocolo = ''3'' ' || pls_util_pck.enter_w;

			ds_rest_rg_it_w := ds_rest_rg_it_w || ' and 	a.ie_status_protocolo = ''3'' ' || pls_util_pck.enter_w;

			ds_rest_rg_w := ds_rest_rg_w || ' and 	prot.ie_status	= ''3'' ' || pls_util_pck.enter_w;
		else
			ds_rest_cm_w := ds_rest_cm_w || ' and 	a.ie_status_protocolo in (''3'',''4'') ' || pls_util_pck.enter_w;

			ds_rest_rg_it_w := ds_rest_rg_it_w || ' and 	a.ie_status_protocolo in (''3'',''4'') ' || pls_util_pck.enter_w;

			ds_rest_rg_w := ds_rest_rg_w || ' and 	prot.ie_status in (''3'',''4'') ' || pls_util_pck.enter_w;
		end if;

	elsif (ie_forma_pagamento_w = 'C') then

		ds_rest_cm_w := ds_rest_cm_w || ' and	a.ie_status = ''F'' ' || pls_util_pck.enter_w ||
						' and	b.ie_status = ''F'' ' || pls_util_pck.enter_w;

		ds_rest_rg_it_w := ds_rest_rg_it_w || ' and	a.ie_status = ''F'' ' || pls_util_pck.enter_w ||
							' and	b.ie_status = ''F'' ' || pls_util_pck.enter_w;

		ds_rest_rg_w := ds_rest_rg_w || ' and	e.ie_status = ''2'' ' || pls_util_pck.enter_w;
	end if;

	if (dt_inicio_lib_pagamento_w IS NOT NULL AND dt_inicio_lib_pagamento_w::text <> '') or (dt_fim_lib_pagamento_w IS NOT NULL AND dt_fim_lib_pagamento_w::text <> '') then

		ds_rest_cm_w := ds_rest_cm_w || ' and	prot.dt_lib_pagamento between trunc(nvl(:dt_inicio_lib_pagamento, prot.dt_lib_pagamento)) ' ||
										' and fim_dia(nvl(:dt_fim_lib_pagamento, prot.dt_lib_pagamento)) ' || pls_util_pck.enter_w;

		ds_rest_rg_it_w :=  ds_rest_rg_it_w || ' and	b.dt_liberacao_pag between trunc(nvl(:dt_inicio_lib_pagamento, b.dt_liberacao_pag)) ' ||
											' and fim_dia(nvl(:dt_fim_lib_pagamento, b.dt_liberacao_pag)) ' || pls_util_pck.enter_w;

		ds_rest_rg_w := ds_rest_rg_w || ' and	prot.dt_liberacao_pag between trunc(nvl(:dt_inicio_lib_pagamento,prot.dt_liberacao_pag)) ' ||
											' and fim_dia(nvl(:dt_fim_lib_pagamento,prot.dt_liberacao_pag)) ' || pls_util_pck.enter_w;

		valor_bind_w := sql_pck.bind_variable( ':dt_inicio_lib_pagamento', dt_inicio_lib_pagamento_w, valor_bind_w, sql_pck.b_data_hora);
		valor_bind_w := sql_pck.bind_variable( ':dt_fim_lib_pagamento', dt_fim_lib_pagamento_w, valor_bind_w, sql_pck.b_data_hora);
	end if;

	if (dt_inicio_comp_w IS NOT NULL AND dt_inicio_comp_w::text <> '') or (dt_fim_comp_w IS NOT NULL AND dt_fim_comp_w::text <> '') then

		ds_rest_cm_w := ds_rest_cm_w || ' and	a.dt_competencia_pgto between nvl(:dt_inicio_comp, a.dt_competencia_pgto) ' ||
							' and nvl(:dt_fim_comp, a.dt_competencia_pgto) ' || pls_util_pck.enter_w;

		ds_rest_rg_it_w := ds_rest_rg_it_w || ' and	b.dt_competencia_lote between nvl(:dt_inicio_comp,b.dt_competencia_lote) ' ||
											' and nvl(:dt_fim_comp,b.dt_competencia_lote)  ' || pls_util_pck.enter_w;

		ds_rest_rg_w := ds_rest_rg_w ||  ' and	a.dt_competencia_pgto between nvl(:dt_inicio_comp,a.dt_competencia_pgto) ' ||
										' and nvl(:dt_fim_comp,a.dt_competencia_pgto)  ' || pls_util_pck.enter_w;

		valor_bind_w := sql_pck.bind_variable( ':dt_inicio_comp', dt_inicio_comp_w, valor_bind_w, sql_pck.b_data_hora);
		valor_bind_w := sql_pck.bind_variable( ':dt_fim_comp', dt_fim_comp_w, valor_bind_w, sql_pck.b_data_hora);
	end if;

	if (ie_analise_fechada_w = 'S') then
		ds_rest_w := ds_rest_w || ' and not exists(	select	1 ' || pls_util_pck.enter_w ||
					'			from	pls_analise_conta x ' || pls_util_pck.enter_w ||
					'			where	x.nr_sequencia = b.nr_seq_analise ' || pls_util_pck.enter_w ||
					'			and	x.ie_status not in (''T'',''C'')) ' || pls_util_pck.enter_w;
					
		
	end if;
	
	-- Nao incluir contas que pertencem a um lote de analise que esta com falha na analise (X), ou esta aguardando guia (G)
	ds_rest_w := ds_rest_w || ' and not exists(	select	1 ' || pls_util_pck.enter_w ||
			'			from	pls_analise_conta 		x, ' || pls_util_pck.enter_w ||
			'				pls_lote_protocolo_conta	y ' || pls_util_pck.enter_w ||
			'			where	x.nr_sequencia	= b.nr_seq_analise ' || pls_util_pck.enter_w ||
			'			and	y.nr_sequencia	= x.nr_seq_lote_protocolo ' || pls_util_pck.enter_w ||
			'			and	y.ie_status in (''X'', ''G'')) ' || pls_util_pck.enter_w;

	if (r_c01_w.nr_seq_evento IS NOT NULL AND r_c01_w.nr_seq_evento::text <> '') then
		ds_rest_cm_w := ds_rest_cm_w || ' and	a.nr_seq_evento = :nr_seq_evento ' || pls_util_pck.enter_w;

		ds_rest_rg_it_w := ds_rest_rg_it_w || ' and	b.nr_seq_evento = :nr_seq_evento ' || pls_util_pck.enter_w;

		ds_rest_rg_w := ds_rest_rg_w || ' and	a.nr_seq_evento = :nr_seq_evento ' || pls_util_pck.enter_w;

		valor_bind_w := sql_pck.bind_variable( ':nr_seq_evento', r_c01_w.nr_seq_evento, valor_bind_w);
		--Para o recurso de glosa nao deve buscar do alias da conta medica resumo
	end if;

	-- Tipo evento
	if (r_c01_w.ie_tipo_evento <> 'N') then -- Producao medica
		ds_rest_cm_w := ds_rest_cm_w || ' and exists(	select	1 ' || pls_util_pck.enter_w ||
						'		from	pls_evento z ' || pls_util_pck.enter_w ||
						'		where	z.nr_sequencia = a.nr_seq_evento ' || pls_util_pck.enter_w ||
						'		and	z.ie_tipo_evento = :ie_tipo_evento) ' || pls_util_pck.enter_w;

		ds_rest_rg_it_w := ds_rest_rg_it_w || 	' and exists(	select	1 ' || pls_util_pck.enter_w ||
							'		from	pls_evento z ' || pls_util_pck.enter_w ||
							'		where	z.nr_sequencia = b.nr_seq_evento ' || pls_util_pck.enter_w ||
							'		and	z.ie_tipo_evento = :ie_tipo_evento) ' || pls_util_pck.enter_w;

		ds_rest_rg_w := ds_rest_rg_w || ' and exists(	select	1 ' || pls_util_pck.enter_w ||
						'		from	pls_evento z ' || pls_util_pck.enter_w ||
						'		where	z.nr_sequencia = a.nr_seq_evento ' || pls_util_pck.enter_w ||
						'		and	z.ie_tipo_evento = :ie_tipo_evento) ' || pls_util_pck.enter_w;
		valor_bind_w := sql_pck.bind_variable( ':ie_tipo_evento', r_c01_w.ie_tipo_evento, valor_bind_w);
	end if;
	-- fim do filtros
	if (cd_estabelecimento_w IS NOT NULL AND cd_estabelecimento_w::text <> '') then
	
		ds_rest_cm_w := ds_rest_cm_w || ' and b.cd_estabelecimento = :cd_estabelecimento ' || pls_util_pck.enter_w;

		ds_rest_rg_it_w := ds_rest_rg_it_w || ' and b.cd_estabelecimento = :cd_estabelecimento ' || pls_util_pck.enter_w;

		ds_rest_rg_w := ds_rest_rg_w || ' and b.cd_estabelecimento = :cd_estabelecimento ' || pls_util_pck.enter_w;

		valor_bind_w := sql_pck.bind_variable( ':cd_estabelecimento', cd_estabelecimento_w, valor_bind_w);
	end if;

	-- sem profissional executor
	if (r_c01_w.ie_profissional_exec = 'S') then

		ds_rest_cm_w := ds_rest_cm_w || ' and a.cd_pessoa_fisica is null ' || pls_util_pck.enter_w;
	-- com
	elsif (r_c01_w.ie_profissional_exec = 'P') then

		ds_rest_cm_w := ds_rest_cm_w || ' and a.cd_pessoa_fisica is not null ' || pls_util_pck.enter_w;
	end if;
	
	-- Verifica se o Informar se o pagamento medico pode ser gerado com contas em ajuste de refaturamento com o valor necessita ajuste.
	if (ie_gerar_pgto_ajust_fat_w = 'N') then
		ds_rest_cm_w := ds_rest_cm_w ||	' and not exists (	select	1 ' || pls_util_pck.enter_w ||
						'			from	pls_ajuste_fatura_conta x ' || pls_util_pck.enter_w ||
						'			where	x.nr_seq_conta	= a.nr_seq_conta ' || pls_util_pck.enter_w ||
						'			and	x.ie_status	= ''N'') ' || pls_util_pck.enter_w;
	end if;
	
	--Select das contas medicas
	ds_sql_w := ' select	a.nr_seq_conta, ' || pls_util_pck.enter_w ||
		'		a.nr_sequencia, ' || pls_util_pck.enter_w ||
		'		''CM'' ie_origem ' || pls_util_pck.enter_w ||
		' from		pls_protocolo_conta prot, ' || pls_util_pck.enter_w ||
		'		pls_conta b, ' || pls_util_pck.enter_w ||
		'		pls_conta_medica_resumo	a, ' ||  pls_util_pck.enter_w ||
		'		pls_prestador prest, ' ||  pls_util_pck.enter_w ||
		'		pls_segurado seg ' ||  pls_util_pck.enter_w ||
		' where		a.nr_seq_conta = b.nr_sequencia ' || pls_util_pck.enter_w ||
		' and		b.nr_seq_protocolo = prot.nr_sequencia ' || pls_util_pck.enter_w ||
		' and		a.nr_seq_lote_pgto is null ' || pls_util_pck.enter_w ||
		' and		((a.ie_situacao != ''I'') or (a.ie_situacao is null)) ' || pls_util_pck.enter_w ||
		' and		prest.nr_sequencia = a.nr_seq_prestador_pgto ' ||  pls_util_pck.enter_w ||
		' and		seg.nr_sequencia = a.nr_seq_segurado ' ||  pls_util_pck.enter_w ||
		' and		a.vl_liberado >= 0 ' || pls_util_pck.enter_w ||
		' and		a.nr_seq_evento is not null ' || pls_util_pck.enter_w ||
		' and		(a.ie_tipo_item != ''I'' or a.ie_tipo_item is null) ' || pls_util_pck.enter_w ||
		' and		(a.nr_seq_periodo_pgto = :nr_seq_periodo or a.nr_seq_periodo_pgto is null) ' || pls_util_pck.enter_w ||
		' and		b.ie_status = ''F'' ' || pls_util_pck.enter_w || -- OS 1286795 - jtonon - O protocolo estava liberado para pagamento mas a conta estava pendente de liberacao
		' and not exists (	select	1 ' ||  pls_util_pck.enter_w ||
		'			from	pls_lote_protocolo	y, ' || pls_util_pck.enter_w ||
		'				pls_prot_conta_titulo	x ' || pls_util_pck.enter_w ||
		'			where	x.nr_seq_protocolo	= prot.nr_sequencia ' || pls_util_pck.enter_w ||
		'			and	x.nr_seq_lote		= y.nr_sequencia ' || pls_util_pck.enter_w ||
		'			and	y.ie_status		= ''D'') ' || pls_util_pck.enter_w ||
		' and not exists (	select	1 ' || pls_util_pck.enter_w ||
		'			from 	pls_evento_regra_ex x ' || pls_util_pck.enter_w ||
		'			where 	x.nr_seq_periodo = :nr_seq_periodo ' || pls_util_pck.enter_w ||
		'			and	x.nr_seq_prestador = prest.nr_sequencia ' || pls_util_pck.enter_w ||
		'			and	x.nr_seq_prestador_atend is null ' || pls_util_pck.enter_w ||
		'			union all ' || pls_util_pck.enter_w ||
		' 			select	1 ' || pls_util_pck.enter_w ||
		'			from 	pls_evento_regra_ex x ' || pls_util_pck.enter_w ||
		'			where 	x.nr_seq_periodo = :nr_seq_periodo ' || pls_util_pck.enter_w ||
		'			and	x.nr_seq_prestador_atend = a.nr_seq_prestador_atend ' || pls_util_pck.enter_w ||
		'			and	x.nr_seq_prestador is null ' || pls_util_pck.enter_w ||
		'			union all ' || pls_util_pck.enter_w ||
		' 			select	1 ' || pls_util_pck.enter_w ||
		'			from 	pls_evento_regra_ex x ' || pls_util_pck.enter_w ||
		'			where 	x.nr_seq_periodo = :nr_seq_periodo ' || pls_util_pck.enter_w ||
		'			and	x.nr_seq_prestador = prest.nr_sequencia ' || pls_util_pck.enter_w ||
		'			and	x.nr_seq_prestador_atend = a.nr_seq_prestador_atend) ' || pls_util_pck.enter_w ||
		' and		a.dt_competencia_pgto >= add_months(:dt_mes_competencia, - :qt_mes_deslocamento) ' ||  pls_util_pck.enter_w ||
		' and		a.dt_competencia_pgto <= add_months(:dt_mes_competencia_fim, - nvl(:qt_mes_desloc_final,0)) ' ||  pls_util_pck.enter_w ||
		ds_rest_w ||
		ds_rest_cm_w ||
		--Select dos recursos de glosas de procedimentos
		' union	all ' || pls_util_pck.enter_w ||
		' select	a.nr_seq_conta,	' || pls_util_pck.enter_w ||
		'		b.nr_seq_rec_glosa_proc_mat, ' || pls_util_pck.enter_w ||
		'		b.ie_origem ' || pls_util_pck.enter_w ||
		' from (select	c.nr_sequencia nr_seq_rec_glosa_proc_mat, ' || pls_util_pck.enter_w ||
		'		c.nr_seq_evento, ' || pls_util_pck.enter_w ||
		'		''RGP'' ie_origem, ' || pls_util_pck.enter_w ||
		'		e.nr_sequencia nr_seq_conta_proc, ' || pls_util_pck.enter_w ||
		'		a.dt_competencia_lote, ' || pls_util_pck.enter_w ||
		'		d.nr_seq_protocolo, ' || pls_util_pck.enter_w ||
		'		d.ie_tipo_conta, ' || pls_util_pck.enter_w ||
		'		d.nr_seq_segurado, ' || pls_util_pck.enter_w ||
		'		d.ie_origem_conta, ' || pls_util_pck.enter_w ||
		'		d.ie_status, ' || pls_util_pck.enter_w ||
		'		d.nr_seq_analise, ' || pls_util_pck.enter_w ||
		'		d.nr_sequencia nr_seq_conta, ' || pls_util_pck.enter_w ||
		'		a.dt_liberacao_pag, ' || pls_util_pck.enter_w ||
		'		d.cd_estabelecimento ' || pls_util_pck.enter_w ||
		'	from	pls_conta_proc e, ' || pls_util_pck.enter_w ||
		'		pls_conta d, ' || pls_util_pck.enter_w ||
		'		pls_rec_glosa_proc c, ' || pls_util_pck.enter_w ||
		'		pls_rec_glosa_conta b, ' || pls_util_pck.enter_w ||
		'		pls_rec_glosa_protocolo a ' || pls_util_pck.enter_w ||
		'	where	a.nr_sequencia = b.nr_seq_protocolo ' || pls_util_pck.enter_w ||
		'	and	b.nr_sequencia = c.nr_seq_conta_rec ' || pls_util_pck.enter_w ||
		'	and	b.nr_seq_conta = d.nr_sequencia ' || pls_util_pck.enter_w ||
		'	and	d.nr_sequencia = e.nr_seq_conta ' || pls_util_pck.enter_w ||
		'	and	e.nr_sequencia = c.nr_seq_conta_proc ' || pls_util_pck.enter_w ||
		'	and	a.ie_status in (''3'',''4'') ' || pls_util_pck.enter_w ||
		'	and	b.ie_status != ''3'' ' || pls_util_pck.enter_w ||
		'	and	c.vl_acatado >= 0 ' || pls_util_pck.enter_w ||
		'	and	c.nr_seq_lote_pgto is null ' || pls_util_pck.enter_w ||
		'	and	a.dt_competencia_lote is not null ' || pls_util_pck.enter_w ||
		'	and	c.nr_seq_evento is not null ' || pls_util_pck.enter_w ||
		'	and not exists(	select 	1 ' || pls_util_pck.enter_w ||
		'			from	pls_conta_rec_resumo_item s ' || pls_util_pck.enter_w ||
		'			where	c.nr_sequencia = s.nr_seq_proc_rec and 	s.nr_seq_conta_rec = c.nr_seq_conta_rec)) b,' || pls_util_pck.enter_w ||
		' 	pls_protocolo_conta prot, ' || pls_util_pck.enter_w ||
		'	pls_conta_medica_resumo	a, ' || pls_util_pck.enter_w ||
		'	pls_prestador prest, ' || pls_util_pck.enter_w ||
		'	pls_segurado seg ' || pls_util_pck.enter_w ||
		' where	b.nr_seq_protocolo = prot.nr_sequencia ' || pls_util_pck.enter_w ||
		' and	b.nr_seq_conta = a.nr_seq_conta ' || pls_util_pck.enter_w ||
		' and	b.nr_seq_conta_proc = a.nr_seq_conta_proc ' || pls_util_pck.enter_w ||
		' and	prest.nr_sequencia = a.nr_seq_prestador_pgto ' || pls_util_pck.enter_w ||
		' and	seg.nr_sequencia = a.nr_seq_segurado ' || pls_util_pck.enter_w ||
		' and not exists (	select	1 ' || pls_util_pck.enter_w ||
		'			from 	pls_evento_regra_ex x ' || pls_util_pck.enter_w ||
		'			where 	x.nr_seq_periodo = :nr_seq_periodo ' || pls_util_pck.enter_w ||
		'			and	x.nr_seq_prestador = prest.nr_sequencia ' || pls_util_pck.enter_w ||
		'			and	x.nr_seq_prestador_atend is null ' || pls_util_pck.enter_w ||
		'			union all ' || pls_util_pck.enter_w ||
		' 			select	1 ' || pls_util_pck.enter_w ||
		'			from 	pls_evento_regra_ex x ' || pls_util_pck.enter_w ||
		'			where 	x.nr_seq_periodo = :nr_seq_periodo ' || pls_util_pck.enter_w ||
		'			and	x.nr_seq_prestador_atend = a.nr_seq_prestador_atend ' || pls_util_pck.enter_w ||
		'			and	x.nr_seq_prestador is null ' || pls_util_pck.enter_w ||
		'			union all ' || pls_util_pck.enter_w ||
		' 			select	1 ' || pls_util_pck.enter_w ||
		'			from 	pls_evento_regra_ex x ' || pls_util_pck.enter_w ||
		'			where 	x.nr_seq_periodo = :nr_seq_periodo ' || pls_util_pck.enter_w ||
		'			and	x.nr_seq_prestador = prest.nr_sequencia ' || pls_util_pck.enter_w ||
		'			and	x.nr_seq_prestador_atend = a.nr_seq_prestador_atend) ' || pls_util_pck.enter_w ||
		' and	((a.nr_seq_periodo_pgto = :nr_seq_periodo) or (a.nr_seq_periodo_pgto is null)) ' || pls_util_pck.enter_w ||
		' and	b.dt_competencia_lote >= add_months(:dt_mes_competencia, - :qt_mes_deslocamento) ' ||   pls_util_pck.enter_w ||
		' and	b.dt_competencia_lote <= add_months(:dt_mes_competencia_fim, - nvl(:qt_mes_desloc_final,0)) ' ||   pls_util_pck.enter_w ||
		ds_rest_w ||
		ds_rest_rg_it_w ||
		--Select dos recursos de glosas de materiais
		' union	all ' || pls_util_pck.enter_w ||
		' select	a.nr_seq_conta, ' || pls_util_pck.enter_w ||
		'		b.nr_seq_rec_glosa_proc_mat, ' || pls_util_pck.enter_w ||
		'		b.ie_origem ' || pls_util_pck.enter_w ||
		' from (select	c.nr_sequencia nr_seq_rec_glosa_proc_mat, ' || pls_util_pck.enter_w ||
		'		c.nr_seq_evento, ' || pls_util_pck.enter_w ||
		'		''RGM'' ie_origem, ' || pls_util_pck.enter_w ||
		'		e.nr_sequencia nr_seq_conta_mat, ' || pls_util_pck.enter_w ||
		'		a.dt_competencia_lote, ' || pls_util_pck.enter_w ||
		'		d.nr_seq_protocolo, ' || pls_util_pck.enter_w ||
		'		d.ie_tipo_conta, ' || pls_util_pck.enter_w ||
		'		d.nr_seq_segurado, ' || pls_util_pck.enter_w ||
		'		d.ie_origem_conta, ' || pls_util_pck.enter_w ||
		'		d.ie_status, ' || pls_util_pck.enter_w ||
		'		d.nr_seq_analise, ' || pls_util_pck.enter_w ||
		'		d.nr_sequencia nr_seq_conta, ' || pls_util_pck.enter_w ||
		'		a.dt_liberacao_pag, ' || pls_util_pck.enter_w ||
		'		d.cd_estabelecimento ' || pls_util_pck.enter_w ||
		' 	from	pls_conta_mat e, ' || pls_util_pck.enter_w ||
		'		pls_conta d, ' || pls_util_pck.enter_w ||
		'		pls_rec_glosa_mat c, ' || pls_util_pck.enter_w ||
		'		pls_rec_glosa_conta b, ' || pls_util_pck.enter_w ||
		'		pls_rec_glosa_protocolo a ' || pls_util_pck.enter_w ||
		'	where	a.nr_sequencia = b.nr_seq_protocolo ' || pls_util_pck.enter_w ||
		'	and	b.nr_sequencia = c.nr_seq_conta_rec ' || pls_util_pck.enter_w ||
		'	and	b.nr_seq_conta = d.nr_sequencia	' || pls_util_pck.enter_w ||
		'	and	d.nr_sequencia = e.nr_seq_conta	' || pls_util_pck.enter_w ||
		'	and	e.nr_sequencia = c.nr_seq_conta_mat ' || pls_util_pck.enter_w ||
		'	and	a.ie_status in (''3'',''4'') ' || pls_util_pck.enter_w ||
		'	and	b.ie_status != ''3'' ' || pls_util_pck.enter_w ||
		'	and	c.vl_acatado >= 0 ' || pls_util_pck.enter_w ||
		'	and	c.nr_seq_lote_pgto is null ' || pls_util_pck.enter_w ||
		'	and	a.dt_competencia_lote is not null ' || pls_util_pck.enter_w ||
		'	and	c.nr_seq_evento is not null ' || pls_util_pck.enter_w ||
		'	and not exists(	select 	1 ' || pls_util_pck.enter_w ||
		'			from	pls_conta_rec_resumo_item s ' || pls_util_pck.enter_w ||
		'			where	c.nr_sequencia	= s.nr_seq_mat_rec and 	s.nr_seq_conta_rec = c.nr_seq_conta_rec)) b, ' || pls_util_pck.enter_w ||
		'	pls_protocolo_conta prot, ' || pls_util_pck.enter_w ||
		'	pls_conta_medica_resumo	a, ' || pls_util_pck.enter_w ||
		'	pls_prestador prest, ' || pls_util_pck.enter_w ||
		'	pls_segurado seg ' || pls_util_pck.enter_w ||
		' where	b.nr_seq_protocolo = prot.nr_sequencia ' || pls_util_pck.enter_w ||
		' and	b.nr_seq_conta = a.nr_seq_conta ' || pls_util_pck.enter_w ||
		' and	b.nr_seq_conta_mat = a.nr_seq_conta_mat ' || pls_util_pck.enter_w ||
		' and	a.nr_seq_prestador_pgto	is not null ' || pls_util_pck.enter_w ||
		' and	prest.nr_sequencia = a.nr_seq_prestador_pgto ' || pls_util_pck.enter_w ||
		' and	seg.nr_sequencia = a.nr_seq_segurado ' || pls_util_pck.enter_w ||
		' and not exists (	select	1 ' || pls_util_pck.enter_w ||
		'			from 	pls_evento_regra_ex x ' || pls_util_pck.enter_w ||
		'			where 	x.nr_seq_periodo = :nr_seq_periodo ' || pls_util_pck.enter_w ||
		'			and	x.nr_seq_prestador = prest.nr_sequencia ' || pls_util_pck.enter_w ||
		'			and	x.nr_seq_prestador_atend is null ' || pls_util_pck.enter_w ||
		'			union all ' || pls_util_pck.enter_w ||
		' 			select	1 ' || pls_util_pck.enter_w ||
		'			from 	pls_evento_regra_ex x ' || pls_util_pck.enter_w ||
		'			where 	x.nr_seq_periodo = :nr_seq_periodo ' || pls_util_pck.enter_w ||
		'			and	x.nr_seq_prestador_atend = a.nr_seq_prestador_atend ' || pls_util_pck.enter_w ||
		'			and	x.nr_seq_prestador is null ' || pls_util_pck.enter_w ||
		'			union all ' || pls_util_pck.enter_w ||
		' 			select	1 ' || pls_util_pck.enter_w ||
		'			from 	pls_evento_regra_ex x ' || pls_util_pck.enter_w ||
		'			where 	x.nr_seq_periodo = :nr_seq_periodo ' || pls_util_pck.enter_w ||
		'			and	x.nr_seq_prestador = prest.nr_sequencia ' || pls_util_pck.enter_w ||
		'			and	x.nr_seq_prestador_atend = a.nr_seq_prestador_atend) ' || pls_util_pck.enter_w ||
		' and	((a.nr_seq_periodo_pgto = :nr_seq_periodo) or (a.nr_seq_periodo_pgto is null)) ' || pls_util_pck.enter_w ||
		' and	b.dt_competencia_lote >= add_months(:dt_mes_competencia, - :qt_mes_deslocamento) ' || pls_util_pck.enter_w ||
		' and	b.dt_competencia_lote <= add_months(:dt_mes_competencia_fim, - nvl(:qt_mes_desloc_final,0)) ' || pls_util_pck.enter_w ||
		ds_rest_w ||
		ds_rest_rg_it_w ||
		' union all ' || pls_util_pck.enter_w ||
		' select	a.nr_seq_conta, ' || pls_util_pck.enter_w ||
		'		a.nr_sequencia, ' || pls_util_pck.enter_w ||
		'		''RG'' ie_origem ' || pls_util_pck.enter_w ||
		' from	pls_rec_glosa_protocolo prot, ' || pls_util_pck.enter_w ||
		'	pls_rec_glosa_conta e, ' || pls_util_pck.enter_w ||
		'	pls_conta b, ' || pls_util_pck.enter_w ||
		'	pls_conta_rec_resumo_item a, ' || pls_util_pck.enter_w ||
		'	pls_prestador prest, ' || pls_util_pck.enter_w ||
		'	pls_segurado seg ' || pls_util_pck.enter_w ||
		' where	b.nr_sequencia = a.nr_seq_conta	' || pls_util_pck.enter_w ||
		' and	e.nr_sequencia = a.nr_seq_conta_rec ' || pls_util_pck.enter_w ||
		' and	prot.nr_sequencia = e.nr_seq_protocolo ' || pls_util_pck.enter_w ||
		' and	a.vl_liberado >= 0 ' || pls_util_pck.enter_w ||
		' and	e.ie_status != ''3'' ' || pls_util_pck.enter_w ||
		' and	a.nr_seq_lote_pgto is null ' || pls_util_pck.enter_w ||
		' and	prest.nr_sequencia = a.nr_seq_prestador_pgto ' || pls_util_pck.enter_w ||
		' and	seg.nr_sequencia = b.nr_seq_segurado ' || pls_util_pck.enter_w ||
		' and	a.ie_situacao = ''A'' ' || pls_util_pck.enter_w ||
		' and not exists (	select	1 ' || pls_util_pck.enter_w ||
		'			from 	pls_evento_regra_ex x ' || pls_util_pck.enter_w ||
		'			where 	x.nr_seq_periodo = :nr_seq_periodo ' || pls_util_pck.enter_w ||
		'			and	x.nr_seq_prestador = prest.nr_sequencia) ' || pls_util_pck.enter_w ||
		' and	((a.nr_seq_periodo_pgto = :nr_seq_periodo) or (a.nr_seq_periodo_pgto is null)) ' || pls_util_pck.enter_w ||
		' and	a.dt_competencia_pgto >= add_months(:dt_mes_competencia, - :qt_mes_deslocamento) ' || pls_util_pck.enter_w ||
		' and	a.dt_competencia_pgto <= add_months(:dt_mes_competencia_fim, - nvl(:qt_mes_desloc_final,0)) ' || pls_util_pck.enter_w ||
		ds_rest_w ||
		ds_rest_rg_w;

	valor_bind_w := sql_pck.bind_variable( ':dt_mes_competencia', dt_mes_competencia_w, valor_bind_w, sql_pck.b_data_hora);
	valor_bind_w := sql_pck.bind_variable( ':dt_mes_competencia_fim', dt_mes_competencia_fim_w, valor_bind_w, sql_pck.b_data_hora);
	valor_bind_w := sql_pck.bind_variable( ':qt_mes_deslocamento', r_c01_w.qt_mes_deslocamento, valor_bind_w);
	valor_bind_w := sql_pck.bind_variable( ':qt_mes_desloc_final', r_c01_w.qt_mes_desloc_final, valor_bind_w);
	valor_bind_w := sql_pck.bind_variable( ':nr_seq_periodo', nr_seq_periodo_w, valor_bind_w);

	-- executa o comando sql com os respectivos binds
	valor_bind_w := sql_pck.executa_sql_cursor(	ds_sql_w, valor_bind_w);

	loop
		fetch cursor_w bulk collect into tb_nr_seq_conta_w, tb_nr_seq_conta_res_w, tb_ie_origem_w
		limit pls_util_pck.qt_registro_transacao_w;
		exit when tb_nr_seq_conta_w.count = 0;

		forall i in tb_nr_seq_conta_w.first..tb_nr_seq_conta_w.last
			insert into w_pls_conta_pag_prod(
				nr_sequencia, dt_atualizacao, nm_usuario,
				dt_atualizacao_nrec, nm_usuario_nrec, nr_seq_conta,
				nr_seq_conta_resumo, nr_seq_evento, ie_origem
			) values (
				nextval('w_pls_conta_pag_prod_seq'), clock_timestamp(), nm_usuario_p,
				clock_timestamp(), nm_usuario_p, tb_nr_seq_conta_w(i),
				tb_nr_seq_conta_res_w(i), null, tb_ie_origem_w(i)
			);

		commit;
	end loop;
end loop;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_vincular_contas_pag_prod ( nr_seq_lote_pag_p pls_lote_pagamento.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type) FROM PUBLIC;

