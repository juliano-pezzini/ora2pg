-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE registrar_ausencia_prof_escala (cd_profissional_p text, dia_p bigint, mes_p text, ano_p text, cd_motivo_afast_p text, cd_substituto_p text, cd_escala_p bigint, nm_usuario_p text) AS $body$
DECLARE


/*
	Procedure duplicada para HTML5  Reg_ausencia_prof_escala_HTML5
	Procedure doubled to HTML5 Reg_ausencia_prof_escala_HTML5
*/
dt_inicio_w		timestamp;
dt_fim_w		timestamp;
ie_escala_inter_w	varchar(1);
qt_registro_w		bigint;


BEGIN

SELECT	TO_DATE(dia_p||'/'||mes_p||'/'||ano_p),
	fim_dia(TO_DATE(dia_p||'/'||mes_p||'/'||ano_p))
INTO STRICT	dt_inicio_w,
	dt_fim_w
;

ie_escala_inter_w := Obter_Param_Usuario(75, 52, obter_perfil_ativo, nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento, ie_escala_inter_w);

if (ie_escala_inter_w = 'S') then

select count(*)
into STRICT qt_registro_w
from escala_afastamento_prof
where nr_seq_motivo_afast = cd_motivo_afast_p
and cd_profissional = cd_profissional_p
and nr_seq_escala = cd_escala_p
and dt_inicio = dt_inicio_w
and trunc(dt_inicio) = trunc(dt_final);

end if;

if (qt_registro_w > 0) and (ie_escala_inter_w = 'S') then

	delete FROM escala_afastamento_prof
	where nr_seq_motivo_afast = cd_motivo_afast_p
	and cd_profissional = cd_profissional_p
	and nr_seq_escala = cd_escala_p
	and dt_inicio = dt_inicio_w
	and trunc(dt_inicio) = trunc(dt_final);

else

	INSERT INTO escala_afastamento_prof(nr_sequencia,
					    dt_inicio,
					    dt_final,
					    nr_seq_motivo_afast,
					    cd_profissional,
					    cd_profissional_subst,
					    dt_atualizacao,
					    dt_atualizacao_nrec,
					    nm_usuario,
					    nm_usuario_nrec,
					    nr_seq_escala,
					    ie_tipo_escala)
				    VALUES ( nextval('escala_afastamento_prof_seq'),
					    dt_inicio_w,
					    dt_fim_w,
					    cd_motivo_afast_p,
					    cd_profissional_p,
					    cd_substituto_p,
					    clock_timestamp(),
					    clock_timestamp(),
					    nm_usuario_p,
					    nm_usuario_p,
					    CASE WHEN cd_escala_p=0 THEN ''  ELSE cd_escala_p END ,
					    'S');

end if;

COMMIT;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE registrar_ausencia_prof_escala (cd_profissional_p text, dia_p bigint, mes_p text, ano_p text, cd_motivo_afast_p text, cd_substituto_p text, cd_escala_p bigint, nm_usuario_p text) FROM PUBLIC;

