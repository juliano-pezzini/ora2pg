-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE tre_atualiza_status_agenda () AS $body$
DECLARE


dt_agenda_w		timestamp;
nr_seq_pac_dia_w	bigint;
nr_seq_inscrito_w	bigint;
ie_status_paciente_w	varchar(2);
cd_estabelecimento_w	bigint;

C01 CURSOR FOR
	SELECT 	substr(tre_obter_dados_pac_dia(b.nr_sequencia,dt_agenda_w,'C'),1,255),
		b.nr_sequencia,
		substr(tre_obter_dados_pac_dia(b.nr_sequencia,dt_agenda_w,'SP'),1,2)
	from	tre_inscrito b,
		tre_evento c
	where	b.nr_seq_evento = c.nr_sequencia
	and	((tre_valida_se_dia_curso(c.nr_sequencia,fim_dia(dt_agenda_w)) = 'S') or ((tre_obter_dados_pac_dia(b.nr_sequencia,dt_agenda_w,'CA'))::numeric  > 0))
	and (substr(tre_obter_se_data_fim_valida(dt_agenda_w,c.nr_sequencia,c.dt_fim_real,c.dt_fim),1,1) = 'S')
	and	fim_dia(dt_agenda_w) >= c.dt_inicio
	and (obter_se_feriado(cd_estabelecimento_w, dt_agenda_w) = 0)
	and	not exists (	SELECT	1
				from	tre_agenda v
				where	v.nr_sequencia = c.nr_seq_agenda
				and	(v.DT_CANCELAMENTO IS NOT NULL AND v.DT_CANCELAMENTO::text <> ''));




BEGIN
cd_estabelecimento_w := wheb_usuario_pck.get_cd_estabelecimento;
dt_agenda_w := trunc(clock_timestamp()) - 1;

open C01;
loop
fetch C01 into
	nr_seq_pac_dia_w,
	nr_seq_inscrito_w,
	ie_status_paciente_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	if (coalesce(nr_seq_pac_dia_w::text, '') = '') and
		((ie_status_paciente_w = 'N') or (ie_status_paciente_w = 'AD')) then
		nr_seq_pac_dia_w := tre_insere_pac_dia(nr_seq_inscrito_w, dt_agenda_w, 'Ag automatico', nr_seq_pac_dia_w);
	end if;


	if (ie_status_paciente_w = 'N') then
		update	tre_paciente_dia
		set	ie_status_paciente = 'I',
			ds_motivo_status = 'Falta realizada automaticamente via JOB'
		where	nr_sequencia = nr_seq_pac_dia_w;

		CALL tre_aplica_regra_falta(dt_agenda_w,nr_seq_inscrito_w,'Ag automatico',cd_estabelecimento_w);
	end if;

	if (ie_status_paciente_w = 'AD') then
		update	tre_paciente_dia
		set	ie_status_paciente = 'E'
		where	nr_sequencia = nr_seq_pac_dia_w;
	end if;

	end;
end loop;
close C01;



commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE tre_atualiza_status_agenda () FROM PUBLIC;

