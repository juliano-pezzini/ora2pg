-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_data_interv_diff_rp (nr_seq_cpoe_rp_p bigint, nm_usuario_p text) AS $body$
DECLARE


nr_seq_cpoe_material_w  cpoe_material.nr_sequencia%type;
ie_segunda_w            cpoe_rp.ie_segunda%type;
ie_terca_w              cpoe_rp.ie_segunda%type;
ie_quarta_w             cpoe_rp.ie_segunda%type;
ie_quinta_w             cpoe_rp.ie_segunda%type;
ie_sexta_w              cpoe_rp.ie_segunda%type;
ie_sabado_w             cpoe_rp.ie_segunda%type;
ie_domingo_w            cpoe_rp.ie_segunda%type;
ie_inter_diff_w         varchar(1) := 'N';
qt_diff_date_w          bigint;

c01 CURSOR FOR
SELECT  b.ie_segunda,
        b.ie_terca,
        b.ie_quarta,
        b.ie_quinta,
        b.ie_sexta,
        b.ie_sabado,
        b.ie_domingo,
        a.nr_sequencia
from    cpoe_material a,
        cpoe_rp b
where   a.nr_seq_cpoe_rp = b.nr_sequencia
and     b.nr_sequencia = nr_seq_cpoe_rp_p
and (
            coalesce(b.ie_segunda, 'S') = 'N' or
            coalesce(b.ie_terca, 'S') = 'N' or
            coalesce(b.ie_quarta, 'S') = 'N' or
            coalesce(b.ie_quinta, 'S') = 'N' or
            coalesce(b.ie_sexta, 'S') = 'N' or
            coalesce(b.ie_sabado, 'S') = 'N' or
            coalesce(b.ie_domingo, 'S') = 'N'
        ); -- if any of the weekdays field is N, it means that the user used differentiated interval
c02 CURSOR FOR
SELECT  a.nr_sequencia
from    cpoe_material a,
        cpoe_rp b
where   a.nr_seq_cpoe_rp = b.nr_sequencia
and     b.nr_sequencia = nr_seq_cpoe_rp_p;


BEGIN

open c01;
loop
fetch c01 into
    ie_segunda_w,
    ie_terca_w,
    ie_quarta_w,
    ie_quinta_w,
    ie_sexta_w,
    ie_sabado_w,
    ie_domingo_w,
    nr_seq_cpoe_material_w;
EXIT WHEN NOT FOUND; /* apply on c01 */

    ie_inter_diff_w := 'S'; -- only can check interval differentiate by date
    -- if user do not used differentiated interval
    -- only one option can be used at once
    update cpoe_material
    set ie_segunda = ie_segunda_w,
        ie_terca = ie_terca_w,
        ie_quarta = ie_quarta_w,
        ie_quinta = ie_quinta_w,
        ie_sexta = ie_sexta_w,
        ie_sabado = ie_sabado_w,
        ie_domingo = ie_domingo_w
    where nr_sequencia = nr_seq_cpoe_material_w;

end loop;
close c01;

select  count(*)
into STRICT    qt_diff_date_w
from    cpoe_diff_date_rp a
where   ie_inter_diff_w = 'N'
and     a.nr_seq_cpoe_rp = nr_seq_cpoe_rp_p;

if (qt_diff_date_w > 0 and ie_inter_diff_w = 'N') then -- enter here if interval differentiated by dates
    open c02;
    loop
    fetch c02 into
        nr_seq_cpoe_material_w;
    EXIT WHEN NOT FOUND; /* apply on c02 */

        insert into cpoe_diff_date(
            nr_sequencia,
            dt_atualizacao,
            dt_atualizacao_nrec,
            nm_usuario,
            nm_usuario_nrec,
            nr_seq_cpoe_material,
            dt_administration)
        SELECT  nextval('cpoe_diff_date_seq'),
                clock_timestamp(),
                clock_timestamp(),
                nm_usuario_p,
                nm_usuario_p,
                nr_seq_cpoe_material_w,
                dt_administration
        from    cpoe_diff_date_rp
        where   nr_seq_cpoe_rp = nr_seq_cpoe_rp_p;

    end loop;
    close c02;

end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_data_interv_diff_rp (nr_seq_cpoe_rp_p bigint, nm_usuario_p text) FROM PUBLIC;

