-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE inserir_grau_de_parentesco ( CD_PESSOA_FISICA_P text, CD_PESSOA_FAMILIA_P text, NR_SEQ_GRAU_PARENTESCO_P text DEFAULT '0', NM_USUARIO_P text DEFAULT NULL, IE_OPERACAO_P text DEFAULT NULL) AS $body$
DECLARE




  existe_relacao_w bigint:=0;



BEGIN


    if (IE_OPERACAO_P = 'I') then

      select CASE WHEN coalesce(max(NR_SEQ_GRAU_PARENTESCO)::text, '') = '' THEN '0'  ELSE max(NR_SEQ_GRAU_PARENTESCO) END  into STRICT existe_relacao_w from PF_FAMILIA where CD_PESSOA_FISICA = CD_PESSOA_FISICA_P and  CD_PESSOA_FAMILIA = CD_PESSOA_FAMILIA_P;

      if (existe_relacao_w > 0 ) then
      begin
        update PF_FAMILIA set NR_SEQ_GRAU_PARENTESCO = NR_SEQ_GRAU_PARENTESCO_P

        where CD_PESSOA_FISICA = CD_PESSOA_FISICA_P and  CD_PESSOA_FAMILIA = CD_PESSOA_FAMILIA_P;
      end;
      else
       begin


        insert into PF_FAMILIA(NR_SEQUENCIA, NR_SEQ_GRAU_PARENTESCO, CD_PESSOA_FISICA, CD_PESSOA_FAMILIA, DT_ATUALIZACAO, NM_USUARIO, IE_HABITACAO)

        VALUES (nextval('pf_familia_seq'), coalesce(NR_SEQ_GRAU_PARENTESCO_P,'0'), CD_PESSOA_FISICA_P, CD_PESSOA_FAMILIA_P, clock_timestamp(), NM_USUARIO_P, 'N');

        insert into PF_FAMILIA(NR_SEQUENCIA, NR_SEQ_GRAU_PARENTESCO, CD_PESSOA_FISICA, CD_PESSOA_FAMILIA, DT_ATUALIZACAO, NM_USUARIO, IE_HABITACAO)

        VALUES (nextval('pf_familia_seq'), coalesce(NR_SEQ_GRAU_PARENTESCO_P,'0'), CD_PESSOA_FISICA_P, CD_PESSOA_FISICA_P, clock_timestamp(), NM_USUARIO_P, 'N');
       end;

      end if;

    ELSIF (IE_OPERACAO_P = 'DELETE') then

      select CASE WHEN coalesce(max(NR_SEQ_GRAU_PARENTESCO)::text, '') = '' THEN '0'  ELSE max(NR_SEQ_GRAU_PARENTESCO) END NR_SEQ_GRAU_PARENTESCO into STRICT existe_relacao_w from PF_FAMILIA where CD_PESSOA_FISICA = CD_PESSOA_FISICA_P and  CD_PESSOA_FAMILIA = CD_PESSOA_FAMILIA_P;

      if (existe_relacao_w > 0 ) then

        delete from PF_FAMILIA where CD_PESSOA_FISICA = CD_PESSOA_FISICA_P and CD_PESSOA_FAMILIA = CD_PESSOA_FAMILIA_P;

      end if;

    elsif (IE_OPERACAO_P = 'INVERSO') then


      select CASE WHEN coalesce(max(NR_SEQ_GRAU_PARENTESCO)::text, '') = '' THEN '0'  ELSE max(NR_SEQ_GRAU_PARENTESCO) END  into STRICT existe_relacao_w from PF_FAMILIA where CD_PESSOA_FISICA = CD_PESSOA_FISICA_P and  CD_PESSOA_FAMILIA = CD_PESSOA_FAMILIA_P;

      if (existe_relacao_w > 0 ) then
      begin
        update PF_FAMILIA set NR_SEQ_GRAU_PARENTESCO = NR_SEQ_GRAU_PARENTESCO_P

        where CD_PESSOA_FISICA = CD_PESSOA_FISICA_P and  CD_PESSOA_FAMILIA = CD_PESSOA_FAMILIA_P;
      end;
      else
       begin


        insert into PF_FAMILIA(NR_SEQUENCIA, NR_SEQ_GRAU_PARENTESCO, CD_PESSOA_FISICA, CD_PESSOA_FAMILIA, DT_ATUALIZACAO, NM_USUARIO, IE_HABITACAO)

        VALUES (nextval('pf_familia_seq'), coalesce(NR_SEQ_GRAU_PARENTESCO_P,'0'), CD_PESSOA_FISICA_P, CD_PESSOA_FAMILIA_P, clock_timestamp(), NM_USUARIO_P, 'N');

        insert into PF_FAMILIA(NR_SEQUENCIA, NR_SEQ_GRAU_PARENTESCO, CD_PESSOA_FISICA, CD_PESSOA_FAMILIA, DT_ATUALIZACAO, NM_USUARIO, IE_HABITACAO)

        VALUES (nextval('pf_familia_seq'), '0', CD_PESSOA_FISICA_P, CD_PESSOA_FISICA_P, clock_timestamp(), NM_USUARIO_P, 'N');

       end;

      end if;


    end if;

    commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE inserir_grau_de_parentesco ( CD_PESSOA_FISICA_P text, CD_PESSOA_FAMILIA_P text, NR_SEQ_GRAU_PARENTESCO_P text DEFAULT '0', NM_USUARIO_P text DEFAULT NULL, IE_OPERACAO_P text DEFAULT NULL) FROM PUBLIC;

