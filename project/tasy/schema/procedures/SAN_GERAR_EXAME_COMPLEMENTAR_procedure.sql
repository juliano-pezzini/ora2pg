-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE san_gerar_exame_complementar (nr_seq_exame_lote_p bigint, nr_seq_exame_p bigint, nm_usuario_p text) AS $body$
DECLARE

 
nr_seq_exame_compl_w	bigint;
ie_acao_w		varchar(1);
nr_seq_lote_w		bigint;
nr_seq_lote_new_w	bigint := 0;

c01 CURSOR FOR 
	SELECT	b.nr_seq_exame_compl, 
		b.ie_acao 
	from	san_exame_complementar b, 
		san_exame_realizado a 
	where	a.nr_seq_exame	= b.nr_seq_exame 
	 and	a.nr_seq_exame	= coalesce(nr_seq_exame_p, a.nr_seq_exame) 
	 and	a.nr_seq_exame_lote = nr_seq_exame_lote_p 
	 and	not exists (	SELECT 1 from san_exame_realizado x 
				where x.nr_seq_exame_lote	= a.nr_seq_exame_lote 
				 and x.nr_seq_exame		= b.nr_seq_exame_compl) 
	 and	(ds_resultado IS NOT NULL AND ds_resultado::text <> '') 
	 and	ds_resultado not in ('NÃ£o reagente','Negativo') 
	order by b.ie_acao;
	

BEGIN 
 
open c01;
loop 
fetch c01 into nr_seq_exame_compl_w, 
		 ie_acao_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
 
	if (ie_acao_w = 'A') and (nr_seq_lote_new_w = 0) then 
		nr_seq_lote_new_w := nr_seq_exame_lote_p;
		nr_seq_lote_new_w := duplicar_registro('SAN_EXAME_LOTE', nm_usuario_p, nr_seq_lote_new_w);
		update san_doacao 
		set	ie_status	= 4 
		where	nr_sequencia	= (	SELECT nr_seq_doacao 
						from san_exame_lote 
						where nr_sequencia = nr_seq_exame_lote_p);
	else 
		nr_seq_lote_new_w := nr_seq_exame_lote_p;
	end if;
 
	insert into san_exame_realizado(nr_seq_exame_lote, nr_seq_exame, 
					 dt_atualizacao, nm_usuario, 
					 dt_realizado, vl_resultado, 
					 ie_resultado, ds_resultado, 
					 nr_seq_propaci, vl_result1, vl_result2) 
	values (nr_seq_lote_new_w, nr_seq_exame_compl_w, 
		clock_timestamp(), nm_usuario_p, 
		clock_timestamp(), null, 
		null, null, 
		null, null, null);
end loop;
close c01;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE san_gerar_exame_complementar (nr_seq_exame_lote_p bigint, nr_seq_exame_p bigint, nm_usuario_p text) FROM PUBLIC;

