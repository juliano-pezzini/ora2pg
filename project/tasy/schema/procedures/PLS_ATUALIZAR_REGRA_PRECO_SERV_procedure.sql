-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_atualizar_regra_preco_serv ( nr_seq_regra_p bigint, ie_opcao_p text, cd_estabelecimento_p bigint, nm_usuario_p text) AS $body$
DECLARE


/* ie_opcao_p
	'A' - Atualizar
	'D' - Deletar
*/
ds_observacao_w			varchar(4000);
cd_prestador_w			varchar(30);
ie_tipo_intercambio_w		varchar(10);
ie_tipo_segurado_w		varchar(3);
ie_preco_w			varchar(2);
ie_tipo_contratacao_w		varchar(2);
ie_tipo_vinculo_w		varchar(2);
ie_tipo_guia_w			varchar(2);
ie_situacao_w			varchar(1);
ie_internado_w			varchar(1);
ie_acomodacao_w			varchar(1);
ie_taxa_coleta_w		varchar(1);
ie_carater_internacao_w		varchar(1);
cd_procedimento_w		bigint;
cd_area_procedimento_w		bigint;
cd_especialidade_w		bigint;
cd_grupo_proc_w			bigint;
nr_seq_regra_w			bigint	:= null;
nr_seq_serv_ref_w		bigint;
nr_seq_prestador_w		bigint;
nr_seq_plano_w			bigint;
nr_seq_categoria_w		bigint;
nr_seq_clinica_w		bigint;
nr_seq_tipo_acomodacao_w	bigint;
nr_seq_tipo_atendimento_w	bigint;
ie_origem_proced_w		bigint;
nr_seq_outorgante_w		bigint;
nr_seq_contrato_w		bigint;
nr_seq_congenere_w		bigint;
nr_seq_classificacao_w		bigint;
nr_seq_grupo_contrato_w		bigint;
nr_seq_grupo_servico_w		bigint;
nr_seq_grupo_prestador_w	bigint;
nr_seq_grupo_produto_w		bigint;
nr_seq_tipo_prestador_w		bigint;
nr_seq_grupo_rec_w		bigint;
nr_seq_cbo_saude_w		bigint;
nr_seq_grupo_intercambio_w	bigint;
nr_seq_intercambio_w		bigint;
nr_seq_congenere_prot_w		bigint;
cd_estabelecimento_w		smallint;
dt_inicio_vigencia_w		timestamp;
dt_fim_vigencia_w		timestamp;
cd_moeda_w			varchar(10);
cd_tabela_servico_w		varchar(10);
ie_autogerado_w			varchar(10);
ie_pcmso_w			varchar(1);
ie_tipo_tabela_w		varchar(10);
nr_contrato_w			numeric(30);
nr_seq_referencia_w		numeric(30);
nr_seq_regra_ant_w		numeric(30);
tx_ajuste_w			double precision;
tx_ajuste_preco_w		double precision;
vl_negociado_w			double precision;
ie_saude_ocupacional_w			pls_regra_preco_servico.ie_saude_ocupacional%type;
ie_regime_atendimento_w			pls_regra_preco_servico.ie_regime_atendimento%type;
ie_regime_atendimento_princ_w	pls_regra_preco_servico.ie_regime_atendimento_princ%type;WITH RECURSIVE cte AS (



C01 CURSOR FOR
	SELECT	a.nr_sequencia,a.nr_seq_serv_ref
	from	pls_regra_preco_servico	a WHERE a.nr_sequencia in (SELECT	x.nr_sequencia
					from	pls_regra_preco_servico x
					where	x.nr_sequencia	= nr_seq_regra_p)
  UNION ALL



C01 CURSOR FOR
	SELECT	a.nr_sequencia,a.nr_seq_serv_ref
	from	pls_regra_preco_servico	a JOIN cte c ON (c.prior nr_sequencia = a.nr_seq_serv_ref)

) SELECT * FROM cte;
;WITH RECURSIVE cte AS (

	
C02 CURSOR FOR
	SELECT	a.nr_sequencia
	from	pls_regra_preco_servico	a WHERE a.nr_sequencia in (SELECT	x.nr_sequencia
					from	pls_regra_preco_servico x
					where	x.nr_seq_serv_ref	= nr_seq_regra_p)
  UNION ALL

	
C02 CURSOR FOR
	SELECT	a.nr_sequencia
	from	pls_regra_preco_servico	a JOIN cte c ON (c.prior nr_sequencia = a.nr_seq_serv_ref)

) SELECT * FROM cte ORDER BY  level desc;
;


BEGIN
if (ie_opcao_p = 'A') then
	open C01;
	loop
	fetch C01 into	
		nr_seq_regra_w,
		nr_seq_serv_ref_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin
		if (nr_seq_serv_ref_w IS NOT NULL AND nr_seq_serv_ref_w::text <> '') then
			select	cd_area_procedimento,
				cd_especialidade,                
				cd_estabelecimento,       
				cd_grupo_proc,                   
				cd_moeda,                        
				cd_prestador,                    
				cd_procedimento,                 
				cd_tabela_servico,        
				ds_observacao,                               
				dt_fim_vigencia,                 
				dt_inicio_vigencia,       
				ie_acomodacao,                   
				ie_autogerado,                   
				ie_carater_internacao,           
				ie_internado,                    
				ie_origem_proced,                
				ie_pcmso,                        
				ie_preco,                       
				ie_situacao,              
				ie_taxa_coleta,                 
				ie_tipo_contratacao,             
				ie_tipo_guia,
				ie_tipo_intercambio,             
				ie_tipo_segurado,                                 
				ie_tipo_vinculo,                               
				nr_contrato,                     
				nr_seq_categoria,                
				nr_seq_cbo_saude,                
				nr_seq_classificacao,            
				nr_seq_clinica,                  
				nr_seq_congenere,                
				nr_seq_congenere_prot,          
				nr_seq_contrato,                 
				nr_seq_grupo_contrato,           
				nr_seq_grupo_intercambio,        
				nr_seq_grupo_prestador,          
				nr_seq_grupo_produto,            
				nr_seq_grupo_rec,                
				nr_seq_grupo_servico,            
				nr_seq_intercambio,              
				nr_seq_outorgante,               
				nr_seq_plano,                    
				nr_seq_prestador,                
				nr_seq_referencia,               
				nr_seq_regra_ant,                              
				nr_seq_tipo_acomodacao,          
				nr_seq_tipo_atendimento,         
				nr_seq_tipo_prestador,                      
				tx_ajuste,                
				tx_ajuste_preco,                 
				vl_negociado,
				ie_saude_ocupacional,
				ie_regime_atendimento,
				ie_regime_atendimento_princ				
			into STRICT	cd_area_procedimento_w,            
				cd_especialidade_w,                
				cd_estabelecimento_w,       
				cd_grupo_proc_w,                   
				cd_moeda_w,                        
				cd_prestador_w,                    
				cd_procedimento_w,                 
				cd_tabela_servico_w,        
				ds_observacao_w,                              
				dt_fim_vigencia_w,                 
				dt_inicio_vigencia_w,       
				ie_acomodacao_w,                   
				ie_autogerado_w,                   
				ie_carater_internacao_w,           
				ie_internado_w,                    
				ie_origem_proced_w,                
				ie_pcmso_w,                        
				ie_preco_w,                       
				ie_situacao_w,              
				ie_taxa_coleta_w,                 
				ie_tipo_contratacao_w,             
				ie_tipo_guia_w,
				ie_tipo_intercambio_w,             
				ie_tipo_segurado_w,                                
				ie_tipo_vinculo_w,                               
				nr_contrato_w,                     
				nr_seq_categoria_w,                
				nr_seq_cbo_saude_w,                
				nr_seq_classificacao_w,            
				nr_seq_clinica_w,                  
				nr_seq_congenere_w,                
				nr_seq_congenere_prot_w,          
				nr_seq_contrato_w,                 
				nr_seq_grupo_contrato_w,           
				nr_seq_grupo_intercambio_w,        
				nr_seq_grupo_prestador_w,          
				nr_seq_grupo_produto_w,            
				nr_seq_grupo_rec_w,                
				nr_seq_grupo_servico_w,            
				nr_seq_intercambio_w,              
				nr_seq_outorgante_w,               
				nr_seq_plano_w,                    
				nr_seq_prestador_w,                
				nr_seq_referencia_w,               
				nr_seq_regra_ant_w,                               
				nr_seq_tipo_acomodacao_w,          
				nr_seq_tipo_atendimento_w,         
				nr_seq_tipo_prestador_W,                     
				tx_ajuste_W,                
				tx_ajuste_preco_w,                 
				vl_negociado_w ,
				ie_saude_ocupacional_w,
				ie_regime_atendimento_w,
				ie_regime_atendimento_princ_w
			from	pls_regra_preco_servico
			where	nr_sequencia	= nr_seq_serv_ref_w;
			
			update	pls_regra_preco_servico
			set	cd_area_procedimento		= cd_area_procedimento_w, 		
				cd_especialidade		= cd_especialidade_w,
				cd_estabelecimento		= cd_estabelecimento_w,
				cd_grupo_proc			= cd_grupo_proc_w,           
				cd_moeda			= cd_moeda_w,                
				cd_prestador			= cd_prestador_w,            
				cd_procedimento			= cd_procedimento_w,         
				cd_tabela_servico		= cd_tabela_servico_w,       
				ds_observacao			= ds_observacao_w,           
				dt_atualizacao			= clock_timestamp(),               
				dt_fim_vigencia			= dt_fim_vigencia_w,         
				dt_inicio_vigencia		= dt_inicio_vigencia_w,      
				ie_acomodacao			= ie_acomodacao_w,           
				ie_autogerado			= ie_autogerado_w,           
				ie_carater_internacao		= ie_carater_internacao_w,   
				ie_internado			= ie_internado_w,            
				ie_origem_proced		= ie_origem_proced_w,        
				ie_pcmso			= ie_pcmso_w,                
				ie_preco			= ie_preco_w,                
				ie_situacao			= ie_situacao_w,             
				ie_taxa_coleta			= ie_taxa_coleta_w,          
				ie_tipo_contratacao		= ie_tipo_contratacao_w,     
				ie_tipo_guia			= ie_tipo_guia_w,            
				ie_tipo_intercambio		= ie_tipo_intercambio_w,     
				ie_tipo_segurado		= ie_tipo_segurado_w,                
				ie_tipo_vinculo			= ie_tipo_vinculo_w,         
				nm_usuario			= nm_usuario_p,
				nr_contrato			= nr_contrato_w,             
				nr_seq_categoria		= nr_seq_categoria_w,        
				nr_seq_cbo_saude		= nr_seq_cbo_saude_w,        
				nr_seq_classificacao		= nr_seq_classificacao_w,    
				nr_seq_clinica			= nr_seq_clinica_w,          
				nr_seq_congenere		= nr_seq_congenere_w,        
				nr_seq_congenere_prot		= nr_seq_congenere_prot_w,   
				nr_seq_contrato			= nr_seq_contrato_w,         
				nr_seq_grupo_contrato		= nr_seq_grupo_contrato_w,   
				nr_seq_grupo_intercambio	= nr_seq_grupo_intercambio_w,
				nr_seq_grupo_prestador		= nr_seq_grupo_prestador_w,  
				nr_seq_grupo_produto		= nr_seq_grupo_produto_w,    
				nr_seq_grupo_rec		= nr_seq_grupo_rec_w,        
				nr_seq_grupo_servico		= nr_seq_grupo_servico_w,    
				nr_seq_intercambio		= nr_seq_intercambio_w,      
				nr_seq_outorgante		= nr_seq_outorgante_w,       
				nr_seq_plano			= nr_seq_plano_w,            
				nr_seq_prestador		= nr_seq_prestador_w,        
				nr_seq_referencia		= nr_seq_referencia_w,                    
				nr_seq_tipo_acomodacao		= nr_seq_tipo_acomodacao_w,  
				nr_seq_tipo_atendimento		= nr_seq_tipo_atendimento_w,
				nr_seq_tipo_prestador		= nr_seq_tipo_prestador_w,               
				tx_ajuste			= tx_ajuste_w,               
				tx_ajuste_preco			= tx_ajuste_preco_w,
				vl_negociado			= vl_negociado_w,
				ie_saude_ocupacional	= ie_saude_ocupacional_w,
				ie_regime_atendimento   = ie_regime_atendimento_w,
				ie_regime_atendimento_princ = ie_regime_atendimento_princ_w
			where	nr_sequencia	= nr_seq_regra_w;
		end if;
		end;
	end loop;
	close C01;
	
elsif (ie_opcao_p = 'D') then
	open C02;
	loop
	fetch C02 into	
		nr_seq_regra_w;
	EXIT WHEN NOT FOUND; /* apply on C02 */
		begin
			delete	FROM pls_regra_preco_servico
			where	nr_sequencia	= nr_seq_regra_w;
		end;
	end loop;
	close C02;
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_atualizar_regra_preco_serv ( nr_seq_regra_p bigint, ie_opcao_p text, cd_estabelecimento_p bigint, nm_usuario_p text) FROM PUBLIC;

