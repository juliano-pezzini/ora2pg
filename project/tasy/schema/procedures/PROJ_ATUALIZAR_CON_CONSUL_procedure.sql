-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE proj_atualizar_con_consul ( nm_usuario_p text, nr_seq_etapa_p bigint, nr_seq_funcao_p bigint) AS $body$
DECLARE

 
cd_consultor_w			varchar(10);
nr_seq_conhec_w			bigint;
pr_conhecimento_w		smallint;
pr_conhec_w				smallint;
nr_seq_conhec_padrao_w	bigint;
nr_seq_modulo_w			bigint;
nr_consultor_w			varchar(10);
nr_seq_consultor_w		bigint;
nr_seq_gest_con_w		bigint;

C01 CURSOR FOR 
	SELECT	substr(proj_obter_dados_equipe_papel(nr_seq_equipe_papel,'C'),1,10) 
	from	proj_cron_etapa_equipe 
	where	nr_seq_etapa_cron = nr_seq_etapa_p;


BEGIN 
open C01;
loop 
fetch C01 into	 
	cd_consultor_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin 
	if (obter_se_consultor(cd_consultor_w) = 'S') then 
		begin 
		select	max(a.nr_sequencia) 
		into STRICT	nr_seq_consultor_w 
		from	proj_gestao_conhecimento a;
 
		select	max(a.nr_sequencia) 
		into STRICT	nr_seq_gest_con_w 
		from	com_canal_consultor a, 
			pessoa_fisica b 
		where	a.cd_pessoa_fisica = b.cd_pessoa_fisica 
		and	a.cd_pessoa_fisica = cd_consultor_w;
		 
		select	distinct 
			coalesce(max(a.nr_seq_conhec_padrao),0) 
		into STRICT	nr_seq_conhec_w 
		from	com_cons_gest_con_fun a, 
			com_cons_gest_con_mod b 
		where	a.cd_funcao = nr_seq_funcao_p 
		and	b.nr_sequencia = a.nr_seq_conhecimento 
		and	b.nr_seq_consultor = nr_seq_consultor_w 
		and	b.nr_seq_gest_con = nr_seq_gest_con_w;
 
		select	distinct 
				coalesce(max(pr_conhecimento),0) 
		into STRICT	pr_conhecimento_w 
		from	proj_conhec_padrao 
		where	nr_sequencia = nr_seq_conhec_w;
 
		if (obter_dados_alter_con_cons('E','PR') > pr_conhecimento_w) then 
			begin 
			select	coalesce(obter_dados_alter_con_cons('E','NR'),0) 
			into STRICT	nr_seq_conhec_padrao_w 
			;
 
			select	coalesce(obter_dados_alter_con_cons('E','PR'),0) 
			into STRICT	pr_conhec_w 
			;
 
			select	proj_obter_dados_consultor(cd_consultor_w,'NR') 
			into STRICT	nr_consultor_w 
			;
			 
			select	distinct 
					max(a.nr_sequencia) 
			into STRICT	nr_seq_modulo_w 
			from	com_cons_gest_con_mod a, 
					com_cons_gest_con_fun b 
			where	a.nr_sequencia = b.nr_seq_conhecimento 
			and		a.nr_seq_consultor = nr_consultor_w 
			and		b.cd_funcao = nr_seq_funcao_p;
 
			if (nr_seq_conhec_padrao_w <> 0) then 
				begin 
				update	com_cons_gest_con_fun 
				set		nr_seq_conhec_padrao = nr_seq_conhec_padrao_w, 
						pr_conhecimento = pr_conhec_w, 
						nm_usuario = nm_usuario_p, 
						dt_atualizacao = clock_timestamp() 
				where	cd_funcao = nr_seq_funcao_p 
				and		nr_seq_conhecimento = nr_seq_modulo_w;
				end;
			end if;
			end;
		end if;
		end;
	end if;
	end;
end loop;
close C01;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE proj_atualizar_con_consul ( nm_usuario_p text, nr_seq_etapa_p bigint, nr_seq_funcao_p bigint) FROM PUBLIC;

