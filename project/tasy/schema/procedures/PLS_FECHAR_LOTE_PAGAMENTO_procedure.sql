-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_fechar_lote_pagamento ( nr_seq_lote_p bigint, nm_usuario_p text) AS $body$
DECLARE

 
ds_erro_w			varchar(4000);
ie_baixar_tit_rec_w			pls_parametro_pagamento.ie_baixar_tit_rec%type;
cd_estabelecimento_w		pls_parametro_pagamento.cd_estabelecimento%type;
ie_baixar_tit_pagar_w		pls_parametro_pagamento.ie_baixar_tit_pagar%type;


BEGIN 
 
ds_erro_w := pls_obter_se_franq_pag_ok(nr_seq_lote_p, ds_erro_w, nm_usuario_p);
if (ds_erro_w IS NOT NULL AND ds_erro_w::text <> '') then 
	CALL wheb_mensagem_pck.exibir_mensagem_abort(282997, 'MENSAGEM=' || ds_erro_w);
end if;
 
select	cd_estabelecimento 
into STRICT	cd_estabelecimento_w 
from	pls_lote_pagamento 
where	nr_sequencia	= nr_seq_lote_p;
 
select	coalesce(max(ie_baixar_tit_rec), 'N'), 
	coalesce(max(ie_baixar_tit_pagar), 'N') 
into STRICT	ie_baixar_tit_rec_w, 
	ie_baixar_tit_pagar_w 
from	pls_parametro_pagamento 
where	cd_estabelecimento	 = cd_estabelecimento_w;
 
if (ie_baixar_tit_rec_w = 'S') then 
	pls_baixar_tit_rec_lote_pag(nr_seq_lote_p, null, 'F', nm_usuario_p);
end if;
 
if (ie_baixar_tit_pagar_w = 'S') then 
	CALL pls_baixar_tit_pagar_lote_pag(nr_seq_lote_p, null, 'F', nm_usuario_p);
end if;
 
update	pls_lote_pagamento 
set	ie_status		= 'D', 
	dt_fechamento		= clock_timestamp(), 
	nm_usuario_fechamento	= nm_usuario_p 
where	nr_sequencia		= nr_seq_lote_p;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_fechar_lote_pagamento ( nr_seq_lote_p bigint, nm_usuario_p text) FROM PUBLIC;

