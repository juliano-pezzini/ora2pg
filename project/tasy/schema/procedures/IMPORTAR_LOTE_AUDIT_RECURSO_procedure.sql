-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE importar_lote_audit_recurso (nr_seq_lote_recurso_p bigint, nr_seq_lote_audit_p bigint, nm_usuario_p text) AS $body$
DECLARE


dt_final_w		timestamp;
dt_inicial_w		timestamp;
dt_ret_previsto_w		timestamp;
nm_usuario_resp_w	varchar(15);
qt_lotes_recurso_w	bigint;
nr_seq_lote_hist_w	bigint;
cd_autorizacao_w		varchar(20);
nr_interno_conta_w	bigint;
nr_seq_lote_guia_w	bigint;
nr_seq_conpaci_ret_w	bigint;
cd_motivo_glosa_w	integer;
cd_resposta_w		bigint;
cd_setor_responsavel_w	integer;
ie_acao_glosa_w		varchar(1);
nr_seq_matpaci_w		bigint;
nr_seq_propaci_w		bigint;
nr_seq_ret_glosa_w	bigint;
nr_seq_ret_item_w		bigint;
qt_item_w		double precision;
vl_amenor_w		double precision;
nr_seq_retorno_w		bigint;

c01 CURSOR FOR
SELECT	distinct
	b.cd_autorizacao,
	b.nr_interno_conta,
	b.nr_sequencia
from	conta_paciente_retorno b,
	conta_paciente_ret_hist a
where	a.nr_seq_lote_recurso	= nr_seq_lote_recurso_p
and	a.nr_seq_conpaci_ret	= b.nr_sequencia;

/* agrupar os itens por conta */

c02 CURSOR FOR
SELECT	c.cd_motivo_glosa,
	c.cd_resposta,
	c.cd_setor_responsavel,
	coalesce(c.ie_acao_glosa,d.ie_acao_glosa),
	c.nr_seq_matpaci,
	c.nr_seq_propaci,
	c.nr_sequencia,
	c.nr_seq_ret_item,
	c.qt_glosa,
	sum(a.vl_historico)
FROM conta_paciente_retorno b, conta_paciente_ret_hist a, convenio_retorno_glosa c
LEFT OUTER JOIN motivo_glosa d ON (c.cd_motivo_glosa = d.cd_motivo_glosa)
WHERE a.nr_seq_lote_recurso		= nr_seq_lote_recurso_p and a.nr_seq_conpaci_ret		= b.nr_sequencia and b.nr_interno_conta			= nr_interno_conta_w and a.nr_sequencia			= c.nr_seq_conpaci_ret_hist  group by	c.cd_motivo_glosa,
	c.cd_resposta,
	c.cd_setor_responsavel,
	coalesce(c.ie_acao_glosa,d.ie_acao_glosa),
	c.nr_seq_matpaci,
	c.nr_seq_propaci,
	c.nr_sequencia,
	c.nr_seq_ret_item,
	c.qt_glosa;


BEGIN

select	a.nr_seq_retorno
into STRICT	nr_seq_retorno_w
from	lote_auditoria a
where	a.nr_sequencia	= nr_seq_lote_audit_p;

select	count(*),
	max(a.dt_final),
	max(a.dt_inicial),
	max(a.dt_prev_retorno),
	coalesce(max(a.nm_usuario_resp),nm_usuario_p)
into STRICT	qt_lotes_recurso_w,
	dt_final_w,
	dt_inicial_w,
	dt_ret_previsto_w,
	nm_usuario_resp_w
from	lote_audit_recurso a
where	a.nr_sequencia	= nr_seq_lote_recurso_p
and	a.ie_situacao_lote	<> 'E';

if (qt_lotes_recurso_w > 0) then

	select	nextval('lote_audit_hist_seq')
	into STRICT	nr_seq_lote_hist_w
	;

	insert	into lote_audit_hist(ds_observacao,
		dt_atualizacao,
		dt_final,
		dt_inicial,
		dt_lote,
		dt_ret_previsto,
		ie_status,
		nm_usuario,
		nm_usuario_resp,
		nr_analise,
		nr_seq_lote_audit,
		nr_sequencia,
		vl_glosa,
		vl_recurso,
		vl_pago)
	values (substr(wheb_mensagem_pck.get_texto(313414,'NR_SEQ_LOTE_RECURSO=' || nr_seq_lote_recurso_p),1,255),
		clock_timestamp(),
		dt_final_w,
		clock_timestamp(),
		dt_inicial_w,
		dt_ret_previsto_w,
		'A',
		nm_usuario_p,
		nm_usuario_resp_w,
		1,
		nr_seq_lote_audit_p,
		nr_seq_lote_hist_w,
		0,
		0,
		0);

	open c01;
	loop
	fetch c01 into
		cd_autorizacao_w,
		nr_interno_conta_w,
		nr_seq_conpaci_ret_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */

		select	nextval('lote_audit_hist_guia_seq')
		into STRICT	nr_seq_lote_guia_w
		;

		insert	into lote_audit_hist_guia(cd_autorizacao,
			dt_atualizacao,
			nm_usuario,
			nr_interno_conta,
			nr_seq_lote_hist,
			nr_sequencia)
		values (cd_autorizacao_w,
			clock_timestamp(),
			nm_usuario_p,
			nr_interno_conta_w,
			nr_seq_lote_hist_w,
			nr_seq_lote_guia_w);

		open c02;
		loop
		fetch c02 into
			cd_motivo_glosa_w,
			cd_resposta_w,
			cd_setor_responsavel_w,
			ie_acao_glosa_w,
			nr_seq_matpaci_w,
			nr_seq_propaci_w,
			nr_seq_ret_glosa_w,
			nr_seq_ret_item_w,
			qt_item_w,
			vl_amenor_w;
		EXIT WHEN NOT FOUND; /* apply on c02 */

			insert	into lote_audit_hist_item(cd_motivo_glosa,
				cd_resposta,
				cd_setor_responsavel,
				ds_observacao,
				dt_atualizacao,
				dt_historico,
				ie_acao_glosa,
				nm_usuario,
				nr_seq_conpaci_ret,
				nr_seq_guia,
				nr_seq_lote,
				nr_seq_matpaci,
				nr_seq_propaci,
				nr_seq_ret_glosa,
				nr_seq_ret_item,
				nr_sequencia,
				qt_item,
				vl_amenor,
				vl_glosa,
				vl_pago,
				vl_saldo)
			values (cd_motivo_glosa_w,
				cd_resposta_w,
				cd_setor_responsavel_w,
				substr(wheb_mensagem_pck.get_texto(313416,'NR_SEQ_LOTE_RECURSO=' || nr_seq_lote_recurso_p),1,255),
				clock_timestamp(),
				clock_timestamp(),
				ie_acao_glosa_w,
				nm_usuario_p,
				nr_seq_conpaci_ret_w,
				nr_seq_lote_guia_w,
				nr_seq_lote_hist_w,
				nr_seq_matpaci_w,
				nr_seq_propaci_w,
				nr_seq_ret_glosa_w,
				nr_seq_ret_item_w,
				nextval('lote_audit_hist_item_seq'),
				qt_item_w,
				vl_amenor_w,
				0,
				0,
				vl_amenor_w);

		end loop;
		close c02;

	end loop;
	close c01;

	commit;

end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE importar_lote_audit_recurso (nr_seq_lote_recurso_p bigint, nr_seq_lote_audit_p bigint, nm_usuario_p text) FROM PUBLIC;

