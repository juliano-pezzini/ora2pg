-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_terceiro (cd_pessoa_fisica_p text, -- afstringari 201032 11/03/2010
 cd_estabelecimento_p bigint, nm_usuario_p text) AS $body$
DECLARE


nr_seq_terceiro_w		bigint;
qt_terceiro_cad_w		bigint;
cd_barras_w		varchar(40);
cd_convenio_w		integer;
cd_categoria_w		varchar(10);
ie_funcionario_w	varchar(03);
qt_reg_w			bigint;
cd_conta_contabil_w	varchar(20);


BEGIN

select	max(ie_funcionario)
into STRICT	ie_funcionario_w
from 	pessoa_fisica
where	cd_pessoa_fisica = cd_pessoa_fisica_p;


select	coalesce(count(*),0)
into STRICT	qt_terceiro_cad_w
from	terceiro
where	cd_pessoa_fisica	= cd_pessoa_fisica_p
and	cd_estabelecimento 	= cd_estabelecimento_p;

if (coalesce(qt_terceiro_cad_w,0) > 0) then
	--r.aise_application_error(-20011, 'Já existe um terceiro cadastrado para esta pessoa física!');
	CALL wheb_mensagem_pck.exibir_mensagem_abort(267411);
end if;

select	nextval('terceiro_seq')
into STRICT	nr_seq_terceiro_w
;

select	max(a.cd_barras) -- afstringari 201032 11/03/2010
into STRICT	cd_barras_w
from	usuario a
where	a.cd_pessoa_fisica	= cd_pessoa_fisica_p;

if (coalesce(cd_barras_w,'0') = '0') then
	select	max(a.cd_funcionario) -- afstringari 201032 11/03/2010
	into STRICT	cd_barras_w
	from	pessoa_fisica a
	where	a.cd_pessoa_fisica	= cd_pessoa_fisica_p;
end if;

cd_convenio_w := obter_param_usuario(230, 36, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, cd_convenio_w);
cd_categoria_w := obter_param_usuario(230, 37, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, cd_categoria_w);
cd_conta_contabil_w := obter_param_usuario(230, 46, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, cd_conta_contabil_w);

insert into terceiro(nr_sequencia,
	dt_atualizacao,
	nm_usuario,
	cd_pessoa_fisica,
	ie_situacao,
	cd_estabelecimento,
	ie_utilizacao,
	ie_gerar_tit_rec,
	cd_barras,
	cd_convenio,
	cd_categoria,
	cd_conta_contabil)
values (nr_seq_terceiro_w,
	clock_timestamp(),
	nm_usuario_p,
	cd_pessoa_fisica_p,
	'A',
	cd_estabelecimento_p,
	'C',
	'S',
	cd_barras_w,
	cd_convenio_w,
	cd_categoria_w,
	cd_conta_contabil_w);

if (ie_funcionario_w = 'S') then
	begin

	select	count(*)
	into STRICT	qt_reg_w
	from	TERCEIRO_PESSOA_FISICA
	where	cd_pessoa_fisica	= cd_pessoa_fisica_p;

	if (qt_reg_w	= 0) then
		begin
		insert into TERCEIRO_PESSOA_FISICA(NR_SEQ_TERCEIRO,
				CD_PESSOA_FISICA ,
				DT_ATUALIZACAO ,
				NM_USUARIO ,
				DT_ATUALIZACAO_NREC,
				NM_USUARIO_NREC,
				DS_OBSERVACAO,
				DT_INICIO_VIGENCIA ,
				DT_FIM_VIGENCIA,
				IE_RESP_TERCEIRO,
				CD_BARRAS,
				IE_REPASSE)
			SELECT	nr_seq_terceiro_w,
				cd_pessoa_fisica_p,
				clock_timestamp(),
				nm_usuario_p,
				clock_timestamp(),
				nm_usuario_p,
				null,
				null,
				null,
				'N',
				null,
				'S'
			;
		end;
	end if;

	end;
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_terceiro (cd_pessoa_fisica_p text, cd_estabelecimento_p bigint, nm_usuario_p text) FROM PUBLIC;

