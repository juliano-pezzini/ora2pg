-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_gerar_lote_analise_disc ( nr_seq_lote_discussao_p bigint, nm_usuario_p text) AS $body$
DECLARE

 
cd_unimed_origem_w		varchar(4);
nr_seq_lote_protocolo_w		bigint;
nr_seq_congenere_w		bigint	:= null;
nr_seq_ptu_fatura_w		bigint;
nr_seq_lote_conta_w		bigint;
nr_seq_lote_contest_w		bigint;
cd_estabelecimento_w		smallint;
ie_tipo_arquivo_w		integer;


BEGIN 
if (nr_seq_lote_discussao_p IS NOT NULL AND nr_seq_lote_discussao_p::text <> '') then 
	select	b.cd_estabelecimento, 
		b.nr_seq_ptu_fatura, 
		b.nr_sequencia, 
		a.ie_tipo_arquivo 
	into STRICT	cd_estabelecimento_w, 
		nr_seq_ptu_fatura_w, 
		nr_seq_lote_contest_w, 
		ie_tipo_arquivo_w 
	from	pls_lote_contestacao b, 
		pls_lote_discussao a 
	where	a.nr_seq_lote_contest	= b.nr_sequencia 
	and	a.nr_sequencia		= nr_seq_lote_discussao_p;
	 
	if (coalesce(ie_tipo_arquivo_w::text, '') = '') then 
		select	max(ie_tipo_arquivo) 
		into STRICT	ie_tipo_arquivo_w 
		from	ptu_camara_contestacao 
		where	nr_seq_lote_contest = nr_seq_lote_contest_w;
	end if;
	 
	if (nr_seq_ptu_fatura_w IS NOT NULL AND nr_seq_ptu_fatura_w::text <> '') then 
		select	a.cd_unimed_origem 
		into STRICT	cd_unimed_origem_w 
		from	ptu_fatura a 
		where	a.nr_sequencia	= nr_seq_ptu_fatura_w;
		 
		begin 
		select	max(nr_sequencia) 
		into STRICT	nr_seq_congenere_w 
		from	pls_congenere 
		where	cd_cooperativa	= cd_unimed_origem_w;
		exception 
		when others then 
			begin 
			select	max(nr_sequencia) 
			into STRICT	nr_seq_congenere_w 
			from	pls_congenere 
			where	somente_numero(cd_cooperativa)	= somente_numero(cd_unimed_origem_w);
			exception 
			when others then 
				nr_seq_congenere_w := null;
			end;
		end;
		 
		if (coalesce(nr_seq_congenere_w::text, '') = '') then 
			begin 
			select	max(nr_sequencia) 
			into STRICT	nr_seq_congenere_w 
			from	pls_congenere 
			where	cd_cooperativa	= substr(cd_unimed_origem_w,2,3);
			exception 
			when others then 
				begin 
				select	max(nr_sequencia) 
				into STRICT	nr_seq_congenere_w 
				from	pls_congenere 
				where	somente_numero(cd_cooperativa)	= somente_numero(cd_unimed_origem_w);
				exception 
				when others then 
					nr_seq_congenere_w := null;
				end;
			end;
		end if;
	end if;
	 
	select	nextval('pls_lote_protocolo_conta_seq') 
	into STRICT	nr_seq_lote_protocolo_w 
	;
	 
	insert	into pls_lote_protocolo_conta(nr_sequencia, 
		dt_atualizacao, 
		dt_atualizacao_nrec, 
		nm_usuario, 
		nm_usuario_nrec, 
		dt_lote, 
		nr_seq_congenere, 
		ie_tipo_lote, 
		cd_estabelecimento, 
		ie_origem_analise)		 
	values (nr_seq_lote_protocolo_w, 
		clock_timestamp(), 
		clock_timestamp(), 
		nm_usuario_p, 
		nm_usuario_p, 
		clock_timestamp(), 
		nr_seq_congenere_w, 
		'I', 
		cd_estabelecimento_w, 
		5);
		 
	update	pls_lote_discussao 
	set	nr_seq_lote_conta	= nr_seq_lote_protocolo_w 
	where	nr_sequencia		= nr_seq_lote_discussao_p;
	 
	CALL pls_gerar_analise_lote(nr_seq_lote_protocolo_w,'N','N',cd_estabelecimento_w,nm_usuario_p,null,null,'');
	 
	-- Mudar status do lote para Em análise 
	update	pls_lote_discussao 
	set	ie_status	= 'AN' 
	where	nr_sequencia	= nr_seq_lote_discussao_p;
	 
	if (ie_tipo_arquivo_w in (2,3,4,5,6,7,8)) then -- Não é preciso fazer análise destas informações, por isso ATENDIMENTO ENCERRADO 
		update	pls_analise_conta 
		set	ie_status		= 'T' 
		where	nr_seq_lote_protocolo	= nr_seq_lote_protocolo_w;
	else -- OS 705451 -- wcbernardino -- Se for gerada análise e já tiver grupo de auditor, a análide deve ficar com o Status 'Aguardando auditoria' 
		update	pls_analise_conta	a 
		set	a.ie_status		= 'G' 
		where	a.nr_seq_lote_protocolo	= nr_seq_lote_protocolo_w 
		and	exists (SELECT	1 
				from	pls_auditoria_conta_grupo	x 
				where	x.nr_seq_analise 		= a.nr_sequencia);	
	end if;
end if;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_gerar_lote_analise_disc ( nr_seq_lote_discussao_p bigint, nm_usuario_p text) FROM PUBLIC;

