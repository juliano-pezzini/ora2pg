-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE vincular_diag_results ( NR_SEQ_DIAG_P pe_prescr_diag.nr_seq_diag%TYPE, NR_SEQ_PRESC_P pe_prescricao.nr_sequencia%TYPE, nm_usuario_p text ) AS $body$
DECLARE

    count_reg_w bigint := 0;
    nr_seq_diagnostico_w pe_prescr_diag.nr_sequencia%TYPE;
    nr_seq_result_w pe_result_item_diag.NR_SEQUENCIA%TYPE;
    cur_01 CURSOR FOR    SELECT
                            a.NR_SEQUENCIA NR_SEQ_RESULT, c.NR_SEQUENCIA
                        FROM pe_prescr_item_result a 
                        INNER JOIN pe_result_item_diag b ON
                            b.nr_seq_result = a.nr_seq_result
                        INNER JOIN pe_prescr_diag c ON
                            c.NR_SEQ_DIAG = b.NR_SEQ_DIAG AND
                            c.NR_SEQ_PRESCR = a.nr_seq_prescr
                        WHERE
                            a.nr_seq_prescr = NR_SEQ_PRESC_P AND
                            c.NR_SEQ_DIAG  = NR_SEQ_DIAG_P;

BEGIN

    open cur_01;
    loop fetch cur_01 into nr_seq_result_w, nr_seq_diagnostico_w;
    EXIT WHEN NOT FOUND; /* apply on cur_01 */
        begin

            SELECT COUNT(1) 
            INTO STRICT count_reg_w 
            FROM pe_prescr_item_result_diag a 
            WHERE a.NR_SEQ_DIAG = nr_seq_diagnostico_w AND
                  a.NR_SEQ_ITEM = nr_seq_result_w;

            IF (count_reg_w = 0) THEN 
                INSERT INTO pe_prescr_item_result_diag a(NR_SEQUENCIA, NR_SEQ_DIAG,NR_SEQ_ITEM, DT_ATUALIZACAO, NM_USUARIO)
                VALUES (nextval('pe_prescr_item_result_diag_seq'),nr_seq_diagnostico_w,nr_seq_result_w,clock_timestamp(),nm_usuario_p);

            END IF;
        end;
    end loop;
    close cur_01;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE vincular_diag_results ( NR_SEQ_DIAG_P pe_prescr_diag.nr_seq_diag%TYPE, NR_SEQ_PRESC_P pe_prescricao.nr_sequencia%TYPE, nm_usuario_p text ) FROM PUBLIC;

