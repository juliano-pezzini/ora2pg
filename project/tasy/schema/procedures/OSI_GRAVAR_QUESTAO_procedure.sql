-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE osi_gravar_questao ( nr_OS_p bigint, nr_seq_modelo_conteudo_p bigint, ds_respostas_p text, nm_usuario_p text) AS $body$
DECLARE


nr_seq_osi_questao_os_w		osi_questao_os.nr_sequencia%type;
ind_w				bigint;
aux_w				varchar(255);
ds_respostas_w			varchar(255);


BEGIN

ds_respostas_w	:= ds_respostas_p;
if (length(ds_respostas_w) > 0) and (substr(ds_respostas_w, length(ds_respostas_w), 1) <> ';') then
	ds_respostas_w := ds_respostas_w || ';';
end if;

select	nextval('osi_questao_os_seq')
into STRICT	nr_seq_osi_questao_os_w
;

insert into osi_questao_os(
	nr_sequencia,
	dt_atualizacao,
	nm_usuario,
	dt_atualizacao_nrec,
	nm_usuario_nrec,
	nr_seq_ordem,
	nr_seq_modelo_conteudo_os)
values (
	nr_seq_osi_questao_os_w,
	clock_timestamp(),
	nm_usuario_p,
	clock_timestamp(),
	nm_usuario_p,
	nr_OS_p,
	nr_seq_modelo_conteudo_p);

for ind_w in 1..length(ds_respostas_p) loop
	if (substr(ds_respostas_p,ind_w,1) = ';') then
		if (aux_w IS NOT NULL AND aux_w::text <> '') then
			insert into osi_questao_os_respostas(
				nr_sequencia,
				dt_atualizacao,
				nm_usuario,
				dt_atualizacao_nrec,
				nm_usuario_nrec,
				nr_seq_osi_questao_os,
				nr_seq_pergunta_result_os)
			values (
				nextval('osi_questao_os_respostas_seq'),
				clock_timestamp(),
				nm_usuario_p,
				clock_timestamp(),
				nm_usuario_p,
				nr_seq_osi_questao_os_w,
				aux_w);
		end if;
		aux_w							:= '';
	else
		aux_w := aux_w || substr(ds_respostas_p,ind_w,1);
	end if;
end loop;

commit;

--osi_definir_classif_os(nr_OS_p, nm_usuario_p); esta procedure Ã© chamada na function OSI_obter_proxima_questao
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE osi_gravar_questao ( nr_OS_p bigint, nr_seq_modelo_conteudo_p bigint, ds_respostas_p text, nm_usuario_p text) FROM PUBLIC;

