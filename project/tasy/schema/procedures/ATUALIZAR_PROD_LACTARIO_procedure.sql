-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE atualizar_prod_lactario ( nr_seq_prod_princ_p bigint, ie_opcao_p text, nm_usuario_p text) AS $body$
DECLARE


/*
IE_OPCAO_P:
C = Cancelado
E = Em produção
F = Produzindo
P = Pendente
V = Conferido
*/
		
ie_valor_parametro_w    varchar(2) := 'S';
		

BEGIN

-- Adicionar os itens na conta do paciente ao finalizar a produção do lactário.
ie_valor_parametro_w := obter_valor_param_usuario(1003, 119, obter_perfil_ativo, nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento);

if (ie_opcao_p = 'E')then
	update	nut_prod_principal
	set	ie_status = 'E',
		nm_usuario = nm_usuario_p,
		dt_atualizacao = clock_timestamp(),
    		NM_USUARIO_INI_PROD = nm_usuario_p,
    		DT_INICIO_PRODUCAO = clock_timestamp()
	where	nr_sequencia = nr_seq_prod_princ_p;
elsif (ie_opcao_p = 'F') then

        	if (ie_valor_parametro_w = 'S')then
        		CALL Buscar_prescr_pac(nr_seq_prod_princ_p,'C');
  	end if;

	update	nut_prod_principal
	set	ie_status = 'F',
		dt_producao = clock_timestamp(),
		nm_usuario = nm_usuario_p,
		dt_atualizacao = clock_timestamp()
	where	nr_sequencia = nr_seq_prod_princ_p;
	
	if (ie_valor_parametro_w = 'S')then
        		CALL Buscar_prescr_pac(nr_seq_prod_princ_p,'');
  	end if;
	
elsif (ie_opcao_p = 'C') then
	update	nut_prod_principal
	set	ie_status = 'C',
		dt_cancelamento = clock_timestamp(),
		nm_usuario = nm_usuario_p,
		dt_atualizacao = clock_timestamp(),
    		NM_USUARIO_CANCEL = nm_usuario_p
	where	nr_sequencia = nr_seq_prod_princ_p;
elsif (ie_opcao_p = 'V') then
	update	nut_prod_principal
	set	ie_status = 'V',		
		nm_usuario = nm_usuario_p,
		dt_atualizacao = clock_timestamp()
	where	nr_sequencia = nr_seq_prod_princ_p;
end if;

commit;				

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE atualizar_prod_lactario ( nr_seq_prod_princ_p bigint, ie_opcao_p text, nm_usuario_p text) FROM PUBLIC;

