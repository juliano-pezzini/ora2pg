-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_consistir_prog_reajuste ( nr_seq_prog_reaj_p bigint, nr_seq_tipo_reajuste_p bigint, nr_seq_contrato_p bigint, dt_mes_reajuste_p timestamp, ie_reajustar_inscricao_p text, ie_commit_p text, nm_usuario_p text) AS $body$
DECLARE



nr_seq_indice_reajuste_w	bigint;
ie_indice_contrato_w		varchar(1);
ie_manual_w			varchar(1);
vl_cotacao_w			cotacao_moeda.vl_cotacao%type;
tx_reajuste_programado_w	double precision;
nr_contrato_w			pls_contrato.nr_contrato%type;


BEGIN

if (coalesce(nr_seq_tipo_reajuste_p,0) <> 0) then
	begin
	select	nr_seq_indice_reajuste,
		ie_indice_contrato,
		ie_manual
	into STRICT	nr_seq_indice_reajuste_w,
		ie_indice_contrato_w,
		ie_manual_w
	from	pls_tipo_reajuste	a,
		pls_tipo_reajuste_regra	b
	where	b.nr_seq_regra	= a.nr_sequencia
	and	a.nr_sequencia	= nr_seq_tipo_reajuste_p;
	exception
	when others then
		nr_seq_indice_reajuste_w	:= null;
		ie_indice_contrato_w		:= null;
		ie_manual_w			:= null;
	end;

	if (ie_manual_w = 'S') then
		select	tx_reajuste_programado
		into STRICT	tx_reajuste_programado_w
		from	pls_prog_reaj_coletivo		a
		where	a.nr_sequencia	= nr_seq_prog_reaj_p;

		if (coalesce(ie_reajustar_inscricao_p,'N') <> 'N') then
			update	pls_prog_reaj_coletivo
			set	tx_reajuste_inscricao	= tx_reajuste_programado_w
			where	nr_sequencia	= nr_seq_prog_reaj_p;
		end if;
	end if;

	if (ie_indice_contrato_w = 'S') then
		select	coalesce(nr_seq_indice_reajuste,nr_seq_indice_reajuste_w),
			nr_contrato
		into STRICT	nr_seq_indice_reajuste_w,
			nr_contrato_w
		from	pls_contrato
		where	nr_sequencia	= nr_seq_contrato_p;

		if (coalesce(nr_seq_indice_reajuste_w,0) = 0) then
			CALL wheb_mensagem_pck.exibir_mensagem_abort(293637,'NR_CONTRATO='||nr_contrato_w);
			--Mensagem: Não foi informado o índice de reajuste para o contrato. Favor verifique!
		end if;
	end if;

	if (coalesce(nr_seq_indice_reajuste_w,0) <> 0) then
		select	max(vl_cotacao)
		into STRICT	vl_cotacao_w
		from	moeda		a,
			cotacao_moeda	b
		where	a.cd_moeda	= nr_seq_indice_reajuste_w
		and	a.cd_moeda	= b.cd_moeda
		and	trunc(b.dt_cotacao, 'month')	= trunc(dt_mes_reajuste_p, 'month');

		if (coalesce(vl_cotacao_w,0) = 0) then
			begin
			select	max(vl_cotacao)
			into STRICT	vl_cotacao_w
			from	moeda		a,
				cotacao_moeda	b
			where	a.cd_moeda	= nr_seq_indice_reajuste_w
			and	a.cd_moeda	= b.cd_moeda
			and	b.dt_cotacao	= (	SELECT	max(x.dt_cotacao)
							from	cotacao_moeda x
							where	x.cd_moeda	= a.cd_moeda
							and	trunc(x.dt_cotacao, 'month')	< trunc(dt_mes_reajuste_p, 'month'));
			exception
			when others then
				CALL wheb_mensagem_pck.exibir_mensagem_abort(293638);
				--Verifique se o índice foi informado no cadastro de moedas. (Shift + F11 -> Aplicação Principal -> Cadastros Gerais -> Moedas).
			end;
		end if;

		if (coalesce(ie_reajustar_inscricao_p,'N') <> 'N') then
			update	pls_prog_reaj_coletivo
			set	tx_reajuste_inscricao	= vl_cotacao_w
			where	nr_sequencia		= nr_seq_prog_reaj_p;
		end if;

		if (coalesce(vl_cotacao_w,0) <> 0) then
			update	pls_prog_reaj_coletivo
			set	tx_reajuste_programado	= vl_cotacao_w
			where	nr_sequencia		= nr_seq_prog_reaj_p;
		end if;
	end if;
end if;

if (coalesce(ie_commit_p,'S') = 'S') then
	commit;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_consistir_prog_reajuste ( nr_seq_prog_reaj_p bigint, nr_seq_tipo_reajuste_p bigint, nr_seq_contrato_p bigint, dt_mes_reajuste_p timestamp, ie_reajustar_inscricao_p text, ie_commit_p text, nm_usuario_p text) FROM PUBLIC;

