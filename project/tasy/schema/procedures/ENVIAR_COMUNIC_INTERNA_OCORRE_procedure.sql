-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE enviar_comunic_interna_ocorre ( cd_pessoa_fisica_p text, nr_ocorrencia_p bigint, ds_ocorrencia_p text, ie_tipo_ocorrencia_p text, cd_setor_atendimento_p bigint) AS $body$
DECLARE


ds_tipo_ocorrencia_w		varchar(255);
ds_pos_inicio_rtf_w		bigint;
ds_ocorrencia_w 		varchar(32000) := '';
ds_ocorrencia_ww 		varchar(32000) := '';
ds_setor_destino_w		varchar(4000) := '';
cd_setor_w			integer;
ds_usuarios_destino_w		varchar(4000) := '';
nm_usuario_w			varchar(255);
ds_perfil_destino_w		varchar(4000):= '';
cd_perfil_w			integer;
ds_quebra_w 			varchar(10);
nr_seq_rtf_srtring_w			bigint;
ci_nextval_w		bigint;
is_long_w			boolean := false;
ds_ocorrencia_body_w 		varchar(32000) := '';
nr_pos_fim_cabecalho		bigint := 0;

C01 CURSOR FOR
	SELECT	ds_ocorrencia
	from	ocorrencia
	where	nr_ocorrencia	= nr_ocorrencia_p;
	
c01_w c01%rowtype;

C02 CURSOR FOR
	SELECT	cd_setor_atendimento
	from 	tipo_ocor_turno_comunic 
	where 	cd_tipo_ocorrencia = ie_tipo_ocorrencia_p
	and	coalesce(nm_usuario_comunic::text, '') = ''
	and	(cd_setor_atendimento IS NOT NULL AND cd_setor_atendimento::text <> '');
	
C03 CURSOR FOR
	SELECT	nm_usuario_comunic
	from 	tipo_ocor_turno_comunic 
	where 	cd_tipo_ocorrencia = ie_tipo_ocorrencia_p
	and	(nm_usuario_comunic IS NOT NULL AND nm_usuario_comunic::text <> '');

C04 CURSOR FOR
	SELECT	cd_perfil
	from 	tipo_ocor_turno_comunic 
	where 	cd_tipo_ocorrencia = ie_tipo_ocorrencia_p
	and	coalesce(nm_usuario_comunic::text, '') = ''
	and	coalesce(cd_setor_atendimento::text, '') = '';	

														

BEGIN

select 	ds_tipo_ocorrencia
into STRICT	ds_tipo_ocorrencia_w
from	tipo_ocorrencia_turno
where	cd_tipo_ocorrencia = ie_tipo_ocorrencia_p;

cd_setor_w	:= cd_Setor_atendimento_p;
ds_quebra_w := wheb_rtf_pck.get_quebra_linha;
	
open C02;
	loop
	fetch C02 into	
		cd_setor_w;
	EXIT WHEN NOT FOUND; /* apply on C02 */
		begin
		ds_setor_destino_w	:= ds_setor_destino_w || ',' || cd_setor_w;
		end;
	end loop;
close C02;

open C03;
	loop
	fetch C03 into	
		nm_usuario_w;
	EXIT WHEN NOT FOUND; /* apply on C03 */
		begin
		if (coalesce(ds_usuarios_destino_w::text, '') = '') then
			ds_usuarios_destino_w	:= nm_usuario_w||',';
		else
			ds_usuarios_destino_w	:= ds_usuarios_destino_w ||nm_usuario_w||',';
		end if;
		end;
	end loop;
close C03;

open C04;
	loop
	fetch C04 into	
		cd_perfil_w;
	EXIT WHEN NOT FOUND; /* apply on C04 */
		begin
		ds_perfil_destino_w	:= ds_perfil_destino_w || ',' || cd_perfil_w;
		end;
	end loop;
close C04;

begin
	open C01;
	loop
	fetch C01 into	
		c01_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin
		ds_ocorrencia_w	:= c01_w.ds_ocorrencia;
		end;
	end loop;
	close C01;

exception
	when others then
	is_long_w := true;
	
end;

select 	nextval('comunic_interna_seq')
into STRICT 	ci_nextval_w
;

if (is_long_w = false) then
	if (ds_ocorrencia_w IS NOT NULL AND ds_ocorrencia_w::text <> '') then

			ds_pos_inicio_rtf_w := position('rtf1' in ds_ocorrencia_w)+4;
			
			if (ds_pos_inicio_rtf_w = 0) then

				ds_ocorrencia_ww	:= wheb_rtf_pck.get_cabecalho;

				begin
				nr_seq_rtf_srtring_w := converte_rtf_string(
				' SELECT DS_OCORRENCIA 
				   FROM OCORRENCIA
					WHERE nr_ocorrencia = :nr_ocorrencia_p ', nr_ocorrencia_p, wheb_usuario_pck.get_nm_usuario, nr_seq_rtf_srtring_w);
				select	ds_texto
				into STRICT	ds_ocorrencia_ww
				from	tasy_conversao_rtf
				where	nr_sequencia	= nr_seq_rtf_srtring_w;
				exception
				when others then
					ds_ocorrencia_ww	:= '';
				end;
			
			else
			
				nr_pos_fim_cabecalho 	:= position('\pard' in ds_ocorrencia_w);

				if (nr_pos_fim_cabecalho > 0) then				
					ds_ocorrencia_ww := substr(ds_ocorrencia_w, 1, nr_pos_fim_cabecalho - 1);
				else
					ds_ocorrencia_ww := wheb_rtf_pck.get_cabecalho;
				end if;
				
				ds_ocorrencia_body_w := substr(ds_ocorrencia_w, nr_pos_fim_cabecalho, length(ds_ocorrencia_w));
			
			end if;
			
			ds_ocorrencia_ww := ds_ocorrencia_ww ||
								'\pard '||
								obter_desc_expressao(330022) || substr(obter_nome_pf(cd_pessoa_fisica_p),1,60)  || ds_quebra_w ||
								obter_desc_expressao(299670) || ' ' || ds_tipo_ocorrencia_w || ds_quebra_w ||
								obter_desc_expressao(294709) ||
								' \par \par' ||
								ds_ocorrencia_body_w;

			if (ds_pos_inicio_rtf_w = 0) then
				ds_ocorrencia_ww := ds_ocorrencia_ww||wheb_rtf_pck.get_rodape;
			end if;
			
	end if;

	insert	into comunic_interna(nr_sequencia,
			dt_comunicado,
			ds_titulo,
			ds_comunicado,		
			nm_usuario,
			dt_atualizacao,
			ie_geral,
			ie_gerencial,
			dt_liberacao,
			cd_setor_destino,
			ds_Setor_adicional,
			nm_usuario_destino,
			ds_perfil_adicional)
		values (
			ci_nextval_w,
			clock_timestamp(),
			obter_desc_expressao(335133),
			ds_ocorrencia_ww,		
			substr(OBTER_USUARIO_PESSOA(cd_pessoa_fisica_p),1,60),
			clock_timestamp(),
			CASE WHEN coalesce(cd_setor_w::text, '') = '' THEN 'S'  ELSE 'N' END ,
			'N',
			clock_timestamp(),
			null,
			ds_setor_destino_w||',',
			ds_usuarios_destino_w,
			ds_perfil_destino_w||',');
	commit;
	
else

insert	into comunic_interna(nr_sequencia,
		dt_comunicado,
		ds_titulo,
		ds_comunicado,		
		nm_usuario,
		dt_atualizacao,
		ie_geral,
		ie_gerencial,
		dt_liberacao,
		cd_setor_destino,
		ds_Setor_adicional,
		nm_usuario_destino,
		ds_perfil_adicional)
	values (
		ci_nextval_w,
		clock_timestamp(),
		obter_desc_expressao(335133),
		' ',		
		substr(OBTER_USUARIO_PESSOA(cd_pessoa_fisica_p),1,60),
		clock_timestamp(),
		CASE WHEN coalesce(cd_setor_w::text, '') = '' THEN 'S'  ELSE 'N' END ,
		'N',
		clock_timestamp(),
		null,
		ds_setor_destino_w||',',
		ds_usuarios_destino_w,
		ds_perfil_destino_w||',');

commit;

CALL copia_campo_ocorrencia_para_ci(nr_ocorrencia_p, ci_nextval_w, ie_tipo_ocorrencia_p, cd_pessoa_fisica_p);

end if;

end	;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE enviar_comunic_interna_ocorre ( cd_pessoa_fisica_p text, nr_ocorrencia_p bigint, ds_ocorrencia_p text, ie_tipo_ocorrencia_p text, cd_setor_atendimento_p bigint) FROM PUBLIC;

