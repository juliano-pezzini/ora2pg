-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE required_amount_mat_bonus ( nr_atendimento_p ATENDIMENTO_PACIENTE.NR_ATENDIMENTO%type, cd_convenio_p CONVENIO.CD_CONVENIO%type, cd_material_p MATERIAL.CD_MATERIAL%type, dt_atendimento_p ATENDIMENTO_PACIENTE.DT_ENTRADA%type, qt_material_p BONUS_QUANTITY_RULE.QT_ITEM_FROM%type, nr_seq_regra_p INOUT REGRA_CONVENIO_PLANO_MAT.NR_SEQUENCIA%type, qt_bonus_p INOUT REGRA_CONVENIO_PLANO.QT_BONUS%type ) AS $body$
DECLARE


cd_material_estoque_w		MATERIAL.CD_MATERIAL_ESTOQUE%type;
cd_subgrupo_material_w		REGRA_CONVENIO_PLANO_MAT.CD_SUBGRUPO_MATERIAL%type;
cd_classe_material_w		REGRA_CONVENIO_PLANO_MAT.CD_CLASSE_MATERIAL%type;
nr_seq_familia_w		REGRA_CONVENIO_PLANO_MAT.NR_SEQ_FAMILIA%type;
ie_tipo_atendimento_w		ATENDIMENTO_PACIENTE.IE_TIPO_ATENDIMENTO%type;
cd_classif_setor_w		SETOR_ATENDIMENTO.CD_CLASSIF_SETOR%type;
cd_setor_atendimento_w		REGRA_CONVENIO_PLANO_MAT.CD_SETOR_ATENDIMENTO%type;
cd_tipo_acomodacao_w		ATEND_CATEGORIA_CONVENIO.CD_TIPO_ACOMODACAO%type;
ie_clinica_w			ATENDIMENTO_PACIENTE.IE_CARATER_INTER_SUS%type;
cd_doenca_atend_w		DIAGNOSTICO_DOENCA.CD_DOENCA%type;
cd_empresa_conv_w		ATEND_CATEGORIA_CONVENIO.CD_EMPRESA%type;
ie_consignado_w			REGRA_CONVENIO_PLANO_MAT.IE_CONSIGNADO%type;
cd_categoria_w			ATEND_CATEGORIA_CONVENIO.CD_CATEGORIA%type;
cd_perfil_w			REGRA_CONVENIO_PLANO_MAT.CD_PERFIL%type;
ie_tipo_material_w		MATERIAL.IE_TIPO_MATERIAL%type;
cd_estabelecimento_w		ATENDIMENTO_PACIENTE.CD_ESTABELECIMENTO%type;
nr_count_w			REGRA_CONVENIO_PLANO.NR_SEQUENCIA%type;
cd_plano_w			CONVENIO_PLANO.CD_PLANO%type;
qt_required_w			BONUS_QUANTITY_RULE.QT_REQUIRED_BONUS%type;

dt_initial_term_s 		REGRA_CONVENIO_PLANO_MAT.DT_INICIO_VIGENCIA%type := TO_DATE('01/01/1900 00:00:00', 'DD/MM/YYYY HH24:MI:SS');
dt_final_term_s 		REGRA_CONVENIO_PLANO_MAT.DT_FIM_VIGENCIA%type 	 := TO_DATE('31/12/2099 00:00:00', 'DD/MM/YYYY HH24:MI:SS');
dt_current_s			REGRA_CONVENIO_PLANO_MAT.DT_ATUALIZACAO%type 	 := clock_timestamp();
cd_empresa_s			REGRA_CONVENIO_PLANO_MAT.CD_EMPRESA%type;


BEGIN

SELECT	COUNT(a.NR_SEQUENCIA)
INTO STRICT 	nr_count_w
FROM	REGRA_CONVENIO_PLANO_MAT a
WHERE	a.CD_CONVENIO = cd_convenio_p;

IF (nr_count_w > 0) THEN
	SELECT 	coalesce(OBTER_EMPRESA_ESTAB(WHEB_USUARIO_PCK.GET_CD_ESTABELECIMENTO), 0)
	INTO STRICT 	cd_empresa_s
	;

	SELECT	coalesce(MAX(a.IE_TIPO_ATENDIMENTO), 0),
		coalesce(MAX(a.CD_ESTABELECIMENTO), 0),
		coalesce(MAX(a.IE_CLINICA), 0),
		coalesce(MAX((SELECT OBTER_CID_ATENDIMENTO(a.NR_ATENDIMENTO, 'P') )), 'X') CID_ATENDIMENTO,
		coalesce(MAX(a.CD_PERFIL_ATIVO), 0),
		coalesce(MAX((SELECT OBTER_SETOR_ATENDIMENTO(a.NR_ATENDIMENTO) )), 0)
	INTO STRICT 	ie_tipo_atendimento_w,
		cd_estabelecimento_w,
		ie_clinica_w,
		cd_doenca_atend_w,
		cd_perfil_w,
		cd_setor_atendimento_w
	FROM	ATENDIMENTO_PACIENTE a
	WHERE	a.NR_ATENDIMENTO = nr_atendimento_p;

	SELECT 	coalesce(MAX(a.CD_CLASSIF_SETOR), 'X')
	INTO STRICT 	cd_classif_setor_w
	FROM 	SETOR_ATENDIMENTO a
	WHERE 	a.CD_SETOR_ATENDIMENTO = cd_setor_atendimento_w;

	SELECT	MAX(b.CD_PLANO)
	INTO STRICT	cd_plano_w
	FROM	CONVENIO_ESTABELECIMENTO a,
		CONVENIO_PLANO b
	WHERE	a.CD_CONVENIO 		= b.CD_CONVENIO
	AND	a.CD_ESTABELECIMENTO 	= cd_estabelecimento_w
	AND 	a.CD_CONVENIO 		= cd_convenio_p;

	SELECT	coalesce(MAX(a.CD_MATERIAL_ESTOQUE), 0),
		coalesce(MAX(a.IE_TIPO_MATERIAL), '0'),
		coalesce(MAX(a.NR_SEQ_FAMILIA), 0),
	        coalesce(MAX(a.IE_CONSIGNADO), 'X'),
	        MAX((SELECT OBTER_ESTRUTURA_MATERIAL(a.CD_MATERIAL, 'S') )),
		MAX((SELECT OBTER_ESTRUTURA_MATERIAL(a.CD_MATERIAL, 'C') ))
	INTO STRICT	cd_material_estoque_w,
		ie_tipo_material_w,
		nr_seq_familia_w,
		ie_consignado_w,
		cd_subgrupo_material_w,
		cd_classe_material_w
	FROM	MATERIAL a
	WHERE	a.CD_MATERIAL = cd_material_p;

	SELECT	coalesce(MAX(a.CD_CATEGORIA), '0'),
		coalesce(MAX(a.CD_TIPO_ACOMODACAO), 0),
		coalesce(MAX(a.CD_EMPRESA), 0)
	INTO STRICT	cd_categoria_w,
		cd_tipo_acomodacao_w,
		cd_empresa_conv_w
	FROM	ATEND_CATEGORIA_CONVENIO a
	WHERE	a.NR_ATENDIMENTO 	= nr_atendimento_p
	AND	a.CD_CONVENIO 		= cd_convenio_p
	AND	a.NR_SEQ_INTERNO 	= (SELECT OBTER_ATECACO_ATENDIMENTO(a.NR_ATENDIMENTO) );

	SELECT	MAX(a.NR_SEQUENCIA),
		MAX(a.QT_BONUS)
	INTO STRICT 	nr_seq_regra_p,
		qt_bonus_p
	FROM 	(
		SELECT	a.NR_SEQUENCIA,
	        	a.QT_BONUS,
			(ROW_NUMBER() OVER (ORDER BY
				a.DS_MASCARA_CARTEIRA,
				a.CD_MATERIAL,
				a.CD_CLASSE_MATERIAL,
				a.CD_SUBGRUPO_MATERIAL,
				a.CD_GRUPO_MATERIAL,
				a.NR_SEQ_FAMILIA,
				a.IE_TIPO_MATERIAL,
				a.CD_TIPO_ACOMODACAO,
				a.CD_SETOR_ATENDIMENTO,
				a.CD_CLASSIF_SETOR,
				a.CD_CATEGORIA,
				a.IE_TIPO_ATENDIMENTO,
				a.IE_CARATER_INTER_SUS,
				a.IE_CLINICA,
				a.CD_EMPRESA_CONV,
				a.NR_SEQ_ESTRUTURA
			)) NR_RULE
		FROM 	REGRA_CONVENIO_PLANO_MAT a
		WHERE	a.CD_CONVENIO 							= cd_convenio_p
		AND	coalesce(a.CD_PLANO, cd_plano_w) 					= cd_plano_w
		AND	coalesce(a.CD_MATERIAL, cd_material_p) 				= cd_material_p
		AND	coalesce(a.CD_MATERIAL_ESTOQUE, cd_material_estoque_w) 		= cd_material_estoque_w
		AND	coalesce(a.CD_SUBGRUPO_MATERIAL, cd_subgrupo_material_w) 		= cd_subgrupo_material_w
		AND	coalesce(a.CD_CLASSE_MATERIAL, cd_classe_material_w) 		= cd_classe_material_w
		AND	coalesce(a.NR_SEQ_FAMILIA, nr_seq_familia_w) 			= nr_seq_familia_w
		AND	coalesce(a.IE_TIPO_ATENDIMENTO, ie_tipo_atendimento_w) 		= ie_tipo_atendimento_w
		AND	coalesce(a.CD_CLASSIF_SETOR, cd_classif_setor_w) 			= cd_classif_setor_w
		AND	coalesce(a.CD_SETOR_ATENDIMENTO, cd_setor_atendimento_w) 		= cd_setor_atendimento_w
		AND	coalesce(a.CD_TIPO_ACOMODACAO, cd_tipo_acomodacao_w) 		= cd_tipo_acomodacao_w
		AND	coalesce(a.IE_CLINICA, ie_clinica_w) 				= ie_clinica_w
		AND 	coalesce(a.CD_EMPRESA, cd_empresa_s) 				= cd_empresa_s
		AND	coalesce(a.CD_DOENCA, cd_doenca_atend_w) 				= cd_doenca_atend_w
		AND	coalesce(a.CD_EMPRESA_CONV, cd_empresa_conv_w) 			= cd_empresa_conv_w
		AND	coalesce(a.IE_CONSIGNADO, ie_consignado_w) 				= ie_consignado_w
		AND	coalesce(a.CD_CATEGORIA, cd_categoria_w) 				= cd_categoria_w
		AND	coalesce(a.CD_PERFIL, cd_perfil_w) 					= cd_perfil_w
		AND 	coalesce(a.IE_TIPO_MATERIAL, ie_tipo_material_w) 			= ie_tipo_material_w
		AND (a.CD_ESTABELECIMENTO = cd_estabelecimento_w OR coalesce(a.CD_ESTABELECIMENTO::text, '') = '')
		AND	coalesce(dt_atendimento_p, dt_current_s) BETWEEN coalesce(a.DT_INICIO_VIGENCIA, dt_initial_term_s) AND coalesce(a.DT_FIM_VIGENCIA, dt_final_term_s)
		AND (coalesce(a.NR_SEQ_ESTRUTURA::text, '') = '' OR (SELECT CONSISTIR_SE_MAT_ESTRUT_VIG(a.NR_SEQ_ESTRUTURA, cd_material_p, dt_current_s) ) = 'S')
	) a
	WHERE 	a.NR_RULE = 1;
END IF;

SELECT	coalesce(SUM(a.QT_REQUIRED_BONUS), 0)
INTO STRICT 	qt_required_w
FROM	BONUS_QUANTITY_RULE a
WHERE	a.NR_SEQ_REGRA_MAT = nr_seq_regra_p
AND	qt_material_p BETWEEN a.QT_ITEM_FROM AND a.QT_ITEM_TO;

IF (qt_required_w > 0) THEN
	qt_bonus_p := qt_required_w;
END IF;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE required_amount_mat_bonus ( nr_atendimento_p ATENDIMENTO_PACIENTE.NR_ATENDIMENTO%type, cd_convenio_p CONVENIO.CD_CONVENIO%type, cd_material_p MATERIAL.CD_MATERIAL%type, dt_atendimento_p ATENDIMENTO_PACIENTE.DT_ENTRADA%type, qt_material_p BONUS_QUANTITY_RULE.QT_ITEM_FROM%type, nr_seq_regra_p INOUT REGRA_CONVENIO_PLANO_MAT.NR_SEQUENCIA%type, qt_bonus_p INOUT REGRA_CONVENIO_PLANO.QT_BONUS%type ) FROM PUBLIC;

