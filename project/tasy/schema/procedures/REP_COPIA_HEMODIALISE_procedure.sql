-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE rep_copia_hemodialise (nr_prescricao_orig_p bigint, nr_prescricao_p bigint, dt_prescricao_p timestamp, nr_seq_regra_p bigint, nr_seq_material_p bigint, nm_usuario_p text) AS $body$
DECLARE


nr_agrup_acum_w				bigint;
nr_seq_solucao_w			bigint;
ie_copia_valid_igual_w		varchar(1);
dt_validade_origem_w		timestamp;
dt_validade_nova_w			timestamp;
dt_prescricao_www			timestamp;
dt_inicio_prescr_w			timestamp;
dt_primeiro_horario_w		timestamp;
nr_horas_validade_w			integer;
ie_prim_horario_setor_w		varchar(10);
hr_setor_w					varchar(10);
cd_setor_atendimento_w		bigint;
cd_estabelecimento_w		smallint;
nr_atendimento_w			bigint;
nr_seq_dialise_w			bigint;
qt_fluxo_sangue_w			hd_prescricao.qt_fluxo_sangue%type;
qt_sessao_sem_w				hd_prescricao.qt_sessao_sem%type;
qt_hora_sessao_w			hd_prescricao.qt_hora_sessao%type;
qt_min_sessao_w				hd_prescricao.qt_min_sessao%type;
nr_seq_mod_dialisador_w		hd_prescricao.nr_seq_mod_dialisador%type;
ie_ultrafiltracao_w			hd_prescricao.ie_ultrafiltracao%type;
qt_ultrafiltracao_w			hd_prescricao.qt_ultrafiltracao%type;
ie_tipo_hemodialise_w		hd_prescricao.ie_tipo_hemodialise%type;
ie_tipo_dialise_w			hd_prescricao.ie_tipo_dialise%type;
ie_tipo_peritoneal_w		hd_prescricao.ie_tipo_peritoneal%type;
nr_seq_maq_cicladora_w		hd_prescricao.nr_seq_maq_cicladora%type;
qt_volume_total_w			hd_prescricao.qt_volume_total%type;
dt_status_w					hd_prescricao.dt_status%type;
ie_status_w					hd_prescricao.ie_status%type;
cd_perfil_ativo_w			hd_prescricao.cd_perfil_ativo%type;
nr_seq_assinatura_w			hd_prescricao.nr_seq_assinatura%type;
nr_seq_diametro_agulha_w	hd_prescricao.nr_seq_diametro_agulha%type;
nr_seq_tipo_agulha_w		hd_prescricao.nr_seq_tipo_agulha%type;
ie_continuo_w				hd_prescricao.ie_continuo%type;
nr_seq_tipo_agulha_art_w	hd_prescricao.nr_seq_tipo_agulha_art%type;
nr_seq_perfil_sodio_w		hd_prescricao.nr_seq_perfil_sodio%type;
qt_zero_um_w				hd_prescricao.qt_zero_um%type;
qt_um_dois_w				hd_prescricao.qt_um_dois%type;
qt_dois_tres_w				hd_prescricao.qt_dois_tres%type;
qt_tres_quatro_w			hd_prescricao.qt_tres_quatro%type;
ie_ligar_prime_w			hd_prescricao.ie_ligar_prime%type;
qt_peso_seco_w				hd_prescricao.qt_peso_seco%type;
ds_observacao_w				hd_prescricao.ds_observacao%type;
qt_peso_ideal_w				hd_prescricao.qt_peso_ideal%type;
dt_inicio_dialise_w			hd_prescricao.dt_inicio_dialise%type;
dt_fim_dialise_w			hd_prescricao.dt_fim_dialise%type;
nr_ciclos_w					hd_prescricao.nr_ciclos%type;
qt_hora_duracao_w			hd_prescricao.qt_hora_duracao%type;
qt_min_duracao_w			hd_prescricao.qt_min_duracao%type;
qt_volume_ciclo_w			hd_prescricao.qt_volume_ciclo%type;
qt_cinco_seis_w				hd_prescricao.qt_cinco_seis%type;
qt_seto_oito_w				hd_prescricao.qt_seto_oito%type;
ie_cateter_w				hd_prescricao.ie_cateter%type;
nr_serie_w					hd_prescricao.nr_serie%type;
ie_perm_inteligente_w		hd_prescricao.ie_perm_inteligente%type;
ie_apagar_visor_w			hd_prescricao.ie_apagar_visor%type;
ie_volume_alarme_w			hd_prescricao.ie_volume_alarme%type;
qt_minimo_volume_w			hd_prescricao.qt_minimo_volume%type;
ie_modo_dialise_w			hd_prescricao.ie_modo_dialise%type;
qt_tempo_min_drenagem_w		hd_prescricao.qt_tempo_min_drenagem%type;
qt_limite_uf_negativo_w		hd_prescricao.qt_limite_uf_negativo%type;
qt_limite_uf_positivo_w		hd_prescricao.qt_limite_uf_positivo%type;
ie_ausente_w				hd_prescricao.ie_ausente%type;
ie_categoria_w				hd_prescricao.ie_categoria%type;
qt_peso_atual_w				hd_prescricao.qt_peso_atual%type;
nr_seq_ultra_w				hd_prescricao.nr_seq_ultra%type;
qt_sodio_w					hd_prescricao.qt_sodio%type;
qt_bicarbonato_w			hd_prescricao.qt_bicarbonato%type;
qt_calcio_w					hd_prescricao.qt_calcio%type;
qt_peso_pos_w				hd_prescricao.qt_peso_pos%type;
qt_volume_prime_w			hd_prescricao.qt_volume_prime%type;
nr_sequencia_w				hd_prescricao.nr_sequencia%type;
qt_zero_um_bic_w			hd_prescricao.qt_zero_um_bic%type;
qt_um_dois_bic_w			hd_prescricao.qt_um_dois_bic%type;
qt_dois_tres_bic_w			hd_prescricao.qt_dois_tres_bic%type;
qt_tres_quatro_bic_w		hd_prescricao.qt_tres_quatro_bic%type;
qt_quatro_cinco_bic_w		hd_prescricao.qt_quatro_cinco_bic%type;
qt_cinco_seis_bic_w			hd_prescricao.qt_cinco_seis_bic%type;
nr_seq_perfil_bic_w			hd_prescricao.nr_seq_perfil_bic%type;

c01 CURSOR FOR
SELECT	qt_fluxo_sangue,
		qt_sessao_sem,
		qt_hora_sessao,
		qt_min_sessao,
		nr_seq_mod_dialisador,
		ie_ultrafiltracao,
		qt_ultrafiltracao,
		CASE WHEN ie_tipo_dialise='P' THEN null  ELSE ie_tipo_hemodialise END  ie_tipo_hemodialise,
		ie_tipo_dialise,
		ie_tipo_peritoneal,
		nr_seq_maq_cicladora,
		qt_volume_total,
		dt_status,
		ie_status,
		cd_perfil_ativo,
		nr_seq_assinatura,
		nr_seq_diametro_agulha,
		nr_seq_tipo_agulha,
		ie_continuo,
		nr_seq_tipo_agulha_art,
		nr_seq_perfil_sodio,
		qt_zero_um,
		qt_um_dois,
		qt_dois_tres,
		qt_tres_quatro,
		ie_ligar_prime,
		qt_peso_seco,
		ds_observacao,
		qt_peso_ideal,
		dt_inicio_dialise,
		dt_fim_dialise,
		nr_ciclos,
		qt_hora_duracao,
		qt_min_duracao,
		qt_volume_ciclo,
		qt_cinco_seis,
		qt_seto_oito,
		ie_cateter,
		nr_serie,
		ie_perm_inteligente,
		ie_apagar_visor,
		ie_volume_alarme,
		qt_minimo_volume,
		ie_modo_dialise,
		qt_tempo_min_drenagem,
		qt_limite_uf_negativo,
		qt_limite_uf_positivo,
		ie_ausente,
		ie_categoria,
		qt_peso_atual,
		nr_seq_ultra,
		qt_sodio,
		qt_bicarbonato,
		qt_calcio,
		qt_peso_pos,
		qt_volume_prime,
		nr_sequencia,
		qt_zero_um_bic,
		qt_um_dois_bic,
		qt_dois_tres_bic,
		qt_tres_quatro_bic,
		qt_quatro_cinco_bic,
		qt_cinco_seis_bic,
		nr_seq_perfil_bic
from	hd_prescricao
where	nr_prescricao	= nr_prescricao_orig_p;

c01_w	c01%rowtype;


BEGIN

open C01;
loop
fetch C01 into	qt_fluxo_sangue_w,
				qt_sessao_sem_w,
				qt_hora_sessao_w,
				qt_min_sessao_w,
				nr_seq_mod_dialisador_w,
				ie_ultrafiltracao_w,
				qt_ultrafiltracao_w,
				ie_tipo_hemodialise_w,
				ie_tipo_dialise_w,
				ie_tipo_peritoneal_w,
				nr_seq_maq_cicladora_w,
				qt_volume_total_w,
				dt_status_w,
				ie_status_w,
				cd_perfil_ativo_w,
				nr_seq_assinatura_w,
				nr_seq_diametro_agulha_w,
				nr_seq_tipo_agulha_w,
				ie_continuo_w,
				nr_seq_tipo_agulha_art_w,
				nr_seq_perfil_sodio_w,
				qt_zero_um_w,
				qt_um_dois_w,
				qt_dois_tres_w,
				qt_tres_quatro_w,
				ie_ligar_prime_w,
				qt_peso_seco_w,
				ds_observacao_w,
				qt_peso_ideal_w,
				dt_inicio_dialise_w,
				dt_fim_dialise_w,
				nr_ciclos_w,
				qt_hora_duracao_w,
				qt_min_duracao_w,
				qt_volume_ciclo_w,
				qt_cinco_seis_w,
				qt_seto_oito_w,
				ie_cateter_w,
				nr_serie_w,
				ie_perm_inteligente_w,
				ie_apagar_visor_w,
				ie_volume_alarme_w,
				qt_minimo_volume_w,
				ie_modo_dialise_w,
				qt_tempo_min_drenagem_w,
				qt_limite_uf_negativo_w,
				qt_limite_uf_positivo_w,
				ie_ausente_w,
				ie_categoria_w,
				qt_peso_atual_w,
				nr_seq_ultra_w,
				qt_sodio_w,
				qt_bicarbonato_w,
				qt_calcio_w,
				qt_peso_pos_w,
				qt_volume_prime_w,
				nr_sequencia_w,
				qt_zero_um_bic_w,
				qt_um_dois_bic_w,
				qt_dois_tres_bic_w,
				qt_tres_quatro_bic_w,
				qt_quatro_cinco_bic_w,
				qt_cinco_seis_bic_w,
				nr_seq_perfil_bic_w;
EXIT WHEN NOT FOUND; /* apply on C01 */

	select	nextval('hd_prescricao_seq')
	into STRICT	nr_seq_dialise_w
	;

	if (ie_tipo_dialise_w = 'H') and (ie_categoria_w = 'C') then

		select	max(nr_horas_validade)
		into STRICT	qt_hora_sessao_w
		from	prescr_medica
		where	nr_prescricao = nr_prescricao_p;

		qt_min_sessao_w := 0;

	end if;

	insert into hd_prescricao(
			nr_sequencia,
			dt_atualizacao,
			nm_usuario,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			nr_prescricao,
			qt_fluxo_sangue,
			qt_sessao_sem,
			qt_hora_sessao,
			qt_min_sessao,
			nr_seq_mod_dialisador,
			ie_ultrafiltracao,
			qt_ultrafiltracao,
			ie_tipo_hemodialise,
			ie_tipo_dialise,
			ie_tipo_peritoneal,
			nr_seq_maq_cicladora,
			qt_volume_total,
			dt_status,
			ie_status,
			cd_perfil_ativo,
			nr_seq_assinatura,
			nr_seq_diametro_agulha,
			nr_seq_tipo_agulha,
			ie_continuo,
			nr_seq_tipo_agulha_art,
			nr_seq_perfil_sodio,
			qt_zero_um,
			qt_um_dois,
			qt_dois_tres,
			qt_tres_quatro,
			ie_ligar_prime,
			qt_peso_seco,
			ds_observacao,
			qt_peso_ideal,
			dt_inicio_dialise,
			dt_fim_dialise,
			nr_ciclos,
			qt_hora_duracao,
			qt_min_duracao,
			qt_volume_ciclo,
			qt_cinco_seis,
			qt_seto_oito,
			ie_cateter,
			nr_prescricao_original,
			nr_serie,
			ie_perm_inteligente,
			ie_apagar_visor,
			ie_volume_alarme,
			qt_minimo_volume,
			ie_modo_dialise,
			qt_tempo_min_drenagem,
			qt_limite_uf_negativo,
			qt_limite_uf_positivo,
			ie_ausente,
			ie_categoria,
			qt_peso_atual,
			nr_seq_ultra,
			qt_sodio,
			qt_bicarbonato,
			qt_calcio,
			qt_peso_pos,
			qt_volume_prime,
			qt_zero_um_bic,
			qt_um_dois_bic,
			qt_dois_tres_bic,
			qt_tres_quatro_bic,
			qt_quatro_cinco_bic,
			qt_cinco_seis_bic,
			nr_seq_perfil_bic)
	values (nr_seq_dialise_w,
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			nr_prescricao_p,
			qt_fluxo_sangue_w,
			qt_sessao_sem_w,
			qt_hora_sessao_w,
			qt_min_sessao_w,
			nr_seq_mod_dialisador_w,
			ie_ultrafiltracao_w,
			qt_ultrafiltracao_w,
			ie_tipo_hemodialise_w,
			ie_tipo_dialise_w,
			ie_tipo_peritoneal_w,
			nr_seq_maq_cicladora_w,
			qt_volume_total_w,
			dt_status_w,
			ie_status_w,
			cd_perfil_ativo_w,
			nr_seq_assinatura_w,
			nr_seq_diametro_agulha_w,
			nr_seq_tipo_agulha_w,
			ie_continuo_w,
			nr_seq_tipo_agulha_art_w,
			nr_seq_perfil_sodio_w,
			qt_zero_um_w,
			qt_um_dois_w,
			qt_dois_tres_w,
			qt_tres_quatro_w,
			ie_ligar_prime_w,
			qt_peso_seco_w,
			ds_observacao_w,
			qt_peso_ideal_w,
			dt_inicio_dialise_w,
			dt_fim_dialise_w,
			nr_ciclos_w,
			qt_hora_duracao_w,
			qt_min_duracao_w,
			qt_volume_ciclo_w,
			qt_cinco_seis_w,
			qt_seto_oito_w,
			ie_cateter_w,
			nr_prescricao_orig_p,
			nr_serie_w,
			ie_perm_inteligente_w,
			ie_apagar_visor_w,
			ie_volume_alarme_w,
			qt_minimo_volume_w,
			ie_modo_dialise_w,
			qt_tempo_min_drenagem_w,
			qt_limite_uf_negativo_w,
			qt_limite_uf_positivo_w,
			ie_ausente_w,
			ie_categoria_w,
			qt_peso_atual_w,
			nr_seq_ultra_w,
			qt_sodio_w,
			qt_bicarbonato_w,
			qt_calcio_w,
			qt_peso_pos_w,
			qt_volume_prime_w,
			qt_zero_um_bic_w,
			qt_um_dois_bic_w,
			qt_dois_tres_bic_w,
			qt_tres_quatro_bic_w,
			qt_quatro_cinco_bic_w,
			qt_cinco_seis_bic_w,
			nr_seq_perfil_bic_w);

	CALL REP_copia_solucao_dialise(nr_prescricao_orig_p, nr_prescricao_p, nr_seq_regra_p,'S', dt_prescricao_p,nm_usuario_p, nr_seq_dialise_w, nr_seq_material_p,nr_sequencia_w,'N');

end loop;
close C01;

select	max(nr_seq_solucao)
into STRICT	nr_seq_solucao_w
from	prescr_solucao
where	nr_prescricao	= nr_prescricao_p
and		ie_hemodialise	in ('S','P');

if (nr_seq_solucao_w > 0) then
	--Elementos da Solução de Hemodiálise
	insert into hd_prescr_sol_elem(
		nr_sequencia,
		dt_atualizacao,
		nm_usuario,
		dt_atualizacao_nrec,
		nm_usuario_nrec,
		nr_prescricao,
		nr_seq_solucao,
		nr_seq_elemento,
		cd_unidade_medida,
		qt_elemento,
		nr_prescricao_original)
	SELECT	nextval('hd_prescr_sol_elem_seq'),
		clock_timestamp(),
		nm_usuario_p,
		clock_timestamp(),
		nm_usuario_p,
		nr_prescricao_p,
		nr_seq_solucao_w,
		nr_seq_elemento,
		cd_unidade_medida,
		qt_elemento,
		nr_prescricao_orig_p
	from	hd_prescr_sol_elem
	where	nr_prescricao	= nr_prescricao_orig_p;

end if;
commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE rep_copia_hemodialise (nr_prescricao_orig_p bigint, nr_prescricao_p bigint, dt_prescricao_p timestamp, nr_seq_regra_p bigint, nr_seq_material_p bigint, nm_usuario_p text) FROM PUBLIC;

