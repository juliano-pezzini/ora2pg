-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE desfazer_setor_realizar ( nr_seq_atendimento_p bigint, nm_usuario_p text) AS $body$
DECLARE

        
nr_atendimento_w    	bigint;
nr_seq_interno_w    	bigint;
dt_entrada_unidade_w    timestamp;
ds_erro_w   		varchar(255);
ie_transf_paci_acomod_w	varchar(1);


BEGIN

/* Quimioterapia - Parâmetro [492] - Ao definir acomodação do paciente, controlar ocupação das unidades de setor. */

ie_transf_paci_acomod_w := obter_param_usuario(3130, 492, obter_perfil_ativo, nm_usuario_p, obter_estabelecimento_ativo, ie_transf_paci_acomod_w);

update	paciente_atendimento
set	nr_seq_local		 = NULL,
	dt_acomodacao_paciente	 = NULL,
	nm_usuario		= nm_usuario_p
where	nr_seq_atendimento	= nr_seq_atendimento_p;

if (ie_transf_paci_acomod_w = 'S') then

	SELECT  max(nr_atendimento)
	INTO STRICT    nr_atendimento_w
	FROM    paciente_atendimento
	where   nr_seq_atendimento = NR_SEQ_ATENDIMENTO_P;

	nr_seq_interno_w := OBTER_ATEPACU_PACIENTE(nr_atendimento_w, 'A');

	select	max(dt_entrada_unidade)
	into STRICT	dt_entrada_unidade_w
	from    atend_paciente_unidade
	where   nr_seq_interno = nr_seq_interno_w;

	if (nr_atendimento_w IS NOT NULL AND nr_atendimento_w::text <> '') then
		ds_erro_w := EXCLUIR_ATEND_PAC_UNIDADE(nr_atendimento_w, dt_entrada_unidade_w, obter_usuario_ativo(), ds_erro_w, nr_seq_interno_w);
	end if;
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE desfazer_setor_realizar ( nr_seq_atendimento_p bigint, nm_usuario_p text) FROM PUBLIC;

