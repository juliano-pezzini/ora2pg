-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE retirar_dispositivo_adep ( nr_seq_acao_disp_p bigint, nr_seq_dispositivo_p bigint, ie_opcao_disp_p text, dt_registro_p timestamp, nr_seq_motivo_ret_p bigint, nr_seq_registro_p bigint, nr_atendimento_p bigint, nm_usuario_p text, ds_retirada_p text) AS $body$
DECLARE


ie_acao_w				varchar(15);
nr_seq_disp_proc_w		bigint;
ds_hint_w				varchar(4000);
ds_dispositivo_w		varchar(255);
cd_pessoa_fisica_w		varchar(10);
ie_gerar_evolucao_w		varchar(10);
cd_evolucao_w			bigint;
ds_texto_aux_w			varchar(50);


BEGIN

select	Obter_Dados_Usuario_Opcao(nm_usuario_p,'C')
into STRICT	cd_pessoa_fisica_w
;

ie_acao_w	:= obter_acao_procedimento(nr_seq_acao_disp_p, nr_seq_dispositivo_p,coalesce(ie_opcao_disp_p,'P'));

update	atend_pac_dispositivo
set		dt_retirada			=	dt_registro_p,
		nr_seq_motivo_ret	=	nr_seq_motivo_ret_p,
		ie_acao				=	coalesce(ie_acao_w, ie_acao),
		dt_atualizacao		=	clock_timestamp(),
		nm_usuario			=	nm_usuario_p
where	nr_sequencia		=	nr_seq_registro_p;

Select	nextval('atend_pac_disp_proc_seq')
into STRICT	nr_seq_disp_proc_w
;

insert into atend_pac_disp_proc(
	nr_sequencia,
	nr_seq_disp_pac,
	dt_atualizacao,
	nm_usuario,
	dt_atualizacao_nrec,
	nm_usuario_nrec,
	nr_seq_proc_interno,
	dt_procedimento,
	cd_pessoa_fisica,
	cd_setor_atendimento,
	ds_observacao)
values (
	nr_seq_disp_proc_w,
	nr_seq_registro_p,
	clock_timestamp(),
	nm_usuario_p,
	clock_timestamp(),
	nm_usuario_p,
	nr_seq_acao_disp_p,
	dt_registro_p,
	cd_pessoa_fisica_w,
	campo_numerico(Obter_Unidade_Atendimento(nr_atendimento_p,'A','CS')),
	ds_retirada_p);
	
CALL ADEP_exec_lancto_dispositivo(nr_atendimento_p,nr_seq_disp_proc_w ,nm_usuario_p);

CALL ADEP_cobranca_dispositivo(nr_atendimento_p,nr_seq_dispositivo_p,nr_seq_disp_proc_w ,nm_usuario_p,'R',ie_acao_w, nr_seq_registro_p);

select	coalesce(max(ie_gerar_evolucao),'S')
into STRICT	ie_gerar_evolucao_w
from	DISPOSITIVO
where	nr_sequencia	= nr_seq_dispositivo_p;

ds_texto_aux_w := wheb_mensagem_pck.get_texto(300586);

select	coalesce(substr(obter_descricao_padrao('DISPOSITIVO','DS_DISPOSITIVO',max(a.nr_seq_dispositivo)),1,80), ds_texto_aux_w) ds_dispositivo,
		substr(obter_hint_graf_niss_adep(max(a.nr_sequencia)),1,4000) ds_hint
into STRICT	ds_dispositivo_w,
		ds_hint_w
from	atend_pac_dispositivo a
where	obter_se_exibe_graf_disp(a.nr_sequencia) = 'S'
and		a.nr_atendimento = nr_atendimento_p
and		a.nr_sequencia 	= nr_seq_registro_p;

ds_hint_w	:= substr(ds_hint_w || chr(13) || wheb_mensagem_pck.get_texto(300588, 'DT='||PKG_DATE_FORMATERS.TO_VARCHAR(dt_registro_p, 'timestamp', WHEB_USUARIO_PCK.GET_CD_ESTABELECIMENTO, WHEB_USUARIO_PCK.GET_NM_USUARIO)||';NOME='||substr(obter_nome_pf(cd_pessoa_fisica_w),1,80)) ,1,4000);
			
if (ie_gerar_evolucao_w = 'S') then
	cd_evolucao_w := Gerar_evolPaci_automa('DISP', nm_usuario_p, nr_atendimento_p, ds_dispositivo_w, null, 'D', ds_hint_w, dt_registro_p, null, null, null, null, cd_evolucao_w, 'S', null, nr_seq_registro_p, ie_opcao_disp_p, nr_seq_acao_disp_p);
end if;

if (coalesce(wheb_usuario_pck.get_ie_commit, 'S') = 'S') then commit; end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE retirar_dispositivo_adep ( nr_seq_acao_disp_p bigint, nr_seq_dispositivo_p bigint, ie_opcao_disp_p text, dt_registro_p timestamp, nr_seq_motivo_ret_p bigint, nr_seq_registro_p bigint, nr_atendimento_p bigint, nm_usuario_p text, ds_retirada_p text) FROM PUBLIC;

