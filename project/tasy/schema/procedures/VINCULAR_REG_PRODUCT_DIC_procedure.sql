-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE vincular_reg_product_dic ( nr_seq_product_requirement_p bigint, nr_seq_objeto_p bigint, ie_tipo_objeto_p text, ie_filhos_p text, nm_usuario_p text) AS $body$
DECLARE


/*ie_tipo_objeto_p
S - Objeto schematic
O - Opção de Mouse
*/
nr_seq_pd_w			reg_product_dic.nr_sequencia%type;
nr_seq_funcao_schematic_w	objeto_schematic.nr_seq_funcao_schematic%type;
nr_seq_objeto_w			objeto_schematic.nr_sequencia%type;
ie_tipo_objeto_w		objeto_schematic.ie_tipo_objeto%type;
ie_tipo_componente_w		objeto_schematic.ie_tipo_componente%type;
nr_seq_dic_objeto_w		objeto_schematic.nr_seq_dic_objeto%type;
nr_seq_opcao_mouse_w		dic_objeto.nr_sequencia%type;
cd_funcao_w			funcao.cd_funcao%type;

qt_w				bigint;WITH RECURSIVE cte AS (


c01 CURSOR FOR  --busca os objetos filhos
SELECT	a.nr_sequencia,a.ie_tipo_objeto,a.ie_tipo_componente,a.nr_seq_dic_objeto,ARRAY[ row_number() OVER (ORDER BY  nr_seq_apres desc) ] as hierarchy
from  	objeto_schematic a WHERE a.nr_sequencia = nr_seq_objeto_p
	and a.nr_seq_funcao_schematic = nr_seq_funcao_schematic_w
  UNION ALL


c01 CURSOR FOR 
SELECT	a.nr_sequencia,a.ie_tipo_objeto,a.ie_tipo_componente,a.nr_seq_dic_objeto, array_append(c.hierarchy, row_number() OVER (ORDER BY  nr_seq_apres desc))  as hierarchy
from  	objeto_schematic a JOIN cte c ON (c.prior  nr_sequencia = a.nr_seq_obj_sup)

) SELECT * FROM cte WHERE nr_seq_funcao_schematic = nr_seq_funcao_schematic_w
and  	nr_sequencia 		<> nr_seq_objeto_p ORDER BY hierarchy;
;

c02 CURSOR FOR
SELECT	a.nr_sequencia
from	dic_objeto a
where	a.nr_seq_obj_sup = nr_seq_dic_objeto_w
and	coalesce(a.ie_situacao,'A') = 'A'
and	a.cd_exp_texto <> 317230 --ignora os separadores
and	not exists  --ignora as opções que são agrupadores.
	(select	1
	from	dic_objeto x
	where	x.NR_SEQ_OBJ_SUP = nr_seq_dic_objeto_w
	and	x.nr_seq_mi_sup	= a.nr_sequencia);


BEGIN

if (ie_tipo_objeto_p = 'S') then

	select	max(nr_seq_funcao_schematic),
		max(cd_funcao)
	into STRICT	nr_seq_funcao_schematic_w,
		cd_funcao_w
	from	objeto_schematic
	where	nr_sequencia = nr_seq_objeto_p;

elsif (ie_tipo_objeto_p = 'O') then

	select	max(cd_funcao)
	into STRICT	cd_funcao_w
	from	dic_objeto
	where	nr_sequencia	= nr_seq_objeto_p;

end if;

if (cd_funcao_w IS NOT NULL AND cd_funcao_w::text <> '') then
	select	count(1)
	into STRICT	qt_w
	from	reg_funcao_pr a
	where	cd_funcao		= cd_funcao_w
	and	nr_seq_product_req	= nr_seq_product_requirement_p;

	if (qt_w = 0) then

		insert into REG_FUNCAO_PR(nr_sequencia,
			dt_atualizacao,
			nm_usuario,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			nr_seq_product_req,
			cd_funcao)
		values (nextval('reg_funcao_pr_seq'),
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			nr_seq_product_requirement_p,
			cd_funcao_w);

	end if;

end if;

CALL gerar_reg_product_dic(nr_seq_product_requirement_p, nr_seq_objeto_p, ie_tipo_objeto_p, nm_usuario_p, cd_funcao_w);

if (ie_tipo_objeto_p = 'S') and (coalesce(ie_filhos_p,'N') = 'S')then

	open C01;
	loop
	fetch C01 into
		nr_seq_objeto_w,
		ie_tipo_objeto_w,
		ie_tipo_componente_w,
		nr_seq_dic_objeto_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin

		if (ie_tipo_objeto_w in ('T','IT','TVN','DDM','C')) then

			CALL gerar_reg_product_dic(nr_seq_product_requirement_p, nr_seq_objeto_w, 'S', nm_usuario_p, cd_funcao_w);

		end if;

		if (ie_tipo_objeto_w = 'C') and (ie_tipo_componente_w = 'WPOPUP') and (nr_seq_dic_objeto_w IS NOT NULL AND nr_seq_dic_objeto_w::text <> '') then

			open C02;
			loop
			fetch C02 into
				nr_seq_opcao_mouse_w;
			EXIT WHEN NOT FOUND; /* apply on C02 */
				begin

				CALL gerar_reg_product_dic(nr_seq_product_requirement_p, nr_seq_opcao_mouse_w, 'O', nm_usuario_p, cd_funcao_w);

				end;
			end loop;
			close C02;

		end if;

		end;
	end loop;
	close C01;

	select	max(a.ie_tipo_objeto),
		max(a.ie_tipo_componente),
		max(a.nr_seq_dic_objeto)
	into STRICT	ie_tipo_objeto_w,
		ie_tipo_componente_w,
		nr_seq_dic_objeto_w
	from	objeto_schematic a
	where	nr_sequencia = nr_seq_objeto_p;

	--Caso o objeto primário selecionado seja um POPUPMenu, então pego todos os MI dele.
	if (ie_tipo_objeto_w = 'C') and (ie_tipo_componente_w = 'WPOPUP') and (nr_seq_dic_objeto_w IS NOT NULL AND nr_seq_dic_objeto_w::text <> '') then

		open C02;
		loop
		fetch C02 into
			nr_seq_opcao_mouse_w;
		EXIT WHEN NOT FOUND; /* apply on C02 */
			begin

			CALL gerar_reg_product_dic(nr_seq_product_requirement_p, nr_seq_opcao_mouse_w, 'O', nm_usuario_p, cd_funcao_w);

			end;
		end loop;
		close C02;

	end if;
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE vincular_reg_product_dic ( nr_seq_product_requirement_p bigint, nr_seq_objeto_p bigint, ie_tipo_objeto_p text, ie_filhos_p text, nm_usuario_p text) FROM PUBLIC;

