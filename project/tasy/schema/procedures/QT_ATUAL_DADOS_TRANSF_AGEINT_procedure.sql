-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE qt_atual_dados_transf_ageint ( nr_seq_item_p bigint, dt_agenda_p timestamp, nm_usuario_p text, nr_seq_local_p bigint, cd_estabelecimento_p bigint, nr_minuto_duracao_p bigint, ie_gerar_p INOUT text, nr_seq_prof_p bigint default null) AS $body$
DECLARE


dt_prevista_w		timestamp;
dt_real_w		timestamp;
qt_tempo_medic_w	bigint;
qt_marcacao_w		bigint;
qt_em_agenda_w		bigint;
qt_pendencia_marcada_w	bigint;
dt_ultimo_horario_w	timestamp;
ie_dia_quimio_w		varchar(1)	:= 'S';
ie_gerar_w		varchar(1)	:= 'N';
qt_tempo_prep_medic_w	bigint;
qt_tempo_prep_pac_w	bigint;
cd_pessoa_fisica_w	varchar(10);
nr_seq_prof_w		bigint;
ie_prof_marcado_w	varchar(1)	:= 'N';
ds_result_pac_prof_w	varchar(255);
nr_min_apres_w		bigint;
qt_duracao_medic_w	bigint;
qt_agendado_W		bigint;
nr_min_apres_local_w	smallint;
qt_bloqueio_w		bigint;


BEGIN
select	coalesce(max(Obter_Valor_Param_Usuario(865, 1, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p)),0)
into STRICT	qt_tempo_prep_medic_w
;

select	coalesce(max(Obter_Valor_Param_Usuario(865, 2, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p)),0)
into STRICT	qt_tempo_prep_pac_w
;

select	coalesce(max(Obter_Valor_Param_Usuario(865, 3, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p)),0)
into STRICT	nr_min_apres_w
;

select	max(nr_min_apres)
into STRICT	nr_min_apres_local_w
from	qt_local
where	nr_sequencia = nr_seq_local_p;

begin
select	1
into STRICT	qt_agendado_W
from	agenda_quimio
where	nr_seq_ageint_item	= nr_seq_item_p;
exception
	when others then
	qt_agendado_w	:= 0;
	ie_gerar_w	:= 'T';
end;

ie_dia_quimio_w	:= 'S';
if (ie_dia_quimio_w	= 'S') and (qt_agendado_W	> 0) then
	/*select	max(nr_seq_prof)
	into	nr_seq_prof_w
	from	qt_paciente_prof
	where	cd_pessoa_fisica	= cd_pessoa_fisica_w;*/
	nr_seq_prof_w	:= nr_seq_prof_p;
	qt_tempo_medic_w	:= nr_minuto_duracao_p;

	if (coalesce(qt_tempo_medic_w,0) = 0) then
		CALL Wheb_mensagem_pck.exibir_mensagem_abort(262417);
	end if;

	select	count(*)
	into STRICT	qt_marcacao_w
	from	agenda_quimio_marcacao
	where	dt_agenda_p between dt_Agenda and dt_Agenda + (nr_duracao - 1) / 1440
	and	nr_seq_ageint_item	= nr_seq_item_p
	and	nm_usuario		= nm_usuario_p
	--and	nr_seq_pend_agenda	= nr_seq_pendencia_p
	and	ie_transferencia	= 'S';

	if (qt_marcacao_w	> 0) then
		delete 	FROM agenda_quimio_marcacao
		where	dt_agenda_p + 1 /1440 between dt_agenda and dt_agenda + (nr_duracao - 1) / 1440
		and	nr_seq_ageint_item	= nr_seq_item_p
		and	nm_usuario		= nm_usuario_p
		--and	nr_seq_pend_agenda	= nr_seq_pendencia_p
		and	ie_transferencia	= 'S';

		ie_gerar_w	:= 'S';
	else
		ds_result_pac_prof_w := Qt_Consistir_Pac_Prof(nr_seq_prof_w, nr_seq_local_p, dt_agenda_p, qt_tempo_prep_pac_w, nm_usuario_p, cd_estabelecimento_p, null, ds_result_pac_prof_w);
		if (ds_result_pac_prof_w = 'M') then
			ie_gerar_w		:= 'E';
			ie_prof_marcado_w	:= 'S';
		elsif (ds_result_pac_prof_w = 'L') then
			ie_gerar_w		:= 'L';
			ie_prof_marcado_w	:= 'S';
		elsif (ds_result_pac_prof_w = 'H') then
			ie_gerar_w		:= 'H';
			ie_prof_marcado_w	:= 'S';
		end if;

		if (ie_prof_marcado_w	= 'N') then
			select	count(*)
			into STRICT	qt_pendencia_marcada_w
			from	agenda_quimio_marcacao
			where	nr_seq_ageint_item	= nr_seq_item_p
			and	trunc(dt_agenda)	= trunc(dt_agenda_p)
			and	ie_transferencia	= 'S';
			if (qt_pendencia_marcada_w = 0) then
				select	count(*)
				into STRICT	qt_marcacao_w
				from	agenda_quimio_marcacao
				where	--dt_agenda <> dt_agenda_p and
				((dt_agenda_p between dt_agenda and dt_agenda + (nr_duracao - 1) / 1440)
				or	(dt_agenda_p + (qt_tempo_medic_w - 1) / 1440 between dt_agenda and dt_agenda + (nr_duracao - 1) / 1440)
				or	(dt_agenda between dt_agenda_p and dt_agenda_p + (qt_tempo_medic_w - 1) / 1440)
				or	(dt_agenda + (nr_duracao - 1) / 1440 between dt_agenda_p and dt_agenda_p + (qt_tempo_medic_w - 1) / 1440))
				and	nr_seq_local	= nr_seq_local_p
				--and	nm_usuario	= nm_usuario_p
				and	nr_seq_ageint_item	<> nr_seq_item_p;

				if (qt_marcacao_w	> 0) then
					ie_Gerar_w	:= 'A';
				end if;

				select	count(*)
				into STRICT	qt_em_agenda_w
				from	w_agenda_quimio
				where	nr_seq_local	= nr_seq_local_p
				and	nm_usuario	= nm_usuario_p
				and	ie_status = 'EA'
				and	trunc(dt_horario)	= trunc(dt_agenda_p)
				and	nr_seq_item_marc	= nr_seq_item_p;

				select	max(dt_horario)
				into STRICT	dt_ultimo_horario_w
				from	w_agenda_quimio
				where	dt_horario between dt_agenda_p and dt_agenda_p + qt_tempo_medic_w / 1440
				and	nr_seq_local	= nr_seq_local_p;
				--and	nm_usuario	= nm_usuario_p
				--and	nr_seq_ageint_item	= nr_seq_item_p;
			else
				ie_Gerar_w	:= 'M';
			end if;
		end if;

		select	count(*)
		into STRICT	qt_bloqueio_w
		from	w_agenda_quimio
		where	dt_horario between dt_agenda_p and dt_agenda_p +  (qt_tempo_medic_w - 1) / 1440
		and	ie_status = 'B'
		and	nr_seq_local = nr_seq_local_p;

		if	((dt_agenda_p + qt_tempo_medic_w / 1440) <= (dt_ultimo_horario_w + coalesce(nr_min_apres_local_w,nr_min_apres_w) / 1440)) and (qt_pendencia_marcada_w	= 0) and (qt_marcacao_w	= 0) and (qt_em_agenda_w	= 0) and (ie_prof_marcado_w	= 'N') and (qt_bloqueio_w 		= 0) then
			insert into agenda_quimio_marcacao(nr_sequencia,
				dt_agenda,
				nm_usuario,
				nr_seq_local,
				nr_duracao,
				nr_seq_ageint_item,
				dt_atualizacao,
				dt_atualizacao_nrec,
				nm_usuario_nrec,
				ie_gerado,
				ie_transferencia,
				nr_seq_prof)
			values (nextval('agenda_quimio_marcacao_seq'),
				dt_agenda_p,
				nm_usuario_p,
				nr_seq_local_p,
				qt_tempo_medic_w,
				nr_seq_item_p,
				clock_timestamp(),
				clock_timestamp(),
				nm_usuario_p,
				'N',
				'S',
				nr_seq_prof_w);
			ie_gerar_w	:= 'S';
		end if;
	end if;
end if;

ie_gerar_p	:= ie_gerar_w;


commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE qt_atual_dados_transf_ageint ( nr_seq_item_p bigint, dt_agenda_p timestamp, nm_usuario_p text, nr_seq_local_p bigint, cd_estabelecimento_p bigint, nr_minuto_duracao_p bigint, ie_gerar_p INOUT text, nr_seq_prof_p bigint default null) FROM PUBLIC;

