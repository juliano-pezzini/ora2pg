-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_excluir_lib_rec_glosa_prot ( nr_seq_rec_glosa_prot_p pls_rec_glosa_protocolo.nr_sequencia%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nm_usuario_p usuario.nm_usuario%type) AS $body$
DECLARE


qt_registros_w		integer;
qt_lote_pgto_w		integer := 0;
ie_gerar_val_adic_w	pls_parametros_rec_glosa.ie_gerar_val_adic%type;

C01 CURSOR FOR
	SELECT	nr_sequencia
	from	pls_rec_glosa_conta
	where	nr_seq_protocolo	= nr_seq_rec_glosa_prot_p;

BEGIN

-- verifica se já tem lote de pagamento
select 	count(1)
into STRICT	qt_lote_pgto_w
from 	pls_conta_rec_resumo_item b,
		pls_rec_glosa_conta c
where	b.nr_seq_conta_rec = c.nr_sequencia
and		c.nr_seq_protocolo = nr_seq_rec_glosa_prot_p
and 	(b.nr_seq_lote_pgto IS NOT NULL AND b.nr_seq_lote_pgto::text <> '')
and		b.ie_situacao = 'A';

/*O pagamento dos itens do recurso já foram gerados. Não é possível desfazer a liberação do pagamento do protocolo!*/

if (qt_lote_pgto_w > 0) then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(292775);
end if;

select	coalesce(max(ie_gerar_val_adic), 'L')
into STRICT	ie_gerar_val_adic_w
from	pls_parametros_rec_glosa
where	cd_estabelecimento = cd_estabelecimento_p;

--Deleta os registors de pós-estabelecidos gerados
if (ie_gerar_val_adic_w = 'L') then
	CALL pls_excluir_val_adic_rec_glo(nr_seq_rec_glosa_prot_p, null);
end if;

for r_c01_w in C01 loop
	-- Limpa o evento do recurso de glosa, pois quando liberar para pagamento deverá ser atualizado
	update	pls_conta_rec_resumo_item
	set	nr_seq_evento  = NULL
	where	nr_seq_conta_rec = r_c01_w.nr_sequencia;

end loop;

update	pls_rec_glosa_protocolo
set	ie_status		= '5',
	nm_usuario		= nm_usuario_p,
	dt_atualizacao		= clock_timestamp(),
	dt_liberacao_pag	 = NULL
where	nr_sequencia		= nr_seq_rec_glosa_prot_p;

CALL pls_atualizar_copart_rec_glosa( nr_seq_rec_glosa_prot_p, cd_estabelecimento_p, nm_usuario_p, 'N');

-- Gera o log da ação
CALL pls_gerar_log_rec_glosa( 'DLP', null, null, nm_usuario_p, null, nr_seq_rec_glosa_prot_p, null);

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_excluir_lib_rec_glosa_prot ( nr_seq_rec_glosa_prot_p pls_rec_glosa_protocolo.nr_sequencia%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nm_usuario_p usuario.nm_usuario%type) FROM PUBLIC;

