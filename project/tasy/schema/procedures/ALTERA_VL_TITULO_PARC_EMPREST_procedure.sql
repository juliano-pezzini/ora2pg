-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE altera_vl_titulo_parc_emprest (nr_titulo_p bigint, vl_alterado_p bigint, vl_anterior_p bigint, ie_alt_bordero_p text, nm_usuario_p text) AS $body$
DECLARE

							 
nr_seq_alteracao_w		titulo_pagar_alt_valor.nr_sequencia%type;
vl_anterior_w			titulo_pagar_alt_valor.vl_anterior%type;
cd_moeda_w			titulo_pagar_alt_valor.cd_moeda%type;
ie_situacao_w			titulo_pagar.ie_situacao%type;
dt_emissao_w			timestamp;
vl_saldo_titulo_w		titulo_pagar.vl_saldo_titulo%type;
qt_alteracao_ant_w		bigint;
qt_registros_w			bigint;
ds_erro_w			varchar(4000);


BEGIN 
vl_anterior_w := vl_anterior_p;
 
select	cd_moeda, 
	dt_emissao, 
	vl_saldo_titulo, 
	ie_situacao 
into STRICT	cd_moeda_w, 
	dt_emissao_w, 
	vl_saldo_titulo_w, 
	ie_situacao_w 
from	titulo_pagar 
where	nr_titulo = nr_titulo_p;
 
if (coalesce(ie_situacao_w,'A') = 'B') then 
	-- O título está bloqueado! Verifique a situação do título. 
	CALL wheb_mensagem_pck.exibir_mensagem_abort(323879);
end if;
 
if (trunc(dt_emissao_w,'dd') > trunc(clock_timestamp(),'dd')) then 
	-- A data da alteração não pode ser menor do que a data de emissão do título 
	CALL wheb_mensagem_pck.exibir_mensagem_abort(150835);
end if;
 
if (vl_saldo_titulo_w <> vl_anterior_p) then 
	vl_anterior_w := vl_saldo_titulo_w;
end if;
 
select	count(*) 
into STRICT	qt_alteracao_ant_w 
from	titulo_pagar_alt_valor 
where	nr_titulo = nr_titulo_p 
and	trunc(dt_alteracao,'dd') > trunc(clock_timestamp(),'dd');
 
if (qt_alteracao_ant_w > 0) then 
	-- A data da alteração deve ser maior do que as datas de alterações anteriores 
	CALL wheb_mensagem_pck.exibir_mensagem_abort(150843);
end if;
 
select 	count(*) 
into STRICT	qt_registros_w 
from 	titulo_pagar_imposto 
where 	ie_pago_prev = 'V' 
and 	nr_titulo = nr_titulo_p;
 
if (qt_registros_w > 0) then 
	-- Este título possui impostos! Não pode ter seu valor alterado. 
	CALL wheb_mensagem_pck.exibir_mensagem_abort(150873);
end if;
 
if (vl_alterado_p <> vl_anterior_w) then 
	begin 
		select	coalesce(max(nr_sequencia), 0) + 1 
		into STRICT	nr_seq_alteracao_w 
		from	titulo_pagar_alt_valor 
		where	nr_titulo	= nr_titulo_p;
		 
		insert into titulo_pagar_alt_valor(nr_sequencia, 
			nr_titulo, 
			dt_alteracao, 
			vl_anterior, 
			vl_alteracao, 
			cd_moeda, 
			dt_atualizacao, 
			nm_usuario, 
			nr_lote_contabil) 
		values (nr_seq_alteracao_w, 
			nr_titulo_p, 
			clock_timestamp(), 
			vl_anterior_w, 
			vl_alterado_p, 
			cd_moeda_w, 
			clock_timestamp(), 
			nm_usuario_p, 
			0);
		 
		CALL atualizar_tit_pagar_classif(nr_titulo_p,'S',nm_usuario_p);
		 
		CALL atualizar_saldo_tit_pagar(nr_titulo_p,nm_usuario_p);
		 
		CALL gerar_w_tit_pag_imposto(nr_titulo_p,nm_usuario_p);
		 
		if (coalesce(ie_alt_bordero_p,'N') = 'S') then 
			CALL atualiza_tit_pagar_alt_valor(nr_titulo_p,vl_alterado_p);
		end if;
		 
	exception when others then 
		ds_erro_w	:= sqlerrm(SQLSTATE);
		CALL wheb_mensagem_pck.exibir_mensagem_abort(ds_erro_w);
	end;
	 
	commit;
end if;
 
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE altera_vl_titulo_parc_emprest (nr_titulo_p bigint, vl_alterado_p bigint, vl_anterior_p bigint, ie_alt_bordero_p text, nm_usuario_p text) FROM PUBLIC;

