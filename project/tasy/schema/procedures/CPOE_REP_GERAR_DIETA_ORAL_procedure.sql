-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE cpoe_rep_gerar_dieta_oral ( nr_prescricao_p prescr_medica.nr_prescricao%type, nr_atendimento_p atendimento_paciente.nr_atendimento%type, dt_inicio_prescr_p timestamp, dt_validade_prescr_p timestamp, dt_liberacao_p timestamp, nm_usuario_p usuario.nm_usuario%type, cd_pessoa_fisica_p pessoa_fisica.cd_pessoa_fisica%type, cd_funcao_origem_p funcao.cd_funcao%type, cd_setor_atendimento_p prescr_medica.cd_setor_atendimento%type default null) AS $body$
DECLARE


cd_dieta_w				prescr_dieta.cd_dieta%type;
cd_intervalo_w			prescr_dieta.cd_intervalo%type;
ds_horarios_w			prescr_dieta.ds_horarios%type;
ds_justificativa_w		prescr_dieta.ds_justificativa%type;
ds_observacao_w			prescr_dieta.ds_observacao%type;
hr_prim_horario_w		prescr_dieta.hr_prim_horario%type;
ie_urgencia_w			prescr_dieta.ie_urgencia%type;
ie_via_aplicacao_w		prescr_dieta.ie_via_aplicacao%type;
qt_parametro_w			prescr_dieta.qt_parametro%type;
nr_seq_dieta_w			prescr_dieta.nr_sequencia%type;
cd_perfil_ativo_w		prescr_dieta.cd_perfil_ativo%type;

nr_sequencia_w			cpoe_dieta.nr_sequencia%type;
dt_prim_horario_w		cpoe_dieta.dt_inicio%type;

ie_retrogrado_w			prescr_medica.ie_prescr_emergencia%type;
dt_liberacao_enf_w		timestamp;
nm_usuario_lib_enf_w	prescr_medica.nm_usuario_lib_enf%type;
cd_medico_w				prescr_medica.cd_medico%type;

c01 CURSOR FOR
SELECT	cd_dieta,
		cd_intervalo,
		ds_horarios,
		ds_justificativa,
		ds_observacao,
		hr_prim_horario,
		coalesce(ie_urgencia,'N'),
		ie_via_aplicacao,
		qt_parametro,
		nr_sequencia,
		cd_perfil_ativo
from	prescr_dieta
where	nr_prescricao = nr_prescricao_p;


BEGIN

select 	max(coalesce(ie_prescr_emergencia,'N')),
		max(dt_liberacao),
		max(nm_usuario_lib_enf),
		max(cd_medico)
into STRICT	ie_retrogrado_w,
		dt_liberacao_enf_w,
		nm_usuario_lib_enf_w,
		cd_medico_w
from	prescr_medica
where	nr_prescricao = nr_prescricao_p;		

open c01;
loop
fetch c01 into	cd_dieta_w,
				cd_intervalo_w,
				ds_horarios_w,
				ds_justificativa_w,
				ds_observacao_w,
				hr_prim_horario_w,
				ie_urgencia_w,
				ie_via_aplicacao_w,
				qt_parametro_w,
				nr_seq_dieta_w,
				cd_perfil_ativo_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	begin
	
	if (hr_prim_horario_w IS NOT NULL AND hr_prim_horario_w::text <> '') then
		dt_prim_horario_w := trunc(ESTABLISHMENT_TIMEZONE_UTILS.dateAtTime(dt_inicio_prescr_p, hr_prim_horario_w), 'mi');
		if (dt_prim_horario_w < dt_inicio_prescr_p) then
			dt_prim_horario_w := dt_prim_horario_w + 1;
		end if;
	else
		dt_prim_horario_w := dt_inicio_prescr_p;
	end if;
	
	select	nextval('cpoe_dieta_seq')
	into STRICT	nr_sequencia_w
	;
	
	insert into	cpoe_dieta(
			nr_sequencia,
			nr_atendimento,
			ie_tipo_dieta,
			ie_administracao,
			ie_duracao,
			dt_inicio,
			dt_fim,
			dt_prox_geracao,
			dt_liberacao,
			cd_dieta,
			cd_intervalo,
			ds_horarios,
			ds_justificativa,
			ds_observacao,
			hr_prim_horario,
			ie_urgencia,
			ie_via_aplicacao,
			nm_usuario,
			nm_usuario_nrec,
			dt_atualizacao,
			dt_atualizacao_nrec,
			cd_perfil_ativo,
			cd_pessoa_fisica,
			cd_funcao_origem,
            qt_dose,
			cd_setor_atendimento,
			ie_retrogrado,
			dt_liberacao_enf,
			nm_usuario_lib_enf,
			cd_medico)
		values (
			nr_sequencia_w,
			nr_atendimento_p,
			'O',
			'P',
			'P',
			dt_prim_horario_w,
			dt_validade_prescr_p,
			dt_liberacao_p,
			dt_validade_prescr_p + 12/24,
			cd_dieta_w,
			cd_intervalo_w,
			ds_horarios_w,
			ds_justificativa_w,
			ds_observacao_w,
			hr_prim_horario_w,
			CASE WHEN ie_urgencia_w='S' THEN '0'  ELSE null END ,
			ie_via_aplicacao_w,
			nm_usuario_p,
			nm_usuario_p,
			clock_timestamp(),
			clock_timestamp(),
			cd_perfil_ativo_w,
			cd_pessoa_fisica_p,
			cd_funcao_origem_p,
            qt_parametro_w,
			cd_setor_atendimento_p,
			ie_retrogrado_w,
			dt_liberacao_enf_w,
			nm_usuario_lib_enf_w,
			cd_medico_w);

	update	prescr_dieta
	set		nr_seq_dieta_cpoe = nr_sequencia_w
	where	nr_sequencia = nr_seq_dieta_w
	and		nr_prescricao = nr_prescricao_p;
	end;
	
end loop;
close c01;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cpoe_rep_gerar_dieta_oral ( nr_prescricao_p prescr_medica.nr_prescricao%type, nr_atendimento_p atendimento_paciente.nr_atendimento%type, dt_inicio_prescr_p timestamp, dt_validade_prescr_p timestamp, dt_liberacao_p timestamp, nm_usuario_p usuario.nm_usuario%type, cd_pessoa_fisica_p pessoa_fisica.cd_pessoa_fisica%type, cd_funcao_origem_p funcao.cd_funcao%type, cd_setor_atendimento_p prescr_medica.cd_setor_atendimento%type default null) FROM PUBLIC;

