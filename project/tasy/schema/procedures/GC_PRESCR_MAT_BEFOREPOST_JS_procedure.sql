-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gc_prescr_mat_beforepost_js ( cd_material_p bigint, cd_fornec_consignado_p text, qt_material_anterior_p bigint, qt_material_atual_p bigint, nm_maquina_atual_p text, cd_setor_atendimento_p bigint, nr_cirurgia_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint, cd_kit_material_p text ) AS $body$
DECLARE



cd_local_estoque_w		varchar(10);
ie_baixa_estoque 		varchar(1);
qt_conversao_w          	double precision  := 0;
qt_saldo_disp_w         	integer;
ie_tipo_material_w		varchar(3);
qt_saldo_disp_consig_w		double precision := 0;
consistir_mat_med_prescr_w	varchar(1);
ie_se_material_prescricao_w	varchar(1);


BEGIN
cd_local_estoque_w := obter_local_estoque_gest_cir(nm_maquina_atual_p,cd_setor_atendimento_p,nr_cirurgia_p,nm_usuario_p,cd_estabelecimento_p);

SELECT coalesce(MAX(ie_atualiza_estoque),'S')
into STRICT ie_baixa_estoque
FROM tipo_baixa_prescricao
WHERE cd_tipo_baixa = (SELECT coalesce(MAX(obter_se_mat_baixa_estoque_cir(cd_material_p, cd_local_estoque_w, nr_cirurgia_p, cd_kit_material_p, 0, 0)),-1)
			);

if (cd_material_p IS NOT NULL AND cd_material_p::text <> '') and (ie_baixa_estoque = 'S') then
	begin

	select	qt_conv_estoque_consumo
	into STRICT	qt_conversao_w
	from	material
	where	cd_material = cd_material_p;

	qt_saldo_disp_w := obter_saldo_disp_estoque(cd_estabelecimento_p,cd_material_p,cd_local_estoque_w,trunc(clock_timestamp(),'mm'));

	ie_tipo_material_w := obter_se_mat_consignado(cd_material_p);

	if	(ie_tipo_material_w = '1' AND cd_fornec_consignado_p IS NOT NULL AND cd_fornec_consignado_p::text <> '') or
		(ie_tipo_material_w = '2' AND cd_fornec_consignado_p IS NOT NULL AND cd_fornec_consignado_p::text <> '') then
		begin

		qt_saldo_disp_consig_w := obter_saldo_estoque_consig(cd_estabelecimento_p,cd_fornec_consignado_p,cd_material_p,cd_local_estoque_w);

		if (qt_material_anterior_p > qt_material_atual_p) then
			begin
			qt_saldo_disp_consig_w := qt_saldo_disp_consig_w + qt_material_anterior_p;
			end;
		end if;

		if	(qt_saldo_disp_consig_w < (qt_material_atual_p / qt_conversao_w)) then
			begin
			CALL WHEB_MENSAGEM_PCK.Exibir_Mensagem_Abort(47144, 'QT_SALDO=' || qt_saldo_disp_consig_w || ';QT_MATERIAL=' || qt_material_atual_p);
			end;
		end if;
		end;
	else if	((ie_tipo_material_w = '1') and (coalesce(cd_fornec_consignado_p::text, '') = '')) then
		begin
		CALL WHEB_MENSAGEM_PCK.Exibir_Mensagem_Abort(47145);
		end;
	     end if;
	end if;

	if (ie_tipo_material_w = '0') or
		((ie_tipo_material_w = '2') and (coalesce(cd_fornec_consignado_p::text, '') = ''))  then
		begin

	        if (qt_material_anterior_p > qt_material_atual_p) then
			begin
			qt_saldo_disp_w := qt_saldo_disp_w + qt_material_anterior_p;
			end;
		end if;

		if	(qt_saldo_disp_w < (qt_material_atual_p / qt_conversao_w)) then
			begin
			CALL WHEB_MENSAGEM_PCK.Exibir_Mensagem_Abort(47144, 'QT_SALDO=' || qt_saldo_disp_w || ';QT_MATERIAL=' || qt_material_atual_p);
			end;
		end if;
	        end;
	end if;

	consistir_mat_med_prescr_w := obter_param_usuario(900, 183, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, consistir_mat_med_prescr_w);

	ie_se_material_prescricao_w := obter_se_material_prescricao(cd_estabelecimento_p, cd_material_p);

	if (consistir_mat_med_prescr_w = 'S') and (cd_material_p IS NOT NULL AND cd_material_p::text <> '') and (ie_se_material_prescricao_w = 'N') then
		begin
		CALL WHEB_MENSAGEM_PCK.Exibir_Mensagem_Abort(47146);
		end;
	end if;
	end;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gc_prescr_mat_beforepost_js ( cd_material_p bigint, cd_fornec_consignado_p text, qt_material_anterior_p bigint, qt_material_atual_p bigint, nm_maquina_atual_p text, cd_setor_atendimento_p bigint, nr_cirurgia_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint, cd_kit_material_p text ) FROM PUBLIC;

