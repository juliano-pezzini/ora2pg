-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_interf_unibanco (nr_seq_envio_p bigint, nm_usuario_p text) AS $body$
DECLARE

 
nr_seq_arquivo_w	bigint;
tp_registro_w		bigint;
ie_forma_pagto_w	varchar(255);
nr_seq_forma_pagto_w	bigint;
nr_inscricao_w		varchar(255);
cd_agencia_w		varchar(255);
cd_conta_w		varchar(15);
ds_dac_agencia_w	varchar(255);
nm_empresa_w		varchar(255);
ds_banco_w		varchar(255);
dt_arquivo_w		timestamp;
nr_seq_envio_w		bigint;
ie_tipo_fornecedor_w	varchar(255);
cd_cgc_fornecedor_w	varchar(255);
nm_hospital_w		varchar(255);
ds_endereco_w		varchar(255);
nr_endereco_w		varchar(255);
ds_complemento_w	varchar(255);
ds_bairro_w		varchar(255);
ds_cidade_w		varchar(255);
cd_cep_w		varchar(255);
ds_estado_w		varchar(255);
cd_banco_fornecedor_w	bigint;
cd_agencia_fornecedor_w	varchar(255);
cd_agencia_conta_w	varchar(255);
nm_fornecedor_w		varchar(255);
nr_documento_w		bigint;
dt_vencimento_w		timestamp;
vl_saldo_titulo_w	double precision;
qt_registros_w		bigint;
ie_tipo_titulo_w	bigint;
ie_cod_barras_w		varchar(255);
dt_emissao_w		timestamp;
dt_limite_w		timestamp;
vl_titulo_w		double precision;
vl_desconto_w		double precision;
vl_abatimento_w		double precision;
vl_mora_w		double precision;
dt_desconto_w		timestamp;
vl_acrescimo_w		double precision;
dt_pagto_w		timestamp;
vl_pagto_w		double precision;
vl_total_pagto_w	double precision;
qt_lotes_arquivo_w	bigint;
qt_total_registros_w	bigint;
cd_moeda_w		varchar(255);
ds_nosso_numero_w	varchar(255);
cd_camara_w		varchar(10);
ie_digito_conta_w	varchar(2);

nr_seq_apres_w			bigint	:= 0;
qt_lotes_w			bigint	:=0;
nr_lote_w			bigint	:= 1;
nr_registro_w			bigint	:= 1;
nr_seq_reg_lote_w		bigint	:= 1;

c01 CURSOR FOR 
SELECT	nr_seq_arquivo,	 
	tp_registro, 
	ie_forma_pagto, 
	nr_seq_forma_pagto, 
	nr_inscricao, 
	cd_agencia, 
	substr(cd_conta,1,15) cd_conta, 
	ds_dac_agencia, 
	ie_digito_conta, 
	nm_empresa, 
	ds_banco, 
	dt_arquivo, 
	nr_seq_envio, 
	ie_tipo_fornecedor, 
	cd_cgc_fornecedor, 
	nm_hospital, 
	ds_endereco, 
	nr_endereco, 
	ds_complemento, 
	ds_bairro, 
	ds_cidade, 
	cd_cep, 
	ds_estado, 
	cd_banco_fornecedor, 
	cd_agencia_fornecedor, 
	cd_agencia_conta, 
	nm_fornecedor, 
	nr_documento, 
	dt_vencimento, 
	vl_saldo_titulo, 
	qt_registros, 
	ie_tipo_titulo, 
	ie_cod_barras, 
	dt_emissao, 
	dt_limite, 
	vl_titulo, 
	vl_desconto, 
	vl_abatimento, 
	vl_mora, 
	dt_desconto, 
	vl_acrescimo, 
	dt_pagto, 
	vl_pagto, 
	vl_total_pagto, 
	qt_lotes_arquivo, 
	qt_total_registros, 
	cd_moeda, 
	ds_nosso_numero, 
	cd_camara 
FROM	( 
	SELECT	0						nr_seq_arquivo, 
		0						tp_registro, 
		'0' 						ie_forma_pagto, 
		0 						nr_seq_forma_pagto, 
		a.cd_cgc 					nr_inscricao, 
		g.cd_agencia_bancaria 				cd_agencia, 
		substr(g.cd_conta || g.ie_digito_conta,1,15)	cd_conta, 
		g.ie_digito_conta 				ds_dac_agencia, 
		g.ie_digito_conta 				ie_digito_conta, 
		UPPER(p.ds_razao_social) 			nm_empresa, 
		g.ds_banco, 
		e.dt_remessa_retorno 				dt_arquivo, 
		e.nr_sequencia 				nr_seq_envio, 
		'2' 						ie_tipo_fornecedor, 
		'0' 						cd_cgc_fornecedor, 
		'' 						nm_hospital, 
		'' 						ds_endereco, 
		'0' 						nr_endereco, 
		' '						ds_complemento, 
		' '						ds_bairro, 
		'' 						ds_cidade, 
		'0' 						cd_cep, 
		'' 						ds_estado, 
		0 						cd_banco_fornecedor, 
		'0' 						cd_agencia_fornecedor, 
		'' 						cd_agencia_conta, 
		''			 			nm_fornecedor, 
		0 						nr_documento, 
		clock_timestamp() 					dt_vencimento, 
		0 						vl_saldo_titulo, 
		0 						qt_registros, 
		0						ie_tipo_titulo, 
		'' 						ie_cod_barras, 
		clock_timestamp()					dt_emissao, 
		clock_timestamp()					dt_limite, 
		0 						vl_titulo, 
		0 						vl_desconto, 
		0						vl_abatimento, 
		0						vl_mora, 
		NULL						dt_desconto, 
		0 						vl_acrescimo, 
		clock_timestamp() 					dt_pagto, 
		0 						vl_pagto, 
		0 						vl_total_pagto, 
		0 						qt_lotes_arquivo, 
		0 						qt_total_registros, 
		''						cd_moeda, 
		''						ds_nosso_numero, 
		''						cd_camara 
	FROM	estabelecimento a, 
		banco_estabelecimento_v g, 
		pessoa_juridica p, 
		banco_escritural e 
	WHERE	e.cd_estabelecimento	= a.cd_estabelecimento 
	AND	a.cd_cgc		= p.cd_cgc 
	AND	g.nr_sequencia	= e.nr_seq_conta_banco 
	AND	g.ie_tipo_relacao 	IN ('EP','ECC') 
	
UNION
 
	/* Header do Lote Documento */
 
	SELECT	1						nr_seq_arquivo, 
		1 						tp_registro, 
		CASE WHEN c.ie_tipo_pagamento='CC' THEN '01' WHEN c.ie_tipo_pagamento='CCP' THEN '05' WHEN c.ie_tipo_pagamento='DOC' THEN '03' WHEN c.ie_tipo_pagamento='TED' THEN '41' WHEN c.ie_tipo_pagamento='BLQ' THEN CASE WHEN c.cd_banco='409' THEN '30'  ELSE '31' END  END  ie_forma_pagto, 
		1 						nr_seq_forma_pagto, 
		E.CD_CGC 					nr_inscricao, 
		b.cd_agencia_bancaria			 	cd_agencia, 
		substr(b.cd_conta || b.ie_digito_conta,1,15)	cd_conta, 
		b.ie_digito_conta 				ds_dac_agencia, 
		b.ie_digito_conta 				ie_digito_conta, 
		UPPER(j.ds_razao_social) 			nm_empresa, 
		b.ds_banco, 
		clock_timestamp() 					dt_arquivo, 
		a.nr_sequencia 				nr_seq_envio, 
		'2' 						ie_tipo_fornecedor, 
		' ' 						cd_cgc_fornecedor, 
		UPPER(j.ds_razao_social) 			nm_hospital, 
		UPPER(j.ds_endereco) 			ds_endereco, 
		'0' 						nr_endereco, 
		' '						ds_complemento, 
		' '						ds_bairro, 
		j.ds_municipio 				ds_cidade, 
		j.cd_cep, 
		j.sg_estado				 	ds_estado, 
		0 						cd_banco_fornecedor, 
		' ' 						cd_agencia_fornecedor, 
		' ' 						cd_agencia_conta, 
		' ' 						nm_fornecedor, 
		0 						nr_documento, 
		clock_timestamp() 					dt_vencimento, 
		0 						vl_saldo_titulo, 
		0 						qt_registros, 
		0						ie_tipo_titulo, 
		'' 						ie_cod_barras, 
		clock_timestamp()					dt_emissao, 
		clock_timestamp()					dt_limite, 
		0 						vl_titulo, 
		0 						vl_desconto, 
		0						vl_abatimento, 
		0						vl_mora, 
		NULL						dt_desconto, 
		0 						vl_acrescimo, 
		clock_timestamp() 					dt_pagto, 
		0 						vl_pagto, 
		0 						vl_total_pagto, 
		0 						qt_lotes_arquivo, 
		0 						qt_total_registros, 
		''						cd_moeda, 
		''						ds_nosso_numero, 
		''						cd_camara 
	FROM	pessoa_juridica j, 
		Estabelecimento e, 
		banco_estabelecimento_v b, 
		banco_escritural a, 
		titulo_pagar_v2 d, 
		titulo_pagar_v k,	 
		titulo_pagar_escrit c 
	WHERE	c.nr_titulo			= d.nr_titulo 
	AND	k.nr_titulo			= d.nr_titulo 
	AND	a.nr_sequencia		= c.nr_seq_escrit 
	AND	e.cd_cgc			= j.cd_cgc 
	AND	a.cd_estabelecimento  	= e.cd_estabelecimento 
	AND	b.ie_tipo_relacao    	IN ('EP','ECC') 
	AND	b.nr_sequencia		= a.nr_seq_conta_banco 
	AND	c.ie_tipo_pagamento		in ('DOC','TED','CC','CCP') 
	GROUP	BY E.CD_CGC, 
		b.cd_agencia_bancaria, 
		b.cd_conta, 
		b.ie_digito_conta, 
		UPPER(j.ds_razao_social), 
		b.ds_banco, 
		a.nr_sequencia, 
		UPPER(j.ds_razao_social), 
		UPPER(j.ds_endereco), 
		j.ds_municipio, 
		j.cd_cep, 
		j.sg_estado, 
		CASE WHEN c.ie_tipo_pagamento='CC' THEN '01' WHEN c.ie_tipo_pagamento='CCP' THEN '05' WHEN c.ie_tipo_pagamento='DOC' THEN '03' WHEN c.ie_tipo_pagamento='TED' THEN '41' WHEN c.ie_tipo_pagamento='BLQ' THEN CASE WHEN c.cd_banco='409' THEN '30'  ELSE '31' END  END  
	
UNION
 
	/* Detalhe Documento */
 
	SELECT	2						nr_seq_arquivo, 
		2 						tp_registro,	 
		CASE WHEN c.ie_tipo_pagamento='CC' THEN '01' WHEN c.ie_tipo_pagamento='CCP' THEN '05' WHEN c.ie_tipo_pagamento='DOC' THEN '03' WHEN c.ie_tipo_pagamento='TED' THEN '41' WHEN c.ie_tipo_pagamento='BLQ' THEN CASE WHEN c.cd_banco='409' THEN '30'  ELSE '31' END  END  ie_forma_pagto, 
		1 						nr_seq_forma_pagto, 
		e.cd_cgc 					nr_inscricao, 
		c.cd_agencia_bancaria				cd_agencia, 
		c.nr_conta					cd_conta, 
		CASE WHEN c.ie_tipo_pagamento='CC' THEN null  ELSE c.ie_digito_conta END  ds_dac_agencia, 
		c.ie_digito_conta 				ie_digito_conta, 
		'' 						nm_empresa, 
		'' 						ds_banco, 
		a.dt_remessa_retorno				dt_arquivo, 
		a.nr_sequencia 				nr_seq_envio, 
		CASE WHEN coalesce(k.cd_pessoa_fisica::text, '') = '' THEN '2'  ELSE '1' END  	ie_tipo_fornecedor, 
		d.cd_favorecido				cd_cgc_fornecedor, 
		'' 						nm_hospital, 
		'' 						ds_endereco, 
		'0' 						nr_endereco, 
		' '						ds_complemento, 
		' '						ds_bairro, 
		'' 						ds_cidade, 
		'0' 						cd_cep, 
		'' 						ds_estado, 
		c.cd_banco 					cd_banco_fornecedor, 
		c.cd_agencia_bancaria 				cd_agencia_fornecedor, 
		'0' || c.cd_agencia_bancaria || '0000000' || c.nr_conta cd_agencia_conta, 
		d.nm_favorecido 				nm_fornecedor, 
		d.nr_titulo 					nr_documento, 
		d.dt_vencimento_atual 			dt_vencimento, 
		d.vl_saldo_titulo, 
		0 						qt_registros, 
		0						ie_tipo_titulo, 
		'' 						ie_cod_barras, 
		k.dt_emissao					dt_emissao, 
		k.dt_vencimento_atual				dt_limite, 
		k.vl_titulo 					vl_titulo, 
		0 						vl_desconto, 
		0						vl_abatimento, 
		0						vl_mora, 
		NULL						dt_desconto, 
		0 						vl_acrescimo, 
		clock_timestamp() 					dt_pagto, 
		c.vl_escritural 				vl_pagto, 
		0 						vl_total_pagto, 
		0 						qt_lotes_arquivo, 
		0 						qt_total_registros, 
		'BRL', 
		k.nr_nosso_numero				ds_nosso_numero, 
		CASE WHEN c.ie_tipo_pagamento='CC' THEN '000' WHEN c.ie_tipo_pagamento='TED' THEN '018' WHEN c.ie_tipo_pagamento='DOC' THEN '700' END  cd_camara 
	FROM	Estabelecimento e, 
		banco_estabelecimento_v b, 
		banco_escritural a, 
		titulo_pagar_v2 d,	 
		titulo_pagar_v k, 
		titulo_pagar_escrit c 
	WHERE	c.nr_titulo			= d.nr_titulo 
	AND	k.nr_titulo			= d.nr_titulo 
	AND	a.nr_sequencia		= c.nr_seq_escrit 
	AND	a.cd_estabelecimento		= e.cd_estabelecimento 
	AND 	b.ie_tipo_relacao		IN ('EP','ECC') 
	AND	b.nr_sequencia		= a.nr_seq_conta_banco 
	AND	c.ie_tipo_pagamento		in ('DOC','TED','CC','CCP') 
	
UNION
 
	/* Detalhe Documento(Complemento) */
 
	SELECT	2						nr_seq_arquivo, 
		3 						tp_registro, 
		CASE WHEN c.ie_tipo_pagamento='CC' THEN '01' WHEN c.ie_tipo_pagamento='CCP' THEN '05' WHEN c.ie_tipo_pagamento='DOC' THEN '03' WHEN c.ie_tipo_pagamento='TED' THEN '41' WHEN c.ie_tipo_pagamento='BLQ' THEN CASE WHEN c.cd_banco='409' THEN '30'  ELSE '31' END  END  ie_forma_pagto, 
		1 						nr_seq_forma_pagto, 
		e.cd_cgc 					nr_inscricao, 
		c.cd_agencia_bancaria				cd_agencia, 
		c.nr_conta					cd_conta, 
		c.ie_digito_conta				ds_dac_agencia, 
		c.ie_digito_conta 				ie_digito_conta, 
		'' 						nm_empresa, 
		'' 						ds_banco, 
		a.dt_remessa_retorno				dt_arquivo, 
		a.nr_sequencia 				nr_seq_envio, 
		CASE WHEN coalesce(k.cd_pessoa_fisica::text, '') = '' THEN '2'  ELSE '1' END  	ie_tipo_fornecedor, 
		d.cd_favorecido				cd_cgc_fornecedor, 
		'' 						nm_hospital, 
		SUBSTR(obter_dados_pf_pj(NULL,d.cd_favorecido,'R'),1,255) ds_endereco, 
		SUBSTR(obter_dados_pf_pj(NULL,d.cd_favorecido,'NR'),1,255) nr_endereco, 
		SUBSTR(obter_dados_pf_pj(NULL,d.cd_favorecido,'CO'),1,255) ds_complemento, 
		SUBSTR(obter_dados_pf_pj(NULL,d.cd_favorecido,'B'),1,255) ds_bairro, 
		SUBSTR(obter_dados_pf_pj(NULL,d.cd_favorecido,'CI'),1,255) ds_cidade, 
		SUBSTR(obter_dados_pf_pj(NULL,d.cd_favorecido,'CEP'),1,255) cd_cep, 
		SUBSTR(obter_dados_pf_pj(NULL,d.cd_favorecido,'UF'),1,255) ds_estado, 
		c.cd_banco 					cd_banco_fornecedor, 
		c.cd_agencia_bancaria 				cd_agencia_fornecedor, 
		'0' || c.cd_agencia_bancaria || '0000000' || c.nr_conta cd_agencia_conta, 
		d.nm_favorecido 				nm_fornecedor, 
		d.nr_titulo 					nr_documento, 
		d.dt_vencimento_atual 			dt_vencimento, 
		d.vl_saldo_titulo, 
		0 						qt_registros, 
		0						ie_tipo_titulo, 
		'' 						ie_cod_barras, 
		k.dt_emissao					dt_emissao, 
		k.dt_vencimento_atual				dt_limite, 
		k.vl_titulo 					vl_titulo, 
		0 						vl_desconto, 
		0						vl_abatimento, 
		0						vl_mora, 
		NULL						dt_desconto, 
		0 						vl_acrescimo, 
		clock_timestamp() 					dt_pagto, 
		c.vl_escritural 				vl_pagto, 
		0 						vl_total_pagto, 
		0 						qt_lotes_arquivo, 
		0 						qt_total_registros, 
		'BRL', 
		k.nr_nosso_numero				ds_nosso_numero, 
		''						cd_camara 
	FROM	Estabelecimento e, 
		banco_estabelecimento_v b, 
		banco_escritural a, 
		titulo_pagar_v2 d,	 
		titulo_pagar_v k, 
		titulo_pagar_escrit c 
	WHERE	c.nr_titulo			= d.nr_titulo 
	AND	k.nr_titulo			= d.nr_titulo 
	AND	a.nr_sequencia		= c.nr_seq_escrit 
	AND	a.cd_estabelecimento		= e.cd_estabelecimento 
	AND 	b.ie_tipo_relacao		IN ('EP','ECC') 
	AND	b.nr_sequencia		= a.nr_seq_conta_banco 
	AND	c.ie_tipo_pagamento		in ('DOC','TED','CC','CCP') 
	
UNION
 
	/* Trailler do Lote Documento */
 
	SELECT	3						nr_seq_arquivo, 
		4 						tp_registro, 
		CASE WHEN c.ie_tipo_pagamento='CC' THEN '01' WHEN c.ie_tipo_pagamento='CCP' THEN '05' WHEN c.ie_tipo_pagamento='DOC' THEN '03' WHEN c.ie_tipo_pagamento='TED' THEN '41' WHEN c.ie_tipo_pagamento='BLQ' THEN CASE WHEN c.cd_banco='409' THEN '30'  ELSE '31' END  END  ie_forma_pagto, 
		1 						nr_seq_forma_pagto, 
		'0' 						nr_inscricao,		 
		'0'						cd_agencia, 
		'0'					 	cd_conta, 
		'' 						ds_dac_agencia, 
		''						ie_digito_conta, 
		'' 						nm_empresa, 
		'' 						ds_banco, 
		clock_timestamp()						dt_arquivo, 
		e.nr_sequencia 				nr_seq_envio, 
		' ' 						ie_tipo_fornecedor, 
		'0' 						cd_cgc_fornecedor, 
		'' 						nm_hospital, 
		'' 						ds_endereco, 
		'0' 						nr_endereco, 
		' '						ds_complemento, 
		' '						ds_bairro, 
		'' 						ds_cidade, 
		'0' 						cd_cep, 
		'' 						ds_estado, 
		0 						cd_banco_fornecedor, 
		'0' 						cd_agencia_fornecedor, 
		'' 						cd_agencia_conta, 
		'' 						nm_fornecedor, 
		0 						nr_documento, 
		clock_timestamp() 					dt_vencimento, 
		0 						vl_saldo_titulo, 
		((COUNT(*) * 2) +2) 					qt_registros, 
		0						ie_tipo_titulo, 
		'' 						ie_cod_barras, 
		clock_timestamp()					dt_emissao, 
		clock_timestamp()					dt_limite, 
		0 						vl_titulo, 
		0 						vl_desconto, 
		0						vl_abatimento, 
		0						vl_mora, 
		NULL						dt_desconto, 
		0 						vl_acrescimo, 
		clock_timestamp() 					dt_pagto, 
		0 						vl_pagto, 
		SUM(c.vl_escritural - c.vl_desconto + c.vl_acrescimo) vl_total_pagto, 
		0 						qt_lotes_arquivo, 
		0 						qt_total_registros, 
		''						cd_moeda, 
		''						ds_nosso_numero, 
		''						cd_camara 
	FROM	banco_estabelecimento_v b, 
		estabelecimento a,    
		banco_escritural e, 
		titulo_pagar k, 
		titulo_pagar_escrit c 
	WHERE	e.nr_sequencia		= c.nr_seq_escrit 
	AND	e.cd_estabelecimento  	= a.cd_estabelecimento 
	AND	k.nr_titulo			= c.nr_titulo 
	AND	b.ie_tipo_relacao 	   	IN ('EP','ECC') 
	AND	b.nr_sequencia		= e.nr_seq_conta_banco 
	AND	c.ie_tipo_pagamento		in ('DOC','TED','CC','CCP') 
	GROUP BY e.nr_sequencia, 
		CASE WHEN c.ie_tipo_pagamento='CC' THEN '01' WHEN c.ie_tipo_pagamento='CCP' THEN '05' WHEN c.ie_tipo_pagamento='DOC' THEN '03' WHEN c.ie_tipo_pagamento='TED' THEN '41' WHEN c.ie_tipo_pagamento='BLQ' THEN CASE WHEN c.cd_banco='409' THEN '30'  ELSE '31' END  END  
	
UNION
 
	/* Header do Lote Bloquetos*/
 
	SELECT	4						nr_seq_arquivo, 
		5 						tp_registro, 
		CASE WHEN c.ie_tipo_pagamento='CC' THEN '01' WHEN c.ie_tipo_pagamento='CCP' THEN '05' WHEN c.ie_tipo_pagamento='DOC' THEN '03' WHEN c.ie_tipo_pagamento='TED' THEN '41' WHEN c.ie_tipo_pagamento='BLQ' THEN CASE WHEN c.cd_banco='409' THEN '30'  ELSE '31' END  END  ie_forma_pagto, 
		1 						nr_seq_forma_pagto, 
		e.cd_cgc 					nr_inscricao, 
		b.cd_agencia_bancaria 				cd_agencia, 
		substr(b.cd_conta || b.ie_digito_conta,1,15)	cd_conta, 
		b.ie_digito_conta 				ds_dac_agencia, 
		b.ie_digito_conta 				ie_digito_conta, 
		UPPER(j.ds_razao_social) 			nm_empresa, 
		b.ds_banco, 
		clock_timestamp() 					dt_arquivo, 
		a.nr_sequencia 				nr_seq_envio, 
		'2' 						ie_tipo_fornecedor, 
		'' 						cd_cgc_fornecedor, 
		UPPER(j.ds_razao_social) 			nm_hospital, 
		UPPER(j.ds_endereco) 			ds_endereco, 
		'0' 						nr_endereco, 
		' '						ds_complemento, 
		' '						ds_bairro, 
		j.ds_municipio 				ds_cidade, 
		j.cd_cep, 
		j.sg_estado 					ds_estado, 
		0 						cd_banco_fornecedor, 
		'' 						cd_agencia_fornecedor, 
		'0' || b.cd_agencia_bancaria || '0000000' || b.CD_CONTA cd_agencia_conta, 
		'' 						nm_fornecedor, 
		0 						nr_documento, 
		clock_timestamp() 					dt_vencimento, 
		0 						vl_saldo_titulo, 
		0 						qt_registros, 
		0						ie_tipo_titulo, 
		'' 						ie_cod_barras, 
		clock_timestamp()					dt_emissao, 
		clock_timestamp()					dt_limite, 
		0 						vl_titulo, 
		0 						vl_desconto, 
		0						vl_abatimento, 
		0						vl_mora, 
		NULL						dt_desconto, 
		0 						vl_acrescimo, 
		clock_timestamp() 					dt_pagto, 
		0 						vl_pagto, 
		0 						vl_total_pagto, 
		0 						qt_lotes_arquivo, 
		0 						qt_total_registros, 
		''						cd_moeda, 
		''						ds_nosso_numero, 
		''						cd_camara 
	FROM	pessoa_juridica j, 
		Estabelecimento e, 
		banco_estabelecimento_v b, 
		banco_escritural a, 
		titulo_pagar k, 
		titulo_pagar_escrit c 
	WHERE	e.cd_cgc			= j.cd_cgc 
	AND	a.nr_sequencia     	= c.nr_seq_escrit 
	AND	a.cd_estabelecimento  	= e.cd_estabelecimento 
	AND	b.ie_tipo_relacao    	IN ('EP','ECC') 
	AND	a.nr_seq_conta_banco		= b.nr_sequencia 
	AND	c.nr_titulo			= k.nr_titulo 
	AND 	c.ie_tipo_pagamento		= 'BLQ' 
	GROUP	BY e.cd_cgc, 
		b.cd_agencia_bancaria, 
		b.cd_conta, 
		b.ie_digito_conta, 
		UPPER(j.ds_razao_social), 
		b.ds_banco, 
		a.nr_sequencia, 
		'0' || b.cd_agencia_bancaria || '0000000' || b.CD_CONTA, 
		UPPER(j.ds_endereco), 
		j.ds_municipio, 
		j.cd_cep, 
		j.sg_estado, 
		CASE WHEN c.ie_tipo_pagamento='CC' THEN '01' WHEN c.ie_tipo_pagamento='CCP' THEN '05' WHEN c.ie_tipo_pagamento='DOC' THEN '03' WHEN c.ie_tipo_pagamento='TED' THEN '41' WHEN c.ie_tipo_pagamento='BLQ' THEN CASE WHEN c.cd_banco='409' THEN '30'  ELSE '31' END  END  
	
UNION
 
	/* Detalhe Bloquetos */
 
	SELECT	5						nr_seq_arquivo, 
		6						tp_registro, 
		CASE WHEN c.ie_tipo_pagamento='CC' THEN '01' WHEN c.ie_tipo_pagamento='CCP' THEN '05' WHEN c.ie_tipo_pagamento='DOC' THEN '03' WHEN c.ie_tipo_pagamento='TED' THEN '41' WHEN c.ie_tipo_pagamento='BLQ' THEN CASE WHEN c.cd_banco='409' THEN '30'  ELSE '31' END  END  ie_forma_pagto, 
		1 						nr_seq_forma_pagto, 
		'0' 						nr_inscricao, 
		c.cd_agencia_bancaria				cd_agencia, 
		c.nr_conta					cd_conta, 
		c.ie_digito_conta 				ds_dac_agencia, 
		c.ie_digito_conta 				ie_digito_conta, 
		'' 						nm_empresa, 
		'' 						ds_banco, 
		a.dt_remessa_retorno				dt_arquivo, 
		a.nr_sequencia 				nr_seq_envio, 
		CASE WHEN coalesce(k.cd_pessoa_fisica::text, '') = '' THEN '2'  ELSE '1' END  	ie_tipo_fornecedor, 
		d.cd_favorecido 				cd_cgc_fornecedor, 
		'' 						nm_hospital, 
		'' 						ds_endereco, 
		'0' 						nr_endereco, 
		' '						ds_complemento, 
		' '						ds_bairro, 
		d.ds_cidade					ds_cidade, 
		'0' 						cd_cep, 
		'' 						ds_estado, 
		c.cd_banco 					cd_banco_fornecedor, 
		c.cd_agencia_bancaria 			cd_agencia_fornecedor, 
		'0' || c.cd_agencia_bancaria || '0000000' || c.nr_conta cd_agencia_conta, 
		d.nm_favorecido 				nm_fornecedor, 
		d.nr_titulo 					nr_documento, 
		k.dt_vencimento_atual 				dt_vencimento, 
		d.vl_saldo_titulo 				vl_saldo_titulo, 
		0 						qt_registros, 
		CASE WHEN d.ie_tipo_titulo=0 THEN 23 WHEN d.ie_tipo_titulo=2 THEN 4 WHEN d.ie_tipo_titulo=3 THEN 12  ELSE 99 END 	ie_tipo_titulo,	 
		d.nr_bloqueto 				ie_cod_barras, 
		k.dt_emissao					dt_emissao, 
		k.dt_vencimento_atual				dt_limite, 
		d.vl_titulo, 
		c.vl_desconto, 
		0						vl_abatimento, 
		0						vl_mora, 
		NULL						dt_desconto, 
		c.vl_acrescimo, 
		clock_timestamp()				dt_pagto, --(dt_limite) 
		c.vl_escritural 				vl_pagto, 
		0 						vl_total_pagto, 
		0 						qt_lotes_arquivo, 
		0 						qt_total_registros, 
		''						cd_moeda, 
		''						ds_nosso_numero, 
		''						cd_camara 
	FROM	Estabelecimento e, 
		banco_estabelecimento_v b, 
		banco_escritural a, 
		titulo_pagar_v2 d,	 
		titulo_pagar_v k, 
		titulo_pagar_escrit c 
	WHERE	c.nr_titulo			= d.nr_titulo 
	AND	k.nr_titulo			= d.nr_titulo 
	AND	a.nr_sequencia		= c.nr_seq_escrit 
	AND	a.cd_estabelecimento		= e.cd_estabelecimento 
	AND 	b.ie_tipo_relacao		IN ('EP','ECC') 
	AND	a.nr_seq_conta_banco		= b.nr_sequencia 
	AND 	c.ie_tipo_pagamento		= 'BLQ' 
	
UNION
 
	/* Trailler do Lote Bloquetos */
 
	SELECT	6						nr_seq_arquivo, 
		7 						tp_registro, 
		CASE WHEN c.ie_tipo_pagamento='CC' THEN '01' WHEN c.ie_tipo_pagamento='CCP' THEN '05' WHEN c.ie_tipo_pagamento='DOC' THEN '03' WHEN c.ie_tipo_pagamento='TED' THEN '41' WHEN c.ie_tipo_pagamento='BLQ' THEN CASE WHEN c.cd_banco='409' THEN '30'  ELSE '31' END  END  ie_forma_pagto, 
		1 						nr_seq_forma_pagto, 
		'0' 						nr_inscricao, 
		'0' 						cd_agencia, 
		'0' 						cd_conta, 
		'' 						ds_dac_agencia, 
		''						ie_digito_conta, 
		'' 						nm_empresa, 
		'' 						ds_banco, 
		clock_timestamp() 					dt_arquivo, 
		e.nr_sequencia 				nr_seq_envio, 
		' ' 						ie_tipo_fornecedor, 
		'0' 						cd_cgc_fornecedor, 
		'' 						nm_hospital, 
		'' 						ds_endereco, 
		'0' 						nr_endereco, 
		' '						ds_complemento, 
		' '						ds_bairro, 
		'' 						ds_cidade, 
		'0' 						cd_cep, 
		'' 						ds_estado, 
		0 						cd_banco_fornecedor, 
		'0' 						cd_agencia_fornecedor, 
		'' 						cd_agencia_conta, 
		'' 						nm_fornecedor, 
		0 						nr_documento, 
		clock_timestamp() 					dt_vencimento, 
		0 						vl_saldo_titulo, 
		(COUNT(*) + 2) 				qt_registros, 
		0						ie_tipo_titulo, 
		'' 						ie_cod_barras, 
		clock_timestamp()					dt_emissao, 
		clock_timestamp()					dt_limite, 
		SUM(d.vl_titulo) 				vl_titulo, 
		SUM(c.vl_desconto) 				vl_desconto, 
		0						vl_abatimento, 
		0						vl_mora, 
		NULL						dt_desconto, 
		SUM(c.vl_acrescimo) 				vl_acrescimo, 
		clock_timestamp() 					dt_pagto, 
		SUM(c.vl_escritural) 			vl_pagto, 
		SUM(c.vl_escritural - c.vl_desconto + c.vl_acrescimo) vl_total_pagto, 
		COUNT(*) 					qt_lotes_arquivo, 
		COUNT(*) 					qt_total_registros, 
		''						cd_moeda, 
		''						ds_nosso_numero, 
		''						cd_camara 
	FROM	banco_estabelecimento_v b, 
		titulo_pagar_v2 d,	 
		titulo_pagar k, 
		estabelecimento a,    
		banco_escritural e, 
		titulo_pagar_escrit c 
	WHERE	e.nr_sequencia		= c.nr_seq_escrit 
	AND	c.nr_titulo			= d.nr_titulo 
	AND	k.nr_titulo			= d.nr_titulo 
	AND	e.cd_estabelecimento  	= a.cd_estabelecimento 
	AND	b.ie_tipo_relacao    	IN ('EP','ECC') 
	AND	b.nr_sequencia		= e.nr_seq_conta_banco 
	AND 	c.ie_tipo_pagamento		= 'BLQ' 
	GROUP BY e.nr_sequencia, 
		CASE WHEN c.ie_tipo_pagamento='CC' THEN '01' WHEN c.ie_tipo_pagamento='CCP' THEN '05' WHEN c.ie_tipo_pagamento='DOC' THEN '03' WHEN c.ie_tipo_pagamento='TED' THEN '41' WHEN c.ie_tipo_pagamento='BLQ' THEN CASE WHEN c.cd_banco='409' THEN '30'  ELSE '31' END  END  
	
UNION
 
	/* Trailler do Arquivo*/
 
	SELECT	7						nr_seq_arquivo, 
		8						tp_registro, 
		'99' 						ie_forma_pagto, 
		0 						nr_seq_forma_pagto, 
		'0'						nr_inscricao, 
		'0' 						cd_agencia, 
		'0' 						cd_conta, 
		'' 						ds_dac_agencia, 
		''						ie_digito_conta, 
		'' 						nm_empresa, 
		'' 						ds_banco, 
		clock_timestamp() 					dt_arquivo, 
		e.nr_sequencia 				nr_seq_envio, 
		' ' 						ie_tipo_fornecedor, 
		'0' 						cd_cgc_fornecedor, 
		'' 						nm_hospital, 
		'' 						ds_endereco, 
		'0' 						nr_endereco, 
		' '						ds_complemento, 
		' '						ds_bairro, 
		'' 						ds_cidade, 
		'0' 						cd_cep, 
		'' 						ds_estado, 
		0 						cd_banco_fornecedor, 
		'0' 						cd_agencia_fornecedor, 
		'' 						cd_agencia_conta, 
		''						nm_fornecedor, 
		99999						nr_documento, 
		clock_timestamp() 					dt_vencimento, 
		0 						vl_saldo_titulo, 
		0 						qt_registros, 
		0						ie_tipo_titulo, 
		'' 						ie_cod_barras, 
		clock_timestamp()					dt_emissao, 
		clock_timestamp()					dt_limite, 
		0 						vl_titulo, 
		0 						vl_desconto, 
		0						vl_abatimento, 
		0						vl_mora, 
		NULL						dt_desconto, 
		0 						vl_acrescimo, 
		clock_timestamp() 					dt_pagto, 
		0 						vl_pagto, 
		0 						vl_total_pagto, 
		COUNT(*) 					qt_lotes_arquisvo, 
		COUNT(*) 					qt_total_registros, 
		''						cd_moeda, 
		''						ds_nosso_numero, 
		''						cd_camara 
	FROM	banco_estabelecimento_v b, 
		estabelecimento a,    
		banco_escritural e 
	WHERE	e.cd_estabelecimento  	= a.cd_estabelecimento 
	AND	b.ie_tipo_relacao    	IN ('EP','ECC') 
	AND	b.nr_sequencia		= e.nr_seq_conta_banco 
	GROUP BY e.nr_sequencia 
	ORDER BY ie_forma_pagto, 
		nr_seq_arquivo, 
		nr_documento, 
		tp_registro) alias93 
where	nr_seq_envio = nr_seq_envio_p;


BEGIN 
 
delete	from w_interf_itau;
commit;
 
open c01;
loop 
fetch c01 into 
	nr_seq_arquivo_w, 
	tp_registro_w, 
	ie_forma_pagto_w, 
	nr_seq_forma_pagto_w, 
	nr_inscricao_w, 
	cd_agencia_w, 
	cd_conta_w, 
	ds_dac_agencia_w, 
	ie_digito_conta_w, 
	nm_empresa_w, 
	ds_banco_w, 
	dt_arquivo_w, 
	nr_seq_envio_w, 
	ie_tipo_fornecedor_w, 
	cd_cgc_fornecedor_w, 
	nm_hospital_w, 
	ds_endereco_w, 
	nr_endereco_w, 
	ds_complemento_w, 
	ds_bairro_w, 
	ds_cidade_w, 
	cd_cep_w, 
	ds_estado_w, 
	cd_banco_fornecedor_w, 
	cd_agencia_fornecedor_w, 
	cd_agencia_conta_w, 
	nm_fornecedor_w, 
	nr_documento_w, 
	dt_vencimento_w, 
	vl_saldo_titulo_w, 
	qt_registros_w, 
	ie_tipo_titulo_w, 
	ie_cod_barras_w, 
	dt_emissao_w, 
	dt_limite_w, 
	vl_titulo_w, 
	vl_desconto_w, 
	vl_abatimento_w, 
	vl_mora_w, 
	dt_desconto_w, 
	vl_acrescimo_w, 
	dt_pagto_w, 
	vl_pagto_w, 
	vl_total_pagto_w, 
	qt_lotes_arquivo_w, 
	qt_total_registros_w, 
	cd_moeda_w, 
	ds_nosso_numero_w, 
	cd_camara_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
 
insert	into	w_interf_itau(nr_sequencia, 
		nm_usuario, 
		dt_atualizacao, 
		nm_usuario_nrec, 
		dt_atualizacao_nrec, 
		nr_seq_apres, 
		ie_tipo_registro, 
		ie_forma_pagto, 
		nr_lote, 
		nr_inscricao, 
		cd_agencia_bancaria, 
		cd_conta, 
		ds_dac_agencia, 
		ie_digito_conta, 
		nm_empresa,	 
		ds_banco, 
		dt_geracao, 
		nr_seq_envio, 
		ie_tipo_inscricao, 
		cd_cgc_fornecedor, 
		cd_carteira, 
		ds_endereco, 
		nr_endereco, 
		ds_complemento, 
		ds_bairro, 
		ds_cidade, 
		cd_cep, 
		sg_estado, 
		cd_banco_fornec, 
		nm_fornecedor, 
		nr_documento, 
		dt_vencimento, 
		vl_saldo_titulo, 
		qt_registros, 
		ie_forma_lancamento, 
		cd_barras, 
		vl_titulo, 
		vl_desconto, 
		vl_acrescimo, 
		dt_pagto, 
		vl_pagto, 
		vl_total_pagto, 
		qt_lote_arquivo, 
		qt_tot_reg, 
		nr_registro, 
		cd_camara_compensacao, 
		nr_seq_reg_lote) 
	values (nextval('w_interf_itau_seq'), 
		nm_usuario_p, 
		clock_timestamp(), 
		nm_usuario_p, 
		clock_timestamp(), 
		nr_seq_apres_w, 
		tp_registro_w, 
		ie_forma_pagto_w, 
		nr_lote_w, 
		nr_inscricao_w, 
		cd_agencia_w, 
		cd_conta_w, 
		ds_dac_agencia_w, 
		ie_digito_conta_w, 
		nm_empresa_w, 
		ds_banco_w, 
		dt_arquivo_w, 
		nr_seq_envio_w, 
		ie_tipo_fornecedor_w, 
		cd_cgc_fornecedor_w, 
		cd_agencia_conta_w, 
		ds_endereco_w, 
		nr_endereco_w, 
		ds_complemento_w, 
		ds_bairro_w, 
		ds_cidade_w, 
		cd_cep_w, 
		ds_estado_w, 
		cd_banco_fornecedor_w, 
		nm_fornecedor_w, 
		nr_documento_w, 
		dt_vencimento_w, 
		vl_saldo_titulo_w, 
		qt_registros_w, 
		ie_tipo_titulo_w, 
		ie_cod_barras_w, 
		vl_titulo_w, 
		vl_desconto_w, 
		vl_acrescimo_w, 
		dt_pagto_w, 
		vl_pagto_w, 
		vl_total_pagto_w, 
		qt_lotes_arquivo_w, 
		qt_total_registros_w, 
		nr_registro_w, 
		cd_camara_w, 
		nr_seq_reg_lote_w);
 
nr_seq_apres_w := nr_seq_apres_w + 1;
 
	/* So incrementar o numero do registro quando detalhe */
 
if (tp_registro_w in ('2','3','6')) then 
	nr_registro_w		:= nr_registro_w + 1;
	end if;
 
/* Quando passou do Trailler muda o numero do lote */
 
if (tp_registro_w in ('4','7')) then 
	qt_lotes_w		:= qt_lotes_w + 1;
	nr_lote_w		:= nr_lote_w + 1;
	nr_registro_w		:= 1;
	nr_seq_reg_lote_w 	:= nr_lote_w - 1;
	end if;
 
end loop;
close c01;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_interf_unibanco (nr_seq_envio_p bigint, nm_usuario_p text) FROM PUBLIC;

