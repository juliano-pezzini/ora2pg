-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE plt_excluir_item ( nr_prescricao_p bigint, nr_sequencia_p bigint, nm_tabela_p text, nm_usuario_p text, cd_perfil_p bigint) AS $body$
DECLARE

 
ie_vazia_w		varchar(1);
nr_prescr_orig_w	bigint;
nr_seq_orig_w		bigint;
ie_prescr_dieta_w	varchar(1);
ds_erro_w		varchar(2000);
nr_seq_leite_deriv_w	bigint;
nr_agrupamento_w	bigint;
nr_seq_solic_sangue_w	bigint;
ie_existe_kit_w			smallint;
				

BEGIN 
 
if (upper(nm_tabela_p) = 'PRESCR_MATERIAL') then 
 
	select	max(nr_seq_leite_deriv) 
	into STRICT	nr_seq_leite_deriv_w 
	from	prescr_material 
	where	nr_prescricao	= nr_prescricao_p 
	and	nr_sequencia	= nr_sequencia_p 
	and	ie_agrupador = 16;
	 
	select	max(nr_agrupamento) 
	into STRICT	nr_agrupamento_w 
	from	prescr_material 
	where 	nr_prescricao 	= nr_prescricao_p 
	and	nr_sequencia	= nr_sequencia_p;
		 
	if (nr_agrupamento_w > 0) then 
		CALL excluir_medic_composto(nr_prescricao_p, nr_sequencia_p, nr_agrupamento_w);
	end if;
	 
	select	count(nr_sequencia) 
	into STRICT	ie_existe_kit_w 
	from	prescr_material 
	where	nr_prescricao	= nr_prescricao_p 
	and		nr_seq_kit		= nr_sequencia_p;
	 
	if (ie_existe_kit_w > 0) then 
		CALL excluir_medic_kit(nr_prescricao_p, nr_sequencia_p);
	end if;
	 
	delete	FROM prescr_material 
	where	nr_prescricao	= nr_prescricao_p 
	and	nr_sequencia	= nr_sequencia_p;
		 
	if (nr_seq_leite_deriv_w IS NOT NULL AND nr_seq_leite_deriv_w::text <> '') then 
		ds_erro_w := consistir_prod_leites_deriv(nr_prescricao_p, null, null, nm_usuario_p, cd_perfil_p, ds_erro_w);
	end if;
		 
elsif (upper(nm_tabela_p) = 'PRESCR_DIETA') then 
 
	delete	FROM prescr_dieta 
	where	nr_prescricao	= nr_prescricao_p 
	and	nr_sequencia	= nr_sequencia_p;
 
elsif (upper(nm_tabela_p) = 'REP_JEJUM') then 
 
	delete	FROM rep_jejum 
	where	nr_prescricao	= nr_prescricao_p 
	and	nr_sequencia	= nr_sequencia_p;
 
	CALL Atualiza_horario_nut_jejum(nr_prescricao_p, 'E', nm_usuario_p, cd_perfil_p);
 
	select	CASE WHEN sum(nr)=0 THEN 'N'  ELSE 'S' END  
	into STRICT	ie_prescr_dieta_w 
	from ( 
			SELECT	1 nr 
			from	prescr_dieta 
			where	nr_prescricao = nr_prescricao_p 
			
union
 
			SELECT	1 nr 
			from	prescr_material 
			where	nr_prescricao = nr_prescricao_p 
			and	ie_agrupador  in (8,12,16)) alias2;
 
	if (ie_prescr_dieta_w	= 'S') then 
		CALL gerar_horarios_sem_lib(nr_prescricao_p,nm_usuario_p);
	end if;
			 
elsif (upper(nm_tabela_p) = 'NUT_PAC') then 
	 
	delete FROM prescr_medica_erro a 
	where	a.nr_seq_npt_elem_mat in ( 	SELECT 	b.nr_sequencia 
						from 	nut_pac_elem_mat b 
						where	b.nr_seq_nut_pac = nr_sequencia_p) 
	and	a.nr_prescricao = nr_prescricao_p;
	 
	delete	FROM nut_pac 
	where	nr_prescricao	= nr_prescricao_p 
	and	nr_sequencia	= nr_sequencia_p;
 
elsif (upper(nm_tabela_p) = 'PRESCR_SOLUCAO') then 
 
	delete	FROM prescr_solucao 
	where	nr_prescricao	= nr_prescricao_p 
	and	nr_seq_solucao	= nr_sequencia_p;
 
elsif (upper(nm_tabela_p) = 'PRESCR_GASOTERAPIA') then 
 
	delete	FROM prescr_gasoterapia 
	where	nr_prescricao	= nr_prescricao_p 
	and	nr_sequencia	= nr_sequencia_p;
 
elsif (upper(nm_tabela_p) = 'PRESCR_PROCEDIMENTO') then 
	 
	Select 	coalesce(max(nr_seq_solic_sangue),0) 
	into STRICT	nr_seq_solic_sangue_w 
	from	prescr_procedimento 
	where	nr_prescricao	= nr_prescricao_p 
	and	nr_sequencia	= nr_sequencia_p  LIMIT 1;
	 
	if (nr_seq_solic_sangue_w > 0) then 
		delete 	FROM prescr_solic_bco_sangue 
		where	nr_prescricao	= nr_prescricao_p 
		and	nr_sequencia	= nr_seq_solic_sangue_w;
	else 
		delete	FROM prescr_procedimento 
		where	nr_prescricao	= nr_prescricao_p 
		and	nr_sequencia	= nr_sequencia_p;
	end if;
	 
elsif (upper(nm_tabela_p) = 'PRESCR_RECOMENDACAO') then 
 
	delete	FROM prescr_recomendacao 
	where	nr_prescricao	= nr_prescricao_p 
	and	nr_sequencia	= nr_sequencia_p;
 
end if;
 
ie_vazia_w	:= obter_se_prescr_vazia(nr_prescricao_p);
 
if (ie_vazia_w	= 'S') then 
	CALL excluir_prescr_copia(nr_prescricao_p);
end if;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE plt_excluir_item ( nr_prescricao_p bigint, nr_sequencia_p bigint, nm_tabela_p text, nm_usuario_p text, cd_perfil_p bigint) FROM PUBLIC;

