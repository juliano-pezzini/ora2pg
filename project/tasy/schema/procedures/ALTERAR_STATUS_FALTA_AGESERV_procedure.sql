-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE alterar_status_falta_ageserv ( cd_agenda_lista_p text, nr_seq_agenda_lista_p text, ie_status_p text, cd_motivo_p bigint, ds_motivo_p text, ie_agenda_dia_p text, ie_gerar_controle_p text, cd_pessoa_fisica_lista_p text, dt_agenda_lista_p text, nr_seq_rp_mod_item_lista_p text, nr_seq_rp_item_ind_lista_p text, nm_usuario_p text, cd_estabelecimento_p bigint) AS $body$
DECLARE


cd_agenda_lista_w		varchar(2000);
cd_agenda_w			bigint;
nr_seq_agenda_lista_w		varchar(2000);
nr_seq_agenda_w			agenda_consulta.nr_sequencia%type;
cd_pessoa_fisica_lista_w	varchar(2000);
cd_pessoa_fisica_w		varchar(10);
dt_agenda_lista_w		varchar(2000);
dt_agenda_w			timestamp;
nr_seq_rp_mod_item_lista_w	varchar(2000);
nr_seq_rp_mod_item_w		varchar(10);
nr_seq_rp_item_ind_lista_w	varchar(2000);
nr_seq_rp_item_ind_w		varchar(10);
--variaveis de retorno para procedure:  alterar_status_agenda_ageserv
nr_seq_lista_ret_w		varchar(2000);
nr_atend_lista_ret_w		varchar(2000);
nr_sequencia_ret_w		bigint;
nr_atendimento_ret_w		bigint;
ds_perg_desvincular_w		varchar(2000);
qtd_linhas_w			smallint;



BEGIN

cd_agenda_lista_w		:= cd_agenda_lista_p;
nr_seq_agenda_lista_w		:= nr_seq_agenda_lista_p;
cd_pessoa_fisica_lista_w	:= cd_pessoa_fisica_lista_p;
dt_agenda_lista_w		:= dt_agenda_lista_p;
nr_seq_rp_mod_item_lista_w	:= nr_seq_rp_mod_item_lista_p;
nr_seq_rp_item_ind_lista_w	:= nr_seq_rp_item_ind_lista_p;
	


if (ie_status_p = 'I') or (ie_status_p = 'F') then
	begin
	
	while (nr_seq_agenda_lista_w IS NOT NULL AND nr_seq_agenda_lista_w::text <> '') loop
		begin
		cd_agenda_w		:= substr(cd_agenda_lista_w, 1, position(',' in cd_agenda_lista_w) - 1);
		nr_seq_agenda_w		:= substr(nr_seq_agenda_lista_w, 1, position(',' in nr_seq_agenda_lista_w) - 1);
		cd_pessoa_fisica_w	:= substr(cd_pessoa_fisica_lista_w, 1, position(',' in cd_pessoa_fisica_lista_w) - 1);
		dt_agenda_w		:= to_date(substr(dt_agenda_lista_w, 1, position(',' in dt_agenda_lista_w) - 1), 'dd/mm/yyyy hh24:mi:ss');
		nr_seq_rp_mod_item_w	:= substr(nr_seq_rp_mod_item_lista_w, 1, position(',' in nr_seq_rp_mod_item_lista_w) - 1);
		nr_seq_rp_item_ind_w	:= substr(nr_seq_rp_item_ind_lista_w, 1, position(',' in nr_seq_rp_item_ind_lista_w) - 1);

		cd_agenda_lista_w		:= substr(cd_agenda_lista_w, position(',' in cd_agenda_lista_w) + 1, length(cd_agenda_lista_w));
		nr_seq_agenda_lista_w		:= substr(nr_seq_agenda_lista_w, position(',' in nr_seq_agenda_lista_w) + 1, length(nr_seq_agenda_lista_w));
		cd_pessoa_fisica_lista_w	:= substr(cd_pessoa_fisica_lista_w, position(',' in cd_pessoa_fisica_lista_w) + 1, length(cd_pessoa_fisica_lista_w));
		dt_agenda_lista_w		:= substr(dt_agenda_lista_w, position(',' in dt_agenda_lista_w) + 1, length(dt_agenda_lista_w));
		nr_seq_rp_mod_item_lista_w	:= substr(nr_seq_rp_mod_item_lista_w, position(',' in nr_seq_rp_mod_item_lista_w) + 1, length(nr_seq_rp_mod_item_lista_w));
		nr_seq_rp_item_ind_lista_w	:= substr(nr_seq_rp_item_ind_lista_w, position(',' in nr_seq_rp_item_ind_lista_w) + 1, length(nr_seq_rp_item_ind_lista_w));
		
		CALL alterar_status_agecons(
						cd_agenda_w,
						nr_seq_agenda_w,
						ie_status_p,
						cd_motivo_p,
						ds_motivo_p,
						ie_agenda_dia_p,
						nm_usuario_p,
						null);

		if (nr_seq_rp_mod_item_w <> 'null') or (nr_seq_rp_item_ind_w <> 'null') then
			begin
			
			if (nr_seq_rp_mod_item_w = 'null') then
				nr_seq_rp_mod_item_w := '';
			end if;
			if (nr_seq_rp_item_ind_w = 'null') then
				nr_seq_rp_item_ind_w := 0;
			end if;
			
			CALL rp_gerar_controle_falta(
				cd_pessoa_fisica_w,
				dt_agenda_w,
				coalesce(nr_seq_rp_mod_item_w,''),
				coalesce(nr_seq_rp_item_ind_w,0),
				nm_usuario_p);
				
			CALL rp_consistir_falta_agend(
				coalesce(nr_seq_rp_mod_item_w,''),
				coalesce(nr_seq_rp_item_ind_w,0),
				nm_usuario_p,
				cd_estabelecimento_p,
				nr_seq_agenda_w );
			end;
		end if;
		end;
	end loop;
	end;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE alterar_status_falta_ageserv ( cd_agenda_lista_p text, nr_seq_agenda_lista_p text, ie_status_p text, cd_motivo_p bigint, ds_motivo_p text, ie_agenda_dia_p text, ie_gerar_controle_p text, cd_pessoa_fisica_lista_p text, dt_agenda_lista_p text, nr_seq_rp_mod_item_lista_p text, nr_seq_rp_item_ind_lista_p text, nm_usuario_p text, cd_estabelecimento_p bigint) FROM PUBLIC;

