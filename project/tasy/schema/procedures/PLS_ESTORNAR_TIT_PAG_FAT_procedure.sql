-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_estornar_tit_pag_fat ( nr_titulo_p titulo_pagar.nr_titulo%type, nm_usuario_p text) AS $body$
DECLARE

					
vl_titulo_w			titulo_pagar.vl_titulo%type;
vl_saldo_titulo_w		titulo_pagar.vl_saldo_titulo%type;
vl_estorno_w			double precision;
nr_seq_tit_pagar_baixa_w	titulo_pagar_baixa.nr_sequencia%type;
cd_tipo_baixa_w			titulo_pagar_baixa.cd_tipo_baixa%type;
nr_seq_baixa_origem_w		titulo_pagar_baixa.nr_seq_baixa_origem%type;


BEGIN

select	max(coalesce(vl_titulo,0)),
	max(coalesce(vl_saldo_titulo,0))
into STRICT	vl_titulo_w,
	vl_saldo_titulo_w
from	titulo_pagar
where	nr_titulo = nr_titulo_p
and	ie_situacao <> 'C';

if (vl_titulo_w <> vl_saldo_titulo_w) then
	vl_estorno_w := coalesce(vl_titulo_w,0) - coalesce(vl_saldo_titulo_w,0);
	
	if (vl_estorno_w > 0) then
		select	coalesce(max(nr_sequencia),0) + 1,
			max(cd_tipo_baixa),
			max(nr_sequencia)
		into STRICT	nr_seq_tit_pagar_baixa_w,
			cd_tipo_baixa_w,
			nr_seq_baixa_origem_w
		from	titulo_pagar_baixa
		where	nr_titulo = nr_titulo_p;
		
		select	coalesce(max(nr_sequencia), nr_seq_baixa_origem_w),
			coalesce(max(cd_tipo_baixa), cd_tipo_baixa_w)
		into STRICT	nr_seq_baixa_origem_w,
			cd_tipo_baixa_w
		from	titulo_pagar_baixa
		where	nr_titulo = nr_titulo_p
		and	vl_baixa = vl_estorno_w;
		
		insert into titulo_pagar_baixa(nr_sequencia,			nr_titulo,			dt_baixa,
			cd_moeda,			dt_atualizacao,			nm_usuario,
			cd_tipo_baixa,			ie_acao,			vl_baixa,
			vl_descontos,			vl_juros,			vl_multa,
			vl_pago,			vl_devolucao,			vl_glosa,
			nr_seq_baixa_origem,		vl_outras_deducoes,		vl_outros_acrescimos,
			nr_lote_contabil,		vl_glosa_ato_coop_princ,	vl_glosa_ato_coop_aux,
			vl_glosa_ato_nao_coop,		ds_observacao)
		values(	nr_seq_tit_pagar_baixa_w,	nr_titulo_p,			trunc(clock_timestamp()),
			1,				clock_timestamp(),			nm_usuario_p,
			cd_tipo_baixa_w,		'I',				(vl_estorno_w * (-1)),
			0,				0,				0,
			0,				0,				(vl_estorno_w * (-1)),
			nr_seq_baixa_origem_w,		0,				0,
			0,				0,				0,
			0,				'Estorno da baixa gerada pelo sistema no fechamento da contestacao.');
			
		update	titulo_pagar
		set	vl_saldo_titulo = vl_titulo_w,
			ie_status = 'D'
		where	nr_titulo = nr_titulo_p;
	end if;
end if;

CALL atualizar_saldo_tit_pagar(nr_titulo_p, nm_usuario_p);

-- commit;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_estornar_tit_pag_fat ( nr_titulo_p titulo_pagar.nr_titulo%type, nm_usuario_p text) FROM PUBLIC;

