-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_imp_conta_proc ( ds_versao_tiss_p text, nr_seq_conta_proc_p bigint, ie_tipo_guia_p text, ie_tipo_despesa_p bigint, nr_seq_conta_p bigint, cd_procedimento_p bigint, qt_procedimento_p bigint, ds_procedimento_p text, vl_unitario_p bigint, vl_procedimento_p bigint, cd_tipo_tabela_p text, tx_reducao_acrescimo_p bigint, dt_procedimento_p timestamp, ie_via_acesso_p text, ds_justificativa_p text, nm_usuario_p text, tx_item_p bigint, dt_inicio_proc_p timestamp, dt_fim_proc_p timestamp, cd_grau_partic_imp_p text, ie_tecnica_utilizada_p text, nr_seq_item_tiss_p pls_conta_proc_regra.nr_seq_item_tiss%type, nr_seq_item_tiss_vinculo_p pls_conta_mat_regra.nr_seq_item_tiss_vinculo%type, cd_dente_p text default null, cd_regiao_boca_p text default null, cd_face_dente_p text default null, qt_unidade_serv_p bigint default null, vl_proc_copartic_p bigint default null, ie_autorizado_p text default null) AS $body$
DECLARE


dt_inicio_proc_w		timestamp;
dt_procedimento_w		varchar(50);
ds_mascara_w			varchar(50);
nr_seq_conta_proc_w		bigint;
ie_tipo_guia_w			varchar(10);
dt_atendimento_imp_w		timestamp;
qt_procedimento_imp_w		pls_conta_proc.qt_procedimento_imp%type;
qt_proc_regra_w			integer;


BEGIN

/*
if	(ds_versao_tiss_p  = '2.01.02') then
	ds_mascara_w	:= 'yyyy-mm-dd';
elsif	(ds_versao_tiss_p  = '2.01.03') then
	ds_mascara_w	:= 'dd/mm/yyyy';
elsif	(ds_versao_tiss_p  = '2.02.01') then
	ds_mascara_w	:= 'yyyy-mm-dd';
end if;
*/
dt_procedimento_w	:= to_char(dt_procedimento_p);
dt_inicio_proc_w	:= dt_inicio_proc_p;
nr_seq_conta_proc_w 	:= nr_seq_conta_proc_p;

if (coalesce(nr_seq_conta_proc_p::text, '') = '') then
	select  nextval('pls_conta_proc_seq')
	into STRICT	nr_seq_conta_proc_w
	;	
end if;

begin
select	ie_tipo_guia,
	dt_atendimento_imp
into STRICT	ie_tipo_guia_w,
	dt_atendimento_imp_w
from	pls_conta
where	nr_sequencia	= nr_seq_conta_p;
exception
when others then
	ie_tipo_guia_w		:= '';
	dt_atendimento_imp_w	:= null;
end;

/* Felipe - 10/05/2011 - OS 314559 - Para as guias de consulta será inserido a data do ATENDIMENTO na data do procedimento*/


/*Robson OS - 361886
if	(ie_tipo_guia_w	= '3') then	
	dt_inicio_proc_w	:= dt_procedimento_p;
end if;
*/


/* No TISS 3 não tem mais quantidade do procedimento na guia de consulta,
porém precisamos dessa informação para valorização, etc */
if (ie_tipo_guia_w = '3') and (coalesce(qt_procedimento_p::text, '') = '') then
	qt_procedimento_imp_w	:= 1;
else
	qt_procedimento_imp_w	:= qt_procedimento_p;
end if;

insert into pls_conta_proc(
	nr_sequencia, dt_atualizacao, nm_usuario,
	nr_seq_conta, cd_procedimento_imp, qt_procedimento_imp,
	ds_procedimento_imp, vl_unitario_imp, vl_procedimento_imp,
	cd_tipo_tabela_imp, tx_reducao_acrescimo_imp, ie_tipo_despesa_imp,
	ie_status, ie_situacao, dt_procedimento_imp,
	dt_atualizacao_nrec, nm_usuario_nrec, ie_via_acesso_imp,
	ds_justificativa, tx_item, dt_procedimento,
	dt_inicio_proc_imp, dt_fim_proc_imp, vl_apresentado_xml,
	cd_grau_partic_imp, ie_tecnica_utilizada_imp,  CD_DENTE_IMP,
	cd_regiao_boca_imp, cd_face_dente_imp, qt_unidade_serv_imp,
	vl_proc_copartic_imp, ie_autorizado_imp)
values (	nr_seq_conta_proc_w, clock_timestamp(), nm_usuario_p,
	nr_seq_conta_p, cd_procedimento_p, qt_procedimento_imp_w,
	ds_procedimento_p, coalesce(vl_unitario_p,dividir(coalesce(vl_procedimento_p,0),qt_procedimento_p)), coalesce(vl_procedimento_p,0),
	cd_tipo_tabela_p, tx_reducao_acrescimo_p, ie_tipo_despesa_p,
	'U', 'I', dt_procedimento_p,
	clock_timestamp(), nm_usuario_p, ie_via_acesso_p,
	ds_justificativa_p, tx_item_p, dt_procedimento_w,
	dt_inicio_proc_w, dt_fim_proc_p, vl_procedimento_p,
	cd_grau_partic_imp_p, ie_tecnica_utilizada_p,cd_dente_p,
	cd_regiao_boca_p, cd_face_dente_p, qt_unidade_serv_p,
	vl_proc_copartic_p, ie_autorizado_p);	
commit;

-- so gera neste momento quando possui informação
if (nr_seq_item_tiss_p IS NOT NULL AND nr_seq_item_tiss_p::text <> '') then


	CALL pls_cta_proc_mat_regra_pck.cria_registro_regra_proc(nr_seq_conta_proc_w, nm_usuario_p);
	
	CALL pls_cta_proc_mat_regra_pck.atualiza_seq_tiss_proc(nr_seq_conta_proc_w, nr_seq_item_tiss_p, nr_seq_item_tiss_vinculo_p, nm_usuario_p);
	
	commit;
	
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_imp_conta_proc ( ds_versao_tiss_p text, nr_seq_conta_proc_p bigint, ie_tipo_guia_p text, ie_tipo_despesa_p bigint, nr_seq_conta_p bigint, cd_procedimento_p bigint, qt_procedimento_p bigint, ds_procedimento_p text, vl_unitario_p bigint, vl_procedimento_p bigint, cd_tipo_tabela_p text, tx_reducao_acrescimo_p bigint, dt_procedimento_p timestamp, ie_via_acesso_p text, ds_justificativa_p text, nm_usuario_p text, tx_item_p bigint, dt_inicio_proc_p timestamp, dt_fim_proc_p timestamp, cd_grau_partic_imp_p text, ie_tecnica_utilizada_p text, nr_seq_item_tiss_p pls_conta_proc_regra.nr_seq_item_tiss%type, nr_seq_item_tiss_vinculo_p pls_conta_mat_regra.nr_seq_item_tiss_vinculo%type, cd_dente_p text default null, cd_regiao_boca_p text default null, cd_face_dente_p text default null, qt_unidade_serv_p bigint default null, vl_proc_copartic_p bigint default null, ie_autorizado_p text default null) FROM PUBLIC;

