-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_inserir_just_automatica ( nr_seq_requisicao_p bigint, nr_seq_guia_p bigint, nr_seq_regra_just_aut_p bigint, nr_seq_item_aud_p bigint, nm_usuario_p text) AS $body$
DECLARE


/* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Finalidade: Inserir o histórico de justificativa nas requisições e guias para que o prestador possa vosualizar no portal web.
-------------------------------------------------------------------------------------------------------------------
Locais de chamada direta:
[  ]  Objetos do dicionário [ ] Tasy (Delphi/Java) [X] Portal [  ]  Relatórios [ ] Outros:
 ------------------------------------------------------------------------------------------------------------------
Pontos de atenção:Avisar ao Eder sempre que for alterado ou incluido algum parâmetro.
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */
cd_proc_regra_w			bigint;
nr_seq_auditoria_w		bigint;
ie_orig_proc_regra_w		bigint;
cd_grupo_proc_regra_w		bigint;
cd_espec_regra_w		bigint;
cd_area_proc_regra_w		bigint;
cd_area_aud_w			bigint;
cd_especialidade_aud_w		bigint;
cd_grupo_aud_w			bigint;
ie_origem_proced_2_w		bigint;
cd_proc_aud_w			bigint;
ie_orig_proc_aud_w		bigint;
ds_mensagem_w			varchar(4000);
qt_ocorrencia_w			bigint;


BEGIN

select	cd_procedimento,
	ie_origem_proced,
	nr_seq_auditoria
into STRICT	cd_proc_aud_w,
	ie_orig_proc_aud_w,
	nr_seq_auditoria_w
from	pls_auditoria_item
where	nr_sequencia	= nr_seq_item_aud_p;

select	cd_procedimento,
	ie_origem_proced,
	cd_grupo_proc,
	cd_especialidade,
	cd_area_procedimento,
	substr(ds_mensagem,1,4000)
into STRICT	cd_proc_regra_w,
	ie_orig_proc_regra_w,
	cd_grupo_proc_regra_w,
	cd_espec_regra_w,
	cd_area_proc_regra_w,
	ds_mensagem_w
from	pls_regra_just_automatica
where	nr_sequencia	= nr_seq_regra_just_aut_p;

SELECT * FROM pls_obter_estrut_proc(	cd_proc_aud_w, ie_orig_proc_aud_w, cd_area_aud_w, cd_especialidade_aud_w, cd_grupo_aud_w, ie_origem_proced_2_w) INTO STRICT cd_area_aud_w, cd_especialidade_aud_w, cd_grupo_aud_w, ie_origem_proced_2_w;

update	pls_auditoria_item
set	ie_status					= 'J',
	dt_atualizacao					= clock_timestamp(),
	nm_usuario					= nm_usuario_p
where	nr_sequencia					= nr_seq_item_aud_p
and	coalesce(cd_area_proc_regra_w,cd_area_aud_w)		= cd_area_aud_w
and	coalesce(cd_espec_regra_w,cd_especialidade_aud_w)	= cd_especialidade_aud_w
and	coalesce(cd_grupo_proc_regra_w,cd_grupo_aud_w)	= cd_grupo_aud_w
and	coalesce(cd_proc_regra_w,cd_proc_aud_w)		= cd_proc_aud_w
and	coalesce(ie_orig_proc_regra_w,ie_origem_proced_2_w)	= ie_origem_proced_2_w;

update	pls_auditoria
set	ie_status		= 'AJ',
	dt_atualizacao		= clock_timestamp(),
	nm_usuario		= nm_usuario_p
where	nr_sequencia		= nr_seq_auditoria_w;

if (coalesce(nr_seq_requisicao_p,0)	<> 0) then
	insert	into pls_requisicao_historico(nr_sequencia, nr_seq_requisicao, ie_tipo_historico,
		 ds_historico, dt_historico, ie_origem_historico,
		 dt_atualizacao, nm_usuario)
	values (nextval('pls_requisicao_historico_seq'), nr_seq_requisicao_p, 'J',
		 ds_mensagem_w, clock_timestamp(), 'A',
		 clock_timestamp(), nm_usuario_p);
elsif (coalesce(nr_seq_guia_p,0)	<> 0) then
	insert	into pls_guia_plano_historico(nr_sequencia, nr_seq_guia, dt_historico,
		 dt_atualizacao, nm_usuario, ds_observacao,
		 ie_origem_historico, ie_tipo_historico)
	values (nextval('pls_guia_plano_historico_seq'), nr_seq_guia_p, clock_timestamp(),
		 clock_timestamp(), nm_usuario_p, ds_mensagem_w,
		 'A', 'J');
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_inserir_just_automatica ( nr_seq_requisicao_p bigint, nr_seq_guia_p bigint, nr_seq_regra_just_aut_p bigint, nr_seq_item_aud_p bigint, nm_usuario_p text) FROM PUBLIC;

