-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_processo_adep_sol ( nr_atendimento_p bigint, nr_prescricao_p bigint, nr_seq_solucao_p bigint, nr_etapa_p bigint, dt_horario_processo_p timestamp, nm_usuario_p text, nr_seq_processo_p INOUT bigint, ie_somente_gedipa_p text, cd_funcao_origem_p bigint, ie_origem_processo_p text, ie_gedipa_p text, nr_seq_material_p bigint, nr_seq_procedimento_p bigint) AS $body$
DECLARE


nr_seq_processo_w            bigint;
cd_setor_atend_w            integer;
cd_local_estoque_w            smallint;
ds_erro_w                    varchar(1800);
ie_urgente_w                varchar(2);
cd_estabelecimento_w        smallint;
ie_local_estoque_proc_w        varchar(15);
cd_intervalo_w                varchar(7);
ie_acm_w                    varchar(1);
ie_se_necessario_w            varchar(1);
qt_tempo_min_w                bigint;
nr_seq_regra_w                bigint;
ie_gerar_urgente_w            varchar(1);
ie_hemodialise_w            varchar(1);
ie_possui_ancora_w            varchar(1);
nr_seq_material_w            bigint;
ie_vincula_processo_pharm_w	varchar(1);
ie_agrupador_w				prescr_material.ie_agrupador%type;
ie_grava_log_rastr_w varchar(1);


C01 CURSOR FOR
    SELECT    nr_sequencia
    from    regra_etapa_gedipa
    where    coalesce(cd_setor_atendimento,coalesce(cd_setor_atend_w,0))     = coalesce(cd_setor_atend_w,0)
    and    coalesce(cd_intervalo,coalesce(cd_intervalo_w,'0'))        = coalesce(cd_intervalo_w,'0')
    and    coalesce(ie_acm,coalesce(ie_acm_w,'N'))                = coalesce(ie_acm_w,'N')
    and    coalesce(ie_se_necessario,coalesce(ie_se_necessario_w,'N'))    = coalesce(ie_se_necessario_w,'N')
    and    coalesce(qt_tempo_min_w,0) between coalesce(qt_tempo_min,-99999) and coalesce(qt_tempo_max,99999)
    and    ie_situacao = 'A'
    and    (((coalesce(ie_hemodialise,'S') = 'S') and (coalesce(ie_hemodialise_w,'X') = 'H')) or
        ((coalesce(ie_hemodialise,'N') = 'N') and (coalesce(ie_hemodialise_w,'X') <> 'H')))
    order by
        coalesce(cd_setor_atendimento,000000),
        coalesce(cd_intervalo,'AAAAAAA'),
        coalesce(ie_acm,'AAAAAAA'),
        coalesce(ie_se_necessario,'AAAAAAA'),
        coalesce(qt_tempo_min,000000);



BEGIN

ie_grava_log_rastr_w := obter_rastreabilidade_adep(nr_prescricao_p, 'GP');

if (ie_grava_log_rastr_w = 'S') then
    CALL adep_gerar_log_rastr('{'||chr(10)||
        '"'||$$plsql_unit||'" : "'||$$plsql_line||'",'||chr(10)||
        '"cd_funcao_origem_p" : "'||cd_funcao_origem_p||'",'||chr(10)||
        '"dt_horario_processo_p" : "'||to_char(dt_horario_processo_p, 'dd/mm/yyyy hh24:mi:ss')||'",'||chr(10)||
        '"ie_gedipa_p" : "'||ie_gedipa_p||'",'||chr(10)||
        '"ie_origem_processo_p" : "'||ie_origem_processo_p||'",'||chr(10)||
        '"ie_somente_gedipa_p" : "'||ie_somente_gedipa_p||'",'||chr(10)||
        '"nm_usuario_p" : "'||nm_usuario_p||'",'||chr(10)||
        '"nr_atendimento_p" : "'||nr_atendimento_p||'",'||chr(10)||
        '"nr_etapa_p" : "'||nr_etapa_p||'",'||chr(10)||
        '"nr_prescricao_p" : "'||nr_prescricao_p||'",'||chr(10)||
        '"nr_seq_material_p" : "'||nr_seq_material_p||'",'||chr(10)||
        '"nr_seq_procedimento_p" : "'||nr_seq_procedimento_p||'",'||chr(10)||
        '"nr_seq_processo_p" : "'||nr_seq_processo_p||'",'||chr(10)||
        '"nr_seq_solucao_p" : "'||nr_seq_solucao_p||'"}', wheb_usuario_pck.get_ie_commit);
end if;

ie_vincula_processo_pharm_w := obter_param_usuario(1113, 617, wheb_usuario_pck.get_cd_perfil, wheb_usuario_pck.get_nm_usuario, cd_estabelecimento_w, ie_vincula_processo_pharm_w);

if (nr_atendimento_p IS NOT NULL AND nr_atendimento_p::text <> '') and (nr_prescricao_p IS NOT NULL AND nr_prescricao_p::text <> '') and (nr_seq_solucao_p IS NOT NULL AND nr_seq_solucao_p::text <> '') and (coalesce(nr_seq_procedimento_p::text, '') = '') and (nr_etapa_p IS NOT NULL AND nr_etapa_p::text <> '') and (nm_usuario_p IS NOT NULL AND nm_usuario_p::text <> '') then
    begin

	select	max(cd_estabelecimento)
	into STRICT	cd_estabelecimento_w
	from	atendimento_paciente
	where	nr_atendimento = nr_atendimento_p;

	select	coalesce(max(ie_local_estoque_proc),'P')
	into STRICT	ie_local_estoque_proc_w
	from	parametros_farmacia
	where	cd_estabelecimento = cd_estabelecimento_w;

    cd_setor_atend_w    := Obter_Unidade_Atendimento(nr_atendimento_p,'IAA','CS');
    if (ie_local_estoque_proc_w = 'P') then
        begin
        cd_local_estoque_w    := obter_local_estoque_setor(cd_setor_atend_w, cd_estabelecimento_w);
        end;
    elsif (ie_local_estoque_proc_w = 'S') then
        begin
        select    obter_local_estoque_setor(cd_setor_atendimento, cd_estabelecimento_w)
        into STRICT    cd_local_estoque_w
        from    prescr_medica
        where    nr_prescricao = nr_prescricao_p;
        end;
    ELSIF (ie_local_estoque_proc_w in ('R', 'L')) THEN

        select     min(nr_sequencia)
        into STRICT    nr_seq_material_w
        from    material b,
                prescr_material a
        where    a.cd_material        =    b.cd_material
        and        coalesce(b.ie_ancora_solucao,'S') = 'S'
        and        a.nr_sequencia_solucao     =    nr_seq_solucao_p
        and        a.nr_prescricao            =    nr_prescricao_p;

        if (coalesce(nr_seq_material_w::text, '') = '') then
                select     min(nr_sequencia)
                into STRICT    nr_seq_material_w
                from    material b,
                        prescr_material a
                where    a.cd_material        =    b.cd_material
                and        a.nr_sequencia_solucao    =    nr_seq_solucao_p
                and        a.nr_prescricao            =    nr_prescricao_p;
        end if;

        if (ie_local_estoque_proc_w = 'L') then
        
            select    max(cd_local_estoque_proc)
            into STRICT    cd_local_estoque_w
            from    regra_local_dispensacao
            where    nr_sequencia in (    SELECT    max(nr_regra_local_disp)
                                            from    prescr_mat_hor a,
                                                    prescr_material b
                                            where    a.nr_prescricao = b.nr_prescricao
                                            and        a.nr_seq_material = b.nr_sequencia
                                            and        b.nr_sequencia_solucao    =    nr_seq_solucao_p
                                            and        b.nr_prescricao            =    nr_prescricao_p
                                            and        b.nr_sequencia             =   nr_seq_material_w);
        else
            cd_local_estoque_w    := obter_local_estoque_regra_ged(cd_setor_atend_w,nr_prescricao_p,coalesce(nr_seq_material_p,nr_seq_material_w),null,dt_horario_processo_p,'N');
        end if;

    end if;

    select    nextval('adep_processo_seq')
    into STRICT    nr_seq_processo_w
;
    	
    select     max(coalesce(ie_urgencia,'N')),
        max(ie_classif_agora), --max(cd_intervalo),
        max(ie_acm),
        max(ie_se_necessario),
        max(trunc((dt_horario_processo_p - clock_timestamp()) * 1440))
    into STRICT    ie_urgente_w,
        cd_intervalo_w,
        ie_acm_w,
        ie_se_necessario_w,
        qt_tempo_min_w
    from    prescr_solucao
    where    nr_prescricao  = nr_prescricao_p
    and    nr_seq_solucao = nr_seq_solucao_p;

    select    max('H')
    into STRICT    ie_hemodialise_w
    from    prescr_material a,
            prescr_solucao b
    where    a.nr_prescricao         = b.nr_prescricao
    and        a.nr_sequencia_solucao    = b.nr_seq_solucao
    and        b.nr_prescricao          = nr_prescricao_p
    and        b.nr_seq_solucao         = nr_seq_solucao_p
    and        a.ie_agrupador            = 13;

    if (ie_grava_log_rastr_w = 'S') then
        CALL adep_gerar_log_rastr('{'||chr(10)||
            '"'||$$plsql_unit||'" : "'||$$plsql_line||'",'||chr(10)||
            '"cd_intervalo_w" : "'||cd_intervalo_w||'",'||chr(10)||
            '"cd_setor_atend_w" : "'||cd_setor_atend_w||'",'||chr(10)||
            '"ie_acm_w" : "'||ie_acm_w||'",'||chr(10)||
            '"ie_hemodialise_w" : "'||ie_hemodialise_w||'",'||chr(10)||
            '"ie_se_necessario_w" : "'||ie_se_necessario_w||'",'||chr(10)||
            '"qt_tempo_min_w" : "'||qt_tempo_min_w||'"}', wheb_usuario_pck.get_ie_commit);
    end if;

    open C01;
    loop
    fetch C01 into
        nr_seq_regra_w;
    EXIT WHEN NOT FOUND; /* apply on C01 */
    begin
        nr_seq_regra_w := nr_seq_regra_w;
    end;
    end loop;
    close C01;

    if (nr_seq_regra_w IS NOT NULL AND nr_seq_regra_w::text <> '') then
        select    coalesce(ie_gerar_urgente,'N')
        into STRICT    ie_gerar_urgente_w
        from    regra_etapa_gedipa
        where    nr_sequencia    = nr_seq_regra_w;
    end if;

    if (ie_grava_log_rastr_w = 'S') then
        CALL adep_gerar_log_rastr('{'||chr(10)||
            '"'||$$plsql_unit||'" : "'||$$plsql_line||'",'||chr(10)||
            '"cd_funcao_origem_p" : "'||cd_funcao_origem_p||'",'||chr(10)||
            '"cd_intervalo_w" : "'||cd_intervalo_w||'",'||chr(10)||
            '"cd_local_estoque_w" : "'||cd_local_estoque_w||'",'||chr(10)||
            '"cd_setor_atend_w" : "'||cd_setor_atend_w||'",'||chr(10)||
            '"dt_horario_processo_p" : "'||to_char(dt_horario_processo_p, 'dd/mm/yyyy hh24:mi:ss')||'",'||chr(10)||
            '"ie_acm_w" : "'||ie_acm_w||'",'||chr(10)||
            '"ie_gedipa_p" : "'||ie_gedipa_p||'",'||chr(10)||
            '"ie_gerar_urgente_w" : "'||ie_gerar_urgente_w||'",'||chr(10)||
            '"ie_hemodialise_w" : "'||ie_hemodialise_w||'",'||chr(10)||
            '"ie_origem_processo_p" : "'||ie_origem_processo_p||'",'||chr(10)||
            '"ie_se_necessario_w" : "'||ie_se_necessario_w||'",'||chr(10)||
            '"ie_urgente_w" : "'||ie_urgente_w||'",'||chr(10)||
            '"ie_vincula_processo_pharm_w" : "'||ie_vincula_processo_pharm_w||'",'||chr(10)||
            '"nm_usuario_p" : "'||nm_usuario_p||'",'||chr(10)||
            '"nr_atendimento_p" : "'||nr_atendimento_p||'",'||chr(10)||
            '"nr_etapa_p" : "'||nr_etapa_p||'",'||chr(10)||
            '"nr_prescricao_p" : "'||nr_prescricao_p||'",'||chr(10)||
            '"nr_seq_processo_w" : "'||nr_seq_processo_w||'",'||chr(10)||
            '"nr_seq_regra_w" : "'||nr_seq_regra_w||'",'||chr(10)||
            '"nr_seq_solucao_p" : "'||nr_seq_solucao_p||'"}', wheb_usuario_pck.get_ie_commit);
    end if;

    insert into adep_processo(
        nr_sequencia,
        dt_atualizacao,
        nm_usuario,
        dt_atualizacao_nrec,
        nm_usuario_nrec,
        nr_atendimento,
        nr_prescricao,
        nr_seq_solucao,
        nr_etapa,
        dt_processo,
        nm_usuario_processo,
        dt_leitura,
        nm_usuario_leitura,
        dt_preparo,
        nm_usuario_preparo,
        dt_paciente,
        nm_usuario_paciente,
        dt_horario_processo,
        cd_local_estoque,
        cd_setor_atendimento,
        cd_funcao_origem,
        ie_origem_processo,
        ie_gedipa,
        ie_urgente,
        cd_intervalo,
        ie_acm,
        ie_se_necessario,
        nr_seq_regra,
        ie_tipo_processo)
    values (
        nr_seq_processo_w,
        clock_timestamp(),
        nm_usuario_p,
        clock_timestamp(),
        nm_usuario_p,
        nr_atendimento_p,
        nr_prescricao_p,
        nr_seq_solucao_p,
        nr_etapa_p,
        clock_timestamp(),
        nm_usuario_p,
        null,
        null,
        null,
        null,
        null,
        null,
        dt_horario_processo_p,
        cd_local_estoque_w,
        cd_setor_atend_w,
        cd_funcao_origem_p,
        ie_origem_processo_p,
        ie_gedipa_p,
        CASE WHEN ie_gerar_urgente_w='S' THEN 'S'  ELSE ie_urgente_w END ,
        cd_intervalo_w,
        ie_acm_w,
        ie_se_necessario_w,
        nr_seq_regra_w,
        ie_hemodialise_w);
		
	if (coalesce(ie_vincula_processo_pharm_w,'N') = 'L') then	
		CALL preparar_processo_adep(nr_seq_processo_w,'S',nm_usuario_p);
	end if;	

    nr_seq_processo_p := nr_seq_processo_w;
    end;
elsif (nr_atendimento_p IS NOT NULL AND nr_atendimento_p::text <> '') and (nr_prescricao_p IS NOT NULL AND nr_prescricao_p::text <> '') and (coalesce(nr_seq_solucao_p::text, '') = '') and (nr_seq_material_p IS NOT NULL AND nr_seq_material_p::text <> '') and (coalesce(nr_seq_procedimento_p::text, '') = '') and (nr_etapa_p IS NOT NULL AND nr_etapa_p::text <> '') and (nm_usuario_p IS NOT NULL AND nm_usuario_p::text <> '') then
    begin

    select    max(cd_estabelecimento)
    into STRICT    cd_estabelecimento_w
    from    atendimento_paciente
    where    nr_atendimento = nr_atendimento_p;

    select    coalesce(max(ie_local_estoque_proc),'P')
    into STRICT    ie_local_estoque_proc_w
    from    parametros_farmacia
    where    cd_estabelecimento = cd_estabelecimento_w;
    
    cd_setor_atend_w    := Obter_Unidade_Atendimento(nr_atendimento_p,'IAA','CS');
    if (ie_local_estoque_proc_w = 'P') then
        begin
        cd_local_estoque_w    := obter_local_estoque_setor(cd_setor_atend_w, cd_estabelecimento_w);
        end;
    elsif (ie_local_estoque_proc_w = 'S') then
        begin
        select    obter_local_estoque_setor(cd_setor_atendimento, cd_estabelecimento_w)
        into STRICT    cd_local_estoque_w
        from    prescr_medica
        where    nr_prescricao = nr_prescricao_p;
        end;
    ELSIF (ie_local_estoque_proc_w in ('R', 'L')) THEN

        if (ie_local_estoque_proc_w = 'L') then
        
            select    max(cd_local_estoque_proc)
            into STRICT    cd_local_estoque_w
            from    regra_local_dispensacao
            where    nr_sequencia in (    SELECT    max(nr_regra_local_disp)
                                            from    prescr_mat_hor a,
                                                    prescr_material b
                                            where    a.nr_prescricao = b.nr_prescricao
                                            and        a.nr_seq_material = b.nr_sequencia
                                            and        b.nr_prescricao            =    nr_prescricao_p
                                            and        b.nr_sequencia             =   nr_seq_material_p);
        else
            cd_local_estoque_w    := obter_local_estoque_regra_ged(cd_setor_atend_w,nr_prescricao_p,nr_seq_material_p,null,dt_horario_processo_p,'N');
        end if;

    end if;

    select    nextval('adep_processo_seq')
    into STRICT    nr_seq_processo_w
;

    select  max(coalesce(ie_urgencia,'N')),
        	max(cd_intervalo),
	        max(ie_acm),
	        max(ie_se_necessario),
	        max(trunc((dt_horario_processo_p - clock_timestamp()) * 1440)),
	        max(CASE WHEN ie_agrupador=13 THEN 'H'  ELSE null END ),
			max(ie_agrupador)
    into STRICT    ie_urgente_w,
	        cd_intervalo_w,
	        ie_acm_w,
	        ie_se_necessario_w,
	        qt_tempo_min_w,
	        ie_hemodialise_w,
			ie_agrupador_w
    from    prescr_material
    where   nr_prescricao  = nr_prescricao_p
    and    nr_sequencia = nr_seq_material_p;

    if (ie_grava_log_rastr_w = 'S') then
        CALL adep_gerar_log_rastr('{'||chr(10)||
            '"'||$$plsql_unit||'" : "'||$$plsql_line||'",'||chr(10)||
            '"cd_intervalo_w" : "'||cd_intervalo_w||'",'||chr(10)||
            '"cd_setor_atend_w" : "'||cd_setor_atend_w||'",'||chr(10)||
            '"ie_acm_w" : "'||ie_acm_w||'",'||chr(10)||
            '"ie_hemodialise_w" : "'||ie_hemodialise_w||'",'||chr(10)||
            '"ie_se_necessario_w" : "'||ie_se_necessario_w||'",'||chr(10)||
            '"qt_tempo_min_w" : "'||qt_tempo_min_w||'"}', wheb_usuario_pck.get_ie_commit);
    end if;

    open C01;
    loop
    fetch C01 into
        nr_seq_regra_w;
    EXIT WHEN NOT FOUND; /* apply on C01 */
    begin
        nr_seq_regra_w := nr_seq_regra_w;
    end;
    end loop;
    close C01;

    if (nr_seq_regra_w IS NOT NULL AND nr_seq_regra_w::text <> '') then
        select    coalesce(ie_gerar_urgente,'N')
        into STRICT    ie_gerar_urgente_w
        from    regra_etapa_gedipa
        where    nr_sequencia    = nr_seq_regra_w;
    end if;

    if (ie_grava_log_rastr_w = 'S') then
        CALL adep_gerar_log_rastr('{'||chr(10)||
            '"'||$$plsql_unit||'" : "'||$$plsql_line||'",'||chr(10)||
            '"cd_funcao_origem_p" : "'||cd_funcao_origem_p||'",'||chr(10)||
            '"cd_intervalo_w" : "'||cd_intervalo_w||'",'||chr(10)||
            '"cd_local_estoque_w" : "'||cd_local_estoque_w||'",'||chr(10)||
            '"cd_setor_atend_w" : "'||cd_setor_atend_w||'",'||chr(10)||
            '"dt_horario_processo_p" : "'||to_char(dt_horario_processo_p, 'dd/mm/yyyy hh24:mi:ss')||'",'||chr(10)||
            '"ie_acm_w" : "'||ie_acm_w||'",'||chr(10)||
            '"ie_agrupador_w" : "'||ie_agrupador_w||'",'||chr(10)||
            '"ie_gedipa_p" : "'||ie_gedipa_p||'",'||chr(10)||
            '"ie_gerar_urgente_w" : "'||ie_gerar_urgente_w||'",'||chr(10)||
            '"ie_hemodialise_w" : "'||ie_hemodialise_w||'",'||chr(10)||
            '"ie_origem_processo_p" : "'||ie_origem_processo_p||'",'||chr(10)||
            '"ie_se_necessario_w" : "'||ie_se_necessario_w||'",'||chr(10)||
            '"ie_urgente_w" : "'||ie_urgente_w||'",'||chr(10)||
            '"ie_vincula_processo_pharm_w" : "'||ie_vincula_processo_pharm_w||'",'||chr(10)||
            '"nm_usuario_p" : "'||nm_usuario_p||'",'||chr(10)||
            '"nr_atendimento_p" : "'||nr_atendimento_p||'",'||chr(10)||
            '"nr_etapa_p" : "'||nr_etapa_p||'",'||chr(10)||
            '"nr_prescricao_p" : "'||nr_prescricao_p||'",'||chr(10)||
            '"nr_seq_material_p" : "'||nr_seq_material_p||'",'||chr(10)||
            '"nr_seq_processo_w" : "'||nr_seq_processo_w||'",'||chr(10)||
            '"nr_seq_regra_w" : "'||nr_seq_regra_w||'"}', wheb_usuario_pck.get_ie_commit);
    end if;

    insert into adep_processo(
        nr_sequencia,
        dt_atualizacao,
        nm_usuario,
        dt_atualizacao_nrec,
        nm_usuario_nrec,
        nr_atendimento,
        nr_prescricao,
        nr_seq_material,
        nr_etapa,
        dt_processo,
        nm_usuario_processo,
        dt_leitura,
        nm_usuario_leitura,
        dt_preparo,
        nm_usuario_preparo,
        dt_paciente,
        nm_usuario_paciente,
        dt_horario_processo,
        cd_local_estoque,
        cd_setor_atendimento,
        cd_funcao_origem,
        ie_origem_processo,
        ie_gedipa,
        ie_urgente,
        cd_intervalo,
        ie_acm,
        ie_se_necessario,
        nr_seq_regra,
        ie_tipo_processo)
    values (
        nr_seq_processo_w,
        clock_timestamp(),
        nm_usuario_p,
        clock_timestamp(),
        nm_usuario_p,
        nr_atendimento_p,
        nr_prescricao_p,
        nr_seq_material_p,
        nr_etapa_p,
        clock_timestamp(),
        nm_usuario_p,
        null,
        null,
        null,
        null,
        null,
        null,
        dt_horario_processo_p,
        cd_local_estoque_w,
        cd_setor_atend_w,
        cd_funcao_origem_p,
        ie_origem_processo_p,
        ie_gedipa_p,
        CASE WHEN ie_gerar_urgente_w='S' THEN 'S'  ELSE ie_urgente_w END ,
        cd_intervalo_w,
        ie_acm_w,
        ie_se_necessario_w,
        nr_seq_regra_w,
        ie_hemodialise_w);
		
		if (((coalesce(ie_vincula_processo_pharm_w,'N') = 'X') and (ie_agrupador_w <> 11)) or (coalesce(ie_vincula_processo_pharm_w,'N') in ('T', 'S'))) then
			CALL preparar_processo_adep(nr_seq_processo_w,'S',nm_usuario_p);
		end if;

    nr_seq_processo_p := nr_seq_processo_w;
    end;
elsif (nr_atendimento_p IS NOT NULL AND nr_atendimento_p::text <> '') and (nr_prescricao_p IS NOT NULL AND nr_prescricao_p::text <> '') and (coalesce(nr_seq_solucao_p::text, '') = '') and (coalesce(nr_seq_material_p::text, '') = '') and (nr_seq_procedimento_p IS NOT NULL AND nr_seq_procedimento_p::text <> '') and (nr_etapa_p IS NOT NULL AND nr_etapa_p::text <> '') and (nm_usuario_p IS NOT NULL AND nm_usuario_p::text <> '') then
    begin

    select    max(cd_estabelecimento)
    into STRICT    cd_estabelecimento_w
    from    atendimento_paciente
    where    nr_atendimento = nr_atendimento_p;

    select    coalesce(max(ie_local_estoque_proc),'P')
    into STRICT    ie_local_estoque_proc_w
    from    parametros_farmacia
    where    cd_estabelecimento = cd_estabelecimento_w;
    
    cd_setor_atend_w    := Obter_Unidade_Atendimento(nr_atendimento_p,'IAA','CS');
    if (ie_local_estoque_proc_w = 'P') then
        begin
        cd_local_estoque_w    := obter_local_estoque_setor(cd_setor_atend_w, cd_estabelecimento_w);
        end;
    elsif (ie_local_estoque_proc_w = 'S') then
        begin
        select    obter_local_estoque_setor(cd_setor_atendimento, cd_estabelecimento_w)
        into STRICT    cd_local_estoque_w
        from    prescr_medica
        where    nr_prescricao = nr_prescricao_p;
        end;
    ELSIF (ie_local_estoque_proc_w = 'R') THEN
        cd_local_estoque_w    := obter_local_estoque_regra_ged(cd_setor_atend_w);
    end if;

    select    nextval('adep_processo_seq')
    into STRICT    nr_seq_processo_w
;

    select     max(coalesce(ie_urgencia,'N')),
        max(cd_intervalo),
        max(ie_acm),
        max(ie_se_necessario)
    into STRICT    ie_urgente_w,
        cd_intervalo_w,
        ie_acm_w,
        ie_se_necessario_w
    from    prescr_procedimento
    where    nr_prescricao  = nr_prescricao_p
    and    nr_sequencia = nr_seq_procedimento_p;

    if (ie_grava_log_rastr_w = 'S') then
        CALL adep_gerar_log_rastr('{'||chr(10)||
            '"'||$$plsql_unit||'" : "'||$$plsql_line||'",'||chr(10)||
            '"cd_funcao_origem_p" : "'||cd_funcao_origem_p||'",'||chr(10)||
            '"cd_intervalo_w" : "'||cd_intervalo_w||'",'||chr(10)||
            '"cd_local_estoque_w" : "'||cd_local_estoque_w||'",'||chr(10)||
            '"cd_setor_atend_w" : "'||cd_setor_atend_w||'",'||chr(10)||
            '"ie_acm_w" : "'||ie_acm_w||'",'||chr(10)||
            '"ie_gedipa_p" : "'||ie_gedipa_p||'",'||chr(10)||
            '"ie_origem_processo_p" : "'||ie_origem_processo_p||'",'||chr(10)||
            '"ie_se_necessario_w" : "'||ie_se_necessario_w||'",'||chr(10)||
            '"ie_urgente_w" : "'||ie_urgente_w||'",'||chr(10)||
            '"nm_usuario_p" : "'||nm_usuario_p||'",'||chr(10)||
            '"nr_atendimento_p" : "'||nr_atendimento_p||'",'||chr(10)||
            '"nr_etapa_p" : "'||nr_etapa_p||'",'||chr(10)||
            '"nr_prescricao_p" : "'||nr_prescricao_p||'",'||chr(10)||
            '"nr_seq_procedimento_p" : "'||nr_seq_procedimento_p||'",'||chr(10)||
            '"nr_seq_processo_w" : "'||nr_seq_processo_w||'",'||chr(10)||
            '"nr_seq_regra_w" : "'||nr_seq_regra_w||'"}', wheb_usuario_pck.get_ie_commit);
    end if;

    insert into adep_processo(
        nr_sequencia,
        dt_atualizacao,
        nm_usuario,
        dt_atualizacao_nrec,
        nm_usuario_nrec,
        nr_atendimento,
        nr_prescricao,
        nr_seq_procedimento,
        nr_etapa,
        dt_processo,
        nm_usuario_processo,
        dt_leitura,
        nm_usuario_leitura,
        dt_preparo,
        nm_usuario_preparo,
        dt_paciente,
        nm_usuario_paciente,
        dt_horario_processo,
        cd_local_estoque,
        cd_setor_atendimento,
        cd_funcao_origem,
        ie_origem_processo,
        ie_gedipa,
        ie_urgente,
        cd_intervalo,
        ie_acm,
        ie_se_necessario,
        nr_seq_regra)
    values (
        nr_seq_processo_w,
        clock_timestamp(),
        nm_usuario_p,
        clock_timestamp(),
        nm_usuario_p,
        nr_atendimento_p,
        nr_prescricao_p,
        nr_seq_procedimento_p,
        nr_etapa_p,
        clock_timestamp(),
        nm_usuario_p,
        null,
        null,
        null,
        null,
        null,
        null,
        clock_timestamp(),--dt_horario_processo_p,
        cd_local_estoque_w,
        cd_setor_atend_w,
        cd_funcao_origem_p,
        ie_origem_processo_p,
        ie_gedipa_p,
        ie_urgente_w,
        cd_intervalo_w,
        ie_acm_w,
        ie_se_necessario_w,
        nr_seq_regra_w);

    nr_seq_processo_p := nr_seq_processo_w;
    end;
end if;

if (coalesce(wheb_usuario_pck.get_ie_commit, 'S') = 'S') then commit; end if;

exception
when others then
    ds_erro_w    := substr(SQLERRM(SQLSTATE),1,1800);
	
	CALL gravar_log_tasy(7892, 'Prescricao='||nr_prescricao_p||';nr_seq_solucao_p='||nr_seq_solucao_p||';Erro='||ds_erro_w, nm_usuario_p);

    
    CALL adep_gerar_log_rastr('{'||chr(10)||
        '"'||$$plsql_unit||'" : "'||$$plsql_line||'",'||chr(10)||
        '"cd_estabelecimento_w" : "'||cd_estabelecimento_w||'",'||chr(10)||
        '"cd_funcao_origem_p" : "'||cd_funcao_origem_p||'",'||chr(10)||
        '"cd_intervalo_w" : "'||cd_intervalo_w||'",'||chr(10)||
        '"cd_local_estoque_w" : "'||cd_local_estoque_w||'",'||chr(10)||
        '"cd_setor_atend_w" : "'||cd_setor_atend_w||'",'||chr(10)||
        '"ds_erro_w" : "'||ds_erro_w||'",'||chr(10)||
        '"dt_horario_processo_p" : "'||to_char(dt_horario_processo_p, 'dd/mm/yyyy hh24:mi:ss')||'",'||chr(10)||
        '"ie_acm_w" : "'||ie_acm_w||'",'||chr(10)||
        '"ie_agrupador_w" : "'||ie_agrupador_w||'",'||chr(10)||
        '"ie_gedipa_p" : "'||ie_gedipa_p||'",'||chr(10)||
        '"ie_gerar_urgente_w" : "'||ie_gerar_urgente_w||'",'||chr(10)||
        '"ie_grava_log_rastr_w" : "'||ie_grava_log_rastr_w||'",'||chr(10)||
        '"ie_hemodialise_w" : "'||ie_hemodialise_w||'",'||chr(10)||
        '"ie_local_estoque_proc_w" : "'||ie_local_estoque_proc_w||'",'||chr(10)||
        '"ie_origem_processo_p" : "'||ie_origem_processo_p||'",'||chr(10)||
        '"ie_possui_ancora_w" : "'||ie_possui_ancora_w||'",'||chr(10)||
        '"ie_se_necessario_w" : "'||ie_se_necessario_w||'",'||chr(10)||
        '"ie_somente_gedipa_p" : "'||ie_somente_gedipa_p||'",'||chr(10)||
        '"ie_urgente_w" : "'||ie_urgente_w||'",'||chr(10)||
        '"ie_vincula_processo_pharm_w" : "'||ie_vincula_processo_pharm_w||'",'||chr(10)||
        '"nm_usuario_p" : "'||nm_usuario_p||'",'||chr(10)||
        '"nr_atendimento_p" : "'||nr_atendimento_p||'",'||chr(10)||
        '"nr_etapa_p" : "'||nr_etapa_p||'",'||chr(10)||
        '"nr_prescricao_p" : "'||nr_prescricao_p||'",'||chr(10)||
        '"nr_seq_material_p" : "'||nr_seq_material_p||'",'||chr(10)||
        '"nr_seq_material_w" : "'||nr_seq_material_w||'",'||chr(10)||
        '"nr_seq_procedimento_p" : "'||nr_seq_procedimento_p||'",'||chr(10)||
        '"nr_seq_processo_p" : "'||nr_seq_processo_p||'",'||chr(10)||
        '"nr_seq_processo_w" : "'||nr_seq_processo_w||'",'||chr(10)||
        '"nr_seq_regra_w" : "'||nr_seq_regra_w||'",'||chr(10)||
        '"nr_seq_solucao_p" : "'||nr_seq_solucao_p||'",'||chr(10)||
        '"qt_tempo_min_w" : "'||qt_tempo_min_w||'"}', wheb_usuario_pck.get_ie_commit);

    if (coalesce(wheb_usuario_pck.get_ie_commit, 'S') = 'S') then commit; end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_processo_adep_sol ( nr_atendimento_p bigint, nr_prescricao_p bigint, nr_seq_solucao_p bigint, nr_etapa_p bigint, dt_horario_processo_p timestamp, nm_usuario_p text, nr_seq_processo_p INOUT bigint, ie_somente_gedipa_p text, cd_funcao_origem_p bigint, ie_origem_processo_p text, ie_gedipa_p text, nr_seq_material_p bigint, nr_seq_procedimento_p bigint) FROM PUBLIC;

