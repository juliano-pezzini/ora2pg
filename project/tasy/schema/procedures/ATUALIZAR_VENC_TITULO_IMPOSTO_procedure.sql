-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE atualizar_venc_titulo_imposto (nr_titulo_original_p bigint, nr_seq_alteracao_p bigint, nm_usuario_p text) AS $body$
DECLARE


nr_titulo_w			bigint;
cd_cond_pagto_w			bigint;
qt_venc_w			bigint;
nr_sequencia_w			bigint;
cd_estabelecimento_w		bigint;
ds_venc_w			varchar(255);
dt_vencimento_w			timestamp;
dt_vencimento_tit_w		timestamp;
cd_tributo_w			bigint;
cd_cgc_w			varchar(20);
cd_pessoa_fisica_w		varchar(20);
nr_seq_alt_w			bigint;
cd_empresa_w			bigint	:= null;
ds_irrelevante_w		varchar(4000);
cd_cgc_titulo_w			varchar(100);
cd_pessoa_fisica_titulo_w	varchar(100);
vl_base_calculo_w		double precision;
nr_seq_classe_w			bigint;
ie_alterar_venc_w		varchar(1);
nr_seq_regra_w			bigint;
ie_origem_titulo_w		titulo_pagar.ie_origem_titulo%type;

c01 CURSOR FOR
SELECT	a.nr_titulo,
	b.nr_sequencia,
	a.cd_estabelecimento,
	c.cd_tributo,
	a.cd_cgc,
	a.cd_pessoa_fisica,
	b.vl_base_calculo,
	a.nr_seq_classe,
	a.ie_origem_titulo
from	tributo c,
	titulo_pagar_imposto b,
	titulo_pagar a
where	a.nr_titulo_original 	= nr_titulo_original_p
and	a.nr_seq_tributo	= b.nr_sequencia
and	b.cd_tributo		= c.cd_tributo
and	a.ie_tipo_titulo	= 4
and	a.ie_situacao		= 'A'
and	c.ie_venc_nf		= 'V';

c02 CURSOR FOR
SELECT	a.nr_titulo,
	b.nr_sequencia,
	c.cd_tributo,
	a.ie_origem_titulo
from	tributo c,
	titulo_pagar_imposto b,
	titulo_pagar a
where	a.nr_titulo_original	= nr_titulo_original_p
and	b.nr_sequencia 		= a.nr_seq_tributo
and	b.cd_tributo		= c.cd_tributo;


BEGIN

ie_alterar_venc_w := obter_valor_param_usuario(851, 175, obter_perfil_ativo, nm_usuario_p, obter_estabelecimento_ativo);

select	dt_vencimento
into STRICT	dt_vencimento_tit_w
from	titulo_pagar_alt_venc
where	nr_sequencia	= nr_seq_alteracao_p
and	nr_titulo	= nr_titulo_original_p;

select	cd_cgc,
	cd_pessoa_fisica
into STRICT	cd_cgc_titulo_w,
	cd_pessoa_fisica_titulo_w
from	titulo_pagar
where	nr_titulo	= nr_titulo_original_p;

open c01;
loop
fetch c01 into
	nr_titulo_w,
	nr_sequencia_w,
	cd_estabelecimento_w,
	cd_tributo_w,
	cd_cgc_w,
	cd_pessoa_fisica_w,
	vl_base_calculo_w,
	nr_seq_classe_w,
	ie_origem_titulo_w;
EXIT WHEN NOT FOUND; /* apply on c01 */

	select	max(cd_empresa)
	into STRICT	cd_empresa_w
	from	estabelecimento
	where	cd_estabelecimento		= cd_estabelecimento_w;

	SELECT * FROM obter_dados_trib_tit_pagar(cd_tributo_w, cd_estabelecimento_w, cd_cgc_titulo_w, cd_pessoa_fisica_titulo_w, ds_irrelevante_w, ds_irrelevante_w, cd_cond_pagto_w, ds_irrelevante_w, ds_irrelevante_w, ds_irrelevante_w, ds_irrelevante_w, ds_irrelevante_w, ds_irrelevante_w, ds_irrelevante_w, ds_irrelevante_w, ds_irrelevante_w, ds_irrelevante_w, ds_irrelevante_w, ds_irrelevante_w, null, null, null, null, null, null, nr_seq_regra_w, null, 0, ds_irrelevante_w, ds_irrelevante_w, vl_base_calculo_w, 'N', nr_seq_classe_w, ie_origem_titulo_w, null, null) INTO STRICT ds_irrelevante_w, ds_irrelevante_w, cd_cond_pagto_w, ds_irrelevante_w, ds_irrelevante_w, ds_irrelevante_w, ds_irrelevante_w, ds_irrelevante_w, ds_irrelevante_w, ds_irrelevante_w, ds_irrelevante_w, ds_irrelevante_w, ds_irrelevante_w, ds_irrelevante_w, nr_seq_regra_w, ds_irrelevante_w, ds_irrelevante_w;

	dt_vencimento_w			:= dt_vencimento_tit_w;
	if (cd_cond_pagto_w > 0) then
		if (pkg_date_utils.get_WeekDay(dt_vencimento_w) = 7) then
			dt_vencimento_w	:= dt_vencimento_w + 2;
		elsif (pkg_date_utils.get_WeekDay(dt_vencimento_w) = 1) then
			dt_vencimento_w := dt_vencimento_w + 1;
		end if;
		SELECT * FROM calcular_vencimento(cd_estabelecimento_w, cd_cond_pagto_w, dt_vencimento_w, qt_venc_w, ds_venc_w) INTO STRICT qt_venc_w, ds_venc_w;
		if (qt_venc_w = 1) then	
			dt_vencimento_w	:= to_date(substr(ds_venc_w,1,10),'dd/mm/yyyy');
		end if;
	end if;


	select	coalesce(max(nr_sequencia),0) + 1
	into STRICT	nr_seq_alt_w
	from	titulo_pagar_alt_venc
	where	nr_titulo = nr_titulo_w;

	insert into titulo_pagar_alt_venc(		/* Rafael. OS48885. 29/01/2007. */
				nr_titulo      ,
				nr_sequencia   ,
				dt_anterior    ,
				dt_vencimento  ,
				dt_atualizacao ,
				nm_usuario     ,
				dt_alteracao)
			values (nr_titulo_w,
				nr_seq_alt_w, 
				dt_vencimento_w,
				dt_vencimento_w,
				clock_timestamp(),
				nm_usuario_p,
				trunc(clock_timestamp(),'dd'));

	CALL atualizar_venc_titulo_pagar(nr_titulo_w, nr_seq_alt_w, nm_usuario_p);

	update	titulo_pagar_imposto
	set	dt_imposto		= dt_vencimento_w,
		dt_atualizacao		= clock_timestamp(),
		nm_usuario		= nm_usuario_p,
		nr_seq_trib_cp		= nr_seq_regra_w
	where	nr_sequencia		= nr_sequencia_w;
/*
	update	titulo_pagar
	set	dt_atualizacao		= sysdate,
		nm_usuario		= nm_usuario_p,
		dt_vencimento_atual	= dt_vencimento_w
	where	nr_titulo		= nr_titulo_w;
*/
end loop;
close c01;

if (ie_alterar_venc_w = 'S') then
	open C02;
	loop
	fetch C02 into	
		nr_titulo_w,
		nr_sequencia_w,
		cd_tributo_w,
		ie_origem_titulo_w;
	EXIT WHEN NOT FOUND; /* apply on C02 */
		begin
		dt_vencimento_w			:= dt_vencimento_tit_w;
		cd_estabelecimento_w		:= OBTER_DADOS_TIT_PAGAR(nr_titulo_original_p,'ESTAB');
		
		select	max(cd_empresa)
		into STRICT	cd_empresa_w
		from	estabelecimento
		where	cd_estabelecimento		= cd_estabelecimento_w;

		SELECT * FROM obter_dados_trib_tit_pagar(cd_tributo_w, cd_estabelecimento_w, cd_cgc_titulo_w, cd_pessoa_fisica_titulo_w, ds_irrelevante_w, ds_irrelevante_w, cd_cond_pagto_w, ds_irrelevante_w, ds_irrelevante_w, ds_irrelevante_w, ds_irrelevante_w, ds_irrelevante_w, ds_irrelevante_w, ds_irrelevante_w, ds_irrelevante_w, ds_irrelevante_w, ds_irrelevante_w, ds_irrelevante_w, ds_irrelevante_w, null, null, null, null, null, null, nr_seq_regra_w, null, 0, ds_irrelevante_w, ds_irrelevante_w, null, 'N', null, ie_origem_titulo_w, null, null) INTO STRICT ds_irrelevante_w, ds_irrelevante_w, cd_cond_pagto_w, ds_irrelevante_w, ds_irrelevante_w, ds_irrelevante_w, ds_irrelevante_w, ds_irrelevante_w, ds_irrelevante_w, ds_irrelevante_w, ds_irrelevante_w, ds_irrelevante_w, ds_irrelevante_w, ds_irrelevante_w, nr_seq_regra_w, ds_irrelevante_w, ds_irrelevante_w;
		
		if (cd_cond_pagto_w > 0) then
			if (pkg_date_utils.get_WeekDay(dt_vencimento_w) = 7) then
				dt_vencimento_w	:= dt_vencimento_w + 2;
			elsif (pkg_date_utils.get_WeekDay(dt_vencimento_w) = 1) then
				dt_vencimento_w := dt_vencimento_w + 1;
			end if;
			SELECT * FROM calcular_vencimento(cd_estabelecimento_w, cd_cond_pagto_w, dt_vencimento_w, qt_venc_w, ds_venc_w) INTO STRICT qt_venc_w, ds_venc_w;
			if (qt_venc_w = 1) then	
				dt_vencimento_w	:= to_date(substr(ds_venc_w,1,10),'dd/mm/yyyy');
			end if;
		end if;
		
		select	coalesce(max(nr_sequencia),0) + 1
		into STRICT	nr_seq_alt_w
		from	titulo_pagar_alt_venc
		where	nr_titulo = nr_titulo_w;

		insert into titulo_pagar_alt_venc(		/* Rafael. OS48885. 29/01/2007. */
				nr_titulo      ,
				nr_sequencia   ,
				dt_anterior    ,
				dt_vencimento  ,
				dt_atualizacao ,
				nm_usuario     ,
				dt_alteracao)
			values (nr_titulo_w,
				nr_seq_alt_w, 
				dt_vencimento_w,
				dt_vencimento_w,
				clock_timestamp(),
				nm_usuario_p,
				trunc(clock_timestamp(),'dd'));

		CALL atualizar_venc_titulo_pagar(nr_titulo_w, nr_seq_alt_w, nm_usuario_p);
		
		update	titulo_pagar_imposto
		set	dt_imposto		= dt_vencimento_w,
			dt_atualizacao		= clock_timestamp(),
			nm_usuario		= nm_usuario_p,
			nr_seq_trib_cp		= nr_seq_regra_w
		where	nr_sequencia		= nr_sequencia_w;
		end;
	end loop;
	close C02;
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE atualizar_venc_titulo_imposto (nr_titulo_original_p bigint, nr_seq_alteracao_p bigint, nm_usuario_p text) FROM PUBLIC;

