-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE diops_gerar_movimentos_rec ( nm_usuario_p text, nr_seq_periodo_p bigint) AS $body$
DECLARE


dt_periodo_diops_w		timestamp;
dt_competencia_w		timestamp;
nr_seq_tipo_movto_w		diops_tipo_movto_pel.nr_sequencia%type;

c_movimentos_rec CURSOR FOR
	SELECT	nr_sequencia
	from	diops_tipo_movto_rec
	where	dt_periodo_diops_w between dt_inicio and coalesce(dt_fim,dt_periodo_diops_w)
	order by nr_seq_apres_tela;

c_competencia_rec CURSOR FOR
	SELECT	pkg_date_utils.add_month(dt_periodo_diops_w,-2,0) dt_competencia
	
	
union all

	SELECT	pkg_date_utils.add_month(dt_periodo_diops_w,-1,0)
	
	
union all

	select	dt_periodo_diops_w
	;


BEGIN

select	dt_periodo_final
into STRICT	dt_periodo_diops_w
from	diops_periodo
where	nr_sequencia	= nr_seq_periodo_p;

open c_movimentos_rec;
loop
fetch c_movimentos_rec into
	nr_seq_tipo_movto_w;
EXIT WHEN NOT FOUND; /* apply on c_movimentos_rec */
	begin

	open c_competencia_rec;
	loop
	fetch c_competencia_rec into
		dt_competencia_w;
	EXIT WHEN NOT FOUND; /* apply on c_competencia_rec */
		begin

		insert into diops_movto_rec(nr_sequencia,
				dt_atualizacao,
				nm_usuario,
				dt_atualizacao_nrec,
				nm_usuario_nrec,
				nr_seq_tipo_movto,
				nr_seq_periodo,
				vl_ind_contrap,
				vl_ind_prov_contrap,
				vl_col_contrap,
				vl_col_prov_contrap,
				dt_mes_competencia)
		values (nextval('diops_movto_rec_seq'),
				clock_timestamp(),
				nm_usuario_p,
				clock_timestamp(),
				nm_usuario_p,
				nr_seq_tipo_movto_w,
				nr_seq_periodo_p,
				0,0,0,0,
				dt_competencia_w);

		end;
	end loop;
	close c_competencia_rec;

	end;
end loop;
close c_movimentos_rec;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE diops_gerar_movimentos_rec ( nm_usuario_p text, nr_seq_periodo_p bigint) FROM PUBLIC;

