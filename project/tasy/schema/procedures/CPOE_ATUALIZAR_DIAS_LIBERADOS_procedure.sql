-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';



--
-- dblink wrapper to call function cpoe_atualizar_dias_liberados as an autonomous transaction
--
CREATE EXTENSION IF NOT EXISTS dblink;

CREATE OR REPLACE PROCEDURE cpoe_atualizar_dias_liberados ( nm_usuario_p text, nr_seq_cpoe_p bigint, nr_prescricao_p bigint, qt_dias_liberado_p bigint, dt_inicio_medic_p timestamp default null) AS $body$
DECLARE
	-- Change this to reflect the dblink connection string
	v_conn_str  text := format('port=%s dbname=%s user=%s', current_setting('port'), current_database(), current_user);
	v_query     text;

BEGIN
	v_query := 'CALL cpoe_atualizar_dias_liberados_atx ( ' || quote_nullable(nm_usuario_p) || ',' || quote_nullable(nr_seq_cpoe_p) || ',' || quote_nullable(nr_prescricao_p) || ',' || quote_nullable(qt_dias_liberado_p) || ',' || quote_nullable(dt_inicio_medic_p) || ' )';
	PERFORM * FROM dblink(v_conn_str, v_query) AS p (ret boolean);

END;
$body$ LANGUAGE plpgsql SECURITY DEFINER;




CREATE OR REPLACE PROCEDURE cpoe_atualizar_dias_liberados_atx ( nm_usuario_p text, nr_seq_cpoe_p bigint, nr_prescricao_p bigint, qt_dias_liberado_p bigint, dt_inicio_medic_p timestamp default null) AS $body$
DECLARE


ie_param7_cih_w			varchar(5);
ie_prescr_origem_cpoe_w	varchar(5);
nr_dia_util_w			cpoe_material.nr_dia_util%type;
nr_seq_mat_cpoe_w 		cpoe_material.nr_sequencia%type;
nr_atendimento_w		cpoe_material.nr_atendimento%type;
dt_inicio_cih_w  	  	timestamp;
dt_inicio_item_w	  	timestamp;
ie_dias_util_medic_w 	material.ie_dias_util_medic%type;
dt_inicio_medic_w	prescr_material.dt_inicio_medic%type;
ie_info_rastre_prescr_w	varchar(1);
BEGIN

if (coalesce(nr_prescricao_p,0) > 0) and (coalesce(nr_seq_cpoe_p,0) > 0) then
	ie_info_rastre_prescr_w := obter_se_info_rastre_prescr('UA', nm_usuario_p, obter_perfil_ativo, wheb_usuario_pck.get_cd_estabelecimento);
	ie_param7_cih_w := Obter_param_Usuario(896, 67, obter_perfil_ativo, nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento, ie_param7_cih_w);
	ie_prescr_origem_cpoe_w := obter_se_prescricao_cpoe(nr_prescricao_p);
	nr_dia_util_w := cih_obter_dias_util_cpoe(nr_seq_cpoe_p);
	
	select 	coalesce(max(b.ie_dias_util_medic),'N'),
			max(a.dt_inicio),
			max(a.nr_atendimento)
	into STRICT 	ie_dias_util_medic_w,
			dt_inicio_item_w,
			nr_atendimento_w
	from 	cpoe_material a,
			material b
	where 	a.nr_sequencia = nr_seq_cpoe_p
	and		a.cd_material = b.cd_material;

	if (dt_inicio_medic_p IS NOT NULL AND dt_inicio_medic_p::text <> '') then
        dt_inicio_medic_w := dt_inicio_medic_p;
    else
        select 	max(dt_inicio_medic)
        into STRICT	dt_inicio_medic_w
        from 	prescr_material
        where 	nr_seq_mat_cpoe = nr_seq_cpoe_p;
    end if;

	if (((ie_param7_cih_w = 'S') and (ie_prescr_origem_cpoe_w = 'S') and
	     ((ie_dias_util_medic_w = 'S' AND qt_dias_liberado_p >= nr_dia_util_w) or
	      (ie_dias_util_medic_w = 'O' AND qt_dias_liberado_p > nr_dia_util_w))) or (ie_param7_cih_w = 'N')) then

		if (coalesce(qt_dias_liberado_p, 0) >= 1) then
			dt_inicio_cih_w := cpoe_obter_inicio_cih_detail(nr_seq_cpoe_p, dt_inicio_item_w,dt_inicio_medic_w);
		else
			dt_inicio_cih_w := clock_timestamp();
		end if;

		update	cpoe_material
		set	qt_dias_liberado	= coalesce(qt_dias_liberado_p, 0),
			nm_usuario		= nm_usuario_p,
			dt_fim_cih 		= dt_inicio_cih_w + coalesce(qt_dias_liberado_p, 0) - 1/86400
		where	nr_sequencia 		= nr_seq_cpoe_p;
		
		if (ie_info_rastre_prescr_w = 'S') then
			CALL gravar_log_cpoe('CPOE_ATUALIZAR_DIAS_LIBERADOS: '
				|| ' - nm_usuario_p: ' || nm_usuario_p
				|| ' - nr_seq_cpoe_p: ' || nr_seq_cpoe_p
				|| ' - nr_prescricao_p: ' || nr_prescricao_p
				|| ' - qt_dias_liberado_p: ' || qt_dias_liberado_p
				|| ' - dt_inicio_item_w: ' || to_char(dt_inicio_item_w,'dd/mm/yyyy hh24:mi:ss')
				|| ' - dt_inicio_medic_w: ' || to_char(dt_inicio_medic_w,'dd/mm/yyyy hh24:mi:ss')
				|| ' - ie_param7_cih_w: ' || ie_param7_cih_w
				|| ' - diff_date: ' || ((dt_inicio_cih_w + coalesce(qt_dias_liberado_p, 0)) - dt_inicio_item_w)
				, nr_atendimento_w
				, 'M'
				, nr_seq_cpoe_p);
		end if;

		commit;
	end if;	
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cpoe_atualizar_dias_liberados ( nm_usuario_p text, nr_seq_cpoe_p bigint, nr_prescricao_p bigint, qt_dias_liberado_p bigint, dt_inicio_medic_p timestamp default null) FROM PUBLIC; -- REVOKE ALL ON PROCEDURE cpoe_atualizar_dias_liberados_atx ( nm_usuario_p text, nr_seq_cpoe_p bigint, nr_prescricao_p bigint, qt_dias_liberado_p bigint, dt_inicio_medic_p timestamp default null) FROM PUBLIC;

