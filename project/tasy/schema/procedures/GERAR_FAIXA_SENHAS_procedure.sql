-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_faixa_senhas ( nr_seq_fila_p bigint, nr_senha_inicial_p bigint, nr_senha_final_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) AS $body$
DECLARE


nr_senha_atual_w        bigint;
nr_seq_pac_senha_fila_w bigint;
ie_existe_w             bigint;
dt_geracao_senha_w      timestamp;
qt_segundos_w           bigint;
nr_seq_fila_w           bigint;

procedure add_paciente_senha_fila(nr_seq_paciente_fila_p in bigint, dt_ger_senha_p in timestamp, nr_senha_p in bigint) is
;
BEGIN
	insert  into    paciente_senha_fila(nr_sequencia,
                        nr_seq_fila_senha_origem,
                        nr_seq_fila_senha,
                        nm_usuario_nrec,
                        nm_usuario,
                        dt_geracao_senha,
                        dt_atualizacao_nrec,
                        dt_atualizacao,
                        cd_senha_gerada,
                        cd_estabelecimento)
                values (nr_seq_paciente_fila_p,
                        nr_seq_fila_p,
                        nr_seq_fila_p,
                        nm_usuario_p,
                        nm_usuario_p,
                        dt_ger_senha_p,
                        clock_timestamp(),
                        clock_timestamp(),
                        nr_senha_p,
                        cd_estabelecimento_p);
end;

procedure add_controle_senha_fila(nr_sequencia_p in number, nr_senha_p in number) is
begin
	insert into CONTROLE_SENHA_FILA(nr_sequencia,
						 dt_atualizacao, 
						 nm_usuario, 
						 dt_atualizacao_nrec, 
						 nm_usuario_nrec,  
						 cd_senha_gerada)
				 values (nr_sequencia_p,
				         clock_timestamp(),
				         nm_usuario_p,
						 clock_timestamp(),
						 nm_usuario_p,
						 nr_senha_p);
end;
	
begin
	delete from CONTROLE_SENHA_FILA where nm_usuario = nm_usuario_p;
	qt_segundos_w := ((coalesce(nr_senha_final_p,0) - coalesce(nr_senha_inicial_p,0)) + 1) * ((1 / 1440) / 60);

	dt_geracao_senha_w := clock_timestamp() - qt_segundos_w;
For     nr_senha_atual_w in coalesce(nr_senha_inicial_p,0) .. coalesce(nr_senha_final_p,0) loop

        update  fila_espera_senha
        set     qt_faixa_atual  = nr_senha_atual_w
        where   nr_sequencia    = nr_seq_fila_p;

        select  nextval('paciente_senha_fila_seq')
        into STRICT    nr_seq_pac_senha_fila_w
;

        begin
                select  nr_sequencia
                into STRICT    ie_existe_w
                from    paciente_senha_fila
                where   cd_senha_gerada = nr_senha_atual_w
                and     nr_seq_fila_senha = nr_seq_fila_p
                and     coalesce(dt_vinculacao_senha::text, '') = ''
                and     coalesce(dt_inutilizacao::text, '') = ''  LIMIT 1;
        exception
                when    others then
                        ie_existe_w := 0;
        end;

        if (ie_existe_w = 0) then
                dt_geracao_senha_w := dt_geracao_senha_w + ((1/1440)/60);
				add_paciente_senha_fila(nr_seq_pac_senha_fila_w, dt_geracao_senha_w, nr_senha_atual_w);
		else
			select nextval('controle_senha_fila_seq')
			  into STRICT nr_seq_fila_w
			;
			
			add_controle_senha_fila(nr_seq_fila_w, nr_senha_atual_w);
        end if;


End loop;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_faixa_senhas ( nr_seq_fila_p bigint, nr_senha_inicial_p bigint, nr_senha_final_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) FROM PUBLIC;

