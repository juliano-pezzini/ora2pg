-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_etapa_conta_item_doc ( nr_sequencia_p bigint, nr_seq_item_p bigint, nr_seq_etapa_p bigint, nm_usuario_p text) AS $body$
DECLARE

			 
nr_seq_interno_w		bigint;
cd_setor_destino_w		integer;
cd_pessoa_destino_w	varchar(10);
ds_documento_w		varchar(2000);
ie_conta_existe_w		varchar(10);
qt_existe_w		bigint;
cd_estabelecimento_w	bigint;
cd_perfil_w		bigint;
nr_seq_etapa_w		bigint;
ie_regra_restrita_etapa_w	varchar(1);
ie_encontrou_regra_w	varchar(1);

C01 CURSOR FOR 
	SELECT	nr_seq_etapa 
	from	fatur_etapa_alta 
	where	nr_seq_etapa_filtro = nr_seq_etapa_p 
	and	ie_evento = '1' 
	and 	coalesce(cd_estabelecimento,coalesce(cd_estabelecimento_w,1)) = coalesce(cd_estabelecimento_w,1) 
	and	coalesce(cd_perfil,coalesce(cd_perfil_w,0)) = coalesce(cd_perfil_w,0) 
	and	ie_situacao = 'A' 
	order by	coalesce(cd_perfil,0), 
		coalesce(cd_estabelecimento,0);


BEGIN 
 
if (coalesce(nr_sequencia_p,0) > 0) and (coalesce(nr_seq_item_p,0) > 0) and (coalesce(nr_seq_etapa_p,0) > 0) then 
	begin 
	select	b.nr_seq_interno, 
		b.ds_documento, 
		a.cd_setor_destino, 
		a.cd_pessoa_destino 
	into STRICT	nr_seq_interno_w, 
		ds_documento_w, 
		cd_setor_destino_w, 
		cd_pessoa_destino_w 
	from 	protocolo_doc_item b, 
		protocolo_documento a 
	where 	a.nr_sequencia	= b.nr_sequencia 
	and	a.nr_sequencia	= nr_sequencia_p 
	and	b.nr_seq_item	= nr_seq_item_p;
	 
	select	wheb_usuario_pck.get_cd_estabelecimento, 
		obter_perfil_ativo 
	into STRICT	cd_estabelecimento_w, 
		cd_perfil_w 
	;
	 
	select	coalesce(max(ie_regra_restrita_etapa),'N') 
	into STRICT	ie_regra_restrita_etapa_w 
	from	parametro_faturamento 
	where	cd_estabelecimento = cd_estabelecimento_w;
	 
	if (coalesce(cd_pessoa_destino_w,'0') = '0') then 
		begin 
		select	cd_pessoa_fisica 
		into STRICT	cd_pessoa_destino_w 
		from	usuario 
		where	nm_usuario = nm_usuario_p;
		exception 
		when others then 
			cd_pessoa_destino_w := null;
		end;		
	end if;
 
	nr_sequencia_p := inserir_conta_etapa( 
			nr_seq_interno_w, nm_usuario_p, nr_seq_etapa_p, cd_setor_destino_w, 0, cd_pessoa_destino_w, wheb_mensagem_pck.get_Texto(312711, 'DS_DOCUMENTO_W='|| DS_DOCUMENTO_W), /*'Gerado pelo Protocolo Documento: ' || ds_documento_w || ' - ', */ 
			0, nr_sequencia_p);
			 
			 
	update	protocolo_doc_item 
	set	nr_seq_etapa_conta	= nr_seq_etapa_p 
	where	nr_sequencia		= nr_sequencia_p 
	and	nr_seq_item		= nr_seq_item_p;
 
	ie_encontrou_regra_w	:= 'N';
 
	open C01;
	loop 
	fetch C01 into	 
		nr_seq_etapa_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin 
		ie_encontrou_regra_w	:= 'S';
		 
		if (ie_regra_restrita_etapa_w = 'N') then 
			nr_sequencia_p := inserir_conta_etapa( 
				nr_seq_interno_w, nm_usuario_p, nr_seq_etapa_w, cd_setor_destino_w, 0, cd_pessoa_destino_w, wheb_mensagem_pck.get_Texto(312713, 'DS_DOCUMENTO_W='|| DS_DOCUMENTO_W), /*'Gerado pela regra (Protocolo Documento): ' || ds_documento_w || ' - ', */ 
				0, nr_sequencia_p);
 
				 
			update	protocolo_doc_item 
			set	nr_seq_etapa_conta	= nr_seq_etapa_p 
			where	nr_sequencia		= nr_sequencia_p 
			and	nr_seq_item		= nr_seq_item_p;
		end if;
		end;
	end loop;
	close C01;
	 
	if (ie_regra_restrita_etapa_w = 'S') and (ie_encontrou_regra_w = 'S') then 
		nr_sequencia_p := inserir_conta_etapa( 
			nr_seq_interno_w, nm_usuario_p, nr_seq_etapa_w, cd_setor_destino_w, 0, cd_pessoa_destino_w, wheb_mensagem_pck.get_Texto(312713, 'DS_DOCUMENTO_W='|| DS_DOCUMENTO_W), /*'Gerado pela regra (Protocolo Documento): ' || ds_documento_w || ' - ', */ 
			0, nr_sequencia_p);
			 
		update	protocolo_doc_item 
		set	nr_seq_etapa_conta	= nr_seq_etapa_p 
		where	nr_sequencia		= nr_sequencia_p 
		and	nr_seq_item		= nr_seq_item_p;
	end if;
 
	commit;
	end;
end if;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_etapa_conta_item_doc ( nr_sequencia_p bigint, nr_seq_item_p bigint, nr_seq_etapa_p bigint, nm_usuario_p text) FROM PUBLIC;

