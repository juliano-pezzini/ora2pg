-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE calcular_carboplatina ( nr_seq_paciente_p bigint, nr_seq_atendimento_p bigint, qt_creatinina_p bigint, qt_auc_p bigint, cd_unidade_param_p text, cd_estabelecimento_p bigint, qt_clearance_p INOUT bigint, qt_carboplatina_p INOUT bigint) AS $body$
DECLARE

 
cd_pessoa_fisica_w	varchar(10);
dt_nascimento_w		timestamp;
qt_idade_w		smallint;
ie_sexo_w		varchar(1);
nr_seq_atendimento_w	bigint;
qt_supef_corporal_w	double precision;
ie_unid_med_w		bigint;
qt_peso_w		varchar(10);
qt_redutor_sc_w		double precision;
ie_l_dl_creatinina_w	smallint;

c01 CURSOR FOR 
SELECT	nr_seq_atendimento 
from	paciente_atendimento 
where	nr_seq_paciente = nr_seq_paciente_p 
and	coalesce(nr_prescricao::text, '') = '';


BEGIN 
qt_carboplatina_p	:= 0;
 
select	cd_pessoa_fisica 
into STRICT	cd_pessoa_fisica_w 
from	paciente_setor 
where	nr_seq_paciente	= nr_seq_paciente_p;
 
if (nr_seq_atendimento_p > 0) then 
	select	qt_peso 
	into STRICT	qt_peso_w 
	from	paciente_atendimento 
	where	nr_seq_atendimento = nr_seq_atendimento_p;
end if;
 
select	dt_nascimento, 
	ie_sexo 
into STRICT	dt_nascimento_w, 
	ie_sexo_w 
from	pessoa_fisica 
where	cd_pessoa_fisica	= cd_pessoa_fisica_w;
 
select	(obter_idade(dt_nascimento_w,clock_timestamp(),'A'))::numeric  
into STRICT	qt_idade_w
;
 
ie_unid_med_w := 1; /* Fixo igual a 1 - OS 108243 */
 
if (qt_peso_w > 0) and (qt_creatinina_p > 0) then 
	begin 
	qt_clearance_p	:= dividir(((140 - qt_idade_w) * qt_peso_w) , (7.2 * qt_creatinina_p));
 
	if (ie_unid_med_w = 1) then 
		qt_clearance_p	:= qt_clearance_p * 0.10;	
	end if;
 
	if (ie_sexo_w = 'F') then	 
		qt_clearance_p	:= qt_clearance_p * 0.85;	
	end if;
 
	qt_carboplatina_p	:= round((qt_auc_p * (qt_clearance_p + 25)),2);
 
	qt_clearance_p	:= round((qt_clearance_p)::numeric,2);
	end;
end if;
 
CALL Atualizar_Dose_Oncologia(nr_seq_atendimento_p);
 
commit;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE calcular_carboplatina ( nr_seq_paciente_p bigint, nr_seq_atendimento_p bigint, qt_creatinina_p bigint, qt_auc_p bigint, cd_unidade_param_p text, cd_estabelecimento_p bigint, qt_clearance_p INOUT bigint, qt_carboplatina_p INOUT bigint) FROM PUBLIC;

