-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE criar_os_atividade_dec ( cd_pessoa_solicitante_w text, ds_os_w text, dt_entrada_w timestamp, NM_USUARIO_LIDER_w text, nr_seq_grupo_des_w bigint, qt_tempo_atividade_w bigint, nr_atividade_dia_w bigint, nr_seq_usuario_controle_w bigint, nm_usuario_p text) AS $body$
DECLARE


nr_sequencia_w		bigint;
nr_seq_atividade_w	bigint;
nr_seq_funcao_w		bigint;
dt_fim_atividade_w timestamp;
dt_entrada_aux_w timestamp;


BEGIN

-- criar OS
select	nextval('man_ordem_servico_seq')
into STRICT	nr_sequencia_w
;

insert	into man_ordem_servico(
	nr_sequencia,
	nr_seq_localizacao,
	nr_seq_equipamento,
	cd_pessoa_solicitante,
	dt_ordem_servico,
	ie_prioridade,
	ie_parado,
	ds_dano_breve,
	dt_atualizacao,
	nm_usuario,
	dt_inicio_desejado,
	dt_conclusao_desejada,
	ds_dano,
	dt_inicio_previsto,
	dt_fim_previsto,
	dt_inicio_real,
	dt_fim_real,
	ie_tipo_ordem,
	ie_status_ordem,
	nr_grupo_planej,
	nr_grupo_trabalho,
	nr_seq_tipo_solucao,
	ds_solucao,
	nm_usuario_exec,
	qt_contador,
	nr_seq_planej,
	nr_seq_tipo_contador,
	nr_seq_estagio,
	cd_projeto,
	nr_seq_etapa_proj,
	dt_reabertura,
	cd_funcao,
	nm_tabela,
	ie_classificacao,
	nr_seq_origem,
	nr_seq_projeto,
	ie_grau_satisfacao,
	nr_seq_indicador,
	nr_seq_causa_dano,
	ie_forma_receb,
	nr_seq_cliente,
	nr_seq_grupo_des,
	nr_seq_grupo_sup,
	nr_seq_superior,
	ie_eficacia,
	dt_prev_eficacia,
	cd_pf_eficacia,
	nr_seq_nao_conform,
	nr_seq_complex,
	dt_atualizacao_nrec,
	nm_usuario_nrec,
	ie_obriga_news,
	nr_seq_meta_pe,
	nr_seq_classif,
	nr_seq_nivel_valor,
	nm_usuario_lib_news,
	dt_libera_news,
	dt_envio_wheb,
	ds_contato_solicitante,
	ie_prioridade_desen,
	ie_prioridade_sup,
	nr_seq_proj_cron_etapa,
	ie_exclusiva,
	ie_origem_os)
values (	nr_sequencia_w,
	1272,					-- nr_seq_localizacao,
	1395,					-- nr_seq_equipamento,
	cd_pessoa_solicitante_w,		-- cd_pessoa_solicitante,
	dt_entrada_w,				-- dt_ordem_servico,
	'M',					-- ie_prioridade,
	'N',					-- ie_parado,
	ds_os_w,		-- ds_dano_breve,
	dt_entrada_w,				-- dt_atualizacao,
	nm_usuario_p,				-- nm_usuario,
	dt_entrada_w,				-- dt_inicio_desejado,
	dt_entrada_w + 15,				-- dt_conclusao_desejada,
	ds_os_w,				-- ds_dano,
	dt_entrada_w,				-- dt_inicio_previsto,
	dt_entrada_w + 15,				-- dt_fim_previsto,
	dt_entrada_w,				-- dt_inicio_real,
	null,					-- dt_fim_real,
	'1',					-- ie_tipo_ordem,
	'1',					-- ie_status_ordem,
	2,					-- nr_grupo_planej,
	2,					-- nr_grupo_trabalho,
	null,					-- nr_seq_tipo_solucao,
	null,					-- ds_solucao,
	NM_USUARIO_LIDER_w, 			-- nm_usuario_exec,
	null,					-- qt_contador,
	null,					-- nr_seq_planej,
	null,					-- nr_seq_tipo_contador,
	1191,					-- nr_seq_estagio,
	null,					-- cd_projeto,
	null,					-- nr_seq_etapa_proj,
	null,					-- dt_reabertura,
	null,				-- cd_funcao,
	null,					-- nm_tabela,
	'S',					-- ie_classificacao,
	null,					-- nr_seq_origem,
	null,					-- nr_seq_projeto,
	null,					-- ie_grau_satisfacao,
	null,					-- nr_seq_indicador,
	null,					-- nr_seq_causa_dano,
	'U',					-- ie_forma_receb,
	null,					-- nr_seq_cliente,
	nr_seq_grupo_des_w,			-- nr_seq_grupo_des,
	null,					-- nr_seq_grupo_sup,
	null,					-- nr_seq_superior,
	null,					-- ie_eficacia,
	null,					-- dt_prev_eficacia,
	null,					-- cd_pf_eficacia,
	null,					-- nr_seq_nao_conform,
	null,					-- nr_seq_complex,
	null,					-- dt_atualizacao_nrec,
	nm_usuario_p,				-- nm_usuario_nrec,
	null,					-- ie_obriga_news,
	null,					-- nr_seq_meta_pe,
	null,					-- nr_seq_classif,
	null,					-- nr_seq_nivel_valor,
	null,					-- nm_usuario_lib_news,
	null,					-- dt_libera_news,
	null,					-- dt_envio_wheb,
	null,					-- ds_contato_solicitante,
	null,					-- ie_prioridade_desen,
	null,					-- ie_prioridade_sup
	null,					-- nr_seq_proj_cron_etapa
	'E',					-- ie_exclusiva
	'1');

-- inserir executor
insert into man_ordem_servico_exec(
	nr_sequencia,
	nr_seq_ordem,
	dt_atualizacao,
	nm_usuario,
	nm_usuario_exec,
	dt_recebimento)
values (nextval('man_ordem_servico_exec_seq'),
	nr_sequencia_w,
	dt_entrada_w,
	nm_usuario_p,
	NM_USUARIO_LIDER_w,
	dt_entrada_w);

-- iniciar atividade
select	nextval('man_ordem_serv_ativ_seq')
into STRICT	nr_seq_atividade_w
;

select	max(nr_sequencia)
into STRICT	nr_seq_funcao_w
from	MAN_TIPO_FUNCAO
where	nr_sequencia = 332;

if (coalesce(nr_seq_funcao_w::text, '') = '') then
	select	max(nr_sequencia)
	into STRICT	nr_seq_funcao_w
	from	MAN_TIPO_FUNCAO;
end if;


dt_entrada_aux_w := trunc(dt_entrada_w) + ((1/24) * 8);

if (nr_atividade_dia_w > 1) then
	dt_entrada_aux_w := dt_entrada_aux_w + (((1/24/60) * qt_tempo_atividade_w)*(nr_atividade_dia_w-1));
end if;

dt_fim_atividade_w := dt_entrada_aux_w + ((1/24/60) * qt_tempo_atividade_w);

if (nr_atividade_dia_w = 4) then
	dt_entrada_aux_w := dt_entrada_aux_w + (((1/24/60) * 1));
end if;


insert into man_ordem_serv_ativ(
		nr_sequencia,
		nr_seq_ordem_serv,
		dt_atualizacao,
		nm_usuario,
		dt_atividade,
		nr_seq_funcao,
		qt_minuto,
		nm_usuario_exec,
		dt_fim_atividade,
		dt_atualizacao_nrec,
		nm_usuario_nrec)
values (
		nr_seq_atividade_w,
		nr_sequencia_w,
		dt_entrada_aux_w,
		nm_usuario_p,
		dt_entrada_aux_w,
		nr_seq_funcao_w,
		qt_tempo_atividade_w,
		nm_usuario_p,
		dt_fim_atividade_w,
		dt_entrada_aux_w,
		nm_usuario_p);

-- finalizar atividade
update	man_ordem_serv_ativ
set	dt_atualizacao = dt_fim_atividade_w,
	nm_usuario = nm_usuario_p,
	dt_fim_atividade = dt_fim_atividade_w
where	nr_sequencia = nr_seq_atividade_w;

CALL ATUALIZAR_ATIV_USUARIO(nr_seq_usuario_controle_w);

-- encerrar os
update	man_ordem_servico
set	dt_fim_real	= trunc(dt_entrada_w) + ((1/24) * 18),
	nr_seq_estagio	= 9,
	ie_status_ordem	= 3,
	nm_usuario	= nm_usuario_p,
	dt_atualizacao	= trunc(dt_entrada_w) + ((1/24) * 18),
	nm_usuario_encer= nm_usuario_p
where	nr_sequencia	= nr_sequencia_w;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE criar_os_atividade_dec ( cd_pessoa_solicitante_w text, ds_os_w text, dt_entrada_w timestamp, NM_USUARIO_LIDER_w text, nr_seq_grupo_des_w bigint, qt_tempo_atividade_w bigint, nr_atividade_dia_w bigint, nr_seq_usuario_controle_w bigint, nm_usuario_p text) FROM PUBLIC;

