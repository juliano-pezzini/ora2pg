-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE qt_duplicar_pendencia ( nr_seq_pend_agenda_p bigint, dt_inicio_ciclo_p timestamp, nr_ciclo_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint) AS $body$
DECLARE



nr_seq_atendimento_w 		bigint;
nr_seq_atendimento_new_w 	bigint;
nr_seq_pend_agenda_w		bigint;
dt_inicio_ciclo_w		timestamp := null;
dt_prevista_w			timestamp;
dt_prevista_new_w		timestamp;

qt_dif_dias_w			bigint := 0;



c01 CURSOR FOR
	SELECT	nr_seq_atendimento,
		coalesce(dt_real,dt_prevista)
	from	paciente_atendimento
	where	nr_seq_pend_agenda	= nr_seq_pend_agenda_p
	order	by nr_seq_atendimento;



BEGIN

select	nextval('qt_pendencia_agenda_seq')
into STRICT	nr_seq_pend_agenda_w
;

insert into qt_pendencia_agenda(nr_sequencia,
	dt_atualizacao,
	nm_usuario,
	dt_atualizacao_nrec,
	nm_usuario_nrec,
	ie_tipo_pendencia,
	ie_pendencia_duplicada,
	cd_estabelecimento)
values (nr_seq_pend_agenda_w,
	clock_timestamp(),
	nm_usuario_p,
	clock_timestamp(),
	nm_usuario_p,
	'Q',
	'S',
	cd_estabelecimento_p);


open c01;
loop
fetch c01 into
	nr_seq_atendimento_w,
	dt_prevista_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	begin

	select	nextval('paciente_atendimento_seq')
	into STRICT	nr_seq_atendimento_new_w
	;

	if (coalesce(dt_inicio_ciclo_w::text, '') = '') then
		dt_inicio_ciclo_w := dt_prevista_w;
	else
		qt_dif_dias_w := trunc(dt_prevista_w)	- trunc(dt_inicio_ciclo_w);
	end if;

	dt_prevista_new_w := trunc(dt_inicio_ciclo_p) + qt_dif_dias_w +  (dt_prevista_w - trunc(dt_prevista_w));


	insert	into	paciente_atendimento(
		nr_seq_atendimento,
		nr_seq_paciente,
		nr_ciclo,
		ds_dia_ciclo,
		dt_prevista,
		dt_atualizacao,
		nm_usuario,
		dt_real,
		qt_peso,
		qt_superf_corporal,
		nr_prescricao,
		nr_seq_protocolo,
		ds_observacao,
		dt_inicio_adm,
		dt_fim_adm,
		nr_seq_local,
		ie_exige_liberacao,
		dt_chegada,
		dt_liberacao,
		nm_usuario_lib,
		dt_dispensacao_medic,
		dt_estorno_chegada,
		nm_usuario_estorno_chegada,
		nr_atendimento,
		dt_cancelamento,
		nm_usuario_cancel,
		nm_usuario_check_lib,
		dt_check_lib,
		qt_altura,
		dt_acomodacao_paciente,
		dt_atualizacao_nrec,
		nm_usuario_nrec,
		dt_geracao_prescricao,
		dt_suspensao,
		nm_usuario_suspensao,
		dt_anterior,
		dt_inicio_triagem,
		dt_fim_triagem,
		dt_retirada_medicacao,
		--nm_usuario_retirada_medicacao,
		dt_liberacao_atend,
		nm_usuario_lib_atend,
		nr_seq_agenda_cons,
		qt_auc,
		qt_creatinina,
		ie_l_dl_creatinina,
		qt_clearance_creatinina,
		qt_mg_carboplatina,
		nr_seq_pend_agenda,
		nm_usuario_fim_adm,
		dt_aguard_result_exame,
		dt_quimio_liberada
		)
		(
		SELECT
		nr_seq_atendimento_new_w,
		nr_seq_paciente,
		nr_ciclo_p,
		ds_dia_ciclo,
		dt_prevista_new_w,
		clock_timestamp(),
		nm_usuario_p,
		--dt_real,
		null,
		qt_peso,
		qt_superf_corporal,
		nr_prescricao,
		nr_seq_protocolo,
		ds_observacao,
		dt_inicio_adm,
		dt_fim_adm,
		nr_seq_local,
		ie_exige_liberacao,
		dt_chegada,
		dt_liberacao,
		nm_usuario_p,
		dt_dispensacao_medic,
		dt_estorno_chegada,
		nm_usuario_estorno_chegada,
		nr_atendimento,
		dt_cancelamento,
		nm_usuario_cancel,
		nm_usuario_check_lib,
		dt_check_lib,
		qt_altura,
		dt_acomodacao_paciente,
		clock_timestamp(),
		nm_usuario_p,
		dt_geracao_prescricao,
		dt_suspensao,
		nm_usuario_suspensao,
		dt_anterior,
		dt_inicio_triagem,
		dt_fim_triagem,
		dt_retirada_medicacao,
		--nm_usuario_retirada_medicacao,
		dt_liberacao_atend,
		nm_usuario_lib_atend,
		nr_seq_agenda_cons,
		qt_auc,
		qt_creatinina,
		ie_l_dl_creatinina,
		qt_clearance_creatinina,
		qt_mg_carboplatina,
		nr_seq_pend_agenda_w,
		nm_usuario_fim_adm,
		dt_aguard_result_exame,
		dt_quimio_liberada
		from	paciente_atendimento
		where	nr_seq_atendimento = nr_seq_atendimento_w
		);


	end;
end loop;
close c01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE qt_duplicar_pendencia ( nr_seq_pend_agenda_p bigint, dt_inicio_ciclo_p timestamp, nr_ciclo_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint) FROM PUBLIC;

