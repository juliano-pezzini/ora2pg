-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE baca_atual_valores_hist_audit () AS $body$
DECLARE


nr_sequencia_w		bigint;
vl_inicial_w		double precision;
nr_interno_conta_w	bigint;
cd_convenio_w		integer;
vl_historico_w		double precision;
ie_acao_w		smallint;
vl_nao_auditado_w 	double precision;
vl_recebido_w		double precision;
vl_reapresentacao_w	double precision;
vl_glosa_devida_w	double precision;
vl_glosa_indevida_w	double precision;
vl_pendente_w		double precision;
vl_recebido_novo_w	double precision;
vl_glosa_devida_novo_w	double precision;
vl_glosa_indevida_novo_w double precision;

c01 CURSOR FOR
SELECT nr_sequencia,
	 vl_inicial,
	 nr_interno_conta,
	 cd_convenio
from	 conta_paciente_retorno;

c02 CURSOR FOR
SELECT 	b.vl_historico,
	a.ie_acao
from	hist_audit_conta_paciente a,
	conta_paciente_ret_hist b
where	a.nr_sequencia 	= b.nr_seq_hist_audit
and	b.nr_seq_conpaci_ret 	= nr_sequencia_w
order by	b.dt_historico;

/*
create table baca_auditoria_valores
as
select nr_sequencia,
	nr_interno_conta,
	cd_convenio,
	vl_inicial,
	vl_pendente,
	vl_recebido,
	vl_reapresentacao,
	vl_glosa_indevida,
	vl_glosa_devida
from conta_paciente_retorno
where 1 = 2;

Ã© necessario criar a tabela antes de criar o baca
*/
BEGIN
vl_recebido_w		:= 0;
vl_nao_auditado_w 	:= 0;
vl_reapresentacao_w	:= 0;
vl_glosa_devida_w	:= 0;
vl_glosa_indevida_w	:= 0;
open c01;
loop
fetch c01 into
	nr_sequencia_w,
	vl_inicial_w,
	nr_interno_conta_w,
	cd_convenio_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	vl_recebido_w		:= 0;
	vl_nao_auditado_w 	:= 0;
	vl_reapresentacao_w	:= 0;
	vl_glosa_devida_w	:= 0;
	vl_glosa_indevida_w	:= 0;
	vl_pendente_w := vl_inicial_w;
	open c02;
	loop
	fetch c02 into
		vl_historico_w,
		ie_acao_w;
	EXIT WHEN NOT FOUND; /* apply on c02 */

		if (ie_acao_w = 0) then
			vl_pendente_w		:= vl_pendente_w - vl_historico_w;
			vl_nao_auditado_w 	:= vl_nao_auditado_w + vl_historico_w;
		end if;

		if (ie_acao_w = 1) then
			vl_recebido_w		:= vl_recebido_w + vl_historico_w;
			vl_recebido_novo_w 	:= vl_historico_w;
			if (vl_pendente_w >= vl_recebido_novo_w) then
				vl_pendente_w 		:= vl_pendente_w - vl_recebido_novo_w;
				vl_recebido_novo_w 	:= 0;
			else
				vl_recebido_novo_w 	:= vl_recebido_novo_w - vl_pendente_w;
				vl_pendente_w 		:= 0;
				if (vl_reapresentacao_w >= vl_recebido_novo_w) then
					vl_reapresentacao_w	:= vl_reapresentacao_w - vl_recebido_novo_w;
					vl_recebido_novo_w	:= 0;
				else
					vl_recebido_novo_w	:= vl_recebido_novo_w - vl_reapresentacao_w;
					vl_reapresentacao_w	:= 0;
					if (vl_glosa_indevida_w >= vl_recebido_novo_w )then
						vl_glosa_indevida_w	:= vl_glosa_indevida_w - vl_recebido_novo_w;
					else
						vl_recebido_novo_w	:= vl_recebido_novo_w - vl_glosa_indevida_w;
						vl_glosa_indevida_w 	:= 0;
					end if;
				end if;
			end if;
		end if;

		if (ie_acao_w = 2) then
			vl_reapresentacao_w		:= vl_reapresentacao_w + vl_historico_w;
			vl_pendente_w			:= vl_pendente_w - vl_historico_w;
		end if;

		if (ie_acao_w = 3) then
			vl_glosa_devida_w		:= vl_glosa_devida_w + vl_historico_w;
			vl_glosa_devida_novo_w 		:= vl_historico_w;
			if (vl_pendente_w >= vl_glosa_devida_novo_w) then
				vl_pendente_w 		:= vl_pendente_w - vl_glosa_devida_novo_w;
				vl_glosa_devida_novo_w 	:= 0;
			else
				vl_glosa_devida_novo_w 	:= vl_glosa_devida_novo_w - vl_pendente_w;
				vl_pendente_w 		:= 0;
				if (vl_reapresentacao_w >= vl_glosa_devida_novo_w) then
					vl_reapresentacao_w	:= vl_reapresentacao_w - vl_glosa_devida_novo_w;
					vl_glosa_devida_novo_w	:= 0;
				else
					vl_glosa_devida_novo_w	:= vl_glosa_devida_novo_w - vl_reapresentacao_w;
					vl_reapresentacao_w	:= 0;
					if (vl_glosa_indevida_w >= vl_glosa_devida_novo_w )then
						vl_glosa_indevida_w	:= vl_glosa_indevida_w - vl_glosa_devida_novo_w;
					else
						vl_glosa_devida_novo_w	:= vl_glosa_devida_novo_w - vl_glosa_indevida_w;
						vl_glosa_indevida_w 	:= 0;
					end if;
				end if;
			end if;
		end if;

		if (ie_acao_w = 4) then
			vl_glosa_indevida_w			:= vl_glosa_indevida_w + vl_historico_w;
			vl_glosa_indevida_novo_w 		:= vl_historico_w;
			if (vl_pendente_w >= vl_glosa_indevida_novo_w) then
				vl_pendente_w 			:= vl_pendente_w - vl_glosa_indevida_novo_w;
				vl_glosa_indevida_novo_w 	:= 0;
			else
				vl_glosa_indevida_novo_w	:= vl_glosa_devida_novo_w - vl_pendente_w;
				vl_pendente_w 			:= 0;
				if (vl_reapresentacao_w >= vl_glosa_indevida_novo_w) then
					vl_reapresentacao_w	:= vl_reapresentacao_w - vl_glosa_devida_novo_w;
					vl_glosa_indevida_novo_w:= 0;
				else
					vl_glosa_indevida_novo_w	:= vl_glosa_indevida_novo_w - vl_reapresentacao_w;
					vl_reapresentacao_w		:= 0;
				end if;
			end if;
		end if;

		if (ie_acao_w = 5) then
			vl_pendente_w 	:= vl_pendente_w + vl_historico_w;
			if (vl_recebido_w > vl_historico_w) then
				vl_recebido_w	:= vl_recebido_w - vl_historico_w;
			else
				vl_historico_w	:= vl_historico_w - vl_recebido_w;
				vl_recebido_w	:= 0;
				vl_inicial_w	:= vl_inicial_w + vl_historico_w;
				vl_historico_w	:= 0;
			end if;
		end if;
	end loop;
	close c02;

	if	(vl_pendente_w >= 0 AND vl_inicial_w = vl_pendente_w + vl_glosa_devida_w + vl_glosa_indevida_w + vl_reapresentacao_w + 													vl_nao_auditado_w + vl_recebido_w) then

		update conta_paciente_retorno
		set 	vl_recebido		= vl_recebido_w,
			vl_nao_auditado 	= vl_nao_auditado_w,
			vl_reapresentacao	= vl_reapresentacao_w,
			vl_glosa_devida		= vl_glosa_devida_w,
			vl_glosa_indevida	= vl_glosa_indevida_w,
			vl_inicial		= vl_inicial_w,
		     	vl_pendente		= vl_pendente_w
		where 	nr_sequencia		= nr_sequencia_w;
/*	else
		insert into baca_auditoria_valores
		values	(nr_sequencia_w,
			nr_interno_conta_w,
			cd_convenio_w,
			vl_inicial_w,
			vl_pendente_w,
			vl_recebido_w,
			vl_reapresentacao_w,
			vl_glosa_indevida_w,
			vl_glosa_devida_w
			);
*/
	end if;
end loop;
close c01;
commit;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE baca_atual_valores_hist_audit () FROM PUBLIC;

