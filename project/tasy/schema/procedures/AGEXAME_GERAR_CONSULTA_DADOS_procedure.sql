-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE agexame_gerar_consulta_dados (cd_estabelecimento_p bigint, nm_usuario_p text, dt_agenda_inicio_p timestamp, dt_agenda_fim_p timestamp) AS $body$
DECLARE

 
cd_agenda_w		bigint;
dt_controle_w		timestamp;
cd_tipo_Agenda_w	bigint;

c01 CURSOR FOR 
	SELECT	b.cd_agenda, 
		b.cd_tipo_agenda 
	from	agenda b 
	where	b.cd_tipo_agenda in (2,1) 
	and	b.ie_situacao = 'A';

BEGIN	
 
delete	FROM w_agenda_exame_relat 
where	nm_usuario	= nm_usuario_p;
 
open C01;
loop 
fetch C01 into	 
	cd_agenda_w, 
	cd_tipo_Agenda_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin	 
	dt_controle_w	:= dt_agenda_inicio_p;
	while dt_controle_w <= dt_agenda_fim_p loop 
		begin 
		if (cd_tipo_Agenda_w	= 2) then 
			CALL Agenda_gerar_consulta_ageexam(cd_estabelecimento_p, 
					   cd_agenda_w, 
					   dt_controle_w, 
					   nm_usuario_p);
		else 
			CALL Agenda_gerar_consulta_agecir(cd_estabelecimento_p, cd_agenda_w, dt_controle_w, nm_usuario_p);
		end if;
        dt_controle_w := dt_controle_w + 1;							
		end;	
	end loop;
	end;
end loop;
close C01;
 
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE agexame_gerar_consulta_dados (cd_estabelecimento_p bigint, nm_usuario_p text, dt_agenda_inicio_p timestamp, dt_agenda_fim_p timestamp) FROM PUBLIC;

