-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE agenda_atual_vig_final_turno ( cd_agenda_p bigint, dt_fim_vigencia_p timestamp, nm_usuario_p text, ie_tipo_agenda_p text, ie_domingo_p text default 'S', ie_segunda_p text default 'S', ie_terca_p text default 'S', ie_quarta_p text default 'S', ie_quinta_p text default 'S', ie_sexta_p text default 'S', ie_sabado_p text default 'S', ie_dias_trab_p text default 'S') AS $body$
DECLARE


ie_domingo_w   varchar(2);
ie_segunda_w   varchar(2);
ie_terca_w     varchar(2);
ie_quarta_w    varchar(2);
ie_quinta_w    varchar(2);
ie_sexta_w     varchar(2);
ie_sabado_w    varchar(2);
ie_dias_trab_w varchar(2);


BEGIN

ie_domingo_w := coalesce(ie_domingo_p, 'S');
ie_segunda_w := coalesce(ie_segunda_p, 'S');
ie_terca_w := coalesce(ie_terca_p, 'S');
ie_quarta_w := coalesce(ie_quarta_p, 'S');
ie_quinta_w := coalesce(ie_quinta_p, 'S');
ie_sexta_w := coalesce(ie_sexta_p, 'S');
ie_sabado_w := coalesce(ie_sabado_p, 'S');
ie_dias_trab_w := coalesce(ie_dias_trab_p, 'S');

/*
ie_tipo_agenda_p
C - Consultas
E - Exames
S - Servicos
*/
if (cd_agenda_p IS NOT NULL AND cd_agenda_p::text <> '') and (dt_fim_vigencia_p IS NOT NULL AND dt_fim_vigencia_p::text <> '') then
	
	if ((ie_tipo_agenda_p = 'C') OR (ie_tipo_agenda_p = 'S')) then
		
		UPDATE 	agenda_turno
		SET    	dt_final_vigencia 	= dt_fim_vigencia_p,
			nm_usuario        	= nm_usuario_p,
			dt_atualizacao    	= clock_timestamp()
		WHERE  	cd_agenda         	= cd_agenda_p
		and ((ie_dia_semana = 1 and ie_domingo_w = 'S') or (ie_dia_semana = 2 and ie_segunda_w = 'S') or (ie_dia_semana = 3 and ie_terca_w = 'S') or (ie_dia_semana = 4 and ie_quarta_w = 'S') or (ie_dia_semana = 5 and ie_quinta_w = 'S') or (ie_dia_semana = 6 and ie_sexta_w = 'S') or (ie_dia_semana = 7 and ie_sabado_w = 'S') or (ie_dia_semana = 9 and ie_dias_trab_w = 'S'));
		
	else
	
		UPDATE 	agenda_horario
		SET    	dt_final_vigencia 	= dt_fim_vigencia_p,
			nm_usuario        	= nm_usuario_p,
			dt_atualizacao    	= clock_timestamp()
		WHERE  	cd_agenda         	= cd_agenda_p;
		
	end if;
	
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE agenda_atual_vig_final_turno ( cd_agenda_p bigint, dt_fim_vigencia_p timestamp, nm_usuario_p text, ie_tipo_agenda_p text, ie_domingo_p text default 'S', ie_segunda_p text default 'S', ie_terca_p text default 'S', ie_quarta_p text default 'S', ie_quinta_p text default 'S', ie_sexta_p text default 'S', ie_sabado_p text default 'S', ie_dias_trab_p text default 'S') FROM PUBLIC;

