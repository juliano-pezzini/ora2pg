-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE cpoe_gerar_plano_protocolo ( nr_atendimento_p atendimento_paciente.nr_atendimento%type, dt_referencia_p timestamp, nr_seq_cpoe_p cpoe_material.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type, ie_tipo_item_p text) AS $body$
DECLARE

  nr_sequencia_w 		cpoe_plan_protocol.nr_sequencia%type;
  nr_seq_mat_cpoe_w		cpoe_plan_protocol.nr_seq_mat_cpoe%type := null;
  nr_seq_diet_cpoe_w	cpoe_plan_protocol.nr_seq_diet_cpoe%type := null;
  nr_seq_dial_cpoe_w	cpoe_plan_protocol.nr_seq_dial_cpoe%type := null;
  nr_seq_exam_cpoe_w	cpoe_plan_protocol.nr_seq_exam_cpoe%type := null;
  nr_seq_rec_cpoe_w		cpoe_plan_protocol.nr_seq_rec_cpoe%type := null;
  nr_seq_gaso_cpoe_w	cpoe_plan_protocol.nr_seq_gaso_cpoe%type := null;
  nr_seq_hemo_cpoe_w	cpoe_plan_protocol.nr_seq_hemo_cpoe%type := null;
  nr_seq_anat_cpoe_w	cpoe_plan_protocol.nr_seq_anat_cpoe%type := null;	

BEGIN
  if ((nr_atendimento_p IS NOT NULL AND nr_atendimento_p::text <> '') and (dt_referencia_p IS NOT NULL AND dt_referencia_p::text <> '') and (nr_seq_cpoe_p IS NOT NULL AND nr_seq_cpoe_p::text <> '') and (ie_tipo_item_p IS NOT NULL AND ie_tipo_item_p::text <> '')) then
    begin
	  if ie_tipo_item_p = 'M' then
	    nr_seq_mat_cpoe_w := nr_seq_cpoe_p;
	  elsif ie_tipo_item_p = 'MA' then
	    nr_seq_mat_cpoe_w := nr_seq_cpoe_p;
	  elsif ie_tipo_item_p = 'N' then
	    nr_seq_diet_cpoe_w := nr_seq_cpoe_p;
	  elsif ie_tipo_item_p = 'P' then
	    nr_seq_exam_cpoe_w := nr_seq_cpoe_p;
	  elsif ie_tipo_item_p = 'G' then
	    nr_seq_gaso_cpoe_w := nr_seq_cpoe_p;
	  elsif ie_tipo_item_p = 'R' then
	    nr_seq_rec_cpoe_w := nr_seq_cpoe_p;
	  elsif ie_tipo_item_p = 'H' then
	    nr_seq_hemo_cpoe_w := nr_seq_cpoe_p;
	  elsif ie_tipo_item_p = 'D' then
	    nr_seq_dial_cpoe_w := nr_seq_cpoe_p;
	  elsif ie_tipo_item_p = 'AP' then
	    nr_seq_anat_cpoe_w := nr_seq_cpoe_p;
  	  end if;

      select nextval('cpoe_plan_protocol_seq')
      into STRICT nr_sequencia_w 
;

      insert
      into cpoe_plan_protocol(
          nr_sequencia,
          nr_atendimento,
          dt_protocol_end,
		  nr_seq_mat_cpoe,
		  nr_seq_diet_cpoe,
		  nr_seq_dial_cpoe,
		  nr_seq_exam_cpoe,
		  nr_seq_rec_cpoe,
		  nr_seq_gaso_cpoe,
		  nr_seq_hemo_cpoe,
		  nr_seq_anat_cpoe,
          nm_usuario,
          dt_atualizacao,
          nm_usuario_nrec,
          dt_atualizacao_nrec
        )
        values (
          nr_sequencia_w,
          nr_atendimento_p,
          dt_referencia_p,
		  nr_seq_mat_cpoe_w,
		  nr_seq_diet_cpoe_w,
		  nr_seq_dial_cpoe_w,
		  nr_seq_exam_cpoe_w,
		  nr_seq_rec_cpoe_w,
		  nr_seq_gaso_cpoe_w,
		  nr_seq_hemo_cpoe_w,
		  nr_seq_anat_cpoe_w,
          nm_usuario_p,
          clock_timestamp(),
          nm_usuario_p,
          clock_timestamp()
        );

      commit;
    exception
      when others then
        CALL gravar_log_tasy(10008, 'cpoe_gerar_plano_protocolo Erro:' || substr(to_char(sqlerrm),1,2000)
          || '//nr_sequencia: ' || nr_sequencia_w 
          || '-nr_atendimento: ' || nr_atendimento_p 
          || '-nm_usuario: ' || nm_usuario_p 
          || '-nr_seq_cpoe: ' || nr_seq_cpoe_p
		  || '-ie_tipo_item: ' || ie_tipo_item_p
		  || '-nr_seq_mat_cpoe_w: ' || coalesce(nr_seq_mat_cpoe_w, 'null')
		  || '-nr_seq_diet_cpoe_w: ' || coalesce(nr_seq_diet_cpoe_w, 'null')
		  || '-nr_seq_dial_cpoe_w: ' || coalesce(nr_seq_dial_cpoe_w, 'null')
		  || '-nr_seq_exam_cpoe_w: ' || coalesce(nr_seq_exam_cpoe_w, 'null')
		  || '-nr_seq_rec_cpoe_w: ' || coalesce(nr_seq_rec_cpoe_w, 'null')
		  || '-nr_seq_gaso_cpoe_w: ' || coalesce(nr_seq_gaso_cpoe_w, 'null')
		  || '-nr_seq_hemo_cpoe_w: ' || coalesce(nr_seq_hemo_cpoe_w, 'null')
          || '-dt_referencia: ' || PKG_DATE_FORMATERS_TZ.TO_VARCHAR(dt_referencia_p,'timestamp', ESTABLISHMENT_TIMEZONE_UTILS.gettimezone)
          || '-dt_atualizacao: ' || PKG_DATE_FORMATERS_TZ.TO_VARCHAR(clock_timestamp(),'timestamp', ESTABLISHMENT_TIMEZONE_UTILS.gettimezone), 
          nm_usuario_p);
    end;
  end if;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cpoe_gerar_plano_protocolo ( nr_atendimento_p atendimento_paciente.nr_atendimento%type, dt_referencia_p timestamp, nr_seq_cpoe_p cpoe_material.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type, ie_tipo_item_p text) FROM PUBLIC;

