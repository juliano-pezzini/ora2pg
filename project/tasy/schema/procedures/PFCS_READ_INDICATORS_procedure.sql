-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pfcs_read_indicators ( nm_user_p text default PFCS_PCK_CONSTANTS.NM_USER_PFCS, cd_establishment_p bigint default null, cd_module_p text default null) AS $body$
DECLARE


cd_module_operating_rooms_w constant varchar(2) := 'OR';
nr_seq_language_w	        usuario.nr_seq_idioma%type;


c01 CURSOR FOR
SELECT e.cd_estabelecimento cd_establishment
from estabelecimento e,
    empresa p
where e.ie_situacao = PFCS_PCK_CONSTANTS.IE_ACTIVE
    and p.ie_situacao = PFCS_PCK_CONSTANTS.IE_ACTIVE
    and e.nm_usuario_nrec = PFCS_PCK_CONSTANTS.NM_USER_PFCS
    and e.cd_empresa = p.cd_empresa
    and e.cd_estabelecimento = coalesce(cd_establishment_p,e.cd_estabelecimento);

BEGIN
    select coalesce(max(obter_nr_seq_idioma(a.nm_usuario)), obter_pais_sistema(null,null,null)) nr_seq_language
    into STRICT nr_seq_language_w
    from usuario a
    where a.nm_usuario = nm_user_p;

    CALL wheb_usuario_pck.set_nr_seq_idioma(nr_seq_language_w);
    CALL philips_param_pck.set_nr_seq_idioma(nr_seq_language_w);

    CALL pfcs_pck_census.check_missing_encounters_ref();
    for c01_w in c01 loop
        if (coalesce(cd_module_p::text, '') = '') then
            if (get_valid_pfcs_function(PFCS_PCK_CONSTANTS.CD_FUNC_ENTERPRISE_DEMAND) = PFCS_PCK_CONSTANTS.IE_YES) then
                CALL PFCS_SIM_FLOW_GROUPING(cd_estabelecimento_p => c01_w.cd_establishment);
                CALL PFCS_PCK_CENSUS.CALC_OCCUPANCY(cd_establishment_p => c01_w.cd_establishment, nm_user_p => nm_user_p);
                CALL PFCS_PCK_BED_REQUESTS.CALC_ADMISSION_ORDERS(cd_establishment_p => c01_w.cd_establishment, nm_user_p => nm_user_p);
                CALL PFCS_PCK_BED_REQUESTS.CALC_EXPECTED_ADMISSIONS(cd_establishment_p => c01_w.cd_establishment, nm_user_p => nm_user_p);
                CALL PFCS_PCK_DISCHARGE_MANAGER.CALC_DISCH_ORDERS_EXPECTED_SUM(cd_establishment_p => c01_w.cd_establishment, nm_user_p => nm_user_p);

                CALL PFCS_EV_CALC_INOUT_24H(cd_establishment_p => c01_w.cd_establishment, nm_user_p => nm_user_p);
                CALL PFCS_PCK_CENSUS.CALC_HIST_OCCUPANCY(cd_establishment_p => c01_w.cd_establishment, nm_user_p => nm_user_p);
            end if;

            if (    get_valid_pfcs_function(PFCS_PCK_CONSTANTS.CD_FUNC_ICU) = PFCS_PCK_CONSTANTS.IE_YES or
                    get_valid_pfcs_function(PFCS_PCK_CONSTANTS.CD_FUNC_ACU) = PFCS_PCK_CONSTANTS.IE_YES or
                    get_valid_pfcs_function(PFCS_PCK_CONSTANTS.CD_FUNC_TCU) = PFCS_PCK_CONSTANTS.IE_YES or
					get_valid_pfcs_function(PFCS_PCK_CONSTANTS.CD_FUNC_HAH) = PFCS_PCK_CONSTANTS.IE_YES		) then
                CALL PFCS_PCK_BED_REQUESTS.CALC_TRANSFER_ORDERS(cd_establishment_p => c01_w.cd_establishment, nm_user_p => nm_user_p);
            end if;

            -- Admission Prioritizer
            if (get_valid_pfcs_function(438) = 'Y') then
                CALL PFCS_PA_CALC_OCCUPANCY_CENSUS(c01_w.cd_establishment, nm_user_p);
                CALL PFCS_PA_INPATIENT_ORDERS(c01_w.cd_establishment, nm_user_p);
                CALL PFCS_PA_CALC_POTENTIAL_ADMITS(c01_w.cd_establishment, nm_user_p);
                CALL PFCS_PA_CALC_BOARDERS(c01_w.cd_establishment, nm_user_p);
                CALL PFCS_PA_CALC_OBSERV_HOLD(c01_w.cd_establishment, nm_user_p);
                CALL PFCS_PA_DIRECT_ADMITS(c01_w.cd_establishment, nm_user_p);
                CALL PFCS_PA_TRANSFERS(c01_w.cd_establishment, nm_user_p);
                CALL PFCS_PA_TOTAL_AVAIL_BED(c01_w.cd_establishment, nm_user_p);
                CALL PFCS_PA_ADMITS_DISCHARGE(c01_w.cd_establishment, nm_user_p);
                CALL PFCS_PA_DISCHARGES(c01_w.cd_establishment, nm_user_p);
                CALL PFCS_PA_AVG_DISPOSITION(c01_w.cd_establishment, nm_user_p);
                CALL PFCS_PA_HIST_OCCUPANCY(155, c01_w.cd_establishment, nm_user_p);
                CALL PFCS_PA_ADMITS_TO_OR(c01_w.cd_establishment, nm_user_p);
            end if;

            -- Telemetry
            if (get_valid_pfcs_function(439) = 'Y') then
                CALL pfcs_tele_requests(40, c01_w.cd_establishment,nm_user_p);
                CALL pfcs_tele_monitors(46, c01_w.cd_establishment,nm_user_p);
                CALL pfcs_db_tl_bat_low_n_emp_stat(49, c01_w.cd_establishment,nm_user_p);
                CALL pfcs_tele_discontinue_orders(50, c01_w.cd_establishment,nm_user_p);
                CALL pfcs_mpl_lhs_avg_time_tl(128, c01_w.cd_establishment,nm_user_p);
                CALL pfcs_db_tl_req_by_unit_cenus(129, c01_w.cd_establishment,nm_user_p);
                CALL pfcs_mod_tl_occupancy_cnt(104, c01_w.cd_establishment,nm_user_p);
            end if;

            -- Discharge Manager
            if (get_valid_pfcs_function(455) = 'Y') then
                CALL PFCS_PCK_DISCHARGE_MANAGER.CALC_TOTAL_DISCHARGES_TODAY(cd_establishment_p => c01_w.cd_establishment, nm_user_p => nm_user_p);
                CALL PFCS_PCK_DISCHARGE_MANAGER.CALC_BIG_NUMBERS(cd_establishment_p => c01_w.cd_establishment, nm_user_p => nm_user_p);
                CALL PFCS_PCK_DISCHARGE_MANAGER.CALC_CARE_STATUS_DELAYS(cd_establishment_p => c01_w.cd_establishment, nm_user_p => nm_user_p);
                CALL PFCS_PCK_DISCHARGE_MANAGER.CALC_DELAYS_TABLECHART(cd_establishment_p => c01_w.cd_establishment, nm_user_p => nm_user_p);
            end if;

			-- Emergency Department (ED)
			if (get_valid_pfcs_function(464) = 'Y') then
				CALL PFCS_PCK_EMERGENCY_DEPARTMENT.CURRENT_ENCOUNTERS(cd_establishment_p => c01_w.cd_establishment, nm_user_p => nm_user_p);
				CALL PFCS_PCK_EMERGENCY_DEPARTMENT.PAST_ENCOUNTERS(cd_establishment_p => c01_w.cd_establishment, nm_user_p => nm_user_p);
				CALL PFCS_PCK_EMERGENCY_DEPARTMENT.WAITING_ROOM(cd_establishment_p => c01_w.cd_establishment, nm_user_p => nm_user_p);
				CALL PFCS_PCK_EMERGENCY_DEPARTMENT.CALC_ENCOUNTERS_HISTOGRAM(cd_establishment_p => c01_w.cd_establishment, nm_user_p => nm_user_p);
            end if;

        end if;

        if (cd_module_p = cd_module_operating_rooms_w) then
            CALL PFCS_PCK_OPERATING_ROOMS.READ_INDICATORS(cd_establishment_p => c01_w.cd_establishment, nm_user_p => nm_user_p);
        end if;

        CALL pfcs_pck_census.calc_module_overview_data(cd_establishment_p => c01_w.cd_establishment, nm_user_p => nm_user_p);
    end loop;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pfcs_read_indicators ( nm_user_p text default PFCS_PCK_CONSTANTS.NM_USER_PFCS, cd_establishment_p bigint default null, cd_module_p text default null) FROM PUBLIC;

