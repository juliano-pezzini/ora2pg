-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE cpoe_gerar_grid_rec (( nr_atendimento_p bigint, nr_seq_recomendacao_p bigint, nm_usuario_p text) is type cursor01 REFCURSOR) RETURNS timestamp AS $body$
DECLARE

	dt_aux_w	timestamp;
	
BEGIN
 dt_aux_w:= dt_inicio_w;
	while(dt_aux_w	<= dt_fim_w) loop 
		begin 
 
		if (to_char(dt_aux_w,'hh24') = nr_hora_w) then 
			return dt_aux_w;
		end if;
		dt_aux_w	:= dt_aux_w +1/24;
		end;
	end loop;
 
 
	return null;
 
	end;
 
begin 
 
dt_inicio_w	:= trunc(clock_timestamp(),'hh24') - (1/24 * 6);
dt_fim_w	:= trunc(clock_timestamp(),'hh24') + ((1/24 * 18) - 1/86400);
 
if (nr_seq_recomendacao_p IS NOT NULL AND nr_seq_recomendacao_p::text <> '') and (nr_seq_recomendacao_p	> 0) then 
	sql_base_w:= sql_base_w||' and c.nr_seq_rec_cpoe = :nr_seq_rec_cpoe '||enter_w;
end if;
 
sql_base_w:= sql_base_w||' order by c.nr_seq_rec_cpoe, b.dt_horario, a.nr_prescricao asc';
 
if (nr_seq_recomendacao_p IS NOT NULL AND nr_seq_recomendacao_p::text <> '') and (nr_seq_recomendacao_p	> 0) then 
 
  open c01 for EXECUTE sql_base_w 
  using 	nr_atendimento_p, 
   		dt_inicio_w, 
   		dt_fim_w, 
			nr_seq_recomendacao_p;
else 
	open c01 for EXECUTE sql_base_w 
  using 	nr_atendimento_p, 
   		dt_inicio_w, 
   		dt_fim_w;
end if;
 
fetch c01 
bulk collect 
into recomendacao_record_w;
close c01;
 
for i in 1..recomendacao_record_w.count loop 
	begin 
 
	if (nr_seq_rec_cpoe_ant_w	<> recomendacao_record_w[i].nr_seq_rec_cpoe) then 
		begin 
		nr_seq_rec_cpoe_ant_w	:= recomendacao_record_w[i].nr_seq_rec_cpoe;
		ind_w	:= ind_w +1;
		nr_seq_rec_cpoe_w(ind_w)	:= nr_seq_rec_cpoe_ant_w;
 
		ds_hora_00_w(ind_w)			:= null;
		ds_hora_01_w(ind_w)			:= null;
		ds_hora_02_w(ind_w)			:= null;
		ds_hora_03_w(ind_w)			:= null;
		ds_hora_04_w(ind_w)			:= null;
		ds_hora_05_w(ind_w)			:= null;
		ds_hora_06_w(ind_w)			:= null;
		ds_hora_07_w(ind_w)			:= null;
		ds_hora_08_w(ind_w)			:= null;
		ds_hora_09_w(ind_w)			:= null;
		ds_hora_10_w(ind_w)			:= null;
		ds_hora_11_w(ind_w)			:= null;
		ds_hora_12_w(ind_w)			:= null;
		ds_hora_13_w(ind_w)			:= null;
		ds_hora_14_w(ind_w)			:= null;
		ds_hora_15_w(ind_w)			:= null;
		ds_hora_16_w(ind_w)			:= null;
		ds_hora_17_w(ind_w)			:= null;
		ds_hora_18_w(ind_w)			:= null;
		ds_hora_19_w(ind_w)			:= null;
		ds_hora_20_w(ind_w)			:= null;
		ds_hora_21_w(ind_w)			:= null;
		ds_hora_22_w(ind_w)			:= null;
		ds_hora_23_w(ind_w)			:= null;
		end;
	end if;
 
	nr_hora_w	:= to_char(recomendacao_record_w[i].dt_horario,'hh24');
	ds_hora_w	:= 'P';
	if (recomendacao_record_w[i](.dt_fim_horario IS NOT NULL AND .dt_fim_horario::text <> '')) then 
		ds_hora_w	:= 'S';
	end if;
	if (recomendacao_record_w[i](.dt_suspensao IS NOT NULL AND .dt_suspensao::text <> '')) then 
		ds_hora_w	:= 'N';
	end if;
 
	CASE nr_hora_w 
   when 0 then ds_hora_00_w(ind_w)			:= ds_hora_w;
   when 1 then ds_hora_01_w(ind_w)			:= ds_hora_w;
   when 2 then ds_hora_02_w(ind_w)			:= ds_hora_w;
   when 3 then ds_hora_03_w(ind_w)			:= ds_hora_w;
   when 4 then ds_hora_04_w(ind_w)			:= ds_hora_w;
	 when 5 then ds_hora_05_w(ind_w)			:= ds_hora_w;
	 when 6 then ds_hora_06_w(ind_w)			:= ds_hora_w;
	 when 7 then ds_hora_07_w(ind_w)			:= ds_hora_w;
	 when 8 then ds_hora_08_w(ind_w)			:= ds_hora_w;
	 when 9 then ds_hora_09_w(ind_w)			:= ds_hora_w;
	 when 10 then ds_hora_10_w(ind_w)			:= ds_hora_w;
	 when 11 then ds_hora_11_w(ind_w)			:= ds_hora_w;
	 when 12 then ds_hora_12_w(ind_w)			:= ds_hora_w;
	 when 13 then ds_hora_13_w(ind_w)			:= ds_hora_w;
	 when 14 then ds_hora_14_w(ind_w)			:= ds_hora_w;
	 when 15 then ds_hora_15_w(ind_w)			:= ds_hora_w;
	 when 16 then ds_hora_16_w(ind_w)			:= ds_hora_w;
	 when 17 then ds_hora_17_w(ind_w)			:= ds_hora_w;
	 when 18 then ds_hora_18_w(ind_w)			:= ds_hora_w;
	 when 19 then ds_hora_19_w(ind_w)			:= ds_hora_w;
	 when 20 then ds_hora_20_w(ind_w)			:= ds_hora_w;
	 when 21 then ds_hora_21_w(ind_w)			:= ds_hora_w;
	 when 22 then ds_hora_22_w(ind_w)			:= ds_hora_w;
	 when 23 then ds_hora_23_w(ind_w)			:= ds_hora_w;
	END CASE;
	end;
end loop;
 
 
 
for i in 1..nr_seq_rec_cpoe_w.count loop 
	begin 
	nr_seq_rec_cpoe_ant_w	:= 	nr_seq_rec_cpoe_w(i);
 
	select	max(dt_fim), 
			max(CASE WHEN coalesce(HR_PRIM_HORARIO::text, '') = '' THEN dt_inicio  ELSE to_date(to_char(dt_inicio,'dd/mm/yyyy')|| ' '||hr_prim_horario,'dd/mm/yyyy hh24:mi') END ) 
	into STRICT	dt_horario_fim_w, 
			dt_horario_inicio_w 
	from	cpoe_recomendacao 
	where	nr_sequencia = nr_seq_rec_cpoe_ant_w;
 
	if (dt_horario_fim_w IS NOT NULL AND dt_horario_fim_w::text <> '') or (dt_horario_inicio_w IS NOT NULL AND dt_horario_inicio_w::text <> '') then 
 
		for x in 0..23 loop 
			begin 
			ind_w	:= x;
			dt_auxiliar_w	:= getDataHora(ind_w);
 
			if 	((dt_auxiliar_w	>dt_horario_fim_w) or (fim_hora(dt_auxiliar_w) 	< dt_horario_inicio_w)) then 
				nr_hora_w	:= ind_w;
				ds_hora_w	:= 'FV';
				case nr_hora_w 
       		when 0 then ds_hora_00_w(i)			:= ds_hora_w;
       		when 1 then ds_hora_01_w(i)			:= ds_hora_w;
       		when 2 then ds_hora_02_w(i)			:= ds_hora_w;
       		when 3 then ds_hora_03_w(i)			:= ds_hora_w;
       		when 4 then ds_hora_04_w(i)			:= ds_hora_w;
       		when 5 then ds_hora_05_w(i)			:= ds_hora_w;
       		when 6 then ds_hora_06_w(i)			:= ds_hora_w;
       		when 7 then ds_hora_07_w(i)			:= ds_hora_w;
       		when 8 then ds_hora_08_w(i)			:= ds_hora_w;
       		when 9 then ds_hora_09_w(i)			:= ds_hora_w;
       		when 10 then ds_hora_10_w(i)		:= ds_hora_w;
       		when 11 then ds_hora_11_w(i)		:= ds_hora_w;
       		when 12 then ds_hora_12_w(i)		:= ds_hora_w;
       		when 13 then ds_hora_13_w(i)		:= ds_hora_w;
       		when 14 then ds_hora_14_w(i)		:= ds_hora_w;
       		when 15 then ds_hora_15_w(i)		:= ds_hora_w;
       		when 16 then ds_hora_16_w(i)		:= ds_hora_w;
       		when 17 then ds_hora_17_w(i)		:= ds_hora_w;
       		when 18 then ds_hora_18_w(i)		:= ds_hora_w;
       		when 19 then ds_hora_19_w(i)		:= ds_hora_w;
       		when 20 then ds_hora_20_w(i)		:= ds_hora_w;
       		when 21 then ds_hora_21_w(i)		:= ds_hora_w;
       		when 22 then ds_hora_22_w(i)		:= ds_hora_w;
       		when 23 then ds_hora_23_w(i)		:= ds_hora_w;
 
        end case;
				end if;
 
			end;
		end loop;
 
	end if;
 
	end;
end loop;
 
 
forall i in nr_seq_rec_cpoe_w.first .. nr_seq_rec_cpoe_w.last 
	update	cpoe_recomendacao 
	set		ds_hora_00	= ds_hora_00_w(i), 
			ds_hora_01	= ds_hora_01_w(i), 
			ds_hora_02	= ds_hora_02_w(i), 
			ds_hora_03	= ds_hora_03_w(i), 
			ds_hora_04	= ds_hora_04_w(i), 
			ds_hora_05	= ds_hora_05_w(i), 
			ds_hora_06	= ds_hora_06_w(i), 
			ds_hora_07	= ds_hora_07_w(i), 
			ds_hora_08	= ds_hora_08_w(i), 
			ds_hora_09	= ds_hora_09_w(i), 
			ds_hora_10	= ds_hora_10_w(i), 
			ds_hora_11	= ds_hora_11_w(i), 
			ds_hora_12	= ds_hora_12_w(i), 
			ds_hora_13	= ds_hora_13_w(i), 
			ds_hora_14	= ds_hora_14_w(i), 
			ds_hora_15	= ds_hora_15_w(i), 
			ds_hora_16	= ds_hora_16_w(i), 
			ds_hora_17	= ds_hora_17_w(i), 
			ds_hora_18	= ds_hora_18_w(i), 
			ds_hora_19	= ds_hora_19_w(i), 
			ds_hora_20	= ds_hora_20_w(i), 
			ds_hora_21	= ds_hora_21_w(i), 
			ds_hora_22	= ds_hora_22_w(i), 
			ds_hora_23	= ds_hora_23_w(i) 
	where	nr_sequencia = 	nr_seq_rec_cpoe_w(i);
 
 
 
commit;
 
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cpoe_gerar_grid_rec (( nr_atendimento_p bigint, nr_seq_recomendacao_p bigint, nm_usuario_p text) is type cursor01 REFCURSOR) FROM PUBLIC;

