-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE cpoe_gerar_exame_lab_dep ( nr_sequencia_p cpoe_procedimento.nr_sequencia%type, nr_atendimento_p atendimento_paciente.nr_atendimento%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, cd_setor_atendimento_p setor_atendimento.cd_setor_atendimento%type, ds_opcao_p text, nm_usuario_p usuario.nm_usuario%type, nr_seq_exame_dep_p exame_lab_dependente.nr_seq_exame_dep%type, ds_itens_p text ) AS $body$
DECLARE


    cd_convenio_w				atend_categoria_convenio.cd_convenio%type;
    cd_plano_convenio_w			atend_categoria_convenio.cd_plano_convenio%type;
    cd_categoria_w				atend_categoria_convenio.cd_categoria%type;
    ie_tipo_atendimento_w 		atendimento_Paciente.ie_tipo_atendimento%type;
	dt_vigencia_w				timestamp;
	ie_tipo_convenio_w			convenio.ie_tipo_convenio%type;
    cd_edicao_amb_w				convenio_amb.cd_edicao_amb%type;
	ie_origem_proced_sus_w		exame_laboratorio.ie_origem_proced%type;
	ie_origem_proced_cursor_w	exame_laboratorio.ie_origem_proced%type;
	cd_setor_atendimento_w		setor_atendimento.cd_setor_atendimento%type;
    nr_seq_proc_interno_w		exame_laboratorio.nr_seq_proc_interno%type;
    qt_proced_w					cpoe_procedimento.qt_procedimento%type;
	ds_horarios_w				cpoe_procedimento.ds_horarios%type;
	ds_observacao_w				cpoe_procedimento.ds_observacao%type;
	cd_intervalo_w				cpoe_procedimento.cd_intervalo%type;
	ie_urgencia_w				cpoe_procedimento.ie_urgencia%type;
	dt_prev_execucao_w			cpoe_procedimento.dt_prev_execucao%type;
	ds_dado_clinico_w			cpoe_procedimento.ds_dado_clinico%type;
    cd_material_original_w		cpoe_procedimento.cd_material_exame%type;
    ds_material_especial_w		cpoe_procedimento.ds_material_especial%type;
	cd_medico_prescr_w        	pessoa_fisica.cd_pessoa_fisica%type;
	nr_seq_rotina_w				cpoe_procedimento.nr_seq_rotina%type;
	ie_se_necessario_w			cpoe_procedimento.ie_se_necessario%type;
	ie_acm_w					cpoe_procedimento.ie_acm%type;
	nr_ocorrencia_w				cpoe_procedimento.nr_ocorrencia%type;
	ie_lado_w					cpoe_procedimento.ie_lado%type;
	ds_justificativa_w			cpoe_procedimento.ds_justificativa%type;
	ie_duracao_w				cpoe_procedimento.ie_duracao%type;
	dt_inicio_w					cpoe_procedimento.dt_inicio%type;
	hr_prim_horario_w			cpoe_procedimento.hr_prim_horario%type;
	cd_perfil_ativo_w			cpoe_procedimento.cd_perfil_ativo%type;
	cd_pessoa_fisica_w			cpoe_procedimento.cd_pessoa_fisica%type;
	nr_seq_contraste_w			cpoe_procedimento.nr_seq_contraste%type;
	nm_usuario_nrec_w			cpoe_procedimento.nm_usuario_nrec%type;
	dt_atualizacao_nrec_w		cpoe_procedimento.dt_atualizacao_nrec%type;
	ie_cobra_paciente_w			cpoe_procedimento.ie_cobra_paciente%type;
	ie_futuro_w					cpoe_procedimento.ie_futuro%type;
	ie_nivel_atencao_w			cpoe_procedimento.ie_nivel_atencao%type;
	ie_oncologia_w				cpoe_procedimento.ie_oncologia%type;
	ie_item_alta_w				cpoe_procedimento.ie_item_alta%type;
	ie_retrogrado_w				cpoe_procedimento.ie_retrogrado%type;
	dt_fim_w					cpoe_procedimento.dt_fim%type;
	ie_administracao_w			cpoe_procedimento.ie_administracao%type;
	ie_evento_unico_w			cpoe_procedimento.ie_evento_unico%type;
    cd_funcao_origem_w			cpoe_procedimento.cd_funcao_origem%type;
	ie_anestesia_w				cpoe_procedimento.ie_anestesia%type;
	nr_seq_classificacao_w		atendimento_paciente.nr_seq_classificacao%type;

    nr_seq_material_prescr_w	material_exame_lab.nr_sequencia%type;

	nr_seq_exame_w				exame_lab_dependente.nr_seq_exame_dep%type;
	cd_procedimento_w			exame_laboratorio.cd_procedimento%type;
	ie_origem_proced_w			exame_laboratorio.ie_origem_proced%type;
	nr_seq_material_w			exame_lab_dependente.nr_seq_material%type;
	nr_seq_exame_princ_w		exame_lab_dependente.nr_seq_exame%type;
	ie_material_exame_princ_w 	exame_lab_dependente.ie_material_exame_princ%type;
	nr_seq_proc_interno_dep_w 	exame_laboratorio.nr_seq_proc_interno%type;

	cd_cgc_laboratorio_depend_w	prescr_procedimento.cd_cgc_laboratorio%type;
	cd_material_exame_w			material_exame_lab.cd_material_exame%type;

	qt_exame_prescr_w			integer;
	qt_tot_exame_prescr_w		integer;
    qt_exame_dep_w				integer;
	contador_w					integer;

	ie_restringe_dep_w			exame_lab_dependente.ie_restringe_dep%type;
	ds_erro_w					varchar(2000);
	nr_seq_cpoe_order_unit_w		cpoe_procedimento.nr_seq_cpoe_order_unit%type;
	
	cProcedimentos CURSOR FOR
		SELECT 	a.nr_seq_proc_interno,
				a.qt_procedimento,
				a.ds_horarios,
				a.ds_observacao,
				a.cd_intervalo,
				a.ie_urgencia,
				a.cd_setor_atendimento,
				a.ds_dado_clinico,
				a.dt_prev_execucao,
				a.cd_material_exame,
				a.ds_material_especial,
				a.cd_medico,
				a.nr_seq_rotina,
				a.ie_se_necessario,
				a.ie_acm,
				a.nr_ocorrencia,
				a.ie_lado,
				a.ds_justificativa,
				a.ie_duracao,
				a.dt_inicio,
				a.hr_prim_horario,
				a.cd_perfil_ativo,
				a.cd_pessoa_fisica,
				a.nr_seq_contraste,
				a.nm_usuario_nrec,
				a.dt_atualizacao_nrec,
				a.ie_cobra_paciente,
				a.ie_futuro,
				a.ie_nivel_atencao,
				a.ie_oncologia,
				a.ie_item_alta,
				a.ie_retrogrado,
				a.dt_fim,
				a.ie_administracao,
				a.ie_evento_unico,
				a.cd_funcao_origem,
				a.ie_anestesia,
				c.nr_seq_classificacao,
				a.nr_seq_cpoe_order_unit
		  from	cpoe_procedimento a,
				atendimento_paciente c
		 where 	a.nr_atendimento = c.nr_atendimento
		   and 	a.nr_sequencia = nr_sequencia_p;

	cItems CURSOR FOR
		SELECT	distinct
				a.nr_seq_exame_dep,
				coalesce(b.cd_procedimento, c.cd_procedimento) cd_procedimento,
				a.nr_seq_material,
				a.nr_seq_exame,
				a.ie_material_exame_princ,
				coalesce(a.cd_setor_atendimento, cd_setor_atendimento_w) cd_setor_atendimento,
				coalesce(a.cd_convenio, cd_convenio_w) cd_convenio,
				c.nr_seq_proc_interno
		  FROM table(lista_pck.obter_lista(ds_opcao_p)) d, exame_laboratorio c, exame_lab_dependente a
LEFT OUTER JOIN exame_lab_convenio b ON (a.nr_seq_exame_dep = b.nr_seq_exame AND ie_origem_proced_w = b.ie_origem_proced)
WHERE d.nr_registro = a.ie_geracao  and a.nr_seq_exame_dep = c.nr_seq_exame  and a.nr_seq_exame = nr_seq_exame_w and ((a.ie_geracao = 10) or ((a.ie_geracao in (7,9)) and exists (SELECT 1
																			   from table(lista_pck.obter_lista(coalesce(ds_itens_p, ','))) z
																			  where z.nr_registro = a.nr_sequencia))) and ((c.nr_seq_proc_interno IS NOT NULL AND c.nr_seq_proc_interno::text <> '') or exists (select 1
																  from proc_interno x
																 where x.nr_seq_exame_lab = c.nr_seq_exame)) and coalesce(a.cd_convenio, cd_convenio_w) = cd_convenio_w and coalesce(a.cd_setor_atendimento, cd_setor_atendimento_p) = cd_setor_atendimento_p  and (((a.nr_seq_exame_dep = c.nr_seq_exame) and (coalesce(nr_seq_exame_dep_p::text, '') = '')) or
				 ((nr_seq_exame_dep_p IS NOT NULL AND nr_seq_exame_dep_p::text <> '') and (a.nr_seq_exame_dep = nr_seq_exame_dep_p) and (a.nr_seq_exame_dep = c.nr_seq_exame))) and coalesce(a.cd_estabelecimento, cd_estabelecimento_p) = cd_estabelecimento_p and coalesce(a.cd_setor_prescricao, cd_setor_atendimento_p) = cd_setor_atendimento_p and coalesce(a.nr_seq_material_regra, nr_seq_material_prescr_w) = nr_seq_material_prescr_w    and coalesce(c.ie_situacao, 'A') = 'A'   and ((((ie_origem_proced_sus_w not in (2, 3)) or (b.ie_origem_proced = ie_origem_proced_sus_w)) and (coalesce(b.ie_origem_proced_regra::text, '') = '')) or 
				 (b.ie_origem_proced_regra IS NOT NULL AND b.ie_origem_proced_regra::text <> '' AND b.ie_origem_proced_regra = ie_origem_proced_cursor_w))     order by coalesce(a.cd_convenio, cd_convenio_w),
				  coalesce(a.cd_setor_atendimento, cd_setor_atendimento_w), 
				  a.nr_seq_exame_dep;

	procedure add_item_dependente is
;
BEGIN
		cd_cgc_laboratorio_depend_w := null;
		cd_material_exame_w := null;

		if (coalesce(nr_seq_material_w::text, '') = '') then
			if (coalesce(ie_material_exame_princ_w, 'N') = 'S') then
				begin
					select	b.cd_material_exame
					  into STRICT	cd_material_exame_w
					  from	material_exame_lab b,
							exame_lab_material a
					 where	a.nr_seq_material	= b.nr_sequencia
					   and	a.nr_seq_exame		= nr_seq_exame_princ_w
					   and	b.cd_material_exame	= cd_material_original_w
					   and	a.ie_situacao 		= 'A';
				exception
					when no_data_found then
						select	coalesce(max(cd_material_exame), '')
						  into STRICT	cd_material_exame_w
						  from (SELECT	b.cd_material_exame
								   from	material_exame_lab b,
										exame_lab_material a
								  where	a.nr_seq_material = b.nr_sequencia
									and	a.nr_seq_exame    = nr_seq_exame_princ_w
									and	a.ie_situacao     = 'A'
								  order by a.ie_prioridade) alias2 LIMIT 1;

						if (cd_material_exame_w = '') then
							CALL wheb_mensagem_pck.exibir_mensagem_abort(195427, 'NR_SEQ_EXAME=' || nr_seq_exame_w);
						end if;
				end;
				
				/*-- Se o material do exame princial esta entre os materiais do exame dependente, entao lanca o material do exame dependente. */

				select	max(b.cd_material_exame)
				  into STRICT	cd_material_exame_w
				  from	material_exame_lab b,
						exame_lab_material a
				 where	a.nr_seq_material	= b.nr_sequencia
				   and	a.nr_seq_exame		= nr_seq_exame_w
				   and	b.cd_material_exame	= cd_material_exame_w
				   and	a.ie_situacao 		= 'A';
				
			else
				begin
					select	b.cd_material_exame
					  into STRICT	cd_material_exame_w
					  from	material_exame_lab b,
							exame_lab_material a
					 where 	a.nr_seq_material	= b.nr_sequencia
					   and 	a.nr_seq_exame		= nr_seq_exame_w
					   and 	b.cd_material_exame	= cd_material_original_w
					   and 	a.ie_situacao 		= 'A';
				exception
					when no_data_found then
						select	coalesce(max(cd_material_exame), '')
						  into STRICT	cd_material_exame_w
						  from (SELECT	b.cd_material_exame
								   from	material_exame_lab b,
										exame_lab_material a
								  where	a.nr_seq_material	= b.nr_sequencia
									and a.nr_seq_exame		= nr_seq_exame_w
									and a.ie_situacao		= 'A'
								  order by a.ie_prioridade) alias2 LIMIT 1;

						if (cd_material_exame_w = '') then
							CALL wheb_mensagem_pck.exibir_mensagem_abort(195427, 'NR_SEQ_EXAME=' || nr_seq_exame_w);
						end if;
				end;
			end if;
		else
			select	cd_material_exame
			  into STRICT	cd_material_exame_w
			  from	material_exame_lab
			 where	nr_sequencia = nr_seq_material_w;
		end if;
		
		begin
			if (cd_material_exame_w IS NOT NULL AND cd_material_exame_w::text <> '') then
				if (nr_seq_material_w IS NOT NULL AND nr_seq_material_w::text <> '') then
					select 	coalesce(sum(qt_procedimento),0)
					  into STRICT	qt_exame_prescr_w
					  from 	material_exame_lab y,
							cpoe_procedimento x 
					 where 	x.nr_atendimento	= nr_atendimento_p
					   and 	coalesce(x.dt_liberacao::text, '') = ''
					   and	coalesce(x.dt_liberacao_enf::text, '') = ''
					   and 	x.dt_atualizacao_nrec > clock_timestamp() - interval '5' day
					   and 	x.nr_seq_proc_interno = nr_seq_proc_interno_dep_w
					   and 	x.cd_material_exame	= y.cd_material_exame
					   and	x.cd_material_exame	= cd_material_exame_w
					   and 	y.nr_sequencia		= nr_seq_material_w;
				else
					select 	coalesce(sum(qt_procedimento),0)
					  into STRICT	qt_exame_prescr_w
					  from 	material_exame_lab y, 
							cpoe_procedimento x 
					 where 	x.nr_atendimento	= nr_atendimento_p
					   and 	coalesce(x.dt_liberacao::text, '') = ''
					   and	coalesce(x.dt_liberacao_enf::text, '') = ''
					   and 	x.dt_atualizacao_nrec > clock_timestamp() - interval '5' day
					   and 	x.nr_seq_proc_interno = nr_seq_proc_interno_dep_w
					   and 	x.cd_material_exame	= y.cd_material_exame
					   and	x.cd_material_exame	= cd_material_exame_w;
				end if;
			else
				qt_exame_prescr_w := 0;
			end if;
		exception
		when others then
			qt_exame_prescr_w := 0;
		end;
		
		qt_tot_exame_prescr_w := 0;
		begin
			if (cd_material_exame_w IS NOT NULL AND cd_material_exame_w::text <> '') then
				if (nr_seq_material_w IS NOT NULL AND nr_seq_material_w::text <> '') then
					select 	count(*)
					  into STRICT	qt_tot_exame_prescr_w
					  from 	material_exame_lab y,
							cpoe_procedimento x
					 where 	x.nr_atendimento	= nr_atendimento_p
					   and 	coalesce(x.dt_liberacao::text, '') = ''
					   and	coalesce(x.dt_liberacao_enf::text, '') = ''
					   and 	x.dt_atualizacao_nrec > clock_timestamp() - interval '5' day
					   and 	x.nr_seq_proc_interno = nr_seq_proc_interno_dep_w
					   and 	x.cd_material_exame	= y.cd_material_exame
					   and	x.cd_material_exame	= cd_material_exame_w
					   and 	y.nr_sequencia		= nr_seq_material_w;
				else
					select 	count(*)
					  into STRICT	qt_tot_exame_prescr_w
					  from 	material_exame_lab y,
							cpoe_procedimento x 
					 where 	x.nr_atendimento	= nr_atendimento_p
					   and 	coalesce(x.dt_liberacao::text, '') = ''
					   and	coalesce(x.dt_liberacao_enf::text, '') = ''
					   and 	x.dt_atualizacao_nrec > clock_timestamp() - interval '5' day
					   and 	x.nr_seq_proc_interno = nr_seq_proc_interno_dep_w
					   and 	x.cd_material_exame	= y.cd_material_exame
					   and	x.cd_material_exame	= cd_material_exame_w;	
				end if;
			end if;
			
		exception
		when others then	
			qt_exame_prescr_w := 0;
		end;

		if (qt_proced_w > qt_exame_prescr_w) then
			
			if (qt_exame_dep_w > qt_tot_exame_prescr_w) then
				qt_exame_prescr_w := 0;
			end if;

			contador_w := 0;
			select	coalesce(max(ie_restringe_dep), 'N')
			  into STRICT	ie_restringe_dep_w
			  from	exame_lab_dependente
			 where	nr_seq_exame_dep = nr_seq_exame_w
			   and	nr_seq_exame = nr_seq_exame_princ_w
			   and	coalesce(cd_convenio, cd_convenio_w) = cd_convenio_w
			   and 	ie_geracao = 0;

			if (ie_restringe_dep_w = 'S') then
				select 	count(*)
				  into STRICT	contador_w
				  from	cpoe_procedimento a
				 where 	a.nr_atendimento = nr_atendimento_p
				   and	a.nr_seq_proc_interno = nr_seq_proc_interno_dep_w
				   and 	coalesce(a.dt_liberacao::text, '') = ''
				   and	coalesce(a.dt_liberacao_enf::text, '') = ''
				   and 	a.dt_atualizacao_nrec > clock_timestamp() - interval '5' day;
			end if;

			begin
				if (contador_w = 0) then
					insert
					  into cpoe_procedimento(	nr_sequencia,
												nr_seq_proc_princ,
												nr_seq_proc_interno,
												qt_procedimento,
												dt_atualizacao,
												nm_usuario,
												dt_prev_execucao,
												ie_se_necessario,
												ie_acm,
												nr_ocorrencia,
												cd_medico,
												ie_lado,
												ds_observacao,
												ds_justificativa,
												ie_duracao,
												ds_horarios,
												nr_atendimento,
												dt_inicio,
												hr_prim_horario,
												cd_perfil_ativo,
												cd_pessoa_fisica,
												ds_dado_clinico,
												nr_seq_contraste,
												cd_intervalo,
												ie_urgencia,
												nm_usuario_nrec,
												dt_atualizacao_nrec,
												ie_anestesia,
												cd_material_exame,
												cd_setor_atendimento,
												ie_cobra_paciente,
												ie_futuro,
												ie_nivel_atencao,
												ie_oncologia,
												ie_item_alta,
												cd_funcao_origem,
												ie_retrogrado,
												dt_fim,
												ie_administracao,
												ie_evento_unico,
												nr_seq_cpoe_order_unit
											 )
					values (	nextval('cpoe_procedimento_seq'),
								nr_sequencia_p,
								nr_seq_proc_interno_dep_w,
								qt_proced_w - qt_exame_prescr_w, ---nvl(qt_proced_dependente_p, qt_proced_w - qt_exame_prescr_w),
								clock_timestamp(),
								nm_usuario_p,
								dt_prev_execucao_w,
								ie_se_necessario_w,
								ie_acm_w,
								nr_ocorrencia_w,
								cd_medico_prescr_w,
								ie_lado_w,
								ds_observacao_w,
								ds_justificativa_w,
								ie_duracao_w,
								ds_horarios_w,
								nr_atendimento_p,
								dt_inicio_w,
								hr_prim_horario_w,
								cd_perfil_ativo_w,
								cd_pessoa_fisica_w,
								ds_dado_clinico_w,
								nr_seq_contraste_w,
								cd_intervalo_w,
								ie_urgencia_w,
								nm_usuario_nrec_w,
								dt_atualizacao_nrec_w,
								ie_anestesia_w,
								coalesce(cd_material_exame_w, cd_material_original_w),
								cd_setor_atendimento_w,
								ie_cobra_paciente_w,
								ie_futuro_w,
								ie_nivel_atencao_w,
								ie_oncologia_w,
								ie_item_alta_w,
								cd_funcao_origem_w,
								ie_retrogrado_w,
								dt_fim_w,
								ie_administracao_w,
								ie_evento_unico_w,
								nr_seq_cpoe_order_unit_w
							);

					commit;
				end if;
			exception when others then
				rollback;

				ds_erro_w := 'nr_atendimento_p=' || nr_atendimento_p
					|| ';nr_sequencia_p=' || nr_sequencia_p
					|| ';nr_seq_exame=' || nr_seq_exame_w
					|| ';nr_seq_proc_interno_w=' || nr_seq_proc_interno_w
					|| ';Erro=' || substr(sqlerrm, 1, 1800);
				CALL gravar_log_cpoe(ds_erro_w, nr_atendimento_p, 'P', nr_sequencia_p);

				commit;
			end;
		end if;
	end;

begin
    if (nr_atendimento_p IS NOT NULL AND nr_atendimento_p::text <> '') then

		for r_cProcedimentos_w in cProcedimentos
		loop
			nr_seq_proc_interno_w := r_cProcedimentos_w.nr_seq_proc_interno;
			qt_proced_w := r_cProcedimentos_w.qt_procedimento;
			ds_horarios_w := r_cProcedimentos_w.ds_horarios;
			ds_observacao_w := r_cProcedimentos_w.ds_observacao;
			cd_intervalo_w := r_cProcedimentos_w.cd_intervalo;
			ie_urgencia_w := r_cProcedimentos_w.ie_urgencia;
			cd_setor_atendimento_w := r_cProcedimentos_w.cd_setor_atendimento;
			ds_dado_clinico_w := r_cProcedimentos_w.ds_dado_clinico;
			dt_prev_execucao_w := r_cProcedimentos_w.dt_prev_execucao;
			cd_material_original_w := r_cProcedimentos_w.cd_material_exame;
			ds_material_especial_w := r_cProcedimentos_w.ds_material_especial;
			cd_medico_prescr_w := r_cProcedimentos_w.cd_medico;
			nr_seq_rotina_w := r_cProcedimentos_w.nr_seq_rotina;
			ie_se_necessario_w := r_cProcedimentos_w.ie_se_necessario;
			ie_acm_w := r_cProcedimentos_w.ie_acm;
			nr_ocorrencia_w := r_cProcedimentos_w.nr_ocorrencia;
			ie_lado_w := r_cProcedimentos_w.ie_lado;
			ds_justificativa_w := r_cProcedimentos_w.ds_justificativa;
			ie_duracao_w := r_cProcedimentos_w.ie_duracao;
			dt_inicio_w := r_cProcedimentos_w.dt_inicio;
			hr_prim_horario_w := r_cProcedimentos_w.hr_prim_horario;
			cd_perfil_ativo_w := r_cProcedimentos_w.cd_perfil_ativo;
			cd_pessoa_fisica_w := r_cProcedimentos_w.cd_pessoa_fisica;
			nr_seq_contraste_w := r_cProcedimentos_w.nr_seq_contraste;
			nm_usuario_nrec_w := r_cProcedimentos_w.nm_usuario_nrec;
			dt_atualizacao_nrec_w := r_cProcedimentos_w.dt_atualizacao_nrec;
			ie_cobra_paciente_w := r_cProcedimentos_w.ie_cobra_paciente;
			ie_futuro_w := r_cProcedimentos_w.ie_futuro;
			ie_nivel_atencao_w := r_cProcedimentos_w.ie_nivel_atencao;
			ie_oncologia_w := r_cProcedimentos_w.ie_oncologia;
			ie_item_alta_w := r_cProcedimentos_w.ie_item_alta;
			cd_funcao_origem_w := r_cProcedimentos_w.cd_funcao_origem;
			ie_retrogrado_w := r_cProcedimentos_w.ie_retrogrado;
			dt_fim_w := r_cProcedimentos_w.dt_fim;
			ie_administracao_w := r_cProcedimentos_w.ie_administracao;
			ie_evento_unico_w := r_cProcedimentos_w.ie_evento_unico;
			ie_anestesia_w := r_cProcedimentos_w.ie_anestesia;
			nr_seq_classificacao_w := r_cProcedimentos_w.nr_seq_classificacao;
			nr_seq_cpoe_order_unit_w  := r_cProcedimentos_w.nr_seq_cpoe_order_unit;
			
			SELECT * FROM CPOE_Obter_Param_Exame_Dep(	nr_atendimento_p, cd_estabelecimento_p, nr_seq_proc_interno_w, nr_seq_rotina_w, cd_material_exame_w, cd_convenio_w, cd_plano_convenio_w, cd_categoria_w, nr_seq_material_prescr_w, ie_origem_proced_cursor_w, ie_origem_proced_sus_w, ie_origem_proced_w, nr_seq_exame_w, ie_tipo_atendimento_w, ie_tipo_convenio_w, cd_edicao_amb_w) INTO STRICT cd_convenio_w, cd_plano_convenio_w, cd_categoria_w, nr_seq_material_prescr_w, ie_origem_proced_cursor_w, ie_origem_proced_sus_w, ie_origem_proced_w, nr_seq_exame_w, ie_tipo_atendimento_w, ie_tipo_convenio_w, cd_edicao_amb_w;

			qt_exame_dep_w := coalesce(qt_exame_dep_w, 0) + 1;

			for r_cItems in cItems
			loop
				nr_seq_exame_w := r_cItems.nr_seq_exame_dep;
				cd_procedimento_w := r_cItems.cd_procedimento;
				nr_seq_material_w := r_cItems.nr_seq_material;
				nr_seq_exame_princ_w := r_cItems.nr_seq_exame;
				ie_material_exame_princ_w := r_cItems.ie_material_exame_princ;
				cd_setor_atendimento_w := r_cItems.cd_setor_atendimento;
				cd_convenio_w := r_cItems.cd_convenio;
				nr_seq_proc_interno_dep_w := r_cItems.nr_seq_proc_interno;

				if (coalesce(nr_seq_proc_interno_dep_w::text, '') = '') then
					select max(nr_sequencia)
					  into STRICT nr_seq_proc_interno_dep_w
					  from proc_interno x
					 where x.nr_seq_exame_lab = nr_seq_exame_w;
				end if;

				add_item_dependente;
			end loop;
		end loop;
    end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cpoe_gerar_exame_lab_dep ( nr_sequencia_p cpoe_procedimento.nr_sequencia%type, nr_atendimento_p atendimento_paciente.nr_atendimento%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, cd_setor_atendimento_p setor_atendimento.cd_setor_atendimento%type, ds_opcao_p text, nm_usuario_p usuario.nm_usuario%type, nr_seq_exame_dep_p exame_lab_dependente.nr_seq_exame_dep%type, ds_itens_p text ) FROM PUBLIC;

