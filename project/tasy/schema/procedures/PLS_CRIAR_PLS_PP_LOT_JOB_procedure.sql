-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_criar_pls_pp_lot_job ( nr_seq_lote_p pls_pp_lote.nr_sequencia%type, ie_opcao_p text, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nm_usuario_p usuario.nm_usuario%type) AS $body$
DECLARE


jobno			bigint;
ie_lote_gerado_w	varchar(1);
ds_comando_job_w	varchar(2000);
dt_mes_competencia_w	pls_pp_lote.dt_mes_competencia%type;
ie_opcao_w		varchar(255) := replace(ie_opcao_p,'''','');
ie_status_w		pls_pp_lote.ie_status%type;
dt_geracao_titulo_w	pls_pp_lote.dt_geracao_titulo%type;
dt_geracao_lote_w	pls_pp_lote.dt_geracao_lote%type;
dt_fechamento_w		pls_pp_lote.dt_fechamento%type;

C01 CURSOR FOR
	-- falhas is not null, significa que ja foi executado pelo menos uma vez, se ja foi executado ao menos uma vez, apaga. durante a execucao ele fica null
	SELECT	job
	from	job_v
	where	comando	like 'pls_pp_lote_job%'
	and	(falhas IS NOT NULL AND falhas::text <> '');

BEGIN

select	max(dt_mes_competencia)
into STRICT	dt_mes_competencia_w
from	pls_pp_lote
where	nr_sequencia	= nr_seq_lote_p;

ie_lote_gerado_w	:= obter_se_lote_contabil_gerado(41, dt_mes_competencia_w);

if (ie_lote_gerado_w = 'S') then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(673786); -- Nao e possivel executar essa acao, pois ja existe um lote contabil gerado para essa competencia.
end if;

select	max(ie_status),
	max(dt_geracao_titulo),
	max(dt_geracao_lote),
	max(dt_fechamento)
into STRICT	ie_status_w,
	dt_geracao_titulo_w,
	dt_geracao_lote_w,
	dt_fechamento_w
from	pls_pp_lote
where	nr_sequencia = nr_seq_lote_p;

if	(ie_status_w in ('A', 'G')) then -- 'Aguardando geracao' ou 'Gerando'
	if (ie_opcao_w = 'TITULO') then
		CALL wheb_mensagem_pck.exibir_mensagem_abort(1087547); -- A geracao dos titulos ja esta sendo executada para este lote.
		
	elsif (ie_opcao_w = 'GERAR') then
		CALL wheb_mensagem_pck.exibir_mensagem_abort(1087548); -- A geracao ja esta sendo executada para este lote.
		
	elsif (ie_opcao_w = 'FECHAR') then
		CALL wheb_mensagem_pck.exibir_mensagem_abort(1087549); -- O fechamento ja esta sendo executada para este lote.
	end if;
elsif (ie_opcao_w = 'TITULO') then
	if (dt_geracao_titulo_w IS NOT NULL AND dt_geracao_titulo_w::text <> '') then
		CALL wheb_mensagem_pck.exibir_mensagem_abort(1087550); -- A geracao dos titulos ja foi executada para este lote.
	end if;
elsif (ie_opcao_w = 'GERAR') then
	if (dt_geracao_lote_w IS NOT NULL AND dt_geracao_lote_w::text <> '') then
		CALL wheb_mensagem_pck.exibir_mensagem_abort(1087552); -- A geracao ja foi executada para este lote.
	end if;
elsif (ie_opcao_w = 'FECHAR') then
	if (dt_fechamento_w IS NOT NULL AND dt_fechamento_w::text <> '') then
		CALL wheb_mensagem_pck.exibir_mensagem_abort(1087553); -- O fechamento ja foi executado para este lote.
	end if;
end if;

-- Verificar se a job ja existe, se existir remove
for r_C01_w in C01 loop
	dbms_job.remove(r_C01_w.job);
	commit;
end loop;

ds_comando_job_w	:= 'pls_pp_lote_job(' || nr_seq_lote_p || ',' -- nr_seq_lote_p
						|| pls_util_pck.aspas_w || ie_opcao_w || pls_util_pck.aspas_w || ',' -- ie_opcao_p
						|| pls_util_pck.aspas_w || nm_usuario_p || pls_util_pck.aspas_w || ',' -- nm_usuario_p
						|| coalesce(to_char(cd_estabelecimento_p), 'null') ||  ');'; --cd_estabelecimento_p

-- Vai iniciar a procedure em 2.5 segundos apos a conclusao desta e sempre joga a proxima execucao para daqui a 10000 dias
dbms_job.submit(jobno, ds_comando_job_w, clock_timestamp() + interval '216000 seconds' * (1/24/60/60));

-- coloca o id do job responsavel por executar o processo.
update	pls_pp_lote
set	nm_id_job = jobno,
	ie_status = 'A',
	nm_id_sid  = NULL,
	nm_id_serial  = NULL
where	nr_sequencia = nr_seq_lote_p;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_criar_pls_pp_lot_job ( nr_seq_lote_p pls_pp_lote.nr_sequencia%type, ie_opcao_p text, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nm_usuario_p usuario.nm_usuario%type) FROM PUBLIC;

