-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE copiar_preco_mat_fornec ( cd_estabelecimento_p bigint, cd_convenio_p bigint, nm_usuario_p text, nr_seq_material_p bigint, vl_material_p bigint, ie_acao_executada_p bigint) AS $body$
DECLARE



/*
ie_acao_executada_p
1 - Inserção
2 - Edição
*/
cd_material_w		integer;
nr_seq_fornec_w		bigint;
nr_seq_mat_fornec_w	bigint;
qt_mat_fornec_w			bigint;
nr_seq_mat_fornec_nova_w	bigint;
cd_cgc_fornec_w		varchar(14);

c01 CURSOR FOR
SELECT	a.nr_sequencia
from 	convenio_preco_fornec a
where	a.cd_convenio 		= cd_convenio_p
and 	a.cd_estabelecimento 	= cd_estabelecimento_p
and 	((coalesce(ie_acao_executada_p,0) = 1) or (exists (select 	1
		from 	convenio_preco_mat_fornec x
		where	x.nr_seq_conv_preco	= a.nr_sequencia
		and 	x.cd_material		= cd_material_w
		and	x.nr_sequencia		<> nr_Seq_material_p)));

c02 CURSOR FOR
SELECT 	b.nr_sequencia
from 	convenio_preco_mat_fornec b
where	b.nr_seq_conv_preco	= nr_seq_fornec_w
and 	b.cd_material		= cd_material_w
and 	b.nr_sequencia		<> nr_seq_material_p;

c03 CURSOR FOR
SELECT	a.nr_sequencia
from 	convenio_preco_fornec a
where	a.cd_estabelecimento 	= cd_estabelecimento_p
and 	(((coalesce(ie_acao_executada_p,0) = 1)and (a.cd_cgc_fornec = cd_cgc_fornec_w)) or (exists (select 	1
		from 	convenio_preco_mat_fornec x
		where	x.nr_seq_conv_preco	= a.nr_sequencia
		and 	x.cd_material		= cd_material_w
		and	x.nr_sequencia		<> nr_Seq_material_p)));


BEGIN

select	max(a.cd_material),
	max(b.cd_cgc_fornec)
into STRICT 	cd_material_w,
	cd_cgc_fornec_w
from 	convenio_preco_mat_fornec a,
	convenio_preco_fornec b
where	a.nr_sequencia	= nr_seq_material_p
and	a.nr_seq_conv_preco = b.nr_sequencia;

if (cd_convenio_p = 0) then
	open c03;
	loop
	fetch c03 into
		nr_seq_fornec_w;
	EXIT WHEN NOT FOUND; /* apply on c03 */

		select 	count(*)
		into STRICT	qt_mat_fornec_w
		from 	convenio_preco_mat_fornec b
		where	b.nr_seq_conv_preco	= nr_seq_fornec_w
		and 	b.cd_material		= cd_material_w;

		if (coalesce(qt_mat_fornec_w,0) > 0) then

			open c02;
			loop
			fetch c02 into
				nr_seq_mat_fornec_w;
			EXIT WHEN NOT FOUND; /* apply on c02 */

				update	convenio_preco_mat_fornec
				set	vl_material	= vl_material_p,
					nm_usuario	= nm_usuario_p,
					dt_atualizacao 	= clock_timestamp()
				where	nr_sequencia	= nr_seq_mat_fornec_w;

			end loop;
			close c02;

		elsif (coalesce(qt_mat_fornec_w,0) = 0) and (coalesce(ie_acao_executada_p,0) = 1)then


			select	nextval('convenio_preco_mat_fornec_seq')
			into STRICT	nr_seq_mat_fornec_nova_w
			;


			insert	into convenio_preco_mat_fornec(
				CD_MATERIAL,
				DT_ATUALIZACAO,
				DT_ATUALIZACAO_NREC,
				NM_USUARIO,
				NM_USUARIO_NREC,
				NR_SEQ_CONV_PRECO,
				NR_SEQ_MARCA,
				NR_SEQUENCIA,
				VL_MATERIAL)
			SELECT	CD_MATERIAL,
				clock_timestamp(),
				clock_timestamp(),
				nm_usuario_p,
				nm_usuario_p,
				nr_seq_fornec_w,
				NR_SEQ_MARCA,
				nr_seq_mat_fornec_nova_w,
				vl_material_p
			from	convenio_preco_mat_fornec
			where	nr_sequencia = nr_seq_material_p;

		end if;


	end loop;
	close c03;
else
		open c01;
	loop
	fetch c01 into
		nr_seq_fornec_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */

		select 	count(*)
		into STRICT	qt_mat_fornec_w
		from 	convenio_preco_mat_fornec b
		where	b.nr_seq_conv_preco	= nr_seq_fornec_w
		and 	b.cd_material		= cd_material_w;

		if (coalesce(qt_mat_fornec_w,0) > 0) then

			open c02;
			loop
			fetch c02 into
				nr_seq_mat_fornec_w;
			EXIT WHEN NOT FOUND; /* apply on c02 */

				update	convenio_preco_mat_fornec
				set	vl_material	= vl_material_p,
					nm_usuario	= nm_usuario_p,
					dt_atualizacao 	= clock_timestamp()
				where	nr_sequencia	= nr_seq_mat_fornec_w;

			end loop;
			close c02;

		elsif (coalesce(qt_mat_fornec_w,0) = 0) and (coalesce(ie_acao_executada_p,0) = 1)then


			select	nextval('convenio_preco_mat_fornec_seq')
			into STRICT	nr_seq_mat_fornec_nova_w
			;


			insert	into convenio_preco_mat_fornec(
				CD_MATERIAL,
				DT_ATUALIZACAO,
				DT_ATUALIZACAO_NREC,
				NM_USUARIO,
				NM_USUARIO_NREC,
				NR_SEQ_CONV_PRECO,
				NR_SEQ_MARCA,
				NR_SEQUENCIA,
				VL_MATERIAL)
			SELECT	CD_MATERIAL,
				clock_timestamp(),
				clock_timestamp(),
				nm_usuario_p,
				nm_usuario_p,
				nr_seq_fornec_w,
				NR_SEQ_MARCA,
				nr_seq_mat_fornec_nova_w,
				vl_material_p
			from	convenio_preco_mat_fornec
			where	nr_sequencia = nr_seq_material_p;

		end if;


	end loop;
	close c01;
end if;



commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE copiar_preco_mat_fornec ( cd_estabelecimento_p bigint, cd_convenio_p bigint, nm_usuario_p text, nr_seq_material_p bigint, vl_material_p bigint, ie_acao_executada_p bigint) FROM PUBLIC;

