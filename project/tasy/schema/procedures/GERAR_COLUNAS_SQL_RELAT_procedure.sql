-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_colunas_sql_relat (nr_seq_banda_p bigint, nm_usuario_p text) AS $body$
DECLARE

 
/* Matheus OS 110671 em 29/09/2008 Ideias de melhorias 
criar os campos do relatório de acordo com o SQL da banda */
 
 
col_cnt   		integer;
campos_w    		dbms_sql.desc_tab;	
cursor_w 			integer;
ds_casas_decimais_w	varchar(20);
ds_comando_w 		varchar(10000);
ds_erro_w		varchar(1000);
ds_label_w		varchar(255);
ds_mascara_w		varchar(40);
ie_alinhamento_w		varchar(1);
nr_seq_apres_w		integer	:= 0;
nr_seq_banda_superior_w	bigint;
nr_seq_relatorio_w		bigint;
nm_atributo_w		varchar(50);
ie_tipo_banda_w		varchar(01);
ie_tipo_campo_w		smallint;
ie_tipo_dado_w		bigint;
ie_totalizar_w		varchar(1);
qt_decimais_w		bigint;
qt_precisao_w		bigint;
qt_esquerda_w		double precision	:= 0;
qt_deslocamento_w		real;
qt_tamanho_ww		double precision;
qt_topo_w			bigint	:= 1;
qt_incremento_topo_w bigint	:= 1;
i			integer;
j			integer;

BEGIN
 
select	max(ds_sql), 
	max(ie_tipo_banda), 
	max(nr_seq_relatorio), 
	max(nr_seq_banda_superior) 
into STRICT	ds_comando_w, 
	ie_tipo_banda_w, 
	nr_seq_relatorio_w, 
	nr_seq_banda_superior_w 
from	banda_relatorio 
where	nr_sequencia = nr_seq_banda_p;
 
if (ie_tipo_banda_w = 'D') then 
	select	max(ds_sql) 
	into STRICT	ds_comando_w 
	from	relatorio 
	where	nr_sequencia	= nr_seq_relatorio_w;
end if;
 
if (nr_seq_banda_superior_w IS NOT NULL AND nr_seq_banda_superior_w::text <> '') then 
	select	coalesce(min(qt_esquerda),5) 
	into STRICT	qt_deslocamento_w 
	from	banda_relat_campo 
	where	nr_seq_banda	= nr_seq_banda_superior_w;
end if;
 
if (coalesce(ds_comando_w,'X') = 'X') then 
	CALL exibir_erro_abortar(Wheb_mensagem_pck.get_texto(308526) || '#@#@' /*'Não existe comando SQL definido nesta banda!#@#@'*/,null);
end if;
 
ds_comando_w	:= replace(upper(ds_comando_w),'@SQL_WHERE','');
 
delete from banda_relat_campo 
where	nr_seq_banda	= nr_Seq_banda_p;
 
begin	 
cursor_w := DBMS_SQL.OPEN_CURSOR;
DBMS_SQL.PARSE(cursor_w, ds_comando_w, dbms_sql.native);
dbms_sql.describe_columns(cursor_w,col_cnt,campos_w);
exception when others then 
	ds_erro_w	:= SQLERRM(SQLSTATE);
	CALL exibir_erro_abortar(Wheb_mensagem_pck.get_texto(308527) /*'Erro ao analisar a instrução SQL!'*/
 || chr(13) || chr(10) || ds_erro_w,null);
end;
	/*Registra as colunas*/
 
	for i in 1 .. col_cnt loop 
		begin 
		if (qt_esquerda_w	= 0) then 
			qt_esquerda_w	:= 5;
			if (qt_deslocamento_w > 0) then 
				qt_esquerda_w	:= qt_deslocamento_w + 15;
			end if;
		else 
			qt_esquerda_w	:= qt_esquerda_w + qt_tamanho_ww + 10;
		end if;
		 
		nm_atributo_w		:= campos_w[i].col_name;
		ie_tipo_dado_w		:= campos_w[i].col_type;
		qt_tamanho_ww	  	:= campos_w[i].col_max_len;
		qt_precisao_w		:= campos_w[i].col_precision;
		qt_decimais_w		:= campos_w[i].col_scale;
		ie_totalizar_w		:= 'N';
		ie_alinhamento_w	:= 'E';
		ds_casas_decimais_w	:= '';
		ds_mascara_w		:= '';
		ie_tipo_campo_w		:= 0;
		ds_label_w		:= substr(nm_atributo_w,1,1) || substr(replace(lower(nm_atributo_w),'_',' '),2,length(nm_atributo_w));
		nr_seq_apres_w		:= nr_seq_apres_w + 5;
		if (qt_tamanho_ww < 40) then 
			qt_tamanho_ww	:= 20;
		end if;
		if (ie_tipo_dado_w = 1) then /* Varchar2 */
 
			begin 
			if (qt_tamanho_ww <= 200) then 
				qt_tamanho_ww	:= qt_tamanho_ww * 2;
			elsif (qt_tamanho_ww = 4000) then 
				qt_tamanho_ww	:= 255;
			end if;
			if (substr(nm_atributo_w,1,2) = 'DT') then /* Se tiver data com to_char trazendo a hora*/
 
				ie_alinhamento_w	:= 'C';
				qt_tamanho_ww		:= 110;
			end if;
			if (nm_atributo_w	= 'IE_SITUACAO') then 
				ds_label_w	:= 'Sit';
				qt_tamanho_ww	:= 40;
			end if;
			if (nm_atributo_w	= 'NM_USUARIO') then 
				ds_label_w	:= Wheb_mensagem_pck.get_texto(308528); --'Usuário'; 
				qt_tamanho_ww	:= 50;
			end if;
 
			if (substr(nm_atributo_w,1,2) in ('CD','NR')) then 
				qt_tamanho_ww		:= 60;
			end if;
			end;
		elsif (ie_tipo_dado_w = 2) then /* Number */
 
			ie_alinhamento_w	:= 'D';
			if (substr(nm_atributo_w,1,2) in ('VL','QT','PR')) then 
				for j in 1..qt_decimais_w loop 
					begin 
					ds_casas_decimais_w	:= ds_casas_decimais_w || '0';
					end;
				end loop;
				if (coalesce(qt_decimais_w,0) = 0) then 
					ds_casas_decimais_w	:= '00';
				end if;
				ds_mascara_w		:= '###,###,###,##0.' || ds_casas_decimais_w;
				ie_totalizar_w		:= 'S';
				qt_tamanho_ww		:= 70;
			elsif (substr(nm_atributo_w,1,2) in ('CD','NR')) then 
				qt_tamanho_ww		:= 60;
			end if;
		elsif (ie_tipo_dado_w = 12) then /* Date*/
 
			ie_alinhamento_w	:= 'C';
			ds_mascara_w		:= 'dd/mm/yyyy';
			qt_tamanho_ww		:= 70;
		elsif (ie_tipo_dado_w = 8) then 
			qt_tamanho_ww		:= 400;
			ie_tipo_campo_w		:= 10; /* DB Rich Edit*/
		end if;
		 
		if (qt_esquerda_w	> 9999) then 
			qt_esquerda_w	:= 5;
			qt_topo_w		:= qt_topo_w + 17;
			qt_incremento_topo_w	:= qt_incremento_topo_w + 1;
		end if;
		 
	 
		insert into banda_relat_campo( 
			nr_sequencia, 
			nr_seq_banda, 
			ds_campo, 
			nr_seq_apresentacao, 
			ie_tipo_campo, 
			dt_atualizacao, 
			nm_usuario, 
			ie_borda_sup, 
			ie_borda_inf, 
			ie_borda_esq, 
			ie_borda_dir, 
			ie_totalizar, 
			ie_campo_quebra, 
			ie_quebra_pagina, 
			ie_zera_apos_imprimir, 
			ie_transparente, 
			ie_alinhamento, 
			ie_ajustar_tamanho, 
			ie_estender, 
			ie_alinhar_banda, 
			qt_altura, 
			qt_tamanho, 
			qt_topo, 
			qt_esquerda, 
			ds_label, 
			nm_atributo, 
			ds_conteudo, 
			ds_expressao, 
			ds_mascara, 
			ds_sql, 
			ds_cor_fundo, 
			qt_tam_fonte, 
			ds_cor_fonte, 
			ds_tipo_fonte, 
			ds_estilo_fonte, 
			ie_tipo_barcode, 
			ie_humano_barcode, 
			pr_altura_barcode, 
			qt_fonte_barcode, 
			ds_cor_label, 
			ie_altera_valor ) 
		values ( nextval('banda_relat_campo_seq'), 
			nr_seq_banda_p, 
			ds_label_w, 
			nr_seq_apres_w, 
			ie_tipo_campo_w, /*Tipo campo = 0 Base Dominio 1042*/
 
			clock_timestamp(), 
			nm_usuario_p, 
			'N', 
			'N', 
			'N', 
			'N', 
			ie_totalizar_w, 
			'N', 
			'N', 
			'N', 
			'S', /* ie_transparente*/
 
			ie_alinhamento_w, 
			'N', 
			'N', 
			'N', 
			17, /* Altura*/
 
			qt_tamanho_ww, 
			qt_topo_w, /* Topo*/
 
			qt_esquerda_w, 
			CASE WHEN ie_tipo_banda_w='M' THEN ''  ELSE ds_label_w END , 
			nm_atributo_w, 
			'', 
			'', 
			ds_mascara_w, 
			'', /* ds_sql*/
 
			'clWhite', 
			8, 
			'clBlack', 
			'Arial', 
			'', 
			'CODE128_C', 
			'S', 
			50, 
			100, 
			'clWhite', 
			'N');
			 
			 
			 
	end;
	end loop;
	 
if (qt_incremento_topo_w > 1) then 
	qt_incremento_topo_w:= qt_incremento_topo_w *17;
	begin 
	update	BANDA_RELATORIO 
	set		QT_ALTURA = qt_incremento_topo_w 
	where	nr_sequencia = nr_seq_banda_p;
	exception 
		when others then 
		null;
	end;
end if;	
	 
	 
dbms_sql.close_cursor(cursor_w);
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_colunas_sql_relat (nr_seq_banda_p bigint, nm_usuario_p text) FROM PUBLIC;

