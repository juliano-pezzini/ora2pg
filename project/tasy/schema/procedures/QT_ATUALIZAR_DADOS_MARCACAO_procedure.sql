-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE qt_atualizar_dados_marcacao ( nr_seq_pendencia_p bigint, nr_seq_atendimento_p bigint, dt_agenda_p timestamp, nm_usuario_p text, nr_seq_local_p bigint, cd_estabelecimento_p bigint, nr_seq_item_p bigint default null, ie_gerar_p INOUT text DEFAULT NULL, nr_seq_prof_p bigint default null, ie_consiste_estab_p text DEFAULT NULL, dt_marcacao_p timestamp default null, ie_valida_agrupamento_p text default 'N') AS $body$
DECLARE


dt_prevista_w			timestamp;
dt_real_w				timestamp;
qt_tempo_medic_w		bigint;
qt_marcacao_w			bigint;
qt_em_agenda_w			bigint;
qt_pendencia_marcada_w	bigint;
dt_ultimo_horario_w		timestamp;
ie_dia_quimio_w			varchar(1)	:= 'S';
ie_gerar_w				varchar(3)	:= 'N';
qt_tempo_prep_medic_w	bigint;
qt_tempo_prep_pac_w		bigint;
cd_pessoa_fisica_w		varchar(10);
ds_result_pac_prof_w	varchar(255);
ie_prof_marcado_w		varchar(1)	:= 'N';
nr_seq_prof_w			bigint;
ie_tipo_agendamento_w	varchar(15)	:= 'P';
ie_perm_mesmo_horario_w	varchar(1)	:= 'N';
nr_min_apres_w			bigint;
dt_suspensao_medico_w	timestamp;
qt_horas_entre_dias_w	bigint;
dt_maior_w				timestamp;
dt_menor_w				timestamp;
dt_maior_marc_w			timestamp;
dt_menor_marc_w			timestamp;
nr_seq_classif_w		bigint;
qt_permitida_w			bigint;
hr_inicial_w			timestamp;
hr_final_w				timestamp;
qt_agendamento_w		bigint;
ie_permite_w			varchar(1);
qt_regra_entre_exames_w	bigint;
ie_hor_concor_w			varchar(1);
nr_seq_ageint_w			bigint;
nr_min_dur_ageint_w		bigint;
ie_consiste_estab_w		varchar(1);
nr_seq_medicacao_w		integer;
cd_protocolo_w			bigint;
qt_marcar_dia_agenda_w	bigint;
qt_marc_dia_agenda_w	bigint;
qt_bloqueio_w			bigint;
nr_min_apres_local_w	smallint;
nr_seq_atendimento_w	bigint;
ds_dia_ciclo_w			varchar(5);
nr_ciclo_w			smallint;
nr_horas_marcacao_w		bigint;
hr_min_inicio_w			timestamp;
nr_seq_regra_w			bigint;
nr_seq_grupo_quimio_w		bigint;
nr_seq_paciente_w		bigint;
ie_permite_conv_w		varchar(1);
ie_consiste_outras_agendas_w	varchar(1);
ie_possui_outros_agend_w	bigint;
qt_tempo_agenda_w		bigint;
ds_texto_w			varchar(2000);
ie_consiste_dias_anteiores_w	varchar(1);
ie_possui_agendas_passadas_w	varchar(1);
dt_min_prevista_w				timestamp;
qt_regra_marc_protocolo_w	bigint;
qt_marcacoes_protocolo_w	bigint;
qt_protocolo_regra_W	bigint;
ie_liberado_grupo_w	varchar(1) := 'S';
nr_seq_medicacao_pend_w		bigint;
nr_seq_local_w			qt_regra_classif_marc.nr_seq_local%type;
nr_seq_quimio_grupo_w 	qt_regra_classif_marc.nr_seq_grupo_quimio%type;
cd_setor_atendimento_w	paciente_setor.cd_setor_atendimento%type;
dt_agenda_pendente_w	timestamp;
ds_local_w	qt_local.ds_local%type;
nr_seq_pendencia_w		paciente_atendimento.nr_seq_pend_agenda%type;
dt_agenda_w			timestamp := null;
nr_seq_item_w		agenda_integrada_item.nr_sequencia%type;
nr_intervalo_w		bigint;
ie_estagio_autorizacao_w varchar(20);
ie_vigencia_w    varchar(10);
ds_retorno_w	 varchar(10);
nr_acrescimo_w		bigint := 0;

C01 CURSOR FOR
	SELECT	nr_sequencia
	from	qt_regra_classif_marc
	where	nr_seq_classif = nr_seq_classif_w
	and		((nr_seq_local = nr_seq_local_p) or (coalesce(nr_seq_local::text, '') = ''))
	and		((nr_seq_grupo_quimio = nr_seq_grupo_quimio_w) or (coalesce(nr_seq_grupo_quimio::text, '') = ''))
	and		dt_agenda_w between to_date(to_char(dt_agenda_w,'dd/mm/yyyy') || ' ' || coalesce(to_char(hr_inicial,'hh24:mi:ss'),'00:00:00'),'dd/mm/yyyy hh24:mi:ss')
				and to_date(to_char(dt_agenda_w,'dd/mm/yyyy') || ' ' || coalesce(to_char(hr_final,'hh24:mi:ss'),'23:59:59'),'dd/mm/yyyy hh24:mi:ss')
	and		((cd_setor_atendimento = cd_setor_atendimento_w) or (coalesce(cd_setor_atendimento::text, '') = ''))
	order by coalesce(nr_seq_grupo_quimio,0),
		 coalesce(nr_seq_local,0);

C02 CURSOR FOR
	SELECT DISTINCT b.nr_seq_pend_agenda
	FROM paciente_setor a,
		paciente_atendimento b
	WHERE a.nr_seq_paciente	= b.nr_seq_paciente AND
		(b.nr_seq_pend_agenda = nr_seq_pendencia_p OR
			(a.ie_agendamento_multiplo = 'S' AND
				b.nr_seq_pend_agenda <> nr_seq_pendencia_p AND
				ie_valida_agrupamento_p = 'S' AND
				a.nr_grupo_agendamento = (SELECT MAX(wp.nr_grupo_agendamento)
											FROM w_pendencia_agequi wp
											WHERE wp.nr_seq_pendencia = nr_seq_pendencia_p
												AND (wp.nr_grupo_agendamento IS NOT NULL AND wp.nr_grupo_agendamento::text <> '')) AND
				a.cd_pessoa_fisica = (SELECT MAX(wp.cd_pessoa_fisica)
											FROM w_pendencia_agequi wp
											WHERE wp.nr_seq_pendencia = nr_seq_pendencia_p
												AND (wp.nr_grupo_agendamento IS NOT NULL AND wp.nr_grupo_agendamento::text <> ''))))
	ORDER BY b.nr_seq_pend_agenda ASC;


BEGIN

select	coalesce(max(Obter_Valor_Param_Usuario(865, 1, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p)),0)
into STRICT	qt_tempo_prep_medic_w
;

select	coalesce(max(Obter_Valor_Param_Usuario(865, 2, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p)),0)
into STRICT	qt_tempo_prep_pac_w
;

select	coalesce(max(Obter_Valor_Param_Usuario(865, 4, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p)),0)
into STRICT	ie_perm_mesmo_horario_w
;

select	coalesce(max(Obter_Valor_Param_Usuario(865, 3, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p)),0)
into STRICT	nr_min_apres_w
;

select	coalesce(max(Obter_Valor_Param_Usuario(865, 119, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p)),0)
into STRICT	nr_horas_marcacao_w
;

select	coalesce(max(Obter_Valor_Param_Usuario(865, 197, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p)),'N')
into STRICT	ie_consiste_outras_agendas_w
;

select	coalesce(max(Obter_Valor_Param_Usuario(865, 198, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p)),0)
into STRICT	qt_tempo_agenda_w
;

select	coalesce(max(Obter_Valor_Param_Usuario(865, 217, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p)),'N')
into STRICT	ie_consiste_dias_anteiores_w
;

select	max(nr_min_apres)
into STRICT	nr_min_apres_local_w
from	qt_local
where	nr_sequencia = nr_seq_local_p;

select	max(hr_min_inicio)
into STRICT	hr_min_inicio_w
from	parametro_agenda_quimio
where	cd_estabelecimento = cd_estabelecimento_p;

qt_horas_entre_dias_w := obter_param_usuario(865, 62, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, qt_horas_entre_dias_w);
if (ie_consiste_estab_p IS NOT NULL AND ie_consiste_estab_p::text <> '') then
	ie_consiste_estab_w	:= ie_consiste_estab_p;
else
	ie_consiste_estab_w	:= 'N';
end if;

select	max(nr_seq_grupo_quimio)
into STRICT	nr_seq_grupo_quimio_w
from	qt_local
where	nr_sequencia = nr_seq_local_p;
dt_agenda_w := dt_agenda_p;

	open C02;
	loop
	fetch C02 into
		nr_seq_pendencia_w;
	EXIT WHEN NOT FOUND; /* apply on C02 */
	begin

		select coalesce(max(nr_sequencia), nr_seq_item_p)
		into STRICT nr_seq_item_w
		from agenda_integrada_item
		where nr_seq_pend_quimio = nr_seq_pendencia_w;
		ie_gerar_w := 'N';

		begin
			select	max(coalesce(b.dt_prevista_agenda, b.dt_prevista)),
				max(b.dt_real),
				max(qt_obter_dur_aplicacao(b.ds_dia_ciclo,a.nr_seq_medicacao,a.cd_protocolo,b.nr_seq_atendimento,coalesce(b.dt_real, b.dt_prevista),nr_seq_pendencia_w,nm_usuario_p,cd_estabelecimento_p)),
				max(a.cd_pessoa_fisica),
				max(b.dt_suspensao_medico),
				max(a.nr_seq_medicacao),
				max(a.cd_protocolo),
				max(b.nr_seq_atendimento),
				max(b.ds_dia_ciclo),
				max(b.nr_ciclo),
				max(a.nr_seq_paciente),
				max(a.cd_setor_atendimento)
			into STRICT	dt_prevista_w,
				dt_real_w,
				qt_tempo_medic_w,
				cd_pessoa_fisica_w,
				dt_suspensao_medico_w,
				nr_seq_medicacao_w,
				cd_protocolo_w,
				nr_seq_atendimento_w,
				ds_dia_ciclo_w,
				nr_ciclo_w,
				nr_seq_paciente_w,
				cd_setor_atendimento_w
			from	paciente_setor a,
				paciente_atendimento b
			where	b.nr_seq_pend_agenda	= nr_seq_pendencia_w
			and (b.nr_seq_atendimento	= nr_seq_atendimento_p or nr_seq_atendimento_p = 0)
			and	a.nr_seq_paciente	= b.nr_seq_paciente
			and	coalesce(b.dt_suspensao::text, '') = ''
			and	coalesce(b.dt_cancelamento::text, '') = ''
			and	coalesce(b.dt_interrompido::text, '') = ''
			and	((coalesce(b.cd_estabelecimento, cd_estabelecimento_p)	= cd_estabelecimento_p and ie_consiste_estab_w = 'S') or ie_consiste_estab_w = 'N')
			and	trunc(coalesce(b.dt_prevista_agenda,coalesce(b.dt_real, b.dt_prevista)))	= trunc(dt_agenda_w) 
			and	not exists (SELECT 1 
						from 	agenda_quimio x
						where 	x.nr_seq_pend_agenda	=  b.nr_seq_pend_agenda
						and	b.nr_seq_atendimento	= x.nr_seq_atendimento
						and	trunc(x.dt_agenda)	= trunc(dt_agenda_w)
						and	x.nr_seq_atendimento	= b.nr_seq_Atendimento
						and	x.ie_status_agenda in ('F','S')) LIMIT 1;
			exception
				when others then
				ie_dia_quimio_w	:= 'N';
		end;
		select 	coalesce(max(qt_marc_dia_agenda),1)
		into STRICT   	qt_marc_dia_agenda_w
		from   	protocolo_medicacao
		where  	nr_sequencia    = nr_seq_medicacao_w
		and	cd_protocolo    = cd_protocolo_w;

		if (hr_min_inicio_w IS NOT NULL AND hr_min_inicio_w::text <> '') and (ds_dia_ciclo_w = 'D1') and (nr_ciclo_w = 1) and (to_char(dt_agenda_w,'hh24:mi') < to_char(hr_min_inicio_w,'hh24:mi')) then
			--Rai2se_app2licat2ion_e2rror(-20011,'O D1 do ciclo 1 nao pode ser agendado neste horario! Verifique o horario minimo para marcacao.'||'#@#@');
			CALL Wheb_mensagem_pck.exibir_mensagem_abort(211780);
		end if;

		ie_permite_conv_w	:= qt_obter_se_perm_conv_agenda(nr_seq_paciente_w, nr_seq_local_p, cd_estabelecimento_p, nm_usuario_p);
		if (ie_permite_conv_w	= 'N') then
			CALL wheb_mensagem_pck.exibir_mensagem_abort(198668);
		end if;

		if (coalesce(cd_protocolo_w,0) > 0) then
			
			select	count(*)
			into STRICT	qt_regra_marc_protocolo_w
			from	protocolo_local_quimio
			where	cd_protocolo = cd_protocolo_w
			and	coalesce(nr_seq_medicacao, nr_seq_medicacao_w) = nr_seq_medicacao_w
			and	cd_estabelecimento = obter_estabelecimento_ativo;
			
			select	count(*)
			into STRICT	qt_protocolo_regra_W
			from	qt_protocolos_grupo
			where	cd_protocolo	= cd_protocolo_w
			and		ie_situacao = 'A';
			
			if (coalesce(qt_protocolo_regra_W,0) > 0) and (coalesce(nr_seq_grupo_quimio_w,0) > 0) then
				
				select	CASE WHEN count(*)=0 THEN 'N'  ELSE 'S' END 
				into STRICT	ie_liberado_grupo_w
				from	qt_protocolos_grupo
				where	cd_protocolo	= cd_protocolo_w
				and	nr_seq_grupo =  nr_seq_grupo_quimio_w
				and	ie_situacao = 'A';
				
				if (ie_liberado_grupo_w = 'N') then
					ie_gerar_w := 'PG';
				end if;
			end if;

		end if;

		if (coalesce(ie_gerar_w,'N') <> 'PG') then	
			delete from	agenda_quimio_marcacao a
			where	dt_agenda between trunc(dt_agenda_w) and trunc(dt_agenda_w) + 86399/86400			
			and	coalesce(ie_gerado,'N')	= 'S'
			AND	NOT EXISTS (SELECT	1
						FROM 	agenda_quimio x
						WHERE 	((a.nr_seq_atendimento = x.nr_seq_atendimento 
						AND	a.nr_seq_pend_agenda = x.nr_seq_pend_agenda)
						OR (x.nr_sequencia = a.nr_seq_agenda))
						AND	x.dt_agenda   BETWEEN TRUNC(a.dt_Agenda) AND TRUNC(a.dt_Agenda) + 86399/86400
						and	x.nr_seq_local = a.nr_seq_local
						and	x.ie_status_agenda not in ('C', 'S', 'F')  LIMIT 1);

				if (coalesce(qt_regra_marc_protocolo_w,0) > 0) then
				
					select	max(QT_LOCAIS)
					into STRICT	qt_regra_marc_protocolo_w
					from	protocolo_local_quimio
					where	cd_protocolo = cd_protocolo_w
					and	coalesce(nr_seq_medicacao, nr_seq_medicacao_w) = nr_seq_medicacao_w
					and	cd_estabelecimento = obter_estabelecimento_ativo;	
					
					
					
					select	count(nr_seq_local)
					into STRICT	qt_marcacoes_protocolo_w
					from	agenda_quimio_marcacao
					where	obter_cd_protocolo_pac_atend(nr_seq_atendimento) = cd_protocolo_w		
					and	coalesce(qt_obter_dados_pendencia(nr_seq_pend_agenda,'MEDIC',nm_usuario_p), nr_seq_medicacao_w) = nr_seq_medicacao_w
					and	coalesce(ie_gerado,'N')	= 'S'
					and	nr_seq_local <> nr_seq_local_p
					and	trunc(dt_agenda_w) = trunc(dt_Agenda);
					
					if (coalesce(qt_marcacoes_protocolo_w,0) >= coalesce(qt_regra_marc_protocolo_w,0)) then
						CALL wheb_mensagem_pck.exibir_mensagem_abort(238305);
					end if;
				end if;
				
			select	count(*)
			into STRICT	qt_marcacao_w
			from	agenda_quimio_marcacao
			where	dt_agenda_w between dt_Agenda and dt_Agenda + (nr_duracao - 1) / 1440
			and	nr_seq_local		= nr_seq_local_p
			--and	nm_usuario		= nm_usuario_p
			and	nr_seq_pend_agenda	= nr_seq_pendencia_w
			and (nr_seq_atendimento	= nr_seq_atendimento_p or nr_seq_atendimento_p = 0);

			if (qt_marcacao_w = 0) then
				if (qt_horas_entre_dias_w > 0) then
					select	max(coalesce(b.dt_prevista_agenda, coalesce(b.dt_real,b.dt_prevista)))
					into STRICT	dt_menor_w
					from	paciente_atendimento b
					where	b.nr_seq_pend_agenda	= nr_seq_pendencia_w
					and (b.nr_seq_atendimento	= nr_seq_atendimento_p or nr_seq_atendimento_p = 0)
					and	coalesce(b.dt_cancelamento::text, '') = ''
					and	coalesce(b.dt_interrompido::text, '') = ''
					and	coalesce(qt_obter_data_status('F',b.nr_seq_atendimento)::text, '') = ''
					and	trunc(coalesce(b.dt_prevista_agenda,coalesce(b.dt_real, b.dt_prevista)))	< trunc(dt_agenda_w);

					select	min(coalesce(b.dt_prevista_agenda, coalesce(b.dt_real,b.dt_prevista)))
					into STRICT	dt_maior_w
					from	paciente_atendimento b
					where	b.nr_seq_pend_agenda	= nr_seq_pendencia_w
					and (b.nr_seq_atendimento	= nr_seq_atendimento_p or nr_seq_atendimento_p = 0)
					and	coalesce(b.dt_cancelamento::text, '') = ''
					and	coalesce(b.dt_interrompido::text, '') = ''
					and	coalesce(qt_obter_data_status('F',b.nr_seq_atendimento)::text, '') = ''
					and	trunc(coalesce(b.dt_prevista_agenda,coalesce(b.dt_real, b.dt_prevista)))	> trunc(dt_agenda_w);

					select	max(dt_agenda)
					into STRICT	dt_maior_marc_w
					from	agenda_quimio_marcacao
					where	nr_seq_pend_agenda	= nr_seq_pendencia_w
					and (nr_seq_atendimento	= nr_seq_atendimento_p or nr_seq_atendimento_p = 0)
					and	trunc(dt_agenda)	= trunc(dt_maior_w);

					select	max(dt_agenda)
					into STRICT	dt_menor_marc_w
					from	agenda_quimio_marcacao
					where	nr_seq_pend_agenda	= nr_seq_pendencia_w
					and (nr_seq_atendimento	= nr_seq_atendimento_p or nr_seq_atendimento_p = 0)
					and	trunc(dt_agenda)	= trunc(dt_menor_w);
					
					if	((((dt_agenda_w - dt_menor_marc_w) * 24) <= qt_horas_entre_dias_w) or (((dt_maior_marc_w - dt_agenda_w) * 24) <= qt_horas_entre_dias_w)) then
						ie_dia_quimio_w := 'N';
						ie_gerar_w 	:= 'T';
					end if;	
				end if;

          if (ie_gerar_p = 'S' and (ie_estagio_autorizacao_w IS NOT NULL AND ie_estagio_autorizacao_w::text <> '')) then

				select 	nr_seq_atendimento,
		                nr_seq_paciente,
		                nr_ciclo
                into STRICT
		                nr_seq_atendimento_w,
		                nr_seq_paciente_w,
		                nr_ciclo_w
                from	paciente_atendimento a
                where	a.nr_Seq_pend_agenda	= nr_seq_pendencia_p;

                select  coalesce(max('S'),'N')
                into STRICT	ie_vigencia_w
                from	autorizacao_convenio
                where	nr_seq_paciente = nr_seq_atendimento_w
                and 	((coalesce(DT_INICIO_VIGENCIA, dt_agenda_p) > dt_agenda_p) or (coalesce(DT_FIM_VIGENCIA, dt_agenda_p) < dt_agenda_p));

                if (ie_vigencia_w = 'N') then
	                select coalesce(max('S'),'N')
                    into STRICT	  ie_vigencia_w
	                from	  autorizacao_convenio
	                where     nr_seq_paciente_setor = nr_seq_paciente_w
                    and 	  nr_ciclo = nr_ciclo_w
	                and 	  ((coalesce(DT_INICIO_VIGENCIA, dt_agenda_p) > dt_agenda_p) or (coalesce(DT_FIM_VIGENCIA, dt_agenda_p) < dt_agenda_p));
                end if;

        if (ie_vigencia_w = 'S') then
	    ds_retorno_w := 'CDV'; --Consiste data vigencia
        end if;	
        end if;

                		select	coalesce(max(nr_sequencia),0)
				into STRICT	nr_seq_classif_w
				from	qt_classif_duracao
				where	nr_minuto_duracao = qt_tempo_medic_w;

				if (nr_seq_classif_w > 0) then

					open C01;
					loop
					fetch C01 into	
						nr_seq_regra_w;
					EXIT WHEN NOT FOUND; /* apply on C01 */
						begin
						nr_seq_regra_w := nr_seq_regra_w;
						end;
					end loop;
					close C01;

					select	max(qt_permitida),
						max(hr_inicial),
						max(hr_final),
						max(nr_seq_local),
						max(nr_seq_grupo_quimio)
					into STRICT	qt_permitida_w,
						hr_inicial_w,
						hr_final_w,
						nr_seq_local_w,
						nr_seq_quimio_grupo_w
					from	qt_regra_classif_marc
					where	nr_sequencia = nr_seq_regra_w;
					
					if (qt_permitida_w IS NOT NULL AND qt_permitida_w::text <> '') then
						select	count(*)
						into STRICT	qt_agendamento_w
						from	agenda_quimio a,
							qt_local b
						where	a.nr_seq_local = b.nr_sequencia
						and	a.dt_agenda between to_date(to_char(dt_agenda_w,'dd/mm/yyyy') || ' ' || coalesce(to_char(hr_inicial_w,'hh24:mi:ss'),'00:00:00'),'dd/mm/yyyy hh24:mi:ss') and
									  to_date(to_char(dt_agenda_w,'dd/mm/yyyy') || ' ' || coalesce(to_char(hr_final_w,'hh24:mi:ss'),'23:59:59'),'dd/mm/yyyy hh24:mi:ss')
						and	a.ie_tipo_pend_agenda = 'Q'
						and	a.nr_minuto_duracao = qt_tempo_medic_w
						and	coalesce(b.ie_situacao,'A') = 'A'
						and ((a.nr_seq_local = nr_seq_local_w) or coalesce(nr_seq_local_w::text, '') = '')
						and ((b.nr_seq_grupo_quimio = nr_seq_quimio_grupo_w ) or coalesce(nr_seq_quimio_grupo_w::text, '') = '')
						and	coalesce(a.dt_cancelada::text, '') = ''
						and	coalesce(a.dt_falta::text, '') = '';
									
						if (qt_agendamento_w >= qt_permitida_w) then
							ie_dia_quimio_w := 'N';
							ie_gerar_w 	:= 'Q';
						end if;
					end if;	
				end if;
					
				select	count(*)
				into STRICT	qt_regra_entre_exames_w
				from	qt_tempo_entre_exame;

				if (qt_regra_entre_exames_w > 0) then	
					ie_permite_w := qt_consistir_agendamento(dt_agenda_w, cd_estabelecimento_p, cd_pessoa_fisica_w, nm_usuario_p, ie_permite_w);
					if (ie_permite_w = 'N') then
						ie_dia_quimio_w := 'N';
						ie_gerar_w 	:= 'G';
					end if;
				end if;
			end if;

			if (dt_suspensao_medico_w IS NOT NULL AND dt_suspensao_medico_w::text <> '') then
				--Rais2e_applicat2ion_e2rror(-20011,'Nao e possivel realizar a marcacao, esse dia de tratamento foi suspenso pelo medico.#@#@');
				CALL wheb_mensagem_pck.exibir_mensagem_abort(211782);
			end if;

			if (nr_horas_marcacao_w > 0) and
				(dt_agenda_w <= (clock_timestamp() + nr_horas_marcacao_w/24)) then
				--Rai2se_appli2cation_err2or(-20011,'Numero de horas minimo excedido! Parametro [119].'||'#@#@');
				CALL wheb_mensagem_pck.exibir_mensagem_abort(211784);
			end if;

			if (ie_dia_quimio_w	= 'S') then
				select	max(nr_seq_agenda_int),
					max(nr_minuto_duracao)
				into STRICT	nr_seq_ageint_w,
					nr_min_dur_ageint_w
				from	agenda_integrada_item
				where	nr_sequencia	= nr_seq_item_w;
				
				if (coalesce(qt_tempo_medic_w::text, '') = '') and (nr_min_dur_ageint_w IS NOT NULL AND nr_min_dur_ageint_w::text <> '') then
					qt_tempo_medic_w := nr_min_dur_ageint_w;
				end if;
				
				if (nr_seq_ageint_w	> 0) then
					ie_hor_concor_w	:= Obter_Se_Pac_Ageint_Concor(nr_seq_ageint_w, dt_agenda_w, nr_seq_item_w, qt_tempo_medic_w);
					if (ie_hor_concor_w	= 'S') then
						ie_gerar_w		:= 'P';
						ie_Dia_quimio_w	:= 'N';
					end if;
				end if;
			end if;
			if (ie_dia_quimio_w	= 'S') then
				/*select	max(nr_seq_prof)
				into	nr_seq_prof_w
				from	qt_paciente_prof
				where	cd_pessoa_fisica	= cd_pessoa_fisica_w;*/
				nr_seq_prof_w	:= nr_seq_prof_p;
				
				qt_tempo_medic_w	:= (qt_tempo_medic_w + qt_tempo_prep_medic_w + qt_tempo_prep_pac_w);
					
				if (coalesce(qt_tempo_medic_w,0) = 0) then	
					ie_gerar_w := 'D';
					
				end if;
				
				if (ie_gerar_w <> 'D') then		
					select	count(*)
					into STRICT	qt_marcacao_w
					from	agenda_quimio_marcacao
					where	dt_agenda_w between dt_Agenda and dt_Agenda + (nr_duracao - 1) / 1440
					and	nr_seq_local		= nr_seq_local_p
					and	coalesce(ie_gerado,'N')	= 'N'
					--and	nm_usuario		= nm_usuario_p
					and	nr_seq_pend_agenda	= nr_seq_pendencia_w
					and (nr_seq_atendimento	= nr_seq_atendimento_p or nr_seq_atendimento_p = 0);
							

					if (qt_marcacao_w	> 0) then
						delete 	FROM agenda_quimio_marcacao
						where	dt_agenda_w + 1 /1440 between dt_agenda and dt_agenda + CASE WHEN nr_duracao - 1=0 THEN  1   ELSE nr_duracao - 1 END  / 1440
						and	nr_seq_local		= nr_seq_local_p
						--and	nm_usuario		= nm_usuario_p
						and	nr_seq_pend_agenda	= nr_seq_pendencia_w
						and (nr_seq_atendimento	= nr_seq_atendimento_p or nr_seq_atendimento_p = 0);
						
						ie_gerar_w	:= 'S';
					else
						ds_result_pac_prof_w := Qt_Consistir_Pac_Prof(nr_seq_prof_w, nr_seq_local_p, dt_agenda_w, qt_tempo_prep_pac_w, nm_usuario_p, cd_estabelecimento_p, null, ds_result_pac_prof_w);
						if (ds_result_pac_prof_w = 'M') then
							ie_gerar_w		:= 'E';
							ie_prof_marcado_w	:= 'S';
						elsif (ds_result_pac_prof_w = 'L') then
							ie_gerar_w		:= 'L';
							ie_prof_marcado_w	:= 'S';
						elsif (ds_result_pac_prof_w = 'H') then
							ie_gerar_w		:= 'H';
							ie_prof_marcado_w	:= 'S';
						end if;
					
						if (ie_prof_marcado_w	= 'N') then
							select	count(*)
							into STRICT	qt_pendencia_marcada_w
							from	agenda_quimio_marcacao a
							where	a.nr_seq_pend_agenda	= nr_seq_pendencia_w
							and (a.nr_seq_atendimento	= nr_seq_atendimento_p or nr_seq_atendimento_p = 0)
							and	trunc(a.dt_agenda)		= trunc(dt_agenda_w);
							-- qt_pendencia_marcada_w = 0; qt_marc_dia_agenda_w = 1
							if (qt_pendencia_marcada_w <= qt_marc_dia_agenda_w) then
								select	count(*)
								into STRICT	qt_marcacao_w
								from	agenda_quimio_marcacao a
								where	((dt_agenda_w between dt_agenda and dt_agenda + (nr_duracao - 1) / 1440)
								or	(dt_agenda_w + (qt_tempo_medic_w - 1) / 1440 between dt_agenda and dt_agenda + (nr_duracao - 1) / 1440)
								or	(dt_agenda between dt_agenda_w and dt_agenda_w + (qt_tempo_medic_w - 1) / 1440)
								or	(dt_agenda + (nr_duracao - 1) / 1440 between dt_agenda_w and dt_agenda_w + (qt_tempo_medic_w - 1) / 1440))
								and	nr_seq_local	= nr_seq_local_p
								and	nr_seq_pend_agenda <> nr_seq_pendencia_w
								and (coalesce(ie_gerado, 'X')	= 'N'
								or (coalesce(ie_gerado, 'X')	= 'S'
								and	(a.nr_seq_pend_agenda IS NOT NULL AND a.nr_seq_pend_agenda::text <> '')
								and	not exists (	SELECT	1
											from 	agenda_quimio x
											where 	a.nr_seq_atendimento = x.nr_seq_atendimento 
											and	a.nr_seq_pend_agenda = x.nr_seq_pend_agenda
											and	trunc(x.dt_agenda)   = trunc(a.dt_Agenda)
											and	x.ie_status_agenda in ('F','S', 'C')) ));
								-- qt_marcacao_w = 0
								if (qt_marcacao_w	< qt_marc_dia_agenda_w) then
									select	count(*)
									into STRICT	qt_marcacao_w
									from	agenda_quimio
									where	((dt_agenda_w between dt_agenda and dt_agenda + (nr_minuto_duracao - 1) / 1440)
										or	(dt_agenda_w + (qt_tempo_medic_w - 1) / 1440 between dt_agenda and dt_agenda + (nr_minuto_duracao - 1) / 1440)
										or	(dt_agenda between dt_agenda_w and dt_agenda_w + (qt_tempo_medic_w - 1) / 1440)
										or	(dt_agenda + (nr_minuto_duracao - 1) / 1440 between dt_agenda_w and dt_agenda_w + (qt_tempo_medic_w - 1) / 1440))
										and	nr_seq_local	= nr_seq_local_p
										and	coalesce(nr_seq_pend_agenda,0) <> nr_seq_pendencia_w
										and	ie_status_agenda	not in ('F','S','C');
								end if;
								
								if (qt_marcacao_w	= qt_marc_dia_agenda_w) then
									ie_Gerar_w	:= 'A';
								end if;
								/*
								select	count(max(trunc(dt_horario)))
								into	qt_em_agenda_w
								from	w_agenda_quimio
								where	nr_seq_local	= nr_seq_local_p
								and	nm_usuario	= nm_usuario_p
								and	ie_status = 'EA'
								and	trunc(dt_horario)	= trunc(dt_agenda_w)
								and	nr_seq_pend_agenda = nr_seq_pendencia_w
								group by trunc(dt_horario);
								*/
								select	count(max(trunc(dt_agenda)))
								into STRICT	qt_em_agenda_w
								from	agenda_quimio_marcacao
								where	nr_seq_local	= nr_seq_local_p
								and	nm_usuario	= nm_usuario_p
								--and	ie_status = 'EA'
								and	coalesce(ie_gerado,'N')	= 'N'
								and	trunc(dt_agenda)	= trunc(dt_agenda_w)
								and	nr_seq_pend_agenda = nr_seq_pendencia_w
								and (nr_seq_atendimento	= nr_seq_atendimento_p or nr_seq_atendimento_p = 0)
								group by trunc(dt_agenda);
								
								select	max(dt_horario)
								into STRICT	dt_ultimo_horario_w
								from	w_agenda_quimio
								where	dt_horario between dt_agenda_w and dt_agenda_w + qt_tempo_medic_w / 1440
								and	nr_seq_local	= nr_seq_local_p
								and	nm_usuario	= nm_usuario_p
								and	nr_seq_pend_agenda = nr_seq_pendencia_w;
								
								if (coalesce(dt_ultimo_horario_w::text, '') = '') and (nr_seq_pendencia_w <> nr_seq_pendencia_p) then
									CALL Qt_Gerar_Horario(nr_seq_pendencia_w, null, trunc(dt_agenda_w), nm_usuario_p, qt_tempo_medic_w,
										cd_pessoa_fisica_w ,null, null, nr_seq_local_p,nr_seq_item_w,'');

									select	max(dt_horario)
									into STRICT	dt_ultimo_horario_w
									from	w_agenda_quimio
									where	dt_horario between dt_agenda_w and dt_agenda_w + qt_tempo_medic_w / 1440
									and	nr_seq_local	= nr_seq_local_p
									and	nm_usuario	= nm_usuario_p
									and	nr_seq_pend_agenda = nr_seq_pendencia_w;
								end if;

							else
								ie_Gerar_w	:= 'M';
							end if;
						end if;
						
						if (ie_perm_mesmo_horario_w = 'S') and
							(((dt_agenda_w + qt_tempo_medic_w / 1440) >= (dt_ultimo_horario_w + coalesce(nr_min_apres_local_w,nr_min_apres_w) / 1440)) and (qt_marcacao_w		> 0) or (qt_em_agenda_w		> 0)) then
							ie_tipo_agendamento_w	:= 'E';
							ie_Gerar_w		:= 'X';
						end if;
						
						if ((dt_agenda_w + qt_tempo_medic_w / 1440) > (dt_ultimo_horario_w + coalesce(nr_min_apres_local_w,nr_min_apres_w) / 1440)) then
							ie_Gerar_w		:= 'FT';
						end if;
						
						select	count(*)
						into STRICT	qt_bloqueio_w
						from	w_agenda_quimio
						where	dt_horario between dt_agenda_w and dt_agenda_w +  (qt_tempo_medic_w - 1) / 1440
						and	ie_status = 'B'
						and	nr_seq_local = nr_seq_local_p;
						
						if (ie_consiste_outras_agendas_w = 'S') then
								
							select 	count(*)
							into STRICT	ie_possui_outros_agend_w
							from 	agenda_paciente
							where   cd_pessoa_fisica = cd_pessoa_fisica_w
							and	hr_inicio between trunc(dt_agenda_w) and trunc(dt_agenda_w) + 86399/86400
							and	dt_agenda_w between hr_inicio and (hr_inicio + (nr_minuto_duracao - 1)/ 1440) + (coalesce(qt_tempo_agenda_w,0) / 1440)
							and	ie_status_agenda not in ('C','B');
								
							if (ie_possui_outros_agend_w = 0) then
								select 	count(*)
								into STRICT	ie_possui_outros_agend_w
								from 	agenda_consulta
								where   cd_pessoa_fisica = cd_pessoa_fisica_w
								and	dt_agenda between trunc(dt_agenda_w) and trunc(dt_agenda_w) + 86399/86400
								and	dt_agenda_w between dt_agenda and (dt_agenda + (nr_minuto_duracao - 1) / 1440) + (coalesce(qt_tempo_agenda_w,0) / 1440)
								and	ie_status_agenda not in ('C','B');
							end if;
							if (ie_possui_outros_agend_w > 0) then
								ie_Gerar_w	:= 'JPM'; --Ja possui marcacao para outras agendas!
							end if;
						end if;
											
						if (ie_consiste_dias_anteiores_w = 'S')	then
								select	CASE WHEN count(*)=0 THEN 'N'  ELSE 'S' END  /*Verificar se existem agendamentos anteriores ainda nao marcados*/
								into STRICT	ie_possui_agendas_passadas_w
								from	paciente_atendimento a
								where	a.nr_seq_pend_agenda 	= nr_seq_pendencia_w
								and		nr_seq_atendimento	<> nr_seq_atendimento_w
								and		trunc(coalesce(dt_real,dt_prevista)) < trunc(dt_agenda_w)
								and		not exists (	SELECT	1
													from	agenda_quimio_marcacao x
													where	x.nr_seq_atendimento = a.nr_seq_atendimento);
									
																
								select	min(trunc(dt_prevista))	/*Nao consistir caso seja a primeira data prevista*/
								into STRICT	dt_min_prevista_w
								from	paciente_atendimento
								where	nr_seq_pend_agenda 	= nr_seq_pendencia_w;
												
								
								if (ie_possui_agendas_passadas_w = 'S') then
									ie_Gerar_w	:= 'NPA';
								end if;
						end if;			

						if (qt_pendencia_marcada_w >= qt_marc_dia_agenda_w) and (qt_marc_dia_agenda_w > 0) and (trunc(dt_marcacao_p) = trunc(dt_agenda_w)) then
							begin															
							select	dt_agenda,
								ds_local
							into STRICT	dt_agenda_pendente_w,
								ds_local_w
							from	agenda_quimio_marcacao a,
								qt_local b
							where	a.nr_seq_pend_agenda	= nr_seq_pendencia_w
							and (a.nr_seq_atendimento	= nr_seq_atendimento_p or nr_seq_atendimento_p = 0)
							and	trunc(a.dt_agenda)		= trunc(dt_agenda_w)
							and	not exists (	SELECT	1 
										from 	agenda_quimio b 
										where 	a.nr_seq_atendimento = b.nr_seq_atendimento 
										and 	trunc(a.dt_agenda) = trunc(b.dt_agenda)
										and 	b.ie_status_agenda in ('F','S', 'C'))
							and a.nr_seq_local = b.nr_sequencia  LIMIT 1;
							
							exception
							when others then
								dt_agenda_pendente_w := null;
								ds_local_w := null;
							end;					
							
							if (dt_agenda_pendente_w IS NOT NULL AND dt_agenda_pendente_w::text <> '') and (ds_local_w IS NOT NULL AND ds_local_w::text <> '') then					
								CALL Wheb_mensagem_pck.exibir_mensagem_abort(420815, 'DT_AGENDA_PEND='||to_char(dt_agenda_pendente_w, 'dd/mm/yyyy hh24:mi:ss')
													||';DS_LOCAL='||ds_local_w);
							end if;
						end if;

						if	(((dt_agenda_w + qt_tempo_medic_w / 1440) <= (dt_ultimo_horario_w + coalesce(nr_min_apres_local_w,nr_min_apres_w) / 1440)) and
							((qt_marcacao_w		= 0) and (coalesce(qt_em_agenda_w,0)		< qt_marc_dia_agenda_w)) or (ie_perm_mesmo_horario_w = 'S')) and (qt_pendencia_marcada_w	< qt_marc_dia_agenda_w) and (ie_prof_marcado_w	= 'N') and (qt_bloqueio_w = 0) and (coalesce(ie_Gerar_w,'S') <> 'JPM') and (coalesce(ie_Gerar_w,'S') <> 'FT') and (coalesce(ie_gerar_w,'S') <> 'NPA')	then

							insert into agenda_quimio_marcacao(nr_sequencia,
								dt_agenda,
								nm_usuario,
								nr_seq_local,
								nr_duracao,
								nr_seq_pend_agenda,
								dt_atualizacao,
								dt_atualizacao_nrec,
								nm_usuario_nrec,
								ie_gerado,
								ie_transferencia,
								nr_seq_prof,
								ie_tipo_agendamento,
								nr_seq_Ageint_item,
								nr_seq_atendimento)
							values (nextval('agenda_quimio_marcacao_seq'),
								dt_agenda_w,
								nm_usuario_p,
								nr_seq_local_p,
								qt_tempo_medic_w, 
								nr_seq_pendencia_w,
								clock_timestamp(),
								clock_timestamp(),
								nm_usuario_p,
								'N',
								'N', 
								nr_seq_prof_w,
								ie_tipo_agendamento_w,
								nr_seq_item_w,
								nr_seq_atendimento_w);
							if (ie_Gerar_w	<> 'X') then
								ie_gerar_w	:= 'S';
							end if;
						end if;
					end if;
				end if;
			end if;
		end if;

		ie_gerar_p	:= ie_gerar_w;
		nr_intervalo_w := coalesce(nr_min_apres_local_w,nr_min_apres_w);
		
		if (nr_intervalo_w < qt_tempo_medic_w) then
			if ((qt_tempo_medic_w/nr_intervalo_w) > 2) then
				nr_acrescimo_w := 1;
			end if;
			nr_intervalo_w := nr_intervalo_w * ((qt_tempo_medic_w/nr_intervalo_w) + nr_acrescimo_w);
		end if;

		dt_agenda_w := dt_agenda_w + (TRUNC(nr_intervalo_w)/(24*60));

		commit;

	end;
	end loop;
	close C02;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE qt_atualizar_dados_marcacao ( nr_seq_pendencia_p bigint, nr_seq_atendimento_p bigint, dt_agenda_p timestamp, nm_usuario_p text, nr_seq_local_p bigint, cd_estabelecimento_p bigint, nr_seq_item_p bigint default null, ie_gerar_p INOUT text DEFAULT NULL, nr_seq_prof_p bigint default null, ie_consiste_estab_p text DEFAULT NULL, dt_marcacao_p timestamp default null, ie_valida_agrupamento_p text default 'N') FROM PUBLIC;

