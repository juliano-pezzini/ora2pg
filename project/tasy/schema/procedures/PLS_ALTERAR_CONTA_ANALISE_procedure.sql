-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_alterar_conta_analise ( nr_seq_analise_p bigint, nr_seq_segurado_p bigint, nr_seq_prestador_exec_p bigint, nr_seq_prestador_solic_p bigint, ie_carater_internacao_p text, nr_seq_saida_int_p bigint, ie_obito_mulher_p text, qt_nasc_mortos_p bigint, qt_nasc_vivos_termo_p bigint, qt_nasc_vivos_prematuros_p bigint, qt_obito_precoce_p bigint, qt_obito_tardio_p bigint, cd_doenca_p text, nr_declaracao_obito_p text, ie_tipo_guia_p text, nr_seq_clinica_p bigint, ie_regime_internacao_p text, ie_indicacao_acidente_p text, nr_seq_tipo_acomodacao_p bigint, nr_seq_saida_spsadt_p bigint, nr_seq_tipo_atendimento_p bigint, ie_tipo_doenca_p text, nr_seq_saida_consulta_p bigint, ie_tipo_consulta_p text, nr_seq_conta_p bigint, nr_seq_grupo_p bigint, cd_estabelecimento_p bigint, dt_atendimento_p text, dt_entrada_p text, dt_alta_p text, cd_senha_externa_p text, cd_medico_executor_p bigint, cd_medico_solicitante_p bigint, cd_doenca_alta_p text, ds_indicacao_clinica_p text, nr_seq_cbo_saude_p bigint, nr_seq_cbo_saude_solic_p bigint, nr_seq_grau_partic_p bigint, nm_usuario_p text, ds_observacao_p text, ie_gestacao_p text, ie_aborto_p text, ie_parto_normal_p text, ie_complicacao_puerperio_p text, ie_complicacao_neonatal_p text, ie_parto_cesaria_p text, ie_baixo_peso_p text, ie_atend_rn_sala_parto_p text, ie_transtorno_p text, nr_seq_tipo_conta_p bigint) AS $body$
DECLARE


ds_observacao_w			varchar(4000) := '';
nr_seq_segurado_w		bigint;
nr_seq_prestador_exec_w		bigint;
nr_seq_prestador_solic_w	bigint;
ie_carater_internacao_w		varchar(10);
nr_seq_saida_int_w		bigint;
ie_obito_mulher_w		varchar(10);
qt_nasc_mortos_w		bigint;
qt_nasc_vivos_termo_w		bigint;
qt_nasc_vivos_prematuros_w	bigint;
qt_obito_precoce_w		bigint;
qt_obito_tardio_w		bigint;
cd_doenca_w			varchar(10);
nr_declaracao_obito_w		varchar(10);
ie_tipo_guia_w			varchar(10);
nr_seq_clinica_w		bigint;
ie_regime_internacao_w		varchar(10);
ie_indicacao_acidente_w		varchar(10);
nr_seq_tipo_acomodacao_w	bigint;
nr_seq_saida_spsadt_w		bigint;
nr_seq_tipo_atendimento_w	bigint;
ie_tipo_doenca_w		varchar(10);
nr_seq_saida_consulta_w		bigint;
ie_tipo_consulta_w		varchar(10);
nm_segurado_w			varchar(255);
cd_usuario_plano_w		varchar(255);
nm_prestador_exec_w		varchar(255);
nm_segurado_ww			varchar(255);
cd_usuario_plano_ww		varchar(255);
nm_prestador_exec_ww		varchar(255);
nr_seq_protocolo_alt_w		bigint;
nr_seq_diagostico_w		bigint;
ie_origem_analise_w		bigint;
dt_atendimento_w		timestamp;
dt_entrada_w			timestamp;
dt_alta_w			timestamp;
dt_atendimento_ww		timestamp;
dt_entrada_ww			timestamp;
dt_alta_ww			timestamp;
cd_doenca_alta_w		varchar(20);
cd_senha_externa_w		varchar(30);
cd_medico_executor_w		bigint;
cd_medico_solicitante_w		bigint;
ds_indicacao_clinica_w		varchar(500);
nr_seq_cbo_saude_w		bigint;
nr_seq_cbo_saude_solic_w	bigint;
ds_observacao_ww		varchar(500);
ie_parametro_w			varchar(2);
nm_medico_executor_w		varchar(255);
nm_medico_executor_ww		varchar(255);
nm_medico_solic_w		varchar(255);
nm_medico_solic_ww		varchar(255);
ie_gestacao_w			varchar(1);
ie_aborto_w			varchar(1);
ie_parto_normal_w               varchar(1);
ie_complicacao_puerperio_w	varchar(1);
ie_complicacao_neonatal_w       varchar(1);
ie_parto_cesaria_w		varchar(1);
ie_baixo_peso_w                 varchar(1);
ie_atend_rn_sala_parto_w        varchar(1);
ie_transtorno_w			varchar(1);
nr_seq_grau_partic_w		bigint;


BEGIN

if (coalesce(ie_tipo_guia_p, 0) = 0) then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(179964);
	--'Por favor insira um tipo guia válido.'
end if;

if (coalesce(nr_seq_segurado_p, 0) = 0) then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(179965);
	--'Por favor insira um beneficiário válido.'
end if;

if (pls_validar_padrao(dt_atendimento_p, '00/00/0000 00:00:00') = 'S') then
	dt_atendimento_w := to_date(dt_atendimento_p,'dd/mm/yyyy hh24:mi:ss');
elsif (pls_validar_padrao(dt_atendimento_p, '00/00/0000') = 'S') then
	dt_atendimento_w := to_date(substr(dt_atendimento_p,1,10),'dd/mm/yyyy');
else
	dt_atendimento_w := null;
end if;

if (pls_validar_padrao(dt_entrada_p, '00/00/0000 00:00:00') = 'S') then
	dt_entrada_w := to_date(dt_entrada_p,'dd/mm/yyyy hh24:mi:ss');
elsif (pls_validar_padrao(dt_entrada_p, '00/00/0000') = 'S') then
	dt_entrada_w := to_date(substr(dt_entrada_p,1,10),'dd/mm/yyyy');
else
	dt_entrada_w := null;
end if;

if (pls_validar_padrao(dt_alta_p, '00/00/0000 00:00:00') = 'S') then
	dt_alta_w := to_date(dt_alta_p,'dd/mm/yyyy hh24:mi:ss');
elsif (pls_validar_padrao(dt_alta_p, '00/00/0000') = 'S') then
	dt_alta_w := to_date(substr(dt_alta_p,1,10),'dd/mm/yyyy');
else
	dt_alta_w := null;
end if;

select	nr_seq_segurado,
	nr_seq_prestador_exec,
	nr_seq_prestador,
	qt_nasc_mortos,
	qt_nasc_vivos_termo,
	qt_nasc_vivos_prematuros,
	qt_obito_precoce,
	qt_obito_tardio,
	nr_seq_saida_int,
	nr_seq_tipo_acomodacao,
	nr_seq_saida_spsadt,
	nr_seq_tipo_atendimento,
	nr_seq_clinica,
	nr_seq_saida_consulta,
	ie_carater_internacao,
	ie_obito_mulher,
	ie_tipo_guia,
	ie_regime_internacao,
	ie_indicacao_acidente,
	ie_tipo_doenca,
	ie_tipo_consulta,
	dt_atendimento,
	dt_entrada,
	dt_alta,
	cd_senha_externa,
	cd_medico_executor,
	cd_medico_solicitante,
	ds_indicacao_clinica,
	nr_seq_cbo_saude,
	nr_seq_cbo_saude_solic,
	ds_observacao,
	ie_gestacao,
	ie_aborto,
	ie_parto_normal,
	ie_complicacao_puerperio,
	ie_complicacao_neonatal,
	ie_parto_cesaria,
	ie_baixo_peso,
	ie_atend_rn_sala_parto,
	ie_transtorno,
	nr_seq_grau_partic
into STRICT	nr_seq_segurado_w,
	nr_seq_prestador_exec_w,
	nr_seq_prestador_solic_w,
	qt_nasc_mortos_w,
	qt_nasc_vivos_termo_w,
	qt_nasc_vivos_prematuros_w,
	qt_obito_precoce_w,
	qt_obito_tardio_w,
	nr_seq_saida_int_w,
	nr_seq_tipo_acomodacao_w,
	nr_seq_saida_spsadt_w,
	nr_seq_tipo_atendimento_w,
	nr_seq_clinica_w,
	nr_seq_saida_consulta_w,
	ie_carater_internacao_w,
	ie_obito_mulher_w,
	ie_tipo_guia_w,
	ie_regime_internacao_w,
	ie_indicacao_acidente_w,
	ie_tipo_doenca_w,
	ie_tipo_consulta_w,
	dt_atendimento_ww,
	dt_entrada_ww,
	dt_alta_ww,
	cd_senha_externa_w,
	cd_medico_executor_w,
	cd_medico_solicitante_w,
	ds_indicacao_clinica_w,
	nr_seq_cbo_saude_w,
	nr_seq_cbo_saude_solic_w,
	ds_observacao_ww,
	ie_gestacao_w,
	ie_aborto_w,
	ie_parto_normal_w,
	ie_complicacao_puerperio_w,
	ie_complicacao_neonatal_w,
	ie_parto_cesaria_w,
	ie_baixo_peso_w,
	ie_atend_rn_sala_parto_w,
	ie_transtorno_w,
	nr_seq_grau_partic_w
from	pls_conta
where	nr_sequencia	= nr_seq_conta_p;

nm_segurado_w		:= pls_obter_dados_segurado(nr_seq_segurado_p, 'N');
cd_usuario_plano_w	:= pls_obter_dados_segurado(nr_seq_segurado_p, 'C');
nm_prestador_exec_w	:= pls_obter_dados_prestador(nr_seq_prestador_exec_p, 'N');

nm_segurado_ww		:= pls_obter_dados_segurado(nr_seq_segurado_w, 'N');
cd_usuario_plano_ww	:= pls_obter_dados_segurado(nr_seq_segurado_w, 'C');
nm_prestador_exec_ww	:= pls_obter_dados_prestador(nr_seq_prestador_exec_w, 'N');

update	pls_analise_conta
set	nr_seq_segurado = nr_seq_segurado_p,
	nm_segurado	= nm_segurado_w
where	nr_sequencia	= nr_seq_analise_p;

if (ie_tipo_guia_w = '6') then

	update	pls_conta
	set	nr_seq_prestador_exec		= nr_seq_prestador_exec_p,
		cd_medico_executor		= cd_medico_executor_p,
		nr_seq_cbo_saude		= nr_seq_cbo_saude_p,
		nr_seq_tipo_acomodacao		= nr_seq_tipo_acomodacao_p,
		nr_seq_grau_partic		= nr_seq_grau_partic_p,
		nr_seq_tipo_conta		= nr_seq_tipo_conta_p
	where	nr_sequencia			= nr_seq_conta_p;

	if (coalesce(nr_seq_prestador_exec_p,0) <> coalesce(nr_seq_prestador_exec_w,0)) then
		ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
					'Prestador executor: '||chr(13)||chr(10)||
					chr(9)||'Anterior: '||pls_obter_dados_prestador(nr_seq_prestador_exec_w,'N')||' - Modificado: '||pls_obter_dados_prestador(nr_seq_prestador_exec_p,'N')||chr(13)||chr(10);
	end if;

	if (coalesce(cd_medico_executor_p,0) <> coalesce(cd_medico_executor_w,0)) then

		if (coalesce(cd_medico_executor_w,0) <> 0) then
			nm_medico_executor_w	:= obter_nome_medico(cd_medico_executor_w,'N');
		else
			nm_medico_executor_w	:= '          ';
		end if;

		if (coalesce(cd_medico_executor_p,0) <> 0) then
			nm_medico_executor_ww	:= obter_nome_medico(cd_medico_executor_p,'N');
		else
			nm_medico_executor_ww	:= '          ';
		end if;

		ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
					'Profissional executor: '||chr(13)||chr(10)||
					chr(9)||'Anterior: '||nm_medico_executor_w||' - Modificado: '||nm_medico_executor_ww||chr(13)||chr(10);
	end if;

	if (coalesce(nr_seq_cbo_saude_p,0) <> coalesce(nr_seq_cbo_saude_w,0)) then
		ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
					'CBO executor: '||chr(13)||chr(10)||
					chr(9)||'Anterior: '||substr(obter_codigo_cbo_saude(nr_seq_cbo_saude_w),1,15)||' - '||substr(obter_cbo_saude(nr_seq_cbo_saude_w),1,80)||' - Modificado: '||substr(obter_codigo_cbo_saude(nr_seq_cbo_saude_p),1,15)||' - '||substr(obter_cbo_saude(nr_seq_cbo_saude_p),1,80)||chr(13)||chr(10);
	end if;

	if (coalesce(nr_seq_tipo_acomodacao_p,0) <> coalesce(nr_seq_tipo_acomodacao_w,0)) then
		ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
					'Acomodação: '||chr(13)||chr(10)||
					chr(9)||'Anterior: '||pls_obter_desc_tipo_acomodacao(nr_seq_tipo_acomodacao_w)||' - Modificado: '||pls_obter_desc_tipo_acomodacao(nr_seq_tipo_acomodacao_p)||chr(13)||chr(10);
	end if;

	if (coalesce(nr_seq_grau_partic_p,0) <> coalesce(nr_seq_grau_partic_w,0)) then
		ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
					'Grau de participação: '||chr(13)||chr(10)||
					chr(9)||'Anterior: '||pls_obter_ds_grau_participacao(nr_seq_grau_partic_w)||' - Modificado: '||pls_obter_ds_grau_participacao(nr_seq_grau_partic_p)||chr(13)||chr(10);
	end if;

elsif (ie_tipo_guia_w = '5') then

	select	max(nr_sequencia)
	into STRICT	nr_seq_diagostico_w
	from	pls_diagnostico_conta
	where	ie_classificacao		= 'P'
	and	nr_seq_conta			= nr_seq_conta_p;

	select	max(cd_doenca)
	into STRICT	cd_doenca_alta_w
	from	pls_diagnostico_conta
	where	nr_sequencia			= nr_seq_diagostico_w;

	if (coalesce(nr_seq_diagostico_w,0) > 0) then
		update	pls_diagnostico_conta
		set	cd_doenca			= cd_doenca_alta_p
		where	nr_sequencia			= nr_seq_diagostico_w;
	else
		insert into pls_diagnostico_conta(cd_doenca, ds_diagnostico, dt_atualizacao,
			dt_atualizacao_nrec, ie_classificacao, ie_estagio_complemento,
			ie_indicacao_acidente, ie_tipo_doenca, nm_usuario,
			nm_usuario_nrec, nr_seq_conta, nr_sequencia)
		values (cd_doenca_alta_p, '', clock_timestamp(),
			 clock_timestamp(), 'P', null,
			 null, null, nm_usuario_p,
			 nm_usuario_p, nr_seq_conta_p, nextval('pls_diagnostico_conta_seq'));
	end if;

	select	max(nr_sequencia)
	into STRICT	nr_seq_diagostico_w
	from	pls_diagnost_conta_obito
	where	nr_seq_conta			= nr_seq_conta_p;

	select	max(cd_doenca)
	into STRICT	cd_doenca_w
	from	pls_diagnost_conta_obito
	where	nr_sequencia			= nr_seq_diagostico_w;

	if (coalesce(nr_seq_diagostico_w,0) > 0) then
		update	pls_diagnost_conta_obito
		set	cd_doenca			= cd_doenca_p,
			nr_declaracao_obito		= nr_declaracao_obito_p
		where	nr_seq_conta			= nr_seq_conta_p;
	else
		insert into pls_diagnost_conta_obito(cd_doenca, dt_atualizacao,
			dt_atualizacao_nrec, nm_usuario, nr_declaracao_obito,
			nr_seq_conta, nr_sequencia, nm_usuario_nrec)
		values (cd_doenca_p, clock_timestamp(),
			clock_timestamp(), nm_usuario_p, nr_declaracao_obito_p,
			nr_seq_conta_p, nextval('pls_diagnost_conta_obito_seq'), nm_usuario_p);
	end if;

	update	pls_conta
	set	ie_tipo_guia			= ie_tipo_guia_p,
		nr_seq_segurado			= nr_seq_segurado_p,
		nr_seq_prestador_exec		= nr_seq_prestador_exec_p,
		nr_seq_prestador		= nr_seq_prestador_solic_p,
		qt_nasc_mortos			= qt_nasc_mortos_p,
		qt_nasc_vivos_termo		= qt_nasc_vivos_termo_p,
		qt_nasc_vivos_prematuros	= qt_nasc_vivos_prematuros_p,
		qt_obito_precoce		= qt_obito_precoce_p,
		qt_obito_tardio			= qt_obito_tardio_p,
		nr_seq_saida_int		= nr_seq_saida_int_p,
		nr_seq_tipo_acomodacao		= nr_seq_tipo_acomodacao_p,
		ie_carater_internacao		= ie_carater_internacao_p,
		ie_obito_mulher			= ie_obito_mulher_p,
		ie_regime_internacao		= ie_regime_internacao_p,
		dt_entrada			= dt_entrada_w,
		dt_alta				= dt_alta_w,
		cd_senha_externa		= cd_senha_externa_p,
		nr_seq_tipo_atendimento		= nr_seq_tipo_atendimento_p,
		ds_observacao			= ds_observacao_p,
		nr_seq_clinica			= nr_seq_clinica_p,
		ie_gestacao			= ie_gestacao_p,
		ie_aborto			= ie_aborto_p,
		ie_parto_normal			= ie_parto_normal_p,
		ie_complicacao_puerperio	= ie_complicacao_puerperio_p,
		ie_complicacao_neonatal		= ie_Complicacao_neonatal_p,
		ie_parto_cesaria		= ie_parto_cesaria_p,
		ie_baixo_peso			= ie_baixo_peso_p,
		ie_atend_rn_sala_parto		= ie_atend_rn_sala_parto_p,
		ie_transtorno			= ie_transtorno_p,
		nr_seq_tipo_conta		= nr_seq_tipo_conta_p
	where	nr_sequencia			= nr_seq_conta_p;

	if (coalesce(ie_tipo_guia_p,'X') <> coalesce(ie_tipo_guia_w,'X')) then
		ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
					'Tipo guia: '||chr(13)||chr(10)||
					chr(9)||'Anterior: '||obter_valor_dominio(1746, ie_tipo_guia_w)||' - Modificada: '||obter_valor_dominio(1746, ie_tipo_guia_p);

		nr_seq_protocolo_alt_w := pls_alterar_tipo_guia_conta(nr_seq_conta_p, ie_tipo_guia_p, nr_seq_protocolo_alt_w, cd_estabelecimento_p, nm_usuario_p);

		ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
					chr(9)||'Conta modificada para constar no protocolo '||nr_seq_protocolo_alt_w||'.';
	end if;

	if (coalesce(nr_seq_segurado_p,0) <> coalesce(nr_seq_segurado_w,0)) then
		ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
					'Segurado: '||chr(13)||chr(10)||
					chr(9)||'Anterior: '||pls_obter_dados_segurado(nr_seq_segurado_w,'N')||' - Modificado: '||pls_obter_dados_segurado(nr_seq_segurado_p,'N')||chr(13)||chr(10);
	end if;

	if (coalesce(nr_seq_prestador_exec_p,0) <> coalesce(nr_seq_prestador_exec_w,0)) then
		ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
					'Prestador executor: '||chr(13)||chr(10)||
					chr(9)||'Anterior: '||pls_obter_dados_prestador(nr_seq_prestador_exec_w,'N')||' - Modificado: '||pls_obter_dados_prestador(nr_seq_prestador_exec_p,'N')||chr(13)||chr(10);
	end if;

	if (coalesce(nr_seq_prestador_solic_p,0) <> coalesce(nr_seq_prestador_solic_w,0)) then
		ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
					'Prestador solicitante: '||chr(13)||chr(10)||
					chr(9)||'Anterior: '||pls_obter_dados_prestador(nr_seq_prestador_solic_w,'N')||' - Modificado: '||pls_obter_dados_prestador(nr_seq_prestador_solic_p,'N')||chr(13)||chr(10);
	end if;

	if (coalesce(qt_nasc_mortos_p,0) <> coalesce(qt_nasc_mortos_w,0)) then
		ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
					'Qt. Nasc. mortos:: '||chr(13)||chr(10)||
					chr(9)||'Anterior: '||qt_nasc_mortos_w||' - Modificado: '||qt_nasc_mortos_p||chr(13)||chr(10);
	end if;

	if (coalesce(qt_nasc_vivos_termo_p,0) <> coalesce(qt_nasc_vivos_termo_w,0)) then
		ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
					'Qt. Nasc. vivos a termo: '||chr(13)||chr(10)||
					chr(9)||'Anterior: '||qt_nasc_vivos_termo_w||' - Modificado: '||qt_nasc_vivos_termo_p||chr(13)||chr(10);
	end if;

	if (coalesce(qt_nasc_vivos_prematuros_p,0) <> coalesce(qt_nasc_vivos_prematuros_w,0)) then
		ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
					'Qt. Nasc. vivos prematuro: '||chr(13)||chr(10)||
					chr(9)||'Anterior: '||qt_nasc_vivos_prematuros_w||' - Modificado: '||qt_nasc_vivos_prematuros_p||chr(13)||chr(10);
	end if;

	if (coalesce(qt_obito_precoce_p,0) <> coalesce(qt_obito_precoce_w,0)) then
		ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
					'Qt. óbito neonatal Precoce: '||chr(13)||chr(10)||
					chr(9)||'Anterior: '||qt_obito_precoce_w||' - Modificado: '||qt_obito_precoce_p||chr(13)||chr(10);
	end if;

	if (coalesce(qt_obito_tardio_p,0) <> coalesce(qt_obito_tardio_w,0)) then
		ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
					'Qt. óbito neonatal Tardio: '||chr(13)||chr(10)||
					chr(9)||'Anterior: '||qt_obito_tardio_w||' - Modificado: '||qt_obito_tardio_p||chr(13)||chr(10);
	end if;

	if (coalesce(nr_seq_saida_int_p,0) <> coalesce(nr_seq_saida_int_w,0)) then
		ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
					'Motivo saída: '||chr(13)||chr(10)||
					chr(9)||'Anterior: '||pls_obter_desc_mot_saida_int(nr_seq_saida_int_w)||' - Modificado: '||pls_obter_desc_mot_saida_int(nr_seq_saida_int_p)||chr(13)||chr(10);
	end if;

	if (coalesce(nr_seq_tipo_acomodacao_p,0) <> coalesce(nr_seq_tipo_acomodacao_w,0)) then
		ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
					'Acomodação: '||chr(13)||chr(10)||
					chr(9)||'Anterior: '||pls_obter_desc_tipo_acomodacao(nr_seq_tipo_acomodacao_w)||' - Modificado: '||pls_obter_desc_tipo_acomodacao(nr_seq_tipo_acomodacao_p)||chr(13)||chr(10);
	end if;

	if (coalesce(nr_seq_tipo_atendimento_p,0) <> coalesce(nr_seq_tipo_atendimento_w,0)) then
		ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
					'Tipo atendimento: '||chr(13)||chr(10)||
					chr(9)||'Anterior: '||pls_obter_desc_tipo_atend(nr_seq_tipo_atendimento_w)||' - Modificado: '||pls_obter_desc_tipo_atend(nr_seq_tipo_atendimento_p)||chr(13)||chr(10);
	end if;

	if (coalesce(to_char(dt_entrada_ww, 'dd/mm/yyyy hh24:mi:ss'),'X') <> coalesce(to_char(dt_entrada_w, 'dd/mm/yyyy hh24:mi:ss'),'X')) then
		ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
					'Data de entrada: '||chr(13)||chr(10)||
					chr(9)||'Anterior: '||to_char(dt_entrada_ww, 'dd/mm/yyyy hh24:mi:ss')||' - Modificado: '||to_char(dt_entrada_w, 'dd/mm/yyyy hh24:mi:ss')||chr(13)||chr(10);
	end if;

	if (coalesce(to_char(dt_alta_w, 'dd/mm/yyyy hh24:mi:ss'),'X') <> coalesce(to_char(dt_alta_ww, 'dd/mm/yyyy hh24:mi:ss'),'X')) then
		ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
					'Data de alta: '||chr(13)||chr(10)||
					chr(9)	||'Anterior: '||to_char(dt_alta_ww, 'dd/mm/yyyy hh24:mi:ss')||' - Modificado: '||to_char(dt_alta_w, 'dd/mm/yyyy hh24:mi:ss')||chr(13)||chr(10);
	end if;

	if (coalesce(cd_senha_externa_p,'X') <> coalesce(cd_senha_externa_w,'X')) then
		ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
					'Senha externa: '||chr(13)||chr(10)||
					chr(9)||'Anterior: '||cd_senha_externa_w||' - Modificado: '||cd_senha_externa_p||chr(13)||chr(10);
	end if;

	if (coalesce(cd_doenca_alta_p,'X') <> coalesce(cd_doenca_alta_w,'X')) then
		ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
					'CID Alta: '||chr(13)||chr(10)||
					chr(9)||'Anterior: '||cd_doenca_alta_w||' - '||obter_desc_cid(cd_doenca_alta_w)||' - Modificado: '||cd_doenca_alta_p||' - '||obter_desc_cid(cd_doenca_alta_p)||chr(13)||chr(10);
	end if;

	if (coalesce(cd_doenca_p,'X') <> coalesce(cd_doenca_w,'X')) then
		ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
					'CID óbito: '||chr(13)||chr(10)||
					chr(9)||'Anterior: '||cd_doenca_w||' - '||obter_desc_cid(cd_doenca_w)||' - Modificado: '||cd_doenca_p||' - '||obter_desc_cid(cd_doenca_p)||chr(13)||chr(10);
	end if;

	if (coalesce(ds_observacao_p,'X') <> coalesce(ds_observacao_ww,'X')) then
		ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
					'Observação: '||chr(13)||chr(10)||
					chr(9)||'Anterior: '||replace(trim(both ds_observacao_ww),chr(13)||chr(10),' ')||''||' - Modificado : '||replace(trim(both ds_observacao_p),chr(13)||chr(10),' ')||chr(13)||chr(10);
	end if;

	if (coalesce(ie_gestacao_p,'X') <> coalesce(ie_gestacao_w,'X')) then
		ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
					'Se gestação: '||chr(13)||chr(10)||
					chr(9)||'Anterior: '||ie_gestacao_w||' - Modificado: '||ie_gestacao_p||chr(13)||chr(10);
	end if;

	if (coalesce(ie_aborto_p,'X') <> coalesce(ie_aborto_w,'X')) then
		ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
					'Aborto: '||chr(13)||chr(10)||
					chr(9)||'Anterior: '||ie_aborto_w||' - Modificado: '||ie_aborto_p||chr(13)||chr(10);
	end if;

	if (coalesce(ie_parto_normal_p,'X') <> coalesce(ie_parto_normal_w,'X')) then
		ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
					'Parto normal: '||chr(13)||chr(10)||
					chr(9)||'Anterior: '||ie_parto_normal_w||' - Modificado: '||ie_parto_normal_p||chr(13)||chr(10);
	end if;

	if (coalesce(ie_complicacao_puerperio_p,'X') <> coalesce(ie_complicacao_puerperio_w,'X')) then
		ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
					'Complic puerpério: '||chr(13)||chr(10)||
					chr(9)||'Anterior: '||ie_complicacao_puerperio_w||' - Modificado: '||ie_complicacao_puerperio_p||chr(13)||chr(10);
	end if;

	if (coalesce(ie_complicacao_neonatal_p,'X') <> coalesce(ie_complicacao_neonatal_w,'X')) then
		ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
					'Complic neonatal: '||chr(13)||chr(10)||
					chr(9)||'Anterior: '||ie_complicacao_neonatal_w||' - Modificado: '||ie_complicacao_neonatal_p||chr(13)||chr(10);
	end if;

	if (coalesce(ie_parto_cesaria_p,'X') <> coalesce(ie_parto_cesaria_w,'X')) then
		ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
					'Parto cesáreo: '||chr(13)||chr(10)||
					chr(9)||'Anterior: '||ie_parto_cesaria_w||' - Modificado: '||ie_parto_cesaria_p||chr(13)||chr(10);
	end if;

	if (coalesce(ie_baixo_peso_p,'X') <> coalesce(ie_baixo_peso_w,'X')) then
		ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
					'Baixo peso: '||chr(13)||chr(10)||
					chr(9)||'Anterior: '||ie_baixo_peso_w||' - Modificado: '||ie_baixo_peso_p||chr(13)||chr(10);
	end if;

	if (coalesce(ie_atend_rn_sala_parto_p,'X') <> coalesce(ie_atend_rn_sala_parto_w,'X')) then
		ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
					'Atendimento ao RN em sala de parto: '||chr(13)||chr(10)||
					chr(9)||'Anterior: '||ie_atend_rn_sala_parto_w||' - Modificado: '||ie_atend_rn_sala_parto_p||chr(13)||chr(10);
	end if;

	if (coalesce(ie_transtorno_p,'X') <> coalesce(ie_transtorno_w,'X')) then
		ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
					'Transtorno materno relac a gravidez: '||chr(13)||chr(10)||
					chr(9)||'Anterior: '||ie_transtorno_w||' - Modificado: '||ie_transtorno_p||chr(13)||chr(10);
	end if;

elsif (ie_tipo_guia_w = '4') then

	select	max(nr_sequencia)
	into STRICT	nr_seq_diagostico_w
	from	pls_diagnostico_conta
	where	ie_classificacao		= 'P'
	and	nr_seq_conta			= nr_seq_conta_p;

	select	max(cd_doenca)
	into STRICT	cd_doenca_alta_w
	from	pls_diagnostico_conta
	where	nr_sequencia			= nr_seq_diagostico_w;

	if (coalesce(nr_seq_diagostico_w,0) > 0) then
		update	pls_diagnostico_conta
		set	cd_doenca			= cd_doenca_alta_p
		where	nr_sequencia			= nr_seq_diagostico_w;
	else
		insert into pls_diagnostico_conta(cd_doenca, ds_diagnostico, dt_atualizacao,
			dt_atualizacao_nrec, ie_classificacao, ie_estagio_complemento,
			ie_indicacao_acidente, ie_tipo_doenca, nm_usuario,
			nm_usuario_nrec, nr_seq_conta, nr_sequencia)
		values (cd_doenca_alta_p, '', clock_timestamp(),
			 clock_timestamp(), 'P', null,
			 null, null, nm_usuario_p,
			 nm_usuario_p, nr_seq_conta_p, nextval('pls_diagnostico_conta_seq'));
	end if;

	update	pls_conta
	set	nr_seq_segurado			= nr_seq_segurado_p,
		ie_tipo_guia			= ie_tipo_guia_p,
		nr_seq_prestador_exec		= nr_seq_prestador_exec_p,
		nr_seq_prestador		= nr_seq_prestador_solic_p,
		cd_senha_externa		= cd_senha_externa_p,
		cd_medico_executor		= cd_medico_executor_p,
		cd_medico_solicitante		= cd_medico_solicitante_p,
		nr_seq_saida_spsadt		= nr_seq_saida_spsadt_p,
		nr_seq_tipo_atendimento		= nr_seq_tipo_atendimento_p,
		ie_carater_internacao		= ie_carater_internacao_p,
		ie_indicacao_acidente		= ie_indicacao_acidente_p,
		ie_tipo_doenca			= ie_tipo_doenca_p,
		ds_indicacao_clinica		= substr(ds_indicacao_clinica_p,1,255),
		dt_atendimento			= dt_atendimento_w,
		dt_emissao			= dt_atendimento_w,
		nr_seq_cbo_saude		= nr_seq_cbo_saude_p,
		nr_seq_cbo_saude_solic		= nr_seq_cbo_saude_solic_p,
		ds_observacao			= ds_observacao_p,
		nr_seq_grau_partic		= nr_seq_grau_partic_p,
		nr_seq_tipo_conta		= nr_seq_tipo_conta_p,
		ie_tipo_consulta		= ie_tipo_consulta_p
	where	nr_sequencia			= nr_seq_conta_p;

	if (coalesce(ie_tipo_guia_p,'X') <> coalesce(ie_tipo_guia_w,'X')) then
		ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
					'Tipo guia: '||chr(13)||chr(10)||
					chr(9)||'Anterior: '||obter_valor_dominio(1746, ie_tipo_guia_w)||' - Modificada: '||obter_valor_dominio(1746, ie_tipo_guia_p)||chr(13)||chr(10);

		nr_seq_protocolo_alt_w := pls_alterar_tipo_guia_conta(nr_seq_conta_p, ie_tipo_guia_p, nr_seq_protocolo_alt_w, cd_estabelecimento_p, nm_usuario_p);

		ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
					chr(9)||'Conta modificada para constar no protocolo '||nr_seq_protocolo_alt_w||'.'||chr(13)||chr(10);
	end if;

	if (coalesce(nr_seq_segurado_p,0) <> coalesce(nr_seq_segurado_w,0)) then
		ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
					'Segurado: '||chr(13)||chr(10)||
					chr(9)||'Anterior: '||pls_obter_dados_segurado(nr_seq_segurado_w,'N')||' - Modificado: '||pls_obter_dados_segurado(nr_seq_segurado_p,'N')||chr(13)||chr(10);
	end if;

	if (coalesce(cd_doenca_p,'X') <> coalesce(cd_doenca_w,'X')) then
		ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
					'CID Principal: '||chr(13)||chr(10)||
					chr(9)||'Anterior: '||cd_doenca_w||' - '||obter_desc_cid(cd_doenca_w)||' - Modificado: '||cd_doenca_p||' - '||obter_desc_cid(cd_doenca_p)||chr(13)||chr(10);
	end if;

	if (coalesce(nr_seq_prestador_exec_p,0) <> coalesce(nr_seq_prestador_exec_w,0)) then
		ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
					'Prestador executor: '||chr(13)||chr(10)||
					chr(9)||'Anterior: '||pls_obter_dados_prestador(nr_seq_prestador_exec_w,'N')||' - Modificado: '||pls_obter_dados_prestador(nr_seq_prestador_exec_p,'N')||chr(13)||chr(10);
	end if;

	if (coalesce(nr_seq_prestador_solic_p,0) <> coalesce(nr_seq_prestador_solic_w,0)) then
		ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
					'Prestador solicitante: '||chr(13)||chr(10)||
					chr(9)||'Anterior: '||pls_obter_dados_prestador(nr_seq_prestador_solic_w,'N')||' - Modificado: '||pls_obter_dados_prestador(nr_seq_prestador_solic_p,'N')||chr(13)||chr(10);
	end if;

	if (coalesce(cd_senha_externa_p,'X') <> coalesce(cd_senha_externa_w,'X')) then
		ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
					'Senha externa: '||chr(13)||chr(10)||
					chr(9)||'Anterior: '||cd_senha_externa_w||' - Modificado: '||cd_senha_externa_p||chr(13)||chr(10);
	end if;

	if (coalesce(cd_medico_executor_p,0) <> coalesce(cd_medico_executor_w,0)) then

		if (coalesce(cd_medico_executor_w,0) <> 0) then
			nm_medico_executor_w	:= obter_nome_medico(cd_medico_executor_w,'N');
		else
			nm_medico_executor_w	:= '          ';
		end if;

		if (coalesce(cd_medico_executor_p,0) <> 0) then
			nm_medico_executor_ww	:= obter_nome_medico(cd_medico_executor_p,'N');
		else
			nm_medico_executor_ww	:= '          ';
		end if;

		ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
					'Profissional executor: '||chr(13)||chr(10)||
					chr(9)||'Anterior: '||nm_medico_executor_w||' - Modificado: '||nm_medico_executor_ww||chr(13)||chr(10);
	end if;

	if (coalesce(cd_medico_solicitante_p,0) <> coalesce(cd_medico_solicitante_w,0)) then
		if (coalesce(cd_medico_solicitante_w,0) <> 0) then
			nm_medico_solic_w	:= obter_nome_medico(cd_medico_solicitante_w,'N');
		else
			nm_medico_solic_w	:= '          ';
		end if;

		if (coalesce(cd_medico_solicitante_p,0) <> 0) then
			nm_medico_solic_ww	:= obter_nome_medico(cd_medico_solicitante_p,'N');
		else
			nm_medico_solic_ww	:= '          ';
		end if;

		ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
					'Profissional solicitante: '||chr(13)||chr(10)||
					chr(9)||'Anterior: '||nm_medico_solic_w||' - Modificado: '||nm_medico_solic_ww||chr(13)||chr(10);

	end if;

	if (coalesce(nr_seq_saida_spsadt_p,0) <> coalesce(nr_seq_saida_spsadt_w,0)) then
		ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
					'Tipo saída: '||chr(13)||chr(10)||
					chr(9)||'Anterior: '||pls_obter_desc_motivo_saida(nr_seq_saida_spsadt_w)||' - Modificado: '||pls_obter_desc_motivo_saida(nr_seq_saida_spsadt_p)||chr(13)||chr(10);
	end if;

	if (coalesce(nr_seq_tipo_atendimento_p,0) <> coalesce(nr_seq_tipo_atendimento_w,0)) then
		ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
					'Tipo atendimento: '||chr(13)||chr(10)||
					chr(9)||'Anterior: '||pls_obter_desc_tipo_atend(nr_seq_tipo_atendimento_w)||' - Modificado: '||pls_obter_desc_tipo_atend(nr_seq_tipo_atendimento_p)||chr(13)||chr(10);
	end if;

	if (coalesce(ie_carater_internacao_p,'X') <> coalesce(ie_carater_internacao_w,'X')) then
		ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
					'Caráter int/solic.: '||chr(13)||chr(10)||
					chr(9)||'Anterior: '||obter_valor_dominio(2819,ie_carater_internacao_w)||' - Modificado: '||obter_valor_dominio(2819,ie_carater_internacao_p)||chr(13)||chr(10);
	end if;

	if (coalesce(ie_indicacao_acidente_p,'X') <> coalesce(ie_indicacao_acidente_w,'X')) then
		ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
					'Ind. acidente: '||chr(13)||chr(10)||
					chr(9)||'Anterior: '||obter_valor_dominio(1759,ie_indicacao_acidente_w)||' - Modificada: '||obter_valor_dominio(1759,ie_indicacao_acidente_p)||chr(13)||chr(10);
	end if;

	if (coalesce(ie_tipo_doenca_p,'X') <> coalesce(ie_tipo_doenca_w,'X')) then
		ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
					'Tipo doença: '||chr(13)||chr(10)||
					chr(9)||'Tipo doença anterior: '||obter_valor_dominio(1758,ie_tipo_doenca_w)||' - Modificado: '||obter_valor_dominio(1758,ie_tipo_doenca_p)||chr(13)||chr(10);
	end if;

	if (coalesce(cd_doenca_alta_p,'X') <> coalesce(cd_doenca_alta_w,'X')) then
		ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
					'CID Principal: '||chr(13)||chr(10)||
					chr(9)||'Anterior: '||cd_doenca_alta_w||' - '||obter_desc_cid(cd_doenca_alta_w)||' - Modificado: '||cd_doenca_alta_w||' - '||obter_desc_cid(cd_doenca_alta_p)||chr(13)||chr(10);
	end if;

	if (coalesce(ds_indicacao_clinica_p,'X') <> coalesce(ds_indicacao_clinica_w,'X')) then
		ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
					'Indicação clinica: '||chr(13)||chr(10)||
					chr(9)||'Anterior: '||ds_indicacao_clinica_w||chr(13)||chr(10)||chr(9)||'Modificado: '||ds_indicacao_clinica_p||chr(13)||chr(10);
	end if;

	if (coalesce(to_char(dt_atendimento_ww, 'dd/mm/yyyy hh24:mi:ss'),'X') <> coalesce(to_char(dt_atendimento_w, 'dd/mm/yyyy hh24:mi:ss'),'X')) then
		ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
					'Data de atendimento: '||chr(13)||chr(10)||
					chr(9)||'Anterior: '||to_char(dt_atendimento_ww, 'dd/mm/yyyy hh24:mi:ss')||' - Modificado: '||to_char(dt_atendimento_w, 'dd/mm/yyyy hh24:mi:ss')||chr(13)||chr(10);
	end if;

	if (coalesce(nr_seq_cbo_saude_p,0) <> coalesce(nr_seq_cbo_saude_w,0)) then
		ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
					'CBO executor: '||chr(13)||chr(10)||
					chr(9)||'Anterior: '||substr(obter_codigo_cbo_saude(nr_seq_cbo_saude_w),1,15)||' - '||substr(obter_cbo_saude(nr_seq_cbo_saude_w),1,80)||' - Modificado: '||substr(obter_codigo_cbo_saude(nr_seq_cbo_saude_p),1,15)||' - '||substr(obter_cbo_saude(nr_seq_cbo_saude_p),1,80)||chr(13)||chr(10);
	end if;

	if (coalesce(nr_seq_cbo_saude_solic_p,0) <> coalesce(nr_seq_cbo_saude_solic_w,0)) then
		ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
					'CBO solicitante: '||chr(13)||chr(10)||
					chr(9)||'Anterior: '||substr(obter_codigo_cbo_saude(nr_seq_cbo_saude_solic_w),1,15)||' - '||substr(obter_cbo_saude(nr_seq_cbo_saude_solic_w),1,80)||' - Modificado: '||substr(obter_codigo_cbo_saude(nr_seq_cbo_saude_solic_p),1,15)||' - '||substr(obter_cbo_saude(nr_seq_cbo_saude_solic_p),1,80)||chr(13)||chr(10);
	end if;

	if (coalesce(ds_observacao_p,'X') <> coalesce(ds_observacao_ww,'X')) then
		ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
					'Observação: '||chr(13)||chr(10)||
					chr(9)||'Anterior: '||replace(trim(both ds_observacao_ww),chr(13)||chr(10),' ')||''||' - Modificado : '||replace(trim(both ds_observacao_p),chr(13)||chr(10),' ')||chr(13)||chr(10);
	end if;

	if (coalesce(ie_tipo_consulta_p,'X') <> coalesce(ie_tipo_consulta_w,'X')) then
		ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
					'Tipo de consulta: '||chr(13)||chr(10)||
					chr(9)||'Anterior: '||obter_valor_dominio(3435,ie_tipo_consulta_w)||' - Modificado: '||obter_valor_dominio(3435,ie_tipo_consulta_p)||chr(13)||chr(10);
	end if;

elsif (ie_tipo_guia_w = '3') then

	select	max(nr_sequencia)
	into STRICT	nr_seq_diagostico_w
	from	pls_diagnostico_conta
	where	ie_classificacao		= 'P'
	and	nr_seq_conta			= nr_seq_conta_p;

	select	max(cd_doenca)
	into STRICT	cd_doenca_alta_w
	from	pls_diagnostico_conta
	where	nr_sequencia			= nr_seq_diagostico_w;

	if (coalesce(nr_seq_diagostico_w,0) > 0) then
		update	pls_diagnostico_conta
		set	cd_doenca			= cd_doenca_alta_p
		where	nr_sequencia			= nr_seq_diagostico_w;
	else
		insert into pls_diagnostico_conta(cd_doenca, ds_diagnostico, dt_atualizacao,
			dt_atualizacao_nrec, ie_classificacao, ie_estagio_complemento,
			ie_indicacao_acidente, ie_tipo_doenca, nm_usuario,
			nm_usuario_nrec, nr_seq_conta, nr_sequencia)
		values (cd_doenca_alta_p, '', clock_timestamp(),
			 clock_timestamp(), 'P', null,
			 null, null, nm_usuario_p,
			 nm_usuario_p, nr_seq_conta_p, nextval('pls_diagnostico_conta_seq'));
	end if;

	update	pls_conta
	set	ie_tipo_guia			= ie_tipo_guia_p,
		nr_seq_segurado			= nr_seq_segurado_p,
		nr_seq_prestador_exec		= nr_seq_prestador_exec_p,
		nr_seq_prestador		= nr_seq_prestador_solic_p,
		nr_seq_saida_consulta		= nr_seq_saida_consulta_p,
		dt_atendimento			= dt_atendimento_w,
		dt_emissao			= dt_atendimento_w,
		cd_senha_externa		= cd_senha_externa_p,
		cd_medico_executor		= cd_medico_executor_p,
		cd_medico_solicitante		= cd_medico_solicitante_p,
		ie_tipo_consulta		= ie_tipo_consulta_p,
		nr_seq_cbo_saude		= nr_seq_cbo_saude_p,
		nr_seq_cbo_saude_solic		= nr_seq_cbo_saude_solic_p,
		ds_observacao			= ds_observacao_p,
		nr_seq_tipo_conta		= nr_seq_tipo_conta_p
	where	nr_sequencia			= nr_seq_conta_p;

	if (coalesce(ie_tipo_guia_p,'X') <> coalesce(ie_tipo_guia_w,'X')) then
		ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
					'Tipo guia: '||chr(13)||chr(10)||
					chr(9)||'Anterior: '||obter_valor_dominio(1746, ie_tipo_guia_w)||' - Modificada: '||obter_valor_dominio(1746, ie_tipo_guia_p)||chr(13)||chr(10);

		nr_seq_protocolo_alt_w := pls_alterar_tipo_guia_conta(nr_seq_conta_p, ie_tipo_guia_p, nr_seq_protocolo_alt_w, cd_estabelecimento_p, nm_usuario_p);

		ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
					chr(9)||'Conta modificada para constar no protocolo '||nr_seq_protocolo_alt_w||'.';
	end if;

	if (coalesce(nr_seq_segurado_p,0) <> coalesce(nr_seq_segurado_w,0)) then
		ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
					'Segurado: '||chr(13)||chr(10)||
					chr(9)||'Anterior: '||pls_obter_dados_segurado(nr_seq_segurado_w,'N')||' - Modificado: '||pls_obter_dados_segurado(nr_seq_segurado_p,'N')||chr(13)||chr(10);
	end if;

	if (coalesce(nr_seq_prestador_exec_p,0) <> coalesce(nr_seq_prestador_exec_w,0)) then
		ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
					'Prestador executor: '||chr(13)||chr(10)||
					chr(9)||'Anterior: '||pls_obter_dados_prestador(nr_seq_prestador_exec_w,'N')||' - Modificado: '||pls_obter_dados_prestador(nr_seq_prestador_exec_p,'N')||chr(13)||chr(10);
	end if;

	if (coalesce(nr_seq_prestador_solic_p,0) <> coalesce(nr_seq_prestador_solic_w,0)) then
		ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
					'Prestador solicitante: '||chr(13)||chr(10)||
					chr(9)||'Anterior: '||pls_obter_dados_prestador(nr_seq_prestador_solic_w,'N')||' - Modificado: '||pls_obter_dados_prestador(nr_seq_prestador_solic_p,'N')||chr(13)||chr(10);
	end if;

	if (coalesce(cd_senha_externa_p,'X') <> coalesce(cd_senha_externa_w,'X')) then
		ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
					'Senha externa: '||chr(13)||chr(10)||
					chr(9)||'Anterior: '||cd_senha_externa_w||' - Modificado: '||cd_senha_externa_p||chr(13)||chr(10);
	end if;

	if (coalesce(cd_medico_executor_p,0) <> coalesce(cd_medico_executor_w,0)) then

		if (coalesce(cd_medico_executor_w,0) <> 0) then
			nm_medico_executor_w	:= obter_nome_medico(cd_medico_executor_w,'N');
		else
			nm_medico_executor_w	:= '          ';
		end if;

		if (coalesce(cd_medico_executor_p,0) <> 0) then
			nm_medico_executor_ww	:= obter_nome_medico(cd_medico_executor_p,'N');
		else
			nm_medico_executor_ww	:= '          ';
		end if;

		ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
					'Profissional executor: '||chr(13)||chr(10)||
					chr(9)||'Anterior: '||nm_medico_executor_w||' - Modificado: '||nm_medico_executor_ww||chr(13)||chr(10);
	end if;

	if (coalesce(cd_medico_solicitante_p,0) <> coalesce(cd_medico_solicitante_w,0)) then
		if (coalesce(cd_medico_solicitante_w,0) <> 0) then
			nm_medico_solic_w	:= obter_nome_medico(cd_medico_solicitante_w,'N');
		else
			nm_medico_solic_w	:= '          ';
		end if;

		if (coalesce(cd_medico_solicitante_p,0) <> 0) then
			nm_medico_solic_ww	:= obter_nome_medico(cd_medico_solicitante_p,'N');
		else
			nm_medico_solic_ww	:= '          ';
		end if;

		ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
					'Profissional solicitante: '||chr(13)||chr(10)||
					chr(9)||'Anterior: '||nm_medico_solic_w||' - Modificado: '||nm_medico_solic_ww||chr(13)||chr(10);
	end if;

	if (coalesce(nr_seq_saida_consulta_p,0) <> coalesce(nr_seq_saida_consulta_w,0)) then
		ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
					'Motivo saída: '||chr(13)||chr(10)||
					chr(9)||'Anterior: '||pls_obter_desc_mot_saida_con(nr_seq_saida_consulta_w)||' - Modificado: '||pls_obter_desc_mot_saida_con(nr_seq_saida_consulta_p)||chr(13)||chr(10);
	end if;

	if (coalesce(to_char(dt_atendimento_ww, 'dd/mm/yyyy hh24:mi:ss'),'X') <> coalesce(to_char(dt_atendimento_w, 'dd/mm/yyyy hh24:mi:ss'),'X')) then
		ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
					'Data de atendimento: '||chr(13)||chr(10)||
					chr(9)||'Anterior: '||to_char(dt_atendimento_ww, 'dd/mm/yyyy hh24:mi:ss')||' - Modificado: '||to_char(dt_atendimento_w, 'dd/mm/yyyy hh24:mi:ss')||chr(13)||chr(10);
	end if;

	if (coalesce(ie_tipo_consulta_p,'X') <> coalesce(ie_tipo_consulta_w,'X')) then
		ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
					'Tipo de consulta: '||chr(13)||chr(10)||
					chr(9)||'Anterior: '||obter_valor_dominio(3435,ie_tipo_consulta_w)||' - Modificado: '||obter_valor_dominio(3435,ie_tipo_consulta_p)||chr(13)||chr(10);
	end if;

	if (coalesce(cd_doenca_alta_p,'X') <> coalesce(cd_doenca_alta_w,'X')) then
		ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
					'CID Principal: '||chr(13)||chr(10)||
					chr(9)||'Anterior: '||cd_doenca_alta_w||' - '||obter_desc_cid(cd_doenca_alta_w)||' - Modificado: '||cd_doenca_alta_p||' - '||obter_desc_cid(cd_doenca_alta_p)||chr(13)||chr(10);
	end if;

	if (coalesce(nr_seq_cbo_saude_p,0) <> coalesce(nr_seq_cbo_saude_w,0)) then
		ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
					'CBO executor: '||chr(13)||chr(10)||
					chr(9)||'Anterior: '||substr(obter_codigo_cbo_saude(nr_seq_cbo_saude_w),1,15)||' - '||substr(obter_cbo_saude(nr_seq_cbo_saude_w),1,80)||' - Modificado: '||substr(obter_codigo_cbo_saude(nr_seq_cbo_saude_p),1,15)||' - '||substr(obter_cbo_saude(nr_seq_cbo_saude_p),1,80)||chr(13)||chr(10);
	end if;

	if (coalesce(nr_seq_cbo_saude_solic_p,0) <> coalesce(nr_seq_cbo_saude_solic_w,0)) then
		ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
					'CBO solicitante: '||chr(13)||chr(10)||
					chr(9)||'Anterior: '||substr(obter_codigo_cbo_saude(nr_seq_cbo_saude_solic_w),1,15)||' - '||substr(obter_cbo_saude(nr_seq_cbo_saude_solic_w),1,80)||' - Modificado: '||substr(obter_codigo_cbo_saude(nr_seq_cbo_saude_solic_p),1,15)||' - '||substr(obter_cbo_saude(nr_seq_cbo_saude_solic_p),1,80)||chr(13)||chr(10);
	end if;

	if (coalesce(ds_observacao_p,'X') <> coalesce(ds_observacao_ww,'X')) then
		ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
					'Observação: '||chr(13)||chr(10)||
					chr(9)||'Anterior: '||replace(trim(both ds_observacao_ww),chr(13)||chr(10),' ')||''||' - Modificado : '||replace(trim(both ds_observacao_p),chr(13)||chr(10),' ')||chr(13)||chr(10);
	end if;

end if;

if (coalesce(ds_observacao_w,'X') <> 'X') then
	CALL pls_inserir_hist_analise(nr_seq_conta_p, nr_seq_analise_p,17,
			 null, null, null,
			 null, 'Modificado pelo auditor '||obter_nome_usuario(nm_usuario_p)||'.'|| ds_observacao_w, nr_seq_grupo_p,
			 nm_usuario_p, cd_estabelecimento_p);
end if;

CALL pls_recalcular_conta(nr_seq_conta_p, nm_usuario_p,'C','S','N',null,null);

/*A rotina pls_recalcular_conta coloca os itens como consistido portanto o update abaixo é necessário*/

update	pls_conta_proc
set	ie_status	= 'A'
where	nr_seq_conta	= nr_seq_conta_p
and	ie_status	<> 'D';

update	pls_conta_mat
set	ie_status	= 'A'
where	nr_seq_conta	= nr_seq_conta_p;

select	max(ie_origem_analise)
into STRICT	ie_origem_analise_w
from	pls_analise_conta
where	nr_sequencia = nr_seq_analise_p;

/* ASKONO - OS367634 - SOLICITAÇÃO UNIMED RIO PRETO PARA RECONSISTÊNCIA AUTOMÁTICA APÓS ALTERAÇÃO DAS INFORMAÇÕES  DO ITEM OU DA CONTA */

ie_parametro_w  := obter_valor_param_usuario(1317,15,Obter_Perfil_Ativo,nm_usuario_p,cd_estabelecimento_p);

if (coalesce(ie_parametro_w,'N') = 'N') then
	if (ie_origem_analise_w = 3) then
		CALL pls_atual_w_resumo_conta_ptu(	nr_seq_conta_p, null, null,
						null, nr_seq_analise_p, nm_usuario_p	);
	else
		CALL pls_atualiza_w_resumo_conta(	nr_seq_conta_p, null, null,
						null, nr_seq_analise_p, nm_usuario_p	);
	end if;
end if;

/*pls_atualizar_ocorrencias(  nr_seq_conta_p, nr_seq_analise_p, nm_usuario_p,
			    cd_estabelecimento_p, 'N');*/
if (coalesce(ie_parametro_w,'N') = 'S') then
	CALL pls_reconsistir_analise(nr_seq_analise_p,nr_seq_grupo_p,cd_estabelecimento_p, nm_usuario_p);
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_alterar_conta_analise ( nr_seq_analise_p bigint, nr_seq_segurado_p bigint, nr_seq_prestador_exec_p bigint, nr_seq_prestador_solic_p bigint, ie_carater_internacao_p text, nr_seq_saida_int_p bigint, ie_obito_mulher_p text, qt_nasc_mortos_p bigint, qt_nasc_vivos_termo_p bigint, qt_nasc_vivos_prematuros_p bigint, qt_obito_precoce_p bigint, qt_obito_tardio_p bigint, cd_doenca_p text, nr_declaracao_obito_p text, ie_tipo_guia_p text, nr_seq_clinica_p bigint, ie_regime_internacao_p text, ie_indicacao_acidente_p text, nr_seq_tipo_acomodacao_p bigint, nr_seq_saida_spsadt_p bigint, nr_seq_tipo_atendimento_p bigint, ie_tipo_doenca_p text, nr_seq_saida_consulta_p bigint, ie_tipo_consulta_p text, nr_seq_conta_p bigint, nr_seq_grupo_p bigint, cd_estabelecimento_p bigint, dt_atendimento_p text, dt_entrada_p text, dt_alta_p text, cd_senha_externa_p text, cd_medico_executor_p bigint, cd_medico_solicitante_p bigint, cd_doenca_alta_p text, ds_indicacao_clinica_p text, nr_seq_cbo_saude_p bigint, nr_seq_cbo_saude_solic_p bigint, nr_seq_grau_partic_p bigint, nm_usuario_p text, ds_observacao_p text, ie_gestacao_p text, ie_aborto_p text, ie_parto_normal_p text, ie_complicacao_puerperio_p text, ie_complicacao_neonatal_p text, ie_parto_cesaria_p text, ie_baixo_peso_p text, ie_atend_rn_sala_parto_p text, ie_transtorno_p text, nr_seq_tipo_conta_p bigint) FROM PUBLIC;

