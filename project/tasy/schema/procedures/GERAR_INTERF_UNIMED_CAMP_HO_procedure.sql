-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_interf_unimed_camp_ho ( nr_seq_protocolo_p bigint, cd_estabelecimento_p bigint, ds_erro_p INOUT text) AS $body$
DECLARE

 
cd_local_prestador_w	varchar(8);
mes_ano_producao_w	timestamp;
nr_seq_grade_w		integer:= 0;
ds_complemento_w		varchar(223);
cd_convenio_w		integer;
dt_mesano_referencia_w	timestamp;
dt_alta_w			timestamp;
nr_seq_int_envio_inicial_w	bigint:= 0;
nr_seq_int_envio_w  	bigint:= 0;
ie_tipo_protocolo_w		smallint;
nr_interno_conta_w		bigint;
nr_interno_conta_ant_w	bigint:= 0;
dt_entrada_w		timestamp;
cd_usuario_convenio_w	varchar(30);
tp_servico_w		varchar(1);
cd_servico_w		varchar(8);
qt_item_w		double precision;
vl_item_w			double precision;
cd_cid_principal_w		varchar(4);
cd_cid_secundario_w	varchar(4);
cd_solicitante_w		varchar(11);
cd_executante_w		varchar(11);
ie_internado_w		varchar(1);
ie_atend_urgencia_w	varchar(1);
ie_acidente_w		varchar(1);
nm_paciente_w		varchar(100);
ie_ordem_w		bigint;
tp_alta_w			varchar(2);
data_aux_w		timestamp;
linha_w			integer:= 0;
seq_w			integer:= 0;
nr_doc_convenio_w	varchar(20);
ds_campos_w		varchar(283);
cd_interface_w		integer := 0;
nr_atendimento_w	bigint;
ds_espaco_w		varchar(11):= '';
ds_espaco_exec_w	varchar(11):= '';
cd_cgc_hospital_w	varchar(14);
ie_tipo_item_w		bigint;
qt_mat_w		bigint:=0;
dt_periodo_inicial_w	timestamp;
dt_periodo_final_w	timestamp;
dt_entrada2_w 		timestamp;

 
/* cabeçalho */
 
c01 CURSOR FOR 
	SELECT	substr(coalesce(cd_interno,'UNCPXXXX'),1,8) 	cd_local_prestador, 
		dt_inicio_protocolo			mes_ano_producao,		 
		substr(nm_hospital,1,40)		ds_complemento 
	from 	w_interf_conta_header 
	where	nr_seq_protocolo = nr_seq_protocolo_p;

/* movimento */
 
c02 CURSOR FOR 
	SELECT	a.nr_interno_conta		nr_interno_conta, 
		CASE WHEN a.cd_cgc_hospital='44595700000141' THEN  a.dt_alta  ELSE a.dt_entrada END 			dt_entrada, 
		CASE WHEN a.cd_cgc_hospital='44595700000141' THEN lpad(substr(replace(Obter_Guia_Conta(a.nr_interno_conta),'-',''),1,11),11,0)  ELSE substr(replace(a.nr_doc_convenio,'-',''),1,11) END 	nr_doc_convenio, 
		substr(a.cd_usuario_convenio,1,17) cd_usuario_convenio, 
		CASE WHEN somente_numero(b.ie_emite_conta)=51 THEN 4 WHEN somente_numero(b.ie_emite_conta)=52 THEN 4 WHEN somente_numero(b.ie_emite_conta)=53 THEN 5 WHEN somente_numero(b.ie_emite_conta)=72 THEN 6 WHEN somente_numero(b.ie_emite_conta)=74 THEN 7 WHEN somente_numero(b.ie_emite_conta)=75 THEN 2  ELSE 8 END  tp_servico, 
		substr(CASE WHEN a.cd_cgc_hospital='61709689000112' THEN CASE WHEN b.cd_item_convenio=to_char(b.cd_item) THEN coalesce(to_char(b.cd_procedimento_tuss),b.cd_item_convenio)  ELSE b.cd_item_convenio END  WHEN a.cd_cgc_hospital='44595700000141' THEN CASE WHEN b.cd_item_convenio=to_char(b.cd_item) THEN coalesce(to_char(b.cd_procedimento_tuss),b.cd_item_convenio)  ELSE b.cd_item_convenio END   ELSE b.cd_item_convenio END ,1,8)	cd_servico, 
		sum(b.qt_item)			qt_item, 
		sum(CASE WHEN a.cd_cgc_hospital='61709689000112' THEN CASE WHEN b.ie_responsavel_credito='M' THEN  b.vl_custo_oper  ELSE b.vl_total_item END   ELSE b.vl_total_item END ) vl_item, 
		substr(a.cd_cid_principal,1,4)	cd_cid_principal, 
		substr(a.cd_cid_secundario,1,4)	cd_cid_secundario, 
		CASE WHEN a.ie_tipo_atendimento=1 THEN 'S'  ELSE 'N' END  ie_internado, 
		CASE WHEN coalesce(a.ie_carater_inter,'U')='U' THEN 'S'  ELSE 'N' END  ie_atend_urgencia, 
		obter_acidente_tiss_atend(a.nr_atendimento) ie_acidente,		 
		a.dt_alta			dt_alta, 
		CASE WHEN a.cd_cgc_hospital='61709689000112' THEN '5825733' WHEN a.cd_cgc_hospital='44595700000141' THEN  substr(b.cd_medico_exec_conv,1,11)   ELSE '189880' END  cd_solicitante,  -- 44595700000141 - centro médico de campinas , 61709689000112 - madre theodora 
		CASE WHEN a.cd_cgc_hospital='61709689000112' THEN '5825733' WHEN a.cd_cgc_hospital='44595700000141' THEN  '88595'  ELSE '189880' END  cd_executante,		 
		coalesce(obter_conversao_externa(a.cd_cgc_convenio, 'INTERF_UNIMED_CAMP_HO_V', 'TP_ALTA', a.cd_motivo_alta),'01') 
						tp_alta, 
		substr(a.nm_paciente,1,100) 	nm_paciente, 
		CASE WHEN somente_numero(coalesce(b.ie_emite_conta,0))=74 THEN 1 WHEN somente_numero(coalesce(b.ie_emite_conta,0))=72 THEN 2 WHEN somente_numero(coalesce(b.ie_emite_conta,0))=75 THEN 3 WHEN somente_numero(coalesce(b.ie_emite_conta,0))=53 THEN 4 WHEN somente_numero(coalesce(b.ie_emite_conta,0))=52 THEN 5 WHEN somente_numero(coalesce(b.ie_emite_conta,0))=51 THEN 6  ELSE 7 END  ie_ordem,		 
		a.nr_atendimento, 
		a.cd_cgc_hospital, 
		b.ie_tipo_item, 
		a.dt_periodo_inicial dt_periodo_inicial, 
		a.dt_periodo_final  dt_periodo_final 
	from 	w_interf_conta_cab	a,	 
		w_interf_conta_item 	b 
	where	a.nr_interno_conta = b.nr_interno_conta 
	and 	somente_numero(coalesce(b.ie_emite_conta,0)) in (51,52,53,72,74,75,77,94,97,98,101) /* incluído o 77 pacotes , 94 ortese e protese*/
 
	and 	a.nr_seq_protocolo = nr_seq_protocolo_p 
	and		((obter_classificacao_proced(cd_item, ie_origem_Proced,'C') <> 2 and b.ie_tipo_item = 1) or (b.ie_tipo_item = 2)) 
	group by 
		a.nr_interno_conta, 
		CASE WHEN a.cd_cgc_hospital='44595700000141' THEN  a.dt_alta  ELSE a.dt_entrada END , 
		CASE WHEN a.cd_cgc_hospital='44595700000141' THEN lpad(substr(replace(Obter_Guia_Conta(a.nr_interno_conta),'-',''),1,11),11,0)  ELSE substr(replace(a.nr_doc_convenio,'-',''),1,11) END , 
		substr(a.cd_usuario_convenio,1,17), 
		CASE WHEN somente_numero(b.ie_emite_conta)=51 THEN 4 WHEN somente_numero(b.ie_emite_conta)=52 THEN 4 WHEN somente_numero(b.ie_emite_conta)=53 THEN 5 WHEN somente_numero(b.ie_emite_conta)=72 THEN 6 WHEN somente_numero(b.ie_emite_conta)=74 THEN 7 WHEN somente_numero(b.ie_emite_conta)=75 THEN 2  ELSE 8 END , 
		substr(CASE WHEN a.cd_cgc_hospital='61709689000112' THEN CASE WHEN b.cd_item_convenio=to_char(b.cd_item) THEN coalesce(to_char(b.cd_procedimento_tuss),b.cd_item_convenio)  ELSE b.cd_item_convenio END  WHEN a.cd_cgc_hospital='44595700000141' THEN CASE WHEN b.cd_item_convenio=to_char(b.cd_item) THEN coalesce(to_char(b.cd_procedimento_tuss),b.cd_item_convenio)  ELSE b.cd_item_convenio END   ELSE b.cd_item_convenio END ,1,8), 
		a.cd_cid_principal, 
		a.cd_cid_secundario, 
		CASE WHEN a.ie_tipo_atendimento=1 THEN 'S'  ELSE 'N' END , 
		CASE WHEN coalesce(a.ie_carater_inter,'U')='U' THEN 'S'  ELSE 'N' END , 
		obter_acidente_tiss_atend(a.nr_atendimento), 
		a.dt_alta, 
		CASE WHEN a.cd_cgc_hospital='61709689000112' THEN '5825733' WHEN a.cd_cgc_hospital='44595700000141' THEN  substr(b.cd_medico_exec_conv,1,11)   ELSE '189880' END , 
		CASE WHEN a.cd_cgc_hospital='61709689000112' THEN '5825733' WHEN a.cd_cgc_hospital='44595700000141' THEN  '88595'  ELSE '189880' END , 
		coalesce(obter_conversao_externa(a.cd_cgc_convenio, 'INTERF_UNIMED_CAMP_HO_V', 'TP_ALTA', a.cd_motivo_alta),'01'), 
		substr(a.nm_paciente,1,100), 
		CASE WHEN somente_numero(coalesce(b.ie_emite_conta,0))=74 THEN 1 WHEN somente_numero(coalesce(b.ie_emite_conta,0))=72 THEN 2 WHEN somente_numero(coalesce(b.ie_emite_conta,0))=75 THEN 3 WHEN somente_numero(coalesce(b.ie_emite_conta,0))=53 THEN 4 WHEN somente_numero(coalesce(b.ie_emite_conta,0))=52 THEN 5 WHEN somente_numero(coalesce(b.ie_emite_conta,0))=51 THEN 6  ELSE 7 END , 
		a.nr_atendimento, 
		a.cd_cgc_hospital, 
		b.ie_tipo_item, 
		a.dt_periodo_inicial, 
		a.dt_periodo_final 
	having	sum(b.qt_item) > 0 
	
union all
 
	SELECT	a.nr_interno_conta		nr_interno_conta, 
		CASE WHEN a.cd_cgc_hospital='44595700000141' THEN  a.dt_alta  ELSE a.dt_entrada END  dt_entrada, 
		CASE WHEN a.cd_cgc_hospital='44595700000141' THEN lpad(substr(replace(Obter_Guia_Conta(a.nr_interno_conta),'-',''),1,11),11,0)  ELSE substr(replace(a.nr_doc_convenio,'-',''),1,11) END 	nr_doc_convenio, 
		substr(a.cd_usuario_convenio,1,17) cd_usuario_convenio, 
		CASE WHEN somente_numero(b.ie_emite_conta)=51 THEN 4 WHEN somente_numero(b.ie_emite_conta)=52 THEN 4 WHEN somente_numero(b.ie_emite_conta)=53 THEN 5 WHEN somente_numero(b.ie_emite_conta)=72 THEN 6 WHEN somente_numero(b.ie_emite_conta)=74 THEN 7 WHEN somente_numero(b.ie_emite_conta)=75 THEN 2  ELSE 8 END  tp_servico, 
		substr(CASE WHEN a.cd_cgc_hospital='61709689000112' THEN CASE WHEN b.cd_item_convenio=to_char(b.cd_item) THEN coalesce(to_char(b.cd_procedimento_tuss),b.cd_item_convenio)  ELSE b.cd_item_convenio END  WHEN a.cd_cgc_hospital='44595700000141' THEN CASE WHEN b.cd_item_convenio=to_char(b.cd_item) THEN coalesce(to_char(b.cd_procedimento_tuss),b.cd_item_convenio)  ELSE b.cd_item_convenio END   ELSE b.cd_item_convenio END ,1,8)	cd_servico, 
		sum(b.qt_item)			qt_item, 
		sum(CASE WHEN a.cd_cgc_hospital='61709689000112' THEN CASE WHEN b.ie_responsavel_credito='M' THEN  b.vl_custo_oper  ELSE b.vl_total_item END   ELSE b.vl_total_item END ) vl_item, 
		substr(a.cd_cid_principal,1,4)	cd_cid_principal, 
		substr(a.cd_cid_secundario,1,4)	cd_cid_secundario, 
		CASE WHEN a.ie_tipo_atendimento=1 THEN 'S'  ELSE 'N' END  ie_internado, 
		CASE WHEN coalesce(a.ie_carater_inter,'U')='U' THEN 'S'  ELSE 'N' END  ie_atend_urgencia, 
		obter_acidente_tiss_atend(a.nr_atendimento) ie_acidente,		 
		a.dt_alta			dt_alta, 
		CASE WHEN a.cd_cgc_hospital='61709689000112' THEN '5825733' WHEN a.cd_cgc_hospital='44595700000141' THEN  substr(b.cd_medico_exec_conv,1,11)   ELSE '189880' END  cd_solicitante,  -- 44595700000141 - centro médico de campinas , 61709689000112 - madre theodora 
		CASE WHEN a.cd_cgc_hospital='61709689000112' THEN '5825733' WHEN a.cd_cgc_hospital='44595700000141' THEN  '88595'  ELSE '189880' END  cd_executante,		 
		coalesce(obter_conversao_externa(a.cd_cgc_convenio, 'INTERF_UNIMED_CAMP_HO_V', 'TP_ALTA', a.cd_motivo_alta),'01') 
						tp_alta, 
		substr(a.nm_paciente,1,100) 	nm_paciente, 
		CASE WHEN somente_numero(coalesce(b.ie_emite_conta,0))=74 THEN 1 WHEN somente_numero(coalesce(b.ie_emite_conta,0))=72 THEN 2 WHEN somente_numero(coalesce(b.ie_emite_conta,0))=75 THEN 3 WHEN somente_numero(coalesce(b.ie_emite_conta,0))=53 THEN 4 WHEN somente_numero(coalesce(b.ie_emite_conta,0))=52 THEN 5 WHEN somente_numero(coalesce(b.ie_emite_conta,0))=51 THEN 6  ELSE 7 END  ie_ordem,		 
		a.nr_atendimento, 
		a.cd_cgc_hospital, 
		b.ie_tipo_item, 
		a.dt_periodo_inicial dt_periodo_inicial, 
		a.dt_periodo_final  dt_periodo_final		 
	from 	w_interf_conta_cab	a,	 
		w_interf_conta_item 	b 
	where	a.nr_interno_conta = b.nr_interno_conta 
	and 	somente_numero(coalesce(b.ie_emite_conta,0)) in (51,52,53,72,74,75,77,94,97,98,101) /* incluído o 77 pacotes , 94 ortese e protese*/
 
	and 	a.nr_seq_protocolo = nr_seq_protocolo_p 
	and (obter_classificacao_proced(cd_item, ie_origem_Proced,'C') = 2 and b.ie_tipo_item = 1) 
	group by 
		a.nr_interno_conta, 
		b.dt_item, 
		CASE WHEN a.cd_cgc_hospital='44595700000141' THEN  a.dt_alta  ELSE a.dt_entrada END , 
		CASE WHEN a.cd_cgc_hospital='44595700000141' THEN lpad(substr(replace(Obter_Guia_Conta(a.nr_interno_conta),'-',''),1,11),11,0)  ELSE substr(replace(a.nr_doc_convenio,'-',''),1,11) END , 
		substr(a.cd_usuario_convenio,1,17), 
		CASE WHEN somente_numero(b.ie_emite_conta)=51 THEN 4 WHEN somente_numero(b.ie_emite_conta)=52 THEN 4 WHEN somente_numero(b.ie_emite_conta)=53 THEN 5 WHEN somente_numero(b.ie_emite_conta)=72 THEN 6 WHEN somente_numero(b.ie_emite_conta)=74 THEN 7 WHEN somente_numero(b.ie_emite_conta)=75 THEN 2  ELSE 8 END , 
		substr(CASE WHEN a.cd_cgc_hospital='61709689000112' THEN CASE WHEN b.cd_item_convenio=to_char(b.cd_item) THEN coalesce(to_char(b.cd_procedimento_tuss),b.cd_item_convenio)  ELSE b.cd_item_convenio END  WHEN a.cd_cgc_hospital='44595700000141' THEN CASE WHEN b.cd_item_convenio=to_char(b.cd_item) THEN coalesce(to_char(b.cd_procedimento_tuss),b.cd_item_convenio)  ELSE b.cd_item_convenio END   ELSE b.cd_item_convenio END ,1,8), 
		a.cd_cid_principal, 
		a.cd_cid_secundario, 
		CASE WHEN a.ie_tipo_atendimento=1 THEN 'S'  ELSE 'N' END , 
		CASE WHEN coalesce(a.ie_carater_inter,'U')='U' THEN 'S'  ELSE 'N' END , 
		obter_acidente_tiss_atend(a.nr_atendimento), 
		a.dt_alta, 
		CASE WHEN a.cd_cgc_hospital='61709689000112' THEN '5825733' WHEN a.cd_cgc_hospital='44595700000141' THEN  substr(b.cd_medico_exec_conv,1,11)   ELSE '189880' END , 
		CASE WHEN a.cd_cgc_hospital='61709689000112' THEN '5825733' WHEN a.cd_cgc_hospital='44595700000141' THEN  '88595'  ELSE '189880' END , 
		coalesce(obter_conversao_externa(a.cd_cgc_convenio, 'INTERF_UNIMED_CAMP_HO_V', 'TP_ALTA', a.cd_motivo_alta),'01'), 
		substr(a.nm_paciente,1,100), 
		CASE WHEN somente_numero(coalesce(b.ie_emite_conta,0))=74 THEN 1 WHEN somente_numero(coalesce(b.ie_emite_conta,0))=72 THEN 2 WHEN somente_numero(coalesce(b.ie_emite_conta,0))=75 THEN 3 WHEN somente_numero(coalesce(b.ie_emite_conta,0))=53 THEN 4 WHEN somente_numero(coalesce(b.ie_emite_conta,0))=52 THEN 5 WHEN somente_numero(coalesce(b.ie_emite_conta,0))=51 THEN 6  ELSE 7 END , 
		a.nr_atendimento, 
		a.cd_cgc_hospital, 
		b.ie_tipo_item, 
		a.dt_periodo_inicial, 
		a.dt_periodo_final 
	having	sum(b.qt_item) > 0 
	order by nr_atendimento, dt_entrada, nr_interno_conta,ie_ordem;
	
 

BEGIN 
 
delete from w_interf_unimed_camp_ho 
where nr_seq_protocolo = nr_seq_protocolo_p;
 
commit;
 
begin 
CALL gerar_interf_conta(cd_estabelecimento_p, nr_seq_protocolo_p);
exception 
	when others then 
		ds_erro_p:= WHEB_MENSAGEM_PCK.get_texto(279112);
end;
 
data_aux_w:= clock_timestamp();
qt_mat_w:= 0;
 
/* achar o número da grade ++ inicio ++ */
 
 
select 	max(cd_convenio), 
	max(dt_mesano_referencia), 
	max(ie_tipo_protocolo), 
	max(coalesce(cd_interface_envio,0)) 
into STRICT	cd_convenio_w, 
	dt_mesano_referencia_w, 
	ie_tipo_protocolo_w, 
	cd_interface_w 
from 	protocolo_convenio 
where 	nr_seq_protocolo = nr_seq_protocolo_p;
 
if (cd_interface_w = 0) then 
	select 	max(coalesce(cd_interface_envio,0)) 
	into STRICT	cd_interface_w 
	from 	convenio 
	where 	cd_convenio = cd_convenio_w;
end if;
 
 
select 	max(coalesce(nr_seq_int_envio_inicial,0)) 
into STRICT	nr_seq_int_envio_inicial_w 
from 	protocolo_convenio 
where	nr_seq_protocolo = nr_seq_protocolo_p;
 
 
if (nr_seq_int_envio_inicial_w = 0) then 
	select 	max(coalesce(nr_seq_int_envio,0)) 
	into STRICT	nr_seq_int_envio_w 
	from 	protocolo_convenio 
	where	cd_convenio = cd_convenio_w 
	and	trunc(dt_mesano_referencia, 'month') 		= trunc(dt_mesano_referencia_w, 'month') 
	and 	coalesce(cd_interface_envio, cd_interface_w)		= cd_interface_w;
	 
	if (nr_seq_int_envio_w = 0) then 
		select	max(coalesce(nr_seq_envio_prot,0)) 
		into STRICT	nr_seq_grade_w 
		from	conv_regra_envio_protocolo 
		where	cd_convenio					= cd_convenio_w 
		and 	coalesce(cd_interface, cd_interface_w)		= cd_interface_w 
		and 	coalesce(ie_tipo_regra, 'S') = 'I';
	else 
		nr_seq_grade_w:= nr_seq_int_envio_w + 1;
	end if;
else 
	nr_seq_grade_w:= nr_seq_int_envio_inicial_w;
end if;
 
/* achar o número da grade ++ fim ++ */
 
 
update	protocolo_convenio 
set 	nr_seq_int_envio_inicial = nr_seq_grade_w 
where 	nr_seq_protocolo 	 = nr_seq_protocolo_p;
 
open c01;
loop 
fetch c01 into 
	cd_local_prestador_w, 
	mes_ano_producao_w,	 
	ds_complemento_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	begin 
	ds_campos_w:=  'AH  ' || rpad(cd_local_prestador_w,8,' ') || '21' || to_char(mes_ano_producao_w,'mmyyyy') || 
			 '    ' || lpad(nr_seq_grade_w,6,0) || to_char(data_aux_w,'ddmmyyyy') || 
			 lpad(' ',25,' ') || rpad(ds_complemento_w,213,' ');
	insert into w_interf_unimed_camp_ho(nr_sequencia, 
			 nr_linha, 
			 nr_seq_protocolo, 
			 ds_campos, 
			 nr_seq_grade, 
			 nr_interno_conta, 
			 cd_usuario_convenio, 
			 dt_entrada, 
			 qt_item, 
			 vl_item, 
			 nm_paciente, 
			 nr_doc_convenio, 
			 cd_servico, 
			 cd_solicitante, 
			 ie_tipo_registro, 
			 nr_atendimento)  /* 1 - cabeçalho,  2 - movimento */
 
		values (nextval('w_interf_unimed_camp_seq'), 
			seq_w, 
			nr_seq_protocolo_p, 
			ds_campos_w, 
			nr_seq_grade_w, 
			0, 
			'', 
			clock_timestamp(), 
			0, 
			0, 
			'', 
			'', 
			0, 
			'', 
			1, 
			0);
	end;
end loop;
close c01;
 
 
open c02;
loop 
fetch c02 into 
	nr_interno_conta_w, 
	dt_entrada_w, 
	nr_doc_convenio_w, 
	cd_usuario_convenio_w, 
	tp_servico_w, 
	cd_servico_w, 
	qt_item_w, 
	vl_item_w, 
	cd_cid_principal_w, 
	cd_cid_secundario_w, 
	ie_internado_w, 
	ie_atend_urgencia_w, 
	ie_acidente_w, 
	dt_alta_w, 
	cd_solicitante_w, 
	cd_executante_w, 
	tp_alta_w, 
	nm_paciente_w, 
	ie_ordem_w, 
	nr_atendimento_w, 
	cd_cgc_hospital_w, 
	ie_tipo_item_w, 
	dt_periodo_inicial_w, 
	dt_periodo_final_w;
EXIT WHEN NOT FOUND; /* apply on c02 */
	begin 
	dt_entrada2_w	:= dt_entrada_w;
	 
	if (cd_cgc_hospital_w = '44595700000141') then 
		dt_entrada_w:= dt_periodo_inicial_w;
		dt_entrada2_w := dt_periodo_final_w;
	end if;
	 
	 
	if	((cd_cgc_hospital_w = '61709689000112') and (ie_tipo_item_w = 2) and (vl_item_w = 0)) then 
		goto proximo;
	end if;
	 
	seq_w:=	seq_w + 1;
 
	if (nr_interno_conta_ant_w <> nr_interno_conta_w) then 
		nr_interno_conta_ant_w:= nr_interno_conta_w;
		linha_w:= linha_w + 1;
	end if;		
	 
	if (cd_solicitante_w = '5825733') or (cd_solicitante_w = '189880') then 
		 
		select 	CASE WHEN length(cd_solicitante_w)=6 THEN  '   '  ELSE '  ' END  
		into STRICT	ds_espaco_w 
		;	
	 
	else 
		if (coalesce(cd_solicitante_w::text, '') = '') then 
			select 	substr(cd_medico_atendimento,1,11) 
			into STRICT	cd_solicitante_w 
			from	atendimento_paciente 
			where 	nr_atendimento = nr_atendimento_w;
			 
			select 	obter_medico_convenio(1, cd_solicitante_w, cd_convenio_w, null, null, null, null,dt_entrada_w, null) 
			into STRICT	cd_solicitante_w 
			;
		end if;
		 
		ds_espaco_w:= '';
		 
		select	lpad(cd_solicitante_w, 11, ' ') 
		into STRICT	cd_solicitante_w 
		;
	 
	end if;	
	 
	select 	CASE WHEN length(cd_executante_w)=6 THEN  '   ' WHEN length(cd_executante_w)=5 THEN  '   '  ELSE '  ' END  
	into STRICT	ds_espaco_exec_w 
	;
	 
	/*SEMPRE que a guia tiver 10 dígitos e iniciar com 1 deve incluir o 0 antes do 1000*/
 
	/* OS 157902 */
 
	if (cd_cgc_hospital_w = '46030318000116') and (length(nr_doc_convenio_w) = 10) and (substr(nr_doc_convenio_w,1,1) = '1') then 
		nr_doc_convenio_w:= '0' || nr_doc_convenio_w;
	end if;
 
	if (linha_w < 16) then 
		ds_campos_w:= 	to_char(dt_entrada2_w,'ddmmyyyyhh24mi') || rpad(coalesce(nr_doc_convenio_w,' '),11,' ') || 
				lpad(coalesce(cd_usuario_convenio_w,'0'),17,'0') || coalesce(tp_servico_w,'8') || rpad(cd_servico_w,8,' ') || 
				lpad(replace(campo_mascara(qt_item_w,2),'.',''),7,'0') || lpad(replace(campo_mascara(vl_item_w,2),'.',''),9,'0') || 
				rpad(coalesce(cd_cid_principal_w,' '),4,' ') || rpad(coalesce(cd_cid_secundario_w,' '),4,' ') || ds_espaco_w || 
				coalesce(cd_solicitante_w,'0') || ds_espaco_exec_w || coalesce(cd_executante_w,'0') || '100' || 
				coalesce(ie_internado_w,'N') || coalesce(ie_atend_urgencia_w,'N') || coalesce(ie_acidente_w,'N') || rpad(' ',100,' ') || 
				' 0' || '00000000' || rpad(' ',30,' ') || '0' || rpad(' ',17,' ') || rpad(' ',6,' ') || to_char(dt_entrada_w,'ddmmyyyy') || 
				to_char(coalesce(dt_alta_w,clock_timestamp()),'ddmmyyyy') || lpad(coalesce(tp_alta_w,'01'),2,'0');
				 
		insert into w_interf_unimed_camp_ho(nr_sequencia, 
			 nr_linha, 
			 nr_seq_protocolo, 
			 ds_campos, 
			 nr_seq_grade, 
			 nr_interno_conta, 
			 cd_usuario_convenio, 
			 dt_entrada, 
			 qt_item, 
			 vl_item, 
			 nm_paciente, 
			 nr_doc_convenio, 
			 cd_servico, 
			 cd_solicitante, 
			 ie_tipo_registro, 
			nr_atendimento)  /* 1 - cabeçalho,  2 - movimento */
 
		values (nextval('w_interf_unimed_camp_seq'), 
			seq_w, 
			nr_seq_protocolo_p, 
			ds_campos_w, 
			nr_seq_grade_w, 
			nr_interno_conta_w, 
			cd_usuario_convenio_w, 
			dt_entrada_w, 
			qt_item_w, 
			vl_item_w, 
			nm_paciente_w, 
			nr_doc_convenio_w, 
			cd_servico_w, 
			cd_solicitante_w, 
			2, 
			nr_atendimento_w);
 
	else 
		linha_w:= 1;
		/* cabeçalho */
 
		nr_seq_grade_w:= nr_seq_grade_w + 1;
		ds_campos_w:=  'AH  ' || rpad(cd_local_prestador_w,8,' ') || '21' || to_char(mes_ano_producao_w,'mmyyyy') || 
				 '    ' || lpad(nr_seq_grade_w,6,0) || to_char(data_aux_w,'ddmmyyyy') || 
			 	 lpad(' ',25,' ') || rpad(ds_complemento_w,213,' ');
 
		insert into w_interf_unimed_camp_ho(nr_sequencia, 
			 nr_linha, 
			 nr_seq_protocolo, 
			 ds_campos, 
			 nr_seq_grade, 
			 nr_interno_conta, 
			 cd_usuario_convenio, 
			 dt_entrada, 
			 qt_item, 
			 vl_item, 
			 nm_paciente, 
			 nr_doc_convenio, 
			 cd_servico, 
			 cd_solicitante, 
			 ie_tipo_registro, 
			 nr_atendimento)  /* 1 - cabeçalho,  2 - movimento */
 
		values (nextval('w_interf_unimed_camp_seq'), 
			seq_w, 
			nr_seq_protocolo_p, 
			ds_campos_w, 
			nr_seq_grade_w, 
			0, 
			'', 
			clock_timestamp(), 
			0, 
			0, 
			'', 
			'', 
			0, 
			'', 
			1, 
			nr_atendimento_w);
 
		seq_w:=	seq_w + 1;
		/* movimento */
 
		ds_campos_w:= 	to_char(dt_entrada2_w,'ddmmyyyyhh24mi') || lpad(coalesce(nr_doc_convenio_w,' '),11,' ') || 
				lpad(coalesce(cd_usuario_convenio_w,'0'),17,'0') || coalesce(tp_servico_w,'8') || rpad(cd_servico_w,8,' ') || 
				lpad(replace(campo_mascara(qt_item_w,2),'.',''),7,'0') || lpad(replace(campo_mascara(vl_item_w,2),'.',''),9,'0') || 
				rpad(coalesce(cd_cid_principal_w,' '),4,' ') || rpad(coalesce(cd_cid_secundario_w,' '),4,' ') || ds_espaco_w || 
				coalesce(cd_solicitante_w,'0') || ds_espaco_exec_w || coalesce(cd_executante_w,'0') || '100' || 
				coalesce(ie_internado_w,'N') || coalesce(ie_atend_urgencia_w,'N') || coalesce(ie_acidente_w,'N') || rpad(' ',100,' ') || 
				' 0' || '00000000' || rpad(' ',30,' ') || '0' || rpad(' ',17,' ') || rpad(' ',6,' ') || to_char(dt_entrada_w,'ddmmyyyy') || 
				to_char(coalesce(dt_alta_w,clock_timestamp()),'ddmmyyyy') || lpad(coalesce(tp_alta_w,'01'),2,'0');
		insert into w_interf_unimed_camp_ho(nr_sequencia, 
			 nr_linha, 
			 nr_seq_protocolo, 
			 ds_campos, 
			 nr_seq_grade, 
			 nr_interno_conta, 
			 cd_usuario_convenio, 
			 dt_entrada, 
			 qt_item, 
			 vl_item, 
			 nm_paciente, 
			 nr_doc_convenio, 
			 cd_servico, 
			 cd_solicitante, 
			 ie_tipo_registro, 
			 nr_atendimento)  /* 1 - cabeçalho,  2 - movimento */
 
		values (nextval('w_interf_unimed_camp_seq'), 
			seq_w, 
			nr_seq_protocolo_p, 
			ds_campos_w, 
			nr_seq_grade_w, 
			nr_interno_conta_w, 
			cd_usuario_convenio_w, 
			dt_entrada_w, 
			qt_item_w, 
			vl_item_w, 
			nm_paciente_w, 
			nr_doc_convenio_w, 
			cd_servico_w, 
			cd_solicitante_w, 
			2, 
			nr_atendimento_w);	
	end if;		
		 
	<<proximo>> 
		if	((cd_cgc_hospital_w = '61709689000112') and (ie_tipo_item_w = 2) and (vl_item_w = 0)) then 
			qt_mat_w:= qt_mat_w + 1;
		end if;	
		 
	end;
	 
end loop;
close c02;
 
update	protocolo_convenio 
set 	nr_seq_int_envio = nr_seq_grade_w 
where 	nr_seq_protocolo = nr_seq_protocolo_p;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_interf_unimed_camp_ho ( nr_seq_protocolo_p bigint, cd_estabelecimento_p bigint, ds_erro_p INOUT text) FROM PUBLIC;

