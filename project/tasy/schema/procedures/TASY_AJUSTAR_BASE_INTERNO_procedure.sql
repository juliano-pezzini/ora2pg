-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE tasy_ajustar_base_interno ( nm_usuario_p text) AS $body$
DECLARE


dt_versao_atual_cliente_w 		timestamp;
qt_registro_w			bigint;
user_w				varchar(4);


BEGIN

CALL abortar_se_base_wheb();

dt_versao_atual_cliente_w := coalesce(to_date(to_char(obter_data_geracao_versao-1,'dd/mm/yyyy') ||' 23:59:59','dd/mm/yyyy hh24:mi:ss'),clock_timestamp() - interval '90 days');

if (dt_versao_atual_cliente_w < to_date('11/02/2011','dd/mm/yyyy')) then
	CALL BACA_ACERTO_VINC_PROFISSIONAL();
end if;

/*if	(dt_versao_atual_cliente_w < to_date('15/03/2011','dd/mm/yyyy')) then

	select	count(*)
	into	qt_registro_w
	from	user_tab_columns
	where	table_name = 'PROJ_RISCO_IMPLANTACAO'
	and	column_name= 'NR_SEQ_TIPO';

	if	(qt_registro_w > 0) then
		exec_sql_dinamico('eberns', 'alter table proj_risco_implantacao modify nr_seq_tipo null');
	end if;

end if;
*/
if (dt_versao_atual_cliente_w < to_date('30/08/2011','dd/mm/yyyy')) then
	begin
	select	substr(user,1,4)
	into STRICT	user_w
	;

	if (user_w <> 'CORP' ) then
		begin
		select	count(*)
		into STRICT	qt_registro_w
		from	user_objects
		where	object_name = 'GERENCIAR_MIGRACAO_PCK';

		if (qt_registro_w > 0) then
			begin
			CALL Exec_SQL_Dinamico('Rafael','Drop Package GERENCIAR_MIGRACAO_PCK');
			end;
		end if;

		select	count(*)
		into STRICT	qt_registro_w
		from	user_objects
		where	object_name = 'BACA_OS_TES_MIGR_OPS_PLAN_NOVO';

		if (qt_registro_w > 0) then
			begin
			CALL Exec_SQL_Dinamico('Rafael','Drop Procedure BACA_OS_TES_MIGR_OPS_PLAN_NOVO'
);
			end;
		end if;

		select	count(*)
		into STRICT	qt_registro_w
		from	user_objects
		where	object_name = 'GERAR_OS_PROJETO_MIGRACAO';

		if (qt_registro_w > 0) then
			begin
			CALL Exec_SQL_Dinamico('Rafael','Drop Procedure GERAR_OS_PROJETO_MIGRACAO'
);
			end;
		end if;

		select	count(*)
		into STRICT	qt_registro_w
		from	user_objects
		where	object_name = 'ATUALIZAR_GERENCIAMENTO_MIGR';

		if (qt_registro_w > 0) then
			begin
			CALL Exec_SQL_Dinamico('Rafael','Drop Procedure ATUALIZAR_GERENCIAMENTO_MIGR'
);
			end;
		end if;

		select	count(*)
		into STRICT	qt_registro_w
		from	user_objects
		where	object_name = 'MAN_ORDEM_SERV_HIST_ATUAL_MIGR';

		if (qt_registro_w > 0) then
			begin
			CALL Exec_SQL_Dinamico('Rafael','Drop Trigger MAN_ORDEM_SERV_HIST_ATUAL_MIGR');
			end;
		end if;
		end;
	end if;
	end;
end if;

if (dt_versao_atual_cliente_w < to_date('12/09/2012','dd/mm/yyyy')) then
	begin
	qt_registro_w := obter_valor_dinamico('select count(*) from gap_ritual where ie_obrigatorio is null', qt_registro_w);
	if (qt_registro_w > 0) then
		CALL exec_sql_dinamico('Matheus','update gap_ritual set ie_obrigatorio = ''S'' where ie_obrigatorio is null');
		commit;
	end if;
	end;
end if;

if (dt_versao_atual_cliente_w < to_date('26/09/2012','dd/mm/yyyy')) then
	begin

	qt_registro_w := obter_valor_dinamico('select count(*) from user_triggers where trigger_name = ''COM_FAQ_UPDATE'' ', qt_registro_w);

	if (qt_registro_w > 0) then
		CALL exec_sql_dinamico('Matheus','drop trigger com_faq_update');
	end if;

	qt_registro_w := obter_valor_dinamico('select count(*) from objeto_sistema where nm_objeto = ''COM_FAQ_UPDATE'' ', qt_registro_w);

	if (qt_registro_w > 0) then
		CALL exec_sql_dinamico('Matheus','delete from objeto_sistema where nm_Objeto = ''COM_FAQ_UPDATE'' ');
		commit;
	end if;
	end;
	/* Altera o campo DS_RESPOSTA para LONG*/

	CALL BACA_RESPOSTA_COM_FAQ();
end if;

if (dt_versao_atual_cliente_w < to_date('26/09/2012','dd/mm/yyyy')) then
	begin
	qt_registro_w := obter_valor_dinamico('select count(*) from perfil where ie_estrategico is null', qt_registro_w);
	if (qt_registro_w > 0) then
		CALL exec_sql_dinamico('Matheus','update perfil set ie_estrategico = ''N'' where ie_estrategico is null');
		commit;
	end if;
	end;
end if;

if (dt_versao_atual_cliente_w < to_date('05/10/2012','dd/mm/yyyy')) then
	begin
	qt_registro_w := obter_valor_dinamico('select count(*) from user_Constraints where constraint_name = ''PARCOM_UK'' ', qt_registro_w);
	if (qt_registro_w > 0) then
		CALL exec_sql_dinamico('Matheus','alter table parametros_comercial drop constraint PARCOM_UK ');
		qt_registro_w := obter_valor_dinamico('select count(*) from user_indexes where index_name = ''PARCOM_UK'' ', qt_registro_w);
		if (qt_registro_w > 0) then
			CALL exec_sql_dinamico('Matheus','drop index PARCOM_UK ');
			CALL exec_sql_dinamico('Matheus','delete from indice where nm_Indice = ''PARCOM_UK'' ');
			commit;
		end if;
	end if;
	end;
end if;

if (dt_versao_atual_cliente_w < to_date('08/10/2015','dd/mm/yyyy')) then
	CALL exec_sql_dinamico('dhoffman', 'alter table pessoa_fisica_alteracao add nr_serie_ctps_v varchar2(10) ');

	CALL exec_sql_dinamico('dhoffman', 'update	pessoa_fisica_alteracao set	nr_serie_ctps_v	= nr_serie_ctps where	nr_serie_ctps is not null ');

	CALL exec_sql_dinamico('dhoffman', 'alter table pessoa_fisica_alteracao drop column nr_serie_ctps ');

	CALL exec_sql_dinamico('dhoffman', 'alter table pessoa_fisica_alteracao add nr_serie_ctps varchar2(10) ');


	CALL exec_sql_dinamico('dhoffman', 'update	pessoa_fisica_alteracao set	nr_serie_ctps	= nr_serie_ctps_v where	nr_serie_ctps_v is not null ');
end if;


if (dt_versao_atual_cliente_w	>= to_date('30/05/2016','dd/mm/yyyy')) then

	select  count(*)
	into STRICT    qt_registro_w
	from    user_tab_columns
	where   table_name = 'PROJ_MUDANCA_ESCOPO'
	and     column_name = 'DS_IMPACTO';

	if (qt_registro_w > 0) then

		CALL Exec_sql_Dinamico('eberns', 'alter table PROJ_MUDANCA_ESCOPO modify DS_IMPACTO varchar2(2000)');
		CALL Exec_sql_Dinamico('eberns', 'alter table PROJ_MUDANCA_ESCOPO modify DS_RISCOS  varchar2(2000)');


	end if;

end if;

if (dt_versao_atual_cliente_w	>= to_date('15/08/2016','dd/mm/yyyy')) then

qt_registro_w := obter_valor_dinamico('select count(*) from valor_dominio where vl_dominio = ''I'' and cd_dominio = 1630 ', qt_registro_w);

	if (qt_registro_w > 0) then
		CALL exec_sql_dinamico('eberns','delete from valor_dominio where vl_dominio = ''I'' and cd_dominio = 1630 ');
	end if;

end if;

if (dt_versao_atual_cliente_w < to_date('15/08/2016','dd/mm/yyyy')) then

	select	count(*)
	into STRICT	qt_registro_w
	from	user_constraints
	where	constraint_name	= 'MKTMODIND_MODIMPL_FK';

	if (qt_registro_w > 0) then
		CALL exec_sql_dinamico('Eberns','Alter Table MKT_MODULO_INDICADOR drop constraint MKTMODIND_MODIMPL_FK');
	end if;

	select	count(*)
	into STRICT	qt_registro_w
	from	user_constraints
	where	constraint_name	= 'MKTMODINT_MODIMPL_FK';

	if (qt_registro_w > 0) then
		CALL exec_sql_dinamico('Eberns','Alter Table MKT_MODULO_INTEGRACAO drop constraint MKTMODINT_MODIMPL_FK');
	end if;

	select	count(*)
	into STRICT	qt_registro_w
	from	user_constraints
	where	constraint_name	= 'MKTMODREL_MODIMPL_FK';

	if (qt_registro_w > 0) then
		CALL exec_sql_dinamico('Eberns','Alter Table MKT_MODULO_RELATORIO drop constraint MKTMODREL_MODIMPL_FK');
	end if;

	select	count(*)
	into STRICT	qt_registro_w
	from	user_constraints
	where	constraint_name	= 'MKTMODTAB_MODIMPL_FK';

	if (qt_registro_w > 0) then
		CALL exec_sql_dinamico('Eberns','Alter Table MKT_MODULO_TABELA drop constraint MKTMODTAB_MODIMPL_FK');
	end if;

	select 	count(*)
	into STRICT	qt_registro_w
	from 	user_indexes
	where 	index_name = 'MKTMODIND_MODIMPL_FK_I';

	if (qt_registro_w > 0) then
		CALL exec_sql_dinamico('Eberns','drop index MKTMODIND_MODIMPL_FK_I');
	end if;

	select 	count(*)
	into STRICT	qt_registro_w
	from 	user_indexes
	where 	index_name = 'MKTMODINT_MODIMPL_FK_I';

	if (qt_registro_w > 0) then
		CALL exec_sql_dinamico('Eberns','drop index MKTMODINT_MODIMPL_FK_I');
	end if;

	select 	count(*)
	into STRICT	qt_registro_w
	from 	user_indexes
	where 	index_name = 'MKTMODREL_MODIMPL_FK_I';

	if (qt_registro_w > 0) then
		CALL exec_sql_dinamico('Eberns','drop index MKTMODREL_MODIMPL_FK_I');
	end if;

	select 	count(*)
	into STRICT	qt_registro_w
	from 	user_indexes
	where 	index_name = 'MKTMODTAB_MODIMPL_FK_I';

	if (qt_registro_w > 0) then
		CALL exec_sql_dinamico('Eberns','drop index MKTMODTAB_MODIMPL_FK_I');
	end if;

end if;

if (dt_versao_atual_cliente_w < to_date('25/08/2016','dd/mm/yyyy')) then
	select	count(*)
	into STRICT	qt_registro_w
	from	user_tab_columns
	where	table_name	= 'MKT_MODULO_FUNCAO'
	and	column_name	= 'NR_SEQ_MODULO';

	if (qt_registro_w > 0) then
		select	count(*)
		into STRICT	qt_registro_w
		from	tabela_atributo
		where	nm_tabela	= 'MKT_MODULO_FUNCAO'
		and	nm_atributo	= 'NR_SEQ_MODULO';
		if (qt_registro_w = 0) then
			CALL Exec_sql_Dinamico('Eberns', ' alter table MKT_MODULO_FUNCAO drop column NR_SEQ_MODULO ');
		end if;
	end if;

	select	count(*)
	into STRICT	qt_registro_w
	from	user_tab_columns
	where	table_name	= 'MKT_PRODUTO_REQUISITO'
	and	column_name	= 'DS_REQUISITOS'
	and	nullable	= 'N';

	if (qt_registro_w > 0) then
		CALL Exec_sql_Dinamico('Eberns', 'alter table mkt_produto_requisito modify DS_REQUISITOS null');
	end if;

end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE tasy_ajustar_base_interno ( nm_usuario_p text) FROM PUBLIC;

