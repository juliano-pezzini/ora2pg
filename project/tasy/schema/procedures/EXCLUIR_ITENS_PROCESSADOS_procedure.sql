-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE excluir_itens_processados (nr_interno_conta_p bigint) AS $body$
DECLARE


qt_proc_deducao_w	bigint;


BEGIN

if (nr_interno_conta_p IS NOT NULL AND nr_interno_conta_p::text <> '') then

	/*Verificar se a conta ainda está processada da forma antiga*/

	select	count(*)
	into STRICT	qt_proc_deducao_w
	from	conta_paciente a,
		conta_log_processamento b
	where	a.nr_interno_conta = b.nr_interno_conta_base
	and	a.nr_interno_conta = nr_interno_conta_p
	and	coalesce(a.ie_cancelamento::text, '') = '';

	if (coalesce(qt_proc_deducao_w,0) = 0) then
		CALL desfazer_processamento_conta(nr_interno_conta_p, wheb_usuario_pck.get_nm_usuario);
	else

		--Seta Null no proc princ dos procedimentos que estão em contas que foram canceladas
		update	procedimento_paciente a
		set 	a.nr_seq_proc_princ  = NULL
		where	exists (SELECT	1
				from	conta_log_processamento x,
						conta_paciente y
				where	x.nr_interno_conta_base = nr_interno_conta_p
				and		x.nr_interno_conta = y.nr_interno_conta
				and		y.ie_cancelamento = 'C'
				and		a.nr_interno_conta = x.nr_interno_conta
				and		a.nr_sequencia = x.nr_seq_item);

		--Seta Null no proc princ dos procedimentos que estão em contas que foram estornadas
		update	procedimento_paciente a
		set 	a.nr_seq_proc_princ  = NULL
		where	exists (SELECT 1
						 from 	conta_paciente y, conta_log_processamento x
						 where   x.nr_interno_conta_base = nr_interno_conta_p
						 and   	x.nr_interno_conta = y.nr_seq_conta_origem
						 and   	y.ie_cancelamento = 'E'
						 and   	a.nr_interno_conta = y.nr_interno_conta);

		delete
		from 	procedimento_paciente a
		where	a.nr_seq_proc_princ in (SELECT	nr_seq_item
										 from	conta_log_processamento x
										 where 	x.nr_interno_conta_base = nr_interno_conta_p)
		and not exists (select	1
						from 	conta_paciente y
						where 	a.nr_interno_conta = y.nr_interno_conta
						and 	(y.ie_cancelamento IS NOT NULL AND y.ie_cancelamento::text <> ''));

		--Delata os procedimentos gerados no processo
		delete
		from	procedimento_paciente a
		where	exists (SELECT	1
				from	conta_log_processamento x,
						conta_paciente y
				where	x.nr_interno_conta_base = nr_interno_conta_p
				and		x.nr_interno_conta = y.nr_interno_conta
				and		coalesce(y.ie_cancelamento::text, '') = ''
				and		a.nr_interno_conta = x.nr_interno_conta
				and		a.nr_sequencia = x.nr_seq_item);


		delete
		from	conta_log_processamento a
		where	a.nr_interno_conta_base = nr_interno_conta_p
		and		not exists ( SELECT	1
							 from	conta_paciente x
							 where	x.nr_interno_conta  = a.nr_interno_conta
							 and	(x.ie_cancelamento IS NOT NULL AND x.ie_cancelamento::text <> ''));

	end if;

	commit;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE excluir_itens_processados (nr_interno_conta_p bigint) FROM PUBLIC;

