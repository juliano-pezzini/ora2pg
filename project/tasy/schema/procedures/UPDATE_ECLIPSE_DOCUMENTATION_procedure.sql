-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE update_eclipse_documentation ( cd_externo_p text) AS $body$
DECLARE


  cd_convenio_w 			convenio.cd_convenio%type;
  nr_seq_eclipse_doc_w 		eclipse_documentation.nr_sequencia%type;
  cd_capability_w 			gpr_response.cd_capability%type;
  cd_capability_ver_w 		gpr_response.cd_capability_ver%type;
  cd_capability_role_w 		gpr_response.cd_capability_role%type;
  ds_notes_w				gpr_response.ds_notes%type := '';
  all_notes_w				eclipse_documentation.ds_notes%type;
  ie_imc_w 			varchar(1) := 'N';
  ie_opv_w 			varchar(1) := 'N';
  ie_ovv_w 			varchar(1) := 'N';
  ie_era_w 			varchar(1) := 'N';
  ie_oec_w 			varchar(1) := 'N';
  ie_ihc_w 			varchar(1) := 'N';
  ie_ovs_w 			varchar(1) := 'N';
  ie_ag_w  			varchar(1) := 'N';
  ie_sc_w  			varchar(1) := 'N';
  ie_mb_w  			varchar(1) := 'N';
  ie_pc_w  			varchar(1) := 'N';
  ie_ecf_w 			varchar(1) := 'N';
  ie_ecm_w 			varchar(1) := 'N';

  c01 CURSOR FOR
    SELECT cd_capability,
      cd_capability_ver,
      cd_capability_role,
	  ds_notes
    FROM gpr_response
    WHERE cd_participant = cd_externo_p;


BEGIN
  SELECT coalesce(MAX(cd_convenio), -1)
  INTO STRICT cd_convenio_w
  FROM convenio
  WHERE cd_externo = cd_externo_p;

  IF cd_convenio_w > 0 THEN
    OPEN c01;
    LOOP
      FETCH c01 INTO
        cd_capability_w,
        cd_capability_ver_w,
        cd_capability_role_w,
		ds_notes_w;
      EXIT WHEN NOT FOUND; /* apply on c01 */
	
	  IF (coalesce(all_notes_w::text, '') = '' or all_notes_w = '') THEN
		all_notes_w := ds_notes_w;
      ELSE
		all_notes_w := all_notes_w || chr(10) || ds_notes_w;
      END IF;
	
      SELECT coalesce(MAX(nr_sequencia), -1)
      INTO STRICT nr_seq_eclipse_doc_w
      FROM eclipse_documentation
      WHERE cd_convenio = cd_convenio_w;

      CASE upper(cd_capability_w)
      WHEN 'IMC' THEN
        ie_imc_w := 'Y';
      WHEN 'OPV' THEN
        ie_opv_w := 'Y';
      WHEN 'OVV' THEN
        ie_ovv_w := 'Y';
      WHEN 'ERA' THEN
        ie_era_w := 'Y';
      WHEN 'OEC' THEN
        ie_oec_w := 'Y';
      WHEN 'IHC' THEN
        ie_ihc_w := 'Y';
      WHEN 'OVS' THEN
        ie_ovs_w := 'Y';
      WHEN 'AG' THEN
        ie_ag_w := 'Y';
      WHEN 'SC' THEN
        ie_sc_w := 'Y';
      WHEN 'MB' THEN
        ie_mb_w := 'Y';
      WHEN 'PC' THEN
        ie_pc_w := 'Y';
      WHEN 'ECF' THEN
        ie_ecf_w := 'Y';
      WHEN 'ECM' THEN
        ie_ecm_w := 'Y';
      END CASE;

      IF nr_seq_eclipse_doc_w > 0 THEN
        UPDATE eclipse_documentation
        SET ie_imc           = ie_imc_w,
          ie_opv             = ie_opv_w,
          ie_ovv             = ie_ovv_w,
          ie_era             = ie_era_w,
          ie_ihc             = ie_ihc_w,
          ie_ovs             = ie_ovs_w,
          ie_ag              = ie_ag_w,
          ie_sc              = ie_sc_w,
          ie_mb              = ie_mb_w,
          ie_pc              = ie_pc_w,
          ie_ecf             = ie_ecf_w,
          ie_ecm             = ie_ecm_w,
          nr_version         = cd_capability_ver_w,
          ds_capability_role = cd_capability_role_w
        WHERE nr_sequencia   = nr_seq_eclipse_doc_w;

        COMMIT;

      ELSE

        SELECT nextval('eclipse_documentation_seq') INTO STRICT nr_seq_eclipse_doc_w;

        INSERT
        INTO eclipse_documentation(
            nr_sequencia,
            dt_atualizacao,
            nm_usuario,
            dt_atualizacao_nrec,
            nm_usuario_nrec,
            cd_convenio,
            ie_imc,
            ie_opv,
            ie_ovv,
            ie_era,
            ie_oec,
            ie_ihc,
            ie_ovs,
            ie_ag,
            ie_sc,
            ie_mb,
            ie_pc,
            ie_ecf,
            ie_ecm,
            nr_version,
            ds_capability_role
          )
          VALUES (
            nr_seq_eclipse_doc_w,
            clock_timestamp(),
            'TASY_BIFROST',
            clock_timestamp(),
            'TASY_BIFROST',
            cd_convenio_w,
            ie_imc_w,
            ie_opv_w,
            ie_ovv_w,
            ie_era_w,
            ie_oec_w,
            ie_ihc_w,
            ie_ovs_w,
            ie_ag_w,
            ie_sc_w,
            ie_mb_w,
            ie_pc_w,
            ie_ecf_w,
            ie_ecm_w,
            cd_capability_ver_w,
            cd_capability_role_w
          );

        COMMIT;

      END IF;
    END LOOP;

	UPDATE eclipse_documentation
	SET DS_NOTES = all_notes_w
	WHERE cd_convenio = cd_convenio_w;
  END IF;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE update_eclipse_documentation ( cd_externo_p text) FROM PUBLIC;

