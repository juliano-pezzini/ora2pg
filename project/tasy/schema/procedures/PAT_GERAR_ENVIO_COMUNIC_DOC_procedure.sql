-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pat_gerar_envio_comunic_doc ( nr_sequencia_p bigint, nm_usuario_p text, ie_evento_p text) AS $body$
DECLARE

 
nm_usuario_transf_w		varchar(15);
nm_usuario_aprov_w		varchar(15);
ds_titulo_w			varchar(80);
nm_pf_usuario_w			varchar(100);
nr_seq_classif_w			bigint;
ds_comunic_w			varchar(2000);
nm_usuario_dest_w			varchar(2000);

/*ie_evento_p 
1 - Comunicar liberação para a pessoa aprovação 
2 - Comunicar aprovação para o resp. transferencia/baixa do documento 
*/
 
 

BEGIN 
 
select	substr(obter_usuario_pessoa(cd_responsavel_transf),1,15), 
	substr(obter_usuario_pessoa(cd_responsavel_aprov),1,15) 
into STRICT	nm_usuario_transf_w, 
	nm_usuario_aprov_w 
from	pat_doc_transferencia 
where	nr_sequencia = nr_sequencia_p;
 
nm_pf_usuario_w := substr(obter_pessoa_fisica_usuario(nm_usuario_p, 'N'),1,100);
 
select	obter_classif_comunic('F') 
into STRICT	nr_seq_classif_w
;
 
if (ie_evento_p = '1') and (nm_usuario_aprov_w IS NOT NULL AND nm_usuario_aprov_w::text <> '') then 
	begin 
	ds_titulo_w 		:= wheb_mensagem_pck.get_texto(799278);
	ds_comunic_w		:= wheb_mensagem_pck.get_texto(799284) || ' ' || nr_sequencia_p || ' ' || wheb_mensagem_pck.get_texto(799289) || ' ' || nm_pf_usuario_w;
	nm_usuario_dest_w	:= nm_usuario_aprov_w;
	end;
elsif (ie_evento_p = '2') and (nm_usuario_transf_w IS NOT NULL AND nm_usuario_transf_w::text <> '') then 
	begin 
	ds_titulo_w 		:= wheb_mensagem_pck.get_texto(799279);
	ds_comunic_w		:= wheb_mensagem_pck.get_texto(799284) || ' ' || nr_sequencia_p || ' ' || wheb_mensagem_pck.get_texto(799301) || ' ' || nm_pf_usuario_w;
	nm_usuario_dest_w	:= nm_usuario_transf_w;
	end;
end if;
 
if (ds_titulo_w IS NOT NULL AND ds_titulo_w::text <> '') and (ds_comunic_w IS NOT NULL AND ds_comunic_w::text <> '') and (nm_usuario_dest_w IS NOT NULL AND nm_usuario_dest_w::text <> '') then 
	CALL gerar_comunic_padrao(clock_timestamp(), ds_titulo_w, ds_comunic_w, nm_usuario_p, 'N', nm_usuario_dest_w, 'N', nr_seq_classif_w, '', null, '', clock_timestamp(), '', '');
commit;
end if;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pat_gerar_envio_comunic_doc ( nr_sequencia_p bigint, nm_usuario_p text, ie_evento_p text) FROM PUBLIC;

