-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE update_dt_real_prot_int_pac (nr_seq_protocolo_p bigint) AS $body$
DECLARE


dt_inicial_real_w timestamp;
dt_final_real_w timestamp;
qt_etapas_incompletas_W bigint;



BEGIN

   select min(dt_inicial_real)
    into STRICT dt_inicial_real_w
    from PROTOCOLO_INT_PAC_ETAPA 
    where nr_seq_protocolo_int_pac = nr_seq_protocolo_p;

    select max(dt_final_real)
    into STRICT dt_final_real_w
    from PROTOCOLO_INT_PAC_ETAPA 
    where nr_seq_protocolo_int_pac = nr_seq_protocolo_p;

    select count(*)
    into STRICT qt_etapas_incompletas_W
    from PROTOCOLO_INT_PAC_ETAPA
    where coalesce(dt_final_real::text, '') = ''
    and nr_seq_protocolo_int_pac = nr_seq_protocolo_p
    and coalesce(ie_evento_sumario,'N') = 'N';

	if (dt_inicial_real_w IS NOT NULL AND dt_inicial_real_w::text <> '') then
        update PROTOCOLO_INT_PACIENTE set dt_inicial_real = dt_inicial_real_w where nr_sequencia = nr_seq_protocolo_p;
        commit;
    end if;

    if (qt_etapas_incompletas_W > 0) then
       dt_final_real_w := null;
    end if;

    update PROTOCOLO_INT_PACIENTE set dt_final_real = dt_final_real_w where nr_sequencia = nr_seq_protocolo_p;
    commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE update_dt_real_prot_int_pac (nr_seq_protocolo_p bigint) FROM PUBLIC;

