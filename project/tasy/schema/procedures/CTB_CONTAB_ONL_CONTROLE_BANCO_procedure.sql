-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE ctb_contab_onl_controle_banco ( doc_p INOUT ctb_documento, nm_usuario_p text) AS $body$
DECLARE

/*
===============================================================================
Purpose: Indentacao

Remarks: n/a

Who         When            What
----------  -----------     --------------------------------------------------

chjreinert  13/mai/2021     OS 2444975 - Indentacao

===============================================================================
*/
cd_agencia_cheque_w            cheque_cr_v.cd_agencia_bancaria%type;
cd_banco_cheque_w              banco.cd_banco%type;
cd_banco_ext_cheque_w          banco.cd_banco_externo%type;
cd_conta_contabil_banco_w      banco_estabelecimento_v.cd_conta_contabil%type;
cd_conta_transitoria_w         ctb_regra_estab_dif.cd_conta_contabil%type;
cd_empresa_w                   empresa.cd_empresa%type;
cd_estab_banco_od_w            banco_estabelecimento_v.cd_estabelecimento%type;
cd_historico_ct_w              ctb_regra_estab_dif.cd_historico%type;
cd_historico_w                 transacao_financeira.cd_historico_banco%type;
cd_processo_dcomp_w            varchar(255);
ctb_movimento_doc_w            ctb_online_pck.ctb_movimento_doc;
ctb_movimento_w                ctb_movimento%rowtype;
ctb_param_lote_cont_banco_w    ctb_param_lote_cont_banco%rowtype;
dados_contab_w                 ctb_contab_onl_lote_fin_pck.dados_contab_tf;
ds_atributos_w                 varchar(4000);
ds_banco_cheque_w              banco.ds_banco%type;
ds_banco_conta_w               varchar(255);
ds_banco_escrit_w              banco.ds_banco%type;
ds_banco_od_w                  banco_estabelecimento_v.ds_banco%type;
ds_banco_w                     banco_estabelecimento_v.ds_banco%type;
ds_bandeira_cartao_w           bandeira_cartao_cr.ds_bandeira%type;
ds_bandeira_cartao_ww          varchar(255);
ds_benef_origem_w              varchar(80);
ds_bordero_w                   bordero_pagamento.ds_bordero%type;
ds_caixa_od_w                  caixa.ds_caixa%type;
ds_cheque_cp_w                 varchar(180);
ds_compl_contab_cp_w           titulo_pagar.ds_compl_contab%type;
ds_comprovante_w               movto_cartao_cr.ds_comprovante%type;
ds_hist_pf_pj_w                titulo_pagar_v.ds_beneficiario%type;
ds_interno_w                   banco_estabelecimento_v.ds_interno%type;
ds_movto_cartao_w              varchar(255);
ds_nfe_cartao_w                varchar(150);
ds_nota_fiscal_cartao_w        varchar(150);
ds_notas_titulo_unificado_w    varchar(255);
ds_obs_adiant_pago_w           varchar(200);
ds_obs_movto_cartao_baixa_w    movto_cartao_cr_baixa.ds_observacao%type;
ds_obs_titulo_pagar_w          titulo_pagar.ds_observacao_titulo%type;
ds_obs_titulo_rec_w            titulo_receber.ds_observacao_titulo%type;
ds_pessoa_rec_cartao_w         varchar(255);
ds_pessoa_titulo_w             titulo_pagar_v.ds_beneficiario%type;
ds_proj_rec_w                  projeto_recurso.ds_projeto%type;
ds_razao_social_cheque_w       cheque_cr_v.ds_razao_social%type;
ds_tributo_w                   tributo.ds_tributo%type;
ie_benef_orig_trib_contab_w    ctb_param_lote_contas_pag.ie_benef_orig_trib_contab%type;
ie_contab_banco_w              transacao_financeira.ie_contab_banco%type;
ie_contab_cb_w                 transacao_financeira.ie_contab_cb%type;
ie_contab_desp_cartao_w        ctb_param_lote_contas_rec.ie_contab_desp_cartao%type;
ie_contab_prov_tributo_w       ctb_param_lote_contas_pag.ie_contab_prov_tributo%type;
ie_contab_trans_fin_baix_rec_w ctb_param_lote_tesouraria.ie_contab_trans_fin_baixa%type;
ie_contab_trans_fin_baixa_w    ctb_param_lote_tesouraria.ie_contab_trans_fin_baixa%type;
ie_contab_transit_w            varchar(1) := 'S';
ie_contab_w                    varchar(1);
ie_debito_credito_w            transacao_financeira.ie_banco%type;
ie_debito_credito_ww           varchar(1);
ie_estorno_ww                  varchar(50);
ie_forma_lanc_lote_cartao_w    ctb_param_lote_cont_banco.ie_forma_lanc_lote_cartao%type;
ie_gera_ctb_transit_w          varchar(1);
ie_nf_nfe_w                    varchar(15);
ie_permite_estab_dif_w         ctb_regra_estab_dif.ie_permite%type;
ie_regra_w                     varchar(255);
movto_trans_financ_w           movto_trans_financ%rowtype;
nm_agrupador_w                 agrupador_contabil.nm_atributo%type;
nm_estabelecimento_w           estabelecimento.nm_fantasia_estab%type;
nm_paciente_adiantamento_w     varchar(60);
nm_paciente_cheque_w           varchar(80);
nm_pessoa_adiant_pago_w        varchar(255);
nm_pessoa_adiantamento_w       varchar(200);
nm_pessoa_caixa_rec_w          varchar(80);
nm_pf_cheque_w                 cheque_cr_v.nm_pessoa_fisica%type;
nm_pf_pj_tit_original_w        varchar(80);
nr_adiant_cheque_w             cheque_cr_v.nr_adiantamento%type;
nr_bordero_w                   titulo_pagar_baixa_cc_contab_v.nr_bordero%type;
nr_cheque_adiant_pago_w        varchar(255);
nr_cheque_cr_w                 cheque_cr_v.nr_cheque%type;
nr_cheque_deposito_w           varchar(255);
nr_cheque_pago_w               cheque.nr_cheque%type;
nr_cheque_tit_pagar_w          varchar(100);
nr_cheque_w                    bordero_pagamento.nr_cheque%type;
nr_conta_cheque_w              cheque_cr_v.nr_conta%type;
nr_conta_od_w                  banco_estabelecimento_v.cd_conta%type;
nr_doc_w                       titulo_receber.nr_documento%type;
nr_nfe_imp_w                   nota_fiscal.nr_nfe_imp%type;
nr_nota_fiscal_w               nota_fiscal.nr_nota_fiscal%type;
nr_parc_cartao_total_w         varchar(40);
nr_parcela_cartao_w            bigint;
nr_parcela_w                   titulo_pagar.nr_parcelas%type;
nr_seq_baixa_cart_w            lote_baixa_cartao_cr.nr_sequencia%type;
nr_seq_baixa_cr_w              titulo_pagar_baixa_cc_contab_v.nr_seq_baixa%type;
nr_seq_banco_escrit_w          titulo_pagar_baixa_cc_contab_v.nr_seq_escrit%type;
nr_seq_caixa_rec_w             movto_cartao_cr.nr_seq_caixa_rec%type;
nr_seq_cheque_dep_w            deposito_cheque.nr_seq_cheque%type;
nr_seq_cni_w                   movto_banco_pend.nr_sequencia%type;
nr_seq_darf_w                  darf_titulo_pagar.nr_seq_darf%type;
nr_seq_liq_cc_w                titulo_pagar_baixa_cc_contab_v.nr_seq_baixa_cc%type;
nr_seq_movto_bco_pend_w        movto_banco_pend_baixa.nr_seq_movto_pend%type;
nr_seq_movto_trans_fin_w       titulo_pagar_baixa_cc_contab_v.nr_seq_movto_trans_fin%type;
nr_seq_nota_fiscal_w           titulo_pagar.nr_seq_nota_fiscal%type;
nr_seq_rpa_w                   titulo_pagar.nr_seq_rpa%type;
nr_seq_titulo_cheque_w         cheque_cr.nr_titulo%type;
nr_seq_trans_fin_baixa_w       titulo_pagar.nr_seq_trans_fin_baixa%type;
nr_titulo_original_w           titulo_pagar.nr_titulo_original%type;
nr_titulo_w                    titulo_pagar_baixa_cc_contab_v.nr_titulo%type;
qt_parcelas_w                  bigint;
qt_regra_estab_origem_w        bigint;
vl_cheque_w                    cheque.vl_cheque%type;
vl_titulo_banco_w              titulo_pagar_baixa_cc.vl_pago%type;
ie_intercompany_w              varchar(1) := 'N';
ie_contabiliza_w               varchar(1) := 'N';
cd_estab_intercompany_w        ctb_movimento.cd_estab_intercompany%type;
nr_seq_cni_orig_w              movto_trans_financ.nr_seq_movto_orig%type;
cd_estab_transit_w             estabelecimento.cd_estabelecimento%type;
cd_estab_banco_w               estabelecimento.cd_estabelecimento%type;
nr_sequencia_movto_w           bigint;
cd_interno_intercompany_ori_w  estabelecimento.cd_interno%type;
cd_interno_intercompany_des_w  estabelecimento.cd_interno%type;
cd_serie_nf_w                  nota_fiscal.cd_serie_nf%type;


c020 CURSOR FOR
    SELECT  nr_cheque,
            vl_cheque
    from    cheque_v
    where   nr_sequencia in (
            SELECT  nr_seq_cheque
            from    cheque_bordero_titulo
            where   nr_bordero  = nr_bordero_w)
    and coalesce(dt_cancelamento::text, '') = '';


BEGIN
dados_contab_w      := null;
ctb_movimento_doc_w := null;
ctb_movimento_w     := null;
dados_contab_w.doc  := doc_p;

cd_empresa_w                    := obter_empresa_estab(doc_p.cd_estabelecimento);
dados_contab_w.dt_transacao     := doc_p.dt_competencia;
dados_contab_w.nr_seq_trans_fin := doc_p.nr_seq_trans_financ;
dados_contab_w.nm_atributo      := doc_p.nm_atributo;
dados_contab_w.nm_tabela        := doc_p.nm_tabela;

select  x.*
into STRICT    ctb_param_lote_cont_banco_w
from ( SELECT  a.*
    from    ctb_param_lote_cont_banco a
    where   a.cd_empresa    = cd_empresa_w
    and     coalesce(a.cd_estab_exclusivo, doc_p.cd_estabelecimento) = doc_p.cd_estabelecimento
    order   by coalesce(a.cd_estab_exclusivo,0) desc) x LIMIT 1;

begin
select coalesce(ie_contab_desp_cartao, 'N'),
       coalesce(ie_contab_trans_fin_baixa, 'N')
into STRICT   ie_contab_desp_cartao_w,
       ie_contab_trans_fin_baix_rec_w
from   ctb_param_lote_contas_rec
where  cd_empresa = cd_empresa_w
and    coalesce(cd_estab_exclusivo, doc_p.cd_estabelecimento) = doc_p.cd_estabelecimento;
exception
when others then
    ie_contab_desp_cartao_w        := 'N';
    ie_contab_trans_fin_baix_rec_w := 'N';
end;

begin
select coalesce(ie_contab_trans_fin_baixa, 'N')
into STRICT   ie_contab_trans_fin_baixa_w
from   ctb_param_lote_tesouraria
where  cd_empresa = cd_empresa_w
and    coalesce(cd_estab_exclusivo, doc_p.cd_estabelecimento) = doc_p.cd_estabelecimento;
exception
when others then
    ie_contab_trans_fin_baixa_w := 'N';
end;

begin
select coalesce(ie_forma_lanc_lote_cartao, 'P')
into STRICT   ie_forma_lanc_lote_cartao_w
from   ctb_param_lote_cont_banco
where  cd_empresa = cd_empresa_w
and    coalesce(cd_estab_exclusivo, doc_p.cd_estabelecimento) = doc_p.cd_estabelecimento;
exception
when others then
    ie_forma_lanc_lote_cartao_w := 'P';
end;

begin
select coalesce(ie_benef_orig_trib_contab, 'N'),
       coalesce(ie_contab_trans_fin_baixa, 'N'),
       coalesce(ie_contab_prov_tributo, 'N')
into STRICT   ie_benef_orig_trib_contab_w,
       ie_contab_trans_fin_baixa_w,
       ie_contab_prov_tributo_w
from   ctb_param_lote_contas_pag
where  cd_empresa = cd_empresa_w
and    coalesce(cd_estab_exclusivo, doc_p.cd_estabelecimento) = doc_p.cd_estabelecimento;
exception
when others then
    ie_benef_orig_trib_contab_w := 'N';
    ie_contab_trans_fin_baixa_w := 'N';
    ie_contab_prov_tributo_w    := 'N';
end;

select max(nm_fantasia_estab)
into STRICT   nm_estabelecimento_w
from   estabelecimento
where  cd_estabelecimento = doc_p.cd_estabelecimento;

nm_agrupador_w := coalesce(trim(both obter_agrupador_contabil(doc_p.cd_tipo_lote_contabil)), 'NR_SEQ_MOVTO_TRANS_FIN');

if doc_p.nm_tabela = 'TITULO_PAGAR_BAIXA_CONTAB_V' and doc_p.nm_atributo ='VL_OUTRAS_DESPESAS' and ctb_param_lote_cont_banco_w.ie_contab_cp_no_cb = 'S' then
        select 'S',
               a.nr_seq_conta_banco, --5
               b.cd_cgc, --6
               a.cd_conta_contabil, --7
               a.cd_centro_custo, --8
               a.nr_titulo, --11
               b.cd_pessoa_fisica, --13
               obter_pessoa_titulo_pagar(a.nr_titulo) ds_hist_pf_pj, --17
               a.nr_bordero, --19
               a.nr_titulo, --20
               b.nr_seq_nota_fiscal, --27
               b.nr_titulo nr_seq_titulo_pagar, --28
               b.ds_compl_contab ds_compl_contab_cp, --33
               b.cd_estabelecimento, --34
               obter_pessoa_titulo_pagar(a.nr_titulo), --38
               coalesce(obter_movto_trans_financ_orig(a.nr_seq_movto_trans_fin), 0) nr_seq_movto_orig, --45
               a.nr_seq_escrit nr_seq_banco_escrit, --46
               null nr_seq_liq_cc, --51
               a.nr_seq_movto_trans_fin nr_seq_movto_trans_fin, --59
               a.cd_tipo_baixa, --61
               a.nr_sequencia nr_seq_baixa_cr, --62
               a.cd_moeda --70
        into STRICT   ie_contabiliza_w,
               dados_contab_w.nr_seq_conta_banco, --5
               dados_contab_w.cd_cnpj, --6
               dados_contab_w.cd_conta_contabil, --7
               dados_contab_w.cd_centro_custo, --8
               movto_trans_financ_w.nr_sequencia, --11
               dados_contab_w.cd_pessoa_fisica, --13
               ds_hist_pf_pj_w, --17
               nr_bordero_w, --19
               nr_titulo_w, --20
               nr_seq_nota_fiscal_w, --27
               dados_contab_w.nr_titulo_pagar, --28
               ds_compl_contab_cp_w, --33
               dados_contab_w.cd_estab_movto, --34
               ds_pessoa_titulo_w, --38
               movto_trans_financ_w.nr_seq_movto_orig, --45
               nr_seq_banco_escrit_w, --46
               nr_seq_liq_cc_w, --51
               nr_seq_movto_trans_fin_w, --59
               dados_contab_w.cd_tipo_baixa, --61
               nr_seq_baixa_cr_w, --62
               dados_contab_w.cd_moeda --70
        from   titulo_pagar b,
               titulo_pagar_baixa a
        where  a.nr_titulo = doc_p.nr_documento
        and    a.nr_sequencia = doc_p.nr_seq_doc_compl
        and    doc_p.nm_atributo = 'VL_OUTRAS_DESPESAS'
        and    a.nr_titulo = b.nr_titulo
        and    (a.nr_seq_trans_fin IS NOT NULL AND a.nr_seq_trans_fin::text <> '')
        and    coalesce(a.vl_outras_despesas, 0) <> 0;

    elsif doc_p.nm_tabela = 'TITULO_PAGAR_BAIXA_CONTAB_V' and doc_p.nm_atributo <> 'VL_PAGO' and ctb_param_lote_cont_banco_w.ie_contab_cp_no_cb = 'S' then
        begin
        select 'S',
               a.nr_seq_conta_banco, --5
               b.cd_cgc, --6
               a.cd_conta_contabil, --7
               a.cd_centro_custo, --8
               a.nr_titulo, --11
               b.cd_pessoa_fisica, --13
               obter_pessoa_titulo_pagar(a.nr_titulo) ds_hist_pf_pj, --17
               a.nr_bordero, --19
               a.nr_titulo, --20
               b.nr_seq_nota_fiscal, --27
               b.nr_titulo nr_seq_titulo_pagar, --28
               b.ds_compl_contab ds_compl_contab_cp, --33
               b.cd_estabelecimento, --34
               obter_pessoa_titulo_pagar(a.nr_titulo), --38
               coalesce(obter_movto_trans_financ_orig(a.nr_seq_movto_trans_fin), 0) nr_seq_movto_orig, --45
               a.nr_seq_escrit nr_seq_banco_escrit, --46
               a.nr_seq_baixa_cc nr_seq_liq_cc, --51
               a.nr_seq_movto_trans_fin nr_seq_movto_trans_fin, --59
               a.cd_tipo_baixa, --61
               a.nr_seq_baixa nr_seq_baixa_cr, --62
               a.cd_moeda --70
        into STRICT   ie_contabiliza_w,
               dados_contab_w.nr_seq_conta_banco, --5
               dados_contab_w.cd_cnpj, --6
               dados_contab_w.cd_conta_contabil, --7
               dados_contab_w.cd_centro_custo, --8
               movto_trans_financ_w.nr_sequencia, --11
               dados_contab_w.cd_pessoa_fisica, --13
               ds_hist_pf_pj_w, --17
               nr_bordero_w, --19
               nr_titulo_w, --20
               nr_seq_nota_fiscal_w, --27
               dados_contab_w.nr_titulo_pagar, --28
               ds_compl_contab_cp_w, --33
               dados_contab_w.cd_estab_movto, --34
               ds_pessoa_titulo_w, --38
               movto_trans_financ_w.nr_seq_movto_orig, --45
               nr_seq_banco_escrit_w, --46
               nr_seq_liq_cc_w, --51
               nr_seq_movto_trans_fin_w, --59
               dados_contab_w.cd_tipo_baixa, --61
               nr_seq_baixa_cr_w, --62
               dados_contab_w.cd_moeda --70
        from   titulo_pagar b,
               titulo_pagar_baixa_cc_contab_v a
        where  a.nr_titulo = doc_p.nr_documento
        and    a.nr_seq_baixa = doc_p.nr_seq_doc_compl
        and    a.ds_atributo = doc_p.nm_atributo
        and    a.nr_titulo = b.nr_titulo
        and    (a.nr_seq_trans_fin IS NOT NULL AND a.nr_seq_trans_fin::text <> '');
        end;

    elsif doc_p.nm_tabela = 'TITULO_RECEBER_LIQ_CONTAB_V' and doc_p.nm_atributo not in ('VL_RECEBIDO', 'VL_RECEBIDO_TESOURARIA') and
          ctb_param_lote_cont_banco_w.ie_contab_cp_no_cb = 'S' then
        begin
        select 'S',
               a.nr_seq_conta_banco, --5
               b.cd_cgc, --6
               a.cd_centro_custo, --8
               a.nr_titulo, --11
               b.cd_pessoa_fisica, --13
               substr(obter_nome_pf_pj(b.cd_pessoa_fisica, b.cd_cgc), 1, 255) ds_hist_pf_pj, --17
               obter_bordero_tit_rec(a.nr_titulo) nr_bordero, --19
               a.nr_titulo, --20
               coalesce(to_char(b.nr_documento), ''), --21
               b.nr_titulo nr_seq_titulo_receber, --29
               b.cd_estabelecimento, --34
               obter_pessoa_titulo_receber(b.nr_titulo), --38
               CASE WHEN coalesce(d.ie_agrupa_lote_cb, 'S')='N' THEN                      coalesce((select max(x.nr_seq_movto_orig) from movto_trans_financ x where x.nr_sequencia = a.nr_seq_movto_trans_fin), 0)  ELSE 0 END  nr_seq_movto_orig, --45
               a.nr_seq_movto_trans_fin nr_seq_movto_trans_fin, --59
               a.nr_seq_baixa nr_seq_baixa_cr, --62
               a.cd_moeda --70
        into STRICT   ie_contabiliza_w,
               dados_contab_w.nr_seq_conta_banco, --5
               dados_contab_w.cd_cnpj, --6
               dados_contab_w.cd_centro_custo, --8
               movto_trans_financ_w.nr_sequencia, --11
               dados_contab_w.cd_pessoa_fisica, --13
               ds_hist_pf_pj_w, --17
               nr_bordero_w, --19
               nr_titulo_w, --20
               nr_doc_w, --21
               dados_contab_w.nr_titulo_receber, --29
               dados_contab_w.cd_estab_movto, --34
               ds_pessoa_titulo_w, --38
               movto_trans_financ_w.nr_seq_movto_orig, --45
               nr_seq_movto_trans_fin_w, --59
               nr_seq_baixa_cr_w, --62
               dados_contab_w.cd_moeda --70
        from   titulo_receber b,
               titulo_receber_liq_contab_v2 a,
               transacao_financeira d
        where  a.nr_titulo = doc_p.nr_documento
        and    a.nr_seq_baixa = doc_p.nr_seq_doc_compl
        and    a.ds_atributo = doc_p.nm_atributo
        and    d.nr_sequencia = a.nr_seq_trans_fin
        and    a.nr_titulo = b.nr_titulo
        and    (a.nr_seq_trans_fin IS NOT NULL AND a.nr_seq_trans_fin::text <> '');
        end;

    elsif doc_p.nm_tabela = 'MOVTO_TRANS_FINANC' and doc_p.nm_atributo in ('VL_TRANSACAO', 'VL_TRANSACAO_ESTRANG', 'VL_MOEDA_COMPLEMENTAR') then
        begin
        select 'S',
               b.nr_seq_banco, /* Francisco OS 83427 - 06/03/2008 - Troquei de NR_SEQ_BANCO_OD para NR_SEQ_BANCO */
 --5
               substr(obter_compl_trans_fin(b.nr_sequencia, 'PJ'), 1, 255) cd_cgc, --6
               b.cd_conta_contabil, --7
               coalesce(e.cd_centro_custo, b.cd_centro_custo), --8
               ie_banco, --10 --10
               coalesce(b.nr_sequencia, 0), --11
               ds_historico, --12
               substr(obter_compl_trans_fin(b.nr_sequencia, 'PF'), 1, 255) cd_pessoa_fisica, --13
               c.cd_conta_contabil, --14
               d.cd_historico_banco, --15
               substr(coalesce(c.ds_interno, obter_banco_e_conta(c.nr_sequencia)), 1, 255), --16
               substr(obter_compl_trans_fin(b.nr_sequencia, 'N'), 1, 255) ds_compl_pf_pj, --17
               substr(obter_se_trans_contab(d.nr_sequencia), 1, 1) ie_contab, --18
               coalesce(b.nr_bordero, 0), --19
               CASE WHEN doc_p.nm_atributo='VL_TRANSACAO' THEN  0  ELSE coalesce(b.nr_seq_titulo_pagar, b.nr_seq_titulo_receber) END  nr_titulo, --20
               coalesce(b.nr_documento, ''), --21
               coalesce(b.nr_adiantamento, 0), --22
               b.cd_historico, --23
               b.nr_adiant_pago, --24
               b.nr_bordero_rec, --25
               b.nr_interno_conta, --26
               (obter_dados_tit_pagar(b.nr_seq_titulo_pagar, 'NFSEQ'))::numeric  nr_seq_nota_fiscal, --27
               b.nr_seq_titulo_pagar, --28
               b.nr_seq_titulo_receber, --29
               b.nr_seq_cheque, --10 --30
               c.ds_banco, --31
               b.nr_seq_cheque_cp, --32
               substr(obter_descricao_padrao('TITULO_PAGAR', 'DS_COMPL_CONTAB', b.nr_seq_titulo_pagar), 1, 255) ds_compl_contab_cp, --33
               b.cd_estabelecimento cd_estabelecimento, --34
               b.nr_seq_caixa_od, --35
               b.nr_seq_movto_cartao, --36
               b.nr_seq_banco_od, --37
               substr(coalesce(obter_pessoa_titulo_pagar(b.nr_seq_titulo_pagar), obter_pessoa_titulo_receber(b.nr_seq_titulo_receber)), 1, 80), --38
               coalesce(b.ie_estorno, 'N') ie_estorno, --44
               coalesce(b.nr_seq_movto_orig, 0) nr_seq_movto_orig, --45
               b.nr_seq_banco_escrit, --46
               b.nr_seq_proj_rec, --52
               b.nr_seq_movto_transf_bco, --54
               obter_movto_banco_pend(b.nr_sequencia) nr_seq_movto_banco_pend, --55
               b.nr_seq_parc_cartao, --56
               b.nr_seq_lote_cartao, --57
               substr(obter_movto_banco_pend_orig(b.nr_sequencia), 1, 10) nr_seq_cni, --58
               b.nr_sequencia, --59
               b.nr_seq_deposito, -- KOliveira --60
               b.nr_seq_perda, --63
               b.nr_seq_cobr_escrit nr_seq_cobr_escrit, --64
               b.nr_seq_concil, --69
               b.cd_moeda, --70
               substr(obter_movto_banco_pend_orig(b.nr_seq_movto_orig), 1, 10) nr_seq_cni_orig --71
        into STRICT   ie_contabiliza_w,
               dados_contab_w.nr_seq_conta_banco, --5
               dados_contab_w.cd_cnpj, --6
               dados_contab_w.cd_conta_contabil, --7
               dados_contab_w.cd_centro_custo, --8
               ie_debito_credito_w, --10
               movto_trans_financ_w.nr_sequencia, --11
               movto_trans_financ_w.ds_historico, --12
               dados_contab_w.cd_pessoa_fisica, --13
               cd_conta_contabil_banco_w, --14
               cd_historico_w, --15
               ds_banco_conta_w, --16
               ds_hist_pf_pj_w, --17
               ie_contab_w, --18
               nr_bordero_w, --19
               nr_titulo_w, --20
               nr_doc_w, --21
               movto_trans_financ_w.nr_adiantamento, --22
               movto_trans_financ_w.cd_historico, --23
               movto_trans_financ_w.nr_adiant_pago, --24
               movto_trans_financ_w.nr_bordero_rec, --25
               movto_trans_financ_w.nr_interno_conta, --26
               nr_seq_nota_fiscal_w, --27
               dados_contab_w.nr_titulo_pagar, --28
               dados_contab_w.nr_titulo_receber, --29
               movto_trans_financ_w.nr_seq_cheque, --30
               ds_banco_w, --31
               movto_trans_financ_w.nr_seq_cheque_cp, --32
               ds_compl_contab_cp_w, --33
               dados_contab_w.cd_estab_movto, --34
               movto_trans_financ_w.nr_seq_caixa_od, --35
               movto_trans_financ_w.nr_seq_movto_cartao, --36
               dados_contab_w.nr_seq_banco_od, --37
               ds_pessoa_titulo_w, --38
               movto_trans_financ_w.ie_estorno, --44
               movto_trans_financ_w.nr_seq_movto_orig, --45
               nr_seq_banco_escrit_w, --46
               dados_contab_w.nr_seq_proj_rec, --52
               movto_trans_financ_w.nr_seq_movto_transf_bco, --54
               nr_seq_movto_bco_pend_w, --55
               movto_trans_financ_w.nr_seq_parc_cartao, --56
               movto_trans_financ_w.nr_seq_lote_cartao, --57
               nr_seq_cni_w, --58
               nr_seq_movto_trans_fin_w, --59
               movto_trans_financ_w.nr_seq_deposito, --60
               movto_trans_financ_w.nr_seq_perda, --KOliveira --63
               movto_trans_financ_w.nr_seq_cobr_escrit, --64
               movto_trans_financ_w.nr_seq_concil, --69
               dados_contab_w.cd_moeda, --70
               nr_seq_cni_orig_w --71
        FROM transacao_financeira d, banco_estabelecimento_v c, banco_saldo a, movto_trans_financ b
LEFT OUTER JOIN movto_trans_financ_cc e ON (b.nr_sequencia = e.nr_seq_movto_trans)
WHERE coalesce(coalesce(b.nr_seq_titulo_pagar, b.nr_seq_titulo_receber), b.nr_sequencia) = doc_p.nr_documento and b.nr_sequencia = coalesce(doc_p.nr_seq_doc_compl, b.nr_sequencia) and a.nr_seq_conta = c.nr_sequencia and a.nr_sequencia = b.nr_seq_saldo_banco and (b.nr_seq_trans_financ IS NOT NULL AND b.nr_seq_trans_financ::text <> '') and coalesce(b.nr_seq_caixa::text, '') = '' and ie_banco in ('D', 'C', 'T') and b.nr_seq_trans_financ = d.nr_sequencia and d.ie_contab_cb = 'S'  and CASE WHEN doc_p.nm_atributo='VL_TRANSACAO_ESTRANG' THEN                      coalesce(b.vl_transacao_estrang, 0) WHEN doc_p.nm_atributo='VL_MOEDA_COMPLEMENTAR' THEN                       coalesce(b.vl_complemento, 0)  ELSE 1 END  <> 0;
        end;

    elsif doc_p.nm_tabela = 'CHEQUE_CR' and doc_p.nm_atributo = 'VL_CHEQUE_DEPOSITO' then
        begin
        select 'S',
               b.nr_seq_banco, /* Francisco OS 83427 - 06/03/2008 - Troquei de NR_SEQ_BANCO_OD para NR_SEQ_BANCO */
 --5
               substr(obter_compl_trans_fin(b.nr_sequencia, 'PJ'), 1, 255) cd_cgc, --6
               b.cd_conta_contabil, --7
               coalesce(e.cd_centro_custo, b.cd_centro_custo), --8
               ie_banco, --10
               b.nr_sequencia, --11
               ds_historico, --12
               substr(obter_compl_trans_fin(b.nr_sequencia, 'PF'), 1, 255) cd_pessoa_fisica, --13
               c.cd_conta_contabil, --14
               d.cd_historico_banco, --15
               substr(obter_banco_e_conta(c.nr_sequencia), 1, 255), --16
               substr(obter_compl_trans_fin(b.nr_sequencia, 'N'), 1, 255) ds_compl_pf_pj, --17
               substr(obter_se_trans_contab(d.nr_sequencia), 1, 1) ie_contab, --18
               b.nr_bordero, --19
               0 nr_titulo, --20
               coalesce(b.nr_documento, ''), --21
               coalesce(b.nr_adiantamento, 0), --22
               b.cd_historico, --23
               b.nr_adiant_pago, --24
               b.nr_bordero_rec, --25
               b.nr_interno_conta, --26
               b.nr_seq_nota_fiscal, --27
               b.nr_seq_titulo_pagar, --28
               b.nr_seq_titulo_receber, --29
               f.nr_seq_cheque, --30
               c.ds_banco, --31
               b.nr_seq_cheque_cp, --32
               substr(obter_descricao_padrao('TITULO_PAGAR', 'DS_COMPL_CONTAB', b.nr_seq_titulo_pagar), 1, 255) ds_compl_contab_cp, --33
               b.nr_seq_caixa_od, --35
               b.nr_seq_movto_cartao, --36
               b.nr_seq_banco_od, --37
               coalesce(obter_pessoa_titulo_pagar(b.nr_seq_titulo_pagar), obter_pessoa_titulo_receber(b.nr_seq_titulo_receber)), --38
               f.nr_seq_cheque nr_seq_cheque_dep, --43
               coalesce(b.ie_estorno, 'N') ie_estorno, --44
               coalesce(b.nr_seq_movto_orig, 0) nr_seq_movto_orig, --45
               coalesce(b.nr_seq_banco_escrit, 0) nr_seq_banco_escrit, --46
               b.nr_seq_proj_rec, --52
               b.nr_seq_movto_transf_bco, --54
               obter_movto_banco_pend(b.nr_sequencia) nr_seq_movto_banco_pend, --55
               b.nr_seq_parc_cartao, --56
               b.nr_seq_lote_cartao, --57
               substr(obter_movto_banco_pend_orig(b.nr_sequencia), 1, 10) nr_seq_cni, --58
               b.nr_sequencia, --59
               b.nr_seq_perda, --63
               b.nr_seq_cobr_escrit nr_seq_cobr_escrit, --64
               b.nr_seq_concil, --69
               b.cd_moeda, --70
               substr(obter_movto_banco_pend_orig(b.nr_seq_movto_orig), 1, 10) nr_seq_cni_orig --71
        into STRICT   ie_contabiliza_w,
               dados_contab_w.nr_seq_conta_banco, --5
               dados_contab_w.cd_cnpj, --6
               dados_contab_w.cd_conta_contabil, --7
               dados_contab_w.cd_centro_custo, --8
               ie_debito_credito_w, --10
               movto_trans_financ_w.nr_sequencia, --11
               movto_trans_financ_w.ds_historico, --12
               dados_contab_w.cd_pessoa_fisica, --13
               cd_conta_contabil_banco_w, --14
               cd_historico_w, --15
               ds_banco_conta_w, --16
               ds_hist_pf_pj_w, --17
               ie_contab_w, --18
               nr_bordero_w, --19
               nr_titulo_w, --20
               nr_doc_w, --21
               movto_trans_financ_w.nr_adiantamento, --22
               movto_trans_financ_w.cd_historico, --23
               movto_trans_financ_w.nr_adiant_pago, --24
               movto_trans_financ_w.nr_bordero_rec, --25
               movto_trans_financ_w.nr_interno_conta, --26
               nr_seq_nota_fiscal_w, --27
               dados_contab_w.nr_titulo_pagar, --28
               dados_contab_w.nr_titulo_receber, --29
               movto_trans_financ_w.nr_seq_cheque, --30
               ds_banco_w, --31
               movto_trans_financ_w.nr_seq_cheque_cp, --32
               ds_compl_contab_cp_w, --33
               movto_trans_financ_w.nr_seq_caixa_od, --35
               movto_trans_financ_w.nr_seq_movto_cartao, --36
               dados_contab_w.nr_seq_banco_od, --37
               ds_pessoa_titulo_w, --38
               nr_seq_cheque_dep_w, --43
               movto_trans_financ_w.ie_estorno, --44
               movto_trans_financ_w.nr_seq_movto_orig, --45
               nr_seq_banco_escrit_w, --46
               dados_contab_w.nr_seq_proj_rec, --52
               movto_trans_financ_w.nr_seq_movto_transf_bco, --54
               nr_seq_movto_bco_pend_w, --55
               movto_trans_financ_w.nr_seq_parc_cartao, --56
               movto_trans_financ_w.nr_seq_lote_cartao, --57
               nr_seq_cni_w, --58
               nr_seq_movto_trans_fin_w, --59
               movto_trans_financ_w.nr_seq_perda, --KOliveira --63
               movto_trans_financ_w.nr_seq_cobr_escrit, --64
               movto_trans_financ_w.nr_seq_concil, --69
               dados_contab_w.cd_moeda, --70
               nr_seq_cni_orig_w
        FROM cheque_cr g, deposito_cheque f, transacao_financeira d, banco_estabelecimento_v c, banco_saldo a, movto_trans_financ b
LEFT OUTER JOIN movto_trans_financ_cc e ON (b.nr_sequencia = e.nr_seq_movto_trans)
WHERE coalesce(coalesce(b.nr_seq_titulo_pagar, b.nr_seq_titulo_receber), b.nr_sequencia) = doc_p.nr_documento and b.nr_sequencia = coalesce(doc_p.nr_seq_doc_compl, b.nr_sequencia) and a.nr_seq_conta = c.nr_sequencia and a.nr_sequencia = b.nr_seq_saldo_banco and f.nr_seq_cheque = g.nr_seq_cheque and f.nr_seq_deposito = b.nr_seq_deposito and b.nr_seq_trans_financ = d.nr_sequencia  and d.ie_banco in ('D', 'C', 'T') and (b.nr_seq_trans_financ IS NOT NULL AND b.nr_seq_trans_financ::text <> '') and d.ie_contab_cb = 'S';
        end;

    elsif doc_p.nm_tabela = 'MOVTO_CARTAO_CR_PARCELA' and ie_contab_desp_cartao_w = 'S' then
        begin
        if doc_p.nm_atributo = 'VL_PARCELA_CARTAO' then
            begin
            select 'S',
                   c.nr_seq_banco       nr_seq_conta_banco, --5
                   b.cd_pessoa_fisica, --13
                   b.cd_estabelecimento, --34
                   c.nr_sequencia       nr_seq_movto_trans_fin, --59
                   c.cd_moeda --70
            into STRICT   ie_contabiliza_w,
                   dados_contab_w.nr_seq_conta_banco, --5
                   dados_contab_w.cd_pessoa_fisica, --13
                   dados_contab_w.cd_estab_movto, --34
                   nr_seq_movto_trans_fin_w, --59
                   dados_contab_w.cd_moeda --70
            from   movto_cartao_cr_parcela a, movto_cartao_cr b, movto_trans_financ c
            where  c.nr_sequencia = doc_p.nr_documento
            and    b.nr_sequencia = doc_p.nr_seq_doc_compl
            and    a.nr_sequencia = doc_p.nr_doc_analitico
            and    a.nr_seq_movto = b.nr_sequencia
            and    c.nr_seq_movto_cartao = b.nr_sequencia
            and    (c.nr_seq_movto_cartao IS NOT NULL AND c.nr_seq_movto_cartao::text <> '')
            and    coalesce(b.nr_seq_caixa_rec::text, '') = '';
            end;

        elsif doc_p.nm_atributo = 'VL_DESPESA_CARTAO' and ie_forma_lanc_lote_cartao_w = 'P' then
            begin
            select 'S',
                   c.nr_seq_banco       nr_seq_conta_banco, --5
                   b.cd_pessoa_fisica, --13
                   b.cd_estabelecimento, --34
                   c.nr_sequencia       nr_seq_movto_trans_fin, --59
                   c.nr_seq_concil, --69
                   c.cd_moeda --70
            into STRICT   ie_contabiliza_w,
                   dados_contab_w.nr_seq_conta_banco, --5
                   dados_contab_w.cd_pessoa_fisica, --13
                   dados_contab_w.cd_estab_movto, --34
                   nr_seq_movto_trans_fin_w, --59
                   movto_trans_financ_w.nr_seq_concil, --69
                   dados_contab_w.cd_moeda --70
            from   movto_cartao_cr_parcela a, movto_cartao_cr b, movto_trans_financ c
            where  c.nr_sequencia = doc_p.nr_documento
            and    b.nr_sequencia = doc_p.nr_seq_doc_compl
            and    a.nr_sequencia = doc_p.nr_doc_analitico
            and    a.nr_seq_movto = b.nr_sequencia
            and    c.nr_seq_movto_cartao = b.nr_sequencia
            and    coalesce(b.nr_seq_caixa_rec::text, '') = ''
            and    (c.nr_seq_movto_cartao IS NOT NULL AND c.nr_seq_movto_cartao::text <> '');
            end;

        elsif doc_p.nm_atributo = 'VL_DESPESA_CARTAO' and ie_forma_lanc_lote_cartao_w = 'L' then
            begin
            select 'S',
                   c.nr_seq_banco       nr_seq_conta_banco, --5
                   b.cd_pessoa_fisica, --13
                   b.cd_estabelecimento, --34
                   c.nr_seq_lote_cartao, --57
                   c.nr_sequencia       nr_seq_movto_trans_fin, --59
                   c.nr_seq_concil, --69
                   c.cd_moeda --70
            into STRICT   ie_contabiliza_w,
                   dados_contab_w.nr_seq_conta_banco, --5
                   dados_contab_w.cd_pessoa_fisica, --13
                   dados_contab_w.cd_estab_movto, --34
                   movto_trans_financ_w.nr_seq_lote_cartao, --57
                   nr_seq_movto_trans_fin_w, --59
                   movto_trans_financ_w.nr_seq_concil, --69
                   dados_contab_w.cd_moeda --70
            from   movto_cartao_cr_parcela a,
                   movto_cartao_cr b,
                   movto_trans_financ c,
                    lote_baixa_cartao_cr d
            where  c.nr_sequencia = doc_p.nr_documento
            and    b.nr_sequencia = doc_p.nr_seq_doc_compl
            and    a.nr_sequencia = doc_p.nr_doc_analitico
            and    a.nr_seq_movto = b.nr_sequencia
            and    d.nr_sequencia = a.nr_seq_lote
            and    d.nr_sequencia = c.nr_seq_lote_cartao
            and    coalesce(b.nr_seq_caixa_rec::text, '') = '';
            end;

        elsif doc_p.nm_atributo = 'VL_LIQUIDO_CARTAO' then
            begin
            select 'S',
                   b.cd_pessoa_fisica, --13
                   b.cd_estabelecimento, --34
                   c.nr_sequencia nr_seq_movto_trans_fin, --59
                   c.cd_moeda --70
            into STRICT   ie_contabiliza_w,
                   dados_contab_w.cd_pessoa_fisica, --13
                   cd_conta_contabil_banco_w, --14
                   nr_seq_movto_trans_fin_w, --59
                   dados_contab_w.cd_moeda --70
            from   movto_cartao_cr_parcela a,
                   movto_cartao_cr b,
                   movto_trans_financ c
            where  c.nr_sequencia = doc_p.nr_documento
            and    b.nr_sequencia = doc_p.nr_seq_doc_compl
            and    a.nr_sequencia = doc_p.nr_doc_analitico
            and    a.nr_seq_movto = b.nr_sequencia
            and    c.nr_seq_movto_cartao = b.nr_sequencia
            and    coalesce(b.nr_seq_caixa_rec::text, '') = '';
            end;
        elsif doc_p.nm_atributo = 'VL_LIQUIDO_CARTAO_TR' then
            begin
            select 'S',
                   b.cd_pessoa_fisica, --13
                   b.cd_estabelecimento, --34
                   c.nr_sequencia nr_seq_movto_trans_fin, --59
                   c.cd_moeda --70
            into STRICT   ie_contabiliza_w,
                   dados_contab_w.cd_pessoa_fisica, --13
                   cd_conta_contabil_banco_w, --14
                   nr_seq_movto_trans_fin_w, --59
                   dados_contab_w.cd_moeda --70
            from   movto_cartao_cr_parcela a,
                   movto_cartao_cr b,
                   movto_trans_financ c
            where  c.nr_sequencia = doc_p.nr_documento
            and    b.nr_sequencia = doc_p.nr_seq_doc_compl
            and    a.nr_sequencia = doc_p.nr_doc_analitico
            and    a.nr_seq_movto = b.nr_sequencia
            and    c.nr_seq_movto_cartao = b.nr_sequencia
            and    coalesce(b.nr_seq_caixa_rec::text, '') = '';
            end;
        end if;
        end;

    elsif doc_p.nm_tabela = 'TITULO_PAGAR_IMPOSTO' and doc_p.nm_atributo = 'VL_PROV_TRIBUTO' and ie_contab_prov_tributo_w = 'S' then
        begin
        select 'S',
               r.cd_cgc, --6
               r.cd_pessoa_fisica, --13
               obter_pessoa_titulo_pagar(r.nr_titulo), --17
               b.nr_bordero, --19
               r.nr_titulo, --20
               coalesce(to_char(r.nr_documento), ''), --21
               r.nr_seq_nota_fiscal nr_seq_nota_fiscal, --27
               r.nr_titulo nr_seq_titulo_pagar, --28
               r.ds_compl_contab ds_compl_contab_cp, --33
               r.cd_estabelecimento, --34
               obter_pessoa_titulo_pagar(r.nr_titulo), --38
               r.nr_seq_proj_rec, --52
               b.nr_seq_movto_trans_fin nr_seq_movto_trans_fin, --59
               i.cd_tributo, --66
               b.cd_moeda --70
        into STRICT   ie_contabiliza_w,
               dados_contab_w.cd_cnpj, --6
               dados_contab_w.cd_pessoa_fisica, --13
               ds_hist_pf_pj_w, --17
               nr_bordero_w, --19
               nr_titulo_w, --20
               nr_doc_w, --21
               nr_seq_nota_fiscal_w, --27
               dados_contab_w.nr_titulo_pagar, --28
               ds_compl_contab_cp_w, --33
               dados_contab_w.cd_estab_movto, --34
               ds_pessoa_titulo_w, --38
               dados_contab_w.nr_seq_proj_rec, --52
               nr_seq_movto_trans_fin_w, --59
               dados_contab_w.cd_tributo, --66
               dados_contab_w.cd_moeda --70
        from   titulo_pagar_baixa b,
               titulo_pagar r,
               tributo t,
               titulo_pagar_imposto i
        where  i.nr_titulo = doc_p.nr_documento
        and    i.nr_seq_baixa = doc_p.nr_seq_doc_compl
        and    i.nr_sequencia = doc_p.nr_doc_analitico
        and    i.cd_tributo = t.cd_tributo
        and    r.nr_titulo = i.nr_titulo
        and    b.nr_titulo = r.nr_titulo
        and    i.nr_seq_baixa = b.nr_sequencia
        and    t.ie_contab_prov_cp = 'S';
        end;

    elsif doc_p.nm_tabela = 'TITULO_PAGAR_TRIB_BAIXA' and doc_p.nm_atributo = 'VL_TRIBUTO_PAGAR' then
        begin
        select 'S',
               b.nr_seq_conta_banco, --5
               a.cd_cgc, --6
               a.cd_pessoa_fisica, --13
               substr(obter_pessoa_titulo_pagar(a.nr_titulo), 1, 255), --17
               a.nr_titulo, --20
               to_char(a.nr_documento), --21
               a.nr_seq_nota_fiscal nr_seq_nota_fiscal, --27
               a.nr_titulo nr_seq_titulo_pagar, --28
               b.nr_seq_cheque_cp nr_seq_cheque_cp, --32
               a.ds_compl_contab ds_compl_contab_cp, --33
               a.cd_estabelecimento, --34
               substr(obter_pessoa_titulo_pagar(a.nr_titulo), 1, 80), --38
               CASE WHEN b.ie_origem_baixa='ET' THEN  'S'  ELSE null END  ie_estorno, --44
               b.nr_seq_movto_trans_fin nr_seq_movto_trans_fin, --59
               b.cd_tipo_baixa cd_tipo_baixa, --61
               c.cd_tributo, --66
               b.cd_moeda --70
        into STRICT   ie_contabiliza_w,
               dados_contab_w.nr_seq_conta_banco, --5
               dados_contab_w.cd_cnpj, --6
               dados_contab_w.cd_pessoa_fisica, --13
               ds_hist_pf_pj_w, --17
               nr_titulo_w, --20
               nr_doc_w, --21
               nr_seq_nota_fiscal_w, --27
               dados_contab_w.nr_titulo_pagar, --28
               movto_trans_financ_w.nr_seq_cheque_cp, --32
               ds_compl_contab_cp_w, --33
               dados_contab_w.cd_estab_movto, --34
               ds_pessoa_titulo_w, --38
               movto_trans_financ_w.ie_estorno, --44
               nr_seq_movto_trans_fin_w, --59
               dados_contab_w.cd_tipo_baixa, --61
               dados_contab_w.cd_tributo, --66
               dados_contab_w.cd_moeda --70
        from   titulo_pagar a,
               titulo_pagar_baixa b,
               titulo_pagar_imposto c,
               titulo_pagar_trib_baixa d
        where  a.nr_titulo = doc_p.nr_documento
        and    b.nr_sequencia = doc_p.nr_seq_doc_compl
        and    d.nr_sequencia = doc_p.nr_doc_analitico
        and    a.nr_titulo = b.nr_titulo /* titulo com a baixa */
        and    a.nr_titulo = c.nr_titulo /* titulo com o imposto*/
        and    a.nr_titulo = d.nr_titulo /* titulo com o rateio da baixa */
        and    b.nr_sequencia = d.nr_seq_tit_baixa /* baixa com o rateio do imposto da baixa */
        and    c.nr_sequencia = d.nr_seq_tit_trib; /* imposto com o rateio do imposto */
        end;

    elsif doc_p.nm_tabela = 'TITULO_RECEBER_TRIB' and doc_p.nm_atributo = 'VL_TRIBUTO_RECEBER' then
        begin
        select 'S',
               b.nr_seq_conta_banco, --5
               a.cd_cgc, --6
               a.cd_pessoa_fisica, --13
               substr(obter_nome_pf_pj(a.cd_pessoa_fisica, a.cd_cgc), 1, 255) ds_hist_pf_pj, --17
               obter_bordero_tit_rec(c.nr_titulo) nr_bordero, --19
               c.nr_titulo, --20
               to_char(a.nr_documento), --21
               a.nr_titulo nr_seq_titulo_receber, --29
               a.cd_estabelecimento, --34
               obter_pessoa_titulo_receber(a.nr_titulo), --38
               c.nr_sequencia nr_seq_movto_orig, --45
               b.nr_sequencia nr_seq_baixa_cr, --62
               c.cd_tributo, --66
               b.cd_moeda --70
        into STRICT   ie_contabiliza_w,
               dados_contab_w.nr_seq_conta_banco, --5
               dados_contab_w.cd_cnpj, --6
               dados_contab_w.cd_pessoa_fisica, --13
               ds_hist_pf_pj_w, --17
               nr_bordero_w, --19
               nr_titulo_w, --20
               nr_doc_w, --21
               dados_contab_w.nr_titulo_receber, --29
               dados_contab_w.cd_estab_movto, --34
               ds_pessoa_titulo_w, --38
               movto_trans_financ_w.nr_seq_movto_orig, --45
               nr_seq_baixa_cr_w, --62
               dados_contab_w.cd_tributo, --66
               dados_contab_w.cd_moeda --70
        from   titulo_receber a,
               titulo_receber_liq b,
               titulo_receber_trib c,
               titulo_receber_trib_baixa d
        where  a.nr_titulo = doc_p.nr_documento
        and    d.nr_sequencia = doc_p.nr_seq_doc_compl
        and    a.nr_titulo = b.nr_titulo
        and    a.nr_titulo = c.nr_titulo
        and    a.nr_titulo = d.nr_titulo
        and    d.nr_seq_tit_liq = b.nr_sequencia
        and    d.nr_seq_tit_trib = c.nr_sequencia;
        end;
    end if;

    if (ie_contabiliza_w = 'S') then

        dados_contab_w.nr_lote_contabil     := ctb_online_pck.get_lote_contabil(doc_p.cd_tipo_lote_contabil,
                                                                                doc_p.cd_estabelecimento,
                                                                                doc_p.dt_competencia,
                                                                                nm_usuario_p);
        dados_contab_w.doc.nr_lote_contabil := dados_contab_w.nr_lote_contabil;

        if (coalesce(dados_contab_w.cd_tributo, 0) <> 0) then
            begin
            select ds_tributo
            into STRICT   ds_tributo_w
            from   tributo
            where  cd_tributo = dados_contab_w.cd_tributo;
            exception
                when others then
                ds_tributo_w := '';
            end;
        end if;

        if (doc_p.vl_movimento < 0) then
            ie_estorno_ww := wheb_mensagem_pck.get_texto(799481);
        end if;

        if (coalesce(dados_contab_w.nr_seq_produto, 0) = 0) and (coalesce(movto_trans_financ_w.nr_seq_movto_cartao, 0) <> 0) then
            dados_contab_w.nr_seq_produto := (substr(obter_prod_financ(movto_trans_financ_w.nr_seq_movto_cartao, 'AC', 'P'), 1, 10))::numeric;
        elsif (coalesce(dados_contab_w.nr_seq_produto, 0) = 0) and (doc_p.nm_atributo = 'VL_TRANSACAO') then
            dados_contab_w.nr_seq_produto := (substr(obter_prod_financ(nr_seq_movto_trans_fin_w, 'MV', 'P'), 1, 10))::numeric;
        elsif (coalesce(dados_contab_w.nr_seq_produto, 0) = 0) and (coalesce(dados_contab_w.nr_titulo_receber, 0) <> 0) then
            dados_contab_w.nr_seq_produto := (substr(obter_prod_financ(dados_contab_w.nr_titulo_receber, 'TR', 'P'), 1, 10))::numeric;
        elsif (coalesce(dados_contab_w.nr_seq_produto, 0) = 0) and (coalesce(dados_contab_w.nr_titulo_pagar, 0) <> 0) then
            dados_contab_w.nr_seq_produto := (substr(obter_prod_financ(dados_contab_w.nr_titulo_pagar, 'TP', 'P'), 1, 10))::numeric;
        elsif (coalesce(dados_contab_w.nr_seq_produto, 0) = 0) and (coalesce(nr_seq_nota_fiscal_w, 0) <> 0) then
            dados_contab_w.nr_seq_produto := (substr(obter_prod_financ(nr_seq_nota_fiscal_w, 'NF', 'P'), 1, 10))::numeric;
        end if;

        /* Francisco - OS 55132 - 23/04/07 - gravar parcela */

        if (coalesce(dados_contab_w.nr_titulo_pagar, 0) <> 0) then
            begin
            select nr_parcelas,
                   nr_seq_trans_fin_baixa,
                   ds_observacao_titulo,
                   cd_tributo,
                   nr_seq_rpa
            into STRICT   nr_parcela_w,
                   nr_seq_trans_fin_baixa_w,
                   ds_obs_titulo_pagar_w,
                   dados_contab_w.cd_tributo,
                   nr_seq_rpa_w
            from   titulo_pagar
            where  nr_titulo = dados_contab_w.nr_titulo_pagar;
            exception
                when others then
                    nr_parcela_w              := 0;
                    nr_seq_trans_fin_baixa_w  := null;
                    ds_obs_titulo_pagar_w     := null;
                    dados_contab_w.cd_tributo := null;
                    nr_seq_rpa_w              := null;
            end;

            ds_notas_titulo_unificado_w := substr(fin_obter_notas_tit_pag_unif(dados_contab_w.nr_titulo_pagar, 2), 1, 255);

            begin
            select nr_seq_darf
            into STRICT   nr_seq_darf_w
            from   darf_titulo_pagar
            where  nr_titulo = dados_contab_w.nr_titulo_pagar;
        exception
                when others then
                    nr_seq_darf_w := null;
            end;
            cd_processo_dcomp_w := substr(fis_obter_dcomp_darf(nr_seq_darf_w), 1, 255);
        end if;

        if (ie_contab_trans_fin_baixa_w = 'S') then
            dados_contab_w.nr_seq_trans_fin := coalesce(nr_seq_trans_fin_baixa_w, dados_contab_w.nr_seq_trans_fin);
        end if;

        if coalesce(dados_contab_w.nr_titulo_receber, 0) > 0 then
            begin
            if (coalesce(nr_seq_baixa_cr_w, 0) <> 0) then
                begin
                select nr_seq_trans_fin
                into STRICT   nr_seq_trans_fin_baixa_w
                from   titulo_receber_liq
                where  nr_titulo = dados_contab_w.nr_titulo_receber
                and    nr_sequencia = nr_seq_baixa_cr_w;
                end;
            else
                begin
                select nr_seq_trans_fin
                into STRICT   nr_seq_trans_fin_baixa_w
                from   titulo_receber_liq
                where  nr_titulo = dados_contab_w.nr_titulo_receber
                and    nr_seq_movto_trans_fin = nr_seq_movto_trans_fin_w;
                end;
            end if;
            exception
            when others then
                nr_seq_trans_fin_baixa_w := null;

                if (ie_contab_trans_fin_baix_rec_w = 'S') then
                    dados_contab_w.nr_seq_trans_fin := coalesce(nr_seq_trans_fin_baixa_w, dados_contab_w.nr_seq_trans_fin);
                end if;

            end;
        end if;

        /* Obter se contabiliza na conta do banco */

        begin
        select coalesce(ie_contab_banco, 'S'),
               coalesce(ie_contab_cb, 'N')
        into STRICT   ie_contab_banco_w,
               ie_contab_cb_w
        from   transacao_financeira
        where  nr_sequencia = dados_contab_w.nr_seq_trans_fin;
        exception
            when others then
                ie_contab_banco_w := 'S';
        end;

        /* Define beneficiario no caso de titulo a pagar */

        if (ie_benef_orig_trib_contab_w = 'S') and (nr_titulo_w > 0) then
            ds_benef_origem_w := substr(Obter_Benef_Orig_Trib(nr_titulo_w), 1, 255);
        end if;

        if (ctb_param_lote_cont_banco_w.ie_contab_vl_estorno = 'E') and (movto_trans_financ_w.nr_seq_movto_orig <> 0) then
            movto_trans_financ_w.nr_sequencia := movto_trans_financ_w.nr_seq_movto_orig;
            nr_seq_movto_trans_fin_w          := movto_trans_financ_w.nr_sequencia;
        end if;

        /* Define agrupamento, documento e historico */

        if (nm_agrupador_w = 'NR_SEQ_MOVTO_TRANS_FIN') then
            dados_contab_w.nr_seq_agrupamento := nr_seq_movto_trans_fin_w;

        elsif (nm_agrupador_w = 'NR_SEQ_MOVTO_TRANSF_BCO') then
            dados_contab_w.nr_seq_agrupamento := movto_trans_financ_w.nr_seq_movto_transf_bco;

        elsif (nm_agrupador_w = 'NR_BORDERO') then
            begin
            dados_contab_w.nr_seq_agrupamento := nr_bordero_w;

            if (coalesce(nr_bordero_w, 0) = 0) and (coalesce(movto_trans_financ_w.nr_bordero_rec, 0) != 0) then
                dados_contab_w.nr_seq_agrupamento := movto_trans_financ_w.nr_bordero_rec;
            end if;
            end;

        elsif (nm_agrupador_w = 'NR_SEQ_CHEQUE') then
            dados_contab_w.nr_seq_agrupamento := movto_trans_financ_w.nr_seq_cheque;

        elsif (nm_agrupador_w = 'NR_SEQ_CONTA_BANCO') then
            begin
                dados_contab_w.nr_seq_agrupamento := dados_contab_w.nr_seq_conta_banco;

                if (coalesce(philips_param_pck.get_cd_pais, 0) = 2) and (doc_p.nm_atributo = 'VL_TRIBUTO_RECEBER') then
                    begin
                    select max(d.nr_conta)
                    into STRICT   dados_contab_w.nr_seq_agrupamento
                    from   titulo_receber_liq t,
                           deposito d,
                           deposito_cheque dc,
                           cheque_cr c,
                           caixa_receb cr
                    where  d.nr_sequencia = dc.nr_seq_deposito
                    and    c.nr_seq_cheque = dc.nr_seq_cheque
                    and    c.nr_seq_caixa_rec = cr.nr_sequencia
                    and    t.nr_titulo = dados_contab_w.nr_titulo_receber
                    and    t.nr_seq_caixa_rec = cr.nr_sequencia;
                    end;
                end if;
            end;
        end if;

        if (coalesce(dados_contab_w.nr_seq_agrupamento, 0) = 0) then
            dados_contab_w.nr_seq_agrupamento := nr_seq_movto_trans_fin_w;
        end if;

        if coalesce(nr_bordero_w, 0) <> 0 then
            -- Edgar 26/07/2006 OS 37008, incluir o nr_cheque
            begin
            select nr_cheque,
                   ds_bordero
            into STRICT   nr_cheque_w,
                   ds_bordero_w
            from   bordero_pagamento
            where  nr_bordero = nr_bordero_w;
            exception
                when others then
                    nr_cheque_w  := null;
                    ds_bordero_w := '';
            end;
        end if;

        if (coalesce(dados_contab_w.nr_titulo_receber, 0) <> 0) then
            select  a.ds_observacao_titulo
            into STRICT    ds_obs_titulo_rec_w
            from    titulo_receber a
            where   a.nr_titulo     = dados_contab_w.nr_titulo_receber;
        end if;

        if (coalesce(nr_seq_banco_escrit_w, 0) <> 0) then
            begin
            select a.ds_banco
            into STRICT   ds_banco_escrit_w
            from   banco a,
                   banco_escritural b
            where  a.cd_banco = b.cd_banco
            and    b.nr_sequencia = nr_seq_banco_escrit_w;
            exception
                when others then
                    ds_banco_escrit_w := '';
            end;
        end if;

        if (coalesce(movto_trans_financ_w.nr_seq_cheque, 0) > 0) then
            select b.cd_banco,
                   b.ds_banco,
                   a.cd_agencia_bancaria,
                   a.nr_conta,
                   a.nr_adiantamento,
                   a.nm_pessoa_fisica,
                   a.ds_razao_social,
                   a.nr_cheque,
                   b.cd_banco_externo,
                   substr(obter_dados_cheque_cr(a.nr_seq_cheque, 'NP'), 1, 255)
            into STRICT   cd_banco_cheque_w,
                   ds_banco_cheque_w,
                   cd_agencia_cheque_w,
                   nr_conta_cheque_w,
                   nr_adiant_cheque_w,
                   nm_pf_cheque_w,
                   ds_razao_social_cheque_w,
                   nr_cheque_cr_w,
                   cd_banco_ext_cheque_w,
                   nm_paciente_cheque_w
            from   banco b,
                   cheque_cr_v a
            where  a.nr_seq_cheque = movto_trans_financ_w.nr_seq_cheque
            and    a.cd_banco = b.cd_banco;
        end if;

        if (coalesce(movto_trans_financ_w.nr_seq_movto_cartao, 0) > 0) then
            ds_movto_cartao_w     := substr(obter_dados_cartao_cr(movto_trans_financ_w.nr_seq_movto_cartao, 'DM'), 1, 255);
            ds_bandeira_cartao_w  := substr(obter_dados_cartao_cr(movto_trans_financ_w.nr_seq_movto_cartao, 'B'), 1, 255);
            nm_pessoa_caixa_rec_w := substr(obter_dados_cartao_cr(movto_trans_financ_w.nr_seq_movto_cartao, 'PR'), 1, 255);

            begin
            select ds_observacao
            into STRICT   ds_obs_movto_cartao_baixa_w
            from   movto_cartao_cr_baixa
            where  nr_seq_movto = movto_trans_financ_w.nr_seq_movto_cartao;
            exception
                when others then
                    ds_obs_movto_cartao_baixa_w := '';
            end;

            begin
            select nr_seq_bandeira,
                   substr(obter_nome_pf_pj(cd_pessoa_fisica, cd_cgc), 1, 255),
                   ds_comprovante,
                   nr_seq_caixa_rec,
                   cd_estabelecimento
            into STRICT   dados_contab_w.nr_seq_bandeira,
                   ds_pessoa_rec_cartao_w,
                   ds_comprovante_w,
                   nr_seq_caixa_rec_w,
                   dados_contab_w.cd_estab_inf_movto
            from   movto_cartao_cr
            where  nr_sequencia = movto_trans_financ_w.nr_seq_movto_cartao;
            exception
                when others then
                    dados_contab_w.nr_seq_bandeira    := null;
                    ds_pessoa_rec_cartao_w            := null;
                    ds_comprovante_w                  := null;
                    nr_seq_caixa_rec_w                := null;
                    dados_contab_w.cd_estab_inf_movto := null;
            end;

            if (nr_seq_caixa_rec_w IS NOT NULL AND nr_seq_caixa_rec_w::text <> '') then
                ds_nota_fiscal_cartao_w := substr(obter_nf_caixa_rec(nr_seq_caixa_rec_w), 1, 150);
                ds_nfe_cartao_w         := substr(obter_nfes(nr_seq_caixa_rec_w), 1, 150);
            end if;

            if (movto_trans_financ_w.nr_seq_parc_cartao IS NOT NULL AND movto_trans_financ_w.nr_seq_parc_cartao::text <> '') then

                nr_parcela_cartao_w := somente_numero(substr(obter_numero_parcela_cartao(movto_trans_financ_w.nr_seq_movto_cartao,
                                                                                         movto_trans_financ_w.nr_seq_parc_cartao),
                                                             1,
                                                             10));
                select count(nr_sequencia)
                into STRICT   qt_parcelas_w
                from   movto_cartao_cr_parcela
                where  nr_seq_movto = movto_trans_financ_w.nr_seq_movto_cartao;

                if (qt_parcelas_w > 0) then
                    nr_parc_cartao_total_w := substr(nr_parcela_cartao_w || '/' || qt_parcelas_w, 1, 40);
                end if;
            end if;
        end if;

        if (coalesce(movto_trans_financ_w.nr_seq_lote_cartao, 0) <> 0 and coalesce(dados_contab_w.nr_seq_bandeira::text, '') = '') then
            begin
                select nr_seq_bandeira,
                       nr_sequencia,
                       substr(obter_desc_bandeira_cartao(nr_seq_bandeira), 1, 255)
                into STRICT   dados_contab_w.nr_seq_bandeira,
                       nr_seq_baixa_cart_w,
                       ds_bandeira_cartao_ww
                from   lote_baixa_cartao_cr
                where  nr_sequencia = movto_trans_financ_w.nr_seq_lote_cartao;
            exception
                when others then
                    dados_contab_w.nr_seq_bandeira := null;
                    nr_seq_baixa_cart_w            := null;
                    ds_bandeira_cartao_ww          := null;
            end;
        end if;

        if (coalesce(movto_trans_financ_w.nr_seq_cheque_cp, 0) > 0) then
            begin
            select nr_cheque
            into STRICT   nr_cheque_pago_w
            from   cheque
            where  nr_sequencia = movto_trans_financ_w.nr_seq_cheque_cp;
            exception
                when others then
                    nr_cheque_pago_w := null;
            end;

            ds_cheque_cp_w := substr(obter_dados_cheque_cp(movto_trans_financ_w.nr_seq_cheque_cp, 'DS'), 1, 180);
        end if;

        if (coalesce(nr_cheque_pago_w, 'X') = 'X') then
            null;
            nr_cheque_pago_w := fin_obter_cheque_bordero_titpa(nr_bordero_w, dados_contab_w.nr_titulo_pagar);
        end if;

        nr_cheque_tit_pagar_w := substr(obter_cheque_tit_pagar(dados_contab_w.nr_titulo_pagar), 1, 100);

        nr_cheque_adiant_pago_w := fin_obter_cheque_adiant_pago(movto_trans_financ_w.nr_adiant_pago);

        if (coalesce(movto_trans_financ_w.nr_seq_caixa_od, 0) > 0) then
            begin
            select ds_caixa
            into STRICT   ds_caixa_od_w
            from   caixa
            where  nr_sequencia = movto_trans_financ_w.nr_seq_caixa_od;
            exception
                when others then
                    ds_caixa_od_w := null;
            end;
        end if;

        if (coalesce(dados_contab_w.nr_seq_banco_od, 0) > 0) then
            begin
            select ds_banco,
                   cd_conta,
                   ds_interno,
                   cd_estabelecimento
            into STRICT   ds_banco_od_w,
                   nr_conta_od_w,
                   ds_interno_w,
                   cd_estab_banco_od_w
            from   banco_estabelecimento_v
            where  nr_sequencia = dados_contab_w.nr_seq_banco_od;
            /* OS 1969492 - Inclusao de Regra da Holding de Intercompany */

            ie_intercompany_w   := holding_pck.get_se_intercompany(doc_p.cd_estabelecimento, cd_estab_banco_od_w);
            if (ie_intercompany_w = 'S') then
               cd_estab_intercompany_w := cd_estab_banco_od_w;
            end if;
            exception
                when others then
                    ds_banco_od_w       := null;
                    nr_conta_od_w       := null;
                    ds_interno_w        := null;
                    cd_estab_banco_od_w := null;
            end;
        end if;

        if (coalesce(nr_seq_nota_fiscal_w, 0) > 0) then
            begin
            select a.nr_nota_fiscal,
                   substr('NF' || CASE WHEN coalesce(b.ie_servico, 'N')='S' THEN  'S' END  || CASE WHEN coalesce(a.ie_nf_eletronica, 'N')='S' THEN  'E' END , 1, 15),
                   a.nr_nfe_imp,
				   a.cd_serie_nf
            into STRICT   nr_nota_fiscal_w,
                   ie_nf_nfe_w,
                   nr_nfe_imp_w,
				   cd_serie_nf_w
            from   nota_fiscal a,
                   operacao_nota b
            where  a.cd_operacao_nf = b.cd_operacao_nf
            and    a.nr_sequencia = nr_seq_nota_fiscal_w;
            exception
                when others then
                    nr_nota_fiscal_w := '';
                    ie_nf_nfe_w      := '';
                    nr_nfe_imp_w     := '';
					cd_serie_nf_w    := null;
            end;
        end if;

        if (coalesce(nr_seq_nota_fiscal_w, 0) = 0) and (coalesce(nr_nota_fiscal_w, '0') = '0') then
            begin
            if (coalesce(nr_nota_fiscal_w, '0') = '0') and (coalesce(dados_contab_w.nr_titulo_receber, 0) <> 0) then
                nr_nota_fiscal_w := somente_numero(substr(coalesce(obter_dados_titulo_receber(dados_contab_w.nr_titulo_receber, 'NFT'), '0'), 1, 20));
                nr_nfe_imp_w     := substr(coalesce(obter_dados_titulo_receber(dados_contab_w.nr_titulo_receber, 'NE'), '0'), 1, 20);
				cd_serie_nf_w    := substr(coalesce(obter_dados_titulo_receber(dados_contab_w.nr_titulo_receber, 'CDS'), '0'), 1, 20);
            end if;
            if (coalesce(nr_nota_fiscal_w, '0') = '0') and (coalesce(dados_contab_w.nr_titulo_pagar, 0) <> 0) then
                nr_nota_fiscal_w := somente_numero(substr(coalesce(obter_dados_tit_pagar(dados_contab_w.nr_titulo_pagar, 'NF'), '0'), 1, 20));
                nr_nota_fiscal_w := substr(coalesce(obter_dados_tit_pagar(dados_contab_w.nr_titulo_pagar, 'NFE'), '0'), 1, 20);
            end if;
            end;
        end if;
        if (coalesce(nr_nota_fiscal_w, 0) = 0) and (doc_p.nm_atributo in ('VL_TRANSACAO', 'VL_CHEQUE_DEPOSITO')) then
            begin
            if (coalesce(movto_trans_financ_w.nr_seq_cheque, 0) <> 0) then
                begin
                select  nr_titulo
                into STRICT    nr_seq_titulo_cheque_w
                from    cheque_cr
                where   nr_seq_cheque = movto_trans_financ_w.nr_seq_cheque;
            exception
                    when others then
                        nr_seq_titulo_cheque_w := null;
                end;
            end if;
            if (coalesce(movto_trans_financ_w.nr_seq_deposito, 0) <> 0) and
               ((coalesce(movto_trans_financ_w.nr_seq_cheque, 0) = 0) or (coalesce(nr_seq_titulo_cheque_w, 0) = 0)) then
                begin
                    select a.nr_titulo
                    into STRICT   nr_seq_titulo_cheque_w
                    from   cheque_cr a,
                           deposito_cheque b
                    where  a.nr_seq_cheque = b.nr_seq_cheque
                    and    b.nr_seq_deposito = movto_trans_financ_w.nr_seq_deposito;
                exception
                    when others then
                        nr_seq_titulo_cheque_w := null;
                end;
            end if;
            if (coalesce(nr_seq_titulo_cheque_w, 0) <> 0) then
                nr_nota_fiscal_w := somente_numero(substr(obter_dados_titulo_receber(nr_seq_titulo_cheque_w, 'NFT'), 1, 100));
                nr_nfe_imp_w     := substr(coalesce(obter_dados_titulo_receber(nr_seq_titulo_cheque_w, 'NE'), '0'), 1, 20);
				cd_serie_nf_w    := substr(coalesce(obter_dados_titulo_receber(nr_seq_titulo_cheque_w, 'CDS'), '0'), 1, 20);
            end if;
            end;
        end if;

        if (coalesce(dados_contab_w.nr_titulo_receber::text, '') = '') and (movto_trans_financ_w.nr_seq_perda IS NOT NULL AND movto_trans_financ_w.nr_seq_perda::text <> '') then

            begin
            select nr_titulo
            into STRICT   dados_contab_w.nr_titulo_receber
            from   perda_contas_receber
            where  nr_sequencia = movto_trans_financ_w.nr_seq_perda;
            exception
                when others then
                    dados_contab_w.nr_titulo_receber := null;
            end;
        end if;

        if (coalesce(nr_seq_cheque_dep_w, 0) <> 0) then
            nr_cheque_deposito_w := substr(obter_dados_cheque_cr(nr_seq_cheque_dep_w, 'N'), 1, 255);
        end if;

        if (coalesce(movto_trans_financ_w.nr_adiant_pago, 0) <> 0) then
            begin
            select  substr(obter_nome_pf_pj(cd_pessoa_fisica,cd_cgc),1,255),
                    substr(ds_observacao,1,200)
            into STRICT    nm_pessoa_adiant_pago_w,
                    ds_obs_adiant_pago_w
            from   adiantamento_pago
            where  nr_adiantamento = movto_trans_financ_w.nr_adiant_pago;
            exception
                when others then
                    nm_pessoa_adiant_pago_w := '';
                    ds_obs_adiant_pago_w    := '';
            end;
        end if;

        if (coalesce(movto_trans_financ_w.nr_adiantamento, 0) <> 0) then
            begin
            select substr(obter_nome_pf_pj(cd_pessoa_fisica, cd_cgc), 1, 200),
                   substr(obter_paciente_adiantamento(movto_trans_financ_w.nr_adiantamento, 'N'), 1, 60)
            into STRICT   nm_pessoa_adiantamento_w,
                   nm_paciente_adiantamento_w
            from   adiantamento
            where  nr_adiantamento = movto_trans_financ_w.nr_adiantamento;
            exception
                when others then
                    nm_pessoa_adiantamento_w   := '';
                    nm_paciente_adiantamento_w := '';
            end;
        end if;

        if (coalesce(dados_contab_w.nr_seq_proj_rec, 0) <> 0) then
            begin
            select  ds_projeto
            into STRICT    ds_proj_rec_w
            from    projeto_recurso
            where   nr_sequencia    = dados_contab_w.nr_seq_proj_rec;
            exception
                when others then
                    ds_proj_rec_w := '';
            end;
        end if;

        if (coalesce(nr_titulo_w, 0) <> 0) then
            begin
            select  nr_titulo_original
            into STRICT    nr_titulo_original_w
            from    titulo_pagar
            where   nr_titulo   = nr_titulo_w;
            exception
                when others then
                    nr_titulo_original_w := null;
            end;

            if (coalesce(nr_titulo_original_w, 0) <> 0) then
                begin
                select substr(obter_dados_pf_pj(a.cd_pessoa_fisica, a.cd_cgc, 'N'), 1, 80)
                into STRICT   nm_pf_pj_tit_original_w
                from   titulo_pagar a
                where  nr_titulo = nr_titulo_original_w;
                exception
                    when others then
                        nm_pf_pj_tit_original_w := '';
                end;
            end if;
        end if;

        if (nr_nota_fiscal_w = '0') then
            nr_nota_fiscal_w := null;
        end if;

        CALL ctb_online_pck.definir_atrib_compl(doc_p.cd_tipo_lote_contabil);
        CALL ctb_online_pck.set_value_compl_hist('CD_CGC', dados_contab_w.cd_cnpj);
        CALL ctb_online_pck.set_value_compl_hist('CD_HISTORICO', movto_trans_financ_w.cd_historico);
        CALL ctb_online_pck.set_value_compl_hist('NR_BORDERO', nr_bordero_w);
        CALL ctb_online_pck.set_value_compl_hist('DS_BENEF_ORIGEM', ds_benef_origem_w);
        CALL ctb_online_pck.set_value_compl_hist('DS_HIST_PF_PJ', ds_hist_pf_pj_w);
        CALL ctb_online_pck.set_value_compl_hist('NR_DOCUMENTO', nr_doc_w);
        CALL ctb_online_pck.set_value_compl_hist('DS_HISTORICO', movto_trans_financ_w.ds_historico);
        CALL ctb_online_pck.set_value_compl_hist('DS_BANCO_CONTA', ds_banco_conta_w);
        CALL ctb_online_pck.set_value_compl_hist('NR_CHEQUE', nr_cheque_w);
        CALL ctb_online_pck.set_value_compl_hist('NR_SEQUENCIA', movto_trans_financ_w.nr_sequencia);
        CALL ctb_online_pck.set_value_compl_hist('NR_ADIANTAMENTO', movto_trans_financ_w.nr_adiantamento);
        CALL ctb_online_pck.set_value_compl_hist('NR_ADIANT_PAGO', movto_trans_financ_w.nr_adiant_pago);
        CALL ctb_online_pck.set_value_compl_hist('NR_BORDERO_REC', movto_trans_financ_w.nr_bordero_rec);
        CALL ctb_online_pck.set_value_compl_hist('NR_INTERNO_CONTA', movto_trans_financ_w.nr_interno_conta);
        CALL ctb_online_pck.set_value_compl_hist('NR_SEQ_NOTA_FISCAL', nr_seq_nota_fiscal_w);
        CALL ctb_online_pck.set_value_compl_hist('NR_SEQ_TITULO_PAGAR', dados_contab_w.nr_titulo_pagar);
        CALL ctb_online_pck.set_value_compl_hist('NR_SEQ_TITULO_RECEBER', dados_contab_w.nr_titulo_receber);
        CALL ctb_online_pck.set_value_compl_hist('CD_BANCO_CHEQUE', cd_banco_cheque_w);
        CALL ctb_online_pck.set_value_compl_hist('DS_BANCO_CHEQUE', ds_banco_cheque_w);
        CALL ctb_online_pck.set_value_compl_hist('CD_AGENCIA_CHEQUE', cd_agencia_cheque_w);
        CALL ctb_online_pck.set_value_compl_hist('NR_CONTA_CHEQUE', nr_conta_cheque_w);
        CALL ctb_online_pck.set_value_compl_hist('NR_ADIANT_CHEQUE', nr_adiant_cheque_w);
        CALL ctb_online_pck.set_value_compl_hist('NM_PF_CHEQUE', nm_pf_cheque_w);
        CALL ctb_online_pck.set_value_compl_hist('DS_RAZAO_SOCIAL_CHEQUE', ds_razao_social_cheque_w);
        CALL ctb_online_pck.set_value_compl_hist('DS_BANCO', ds_banco_w);
        CALL ctb_online_pck.set_value_compl_hist('NR_CHEQUE_PAGO', nr_cheque_pago_w);
        CALL ctb_online_pck.set_value_compl_hist('NR_PARCELA', nr_parcela_w);
        CALL ctb_online_pck.set_value_compl_hist('DS_COMPL_CONTAB_CP', ds_compl_contab_cp_w);
        CALL ctb_online_pck.set_value_compl_hist('NR_CHEQUE_ADIANT_PAGO', nr_cheque_adiant_pago_w);
        CALL ctb_online_pck.set_value_compl_hist('DS_CAIXA_ORIGEM_DESTINO', ds_caixa_od_w);
        CALL ctb_online_pck.set_value_compl_hist('DS_MOVTO_CARTAO', ds_movto_cartao_w);
        CALL ctb_online_pck.set_value_compl_hist('NR_CHEQUE_CR', nr_cheque_cr_w);
        CALL ctb_online_pck.set_value_compl_hist('DS_BANCO_OD', ds_banco_od_w);
        CALL ctb_online_pck.set_value_compl_hist('NR_CONTA_OD', nr_conta_od_w);
        CALL ctb_online_pck.set_value_compl_hist('DS_PESSOA_TITULO', ds_pessoa_titulo_w);
        CALL ctb_online_pck.set_value_compl_hist('NR_NOTA_FISCAL', nr_nota_fiscal_w);
        CALL ctb_online_pck.set_value_compl_hist('NR_CHEQUE_TIT_PAGAR', nr_cheque_tit_pagar_w);
        CALL ctb_online_pck.set_value_compl_hist('CD_BANCO_EXT_CHEQUE', cd_banco_ext_cheque_w);
        CALL ctb_online_pck.set_value_compl_hist('DS_INTERNO', ds_interno_w);
        CALL ctb_online_pck.set_value_compl_hist('NR_CHEQUE_DEPOSITO', nr_cheque_deposito_w);
        CALL ctb_online_pck.set_value_compl_hist('NM_PESSOA_ADIANT_PAGO', nm_pessoa_adiant_pago_w);
        CALL ctb_online_pck.set_value_compl_hist(' ', nr_seq_banco_escrit_w);
        CALL ctb_online_pck.set_value_compl_hist('DS_BANCO_ESCRIT', ds_banco_escrit_w);
        CALL ctb_online_pck.set_value_compl_hist('DS_OBS_MOVTO_CARTAO_BAIXA', ds_obs_movto_cartao_baixa_w);
        CALL ctb_online_pck.set_value_compl_hist('DS_OBS_TITULO_REC', ds_obs_titulo_rec_w);
        CALL ctb_online_pck.set_value_compl_hist('DS_BANDEIRA_CARTAO', ds_bandeira_cartao_w);
        CALL ctb_online_pck.set_value_compl_hist('DS_OBS_ADIANT_PAGO', ds_obs_adiant_pago_w);
        CALL ctb_online_pck.set_value_compl_hist('DS_OBS_TITULO_PAGAR', ds_obs_titulo_pagar_w);
        CALL ctb_online_pck.set_value_compl_hist('NM_PESSOA_CAIXA_REC', nm_pessoa_caixa_rec_w);
        CALL ctb_online_pck.set_value_compl_hist('DS_PESSOA_REC_CARTAO', ds_pessoa_rec_cartao_w);
        CALL ctb_online_pck.set_value_compl_hist('DS_COMPROVANTE', ds_comprovante_w);
        CALL ctb_online_pck.set_value_compl_hist('NM_ESTABELECIMENTO', nm_estabelecimento_w);
        CALL ctb_online_pck.set_value_compl_hist('NR_SEQ_PROJ_REC', dados_contab_w.nr_seq_proj_rec);
        CALL ctb_online_pck.set_value_compl_hist('DS_PROJ_REC', ds_proj_rec_w);
        CALL ctb_online_pck.set_value_compl_hist('NM_PESSOA_ADIANTAMENTO', nm_pessoa_adiantamento_w);
        CALL ctb_online_pck.set_value_compl_hist('DS_CHEQUE_CP', ds_cheque_cp_w);
        CALL ctb_online_pck.set_value_compl_hist('NR_SEQ_MOVTO_BCO_PEND', nr_seq_movto_bco_pend_w);
        CALL ctb_online_pck.set_value_compl_hist('DS_NOTAS_TITULO_UNIFICADO', ds_notas_titulo_unificado_w);
        CALL ctb_online_pck.set_value_compl_hist('DS_NOTA_FISCAL_CARTAO', ds_nota_fiscal_cartao_w);
        CALL ctb_online_pck.set_value_compl_hist('NR_PARCELA_CARTAO', nr_parcela_cartao_w);
        CALL ctb_online_pck.set_value_compl_hist('NR_SEQ_CNI', nr_seq_cni_w);
        CALL ctb_online_pck.set_value_compl_hist('DS_BORDERO', ds_bordero_w);
        CALL ctb_online_pck.set_value_compl_hist('NM_PACIENTE_ADIANTAMENTO', nm_paciente_adiantamento_w);
        CALL ctb_online_pck.set_value_compl_hist('NR_SEQ_DEPOSITO', movto_trans_financ_w.nr_seq_deposito);
        CALL ctb_online_pck.set_value_compl_hist('NR_SEQ_BAIXA_CART', nr_seq_baixa_cart_w);
        CALL ctb_online_pck.set_value_compl_hist('DS_BANDEIRA_CARTAO', ds_bandeira_cartao_ww);
        CALL ctb_online_pck.set_value_compl_hist('NM_PF_PJ_TIT_PAGAR_ORIG', nm_pf_pj_tit_original_w);
        CALL ctb_online_pck.set_value_compl_hist('NR_SEQ_COBR_ESCRIT', movto_trans_financ_w.nr_seq_cobr_escrit);
        CALL ctb_online_pck.set_value_compl_hist('IE_NF_NFE', ie_nf_nfe_w);
        CALL ctb_online_pck.set_value_compl_hist('IE_ESTORNO', ie_estorno_ww);
        CALL ctb_online_pck.set_value_compl_hist('NR_SEQ_CONCIL', movto_trans_financ_w.nr_seq_concil);
        CALL ctb_online_pck.set_value_compl_hist('NM_PACIENTE_CHEQUE', nm_paciente_cheque_w);
        CALL ctb_online_pck.set_value_compl_hist('DS_TRIBUTO', ds_tributo_w);
        CALL ctb_online_pck.set_value_compl_hist('NR_PARC_CARTAO_TOTAL', nr_parc_cartao_total_w);
        CALL ctb_online_pck.set_value_compl_hist('CD_PROCESSO_DCOMP', cd_processo_dcomp_w);
        CALL ctb_online_pck.set_value_compl_hist('DS_NOTA_FISCAL_BORDERO', null);
        CALL ctb_online_pck.set_value_compl_hist('NR_NFE', nr_nfe_imp_w);
        CALL ctb_online_pck.set_value_compl_hist('DS_NFE_CARTAO', ds_nfe_cartao_w);
        CALL ctb_online_pck.set_value_compl_hist('NR_SEQ_RPA', nr_seq_rpa_w);
        CALL ctb_online_pck.set_value_compl_hist('NR_SEQ_CNI_ORIG', nr_seq_cni_orig_w);
		CALL ctb_online_pck.set_value_compl_hist('CD_SERIE_NF', cd_serie_nf_w);

        if holding_pck.get_se_intercompany_btw_estab(doc_p.cd_estabelecimento, cd_estab_banco_od_w) = 'S' then
			CALL ctb_online_pck.set_value_compl_hist(
				nm_atributo_p => 'CD_ESTAB_INTERCOMPANY_ORI', ds_valor_p => cd_estab_banco_od_w);
			CALL ctb_online_pck.set_value_compl_hist(
				nm_atributo_p => 'DS_ESTAB_INTERCOMPANY_ORI', ds_valor_p => substr(obter_nome_estabelecimento(cd_estab_banco_od_w),1,80));
			CALL ctb_online_pck.set_value_compl_hist(
				nm_atributo_p => 'CD_ESTAB_INTERCOMPANY_DES', ds_valor_p => doc_p.cd_estabelecimento);
			CALL ctb_online_pck.set_value_compl_hist(
				nm_atributo_p => 'DS_ESTAB_INTERCOMPANY_DES', ds_valor_p => nm_estabelecimento_w);

            begin
                select cd_interno
                into STRICT cd_interno_intercompany_ori_w
                from estabelecimento
                where cd_estabelecimento = cd_estab_banco_od_w
                and cd_empresa = obter_empresa_estab(cd_estab_banco_od_w);
            exception
                when no_data_found then
                    cd_interno_intercompany_ori_w := null;
                when too_many_rows then
                    cd_interno_intercompany_ori_w := null;
                when others then
                    cd_interno_intercompany_ori_w := null;
            end;

            begin
                select cd_interno
                into STRICT cd_interno_intercompany_des_w
                from estabelecimento
                where cd_estabelecimento = doc_p.cd_estabelecimento
                and cd_empresa = obter_empresa_estab(doc_p.cd_estabelecimento);
            exception
                when no_data_found then
                    cd_interno_intercompany_des_w := null;
                when too_many_rows then
                    cd_interno_intercompany_des_w := null;
                when others then
                    cd_interno_intercompany_des_w := null;
            end;
			
			CALL ctb_online_pck.set_value_compl_hist(
				nm_atributo_p => 'CD_INTERNO_INTERCOMPANY_ORI', ds_valor_p => cd_interno_intercompany_ori_w);
			CALL ctb_online_pck.set_value_compl_hist(
				nm_atributo_p => 'CD_INTERNO_INTERCOMPANY_DES', ds_valor_p => cd_interno_intercompany_des_w);
		else
			CALL ctb_online_pck.set_value_compl_hist(
				nm_atributo_p => 'CD_ESTAB_INTERCOMPANY_ORI', ds_valor_p => null);
			CALL ctb_online_pck.set_value_compl_hist(
				nm_atributo_p => 'DS_ESTAB_INTERCOMPANY_ORI', ds_valor_p => null);
			CALL ctb_online_pck.set_value_compl_hist(
				nm_atributo_p => 'CD_ESTAB_INTERCOMPANY_DES', ds_valor_p => null);
			CALL ctb_online_pck.set_value_compl_hist(
				nm_atributo_p => 'DS_ESTAB_INTERCOMPANY_DES', ds_valor_p => null);
			CALL ctb_online_pck.set_value_compl_hist(
				nm_atributo_p => 'CD_INTERNO_INTERCOMPANY_ORI', ds_valor_p => null);
			CALL ctb_online_pck.set_value_compl_hist(
				nm_atributo_p => 'CD_INTERNO_INTERCOMPANY_DES', ds_valor_p => null);
		end if;

        begin
        if (coalesce(nr_nota_fiscal_w, 0) <> 0) and (coalesce(nr_seq_nota_fiscal_w, 0) = 0) then
            begin
                select nr_sequencia
                into STRICT   nr_seq_nota_fiscal_w
                from   nota_fiscal
                where  nr_nota_fiscal = nr_nota_fiscal_w
                and    cd_estabelecimento = doc_p.cd_estabelecimento;
            exception
                when others then
                    nr_seq_nota_fiscal_w := null;
            end;

            if (coalesce(nr_seq_nota_fiscal_w, 0) <> 0) then
                begin
			begin
				select  nr_nfe_imp,
					cd_serie_nf
				into STRICT    nr_nfe_imp_w,
					cd_serie_nf_w
				from    nota_fiscal
				where   nr_sequencia = nr_seq_nota_fiscal_w;					
			exception when no_data_found or too_many_rows then
				nr_nfe_imp_w:= null;
				cd_serie_nf_w := null;
			end;
		end;
            end if;
        end if;

    exception
        when others then
            nr_seq_nota_fiscal_w := null;
    end;

    ds_atributos_w := 'NR_BORDERO_PAGAR=' || nr_bordero_w || ';' ||
                      'NR_BORDERO_RECEBER=' || movto_trans_financ_w.nr_bordero_rec || ';' ||
                      'NR_TITULO_RECEBER=' || dados_contab_w.nr_titulo_receber || ';' ||
                      'NR_TITULO_PAGAR=' || dados_contab_w.nr_titulo_pagar || ';' ||
                      'NR_NOTA_FISCAL=' || nr_nota_fiscal_w || ';' ||
                      'NR_SEQ_NOTA_FISCAL=' || nr_seq_nota_fiscal_w || ';' ||
                      'NR_SEQ_MOVTO_CONTROLE_BANCARIO=' || nr_seq_movto_trans_fin_w;

    ctb_obter_doc_movto(doc_p.cd_tipo_lote_contabil,
                        doc_p.nm_atributo,
                        'VR',
                        doc_p.dt_competencia,
                        null,
                        null,
                        ds_atributos_w,
                        nm_usuario_p,
                        ie_regra_w,
                        dados_contab_w.nr_doc_movto,
                        dados_contab_w.ie_origem_documento);

    if (coalesce(dados_contab_w.nr_doc_movto, 0) = 0) then
        begin
            dados_contab_w.nr_doc_movto        := nr_seq_movto_trans_fin_w;
            dados_contab_w.ie_origem_documento := '11';
        end;
    end if;

    if (ie_debito_credito_w <> 'T') and (ie_contab_banco_w = 'S') and (ie_contab_cb_w = 'S') then

        vl_cheque_w := 0;

        if coalesce(nr_bordero_w, 0) <> 0 then
            select coalesce(sum(vl_cheque), 0)
            into STRICT   vl_cheque_w
            from   cheque_v
            where  nr_sequencia in (SELECT nr_seq_cheque from cheque_bordero_titulo where nr_bordero = nr_bordero_w)
            and    coalesce(dt_cancelamento::text, '') = '';
        end if;

        /* Francisco - OS 84288 - 22/04/2008 - Inclui o "ABS" abaixo para o estorno contabilizar da mesma forma */

        if (abs(vl_cheque_w) = abs(doc_p.vl_movimento)) and coalesce(nr_bordero_w, 0) <> 0 then

            open C020;
            loop
                fetch C020
                    into nr_cheque_w,
                         vl_cheque_w;
                EXIT WHEN NOT FOUND; /* apply on c020 */
                begin
                    /* ---------------------------------------- */


                    /* - MONTAR COMPLEMENTO DE HISTORICO AQUI - */


                    /* ---------------------------------------- */

                    CALL ctb_online_pck.set_value_compl_hist('CD_BANCO_EXT_CHEQUE', null);
                    CALL ctb_online_pck.set_value_compl_hist('NR_SEQ_BAIXA_CART', null);
                    CALL ctb_online_pck.set_value_compl_hist('DS_BANDEIRA_CARTAO', null);

                    /* Francisco - OS 84288 - 22/04/2008 - Fiz esse tratamento pois senao o estorno
                    duplicava o valor lancado original, Ex: ao inves de lancar 1 debito e 1 credito, lancava 2 creditos */
                    if (doc_p.vl_movimento < 0) then
                        vl_cheque_w := vl_cheque_w * -1;
                    end if;
                    /* Fim alteracao Francisco - 22/04/2008*/

                    ctb_movimento_doc_w.nr_lote_contabil    := dados_contab_w.nr_lote_contabil;
                    ctb_movimento_doc_w.cd_estabelecimento  := doc_p.cd_estabelecimento;
                    ctb_movimento_doc_w.dt_movimento        := doc_p.dt_competencia;
                    ctb_movimento_doc_w.vl_movimento        := vl_cheque_w;
                    ctb_movimento_doc_w.cd_historico        := cd_historico_w;
                    ctb_movimento_doc_w.nr_seq_agrupamento  := dados_contab_w.nr_seq_agrupamento;
                    ctb_movimento_doc_w.ds_compl_historico  := ctb_online_pck.ctb_obter_compl_historico(doc_p.cd_tipo_lote_contabil,cd_historico_w);
                    ctb_movimento_doc_w.nr_documento        := dados_contab_w.nr_doc_movto;
                    ctb_movimento_doc_w.ie_origem_documento := dados_contab_w.ie_origem_documento;
                    ctb_movimento_doc_w.ie_transitorio      := 'N';
                    ctb_movimento_doc_w.cd_centro_custo     := null;
                    /* OS 1969492 - Inclusao regra da Holding Intercompany  */

                    ctb_movimento_doc_w.ie_intercompany            := ie_intercompany_w;
                    ctb_movimento_doc_w.cd_estab_intercompany      := cd_estab_intercompany_w;

                    if (ie_debito_credito_w = 'D') then
                        ctb_movimento_doc_w.cd_conta_debito  := cd_conta_contabil_banco_w;
                        ctb_movimento_doc_w.cd_conta_credito := null;
                    else
                        ctb_movimento_doc_w.cd_conta_debito  := null;
                        ctb_movimento_doc_w.cd_conta_credito := cd_conta_contabil_banco_w;
                    end if;

                    ctb_movimento_doc_w := ctb_online_pck.ctb_gravar_movto(ctb_movimento_doc_w, nm_usuario_p);
                end;
            end loop;
            close C020;

        elsif (doc_p.nm_atributo <> 'VL_CHEQUE_DEPOSITO') then

            ctb_movimento_doc_w.nr_lote_contabil     := dados_contab_w.nr_lote_contabil;
            ctb_movimento_doc_w.cd_estabelecimento   := doc_p.cd_estabelecimento;
            ctb_movimento_doc_w.dt_movimento         := doc_p.dt_competencia;
            ctb_movimento_doc_w.vl_movimento         := doc_p.vl_movimento;
            ctb_movimento_doc_w.cd_historico         := cd_historico_w;
            ctb_movimento_doc_w.nr_seq_agrupamento   := dados_contab_w.nr_seq_agrupamento;
            ctb_movimento_doc_w.ds_compl_historico   := ctb_online_pck.ctb_obter_compl_historico(doc_p.cd_tipo_lote_contabil, cd_historico_w);
            ctb_movimento_doc_w.nr_documento         := dados_contab_w.nr_doc_movto;
            ctb_movimento_doc_w.ie_origem_documento  := dados_contab_w.ie_origem_documento;
            ctb_movimento_doc_w.ie_transitorio       := 'N';
            ctb_movimento_doc_w.nr_seq_ctb_documento := doc_p.nr_sequencia;
            ctb_movimento_doc_w.nr_seq_tab_orig      := doc_p.nr_documento;
            ctb_movimento_doc_w.nr_seq_doc_compl     := doc_p.nr_seq_doc_compl;
            ctb_movimento_doc_w.nr_seq_info          := doc_p.nr_seq_info;
            ctb_movimento_doc_w.nm_tabela            := doc_p.nm_tabela;
            ctb_movimento_doc_w.nm_atributo          := doc_p.nm_atributo;
            ctb_movimento_doc_w.nr_seq_trans_fin     := doc_p.nr_seq_trans_financ;
            ctb_movimento_doc_w.cd_centro_custo      := null;
            /* OS 1969492 - Inclusao regra da Holding Intercompany  */

            ctb_movimento_doc_w.ie_intercompany           := ie_intercompany_w;
            ctb_movimento_doc_w.cd_estab_intercompany     := cd_estab_intercompany_w;

            if (ie_debito_credito_w = 'D') then
                ctb_movimento_doc_w.cd_conta_debito  := cd_conta_contabil_banco_w;
                ctb_movimento_doc_w.cd_conta_credito := null;
            else
                ctb_movimento_doc_w.cd_conta_debito  := null;
                ctb_movimento_doc_w.cd_conta_credito := cd_conta_contabil_banco_w;
            end if;

            ctb_movimento_doc_w := ctb_online_pck.ctb_gravar_movto(ctb_movimento_doc_w, nm_usuario_p);
        end if;
    end if;

    if (dados_contab_w.cd_estab_movto = 0) then
        dados_contab_w.cd_estab_movto := null;
    end if;

    if (dados_contab_w.cd_tributo IS NOT NULL AND dados_contab_w.cd_tributo::text <> '') then
        dados_contab_w.cd_tributo := dados_contab_w.cd_tributo;
    end if;

    dados_contab_w.cd_tributo_regra := dados_contab_w.cd_tributo;

    ctb_contab_onl_lote_fin_pck.contabiliza_trans_financ(dados_contab_w, doc_p.nm_usuario);

    /* Gerar lancamentos em conta transitoria para titulos pagos por estabelecimento diferente do pagador */

    select count(*)
    into STRICT   qt_regra_estab_origem_w
    from   ctb_regra_estab_dif
    where  cd_tipo_lote_contabil = doc_p.cd_tipo_lote_contabil
    and    cd_estabelecimento = doc_p.cd_estabelecimento
    and    (cd_estab_origem IS NOT NULL AND cd_estab_origem::text <> '');

    begin
    select  cd_estab_financeiro
    into STRICT    cd_estab_transit_w
    from    estabelecimento
    where   cd_estabelecimento = doc_p.cd_estabelecimento;
    exception
    when others then
        cd_estab_transit_w := null;
    end;

    select  coalesce(cd_estab_transit_w, doc_p.cd_estabelecimento)
    into STRICT    cd_estab_transit_w
;

    begin
    if (coalesce(dados_contab_w.nr_seq_banco_od,0) <> 0) then
        select  b.cd_estabelecimento
        into STRICT    cd_estab_banco_w
        from    movto_trans_financ m,
                banco_estabelecimento b
        where   m.nr_seq_banco_od = b.nr_sequencia
        and     m.nr_sequencia = dados_contab_w.nr_seq_agrupamento;
    else
        select  b.cd_estabelecimento
        into STRICT    cd_estab_banco_w
        from    movto_trans_financ m,
                banco_estabelecimento b
        where   m.nr_seq_banco = b.nr_sequencia
        and     m.nr_sequencia = dados_contab_w.nr_seq_agrupamento;
    end if;
    exception
    when others then
            cd_estab_banco_w := null;
    end;

    if (coalesce(cd_estab_banco_w::text, '') = '') then
        select  CASE WHEN            coalesce(cd_estab_banco_w, doc_p.cd_estabelecimento)=doc_p.cd_estabelecimento THEN             coalesce(cd_estab_transit_w, doc_p.cd_estabelecimento)  ELSE coalesce(cd_estab_banco_w, doc_p.cd_estabelecimento) END 
        into STRICT    cd_estab_banco_w
;
    end if;

    CALL ctb_online_pck.definir_regra_lote_esta_dif(doc_p.cd_tipo_lote_contabil, doc_p.cd_estabelecimento);
    ie_permite_estab_dif_w := ctb_online_pck.get_permite_estab_dif(doc_p.cd_tipo_lote_contabil, cd_estab_transit_w);
    cd_conta_transitoria_w := ctb_online_pck.get_conta_transitoria_estab(doc_p.cd_tipo_lote_contabil, cd_estab_transit_w);
    cd_historico_ct_w      := ctb_online_pck.get_historico_transit_estab(doc_p.cd_tipo_lote_contabil, cd_estab_transit_w);

    if (ie_permite_estab_dif_w = 'PCCT') and (doc_p.nm_atributo = 'VL_TRANSACAO') and (ie_debito_credito_w <> 'T') and (qt_regra_estab_origem_w > 0) and
        ((coalesce(cd_estab_banco_w, doc_p.cd_estabelecimento) <> doc_p.cd_estabelecimento) or
        ((coalesce(dados_contab_w.cd_estab_movto, doc_p.cd_estabelecimento) <> doc_p.cd_estabelecimento) and (ctb_param_lote_cont_banco_w.ie_contab_transit_tf = 'S'))) then
        if (cd_conta_transitoria_w IS NOT NULL AND cd_conta_transitoria_w::text <> '') then
            if (ie_debito_credito_w = 'D') then
                ie_debito_credito_ww := 'C';
            elsif (ie_debito_credito_w = 'C') then
                ie_debito_credito_ww := 'D';
            end if;

            ctb_movimento_w                     := null;
            ctb_movimento_w.nr_lote_contabil    := dados_contab_w.nr_lote_contabil;
            ctb_movimento_w.cd_estabelecimento  := doc_p.cd_estabelecimento;
            ctb_movimento_w.dt_movimento        := doc_p.dt_competencia;
            ctb_movimento_w.vl_movimento        := doc_p.vl_movimento;
            ctb_movimento_w.cd_historico        := cd_historico_ct_w;
            ctb_movimento_w.nr_seq_agrupamento  := dados_contab_w.nr_seq_agrupamento;
            ctb_movimento_w.nr_documento        := dados_contab_w.nr_seq_agrupamento;
            ctb_movimento_w.ie_origem_documento := dados_contab_w.ie_origem_documento;
            ctb_movimento_w.ds_compl_historico  := ctb_online_pck.ctb_obter_compl_historico(doc_p.cd_tipo_lote_contabil,cd_historico_ct_w);
            ctb_movimento_w.nr_seq_proj_rec     := dados_contab_w.nr_seq_proj_rec;

            if (coalesce(dados_contab_w.nr_seq_banco_od,0) <> 0) then
                if (ie_debito_credito_ww = 'D') then
                    ctb_movimento_w.cd_conta_debito  := cd_conta_transitoria_w;
                    ctb_movimento_w.cd_conta_credito := null;
                else
                    ctb_movimento_w.cd_conta_debito  := null;
                    ctb_movimento_w.cd_conta_credito := cd_conta_transitoria_w;
                end if;

                ctb_movimento_w := ctb_online_pck.ctb_gerar_movto_conta_transit(ctb_movimento_w, nm_usuario_p);
            else
                select  coalesce(max(nr_sequencia),0)
                into STRICT    nr_sequencia_movto_w
                from    ctb_movimento
                where   nr_lote_contabil        = dados_contab_w.nr_lote_contabil
                and     (cd_conta_debito IS NOT NULL AND cd_conta_debito::text <> '')
                and     ie_transitorio          = 'N'
                and     nr_seq_agrupamento      = dados_contab_w.nr_seq_agrupamento;

                if (nr_sequencia_movto_w IS NOT NULL AND nr_sequencia_movto_w::text <> '') then
                    update  ctb_movimento
                    set     cd_estabelecimento      = cd_estab_banco_w
                    where   nr_lote_contabil        = dados_contab_w.nr_lote_contabil
                    and     nr_sequencia            = nr_sequencia_movto_w;
                end if;

                ctb_movimento_w.cd_conta_credito    := null;
                ctb_movimento_w.cd_conta_debito     := cd_conta_transitoria_w;
                ctb_movimento_w := ctb_online_pck.ctb_gerar_movto_conta_transit(ctb_movimento_w, nm_usuario_p);

                ctb_movimento_w.cd_conta_debito     := null;
                ctb_movimento_w.cd_conta_credito    := cd_conta_transitoria_w;
                ctb_movimento_w.cd_estabelecimento  := cd_estab_banco_w;
                ctb_movimento_w := ctb_online_pck.ctb_gerar_movto_conta_transit(ctb_movimento_w, nm_usuario_p);
            end if;

            if (ctb_param_lote_cont_banco_w.ie_contab_transit_tf = 'S') then
                ctb_movimento_w.cd_estabelecimento := coalesce(coalesce(dados_contab_w.cd_estab_movto, doc_p.cd_estabelecimento),doc_p.cd_estabelecimento);
                ctb_movimento_w := ctb_online_pck.ctb_gerar_movto_conta_transit(ctb_movimento_w, nm_usuario_p);
            end if;
        end if;
    end if;

    if (doc_p.nm_atributo in ('VL_DESCONTOS', 'VL_DESPESA_BANCARIA', 'VL_GLOSA', 'VL_JUROS', 'VL_MULTA', 'VL_RECEBIDO_CB', 'VL_REC_MAIOR', 'VL_REC_PLS')) then
        ie_contab_transit_w := ctb_param_lote_cont_banco_w.ie_contab_transit_cr;
    end if;

    /*      Gerar lancamentos em conta transitoria para titulos pagos por estabelecimento diferente do pagador */

    if (ctb_param_lote_cont_banco_w.ie_contab_cp_no_cb = 'S') and (ie_contab_transit_w = 'S') and (ie_permite_estab_dif_w = 'PCCT') and (coalesce(dados_contab_w.cd_estab_movto, 0) <> 0) and (doc_p.nm_atributo <> 'VL_TRANSACAO') and (doc_p.nm_atributo <> 'VL_IMPOSTO_BAIXA') and (doc_p.nm_atributo <> 'VL_PROV_TRIBUTO') and (nr_titulo_w IS NOT NULL AND nr_titulo_w::text <> '') and (cd_conta_transitoria_w IS NOT NULL AND cd_conta_transitoria_w::text <> '') and (dados_contab_w.cd_estab_movto <> doc_p.cd_estabelecimento) then
        begin

            if (doc_p.nm_atributo = 'VL_BAIXA') and (doc_p.nm_tabela = 'TITULO_PAGAR_BAIXA_CONTAB_V') then
                begin
                    begin
                        if (doc_p.nm_tabela = 'TITULO_PAGAR_BAIXA_CONTAB_V') and (coalesce(nr_seq_liq_cc_w, 0) <> 0) then
                            begin
                                select coalesce(c.vl_pago, 0)
                                into STRICT   vl_titulo_banco_w
                                from    titulo_pagar_baixa_cc c,
                                        titulo_pagar_baixa b,
                                        titulo_pagar a
                                where  a.nr_titulo = c.nr_titulo
                                and    a.nr_titulo = b.nr_titulo
                                and    a.nr_titulo = nr_titulo_w
                                and    b.nr_sequencia = nr_seq_baixa_cr_w
                                and    (nr_seq_conta_banco IS NOT NULL AND nr_seq_conta_banco::text <> '')
                                and    c.nr_sequencia = nr_seq_liq_cc_w;
                            end;
                        else
                            begin
                                select coalesce(max(b.vl_pago), 0)
                                into STRICT   vl_titulo_banco_w
                                from    titulo_pagar_baixa b,
                                        titulo_pagar a
                                where  a.nr_titulo = b.nr_titulo
                                and    a.nr_titulo = nr_titulo_w
                                and    b.nr_sequencia = nr_seq_baixa_cr_w
                                and    (nr_seq_conta_banco IS NOT NULL AND nr_seq_conta_banco::text <> '')
                                and    not exists (SELECT 1
                                        from   titulo_pagar_baixa_cc x
                                        where  b.nr_titulo = x.nr_titulo
                                        and    b.nr_sequencia = x.nr_seq_baixa  LIMIT 1);
                            end;
                        end if;
                    exception
                        when others then
                            vl_titulo_banco_w := doc_p.vl_movimento;
                    end;

                    if (vl_titulo_banco_w <> doc_p.vl_movimento) then
                        doc_p.vl_movimento := vl_titulo_banco_w;
                    end if;
                end;
            end if;

            ie_gera_ctb_transit_w := 'S';
            if (doc_p.nm_atributo in ('VL_DESCONTOS', 'VL_JUROS', 'VL_MULTA')) and (doc_p.nm_tabela = 'TITULO_PAGAR_BAIXA_CONTAB_V') then
                begin
                    select CASE WHEN coalesce(sum(c.vl_pago), 0)=0 THEN  'N'  ELSE 'S' END
                    into STRICT   ie_gera_ctb_transit_w
                    from    titulo_pagar_baixa_cc c,
                            titulo_pagar_baixa b,
                            titulo_pagar a
                    where  a.nr_titulo = c.nr_titulo
                    and    a.nr_titulo = b.nr_titulo
                    and    a.nr_titulo = nr_titulo_w
                    and    b.nr_sequencia = nr_seq_baixa_cr_w
                    and    (nr_seq_conta_banco IS NOT NULL AND nr_seq_conta_banco::text <> '')
                    and    c.nr_sequencia = nr_seq_liq_cc_w;

                    /*Valor de multa e juros ja esta no VL_TRANSACAO */

                    if (doc_p.nm_atributo in ('VL_MULTA', 'VL_JUROS')) then
                        ie_gera_ctb_transit_w := 'N';
                    end if;
                end;
            end if;

            ie_gera_ctb_transit_w := coalesce(ie_gera_ctb_transit_w, 'S');

            if (ie_gera_ctb_transit_w = 'S') then
                begin

                    ctb_movimento_w                     := null;
                    ctb_movimento_w.nr_lote_contabil    := dados_contab_w.nr_lote_contabil;
                    ctb_movimento_w.dt_movimento        := doc_p.dt_competencia;
                    ctb_movimento_w.vl_movimento        := doc_p.vl_movimento;
                    ctb_movimento_w.cd_historico        := cd_historico_ct_w;
                    ctb_movimento_w.nr_seq_agrupamento  := dados_contab_w.nr_seq_agrupamento;
                    ctb_movimento_w.nr_documento        := dados_contab_w.nr_doc_movto;
                    ctb_movimento_w.ie_origem_documento := dados_contab_w.ie_origem_documento;
                    ctb_movimento_w.ds_compl_historico  := ctb_online_pck.ctb_obter_compl_historico(doc_p.cd_tipo_lote_contabil,cd_historico_ct_w);
                    ctb_movimento_w.cd_estabelecimento := doc_p.cd_estabelecimento;
                    ctb_movimento_w.cd_conta_debito    := cd_conta_transitoria_w;
                    ctb_movimento_w.cd_conta_credito   := null;
                    ctb_movimento_w.nr_seq_proj_rec     := dados_contab_w.nr_seq_proj_rec;

                    ctb_movimento_w := ctb_online_pck.ctb_gerar_movto_conta_transit(ctb_movimento_w, nm_usuario_p);

                    ctb_movimento_w.cd_estabelecimento := dados_contab_w.cd_estab_movto;
                    ctb_movimento_w.cd_conta_debito    := null;
                    ctb_movimento_w.cd_conta_credito   := cd_conta_transitoria_w;

                    ctb_movimento_w := ctb_online_pck.ctb_gerar_movto_conta_transit(ctb_movimento_w, nm_usuario_p);
                end;
            end if;

        end;
    end if;

    doc_p := dados_contab_w.doc;

    if (doc_p.nm_tabela = 'TITULO_PAGAR_BAIXA_CONTAB_V') then
        begin
        update  titulo_pagar_baixa
        set   nr_lote_contabil = dados_contab_w.doc.nr_lote_contabil
        where coalesce(nr_lote_contabil,0) = 0
        and   nr_titulo = doc_p.nr_documento
        and   nr_sequencia = doc_p.nr_seq_doc_compl;
        end;

    elsif (doc_p.nm_tabela = 'TITULO_RECEBER_LIQ_CONTAB_V') then
        begin
        update  titulo_receber_liq
        set   nr_lote_contabil = dados_contab_w.doc.nr_lote_contabil
        where coalesce(nr_lote_contabil,0) = 0
        and   nr_titulo = doc_p.nr_documento
        and   nr_sequencia = doc_p.nr_seq_doc_compl;
        end;

    elsif (doc_p.nm_tabela = 'MOVTO_TRANS_FINANC') then
        begin
        update  movto_trans_financ a
        set   nr_lote_contabil = dados_contab_w.doc.nr_lote_contabil
        where coalesce(nr_lote_contabil,0) = 0
        and   coalesce(coalesce(nr_seq_titulo_pagar, nr_seq_titulo_receber),nr_sequencia) = doc_p.nr_documento
        and (coalesce(doc_p.nr_seq_doc_compl::text, '') = '' or nr_sequencia = doc_p.nr_seq_doc_compl);
        end;

    elsif (doc_p.nm_tabela = 'CHEQUE_CR') then
        begin
        update  movto_trans_financ
        set     nr_lote_contabil = dados_contab_w.doc.nr_lote_contabil
        where   coalesce(nr_lote_contabil,0) = 0
        and   nr_sequencia = (
          SELECT  a.nr_sequencia
          from    movto_trans_financ a,
              deposito_cheque b,
              cheque_cr g
          where   b.nr_seq_deposito = a.nr_seq_deposito
          and     b.nr_seq_cheque = g.nr_seq_cheque
          and     g.nr_seq_cheque   = doc_p.nr_documento
          and     coalesce(coalesce(a.nr_seq_titulo_pagar, a.nr_seq_titulo_receber),a.nr_sequencia) = doc_p.nr_seq_doc_compl
        );
        end;

    elsif (doc_p.nm_tabela = 'MOVTO_CARTAO_CR_PARCELA') then
        begin
        update  movto_cartao_cr_parcela
        set     nr_lote_contabil = dados_contab_w.doc.nr_lote_contabil
        where   coalesce(nr_lote_contabil,0) = 0
        and   nr_sequencia = doc_p.nr_doc_analitico;
        end;

    elsif (doc_p.nm_tabela = 'TITULO_PAGAR_IMPOSTO') then
        begin
        update  titulo_pagar_imposto
        set     nr_lote_contabil = dados_contab_w.doc.nr_lote_contabil
        where   coalesce(nr_lote_contabil,0) = 0
        and   nr_sequencia = doc_p.nr_doc_analitico;
        end;

    elsif (doc_p.nm_tabela = 'TITULO_PAGAR_TRIB_BAIXA') then
        begin
        update  titulo_pagar_trib_baixa
        set     nr_lote_contabil = dados_contab_w.doc.nr_lote_contabil
        where   coalesce(nr_lote_contabil,0) = 0
        and   nr_sequencia = doc_p.nr_doc_analitico;
        end;

    elsif (doc_p.nm_tabela = 'TITULO_RECEBER_TRIB') then
        begin
        update  titulo_receber_trib_baixa
        set     nr_lote_contabil = dados_contab_w.doc.nr_lote_contabil
        where   coalesce(nr_lote_contabil,0) = 0
        and   nr_sequencia = doc_p.nr_doc_analitico;
        end;

    end if;

end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ctb_contab_onl_controle_banco ( doc_p INOUT ctb_documento, nm_usuario_p text) FROM PUBLIC;

