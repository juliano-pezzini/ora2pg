-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE cpoe_count_dieta_oral_atend ( nr_atendimento_p bigint, ie_inclusao_p bigint, ie_excede_limite_p INOUT text, dt_prox_prescr_p INOUT timestamp, qt_dieta_vigente_p INOUT bigint) AS $body$
DECLARE


qt_segunda_ordem_w   integer := 0;
qt_programada_w      integer := 0;
param_REP_298_w      double precision;
ie_excede_limite_w   varchar(1) := 'N';
dt_prox_prescr_w     cpoe_dieta.dt_fim%type := null;
qt_dieta_vigente_w   integer := 1;


BEGIN

	param_REP_298_w := coalesce((obter_valor_param_usuario(924, 298, obter_perfil_ativo, WHEB_USUARIO_PCK.get_nm_usuario, obter_estabelecimento_ativo))::numeric ,0);
	
	select count(*)
	  into STRICT qt_segunda_ordem_w
	  from cpoe_dieta
	 where nr_atendimento = nr_atendimento_p
	   and ie_tipo_dieta = 'O'
	   and ie_duracao = 'C'
	   and (coalesce(dt_suspensao::text, '') = '' or dt_suspensao > clock_timestamp());
	
	select count(*)
	  into STRICT qt_programada_w
	  from cpoe_dieta      
	 where nr_atendimento = nr_atendimento_p
	   and ie_tipo_dieta = 'O'
	   and ie_duracao = 'P'
	   and (coalesce(dt_suspensao::text, '') = '' or dt_suspensao > clock_timestamp())
	   and dt_fim > clock_timestamp();
		
	if ((qt_segunda_ordem_w + qt_programada_w) + ie_inclusao_p > param_REP_298_w) then
		ie_excede_limite_w := 'S';
	end if;
	
	qt_dieta_vigente_w := (qt_segunda_ordem_w + qt_programada_w) + ie_inclusao_p;
	
	if (param_REP_298_w = 1 and ie_excede_limite_w = 'S') then
		select max(dt_fim)
		  into STRICT dt_prox_prescr_w
		  from cpoe_dieta a
		 where nr_atendimento = nr_atendimento_p
		   and ie_tipo_dieta = 'O'
		   and ie_duracao = 'P'
		   and dt_fim > clock_timestamp()
		   and (coalesce(dt_suspensao::text, '') = '' or dt_suspensao > clock_timestamp());
	end if;
	
	ie_excede_limite_p := ie_excede_limite_w;
	dt_prox_prescr_p := dt_prox_prescr_w;
	qt_dieta_vigente_p := qt_dieta_vigente_w;
	
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cpoe_count_dieta_oral_atend ( nr_atendimento_p bigint, ie_inclusao_p bigint, ie_excede_limite_p INOUT text, dt_prox_prescr_p INOUT timestamp, qt_dieta_vigente_p INOUT bigint) FROM PUBLIC;

