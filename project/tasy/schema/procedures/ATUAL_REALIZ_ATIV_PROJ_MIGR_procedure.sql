-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE atual_realiz_ativ_proj_migr ( nr_seq_gerencia_p bigint, nm_usuario_p text) AS $body$
DECLARE


nr_seq_projeto_w	bigint := 0;
ie_pre_projeto_w	varchar(1);
nr_seq_projeto_old_ww	bigint := 0;
nr_seq_os_projeto_w	bigint;

c01 CURSOR FOR
SELECT	p.nr_sequencia nr_seq_projeto,
	'S' ie_pre_projeto,
	p.nr_seq_ordem_serv
from	funcoes_migradas_pre_projeto_v f,
	proj_projeto p
where	f.cd_funcao = p.cd_funcao
and	f.ie_gerencia = p.nr_seq_gerencia
and	p.nr_seq_classif = 14
and	p.nr_seq_gerencia = nr_seq_gerencia_p

union

select	p.nr_sequencia nr_seq_projeto,
	'N' ie_pre_projeto,
	p.nr_seq_ordem_serv
from	proj_projeto p
where	p.nr_seq_gerencia = nr_seq_gerencia_p
and	p.nr_seq_classif = 14
and	p.nr_seq_estagio in (12,13)
and	not exists (
		SELECT	1
		from	funcoes_migradas_pre_projeto_v f
		where	f.cd_funcao = p.cd_funcao
		and	f.ie_gerencia = p.nr_seq_gerencia)
order by
	nr_seq_projeto,
	ie_pre_projeto desc;


BEGIN
if (nr_seq_gerencia_p IS NOT NULL AND nr_seq_gerencia_p::text <> '') and (nm_usuario_p IS NOT NULL AND nm_usuario_p::text <> '') then
	begin
	open c01;
	loop
	fetch c01 into	nr_seq_projeto_w,
			ie_pre_projeto_w,
			nr_seq_os_projeto_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
		begin
		if (nr_seq_projeto_w <> nr_seq_projeto_old_ww) then
			begin
			if (nr_seq_projeto_w = 1105) then
				begin
				CALL limpar_real_ativ_proj_migr_pep(nr_seq_projeto_w, nm_usuario_p);
				end;
			else
				begin
				CALL limpar_realiz_ativ_proj_migr(nr_seq_projeto_w, nm_usuario_p);
				end;
			end if;
			end;
		end if;
		if (nr_seq_projeto_w = 1105) then
			begin
			CALL gerar_real_ativ_proj_migr_pep(nr_seq_projeto_w, nm_usuario_p);
			end;
		elsif (ie_pre_projeto_w = 'S') then
			begin
			CALL gerar_realiz_ativ_proj_migr(nr_seq_projeto_w, nm_usuario_p);
			end;
		elsif (nr_seq_os_projeto_w IS NOT NULL AND nr_seq_os_projeto_w::text <> '') then
			begin
			CALL gerar_realiz_os_ativ_proj_migr(nr_seq_projeto_w, nr_seq_os_projeto_w, nm_usuario_p);
			end;
		end if;
		nr_seq_projeto_old_ww := nr_seq_projeto_w;
		end;
	end loop;
	close c01;
	end;
end if;
commit;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE atual_realiz_ativ_proj_migr ( nr_seq_gerencia_p bigint, nm_usuario_p text) FROM PUBLIC;

