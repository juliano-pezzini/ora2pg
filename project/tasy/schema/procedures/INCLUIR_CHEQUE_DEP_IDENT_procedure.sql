-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE incluir_cheque_dep_ident ( nr_seq_deposito_p bigint, nr_seq_cheque_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) AS $body$
DECLARE


vl_depositar_w			double precision;
dt_validade_w			timestamp;
cd_moeda_deposito_w		deposito_identificado.cd_moeda%type;
cd_moeda_cheque_w		cheque_cr.cd_moeda%type;
vl_cotacao_w			deposito_identificado.vl_cotacao%type;
vl_depositar_estrang_w		double precision;
vl_complemento_w		double precision;



BEGIN

select	coalesce(max(a.cd_moeda),obter_moeda_padrao_empresa(cd_estabelecimento_p,'E')),
	max(a.vl_cotacao)
into STRICT	cd_moeda_deposito_w,
	vl_cotacao_w
from	deposito_identificado a
where	a.nr_Sequencia = nr_seq_deposito_p;

select	coalesce(max(a.cd_moeda),obter_moeda_padrao_empresa(cd_estabelecimento_p,'E'))
into STRICT 	cd_moeda_cheque_w
from 	cheque_cr a
where 	a.nr_seq_cheque = nr_seq_cheque_p;

if (cd_moeda_deposito_w <> cd_moeda_cheque_w) then
	CALL Wheb_mensagem_pck.exibir_mensagem_abort(347339); --A moeda do deposito Ã© diferente da moeda do cheque selecionado
end if;

if (nr_seq_cheque_p IS NOT NULL AND nr_seq_cheque_p::text <> '') and (nr_seq_deposito_p IS NOT NULL AND nr_seq_deposito_p::text <> '') then

	select	coalesce(a.dt_limite_deposito,clock_timestamp())
	into STRICT	dt_validade_w
	from	deposito_identificado a
	where	a.nr_sequencia	= nr_seq_deposito_p;

	select	a.vl_saldo_negociado +
		coalesce(obter_juro_multa_cheque(a.nr_seq_cheque,dt_validade_w,'R','J'),0) +
		coalesce(obter_juro_multa_cheque(a.nr_seq_cheque,dt_validade_w,'R','M'),0)
	into STRICT	vl_depositar_w
	from	cheque_cr a
	where	a.nr_seq_cheque	= nr_seq_cheque_p;

	if (coalesce(vl_cotacao_w,0) <> 0) then
		vl_depositar_estrang_w := (coalesce(vl_depositar_w,0) / coalesce(vl_cotacao_w,1));
		vl_complemento_w := (coalesce(vl_depositar_w,0) - coalesce(vl_depositar_estrang_w,0));
	else
		vl_cotacao_w := null;
		vl_depositar_estrang_w := null;
		vl_complemento_w := null;
		cd_moeda_deposito_w := null;
	end if;


	insert into deposito_ident_cheque(nr_sequencia,
		nm_usuario,
		dt_atualizacao,
		nm_usuario_nrec,
		dt_atualizacao_nrec,
		nr_seq_deposito,
		nr_seq_cheque,
		vl_depositar,
		cd_moeda,
		vl_depositar_estrang,
		vl_complemento,
		vl_cotacao)
	values (nextval('deposito_ident_titulo_seq'),
		nm_usuario_p,
		clock_timestamp(),
		nm_usuario_p,
		clock_timestamp(),
		nr_seq_deposito_p,
		nr_seq_cheque_p,
		coalesce(vl_depositar_w,0),
		cd_moeda_deposito_w,
		vl_depositar_estrang_w,
		vl_complemento_w,
		vl_cotacao_w);
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE incluir_cheque_dep_ident ( nr_seq_deposito_p bigint, nr_seq_cheque_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) FROM PUBLIC;

