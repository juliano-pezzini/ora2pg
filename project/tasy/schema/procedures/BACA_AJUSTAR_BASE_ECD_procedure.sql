-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE baca_ajustar_base_ecd () AS $body$
DECLARE


qt_atual_w	bigint;
qt_registro_w	bigint;
ds_comando_w 	varchar(4000);

c01 CURSOR FOR
SELECT	a.Vl_Dominio,
	a.ds_valor_dominio,
	a.nr_seq_apresent
from	dominio b,
	valor_dominio a
where	a.cd_dominio	= b.cd_dominio
and	b.cd_dominio	= 3508
and	coalesce(a.nr_seq_apresent::text, '') = '';

vet01	c01%rowtype;


BEGIN

/*Ajusta a sequencia de apresentação dos registros */

open C01;
loop
fetch C01 into
	vet01;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin

	ds_comando_w	:= 	'	update	valor_dominio a ' ||
				'	set	a.nr_seq_apresent	= (	select	max(y.nr_seq_apresent)  ' ||
				'					from	tasy_versao.valor_dominio y     ' ||
				'					where	y.cd_dominio	= 3508  ' ||
				'					and	y.vl_dominio	= a.vl_dominio) ' ||
				' where	a.cd_dominio	= 3508 ' ||
				' and	a.vl_dominio	= :vl_dominio';

	CALL Exec_Sql_Dinamico_Bv('Matheus',ds_comando_w,'vl_dominio=' || vet01.Vl_Dominio);

	end;
end loop;
close C01;


/*Início - Verifica a ativação da interface */

select	coalesce(max(position('nr_seq_controle_sped' in ds_comando)),0)
into STRICT	qt_registro_w
from	interface
where	cd_interface = 1453;

select	count(*)
into STRICT	qt_registro_w
from	interface
where	cd_interface	= 1453;

if (qt_registro_w = 0) then
	begin
	CALL exec_sql_dinamico('Matheus','insert into interface select * from tasy_versao.interface where cd_interface = 1453');
	CALL exec_sql_dinamico('Matheus','insert into interface_reg select * from tasy_versao.interface_reg where cd_interface = 1453');
	CALL exec_sql_dinamico('Matheus','insert into interface_atributo select * from tasy_versao.interface_atributo where cd_interface = 1453');
	end;
else
	begin

	select	count(*)
	into STRICT	qt_registro_w
	from	interface
	where	cd_interface		= 1453
	and	substr(ds_interface,1,3) = 'ECD';

	select	coalesce(max(position('nr_seq_controle_sped' in ds_comando)),0)
	into STRICT	qt_atual_w
	from	interface
	where	cd_interface = 1453;

	/*Se a interface for a do ECD e estiver desatualizada */

	if (qt_registro_w > 0) and (qt_atual_w = 0) then
		begin
		/*Elimina registros antigos */

		CALL exec_sql_dinamico('Matheus','delete from interface_atributo where cd_interface = 1453');
		CALL exec_sql_dinamico('Matheus','delete from interface_reg where cd_interface = 1453');
		CALL exec_sql_dinamico('Matheus','delete from interface where cd_interface = 1453');

		/*Reativa a interface 1453 do registro J800 */

		CALL exec_sql_dinamico('Matheus','insert into interface select * from tasy_versao.interface where cd_interface = 1453');
		CALL exec_sql_dinamico('Matheus','insert into interface_reg select * from tasy_versao.interface_reg where cd_interface = 1453');
		CALL exec_sql_dinamico('Matheus','insert into interface_atributo select * from tasy_versao.interface_atributo where cd_interface = 1453');

		end;
	end if;

	end;
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE baca_ajustar_base_ecd () FROM PUBLIC;

