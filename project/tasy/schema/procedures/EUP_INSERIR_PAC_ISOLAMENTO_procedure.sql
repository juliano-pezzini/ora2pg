-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE eup_inserir_pac_isolamento (nr_atendimento_p bigint, cd_setor_atendimento_p bigint, nr_seq_motivo_isol_p bigint, nr_seq_tipo_isolamento_cih_p bigint, cd_perfil_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint) AS $body$
DECLARE

				 
cd_pessoa_fisica_w		varchar(10);
cd_classif_Setor_w		varchar(2);
ie_microorganismo_isol_w	varchar(1) := 'N';

/*ParÃ¢metros*/
 
VarMotivoIsolamento_w		varchar(1);


BEGIN 
VarMotivoIsolamento_w	:= coalesce(Obter_valor_param_usuario(44, 80, cd_perfil_p, nm_usuario_p, cd_estabelecimento_p),'N');
 
if (coalesce(nr_atendimento_p,0) > 0) and (coalesce(cd_Setor_atendimento_p,0) > 0) then 
	 
	select	max(a.cd_pessoa_fisica) 
	into STRICT	cd_pessoa_fisica_w 
	from	atendimento_paciente a 
	where	a.nr_atendimento = nr_atendimento_p;
	 
	select	max(a.cd_classif_setor) 
	into STRICT	cd_classif_Setor_w 
	from	setor_atendimento a 
	where	a.cd_setor_atendimento = cd_setor_atendimento_p;
		 
	if (cd_classif_setor_w in (3,4,5,1)) then 
		 
		begin 
		select	'S' 
		into STRICT	ie_microorganismo_isol_w 
		from 	atendimento_paciente a, 
			atendimento_precaucao b, 
			atend_precaucao_micro c, 
			cih_microorganismo d 
		where	a.nr_atendimento = b.nr_atendimento 
		and	b.nr_sequencia = c.nr_seq_atend_precaucao 
		and	c.cd_microorganismo = d.cd_microorganismo 
		and	coalesce(d.ie_isolamento_permanente,'N') = 'S'  
		and	a.cd_pessoa_fisica = cd_pessoa_fisica_w LIMIT 1;
		exception 
		when others then 
			ie_microorganismo_isol_w := 'N';
		end;
		 
		if (ie_microorganismo_isol_w = 'S') then 
			 
			update	atendimento_paciente 
			set	ie_paciente_isolado 	= 'S', 
				nm_usuario 		= nm_usuario_p, 
				dt_atualizacao		= clock_timestamp() 
			where	nr_atendimento 		= nr_atendimento_p;
			 
			if (VarMotivoIsolamento_w = 'S') and (coalesce(nr_seq_motivo_isol_p,0) > 0) then 
			 
				CALL Gerar_motivo_isolamento(nr_atendimento_p, 
							nr_seq_motivo_isol_p, 
							nm_usuario_p, 
							'I', 
							'', 
							null, 
							nr_seq_tipo_isolamento_cih_p, 
							clock_timestamp(), 
							null, 
							null);					
				 
			end if;
		end if;				
	end if;
	 
end if;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eup_inserir_pac_isolamento (nr_atendimento_p bigint, cd_setor_atendimento_p bigint, nr_seq_motivo_isol_p bigint, nr_seq_tipo_isolamento_cih_p bigint, cd_perfil_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint) FROM PUBLIC;

