-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gera_result_micro_datainnov ( cd_barras_p text, cd_microorganismo_p text, cd_medicamento_p text, ie_resultado_p text, ds_resultado_antib_p text, nm_usuario_p text, qt_microorganismo_p text ) AS $body$
DECLARE


nr_prescricao_w		bigint;
nr_seq_prescr_w		bigint;
nr_seq_resultado_w	bigint;
nr_seq_result_item_w	bigint;
cd_microorganismo_w	bigint;
cd_medicamento_w	bigint;
ie_resultado_w		varchar(1);
ie_status_atend_w	smallint;
ie_gera_result_presc_w	varchar(1);
nr_seq_exame_w		exame_laboratorio.nr_seq_exame%type;
nr_seq_material_w	material_exame_lab.nr_sequencia%type;
dt_prescricao_w		prescr_medica.dt_prescricao%type;
dt_nascimento_w		timestamp;
ie_sexo_w		varchar(1);
nr_sequencia_w		exame_lab_result_antib.nr_sequencia%type;


BEGIN

select 	max(nr_prescricao),
	max(nr_seq_prescr)
into STRICT	nr_prescricao_w,
	nr_seq_prescr_w
from	prescr_proc_mat_item
where	cd_barras = to_char((cd_barras_p)::numeric );

select	max(ie_status_atend),
	max(nr_seq_exame),
	max(b.nr_sequencia)
into STRICT	ie_status_atend_w,
	nr_seq_exame_w,
	nr_seq_material_w
from	prescr_procedimento a,
	material_exame_lab b
where	a.cd_material_exame = b.cd_material_exame
and	a.nr_prescricao = nr_prescricao_w
and	a.nr_sequencia = nr_seq_prescr_w;

if (ie_status_atend_w <= 30) then

	select 	max(a.ie_gerar_result_prescr)
	into STRICT	ie_gera_result_presc_w
	from 	lab_parametro a,
		prescr_medica  b
	where	a.cd_estabelecimento = b.cd_estabelecimento
	and	b.nr_prescricao = nr_prescricao_w;

	if (ie_gera_result_presc_w = 'N') then
		CALL Gera_Exame_Result_Lab(nr_prescricao_w , nr_seq_prescr_w, 'N', 'N', 'S', nm_usuario_p);
	else
		select 	max(nr_seq_resultado)
		into STRICT	nr_seq_resultado_w
		from	exame_lab_resultado
		where	nr_prescricao = nr_prescricao_w;

		if ((coalesce(nr_seq_resultado_w::text, '') = '') or (nr_seq_resultado_w <= 0)) then
			CALL Gera_Exame_Result_Lab(nr_prescricao_w , nr_seq_prescr_w, 'N', 'N', 'S', nm_usuario_p);
			select 	max(nr_seq_resultado)
			into STRICT	nr_seq_resultado_w
			from	exame_lab_resultado
			where	nr_prescricao = nr_prescricao_w;
		end if;
/*	Tratativa para caso o usuário libere uma prescrição com a opção de gerar os resultados desmarcada
	e, antes de efetuar o processo de integração altere a opção para "SIM" Dessa maneira não existirá um nr_seq_resultado para a determinada
	prescrição o que irá impactar na geração dos resultados negativamente
	*/
		select 	dt_prescricao,
			obter_nascimento_prescricao(nr_prescricao_w),
			obter_sexo_prescricao(nr_prescricao_w)
		into STRICT	dt_prescricao_w,
			dt_nascimento_w,
			ie_sexo_w
		from 	prescr_medica
		where 	nr_prescricao = nr_prescricao_w;

		CALL Gera_resultado_lab(nr_seq_resultado_w, nr_prescricao_w, nr_seq_prescr_w, nr_seq_exame_w, nr_seq_material_w, (dt_prescricao_w - dt_nascimento_w) / 365.25, ie_sexo_w, nm_usuario_p);
	end if;

	select 	max(nr_seq_resultado)
	into STRICT	nr_seq_resultado_w
	from	exame_lab_resultado
	where	nr_prescricao = nr_prescricao_w;

end if;


select	max(i.nr_sequencia)
into STRICT	nr_seq_result_item_w
from	exame_lab_result_item i,
	exame_laboratorio e
where 	i.nr_seq_exame		= e.nr_seq_exame
and	i.nr_seq_resultado 	= nr_seq_resultado_w
and	i.nr_seq_prescr		= nr_seq_prescr_w
and	e.ie_formato_resultado	in ('SM','SDM');

select	max(cd_microorganismo)
into STRICT	cd_microorganismo_w
from	cih_microorganismo
where	coalesce(ds_microorganismo_integr,cd_microorganismo) = cd_microorganismo_p;

select	max(a.cd_medicamento)
into STRICT	cd_medicamento_w
from	cih_medicamento a,
	cih_medicamento_int b,
	equipamento_lab c
where	a.cd_medicamento = b.cd_medicamento
and	b.cd_equipamento = c.cd_equipamento
and	c.ds_sigla = 'DTINNOV'
and	b.cd_medicamento_integracao = cd_medicamento_p;

if (coalesce(cd_medicamento_w::text, '') = '') then
	select	max(cd_medicamento)
	into STRICT	cd_medicamento_w
	from	cih_medicamento a
	where	coalesce(ds_codigo_integr,cd_medicamento) = cd_medicamento_p;
end if;

if (nr_seq_result_item_w IS NOT NULL AND nr_seq_result_item_w::text <> '') and (cd_microorganismo_w IS NOT NULL AND cd_microorganismo_w::text <> '') and (cd_medicamento_w IS NOT NULL AND cd_medicamento_w::text <> '') then


	ie_resultado_w := substr(ie_resultado_p,1,1);

	select	coalesce(max(a.nr_sequencia),0)
	into STRICT		nr_sequencia_w
	from		exame_lab_result_antib	a
	where		a.nr_seq_resultado = nr_seq_resultado_w
	and			a.nr_seq_result_item = nr_seq_result_item_w
	and			a.cd_microorganismo = cd_microorganismo_w
	and			a.cd_medicamento = cd_medicamento_w;

	if (nr_sequencia_w > 0) then

		update 	exame_lab_result_antib
		set			nr_seq_resultado = nr_seq_resultado_w,
						nr_seq_result_item = nr_seq_result_item_w,
						cd_microorganismo = cd_microorganismo_w,
						cd_medicamento = cd_medicamento_w,
						ie_resultado = ie_resultado_w,
						dt_atualizacao = clock_timestamp(),
						nm_usuario = nm_usuario_p,
						ds_resultado_antib = ds_resultado_antib_p,
						qt_microorganismo = qt_microorganismo_p
		where		nr_sequencia = nr_sequencia_w;

	else

		insert	into exame_lab_result_antib(
			nr_sequencia,
			nr_seq_resultado,
			nr_seq_result_item,
			cd_microorganismo,
			cd_medicamento,
			ie_resultado,
			dt_atualizacao,
			nm_usuario,
			ds_resultado_antib,
			qt_microorganismo,
         nr_cultura_microorg
			)
		values (
			nextval('exame_lab_result_antib_seq'),
			nr_seq_resultado_w,
			nr_seq_result_item_w,
			cd_microorganismo_w,
			cd_medicamento_w,
			ie_resultado_w,
			clock_timestamp(),
			nm_usuario_p,
			ds_resultado_antib_p,
			qt_microorganismo_p,
         0
			);

	end if;

end if;


commit;


end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gera_result_micro_datainnov ( cd_barras_p text, cd_microorganismo_p text, cd_medicamento_p text, ie_resultado_p text, ds_resultado_antib_p text, nm_usuario_p text, qt_microorganismo_p text ) FROM PUBLIC;

