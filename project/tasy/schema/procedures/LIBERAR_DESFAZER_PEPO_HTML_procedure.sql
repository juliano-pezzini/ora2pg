-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE liberar_desfazer_pepo_html ( nr_cirurgia_p bigint default null, nm_usuario_p text DEFAULT NULL, nr_seq_pepo_p bigint default null, ie_opcao_p text DEFAULT NULL, ie_retorno_wdlg_p text DEFAULT NULL, cd_local_estoque_p bigint DEFAULT NULL, nr_prescricao_p bigint DEFAULT NULL, dt_liberacao_p timestamp default null, cd_retorno_p INOUT bigint  DEFAULT NULL) AS $body$
DECLARE

param_433_w					varchar(1);
param_117_w					varchar(1);
param_158_w					varchar(1);
param_323_w					varchar(1);

libera_pepo_w				boolean := false;
nr_seq_wdlg_w				bigint;
ie_geral_permite_liberar_w 	varchar(1);
cd_estabelecimento_w		bigint := wheb_usuario_pck.get_cd_estabelecimento;

nr_cirurgia_w				cirurgia.NR_CIRURGIA%TYPE;
nr_prescricao_w				cirurgia.NR_PRESCRICAO%TYPE;
dt_liberacao_w				cirurgia.DT_LIBERACAO%TYPE;

c01 CURSOR(nr_seq_p bigint) FOR 
	SELECT 	nr_cirurgia, 
				nr_prescricao, 
				dt_liberacao 
	from  	cirurgia 
	where  	nr_seq_pepo = nr_seq_p;


BEGIN 
 cd_retorno_p := 0;
  
	param_433_w	:= obter_valor_param_usuario(872, 433, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w);
	if (coalesce(param_433_w,'N') = 'S') then 
		CALL GERAR_TEMPO_CIRURGICO(nr_cirurgia_p,nm_usuario_p,nr_seq_pepo_p);		
	end if;
	 
	if (ie_opcao_p = 'L') then 
		param_117_w	:= obter_valor_param_usuario(872, 117, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w);
		if (coalesce(param_117_w,'N') = 'S') then 
			if (nr_seq_pepo_p > 0) then 
				ie_geral_permite_liberar_w := CONSISTE_LIBERACAO_PEPO_SUP(NR_SEQ_PEPO_P, nm_usuario_p, 'S', ie_geral_permite_liberar_w);
			else 
				ie_geral_permite_liberar_w := CONSISTE_LIBERACAO_PEPO(nr_cirurgia_p, nm_usuario_p, NULL, 'S', ie_geral_permite_liberar_w);
			end if;
			 
			select	max(b.nr_sequencia) 
			into STRICT	nr_seq_wdlg_w 
			from	consistencia_cirurgia a, 
					consistencia_lib_pepo b 
			where	a.nr_seq_consistencia  = b.nr_sequencia 
			and		((b.cd_estabelecimento = cd_estabelecimento_w) or (coalesce(b.cd_estabelecimento::text, '') = '')) 
			and 	((a.nr_cirurgia = coalesce(nr_cirurgia_p,0)) OR (coalesce(nr_seq_pepo_p,0) = a.nr_seq_pepo)) 
			and		obter_se_cirurgia_cancelada(a.nr_cirurgia) = 'N';
	 
			if (nr_seq_wdlg_w IS NOT NULL AND nr_seq_wdlg_w::text <> '') then 
				if (coalesce(ie_geral_permite_liberar_w, 'N') = 'S') 
				and (coalesce(ie_retorno_wdlg_p, 'N') = 'S') then 
					libera_pepo_w := true;
				else 
					cd_retorno_p := -1;
				end if;
			else 
				libera_pepo_w := true;
			end if;			
		else 
			libera_pepo_w := true;
		end if;
	end if;
	 
	if (ie_opcao_p = 'D') or (libera_pepo_w) then 
		param_158_w	:= obter_valor_param_usuario(872, 158, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w);
		param_323_w := obter_valor_param_usuario(872, 323, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w);
		 
		if (coalesce(param_158_w,'N') = 'S') and (nr_seq_pepo_p > 0) then 
			open c01(nr_seq_pepo_p);
			loop 
			fetch c01 into 
				nr_cirurgia_w, 
				nr_prescricao_w, 
				dt_liberacao_w;
			EXIT WHEN NOT FOUND; /* apply on c01 */
			begin 
				CALL LIBERAR_PEPO(nr_cirurgia_w, ie_opcao_p, nm_usuario_p, nr_seq_pepo_p);
					 
				if (coalesce(param_323_w,'N') = 'S') 
				and (ie_opcao_p = 'L') 
				and (nr_cirurgia_w > 0) 
				and (nr_prescricao_w > 0) 
				and (dt_liberacao_w IS NOT NULL AND dt_liberacao_w::text <> '') then 
					CALL LIBERAR_PEPOB_JS(nr_cirurgia_w, nr_prescricao_w, cd_local_estoque_p, nm_usuario_p);
				end if;
			end;
			end loop;
			close c01;
			 
			cd_retorno_p := 2;
		else 
			CALL LIBERAR_PEPO(nr_cirurgia_p, ie_opcao_p, nm_usuario_p);
    
			if (coalesce(param_323_w,'N') = 'S') 
			and (nr_prescricao_p > 0) 
			and (nr_cirurgia_p > 0) 
			and (coalesce(dt_liberacao_p::text, '') = '') then 
				CALL LIBERAR_PEPOB_JS(nr_cirurgia_p, nr_prescricao_p, cd_local_estoque_p, nm_usuario_p);
			end if;
			 
			cd_retorno_p := 2;
		end if;
	end if;
	 
	if (ie_opcao_p = 'D') then 
		cd_retorno_p := 1;
	end if;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE liberar_desfazer_pepo_html ( nr_cirurgia_p bigint default null, nm_usuario_p text DEFAULT NULL, nr_seq_pepo_p bigint default null, ie_opcao_p text DEFAULT NULL, ie_retorno_wdlg_p text DEFAULT NULL, cd_local_estoque_p bigint DEFAULT NULL, nr_prescricao_p bigint DEFAULT NULL, dt_liberacao_p timestamp default null, cd_retorno_p INOUT bigint  DEFAULT NULL) FROM PUBLIC;

