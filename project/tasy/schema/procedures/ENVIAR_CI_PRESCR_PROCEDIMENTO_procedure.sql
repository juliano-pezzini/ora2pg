-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE enviar_ci_prescr_procedimento (nr_prescricao_p bigint, cd_estabelecimento_p bigint, cd_perfil_p bigint, nm_usuario_p text) AS $body$
DECLARE


ds_titulo_w		varchar(255);
nm_paciente_w		varchar(255);
nm_medico_w		varchar(255);
nm_medico_exec_w	varchar(255);
ds_comunicado_w		varchar(4000);
ds_comunic_w		varchar(4000);
ds_procedimento_w	varchar(4000);
nm_usuario_destino_w	varchar(255);
cd_medico_atend_w	varchar(255);
ds_lista_usuario_destino_w	varchar(1000);
ds_observacao_w		varchar(255);
ds_dado_clinico_w	varchar(255);
cd_prescritor_w		varchar(255);
ds_unidade_w		varchar(255);
ie_enviar_email_w	varchar(5);
cd_procedimento_w	bigint;
nr_atendimento_w	bigint;
ds_email_w		varchar(4000);
cd_perfil_w		varchar(4000);
cd_setor_envio_w    varchar(4000);
ds_email_usuario_w	varchar(4000);
ds_final_w		varchar(4000);
nr_sequencia_w		bigint;
nr_sequencia_ww		bigint;
cd_area_procedimento_w	bigint;
cd_perfil_destino_w	bigint;
cd_setor_destino_w	bigint;
cd_especialidade_w	bigint;
cd_grupo_proc_w		bigint;
cd_setor_w		bigint;
ie_origem_proced_w	bigint;
ie_tipo_atendimento_w	bigint;
nr_seq_regra_w		bigint;
ie_enviar_prescritor_w	varchar(1);
cd_medico_w		varchar(50);
NM_USUARIO_MEDICO_W	varchar(50);
cd_pessoa_fisica_w	varchar(50);
ie_enviar_executor_w	varchar(1);
nr_seq_comunic_w	bigint;
nr_seq_exame_w		bigint;
cd_convenio_w		integer;
nr_seq_proc_interno_w	bigint;
ds_quebra_w		varchar(2) := chr(13) || chr(10);

cd_intervalo_w		varchar(30);
ds_horarios_w		varchar(255);
ds_intervalo_w		varchar(255);
ds_setor_exec_w		varchar(255);
ds_setor_prescr_w	varchar(255);
dt_liberacao_w		timestamp;
dt_prescricao_w		timestamp;
dt_prev_exec_w		timestamp;
qt_procedimento_w	double precision;
ds_convenio_w		varchar(255);
cd_protocolo_w		bigint;
nr_seq_protocolo_w	bigint;
cd_medico_exec_w	bigint;
qt_exames_w		bigint;
qt_prescr_w		bigint;
ie_medico_responsavel_w	varchar(1);
ie_aplica_prescr_eup_w	varchar(1);

c01 CURSOR FOR
SELECT	a.nr_sequencia,
	a.ds_titulo,
	a.ds_comunicado,
	a.cd_area_procedimento,
	a.cd_especialidade,
	a.cd_grupo_proc,
	a.cd_procedimento,
	a.ie_origem_proced,
	a.ie_tipo_atendimento,
	coalesce(a.ie_enviar_prescritor,'S'),
	a.nr_seq_proc_interno,
	a.cd_protocolo,
	a.nr_seq_protocolo,
	coalesce(a.ie_enviar_executor,'S'),
	a.cd_pessoa_fisica,
	a.nr_seq_exame,
	a.ie_enviar_email,
	a.qt_exames,
	coalesce(a.ie_medico_responsavel,'S'),
	coalesce(a.ie_aplica_prescr_eup,'S')
from	rep_regra_envio_ci_proced a
where	obter_se_envia_ci_setor(a.nr_sequencia, cd_setor_w) = 'S'
and		((coalesce(cd_convenio::text, '') = '') or (cd_convenio = cd_convenio_w))
and		((coalesce(cd_perfil::text, '') = '') or (cd_perfil = obter_Perfil_ativo))
and		coalesce(cd_estabelecimento,coalesce(cd_estabelecimento_p,0))	= coalesce(cd_estabelecimento_p,0)
and	coalesce(ie_job,'N') = 'N';

c02 CURSOR FOR
SELECT	b.cd_perfil
from	rep_perfil_ci_proced b
where	b.nr_seq_regra	= nr_sequencia_ww;

c03 CURSOR FOR
SELECT	b.cd_setor_recebimento
from	rep_regra_ci_proced_setor b
where	b.nr_seq_regra	= nr_sequencia_ww
and    (b.cd_setor_recebimento IS NOT NULL AND b.cd_setor_recebimento::text <> '');

c14 CURSOR FOR
SELECT	substr(a.DS_PROCEDIMENTO,1,80),
	substr(c.ds_observacao,1,255),
	substr(c.ds_dado_clinico,1,255),
	c.cd_procedimento,
	coalesce(obter_desc_intervalo_prescr(c.cd_intervalo),c.cd_intervalo),
	obter_desc_intervalo(c.cd_intervalo),
	substr(c.ds_horarios,1,255),
	c.dt_prev_execucao,
	c.qt_procedimento,
	substr(obter_nome_setor(c.cd_setor_atendimento),1,80),
	c.cd_medico_exec
from	prescr_medica p,
	estrutura_procedimento_v a,
	prescr_procedimento c
where	a.cd_procedimento	= c.cd_procedimento
and	a.ie_origem_proced	= c.ie_origem_proced
and	c.nr_prescricao		= p.nr_prescricao
and	c.nr_prescricao		= nr_prescricao_p
and	((coalesce(cd_procedimento_w::text, '') = '') or (c.cd_procedimento	= cd_procedimento_w))
and	((coalesce(ie_origem_proced_w::text, '') = '') or (c.ie_origem_proced	= ie_origem_proced_w) or (coalesce(cd_procedimento_w::text, '') = ''))
and	((coalesce(cd_grupo_proc_w::text, '') = '') or (a.cd_grupo_proc = cd_grupo_proc_w))
and	((coalesce(cd_area_procedimento_w::text, '') = '') or (a.cd_area_procedimento = cd_area_procedimento_w))
and	((p.cd_prescritor = cd_pessoa_fisica_w) or (coalesce(cd_pessoa_fisica_w::text, '') = ''))
and	((coalesce(cd_especialidade_w::text, '') = '') or (a.cd_especialidade = cd_especialidade_w))
and	((coalesce(nr_seq_proc_interno_w::text, '') = '') or (c.nr_seq_proc_interno	= nr_seq_proc_interno_w))
and	((c.nr_seq_exame	= nr_seq_exame_w) or (coalesce(nr_seq_exame_w::text, '') = ''))
and	((coalesce(ie_tipo_atendimento_w::text, '') = '') or (obter_tipo_atendimento(obter_atendimento_prescr(nr_prescricao_p)) = ie_tipo_atendimento_w))
and	((coalesce(cd_protocolo_w::text, '') = '') or (p.cd_protocolo = cd_protocolo_w))
and	((ie_aplica_prescr_eup_w = 'S') or (coalesce(p.cd_funcao_origem,924) <> 916))
and	((coalesce(nr_seq_protocolo_w::text, '') = '') or (p.nr_seq_protocolo = nr_seq_protocolo_w));

c15 CURSOR FOR
SELECT	b.nm_usuario_regra
from	rep_regra_envio_ci_proced a,
	rep_usuario_ci_proced b
where	a.nr_sequencia	= b.nr_seq_regra
and	b.nr_seq_regra	= nr_sequencia_ww
--and	    nvl(a.ie_medico_responsavel,'S') = 'S'
and	obter_se_envia_ci_setor(a.nr_sequencia, cd_setor_w) = 'S';


BEGIN

select	min(nr_sequencia)
into STRICT	nr_sequencia_w
from	comunic_interna_classif
where	ie_tipo	= 'F';

select	max(substr(obter_nome_pf(b.cd_pessoa_fisica),0,255)),
	max(substr(obter_nome_pf(c.cd_pessoa_fisica),0,255)),
	max(a.cd_setor_atendimento),
	max(a.nr_atendimento),
	max(obter_unidade_atendimento(a.nr_atendimento,'A','U')),
	max(a.dt_prescricao),
	max(coalesce(a.dt_liberacao_medico,a.dt_liberacao)),
	max(obter_nome_setor(a.cd_setor_atendimento)),
	max(a.cd_medico),
	max(obter_convenio_Atendimento(a.nr_atendimento))
into STRICT	nm_paciente_w,
	nm_medico_w,
	cd_setor_w,
	nr_atendimento_w,
	ds_unidade_w,
	dt_prescricao_w,
	dt_liberacao_w,
	ds_setor_prescr_w,
	cd_medico_w,
	cd_convenio_w
from	pessoa_fisica c,
		pessoa_fisica b,
		prescr_medica a
where	a.cd_prescritor		= c.cd_pessoa_fisica
and		a.cd_pessoa_fisica = b.cd_pessoa_fisica
and		a.nr_prescricao	= nr_prescricao_p;

if (cd_convenio_w > 0) then
	ds_convenio_w	:= substr(obter_desc_convenio(cd_convenio_w),1,100);
end if;


open c01;
loop
fetch c01 into
	nr_sequencia_ww,
	ds_titulo_w,
	ds_comunic_w,
	cd_area_procedimento_w,
	cd_especialidade_w,
	cd_grupo_proc_w,
	cd_procedimento_w,
	ie_origem_proced_w,
	ie_tipo_atendimento_w,
	ie_enviar_prescritor_w,
	nr_seq_proc_interno_w,
	cd_protocolo_w,
	nr_seq_protocolo_w,
	ie_enviar_executor_w,
	cd_pessoa_fisica_w,
	nr_seq_exame_w,
	ie_enviar_email_w,
	qt_exames_w,
	ie_medico_responsavel_w,
	ie_aplica_prescr_eup_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	ds_comunicado_w := null;

	if (coalesce(qt_exames_w,0) > 0) then
		select	count(*)
		into STRICT	qt_prescr_w
		from	prescr_medica p,
			estrutura_procedimento_v a,
			prescr_procedimento c
		where	a.cd_procedimento	= c.cd_procedimento
		and	a.ie_origem_proced	= c.ie_origem_proced
		and	c.nr_prescricao		= p.nr_prescricao
		and 	PKG_DATE_UTILS.start_of(c.dt_prev_execucao,'month',0) = PKG_DATE_UTILS.start_of(clock_timestamp(),'month',0)
		and	((coalesce(cd_procedimento_w::text, '') = '') or (c.cd_procedimento	= cd_procedimento_w))
		and	((coalesce(ie_origem_proced_w::text, '') = '') or (c.ie_origem_proced	= ie_origem_proced_w) or (coalesce(cd_procedimento_w::text, '') = ''))
		and	((coalesce(cd_grupo_proc_w::text, '') = '') or (a.cd_grupo_proc = cd_grupo_proc_w))
		and	((coalesce(cd_area_procedimento_w::text, '') = '') or (a.cd_area_procedimento = cd_area_procedimento_w))
		and	((p.cd_prescritor = cd_pessoa_fisica_w) or (coalesce(cd_pessoa_fisica_w::text, '') = ''))
		and	((coalesce(cd_especialidade_w::text, '') = '') or (a.cd_especialidade = cd_especialidade_w))
		and	((coalesce(nr_seq_proc_interno_w::text, '') = '') or (c.nr_seq_proc_interno	= nr_seq_proc_interno_w))
		and	((c.nr_seq_exame	= nr_seq_exame_w) or (coalesce(nr_seq_exame_w::text, '') = ''))
		and	((coalesce(ie_tipo_atendimento_w::text, '') = '') or (obter_tipo_atendimento(obter_atendimento_prescr(nr_prescricao_p)) = ie_tipo_atendimento_w))
		and	((coalesce(cd_protocolo_w::text, '') = '') or (p.cd_protocolo = cd_protocolo_w))
		and	((ie_aplica_prescr_eup_w = 'S') or (coalesce(p.cd_funcao_origem,924) <> 916))
		and	((coalesce(nr_seq_protocolo_w::text, '') = '') or (p.nr_seq_protocolo = nr_seq_protocolo_w));
	end if;

	if (coalesce(qt_exames_w,0) = 0) or (coalesce(qt_exames_w,0) < coalesce(qt_prescr_w,0)) then

		open c14;
		loop
		fetch c14 into
			ds_procedimento_w,
			ds_observacao_w,
			ds_dado_clinico_w,
			cd_procedimento_w,
			cd_intervalo_w,
			ds_intervalo_w,
			ds_horarios_w,
			dt_prev_exec_w,
			qt_procedimento_w,
			ds_setor_exec_w,
			cd_medico_exec_w;
		EXIT WHEN NOT FOUND; /* apply on c14 */
			if (ds_comunicado_w IS NOT NULL AND ds_comunicado_w::text <> '') then
				ds_comunicado_w := substr(ds_comunicado_w || ds_quebra_w,1,4000);
			end if;
			--Procedimento
			ds_comunicado_w := substr(ds_comunicado_w || obter_desc_expressao(720319)||': ' || cd_procedimento_w ||  ' - ' || ds_procedimento_w || ds_quebra_w,1,4000);
      --Quantidade
			ds_comunicado_w := substr(ds_comunicado_w || obter_desc_expressao(297049)||':   ' || qt_procedimento_w || ds_quebra_w,1,4000);

			if (dt_prev_exec_w IS NOT NULL AND dt_prev_exec_w::text <> '') then
      --Data Prevista execução
				ds_comunicado_w := substr(ds_comunicado_w || obter_desc_expressao(287132)||':   ' || PKG_DATE_FORMATERS.TO_VARCHAR(dt_prev_exec_w,'timestamp', cd_estabelecimento_p, nm_usuario_p) || ds_quebra_w,1,4000);
			end if;

			if (cd_medico_exec_w IS NOT NULL AND cd_medico_exec_w::text <> '') then
      --Médico executor
				ds_comunicado_w	:= substr(ds_comunicado_w || obter_desc_expressao(722393)||': ' || substr(obter_nome_pf(cd_medico_exec_w),1,70) || ds_quebra_w,1,4000);
			end if;

			if ((coalesce(cd_intervalo_w, ds_intervalo_w) IS NOT NULL AND (coalesce(cd_intervalo_w, ds_intervalo_w))::text <> '')) then
      --Intervalo
				ds_comunicado_w := substr(ds_comunicado_w || obter_desc_expressao(292190)||':   ' || coalesce(cd_intervalo_w, ds_intervalo_w) || ds_quebra_w,1,4000);
			end if;

			if (ds_horarios_w IS NOT NULL AND ds_horarios_w::text <> '') then
      --Horários
				ds_comunicado_w := substr(ds_comunicado_w || obter_desc_expressao(291449)||':   ' || ds_horarios_w || ds_quebra_w,1,4000);
			end if;

			if (ds_setor_exec_w IS NOT NULL AND ds_setor_exec_w::text <> '') then
      --Setor de execução
				ds_comunicado_w := substr(ds_comunicado_w || obter_desc_expressao(298393)||':   ' || ds_setor_exec_w || ds_quebra_w,1,4000);
			end if;

			if (ds_observacao_w IS NOT NULL AND ds_observacao_w::text <> '') then
      --Observação
				ds_comunicado_w	:= substr(ds_comunicado_w || obter_desc_expressao(667998)||': ' || ds_observacao_w|| ds_quebra_w,1,4000);
			end if;

			if (ds_dado_clinico_w IS NOT NULL AND ds_dado_clinico_w::text <> '') then
      --Indicação clínica
				ds_comunicado_w	:= substr(ds_comunicado_w || obter_desc_expressao(291841)||': ' || ds_dado_clinico_w|| ds_quebra_w,1,4000);
			end if;

			if (ie_enviar_executor_w = 'S') and (cd_medico_exec_w IS NOT NULL AND cd_medico_exec_w::text <> '') then
				select	max(nm_usuario)
				into STRICT	nm_usuario_destino_w
				from	usuario
				where	cd_pessoa_fisica = cd_medico_exec_w
				and		coalesce(ie_situacao,'A') = 'A';

				if (ds_lista_usuario_destino_w IS NOT NULL AND ds_lista_usuario_destino_w::text <> '') then
					ds_lista_usuario_destino_w := substr(ds_lista_usuario_destino_w || ',',1,1000);
				end if;

				ds_lista_usuario_destino_w := substr(ds_lista_usuario_destino_w || nm_usuario_destino_w,1,1000);

			end if;
		end loop;
		close C14;
	end if;

	cd_perfil_w := null;
	open c02;
	loop
	fetch c02 into
		cd_perfil_destino_w;
	EXIT WHEN NOT FOUND; /* apply on c02 */
		if (cd_perfil_w IS NOT NULL AND cd_perfil_w::text <> '') or (cd_perfil_w <> '') then
			cd_perfil_w := cd_perfil_w || ',';
		end if;

		cd_perfil_w := substr(cd_perfil_w || cd_perfil_destino_w,1,1000);

	end loop;
	close c02;

	cd_setor_envio_w := null;
	open c03;
	loop
	fetch c03 into
		cd_setor_destino_w;
	EXIT WHEN NOT FOUND; /* apply on c03 */
		if (cd_setor_envio_w IS NOT NULL AND cd_setor_envio_w::text <> '') or (cd_setor_envio_w <> '') then
			cd_setor_envio_w := cd_setor_envio_w || ',';
		end if;

		cd_setor_envio_w := substr(cd_setor_envio_w || cd_setor_destino_w,1,1000);

	end loop;
	close c03;


	if (ds_comunicado_w IS NOT NULL AND ds_comunicado_w::text <> '') then

		open C15;
		loop
		fetch C15 into
			nm_usuario_destino_w;
		EXIT WHEN NOT FOUND; /* apply on C15 */
			if (ie_enviar_prescritor_w = 'S') or (nm_usuario_destino_w <> nm_usuario_P) then
				if (ds_lista_usuario_destino_w IS NOT NULL AND ds_lista_usuario_destino_w::text <> '') then
					ds_lista_usuario_destino_w := substr(ds_lista_usuario_destino_w || ',',1,1000);
				end if;

				ds_lista_usuario_destino_w := substr(ds_lista_usuario_destino_w || nm_usuario_destino_w,1,1000);

				select	max(ds_email)
				into STRICT	ds_email_usuario_w
				from	usuario
				where	substr(obter_se_email_valido(ds_email),1,1) = 'S'
				and	upper(nm_usuario) = upper(nm_usuario_destino_w);

				if (ds_email_usuario_w IS NOT NULL AND ds_email_usuario_w::text <> '') then
					if (ds_email_w IS NOT NULL AND ds_email_w::text <> '') then
						ds_email_w	:= ds_email_usuario_w || ';' || ds_email_w;
					else
						ds_email_w	:= ds_email_usuario_w;
					end if;
				end if;
			end if;
		end loop;
		close C15;

		select	max(cd_pessoa_fisica)
		into STRICT	cd_prescritor_w
		from	usuario
		where	nm_usuario	= nm_usuario_p;

		if (cd_medico_w <> cd_prescritor_w) and (ie_enviar_prescritor_w = 'S') then
			select	max(nm_usuario)
			into STRICT	nm_usuario_medico_w
			from	usuario
			where	cd_pessoa_fisica	= cd_medico_w;

			if (nm_usuario_medico_w IS NOT NULL AND nm_usuario_medico_w::text <> '') then
				if (ds_lista_usuario_destino_w IS NOT NULL AND ds_lista_usuario_destino_w::text <> '') then
					ds_lista_usuario_destino_w := substr(ds_lista_usuario_destino_w || ',',1,1000);
				end if;

				ds_lista_usuario_destino_w := substr(ds_lista_usuario_destino_w || nm_usuario_medico_w,1,1000);
			end if;
		end if;

		if (ie_medico_responsavel_w = 'S') then
			select	max(substr(Obter_medico_resp_atend(nr_atendimento_w,'C'),1,80))
			into STRICT	cd_medico_atend_w
			;

			if (cd_medico_atend_w <> cd_medico_w) then
				select	max(nm_usuario)
				into STRICT	nm_usuario_medico_w
				from	usuario
				where	cd_pessoa_fisica	= cd_medico_atend_w;

				if (ie_enviar_prescritor_w = 'S') or (nm_usuario_medico_w <> nm_usuario_P) then
					if (nm_usuario_medico_w IS NOT NULL AND nm_usuario_medico_w::text <> '') then
						if (ds_lista_usuario_destino_w IS NOT NULL AND ds_lista_usuario_destino_w::text <> '') then
							ds_lista_usuario_destino_w := substr(ds_lista_usuario_destino_w || ',',1,1000);
						end if;

						ds_lista_usuario_destino_w := substr(ds_lista_usuario_destino_w || nm_usuario_medico_w,1,1000);
					end if;
				end if;
			end if;
		end if;

		ds_comunic_w	:=
          --Prescrição
          obter_desc_expressao(296208)||': ' || nr_prescricao_p || ds_quebra_W ||
          --Atendimento
					obter_desc_expressao(283863)||': ' || nr_atendimento_w || ds_quebra_W ||
          --Paciente
					obter_desc_expressao(295156)||': ' || nm_paciente_w || ds_quebra_W ||
          --Setor da prescrição
					obter_desc_expressao(298386)||': ' || ds_setor_prescr_w || ds_quebra_W ||
          --Leito do paciente
					obter_desc_expressao(345228)||': ' || ds_unidade_w || ds_quebra_W ||
          --Convênio
					obter_desc_expressao(286193)||': '|| ds_convenio_w || ds_quebra_w ||
          --Dt Prescrição
					obter_desc_expressao(335718)||':' ||PKG_DATE_FORMATERS.TO_VARCHAR(dt_prescricao_W,'timestamp', cd_estabelecimento_p, nm_usuario_p) || ds_quebra_W ||
          --Dt Liberação
					obter_desc_expressao(287026)||':' ||PKG_DATE_FORMATERS.TO_VARCHAR(dt_liberacao_w,'timestamp', cd_estabelecimento_p, nm_usuario_p) || ds_quebra_W ||
          --Prescritor
					obter_desc_expressao(296217)||': ' || nm_medico_w || ds_quebra_W|| ds_quebra_W ||
					ds_comunic_w;

		if (ds_titulo_w IS NOT NULL AND ds_titulo_w::text <> '') then

			if (ie_enviar_email_w = 'S') and (coalesce(ds_email_w,'X') <> 'X') then
				CALL enviar_email(	ds_titulo_w,
						ds_comunic_w,
						null,
						ds_email_w,
						nm_usuario_p,
						'M');
			end if;

			select	nextval('comunic_interna_seq')
			into STRICT	nr_seq_comunic_w
			;

			ds_final_w	:= substr(ds_comunic_w || ds_quebra_w || ds_quebra_w|| ds_comunicado_w,1,3000);

			insert	into comunic_interna(
				dt_comunicado,
				ds_titulo,
				ds_comunicado,
				nm_usuario,
				nm_usuario_destino,
				dt_atualizacao,
				ie_geral,
				ie_gerencial,
				ds_perfil_adicional,
				ds_setor_adicional,
				nr_sequencia,
				nr_seq_classif,
				dt_liberacao)
			values (
				clock_timestamp(),
				ds_titulo_w,
				ds_final_w,
				nm_usuario_p,
				ds_lista_usuario_destino_w,
				clock_timestamp(),
				'N',
				'N',
				cd_perfil_w,
				cd_setor_envio_w,
				nr_seq_comunic_w,
				nr_sequencia_w,
				clock_timestamp());

			if (coalesce(wheb_usuario_pck.get_ie_commit, 'S') = 'S') then commit; end if;

			if (ie_enviar_prescritor_w = 'N') then
				insert into comunic_interna_lida
				values (	nr_seq_comunic_w,
					nm_usuario_p,
					clock_timestamp());
			end if;

			if (coalesce(wheb_usuario_pck.get_ie_commit, 'S') = 'S') then commit; end if;

		end if;
		ds_lista_usuario_destino_w := null;
	end if;

end loop;
close C01;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE enviar_ci_prescr_procedimento (nr_prescricao_p bigint, cd_estabelecimento_p bigint, cd_perfil_p bigint, nm_usuario_p text) FROM PUBLIC;

