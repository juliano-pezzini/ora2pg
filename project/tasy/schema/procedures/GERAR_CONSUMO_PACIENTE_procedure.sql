-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_consumo_paciente ( nr_atendimento_p bigint, cd_material_p bigint, dt_atendimento_p timestamp, cd_acao_p text, cd_local_estoque_p bigint, qt_material_p bigint, cd_setor_atendimento_p bigint, cd_unidade_medida_p text, nm_usuario_p text, ie_inserir_excluir text, nr_prescricao_p bigint, nr_seq_prescricao_p bigint, cd_cgc_fornec_p text, nr_devolucao_p bigint, nr_seq_lote_fornec_p bigint) AS $body$
DECLARE


cd_estabelecimento_w 	  	smallint;
nr_movimento_estoque_w    	bigint;
cd_operacao_cons_paciente_w 	smallint;
cd_operacao_cons_consignado_w	smallint;
cd_operacao_devol_paciente_w	smallint;
cd_operacao_dev_consignado_w	smallint;
cd_acao_w	  		varchar(1);
qt_minimo_multiplo_solic_w 	double precision;
ie_consignado_w			varchar(01);
nr_documento_w			bigint;
nr_seq_doc_w			bigint;
ie_forma_operacao_devolucao_w	varchar(1);
cd_centro_custo_w		integer;
ie_tipo_conta_w			smallint;
cd_conta_contabil_w		varchar(20);
ds_lote_fornec_w		varchar(20);
ie_passagem_direta_cc_w		varchar(1);
dt_validade_w			timestamp;


BEGIN

if (ie_inserir_excluir   = 'I') then
	cd_acao_w 		:= cd_acao_p;
else
	if (cd_acao_p = '1') then
		cd_acao_w 	:= '2';
	else
		cd_acao_w	:= '1';
	end if;
end if;

select	qt_minimo_multiplo_solic
into STRICT	qt_minimo_multiplo_solic_w
from	material
where	cd_material = cd_material_p;

select	cd_estabelecimento
into STRICT	cd_estabelecimento_w
from	atendimento_paciente
where	nr_atendimento = nr_atendimento_p;

ie_passagem_direta_cc_w := obter_param_usuario(42, 101, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_passagem_direta_cc_w);

select	cd_operacao_cons_consignado,
	cd_operacao_cons_paciente,
	cd_operacao_devol_paciente,
	cd_operacao_dev_consignado,
	ie_forma_operacao_devolucao
into STRICT	cd_operacao_cons_consignado_w,
	cd_operacao_cons_paciente_w,
	cd_operacao_devol_paciente_w,
	cd_operacao_dev_consignado_w,
	ie_forma_operacao_devolucao_w
from	parametro_estoque
where	cd_estabelecimento	= cd_estabelecimento_w;

if (coalesce(nr_seq_lote_fornec_p,0) > 0) then
	select	ds_lote_fornec,
		dt_validade
	into STRICT	ds_lote_fornec_w,
		dt_validade_w
	from	material_lote_fornec
	where	nr_sequencia = nr_seq_lote_fornec_p;
end if;

select	ie_consignado
into STRICT	ie_consignado_w
from	material
where	cd_material	= cd_material_p;

if (ie_consignado_w <> '0') then
	if (ie_consignado_w = '1') or
		((ie_consignado_w = '2') and (coalesce(cd_cgc_fornec_p,'X') <> 'X')) then
		cd_operacao_cons_paciente_w	:= cd_operacao_cons_consignado_w;
	end if;
end if;


/*fabio os35814 - tratamento para gerar o movimento com operação devolução e acao inclusao*/

if (ie_forma_operacao_devolucao_w = 'D') then
	cd_operacao_cons_paciente_w	:= cd_operacao_devol_paciente_w;
	cd_acao_w			:= '1';
	if (ie_consignado_w <> '0') then
		if (ie_consignado_w = '1') or
			((ie_consignado_w = '2') and (coalesce(cd_cgc_fornec_p,'X') <> 'X')) then
			cd_operacao_cons_paciente_w	:= cd_operacao_dev_consignado_w;
		end if;
	end if;
end if;


if (coalesce(nr_prescricao_p::text, '') = '') then
	nr_documento_w	:= nr_atendimento_p;
	nr_seq_doc_w		:= 999;
else
	nr_documento_w	:= nr_prescricao_p;
	nr_seq_doc_w		:= coalesce(nr_seq_prescricao_p, 888888);
end if;


/*Mesmo tratamento de acaba fazendo na trigger do movimento de estoque
Se o tipo = 3*/
if (coalesce(cd_setor_atendimento_p, 0) > 0) then
	select	max(cd_centro_custo)
	into STRICT	cd_centro_custo_w
	from 	setor_atendimento
	where 	cd_setor_atendimento = cd_setor_atendimento_p;
end if;

if (coalesce(ie_passagem_direta_cc_w,'X') <> 'S') then
	ie_tipo_conta_w	:= 3;
	if (coalesce(cd_centro_custo_w,0) > 0) then
		ie_tipo_conta_w	:= 2;
	end if;
else
	ie_tipo_conta_w	:= 2;
	if (coalesce(cd_centro_custo_w,0) > 0) then
		ie_tipo_conta_w := 3;
	end if;
end if;

SELECT * FROM Define_Conta_Material(
		cd_estabelecimento_w, cd_material_p, ie_tipo_conta_w, null, cd_setor_atendimento_p, null, null, null, null, null, cd_local_estoque_p, cd_operacao_cons_paciente_w, dt_atendimento_p, cd_conta_contabil_w, cd_centro_custo_w, null) INTO STRICT cd_conta_contabil_w, cd_centro_custo_w;


select	nextval('movimento_estoque_seq')
into STRICT	nr_movimento_estoque_w
;

if (coalesce(cd_operacao_cons_paciente_w::text, '') = '') then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(220151);
end if;

insert	into movimento_estoque(
	nr_movimento_estoque,
	cd_estabelecimento,
	cd_local_estoque,
	dt_movimento_estoque,
	cd_operacao_estoque,
	cd_acao,
	cd_material,
	dt_mesano_referencia,
	qt_movimento,
	dt_atualizacao,
	nm_usuario,
	ie_origem_documento,
	nr_documento,
	nr_sequencia_item_docto,
	cd_unidade_medida_estoque,
	cd_setor_atendimento,
	qt_estoque,
	cd_unidade_med_mov,
	cd_fornecedor,
	ds_observacao,
	nr_atendimento,
	nr_prescricao,
	nr_seq_tab_orig,
	cd_conta_contabil,
	cd_centro_custo,
	nr_seq_lote_fornec,
	cd_lote_fabricacao,
	dt_validade)
values ( nr_movimento_estoque_w,
	cd_estabelecimento_w,
	cd_local_estoque_p,
	dt_atendimento_p,
	cd_operacao_cons_paciente_w,
	cd_acao_w,
	cd_material_p,
	dt_atendimento_p,
	qt_material_p,
	clock_timestamp(),
	nm_usuario_p,
	'3',
	nr_documento_w,
	nr_seq_doc_w,
	cd_unidade_medida_p,
	cd_setor_atendimento_p,
	qt_material_p,
	cd_unidade_medida_p,
	cd_cgc_fornec_p,
	'Gerar_Consumo_Paciente ' || nr_devolucao_p,
	nr_atendimento_p,
	nr_prescricao_p,
	nr_devolucao_p,
	cd_conta_contabil_w,
	cd_centro_custo_w,
	CASE WHEN nr_seq_lote_fornec_p=0 THEN null  ELSE nr_seq_lote_fornec_p END ,
	ds_lote_fornec_w,
	dt_validade_w);

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_consumo_paciente ( nr_atendimento_p bigint, cd_material_p bigint, dt_atendimento_p timestamp, cd_acao_p text, cd_local_estoque_p bigint, qt_material_p bigint, cd_setor_atendimento_p bigint, cd_unidade_medida_p text, nm_usuario_p text, ie_inserir_excluir text, nr_prescricao_p bigint, nr_seq_prescricao_p bigint, cd_cgc_fornec_p text, nr_devolucao_p bigint, nr_seq_lote_fornec_p bigint) FROM PUBLIC;

