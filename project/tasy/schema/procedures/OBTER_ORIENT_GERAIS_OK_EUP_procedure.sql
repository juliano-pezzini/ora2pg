-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE obter_orient_gerais_ok_eup (nr_prescricao_p bigint, nr_seq_exame_p INOUT bigint, nr_seq_exame_hint_p bigint, cd_material_exame_p text, cd_estabelecimento_p bigint, nm_usuario_p text, nr_atendimento_p bigint, cd_exame_p text, ie_tipo_atendimento_p bigint, dt_servico_p timestamp, dt_conta_p timestamp default null, nr_seq_material_p bigint default null, ds_orientacao_tecnica_p INOUT text DEFAULT NULL, ds_orient_tec_p INOUT text DEFAULT NULL, ds_orient_pac_p INOUT text DEFAULT NULL, ds_orient_medic_p INOUT text DEFAULT NULL, ds_orientacao_tec_p INOUT text DEFAULT NULL, ds_orientacao_usu_p INOUT text DEFAULT NULL, ds_orientacao_medic_p INOUT text DEFAULT NULL, nr_seq_origem_p INOUT bigint DEFAULT NULL, vl_procedimento_p INOUT bigint DEFAULT NULL, vl_custo_operacional_p INOUT bigint DEFAULT NULL, vl_anestesista_p INOUT bigint DEFAULT NULL, vl_medico_p INOUT bigint DEFAULT NULL, vl_auxiliares_p INOUT bigint DEFAULT NULL, vl_materiais_p INOUT bigint DEFAULT NULL, vl_pto_procedimento_p INOUT bigint DEFAULT NULL, vl_pto_custo_operac_p INOUT bigint DEFAULT NULL, vl_pto_anestesista_p INOUT bigint DEFAULT NULL, vl_pto_medico_p INOUT bigint DEFAULT NULL, vl_pto_auxiliares_p INOUT bigint DEFAULT NULL, vl_pto_materiais_p INOUT bigint DEFAULT NULL, qt_porte_anestesico_p INOUT bigint DEFAULT NULL, cd_edicao_amb_p INOUT bigint DEFAULT NULL, ie_valor_informado_p INOUT text DEFAULT NULL, nr_seq_ajuste_proc_p INOUT bigint DEFAULT NULL, vl_servico_p INOUT bigint DEFAULT NULL) AS $body$
DECLARE


qt_pontos_w			preco_amb.qt_pontuacao%type;
ie_classificacao_w		varchar(10);
cd_procedimento_w		bigint;
ie_origem_proced_w		bigint;
cd_convenio_w			bigint;
cd_categoria_w			bigint;
qt_orientacao_tecnica_w	bigint;
qt_consulta_w			bigint;


BEGIN

select 	count(a.ds_orientacao_tecnica)
into STRICT	qt_orientacao_tecnica_w
from   	exame_lab_material a,
		material_exame_lab b
where  	a.nr_seq_material 		= b.nr_sequencia
and    	a.nr_seq_exame 		= nr_seq_exame_p
and    	b.cd_material_exame  	= cd_material_exame_p;

if (qt_orientacao_tecnica_w > 0) then
	select 	trim(both a.ds_orientacao_tecnica)
	into STRICT	ds_orientacao_tecnica_p
	from   	exame_lab_material a,
			material_exame_lab b
	where  	a.nr_seq_material 		= b.nr_sequencia
	and    	a.nr_seq_exame 		= nr_seq_exame_p
	and    	b.cd_material_exame  	= cd_material_exame_p;
end if;

select  substr(obter_orientacao_exame_id_sexo(nr_seq_exame_p, nr_prescricao_p, cd_estabelecimento_p, 'S', 'N','N'), 1, 4000),
		substr(obter_orientacao_exame_id_sexo(nr_seq_exame_p, nr_prescricao_p, cd_estabelecimento_p, 'N', 'S','N'), 1, 4000),
		substr(obter_orientacao_exame_id_sexo(nr_seq_exame_p, nr_prescricao_p, cd_estabelecimento_p, 'N', 'N','S'), 1, 4000)
into STRICT	ds_orient_tec_p,
		ds_orient_pac_p,
		ds_orient_medic_p
;

select	Count(*)
into STRICT	qt_consulta_w
from    exame_laboratorio
where   nr_seq_exame = nr_seq_exame_hint_p;

if (qt_consulta_w > 0) then
	select	substr(ds_orientacao_tecnica,1,4000) ds_orientacao_tecnica,
			substr(ds_orientacao_usuario,1,4000) ds_orientacao_usuario,
			substr(ds_orientacao_medicamento,1,4000) ds_orientacao_medicamento
	into STRICT	ds_orientacao_tec_p,
			ds_orientacao_usu_p,
			ds_orientacao_medic_p
	from    exame_laboratorio
	where   nr_seq_exame = nr_seq_exame_hint_p;
end if;

select 	obter_dados_param_faturamento(cd_estabelecimento_p,'CONP') cd_convenio,
		obter_dados_param_faturamento(cd_estabelecimento_p,'CATP') cd_categoria
into STRICT	cd_convenio_w,
		cd_categoria_w
;

nr_seq_origem_p := obter_dados_categ_conv(nr_atendimento_p, 'OC');

SELECT * FROM Obter_Proc_Exame_Laborat(cd_exame_p, cd_convenio_w, cd_estabelecimento_p, cd_categoria_w, cd_procedimento_w, ie_origem_proced_w, nr_seq_exame_p, ie_tipo_atendimento_p, dt_conta_p, nr_seq_material_p) INTO STRICT cd_procedimento_w, ie_origem_proced_w, nr_seq_exame_p;

select	max(ie_classificacao)
into STRICT	ie_classificacao_w
from	procedimento
where	cd_procedimento = cd_procedimento_w
and	ie_origem_proced	= ie_origem_proced_w;

if (ie_classificacao_w = '1') then
	SELECT * FROM Define_Preco_Procedimento(cd_estabelecimento_p, cd_convenio_w, cd_categoria_w, dt_conta_p, cd_procedimento_w, null, null, null, null, null, null, nr_seq_exame_p, null, null, null, null, null, null, vl_procedimento_p, vl_custo_operacional_p, vl_anestesista_p, vl_medico_p, vl_auxiliares_p, vl_materiais_p, vl_pto_procedimento_p, vl_pto_custo_operac_p, vl_pto_anestesista_p, vl_pto_medico_p, vl_pto_auxiliares_p, vl_pto_materiais_p, qt_porte_anestesico_p, qt_pontos_w, cd_edicao_amb_p, ie_valor_informado_p, nr_seq_ajuste_proc_p, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null) INTO STRICT vl_procedimento_p, vl_custo_operacional_p, vl_anestesista_p, vl_medico_p, vl_auxiliares_p, vl_materiais_p, vl_pto_procedimento_p, vl_pto_custo_operac_p, vl_pto_anestesista_p, vl_pto_medico_p, vl_pto_auxiliares_p, vl_pto_materiais_p, qt_porte_anestesico_p, qt_pontos_w, cd_edicao_amb_p, ie_valor_informado_p, nr_seq_ajuste_proc_p;
else
	SELECT * FROM define_preco_servico(cd_estabelecimento_p, cd_convenio_w, cd_categoria_w, dt_servico_p, cd_procedimento_w, null, null, null, null, null, null, null, null, vl_servico_p, nr_seq_ajuste_proc_p, null, null, null, null, null, null, null, null, null, null, null, null, null, null) INTO STRICT vl_servico_p, nr_seq_ajuste_proc_p;
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE obter_orient_gerais_ok_eup (nr_prescricao_p bigint, nr_seq_exame_p INOUT bigint, nr_seq_exame_hint_p bigint, cd_material_exame_p text, cd_estabelecimento_p bigint, nm_usuario_p text, nr_atendimento_p bigint, cd_exame_p text, ie_tipo_atendimento_p bigint, dt_servico_p timestamp, dt_conta_p timestamp default null, nr_seq_material_p bigint default null, ds_orientacao_tecnica_p INOUT text DEFAULT NULL, ds_orient_tec_p INOUT text DEFAULT NULL, ds_orient_pac_p INOUT text DEFAULT NULL, ds_orient_medic_p INOUT text DEFAULT NULL, ds_orientacao_tec_p INOUT text DEFAULT NULL, ds_orientacao_usu_p INOUT text DEFAULT NULL, ds_orientacao_medic_p INOUT text DEFAULT NULL, nr_seq_origem_p INOUT bigint DEFAULT NULL, vl_procedimento_p INOUT bigint DEFAULT NULL, vl_custo_operacional_p INOUT bigint DEFAULT NULL, vl_anestesista_p INOUT bigint DEFAULT NULL, vl_medico_p INOUT bigint DEFAULT NULL, vl_auxiliares_p INOUT bigint DEFAULT NULL, vl_materiais_p INOUT bigint DEFAULT NULL, vl_pto_procedimento_p INOUT bigint DEFAULT NULL, vl_pto_custo_operac_p INOUT bigint DEFAULT NULL, vl_pto_anestesista_p INOUT bigint DEFAULT NULL, vl_pto_medico_p INOUT bigint DEFAULT NULL, vl_pto_auxiliares_p INOUT bigint DEFAULT NULL, vl_pto_materiais_p INOUT bigint DEFAULT NULL, qt_porte_anestesico_p INOUT bigint DEFAULT NULL, cd_edicao_amb_p INOUT bigint DEFAULT NULL, ie_valor_informado_p INOUT text DEFAULT NULL, nr_seq_ajuste_proc_p INOUT bigint DEFAULT NULL, vl_servico_p INOUT bigint DEFAULT NULL) FROM PUBLIC;

