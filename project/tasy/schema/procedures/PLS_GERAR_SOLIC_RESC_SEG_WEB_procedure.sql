-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_gerar_solic_resc_seg_web ( nr_seq_segurado_p bigint, nr_seq_causa_rescisao_p bigint, nr_ddi_celular_p text, nr_ddd_celular_p text, nr_telefone_celular_p text, nr_ddi_telefone_p text, nr_ddd_telefone_p text, nr_telefone_p text, ds_email_p text, nome_financ_p text, cpf_financ_p text, banco_financ_p bigint, agencia_financ_p text, agencia_dig_financ_p text, conta_financ_p text, conta_dig_financ_p text, nm_usuario_p text, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nr_seq_solicitacao_p INOUT bigint, nr_protocolo_atend_p INOUT bigint, ie_commit_p text default 'S', id_app_externo_p bigint DEFAULT NULL, ie_app_externo_p text DEFAULT NULL) AS $body$
DECLARE


--Procedure utilizada no portal do plano de saude
nr_seq_solicitacao_w		pls_solicitacao_rescisao.nr_sequencia%type;
nr_seq_contrato_w		pls_contrato.nr_sequencia%type;
nr_contrato_w			pls_contrato.nr_contrato%type;
nr_seq_intercambio_w		pls_intercambio.nr_sequencia%type;
nr_seq_protocolo_atend_w	pls_protocolo_atendimento.nr_sequencia%type;
nr_protocolo_atend_w		pls_protocolo_atendimento.nr_protocolo%type;
ds_observacao_w			varchar(150);
nr_seq_tipo_contato_w		pls_tp_contato_solic_resc.nr_sequencia%type;
cd_pessoa_fisica_w		pls_segurado.cd_pessoa_fisica%type;


BEGIN

select	a.cd_pessoa_fisica,
	a.nr_seq_contrato,
	(	select	max(x.nr_contrato)
		from	pls_contrato x
		where	x.nr_sequencia = a.nr_seq_contrato) nr_contrato,
	a.nr_seq_intercambio
into STRICT	cd_pessoa_fisica_w,
	nr_seq_contrato_w,
	nr_contrato_w,
	nr_seq_intercambio_w
from	pls_segurado a
where	a.nr_sequencia = nr_seq_segurado_p;

ds_observacao_w := wheb_mensagem_pck.get_texto(1120641); --SOLICITACAO DE RESCISAO GERADA PELO PORTAL WEB POR INICIATIVA DO BENEFICIARIO.
insert	into pls_solicitacao_rescisao(nr_sequencia,
	cd_estabelecimento,
	dt_atualizacao,
	dt_atualizacao_nrec,
	nm_usuario,
	nm_usuario_nrec,
	dt_solicitacao,
	ie_status,
	ie_origem_solicitacao,
	ie_forma_pedido,
	nr_contrato,
	nr_seq_contrato,
	nr_seq_intercambio,
	ie_rescindir_contrato,
	ds_observacao,
	nm_pessoa_devolucao,
	nr_cpf_devolucao,
	cd_banco,
	cd_agencia_bancaria,
	ie_digito_agencia,
	cd_conta,
	ie_digito_conta,
	id_app_externo,
	ie_app_externo)
values (nextval('pls_solicitacao_rescisao_seq'),
	cd_estabelecimento_p,
	clock_timestamp(),
	clock_timestamp(),
	nm_usuario_p,
	nm_usuario_p,
	clock_timestamp(),
	1, --Pendente de liberacao
	'P', --Portal web
	6, --Portal beneficiario
	nr_contrato_w,
	nr_seq_contrato_w,
	nr_seq_intercambio_w,
	'P',
	ds_observacao_w,
	nome_financ_p,
	cpf_financ_p,
	banco_financ_p,
	agencia_financ_p,
	agencia_dig_financ_p,
	conta_financ_p,
	conta_dig_financ_p,
	id_app_externo_p,
	ie_app_externo_p)
returning nr_sequencia into nr_seq_solicitacao_w;

--Gerar o protocolo de atendimento
SELECT * FROM pls_gravar_protocolo_atend('7', nr_seq_segurado_p, null, null, null, null, nr_seq_solicitacao_w, null, null, null, cd_estabelecimento_p, nm_usuario_p, nr_seq_protocolo_atend_w, nr_protocolo_atend_w) INTO STRICT nr_seq_protocolo_atend_w, nr_protocolo_atend_w;

update	pls_solicitacao_rescisao
set	nr_seq_protocolo_atend	= nr_seq_protocolo_atend_w
where	nr_sequencia		= nr_seq_solicitacao_w;

select	max(nr_sequencia)
into STRICT	nr_seq_tipo_contato_w
from	pls_tp_contato_solic_resc
where	ie_padrao = 'S'
and	ie_situacao = 'A';

if (cd_pessoa_fisica_w IS NOT NULL AND cd_pessoa_fisica_w::text <> '') and (nr_seq_tipo_contato_w IS NOT NULL AND nr_seq_tipo_contato_w::text <> '') then
	
	insert	into	pls_solic_resc_contato(	nr_sequencia, nr_seq_solicitacao, cd_pessoa_fisica, nr_seq_tipo_contato,
			dt_atualizacao, dt_atualizacao_nrec, nm_usuario, nm_usuario_nrec,
			nr_ddi_celular, nr_ddd_celular, nr_telefone_celular,
			nr_ddi_telefone, nr_ddd_telefone, nr_telefone,
			ds_email, ie_forma_envio)
		values (nextval('pls_solic_resc_contato_seq'), nr_seq_solicitacao_w, cd_pessoa_fisica_w, nr_seq_tipo_contato_w,
			clock_timestamp(), clock_timestamp(), nm_usuario_p, nm_usuario_p,
			nr_ddi_celular_p, nr_ddd_celular_p, nr_telefone_celular_p,
			nr_ddi_telefone_p, nr_ddd_telefone_p, nr_telefone_p,
			ds_email_p, '1'); --Solicitacao realizada no portal a forma de envio sera e-mail
end if;

--Gerar o contato da empresa
CALL pls_gerar_contato_resc_estip(nr_seq_solicitacao_w,'N',nm_usuario_p);

nr_protocolo_atend_p := nr_protocolo_atend_w;
nr_seq_solicitacao_p := nr_seq_solicitacao_w;

if (ie_commit_p = 'S') then
	commit;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_gerar_solic_resc_seg_web ( nr_seq_segurado_p bigint, nr_seq_causa_rescisao_p bigint, nr_ddi_celular_p text, nr_ddd_celular_p text, nr_telefone_celular_p text, nr_ddi_telefone_p text, nr_ddd_telefone_p text, nr_telefone_p text, ds_email_p text, nome_financ_p text, cpf_financ_p text, banco_financ_p bigint, agencia_financ_p text, agencia_dig_financ_p text, conta_financ_p text, conta_dig_financ_p text, nm_usuario_p text, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nr_seq_solicitacao_p INOUT bigint, nr_protocolo_atend_p INOUT bigint, ie_commit_p text default 'S', id_app_externo_p bigint DEFAULT NULL, ie_app_externo_p text DEFAULT NULL) FROM PUBLIC;

