-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';



CREATE TYPE reg_mes AS (	nr_seq_mes_ref	ctb_orc_cen_valor.nr_seq_mes_ref%type,
			vl_orcado	ctb_orc_cen_valor.vl_orcado%type);


CREATE OR REPLACE PROCEDURE ctb_gerar_planej_orc_rec ( nr_seq_planej_p ctb_orc_cenario.nr_sequencia%type, nm_usuario_p text) AS $body$
DECLARE

		
c_planej_receita CURSOR FOR
SELECT	a.cd_estabelecimento,
	a.cd_centro_custo,
	a.cd_conta_contabil,
	coalesce(sum(a.vl_planej_01),0) vl_planej_01,
	coalesce(sum(a.vl_planej_02),0) vl_planej_02,
	coalesce(sum(a.vl_planej_03),0) vl_planej_03,
	coalesce(sum(a.vl_planej_04),0) vl_planej_04,
	coalesce(sum(a.vl_planej_05),0) vl_planej_05,
	coalesce(sum(a.vl_planej_06),0) vl_planej_06,
	coalesce(sum(a.vl_planej_07),0) vl_planej_07,
	coalesce(sum(a.vl_planej_08),0) vl_planej_08,
	coalesce(sum(a.vl_planej_09),0) vl_planej_09,
	coalesce(sum(a.vl_planej_10),0) vl_planej_10,
	coalesce(sum(a.vl_planej_11),0) vl_planej_11,
	coalesce(sum(a.vl_planej_12),0) vl_planej_12
from	ctb_grupo_conta g,
	conta_contabil c,
	ctb_planej_orc_valor a
where	a.cd_conta_contabil	= c.cd_conta_contabil
and	c.cd_grupo		= g.cd_grupo
and	c.cd_empresa		= g.cd_empresa
and	g.ie_tipo in ('R','C')
and	a.nr_seq_planej		= nr_seq_planej_p
group by a.cd_estabelecimento,
	a.cd_centro_custo,
	a.cd_conta_contabil;
	
ctb_orc_cenario_w	ctb_orc_cenario%rowtype;

c_mes CURSOR FOR
SELECT	a.nr_seq_mes_ref
from	ctb_mes_planejamento_v a
where	a.nr_sequencia	= nr_seq_planej_p
order by a.dt_referencia;
			
type tab_mes is table of reg_mes index by integer;

mes_w			tab_mes;
i			integer	:= 0;
qt_registro_w		bigint;
BEGIN

select	a.*
into STRICT	ctb_orc_cenario_w
from	ctb_orc_cenario a
where	a.nr_sequencia = nr_seq_planej_p;

for vet in c_mes loop
	i	:= i + 1;
	mes_w[i].nr_seq_mes_ref		:= vet.nr_seq_mes_ref;
	mes_w[i].vl_orcado		:= 0;
end loop;

for rec_w in c_planej_receita loop
	begin
	
	mes_w[01].vl_orcado	:= rec_w.vl_planej_01;
	mes_w[02].vl_orcado	:= rec_w.vl_planej_02;
	mes_w[03].vl_orcado	:= rec_w.vl_planej_03;
	mes_w[04].vl_orcado	:= rec_w.vl_planej_04;
	mes_w[05].vl_orcado	:= rec_w.vl_planej_05;
	mes_w[06].vl_orcado	:= rec_w.vl_planej_06;
	mes_w[07].vl_orcado	:= rec_w.vl_planej_07;
	mes_w[08].vl_orcado	:= rec_w.vl_planej_08;
	mes_w[09].vl_orcado	:= rec_w.vl_planej_09;
	mes_w[10].vl_orcado	:= rec_w.vl_planej_10;
	mes_w[11].vl_orcado	:= rec_w.vl_planej_11;
	mes_w[12].vl_orcado	:= rec_w.vl_planej_12;
	
	for i in 1..12 loop
		begin
		
		select	count(a.nr_sequencia)
		into STRICT	qt_registro_w
		from	ctb_orc_cen_valor a
		where	a.nr_seq_cenario	= nr_seq_planej_p
		and	a.cd_estabelecimento	= rec_w.cd_estabelecimento
		and	a.cd_centro_custo	= rec_w.cd_centro_custo
		and	a.cd_conta_contabil	= rec_w.cd_conta_contabil
		and	a.nr_seq_mes_ref	= mes_w[i].nr_seq_mes_ref;
		
		if (qt_registro_w = 0) then
			begin
			insert into ctb_orc_cen_valor(
				nr_sequencia,
				nr_seq_cenario,
				cd_estabelecimento,
				nr_seq_mes_ref,
				dt_atualizacao,
				nm_usuario,
				cd_conta_contabil,
				cd_centro_custo,
				vl_orcado,
				ds_observacao,
				qt_metrica,
				vl_ticket_medio,
				nr_seq_metrica,
				dt_liberacao,
				nm_usuario_lib)
			values (	nextval('ctb_orc_cen_valor_seq'),
				nr_seq_planej_p,
				rec_w.cd_estabelecimento,
				mes_w[i].nr_seq_mes_ref,
				clock_timestamp(),
				nm_usuario_p,
				rec_w.cd_conta_contabil,
				rec_w.cd_centro_custo,
				mes_w[i].vl_orcado,
				null,
				null,
				null,
				null,
				null,
				null);
			end;
		else
			update	ctb_orc_cen_valor a
			set	vl_orcado		= mes_w[i].vl_orcado,
				nm_usuario		= nm_usuario_p,
				dt_atualizacao		= clock_timestamp()
			where	a.nr_seq_cenario	= nr_seq_planej_p
			and	a.cd_estabelecimento	= rec_w.cd_estabelecimento
			and	a.cd_centro_custo	= rec_w.cd_centro_custo
			and	a.cd_conta_contabil	= rec_w.cd_conta_contabil
			and	a.nr_seq_mes_ref	= mes_w[i].nr_seq_mes_ref;
		end if;
		end;
	end loop;
	end;
end loop;

mes_w.delete;
commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ctb_gerar_planej_orc_rec ( nr_seq_planej_p ctb_orc_cenario.nr_sequencia%type, nm_usuario_p text) FROM PUBLIC;

