-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE man_gerar_justif_sever_os ( nr_seq_ordem_p bigint, ie_tipo_justificativa_p text, ds_justificativa_p text, nm_usuario_p text, nr_seq_severidade_p bigint default null, nr_seq_sever_antiga_p bigint default null, ie_sla_before_p text default null) AS $body$
DECLARE


nr_seq_tipo_w			bigint;
ds_mensagem_w			varchar(4000);
ds_severidade_antiga_w		varchar(4000);
ds_severidade_w			varchar(4000);
ds_nao_informado_w      	varchar(100);
nr_seq_idioma_w			idioma.nr_sequencia%type;
ie_sla_after_w			varchar(1);


BEGIN

	if (nr_seq_severidade_p <> nr_seq_sever_antiga_p) then
		begin
			nr_seq_tipo_w	:= 202;
						
			select substr(max(obter_desc_exp_idioma(309956, man_obter_idioma_os_local(nr_seq_ordem_p))),1,4000)
			into STRICT ds_nao_informado_w
			;

			select	coalesce(max('S'), 'N')
			into STRICT	ie_sla_after_w
			from	man_ordem_serv_sla
			where	nr_seq_ordem = nr_seq_ordem_p
			and	ie_tipo_sla_termino <> 3;

			if (ie_sla_before_p = 'S' and ie_sla_after_w = 'N')then
				select	substr(max(obter_desc_expressao_idioma(cd_exp_informacao, ds_informacao, man_obter_idioma_os_local(nr_seq_ordem_p))),1,4000)
				into STRICT	ds_mensagem_w
				from	dic_objeto
				where	nr_sequencia = 1212661
				and	ie_tipo_objeto = 'T';
			end if;
			
			if (nr_seq_severidade_p IS NOT NULL AND nr_seq_severidade_p::text <> '') then
				select substr(obter_desc_expressao_idioma(cd_exp_severidade, ds_severidade, man_obter_idioma_os_local(nr_seq_ordem_p)), 1, 255)
				into STRICT ds_severidade_w
				from man_severidade
				where nr_sequencia = nr_seq_severidade_p;
			else
				ds_severidade_w := ds_nao_informado_w;
			end if;
			
			if (nr_seq_sever_antiga_p IS NOT NULL AND nr_seq_sever_antiga_p::text <> '') then
				select substr(obter_desc_expressao_idioma(cd_exp_severidade, ds_severidade, man_obter_idioma_os_local(nr_seq_ordem_p)), 1, 255)
				into STRICT ds_severidade_antiga_w
				from man_severidade
				where nr_sequencia = nr_seq_sever_antiga_p;
			else
				ds_severidade_antiga_w := ds_nao_informado_w;
			end if;
			
			if (ds_mensagem_w IS NOT NULL AND ds_mensagem_w::text <> '') then
				ds_mensagem_w := substr(ds_mensagem_w || chr(13) || chr(10), 1, 4000);
			end if;
			
			ds_mensagem_w := substr(ds_mensagem_w || obter_texto_dic_objeto(1064782, man_obter_idioma_os_local(nr_seq_ordem_p), 'SEVERIDADE_ANTIGA='|| ds_severidade_antiga_w
																		|| ';SEVERIDADE_NOVA=' || ds_severidade_w 
																		|| ';JUSTIFICATIVA=' || ds_justificativa_p),1 , 4000);
			
			insert into man_ordem_justificativa(nr_sequencia,
				nr_seq_ordem,
				ie_tipo_justificativa,
				dt_atualizacao,
				nm_usuario,
				dt_atualizacao_nrec,
				nm_usuario_nrec,
				ds_justificativa)
			values (nextval('man_ordem_justificativa_seq'),
				nr_seq_ordem_p,
				ie_tipo_justificativa_p,
				clock_timestamp(),
				nm_usuario_p,
				clock_timestamp(), 
				nm_usuario_p,
				substr(ds_justificativa_p,1,255));
			
			insert into man_ordem_serv_tecnico(	nr_sequencia,
				nr_seq_ordem_serv,
				dt_atualizacao,
				nm_usuario,
				ds_relat_tecnico,
				dt_historico,
				dt_liberacao,
				nm_usuario_lib,
				nr_seq_tipo,
				ie_origem)
			values (nextval('man_ordem_serv_tecnico_seq'),
				nr_seq_ordem_p,
				clock_timestamp(),
				nm_usuario_p,
				ds_mensagem_w,
				clock_timestamp(),
				clock_timestamp(),
				nm_usuario_p,
				nr_seq_tipo_w,
				'I');
			
			commit;
		end;
	end if;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE man_gerar_justif_sever_os ( nr_seq_ordem_p bigint, ie_tipo_justificativa_p text, ds_justificativa_p text, nm_usuario_p text, nr_seq_severidade_p bigint default null, nr_seq_sever_antiga_p bigint default null, ie_sla_before_p text default null) FROM PUBLIC;

