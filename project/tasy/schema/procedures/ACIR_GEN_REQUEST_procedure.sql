-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE acir_gen_request ( nr_seq_account_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint, nr_seq_vaccin_p bigint, ie_resubmission_p text default 'n', ie_validation_p text default 'f', cd_seq_transaction_p INOUT text DEFAULT NULL) AS $body$
DECLARE


cd_pmsclaimid_w			acir_request_claim.cd_claim%type;
cd_immun_provider_w		acir_request_claim.cd_immun_provider%type;
cd_info_provider_w		acir_request_claim.cd_info_provider%type;
cd_transaction_w		acir_request_claim.nr_seq_transaction%type;
cd_indigenous_status_w		acir_request_event.ie_ats%type;
cd_clinic_w			acir_request_event.cd_clinic%type := null;
cd_community_w			acir_request_event.cd_community%type := null;
nr_sender_phone_w		acir_request_event.nr_sender_phone%type := null;
nm_first_w			acir_request_event.nm_first%type;
nm_family_w			acir_request_event.nm_family%type;
dt_birth_w			acir_request_event.dt_birth%type;
ie_gender_w			acir_request_event.ie_gender%type;
ds_address_w			acir_request_event.ds_address%type;
nr_postcode_w			acir_request_event.nr_postcode%type;
nr_atendimento_w		atendimento_paciente.nr_atendimento%type;
cd_medicare_card_w		atend_categoria_convenio.cd_usuario_convenio%type;
nr_pat_ref_number_w		atend_categoria_convenio.cd_complemento%type;
dt_next_due_w			acir_request_event.dt_next_due%type;
dt_immunisation_w 		acir_request_event.dt_immunisation%type;
nr_dose_w			acir_request_event.nm_dose%type;
inconsistency_count_w 		bigint;
request_gen              	varchar(500);

w      				bigint := 0;
a      				varchar(10);
nr_seq_acir_req_w 		bigint;





BEGIN


-- code to generate PmsClaimId
select	Upper(dbms_random.String('a', 1))
into STRICT  	a
;

select	CASE WHEN mod((nextval('eclipse_claim_seq')),10000)=0 THEN  1  ELSE mod((nextval('eclipse_claim_seq')),10000) END
into STRICT	w
;

cd_pmsclaimid_w := ( 	a
			|| Lpad(To_char(w), 6, '0')
			|| '+'
			);

-- transaction ID
cd_transaction_w :=  generateRandomNumber();
cd_seq_transaction_p := cd_transaction_w;
-- Encounter number , DateOfImmunisation , NextDueDate
select	max(a.nr_atendimento),
	max(a.dt_vacina),
	max(a.dt_proxima_dose),
	max(qt_dose)
into STRICT 	nr_atendimento_w,
	dt_immunisation_w,
	dt_next_due_w,
	nr_dose_w
from 	paciente_vacina a
where 	nr_sequencia = nr_seq_vaccin_p;


-- 	ImmunisationProviderNum
select	max(lpad(substr(k.nr_provider, 1,8),8,'0')),
	max(lpad(substr(k.nr_provider, 1,8),8,'0'))
into STRICT	cd_immun_provider_w,
	cd_info_provider_w
from   	paciente_vacina b,
        atendimento_paciente a ,
        medical_provider_number k
where   b.nr_atendimento = a.nr_atendimento
and     a.cd_medico_resp = k.cd_medico
and	b.nr_sequencia = nr_seq_vaccin_p  LIMIT 1;

-- Information Provider number
-- AtsiIndicator
select	max(cd_indigenous_status)
into STRICT	cd_indigenous_status_w
from 	qhapdc_hcp_assessment_data a,
	paciente_vacina b,
	atendimento_paciente c
where  	b.nr_atendimento = a.nr_atendimento
and   	a.nr_atendimento = c.nr_atendimento
and 	b.nr_sequencia = nr_seq_vaccin_p;

select	CASE WHEN cd_indigenous_status_w=1 THEN 'Y' WHEN cd_indigenous_status_w=2 THEN 'Y' WHEN cd_indigenous_status_w=3 THEN 'Y'   ELSE 'N' END
into STRICT 	cd_indigenous_status_w
;

-- ContactPhoneNum
select	max(b.nr_telefone_celular)
into STRICT 	nr_sender_phone_w
from 	paciente_vacina a,
	pessoa_fisica b,
	atendimento_paciente c
where	a.nr_atendimento = c.nr_atendimento
and	b.cd_pessoa_fisica = c.cd_pessoa_fisica
and	a.nr_sequencia = nr_seq_vaccin_p  LIMIT 1;

--
select	max(pkg_name_utils.get_person_name(d.nr_seq_person_name,cd_estabelecimento_p,'givenName')) ,
	max(pkg_name_utils.get_person_name(d.nr_seq_person_name,cd_estabelecimento_p,'familyName')) ,
      	max(d.dt_nascimento) dt_birth,
      	max(d.ie_sexo) ie_gender,
        max(substr(e.ds_endereco, 1, 40)),
        max(e.cd_cep)
	--max(b.cd_usuario_convenio)
into STRICT
	nm_first_w,
	nm_family_w,
	dt_birth_w,
	ie_gender_w,
	ds_address_w,
	nr_postcode_w


from  	paciente_vacina a,
	atend_categoria_convenio b,
	atendimento_paciente c,
	pessoa_fisica d,
	compl_pessoa_fisica e,
	convenio f
where 	b.nr_atendimento   = a.nr_atendimento
and   	c.nr_atendimento   = b.nr_atendimento
and   	c.cd_pessoa_fisica = d.cd_pessoa_fisica
and   	d.cd_pessoa_fisica = e.cd_pessoa_fisica
and 	a.nr_sequencia = nr_seq_vaccin_p  LIMIT 1;


select	max(a.cd_usuario_convenio),
	max(a.cd_complemento)

into STRICT	cd_medicare_card_w,
	nr_pat_ref_number_w
from	atend_categoria_convenio a
where	a.nr_atendimento = nr_atendimento_w;

select  nextval('acir_request_claim_seq')
into STRICT  	nr_seq_acir_req_w
;


insert	into	acir_request_claim(	nr_sequencia,
				dt_atualizacao,
				nm_usuario,
				dt_atualizacao_nrec,
				nm_usuario_nrec,
				cd_immun_provider,
				cd_claim,
				cd_info_provider,
				nr_seq_transaction
			)
	values (
				nr_seq_acir_req_w,
				clock_timestamp(),
				nm_usuario_p,
				clock_timestamp(),
				nm_usuario_p,
				cd_immun_provider_w,
				cd_pmsclaimid_w,
				cd_info_provider_w,
				cd_transaction_w

			);

insert	into	acir_request_event(	nr_sequencia,
				dt_atualizacao,
				nm_usuario,
				dt_atualizacao_nrec,
				nm_usuario_nrec,
				nm_dose,
				ie_ats,
				dt_next_due,
				cd_clinic,
				cd_community,
				nr_sender_phone,
				dt_immunisation,
				ds_address_line1,
				dt_hepb_birth,
				ie_hepb,
				ds_address_line2,
				ds_address,
				nr_postcode,
				dt_birth,
				nm_family,
				nm_first,
				ie_gender,
				cd_medicare_card,
				cd_provider_child,
				nr_patient_ref,
				nm_second,
				cd_school,
				nm_batch,
				cd_vaccine,
				cd_medicare_issue_num,
				nr_seq_request
			)
	values (
				nextval('acir_request_event_seq'),
				clock_timestamp(),
				nm_usuario_p,
				clock_timestamp(),
				nm_usuario_p,
				nr_dose_w,
				cd_indigenous_status_w,
				dt_next_due_w,
				'NTNT'	,		--- Hard coding clinic code
				'12345'		,	-- Community code
				nr_sender_phone_w,
				dt_immunisation_w,
				ds_address_w,
				clock_timestamp() - interval '3000 days'		,	-- Hard coding hepd date
				'Y'		,	-- hard coding hepBBirthDoseInd
				null,
				ds_address_w,
				nr_postcode_w,
				dt_birth_w,
				nm_family_w,
				nm_first_w,
				ie_gender_w,
				substr(cd_medicare_card_w,1,9),
				substr(cd_medicare_card_w,1,9),	-- child medicare
				nr_pat_ref_number_w,
				'S',
				'45906', -- hard coding school id
				'u756' , -- hard coding vaccine batch
				'HPVNIN', -- hard codin vaccine code
				substr(cd_medicare_card_w,10,1),
				nr_seq_acir_req_w
			);
commit;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE acir_gen_request ( nr_seq_account_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint, nr_seq_vaccin_p bigint, ie_resubmission_p text default 'n', ie_validation_p text default 'f', cd_seq_transaction_p INOUT text DEFAULT NULL) FROM PUBLIC;

