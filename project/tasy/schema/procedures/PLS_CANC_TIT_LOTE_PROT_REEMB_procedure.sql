-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_canc_tit_lote_prot_reemb ( nr_seq_lote_reemb_cred_p pls_protocolo_conta.nr_seq_lote_reemb_cred%type, nm_usuario_p text) AS $body$
DECLARE

 
dt_vencimento_w		pls_lote_reemb_credito.dt_vencimento%type;
dt_geracao_titulos_w	pls_lote_reemb_credito.dt_geracao_titulos%type;
			
C01 CURSOR(nr_seq_lote_reemb_cred_pc	pls_protocolo_conta.nr_seq_lote_reemb_cred%type) FOR 
SELECT	b.nr_titulo 
from	titulo_pagar b, 
	pls_protocolo_conta a 
where	a.nr_seq_lote_reemb_cred	= nr_seq_lote_reemb_cred_pc 
and	a.nr_sequencia			= b.nr_seq_reembolso;

BEGIN 
 
for r_C01_w in c01(nr_seq_lote_reemb_cred_p) loop 
 
	CALL cancelar_titulo_pagar(r_C01_w.nr_titulo, nm_usuario_p, clock_timestamp());
 
	update	titulo_pagar 
	set	nr_seq_reembolso	 = NULL 
	where	nr_titulo		= r_C01_w.nr_titulo;
 
end loop;
 
update 	pls_lote_reemb_credito 
set	dt_geracao_titulos	 = NULL, 
	dt_atualizacao		= clock_timestamp(), 
	nm_usuario		= nm_usuario_p 
where	nr_sequencia		= nr_seq_lote_reemb_cred_p;	
 
commit;
	 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_canc_tit_lote_prot_reemb ( nr_seq_lote_reemb_cred_p pls_protocolo_conta.nr_seq_lote_reemb_cred%type, nm_usuario_p text) FROM PUBLIC;

