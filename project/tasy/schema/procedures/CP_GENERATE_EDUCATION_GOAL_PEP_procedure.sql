-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE cp_generate_education_goal_pep ( nr_seq_prescr_p bigint, nm_usuario_p text) AS $body$
DECLARE


						
nr_atendimento_w		pe_prescricao.nr_atendimento%type;
ie_tipo_w			pe_prescricao.ie_tipo%type;
nr_seq_tof_meta_w		cp_conv_goal.nr_seq_tof_meta%type;
nr_seq_pat_cp_goal_w	patient_cp_goal.nr_sequencia%type;


c01 CURSOR FOR
SELECT	a.nr_seq_tof_meta,
	c.nr_sequencia
from	cp_conv_goal a,
	cp_goal b,
	patient_cp_goal c,
	patient_cp_problem d,
	patient_care_plan e
where	a.nr_seq_goal = b.nr_sequencia
and	c.nr_seq_cp_goal = b.nr_sequencia
and	c.nr_seq_pat_cp_problem = d.nr_sequencia
and	d.nr_seq_pat_care_plan = e.nr_sequencia
and	e.nr_seq_prescr = nr_seq_prescr_p
and	c.si_selected = 'Y'
and exists (	SELECT	1
		from	patient_cp_indicator x 
		where	x.nr_seq_pat_cp_goal = c.nr_sequencia);

c01_w	c01%rowtype;


BEGIN

if (nr_seq_prescr_p > 0) then


	select	nr_atendimento,
		ie_tipo		
	into STRICT	nr_atendimento_w,
		ie_tipo_w
	from	pe_prescricao
	where	nr_sequencia = nr_seq_prescr_p;
	
	if (nr_atendimento_w > 0) and (ie_tipo_w = 'CP') then

		open C01;
		loop
		fetch C01 into	
			nr_seq_tof_meta_w,
			nr_seq_pat_cp_goal_w;
		EXIT WHEN NOT FOUND; /* apply on C01 */
			begin
			
			insert into tof_meta_atend(
				nr_sequencia,
				dt_atualizacao,
				nm_usuario,
				dt_atualizacao_nrec,
				nm_usuario_nrec,
				nr_seq_meta,
				dt_inicio,
				nr_atendimento,
				dt_liberacao,
				ie_situacao,
				nr_seq_pat_cp_goal)
			values (	nextval('tof_meta_atend_seq'),
				clock_timestamp(),
				nm_usuario_p,
				clock_timestamp(),
				nm_usuario_p,
				nr_seq_tof_meta_w,
				clock_timestamp(),
				nr_atendimento_w,
				clock_timestamp(),
				'A',
				nr_seq_pat_cp_goal_w);		
			
			end;
		end loop;
		close C01;		
	end if;
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cp_generate_education_goal_pep ( nr_seq_prescr_p bigint, nm_usuario_p text) FROM PUBLIC;

