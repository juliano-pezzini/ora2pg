-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE consiste_opm_prescricao ( cd_material_p material.cd_material%type, cd_pessoa_fisica_p pessoa_fisica.cd_pessoa_fisica%type, nr_prescricao_p prescr_medica.nr_prescricao%type, nr_sequencia_p prescr_opm.nr_sequencia%type, ds_aviso_p INOUT text, ds_abort_p INOUT text, ds_questiona_p INOUT text) AS $body$
DECLARE

						 
ie_retorno_mat_atual_w		varchar(15);	
ie_retorno_mat_registrado_w	varchar(15);					
cd_material_w			material.cd_material%type;
ie_situacao_w			varchar(2);
ie_prescricao_w			varchar(2);
cd_estabelecimento_w		bigint;
ie_modo_sem_vinculo_w		varchar(15);
ie_modo_imcompativel_w		varchar(15);
								
c01 CURSOR FOR				 
	SELECT	cd_material 
	from	prescr_opm 
	where	nr_prescricao	= 	nr_prescricao_p 
	and	nr_sequencia	<> 	nr_sequencia_p;
						

BEGIN 
 
cd_estabelecimento_w := wheb_usuario_pck.get_cd_estabelecimento;
 
ie_modo_sem_vinculo_w := obter_param_usuario(924, 1177, wheb_usuario_pck.get_cd_perfil, wheb_usuario_pck.get_nm_usuario, wheb_usuario_pck.get_cd_estabelecimento, ie_modo_sem_vinculo_w);
ie_modo_imcompativel_w := obter_param_usuario(924, 1178, wheb_usuario_pck.get_cd_perfil, wheb_usuario_pck.get_nm_usuario, wheb_usuario_pck.get_cd_estabelecimento, ie_modo_imcompativel_w);
 
select coalesce(max(ie_situacao), 'A'), 
	  coalesce(max(substr(obter_se_material_prescricao(cd_estabelecimento_w,cd_material_p),1,1)), 'S') 
into STRICT  ie_situacao_w, 
	  ie_prescricao_w 
from  material 
where cd_material = cd_material_p;
 
if ((ie_situacao_w = 'I') or (ie_prescricao_w = 'N')) then 
  --204281 - Este item não será incluso por estar inativo ou não ser prescritível. Verificar cadastro do material. 
	ds_abort_p := '204281'; 		
else 
	ie_retorno_mat_atual_w	:= obter_se_compatibilidade_opm(cd_material_p,cd_pessoa_fisica_p);
	 
	if (ie_retorno_mat_atual_w = 'SD') then 
		--365874 - Este paciente não possui CID. É necessário informar o CID do paciente na função Prontuário Eletrônico Paciente - PEP 
		ds_abort_p := '365874';
	elsif (ie_retorno_mat_atual_w = 'SP') then 
		if (ie_modo_sem_vinculo_w = 'A') then 
			--365876 - Atenção. Esta OPM não possui vínculo com o procedimento SUS 
			ds_aviso_p := '365876';
		elsif (ie_modo_sem_vinculo_w = 'I') then 
			--365876 - Atenção. Esta OPM não possui vínculo com o procedimento SUS 
			ds_abort_p := '365876';
		end if;	
	elsif (ie_retorno_mat_atual_w = 'I') then	 
		if (ie_modo_imcompativel_w = 'Q') then 
			--365877 - Atenção. Esta OPM não é compatível com o CID do procedimento SUS. Deseja salvar a OPM mesmo assim? 
			ds_questiona_p 	:= '365877';
		elsif (ie_modo_imcompativel_w = 'B') then 
			--456264 - Atenção. Esta OPM não é compatível com o CID do procedimento SUS. 
			ds_abort_p 	:= '456264';
		end if;	
	end if;	
	 
	if (coalesce(ds_abort_p::text, '') = '') and (coalesce(nr_prescricao_p,0) > 0) then 
		open C01;
		loop 
		fetch C01 into	 
			cd_material_w;
		EXIT WHEN NOT FOUND; /* apply on C01 */
			begin 
			 
			ie_retorno_mat_registrado_w := obter_se_compatibilidade_opm(cd_material_w,cd_pessoa_fisica_p);
			 
			if	((ie_retorno_mat_atual_w = 'C' AND ie_retorno_mat_registrado_w = 'I') or 
				(ie_retorno_mat_atual_w = 'I' AND ie_retorno_mat_registrado_w = 'C')) then 
				--365880 - Não é possível salvar a OPM! Existem OPM's compatíveis e não compatíveis com o CID do procedimento SUS nesta prescrição. É possível registrar OPM's na mesma condição. Será necessário criar uma nova prescrição para a excessão. 
				ds_abort_p := '365880';
			elsif	((ie_retorno_mat_atual_w = 'C' AND ie_retorno_mat_registrado_w = 'SP') or 
				(ie_retorno_mat_atual_w = 'SP' AND ie_retorno_mat_registrado_w = 'C')) then 
				--365882 - Não é possível salvar a OPM! Existem OPM's compatíveis e OPM's sem vínculo com o procedimento SUS nesta prescrição. É possível registrar OPM's na mesma condição. Será necessário criar uma nova prescrição para a excessão. 
				ds_abort_p := '365882';
			end if;	
			end;
		end loop;
		close C01;
	end if;
end if;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE consiste_opm_prescricao ( cd_material_p material.cd_material%type, cd_pessoa_fisica_p pessoa_fisica.cd_pessoa_fisica%type, nr_prescricao_p prescr_medica.nr_prescricao%type, nr_sequencia_p prescr_opm.nr_sequencia%type, ds_aviso_p INOUT text, ds_abort_p INOUT text, ds_questiona_p INOUT text) FROM PUBLIC;

