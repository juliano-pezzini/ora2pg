-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE enviar_prestador_externo (NR_SEQ_LISTA_ESPERA_P bigint, CNPJ_EXTERNO_P text) AS $body$
DECLARE


  NR_SEQ_REGULACAO_ATEND_W REGULACAO_ATEND.NR_SEQUENCIA%TYPE;

  IE_STATUS_W REGULACAO_ATEND.IE_STATUS%TYPE;

  IE_INTEGRACAO_W varchar(2);



  NM_USUARIO_W REGULACAO_ATEND.NM_USUARIO%TYPE;




BEGIN



  IF (NR_SEQ_LISTA_ESPERA_P IS NOT NULL AND NR_SEQ_LISTA_ESPERA_P::text <> '') THEN

  

    UPDATE AGENDA_LISTA_ESPERA A

       SET A.CNPJ_LOCAL_AGENDA_EXTERNO = CNPJ_EXTERNO_P,

           A.DS_LOCAL_AGENDA_EXTERNO   = OBTER_NOME_PJ(CNPJ_EXTERNO_P),

           A.DT_AGENDA_EXTERNO         = clock_timestamp()

     WHERE A.NR_SEQUENCIA = NR_SEQ_LISTA_ESPERA_P;



    COMMIT;



    SELECT MAX(A.NR_SEQ_REGULACAO)

      INTO STRICT NR_SEQ_REGULACAO_ATEND_W

      FROM AGENDA_LISTA_ESPERA A

     WHERE NR_SEQUENCIA = NR_SEQ_LISTA_ESPERA_P;



    IF (NR_SEQ_REGULACAO_ATEND_W IS NOT NULL AND NR_SEQ_REGULACAO_ATEND_W::text <> '') THEN

    

      SELECT MAX(IE_STATUS)

      

        INTO STRICT IE_STATUS_W
      

        FROM REGULACAO_ATEND

      

       WHERE NR_SEQUENCIA = NR_SEQ_REGULACAO_ATEND_W;



    

      NM_USUARIO_W := WHEB_USUARIO_PCK.GET_NM_USUARIO;



      IE_INTEGRACAO_W := OBTER_PARAM_USUARIO(366, 4, OBTER_PERFIL_ATIVO, NM_USUARIO_W, NULL, IE_INTEGRACAO_W);



      IF (IE_INTEGRACAO_W = 'I') THEN
 
        CALL ENVIA_LISTA_ESPERA_INTEGRACAO(NR_SEQ_LISTA_ESPERA_P, NULL, CNPJ_EXTERNO_P);

     END IF;

    END IF;

  END IF;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE enviar_prestador_externo (NR_SEQ_LISTA_ESPERA_P bigint, CNPJ_EXTERNO_P text) FROM PUBLIC;

