-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE delete_ajust_int_test_pend (nr_seq_intencao_uso_p bigint, ds_version_p text, nm_usuario_p text) AS $body$
DECLARE



  c01 CURSOR FOR
    SELECT w.nr_seq_integrated_test, w.nr_sequencia
      from w_test_plan_ignored_int w, reg_integrated_test t
     where w.nr_seq_integrated_test = t.nr_sequencia
       and w.ie_tipo_operacao = 'E'
       and w.nm_usuario = nm_usuario_p
       and w.ds_version = ds_version_p
       and t.nr_seq_intencao_uso = nr_seq_intencao_uso_p;

  c02 CURSOR(nr_seq_int_test_w bigint) FOR
    SELECT p.*
      from reg_integrated_test_pend p, reg_integrated_test_cont c
     where p.nr_seq_controle = c.nr_sequencia
       and c.ie_situacao = 'A'
       and c.cd_versao = ds_version_p
       and coalesce(c.dt_fim::text, '') = ''
       and c.nr_seq_intencao_uso = nr_seq_intencao_uso_p
       and p.nr_seq_integrated_test = nr_seq_int_test_w;

  r01 c01%rowtype;
  r02 c02%rowtype;



BEGIN

  if ((nr_seq_intencao_uso_p IS NOT NULL AND nr_seq_intencao_uso_p::text <> '') and (ds_version_p IS NOT NULL AND ds_version_p::text <> '') and
     (nm_usuario_p IS NOT NULL AND nm_usuario_p::text <> '')) then

    for r01 in c01 loop
    
      for r02 in c02(r01.nr_seq_integrated_test) loop
      
        delete from reg_integrated_test_so
         where nr_seq_int_test_res in (SELECT nr_sequencia
                  from reg_integrated_test_result
                 where nr_seq_pendencia = r02.nr_sequencia);

        delete from reg_integrated_test_result
         where nr_seq_pendencia = r02.nr_sequencia;

        delete from reg_integrated_test_pend
         where nr_sequencia = r02.nr_sequencia;

      end loop;

      delete from w_test_plan_ignored_int
       where nr_sequencia = r01.nr_sequencia;

    end loop;

    commit;

  end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE delete_ajust_int_test_pend (nr_seq_intencao_uso_p bigint, ds_version_p text, nm_usuario_p text) FROM PUBLIC;

