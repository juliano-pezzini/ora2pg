-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_w_philips_sales ( ie_status_p text, ie_project_currency_p bigint, ie_restr_prop_lib_p text, dt_prev_fecham_inic_p timestamp, dt_prev_fecham_term_p timestamp, ie_produto_p text, ie_fase_venda_p text, ds_filtros_p text, cd_gestor_p text, ie_not_restricao_p text, ie_status_neg_p text) AS $body$
DECLARE

		 
channel_w		varchar(15);
public_private_w    varchar(15);
account_manager_w    varchar(60);
system_w        varchar(20);
customer_w       varchar(80);
status_w        varchar(255);
quantity_w		double precision;
project_currency_w	varchar(15) := 'Real';
net_sales_price_w    double precision;
competition_company_w	varchar(2000);
forecasting_w		timestamp;
forecasting_quarter_w	smallint;
comments_w		varchar(2000);
nr_seq_cliente_w	bigint;
ie_restr_fecham_w	varchar(1) := 'N';
sales_phase_w		varchar(100);
negotiation_status_w	varchar(100);
customer_type_w		varchar(100);
beds_w			integer;
lifes_w			bigint;
channel_name_w		varchar(60);
cd_canal_w		bigint;
cd_gestor_w		varchar(10);

c01 CURSOR FOR 
SELECT	PS_obter_canal_venda(c.nr_sequencia) channel, 
	PS_obter_natureza_venda(c.ie_natureza) public_private, 
	PS_obter_gestor_conta(c.nr_sequencia, 'N') account_manager, 
	PS_obter_produto_venda(c.ie_produto) system, 
	p.nm_fantasia customer, 
	PS_obter_classif_conta(c.ie_classificacao) status, 
	PS_obter_quant_propostas_venda(c.nr_sequencia) quantity, 
	PS_obter_valor_proposta_venda(c.nr_sequencia, ie_project_currency_p) net_sales_price, 
	PS_obter_concorrentes(c.nr_sequencia) competition_company, 
	c.dt_revisao_prevista forecasting, 
	PS_obter_forecasting_quarter(c.dt_revisao_prevista) forecasting_quarter, 
	substr(	PS_obter_fase_venda(c.ie_fase_venda) 		|| ';' || 
		PS_obter_status_negociacao(c.ie_status_neg) 	|| ';' || 
		to_char(c.qt_leito)				|| ';' || 
		to_char(c.qt_vidas)				|| ';' || 
		PS_obter_tipo_cliente(c.ie_tipo),1,2000) comments, 
	c.nr_sequencia, 
	PS_obter_fase_venda(c.ie_fase_venda) sales_phase, 
	PS_obter_status_negociacao(c.ie_status_neg) negotiation_status, 
	c.qt_leito beds, 
	c.qt_vidas lifes,	 
	PS_obter_tipo_cliente(c.ie_tipo) customer_type, 
	PS_obter_nome_canal_venda(c.nr_sequencia) channel_name, 
	com_obter_canal_venda(c.nr_sequencia,'C') cd_canal, 
	PS_obter_gestor_conta(c.nr_sequencia,'C') cd_gestor 
from	pessoa_juridica p, 
	com_cliente c 
where	p.cd_cgc = c.cd_cnpj 
and	ie_classificacao = ie_status_p 
and	exists (	SELECT 1 
			from	com_canal_cliente x,  
				com_canal y 
			where  x.nr_seq_cliente = c.nr_sequencia 
			and   x.nr_seq_canal  = y.nr_sequencia 
			and   coalesce(obter_se_perfil_canal(y.nr_sequencia,obter_perfil_ativo),'S') = 'S' 
			and   coalesce(x.dt_fim_atuacao::text, '') = '' 
			and   x.ie_tipo_atuacao = 'V') 
and	((ie_restr_prop_lib_p = 'N') or 
	 ((ie_restr_prop_lib_p = 'S') and (exists ( 
						select	1 
						from	com_cliente_prop_item y, 
							com_cliente_proposta x 
						where	y.nr_seq_proposta = x.nr_sequencia 
						and	coalesce(y.ie_orcam_coml_wheb,'N') = 'S' 
						and	x.nr_seq_cliente = c.nr_sequencia 
						and	(x.dt_liberacao IS NOT NULL AND x.dt_liberacao::text <> '') 
						and	coalesce(x.dt_cancelamento::text, '') = '' 
						and	coalesce(x.dt_vencimento,clock_timestamp()) >= clock_timestamp())))) 
and	((ie_restr_fecham_w = 'N') or 
	 (ie_restr_fecham_w = 'S' AND c.dt_revisao_prevista between dt_prev_fecham_inic_p and dt_prev_fecham_term_p)) 
and ((coalesce(ie_produto_p::text, '') = '') or 
	ie_produto = ie_produto_p) 
and ((coalesce(ie_fase_venda_p::text, '') = '') or 
	ie_fase_venda = ie_fase_venda_p) 
and ((coalesce(ds_filtros_p::text, '') = '') or 
  (('N' = ie_not_restricao_p) and ('S' = obter_se_contido(com_obter_canal_venda(c.nr_sequencia,'C'), ds_filtros_p))) or 
	(('S' = ie_not_restricao_p) and ('N' = obter_se_contido(com_obter_canal_venda(c.nr_sequencia,'C'), ds_filtros_p)))) 
and ((coalesce(cd_gestor_p::text, '') = '') or (PS_obter_gestor_conta(c.nr_sequencia,'C') = cd_gestor_p)) 
and ((coalesce(ie_status_neg_p::text, '') = '') or (c.ie_status_neg = ie_status_neg_p));


BEGIN 
CALL exec_sql_dinamico('Tasy','truncate table w_philips_sales');
 
project_currency_w := obter_desc_sigla_moeda(ie_project_currency_p);
 
if (dt_prev_fecham_inic_p IS NOT NULL AND dt_prev_fecham_inic_p::text <> '') and (dt_prev_fecham_term_p IS NOT NULL AND dt_prev_fecham_term_p::text <> '') then 
	begin 
	ie_restr_fecham_w := 'S';
	end;
end if;
 
open c01;
loop 
fetch c01 into	channel_w, 
		public_private_w, 
		account_manager_w, 
		system_w, 
		customer_w, 
		status_w, 
		quantity_w, 
		net_sales_price_w, 
		competition_company_w, 
		forecasting_w, 
		forecasting_quarter_w, 
		comments_w, 
		nr_seq_cliente_w, 
		sales_phase_w, 
		negotiation_status_w, 
		beds_w, 
		lifes_w,		 
		customer_type_w, 
		channel_name_w, 
		cd_canal_w, 
		cd_gestor_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	begin	 
	insert into w_philips_sales( 
		channel, 
		public_private, 
		account_manager, 
		system, 
		customer, 
		status, 
		quantity, 
		net_sales_price, 
		project_currency, 
		competition_company, 
		forecasting, 
		forecasting_quarter, 
		comments, 
		nr_seq_cliente, 
		sales_phase, 
		negotiation_status, 
		beds, 
		lifes,		 
		customer_type, 
		channel_name, 
		id_channel, 
		id_account_manager) 
	values ( 
		channel_w, 
		public_private_w, 
		account_manager_w, 
		system_w, 
		customer_w, 
		status_w, 
		quantity_w, 
		net_sales_price_w, 
		project_currency_w, 
		competition_company_w, 
		forecasting_w, 
		forecasting_quarter_w, 
		comments_w, 
		nr_seq_cliente_w, 
		sales_phase_w, 
		negotiation_status_w, 
		beds_w, 
		lifes_w,		 
		customer_type_w, 
		channel_name_w, 
		cd_canal_w, 
		cd_gestor_w);
	end;
end loop;
close c01;
commit;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_w_philips_sales ( ie_status_p text, ie_project_currency_p bigint, ie_restr_prop_lib_p text, dt_prev_fecham_inic_p timestamp, dt_prev_fecham_term_p timestamp, ie_produto_p text, ie_fase_venda_p text, ds_filtros_p text, cd_gestor_p text, ie_not_restricao_p text, ie_status_neg_p text) FROM PUBLIC;

