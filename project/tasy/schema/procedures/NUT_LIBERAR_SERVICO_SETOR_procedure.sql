-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE nut_liberar_servico_setor ( ds_lista_servico_p text, cd_setor_p bigint, dt_incial_p timestamp, dt_final_p timestamp) AS $body$
DECLARE

			 
nr_sequencia_w			bigint;

tam_lista_w			bigint;
ds_lista_servico_w			varchar(4000);
ie_pos_virgula_w			smallint;
nr_seq_servico_w			bigint;

--Auxiliares 
qtd_w				bigint;

C01 CURSOR FOR 
	SELECT	a.nr_sequencia 
	from	nut_atend_serv_dia a 
	where	cd_setor_atendimento 	= cd_setor_p 
	and	dt_servico between dt_incial_p and fim_dia(dt_final_p) 
	and	a.nr_seq_servico 		= nr_seq_servico_w 
	and	coalesce(dt_liberacao::text, '') = '' 
	order by a.nr_sequencia;
	

BEGIN 
if (cd_setor_p IS NOT NULL AND cd_setor_p::text <> '') then 
	begin			 
		if (ds_lista_servico_p IS NOT NULL AND ds_lista_servico_p::text <> '') then 
			ds_lista_servico_w := ds_lista_servico_p;
			qtd_w := 1;
			 
			while(ds_lista_servico_w IS NOT NULL AND ds_lista_servico_w::text <> '') and (qtd_w < 1000)loop 
				begin 
				qtd_w			:= qtd_w + 1;
				tam_lista_w		:= length(ds_lista_servico_w);
				ie_pos_virgula_w	:= position(',' in ds_lista_servico_w);
			 
				if (ie_pos_virgula_w <> 0) then 
					nr_seq_servico_w	:= substr(ds_lista_servico_w,1,(ie_pos_virgula_w - 1));
				else 
					nr_seq_servico_w	:= ds_lista_servico_w;
				end if;
			 
				ds_lista_servico_w	:= substr(ds_lista_servico_w,(ie_pos_virgula_w + 1),tam_lista_w);
				 
				open C01;
				loop 
				fetch C01 into	 
					nr_sequencia_w;
				EXIT WHEN NOT FOUND; /* apply on C01 */
					begin 
					CALL Liberar_Servico_Nutricao( nr_sequencia_w, wheb_usuario_pck.get_nm_usuario, 'L');
					end;
				end loop;
				close C01;
				 
				end;
			end loop;
		end if;
	end;
end if;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE nut_liberar_servico_setor ( ds_lista_servico_p text, cd_setor_p bigint, dt_incial_p timestamp, dt_final_p timestamp) FROM PUBLIC;

