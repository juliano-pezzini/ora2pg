-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE qua_excluir_documento ( nr_sequencia_p bigint) AS $body$
DECLARE


nr_seq_ordem_serv_w		bigint;
nm_documento_w			qua_documento.nm_documento%type;
cd_documento_w			qua_documento.cd_documento%type;


BEGIN

if (nr_sequencia_p IS NOT NULL AND nr_sequencia_p::text <> '') then
	begin

	select	max(nr_sequencia)
	into STRICT	nr_seq_ordem_serv_w
	from	man_ordem_servico
	where	nr_seq_documento = nr_sequencia_p;

	select	cd_documento
	into STRICT	cd_documento_w
	from	qua_documento
	where	nr_sequencia = nr_sequencia_p;

	if (nr_seq_ordem_serv_w IS NOT NULL AND nr_seq_ordem_serv_w::text <> '') then

		select	substr(nm_documento, 1, 255) nm_documento
		into STRICT	nm_documento_w
		from	qua_documento
		where	nr_sequencia = nr_sequencia_p;

		insert into man_ordem_serv_tecnico(
			nr_sequencia,
			nr_seq_ordem_serv,
			dt_atualizacao,
			nm_usuario,
			ds_relat_tecnico,
			dt_historico,
			ie_origem,
			nr_seq_tipo,
			dt_liberacao,
			nm_usuario_lib )
		values (nextval('man_ordem_serv_tecnico_seq'),
			nr_seq_ordem_serv_w,
			clock_timestamp(),
			wheb_usuario_pck.get_nm_usuario,
			--Foi desfeito o vínculo do documento #@NR_SEQ_DOCUMENTO#@ - #@NM_DOCUMENTO#@ com esta OS para que o mesmo possa ser excluído.
			wheb_mensagem_pck.get_texto(356546, 	'NR_SEQ_DOCUMENTO=' || nr_sequencia_p || ';' ||
								'NM_DOCUMENTO=' || nm_documento_w || ';' ||
								'CD_DOCUMENTO=' || cd_documento_w ),
			clock_timestamp(),
			'I',
			1,
			clock_timestamp(),
			wheb_usuario_pck.get_nm_usuario );

		update	man_ordem_servico
		set	nr_seq_documento  = NULL,
			dt_atualizacao = clock_timestamp(),
			nm_usuario = wheb_usuario_pck.get_nm_usuario
		where	nr_sequencia = nr_seq_ordem_serv_w;

	end if;

	/*Liberação*/

	delete from qua_doc_lib where nr_seq_doc = nr_sequencia_p;
	delete from qua_doc_lib_estab where nr_seq_doc = nr_sequencia_p;
	delete from qua_doc_arquivo where nr_seq_doc = nr_sequencia_p;

	/*Log*/

	delete from qua_doc_log_acesso where nr_seq_doc = nr_sequencia_p;

	/*Revisão*/

	delete from qua_doc_processo where nr_seq_revisao in (SELECT nr_sequencia from qua_doc_revisao where nr_seq_doc = nr_sequencia_p);
	delete from qua_doc_revisao_validacao where nr_seq_doc_revisao in (SELECT nr_sequencia from qua_doc_revisao where nr_seq_doc = nr_sequencia_p);
	delete from qua_doc_revisao_aprovacao where nr_seq_revisao in (SELECT nr_sequencia from qua_doc_revisao where nr_seq_doc = nr_sequencia_p);
	delete from qua_doc_revisao where nr_seq_doc = nr_sequencia_p;

	/*Treinamento*/

	delete from qua_doc_trein_resp where nr_seq_treinamento in (SELECT nr_sequencia from qua_doc_treinamento where nr_seq_documento = nr_sequencia_p);
	delete from qua_doc_tr_pf_aval_result where nr_seq_trein_pf_aval in (SELECT nr_sequencia from qua_doc_trein_pf_aval where nr_seq_trein_pessoa in (select nr_sequencia from qua_doc_trein_pessoa where nr_seq_treinamento in (select	nr_sequencia from qua_doc_treinamento where nr_seq_documento = nr_sequencia_p)));
	delete from qua_doc_trein_pf_aval where nr_seq_trein_pessoa in (SELECT nr_sequencia from qua_doc_trein_pessoa where nr_seq_treinamento in (select	nr_sequencia from qua_doc_treinamento where nr_seq_documento = nr_sequencia_p));
	delete from qua_doc_trein_pessoa where nr_seq_treinamento in (SELECT nr_sequencia from qua_doc_treinamento where nr_seq_documento = nr_sequencia_p);
	delete from qua_doc_trein_funcao where nr_seq_treinamento in (SELECT nr_sequencia from qua_doc_treinamento where nr_seq_documento = nr_sequencia_p);
	delete from qua_doc_trein_anexo where nr_seq_treinamento in (SELECT nr_sequencia from qua_doc_treinamento where nr_seq_documento = nr_sequencia_p);
	delete from qua_doc_treinamento where nr_seq_documento = nr_sequencia_p;

	/*Envio*/

	delete from qua_doc_envio where nr_seq_doc = nr_sequencia_p;

	/*Documento relacionado*/

	delete from qua_doc_doc where nr_seq_doc = nr_sequencia_p;

	/*Armazenamento*/

	delete from qua_doc_local where nr_seq_doc = nr_sequencia_p;

	/*Setores envolvidos*/

	delete from qua_doc_setor_adic where nr_seq_doc = nr_sequencia_p;

	/*Participantes*/

	delete from qua_doc_participante where nr_seq_doc = nr_sequencia_p;

	/*Cargo*/

	delete from qua_doc_grupo_cargo where nr_seq_doc = nr_sequencia_p;

	/*Processos*/

	delete from qua_doc_proc_emp where nr_seq_doc = nr_sequencia_p;

	/*Anexos*/

	delete from qua_doc_anexo where nr_seq_doc = nr_sequencia_p;

	/*Aprovadores*/

	delete from qua_doc_aprov where nr_seq_doc = nr_sequencia_p;

	/*Validadores*/

	delete from qua_doc_validacao where nr_seq_doc = nr_sequencia_p;

	/*Histórico*/

	delete from qua_doc_historico where nr_seq_documento = nr_sequencia_p;

	/*Necessita treinamento*/

	delete from qua_doc_nec_treinamento where nr_seq_documento = nr_sequencia_p;

	/*Trocas*/

	delete from qua_doc_troca_doc where nr_seq_documento = nr_sequencia_p;

	/*Documento*/

	delete from qua_documento where nr_sequencia = nr_sequencia_p;

	/*insert into logxxxxx_tasy values(sysdate, wheb_usuario_pck.get_nm_usuario, 55887, 'Excluído o documento da qualidade Seq.:' || nr_sequencia_p);
	commit;*/
	end;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE qua_excluir_documento ( nr_sequencia_p bigint) FROM PUBLIC;

