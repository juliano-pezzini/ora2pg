-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_gerar_arq_exp_benef_guia ( nr_seq_lote_p pls_conta_medica_ted.nr_sequencia%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nm_usuario_p usuario.nm_usuario%type) AS $body$
DECLARE

 
ds_conteudo_w			varchar(4000);
nm_arquivo_w			varchar(255);
ds_local_w			varchar(255) := null;
ds_erro_w			varchar(255);
arq_texto_w			utl_file.file_type;
qt_linha_w			integer;
ie_tipo_guia_w			pls_exp_guia_benef.ie_tipo_guia%type;
qt_guia_w			integer := 0;
vl_tot_pagamento_w		pls_exp_guia_benef.vl_tot_pagamento%type := 0;
vl_tot_recebimento_w		pls_exp_guia_benef.vl_tot_recebimento%type := 0;
ds_tipo_guia_w			varchar(255);
ds_tipo_guia_cab_w		varchar(255);
ie_origem_conta_w		pls_conta.ie_origem_conta%type;
nr_seq_congenere_w		pls_conta.nr_seq_congenere%type;
nm_congenere_w			varchar(255);
nr_seq_protocolo_w		pls_protocolo_conta.nr_sequencia%type;
nr_seq_nota_cobranca_w		pls_conta.nr_seq_nota_cobranca%type;
ds_especialidade_w		varchar(255);
ds_prestador_solicitante_w	varchar(255);
tx_coparticipacao_w		pls_conta_coparticipacao.tx_coparticipacao%type;
vl_coparticipacao_w		pls_conta_coparticipacao.vl_coparticipacao%type;
nr_seq_cong_w			pls_segurado_repasse.nr_seq_congenere%type;
ie_tipo_repasse_w		pls_segurado_repasse.ie_tipo_repasse%type;
ds_repasse_w			varchar(500);

 
C01 CURSOR(nr_seq_lote_pc		pls_conta_medica_ted.nr_sequencia%type) FOR 
	SELECT	substr(obter_valor_dominio(1746, ie_tipo_guia),1,255) ds_tipo_guia, 
		cd_guia, 
		cd_guia_aux, 
		nr_sequencia, 
		ie_tipo_guia, 
		dt_atendimento, 
		cd_doenca, 
		pls_convert_masc_cart_usuario(cd_usuario_plano,cd_estabelecimento_p) cd_usuario_plano, 
		nm_beneficiario, 
		ie_carater_internacao, 
		cd_especialidade, 
		ds_especialidade, 
		dt_emissao, 
		nr_seq_segurado, 
		ds_plano, 
		ie_tipo_contrato, 
		vl_tot_pagamento, 
		vl_tot_recebimento, 
		ds_prestador_solicitante, 
		nr_seq_conta 
	from	pls_exp_guia_benef 
	where	nr_seq_lote	= nr_seq_lote_pc 
	order by 1,2,3;
	
C02 CURSOR(nr_seq_exp_guia_pc	pls_exp_guia_benef.nr_sequencia%type) FOR 
	SELECT	nr_sequencia, 
		cd_item_amb, 
		cd_item_cbhpm, 
		ds_item, 
		qt_item, 
		cd_prestador_pagto, 
		ds_prestador_pagto, 
		qt_acomodacao, 
		vl_pagamento, 
		vl_recebimento, 
		ie_cobranca, 
		pr_fator, 
		nr_seq_conta_proc, 
		nr_seq_conta_mat 
	from	pls_exp_guia_benef_item 
	where	nr_seq_exp_guia	= nr_seq_exp_guia_pc;

BEGIN 
begin 
SELECT * FROM obter_evento_utl_file(16, null, ds_local_w, ds_erro_w) INTO STRICT ds_local_w, ds_erro_w;
exception 
when others then 
	ds_local_w := null;
end;
 
nm_arquivo_w	:= 'Conferencia de Guia.txt';
 
begin 
arq_texto_w := utl_file.fopen(ds_local_w,nm_arquivo_w,'W');
exception 
when others then 
	if (SQLSTATE = -29289) then 
		ds_erro_w := 'O acesso ao arquivo foi negado pelo sistema operacional (access_denied).';
	elsif (SQLSTATE = -29298) then 
		ds_erro_w := 'O arquivo foi aberto usando FOPEN_NCHAR, mas efetuaram-se operações de I/O usando funções nonchar comos PUTF ou GET_LINE (charsetmismatch).';
	elsif (SQLSTATE = -29291) then 
		ds_erro_w := 'Não foi possível apagar o arquivo (delete_failed).';
	elsif (SQLSTATE = -29286) then 
		ds_erro_w := 'Erro interno desconhecido no package UTL_FILE (internal_error).';
	elsif (SQLSTATE = -29282) then 
		ds_erro_w := 'O handle do arquivo não existe (invalid_filehandle).';
	elsif (SQLSTATE = -29288) then 
		ds_erro_w := 'O arquivo com o nome especificado não foi encontrado neste local (invalid_filename).';
	elsif (SQLSTATE = -29287) then 
		ds_erro_w := 'O valor de MAX_LINESIZE para FOPEN() é inválido; deveria estar na faixa de 1 a 32767 (invalid_maxlinesize).';
	elsif (SQLSTATE = -29281) then 
		ds_erro_w := 'O parâmetro open_mode na chamda FOPEN é inválido (invalid_mode).';
	elsif (SQLSTATE = -29290) then 
		ds_erro_w := 'O parâmetro ABSOLUTE_OFFSET para a chamada FSEEK() é inválido; deveria ser maior do que 0 e menor do que o número total de bytes do arquivo (invalid_offset).';
	elsif (SQLSTATE = -29283) then 
		ds_erro_w := 'O arquivo não pôde ser aberto ou operado da forma desejada - ou o caminho não foi encontrado (invalid_operation).';
	elsif (SQLSTATE = -29280) then 
		ds_erro_w := 'O caminho especificado não existe ou não está visível ao Oracle (invalid_path).';
	elsif (SQLSTATE = -29284) then 
		ds_erro_w := 'Não é possível efetuar a leitura do arquivo (read_error).';
	elsif (SQLSTATE = -29292) then 
		ds_erro_w := 'Não é possível renomear o arquivo.';
	elsif (SQLSTATE = -29285) then 
		ds_erro_w := 'Não foi possível gravar no arquivo (write_error).';
	else 
		ds_erro_w := 'Erro desconhecido no package UTL_FILE.';
	end if;
end;
 
-- Contas 
for r_C01_w in C01(nr_seq_lote_p) loop 
 
	qt_guia_w := qt_guia_w + 1;
	ds_conteudo_w := '------------------------------------------------------------------------------------------------------------------------------------';
	utl_file.put_line(arq_texto_w,ds_conteudo_w || chr(13));
	utl_file.fflush(arq_texto_w);
	ds_conteudo_w := null;
	qt_linha_w := qt_linha_w + 1;
	 
	 
	select	ie_origem_conta, 
		nr_seq_protocolo, 
		nr_seq_nota_cobranca 
	into STRICT	ie_origem_conta_w, 
		nr_seq_protocolo_w, 
		nr_seq_nota_cobranca_w 
	from	pls_conta 
	where	nr_sequencia = r_C01_w.nr_seq_conta;
	 
	--se a conta for de a500 não tera todas as informações do cursor neste caso pego das tabela abaixo	 
	if (ie_origem_conta_w = 'A') then 
		if (nr_seq_protocolo_w IS NOT NULL AND nr_seq_protocolo_w::text <> '') then 
			select	max(nr_seq_congenere) 
			into STRICT	nr_seq_congenere_w 
			from	pls_protocolo_conta 
			where	nr_sequencia = nr_seq_protocolo_w;
			 
			select	pls_obter_nome_congenere(nr_seq_congenere_w) 
			into STRICT	nm_congenere_w 
			;
		end if;
			 
		if (nr_seq_nota_cobranca_w IS NOT NULL AND nr_seq_nota_cobranca_w::text <> '') then 
			select	substr(pls_obter_desc_espec_ptu(max(cd_especialidade)), 1, 255), 
				substr(max(nm_prestador_requisitante), 1, 25) 
			into STRICT	ds_especialidade_w, 
				ds_prestador_solicitante_w 
			from	ptu_nota_servico 
			where	nr_seq_nota_cobr = nr_seq_nota_cobranca_w;
			 
			if (coalesce(trim(both ds_prestador_solicitante_w)::text, '') = '') then 
				ds_prestador_solicitante_w := substr(nm_congenere_w, 1, 25);
			end if;
		end if;
	else 
		--nm_congenere_w			:= r_C02_w.ds_prestador_pagto; 
		ds_especialidade_w		:= r_C01_w.ds_especialidade;
		ds_prestador_solicitante_w	:= r_C01_w.ds_prestador_solicitante;	
	end if;
	 
	--verifico se o beneficiário é de repasse 
	select	max(nr_seq_congenere), 
		max(ie_tipo_repasse) 
	into STRICT	nr_seq_cong_w, 
		ie_tipo_repasse_w 
	from	pls_segurado_repasse 
	where	nr_seq_segurado = r_C01_w.nr_seq_segurado;
	 
	if (nr_seq_cong_w IS NOT NULL AND nr_seq_cong_w::text <> '') and (ie_tipo_repasse_w IS NOT NULL AND ie_tipo_repasse_w::text <> '') then 
		select	'Repasse: '||pls_obter_nome_congenere(nr_seq_cong_w)||' 		Tipo repasse: '||CASE WHEN ie_tipo_repasse_w='C' THEN  'Custo Operacional'  ELSE 'Pré - Pagamento' END  
		into STRICT	ds_repasse_w 
		;
	else 
		ds_repasse_w := '';
	end if;	
	 
	-- Cabeçalho 
	qt_linha_w := 1;
	if (coalesce(ie_tipo_guia_w::text, '') = '') or (ie_tipo_guia_w <> r_C01_w.ie_tipo_guia) then 
		 
		while(qt_linha_w < 8) loop 
			 
			if (qt_linha_w = 1) then 
				ds_conteudo_w := 'UNIMED                        Conferência de guias                    FATRE05A Pag    ';
			 
			elsif (qt_linha_w = 2) then 
				ds_conteudo_w := 'Conferência de guias                                               '||to_char(clock_timestamp(),'dd/mm/yyyy hh24:mi:ss');
			 
			elsif (qt_linha_w = 3) then 
				ds_conteudo_w := '------------------------------------------------------------------------------------------------------------------------------------';
			 
			elsif (qt_linha_w = 4) then 
				ds_conteudo_w := null;
				 
			elsif (qt_linha_w = 5) then 
				select	upper(CASE WHEN r_C01_w.ie_tipo_guia='5' THEN 'internacoes' WHEN r_C01_w.ie_tipo_guia='3' THEN 'consultas' WHEN r_C01_w.ie_tipo_guia='4' THEN 'SP/SADT' WHEN r_C01_w.ie_tipo_guia='6' THEN 'honorario individual'  ELSE substr(obter_valor_dominio(1746,r_C01_w.ie_tipo_guia),1,255) END ) 
				into STRICT	ds_tipo_guia_cab_w 
				;
			 
				ds_conteudo_w := '******** '||ds_tipo_guia_cab_w||' ********';
				 
			elsif (qt_linha_w in (6,7)) then 
				ds_conteudo_w := null;
 
			end if;
 
			utl_file.put_line(arq_texto_w,ds_conteudo_w || chr(13));
			utl_file.fflush(arq_texto_w);
			ds_conteudo_w := null;
			qt_linha_w := qt_linha_w + 1;
		end loop;
		 
		ie_tipo_guia_w := r_C01_w.ie_tipo_guia;
	else	 
		ds_conteudo_w := null;
		utl_file.put_line(arq_texto_w,ds_conteudo_w || chr(13));
		utl_file.fflush(arq_texto_w);
		ds_conteudo_w := null;
	end if;
	 
	-- Informações das contas 
	qt_linha_w := 1;
	while(qt_linha_w < 6) loop 
	 
		if (qt_linha_w = 1) then 
			ds_conteudo_w :=	'Guia:'||lpad(coalesce(r_C01_w.cd_guia,' '),10,' ')||' - '||to_char(r_C01_w.dt_atendimento,'dd/mm/yyyy hh24:mi')||' CID10:'||lpad(coalesce(r_C01_w.cd_doenca,' '),5,' ')|| 
						'  Benefi.:'||lpad(coalesce(r_C01_w.cd_usuario_plano,' '),21,' ')||' - '||rpad(coalesce(r_C01_w.nm_beneficiario,' '),33,' ')||'N.Aux: '||rpad(coalesce(r_C01_w.cd_guia_aux,' '),10,' ');
 
		elsif (qt_linha_w = 2) then 
			select	upper(CASE WHEN r_C01_w.ie_tipo_guia='5' THEN 'internacao' WHEN r_C01_w.ie_tipo_guia='3' THEN 'consulta' WHEN r_C01_w.ie_tipo_guia='4' THEN 'SP/SADT' WHEN r_C01_w.ie_tipo_guia='6' THEN 'honorario individual'  ELSE substr(obter_valor_dominio(1746,r_C01_w.ie_tipo_guia),1,255) END ) 
			into STRICT	ds_tipo_guia_w 
			;
		 
			ds_conteudo_w :=	'     Tipo Guia: '||rpad(coalesce(ds_tipo_guia_w,' '),49,' ')||'Especialidade: '||lpad(coalesce(to_char(r_C01_w.cd_especialidade),' '),4,' ')|| 
						' '||rpad(coalesce(ds_especialidade_w,' '),20,' ')||'Dt.emissao: '||to_char(r_C01_w.dt_emissao,'dd/mm/yyyy');
		 
		elsif (qt_linha_w = 3) then		 
			ds_conteudo_w :=	'Plano: '||rpad(coalesce(r_C01_w.ds_plano,' '),32,' ')||'Tipo de Contrato: '||rpad(coalesce(r_C01_w.ie_tipo_contrato,' '),20,' ');
		 
		elsif (qt_linha_w = 4) then 
			ds_conteudo_w := substr(ds_repasse_w, 1, 500);
		 
		elsif (qt_linha_w = 5) then 
			ds_conteudo_w :=	'Cód. AMB Cód CBHPM Descrição            Qtde Prestador             Acom Vl Pagto  V.Rec. Cobrar  %Fator ';
		end if;
		 
		utl_file.put_line(arq_texto_w,ds_conteudo_w || chr(13));
		utl_file.fflush(arq_texto_w);
		ds_conteudo_w := null;
		qt_linha_w := qt_linha_w + 1;
	end loop;
	 
	-- Procedimentos/Materiais 
	for r_C02_w in C02(r_C01_w.nr_sequencia) loop 
	 
		if (r_C02_w.nr_seq_conta_proc IS NOT NULL AND r_C02_w.nr_seq_conta_proc::text <> '') then 
			select	max(tx_coparticipacao), 
				sum(vl_coparticipacao) 
			into STRICT	tx_coparticipacao_w, 
				vl_coparticipacao_w 
			from	pls_conta_coparticipacao 
			where	nr_seq_conta_proc = r_C02_w.nr_seq_conta_proc;
		elsif (r_C02_w.nr_seq_conta_mat IS NOT NULL AND r_C02_w.nr_seq_conta_mat::text <> '') then 
			select	max(tx_coparticipacao), 
				sum(vl_coparticipacao) 
			into STRICT	tx_coparticipacao_w, 
				vl_coparticipacao_w 
			from	pls_conta_coparticipacao 
			where	nr_seq_conta_mat = r_C02_w.nr_seq_conta_mat;
		end if;	
						 
		ds_conteudo_w :=	lpad(coalesce(to_char(r_C02_w.cd_item_amb),' '),8,' ')||' '|| 
					lpad(coalesce(to_char(r_C02_w.cd_item_cbhpm),' '),9,' ')||' '|| 
					rpad(coalesce(r_C02_w.ds_item,' '),31,' ')||' '|| 
					lpad(coalesce(to_char(campo_mascara_virgula(r_C02_w.qt_item)),' '),5,' ')|| 
					lpad(coalesce(r_C02_w.cd_prestador_pagto,' '),6,' ')||' - '|| 
					rpad(coalesce(nm_congenere_w, r_C02_w.ds_prestador_pagto),25,' ')||' '|| 
					lpad(coalesce(to_char(campo_mascara_virgula(r_C02_w.qt_acomodacao)),' '),4,' ')||' '|| 
					lpad(coalesce(to_char(campo_mascara_virgula(r_C02_w.vl_pagamento)),' '),9,' ')||' '|| 
					lpad(coalesce(to_char(campo_mascara_virgula(vl_coparticipacao_w)),' '),9,' ')||' '|| 
					lpad(coalesce(r_C02_w.ie_cobranca,' '),6,' ')|| 
					lpad(coalesce(to_char(campo_mascara_virgula(tx_coparticipacao_w)),' '),9,' ');
			  
		utl_file.put_line(arq_texto_w,ds_conteudo_w || chr(13));
		utl_file.fflush(arq_texto_w);
		ds_conteudo_w := null;
	end loop;
	 
	-- Totais 
	qt_linha_w := 1;
	while(qt_linha_w < 3) loop 
	 
		ds_conteudo_w := null;
		if (qt_linha_w = 2) then 
			ds_conteudo_w := 	'   Vlr.Total Pagto.:'||lpad(coalesce(to_char(campo_mascara_virgula(r_C01_w.vl_tot_pagamento)),' '),11,' ')|| 
						'       Vlr.Total Receb.:'||lpad(coalesce(to_char(campo_mascara_virgula(r_C01_w.vl_tot_recebimento)),' '),11,' ')|| 
						' Requisitante : '||rpad(coalesce(ds_prestador_solicitante_w,' '),41,' ');
		end if;
		 
		utl_file.put_line(arq_texto_w,ds_conteudo_w || chr(13));
		utl_file.fflush(arq_texto_w);
		ds_conteudo_w := null;
		qt_linha_w := qt_linha_w + 1;
 
	end loop;
	 
	vl_tot_pagamento_w	:= vl_tot_pagamento_w + r_C01_w.vl_tot_pagamento;
	vl_tot_recebimento_w	:= vl_tot_recebimento_w + r_C01_w.vl_tot_recebimento;
end loop;
 
-- Rodapé 
qt_linha_w := 1;
while(qt_linha_w < 8) loop 
 
	if (qt_linha_w = 1) then 
		ds_conteudo_w := 	'------------------------------------------------------------------------------------------------------------------------------------';
	 
	elsif (qt_linha_w in (2,4,6)) then 
		ds_conteudo_w := null;
		 
	elsif (qt_linha_w = 3) then 
		ds_conteudo_w := 	'Total de Guias no periodo:'||lpad(coalesce(to_char(qt_guia_w),' '),11,' ');
		 
	elsif (qt_linha_w = 5) then 
		ds_conteudo_w := 	'Valor Total a Pagar......:'||lpad(coalesce(to_char(vl_tot_pagamento_w),' '),16,' ');
	 
	elsif (qt_linha_w = 7) then 
		ds_conteudo_w := 	'Valor Total a Receber....:'||lpad(coalesce(to_char(vl_tot_recebimento_w),' '),16,' ');
	end if;
	 
	utl_file.put_line(arq_texto_w,ds_conteudo_w || chr(13));
	utl_file.fflush(arq_texto_w);
	ds_conteudo_w := null;
	qt_linha_w := qt_linha_w + 1;
 
end loop;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_gerar_arq_exp_benef_guia ( nr_seq_lote_p pls_conta_medica_ted.nr_sequencia%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nm_usuario_p usuario.nm_usuario%type) FROM PUBLIC;

