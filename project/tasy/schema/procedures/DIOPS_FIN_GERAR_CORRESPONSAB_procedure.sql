-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE diops_fin_gerar_corresponsab ( nr_seq_operadora_p bigint, nr_seq_transacao_p bigint, nr_seq_periodo_p bigint, nm_usuario_p text) AS $body$
DECLARE


cd_ans_w			varchar(4000);
vl_credito_operadoras_w		double precision;
cd_estabelecimento_w		bigint;
dt_periodo_inicial_w		timestamp;
dt_periodo_final_w		timestamp;

C01 CURSOR FOR
	SELECT	cd_ans,
		coalesce(sum(vl_credito_operadoras),0)
	from  	w_diops_fin_idadesaldo_ati
	where	nr_seq_periodo	= nr_seq_periodo_p
	and	(cd_ans IS NOT NULL AND cd_ans::text <> '')
	group by cd_ans;


BEGIN
/* Obter o per√≠odo trimestral do DIOPS */

begin
select	coalesce(dt_periodo_inicial,''),
	coalesce(dt_periodo_final, '')
into STRICT	dt_periodo_inicial_w,
	dt_periodo_final_w
from	diops_periodo
where	nr_sequencia	= nr_seq_periodo_p;
exception
	when others then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(174234, 'NR_SEQ_OPERADORA=' || nr_seq_operadora_p || ';' ||
							'NR_SEQ_PERIODO=' || nr_seq_periodo_p);
end;

/* Obter o estabelecimento da operadora */

begin
select	cd_estabelecimento
into STRICT	cd_estabelecimento_w
from	pls_outorgante
where	nr_sequencia	= nr_seq_operadora_p;
exception
	when others then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(183309,'NR_SEQ_OPERADORA=' || nr_seq_operadora_p);
end;

open C01;
loop
fetch C01 into
	cd_ans_w,
	vl_credito_operadoras_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	insert into diops_fin_corresp(nr_sequencia,
		nm_usuario_nrec,
		dt_atualizacao_nrec,
		nm_usuario,
		dt_atualizacao,
		cd_estabelecimento,
		nr_seq_operadora,
		nr_seq_periodo,
		cd_ans,
		vl_saldo,
		ie_tipo)
	values (nextval('diops_fin_corresp_seq'),
		nm_usuario_p,
		clock_timestamp(),
		nm_usuario_p,
		clock_timestamp(),
		cd_estabelecimento_w,
		nr_seq_operadora_p,
		nr_seq_periodo_p,
		cd_ans_w,
		vl_credito_operadoras_w,
		'A');
	end;
end loop;
close C01;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE diops_fin_gerar_corresponsab ( nr_seq_operadora_p bigint, nr_seq_transacao_p bigint, nr_seq_periodo_p bigint, nm_usuario_p text) FROM PUBLIC;

