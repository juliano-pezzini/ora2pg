-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_aviso_tolerancia_npi ( nm_usuario_p text) AS $body$
DECLARE


qt_regra_tol_w			bigint;
nr_seq_etapa_processo_w		bigint;
nr_seq_area_proc_partic_w		bigint;
nr_seq_projeto_w			bigint;
qt_tolerancia_w			real;
ie_envolvidos_w			varchar(1);
ie_comunic_interna_w		varchar(1);
ie_via_email_w			varchar(1);
nm_usuario_w			varchar(15);
ds_titulo_w			varchar(80);
ds_atividade_w			varchar(255);
ds_email_w			varchar(255);
dt_fim_real_w			timestamp;
dt_inicio_prev_w		timestamp;
dt_fim_prev_w			timestamp;
ds_texto_w			varchar(255);
ds_texto_ww			varchar(255);

C01 CURSOR FOR
	SELECT	a.nr_seq_etapa_processo,
		a.nr_seq_area_proc_partic,
		a.ie_envolvidos,
		a.ie_comunic_interna,
		a.ie_via_email,
		a.qt_tolerancia
	from	prp_regra_tolerancia a;

C02 CURSOR FOR
	SELECT (	SELECT	coalesce(max(o.dt_fim_atividade),clock_timestamp())
			from	man_ordem_serv_ativ o
			where	o.nr_seq_ordem_serv = m.nr_sequencia) dt_fim_real,
		a.dt_inicio_prev,
		a.dt_fim_prev,
		p.nr_sequencia,
		p.ds_titulo,
		a.ds_atividade
	from	proj_projeto p,
		proj_cronograma c,
		proj_cron_etapa a,
		man_ordem_servico m,
		prp_processo_etapa e
	where	p.nr_sequencia = c.nr_seq_proj
	and	c.nr_sequencia = a.nr_seq_cronograma
	and	a.nr_Sequencia = m.nr_seq_proj_cron_etapa
	and	e.nr_sequencia = a.nr_seq_processo_etapa
	and	e.nr_seq_etapa_processo = nr_seq_etapa_processo_w
	and	(p.nr_seq_tipo_projeto IS NOT NULL AND p.nr_seq_tipo_projeto::text <> '')
	and	a.ie_status_etapa in ('2','3');

C03 CURSOR FOR
	SELECT	u.nm_usuario,
		u.ds_email
	from	prp_processo a,
		prp_processo_fase b,
		prp_processo_etapa c,
		prp_processo_etapa_partic d,
		usuario u
	where	a.nr_sequencia = b.nr_seq_processo
	and	b.nr_sequencia = c.nr_seq_processo_fase
	and	c.nr_sequencia = d.nr_seq_processo_etapa
	and	u.cd_pessoa_fisica = d.cd_pessoa_fisica
	and	a.nr_seq_projeto = nr_seq_projeto_w
	and	ie_envolvidos_w = 'S'
	
union all

	SELECT	u.nm_usuario,
		u.ds_email
	from	proj_equipe a,
		proj_equipe_papel b,
		usuario u
	where	a.nr_sequencia = b.nr_seq_equipe
	and	u.cd_pessoa_fisica = b.cd_pessoa_fisica
	and	a.nr_seq_proj = nr_seq_projeto_w
	and	ie_envolvidos_w = 'N';

BEGIN

select	count(*)
into STRICT	qt_regra_tol_w
from	prp_regra_tolerancia a;

if (qt_regra_tol_w > 0) then

	open C01;
	loop
	fetch C01 into
		nr_seq_etapa_processo_w,
		nr_seq_area_proc_partic_w,
		ie_envolvidos_w,
		ie_comunic_interna_w,
		ie_via_email_w,
		qt_tolerancia_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin

		open C02;
		loop
		fetch C02 into
			dt_fim_real_w,
			dt_inicio_prev_w,
			dt_fim_prev_w,
			nr_seq_projeto_w,
			ds_titulo_w,
			ds_atividade_w;
		EXIT WHEN NOT FOUND; /* apply on C02 */
			begin

			if (dt_fim_real_w > dt_fim_prev_w) then

				if (dividir((obter_dias_entre_datas(dt_inicio_prev_w,dt_fim_real_w)*100),obter_dias_entre_datas(dt_inicio_prev_w,dt_fim_prev_w)) >= qt_tolerancia_w+100) then

					open C03;
					loop
					fetch C03 into
						nm_usuario_w,
						ds_email_w;
					EXIT WHEN NOT FOUND; /* apply on C03 */
						begin

						if (ie_comunic_interna_w = 'S') then

							ds_texto_w	:= substr(wheb_mensagem_pck.get_texto(311542),1,255);--Aviso de tolerância excedida
							--A etapa (#@DS_ATIVIDADE_P#@) do projeto #@NR_SEQ_PROJETO_P#@ - #@DS_TITULO_P#@ excedido p percentual de #@QT_TOLERANCIA_P#@ %
							ds_texto_ww	:= substr(wheb_mensagem_pck.get_texto(311543,'DS_ATIVIDADE_P='|| ds_atividade_w ||
														';NR_SEQ_PROJETO_P='|| nr_seq_projeto_w ||
														';DS_TITULO_P='|| ds_titulo_w ||
														';QT_TOLERANCIA_P='|| qt_tolerancia_w ),1,255);
							CALL gerar_comunic_padrao(	clock_timestamp(),
								'PRP/NPI - '|| ds_texto_w,
								ds_texto_ww,
								'Tasy',
								'N',
								nm_usuario_w,
								'N',
								'',
								'',
								'',
								'',
								clock_timestamp(),
								'',
								'');

						end if;

						if (ie_via_email_w = 'S') then
							ds_texto_w := substr(wheb_mensagem_pck.get_texto(311542),1,255);--Aviso de tolerância excedida
							--A etapa (#@DS_ATIVIDADE_P#@) do projeto #@NR_SEQ_PROJETO_P#@ - #@DS_TITULO_P#@ excedido p percentual de #@QT_TOLERANCIA_P#@ %
							ds_texto_ww	:= substr(wheb_mensagem_pck.get_texto(311543,'DS_ATIVIDADE_P='|| ds_atividade_w ||
														';NR_SEQ_PROJETO_P='|| nr_seq_projeto_w ||
														';DS_TITULO_P='|| ds_titulo_w ||
														';QT_TOLERANCIA_P='|| qt_tolerancia_w ),1,255);
							CALL enviar_email(
							'PRP/NPI - '|| ds_texto_w,
							ds_texto_ww,
							'support.informatics@philips.com',
							ds_email_w,
							nm_usuario_p,
							'A');

						end if;

						end;
					end loop;
					close C03;

				end if;

			end if;

			end;
		end loop;
		close C02;

		end;
	end loop;
	close C01;

end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_aviso_tolerancia_npi ( nm_usuario_p text) FROM PUBLIC;

