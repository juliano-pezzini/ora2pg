-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE hem_gerar_calculos_fick ( nr_seq_hem_calc_p bigint, nm_usuario_p text, ds_mensagem_p INOUT text) AS $body$
DECLARE


C01 CURSOR FOR
	SELECT	coalesce(qt_saturacao_o2,0),
		coalesce(qt_po2,0),
		coalesce(qt_pam,0),
		coalesce(qt_pa_diastolica_fim,0),
		ie_tipo
	from	hem_manometria_completa
	where	nr_seq_hem_calc	= nr_seq_hem_calc_p;

qt_saturacao_w		hem_manometria_completa.qt_saturacao_o2%type;
qt_po2_w		hem_manometria_completa.qt_po2%type;
qt_pam_w		hem_manometria_completa.qt_pam%type;
ie_tipo_w		hem_manometria_completa.ie_tipo%type;
qt_fluxo_sist_w		hem_calc_hem_result.qt_fluxo_sist%type;
qt_deb_sist_w		hem_calc_hem_result.qt_deb_sist%type;
qt_fluxo_pulmonar_w	hem_calc_hem_result.qt_fluxo_pulmonar%type;
qt_ind_card_w		hem_calc_hem_result.qt_ind_card%type;
qt_rv_sistemica_w	hem_calc_hem_result.qt_rv_sistemica%type;
qt_rv_tot_w		hem_calc_hem_result.qt_rv_tot%type;
qt_rv_pulmonar_w	hem_calc_hem_result.qt_rv_pulmonar%type;
qt_rvp_rvs_w		hem_calc_hem_result.qt_rvp_rvs%type;
qt_gradiente_w		hem_calc_hem_result.qt_gradiente%type;
qt_area_valvula_w	hem_calc_hem_result.qt_area_valvula%type;
qt_cons_est_o2_w	hem_calc_hemodinamico.qt_cons_est_o2%type;
qt_superf_corporia_w	hem_calc_hemodinamico.qt_superf_corporia%type;
qt_hb_w			hem_calc_hemodinamico.qt_hb%type;
qt_freq_cardiaca_w	hem_calc_hemodinamico.qt_freq_cardiaca%type;
qt_ench_sist_w		hem_calc_hemodinamico.qt_ench_sist%type;
qt_po2_AO_w		hem_manometria_completa.qt_po2%type;
qt_saturacao_o2_AO_w	hem_manometria_completa.qt_saturacao_o2%type;
qt_po2_TP_w		hem_manometria_completa.qt_po2%type;
qt_saturacao_o2_TP_w	hem_manometria_completa.qt_saturacao_o2%type;
qt_po2_AE_w		hem_manometria_completa.qt_po2%type;
qt_saturacao_o2_AE_w	hem_manometria_completa.qt_saturacao_o2%type;
qt_po2_VC_w		hem_manometria_completa.qt_po2%type;
qt_saturacao_o2_VC_w	hem_manometria_completa.qt_saturacao_o2%type;
qt_pam_TP_w		hem_manometria_completa.qt_pam%type;
qt_pam_AD_w		hem_manometria_completa.qt_pam%type;
qt_pam_AO_w		hem_manometria_completa.qt_pam%type;
qt_pam_CP_w		hem_manometria_completa.qt_pam%type;
qt_pa_fim_VE_w		hem_manometria_completa.qt_pa_diastolica_fim%type;
qt_pa_diastolica_fim_w	hem_manometria_completa.qt_pa_diastolica_fim%type;
qt_rv_sistemica_wood_w	hem_calc_hem_result.qt_rv_sistemica_wood%type;
qt_rv_tot_wood_w	hem_calc_hem_result.qt_rv_tot_wood%type;
qt_rv_pulmonar_wood_w	hem_calc_hem_result.qt_rv_pulmonar_wood%type;
qt_total_O2_AO_w	double precision;
qt_total_O2_TP_w	double precision;
qt_diferenca_w		double precision;
ds_erro_w		varchar(255);
qt_registro_w		bigint;


BEGIN
if (coalesce(nr_seq_hem_calc_p, 0) > 0) then

	-- VALORES CALCULOS HEMODINÂMICOS
	select	max(qt_cons_est_o2),
		max(qt_hb),
		max(qt_superf_corporia),
		max(qt_freq_cardiaca),
		max(qt_ench_sist)
	into STRICT	qt_cons_est_o2_w,
		qt_hb_w,
		qt_superf_corporia_w,
		qt_freq_cardiaca_w,
		qt_ench_sist_w
	from	hem_calc_hemodinamico
	where	nr_sequencia = nr_seq_hem_calc_p;

	open C01;
	loop
	fetch C01 into
		qt_saturacao_w,
		qt_po2_w,
		qt_pam_w,
		qt_pa_diastolica_fim_w,
		ie_tipo_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin
		if (ie_tipo_w = 'AO') then
			qt_saturacao_o2_AO_w	:= qt_saturacao_w;
			qt_po2_AO_w		:= qt_po2_w;
			qt_pam_AO_w		:= qt_pam_w;
		end if;
		if (ie_tipo_w = 'TP') then
			qt_saturacao_o2_TP_w	:= qt_saturacao_w;
			qt_po2_TP_w		:= qt_po2_w;
			qt_pam_TP_w		:= qt_pam_w;
		end if;
		if (ie_tipo_w = 'AD') then
			qt_pam_AD_w		:= qt_pam_w;
		end if;
		if (ie_tipo_w = 'CP') then
			qt_pam_CP_w		:= qt_pam_w;
		end if;
		if (ie_tipo_w = 'VE') then
			qt_pa_fim_VE_w		:= qt_pa_diastolica_fim_w;
		end if;
		end;
	end loop;
	close C01;

	begin
		qt_total_O2_AO_w	:= qt_hb_w *1.34 *(qt_saturacao_o2_AO_w/100)+0.003*qt_po2_AO_w; 	--Qtotal de O2 em Ao
	exception when others then
		qt_total_O2_AO_w := null;
	end;
	begin
	qt_total_O2_TP_w	:= qt_hb_w *1.34 *(qt_saturacao_o2_TP_w/100)+0.003*qt_po2_TP_w; 		--Qtotal de O2 em TP
	exception when others then
		qt_total_O2_TP_w := null;
	end;
	begin
	qt_diferenca_w := qt_total_O2_AO_w - qt_total_O2_TP_w;
	exception when others then
		qt_diferenca_w := null;
	end;

	begin
		qt_fluxo_sist_w		:= qt_cons_est_o2_w / (qt_diferenca_w *10); 	--Fluxo Sist (l/min)
	exception when others then
		qt_fluxo_sist_w := null;
	end;

	begin
		qt_deb_sist_w		:= qt_fluxo_sist_w * 1000/ qt_freq_cardiaca_w;				--Débito sistólico (ml)
	exception when others then
		qt_deb_sist_w := null;
	end;
	begin
		qt_fluxo_pulmonar_w	:= qt_cons_est_o2_w / (qt_diferenca_w *10); 				--Fluxo Pulm (l/min)
	exception when others then
		qt_fluxo_pulmonar_w := null;
	end;
	begin
		qt_ind_card_w		:= qt_fluxo_sist_w / qt_superf_corporia_w;				--Índ card (l/min/m2)
	exception when others then
		qt_ind_card_w := null;
	end;
	begin
		qt_rv_sistemica_w	:= (qt_pam_AO_w - qt_pam_AD_w) / qt_fluxo_sist_w * 80;		-- RVS (dyna.seg.cm-5)
	exception when others then
		qt_rv_sistemica_w := null;
	end;
	begin
		qt_rv_tot_w		:= qt_pam_TP_w / qt_fluxo_pulmonar_w * 80;				--RVP tot (dyna.seg.cm-5)
	exception when others then
		qt_rv_tot_w := null;
	end;
	begin
		qt_rv_pulmonar_w	:= (qt_pam_TP_w - qt_pam_CP_w) / qt_fluxo_pulmonar_w * 80;		--RPart.(dyna.seg.cm-5)
	exception when others then
		qt_rv_pulmonar_w := null;
	end;
	begin
		qt_rv_sistemica_wood_w	:= (qt_pam_AO_w - qt_pam_AD_w) / qt_fluxo_sist_w;			-- RVS (wood)
	exception when others then
		qt_rv_sistemica_wood_w := null;
	end;
	begin
		qt_rv_tot_wood_w		:= qt_pam_TP_w / qt_fluxo_pulmonar_w;				--RVP tot (wood)
	exception when others then
		qt_rv_tot_wood_w := null;
	end;
	begin
		qt_rv_pulmonar_wood_w	:= (qt_pam_TP_w - qt_pam_CP_w) / qt_fluxo_pulmonar_w;		--RPart.(wood)
	exception when others then
		qt_rv_pulmonar_wood_w := null;
	end;
	begin
		qt_rvp_rvs_w		:= qt_rv_tot_w / qt_rv_sistemica_w;
	exception
	when others then
		qt_rvp_rvs_w := null;
	end;
	begin
		qt_gradiente_w		:= qt_pam_CP_w - qt_pa_fim_VE_w;
	exception
	when others then
		qt_gradiente_w := null;
	end;
	begin
		qt_area_valvula_w		:= (qt_deb_sist_w/qt_ench_sist_w)/(0.85*44.3*sqrt(qt_gradiente_w));
	exception
	when others then
		qt_area_valvula_w := null;
	end;

	select	count(*)
	into STRICT	qt_registro_w
	from	hem_calc_hem_result
	where	nr_seq_calc_hemo = nr_seq_hem_calc_p;

	if (coalesce(qt_deb_sist_w::text, '') = '') then
		ds_erro_w	:= obter_desc_expressao(643063)||';'||ds_erro_w;
	end if;
	if (coalesce(qt_fluxo_sist_w::text, '') = '') then
		ds_erro_w	:= obter_desc_expressao(643064)||';'||	ds_erro_w;
	end if;
	if (coalesce(qt_fluxo_pulmonar_w::text, '') = '') then
		ds_erro_w	:= obter_desc_expressao(643066)||';'||	ds_erro_w;
	end if;
	if (coalesce(qt_ind_card_w::text, '') = '') then
		ds_erro_w	:= obter_desc_expressao(291869)||';'||	ds_erro_w;
	end if;
	if (coalesce(qt_rv_sistemica_w::text, '') = '') then
		ds_erro_w	:= obter_desc_expressao(297957)||';'||	ds_erro_w;
	end if;
	if (coalesce(qt_rv_pulmonar_w::text, '') = '') then
		ds_erro_w	:= obter_desc_expressao(297956)||';'||	ds_erro_w;
	end if;
	if (coalesce(qt_rvp_rvs_w::text, '') = '') then
		ds_erro_w	:= obter_desc_expressao(643068)||';'||	ds_erro_w;
	end if;
	if (coalesce(qt_rv_tot_w::text, '') = '') then
		ds_erro_w	:= obter_desc_expressao(643070)||';'||	ds_erro_w;
	end if;
	if (coalesce(qt_gradiente_w::text, '') = '') then
		ds_erro_w	:= obter_desc_expressao(643640)||';'||	ds_erro_w;
	end if;
	if (coalesce(qt_area_valvula_w::text, '') = '') then
		ds_erro_w	:= obter_desc_expressao(643645)||';'||	ds_erro_w;
	end if;
	if (coalesce(qt_rv_sistemica_wood_w::text, '') = '') then
		ds_erro_w	:= obter_desc_expressao(731502)||';'||	ds_erro_w;
	end if;
	if (coalesce(qt_rv_tot_wood_w::text, '') = '') then
		ds_erro_w	:= obter_desc_expressao(731506)||';'||	ds_erro_w;
	end if;
	if (coalesce(qt_rv_pulmonar_wood_w::text, '') = '') then
		ds_erro_w	:= obter_desc_expressao(731508)||';'||	ds_erro_w;
	end if;

	if (qt_registro_w = 0) then

		insert into hem_calc_hem_result(
			nr_sequencia,
			dt_atualizacao,
			nm_usuario,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			nr_seq_calc_hemo,
			qt_deb_sist,
			qt_fluxo_sist,
			qt_rv_sistemica,
			qt_rv_pulmonar,
			qt_ind_card,
			qt_rvp_rvs,
			qt_fluxo_pulmonar,
			qt_rv_tot,
			qt_gradiente,
			qt_area_valvula,
			qt_rv_sistemica_wood,
			qt_rv_tot_wood,
			qt_rv_pulmonar_wood
		) values (
			nextval('hem_calc_hem_result_seq'),
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			nr_seq_hem_calc_p,
			qt_deb_sist_w,
			qt_fluxo_sist_w,
			qt_rv_sistemica_w,
			qt_rv_pulmonar_w,
			qt_ind_card_w,
			qt_rvp_rvs_w,
			qt_fluxo_pulmonar_w,
			qt_rv_tot_w,
			qt_gradiente_w,
			qt_area_valvula_w,
			qt_rv_sistemica_wood_w,
			qt_rv_tot_wood_w,
			qt_rv_pulmonar_wood_w);
	else
		update hem_calc_hem_result
		set	dt_atualizacao		= clock_timestamp(),
			nm_usuario		= nm_usuario_p,
			qt_fluxo_sist		= qt_fluxo_sist_w,
			qt_rv_sistemica		= qt_rv_sistemica_w,
			qt_rv_pulmonar		= qt_rv_pulmonar_w,
			qt_ind_card		= qt_ind_card_w,
			qt_rvp_rvs		= qt_rvp_rvs_w,
			qt_fluxo_pulmonar	= qt_fluxo_pulmonar_w,
			qt_rv_tot		= qt_rv_tot_w,
			qt_deb_sist		= qt_deb_sist_w,
			qt_rv_sistemica_wood = qt_rv_sistemica_wood_w,
			qt_rv_tot_wood	= qt_rv_tot_wood_w,
			qt_rv_pulmonar_wood = qt_rv_pulmonar_wood_w
		where	nr_seq_calc_hemo	= nr_seq_hem_calc_p;

	end if;
end if;

commit;

ds_mensagem_p	:= ds_erro_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE hem_gerar_calculos_fick ( nr_seq_hem_calc_p bigint, nm_usuario_p text, ds_mensagem_p INOUT text) FROM PUBLIC;

