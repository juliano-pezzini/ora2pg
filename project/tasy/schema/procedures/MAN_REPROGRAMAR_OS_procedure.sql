-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE man_reprogramar_os ( nr_seq_ordem_p bigint, nr_seq_estagio_p bigint, dt_inicio_previsto_p timestamp, dt_fim_previsto_p timestamp, nr_seq_motivo_reprog_p bigint, ds_observacao_p text, ie_comunic_usuario_p bigint, nr_seq_tipo_hist_p bigint, nm_usuario_p text, ie_envia_ci_p text, ie_envia_email_p text) AS $body$
DECLARE

 
nr_seq_classif_w			bigint;
nm_usuario_dest_w			varchar(15);
ds_usuarios_destino_w		varchar(4000);
ds_titulo_w					varchar(255);
ds_comunicado_w				varchar(2000);
ds_motivo_w					varchar(255);
ds_email_w					varchar(255);
ds_lista_email_w			varchar(4000);
ie_email_valido_w			varchar(1);
ds_email_origem_w			varchar(255);
ds_estagio_w				varchar(255);
nr_grupo_planej_w			man_ordem_servico.nr_grupo_planej%type;
nr_seq_estagio_w			man_ordem_servico.nr_seq_estagio%type;
dt_inicio_previsto_w		man_ordem_servico.dt_inicio_previsto%type;
dt_fim_previsto_w			man_ordem_servico.dt_fim_previsto%type;

nr_seq_localizacao_w		man_localizacao.nr_sequencia%type;
cd_cnpj_w					man_localizacao.cd_cnpj%type;
nr_seq_idioma_w				pessoa_juridica.nr_seq_idioma%type;
ds_relat_tecnico_w			man_ordem_serv_tecnico.ds_relat_tecnico%type;

 
c01 CURSOR FOR 
SELECT	distinct 
	b.nm_usuario_exec, 
	a.ds_email 
from	man_ordem_servico_exec b, 
	usuario a 
where	b.nr_seq_ordem = nr_seq_ordem_p 
and	a.nm_usuario = b.nm_usuario_exec;


BEGIN 
if (nr_seq_ordem_p > 0) then 
	select	nr_seq_estagio, 
		dt_inicio_previsto, 
		dt_fim_previsto, 
		nr_grupo_planej, 
		nr_seq_localizacao 
	into STRICT	nr_seq_estagio_w, 
		dt_inicio_previsto_w, 
		dt_fim_previsto_w, 
		nr_grupo_planej_w, 
		nr_seq_localizacao_w 
	from	man_ordem_servico 
	where	nr_sequencia = nr_seq_ordem_p;
 
	update	man_ordem_servico 
	set	nr_seq_estagio 		= nr_seq_estagio_p, 
		dt_inicio_previsto 		= dt_inicio_previsto_p, 
		dt_fim_previsto 		= dt_fim_previsto_p, 
		nr_seq_motivo_reprog 	= nr_seq_motivo_reprog_p, 
		dt_reprogramacao 		= clock_timestamp(), 
		nm_usuario_reprog 		= nm_usuario_p 
	where	nr_sequencia 		= nr_seq_ordem_p;
 
	ds_lista_email_w := '';
 
	select	substr(obter_dados_usuario_opcao(nm_usuario_p,'E'),1,255) 
	into STRICT	ds_email_origem_w 
	;
 
	if (ie_comunic_usuario_p in (0,2)) then 
		open c01;
		loop 
		fetch c01 into	 
			nm_usuario_dest_w, 
			ds_email_w;
		EXIT WHEN NOT FOUND; /* apply on c01 */
			begin 
			ds_usuarios_destino_w := substr(ds_usuarios_destino_w || nm_usuario_dest_w || ', ',1,4000);
			if (ds_email_w <> '') then 
				select	substr(obter_se_email_valido(ds_email_w),1,1) 
				into STRICT	ie_email_valido_w 
				;
				 
				if (ie_email_valido_w = 'S') then 
					ds_lista_email_w := substr(ds_lista_email_w || ds_email_w || ';',1,4000);
				end if;
			end if;
			end;
		end loop;
		close c01;
	end if;
 
	if (ie_comunic_usuario_p in (1,2)) then 
		select	substr(obter_usuario_pessoa(cd_pessoa_solicitante),1,15) 
		into STRICT	nm_usuario_dest_w 
		from	man_ordem_servico 
		where	nr_sequencia = nr_seq_ordem_p;
 
		if (coalesce(nm_usuario_dest_w,'X') <> 'X') then 
			ds_usuarios_destino_w := substr(ds_usuarios_destino_w || nm_usuario_dest_w || ', ',1,4000);
 
			begin 
			select	ds_email 
			into STRICT	ds_email_w 
			from	usuario 
			where	nm_usuario = nm_usuario_dest_w 
			and	substr(obter_se_email_valido(ds_email),1,1) = 'S';
			exception 
				when others then 
				ds_email_w := '';
			end;
 
			if (coalesce(ds_email_w,'X') <> 'X') then 
				ds_lista_email_w := substr(ds_lista_email_w || ds_email_w || ';',1,4000);
			end if;
		end if;
	end if;
 
	if (coalesce(ds_usuarios_destino_w, 'X') <> 'X') then 
		begin 
		select	obter_classif_comunic('F'), 
			man_obter_dados_estagio(ds_estagio_w,'D') 
		into STRICT	nr_seq_classif_w, 
			ds_estagio_w 
		;
 
		begin 
		select	ds_motivo 
		into STRICT	ds_motivo_w 
		from	man_motivo_reprog_os 
		where	nr_sequencia = nr_seq_motivo_reprog_p;
		exception 
		when others then 
			ds_motivo_w := '';
		end;
		 
		 
		 
		if (nr_grupo_planej_w IS NOT NULL AND nr_grupo_planej_w::text <> '') then 
			ds_titulo_w	:= substr('Tasy - OS reprogramada - OS ' || nr_seq_ordem_p || ' - ' || Obter_desc_grupo_planej(nr_grupo_planej_w),1,255);
		else 
			ds_titulo_w	:= substr('Tasy - OS reprogramada - OS ' || nr_seq_ordem_p,1,255);
		end if;
		 
		ds_comunicado_w	:= substr('OS reprogramada por '|| nm_usuario_p ||' em ' || to_char(clock_timestamp(),'dd/mm/yyyy'),1,500);
						 
		if (nr_seq_estagio_w <> nr_seq_estagio_p) then 
			ds_comunicado_w	:= substr(ds_comunicado_w || chr(10) || chr(13) || 
						substr('Alterado estágio de ' || man_obter_dados_estagio(nr_seq_estagio_w,'D') || ' para ' || man_obter_dados_estagio(nr_seq_estagio_p,'D'),1,500),1,1000);
		elsif (dt_inicio_previsto_w <> dt_inicio_previsto_p) then 
			ds_comunicado_w	:= substr(ds_comunicado_w || chr(10) || chr(13) || 
						substr('Alterada data de início previsto de ' || dt_inicio_previsto_w || ' para ' || dt_inicio_previsto_p,1,500),1,1000);
		elsif (dt_fim_previsto_w <> dt_fim_previsto_p) then 
			ds_comunicado_w	:= substr(ds_comunicado_w || chr(10) || chr(13) || 
						substr('Alterada data de fim previsto de ' || dt_fim_previsto_w || ' para ' || dt_fim_previsto_p,1,500),1,1000);
		end if;
		 
		ds_comunicado_w	:= substr(ds_comunicado_w || chr(10) || chr(13) || substr(obter_desc_expressao(327458)/*'Motivo: '*/
 || ds_motivo_w,1,1000),1,2000);
 
		if (ds_observacao_p IS NOT NULL AND ds_observacao_p::text <> '') then 
			ds_comunicado_w	:= substr(ds_comunicado_w || chr(10) || chr(13) || obter_desc_expressao(329252)/*'Observação: '*/
 || ds_observacao_p,1,2000);
		end if;
		 
		if (nr_seq_tipo_hist_p in (1,2,6,129,130,132,143)) then -- Tipo de históricos que foram tradados no Servidor, que vão para cliente (externos) 
			begin 
				 
				if (nr_seq_localizacao_w IS NOT NULL AND nr_seq_localizacao_w::text <> '') then 
					select	max(a.cd_cnpj) 
					into STRICT	cd_cnpj_w 
					from	man_localizacao	a 
					where	a.nr_sequencia	= nr_seq_localizacao_w;
					 
					if (cd_cnpj_w IS NOT NULL AND cd_cnpj_w::text <> '') then 
						select	max(a.nr_seq_idioma) 
						into STRICT	nr_seq_idioma_w 
						from	pessoa_juridica	a 
						where	a.cd_cgc	= cd_cnpj_w;						
						 
						if (nr_seq_idioma_w IS NOT NULL AND nr_seq_idioma_w::text <> '') then 
							 
							 
							if (nr_grupo_planej_w IS NOT NULL AND nr_grupo_planej_w::text <> '') then 
								--Tasy - OS reprogramada - OS - grupo 
								ds_titulo_w	:= substr(obter_texto_dic_objeto(338192, nr_seq_idioma_w, 'NR_SEQ_ORDEM='||nr_seq_ordem_p||';GRUPO_PLANEJ='||Obter_desc_grupo_planej(nr_grupo_planej_w)), 1, 255);
							else 
								-- Tasy - OS reprogramada - OS 
								ds_titulo_w	:= substr(obter_texto_dic_objeto(338193, nr_seq_idioma_w, 'NR_SEQ_ORDEM='||nr_seq_ordem_p), 1, 255);
							end if;	
							 
							--OS reprogramada por 
							ds_comunicado_w	:= substr(obter_texto_dic_objeto(338194, nr_seq_idioma_w, 'NM_USUARIO='||nm_usuario_p||';DT_REPROG='||to_char(clock_timestamp(),'dd/mm/yyyy')), 1, 500);
														 
							if (nr_seq_estagio_w <> nr_seq_estagio_p) then 
								--Alterado estágio de 
								ds_comunicado_w	:= substr(ds_comunicado_w || chr(10) || chr(13) || 
											substr(obter_texto_dic_objeto(338195, nr_seq_idioma_w, 'ESTAGIO_ANTIGO='||man_obter_dados_estagio(nr_seq_estagio_w,'D')||';ESTAGIO_NOVO='||man_obter_dados_estagio(nr_seq_estagio_p,'D')), 1, 500),1,1000);
							elsif (dt_inicio_previsto_w <> dt_inicio_previsto_p) then 
								-- Alterada data de início previsto de 
								ds_comunicado_w	:= substr(ds_comunicado_w || chr(10) || chr(13) || 
											substr(obter_texto_dic_objeto(338196, nr_seq_idioma_w, 'DT_INICIO_ANTIGA='||dt_inicio_previsto_w||';DT_INICIO_NOVA='||dt_inicio_previsto_p), 1, 500),1,1000);
							elsif (dt_fim_previsto_w <> dt_fim_previsto_p) then 
								-- Alterada data de fim previsto de 
								ds_comunicado_w	:= substr(ds_comunicado_w || chr(10) || chr(13) || 
											substr(obter_texto_dic_objeto(338197, nr_seq_idioma_w, 'DT_FIM_ANTIGA='||dt_fim_previsto_w||';DT_FIM_NOVA='||dt_fim_previsto_p), 1, 500),1,1000);
							end if;
							 
							--Motivo 
							ds_comunicado_w	:= substr(ds_comunicado_w || chr(10) || chr(13) || substr(obter_texto_dic_objeto(338211, nr_seq_idioma_w, 'DS_MOTIVO='||ds_motivo_w), 1, 1000),1,2000);
							 
							--Observação 
							if (ds_observacao_p IS NOT NULL AND ds_observacao_p::text <> '') then 
								ds_comunicado_w	:= substr(ds_comunicado_w || chr(10) || chr(13) || substr(obter_texto_dic_objeto(338198, nr_seq_idioma_w, 'DS_OBSERVACAO='||ds_observacao_p), 1, 1000),1,2000);
							end if;							
							 
						end if;
					end if;
				end if;							
			end;
		end if;
			 
		if (ie_envia_ci_p = 'S') then 
			begin 
			insert into comunic_interna( 
				dt_comunicado, 
				ds_titulo, 
				ds_comunicado, 
				nm_usuario, 
				dt_atualizacao, 
				ie_geral, 
				nm_usuario_destino, 
				nr_sequencia, 
				ie_gerencial, 
				nr_seq_classif, 
				dt_liberacao, 
				ds_perfil_adicional, 
				ds_setor_adicional) 
			values (	clock_timestamp(), 
				ds_titulo_w, 
				ds_comunicado_w, 
				nm_usuario_p, 
				clock_timestamp(), 
				'N', 
				ds_usuarios_destino_w, 
				nextval('comunic_interna_seq'), 
				'N', 
				nr_seq_classif_w, 
				clock_timestamp(), 
				null, 
				null);
			 
			CALL man_atualizar_envio_ordem(nr_seq_ordem_p, ds_usuarios_destino_w, ds_comunicado_w, 'I', nm_usuario_p);
			end;
		end if;
		end;
	end if;
 
	if (ie_envia_email_p = 'S') then 
		if (coalesce(ds_lista_email_w,'X') <> 'X') and (coalesce(ds_email_origem_w,'X') <> 'X') then 
			begin 
			CALL enviar_email(	ds_titulo_w, 
					ds_comunicado_w, 
					ds_email_origem_w, 
					ds_lista_email_w, 
					nm_usuario_p, 
					'M');
			 
			CALL man_atualizar_envio_ordem(nr_seq_ordem_p, ds_usuarios_destino_w, ds_comunicado_w, 'E', nm_usuario_p);
			end;
		end if;
	end if;
 
	if (nr_seq_tipo_hist_p > 0) then	 
		ds_comunicado_w := substr(ds_titulo_w || chr(10) || chr(13) || ds_comunicado_w,1,2000);
 
		insert into man_ordem_serv_tecnico( 
			nr_sequencia, 
			nr_seq_ordem_serv, 
			dt_atualizacao, 
			dt_historico, 
			dt_liberacao, 
			nm_usuario_lib, 
			nm_usuario, 
			nr_seq_tipo, 
			ie_origem, 
			ds_relat_tecnico) 
		values (	nextval('man_ordem_serv_tecnico_seq'), 
			nr_seq_ordem_p, 
			clock_timestamp(), 
			clock_timestamp(), 
			clock_timestamp(), 
			nm_usuario_p, 
			nm_usuario_p, 
			nr_seq_tipo_hist_p, 
			'I', 
			ds_comunicado_w);
	end if;
	 
	commit;
end if;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE man_reprogramar_os ( nr_seq_ordem_p bigint, nr_seq_estagio_p bigint, dt_inicio_previsto_p timestamp, dt_fim_previsto_p timestamp, nr_seq_motivo_reprog_p bigint, ds_observacao_p text, ie_comunic_usuario_p bigint, nr_seq_tipo_hist_p bigint, nm_usuario_p text, ie_envia_ci_p text, ie_envia_email_p text) FROM PUBLIC;

