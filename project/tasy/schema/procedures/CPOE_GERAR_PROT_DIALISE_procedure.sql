-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE cpoe_gerar_prot_dialise ( cd_protocolo_p bigint, nr_seq_protocolo_p bigint, nr_seq_item_p bigint, nr_atendimento_p bigint, cd_perfil_p bigint, nm_usuario_p text, cd_paciente_p text, qt_peso_p bigint, nr_seq_item_gerado_p INOUT bigint, nr_seq_pend_pac_acao_p gqa_pend_pac_acao.nr_sequencia%type default null, nr_seq_transcricao_p bigint default null, ie_item_alta_p text default 'N', ie_prescritor_aux_p text default 'N', cd_medico_p bigint default null, ie_retrogrado_p text default 'N', dt_inicio_p timestamp default null, nr_seq_pepo_p bigint default null, nr_cirurgia_p bigint default null, nr_cirurgia_patologia_p bigint default null, nr_seq_agenda_p bigint default null, nr_seq_conclusao_apae_p bigint default null, dt_fim_presc_p timestamp default null, dt_inicio_presc_p timestamp default null, ie_futuro_p text default 'N', nr_seq_cpoe_rp_p cpoe_rp.nr_sequencia%type default null, nr_seq_cpoe_order_unit_p cpoe_order_unit.nr_sequencia%type default null) AS $body$
DECLARE


ds_stack_w					log_cpoe.ds_stack%type;
ds_log_cpoe_w				log_cpoe.ds_log%type;
ds_observacao_w				protocolo_hd_prescricao.ds_observacao%type;
dt_status_w					protocolo_hd_prescricao.dt_status%type;
ie_categoria_w				protocolo_hd_prescricao.ie_categoria%type;
ie_continuo_w				protocolo_hd_prescricao.ie_continuo%type;
ie_ligar_prime_w			protocolo_hd_prescricao.ie_ligar_prime%type;
ie_status_w					protocolo_hd_prescricao.ie_status%type;
ie_tipo_dialise_w			protocolo_hd_prescricao.ie_tipo_dialise%type;
ie_tipo_hemodialise_w		protocolo_hd_prescricao.ie_tipo_hemodialise%type;
ie_tipo_peritoneal_w		protocolo_hd_prescricao.ie_tipo_peritoneal%type;
ie_ultrafiltracao_w			protocolo_hd_prescricao.ie_ultrafiltracao%type;
nr_seq_diametro_agulha_w	protocolo_hd_prescricao.nr_seq_diametro_agulha%type;
nr_seq_maq_cicladora_w		protocolo_hd_prescricao.nr_seq_maq_cicladora%type;
nr_seq_mod_dialisador_w		protocolo_hd_prescricao.nr_seq_mod_dialisador%type;
nr_seq_ultra_w				protocolo_hd_prescricao.nr_seq_ultra%type;
nr_seq_perfil_sodio_w		protocolo_hd_prescricao.nr_seq_perfil_sodio%type;
nr_seq_tipo_agulha_w		protocolo_hd_prescricao.nr_seq_tipo_agulha%type;
nr_seq_tipo_agulha_art_w	protocolo_hd_prescricao.nr_seq_tipo_agulha_art%type;
qt_dois_tres_w				protocolo_hd_prescricao.qt_dois_tres%type;
qt_fluxo_sangue_w			protocolo_hd_prescricao.qt_fluxo_sangue%type;
qt_hora_sessao_w			protocolo_hd_prescricao.qt_hora_sessao%type;
qt_min_sessao_w				protocolo_hd_prescricao.qt_min_sessao%type;
qt_peso_seco_w				protocolo_hd_prescricao.qt_peso_seco%type;
qt_sessao_sem_w				protocolo_hd_prescricao.qt_sessao_sem%type;
qt_tres_quatro_w			protocolo_hd_prescricao.qt_tres_quatro%type;
qt_ultrafiltracao_w			protocolo_hd_prescricao.qt_ultrafiltracao%type;
qt_um_dois_w				protocolo_hd_prescricao.qt_um_dois%type;
qt_volume_total_w			protocolo_hd_prescricao.qt_volume_total%type;
qt_zero_um_w				protocolo_hd_prescricao.qt_zero_um%type;
nr_seq_perfil_bic_w			protocolo_hd_prescricao.nr_seq_perfil_bic%type;	
qt_zero_um_bic_w			protocolo_hd_prescricao.qt_zero_um_bic%type;
qt_um_dois_bic_w			protocolo_hd_prescricao.qt_um_dois_bic%type;
qt_dois_tres_bic_w			protocolo_hd_prescricao.qt_dois_tres_bic%type;
qt_tres_quatro_bic_w		protocolo_hd_prescricao.qt_tres_quatro_bic%type;
qt_quatro_cinco_bic_w		protocolo_hd_prescricao.qt_quatro_cinco_bic%type;
qt_cinco_seis_bic_w			protocolo_hd_prescricao.qt_cinco_seis_bic%type;	
qt_volume_ciclo_w           protocolo_hd_prescricao.qt_volume_ciclo%type;	
qt_tempo_permanencia_w      protocolo_hd_prescricao.qt_tempo_permanencia%type;
nr_seq_dialise_w              protocolo_hd_prescricao.nr_sequencia%type;

nr_seq_solucao_w			protocolo_medic_solucao.nr_seq_solucao%type;
nr_seq_protocolo_w			protocolo_medic_solucao.nr_seq_protocolo%type;
ie_tipo_solucao_w			protocolo_medic_solucao.ie_tipo_solucao%type;
ie_bomba_infusao_w			protocolo_medic_solucao.ie_bomba_infusao%type;
qt_solucao_total_w			protocolo_medic_solucao.qt_solucao_total%type;
qt_dosagem_w				protocolo_medic_solucao.qt_dosagem%type;
ie_unid_vel_inf_w			protocolo_medic_solucao.ie_unid_vel_inf%type;
qt_temp_solucao_w			protocolo_medic_solucao.qt_temp_solucao%type;
qt_dose_ataque_w			protocolo_medic_solucao.qt_dose_ataque%type;
ds_orientacao_w				protocolo_medic_solucao.ds_orientacao%type;
qt_tempo_infusao_w			protocolo_medic_solucao.qt_tempo_infusao%type;


cd_material_w				protocolo_medic_material.cd_material%type;
qt_dose_w					protocolo_medic_material.qt_dose%type;
cd_unidade_medida_w			protocolo_medic_material.cd_unidade_medida%type;
qt_dose_conv_un_md_w	    protocolo_medic_material.qt_dose%type;
qt_ds_conv_un_md_calc_w	    protocolo_medic_material.qt_dose%type;
qt_dose_after_conv_w	    protocolo_medic_material.qt_dose%type;

ie_hemodialise_w			protocolo_medicacao.ie_hemodialise%type;

nr_sequencia_w				cpoe_dialise.nr_sequencia%type;
qt_hora_min_sessao_w		cpoe_dialise.qt_hora_min_sessao%type;
dt_inicio_dialise_w			cpoe_dialise.dt_inicio%type;	
ie_duracao_w				cpoe_dialise.ie_duracao%type;
dt_fim_w					cpoe_dialise.dt_fim%type;
ie_cateter_w				cpoe_dialise.ie_cateter%type;
qt_volume_sol_w             cpoe_dialise.qt_volume_sol%type;

ie_prescricao_w				material.ie_prescricao%type;
count_solucao_w				bigint := 0;
count_sol_prod_w			bigint := 0;
count_component_w			bigint := 0;
sql_w						varchar(4000);
ds_sep_bv_w					varchar(10);
ds_parametros_w				varchar(2000);
ds_params_w                 varchar(2000);
ds_num_atrib_w				varchar(3);
qt_duracao_ciclo_w			varchar(10);
qt_permanencia_w			varchar(10);
qt_sodio_w					double precision;
qt_bicarbonato_w			double precision;
ie_prescr_alta_agora_w		varchar(1);

c01 CURSOR FOR
	SELECT	ds_observacao,
			dt_status,
			ie_categoria,	
			ie_continuo,
			ie_ligar_prime,
			ie_status,
			ie_tipo_dialise,
			ie_tipo_hemodialise,
			ie_tipo_peritoneal,
			ie_ultrafiltracao,
			nr_seq_diametro_agulha,
			nr_seq_maq_cicladora,
			nr_seq_mod_dialisador,
			nr_seq_ultra,
			nr_seq_perfil_sodio,
			nr_seq_tipo_agulha,
			nr_seq_tipo_agulha_art,
			qt_dois_tres,
			qt_fluxo_sangue,
			qt_hora_sessao,
			qt_min_sessao,
			qt_peso_seco,
			qt_sessao_sem,
			qt_tres_quatro,
			qt_ultrafiltracao,
			qt_um_dois,
			qt_volume_total,
			qt_zero_um,
			qt_sodio,
			qt_bicarbonato,
			nr_seq_perfil_bic,
			qt_zero_um_bic,
			qt_um_dois_bic,
			qt_dois_tres_bic,
			qt_tres_quatro_bic,
			qt_quatro_cinco_bic,
			qt_cinco_seis_bic,
			coalesce(ie_duracao,'C'),
      qt_volume_ciclo,
      qt_tempo_permanencia,
      nr_sequencia
	from	protocolo_hd_prescricao
	where	cd_protocolo = cd_protocolo_p
	and		nr_seq_protocolo = nr_seq_protocolo_p
	and		nr_sequencia = coalesce(nr_seq_item_p, nr_sequencia)
	and		coalesce(ie_tipo_dialise,'H') in ('H','P');		

c02 CURSOR FOR
	SELECT	nr_seq_solucao,
			nr_seq_protocolo,
			ie_tipo_solucao,
			ie_bomba_infusao,
			qt_solucao_total,
			qt_dosagem,
			ie_unid_vel_inf,
			qt_temp_solucao,
			qt_dose_ataque,
			ds_orientacao,
      qt_tempo_infusao
	from	protocolo_medic_solucao
	where	nr_sequencia = nr_seq_protocolo_p
	and		cd_protocolo = cd_protocolo_p
	and    	((ie_hemodialise = 'P' and nr_seq_dialise = nr_seq_dialise_w) or (ie_hemodialise = 'S'))  LIMIT 4;

c03 CURSOR FOR
	SELECT	cd_material,
			cd_unidade_medida,
			qt_dose
	from	protocolo_medic_material
	where	cd_protocolo = cd_protocolo_p
	and		nr_sequencia = nr_seq_protocolo_p
	and		nr_seq_solucao = nr_seq_solucao_w;


BEGIN

qt_volume_sol_w := 0;
ds_sep_bv_w	:= obter_separador_bv;
ie_prescr_alta_agora_w := obter_param_usuario(924, 409, cd_perfil_p, nm_usuario_p, obter_estab_atendimento(nr_atendimento_p), ie_prescr_alta_agora_w);

open c01;
loop
fetch c01 into	ds_observacao_w,
				dt_status_w,
				ie_categoria_w,
				ie_continuo_w,
				ie_ligar_prime_w,
				ie_status_w,
				ie_tipo_dialise_w,
				ie_tipo_hemodialise_w,
				ie_tipo_peritoneal_w,
				ie_ultrafiltracao_w,
				nr_seq_diametro_agulha_w,
				nr_seq_maq_cicladora_w,
				nr_seq_mod_dialisador_w,
				nr_seq_ultra_w,
				nr_seq_perfil_sodio_w,
				nr_seq_tipo_agulha_w,
				nr_seq_tipo_agulha_art_w,
				qt_dois_tres_w,
				qt_fluxo_sangue_w,
				qt_hora_sessao_w,
				qt_min_sessao_w,
				qt_peso_seco_w,
				qt_sessao_sem_w,
				qt_tres_quatro_w,
				qt_ultrafiltracao_w,
				qt_um_dois_w,
				qt_volume_total_w,
				qt_zero_um_w,
				qt_sodio_w,
				qt_bicarbonato_w,
				nr_seq_perfil_bic_w,
				qt_zero_um_bic_w,
				qt_um_dois_bic_w,
				qt_dois_tres_bic_w,
				qt_tres_quatro_bic_w,
				qt_quatro_cinco_bic_w,
				qt_cinco_seis_bic_w,
				ie_duracao_w,
        qt_volume_ciclo_w,
        qt_tempo_permanencia_w,
        nr_seq_dialise_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	begin

	select	nextval('cpoe_dialise_seq')
	into STRICT	nr_sequencia_w
	;

	qt_hora_min_sessao_w	:= obter_horas_minutos(qt_min_sessao_w + (qt_hora_sessao_w * 60));

	if (dt_inicio_presc_p IS NOT NULL AND dt_inicio_presc_p::text <> '') then
		dt_inicio_dialise_w := dt_inicio_presc_p;
	else
		dt_inicio_dialise_w := trunc(clock_timestamp(),'hh24') + 1/24;
	end if;	

	dt_fim_w				:=	null;	

	if (ie_duracao_w = 'P') then
		dt_fim_w := ((dt_inicio_dialise_w + 1) +(1/86400));
	end if;

	if (dt_fim_presc_p IS NOT NULL AND dt_fim_presc_p::text <> '') then
		dt_fim_w := dt_fim_presc_p;
		ie_duracao_w := 'P';
	end if;

	ie_hemodialise_w := 'S';
	if (ie_tipo_dialise_w = 'H') then
		select	CASE WHEN ie_hemodialise='E' THEN 'E'  ELSE 'S' END
		into STRICT	ie_hemodialise_w
		from	protocolo_medicacao 
		where	nr_sequencia = nr_seq_protocolo_p 
		and		cd_protocolo = cd_protocolo_p;

		if ((nr_seq_tipo_agulha_w IS NOT NULL AND nr_seq_tipo_agulha_w::text <> '') or (nr_seq_tipo_agulha_art_w IS NOT NULL AND nr_seq_tipo_agulha_art_w::text <> '')) then
			ie_cateter_w := 'N';
		end if;

		if (ie_hemodialise_w = 'E') then
			ie_duracao_w	:= 'P';
			dt_fim_w		:= ((dt_inicio_dialise_w + 1) - (1/1440));
		end if;

	end if;

	if (coalesce(ie_prescr_alta_agora_w,'N') = 'S') and (coalesce(ie_item_alta_p,'N') = 'S')	then
		dt_inicio_dialise_w := clock_timestamp();
	end if;

	if (ie_retrogrado_p = 'S' or ie_futuro_p = 'S') then -- retrograde/backward item
		dt_inicio_dialise_w := dt_inicio_p;
		dt_fim_w := (dt_inicio_dialise_w + 1) - 1/1440;
		ie_duracao_w := 'P';
	end if;
	insert into cpoe_dialise(
				nr_sequencia,
				nr_atendimento,
				cd_pessoa_fisica,
				ie_hemodialise,
				ie_categoria,
				ie_tipo_hemodialise,
				qt_fluxo_sangue,
				qt_sessao_sem,
				qt_hora_min_sessao,
				nr_seq_mod_dialisador,
				ie_ultrafiltracao,
				qt_ultrafiltracao,
				nr_seq_diametro_agulha,
				nr_seq_tipo_agulha,
				nr_seq_tipo_agulha_art,
				nr_seq_ultra,
				nr_seq_perfil_sodio,
				qt_zero_um,
				qt_um_dois,
				qt_dois_tres,
				qt_tres_quatro,
				qt_peso_atual,
				ie_ligar_prime,
				ds_observacao,
				nm_usuario,
				nm_usuario_nrec,
				dt_atualizacao,
				dt_atualizacao_nrec,
				cd_perfil_ativo,
				ie_duracao,
				dt_inicio,
				dt_fim,
				ie_tipo_dialise,
				nr_seq_maq_cicladora,
				ie_tipo_peritoneal,
				cd_funcao_origem,
				qt_sodio,
				qt_bicarbonato,
				ie_cateter,
				nr_seq_perfil_bic,
				qt_zero_um_bic,
				qt_um_dois_bic,
				qt_dois_tres_bic,
				qt_tres_quatro_bic,
				qt_quatro_cinco_bic,
				qt_cinco_seis_bic,
				nr_seq_pend_pac_acao,
				nr_seq_transcricao,
				ie_item_alta,
				ie_prescritor_aux,
				cd_medico,
				ie_retrogrado,
				ie_futuro,
				nr_seq_pepo,
				nr_cirurgia,
				nr_cirurgia_patologia,
				nr_seq_agenda,
				nr_seq_conclusao_apae,
				cd_protocolo,
				nr_seq_protocolo_prescr,
				ie_forma_geracao,
        qt_volume_ciclo, 
        qt_tempo_permanencia,
        nr_seq_protocolo,
        qt_volume_sol,
	nr_seq_cpoe_order_unit)
			values (
				nr_sequencia_w,
				nr_atendimento_p,
				cd_paciente_p,
				ie_hemodialise_w,
				ie_categoria_w,
				ie_tipo_hemodialise_w,
				qt_fluxo_sangue_w,
				qt_sessao_sem_w,
				qt_hora_min_sessao_w,
				nr_seq_mod_dialisador_w,
				ie_ultrafiltracao_w,
				qt_ultrafiltracao_w,
				nr_seq_diametro_agulha_w,
				nr_seq_tipo_agulha_w,
				nr_seq_tipo_agulha_art_w,
				nr_seq_ultra_w,
				nr_seq_perfil_sodio_w,
				qt_zero_um_w,
				qt_um_dois_w,
				qt_dois_tres_w,
				qt_tres_quatro_w,
				qt_peso_p,
				ie_ligar_prime_w,
				ds_observacao_w,
				nm_usuario_p,
				nm_usuario_p,
				clock_timestamp(),
				clock_timestamp(),
				cd_perfil_p,
				ie_duracao_w,
				dt_inicio_dialise_w,
				dt_fim_w,
				CASE WHEN ie_tipo_dialise_w='H' THEN 'DI' WHEN ie_tipo_dialise_w='P' THEN 'DP' END ,
				nr_seq_maq_cicladora_w,
				ie_tipo_peritoneal_w,
				2314,
				qt_sodio_w,
				qt_bicarbonato_w,
				ie_cateter_w,
				nr_seq_perfil_bic_w,
				qt_zero_um_bic_w,
				qt_um_dois_bic_w,
				qt_dois_tres_bic_w,
				qt_tres_quatro_bic_w,
				qt_quatro_cinco_bic_w,
				qt_cinco_seis_bic_w,
				nr_seq_pend_pac_acao_p,
				nr_seq_transcricao_p,
				ie_item_alta_p,
				ie_prescritor_aux_p,
				cd_medico_p,
				ie_retrogrado_p,
				ie_futuro_p,
				nr_seq_pepo_p,
				nr_cirurgia_p,
				nr_cirurgia_patologia_p,
				nr_seq_agenda_p,
				nr_seq_conclusao_apae_p,
				cd_protocolo_p,
				nr_seq_protocolo_p,
				'P',
        qt_volume_ciclo_w, 
        obter_horas_minutos(coalesce(qt_tempo_permanencia_w, 0) * 60),
        nr_seq_protocolo_w,
        qt_volume_sol_w,
	nr_seq_cpoe_order_unit_p);

	count_solucao_w := 0;

	open c02;
	loop
	fetch c02 into	nr_seq_solucao_w,
					nr_seq_protocolo_w,
					ie_tipo_solucao_w,
					ie_bomba_infusao_w,
					qt_solucao_total_w,
					qt_dosagem_w,
					ie_unid_vel_inf_w,
					qt_temp_solucao_w,
					qt_dose_ataque_w,
					ds_orientacao_w,
          qt_tempo_infusao_w;
	EXIT WHEN NOT FOUND; /* apply on c02 */
		begin
		count_solucao_w := count_solucao_w + 1;

		ds_num_atrib_w := '';
		if (count_solucao_w > 1) then
			ds_num_atrib_w := to_char(count_solucao_w);
		end if;

		if (qt_tempo_infusao_w > 0) then
			qt_hora_min_sessao_w := obter_horas_minutos(qt_tempo_infusao_w);
		end if;
		ds_parametros_w	:= 	'nr_seq_protocolo='	|| nr_seq_protocolo_w	|| ds_sep_bv_w ||
							'ie_tipo_solucao='	|| ie_tipo_solucao_w	|| ds_sep_bv_w ||
							'ie_bomba_infusao='	|| ie_bomba_infusao_w	|| ds_sep_bv_w ||
							'qt_solucao_total='	|| qt_solucao_total_w	|| ds_sep_bv_w ||
							'qt_dosagem='		|| qt_dosagem_w			|| ds_sep_bv_w ||
							'ie_unid_vel_inf='	|| ie_unid_vel_inf_w	|| ds_sep_bv_w ||
							'qt_temp_solucao='	|| qt_temp_solucao_w	|| ds_sep_bv_w ||
							'qt_dose_ataque='	|| qt_dose_ataque_w		|| ds_sep_bv_w ||
							'ds_orientacao='	|| substr(ds_orientacao_w,1,200)	   || ds_sep_bv_w ||
              'qt_tempo_infusao=' || qt_hora_min_sessao_w   || ds_sep_bv_w ||
							'nr_sequencia='		|| nr_sequencia_w		|| ds_sep_bv_w ||
							'qt_hora_min_sessao='|| qt_hora_min_sessao_w || ds_sep_bv_w;

		sql_w :=	'update	cpoe_dialise '		||
					'set	nr_seq_protocolo'	|| ds_num_atrib_w || '	= :nr_seq_protocolo, '	||
					'		ie_tipo_solucao'	|| ds_num_atrib_w || '	= :ie_tipo_solucao, '	||
					'		ie_bomba_infusao'	|| ds_num_atrib_w || '	= :ie_bomba_infusao, '	||
					'		qt_solucao_total'	|| ds_num_atrib_w || '	= :qt_solucao_total, '	||
					'		qt_dosagem'			|| ds_num_atrib_w || '	= :qt_dosagem, '		||
					'		ie_unid_vel_inf'	|| ds_num_atrib_w || '	= :ie_unid_vel_inf, '	||
					'		qt_temp_solucao'	|| ds_num_atrib_w || '	= :qt_temp_solucao, '	||
					'		qt_dose_ataque'		|| ds_num_atrib_w || '	= :qt_dose_ataque, '	||
					'		ds_orientacao'		|| ds_num_atrib_w || '	= :ds_orientacao, '		||
          '		qt_tempo_infusao'	|| ds_num_atrib_w || '	= :qt_tempo_infusao, '	||
					'		qt_hora_min_sessao' || '	= :qt_hora_min_sessao ' ||
					'where	nr_sequencia = :nr_sequencia';

		CALL exec_sql_dinamico_bv('TASY', sql_w, ds_parametros_w);

		count_component_w := 0;

		open c03;
		loop
		fetch c03 into	cd_material_w,
						cd_unidade_medida_w,
						qt_dose_w;
		EXIT WHEN NOT FOUND; /* apply on c03 */
			begin

			count_component_w := count_component_w + 1;

			ds_num_atrib_w := '';
			if (count_solucao_w = 1) then
				ds_num_atrib_w := to_char(count_component_w);
			else
				ds_num_atrib_w := count_component_w || '_' || to_char(count_solucao_w);
			end if;

      if (upper(cd_unidade_medida_w) <> upper('ml')) then
          select obter_conversao_unid_med(cd_material_w, 'ml') into STRICT qt_dose_conv_un_md_w;
          if (coalesce(qt_dose_conv_un_md_w,0) > 0) then
              qt_ds_conv_un_md_calc_w := qt_dose_conv_un_md_w * qt_dose_w;
          end if;
      end if;

      select CASE WHEN upper(cd_unidade_medida_w)=upper('ml') THEN  qt_dose_w  ELSE qt_ds_conv_un_md_calc_w END  into STRICT qt_dose_after_conv_w;

			if (coalesce(qt_dose_after_conv_w::text, '') = '' AND qt_dose_w > 0) then
				qt_dose_after_conv_w := qt_dose_w;
			end if;
			
			select a.IE_PRESCRICAO
			into STRICT ie_prescricao_w
			from MATERIAL a
			where a.CD_MATERIAL = cd_material_w;
			
			if (coalesce(ie_prescricao_w,'S') = 'S') then
				ds_parametros_w	:= 	'cd_material='	|| cd_material_w		|| ds_sep_bv_w ||
									'qt_dose='					|| qt_dose_after_conv_w || ds_sep_bv_w ||
									'cd_unidade_medida_dose='	|| cd_unidade_medida_w	|| ds_sep_bv_w ||
									'nr_sequencia='				|| nr_sequencia_w		|| ds_sep_bv_w;
	
				sql_w :='	update	cpoe_dialise '			||
						'	set		cd_mat_soluc'			|| ds_num_atrib_w || '	= :cd_material,' 			||
						'			cd_unid_med_dose_sol'	|| ds_num_atrib_w || '	= :cd_unidade_medida_dose,' ||
						'			qt_dose_soluc'			|| ds_num_atrib_w || '	= :qt_dose' 				||
						'	where	nr_sequencia					= :nr_sequencia';
	
				CALL exec_sql_dinamico_bv('TASY', sql_w, ds_parametros_w);
			else
			  count_component_w := count_component_w - 1;
			end if;
      qt_volume_sol_w := qt_volume_sol_w + qt_dose_w;

			end;
		end loop;
		close c03;

    begin
        ds_params_w	:= 	'qt_volume_sol=' || qt_volume_sol_w || ds_sep_bv_w ||
                            'nr_sequencia='	 || nr_sequencia_w	|| ds_sep_bv_w;
        if (count_solucao_w <= 1)then
            count_sol_prod_w := null;
        else
            count_sol_prod_w := count_solucao_w;
        end if;
        sql_w :='	update	cpoe_dialise ' ||
                '	set		qt_volume_sol' || count_sol_prod_w || '	= :qt_volume_sol' ||
                '	where	nr_sequencia = :nr_sequencia';
        CALL exec_sql_dinamico_bv('TASY', sql_w, ds_params_w);
        qt_volume_sol_w := 0;
    end;
		end;
	end loop;
	close c02;	

	CALL cpoe_gerar_plano_protocolo(nr_atendimento_p, dt_fim_presc_p, nr_sequencia_w, nm_usuario_p, 'D');
	CALL cpoe_utils_pck.set_list_itens(nr_sequencia_w, 'DI');
	end;
end loop;
close c01;

commit;

nr_seq_item_gerado_p := nr_sequencia_w;

exception
   when others then
	rollback;

	ds_stack_w	:= substr(dbms_utility.format_call_stack,1,2000);
	ds_log_cpoe_w := substr('CPOE_GERAR_PROT_DIALISE '
		|| chr(13) || ' - cd_protocolo_p: ' || cd_protocolo_p
		|| chr(13) || ' - nr_seq_protocolo_p: ' || nr_seq_protocolo_p
		|| chr(13) || ' - nr_seq_item_p: ' || nr_seq_item_p
		|| chr(13) || ' - nr_atendimento_p: ' || nr_atendimento_p
		|| chr(13) || ' - cd_perfil_p: ' || cd_perfil_p
		|| chr(13) || ' - nm_usuario_p: ' || nm_usuario_p
		|| chr(13) || ' - cd_paciente_p: ' || cd_paciente_p
		|| chr(13) || ' - qt_peso_p: ' || qt_peso_p
		|| chr(13) || ' - nr_seq_item_gerado_p: ' || nr_seq_item_gerado_p
		|| chr(13) || ' - nr_seq_pend_pac_acao_p: ' || nr_seq_pend_pac_acao_p
		|| chr(13) || ' - nr_seq_transcricao_p: ' || nr_seq_transcricao_p
		|| chr(13) || ' - ie_item_alta_p: ' || ie_item_alta_p
		|| chr(13) || ' - ie_prescritor_aux_p: ' || ie_prescritor_aux_p
		|| chr(13) || ' - cd_medico_p: ' || cd_medico_p
		|| chr(13) || ' - ie_retrogrado_p: ' || ie_retrogrado_p
		|| chr(13) || ' - ie_futuro_p: ' || ie_futuro_p
		|| chr(13) || ' - dt_inicio_p: ' || PKG_DATE_FORMATERS_TZ.TO_VARCHAR(dt_inicio_p,'timestamp',ESTABLISHMENT_TIMEZONE_UTILS.gettimezone)
		|| chr(13) || ' - nr_seq_pepo_p: ' || nr_seq_pepo_p
		|| chr(13) || ' - nr_cirurgia_p: ' || nr_cirurgia_p
		|| chr(13) || ' - nr_cirurgia_patologia_p: ' || nr_cirurgia_patologia_p
		|| chr(13) || ' - nr_seq_agenda_p: ' || nr_seq_agenda_p
		|| chr(13) || ' - nr_seq_conclusao_apae_p: ' || nr_seq_conclusao_apae_p
		|| chr(13) || ' - dt_fim_presc_p: ' || PKG_DATE_FORMATERS_TZ.TO_VARCHAR(dt_fim_presc_p,'timestamp',ESTABLISHMENT_TIMEZONE_UTILS.gettimezone)
		|| chr(13) || ' - dt_inicio_presc_p: ' || PKG_DATE_FORMATERS_TZ.TO_VARCHAR(dt_inicio_presc_p,'timestamp',ESTABLISHMENT_TIMEZONE_UTILS.gettimezone)
		|| chr(13) || ' - ERRO: ' || sqlerrm
		|| chr(13) || ' - FUNCAO('||to_char(obter_funcao_ativa)||'); PERFIL('||to_char(obter_perfil_ativo)||')',1,2000);

	insert into log_cpoe(
		nr_sequencia,
		nr_atendimento, 
		dt_atualizacao, 
		nm_usuario, 
		ds_log, 
		ds_stack) 
	values (
		nextval('log_cpoe_seq'), 
		nr_atendimento_p, 
		clock_timestamp(), 
		nm_usuario_p, 
		ds_log_cpoe_w, 
		ds_stack_w);

	commit;

	CALL wheb_mensagem_pck.exibir_mensagem_abort(sqlerrm);

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cpoe_gerar_prot_dialise ( cd_protocolo_p bigint, nr_seq_protocolo_p bigint, nr_seq_item_p bigint, nr_atendimento_p bigint, cd_perfil_p bigint, nm_usuario_p text, cd_paciente_p text, qt_peso_p bigint, nr_seq_item_gerado_p INOUT bigint, nr_seq_pend_pac_acao_p gqa_pend_pac_acao.nr_sequencia%type default null, nr_seq_transcricao_p bigint default null, ie_item_alta_p text default 'N', ie_prescritor_aux_p text default 'N', cd_medico_p bigint default null, ie_retrogrado_p text default 'N', dt_inicio_p timestamp default null, nr_seq_pepo_p bigint default null, nr_cirurgia_p bigint default null, nr_cirurgia_patologia_p bigint default null, nr_seq_agenda_p bigint default null, nr_seq_conclusao_apae_p bigint default null, dt_fim_presc_p timestamp default null, dt_inicio_presc_p timestamp default null, ie_futuro_p text default 'N', nr_seq_cpoe_rp_p cpoe_rp.nr_sequencia%type default null, nr_seq_cpoe_order_unit_p cpoe_order_unit.nr_sequencia%type default null) FROM PUBLIC;

