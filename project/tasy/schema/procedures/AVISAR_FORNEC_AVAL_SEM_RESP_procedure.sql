-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE avisar_fornec_aval_sem_resp ( cd_estabelecimento_p bigint, nm_usuario_p text) AS $body$
DECLARE

 
/* Campos Avaliação */
 
nr_seq_avaliacao_w		bigint;
ds_tipo_avaliacao_w		varchar(255);
cd_cgc_w			varchar(14);
cd_pessoa_resp_w			varchar(10);
nm_pessoa_resp_w			varchar(100);
dt_limite_w			timestamp;
ds_email_w			varchar(255);
ds_email_remetente_w		varchar(255);

/* Campos CI e EMAIL */
 
ds_email_origem_w			varchar(60);
ds_email_destino_w			varchar(60);
nm_usuario_w			varchar(15);
ie_momento_envio_w		varchar(1);

/* Campos CI */
 
pessoa_envio_w			varchar(15);
nr_sequencia_w			bigint;

cd_pf_pj_w			varchar(14);
ie_envia_email_ci_w		boolean;

/*Campos Regra Email*/
 
nr_seq_regra_w			bigint;
ds_email_adicional_w		varchar(2000);
cd_perfil_disparar_w		integer;
ds_assunto_w			varchar(80);
ds_mensagem_w			varchar(4000);

/*Valor para a macro*/
 
ds_avaliacao_tipo_w		varchar(4000);

ds_txt_dt_limite_w		varchar(30) := wheb_mensagem_pck.get_texto(313591);
ds_txt_responsavel_w		varchar(30) := wheb_mensagem_pck.get_texto(241183);
ds_txt_email_w			varchar(15) := wheb_mensagem_pck.get_texto(275291)||':';
C01 CURSOR FOR
	SELECT	distinct 
		a.cd_cnpj 
	from  avf_resultado a 
	where  coalesce(a.dt_resp_portal::text, '') = '' 
	and	a.cd_estabelecimento = cd_estabelecimento_p 
	and	(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '') 
	and   	exists ( 	SELECT	1 
			from  	avf_tipo_avaliacao b 
			where  	b.nr_sequencia = a.nr_seq_tipo_aval 
			and   	coalesce(b.qt_dias_resposta_aval,0) > 0 
			and   	coalesce(b.ie_portal,'N') = 'S' 
			and		substr(obter_se_avf_tipo_lib(b.nr_sequencia),1,1) = 'S' 
			and   	obter_dias_entre_datas(a.dt_avaliacao, clock_timestamp()) > b.qt_dias_resposta_aval) 
	order  by	cd_cnpj;

C02 CURSOR FOR 
	SELECT	distinct 
		a.cd_pessoa_resp 
	from  avf_resultado a 
	where  coalesce(a.dt_resp_portal::text, '') = '' 
	and	(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '') 
	and	a.cd_estabelecimento = cd_estabelecimento_p 
	and   	exists ( 	SELECT	1 
			from  	avf_tipo_avaliacao b 
			where  	b.nr_sequencia = a.nr_seq_tipo_aval 
			and   	coalesce(b.qt_dias_resposta_aval,0) > 0 
			and   	coalesce(b.ie_portal,'N') = 'S' 
			and		substr(obter_se_avf_tipo_lib(b.nr_sequencia),1,1) = 'S' 
			and   	obter_dias_entre_datas(a.dt_avaliacao, clock_timestamp()) > b.qt_dias_resposta_aval) 
	order  by	cd_pessoa_resp;

C03 CURSOR FOR 
	SELECT	distinct 
		a.nr_sequencia, 
		substr(obter_nome_avf_tipo_avaliacao(a.nr_seq_tipo_aval),1,250) ds_tipo_aval, 
		a.dt_liberacao + coalesce(b.qt_dias_resposta_aval,0), 
		substr(obter_nome_pf(a.cd_pessoa_resp),1,100), 
		substr(obter_dados_usuario_opcao(obter_usuario_pessoa(a.cd_pessoa_resp),'E'),1,255) 
	from  avf_resultado a, 
		avf_tipo_avaliacao b 
	where  a.nr_seq_tipo_aval = b.nr_Sequencia 
	and	coalesce(a.dt_resp_portal::text, '') = '' 
	and	(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '') 
	and	a.cd_estabelecimento = cd_estabelecimento_p 
	and	substr(obter_se_avf_tipo_lib(a.nr_sequencia),1,1) = 'S' 
	and	((a.cd_pessoa_resp = cd_pf_pj_w) or (a.cd_cnpj = cd_pf_pj_w)) 
	and   	exists ( 	SELECT	1 
			from  	avf_tipo_avaliacao b 
			where  	b.nr_sequencia = a.nr_seq_tipo_aval 
			and   	coalesce(b.qt_dias_resposta_aval,0) > 0 
			and   	coalesce(b.ie_portal,'N') = 'S' 
			and		substr(obter_se_avf_tipo_lib(b.nr_sequencia),1,1) = 'S' 
			and   	obter_dias_entre_datas(a.dt_avaliacao, clock_timestamp()) > b.qt_dias_resposta_aval) 
	order  by	nr_sequencia;


BEGIN 
 
select	coalesce(max(nr_sequencia),0), 
	coalesce(max(ds_email_remetente),'X'), 
	max(replace(ds_email_adicional,',',';')), 
	coalesce(max(ie_momento_envio),'I') 
into STRICT	nr_seq_regra_w, 
	ds_email_remetente_w, 
	ds_email_adicional_w, 
	ie_momento_envio_w 
from	regra_envio_email_compra 
where	ie_tipo_mensagem = 55 -- Pessoa jurídica - Avaliação sem resposta (Avisa fornecedor e responsável) 
and	ie_situacao = 'A' 
and	cd_estabelecimento = cd_estabelecimento_p;
 
if (nr_seq_regra_w > 0) then 
	begin 
 
	/* Envia Email para o FORNECEDOR referente ao atraso da resposta da avaliação */
 
	open C01;
	loop 
	fetch C01 into 
		cd_pf_pj_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin 
		/* EXCEPTION */
 
		begin 
 
		ie_envia_email_ci_w := false;
		ds_avaliacao_tipo_w := '';
		open C03;
		loop 
		fetch C03 into	 
			nr_seq_avaliacao_w, 
			ds_tipo_avaliacao_w, 
			dt_limite_w, 
			nm_pessoa_resp_w,			 
			ds_email_w;
		EXIT WHEN NOT FOUND; /* apply on C03 */
			begin 
			ds_avaliacao_tipo_w := substr(	ds_avaliacao_tipo_w || nr_seq_avaliacao_w || ' - ' || ds_tipo_avaliacao_w || chr(13) || chr(10) || 
							ds_txt_dt_limite_w|| ' '|| dt_limite_w 		|| chr(13) || chr(10) || 
							ds_txt_responsavel_w|| ' ' || nm_pessoa_resp_w 	|| chr(13) || chr(10) || 
							ds_txt_email_w|| ' '	|| ds_email_w		|| chr(13) || chr(10) || chr(13) || chr(10),1,4000);
			ie_envia_email_ci_w := true;
			end;
		end loop;
		close C03;
		 
 
		 
		select	substr(ds_assunto,1,80), 
			substr(ds_mensagem_padrao,1,4000) 
		into STRICT	ds_assunto_w, 
			ds_mensagem_w 
		from	regra_envio_email_compra 
		where	nr_sequencia = nr_seq_regra_w;
 
		ds_mensagem_w := substr(replace_macro(ds_mensagem_w, '@fornecedor_responsavel', wheb_mensagem_pck.get_texto(312719)),1,4000);
		ds_mensagem_w := substr(replace_macro(ds_mensagem_w, '@avaliacao_tipo',ds_avaliacao_tipo_w),1,4000);
 
		select	coalesce(ds_email,'X') 
		into STRICT	ds_email_destino_w 
		from	pessoa_juridica_estab 
		where	cd_cgc = cd_pf_pj_w 
		and	cd_estabelecimento = cd_estabelecimento_p;
 
		select	ds_email, 
			obter_usuario_pf(cd_responsavel_compras) 
		into STRICT	ds_email_origem_w, 
			nm_usuario_w 
		from	parametro_compras 
		where	cd_estabelecimento = cd_estabelecimento_p;
 
		if (ds_email_remetente_w <> 'X') then 
			ds_email_origem_w	:= ds_email_remetente_w;
		end if;
 
		if (cd_pf_pj_w IS NOT NULL AND cd_pf_pj_w::text <> '') and (ds_email_destino_w <> 'X') and (ds_email_origem_w IS NOT NULL AND ds_email_origem_w::text <> '') and 
			--(nm_usuario_w is not null) and 
			(ie_envia_email_ci_w) then 
			 
			if (ie_momento_envio_w = 'A') then 
				begin 
 
				CALL sup_grava_envio_email( 
					'PJ', 
					'55', 
					0, 
					null, 
					null, 
					ds_email_destino_w, 
					nm_usuario_w,					 
					ds_email_origem_w, 
					ds_assunto_w, 
					ds_mensagem_w, 
					cd_estabelecimento_p, 
					nm_usuario_p);
				end;
			else 
				begin 
				CALL enviar_email(	 
					ds_assunto_w, 
					ds_mensagem_w, 
					ds_email_origem_w, 
					ds_email_destino_w, 
					nm_usuario_w, 
					'M');
				end;
			end if;
		end if;
 
		exception 
		when others then 
			null;
		end; /* EXCEPTION */
 
		end;
	end loop;
	close C01;
 
	/* Envia Email para o RESPONSÁVEL da avaliaçaõ, referente ao atraso da resposta da mesma */
 
	open C02;
	loop 
	fetch C02 into	 
		cd_pf_pj_w;
	EXIT WHEN NOT FOUND; /* apply on C02 */
		begin 
 
		/* EXCEPTION */
 
		begin 
 
		ie_envia_email_ci_w := false;
		ds_avaliacao_tipo_w := '';
		open C03;
		loop 
		fetch C03 into	 
			nr_seq_avaliacao_w, 
			ds_tipo_avaliacao_w, 
			dt_limite_w, 
			nm_pessoa_resp_w, 
			ds_email_w;
		EXIT WHEN NOT FOUND; /* apply on C03 */
			begin 
			ds_avaliacao_tipo_w := substr(	ds_avaliacao_tipo_w || nr_seq_avaliacao_w || ' - ' || ds_tipo_avaliacao_w || chr(13) || chr(10) || 
							ds_txt_dt_limite_w|| ' '	|| dt_limite_w 		|| chr(13) || chr(10) || 
							ds_txt_responsavel_w|| ' ' || nm_pessoa_resp_w 	|| chr(13) || chr(10) || 
							ds_txt_email_w|| ' ' || ds_email_w		|| chr(13) || chr(10) || chr(13) || chr(10),1,4000);
			 
			ie_envia_email_ci_w := true;
			end;
		end loop;
		close C03;
		 
				 
 
	 
 
		select	substr(ds_assunto,1,80), 
			substr(ds_mensagem_padrao,1,4000) 
		into STRICT	ds_assunto_w, 
			ds_mensagem_w 
		from	regra_envio_email_compra 
		where	nr_sequencia = nr_seq_regra_w;
 
		ds_mensagem_w := substr(replace_macro(ds_mensagem_w, '@fornecedor_responsavel', wheb_mensagem_pck.get_texto(301713)),1,4000);
		ds_mensagem_w := substr(replace_macro(ds_mensagem_w, '@avaliacao_tipo', ds_avaliacao_tipo_w),1,4000);
 
		if (cd_pf_pj_w IS NOT NULL AND cd_pf_pj_w::text <> '') and (ie_envia_email_ci_w) then 
 
			select	obter_dados_usuario_opcao(obter_usuario_pessoa(cd_pf_pj_w), 'E') nm_usuario 
			into STRICT	ds_email_destino_w 
			;
 
			select	ds_email, 
				obter_usuario_pf(cd_responsavel_compras) nm_usuario_origem 
			into STRICT	ds_email_origem_w, 
				nm_usuario_w 
			from	parametro_compras 
			where	cd_estabelecimento = cd_estabelecimento_p;
 
			if (ds_email_remetente_w <> 'X') then 
				ds_email_origem_w	:= ds_email_remetente_w;
			end if;
 
			if (ds_email_destino_w <> 'X') and (ds_email_origem_w IS NOT NULL AND ds_email_origem_w::text <> '') and 
				--(nm_usuario_w is not null) and 
				(ie_envia_email_ci_w) then 
				begin 
 
				if (ie_momento_envio_w = 'A') then 
					begin 
 
					CALL sup_grava_envio_email( 
						'PJ', 
						'55', 
						0, 
						null, 
						null, 
						ds_email_destino_w, 
						nm_usuario_w,						 
						ds_email_origem_w, 
						ds_assunto_w, 
						ds_mensagem_w, 
						cd_estabelecimento_p, 
						nm_usuario_p);
 
					end;
				else 
					begin 
					CALL enviar_email(	ds_assunto_w, 
							ds_mensagem_w, 
							ds_email_origem_w, 
							ds_email_destino_w, 
							nm_usuario_w, 
							'M');
 
					end;
				end if;
 
				end;
			end if;
		end if;
 
		exception 
		when others then 
			null;
		end; /* EXCEPTION */
 
		end;
	end loop;
	close C02;
	end;
end if;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE avisar_fornec_aval_sem_resp ( cd_estabelecimento_p bigint, nm_usuario_p text) FROM PUBLIC;

