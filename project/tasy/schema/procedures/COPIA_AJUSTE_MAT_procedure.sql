-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE copia_ajuste_mat (CD_CONVENIO_ORIGEM_P bigint, CD_CATEGORIA_ORIGEM_P text, CD_CONVENIO_DESTINO_P bigint, CD_CATEGORIA_DESTINO_P text, IE_COPIA_GRUPO_P text, IE_COPIA_SUBGRUPO_P text, IE_COPIA_CLASSE_P text, IE_COPIA_MATERIAL_P text, CD_ESTABELECIMENTO_ORIG_P bigint, CD_ESTABELECIMENTO_DEST_P bigint, NM_USUARIO_P text, cd_plano_origem_p text, cd_plano_destino_p text) AS $body$
DECLARE


nr_sequencia_w			bigint;
NR_SEQUENCIA_ww			bigint;
cd_estabelecimento_w		smallint;
dt_inicio_vigencia_w		timestamp;
cd_grupo_material_w		smallint;
cd_subgrupo_material_w		smallint;
cd_classe_material_w		integer;
cd_material_w			integer;
tx_ajuste_w			double precision;
vl_negociado_w			double precision;
ie_preco_informado_w		varchar(1);
ie_glosa_w			varchar(1);
tx_brasindice_pfb_w		REGRA_AJUSTE_MATERIAL.TX_BRASINDICE_PFB%type;-- number(15,4);
tx_brasindice_pmc_w		CONVENIO_BRASINDICE.TX_BRASINDICE_PMC%type;--number(15,4);
tx_afaturar_w			double precision;
DT_FINAL_VIGENCIA_w     	timestamp;
CD_TIPO_ACOMODACAO_w    	smallint;
IE_TIPO_ATENDIMENTO_w   	smallint;
CD_SETOR_ATENDIMENTO_w  	integer;
ie_origem_preco_w		varchar(05);
ie_precedencia_preco_w		varchar(01);
pr_glosa_w			double precision;
ie_tipo_material_w		varchar(03);
CD_CID_w			varchar(10);
CD_TABELA_PRECO_w		bigint;
CD_MOTIVO_EXC_CONTA_w		bigint;
qt_tab_w			bigint:= 0;

/* Elemar 23/07/2004 */

tx_pmc_neg_w		 	CONVENIO_BRASINDICE.TX_PMC_NEG%type;--number(15,4);
tx_pmc_pos_w			CONVENIO_BRASINDICE.TX_PMC_POS%type;--number(15,4);
ie_sexo_w			varchar(01);
cd_plano_w			varchar(10);
ie_autor_particular_w		varchar(01);
/*Geliard 12/01/2009*/

ie_kit_material_w		varchar(01);
cd_kit_material_w		integer;
ie_data_referencia_vig_w	varchar(1);
tx_pfb_neg_w			CONVENIO_BRASINDICE.TX_PFB_NEG%type; --number(15,4);
tx_pfb_pos_w			CONVENIO_BRASINDICE.TX_PFB_POS%type;--number(15,4);
nr_seq_estrutura_w		bigint;
cd_tipo_baixa_w			smallint;
ie_clinica_w			integer;
cd_convenio_glosa_w		convenio.cd_convenio%type;
cd_categoria_glosa_w		categoria_convenio.cd_categoria%type;
nr_seq_classificacao_w   REGRA_AJUSTE_MATERIAL.NR_SEQ_CLASSIFICACAO%type;
tx_simpro_pfb_w          REGRA_AJUSTE_MATERIAL.TX_SIMPRO_PFB%type;
tx_simpro_pos_pmc_w      REGRA_AJUSTE_MATERIAL.TX_SIMPRO_POS_PMC%type;
tx_simpro_pos_pfb_w      REGRA_AJUSTE_MATERIAL.TX_SIMPRO_POS_PFB%type;
tx_simpro_pmc_w          REGRA_AJUSTE_MATERIAL.TX_SIMPRO_PMC%type;
tx_simpro_neg_pmc_w      REGRA_AJUSTE_MATERIAL.TX_SIMPRO_NEG_PMC%type;
tx_simpro_neg_pfb_w      REGRA_AJUSTE_MATERIAL.TX_SIMPRO_NEG_PFB%type;
qt_idade_min_w           REGRA_AJUSTE_MATERIAL.QT_IDADE_MIN%type;
qt_idade_max_w           REGRA_AJUSTE_MATERIAL.QT_IDADE_MAX%type;
nr_seq_proc_interno_w    REGRA_AJUSTE_MATERIAL.NR_SEQ_PROC_INTERNO%type;
qt_dias_inter_inicio_w   REGRA_AJUSTE_MATERIAL.QT_DIAS_INTER_INICIO%type;
qt_dias_inter_final_w    REGRA_AJUSTE_MATERIAL.QT_DIAS_INTER_FINAL%type;
ie_tipo_kit_w            REGRA_AJUSTE_MATERIAL.IE_TIPO_KIT%type;
ie_atend_retorno_w       REGRA_AJUSTE_MATERIAL.IE_ATEND_RETORNO%type;
ds_observacao_w          REGRA_AJUSTE_MATERIAL.DS_OBSERVACAO%type;
ie_ignora_divisao_bras_w REGRA_AJUSTE_MATERIAL.IE_IGNORA_DIVISAO_BRAS%type;
ie_reconstituinte_w      REGRA_AJUSTE_MATERIAL.IE_RECONSTITUINTE%type;
ie_existe_tabela_w       REGRA_AJUSTE_MATERIAL.IE_EXISTE_TABELA%type;
ie_estrangeiro_w         REGRA_AJUSTE_MATERIAL.IE_ESTRANGEIRO%type;
ie_tipo_preco_autor_w	 REGRA_AJUSTE_MATERIAL.IE_TIPO_PRECO_AUTOR%type;


C001 CURSOR FOR
SELECT	nr_sequencia,
	cd_estabelecimento,
	dt_inicio_vigencia,
	cd_grupo_material,
	cd_subgrupo_material,
	cd_classe_material,
	cd_kit_material,
	cd_material,
	tx_ajuste,
	vl_negociado,
	ie_preco_informado,
	ie_glosa,
	ie_kit_material,
	tx_brasindice_pfb,
	tx_brasindice_pmc,
	tx_afaturar,
	dt_final_vigencia,
	cd_tipo_acomodacao,
	ie_tipo_atendimento,
	cd_setor_atendimento,
	ie_origem_preco,
	ie_precedencia_preco,
	pr_glosa,
	ie_tipo_material,
	tx_pmc_neg,
	tx_pmc_pos,
	CD_CID,
	CD_TABELA_PRECO,
	CD_MOTIVO_EXC_CONTA,
	ie_sexo,
	cd_plano,
	coalesce(ie_autor_particular,'N'),
	ie_data_referencia_vig,
	tx_pfb_neg,
	tx_pfb_pos,
	nr_seq_estrutura,
	cd_tipo_baixa,
	ie_clinica,
	cd_convenio_glosa,
	cd_categoria_glosa,
	nr_seq_classificacao,
	tx_simpro_pfb,
	tx_simpro_pos_pmc,
	tx_simpro_pos_pfb,
	tx_simpro_pmc,
	tx_simpro_neg_pmc,
	tx_simpro_neg_pfb,
	qt_idade_min,
	qt_idade_max,
	nr_seq_proc_interno,
	qt_dias_inter_inicio,
	qt_dias_inter_final,
	ie_tipo_kit,
	ie_atend_retorno,
	ds_observacao,
	ie_ignora_divisao_bras,
	ie_reconstituinte,
	ie_existe_tabela,
	ie_estrangeiro,
	ie_tipo_preco_autor
from	regra_ajuste_material
where	cd_convenio = cd_convenio_origem_p
  and (cd_categoria = cd_categoria_origem_p or coalesce(cd_categoria_origem_p::text, '') = '')
  and (cd_plano = cd_plano_origem_p or coalesce(cd_plano_origem_p::text, '') = '' or coalesce(cd_plano::text, '') = '')
  and	ie_situacao = 'A'
  and 	cd_estabelecimento = cd_estabelecimento_orig_p
  and	((ie_copia_grupo_p = 'S' AND cd_grupo_material IS NOT NULL AND cd_grupo_material::text <> '')
  	or	(ie_copia_subgrupo_p = 'S' AND cd_subgrupo_material IS NOT NULL AND cd_subgrupo_material::text <> '') 
  	or	(ie_copia_classe_p = 'S' AND cd_classe_material IS NOT NULL AND cd_classe_material::text <> '') 
  	or	(ie_copia_material_p = 'S' AND cd_material IS NOT NULL AND cd_material::text <> ''));


BEGIN

delete FROM regra_ajuste_material
where cd_convenio = cd_convenio_destino_p
  and cd_categoria = cd_categoria_destino_p
  and cd_plano = cd_plano_destino_p
  and cd_estabelecimento = cd_estabelecimento_dest_p
  and	((ie_copia_grupo_p = 'S' AND cd_grupo_material IS NOT NULL AND cd_grupo_material::text <> '')
  	or	(ie_copia_subgrupo_p = 'S' AND cd_subgrupo_material IS NOT NULL AND cd_subgrupo_material::text <> '')
  	or	(ie_copia_classe_p = 'S' AND cd_classe_material IS NOT NULL AND cd_classe_material::text <> '') 
  	or	(ie_copia_material_p = 'S' AND cd_material IS NOT NULL AND cd_material::text <> ''));

open c001;
loop
fetch c001 into
		nr_sequencia_ww,
		cd_estabelecimento_w,
		dt_inicio_vigencia_w,
		cd_grupo_material_w,
		cd_subgrupo_material_w,
		cd_classe_material_w,
		cd_kit_material_w,
		cd_material_w,
		tx_ajuste_w,
		vl_negociado_w,
		ie_preco_informado_w,
		ie_glosa_w,
		ie_kit_material_w,
		tx_brasindice_pfb_w,
		tx_brasindice_pmc_w,
		tx_afaturar_w,
		dt_final_vigencia_w,
		cd_tipo_acomodacao_w,
		ie_tipo_atendimento_w,
		cd_setor_atendimento_w,
		ie_origem_preco_w,
		ie_precedencia_preco_w,
		pr_glosa_w,
		ie_tipo_material_w,
		tx_pmc_neg_w,
		tx_pmc_pos_w,
		CD_CID_w,
		CD_TABELA_PRECO_w,
		CD_MOTIVO_EXC_CONTA_w,
		ie_sexo_w,
		cd_plano_w,
		ie_autor_particular_w,
		ie_data_referencia_vig_w,
		tx_pfb_neg_w,
		tx_pfb_pos_w,
		nr_seq_estrutura_w,
		cd_tipo_baixa_w,
		ie_clinica_w,
		cd_convenio_glosa_w,
		cd_categoria_glosa_w,
		nr_seq_classificacao_w,
		tx_simpro_pfb_w,
		tx_simpro_pos_pmc_w,
		tx_simpro_pos_pfb_w,
		tx_simpro_pmc_w,
		tx_simpro_neg_pmc_w,
		tx_simpro_neg_pfb_w,
		qt_idade_min_w,
		qt_idade_max_w,
		nr_seq_proc_interno_w,
		qt_dias_inter_inicio_w,
		qt_dias_inter_final_w,
		ie_tipo_kit_w,
		ie_atend_retorno_w,
		ds_observacao_w,
		ie_ignora_divisao_bras_w,
		ie_reconstituinte_w,
		ie_existe_tabela_w,
		ie_estrangeiro_w,
		ie_tipo_preco_autor_w;
	EXIT WHEN NOT FOUND; /* apply on c001 */
		begin
		select nextval('regra_ajuste_material_seq')
		into STRICT  nr_sequencia_w
		;
		
		/* Verifica se existe a tabela de pre√ßos no estabelecimento de destino*/

		if (coalesce(CD_TABELA_PRECO_w,0) <> 0) then
			begin
				
			select 	count(*)
			into STRICT	qt_tab_w
			from 	tabela_preco_material
			where 	cd_tab_preco_mat = CD_TABELA_PRECO_w
			and 	cd_estabelecimento = cd_estabelecimento_dest_p;
		
			if (qt_tab_w > 0) then
				begin
				insert into regra_ajuste_material(
					nr_sequencia,
					cd_estabelecimento,
					cd_convenio,
					dt_inicio_vigencia,
					ie_situacao,
					dt_atualizacao,
					nm_usuario,
					cd_categoria,
					cd_grupo_material,
					cd_subgrupo_material,
					cd_classe_material,
					cd_material,
					tx_ajuste,
					vl_negociado,
					ie_preco_informado,
					ie_glosa,
					tx_brasindice_pfb,
					tx_brasindice_pmc,
					tx_afaturar,
					dt_final_vigencia,
					cd_tipo_acomodacao,
					ie_tipo_atendimento,
					cd_setor_atendimento,
					ie_origem_preco,
					ie_precedencia_preco,
					pr_glosa,
					ie_tipo_material,
					tx_pmc_neg,
					tx_pmc_pos,
					CD_CID,
					CD_TABELA_PRECO,
					CD_MOTIVO_EXC_CONTA,
					ie_sexo,
					cd_plano,
					ie_autor_particular,
					ie_kit_material,
					cd_kit_material,
					ie_data_referencia_vig,
					tx_pfb_neg,
					tx_pfb_pos,
					nr_seq_estrutura,
					cd_tipo_baixa,
					ie_clinica,
					cd_convenio_glosa,
					cd_categoria_glosa,
					nr_seq_classificacao,
					tx_simpro_pfb,
					tx_simpro_pos_pmc,
					tx_simpro_pos_pfb,
					tx_simpro_pmc,
					tx_simpro_neg_pmc,
					tx_simpro_neg_pfb,
					qt_idade_min,
					qt_idade_max,
					nr_seq_proc_interno,
					qt_dias_inter_inicio,
					qt_dias_inter_final,
					ie_tipo_kit,
					ie_atend_retorno,
					ds_observacao,
					ie_ignora_divisao_bras,
					ie_reconstituinte,
					ie_existe_tabela,
					ie_estrangeiro,
					ie_tipo_preco_autor)
				values ( nr_sequencia_w,
					cd_estabelecimento_dest_p,
					cd_convenio_destino_p,
					dt_inicio_vigencia_w,
					'A',
					clock_timestamp(),
					nm_usuario_p,
					cd_categoria_destino_p,
					cd_grupo_material_w,
					cd_subgrupo_material_w,
					cd_classe_material_w,
					cd_material_w,
					tx_ajuste_w,
					vl_negociado_w,
					ie_preco_informado_w,
					ie_glosa_w,
					tx_brasindice_pfb_w,
					tx_brasindice_pmc_w,
					tx_afaturar_w,
					dt_final_vigencia_w,
					cd_tipo_acomodacao_w,
					ie_tipo_atendimento_w,
					cd_setor_atendimento_w,
					ie_origem_preco_w,
					ie_precedencia_preco_w,
					pr_glosa_w,
					ie_tipo_material_w,
					tx_pmc_neg_w,
					tx_pmc_pos_w,
					CD_CID_w,
					CD_TABELA_PRECO_w,
					CD_MOTIVO_EXC_CONTA_w,
					ie_sexo_w,
					cd_plano_w,
					ie_autor_particular_w,
					ie_kit_material_w,
					cd_kit_material_w,
					ie_data_referencia_vig_w,
					tx_pfb_neg_w,
					tx_pfb_pos_w,
					nr_seq_estrutura_w,
					cd_tipo_baixa_w,
					ie_clinica_w,
					cd_convenio_glosa_w,
					cd_categoria_glosa_w,
					nr_seq_classificacao_w,
					tx_simpro_pfb_w,
					tx_simpro_pos_pmc_w,
					tx_simpro_pos_pfb_w,
					tx_simpro_pmc_w,
					tx_simpro_neg_pmc_w,
					tx_simpro_neg_pfb_w,
					qt_idade_min_w,
					qt_idade_max_w,
					nr_seq_proc_interno_w,
					qt_dias_inter_inicio_w,
					qt_dias_inter_final_w,
					ie_tipo_kit_w,
					ie_atend_retorno_w,
					ds_observacao_w,
					ie_ignora_divisao_bras_w,
					ie_reconstituinte_w,
					ie_existe_tabela_w,
					ie_estrangeiro_w,
					ie_tipo_preco_autor_w);
				end;
			end if;
			end;
		else
			begin	
			insert into regra_ajuste_material(
				nr_sequencia,
				cd_estabelecimento,
				cd_convenio,
				dt_inicio_vigencia,
				ie_situacao,
				dt_atualizacao,
				nm_usuario,
				cd_categoria,
				cd_grupo_material,
				cd_subgrupo_material,
				cd_classe_material,
				cd_material,
				tx_ajuste,
				vl_negociado,
				ie_preco_informado,
				ie_glosa,
				tx_brasindice_pfb,
				tx_brasindice_pmc,
				tx_afaturar,
				dt_final_vigencia,
				cd_tipo_acomodacao,
				ie_tipo_atendimento,
				cd_setor_atendimento,
				ie_origem_preco,
				ie_precedencia_preco,
				pr_glosa,
				ie_tipo_material,
				tx_pmc_neg,
				tx_pmc_pos,
				CD_CID,
				CD_TABELA_PRECO,
				CD_MOTIVO_EXC_CONTA,
				ie_sexo,
				cd_plano,
				ie_autor_particular,
				ie_kit_material,
				cd_kit_material,
				ie_data_referencia_vig,
				tx_pfb_neg,
				tx_pfb_pos,
				nr_seq_estrutura,
				cd_tipo_baixa,
				ie_clinica,
				cd_convenio_glosa,
				cd_categoria_glosa,
				nr_seq_classificacao,
				tx_simpro_pfb,
				tx_simpro_pos_pmc,
				tx_simpro_pos_pfb,
				tx_simpro_pmc,
				tx_simpro_neg_pmc,
				tx_simpro_neg_pfb,
				qt_idade_min,
				qt_idade_max,
				nr_seq_proc_interno,
				qt_dias_inter_inicio,
				qt_dias_inter_final,
				ie_tipo_kit,
				ie_atend_retorno,
				ds_observacao,
				ie_ignora_divisao_bras,
				ie_reconstituinte,
				ie_existe_tabela,
				ie_estrangeiro,
				ie_tipo_preco_autor)
			values ( nr_sequencia_w,
				cd_estabelecimento_dest_p,
				cd_convenio_destino_p,
				dt_inicio_vigencia_w,
				'A',
				clock_timestamp(),
				nm_usuario_p,
				cd_categoria_destino_p,
				cd_grupo_material_w,
				cd_subgrupo_material_w,
				cd_classe_material_w,
				cd_material_w,
				tx_ajuste_w,
				vl_negociado_w,
				ie_preco_informado_w,
				ie_glosa_w,
				tx_brasindice_pfb_w,
				tx_brasindice_pmc_w,
				tx_afaturar_w,
				dt_final_vigencia_w,
				cd_tipo_acomodacao_w,
				ie_tipo_atendimento_w,
				cd_setor_atendimento_w,
				ie_origem_preco_w,
				ie_precedencia_preco_w,
				pr_glosa_w,
				ie_tipo_material_w,
				tx_pmc_neg_w,
				tx_pmc_pos_w,
				CD_CID_w,
				CD_TABELA_PRECO_w,
				CD_MOTIVO_EXC_CONTA_w,
				ie_sexo_w,
				coalesce(cd_plano_destino_p, CD_PLANO_w),
				ie_autor_particular_w,
				ie_kit_material_w,
				cd_kit_material_w,
				ie_data_referencia_vig_w,
				tx_pfb_neg_w,
				tx_pfb_pos_w,
				nr_seq_estrutura_w,
				cd_tipo_baixa_w,
				ie_clinica_w,
				cd_convenio_glosa_w,
				cd_categoria_glosa_w,
				nr_seq_classificacao_w,
				tx_simpro_pfb_w,
				tx_simpro_pos_pmc_w,
				tx_simpro_pos_pfb_w,
				tx_simpro_pmc_w,
				tx_simpro_neg_pmc_w,
				tx_simpro_neg_pfb_w,
				qt_idade_min_w,
				qt_idade_max_w,
				nr_seq_proc_interno_w,
				qt_dias_inter_inicio_w,
				qt_dias_inter_final_w,
				ie_tipo_kit_w,
				ie_atend_retorno_w,
				ds_observacao_w,
				ie_ignora_divisao_bras_w,
				ie_reconstituinte_w,
				ie_existe_tabela_w,
				ie_estrangeiro_w,
				ie_tipo_preco_autor_w
				);
			end;
		end if;
		end;
		insert into regra_ajuste_item_ref(
				nr_sequencia, dt_atualizacao, dt_atualizacao_nrec, nm_usuario, nm_usuario_nrec, cd_material, cd_procedimento, ie_situacao, nr_seq_regra_ajuste_mat)
			SELECT 	nextval('regra_ajuste_material_seq'), clock_timestamp(), clock_timestamp(), nm_usuario_p, nm_usuario_p, cd_material, cd_procedimento, ie_situacao, nr_sequencia_w
			from    regra_ajuste_item_ref
			where 	nr_seq_regra_ajuste_mat = nr_sequencia_ww;
		
		insert into regra_ajuste_mat_aviso(
				nr_sequencia, dt_atualizacao, dt_atualizacao_nrec, nm_usuario, nm_usuario_nrec, nm_usuario_aviso, cd_perfil_aviso, nr_seq_regra)
			SELECT 	nextval('regra_ajuste_material_seq'), clock_timestamp(), clock_timestamp(), nm_usuario_p, nm_usuario_p, nm_usuario_aviso, cd_perfil_aviso, nr_sequencia_w
			from 	regra_ajuste_mat_aviso
			where 	nr_seq_regra = nr_sequencia_ww;
end loop;
close c001;
commit;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE copia_ajuste_mat (CD_CONVENIO_ORIGEM_P bigint, CD_CATEGORIA_ORIGEM_P text, CD_CONVENIO_DESTINO_P bigint, CD_CATEGORIA_DESTINO_P text, IE_COPIA_GRUPO_P text, IE_COPIA_SUBGRUPO_P text, IE_COPIA_CLASSE_P text, IE_COPIA_MATERIAL_P text, CD_ESTABELECIMENTO_ORIG_P bigint, CD_ESTABELECIMENTO_DEST_P bigint, NM_USUARIO_P text, cd_plano_origem_p text, cd_plano_destino_p text) FROM PUBLIC;

