-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_transferencia_rn ( nr_atendimento_p bigint, cd_setor_atendimento_p bigint, cd_unidade_basica_p text, cd_unidade_compl_p text, nr_seq_motivo_transf_p bigint, ds_observacao_p text, nm_usuario_p text, dt_entrada_unidade_p timestamp) AS $body$
DECLARE

 
nr_seq_unidade_rn_w	bigint;	
cd_setor_rn_w		integer;
cd_unidade_basica_rn_w	varchar(10);
cd_unidade_compl_rn_w	varchar(10);
cd_tipo_acomod_rn_w	smallint;
nr_atendimento_rn_w	bigint;

C01 CURSOR FOR 
	SELECT	nr_atendimento 
	from	atendimento_paciente 
	where	nr_atendimento_mae = nr_atendimento_p  --atendimento da mae 
	and coalesce(dt_alta::text, '') = '';				
					 

BEGIN 
 
if (coalesce(nr_atendimento_p,0) > 0) and (coalesce(cd_setor_atendimento_p,0) > 0) then 
 
	select	coalesce(max(nr_seq_unidade_rn),0) 
	into STRICT	nr_seq_unidade_rn_w 
    from	unidade_atendimento 
    where	cd_setor_atendimento = cd_setor_atendimento_p 
    and	cd_unidade_basica = cd_unidade_basica_p 
	and	cd_unidade_compl = cd_unidade_compl_p;
	 
	if (nr_seq_unidade_rn_w > 0) then 
		 
		select	max(cd_setor_atendimento), 
			max(cd_unidade_basica), 
			max(cd_unidade_compl), 
			max(cd_tipo_acomodacao) 
		into STRICT	cd_setor_rn_w, 
			cd_unidade_basica_rn_w, 
			cd_unidade_compl_rn_w, 
			cd_tipo_acomod_rn_w 
		from	unidade_atendimento 
		where	nr_seq_interno = nr_seq_unidade_rn_w;
		 
 
		open C01;
		loop 
		fetch C01 into	 
			nr_atendimento_rn_w;
		EXIT WHEN NOT FOUND; /* apply on C01 */
			begin 
			CALL Gerar_Transferencia_Paciente(nr_atendimento_rn_w, 
						   cd_setor_rn_w, 
						   cd_unidade_basica_rn_w, 
						   cd_unidade_compl_rn_w, 
						   cd_tipo_acomod_rn_w, 
						   0, 
						   nr_seq_motivo_transf_p, 
						   ds_observacao_p, 
						   nm_usuario_p, 
						   dt_entrada_unidade_p);
			end;
		end loop;
		close C01;
		 
	end if;
 
end if;
 
if (coalesce(wheb_usuario_pck.get_ie_commit, 'S') = 'S') then commit; end if;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_transferencia_rn ( nr_atendimento_p bigint, cd_setor_atendimento_p bigint, cd_unidade_basica_p text, cd_unidade_compl_p text, nr_seq_motivo_transf_p bigint, ds_observacao_p text, nm_usuario_p text, dt_entrada_unidade_p timestamp) FROM PUBLIC;

