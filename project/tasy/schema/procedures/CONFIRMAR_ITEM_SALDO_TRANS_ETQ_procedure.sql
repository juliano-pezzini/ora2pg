-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE confirmar_item_saldo_trans_etq (nr_ordem_compra_p bigint, nr_item_oci_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text, ie_gerar_disponivel_p text, qt_solicitada_p INOUT bigint, qt_pendente_p INOUT bigint, qt_atendido_p INOUT bigint, qt_consistido_barras_p INOUT bigint, qt_consistido_manual_p INOUT bigint, qt_saldo_disp_p INOUT bigint, ds_erro_p INOUT text) AS $body$
DECLARE


cd_local_estoque_w		smallint;
cd_material_w			integer;
cd_unidade_medida_compra_w	varchar(30);
cd_unidade_medida_estoque_w	varchar(30);
qt_saldo_disp_w			double precision;
qt_material_w			double precision;
qt_atendido_w			double precision;
qt_consistido_barras_w		double precision;
qt_consistido_manual_w		double precision;
dt_mesano_referencia_w		timestamp;
qt_pendente_w			double precision;
qt_gerar_w			double precision;


BEGIN
ds_erro_p := null;

select 	trunc(clock_timestamp(),'month')
into STRICT	dt_mesano_referencia_w
from 	parametro_estoque
where 	cd_estabelecimento = cd_estabelecimento_p;

select	cd_material,
	cd_unidade_medida_compra,
	qt_material
into STRICT	cd_material_w,
	cd_unidade_medida_compra_w,
	qt_material_w
from	ordem_compra_item
where	nr_ordem_compra = nr_ordem_compra_p
and	nr_item_oci = nr_item_oci_p;

select	substr(obter_dados_material_estab(cd_material,cd_estabelecimento_p,'UME'),1,30) cd_unidade_medida_estoque
into STRICT	cd_unidade_medida_estoque_w
from	material
where	cd_material = cd_material_w;

cd_local_estoque_w := (obter_valor_param_usuario(146, 16, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p))::numeric;

if (coalesce(cd_local_estoque_w,0) = 0) then
	select	cd_local_transf
	into STRICT	cd_local_estoque_w
	from	ordem_compra
	where	nr_ordem_compra = nr_ordem_compra_p;
end if;

qt_saldo_disp_w		:= obter_saldo_disp_estoque(cd_estabelecimento_p,cd_material_w, cd_local_estoque_w, dt_mesano_referencia_w);
qt_material_w		:= obter_quantidade_convertida(cd_material_w, qt_material_w, cd_unidade_medida_compra_w,'UME');

select	coalesce(sum(a.qt_item_estoque),0)
into STRICT	qt_atendido_w
from	nota_fiscal b,
	nota_fiscal_item a
where	a.nr_ordem_compra = nr_ordem_compra_p
and	a.nr_item_oci = nr_item_oci_p
and	b.nr_sequencia = a.nr_sequencia
and	b.ie_situacao = '1'
and	obter_se_nota_entrada_saida(a.nr_sequencia) = 'S';

select	coalesce(sum(obter_quantidade_convertida(b.cd_material, b.qt_material, b.cd_unidade_medida_compra, 'UME')),0)
into STRICT	qt_consistido_barras_w
from	ordem_compra_item_cb b
where	b.nr_ordem_compra = b.nr_ordem_compra
and	coalesce(b.nr_seq_nota::text, '') = ''
and	b.ie_atende_recebe = 'A'
and	b.nr_ordem_compra = nr_ordem_compra_p
and	b.nr_item_oci     = nr_item_oci_p
and	coalesce(b.ie_status,'CB') = 'CB';

select	coalesce(sum(obter_quantidade_convertida(b.cd_material, b.qt_material, b.cd_unidade_medida_compra, 'UME')),0)
into STRICT	qt_consistido_manual_w
from	ordem_compra_item_cb b
where	b.nr_ordem_compra = b.nr_ordem_compra
and	coalesce(b.nr_seq_nota::text, '') = ''
and	b.ie_atende_recebe = 'A'
and	b.nr_ordem_compra = nr_ordem_compra_p
and	b.nr_item_oci     = nr_item_oci_p
and	coalesce(b.ie_status,'CB') = 'CM';

qt_pendente_w := qt_material_w - qt_atendido_w;

if (qt_pendente_w > 0) and
	(qt_pendente_w > (qt_consistido_manual_w + qt_consistido_barras_w)) then
	begin
	if (qt_saldo_disp_w < qt_pendente_w) and (coalesce(ie_gerar_disponivel_p,'N') = 'N') then
		begin
		ds_erro_p	:= 'S';
		qt_pendente_p := qt_pendente_w;
		qt_atendido_p := qt_atendido_w;
		qt_consistido_barras_p := qt_consistido_barras_w;
		qt_consistido_manual_p := qt_consistido_manual_w;
		qt_saldo_disp_p := qt_saldo_disp_w;
		qt_solicitada_p	:= qt_material_w;
		end;
	else
		begin
		ds_erro_p	:= null;
		qt_pendente_p := null;
		qt_atendido_p := null;
		qt_consistido_barras_p := null;
		qt_consistido_manual_p := null;
		qt_saldo_disp_p := null;
		qt_solicitada_p	:= null;

		qt_gerar_w := qt_pendente_w - qt_consistido_barras_w;

		if (qt_gerar_w > 0) then
			begin
			if (qt_gerar_w > qt_saldo_disp_w) then
				qt_gerar_w := qt_saldo_disp_w;
			end if;
			if (cd_unidade_medida_estoque_w <> cd_unidade_medida_compra_w) then
				qt_gerar_w := obter_quantidade_convertida(cd_material_w, qt_gerar_w, cd_unidade_medida_estoque_w, 'UMP');
			end if;
			CALL gravar_itens_consist_manual(nr_ordem_compra_p,nr_item_oci_p,qt_gerar_w,nm_usuario_p);
			end;
		end if;
		end;
	end if;
	end;
end if;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE confirmar_item_saldo_trans_etq (nr_ordem_compra_p bigint, nr_item_oci_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text, ie_gerar_disponivel_p text, qt_solicitada_p INOUT bigint, qt_pendente_p INOUT bigint, qt_atendido_p INOUT bigint, qt_consistido_barras_p INOUT bigint, qt_consistido_manual_p INOUT bigint, qt_saldo_disp_p INOUT bigint, ds_erro_p INOUT text) FROM PUBLIC;

