-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE lic_gerar_itens_licitacao ( nr_seq_lic_p bigint, cd_estabelecimento_p bigint, ie_opcao_regra_p bigint, ie_curva_abc_p text, cd_grupo_material_p bigint, cd_subgrupo_material_p bigint, cd_classe_material_p bigint, dt_entrega_p text, cd_local_estoque_p bigint, ie_padronizado_p text, ie_somente_saldo_p text, nm_usuario_p text, qt_dias_p bigint) AS $body$
DECLARE

					 
 
/* 
ie_opcao_regra_p : 
0 - MÃ­nimo 
1 - Ponto Pedido 
2 - Ambos 
null - todos 
*/
 
 
 
ie_regra_ressup_w	varchar(15);
nr_seq_item_w		bigint;
qt_item_w		double precision;
cd_material_w		integer;
qt_consumo_mensal_w	double precision;
cd_unidade_medida_w	varchar(30);

 
c01 CURSOR FOR 
SELECT a.cd_material, 
	a.qt_consumo_mensal, 
	substr(obter_dados_material_estab(c.cd_material,cd_estabelecimento_p,'UMC'),1,255) cd_unidade_medida_compra 
from  material c, 
	estrutura_material_v b, 
	material_Ressuprimento_v a 
where a.cd_material = b.cd_material 
and  a.cd_material = c.cd_material 
and  c.ie_situacao = 'A' 
and	((	 
		(a.qt_estoque < a.qt_estoque_minimo and ie_opcao_regra_p = 0) 						or (a.qt_estoque > a.qt_estoque_minimo and a.qt_estoque < a.qt_ponto_pedido and ie_opcao_regra_p = 1) 	or (a.qt_estoque < a.qt_ponto_pedido and ie_opcao_regra_p = 2) 						and (ie_regra_ressup_w = WHEB_MENSAGEM_PCK.get_texto(310607)) 
	 ) 
	or 	 
	(	 
	(a.qt_estoque <= a.qt_estoque_minimo and ie_opcao_regra_p = 0) 						or (a.qt_estoque > a.qt_estoque_minimo and a.qt_estoque <= a.qt_ponto_pedido and ie_opcao_regra_p = 1) 	or (a.qt_estoque <= a.qt_ponto_pedido and ie_opcao_regra_p = 2) 						and (coalesce(ie_regra_ressup_w::text, '') = '') 
	) 
	or coalesce(ie_opcao_regra_p::text, '') = '' 
	) 
and (exists (SELECT 	1 
		from 	saldo_estoque s, 
			material m 
		where 	s.cd_material = m.cd_material_estoque 
		and 	m.cd_material = a.cd_material 
		and 	to_char(s.dt_mesano_referencia, 'mm/yyyy') like dt_entrega_p 
		and 	s.cd_local_estoque = cd_local_estoque_p) or ie_somente_saldo_p = 'N') 
and	substr(obter_se_material_padronizado(cd_estabelecimento_p, c.cd_material),1,1) = ie_padronizado_p 
and	a.ie_curva_abc = coalesce(ie_curva_abc_p, a.ie_curva_abc) 
and	b.cd_grupo_material = coalesce(cd_grupo_material_p, b.cd_grupo_material) 
and	b.cd_subgrupo_material = coalesce(cd_subgrupo_material_p, b.cd_subgrupo_material) 
and	b.cd_classe_material = coalesce(cd_classe_material_p, b.cd_classe_material);

 

BEGIN 
begin 
select	ie_regra_ressup 
into STRICT	ie_regra_ressup_w 
from 	parametro_compras 
where 	cd_estabelecimento = cd_estabelecimento_p;
exception 
	when no_data_found then 
		ie_regra_ressup_w := null;
end;
open c01;
loop 
fetch c01 into 
	cd_material_w, 
    	qt_consumo_mensal_w, 
    	cd_unidade_medida_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	qt_item_w := (qt_consumo_mensal_w / 30) * qt_dias_p;
	select 	coalesce(max(nr_seq_item), 0) + 1 
	into STRICT	nr_seq_item_w 
	from	lic_item 
	where 	nr_seq_licitacao = nr_seq_lic_p;
	insert into lic_item(nr_sequencia, 
		nr_seq_licitacao, 
		CD_MATERIAL, 
		NR_SEQ_ITEM, 
		DT_ATUALIZACAO, 
		NM_USUARIO, 
		QT_ITEM, 
		DS_ADICIONAL, 
		CD_UNID_MEDIDA) 
	values (nextval('lic_item_seq'), 
		nr_seq_lic_p, 
		CD_MATERIAL_w, 
		nr_seq_item_w, 
		clock_timestamp(), 
		nm_usuario_p, 
		trunc(coalesce(qt_item_w, 0)), 
		'', 
		cd_unidade_medida_w);
end loop;
close c01;
commit;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE lic_gerar_itens_licitacao ( nr_seq_lic_p bigint, cd_estabelecimento_p bigint, ie_opcao_regra_p bigint, ie_curva_abc_p text, cd_grupo_material_p bigint, cd_subgrupo_material_p bigint, cd_classe_material_p bigint, dt_entrega_p text, cd_local_estoque_p bigint, ie_padronizado_p text, ie_somente_saldo_p text, nm_usuario_p text, qt_dias_p bigint) FROM PUBLIC;

