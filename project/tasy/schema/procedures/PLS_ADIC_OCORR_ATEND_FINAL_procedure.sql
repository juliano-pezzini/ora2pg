-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_adic_ocorr_atend_final ( nr_seq_atendimento_p bigint, nr_seq_ocorrencia_p bigint, nr_seq_evento_p bigint, ds_observacao_p text, nm_usuario_p text, cd_estabelecimento_p bigint) AS $body$
DECLARE


ds_historico_w			varchar(255);
nr_seq_tipo_historico_w		bigint;


BEGIN

insert	into pls_atendimento_evento(nr_sequencia, nr_seq_atendimento, ie_tipo_ocorrencia,
	 nr_seq_evento, dt_inicio, ie_status,
	 dt_atualizacao, nm_usuario, dt_conclusao,
	 dt_fim_evento, ds_observacao, nr_seq_tipo_ocorrencia,
	 qt_evento_realizado, nr_seq_regra_tempo)
values (nextval('pls_atendimento_evento_seq'), nr_seq_atendimento_p, null,
	 nr_seq_evento_p, clock_timestamp(), 'C',
	 clock_timestamp(), nm_usuario_p, clock_timestamp(),
	 clock_timestamp(), substr(ds_observacao_p,1,4000), nr_seq_ocorrencia_p,
	 1, null);

begin
	select	ds_valor_dominio
	into STRICT	ds_historico_w
	from	valor_dominio
	where	cd_dominio	= 3394
	and	vl_dominio	= 10
	and	ie_situacao	= 'A';
exception
when others then
	ds_historico_w	:= 'Inseriu ocorrência no atendimento finalizado.';
end;

ds_historico_w	:= ds_historico_w||chr(13)||'Usuário: '||nm_usuario_p||chr(13)||'Data\hora: '||to_char(clock_timestamp(),'dd/mm/yyyy hh24:mi:ss');

if (pls_obter_se_controle_estab('GA') = 'S') then
	select	max(nr_sequencia)
	into STRICT	nr_seq_tipo_historico_w
	from	pls_tipo_historico_atend
	where	ie_gerado_sistema	= 'S'
	and	ie_situacao		= 'A'
	and (cd_estabelecimento = cd_estabelecimento_p );
else
	select	max(nr_sequencia)
	into STRICT	nr_seq_tipo_historico_w
	from	pls_tipo_historico_atend
	where	ie_gerado_sistema	= 'S'
	and	ie_situacao		= 'A';
end if;

insert	into pls_atendimento_historico( nr_sequencia, nr_seq_atendimento, ds_historico_long,
	 dt_atualizacao, nm_usuario, dt_atualizacao_nrec,
	 nm_usuario_nrec, nr_seq_tipo_historico, dt_historico,
	 ie_origem_historico, ie_gerado_sistema)
values (nextval('pls_atendimento_historico_seq'), nr_seq_atendimento_p, ds_historico_w,
	 clock_timestamp(), nm_usuario_p, clock_timestamp(),
	 nm_usuario_p, nr_seq_tipo_historico_w, clock_timestamp(),
	 10,'S');

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_adic_ocorr_atend_final ( nr_seq_atendimento_p bigint, nr_seq_ocorrencia_p bigint, nr_seq_evento_p bigint, ds_observacao_p text, nm_usuario_p text, cd_estabelecimento_p bigint) FROM PUBLIC;

