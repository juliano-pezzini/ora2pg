-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_w_hfp_prescr_carga ( nr_seq_avaliacao_p bigint, ds_maquina_p text, nm_usuario_p text) AS $body$
DECLARE


--variaveis validadas
nr_seq_carga_w		bigint;
nr_seq_exercicio_w	bigint;
ds_comando_w		varchar(4000);
ds_sql_exerc_cria_w	varchar(2000);
ds_sql_exerc_w		varchar(2000);
ds_sql_seq_exerc_cria_w	varchar(2000);
ds_sql_seq_exerc_w	varchar(2000);
nr_atributo_w		smallint;
nr_sequencia_w		bigint;
ds_exercicio_w		varchar(80);
nr_seq_etapa_w		bigint;
ds_etapa_w		varchar(80);
qt_valor_w		real;

qt_w bigint;

C01 CURSOR FOR 	-- Cabeçalho: Etapas
	SELECT DISTINCT a.nr_seq_etapa,
			b.ds_etapa
	FROM	hfp_prescr_cargas a,
		hfp_etapa b
	WHERE	a.nr_seq_etapa = b.nr_sequencia
	AND	a.nr_seq_aval = nr_seq_avaliacao_p
	ORDER BY a.nr_seq_etapa;

C02 CURSOR FOR 	-- Painel esquerdo com os exercicios
	SELECT DISTINCT
		a.nr_seq_exercicio,
		b.ds_nome_curto
	FROM	hfp_prescr_cargas a,
		hfp_exercicio b
	WHERE	a.nr_seq_exercicio = b.nr_sequencia
	AND	a.nr_seq_aval = nr_seq_avaliacao_p
	ORDER BY b.ds_nome_curto;


BEGIN
-- Limpeza inicial da tabela
DELETE
FROM 	w_hfp_prescr_carga
WHERE 	nm_usuario = nm_usuario_p;
--and	ds_maquina = ds_maquina_p;
IF (nr_seq_avaliacao_p IS NOT NULL AND nr_seq_avaliacao_p::text <> '') THEN
	ds_exercicio_w	:= '';
	nr_atributo_w	:= 1;



	--Montar o cabeçalho IE_TIPO = 'C'
	OPEN C01;
	LOOP
	FETCH 	C01 INTO
		nr_seq_exercicio_w,
		ds_exercicio_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		BEGIN

		if (nr_atributo_w < 41) then

			ds_sql_exerc_w			:= ds_sql_exerc_w || CHR(39) || ds_exercicio_w || CHR(39) || ',';
			ds_sql_exerc_cria_w		:= ds_sql_exerc_cria_w || ' DS_RESULTADO' || nr_atributo_w || ',';

			ds_sql_seq_exerc_w		:= ds_sql_seq_exerc_w || CHR(39) || '0' || CHR(39) || ',';
			ds_sql_seq_exerc_cria_w		:= ds_sql_seq_exerc_cria_w || ' NR_SEQ_RESULTADO' || nr_atributo_w || ',';

			nr_atributo_w			:= nr_atributo_w + 1;

		end if;

		END;
	END LOOP;
	CLOSE C01;

	SELECT	nextval('w_hfp_prescr_carga_seq')
	INTO STRICT	nr_sequencia_w
	;



	ds_comando_w	:= ' insert into w_hfp_prescr_carga (	nr_sequencia, ' ||
								'ie_tipo, '||
								ds_sql_exerc_cria_w||
								ds_sql_seq_exerc_cria_w||
								'ds_exercicio, ' ||
								'ds_maquina, ' ||
								'nm_usuario) ' ||
							'values('|| nr_sequencia_w ||',' ||
								CHR(39)||'C'||CHR(39)||',' ||
								ds_sql_exerc_w ||
								ds_sql_seq_exerc_w ||
								CHR(39)||wheb_mensagem_pck.get_texto(802298)||CHR(39)||',' ||
								CHR(39)||ds_maquina_p||CHR(39)||','||
								CHR(39)||nm_usuario_p||CHR(39)||') ';
	CALL exec_sql_dinamico('TASY', ds_comando_w);



	--Montar as informações
	OPEN C02;
	LOOP
	FETCH C02 INTO
		nr_seq_exercicio_w,
		ds_exercicio_w;
	EXIT WHEN NOT FOUND; /* apply on C02 */
		BEGIN
		qt_valor_w		:= '';
		ds_sql_exerc_w		:= '';
		ds_sql_exerc_cria_w	:= '';
		ds_sql_seq_exerc_w	:= '';
		ds_sql_seq_exerc_cria_w	:= '';
		nr_atributo_w		:= 1;

		-- varre todas os exercícios para buscar os respectivos valores:
		OPEN C01;
		LOOP
		FETCH 	C01 INTO
			nr_seq_etapa_w,
			ds_etapa_w;
		EXIT WHEN NOT FOUND; /* apply on C01 */
			BEGIN

			if (nr_atributo_w < 41) then

				select 	max(nr_sequencia)
				into STRICT	nr_seq_carga_w
				from	hfp_prescr_cargas
				where	nr_seq_aval = nr_seq_avaliacao_p
				and	nr_seq_etapa = nr_seq_etapa_w
				and	nr_seq_exercicio = nr_seq_exercicio_w;

				select	sum(qt_valor)
				into STRICT	qt_valor_w
				from	hfp_prescr_cargas
				where	nr_sequencia = nr_seq_carga_w;

				ds_sql_exerc_w			:= ds_sql_exerc_w || CHR(39) || qt_valor_w || CHR(39) || ',';
				ds_sql_exerc_cria_w		:= ds_sql_exerc_cria_w || ' DS_RESULTADO' || nr_atributo_w || ',';

				ds_sql_seq_exerc_w		:= ds_sql_seq_exerc_w || CHR(39) || nr_seq_carga_w || CHR(39) || ',';
				ds_sql_seq_exerc_cria_w		:= ds_sql_seq_exerc_cria_w || ' NR_SEQ_RESULTADO' || nr_atributo_w || ',';

				nr_atributo_w			:= nr_atributo_w + 1;
			end if;

			END;
		END LOOP;
		CLOSE C01;

		SELECT	nextval('w_hfp_prescr_carga_seq')
		INTO STRICT	nr_sequencia_w
		;

		ds_comando_w	:= ' insert into w_hfp_prescr_carga (	nr_sequencia, ' ||
									'ie_tipo, '||
									ds_sql_exerc_cria_w||
									ds_sql_seq_exerc_cria_w||
									'ds_exercicio, '||
									'ds_maquina, ' ||
									'nm_usuario) '||
								'values('||nr_sequencia_w||','||
									CHR(39)||'D'||CHR(39)||','||
									ds_sql_exerc_w ||
									ds_sql_seq_exerc_w ||
									CHR(39)||ds_exercicio_w||CHR(39)||','||
									CHR(39)||ds_maquina_p||CHR(39)||','||
									CHR(39)||nm_usuario_p||CHR(39)||') ';
		CALL exec_sql_dinamico('TASY', ds_comando_w);



		END;
	END LOOP;

	CLOSE C02;
END IF;


COMMIT;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_w_hfp_prescr_carga ( nr_seq_avaliacao_p bigint, ds_maquina_p text, nm_usuario_p text) FROM PUBLIC;

