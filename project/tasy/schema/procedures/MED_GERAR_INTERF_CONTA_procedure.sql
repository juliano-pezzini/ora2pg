-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE med_gerar_interf_conta (nr_seq_protocolo_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint) AS $body$
DECLARE


nr_seq_protocolo_w			bigint		:= 0;
nr_seq_envio_convenio_w		bigint		:= 0;
dt_mesano_referencia_w		timestamp;
dt_vencimento_w			timestamp;
cd_convenio_w				integer		:= 0;
cd_cgc_hospital_w			varchar(14);
nm_hospital_w				varchar(80);
ds_convenio_w				varchar(255);
cd_cgc_convenio_w			varchar(14);
cd_interno_w				varchar(15);
cd_regional_w				varchar(15);
nr_sequencia_w			bigint		:= 0;
nr_interno_conta_w			bigint		:= 0;
nr_atendimento_w			bigint		:= 0;
ie_tipo_protocolo_w			smallint		:= 0;
ie_tipo_atendimento_w		smallint		:= 0;
ie_excluir_hon_med_w			varchar(1);
ie_excluir_hon_terc_w		varchar(1);
QT_ITENS_CONTA_W			bigint		:= 0;
nr_seq_registro_w			bigint		:= 0;
vl_material_w				double precision		:= 0;
nr_protocolo_w			varchar(40);
dt_inicio_protocolo_w		timestamp;
dt_fim_protocolo_w			timestamp;
nr_primeira_guia_w			varchar(10);
nr_ultima_guia_w			varchar(10);
qt_guia_w				integer := 0;
ie_agrup_item_interf_w		varchar(1);
w_tot_trailler_w			integer := 0;
qt_documento_w			bigint;
vl_procedimento_w			double precision;

C02 CURSOR FOR
SELECT 	a.nr_atendimento,
	a.nr_atendimento
from 	med_faturamento a
where 	a.nr_seq_protocolo	 	= nr_seq_protocolo_p
group by a.nr_atendimento
order by 1;


BEGIN


/* Limpar tabelas transitórias */

delete	from w_interf_conta_header
where 	nr_seq_protocolo	= nr_seq_protocolo_p
and	nm_usuario		= nm_usuario_p;

delete 	from w_interf_conta_cab
where 	nr_seq_protocolo	= nr_seq_protocolo_p
and	nm_usuario		= nm_usuario_p;

delete 	from w_interf_conta_item
where 	nr_seq_protocolo	= nr_seq_protocolo_p
and	nm_usuario		= nm_usuario_p;

delete 	from w_interf_conta_total
where 	nr_seq_protocolo	= nr_seq_protocolo_p
and	nm_usuario		= nm_usuario_p;

delete 	from w_interf_conta_trailler
where 	nr_seq_protocolo	= nr_seq_protocolo_p
and	nm_usuario		= nm_usuario_p;

commit;


/* Tratar registro tipo HEADER */

/* Buscar sequence */

select nextval('w_interf_conta_header_seq')
into STRICT	 nr_sequencia_w
;

/* Dados do protocolo */

select 	nr_sequencia,
	0,
	dt_referencia,
	dt_referencia,
	cd_convenio,
	0,
	nr_seq_externo,
	dt_inicio,
	dt_fim,
	CASE WHEN ie_beneficiario='M' THEN  cd_medico  ELSE cd_cgc END ,
	CASE WHEN ie_beneficiario='M' THEN  Elimina_Acentuacao(obter_nome_pessoa_fisica(cd_medico, null))  ELSE Elimina_Acentuacao(obter_razao_social(cd_cgc)) END
into STRICT	nr_seq_protocolo_w,
	nr_seq_envio_convenio_w,
	dt_mesano_referencia_w,
	dt_vencimento_w,
	cd_convenio_w,
	ie_tipo_protocolo_w,
	nr_protocolo_w,
	dt_inicio_protocolo_w,
	dt_fim_protocolo_w,
	cd_cgc_hospital_w,
	nm_hospital_w
from 	med_prot_convenio
where 	nr_sequencia	= nr_seq_protocolo_p;


/* Dados do convenio */

select		Elimina_Acentuacao(ds_convenio),
		cd_cgc,
		Obter_Valor_Conv_Estab(cd_convenio, cd_estabelecimento_p, 'CD_INTERNO'),
		Obter_Valor_Conv_Estab(cd_convenio, cd_estabelecimento_p, 'CD_REGIONAL'),
		ie_agrup_item_interf
into STRICT		ds_convenio_w,
		cd_cgc_convenio_w,
		cd_interno_w,
		cd_regional_w,
		ie_agrup_item_interf_w
from		convenio
where		cd_convenio				= cd_convenio_w;


/* Gravar conta_header */

insert into w_interf_conta_header(
	 nr_sequencia,
	 cd_tipo_registro,
	 nr_seq_registro,
	 nr_seq_interface,
	 cd_interno,
	 cd_regional,
	 nm_convenio,
	 cd_cgc_convenio,
	 nm_hospital,
	 cd_cgc_hospital,
	 nr_remessa,
	 dt_remessa,
	 dt_vencimento,
	 nr_seq_protocolo,
	 cd_convenio,
	 ie_tipo_protocolo,
	 nr_protocolo,
	 dt_inicio_protocolo,
	 dt_fim_protocolo,
	 nm_usuario)
values (nr_sequencia_w,
	0,
	1,
	1,
	cd_interno_w,
	cd_regional_w,
	ds_convenio_w,
	cd_cgc_convenio_w,
	nm_hospital_w,
	cd_cgc_hospital_w,
	nr_seq_envio_convenio_w,
	dt_mesano_referencia_w,
	dt_vencimento_w,
	nr_seq_protocolo_p,
	cd_convenio_w,
	ie_tipo_protocolo_w,
	 nr_protocolo_w,
	 dt_inicio_protocolo_w,
	 dt_fim_protocolo_w,
	 nm_usuario_p);
commit;

/* selecionar as contas do protocolo */

open c02;
loop
fetch c02 	into
		nr_interno_conta_w,
		nr_atendimento_w;
EXIT WHEN NOT FOUND; /* apply on c02 */
     		begin
		begin
		/* selecionar regra de exclusao de honorários */

		/* IE_EXCLUIR_HON_MED exclui regra honorário direto do médico 'M' */

		/* IE_EXCLUIR_HON_TERC exclui regra honorário terceiros 'COOP' */

		select coalesce(ie_excluir_hon_med,'N'),
			 coalesce(ie_excluir_hon_terc,'N')
		into STRICT 	 ie_excluir_hon_med_w,
			 ie_excluir_hon_terc_w
		from	 param_interface
		where	 cd_convenio	= cd_convenio_w
		and	 coalesce(ie_tipo_atendimento,ie_tipo_atendimento_w) = ie_tipo_atendimento_w
		and	 coalesce(cd_estabelecimento,cd_estabelecimento_p) = cd_estabelecimento_p;
		exception
			 when others then
			 begin
		 	 ie_excluir_hon_med_w	:= 'N';
			 ie_excluir_hon_terc_w	:= 'N';
			 end;
		end;

		nr_sequencia_w := Med_Gerar_Interf_Conta_Cab(	nr_seq_protocolo_p, nr_seq_envio_convenio_w, cd_convenio_w, nr_atendimento_w, nr_interno_conta_w, cd_cgc_hospital_w, cd_cgc_convenio_w, cd_interno_w, nm_usuario_p, nr_sequencia_w);
		nr_seq_registro_w		:= nr_seq_registro_w + 1;
		update w_interf_conta_cab
		set nr_seq_registro	= nr_seq_registro_w
		where nr_sequencia	= nr_sequencia_w;

		CALL Med_Gerar_Interf_Conta_Item(nr_seq_protocolo_p,
						nr_seq_envio_convenio_w,
						cd_convenio_w,
						nr_atendimento_w,
						nr_interno_conta_w,
						cd_cgc_hospital_w,
						cd_cgc_convenio_w,
						cd_interno_w,
						nm_usuario_p,
		 	 			ie_excluir_hon_med_w,
			 			ie_excluir_hon_terc_w);


		CALL med_Gerar_Interf_Conta_Total(nr_seq_protocolo_p,
						nr_seq_envio_convenio_w,
						cd_convenio_w,
						nr_atendimento_w,
						nr_interno_conta_w,
						cd_cgc_hospital_w,
						cd_cgc_convenio_w,
						cd_interno_w,
		 	 			ie_excluir_hon_med_w,
			 			ie_excluir_hon_terc_w,
						nm_usuario_p);


		begin
		qt_itens_conta_w	:= 0;
		Select	count(*)
		into STRICT		qt_itens_conta_w
		from		w_interf_conta_item
		where		nr_interno_conta	= nr_interno_conta_w;
		exception
				when others then
				qt_itens_conta_w := 0;
		end;
		if (qt_itens_conta_w = 0) then
			begin
			delete from w_interf_conta_cab
			where nr_interno_conta	= nr_interno_conta_w
			and   nm_usuario = nm_usuario_p;
			delete from w_interf_conta_item
			where nr_interno_conta	= nr_interno_conta_w
			and   nm_usuario = nm_usuario_p;
			delete from w_interf_conta_total
			where nr_interno_conta	= nr_interno_conta_w
			and   nm_usuario = nm_usuario_p;
			end;
		end if;


		commit;
		END;
END LOOP;
close C02;
commit;
/* Tratar registro tipo TRAILLER */

/* Buscar sequence */

select nextval('w_interf_conta_trailler_seq')
into STRICT	 nr_sequencia_w
;

vl_material_w		:= 0;
qt_guia_w		:= 0;
nr_primeira_guia_w	:= '0';
nr_ultima_guia_w	:= '0';


select	coalesce(sum(b.vl_item),0)
into STRICT	vl_procedimento_w
from	med_faturamento b
where	b.nr_seq_protocolo		= nr_seq_protocolo_p;

select 	count(*)
into STRICT	qt_documento_w
from	w_interf_conta_cab
where	nr_seq_protocolo	= nr_seq_protocolo_w;

insert into w_interf_conta_trailler(
 		nr_sequencia,
 		cd_tipo_registro,
 		nr_seq_registro,
 		nr_seq_interface,
 		nr_remessa,
 		qt_total_conta,
 		vl_total_conta,
 		nr_seq_protocolo,
 		cd_convenio,
 		cd_cgc_hospital,
 		cd_cgc_convenio,
 		cd_interno,
 		nr_primeira_guia,
 		nr_ultima_guia,
 		qt_guia,
		nm_usuario)
values (
		nr_sequencia_w,
		9,1,1,
		nr_seq_envio_convenio_w,
		qt_documento_w,
		vl_procedimento_w,
 		nr_seq_protocolo_w,
 		cd_convenio_w,
 		cd_cgc_hospital_w,
 		cd_cgc_convenio_w,
 		cd_interno_w,
 		nr_primeira_guia_w,
 		nr_ultima_guia_w,
 		qt_guia_w,
		nm_usuario_p);
commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE med_gerar_interf_conta (nr_seq_protocolo_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint) FROM PUBLIC;

