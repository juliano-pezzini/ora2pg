-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE generate_soap_patient_transfer (nr_seq_interno_p atend_paciente_unidade.nr_seq_interno%type, nr_atendimento_p atend_paciente_unidade.nr_atendimento%type, cd_pessoa_fisica_p atendimento_paciente.cd_pessoa_fisica%type) AS $body$
DECLARE


nr_seq_interno_old_w		atend_paciente_unidade.nr_seq_interno%type;
ie_gerar_clinical_notes_w       atend_paciente_unidade.ie_passagem_setor%type := 'N';
cd_unidade_basica_old_w		atend_paciente_unidade.cd_unidade_basica%type;
cd_unidade_compl_old_w		atend_paciente_unidade.cd_unidade_compl%type;
cd_unidade_basica_w		atend_paciente_unidade.cd_unidade_basica%type;
cd_unidade_compl_w		atend_paciente_unidade.cd_unidade_compl%type;
cd_departamento_old_w           atend_paciente_unidade.cd_departamento%type;
cd_departamento_w               atend_paciente_unidade.cd_setor_atendimento%type;
cd_setor_atendimento_old_w      atend_paciente_unidade.cd_setor_atendimento%type;
cd_evolucao_w                   evolucao_paciente.cd_evolucao%type;
cd_setor_atendimento_w          atend_paciente_unidade.cd_setor_atendimento%type;
ie_dept_transfer_w              clinical_note_settings.ie_med_rec_type%type := 'DEPT_TRANSFER';
ie_ward_transfer_w              clinical_note_settings.ie_med_rec_type%type := 'WARD_TRANSFER';
ie_bed_transfer_w               clinical_note_settings.ie_med_rec_type%type := 'BED_TRANSFER';
ie_soap_type_w                  clinical_note_settings.ie_soap_type%type := 'P';
ie_stage_w                      clinical_note_settings.ie_stage%type := 1;
ds_error_w			evolucao_paciente.ds_evolucao%type;

BEGIN
ie_gerar_clinical_notes_w := obter_param_usuario(281, 1596, Obter_perfil_ativo, wheb_usuario_pck.get_nm_usuario, wheb_usuario_pck.get_cd_estabelecimento, ie_gerar_clinical_notes_w);

if (ie_gerar_clinical_notes_w = 'S') then
        begin
		if (coalesce(pkg_i18n.get_user_locale, 'pt_BR')='ja_JP') then
			select	coalesce(max(nr_seq_interno),0)
			into STRICT	nr_seq_interno_old_w
			from	atend_paciente_unidade b
			where	b.nr_atendimento = nr_atendimento_p
			and	b.nr_seq_interno < nr_seq_interno_p;
		end if;

                if (coalesce(nr_seq_interno_old_w,0) > 0) then
		select COALESCE(cd_departamento,obter_departamento_setor(cd_setor_atendimento)),
                	cd_setor_atendimento,
                	cd_unidade_basica,
                	cd_unidade_compl
		into STRICT 	cd_departamento_w,
                	cd_setor_atendimento_w,
                	cd_unidade_basica_w,
                	cd_unidade_compl_w
		from atend_paciente_unidade where nr_seq_interno=nr_seq_interno_p;

                select cd_unidade_basica,
                       cd_unidade_compl,
                       COALESCE(cd_departamento,obter_departamento_setor(cd_setor_atendimento)),
                       cd_setor_atendimento
                into STRICT   cd_unidade_basica_old_w,
                       cd_unidade_compl_old_w,
                       cd_departamento_old_w,
                       cd_setor_atendimento_old_w
                from atend_paciente_unidade
                where nr_seq_interno = nr_seq_interno_old_w;
		if (coalesce(cd_departamento_w,0) > 0 and coalesce(cd_departamento_old_w,0) > 0 and ( coalesce(cd_departamento_w,0) <>  coalesce(cd_departamento_old_w,0))) then
                cd_evolucao_p =>     cd_evolucao_w := clinical_notes_pck.gerar_soap(nr_atendimento_p  => nr_atendimento_p, nr_sequencia_p => nr_seq_interno_p, ie_record_type_p => ie_dept_transfer_w, ie_record_sub_type_p => null, ie_soap_type_p => ie_soap_type_w, ie_stage_p => ie_stage_w, cd_evolucao_p =>     cd_evolucao_w, ie_option_p => null, cd_pessoa_fisica_p => cd_pessoa_fisica_p);
                elsif (coalesce(cd_setor_atendimento_w,0) > 0 and coalesce(cd_setor_atendimento_old_w,0) > 0  and (coalesce(cd_setor_atendimento_w,0) <> coalesce(cd_setor_atendimento_old_w,0))) then
                        cd_evolucao_p =>     cd_evolucao_w := clinical_notes_pck.gerar_soap(nr_atendimento_p  => nr_atendimento_p, nr_sequencia_p => nr_seq_interno_p, ie_record_type_p => ie_ward_transfer_w, ie_record_sub_type_p => null, ie_soap_type_p => ie_soap_type_w, ie_stage_p => ie_stage_w, cd_evolucao_p =>     cd_evolucao_w, ie_option_p => null, cd_pessoa_fisica_p => cd_pessoa_fisica_p);
                elsif (((cd_unidade_basica_w IS NOT NULL AND cd_unidade_basica_w::text <> '') and (cd_unidade_basica_old_w IS NOT NULL AND cd_unidade_basica_old_w::text <> '')  and cd_unidade_basica_w <> cd_unidade_basica_old_w) or ((cd_unidade_compl_w IS NOT NULL AND cd_unidade_compl_w::text <> '') and (cd_unidade_compl_old_w IS NOT NULL AND cd_unidade_compl_old_w::text <> '')  and cd_unidade_compl_w <> cd_unidade_compl_old_w) ) then
                        cd_evolucao_p =>     cd_evolucao_w := clinical_notes_pck.gerar_soap(nr_atendimento_p  => nr_atendimento_p, nr_sequencia_p => nr_seq_interno_p, ie_record_type_p => ie_bed_transfer_w, ie_record_sub_type_p => null, ie_soap_type_p => ie_soap_type_w, ie_stage_p => ie_stage_w, cd_evolucao_p =>     cd_evolucao_w, ie_option_p => null, cd_pessoa_fisica_p => cd_pessoa_fisica_p);
                end if;

                update atend_paciente_unidade
                set cd_evolucao = cd_evolucao_w
                where nr_seq_interno = nr_seq_interno_p;
        end if;

        exception
	when data_exception then
	ds_error_w := substr('NR_ATENDIMENTO='||nr_atendimento_p||';nr_seq_interno_p='|| nr_seq_interno_p || 'cd_pessoa_fisica_p =' || cd_pessoa_fisica_p ,1,2000);
        ds_error_w	:= substr(ds_error_w || ';DS_ERROR='||sqlerrm ,1,2000);
        CALL gravar_log_tasy(21058,ds_error_w,wheb_usuario_pck.get_nm_usuario);
        when others then
        ds_error_w := substr('NR_ATENDIMENTO='||nr_atendimento_p||';nr_seq_interno_p='|| nr_seq_interno_p || 'cd_pessoa_fisica_p =' || cd_pessoa_fisica_p ,1,2000);
        ds_error_w	:= substr(ds_error_w || ';DS_ERROR='||sqlerrm ,1,2000);
        CALL gravar_log_tasy(21058,ds_error_w,wheb_usuario_pck.get_nm_usuario);
        end;
    end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE generate_soap_patient_transfer (nr_seq_interno_p atend_paciente_unidade.nr_seq_interno%type, nr_atendimento_p atend_paciente_unidade.nr_atendimento%type, cd_pessoa_fisica_p atendimento_paciente.cd_pessoa_fisica%type) FROM PUBLIC;

