-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE man_integrar_pat_manutencao ( nr_sequencia_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text, nr_seq_local_p bigint, cd_centro_custo_p bigint, nr_seq_tipo_equip_p bigint, nr_seq_planej_p bigint, nr_seq_trab_p bigint, cd_impacto_p text, ie_prioridade_p text, nm_equip_format_p text) AS $body$
DECLARE


ds_bem_w			varchar(80);
ie_situacao_w			varchar(1);
cd_bem_w			varchar(20);
cd_cgc_w			varchar(14);
dt_aquisicao_w			timestamp;
cd_moeda_w			bigint;
ds_serie_w			varchar(30);
ds_marca_w			varchar(50);
nr_sequencia_w			bigint;
qt_existe_w			bigint;
nr_seq_local_manut_w		bigint;
nr_seq_local_w			bigint;
cd_centro_custo_w		integer;
cd_centro_bem_w			integer;
ie_propriedade_w		varchar(15);
ds_documento_w			varchar(255);
vl_original_w			double precision;
nr_nota_fiscal_w		varchar(255);
cd_bem_externo_w		varchar(20);
nr_seq_integr_nf_w		bigint;
nr_seq_nota_w			bigint;
nr_seq_item_w			bigint;
dt_inicio_garantia_w		timestamp;
dt_fim_garantia_w			timestamp;
ds_modelo_w			pat_bem.ds_modelo%type;

C01 CURSOR FOR
SELECT	ds_documento
from	pat_documento
where	nr_seq_bem =	nr_sequencia_p;


BEGIN
begin
select	cd_moeda_padrao
into STRICT	cd_moeda_w
from	parametro_compras
where	cd_estabelecimento = cd_estabelecimento_p;
exception when others then
	/*(-20011,'Falta a informação da moeda padrão para este estabelecimento.');*/

	CALL wheb_mensagem_pck.exibir_mensagem_abort(263140);
end;

select	coalesce(b.nr_seq_local_manutencao,0),
	substr(a.ds_bem,1,80),
	a.ie_situacao,
	a.cd_bem,
	a.cd_cgc,
	a.dt_aquisicao,
	substr(a.ds_serie,1,30),
	substr(pat_obter_marca(a.nr_seq_marca),1,50),
	a.cd_centro_custo,
	coalesce(a.ie_propriedade,'P'),
	a.vl_original,
	nr_nota_fiscal,
	a.cd_bem_externo,
	a.ds_modelo
into STRICT	nr_seq_local_manut_w,
	ds_bem_w,
	ie_situacao_w,
	cd_bem_w,
	cd_cgc_w,
	dt_aquisicao_w,
	ds_serie_w,
	ds_marca_w,
	cd_centro_bem_w,
	ie_propriedade_w,
	vl_original_w,
	nr_nota_fiscal_w,
	cd_bem_externo_w,
	ds_modelo_w
from	pat_local b,
	pat_bem a
where	a.nr_sequencia = nr_sequencia_p
and	a.nr_seq_local = b.nr_sequencia;

nr_seq_local_w		:= nr_seq_local_p;
if (coalesce(nr_seq_local_w, 0) = 0) then
	nr_seq_local_w	:= nr_seq_local_manut_w;
end if;

if (nr_seq_local_w = 0) then
	/*(-20011, 'Falta informar a localização, ou informar a localização do bem no Patrimônio.');*/

	CALL wheb_mensagem_pck.exibir_mensagem_abort(263148);
end if;

cd_centro_custo_w	:= cd_centro_custo_p;
if (coalesce(cd_centro_custo_w, 0) = 0) then
	cd_centro_custo_w	:= cd_centro_bem_w;
end if;

select	coalesce(max(nr_sequencia),0)
into STRICT	nr_seq_integr_nf_w
from	nf_integracao_pat_equip
where	nr_seq_bem	= nr_sequencia_p;

if (nr_seq_integr_nf_w <> 0) then

	select	max(nr_seq_nota),
		max(nr_seq_item)
	into STRICT	nr_seq_nota_w,
		nr_seq_item_w
	from	nf_integracao_pat_equip
	where	nr_sequencia	= nr_seq_integr_nf_w;
	
	select	max(dt_inicio_garantia),
		max(dt_fim_garantia)
	into STRICT	dt_inicio_garantia_w,
		dt_fim_garantia_w
	from	nota_fiscal_item
	where	nr_sequencia	= nr_seq_nota_w
	and	nr_item_nf	= nr_seq_item_w;

end if;

select	nextval('man_equipamento_seq')
into STRICT	nr_sequencia_w
;

if (nm_equip_format_p = 'NPDTP') then
	begin
	
	SELECT 	substr(concat(concat(DS_BEM, ' - '), substr(obter_descricao_padrao('PAT_TIPO_BEM','DS_TIPO',nr_seq_tipo),1,80)), 1,80)
	INTO STRICT	ds_bem_w
	FROM	pat_bem a
	WHERE 	a.nr_sequencia = nr_sequencia_p;
	
	end;
end if;

insert into man_equipamento(
	nr_sequencia,
	ds_equipamento,
	nr_seq_local,
	nr_seq_tipo_equip,
	dt_atualizacao,
	nm_usuario,
	nr_seq_planej,
	nr_seq_trab,
	ie_situacao,
	cd_imobilizado,
	cd_fornecedor,
	dt_aquisicao,
	cd_moeda,
	ie_disponibilidade,
	ie_rotina_seguranca,
	cd_estab_contabil,
	cd_centro_custo,
	ie_propriedade,
	ds_marca,
	nr_serie,
	ie_parado,
	ie_controle_setor,
	vl_aquisicao,
	nr_doc_garantia,
	cd_imobilizado_ext,
	cd_impacto,
	dt_inicio_garantia,
	dt_fim_garantia,
	nr_seq_bem,
	ie_consiste_os_duplic,
	ie_prioridade,
	ds_modelo)
values (	nr_sequencia_w,
	ds_bem_w,
	nr_seq_local_w,
	nr_seq_tipo_equip_p,
	clock_timestamp(),
	nm_usuario_p,
	nr_seq_planej_p,
	nr_seq_trab_p,
	ie_situacao_w,
	cd_bem_w,
	cd_cgc_w,
	dt_aquisicao_w,
	cd_moeda_w,
	'N',
	'N',
	cd_estabelecimento_p,
	cd_centro_custo_w,
	ie_propriedade_w,
	ds_marca_w,
	ds_serie_w,
	'N',
	'S',
	vl_original_w,
	substr(nr_nota_fiscal_w,1,20),
	cd_bem_externo_w,
	coalesce(cd_impacto_p,''),
	dt_inicio_garantia_w,
	dt_fim_garantia_w,
	nr_sequencia_p,
	'N',
	ie_prioridade_p,
	ds_modelo_w);

open C01;
loop
fetch C01 into	
	ds_documento_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	insert into man_equip_arq(
			nr_sequencia,
			dt_atualizacao,
			nm_usuario,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			ds_arquivo,
			nr_seq_equipamento,
			dt_arquivo)
		values (	nextval('man_equip_arq_seq'),
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			ds_documento_w,
			nr_sequencia_w,
			clock_timestamp());
	end;
end loop;
close C01;
	
select	count(*)
into STRICT	qt_existe_w
from	nf_integracao_pat_equip
where	nr_seq_bem = nr_sequencia_p;

if (qt_existe_w > 0) then
	select	cd_bem
	into STRICT	cd_bem_w
	from	pat_bem
	where	nr_sequencia = nr_sequencia_p;
	
	update	man_equipamento
	set	cd_imobilizado	= cd_bem_w,
		nr_seq_bem	= nr_sequencia_p
	where	nr_sequencia	= nr_sequencia_w;
	
	update	nf_integracao_pat_equip
	set	nr_seq_equipamento	= nr_sequencia_w
	where	nr_seq_bem		= nr_sequencia_p;
	
	if (coalesce(dt_inicio_garantia_w::text, '') = '' and  coalesce(dt_fim_garantia_w::text, '') = '') then

		select	max(dt_aquisicao),
			max(dt_garantia)
		into STRICT	dt_inicio_garantia_w,
			dt_fim_garantia_w
		from	pat_bem 	
		where	nr_sequencia = nr_sequencia_p;

		update	man_equipamento
		set	dt_inicio_garantia = dt_inicio_garantia_w,
			dt_fim_garantia	= dt_fim_garantia_w
		where	nr_sequencia	= nr_sequencia_w;
		
	end if;
end if;
	
commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE man_integrar_pat_manutencao ( nr_sequencia_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text, nr_seq_local_p bigint, cd_centro_custo_p bigint, nr_seq_tipo_equip_p bigint, nr_seq_planej_p bigint, nr_seq_trab_p bigint, cd_impacto_p text, ie_prioridade_p text, nm_equip_format_p text) FROM PUBLIC;

