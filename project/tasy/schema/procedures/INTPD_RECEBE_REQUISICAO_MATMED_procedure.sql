-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE intpd_recebe_requisicao_matmed ( nr_sequencia_p bigint, xml_p xml) AS $body$
DECLARE




_ora2pg_r RECORD;
ie_conversao_w			intpd_eventos_sistema.ie_conversao%type;
nr_seq_projeto_xml_w		intpd_eventos_sistema.nr_seq_projeto_xml%type;
nr_seq_sistema_w			intpd_eventos_sistema.nr_seq_sistema%type;
ie_sistema_externo_w		varchar(15);
qt_registros_w			bigint;
nr_requisicao_delete_w		requisicao_material.nr_requisicao%type;
requisicao_material_w		requisicao_material%rowtype;
item_requisicao_material_w		item_requisicao_material%rowtype;
reg_integracao_w			gerar_int_padrao.reg_integracao_conv;
nr_seq_regra_conv_w		conversao_meio_externo.nr_seq_regra%type;
nr_documento_externo_w		ordem_compra.nr_documento_externo%type;
i				integer;
cd_estabelecimento_w		estabelecimento.cd_estabelecimento%type;
nr_sequencia_w			ordem_compra_item.nr_item_oci%type;
id_origin_w			intpd_eventos_sistema.ds_id_origin%type;

c01 CURSOR FOR
SELECT	*
from	xmltable('/STRUCTURE/MATERIAL_REQUISITION' passing xml_p columns
	ie_action				varchar(15)	path	'IE_ACTION',
	nr_documento_externo		bigint	path	'NR_EXTERNAL_DOCUMENT',
	cd_centro_custo			varchar(40)	path	'CD_COST_CENTER',
	cd_estabelecimento			varchar(40)	path	'CD_ESTABLISHMENT',
	cd_estabelecimento_destino		varchar(40)	path	'CD_DESTINATION_ESTABLISHMENT',
	cd_local_estoque			varchar(40)	path	'CD_STOCK_LOCATION',
	cd_local_estoque_destino		varchar(40)	path	'CD_DESTINATION_STOCK_LOCATION',
	cd_operacao_estoque		varchar(40)	path	'CD_STOCK_OPERATION',
	cd_pessoa_atendente		varchar(40)	path	'CD_ATTENDANT_PERSON',
	cd_pessoa_requisitante		varchar(40)	path	'CD_REQUESTER_PERSON',
	cd_pessoa_solicitante		varchar(40)	path	'CD_REQUESTING_PERSON',
	cd_setor_atendimento		varchar(40)	path	'CD_ATTENDANCE_DEPARTMENT',
	cd_setor_entrega			varchar(40)	path	'CD_DELIVERY_DEPARTMENT',
	ds_observacao			varchar(255)	path	'DS_NOTE',
	dt_aprovacao			varchar(40)	path	'DT_APPROVAL',
	dt_atualizacao			varchar(40)	path	'DT_UPDATE',
	dt_baixa				varchar(40)	path	'DT_SETTLEMENT',
	dt_emissao_loc_estoque		varchar(40)	path	'DT_LOCAL_STOCK_ISSUEANCE',
	dt_emissao_setor			varchar(40)	path	'DT_DEPARTMENT_ISSUEANCE',
	dt_liberacao			varchar(40)	path	'DT_SUBMISSION',
	dt_recebimento			varchar(40)	path	'DT_RECEIPT',
	dt_solicitacao_requisicao		varchar(40)	path	'DT_REQUISITION_REQUEST',
	ie_urgente			varchar(40)	path	'IE_URGENT',
	nm_usuario			varchar(40)	path	'NM_USER',
	nm_usuario_aprov			varchar(40)	path	'NM_APPROVAL_USER',
	nm_usuario_lib			varchar(40)	path	'NM_SUBMISSION_USER',
	nm_usuario_recebedor		varchar(40)	path	'NM_RECIPIENT_USER',
	nr_seq_justificativa			varchar(40)	path	'NR_JUSTIFICATION_SEQUENCE',
	xml_itens_requisicao		xml 		path	'MATERIAL_REQUISITION_ITEMS');
c01_w	c01%rowtype;


c02 CURSOR FOR
SELECT	*
from	xmltable('/MATERIAL_REQUISITION_ITEMS/MATERIAL_REQUISITION_ITEM' passing c01_w.xml_itens_requisicao columns
	cd_cgc_fornecedor			varchar(40)	path	'CD_SUPPLIER_IDENTIFICATION',
	cd_conta_contabil			varchar(40)	path	'CD_BOOKKEEPING_ACCOUNT',
	cd_material			varchar(40)	path	'CD_MATERIAL',
	cd_motivo_baixa			varchar(40)	path	'CD_SETTLEMENT_REASON',
	cd_pessoa_atende			varchar(40)	path	'CD_ATTEND_PERSON',
	cd_pessoa_recebe			varchar(40)	path	'CD_RECEIVE_PERSON',
	cd_unidade_medida		varchar(40)	path	'CD_UNIT_MEASUREMENT',
	cd_unidade_medida_estoque		varchar(40)	path	'CD_STOCK_UNIT_MEASUREMENT',
	ds_justificativa			varchar(255)	path	'DS_JUSTIFICATION',
	ds_justificativa_atend		varchar(255)	path	'DS_ATTENDANCE_JUSTIFICATION',
	ds_justificativa_reprov		varchar(255)	path	'DS_DISAPPROVAL_JUSTIFICATION',
	ds_observacao			varchar(255)	path	'DS_NOTE',
	dt_aprovacao			varchar(40)	path	'DT_APPROVAL',
	dt_atendimento			varchar(40)	path	'DT_ATTENDANCE',
	dt_atualizacao			varchar(40)	path	'DT_UPDATE',
	dt_recebimento			varchar(40)	path	'DT_RECEIPT',
	dt_reprovacao			varchar(40)	path	'DT_DISAPPROVAL',
	ie_acao				varchar(40)	path	'IE_ACTION',
	ie_motivo_reprovacao		varchar(40)	path	'IE_DISAPPROVAL_REASON',
	nm_usuario			varchar(40)	path	'NM_USER',
	nm_usuario_aprov			varchar(40)	path	'NM_APPROVAL_USER',
	nm_usuario_receb			varchar(40)	path	'NM_RECIPIENT_USER',
	nr_seq_justificativa			varchar(40)	path	'NR_JUSTIFICATION_SEQUENCE',
	nr_seq_lote_fornec			varchar(40)	path	'NR_SUPPLIER_BATCH_SEQUENCE',
	nr_sequencia			bigint	path	'NR_SEQUENCE',
	qt_estoque			varchar(40)	path	'QT_STOCK',
	qt_material_atendida		varchar(40)	path	'QT_ATTEND_MATERIAL',
	qt_material_requisitada		varchar(40)	path	'QT_REQUESTED_MATERIAL',
	vl_material			varchar(40)	path	'VL_MATERIAL',
	vl_unit_previsto			varchar(40)	path	'VL_ESTIMATED_UNIT',
	cd_barras				varchar(4000)	path	'CD_BARCODE',
	cd_kit_material			varchar(40)	path	'CD_KIT_MATERIAL');
c02_w	c02%rowtype;


BEGIN

select	id_origin
into STRICT	id_origin_w
from	xmltable('/STRUCTURE' passing xml_p
	columns id_origin	varchar2(10) path 'ID_ORIGIN');


select	coalesce(b.ie_conversao,'I'),
	nr_seq_sistema,
	nr_seq_projeto_xml,
	nr_seq_regra_conv,
	coalesce(ds_id_origin,id_origin_w)
into STRICT	ie_conversao_w,
	nr_seq_sistema_w,
	nr_seq_projeto_xml_w,
	nr_seq_regra_conv_w,
	id_origin_w
from	intpd_fila_transmissao a,
	intpd_eventos_sistema b
where	a.nr_seq_evento_sistema = b.nr_sequencia
and	a.nr_sequencia = nr_sequencia_p;

ie_sistema_externo_w	:=	nr_seq_sistema_w;

reg_integracao_w.nr_seq_fila_transmissao	:=	nr_sequencia_p;
reg_integracao_w.ie_envio_recebe		:=	'R';
reg_integracao_w.ie_sistema_externo		:=	ie_sistema_externo_w;
reg_integracao_w.ie_conversao		:=	ie_conversao_w;
reg_integracao_w.nr_seq_projeto_xml		:=	nr_seq_projeto_xml_w;
reg_integracao_w.nr_seq_regra_conversao	:=	nr_seq_regra_conv_w;

open C01;
loop
fetch C01 into
	c01_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin

	if (c01_w.ie_action = 'DELETE') then

		nr_documento_externo_w := c01_w.nr_documento_externo;

		select	coalesce(max(nr_requisicao),0)
		into STRICT	nr_requisicao_delete_w
		from	requisicao_material
		where	nr_documento_externo = nr_documento_externo_w;

		if (nr_requisicao_delete_w > 0) then

			select	count(*)
			into STRICT	qt_registros_w
			from	item_requisicao_material
			where	nr_requisicao = nr_requisicao_delete_w
			and	(dt_atendimento IS NOT NULL AND dt_atendimento::text <> '');

			if (qt_registros_w = 0) then

				delete from requisicao_material where nr_requisicao = nr_requisicao_delete_w;
			else
				intpd_gravar_log_recebimento(nr_sequencia_p,883315,c01_w.nm_usuario);
				/*A requisição não pode ser excluída porque já possui um item atendido.*/

			end if;
		end if;
	else

		reg_integracao_w.nm_tabela		:=	'REQUISICAO_MATERIAL';
		reg_integracao_w.nm_elemento		:=	'MATERIAL_REQUISITION';
		reg_integracao_w.nr_seq_visao		:=	16487;

		SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'CD_ESTABELECIMENTO', c01_w.cd_estabelecimento, 'S', requisicao_material_w.cd_estabelecimento) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; requisicao_material_w.cd_estabelecimento := _ora2pg_r.ds_valor_retorno_p;
		SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'CD_LOCAL_ESTOQUE', c01_w.cd_local_estoque, 'S', requisicao_material_w.cd_local_estoque) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; requisicao_material_w.cd_local_estoque := _ora2pg_r.ds_valor_retorno_p;
		SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'DT_SOLICITACAO_REQUISICAO', c01_w.dt_solicitacao_requisicao, 'N', requisicao_material_w.dt_solicitacao_requisicao) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; requisicao_material_w.dt_solicitacao_requisicao := _ora2pg_r.ds_valor_retorno_p;
		SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'DT_ATUALIZACAO', c01_w.dt_atualizacao, 'N', requisicao_material_w.dt_atualizacao) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; requisicao_material_w.dt_atualizacao := _ora2pg_r.ds_valor_retorno_p;
		SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'NM_USUARIO', c01_w.nm_usuario, 'N', requisicao_material_w.nm_usuario) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; requisicao_material_w.nm_usuario := _ora2pg_r.ds_valor_retorno_p;
		SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'CD_OPERACAO_ESTOQUE', c01_w.cd_operacao_estoque, 'S', requisicao_material_w.cd_operacao_estoque) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; requisicao_material_w.cd_operacao_estoque := _ora2pg_r.ds_valor_retorno_p;
		SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'CD_PESSOA_REQUISITANTE', c01_w.cd_pessoa_requisitante, 'S', requisicao_material_w.cd_pessoa_requisitante) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; requisicao_material_w.cd_pessoa_requisitante := _ora2pg_r.ds_valor_retorno_p;
		SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'CD_PESSOA_ATENDENTE', c01_w.cd_pessoa_atendente, 'S', requisicao_material_w.cd_pessoa_atendente) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; requisicao_material_w.cd_pessoa_atendente := _ora2pg_r.ds_valor_retorno_p;
		SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'CD_SETOR_ATENDIMENTO', c01_w.cd_setor_atendimento, 'S', requisicao_material_w.cd_setor_atendimento) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; requisicao_material_w.cd_setor_atendimento := _ora2pg_r.ds_valor_retorno_p;
		SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'CD_ESTABELECIMENTO_DESTINO', c01_w.cd_estabelecimento_destino, 'S', requisicao_material_w.cd_estabelecimento_destino) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; requisicao_material_w.cd_estabelecimento_destino := _ora2pg_r.ds_valor_retorno_p;
		SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'CD_LOCAL_ESTOQUE_DESTINO', c01_w.cd_local_estoque_destino, 'S', requisicao_material_w.cd_local_estoque_destino) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; requisicao_material_w.cd_local_estoque_destino := _ora2pg_r.ds_valor_retorno_p;
		SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'CD_CENTRO_CUSTO', c01_w.cd_centro_custo, 'S', requisicao_material_w.cd_centro_custo) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; requisicao_material_w.cd_centro_custo := _ora2pg_r.ds_valor_retorno_p;
		SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'DT_BAIXA', c01_w.dt_baixa, 'N', requisicao_material_w.dt_baixa) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; requisicao_material_w.dt_baixa := _ora2pg_r.ds_valor_retorno_p;
		SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'DT_LIBERACAO', c01_w.dt_liberacao, 'N', requisicao_material_w.dt_liberacao) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; requisicao_material_w.dt_liberacao := _ora2pg_r.ds_valor_retorno_p;
		SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'DT_EMISSAO_SETOR', c01_w.dt_emissao_setor, 'N', requisicao_material_w.dt_emissao_setor) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; requisicao_material_w.dt_emissao_setor := _ora2pg_r.ds_valor_retorno_p;
		SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'DT_EMISSAO_LOC_ESTOQUE', c01_w.dt_emissao_loc_estoque, 'N', requisicao_material_w.dt_emissao_loc_estoque) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; requisicao_material_w.dt_emissao_loc_estoque := _ora2pg_r.ds_valor_retorno_p;
		SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'DS_OBSERVACAO', c01_w.ds_observacao, 'N', requisicao_material_w.ds_observacao) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; requisicao_material_w.ds_observacao := _ora2pg_r.ds_valor_retorno_p;
		SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'IE_URGENTE', c01_w.ie_urgente, 'N', requisicao_material_w.ie_urgente) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; requisicao_material_w.ie_urgente := _ora2pg_r.ds_valor_retorno_p;
		SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'CD_SETOR_ENTREGA', c01_w.cd_setor_entrega, 'S', requisicao_material_w.cd_setor_entrega) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; requisicao_material_w.cd_setor_entrega := _ora2pg_r.ds_valor_retorno_p;
		SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'NM_USUARIO_LIB', c01_w.nm_usuario_lib, 'N', requisicao_material_w.nm_usuario_lib) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; requisicao_material_w.nm_usuario_lib := _ora2pg_r.ds_valor_retorno_p;
		SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'NR_DOCUMENTO_EXTERNO', c01_w.nr_documento_externo, 'N', requisicao_material_w.nr_documento_externo) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; requisicao_material_w.nr_documento_externo := _ora2pg_r.ds_valor_retorno_p;
		SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'NM_USUARIO_RECEBEDOR', c01_w.nm_usuario_recebedor, 'N', requisicao_material_w.nm_usuario_recebedor) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; requisicao_material_w.nm_usuario_recebedor := _ora2pg_r.ds_valor_retorno_p;
		SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'DT_RECEBIMENTO', c01_w.dt_recebimento, 'N', requisicao_material_w.dt_recebimento) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; requisicao_material_w.dt_recebimento := _ora2pg_r.ds_valor_retorno_p;
		SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'CD_PESSOA_SOLICITANTE', c01_w.cd_pessoa_solicitante, 'S', requisicao_material_w.cd_pessoa_solicitante) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; requisicao_material_w.cd_pessoa_solicitante := _ora2pg_r.ds_valor_retorno_p;
		SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'DT_APROVACAO', c01_w.dt_aprovacao, 'N', requisicao_material_w.dt_aprovacao) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; requisicao_material_w.dt_aprovacao := _ora2pg_r.ds_valor_retorno_p;
		SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'NM_USUARIO_APROV', c01_w.nm_usuario_aprov, 'N', requisicao_material_w.nm_usuario_aprov) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; requisicao_material_w.nm_usuario_aprov := _ora2pg_r.ds_valor_retorno_p;
		SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'NR_SEQ_JUSTIFICATIVA', c01_w.nr_seq_justificativa, 'S', requisicao_material_w.nr_seq_justificativa) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; requisicao_material_w.nr_seq_justificativa := _ora2pg_r.ds_valor_retorno_p;
		requisicao_material_w.ie_origem_requisicao 	:= id_origin_w;
		requisicao_material_w.ie_geracao 		:= 'I';
		requisicao_material_w.dt_atualizacao_nrec	:= clock_timestamp();
		requisicao_material_w.nm_usuario_nrec		:= requisicao_material_w.nm_usuario;


		if (reg_integracao_w.qt_reg_log = 0) then

			select	coalesce(max(nr_requisicao),0)
			into STRICT	requisicao_material_w.nr_requisicao
			from	requisicao_material
			where	nr_documento_externo = requisicao_material_w.nr_documento_externo;

			if (requisicao_material_w.nr_requisicao > 0) then

				update	requisicao_material
				set	row = requisicao_material_w
				where	nr_requisicao = requisicao_material_w.nr_requisicao;

			else
				select	nextval('requisicao_seq')
				into STRICT	requisicao_material_w.nr_requisicao
				;

				requisicao_material_w.dt_aprovacao := null;

				insert into requisicao_material values (requisicao_material_w.*);

				SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'DT_APROVACAO', c01_w.dt_aprovacao, 'N', requisicao_material_w.dt_aprovacao) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; requisicao_material_w.dt_aprovacao := _ora2pg_r.ds_valor_retorno_p;

				update	requisicao_material
				set	dt_aprovacao = requisicao_material_w.dt_aprovacao
				where	nr_requisicao = requisicao_material_w.nr_requisicao;
			end if;
		end if;

		open C02;
		loop
		fetch C02 into
			c02_w;
		EXIT WHEN NOT FOUND; /* apply on C02 */
			begin

			if (c02_w.nr_seq_lote_fornec IS NOT NULL AND c02_w.nr_seq_lote_fornec::text <> '') then
				select	max(nr_sequencia)
				into STRICT	item_requisicao_material_w.nr_seq_lote_fornec
				from	material_lote_fornec
				where	nr_sequencia = c02_w.nr_seq_lote_fornec;
			end if;


			reg_integracao_w.nm_tabela	:=	'ITEM_REQUISICAO_MATERIAL';
			reg_integracao_w.nm_elemento	:=	'MATERIAL_REQUISITION_ITEM';
			reg_integracao_w.nr_seq_visao	:=	16490;


			SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'NR_SEQUENCIA', c02_w.nr_sequencia, 'N', item_requisicao_material_w.nr_sequencia) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; item_requisicao_material_w.nr_sequencia := _ora2pg_r.ds_valor_retorno_p;
			SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'CD_MATERIAL', c02_w.cd_material, 'S', item_requisicao_material_w.cd_material) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; item_requisicao_material_w.cd_material := _ora2pg_r.ds_valor_retorno_p;
			SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'QT_MATERIAL_REQUISITADA', c02_w.qt_material_requisitada, 'N', item_requisicao_material_w.qt_material_requisitada) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; item_requisicao_material_w.qt_material_requisitada := _ora2pg_r.ds_valor_retorno_p;
			SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'QT_ESTOQUE', c02_w.qt_estoque, 'N', item_requisicao_material_w.qt_estoque) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; item_requisicao_material_w.qt_estoque := _ora2pg_r.ds_valor_retorno_p;
			SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'QT_MATERIAL_ATENDIDA', c02_w.qt_material_atendida, 'N', item_requisicao_material_w.qt_material_atendida) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; item_requisicao_material_w.qt_material_atendida := _ora2pg_r.ds_valor_retorno_p;
			SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'VL_UNIT_PREVISTO', c02_w.vl_unit_previsto, 'N', item_requisicao_material_w.vl_unit_previsto) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; item_requisicao_material_w.vl_unit_previsto := _ora2pg_r.ds_valor_retorno_p;
			SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'DT_ATENDIMENTO', c02_w.dt_atendimento, 'N', item_requisicao_material_w.dt_atendimento) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; item_requisicao_material_w.dt_atendimento := _ora2pg_r.ds_valor_retorno_p;
			SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'CD_PESSOA_RECEBE', c02_w.cd_pessoa_recebe, 'S', item_requisicao_material_w.cd_pessoa_recebe) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; item_requisicao_material_w.cd_pessoa_recebe := _ora2pg_r.ds_valor_retorno_p;
			SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'CD_PESSOA_ATENDE', c02_w.cd_pessoa_atende, 'S', item_requisicao_material_w.cd_pessoa_atende) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; item_requisicao_material_w.cd_pessoa_atende := _ora2pg_r.ds_valor_retorno_p;
			SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'IE_ACAO', c02_w.ie_acao, 'N', item_requisicao_material_w.ie_acao) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; item_requisicao_material_w.ie_acao := _ora2pg_r.ds_valor_retorno_p;
			SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'CD_MOTIVO_BAIXA', c02_w.cd_motivo_baixa, 'S', item_requisicao_material_w.cd_motivo_baixa) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; item_requisicao_material_w.cd_motivo_baixa := _ora2pg_r.ds_valor_retorno_p;
			SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'CD_CONTA_CONTABIL', c02_w.cd_conta_contabil, 'S', item_requisicao_material_w.cd_conta_contabil) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; item_requisicao_material_w.cd_conta_contabil := _ora2pg_r.ds_valor_retorno_p;
			SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'CD_CGC_FORNECEDOR', c02_w.cd_cgc_fornecedor, 'S', item_requisicao_material_w.cd_cgc_fornecedor) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; item_requisicao_material_w.cd_cgc_fornecedor := _ora2pg_r.ds_valor_retorno_p;
			SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'DS_OBSERVACAO', c02_w.ds_observacao, 'N', item_requisicao_material_w.ds_observacao) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; item_requisicao_material_w.ds_observacao := _ora2pg_r.ds_valor_retorno_p;
			SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'DS_JUSTIFICATIVA', c02_w.ds_justificativa, 'N', item_requisicao_material_w.ds_justificativa) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; item_requisicao_material_w.ds_justificativa := _ora2pg_r.ds_valor_retorno_p;
			SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'DS_JUSTIFICATIVA_ATEND', c02_w.ds_justificativa_atend, 'N', item_requisicao_material_w.ds_justificativa_atend) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; item_requisicao_material_w.ds_justificativa_atend := _ora2pg_r.ds_valor_retorno_p;
			SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'DS_JUSTIFICATIVA_REPROV', c02_w.ds_justificativa_reprov, 'N', item_requisicao_material_w.ds_justificativa_reprov) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; item_requisicao_material_w.ds_justificativa_reprov := _ora2pg_r.ds_valor_retorno_p;
			SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'DT_APROVACAO', c02_w.dt_aprovacao, 'N', item_requisicao_material_w.dt_aprovacao) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; item_requisicao_material_w.dt_aprovacao := _ora2pg_r.ds_valor_retorno_p;
			SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'DT_RECEBIMENTO', c02_w.dt_recebimento, 'N', item_requisicao_material_w.dt_recebimento) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; item_requisicao_material_w.dt_recebimento := _ora2pg_r.ds_valor_retorno_p;
			SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'NM_USUARIO_APROV', c02_w.nm_usuario_aprov, 'N', item_requisicao_material_w.nm_usuario_aprov) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; item_requisicao_material_w.nm_usuario_aprov := _ora2pg_r.ds_valor_retorno_p;
			SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'NM_USUARIO_RECEB', c02_w.nm_usuario_receb, 'N', item_requisicao_material_w.nm_usuario_receb) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; item_requisicao_material_w.nm_usuario_receb := _ora2pg_r.ds_valor_retorno_p;
			SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'DT_REPROVACAO', c02_w.dt_reprovacao, 'N', item_requisicao_material_w.dt_reprovacao) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; item_requisicao_material_w.dt_reprovacao := _ora2pg_r.ds_valor_retorno_p;
			SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'CD_KIT_MATERIAL', c02_w.cd_kit_material, 'S', item_requisicao_material_w.cd_kit_material) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; item_requisicao_material_w.cd_kit_material := _ora2pg_r.ds_valor_retorno_p;
			SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'IE_MOTIVO_REPROVACAO', c02_w.ie_motivo_reprovacao, 'S', item_requisicao_material_w.ie_motivo_reprovacao) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; item_requisicao_material_w.ie_motivo_reprovacao := _ora2pg_r.ds_valor_retorno_p;
			SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'NR_SEQ_JUSTIFICATIVA', c02_w.nr_seq_justificativa, 'S', item_requisicao_material_w.nr_seq_justificativa) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; item_requisicao_material_w.nr_seq_justificativa := _ora2pg_r.ds_valor_retorno_p;
			SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'CD_BARRAS', c02_w.cd_barras, 'N', item_requisicao_material_w.cd_barras) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; item_requisicao_material_w.cd_barras := _ora2pg_r.ds_valor_retorno_p;
			item_requisicao_material_w.nr_requisicao	:= requisicao_material_w.nr_requisicao;
			item_requisicao_material_w.cd_estabelecimento	:= requisicao_material_w.cd_estabelecimento;
			item_requisicao_material_w.dt_atualizacao	:= clock_timestamp();
			item_requisicao_material_w.nm_usuario		:= requisicao_material_w.nm_usuario;
			item_requisicao_material_w.nr_documento_externo	:= requisicao_material_w.nr_documento_externo;
			item_requisicao_material_w.dt_atualizacao_nrec	:= clock_timestamp();
			item_requisicao_material_w.nm_usuario_nrec	:= requisicao_material_w.nm_usuario;
			item_requisicao_material_w.cd_material_req	:= item_requisicao_material_w.cd_material;
			item_requisicao_material_w.ie_geracao		:= 'S';


			if (c02_w.cd_unidade_medida IS NOT NULL AND c02_w.cd_unidade_medida::text <> '') then
				SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'CD_UNIDADE_MEDIDA', c02_w.cd_unidade_medida, 'S', item_requisicao_material_w.cd_unidade_medida) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; item_requisicao_material_w.cd_unidade_medida := _ora2pg_r.ds_valor_retorno_p;
			else
				select	cd_unidade_medida_consumo
				into STRICT	item_requisicao_material_w.cd_unidade_medida
				from	material
				where	cd_material = item_requisicao_material_w.cd_material;
			end if;

			if (c02_w.cd_unidade_medida_estoque IS NOT NULL AND c02_w.cd_unidade_medida_estoque::text <> '') then
				SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'CD_UNIDADE_MEDIDA_ESTOQUE', c02_w.cd_unidade_medida_estoque, 'S', item_requisicao_material_w.cd_unidade_medida_estoque) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; item_requisicao_material_w.cd_unidade_medida_estoque := _ora2pg_r.ds_valor_retorno_p;
			else
				select	cd_unidade_medida_estoque
				into STRICT	item_requisicao_material_w.cd_unidade_medida_estoque
				from	material
				where	cd_material = item_requisicao_material_w.cd_material;
			end if;


			if (coalesce(c02_w.vl_material,'0') <> '0') then
				SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'VL_MATERIAL', c02_w.vl_material, 'N', item_requisicao_material_w.vl_material) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; item_requisicao_material_w.vl_material := _ora2pg_r.ds_valor_retorno_p;
			else
				select	coalesce(obter_custo_medio_material(requisicao_material_w.cd_estabelecimento, requisicao_material_w.dt_solicitacao_requisicao, item_requisicao_material_w.cd_material),0)
				into STRICT	item_requisicao_material_w.vl_material
				;
			end if;


			if (requisicao_material_w.cd_local_estoque_destino > 0) then

				select	cd_estabelecimento
				into STRICT	cd_estabelecimento_w
				from	local_estoque
				where	cd_local_estoque = requisicao_material_w.cd_local_estoque_destino;

				if (cd_estabelecimento_w > 0) then
					item_requisicao_material_w.qt_saldo_estoque_dest := obter_saldo_disp_estoque(cd_estabelecimento_w,item_requisicao_material_w.cd_material,requisicao_material_w.cd_local_estoque_destino,pkg_date_utils.start_of(clock_timestamp(), 'MM', null));
				end if;
			end if;

			if (requisicao_material_w.cd_local_estoque > 0) then

				select	cd_estabelecimento
				into STRICT	cd_estabelecimento_w
				from	local_estoque
				where	cd_local_estoque = requisicao_material_w.cd_local_estoque;

				if (cd_estabelecimento_w > 0) then
					item_requisicao_material_w.qt_saldo_estoque := obter_saldo_disp_estoque(cd_estabelecimento_w,item_requisicao_material_w.cd_material,requisicao_material_w.cd_local_estoque,pkg_date_utils.start_of(clock_timestamp(), 'MM', null));
				end if;
			end if;


			if (reg_integracao_w.qt_reg_log = 0) then

				select	coalesce(max(nr_sequencia),0)
				into STRICT	nr_sequencia_w
				from	item_requisicao_material
				where	nr_requisicao = requisicao_material_w.nr_requisicao
				and	nr_sequencia = item_requisicao_material_w.nr_sequencia;




				if (nr_sequencia_w > 0) then



					update	item_requisicao_material
					set	row = item_requisicao_material_w
					where	nr_requisicao = requisicao_material_w.nr_requisicao
					and	nr_sequencia = item_requisicao_material_w.nr_sequencia;

				else
					insert into item_requisicao_material values (item_requisicao_material_w.*);

				end if;
			end if;
			end;
		end loop;
		close C02;
	end if;
	end;
end loop;
close C01;

if (reg_integracao_w.qt_reg_log > 0) then
	begin
	rollback;

	update intpd_fila_transmissao
	set	ie_status = 'E',
		ie_tipo_erro = 'F'
	where	nr_sequencia = nr_sequencia_p;

	for i in 0..reg_integracao_w.qt_reg_log-1 loop

		INTPD_GRAVAR_LOG_RECEBIMENTO(nr_sequencia_p,reg_integracao_w.intpd_log_receb[i].ds_log,'INTPDTASY');
	end loop;
	end;

else
	update	intpd_fila_transmissao
	set	ie_status = 'S',
		nr_seq_documento = coalesce(nr_requisicao_delete_w,requisicao_material_w.nr_requisicao),
		nr_doc_externo = c01_w.nr_documento_externo
	where	nr_sequencia = nr_sequencia_p;

end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE intpd_recebe_requisicao_matmed ( nr_sequencia_p bigint, xml_p xml) FROM PUBLIC;

