-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE delete_vinculo_procedimento (ds_valores_p text) AS $body$
DECLARE

valores_insert_w     varchar(10000);
pos_separador_w      bigint;
codigo1_w 	     varchar(10);
codigo2_w 	     varchar(10);WITH RECURSIVE cte AS (


valores_separados is CURSOR
with data as (SELECT ds_valores_p str )
SELECT trim(both regexp_substr(str, '[^|]+', 1, 1)) valor_w
from data
instr(str, '|', 1, level - 1) > 0  UNION ALL


valores_separados is CURSOR
with data as (SELECT ds_valores_p str )
SELECT trim(both regexp_substr(str, '[^|]+', 1, (c.level+1))) valor_w
from data
instr(str, '|', 1, level - 1) > 0 JOIN cte c ON ()

) SELECT * FROM cte;
;

linha_w			         valores_separados%rowtype;


BEGIN
  open valores_separados;
  loop
  fetch valores_separados into
    linha_w;
  EXIT WHEN NOT FOUND; /* apply on valores_separados */
    begin
      if (linha_w.valor_w IS NOT NULL AND linha_w.valor_w::text <> '') then
        pos_separador_w	:= position(',' in linha_w.valor_w);
        codigo1_w := substr(linha_w.valor_w, 1, pos_separador_w - 1);
        codigo2_w := substr(linha_w.valor_w, pos_separador_w + 1, length(linha_w.valor_w));

        EXECUTE 'delete from vinculo_procedimento where cd_procedimento1 = ' || codigo1_w || ' and ' || 'cd_procedimento2 = ' || codigo2_w;
        EXECUTE 'delete from vinculo_procedimento where cd_procedimento1 = ' || codigo2_w || ' and ' || 'cd_procedimento2 = ' || codigo1_w;
      end if;
    end;
  end loop;
  commit;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE delete_vinculo_procedimento (ds_valores_p text) FROM PUBLIC;

