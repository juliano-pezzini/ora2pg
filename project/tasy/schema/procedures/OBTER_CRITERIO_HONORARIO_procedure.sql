-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE obter_criterio_honorario ( ie_proc_mat_p text, nr_sequencia_p bigint, ie_proc_participante_p text, nr_sequencia_partip_p bigint, nr_seq_partic_p bigint, cd_convenio_p bigint, cd_regra_repasse_p bigint, nr_seq_proc_crit_repasse_p bigint, ie_responsavel_credito_p text, ie_omitir_regra_repasse_p text, cd_estabelecimento_p bigint, ds_regra_p INOUT text, nr_seq_criterio_p INOUT text, repasse_p INOUT text, cd_criterio_p INOUT bigint, ds_resp_credito_p INOUT text) AS $body$
DECLARE

 
 
nr_seq_criterio_w	bigint;
ds_resp_credito_w	varchar(255);
ds_regra_w		varchar(80);
ds_repasse_w		varchar(255);
ie_repasse_valor_w	varchar(1);
cd_criterio_w		bigint;


BEGIN 
 
if (ie_proc_mat_p = 'P') then 
 
	select	max(obter_criterio_honor_proc(nr_sequencia_p)) 
	into STRICT	nr_seq_criterio_w 
	;
	 
	if (ie_proc_participante_p = 'S') then 
	 
		select	max(obter_criterio_honor_partic(nr_sequencia_partip_p, nr_seq_partic_p)) 
		into STRICT	nr_seq_criterio_w 
		;
		 
		--select	'Resp. Crédito: ' || max(decode(a.ie_partic_resp_cred, 'S', 'Resp. crédito particip. igual ao do proc principal ')) 
		 
		select	wheb_mensagem_pck.get_texto(304520) || max(CASE WHEN a.ie_partic_resp_cred='S' THEN wheb_mensagem_pck.get_texto(304521) END ) 
		into STRICT	ds_resp_credito_w 
		from	convenio_estabelecimento a 
		where	a.cd_convenio = cd_convenio_p 
		and	a.cd_estabelecimento = cd_estabelecimento_p;
		 
	end if;
	 
	if (cd_regra_repasse_p = '' or coalesce(cd_regra_repasse_p::text, '') = '') then 
	 
		select	max(a.ds_regra) 
		into STRICT	ds_regra_w 
		from	regra_honorario a, 
				regra_honorario_criterio b 
		where	a.cd_regra = b.cd_regra 
		and	b.nr_sequencia = nr_seq_criterio_w;
	 
	else 
	 
		select	max(a.ds_regra) 
		into STRICT	ds_regra_w 
		from	regra_honorario a 
		where	a.cd_regra = to_char(cd_regra_repasse_p);
		 
	end if;
	 
	begin 
	select	a.ds_regra, 
		b.nr_seq_criterio 
	into STRICT	ds_repasse_w, 
		cd_criterio_w 
	from	regra_repasse_terceiro a, 
		procedimento_repasse b 
	where	a.cd_regra = b.cd_regra 
	and	b.nr_seq_procedimento = nr_sequencia_p;
	exception 
	when others then 
		ds_repasse_w := null;
		cd_criterio_w := null;
	end;
	 
	if (coalesce(ds_repasse_w::text, '') = '') then 
		 
		select	max(a.ds_regra) 
		into STRICT	ds_repasse_w 
		from	regra_repasse_terceiro a, 
			proc_criterio_repasse b 
		where	a.cd_regra = b.cd_regra 
		and	b.nr_sequencia = nr_seq_proc_crit_repasse_p;
		 
	end if;
	 
	if (coalesce(cd_criterio_w::text, '') = '') then 
		cd_criterio_w := nr_seq_proc_crit_repasse_p;
	end if;
	 
	select	coalesce(max(ie_repassa_medico),'N') 
	into STRICT	ie_repasse_valor_w 
	from	regra_honorario 
	where	cd_regra = ie_responsavel_credito_p;
	 
	if (ie_omitir_regra_repasse_p = 'S') and (ie_repasse_valor_w = 'N') then 
		ds_repasse_w := '';
		cd_criterio_w := '';
	end if;
	 
end if;
 
ds_regra_p		:= ds_regra_w;
nr_seq_criterio_p	:= nr_seq_criterio_w;
repasse_p		:= ds_repasse_w;
cd_criterio_p		:= cd_criterio_w;
ds_resp_credito_p	:= ds_resp_credito_w;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE obter_criterio_honorario ( ie_proc_mat_p text, nr_sequencia_p bigint, ie_proc_participante_p text, nr_sequencia_partip_p bigint, nr_seq_partic_p bigint, cd_convenio_p bigint, cd_regra_repasse_p bigint, nr_seq_proc_crit_repasse_p bigint, ie_responsavel_credito_p text, ie_omitir_regra_repasse_p text, cd_estabelecimento_p bigint, ds_regra_p INOUT text, nr_seq_criterio_p INOUT text, repasse_p INOUT text, cd_criterio_p INOUT bigint, ds_resp_credito_p INOUT text) FROM PUBLIC;

