-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE duplicar_proc_paciente_estab ( nr_sequencia_p procedimento_paciente.nr_sequencia%type, cd_setor_atendimento_p setor_atendimento.cd_setor_atendimento%type, nr_interno_conta_p conta_paciente.nr_interno_conta%type, nm_usuario_p usuario.nm_usuario%type, dt_entrada_unidade_p atend_paciente_unidade.dt_entrada_unidade%type, nr_seq_interno_p procedimento_paciente.nr_seq_atepacu%type) AS $body$
DECLARE


nr_sequencia_w			procedimento_paciente.nr_sequencia%type;
nr_atendimento_w		conta_paciente.nr_atendimento%type;
cd_convenio_w			conta_paciente.cd_convenio_parametro%type;
nr_seq_proc_pri_orig_w		procedimento_paciente.nr_seq_proc_princ%type;
nr_seq_proc_princ_w		procedimento_paciente.nr_seq_proc_princ%type;
cd_categoria_w			conta_paciente.cd_categoria_parametro%type;
cd_estabelecimento_w		conta_paciente.cd_estabelecimento%type;
nr_doc_convenio_w		procedimento_paciente.nr_doc_convenio%type := '';


BEGIN

select nextval('procedimento_paciente_seq')
into STRICT nr_sequencia_w
;

select	nr_atendimento,
	cd_convenio_parametro,
	cd_categoria_parametro,
	cd_estabelecimento
into STRICT	nr_atendimento_w,
	cd_convenio_w,
	cd_categoria_w,
	cd_estabelecimento_w
from	conta_paciente
where	nr_interno_conta = nr_interno_conta_p;

nr_doc_convenio_w	:= coalesce(obter_guia_atend(nr_atendimento_w,cd_convenio_w,cd_categoria_w),'');

begin
insert into Procedimento_paciente(
	nr_sequencia,			nr_atendimento,		dt_entrada_unidade,		cd_procedimento,
	dt_procedimento, 		qt_procedimento, 	dt_atualizacao, 		nm_usuario,
	cd_medico, 			cd_convenio, 		cd_categoria, 			cd_pessoa_fisica,
	dt_prescricao,			ds_observacao, 		vl_procedimento, 		vl_medico,
	vl_anestesista,			vl_materiais,		cd_edicao_amb,			cd_tabela_servico,
	dt_vigencia_preco,		cd_procedimento_princ,	dt_procedimento_princ,		dt_acerto_conta,
	dt_acerto_convenio,		dt_acerto_medico,	vl_auxiliares,			vl_custo_operacional,
	tx_medico, 			tx_anestesia, 		nr_prescricao, 			nr_sequencia_prescricao,
	cd_motivo_exc_conta,		ds_compl_motivo_excon,	cd_acao,			qt_devolvida,
	cd_motivo_devolucao,		nr_cirurgia,		nr_doc_convenio,
	ie_cobra_pf_pj,			nr_laudo,		dt_conta,			cd_setor_atendimento,
	cd_conta_contabil,		cd_procedimento_aih,	ie_origem_proced,		nr_aih,
	ie_responsavel_credito,		tx_procedimento,	cd_equipamento,			ie_valor_informado,
	cd_estabelecimento_custo,	cd_tabela_custo,	cd_situacao_glosa,		nr_lote_contabil,
	cd_procedimento_convenio,	nr_seq_autorizacao,	ie_tipo_servico_sus,		ie_tipo_ato_sus,
	cd_medico_executor,		cd_cgc_prestador,
	nr_nf_prestador,		cd_atividade_prof_bpa,	nr_interno_conta, 		nr_doc_honor_conv,
	nr_seq_proc_princ,		ie_guia_informada,	dt_inicio_procedimento,		ie_emite_conta,
	ie_funcao_medico,		ie_classif_sus,		cd_especialidade, 		nm_usuario_original,
	nr_seq_proc_pacote,		ie_tipo_proc_sus,	cd_setor_receita, 		vl_adic_plant,
	qt_porte_anestesico, 		tx_hora_extra,		ie_emite_conta_honor, 		nr_seq_atepacu,
	ie_proc_princ_atend,		cd_medico_req, 		ie_tipo_guia, 			ie_video,
	ie_auditoria,			nr_seq_exame,		nr_seq_aih,			nr_seq_proc_interno,
	nr_seq_material,		ie_via_acesso, 		ie_tecnica_utilizada,		cd_senha,
	cd_senha_autor,			nr_seq_origem,		nr_ato_ipasgo)
SELECT	nr_sequencia_w, 		nr_atendimento_w, 	dt_entrada_unidade_p, 		cd_procedimento,
	dt_procedimento,		qt_procedimento,	clock_timestamp(),			nm_usuario_p,
	cd_medico, 			cd_convenio_w, 		cd_categoria_w,			cd_pessoa_fisica,
	dt_prescricao,			ds_observacao, 		0, 				vl_medico,
	vl_anestesista,			vl_materiais,		cd_edicao_amb,			cd_tabela_servico,
	dt_vigencia_preco,		cd_procedimento_princ,	dt_procedimento_princ, 		dt_acerto_conta,
	dt_acerto_convenio, 		dt_acerto_medico, 	vl_auxiliares, 			vl_custo_operacional,
	tx_medico,			tx_anestesia,		nr_prescricao,			nr_sequencia_prescricao,
	cd_motivo_exc_conta,		ds_compl_motivo_excon,	cd_acao,			qt_devolvida,
	cd_motivo_devolucao,		nr_cirurgia,		CASE WHEN coalesce(nr_doc_convenio,'X')='X' THEN ''  ELSE coalesce(nr_doc_convenio_w,'') END ,
	ie_cobra_pf_pj, 		nr_laudo,		dt_conta,			cd_setor_atendimento_p,
	cd_conta_contabil,		cd_procedimento_aih,	ie_origem_proced,		nr_aih,
	'M',				tx_procedimento,	cd_equipamento,			ie_valor_informado,
	cd_estabelecimento_w,		cd_tabela_custo,	cd_situacao_glosa,		nr_lote_contabil,
	cd_procedimento_convenio, 	nr_seq_autorizacao,	ie_tipo_servico_sus,		ie_tipo_ato_sus,
	cd_medico_executor,		CASE WHEN ie_origem_proced=1 THEN CASE WHEN obter_area_procedimento(cd_procedimento,ie_origem_proced)=2 THEN null WHEN obter_area_procedimento(cd_procedimento,ie_origem_proced)=3 THEN null WHEN obter_area_procedimento(cd_procedimento,ie_origem_proced)=4 THEN null  ELSE cd_cgc_prestador END   ELSE cd_cgc_prestador END ,
	nr_nf_prestador,		cd_atividade_prof_bpa,	nr_interno_conta_p, 		nr_doc_honor_conv,
	nr_seq_proc_princ,		ie_guia_informada,	dt_inicio_procedimento,		ie_emite_conta,
	ie_funcao_medico,		ie_classif_sus,		cd_especialidade,		nm_usuario_original,
	nr_seq_proc_pacote,		ie_tipo_proc_sus,	cd_setor_atendimento_p,		vl_adic_plant,
	qt_porte_anestesico,		tx_hora_extra,		ie_emite_conta_honor,		nr_seq_interno_p,
	ie_proc_princ_atend,		cd_medico_req,		ie_tipo_guia,			ie_video,
	ie_auditoria,			nr_seq_exame,		nr_seq_aih,			nr_seq_proc_interno,
	nr_seq_material,		ie_via_acesso,		ie_tecnica_utilizada,		cd_senha,
	cd_senha_autor,			nr_sequencia,		nr_ato_ipasgo
from 	procedimento_paciente
where 	nr_sequencia = nr_sequencia_p;
exception
    	when others then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(279331);
	end;

begin
insert into procedimento_participante(cd_cbo,			cd_cgc,			cd_cgc_prestador_tiss,
	cd_cgc_prest_honor_tiss,	cd_cgc_prest_solic_tiss,cd_especialidade,
	cd_medico_convenio,		cd_medico_exec_conta,	cd_medico_exec_tiss,
	cd_medico_honor_tiss,		cd_pessoa_fisica,	cd_prestador_tiss,
	cd_proc_conv,			ds_prestador_tiss,	nr_seq_partic,
	ds_proc_conv,			ds_proc_tiss,		ds_stack,
	dt_atualizacao,			ie_doc_executor,	ie_emite_conta,
	ie_funcao,			ie_participou_sus,	ie_responsavel_credito,
	ie_tipo_ato_sus,		ie_tipo_servico_sus,	ie_tiss_tipo_guia,
	ie_valor_informado,		nm_usuario,		nr_cirurgia,
	nr_conta_medico,		nr_doc_honor_conv,	nr_lote_contabil,
	nr_sequencia,			pr_faturar,		pr_procedimento,
	qt_ponto_sus,			vl_conta,		vl_original,
	vl_participante,		vl_ponto_sus,		vl_repasse_calc)
SELECT	cd_cbo,				'',			cd_cgc_prestador_tiss,
	cd_cgc_prest_honor_tiss,	cd_cgc_prest_solic_tiss,cd_especialidade,
	cd_medico_convenio,		cd_medico_exec_conta,	cd_medico_exec_tiss,
	cd_medico_honor_tiss,		cd_pessoa_fisica,	cd_prestador_tiss,
	cd_proc_conv,			ds_prestador_tiss,	nr_seq_partic,
	ds_proc_conv,			ds_proc_tiss,		ds_stack,
	clock_timestamp(),			ie_doc_executor,	ie_emite_conta,
	ie_funcao,			ie_participou_sus,	'M',
	ie_tipo_ato_sus,		ie_tipo_servico_sus,	ie_tiss_tipo_guia,
	ie_valor_informado,		nm_usuario_p,		nr_cirurgia,
	nr_conta_medico,		nr_doc_honor_conv,	nr_lote_contabil,
	nr_sequencia_w,			pr_faturar,		pr_procedimento,
	qt_ponto_sus,			vl_conta,		vl_original,
	0,		vl_ponto_sus,		vl_repasse_calc
from	procedimento_participante
where	nr_sequencia = nr_sequencia_p;
exception
    	when others then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(279331);
	end;

begin
select	nr_seq_proc_princ
into STRICT	nr_seq_proc_pri_orig_w
from	procedimento_paciente
where 	nr_sequencia = nr_sequencia_p
and	(nr_seq_proc_princ IS NOT NULL AND nr_seq_proc_princ::text <> '');
exception
when others then
	nr_seq_proc_pri_orig_w	:= null;
end;
if (coalesce(nr_seq_proc_pri_orig_w,0) > 0) then
	begin

	begin
	select	nr_sequencia
	into STRICT	nr_seq_proc_princ_w
	from	procedimento_paciente
	where	nr_interno_conta = nr_interno_conta_p
	and	nr_seq_origem = nr_seq_proc_pri_orig_w;
	exception
	when others then
		nr_seq_proc_princ_w := null;
	end;

	if (coalesce(nr_seq_proc_princ_w,0) > 0) then
		begin

		update	procedimento_paciente
		set	nr_seq_proc_princ = nr_seq_proc_princ_w
		where	nr_sequencia = nr_sequencia_w;

		end;
	end if;

	end;
end if;

CALL atualiza_preco_procedimento(nr_sequencia_w,cd_convenio_w,nm_usuario_p);

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE duplicar_proc_paciente_estab ( nr_sequencia_p procedimento_paciente.nr_sequencia%type, cd_setor_atendimento_p setor_atendimento.cd_setor_atendimento%type, nr_interno_conta_p conta_paciente.nr_interno_conta%type, nm_usuario_p usuario.nm_usuario%type, dt_entrada_unidade_p atend_paciente_unidade.dt_entrada_unidade%type, nr_seq_interno_p procedimento_paciente.nr_seq_atepacu%type) FROM PUBLIC;

