-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE reservar_leito ( nr_sequencia_p bigint, nm_usuario_p text ) AS $body$
DECLARE


cd_setor_desejado_w	integer;
cd_unidade_basica_w	varchar(10);
cd_unidade_compl_w	varchar(10);
cd_pessoa_fisica_w	varchar(10);
ie_status_unidade_w	varchar(3);
cd_paciente_reserva_w	varchar(10);
cd_paciente_reserva_pos_w	varchar(10);
nm_paciente_reserva_pos_w	varchar(255);
ie_solicitacao_w	varchar(10);
nr_seq_vaga_reserva_w	bigint;
qt_pac_vaga_w		bigint;
dt_prevista_vaga_w	timestamp;
qt_dia_vaga_w		bigint;
qt_horas_vaga_w		bigint;
cd_estabelecimento_w	smallint;
IE_PER_RESERVA_GV_RESERVADO_w	varchar(1);
nr_atendimento_w		bigint;
ie_tipo_atendimento_w	smallint;
ie_sexo_reserva_w		varchar(2);
ie_sexo_pac_w		varchar(1);
ie_sexo_pac_leito_w	varchar(1);
ie_verifica_fila_w	varchar(1);
ie_reservar_sem_PF_w	varchar(1);
ie_mostra_gestao_disp_w varchar(1);
ie_status_fila_w        varchar(1);
nm_paciente_reserva_w	varchar(255) := '';
nm_paciente_reserva_GV_w	varchar(255) := '';
nr_seq_fila_w			bigint;
ie_status_reservar_w    varchar(1);
cd_genero_pac_w		pessoa_fisica_aux.NR_SEQ_GENERO%type;
cd_genero_pac_leito_w	unidade_atendimento.NR_SEQ_GENERO%type;


BEGIN
ie_reservar_sem_PF_w	:= coalesce(ie_reservar_sem_PF_w,'N');
ie_status_reservar_w	:= coalesce(ie_status_reservar_w,'R');

select	max(cd_pessoa_fisica),
	max(cd_setor_desejado),
	max(cd_unidade_basica),
	max(cd_unidade_compl),
	max(ie_solicitacao),
	max(cd_estabelecimento),
	max(nr_atendimento),
	max(nm_paciente)
into STRICT	cd_pessoa_fisica_w,
	cd_setor_desejado_w,
	cd_unidade_basica_w,
	cd_unidade_compl_w,
	ie_solicitacao_w,
	cd_estabelecimento_w,
	nr_atendimento_w,
	nm_paciente_reserva_GV_w
from	gestao_vaga
where	nr_sequencia	= nr_sequencia_p;


ie_verifica_fila_w := obter_param_usuario(1002, 77, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_verifica_fila_w);
ie_reservar_sem_PF_w := obter_param_usuario(1002, 147, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_reservar_sem_PF_w);
ie_status_reservar_w := obter_param_usuario(1002, 151, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_status_reservar_w);

if (ie_reservar_sem_PF_w = 'N') or (cd_pessoa_fisica_w IS NOT NULL AND cd_pessoa_fisica_w::text <> '') then
	nm_paciente_reserva_GV_w := null;
end if;

select 	max(IE_PER_RESERVA_GV_RESERVADO)
into STRICT	IE_PER_RESERVA_GV_RESERVADO_w
from	PARAMETRO_ATENDIMENTO
where	cd_estabelecimento = cd_estabelecimento_w;

begin
select	coalesce(max(ie_status_unidade),'L'),
	max(cd_paciente_reserva),
	max(nm_pac_reserva)
into STRICT	ie_status_unidade_w,
	cd_paciente_reserva_w,
	nm_paciente_reserva_w
from	unidade_atendimento
where	cd_unidade_basica	= cd_unidade_basica_w	
and	cd_unidade_compl	= cd_unidade_compl_w
and	cd_setor_atendimento	= cd_setor_desejado_w;
exception
when others then
	ie_status_unidade_w 		:= 'L';
	cd_paciente_reserva_w 		:= null;
	cd_paciente_reserva_pos_w 	:= null;
	nm_paciente_reserva_w		:= null;
end;

if (ie_reservar_sem_PF_w = 'N') or (cd_paciente_reserva_w IS NOT NULL AND cd_paciente_reserva_w::text <> '') then
	nm_paciente_reserva_w	:= null;
end if;

cd_paciente_reserva_pos_w	:= cd_paciente_reserva_w;
nm_paciente_reserva_pos_w	:= nm_paciente_reserva_w;

	select 	max(DT_PREVISTA),
		coalesce(max(QT_DIA),0),
		coalesce(max(QT_HORAS),0)
	into STRICT	dt_prevista_vaga_w,
		qt_dia_vaga_w,
		qt_horas_vaga_w
	from	gestao_vaga
	where	nr_sequencia = nr_sequencia_p;	
	

if	((cd_paciente_reserva_w IS NOT NULL AND cd_paciente_reserva_w::text <> '') or (nm_paciente_reserva_w IS NOT NULL AND nm_paciente_reserva_w::text <> '')) and (IE_PER_RESERVA_GV_RESERVADO_w = 'S') then

--	select 	max(DT_PREVISTA),

--		nvl(max(QT_DIA),0),

--		nvl(max(QT_HORAS),0)

--	into	dt_prevista_vaga_w,

--		qt_dia_vaga_w,

--		qt_horas_vaga_w

--	from	gestao_vaga

--	where	nr_sequencia = nr_sequencia_p;	
		
	select 	count(*) 	
	into STRICT	qt_pac_vaga_w
	from	gestao_vaga
	where	nr_sequencia <> nr_sequencia_p
	and	ie_status		= 'R'
	and	dt_prevista_vaga_w	between DT_PREVISTA and (DT_PREVISTA + coalesce(qt_dia,0) + (coalesce(qt_horas,0)/24))
	and	cd_unidade_basica	= cd_unidade_basica_w	
	and	cd_unidade_compl	= cd_unidade_compl_w
	and	cd_setor_desejado	= cd_setor_desejado_w;
	
	if (qt_pac_vaga_w = 0) then
		cd_paciente_reserva_w	:= null;
		nm_paciente_reserva_w	:= null;
	end if;	
end if;

if	((cd_paciente_reserva_w IS NOT NULL AND cd_paciente_reserva_w::text <> '') or (nm_paciente_reserva_w IS NOT NULL AND nm_paciente_reserva_w::text <> '')) then
	if (cd_paciente_reserva_w IS NOT NULL AND cd_paciente_reserva_w::text <> '') then
		begin
		
			select	obter_nome_pf(cd_paciente_reserva_w)
			into STRICT	nm_paciente_reserva_w
			;
			
		exception
		when others then
			nm_paciente_reserva_w := '';
		end;
	end if;
	
	if (nm_paciente_reserva_w = '') then
		CALL Wheb_mensagem_pck.exibir_mensagem_abort(216742);
	else
		CALL Wheb_mensagem_pck.exibir_mensagem_abort(216744,'NM_PACIENTE_W=' || nm_paciente_reserva_w);
	end if;
	
	--'Este leito ja esta reservado para outro paciente!'
end if;

if (nr_atendimento_w > 0) then
select max(ie_tipo_atendimento)
into STRICT   ie_tipo_atendimento_w
from   atendimento_paciente
where  nr_atendimento = nr_atendimento_w;
end if;

ie_sexo_reserva_w := obter_param_usuario(1002, 72, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_sexo_reserva_w);
if (ie_sexo_reserva_w = 'S') and (cd_pessoa_fisica_w IS NOT NULL AND cd_pessoa_fisica_w::text <> '') then

	select max(ie_sexo)
	into STRICT ie_sexo_pac_w
	from pessoa_fisica
	where cd_pessoa_fisica = cd_pessoa_fisica_w;

	select max(nr_seq_genero)
	into STRICT cd_genero_pac_w
	from pessoa_fisica_aux
	where cd_pessoa_fisica = cd_pessoa_fisica_w;

	select max(ie_sexo_paciente),
		max(nr_seq_genero)
	into STRICT ie_sexo_pac_leito_w,
		cd_genero_pac_leito_w
	from	unidade_atendimento
	where	cd_unidade_basica	= cd_unidade_basica_w
	and	cd_unidade_compl	= cd_unidade_compl_w
	and	cd_setor_atendimento = cd_setor_desejado_w;


	if ((upper(ie_sexo_pac_leito_w) = 'M') or (upper(ie_sexo_pac_leito_w)  = 'F')) and (upper(ie_sexo_pac_leito_w) <> ie_sexo_pac_w) and (obter_se_quarto_familiar(cd_setor_desejado_w,
								 cd_unidade_basica_w,
								 cd_unidade_compl_w,
								 cd_pessoa_fisica_w) = 'N') and
		((cd_genero_pac_w <> cd_genero_pac_leito_w) 
		or coalesce(cd_genero_pac_leito_w::text, '') = '')	then
		
		CALL Wheb_mensagem_pck.exibir_mensagem_abort(216745);
	   -- 'O sexo do paciente nao e permitido para este leito. Parametro 72 '
	end if;
end if;

ie_status_fila_w := 'R';
if	((ie_verifica_fila_w = 'S') and ((cd_paciente_reserva_w IS NOT NULL AND cd_paciente_reserva_w::text <> '') or (nm_paciente_reserva_w IS NOT NULL AND nm_paciente_reserva_w::text <> ''))) or (ie_verifica_fila_w = 'N') or (coalesce(cd_paciente_reserva_pos_w::text, '') = '') or (nm_paciente_reserva_pos_w IS NOT NULL AND nm_paciente_reserva_pos_w::text <> '') then

	if	((coalesce(cd_paciente_reserva_pos_w::text, '') = '') or (nm_paciente_reserva_pos_w IS NOT NULL AND nm_paciente_reserva_pos_w::text <> '')) and
		((ie_tipo_atendimento_w <> 3) or (coalesce(nr_atendimento_w::text, '') = '')) then

		if (ie_status_unidade_w = 'L')	then
			update	unidade_atendimento
			set	ie_status_unidade	= 'R',
				cd_paciente_reserva	= cd_pessoa_fisica_w,	
				ds_observacao		= substr(wheb_mensagem_pck.get_texto(794854,
										'DS_OBSERVACAO='||ds_observacao||
										';NM_USUARIO_RESERVA='||nm_usuario_p||
										';DT_RESERVA='||to_char(clock_timestamp(),pkg_date_formaters.localize_mask('timestamp', pkg_date_formaters.getUserLanguageTag(wheb_usuario_pck.get_cd_estabelecimento, nm_usuario_p)))),1,255),				
				nm_usuario_reserva	= nm_usuario_p,
				nm_usuario		= nm_usuario_p,
				dt_atualizacao		= clock_timestamp(),
				ie_tipo_reserva		= 'S',
				nm_pac_reserva		= nm_paciente_reserva_GV_w
			where	cd_unidade_basica	= cd_unidade_basica_w	
			and	cd_unidade_compl	= cd_unidade_compl_w
			and	cd_setor_atendimento	= cd_setor_desejado_w;
			
		else
			update	unidade_atendimento
			set	cd_paciente_reserva	= cd_pessoa_fisica_w,	
				ds_observacao		= substr(wheb_mensagem_pck.get_texto(794854,
										'DS_OBSERVACAO='||ds_observacao||
										';NM_USUARIO_RESERVA='||nm_usuario_p||
										';DT_RESERVA='||to_char(clock_timestamp(),pkg_date_formaters.localize_mask('timestamp', pkg_date_formaters.getUserLanguageTag(wheb_usuario_pck.get_cd_estabelecimento, nm_usuario_p)))),1,255),				
				nm_usuario_reserva	= nm_usuario_p,
				nm_usuario		= nm_usuario_p,
				dt_atualizacao		= clock_timestamp(),
				ie_tipo_reserva		= 'S',
				nm_pac_reserva		= nm_paciente_reserva_GV_w
			where	cd_unidade_basica	= cd_unidade_basica_w	
			and	cd_unidade_compl	= cd_unidade_compl_w
			and	cd_setor_atendimento	= cd_setor_desejado_w;
		end if;	
	end if;

		
	if (ie_tipo_atendimento_w = 3) /*and (ie_status_unidade_w = 'L')*/
 then
			update	unidade_atendimento
			set	cd_paciente_reserva	= cd_pessoa_fisica_w,
				ds_observacao		= substr(wheb_mensagem_pck.get_texto(794854,
										'DS_OBSERVACAO='||ds_observacao||
										';NM_USUARIO_RESERVA='||nm_usuario_p||
										';DT_RESERVA='||to_char(clock_timestamp(),pkg_date_formaters.localize_mask('timestamp', pkg_date_formaters.getUserLanguageTag(wheb_usuario_pck.get_cd_estabelecimento, nm_usuario_p)))),1,255),				
				nm_usuario_reserva	= nm_usuario_p,
				nm_usuario		= nm_usuario_p,
				nm_pac_reserva		= nm_paciente_reserva_GV_w
			where	cd_unidade_basica	= cd_unidade_basica_w	
			and	cd_unidade_compl	= cd_unidade_compl_w
			and	cd_setor_atendimento	= cd_setor_desejado_w;
			
		if (ie_status_unidade_w = 'L') then
			update	unidade_atendimento
			set	ie_status_unidade	= 'R'
			where	cd_unidade_basica	= cd_unidade_basica_w	
			and	cd_unidade_compl	= cd_unidade_compl_w
			and	cd_setor_atendimento	= cd_setor_desejado_w;
		end if;
		
	end if;

	if (ie_solicitacao_w	= 'TE') or (ie_solicitacao_w	= 'I') then

		if ((ie_tipo_atendimento_w <> 3) or (coalesce(nr_atendimento_w::text, '') = '')) then
			update	unidade_atendimento
			set	cd_paciente_reserva	= cd_pessoa_fisica_w,
				ie_tipo_reserva		= 'N',
				nm_usuario_reserva	= nm_usuario_p,
				nm_usuario		= nm_usuario_p,
				nm_pac_reserva		= nm_paciente_reserva_GV_w
			where	cd_unidade_basica	= cd_unidade_basica_w	
			and	cd_unidade_compl	= cd_unidade_compl_w
			and	cd_setor_atendimento	= cd_setor_desejado_w;
		end if;
	end if;
	ie_status_fila_w := 'U';
end if;

select	coalesce(max(ie_mostra_gestao_disp),'N')
into STRICT	ie_mostra_gestao_disp_w	
from	setor_atendimento
where	cd_setor_atendimento = cd_setor_desejado_w;


if (ie_mostra_gestao_disp_w = 'S') then

	insert into fila_espera_reserva(nr_sequencia,
					nr_seq_gv,
					dt_atualizacao,
					nm_usuario,
					dt_atualizacao_nrec,
					nm_usuario_nrec,
					ie_status,
					cd_unidade_basica,
					cd_unidade_compl,
					cd_setor_atendimento,
					cd_pessoa_reserva,
					dt_prevista,
					nm_pac_reserva) 
	                         values (nextval('fila_espera_reserva_seq'),
				        nr_sequencia_p,
					clock_timestamp(),
					nm_usuario_p,
					clock_timestamp(),
					nm_usuario_p,
					ie_status_fila_w,
					cd_unidade_basica_w,
					cd_unidade_compl_w,
					cd_setor_desejado_w,
					cd_pessoa_fisica_w,
					dt_prevista_vaga_w,
					nm_paciente_reserva_GV_w);
end if;	
	
update	gestao_vaga
set	ie_status	= ie_status_reservar_w
where	nr_sequencia	= nr_sequencia_p;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE reservar_leito ( nr_sequencia_p bigint, nm_usuario_p text ) FROM PUBLIC;

