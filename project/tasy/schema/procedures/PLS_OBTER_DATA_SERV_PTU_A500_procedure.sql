-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_obter_data_serv_ptu_a500 ( nr_seq_conta_p pls_conta.nr_sequencia%type, ie_participante_p text, ie_tipo_guia_p pls_conta.ie_tipo_guia%type, nr_seq_segurado_p pls_segurado.nr_sequencia%type, cd_guia_ok_p pls_conta.cd_guia_ok%type, nr_seq_congenere_p pls_congenere.nr_sequencia%type, dt_geracao_lote_fat_p pls_lote_faturamento.dt_geracao%type, dt_atendimento_p pls_conta.dt_atendimento%type, dt_alta_p pls_conta.dt_alta%type, ie_tipo_data_p pls_regra_data_ptu_serv.ie_tipo_data%type, ie_tipo_conta_p text, dt_item_p pls_conta_proc.dt_procedimento%type, ie_conta_fechada_p pls_regra_faturamento.ie_conta_fechada%type, dt_servico_p INOUT ptu_nota_servico.dt_procedimento%type) AS $body$
DECLARE

 
/* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ 
Finalidade:		Pegar a data do serviço 
------------------------------------------------------------------------------------------------------------------- 
Locais de chamada direta: 
[ ] Objetos do dicionário [ ] Tasy (Delphi/Java) [ ] Portal [ ] Relatórios [ ] Outros: 
 ------------------------------------------------------------------------------------------------------------------ 
Pontos de atenção:	NAO PODE TER COMMIT 
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */
 
 
dt_referencia_w		timestamp;


BEGIN 
dt_referencia_w := null;
 
-- Erro na validação do Intercambio Estadual. A data do serviço, quando o tipo da nota é igual a consultas ou serviços diversos/SADT, deve ser igual à data do atendimento. 
if (ie_tipo_guia_p <> '5') and (ie_participante_p = 'N') then			 
	select	min(dt_item) 
	into STRICT	dt_referencia_w 
	from (SELECT	min(a.dt_procedimento) dt_item 
		from	pls_conta_proc a 
		where	a.nr_seq_conta	= nr_seq_conta_p 
		
union
 
		SELECT	min(a.dt_atendimento) dt_item 
		from	pls_conta_mat a 
		where	a.nr_seq_conta	= nr_seq_conta_p) alias5;
		 
	if (dt_referencia_w IS NOT NULL AND dt_referencia_w::text <> '') then 
		dt_servico_p := dt_referencia_w;
	end if;
end if;
 
-- Não pode colocar tratamento para pegar data de outro lugar 
-- Quando uma guia tiver um vinculo com guia de internação, tem que gerar o a data da alta 
if (cd_guia_ok_p IS NOT NULL AND cd_guia_ok_p::text <> '') then 
	if (coalesce(ie_conta_fechada_p,'N') = 'S') then 
		select	min(dt_alta) 
		into STRICT	dt_referencia_w 
		from	pls_conta 
		where	nr_seq_segurado	= nr_seq_segurado_p 
		and	cd_guia_ok	= cd_guia_ok_p 
		and	ie_tipo_guia	= '5';
 
	else -- OS 802541 - Manual do PTU - Regra: Para notas de internação, adotar a data de inicio de faturamento¿, conforme regra do Envio de Dados da ANS		 
		begin 
		select	coalesce(dt_inicio_faturamento,dt_entrada) 
		into STRICT	dt_referencia_w 
		from	pls_conta 
		where	nr_sequencia	= nr_seq_conta_p 
		and	ie_tipo_guia	= '5';
		exception 
		when others then 
			dt_referencia_w := null;
		end;
	end if;
	 
	if (dt_referencia_w IS NOT NULL AND dt_referencia_w::text <> '') and (pls_obter_se_envia_conta(coalesce(dt_atendimento_p,dt_referencia_w), dt_geracao_lote_fat_p, nr_seq_congenere_p, nr_seq_segurado_p, nr_seq_conta_p) = 'N') then 
		dt_servico_p := dt_referencia_w;
	end if;
	 
	-- OS 744647 
	if (ie_tipo_guia_p in ('4')) and (coalesce(dt_referencia_w::text, '') = '') then 
		select	max(dt_emissao) 
		into STRICT	dt_referencia_w 
		from	pls_conta 
		where	nr_sequencia = nr_seq_conta_p;
		 
		if (dt_referencia_w IS NOT NULL AND dt_referencia_w::text <> '') and (pls_obter_se_envia_conta(coalesce(dt_servico_p,dt_referencia_w), dt_geracao_lote_fat_p, nr_seq_congenere_p, nr_seq_segurado_p, nr_seq_conta_p) = 'N') then 
			dt_servico_p := dt_referencia_w;
		end if;
	end if;
end if;
 
-- DATA DO PROCEDIMENTO NÃO PODE SER MAIOR QUE A DATA DA ALTA 
if (dt_alta_p IS NOT NULL AND dt_alta_p::text <> '') and (dt_alta_p < dt_servico_p) then 
	dt_servico_p := dt_alta_p;
end if;
 
if (ie_tipo_data_p = 'DI') then 
	dt_servico_p := dt_item_p;
	 
elsif (ie_tipo_data_p = 'DA') and (dt_atendimento_p IS NOT NULL AND dt_atendimento_p::text <> '') then 
	dt_servico_p := dt_atendimento_p;
end if;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_obter_data_serv_ptu_a500 ( nr_seq_conta_p pls_conta.nr_sequencia%type, ie_participante_p text, ie_tipo_guia_p pls_conta.ie_tipo_guia%type, nr_seq_segurado_p pls_segurado.nr_sequencia%type, cd_guia_ok_p pls_conta.cd_guia_ok%type, nr_seq_congenere_p pls_congenere.nr_sequencia%type, dt_geracao_lote_fat_p pls_lote_faturamento.dt_geracao%type, dt_atendimento_p pls_conta.dt_atendimento%type, dt_alta_p pls_conta.dt_alta%type, ie_tipo_data_p pls_regra_data_ptu_serv.ie_tipo_data%type, ie_tipo_conta_p text, dt_item_p pls_conta_proc.dt_procedimento%type, ie_conta_fechada_p pls_regra_faturamento.ie_conta_fechada%type, dt_servico_p INOUT ptu_nota_servico.dt_procedimento%type) FROM PUBLIC;

