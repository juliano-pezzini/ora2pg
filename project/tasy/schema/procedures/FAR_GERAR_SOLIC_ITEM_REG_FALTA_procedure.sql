-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE far_gerar_solic_item_reg_falta ( nr_solic_compra_p bigint, nr_seq_reg_falta_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint) AS $body$
DECLARE


nr_item_solic_compra_w		integer;
cd_material_w			integer;
cd_unidade_medida_compra_w	varchar(30);
qt_dia_entrega_w			varchar(10);
ie_somente_dias_uteis_w		varchar(1);
data_entrega_w			timestamp;
cd_local_estoque_w		bigint;


BEGIN

select	cd_local_estoque
into STRICT	cd_local_estoque_w
from	solic_compra
where	nr_solic_compra = nr_solic_compra_p;

select (coalesce(max(nr_item_solic_compra),0) + 1)
into STRICT	nr_item_solic_compra_w
from	solic_compra_item
where	nr_solic_compra = nr_solic_compra_p;

select 	a.cd_material,
	substr(obter_dados_material_estab(b.cd_material,cd_estabelecimento_p,'UMC'),1,30) cd_unidade_medida_compra
into STRICT	cd_material_w,
	cd_unidade_medida_compra_w
from 	far_registro_falta a,
	material b
where	a.cd_material = b.cd_material
and	a.nr_sequencia = nr_seq_reg_falta_p;

qt_dia_entrega_w := obter_param_usuario(913, 8, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, qt_dia_entrega_w);
ie_somente_dias_uteis_w := obter_param_usuario(913, 14, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_somente_dias_uteis_w);
data_entrega_w := dias_entrega_solic_compra(nr_solic_compra_p, qt_dia_entrega_w, ie_somente_dias_uteis_w, data_entrega_w);

insert into solic_compra_item(	nr_solic_compra,
			nr_item_solic_compra,
			cd_material,
			cd_unidade_medida_compra,
			qt_material,
			dt_atualizacao,
			nm_usuario,
			ie_situacao,
			ie_geracao,
			dt_solic_item,
			qt_conv_compra_est_orig,
			qt_saldo_disp_estoque)
		values (	nr_solic_compra_p,
			nr_item_solic_compra_w,
			cd_material_w,
			cd_unidade_medida_compra_w,
			1,
			clock_timestamp(),
			nm_usuario_p,
			'A',
			'U',
			data_entrega_w,
			obter_dados_material(cd_material_w,'QCE'),
			obter_saldo_disp_estoque(cd_estabelecimento_p, cd_material_w, cd_local_estoque_w, trunc(clock_timestamp(),'mm')));

insert into solic_compra_item_entrega(nr_solic_compra,
			nr_item_solic_compra,
			nr_item_solic_compra_entr,
			qt_entrega_solicitada,
			dt_entrega_solicitada,
			dt_atualizacao,
			nm_usuario)
		values (	nr_solic_compra_p,
			nr_item_solic_compra_w,
			1,
			1,
			data_entrega_w,
			clock_timestamp(),
			nm_usuario_p);

update	far_registro_falta
set	nr_solic_compra = nr_solic_compra_p,
	nr_item_solic_compra = nr_item_solic_compra_w
where	nr_sequencia = nr_seq_reg_falta_p;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE far_gerar_solic_item_reg_falta ( nr_solic_compra_p bigint, nr_seq_reg_falta_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint) FROM PUBLIC;

