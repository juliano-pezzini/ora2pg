-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_comp_di_peritoneal ( nr_seq_protocolo_p protocolo_npt.nr_sequencia%TYPE, cd_protocolo_p protocolo_medic_solucao.cd_protocolo%TYPE, nm_usuario_p protocolo_medic_solucao.nm_usuario%TYPE, NR_SEQUENCIA_P protocolo_medic_material.nr_sequencia%type, NR_SEQ_SOLUCAO_P protocolo_medic_material.nr_seq_solucao%type ) AS $body$
DECLARE


    count_material_exist_w      protocolo_medic_material.cd_material%TYPE;
    qt_volume_sol_w             protocolo_medic_solucao.qt_volume%TYPE;
  /*QT_SOLUCAO_TOTAL_W  	 	PROTOCOLO_MEDIC_SOLUCAO.Qt_Solucao_Total%type;*/

    qt_tempo_infusao_w          protocolo_medic_solucao.qt_tempo_infusao%TYPE;
    nr_seq_prot_soluc_w         protocolo_medic_solucao.nr_sequencia%TYPE;
    cd_medic_material_w         protocolo_medic_material.cd_material%TYPE;
    qt_medic_dose_w             protocolo_medic_material.qt_dose%TYPE;
    cd_medic_unidade_medida_w   protocolo_medic_material.cd_unidade_medida%TYPE;
    nr_seq_solucao_w            protocolo_medic_material.nr_seq_solucao%TYPE;

  /*TABELA PROTOCOLO_NPT_PROD*/

    nr_sequencia_w              protocolo_npt_prod.nr_sequencia%TYPE;
    dt_atualizacao_w            protocolo_npt_prod.dt_atualizacao%TYPE;
    nm_usuario_w                protocolo_npt_prod.nm_usuario%TYPE;
    nr_seq_protocolo_w          protocolo_npt_prod.nr_seq_protocolo%TYPE;
    nr_seq_elem_mat_w           protocolo_npt_prod.nr_seq_elem_mat%TYPE;
    qt_volume_w                 protocolo_npt_prod.qt_volume%TYPE;
    qt_vol_1_fase_w             protocolo_npt_prod.qt_vol_1_fase%TYPE;
    qt_vol_2_fase_w             protocolo_npt_prod.qt_vol_2_fase%TYPE;
    qt_vol_3_fase_w             protocolo_npt_prod.qt_vol_3_fase%TYPE;
    dt_atualizacao_nrec_w       protocolo_npt_prod.dt_atualizacao_nrec%TYPE;
    nm_usuario_nrec_w           protocolo_npt_prod.nm_usuario_nrec%TYPE;
    cd_material_w               protocolo_npt_prod.cd_material%TYPE;
    cd_unidade_medida_w         protocolo_npt_prod.cd_unidade_medida%TYPE;
    ds_observacao_w             protocolo_npt_prod.ds_observacao%TYPE;
    ie_dose_peso_w              protocolo_npt_prod.ie_dose_peso%TYPE;
    qt_npt_prod_dose_w          protocolo_npt_prod.qt_dose%TYPE;
    ie_dispensacao_w            protocolo_npt_prod.ie_dispensacao%TYPE;
    ie_prod_adicional_w         protocolo_npt_prod.ie_prod_adicional%TYPE;
    nr_seq_apresentacao_w       protocolo_npt_prod.nr_seq_apresentacao%TYPE;
    ie_somar_volume_w           protocolo_npt_prod.ie_somar_volume%TYPE;
    qt_vol_4_fase_w             protocolo_npt_prod.qt_vol_4_fase%TYPE;

    nr_seq_material_w		    bigint;
    nr_agrupamento_w            protocolo_medic_material.nr_agrupamento%TYPE;
    nr_sequencia_ww             protocolo_medic_material.nr_sequencia%TYPE;

  /*cursores*/

    c_protocolos CURSOR FOR
    SELECT
        qt_volume,
        qt_tempo_infusao
    FROM
        protocolo_npt
    WHERE
        nr_sequencia = nr_seq_protocolo_p;

    c_componentes CURSOR FOR
    SELECT
        nr_sequencia,
        dt_atualizacao,
        nm_usuario,
        nr_seq_protocolo,
        nr_seq_elem_mat,
        qt_volume,
        qt_vol_1_fase,
        qt_vol_2_fase,
        qt_vol_3_fase,
        dt_atualizacao_nrec,
        nm_usuario_nrec,
        cd_material,
        cd_unidade_medida,
        ds_observacao,
        ie_dose_peso,
        qt_dose,
        ie_dispensacao,
        ie_prod_adicional,
        nr_seq_apresentacao,
        ie_somar_volume,
        qt_vol_4_fase
    FROM
        protocolo_npt_prod a
    WHERE
        a.nr_seq_protocolo IN (
            SELECT
                nr_sequencia
            FROM
                protocolo_npt
            WHERE
                nr_sequencia = nr_seq_protocolo_p
        );


BEGIN
        OPEN c_componentes;
            FETCH c_componentes INTO
                nr_sequencia_w,
                dt_atualizacao_w,
                nm_usuario_w,
                nr_seq_protocolo_w,
                nr_seq_elem_mat_w,
                qt_volume_w,
                qt_vol_1_fase_w,
                qt_vol_2_fase_w,
                qt_vol_3_fase_w,
                dt_atualizacao_nrec_w,
                nm_usuario_nrec_w,
                cd_medic_material_w,
                cd_unidade_medida_w,
                ds_observacao_w,
                ie_dose_peso_w,
                qt_npt_prod_dose_w,
                ie_dispensacao_w,
                ie_prod_adicional_w,
                nr_seq_apresentacao_w,
                ie_somar_volume_w,
                qt_vol_4_fase_w;

            SELECT
                coalesce(COUNT(*), 0) cnt
            INTO STRICT count_material_exist_w
            FROM
                protocolo_medic_material
            WHERE
                cd_material = cd_medic_material_w
                and cd_protocolo = cd_protocolo_p;


            IF ( count_material_exist_w = 0 ) THEN
                SELECT coalesce(nr_seq_solucao,0)
                INTO STRICT nr_seq_prot_soluc_w
                FROM
                    protocolo_medic_solucao
                WHERE
                    cd_protocolo = cd_protocolo_p
                    AND nr_seq_protocolo = nr_seq_protocolo_p;

                    select	max(nr_seq_material)
                    into STRICT	nr_seq_material_w
                    From	protocolo_medic_Material
                    where	cd_protocolo = cd_protocolo_p
                    and	nr_sequencia = nr_sequencia_p;

                    nr_seq_material_w:= coalesce(nr_seq_material_w,0)+1;

                IF ( NR_SEQUENCIA_P > 0 ) THEN
                    
                --select Obter_seq_mat_prot_medic_mat(cd_protocolo_p, NR_SEQUENCIA_P) into  nr_sequencia_ww from dual;
                        select	NR_SEQUENCIA
                        into STRICT	nr_sequencia_ww
                        from	PROTOCOLO_MEDICACAO
                        where	cd_protocolo = cd_protocolo_p
                        and	nr_sequencia = nr_sequencia_p;
    
                select obter_agrup_prot_medic_mat(cd_protocolo_p,NR_SEQUENCIA_P,13) into STRICT nr_agrupamento_w;
                    
                INSERT INTO protocolo_medic_material(
                    nr_seq_material,
                    nr_sequencia,
                    cd_material,
                    cd_protocolo,
                    nr_seq_solucao,
                    cd_unidade_medida,
                    dt_atualizacao,
                    ie_aplic_bolus,
                    ie_aplic_lenta,
                    ie_bomba_infusao,
                    ie_urgencia,
                    nm_usuario,
                    nr_agrupamento,
                    ie_agrupador                    
                ) VALUES (
                    nr_seq_material_w,
                    nr_sequencia_ww,
                    cd_medic_material_w,
                    cd_protocolo_p,
                    NR_SEQ_SOLUCAO_P,
                    cd_unidade_medida_w,
                    clock_timestamp(),
                    'N',
                    'N',
                    'N',
                    'N',
                    nm_usuario_p,
                    nr_agrupamento_w,
                    13
                );

                END IF;
            END IF;
        CLOSE c_componentes;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_comp_di_peritoneal ( nr_seq_protocolo_p protocolo_npt.nr_sequencia%TYPE, cd_protocolo_p protocolo_medic_solucao.cd_protocolo%TYPE, nm_usuario_p protocolo_medic_solucao.nm_usuario%TYPE, NR_SEQUENCIA_P protocolo_medic_material.nr_sequencia%type, NR_SEQ_SOLUCAO_P protocolo_medic_material.nr_seq_solucao%type ) FROM PUBLIC;

