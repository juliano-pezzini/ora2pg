-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_estornar_adep_map ( nr_seq_processo_p bigint, nr_seq_horario_p bigint, nr_seq_area_prep_p bigint, ie_gerar_estornar_p text, dt_gerar_estornar_p timestamp, nm_usuario_p text, nr_seq_map_p INOUT bigint, ie_momento_p text default null, qt_material_p bigint DEFAULT NULL, nr_seq_lote_fornec_p bigint DEFAULT NULL) AS $body$
DECLARE

					
nr_atendimento_w	bigint;
nr_atendimento_ww	bigint;
nr_prescricao_w		bigint;
dt_prescricao_w		timestamp;
nr_seq_matmed_w		integer;
nr_seq_material_w	integer;
nr_seq_kit_w		integer;
nr_seq_diluicao_w	integer;
cd_material_w		integer;
cd_material_exec_w	integer;
cd_mat_regra_w		integer;
qt_total_dispensar_w	double precision;
dt_horario_w		timestamp;
cd_local_estoque_baixa_w	bigint;
qt_dispensar_hor_w		double precision;
cd_um_dose_w		varchar(30);
VarCobrarZerado_w	varchar(30);
ds_erro_w		varchar(250);
cd_local_estoque_w	bigint;
cd_local_estoque_ww	smallint := null;
nr_seq_dialise_w	bigint;
ie_baixa_estoque_w	varchar(1);
nr_seq_lote_fornec_w	bigint;
varLancaAuto_w		varchar(10);	
qt_unitaria_w		double precision;

nr_seq_atepacu_w		bigint;
cd_setor_paciente_w	integer;
dt_entrada_unidade_w	timestamp;

nr_seq_lote_ap_w		bigint;
nr_seq_processo_w		bigint;
nr_seq_processo_ww		bigint;

cd_convenio_w		integer;
cd_categoria_w		varchar(10);
ie_agrupador_w		integer;

qt_total_mat_hor_w		double precision;

nr_seq_map_w		bigint;

nr_seq_item_w		bigint;
cd_motivo_baixa_w	bigint;
cont_w			bigint;
nr_seq_horario_w	bigint;
ie_horario_conta_w	varchar(10);
ie_setor_lancamento_w	varchar(15);
cd_setor_prescricao_w	integer;
cd_setor_prescricao_ww	integer := null;

nr_doc_convenio_w		varchar(20);
ie_tipo_guia_w			varchar(2);
cd_senha_w			varchar(20);
Ie_Local_Estoque_Prescr_w	varchar(2);
Ie_Altera_data_w		varchar(1);
dt_prescricao_ww		timestamp;
ie_nao_req_est_paciente_w 	varchar(15);
ie_gerar_estornar_w		varchar(5);
cd_unidade_medida_regra_w	varchar(50);
ie_prescr_conta_w		varchar(15);
nr_seq_pe_proc_w		bigint;
ie_cobra_assoc_inter_zerado_w	varchar(1) := 'N';
ie_nao_requisitado_w		varchar(1);
cd_unidade_medida_dose_w	varchar(30);
ie_mat_ivc_w				varchar(1);
ie_registrar_w				boolean := false;
ie_registrar_log_w			varchar(1);
cd_classe_material_w		bigint;
cd_grupo_material_w			bigint;
cd_subgrupo_material_w		bigint;
nr_seq_familia_w			bigint;
ie_cobrar_w					varchar(1);
cd_perfil_w					integer := obter_perfil_ativo;
ie_momento_lancamento_w		varchar(10);
dt_atualizacao_estoque_w	timestamp;
cd_estabelecimento_w		smallint	:= wheb_usuario_pck.get_cd_estabelecimento;
cd_setor_conta_w			integer;
cd_local_conta_w			bigint;
qt_material_conta_w			double precision;
nr_seq_prescr_conta_w		bigint;
ie_via_aplicacao_w		prescr_material.ie_via_aplicacao%type;
nr_seq_lote_w			ap_lote.nr_sequencia%type;
ie_origem_lote_w		ap_lote.ie_origem_lote%type;
cd_setor_atendimento_w		prescr_medica.cd_setor_atendimento%type;
ie_lancar_item_zerado_w		varchar(1);
nr_lote_producao_w			lote_producao.nr_lote_producao%type;
qt_real_w					lote_producao.qt_real%type;
ie_param_88_w				varchar(1);
ie_param_44_pharm_w			varchar(1);
nr_sequencia_proc_w			prescr_material.nr_sequencia_proc%type;
nr_seq_proc_pac_w			procedimento_paciente.nr_sequencia%type;
ie_regra_disp_w				prescr_material.ie_regra_disp%type;
qt_disp_conv_w				prescr_mat_hor.qt_dispensar_hor%type;
qt_conversao_w				prescr_mat_hor.qt_dispensar_hor%type;
cd_cgc_fornecedor_w			material_atend_paciente.cd_cgc_fornecedor%type;
ie_mat_consignado_w			material.ie_consignado%type := null;
ie_tipo_saldo_w				varchar(1);
ie_grupo_w					varchar(1) := 'N';
nr_seq_regra_w				bigint;
qt_estoque_w				double precision;
qt_diferenca_w				bigint := 0;
qt_material_baixar			double precision;
qt_baixado_consignado_w		double precision;
qt_baixado_proprio_w		double precision;
ie_continua					varchar(1)	:= 'S';
qt_material_w				double precision := 0;
saldo_total					double precision;
ie_estoque_lote_w			varchar(1);
ie_cobra_sem_lote_w			varchar(1);
ie_cobra_item_disp_enf_w	varchar(1);
ie_item_sem_lote_w			varchar(1);

c01 CURSOR FOR
SELECT	nr_atendimento,
	nr_sequencia,
	cd_material,
	dt_horario_processo,
	qt_conta,
	cd_unidade_medida_conta,
	nr_seq,
	cd_local_estoque,
	ie_baixa_estoque,
	nr_seq_lote_fornec,
	ie_horario_conta,
	nr_seq_horario,
	ie_nao_requisitado,
	nr_lote_producao	
from	(
SELECT	a.nr_atendimento,
	b.nr_sequencia,
	b.cd_material,
	a.dt_horario_processo,
	b.qt_conta,
	b.cd_unidade_medida_conta,
	a.nr_sequencia nr_seq,
	CASE WHEN ie_nao_requisitado='S' THEN coalesce(cd_local_estoque_ww,a.cd_local_estoque)  ELSE a.cd_local_estoque END  cd_local_estoque,
	coalesce(b.ie_baixa_estoque,'S') ie_baixa_estoque,
	b.nr_seq_lote_fornec,
	coalesce(obter_se_horario_conta(b.nr_seq_horario),'N') ie_horario_conta,
	b.nr_seq_horario,
	ie_nao_requisitado,
	0 nr_lote_producao	
from	adep_processo_item b,
	adep_processo a
where	b.nr_seq_processo	= a.nr_sequencia
and	a.nr_sequencia		= nr_seq_processo_p
and	((coalesce(b.ie_lanca_conta,'S')	= 'S') or (coalesce(obter_se_horario_conta(b.nr_seq_horario),'N') = 'S'))
and	((ie_gerar_estornar_p	<> 'GN') or
	 ((coalesce(b.ie_nao_requisitado,'N') = 'S') and (coalesce(b.nr_prescricao::text, '') = '')))
and	((ie_gerar_estornar_w = 'E') or ((ie_gerar_estornar_w = 'G') and (coalesce(b.ie_conta_paciente,'N') = 'N')))
and	((coalesce(nr_seq_area_prep_p::text, '') = '') or (b.nr_seq_area_prep = nr_seq_area_prep_p))
and	((coalesce(ie_nao_req_est_paciente_w,'N') = 'N') or (coalesce(b.ie_nao_requisitado,'N') = 'S'))
and	obter_se_processo_disp(b.nr_seq_horario, nr_seq_processo_p) = 'S'
and ((coalesce(b.nr_lote_producao::text, '') = '') or (ie_param_88_w = 'N'))
and ((ie_momento_p <> 'SP') or (ie_param_44_pharm_w <> 'A') or (coalesce(gedipa_consiste_iventario(obter_estabelecimento_ativo, b.cd_material, a.cd_local_estoque)::text, '') = ''))

union

select	a.nr_atendimento,
	b.nr_sequencia,
	b.cd_material,
	a.dt_horario_processo,
	b.qt_conta,
	b.cd_unidade_medida_conta,
	a.nr_sequencia nr_seq,
	CASE WHEN ie_nao_requisitado='S' THEN coalesce(cd_local_estoque_ww,a.cd_local_estoque)  ELSE a.cd_local_estoque END  cd_local_estoque,
	coalesce(b.ie_baixa_estoque,'S') ie_baixa_estoque,
	b.nr_seq_lote_fornec,
	coalesce(obter_se_horario_conta(b.nr_seq_horario),'N') ie_horario_conta,
	b.nr_seq_horario,
	ie_nao_requisitado,
	0 nr_lote_producao	
from	adep_processo_item b,
	adep_processo a
where	b.nr_seq_processo	= a.nr_sequencia
and	a.nr_sequencia		= nr_seq_processo_p
and	((ie_gerar_estornar_p	<> 'GN') or
	 ((coalesce(b.ie_nao_requisitado,'N') = 'S') and (coalesce(b.nr_prescricao::text, '') = '')))
and	((ie_gerar_estornar_w = 'E') or ((ie_gerar_estornar_w = 'G') and (coalesce(b.ie_lanc_automatico, 'N') = 'N')))
and	((coalesce(nr_seq_area_prep_p::text, '') = '') or (b.nr_seq_area_prep = nr_seq_area_prep_p))
and	((ie_gerar_estornar_w = 'E') or ((ie_gerar_estornar_w = 'G') and (coalesce(b.ie_conta_paciente,'N') = 'N')))
and	((coalesce(ie_nao_req_est_paciente_w,'N') = 'SL') and (obter_se_proc_hor_lote(b.nr_seq_horario, nr_seq_processo_p) = 'N'))
and	obter_se_processo_disp(b.nr_seq_horario, nr_seq_processo_p) = 'S'
and ((coalesce(b.nr_lote_producao::text, '') = '') or (ie_param_88_w = 'N'))
and ((ie_momento_p <> 'SP') or (ie_param_44_pharm_w <> 'A') or (coalesce(gedipa_consiste_iventario(obter_estabelecimento_ativo, b.cd_material, a.cd_local_estoque)::text, '') = ''))

union

select	a.nr_atendimento,
		b.nr_sequencia,
		c.cd_material,
		a.dt_horario_processo,
		CASE WHEN coalesce(c.qt_prevista,0)=0 THEN  b.qt_conta  ELSE coalesce(c.qt_prevista,0) END , 				
		CASE WHEN coalesce(c.qt_prevista,0)=0 THEN  b.cd_unidade_medida_conta  ELSE c.cd_unidade_medida END , 		
		a.nr_sequencia nr_seq,
		CASE WHEN ie_nao_requisitado='S' THEN coalesce(cd_local_estoque_ww,a.cd_local_estoque)  ELSE a.cd_local_estoque END  cd_local_estoque,
		'N' ie_baixa_estoque,
		b.nr_seq_lote_fornec,
		coalesce(obter_se_horario_conta(b.nr_seq_horario),'N') ie_horario_conta,
		b.nr_seq_horario,
		ie_nao_requisitado,
		b.nr_lote_producao		
from	adep_processo_item b,
		adep_processo a,
		lote_producao_comp c
where	b.nr_seq_processo	= a.nr_sequencia
and		c.nr_lote_producao  = b.nr_lote_producao
and		a.nr_sequencia		= nr_seq_processo_p
and		((ie_gerar_estornar_p	<> 'GN') or
	 	((coalesce(b.ie_nao_requisitado,'N') = 'S') and (coalesce(b.nr_prescricao::text, '') = '')))
and		((ie_gerar_estornar_w = 'E') or ((ie_gerar_estornar_w = 'G') and (coalesce(b.ie_lanc_automatico, 'N') = 'N')))
and		((coalesce(nr_seq_area_prep_p::text, '') = '') or (b.nr_seq_area_prep = nr_seq_area_prep_p))
and		((ie_gerar_estornar_w = 'E') or ((ie_gerar_estornar_w = 'G') and (coalesce(b.ie_conta_paciente,'N') = 'N')))
--and		((nvl(ie_nao_req_est_paciente_w,'N') = 'SL') and (obter_se_proc_hor_lote(b.nr_seq_horario, nr_seq_processo_p) = 'N'))
and		obter_se_processo_disp(b.nr_seq_horario, nr_seq_processo_p) = 'S'
and     (b.nr_lote_producao IS NOT NULL AND b.nr_lote_producao::text <> '' AND ie_param_88_w = 'S')
and		((ie_momento_p <> 'SP') or (ie_param_44_pharm_w <> 'A') or (coalesce(gedipa_consiste_iventario(obter_estabelecimento_ativo, b.cd_material, a.cd_local_estoque)::text, '') = ''))
) alias123
order by coalesce(nr_seq_horario,999999999);

c02 CURSOR FOR
SELECT	a.nr_sequencia
from	adep_processo b,
	adep_processo_item a
where	a.nr_seq_processo	= b.nr_sequencia
and	a.nr_seq_processo	= nr_seq_processo_w
and	b.nr_sequencia		= nr_seq_processo_w
and	a.cd_material		= cd_material_w;

c03 CURSOR FOR
	SELECT 	coalesce(ie_cobrar,'S')
	from	regra_cobranca_mat_adep
	where	((coalesce(cd_material::text, '') = '') or (cd_material = cd_material_w))
	and	((coalesce(cd_classe_material::text, '') = '') or (cd_classe_material = cd_classe_material_w))
	and	((coalesce(cd_grupo_material::text, '') = '') or (cd_grupo_material = cd_grupo_material_w))
	and	((coalesce(cd_subgrupo_material::text, '') = '') or (cd_subgrupo_material = cd_subgrupo_material_w))
	and	((coalesce(nr_seq_familia::text, '') = '') or (nr_seq_familia = nr_seq_familia_w))
	and	((coalesce(cd_setor_atendimento::text, '') = '') or (cd_setor_atendimento = cd_setor_paciente_w) or (coalesce(cd_setor_paciente_w::text, '') = ''))
	order by
		coalesce(cd_material,0),
		coalesce(cd_classe_material,0),
		coalesce(cd_grupo_material,0),
		coalesce(cd_subgrupo_material,0),
		coalesce(nr_seq_familia_w,0),
		coalesce(cd_setor_atendimento,0);
		
								

BEGIN
ie_momento_lancamento_w := obter_param_usuario(1113, 97, cd_perfil_w, nm_usuario_p, cd_estabelecimento_w, ie_momento_lancamento_w);
ie_lancar_item_zerado_w := obter_param_usuario(1113, 679, cd_perfil_w, nm_usuario_p, cd_estabelecimento_w, ie_lancar_item_zerado_w);
ie_cobra_sem_lote_w := obter_param_usuario(-1113, 76, cd_perfil_w, nm_usuario_p, cd_estabelecimento_w, ie_cobra_sem_lote_w);
ie_cobra_item_disp_enf_w := obter_param_usuario(-1113, 77, cd_perfil_w, nm_usuario_p, cd_estabelecimento_w, ie_cobra_item_disp_enf_w);

if (obter_rastreabilidade_adep(nr_seq_processo_p, 'CH') = 'S') then
	CALL adep_gerar_log_rastr('{'||chr(10)||
						'"'||$$plsql_unit||'" : "'||$$plsql_line||'",'||chr(10)||
						'"dt_gerar_estornar_p" : "'||to_char(dt_gerar_estornar_p, 'dd/mm/yyyy hh24:mi:ss')||'",'||chr(10)||
						'"ie_gerar_estornar_p" : "'||ie_gerar_estornar_p||'",'||chr(10)||
						'"ie_momento_p" : "'||ie_momento_p||'",'||chr(10)||
						'"nm_usuario_p" : "'||nm_usuario_p||'",'||chr(10)||
						'"nr_seq_area_prep_p" : "'||nr_seq_area_prep_p||'",'||chr(10)||
						'"nr_seq_horario_p" : "'||nr_seq_horario_p||'",'||chr(10)||
						'"nr_seq_lote_fornec_p" : "'||nr_seq_lote_fornec_p||'",'||chr(10)||
						'"nr_seq_map_p" : "'||nr_seq_map_p||'",'||chr(10)||
						'"nr_seq_processo_p" : "'||nr_seq_processo_p||'",'||chr(10)||
						'"qt_material_p" : "'||qt_material_p||'",'||chr(10)||
						'"cd_estabelecimento_w" : "'||cd_estabelecimento_w||'",'||chr(10)||
						'"cd_perfil_w" : "'||cd_perfil_w||'",'||chr(10)||
						'"ie_lancar_item_zerado_w" : "'||ie_lancar_item_zerado_w||'",'||chr(10)||
						'"ie_cobra_sem_lote_w" : "'||ie_cobra_sem_lote_w||'",'||chr(10)||
						'"ie_cobra_item_disp_enf_w" : "'||ie_cobra_item_disp_enf_w||'",'||chr(10)||
						'"ie_momento_lancamento_w" : "'||ie_momento_lancamento_w||'"}'
						, wheb_usuario_pck.get_ie_commit);
end if;

if (ie_gerar_estornar_p IS NOT NULL AND ie_gerar_estornar_p::text <> '') and (dt_gerar_estornar_p IS NOT NULL AND dt_gerar_estornar_p::text <> '') and (nm_usuario_p IS NOT NULL AND nm_usuario_p::text <> '') and ((coalesce(nr_seq_processo_p,nr_seq_horario_p) IS NOT NULL AND (coalesce(nr_seq_processo_p,nr_seq_horario_p))::text <> '')) then
			
	if (ie_gerar_estornar_p	= 'GN') then
		ie_gerar_estornar_w	:= 'G';
	else
		ie_gerar_estornar_w	:= ie_gerar_estornar_p;
	end if;	
	ie_setor_lancamento_w := obter_param_usuario(1113, 161, cd_perfil_w, nm_usuario_p, cd_estabelecimento_w, ie_setor_lancamento_w);

	ie_nao_req_est_paciente_w := obter_param_usuario(3112, 51, cd_perfil_w, nm_usuario_p, cd_estabelecimento_w, ie_nao_req_est_paciente_w);
	ie_param_88_w := obter_param_usuario(3112, 88, cd_perfil_w, nm_usuario_p, cd_estabelecimento_w, ie_param_88_w);
	ie_param_44_pharm_w := obter_param_usuario(-1113, 44, cd_perfil_w, nm_usuario_p, cd_estabelecimento_w, ie_param_44_pharm_w);
	
	
	if (ie_nao_req_est_paciente_w in ('S','SL'))  then
		select	max(nr_atendimento)
		into STRICT	nr_atendimento_ww
		from	adep_processo
		where	nr_sequencia = nr_seq_processo_p;
		
		if (nr_atendimento_ww IS NOT NULL AND nr_atendimento_ww::text <> '') then
			cd_local_estoque_ww	:= obter_local_estoque_setor(Obter_Unidade_Atendimento(nr_atendimento_ww,'IA','CS'),cd_estabelecimento_w);
		end if;	
	end if;	

	Ie_Altera_data_w := obter_param_usuario(3112, 43, cd_perfil_w, nm_usuario_p, cd_estabelecimento_w, Ie_Altera_data_w);
	if (Ie_Altera_data_w = 'S') then
		if (nr_seq_horario_p IS NOT NULL AND nr_seq_horario_p::text <> '') then
			select	max(dt_prescricao)
			into STRICT	dt_prescricao_ww
			from	prescr_medica a,
				prescr_mat_hor b
			where	a.nr_prescricao = b.nr_prescricao
			and	b.nr_sequencia = nr_seq_horario_p;
		else
			/* Obter a data da  primeira prescricao que encontrar com aquele processo */

			select	max(dt_prescricao)
			into STRICT	dt_prescricao_ww
			from	prescr_medica a,
				prescr_mat_hor b
			where	a.nr_prescricao = b.nr_prescricao
			and	b.nr_seq_processo = nr_seq_processo_p;
		end if;
	end if;

	if (obter_rastreabilidade_adep(nr_seq_processo_p, 'CH') = 'S') then
		CALL adep_gerar_log_rastr('{'||chr(10)||
							'"'||$$plsql_unit||'" : "'||$$plsql_line||'",'||chr(10)||
							'"nr_seq_processo_p" : "'||nr_seq_processo_p||'",'||chr(10)||
							'"ie_gerar_estornar_w" : "'||ie_gerar_estornar_w||'",'||chr(10)||
							'"ie_setor_lancamento_w" : "'||ie_setor_lancamento_w||'",'||chr(10)||
							'"ie_nao_req_est_paciente_w" : "'||ie_nao_req_est_paciente_w||'",'||chr(10)||
							'"ie_param_88_w" : "'||ie_param_88_w||'",'||chr(10)||
							'"ie_param_44_pharm_w" : "'||ie_param_44_pharm_w||'",'||chr(10)||
							'"nr_atendimento_ww" : "'||nr_atendimento_ww||'",'||chr(10)||
							'"Ie_Altera_data_w" : "'||Ie_Altera_data_w||'",'||chr(10)||
							'"dt_prescricao_ww" : "'||to_char(dt_prescricao_ww, 'dd/mm/yyyy hh24:mi:ss')||'"}'
							, wheb_usuario_pck.get_ie_commit);
	end if;

	CALL gravar_log_before_rais(94902,	'1 - gerar_estornar_adep_map '||
										' nr_seq_processo_p='||nr_seq_processo_p||
										' dt_gerar_estornar_p='||PKG_DATE_FORMATERS_TZ.TO_VARCHAR(dt_gerar_estornar_p, 'timestamp', ESTABLISHMENT_TIMEZONE_UTILS.getTimeZone)||
										' ie_gerar_estornar_p='||ie_gerar_estornar_p||
										' nr_seq_horario_p='||nr_seq_horario_p||
										' nr_seq_area_prep_p='||nr_seq_area_prep_p||
										' '||substr(dbms_utility.format_call_stack,1,1800),nm_usuario_p);
				
	if (nr_seq_horario_p IS NOT NULL AND nr_seq_horario_p::text <> '') then
		begin
		/* obter rep */
		
		Ie_Local_Estoque_Prescr_w := obter_param_usuario(1113, 429, cd_perfil_w, nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento, Ie_Local_Estoque_Prescr_w);
		varLancaAuto_w := obter_param_usuario(1113, 505, cd_perfil_w, nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento, varLancaAuto_w);
		
		Ie_Local_Estoque_Prescr_w := obter_param_usuario(1113, 429, cd_perfil_w, nm_usuario_p, cd_estabelecimento_w, Ie_Local_Estoque_Prescr_w);

		if (obter_rastreabilidade_adep(nr_seq_processo_p, 'CH') = 'S') then
			CALL adep_gerar_log_rastr('{'||chr(10)||
								'"'||$$plsql_unit||'" : "'||$$plsql_line||'",'||chr(10)||
								'"nr_seq_processo_p" : "'||nr_seq_processo_p||'",'||chr(10)||
								'"Ie_Local_Estoque_Prescr_w" : "'||Ie_Local_Estoque_Prescr_w||'",'||chr(10)||
								'"varLancaAuto_w" : "'||varLancaAuto_w||'",'||chr(10)||
								'"cd_estabelecimento_w" : "'||cd_estabelecimento_w||'",'||chr(10)||
								'"cd_perfil_w" : "'||cd_perfil_w||'"}'
								, wheb_usuario_pck.get_ie_commit);
		end if;

		if (Ie_Local_Estoque_Prescr_w = 'LS') then
			select 	coalesce(max(nr_seq_processo),0)
			into STRICT	nr_seq_processo_ww
			from	prescr_mat_hor
			where	nr_sequencia = nr_seq_horario_p;
			
			if (nr_seq_processo_ww > 0) then
				select 	max(cd_local_estoque)
				into STRICT	cd_local_estoque_w
				from	adep_processo
				where	nr_sequencia = nr_seq_processo_ww;
			end if;
		end if;
		
		select	a.nr_atendimento,
			a.nr_prescricao,
			a.dt_prescricao,			
			b.nr_sequencia,
			b.cd_material,
			b.qt_total_dispensar,
			c.dt_horario,
			CASE WHEN coalesce(c.cd_motivo_baixa,0)=0 THEN c.qt_dispensar_hor  ELSE 0 END ,
			c.cd_unidade_medida, --c.cd_unidade_medida_dose, OS92913
			CASE WHEN Ie_Local_Estoque_Prescr_w='S' THEN coalesce(c.cd_local_estoque_baixa,coalesce(obter_local_estoque_setor(a.cd_setor_atendimento,a.cd_estabelecimento),b.cd_local_estoque)) WHEN Ie_Local_Estoque_Prescr_w='LS' THEN cd_local_estoque_w WHEN Ie_Local_Estoque_Prescr_w='LI' THEN b.cd_local_estoque  ELSE null END ,
			c.nr_seq_lote,
			c.nr_seq_processo,				
			b.ie_agrupador,
			b.qt_unitaria,
			c.nr_seq_dialise,
			coalesce(nr_seq_lote_fornec_p,c.nr_seq_lote_fornec),
			b.nr_seq_pe_proc,
			c.cd_unidade_medida_dose,
			b.ie_via_aplicacao,
			coalesce(c.nr_seq_lote,0),
			a.cd_setor_atendimento,
			b.nr_sequencia_proc,
			ie_regra_disp			
		into STRICT	nr_atendimento_w,
			nr_prescricao_w,
			dt_prescricao_w,
			nr_seq_matmed_w,
			cd_material_w,
			qt_total_dispensar_w,
			dt_horario_w,
			qt_dispensar_hor_w,
			cd_um_dose_w,
			cd_local_estoque_w,
			nr_seq_lote_ap_w,
			nr_seq_processo_w,				
			ie_agrupador_w,
			qt_unitaria_w,
			nr_seq_dialise_w,
			nr_seq_lote_fornec_w,
			nr_seq_pe_proc_w,
			cd_unidade_medida_dose_w,
			ie_via_aplicacao_w,
			nr_seq_lote_w,
			cd_setor_atendimento_w,
			nr_sequencia_proc_w,
			ie_regra_disp_w
		from	prescr_medica a,
			prescr_material b,
			prescr_mat_hor c
		where	a.nr_prescricao = b.nr_prescricao
		and	b.nr_prescricao = c.nr_prescricao
		and	b.nr_sequencia = c.nr_seq_material
		and	c.nr_sequencia = nr_seq_horario_p
		and	Obter_se_horario_liberado(c.dt_lib_horario, c.dt_horario) = 'S';

		if (obter_rastreabilidade_adep(nr_seq_processo_p, 'CH') = 'S') then
			CALL adep_gerar_log_rastr('{'||chr(10)||
								'"'||$$plsql_unit||'" : "'||$$plsql_line||'",'||chr(10)||
								'"Ie_Local_Estoque_Prescr_w" : "'||Ie_Local_Estoque_Prescr_w||'",'||chr(10)||
								'"cd_local_estoque_w" : "'||cd_local_estoque_w||'",'||chr(10)||
								'"cd_material_w" : "'||cd_material_w||'",'||chr(10)||
								'"cd_setor_atendimento_w" : "'||cd_setor_atendimento_w||'",'||chr(10)||
								'"cd_um_dose_w" : "'||cd_um_dose_w||'",'||chr(10)||
								'"cd_unidade_medida_dose_w" : "'||cd_unidade_medida_dose_w||'",'||chr(10)||
								'"dt_horario_w" : "'||to_char(dt_horario_w, 'dd/mm/yyyy hh24:mi:ss')||'",'||chr(10)||
								'"dt_prescricao_w" : "'||to_char(dt_prescricao_w, 'dd/mm/yyyy hh24:mi:ss')||'",'||chr(10)||
								'"ie_agrupador_w" : "'||ie_agrupador_w||'",'||chr(10)||
								'"ie_regra_disp_w" : "'||ie_regra_disp_w||'",'||chr(10)||
								'"ie_via_aplicacao_w" : "'||ie_via_aplicacao_w||'",'||chr(10)||
								'"nr_atendimento_w" : "'||nr_atendimento_w||'",'||chr(10)||
								'"nr_prescricao_w" : "'||nr_prescricao_w||'",'||chr(10)||
								'"nr_seq_dialise_w" : "'||nr_seq_dialise_w||'",'||chr(10)||
								'"nr_seq_horario_p" : "'||nr_seq_horario_p||'",'||chr(10)||
								'"nr_seq_lote_ap_w" : "'||nr_seq_lote_ap_w||'",'||chr(10)||
								'"nr_seq_lote_fornec_p" : "'||nr_seq_lote_fornec_p||'",'||chr(10)||
								'"nr_seq_lote_fornec_w" : "'||nr_seq_lote_fornec_w||'",'||chr(10)||
								'"nr_seq_lote_w" : "'||nr_seq_lote_w||'",'||chr(10)||
								'"nr_seq_matmed_w" : "'||nr_seq_matmed_w||'",'||chr(10)||
								'"nr_seq_pe_proc_w" : "'||nr_seq_pe_proc_w||'",'||chr(10)||
								'"nr_seq_processo_w" : "'||nr_seq_processo_w||'",'||chr(10)||
								'"nr_seq_processo_ww" : "'||nr_seq_processo_ww||'",'||chr(10)||
								'"nr_sequencia_proc_w" : "'||nr_sequencia_proc_w||'",'||chr(10)||
								'"qt_dispensar_hor_w" : "'||qt_dispensar_hor_w||'",'||chr(10)||
								'"qt_total_dispensar_w" : "'||qt_total_dispensar_w||'",'||chr(10)||
								'"qt_unitaria_w" : "'||qt_unitaria_w||'"}'
								, wheb_usuario_pck.get_ie_commit);
		end if;

		select 	coalesce(obter_material_estoque(max(a.cd_material)), cd_material_w) cd_material
		into STRICT	cd_material_w
		from	adep_processo_item a
		where	a.nr_seq_horario = nr_seq_horario_p;

		ie_estoque_lote_w	:= obter_se_material_estoque_lote(	cd_material_p	=> cd_material_w,
																cd_estabelecimento_p => cd_estabelecimento_w);
		
		if (ie_estoque_lote_w = 'S' and coalesce(nr_seq_lote_fornec_w::text, '') = '') then
			select	max(a.nr_seq_lote_fornec)
			into STRICT	nr_seq_lote_fornec_w
			from	adep_processo_item	a
			where	a.nr_seq_processo = nr_seq_processo_w
			and		a.cd_material = cd_material_w
			and		coalesce(a.ie_nao_requisitado,'N') = 'N';
		end if;
		
		if (ie_agrupador_w = 5) then
			
			select	max(nr_sequencia)
			into STRICT	nr_seq_proc_pac_w
			from	procedimento_paciente
			where 	nr_prescricao = nr_prescricao_w
			and 	nr_sequencia_prescricao = nr_sequencia_proc_w;
			
		end if;

		if (coalesce(qt_material_p,0)	> 0) then
			qt_dispensar_hor_w	:= qt_material_p;
			
			select	coalesce(max(d.ie_ivc),'N')
			into STRICT	ie_mat_ivc_w
			from	proc_interno d,
				prescr_procedimento c,
				prescr_material b,
				prescr_mat_hor a
			where	a.nr_prescricao = b.nr_prescricao
			and	a.nr_prescricao	= c.nr_prescricao
			and	a.nr_seq_material = b.nr_sequencia
			and	b.nr_sequencia_proc = c.nr_sequencia
			and	c.nr_seq_proc_interno = d.nr_sequencia				
			and	a.nr_sequencia = nr_seq_horario_p;

			if (ie_mat_ivc_w	= 'S') then
				cd_um_dose_w		:= lower(obter_unid_med_usua('ml'));
			else
				cd_um_dose_w		:= cd_unidade_medida_dose_w;
			end if;
			
		end if;
		
		if (coalesce(nr_seq_lote_ap_w,0) > 0) then
			select	coalesce(max(a.cd_material), cd_material_w)
			into STRICT	cd_material_exec_w
			from	material m,
				operacao_estoque e,
				ap_lote b,
				movimento_estoque a
			where	a.cd_material = m.cd_material
			and	a.nr_lote_ap = b.nr_sequencia
			and	a.cd_operacao_estoque = e.cd_operacao_estoque
			and	a.nr_prescricao = nr_prescricao_w
			and	a.nr_lote_ap = nr_seq_lote_ap_w
			and	nr_sequencia_item_docto = nr_seq_matmed_w
			and	e.ie_entrada_saida = 'S'
			and	a.cd_acao = '1'
			and	coalesce(a.nr_movimento_estoque_corresp::text, '') = ''
			and	b.ie_status_lote <> 'G'
			and	not exists (
				SELECT	1
				from	movimento_estoque x
				where	x.nr_prescricao = a.nr_prescricao
				and	x.nr_movimento_estoque_corresp = a.nr_movimento_estoque);
		end if;
		
		if (nr_seq_dialise_w > 0) then
			select	coalesce(max(nr_atendimento),nr_atendimento_w)
			into STRICT	nr_atendimento_w
			from	hd_dialise
			where	nr_sequencia = nr_seq_dialise_w;
		end if;
		
		ie_cobra_assoc_inter_zerado_w := obter_param_usuario(1113, 665, cd_perfil_w, nm_usuario_p, cd_estabelecimento_w, ie_cobra_assoc_inter_zerado_w);
		if		((ie_agrupador_w = 1) and (coalesce(nr_seq_pe_proc_w,0) > 0) and (ie_cobra_assoc_inter_zerado_w = 'S')) then
				qt_dispensar_hor_w := qt_unitaria_w;
		end if;
		
		VarCobrarZerado_w := obter_param_usuario(1113, 407, cd_perfil_w, nm_usuario_p, cd_estabelecimento_w, VarCobrarZerado_w);				

		if (obter_rastreabilidade_adep(nr_seq_processo_p, 'CH') = 'S') then
			CALL adep_gerar_log_rastr('{'||chr(10)||
								'"'||$$plsql_unit||'" : "'||$$plsql_line||'",'||chr(10)||
								'"nr_seq_processo_p" : "'||nr_seq_processo_p||'",'||chr(10)||
								'"cd_classe_material_w" : "'||cd_classe_material_w||'",'||chr(10)||
								'"cd_grupo_material_w" : "'||cd_grupo_material_w||'",'||chr(10)||
								'"cd_material_w" : "'||cd_material_w||'",'||chr(10)||
								'"cd_setor_paciente_w" : "'||cd_setor_paciente_w||'",'||chr(10)||
								'"cd_subgrupo_material_w" : "'||cd_subgrupo_material_w||'",'||chr(10)||
								'"nr_seq_familia_w" : "'||nr_seq_familia_w||'",'||chr(10)||
								'"cd_motivo_baixa_w" : "'||cd_motivo_baixa_w||'",'||chr(10)||
								'"cd_unidade_medida_regra_w" : "'||cd_unidade_medida_regra_w||'",'||chr(10)||
								'"nr_atendimento_w" : "'||nr_atendimento_w||'",'||chr(10)||
								'"ie_gerar_estornar_w" : "'||ie_gerar_estornar_w||'",'||chr(10)||
								'"ie_nao_requisitado_w" : "'||ie_nao_requisitado_w||'",'||chr(10)||
								'"ie_momento_lancamento_w" : "'||ie_momento_lancamento_w||'",'||chr(10)||
								'"nr_prescricao_w" : "'||nr_prescricao_w||'",'||chr(10)||
								'"VarCobrarZerado_w" : "'||VarCobrarZerado_w||'",'||chr(10)||
								'"ie_agrupador_w" : "'||ie_agrupador_w||'",'||chr(10)||
								'"ie_cobra_item_disp_enf_w" : "'||ie_cobra_item_disp_enf_w||'",'||chr(10)||
								'"ie_cobra_sem_lote_w" : "'||ie_cobra_sem_lote_w||'",'||chr(10)||
								'"ie_lancar_item_zerado_w" : "'||ie_lancar_item_zerado_w||'",'||chr(10)||
								'"ie_regra_disp_w" : "'||ie_regra_disp_w||'",'||chr(10)||
								'"nr_seq_lote_ap_w" : "'||nr_seq_lote_ap_w||'",'||chr(10)||
								'"qt_dispensar_hor_w" : "'||qt_dispensar_hor_w||'",'||chr(10)||
								'"qt_unitaria_w" : "'||qt_unitaria_w||'"}'
								, wheb_usuario_pck.get_ie_commit);
		end if;
		
		if	((coalesce(qt_dispensar_hor_w,0) > 0) or
			(ie_agrupador_w = 5 AND VarCobrarZerado_w = 'S') or
			(((ie_lancar_item_zerado_w = 'S') and (ie_agrupador_w in (1,2,3,4,7,9)) and coalesce(qt_unitaria_w,0) > 0)  or
			((ie_lancar_item_zerado_w = 'D') and (ie_regra_disp_w = 'N') and (ie_agrupador_w in (1,2,3,4,7,9,11)) and coalesce(qt_unitaria_w,0) > 0)) or
			((ie_cobra_sem_lote_w = 'S') and (ie_regra_disp_w = 'S') and (coalesce(nr_seq_lote_ap_w::text, '') = '')) or
			(ie_regra_disp_w = 'E' AND ie_cobra_item_disp_enf_w = 'S')) and (ie_regra_disp_w <> 'E' or ie_cobra_item_disp_enf_w = 'S') then

			if (qt_dispensar_hor_w = 0) and (ie_agrupador_w = 5) and (VarCobrarZerado_w = 'S') then
				qt_dispensar_hor_w := qt_unitaria_w;
			elsif ((ie_lancar_item_zerado_w = 'D' AND ie_regra_disp_w = 'N') or (ie_lancar_item_zerado_w = 'S')) and (ie_agrupador_w in (1,2,3,4,7,9,11)) and (coalesce(qt_dispensar_hor_w, 0) = 0) then
				qt_dispensar_hor_w := qt_unitaria_w;
			elsif (coalesce(qt_dispensar_hor_w, 0) = 0) and (ie_regra_disp_w = 'S') and (coalesce(nr_seq_lote_ap_w::text, '') = '') and (ie_cobra_sem_lote_w = 'S') then
				qt_dispensar_hor_w := qt_unitaria_w;
			end if;

			if	((ie_cobra_sem_lote_w = 'S') and (ie_regra_disp_w = 'S') and (coalesce(nr_seq_lote_ap_w::text, '') = '')) then
				ie_item_sem_lote_w	:= 'S';
			end if;
		
			/* obter atepacu */

			if (ie_setor_lancamento_w = 'SA') then
				select	nr_seq_interno,
					cd_setor_atendimento,
					dt_entrada_unidade
				into STRICT	nr_seq_atepacu_w,
					cd_setor_paciente_w,
					dt_entrada_unidade_w
				from	atend_paciente_unidade
				where	nr_atendimento = nr_atendimento_w
				and	nr_seq_interno = obter_atepacu_paciente(nr_atendimento,'A');
				
			elsif (ie_setor_lancamento_w = 'SU') then
			
				select	max(cd_setor_atendimento)
				into STRICT	cd_setor_paciente_w
				from	usuario
				where	nm_usuario = nm_usuario_p;
				
				begin
				select	nr_seq_interno,
					cd_setor_atendimento,
					dt_entrada_unidade
				into STRICT	nr_seq_atepacu_w,
					cd_setor_paciente_w,
					dt_entrada_unidade_w
				from	atend_paciente_unidade
				where	nr_atendimento = nr_atendimento_w
				and	nr_seq_interno = (	SELECT	max(nr_seq_interno)
								from	atend_paciente_unidade
								where	cd_setor_atendimento	=	cd_setor_paciente_w
								and	nr_atendimento				=	nr_atendimento_w );
				exception
				when others then
					nr_seq_atepacu_w := null;
				end;
				
								
				if (coalesce(nr_seq_atepacu_w::text, '') = '') then
					select	nr_seq_interno,
						cd_setor_atendimento,
						dt_entrada_unidade
					into STRICT	nr_seq_atepacu_w,
						cd_setor_paciente_w,
						dt_entrada_unidade_w
					from	atend_paciente_unidade
					where	nr_atendimento = nr_atendimento_w
					and	nr_seq_interno = obter_atepacu_paciente(nr_atendimento,'A');
				end if;
				
			elsif (ie_setor_lancamento_w = 'SP') then
				select	max(cd_setor_atendimento)
				into STRICT	cd_setor_prescricao_w
				from	prescr_medica
				where	nr_prescricao = nr_prescricao_w;
													
				begin
				select	nr_seq_interno,
					cd_setor_atendimento,
					dt_entrada_unidade
				into STRICT	nr_seq_atepacu_w,
					cd_setor_paciente_w,
					dt_entrada_unidade_w
				from	atend_paciente_unidade
				where	nr_atendimento = nr_atendimento_w
				and	nr_seq_interno = (	SELECT	max(nr_seq_interno)
								from	atend_paciente_unidade
								where	cd_setor_atendimento	=	cd_setor_prescricao_w
								and	nr_atendimento		=	nr_atendimento_w );
				exception
				when others then
					nr_seq_atepacu_w := null;
				end;
				
								
				if (coalesce(nr_seq_atepacu_w::text, '') = '') then
					select	nr_seq_interno,
						cd_setor_atendimento,
						dt_entrada_unidade
					into STRICT	nr_seq_atepacu_w,
						cd_setor_paciente_w,
						dt_entrada_unidade_w
					from	atend_paciente_unidade
					where	nr_atendimento = nr_atendimento_w
					and	nr_seq_interno = obter_atepacu_paciente(nr_atendimento,'A');
				end if;
			end if;
			
			/* obter atecaco */

			select	cd_convenio,
				cd_categoria
			into STRICT	cd_convenio_w,
				cd_categoria_w
			from	atend_categoria_convenio
			where	nr_atendimento = nr_atendimento_w
			and	nr_seq_interno = obter_atecaco_atendimento(nr_atendimento);
		
			if (coalesce(nr_atendimento_w,0) > 0) then
				SELECT * FROM obter_convenio_execucao(nr_atendimento_w, clock_timestamp(), cd_convenio_w, cd_categoria_w, nr_doc_convenio_w, ie_tipo_guia_w, cd_senha_w) INTO STRICT cd_convenio_w, cd_categoria_w, nr_doc_convenio_w, ie_tipo_guia_w, cd_senha_w;
			end if;
			
			CALL gravar_log_before_rais(94902,	'2 - gerar_estornar_adep_map '||
												' nr_seq_processo_p='||nr_seq_processo_p||
												' nr_prescricao_w='||nr_prescricao_w||
												' ie_gerar_estornar_p='||ie_gerar_estornar_p||
												' nr_seq_horario_p='||nr_seq_horario_p||
												' nr_seq_matmed_w='||nr_seq_matmed_w||
												' cd_material_w='||cd_material_w||
												' nr_seq_processo_w='||nr_seq_processo_w||
												' '||substr(dbms_utility.format_call_stack,1,1800),nm_usuario_p);

			cd_unidade_medida_regra_w	:= obter_se_mat_regra_adep(nr_atendimento_w,nr_prescricao_w,cd_material_w,cd_setor_paciente_w,'UN');
			cd_motivo_baixa_w			:= (obter_se_mat_regra_adep(nr_atendimento_w,nr_prescricao_w,cd_material_w,cd_setor_paciente_w,'MB'))::numeric;

			if (obter_rastreabilidade_adep(nr_seq_processo_p, 'CH') = 'S') then
				CALL adep_gerar_log_rastr('{'||chr(10)||
									'"'||$$plsql_unit||'" : "'||$$plsql_line||'",'||chr(10)||
									'"nr_seq_processo_p" : "'||nr_seq_processo_p||'",'||chr(10)||
									'"cd_classe_material_w" : "'||cd_classe_material_w||'",'||chr(10)||
									'"cd_grupo_material_w" : "'||cd_grupo_material_w||'",'||chr(10)||
									'"cd_material_w" : "'||cd_material_w||'",'||chr(10)||
									'"cd_setor_paciente_w" : "'||cd_setor_paciente_w||'",'||chr(10)||
									'"cd_subgrupo_material_w" : "'||cd_subgrupo_material_w||'",'||chr(10)||
									'"nr_seq_familia_w" : "'||nr_seq_familia_w||'",'||chr(10)||
									'"cd_motivo_baixa_w" : "'||cd_motivo_baixa_w||'",'||chr(10)||
									'"cd_unidade_medida_regra_w" : "'||cd_unidade_medida_regra_w||'",'||chr(10)||
									'"nr_atendimento_w" : "'||nr_atendimento_w||'",'||chr(10)||
									'"ie_gerar_estornar_w" : "'||ie_gerar_estornar_w||'",'||chr(10)||
									'"ie_nao_requisitado_w" : "'||ie_nao_requisitado_w||'",'||chr(10)||
									'"ie_momento_lancamento_w" : "'||ie_momento_lancamento_w||'",'||chr(10)||
									'"ie_item_sem_lote_w" : "'||ie_item_sem_lote_w||'",'||chr(10)||
									'"nr_prescricao_w" : "'||nr_prescricao_w||'"}'
									, wheb_usuario_pck.get_ie_commit);
			end if;

			if (ie_gerar_estornar_w = 'E') or (ie_nao_requisitado_w = 'S') then
				if (ie_momento_lancamento_w = 'CR') and (ie_momento_p = 'GAP') then
					cd_subgrupo_material_w	:= obter_dados_material(cd_material_w,'CSUB');
					cd_grupo_material_w		:= obter_dados_material(cd_material_w,'CGRU');
					cd_classe_material_w	:= obter_dados_material(cd_material_w,'CCLA');
					nr_seq_familia_w		:= obter_dados_material(cd_material_w,'FA');
					ie_cobrar_w				:= 'S';
					open C03;
					loop
					fetch C03 into	
						ie_cobrar_w;
					EXIT WHEN NOT FOUND; /* apply on C03 */
						begin
						ie_cobrar_w 	    := ie_cobrar_w;
						end;
					end loop;
					close C03;
					ie_registrar_w	:= ie_cobrar_w = 'S';
				else
					ie_registrar_w	:= true;
				end if;
			else
				-- Verificar se cobra item
				ie_registrar_w	:= (coalesce(obter_se_mat_regra_adep(nr_atendimento_w,nr_prescricao_w,cd_material_w,cd_setor_paciente_w,'CB',ie_momento_p),'S') = 'S');
				
				if (ie_registrar_w) then
					ie_registrar_w	:= (coalesce(obter_se_mat_regra_adep(nr_atendimento_w,nr_prescricao_w,cd_material_w,cd_setor_paciente_w,'LM'),'S') = 'S');
				end if;
			end if;
			
			if (cd_unidade_medida_regra_w IS NOT NULL AND cd_unidade_medida_regra_w::text <> '') and (coalesce(qt_material_p,0)	= 0) then
				
				if (cd_um_dose_w <> cd_unidade_medida_regra_w) then
					begin
					
					qt_conversao_w	:= obter_conversao_unid_med(cd_material_w, cd_unidade_medida_regra_w);
					if (qt_conversao_w <> 0) then
						qt_dispensar_hor_w	:= qt_dispensar_hor_w * qt_conversao_w;
						cd_um_dose_w := cd_unidade_medida_regra_w;
					end if;
					
					end;
				end if;				
			end if;

			if (obter_rastreabilidade_adep(nr_seq_processo_p, 'CH') = 'S') then

				if (ie_registrar_w) then
					ie_registrar_log_w:= 'T';
				else
					ie_registrar_log_w:= 'F';
				end if;

				CALL adep_gerar_log_rastr('{'||chr(10)||
									'"'||$$plsql_unit||'" : "'||$$plsql_line||'",'||chr(10)||
									'"nr_seq_processo_p" : "'||nr_seq_processo_p||'",'||chr(10)||
									'"cd_classe_material_w" : "'||cd_classe_material_w||'",'||chr(10)||
									'"cd_grupo_material_w" : "'||cd_grupo_material_w||'",'||chr(10)||
									'"cd_material_w" : "'||cd_material_w||'",'||chr(10)||
									'"cd_setor_paciente_w" : "'||cd_setor_paciente_w||'",'||chr(10)||
									'"cd_subgrupo_material_w" : "'||cd_subgrupo_material_w||'",'||chr(10)||
									'"cd_um_dose_w" : "'||cd_um_dose_w||'",'||chr(10)||
									'"cd_unidade_medida_regra_w" : "'||cd_unidade_medida_regra_w||'",'||chr(10)||
									'"ie_cobrar_w" : "'||ie_cobrar_w||'",'||chr(10)||
									'"ie_gerar_estornar_w" : "'||ie_gerar_estornar_w||'",'||chr(10)||
									'"ie_momento_lancamento_w" : "'||ie_momento_lancamento_w||'",'||chr(10)||
									'"ie_momento_p" : "'||ie_momento_p||'",'||chr(10)||
									'"ie_nao_requisitado_w" : "'||ie_nao_requisitado_w||'",'||chr(10)||
									'"ie_registrar_w" : "'||ie_registrar_log_w||'",'||chr(10)||
									'"nr_atendimento_w" : "'||nr_atendimento_w||'",'||chr(10)||
									'"nr_prescricao_w" : "'||nr_prescricao_w||'",'||chr(10)||
									'"nr_seq_familia_w" : "'||nr_seq_familia_w||'",'||chr(10)||
									'"qt_conversao_w" : "'||qt_conversao_w||'",'||chr(10)||
									'"qt_dispensar_hor_w" : "'||qt_dispensar_hor_w||'",'||chr(10)||
									'"qt_material_p" : "'||qt_material_p||'"}'
									, wheb_usuario_pck.get_ie_commit);
			end if;

			if (ie_registrar_w) then
				--Se o item tiver lote garantir que o mesmo

				--foi gerado no GEDIPA atraves da opcao

				--"Gerar lote item processo" OS 786280
				
				if (coalesce(qt_material_p,0) > 0)then
					qt_material_w := qt_material_p;
				else
					qt_material_w := qt_dispensar_hor_w;
				end if;
				
				while(qt_diferenca_w > 0 or ie_continua = 'S') loop
					begin					
					if (nr_seq_lote_w > 0) then					
						select	max(ie_origem_lote)
						into STRICT	ie_origem_lote_w
						from	ap_lote
						where	nr_sequencia = nr_seq_lote_w;
						
						if (ie_origem_lote_w = 'GLPG') then				
							cd_local_estoque_ww	:= obter_local_prioridade_setor(cd_setor_atendimento_w, cd_estabelecimento_w);					
							if (coalesce(cd_local_estoque_ww,0) > 0) then
								cd_local_estoque_w	:= cd_local_estoque_ww;	
							end if;
						end if;					
					end if;	
					--Fim OS 786280		
					
					if (cd_motivo_baixa_w IS NOT NULL AND cd_motivo_baixa_w::text <> '') and (cd_motivo_baixa_w > 0) and (coalesce(qt_material_w,0)	= 0) then						
						update	prescr_mat_hor
						set	cd_motivo_baixa = cd_motivo_baixa_w
						where	nr_sequencia = nr_seq_horario_p;
						if (coalesce(wheb_usuario_pck.get_ie_commit, 'S') = 'S') then commit; end if;						
					end if;
						
					select	ie_consignado
					into STRICT	ie_mat_consignado_w
					from	material
					where	cd_material = cd_material_w;

					select	coalesce(max(IE_REGRA_SALDO_CONSIG),0)
					into STRICT	nr_seq_regra_w
					from	parametro_estoque
					where	cd_estabelecimento = cd_estabelecimento_w;
										
					if (ie_mat_consignado_w = '2') and (coalesce(cd_cgc_fornecedor_w::text, '') = '') and (nr_seq_regra_w > 0) then
					begin
						saldo_total := Obter_Saldo_Total_Consig(cd_estabelecimento_w, cd_material_w, cd_local_estoque_w, PKG_DATE_UTILS.start_of(clock_timestamp(), 'month', 0),	nr_seq_lote_fornec_w);
						
						if (saldo_total >= qt_material_w)then
						begin
							if (ie_gerar_estornar_p = 'G')then
								SELECT * FROM obter_fornec_consig_ambos(cd_estabelecimento_w, cd_material_w, nr_seq_lote_fornec_w, cd_local_estoque_w, ie_tipo_saldo_w, cd_cgc_fornecedor_w) INTO STRICT ie_tipo_saldo_w, cd_cgc_fornecedor_w;
							end if;
							
							if (ie_tipo_saldo_w = 'N')then
							begin
								qt_estoque_w := obter_saldo_estoque(cd_estabelecimento_w, cd_material_w, cd_local_estoque_w, PKG_DATE_UTILS.start_of(clock_timestamp(), 'month', 0), qt_estoque_w);
							end;
							elsif (ie_tipo_saldo_w = 'C')then
							begin
								select	coalesce(sum(qt_estoque),0)
								into STRICT	qt_estoque_w
								from	fornecedor_mat_consignado
								where	cd_estabelecimento	= cd_estabelecimento_w
								and	cd_local_estoque		= cd_local_estoque_w
								and	cd_fornecedor			= cd_cgc_fornecedor_w
								and	cd_material				= cd_material_w
								and	dt_mesano_referencia	= ESTABLISHMENT_TIMEZONE_UTILS.startOfMonth(clock_timestamp());
							end;
							end if;
													
							if ((ie_tipo_saldo_w = 'N') or (ie_tipo_saldo_w = 'C') and (ie_gerar_estornar_p = 'G'))then
							begin
								if (qt_diferenca_w > 0)then
									qt_material_w := qt_diferenca_w;
								end if;
											
								if (qt_estoque_w >= qt_material_w)then
								begin
									qt_diferenca_w 	:= 0;
									ie_continua 	:= 'N';
									
									if (ie_tipo_saldo_w = 'N')then
										qt_baixado_proprio_w := qt_baixado_proprio_w + qt_material_w;
									else									
										qt_baixado_consignado_w := qt_baixado_consignado_w + qt_material_w;
									end if;																
								end;
								else
								begin								
									qt_diferenca_w 	:= qt_material_w - qt_estoque_w;
									qt_material_w 	:= qt_estoque_w;
									ie_continua 	:= 'S';
									
									if (ie_tipo_saldo_w = 'N')then
										qt_baixado_proprio_w := qt_baixado_proprio_w + qt_material_w;
									else									
										qt_baixado_consignado_w := qt_baixado_consignado_w + qt_material_w;
									end if;															
								end;
								end if;
								qt_dispensar_hor_w := qt_material_w;
							end;
							else
							begin
								qt_diferenca_w 	:= 0;
								ie_continua 	:= 'N';
							end;						
							end if;
						end;
						else
						begin
							qt_diferenca_w 	:= 0;
							ie_continua 	:= 'N';
						end;						
						end if;
					end;
					end if;				
										
					if (coalesce(ie_agrupador_w, 0) in (1, 8)) then
						ie_grupo_w := 'S';
					end if;
					
					if (coalesce(nr_seq_lote_fornec_w::text, '') = '') then
					
						select	max(a.nr_seq_lote_fornec)
						into STRICT	nr_seq_lote_fornec_w
						from	adep_processo_item	a
						where	a.nr_seq_processo = nr_seq_processo_w
						and		a.cd_material = cd_material_w
						and		coalesce(a.ie_nao_requisitado,'N') = 'N';
						
					end if;
					
					
					/* gerar map */

					select	nextval('material_atend_paciente_seq')
					into STRICT	nr_seq_map_w
					;
					
					if (qt_material_w = 0) or (obter_funcao_ativa = 88) then
						CALL gravar_log_tasy(43940,
							substr('GERAR_ESTORNAR_ADEP_MAP LINE 810' || chr(10) ||
							'nr_atendimento_w= ' || nr_atendimento_w || chr(10) ||
							'dt_gerar_estornar_p= ' || PKG_DATE_FORMATERS_TZ.TO_VARCHAR(dt_gerar_estornar_p, 'timestamp', ESTABLISHMENT_TIMEZONE_UTILS.getTimeZone)|| chr(10) ||
							'ie_gerar_estornar_w= ' || ie_gerar_estornar_w || chr(10) ||
							'qt_material_w= ' || qt_material_w || chr(10) ||
							'cd_convenio_w= ' || cd_convenio_w || chr(10) ||
							'nr_prescricao_w= ' || nr_prescricao_w || chr(10) ||
							'nr_seq_horario_p= ' || nr_seq_horario_p || chr(10) ||
							'nr_seq_matmed_w= ' || nr_seq_matmed_w || chr(10) ||
							'cd_material_exec_w= ' || cd_material_exec_w || chr(10) ||
							'cd_material_w= ' || cd_material_w || chr(10) ||
							'nr_seq_lote_ap_w= ' || nr_seq_lote_ap_w || chr(10) ||
							'cd_setor_paciente_w= ' || cd_setor_paciente_w || chr(10) ||
							'nr_seq_processo_w= ' || nr_seq_processo_w || chr(10) ||
							'nr_seq_lote_fornec_w= ' || nr_seq_lote_fornec_w || chr(10) ||
							'qt_estoque_w= ' || qt_estoque_w || chr(10) ||
							'qt_diferenca_w= ' || qt_diferenca_w || chr(10) ||
							'qt_dispensar_hor_w= ' || qt_dispensar_hor_w || chr(10) ||
							'cd_estabelecimento_w= ' || cd_estabelecimento_w || chr(10) ||
							'ie_tipo_saldo_w= ' || ie_tipo_saldo_w || chr(10) ||
							'qt_conversao_w= ' || qt_conversao_w || chr(10) ||
							'ie_momento_p= ' || ie_momento_p || chr(10) ||
							'cd_local_estoque_w= ' || cd_local_estoque_w || chr(10) ||
							'cd_cgc_fornecedor_w= ' || cd_cgc_fornecedor_w || chr(10) ||
							'cd_convenio_w= ' || cd_convenio_w || chr(10) ||
							'cd_categoria_w= ' || cd_categoria_w || chr(10) ||
							'nr_doc_convenio_w= ' || nr_doc_convenio_w || chr(10) ||
							'cd_senha_w= ' || cd_senha_w || chr(10) ||
							'ie_tipo_guia_w= ' || ie_tipo_guia_w || chr(10) ||
							'cd_unidade_medida_regra_w= ' || cd_unidade_medida_regra_w || chr(10) ||
							'ie_continua= ' || ie_continua || chr(10) ||
							'STACK=' || chr(10) ||
							dbms_utility.format_call_stack,1,2000),
							nm_usuario_p);
					end if;

					if (obter_rastreabilidade_adep(nr_seq_processo_p, 'CH') = 'S') then
						CALL adep_gerar_log_rastr('{'||chr(10)||
											'"'||$$plsql_unit||'" : "'||$$plsql_line||'",'||chr(10)||
											'"Ie_Altera_data_w" : "'||Ie_Altera_data_w||'",'||chr(10)||
											'"cd_categoria_w" : "'||cd_categoria_w||'",'||chr(10)||
											'"cd_cgc_fornecedor_w" : "'||cd_cgc_fornecedor_w||'",'||chr(10)||
											'"cd_convenio_w" : "'||cd_convenio_w||'",'||chr(10)||
											'"cd_local_estoque_w" : "'||cd_local_estoque_w||'",'||chr(10)||
											'"cd_material_exec_w" : "'||cd_material_exec_w||'",'||chr(10)||
											'"cd_material_w" : "'||cd_material_w||'",'||chr(10)||
											'"cd_perfil_w" : "'||cd_perfil_w||'",'||chr(10)||
											'"cd_senha_w" : "'||cd_senha_w||'",'||chr(10)||
											'"cd_setor_paciente_w" : "'||cd_setor_paciente_w||'",'||chr(10)||
											'"cd_um_dose_w" : "'||cd_um_dose_w||'",'||chr(10)||
											'"dt_entrada_unidade_w" : "'||to_char(dt_entrada_unidade_w, 'dd/mm/yyyy hh24:mi:ss')||'",'||chr(10)||
											'"dt_gerar_estornar_p" : "'||to_char(dt_gerar_estornar_p, 'dd/mm/yyyy hh24:mi:ss')||'",'||chr(10)||
											'"dt_horario_w" : "'||to_char(dt_horario_w, 'dd/mm/yyyy hh24:mi:ss')||'",'||chr(10)||
											'"dt_prescricao_w" : "'||to_char(dt_prescricao_w, 'dd/mm/yyyy hh24:mi:ss')||'",'||chr(10)||
											'"dt_prescricao_ww" : "'||to_char(dt_prescricao_ww, 'dd/mm/yyyy hh24:mi:ss')||'",'||chr(10)||
											'"ie_gerar_estornar_w" : "'||ie_gerar_estornar_w||'",'||chr(10)||
											'"ie_grupo_w" : "'||ie_grupo_w||'",'||chr(10)||
											'"ie_tipo_guia_w" : "'||ie_tipo_guia_w||'",'||chr(10)||
											'"ie_via_aplicacao_w" : "'||ie_via_aplicacao_w||'",'||chr(10)||
											'"nm_usuario_p" : "'||nm_usuario_p||'",'||chr(10)||
											'"nr_atendimento_w" : "'||nr_atendimento_w||'",'||chr(10)||
											'"nr_doc_convenio_w" : "'||nr_doc_convenio_w||'",'||chr(10)||
											'"nr_prescricao_w" : "'||nr_prescricao_w||'",'||chr(10)||
											'"nr_seq_atepacu_w" : "'||nr_seq_atepacu_w||'",'||chr(10)||
											'"nr_seq_horario_p" : "'||nr_seq_horario_p||'",'||chr(10)||
											'"nr_seq_lote_ap_w" : "'||nr_seq_lote_ap_w||'",'||chr(10)||
											'"nr_seq_lote_fornec_w" : "'||nr_seq_lote_fornec_w||'",'||chr(10)||
											'"nr_seq_map_w" : "'||nr_seq_map_w||'",'||chr(10)||
											'"nr_seq_matmed_w" : "'||nr_seq_matmed_w||'",'||chr(10)||
											'"nr_seq_proc_pac_w" : "'||nr_seq_proc_pac_w||'",'||chr(10)||
											'"nr_seq_processo_w" : "'||nr_seq_processo_w||'",'||chr(10)||
											'"qt_dispensar_hor_w" : "'||qt_dispensar_hor_w||'",'||chr(10)||
											'"qt_material_w" : "'||qt_material_w||'",'||chr(10)||
											'"sysdate" : "'||to_char(clock_timestamp(), 'dd/mm/yyyy hh24:mi:ss')||'"}'
											, wheb_usuario_pck.get_ie_commit);
					end if;

					begin
					insert into material_atend_paciente(
						nr_sequencia,
						nr_atendimento,
						dt_entrada_unidade,
						dt_atendimento,
						cd_unidade_medida,
						qt_material,
						dt_atualizacao,
						nm_usuario,
						cd_convenio,
						cd_categoria,
						dt_prescricao,
						cd_material_prescricao,
						ie_via_aplicacao,
						ds_observacao,
						vl_material,
						cd_tab_preco_material,
						dt_vigencia_tabela,
						dt_acerto_conta,
						dt_acerto_convenio,
						nr_prescricao,
						nr_sequencia_prescricao,
						nr_seq_mat_hor,
						cd_motivo_exc_conta,
						ds_compl_motivo_excon,
						cd_local_estoque,
						dt_atualizacao_estoque,
						cd_acao,
						cd_setor_atendimento,
						qt_devolvida,
						cd_motivo_devolucao,
						nr_cirurgia,
						nr_doc_convenio,
						qt_executada,
						dt_conta,
						vl_unitario,
						cd_proced_referencia,
						cd_conta_contabil,
						qt_ajuste_conta,
						nr_aih,
						ie_valor_informado,
						cd_estabelecimento_custo,
						cd_tabela_custo,
						cd_situacao_glosa,
						nr_lote_contabil,
						cd_material_convenio,
						nr_seq_autorizacao,
						nr_interno_conta,
						nr_seq_proc_princ,
						ie_guia_informada,
						cd_especialidade,
						nm_usuario_original,
						nr_seq_proc_pacote,
						vl_tabela_original,
						ie_emite_conta,
						cd_setor_receita,
						cd_cgc_fornecedor,
						nr_seq_lote_fornec,
						cd_material_exec,
						nr_seq_atepacu,
						ie_tipo_guia,
						nr_doc_interno,
						ie_auditoria,
						nr_seq_grupo_rec,
						cd_motivo_ajuste,
						nr_seq_tipo_baixa,
						nr_seq_cor_exec,
						nr_seq_origem,
						ie_dispersao,
						nr_seq_conta_origem,
						cd_setor_paciente,
						nr_seq_parcial,
						cd_cgc_prestador,
						nr_seq_aih,
						dt_conferencia,
						dt_atualizacao_nrec,
						nm_usuario_nrec,
						nr_seq_ordem_prod,
						nr_receita,
						nr_serie_material,
						ie_origem_preco,
						qt_estoque,
						cd_material,
						nr_seq_regra_lanc,
						nr_seq_tiss_tabela,
						ie_responsavel_credito,
						ie_tiss_tipo_guia_desp,
						ie_tiss_tipo_despesa,
						cd_cgc_prestador_tiss,
						cd_senha,
						ie_estorno_conta,
						cd_material_tiss,
						ds_material_tiss,
						cd_kit_material,
						cd_tab_custo_preco,
						nr_seq_mat_autor,
						tx_material,
						cd_prestador_tiss,
						cd_cgc_prest_solic_tiss,
						nr_seq_lote_ap,
						nr_seq_processo)
					values (
						nr_seq_map_w,
						nr_atendimento_w,
						dt_entrada_unidade_w,
						dt_gerar_estornar_p,--decode(NVL(Ie_Altera_data_w,'N'),'N',dt_gerar_estornar_p,nvl(dt_prescricao_ww,dt_gerar_estornar_p)),
						cd_um_dose_w,
						CASE WHEN ie_gerar_estornar_w='G' THEN  qt_dispensar_hor_w  ELSE qt_dispensar_hor_w * -1 END ,
						clock_timestamp(),
						nm_usuario_p,
						cd_convenio_w,
						cd_categoria_w,
						dt_prescricao_w,
						null,
						ie_via_aplicacao_w,
						substr(wheb_mensagem_pck.get_texto(306351,'NR_SEQ_HORARIO=' || to_char(nr_seq_horario_p) ||
							';DT_HORARIO=' || PKG_DATE_FORMATERS_TZ.TO_VARCHAR(dt_horario_w, 'timestamp', ESTABLISHMENT_TIMEZONE_UTILS.getTimeZone)||
							';CD_PERFIL=' || to_char(cd_perfil_w) ||
							';NM_USUARIO=' || nm_usuario_p ||
							';DT_ATUAL=' || PKG_DATE_FORMATERS_TZ.TO_VARCHAR(clock_timestamp(), 'timestamp', ESTABLISHMENT_TIMEZONE_UTILS.getTimeZone)),1,255),
						null,
						null,
						null,
						null,
						null,
						nr_prescricao_w,
						nr_seq_matmed_w,
						CASE WHEN ie_grupo_w='S' THEN  nr_seq_horario_p  ELSE CASE WHEN coalesce(qt_material_w::text, '') = '' THEN nr_seq_horario_p  ELSE null END  END ,
						null,
						null,
						CASE WHEN ie_item_sem_lote_w='S' THEN  null  ELSE cd_local_estoque_w END ,
						null,
						'1',
						cd_setor_paciente_w,
						null,
						null,
						null,
						nr_doc_convenio_w,
						null,
						CASE WHEN coalesce(Ie_Altera_data_w,'N')='N' THEN dt_gerar_estornar_p  ELSE coalesce(dt_prescricao_ww,dt_gerar_estornar_p) END ,
						null,
						null,
						null,
						null,
						null,
						null,
						null,
						null,
						null,
						null,
						null,
						null,
						null,
						nr_seq_proc_pac_w,
						null,
						null,
						nm_usuario_p,
						null,
						null,
						null,
						null,
						cd_cgc_fornecedor_w,
						nr_seq_lote_fornec_w,
						cd_material_exec_w,
						nr_seq_atepacu_w,
						ie_tipo_guia_w,
						null,
						'N',
						null,
						null,
						null,
						907,
						null,
						null,
						null,
						cd_setor_paciente_w,
						null,
						null,
						null,
						null,
						clock_timestamp(),
						nm_usuario_p,
						null,
						null,
						null,
						null,
						null,
						cd_material_w,
						null,
						null,
						null,
						null,
						null,
						null,
						cd_senha_w,
						null,
						null,
						null,
						null,
						null,
						null,
						null,
						null,
						null,
						nr_seq_lote_ap_w,
						nr_seq_processo_w);
					exception
					when others then
						CALL gravar_log_tasy(3535,substr(sqlerrm,1,2000),nm_usuario_p);
						if (obter_funcao_ativa = 88) then
							CALL wheb_mensagem_pck.exibir_mensagem_abort(substr(sqlerrm,1,2000));
						end if;
					end;
							
					select	max(dt_atualizacao_estoque),
						max(cd_setor_atendimento),
						max(cd_local_estoque),
						max(qt_material)
					into STRICT	dt_atualizacao_estoque_w,
						cd_setor_conta_w,
						cd_local_conta_w,
						qt_material_conta_w
					from	material_atend_paciente
					where	nr_sequencia = nr_seq_map_w;

					if (ie_gerar_estornar_w = 'E') and (ie_momento_lancamento_w = 'CR') and (ie_momento_p = 'GAP') and (dt_atualizacao_estoque_w IS NOT NULL AND dt_atualizacao_estoque_w::text <> '') then
						begin
						CALL gerar_prescricao_estoque(
							cd_estabelecimento_w,
							nr_atendimento_w,
							dt_entrada_unidade_w,
							coalesce(cd_material_exec_w, cd_material_w),
							dt_gerar_estornar_p,
							'1',
							coalesce(cd_local_conta_w,cd_local_estoque_w),
							qt_material_conta_w,
							cd_setor_conta_w,
							cd_um_dose_w,
							nm_usuario_p,
							'I',
							nr_prescricao_w,
							nr_seq_matmed_w,
							null,
							nr_seq_map_w,
							null,
							null,
							nr_seq_lote_fornec_w,
							null,
							null,
							nr_seq_lote_ap_w, 
							'S',
							'',
							'');
						end;
					end if;	
												
					if (varLancaAuto_w	= 'S')	and (ie_gerar_estornar_w <> 'E') then
						begin
							CALL gerar_lanc_automatico_mat(nr_atendimento_w,NULL, 132, nm_usuario_p, nr_seq_map_w,NULL,NULL);
						exception when others then
							null;
						end;
					end if;
					
					if (coalesce(wheb_usuario_pck.get_ie_commit, 'S') = 'S') then
						commit;
					end if;
					
					if (ie_estoque_lote_w = 'N') then
						nr_seq_lote_fornec_w	:= null;
					end if;
					
					if (((qt_diferenca_w > 0) and (qt_material_baixar = (qt_baixado_consignado_w + qt_baixado_proprio_w))) or (qt_diferenca_w = 0) or (ie_continua = 'N') and (ie_mat_consignado_w = '2' AND nr_seq_regra_w > 0))then
					begin
						qt_diferenca_w := 0;
						ie_continua := 'N';
					end;
					elsif ((ie_mat_consignado_w = '2') and (nr_seq_regra_w > 0) and (ie_gerar_estornar_p = 'G'))then
					begin
						cd_cgc_fornecedor_w := null;
						ie_continua := 'S';
						qt_material_w := qt_diferenca_w;
					end;
					else
						ie_continua := 'N';
						qt_diferenca_w := 0;
					end if;
					
					end;					
				end loop;
			end if;
		
			if (coalesce(nr_seq_processo_w,0) > 0) then
				open C02;
				loop
				fetch C02 into	
					nr_seq_item_w;
				EXIT WHEN NOT FOUND; /* apply on C02 */
					begin

					update	adep_processo_item
					set	ie_conta_paciente	= 'S',
						ie_lanc_automatico      = 'S'
					where	nr_sequencia		= nr_seq_item_w;

					end;
				end loop;
				close C02;
			end if;			
			/* obter conta */

			CALL atualiza_preco_material(nr_seq_map_w,nm_usuario_p);				
		end if;
		
		exception when others then
			ds_erro_w	:= ds_erro_w;
			if (obter_funcao_ativa = 88) then
				CALL wheb_mensagem_pck.exibir_mensagem_abort(substr(sqlerrm,1,2000));
			end if;
		end;

	elsif (nr_seq_processo_p IS NOT NULL AND nr_seq_processo_p::text <> '') then		
		ie_prescr_conta_w := obter_param_usuario(3112, 65, cd_perfil_w, nm_usuario_p, cd_estabelecimento_w, ie_prescr_conta_w);
		varLancaAuto_w := obter_param_usuario(1113, 505, cd_perfil_w, nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento, varLancaAuto_w);

		if (obter_rastreabilidade_adep(nr_seq_processo_p, 'CH') = 'S') then
				CALL adep_gerar_log_rastr('{'||chr(10)||
									'"'||$$plsql_unit||'" : "'||$$plsql_line||'",'||chr(10)||
									'"nr_seq_processo_p" : "'||nr_seq_processo_p||'",'||chr(10)||
									'"ie_prescr_conta_w" : "'||ie_prescr_conta_w||'",'||chr(10)||
									'"varLancaAuto_w" : "'||varLancaAuto_w||'",'||chr(10)||
									'"cd_local_estoque_ww" : "'||cd_local_estoque_ww||'",'||chr(10)||
									'"ie_gerar_estornar_p" : "'||ie_gerar_estornar_p||'",'||chr(10)||
									'"ie_gerar_estornar_w" : "'||ie_gerar_estornar_w||'",'||chr(10)||
									'"ie_momento_p" : "'||ie_momento_p||'",'||chr(10)||
									'"ie_nao_req_est_paciente_w" : "'||ie_nao_req_est_paciente_w||'",'||chr(10)||
									'"ie_param_44_pharm_w" : "'||ie_param_44_pharm_w||'",'||chr(10)||
									'"ie_param_88_w" : "'||ie_param_88_w||'",'||chr(10)||
									'"nr_seq_area_prep_p" : "'||nr_seq_area_prep_p||'",'||chr(10)||
									'"nr_seq_processo_p" : "'||nr_seq_processo_p||'"}'
									, wheb_usuario_pck.get_ie_commit);
		end if;

		open c01;
		loop
		fetch c01 into	nr_atendimento_w,
				nr_seq_item_w,
				cd_material_w,
				dt_horario_w,
				qt_dispensar_hor_w,
				cd_um_dose_w,
				nr_seq_processo_w,
				cd_local_estoque_w,
				ie_baixa_estoque_w,
				nr_seq_lote_fornec_w,
				ie_horario_conta_w,
				nr_seq_horario_w,
				ie_nao_requisitado_w,
				nr_lote_producao_w;
		EXIT WHEN NOT FOUND; /* apply on c01 */
			begin
			qt_diferenca_w := 0;
			ie_continua    := 'S';
						
			select	coalesce(max(cd_local_estoque_baixa),0),
				coalesce(max(nr_seq_lote),0),
				max(nr_seq_material),
				max(nr_prescricao)
			into STRICT	cd_local_estoque_baixa_w,
				nr_seq_lote_ap_w,
				nr_seq_matmed_w,
				nr_prescricao_w
			from	prescr_mat_hor
			where	nr_sequencia = nr_seq_horario_w;
			
			
			if (nr_seq_matmed_w IS NOT NULL AND nr_seq_matmed_w::text <> '') and (nr_prescricao_w IS NOT NULL AND nr_prescricao_w::text <> '') then
			--Buscar a via pq ela pode ser usada na regra de lancamento automatico.
				select	ie_via_aplicacao
				into STRICT	ie_via_aplicacao_w
				from	prescr_material
				where	nr_sequencia	= nr_seq_matmed_w
				and	nr_prescricao 	= nr_prescricao_w;	
			
			end if;
			/*
			if	(cd_local_estoque_baixa_w > 0) then
				cd_local_estoque_w := cd_local_estoque_baixa_w;
			end if;
			*/
			if (coalesce(qt_dispensar_hor_w,0)	> 0) or (coalesce(ie_horario_conta_w,'N')	= 'S') then
			
				/* obter atepacu */

				if (ie_setor_lancamento_w = 'SA') then
					select	nr_seq_interno,
						cd_setor_atendimento,
						dt_entrada_unidade
					into STRICT	nr_seq_atepacu_w,
						cd_setor_paciente_w,
						dt_entrada_unidade_w
					from	atend_paciente_unidade
					where	nr_atendimento = nr_atendimento_w
					and	nr_seq_interno = obter_atepacu_paciente(nr_atendimento,'A');
					
					if (ie_prescr_conta_w = 'S') then
						select	max(nr_prescricao),
								max(nr_seq_material)
						into STRICT	nr_prescricao_w,
								nr_seq_matmed_w
						from	prescr_mat_hor
						where	nr_sequencia	= nr_seq_horario_w
						and		Obter_se_horario_liberado(dt_lib_horario, dt_horario) = 'S';						
					end if;
				
				elsif (ie_setor_lancamento_w = 'SU') then
			
					select	max(cd_setor_atendimento)
					into STRICT	cd_setor_paciente_w
					from	usuario
					where	nm_usuario = nm_usuario_p;
					
					begin
					select	nr_seq_interno,
						cd_setor_atendimento,
						dt_entrada_unidade
					into STRICT	nr_seq_atepacu_w,
						cd_setor_paciente_w,
						dt_entrada_unidade_w
					from	atend_paciente_unidade
					where	nr_atendimento = nr_atendimento_w
					and	nr_seq_interno = (	SELECT	max(nr_seq_interno)
									from	atend_paciente_unidade
									where	cd_setor_atendimento	=	cd_setor_paciente_w
									and	nr_atendimento		=	nr_atendimento_w );
					exception
					when others then
						nr_seq_atepacu_w := null;
					end;
					
									
					if (coalesce(nr_seq_atepacu_w::text, '') = '') then
						select	nr_seq_interno,
							cd_setor_atendimento,
							dt_entrada_unidade
						into STRICT	nr_seq_atepacu_w,
							cd_setor_paciente_w,
							dt_entrada_unidade_w
						from	atend_paciente_unidade
						where	nr_atendimento = nr_atendimento_w
						and	nr_seq_interno = obter_atepacu_paciente(nr_atendimento,'A');
					end if;
					
				elsif (ie_setor_lancamento_w = 'SP') then
				
					if (nr_seq_horario_w IS NOT NULL AND nr_seq_horario_w::text <> '') and (coalesce(cd_setor_prescricao_ww::text, '') = '') then
						select	max(nr_prescricao)
						into STRICT	nr_prescricao_w
						from	prescr_mat_hor
						where	nr_sequencia	= nr_seq_horario_w
						and	Obter_se_horario_liberado(dt_lib_horario, dt_horario) = 'S';						
					
						select	max(cd_setor_atendimento)
						into STRICT	cd_setor_prescricao_ww
						from	prescr_medica
						where	nr_prescricao = nr_prescricao_w;
					end if;
			
					select	max(nr_prescricao)
					into STRICT	nr_prescricao_w
					from	prescr_mat_hor
					where	nr_sequencia	= nr_seq_horario_w
					and	Obter_se_horario_liberado(dt_lib_horario, dt_horario) = 'S';						
					
					select	max(cd_setor_atendimento)
					into STRICT	cd_setor_prescricao_w
					from	prescr_medica
					where	nr_prescricao = nr_prescricao_w;
					
					if (coalesce(cd_setor_prescricao_w::text, '') = '') and (cd_setor_prescricao_ww IS NOT NULL AND cd_setor_prescricao_ww::text <> '') then
						cd_setor_prescricao_w:= cd_setor_prescricao_ww;
					end if;
																
					begin
					select	nr_seq_interno,
						cd_setor_atendimento,
						dt_entrada_unidade
					into STRICT	nr_seq_atepacu_w,
						cd_setor_paciente_w,
						dt_entrada_unidade_w
					from	atend_paciente_unidade
					where	nr_atendimento = nr_atendimento_w
					and	nr_seq_interno = (	SELECT	max(nr_seq_interno)
									from	atend_paciente_unidade
									where	cd_setor_atendimento	=	cd_setor_prescricao_w
									and	nr_atendimento		=	nr_atendimento_w );
					exception
					when others then
						nr_seq_atepacu_w := null;
					end;
																			
					if (coalesce(nr_seq_atepacu_w::text, '') = '') then
						select	nr_seq_interno,
							cd_setor_atendimento,
							dt_entrada_unidade
						into STRICT	nr_seq_atepacu_w,
							cd_setor_paciente_w,
							dt_entrada_unidade_w
						from	atend_paciente_unidade
						where	nr_atendimento = nr_atendimento_w
						and	nr_seq_interno = obter_atepacu_paciente(nr_atendimento,'A');
					end if;
				end if;
			
				/* obter atecaco */

				select	max(cd_convenio),
					max(cd_categoria)
				into STRICT	cd_convenio_w,
					cd_categoria_w
				from	atend_categoria_convenio
				where	nr_atendimento = nr_atendimento_w
				and	nr_seq_interno = obter_atecaco_atendimento(nr_atendimento);
				
				if (coalesce(nr_seq_horario_w,0) 	> 0) and (coalesce(ie_horario_conta_w,'N')	= 'S') and (coalesce(qt_dispensar_hor_w,0) 	= 0) then
					select	ceil(dividir(qt_dispensar, nr_ocorrencia))
					into STRICT	qt_dispensar_hor_w
					from	prescr_mat_hor
					where	nr_sequencia	= nr_seq_horario_w
					and	Obter_se_horario_liberado(dt_lib_horario, dt_horario) = 'S';
				end if;
				
				cd_mat_regra_w := cd_material_w;
									
				/* gerar map */
					
				if (coalesce(ie_nao_requisitado_w,'N') <> 'S') and (coalesce(nr_seq_horario_w,0) > 0) then
					
					select	coalesce(max(nr_seq_material),0),
						coalesce(max(nr_prescricao),0)						
					into STRICT	nr_seq_material_w,
						nr_prescricao_w						
					from	prescr_mat_hor
					where	nr_sequencia = nr_seq_horario_w;
					
					if (nr_prescricao_w > 0) and (nr_seq_material_w > 0) then
						
						select	coalesce(max(nr_seq_kit),0),
							coalesce(max(nr_sequencia_diluicao),0),
							max(ie_via_aplicacao)
						into STRICT	nr_seq_kit_w,
							nr_seq_diluicao_w,
							ie_via_aplicacao_w
						from	prescr_material
						where	nr_prescricao = nr_prescricao_w
						and	nr_sequencia  = nr_seq_material_w;
						
						if (nr_seq_kit_w > 0) then
							select	max(cd_material)
							into STRICT	cd_mat_regra_w
							from	prescr_material
							where	nr_prescricao = nr_prescricao_w
							and	nr_sequencia = nr_seq_kit_w;
						elsif (nr_seq_diluicao_w > 0) then
							select	max(cd_material)
							into STRICT	cd_mat_regra_w
							from	prescr_material
							where	nr_prescricao = nr_prescricao_w
							and	nr_sequencia = nr_seq_diluicao_w;
						end if;
						
					end if;
					
				end if;
				
				if (coalesce(nr_seq_lote_ap_w,0) > 0) then
					select	max(a.cd_material)
					into STRICT	cd_material_exec_w
					from	material m,
						operacao_estoque e,
						ap_lote b,
						movimento_estoque a
					where	a.cd_material = m.cd_material
					and	a.nr_lote_ap = b.nr_sequencia
					and	a.cd_operacao_estoque = e.cd_operacao_estoque
					and	a.nr_prescricao = nr_prescricao_w
					and	a.nr_lote_ap = nr_seq_lote_ap_w
					and	nr_sequencia_item_docto = nr_seq_matmed_w
					and	e.ie_entrada_saida = 'S'
					and	a.cd_acao = '1'
					and	coalesce(a.nr_movimento_estoque_corresp::text, '') = ''
					and	b.ie_status_lote <> 'G'
					and	not exists (
						SELECT	1
						from	movimento_estoque x
						where	x.nr_prescricao = a.nr_prescricao
						and	x.nr_movimento_estoque_corresp = a.nr_movimento_estoque);
				end if;
				
				CALL gravar_log_before_rais(94902,	'3 - gerar_estornar_adep_map '||
													' nr_seq_processo_p='||nr_seq_processo_p||
													' nr_prescricao_w='||nr_prescricao_w||
													' ie_gerar_estornar_p='||ie_gerar_estornar_p||
													' nr_seq_horario_p='||nr_seq_horario_p||
													' nr_seq_matmed_w='||nr_seq_matmed_w||
													' cd_material_w='||cd_material_w||
													' nr_seq_processo_w='||nr_seq_processo_w||
													' nr_seq_item_w='||nr_seq_item_w||
													' '||substr(dbms_utility.format_call_stack,1,1800),nm_usuario_p);
								
				cd_unidade_medida_regra_w	:= obter_se_mat_regra_adep(nr_atendimento_w,nr_prescricao_w,cd_mat_regra_w,cd_setor_paciente_w,'UN');

				if (obter_rastreabilidade_adep(nr_seq_processo_p, 'CH') = 'S') then
					CALL adep_gerar_log_rastr('{'||chr(10)||
										'"'||$$plsql_unit||'" : "'||$$plsql_line||'",'||chr(10)||
										'"nr_seq_processo_p" : "'||nr_seq_processo_p||'",'||chr(10)||
										'"cd_classe_material_w" : "'||cd_classe_material_w||'",'||chr(10)||
										'"cd_grupo_material_w" : "'||cd_grupo_material_w||'",'||chr(10)||
										'"cd_material_w" : "'||cd_material_w||'",'||chr(10)||
										'"cd_setor_paciente_w" : "'||cd_setor_paciente_w||'",'||chr(10)||
										'"cd_subgrupo_material_w" : "'||cd_subgrupo_material_w||'",'||chr(10)||
										'"nr_seq_familia_w" : "'||nr_seq_familia_w||'",'||chr(10)||
										'"cd_motivo_baixa_w" : "'||cd_motivo_baixa_w||'",'||chr(10)||
										'"cd_unidade_medida_regra_w" : "'||cd_unidade_medida_regra_w||'",'||chr(10)||
										'"nr_atendimento_w" : "'||nr_atendimento_w||'",'||chr(10)||
										'"ie_gerar_estornar_w" : "'||ie_gerar_estornar_w||'",'||chr(10)||
										'"ie_nao_requisitado_w" : "'||ie_nao_requisitado_w||'",'||chr(10)||
										'"ie_momento_lancamento_w" : "'||ie_momento_lancamento_w||'",'||chr(10)||
										'"nr_prescricao_w" : "'||nr_prescricao_w||'"}'
										, wheb_usuario_pck.get_ie_commit);
				end if;

				if (ie_gerar_estornar_w = 'E') or (ie_nao_requisitado_w = 'S') then
					if (ie_momento_lancamento_w = 'CR') and (ie_momento_p = 'GAP') then
						cd_subgrupo_material_w	:= obter_dados_material(cd_material_w,'CSUB');
						cd_grupo_material_w		:= obter_dados_material(cd_material_w,'CGRU');
						cd_classe_material_w	:= obter_dados_material(cd_material_w,'CCLA');
						nr_seq_familia_w		:= obter_dados_material(cd_material_w,'FA');
						ie_cobrar_w				:= 'S';
						open C03;
						loop
						fetch C03 into	
							ie_cobrar_w;
						EXIT WHEN NOT FOUND; /* apply on C03 */
							begin
							ie_cobrar_w 	    := ie_cobrar_w;
							end;
						end loop;
						close C03;
						ie_registrar_w	:= ie_cobrar_w = 'S';
					else
						ie_registrar_w	:= true;
					end if;
				else
					-- Verificar se cobra item
					ie_registrar_w	:= (coalesce(obter_se_mat_regra_adep(nr_atendimento_w,nr_prescricao_w,cd_mat_regra_w,cd_setor_paciente_w,'CB',ie_momento_p),'S') = 'S');
					
					if (ie_registrar_w) then
						ie_registrar_w		:= (coalesce(obter_se_mat_regra_adep(nr_atendimento_w,nr_prescricao_w,cd_mat_regra_w,cd_setor_paciente_w,'LM'),'S') = 'S');
					end if;
				end if;
				
				if (cd_unidade_medida_regra_w IS NOT NULL AND cd_unidade_medida_regra_w::text <> '') and (coalesce(nr_seq_kit_w, 0) = 0) and (coalesce(nr_seq_diluicao_w, 0) = 0) then
					if (cd_um_dose_w <> cd_unidade_medida_regra_w) then
						begin
					
						qt_conversao_w	:= obter_conversao_unid_med(cd_material_w, cd_unidade_medida_regra_w);
						if (qt_conversao_w <> 0) then
							qt_dispensar_hor_w	:= qt_dispensar_hor_w * qt_conversao_w;
							cd_um_dose_w := cd_unidade_medida_regra_w;
						end if;
					
						end;
					end if;
				end if;

				if (obter_rastreabilidade_adep(nr_seq_processo_p, 'CH') = 'S') then

					if (ie_registrar_w) then
						ie_registrar_log_w:= 'T';
					else
						ie_registrar_log_w:= 'F';
					end if;

					CALL adep_gerar_log_rastr('{'||chr(10)||
										'"'||$$plsql_unit||'" : "'||$$plsql_line||'",'||chr(10)||
										'"nr_seq_processo_p" : "'||nr_seq_processo_p||'",'||chr(10)||
										'"cd_classe_material_w" : "'||cd_classe_material_w||'",'||chr(10)||
										'"cd_grupo_material_w" : "'||cd_grupo_material_w||'",'||chr(10)||
										'"cd_material_w" : "'||cd_material_w||'",'||chr(10)||
										'"cd_setor_paciente_w" : "'||cd_setor_paciente_w||'",'||chr(10)||
										'"cd_subgrupo_material_w" : "'||cd_subgrupo_material_w||'",'||chr(10)||
										'"cd_um_dose_w" : "'||cd_um_dose_w||'",'||chr(10)||
										'"cd_unidade_medida_regra_w" : "'||cd_unidade_medida_regra_w||'",'||chr(10)||
										'"ie_cobrar_w" : "'||ie_cobrar_w||'",'||chr(10)||
										'"ie_gerar_estornar_w" : "'||ie_gerar_estornar_w||'",'||chr(10)||
										'"ie_momento_lancamento_w" : "'||ie_momento_lancamento_w||'",'||chr(10)||
										'"ie_momento_p" : "'||ie_momento_p||'",'||chr(10)||
										'"ie_nao_requisitado_w" : "'||ie_nao_requisitado_w||'",'||chr(10)||
										'"ie_registrar_w" : "'||ie_registrar_log_w||'",'||chr(10)||
										'"nr_atendimento_w" : "'||nr_atendimento_w||'",'||chr(10)||
										'"nr_prescricao_w" : "'||nr_prescricao_w||'",'||chr(10)||
										'"nr_seq_familia_w" : "'||nr_seq_familia_w||'",'||chr(10)||
										'"qt_conversao_w" : "'||qt_conversao_w||'",'||chr(10)||
										'"qt_dispensar_hor_w" : "'||qt_dispensar_hor_w||'",'||chr(10)||
										'"qt_material_p" : "'||qt_material_p||'"}'
										, wheb_usuario_pck.get_ie_commit);
				end if;

				if (ie_registrar_w) then					
					qt_material_w := qt_dispensar_hor_w;
					
					while(qt_diferenca_w > 0 or ie_continua = 'S') loop 
						begin
						if (coalesce(nr_atendimento_w,0) > 0) then
							SELECT * FROM obter_convenio_execucao(nr_atendimento_w, clock_timestamp(), cd_convenio_w, cd_categoria_w, nr_doc_convenio_w, ie_tipo_guia_w, cd_senha_w) INTO STRICT cd_convenio_w, cd_categoria_w, nr_doc_convenio_w, ie_tipo_guia_w, cd_senha_w;
						end if;				

						select	ie_consignado
						into STRICT	ie_mat_consignado_w
						from	material
						where	cd_material = cd_material_w;

						select	coalesce(max(IE_REGRA_SALDO_CONSIG),0)
						into STRICT	nr_seq_regra_w
						from	parametro_estoque
						where	cd_estabelecimento = cd_estabelecimento_w;
						
						if (ie_mat_consignado_w = '2') and (coalesce(cd_cgc_fornecedor_w::text, '') = '') and (nr_seq_regra_w > 0) then
							begin
							SELECT * FROM obter_fornec_consig_ambos(cd_estabelecimento_w, cd_material_w, nr_seq_lote_fornec_w, cd_local_estoque_w, ie_tipo_saldo_w, cd_cgc_fornecedor_w) INTO STRICT ie_tipo_saldo_w, cd_cgc_fornecedor_w;
							
							if (ie_tipo_saldo_w = 'N')then
							begin
								qt_estoque_w := obter_saldo_estoque(cd_estabelecimento_w, cd_material_w, cd_local_estoque_w, PKG_DATE_UTILS.start_of(clock_timestamp(), 'month', 0), qt_estoque_w);
							end;
							elsif (ie_tipo_saldo_w = 'C')then
							begin
								select	coalesce(sum(qt_estoque),0)
								into STRICT	qt_estoque_w
								from	fornecedor_mat_consignado
								where	cd_estabelecimento	= cd_estabelecimento_w
								and	cd_local_estoque		= cd_local_estoque_w
								and	cd_fornecedor			= cd_cgc_fornecedor_w
								and	cd_material				= cd_material_w
								and	dt_mesano_referencia	= ESTABLISHMENT_TIMEZONE_UTILS.startOfMonth(clock_timestamp());									
							end;
							end if;
							
							if ((ie_tipo_saldo_w = 'N') or (ie_tipo_saldo_w = 'C'))then
							begin
								if (qt_diferenca_w > 0)then
									qt_material_w := qt_diferenca_w;
								end if;
											
								if (qt_estoque_w >= qt_material_w)then
								begin
									qt_diferenca_w 	:= 0;
									ie_continua 	:= 'N';
									
									if (ie_tipo_saldo_w = 'N')then
										qt_baixado_proprio_w := qt_baixado_proprio_w + qt_material_w;
									else									
										qt_baixado_consignado_w := qt_baixado_consignado_w + qt_material_w;
									end if;
								end;
								else
								begin
									qt_diferenca_w 	:= qt_material_w - qt_estoque_w;
									qt_material_w 	:= qt_estoque_w;
									ie_continua 	:= 'S';
									
									if (ie_tipo_saldo_w = 'N')then
										qt_baixado_proprio_w := qt_baixado_proprio_w + qt_material_w;
									else									
										qt_baixado_consignado_w := qt_baixado_consignado_w + qt_material_w;
									end if;
								end;
								end if;
							end;
							else
							begin
								qt_diferenca_w 	:= 0;
								ie_continua 	:= 'N';
							end;
							end if;
							end;
						else
							begin
							qt_diferenca_w 	:= 0;
							ie_continua 	:= 'N';
							end;
						end if;
						
						select	nextval('material_atend_paciente_seq')
						into STRICT	nr_seq_map_w
						;
						
						if (qt_material_w = 0) or (obter_funcao_ativa = 88) then
							CALL gravar_log_tasy(43940,
								substr('GERAR_ESTORNAR_ADEP_MAP LINE 1576' || chr(10) ||
								'nr_atendimento_w= ' || nr_atendimento_w || chr(10) ||
								'dt_gerar_estornar_p= ' || PKG_DATE_FORMATERS_TZ.TO_VARCHAR(dt_gerar_estornar_p, 'timestamp', ESTABLISHMENT_TIMEZONE_UTILS.getTimeZone)|| chr(10) ||
								'ie_gerar_estornar_w= ' || ie_gerar_estornar_w || chr(10) ||
								'qt_material_w= ' || qt_material_w || chr(10) ||
								'cd_convenio_w= ' || cd_convenio_w || chr(10) ||
								'nr_prescricao_w= ' || nr_prescricao_w || chr(10) ||
								'nr_seq_horario_p= ' || nr_seq_horario_p || chr(10) ||
								'nr_seq_matmed_w= ' || nr_seq_matmed_w || chr(10) ||
								'cd_material_exec_w= ' || cd_material_exec_w || chr(10) ||
								'cd_material_w= ' || cd_material_w || chr(10) ||
								'nr_seq_lote_ap_w= ' || nr_seq_lote_ap_w || chr(10) ||
								'cd_setor_paciente_w= ' || cd_setor_paciente_w || chr(10) ||
								'nr_seq_processo_w= ' || nr_seq_processo_w || chr(10) ||
								'nr_seq_lote_fornec_w= ' || nr_seq_lote_fornec_w || chr(10) ||
								'qt_estoque_w= ' || qt_estoque_w || chr(10) ||
								'qt_diferenca_w= ' || qt_diferenca_w || chr(10) ||
								'qt_dispensar_hor_w= ' || qt_dispensar_hor_w || chr(10) ||
								'cd_estabelecimento_w= ' || cd_estabelecimento_w || chr(10) ||
								'ie_tipo_saldo_w= ' || ie_tipo_saldo_w || chr(10) ||
								'qt_conversao_w= ' || qt_conversao_w || chr(10) ||
								'ie_momento_p= ' || ie_momento_p || chr(10) ||
								'cd_local_estoque_w= ' || cd_local_estoque_w || chr(10) ||
								'cd_cgc_fornecedor_w= ' || cd_cgc_fornecedor_w || chr(10) ||
								'cd_convenio_w= ' || cd_convenio_w || chr(10) ||
								'cd_categoria_w= ' || cd_categoria_w || chr(10) ||
								'nr_doc_convenio_w= ' || nr_doc_convenio_w || chr(10) ||
								'cd_senha_w= ' || cd_senha_w || chr(10) ||
								'ie_tipo_guia_w= ' || ie_tipo_guia_w || chr(10) ||
								'cd_unidade_medida_regra_w= ' || cd_unidade_medida_regra_w || chr(10) ||
								'ie_continua= ' || ie_continua || chr(10) ||
								'STACK=' || chr(10) ||
								dbms_utility.format_call_stack,1,2000),
								nm_usuario_p);
						end if;

						if (obter_rastreabilidade_adep(nr_seq_processo_p, 'CH') = 'S') then
							CALL adep_gerar_log_rastr('{'||chr(10)||
												'"'||$$plsql_unit||'" : "'||$$plsql_line||'",'||chr(10)||
												'"Ie_Altera_data_w" : "'||Ie_Altera_data_w||'",'||chr(10)||
												'"cd_categoria_w" : "'||cd_categoria_w||'",'||chr(10)||
												'"cd_cgc_fornecedor_w" : "'||cd_cgc_fornecedor_w||'",'||chr(10)||
												'"cd_convenio_w" : "'||cd_convenio_w||'",'||chr(10)||
												'"cd_local_estoque_w" : "'||cd_local_estoque_w||'",'||chr(10)||
												'"cd_material_exec_w" : "'||cd_material_exec_w||'",'||chr(10)||
												'"cd_material_w" : "'||cd_material_w||'",'||chr(10)||
												'"cd_perfil_w" : "'||cd_perfil_w||'",'||chr(10)||
												'"cd_senha_w" : "'||cd_senha_w||'",'||chr(10)||
												'"cd_setor_paciente_w" : "'||cd_setor_paciente_w||'",'||chr(10)||
												'"cd_um_dose_w" : "'||cd_um_dose_w||'",'||chr(10)||
												'"dt_entrada_unidade_w" : "'||to_char(dt_entrada_unidade_w, 'dd/mm/yyyy hh24:mi:ss')||'",'||chr(10)||
												'"dt_gerar_estornar_p" : "'||to_char(dt_gerar_estornar_p, 'dd/mm/yyyy hh24:mi:ss')||'",'||chr(10)||
												'"dt_horario_w" : "'||to_char(dt_horario_w, 'dd/mm/yyyy hh24:mi:ss')||'",'||chr(10)||
												'"dt_prescricao_w" : "'||to_char(dt_prescricao_w, 'dd/mm/yyyy hh24:mi:ss')||'",'||chr(10)||
												'"dt_prescricao_ww" : "'||to_char(dt_prescricao_ww, 'dd/mm/yyyy hh24:mi:ss')||'",'||chr(10)||
												'"ie_baixa_estoque_w" : "'||ie_baixa_estoque_w||'",'||chr(10)||
												'"ie_gerar_estornar_w" : "'||ie_gerar_estornar_w||'",'||chr(10)||
												'"ie_tipo_guia_w" : "'||ie_tipo_guia_w||'",'||chr(10)||
												'"ie_via_aplicacao_w" : "'||ie_via_aplicacao_w||'",'||chr(10)||
												'"nm_usuario_p" : "'||nm_usuario_p||'",'||chr(10)||
												'"nr_atendimento_w" : "'||nr_atendimento_w||'",'||chr(10)||
												'"nr_doc_convenio_w" : "'||nr_doc_convenio_w||'",'||chr(10)||
												'"nr_prescricao_w" : "'||nr_prescricao_w||'",'||chr(10)||
												'"nr_seq_area_prep_p" : "'||nr_seq_area_prep_p||'",'||chr(10)||
												'"nr_seq_atepacu_w" : "'||nr_seq_atepacu_w||'",'||chr(10)||
												'"nr_seq_horario_p" : "'||nr_seq_horario_p||'",'||chr(10)||
												'"nr_seq_lote_ap_w" : "'||nr_seq_lote_ap_w||'",'||chr(10)||
												'"nr_seq_lote_fornec_w" : "'||nr_seq_lote_fornec_w||'",'||chr(10)||
												'"nr_seq_map_w" : "'||nr_seq_map_w||'",'||chr(10)||
												'"nr_seq_matmed_w" : "'||nr_seq_matmed_w||'",'||chr(10)||
												'"nr_seq_processo_p" : "'||nr_seq_processo_p||'",'||chr(10)||
												'"nr_seq_processo_w" : "'||nr_seq_processo_w||'",'||chr(10)||
												'"qt_material_w" : "'||qt_material_w||'",'||chr(10)||
												'"sysdate" : "'||to_char(clock_timestamp(), 'dd/mm/yyyy hh24:mi:ss')||'"}'
												, wheb_usuario_pck.get_ie_commit);
						end if;

						begin
						insert into material_atend_paciente(
							nr_sequencia,
							nr_atendimento,
							dt_entrada_unidade,
							dt_atendimento,
							cd_unidade_medida,
							qt_material,
							dt_atualizacao,
							nm_usuario,
							cd_convenio,
							cd_categoria,
							dt_prescricao,
							cd_material_prescricao,
							ie_via_aplicacao,
							ds_observacao,
							vl_material,
							cd_tab_preco_material,
							dt_vigencia_tabela,
							dt_acerto_conta,
							dt_acerto_convenio,
							nr_prescricao,
							nr_sequencia_prescricao,
							nr_seq_mat_hor,
							cd_motivo_exc_conta,
							ds_compl_motivo_excon,
							cd_local_estoque,
							dt_atualizacao_estoque,
							cd_acao,
							cd_setor_atendimento,
							qt_devolvida,
							cd_motivo_devolucao,
							nr_cirurgia,
							nr_doc_convenio,
							qt_executada,
							dt_conta,
							vl_unitario,
							cd_proced_referencia,
							cd_conta_contabil,
							qt_ajuste_conta,
							nr_aih,
							ie_valor_informado,
							cd_estabelecimento_custo,
							cd_tabela_custo,
							cd_situacao_glosa,
							nr_lote_contabil,
							cd_material_convenio,
							nr_seq_autorizacao,
							nr_interno_conta,
							nr_seq_proc_princ,
							ie_guia_informada,
							cd_especialidade,
							nm_usuario_original,
							nr_seq_proc_pacote,
							vl_tabela_original,
							ie_emite_conta,
							cd_setor_receita,
							cd_cgc_fornecedor,
							nr_seq_lote_fornec,
							cd_material_exec,
							nr_seq_atepacu,
							ie_tipo_guia,
							nr_doc_interno,
							ie_auditoria,
							nr_seq_grupo_rec,
							cd_motivo_ajuste,
							nr_seq_tipo_baixa,
							nr_seq_cor_exec,
							nr_seq_origem,
							ie_dispersao,
							nr_seq_conta_origem,
							cd_setor_paciente,
							nr_seq_parcial,
							cd_cgc_prestador,
							nr_seq_aih,
							dt_conferencia,
							dt_atualizacao_nrec,
							nm_usuario_nrec,
							nr_seq_ordem_prod,
							nr_receita,
							nr_serie_material,
							ie_origem_preco,
							qt_estoque,
							cd_material,
							nr_seq_regra_lanc,
							nr_seq_tiss_tabela,
							ie_responsavel_credito,
							ie_tiss_tipo_guia_desp,
							ie_tiss_tipo_despesa,
							cd_cgc_prestador_tiss,
							cd_senha,
							ie_estorno_conta,
							cd_material_tiss,
							ds_material_tiss,
							cd_kit_material,
							cd_tab_custo_preco,
							nr_seq_mat_autor,
							tx_material,
							cd_prestador_tiss,
							cd_cgc_prest_solic_tiss,
							nr_seq_lote_ap,
							nr_seq_processo)
						values (
							nr_seq_map_w,
							nr_atendimento_w,
							dt_entrada_unidade_w,
							dt_gerar_estornar_p,--decode(NVL(Ie_Altera_data_w,'N'),'N',dt_gerar_estornar_p,nvl(dt_prescricao_ww,dt_gerar_estornar_p)),
							cd_um_dose_w,
							CASE WHEN ie_gerar_estornar_w='G' THEN  qt_material_w  ELSE qt_material_w * -1 END ,
							clock_timestamp(),
							nm_usuario_p,
							cd_convenio_w,
							cd_categoria_w,
							dt_prescricao_w,
							null,
							ie_via_aplicacao_w,
							substr(wheb_mensagem_pck.get_texto(306360,'NR_SEQ_PROCESSO=' || to_char(nr_seq_processo_p) ||
								';DT_HORARIO=' || PKG_DATE_FORMATERS_TZ.TO_VARCHAR(dt_horario_w, 'timestamp', ESTABLISHMENT_TIMEZONE_UTILS.getTimeZone)||
								';NR_SEQ_AREA_PREP=' || to_char(nr_seq_area_prep_p) ||
								';CD_PERFIL=' || to_char(cd_perfil_w) || ';NM_USUARIO=' || nm_usuario_p ||
								';DT_ATUAL=' || PKG_DATE_FORMATERS_TZ.TO_VARCHAR(clock_timestamp(), 'timestamp', ESTABLISHMENT_TIMEZONE_UTILS.getTimeZone)),1,255),
							null,
							null,
							null,
							null,
							null,
							nr_prescricao_w,
							CASE WHEN nr_seq_matmed_w=0 THEN null  ELSE nr_seq_matmed_w END ,
							nr_seq_horario_p,
							null,
							null,
							CASE WHEN ie_baixa_estoque_w='N' THEN  null  ELSE cd_local_estoque_w END ,
							null,
							'1',
							cd_setor_paciente_w,
							null,
							null,
							null,
							nr_doc_convenio_w,
							null,
							CASE WHEN coalesce(Ie_Altera_data_w,'N')='N' THEN dt_gerar_estornar_p  ELSE coalesce(dt_prescricao_ww,dt_gerar_estornar_p) END ,
							null,
							null,
							null,
							null,
							null,
							null,
							null,
							null,
							null,
							null,
							null,
							null,
							null,
							null,
							null,
							null,
							nm_usuario_p,
							null,
							null,
							null,
							null,
							cd_cgc_fornecedor_w,
							nr_seq_lote_fornec_w, --null,
							cd_material_exec_w,
							nr_seq_atepacu_w,
							ie_tipo_guia_w,
							null,
							'N',
							null,
							null,
							null,
							907,
							null,
							null,
							null,
							cd_setor_paciente_w,
							null,
							null,
							null,
							null,
							clock_timestamp(),
							nm_usuario_p,
							null,
							null,
							null,
							null,
							null,
							cd_material_w,
							null,
							null,
							null,
							null,
							null,
							null,
							cd_senha_w,
							null,
							null,
							null,
							null,
							null,
							null,
							null,
							null,
							null,
							nr_seq_lote_ap_w,
							nr_seq_processo_w);
													
							exception
							when others then
								CALL gravar_log_tasy(3535,substr(sqlerrm,1,2000),nm_usuario_p);
								if (obter_funcao_ativa = 88) then
									CALL wheb_mensagem_pck.exibir_mensagem_abort(substr(sqlerrm,1,2000));
								end if;
							end;
							
						select	max(dt_atualizacao_estoque),
							max(cd_setor_atendimento),
							max(cd_local_estoque),
							max(qt_material),
							max(nr_sequencia_prescricao)
						into STRICT	dt_atualizacao_estoque_w,
							cd_setor_conta_w,
							cd_local_conta_w,
							qt_material_conta_w,
							nr_seq_prescr_conta_w
						from	material_atend_paciente
						where	nr_sequencia = nr_seq_map_w;
							
						if (ie_gerar_estornar_w = 'E') and (ie_momento_lancamento_w = 'CR') and (ie_momento_p = 'GAP') and (dt_atualizacao_estoque_w IS NOT NULL AND dt_atualizacao_estoque_w::text <> '') then
							begin
							CALL gerar_prescricao_estoque(
								cd_estabelecimento_w,
								nr_atendimento_w,
								dt_entrada_unidade_w,

								coalesce(cd_material_exec_w, cd_material_w),
								dt_gerar_estornar_p,
								'1',
								coalesce(cd_local_conta_w,cd_local_estoque_w),
								qt_material_conta_w,
								cd_setor_conta_w,
								cd_um_dose_w,
								nm_usuario_p,
								'I',
								nr_prescricao_w,
								nr_seq_prescr_conta_w,
								null,
								nr_seq_map_w,
								null,
								null,
								nr_seq_lote_fornec_w,
								null,
								null,
								nr_seq_lote_ap_w, 
								'S',
								'',
								'');
							end;
						end if;				
															
						--Chama regra de lancamento automatico
						if (varLancaAuto_w	= 'S') and (ie_gerar_estornar_w <> 'E') then
							begin
								CALL gerar_lanc_automatico_mat(nr_atendimento_w,NULL, 132, nm_usuario_p, nr_seq_map_w,NULL,NULL);
							exception when others then
								null;
							end;

						end if;
							
						update	adep_processo_item
						set	ie_conta_paciente	= 'S',
							ie_lanc_automatico      = 'S'
						where	nr_sequencia		= nr_seq_item_w;						
								
						/* obter conta */

						CALL atualiza_preco_material(nr_seq_map_w,nm_usuario_p);
						cd_material_exec_w := null;
						if (coalesce(wheb_usuario_pck.get_ie_commit, 'S') = 'S') then
							commit;
						end if;
						
						if ((((qt_diferenca_w > 0) and (qt_material_baixar = (qt_baixado_consignado_w + qt_baixado_proprio_w))) or (qt_diferenca_w = 0) or (ie_continua = 'N')) and (ie_mat_consignado_w = '2' and nr_seq_regra_w > 0))then
						begin
							qt_diferenca_w := 0;
							ie_continua := 'N';
						end;
						elsif (ie_mat_consignado_w = '2' and nr_seq_regra_w > 0 and qt_estoque_w > 0)then
						begin --vai baixar mais itens
							cd_cgc_fornecedor_w := null;
							ie_continua := 'S';
							qt_material_w := qt_diferenca_w;
						end;
						else
							ie_continua := 'N';
							qt_diferenca_w := 0;
						end if;
						end;					
					end loop;					
				end if;
			end if;
			end;
		end loop;
		close c01;
		
		if (ie_gerar_estornar_w = 'E') and (coalesce(nr_seq_map_w,0) > 0) then
			if (coalesce(nr_seq_area_prep_p::text, '') = '') then
				delete	FROM adep_processo_item
				where	nr_seq_processo = nr_seq_processo_p;
			else
				delete	FROM adep_processo_item
				where	nr_seq_processo = nr_seq_processo_p
				and		nr_seq_area_prep = nr_seq_area_prep_p;
			end if;
		end if;
	end if;
end if;

if (coalesce(wheb_usuario_pck.get_ie_commit, 'S') = 'S') then commit; end if;

nr_seq_map_p := nr_seq_map_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_estornar_adep_map ( nr_seq_processo_p bigint, nr_seq_horario_p bigint, nr_seq_area_prep_p bigint, ie_gerar_estornar_p text, dt_gerar_estornar_p timestamp, nm_usuario_p text, nr_seq_map_p INOUT bigint, ie_momento_p text default null, qt_material_p bigint DEFAULT NULL, nr_seq_lote_fornec_p bigint DEFAULT NULL) FROM PUBLIC;

