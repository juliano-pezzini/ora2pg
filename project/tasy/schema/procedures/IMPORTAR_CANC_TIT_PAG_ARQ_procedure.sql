-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE importar_canc_tit_pag_arq (nr_titulo_p text, nm_usuario_p text, dt_cancelamento_p timestamp, nr_externo_p text) AS $body$
DECLARE

 
 
nr_seq_alt_valor_w	bigint;
qt_externo_w		bigint;

/* 
Procedure utilizada para importação padrão WHEB dos calncelamentos de títulos a pagar 
Usar interface 1624 - "Integração WHEB - Importar Cancelamento títulos a pagar 1.0" 
*/
 
 

BEGIN 
 
IF (coalesce(nr_titulo_p::text, '') = '') THEN 
	CALL Wheb_mensagem_pck.exibir_mensagem_abort(230949);
end if;
 
 
select	count(*) 
into STRICT	qt_externo_w 
from	titulo_pagar_alt_valor 
where	nr_titulo 	= nr_titulo_p 
and	nr_externo 	= nr_externo_p;
 
 
if (qt_externo_w = 0) then 
	begin 
	CALL Cancelar_Titulo_pagar(nr_titulo_p,nm_usuario_p,dt_cancelamento_p);
	 
	select	max(nr_sequencia) 
	into STRICT	nr_seq_alt_valor_w 
	from	titulo_pagar_alt_valor 
	where	nr_titulo = nr_titulo_p;
	 
	update	titulo_pagar_alt_valor 
	set	nr_externo 	= nr_externo_p 
	where	nr_titulo 	= nr_titulo_p 
	and	nr_sequencia	= nr_seq_alt_valor_w;
	end;
 
 
/* 	Alteração realizada conforme OS 558926 
else 
 
	 
	insert into log_tasy 
		(cd_log, 
		nm_usuario, 
		dt_atualizacao, 
		ds_log) 
	values	(55786, 
		'IMP_WHEB', 
		sysdate, 
		'Erro ao inserir o título ' || nr_titulo_p || chr(13) || chr(10) || 
		'Erro: Este cancelamento já foi importado!'); 
*/
 
 
end if;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE importar_canc_tit_pag_arq (nr_titulo_p text, nm_usuario_p text, dt_cancelamento_p timestamp, nr_externo_p text) FROM PUBLIC;

