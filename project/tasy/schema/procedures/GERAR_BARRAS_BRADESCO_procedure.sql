-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_barras_bradesco (nr_seq_banco_escrit_p bigint, nm_usuario_p text, nr_seq_lote_p bigint) AS $body$
DECLARE


cd_banco_w		varchar(3);
cd_barras_w		varchar(255);
cd_moeda_w		varchar(1);
ds_campo_livre_w	varchar(25);
ds_fator_venc_w		varchar(4);
ie_digito_w		varchar(1);
nr_seq_barras_w		bigint;
vl_transacao_w		varchar(10);
ie_tipo_inscricao_w	bigint;
nr_inscricao_w		varchar(15);
cd_cgc_w		varchar(14);
cd_pessoa_fisica_w	varchar(10);
cd_agencia_bancaria_w	varchar(5);
nr_conta_w		varchar(13);
cd_carteira_w		varchar(3);
qt_cont_w		bigint;
nr_nosso_numero_w	varchar(12);
ie_forma_importacao_w	varchar(1);
cd_estabelecimento_w	smallint;
nr_seq_banco_escrit_w	bigint;
nm_pessoa_externo_w	varchar(30);
nr_pagamento_w		numeric(20);
dt_emissao_w		timestamp;
cd_lancamento_w		bigint;
dt_limite_desconto_w	timestamp;
ds_limite_desconto_w	varchar(8);
ds_sacador_avalista_w	varchar(40);
nr_documento_w		varchar(15);
nr_titulo_w		bigint;
nr_seq_escrit_barras_w	bigint;
cd_banco_lote_w		smallint;
ie_digito_calc_w	varchar(1);
vl_desconto_w		double precision;
vl_acrescimo_w		double precision;
ie_alt_tit_bloq_barras_w	varchar(1);
ie_vincular_tit_bloq_barras_w	varchar(1);
dt_vencimento_barras_w			timestamp;
ie_sem_venc_w				varchar(1);
ie_importar_vencidos_w		varchar(1) := 'S';
qt_barras_lote_w	bigint;

c01 CURSOR FOR
/* Registro de transação */

SELECT	substr(a.ds_conteudo,96,3) cd_banco,
	somente_numero(substr(a.ds_conteudo,2,1)) ie_tipo_inscricao,
	substr(a.ds_conteudo,3,15) nr_inscricao,
	substr(a.ds_conteudo,400,1) cd_moeda,
	substr(a.ds_conteudo,399,1) ie_digito,
	substr(a.ds_conteudo,191,4) ds_fator_venc,
	substr(a.ds_conteudo,195,10) vl_transacao,
	substr(a.ds_conteudo,99,5) cd_agencia_bancaria,
	substr(a.ds_conteudo,105,13) nr_conta,
	substr(a.ds_conteudo,136,3) cd_carteira,
	substr(a.ds_conteudo,139,12) nr_nosso_numero,
	substr(a.ds_conteudo,374,25) ds_campo_livre,
	substr(a.ds_conteudo,18,30) nm_pessoa_externo,
	somente_numero(substr(a.ds_conteudo,120,16)) nr_pagamento,
	to_date(substr(a.ds_conteudo,174,8),'yyyy/mm/dd') dt_emissao,
	somente_numero(substr(a.ds_conteudo,473,5)) cd_lancamento,
	substr(a.ds_conteudo,182,8) ds_limite_desconto,
	a.nr_sequencia,
	substr(a.ds_conteudo,332,40) ds_sacador_avalista,
	substr(a.ds_conteudo,151,15) nr_documento,
	somente_numero(substr(a.ds_conteudo,220,15)) / 100 vl_desconto,
	somente_numero(substr(a.ds_conteudo,235,15)) / 100 vl_acrescimo
from	w_barras a
where	substr(a.ds_conteudo,1,1)	= '1'
order by	a.nr_sequencia;


BEGIN

begin

if (coalesce(nr_seq_lote_p,0)	= 0) then

	select	max(a.cd_estabelecimento),
		max(a.cd_banco)
	into STRICT	cd_estabelecimento_w,
		cd_banco_lote_w
	from	banco_escritural a
	where	a.nr_sequencia		= nr_seq_banco_escrit_p;

else

	select	max(a.cd_estabelecimento),
		max(b.cd_banco)
	into STRICT	cd_estabelecimento_w,
		cd_banco_lote_w
	from	banco_estabelecimento b,
		banco_escrit_lote a
	where	a.nr_seq_conta_banco	= b.nr_sequencia
	and	a.nr_sequencia		= nr_seq_lote_p;

end if;

ie_forma_importacao_w := obter_param_usuario(857, 32, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_forma_importacao_w);
ie_alt_tit_bloq_barras_w := obter_param_usuario(857, 60, obter_perfil_ativo, nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento, ie_alt_tit_bloq_barras_w);
ie_vincular_tit_bloq_barras_w := obter_param_usuario(857, 66, obter_perfil_ativo, nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento, ie_vincular_tit_bloq_barras_w);
ie_sem_venc_w := obter_param_usuario(857, 67, obter_perfil_ativo, nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento, ie_sem_venc_w);

if (ie_forma_importacao_w = '2') then
	nr_seq_banco_escrit_w	:= null;
else
	nr_seq_banco_escrit_w	:= nr_seq_banco_escrit_p;
end if;

open	c01;
loop
fetch	c01 into
	cd_banco_w,
	ie_tipo_inscricao_w,
	nr_inscricao_w,
	cd_moeda_w,
	ie_digito_w,
	ds_fator_venc_w,
	vl_transacao_w,
	cd_agencia_bancaria_w,
	nr_conta_w,
	cd_carteira_w,
	nr_nosso_numero_w,
	ds_campo_livre_w,
	nm_pessoa_externo_w,
	nr_pagamento_w,
	dt_emissao_w,
	cd_lancamento_w,
	ds_limite_desconto_w,
	nr_seq_barras_w,
	ds_sacador_avalista_w,
	nr_documento_w,
	vl_desconto_w,
	vl_acrescimo_w;
EXIT WHEN NOT FOUND; /* apply on c01 */

	if (cd_banco_w = '237') then

		cd_barras_w	:=	to_char(somente_numero(cd_banco_w),'FM000') ||
					'9' ||
					'?' ||
					to_char(somente_numero(ds_fator_venc_w),'FM0000') ||
					to_char(somente_numero(vl_transacao_w),'FM0000000000') ||
					to_char(somente_numero(cd_agencia_bancaria_w),'FM0000') ||
					to_char(somente_numero(cd_carteira_w),'FM00') ||
					to_char(somente_numero(nr_nosso_numero_w),'FM00000000000') ||
					to_char(somente_numero(nr_conta_w),'FM0000000') ||
					'0';
		ie_digito_calc_w	:= substr(to_char(calcula_digito('Bloqueto',cd_barras_w)),1,1);
		cd_barras_w		:= substr(cd_barras_w,1,4) || ie_digito_calc_w || substr(cd_barras_w,6,39);

	else

		cd_barras_w	:=	to_char(somente_numero(cd_banco_w),'FM000') ||
					to_char(somente_numero(cd_moeda_w),'FM0') ||
					to_char(somente_numero(ie_digito_w),'FM0') ||
					to_char(somente_numero(ds_fator_venc_w),'FM0000') ||
					to_char(somente_numero(vl_transacao_w),'FM0000000000') ||
					to_char(somente_numero(ds_campo_livre_w),'FM0000000000000000000000000');

	end if;

	if (ie_tipo_inscricao_w = 1) then	/* CPF */
		select	max(a.cd_pessoa_fisica)
		into STRICT	cd_pessoa_fisica_w
		from	pessoa_fisica a
		where	somente_numero(a.nr_cpf)	= somente_numero(nr_inscricao_w);

	elsif (ie_tipo_inscricao_w = 2) then	/* CNPJ */
		select	max(a.cd_cgc)
		into STRICT	cd_cgc_w
		from	pessoa_juridica a
		where	somente_numero(a.cd_cgc)	= somente_numero(nr_inscricao_w);

	end if;

	if ( coalesce(ie_sem_venc_w,'S') = 'N') and (cd_barras_w IS NOT NULL AND cd_barras_w::text <> '') then

		select	to_date(obter_dados_cod_barras(cd_barras_w,'DT'),'dd/mm/yyyy')
		into STRICT	dt_vencimento_barras_w
		;

		if ( to_date(dt_vencimento_barras_w,'dd/mm/RR') < to_date(clock_timestamp(),'dd/mm/RR') ) or (coalesce(dt_vencimento_barras_w::text, '') = '') then
			ie_importar_vencidos_w := 'N';
		else
			ie_importar_vencidos_w := 'S';
		end if;
	else
		ie_importar_vencidos_w := 'S';
	end if;

	if (cd_barras_w IS NOT NULL AND cd_barras_w::text <> '') and (coalesce(ie_importar_vencidos_w,'S') = 'S') then

		select 	count(1)
		into STRICT	qt_barras_lote_w
		from	banco_escrit_barras
		where	cd_barras = cd_barras_w
		and		CASE WHEN ie_forma_importacao_w='2' THEN 0  ELSE nr_seq_banco_escrit END  = CASE WHEN ie_forma_importacao_w='2' THEN 0  ELSE nr_seq_banco_escrit_w END;

		if (qt_barras_lote_w = 0) then

			if (ds_limite_desconto_w <> '00000000') then
				dt_limite_desconto_w	:= to_date(ds_limite_desconto_w,'yyyy/mm/dd');
			else
				dt_limite_desconto_w	:= null;
			end if;

			select	nextval('banco_escrit_barras_seq')
			into STRICT	nr_seq_escrit_barras_w
			;

			insert	into banco_escrit_barras(cd_barras,
				dt_atualizacao,
				nm_usuario,
				nr_seq_banco_escrit,
				nr_sequencia,
				cd_cgc,
				cd_pessoa_fisica,
				nr_seq_lote,
				cd_pessoa_externo,
				nm_pessoa_externo,
				nr_pagamento,
				dt_emissao,
				cd_lancamento,
				dt_limite_desconto,
				ds_sacador_avalista,
				nr_documento,
				nr_nosso_numero,
				vl_desconto,
				vl_acrescimo)
			values (cd_barras_w,
				clock_timestamp(),
				nm_usuario_p,
				nr_seq_banco_escrit_w,
				nr_seq_escrit_barras_w,
				cd_cgc_w,
				cd_pessoa_fisica_w,
				nr_seq_lote_p,
				nr_inscricao_w,
				nm_pessoa_externo_w,
				nr_pagamento_w,
				dt_emissao_w,
				to_char(cd_lancamento_w),
				dt_limite_desconto_w,
				ds_sacador_avalista_w,
				nr_documento_w,
				nr_nosso_numero_w,
				vl_desconto_w,
				vl_acrescimo_w);

			nr_titulo_w := obter_titulo_regra_barras(cd_banco_lote_w, nr_documento_w, cd_cgc_w, cd_barras_w, nr_titulo_w, 'N', nr_seq_escrit_barras_w);

			update	banco_escrit_barras
			set	nr_titulo	= nr_titulo_w
			where	nr_sequencia	= nr_seq_escrit_barras_w;

			if (coalesce(nr_titulo_w,0)	<> 0) and (cd_barras_w IS NOT NULL AND cd_barras_w::text <> '') then
			begin
				if (coalesce(ie_vincular_tit_bloq_barras_w, 'N') = 'S') then
					update	titulo_pagar
					set	nr_bloqueto	= cd_barras_w,
						nm_usuario	= nm_usuario_p,
						ie_bloqueto     = 'S'
					where	nr_titulo	= nr_titulo_w;
				end if;

				if (coalesce(ie_alt_tit_bloq_barras_w, 'N') = 'S') then
					update	titulo_pagar
					set	ie_tipo_titulo	= '1',
						nm_usuario	= nm_usuario_p
					where	nr_titulo	= nr_titulo_w;
				end if;

				CALL definir_banco_tit_escritural('CP',nr_titulo_w,nr_seq_banco_escrit_w,nm_usuario_p,'N');
			end;
			end if;

		end if;
	end if;

end	loop;
close	c01;

delete	from w_barras;

commit;

exception
when others then

	delete	from w_barras;
	commit;

end;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_barras_bradesco (nr_seq_banco_escrit_p bigint, nm_usuario_p text, nr_seq_lote_p bigint) FROM PUBLIC;

