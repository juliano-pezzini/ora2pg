-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_log_etiq_impressas_atend ( nr_atendimento_p bigint, qt_etiqueta_p bigint, nm_usuario_p text) AS $body$
DECLARE
 	
ie_existe_atendimento_w 	double precision 	:= 0;		
nr_etiqueta_w		 double precision 	:= 0;
nr_sequencia_w		 double precision 	:= 0;
BEGIN
	 
	if (nr_atendimento_p IS NOT NULL AND nr_atendimento_p::text <> '' AND nm_usuario_p IS NOT NULL AND nm_usuario_p::text <> '') then	 
	select 	count(*) 
	into STRICT	ie_existe_atendimento_w 
	from	atendimento_paciente 
	where	nr_atendimento = nr_atendimento_p;
 
	if ie_existe_atendimento_w > 0 then 
	begin 
	select 	coalesce(max(nr_sequencia),0) 
	into STRICT	nr_sequencia_w 
	from  	etiqueta_controle_atend;
	 
	select 	coalesce(max(nr_etiqueta),0) 
	into STRICT	nr_etiqueta_w 
	from	etiqueta_controle_atend 
	where	nr_atendimento = nr_atendimento_p;
	end;	
					 
	for i in 1..qt_etiqueta_p 
	loop 
		begin 
		nr_etiqueta_w := nr_etiqueta_w + 1;
		nr_sequencia_w := nr_sequencia_w +1;	
		insert into etiqueta_controle_atend values (	nr_sequencia_w, 
							clock_timestamp(), 
							nm_usuario_p, 
							clock_timestamp(), 
							nm_usuario_p, 
							nr_etiqueta_w, 
							nr_atendimento_p);
		end;
	end loop;	
	end if;
	end if;
	commit;	
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_log_etiq_impressas_atend ( nr_atendimento_p bigint, qt_etiqueta_p bigint, nm_usuario_p text) FROM PUBLIC;

