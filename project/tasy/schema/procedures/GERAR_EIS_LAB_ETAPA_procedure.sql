-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_eis_lab_etapa (dt_parametro_p timestamp, nm_usuario_p text) AS $body$
DECLARE

 
 
nr_seq_grupo_w			bigint;
nr_seq_exame_w			bigint;
cd_setor_solic_w		integer;
ie_tipo_atendimento_w	smallint;
cd_medico_w				varchar(10);
ie_etapa_w				smallint;
nm_exame_w				varchar(255);
nr_prescricao_w			bigint;
nr_seq_prescr_w			integer;
dt_prescricao_w			timestamp;
cd_setor_prescricao_w	integer;
cd_setor_entrega_w		integer;
dt_prev_execucao_w		timestamp;
dt_coleta_w				timestamp;
dt_liberacao_w			timestamp;
ie_urgencia_w			varchar(1);

dt_etapa_mapa_w			timestamp;
dt_etapa_coleta_w		timestamp;
dt_etapa_distrib_w		timestamp;
dt_etapa_digit_w		timestamp;
dt_etapa_aprov_w		timestamp;
dt_etapa_lib_exame_w	timestamp;
dt_etapa_mapa_ant_w		timestamp;
dt_etapa_coleta_ant_w	timestamp;
dt_etapa_distrib_ant_w	timestamp;
dt_etapa_digit_ant_w	timestamp;
dt_etapa_aprov_ant_w	timestamp;
dt_etapa_lib_exame_ant_w timestamp;

nr_min_mapa_w			double precision;
nr_min_coleta_w			double precision;
nr_min_distrib_w		double precision;
nr_min_dig_w			double precision;
nr_min_aprov_w			double precision;
nr_min_coleta_aprov_w	double precision;
nr_min_lib_aprov_w		double precision;
nr_min_lib_coleta_w		double precision;
nr_min_lib_digit_w		double precision;
nr_min_prev_coleta_w	double precision;
nr_min_prev_aprov_w		double precision;
nr_min_lib_lib_exame_w	double precision;
nm_usuario_etapa_w		varchar(15);

dt_parametro_w			timestamp;
nr_sequencia_w			bigint;
nr_sequencia_etapa_w	bigint;
nr_seq_etapa_atual_w	bigint;
nr_seq_etapa_ant_w		bigint;

cd_pessoa_fisica_w		pessoa_fisica.cd_pessoa_fisica%type;

 
C01 CURSOR FOR 
	SELECT	b.nr_seq_grupo, 
		a.nr_seq_exame, 
		coalesce(d.cd_setor_entrega, d.cd_setor_atendimento), 
		e.ie_tipo_atendimento, 
		d.cd_medico, 
		c.ie_etapa, 
		substr(b.nm_exame,1,255), 
		d.nr_prescricao, 
		a.nr_sequencia, 
		trunc(d.dt_prescricao,'dd'), 
		d.cd_setor_atendimento, 
		d.cd_setor_entrega, 
		a.dt_prev_execucao, 
		a.dt_coleta, 
		d.dt_liberacao, 
		coalesce(a.ie_urgencia,'N'), 
		coalesce(c.nm_usuario,Obter_Desc_Expressao(327119)), 
		d.cd_pessoa_fisica 
	from 	prescr_procedimento a, 
		exame_laboratorio b, 
		prescr_proc_etapa c, 
		prescr_medica d, 
		atendimento_paciente e 
	where 	a.nr_seq_exame		= b.nr_seq_exame 
	and	a.nr_prescricao 	= c.nr_prescricao 
	and	a.nr_sequencia 		= c.nr_seq_prescricao 
	and	a.nr_prescricao 	= d.nr_prescricao 
	and	d.nr_atendimento	= e.nr_atendimento 
	and	c.nr_sequencia = (SELECT max(nr_sequencia) 
				from prescr_proc_etapa 
				where nr_prescricao = d.nr_prescricao 
				and nr_seq_prescricao = a.nr_sequencia 
				and ie_etapa = c.ie_etapa) 
	and	(a.nr_seq_exame IS NOT NULL AND a.nr_seq_exame::text <> '') 
	and	(d.dt_liberacao IS NOT NULL AND d.dt_liberacao::text <> '') 
	and	trunc(d.dt_prescricao,'dd')  = dt_parametro_w;


BEGIN 
 
dt_parametro_w	:= trunc(dt_parametro_p,'dd');
 
delete from eis_lab_qt_exame_etapa where dt_referencia = dt_parametro_w;
 
open C01;
loop 
fetch C01 into 
	nr_seq_grupo_w, 
	nr_seq_exame_w, 
	cd_setor_solic_w, 
	ie_tipo_atendimento_w, 
	cd_medico_w, 
	ie_etapa_w, 
	nm_exame_w, 
	nr_prescricao_w, 
	nr_seq_prescr_w, 
	dt_prescricao_w, 
	cd_setor_prescricao_w, 
	cd_setor_entrega_w, 
	dt_prev_execucao_w, 
	dt_coleta_w, 
	dt_liberacao_w, 
	ie_urgencia_w, 
	nm_usuario_etapa_w, 
	cd_pessoa_fisica_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin 
	 
	nr_min_mapa_w			:=	null;
	nr_min_coleta_w			:=	null;
	nr_min_distrib_w		:=	null;
	nr_min_dig_w			:=	null;
	nr_min_aprov_w			:=	null;
	nr_min_coleta_aprov_w		:=	null;
	nr_min_lib_aprov_w		:=	null;
	nr_min_lib_coleta_w		:=	null;
	nr_min_lib_digit_w		:=	null;
	nr_min_prev_coleta_w		:=	null;
	nr_min_prev_aprov_w		:=	null;
 
	dt_etapa_mapa_w		:=	null;
	dt_etapa_coleta_w	:=	null;
	dt_etapa_distrib_w	:=	null;
	dt_etapa_digit_w	:=	null;
	dt_etapa_aprov_w	:=	null;
	dt_etapa_mapa_ant_w	:=	null;
	dt_etapa_coleta_ant_w	:=	null;
	dt_etapa_distrib_ant_w	:=	null;
	dt_etapa_digit_ant_w	:=	null;
	dt_etapa_aprov_ant_w	:=	null;
 
 
	select 	coalesce(max(nr_sequencia),0) 
	into STRICT	nr_sequencia_etapa_w 
	from 	prescr_proc_etapa 
	where	nr_prescricao		= nr_prescricao_w 
	and	nr_seq_prescricao	= nr_seq_prescr_w 
	and	ie_etapa		= ie_etapa_w;
 
	select 	min(nr_sequencia) 
	into STRICT	nr_seq_etapa_atual_w 
	from 	prescr_proc_etapa 
	where 	nr_prescricao 		= nr_prescricao_w 
	and	nr_seq_prescricao 	= nr_seq_prescr_w 
	and	ie_etapa		= ie_etapa_w;
 
 
	select 	max(nr_sequencia) 
	into STRICT	nr_seq_etapa_ant_w 
	from 	prescr_proc_etapa 
	where 	nr_prescricao 		= nr_prescricao_w 
	and	nr_seq_prescricao 	= nr_seq_prescr_w 
	and	nr_sequencia		< nr_seq_etapa_atual_w;
 
	if (nr_sequencia_etapa_w > 0) then 
 
		if (ie_etapa_w = 15) then 
			begin 
 
			select	coalesce(max(dt_atualizacao), null) 
			into STRICT	dt_etapa_mapa_w 
			from 	prescr_proc_etapa 
			where	nr_prescricao		= nr_prescricao_w 
			and	nr_seq_prescricao	= nr_seq_prescr_w 
			and	ie_etapa		= ie_etapa_w 
			and 	nr_sequencia		= nr_sequencia_etapa_w;
		 
			if (coalesce(nr_seq_etapa_ant_w::text, '') = '') then 
				dt_etapa_mapa_ant_w := dt_liberacao_w;
			else 
				select	max(dt_atualizacao) 
				into STRICT	dt_etapa_mapa_ant_w 
				from 	prescr_proc_etapa 
				where	nr_sequencia 		= nr_seq_etapa_ant_w 
				and	nr_prescricao 		= nr_prescricao_w 
				and	nr_seq_prescricao 	= nr_seq_prescr_w;
			end if;
 
			end;
		elsif (ie_etapa_w = 20) then 
			begin 
 
			select	coalesce(max(dt_atualizacao), null) 
			into STRICT	dt_etapa_coleta_w 
			from 	prescr_proc_etapa 
			where	nr_prescricao		= nr_prescricao_w 
			and	nr_seq_prescricao	= nr_seq_prescr_w 
			and	ie_etapa		= ie_etapa_w 
			and 	nr_sequencia		= nr_sequencia_etapa_w;
 
			if (coalesce(nr_seq_etapa_ant_w::text, '') = '') then 
				dt_etapa_coleta_ant_w := dt_liberacao_w;
			else 
				select	max(dt_atualizacao) 
				into STRICT	dt_etapa_coleta_ant_w 
				from 	prescr_proc_etapa 
				where	nr_sequencia 		= nr_seq_etapa_ant_w 
				and	nr_prescricao 		= nr_prescricao_w 
				and	nr_seq_prescricao 	= nr_seq_prescr_w;
			end if;
			end;
		elsif (ie_etapa_w = 25) then 
			begin 
 
			select	coalesce(max(dt_atualizacao), null) 
			into STRICT	dt_etapa_distrib_w 
			from 	prescr_proc_etapa 
			where	nr_prescricao		= nr_prescricao_w 
			and	nr_seq_prescricao	= nr_seq_prescr_w 
			and	ie_etapa		= ie_etapa_w 
			and 	nr_sequencia		= nr_sequencia_etapa_w;
 
			if (coalesce(nr_seq_etapa_ant_w::text, '') = '') then 
				dt_etapa_distrib_ant_w := dt_liberacao_w;
			else 
				select	max(dt_atualizacao) 
				into STRICT	dt_etapa_distrib_ant_w 
				from 	prescr_proc_etapa 
				where	nr_sequencia 		= nr_seq_etapa_ant_w 
				and	nr_prescricao 		= nr_prescricao_w 
				and	nr_seq_prescricao 	= nr_seq_prescr_w;
			end if;
			 
			end;
		elsif (ie_etapa_w = 30) then 
			begin 
 
			select	coalesce(max(dt_atualizacao), null) 
			into STRICT	dt_etapa_digit_w 
			from 	prescr_proc_etapa 
			where	nr_prescricao		= nr_prescricao_w 
			and	nr_seq_prescricao	= nr_seq_prescr_w 
			and	ie_etapa		= ie_etapa_w 
			and 	nr_sequencia		= nr_sequencia_etapa_w;
			 
			if (coalesce(nr_seq_etapa_ant_w::text, '') = '') then 
				dt_etapa_digit_ant_w := dt_liberacao_w;
			else 
				select	max(dt_atualizacao) 
				into STRICT	dt_etapa_digit_ant_w 
				from 	prescr_proc_etapa 
				where	nr_sequencia 		= nr_seq_etapa_ant_w 
				and	nr_prescricao 		= nr_prescricao_w 
				and	nr_seq_prescricao 	= nr_seq_prescr_w;
			end if;
 
			end;
		elsif (ie_etapa_w = 35) then 
			begin 
 
			select	coalesce(max(dt_atualizacao), null) 
			into STRICT	dt_etapa_aprov_w 
			from 	prescr_proc_etapa 
			where	nr_prescricao		= nr_prescricao_w 
			and	nr_seq_prescricao	= nr_seq_prescr_w 
			and	ie_etapa		= ie_etapa_w 
			and 	nr_sequencia		= nr_sequencia_etapa_w;
 
			if (coalesce(nr_seq_etapa_ant_w::text, '') = '') then 
				dt_etapa_aprov_ant_w := dt_liberacao_w;
			else 
				select	max(dt_atualizacao) 
				into STRICT	dt_etapa_aprov_ant_w 
				from 	prescr_proc_etapa 
				where	nr_sequencia 		= nr_seq_etapa_ant_w 
				and	nr_prescricao 		= nr_prescricao_w 
				and	nr_seq_prescricao 	= nr_seq_prescr_w;
			end if;
			 
			end;
		elsif (ie_etapa_w = 40) then 
			begin 
 
			select	coalesce(max(dt_atualizacao), null) 
			into STRICT	dt_etapa_lib_exame_w 
			from 	prescr_proc_etapa 
			where	nr_prescricao		= nr_prescricao_w 
			and	nr_seq_prescricao	= nr_seq_prescr_w 
			and	ie_etapa		= ie_etapa_w 
			and 	nr_sequencia		= nr_sequencia_etapa_w;
 
			if (coalesce(nr_seq_etapa_ant_w::text, '') = '') then 
				dt_etapa_lib_exame_ant_w := dt_liberacao_w;
			else 
				select	max(dt_atualizacao) 
				into STRICT	dt_etapa_lib_exame_ant_w 
				from 	prescr_proc_etapa 
				where	nr_sequencia 		= nr_seq_etapa_ant_w 
				and	nr_prescricao 		= nr_prescricao_w 
				and	nr_seq_prescricao 	= nr_seq_prescr_w;
			end if;
			 
			end;
		end if;
 
	nr_min_mapa_w			:=	(dt_etapa_mapa_w - dt_etapa_mapa_ant_w);
	nr_min_coleta_w			:=	(dt_etapa_coleta_w - dt_etapa_coleta_ant_w);
	nr_min_distrib_w		:=	(dt_etapa_distrib_w - dt_etapa_distrib_ant_w);
	nr_min_dig_w			:= 	(dt_etapa_digit_w - dt_etapa_digit_ant_w);
	nr_min_aprov_w			:= 	(dt_etapa_aprov_w - dt_etapa_aprov_ant_w);
	nr_min_coleta_aprov_w		:=	(dt_etapa_aprov_w - dt_coleta_w);
	nr_min_lib_aprov_w		:=	(dt_etapa_aprov_w - dt_liberacao_w);
	nr_min_lib_coleta_w		:=	(dt_coleta_w - dt_liberacao_w);
	nr_min_lib_digit_w		:=	(dt_etapa_digit_w - dt_liberacao_w);
	nr_min_prev_coleta_w		:=	(dt_etapa_coleta_w - dt_prev_execucao_w);
	nr_min_prev_aprov_w		:=	(dt_etapa_aprov_w - dt_prev_execucao_w);
	nr_min_lib_lib_exame_w		:=	(dt_etapa_lib_exame_w - dt_liberacao_w);
 
	end if;
 
	select	nextval('eis_lab_qt_exame_etapa_seq') 
	into STRICT	nr_sequencia_w 
	;
 
	insert into eis_lab_qt_exame_etapa(	nr_sequencia, 
						dt_atualizacao, 
						nm_usuario, 
						dt_atualizacao_nrec, 
						nm_usuario_nrec, 
						nr_seq_grupo, 
						nr_seq_exame, 
						cd_setor_solicitacao, 
						ie_tipo_atendimento, 
						cd_medico, 
						ie_etapa, 
						dt_referencia, 
						nm_exame, 
						nr_prescricao, 
						nr_seq_prescr, 
						dt_prescricao, 
						cd_setor_prescricao, 
						cd_setor_entrega, 
						nr_min_mapa, 
						nr_min_coleta, 
						nr_min_distribuicao, 
						nr_min_digitacao, 
						nr_min_aprovacao, 
						nr_min_coleta_aprov, 
						nr_min_lib_aprov, 
						nr_min_lib_coleta, 
						nr_min_lib_digitacao, 
						dt_coleta, 
						nr_min_prev_coleta, 
						nr_min_prev_aprovacao, 
						ie_urgencia, 
						dt_aprovacao, 
						nr_min_lib_exame, 
						nm_usuario_etapa, 
						cd_pessoa_fisica 
					) 
				values (	nr_sequencia_w, 
						clock_timestamp(), 
						nm_usuario_p, 
						clock_timestamp(), 
						nm_usuario_p, 
						nr_seq_grupo_w, 
						nr_seq_exame_w, 
						cd_setor_solic_w, 
						ie_tipo_atendimento_w, 
						cd_medico_w, 
						ie_etapa_w, 
						dt_parametro_w, 
						nm_exame_w, 
						nr_prescricao_w, 
						nr_seq_prescr_w, 
						dt_prescricao_w, 
						cd_setor_prescricao_w, 
						cd_setor_entrega_w, 
						nr_min_mapa_w, 
						nr_min_coleta_w, 
						nr_min_distrib_w, 
						nr_min_dig_w, 
						nr_min_aprov_w, 
						nr_min_coleta_aprov_w, 
						nr_min_lib_aprov_w, 
						nr_min_lib_coleta_w, 
						nr_min_lib_digit_w, 
						dt_coleta_w, 
						nr_min_prev_coleta_w, 
						nr_min_prev_aprov_w, 
						ie_urgencia_w, 
						dt_etapa_aprov_w, 
						nr_min_lib_lib_exame_w, 
						nm_usuario_etapa_w, 
						cd_pessoa_fisica_w 
					);
 
	end;
end loop;
close C01;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_eis_lab_etapa (dt_parametro_p timestamp, nm_usuario_p text) FROM PUBLIC;

