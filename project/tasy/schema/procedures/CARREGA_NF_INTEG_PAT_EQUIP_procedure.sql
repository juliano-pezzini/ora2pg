-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE carrega_nf_integ_pat_equip ( nr_seq_nota_p bigint, dt_inicio_p timestamp, dt_final_p timestamp, nm_usuario_p text, ie_replica_qt_item_p text) AS $body$
DECLARE


qt_existe_w		bigint;
ie_desdobrar_w		varchar(1);

c01 CURSOR FOR
SELECT	a.nr_sequencia,
	b.nr_item_nf,
	substr(obter_regra_nf_pat_equip(b.cd_material,coalesce(b.cd_local_estoque,0),coalesce(b.cd_conta_contabil,'0'),a.cd_estabelecimento,'E', 'E', obter_valor_item_regra(b.nr_sequencia, b.nr_item_nf), a.dt_entrada_saida),1,1) ie_equipamento,
	substr(obter_regra_nf_pat_equip(b.cd_material,coalesce(b.cd_local_estoque,0),coalesce(b.cd_conta_contabil,'0'),a.cd_estabelecimento,'P', 'E', obter_valor_item_regra(b.nr_sequencia, b.nr_item_nf), a.dt_entrada_saida),1,1) ie_patrimonio,
	substr(obter_regra_nf_pat_equip(b.cd_material,coalesce(b.cd_local_estoque,0),coalesce(b.cd_conta_contabil,'0'),a.cd_estabelecimento,'P','D', obter_valor_item_regra(b.nr_sequencia, b.nr_item_nf), a.dt_entrada_saida),1,1) ie_desdobrar_itens,
	b.qt_item_nf
from	nota_fiscal_item b,
	nota_fiscal a
where	a.nr_sequencia = b.nr_sequencia
and	a.ie_situacao = 1
and	obter_entrada_saida_nf(a.nr_sequencia) = 'E'
and	(a.dt_atualizacao_estoque IS NOT NULL AND a.dt_atualizacao_estoque::text <> '')
and	((nr_seq_nota_p IS NOT NULL AND nr_seq_nota_p::text <> '' AND a.nr_sequencia = nr_seq_nota_p) or (a.dt_entrada_saida between dt_inicio_p and fim_dia(dt_final_p)))
and	((obter_regra_nf_pat_equip(b.cd_material,coalesce(b.cd_local_estoque,0),coalesce(b.cd_conta_contabil,'0'),a.cd_estabelecimento,'E', 'E', obter_valor_item_regra(b.nr_sequencia, b.nr_item_nf), a.dt_entrada_saida) = 'S') or (obter_regra_nf_pat_equip(b.cd_material,coalesce(b.cd_local_estoque,0),coalesce(b.cd_conta_contabil,'0'),a.cd_estabelecimento,'P', 'E', obter_valor_item_regra(b.nr_sequencia, b.nr_item_nf), a.dt_entrada_saida) = 'S'))
and	not exists (
		SELECT	1
		from	nf_integracao_pat_equip x
		where	x.nr_seq_nota = a.nr_sequencia
		and	x.nr_seq_item = b.nr_item_nf
		and	x.ie_equipamento= substr(obter_regra_nf_pat_equip(b.cd_material,coalesce(b.cd_local_estoque,0),coalesce(b.cd_conta_contabil,'0'),a.cd_estabelecimento,'E', 'E', obter_valor_item_regra(b.nr_sequencia, b.nr_item_nf), a.dt_entrada_saida),1,1)
		and	x.ie_patrimonio	= substr(obter_regra_nf_pat_equip(b.cd_material,coalesce(b.cd_local_estoque,0),coalesce(b.cd_conta_contabil,'0'),a.cd_estabelecimento,'P', 'E', obter_valor_item_regra(b.nr_sequencia, b.nr_item_nf), a.dt_entrada_saida),1,1))
order by	a.nr_sequencia,
	b.nr_item_nf;

c01_w		c01%rowtype;

BEGIN

open C01;
loop
fetch C01 into
	c01_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin

	if (ie_replica_qt_item_p = 'N') then
		ie_desdobrar_w := 'N';
	elsif (ie_replica_qt_item_p = 'D') then
		ie_desdobrar_w := c01_w.ie_desdobrar_itens;
	elsif (ie_replica_qt_item_p = 'S') then
		ie_desdobrar_w := 'S';
	end if;

	if (coalesce(ie_desdobrar_w,'N') = 'N') then
		begin
		select	count(*)
		into STRICT	qt_existe_w
		from	nf_integracao_pat_equip
		where	nr_seq_nota	= c01_w.nr_sequencia
		and	nr_seq_item	= c01_w.nr_item_nf;

		if (qt_existe_w = 0) then
			insert into nf_integracao_pat_equip(
				nr_sequencia,
				dt_atualizacao,
				nm_usuario,
				dt_atualizacao_nrec,
				nm_usuario_nrec,
				nr_seq_nota,
				nr_seq_item,
				ie_equipamento,
				ie_patrimonio,
				ie_desdobrar_itens)
			values (	nextval('nf_integracao_pat_equip_seq'),
				clock_timestamp(),
				nm_usuario_p,
				clock_timestamp(),
				nm_usuario_p,
				c01_w.nr_sequencia,
				c01_w.nr_item_nf,
				c01_w.ie_equipamento,
				c01_w.ie_patrimonio,
				ie_desdobrar_w);
		else
			update	nf_integracao_pat_equip
			set	ie_equipamento	= c01_w.ie_equipamento,
				ie_patrimonio	= c01_w.ie_patrimonio
			where	nr_seq_nota	= c01_w.nr_sequencia
			and	nr_seq_item	= c01_w.nr_item_nf;
		end if;
		end;
	elsif (coalesce(ie_desdobrar_w,'N') in ('S','U')) then
		begin

		if (coalesce(ie_desdobrar_w,'N') = 'U') then
			begin
			c01_w.qt_item_nf := 1;
			end;
		end if;

		for i in 1..c01_w.qt_item_nf loop
			begin
			insert into nf_integracao_pat_equip(
					nr_sequencia,
					dt_atualizacao,
					nm_usuario,
					dt_atualizacao_nrec,
					nm_usuario_nrec,
					nr_seq_nota,
					nr_seq_item,
					ie_equipamento,
					ie_patrimonio,
					ie_desdobrar_itens)
				values (	nextval('nf_integracao_pat_equip_seq'),
					clock_timestamp(),
					nm_usuario_p,
					clock_timestamp(),
					nm_usuario_p,
					c01_w.nr_sequencia,
					c01_w.nr_item_nf,
					c01_w.ie_equipamento,
					c01_w.ie_patrimonio,
					ie_desdobrar_w);
			end;
		end loop;
		end;
	end if;
	end;
end loop;
close C01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE carrega_nf_integ_pat_equip ( nr_seq_nota_p bigint, dt_inicio_p timestamp, dt_final_p timestamp, nm_usuario_p text, ie_replica_qt_item_p text) FROM PUBLIC;

