-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';



CREATE TYPE colunas AS (nr_prescricao_w		bigint, 
                        nr_seq_cpoe_w       bigint);


CREATE OR REPLACE PROCEDURE aprazar_item_prescr ( ie_aprazar_interv_p text, cd_estabelecimento_p bigint, nr_atendimento_p bigint, ie_tipo_item_p text, qt_hora_prescricao_p bigint, cd_item_p text, cd_intervalo_p text, qt_item_p bigint, dt_horario_p timestamp, nr_prescricoes_p text, nr_prescricao_p bigint, nr_seq_item_p bigint, ie_laboratorio_p text, nr_seq_motivo_p bigint, ds_justificativa_p text, nm_usuario_p text, ie_inconsistencia_p INOUT text, ds_inconsistentes_p INOUT text, nr_seq_proc_interno_p bigint, nr_agrupamento_p bigint, ie_acm_sn_p text, ie_gerar_evento_p text default null, nr_seq_assinatura_p bigint default null, ie_chamada_glicemia_p text default 'N', nr_seq_horario_p bigint default null, nr_seq_prot_glic_p bigint DEFAULT NULL, cd_unidade_medida_p text default null, nr_seq_pergunta_p bigint default null, ds_componentes_p text DEFAULT NULL, nr_seq_objeto_p bigint DEFAULT NULL, ie_via_aplicacao_p text default null, nr_seq_cpoe_p bigint default null) AS $body$
DECLARE


			
/* vetor */

type vetor is table of colunas index by integer;
vetor_w			vetor;

/* horario */

dt_horario_w			timestamp;
dt_hora_atual_w			timestamp;
dt_proxima_dose_w		timestamp;
dt_validade_prescr_w	timestamp;
dt_emissao_farmacia_w	timestamp;

/* cursor */

ie_cursor_w					varchar(1) := 'N';
ie_inconsistencia_w			varchar(1);
ie_gerar_nec_disp_kit_w		varchar(1);
ie_gedipa_w					varchar(20);
nr_prescr_www				bigint;
ie_local_estoque_mat_hor_w	varchar(20);
ds_inconsistentes_w			varchar(255);
nr_prescricoes_w			varchar(4000);
ie_local_estoque_w			varchar(20);
ie_gera_lote_param_w		varchar(1) := 'S';
ie_aprazar_w				varchar(1) := 'S';
nr_prescricao_w				bigint;
TAMANHO_W					bigint;
x							bigint;
qt_item_w					bigint;
nr_prescricao_ww			bigint;
nr_prescricao_www			bigint;
nr_seq_processo_nut_w		bigint;
qt_hora_intervalo_w			bigint;
nr_sequencia_w				bigint;
nr_seq_processo_agora_w		bigint;
nr_etapa_w					bigint;
nr_seq_processo_w			bigint;
cd_setor_atendimento_w		bigint;
cd_local_estoque_baixa_w	smallint;
qt_total_dispensar_w		double precision;
nr_seq_item_w				bigint;
qt_registros_vetor_w		bigint;
nr_seq_hor_w				bigint;
qt_controle_ww				bigint;
nr_prescr_atual_w			bigint := 0;
qt_horas_apraz_w			bigint;
nr_seq_pend_pac_acao_w		bigint;
nr_seq_item_ww              bigint;
ie_regra_disp_w				prescr_material.ie_regra_disp%type;
ie_permite_antes_val_w varchar(1);

/* informacoes */

nr_seq_orig_w				bigint;
qt_dose_w					double precision;
qt_dispensar_w				double precision;
qt_dispensar_hor_w			double precision;
cd_unidade_medida_w			varchar(30);
ie_exibe_suspenso_w			varchar(10);
cd_unidade_medida_dose_w	varchar(30);
ie_gerar_lote_w				varchar(1);
ie_gerar_lote_apraza_w		varchar(1);
ie_gerar_lote_ww			varchar(1);
ie_origem_proced_w			bigint;
cont_w						bigint;
nr_seq_proc_interno_w		bigint;
nr_prescr_aux_w				bigint;
cd_material_exame_w			varchar(20);
nr_seq_classif_w			bigint;
cd_setor_pac_w				integer;
nr_prescricao_adic_w		bigint;
nr_prescricoes_ww			varchar(255);
nr_prescr_vigente_w			bigint;
cd_unid_med_consumo_w		varchar(30);
cd_motivo_baixa_w			bigint;

/* insert */

nr_seq_horario_w			bigint;

/* evento */

ie_alteracao_w				smallint := 15;
ie_data_proc_w				varchar(15);
dt_validade_w				timestamp;
dt_fim_w					timestamp;
dt_ini_w					timestamp;
ie_gerar_necessidade_disp_w	varchar(15);
cd_setor_prescr_w			integer;
cd_estab_prescr_w			smallint;
ie_agrupador_w				smallint;
cd_local_estoque_w			smallint;
nr_agrupamento_w			double precision;
ie_data_lib_prescr_w		varchar(15);
ie_aprazar_suspensos_w		varchar(10);
ie_classif_urgente_w		varchar(3);
ie_padronizado_w			varchar(1);
ie_classif_nao_padrao_w		varchar(15);
ie_controlado_w				varchar(1);
dt_limite_agora_w			timestamp;
dt_limite_especial_w		timestamp;
dt_liberacao_w				timestamp;
qt_min_agora_w				bigint;
qt_min_especial_w			bigint;
cd_estabelecimento_w		bigint;
qt_dose_hor_w				double precision;
cd_unid_med_dose_hor_w		varchar(30);
cd_material_w				integer;
ie_aprazar_mat_proc_w		varchar(1);
nr_prescr_w					bigint;
nr_prescr_ww				bigint;
ie_aprazar_agrupados_w		varchar(1);
ie_aprazar_ivc_adep_w		varchar(1);
ie_acm_w					varchar(1);
ie_sn_w						varchar(1);
ie_acm_sn_w					varchar(1);
ie_liberado_w				varchar(1);
ie_agora_impressao_w		varchar(15);
nr_seq_turno_hor_ag_w		bigint;
hr_turno_agora_w			varchar(15);
qt_min_antes_atend_w		integer;
cd_refeicao_w				varchar(15);
nr_seq_dieta_w				bigint;
nr_etapa_item_w				bigint;
ie_desagrupa_proced_w		varchar(1);
nr_seq_classif_param_w		bigint;
ie_ver_check_adep_w			varchar(1);
ie_gerar_classif_agora_w	varchar(1);
ie_agrupar_acm_sn_w			varchar(1);
nr_seq_hor_glic_w			bigint;
ie_gerar_serv_supl_w		varchar(1);
ie_gera_nutricao_w			varchar(1);
hr_final_turno_agora_w		varchar(15);
dt_inicio_prescr_w			timestamp;

/*  Gasoterapia  -  Guilherme Pereira 04/11/2011  */

nr_prescricao_gas_w			bigint;
nr_sequencia_gas_w			bigint;
qt_gasoterapia_gas_w		bigint;
cd_unidade_medida_gas_w		varchar(15);
ie_inicio_w					varchar(15);
nr_seq_gaso_hor_w			bigint;
nr_etapa_gas_w				bigint;
nr_seq_lote_w				bigint;
nr_ultima_prescr_w			bigint;
ie_horario_adep_w			varchar(1);
ie_gera_integracao_w		varchar(1);
cd_perfil_w					integer	:= obter_perfil_ativo;
ie_entrou_cond_w			varchar(1) 	:= 'N';
qt_dose_convertida_w		prescr_mat_hor.qt_dose%type;
cd_um_consumo_w				prescr_mat_hor.cd_unid_med_hor%type;
ie_gerar_proc_gedipa_job_w	varchar(1);
ie_gera_disp_acm_sn_w		varchar(1);
ie_define_agora_w			regra_tempo_disp.ie_define_agora%type;
ie_lancou_iag_w				varchar(1);
ie_gas_separada_w			varchar(1);

ds_erro_w					varchar(255);
ds_erro2_w					varchar(255);
qt_max_prescricao_w			double precision;
cd_unidade_medida_consumo_w	varchar(30);
cd_unid_med_limite_w		varchar(30);
qt_limite_pessoa_w			double precision;
ie_dose_limite_w			varchar(15);

qt_fase_npt_w 				nut_pac.qt_fase_npt%type;
qt_tempo_etapa_w			nut_pac.qt_tempo_etapa%type;
qt_hora_inf_w				nut_pac.qt_hora_inf%type;
ie_aprazar_fase_npt_w		varchar(1);
dt_horario_npt_w			timestamp;				
ie_tipo_cons_w				varchar(1);
qt_dose_limite_w			double precision;
cd_unidade_medida_limte_w	varchar(15);
cd_pessoa_fisica_w			atendimento_paciente.cd_pessoa_fisica%type;
ie_kit_gerado_w				prescr_material.ie_kit_gerado%type;
ie_setor_gedipa_w			varchar(1);
ie_gerar_processo_w			varchar(1) := 'S';
ie_item_susbtituido_w		varchar(1);
ie_gera_sem_certificado_w	varchar(1);
ie_imprimir_acm_sn_w		varchar(1);
ie_grava_log_rastr_w		varchar(1);
dt_inicio_prescr_cpoe_w     cpoe_material.dt_liberacao%type;
dt_fim_prescr_cpoe_w        cpoe_material.dt_fim%type;


c01 CURSOR FOR
SELECT	a.nr_prescricao nr_prescricao, /* dieta oral */
	
		'N' ie_sn,
		'N' ie_acm,
		c.cd_refeicao,
		c.nr_seq_dieta
from	prescr_dieta_hor c,
		prescr_medica a
where	c.nr_prescricao = a.nr_prescricao
and		((coalesce(ie_aprazar_suspensos_w,'S') = 'S') or (coalesce(c.dt_suspensao::text, '') = ''))
and		c.cd_refeicao = cd_item_p
and		Obter_se_horario_liberado(c.dt_lib_horario, c.dt_horario) = 'S'
and		obter_se_prescr_lib_adep(a.dt_liberacao_medico, a.dt_liberacao, a.dt_liberacao_farmacia, ie_data_lib_prescr_w) = 'S'
and		obter_se_exibir_rep_adep_setor(cd_setor_pac_w,a.cd_setor_atendimento,coalesce(a.ie_adep,'S')) = 'S'
and		dt_horario_w between a.dt_inicio_prescr and a.dt_validade_prescr
--and	a.dt_liberacao is not null
--and	((nr_prescricoes_p is null) or (obter_se_contido(a.nr_prescricao, '(' || nr_prescricoes_p || ')') = 'S'))
and		a.dt_validade_prescr > dt_validade_w
and		a.nr_atendimento = nr_atendimento_p
and		a.nr_prescricao	= vetor_w[x].nr_prescricao_w
and		ie_tipo_item_p = 'D'
group by
	a.nr_prescricao,	
	'N',
	c.cd_refeicao,
	c.nr_seq_dieta

union

select	a.nr_prescricao nr_prescricao,
		'N' ie_sn,
		'N' ie_acm,
		c.cd_refeicao,
		c.nr_seq_dieta
from	prescr_medica a,
		prescr_dieta b,
		prescr_dieta_hor c
where	c.nr_prescricao = a.nr_prescricao
and		c.nr_prescricao	= b.nr_prescricao
and		c.nr_seq_dieta	= b.nr_sequencia
and		((coalesce(ie_aprazar_suspensos_w,'S') = 'S') or (coalesce(c.dt_suspensao::text, '') = ''))
and		Obter_se_horario_liberado(c.dt_lib_horario, c.dt_horario) = 'S'
and		to_char(b.cd_dieta) = cd_item_p
and		coalesce(c.cd_refeicao::text, '') = ''
and		obter_se_prescr_lib_adep(a.dt_liberacao_medico, a.dt_liberacao, a.dt_liberacao_farmacia, ie_data_lib_prescr_w) = 'S'
and		obter_se_exibir_rep_adep_setor(cd_setor_pac_w,a.cd_setor_atendimento,coalesce(a.ie_adep,'S')) = 'S'
and		dt_horario_w between a.dt_inicio_prescr and a.dt_validade_prescr
and		a.dt_validade_prescr > dt_validade_w
--and	a.dt_liberacao is not null
--and	((nr_prescricoes_p is null) or (obter_se_contido(a.nr_prescricao, '(' || nr_prescricoes_p || ')') = 'S'))
and		a.nr_atendimento = nr_atendimento_p
and		a.nr_prescricao	= vetor_w[x].nr_prescricao_w
and		ie_tipo_item_p = 'D'
group by
	a.nr_prescricao,	
	'N',
	c.cd_refeicao,
	c.nr_seq_dieta	
order by
	1, 2;
	
c02 CURSOR FOR
SELECT	a.nr_prescricao nr_prescricao, /* suplemento oral */
		b.nr_sequencia nr_seq_item,
		b.cd_local_estoque,
		b.nr_agrupamento,
		b.cd_material,
		b.cd_unidade_medida,
		'N' ie_sn,
		'N' ie_acm,
		b.qt_total_dispensar
from	prescr_mat_hor c,
		prescr_material b,
		prescr_medica a
where	c.nr_prescricao = b.nr_prescricao
and		c.nr_seq_material = b.nr_sequencia
and		b.nr_prescricao = a.nr_prescricao
and		b.ie_agrupador in (12)
--and	obter_se_prescr_adep(a.nr_prescricao, b.nr_sequencia, nr_prescricao_p, nr_seq_item_p, nr_prescricoes_p) = 'S'
and		b.cd_material = cd_item_p
and		((coalesce(ie_aprazar_suspensos_w,'S') = 'S') or (coalesce(b.dt_suspensao::text, '') = ''))
and		coalesce(b.cd_intervalo,'XPTO') = coalesce(cd_intervalo_p,'XPTO')
and		coalesce(b.qt_dose,1) = coalesce(qt_item_p,coalesce(b.qt_dose,1))
and		Obter_se_horario_liberado(c.dt_lib_horario, c.dt_horario) = 'S'
and		((dt_horario_w between a.dt_inicio_prescr and a.dt_validade_prescr) or
		 ((dt_horario_w between a.dt_prescricao and a.dt_validade_prescr) and ((coalesce(ie_acm,'N') = 'S') or (coalesce(ie_se_necessario,'N') = 'S'))))
and		obter_se_prescr_lib_adep(a.dt_liberacao_medico, a.dt_liberacao, a.dt_liberacao_farmacia, ie_data_lib_prescr_w) = 'S'
and		obter_se_exibir_rep_adep_setor(cd_setor_pac_w,a.cd_setor_atendimento,coalesce(a.ie_adep,'S')) = 'S'
and		a.dt_validade_prescr > dt_validade_w
and		a.nr_atendimento = nr_atendimento_p
and		a.nr_prescricao	= vetor_w[x].nr_prescricao_w
and		ie_tipo_item_p = 'S'
group by
	a.nr_prescricao,
	b.nr_sequencia,
	b.cd_local_estoque,
	b.nr_agrupamento,
	b.qt_total_dispensar,
	b.cd_material,
	b.cd_unidade_medida,
	'N'
order by
	1, 2;

c03 CURSOR FOR
SELECT	a.nr_prescricao nr_prescricao, /* medicamentos */
		b.nr_sequencia nr_seq_item,
		b.cd_local_estoque,
		b.nr_agrupamento,
		b.cd_material,
		b.cd_unidade_medida,
		coalesce(b.ie_se_necessario,'N') ie_sn,
		coalesce(b.ie_acm,'N') ie_acm,
		b.qt_total_dispensar,
		b.dt_proxima_dose,
		obter_ocorrencia_intervalo(b.cd_intervalo,24,'H'),
		a.dt_validade_prescr,
		coalesce(b.ie_regra_disp,'S'),
		coalesce(ie_kit_gerado,'S')
from	prescr_mat_hor c,
		prescr_medica a,
		prescr_material b
where	c.nr_prescricao = b.nr_prescricao
and		c.nr_seq_material = b.nr_sequencia
and		b.nr_prescricao = a.nr_prescricao
and		b.ie_agrupador = 1
and		((((ie_aprazar_agrupados_w = 'N') or (ie_acm_sn_p = 'N'))  and (a.nr_prescricao	= vetor_w[x].nr_prescricao_w)) or
		 ((ie_aprazar_agrupados_w <> 'N') and ((obter_se_prescr_adep(a.nr_prescricao, b.nr_sequencia, nr_prescr_w, nr_seq_item_p, nr_prescr_www||','||nr_prescr_ww) = 'S') or ((coalesce(ie_se_necessario,'N') = 'S') or (coalesce(ie_acm,'N') = 'S')))))
and		((((nr_ultima_prescr_w = vetor_w[x].nr_prescricao_w AND a.nr_prescricao	= vetor_w[x].nr_prescricao_w) or (ie_acm_sn_p = 'N')) and (ie_aprazar_agrupados_w <> 'N')) or (ie_aprazar_agrupados_w = 'N'))
and		((coalesce(cd_unidade_medida_p,'XPTO') = 'XPTO') or (cd_unidade_medida_p = c.cd_unidade_medida_dose))
and		coalesce(b.cd_intervalo,'XPTO') = coalesce(cd_intervalo_p,'XPTO')
and		((coalesce(nr_seq_objeto_p,0)	<> 3558) or (a.nr_prescricao		= nr_prescricao_p))	
and		b.cd_material = cd_item_p
and		obter_se_acm_sn(b.ie_acm, b.ie_se_necessario) = ie_acm_sn_p
and		((coalesce(ie_aprazar_suspensos_w,'S') = 'S') or (coalesce(b.dt_suspensao::text, '') = ''))
and		coalesce(b.qt_dose,1) = coalesce(qt_item_p,coalesce(b.qt_dose,1))
and		(((coalesce(nr_agrupamento_p,0) > 0) and (b.nr_agrupamento = nr_agrupamento_p)) or
		 ((coalesce(nr_agrupamento_p,0) = 0) and (obter_se_agrupa_composto(a.nr_prescricao, b.nr_sequencia, b.nr_agrupamento, b.cd_material) = 'N')))
and		Obter_se_horario_liberado(c.dt_lib_horario, c.dt_horario) = 'S'
and		((dt_horario_w between a.dt_inicio_prescr and a.dt_validade_prescr) or 
            ((dt_horario_w between a.dt_prescricao and a.dt_validade_prescr) and ((coalesce(ie_acm,'N') = 'S') or (coalesce(ie_se_necessario,'N') = 'S'))) or
            (((ie_permite_antes_val_w = 'T') or (ie_permite_antes_val_w = 'S' and (coalesce(ie_acm,'N') = 'S' or coalesce(ie_se_necessario,'N') = 'S'))) and dt_horario_w < a.dt_validade_prescr) or (ie_tipo_item_p = 'M' and (nr_seq_cpoe_p IS NOT NULL AND nr_seq_cpoe_p::text <> '') and nr_seq_cpoe_p <> 0 and
                dt_horario_w between dt_inicio_prescr_cpoe_w and coalesce(dt_fim_prescr_cpoe_w, a.dt_validade_prescr)))
and		obter_se_prescr_lib_adep(coalesce(a.dt_liberacao_medico, b.dt_lib_material), coalesce(a.dt_liberacao,b.dt_lib_material), coalesce(a.dt_liberacao_farmacia, b.dt_lib_farmacia), ie_data_lib_prescr_w) = 'S'
and		obter_se_exibir_rep_adep_setor(cd_setor_pac_w,a.cd_setor_atendimento,coalesce(a.ie_adep,'S')) = 'S'
and		a.dt_validade_prescr > dt_validade_w
and		a.nr_prescricao	= vetor_w[x].nr_prescricao_w
and		a.nr_atendimento = nr_atendimento_p
and		((coalesce(ie_via_aplicacao_p::text, '') = '') or (coalesce(b.ie_via_aplicacao, coalesce(ie_via_aplicacao_p, 'XPTO')) = ie_via_aplicacao_p))
and		ie_tipo_item_p in ('M', 'IAH')
and 	((coalesce(b.nr_seq_mat_cpoe, 0) = coalesce(nr_seq_cpoe_p, 0)) or (coalesce(nr_seq_cpoe_p::text, '') = ''))
and		coalesce(b.nr_seq_substituto::text, '') = ''
group by
	a.nr_prescricao,
	b.nr_sequencia,
	b.cd_local_estoque,
	b.nr_agrupamento,
	b.cd_material,
	b.qt_total_dispensar,
	b.cd_unidade_medida,
	coalesce(b.ie_se_necessario,'N'), 
	obter_ocorrencia_intervalo(b.cd_intervalo,24,'H'),
	a.dt_validade_prescr,
	coalesce(b.ie_acm,'N'),
	b.dt_proxima_dose,
	coalesce(b.ie_regra_disp,'S'),
	coalesce(ie_kit_gerado,'S')
order by
	a.nr_prescricao desc, 2;

c04 CURSOR FOR
SELECT	a.nr_prescricao nr_prescricao, /* materiais */
		b.nr_sequencia nr_seq_item,
		b.cd_local_estoque,
		b.nr_agrupamento,
		b.cd_material,
		b.cd_unidade_medida,
		'N' ie_sn,
		'N' ie_acm
from	prescr_mat_hor c,
		prescr_material b,
		prescr_medica a
where	c.nr_prescricao = b.nr_prescricao
and		c.nr_seq_material = b.nr_sequencia
and		b.nr_prescricao = a.nr_prescricao
and		b.ie_agrupador in (2)
--and	obter_se_prescr_adep(a.nr_prescricao, b.nr_sequencia, nr_prescricao_p, nr_seq_item_p, nr_prescricoes_p) = 'S'
and		b.cd_material = cd_item_p
and		((coalesce(ie_aprazar_suspensos_w,'S') = 'S') or (coalesce(b.dt_suspensao::text, '') = ''))
and		coalesce(b.cd_intervalo,'XPTO') = coalesce(cd_intervalo_p,'XPTO')
and		coalesce(b.qt_dose,1) = coalesce(qt_item_p,coalesce(b.qt_dose,1))
and		Obter_se_horario_liberado(c.dt_lib_horario, c.dt_horario) = 'S'
and		obter_se_prescr_lib_adep(a.dt_liberacao_medico, a.dt_liberacao, a.dt_liberacao_farmacia, ie_data_lib_prescr_w) = 'S'
and		obter_se_exibir_rep_adep_setor(cd_setor_pac_w,a.cd_setor_atendimento,coalesce(a.ie_adep,'S')) = 'S'
and		a.dt_validade_prescr > dt_validade_w
and		a.nr_atendimento = nr_atendimento_p
and		dt_horario_w between a.dt_inicio_prescr and a.dt_validade_prescr
and		a.nr_prescricao	= vetor_w[x].nr_prescricao_w
and		ie_tipo_item_p = 'MAT'
group by
	a.nr_prescricao,
	b.nr_sequencia,
	b.cd_local_estoque,
	b.nr_agrupamento,
	b.cd_material,
	b.cd_unidade_medida,
	'N'
order by
	1, 2;

c05 CURSOR FOR
SELECT	a.nr_prescricao nr_prescricao, /* procedimentos e controles de glicemia */
		b.nr_sequencia nr_seq_item,
		b.nr_agrupamento,
		'N' ie_sn,
		'N' ie_acm
from	prescr_proc_hor c,
		prescr_procedimento b,
		prescr_medica a
where	c.nr_prescricao = b.nr_prescricao
and		c.nr_seq_procedimento = b.nr_sequencia
and		b.nr_prescricao = a.nr_prescricao
and		obter_se_exibir_adep_suspensos(b.dt_suspensao, ie_exibe_suspenso_w) = 'S'
and		coalesce(nr_seq_prot_glic,0) = coalesce(nr_seq_prot_glic_p,0)
and		coalesce(b.nr_seq_proc_interno,0) = coalesce(nr_seq_proc_interno_p, 0)
and		((((b.nr_sequencia	= nr_Seq_item_p AND b.nr_prescricao	= nr_prescricao_p) or (ie_tipo_item_p	<> 'P')) and (ie_desagrupa_proced_w = 'S')) or (ie_desagrupa_proced_w  = 'N')) 		
and	((a.nr_prescricao = nr_prescricao_www AND ie_aprazar_ivc_adep_w = 'S') or 
	 (((a.nr_prescricao	= vetor_w[x].nr_prescricao_w) or  
	   (exists (
		SELECT	1
		from	prescr_proc_hor d,
			prescr_procedimento e
		where	d.nr_prescricao 		= e.nr_prescricao
		and	d.nr_seq_procedimento		= e.nr_sequencia
		and	b.nr_prescricao 		= a.nr_prescricao
		and	coalesce(d.ie_situacao,'A')		= 'A'	
		and	e.cd_procedimento 		= cd_item_p
		and	coalesce(e.nr_seq_proc_interno,0) 	= coalesce(nr_seq_proc_interno_p,0)
		and	coalesce(e.cd_intervalo,'XPTO')	= coalesce(cd_intervalo_p,'XPTO')
		and	coalesce(e.qt_procedimento,1) 	= coalesce(qt_item_p,coalesce(b.qt_procedimento,1))
		and	((coalesce(b.nr_seq_exame::text, '') = '') or (ie_tipo_item_p in ('G','C')))
		and	Obter_se_horario_liberado(d.dt_lib_horario, d.dt_horario) = 'S'))) and (ie_aprazar_ivc_adep_w = 'N'))) 	 
and		b.cd_procedimento = cd_item_p
and		obter_se_acm_sn(b.ie_acm, b.ie_se_necessario) = ie_acm_sn_p
and		((coalesce(ie_aprazar_suspensos_w,'S') = 'S') or (coalesce(b.dt_suspensao::text, '') = ''))
and		coalesce(b.cd_intervalo,'XPTO') = coalesce(cd_intervalo_p,'XPTO')
and		coalesce(b.qt_procedimento,1) = coalesce(qt_item_p,coalesce(b.qt_procedimento,1))
and		((coalesce(b.nr_seq_exame::text, '') = '' and ie_laboratorio_p = 'N') or ((b.nr_seq_exame IS NOT NULL AND b.nr_seq_exame::text <> '') and ie_laboratorio_p = 'S') or (ie_tipo_item_p in ('G','C')))		 
and	((((ie_tipo_item_p in ('G','C')) or (ie_aprazar_agrupados_w <> 'N')) and
	  ((dt_horario_w between dt_ini_w and dt_fim_w) or 
	   ((dt_horario_w between a.dt_prescricao and dt_fim_w) and ((coalesce(ie_acm,'N') = 'S') or (coalesce(ie_se_necessario,'N') = 'S'))))) or
	 ((ie_tipo_item_p not in ('G','C')) and
	  ((dt_horario_w between a.dt_inicio_prescr and a.dt_validade_prescr) or 
	   ((dt_horario_w between a.dt_prescricao and a.dt_validade_prescr) and ((coalesce(ie_acm,'N') = 'S') or (coalesce(ie_se_necessario,'N') = 'S'))))))	   
and	(((not exists (
		select	distinct 1
		from	prescr_proc_hor d,
				prescr_procedimento e
		where	Obter_se_horario_liberado(d.dt_lib_horario, d.dt_horario) = 'S'
		and		d.dt_horario = dt_horario_w
		and		coalesce(d.ie_horario_especial,'N') = 'N'
		and		coalesce(d.ie_situacao,'A')		= 'A'	
		and		coalesce(e.qt_procedimento,1) 	= coalesce(qt_item_p,coalesce(b.qt_procedimento,1))
		and		coalesce(e.cd_intervalo,'XPTO')	= coalesce(cd_intervalo_p,'XPTO')
		and		coalesce(e.nr_seq_proc_interno,0) 	= coalesce(nr_seq_proc_interno_p,0)
		and		e.cd_procedimento 		= cd_item_p
		and		d.nr_seq_procedimento	= e.nr_sequencia
		and		d.nr_prescricao 		= e.nr_prescricao
		and		e.nr_prescricao 		= a.nr_prescricao)) and (ie_tipo_item_p in ('G','C')) and (nr_prescr_vigente_w = a.nr_prescricao)) or
	 ((vetor_w[x].nr_prescricao_w = a.nr_prescricao) and (ie_tipo_item_p not in ('G','C'))) or (ie_aprazar_agrupados_w = 'N') or (ie_aprazar_agrupados_w = 'T' AND nr_prescr_vigente_w = a.nr_prescricao))	 	
and		((a.nr_seq_pend_pac_acao IS NOT NULL AND a.nr_seq_pend_pac_acao::text <> '') or (Obter_se_horario_liberado(c.dt_lib_horario, c.dt_horario) = 'S'))
and		((a.nr_seq_pend_pac_acao IS NOT NULL AND a.nr_seq_pend_pac_acao::text <> '') or ((obter_data_lib_proc_adep(a.dt_liberacao, a.dt_liberacao_medico, ie_data_proc_w) IS NOT NULL AND (obter_data_lib_proc_adep(a.dt_liberacao, a.dt_liberacao_medico, ie_data_proc_w))::text <> '')))
and		obter_se_exibir_rep_adep_setor(cd_setor_pac_w,a.cd_setor_atendimento,coalesce(a.ie_adep,'S')) = 'S'
and		coalesce(a.dt_validade_prescr,a.dt_inicio_prescr + 24/24) > dt_validade_w
and		PKG_DATE_UTILS.get_DateTime(a.dt_inicio_prescr, coalesce(a.dt_primeiro_horario, PKG_DATE_UTILS.get_Time('00:00:00'))) between a.dt_inicio_prescr and a.dt_validade_prescr
and		a.nr_atendimento = nr_atendimento_p
and 	ie_tipo_item_p in ('P','G','C','I','HM') -- A consulta sempre comeca de baixo pra cima.
and		((coalesce(ds_componentes_p::text, '') = '') or (ds_componentes_p = obter_mat_med_assoc_proc(b.nr_prescricao, b.nr_sequencia, 'S')))
group by
	a.nr_prescricao,
	b.nr_sequencia,
	b.nr_agrupamento,
	'N'
order by
	1, 2;

c06 CURSOR FOR
SELECT	a.nr_prescricao nr_prescricao, /* recomendacoes */
		b.nr_sequencia nr_seq_item,
		coalesce(b.ie_se_necessario,'N') ie_sn,
		coalesce(b.ie_acm,'N') ie_acm
from	prescr_rec_hor c,
		prescr_recomendacao b,
		prescr_medica a
where	c.nr_prescricao = b.nr_prescricao
and		c.nr_seq_recomendacao = b.nr_sequencia
and		b.nr_prescricao = a.nr_prescricao

and		((ie_data_lib_prescr_w = 'F') or (obter_se_prescr_lib_adep(a.dt_liberacao_medico, a.dt_liberacao, a.dt_liberacao_farmacia, ie_data_lib_prescr_w) = 'S'))
and		obter_se_exibir_rep_adep_setor(cd_setor_pac_w,a.cd_setor_atendimento,coalesce(a.ie_adep,'S')) = 'S'
and		a.dt_validade_prescr > dt_validade_w
and		a.nr_atendimento = nr_atendimento_p
--and	obter_se_prescr_adep(a.nr_prescricao, b.nr_sequencia, nr_prescricao_p, nr_seq_item_p, nr_prescricoes_p) = 'S'
and		((((ie_aprazar_agrupados_w = 'N') or ((coalesce(b.ie_se_necessario,'N') = 'N') and (coalesce(ie_acm,'N') = 'N')))  and (a.nr_prescricao	= vetor_w[x].nr_prescricao_w)) or
		 ((ie_aprazar_agrupados_w <> 'N') and ((obter_se_prescr_adep(a.nr_prescricao, b.nr_sequencia, '', '', nr_prescricoes_p) = 'S') or ((coalesce(b.ie_se_necessario,'N') = 'S') or (coalesce(ie_acm,'N') = 'S')))))
and		((((nr_ultima_prescr_w = vetor_w[x].nr_prescricao_w AND a.nr_prescricao	= vetor_w[x].nr_prescricao_w) or (coalesce(ie_acm_sn_p, 'N') = 'N')) and (ie_aprazar_agrupados_w <> 'N')) or (ie_aprazar_agrupados_w = 'N'))
and		coalesce(to_char(b.cd_recomendacao),b.ds_recomendacao) = cd_item_p
and		coalesce(b.cd_intervalo,'XPTO') = coalesce(cd_intervalo_p,'XPTO')
and		obter_se_acm_sn(b.ie_acm, b.ie_se_necessario) = ie_acm_sn_p
and		((coalesce(ie_aprazar_suspensos_w,'S') = 'S') or (coalesce(b.dt_suspensao::text, '') = ''))
and		coalesce(b.qt_recomendacao,1) = coalesce(qt_item_p,coalesce(b.qt_recomendacao,1))
and		Obter_se_horario_liberado(c.dt_lib_horario, c.dt_horario) = 'S'
and		dt_horario_w between a.dt_inicio_prescr and a.dt_validade_prescr
and		a.nr_prescricao	= vetor_w[x].nr_prescricao_w
and		ie_tipo_item_p = 'R'
group by
	a.nr_prescricao,
	b.nr_sequencia,
	coalesce(b.ie_se_necessario,'N'),
	coalesce(b.ie_acm,'N')
order by
	a.nr_prescricao desc, 2;
	
/* sae */

c07 CURSOR FOR
SELECT	/*+ index (B, PEPREPR_PEPRESC_FK_I) */		a.nr_prescricao nr_seq_prescricao,
		b.nr_sequencia nr_seq_item,	
		a.nr_sequencia nr_prescricao_sae,
		'N' ie_sn,
		'N' ie_acm
from	pe_prescr_proc_hor c,
		pe_prescr_proc b,
		pe_prescricao a
where	c.nr_seq_pe_proc = b.nr_sequencia
and		b.nr_seq_prescr = a.nr_sequencia
and		coalesce(b.ie_adep,'N') in ('S','M')
and		obter_se_prescr_adep(a.nr_sequencia, b.nr_sequencia, nr_prescricao_p, nr_seq_item_p, nr_prescricoes_p) = 'S'
and		b.nr_seq_proc = cd_item_p
and		((coalesce(ie_aprazar_suspensos_w,'S') = 'S') or (coalesce(b.dt_suspensao::text, '') = ''))
and		coalesce(b.cd_intervalo,'XPTO') = coalesce(cd_intervalo_p,'XPTO')
and		(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
and		dt_horario_w between a.dt_inicio_prescr and a.dt_validade_prescr
and		a.dt_validade_prescr > dt_validade_w
and		a.nr_atendimento = nr_atendimento_p
and		a.nr_sequencia	= vetor_w[x].nr_prescricao_w
and		ie_tipo_item_p = 'E'
group by
	a.nr_sequencia,
	b.nr_sequencia,
	a.nr_prescricao,
	'N'
order by
	1, 2;

c08 CURSOR FOR
SELECT	a.nr_prescricao nr_prescricao, /* Itens associados */
		b.nr_sequencia nr_seq_item,
		b.cd_local_estoque,
		b.nr_agrupamento,
		b.cd_material,
		b.cd_unidade_medida_dose,
		b.qt_dose,
		b.cd_unidade_medida,
		'N' ie_sn,
		'N' ie_acm,
		c.ie_agrupador
from	prescr_mat_hor c,
		prescr_material b,
		prescr_medica a
where	c.nr_prescricao = b.nr_prescricao
and		c.nr_seq_material = b.nr_sequencia
and		b.nr_prescricao = a.nr_prescricao
and		(((b.ie_agrupador = 5) and ((coalesce(b.ie_checar_adep, 'N') = 'S') or (ie_ver_check_adep_w = 'N')))
		or ((b.ie_agrupador = 15) and coalesce(c.ie_adep,'S') = 'S'))
and		b.cd_material = cd_item_p
and		coalesce(b.cd_intervalo,'XPTO') = coalesce(cd_intervalo_p,'XPTO')
and		((coalesce(ie_aprazar_suspensos_w,'S') = 'S') or (coalesce(b.dt_suspensao::text, '') = ''))
and		coalesce(b.qt_dose,1) = coalesce(qt_item_p,coalesce(b.qt_dose,1))
and		Obter_se_horario_liberado(c.dt_lib_horario, c.dt_horario) = 'S'
and		obter_se_prescr_lib_adep(a.dt_liberacao_medico, a.dt_liberacao, a.dt_liberacao_farmacia, ie_data_lib_prescr_w) = 'S'
and		obter_se_exibir_rep_adep_setor(cd_setor_pac_w,a.cd_setor_atendimento,coalesce(a.ie_adep,'S')) = 'S'
and		a.dt_validade_prescr > dt_validade_w
and		dt_horario_w between a.dt_inicio_prescr and a.dt_validade_prescr
and		a.nr_atendimento = nr_atendimento_p
and		a.nr_prescricao	= vetor_w[x].nr_prescricao_w
and		ie_tipo_item_p = 'IA'
group by
	a.nr_prescricao,
	b.nr_sequencia,
	b.cd_local_estoque,
	b.nr_agrupamento,
	b.cd_material,
	b.cd_unidade_medida_dose,
	b.qt_dose,
	b.cd_unidade_medida,
	'N',
	c.ie_agrupador
order by
	1, 2;

c09 CURSOR FOR
SELECT	a.nr_prescricao nr_prescricao, /* Itens associados CCG*/
		b.nr_sequencia nr_seq_item,
		b.cd_local_estoque,
		b.nr_agrupamento,
		b.cd_material,
		b.cd_unidade_medida_dose,
		b.qt_dose,
		b.cd_unidade_medida,
		'N' ie_sn,
		'N' ie_acm,
		d.cd_unidade_medida_consumo,
		b.ie_regra_disp,
		b.ie_kit_gerado
from	prescr_procedimento c,
		prescr_material b,
		prescr_medica a,
		material d
where	b.nr_prescricao = c.nr_prescricao
and		b.nr_sequencia_proc = c.nr_sequencia
and		c.nr_prescricao = a.nr_prescricao
and		b.nr_prescricao = a.nr_prescricao
and		b.cd_material   = d.cd_material
and		b.ie_agrupador in (5)
and		b.cd_material = cd_item_p
and		coalesce(nr_seq_prot_glic,0) = coalesce(nr_seq_prot_glic_p,0)
and		coalesce(b.cd_intervalo,'XPTO') = coalesce(cd_intervalo_p,'XPTO')
and		((dt_horario_w between a.dt_inicio_prescr and a.dt_validade_prescr) or
			((dt_horario_w between a.dt_prescricao and a.dt_validade_prescr) and ((coalesce(b.ie_acm,'N') = 'S') or (coalesce(b.ie_se_necessario,'N') = 'S'))) or
            (((ie_permite_antes_val_w = 'T') or (ie_permite_antes_val_w = 'S' and (coalesce(b.ie_acm,'N') = 'S' or coalesce(b.ie_se_necessario,'N') = 'S'))) and dt_horario_w < a.dt_validade_prescr))
and		obter_se_exibir_rep_adep_setor(cd_setor_pac_w,a.cd_setor_atendimento,coalesce(a.ie_adep,'S')) = 'S'
and		a.dt_validade_prescr > dt_validade_w
and		a.nr_atendimento = nr_atendimento_p
and		ie_tipo_item_p = 'IAG'
and		((((ie_aprazar_agrupados_w = 'N') or (coalesce(ie_acm_sn_p, 'N') = 'N'))  and (a.nr_prescricao	= vetor_w[x].nr_prescricao_w)) or
		 ((ie_aprazar_agrupados_w <> 'N') and ((obter_se_prescr_adep(a.nr_prescricao, b.nr_sequencia, nr_prescr_w, nr_seq_item_p, nr_prescr_www||','||nr_prescr_ww) = 'S') or ((coalesce(b.ie_se_necessario,'N') = 'S') or (coalesce(b.ie_acm,'N') = 'S')))))
and		((((nr_ultima_prescr_w = vetor_w[x].nr_prescricao_w AND a.nr_prescricao	= vetor_w[x].nr_prescricao_w) or (coalesce(ie_acm_sn_p, 'N') = 'N')) and (ie_aprazar_agrupados_w <> 'N')) or (ie_aprazar_agrupados_w = 'N'))
and		obter_se_prescr_adep(c.nr_prescricao, b.nr_sequencia, nr_prescricao_p, nr_seq_item_p, nr_prescricoes_p) = 'S'		 
and		a.nr_prescricao	= vetor_w[x].nr_prescricao_w
group by
	a.nr_prescricao,
	b.nr_sequencia,
	b.cd_local_estoque,
	b.nr_agrupamento,
	b.cd_material,
	b.cd_unidade_medida_dose,
	b.qt_dose,
	b.cd_unidade_medida,
	'N',
	d.cd_unidade_medida_consumo,
	b.ie_regra_disp,
	b.ie_kit_gerado
order by
	1, 2;
	
c10 CURSOR FOR
SELECT	a.nr_prescricao nr_prescricao, /* SNE */
		b.nr_sequencia nr_seq_item,
		b.cd_local_estoque,
		b.nr_agrupamento,
		b.cd_material,
		b.cd_unidade_medida,
		'N' ie_sn,
		'N' ie_acm,
		b.qt_total_dispensar
from
		prescr_material b,
		prescr_medica a
where 	--c.nr_prescricao = b.nr_prescricao
--and	c.nr_seq_material = b.nr_sequencia
		b.nr_prescricao = a.nr_prescricao
and		b.ie_agrupador in (8)
--and	obter_se_prescr_adep(a.nr_prescricao, b.nr_sequencia, nr_prescricao_p, nr_seq_item_p, nr_prescricoes_p) = 'S'
and		b.cd_material = cd_item_p
and		((coalesce(ie_aprazar_suspensos_w,'S') = 'S') or
        ((coalesce(b.dt_suspensao::text, '') = '') and ((coalesce(b.nr_seq_dieta_cpoe::text, '') = '') or (coalesce(cpoe_obter_dt_suspensao(b.nr_seq_dieta_cpoe, 'N')::text, '') = ''))))
and		coalesce(b.cd_intervalo,'XPTO') = coalesce(cd_intervalo_p,'XPTO')
and		coalesce(b.qt_dose,1) = coalesce(qt_item_p,coalesce(b.qt_dose,1))
and		((dt_horario_w between a.dt_inicio_prescr and a.dt_validade_prescr) or 
		 ((dt_horario_w between a.dt_prescricao and a.dt_validade_prescr) and ((coalesce(ie_acm,'N') = 'S') or (coalesce(ie_se_necessario,'N') = 'S'))))
and		a.dt_validade_prescr > dt_validade_w
and		obter_se_prescr_lib_adep(a.dt_liberacao_medico, a.dt_liberacao, a.dt_liberacao_farmacia, ie_data_lib_prescr_w) = 'S'
and		obter_se_exibir_rep_adep_setor(cd_setor_pac_w,a.cd_setor_atendimento,coalesce(a.ie_adep,'S')) = 'S'
and		a.nr_atendimento = nr_atendimento_p
and		a.nr_prescricao	= vetor_w[x].nr_prescricao_w
and		ie_tipo_item_p = 'SNE'
group by
	a.nr_prescricao,
	b.nr_sequencia,
	b.cd_local_estoque,
	b.nr_agrupamento,
	b.cd_material,
	b.qt_total_dispensar,
	b.cd_unidade_medida,
	'N'	
order by
	1, 2;
	
c11 CURSOR FOR
	SELECT	nr_sequencia,
			ie_classif_urgente,
			ie_controlado,
			ie_padronizado
	from	classif_lote_disp_far
	where	cd_estabelecimento = cd_estabelecimento_w
	and		ie_situacao = 'A'
	order by ie_classif_urgente,
			ie_controlado desc,
			ie_padronizado desc;
--- Guilherme Pereira 04/11/2011		
c12 CURSOR FOR
	SELECT	a.nr_prescricao,
			b.nr_sequencia,
			b.qt_gasoterapia,
			b.cd_unidade_medida,
			CASE WHEN b.ie_inicio='D' THEN 'SN'  ELSE b.ie_inicio END  ie_inicio,
			a.cd_estabelecimento,
			a.cd_setor_atendimento
	from	prescr_gasoterapia	b,
			prescr_medica		a
	where	b.nr_prescricao = a.nr_prescricao
	and		b.nr_seq_gas = cd_item_p
	and 	(((nr_seq_item_p IS NOT NULL AND nr_seq_item_p::text <> '') and b.nr_Sequencia = nr_seq_item_p)
	or (b.nr_seq_gas_cpoe = nr_seq_cpoe_p) and (ie_gas_separada_w = 'N'))
	and		((coalesce(ie_aprazar_suspensos_w,'S') = 'S') or (coalesce(b.dt_suspensao::text, '') = ''))
	and		coalesce(b.cd_intervalo,'XPTO') = coalesce(cd_intervalo_p,'XPTO')
	and		coalesce(b.qt_gasoterapia,1) = coalesce(qt_item_p,coalesce(b.qt_gasoterapia,1))
	and		((dt_horario_w between a.dt_inicio_prescr and a.dt_validade_prescr) or
			((dt_horario_w between a.dt_prescricao and a.dt_validade_prescr) and 
			((coalesce(b.ie_inicio,'H') = 'ACM') or (coalesce(b.ie_inicio,'H') = 'D'))))
	and		obter_se_prescr_lib_adep(a.dt_liberacao_medico, a.dt_liberacao, a.dt_liberacao_farmacia, ie_data_lib_prescr_w) = 'S'
	and		obter_se_exibir_rep_adep_setor(cd_setor_pac_w,a.cd_setor_atendimento,coalesce(a.ie_adep,'S')) = 'S'
	and		a.dt_validade_prescr > dt_validade_w
	and		a.nr_atendimento = nr_atendimento_p
	and		((vetor_w[x](.nr_prescricao_w IS NOT NULL AND .nr_prescricao_w::text <> '') and a.nr_prescricao = vetor_w[x].nr_prescricao_w)
            or (vetor_w[x](.nr_seq_cpoe_w IS NOT NULL AND .nr_seq_cpoe_w::text <> '') and b.nr_seq_gas_cpoe = vetor_w[x].nr_seq_cpoe_w))
	and		ie_tipo_item_p = 'O'	
	order by
		1, 2;
		
--NPT Adulta
c13 CURSOR FOR
SELECT	a.nr_prescricao nr_prescricao, /* materiais NPA*/
		b.nr_sequencia nr_seq_item,
		a.cd_estabelecimento
from	nut_paciente b,
		prescr_medica a
where	a.nr_prescricao = b.nr_prescricao
and		b.nr_sequencia	= nr_seq_item_p
and		obter_se_prescr_lib_adep(a.dt_liberacao_medico, a.dt_liberacao, a.dt_liberacao_farmacia, ie_data_lib_prescr_w) = 'S'
and		obter_se_exibir_rep_adep_setor(cd_setor_pac_w,a.cd_setor_atendimento,coalesce(a.ie_adep,'S')) = 'S'
and		a.dt_validade_prescr > dt_validade_w
and		a.nr_atendimento = nr_atendimento_p
and		dt_horario_w between a.dt_inicio_prescr and a.dt_validade_prescr
and		ie_tipo_item_p = 'NPA';

c14 CURSOR FOR
SELECT	a.nr_prescricao nr_prescricao, /* materiais NAN*/
		b.nr_sequencia nr_seq_item,
		a.cd_estabelecimento,
		b.qt_fase_npt qt_fase_npt,
		b.qt_tempo_etapa qt_tempo_etapa,
		b.qt_hora_inf	qt_hora_inf
from	nut_pac b,
		prescr_medica a
where	a.nr_prescricao = b.nr_prescricao
and		b.nr_sequencia	= nr_seq_item_p
and		obter_se_prescr_lib_adep(a.dt_liberacao_medico, a.dt_liberacao, a.dt_liberacao_farmacia, ie_data_lib_prescr_w) = 'S'
and		obter_se_exibir_rep_adep_setor(cd_setor_pac_w,a.cd_setor_atendimento,coalesce(a.ie_adep,'S')) = 'S'
and		a.dt_validade_prescr > dt_validade_w
and		a.nr_atendimento = nr_atendimento_p
and		dt_horario_w between a.dt_inicio_prescr and a.dt_validade_prescr
and		(((ie_aprazar_fase_npt_w = 'S') and
          (dt_horario_w + ((b.qt_fase_npt -1) *  coalesce(qt_tempo_etapa,(b.qt_hora_inf/b.qt_fase_npt))/24) between a.dt_inicio_prescr and a.dt_validade_prescr)) or (ie_aprazar_fase_npt_w = 'N'))
and		ie_tipo_item_p = 'NAN';



c15 CURSOR FOR
SELECT	a.nr_prescricao nr_prescricao, /* Leites e derivados */
		b.nr_sequencia nr_seq_item,
		b.cd_local_estoque,
		b.nr_agrupamento,
		b.cd_material,
		b.cd_unidade_medida,
		coalesce(b.ie_se_necessario,'N') ie_sn,
		coalesce(b.ie_acm,'N') ie_acm,
		b.qt_total_dispensar,
		b.dt_proxima_dose,
		obter_ocorrencia_intervalo(b.cd_intervalo,24,'H'),
		a.dt_validade_prescr
from	prescr_mat_hor c,
		prescr_medica a,
		prescr_material b
where	c.nr_prescricao = b.nr_prescricao
and		c.nr_seq_material = b.nr_sequencia
and		b.nr_prescricao = a.nr_prescricao
and		b.ie_agrupador = 16
and		((((ie_aprazar_agrupados_w = 'N') or ((coalesce(ie_se_necessario,'N') = 'N') and (coalesce(ie_acm,'N') = 'N')))  and (a.nr_prescricao	= vetor_w[x].nr_prescricao_w)) or
		 ((ie_aprazar_agrupados_w <> 'N') and ((obter_se_prescr_adep(a.nr_prescricao, b.nr_sequencia, nr_prescr_w, nr_seq_item_p, nr_prescr_www||','||nr_prescr_ww) = 'S') or ((coalesce(ie_se_necessario,'N') = 'S') or (coalesce(ie_acm,'N') = 'S')))))
and		b.cd_material = cd_item_p
and		coalesce(b.cd_intervalo,'XPTO') = coalesce(cd_intervalo_p,'XPTO')
and		obter_se_acm_sn(b.ie_acm, b.ie_se_necessario) = ie_acm_sn_p
and		((coalesce(ie_aprazar_suspensos_w,'S') = 'S') or (coalesce(b.dt_suspensao::text, '') = ''))
and		coalesce(b.qt_dose,1) = coalesce(qt_item_p,coalesce(b.qt_dose,1))
and		(((coalesce(nr_agrupamento_p,0) > 0) and (b.nr_agrupamento = nr_agrupamento_p)) or
		 ((coalesce(nr_agrupamento_p,0) = 0) and (obter_se_agrupa_composto(a.nr_prescricao, b.nr_sequencia, b.nr_agrupamento, b.cd_material) = 'N')))
and		Obter_se_horario_liberado(c.dt_lib_horario, c.dt_horario) = 'S'
and		((dt_horario_w between a.dt_inicio_prescr and a.dt_validade_prescr) or 
		 ((dt_horario_w between a.dt_prescricao and a.dt_validade_prescr) and ((coalesce(ie_acm,'N') = 'S') or (coalesce(ie_se_necessario,'N') = 'S'))))
and		obter_se_prescr_lib_adep(coalesce(a.dt_liberacao_medico, b.dt_lib_material), coalesce(a.dt_liberacao,b.dt_lib_material), coalesce(a.dt_liberacao_farmacia, b.dt_lib_farmacia), ie_data_lib_prescr_w) = 'S'
and		obter_se_exibir_rep_adep_setor(cd_setor_pac_w,a.cd_setor_atendimento,coalesce(a.ie_adep,'S')) = 'S'
and		a.dt_validade_prescr > dt_validade_w
and		a.nr_prescricao	= vetor_w[x].nr_prescricao_w
and		a.nr_atendimento = nr_atendimento_p
and		((coalesce(cd_unidade_medida_p,'XPTO') = 'XPTO') or (cd_unidade_medida_p = c.cd_unidade_medida_dose))
and		ie_tipo_item_p = 'LD'
group by
	a.nr_prescricao,
	b.nr_sequencia,
	b.cd_local_estoque,
	b.nr_agrupamento,
	b.cd_material,
	b.qt_total_dispensar,
	b.cd_unidade_medida,
	coalesce(b.ie_se_necessario,'N'), 
	obter_ocorrencia_intervalo(b.cd_intervalo,24,'H'),
	a.dt_validade_prescr,
	coalesce(b.ie_acm,'N'),
	b.dt_proxima_dose
order by
	a.nr_prescricao desc, 2;

C16 CURSOR FOR	
	SELECT	a.nr_prescricao,	--Selecionar itens associados a SAE para gerar lote. OS 689787
			a.nr_sequencia,
			c.nr_sequencia   
	from  pe_prescricao b,
			prescr_material a,
			prescr_mat_hor c
	where a.nr_prescricao = b.nr_prescricao                        
	and		a.nr_prescricao = c.nr_prescricao
	and		a.nr_sequencia  = c.nr_seq_material
	and		b.nr_atendimento = nr_atendimento_p
	and		b.nr_sequencia	= vetor_w[x].nr_prescricao_w;	
	

	
BEGIN

if (nr_atendimento_p IS NOT NULL AND nr_atendimento_p::text <> '') and (ie_tipo_item_p IS NOT NULL AND ie_tipo_item_p::text <> '') and (cd_item_p IS NOT NULL AND cd_item_p::text <> '') and (dt_horario_p IS NOT NULL AND dt_horario_p::text <> '') and (ie_laboratorio_p IS NOT NULL AND ie_laboratorio_p::text <> '') and (nm_usuario_p IS NOT NULL AND nm_usuario_p::text <> '') then
	
	ie_gera_sem_certificado_w	:= 'N';
	
	if (wheb_assist_pck.get_gerar_sem_certificado = 'S') then
		ie_gera_sem_certificado_w := adep_obter_se_assin_perfil(50592, obter_perfil_ativo); --ADEP - Aprazamento de itens
	end if;
	
    if (obter_funcao_ativa = 252) then
		ie_ver_check_adep_w := obter_param_usuario(252, 29, cd_perfil_w, nm_usuario_p, coalesce(cd_estabelecimento_p, wheb_usuario_pck.get_cd_estabelecimento), ie_ver_check_adep_w);
	else
		ie_ver_check_adep_w := obter_param_usuario(7015, 65, cd_perfil_w, nm_usuario_p, coalesce(cd_estabelecimento_p, wheb_usuario_pck.get_cd_estabelecimento), ie_ver_check_adep_w);
	end if;
	
	ie_gerar_lote_apraza_w := obter_param_usuario(88, 298, cd_perfil_w, nm_usuario_p, coalesce(cd_estabelecimento_p, wheb_usuario_pck.get_cd_estabelecimento), ie_gerar_lote_apraza_w);

	CALL wheb_assist_pck.set_informacoes_usuario(cd_estabelecimento_p, cd_perfil_w, nm_usuario_p);
	
	ie_setor_gedipa_w	:= obter_se_setor_processo_gedipa(obter_unidade_atendimento(nr_atendimento_p,'IAA','CS'));

	ie_grava_log_rastr_w := obter_rastreabilidade_adep(nr_prescricao_p, 'APR');
	
	if (ie_grava_log_rastr_w = 'S') then
		CALL adep_gerar_log_rastr(substr('APRAZAR_ITEM_PRESCR PARAMETROS IN' || chr(10) ||
			'{'||chr(10)||
			'"ie_aprazar_interv_p" : "'||ie_aprazar_interv_p||'",'||chr(10)||
			'"cd_estabelecimento_p" : "'||cd_estabelecimento_p||'",'||chr(10)||
			'"nr_atendimento_p" : "'||nr_atendimento_p||'",'||chr(10)||
			'"ie_tipo_item_p" : "'||ie_tipo_item_p||'",'||chr(10)||
			'"qt_hora_prescricao_p" : "'||qt_hora_prescricao_p||'",'||chr(10)||
			'"cd_item_p" : "'||cd_item_p||'",'||chr(10)||
			'"cd_intervalo_p" : "'||cd_intervalo_p||'",'||chr(10)||
			'"qt_item_p" : "'||qt_item_p||'",'||chr(10)||
			'"dt_horario_p" : "'||to_char(dt_horario_p, 'dd/mm/yyyy hh24:mi:ss')||'",'||chr(10)||
			'"nr_prescricoes_p" : "'||nr_prescricoes_p||'",'||chr(10)||
			'"nr_prescricao_p" : "'||nr_prescricao_p||'",'||chr(10)||
			'"nr_seq_item_p" : "'||nr_seq_item_p||'",'||chr(10)||
			'"ie_laboratorio_p" : "'||ie_laboratorio_p||'",'||chr(10)||
			'"nr_seq_motivo_p" : "'||nr_seq_motivo_p||'",'||chr(10)||
			'"ds_justificativa_p" : "'||substr(ds_justificativa_p,1,255)||'",'||chr(10)||
			'"nm_usuario_p" : "'||nm_usuario_p||'",'||chr(10)||
			'"nr_seq_proc_interno_p" : "'||nr_seq_proc_interno_p||'",'||chr(10)||
			'"nr_agrupamento_p" : "'||nr_agrupamento_p||'",'||chr(10)||
			'"ie_acm_sn_p" : "'||ie_acm_sn_p||'",'||chr(10)||
			'"ie_gerar_evento_p" : "'||ie_gerar_evento_p||'",'||chr(10)||
			'"nr_seq_assinatura_p" : "'||nr_seq_assinatura_p||'",'||chr(10)||
			'"ie_chamada_glicemia_p" : "'||ie_chamada_glicemia_p||'",'||chr(10)||
			'"nr_seq_horario_p" : "'||nr_seq_horario_p||'",'||chr(10)||
			'"nr_seq_prot_glic_p" : "'||nr_seq_prot_glic_p||'",'||chr(10)||
			'"cd_unidade_medida_p" : "'||cd_unidade_medida_p||'",'||chr(10)||
			'"nr_seq_pergunta_p" : "'||nr_seq_pergunta_p||'",'||chr(10)||
			'"ds_componentes_p" : "'||substr(ds_componentes_p,1,255)||'",'||chr(10)||
			'"nr_seq_objeto_p" : "'||nr_seq_objeto_p||'",'||chr(10)||
			'"ie_via_aplicacao_p" : "'||ie_via_aplicacao_p||'",'||chr(10)||
			'"nr_seq_cpoe_p" : "'||nr_seq_cpoe_p||'"}',1,1500));
	end if;
	
	select	coalesce(max(ie_gerar_proc_gedipa_job),'S'),
		coalesce(max(ie_gera_disp_acm_sn),'S'),
		coalesce(max(ie_imprimir_acm_sn),'S')
	into STRICT	ie_gerar_proc_gedipa_job_w,
		ie_gera_disp_acm_sn_w,
		ie_imprimir_acm_sn_w
	from	parametros_farmacia
	where	cd_estabelecimento = coalesce(cd_estabelecimento_p, wheb_usuario_pck.get_cd_estabelecimento);
	
	ie_aprazar_ivc_adep_w		:= wheb_assist_pck.obterParametroFuncao(1113,557);

	cd_setor_pac_w		:= Obter_Unidade_Atendimento(nr_atendimento_p, 'IA', 'CS');

	if (ie_tipo_item_p <> 'I') then
		ie_aprazar_ivc_adep_w := 'N';
	end if;

	if (ie_aprazar_ivc_adep_w = 'S') then
		select	min(a.nr_prescricao)
		into STRICT	nr_prescricao_www
		from	prescr_medica a,
			prescr_procedimento b
		where	a.nr_atendimento = nr_atendimento_p
		and	clock_timestamp() between a.dt_inicio_prescr and a.dt_validade_prescr
		and	dt_horario_p between a.dt_inicio_prescr and a.dt_validade_prescr
		and	coalesce(a.dt_suspensao::text, '') = ''
		and	a.nr_prescricao = b.nr_prescricao
		and	(b.nr_seq_proc_interno IS NOT NULL AND b.nr_seq_proc_interno::text <> '')
		and	obter_se_proc_IVC(b.nr_seq_proc_interno) = 'S';
		
		if (coalesce(nr_prescricao_www::text, '') = '') then
			select	max(nr_prescricao)
			into STRICT	nr_prescricao_www
			from	prescr_medica
			where	nr_atendimento = nr_atendimento_p;
		end if;
	end if;

	ie_data_proc_w				:= wheb_assist_pck.obterParametroFuncao(924,223);
	ie_gera_nutricao_w			:= wheb_assist_pck.obterParametroFuncao(924,545);
	cd_motivo_baixa_w			:= wheb_assist_pck.obterParametroFuncao(924,587);
	ie_local_estoque_w			:= wheb_assist_pck.obterParametroFuncao(924,799);
	ie_local_estoque_mat_hor_w	:= wheb_assist_pck.obterParametroFuncao(924,851);
	ie_gerar_serv_supl_w		:= wheb_assist_pck.obterParametroFuncao(924,925);

	ie_gerar_necessidade_disp_w	:= wheb_assist_pck.obterParametroFuncao(1113,70);
	ie_agrupar_acm_sn_w			:= wheb_assist_pck.obterParametroFuncao(1113,74);
	ie_data_lib_prescr_w		:= wheb_assist_pck.obterParametroFuncao(1113,115);
	ie_exibe_suspenso_w			:= wheb_assist_pck.obterParametroFuncao(1113,117);
	ie_aprazar_suspensos_w		:= wheb_assist_pck.obterParametroFuncao(1113,125);
	ie_aprazar_mat_proc_w		:= wheb_assist_pck.obterParametroFuncao(1113,216);
	ie_aprazar_agrupados_w		:= wheb_assist_pck.obterParametroFuncao(1113,217);
	ie_gerar_lote_ww			:= wheb_assist_pck.obterParametroFuncao(1113,342);
	qt_horas_apraz_w			:= wheb_assist_pck.obterParametroFuncao(1113,388);
	ie_gerar_nec_disp_kit_w		:= wheb_assist_pck.obterParametroFuncao(1113,393);
	ie_desagrupa_proced_w		:= wheb_assist_pck.obterParametroFuncao(1113,463);
	nr_seq_classif_param_w		:= wheb_assist_pck.obterParametroFuncao(1113,498);
	ie_gerar_classif_agora_w	:= wheb_assist_pck.obterParametroFuncao(1113,529);
	ie_aprazar_fase_npt_w		:= wheb_assist_pck.obterParametroFuncao(1113,685);
	ie_gerar_processo_w			:= wheb_assist_pck.obterParametroFuncao(1113,279);
	ie_gas_separada_w			:= wheb_assist_pck.obterParametroFuncao(1113,704);
	ie_permite_antes_val_w := wheb_assist_pck.obterParametroFuncao(1113,271);

	if (qt_horas_apraz_w = 0) then
		dt_validade_w		:= clock_timestamp() - qt_hora_prescricao_p / 24;
	else
		dt_validade_w		:= clock_timestamp() - qt_horas_apraz_w / 24;
	end if;
	dt_horario_w := PKG_DATE_UTILS.start_of(dt_horario_p, 'mi', 0);
	
	if (ie_tipo_item_p in ('G','IAG')) then
		nr_seq_hor_glic_w	:= nr_seq_horario_p;
	end if;

	nr_prescricao_adic_w	:= 0;

    -- vigencia CPOE
    select	max(a.dt_liberacao),
            max(a.dt_fim)
    into STRICT	dt_inicio_prescr_cpoe_w,
            dt_fim_prescr_cpoe_w
    from	cpoe_material a
    where   a.nr_sequencia = nr_seq_cpoe_p;
	
	if (ie_grava_log_rastr_w = 'S') then
		CALL adep_gerar_log_rastr(substr('APRAZAR_ITEM_PRESCR PARAMETROS FUNCOES' || chr(10) ||
			'{'||chr(10)||
			'"ie_gera_sem_certificado_w" : "'||ie_gera_sem_certificado_w||'",'||chr(10)||
			'"ie_ver_check_adep_w" : "'||ie_ver_check_adep_w||'",'||chr(10)||
			'"ie_gerar_lote_apraza_w" : "'||ie_gerar_lote_apraza_w||'",'||chr(10)||
			'"ie_setor_gedipa_w" : "'||ie_setor_gedipa_w||'",'||chr(10)||
			'"ie_gerar_proc_gedipa_job_w" : "'||ie_gerar_proc_gedipa_job_w||'",'||chr(10)||
			'"ie_gera_disp_acm_sn_w" : "'||ie_gera_disp_acm_sn_w||'",'||chr(10)||
			'"ie_imprimir_acm_sn_w" : "'||ie_imprimir_acm_sn_w||'",'||chr(10)||
			'"ie_aprazar_ivc_adep_w" : "'||ie_aprazar_ivc_adep_w||'",'||chr(10)||
			'"cd_setor_pac_w" : "'||cd_setor_pac_w||'",'||chr(10)||
			'"nr_prescricao_www" : "'||nr_prescricao_www||'",'||chr(10)||
			'"ie_data_proc_w" : "'||ie_data_proc_w||'",'||chr(10)||
			'"ie_gera_nutricao_w" : "'||ie_gera_nutricao_w||'",'||chr(10)||
			'"cd_motivo_baixa_w" : "'||cd_motivo_baixa_w||'",'||chr(10)||
			'"ie_local_estoque_w" : "'||ie_local_estoque_w||'",'||chr(10)||
			'"ie_local_estoque_mat_hor_w" : "'||ie_local_estoque_mat_hor_w||'",'||chr(10)||
			'"ie_gerar_serv_supl_w" : "'||ie_gerar_serv_supl_w||'",'||chr(10)||
			'"ie_gerar_necessidade_disp_w" : "'||ie_gerar_necessidade_disp_w||'",'||chr(10)||
			'"ie_agrupar_acm_sn_w" : "'||ie_agrupar_acm_sn_w||'",'||chr(10)||
			'"ie_data_lib_prescr_w" : "'||ie_data_lib_prescr_w||'",'||chr(10)||
			'"ie_exibe_suspenso_w" : "'||ie_exibe_suspenso_w||'",'||chr(10)||
			'"ie_aprazar_suspensos_w" : "'||ie_aprazar_suspensos_w||'",'||chr(10)||
			'"ie_aprazar_mat_proc_w" : "'||ie_aprazar_mat_proc_w||'",'||chr(10)||
			'"ie_aprazar_agrupados_w" : "'||ie_aprazar_agrupados_w||'",'||chr(10)||
			'"ie_gerar_lote_ww" : "'||ie_gerar_lote_ww||'",'||chr(10)||
			'"qt_horas_apraz_w" : "'||qt_horas_apraz_w||'",'||chr(10)||
			'"ie_gerar_nec_disp_kit_w" : "'||ie_gerar_nec_disp_kit_w||'",'||chr(10)||
			'"ie_desagrupa_proced_w" : "'||ie_desagrupa_proced_w||'",'||chr(10)||
			'"nr_seq_classif_param_w" : "'||nr_seq_classif_param_w||'",'||chr(10)||
			'"ie_gerar_classif_agora_w" : "'||ie_gerar_classif_agora_w||'",'||chr(10)||
			'"ie_aprazar_fase_npt_w" : "'||ie_aprazar_fase_npt_w||'",'||chr(10)||
			'"ie_gerar_processo_w" : "'||ie_gerar_processo_w||'",'||chr(10)||
			'"ie_gas_separada_w" : "'||ie_gas_separada_w||'",'||chr(10)||
			'"ie_permite_antes_val_w" : "'||ie_permite_antes_val_w||'",'||chr(10)||
			'"dt_validade_w" : "'||to_char(dt_validade_w, 'dd/mm/yyyy hh24:mi:ss')||'",'||chr(10)||
			'"dt_horario_w" : "'||to_char(dt_horario_w, 'dd/mm/yyyy hh24:mi:ss')||'",'||chr(10)||
            '"dt_inicio_prescr_cpoe_w" : "'||to_char(dt_inicio_prescr_cpoe_w, 'dd/mm/yyyy hh24:mi:ss')||'",'||chr(10)||
            '"dt_fim_prescr_cpoe_w" : "'||to_char(dt_fim_prescr_cpoe_w, 'dd/mm/yyyy hh24:mi:ss')||'",'||chr(10)||
			'"nr_seq_hor_glic_w" : "'||nr_seq_hor_glic_w||'"}',1,1500));
	end if;

    if (ie_grava_log_rastr_w = 'S') then
        CALL adep_gerar_log_rastr('APRAZAR_ITEM_PRESCR PARAMETROS NR_ULTIMA_PRESCR' || chr(10) ||
            '{'||chr(10)||
            '"cd_intervalo_p" : "'||cd_intervalo_p||'",'||chr(10)||
            '"cd_item_p" : "'||cd_item_p||'",'||chr(10)||
            '"cd_setor_pac_w" : "'||cd_setor_pac_w||'",'||chr(10)||
            '"cd_unidade_medida_p" : "'||cd_unidade_medida_p||'",'||chr(10)||
            '"ds_componentes_p" : "'||ds_componentes_p||'",'||chr(10)||
            '"dt_fim_prescr_cpoe_w" : "'||to_char(dt_fim_prescr_cpoe_w, 'dd/mm/yyyy hh24:mi:ss')||'",'||chr(10)||
            '"dt_horario_w" : "'||to_char(dt_horario_w, 'dd/mm/yyyy hh24:mi:ss')||'",'||chr(10)||
            '"dt_inicio_prescr_cpoe_w" : "'||to_char(dt_inicio_prescr_cpoe_w, 'dd/mm/yyyy hh24:mi:ss')||'",'||chr(10)||
            '"dt_validade_w" : "'||to_char(dt_validade_w, 'dd/mm/yyyy hh24:mi:ss')||'",'||chr(10)||
            '"ie_acm_sn_p" : "'||ie_acm_sn_p||'",'||chr(10)||
            '"ie_aprazar_agrupados_w" : "'||ie_aprazar_agrupados_w||'",'||chr(10)||
            '"ie_aprazar_suspensos_w" : "'||ie_aprazar_suspensos_w||'",'||chr(10)||
            '"ie_data_lib_prescr_w" : "'||ie_data_lib_prescr_w||'",'||chr(10)||
            '"ie_permite_antes_val_w" : "'||ie_permite_antes_val_w||'",'||chr(10)||
            '"ie_tipo_item_p" : "'||ie_tipo_item_p||'",'||chr(10)||
            '"nr_agrupamento_p" : "'||nr_agrupamento_p||'",'||chr(10)||
            '"nr_atendimento_p" : "'||nr_atendimento_p||'",'||chr(10)||
            '"nr_prescricao_adic_w" : "'||nr_prescricao_adic_w||'",'||chr(10)||
            '"nr_prescricoes_p" : "'||nr_prescricoes_p||'",'||chr(10)||
            '"nr_prescricoes_ww" : "'||nr_prescricoes_ww||'",'||chr(10)||
            '"nr_seq_cpoe_p" : "'||nr_seq_cpoe_p||'",'||chr(10)||
            '"nr_ultima_prescr_w" : "'||nr_ultima_prescr_w||'",'||chr(10)||
            '"qt_item_p" : "'||qt_item_p||'"}', coalesce(wheb_usuario_pck.get_ie_commit, 'S'));
	end if;
	
	if (ie_aprazar_agrupados_w <> 'N') and (ie_acm_sn_p = 'S') then
      select coalesce(max(cte.nr_prescricao),0) nr_prescricao
      into STRICT	nr_ultima_prescr_w
      from (
          SELECT	coalesce(a.nr_prescricao,0) nr_prescricao,
					        obter_se_prescr_vigente(a.nr_prescricao) ie_prescr_vigente
          from	prescr_mat_hor c,
              prescr_medica a,
              prescr_material b
          where	c.nr_prescricao = b.nr_prescricao
          and		c.nr_seq_material = b.nr_sequencia
          and		b.nr_prescricao = a.nr_prescricao
          and		b.ie_agrupador = 1
          and		((coalesce(cd_unidade_medida_p,'XPTO') = 'XPTO') or (cd_unidade_medida_p = c.cd_unidade_medida_dose))
          and		coalesce(b.cd_intervalo,'XPTO') = coalesce(cd_intervalo_p,'XPTO')
          and		obter_se_acm_sn(b.ie_acm, b.ie_se_necessario) = ie_acm_sn_p
          and		b.cd_material = cd_item_p
          and		((coalesce(ie_aprazar_suspensos_w,'S') = 'S') or (coalesce(b.dt_suspensao::text, '') = ''))
          and		coalesce(b.qt_dose,1) = coalesce(qt_item_p,coalesce(b.qt_dose,1))
          and		(((coalesce(nr_agrupamento_p,0) > 0) and (b.nr_agrupamento = nr_agrupamento_p)) or
              ((coalesce(nr_agrupamento_p,0) = 0) and (obter_se_agrupa_composto(a.nr_prescricao, b.nr_sequencia, b.nr_agrupamento, b.cd_material) = 'N')))
          and		Obter_se_horario_liberado(c.dt_lib_horario, c.dt_horario) = 'S'
		      and		((ie_aprazar_agrupados_w = 'V' and ( dt_horario_w between a.dt_inicio_prescr and a.dt_validade_prescr)) or ie_aprazar_agrupados_w <> 'V')
          and		((dt_horario_w between a.dt_inicio_prescr and a.dt_validade_prescr) or 
                          ((dt_horario_w between a.dt_prescricao and a.dt_validade_prescr) and (ie_aprazar_agrupados_w <> 'V') and (ie_aprazar_agrupados_w <> 'T') and((coalesce(ie_acm,'N') = 'S') or (coalesce(ie_se_necessario,'N') = 'S'))) or
                          (((ie_permite_antes_val_w = 'T') or (ie_permite_antes_val_w = 'S' and (coalesce(ie_acm,'N') = 'S' or coalesce(ie_se_necessario,'N') = 'S'))) and dt_horario_w < a.dt_validade_prescr) or (ie_tipo_item_p = 'M' and (nr_seq_cpoe_p IS NOT NULL AND nr_seq_cpoe_p::text <> '') and nr_seq_cpoe_p <> 0 and
                              dt_horario_w between dt_inicio_prescr_cpoe_w and coalesce(dt_fim_prescr_cpoe_w, a.dt_validade_prescr)))
          and		obter_se_prescr_lib_adep(coalesce(a.dt_liberacao_medico, b.dt_lib_material), coalesce(a.dt_liberacao,b.dt_lib_material), coalesce(a.dt_liberacao_farmacia, b.dt_lib_farmacia), ie_data_lib_prescr_w) = 'S'
          and		obter_se_exibir_rep_adep_setor(cd_setor_pac_w,a.cd_setor_atendimento,coalesce(a.ie_adep,'S')) = 'S'
          and     ((coalesce(ds_componentes_p::text, '') = '') or (ie_aprazar_agrupados_w <> 'V') or ((substr(adep_obter_inf_dil_obs(a.nr_prescricao, b.nr_sequencia),1,2000) = substr(ds_componentes_p,1,2000)) and (ie_aprazar_agrupados_w = 'V')))
          and		a.dt_validade_prescr > dt_validade_w
          and		a.nr_atendimento = nr_atendimento_p
          and		ie_tipo_item_p in ('M', 'IAH', 'LD')
          
union all

          SELECT	coalesce(a.nr_prescricao,0) nr_prescricao,
					        obter_se_prescr_vigente(a.nr_prescricao) ie_prescr_vigente
          from	prescr_rec_hor c,
              prescr_recomendacao b,
              prescr_medica a
          where	c.nr_prescricao = b.nr_prescricao
          and		c.nr_seq_recomendacao = b.nr_sequencia
          and		b.nr_prescricao = a.nr_prescricao

          and		((ie_data_lib_prescr_w = 'F') or (obter_se_prescr_lib_adep(a.dt_liberacao_medico, a.dt_liberacao, a.dt_liberacao_farmacia, ie_data_lib_prescr_w) = 'S'))
          and		obter_se_exibir_rep_adep_setor(cd_setor_pac_w,a.cd_setor_atendimento,coalesce(a.ie_adep,'S')) = 'S'
          and		a.dt_validade_prescr > dt_validade_w
          and		a.nr_atendimento = nr_atendimento_p
		      and		((ie_aprazar_agrupados_w = 'V' and (dt_horario_w between a.dt_inicio_prescr and a.dt_validade_prescr)) or ie_aprazar_agrupados_w <> 'V')
          and		((((ie_aprazar_agrupados_w = 'N') or ((coalesce(b.ie_se_necessario,'N') = 'N') and (coalesce(ie_acm,'N') = 'N')))) or
              ((ie_aprazar_agrupados_w <> 'N') and ((obter_se_prescr_adep(a.nr_prescricao, b.nr_sequencia, '', '', nr_prescricoes_p) = 'S') or ((coalesce(b.ie_se_necessario,'N') = 'S') or (coalesce(ie_acm,'N') = 'S')))))
          and		coalesce(to_char(b.cd_recomendacao),b.ds_recomendacao) = cd_item_p
          and		coalesce(b.cd_intervalo,'XPTO') = coalesce(cd_intervalo_p,'XPTO')
          and		obter_se_acm_sn(b.ie_acm, b.ie_se_necessario) = ie_acm_sn_p
          and		((coalesce(ie_aprazar_suspensos_w,'S') = 'S') or (coalesce(b.dt_suspensao::text, '') = ''))
          and		coalesce(b.qt_recomendacao,1) = coalesce(qt_item_p,coalesce(b.qt_recomendacao,1))
          and		Obter_se_horario_liberado(c.dt_lib_horario, c.dt_horario) = 'S'
          and		dt_horario_w between a.dt_inicio_prescr and a.dt_validade_prescr
          and		ie_tipo_item_p = 'R'
      ) cte
		  where	((cte.ie_prescr_vigente = 'S' and ie_aprazar_agrupados_w = 'T') or (ie_aprazar_agrupados_w <> 'T'));
		
      nr_prescricao_adic_w	:= nr_ultima_prescr_w;
	end if;
	
	if (nr_prescricao_adic_w > 0) and (ie_aprazar_agrupados_w <> 'N') then
		if (position(nr_prescricao_adic_w in nr_prescricoes_ww) = 0) then
			nr_prescricoes_ww := nr_prescricoes_p||','||nr_prescricao_adic_w;
		else
			nr_prescricoes_ww := nr_prescricoes_p;
		end if;
	elsif ((ie_aprazar_agrupados_w = 'T') and (ie_tipo_item_p in ('M', 'IAH', 'LD', 'IAG', 'R'))) then
    select coalesce(max(cte.nr_prescricao), 0)
    into STRICT	nr_ultima_prescr_w
    from(
        SELECT	coalesce(min(a.nr_prescricao),0) nr_prescricao
        from	prescr_mat_hor c,
            prescr_medica a,
            prescr_material b
        where	c.nr_prescricao = b.nr_prescricao
        and		c.nr_seq_material = b.nr_sequencia
        and		b.nr_prescricao = a.nr_prescricao
        and		b.ie_agrupador in (1,5)
        and		((coalesce(cd_unidade_medida_p,'XPTO') = 'XPTO') or (cd_unidade_medida_p = c.cd_unidade_medida_dose))
        and		coalesce(b.cd_intervalo,'XPTO') = coalesce(cd_intervalo_p,'XPTO')
        and		obter_se_acm_sn(b.ie_acm, b.ie_se_necessario) = ie_acm_sn_p
        and		b.cd_material = cd_item_p
        and		((coalesce(ie_aprazar_suspensos_w,'S') = 'S') or (coalesce(b.dt_suspensao::text, '') = ''))
        and		((ie_tipo_item_p = 'IAG') or (coalesce(b.qt_dose,1) = coalesce(qt_item_p,coalesce(b.qt_dose,1))))
        and		(((coalesce(nr_agrupamento_p,0) > 0) and (b.nr_agrupamento = nr_agrupamento_p)) or
            ((coalesce(nr_agrupamento_p,0) = 0) and (obter_se_agrupa_composto(a.nr_prescricao, b.nr_sequencia, b.nr_agrupamento, b.cd_material) = 'N')))
        and		Obter_se_horario_liberado(c.dt_lib_horario, c.dt_horario) = 'S'
        and (dt_horario_w between a.dt_prescricao and a.dt_validade_prescr or (ie_tipo_item_p = 'M' and (nr_seq_cpoe_p IS NOT NULL AND nr_seq_cpoe_p::text <> '') and nr_seq_cpoe_p <> 0 and
                            dt_horario_w between dt_inicio_prescr_cpoe_w and coalesce(dt_fim_prescr_cpoe_w, a.dt_validade_prescr)))
        and		obter_se_prescr_lib_adep(coalesce(a.dt_liberacao_medico, b.dt_lib_material), coalesce(a.dt_liberacao,b.dt_lib_material), coalesce(a.dt_liberacao_farmacia, b.dt_lib_farmacia), ie_data_lib_prescr_w) = 'S'
        and		obter_se_exibir_rep_adep_setor(cd_setor_pac_w,a.cd_setor_atendimento,coalesce(a.ie_adep,'S')) = 'S'
        and		a.dt_validade_prescr > dt_validade_w
        and		a.nr_atendimento = nr_atendimento_p
        and		ie_tipo_item_p in ('M', 'LD', 'IAG', 'IAH')
        
union all

        SELECT	coalesce(min(a.nr_prescricao),0) nr_prescricao 
        from	prescr_rec_hor c,
            prescr_recomendacao b,
            prescr_medica a
        where	c.nr_prescricao = b.nr_prescricao
        and		c.nr_seq_recomendacao = b.nr_sequencia
        and		b.nr_prescricao = a.nr_prescricao
        and		((ie_data_lib_prescr_w = 'F') or (obter_se_prescr_lib_adep(a.dt_liberacao_medico, a.dt_liberacao, a.dt_liberacao_farmacia, ie_data_lib_prescr_w) = 'S'))
        and		obter_se_exibir_rep_adep_setor(cd_setor_pac_w,a.cd_setor_atendimento,coalesce(a.ie_adep,'S')) = 'S'
        and		a.dt_validade_prescr > dt_validade_w
        and		a.nr_atendimento = nr_atendimento_p
        and		((((ie_aprazar_agrupados_w = 'N') or ((coalesce(b.ie_se_necessario,'N') = 'N') and (coalesce(ie_acm,'N') = 'N')))) or
            ((ie_aprazar_agrupados_w <> 'N') and ((obter_se_prescr_adep(a.nr_prescricao, b.nr_sequencia, '', '', nr_prescricoes_p) = 'S') or ((coalesce(b.ie_se_necessario,'N') = 'S') or (coalesce(ie_acm,'N') = 'S')))))
        and		coalesce(to_char(b.cd_recomendacao),b.ds_recomendacao) = cd_item_p
        and		coalesce(b.cd_intervalo,'XPTO') = coalesce(cd_intervalo_p,'XPTO')
        and		obter_se_acm_sn(b.ie_acm, b.ie_se_necessario) = ie_acm_sn_p
        and		((coalesce(ie_aprazar_suspensos_w,'S') = 'S') or (coalesce(b.dt_suspensao::text, '') = ''))
        and		coalesce(b.qt_recomendacao,1) = coalesce(qt_item_p,coalesce(b.qt_recomendacao,1))
        and		Obter_se_horario_liberado(c.dt_lib_horario, c.dt_horario) = 'S'
        and		dt_horario_w between a.dt_prescricao and a.dt_validade_prescr
        and		ie_tipo_item_p = 'R') cte;
		
		nr_prescricoes_ww	:= nr_ultima_prescr_w;		
	 else
		nr_prescricoes_ww := nr_prescricoes_p;
	end if;

	if (ie_agrupar_acm_sn_w = 'N') and (nr_prescricao_p IS NOT NULL AND nr_prescricao_p::text <> '') then
		nr_prescr_w	:= nr_prescricao_p;
		nr_prescr_ww	:= nr_prescricao_p;
		nr_prescr_www	:= nr_prescricao_p;
	elsif (ie_aprazar_agrupados_w <> 'N') then
		nr_prescr_w   := Obter_Min_NrPrescricao(nr_prescricoes_ww);
		nr_prescr_www := nr_prescr_w;
		nr_prescr_w  := Obter_Max_NrPrescricao(nr_prescricoes_ww);
		nr_prescr_ww := nr_prescr_w;
		
		if (coalesce(nr_ultima_prescr_w::text, '') = '') then
			nr_ultima_prescr_w	:= nr_prescr_ww;
		end if;
		
	end if;
		
	ie_inconsistencia_w := null;
	ds_inconsistentes_w := null;
			
	if (nr_prescricoes_p IS NOT NULL AND nr_prescricoes_p::text <> '') or (nr_prescricao_p IS NOT NULL AND nr_prescricao_p::text <> '') then
		cont_w := 0;		
		
		if (nr_prescricao_p IS NOT NULL AND nr_prescricao_p::text <> '') and
			((nr_prescricao_adic_w = 0) or (nr_prescricao_adic_w = nr_prescricao_p)) then
			

			if (ie_tipo_item_p in ('IAH', 'M', 'MAT', 'SOL')) then
			    select	coalesce(max(a.nr_prescricao),nr_prescricao_p)
		    	into STRICT	nr_prescricao_w
				from	prescr_medica a,
						prescr_material b
				where	a.nr_prescricao	= b.nr_prescricao			
				and		b.nr_seq_mat_cpoe	= nr_seq_cpoe_p
				and		dt_horario_p between dt_inicio_prescr and dt_validade_prescr;
							
			elsif (ie_tipo_item_p in ('S', 'SNE')) then	

				select	coalesce(max(a.nr_prescricao),nr_prescricao_p)
		    	into STRICT	nr_prescricao_w
				from	prescr_medica a,
						prescr_material b
				where	a.nr_prescricao	= b.nr_prescricao			
				and		b.nr_seq_dieta_cpoe	= nr_seq_cpoe_p
				and		dt_horario_p between dt_inicio_prescr and dt_validade_prescr;
			
			elsif (ie_tipo_item_p in ('P', 'L', 'HM', 'CIG', 'CCG')) then	
			
				select	coalesce(max(a.nr_prescricao),nr_prescricao_p)
		    	into STRICT	nr_prescricao_w
				from	prescr_medica a,
						prescr_procedimento b
				where	a.nr_prescricao	= b.nr_prescricao			
				and		b.nr_seq_proc_cpoe	= nr_seq_cpoe_p
				and		dt_horario_p between dt_inicio_prescr and dt_validade_prescr;
			
			elsif (ie_tipo_item_p = 'R') then	
			
				select	coalesce(max(a.nr_prescricao),nr_prescricao_p)
		    	into STRICT	nr_prescricao_w
				from	prescr_medica a,
						prescr_recomendacao b
				where	a.nr_prescricao	= b.nr_prescricao			
				and		b.nr_seq_rec_cpoe	= nr_seq_cpoe_p
				and		dt_horario_p between dt_inicio_prescr and dt_validade_prescr;
			
			elsif (ie_tipo_item_p = 'D') then

				select	coalesce(max(a.nr_prescricao),nr_prescricao_p)
		    	into STRICT	nr_prescricao_w
				from	prescr_medica a,
						prescr_solucao b
				where	a.nr_prescricao	= b.nr_prescricao			
				and		b.nr_seq_dialise_cpoe	= nr_seq_cpoe_p
				and		dt_horario_p between dt_inicio_prescr and dt_validade_prescr;	
				
			elsif (ie_tipo_item_p = 'O') then	

				select	coalesce(max(a.nr_prescricao),nr_prescricao_p)
		    	into STRICT	nr_prescricao_w
				from	prescr_medica a,
						prescr_gasoterapia b
				where	a.nr_prescricao	= b.nr_prescricao			
				and		b.nr_seq_gas_cpoe	= nr_seq_cpoe_p
				and		dt_horario_p between dt_inicio_prescr and dt_validade_prescr;		
			
			end if;
			
			if	((coalesce(nr_prescricao_w::text, '') = '') and (nr_prescricao_p IS NOT NULL AND nr_prescricao_p::text <> '')) then
				nr_prescricao_w	:= nr_prescricao_p;
			end if;			
			
			vetor_w[cont_w].nr_prescricao_w := nr_prescricao_w;	
		
		elsif (nr_prescricoes_p IS NOT NULL AND nr_prescricoes_p::text <> '') then
			if (nr_prescricao_adic_w > 0) then
				if (position(nr_prescricao_adic_w in nr_prescricoes_p) = 0) then
					nr_prescricoes_w	:= nr_prescricoes_p||','||nr_prescricao_adic_w;
				else
					nr_prescricoes_w	:= nr_prescricoes_p;
				end if;
			else
				nr_prescricoes_w	:= nr_prescricoes_p;
			end if;
			if (substr(nr_prescricoes_w,length(nr_prescricoes_w),1) <> ',') then
				nr_prescricoes_w	:= nr_prescricoes_w ||',';
			end if;
			tamanho_w	:= length(nr_prescricoes_w);
			x		:= 0;
			
			while(x <= tamanho_w) loop
				x := x+1;	
				if (substr(nr_prescricoes_w,x,1) = ',') then
					vetor_w[cont_w].nr_prescricao_w		:= nr_prescr_aux_w;
					nr_prescr_aux_w	:= null;
					cont_w 		:= cont_w + 1;
				else
					nr_prescr_aux_w := nr_prescr_aux_w || substr(nr_prescricoes_w,x,1);
				end if;

			end loop;
		end if;
	end if;

    if (vetor_w.count = 0 and (nr_seq_cpoe_p IS NOT NULL AND nr_seq_cpoe_p::text <> '')) then
        vetor_w[0].nr_seq_cpoe_w := nr_seq_cpoe_p;
    end if;

	/* ajustar horario */

	dt_horario_w := PKG_DATE_UTILS.start_of(dt_horario_p, 'mi', 0);
	
	qt_registros_vetor_w	:= vetor_w.count - 1;
	
	qt_controle_ww		:= 0;
	x			:= -1;
		
	while(x < qt_registros_vetor_w) and (qt_controle_ww		< 1000) loop
		x := x + 1;
		
		if (ie_grava_log_rastr_w = 'S') then
			CALL adep_gerar_log_rastr(substr('APRAZAR_ITEM_PRESCR C01 PARAMETERS' || chr(10) ||
				'{'||chr(10)||
				'"cd_item_p" : "'||cd_item_p||'",'||chr(10)||
				'"cd_setor_pac_w" : "'||cd_setor_pac_w||'",'||chr(10)||
				'"dt_horario_w" : "'||to_char(dt_horario_w, 'dd/mm/yyyy hh24:mi:ss')||'",'||chr(10)||
				'"dt_validade_w" : "'||to_char(dt_validade_w, 'dd/mm/yyyy hh24:mi:ss')||'",'||chr(10)||
				'"ie_aprazar_suspensos_w" : "'||ie_aprazar_suspensos_w||'",'||chr(10)||
				'"ie_data_lib_prescr_w" : "'||ie_data_lib_prescr_w||'",'||chr(10)||
				'"ie_tipo_item_p" : "'||ie_tipo_item_p||'",'||chr(10)||
				'"nr_atendimento_p" : "'||nr_atendimento_p||'"}',1,1500));
		end if;
				
		open C01;
		loop
		fetch C01 into	
			nr_prescricao_w,
			ie_acm_w,
			ie_sn_w,
			cd_refeicao_w,
			nr_seq_dieta_w;
		EXIT WHEN NOT FOUND; /* apply on C01 */
			begin
			
			ie_cursor_w := 'S';
			
			select	max(dt_liberacao),
				max(cd_estabelecimento)
			into STRICT	dt_liberacao_w,
				cd_estabelecimento_w
			from	prescr_medica
			where	nr_prescricao = nr_prescricao_w;

			select	coalesce(max(qt_min_agora),0),
				coalesce(max(qt_min_especial),0),
				max(ie_classif_urgencia),
				coalesce(max(ie_forma_agora), 'N')
			into STRICT	qt_min_agora_w,
				qt_min_especial_w,
				ie_classif_nao_padrao_w,
				ie_agora_impressao_w
			from	parametros_farmacia
			where	cd_estabelecimento = cd_estabelecimento_w;
			
			dt_limite_agora_w	:= dt_liberacao_w + qt_min_agora_w/1440;
			dt_limite_especial_w	:= dt_liberacao_w + qt_min_especial_w/1440;

			if (coalesce(ie_gerar_classif_agora_w,'N') = 'S') then
				dt_hora_atual_w := clock_timestamp();
				dt_limite_agora_w	:=  dt_hora_atual_w + qt_min_agora_w/1440; 			
			end if;
			
			if (ie_sn_w = 'S') or (ie_acm_w = 'S') then			
				ie_acm_sn_w := 'S';
			else
				ie_acm_sn_w := 'N';
			end if;	
			
			if (ie_aprazar_interv_p = 'N') then
				begin
				ie_aprazar_w := 'S';
				if (ie_aprazar_w = 'S') then
					begin
					
					ie_liberado_w := 'N';
					
					select	coalesce(max('S'),'N')
					into STRICT	ie_liberado_w
					from	prescr_dieta_hor	
					where	nr_prescricao = nr_prescricao_w
					and	(dt_lib_horario IS NOT NULL AND dt_lib_horario::text <> '');				
					
					select	nextval('prescr_dieta_hor_seq')
					into STRICT	nr_seq_horario_w
					;

					insert into prescr_dieta_hor(
						nr_sequencia,
						dt_atualizacao_nrec,
						nm_usuario_nrec,
						dt_atualizacao,
						nm_usuario,
						nr_prescricao,
						dt_horario,
						dt_fim_horario,
						dt_suspensao,
						nm_usuario_reaprazamento,
						qt_hor_reaprazamento,
						cd_refeicao,
						ie_aprazado,
						dt_lib_horario,
						nr_seq_dieta)
					values (
						nr_seq_horario_w,
						clock_timestamp(),
						nm_usuario_p,
						clock_timestamp(),
						nm_usuario_p,
						nr_prescricao_w,					
						dt_horario_w,
						null,
						null,
						null,
						null,
						cd_refeicao_w,
						'S',
						CASE WHEN ie_liberado_w='N' THEN  null  ELSE clock_timestamp() END ,
						nr_seq_dieta_w);
					
					if (coalesce(nr_seq_classif_param_w ,0) > 0)	then
						begin
						update	prescr_mat_hor
						set	nr_seq_classif		= nr_seq_classif_param_w
						where	nr_prescricao		= nr_prescricao_w	
						and	nr_sequencia		= nr_seq_horario_w;
						end;
					else
						if (ie_grava_log_rastr_w = 'S') then
							CALL adep_gerar_log_rastr(substr('APRAZAR_ITEM_PRESCR C11 LINE 1412 PARAMETERS' || chr(10) ||
								'{'||chr(10)||
								'"cd_estabelecimento_w" : "'||cd_estabelecimento_w||'"}',1,1500));
						end if;
						open C11;
						loop
						fetch C11 into	
							nr_seq_classif_w,
							ie_classif_urgente_w,
							ie_controlado_w,
							ie_padronizado_w;
						EXIT WHEN NOT FOUND; /* apply on C11 */
							begin
							if (ie_controlado_w = 'A') and (ie_padronizado_w = 'A') then
								update	prescr_mat_hor
								set	nr_seq_classif		= nr_seq_classif_w
								where	nr_prescricao		= nr_prescricao_w	
								and	nr_sequencia		= nr_seq_horario_w
								--and	nr_seq_lote		is not null
								and	ie_classif_urgente	= ie_classif_urgente_w;
							elsif (ie_controlado_w = 'A') and (ie_padronizado_w = 'S') then
								update	prescr_mat_hor
								set	nr_seq_classif		= nr_seq_classif_w
								where	nr_prescricao		= nr_prescricao_w
								and	ie_padronizado		= 'S'
								and	nr_sequencia		= nr_seq_horario_w
								--and	nr_seq_lote		is not null
								and	ie_classif_urgente	= ie_classif_urgente_w;
							elsif (ie_controlado_w = 'A') and (ie_padronizado_w = 'N') then
								update	prescr_mat_hor
								set	nr_seq_classif		= nr_seq_classif_w
								where	nr_prescricao		= nr_prescricao_w
								and	ie_padronizado		= 'N'
								and	nr_sequencia		= nr_seq_horario_w
								--and	nr_seq_lote		is not null
								and	ie_classif_urgente	= ie_classif_urgente_w;
							elsif (ie_controlado_w = 'N') and (ie_padronizado_w = 'A') then
								update	prescr_mat_hor
								set	nr_seq_classif		= nr_seq_classif_w
								where	nr_prescricao		= nr_prescricao_w
								and	ie_controlado		= 'N'
								and	nr_sequencia		= nr_seq_horario_w
								--and	nr_seq_lote		is not null
								and	ie_classif_urgente	= ie_classif_urgente_w;
							elsif (ie_controlado_w = 'N') and (ie_padronizado_w = 'N') then
								update	prescr_mat_hor
								set	nr_seq_classif		= nr_seq_classif_w
								where	nr_prescricao		= nr_prescricao_w
								and	ie_controlado		= 'N'
								and	ie_padronizado		= 'N'
								and	nr_sequencia		= nr_seq_horario_w
								--and	nr_seq_lote		is not null
								and	ie_classif_urgente	= ie_classif_urgente_w;
							elsif (ie_controlado_w = 'N') and (ie_padronizado_w = 'S') then
								update	prescr_mat_hor
								set	nr_seq_classif		= nr_seq_classif_w
								where	nr_prescricao		= nr_prescricao_w
								and	ie_controlado		= 'N'
								and	ie_padronizado		= 'S'
								--and	nr_seq_lote		is not null
								and	nr_sequencia		= nr_seq_horario_w
								and	ie_classif_urgente	= ie_classif_urgente_w;
							elsif (ie_controlado_w = 'S') and (ie_padronizado_w = 'A') then
								update	prescr_mat_hor
								set	nr_seq_classif		= nr_seq_classif_w
								where	nr_prescricao		= nr_prescricao_w
								and	ie_controlado		= 'S'
								--and	nr_seq_lote		is not null
								and	nr_sequencia		= nr_seq_horario_w
								and	ie_classif_urgente	= ie_classif_urgente_w;
							elsif (ie_controlado_w = 'S') and (ie_padronizado_w = 'N') then
								update	prescr_mat_hor
								set	nr_seq_classif		= nr_seq_classif_w
								where	nr_prescricao		= nr_prescricao_w
								and	ie_controlado		= 'S'
								and	ie_padronizado		= 'N'
								--and	nr_seq_lote		is not null
								and	nr_sequencia		= nr_seq_horario_w
								and	ie_classif_urgente	= ie_classif_urgente_w;
							elsif (ie_controlado_w = 'S') and (ie_padronizado_w = 'S') then
								update	prescr_mat_hor
								set	nr_seq_classif		= nr_seq_classif_w
								where	nr_prescricao		= nr_prescricao_w
								and	ie_controlado		= 'S'
								and	ie_padronizado		= 'S'
								--and	nr_seq_lote		is not null
								and	nr_sequencia		= nr_seq_horario_w
								and	ie_classif_urgente	= ie_classif_urgente_w;
							end if;
						
							end;
						end loop;
						close C11;
					end if;
					/* gerar evento aprazamento */

					if (nr_prescr_atual_w <> nr_prescricao_w) and (coalesce(nr_seq_horario_w,0) > 0) and (coalesce(ie_gerar_evento_p,'S') <> 'N') then
						CALL gerar_evento_reaprazamento(nr_atendimento_p, nr_prescricao_w, nr_seq_item_w, nr_seq_horario_w, cd_item_p, ie_tipo_item_p, ie_alteracao_w, nr_seq_motivo_p, ds_justificativa_p, nm_usuario_p, nr_seq_proc_interno_p,ie_acm_sn_w,nr_seq_assinatura_p);
					end if;

					if (nr_prescr_atual_w <> nr_prescricao_w) and (coalesce(nr_seq_horario_w,0) > 0) then
						--(nvl(ie_gerar_evento_p,'S') <> 'N') then
						--gerar_evento_reaprazamento(nr_atendimento_p, nr_prescricao_w, nr_seq_item_w, nr_seq_horario_w, cd_item_p, ie_tipo_item_p, ie_alteracao_w, nr_seq_motivo_p, ds_justificativa_p, nm_usuario_p, nr_seq_proc_interno_p,ie_acm_sn_w,nr_seq_assinatura_p);
						CALL adep_gerar_area_prep(nr_prescricao_w, null, nm_usuario_p);
						CALL Gerar_Lote_Atend_Prescricao(nr_prescricao_w, nr_seq_item_w, nr_seq_horario_w, 'S', nm_usuario_p, 'AIP');
						CALL gerar_acm_sn_apraz_prescricao(nr_prescricao_w, nr_seq_item_w,cd_local_estoque_w,nm_usuario_p);	
					end if;

					/* atualizar prescricao */

					nr_prescr_atual_w := nr_prescricao_w;
					end;
				else
					ie_inconsistencia_w := 'H';
					if (coalesce(ds_inconsistentes_w::text, '') = '') then
						ds_inconsistentes_w := to_char(nr_prescricao_w);
					elsif (position(nr_prescricao_w in ds_inconsistentes_w) = 0) then
						ds_inconsistentes_w := ds_inconsistentes_w || ', ' || to_char(nr_prescricao_w);
					end if;
				end if;			
				end;
			elsif (ie_aprazar_interv_p = 'S') then
				CALL aprazar_item_prescr_interv(ie_tipo_item_p, nr_prescricao_w, nr_seq_item_w, dt_horario_p, nr_seq_motivo_p, ds_justificativa_p, nm_usuario_p, nr_seq_assinatura_p);
			end if;
			
			end;
		end loop;
		close C01;
		
		if (ie_grava_log_rastr_w = 'S') then
			CALL adep_gerar_log_rastr(substr('APRAZAR_ITEM_PRESCR C02 PARAMETERS' || chr(10) ||
				'{'||chr(10)||
				'"cd_intervalo_p" : "'||cd_intervalo_p||'",'||chr(10)||
				'"cd_item_p" : "'||cd_item_p||'",'||chr(10)||
				'"cd_setor_pac_w" : "'||cd_setor_pac_w||'",'||chr(10)||
				'"dt_horario_w" : "'||to_char(dt_horario_w, 'dd/mm/yyyy hh24:mi:ss')||'",'||chr(10)||
				'"dt_validade_w" : "'||to_char(dt_validade_w, 'dd/mm/yyyy hh24:mi:ss')||'",'||chr(10)||
				'"ie_aprazar_suspensos_w" : "'||ie_aprazar_suspensos_w||'",'||chr(10)||
				'"ie_data_lib_prescr_w" : "'||ie_data_lib_prescr_w||'",'||chr(10)||
				'"ie_tipo_item_p" : "'||ie_tipo_item_p||'",'||chr(10)||
				'"nr_atendimento_p" : "'||nr_atendimento_p||'",'||chr(10)||
				'"qt_item_p" : "'||qt_item_p||'"}',1,1500));
		end if;
		
		open C02;
		loop
		fetch C02 into	
			nr_prescricao_w,
			nr_seq_item_w,
			cd_local_estoque_w,
			nr_agrupamento_w,
			cd_material_w,
			cd_unidade_medida_w,		
			ie_sn_w,
			ie_acm_w,
			qt_total_dispensar_w;
		EXIT WHEN NOT FOUND; /* apply on C02 */
			begin
			ie_cursor_w := 'S';
			
			select	max(dt_liberacao),
				max(cd_estabelecimento)
			into STRICT	dt_liberacao_w,
				cd_estabelecimento_w
			from	prescr_medica
			where	nr_prescricao = nr_prescricao_w;

			select	coalesce(max(qt_min_agora),0),
				coalesce(max(qt_min_especial),0),
				max(ie_classif_urgencia),
				coalesce(max(ie_forma_agora), 'N'),
				coalesce(max(ie_gera_disp_acm_sn),'S')
			into STRICT	qt_min_agora_w,
				qt_min_especial_w,
				ie_classif_nao_padrao_w,
				ie_agora_impressao_w,
				ie_gera_disp_acm_sn_w
			from	parametros_farmacia
			where	cd_estabelecimento = cd_estabelecimento_w;
			
			dt_limite_agora_w	:= dt_liberacao_w + qt_min_agora_w/1440;
			dt_limite_especial_w	:= dt_liberacao_w + qt_min_especial_w/1440;
			
			if (coalesce(ie_gerar_classif_agora_w,'N') = 'S') then
				dt_hora_atual_w := clock_timestamp();
				dt_limite_agora_w	:=  dt_hora_atual_w + qt_min_agora_w/1440; 			
			end if;

			if (ie_sn_w = 'S') or (ie_acm_w = 'S') then			
				ie_acm_sn_w := 'S';
			else
				ie_acm_sn_w := 'N';
			end if;	
			
			if (ie_aprazar_interv_p = 'N') then
				begin
				ie_aprazar_w := 'S';
				if (ie_aprazar_w = 'S') then
					begin
			
					select	cd_estabelecimento,
						cd_setor_atendimento,
						dt_inicio_prescr
					into STRICT	cd_estab_prescr_w,
						cd_setor_prescr_w,
						dt_inicio_prescr_w
					from	prescr_medica
					where	nr_prescricao = nr_prescricao_w;
					
					ie_agrupador_w	:= 12;
					
					/* obter informacoes horario original */

					select	coalesce(min(nr_sequencia),0)
					into STRICT	nr_seq_orig_w
					from	prescr_mat_hor
					where	nr_prescricao = nr_prescricao_w
					and	nr_seq_material = nr_seq_item_w
					and	coalesce(ie_situacao,'A') = 'A'
					and	Obter_se_horario_liberado(dt_lib_horario, dt_horario) = 'S';
										
					if (nr_seq_orig_w > 0) then
						select	qt_dose,
							qt_dispensar,
							qt_dispensar_hor,
							cd_unidade_medida,
							cd_unidade_medida_dose
						into STRICT	qt_dose_w,
							qt_dispensar_w,
							qt_dispensar_hor_w,
							cd_unidade_medida_w,
							cd_unidade_medida_dose_w
						from	prescr_mat_hor
						where	nr_sequencia = nr_seq_orig_w
						and	Obter_se_horario_liberado(dt_lib_horario, dt_horario) = 'S';
					else		
						cd_unid_med_dose_hor_w := null;
						qt_dose_hor_w	:= null;	
														
						SELECT * FROM obter_dose_um_horario_pmh(cd_material_w, qt_item_p, cd_unidade_medida_dose_w, qt_dose_hor_w, cd_unid_med_dose_hor_w) INTO STRICT qt_dose_hor_w, cd_unid_med_dose_hor_w;							
					end if;
							
					select	coalesce(max(substr(Obter_se_medic_controlado(cd_item_p),1,1)),'N'),
						coalesce(max(substr(obter_se_material_padronizado(cd_estabelecimento_w, cd_item_p),1,1)),'N')
					into STRICT	ie_controlado_w,
						ie_padronizado_w
					;
					
					/*	Fabio e JonasJonas - 19/01/2010 = Para gerar os lotes como AGORA dependendo do horario final do turno, e nao mais pelo minutos de agora*/

					if (ie_agora_impressao_w = 'S') then
						nr_seq_turno_hor_ag_w	:= obter_turno_horario_prescr(cd_estabelecimento_w,cd_setor_prescr_w,to_char(dt_horario_w,'hh24:mi'),cd_local_estoque_w);
						select	max(to_char(b.hr_inicial,'hh24:mi')),
							max(to_char(b.hr_final,'hh24:mi'))
						into STRICT	hr_turno_agora_w,
							hr_final_turno_agora_w
						from	regra_turno_disp_param b,
							regra_turno_disp a
						where	a.nr_sequencia		= b.nr_seq_turno
						and	a.cd_estabelecimento	= cd_estabelecimento_w
						and	a.nr_sequencia		= nr_seq_turno_hor_ag_w
						and (coalesce(b.cd_setor_atendimento,coalesce(cd_setor_prescr_w,0))	= coalesce(cd_setor_prescr_w,0));

						select	coalesce(max(qt_min_antes_atend), 0),
							coalesce(max(ie_define_agora), 'N')
						into STRICT	qt_min_antes_atend_w,
							ie_define_agora_w
						from	regra_tempo_disp
						where	cd_estabelecimento	= cd_estabelecimento_w
						and (coalesce(cd_setor_atendimento,coalesce(cd_setor_prescr_w,0)) = coalesce(cd_setor_prescr_w,0))
						and	nr_seq_turno = nr_seq_turno_hor_ag_w
						and	ie_situacao = 'A';

						if (hr_turno_agora_w > hr_final_turno_agora_w) then
							
                            if (ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_horario_w) > ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_inicio_prescr_w)) then
								dt_limite_agora_w := PKG_DATE_UTILS.get_Time(dt_horario_w - 1, hr_turno_agora_w) - (qt_min_antes_atend_w/1440);
							else
								dt_limite_agora_w := PKG_DATE_UTILS.get_Time(dt_horario_w, hr_turno_agora_w) - (qt_min_antes_atend_w/1440);
							end if;
						else
							dt_limite_agora_w := PKG_DATE_UTILS.get_Time(dt_horario_w, hr_turno_agora_w) - (qt_min_antes_atend_w/1440);
						end if;
					end if;
					/*	Fabio e Jonas - 19/01/2010 = Final da alteracao*/

					
					if (coalesce(ie_classif_nao_padrao_w::text, '') = '') or (ie_padronizado_w = 'S') then
						begin
						ie_classif_urgente_w	:= 'N';
						if (dt_horario_w <= dt_limite_agora_w) then
							ie_classif_urgente_w	:= 'A';						
						elsif	((dt_limite_agora_w <= clock_timestamp()) and (ie_agora_impressao_w = 'S') and (ie_define_agora_w = 'N')) then
							ie_classif_urgente_w	:= 'A';
						elsif (ie_agora_impressao_w = 'S' and ie_define_agora_w = 'S') and
							(dt_horario_w <= (clock_timestamp() + (qt_min_antes_atend_w /1440))) then
							ie_classif_urgente_w	:= 'A';
						elsif (dt_horario_w <= dt_limite_especial_w) then
							ie_classif_urgente_w	:= 'E';
						end if;
						end;
					else
						ie_classif_urgente_w	:= ie_classif_nao_padrao_w;
					end if;
					
					ie_liberado_w := 'N';
					
					if (ie_gera_disp_acm_sn_w = 'N' AND (ie_acm_w = 'S' or ie_sn_w = 'S' )) then
						ie_gerar_lote_w := 'S';
						
						update	prescr_material
						set		ie_gerar_lote 	    = 'S'
						where	nr_prescricao		= nr_prescricao_w
						and	nr_sequencia_diluicao	= nr_seq_item_w;
					end if;

					select	coalesce(max('S'),'N')
					into STRICT	ie_liberado_w
					from	prescr_mat_hor	
					where	nr_prescricao = nr_prescricao_w
					and	(dt_lib_horario IS NOT NULL AND dt_lib_horario::text <> '');
					
					select	nextval('prescr_mat_hor_seq')
					into STRICT	nr_seq_horario_w
					;

					insert into prescr_mat_hor(
						nr_sequencia,
						nr_seq_digito,
						nr_prescricao,
						nr_seq_material,
						ie_agrupador,
						dt_atualizacao,
						nm_usuario,
						dt_atualizacao_nrec,
						nm_usuario_nrec,
						cd_material,
						qt_dose,
						qt_dispensar_hor,
						ds_horario,
						dt_horario,
						cd_unidade_medida,
						cd_unidade_medida_dose,
						ie_urgente,
						dt_emissao_farmacia,
						dt_fim_horario,
						dt_suspensao,
						ie_horario_especial,
						qt_hor_reaprazamento,
						nm_usuario_reaprazamento,
						nr_seq_turno,
						dt_disp_farmacia,
						ie_aprazado,
						ie_classif_urgente,
						ie_padronizado,
						ie_controlado,
						cd_unid_med_hor,
						qt_horario,
						ie_gerar_lote,
						dt_lib_horario,
						qt_dispensar,
						nr_atendimento)
					values (
						nr_seq_horario_w,
						calcula_digito('MODULO11',nr_seq_horario_w),
						nr_prescricao_w,
						nr_seq_item_w,			
						ie_agrupador_w,
						clock_timestamp(),
						nm_usuario_p,
						clock_timestamp(),
						nm_usuario_p,
						cd_item_p,
						qt_dose_w,
						qt_dispensar_hor_w,
						to_char(dt_horario_w,'hh24:mi'),
						dt_horario_w,
						cd_unidade_medida_w,
						cd_unidade_medida_dose_w,
						'N',
						CASE WHEN ie_gerar_necessidade_disp_w='S' THEN null  ELSE clock_timestamp() END ,
						null,
						null,
						'N',
						null,
						null,
						obter_turno_horario_prescr(cd_estab_prescr_w,cd_setor_prescr_w,to_char(dt_horario_w,'hh24:mi'),cd_local_estoque_w),
						clock_timestamp(),
						'S',
						ie_classif_urgente_w,
						ie_padronizado_w,
						ie_controlado_w,
						coalesce(cd_unid_med_dose_hor_w, cd_unidade_medida_dose_w),
						qt_dose_w,
						coalesce(ie_gerar_lote_w,'S'),
						CASE WHEN ie_liberado_w='N' THEN  null  ELSE clock_timestamp() END ,
						qt_total_dispensar_w,
						nr_atendimento_p);
						
						CALL adep_gerar_area_prep(nr_prescricao_w, null, nm_usuario_p);
						if (ie_gerar_proc_gedipa_job_w	= 'N') and (ie_liberado_w	= 'S') then
							CALL Gedipa_Gerar_Proc_Instantaneo(nr_prescricao_w,nr_seq_item_w,null,nr_seq_horario_w);
						end if;
						
						CALL Gerar_Gedi_Medic_atend(cd_estabelecimento_w, nr_prescricao_w, nr_seq_item_w, nr_seq_horario_w, nm_usuario_p);
						
						if (coalesce(nr_seq_classif_param_w ,0) > 0)	then
							begin
							update	prescr_mat_hor
							set	nr_seq_classif		= nr_seq_classif_param_w
							where	nr_prescricao		= nr_prescricao_w	
							and	nr_sequencia		= nr_seq_horario_w;
							end;
						else
							if (ie_grava_log_rastr_w = 'S') then
								CALL adep_gerar_log_rastr(substr('APRAZAR_ITEM_PRESCR C11 LINE 1837 PARAMETERS' || chr(10) ||
									'{'||chr(10)||
									'"cd_estabelecimento_w" : "'||cd_estabelecimento_w||'"}',1,1500));
							end if;						
							open C11;
							loop
							fetch C11 into	
								nr_seq_classif_w,
								ie_classif_urgente_w,
								ie_controlado_w,
								ie_padronizado_w;
							EXIT WHEN NOT FOUND; /* apply on C11 */
								begin
								if (ie_controlado_w = 'A') and (ie_padronizado_w = 'A') then
									update	prescr_mat_hor
									set	nr_seq_classif		= nr_seq_classif_w
									where	nr_prescricao		= nr_prescricao_w	
									and	nr_sequencia		= nr_seq_horario_w
									--and	nr_seq_lote		is not null
									and	ie_classif_urgente	= ie_classif_urgente_w;
								elsif (ie_controlado_w = 'A') and (ie_padronizado_w = 'S') then
									update	prescr_mat_hor
									set	nr_seq_classif		= nr_seq_classif_w
									where	nr_prescricao		= nr_prescricao_w
									and	ie_padronizado		= 'S'
									and	nr_sequencia		= nr_seq_horario_w
									--and	nr_seq_lote		is not null
									and	ie_classif_urgente	= ie_classif_urgente_w;
								elsif (ie_controlado_w = 'A') and (ie_padronizado_w = 'N') then
									update	prescr_mat_hor
									set	nr_seq_classif		= nr_seq_classif_w
									where	nr_prescricao		= nr_prescricao_w
									and	ie_padronizado		= 'N'
									and	nr_sequencia		= nr_seq_horario_w
									--and	nr_seq_lote		is not null
									and	ie_classif_urgente	= ie_classif_urgente_w;
								elsif (ie_controlado_w = 'N') and (ie_padronizado_w = 'A') then
									update	prescr_mat_hor
									set	nr_seq_classif		= nr_seq_classif_w
									where	nr_prescricao		= nr_prescricao_w
									and	ie_controlado		= 'N'
									and	nr_sequencia		= nr_seq_horario_w
									--and	nr_seq_lote		is not null
									and	ie_classif_urgente	= ie_classif_urgente_w;
								elsif (ie_controlado_w = 'N') and (ie_padronizado_w = 'N') then
									update	prescr_mat_hor
									set	nr_seq_classif		= nr_seq_classif_w
									where	nr_prescricao		= nr_prescricao_w
									and	ie_controlado		= 'N'
									and	ie_padronizado		= 'N'
									and	nr_sequencia		= nr_seq_horario_w
									--and	nr_seq_lote		is not null
									and	ie_classif_urgente	= ie_classif_urgente_w;
								elsif (ie_controlado_w = 'N') and (ie_padronizado_w = 'S') then
									update	prescr_mat_hor
									set	nr_seq_classif		= nr_seq_classif_w
									where	nr_prescricao		= nr_prescricao_w
									and	ie_controlado		= 'N'
									and	ie_padronizado		= 'S'
									--and	nr_seq_lote		is not null
									and	nr_sequencia		= nr_seq_horario_w
									and	ie_classif_urgente	= ie_classif_urgente_w;
								elsif (ie_controlado_w = 'S') and (ie_padronizado_w = 'A') then
									update	prescr_mat_hor
									set	nr_seq_classif		= nr_seq_classif_w
									where	nr_prescricao		= nr_prescricao_w
									and	ie_controlado		= 'S'
									--and	nr_seq_lote		is not null
									and	nr_sequencia		= nr_seq_horario_w
									and	ie_classif_urgente	= ie_classif_urgente_w;
								elsif (ie_controlado_w = 'S') and (ie_padronizado_w = 'N') then
									update	prescr_mat_hor
									set	nr_seq_classif		= nr_seq_classif_w
									where	nr_prescricao		= nr_prescricao_w
									and	ie_controlado		= 'S'
									and	ie_padronizado		= 'N'
									--and	nr_seq_lote		is not null
									and	nr_sequencia		= nr_seq_horario_w
									and	ie_classif_urgente	= ie_classif_urgente_w;
								elsif (ie_controlado_w = 'S') and (ie_padronizado_w = 'S') then
									update	prescr_mat_hor
									set	nr_seq_classif		= nr_seq_classif_w
									where	nr_prescricao		= nr_prescricao_w
									and	ie_controlado		= 'S'
									and	ie_padronizado		= 'S'
									--and	nr_seq_lote		is not null
									and	nr_sequencia		= nr_seq_horario_w
									and	ie_classif_urgente	= ie_classif_urgente_w;
								end if;
							
								end;
							end loop;
							close C11;
						end if;
					
						if (ie_gerar_necessidade_disp_w = 'S') then

							if	((ie_acm_w = 'S') or (ie_sn_w = 'S' )) then
								if (ie_imprimir_acm_sn_w = 'S') then
									update	prescr_medica
									set	dt_emissao_farmacia	 = NULL,
										nm_usuario_imp_far	 = NULL
									where	nr_prescricao		= nr_prescricao_w;
								end if;
							else	
								update	prescr_medica
								set	dt_emissao_farmacia	 = NULL,
									nm_usuario_imp_far	 = NULL
								where	nr_prescricao		= nr_prescricao_w;
							end if;
							
							update	prescr_material
							set	cd_motivo_baixa	= 0,
								dt_baixa	 = NULL
							where	nr_prescricao	= nr_prescricao_w
							and	nr_sequencia	= nr_seq_item_w;
							
							if (ie_gerar_nec_disp_kit_w = 'S') then
								update	prescr_material
								set	cd_motivo_baixa	= 0,
									dt_baixa	 = NULL
								where	nr_prescricao		= nr_prescricao_w
								and	nr_sequencia_diluicao	= nr_seq_item_w;
								
								update	prescr_material
								set	cd_motivo_baixa	= 0,
									dt_baixa	 = NULL
								where	nr_prescricao	= nr_prescricao_w
								and	nr_seq_kit	= nr_seq_item_w;
							end if;
						end if;
						/* gerar evento aprazamento */

						if (nr_prescr_atual_w <> nr_prescricao_w) and (coalesce(nr_seq_horario_w,0) > 0) and (coalesce(ie_gerar_evento_p,'S') <> 'N') then
							--adep_gerar_area_prep(nr_prescricao_w, null, nm_usuario_p);
							CALL Gerar_Lote_Atend_Prescricao(nr_prescricao_w, nr_seq_item_w, nr_seq_horario_w, 'S', nm_usuario_p, 'AIP');
							CALL gerar_evento_reaprazamento(nr_atendimento_p, nr_prescricao_w, nr_seq_item_w, nr_seq_horario_w, cd_item_p, ie_tipo_item_p, ie_alteracao_w, nr_seq_motivo_p, ds_justificativa_p, nm_usuario_p, nr_seq_proc_interno_p,ie_acm_sn_w,nr_seq_assinatura_p);
							CALL gerar_acm_sn_apraz_prescricao(nr_prescricao_w, nr_seq_item_w,cd_local_estoque_w,nm_usuario_p);	
						end if;

						/* atualizar prescricao */

						nr_prescr_atual_w := nr_prescricao_w;	
						end;
					else
						ie_inconsistencia_w := 'H';
						if (coalesce(ds_inconsistentes_w::text, '') = '') then
							ds_inconsistentes_w := to_char(nr_prescricao_w);
						elsif (position(nr_prescricao_w in ds_inconsistentes_w) = 0) then
							ds_inconsistentes_w := ds_inconsistentes_w || ', ' || to_char(nr_prescricao_w);
						end if;		

					end if;
				end;
			elsif (ie_aprazar_interv_p = 'S') then
				CALL aprazar_item_prescr_interv(ie_tipo_item_p, nr_prescricao_w, nr_seq_item_w, dt_horario_p, nr_seq_motivo_p, ds_justificativa_p, nm_usuario_p, nr_seq_assinatura_p);
			end if;		
			
			if (ie_gera_nutricao_w = 'S') and ((ie_gerar_serv_supl_w = 'A') or (ie_gerar_serv_supl_w = 'T')) then
				CALL gerar_servico_nut_pep(nr_prescricao_w,nm_usuario_p,cd_perfil_w);
			end if;
				
			end;
		end loop;
		close C02;
		
		if (ie_grava_log_rastr_w = 'S') then
			CALL adep_gerar_log_rastr(substr('APRAZAR_ITEM_PRESCR C03 PARAMETERS' || chr(10) ||
				'{'||chr(10)||
				'"vetor_w(x).nr_prescricao_w" : "'||vetor_w[x].nr_prescricao_w||'",'||chr(10)||
				'"cd_intervalo_p" : "'||cd_intervalo_p||'",'||chr(10)||
				'"cd_item_p" : "'||cd_item_p||'",'||chr(10)||
				'"cd_setor_pac_w" : "'||cd_setor_pac_w||'",'||chr(10)||
				'"cd_unidade_medida_p" : "'||cd_unidade_medida_p||'",'||chr(10)||
				'"dt_horario_w" : "'||to_char(dt_horario_w, 'dd/mm/yyyy hh24:mi:ss')||'",'||chr(10)||
				'"dt_validade_w" : "'||to_char(dt_validade_w, 'dd/mm/yyyy hh24:mi:ss')||'",'||chr(10)||
				'"ie_acm_sn_p" : "'||ie_acm_sn_p||'",'||chr(10)||
				'"ie_aprazar_agrupados_w" : "'||ie_aprazar_agrupados_w||'",'||chr(10)||
				'"ie_aprazar_suspensos_w" : "'||ie_aprazar_suspensos_w||'",'||chr(10)||
				'"ie_data_lib_prescr_w" : "'||ie_data_lib_prescr_w||'",'||chr(10)||
				'"ie_permite_antes_val_w" : "'||ie_permite_antes_val_w||'",'||chr(10)||
				'"ie_tipo_item_p" : "'||ie_tipo_item_p||'",'||chr(10)||
				'"ie_via_aplicacao_p" : "'||ie_via_aplicacao_p||'",'||chr(10)||
				'"nr_agrupamento_p" : "'||nr_agrupamento_p||'",'||chr(10)||
				'"nr_atendimento_p" : "'||nr_atendimento_p||'",'||chr(10)||
				'"nr_prescr_w" : "'||nr_prescr_w||'",'||chr(10)||
				'"nr_prescr_ww" : "'||nr_prescr_w||'",'||chr(10)||
				'"nr_prescr_www" : "'||nr_prescr_w||'",'||chr(10)||
				'"nr_prescricao_p" : "'||nr_prescricao_p||'",'||chr(10)||
				'"nr_seq_cpoe_p" : "'||nr_seq_cpoe_p||'",'||chr(10)||
				'"nr_seq_item_p" : "'||nr_seq_item_p||'",'||chr(10)||
				'"nr_seq_objeto_p" : "'||nr_seq_objeto_p||'",'||chr(10)||
				'"nr_ultima_prescr_w" : "'||nr_ultima_prescr_w||'",'||chr(10)||
                '"dt_inicio_prescr_cpoe_w" : "'||to_char(dt_inicio_prescr_cpoe_w, 'dd/mm/yyyy hh24:mi:ss')||'",'||chr(10)||
                '"dt_fim_prescr_cpoe_w" : "'||to_char(dt_fim_prescr_cpoe_w, 'dd/mm/yyyy hh24:mi:ss')||'",'||chr(10)||
				'"qt_item_p" : "'||qt_item_p||'"}',1,1500));
		end if;
		
		open C03;
		loop
		fetch C03 into	
			nr_prescricao_w,
			nr_seq_item_w,
			cd_local_estoque_w,
			nr_agrupamento_w,
			cd_material_w,		
			cd_unidade_medida_w,		
			ie_sn_w,
			ie_acm_w,
			qt_total_dispensar_w,
			dt_proxima_dose_w,
			qt_hora_intervalo_w,
			dt_validade_prescr_w,
			ie_regra_disp_w,
			ie_kit_gerado_w;
		EXIT WHEN NOT FOUND; /* apply on C03 */
			begin			
			ie_cursor_w := 'S';
			
			CALL Consistir_qt_aprazamento(cd_perfil_w, cd_item_p, nr_prescricao_w, nr_seq_item_w);
			
			select	max(dt_liberacao),
				max(cd_estabelecimento)
			into STRICT	dt_liberacao_w,
				cd_estabelecimento_w
			from	prescr_medica
			where	nr_prescricao = nr_prescricao_w;

			select	coalesce(max(qt_min_agora),0),
				coalesce(max(qt_min_especial),0),
				max(ie_classif_urgencia),
				coalesce(max(ie_forma_agora), 'N'),
				coalesce(max(ie_gera_integracao),'N'),
				coalesce(MAX(ie_gera_disp_acm_sn),'S')
			into STRICT	qt_min_agora_w,
				qt_min_especial_w,
				ie_classif_nao_padrao_w,
				ie_agora_impressao_w,
				ie_gera_integracao_w,
				ie_gera_disp_acm_sn_w	
			from	parametros_farmacia
			where	cd_estabelecimento = cd_estabelecimento_w;
			
			dt_limite_agora_w	:= dt_liberacao_w + qt_min_agora_w/1440;
			dt_limite_especial_w	:= dt_liberacao_w + qt_min_especial_w/1440;
			
			if (coalesce(ie_gerar_classif_agora_w,'N') = 'S') then
				dt_hora_atual_w := clock_timestamp();
				dt_limite_agora_w	:=  dt_hora_atual_w + qt_min_agora_w/1440; 			
			end if;

			if (ie_sn_w = 'S') or (ie_acm_w = 'S') then			
				ie_acm_sn_w := 'S';
			else
				ie_acm_sn_w := 'N';
			end if;
			
			if (ie_aprazar_interv_p = 'N') then
				ie_aprazar_w := 'S';
				if (ie_aprazar_w = 'S') then
					begin
					select	cd_estabelecimento,
						cd_setor_atendimento,
						dt_inicio_prescr
					into STRICT	cd_estab_prescr_w,
						cd_setor_prescr_w,
						dt_inicio_prescr_w
					from	prescr_medica
					where	nr_prescricao = nr_prescricao_w;
					
					cd_setor_atendimento_w := cd_setor_prescr_w;
					
					if (ie_local_estoque_w = 'S') then
						CALL define_local_disp_prescr(nr_prescricao_w, nr_seq_item_w, cd_perfil_w, nm_usuario_p);
						select	max(cd_local_estoque)
						into STRICT	cd_local_estoque_w
						from	prescr_material b
						where	nr_prescricao	= nr_prescricao_w
						and	nr_sequencia	= nr_seq_item_w;
						
						cd_setor_atendimento_w		:= Obter_Setor_Atendimento(nr_atendimento_p);
					elsif (ie_local_estoque_w = 'R') then
						CALL define_local_disp_prescr(nr_prescricao_w, nr_seq_item_w, cd_perfil_w, nm_usuario_p);
						select	max(cd_local_estoque)
						into STRICT	cd_local_estoque_w
						from	prescr_material b
						where	nr_prescricao	= nr_prescricao_w
						and	nr_sequencia	= nr_seq_item_w;
						
						cd_setor_atendimento_w		:= Obter_Setor_Atendimento_lib(nr_atendimento_p);
					end if;
					
					ie_agrupador_w	:= 1;
					
					cd_local_estoque_baixa_w	:= null;
	
					if (coalesce(cd_setor_atendimento_w,0) > 0) then	
						select	coalesce(max(cd_local_estoque),0)
						into STRICT	cd_local_estoque_baixa_w
						from	setor_local
						where	cd_setor_atendimento = cd_setor_atendimento_w
						and		ie_loca_estoque_pac = 'S';				
						
						if (cd_local_estoque_baixa_w = 0) then
							cd_local_estoque_baixa_w := null;
						end if;
					end if;
					
					/* obter informacoes horario original */

					select	coalesce(min(nr_sequencia),0)
					into STRICT	nr_seq_orig_w
					from	prescr_mat_hor
					where	nr_prescricao = nr_prescricao_w
          				and 	coalesce(ie_dose_especial,'N') = 'N'
					and	nr_seq_material = nr_seq_item_w
					and	coalesce(ie_situacao,'A') = 'A'
					and	Obter_se_horario_liberado(dt_lib_horario, dt_horario) = 'S';
										
					if (nr_seq_orig_w > 0) then
						select	qt_dose,
							qt_dispensar,
							qt_dispensar_hor,
							cd_unidade_medida,
							cd_unidade_medida_dose
						into STRICT	qt_dose_w,
							qt_dispensar_w,
							qt_dispensar_hor_w,
							cd_unidade_medida_w,
							cd_unidade_medida_dose_w
						from	prescr_mat_hor
						where	nr_sequencia = nr_seq_orig_w;
					else		
						cd_unid_med_dose_hor_w := null;
						qt_dose_hor_w	:= null;	
														
						SELECT * FROM obter_dose_um_horario_pmh(cd_material_w, qt_item_p, cd_unidade_medida_dose_w, qt_dose_hor_w, cd_unid_med_dose_hor_w) INTO STRICT qt_dose_hor_w, cd_unid_med_dose_hor_w;							
					end if;
					
					ie_controlado_w		:= coalesce(substr(Obter_se_medic_controlado(cd_item_p),1,1),'N');
					ie_padronizado_w	:= coalesce(substr(obter_se_material_padronizado(cd_estabelecimento_w, cd_item_p),1,1),'N');
					
					/*	Fabio e JonasJonas - 19/01/2010 = Para gerar os lotes como AGORA dependendo do horario final do turno, e nao mais pelo minutos de agora*/

					if (ie_agora_impressao_w = 'S') then
						nr_seq_turno_hor_ag_w	:= obter_turno_horario_prescr(cd_estabelecimento_w,cd_setor_prescr_w,to_char(dt_horario_w,'hh24:mi'), cd_local_estoque_w);
						select	max(to_char(b.hr_inicial,'hh24:mi')),
							max(to_char(b.hr_final,'hh24:mi'))
						into STRICT	hr_turno_agora_w,
							hr_final_turno_agora_w
						from	regra_turno_disp_param b,
							regra_turno_disp a
						where	a.nr_sequencia		= b.nr_seq_turno
						and	a.cd_estabelecimento	= cd_estabelecimento_w
						and	a.nr_sequencia		= nr_seq_turno_hor_ag_w
						and (coalesce(b.cd_setor_atendimento,coalesce(cd_setor_prescr_w,0))	= coalesce(cd_setor_prescr_w,0));

						select	coalesce(max(qt_min_antes_atend), 0),
							coalesce(max(ie_define_agora), 'N')
						into STRICT	qt_min_antes_atend_w,
							ie_define_agora_w
						from	regra_tempo_disp
						where	cd_estabelecimento	= cd_estabelecimento_w
						and (coalesce(cd_setor_atendimento,coalesce(cd_setor_prescr_w,0)) = coalesce(cd_setor_prescr_w,0))
						and	nr_seq_turno = nr_seq_turno_hor_ag_w
						and	ie_situacao = 'A';

						if (hr_turno_agora_w > hr_final_turno_agora_w) then
							if (ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_horario_w) > ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_inicio_prescr_w)) then
								dt_limite_agora_w := PKG_DATE_UTILS.get_Time(dt_horario_w - 1, hr_turno_agora_w) - (qt_min_antes_atend_w/1440);
							else
								dt_limite_agora_w := PKG_DATE_UTILS.get_Time(dt_horario_w, hr_turno_agora_w) - (qt_min_antes_atend_w/1440);
							end if;
						else
							dt_limite_agora_w := PKG_DATE_UTILS.get_Time(dt_horario_w, hr_turno_agora_w) - (qt_min_antes_atend_w/1440);
						end if;
					end if;
					/*	Fabio e Jonas - 19/01/2010 = Final da alteracao*/

					
					if (coalesce(ie_classif_nao_padrao_w::text, '') = '') or (ie_padronizado_w = 'S') then
						begin
						ie_classif_urgente_w	:= 'N';
						if (dt_horario_w <= dt_limite_agora_w) then
							ie_classif_urgente_w	:= 'A';						
						elsif	((dt_limite_agora_w <= clock_timestamp()) and (ie_agora_impressao_w = 'S') and (ie_define_agora_w = 'N')) then
							ie_classif_urgente_w	:= 'A';
						elsif (ie_agora_impressao_w = 'S' and ie_define_agora_w = 'S') and
							(dt_horario_w <= (clock_timestamp() + (qt_min_antes_atend_w /1440))) then
							ie_classif_urgente_w	:= 'A';
						elsif (dt_horario_w <= dt_limite_especial_w) then
							ie_classif_urgente_w	:= 'E';
						end if;
						end;
					else
						ie_classif_urgente_w	:= ie_classif_nao_padrao_w;
					end if;
									
					ie_liberado_w := 'N';
					
					select	coalesce(max('S'),'N')
					into STRICT	ie_liberado_w
					from	prescr_mat_hor	
					where	nr_prescricao = nr_prescricao_w
					and	(dt_lib_horario IS NOT NULL AND dt_lib_horario::text <> '');
					
					select	count(*)
					into STRICT	qt_item_w
					from	prescr_mat_hor
					where	nr_prescricao		in (nr_prescr_ww, nr_prescr_www)
					and	dt_horario		= dt_horario_w
					and	cd_material		= cd_item_p
					and	qt_dose			= qt_dose_w
					and	ie_agrupador		= ie_agrupador_w
					and	cd_unidade_medida_dose	= cd_unidade_medida_dose_w
					and	(dt_lib_horario IS NOT NULL AND dt_lib_horario::text <> '')
					and	coalesce(ie_horario_especial,'N') <> 'S';					
					
					if (qt_item_w	> 0) then
						
						select	count(*)
						into STRICT	qt_item_w
						from	prescr_mat_hor a,
							prescr_material b
						where	a.nr_prescricao		= b.nr_prescricao
						and	b.nr_sequencia		= a.nr_seq_material
						and	b.nr_prescricao		in (nr_prescr_ww, nr_prescr_www)
						and	a.dt_horario		= dt_horario_w
						and	a.cd_material		= cd_item_p
						and	a.qt_dose			= qt_dose_w
						and	a.ie_agrupador		= ie_agrupador_w
						and	a.cd_unidade_medida_dose	= cd_unidade_medida_dose_w
						and	(a.dt_lib_horario IS NOT NULL AND a.dt_lib_horario::text <> '')
						and	coalesce(a.ie_horario_especial,'N') <> 'S'
						and	coalesce(b.ie_via_aplicacao, coalesce(ie_via_aplicacao_p, 'XPTO')) = coalesce(ie_via_aplicacao_p, 'XPTO')
						and ((coalesce(b.nr_seq_mat_cpoe, 0) = coalesce(nr_seq_cpoe_p, 0)) or (coalesce(nr_seq_cpoe_p::text, '') = ''));
						
					end if;

					if (coalesce(nr_seq_objeto_p,0)	= 3558) then
						ie_horario_adep_w	:= 'N';
					else
						ie_horario_adep_w	:= 'S';
					end if;
					
					if (ie_tipo_item_p in ('M', 'IAH')) and (wheb_assist_pck.Obter_Se_Consiste_REP(31,obter_perfil_ativo) = 'S') and (ie_horario_adep_w = 'S') then
																				
						SELECT * FROM Verifica_dose_maxima(nr_prescricao_w, nr_seq_item_w, 'S', ds_erro_w, ds_erro2_w, dt_horario_w, ie_tipo_cons_w, qt_dose_limite_w, cd_unidade_medida_limte_w) INTO STRICT ds_erro_w, ds_erro2_w, ie_tipo_cons_w, qt_dose_limite_w, cd_unidade_medida_limte_w;

						if ((ds_erro2_w IS NOT NULL AND ds_erro2_w::text <> '') and ((obter_lib_erro_regra_rep(31, cd_perfil_w)) = 'N')) then
							CALL wheb_mensagem_pck.exibir_mensagem_abort(ds_erro2_w || '#@#@');
						elsif (ds_erro2_w IS NOT NULL AND ds_erro2_w::text <> '') then
							ds_inconsistentes_w := ds_erro2_w;							
							ie_inconsistencia_w := 'D';
						end if;
					
					end if;
					if	(ie_gerar_necessidade_disp_w = 'N' AND ie_regra_disp_w = 'N') then
						ie_gerar_lote_w			:= 'N';
						dt_emissao_farmacia_w	:= clock_timestamp();
						qt_dispensar_hor_w		:= 0;
					else
						ie_gerar_lote_w			:= 'S';
						cd_motivo_baixa_w		:= 0;
						dt_emissao_farmacia_w	:= null;
					end if;
					
					if (ie_gera_disp_acm_sn_w = 'N' AND ie_acm_sn_w = 'S') then
						ie_gerar_lote_w := 'S';
						
						update	prescr_material
						set		ie_gerar_lote 	= 'S'
						where	nr_prescricao	= nr_prescricao_w
 						and	nr_sequencia	= nr_seq_item_w;
						
						update	prescr_material
						set		ie_gerar_lote 	= 'S'
						where	nr_prescricao	= nr_prescricao_w
 						and		nr_agrupamento	= nr_agrupamento_w
						and		coalesce(ie_gerar_lote,'N') = 'N';
						
						if (ie_gerar_nec_disp_kit_w = 'S') then
							update	prescr_material
							set		ie_gerar_lote 	= 'S'
							where	nr_prescricao		= nr_prescricao_w
							and	nr_sequencia_diluicao	= nr_seq_item_w;
							
							update	prescr_material
							set		ie_gerar_lote 	= 'S'
							where	nr_prescricao	= nr_prescricao_w
							and	nr_seq_kit			= nr_seq_item_w;
						end if;
					end if;					
					
					if	((ie_regra_disp_w = 'N') and (ie_gerar_necessidade_disp_w = 'S') and (coalesce(qt_dispensar_hor_w,0) = 0) and (ie_acm_sn_w = 'S')) then -- OS 1317985
							
							select 	dividir(qt_total_dispensar,nr_ocorrencia)								
							into STRICT	qt_dispensar_hor_w
							from 	prescr_material
							where	nr_prescricao = nr_prescricao_w
							and		nr_sequencia = nr_seq_item_w;
							
					end if;	
					
					if (qt_item_w = 0) then		
						select	nextval('prescr_mat_hor_seq')
						into STRICT	nr_seq_horario_w
						;
	
						insert into prescr_mat_hor(
							nr_sequencia,
							nr_seq_digito,
							nr_prescricao,
							nr_seq_material,
							ie_agrupador,
							dt_atualizacao,
							nm_usuario,
							dt_atualizacao_nrec,
							nm_usuario_nrec,
							cd_material,
							qt_dose,
							qt_dispensar_hor,
							ds_horario,
							dt_horario,
							cd_unidade_medida,
							cd_unidade_medida_dose,
							ie_urgente,
							dt_emissao_farmacia,
							dt_fim_horario,
							dt_suspensao,
							ie_horario_especial,
							qt_hor_reaprazamento,
							nm_usuario_reaprazamento,
							nr_seq_turno,
							dt_disp_farmacia,
							ie_aprazado,
							ie_classif_urgente,
							ie_padronizado,
							ie_controlado,
							cd_unid_med_hor,
							qt_horario,
							ie_gerar_lote,
							dt_lib_horario,
							qt_dispensar,
							nr_atendimento,
							ie_horario_adep,
							cd_motivo_baixa,
							cd_local_estoque_baixa,
							nr_agrupamento
							)
						values (
							nr_seq_horario_w,
							calcula_digito('MODULO11',nr_seq_horario_w),
							nr_prescricao_w,
							nr_seq_item_w,
							ie_agrupador_w,
							clock_timestamp(),
							nm_usuario_p,
							clock_timestamp(),
							nm_usuario_p,
							cd_item_p,
							qt_dose_w,
							qt_dispensar_hor_w,
							to_char(dt_horario_w,'hh24:mi'),
							dt_horario_w,
							cd_unidade_medida_w,
							cd_unidade_medida_dose_w,
							'N',
							dt_emissao_farmacia_w,
							null,
							null,
							'N',
							null,
							null,
							obter_turno_horario_prescr(cd_estab_prescr_w,cd_setor_atendimento_w,to_char(dt_horario_w,'hh24:mi'),cd_local_estoque_w),
							clock_timestamp(),
							'S',
							ie_classif_urgente_w,
							ie_padronizado_w,
							ie_controlado_w,
							coalesce(cd_unid_med_dose_hor_w, cd_unidade_medida_dose_w),
							qt_dose_w,
							coalesce(ie_gerar_lote_w,'S'),
							CASE WHEN ie_liberado_w='N' THEN  null  ELSE clock_timestamp() END ,
							qt_total_dispensar_w,
							nr_atendimento_p,
							ie_horario_adep_w,
							cd_motivo_baixa_w,
							cd_local_estoque_baixa_w,
							CASE WHEN coalesce(nr_agrupamento_w::text, '') = '' THEN  null  ELSE nr_agrupamento_w END
							);
							
						if (dt_proxima_dose_w IS NOT NULL AND dt_proxima_dose_w::text <> '') and (obter_ocorrencia_intervalo(cd_intervalo_p,24,'H') > 24) then
							dt_proxima_dose_w	:= dt_horario_w + (obter_ocorrencia_intervalo(cd_intervalo_p,24,'H') / 24);
							
							update	prescr_material
							set	dt_proxima_dose	= dt_proxima_dose_w
							where	nr_prescricao	= nr_prescricao_w
							and	nr_sequencia	= nr_seq_item_w;
							
							if (coalesce(wheb_usuario_pck.get_ie_commit, 'S') = 'S') then commit; end if;
						end if;
						
						select	coalesce(max('S'),'N')
						into STRICT	ie_item_susbtituido_w
						from	prescr_material
						where	nr_prescricao = nr_prescricao_w
						and		nr_seq_substituto = nr_seq_item_w;









						
						if (coalesce(nr_seq_classif_param_w ,0) > 0)	then
							begin
							update	prescr_mat_hor
							set	nr_seq_classif		= nr_seq_classif_param_w
							where	nr_prescricao		= nr_prescricao_w	
							and	nr_sequencia		= nr_seq_horario_w;
							end;
						else
							if (ie_grava_log_rastr_w = 'S') then
								CALL adep_gerar_log_rastr(substr('APRAZAR_ITEM_PRESCR C11 LINE 2475 PARAMETERS' || chr(10) ||
									'{'||chr(10)||
									'"cd_estabelecimento_w" : "'||cd_estabelecimento_w||'"}',1,1500));
							end if;
							open C11;
							loop
							fetch C11 into	
								nr_seq_classif_w,
								ie_classif_urgente_w,
								ie_controlado_w,
								ie_padronizado_w;
							EXIT WHEN NOT FOUND; /* apply on C11 */
								begin
								if (ie_controlado_w = 'A') and (ie_padronizado_w = 'A') then
									update	prescr_mat_hor
									set	nr_seq_classif		= nr_seq_classif_w
									where	nr_prescricao		= nr_prescricao_w	
									and	nr_sequencia		= nr_seq_horario_w
									--and	nr_seq_lote		is not null
									and	ie_classif_urgente	= ie_classif_urgente_w;
								elsif (ie_controlado_w = 'A') and (ie_padronizado_w = 'S') then
									update	prescr_mat_hor
									set	nr_seq_classif		= nr_seq_classif_w
									where	nr_prescricao		= nr_prescricao_w
									and	ie_padronizado		= 'S'
									and	nr_sequencia		= nr_seq_horario_w
									--and	nr_seq_lote		is not null
									and	ie_classif_urgente	= ie_classif_urgente_w;
								elsif (ie_controlado_w = 'A') and (ie_padronizado_w = 'N') then
									update	prescr_mat_hor
									set	nr_seq_classif		= nr_seq_classif_w
									where	nr_prescricao		= nr_prescricao_w
									and	ie_padronizado		= 'N'
									and	nr_sequencia		= nr_seq_horario_w
									--and	nr_seq_lote		is not null
									and	ie_classif_urgente	= ie_classif_urgente_w;
								elsif (ie_controlado_w = 'N') and (ie_padronizado_w = 'A') then
									update	prescr_mat_hor
									set	nr_seq_classif		= nr_seq_classif_w
									where	nr_prescricao		= nr_prescricao_w
									and	ie_controlado		= 'N'
									and	nr_sequencia		= nr_seq_horario_w
									--and	nr_seq_lote		is not null
									and	ie_classif_urgente	= ie_classif_urgente_w;
								elsif (ie_controlado_w = 'N') and (ie_padronizado_w = 'N') then
									update	prescr_mat_hor
									set	nr_seq_classif		= nr_seq_classif_w
									where	nr_prescricao		= nr_prescricao_w
									and	ie_controlado		= 'N'
									and	ie_padronizado		= 'N'
									and	nr_sequencia		= nr_seq_horario_w
									--and	nr_seq_lote		is not null
									and	ie_classif_urgente	= ie_classif_urgente_w;
								elsif (ie_controlado_w = 'N') and (ie_padronizado_w = 'S') then
									update	prescr_mat_hor
									set	nr_seq_classif		= nr_seq_classif_w
									where	nr_prescricao		= nr_prescricao_w
									and	ie_controlado		= 'N'
									and	ie_padronizado		= 'S'
									--and	nr_seq_lote		is not null
									and	nr_sequencia		= nr_seq_horario_w
									and	ie_classif_urgente	= ie_classif_urgente_w;
								elsif (ie_controlado_w = 'S') and (ie_padronizado_w = 'A') then
									update	prescr_mat_hor
									set	nr_seq_classif		= nr_seq_classif_w
									where	nr_prescricao		= nr_prescricao_w
									and	ie_controlado		= 'S'
									--and	nr_seq_lote		is not null
									and	nr_sequencia		= nr_seq_horario_w
									and	ie_classif_urgente	= ie_classif_urgente_w;
								elsif (ie_controlado_w = 'S') and (ie_padronizado_w = 'N') then
									update	prescr_mat_hor
									set	nr_seq_classif		= nr_seq_classif_w
									where	nr_prescricao		= nr_prescricao_w
									and	ie_controlado		= 'S'
									and	ie_padronizado		= 'N'
									--and	nr_seq_lote		is not null
									and	nr_sequencia		= nr_seq_horario_w
									and	ie_classif_urgente	= ie_classif_urgente_w;
								elsif (ie_controlado_w = 'S') and (ie_padronizado_w = 'S') then
									update	prescr_mat_hor
									set	nr_seq_classif		= nr_seq_classif_w
									where	nr_prescricao		= nr_prescricao_w
									and	ie_controlado		= 'S'
									and	ie_padronizado		= 'S'
									--and	nr_seq_lote		is not null
									and	nr_sequencia		= nr_seq_horario_w
									and	ie_classif_urgente	= ie_classif_urgente_w;
								end if;
							
								end;
							end loop;
							close C11;
						end if;
						
						if (ie_local_estoque_mat_hor_w	= 'S') then
							CALL define_disp_prescr_mat_hor(nr_seq_horario_w, nr_prescricao_w, nr_seq_item_w, cd_perfil_w, nm_usuario_p);
						
							select	coalesce(max(cd_local_estoque),cd_local_estoque_w)
							into STRICT	cd_local_estoque_w
							from	prescr_mat_hor
							where	nr_sequencia	= nr_seq_horario_w;
							
							update	prescr_mat_hor
							set	nr_seq_turno	= coalesce(Obter_turno_horario_prescr(cd_estabelecimento_w, cd_setor_atendimento_w, to_char(dt_horario_w,'hh24:mi'), cd_local_estoque_w),nr_seq_turno)
							where	nr_sequencia	= nr_seq_horario_w;
						end if;
						
						CALL Gerar_Gedi_Medic_atend(cd_estab_prescr_w, nr_prescricao_w, nr_seq_item_w, nr_seq_horario_w, nm_usuario_p);
						CALL aprazar_itens_dependentes(cd_estab_prescr_w, cd_setor_prescr_w, nr_atendimento_p, nr_prescricao_w, nr_seq_item_w, nr_agrupamento_w, dt_horario_w, ie_gerar_necessidade_disp_w, nm_usuario_p, null, nr_seq_hor_glic_w, null, ie_horario_adep_w, '');
						CALL adep_gerar_area_prep(nr_prescricao_w, null, nm_usuario_p);
						
						if (ie_gerar_proc_gedipa_job_w	= 'N') and (ie_liberado_w	= 'S') then
							CALL Gedipa_Gerar_Proc_Instantaneo(nr_prescricao_w,nr_seq_item_w,null,nr_seq_horario_w);
						end if;

						if	((ie_gerar_necessidade_disp_w = 'S') or (ie_regra_disp_w <> 'N')) and (coalesce(nr_seq_objeto_p,0) <> 3558) then

							if	((ie_acm_w = 'S') or (ie_sn_w = 'S' )) then
								if (ie_imprimir_acm_sn_w = 'S') then
									update	prescr_medica
									set	dt_emissao_farmacia	 = NULL,
										nm_usuario_imp_far	 = NULL
									where	nr_prescricao		= nr_prescricao_w;
								end if;
							else	
								update	prescr_medica
								set	dt_emissao_farmacia	 = NULL,
									nm_usuario_imp_far	 = NULL
								where	nr_prescricao		= nr_prescricao_w;
							end if;
								
							update	prescr_material
							set	cd_motivo_baixa	= 0,
								dt_baixa	 = NULL
							where	nr_prescricao	= nr_prescricao_w
							and	nr_sequencia	= nr_seq_item_w;

							update	prescr_material
							set		cd_motivo_baixa	= 0,
									dt_baixa	 = NULL
							where	nr_prescricao	= nr_prescricao_w
							and		nr_sequencia	<> nr_seq_item_w
							and		nr_agrupamento	= nr_agrupamento_w;
							
							
						else
						
							ie_gerar_lote_w			:= 'N';
							dt_emissao_farmacia_w	:= clock_timestamp();
							qt_dispensar_hor_w		:= 0;
							
							update	prescr_material
							set		cd_motivo_baixa	= cd_motivo_baixa_w,
									dt_baixa		= dt_emissao_farmacia_w
							where	coalesce(cd_motivo_baixa,0) = 0
							and		nr_prescricao	= nr_prescricao_w
							and		nr_sequencia	= nr_seq_item_w;

							update	prescr_material
							set		cd_motivo_baixa	= cd_motivo_baixa_w,
									dt_baixa	= dt_emissao_farmacia_w
							where	coalesce(cd_motivo_baixa,0) = 0
							and		nr_prescricao	= nr_prescricao_w
							and		nr_sequencia	<> nr_seq_item_w
							and		nr_agrupamento	= nr_agrupamento_w;
							
							update	prescr_mat_hor a
							set		a.cd_motivo_baixa	= cd_motivo_baixa_w,
									a.dt_emissao_farmacia = dt_emissao_farmacia_w,
									a.ie_gerar_lote = ie_gerar_lote_w,
									a.qt_dispensar_hor = 0
							where	coalesce(a.cd_motivo_baixa,0) = 0
							and		coalesce(a.ie_horario_especial,'N') = 'N'
							and		coalesce(a.ie_aprazado,'S') = 'S'
							and		a.nr_prescricao	= nr_prescricao_w
							and		a.nr_seq_material	= nr_seq_item_w;

							update	prescr_mat_hor a
							set		a.cd_motivo_baixa	= cd_motivo_baixa_w,
									a.dt_emissao_farmacia = dt_emissao_farmacia_w,
									a.ie_gerar_lote = ie_gerar_lote_w,
									a.qt_dispensar_hor = 0
							where	a.nr_prescricao	= nr_prescricao_w
							and		a.nr_seq_material	<> nr_seq_item_w
							and		coalesce(a.cd_motivo_baixa,0) = 0
							and		coalesce(a.ie_horario_especial,'N') = 'N'
							and		coalesce(a.ie_aprazado,'S') = 'S'
							and		exists (	SELECT	1
											from	prescr_material b
											where	b.nr_prescricao = a.nr_prescricao
											and		b.nr_sequencia = a.nr_seq_material
											and		b.nr_agrupamento = nr_agrupamento_w);
						end if;
						
						
						if (ie_gerar_nec_disp_kit_w = 'S') then
							update	prescr_material
							set		cd_motivo_baixa	= 0,
									dt_baixa	 = NULL
							where	nr_prescricao		= nr_prescricao_w
							and		nr_sequencia_diluicao	= nr_seq_item_w;
							
							update	prescr_material
							set		cd_motivo_baixa	= 0,
									dt_baixa	 = NULL
							where	nr_prescricao	= nr_prescricao_w
							and		nr_seq_kit	= nr_seq_item_w;
						else
							update	prescr_material
							set		cd_motivo_baixa	= cd_motivo_baixa_w,
									dt_baixa	= dt_emissao_farmacia_w
							where	coalesce(cd_motivo_baixa,0) = 0
							and		nr_prescricao		= nr_prescricao_w
							and		nr_sequencia_diluicao	= nr_seq_item_w;
							
							update	prescr_material
							set		cd_motivo_baixa	= cd_motivo_baixa_w,
									dt_baixa	= dt_emissao_farmacia_w
							where	coalesce(cd_motivo_baixa,0) = 0
							and		nr_prescricao	= nr_prescricao_w
							and		nr_seq_kit	= nr_seq_item_w;
							
							update	prescr_mat_hor a
							set		a.cd_motivo_baixa	= cd_motivo_baixa_w,
									a.dt_emissao_farmacia	= dt_emissao_farmacia_w,
									a.ie_gerar_lote = ie_gerar_lote_w,
									a.qt_dispensar_hor = 0
							where	a.nr_prescricao		= nr_prescricao_w
							and		coalesce(a.cd_motivo_baixa,0) = 0
							and		coalesce(a.ie_horario_especial,'N') = 'N'
							and		coalesce(a.ie_aprazado,'S') = 'S'
							and		exists (	SELECT	1
											from	prescr_material b
											where	b.nr_prescricao = a.nr_prescricao
											and		b.nr_sequencia = a.nr_seq_material
											and		b.nr_sequencia_diluicao = nr_seq_item_w);
							
							update	prescr_mat_hor a
							set		a.cd_motivo_baixa	= cd_motivo_baixa_w,
									a.dt_emissao_farmacia	= dt_emissao_farmacia_w,
									a.ie_gerar_lote = ie_gerar_lote_w,
									a.qt_dispensar_hor = 0
							where	a.nr_prescricao	= nr_prescricao_w
							and		coalesce(a.cd_motivo_baixa,0) = 0
							and		coalesce(a.ie_horario_especial,'N') = 'N'
							and		coalesce(a.ie_aprazado,'S') = 'S'
							and		exists (	SELECT	1
											from	prescr_material b
											where	b.nr_prescricao = a.nr_prescricao
											and		b.nr_sequencia = a.nr_seq_material
											and		b.nr_seq_kit	= nr_seq_item_w);
						end if;
						
						/* gerar evento aprazamento */

						if (nr_prescr_atual_w <> nr_prescricao_w) and (coalesce(nr_seq_horario_w,0) > 0) and (coalesce(ie_gerar_evento_p,'S') <> 'N') then
							
							ie_gera_lote_param_w	:= 'S';
							if (ie_gerar_lote_ww = 'R') and (ie_acm_sn_p	= 'S') and
								((dt_horario_w + qt_hora_intervalo_w/24) > dt_validade_prescr_w) then
								ie_gera_lote_param_w	:= 'N';
							elsif (ie_gerar_lote_ww = 'T') and (ie_acm_sn_p	= 'N') then
								ie_gera_lote_param_w	:= 'N';
							end if;

							CALL adep_gerar_area_prep(nr_prescricao_w, null, nm_usuario_p);
							
							-- Caso nao deva dispensar, nao gerar lote (Parametro [70] do ADEP e regra de dispensacao do item)
							if	--(ie_gerar_lote_w = 'S') and
								(ie_gera_lote_param_w = 'S') and
								((ie_gerar_lote_ww not in ('N','A')) or (PKG_DATE_UTILS.start_of(dt_horario_w,'mi',0) >= PKG_DATE_UTILS.start_of(clock_timestamp(),'mi',0))) then
								CALL define_local_disp_prescr(nr_prescricao_w, nr_seq_item_w, cd_perfil_w, nm_usuario_p);
								CALL Gerar_Lote_Atend_Prescricao(nr_prescricao_w, nr_seq_item_w, nr_seq_horario_w, 'S', nm_usuario_p, 'AIP');
							end if;

							/*if	(ie_gera_integracao_w = 'S') then
								disp_prescr_mat_hor(nr_prescricao_w,nr_seq_horario_w,nm_usuario_p);
							end if;*/
							CALL gerar_evento_reaprazamento(nr_atendimento_p, nr_prescricao_w, nr_seq_item_w, nr_seq_horario_w, cd_item_p, ie_tipo_item_p, ie_alteracao_w, nr_seq_motivo_p, ds_justificativa_p, nm_usuario_p, nr_seq_proc_interno_p,ie_acm_sn_w,nr_seq_assinatura_p);
							
							-- Pode haver conflito entre o parametro [70] e [606] do ADEP
							if (ie_gerar_lote_w = 'S') then
								CALL gerar_acm_sn_apraz_prescricao(nr_prescricao_w, nr_seq_item_w,cd_local_estoque_w,nm_usuario_p);
							end if;

						end if;
					end if;
					/* atualizar prescricao */

					nr_prescr_atual_w := nr_prescricao_w;	
					end;
				else
					ie_inconsistencia_w := 'H';
					if (coalesce(ds_inconsistentes_w::text, '') = '') then
						ds_inconsistentes_w := to_char(nr_prescricao_w);
					elsif (position(nr_prescricao_w in ds_inconsistentes_w) = 0) then
						ds_inconsistentes_w := ds_inconsistentes_w || ', ' || to_char(nr_prescricao_w);
					end if;					
					
				end if;
			elsif (ie_aprazar_interv_p = 'S') then
				CALL aprazar_item_prescr_interv(ie_tipo_item_p, nr_prescricao_w, nr_seq_item_w, dt_horario_p, nr_seq_motivo_p, ds_justificativa_p, nm_usuario_p, nr_seq_assinatura_p);
			end if;
			end;
		end loop;
		close C03;

		if (ie_grava_log_rastr_w = 'S') then
			CALL adep_gerar_log_rastr(substr('APRAZAR_ITEM_PRESCR C13 PARAMETERS' || chr(10) ||
				'{'||chr(10)||
				'"cd_setor_pac_w" : "'||cd_setor_pac_w||'",'||chr(10)||
				'"dt_horario_w" : "'||to_char(dt_horario_w, 'dd/mm/yyyy hh24:mi:ss')||'",'||chr(10)||
				'"dt_validade_w" : "'||to_char(dt_validade_w, 'dd/mm/yyyy hh24:mi:ss')||'",'||chr(10)||
				'"ie_data_lib_prescr_w" : "'||ie_data_lib_prescr_w||'",'||chr(10)||
				'"ie_tipo_item_p" : "'||ie_tipo_item_p||'",'||chr(10)||
				'"nr_atendimento_p" : "'||nr_atendimento_p||'",'||chr(10)||
				'"nr_seq_item_p" : "'||nr_seq_item_p||'"}',1,1500));
		end if;

		open C13;
		loop
		fetch C13 into	
			nr_prescricao_w,
			nr_seq_item_w,
			cd_estab_prescr_w;
		EXIT WHEN NOT FOUND; /* apply on C13 */
			ie_cursor_w := 'S';
			CALL Gerar_nut_paciente_hor(nr_prescricao_w, nr_atendimento_p, nr_seq_item_w, dt_horario_p, 'S', cd_estab_prescr_w, cd_perfil_w, nm_usuario_p);
			
			select	count(*) + 1
			into STRICT	nr_etapa_w
			from	nut_paciente_hor
			where	nr_seq_nut_pac	= nr_seq_item_w
			and		coalesce(ie_horario_especial,'N')	= 'N';
			
			select	nextval('prescr_solucao_evento_seq')
			into STRICT	nr_sequencia_w
			;

			/* gerar evento */

			insert into prescr_solucao_evento(
				nr_sequencia,
				dt_atualizacao,
				nm_usuario,
				dt_atualizacao_nrec,
				nm_usuario_nrec,
				nr_prescricao,
				nr_seq_solucao,
				nr_seq_material,
				nr_seq_procedimento,
				nr_seq_nut,
				nr_seq_nut_neo,
				ie_forma_infusao,
				ie_tipo_dosagem,
				qt_dosagem,
				qt_vol_infundido,
				qt_vol_desprezado,
				cd_pessoa_fisica,
				ie_alteracao,
				dt_alteracao,
				ie_evento_valido,
				nr_seq_motivo,
				ds_observacao,
				ie_tipo_solucao,
				nr_seq_lote,
				nr_seq_assinatura,
				ds_justificativa,
				dt_horario,
				nr_etapa_evento)
			values (
				nr_sequencia_w,
				clock_timestamp(),
				nm_usuario_p,
				clock_timestamp(),
				nm_usuario_p,
				nr_prescricao_w,
				null,
				null,
				null,
				nr_seq_item_w,
				null,
				null,
				null,
				null,
				null,
				null,
				obter_dados_usuario_opcao(nm_usuario_p, 'C'),
				16,
				clock_timestamp(),
				'S',
				null,
				null,
				4,
				null,
				nr_seq_assinatura_p,
				ds_justificativa_p,
				dt_horario_p,
				nr_etapa_w);

		if	((wheb_assist_pck.get_cd_certificado IS NOT NULL AND wheb_assist_pck.get_cd_certificado::text <> '') OR (ie_gera_sem_certificado_w = 'S')) AND (coalesce(obter_data_assinatura_digital(nr_seq_assinatura_p)::text, '') = '') then
		
     		select	max(cd_pessoa_fisica)
			into STRICT	cd_pessoa_fisica_w
			from	atendimento_paciente
			where	nr_atendimento = nr_atendimento_p;
		
			CALL Gerar_registro_pendente_PEP('ADEP',nr_prescricao_w, cd_pessoa_fisica_w, nr_atendimento_p,nm_usuario_p, 'A', nr_seq_horario_p, ie_tipo_item_p,null,null,null,null,null,null,null,null,null,null,null,null,null,null,nr_sequencia_w);
		
		end if;	
			
		end loop;
		close C13;

		if (ie_grava_log_rastr_w = 'S') then
			CALL adep_gerar_log_rastr(substr('APRAZAR_ITEM_PRESCR C14 PARAMETERS' || chr(10) ||
				'{'||chr(10)||
				'"cd_setor_pac_w" : "'||cd_setor_pac_w||'",'||chr(10)||
				'"dt_horario_w" : "'||to_char(dt_horario_w, 'dd/mm/yyyy hh24:mi:ss')||'",'||chr(10)||
				'"dt_validade_w" : "'||to_char(dt_validade_w, 'dd/mm/yyyy hh24:mi:ss')||'",'||chr(10)||
				'"ie_aprazar_fase_npt_w" : "'||ie_aprazar_fase_npt_w||'",'||chr(10)||
				'"ie_data_lib_prescr_w" : "'||ie_data_lib_prescr_w||'",'||chr(10)||
				'"ie_tipo_item_p" : "'||ie_tipo_item_p||'",'||chr(10)||
				'"nr_atendimento_p" : "'||nr_atendimento_p||'",'||chr(10)||
				'"nr_seq_item_p" : "'||nr_seq_item_p||'"}',1,1500));
		end if;

		open C14;
		loop
		fetch C14 into	
			nr_prescricao_w,
			nr_seq_item_w,
			cd_estab_prescr_w,
			qt_fase_npt_w,
			qt_tempo_etapa_w,
			qt_hora_inf_w;
		EXIT WHEN NOT FOUND; /* apply on C14 */
			ie_cursor_w := 'S';
			
			dt_horario_npt_w	:= dt_horario_p;
			
			update	prescr_material
			set		cd_motivo_baixa = 0,
					dt_baixa  = NULL
			where	nr_prescricao = nr_prescricao_w
			and		ie_agrupador = 11;
			if (coalesce(wheb_usuario_pck.get_ie_commit, 'S') = 'S') then commit; end if;
						
			if (coalesce(ie_aprazar_fase_npt_w,'N') = 'N') then
			
				CALL Gerar_nut_paciente_hor_prot(nr_prescricao_w, nr_atendimento_p, nr_seq_item_w, dt_horario_npt_w, 'S', cd_estab_prescr_w, cd_perfil_w, nm_usuario_p);
				
				select	count(*)
				into STRICT		nr_etapa_w
				from		nut_paciente_hor
				where	nr_seq_nut_protocolo	= nr_seq_item_w	
				and		coalesce(ie_horario_especial,'N')	= 'N';
							
				select	max(nr_seq_lote)
				into STRICT		nr_seq_lote_w
				from		prescr_mat_hor
				where	nr_prescricao = nr_prescricao_w
				and		dt_horario = dt_horario_npt_w
				and		ie_agrupador = 11;
				
				select	nextval('prescr_solucao_evento_seq')
				into STRICT	nr_sequencia_w
				;

				/* gerar evento */

				insert into prescr_solucao_evento(
					nr_sequencia,
					dt_atualizacao,
					nm_usuario,
					dt_atualizacao_nrec,
					nm_usuario_nrec,
					nr_prescricao,
					nr_seq_solucao,
					nr_seq_material,
					nr_seq_procedimento,
					nr_seq_nut,
					nr_seq_nut_neo,
					ie_forma_infusao,
					ie_tipo_dosagem,
					qt_dosagem,
					qt_vol_infundido,
					qt_vol_desprezado,
					cd_pessoa_fisica,
					ie_alteracao,
					dt_alteracao,
					ie_evento_valido,
					nr_seq_motivo,
					ds_observacao,
					ie_tipo_solucao,
					nr_seq_lote,
					nr_seq_assinatura,
					ds_justificativa,
					dt_horario,
					nr_etapa_evento)
				values (
					nr_sequencia_w,
					clock_timestamp(),
					nm_usuario_p,
					clock_timestamp(),
					nm_usuario_p,
					nr_prescricao_w,
					null,
					null,
					null,
					null,
					nr_seq_item_w,
					null,
					null,
					null,
					null,
					null,
					obter_dados_usuario_opcao(nm_usuario_p, 'C'),
					16,
					clock_timestamp(),
					'S',
					null,
					null,
					6,
					nr_seq_lote_w,
					nr_seq_assinatura_p,
					ds_justificativa_p,
					dt_horario_npt_w,
					nr_etapa_w);
		
			    if	((wheb_assist_pck.get_cd_certificado IS NOT NULL AND wheb_assist_pck.get_cd_certificado::text <> '') OR (ie_gera_sem_certificado_w = 'S')) AND (coalesce(obter_data_assinatura_digital(nr_seq_assinatura_p)::text, '') = '') then
		
     	     	    select	max(cd_pessoa_fisica)
					into STRICT	cd_pessoa_fisica_w
					from	atendimento_paciente
					where	nr_atendimento = nr_atendimento_p;
		
					CALL Gerar_registro_pendente_PEP('ADEP',nr_prescricao_w, cd_pessoa_fisica_w, nr_atendimento_p,nm_usuario_p, 'A', nr_seq_horario_p, ie_tipo_item_p,null,null,null,null,null,null,null,null,null,null,null,null,null,null,nr_sequencia_w);
		
				end if;	 		
				
			else
			
				if (coalesce(qt_tempo_etapa_w,0) = 0) then
					qt_tempo_etapa_w := qt_hora_inf_w / qt_fase_npt_w;
				end if;

				for i in 1..qt_fase_npt_w  loop
					begin
					
					CALL Gerar_nut_paciente_hor_prot(nr_prescricao_w, nr_atendimento_p, nr_seq_item_w, dt_horario_npt_w, 'S', cd_estab_prescr_w, cd_perfil_w, nm_usuario_p);
					
					select	count(*)
					into STRICT		nr_etapa_w
					from		nut_paciente_hor
					where	nr_seq_nut_protocolo	= nr_seq_item_w	
					and		coalesce(ie_horario_especial,'N')	= 'N';
								
					select	max(nr_seq_lote)
					into STRICT		nr_seq_lote_w
					from		prescr_mat_hor
					where	nr_prescricao = nr_prescricao_w
					and		dt_horario 	 = dt_horario_npt_w
					and		ie_agrupador = 11;
					
					select	nextval('prescr_solucao_evento_seq')
					into STRICT	nr_sequencia_w
					;

					/* gerar evento */

					insert into prescr_solucao_evento(
						nr_sequencia,
						dt_atualizacao,
						nm_usuario,
						dt_atualizacao_nrec,
						nm_usuario_nrec,
						nr_prescricao,
						nr_seq_solucao,
						nr_seq_material,
						nr_seq_procedimento,
						nr_seq_nut,
						nr_seq_nut_neo,
						ie_forma_infusao,
						ie_tipo_dosagem,
						qt_dosagem,
						qt_vol_infundido,
						qt_vol_desprezado,
						cd_pessoa_fisica,
						ie_alteracao,
						dt_alteracao,
						ie_evento_valido,
						nr_seq_motivo,
						ds_observacao,
						ie_tipo_solucao,
						nr_seq_lote,
						nr_seq_assinatura,
						ds_justificativa,
						dt_horario,
						nr_etapa_evento)
					values (
						nr_sequencia_w,
						clock_timestamp(),
						nm_usuario_p,
						clock_timestamp(),
						nm_usuario_p,
						nr_prescricao_w,
						null,
						null,
						null,
						null,
						nr_seq_item_w,
						null,
						null,
						null,
						null,
						null,
						obter_dados_usuario_opcao(nm_usuario_p, 'C'),
						16,
						clock_timestamp(),
						'S',
						null,
						null,
						6,
						nr_seq_lote_w,
						nr_seq_assinatura_p,
						ds_justificativa_p,
						dt_horario_npt_w,
						nr_etapa_w);
					
				        if	((wheb_assist_pck.get_cd_certificado IS NOT NULL AND wheb_assist_pck.get_cd_certificado::text <> '') OR (ie_gera_sem_certificado_w = 'S')) AND (coalesce(obter_data_assinatura_digital(nr_seq_assinatura_p)::text, '') = '') then
		
     	     	            select	max(cd_pessoa_fisica)
							into STRICT	cd_pessoa_fisica_w
							from	atendimento_paciente
							where	nr_atendimento = nr_atendimento_p;
		
							CALL Gerar_registro_pendente_PEP('ADEP',nr_prescricao_w, cd_pessoa_fisica_w, nr_atendimento_p,nm_usuario_p, 'A', nr_seq_horario_p, ie_tipo_item_p,null,null,null,null,null,null,null,null,null,null,null,null,null,null,nr_sequencia_w);
		
						end if;	
						
						dt_horario_npt_w :=  dt_horario_npt_w + (qt_tempo_etapa_w/24);
						
					end;
				end loop;
			end if;	
		end loop;
		close C14;		
		
		if (ie_grava_log_rastr_w = 'S') then
			CALL adep_gerar_log_rastr(substr('APRAZAR_ITEM_PRESCR C04 PARAMETERS' || chr(10) ||
				'{'||chr(10)||
				'"cd_intervalo_p" : "'||cd_intervalo_p||'",'||chr(10)||
				'"cd_item_p" : "'||cd_item_p||'",'||chr(10)||
				'"cd_setor_pac_w" : "'||cd_setor_pac_w||'",'||chr(10)||
				'"dt_horario_w" : "'||to_char(dt_horario_w, 'dd/mm/yyyy hh24:mi:ss')||'",'||chr(10)||
				'"dt_validade_w" : "'||to_char(dt_validade_w, 'dd/mm/yyyy hh24:mi:ss')||'",'||chr(10)||
				'"ie_aprazar_suspensos_w" : "'||ie_aprazar_suspensos_w||'",'||chr(10)||
				'"ie_data_lib_prescr_w" : "'||ie_data_lib_prescr_w||'",'||chr(10)||
				'"ie_tipo_item_p" : "'||ie_tipo_item_p||'",'||chr(10)||
				'"nr_atendimento_p" : "'||nr_atendimento_p||'",'||chr(10)||
				'"qt_item_p" : "'||qt_item_p||'"}',1,1500));
		end if;
		
		open C04;
		loop
		fetch C04 into	
			nr_prescricao_w,
			nr_seq_item_w,
			cd_local_estoque_w,
			nr_agrupamento_w,
			cd_material_w,		
			cd_unidade_medida_w,		
			ie_sn_w,
			ie_acm_w;
		EXIT WHEN NOT FOUND; /* apply on C04 */
			begin
			ie_cursor_w := 'S';
			
			select	max(dt_liberacao),
				max(cd_estabelecimento)
			into STRICT	dt_liberacao_w,
				cd_estabelecimento_w
			from	prescr_medica
			where	nr_prescricao = nr_prescricao_w;

			select	coalesce(max(qt_min_agora),0),
				coalesce(max(qt_min_especial),0),
				max(ie_classif_urgencia),
				coalesce(max(ie_forma_agora), 'N'),
				coalesce(max(ie_gera_disp_acm_sn),'S')
			into STRICT	qt_min_agora_w,
				qt_min_especial_w,
				ie_classif_nao_padrao_w,
				ie_agora_impressao_w,
				ie_gera_disp_acm_sn_w
			from	parametros_farmacia
			where	cd_estabelecimento = cd_estabelecimento_w;
			
			dt_limite_agora_w	:= dt_liberacao_w + qt_min_agora_w/1440;
			dt_limite_especial_w	:= dt_liberacao_w + qt_min_especial_w/1440;
			
			if (coalesce(ie_gerar_classif_agora_w,'N') = 'S') then
				dt_hora_atual_w := clock_timestamp();
				dt_limite_agora_w	:=  dt_hora_atual_w + qt_min_agora_w/1440; 			
			end if;
			
			if (ie_sn_w = 'S') or (ie_acm_w = 'S') then			
				ie_acm_sn_w := 'S';
			else
				ie_acm_sn_w := 'N';
			end if;	
			
			if (ie_aprazar_interv_p = 'N') then
				begin
				ie_aprazar_w := 'S';
				if (ie_aprazar_w = 'S') then
					begin
					select	cd_estabelecimento,
						cd_setor_atendimento,
						dt_inicio_prescr
					into STRICT	cd_estab_prescr_w,
						cd_setor_prescr_w,
						dt_inicio_prescr_w
					from	prescr_medica
					where	nr_prescricao = nr_prescricao_w;
					
					ie_agrupador_w	:= 2;
					
					select	coalesce(min(nr_sequencia),0)
					into STRICT	nr_seq_orig_w
					from	prescr_mat_hor
					where	nr_prescricao = nr_prescricao_w
					and	nr_seq_material = nr_seq_item_w
					and	coalesce(ie_situacao,'A') = 'A'
					and	Obter_se_horario_liberado(dt_lib_horario, dt_horario) = 'S';
										
					if (nr_seq_orig_w > 0) then
						select	qt_dose,
							qt_dispensar,
							qt_dispensar_hor,
							cd_unidade_medida,
							cd_unidade_medida_dose
						into STRICT	qt_dose_w,
							qt_dispensar_w,
							qt_dispensar_hor_w,
							cd_unidade_medida_w,
							cd_unidade_medida_dose_w
						from	prescr_mat_hor
						where	nr_sequencia = nr_seq_orig_w;
					else		
						cd_unid_med_dose_hor_w := null;
						qt_dose_hor_w	:= null;	
														
						SELECT * FROM obter_dose_um_horario_pmh(cd_material_w, qt_item_p, cd_unidade_medida_dose_w, qt_dose_hor_w, cd_unid_med_dose_hor_w) INTO STRICT qt_dose_hor_w, cd_unid_med_dose_hor_w;							
					end if;
									
					select	coalesce(max(substr(Obter_se_medic_controlado(cd_item_p),1,1)),'N'),
						coalesce(max(substr(obter_se_material_padronizado(cd_estabelecimento_w, cd_item_p),1,1)),'N')
					into STRICT	ie_controlado_w,
						ie_padronizado_w
					;
					
					/*	Fabio e JonasJonas - 19/01/2010 = Para gerar os lotes como AGORA dependendo do horario final do turno, e nao mais pelo minutos de agora*/

					if (ie_agora_impressao_w = 'S') then
						nr_seq_turno_hor_ag_w	:= obter_turno_horario_prescr(cd_estabelecimento_w,cd_setor_prescr_w,to_char(dt_horario_w,'hh24:mi'), cd_local_estoque_w);
						select	max(to_char(b.hr_inicial,'hh24:mi')),
							max(to_char(b.hr_final,'hh24:mi'))
						into STRICT	hr_turno_agora_w,
							hr_final_turno_agora_w
						from	regra_turno_disp_param b,
							regra_turno_disp a
						where	a.nr_sequencia		= b.nr_seq_turno
						and	a.cd_estabelecimento	= cd_estabelecimento_w
						and	a.nr_sequencia		= nr_seq_turno_hor_ag_w
						and (coalesce(b.cd_setor_atendimento,coalesce(cd_setor_prescr_w,0))	= coalesce(cd_setor_prescr_w,0));

						select	coalesce(max(qt_min_antes_atend), 0),
							coalesce(max(ie_define_agora), 'N')
						into STRICT	qt_min_antes_atend_w,
							ie_define_agora_w
						from	regra_tempo_disp
						where	cd_estabelecimento	= cd_estabelecimento_w
						and (coalesce(cd_setor_atendimento,coalesce(cd_setor_prescr_w,0)) = coalesce(cd_setor_prescr_w,0))
						and	nr_seq_turno = nr_seq_turno_hor_ag_w
						and	ie_situacao = 'A';

						if (hr_turno_agora_w > hr_final_turno_agora_w) then
							if (ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_horario_w) > ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_inicio_prescr_w)) then
								dt_limite_agora_w := PKG_DATE_UTILS.get_Time(dt_horario_w - 1, hr_turno_agora_w) - (qt_min_antes_atend_w/1440);
							else
								dt_limite_agora_w := PKG_DATE_UTILS.get_Time(dt_horario_w, hr_turno_agora_w) - (qt_min_antes_atend_w/1440);
							end if;
						else
							dt_limite_agora_w := PKG_DATE_UTILS.get_Time(dt_horario_w, hr_turno_agora_w) - (qt_min_antes_atend_w/1440);
						end if;
					end if;
					/*	Fabio e Jonas - 19/01/2010 = Final da alteracao*/

					
					if (coalesce(ie_classif_nao_padrao_w::text, '') = '') or (ie_padronizado_w = 'S') then
						begin
						ie_classif_urgente_w	:= 'N';
						if (dt_horario_w <= dt_limite_agora_w) then
							ie_classif_urgente_w	:= 'A';
						elsif	((dt_limite_agora_w <= clock_timestamp()) and (ie_agora_impressao_w = 'S') and (ie_define_agora_w = 'N')) then
							ie_classif_urgente_w	:= 'A';
						elsif (ie_agora_impressao_w = 'S' and ie_define_agora_w = 'S') and
							(dt_horario_w <= (clock_timestamp() + (qt_min_antes_atend_w /1440))) then
							ie_classif_urgente_w	:= 'A';
						elsif (dt_horario_w <= dt_limite_especial_w) then
							ie_classif_urgente_w	:= 'E';
						end if;
						end;
					else
						ie_classif_urgente_w	:= ie_classif_nao_padrao_w;
					end if;
									
					ie_liberado_w := 'N';
					
					select	coalesce(max('S'),'N')
					into STRICT	ie_liberado_w
					from	prescr_mat_hor	
					where	nr_prescricao = nr_prescricao_w
					and	(dt_lib_horario IS NOT NULL AND dt_lib_horario::text <> '');
					
					select	nextval('prescr_mat_hor_seq')
					into STRICT	nr_seq_horario_w
					;
					
					if (ie_gera_disp_acm_sn_w = 'N' AND ie_acm_sn_w = 'S') then
						ie_gerar_lote_w := 'S';
						update	prescr_material
						set		ie_gerar_lote 	= 'S'
						where	nr_prescricao	= nr_prescricao_w
 						and	nr_sequencia	= nr_seq_item_w;
					end if;	

					insert into prescr_mat_hor(
						nr_sequencia,
						nr_seq_digito,
						nr_prescricao,
						nr_seq_material,
						ie_agrupador,
						dt_atualizacao,
						nm_usuario,
						dt_atualizacao_nrec,
						nm_usuario_nrec,
						cd_material,
						qt_dose,
						qt_dispensar_hor,
						ds_horario,
						dt_horario,
						cd_unidade_medida,
						cd_unidade_medida_dose,
						ie_urgente,
						dt_emissao_farmacia,
						dt_fim_horario,
						dt_suspensao,
						ie_horario_especial,
						qt_hor_reaprazamento,
						nm_usuario_reaprazamento,
						nr_seq_turno,
						dt_disp_farmacia,
						ie_aprazado,
						ie_classif_urgente,
						ie_padronizado,
						ie_controlado,
						cd_unid_med_hor,
						qt_horario,
						ie_gerar_lote,
						dt_lib_horario,
						nr_atendimento
						)
					values (
						nr_seq_horario_w,
						calcula_digito('MODULO11',nr_seq_horario_w),
						nr_prescricao_w,
						nr_seq_item_w,
						--decode(ie_tipo_item_p,'M',1,12),
						ie_agrupador_w,
						clock_timestamp(),
						nm_usuario_p,
						clock_timestamp(),
						nm_usuario_p,
						cd_item_p,
						qt_dose_w,
						qt_dispensar_hor_w,
						to_char(dt_horario_w,'hh24:mi'),
						dt_horario_w,
						cd_unidade_medida_w,
						cd_unidade_medida_dose_w,
						'N',
						CASE WHEN ie_gerar_necessidade_disp_w='S' THEN null  ELSE clock_timestamp() END ,
						null,
						null,
						'N',
						null,
						null,
						obter_turno_horario_prescr(cd_estab_prescr_w,cd_setor_prescr_w,to_char(dt_horario_w,'hh24:mi'),cd_local_estoque_w),
						clock_timestamp(),
						'S',
						ie_classif_urgente_w,
						ie_padronizado_w,
						ie_controlado_w,
						coalesce(cd_unid_med_dose_hor_w, cd_unidade_medida_dose_w),
						qt_dose_w,
						coalesce(ie_gerar_lote_w,'S'),
						CASE WHEN ie_liberado_w='N' THEN  null  ELSE clock_timestamp() END ,
						nr_atendimento_p);						
						
						CALL adep_gerar_area_prep(nr_prescricao_w, null, nm_usuario_p);
						if (ie_gerar_proc_gedipa_job_w	= 'N') and (ie_liberado_w	= 'S') then
							CALL Gedipa_Gerar_Proc_Instantaneo(nr_prescricao_w,nr_seq_item_w,null,nr_seq_horario_w);
						end if;						
						
						if (coalesce(nr_seq_classif_param_w ,0) > 0)	then
							begin
							update	prescr_mat_hor
							set	nr_seq_classif		= nr_seq_classif_param_w
							where	nr_prescricao		= nr_prescricao_w	
							and	nr_sequencia		= nr_seq_horario_w;
							end;
						else
							if (ie_grava_log_rastr_w = 'S') then
								CALL adep_gerar_log_rastr(substr('APRAZAR_ITEM_PRESCR C11 LINE 3423 PARAMETERS' || chr(10) ||
									'{'||chr(10)||
									'"cd_estabelecimento_w" : "'||cd_estabelecimento_w||'"}',1,1500));
							end if;
							open C11;
							loop
							fetch C11 into	
								nr_seq_classif_w,
								ie_classif_urgente_w,
								ie_controlado_w,
								ie_padronizado_w;
							EXIT WHEN NOT FOUND; /* apply on C11 */
								begin
								if (ie_controlado_w = 'A') and (ie_padronizado_w = 'A') then
									update	prescr_mat_hor
									set	nr_seq_classif		= nr_seq_classif_w
									where	nr_prescricao		= nr_prescricao_w	
									and	nr_sequencia		= nr_seq_horario_w
									--and	nr_seq_lote		is not null
									and	ie_classif_urgente	= ie_classif_urgente_w;
								elsif (ie_controlado_w = 'A') and (ie_padronizado_w = 'S') then
									update	prescr_mat_hor
									set	nr_seq_classif		= nr_seq_classif_w
									where	nr_prescricao		= nr_prescricao_w
									and	ie_padronizado		= 'S'
									and	nr_sequencia		= nr_seq_horario_w
									--and	nr_seq_lote		is not null
									and	ie_classif_urgente	= ie_classif_urgente_w;
								elsif (ie_controlado_w = 'A') and (ie_padronizado_w = 'N') then
									update	prescr_mat_hor
									set	nr_seq_classif		= nr_seq_classif_w
									where	nr_prescricao		= nr_prescricao_w
									and	ie_padronizado		= 'N'
									and	nr_sequencia		= nr_seq_horario_w
									--and	nr_seq_lote		is not null
									and	ie_classif_urgente	= ie_classif_urgente_w;
								elsif (ie_controlado_w = 'N') and (ie_padronizado_w = 'A') then
									update	prescr_mat_hor
									set	nr_seq_classif		= nr_seq_classif_w
									where	nr_prescricao		= nr_prescricao_w
									and	ie_controlado		= 'N'
									and	nr_sequencia		= nr_seq_horario_w
									--and	nr_seq_lote		is not null
									and	ie_classif_urgente	= ie_classif_urgente_w;
								elsif (ie_controlado_w = 'N') and (ie_padronizado_w = 'N') then
									update	prescr_mat_hor
									set	nr_seq_classif		= nr_seq_classif_w
									where	nr_prescricao		= nr_prescricao_w
									and	ie_controlado		= 'N'
									and	ie_padronizado		= 'N'
									and	nr_sequencia		= nr_seq_horario_w
									--and	nr_seq_lote		is not null
									and	ie_classif_urgente	= ie_classif_urgente_w;
								elsif (ie_controlado_w = 'N') and (ie_padronizado_w = 'S') then
									update	prescr_mat_hor
									set	nr_seq_classif		= nr_seq_classif_w
									where	nr_prescricao		= nr_prescricao_w
									and	ie_controlado		= 'N'
									and	ie_padronizado		= 'S'
									--and	nr_seq_lote		is not null
									and	nr_sequencia		= nr_seq_horario_w
									and	ie_classif_urgente	= ie_classif_urgente_w;
								elsif (ie_controlado_w = 'S') and (ie_padronizado_w = 'A') then
									update	prescr_mat_hor
									set	nr_seq_classif		= nr_seq_classif_w
									where	nr_prescricao		= nr_prescricao_w
									and	ie_controlado		= 'S'
									--and	nr_seq_lote		is not null
									and	nr_sequencia		= nr_seq_horario_w
									and	ie_classif_urgente	= ie_classif_urgente_w;
								elsif (ie_controlado_w = 'S') and (ie_padronizado_w = 'N') then
									update	prescr_mat_hor
									set	nr_seq_classif		= nr_seq_classif_w
									where	nr_prescricao		= nr_prescricao_w
									and	ie_controlado		= 'S'
									and	ie_padronizado		= 'N'
									--and	nr_seq_lote		is not null
									and	nr_sequencia		= nr_seq_horario_w
									and	ie_classif_urgente	= ie_classif_urgente_w;
								elsif (ie_controlado_w = 'S') and (ie_padronizado_w = 'S') then
									update	prescr_mat_hor
									set	nr_seq_classif		= nr_seq_classif_w
									where	nr_prescricao		= nr_prescricao_w
									and	ie_controlado		= 'S'
									and	ie_padronizado		= 'S'
									--and	nr_seq_lote		is not null
									and	nr_sequencia		= nr_seq_horario_w
									and	ie_classif_urgente	= ie_classif_urgente_w;
								end if;
							
								end;
							end loop;
							close C11;
						end if;

						if (ie_local_estoque_mat_hor_w	= 'S') then
						
							cd_setor_atendimento_w := cd_setor_prescr_w;
							if (ie_local_estoque_w = 'S') then
								CALL define_local_disp_prescr(nr_prescricao_w, nr_seq_item_w, cd_perfil_w, nm_usuario_p);
								select	max(cd_local_estoque)
								into STRICT	cd_local_estoque_w
								from	prescr_material b
								where	nr_prescricao	= nr_prescricao_w
								and	nr_sequencia	= nr_seq_item_w;
								
								cd_setor_atendimento_w		:= Obter_Setor_Atendimento(nr_atendimento_p);
							elsif (ie_local_estoque_w = 'R') then
								CALL define_local_disp_prescr(nr_prescricao_w, nr_seq_item_w, cd_perfil_w, nm_usuario_p);
								select	max(cd_local_estoque)
								into STRICT	cd_local_estoque_w
								from	prescr_material b
								where	nr_prescricao	= nr_prescricao_w
								and	nr_sequencia	= nr_seq_item_w;
								
								cd_setor_atendimento_w		:= Obter_Setor_Atendimento_lib(nr_atendimento_p);
							end if;
							
							CALL define_disp_prescr_mat_hor(nr_seq_horario_w, nr_prescricao_w, nr_seq_item_w, cd_perfil_w, nm_usuario_p);
						
							select	coalesce(max(cd_local_estoque),cd_local_estoque_w)
							into STRICT	cd_local_estoque_w
							from	prescr_mat_hor
							where	nr_sequencia	= nr_seq_horario_w;
							
							update	prescr_mat_hor
							set	nr_seq_turno	= coalesce(Obter_turno_horario_prescr(cd_estabelecimento_w, cd_setor_atendimento_w, to_char(dt_horario_w,'hh24:mi'), cd_local_estoque_w),nr_seq_turno)
							where	nr_sequencia	= nr_seq_horario_w;
						end if;
						
						/* gerar evento aprazamento */

						if (nr_prescr_atual_w <> nr_prescricao_w) and (coalesce(nr_seq_horario_w,0) > 0) and (coalesce(ie_gerar_evento_p,'S') <> 'N') then
							CALL gerar_evento_reaprazamento(nr_atendimento_p, nr_prescricao_w, nr_seq_item_w, nr_seq_horario_w, cd_item_p, ie_tipo_item_p, ie_alteracao_w, nr_seq_motivo_p, ds_justificativa_p, nm_usuario_p, nr_seq_proc_interno_p,ie_acm_sn_w,nr_seq_assinatura_p);
							--adep_gerar_area_prep(nr_prescricao_w, null, nm_usuario_p);
							CALL Gerar_Lote_Atend_Prescricao(nr_prescricao_w, nr_seq_item_w, nr_seq_horario_w, 'S', nm_usuario_p, 'AIP');
							CALL gerar_acm_sn_apraz_prescricao(nr_prescricao_w, nr_seq_item_w,cd_local_estoque_w,nm_usuario_p);	
						end if;

						/* atualizar prescricao */

						nr_prescr_atual_w := nr_prescricao_w;							
						end;
					else
						ie_inconsistencia_w := 'H';
						if (coalesce(ds_inconsistentes_w::text, '') = '') then
							ds_inconsistentes_w := to_char(nr_prescricao_w);
						elsif (position(nr_prescricao_w in ds_inconsistentes_w) = 0) then
							ds_inconsistentes_w := ds_inconsistentes_w || ', ' || to_char(nr_prescricao_w);
						end if;					
						
					end if;
				end;
			elsif (ie_aprazar_interv_p = 'S') then
				CALL aprazar_item_prescr_interv(ie_tipo_item_p, nr_prescricao_w, nr_seq_item_w, dt_horario_p, nr_seq_motivo_p, ds_justificativa_p, nm_usuario_p, nr_seq_assinatura_p);
			end if;
			
			end;
		end loop;
		close C04;

		if (ie_grava_log_rastr_w = 'S') then
			CALL adep_gerar_log_rastr(substr('APRAZAR_ITEM_PRESCR C15 PARAMETERS' || chr(10) ||
				'{'||chr(10)||
				'"vetor_w(x).nr_prescricao_w" : "'||vetor_w[x].nr_prescricao_w||'",'||chr(10)||
				'"cd_intervalo_p" : "'||cd_intervalo_p||'",'||chr(10)||
				'"cd_item_p" : "'||cd_item_p||'",'||chr(10)||
				'"cd_setor_pac_w" : "'||cd_setor_pac_w||'",'||chr(10)||
				'"cd_unidade_medida_p" : "'||cd_unidade_medida_p||'",'||chr(10)||
				'"dt_horario_w" : "'||to_char(dt_horario_w, 'dd/mm/yyyy hh24:mi:ss')||'",'||chr(10)||
				'"dt_validade_w" : "'||to_char(dt_validade_w, 'dd/mm/yyyy hh24:mi:ss')||'",'||chr(10)||
				'"ie_acm_sn_p" : "'||ie_acm_sn_p||'",'||chr(10)||
				'"ie_aprazar_agrupados_w" : "'||ie_aprazar_agrupados_w||'",'||chr(10)||
				'"ie_aprazar_suspensos_w" : "'||ie_aprazar_suspensos_w||'",'||chr(10)||
				'"ie_data_lib_prescr_w" : "'||ie_data_lib_prescr_w||'",'||chr(10)||
				'"ie_tipo_item_p" : "'||ie_tipo_item_p||'",'||chr(10)||
				'"nr_agrupamento_p" : "'||nr_agrupamento_p||'",'||chr(10)||
				'"nr_atendimento_p" : "'||nr_atendimento_p||'",'||chr(10)||
				'"nr_prescr_w" : "'||nr_prescr_w||'",'||chr(10)||
				'"nr_prescr_ww" : "'||nr_prescr_w||'",'||chr(10)||
				'"nr_prescr_www" : "'||nr_prescr_w||'",'||chr(10)||
				'"nr_seq_item_p" : "'||nr_seq_item_p||'",'||chr(10)||
				'"qt_item_p" : "'||qt_item_p||'"}',1,1500));
		end if;

		open C15;
		loop
		fetch C15 into	
			nr_prescricao_w,
			nr_seq_item_w,
			cd_local_estoque_w,
			nr_agrupamento_w,
			cd_material_w,		
			cd_unidade_medida_w,		
			ie_sn_w,
			ie_acm_w,
			qt_total_dispensar_w,
			dt_proxima_dose_w,
			qt_hora_intervalo_w,
			dt_validade_prescr_w;
		EXIT WHEN NOT FOUND; /* apply on C15 */
			begin			
			ie_cursor_w := 'S';
			
			select	max(dt_liberacao),
				max(cd_estabelecimento)
			into STRICT	dt_liberacao_w,
				cd_estabelecimento_w
			from	prescr_medica
			where	nr_prescricao = nr_prescricao_w;

			select	coalesce(max(qt_min_agora),0),
				coalesce(max(qt_min_especial),0),
				max(ie_classif_urgencia),
				coalesce(max(ie_forma_agora), 'N'),
				coalesce(max(ie_gera_disp_acm_sn),'S')
			into STRICT	qt_min_agora_w,
				qt_min_especial_w,
				ie_classif_nao_padrao_w,
				ie_agora_impressao_w,
				ie_gera_disp_acm_sn_w
			from	parametros_farmacia
			where	cd_estabelecimento = cd_estabelecimento_w;
			
			dt_limite_agora_w	:= dt_liberacao_w + qt_min_agora_w/1440;
			dt_limite_especial_w	:= dt_liberacao_w + qt_min_especial_w/1440;
			
			if (coalesce(ie_gerar_classif_agora_w,'N') = 'S') then
				dt_hora_atual_w := clock_timestamp();
				dt_limite_agora_w	:=  dt_hora_atual_w + qt_min_agora_w/1440; 			
			end if;

			if (ie_sn_w = 'S') or (ie_acm_w = 'S') then			
				ie_acm_sn_w := 'S';
			else
				ie_acm_sn_w := 'N';
			end if;
			
			if (ie_aprazar_interv_p = 'N') then
				ie_aprazar_w := 'S';
				if (ie_aprazar_w = 'S') then
					begin
					select	cd_estabelecimento,
						cd_setor_atendimento,
						dt_inicio_prescr
					into STRICT	cd_estab_prescr_w,
						cd_setor_prescr_w,
						dt_inicio_prescr_w
					from	prescr_medica
					where	nr_prescricao = nr_prescricao_w;
					
					cd_setor_atendimento_w := cd_setor_prescr_w;
					if (ie_local_estoque_w = 'S') then
						CALL define_local_disp_prescr(nr_prescricao_w, nr_seq_item_w, cd_perfil_w, nm_usuario_p);
						select	max(cd_local_estoque)
						into STRICT	cd_local_estoque_w
						from	prescr_material b
						where	nr_prescricao	= nr_prescricao_w
						and	nr_sequencia	= nr_seq_item_w;
						
						cd_setor_atendimento_w		:= Obter_Setor_Atendimento(nr_atendimento_p);
					elsif (ie_local_estoque_w = 'R') then
						CALL define_local_disp_prescr(nr_prescricao_w, nr_seq_item_w, cd_perfil_w, nm_usuario_p);
						select	max(cd_local_estoque)
						into STRICT	cd_local_estoque_w
						from	prescr_material b
						where	nr_prescricao	= nr_prescricao_w
						and	nr_sequencia	= nr_seq_item_w;
						
						cd_setor_atendimento_w		:= Obter_Setor_Atendimento_lib(nr_atendimento_p);
					end if;
					
					ie_agrupador_w	:= 16;
					
					/* obter informacoes horario original */

					select	coalesce(min(nr_sequencia),0)
					into STRICT	nr_seq_orig_w
					from	prescr_mat_hor
					where	nr_prescricao = nr_prescricao_w
					and	nr_seq_material = nr_seq_item_w
					and	coalesce(ie_situacao,'A') = 'A'
					and	Obter_se_horario_liberado(dt_lib_horario, dt_horario) = 'S';
										
					if (nr_seq_orig_w > 0) then
						select	qt_dose,
							qt_dispensar,
							qt_dispensar_hor,
							cd_unidade_medida,
							cd_unidade_medida_dose
						into STRICT	qt_dose_w,
							qt_dispensar_w,
							qt_dispensar_hor_w,
							cd_unidade_medida_w,
							cd_unidade_medida_dose_w
						from	prescr_mat_hor
						where	nr_sequencia = nr_seq_orig_w;
					else		
						cd_unid_med_dose_hor_w := null;
						qt_dose_hor_w	:= null;	
														
						SELECT * FROM obter_dose_um_horario_pmh(cd_material_w, qt_item_p, cd_unidade_medida_dose_w, qt_dose_hor_w, cd_unid_med_dose_hor_w) INTO STRICT qt_dose_hor_w, cd_unid_med_dose_hor_w;							
					end if;
					
					select	coalesce(max(substr(Obter_se_medic_controlado(cd_item_p),1,1)),'N'),
						coalesce(max(substr(obter_se_material_padronizado(cd_estabelecimento_w, cd_item_p),1,1)),'N')
					into STRICT	ie_controlado_w,
						ie_padronizado_w
					;
					
					/*	Fabio e JonasJonas - 19/01/2010 = Para gerar os lotes como AGORA dependendo do horario final do turno, e nao mais pelo minutos de agora*/

					if (ie_agora_impressao_w = 'S') then
						nr_seq_turno_hor_ag_w	:= obter_turno_horario_prescr(cd_estabelecimento_w,cd_setor_prescr_w,to_char(dt_horario_w,'hh24:mi'),cd_local_estoque_w);
						select	max(to_char(b.hr_inicial,'hh24:mi')),
							max(to_char(b.hr_final,'hh24:mi'))
						into STRICT	hr_turno_agora_w,
							hr_final_turno_agora_w
						from	regra_turno_disp_param b,
							regra_turno_disp a
						where	a.nr_sequencia		= b.nr_seq_turno
						and	a.cd_estabelecimento	= cd_estabelecimento_w
						and	a.nr_sequencia		= nr_seq_turno_hor_ag_w
						and (coalesce(b.cd_setor_atendimento,coalesce(cd_setor_prescr_w,0))	= coalesce(cd_setor_prescr_w,0));

						select	coalesce(max(qt_min_antes_atend), 0),
							coalesce(max(ie_define_agora), 'N')
						into STRICT	qt_min_antes_atend_w,
							ie_define_agora_w
						from	regra_tempo_disp
						where	cd_estabelecimento	= cd_estabelecimento_w
						and (coalesce(cd_setor_atendimento,coalesce(cd_setor_prescr_w,0)) = coalesce(cd_setor_prescr_w,0))
						and	nr_seq_turno = nr_seq_turno_hor_ag_w
						and	ie_situacao = 'A';

						if (hr_turno_agora_w > hr_final_turno_agora_w) then
							if (ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_horario_w) > ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_inicio_prescr_w)) then
								dt_limite_agora_w := PKG_DATE_UTILS.get_Time(dt_horario_w - 1, hr_turno_agora_w) - (qt_min_antes_atend_w/1440);
							else
								dt_limite_agora_w := PKG_DATE_UTILS.get_Time(dt_horario_w, hr_turno_agora_w) - (qt_min_antes_atend_w/1440);
							end if;
						else
							dt_limite_agora_w := PKG_DATE_UTILS.get_Time(dt_horario_w, hr_turno_agora_w) - (qt_min_antes_atend_w/1440);
						end if;
					end if;
					/*	Fabio e Jonas - 19/01/2010 = Final da alteracao*/

					
					if (coalesce(ie_classif_nao_padrao_w::text, '') = '') or (ie_padronizado_w = 'S') then
						begin
						ie_classif_urgente_w	:= 'N';
						if (dt_horario_w <= dt_limite_agora_w) then
							ie_classif_urgente_w	:= 'A';
						elsif	((dt_limite_agora_w <= clock_timestamp()) and (ie_agora_impressao_w = 'S') and (ie_define_agora_w = 'N')) then
							ie_classif_urgente_w	:= 'A';
						elsif (ie_agora_impressao_w = 'S' and ie_define_agora_w = 'S') and
							(dt_horario_w <= (clock_timestamp() + (qt_min_antes_atend_w /1440))) then
							ie_classif_urgente_w	:= 'A';
						elsif (dt_horario_w <= dt_limite_especial_w) then
							ie_classif_urgente_w	:= 'E';
						end if;
						end;
					else
						ie_classif_urgente_w	:= ie_classif_nao_padrao_w;
					end if;
									
					ie_liberado_w := 'N';
					
					select	coalesce(max('S'),'N')
					into STRICT	ie_liberado_w
					from	prescr_mat_hor	
					where	nr_prescricao = nr_prescricao_w
					and	(dt_lib_horario IS NOT NULL AND dt_lib_horario::text <> '');
					
					select	count(*)
					into STRICT	qt_item_w
					from	prescr_mat_hor
					where	nr_prescricao		in (nr_prescr_ww, nr_prescr_www)
					and	dt_horario		= dt_horario_w
					and	cd_material		= cd_item_p
					and	qt_dose			= qt_dose_w
					and	ie_agrupador		= ie_agrupador_w
					and	cd_unidade_medida_dose	= cd_unidade_medida_dose_w
					and	(dt_lib_horario IS NOT NULL AND dt_lib_horario::text <> '')
					and	coalesce(ie_horario_especial,'N') <> 'S';
					
					ie_gerar_lote_w	:= 'S';
					if (qt_item_w = 0) then		
						select	nextval('prescr_mat_hor_seq')
						into STRICT	nr_seq_horario_w
						;
						
						if (ie_gera_disp_acm_sn_w = 'N' AND ie_acm_sn_w = 'S') then
							ie_gerar_lote_w := 'S';
							update	prescr_material
							set		ie_gerar_lote 	= 'S'
							where	nr_prescricao	= nr_prescricao_w
							and	nr_sequencia	= nr_seq_item_w;
						end if;	

						insert into prescr_mat_hor(
							nr_sequencia,
							nr_seq_digito,
							nr_prescricao,
							nr_seq_material,
							ie_agrupador,
							dt_atualizacao,
							nm_usuario,
							dt_atualizacao_nrec,
							nm_usuario_nrec,
							cd_material,
							qt_dose,
							qt_dispensar_hor,
							ds_horario,
							dt_horario,
							cd_unidade_medida,
							cd_unidade_medida_dose,
							ie_urgente,
							dt_emissao_farmacia,
							dt_fim_horario,
							dt_suspensao,
							ie_horario_especial,
							qt_hor_reaprazamento,
							nm_usuario_reaprazamento,
							nr_seq_turno,
							dt_disp_farmacia,
							ie_aprazado,
							ie_classif_urgente,
							ie_padronizado,
							ie_controlado,
							cd_unid_med_hor,
							qt_horario,
							ie_gerar_lote,
							dt_lib_horario,
							qt_dispensar,
							nr_atendimento
							)
						values (
							nr_seq_horario_w,
							calcula_digito('MODULO11',nr_seq_horario_w),
							nr_prescricao_w,
							nr_seq_item_w,
							ie_agrupador_w,
							clock_timestamp(),
							nm_usuario_p,
							clock_timestamp(),
							nm_usuario_p,
							cd_item_p,
							qt_dose_w,
							qt_dispensar_hor_w,
							to_char(dt_horario_w,'hh24:mi'),
							dt_horario_w,
							cd_unidade_medida_w,
							cd_unidade_medida_dose_w,
							'N',
							CASE WHEN ie_gerar_necessidade_disp_w='S' THEN null  ELSE clock_timestamp() END ,
							null,
							null,
							'N',
							null,
							null,
							obter_turno_horario_prescr(cd_estab_prescr_w,cd_setor_atendimento_w,to_char(dt_horario_w,'hh24:mi'),cd_local_estoque_w),
							clock_timestamp(),
							'S',
							ie_classif_urgente_w,
							ie_padronizado_w,
							ie_controlado_w,
							coalesce(cd_unid_med_dose_hor_w, cd_unidade_medida_dose_w),
							qt_dose_w,
							coalesce(ie_gerar_lote_w,'S'),
							CASE WHEN ie_liberado_w='N' THEN  null  ELSE clock_timestamp() END ,
							qt_total_dispensar_w,
							nr_atendimento_p
							);
							
						if (dt_proxima_dose_w IS NOT NULL AND dt_proxima_dose_w::text <> '') and (obter_ocorrencia_intervalo(cd_intervalo_p,24,'H') > 24) then
							dt_proxima_dose_w	:= dt_horario_w + (obter_ocorrencia_intervalo(cd_intervalo_p,24,'H') / 24);
							
							update	prescr_material
							set	dt_proxima_dose	= dt_proxima_dose_w
							where	nr_prescricao	= nr_prescricao_w
							and	nr_sequencia	= nr_seq_item_w;
							
							if (coalesce(wheb_usuario_pck.get_ie_commit, 'S') = 'S') then commit; end if;
						end if;
						
						CALL Gerar_Gedi_Medic_atend(cd_estab_prescr_w, nr_prescricao_w, nr_seq_item_w, nr_seq_horario_w, nm_usuario_p);
						CALL aprazar_itens_dependentes(cd_estab_prescr_w, cd_setor_prescr_w, nr_atendimento_p, nr_prescricao_w, nr_seq_item_w, nr_agrupamento_w, dt_horario_w, ie_gerar_necessidade_disp_w, nm_usuario_p, null, nr_seq_hor_glic_w, null, null, '');
						CALL adep_gerar_area_prep(nr_prescricao_w, null, nm_usuario_p);
						
						if (ie_gerar_proc_gedipa_job_w	= 'N') and (ie_liberado_w	= 'S') then
							CALL Gedipa_Gerar_Proc_Instantaneo(nr_prescricao_w,nr_seq_item_w,null,nr_seq_horario_w);
						end if;						
						
						if (coalesce(nr_seq_classif_param_w ,0) > 0)	then
							begin
							update	prescr_mat_hor
							set	nr_seq_classif		= nr_seq_classif_param_w
							where	nr_prescricao		= nr_prescricao_w	
							and	nr_sequencia		= nr_seq_horario_w;
							end;
						else
							if (ie_grava_log_rastr_w = 'S') then
								CALL adep_gerar_log_rastr(substr('APRAZAR_ITEM_PRESCR C11 LINE 3936 PARAMETERS' || chr(10) ||
									'{'||chr(10)||
									'"cd_estabelecimento_w" : "'||cd_estabelecimento_w||'"}',1,1500));
							end if;
							open C11;
							loop
							fetch C11 into	
								nr_seq_classif_w,
								ie_classif_urgente_w,
								ie_controlado_w,
								ie_padronizado_w;
							EXIT WHEN NOT FOUND; /* apply on C11 */
								begin
								if (ie_controlado_w = 'A') and (ie_padronizado_w = 'A') then
									update	prescr_mat_hor
									set	nr_seq_classif		= nr_seq_classif_w
									where	nr_prescricao		= nr_prescricao_w	
									and	nr_sequencia		= nr_seq_horario_w
									--and	nr_seq_lote		is not null
									and	ie_classif_urgente	= ie_classif_urgente_w;
								elsif (ie_controlado_w = 'A') and (ie_padronizado_w = 'S') then
									update	prescr_mat_hor
									set	nr_seq_classif		= nr_seq_classif_w
									where	nr_prescricao		= nr_prescricao_w
									and	ie_padronizado		= 'S'
									and	nr_sequencia		= nr_seq_horario_w
									--and	nr_seq_lote		is not null
									and	ie_classif_urgente	= ie_classif_urgente_w;
								elsif (ie_controlado_w = 'A') and (ie_padronizado_w = 'N') then
									update	prescr_mat_hor
									set	nr_seq_classif		= nr_seq_classif_w
									where	nr_prescricao		= nr_prescricao_w
									and	ie_padronizado		= 'N'
									and	nr_sequencia		= nr_seq_horario_w
									--and	nr_seq_lote		is not null
									and	ie_classif_urgente	= ie_classif_urgente_w;
								elsif (ie_controlado_w = 'N') and (ie_padronizado_w = 'A') then
									update	prescr_mat_hor
									set	nr_seq_classif		= nr_seq_classif_w
									where	nr_prescricao		= nr_prescricao_w
									and	ie_controlado		= 'N'
									and	nr_sequencia		= nr_seq_horario_w
									--and	nr_seq_lote		is not null
									and	ie_classif_urgente	= ie_classif_urgente_w;
								elsif (ie_controlado_w = 'N') and (ie_padronizado_w = 'N') then
									update	prescr_mat_hor
									set	nr_seq_classif		= nr_seq_classif_w
									where	nr_prescricao		= nr_prescricao_w
									and	ie_controlado		= 'N'
									and	ie_padronizado		= 'N'
									and	nr_sequencia		= nr_seq_horario_w
									--and	nr_seq_lote		is not null
									and	ie_classif_urgente	= ie_classif_urgente_w;
								elsif (ie_controlado_w = 'N') and (ie_padronizado_w = 'S') then
									update	prescr_mat_hor
									set	nr_seq_classif		= nr_seq_classif_w
									where	nr_prescricao		= nr_prescricao_w
									and	ie_controlado		= 'N'
									and	ie_padronizado		= 'S'
									--and	nr_seq_lote		is not null
									and	nr_sequencia		= nr_seq_horario_w
									and	ie_classif_urgente	= ie_classif_urgente_w;
								elsif (ie_controlado_w = 'S') and (ie_padronizado_w = 'A') then
									update	prescr_mat_hor
									set	nr_seq_classif		= nr_seq_classif_w
									where	nr_prescricao		= nr_prescricao_w
									and	ie_controlado		= 'S'
									--and	nr_seq_lote		is not null
									and	nr_sequencia		= nr_seq_horario_w
									and	ie_classif_urgente	= ie_classif_urgente_w;
								elsif (ie_controlado_w = 'S') and (ie_padronizado_w = 'N') then
									update	prescr_mat_hor
									set	nr_seq_classif		= nr_seq_classif_w
									where	nr_prescricao		= nr_prescricao_w
									and	ie_controlado		= 'S'
									and	ie_padronizado		= 'N'
									--and	nr_seq_lote		is not null
									and	nr_sequencia		= nr_seq_horario_w
									and	ie_classif_urgente	= ie_classif_urgente_w;
								elsif (ie_controlado_w = 'S') and (ie_padronizado_w = 'S') then
									update	prescr_mat_hor
									set	nr_seq_classif		= nr_seq_classif_w
									where	nr_prescricao		= nr_prescricao_w
									and	ie_controlado		= 'S'
									and	ie_padronizado		= 'S'
									--and	nr_seq_lote		is not null
									and	nr_sequencia		= nr_seq_horario_w
									and	ie_classif_urgente	= ie_classif_urgente_w;
								end if;
							
								end;
							end loop;
							close C11;
						end if;
							
						if (ie_local_estoque_mat_hor_w	= 'S') then
							CALL define_disp_prescr_mat_hor(nr_seq_horario_w, nr_prescricao_w, nr_seq_item_w, cd_perfil_w, nm_usuario_p);
						
							select	coalesce(max(cd_local_estoque),cd_local_estoque_w)
							into STRICT	cd_local_estoque_w
							from	prescr_mat_hor
							where	nr_sequencia	= nr_seq_horario_w;
							
							update	prescr_mat_hor
							set	nr_seq_turno	= coalesce(Obter_turno_horario_prescr(cd_estabelecimento_w, cd_setor_atendimento_w, to_char(dt_horario_w,'hh24:mi'), cd_local_estoque_w),nr_seq_turno)
							where	nr_sequencia	= nr_seq_horario_w;
						end if;

						if (ie_gerar_necessidade_disp_w = 'S') then

							if	((ie_acm_w = 'S') or (ie_sn_w = 'S' )) then
								if (ie_imprimir_acm_sn_w = 'S') then
									update	prescr_medica
									set	dt_emissao_farmacia	 = NULL,
										nm_usuario_imp_far	 = NULL
									where	nr_prescricao		= nr_prescricao_w;
								end if;
							else	
								update	prescr_medica
								set	dt_emissao_farmacia	 = NULL,
									nm_usuario_imp_far	 = NULL
								where	nr_prescricao		= nr_prescricao_w;
							end if;
								
							update	prescr_material
							set	cd_motivo_baixa	= 0,
								dt_baixa	 = NULL
							where	nr_prescricao	= nr_prescricao_w
							and	nr_sequencia	= nr_seq_item_w;

							update	prescr_material
							set	cd_motivo_baixa	= 0,
								dt_baixa	 = NULL
							where	nr_prescricao	= nr_prescricao_w
							and	nr_sequencia	<> nr_seq_item_w
							and	nr_agrupamento	= nr_agrupamento_w;

							if (ie_gerar_nec_disp_kit_w = 'S') then
								update	prescr_material
								set	cd_motivo_baixa	= 0,
									dt_baixa	 = NULL
								where	nr_prescricao		= nr_prescricao_w
								and	nr_sequencia_diluicao	= nr_seq_item_w;
								
								update	prescr_material
								set	cd_motivo_baixa	= 0,
									dt_baixa	 = NULL
								where	nr_prescricao	= nr_prescricao_w
								and	nr_seq_kit	= nr_seq_item_w;
							end if;
												
						end if;
					
						/* gerar evento aprazamento */

						if (nr_prescr_atual_w <> nr_prescricao_w) and (coalesce(nr_seq_horario_w,0) > 0) and (coalesce(ie_gerar_evento_p,'S') <> 'N') then
							
							ie_gera_lote_param_w	:= 'S';
							if (ie_gerar_lote_ww = 'R') and (ie_acm_sn_p	= 'S') and
								((dt_horario_w + qt_hora_intervalo_w/24) > dt_validade_prescr_w) then
								ie_gera_lote_param_w	:= 'N';
							elsif (ie_gerar_lote_ww = 'T') and (ie_acm_sn_p	= 'N') then
								ie_gera_lote_param_w	:= 'N';
							end if;
							CALL adep_gerar_area_prep(nr_prescricao_w, null, nm_usuario_p);							
							if (ie_gera_lote_param_w = 'S') and
								((ie_gerar_lote_ww not in ('N','A')) or (PKG_DATE_UTILS.start_of(dt_horario_w,'mi',0) >= PKG_DATE_UTILS.start_of(clock_timestamp(),'mi',0))) then
								CALL Gerar_Lote_Atend_Prescricao(nr_prescricao_w, nr_seq_item_w, nr_seq_horario_w, 'S', nm_usuario_p, 'AIP');
							end if;

							CALL gerar_evento_reaprazamento(nr_atendimento_p, nr_prescricao_w, nr_seq_item_w, nr_seq_horario_w, cd_item_p, ie_tipo_item_p, ie_alteracao_w, nr_seq_motivo_p, ds_justificativa_p, nm_usuario_p, nr_seq_proc_interno_p,ie_acm_sn_w,nr_seq_assinatura_p);
							CALL gerar_acm_sn_apraz_prescricao(nr_prescricao_w, nr_seq_item_w,cd_local_estoque_w,nm_usuario_p);	
						end if;
					end if;
					/* atualizar prescricao */

					nr_prescr_atual_w := nr_prescricao_w;	
					end;
				else
					ie_inconsistencia_w := 'H';
					if (coalesce(ds_inconsistentes_w::text, '') = '') then
						ds_inconsistentes_w := to_char(nr_prescricao_w);
					elsif (position(nr_prescricao_w in ds_inconsistentes_w) = 0) then
						ds_inconsistentes_w := ds_inconsistentes_w || ', ' || to_char(nr_prescricao_w);
					end if;					
					
				end if;
			elsif (ie_aprazar_interv_p = 'S') then
				CALL aprazar_item_prescr_interv(ie_tipo_item_p, nr_prescricao_w, nr_seq_item_w, dt_horario_p, nr_seq_motivo_p, ds_justificativa_p, nm_usuario_p, nr_seq_assinatura_p);
			end if;
			end;
		end loop;
		close C15;
		
		select	min(a.dt_inicio_prescr),
				max(a.dt_validade_prescr)
		into STRICT	dt_ini_w,
				dt_fim_w
		from	prescr_proc_hor c,
				prescr_procedimento b,
				prescr_medica a
		where	c.nr_prescricao = b.nr_prescricao
		and	c.nr_seq_procedimento = b.nr_sequencia
		and	b.nr_prescricao = a.nr_prescricao
		and	((a.nr_seq_pend_pac_acao IS NOT NULL AND a.nr_seq_pend_pac_acao::text <> '') or ((obter_data_lib_proc_adep(a.dt_liberacao, a.dt_liberacao_medico, ie_data_proc_w) IS NOT NULL AND (obter_data_lib_proc_adep(a.dt_liberacao, a.dt_liberacao_medico, ie_data_proc_w))::text <> '')))
		and	obter_se_exibir_adep_suspensos(b.dt_suspensao, ie_exibe_suspenso_w) = 'S'
		and	obter_se_exibir_rep_adep_setor(cd_setor_pac_w,a.cd_setor_atendimento,coalesce(a.ie_adep,'S')) = 'S'
		and	a.dt_validade_prescr > dt_validade_w
		and	a.nr_atendimento = nr_atendimento_p
		and	((((b.nr_sequencia	= nr_Seq_item_p AND b.nr_prescricao	= nr_prescricao_p) or (ie_tipo_item_p	<> 'P')) and (ie_desagrupa_proced_w = 'S')) or (ie_desagrupa_proced_w  = 'N'))
		and	((a.nr_prescricao	= vetor_w[x].nr_prescricao_w) or
			(exists (
				SELECT	1
				from	prescr_proc_hor d,
					prescr_procedimento e
				where	d.nr_prescricao 		= e.nr_prescricao
				and	d.nr_seq_procedimento		= e.nr_sequencia
				and	b.nr_prescricao 		= a.nr_prescricao
				and	coalesce(d.ie_situacao,'A')		= 'A'	
				and	e.cd_procedimento 		= cd_item_p
				and	coalesce(e.nr_seq_proc_interno,0) 	= coalesce(nr_seq_proc_interno_p,0)
				and	coalesce(e.cd_intervalo,'XPTO')	= coalesce(cd_intervalo_p,'XPTO')
				and	coalesce(e.qt_procedimento,1) 	= coalesce(qt_item_p,coalesce(b.qt_procedimento,1))
				and	((coalesce(b.nr_seq_exame::text, '') = '') or (ie_tipo_item_p in ('G','C')))
				and	Obter_se_horario_liberado(d.dt_lib_horario, d.dt_horario) = 'S'
				)))
		and	b.cd_procedimento = cd_item_p
		and	obter_se_acm_sn(b.ie_acm, b.ie_se_necessario) = ie_acm_sn_p
		and	((coalesce(ie_aprazar_suspensos_w,'S') = 'S') or (coalesce(b.dt_suspensao::text, '') = ''))
		and	coalesce(b.cd_intervalo,'XPTO') = coalesce(cd_intervalo_p,'XPTO')
		and	coalesce(b.qt_procedimento,1) = coalesce(qt_item_p,coalesce(b.qt_procedimento,1))
		and		((coalesce(b.nr_seq_exame::text, '') = '' and ie_laboratorio_p = 'N') or ((b.nr_seq_exame IS NOT NULL AND b.nr_seq_exame::text <> '') and ie_laboratorio_p = 'S') or (ie_tipo_item_p in ('G','C')))		
		and		((ie_aprazar_agrupados_w = 'N') or (a.nr_prescricao between nr_prescr_www and nr_prescr_ww))
		and		coalesce(b.nr_seq_proc_interno,0) = coalesce(nr_seq_proc_interno_p, 0)
		and		((a.nr_seq_pend_pac_acao IS NOT NULL AND a.nr_seq_pend_pac_acao::text <> '') or (Obter_se_horario_liberado(c.dt_lib_horario, c.dt_horario) = 'S'))
		and		ie_tipo_item_p in ('P','G','C','I','HM');

		if (ie_tipo_item_p in ('G','C')) then
			-- Busca prescricao vigente do item de controle glicemico
			select	coalesce(max(a.nr_prescricao),nr_prescr_www)
			into STRICT	nr_prescr_vigente_w
			from	prescr_procedimento b,
					prescr_medica a
			where	b.nr_prescricao = a.nr_prescricao
			and		obter_se_exibir_adep_suspensos(b.dt_suspensao, ie_exibe_suspenso_w) = 'S'
			and		coalesce(nr_seq_prot_glic,0) = coalesce(nr_seq_prot_glic_p,0)
			and		coalesce(b.nr_seq_proc_interno,0) = coalesce(nr_seq_proc_interno_p, 0)
			and		((((b.nr_sequencia	= nr_Seq_item_p AND b.nr_prescricao	= nr_prescricao_p) or (ie_tipo_item_p	<> 'P')) and (ie_desagrupa_proced_w = 'S')) or (ie_desagrupa_proced_w  = 'N'))
			and		(((a.nr_prescricao	= vetor_w[x].nr_prescricao_w) or
					   (exists (
						SELECT	1
						from	prescr_proc_hor d,
							prescr_procedimento e
						where	d.nr_prescricao 		= e.nr_prescricao
						and	d.nr_seq_procedimento		= e.nr_sequencia
						and	b.nr_prescricao 		= a.nr_prescricao
						and	coalesce(d.ie_situacao,'A')		= 'A'	
						and	e.cd_procedimento 		= cd_item_p
						and	coalesce(e.nr_seq_proc_interno,0) 	= coalesce(nr_seq_proc_interno_p,0)
						and	coalesce(e.cd_intervalo,'XPTO')	= coalesce(cd_intervalo_p,'XPTO')
						and	coalesce(e.qt_procedimento,1) 	= coalesce(qt_item_p,coalesce(b.qt_procedimento,1))
						and	((coalesce(b.nr_seq_exame::text, '') = '') or (ie_tipo_item_p in ('G','C')))
						and	Obter_se_horario_liberado(d.dt_lib_horario, d.dt_horario) = 'S'))))
			and		b.cd_procedimento = cd_item_p
			and		obter_se_acm_sn(b.ie_acm, b.ie_se_necessario) = ie_acm_sn_p
			and		((coalesce(ie_aprazar_suspensos_w,'S') = 'S') or (coalesce(b.dt_suspensao::text, '') = ''))
			and		coalesce(b.cd_intervalo,'XPTO') = coalesce(cd_intervalo_p,'XPTO')
			and		coalesce(b.qt_procedimento,1) = coalesce(qt_item_p,coalesce(b.qt_procedimento,1))
			and		((coalesce(b.nr_seq_exame::text, '') = '' and ie_laboratorio_p = 'N') or ((b.nr_seq_exame IS NOT NULL AND b.nr_seq_exame::text <> '') and ie_laboratorio_p = 'S') or (ie_tipo_item_p in ('G','C')))
			and	((((ie_tipo_item_p in ('G','C')) or (ie_aprazar_agrupados_w <> 'N')) and
				  ((dt_horario_w between dt_ini_w and dt_fim_w) or 
				   ((dt_horario_w between a.dt_prescricao and dt_fim_w) and ((coalesce(ie_acm,'N') = 'S') or (coalesce(ie_se_necessario,'N') = 'S'))))) or
				 ((ie_tipo_item_p not in ('G','C')) and
				  ((dt_horario_w between a.dt_inicio_prescr and a.dt_validade_prescr) or 
				   ((dt_horario_w between a.dt_prescricao and a.dt_validade_prescr) and ((coalesce(ie_acm,'N') = 'S') or (coalesce(ie_se_necessario,'N') = 'S'))))))
			and		(obter_data_lib_proc_adep(a.dt_liberacao, a.dt_liberacao_medico, ie_data_proc_w) IS NOT NULL AND (obter_data_lib_proc_adep(a.dt_liberacao, a.dt_liberacao_medico, ie_data_proc_w))::text <> '')
			and		obter_se_exibir_rep_adep_setor(cd_setor_pac_w,a.cd_setor_atendimento,coalesce(a.ie_adep,'S')) = 'S'
			and		coalesce(a.dt_validade_prescr,a.dt_inicio_prescr + 24/24) > dt_validade_w
			and		dt_horario_w between a.dt_inicio_prescr and a.dt_validade_prescr
			and		a.nr_atendimento = nr_atendimento_p
			--and 	ie_tipo_item_p in ('P','G','C','I','HM');
			and		ie_tipo_item_p in ('G','C');
		elsif (ie_tipo_item_p = 'P') then
		
			select	coalesce(max(a.nr_prescricao),nr_prescr_www)
			into STRICT	nr_prescr_vigente_w
			from	prescr_procedimento b,
					prescr_medica a
			where	b.nr_prescricao = a.nr_prescricao
			and		obter_se_exibir_adep_suspensos(b.dt_suspensao, ie_exibe_suspenso_w) = 'S'			
			and		coalesce(b.nr_seq_proc_interno,0) = coalesce(nr_seq_proc_interno_p, 0)
			and		((((b.nr_sequencia	= nr_Seq_item_p AND b.nr_prescricao	= nr_prescricao_p) or (ie_tipo_item_p	not in ('G', 'C'))) and (ie_desagrupa_proced_w = 'S')) or (ie_desagrupa_proced_w  = 'N'))
			and		(((a.nr_prescricao	= vetor_w[x].nr_prescricao_w) or (exists (
						SELECT	1
						from	prescr_proc_hor d,
							prescr_procedimento e
						where	d.nr_prescricao 		= e.nr_prescricao
						and	d.nr_seq_procedimento		= e.nr_sequencia
						and	b.nr_prescricao 		= a.nr_prescricao
						and	coalesce(d.ie_situacao,'A')		= 'A'	
						and	e.cd_procedimento 		= cd_item_p
						and	coalesce(e.nr_seq_proc_interno,0) 	= coalesce(nr_seq_proc_interno_p,0)
						and	coalesce(e.cd_intervalo,'XPTO')	= coalesce(cd_intervalo_p,'XPTO')
						and	coalesce(e.qt_procedimento,1) 	= coalesce(qt_item_p,coalesce(b.qt_procedimento,1))
						and	coalesce(b.nr_seq_exame::text, '') = ''
						and	Obter_se_horario_liberado(d.dt_lib_horario, d.dt_horario) = 'S'))))
			and		b.cd_procedimento = cd_item_p
			and		obter_se_acm_sn(b.ie_acm, b.ie_se_necessario) = ie_acm_sn_p
			and		((coalesce(ie_aprazar_suspensos_w,'S') = 'S') or (coalesce(b.dt_suspensao::text, '') = ''))
			and		coalesce(b.cd_intervalo,'XPTO') = coalesce(cd_intervalo_p,'XPTO')
			and		coalesce(b.qt_procedimento,1) = coalesce(qt_item_p,coalesce(b.qt_procedimento,1))
			and		((coalesce(b.nr_seq_exame::text, '') = '' and ie_laboratorio_p = 'N') or ((b.nr_seq_exame IS NOT NULL AND b.nr_seq_exame::text <> '') and ie_laboratorio_p = 'S') or (ie_tipo_item_p in ('P')))
			and	((((ie_tipo_item_p in ('P')) or (ie_aprazar_agrupados_w <> 'N')) and
				  ((dt_horario_w between dt_ini_w and dt_fim_w) or
				   ((dt_horario_w between a.dt_prescricao and dt_fim_w) and ((coalesce(ie_acm,'N') = 'S') or (coalesce(ie_se_necessario,'N') = 'S'))))) or
				 ((ie_tipo_item_p not in ('P')) and
				  ((dt_horario_w between a.dt_inicio_prescr and a.dt_validade_prescr) or 
				   ((dt_horario_w between a.dt_prescricao and a.dt_validade_prescr) and ((coalesce(ie_acm,'N') = 'S') or (coalesce(ie_se_necessario,'N') = 'S'))))))
			and		(obter_data_lib_proc_adep(a.dt_liberacao, a.dt_liberacao_medico, ie_data_proc_w) IS NOT NULL AND (obter_data_lib_proc_adep(a.dt_liberacao, a.dt_liberacao_medico, ie_data_proc_w))::text <> '')
			and		obter_se_exibir_rep_adep_setor(cd_setor_pac_w,a.cd_setor_atendimento,coalesce(a.ie_adep,'S')) = 'S'
			and		coalesce(a.dt_validade_prescr,a.dt_inicio_prescr + 24/24) > dt_validade_w
			and		dt_horario_w between a.dt_inicio_prescr and a.dt_validade_prescr
			and		a.nr_atendimento = nr_atendimento_p;	
			
		end if;

		if (ie_grava_log_rastr_w = 'S') then
			CALL adep_gerar_log_rastr(substr('APRAZAR_ITEM_PRESCR C05 PARAMETERS' || chr(10) ||
				'{'||chr(10)||
				'"cd_intervalo_p" : "'||cd_intervalo_p||'",'||chr(10)||
				'"cd_item_p" : "'||cd_item_p||'",'||chr(10)||
				'"cd_setor_pac_w" : "'||cd_setor_pac_w||'",'||chr(10)||
				'"ds_componentes_p" : "'||ds_componentes_p||'",'||chr(10)||
				'"dt_fim_w" : "'||to_char(dt_fim_w, 'dd/mm/yyyy hh24:mi:ss')||'",'||chr(10)||
				'"dt_horario_w" : "'||to_char(dt_horario_w, 'dd/mm/yyyy hh24:mi:ss')||'",'||chr(10)||
				'"dt_ini_w" : "'||to_char(dt_ini_w, 'dd/mm/yyyy hh24:mi:ss')||'",'||chr(10)||
				'"dt_validade_w" : "'||to_char(dt_validade_w, 'dd/mm/yyyy hh24:mi:ss')||'",'||chr(10)||
				'"ie_acm_sn_p" : "'||ie_acm_sn_p||'",'||chr(10)||
				'"ie_aprazar_agrupados_w" : "'||ie_aprazar_agrupados_w||'",'||chr(10)||
				'"ie_aprazar_ivc_adep_w" : "'||ie_aprazar_ivc_adep_w||'",'||chr(10)||
				'"ie_aprazar_suspensos_w" : "'||ie_aprazar_suspensos_w||'",'||chr(10)||
				'"ie_data_proc_w" : "'||ie_data_proc_w||'",'||chr(10)||
				'"ie_desagrupa_proced_w" : "'||ie_desagrupa_proced_w||'",'||chr(10)||
				'"ie_exibe_suspenso_w" : "'||ie_exibe_suspenso_w||'",'||chr(10)||
				'"ie_laboratorio_p" : "'||ie_laboratorio_p||'",'||chr(10)||
				'"ie_tipo_item_p" : "'||ie_tipo_item_p||'",'||chr(10)||
				'"nr_Seq_item_p" : "'||nr_Seq_item_p||'",'||chr(10)||
				'"nr_atendimento_p" : "'||nr_atendimento_p||'",'||chr(10)||
				'"nr_prescr_vigente_w" : "'||nr_prescr_vigente_w||'",'||chr(10)||
				'"nr_prescricao_p" : "'||nr_prescricao_p||'",'||chr(10)||
				'"nr_prescricao_www" : "'||nr_prescricao_www||'",'||chr(10)||
				'"nr_seq_proc_interno_p" : "'||nr_seq_proc_interno_p||'",'||chr(10)||
				'"nr_seq_prot_glic_p" : "'||nr_seq_prot_glic_p||'",'||chr(10)||
				'"qt_item_p" : "'||qt_item_p||'"}',1,1500));
		end if;

		open C05;
		loop
		fetch C05 into	
			nr_prescricao_w,
			nr_seq_item_w,		
			nr_agrupamento_w,		
			ie_sn_w,
			ie_acm_w;	
		EXIT WHEN NOT FOUND; /* apply on C05 */
			begin
			
			ie_cursor_w := 'S';
			
			select	max(dt_liberacao),
				max(cd_estabelecimento)
			into STRICT	dt_liberacao_w,
				cd_estabelecimento_w
			from	prescr_medica
			where	nr_prescricao = nr_prescricao_w;

			select	coalesce(max(qt_min_agora),0),
				coalesce(max(qt_min_especial),0),
				max(ie_classif_urgencia),
				coalesce(max(ie_forma_agora), 'N'),
				coalesce(max(ie_gera_disp_acm_sn),'S')
			into STRICT	qt_min_agora_w,
				qt_min_especial_w,
				ie_classif_nao_padrao_w,
				ie_agora_impressao_w,
				ie_gera_disp_acm_sn_w
			from	parametros_farmacia
			where	cd_estabelecimento = cd_estabelecimento_w;
			
			dt_limite_agora_w	:= dt_liberacao_w + qt_min_agora_w/1440;
			dt_limite_especial_w	:= dt_liberacao_w + qt_min_especial_w/1440;
			
			if (coalesce(ie_gerar_classif_agora_w,'N') = 'S') then
				dt_hora_atual_w := clock_timestamp();
				dt_limite_agora_w	:=  dt_hora_atual_w + qt_min_agora_w/1440; 			
			end if;

			if (ie_sn_w = 'S') or (ie_acm_w = 'S') then			
				ie_acm_sn_w := 'S';
			else
				ie_acm_sn_w := 'N';
			end if;	
			
			if (ie_aprazar_interv_p = 'N') then
				begin			
				ie_aprazar_w := 'S';
				if (ie_aprazar_w = 'S') then
					begin
					
					select	count(*)
					into STRICT	qt_item_w
					from	prescr_proc_hor		a
					where	a.nr_prescricao			= nr_prescricao_w
					and		a.nr_seq_procedimento 	= nr_seq_item_w
					and		a.cd_procedimento		= cd_item_p
					and		a.dt_horario			= dt_horario_w
					and		(a.dt_lib_horario IS NOT NULL AND a.dt_lib_horario::text <> '')
					and		coalesce(a.ie_horario_especial,'N') <> 'S'
					and		coalesce(a.dt_suspensao::text, '') = ''  LIMIT 1;
					
					if (qt_item_w = 0) then
						if (ie_tipo_item_p in ('G','C')) then
							if (coalesce(nr_seq_objeto_p,0) <> 6773) and (coalesce(ie_chamada_glicemia_p,'N') <> 'S') then
								ie_alteracao_w := ie_alteracao_w;
							else
								ie_alteracao_w := 17;
							end if;
						end if;

						select	nextval('prescr_proc_hor_seq')
						into STRICT	nr_seq_horario_w
						;
			
						/* obter informacoes horario original */

						
						select	coalesce(max(nr_seq_pend_pac_acao),0)
						into STRICT	nr_seq_pend_pac_acao_w
						from	prescr_medica
						where	nr_prescricao = nr_prescricao_w;
						
						select	coalesce(min(nr_sequencia),0)
						into STRICT	nr_seq_orig_w
						from	prescr_proc_hor
						where	nr_prescricao = nr_prescricao_w
						and	nr_seq_procedimento = nr_seq_item_w
						and	coalesce(ie_situacao,'A') = 'A'
						and	((nr_seq_pend_pac_acao_w > 0) or (Obter_se_horario_liberado(dt_lib_horario, dt_horario) = 'S'));

						if (nr_seq_orig_w > 0) then
							select	ie_origem_proced,
								nr_seq_proc_interno,
								cd_material_exame
							into STRICT	ie_origem_proced_w,
								nr_seq_proc_interno_w,
								cd_material_exame_w
							from	prescr_proc_hor
							where	nr_sequencia = nr_seq_orig_w
							and	((nr_seq_pend_pac_acao_w > 0) or (Obter_se_horario_liberado(dt_lib_horario, dt_horario) = 'S'));						
						end if;
						
						ie_liberado_w := 'N';
						
						select	coalesce(max('S'),'N')
						into STRICT	ie_liberado_w
						from	prescr_proc_hor	
						where	nr_prescricao = nr_prescricao_w
						and	(dt_lib_horario IS NOT NULL AND dt_lib_horario::text <> '');
						
						if (ie_liberado_w = 'N') and (nr_seq_pend_pac_acao_w > 0) then
							ie_liberado_w := 'S';
						end if;

						insert into prescr_proc_hor(
							nr_sequencia,
							dt_atualizacao,
							nm_usuario,
							dt_atualizacao_nrec,
							nm_usuario_nrec,
							nr_prescricao,
							nr_seq_procedimento,
							cd_procedimento,
							ie_origem_proced,
							nr_seq_proc_interno,
							ds_horario,
							dt_horario,
							ie_urgente,
							dt_fim_horario,
							dt_suspensao,
							ie_horario_especial,
							cd_material_exame,
							nm_usuario_reaprazamento,
							qt_hor_reaprazamento,
							ie_aprazado,
							ie_dose_especial,
							nm_usuario_dose_esp,
							dt_lib_horario,
							nr_seq_hor_glic,
							nr_etapa
							)
						values	(
							nr_seq_horario_w,
							clock_timestamp(),
							nm_usuario_p,
							clock_timestamp(),
							nm_usuario_p,
							nr_prescricao_w,
							nr_seq_item_w,
							cd_item_p,
							ie_origem_proced_w,						
							nr_seq_proc_interno_w,
							--to_char(dt_horario_p,'hh24:mi'),
							--dt_horario_p,
							to_char(dt_horario_w,'hh24:mi'),
							dt_horario_w,
							'N',
							null,
							null,
							'N',
							cd_material_exame_w,
							null,
							null,
							'S',
							CASE WHEN coalesce(nr_seq_horario_p::text, '') = '' THEN 'N'  ELSE CASE WHEN ie_tipo_item_p='G' THEN 'S' WHEN ie_tipo_item_p='C' THEN 'S'  ELSE 'N' END  END ,
							CASE WHEN ie_tipo_item_p='G' THEN nm_usuario_p WHEN ie_tipo_item_p='C' THEN nm_usuario_p  ELSE null END ,
							CASE WHEN ie_liberado_w='N' THEN  null  ELSE clock_timestamp() END ,
							nr_seq_hor_glic_w,
							(obter_etapa_atual_proc(nr_prescricao_p, nr_seq_item_p) +1)
							);
						if (coalesce(wheb_usuario_pck.get_ie_commit, 'S') = 'S') then commit; end if;
							
						if (ie_aprazar_mat_proc_w = 'S') and (coalesce(ie_chamada_glicemia_p,'N') <> 'S') then
							CALL aprazar_itens_dependentes(cd_estabelecimento_w, cd_setor_prescr_w, nr_atendimento_p, nr_prescricao_w, nr_seq_item_w, 9999, dt_horario_w, ie_gerar_necessidade_disp_w, nm_usuario_p, null, nr_seq_hor_glic_w, nr_seq_pergunta_p, null, '');
						end if;
							
							if (coalesce(nr_seq_classif_param_w ,0) > 0)	then
								begin
								update	prescr_mat_hor
								set	nr_seq_classif		= nr_seq_classif_param_w
								where	nr_prescricao		= nr_prescricao_w	
								and	nr_sequencia		= nr_seq_horario_w;
								end;
							else
								if (ie_grava_log_rastr_w = 'S') then
									CALL adep_gerar_log_rastr(substr('APRAZAR_ITEM_PRESCR C11 LINE 4519 PARAMETERS' || chr(10) ||
										'{'||chr(10)||
										'"cd_estabelecimento_w" : "'||cd_estabelecimento_w||'"}',1,1500));
								end if;
								open C11;
								loop
								fetch C11 into	
									nr_seq_classif_w,
									ie_classif_urgente_w,
									ie_controlado_w,
									ie_padronizado_w;
								EXIT WHEN NOT FOUND; /* apply on C11 */
									begin
									if (ie_controlado_w = 'A') and (ie_padronizado_w = 'A') then
										update	prescr_mat_hor
										set	nr_seq_classif		= nr_seq_classif_w
										where	nr_prescricao		= nr_prescricao_w	
										and	nr_sequencia		= nr_seq_horario_w
										--and	nr_seq_lote		is not null
										and	ie_classif_urgente	= ie_classif_urgente_w;
									elsif (ie_controlado_w = 'A') and (ie_padronizado_w = 'S') then
										update	prescr_mat_hor
										set	nr_seq_classif		= nr_seq_classif_w
										where	nr_prescricao		= nr_prescricao_w
										and	ie_padronizado		= 'S'
										and	nr_sequencia		= nr_seq_horario_w
										--and	nr_seq_lote		is not null
										and	ie_classif_urgente	= ie_classif_urgente_w;
									elsif (ie_controlado_w = 'A') and (ie_padronizado_w = 'N') then
										update	prescr_mat_hor
										set	nr_seq_classif		= nr_seq_classif_w
										where	nr_prescricao		= nr_prescricao_w
										and	ie_padronizado		= 'N'
										and	nr_sequencia		= nr_seq_horario_w
										--and	nr_seq_lote		is not null
										and	ie_classif_urgente	= ie_classif_urgente_w;
									elsif (ie_controlado_w = 'N') and (ie_padronizado_w = 'A') then
										update	prescr_mat_hor
										set	nr_seq_classif		= nr_seq_classif_w
										where	nr_prescricao		= nr_prescricao_w
										and	ie_controlado		= 'N'
										and	nr_sequencia		= nr_seq_horario_w
										--and	nr_seq_lote		is not null
										and	ie_classif_urgente	= ie_classif_urgente_w;
									elsif (ie_controlado_w = 'N') and (ie_padronizado_w = 'N') then
										update	prescr_mat_hor
										set	nr_seq_classif		= nr_seq_classif_w
										where	nr_prescricao		= nr_prescricao_w
										and	ie_controlado		= 'N'
										and	ie_padronizado		= 'N'
										and	nr_sequencia		= nr_seq_horario_w
										--and	nr_seq_lote		is not null
										and	ie_classif_urgente	= ie_classif_urgente_w;
									elsif (ie_controlado_w = 'N') and (ie_padronizado_w = 'S') then
										update	prescr_mat_hor
										set	nr_seq_classif		= nr_seq_classif_w
										where	nr_prescricao		= nr_prescricao_w
										and	ie_controlado		= 'N'
										and	ie_padronizado		= 'S'
										--and	nr_seq_lote		is not null
										and	nr_sequencia		= nr_seq_horario_w
										and	ie_classif_urgente	= ie_classif_urgente_w;
									elsif (ie_controlado_w = 'S') and (ie_padronizado_w = 'A') then
										update	prescr_mat_hor
										set	nr_seq_classif		= nr_seq_classif_w
										where	nr_prescricao		= nr_prescricao_w
										and	ie_controlado		= 'S'
										--and	nr_seq_lote		is not null
										and	nr_sequencia		= nr_seq_horario_w
										and	ie_classif_urgente	= ie_classif_urgente_w;
									elsif (ie_controlado_w = 'S') and (ie_padronizado_w = 'N') then
										update	prescr_mat_hor
										set	nr_seq_classif		= nr_seq_classif_w
										where	nr_prescricao		= nr_prescricao_w
										and	ie_controlado		= 'S'
										and	ie_padronizado		= 'N'
										--and	nr_seq_lote		is not null
										and	nr_sequencia		= nr_seq_horario_w
										and	ie_classif_urgente	= ie_classif_urgente_w;
									elsif (ie_controlado_w = 'S') and (ie_padronizado_w = 'S') then
										update	prescr_mat_hor
										set	nr_seq_classif		= nr_seq_classif_w
										where	nr_prescricao		= nr_prescricao_w
										and	ie_controlado		= 'S'
										and	ie_padronizado		= 'S'
										--and	nr_seq_lote		is not null
										and	nr_sequencia		= nr_seq_horario_w
										and	ie_classif_urgente	= ie_classif_urgente_w;
									end if;
								
									end;
								end loop;
								close C11;
							end if;
								
							/* gerar evento aprazamento */

													
							if (nr_prescr_atual_w <> nr_prescricao_w) and (coalesce(nr_seq_horario_w,0) > 0) and (coalesce(ie_gerar_evento_p,'S') <> 'N') then
								CALL adep_gerar_area_prep(nr_prescricao_w, null, nm_usuario_p);				
								ie_entrou_cond_w := 'S'; --Gerar_Lote_Atend_Prescricao(nr_prescricao_w, nr_seq_item_w, nr_seq_horario_w, 'S', nm_usuario_p, 'AIP');
								CALL gerar_evento_reaprazamento(nr_atendimento_p, nr_prescricao_w, nr_seq_item_w, nr_seq_horario_w, cd_item_p, ie_tipo_item_p, ie_alteracao_w, nr_seq_motivo_p, ds_justificativa_p, nm_usuario_p, nr_seq_proc_interno_p,ie_acm_sn_w,nr_seq_assinatura_p);
								CALL gerar_acm_sn_apraz_prescricao(nr_prescricao_w, nr_seq_item_w,cd_local_estoque_w,nm_usuario_p);	
								
								if ((ie_gerar_lote_apraza_w = 'S') and (ie_tipo_item_p <> 'HM') and (obter_funcao_ativa = 88) and (ie_gerar_proc_gedipa_job_w = 'N')) then
									select	obter_se_setor_processo_gedipa(obter_unidade_atendimento(nr_atendimento_p,'IAA','CS'))
									into STRICT	ie_gedipa_w
									;

									SELECT * FROM Gerar_Processo_ADEP(nr_atendimento_p, dt_horario_w, nm_usuario_p, nr_seq_processo_w, 'N', 1113, 'GPA', ie_gedipa_w, 'N', nr_seq_processo_agora_w, null, null, 'N', nr_seq_processo_nut_w) INTO STRICT nr_seq_processo_w, nr_seq_processo_agora_w, nr_seq_processo_nut_w;
								end if;
								
								if	(ie_gerar_processo_w = 'S' AND ie_tipo_item_p = 'HM') then
																		
									nr_etapa_item_w	:=	obter_etapas_adep_sol(3, nr_prescricao_w, nr_seq_item_w);
									
									if (nr_etapa_item_w = 0) then
										nr_etapa_item_w	:= 1;
									end if;
											
									nr_seq_processo_w := gerar_processo_adep_sol(nr_atendimento_p, nr_prescricao_w, null, nr_etapa_item_w, trunc(dt_horario_w,'mi'), nm_usuario_p, nr_seq_processo_w, null, obter_funcao_ativa, 'AIS', ie_setor_gedipa_w, null, nr_seq_item_w);
												
								end if;
								
							end if;
					end if;

					/* atualizar prescricao */

					nr_prescr_atual_w := nr_prescricao_w;							
					end;
				else
					ie_inconsistencia_w := 'H';
					if (coalesce(ds_inconsistentes_w::text, '') = '') then
						ds_inconsistentes_w := to_char(nr_prescricao_w);
					elsif (position(nr_prescricao_w in ds_inconsistentes_w) = 0) then
						ds_inconsistentes_w := ds_inconsistentes_w || ', ' || to_char(nr_prescricao_w);
					end if;
				end if;
				end;
			elsif (ie_aprazar_interv_p = 'S') then
				CALL aprazar_item_prescr_interv(ie_tipo_item_p, nr_prescricao_w, nr_seq_item_w, dt_horario_p, nr_seq_motivo_p, ds_justificativa_p, nm_usuario_p, nr_seq_assinatura_p);
			end if;
			end;
		end loop;
		close C05;
		
		--Gerar lote do cursor acima
		if (ie_entrou_cond_w = 'S') then
			CALL Gerar_Lote_Atend_Prescricao(nr_prescricao_w, 0, 0, 'S', nm_usuario_p, 'AIP');			
			ie_entrou_cond_w := 'N';
		end if;

		if (ie_grava_log_rastr_w = 'S') then
			CALL adep_gerar_log_rastr(substr('APRAZAR_ITEM_PRESCR C06 PARAMETERS' || chr(10) ||
				'{'||chr(10)||
				'"cd_intervalo_p" : "'||cd_intervalo_p||'",'||chr(10)||
				'"cd_item_p" : "'||cd_item_p||'",'||chr(10)||
				'"cd_setor_pac_w" : "'||cd_setor_pac_w||'",'||chr(10)||
				'"dt_horario_w" : "'||to_char(dt_horario_w, 'dd/mm/yyyy hh24:mi:ss')||'",'||chr(10)||
				'"dt_validade_w" : "'||to_char(dt_validade_w, 'dd/mm/yyyy hh24:mi:ss')||'",'||chr(10)||
				'"ie_aprazar_suspensos_w" : "'||ie_aprazar_suspensos_w||'",'||chr(10)||
				'"ie_data_lib_prescr_w" : "'||ie_data_lib_prescr_w||'",'||chr(10)||
				'"ie_tipo_item_p" : "'||ie_tipo_item_p||'",'||chr(10)||
				'"nr_atendimento_p" : "'||nr_atendimento_p||'",'||chr(10)||
				'"qt_item_p" : "'||qt_item_p||'"}',1,1500));
		end if;

		open C06;
		loop
		fetch C06 into	
			nr_prescricao_w,
			nr_seq_item_w,		
			ie_sn_w,
			ie_acm_w;
		EXIT WHEN NOT FOUND; /* apply on C06 */
			begin
			ie_cursor_w := 'S';
			
			select	max(dt_liberacao),
				max(cd_estabelecimento),
				max(cd_setor_atendimento)
			into STRICT	dt_liberacao_w,
				cd_estabelecimento_w,
				cd_setor_prescr_w
			from	prescr_medica
			where	nr_prescricao = nr_prescricao_w;

			select	coalesce(max(qt_min_agora),0),
				coalesce(max(qt_min_especial),0),
				max(ie_classif_urgencia),
				coalesce(max(ie_forma_agora), 'N'),
				coalesce(max(ie_gera_disp_acm_sn),'S')
			into STRICT	qt_min_agora_w,
				qt_min_especial_w,
				ie_classif_nao_padrao_w,
				ie_agora_impressao_w,
				ie_gera_disp_acm_sn_w
			from	parametros_farmacia
			where	cd_estabelecimento = cd_estabelecimento_w;
			
			dt_limite_agora_w	:= dt_liberacao_w + qt_min_agora_w/1440;
			dt_limite_especial_w	:= dt_liberacao_w + qt_min_especial_w/1440;
			
			if ( 1 = 1)	then
				dt_hora_atual_w := clock_timestamp();
				dt_limite_agora_w	:=  dt_hora_atual_w + qt_min_agora_w/1440; 			
			end if;

			if (ie_sn_w = 'S') or (ie_acm_w = 'S') then			
				ie_acm_sn_w := 'S';
			else
				ie_acm_sn_w := 'N';
			end if;	
			
			if (ie_aprazar_interv_p = 'N') then
				begin
				ie_aprazar_w := 'S';
				if (ie_aprazar_w = 'S') then
					begin
						/* obter informacoes horario original */

						select	coalesce(min(nr_sequencia),0)
						into STRICT	nr_seq_orig_w
						from	prescr_rec_hor
						where	nr_prescricao = nr_prescricao_w
						and	nr_seq_recomendacao = nr_seq_item_w
						and	coalesce(ie_situacao,'A') = 'A'
						and	Obter_se_horario_liberado(dt_lib_horario, dt_horario) = 'S';
					
						if (nr_seq_orig_w > 0) then
							select	nr_seq_classificacao
							into STRICT	nr_seq_classif_w
							from	prescr_rec_hor
							where	nr_sequencia = nr_seq_orig_w
							and	Obter_se_horario_liberado(dt_lib_horario, dt_horario) = 'S';
						end if;
						
						ie_liberado_w := 'N';
						
						select	coalesce(max('S'),'N')
						into STRICT	ie_liberado_w
						from	prescr_rec_hor	
						where	nr_prescricao = nr_prescricao_w
						and	(dt_lib_horario IS NOT NULL AND dt_lib_horario::text <> '');
						
						select	count(*)
						into STRICT	qt_item_w
						from	prescr_rec_hor c,
                                prescr_recomendacao b
						where	c.nr_prescricao     in (nr_prescr_ww, nr_prescr_www)
                        and     c.nr_prescricao		in (nr_prescr_ww, nr_prescr_www)
						and	c.dt_horario		= dt_horario_w
						and coalesce(to_char(b.cd_recomendacao),b.ds_recomendacao) = cd_item_p
						and	(c.dt_lib_horario IS NOT NULL AND c.dt_lib_horario::text <> '')
						and	coalesce(c.ie_horario_especial,'N') <> 'S';
					
						ie_gerar_lote_w	:= 'S';
						if (qt_item_w = 0) then	
							select	nextval('prescr_rec_hor_seq')
							into STRICT	nr_seq_horario_w
							;
							
							if (ie_gera_disp_acm_sn_w = 'N' AND ie_acm_sn_w = 'S') then
								ie_gerar_lote_w := 'S';
								update	prescr_material
								set		ie_gerar_lote 	= 'S'
								where	nr_prescricao	= nr_prescricao_w
								and	nr_sequencia	= nr_seq_item_w;
							end if;

							insert into prescr_rec_hor(
								nr_sequencia,
								dt_atualizacao,
								nm_usuario,
								dt_atualizacao_nrec,
								nm_usuario_nrec,
								nr_prescricao,
								nr_seq_recomendacao,
								cd_recomendacao,
								dt_fim_horario,
								dt_suspensao,
								ds_horario,
								dt_horario,
								nr_seq_classificacao,
								ie_horario_especial,
								ie_aprazado,
								dt_lib_horario
								)
							values (
								nr_seq_horario_w,
								clock_timestamp(),
								nm_usuario_p,
								clock_timestamp(),
								nm_usuario_p,
								nr_prescricao_w,
								nr_seq_item_w,
								cd_item_p,
								null,
								null,
								--to_char(dt_horario_p,'hh24:mi'),
								--dt_horario_p,
								to_char(dt_horario_w,'hh24:mi'),
								dt_horario_w,
								nr_seq_classif_w,
								'N',
								'S',
								CASE WHEN ie_liberado_w='N' THEN  null  ELSE clock_timestamp() END
							);

							CALL aprazar_itens_dependentes(cd_estabelecimento_w, cd_setor_prescr_w, nr_atendimento_p, nr_prescricao_w, nr_seq_item_w, 2222, dt_horario_w, ie_gerar_necessidade_disp_w, nm_usuario_p, null, nr_seq_hor_glic_w, null, null, '');

							if (coalesce(nr_seq_classif_param_w ,0) > 0)	then
								begin
								update	prescr_mat_hor
								set	nr_seq_classif		= nr_seq_classif_param_w
								where	nr_prescricao		= nr_prescricao_w	
								and	nr_sequencia		= nr_seq_horario_w;
								end;
							else
								if (ie_grava_log_rastr_w = 'S') then
									CALL adep_gerar_log_rastr(substr('APRAZAR_ITEM_PRESCR C11 LINE 4831 PARAMETERS' || chr(10) ||
										'{'||chr(10)||
										'"cd_estabelecimento_w" : "'||cd_estabelecimento_w||'"}',1,1500));
								end if;
								open C11;
								loop
								fetch C11 into	
									nr_seq_classif_w,
									ie_classif_urgente_w,
									ie_controlado_w,
									ie_padronizado_w;
								EXIT WHEN NOT FOUND; /* apply on C11 */
									begin
									if (ie_controlado_w = 'A') and (ie_padronizado_w = 'A') then
										update	prescr_mat_hor
										set	nr_seq_classif		= nr_seq_classif_w
										where	nr_prescricao		= nr_prescricao_w	
										and	nr_sequencia		= nr_seq_horario_w
										--and	nr_seq_lote		is not null
										and	ie_classif_urgente	= ie_classif_urgente_w;
									elsif (ie_controlado_w = 'A') and (ie_padronizado_w = 'S') then
										update	prescr_mat_hor
										set	nr_seq_classif		= nr_seq_classif_w
										where	nr_prescricao		= nr_prescricao_w
										and	ie_padronizado		= 'S'
										and	nr_sequencia		= nr_seq_horario_w
										--and	nr_seq_lote		is not null
										and	ie_classif_urgente	= ie_classif_urgente_w;
									elsif (ie_controlado_w = 'A') and (ie_padronizado_w = 'N') then
										update	prescr_mat_hor
										set	nr_seq_classif		= nr_seq_classif_w
										where	nr_prescricao		= nr_prescricao_w
										and	ie_padronizado		= 'N'
										and	nr_sequencia		= nr_seq_horario_w
										--and	nr_seq_lote		is not null
										and	ie_classif_urgente	= ie_classif_urgente_w;
									elsif (ie_controlado_w = 'N') and (ie_padronizado_w = 'A') then
										update	prescr_mat_hor
										set	nr_seq_classif		= nr_seq_classif_w
										where	nr_prescricao		= nr_prescricao_w
										and	ie_controlado		= 'N'
										and	nr_sequencia		= nr_seq_horario_w
										--and	nr_seq_lote		is not null
										and	ie_classif_urgente	= ie_classif_urgente_w;
									elsif (ie_controlado_w = 'N') and (ie_padronizado_w = 'N') then
										update	prescr_mat_hor
										set	nr_seq_classif		= nr_seq_classif_w
										where	nr_prescricao		= nr_prescricao_w
										and	ie_controlado		= 'N'
										and	ie_padronizado		= 'N'
										and	nr_sequencia		= nr_seq_horario_w
										--and	nr_seq_lote		is not null
										and	ie_classif_urgente	= ie_classif_urgente_w;
									elsif (ie_controlado_w = 'N') and (ie_padronizado_w = 'S') then
										update	prescr_mat_hor
										set	nr_seq_classif		= nr_seq_classif_w
										where	nr_prescricao		= nr_prescricao_w
										and	ie_controlado		= 'N'
										and	ie_padronizado		= 'S'
										--and	nr_seq_lote		is not null
										and	nr_sequencia		= nr_seq_horario_w
										and	ie_classif_urgente	= ie_classif_urgente_w;
									elsif (ie_controlado_w = 'S') and (ie_padronizado_w = 'A') then
										update	prescr_mat_hor
										set	nr_seq_classif		= nr_seq_classif_w
										where	nr_prescricao		= nr_prescricao_w
										and	ie_controlado		= 'S'
										--and	nr_seq_lote		is not null
										and	nr_sequencia		= nr_seq_horario_w
										and	ie_classif_urgente	= ie_classif_urgente_w;
									elsif (ie_controlado_w = 'S') and (ie_padronizado_w = 'N') then
										update	prescr_mat_hor
										set	nr_seq_classif		= nr_seq_classif_w
										where	nr_prescricao		= nr_prescricao_w
										and	ie_controlado		= 'S'
										and	ie_padronizado		= 'N'
										--and	nr_seq_lote		is not null
										and	nr_sequencia		= nr_seq_horario_w
										and	ie_classif_urgente	= ie_classif_urgente_w;
									elsif (ie_controlado_w = 'S') and (ie_padronizado_w = 'S') then
										update	prescr_mat_hor
										set	nr_seq_classif		= nr_seq_classif_w
										where	nr_prescricao		= nr_prescricao_w
										and	ie_controlado		= 'S'
										and	ie_padronizado		= 'S'
										--and	nr_seq_lote		is not null
										and	nr_sequencia		= nr_seq_horario_w
										and	ie_classif_urgente	= ie_classif_urgente_w;
									end if;
								
									end;
								end loop;
								close C11;
							end if;
							
							/* gerar evento aprazamento */

							if (nr_prescr_atual_w <> nr_prescricao_w) and (coalesce(nr_seq_horario_w,0) > 0) and (coalesce(ie_gerar_evento_p,'S') <> 'N') then							
								CALL adep_gerar_area_prep(nr_prescricao_w, null, nm_usuario_p);
								--Gerar_Lote_Atend_Prescricao(nr_prescricao_w, nr_seq_item_w, nr_seq_horario_w, 'S', nm_usuario_p, 'AIP');
								CALL Gerar_Lote_Atend_Prescricao(nr_prescricao_w, 0, 0, 'S', nm_usuario_p, 'AIP');										
								CALL gerar_evento_reaprazamento(nr_atendimento_p, nr_prescricao_w, nr_seq_item_w, nr_seq_horario_w, cd_item_p, ie_tipo_item_p, ie_alteracao_w, nr_seq_motivo_p, ds_justificativa_p, nm_usuario_p, nr_seq_proc_interno_p,ie_acm_sn_w,nr_seq_assinatura_p);


								CALL gerar_acm_sn_apraz_prescricao(nr_prescricao_w, nr_seq_item_w,cd_local_estoque_w,nm_usuario_p);	
							end if;
						end if;

						/* atualizar prescricao */

						nr_prescr_atual_w := nr_prescricao_w;							
						end;
					else
						ie_inconsistencia_w := 'H';
						if (coalesce(ds_inconsistentes_w::text, '') = '') then
							ds_inconsistentes_w := to_char(nr_prescricao_w);
						elsif (position(nr_prescricao_w in ds_inconsistentes_w) = 0) then
							ds_inconsistentes_w := ds_inconsistentes_w || ', ' || to_char(nr_prescricao_w);
						end if;				
					
				end if;
				end;
			elsif (ie_aprazar_interv_p = 'S') then
				CALL aprazar_item_prescr_interv(ie_tipo_item_p, nr_prescricao_w, nr_seq_item_w, dt_horario_p, nr_seq_motivo_p, ds_justificativa_p, nm_usuario_p, nr_seq_assinatura_p);
			end if;		
			end;
		end loop;
		close C06;

		if (ie_grava_log_rastr_w = 'S') then
			CALL adep_gerar_log_rastr(substr('APRAZAR_ITEM_PRESCR C07 PARAMETERS' || chr(10) ||
				'{'||chr(10)||
				'"cd_intervalo_p" : "'||cd_intervalo_p||'",'||chr(10)||
				'"cd_item_p" : "'||cd_item_p||'",'||chr(10)||
				'"dt_horario_w" : "'||to_char(dt_horario_w, 'dd/mm/yyyy hh24:mi:ss')||'",'||chr(10)||
				'"dt_validade_w" : "'||to_char(dt_validade_w, 'dd/mm/yyyy hh24:mi:ss')||'",'||chr(10)||
				'"ie_aprazar_suspensos_w" : "'||ie_aprazar_suspensos_w||'",'||chr(10)||
				'"vetor_w(x).nr_prescricao_w" : "'||vetor_w[x].nr_prescricao_w||'",'||chr(10)||
				'"ie_tipo_item_p" : "'||ie_tipo_item_p||'",'||chr(10)||
				'"nr_atendimento_p" : "'||nr_atendimento_p||'",'||chr(10)||
				'"nr_prescricao_p" : "'||nr_prescricao_p||'",'||chr(10)||
				'"nr_prescricoes_p" : "'||nr_prescricoes_p||'",'||chr(10)||
				'"nr_seq_item_p" : "'||nr_seq_item_p||'"}',1,1500));
		end if;

		open C07;
		loop
		fetch C07 into	
			nr_prescricao_w,
			nr_seq_item_w,		
			nr_prescricao_ww,
			ie_sn_w,
			ie_acm_w;
		EXIT WHEN NOT FOUND; /* apply on C07 */
			begin
			ie_cursor_w := 'S';
			
			select	max(dt_liberacao),
				max(cd_estabelecimento),
				max(cd_setor_atendimento),
				max(cd_estabelecimento)
			into STRICT	dt_liberacao_w,
				cd_estabelecimento_w,
				cd_setor_prescr_w,
				cd_estab_prescr_w
			from	prescr_medica
			where	nr_prescricao = nr_prescricao_w;
						
			select	coalesce(max(qt_min_agora),0),
				coalesce(max(qt_min_especial),0),
				max(ie_classif_urgencia),
				coalesce(max(ie_forma_agora), 'N'),
				coalesce(max(ie_gera_disp_acm_sn),'S')
			into STRICT	qt_min_agora_w,
				qt_min_especial_w,
				ie_classif_nao_padrao_w,
				ie_agora_impressao_w,
				ie_gera_disp_acm_sn_w
			from	parametros_farmacia
			where	cd_estabelecimento = cd_estabelecimento_w;
			
			dt_limite_agora_w	:= dt_liberacao_w + qt_min_agora_w/1440;
			dt_limite_especial_w	:= dt_liberacao_w + qt_min_especial_w/1440;
			
			if (coalesce(ie_gerar_classif_agora_w,'N') = 'S') then
				dt_hora_atual_w := clock_timestamp();
				dt_limite_agora_w	:=  dt_hora_atual_w + qt_min_agora_w/1440; 			
			end if;

			if (ie_sn_w = 'S') or (ie_acm_w = 'S') then			
				ie_acm_sn_w := 'S';
			else
				ie_acm_sn_w := 'N';
			end if;	
			
			if (ie_aprazar_interv_p = 'N') then
				begin
				ie_aprazar_w := 'S';
				if (ie_aprazar_w = 'S') then
					begin					
					select	nextval('pe_prescr_proc_hor_seq')
					into STRICT	nr_seq_horario_w
					;
					
					insert into pe_prescr_proc_hor(
						nr_sequencia,
						dt_atualizacao_nrec,
						nm_usuario_nrec,
						dt_atualizacao,
						nm_usuario,
						nr_seq_pe_prescr,
						nr_seq_pe_proc,
						nr_seq_proc,
						dt_horario,
						dt_fim_horario,
						dt_suspensao,
						ie_horario_especial,
						nm_usuario_reaprazamento,
						qt_hor_reaprazamento,
						ie_aprazado
						)
					values (
						nr_seq_horario_w,
						clock_timestamp(),
						nm_usuario_p,
						clock_timestamp(),
						nm_usuario_p,
						nr_prescricao_ww,
						nr_seq_item_w,
						cd_item_p,
						--dt_horario_p,
						dt_horario_w,
						null,
						null,
						'N',
						null,
						null,
						'S'
						);
						
						CALL aprazar_itens_dependentes(cd_estab_prescr_w, cd_setor_prescr_w, nr_atendimento_p, nr_prescricao_w, nr_seq_item_w, 1111, dt_horario_w, ie_gerar_necessidade_disp_w, nm_usuario_p, null, nr_seq_hor_glic_w, null, null, '');
					
						if (coalesce(nr_seq_classif_param_w ,0) > 0)	then
							begin
							update	prescr_mat_hor
							set	nr_seq_classif		= nr_seq_classif_param_w
							where	nr_prescricao		= nr_prescricao_w	
							and	nr_sequencia		= nr_seq_horario_w;
							end;
						else
							if (ie_grava_log_rastr_w = 'S') then
								CALL adep_gerar_log_rastr(substr('APRAZAR_ITEM_PRESCR C11 LINE 5091 PARAMETERS' || chr(10) ||
									'{'||chr(10)||
									'"cd_estabelecimento_w" : "'||cd_estabelecimento_w||'"}',1,1500));
							end if;
							open C11;
							loop
							fetch C11 into	
								nr_seq_classif_w,
								ie_classif_urgente_w,
								ie_controlado_w,
								ie_padronizado_w;
							EXIT WHEN NOT FOUND; /* apply on C11 */
								begin
								if (ie_controlado_w = 'A') and (ie_padronizado_w = 'A') then
									update	prescr_mat_hor
									set	nr_seq_classif		= nr_seq_classif_w
									where	nr_prescricao		= nr_prescricao_w	
									and	nr_sequencia		= nr_seq_horario_w
									--and	nr_seq_lote		is not null
									and	ie_classif_urgente	= ie_classif_urgente_w;
								elsif (ie_controlado_w = 'A') and (ie_padronizado_w = 'S') then
									update	prescr_mat_hor
									set	nr_seq_classif		= nr_seq_classif_w
									where	nr_prescricao		= nr_prescricao_w
									and	ie_padronizado		= 'S'
									and	nr_sequencia		= nr_seq_horario_w
									--and	nr_seq_lote		is not null
									and	ie_classif_urgente	= ie_classif_urgente_w;
								elsif (ie_controlado_w = 'A') and (ie_padronizado_w = 'N') then
									update	prescr_mat_hor
									set	nr_seq_classif		= nr_seq_classif_w
									where	nr_prescricao		= nr_prescricao_w
									and	ie_padronizado		= 'N'
									and	nr_sequencia		= nr_seq_horario_w
									--and	nr_seq_lote		is not null
									and	ie_classif_urgente	= ie_classif_urgente_w;
								elsif (ie_controlado_w = 'N') and (ie_padronizado_w = 'A') then
									update	prescr_mat_hor
									set	nr_seq_classif		= nr_seq_classif_w
									where	nr_prescricao		= nr_prescricao_w
									and	ie_controlado		= 'N'
									and	nr_sequencia		= nr_seq_horario_w
									--and	nr_seq_lote		is not null
									and	ie_classif_urgente	= ie_classif_urgente_w;
								elsif (ie_controlado_w = 'N') and (ie_padronizado_w = 'N') then
									update	prescr_mat_hor
									set	nr_seq_classif		= nr_seq_classif_w
									where	nr_prescricao		= nr_prescricao_w
									and	ie_controlado		= 'N'
									and	ie_padronizado		= 'N'
									and	nr_sequencia		= nr_seq_horario_w
									--and	nr_seq_lote		is not null
									and	ie_classif_urgente	= ie_classif_urgente_w;
								elsif (ie_controlado_w = 'N') and (ie_padronizado_w = 'S') then
									update	prescr_mat_hor
									set	nr_seq_classif		= nr_seq_classif_w
									where	nr_prescricao		= nr_prescricao_w
									and	ie_controlado		= 'N'
									and	ie_padronizado		= 'S'
									--and	nr_seq_lote		is not null
									and	nr_sequencia		= nr_seq_horario_w
									and	ie_classif_urgente	= ie_classif_urgente_w;
								elsif (ie_controlado_w = 'S') and (ie_padronizado_w = 'A') then
									update	prescr_mat_hor
									set	nr_seq_classif		= nr_seq_classif_w
									where	nr_prescricao		= nr_prescricao_w
									and	ie_controlado		= 'S'
									--and	nr_seq_lote		is not null
									and	nr_sequencia		= nr_seq_horario_w
									and	ie_classif_urgente	= ie_classif_urgente_w;
								elsif (ie_controlado_w = 'S') and (ie_padronizado_w = 'N') then
									update	prescr_mat_hor
									set	nr_seq_classif		= nr_seq_classif_w
									where	nr_prescricao		= nr_prescricao_w
									and	ie_controlado		= 'S'
									and	ie_padronizado		= 'N'
									--and	nr_seq_lote		is not null
									and	nr_sequencia		= nr_seq_horario_w
									and	ie_classif_urgente	= ie_classif_urgente_w;
								elsif (ie_controlado_w = 'S') and (ie_padronizado_w = 'S') then
									update	prescr_mat_hor
									set	nr_seq_classif		= nr_seq_classif_w
									where	nr_prescricao		= nr_prescricao_w
									and	ie_controlado		= 'S'
									and	ie_padronizado		= 'S'
									--and	nr_seq_lote		is not null
									and	nr_sequencia		= nr_seq_horario_w
									and	ie_classif_urgente	= ie_classif_urgente_w;
								end if;
							
								end;
							end loop;
							close C11;
						end if;

						if (ie_grava_log_rastr_w = 'S') then
							CALL adep_gerar_log_rastr(substr('APRAZAR_ITEM_PRESCR C16 PARAMETERS' || chr(10) ||
								'{'||chr(10)||
								'"vetor_w(x).nr_prescricao_w" : "'||vetor_w[x].nr_prescricao_w||'",'||chr(10)||
								'"nr_atendimento_p" : "'||nr_atendimento_p||'"}',1,1500));
						end if;

						--Gerar Lote itens associados a SAE ao aprazar a mesma
						open C16;
						loop
						fetch C16 into
							nr_prescricao_w,
							nr_seq_item_ww,
							nr_seq_hor_w;
						EXIT WHEN NOT FOUND; /* apply on C16 */
							begin							
							nr_prescricao_w	 := nr_prescricao_w;	
							nr_seq_item_ww	 := nr_seq_item_ww;
							nr_seq_hor_w	 := nr_seq_hor_w;			
							ie_entrou_cond_w := 'S';
							end;
						end loop;
						close C16;
						
						if (nr_prescr_atual_w <> nr_prescricao_w) and (coalesce(nr_seq_horario_w,0) > 0) and (ie_entrou_cond_w = 'S')then
							CALL Gerar_Lote_Atend_Prescricao(nr_prescricao_w, 0, 0, 'S', nm_usuario_p, 'AIP');
						end if;
						
						/* gerar evento aprazamento */

						if (nr_prescr_atual_w <> nr_prescricao_ww) and (coalesce(nr_seq_horario_w,0) > 0) and (coalesce(ie_gerar_evento_p,'S') <> 'N') then
							CALL gerar_evento_reaprazamento(nr_atendimento_p, nr_prescricao_ww, nr_seq_item_w, nr_seq_horario_w, cd_item_p, ie_tipo_item_p, ie_alteracao_w, nr_seq_motivo_p, ds_justificativa_p, nm_usuario_p, nr_seq_proc_interno_p,ie_acm_sn_w,nr_seq_assinatura_p);
							CALL adep_gerar_area_prep(nr_prescricao_w, null, nm_usuario_p);
							CALL gerar_acm_sn_apraz_prescricao(nr_prescricao_w, nr_seq_item_w,cd_local_estoque_w,nm_usuario_p);	
						end if;

						/* atualizar prescricao */

						nr_prescr_atual_w := nr_prescricao_w;							
						end;
					else
						ie_inconsistencia_w := 'H';
						if (coalesce(ds_inconsistentes_w::text, '') = '') then
							ds_inconsistentes_w := to_char(nr_prescricao_w);
						elsif (position(nr_prescricao_w in ds_inconsistentes_w) = 0) then
							ds_inconsistentes_w := ds_inconsistentes_w || ', ' || to_char(nr_prescricao_w);
						end if;				
				end if;
				end;
			elsif (ie_aprazar_interv_p = 'S') then
				CALL aprazar_item_prescr_interv(ie_tipo_item_p, nr_prescricao_w, nr_seq_item_w, dt_horario_p, nr_seq_motivo_p, ds_justificativa_p, nm_usuario_p, nr_seq_assinatura_p);
			end if;		
			
			end;
		end loop;
		close C07;
		
		if (ie_grava_log_rastr_w = 'S') then
			CALL adep_gerar_log_rastr(substr('APRAZAR_ITEM_PRESCR C08 PARAMETERS' || chr(10) ||
				'{'||chr(10)||
				'"cd_intervalo_p" : "'||cd_intervalo_p||'",'||chr(10)||
				'"cd_item_p" : "'||cd_item_p||'",'||chr(10)||
				'"cd_setor_pac_w" : "'||cd_setor_pac_w||'",'||chr(10)||
				'"dt_horario_w" : "'||to_char(dt_horario_w, 'dd/mm/yyyy hh24:mi:ss')||'",'||chr(10)||
				'"dt_validade_w" : "'||to_char(dt_validade_w, 'dd/mm/yyyy hh24:mi:ss')||'",'||chr(10)||
				'"ie_aprazar_suspensos_w" : "'||ie_aprazar_suspensos_w||'",'||chr(10)||
				'"vetor_w(x).nr_prescricao_w" : "'||vetor_w[x].nr_prescricao_w||'",'||chr(10)||
				'"ie_data_lib_prescr_w" : "'||ie_data_lib_prescr_w||'",'||chr(10)||
				'"ie_tipo_item_p" : "'||ie_tipo_item_p||'",'||chr(10)||
				'"ie_ver_check_adep_w" : "'||ie_ver_check_adep_w||'",'||chr(10)||
				'"nr_atendimento_p" : "'||nr_atendimento_p||'",'||chr(10)||
				'"qt_item_p" : "'||qt_item_p||'"}',1,1500));
		end if;
		
		open C08;
		loop
		fetch C08 into	
			nr_prescricao_w,
			nr_seq_item_w,
			cd_local_estoque_w,
			nr_agrupamento_w,
			cd_material_w,
			cd_unidade_medida_dose_w,	
			qt_dose_w,
			cd_unidade_medida_w,		
			ie_sn_w,
			ie_acm_w,
			ie_agrupador_w;
		EXIT WHEN NOT FOUND; /* apply on C08 */
			begin
			ie_cursor_w := 'S';
			
			select	max(dt_liberacao),
				max(cd_estabelecimento)
			into STRICT	dt_liberacao_w,
				cd_estabelecimento_w
			from	prescr_medica
			where	nr_prescricao = nr_prescricao_w;

			select	coalesce(max(qt_min_agora),0),
				coalesce(max(qt_min_especial),0),
				max(ie_classif_urgencia),
				coalesce(max(ie_forma_agora), 'N'),
				coalesce(max(ie_gera_disp_acm_sn),'S')
			into STRICT	qt_min_agora_w,
				qt_min_especial_w,
				ie_classif_nao_padrao_w,
				ie_agora_impressao_w,
				ie_gera_disp_acm_sn_w
			from	parametros_farmacia
			where	cd_estabelecimento = cd_estabelecimento_w;
			
			dt_limite_agora_w	:= dt_liberacao_w + qt_min_agora_w/1440;
			dt_limite_especial_w	:= dt_liberacao_w + qt_min_especial_w/1440;
			
			if (coalesce(ie_gerar_classif_agora_w,'N') = 'S') then
				dt_hora_atual_w := clock_timestamp();
				dt_limite_agora_w	:=  dt_hora_atual_w + qt_min_agora_w/1440; 			
			end if;
			
			if (ie_sn_w = 'S') or (ie_acm_w = 'S') then			
				ie_acm_sn_w := 'S';
			else
				ie_acm_sn_w := 'N';
			end if;	
			
			if (ie_aprazar_interv_p = 'N') then
				begin
				ie_aprazar_w := 'S';
				if (ie_aprazar_w = 'S') then
					begin
					select	cd_estabelecimento,
						cd_setor_atendimento,
						dt_inicio_prescr
					into STRICT	cd_estab_prescr_w,
						cd_setor_prescr_w,
						dt_inicio_prescr_w
					from	prescr_medica
					where	nr_prescricao = nr_prescricao_w;
					
					select	coalesce(min(nr_sequencia),0)
					into STRICT	nr_seq_orig_w
					from	prescr_mat_hor
					where	nr_prescricao = nr_prescricao_w
					and	nr_seq_material = nr_seq_item_w
					and	coalesce(ie_situacao,'A') = 'A';
										
					if (nr_seq_orig_w > 0) then
						select	qt_dose,
							qt_dispensar,
							qt_dispensar_hor,
							cd_unidade_medida,
							cd_unidade_medida_dose
						into STRICT	qt_dose_w,
							qt_dispensar_w,
							qt_dispensar_hor_w,
							cd_unidade_medida_w,
							cd_unidade_medida_dose_w
						from	prescr_mat_hor
						where	nr_sequencia = nr_seq_orig_w
						and	Obter_se_horario_liberado(dt_lib_horario, dt_horario) = 'S';
					else		
						cd_unid_med_dose_hor_w := null;
						qt_dose_hor_w	:= null;	
														
						SELECT * FROM obter_dose_um_horario_pmh(cd_material_w, qt_item_p, cd_unidade_medida_dose_w, qt_dose_hor_w, cd_unid_med_dose_hor_w) INTO STRICT qt_dose_hor_w, cd_unid_med_dose_hor_w;							
					end if;
									
					select	coalesce(max(substr(Obter_se_medic_controlado(cd_item_p),1,1)),'N'),
						coalesce(max(substr(obter_se_material_padronizado(cd_estabelecimento_w, cd_item_p),1,1)),'N')
					into STRICT	ie_controlado_w,
						ie_padronizado_w
					;
					
					/*	Fabio e JonasJonas - 19/01/2010 = Para gerar os lotes como AGORA dependendo do horario final do turno, e nao mais pelo minutos de agora*/

					if (ie_agora_impressao_w = 'S') then
						nr_seq_turno_hor_ag_w	:= obter_turno_horario_prescr(cd_estabelecimento_w,cd_setor_prescr_w,to_char(dt_horario_w,'hh24:mi'),cd_local_estoque_w);
						select	max(to_char(b.hr_inicial,'hh24:mi')),
							max(to_char(b.hr_final,'hh24:mi'))
						into STRICT	hr_turno_agora_w,
							hr_final_turno_agora_w
						from	regra_turno_disp_param b,
							regra_turno_disp a
						where	a.nr_sequencia		= b.nr_seq_turno
						and	a.cd_estabelecimento	= cd_estabelecimento_w
						and	a.nr_sequencia		= nr_seq_turno_hor_ag_w
						and (coalesce(b.cd_setor_atendimento,coalesce(cd_setor_prescr_w,0))	= coalesce(cd_setor_prescr_w,0));

						select	coalesce(max(qt_min_antes_atend), 0),
							coalesce(max(ie_define_agora), 'N')
						into STRICT	qt_min_antes_atend_w,
							ie_define_agora_w
						from	regra_tempo_disp
						where	cd_estabelecimento	= cd_estabelecimento_w
						and (coalesce(cd_setor_atendimento,coalesce(cd_setor_prescr_w,0)) = coalesce(cd_setor_prescr_w,0))
						and	nr_seq_turno = nr_seq_turno_hor_ag_w
						and	ie_situacao = 'A';

						if (hr_turno_agora_w > hr_final_turno_agora_w) then
							if (ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_horario_w) > ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_inicio_prescr_w)) then
								dt_limite_agora_w := PKG_DATE_UTILS.get_Time(dt_horario_w - 1, hr_turno_agora_w) - (qt_min_antes_atend_w/1440);
							else
								dt_limite_agora_w := PKG_DATE_UTILS.get_Time(dt_horario_w, hr_turno_agora_w) - (qt_min_antes_atend_w/1440);
							end if;
						else
							dt_limite_agora_w := PKG_DATE_UTILS.get_Time(dt_horario_w, hr_turno_agora_w) - (qt_min_antes_atend_w/1440);
						end if;
					end if;
					/*	Fabio e Jonas - 19/01/2010 = Final da alteracao*/

					
					if (coalesce(ie_classif_nao_padrao_w::text, '') = '') or (ie_padronizado_w = 'S') then
						begin
						ie_classif_urgente_w	:= 'N';
						if (dt_horario_w <= dt_limite_agora_w) then
							ie_classif_urgente_w	:= 'A';
						elsif	((dt_limite_agora_w <= clock_timestamp()) and (ie_agora_impressao_w = 'S') and (ie_define_agora_w = 'N')) then
							ie_classif_urgente_w	:= 'A';
						elsif (ie_agora_impressao_w = 'S' and ie_define_agora_w = 'S') and
							(dt_horario_w <= (clock_timestamp() + (qt_min_antes_atend_w /1440))) then
							ie_classif_urgente_w	:= 'A';
						elsif (dt_horario_w <= dt_limite_especial_w) then
							ie_classif_urgente_w	:= 'E';
						end if;
						end;
					else
						ie_classif_urgente_w	:= ie_classif_nao_padrao_w;
					end if;
									
					ie_liberado_w := 'N';
					
					
					if (ie_gera_disp_acm_sn_w = 'N' AND ie_acm_sn_w = 'S') then
						ie_gerar_lote_w := 'S';
						update	prescr_material
						set		ie_gerar_lote 	= 'S'
						where	nr_prescricao	= nr_prescricao_w
 						and	nr_sequencia	= nr_seq_item_w;
					end if;	
					
					select	coalesce(max('S'),'N')
					into STRICT	ie_liberado_w
					from	prescr_mat_hor	
					where	nr_prescricao = nr_prescricao_w
					and	(dt_lib_horario IS NOT NULL AND dt_lib_horario::text <> '');
					
					select	nextval('prescr_mat_hor_seq')
					into STRICT	nr_seq_horario_w
					;

					insert into prescr_mat_hor(
						nr_sequencia,
						nr_seq_digito,
						nr_prescricao,
						nr_seq_material,
						ie_agrupador,
						dt_atualizacao,
						nm_usuario,
						dt_atualizacao_nrec,
						nm_usuario_nrec,
						cd_material,
						qt_dose,
						qt_dispensar_hor,
						ds_horario,
						dt_horario,
						cd_unidade_medida,
						cd_unidade_medida_dose,
						ie_urgente,
						dt_emissao_farmacia,
						dt_fim_horario,
						dt_suspensao,
						ie_horario_especial,
						qt_hor_reaprazamento,
						nm_usuario_reaprazamento,
						nr_seq_turno,
						dt_disp_farmacia,
						ie_aprazado,
						ie_classif_urgente,
						ie_padronizado,
						ie_controlado,
						cd_unid_med_hor,
						qt_horario,
						ie_gerar_lote,
						dt_lib_horario,
						nr_atendimento
						)
					values (
						nr_seq_horario_w,
						calcula_digito('MODULO11',nr_seq_horario_w),
						nr_prescricao_w,
						nr_seq_item_w,
						--decode(ie_tipo_item_p,'M',1,12),
						ie_agrupador_w,
						clock_timestamp(),
						nm_usuario_p,
						clock_timestamp(),
						nm_usuario_p,
						cd_item_p,
						qt_dose_w,
						qt_dispensar_hor_w,
						to_char(dt_horario_w,'hh24:mi'),
						dt_horario_w,
						cd_unidade_medida_w,
						cd_unidade_medida_dose_w,
						'N',
						CASE WHEN ie_gerar_necessidade_disp_w='S' THEN null  ELSE clock_timestamp() END ,
						null,
						null,
						'N',
						null,
						null,
						obter_turno_horario_prescr(cd_estab_prescr_w,cd_setor_prescr_w,to_char(dt_horario_w,'hh24:mi'),cd_local_estoque_w),
						clock_timestamp(),
						'S',
						ie_classif_urgente_w,
						ie_padronizado_w,
						ie_controlado_w,
						coalesce(cd_unid_med_dose_hor_w, cd_unidade_medida_dose_w),
						qt_dose_w,
						coalesce(ie_gerar_lote_w,'S'),
						clock_timestamp(),
						nr_atendimento_p);
					
					CALL adep_gerar_area_prep(nr_prescricao_w, null, nm_usuario_p);
					if (ie_gerar_proc_gedipa_job_w	= 'N') then
						CALL Gedipa_Gerar_Proc_Instantaneo(nr_prescricao_w,nr_seq_item_w,null,nr_seq_horario_w);
					end if;					
					
					if (coalesce(nr_seq_classif_param_w ,0) > 0)	then
						begin
						update	prescr_mat_hor
						set	nr_seq_classif		= nr_seq_classif_param_w
						where	nr_prescricao		= nr_prescricao_w	
						and	nr_sequencia		= nr_seq_horario_w;
						end;
					else
						if (ie_grava_log_rastr_w = 'S') then
							CALL adep_gerar_log_rastr(substr('APRAZAR_ITEM_PRESCR C11 LINE 5535 PARAMETERS' || chr(10) ||
								'{'||chr(10)||
								'"cd_estabelecimento_w" : "'||cd_estabelecimento_w||'"}',1,1500));
						end if;

						open C11;
						loop
						fetch C11 into	
							nr_seq_classif_w,
							ie_classif_urgente_w,
							ie_controlado_w,
							ie_padronizado_w;
						EXIT WHEN NOT FOUND; /* apply on C11 */
							begin
							if (ie_controlado_w = 'A') and (ie_padronizado_w = 'A') then
								update	prescr_mat_hor
								set	nr_seq_classif		= nr_seq_classif_w
								where	nr_prescricao		= nr_prescricao_w	
								and	nr_sequencia		= nr_seq_horario_w
								--and	nr_seq_lote		is not null
								and	ie_classif_urgente	= ie_classif_urgente_w;
							elsif (ie_controlado_w = 'A') and (ie_padronizado_w = 'S') then
								update	prescr_mat_hor
								set	nr_seq_classif		= nr_seq_classif_w
								where	nr_prescricao		= nr_prescricao_w
								and	ie_padronizado		= 'S'
								and	nr_sequencia		= nr_seq_horario_w
								--and	nr_seq_lote		is not null
								and	ie_classif_urgente	= ie_classif_urgente_w;
							elsif (ie_controlado_w = 'A') and (ie_padronizado_w = 'N') then
								update	prescr_mat_hor
								set	nr_seq_classif		= nr_seq_classif_w
								where	nr_prescricao		= nr_prescricao_w
								and	ie_padronizado		= 'N'
								and	nr_sequencia		= nr_seq_horario_w
								--and	nr_seq_lote		is not null
								and	ie_classif_urgente	= ie_classif_urgente_w;
							elsif (ie_controlado_w = 'N') and (ie_padronizado_w = 'A') then
								update	prescr_mat_hor
								set	nr_seq_classif		= nr_seq_classif_w
								where	nr_prescricao		= nr_prescricao_w
								and	ie_controlado		= 'N'
								and	nr_sequencia		= nr_seq_horario_w
								--and	nr_seq_lote		is not null
								and	ie_classif_urgente	= ie_classif_urgente_w;
							elsif (ie_controlado_w = 'N') and (ie_padronizado_w = 'N') then
								update	prescr_mat_hor
								set	nr_seq_classif		= nr_seq_classif_w
								where	nr_prescricao		= nr_prescricao_w
								and	ie_controlado		= 'N'
								and	ie_padronizado		= 'N'
								and	nr_sequencia		= nr_seq_horario_w
								--and	nr_seq_lote		is not null
								and	ie_classif_urgente	= ie_classif_urgente_w;
							elsif (ie_controlado_w = 'N') and (ie_padronizado_w = 'S') then
								update	prescr_mat_hor
								set	nr_seq_classif		= nr_seq_classif_w
								where	nr_prescricao		= nr_prescricao_w
								and	ie_controlado		= 'N'
								and	ie_padronizado		= 'S'
								--and	nr_seq_lote		is not null
								and	nr_sequencia		= nr_seq_horario_w
								and	ie_classif_urgente	= ie_classif_urgente_w;
							elsif (ie_controlado_w = 'S') and (ie_padronizado_w = 'A') then
								update	prescr_mat_hor
								set	nr_seq_classif		= nr_seq_classif_w
								where	nr_prescricao		= nr_prescricao_w
								and	ie_controlado		= 'S'
								--and	nr_seq_lote		is not null
								and	nr_sequencia		= nr_seq_horario_w
								and	ie_classif_urgente	= ie_classif_urgente_w;
							elsif (ie_controlado_w = 'S') and (ie_padronizado_w = 'N') then
								update	prescr_mat_hor
								set	nr_seq_classif		= nr_seq_classif_w
								where	nr_prescricao		= nr_prescricao_w
								and	ie_controlado		= 'S'
								and	ie_padronizado		= 'N'
								--and	nr_seq_lote		is not null
								and	nr_sequencia		= nr_seq_horario_w
								and	ie_classif_urgente	= ie_classif_urgente_w;
							elsif (ie_controlado_w = 'S') and (ie_padronizado_w = 'S') then
								update	prescr_mat_hor
								set	nr_seq_classif		= nr_seq_classif_w
								where	nr_prescricao		= nr_prescricao_w
								and	ie_controlado		= 'S'
								and	ie_padronizado		= 'S'
								--and	nr_seq_lote		is not null
								and	nr_sequencia		= nr_seq_horario_w
								and	ie_classif_urgente	= ie_classif_urgente_w;
							end if;
						
							end;
						end loop;
						close C11;
					end if;		
					
					if (ie_gerar_necessidade_disp_w = 'S') then
						update	prescr_material
						set	cd_motivo_baixa	= 0,
							dt_baixa	 = NULL
						where	nr_prescricao	= nr_prescricao_w
						and	nr_sequencia	= nr_seq_item_w;
					end if;	
					/* gerar evento aprazamento */

					if (nr_prescr_atual_w <> nr_prescricao_w) and (coalesce(nr_seq_horario_w,0) > 0) and (coalesce(ie_gerar_evento_p,'S') <> 'N') then
						CALL gerar_evento_reaprazamento(nr_atendimento_p, nr_prescricao_w, nr_seq_item_w, nr_seq_horario_w, cd_item_p, ie_tipo_item_p, ie_alteracao_w, nr_seq_motivo_p, ds_justificativa_p, nm_usuario_p, nr_seq_proc_interno_p,ie_acm_sn_w,nr_seq_assinatura_p);
						--adep_gerar_area_prep(nr_prescricao_w, null, nm_usuario_p);
						CALL Gerar_Lote_Atend_Prescricao(nr_prescricao_w, nr_seq_item_w, nr_seq_horario_w, 'S', nm_usuario_p, 'AIP');
						CALL gerar_acm_sn_apraz_prescricao(nr_prescricao_w, nr_seq_item_w,cd_local_estoque_w,nm_usuario_p);	
					end if;

					/* atualizar prescricao */

					nr_prescr_atual_w := nr_prescricao_w;							
					end;
				else
					ie_inconsistencia_w := 'H';
					if (coalesce(ds_inconsistentes_w::text, '') = '') then
						ds_inconsistentes_w := to_char(nr_prescricao_w);
					elsif (position(nr_prescricao_w in ds_inconsistentes_w) = 0) then
						ds_inconsistentes_w := ds_inconsistentes_w || ', ' || to_char(nr_prescricao_w);
					end if;				
				end if;
				end;
			elsif (ie_aprazar_interv_p = 'S') then
				CALL aprazar_item_prescr_interv(ie_tipo_item_p, nr_prescricao_w, nr_seq_item_w, dt_horario_p, nr_seq_motivo_p, ds_justificativa_p, nm_usuario_p, nr_seq_assinatura_p);
			end if;	
			end;
		end loop;
		close C08;

		if (ie_grava_log_rastr_w = 'S') then
			CALL adep_gerar_log_rastr(substr('APRAZAR_ITEM_PRESCR C09 PARAMETERS' || chr(10) ||
				'{'||chr(10)||
				'"vetor_w(x).nr_prescricao_w" : "'||vetor_w[x].nr_prescricao_w||'",'||chr(10)||
				'"cd_intervalo_p" : "'||cd_intervalo_p||'",'||chr(10)||
				'"cd_item_p" : "'||cd_item_p||'",'||chr(10)||
				'"cd_setor_pac_w" : "'||cd_setor_pac_w||'",'||chr(10)||
				'"dt_horario_w" : "'||to_char(dt_horario_w, 'dd/mm/yyyy hh24:mi:ss')||'",'||chr(10)||
				'"dt_validade_w" : "'||to_char(dt_validade_w, 'dd/mm/yyyy hh24:mi:ss')||'",'||chr(10)||
				'"ie_acm_sn_p" : "'||ie_acm_sn_p||'",'||chr(10)||
				'"ie_aprazar_agrupados_w" : "'||ie_aprazar_agrupados_w||'",'||chr(10)||
				'"ie_tipo_item_p" : "'||ie_tipo_item_p||'",'||chr(10)||
				'"nr_atendimento_p" : "'||nr_atendimento_p||'",'||chr(10)||
				'"nr_prescr_w" : "'||nr_prescr_w||'",'||chr(10)||
				'"nr_prescr_ww" : "'||nr_prescr_w||'",'||chr(10)||
				'"nr_prescr_www" : "'||nr_prescr_w||'",'||chr(10)||
				'"nr_prescricao_p" : "'||nr_prescricao_p||'",'||chr(10)||
				'"nr_prescricoes_p" : "'||nr_prescricoes_p||'",'||chr(10)||
				'"nr_seq_item_p" : "'||nr_seq_item_p||'",'||chr(10)||
				'"nr_seq_prot_glic_p" : "'||nr_seq_prot_glic_p||'",'||chr(10)||
				'"ie_permite_antes_val_w" : "'||ie_permite_antes_val_w||'",'||chr(10)||
				'"nr_ultima_prescr_w" : "'||nr_ultima_prescr_w||'"}',1,1500));
		end if;

		open C09;
		loop
		fetch C09 into	
			nr_prescricao_w,
			nr_seq_item_w,
			cd_local_estoque_w,
			nr_agrupamento_w,
			cd_material_w,
			cd_unidade_medida_dose_w,	
			qt_dose_w,
			cd_unidade_medida_w,		
			ie_sn_w,
			ie_acm_w,
			cd_unid_med_consumo_w,
			ie_regra_disp_w,
			ie_kit_gerado_w;
		EXIT WHEN NOT FOUND; /* apply on C09 */
			begin
			ie_cursor_w := 'S';
				
			--Tratamento relizado para evitar que ocorra duplicidades 
			-- ao realizar a medicao do CCG no PDA.	
			ie_lancou_iag_w := 'N';			
			if	(nr_seq_hor_glic_w IS NOT NULL AND nr_seq_hor_glic_w::text <> '' AND ie_tipo_item_p = 'IAG') then
			
				select 	coalesce(max('S'), 'N')			
				into STRICT	ie_lancou_iag_w
				from	prescr_mat_hor
				where	nr_prescricao = nr_prescricao_w
				and		cd_material = cd_material_w
				and		nr_seq_hor_glic = nr_seq_hor_glic_w
				and		dt_horario = dt_horario_w
				and		coalesce(dt_suspensao::text, '') = '';
				
			end if;

			if (ie_lancou_iag_w = 'N') then
									
				select	max(dt_liberacao),
						max(cd_estabelecimento)
				into STRICT	dt_liberacao_w,
						cd_estabelecimento_w
				from	prescr_medica
				where	nr_prescricao = nr_prescricao_w;

				select	coalesce(max(qt_min_agora),0),
						coalesce(max(qt_min_especial),0),
						max(ie_classif_urgencia),
						coalesce(max(ie_forma_agora), 'N'),
						coalesce(max(ie_gera_disp_acm_sn),'S')
				into STRICT	qt_min_agora_w,
						qt_min_especial_w,
						ie_classif_nao_padrao_w,
						ie_agora_impressao_w,
						ie_gera_disp_acm_sn_w
				from	parametros_farmacia
				where	cd_estabelecimento = cd_estabelecimento_w;
				
				dt_limite_agora_w	:= dt_liberacao_w + qt_min_agora_w/1440;
				dt_limite_especial_w	:= dt_liberacao_w + qt_min_especial_w/1440;
				
				if (coalesce(ie_gerar_classif_agora_w,'N') = 'S') then
					dt_hora_atual_w := clock_timestamp();
					dt_limite_agora_w	:=  dt_hora_atual_w + qt_min_agora_w/1440; 			
				end if;

				if (ie_sn_w = 'S') or (ie_acm_w = 'S') then			
					ie_acm_sn_w := 'S';
				else
					ie_acm_sn_w := 'N';
				end if;	
				
				if (ie_aprazar_interv_p = 'N') then
					begin
					ie_aprazar_w := 'S';
					if (ie_aprazar_w = 'S') then
						begin
						select	cd_estabelecimento,
								cd_setor_atendimento,
								dt_inicio_prescr
						into STRICT	cd_estab_prescr_w,
								cd_setor_prescr_w,
								dt_inicio_prescr_w
						from	prescr_medica
						where	nr_prescricao = nr_prescricao_w;
						
						ie_agrupador_w	:= 5;
						
						select	coalesce(min(nr_sequencia),0)
						into STRICT	nr_seq_orig_w
						from	prescr_mat_hor
						where	nr_prescricao = nr_prescricao_w
						and	nr_seq_material = nr_seq_item_w
						and	coalesce(ie_situacao,'A') = 'A'
						and	Obter_se_horario_liberado(dt_lib_horario, dt_horario) = 'S';
																					

						if (nr_seq_orig_w > 0) then
							select	qt_dose,
								qt_dispensar,
								qt_dispensar_hor,
								cd_unidade_medida,
								cd_unidade_medida_dose
							into STRICT	qt_dose_w,
								qt_dispensar_w,
								qt_dispensar_hor_w,
								cd_unidade_medida_w,
								cd_unidade_medida_dose_w
							from	prescr_mat_hor
							where	nr_sequencia = nr_seq_orig_w;
						else		
							cd_unid_med_dose_hor_w := null;
							qt_dose_hor_w	:= null;	
							SELECT * FROM obter_dose_um_horario_pmh(cd_material_w, qt_item_p, cd_unidade_medida_dose_w, qt_dose_hor_w, cd_unid_med_dose_hor_w) INTO STRICT qt_dose_hor_w, cd_unid_med_dose_hor_w;							
						end if;
										
						select	coalesce(max(substr(Obter_se_medic_controlado(cd_item_p),1,1)),'N'),
							coalesce(max(substr(obter_se_material_padronizado(cd_estabelecimento_w, cd_item_p),1,1)),'N')
						into STRICT	ie_controlado_w,
							ie_padronizado_w
						;
						
						/*	Fabio e JonasJonas - 19/01/2010 = Para gerar os lotes como AGORA dependendo do horario final do turno, e nao mais pelo minutos de agora*/

						if (ie_agora_impressao_w = 'S') then
							nr_seq_turno_hor_ag_w	:= obter_turno_horario_prescr(cd_estabelecimento_w,cd_setor_prescr_w,to_char(dt_horario_w,'hh24:mi'),cd_local_estoque_w);
							select	max(to_char(b.hr_inicial,'hh24:mi')),
								max(to_char(b.hr_final,'hh24:mi'))
							into STRICT	hr_turno_agora_w,
								hr_final_turno_agora_w
							from	regra_turno_disp_param b,
								regra_turno_disp a
							where	a.nr_sequencia		= b.nr_seq_turno
							and	a.cd_estabelecimento	= cd_estabelecimento_w
							and	a.nr_sequencia		= nr_seq_turno_hor_ag_w
							and (coalesce(b.cd_setor_atendimento,coalesce(cd_setor_prescr_w,0))	= coalesce(cd_setor_prescr_w,0));

							select	coalesce(max(qt_min_antes_atend), 0),
								coalesce(max(ie_define_agora), 'N')
							into STRICT	qt_min_antes_atend_w,
								ie_define_agora_w
							from	regra_tempo_disp
							where	cd_estabelecimento	= cd_estabelecimento_w
							and (coalesce(cd_setor_atendimento,coalesce(cd_setor_prescr_w,0)) = coalesce(cd_setor_prescr_w,0))
							and	nr_seq_turno = nr_seq_turno_hor_ag_w
							and	ie_situacao = 'A';

							if (hr_turno_agora_w > hr_final_turno_agora_w) then
								if (ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_horario_w) > ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_inicio_prescr_w)) then
									dt_limite_agora_w := PKG_DATE_UTILS.get_Time(dt_horario_w - 1, hr_turno_agora_w) - (qt_min_antes_atend_w/1440);
								else
									dt_limite_agora_w := PKG_DATE_UTILS.get_Time(dt_horario_w, hr_turno_agora_w) - (qt_min_antes_atend_w/1440);
								end if;
							else
								dt_limite_agora_w := PKG_DATE_UTILS.get_Time(dt_horario_w, hr_turno_agora_w) - (qt_min_antes_atend_w/1440);
							end if;
						end if;
						/*	Fabio e Jonas - 19/01/2010 = Final da alteracao*/

						
						if (coalesce(ie_classif_nao_padrao_w::text, '') = '') or (ie_padronizado_w = 'S') then
							begin
							ie_classif_urgente_w	:= 'N';
							if (dt_horario_w <= dt_limite_agora_w) then
								ie_classif_urgente_w	:= 'A';
							elsif	((dt_limite_agora_w <= clock_timestamp()) and (ie_agora_impressao_w = 'S') and (ie_define_agora_w = 'N')) then
								ie_classif_urgente_w	:= 'A';
							elsif (ie_agora_impressao_w = 'S' and ie_define_agora_w = 'S') and
								(dt_horario_w <= (clock_timestamp() + (qt_min_antes_atend_w /1440))) then
								ie_classif_urgente_w	:= 'A';
							elsif (dt_horario_w <= dt_limite_especial_w) then
								ie_classif_urgente_w	:= 'E';
							end if;
							end;
						else
							ie_classif_urgente_w	:= ie_classif_nao_padrao_w;
						end if;
						
						if (ie_tipo_item_p = 'IAG') then
							qt_dose_w := qt_item_p;
							qt_dispensar_hor_w := qt_item_p;
							
							if	(ie_gerar_necessidade_disp_w = 'N' AND ie_regra_disp_w = 'N') then
								ie_gerar_lote_w			:= 'N';							
							end if;
						end if;
						
						--OS 714387
						cd_um_consumo_w := obter_dados_material_estab(cd_material_w,cd_estabelecimento_w,'UMS');
						
						if (cd_um_consumo_w = '')	then
							qt_dose_convertida_w 	:= qt_item_p;
							cd_um_consumo_w		:= cd_unidade_medida_dose_w;						
						else
							qt_dose_convertida_w	:= ceil(obter_dose_convertida(cd_material_w,qt_item_p,cd_unidade_medida_dose_w,cd_um_consumo_w));						
						end if;
						--Fim OS714387
						
						ie_liberado_w := 'N';
						
						select	coalesce(max('S'),'N')
						into STRICT	ie_liberado_w
						from	prescr_mat_hor	
						where	nr_prescricao = nr_prescricao_w
						and	(dt_lib_horario IS NOT NULL AND dt_lib_horario::text <> '');	

						if (ie_gera_disp_acm_sn_w = 'N' AND ie_acm_sn_w = 'S') then
							ie_gerar_lote_w := 'S';
							update	prescr_material
							set		ie_gerar_lote 	= 'S'
							where	nr_prescricao	= nr_prescricao_w
							and	nr_sequencia	= nr_seq_item_w;
						end if;	
											
						select	nextval('prescr_mat_hor_seq')
						into STRICT	nr_seq_horario_w
						;

						insert into prescr_mat_hor(
							nr_sequencia,
							nr_seq_digito,
							nr_prescricao,
							nr_seq_material,
							ie_agrupador,
							dt_atualizacao,
							nm_usuario,
							dt_atualizacao_nrec,
							nm_usuario_nrec,
							cd_material,
							qt_dose,
							qt_dispensar_hor,
							ds_horario,
							dt_horario,
							cd_unidade_medida,
							cd_unidade_medida_dose,
							ie_urgente,
							dt_emissao_farmacia,
							dt_fim_horario,
							dt_suspensao,
							ie_horario_especial,
							qt_hor_reaprazamento,
							nm_usuario_reaprazamento,
							nr_seq_turno,
							dt_disp_farmacia,
							ie_aprazado,
							ie_classif_urgente,
							ie_padronizado,
							ie_controlado,
							cd_unid_med_hor,
							qt_horario,
							ie_gerar_lote,
							dt_lib_horario,
							ie_dose_especial,
							nr_seq_hor_glic,
							nr_atendimento,
							ie_gedipa
							)
						values (
							nr_seq_horario_w,
							calcula_digito('MODULO11',nr_seq_horario_w),
							nr_prescricao_w,
							nr_seq_item_w,
							--decode(ie_tipo_item_p,'M',1,12),
							ie_agrupador_w,
							clock_timestamp(),
							nm_usuario_p,
							clock_timestamp(),
							nm_usuario_p,
							cd_item_p,
							qt_dose_w,
							qt_dispensar_hor_w,
							to_char(dt_horario_w,'hh24:mi'),
							dt_horario_w,
							cd_unidade_medida_w,
							cd_unidade_medida_dose_w,
							'N',
							CASE WHEN ie_gerar_necessidade_disp_w='S' THEN null  ELSE clock_timestamp() END ,
							null,
							null,
							'N',
							null,
							null,
							obter_turno_horario_prescr(cd_estab_prescr_w,cd_setor_prescr_w,to_char(dt_horario_w,'hh24:mi'),cd_local_estoque_w),
							clock_timestamp(),
							'S',
							ie_classif_urgente_w,
							ie_padronizado_w,
							ie_controlado_w,
							cd_um_consumo_w, --nvl(cd_unid_med_dose_hor_w, cd_unidade_medida_dose_w),
							qt_dose_convertida_w, --qt_dose_w,
							coalesce(ie_gerar_lote_w,'S'),
							clock_timestamp(),
							'S',
							nr_seq_hor_glic_w,
							nr_atendimento_p,
							null);
							
							if	((ie_gerar_necessidade_disp_w = 'S') or (ie_regra_disp_w <> 'N')) then

								if	((ie_acm_w = 'S') or (ie_sn_w = 'S' )) then
									if (ie_imprimir_acm_sn_w = 'S') then
										update	prescr_medica
										set	dt_emissao_farmacia	 = NULL,
											nm_usuario_imp_far	 = NULL
										where	nr_prescricao		= nr_prescricao_w;
									end if;
								else	
									update	prescr_medica
									set	dt_emissao_farmacia	 = NULL,
										nm_usuario_imp_far	 = NULL
									where	nr_prescricao		= nr_prescricao_w;
								end if;

								update	prescr_material
								set	cd_motivo_baixa	= 0,
									dt_baixa	 = NULL
								where	nr_prescricao	= nr_prescricao_w
								and	nr_sequencia	= nr_seq_item_w;

								if (ie_gerar_nec_disp_kit_w = 'S') then
									update	prescr_material
									set	cd_motivo_baixa	= 0,
										dt_baixa	 = NULL
									where	nr_prescricao		= nr_prescricao_w
									and	nr_sequencia_diluicao	= nr_seq_item_w;

									update	prescr_material
									set	cd_motivo_baixa	= 0,
										dt_baixa	 = NULL
									where	nr_prescricao	= nr_prescricao_w
									and	nr_seq_kit	= nr_seq_item_w;
								end if;
								
							end if;
							-- A qt_dispensar_hor e recalculada neste objeto "calcular_dispensar_hor_kit", observar que pode se recalculada mais uma vez caso nr_Seq_pergunta_p > 0 (Isso so ocorre quando usuario
							--registra medicao no PDA)
							CALL calcular_dispensar_hor_kit(nr_prescricao_w, nr_seq_horario_w,qt_dose_w,cd_unidade_medida_dose_w);
							
							if (coalesce(ie_kit_gerado_w,'N') = 'N') then
								CALL Gerar_Kit_Medic_Prescr_manual(cd_estab_prescr_w, nr_prescricao_w, nr_seq_item_w, nm_usuario_p);		
								CALL define_local_disp_prescr(nr_prescricao_w, nr_seq_item_w, cd_perfil_w, nm_usuario_p);
							end if;	
							
							CALL aprazar_itens_dependentes(cd_estab_prescr_w, cd_setor_prescr_w, nr_atendimento_p, nr_prescricao_w, nr_seq_item_w, nr_agrupamento_w, dt_horario_w, ie_gerar_necessidade_disp_w, nm_usuario_p, null, nr_seq_hor_glic_w, null, ie_horario_adep_w, '');	
							
							CALL Gerar_Gedi_Medic_atend(cd_estabelecimento_w, nr_prescricao_w, nr_seq_item_w, nr_seq_horario_w, nm_usuario_p);						
							
							if (ie_local_estoque_mat_hor_w	= 'N') then
								CALL adep_gerar_area_prep(nr_prescricao_w, null, nm_usuario_p);
							    if (ie_gerar_proc_gedipa_job_w	= 'N') then
									CALL Gedipa_Gerar_Proc_Instantaneo(nr_prescricao_w,nr_seq_item_w,null,nr_seq_horario_w);
								end if;						
							end if;
							
						if (coalesce(nr_seq_classif_param_w ,0) > 0)	then
							begin
							update	prescr_mat_hor
							set	nr_seq_classif		= nr_seq_classif_param_w
							where	nr_prescricao		= nr_prescricao_w	
							and	nr_sequencia		= nr_seq_horario_w;
							end;
						else

							if (ie_grava_log_rastr_w = 'S') then
								CALL adep_gerar_log_rastr(substr('APRAZAR_ITEM_PRESCR C11 LINE 6065 PARAMETERS' || chr(10) ||
									'{'||chr(10)||
									'"cd_estabelecimento_w" : "'||cd_estabelecimento_w||'"}',1,1500));
							end if;

							open C11;
							loop
							fetch C11 into	
								nr_seq_classif_w,
								ie_classif_urgente_w,
								ie_controlado_w,
								ie_padronizado_w;
							EXIT WHEN NOT FOUND; /* apply on C11 */
								begin
								if (ie_controlado_w = 'A') and (ie_padronizado_w = 'A') then
									update	prescr_mat_hor
									set	nr_seq_classif		= nr_seq_classif_w
									where	nr_prescricao		= nr_prescricao_w	
									and	nr_sequencia		= nr_seq_horario_w
									--and	nr_seq_lote		is not null
									and	ie_classif_urgente	= ie_classif_urgente_w;
								elsif (ie_controlado_w = 'A') and (ie_padronizado_w = 'S') then
									update	prescr_mat_hor
									set	nr_seq_classif		= nr_seq_classif_w
									where	nr_prescricao		= nr_prescricao_w
									and	ie_padronizado		= 'S'
									and	nr_sequencia		= nr_seq_horario_w
									--and	nr_seq_lote		is not null
									and	ie_classif_urgente	= ie_classif_urgente_w;
								elsif (ie_controlado_w = 'A') and (ie_padronizado_w = 'N') then
									update	prescr_mat_hor
									set	nr_seq_classif		= nr_seq_classif_w
									where	nr_prescricao		= nr_prescricao_w
									and	ie_padronizado		= 'N'
									and	nr_sequencia		= nr_seq_horario_w
									--and	nr_seq_lote		is not null
									and	ie_classif_urgente	= ie_classif_urgente_w;
								elsif (ie_controlado_w = 'N') and (ie_padronizado_w = 'A') then
									update	prescr_mat_hor
									set	nr_seq_classif		= nr_seq_classif_w
									where	nr_prescricao		= nr_prescricao_w
									and	ie_controlado		= 'N'
									and	nr_sequencia		= nr_seq_horario_w
									--and	nr_seq_lote		is not null
									and	ie_classif_urgente	= ie_classif_urgente_w;
								elsif (ie_controlado_w = 'N') and (ie_padronizado_w = 'N') then
									update	prescr_mat_hor
									set	nr_seq_classif		= nr_seq_classif_w
									where	nr_prescricao		= nr_prescricao_w
									and	ie_controlado		= 'N'
									and	ie_padronizado		= 'N'
									and	nr_sequencia		= nr_seq_horario_w
									--and	nr_seq_lote		is not null
									and	ie_classif_urgente	= ie_classif_urgente_w;
								elsif (ie_controlado_w = 'N') and (ie_padronizado_w = 'S') then
									update	prescr_mat_hor
									set	nr_seq_classif		= nr_seq_classif_w
									where	nr_prescricao		= nr_prescricao_w
									and	ie_controlado		= 'N'
									and	ie_padronizado		= 'S'
									--and	nr_seq_lote		is not null
									and	nr_sequencia		= nr_seq_horario_w
									and	ie_classif_urgente	= ie_classif_urgente_w;
								elsif (ie_controlado_w = 'S') and (ie_padronizado_w = 'A') then
									update	prescr_mat_hor
									set	nr_seq_classif		= nr_seq_classif_w
									where	nr_prescricao		= nr_prescricao_w
									and	ie_controlado		= 'S'
									--and	nr_seq_lote		is not null
									and	nr_sequencia		= nr_seq_horario_w
									and	ie_classif_urgente	= ie_classif_urgente_w;
								elsif (ie_controlado_w = 'S') and (ie_padronizado_w = 'N') then
									update	prescr_mat_hor
									set	nr_seq_classif		= nr_seq_classif_w
									where	nr_prescricao		= nr_prescricao_w
									and	ie_controlado		= 'S'
									and	ie_padronizado		= 'N'
									--and	nr_seq_lote		is not null
									and	nr_sequencia		= nr_seq_horario_w
									and	ie_classif_urgente	= ie_classif_urgente_w;
								elsif (ie_controlado_w = 'S') and (ie_padronizado_w = 'S') then
									update	prescr_mat_hor
									set	nr_seq_classif		= nr_seq_classif_w
									where	nr_prescricao		= nr_prescricao_w
									and	ie_controlado		= 'S'
									and	ie_padronizado		= 'S'
									--and	nr_seq_lote		is not null
									and	nr_sequencia		= nr_seq_horario_w
									and	ie_classif_urgente	= ie_classif_urgente_w;
								end if;
							
								end;
							end loop;
							close C11;
						end if;
						
						if (ie_local_estoque_mat_hor_w	= 'S') then
						
							CALL define_disp_prescr_mat_hor(nr_seq_horario_w, nr_prescricao_w, nr_seq_item_w, cd_perfil_w, nm_usuario_p);
							
							select	coalesce(max(cd_local_estoque),cd_local_estoque_w)
							into STRICT	cd_local_estoque_w
							from	prescr_mat_hor
							where	nr_sequencia	= nr_seq_horario_w;
							
							update	prescr_mat_hor
							set		nr_seq_turno	= coalesce(Obter_turno_horario_prescr(cd_estabelecimento_w, cd_setor_atendimento_w, to_char(dt_horario_w,'hh24:mi'), cd_local_estoque_w),nr_seq_turno)
							where	nr_sequencia	= nr_seq_horario_w;
							
							CALL adep_gerar_area_prep(nr_prescricao_w, null, nm_usuario_p);
							if (ie_gerar_proc_gedipa_job_w	= 'N') then
								CALL Gedipa_Gerar_Proc_Instantaneo(nr_prescricao_w,nr_seq_item_w,null,nr_seq_horario_w);
							end if;						

						end if;						
						
						/* gerar evento aprazamento */

						if (nr_prescr_atual_w <> nr_prescricao_w) and (coalesce(nr_seq_horario_w,0) > 0) then						
							
							CALL Gerar_Lote_Atend_Prescricao(nr_prescricao_w, nr_seq_item_w, nr_seq_horario_w, 'S', nm_usuario_p, 'AIP');
							CALL gerar_acm_sn_apraz_prescricao(nr_prescricao_w, nr_seq_item_w,cd_local_estoque_w,nm_usuario_p);	
							
							if (ie_gerar_lote_apraza_w = 'S') and (obter_funcao_ativa = 88) and (ie_gerar_proc_gedipa_job_w = 'N') then
								select	obter_se_setor_processo_gedipa(obter_unidade_atendimento(nr_atendimento_p,'IAA','CS'))
								into STRICT	ie_gedipa_w
								;
								
								SELECT * FROM Gerar_Processo_ADEP(nr_atendimento_p, dt_horario_w, nm_usuario_p, nr_seq_processo_w, 'N', 1113, 'GPAP', ie_gedipa_w, 'N', nr_seq_processo_agora_w, null, null, 'N', nr_seq_processo_nut_w) INTO STRICT nr_seq_processo_w, nr_seq_processo_agora_w, nr_seq_processo_nut_w;
								--gerar_fracionamento_processo(nr_seq_processo_w,nm_usuario_p);
							end if;
							
						end if;
						
						if (coalesce(ie_gerar_evento_p,'S') <> 'N') then
							CALL gerar_evento_reaprazamento(nr_atendimento_p, nr_prescricao_w, nr_seq_item_w, nr_seq_horario_w, cd_item_p, ie_tipo_item_p, ie_alteracao_w, nr_seq_motivo_p, ds_justificativa_p, nm_usuario_p, nr_seq_proc_interno_p,ie_acm_sn_w,nr_seq_assinatura_p);					
						end if;
						
						if (ie_tipo_item_p = 'IAG') and (coalesce(nr_seq_pergunta_p,0) > 0) then
							
							if ((ie_gerar_necessidade_disp_w = 'N') or (ie_regra_disp_w = 'N')) then
							   qt_dispensar_hor_w := 0;
							else
							   qt_dispensar_hor_w := ceil(obter_dose_convertida(cd_material_w,qt_item_p,cd_unidade_medida_dose_w,cd_unid_med_consumo_w));
							end if;
							
							update	prescr_mat_hor
							set		qt_dispensar_hor = qt_dispensar_hor_w
							where	nr_sequencia = nr_seq_horario_w;
							if (coalesce(wheb_usuario_pck.get_ie_commit, 'S') = 'S') then commit; end if;
						end if;

						/* atualizar prescricao */

						nr_prescr_atual_w := nr_prescricao_w;							
						end;
					else
						ie_inconsistencia_w := 'H';
						if (coalesce(ds_inconsistentes_w::text, '') = '') then
							ds_inconsistentes_w := to_char(nr_prescricao_w);
						elsif (position(nr_prescricao_w in ds_inconsistentes_w) = 0) then
							ds_inconsistentes_w := ds_inconsistentes_w || ', ' || to_char(nr_prescricao_w);
						end if;	
					end if;
					end;			
				elsif (ie_aprazar_interv_p = 'S') then
					CALL aprazar_item_prescr_interv(ie_tipo_item_p, nr_prescricao_w, nr_seq_item_w, dt_horario_p, nr_seq_motivo_p, ds_justificativa_p, nm_usuario_p, nr_seq_assinatura_p);
				end if;	
				
			end if;	
				
			end;
		end loop;
		close C09;
		
		if (ie_grava_log_rastr_w = 'S') then
			CALL adep_gerar_log_rastr(substr('APRAZAR_ITEM_PRESCR C10 PARAMETERS' || chr(10) ||
				'{'||chr(10)||
				'"cd_intervalo_p" : "'||cd_intervalo_p||'",'||chr(10)||
				'"cd_item_p" : "'||cd_item_p||'",'||chr(10)||
				'"cd_setor_pac_w" : "'||cd_setor_pac_w||'",'||chr(10)||
				'"dt_horario_w" : "'||to_char(dt_horario_w, 'dd/mm/yyyy hh24:mi:ss')||'",'||chr(10)||
				'"dt_validade_w" : "'||to_char(dt_validade_w, 'dd/mm/yyyy hh24:mi:ss')||'",'||chr(10)||
				'"ie_aprazar_suspensos_w" : "'||ie_aprazar_suspensos_w||'",'||chr(10)||
				'"vetor_w(x).nr_prescricao_w" : "'||vetor_w[x].nr_prescricao_w||'",'||chr(10)||
				'"ie_data_lib_prescr_w" : "'||ie_data_lib_prescr_w||'",'||chr(10)||
				'"ie_tipo_item_p" : "'||ie_tipo_item_p||'",'||chr(10)||
				'"nr_atendimento_p" : "'||nr_atendimento_p||'",'||chr(10)||
				'"qt_item_p" : "'||qt_item_p||'"}',1,1500));
		end if;
		
		open C10;
		loop
		fetch C10 into	
			nr_prescricao_w,
			nr_seq_item_w,
			cd_local_estoque_w,
			nr_agrupamento_w,
			cd_material_w,
			cd_unidade_medida_w,		
			ie_sn_w,
			ie_acm_w,
			qt_total_dispensar_w;
		EXIT WHEN NOT FOUND; /* apply on C10 */
			begin
			ie_cursor_w := 'S';
			
			CALL Consistir_qt_aprazamento(cd_perfil_w, cd_item_p, nr_prescricao_w, nr_seq_item_w);
			
			select	max(dt_liberacao),
				max(cd_estabelecimento)
			into STRICT	dt_liberacao_w,
				cd_estabelecimento_w
			from	prescr_medica
			where	nr_prescricao = nr_prescricao_w;

			select	coalesce(max(qt_min_agora),0),
				coalesce(max(qt_min_especial),0),
				max(ie_classif_urgencia),
				coalesce(max(ie_forma_agora), 'N'),
				coalesce(max(ie_gera_disp_acm_sn),'S')
			into STRICT	qt_min_agora_w,
				qt_min_especial_w,
				ie_classif_nao_padrao_w,
				ie_agora_impressao_w,
				ie_gera_disp_acm_sn_w
			from	parametros_farmacia
			where	cd_estabelecimento = cd_estabelecimento_w;
			
			dt_limite_agora_w	:= dt_liberacao_w + qt_min_agora_w/1440;
			dt_limite_especial_w	:= dt_liberacao_w + qt_min_especial_w/1440;
			
			if (coalesce(ie_gerar_classif_agora_w,'N') = 'S') then
				dt_hora_atual_w := clock_timestamp();
				dt_limite_agora_w	:=  dt_hora_atual_w + qt_min_agora_w/1440; 			
			end if;

			if (ie_sn_w = 'S') or (ie_acm_w = 'S') then			
				ie_acm_sn_w := 'S';
			else
				ie_acm_sn_w := 'N';
			end if;	
			
			if (ie_aprazar_interv_p = 'N') then
				begin
				ie_aprazar_w := 'S';
				if (ie_aprazar_w = 'S') then
					begin
					select	max(cd_estabelecimento),
							max(cd_setor_atendimento),
							max(dt_inicio_prescr)
					into STRICT	cd_estab_prescr_w,
							cd_setor_prescr_w,
							dt_inicio_prescr_w
					from	prescr_medica
					where	nr_prescricao = nr_prescricao_w;
					
					if (ie_local_estoque_w = 'S') then
						CALL define_local_disp_prescr(nr_prescricao_w, nr_seq_item_w, cd_perfil_w, nm_usuario_p);
						select	max(cd_local_estoque)
						into STRICT	cd_local_estoque_w
						from	prescr_material b
						where	nr_prescricao	= nr_prescricao_w
						and		nr_sequencia	= nr_seq_item_w;
						
						cd_setor_prescr_w		:= Obter_Setor_Atendimento(nr_atendimento_p);
					elsif (ie_local_estoque_w = 'R') then
						CALL define_local_disp_prescr(nr_prescricao_w, nr_seq_item_w, cd_perfil_w, nm_usuario_p);
						select	max(cd_local_estoque)
						into STRICT	cd_local_estoque_w
						from	prescr_material b
						where	nr_prescricao	= nr_prescricao_w
						and		nr_sequencia	= nr_seq_item_w;
						
						cd_setor_prescr_w		:= Obter_Setor_Atendimento_lib(nr_atendimento_p);
					end if;
					
					ie_agrupador_w	:= 8;
					
					select	coalesce(min(nr_sequencia),0)
					into STRICT	nr_seq_orig_w
					from	prescr_mat_hor
					where	nr_prescricao = nr_prescricao_w
					and	nr_seq_material = nr_seq_item_w
					and	coalesce(ie_situacao,'A') = 'A'
					and	Obter_se_horario_liberado(dt_lib_horario, dt_horario) = 'S';
					
					if (nr_seq_orig_w > 0) then
						select	qt_dose,
							qt_dispensar,
							qt_dispensar_hor,
							cd_unidade_medida,
							cd_unidade_medida_dose
						into STRICT	qt_dose_w,
							qt_dispensar_w,
							qt_dispensar_hor_w,
							cd_unidade_medida_w,
							cd_unidade_medida_dose_w
						from	prescr_mat_hor
						where	nr_sequencia = nr_seq_orig_w;
					else		
						cd_unid_med_dose_hor_w := null;
						qt_dose_hor_w	:= null;	
						
						SELECT * FROM obter_dose_um_horario_pmh(cd_material_w, qt_item_p, cd_unidade_medida_dose_w, qt_dose_hor_w, cd_unid_med_dose_hor_w) INTO STRICT qt_dose_hor_w, cd_unid_med_dose_hor_w;							

						select	qt_dose,
							qt_total_dispensar,
							dividir(qt_total_dispensar,nr_ocorrencia),
							cd_unidade_medida,
							cd_unidade_medida_dose
						into STRICT	qt_dose_w,
							qt_dispensar_w,
							qt_dispensar_hor_w,
							cd_unidade_medida_w,
							cd_unidade_medida_dose_w
						from	prescr_material
						where	nr_prescricao = nr_prescricao_w
						and	nr_sequencia = nr_seq_item_w;
					end if;
					
					SELECT * FROM obter_dose_um_horario_pmh(cd_material_w, qt_item_p, cd_unidade_medida_dose_w, qt_dose_hor_w, cd_unid_med_dose_hor_w) INTO STRICT qt_dose_hor_w, cd_unid_med_dose_hor_w;							
					
					select	coalesce(max(substr(Obter_se_medic_controlado(cd_item_p),1,1)),'N'),
						coalesce(max(substr(obter_se_material_padronizado(cd_estabelecimento_w, cd_item_p),1,1)),'N')
					into STRICT	ie_controlado_w,
						ie_padronizado_w
					;
					
					if (coalesce(ie_classif_nao_padrao_w::text, '') = '') or (ie_padronizado_w = 'S') then
						begin
						ie_classif_urgente_w	:= 'N';
						if (dt_horario_w <= dt_limite_agora_w) then
							ie_classif_urgente_w	:= 'A';
						elsif (dt_horario_w <= dt_limite_especial_w) then
							ie_classif_urgente_w	:= 'E';
						end if;
						end;
					else
						ie_classif_urgente_w	:= ie_classif_nao_padrao_w;
					end if;
					
					ie_liberado_w := 'N';
					
					Select	coalesce(max(nr_etapa_sol),0) +1
					into STRICT	nr_etapa_item_w
					from	prescr_mat_hor
					where	nr_prescricao	= nr_prescricao_p
					and 	nr_Seq_material	= nr_seq_item_w;
					
					select	coalesce(max('S'),'N')
					into STRICT	ie_liberado_w
					from	prescr_mat_hor	
					where	nr_prescricao = nr_prescricao_w
					and	(dt_lib_horario IS NOT NULL AND dt_lib_horario::text <> '');
												
					select	nextval('prescr_mat_hor_seq')
					into STRICT	nr_seq_horario_w
					;
					
					insert into prescr_mat_hor(
						nr_sequencia,
						nr_seq_digito,
						nr_prescricao,
						nr_seq_material,
						ie_agrupador,
						dt_atualizacao,
						nm_usuario,
						dt_atualizacao_nrec,
						nm_usuario_nrec,
						cd_material,
						qt_dose,
						qt_dispensar_hor,
						ds_horario,
						dt_horario,
						cd_unidade_medida,
						cd_unidade_medida_dose,
						ie_urgente,
						dt_emissao_farmacia,
						dt_fim_horario,
						dt_suspensao,
						ie_horario_especial,
						qt_hor_reaprazamento,
						nm_usuario_reaprazamento,
						nr_seq_turno,
						dt_disp_farmacia,
						ie_aprazado,
						ie_classif_urgente,
						ie_padronizado,
						ie_controlado,
						cd_unid_med_hor,
						qt_horario,
						ie_gerar_lote,
						dt_lib_horario,
						qt_dispensar,
						nr_etapa_sol,
						nr_atendimento
						)
					values (
						nr_seq_horario_w,
						calcula_digito('MODULO11',nr_seq_horario_w),
						nr_prescricao_w,
						nr_seq_item_w,
						ie_agrupador_w,
						clock_timestamp(),
						nm_usuario_p,
						clock_timestamp(),
						nm_usuario_p,
						cd_item_p,
						qt_dose_w,
						qt_dispensar_hor_w,
						to_char(dt_horario_w,'hh24:mi'),
						dt_horario_w,
						cd_unidade_medida_w,
						cd_unidade_medida_dose_w,
						'N',
						CASE WHEN ie_gerar_necessidade_disp_w='S' THEN null  ELSE clock_timestamp() END ,
						null,
						null,
						'N',
						null,
						null,
						obter_turno_horario_prescr(cd_estab_prescr_w,cd_setor_prescr_w,to_char(dt_horario_w,'hh24:mi'),cd_local_estoque_w),
						clock_timestamp(),
						'S',
						ie_classif_urgente_w,
						ie_padronizado_w,
						ie_controlado_w,
						coalesce(cd_unid_med_dose_hor_w, cd_unidade_medida_dose_w),
						qt_dose_hor_w,
						coalesce(ie_gerar_lote_w,'S'),
						clock_timestamp(),
						qt_total_dispensar_w,
						nr_etapa_item_w,
						nr_atendimento_p);
						
					CALL adep_gerar_area_prep(nr_prescricao_w, null, nm_usuario_p);
					/*
					if	(ie_gerar_proc_gedipa_job_w	= 'N') then
						Gedipa_Gerar_Proc_Instantaneo(nr_prescricao_w,nr_seq_item_w,null,nr_seq_horario_w);
					end if;						
					*/
					
					if (ie_gerar_processo_w = 'S') then
												
						nr_seq_processo_w := gerar_processo_adep_sol(nr_atendimento_p, nr_prescricao_w, null, nr_etapa_item_w, trunc(dt_horario_w,'mi'), nm_usuario_p, nr_seq_processo_w, null, obter_funcao_ativa, 'AIS', ie_setor_gedipa_w, nr_seq_item_w, null);
						
						update	prescr_mat_hor a
						set		a.nr_seq_processo	= nr_seq_processo_w
						where	a.nr_prescricao		= nr_prescricao_w
						and		a.dt_horario		= trunc(dt_horario_w,'mi')
						and		coalesce(a.ie_horario_especial,'N') <> 'S'
						and		a.nr_seq_material = nr_seq_item_w
						and 	coalesce(a.nr_seq_processo::text, '') = '';
		
			            if (ie_setor_gedipa_w = 'S') then
							CALL gerar_frac_proc_sol(nr_seq_processo_w, nr_prescricao_w, null, 'S', nm_usuario_p, nr_seq_item_w, 'S');
						end if;
			
					end if;
						
					CALL aprazar_itens_dependentes(cd_estab_prescr_w, cd_setor_prescr_w, nr_atendimento_p, nr_prescricao_w, nr_seq_item_w, nr_agrupamento_w, dt_horario_w, ie_gerar_necessidade_disp_w, nm_usuario_p, null, nr_seq_hor_glic_w, null, null, '');
					--	calcular_dispensar_hor_kit(nr_prescricao_w, nr_seq_horario_w);
					
					if (coalesce(nr_seq_classif_param_w ,0) > 0)	then
						begin
						update	prescr_mat_hor
						set	nr_seq_classif		= nr_seq_classif_param_w
						where	nr_prescricao		= nr_prescricao_w	
						and	nr_sequencia		= nr_seq_horario_w;
						end;
					else
						if (ie_grava_log_rastr_w = 'S') then
							CALL adep_gerar_log_rastr(substr('APRAZAR_ITEM_PRESCR C11 LINE 6531 PARAMETERS' || chr(10) ||
								'{'||chr(10)||
								'"cd_estabelecimento_w" : "'||cd_estabelecimento_w||'"}',1,1500));
						end if;

						open C11;
						loop
						fetch C11 into	
							nr_seq_classif_w,
							ie_classif_urgente_w,
							ie_controlado_w,
							ie_padronizado_w;
						EXIT WHEN NOT FOUND; /* apply on C11 */
							begin
							if (ie_controlado_w = 'A') and (ie_padronizado_w = 'A') then
								update	prescr_mat_hor
								set	nr_seq_classif		= nr_seq_classif_w
								where	nr_prescricao		= nr_prescricao_w	
								and	nr_sequencia		= nr_seq_horario_w
								--and	nr_seq_lote		is not null
								and	ie_classif_urgente	= ie_classif_urgente_w;
							elsif (ie_controlado_w = 'A') and (ie_padronizado_w = 'S') then
								update	prescr_mat_hor
								set	nr_seq_classif		= nr_seq_classif_w
								where	nr_prescricao		= nr_prescricao_w
								and	ie_padronizado		= 'S'
								and	nr_sequencia		= nr_seq_horario_w
								--and	nr_seq_lote		is not null
								and	ie_classif_urgente	= ie_classif_urgente_w;
							elsif (ie_controlado_w = 'A') and (ie_padronizado_w = 'N') then
								update	prescr_mat_hor
								set	nr_seq_classif		= nr_seq_classif_w
								where	nr_prescricao		= nr_prescricao_w
								and	ie_padronizado		= 'N'
								and	nr_sequencia		= nr_seq_horario_w
								--and	nr_seq_lote		is not null
								and	ie_classif_urgente	= ie_classif_urgente_w;
							elsif (ie_controlado_w = 'N') and (ie_padronizado_w = 'A') then
								update	prescr_mat_hor
								set	nr_seq_classif		= nr_seq_classif_w
								where	nr_prescricao		= nr_prescricao_w
								and	ie_controlado		= 'N'
								and	nr_sequencia		= nr_seq_horario_w
								--and	nr_seq_lote		is not null
								and	ie_classif_urgente	= ie_classif_urgente_w;
							elsif (ie_controlado_w = 'N') and (ie_padronizado_w = 'N') then
								update	prescr_mat_hor
								set	nr_seq_classif		= nr_seq_classif_w
								where	nr_prescricao		= nr_prescricao_w
								and	ie_controlado		= 'N'
								and	ie_padronizado		= 'N'
								and	nr_sequencia		= nr_seq_horario_w
								--and	nr_seq_lote		is not null
								and	ie_classif_urgente	= ie_classif_urgente_w;
							elsif (ie_controlado_w = 'N') and (ie_padronizado_w = 'S') then
								update	prescr_mat_hor
								set	nr_seq_classif		= nr_seq_classif_w
								where	nr_prescricao		= nr_prescricao_w
								and	ie_controlado		= 'N'
								and	ie_padronizado		= 'S'
								--and	nr_seq_lote		is not null
								and	nr_sequencia		= nr_seq_horario_w
								and	ie_classif_urgente	= ie_classif_urgente_w;
							elsif (ie_controlado_w = 'S') and (ie_padronizado_w = 'A') then
								update	prescr_mat_hor
								set	nr_seq_classif		= nr_seq_classif_w
								where	nr_prescricao		= nr_prescricao_w
								and	ie_controlado		= 'S'
								--and	nr_seq_lote		is not null
								and	nr_sequencia		= nr_seq_horario_w
								and	ie_classif_urgente	= ie_classif_urgente_w;
							elsif (ie_controlado_w = 'S') and (ie_padronizado_w = 'N') then
								update	prescr_mat_hor
								set	nr_seq_classif		= nr_seq_classif_w
								where	nr_prescricao		= nr_prescricao_w
								and	ie_controlado		= 'S'
								and	ie_padronizado		= 'N'
								--and	nr_seq_lote		is not null
								and	nr_sequencia		= nr_seq_horario_w
								and	ie_classif_urgente	= ie_classif_urgente_w;
							elsif (ie_controlado_w = 'S') and (ie_padronizado_w = 'S') then
								update	prescr_mat_hor
								set	nr_seq_classif		= nr_seq_classif_w
								where	nr_prescricao		= nr_prescricao_w
								and	ie_controlado		= 'S'
								and	ie_padronizado		= 'S'
								--and	nr_seq_lote		is not null
								and	nr_sequencia		= nr_seq_horario_w
								and	ie_classif_urgente	= ie_classif_urgente_w;
							end if;
						
							end;
						end loop;
						close C11;
					end if;
					
					if (ie_local_estoque_mat_hor_w	= 'S') then
						CALL define_disp_prescr_mat_hor(nr_seq_horario_w, nr_prescricao_w, nr_seq_item_w, cd_perfil_w, nm_usuario_p);
						
						select	coalesce(max(cd_local_estoque),cd_local_estoque_w)
						into STRICT	cd_local_estoque_w
						from	prescr_mat_hor
						where	nr_sequencia	= nr_seq_horario_w;
						
						update	prescr_mat_hor
						set		nr_seq_turno	= coalesce(Obter_turno_horario_prescr(cd_estabelecimento_w, cd_setor_atendimento_w, to_char(dt_horario_w,'hh24:mi'), cd_local_estoque_w),nr_seq_turno)
						where	nr_sequencia	= nr_seq_horario_w;
					end if;
					
					if (ie_gerar_necessidade_disp_w = 'S') then

						if	((ie_acm_w = 'S') or (ie_sn_w = 'S' )) then
							if (ie_imprimir_acm_sn_w = 'S') then
								update	prescr_medica
								set	dt_emissao_farmacia	 = NULL,
									nm_usuario_imp_far	 = NULL
								where	nr_prescricao		= nr_prescricao_w;
							end if;
						else	
							update	prescr_medica
							set	dt_emissao_farmacia	 = NULL,
								nm_usuario_imp_far	 = NULL
							where	nr_prescricao		= nr_prescricao_w;
						end if;
							
						update	prescr_material
						set	cd_motivo_baixa	= 0,
							dt_baixa	 = NULL
						where	nr_prescricao	= nr_prescricao_w
						and	nr_sequencia	= nr_seq_item_w;

						if (ie_gerar_nec_disp_kit_w = 'S') then
							update	prescr_material
							set	cd_motivo_baixa	= 0,
								dt_baixa	 = NULL
							where	nr_prescricao		= nr_prescricao_w
							and	nr_sequencia_diluicao	= nr_seq_item_w;
							
							update	prescr_material
							set	cd_motivo_baixa	= 0,
								dt_baixa	 = NULL
							where	nr_prescricao	= nr_prescricao_w
							and	nr_seq_kit	= nr_seq_item_w;
						end if;					
											
					end if;	
					/* gerar evento aprazamento */

					if (nr_prescr_atual_w <> nr_prescricao_w) and (coalesce(nr_seq_horario_w,0) > 0) and (coalesce(ie_gerar_evento_p,'S') <> 'N') then
						--adep_gerar_area_prep(nr_prescricao_w, null, nm_usuario_p);
						CALL Gerar_Lote_Atend_Prescricao(nr_prescricao_w, nr_seq_item_w, nr_seq_horario_w, 'S', nm_usuario_p, 'AIP');
						CALL gerar_evento_reaprazamento(nr_atendimento_p, nr_prescricao_w, nr_seq_item_w, nr_seq_horario_w, cd_item_p, ie_tipo_item_p, ie_alteracao_w, nr_seq_motivo_p, ds_justificativa_p, nm_usuario_p, nr_seq_proc_interno_p,ie_acm_sn_w,nr_seq_assinatura_p);
						CALL gerar_acm_sn_apraz_prescricao(nr_prescricao_w, nr_seq_item_w,cd_local_estoque_w,nm_usuario_p);	
					end if;

					/* atualizar prescricao */

					nr_prescr_atual_w := nr_prescricao_w;							
					end;
				else
					ie_inconsistencia_w := 'H';
					if (coalesce(ds_inconsistentes_w::text, '') = '') then
						ds_inconsistentes_w := to_char(nr_prescricao_w);
					elsif (position(nr_prescricao_w in ds_inconsistentes_w) = 0) then
						ds_inconsistentes_w := ds_inconsistentes_w || ', ' || to_char(nr_prescricao_w);
					end if;
				end if;		
				end;			
			elsif (ie_aprazar_interv_p = 'S') then
				CALL aprazar_item_prescr_interv(ie_tipo_item_p, nr_prescricao_w, nr_seq_item_w, dt_horario_p, nr_seq_motivo_p, ds_justificativa_p, nm_usuario_p, nr_seq_assinatura_p);
			end if;	
			--define_local_disp_prescr(nr_prescricao_w, nr_seq_item_w, cd_perfil_w, nm_usuario_p);	
			end;
		end loop;
		close C10;

		if (ie_grava_log_rastr_w = 'S') then
			CALL adep_gerar_log_rastr(substr('APRAZAR_ITEM_PRESCR C12 PARAMETERS' || chr(10) ||
				'{'||chr(10)||
				'"cd_intervalo_p" : "'||cd_intervalo_p||'",'||chr(10)||
				'"cd_item_p" : "'||cd_item_p||'",'||chr(10)||
				'"cd_setor_pac_w" : "'||cd_setor_pac_w||'",'||chr(10)||
				'"dt_horario_w" : "'||to_char(dt_horario_w, 'dd/mm/yyyy hh24:mi:ss')||'",'||chr(10)||
				'"dt_validade_w" : "'||to_char(dt_validade_w, 'dd/mm/yyyy hh24:mi:ss')||'",'||chr(10)||
				'"ie_aprazar_suspensos_w" : "'||ie_aprazar_suspensos_w||'",'||chr(10)||
				'"vetor_w(x).nr_prescricao_w" : "'||vetor_w[x].nr_prescricao_w||'",'||chr(10)||
				'"vetor_w(x).nr_seq_cpoe_w" : "'||vetor_w[x].nr_seq_cpoe_w||'",'||chr(10)||
				'"ie_data_lib_prescr_w" : "'||ie_data_lib_prescr_w||'",'||chr(10)||
				'"ie_gas_separada_w" : "'||ie_gas_separada_w||'",'||chr(10)||
				'"ie_tipo_item_p" : "'||ie_tipo_item_p||'",'||chr(10)||
				'"nr_atendimento_p" : "'||nr_atendimento_p||'",'||chr(10)||
				'"nr_seq_cpoe_p" : "'||nr_seq_cpoe_p||'",'||chr(10)||
				'"nr_seq_item_p" : "'||nr_seq_item_p||'",'||chr(10)||
				'"qt_item_p" : "'||qt_item_p||'"}',1,1500));
		end if;

		-- Gasoterapia 	Guilherme Pereira 04/11/2011
		open c12;
		loop
		fetch c12 into	nr_prescricao_gas_w,
				nr_sequencia_gas_w,
				qt_gasoterapia_gas_w,
				cd_unidade_medida_gas_w,
				ie_inicio_w,
				cd_estab_prescr_w,
				cd_setor_prescr_w;
		EXIT WHEN NOT FOUND; /* apply on c12 */
			begin
				ie_cursor_w	:= 'S';
			if (ie_inicio_w = 'ACM')	or (ie_inicio_w = 'A')	or (ie_inicio_w = 'SN')	then
				-- A proxima sequencia na tabela
				select	nextval('prescr_gasoterapia_hor_seq')
				into STRICT 	nr_seq_gaso_hor_w
				;
				-- Busca a etapa
				Select	coalesce(max(nr_etapa),0)+1
				into STRICT	nr_etapa_gas_w
				from	prescr_gasoterapia_hor
				where	nr_prescricao		= nr_prescricao_gas_w
				and 	nr_seq_gasoterapia	= nr_sequencia_gas_w;
				
				insert into prescr_gasoterapia_hor(
								dt_atualizacao,
								dt_atualizacao_nrec,
								dt_fim_horario,
								dt_horario,
								dt_lib_horario,
								dt_suspensao,
								ie_horario_especial,
								nm_usuario,
								nm_usuario_adm,
								nm_usuario_nrec,
								nm_usuario_susp,
								nr_etapa,
								nr_prescricao,
								nr_seq_gasoterapia,
								nr_sequencia)
							    values (
								clock_timestamp(),
								clock_timestamp(),
								null,
								dt_horario_w,
								clock_timestamp(),
								null,
								'N',
								nm_usuario_p,
								null,
								nm_usuario_p,
								null,
								nr_etapa_gas_w,
								nr_prescricao_gas_w,
								nr_sequencia_gas_w,
								nr_seq_gaso_hor_w);
								
				CALL gerar_evento_reaprazamento(nr_atendimento_p, nr_prescricao_gas_w, nr_sequencia_gas_w, nr_seq_gaso_hor_w, cd_item_p, ie_tipo_item_p, ie_alteracao_w, nr_seq_motivo_p, ds_justificativa_p, 	nm_usuario_p, nr_seq_proc_interno_p, 'S',nr_seq_assinatura_p, null, null, nr_seq_cpoe_p);
				ie_entrou_cond_w := 'S';
				CALL aprazar_itens_dependentes(	cd_estabelecimento_p        => cd_estab_prescr_w,
							cd_setor_atendimento_p      => cd_setor_prescr_w,
							nr_atendimento_p            => nr_atendimento_p,
							nr_prescricao_p             => nr_prescricao_w,
							nr_seq_superior_p           => null,
							nr_agrupamento_p            => null,
							dt_horario_aprazar_p        => dt_horario_w,
							ie_gerar_disp_farm_p        => ie_gerar_necessidade_disp_w,
							nm_usuario_p                => nm_usuario_p,
							nr_seq_dialise_p            => null,
							nr_seq_hor_glic_p           => null,
							nr_seq_pergunta_p           => null,
							ie_horario_adep_p           => null,
							ie_origem_p                 => '',
							nr_seq_gasoterapia_p        => nr_sequencia_gas_w);
				
			end if;
			end;
		end loop;
		close c12;
		
		--Gerar lote do cursor acima
		if (ie_entrou_cond_w = 'S') then
			CALL Gerar_Lote_Atend_Prescricao(nr_prescricao_p 	=> nr_prescricao_gas_w,
										nr_sequencia_p		=> 0,
										nr_seq_horario_p	=> 0,
										ie_so_aprazado_p	=> 'S',
										nm_usuario_p		=> nm_usuario_p,
										ie_origem_lote_p	=> 'AIP');
			ie_entrou_cond_w := 'N';
		end if;
	end loop;
	
	if (ie_cursor_w = 'N') then
		ie_inconsistencia_w := 'P';
	end if;
		
end if;
CALL gravar_ag_int_apr_item_prescr(nr_prescricao_w);

ie_inconsistencia_p := ie_inconsistencia_w;
ds_inconsistentes_p := ds_inconsistentes_w;

if (coalesce(wheb_usuario_pck.get_ie_commit, 'S') = 'S') then commit; end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE aprazar_item_prescr ( ie_aprazar_interv_p text, cd_estabelecimento_p bigint, nr_atendimento_p bigint, ie_tipo_item_p text, qt_hora_prescricao_p bigint, cd_item_p text, cd_intervalo_p text, qt_item_p bigint, dt_horario_p timestamp, nr_prescricoes_p text, nr_prescricao_p bigint, nr_seq_item_p bigint, ie_laboratorio_p text, nr_seq_motivo_p bigint, ds_justificativa_p text, nm_usuario_p text, ie_inconsistencia_p INOUT text, ds_inconsistentes_p INOUT text, nr_seq_proc_interno_p bigint, nr_agrupamento_p bigint, ie_acm_sn_p text, ie_gerar_evento_p text default null, nr_seq_assinatura_p bigint default null, ie_chamada_glicemia_p text default 'N', nr_seq_horario_p bigint default null, nr_seq_prot_glic_p bigint DEFAULT NULL, cd_unidade_medida_p text default null, nr_seq_pergunta_p bigint default null, ds_componentes_p text DEFAULT NULL, nr_seq_objeto_p bigint DEFAULT NULL, ie_via_aplicacao_p text default null, nr_seq_cpoe_p bigint default null) FROM PUBLIC;

