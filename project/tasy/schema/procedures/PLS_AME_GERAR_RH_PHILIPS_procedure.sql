-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_ame_gerar_rh_philips ( nr_sequencia_p bigint, ds_local_p text, nm_arquivo_p text) AS $body$
DECLARE


ds_erro_w			varchar(255);
ds_conteudo_w			varchar(4000);
arq_texto_w			utl_file.file_type;
nm_pessoa_contato_w		varchar(255);
ds_email_w			varchar(255);
nr_telefone_w			varchar(255);
qt_linhas_w			integer;
dt_lote_w			timestamp;

C01 CURSOR FOR
	SELECT  lpad(substr(coalesce(e.cd_matricula_estipulante,'00000000'),1,8),8,0) cd_matricula,
		trim(both to_char(coalesce(d.vl_total,0),'999999999.99'))	vl_coparticipacao
	from	pls_segurado 			e,
		pls_plano 			f,
		pls_ame_lote_rem_valor		d,
		pls_ame_lote_rem_arquivo	c,
		pls_ame_lote_rem_destino	b,
		pls_ame_lote_remessa		a
	where   e.nr_seq_plano 		= f.nr_sequencia
	and	a.nr_sequencia 		= b.nr_seq_lote_rem
	and	b.nr_sequencia 		= c.nr_seq_lote_rem_dest
	and	c.nr_sequencia 		= d.nr_seq_lote_rem_arq
	and	e.nr_sequencia 		= d.nr_seq_segurado
	and	coalesce(d.nr_seq_titular::text, '') = ''
	and	c.nr_sequencia		= nr_sequencia_p;

BEGIN

begin
select  substr(g.nm_pessoa_contato,1,40),
	substr(f.ds_email,1,50),
	substr(f.nr_ddi_telefone||f.nr_ddd_telefone||f.nr_telefone,1,20),
	b.dt_lote
into STRICT	nm_pessoa_contato_w,
	ds_email_w,
	nr_telefone_w,
	dt_lote_w
from	pls_ame_lote_rem_arquivo	d,
	pls_ame_lote_rem_destino	c,
	pls_ame_lote_remessa		b,
	pls_ame_regra_geracao		a,
	pls_ame_empresa			e,
	pessoa_juridica			f,
	pessoa_juridica_estab		g
where	d.nr_seq_lote_rem_dest		= c.nr_sequencia
and	c.nr_seq_lote_rem		= b.nr_sequencia
and	b.nr_seq_regra_geracao		= a.nr_sequencia
and	c.nr_seq_ame_empresa 		= e.nr_sequencia
and 	e.cd_cgc			= f.cd_cgc
and	g.cd_cgc			= g.cd_cgc
and	e.cd_cgc			= g.cd_cgc
and	g.cd_estabelecimento		= wheb_usuario_pck.get_cd_estabelecimento
and	d.nr_sequencia			= nr_sequencia_p;
exception
when others then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(359678);
end;

begin
arq_texto_w := utl_file.fopen(ds_local_p,nm_arquivo_p,'W');
exception
when others then
	if (SQLSTATE = -29289) then
		ds_erro_w  := 'O acesso ao arquivo foi negado pelo sistema operacional (access_denied).';
	elsif (SQLSTATE = -29298) then
		ds_erro_w  := 'O arquivo foi aberto usando FOPEN_NCHAR,  mas efetuaram-se operações de I/O usando funções nonchar comos PUTF ou GET_LINE (charsetmismatch).';
	elsif (SQLSTATE = -29291) then
		ds_erro_w  := 'Não foi possível apagar o arquivo (delete_failed).';
	elsif (SQLSTATE = -29286) then
		ds_erro_w  := 'Erro interno desconhecido no package UTL_FILE (internal_error).';
	elsif (SQLSTATE = -29282) then
		ds_erro_w  := 'O handle do arquivo não existe (invalid_filehandle).';
	elsif (SQLSTATE = -29288) then
		ds_erro_w  := 'O arquivo com o nome especificado não foi encontrado neste local (invalid_filename).';
	elsif (SQLSTATE = -29287) then
		ds_erro_w  := 'O valor de MAX_LINESIZE para FOPEN() é inválido; deveria estar na faixa de 1 a 32767 (invalid_maxlinesize).';
	elsif (SQLSTATE = -29281) then
		ds_erro_w  := 'O parâmetro open_mode na chamda FOPEN é inválido (invalid_mode).';
	elsif (SQLSTATE = -29290) then
		ds_erro_w  := 'O parâmetro ABSOLUTE_OFFSET para a chamada FSEEK() é inválido; deveria ser maior do que 0 e menor do que o número total de bytes do arquivo (invalid_offset).';
	elsif (SQLSTATE = -29283) then
		ds_erro_w  := 'O arquivo não pôde ser aberto ou operado da forma desejada - ou o caminho não foi encontrado (invalid_operation).';
	elsif (SQLSTATE = -29280) then
		ds_erro_w  := 'O caminho especificado não existe ou não está visível ao Oracle (invalid_path).';
	elsif (SQLSTATE = -29284) then
		ds_erro_w  := 'Não é possível efetuar a leitura do arquivo (read_error).';
	elsif (SQLSTATE = -29292) then
		ds_erro_w  := 'Não é possível renomear o arquivo.';
	elsif (SQLSTATE = -29285) then
		ds_erro_w  := 'Não foi possível gravar no arquivo (write_error).';
	else
		ds_erro_w  := 'Erro desconhecido no package UTL_FILE.';
	end if;
end;
if (ds_erro_w IS NOT NULL AND ds_erro_w::text <> '') then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(ds_erro_w);
end if;
ds_conteudo_w	:= 	'HEADR|"PHILIPS|"PHILIPS|"'||nm_pessoa_contato_w||'|"'||nr_telefone_w||'|"'||ds_email_w||
			'|"PHILIPSBR.P0015.'||formatar_data_mascara(dt_lote_w,'yyyymmdd_hh24miss')||
			'|"'||formatar_data_mascara(dt_lote_w,'yyyymmdd')||
			'|"'||formatar_data_mascara(dt_lote_w,'hh24miss')||
			'|"P|"1|"|"|"';
utl_file.put_line(arq_texto_w,ds_conteudo_w || chr(13));
utl_file.fflush(arq_texto_w);

qt_linhas_w	:= 1; --Começa com 1 contando o HEADER
for r_c01_w in C01 loop
	begin
	ds_conteudo_w	:= 	'P0015|"'||r_c01_w.cd_matricula||'|"BR|"000|"INS|"0015|"8090|"'||formatar_data_mascara(dt_lote_w,'yyyymmdd')||
				'|"'||formatar_data_mascara(dt_lote_w,'yyyymmdd')||'|"|"|"|"|"8090|"'||r_c01_w.vl_coparticipacao||'|"BRL'||
				'|"|"|"';
	utl_file.put_line(arq_texto_w,ds_conteudo_w || chr(13));
	utl_file.fflush(arq_texto_w);
	qt_linhas_w	:= qt_linhas_w + 1;
	end;
end loop;

ds_conteudo_w	:= 	'TRAIL|"'||to_char(qt_linhas_w+1); --Considerar a última linha
utl_file.put_line(arq_texto_w,ds_conteudo_w || chr(13));
utl_file.fflush(arq_texto_w);

utl_file.fclose(arq_texto_w);

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_ame_gerar_rh_philips ( nr_sequencia_p bigint, ds_local_p text, nm_arquivo_p text) FROM PUBLIC;

