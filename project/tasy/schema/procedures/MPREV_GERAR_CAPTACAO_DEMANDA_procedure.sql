-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE mprev_gerar_captacao_demanda (nr_seq_demanda_p bigint, nm_usuario_p text, nr_seq_captacao_p INOUT bigint, ie_commit_p text default 'S') AS $body$
DECLARE

 		
/* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Finalidade: Verificar se já existe captação para a demanda espontânea, caso não existir irá inserir uma captação.
-------------------------------------------------------------------------------------------------------------------

Locais de chamada direta: 
[  ]  Objetos do dicionário [X] Tasy (Delphi/Java) [  ] Portal [  ]  Relatórios [ ] Outros:
 ------------------------------------------------------------------------------------------------------------------

Pontos de atenção:
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */
nr_seq_captacao_w	bigint;
cd_pessoa_fisica_w	varchar(10);


BEGIN

begin
	select	max(x.nr_sequencia)
	into STRICT	nr_seq_captacao_w
	from	mprev_captacao x
	where	x.nr_seq_demanda_espont = nr_seq_demanda_p;
exception	
	when	no_data_found then
		nr_seq_captacao_w := null;
end;
if (coalesce(nr_seq_captacao_w::text, '') = '') then

	select	nextval('mprev_captacao_seq')
	into STRICT	nr_seq_captacao_w
	;

	select	y.cd_pessoa_fisica
	into STRICT	cd_pessoa_fisica_w
	from	mprev_demanda_espont y
	where	y.nr_sequencia = nr_seq_demanda_p;

	insert	into mprev_captacao(nr_sequencia, dt_atualizacao, nm_usuario, dt_atualizacao_nrec, nm_usuario_nrec,
				    cd_pessoa_fisica, nr_seq_demanda_espont, ie_status,
				    ie_origem)
			   values (nr_seq_captacao_w, clock_timestamp(), nm_usuario_p, clock_timestamp(), nm_usuario_p,
				    cd_pessoa_fisica_w, nr_seq_demanda_p, 'N', 
				    'DE');
	if (ie_commit_p = 'S') then
		commit;
	end if;
end if;
	
nr_seq_captacao_p := nr_seq_captacao_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE mprev_gerar_captacao_demanda (nr_seq_demanda_p bigint, nm_usuario_p text, nr_seq_captacao_p INOUT bigint, ie_commit_p text default 'S') FROM PUBLIC;

