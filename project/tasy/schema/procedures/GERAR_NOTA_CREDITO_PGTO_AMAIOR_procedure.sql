-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_nota_credito_pgto_amaior ( nr_seq_movto_trans_p bigint, cd_pessoa_fisica_p text, cd_cgc_p text, nr_seq_pagador_p bigint, dt_baixa_p timestamp, vl_transacao_p bigint, ie_acao_p text, cd_estabelecimento_p bigint, nm_usuario_p text) AS $body$
DECLARE


vl_saldo_nota_w			double precision;
nr_seq_nota_credito_w		bigint;
nr_seq_movto_w				movto_trans_financ.nr_seq_movto_orig%type;
vl_nota_credito_w		nota_credito.vl_nota_credito%type;
/* Projeto Multimoeda - Variáveis */

vl_transacao_estrang_w	double precision;
vl_complemento_w	double precision;
vl_cotacao_w		cotacao_moeda.vl_cotacao%type;
cd_moeda_w		integer;
vl_baixa_estrang_w	double precision;
cd_moeda_empresa_w	integer;


BEGIN
/* Projeto Multimoeda - Busca a moeda padrão da empresa */

select	obter_moeda_padrao_empresa(cd_estabelecimento_p,'E')
into STRICT	cd_moeda_empresa_w
;

if (ie_acao_p = 'I') then
	/* Projeto Multimoeda - Busca os dados da transação*/

	select max(vl_transacao_estrang),
		max(vl_cotacao),
		max(cd_moeda)
	into STRICT vl_transacao_estrang_w,
		vl_cotacao_w,
		cd_moeda_w
	from movto_trans_financ
	where nr_sequencia = nr_seq_movto_trans_p;
	/* Projeto Multimoeda - verifica a existência de valor em moeda estrangeira, caso não exista limpa os campos correspondentes */

	if (coalesce(vl_transacao_estrang_w,0) <> 0) then
		vl_complemento_w := vl_transacao_p - vl_transacao_estrang_w;
	else
		vl_transacao_estrang_w	:= null;
		vl_complemento_w	:= null;
		vl_cotacao_w		:= null;
		cd_moeda_w		:= null;
	end if;

	insert into nota_credito(nr_sequencia,
		cd_estabelecimento,
		dt_atualizacao,
		nm_usuario,
		dt_atualizacao_nrec,
		nm_usuario_nrec,
		vl_nota_credito,
		cd_pessoa_fisica,
		cd_cgc,
		nr_seq_pagador_aprop,
		dt_nota_credito,
		dt_vencimento,
		tx_juros,
		tx_multa,
		cd_tipo_taxa_juro,
		cd_tipo_taxa_multa,
		ie_origem,
		vl_saldo,
		nr_lote_contabil,
		ds_observacao,
		ie_situacao,
		nr_seq_movto_origem,
		vl_nota_cred_estrang,
		vl_complemento,
		vl_cotacao,
		cd_moeda)
	values (nextval('nota_credito_seq'),
		cd_estabelecimento_p,
		clock_timestamp(),
		nm_usuario_p,
		clock_timestamp(),
		nm_usuario_p,
		vl_transacao_p,
		cd_pessoa_fisica_p,
		cd_cgc_p,
		nr_seq_pagador_p,
		dt_baixa_p,
		null,
		null,
		null,
		null,
		null,
		'M',
		vl_transacao_p,
		null,
		wheb_mensagem_pck.get_texto(305694),
		'A',
		nr_seq_movto_trans_p,
		vl_transacao_estrang_w,
		vl_complemento_w,
		vl_cotacao_w,
		cd_moeda_w);

else

	select	max(nr_sequencia)
	into STRICT	nr_seq_nota_credito_w
	from	nota_credito a
	where	a.nr_seq_movto_origem	= nr_seq_movto_trans_p
	and	a.ie_situacao		<> 'C';

	if (coalesce(nr_seq_nota_credito_w::text, '') = '') then /*No select de cima busca pelo movimento bancario de estorno e não encontra. Aqui irá procurar pelo movimento que  esta originando o estorno*/
		select	max(a.nr_seq_movto_orig) /*aqui busca o movto de origem desse movimento de estorno*/
		into STRICT	nr_seq_movto_w
		from	movto_trans_financ a
		where 	a.nr_sequencia	= nr_seq_movto_trans_p;

		if (nr_seq_movto_w IS NOT NULL AND nr_seq_movto_w::text <> '') then

			select	max(nr_sequencia) /*aqui tenta localizar a  nota de credito pelo movimento que originou o estorno.*/
			into STRICT	nr_seq_nota_credito_w
			from	nota_credito a
			where	a.nr_seq_movto_origem	= nr_seq_movto_w
			and	a.ie_situacao		<> 'C';

			if (nr_seq_nota_credito_w IS NOT NULL AND nr_seq_nota_credito_w::text <> '') then

				select	max(a.vl_saldo),
						max(a.vl_nota_credito)
				into STRICT	vl_saldo_nota_w,
						vl_nota_credito_w
				from	nota_credito a
				where	a.nr_sequencia = nr_seq_nota_credito_w;

				if ( coalesce(vl_saldo_nota_w,0) <> coalesce(vl_nota_credito_w,0) ) then
					CALL Wheb_mensagem_pck.exibir_mensagem_abort(323841);
				end if;

			end if;

		end if;

	end if;

	if (nr_seq_nota_credito_w IS NOT NULL AND nr_seq_nota_credito_w::text <> '') then
		select	vl_saldo,
			vl_cotacao,
			cd_moeda
		into STRICT	vl_saldo_nota_w,
			vl_cotacao_w,
			cd_moeda_w
		from	nota_credito a
		where	a.nr_sequencia	= nr_seq_nota_credito_w;

		/* Projeto Multimoeda - Verifica se a nota de crédito é moeda estrangeira, caso positivo calcula os valores para gravar na baixa */

		if (coalesce(vl_cotacao_w,0) <> 0 and coalesce(cd_moeda_w,cd_moeda_empresa_w) <> cd_moeda_empresa_w) then
			vl_baixa_estrang_w := vl_saldo_nota_w / vl_cotacao_w;
			vl_complemento_w := vl_saldo_nota_w - vl_baixa_estrang_w;
		else
			vl_baixa_estrang_w := null;
			vl_complemento_w := null;
			vl_cotacao_w := null;
			cd_moeda_w := null;
		end if;

		insert into nota_credito_baixa(nr_sequencia,
			nm_usuario,
			dt_atualizacao,
			nm_usuario_nrec,
			dt_atualizacao_nrec,
			nr_seq_nota_credito,
			dt_baixa,
			vl_baixa,
			ie_cancelamento,
			vl_baixa_estrang,
			vl_complemento,
			vl_cotacao,
			cd_moeda)
		values (nextval('nota_credito_baixa_seq'),
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			nr_seq_nota_credito_w,
			coalesce(dt_baixa_p,clock_timestamp()),
			vl_saldo_nota_w,
			'S',
			vl_baixa_estrang_w,
			vl_complemento_w,
			vl_cotacao_w,
			cd_moeda_w);

		CALL atualizar_saldo_nota_credito(nr_seq_nota_credito_w,nm_usuario_p);
	end if;
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_nota_credito_pgto_amaior ( nr_seq_movto_trans_p bigint, cd_pessoa_fisica_p text, cd_cgc_p text, nr_seq_pagador_p bigint, dt_baixa_p timestamp, vl_transacao_p bigint, ie_acao_p text, cd_estabelecimento_p bigint, nm_usuario_p text) FROM PUBLIC;

