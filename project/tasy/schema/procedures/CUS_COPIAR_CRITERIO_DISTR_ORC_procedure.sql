-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';



CREATE TYPE campos AS (		nr_seq_old 	bigint, 
				nr_seq_new 	bigint);


CREATE OR REPLACE PROCEDURE cus_copiar_criterio_distr_orc ( cd_estabelecimento_p bigint, cd_tabela_origem_p bigint, cd_tabela_destino_p bigint, cd_sequencia_criterio_p bigint, nr_seq_tabela_origem_p bigint, nr_seq_tabela_destino_p bigint, nm_usuario_p text) AS $body$
DECLARE

				
type vetor is table of campos index 	by integer;

nr_sequencia_criterio_w		bigint;
cd_sequencia_criterio_w         	bigint;
cd_estabelecimento_w              	smallint;
cd_tabela_custo_w                 	integer;
qt_base_distribuicao_w            	double precision;
vl_fixo_w				double precision;
ds_base_distribuicao_w            	varchar(200);
nr_seq_distribuicao_w             	bigint;
cd_natureza_gasto_orig_w          	numeric(20);
cd_natureza_gasto_dest_w          	numeric(20);
dt_atualizacao_w			timestamp;
nm_usuario_w			varchar(15);
cd_centro_controle_w              	integer;
cd_grupo_natureza_gasto_w 		integer;
nr_seq_gng_w			bigint;
nr_seq_gng_ref_w			bigint;
cd_natureza_gasto_w		numeric(20);
ie_criterio_distribuicao_w		varchar(1);
ie_criterio_valor_w			varchar(1);
ie_criterio_centro_w			varchar(1);
nr_seq_criterio_ref_w		bigint;
pr_distribuir_w			real := 0;
i				integer := 1;
vetor_proc_w			vetor;
ie_tipo_gasto_w			varchar(15);
ie_limitado_w			varchar(1);
ds_view_w			varchar(30);
nr_seq_ng_orig_w			bigint;
nr_seq_ng_w			bigint;
nr_seq_ng_dest_w			bigint;
nr_seq_ng_ref_w			bigint;
ie_copiar_centros_destino_w		varchar(1);
ie_copiar_w			varchar(1);

c01 CURSOR FOR
SELECT	cd_sequencia_criterio,
	cd_estabelecimento,
	cd_tabela_custo,
	qt_base_distribuicao,
	ds_base_distribuicao,
	nr_seq_distribuicao,
	cd_natureza_gasto_orig,
	cd_centro_controle,
	cd_grupo_natureza_gasto,
	cd_natureza_gasto,
	ie_criterio_distribuicao,
	ie_criterio_valor,
	ie_criterio_centro,
	nr_seq_criterio_ref,
	pr_distribuir,
	cd_natureza_gasto_dest,
	ie_tipo_gasto,
	vl_fixo,
	coalesce(ie_limitado,'N'),
	ds_view,
	nr_seq_gng,
	nr_seq_gng_ref,
	nr_seq_ng_orig,
	nr_seq_ng,
	nr_seq_ng_dest,
	nr_seq_ng_ref
from	criterio_distr_orc
where	/*cd_estabelecimento		= cd_estabelecimento_p and*/
		
	nr_seq_tabela		= nr_seq_tabela_origem_p
and	cd_sequencia_criterio	= cd_sequencia_criterio_p
/*OS1992919 - Jean - Projeto Da vita - Inicio */

and	exists (	SELECT	1
		from	tabela_custo_acesso_v tca
		where	tca.nr_sequencia	= nr_seq_tabela_origem_p
		and	tca.cd_estabelecimento	= cd_estabelecimento);
/*OS1992919 - Jean - Projeto Da vita - Final*/

BEGIN

if (cd_tabela_origem_p = cd_tabela_destino_p) then
	
	/*'Não é permitida a cópia dos critérios para a própria tabela de origem!#@#@');*/

	CALL wheb_mensagem_pck.exibir_mensagem_abort(195424);
	
end if;

open c01;
loop
fetch c01 into
 	cd_sequencia_criterio_w,
	cd_estabelecimento_w,
	cd_tabela_custo_w,
	qt_base_distribuicao_w,
	ds_base_distribuicao_w,
	nr_seq_distribuicao_w,
	cd_natureza_gasto_orig_w,
	cd_centro_controle_w,
	cd_grupo_natureza_gasto_w,
	cd_natureza_gasto_w,
	ie_criterio_distribuicao_w,
	ie_criterio_valor_w,
	ie_criterio_centro_w,
	nr_seq_criterio_ref_w,
	pr_distribuir_w,
	cd_natureza_gasto_dest_w,
	ie_tipo_gasto_w,
	vl_fixo_w,
	ie_limitado_w,
	ds_view_w,
	nr_seq_gng_w,
	nr_seq_gng_ref_w,
	nr_seq_ng_orig_w,
	nr_seq_ng_w,
	nr_seq_ng_dest_w,
	nr_seq_ng_ref_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	begin
	
	ie_copiar_centros_destino_w	:= coalesce(obter_valor_param_usuario(927, 43, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w), 'N');

	ie_copiar_w	:= 'S';
	select	nextval('criterio_distr_orc_seq')
	into STRICT	nr_sequencia_criterio_w
	;
	
	insert into criterio_distr_orc(
		cd_sequencia_criterio,
		cd_estabelecimento,
		cd_tabela_custo,
		qt_base_distribuicao,
		ds_base_distribuicao,
		nr_seq_distribuicao,
		cd_natureza_gasto_orig,
		cd_centro_controle,
		cd_grupo_natureza_gasto,
		cd_natureza_gasto,
		dt_atualizacao,
		nm_usuario,
		ie_criterio_distribuicao,
		ie_criterio_valor,
		ie_criterio_centro,
		nr_seq_criterio_ref,
		pr_distribuir,
		cd_natureza_gasto_dest,
		ie_tipo_gasto,
		vl_fixo,
		ie_limitado,
		ds_view,
		nr_seq_gng,
		nr_seq_gng_ref,
		nr_seq_ng_orig,
		nr_seq_ng,
		nr_seq_ng_dest,
		nr_seq_ng_ref,
		nm_usuario_nrec,
		dt_atualizacao_nrec,
		ie_revisado,
		nr_seq_tabela)
	values (	nr_sequencia_criterio_w,
		cd_estabelecimento_w,
		cd_tabela_destino_p,
		qt_base_distribuicao_w,
		ds_base_distribuicao_w,
		nr_seq_distribuicao_w,
		cd_natureza_gasto_orig_w,
		cd_centro_controle_w,
		cd_grupo_natureza_gasto_w,
		cd_natureza_gasto_w,
		clock_timestamp(),
		nm_usuario_p,
		ie_criterio_distribuicao_w,
		ie_criterio_valor_w,
		ie_criterio_centro_w,
		nr_seq_criterio_ref_w,
		pr_distribuir_w,
		cd_natureza_gasto_dest_w,
		ie_tipo_gasto_w,
		vl_fixo_w,
		ie_limitado_w,
		ds_view_w,
		nr_seq_gng_w,
		nr_seq_gng_ref_w,
		nr_seq_ng_orig_w,
		nr_seq_ng_w,
		nr_seq_ng_dest_w,
		nr_seq_ng_ref_w,
		nm_usuario_p,
		clock_timestamp(),
		'N',
		nr_seq_tabela_destino_p);
		
	
	if (ie_copiar_centros_destino_w = 'N') and (ie_criterio_centro_w = 'C') then
		
		ie_copiar_w	:= 'N';
		
	end if;
	
	insert into criterio_distr_orc_dest(
		cd_sequencia_criterio,
		cd_estabelecimento,
		cd_centro_controle_dest,
		qt_distribuicao,
		pr_distribuicao,
		cd_natureza_gasto_dest,
		dt_atualizacao,
		nm_usuario,
		qt_peso,
		nr_seq_ng_dest,
		dt_atualizacao_nrec,
		nm_usuario_nrec)
	SELECT	nr_sequencia_criterio_w,
		cd_estabelecimento,
		cd_centro_controle_dest,
		qt_distribuicao,
		pr_distribuicao,
		cd_natureza_gasto_dest,
		dt_atualizacao,
		nm_usuario,
		qt_peso,
		nr_seq_ng_dest,
		clock_timestamp(),
		nm_usuario_p
	from	criterio_distr_orc_dest
	where	cd_sequencia_criterio	= cd_sequencia_criterio_w
	and	ie_copiar_w		= 'S';
	
	vetor_proc_w[i].nr_seq_old 	:= cd_sequencia_criterio_w;
	vetor_proc_w[i].nr_seq_new 	:= nr_sequencia_criterio_w;
	i := i + 1;
	end;
end loop;
close c01;
for i in 1..vetor_proc_w.count loop
	update	criterio_distr_orc
	set	nr_seq_criterio_ref	= vetor_proc_w[i].nr_seq_new
	where	nr_seq_criterio_ref	= vetor_proc_w[i].nr_seq_old
	and	nr_seq_tabela		= nr_seq_tabela_destino_p;
end loop;

commit;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cus_copiar_criterio_distr_orc ( cd_estabelecimento_p bigint, cd_tabela_origem_p bigint, cd_tabela_destino_p bigint, cd_sequencia_criterio_p bigint, nr_seq_tabela_origem_p bigint, nr_seq_tabela_destino_p bigint, nm_usuario_p text) FROM PUBLIC;

