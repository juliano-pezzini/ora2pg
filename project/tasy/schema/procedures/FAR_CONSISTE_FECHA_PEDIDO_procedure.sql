-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE far_consiste_fecha_pedido ( nr_seq_pedido_p bigint, ds_consistencia_p INOUT text, ie_libera_p INOUT text) AS $body$
DECLARE


dt_ult_compra_w			timestamp;
cd_material_w			bigint;
cd_grupo_material_w		integer;
cd_subgrupo_material_w		integer;
cd_classe_material_w		integer;
qt_medic_cont_w			bigint;
qt_material_pedido_w		bigint;
ie_libera_w			varchar(1);
ie_exige_crm_w			varchar(1);
cd_pessoa_fisica_w		varchar(10);
ds_material_w			varchar(255);
ds_consistencia_w			varchar(4000);
nr_crm_w			varchar(20);
ie_consiste_w		varchar(1);

c01 CURSOR FOR
SELECT	b.cd_material,
	b.cd_grupo_material,
	b.cd_subgrupo_material,
	b.cd_classe_material,
	b.ds_material
from	far_pedido_item a,
	estrutura_material_v b
where	b.cd_material = a.cd_material
and	a.nr_seq_pedido = nr_seq_pedido_p;

c02 CURSOR FOR
SELECT	cd_material
from	far_medic_uso_continuo a
where	cd_pessoa_fisica = cd_pessoa_fisica_w;


BEGIN

ds_consistencia_w	:= '';
ie_libera_w	:= 'S';

select	nr_crm
into STRICT	nr_crm_w
from	far_pedido
where	nr_sequencia = nr_seq_pedido_p;

open c01;
loop
fetch c01 into
	cd_material_w,
	cd_grupo_material_w,
	cd_subgrupo_material_w,
	cd_classe_material_w,
	ds_material_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	begin

	select	coalesce(max(ie_exige_crm),'N')
	into STRICT	ie_exige_crm_w
	from	far_regra_mat_pedido
	where (coalesce(cd_material,cd_material_w) = cd_material_w)
	and (coalesce(cd_grupo_material,cd_grupo_material_w) = cd_grupo_material_w)
	and (coalesce(cd_subgrupo_material,cd_subgrupo_material_w) = cd_subgrupo_material_w)
	and (coalesce(cd_classe_material,cd_classe_material_w) = cd_classe_material_w);

	if (ie_exige_crm_w = 'S') and (coalesce(nr_crm_w::text, '') = '') then
		begin
		ds_consistencia_w := substr(wheb_mensagem_pck.get_texto(313977,'DS_CONSISTENCIA_W='|| DS_CONSISTENCIA_W ||';DS_MATERIAL_W='|| DS_MATERIAL_W),1,4000);
						/*#@DS_CONSISTENCIA_W#@ É obrigatório informar o CRM do prescritor para o medicamento #@DS_MATERIAL_W#@.*/

		ie_libera_w := 'N';
		end;
	end if;

	end;
end loop;
close c01;

select	cd_pessoa_fisica
into STRICT	cd_pessoa_fisica_w
from	far_pedido
where	nr_sequencia = nr_seq_pedido_p;

select	count(*)
into STRICT	qt_medic_cont_w
from	far_medic_uso_continuo
where	cd_pessoa_fisica = cd_pessoa_fisica_w;

if (qt_medic_cont_w > 0) then
	begin

	open c02;
	loop
	fetch c02 into
		cd_material_w;
	EXIT WHEN NOT FOUND; /* apply on c02 */
		begin

		select	count(*)
		into STRICT	qt_material_pedido_w
		from	far_pedido_item
		where	nr_seq_pedido = nr_seq_pedido_p
		and	cd_material = cd_material_w;

		if (qt_material_pedido_w <> 0) then
			begin

			ie_consiste_w:= far_obter_se_continuo(cd_pessoa_fisica_w,cd_material_w);

			if (ie_consiste_w = 'S') then
				begin

				select	ds_material
				into STRICT	ds_material_w
				from	material
				where	cd_material = cd_material_w;

				ds_consistencia_w	:= substr(wheb_mensagem_pck.get_texto(313978,'DS_CONSISTENCIA_W='|| DS_CONSISTENCIA_W ||';DS_MATERIAL_W='|| DS_MATERIAL_W),1,4000);
									/*#@DS_CONSISTENCIA_W#@ O medicamento de uso contínuo #@DS_MATERIAL_W#@ não é comprado a mais de 10 dias.*/

				end;
			end if;

			end;
		end if;

		end;
	end loop;
	close c02;

	end;
end if;

ds_consistencia_p	:= ds_consistencia_w;
ie_libera_p	:= ie_libera_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE far_consiste_fecha_pedido ( nr_seq_pedido_p bigint, ds_consistencia_p INOUT text, ie_libera_p INOUT text) FROM PUBLIC;

