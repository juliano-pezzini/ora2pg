-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE consistir_item_nota_fiscal ( nr_sequencia_p bigint, nr_item_nf_p bigint, nm_usuario_p text, ds_erro_p INOUT text, ie_acao_p text DEFAULT 'N') AS $body$
DECLARE


/*ie_acao_p - Indica o momento que esta sendo chamado a procedure.
N - Padrao do sistema
S - Quando salva o item na nota fiscal*/
cd_unidade_medida_compra_w		varchar(30);
cd_unidade_medida_ordem_w		varchar(30);
cd_unidade_medida_estoque_w		varchar(30);
cd_unidade_compra_material_w		varchar(30);
cd_unidade_estoque_material_w		varchar(30);
qt_conv_compra_estoque_w		double precision;
cd_cgc_w				varchar(14);
cd_cgc_emitente_w			varchar(14);
cd_conta_contabil_w			varchar(20);
cd_conta_contabil_nota_w		varchar(20);
cd_lote_fabricacao_w			varchar(20);
cd_lote_fabricacao_ww			varchar(20);
cd_estabelecimento_w			smallint;
cd_material_w				integer;
nr_seq_marca_w				bigint;
cd_material_generico_w			integer;
cd_material_estoque_w			integer;
cd_material_gen_oci_w			integer;
cd_material_est_oci_w			integer;
cd_material_ordem_w			integer;
cd_natureza_nota_w			smallint;
cd_natureza_item_w			smallint;
cd_local_estoque_w			smallint;
cd_centro_custo_w			integer;
qt_existe_rate_w			bigint;
cd_conta_contabil_rateito_w 		nota_fiscal_item_rateio.cd_conta_contabil%type;
cd_operacao_nota_w			smallint;
cd_local_conta_w			smallint	:= NULL;
cd_cond_pagto_oc_w			bigint;
cd_cond_pagto_nf_w			bigint;
ds_erro_w				varchar(4000);
ds_erro_grupo_conta_w			varchar(255);
ds_material_w				varchar(255);
dt_mesano_referencia_w			timestamp;
dt_validade_w				timestamp;
dt_validade_lote_w			timestamp;
ie_consignado_material_w		varchar(1);
ie_consiste_venc_contrato_w		varchar(1);
ie_consignado_operacao_w		varchar(1);
ie_local_valido_w			varchar(1);
ie_material_estoque_w			varchar(1);
ie_consiste_dt_validade_w		varchar(1);
ie_altera_material_w			varchar(1);
ie_consiste_ordem_compra_w		varchar(1);
ie_obriga_conta_contabil_mat_w		varchar(1);
ie_obriga_conta_cont_proc_w		varchar(1);
ie_consumo_w				varchar(1);
ie_coluna_resumo_w			varchar(1);
ie_ent_sai_op_estoque_w			varchar(1);
ie_situacao_w				varchar(1);
ie_situacao_controlador_w		varchar(1);
ie_situacao_ww				varchar(1);
ie_estoque_lote_w			varchar(1);
ie_tipo_requisicao_w			varchar(3);
ie_consig_w				boolean;
ie_local_direto_w			smallint;
ie_tipo_conta_w				smallint;
ie_clinica_w				integer;
nr_ordem_compra_w			bigint;
nr_item_oci_w				integer;
pr_dif_valor_nota_ordem_w		double precision;
pr_dif_quant_nota_ordem_w		double precision;
ie_dif_valor_nota_ordem_w		varchar(1);
ie_dif_quant_nota_ordem_w		varchar(5);
qt_item_nf_w				double precision 	:= 0;
qt_item_nf_ww				double precision 	:= 0;
qt_item_nf_total_w			double precision 	:= 0;
qt_total_item_nf_w			double precision 	:= 0;
qt_item_nf_aConsistir_w			double precision 	:= 0;
qt_estoque_w				double precision;
qt_saldo_ordem_w			double precision;
qt_valor_max_ordem_w			double precision;
qt_valor_min_ordem_w			double precision;
qt_entrega_real_ordem_w			double precision;
qt_prevista_entrega_w			double precision;
qt_saldo_ordem_ww			double precision;
qt_item_rateio_w			bigint;
qt_falta_lote_w				smallint;
qt_item_rateio_inativo_w		integer;
vl_unitario_item_nf_w			double precision 	:= 0;
vl_unitario_ordem_w			double precision;
vl_total_item_nf_w			nota_fiscal_item.vl_total_item_nf%type;
vl_arredondamento_w			double precision;
vl_rateio_w				double precision;
qt_rateio_w				double precision;
vl_dif_item_w				double precision;
vl_diferenca_w				double precision;
ie_consiste_saldo_dev_w			varchar(1);
ie_regra_dif_valor_w			varchar(1);
ie_regra_dif_quant_w			varchar(1);
ie_consiste_validade_anvisa_w		varchar(1);
ie_consiste_valid_marca_mat_w		varchar(1);
qt_validade_vencida_w			smallint;
dt_validade_anvisa_marca_w		timestamp;
qt_existe_rateio_w			smallint;
nr_contrato_w				bigint;
vl_liquido_w				double precision;
vl_liquido_item_w			double precision;
vl_unitario_diferenca_w			double precision;
vl_total_contrato_w			double precision;
ie_consiste_just_contrato_w		varchar(1);
ie_obriga_just_contrato_w		varchar(1);
dt_entrada_saida_w			timestamp;
ie_conta_vigente_w			varchar(1);
ds_justificativa_w			varchar(255);
ie_tipo_nota_w				varchar(3);
ie_obriga_local_centro_w		varchar(20);
ie_obriga_local_centro_ww		varchar(20);
nr_seq_conta_financ_w			bigint;
ie_sit_conta_fin_w			varchar(1);
ie_tipo_material_w			varchar(3);
ie_consiste_med_generico_w		varchar(1);
ie_forma_vinc_nota_consig_w		varchar(1);
cd_oper_nota_ent_vinc_consig_w		smallint;
cd_oper_nota_fat_vinc_consig_w		smallint;
qt_item_sem_vinc_consig_w		integer;
ie_obriga_w				varchar(10);
dt_prevista_entrega_w			timestamp;
qt_dias_entrega_antecipada_w		integer;
dt_prevista_oci_w			timestamp;
dt_registro_w				timestamp;
ie_consiste_qt_item_saldo_oc_w		varchar(01);
ie_consiste_local_w			varchar(01);
ie_atualiza_estoque_w			varchar(01);
qt_existe_regra_w			bigint;
ie_consiste_nr_atend_w			varchar(01);
nr_atendimento_w	                nota_fiscal_item.nr_atendimento%type;
qt_existe_w				bigint;
ie_avisa_emprestimo_aberto_w		varchar(1);
ie_permite_nat_diferente_w		varchar(1);
ie_tipo_ordem_w				varchar(1);
nr_emprestimo_w				bigint;
nr_seq_item_emprestimo_w		bigint;
qt_emprestimo_w				double precision;
qt_nota_fiscal_w			double precision;
qt_falta_gerar_nota_w			double precision;
cd_procedimento_w			bigint;
pr_variacao_param_w			bigint;
vl_ultima_compra_w			double precision;
vl_dif_ultima_compra_w			double precision;
ie_consiste_vl_compra_w			varchar(1);
pr_variacao_valor_w			varchar(3);
ie_mat_estoque_local_direto_w		varchar(1);
ie_conta_financeira_w			varchar(1);
ie_qualificado_w			varchar(15) := 'S';
dt_lib_estrut_pj_w			timestamp := NULL;
ie_valor_considerar_w			varchar(1);
ie_consiste_se_mat_contr_w		varchar(1);
qt_controlador_w			bigint;
ds_marca_w				varchar(255);
ds_status_marca_w			varchar(255);
ie_periodo_nf_w				varchar(15);
qt_maximo_nf_periodo_w			integer;
qt_dias_periodo_w			bigint;
ie_consiste_vl_brasindice_w		varchar(1);
ie_consiste_vl_simpro_item_w		varchar(1);
vl_preco_brasindice_w			double precision := 0;
vl_preco_simpro_w			double precision := 0;
cd_convenio_w				bigint;
dt_ult_vigencia_w			timestamp;
ie_exige_centro_loc_direto_w		varchar(1);
ie_estrutura_lib_w			varchar(1);
ie_consiste_qt_pend_oc_w		varchar(1);
qt_pendente_entrega_w			double precision;
ie_consiste_status_marca_w		varchar(1);
ie_consiste_status_marca_ww		varchar(1);
ie_consiste_nat_contrato_w		varchar(1);
ie_consiste_unid_contrato_w		varchar(1);
nr_seq_regra_contrato_w			bigint;
nr_seq_preco_pj_w			bigint;
cd_natureza_contrato_w			bigint;
cd_unid_med_contrato_w			varchar(30);
ie_consiste_nat_regra_pj_w		varchar(30);
ie_consiste_unid_regra_pj_w		varchar(30);
cd_natureza_regra_pj_w			bigint;
cd_unid_med_regra_pj_w			varchar(30);
ie_preco_w				varchar(1);
ie_quantidade_w				varchar(1);
vl_pagto_w				double precision;
ie_devolucao_w				varchar(1);
ie_consiste_cm_nf_dev_w			varchar(1);
vl_custo_w				double precision;
ie_desp_aces_rateio_itens_w		varchar(1);
vl_tot_item_nf_desp_w			double precision := 0;
vl_despesa_acessoria_w			double precision := 0;
vl_soma_itens_w				double precision;
cd_perfil_w				bigint;
ie_exige_marca_w			varchar(1);
ie_exige_fabric_w			varchar(1);
qt_existe_exigencia_regra_w		bigint;
ie_exige_ca_w				varchar(1);
ie_exige_anvisa_w			varchar(1);
qt_item_lote_w				double precision;
qt_item_estoque_w			double precision;
ie_consiste_entrega_dif_oc_w		varchar(1);
qt_material_fixa_w			double precision;
vl_conv_moeda_w				double precision;
ie_consiste_mat_fiscal_w		varchar(1);
ie_consiste_marca_oc			varchar(1);
nr_seq_ncm_w				bigint;
nr_seq_marca_oci_w			bigint;
pr_variacao_param_360_w			bigint;
ie_atualiza_ult_compra_w		varchar(1);
cd_tab_preco_mat_w			bigint;
qt_existe_preco_tab_w			bigint;
ie_permite_conta_financ_w		varchar(1);
dt_entrega_limite_w			timestamp;
ie_consiste_entrega_limite_w		varchar(1);
nr_seq_inspecao_w			bigint;
ie_exige_reg_anvisa_w			varchar(1);
ie_exige_reg_anvisa_param_w		varchar(1);
ds_orientacao_reg_anv_w			varchar(255);
nr_registro_anvisa_w			varchar(60);
cd_fabric_marca_w			varchar(14);
ie_possui_doc_venc_w			varchar(1);
ie_consiste_doc_vencido_w		varchar(1);
ie_obriga_serie_w			varchar(1);
nr_serie_material_w			varchar(80);
ie_controla_serie_w			varchar(1);
ie_permite_item_sem_contrato_w		varchar(1);
ie_centro_custo_nf_w			varchar(1);
vl_preco_material_w			double precision;
cd_tabela_preco_param_w			bigint;
ie_gera_lote_fornec_w			varchar(1);
qt_existe_item_lote_w			integer;
nr_item_nf_w				integer;
ie_gera_w				varchar(1);
ie_gerar_desdobrado_w			varchar(1);
qt_lote_gerado_w			bigint := 0;
ie_regra_lote_nf_w			varchar(1) := 'N';
ie_indeterminado_w			varchar(1);
cd_controlador_w			bigint;
nr_seq_mat_simpro_w			bigint;
nr_seq_simpro_preco_w			bigint;
ie_classif_fiscal_nf_w			varchar(1);
ie_consiste_dev_qt_maior_w		varchar(1);
qt_ja_devolvida_w			double precision;
qt_entrada_w				double precision;
qt_total_devolver_w			double precision := 0;
ie_consiste_proj_rec_w			funcao_param_usuario.vl_parametro%type;
nr_seq_proj_rec_ordem_w			projeto_recurso.nr_sequencia%type;
nr_seq_proj_rec_nf_w			projeto_recurso.nr_sequencia%type;
ie_permite_indeterm_w			regra_validade_indeterm.ie_permite_indeterm%type;
ie_indeterminado_lote_w			nota_fiscal_item_lote.ie_indeterminado%type;
ie_fornecedor_oc_nf_w			varchar(1) := 'N';
cd_cgc_fornecedor_oc_w			ordem_compra.cd_cgc_fornecedor%type;
ds_acao_lote_w				lote_fornec_restricao.ds_acao%type;
ie_consiste_fornec_w			funcao_param_usuario.vl_parametro%type;
ie_situacao_estoque_w			local_estoque.ie_situacao%type;
qt_dias_minimo_validade_w		regra_val_minima_lote.qt_dias_validade_lote%type;
qt_dias_validade_w			bigint;
ie_param_465_w				varchar(1);
ie_param_470_w				varchar(1);
ie_acao_w				varchar(1);
nr_seq_far_venda_w			nota_fiscal.nr_seq_far_venda%type;
ie_vigente_anvisa_w  		material_estab.ie_vigente_anvisa%type;
cd_material_estoque_mat_w               bigint;
vl_item_liquido_w			double precision;
dt_mesa_verif_w				timestamp;
dt_base_w				timestamp;
ie_exige_aval_solic_servico_w		sup_regra_consistencia_nf.ie_exige_aval_solic_servico%type;
ie_tipo_compra_w			solic_compra.ie_tipo_compra%type;
nr_solic_compra_w			solic_compra.nr_solic_compra%type;
ie_vigente_anvisa_marca_w	material_marca.ie_vigente_anvisa%type;
ie_param_485_w				varchar(1);
ds_observacao_lote_w			varchar(255);
ie_param_100_w				funcao_param_usuario.vl_parametro%type;
ie_consiste_fixos_contrato_w		varchar(1);
ds_justificativa_ww			nota_fiscal_item.ds_justificativa%type;
qt_reg_conferencia_w		bigint;
ie_agrupar_lote_w 			regra_nf_lote_fornec.ie_agrupar_lote%type;
dt_inicio_vigencia_w    		PESSOA_JUR_CNAE_SEC.dt_inicio_vigencia%type;
dt_fim_vigencia_w    			PESSOA_JUR_CNAE_SEC.dt_fim_vigencia%type;
nr_seq_cnae_w           		MATERIAL_FISCAL.NR_SEQ_CNAE%type;
ie_consiste_calculo_w			varchar(1);

C01 CURSOR FOR
	SELECT	cd_lote_fabricacao,
		coalesce(ie_indeterminado,'N'),
		dt_validade
	FROM	nota_fiscal_item_lote
	WHERE	nr_seq_nota = nr_sequencia_p
	AND	nr_item_nf = nr_item_nf_p;

C02 CURSOR FOR
	SELECT	coalesce(a.cd_conta_contabil,b.cd_conta_contabil)
	FROM	nota_fiscal_item_rateio a,
		nota_fiscal_item b
	WHERE	b.nr_sequencia	= a.nr_seq_nota
	AND 	b.nr_item_nf	= a.nr_item_nf
	AND 	b.nr_sequencia	= nr_sequencia_p
	AND	b.nr_item_nf	= nr_item_nf_p;


BEGIN

ie_acao_w := coalesce(ie_acao_p,'N');

SELECT	cd_material,
	coalesce(nr_seq_marca,0),
	cd_procedimento,
	dt_lib_estrut_pj,
	qt_item_estoque,
	coalesce(ie_indeterminado,'N')
INTO STRICT	cd_material_w,
	nr_seq_marca_w,
	cd_procedimento_w,
	dt_lib_estrut_pj_w,
	qt_item_nf_w,
	ie_indeterminado_w
FROM	nota_fiscal_item
WHERE	nr_sequencia	= nr_sequencia_p
AND	nr_item_nf	= nr_item_nf_p;

/* OS 1326710 -  Tratamento para que leia a quantidade total do mesmo item da nota, para verificar se existe saldo em estoque */

SELECT  Sum(qt_item_nf)
into STRICT 	qt_item_nf_total_w
FROM	nota_fiscal_item
WHERE	nr_sequencia	= nr_sequencia_p
AND  	cd_material = cd_material_w
and          nr_item_nf  = nr_item_nf_p;


cd_perfil_w	:= obter_perfil_ativo;

IF (cd_material_w IS NOT NULL AND cd_material_w::text <> '') THEN
	BEGIN
	ds_erro_w := '';

	SELECT	MAX(a.cd_operacao_nf),
		MAX(cd_condicao_pagamento),
		MAX(coalesce(cd_cgc_emitente,'N')) cd_cgc_emitente,
		max(nr_seq_far_venda)
	INTO STRICT	cd_operacao_nota_w,
		cd_cond_pagto_nf_w,
		cd_cgc_emitente_w,
		nr_seq_far_venda_w
	FROM 	nota_fiscal a
	WHERE	nr_sequencia	= nr_sequencia_p;


	SELECT	coalesce(MAX(b.ie_consignado),'0'),
		coalesce(MAX(b.ie_tipo_requisicao),'X'),
		coalesce(MAX(b.ie_consumo),'X'),
		coalesce(MAX(b.ie_coluna_resumo),'X'),
		MAX(b.ie_entrada_saida),
		MAX(b.ie_atualiza_estoque),
		coalesce(MAX(a.ie_exige_centro_loc_direto),'S'),
		coalesce(MAX(a.ie_devolucao),'N')
	INTO STRICT	ie_consignado_operacao_w,
		ie_tipo_requisicao_w,
		ie_consumo_w,
		ie_coluna_resumo_w,
		ie_ent_sai_op_estoque_w,
		ie_atualiza_estoque_w,
		ie_exige_centro_loc_direto_w,
		ie_devolucao_w
	FROM	operacao_estoque b,
		operacao_nota a
	WHERE	a.cd_operacao_estoque	= b.cd_operacao_estoque
	AND	a.cd_operacao_nf	= cd_operacao_nota_w;

	SELECT	c.ie_consignado,
		a.dt_entrada_saida,
		SUBSTR(obter_se_material_estoque(a.cd_estabelecimento, 0, b.cd_material),1,1),
		coalesce(c.cd_material_generico,c.cd_material),
		coalesce(c.cd_material_estoque, c.cd_material),
		b.cd_material,
		SUBSTR(c.ds_material,1,255),
		b.vl_unitario_item_nf,
		b.vl_liquido,
		b.qt_item_nf,
		b.cd_local_estoque,
		b.cd_centro_custo,
		b.nr_ordem_compra,
		b.nr_item_oci,
		a.cd_estabelecimento,
		b.vl_total_item_nf,
		b.cd_unidade_medida_compra,
		b.cd_unidade_medida_estoque,
		b.cd_conta_contabil,
		b.cd_natureza_operacao,
		a.cd_natureza_operacao,
		c.ie_situacao,
		SUBSTR(obter_dados_material_estab(c.cd_material,cd_estabelecimento_w,'UMC'),1,30) cd_unidade_medida_compra,
		SUBSTR(obter_dados_material_estab(c.cd_material,cd_estabelecimento_w,'UME'),1,30) cd_unidade_medida_estoque,
		c.qt_conv_compra_estoque,
		SUBSTR(obter_se_material_estoque_lote(a.cd_estabelecimento, b.cd_material),1,1),
		dt_validade,
		cd_lote_fabricacao,
		b.nr_contrato,
		ds_justificativa,
		a.ie_tipo_nota,
		b.nr_seq_conta_financ,
		c.ie_tipo_material,
		b.dt_entrega_ordem,
		b.nr_atendimento,
		b.nr_emprestimo,
		b.nr_seq_item_emprestimo,
		coalesce(a.cd_conv_integracao,0),
		nr_seq_regra_contrato,
		nr_seq_preco_pj,
		coalesce(a.vl_despesa_acessoria,0),
		coalesce(a.vl_conv_moeda,1),
		b.nr_seq_inspecao,
		b.nr_seq_proj_rec
	INTO STRICT	ie_consignado_material_w,
		dt_entrada_saida_w,
		ie_material_estoque_w,
		cd_material_generico_w,
		cd_material_estoque_w,
		cd_material_w,
		ds_material_w,
		vl_unitario_item_nf_w,
		vl_liquido_item_w,
		qt_item_nf_w,
		cd_local_estoque_w,
		cd_centro_custo_w,
		nr_ordem_compra_w,
		nr_item_oci_w,
		cd_estabelecimento_w,
		vl_total_item_nf_w,
		cd_unidade_medida_compra_w,
		cd_unidade_medida_estoque_w,
		cd_conta_contabil_nota_w,
		cd_natureza_nota_w,
		cd_natureza_item_w,
		ie_situacao_w,
		cd_unidade_compra_material_w,
		cd_unidade_estoque_material_w,
		qt_conv_compra_estoque_w,
		ie_estoque_lote_w,
		dt_validade_w,
		cd_lote_fabricacao_w,
		nr_contrato_w,
		ds_justificativa_w,
		ie_tipo_nota_w,
		nr_seq_conta_financ_w,
		ie_tipo_material_w,
		dt_prevista_entrega_w,
		nr_atendimento_w,
		nr_emprestimo_w,
		nr_seq_item_emprestimo_w,
		cd_convenio_w,
		nr_seq_regra_contrato_w,
		nr_seq_preco_pj_w,
		vl_despesa_acessoria_w,
		vl_conv_moeda_w,
		nr_seq_inspecao_w,
		nr_seq_proj_rec_nf_w
	FROM	operacao_nota e,
		material c,
		nota_fiscal_item b,
		nota_fiscal a
	WHERE 	a.nr_sequencia	= b.nr_sequencia
	AND	b.cd_material	= c.cd_material
	AND	a.cd_operacao_nf 	= e.cd_operacao_nf
	AND   	b.nr_item_nf	= nr_item_nf_p
	AND	a.nr_sequencia	= nr_sequencia_p;

	IF (dt_prevista_entrega_w IS NOT NULL AND dt_prevista_entrega_w::text <> '') AND (nr_ordem_compra_w > 0) AND (nr_item_oci_w > 0) THEN

		SELECT	MAX(dt_entrega_limite)
		INTO STRICT	dt_entrega_limite_w
		FROM	ordem_compra_item_entrega
		WHERE	nr_ordem_compra = nr_ordem_compra_w
		AND	nr_item_oci = nr_item_oci_w
		AND	TRUNC(dt_prevista_entrega,'dd') = TRUNC(dt_prevista_entrega_w,'dd');
	END IF;

	SELECT coalesce(MAX(dt_mesano_vigente),TRUNC(clock_timestamp(),'mm'))
	INTO STRICT 	dt_mesano_referencia_w
	FROM 	Parametro_estoque
	WHERE 	cd_estabelecimento = cd_estabelecimento_w;

	ie_altera_material_w		:= coalesce((obter_valor_param_usuario(40, 11, cd_perfil_w, nm_usuario_p, cd_estabelecimento_w)), 'N');
	ie_consiste_ordem_compra_w		:= coalesce((obter_valor_param_usuario(40, 13, cd_perfil_w, nm_usuario_p, cd_estabelecimento_w)), 'N');
	ie_obriga_conta_contabil_mat_w	:= coalesce((obter_valor_param_usuario(40, 21, cd_perfil_w, nm_usuario_p, cd_estabelecimento_w)), 'N');
	ie_consiste_saldo_dev_w		:= coalesce((obter_valor_param_usuario(40, 60, cd_perfil_w, nm_usuario_p, cd_estabelecimento_w)), 'N');
	pr_dif_valor_nota_ordem_w	:= coalesce((obter_valor_param_usuario(40, 34, cd_perfil_w, nm_usuario_p, cd_estabelecimento_w)), 0);
	pr_dif_quant_nota_ordem_w	:= coalesce((obter_valor_param_usuario(40, 35, cd_perfil_w, nm_usuario_p, cd_estabelecimento_w)), 0);
	ie_consiste_dt_validade_w	:= coalesce((obter_valor_param_usuario(40, 38, cd_perfil_w, nm_usuario_p, cd_estabelecimento_w)), 'N');
	ie_regra_dif_valor_w		:= coalesce((obter_valor_param_usuario(40, 64, cd_perfil_w, nm_usuario_p, cd_estabelecimento_w)), 'M');
	ie_regra_dif_quant_w		:= coalesce((obter_valor_param_usuario(40, 65, cd_perfil_w, nm_usuario_p, cd_estabelecimento_w)), 'M');
	ie_consiste_just_contrato_w	:= coalesce((obter_valor_param_usuario(40, 76, cd_perfil_w, nm_usuario_p, cd_estabelecimento_w)), 'N');
	ie_obriga_just_contrato_w	:= coalesce((obter_valor_param_usuario(40, 78, cd_perfil_w, nm_usuario_p, cd_estabelecimento_w)), 'N');
	ie_consiste_med_generico_w	:= coalesce((obter_valor_param_usuario(40, 83, cd_perfil_w, nm_usuario_p, cd_estabelecimento_w)), 'N');
	qt_dias_entrega_antecipada_w	:= coalesce((obter_valor_param_usuario(40, 91, cd_perfil_w, nm_usuario_p, cd_estabelecimento_w)), 0);
	ie_consiste_venc_contrato_w	:= coalesce((obter_valor_param_usuario(40, 92, cd_perfil_w, nm_usuario_p, cd_estabelecimento_w)), 'N');
	ie_consiste_qt_item_saldo_oc_w	:= coalesce((obter_valor_param_usuario(40, 118, cd_perfil_w, nm_usuario_p, cd_estabelecimento_w)), 'N');
	ie_consiste_local_w		:= coalesce((obter_valor_param_usuario(40, 127, cd_perfil_w, nm_usuario_p, cd_estabelecimento_w)), 'N');
	ie_avisa_emprestimo_aberto_w	:= coalesce((obter_valor_param_usuario(40, 157, cd_perfil_w, nm_usuario_p, cd_estabelecimento_w)), 'N');
	ie_permite_nat_diferente_w	:= coalesce((obter_valor_param_usuario(40, 178, cd_perfil_w, nm_usuario_p, cd_estabelecimento_w)), 'N');
	ie_dif_valor_nota_ordem_w	:= coalesce((obter_valor_param_usuario(40, 252, cd_perfil_w, nm_usuario_p, cd_estabelecimento_w)), 'P');
	ie_dif_quant_nota_ordem_w	:= coalesce((obter_valor_param_usuario(40, 253, cd_perfil_w, nm_usuario_p, cd_estabelecimento_w)), 'P');
	ie_mat_estoque_local_direto_w	:= coalesce((obter_valor_param_usuario(40, 257, cd_perfil_w, nm_usuario_p, cd_estabelecimento_w)), 'N');
	ie_consiste_vl_brasindice_w	:= coalesce((obter_valor_param_usuario(40, 278, cd_perfil_w, nm_usuario_p, cd_estabelecimento_w)), 'N');
	ie_consiste_vl_simpro_item_w	:= coalesce((obter_valor_param_usuario(40, 279, cd_perfil_w, nm_usuario_p, cd_estabelecimento_w)), 'N');
	ie_conta_financeira_w		:= coalesce((obter_valor_param_usuario(40, 281, cd_perfil_w, nm_usuario_p, cd_estabelecimento_w)), 'N');
	ie_valor_considerar_w		:= coalesce((obter_valor_param_usuario(40, 291, cd_perfil_w, nm_usuario_p, cd_estabelecimento_w)), 'U');
	ie_consiste_qt_pend_oc_w	:= coalesce((obter_valor_param_usuario(40, 297, cd_perfil_w, nm_usuario_p, cd_estabelecimento_w)), 'U');
	ie_consiste_se_mat_contr_w	:= coalesce((obter_valor_param_usuario(40, 308, cd_perfil_w, nm_usuario_p, cd_estabelecimento_w)), 'N');
	ie_consiste_status_marca_w	:= coalesce((obter_valor_param_usuario(40, 319, cd_perfil_w, nm_usuario_p, cd_estabelecimento_w)), 'N');
	pr_variacao_param_w		:= obter_valor_param_usuario(40, 238, cd_perfil_w, nm_usuario_p, cd_estabelecimento_w);
	vl_arredondamento_w		:= campo_numerico(REPLACE(obter_valor_param_usuario(40, 4, cd_perfil_w, nm_usuario_p, cd_estabelecimento_w),',','.'));
	ie_consiste_nat_contrato_w	:= coalesce((obter_valor_param_usuario(40, 323, cd_perfil_w, nm_usuario_p, cd_estabelecimento_w)), 'N');
	ie_consiste_unid_contrato_w	:= coalesce((obter_valor_param_usuario(40, 324, cd_perfil_w, nm_usuario_p, cd_estabelecimento_w)), 'N');
	ie_consiste_nat_regra_pj_w	:= coalesce((obter_valor_param_usuario(40, 325, cd_perfil_w, nm_usuario_p, cd_estabelecimento_w)), 'N');
	ie_consiste_unid_regra_pj_w	:= coalesce((obter_valor_param_usuario(40, 326, cd_perfil_w, nm_usuario_p, cd_estabelecimento_w)), 'N');
	ie_consiste_cm_nf_dev_w		:= coalesce((obter_valor_param_usuario(40, 328, cd_perfil_w, nm_usuario_p, cd_estabelecimento_w)), 'N');
	ie_desp_aces_rateio_itens_w	:= coalesce((obter_valor_param_usuario(40, 331, cd_perfil_w, nm_usuario_p, cd_estabelecimento_w)), 'N');
	ie_consiste_entrega_dif_oc_w	:= coalesce((obter_valor_param_usuario(40, 353, cd_perfil_w, nm_usuario_p, cd_estabelecimento_w)), 'N');
	ie_consiste_mat_fiscal_w	:= coalesce((obter_valor_param_usuario(40, 359, cd_perfil_w, nm_usuario_p, cd_estabelecimento_w)), 'N');
	ie_consiste_marca_oc		:= coalesce((obter_valor_param_usuario(40, 358, cd_perfil_w, nm_usuario_p, cd_estabelecimento_w)), 'N');
	pr_variacao_param_360_w		:= obter_valor_param_usuario(40, 360, cd_perfil_w, nm_usuario_p, cd_estabelecimento_w);
	ie_consiste_entrega_limite_w	:= coalesce((obter_valor_param_usuario(40, 369, cd_perfil_w, nm_usuario_p, cd_estabelecimento_w)), 'N');
	ie_consiste_doc_vencido_w	:= coalesce((obter_valor_param_usuario(40, 376, cd_perfil_w, nm_usuario_p, cd_estabelecimento_w)), 'N');
	ie_obriga_serie_w		:= coalesce((obter_valor_param_usuario(40, 379, cd_perfil_w, nm_usuario_p, cd_estabelecimento_w)), 'N');
	ie_permite_item_sem_contrato_w	:= coalesce((obter_valor_param_usuario(40, 380, cd_perfil_w, nm_usuario_p, cd_estabelecimento_w)), 'N');
	ie_exige_reg_anvisa_param_w	:= coalesce((obter_valor_param_usuario(40, 385, cd_perfil_w, nm_usuario_p, cd_estabelecimento_w)), 'N');
	cd_tabela_preco_param_w		:= obter_valor_param_usuario(40, 418, cd_perfil_w, nm_usuario_p, cd_estabelecimento_w);
	ie_gera_lote_fornec_w		:= coalesce((obter_valor_param_usuario(40, 18, cd_perfil_w, nm_usuario_p, cd_estabelecimento_w)), 'N');
	ie_consiste_dev_qt_maior_w	:= coalesce((obter_valor_param_usuario(40, 432, cd_perfil_w, nm_usuario_p, cd_estabelecimento_w)), 'N');
	ie_consiste_proj_rec_w		:= coalesce((obter_valor_param_usuario(40, 435, cd_perfil_w, nm_usuario_p, cd_estabelecimento_w)), 'N');
	ie_consiste_fornec_w		:= coalesce((obter_valor_param_usuario(40, 15, cd_perfil_w, nm_usuario_p, cd_estabelecimento_w)), 'N');
	ie_param_465_w			:= coalesce((obter_valor_param_usuario(40, 465, cd_perfil_w, nm_usuario_p, cd_estabelecimento_w)), 'N');
	ie_param_470_w			:= coalesce((obter_valor_param_usuario(40, 470, cd_perfil_w, nm_usuario_p, cd_estabelecimento_w)), 'N');
	ie_param_485_w			:= coalesce((obter_valor_param_usuario(40, 485, cd_perfil_w, nm_usuario_p, cd_estabelecimento_w)), 'T');
  	ie_param_100_w			:= coalesce((obter_valor_param_usuario(40, 100, cd_perfil_w, nm_usuario_p, cd_estabelecimento_w)), 'S');
	ie_consiste_calculo_w		:= coalesce((obter_valor_param_usuario(40, 508, cd_perfil_w, nm_usuario_p, cd_estabelecimento_w)), 'N');

	if (ie_param_465_w = 'C') then
		ie_param_465_w := 'S';
	else
		ie_param_465_w := 'N';
	end if;

	if (nr_ordem_compra_w > 0) and (nr_item_oci_w > 0) and (nr_seq_proj_rec_nf_w > 0) and (ie_consiste_proj_rec_w = 'S') then

		select	coalesce(nr_seq_proj_rec,0)
		into STRICT	nr_seq_proj_rec_ordem_w
		from	ordem_compra_item
		where	nr_ordem_compra = nr_ordem_compra_w
		and	nr_item_oci = nr_item_oci_w;

		if (nr_seq_proj_rec_ordem_w > 0) and (nr_seq_proj_rec_ordem_w <> nr_seq_proj_rec_nf_w) then
			ds_erro_w := SUBSTR(ds_erro_w || nr_item_nf_p || '-' || 'S -' ||
				WHEB_MENSAGEM_PCK.get_texto(278207) || CHR(13) || CHR(10),1,4000);

			CALL gravar_nota_fiscal_consist(
				nr_sequencia_p,
				WHEB_MENSAGEM_PCK.get_texto(278209) || nr_item_nf_p || WHEB_MENSAGEM_PCK.get_texto(278211),
				'S','I',
				WHEB_MENSAGEM_PCK.get_texto(278212),
				nm_usuario_p,'S',
				nr_item_nf_p);
		end if;

	end if;

	if (ie_consiste_dev_qt_maior_w = 'S') and (ie_devolucao_w = 'S') and (nr_ordem_compra_w > 0) and (nr_item_oci_w > 0) then

		select	coalesce(sum(b.qt_item_nf),0)
		into STRICT	qt_ja_devolvida_w
		from	nota_fiscal a,
			nota_fiscal_item b,
			operacao_nota o
		where	a.nr_sequencia = b.nr_sequencia
		and	o.cd_operacao_nf = a.cd_operacao_nf
		and	b.nr_ordem_compra = nr_ordem_compra_w
		and	b.nr_item_oci = nr_item_oci_w
		and	o.ie_devolucao = 'S'
		and	(a.dt_atualizacao_estoque IS NOT NULL AND a.dt_atualizacao_estoque::text <> '')
		and	a.ie_situacao = '1';

		select	coalesce(sum(b.qt_item_nf),0)
		into STRICT	qt_entrada_w
		from	nota_fiscal a,
			nota_fiscal_item b,
			operacao_nota o
		where	a.nr_sequencia = b.nr_sequencia
		and	o.cd_operacao_nf = a.cd_operacao_nf
		and	b.nr_ordem_compra = nr_ordem_compra_w
		and	b.nr_item_oci = nr_item_oci_w
		and	o.ie_operacao_fiscal = 'E'
		and	(a.dt_atualizacao_estoque IS NOT NULL AND a.dt_atualizacao_estoque::text <> '')
		and	a.ie_situacao = '1';

		qt_total_devolver_w := qt_ja_devolvida_w + qt_item_nf_w;

		if (qt_total_devolver_w > qt_entrada_w) then
			ds_erro_w := SUBSTR(ds_erro_w || nr_item_nf_p || '-' || 'S -' ||
				WHEB_MENSAGEM_PCK.get_texto(278213) || CHR(13) || CHR(10),1,4000);

			CALL gravar_nota_fiscal_consist(
				nr_sequencia_p,
				WHEB_MENSAGEM_PCK.get_texto(278209) || nr_item_nf_p || WHEB_MENSAGEM_PCK.get_texto(278214),
				'S','I',
				WHEB_MENSAGEM_PCK.get_texto(278215),
				nm_usuario_p,'S',
				nr_item_nf_p);
		end if;
	end if;

	IF (ie_consiste_ordem_compra_w = 'O') AND (coalesce(nr_ordem_compra_w::text, '') = '') THEN
		ds_erro_w := SUBSTR(ds_erro_w || nr_item_nf_p || '-' || 'S -' ||
				WHEB_MENSAGEM_PCK.get_texto(278216) || CHR(13) || CHR(10),1,4000);

		CALL gravar_nota_fiscal_consist(
			nr_sequencia_p,
			WHEB_MENSAGEM_PCK.get_texto(278209) || nr_item_nf_p || WHEB_MENSAGEM_PCK.get_texto(278217),
			'S','I',
			WHEB_MENSAGEM_PCK.get_texto(278219),
			nm_usuario_p,'S',
			nr_item_nf_p);
	END IF;

	if (obter_se_material_estoque(cd_estabelecimento_w,cd_estabelecimento_w,cd_material_w) = 'S') then

	select coalesce(cd_material_estoque,0)
	into STRICT   cd_material_estoque_mat_w
	from   material
	where  cd_material = cd_material_w;

	        if (cd_material_estoque_mat_w <> 0) then

			if (obter_se_material_estoque(cd_estabelecimento_w,cd_estabelecimento_w,cd_material_estoque_mat_w) = 'N') then
			    CALL gravar_nota_fiscal_consist(nr_sequencia_p,WHEB_MENSAGEM_PCK.get_texto(440681) || nr_item_nf_p ,'S','I',WHEB_MENSAGEM_PCK.get_texto(440793),nm_usuario_p,'S',nr_item_nf_p);
			end if;

		end if;
	else

	select coalesce(cd_material_estoque,0)
	into STRICT   cd_material_estoque_mat_w
	from   material
	where  cd_material = cd_material_w;

	        if (cd_material_estoque_mat_w <> 0) then

			if (obter_se_material_estoque(cd_estabelecimento_w,cd_estabelecimento_w,cd_material_estoque_mat_w) = 'S') then
				CALL gravar_nota_fiscal_consist(nr_sequencia_p,WHEB_MENSAGEM_PCK.get_texto(440681) || nr_item_nf_p ,'S','I',WHEB_MENSAGEM_PCK.get_texto(440793),nm_usuario_p,'S',nr_item_nf_p);
			end if;

		end if;

	end if;

	IF (ie_permite_item_sem_contrato_w = 'N') THEN

		select 	count(*)
		into STRICT  	qt_existe_w
		from 	nota_fiscal
		where	nr_sequencia = nr_sequencia_p
		and	(nr_contrato IS NOT NULL AND nr_contrato::text <> '')  LIMIT 1;

		IF (coalesce(nr_contrato_w::text, '') = '')and (qt_existe_w > 0)then
			ds_erro_w := SUBSTR(ds_erro_w || nr_item_nf_p || '-' || 'S -' ||
				WHEB_MENSAGEM_PCK.get_texto(278220) || CHR(13) || CHR(10),1,4000);

			CALL gravar_nota_fiscal_consist(
				nr_sequencia_p,
				WHEB_MENSAGEM_PCK.get_texto(278209) || nr_item_nf_p || WHEB_MENSAGEM_PCK.get_texto(278221),
				'S','I',
				WHEB_MENSAGEM_PCK.get_texto(278223),
				nm_usuario_p,'S',nr_item_nf_p);
		END IF;
	END IF;

	IF	((ie_param_470_w = 'N') or (ie_param_470_w = 'S' AND ie_acao_w = 'N')) and /*Quando o paramentro 470 esta ativado, e esta salvando o item, nao deve passar nessa rotina. Deve passar somente quando calcula a nota*/
		(coalesce(nr_seq_inspecao_w::text, '') = '') AND (ie_ent_sai_op_estoque_w = 'E') and (obter_se_exige_inspecao_nf(cd_material_w,nr_sequencia_p) = 'S') and (nr_ordem_compra_w IS NOT NULL AND nr_ordem_compra_w::text <> '')	THEN

		ds_erro_w := SUBSTR(ds_erro_w || nr_item_nf_p || '-' || 'S -' ||
				WHEB_MENSAGEM_PCK.get_texto(278225) || CHR(13) || CHR(10),1,4000);

		CALL gravar_nota_fiscal_consist(
			nr_sequencia_p,
			WHEB_MENSAGEM_PCK.get_texto(278209) || nr_item_nf_p || WHEB_MENSAGEM_PCK.get_texto(278226),
			'S','I',
			WHEB_MENSAGEM_PCK.get_texto(278227),
			nm_usuario_p,'S',nr_item_nf_p);

	END IF;

	/* Verifica se exige conferencia fisica */

	IF (obter_se_exige_inspecao_nf(cd_material_w,nr_sequencia_p, 'C') = 'S') and (ie_ent_sai_op_estoque_w = 'E') and (nr_ordem_compra_w IS NOT NULL AND nr_ordem_compra_w::text <> '') then

	   select count(*)
	     into STRICT qt_reg_conferencia_w
	     from ordem_compra_item_conf
		where nr_ordem_compra = nr_ordem_compra_w
		  and nr_item_oci     = nr_item_oci_w
		  and coalesce(qt_conferencia,0) > 0  LIMIT 1;

		if (qt_reg_conferencia_w = 0) then

			ds_erro_w := SUBSTR(ds_erro_w || nr_item_nf_p || '-' || 'S -' ||
				WHEB_MENSAGEM_PCK.get_texto(1144198) || CHR(13) || CHR(10),1,4000);

			CALL gravar_nota_fiscal_consist(
				nr_sequencia_p,
				WHEB_MENSAGEM_PCK.get_texto(278209) || nr_item_nf_p || '- ' || WHEB_MENSAGEM_PCK.get_texto(1144198),
				'S','I',
				WHEB_MENSAGEM_PCK.get_texto(1144199),
				nm_usuario_p,'S',nr_item_nf_p);

		end if;
	end if;

	IF (ie_consiste_entrega_limite_w IN ('S','C')) AND (dt_entrega_limite_w IS NOT NULL AND dt_entrega_limite_w::text <> '') AND
		(TRUNC(dt_entrada_saida_w,'dd') > (TRUNC(dt_entrega_limite_w,'dd'))) THEN

		SELECT	CASE WHEN ie_consiste_entrega_limite_w='S' THEN 'N'  ELSE 'S' END
		INTO STRICT	ie_consiste_entrega_limite_w
		;

		ds_erro_w := SUBSTR(ds_erro_w || nr_item_nf_p || '-' || 'N -' ||
				WHEB_MENSAGEM_PCK.get_texto(278228) || TO_CHAR(dt_entrega_limite_w,'dd/mm/yyyy') || '.' || CHR(13) || CHR(10),1,4000);

		CALL gravar_nota_fiscal_consist(
			nr_sequencia_p,
			WHEB_MENSAGEM_PCK.get_texto(278209) || nr_item_nf_p || WHEB_MENSAGEM_PCK.get_texto(278229) || TO_CHAR(dt_entrega_limite_w,'dd/mm/yyyy') || '.',
			ie_consiste_entrega_limite_w,'I',
			WHEB_MENSAGEM_PCK.get_texto(278232),
			nm_usuario_p,'S',nr_item_nf_p);

	END IF;

	IF (ie_consiste_cm_nf_dev_w = 'S') AND (ie_devolucao_w = 'S') AND (ie_ent_sai_op_estoque_w = 'S') THEN

		SELECT	OBTER_CUSTO_MEDIO_MATERIAL(cd_estabelecimento_w, TRUNC(dt_entrada_saida_w,'MM'),cd_material_w) vl_custo
		INTO STRICT	vl_custo_w
		;

		IF (vl_custo_w <> vl_unitario_item_nf_w) THEN
			ds_erro_w := SUBSTR(ds_erro_w || nr_item_nf_p || '-' || 'S -' ||
				WHEB_MENSAGEM_PCK.get_texto(278235) || CHR(13) || CHR(10),1,4000);

				CALL gravar_nota_fiscal_consist(
				nr_sequencia_p,
				WHEB_MENSAGEM_PCK.get_texto(278209) || nr_item_nf_p || WHEB_MENSAGEM_PCK.get_texto(278240),
				ie_consiste_cm_nf_dev_w,'I',
				WHEB_MENSAGEM_PCK.get_texto(278243),
				nm_usuario_p,'S',nr_item_nf_p);

		END IF;
	END IF;

	IF (nr_seq_regra_contrato_w > 0) THEN

		if (ie_param_100_w = 'S') then
			ie_consiste_fixos_contrato_w := 'N';
		elsif (ie_param_100_w = 'N') then

			select ds_justificativa
			into STRICT ds_justificativa_ww
			from nota_fiscal_item
			where nr_sequencia = nr_sequencia_p
			and nr_item_nf = nr_item_nf_p;

			if (ds_justificativa_ww IS NOT NULL AND ds_justificativa_ww::text <> '') then
				ie_consiste_fixos_contrato_w := 'N';
			else
				ie_consiste_fixos_contrato_w := 'S';
			end if;

		else
			ie_consiste_fixos_contrato_w := 'S';
		end if;

		SELECT	coalesce(vl_pagto,0),
			coalesce(ie_preco,'V')
		INTO STRICT	vl_pagto_w,
			ie_preco_w
		FROM	contrato_regra_nf
		WHERE	nr_sequencia = nr_seq_regra_contrato_w;

		IF (ie_preco_w = 'F') AND (vl_pagto_w > 0) AND (vl_unitario_item_nf_w <> vl_pagto_w) THEN

			ds_erro_w := SUBSTR(ds_erro_w || nr_item_nf_p || '-' || 'S -' ||
				WHEB_MENSAGEM_PCK.get_texto(278245) || CHR(13) || CHR(10),1,4000);

			CALL gravar_nota_fiscal_consist(
				nr_sequencia_p,
				WHEB_MENSAGEM_PCK.get_texto(278209) || nr_item_nf_p || WHEB_MENSAGEM_PCK.get_texto(278246),
				ie_consiste_fixos_contrato_w,'I',
				WHEB_MENSAGEM_PCK.get_texto(278247) ||
				WHEB_MENSAGEM_PCK.get_texto(278248) || campo_mascara_virgula_casas(vl_unitario_item_nf_w,4) || WHEB_MENSAGEM_PCK.get_texto(278249) || campo_mascara_virgula_casas(vl_pagto_w,4),
				nm_usuario_p,'S',nr_item_nf_p);


		END IF;

		SELECT	coalesce(ie_quantidade,'V'),
			coalesce(qt_material_fixa,1)
		INTO STRICT	ie_quantidade_w,
			qt_material_fixa_w
		FROM	contrato_regra_nf
		WHERE	nr_sequencia = nr_seq_regra_contrato_w;

		IF (ie_quantidade_w = 'F') AND (qt_item_nf_w <> qt_material_fixa_w) THEN

			ds_erro_w := SUBSTR(ds_erro_w || nr_item_nf_p || '-' || 'S -' ||
				WHEB_MENSAGEM_PCK.get_texto(278250) || qt_material_fixa_w || WHEB_MENSAGEM_PCK.get_texto(278251) || CHR(13) || CHR(10),1,4000);

			CALL gravar_nota_fiscal_consist(
				nr_sequencia_p,
				WHEB_MENSAGEM_PCK.get_texto(278209) || nr_item_nf_p || WHEB_MENSAGEM_PCK.get_texto(278252) || qt_material_fixa_w || '.',
				ie_consiste_fixos_contrato_w,'I',
				WHEB_MENSAGEM_PCK.get_texto(278253) || qt_material_fixa_w || WHEB_MENSAGEM_PCK.get_texto(278254),
				nm_usuario_p,'S',nr_item_nf_p);
		END IF;
	END IF;

	IF (nr_seq_regra_contrato_w > 0) AND (ie_consiste_nat_contrato_w = 'S') THEN

		SELECT	cd_natureza_operacao
		INTO STRICT	cd_natureza_contrato_w
		FROM	contrato_regra_nf
		WHERE	nr_sequencia = nr_seq_regra_contrato_w;

		IF (cd_natureza_contrato_w > 0) AND (cd_natureza_contrato_w <> cd_natureza_item_w) THEN
			ds_erro_w := SUBSTR(ds_erro_w || nr_item_nf_p || '-' || ie_consiste_nat_contrato_w || ' -' ||
				WHEB_MENSAGEM_PCK.get_texto(278255) || CHR(13) || CHR(10),1,4000);

			CALL gravar_nota_fiscal_consist(
				nr_sequencia_p,
				WHEB_MENSAGEM_PCK.get_texto(278209) || nr_item_nf_p || WHEB_MENSAGEM_PCK.get_texto(278256),
				ie_consiste_nat_contrato_w,'I',
				WHEB_MENSAGEM_PCK.get_texto(278257),
				nm_usuario_p,'S',nr_item_nf_p);
		END IF;
	END IF;

	IF (nr_seq_regra_contrato_w > 0) AND (ie_consiste_unid_contrato_w = 'S') THEN

		SELECT	cd_unidade_medida_compra
		INTO STRICT	cd_unid_med_contrato_w
		FROM	contrato_regra_nf
		WHERE	nr_sequencia = nr_seq_regra_contrato_w;

		IF (cd_unid_med_contrato_w IS NOT NULL AND cd_unid_med_contrato_w::text <> '') AND (cd_unid_med_contrato_w <> cd_unidade_medida_compra_w) THEN
			ds_erro_w := SUBSTR(ds_erro_w || nr_item_nf_p || '-' || ie_consiste_unid_contrato_w || ' -' ||
				WHEB_MENSAGEM_PCK.get_texto(278258) || CHR(13) || CHR(10),1,4000);

			CALL gravar_nota_fiscal_consist(
				nr_sequencia_p,
				WHEB_MENSAGEM_PCK.get_texto(278209) || nr_item_nf_p || WHEB_MENSAGEM_PCK.get_texto(278259),
				ie_consiste_unid_contrato_w,'I',
				WHEB_MENSAGEM_PCK.get_texto(278260),
				nm_usuario_p,'S',nr_item_nf_p);
		END IF;
	END IF;


	IF (nr_seq_preco_pj_w > 0) AND (ie_consiste_nat_regra_pj_w = 'S') THEN

		SELECT	coalesce(MAX(cd_natureza_operacao),0)
		INTO STRICT	cd_natureza_regra_pj_w
		FROM	preco_pj
		WHERE	nr_sequencia = nr_seq_preco_pj_w;

		IF (cd_natureza_regra_pj_w > 0) AND (cd_natureza_regra_pj_w <> cd_natureza_item_w) THEN
			ds_erro_w := SUBSTR(ds_erro_w || nr_item_nf_p || '-' || ie_consiste_nat_regra_pj_w || ' -' ||
				WHEB_MENSAGEM_PCK.get_texto(278261) || CHR(13) || CHR(10),1,4000);

			CALL gravar_nota_fiscal_consist(
				nr_sequencia_p,
				WHEB_MENSAGEM_PCK.get_texto(278209) || nr_item_nf_p || WHEB_MENSAGEM_PCK.get_texto(278262),
				ie_consiste_nat_regra_pj_w,'I',
				WHEB_MENSAGEM_PCK.get_texto(278263),
				nm_usuario_p,'S',nr_item_nf_p);
		END IF;
	END IF;

	IF (nr_seq_preco_pj_w > 0) AND (ie_consiste_unid_regra_pj_w = 'S') THEN

		SELECT	coalesce(MAX(cd_unidade_medida_compra),'')
		INTO STRICT	cd_unid_med_regra_pj_w
		FROM	preco_pj
		WHERE	nr_sequencia = nr_seq_preco_pj_w;


		IF (cd_unid_med_regra_pj_w IS NOT NULL AND cd_unid_med_regra_pj_w::text <> '') AND (cd_unid_med_regra_pj_w <> cd_unidade_medida_compra_w) THEN
			ds_erro_w := SUBSTR(ds_erro_w || nr_item_nf_p || '-' || ie_consiste_unid_regra_pj_w || ' -' ||
				WHEB_MENSAGEM_PCK.get_texto(278264) || CHR(13) || CHR(10),1,4000);

			CALL gravar_nota_fiscal_consist(
				nr_sequencia_p,
				WHEB_MENSAGEM_PCK.get_texto(278209) || nr_item_nf_p || WHEB_MENSAGEM_PCK.get_texto(278265),
				ie_consiste_unid_regra_pj_w,'I',
				WHEB_MENSAGEM_PCK.get_texto(278272),
				nm_usuario_p,'S',nr_item_nf_p);
		END IF;
	END IF;

	IF (ie_consiste_med_generico_w = 'S') AND (ie_tipo_material_w = '3') THEN
		ds_erro_w := SUBSTR(ds_erro_w || nr_item_nf_p || '-' || ie_consiste_med_generico_w || ' -' ||
			WHEB_MENSAGEM_PCK.get_texto(278274) || CHR(13) || CHR(10),1,4000);

		CALL gravar_nota_fiscal_consist(
			nr_sequencia_p,
			WHEB_MENSAGEM_PCK.get_texto(278209) || nr_item_nf_p || WHEB_MENSAGEM_PCK.get_texto(278276),
			ie_consiste_med_generico_w,'I',
			WHEB_MENSAGEM_PCK.get_texto(278278),
			nm_usuario_p,'S',nr_item_nf_p);

	ELSIF (ie_consiste_med_generico_w = 'A') AND (ie_tipo_material_w = '3') THEN
		ds_erro_w := SUBSTR(ds_erro_w || nr_item_nf_p || '-' || 'N -' ||
			WHEB_MENSAGEM_PCK.get_texto(278274) || CHR(13) || CHR(10),1,4000);

		CALL gravar_nota_fiscal_consist(
			nr_sequencia_p,
			WHEB_MENSAGEM_PCK.get_texto(278209) || nr_item_nf_p || WHEB_MENSAGEM_PCK.get_texto(278276),
			'N','I',
			WHEB_MENSAGEM_PCK.get_texto(278278),
			nm_usuario_p,'S',nr_item_nf_p);
	END IF;

	IF (nr_contrato_w > 0) THEN

		SELECT	coalesce(ie_periodo_nf,'D'),
			coalesce(qt_maximo_nf_periodo,0),
			coalesce(qt_dias_periodo,0)
		INTO STRICT	ie_periodo_nf_w,
			qt_maximo_nf_periodo_w,
			qt_dias_periodo_w
		FROM	contrato
		WHERE	nr_sequencia = nr_contrato_w;

		IF (ie_periodo_nf_w = 'M') AND /*Mensal*/
			(qt_maximo_nf_periodo_w > 0) THEN

			SELECT	COUNT(DISTINCT a.nr_sequencia)
			INTO STRICT	qt_existe_w
			FROM	nota_fiscal a,
				nota_fiscal_item b
			WHERE	a.nr_sequencia = b.nr_sequencia
			AND	(a.dt_atualizacao_estoque IS NOT NULL AND a.dt_atualizacao_estoque::text <> '')
			AND	a.ie_situacao = '1'
			AND	b.nr_contrato = nr_contrato_w
			AND	TRUNC(a.dt_entrada_saida,'mm') = TRUNC(clock_timestamp(),'mm');

			IF (qt_existe_w >= qt_maximo_nf_periodo_w) THEN
				ds_erro_w := SUBSTR(ds_erro_w || nr_item_nf_p || '-' || 'S -' ||
					WHEB_MENSAGEM_PCK.get_texto(278282) || CHR(13) || CHR(10),1,4000);

				CALL gravar_nota_fiscal_consist(
					nr_sequencia_p,
					WHEB_MENSAGEM_PCK.get_texto(278209) || nr_item_nf_p || WHEB_MENSAGEM_PCK.get_texto(278285),
					'S','I',
					WHEB_MENSAGEM_PCK.get_texto(278292) || CHR(13) || CHR(10) ||
					WHEB_MENSAGEM_PCK.get_texto(278294) || qt_maximo_nf_periodo_w || WHEB_MENSAGEM_PCK.get_texto(278296),
					nm_usuario_p,'S',nr_item_nf_p);
			END IF;
		END IF;

		IF (ie_periodo_nf_w = 'A') AND /*Anual*/
			(qt_maximo_nf_periodo_w > 0) THEN

			SELECT	COUNT(DISTINCT a.nr_sequencia)
			INTO STRICT	qt_existe_w
			FROM	nota_fiscal a,
				nota_fiscal_item b
			WHERE	a.nr_sequencia = b.nr_sequencia
			AND	(a.dt_atualizacao_estoque IS NOT NULL AND a.dt_atualizacao_estoque::text <> '')
			AND	a.ie_situacao = '1'
			AND	b.nr_contrato = nr_contrato_w
			AND	TRUNC(a.dt_entrada_saida,'YYYY') = TRUNC(clock_timestamp(),'YYYY');

			IF (qt_existe_w >= qt_maximo_nf_periodo_w) THEN
				ds_erro_w := SUBSTR(ds_erro_w || nr_item_nf_p || '-' || 'S -' ||
					WHEB_MENSAGEM_PCK.get_texto(278298) || CHR(13) || CHR(10),1,4000);

				CALL gravar_nota_fiscal_consist(
					nr_sequencia_p,
					WHEB_MENSAGEM_PCK.get_texto(278209) || nr_item_nf_p || WHEB_MENSAGEM_PCK.get_texto(278299),
					'S','I',
					WHEB_MENSAGEM_PCK.get_texto(278292) || CHR(13) || CHR(10) ||
					WHEB_MENSAGEM_PCK.get_texto(278294) || qt_maximo_nf_periodo_w || WHEB_MENSAGEM_PCK.get_texto(278300),
					nm_usuario_p,'S',nr_item_nf_p);
			END IF;
		END IF;

		IF (ie_periodo_nf_w = 'V') AND /*Variavel*/
			(qt_maximo_nf_periodo_w > 0) AND (qt_dias_periodo_w > 0) THEN

			SELECT	COUNT(DISTINCT a.nr_sequencia)
			INTO STRICT	qt_existe_w
			FROM	nota_fiscal a,
				nota_fiscal_item b
			WHERE	a.nr_sequencia = b.nr_sequencia
			AND	(a.dt_atualizacao_estoque IS NOT NULL AND a.dt_atualizacao_estoque::text <> '')
			AND	a.ie_situacao = '1'
			AND	b.nr_contrato = nr_contrato_w
			AND	TRUNC(a.dt_entrada_saida,'dd') BETWEEN TRUNC(clock_timestamp() - qt_dias_periodo_w,'dd') AND TRUNC(clock_timestamp(),'dd');

			IF (qt_existe_w >= qt_maximo_nf_periodo_w) THEN
				ds_erro_w := SUBSTR(ds_erro_w || nr_item_nf_p || '-' || 'S -' ||
					WHEB_MENSAGEM_PCK.get_texto(278301) || qt_dias_periodo_w || WHEB_MENSAGEM_PCK.get_texto(278302) || CHR(13) || CHR(10),1,4000);

				CALL gravar_nota_fiscal_consist(
					nr_sequencia_p,
					WHEB_MENSAGEM_PCK.get_texto(278209) || nr_item_nf_p || WHEB_MENSAGEM_PCK.get_texto(278303) || qt_dias_periodo_w || WHEB_MENSAGEM_PCK.get_texto(278302),
					'S','I',
					WHEB_MENSAGEM_PCK.get_texto(278304) || CHR(13) || CHR(10) ||
					WHEB_MENSAGEM_PCK.get_texto(278294) || qt_maximo_nf_periodo_w || WHEB_MENSAGEM_PCK.get_texto(278308) || qt_dias_periodo_w || WHEB_MENSAGEM_PCK.get_texto(278309),
					nm_usuario_p,'S',nr_item_nf_p);
			END IF;
		END IF;
	END IF;

	SELECT	COUNT(*)
	INTO STRICT	qt_controlador_w
	FROM	material
	WHERE	cd_material = cd_material_w
	AND	cd_material_estoque = cd_material  LIMIT 1;

	IF (qt_controlador_w = 0) AND (ie_consiste_se_mat_contr_w = 'S') THEN
		ds_erro_w := SUBSTR(ds_erro_w || nr_item_nf_p || '-' || 'S -' ||
			WHEB_MENSAGEM_PCK.get_texto(278310) || CHR(13) || CHR(10),1,4000);

		CALL gravar_nota_fiscal_consist(
			nr_sequencia_p,
			WHEB_MENSAGEM_PCK.get_texto(278209) || nr_item_nf_p || WHEB_MENSAGEM_PCK.get_texto(278311),
			'S','I',
			WHEB_MENSAGEM_PCK.get_texto(278312),
			nm_usuario_p,'S',nr_item_nf_p);

	ELSIF (qt_controlador_w = 0) AND (ie_consiste_se_mat_contr_w = 'A') THEN
		ds_erro_w := SUBSTR(ds_erro_w || nr_item_nf_p || '-' || 'N -' ||
			WHEB_MENSAGEM_PCK.get_texto(278313) || CHR(13) || CHR(10),1,4000);

		CALL gravar_nota_fiscal_consist(
			nr_sequencia_p,
			WHEB_MENSAGEM_PCK.get_texto(278209) || nr_item_nf_p || WHEB_MENSAGEM_PCK.get_texto(278314),
			'N','I',
			WHEB_MENSAGEM_PCK.get_texto(278312),
			nm_usuario_p,'S',nr_item_nf_p);

	ELSIF (ie_consiste_se_mat_contr_w = 'C') THEN

		SELECT	cd_material_estoque
		INTO STRICT	cd_controlador_w
		FROM	material
		WHERE	cd_material = cd_material_w;

		IF (cd_controlador_w = cd_material_w) THEN
			ds_erro_w := SUBSTR(ds_erro_w || nr_item_nf_p || '-' || 'N -' ||
				WHEB_MENSAGEM_PCK.get_texto(278316) || CHR(13) || CHR(10),1,4000);

			CALL gravar_nota_fiscal_consist(
				nr_sequencia_p,
				WHEB_MENSAGEM_PCK.get_texto(278209) || nr_item_nf_p || WHEB_MENSAGEM_PCK.get_texto(278317),
				'S','I',
				WHEB_MENSAGEM_PCK.get_texto(278312),
				nm_usuario_p,'S',nr_item_nf_p);
		END IF;

	END IF;


	IF (pr_variacao_param_w IS NOT NULL AND pr_variacao_param_w::text <> '') AND (ie_tipo_nota_w IN ('EN','EF','EP')) THEN

		SELECT	coalesce(obter_valor_ultima_compra_seq(cd_estabelecimento_w, 365, cd_material_w, NULL, 'N',nr_sequencia_p), 0)
		INTO STRICT	vl_ultima_compra_w
		;

		IF (vl_ultima_compra_w > 0) THEN
			vl_dif_ultima_compra_w	:= round((vl_ultima_compra_w * pr_variacao_param_w) / 100,4);

			IF	(vl_unitario_item_nf_w > (vl_ultima_compra_w + vl_dif_ultima_compra_w)) OR
				(vl_unitario_item_nf_w < (vl_ultima_compra_w - vl_dif_ultima_compra_w)) THEN

				ds_erro_w := SUBSTR(ds_erro_w || nr_item_nf_p || '-' || 'S -' ||
				WHEB_MENSAGEM_PCK.get_texto(278318)|| CHR(13) || CHR(10),1,4000);

				CALL gravar_nota_fiscal_consist(
					nr_sequencia_p,
					WHEB_MENSAGEM_PCK.get_texto(278209) || nr_item_nf_p || WHEB_MENSAGEM_PCK.get_texto(278319),
					'S','I',
					WHEB_MENSAGEM_PCK.get_texto(278320),
					nm_usuario_p,'S',nr_item_nf_p);

			END IF;
		END IF;
	END IF;

	SELECT	coalesce(MAX(ie_preco_compra),'N')
	INTO STRICT	ie_atualiza_ult_compra_w
	FROM	material
	WHERE	cd_material = cd_material_w;

	IF (ie_atualiza_ult_compra_w = 'S') THEN
		BEGIN

		BEGIN
		SELECT	coalesce(vl_parametro,vl_parametro_padrao)
		INTO STRICT	cd_tab_preco_mat_w
		FROM	funcao_parametro
		WHERE	cd_funcao	= 40
		AND	nr_sequencia	= 1;
		EXCEPTION WHEN OTHERS THEN
			cd_tab_preco_mat_w	:= 0;
		END;

		SELECT	COUNT(*)
		INTO STRICT	qt_existe_preco_tab_w
		FROM	preco_material
		WHERE	cd_tab_preco_mat = cd_tab_preco_mat_w
		AND	cd_material = cd_material_w
		AND	ie_situacao = 'A';

		END;
	END IF;

	IF (coalesce(cd_tabela_preco_param_w,0) > 0) THEN
		BEGIN
		IF (coalesce(obter_preco_mat_tab(cd_estabelecimento_w,cd_material_w,cd_tabela_preco_param_w),0) > 0) AND (ie_tipo_nota_w IN ('EN','EF','EP')) AND (ie_atualiza_ult_compra_w = 'S') AND (pr_variacao_param_360_w IS NOT NULL AND pr_variacao_param_360_w::text <> '') AND (qt_existe_preco_tab_w > 0) THEN
			BEGIN
			UPDATE	nota_fiscal_item
			SET	ie_pend_tab_preco	= 'N'
			WHERE	nr_sequencia		= nr_sequencia_p
			AND	nr_item_nf		= nr_item_nf_p;

			SELECT	coalesce(obter_preco_mat_tab(cd_estabelecimento_w,cd_material_w,cd_tabela_preco_param_w), 0)
			INTO STRICT	vl_preco_material_w
			;

			IF (vl_preco_material_w > 0) THEN
				vl_dif_ultima_compra_w	:= round((vl_preco_material_w * pr_variacao_param_360_w) / 100,4);

				IF	(vl_unitario_item_nf_w > (vl_preco_material_w + vl_dif_ultima_compra_w)) THEN

							ds_erro_w := SUBSTR(ds_erro_w || nr_item_nf_p || '-' || 'N -' ||
							WHEB_MENSAGEM_PCK.get_texto(278321)|| CHR(13) || CHR(10),1,4000);

								CALL gravar_nota_fiscal_consist(
									nr_sequencia_p,
									WHEB_MENSAGEM_PCK.get_texto(278209) || nr_item_nf_p || WHEB_MENSAGEM_PCK.get_texto(278319),
									'N','I',
									WHEB_MENSAGEM_PCK.get_texto(278323) ||
							WHEB_MENSAGEM_PCK.get_texto(278324),
							nm_usuario_p,'S',nr_item_nf_p);

						UPDATE	nota_fiscal_item
						SET	ie_pend_tab_preco	= 'S'
						WHERE	nr_sequencia		= nr_sequencia_p
						AND	nr_item_nf		= nr_item_nf_p;

				END IF;
			END IF;
			END;
		END IF;
		END;
	END IF;


	SELECT	coalesce(obter_se_consiste_regra_nf(cd_estabelecimento_w, cd_material_w, 'C'),'N'),
		obter_se_consiste_regra_nf(cd_estabelecimento_w, cd_material_w, 'P')
	INTO STRICT	ie_consiste_vl_compra_w,
		pr_variacao_valor_w
	;

	IF (ie_consiste_vl_compra_w = 'S') AND (pr_variacao_valor_w IS NOT NULL AND pr_variacao_valor_w::text <> '') AND (ie_tipo_nota_w IN ('EN','EF','EP')) THEN

		SELECT	coalesce(obter_valor_ultima_compra_seq(cd_estabelecimento_w, 365, cd_material_w, NULL, 'N',nr_sequencia_p), 0)
		INTO STRICT	vl_ultima_compra_w
		;

		IF (vl_ultima_compra_w > 0) THEN
			vl_dif_ultima_compra_w	:= round((vl_ultima_compra_w * pr_variacao_valor_w) / 100,4);

			IF	(vl_unitario_item_nf_w > (vl_ultima_compra_w + vl_dif_ultima_compra_w)) OR
				(vl_unitario_item_nf_w < (vl_ultima_compra_w - vl_dif_ultima_compra_w)) THEN
				ds_erro_w := SUBSTR(ds_erro_w || nr_item_nf_p || '-' || 'S -' ||
				WHEB_MENSAGEM_PCK.get_texto(278325)|| CHR(13) || CHR(10),1,4000);

				CALL gravar_nota_fiscal_consist(
					nr_sequencia_p,
					WHEB_MENSAGEM_PCK.get_texto(278209) || nr_item_nf_p || WHEB_MENSAGEM_PCK.get_texto(278326),
					'S','I',
					WHEB_MENSAGEM_PCK.get_texto(278327),
					nm_usuario_p,'S',nr_item_nf_p);

			END IF;
		END IF;
	END IF;

	/* Consistencias DE CONTRATO */

	IF (nr_contrato_w IS NOT NULL AND nr_contrato_w::text <> '') THEN
		BEGIN
		/* Jerusa OS 72609 */

		IF (ie_consiste_just_contrato_w = 'S') THEN
			BEGIN
			SELECT	coalesce(SUM(a.vl_liquido),0)
			INTO STRICT	vl_liquido_w
			FROM	nota_fiscal_item a,
				nota_fiscal b
			WHERE	a.nr_sequencia = b.nr_sequencia
			AND	a.nr_contrato = nr_contrato_w
			AND	b.ie_situacao = '1';

			SELECT	coalesce(vl_total_contrato,0)
			INTO STRICT	vl_total_contrato_w
			FROM	contrato
			WHERE	nr_sequencia = nr_contrato_w;

			IF (ds_justificativa_w IS NOT NULL AND ds_justificativa_w::text <> '') THEN
				ie_obriga_just_contrato_w	:= 'N';
			END IF;

			IF	(vl_total_contrato_w > 0 AND vl_liquido_w > vl_total_contrato_w) THEN
				ds_erro_w := SUBSTR(ds_erro_w || nr_item_nf_p || '-' || ie_obriga_just_contrato_w || ' -' ||
				WHEB_MENSAGEM_PCK.get_texto(278328) || CHR(13) || CHR(10),1,4000);

				CALL gravar_nota_fiscal_consist(
					nr_sequencia_p,
					WHEB_MENSAGEM_PCK.get_texto(278209) || nr_item_nf_p ||WHEB_MENSAGEM_PCK.get_texto(278329),
					ie_obriga_just_contrato_w,'I',
					WHEB_MENSAGEM_PCK.get_texto(278328),
					nm_usuario_p,'S',nr_item_nf_p);

			END IF;
			END;
		END IF;

		IF (ie_consiste_venc_contrato_w = 'S') THEN /*Matheus OS 102877 04082008*/
			BEGIN
			SELECT	MAX(dt_fim)
			INTO STRICT	dt_registro_w
			FROM	contrato
			WHERE	nr_sequencia	= nr_contrato_w;

			IF (dt_registro_w IS NOT NULL AND dt_registro_w::text <> '') AND (dt_registro_w <= clock_timestamp()) THEN
				ds_erro_w := SUBSTR(ds_erro_w || nr_item_nf_p || '-' || 'S' || ' -' ||
				WHEB_MENSAGEM_PCK.get_texto(278330) || CHR(13) || CHR(10),1,4000);

				CALL gravar_nota_fiscal_consist(
					nr_sequencia_p,
					WHEB_MENSAGEM_PCK.get_texto(278209) || nr_item_nf_p || WHEB_MENSAGEM_PCK.get_texto(278331),
					'S','I',
					WHEB_MENSAGEM_PCK.get_texto(278332),
					nm_usuario_p,'S',nr_item_nf_p);

			END IF;
			END;
		END IF;
		END;
	END IF;

	/* Consistencia referente a Regra de consistencias ao calcular a nota fiscal*/

	SELECT	COUNT(*)
	INTO STRICT	qt_existe_regra_w
	FROM	sup_regra_consistencia_nf
	WHERE	coalesce(ie_situacao,'A') = 'A'
	AND	cd_estabelecimento = cd_estabelecimento_w  LIMIT 1;

	IF (qt_existe_regra_w > 0) AND /*Somente se tem uma regra Ativa para o estabelecimento*/
		(ie_ent_sai_op_estoque_w = 'E') THEN /*Somente se a nota fiscal for de entrada*/
		SELECT	coalesce(obter_se_consiste_regra_nf(cd_estabelecimento_w,cd_material_w,'A'),'N')
		INTO STRICT	ie_consiste_nr_atend_w
		;

		IF (ie_consiste_nr_atend_w = 'S') AND (coalesce(nr_atendimento_w::text, '') = '') THEN

			ds_erro_w := SUBSTR(ds_erro_w || nr_item_nf_p || '-' || 'S' || ' -' ||
				WHEB_MENSAGEM_PCK.get_texto(278333) || CHR(13) || CHR(10),1,4000);

			CALL gravar_nota_fiscal_consist(
					nr_sequencia_p,
					WHEB_MENSAGEM_PCK.get_texto(278209) || nr_item_nf_p || WHEB_MENSAGEM_PCK.get_texto(278334),
					'S','I',
					WHEB_MENSAGEM_PCK.get_texto(278335),
					nm_usuario_p,'S',nr_item_nf_p);

		END IF;
	END IF;

	IF (qt_existe_regra_w > 0) THEN
		BEGIN

		SELECT	coalesce(obter_se_consiste_regra_nf(cd_estabelecimento_w, cd_material_w, 'M'),'N'),
			coalesce(obter_se_consiste_regra_nf(cd_estabelecimento_w, cd_material_w, 'F'),'N'),
			coalesce(obter_se_consiste_regra_nf(cd_estabelecimento_w, cd_material_w, 'CA'),'N'),
			coalesce(obter_se_consiste_regra_nf(cd_estabelecimento_w, cd_material_w, 'AN'),'N'),
			coalesce(obter_se_consiste_regra_nf(cd_estabelecimento_w, cd_material_w, 'V'),'N')
		INTO STRICT	ie_exige_marca_w,
			ie_exige_fabric_w,
			ie_exige_ca_w,
			ie_exige_anvisa_w,
			ie_exige_aval_solic_servico_w
		;

		if (ie_exige_aval_solic_servico_w = 'S') and (nr_ordem_compra_w > 0) then

			select	coalesce(max(nr_solic_compra),0)
			into STRICT	nr_solic_compra_w
			from	ordem_compra_item
			where	nr_ordem_compra = nr_ordem_compra_w
			and	nr_item_oci = nr_item_oci_w;

			if (nr_solic_compra_w > 0) then

				select	ie_tipo_compra
				into STRICT	ie_tipo_compra_w
				from	solic_compra
				where	nr_solic_compra = nr_solic_compra_w;

				if (ie_tipo_compra_w = 'SV') then

					select	count(*)
					into STRICT	qt_existe_w
					from	avf_resultado
					where	nr_solic_compra = nr_solic_compra_w
					and	(dt_aprovacao IS NOT NULL AND dt_aprovacao::text <> '')  LIMIT 1;

					if (qt_existe_w = 0) then
						ds_erro_w := SUBSTR(ds_erro_w || nr_item_nf_p || '-' || 'S' || ' -' ||
							wheb_mensagem_pck.get_Texto(456281, 'CD_MATERIAL_W='|| cd_material_w) || CHR(13) || CHR(10),1,4000);
							/*O material #@DS_MATERIAL_W#@ exige uma avaliacao dinamica na solicitacao de compras. Favor realizar a avaliacao e em seguida calcular a nota fiscal.*/

						CALL gravar_nota_fiscal_consist(
							nr_sequencia_p,
							WHEB_MENSAGEM_PCK.get_texto(456282,'NR_ITEM_W='||nr_item_nf_p), /*Item: #@NR_ITEM_W#@ exige que tenha uma avaliacao do servico prestado.*/
							'S','I',
							wheb_mensagem_pck.get_texto(456283), /* Essa avaliacao deve ser feita na funcao solicitacao de compras, pasta Avaliacao dinamica.*/
							nm_usuario_p,'S',nr_item_nf_p);
					end if;

				end if;

			end if;

		end if;

		IF (ie_exige_marca_w = 'S') THEN
			BEGIN

			SELECT	COUNT(*)
			INTO STRICT	qt_existe_exigencia_regra_w
			FROM	material_marca
			WHERE	cd_material = cd_material_w  LIMIT 1;

			IF (qt_existe_exigencia_regra_w = 0) THEN
				BEGIN

				ds_erro_w := SUBSTR(ds_erro_w || nr_item_nf_p || '-' || 'S' || ' -' ||
					WHEB_MENSAGEM_PCK.get_texto(278336) || cd_material_w ||WHEB_MENSAGEM_PCK.get_texto(278337) || CHR(13) || CHR(10),1,4000);

				CALL gravar_nota_fiscal_consist(
					nr_sequencia_p,
					WHEB_MENSAGEM_PCK.get_texto(278209) || nr_item_nf_p || WHEB_MENSAGEM_PCK.get_texto(278339),
					'S','I',
					WHEB_MENSAGEM_PCK.get_texto(278341),
					nm_usuario_p,'S',nr_item_nf_p);

				END;
			END IF;

			END;
		END IF;

		IF (ie_exige_fabric_w = 'S') THEN
			BEGIN

			SELECT	COUNT(*)
			INTO STRICT	qt_existe_exigencia_regra_w
			FROM	material
			WHERE	cd_material = cd_material_w
			AND	(nr_seq_fabric IS NOT NULL AND nr_seq_fabric::text <> '')  LIMIT 1;

			IF (qt_existe_exigencia_regra_w = 0) THEN
				BEGIN

				ds_erro_w := SUBSTR(ds_erro_w || nr_item_nf_p || '-' || 'S' || ' -' ||
					WHEB_MENSAGEM_PCK.get_texto(278336) || cd_material_w || WHEB_MENSAGEM_PCK.get_texto(278343) || CHR(13) || CHR(10),1,4000);

				CALL gravar_nota_fiscal_consist(
					nr_sequencia_p,
					WHEB_MENSAGEM_PCK.get_texto(278209) || nr_item_nf_p || WHEB_MENSAGEM_PCK.get_texto(278344),
					'S','I',
					WHEB_MENSAGEM_PCK.get_texto(278345),
					nm_usuario_p,'S',nr_item_nf_p);

				END;
			END IF;

			END;
		END IF;

		IF (ie_exige_ca_w = 'S') THEN
			BEGIN

			SELECT	COUNT(*)
			INTO STRICT	qt_existe_exigencia_regra_w
			FROM	material
			WHERE	cd_material = cd_material_w
			AND	(nr_certificado_aprovacao IS NOT NULL AND nr_certificado_aprovacao::text <> '')
			AND	dt_validade_certificado_aprov >= TRUNC(clock_timestamp())  LIMIT 1;

			IF (qt_existe_exigencia_regra_w = 0) THEN
				BEGIN

				ds_erro_w := SUBSTR(ds_erro_w || nr_item_nf_p || '-' || 'S' || ' -' ||
					WHEB_MENSAGEM_PCK.get_texto(278336) || cd_material_w || WHEB_MENSAGEM_PCK.get_texto(278346) || CHR(13) || CHR(10),1,4000);

				CALL gravar_nota_fiscal_consist(
					nr_sequencia_p,
					WHEB_MENSAGEM_PCK.get_texto(278209) || nr_item_nf_p || WHEB_MENSAGEM_PCK.get_texto(278347),
					'S','I',
					WHEB_MENSAGEM_PCK.get_texto(278348),
					nm_usuario_p,'S',nr_item_nf_p);

				END;
			END IF;

			END;
		END IF;

		IF (ie_exige_anvisa_w = 'S') THEN
		BEGIN

		SELECT		MAX(dt_validade_reg_anvisa),
				MAX(ie_vigente_anvisa),
				max(nr_registro_anvisa)
		INTO STRICT		dt_validade_anvisa_marca_w,
				ie_vigente_anvisa_marca_w,
				nr_registro_anvisa_w
		FROM		material_estab
		WHERE		cd_material = cd_material_w
		and		cd_estabelecimento = cd_estabelecimento_w;

		IF	((coalesce(ie_vigente_anvisa_marca_w,'X') = 'N') and
			((coalesce(dt_validade_anvisa_marca_w, clock_timestamp()) < TRUNC(clock_timestamp())) or (coalesce(nr_registro_anvisa_w::text, '') = ''))) THEN

				BEGIN

				ds_erro_w := SUBSTR(ds_erro_w || nr_item_nf_p || '-' || 'S' || ' -' ||
					WHEB_MENSAGEM_PCK.get_texto(278336) || cd_material_w || WHEB_MENSAGEM_PCK.get_texto(278349) || CHR(13) || CHR(10),1,4000);

				CALL gravar_nota_fiscal_consist(
					nr_sequencia_p,
					WHEB_MENSAGEM_PCK.get_texto(278209) || nr_item_nf_p || WHEB_MENSAGEM_PCK.get_texto(278350),
					'S','I',
					WHEB_MENSAGEM_PCK.get_texto(278351),
					nm_usuario_p,'S',nr_item_nf_p);

				END;
			END IF;

			END;
		END IF;

		END;
	END IF;
	/* Fim */

	ie_local_direto_w := 0;
	IF (cd_local_estoque_w IS NOT NULL AND cd_local_estoque_w::text <> '') THEN
		SELECT	COUNT(*)
		INTO STRICT	ie_local_direto_w
		FROM	local_estoque
		WHERE	ie_tipo_local = 8
		AND	cd_estabelecimento	= cd_estabelecimento_w
		AND	cd_local_estoque	= cd_local_estoque_w;
	END IF;
	ie_consig_w		:= (ie_consignado_operacao_w IN (1,2,3,5,8));

	/*Consistir se existe itens com local de estoque inativos*/

	if (cd_local_estoque_w IS NOT NULL AND cd_local_estoque_w::text <> '') then
		select	coalesce(ie_situacao,'A')
		into STRICT	ie_situacao_estoque_w
		from	local_estoque
		where	cd_local_estoque = cd_local_estoque_w;

		if (ie_situacao_estoque_w = 'I') then
			ds_erro_w := SUBSTR(ds_erro_w || '-' || 'S -' ||
				WHEB_MENSAGEM_PCK.get_texto(278355) || cd_material_w || WHEB_MENSAGEM_PCK.get_texto(294146) || CHR(13) || CHR(10),1,4000);

			CALL gravar_nota_fiscal_consist(
				nr_sequencia_p,
				WHEB_MENSAGEM_PCK.get_texto(278209) || nr_item_nf_p || WHEB_MENSAGEM_PCK.get_texto(294148),
				'S','I',
				WHEB_MENSAGEM_PCK.get_texto(294149),
				nm_usuario_p,'S',nr_item_nf_p);
		end if;
	end if;

	/*Consistir se existe itens com local de estoque diferente de direto, sendo que a operacao da nota nao atualiza estoque*/

	IF (ie_consiste_local_w = 'N') AND (ie_atualiza_estoque_w = 'N') AND (ie_ent_sai_op_estoque_w = 'E') AND (ie_consignado_material_w = '0') AND (cd_local_estoque_w IS NOT NULL AND cd_local_estoque_w::text <> '') AND (ie_local_direto_w = 0) THEN
		ds_erro_w	:= SUBSTR(ds_erro_w || '-' || 'S -' ||
			WHEB_MENSAGEM_PCK.get_texto(278355) || cd_material_w || WHEB_MENSAGEM_PCK.get_texto(278352) || CHR(13) || CHR(10),1,4000);

		CALL gravar_nota_fiscal_consist(
			nr_sequencia_p,
			WHEB_MENSAGEM_PCK.get_texto(278209) || nr_item_nf_p || WHEB_MENSAGEM_PCK.get_texto(278360),
			'S','I',
			WHEB_MENSAGEM_PCK.get_texto(278361),
			nm_usuario_p,'S',nr_item_nf_p);
	END IF;


	/*Consistir o local e direto e o material e de estoque*/

	IF (ie_mat_estoque_local_direto_w = 'S') AND (ie_local_direto_w = 1) AND (ie_material_estoque_w = 'S') AND (ie_consignado_operacao_w not in ('1','8')) THEN
		ds_erro_w	:= SUBSTR(ds_erro_w || nr_item_nf_p || '-' || 'S' || ' -' ||
				WHEB_MENSAGEM_PCK.get_texto(278362) || CHR(13) || CHR(10),1,4000);

		CALL gravar_nota_fiscal_consist(
			nr_sequencia_p,
			WHEB_MENSAGEM_PCK.get_texto(278209) || nr_item_nf_p || WHEB_MENSAGEM_PCK.get_texto(278363),
			'S','I',
			WHEB_MENSAGEM_PCK.get_texto(278364),
			nm_usuario_p,'S',nr_item_nf_p);

	END IF;

	/* Consistir quando o valor do item for maior que o valor Brasindice */

	IF (coalesce(ie_consiste_vl_brasindice_w,'N') <> 'N') THEN
		BEGIN
		IF (ie_consiste_vl_brasindice_w = 'S') THEN
			ie_obriga_w := 'S';
		ELSE
			ie_obriga_w := 'N';
		END IF;
		vl_preco_brasindice_w := coalesce(obter_valor_brasindice(cd_material_w,'C'),0);

		IF (coalesce(vl_preco_brasindice_w,0) > 0) AND (vl_unitario_item_nf_w > vl_preco_brasindice_w) THEN
			ds_erro_w	:= SUBSTR(ds_erro_w || nr_item_nf_p || '-' || ie_obriga_w || ' -' ||
					WHEB_MENSAGEM_PCK.get_texto(278368) || cd_material_w || WHEB_MENSAGEM_PCK.get_texto(278369) || CHR(13) || CHR(10),1,4000);

			CALL gravar_nota_fiscal_consist(
				nr_sequencia_p,
				WHEB_MENSAGEM_PCK.get_texto(278209) || nr_item_nf_p || WHEB_MENSAGEM_PCK.get_texto(278370),
				ie_obriga_w,'I',
				WHEB_MENSAGEM_PCK.get_texto(278371),
				nm_usuario_p,'S',nr_item_nf_p);

		END IF;
		END;
	END IF;

	/* Consistir quando o valor do item for maior que o valor Simpro */

	IF (coalesce(ie_consiste_vl_simpro_item_w,'N') <> 'N') AND (cd_convenio_w > 0) THEN
		BEGIN
		IF (ie_consiste_vl_simpro_item_w = 'S') THEN
			ie_obriga_w := 'S';
		ELSE
			ie_obriga_w := 'N';
		END IF;
		SELECT * FROM calcular_preco_simpro(	cd_estabelecimento_w, cd_convenio_w, cd_material_w, 1, 1, clock_timestamp(), 'C', vl_preco_simpro_w, dt_ult_vigencia_w, 1, 1, 1, 1, 'N', 'N', nr_seq_marca_w, nr_seq_mat_simpro_w, nr_seq_simpro_preco_w) INTO STRICT vl_preco_simpro_w, dt_ult_vigencia_w, nr_seq_mat_simpro_w, nr_seq_simpro_preco_w
					;

		IF (coalesce(vl_preco_simpro_w,0) > 0) AND (vl_unitario_item_nf_w > vl_preco_simpro_w) THEN
			ds_erro_w	:= SUBSTR(ds_erro_w || nr_item_nf_p || '-' || ie_obriga_w || ' -' ||
					WHEB_MENSAGEM_PCK.get_texto(278368) || cd_material_w || WHEB_MENSAGEM_PCK.get_texto(278372) || CHR(13) || CHR(10),1,4000);

			CALL gravar_nota_fiscal_consist(
				nr_sequencia_p,
				WHEB_MENSAGEM_PCK.get_texto(278209) || nr_item_nf_p || WHEB_MENSAGEM_PCK.get_texto(278373),
				ie_obriga_w,'I',
				WHEB_MENSAGEM_PCK.get_texto(278374),
				nm_usuario_p,'S',nr_item_nf_p);
		END IF;
		END;
	END IF;

	/* Consistir se o material tem controle de estoque por lote*/

	IF (ie_estoque_lote_w = 'S') AND (ie_consignado_operacao_w not in (1,8)) THEN
		SELECT	COUNT(*)
		INTO STRICT	qt_falta_lote_w
		FROM	nota_fiscal_item a
		WHERE	a.nr_sequencia = nr_sequencia_p
		AND	a.nr_item_nf = nr_item_nf_p
		AND	((coalesce(a.cd_lote_fabricacao::text, '') = '') OR (coalesce(a.ie_indeterminado,'N') = 'N' AND coalesce(a.dt_validade::text, '') = ''))
		AND NOT EXISTS (
			SELECT	1
			FROM	nota_fiscal_item_lote x
			WHERE	x.nr_seq_nota = a.nr_sequencia)  LIMIT 1;

		IF (qt_falta_lote_w > 0) THEN
			ds_erro_w	:= SUBSTR(ds_erro_w || '-' || 'S -' ||
			WHEB_MENSAGEM_PCK.get_texto(278355) || cd_material_w || WHEB_MENSAGEM_PCK.get_texto(278375) || CHR(13) || CHR(10),1,4000);

			CALL gravar_nota_fiscal_consist(
				nr_sequencia_p,
				WHEB_MENSAGEM_PCK.get_texto(278209) || nr_item_nf_p || WHEB_MENSAGEM_PCK.get_texto(278399),
				'S','I',
				WHEB_MENSAGEM_PCK.get_texto(278437),
				nm_usuario_p,'S',nr_item_nf_p);

		END IF;
	END IF;

	/* Consistir estoque de consignado se for nota de devolucao */

	IF (ie_consiste_saldo_dev_w = 'S') AND (ie_consignado_operacao_w	= '5') AND (ie_tipo_requisicao_w	= '9') AND (ie_consumo_w		= 'D') AND (ie_coluna_resumo_w	= 'V') AND (ie_ent_sai_op_estoque_w	= 'S')and (ie_devolucao_w			= 'S')THEN
		SELECT	cd_cgc
		INTO STRICT	cd_cgc_w
		FROM	nota_fiscal
		WHERE	nr_sequencia = nr_sequencia_p;
		SELECT	Obter_Saldo_Estoque_Consig(
					cd_estabelecimento_w,
					cd_cgc_w,
					cd_material_w,
					cd_local_estoque_w)
		INTO STRICT	qt_estoque_w
		;
		IF (qt_estoque_w < qt_item_nf_w) THEN
			ds_erro_w	:= SUBSTR(ds_erro_w || '-' || 'S -' ||
			WHEB_MENSAGEM_PCK.get_texto(278355) || cd_material_w || WHEB_MENSAGEM_PCK.get_texto(278438) || CHR(13) || CHR(10),1,4000);

			CALL gravar_nota_fiscal_consist(
				nr_sequencia_p,
				WHEB_MENSAGEM_PCK.get_texto(278209) || nr_item_nf_p || WHEB_MENSAGEM_PCK.get_texto(278439),
				'S','I',
				WHEB_MENSAGEM_PCK.get_texto(278440),
				nm_usuario_p,'S',nr_item_nf_p);

		END IF;
	END IF;

	/* Consistir estoque de mat med nao consignado se for nota de devolucao */

	IF (ie_consiste_saldo_dev_w	= 'S') AND (ie_ent_sai_op_estoque_w	= 'S') AND (ie_consignado_operacao_w	= '0') AND (ie_local_direto_w		= 0) and (ie_atualiza_estoque_w		= 'S')and (ie_devolucao_w			= 'S')then
		begin

		if (dt_mesano_referencia_w > dt_entrada_saida_w) then
			dt_base_w	:=	dt_mesano_referencia_w;
		else
			dt_base_w	:=	trunc(dt_entrada_saida_w,'mm');
		end if;

		dt_mesa_verif_w	:=	dt_base_w;

		while(dt_mesa_verif_w <= trunc(clock_timestamp(),'mm')) loop
			begin
			qt_estoque_w	:= obter_saldo_disp_estoque(
						cd_estabelecimento_w,
						cd_material_w,
						cd_local_estoque_w,
						dt_mesa_verif_w);

			IF (qt_estoque_w < qt_item_nf_w) THEN
				ds_erro_w	:= SUBSTR(ds_erro_w || '-' || 'S -' ||
						WHEB_MENSAGEM_PCK.get_texto(278355) || cd_material_w || ' ' || ds_material_w || WHEB_MENSAGEM_PCK.get_texto(278444) || CHR(13) || CHR(10),1,4000);

				CALL gravar_nota_fiscal_consist(
					nr_sequencia_p,
					WHEB_MENSAGEM_PCK.get_texto(278209) || nr_item_nf_p || WHEB_MENSAGEM_PCK.get_texto(278439),
					'S','I',
					WHEB_MENSAGEM_PCK.get_texto(278440),
					nm_usuario_p,'S',nr_item_nf_p);
			END IF;

			dt_mesa_verif_w	:=	add_months(dt_mesa_verif_w,1);
			end;
		end loop;


		end;
	END IF;

	/* Consistir situacao item */

	IF (ie_situacao_w = 'I') THEN
		ds_erro_w := SUBSTR(ds_erro_w || nr_item_nf_p || '-' || 'S -' || WHEB_MENSAGEM_PCK.get_texto(278336) || cd_material_w || WHEB_MENSAGEM_PCK.get_texto(278446) || CHR(13) || CHR(10),1,4000);

		CALL gravar_nota_fiscal_consist(
				nr_sequencia_p,
				WHEB_MENSAGEM_PCK.get_texto(278209) || nr_item_nf_p || WHEB_MENSAGEM_PCK.get_texto(278447),
				'S','I',
				WHEB_MENSAGEM_PCK.get_texto(278448),
				nm_usuario_p,'S');

	END IF;

	SELECT	ie_situacao
	INTO STRICT	ie_situacao_controlador_w
	FROM	material
	WHERE	cd_material = cd_material_estoque_w;

	/* Consistir situacao controlador do item */

	IF (ie_situacao_controlador_w = 'I') THEN
		ds_erro_w := SUBSTR(ds_erro_w || nr_item_nf_p || '-' || 'S -' || WHEB_MENSAGEM_PCK.get_texto(278449) || cd_material_w || WHEB_MENSAGEM_PCK.get_texto(278446) || CHR(13) || CHR(10),1,4000);

		CALL gravar_nota_fiscal_consist(
				nr_sequencia_p,
				WHEB_MENSAGEM_PCK.get_texto(278209) || nr_item_nf_p || WHEB_MENSAGEM_PCK.get_texto(278450),
				'S','I',
				WHEB_MENSAGEM_PCK.get_texto(278451),
				nm_usuario_p,'S',nr_item_nf_p);

	END IF;

	/*Consistir se a quantidade do item e maior que a quantidade do emprestimo*/

	IF (nr_emprestimo_w > 0) AND (nr_seq_item_emprestimo_w > 0) and (ie_ent_sai_op_estoque_w = 'E') THEN

		SELECT	coalesce(SUM(qt_emprestimo),0),
			coalesce(SUM(qt_nota_fiscal),0)
		INTO STRICT	qt_emprestimo_w,
			qt_nota_fiscal_w
		FROM	emprestimo_material
		WHERE	nr_emprestimo = nr_emprestimo_w
		AND	nr_sequencia = nr_seq_item_emprestimo_w;

		qt_falta_gerar_nota_w := qt_emprestimo_w - qt_nota_fiscal_w;

		IF (qt_falta_gerar_nota_w > qt_item_nf_w) THEN
			ds_erro_w := SUBSTR(ds_erro_w || WHEB_MENSAGEM_PCK.get_texto(278452) || cd_material_w || WHEB_MENSAGEM_PCK.get_texto(278453) || CHR(13) || CHR(10),1,4000);

			CALL gravar_nota_fiscal_consist(
				nr_sequencia_p,
				WHEB_MENSAGEM_PCK.get_texto(278209) || nr_item_nf_p || WHEB_MENSAGEM_PCK.get_texto(278454),
				'S','I',
				WHEB_MENSAGEM_PCK.get_texto(278455),
				nm_usuario_p,'S',nr_item_nf_p);

		END IF;
	END IF;

	/*Consistencia de vinculacao das notas de consigando - Entrada X Faturamento*/


	/*Fara a consistencia, se os parametros estiverem informados e se a operacao da nota for igual a operacao da faturamento no parametro*/

	SELECT	coalesce(MAX(ie_forma_vinc_nota_consig),'N'),
		coalesce(MAX(cd_oper_nota_ent_vinc_consig), 0),
		coalesce(MAX(cd_oper_nota_fat_vinc_consig), 0),
		coalesce(MAX(ie_exige_anvisa_marca_mat),'N')
	INTO STRICT	ie_forma_vinc_nota_consig_w,
		cd_oper_nota_ent_vinc_consig_w,
		cd_oper_nota_fat_vinc_consig_w,
		ie_exige_reg_anvisa_w
	FROM	parametro_compras
	WHERE	cd_estabelecimento = cd_estabelecimento_w;
	IF (ie_forma_vinc_nota_consig_w <> 'N') AND (cd_oper_nota_ent_vinc_consig_w <> 0) AND (cd_oper_nota_fat_vinc_consig_w <> 0) AND (cd_operacao_nota_w = cd_oper_nota_fat_vinc_consig_w) THEN
		BEGIN
		SELECT	COUNT(*)
		INTO STRICT	qt_item_sem_vinc_consig_w
		FROM	nota_fiscal_item
		WHERE	nr_sequencia = nr_sequencia_p
		AND	coalesce(nr_sequencia_vinc_consig::text, '') = ''  LIMIT 1;

		IF (qt_item_sem_vinc_consig_w > 0) THEN
			BEGIN
			ie_obriga_w	:= 'N -';
			IF (ie_forma_vinc_nota_consig_w = 'O') THEN
				ie_obriga_w	:= 'S -';
			END IF;
			ds_erro_w := SUBSTR(ds_erro_w || nr_item_nf_p || '-' || ie_obriga_w ||
				WHEB_MENSAGEM_PCK.get_texto(278456) || CHR(13) || CHR(10),1,4000);

			CALL gravar_nota_fiscal_consist(
				nr_sequencia_p,
				WHEB_MENSAGEM_PCK.get_texto(278209) || nr_item_nf_p || WHEB_MENSAGEM_PCK.get_texto(278458),
				ie_obriga_w,'I',
				WHEB_MENSAGEM_PCK.get_texto(278456),
				nm_usuario_p,'S',nr_item_nf_p);

			END;
		END IF;
		END;
	END IF;

	/*Consiste a atividade economica*/

	IF (coalesce((pkg_i18n.get_user_locale),'pt_BR') = 'es_CO' AND coalesce(ie_tipo_material_w,0) = 4 AND ie_tipo_nota_w = 'EN') THEN

		SELECT max(t.NR_SEQ_CNAE)
		INTO STRICT   nr_seq_cnae_w 
		FROM   MATERIAL_FISCAL t 
		WHERE  t.cd_material = cd_material_w;
		
		SELECT CASE WHEN count(1)=0 THEN  0  ELSE 1 END 
		INTO STRICT   qt_existe_w 
		
		WHERE EXISTS (
			SELECT 1
			FROM   nota_fiscal t,
			       pessoa_juridica p
			WHERE  p.cd_cgc = t.cd_cgc_emitente
			AND    t.nr_sequencia = nr_sequencia_p 
			AND    p.NR_SEQ_CNAE = nr_seq_cnae_w
		);
		
		IF ((nr_seq_cnae_w IS NOT NULL AND nr_seq_cnae_w::text <> '') AND qt_existe_w = 0) THEN
		
			SELECT max(p.DT_INICIO_VIGENCIA),
			       max(p.DT_FIM_VIGENCIA)
			INTO STRICT   dt_inicio_vigencia_w,
			       dt_fim_vigencia_w 
			FROM   nota_fiscal t,
			       PESSOA_JUR_CNAE_SEC p
			WHERE  p.cd_cnpj = t.cd_cgc_emitente
			AND    t.nr_sequencia = nr_sequencia_p 
			AND    p.NR_SEQ_CNAE = nr_seq_cnae_w;
			
			SELECT CASE WHEN count(1)=0 THEN  0  ELSE 1 END
			INTO STRICT   qt_existe_w 
			
			WHERE EXISTS (
				SELECT 1
				FROM   nota_fiscal t,
				       pessoa_jur_cnae_sec p
				WHERE  p.cd_cnpj = t.cd_cgc_emitente
				AND    t.nr_sequencia = nr_sequencia_p 
				AND    p.NR_SEQ_CNAE = nr_seq_cnae_w
			);
			
			IF (qt_existe_w = 0 OR (qt_existe_w = 1 AND ((coalesce(dt_fim_vigencia_w::text, '') = '' AND dt_inicio_vigencia_w > clock_timestamp()) OR (dt_inicio_vigencia_w > clock_timestamp() OR dt_fim_vigencia_w < clock_timestamp())))) THEN
				BEGIN
					ds_erro_w := SUBSTR(ds_erro_w||nr_item_nf_p||'-'||ie_consiste_calculo_w ||' -'||WHEB_MENSAGEM_PCK.get_texto(1070114)||CHR(13)||CHR(10),1,4000);
					CALL gravar_nota_fiscal_consist(
					nr_sequencia_p,
					WHEB_MENSAGEM_PCK.get_texto(278209) || nr_item_nf_p ||' - '|| WHEB_MENSAGEM_PCK.get_texto(1197007),
					ie_consiste_calculo_w,'I',
					WHEB_MENSAGEM_PCK.get_texto(1197008),
					nm_usuario_p,ie_consiste_calculo_w,nr_item_nf_p);
				END;
			END IF;
		END IF;
	END IF;

	/*Consistir a conta financeira*/

	IF (nr_seq_conta_financ_w IS NOT NULL AND nr_seq_conta_financ_w::text <> '') THEN
		SELECT	ie_situacao
		INTO STRICT	ie_sit_conta_fin_w
		FROM	conta_financeira
		WHERE	cd_conta_financ = nr_seq_conta_financ_w;
		IF (ie_sit_conta_fin_w <> 'A') THEN
			ds_erro_w := SUBSTR(ds_erro_w || nr_item_nf_p || '-' || 'S -' || WHEB_MENSAGEM_PCK.get_texto(278460) || CHR(13) || CHR(10),1,4000);

			CALL gravar_nota_fiscal_consist(
				nr_sequencia_p,
				WHEB_MENSAGEM_PCK.get_texto(278209) || nr_item_nf_p || WHEB_MENSAGEM_PCK.get_texto(278461),
				'S','I',
				WHEB_MENSAGEM_PCK.get_texto(278462),
				nm_usuario_p,'S',nr_item_nf_p);

		END IF;

		SELECT	coalesce(obter_se_permite_cfinanc_nf(nr_seq_conta_financ_w, nr_sequencia_p, nr_item_nf_p),'S')
		INTO STRICT	ie_permite_conta_financ_w
		;

		IF (ie_permite_conta_financ_w = 'N') THEN
			ds_erro_w := SUBSTR(ds_erro_w || nr_item_nf_p || '-' || 'S -' || WHEB_MENSAGEM_PCK.get_texto(278463) || CHR(13) || CHR(10),1,4000);

			CALL gravar_nota_fiscal_consist(
				nr_sequencia_p,
				WHEB_MENSAGEM_PCK.get_texto(278209) || nr_item_nf_p || WHEB_MENSAGEM_PCK.get_texto(278464),
				'S','I',
				WHEB_MENSAGEM_PCK.get_texto(278465),
				nm_usuario_p,'S');
		END IF;

	END IF;

	/* Consiste se validade do registro da anvisa vencida*/

	BEGIN
	SELECT	coalesce(ie_consiste_validade_anvisa, 'N'),
		coalesce(ie_consiste_validade_marca_mat,'N')
	INTO STRICT	ie_consiste_validade_anvisa_w,
		ie_consiste_valid_marca_mat_w
	FROM	parametro_compras
	WHERE	cd_estabelecimento = cd_estabelecimento_w;
	EXCEPTION WHEN no_data_found THEN
		--Nao existe registro no cadastro dos parametros de compras.
		CALL Wheb_mensagem_pck.exibir_mensagem_abort(183264);
	END;
	IF (ie_consiste_validade_anvisa_w = 'S') THEN

		select	count(*)
		into STRICT	qt_validade_vencida_w
		from	material_estab
		where	cd_material = cd_material_w
		and		cd_estabelecimento = cd_estabelecimento_w
		and		(dt_validade_reg_anvisa IS NOT NULL AND dt_validade_reg_anvisa::text <> '')
		and		dt_validade_reg_anvisa < clock_timestamp()  LIMIT 1;

		select	max(coalesce(ie_vigente_anvisa,'N'))
		into STRICT 	ie_vigente_anvisa_w
		from	material_estab
		where	cd_material 		= cd_material_w
		and		cd_estabelecimento 	= cd_estabelecimento_w;

		if (qt_validade_vencida_w > 0) and (ie_vigente_anvisa_w = 'N') then
			ds_erro_w := SUBSTR(ds_erro_w || nr_item_nf_p || '-' || 'S -' ||
			WHEB_MENSAGEM_PCK.get_texto(278336) || cd_material_w || WHEB_MENSAGEM_PCK.get_texto(278466) || CHR(13) || CHR(10),1,4000);

			CALL gravar_nota_fiscal_consist(
				nr_sequencia_p,
				WHEB_MENSAGEM_PCK.get_texto(278209) || nr_item_nf_p || WHEB_MENSAGEM_PCK.get_texto(278467),
				'S','I',
				WHEB_MENSAGEM_PCK.get_texto(278468),
				nm_usuario_p,'S',nr_item_nf_p);

		END IF;
	END IF;

	/*Consiste a data de validade da marca do material*/

	IF (ie_consiste_valid_marca_mat_w = 'S') THEN

		SELECT	MAX(dt_validade_reg_anvisa),
				MAX(ie_vigente_anvisa)
		INTO STRICT	dt_validade_anvisa_marca_w,
				ie_vigente_anvisa_marca_w
		FROM	material_marca
		WHERE	cd_material = cd_material_w
		AND	nr_sequencia = nr_seq_marca_w;

		IF	((coalesce(ie_vigente_anvisa_marca_w,'X') = 'N') and (coalesce(dt_validade_anvisa_marca_w, clock_timestamp()) < TRUNC(clock_timestamp()))) THEN
			ds_erro_w :=	SUBSTR(	ds_erro_w || nr_item_nf_p || '-' || 'S -' ||
				WHEB_MENSAGEM_PCK.get_texto(278470) || obter_desc_marca(nr_seq_marca_w) || WHEB_MENSAGEM_PCK.get_texto(278472) || cd_material_w || WHEB_MENSAGEM_PCK.get_texto(278474) ||
						WHEB_MENSAGEM_PCK.get_texto(278476) || CHR(13) || CHR(10),1,4000);

			CALL gravar_nota_fiscal_consist(
				nr_sequencia_p,
				WHEB_MENSAGEM_PCK.get_texto(278209) || nr_item_nf_p || WHEB_MENSAGEM_PCK.get_texto(278477),
				'S','I',
				WHEB_MENSAGEM_PCK.get_texto(278478),
				nm_usuario_p,'S',nr_item_nf_p);
		END IF;
	END IF;


		/* Consistir o preenchimento do campo Regitro Anvisa e Valida Anvisa   */

	IF (ie_exige_reg_anvisa_w = 'S') OR /* Parametro de Compras */
		(ie_exige_reg_anvisa_param_w = 'S') THEN /* Parametro da funcao */
		BEGIN

		SELECT	MAX(dt_validade_reg_anvisa),
			MAX(nr_registro_anvisa),
			MAX(ie_vigente_anvisa)
		INTO STRICT	dt_validade_anvisa_marca_w,
			nr_registro_anvisa_w,
			ie_vigente_anvisa_marca_w
		FROM	material_marca
		WHERE	cd_material = cd_material_w
		AND	nr_sequencia = nr_seq_marca_w;

		IF	((coalesce(ie_vigente_anvisa_marca_w, 'X') = 'N') or (coalesce(dt_validade_anvisa_marca_w::text, '') = '')) OR (coalesce(nr_registro_anvisa_w::text, '') = '') THEN
			BEGIN

			IF (ie_exige_reg_anvisa_w = 'S') THEN
				ds_orientacao_reg_anv_w	:= WHEB_MENSAGEM_PCK.get_texto(278479);
			ELSE
				ds_orientacao_reg_anv_w	:= WHEB_MENSAGEM_PCK.get_texto(278480);
			END IF;

			ds_erro_w := SUBSTR(ds_erro_w ||  nr_item_nf_p || '-' || 'S -' || WHEB_MENSAGEM_PCK.get_texto(278481) || CHR(13) || CHR(10),1,4000);
			CALL gravar_nota_fiscal_consist(
				nr_sequencia_p,
				WHEB_MENSAGEM_PCK.get_texto(278209) || nr_item_nf_p || WHEB_MENSAGEM_PCK.get_texto(278482),
				'S','I',
				WHEB_MENSAGEM_PCK.get_texto(278483) || ds_orientacao_reg_anv_w,
				nm_usuario_p,'S',nr_item_nf_p);

			END;
		END IF;

		END;
	END IF;

	--fabricante


	--if	(ie_consiste_doc_venc_w = 'S') and   parametro que sera criado
	IF (ie_ent_sai_op_estoque_w = 'E') THEN
		BEGIN

		SELECT	MAX(cd_cnpj)
		INTO STRICT	cd_fabric_marca_w
		FROM	material_marca
		WHERE	cd_material = cd_material_w
		AND	nr_sequencia = nr_seq_marca_w;

		SELECT	obter_se_existe_doc_venc_NF(cd_fabric_marca_w, nr_sequencia_p)
		INTO STRICT	ie_possui_doc_venc_w
		;


		IF (ie_possui_doc_venc_w = 'S') AND (ie_consiste_doc_vencido_w = 'S')	THEN
			ds_erro_w:= SUBSTR(ds_erro_w || WHEB_MENSAGEM_PCK.get_texto(278484) || CHR(13) || CHR(10),1,255);

			CALL gravar_nota_fiscal_consist(
				nr_sequencia_p,
				WHEB_MENSAGEM_PCK.get_texto(278209) || nr_item_nf_p || WHEB_MENSAGEM_PCK.get_texto(278485),
				'S','I',
				WHEB_MENSAGEM_PCK.get_texto(278486),
				nm_usuario_p,'S',nr_item_nf_p);
		END IF;
		END;
	END IF;

	IF (coalesce(ie_obriga_serie_w,'N') <> 'N') THEN
		SELECT	nr_serie_material
		INTO STRICT	nr_serie_material_w
		FROM	nota_fiscal_item
		WHERE	nr_sequencia = nr_sequencia_p
		AND	nr_item_nf = nr_item_nf_p;

		IF (coalesce(ie_obriga_serie_w,'N') = 'S') AND (coalesce(nr_serie_material_w::text, '') = '') THEN

			ds_erro_w := SUBSTR(ds_erro_w || nr_item_nf_p || '-' || WHEB_MENSAGEM_PCK.get_texto(278487) || CHR(13) || CHR(10),1,4000);

			CALL gravar_nota_fiscal_consist(
				nr_sequencia_p,
				WHEB_MENSAGEM_PCK.get_texto(278209) || nr_item_nf_p || WHEB_MENSAGEM_PCK.get_texto(278488),
				'S','I',
				WHEB_MENSAGEM_PCK.get_texto(278489),
				nm_usuario_p,'S',nr_item_nf_p);

		ELSIF (coalesce(ie_obriga_serie_w,'N') = 'D') THEN
			ie_controla_serie_w := obter_se_mat_controla_serie(cd_estabelecimento_w, cd_material_w);

			IF (ie_controla_serie_w = 'P') AND (coalesce(nr_serie_material_w::text, '') = '') THEN

				CALL gravar_nota_fiscal_consist(
				nr_sequencia_p,
				WHEB_MENSAGEM_PCK.get_texto(278209) || nr_item_nf_p || WHEB_MENSAGEM_PCK.get_texto(278490),
				'N','I',
				'',
				nm_usuario_p,'S',nr_item_nf_p);

			ELSIF (ie_controla_serie_w = 'O') AND (coalesce(nr_serie_material_w::text, '') = '') THEN

				ds_erro_w := SUBSTR(ds_erro_w || nr_item_nf_p || '-' || WHEB_MENSAGEM_PCK.get_texto(278491) || CHR(13) || CHR(10),1,4000);

				CALL gravar_nota_fiscal_consist(
				nr_sequencia_p,
				WHEB_MENSAGEM_PCK.get_texto(278209) || nr_item_nf_p || WHEB_MENSAGEM_PCK.get_texto(278492),
				'S','I',
				'',
				nm_usuario_p,'S',nr_item_nf_p);

			END IF;
		END IF;

	END IF;

	--fabricante
	SELECT	CASE WHEN ie_consiste_status_marca_w='S' THEN 'S'  ELSE 'N' END
	INTO STRICT	ie_consiste_status_marca_ww
	;

	IF (ie_consiste_status_marca_w <> 'N') THEN

		SELECT	coalesce(MAX(a.nr_seq_marca),0),
			SUBSTR(MAX(obter_desc_marca(a.nr_seq_marca)),1,255),
			SUBSTR(MAX(obter_desc_status_aval_marca(c.nr_seq_status_aval)),1,255)
		INTO STRICT	nr_seq_marca_w,
			ds_marca_w,
			ds_status_marca_w
		FROM	nota_fiscal_item a,
			material_marca c
		WHERE	c.nr_sequencia		= a.nr_seq_marca
		AND	a.cd_material		= c.cd_material
		AND	a.nr_sequencia		= nr_sequencia_p
		AND	a.nr_item_nf		= nr_item_nf_p
		AND	c.nr_seq_status_aval	> 0
		AND	obter_tipo_status_aval_marca(c.nr_seq_status_aval) <> 'A';

		IF (nr_seq_marca_w > 0) THEN

			CALL gravar_nota_fiscal_consist(
				nr_sequencia_p,
				WHEB_MENSAGEM_PCK.get_texto(278209) || nr_item_nf_p || WHEB_MENSAGEM_PCK.get_texto(278493) || ds_marca_w || WHEB_MENSAGEM_PCK.get_texto(278494) || ds_status_marca_w || '.',
				ie_consiste_status_marca_ww,'I',
				WHEB_MENSAGEM_PCK.get_texto(278495),
				nm_usuario_p,'S',nr_item_nf_p);
		END IF;
	END IF;

	/* Consistir Natureza Operacao */

	IF (ie_permite_nat_diferente_w = 'N') AND (cd_natureza_nota_w <> cd_natureza_item_w) THEN
		ds_erro_w := SUBSTR(ds_erro_w || nr_item_nf_p || '-' || 'N -' ||
			WHEB_MENSAGEM_PCK.get_texto(278496) || CHR(13) || CHR(10),1,4000);

		CALL gravar_nota_fiscal_consist(
			nr_sequencia_p,
			WHEB_MENSAGEM_PCK.get_texto(278209) || nr_item_nf_p || WHEB_MENSAGEM_PCK.get_texto(278497),
			'N','I',
			WHEB_MENSAGEM_PCK.get_texto(278498),
			nm_usuario_p,'S',nr_item_nf_p);
	END IF;

	if (coalesce(nr_seq_far_venda_w::text, '') = '') then
		/* Consistir Material Consignado */

		IF (ie_consignado_operacao_w <> '0') AND (ie_consignado_material_w = '0') THEN
			ds_erro_w := SUBSTR(ds_erro_w || nr_item_nf_p || '-' || 'S -' || WHEB_MENSAGEM_PCK.get_texto(278499) || CHR(13) || CHR(10),1,4000);

			CALL gravar_nota_fiscal_consist(
				nr_sequencia_p,
				WHEB_MENSAGEM_PCK.get_texto(278209) || nr_item_nf_p || WHEB_MENSAGEM_PCK.get_texto(278501),
				'S','I',
				WHEB_MENSAGEM_PCK.get_texto(278503),
				nm_usuario_p,'S',nr_item_nf_p);
		END IF;

		IF (ie_consignado_operacao_w = '0') AND (ie_consignado_material_w = '1') THEN
			ds_erro_w := SUBSTR(ds_erro_w || nr_item_nf_p || '-' || 'S -' || WHEB_MENSAGEM_PCK.get_texto(278504) || CHR(13) || CHR(10),1,4000);

			CALL gravar_nota_fiscal_consist(
				nr_sequencia_p,
				WHEB_MENSAGEM_PCK.get_texto(278209) || nr_item_nf_p || WHEB_MENSAGEM_PCK.get_texto(278508),
				'S','I',
				WHEB_MENSAGEM_PCK.get_texto(278509),
				nm_usuario_p,'S',nr_item_nf_p);

		END IF;
	end if;

	IF	(ie_exige_centro_loc_direto_w = 'S' AND ie_local_direto_w = 1) OR
		(ie_exige_centro_loc_direto_w = 'D' AND ie_local_direto_w = 0) THEN

		SELECT	COUNT(*)
		INTO STRICT	qt_existe_rateio_w
		FROM	Nota_fiscal_item_rateio
		WHERE	nr_seq_nota	= nr_sequencia_p
		AND	nr_item_nf	= nr_item_nf_p  LIMIT 1;

		IF (coalesce(cd_centro_custo_w::text, '') = '') AND (qt_existe_rateio_w = 0) THEN
			ds_erro_w := SUBSTR(ds_erro_w || nr_item_nf_p || '-' || 'S -' || WHEB_MENSAGEM_PCK.get_texto(278510) || CHR(13) || CHR(10),1,4000);

			CALL gravar_nota_fiscal_consist(
				nr_sequencia_p,
				WHEB_MENSAGEM_PCK.get_texto(278209) || nr_item_nf_p || WHEB_MENSAGEM_PCK.get_texto(278511),
				'S','I',
				WHEB_MENSAGEM_PCK.get_texto(278512),
				nm_usuario_p,'S',nr_item_nf_p);

		END IF;
	END IF;

	IF (ie_consignado_operacao_w in ('1','8')) THEN
		BEGIN
		IF (coalesce(cd_centro_custo_w::text, '') = '') THEN
			ds_erro_w := SUBSTR(ds_erro_w || nr_item_nf_p || '-' || 'S -' || WHEB_MENSAGEM_PCK.get_texto(278510) || CHR(13) || CHR(10),1,4000);

			CALL gravar_nota_fiscal_consist(
				nr_sequencia_p,
				WHEB_MENSAGEM_PCK.get_texto(278209) || nr_item_nf_p || WHEB_MENSAGEM_PCK.get_texto(278511),
				'S','I',
				WHEB_MENSAGEM_PCK.get_texto(278513),
				nm_usuario_p,'S',nr_item_nf_p);

		ELSIF (cd_local_estoque_w IS NOT NULL AND cd_local_estoque_w::text <> '') AND (ie_local_direto_w = 0) THEN
			ds_erro_w := SUBSTR(ds_erro_w || nr_item_nf_p || '-' || 'S -' ||
					WHEB_MENSAGEM_PCK.get_texto(278514) || CHR(13) || CHR(10),1,4000);

			CALL gravar_nota_fiscal_consist(
				nr_sequencia_p,
				WHEB_MENSAGEM_PCK.get_texto(278209) || nr_item_nf_p || WHEB_MENSAGEM_PCK.get_texto(278515),
				'S','I',
				WHEB_MENSAGEM_PCK.get_texto(278516),
				nm_usuario_p,'S',nr_item_nf_p);
		END IF;
		END;
	END IF;

	IF (coalesce(cd_local_estoque_w::text, '') = '') THEN
		ds_erro_w := SUBSTR(ds_erro_w || nr_item_nf_p || '-' || 'S -' || WHEB_MENSAGEM_PCK.get_texto(278517) || CHR(13) || CHR(10),1,4000);

		CALL gravar_nota_fiscal_consist(
			nr_sequencia_p,
			WHEB_MENSAGEM_PCK.get_texto(278209) || nr_item_nf_p || WHEB_MENSAGEM_PCK.get_texto(278518),
			'S','I',
			WHEB_MENSAGEM_PCK.get_texto(278520),
			nm_usuario_p,'S',nr_item_nf_p);
	END IF;

	IF (ie_consignado_operacao_w = '2') THEN
		IF (cd_centro_custo_w IS NOT NULL AND cd_centro_custo_w::text <> '') THEN
			ds_erro_w := SUBSTR(ds_erro_w || nr_item_nf_p || '-' || 'S -' || WHEB_MENSAGEM_PCK.get_texto(278521) || CHR(13) || CHR(10),1,4000);

			CALL gravar_nota_fiscal_consist(
				nr_sequencia_p,
				WHEB_MENSAGEM_PCK.get_texto(278209) || nr_item_nf_p || WHEB_MENSAGEM_PCK.get_texto(278522),
				'S','I',
				WHEB_MENSAGEM_PCK.get_texto(278520),
				nm_usuario_p,'S',nr_item_nf_p);
		END IF;
	END IF;

	IF (ie_consignado_operacao_w = '3') THEN
		BEGIN
		IF (coalesce(cd_local_estoque_w::text, '') = '') OR (coalesce(cd_centro_custo_w::text, '') = '') THEN
			ds_erro_w := SUBSTR(ds_erro_w || nr_item_nf_p || '-' || 'S -' ||
				WHEB_MENSAGEM_PCK.get_texto(278523) || CHR(13) || CHR(10),1,4000);

			CALL gravar_nota_fiscal_consist(
				nr_sequencia_p,
				WHEB_MENSAGEM_PCK.get_texto(278209) || nr_item_nf_p || WHEB_MENSAGEM_PCK.get_texto(278524),
				'S','I',
				WHEB_MENSAGEM_PCK.get_texto(278525),
				nm_usuario_p,'S',nr_item_nf_p);
		END IF;
		IF (coalesce(cd_local_estoque_w::text, '') = '') OR (coalesce(cd_centro_custo_w::text, '') = '') OR (ie_local_direto_w = 1) THEN
			ds_erro_w := SUBSTR(ds_erro_w || nr_item_nf_p || '-' || 'S -' ||
				WHEB_MENSAGEM_PCK.get_texto(278544) || CHR(13) || CHR(10),1,4000);

			CALL gravar_nota_fiscal_consist(
				nr_sequencia_p,
				WHEB_MENSAGEM_PCK.get_texto(278209) || nr_item_nf_p || WHEB_MENSAGEM_PCK.get_texto(278560),
				'S','I',
				WHEB_MENSAGEM_PCK.get_texto(278561),
				nm_usuario_p,'S',nr_item_nf_p);
		END IF;
		END;
	END IF;

	/* Consistir Unidade de Medida */

	IF (coalesce(cd_unidade_medida_compra_w::text, '') = '') THEN
		ds_erro_w := SUBSTR(ds_erro_w || nr_item_nf_p || '-' || 'S -' || WHEB_MENSAGEM_PCK.get_texto(278562) || CHR(13) || CHR(10),1,4000);

		CALL gravar_nota_fiscal_consist(
				nr_sequencia_p,
				WHEB_MENSAGEM_PCK.get_texto(278209) || nr_item_nf_p || WHEB_MENSAGEM_PCK.get_texto(278564),
				'S','I',
				WHEB_MENSAGEM_PCK.get_texto(278566),
				nm_usuario_p,'S',nr_item_nf_p);
	END IF;
	IF (coalesce(cd_unidade_medida_estoque_w::text, '') = '') THEN
		ds_erro_w := SUBSTR(ds_erro_w ||  nr_item_nf_p || '-' || 'S -' || WHEB_MENSAGEM_PCK.get_texto(278568) || CHR(13) || CHR(10),1,4000);

		CALL gravar_nota_fiscal_consist(
				nr_sequencia_p,
				WHEB_MENSAGEM_PCK.get_texto(278209) || nr_item_nf_p || WHEB_MENSAGEM_PCK.get_texto(278569),
				'S','I',
				WHEB_MENSAGEM_PCK.get_texto(278570),
				nm_usuario_p,'S',nr_item_nf_p);
	END IF;



	/* Consistir Totais e Qtdades do Item */

	IF (vl_unitario_item_nf_w = 0) then


		ds_erro_w := SUBSTR(ds_erro_w || nr_item_nf_p || '-' || 'S -' || WHEB_MENSAGEM_PCK.get_texto(278573) || CHR(13) || CHR(10),1,4000);

		CALL gravar_nota_fiscal_consist(
				nr_sequencia_p,
				WHEB_MENSAGEM_PCK.get_texto(278209) || nr_item_nf_p || WHEB_MENSAGEM_PCK.get_texto(278574),
				'S','I',
				WHEB_MENSAGEM_PCK.get_texto(278576),
				nm_usuario_p,'S',nr_item_nf_p);

	END IF;

	IF (qt_item_nf_w = 0) then

		ds_erro_w := SUBSTR(ds_erro_w || nr_item_nf_p || '-' || 'S -' || WHEB_MENSAGEM_PCK.get_texto(278577) || CHR(13) || CHR(10),1,4000);

		CALL gravar_nota_fiscal_consist(
				nr_sequencia_p,
				WHEB_MENSAGEM_PCK.get_texto(278209) || nr_item_nf_p || WHEB_MENSAGEM_PCK.get_texto(278584),
				'S','I',
				WHEB_MENSAGEM_PCK.get_texto(278585),
				nm_usuario_p,'S',nr_item_nf_p);

	END IF;

	vl_dif_item_w	:= 0;
	IF (qt_item_nf_w > 0) THEN
		if ie_param_485_w = 'U' then
			vl_dif_item_w	:= round((vl_unitario_item_nf_w * qt_item_nf_w)::numeric, 4) - vl_total_item_nf_w;
		else
			vl_dif_item_w	:= round((vl_total_item_nf_w / qt_item_nf_w)::numeric, 4) - vl_unitario_item_nf_w;
		end if;
	END IF;
	IF (ABS(vl_dif_item_w) > vl_arredondamento_w) THEN
		ds_erro_w := SUBSTR(ds_erro_w || nr_item_nf_p || '-' || 'S -' ||
			WHEB_MENSAGEM_PCK.get_texto(278586) || vl_dif_item_w || WHEB_MENSAGEM_PCK.get_texto(278587) || CHR(13) || CHR(10),1,4000);

		CALL gravar_nota_fiscal_consist(
				nr_sequencia_p,
				WHEB_MENSAGEM_PCK.get_texto(278209) || nr_item_nf_p || WHEB_MENSAGEM_PCK.get_texto(278588) || vl_dif_item_w || '.',
				'S','I',
				WHEB_MENSAGEM_PCK.get_texto(278589),
				nm_usuario_p,'S',nr_item_nf_p);

	END IF;

	/* Consistir Rateio por Centro de Custo */

	SELECT	COUNT(*),
		coalesce(SUM(vl_rateio),0),
		coalesce(SUM(qt_rateio),0)
	INTO STRICT	qt_item_rateio_w,
		vl_rateio_w,
		qt_rateio_w
	FROM	Nota_fiscal_item_rateio
	WHERE	nr_seq_nota	= nr_sequencia_p
	AND	nr_item_nf	= nr_item_nf_p;

	IF ((qt_item_rateio_w > 0) AND (qt_rateio_w = 0) AND (vl_rateio_w = 0)) THEN
		ds_erro_w := SUBSTR(ds_erro_w || nr_item_nf_p || '-' || 'S -' || WHEB_MENSAGEM_PCK.get_texto(329178) || CHR(13) || CHR(10),1,4000);

		CALL gravar_nota_fiscal_consist(
			nr_sequencia_p,
			WHEB_MENSAGEM_PCK.get_texto(278209) || nr_item_nf_p || WHEB_MENSAGEM_PCK.get_texto(329179),
			'S','I',
			WHEB_MENSAGEM_PCK.get_texto(329180),
			nm_usuario_p,'S',nr_item_nf_p);
	END IF;

	SELECT	SUM(vl_total_item_nf)
	INTO STRICT	vl_soma_itens_w
	FROM	nota_fiscal_item
	WHERE	nr_sequencia = nr_sequencia_p;

	vl_tot_item_nf_desp_w	:= ((round((vl_despesa_acessoria_w /100)::numeric,4)) * (dividir((vl_total_item_nf_w * 100),vl_soma_itens_w))) + vl_total_item_nf_w;

	IF	((ie_desp_aces_rateio_itens_w = 'S') AND (vl_rateio_w > 0) AND
		(qt_item_rateio_w > 0 AND vl_rateio_w <> vl_tot_item_nf_desp_w)) OR
		((ie_desp_aces_rateio_itens_w <> 'S') AND (vl_rateio_w > 0) AND
		(qt_item_rateio_w > 0 AND vl_rateio_w <> vl_total_item_nf_w)) THEN

		ds_erro_w := SUBSTR(ds_erro_w || nr_item_nf_p || '-' || 'S -' || WHEB_MENSAGEM_PCK.get_texto(278590) || CHR(13) || CHR(10),1,4000);

		CALL gravar_nota_fiscal_consist(
			nr_sequencia_p,
			WHEB_MENSAGEM_PCK.get_texto(278209) || nr_item_nf_p || WHEB_MENSAGEM_PCK.get_texto(278591),
			'S','I',
			WHEB_MENSAGEM_PCK.get_texto(278592),
			nm_usuario_p,'S',nr_item_nf_p);

	END IF;

	IF (qt_rateio_w > 0) AND (qt_item_rateio_w > 0) AND (qt_rateio_w <> round((qt_item_nf_w)::numeric,2)) THEN
		ds_erro_w := SUBSTR(ds_erro_w || nr_item_nf_p || '-' || 'S -' || WHEB_MENSAGEM_PCK.get_texto(278593) || CHR(13) || CHR(10),1,4000);

		CALL gravar_nota_fiscal_consist(
			nr_sequencia_p,
			WHEB_MENSAGEM_PCK.get_texto(278209) || nr_item_nf_p || WHEB_MENSAGEM_PCK.get_texto(278594),
			'S','I',
			WHEB_MENSAGEM_PCK.get_texto(278595),
			nm_usuario_p,'S',nr_item_nf_p);
	END IF;

	SELECT	COUNT(*)
	INTO STRICT	qt_item_rateio_inativo_w
	FROM	centro_custo b,
		Nota_fiscal_item_rateio a
	WHERE	a.cd_centro_custo = b.cd_centro_custo
	AND	b.ie_situacao = 'I'
	AND	a.nr_seq_nota	= nr_sequencia_p
	AND	a.nr_item_nf	= nr_item_nf_p  LIMIT 1;

	IF (qt_item_rateio_inativo_w > 0) THEN
		ds_erro_w := SUBSTR(ds_erro_w || nr_item_nf_p || '-' || 'S -' || WHEB_MENSAGEM_PCK.get_texto(278597) || CHR(13) || CHR(10),1,4000);

		CALL gravar_nota_fiscal_consist(
				nr_sequencia_p,
				WHEB_MENSAGEM_PCK.get_texto(278209) || nr_item_nf_p || WHEB_MENSAGEM_PCK.get_texto(278599),
				'S','I',
				WHEB_MENSAGEM_PCK.get_texto(278600),
				nm_usuario_p,'S',nr_item_nf_p);
	END IF;


	/* Consistir Local de Estoque */

	IF (cd_local_estoque_w IS NOT NULL AND cd_local_estoque_w::text <> '') AND (ie_local_direto_w = 0) THEN
		BEGIN
		IF (ie_material_estoque_w = 'S') THEN
			BEGIN
			ie_local_valido_w := obter_local_valido(	cd_estabelecimento_w, cd_local_estoque_w, cd_material_w, '1', ie_local_valido_w);

			IF (cd_local_estoque_w <> 8) AND (ie_local_valido_w <> 'S') THEN
				ds_erro_w := SUBSTR(ds_erro_w || nr_item_nf_p || '-S-[' || cd_material_w || '] - ' || WHEB_MENSAGEM_PCK.get_texto(278601) || CHR(13) || CHR(10),1,4000);

				CALL gravar_nota_fiscal_consist(
					nr_sequencia_p,
					WHEB_MENSAGEM_PCK.get_texto(278209) || nr_item_nf_p || WHEB_MENSAGEM_PCK.get_texto(278602),
					'S','I',
					WHEB_MENSAGEM_PCK.get_texto(278603),
					nm_usuario_p,'S',nr_item_nf_p);

			END IF;
			END;
		END IF;
		IF (ie_material_estoque_w = 'N') THEN
			ds_erro_w := SUBSTR(ds_erro_w || nr_item_nf_p || '-S-[' || cd_material_w || '] - ' || WHEB_MENSAGEM_PCK.get_texto(278604) || CHR(13) || CHR(10),1,4000);

			CALL gravar_nota_fiscal_consist(
					nr_sequencia_p,
					WHEB_MENSAGEM_PCK.get_texto(278209) || nr_item_nf_p || WHEB_MENSAGEM_PCK.get_texto(278605),
					'S','I',
					WHEB_MENSAGEM_PCK.get_texto(278606),
					nm_usuario_p,'S',nr_item_nf_p);
		END IF;
		END;
	END IF;

	IF (cd_local_estoque_w > 0) THEN
		SELECT	coalesce(ie_centro_custo_nf,'N')
		INTO STRICT	ie_centro_custo_nf_w
		FROM	local_estoque
		WHERE	cd_local_estoque = cd_local_estoque_w;
	END IF;

	/* Consistir Local e Centro de Custo */

	IF	((ie_consignado_material_w = '0') OR
		(ie_consignado_material_w = '2' AND ie_consignado_operacao_w = '0')) AND (cd_local_estoque_w IS NOT NULL AND cd_local_estoque_w::text <> '') AND (cd_centro_custo_w IS NOT NULL AND cd_centro_custo_w::text <> '') AND (ie_local_direto_w = 0) AND (ie_centro_custo_nf_w = 'N') THEN
		BEGIN
		ie_obriga_local_centro_w	:= 'S -';
		ie_obriga_local_centro_ww	:= 'S';

		IF (ie_tipo_nota_w = 'SD')THEN
			ie_obriga_local_centro_w	:= 'N -';
			ie_obriga_local_centro_ww	:= 'N';
		END IF;
		ds_erro_w := SUBSTR(ds_erro_w || nr_item_nf_p || '-' || ie_obriga_local_centro_w ||
				WHEB_MENSAGEM_PCK.get_texto(278611) || CHR(13) || CHR(10),1,4000);

		CALL gravar_nota_fiscal_consist(
			nr_sequencia_p,
			WHEB_MENSAGEM_PCK.get_texto(278209) || nr_item_nf_p || WHEB_MENSAGEM_PCK.get_texto(278612),
			ie_obriga_local_centro_ww,'I',
			WHEB_MENSAGEM_PCK.get_texto(278615),
			nm_usuario_p,'S',nr_item_nf_p);

		END;
	END IF;

	IF (ie_consignado_operacao_w IN (0,4)) AND (coalesce(cd_local_estoque_w::text, '') = '') AND (cd_centro_custo_w IS  NULL) THEN
		ds_erro_w := SUBSTR(ds_erro_w || nr_item_nf_p || '-' || 'S -' || WHEB_MENSAGEM_PCK.get_texto(278618) || CHR(13) || CHR(10),1,4000);

		CALL gravar_nota_fiscal_consist(
			nr_sequencia_p,
			WHEB_MENSAGEM_PCK.get_texto(278209) || nr_item_nf_p || WHEB_MENSAGEM_PCK.get_texto(278620),
			'S','I',
			WHEB_MENSAGEM_PCK.get_texto(278622),
			nm_usuario_p,'S',nr_item_nf_p);

	END IF;

	/* Consistir Centro de Custo Ativo */

	IF (coalesce(cd_centro_custo_w,0) > 0) THEN
		SELECT	coalesce(MAX(ie_situacao),'I')
		INTO STRICT	ie_situacao_ww
		FROM	centro_custo
		WHERE	cd_centro_custo	= cd_centro_custo_w;
		IF (ie_situacao_ww <> 'A') THEN
			ds_erro_w := SUBSTR(ds_erro_w || nr_item_nf_p || '-' || 'N -' || WHEB_MENSAGEM_PCK.get_texto(278623) || CHR(13) || CHR(10),1,4000);

			CALL gravar_nota_fiscal_consist(
				nr_sequencia_p,
				WHEB_MENSAGEM_PCK.get_texto(278209) || nr_item_nf_p || WHEB_MENSAGEM_PCK.get_texto(278624),
				'N','I',
				WHEB_MENSAGEM_PCK.get_texto(278625),
				nm_usuario_p,'S',nr_item_nf_p);
		END IF;
	END IF;
	/* Consistir Conta financeira */

	IF (ie_conta_financeira_w = 'S') THEN
		SELECT	COUNT(*)
		INTO STRICT	qt_existe_w
		FROM	nota_fiscal_item
		WHERE	nr_sequencia	= nr_sequencia_p
		AND	nr_item_nf	= nr_item_nf_p
		AND	coalesce(nr_seq_conta_financ::text, '') = ''  LIMIT 1;

		IF (qt_existe_w > 0) THEN
			ds_erro_w := SUBSTR(ds_erro_w || nr_item_nf_p || '-' || 'S -' || WHEB_MENSAGEM_PCK.get_texto(278626) || CHR(13) || CHR(10),1,4000);

			CALL gravar_nota_fiscal_consist(
				nr_sequencia_p,
				WHEB_MENSAGEM_PCK.get_texto(278209) || nr_item_nf_p || WHEB_MENSAGEM_PCK.get_texto(278627),
				'S','I',
				WHEB_MENSAGEM_PCK.get_texto(278628),
				nm_usuario_p,'S',nr_item_nf_p);
		END IF;
	END IF;

	/* Consistir Conta Contabil */

	ie_tipo_conta_w	:= 3;
	IF (coalesce(cd_centro_custo_w::text, '') = '') THEN
		ie_tipo_conta_w	:= 2;
	END IF;

	ds_erro_grupo_conta_w := consiste_grupo_centro_conta(cd_conta_contabil_nota_w, cd_centro_custo_w, NULL, ds_erro_grupo_conta_w);
	IF (ds_erro_grupo_conta_w IS NOT NULL AND ds_erro_grupo_conta_w::text <> '') THEN
		ds_erro_w := SUBSTR(ds_erro_w || nr_item_nf_p || '-' || 'S -' ||
				REPLACE(REPLACE(ds_erro_grupo_conta_w, CHR(13), ''), CHR(10), '') || CHR(13) || CHR(10),1,4000);

		CALL gravar_nota_fiscal_consist(
				nr_sequencia_p,
				WHEB_MENSAGEM_PCK.get_texto(278209) || nr_item_nf_p || REPLACE(REPLACE(ds_erro_grupo_conta_w, CHR(13), ''), CHR(10), ''),
				'S','I',
				'',
				nm_usuario_p,'S',nr_item_nf_p);
	END IF;

	SELECT * FROM define_conta_material(cd_estabelecimento_w, cd_material_w, ie_tipo_conta_w, ie_clinica_w, NULL, NULL, NULL, NULL, NULL, NULL, cd_local_conta_w, NULL, NULL, cd_conta_contabil_w, cd_centro_custo_w, NULL) INTO STRICT cd_conta_contabil_w, cd_centro_custo_w;

	select	count(1)
	into STRICT	qt_existe_rate_w
	from	nota_fiscal_item_rateio
	where	nr_seq_nota	= nr_sequencia_p
	and	nr_item_nf	= nr_item_nf_p  LIMIT 1;

	IF (qt_existe_rate_w > 0) THEN
		OPEN C02;
		LOOP
		FETCH C02 INTO
			cd_conta_contabil_rateito_w;
		EXIT WHEN NOT FOUND; /* apply on C02 */
			BEGIN
				/*deve ser pego a do item caso existir rateio sem conta contabil*/

				IF	((coalesce(cd_conta_contabil_rateito_w::text, '') = '') AND (ie_obriga_conta_contabil_mat_w = 'S')) THEN
					ds_erro_w := SUBSTR(ds_erro_w || nr_item_nf_p || '-' || ie_obriga_conta_contabil_mat_w || ' -' ||
						WHEB_MENSAGEM_PCK.get_texto(1091206) || CHR(13) || CHR(10),1,4000);

					CALL gravar_nota_fiscal_consist(
						nr_sequencia_p,
						WHEB_MENSAGEM_PCK.get_texto(278209) || nr_item_nf_p || ' - ' || WHEB_MENSAGEM_PCK.get_texto(1091206),
						ie_obriga_conta_contabil_mat_w,'I',
						WHEB_MENSAGEM_PCK.get_texto(278631),
						nm_usuario_p,'S',nr_item_nf_p);

				ELSE
					SELECT	SUBSTR(obter_se_conta_vigente(cd_conta_contabil_rateito_w, TRUNC(dt_entrada_saida_w,'dd')),1,1)
					INTO STRICT	ie_conta_vigente_w
					;
					IF (ie_conta_vigente_w = 'N') THEN
						ds_erro_w := SUBSTR(ds_erro_w || nr_item_nf_p || '-' || 'S -' ||
							WHEB_MENSAGEM_PCK.get_texto(1091207) || CHR(13) || CHR(10),1,4000);

						CALL gravar_nota_fiscal_consist(
							nr_sequencia_p,
							WHEB_MENSAGEM_PCK.get_texto(278209) || nr_item_nf_p || ' - ' || WHEB_MENSAGEM_PCK.get_texto(1091207),
							'S','I',
							WHEB_MENSAGEM_PCK.get_texto(278636),
							nm_usuario_p,'S',nr_item_nf_p);
					END IF;
				END IF;

			END;
		END LOOP;
		CLOSE C02;
	ELSE
		IF	((coalesce(cd_conta_contabil_nota_w::text, '') = '') AND (ie_obriga_conta_contabil_mat_w = 'S')) THEN
			ds_erro_w := SUBSTR(ds_erro_w || nr_item_nf_p || '-' || ie_obriga_conta_contabil_mat_w || ' -' ||
				WHEB_MENSAGEM_PCK.get_texto(278629) || CHR(13) || CHR(10),1,4000);

			CALL gravar_nota_fiscal_consist(
				nr_sequencia_p,
				WHEB_MENSAGEM_PCK.get_texto(278209) || nr_item_nf_p || WHEB_MENSAGEM_PCK.get_texto(278630),
				ie_obriga_conta_contabil_mat_w,'I',
				WHEB_MENSAGEM_PCK.get_texto(278631),
				nm_usuario_p,'S',nr_item_nf_p);

		ELSE
			SELECT	SUBSTR(obter_se_conta_vigente(cd_conta_contabil_nota_w, TRUNC(dt_entrada_saida_w,'dd')),1,1)
			INTO STRICT	ie_conta_vigente_w
			;
			IF (ie_conta_vigente_w = 'N') THEN
				ds_erro_w := SUBSTR(ds_erro_w || nr_item_nf_p || '-' || 'S -' ||
					WHEB_MENSAGEM_PCK.get_texto(278632) || CHR(13) || CHR(10),1,4000);

				CALL gravar_nota_fiscal_consist(
					nr_sequencia_p,
					WHEB_MENSAGEM_PCK.get_texto(278209) || nr_item_nf_p || WHEB_MENSAGEM_PCK.get_texto(278635),
					'S','I',
					WHEB_MENSAGEM_PCK.get_texto(278636),
					nm_usuario_p,'S',nr_item_nf_p);
			END IF;
		END IF;
	END IF;

	IF (cd_conta_contabil_w <> cd_conta_contabil_nota_w) THEN
		ds_erro_w := SUBSTR(ds_erro_w || nr_item_nf_p || '-' || 'N -' ||
			WHEB_MENSAGEM_PCK.get_texto(278639) || CHR(13) || CHR(10),1,4000);

		CALL gravar_nota_fiscal_consist(
				nr_sequencia_p,
				WHEB_MENSAGEM_PCK.get_texto(278209) || nr_item_nf_p || WHEB_MENSAGEM_PCK.get_texto(278640),
				'N','I',
				WHEB_MENSAGEM_PCK.get_texto(278641),
				nm_usuario_p,'S',nr_item_nf_p);
	END IF;

	IF (cd_conta_contabil_w IS NOT NULL AND cd_conta_contabil_w::text <> '') THEN

		SELECT	ie_situacao
		INTO STRICT	ie_situacao_w
		FROM	conta_contabil
		WHERE	cd_conta_contabil = cd_conta_contabil_w;

		IF (ie_situacao_w = 'I') THEN

		ds_erro_w := SUBSTR(ds_erro_w || nr_item_nf_p || '-' || 'S -' ||
			WHEB_MENSAGEM_PCK.get_texto(278643) || cd_conta_contabil_w ||WHEB_MENSAGEM_PCK.get_texto(278642) || CHR(13) || CHR(10),1,4000);

		CALL gravar_nota_fiscal_consist(
				nr_sequencia_p,
				WHEB_MENSAGEM_PCK.get_texto(278209) || nr_item_nf_p || WHEB_MENSAGEM_PCK.get_texto(278645) || cd_conta_contabil_w || WHEB_MENSAGEM_PCK.get_texto(278647),
				'S','I',
				WHEB_MENSAGEM_PCK.get_texto(278650),
				nm_usuario_p,'S',nr_item_nf_p);
		END IF;
	END IF;

	/* Consistir Ordem de Compra */

	IF (nr_ordem_compra_w IS NOT NULL AND nr_ordem_compra_w::text <> '') THEN
		SELECT	ie_tipo_ordem
		INTO STRICT	ie_tipo_ordem_w
		FROM	ordem_compra
		WHERE	nr_ordem_compra = nr_ordem_compra_w;
	END IF;

	IF (ie_consiste_qt_pend_oc_w = 'S') AND (nr_ordem_compra_w IS NOT NULL AND nr_ordem_compra_w::text <> '') AND (nr_item_oci_w IS NOT NULL AND nr_item_oci_w::text <> '') THEN

		SELECT	SUM(qt_item_nf)
		INTO STRICT	qt_item_nf_ww
		FROM	nota_fiscal_item
		WHERE	nr_ordem_compra = nr_ordem_compra_w
		AND	nr_item_oci = nr_item_oci_w
		AND	nr_sequencia = nr_sequencia_p;

		SELECT	SUM(qt_prevista_entrega - coalesce(qt_real_entrega,0))
		INTO STRICT	qt_pendente_entrega_w
		FROM	ordem_compra_item_entrega
		WHERE	nr_ordem_compra = nr_ordem_compra_w
		AND	nr_item_oci = nr_item_oci_w
		AND	qt_prevista_entrega > coalesce(qt_real_entrega,0)
		AND	coalesce(dt_cancelamento::text, '') = '';

		IF (qt_item_nf_ww > qt_pendente_entrega_w) THEN
			ds_erro_w	:= SUBSTR(ds_erro_w || nr_item_nf_p || '-' || 'N -' ||
						WHEB_MENSAGEM_PCK.get_texto(278651) || CHR(13) || CHR(10),1,4000);

			CALL gravar_nota_fiscal_consist(
				nr_sequencia_p,
				WHEB_MENSAGEM_PCK.get_texto(278209) || nr_item_nf_p || WHEB_MENSAGEM_PCK.get_texto(278652),
				'N','I',
				WHEB_MENSAGEM_PCK.get_texto(278651),
				nm_usuario_p,'S',nr_item_nf_p);
		END IF;
	END IF;

	IF (ie_consiste_entrega_dif_oc_w = 'S') AND (nr_ordem_compra_w IS NOT NULL AND nr_ordem_compra_w::text <> '') AND (nr_item_oci_w IS NOT NULL AND nr_item_oci_w::text <> '') THEN
		BEGIN

		SELECT	COUNT(*)
		INTO STRICT	qt_existe_w
		FROM	ordem_compra_item_entrega
		WHERE	nr_ordem_compra = nr_ordem_compra_w
		AND	nr_item_oci = nr_item_oci_w
		AND	TRUNC(dt_prevista_entrega) = TRUNC(dt_prevista_entrega_w)  LIMIT 1;

		IF (qt_existe_w = 0) THEN
			BEGIN

			ds_erro_w	:= SUBSTR(ds_erro_w || nr_item_nf_p || '-' || 'N -' ||
						WHEB_MENSAGEM_PCK.get_texto(278653) || CHR(13) || CHR(10),1,4000);

			CALL gravar_nota_fiscal_consist(
				nr_sequencia_p,
				WHEB_MENSAGEM_PCK.get_texto(278209) || nr_item_nf_p || WHEB_MENSAGEM_PCK.get_texto(278654),
				'N','I',
				WHEB_MENSAGEM_PCK.get_texto(278656),
				nm_usuario_p,'S',nr_item_nf_p);

			END;
		END IF;


		END;
	END IF;

	IF (nr_ordem_compra_w IS NOT NULL AND nr_ordem_compra_w::text <> '') AND (nr_item_oci_w IS NOT NULL AND nr_item_oci_w::text <> '') AND (nr_seq_marca_w IS NOT NULL AND nr_seq_marca_w::text <> '') THEN

		SELECT	coalesce(max(nr_seq_marca),0)
		INTO STRICT	nr_seq_marca_oci_w
		FROM	ordem_compra_item a
		WHERE	nr_ordem_compra = nr_ordem_compra_w
		AND	nr_item_oci = nr_item_oci_w;

		IF (nr_seq_marca_oci_w > 0) AND (nr_seq_marca_oci_w <> nr_seq_marca_w) THEN

			CALL gerar_historico_nota_fiscal(
						nr_sequencia_p,
						nm_usuario_p,
						51,
						WHEB_MENSAGEM_PCK.get_texto(278658) || nr_item_nf_p || WHEB_MENSAGEM_PCK.get_texto(278659));

			IF (ie_consiste_marca_oc = 'S') THEN
				ds_erro_w :=	SUBSTR(ds_erro_w || nr_item_nf_p || '-' || 'N -' ||
						WHEB_MENSAGEM_PCK.get_texto(278661) || CHR(13) || CHR(10),1,4000);

				CALL gravar_nota_fiscal_consist(
							nr_sequencia_p,
							WHEB_MENSAGEM_PCK.get_texto(278209) || nr_item_nf_p || WHEB_MENSAGEM_PCK.get_texto(278665),
							'N','I',
							WHEB_MENSAGEM_PCK.get_texto(278661),
							nm_usuario_p,'S',nr_item_nf_p);
			END IF;
		END IF;

	END IF;

	IF (ie_consiste_mat_fiscal_w = 'S') THEN

		SELECT	MAX(nr_seq_ncm)
		INTO STRICT	nr_seq_ncm_w
		FROM	nota_fiscal_item a,
			material_fiscal b
		WHERE	a.nr_sequencia = nr_sequencia_p
		AND	a.nr_item_nf = nr_item_nf_p
		AND	a.cd_material = b.cd_material;

		IF (coalesce(nr_seq_ncm_w::text, '') = '') THEN

			ds_erro_w	:= SUBSTR(ds_erro_w || nr_item_nf_p || '-' || 'S -' ||
						WHEB_MENSAGEM_PCK.get_texto(278666) || CHR(13) || CHR(10),1,4000);
			CALL gravar_nota_fiscal_consist(
				nr_sequencia_p,
				WHEB_MENSAGEM_PCK.get_texto(278209) || nr_item_nf_p || WHEB_MENSAGEM_PCK.get_texto(278667),
				'S','I',
				WHEB_MENSAGEM_PCK.get_texto(278668),
				nm_usuario_p,'S',nr_item_nf_p);
		END IF;
	ELSIF (ie_consiste_mat_fiscal_w = 'D') THEN

		SELECT	ie_classif_fiscal_nf
		INTO STRICT	ie_classif_fiscal_nf_w
		FROM	operacao_nota
		WHERE	cd_operacao_nf	= cd_operacao_nota_w;

		IF (ie_classif_fiscal_nf_w = 'S') THEN
			SELECT	MAX(nr_seq_ncm)
			INTO STRICT	nr_seq_ncm_w
			FROM	nota_fiscal_item a,
				material_fiscal b
			WHERE	a.nr_sequencia = nr_sequencia_p
			AND	a.nr_item_nf = nr_item_nf_p
			AND	a.cd_material = b.cd_material;

			IF (coalesce(nr_seq_ncm_w::text, '') = '') THEN

				ds_erro_w	:= SUBSTR(ds_erro_w || nr_item_nf_p || '-' || 'S -' ||
							WHEB_MENSAGEM_PCK.get_texto(278666) || CHR(13) || CHR(10),1,4000);
				CALL gravar_nota_fiscal_consist(
					nr_sequencia_p,
					WHEB_MENSAGEM_PCK.get_texto(278209) || nr_item_nf_p || WHEB_MENSAGEM_PCK.get_texto(278667),
					'S','I',
					WHEB_MENSAGEM_PCK.get_texto(278668),
					nm_usuario_p,'S',nr_item_nf_p);
			END IF;
		END IF;
	END IF;

	IF (nr_ordem_compra_w IS NOT NULL AND nr_ordem_compra_w::text <> '') AND (nr_item_oci_w IS NOT NULL AND nr_item_oci_w::text <> '') AND (ie_tipo_ordem_w <> 'T') AND (ie_tipo_nota_w <> 'ST') THEN
		SELECT	MAX(coalesce(a.cd_material,0)),
			MAX(coalesce(a.vl_unitario_material,0)),
			MAX(coalesce(b.cd_material_generico,b.cd_material)),
			MAX(coalesce(b.cd_material_estoque,b.cd_material)),
			MAX(a.cd_unidade_medida_compra),
			max(coalesce(vl_item_liquido,0))
		INTO STRICT	cd_material_ordem_w,
			vl_unitario_ordem_w,
			cd_material_gen_oci_w,
			cd_material_est_oci_w,
			cd_unidade_medida_ordem_w,
			vl_item_liquido_w
		FROM	material b,
			ordem_compra_item a
		WHERE	a.cd_material     = b.cd_material
		AND 	a.nr_ordem_compra = nr_ordem_compra_w
		AND 	a.nr_item_oci     = nr_item_oci_w;

		SELECT	cd_condicao_pagamento
		INTO STRICT	cd_cond_pagto_oc_w
		FROM	ordem_compra
		WHERE	nr_ordem_compra = nr_ordem_compra_w;

		vl_unitario_ordem_w	:= (vl_unitario_ordem_w * vl_conv_moeda_w);

		IF (cd_material_ordem_w <> 0) THEN
			IF (ie_altera_material_w <> 'S') THEN
				IF (cd_material_w <> cd_material_ordem_w) THEN
					IF (ie_altera_material_w = 'N') OR
						(ie_altera_material_w = 'G' AND cd_material_generico_w <> cd_material_gen_oci_w) OR
						(ie_altera_material_w = 'E' AND cd_material_estoque_w  <> cd_material_est_oci_w) THEN
						ds_erro_w	:= SUBSTR(ds_erro_w || nr_item_nf_p || '-' || 'N -' ||
								WHEB_MENSAGEM_PCK.get_texto(278672) || CHR(13) || CHR(10),1,4000);

						CALL gravar_nota_fiscal_consist(
							nr_sequencia_p,
							WHEB_MENSAGEM_PCK.get_texto(278209) || nr_item_nf_p || WHEB_MENSAGEM_PCK.get_texto(278677),
							ie_param_465_w,'I',
							WHEB_MENSAGEM_PCK.get_texto(278682),
							nm_usuario_p,'S',nr_item_nf_p);
					END IF;
				END IF;
			END IF;

			/*Verifica diferenca entre Valor unitario (Item nota fiscal X Item Ordem de compras*/

			IF (pr_dif_valor_nota_ordem_w > 0) AND (ie_devolucao_w = 'N') THEN
				BEGIN

				IF (ie_valor_considerar_w = 'L') THEN
					vl_unitario_diferenca_w	:= vl_liquido_item_w;
				ELSE
					vl_unitario_diferenca_w	:= vl_unitario_item_nf_w;
					vl_item_liquido_w  := vl_unitario_ordem_w;
				END IF;

				vl_diferenca_w	:= round((vl_item_liquido_w * pr_dif_valor_nota_ordem_w)/ 100,4);
				IF (ie_dif_valor_nota_ordem_w = 'V') THEN
					vl_diferenca_w	:= pr_dif_valor_nota_ordem_w;
				END IF;

				IF (ie_regra_dif_valor_w = 'A') AND (vl_unitario_diferenca_w > (vl_item_liquido_w + vl_diferenca_w)) THEN
					ds_erro_w := SUBSTR(ds_erro_w || nr_item_nf_p || '-' || 'S -' ||
						WHEB_MENSAGEM_PCK.get_texto(278683) || CHR(13) || CHR(10),1,4000);

					CALL gravar_nota_fiscal_consist(
						nr_sequencia_p,
						WHEB_MENSAGEM_PCK.get_texto(278209) || nr_item_nf_p || WHEB_MENSAGEM_PCK.get_texto(278684),
						'S','I',
						WHEB_MENSAGEM_PCK.get_texto(278686),
						nm_usuario_p,'S',nr_item_nf_p);


				ELSIF (ie_regra_dif_valor_w = 'B') AND (vl_unitario_diferenca_w < (vl_item_liquido_w - vl_diferenca_w)) THEN
					ds_erro_w := SUBSTR(ds_erro_w || nr_item_nf_p || '-' || 'S -' ||
						WHEB_MENSAGEM_PCK.get_texto(278688) || CHR(13) || CHR(10),1,4000);

					CALL gravar_nota_fiscal_consist(
						nr_sequencia_p,
						WHEB_MENSAGEM_PCK.get_texto(278209) || nr_item_nf_p || WHEB_MENSAGEM_PCK.get_texto(278689),
						'S','I',
						WHEB_MENSAGEM_PCK.get_texto(278690),
						nm_usuario_p,'S',nr_item_nf_p);

				ELSIF (ie_regra_dif_valor_w = 'M') AND
					((vl_unitario_diferenca_w > (vl_item_liquido_w + vl_diferenca_w)) OR
					 (vl_unitario_diferenca_w < (vl_item_liquido_w - vl_diferenca_w))) THEN
					ds_erro_w := SUBSTR(ds_erro_w || nr_item_nf_p || '-' || 'S -' ||
						WHEB_MENSAGEM_PCK.get_texto(278694) || CHR(13) || CHR(10),1,4000);

					CALL gravar_nota_fiscal_consist(
						nr_sequencia_p,
						WHEB_MENSAGEM_PCK.get_texto(278209) || nr_item_nf_p || WHEB_MENSAGEM_PCK.get_texto(278695),
						'S','I',
						WHEB_MENSAGEM_PCK.get_texto(278696),
						nm_usuario_p,'S',nr_item_nf_p);
				END IF;
				END;
			END IF;
			IF (pr_dif_valor_nota_ordem_w = 0) AND (vl_unitario_diferenca_w <> vl_item_liquido_w) THEN
				ds_erro_w := SUBSTR(ds_erro_w || nr_item_nf_p || '-' || 'N -' || WHEB_MENSAGEM_PCK.get_texto(278697) || CHR(13) || CHR(10),1,4000);

				CALL gravar_nota_fiscal_consist(
					nr_sequencia_p,
					WHEB_MENSAGEM_PCK.get_texto(278209) || nr_item_nf_p || WHEB_MENSAGEM_PCK.get_texto(278699),
					'N','I',
					WHEB_MENSAGEM_PCK.get_texto(278700),
					nm_usuario_p,'S',nr_item_nf_p);
			END IF;


			/*Verifica diferenca entre quantidade (Item nota fiscal X Item Ordem de compras*/

			SELECT	coalesce(SUM(b.qt_item_nf),0)
			INTO STRICT	qt_total_item_nf_w
			FROM	nota_fiscal a,
				nota_fiscal_item b
			WHERE	a.nr_sequencia = b.nr_Sequencia
			AND	b.nr_ordem_compra = nr_ordem_compra_w
			AND	b.nr_item_oci = nr_item_oci_w
			AND	a.nr_sequencia = nr_sequencia_p
			AND	((coalesce(dt_prevista_entrega_w::text, '') = '') OR (dt_prevista_entrega_w IS NOT NULL AND dt_prevista_entrega_w::text <> '') AND (dt_entrega_ordem = dt_prevista_entrega_w));

			SELECT	SUM(coalesce(qt_prevista_entrega,0)),
				SUM(coalesce(qt_real_entrega,0))
			INTO STRICT	qt_prevista_entrega_w,
				qt_entrega_real_ordem_w
			FROM	ordem_compra_item_entrega
			WHERE	nr_ordem_compra = nr_ordem_compra_w
			AND	nr_item_oci     = nr_item_oci_w
			AND	((coalesce(dt_prevista_entrega_w::text, '') = '') OR (dt_prevista_entrega_w IS NOT NULL AND dt_prevista_entrega_w::text <> '') AND (TRUNC(dt_prevista_entrega) = dt_prevista_entrega_w));

			IF (pr_dif_quant_nota_ordem_w > 0) AND (ie_ent_sai_op_estoque_w = 'E') THEN
				BEGIN

				qt_item_nf_aConsistir_w	:= qt_total_item_nf_w;
				IF (cd_unidade_medida_ordem_w <> cd_unidade_medida_compra_w) THEN
					qt_item_nf_aConsistir_w	:= qt_total_item_nf_w * qt_conv_compra_estoque_w;
					IF (cd_unidade_medida_ordem_w = cd_unidade_compra_material_w) AND (cd_unidade_medida_compra_w = cd_unidade_estoque_material_w) THEN
						qt_item_nf_aConsistir_w	:= dividir(qt_total_item_nf_w, qt_conv_compra_estoque_w);
					END IF;
				END IF;

				IF (ie_dif_quant_nota_ordem_w IN ('PT','VT')) THEN
					BEGIN

					vl_diferenca_w	:= round((qt_prevista_entrega_w * pr_dif_quant_nota_ordem_w) / 100, 4);

					IF (ie_dif_quant_nota_ordem_w = 'VT') THEN
						vl_diferenca_w	:= pr_dif_quant_nota_ordem_w;
					END IF;

					qt_valor_max_ordem_w	:= ((qt_prevista_entrega_w + vl_diferenca_w) - qt_entrega_real_ordem_w);
					qt_valor_min_ordem_w	:= ((qt_prevista_entrega_w - vl_diferenca_w) - qt_entrega_real_ordem_w);

					END;
				ELSE
					BEGIN

					qt_saldo_ordem_w	:= (qt_prevista_entrega_w - qt_entrega_real_ordem_w);

					vl_diferenca_w	:= round((qt_saldo_ordem_w * pr_dif_quant_nota_ordem_w) / 100, 4);
					IF (ie_dif_quant_nota_ordem_w = 'V') THEN
						vl_diferenca_w	:= pr_dif_quant_nota_ordem_w;
					END IF;

					qt_valor_max_ordem_w	:= (qt_saldo_ordem_w + vl_diferenca_w);
					qt_valor_min_ordem_w	:= (qt_saldo_ordem_w - vl_diferenca_w);

					END;
				END IF;



				IF (ie_regra_dif_quant_w = 'A') AND (ie_devolucao_w = 'N') AND
					(qt_item_nf_aConsistir_w > (qt_valor_max_ordem_w)) THEN
					ds_erro_w := SUBSTR(ds_erro_w || nr_item_nf_p || '-' || 'S -' || WHEB_MENSAGEM_PCK.get_texto(278703) || CHR(13) || CHR(10),1,4000);

					CALL gravar_nota_fiscal_consist(
						nr_sequencia_p,
						WHEB_MENSAGEM_PCK.get_texto(278209) || nr_item_nf_p || WHEB_MENSAGEM_PCK.get_texto(278704),
						'S','I',
						WHEB_MENSAGEM_PCK.get_texto(278705),
						nm_usuario_p,'S',nr_item_nf_p);

				ELSIF (ie_regra_dif_quant_w = 'B') AND (ie_devolucao_w = 'N') AND
					(qt_item_nf_aConsistir_w < (qt_valor_min_ordem_w)) THEN
					ds_erro_w := SUBSTR(ds_erro_w || nr_item_nf_p || '-' || 'S -' || WHEB_MENSAGEM_PCK.get_texto(278707) || CHR(13) || CHR(10),1,4000);

					CALL gravar_nota_fiscal_consist(
						nr_sequencia_p,
						WHEB_MENSAGEM_PCK.get_texto(278209) || nr_item_nf_p || WHEB_MENSAGEM_PCK.get_texto(278709),
						'S','I',
						WHEB_MENSAGEM_PCK.get_texto(278710),
						nm_usuario_p,'S',nr_item_nf_p);

				ELSIF (ie_regra_dif_quant_w = 'M') AND (ie_devolucao_w = 'N') AND
					((qt_item_nf_aConsistir_w > (qt_valor_max_ordem_w)) OR (qt_item_nf_aConsistir_w < (qt_valor_min_ordem_w))) THEN
					ds_erro_w := SUBSTR(ds_erro_w || nr_item_nf_p || '-' || 'S -' || WHEB_MENSAGEM_PCK.get_texto(278711) || CHR(13) || CHR(10),1,4000);

					CALL gravar_nota_fiscal_consist(
						nr_sequencia_p,
						WHEB_MENSAGEM_PCK.get_texto(278209) || nr_item_nf_p || WHEB_MENSAGEM_PCK.get_texto(278712),
						'S','I',
						WHEB_MENSAGEM_PCK.get_texto(278713),
						nm_usuario_p,'S',nr_item_nf_p);
				END IF;
				END;
			END IF;


			IF (pr_dif_quant_nota_ordem_w = 0) AND (ie_devolucao_w = 'N') THEN
				BEGIN

				qt_saldo_ordem_w	:= (qt_prevista_entrega_w - qt_entrega_real_ordem_w);

				IF (qt_saldo_ordem_w <> qt_total_item_nf_w) AND (ie_ent_sai_op_estoque_w = 'E') THEN
					ds_erro_w := SUBSTR(ds_erro_w || nr_item_nf_p || '-' || 'N -' || WHEB_MENSAGEM_PCK.get_texto(278714) || CHR(13) || CHR(10),1,4000);

					CALL gravar_nota_fiscal_consist(
							nr_sequencia_p,
							WHEB_MENSAGEM_PCK.get_texto(278209) || nr_item_nf_p || WHEB_MENSAGEM_PCK.get_texto(278715),
							'N','I',
							WHEB_MENSAGEM_PCK.get_texto(278716),
							nm_usuario_p,'S',nr_item_nf_p);
				END IF;
				END;
			END IF;

			/*Consiste o saldo pendente de entrega na data prevista*/

			IF (ie_consiste_qt_item_saldo_oc_w = 'S') THEN

				IF (ie_devolucao_w = 'S') THEN
					BEGIN

					SELECT	SUM(coalesce(qt_real_entrega,0))
					INTO STRICT	qt_saldo_ordem_ww
					FROM	ordem_compra_item_entrega
					WHERE	nr_ordem_compra = nr_ordem_compra_w
					AND	nr_item_oci     = nr_item_oci_w
					AND	((coalesce(dt_prevista_entrega_w::text, '') = '') OR (dt_prevista_entrega_w IS NOT NULL AND dt_prevista_entrega_w::text <> '') AND (dt_prevista_entrega = dt_prevista_entrega_w));


					/*Tive que incluir o IF abaixo porque alguns clientes estornam a OC ao gerar a devolucao
					e outros estornam ao calcular a devolucao*/
					IF (qt_saldo_ordem_ww = 0) THEN
						BEGIN

						SELECT	SUM(coalesce(qt_prevista_entrega - coalesce(qt_real_entrega,0),0))
						INTO STRICT	qt_saldo_ordem_ww
						FROM	ordem_compra_item_entrega
						WHERE	nr_ordem_compra = nr_ordem_compra_w
						AND	nr_item_oci     = nr_item_oci_w
						AND	((coalesce(dt_prevista_entrega_w::text, '') = '') OR (dt_prevista_entrega_w IS NOT NULL AND dt_prevista_entrega_w::text <> '') AND (dt_prevista_entrega = dt_prevista_entrega_w));

						END;
					END IF;

					END;
				ELSE
					BEGIN

					SELECT	SUM(coalesce(qt_prevista_entrega - coalesce(qt_real_entrega,0),0))
					INTO STRICT	qt_saldo_ordem_ww
					FROM	ordem_compra_item_entrega
					WHERE	nr_ordem_compra = nr_ordem_compra_w
					AND	nr_item_oci     = nr_item_oci_w
					AND	((coalesce(dt_prevista_entrega_w::text, '') = '') OR (dt_prevista_entrega_w IS NOT NULL AND dt_prevista_entrega_w::text <> '') AND (dt_prevista_entrega = dt_prevista_entrega_w));

					END;
				END IF;



				IF (qt_saldo_ordem_ww < qt_item_nf_w) THEN
					ds_erro_w := SUBSTR(ds_erro_w || nr_item_nf_p || '-' || 'S -' || WHEB_MENSAGEM_PCK.get_texto(278718) || CHR(13) || CHR(10),1,4000);

					CALL gravar_nota_fiscal_consist(
						nr_sequencia_p,
						WHEB_MENSAGEM_PCK.get_texto(278209) || nr_item_nf_p || WHEB_MENSAGEM_PCK.get_texto(278719),
						'S','I',
						WHEB_MENSAGEM_PCK.get_texto(278720),
						nm_usuario_p,'S',nr_item_nf_p);

				END IF;
			/*Consiste o saldo total do item da ordem de compra*/

			ELSIF (ie_consiste_qt_item_saldo_oc_w = 'T') THEN

				IF (ie_devolucao_w = 'S') THEN
					BEGIN

					SELECT	SUM(coalesce(qt_real_entrega,0))
					INTO STRICT	qt_saldo_ordem_ww
					FROM	ordem_compra_item a,
						ordem_compra_item_entrega b
					WHERE	a.nr_ordem_compra = b.nr_ordem_compra
					AND	a.nr_item_oci     = b.nr_item_oci
					AND	a.nr_ordem_compra = nr_ordem_compra_w
					AND	a.cd_material	  = cd_material_w;

					/*Tive que incluir o IF abaixo porque alguns clientes estornam a OC ao gerar a devolucao
					e outros estornam ao calcular a devolucao*/
					IF (qt_saldo_ordem_ww = 0) THEN
						BEGIN

						SELECT	SUM(coalesce(qt_prevista_entrega - coalesce(qt_real_entrega,0),0))
						INTO STRICT	qt_saldo_ordem_ww
					FROM	ordem_compra_item a,
						ordem_compra_item_entrega b
					WHERE	a.nr_ordem_compra = b.nr_ordem_compra
					AND	a.nr_item_oci     = b.nr_item_oci
					AND	a.nr_ordem_compra = nr_ordem_compra_w
					AND	a.cd_material	  = cd_material_w;

						END;
					END IF;

					END;
				ELSE
					BEGIN

					SELECT	SUM(coalesce(qt_prevista_entrega - coalesce(qt_real_entrega,0),0))
					INTO STRICT	qt_saldo_ordem_ww
					FROM	ordem_compra_item a,
						ordem_compra_item_entrega b
					WHERE	a.nr_ordem_compra = b.nr_ordem_compra
					AND	a.nr_item_oci     = b.nr_item_oci
					AND	a.nr_ordem_compra = nr_ordem_compra_w
					AND	a.cd_material	  = cd_material_w;

					END;
				END IF;

				IF (qt_saldo_ordem_ww < qt_item_nf_total_w) THEN
					ds_erro_w := SUBSTR(ds_erro_w || nr_item_nf_p || '-' || 'S -' || WHEB_MENSAGEM_PCK.get_texto(278718) || CHR(13) || CHR(10),1,4000);

					CALL gravar_nota_fiscal_consist(
						nr_sequencia_p,
						WHEB_MENSAGEM_PCK.get_texto(278209) || nr_item_nf_p || WHEB_MENSAGEM_PCK.get_texto(278719),
						'S','I',
						WHEB_MENSAGEM_PCK.get_texto(278720),
						nm_usuario_p,'S',nr_item_nf_p);
				END IF;
			END IF;

			/*Consiste a antecipacao de entrega*/

			IF (qt_dias_entrega_antecipada_w > 0) THEN
				BEGIN
				SELECT	coalesce(MIN(dt_prevista_entrega), clock_timestamp())
				INTO STRICT	dt_prevista_oci_w
				FROM	ordem_compra_item_entrega
				WHERE	nr_ordem_compra = nr_ordem_compra_w
				AND	nr_item_oci     = nr_item_oci_w
				AND	(dt_prevista_entrega IS NOT NULL AND dt_prevista_entrega::text <> '')
				AND	coalesce(dt_cancelamento::text, '') = ''
				AND	coalesce(dt_real_entrega::text, '') = '';
				IF	((TRUNC(dt_prevista_oci_w,'dd') - TRUNC(clock_timestamp(), 'dd')) > qt_dias_entrega_antecipada_w) THEN
					ds_erro_w := SUBSTR(ds_erro_w || nr_item_nf_p || '-' || 'S -' || WHEB_MENSAGEM_PCK.get_texto(278721) || CHR(13) || CHR(10),1,4000);

					CALL gravar_nota_fiscal_consist(
						nr_sequencia_p,
						WHEB_MENSAGEM_PCK.get_texto(278209) || nr_item_nf_p || WHEB_MENSAGEM_PCK.get_texto(278722),
						'S','I',
						WHEB_MENSAGEM_PCK.get_texto(278723),
						nm_usuario_p,'S',nr_item_nf_p);
				END IF;
				END;
			END IF;
		END IF;

		IF (coalesce(cd_cond_pagto_nf_w,0) <> coalesce(cd_cond_pagto_oc_w,0)) THEN
			ds_erro_w := SUBSTR(ds_erro_w || nr_item_nf_p || '-' || 'N -' || WHEB_MENSAGEM_PCK.get_texto(278724) ||	CHR(13) || CHR(10),1,4000);

			CALL gravar_nota_fiscal_consist(
				nr_sequencia_p,
				WHEB_MENSAGEM_PCK.get_texto(278209) || nr_item_nf_p || WHEB_MENSAGEM_PCK.get_texto(278725),
				'N','I',
				WHEB_MENSAGEM_PCK.get_texto(278726),
				nm_usuario_p,'S',nr_item_nf_p);
		END IF;
	END IF;

	IF (ie_avisa_emprestimo_aberto_w = 'S') THEN

		SELECT	COUNT(*)
		INTO STRICT	qt_existe_w
		FROM	emprestimo a,
			emprestimo_material b
		WHERE	a.nr_emprestimo = b.nr_emprestimo
		AND	b.cd_material = cd_material_w
		AND	a.cd_estabelecimento = cd_estabelecimento_w
		AND	coalesce(a.ie_situacao, 'A') = 'A'
		AND	TRUNC(a.dt_emprestimo,'mm') <= TRUNC(clock_timestamp(),'mm')
		AND	a.nr_emprestimo <> coalesce(nr_emprestimo_w,0)  LIMIT 1;

		IF (qt_existe_w > 0) THEN
			ds_erro_w := SUBSTR(ds_erro_w || nr_item_nf_p || '-' || 'N -' || WHEB_MENSAGEM_PCK.get_texto(278727) || CHR(13) || CHR(10),1,4000);

			CALL gravar_nota_fiscal_consist(
				nr_sequencia_p,
				WHEB_MENSAGEM_PCK.get_texto(278209) || nr_item_nf_p || WHEB_MENSAGEM_PCK.get_texto(278728),
				'N','I',
				WHEB_MENSAGEM_PCK.get_texto(278729),
				nm_usuario_p,'S',nr_item_nf_p);
		ELSE
			SELECT	COUNT(*)
			INTO STRICT	qt_existe_w
			FROM	emprestimo a,
				emprestimo_material b
			WHERE	a.nr_emprestimo = b.nr_emprestimo
			AND	b.cd_material = cd_material_w
			AND	a.cd_estabelecimento = cd_estabelecimento_w
			AND	coalesce(a.ie_situacao, 'A') = 'A'
			AND	a.nr_emprestimo <> coalesce(nr_emprestimo_w,0)  LIMIT 1;

			IF (qt_existe_w > 0) THEN
				ds_erro_w := SUBSTR(ds_erro_w || nr_item_nf_p || '-' || 'N -' || WHEB_MENSAGEM_PCK.get_texto(278727) || CHR(13) || CHR(10),1,4000);

				CALL gravar_nota_fiscal_consist(
					nr_sequencia_p,
					WHEB_MENSAGEM_PCK.get_texto(278209) || nr_item_nf_p || WHEB_MENSAGEM_PCK.get_texto(278728),
					'N','I',
					WHEB_MENSAGEM_PCK.get_texto(278727),
					nm_usuario_p,'S',nr_item_nf_p);
			END IF;
		END IF;

	ELSIF (ie_avisa_emprestimo_aberto_w = 'C') THEN

		SELECT	COUNT(*)
		INTO STRICT	qt_existe_w
		FROM	emprestimo a,
			emprestimo_material b
		WHERE	a.nr_emprestimo = b.nr_emprestimo
		AND	a.cd_estabelecimento = cd_estabelecimento_w
		AND	coalesce(a.ie_situacao, 'A') = 'A'
		AND	TRUNC(a.dt_emprestimo,'mm') <= TRUNC(clock_timestamp(),'mm')
		AND	a.nr_emprestimo <> coalesce(nr_emprestimo_w,0)
		AND	EXISTS (SELECT	1
				FROM	material x
				WHERE	x.cd_material = b.cd_material
				AND	x.cd_material_estoque = cd_material_estoque_w)  LIMIT 1;

		IF (qt_existe_w > 0) THEN
			ds_erro_w := SUBSTR(ds_erro_w || nr_item_nf_p || '-' || 'N -' || WHEB_MENSAGEM_PCK.get_texto(278727) || CHR(13) || CHR(10),1,4000);

			CALL gravar_nota_fiscal_consist(
				nr_sequencia_p,
				WHEB_MENSAGEM_PCK.get_texto(278209) || nr_item_nf_p || WHEB_MENSAGEM_PCK.get_texto(278728),
				'N','I',
				WHEB_MENSAGEM_PCK.get_texto(278729),
				nm_usuario_p,'S',nr_item_nf_p);
		ELSE
			SELECT	COUNT(*)
			INTO STRICT	qt_existe_w
			FROM	emprestimo a,
				emprestimo_material b
			WHERE	a.nr_emprestimo = b.nr_emprestimo
			AND	a.cd_estabelecimento = cd_estabelecimento_w
			AND	a.nr_emprestimo <> coalesce(nr_emprestimo_w,0)
			AND	coalesce(a.ie_situacao, 'A') = 'A'
			AND	EXISTS (SELECT	1
					FROM	material x
					WHERE	x.cd_material = b.cd_material
					AND	x.cd_material_estoque = cd_material_estoque_w)  LIMIT 1;

			IF (qt_existe_w > 0) THEN
				ds_erro_w := SUBSTR(ds_erro_w || nr_item_nf_p || '-' || 'N -' || WHEB_MENSAGEM_PCK.get_texto(278727) || CHR(13) || CHR(10),1,4000);

				CALL gravar_nota_fiscal_consist(
					nr_sequencia_p,
					WHEB_MENSAGEM_PCK.get_texto(278209) || nr_item_nf_p || WHEB_MENSAGEM_PCK.get_texto(278728),
					'N','I',
					WHEB_MENSAGEM_PCK.get_texto(278727),
					nm_usuario_p,'S',nr_item_nf_p);
			END IF;
		END IF;
	END IF;

	SELECT	SUBSTR(obter_se_mat_lib_operacao_nf(cd_operacao_nota_w,cd_material_w),1,1)
	INTO STRICT	ie_estrutura_lib_w
	;

	IF (ie_estrutura_lib_w = 'N') THEN
		ds_erro_w := SUBSTR(ds_erro_w || nr_item_nf_p || '-' || 'S -' || WHEB_MENSAGEM_PCK.get_texto(278730) || CHR(13) || CHR(10),1,4000);

		CALL gravar_nota_fiscal_consist(
			nr_sequencia_p,
			WHEB_MENSAGEM_PCK.get_texto(278209) || nr_item_nf_p || WHEB_MENSAGEM_PCK.get_texto(278732),
			'S','I',
			WHEB_MENSAGEM_PCK.get_texto(278730),
			nm_usuario_p,'S',nr_item_nf_p);
	END IF;

	/* Verifica a regra na funcao Pessoa Juridica - Pasta Regra liberacao por estrutura */

	SELECT	SUBSTR(obter_se_mat_lib_fornec(cd_cgc_emitente_w, cd_material_w, cd_estabelecimento_w, 'NF'),1,1) ie_qualificado
	INTO STRICT	ie_qualificado_w
	;

	IF (ie_tipo_nota_w IN ('EN','EP')) AND (coalesce(dt_lib_estrut_pj_w::text, '') = '') AND (ie_qualificado_w IN ('N', 'L', 'V')) THEN
		BEGIN
		IF (ie_qualificado_w = 'N') THEN
			ds_erro_w := SUBSTR(ds_erro_w || nr_item_nf_p || '-' || 'S -' || WHEB_MENSAGEM_PCK.get_texto(278734) || CHR(13) || CHR(10),1,4000);

			CALL gravar_nota_fiscal_consist(
				nr_sequencia_p,
				WHEB_MENSAGEM_PCK.get_texto(278209) || nr_item_nf_p || WHEB_MENSAGEM_PCK.get_texto(278735),
				'S','I',
				WHEB_MENSAGEM_PCK.get_texto(278736),
				nm_usuario_p,'S',nr_item_nf_p);

		END IF;
		IF (ie_qualificado_w = 'L') THEN
			ds_erro_w := SUBSTR(ds_erro_w || nr_item_nf_p || '-' || 'S -' || WHEB_MENSAGEM_PCK.get_texto(278737) || CHR(13) || CHR(10),1,4000);

			CALL gravar_nota_fiscal_consist(
				nr_sequencia_p,
				WHEB_MENSAGEM_PCK.get_texto(278209) || nr_item_nf_p || WHEB_MENSAGEM_PCK.get_texto(278735),
				'S','I',
				WHEB_MENSAGEM_PCK.get_texto(278740),
				nm_usuario_p,'S',nr_item_nf_p);

		END IF;
		IF (ie_qualificado_w = 'V') THEN
			ds_erro_w := SUBSTR(ds_erro_w || nr_item_nf_p || '-' || 'S -' || WHEB_MENSAGEM_PCK.get_texto(278741)|| CHR(13) || CHR(10),1,4000);

			CALL gravar_nota_fiscal_consist(
				nr_sequencia_p,
				WHEB_MENSAGEM_PCK.get_texto(278209) || nr_item_nf_p || WHEB_MENSAGEM_PCK.get_texto(278743),
				'S','I',
				WHEB_MENSAGEM_PCK.get_texto(278744),
				nm_usuario_p,'S',nr_item_nf_p);
		END IF;
		END;
	END IF;

	SELECT	coalesce(SUM(qt_material),0)
	INTO STRICT	qt_item_lote_w
	FROM	nota_fiscal_item_lote
	WHERE	nr_seq_nota = nr_sequencia_p
	AND	nr_item_nf = nr_item_nf_p;

	IF (qt_item_lote_w > 0) THEN
		BEGIN

		SELECT	coalesce(qt_item_estoque,0)
		INTO STRICT	qt_item_estoque_w
		FROM	nota_fiscal_item
		WHERE	nr_sequencia = nr_sequencia_p
		AND	nr_item_nf = nr_item_nf_p;

		IF (qt_item_estoque_w > 0) AND (qt_item_lote_w > qt_item_estoque_w) THEN
			BEGIN

			CALL gravar_nota_fiscal_consist(
				nr_sequencia_p,
				WHEB_MENSAGEM_PCK.get_texto(278209) || nr_item_nf_p || WHEB_MENSAGEM_PCK.get_texto(278745),
				'S','I',
				WHEB_MENSAGEM_PCK.get_texto(278746),
				nm_usuario_p,'S',nr_item_nf_p);

			END;
		END IF;

		END;
	END IF;

	SELECT	COUNT(*)
	INTO STRICT	qt_existe_item_lote_w
	FROM	nota_fiscal_item_lote
	WHERE	nr_seq_nota = nr_sequencia_p
	AND	nr_item_nf = nr_item_nf_p;

	SELECT	coalesce(SUM(qt_material),0)
	INTO STRICT	qt_item_lote_w
	FROM	nota_fiscal_item_lote
	WHERE	nr_seq_nota = nr_sequencia_p
	AND	nr_item_nf = nr_item_nf_p;

	SELECT	coalesce(qt_item_estoque,0)
	INTO STRICT	qt_item_estoque_w
	FROM	nota_fiscal_item
	WHERE	nr_sequencia = nr_sequencia_p
	AND	nr_item_nf = nr_item_nf_p;

	IF (qt_item_estoque_w <> qt_item_lote_w) AND (qt_existe_item_lote_w > 0) THEN
		CALL gravar_nota_fiscal_consist(
				nr_sequencia_p,
				WHEB_MENSAGEM_PCK.get_texto(278209) || nr_item_nf_p || WHEB_MENSAGEM_PCK.get_texto(278748),
				'S','I',
				WHEB_MENSAGEM_PCK.get_texto(278749),
				nm_usuario_p,'S',nr_item_nf_p);
	END IF;

	SELECT	COUNT(*)
	INTO STRICT	qt_lote_gerado_w
	FROM	material_lote_fornec
	WHERE	nr_sequencia_nf	= nr_sequencia_p
	AND	nr_item_nf	= nr_item_nf_p;
	
	if (qt_lote_gerado_w = 0) THEN
		select	count(1)
		into STRICT	qt_lote_gerado_w
		from	material_lote_fornec_nf
		where	nr_sequencia_nf	= nr_sequencia_p
		and	nr_item_nf	= nr_item_nf_p;
	end if;

	/* Consiste Validade Indeterminada  */

	SELECT	coalesce(obter_se_consis_val_indeterm('NF',cd_material_w),'S')
	INTO STRICT	ie_permite_indeterm_w
	;

	if (coalesce(ie_permite_indeterm_w,'S') = 'N') and (coalesce(ie_indeterminado_w,'N') = 'S') then
		begin
		CALL gravar_nota_fiscal_consist(
					nr_sequencia_p,
					WHEB_MENSAGEM_PCK.get_texto(278209) || nr_item_nf_p || WHEB_MENSAGEM_PCK.get_texto(288382),
					'S','I',
					WHEB_MENSAGEM_PCK.get_texto(288383),
					nm_usuario_p,'S',nr_item_nf_p);
		end;
	end if;

	open C01;
	loop
	fetch C01 into
		cd_lote_fabricacao_ww,
		ie_indeterminado_lote_w,
		dt_validade_lote_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin
		ie_indeterminado_lote_w	:= ie_indeterminado_lote_w;

		if (ie_tipo_nota_w IN ('EN','EF','EP')) and (coalesce(cd_lote_fabricacao_ww,'X') <> 'X') then
			begin
			if (substr(obter_se_lote_forn_restricao(cd_material_w, cd_lote_fabricacao_ww),1,1) = 'S') then
				begin
				begin
				select	DS_ACAO
				into STRICT	DS_ACAO_lote_w
				from	lote_fornec_restricao
				where	cd_material = cd_material_w
				and	upper(ds_lote_fornec) = upper(cd_lote_fabricacao_ww)
				and	ie_bloquear_lote_nf = 'S'
				and	ie_situacao = 'A'  LIMIT 1;
				exception
				when others then
					DS_ACAO_lote_w	:=	null;
				end;

				CALL gravar_nota_fiscal_consist(
					nr_sequencia_p,
					/*O lote fornecedor #@DS_LOTE_FORNEC#@ do item #@NR_ITEM_NF#@ esta bloqueado para entrada!*/

					substr(WHEB_MENSAGEM_PCK.get_texto(
						289182, 'DS_LOTE_FORNEC='||cd_lote_fabricacao_ww||';'||
							'NR_ITEM_NF='||nr_item_nf_p || ';' ||
							'DS_ACAO='||DS_ACAO_lote_w),1,255),
					'S','I',
					/*Verifique o cadastro de Restricao de lote fornecedor!*/

					WHEB_MENSAGEM_PCK.get_texto(289181),
					nm_usuario_p,'S',nr_item_nf_p);
				end;
			end if;
			end;
		end if;

		if (dt_validade_lote_w IS NOT NULL AND dt_validade_lote_w::text <> '') then
			if (dt_validade_lote_w < pkg_date_utils.start_of(clock_timestamp(), 'DD')) and (ie_consiste_dt_validade_w = 'N') then
				ds_observacao_lote_w := wheb_mensagem_pck.get_texto(278209) || nr_item_nf_p || chr(10) || chr(13) ||
							wheb_mensagem_pck.get_texto(310788) || cd_lote_fabricacao_ww || chr(10) || chr(13) ||
							Wheb_mensagem_pck.get_Texto(150608);
				CALL gravar_nota_fiscal_consist(nr_sequencia_p,
								wheb_mensagem_pck.get_texto(278209) || nr_item_nf_p || ' - ' || wheb_mensagem_pck.get_Texto(150608), /*Sem permissao para informar data de validade anterior a data atual. Verifique Parametro[38].*/
								'S','I',
								ds_observacao_lote_w, /*Sem permissao para informar data de validade anterior a data atual. Verifique Parametro[38].*/
								nm_usuario_p,'S',nr_item_nf_p);
			end if;

			select	count(*)
			into STRICT	qt_existe_w
			from	regra_val_minima_lote
			where	ie_situacao = 'A'
			and	cd_estabelecimento = cd_estabelecimento_w
			and	coalesce(ie_nota_fiscal,'N') = 'S'  LIMIT 1;

			if (qt_existe_w > 0) then

				select	obter_regra_valid_min_opcao(cd_material_w, cd_estabelecimento_w, nm_usuario_p, 'N')
				into STRICT	qt_dias_minimo_validade_w
				;

				select	obter_dias_entre_datas(trunc(clock_timestamp(),'dd'), trunc(dt_validade_lote_w,'dd'))
				into STRICT	qt_dias_validade_w
				;

				if (qt_dias_minimo_validade_w >= 0) and (qt_dias_validade_w < qt_dias_minimo_validade_w) then
					CALL gravar_nota_fiscal_consist(
								nr_sequencia_p,
								Wheb_mensagem_pck.get_Texto(306530, 'NR_ITEM_NF_P='|| NR_ITEM_NF_P), /*A validade do item #@NR_ITEM_NF_P#@ e superior ao permitido pela regra*/
								'S','I',
								WHEB_MENSAGEM_PCK.get_texto(306531), /*A data de validade do produto nao pode ser maior que a quantidade de dias permitidos na Regra de validade minima lote que tem nos Cadastros gerais.*/
								nm_usuario_p,'S',nr_item_nf_p);

				end if;

			end if;
		end if;
		end;
	end loop;
	close C01;

	if (coalesce(ie_permite_indeterm_w,'S') = 'N') and (coalesce(ie_indeterminado_lote_w,'N') = 'S') then
		begin
		CALL gravar_nota_fiscal_consist(
					nr_sequencia_p,
					WHEB_MENSAGEM_PCK.get_texto(278209) || nr_item_nf_p || WHEB_MENSAGEM_PCK.get_texto(288434),
					'S','I',
					WHEB_MENSAGEM_PCK.get_texto(288435),
					nm_usuario_p,'S',nr_item_nf_p);
		end;
	end if;

	if (dt_validade_w IS NOT NULL AND dt_validade_w::text <> '') then
		if (dt_validade_w < pkg_date_utils.start_of(clock_timestamp(), 'DD')) and (ie_consiste_dt_validade_w = 'N') then
				ds_observacao_lote_w := wheb_mensagem_pck.get_texto(278209) || nr_item_nf_p || chr(10) || chr(13) ||
							wheb_mensagem_pck.get_texto(310788) || cd_lote_fabricacao_w || chr(10) || chr(13) ||
							Wheb_mensagem_pck.get_Texto(150608);
				CALL gravar_nota_fiscal_consist(nr_sequencia_p,
								wheb_mensagem_pck.get_texto(278209) || nr_item_nf_p || ' - ' || Wheb_mensagem_pck.get_Texto(150608), /*Sem permissao para informar data de validade anterior a data atual. Verifique Parametro[38].*/
								'S','I',
								ds_observacao_lote_w, /*Sem permissao para informar data de validade anterior a data atual. Verifique Parametro[38].*/
								nm_usuario_p,'S',nr_item_nf_p);
		end if;

		select	count(*)
		into STRICT	qt_existe_w
		from	regra_val_minima_lote
		where	ie_situacao = 'A'
		and	cd_estabelecimento = cd_estabelecimento_w
		and	coalesce(ie_nota_fiscal,'N') = 'S'  LIMIT 1;

		if (qt_existe_w > 0) then

			select	obter_regra_valid_min_opcao(cd_material_w, cd_estabelecimento_w, nm_usuario_p, 'N')
			into STRICT	qt_dias_minimo_validade_w
			;

			select	obter_dias_entre_datas(trunc(clock_timestamp(),'dd'), trunc(dt_validade_w,'dd'))
			into STRICT	qt_dias_validade_w
			;

			if (qt_dias_minimo_validade_w >= 0) and (qt_dias_validade_w < qt_dias_minimo_validade_w) then
				CALL gravar_nota_fiscal_consist(
							nr_sequencia_p,
							Wheb_mensagem_pck.get_Texto(306530, 'NR_ITEM_NF_P='|| NR_ITEM_NF_P), /*A validade do item #@NR_ITEM_NF_P#@ e superior ao permitido pela regra*/
							'S','I',
							WHEB_MENSAGEM_PCK.get_texto(306531), /*A data de validade do produto nao pode ser maior que a quantidade de dias permitidos na Regra de validade minima lote que tem nos Cadastros gerais.*/
							nm_usuario_p,'S',nr_item_nf_p);

			end if;

		end if;
	end if;

	IF (qt_lote_gerado_w = 0) THEN
		IF (ie_gera_lote_fornec_w = 'S') THEN
			SELECT	coalesce(MAX(ie_regra_lote_nf),'N')
			INTO STRICT	ie_regra_lote_nf_w
			FROM	operacao_nota
			WHERE	cd_operacao_nf = cd_operacao_nota_w;

			IF (ie_regra_lote_nf_w = 'N') THEN
				SELECT * FROM Obter_Regra_nf_lote_fornec(	cd_material_w, cd_estabelecimento_w, ie_gera_w, ie_quantidade_w, ie_gerar_desdobrado_w, ie_agrupar_lote_w, nr_seq_marca_w) INTO STRICT ie_gera_w, ie_quantidade_w, ie_gerar_desdobrado_w, ie_agrupar_lote_w;

				IF (ie_gera_w = 'O') AND (qt_existe_item_lote_w = 0) AND
					((coalesce(cd_lote_fabricacao_w::text, '') = '') OR ((coalesce(dt_validade_w::text, '') = '') AND (ie_indeterminado_w = 'N'))) THEN
					CALL gravar_nota_fiscal_consist(
							nr_sequencia_p,
							WHEB_MENSAGEM_PCK.get_texto(278209) || nr_item_nf_p || WHEB_MENSAGEM_PCK.get_texto(278750),
							'S','I',
							WHEB_MENSAGEM_PCK.get_texto(278751),
							nm_usuario_p,'S',nr_item_nf_p);
				END IF;
			END IF;
		END IF;
	END IF;

	if (ie_tipo_nota_w IN ('EN','EF','EP')) and (coalesce(cd_lote_fabricacao_w,'X') <> 'X') then
		begin
		if (substr(obter_se_lote_forn_restricao(cd_material_w, cd_lote_fabricacao_w),1,1) = 'S') then
			begin

			begin
			select	DS_ACAO
			into STRICT	DS_ACAO_lote_w
			from	lote_fornec_restricao
			where	cd_material = cd_material_w
			and	upper(ds_lote_fornec) = upper(cd_lote_fabricacao_w)
			and	ie_bloquear_lote_nf = 'S'
			and	ie_situacao = 'A'  LIMIT 1;
			exception
			when others then
				DS_ACAO_lote_w	:=	null;
			end;

			CALL gravar_nota_fiscal_consist(
				nr_sequencia_p,
				/*O lote fornecedor #@DS_LOTE_FORNEC#@ do item #@NR_ITEM_NF#@ esta bloqueado para entrada!*/

				substr(WHEB_MENSAGEM_PCK.get_texto(
					289182, 'DS_LOTE_FORNEC='||cd_lote_fabricacao_w||';'||
						'NR_ITEM_NF='||nr_item_nf_p || ';' ||
						'DS_ACAO='||DS_ACAO_lote_w),1,255),
				'S','I',
				/*Verifique o cadastro de Restricao de lote fornecedor!*/

				WHEB_MENSAGEM_PCK.get_texto(289181),
				nm_usuario_p,'S',nr_item_nf_p);
			end;
		end if;
		end;
	end if;

	if (nr_ordem_compra_w IS NOT NULL AND nr_ordem_compra_w::text <> '') and (cd_cgc_emitente_w IS NOT NULL AND cd_cgc_emitente_w::text <> '') then
		begin

		select	cd_cgc_fornecedor
		into STRICT	cd_cgc_fornecedor_oc_w
		from	ordem_compra
		where	nr_ordem_compra = nr_ordem_compra_w;

		if (ie_consiste_fornec_w = 'N') and (ie_tipo_nota_w IN ('EN','EF','EP')) and (cd_cgc_emitente_w <> cd_cgc_fornecedor_oc_w) and (obter_se_pj_matriz_filial(cd_cgc_emitente_w,cd_cgc_fornecedor_oc_w) = 'N') then
			CALL gravar_nota_fiscal_consist(
				nr_sequencia_p,
				/*O item #@NR_ITEM_NF#@ pertence a uma ordem de compra de fornecedor diferente da nota fiscal.*/

				WHEB_MENSAGEM_PCK.get_texto(
					290852,'NR_ITEM_NF='||nr_item_nf_p),
				'S','I',
				/*Verifique os itens informados na nota fiscal!*/

				WHEB_MENSAGEM_PCK.get_texto(290855),
				nm_usuario_p,'S',nr_item_nf_p);
		end if;
		end;
	end if;

	UPDATE	nota_fiscal_item
	SET	ds_inconsistencia 	= SUBSTR(ds_erro_w,1,255)
	WHERE	nr_sequencia	= nr_sequencia_p
	AND	nr_item_nf	= nr_item_nf_p;
	END;

ELSIF (cd_procedimento_w IS NOT NULL AND cd_procedimento_w::text <> '') THEN

	SELECT	max(a.cd_conta_contabil),
		max(a.qt_item_nf),
		max(a.vl_total_item_nf)
	INTO STRICT	cd_conta_contabil_nota_w,
		qt_item_nf_w,
		vl_total_item_nf_w
	FROM	nota_fiscal_item a,
		nota_fiscal b,
		procedimento c
	WHERE	a.nr_item_nf	= nr_item_nf_p
	AND	a.nr_sequencia	= nr_sequencia_p
	and	a.nr_sequencia = b.nr_sequencia

	and	c.cd_procedimento = a.cd_procedimento
	and     a.ie_origem_proced = c.ie_origem_proced;

	SELECT	COUNT(*),
		coalesce(SUM(vl_rateio),0),
		coalesce(SUM(qt_rateio),0)
	INTO STRICT	qt_item_rateio_w,
		vl_rateio_w,
		qt_rateio_w
	FROM	Nota_fiscal_item_rateio
	WHERE	nr_seq_nota	= nr_sequencia_p
	AND	nr_item_nf	= nr_item_nf_p;


	ie_obriga_conta_cont_proc_w	:= coalesce(obter_valor_param_usuario(40, 237, cd_perfil_w, nm_usuario_p, cd_estabelecimento_w), 'N');

	IF (coalesce(cd_conta_contabil_nota_w::text, '') = '') AND (ie_obriga_conta_cont_proc_w = 'S') THEN
		ds_erro_w := SUBSTR(ds_erro_w || nr_item_nf_p || '-' || ie_obriga_conta_cont_proc_w || ' -' ||
			WHEB_MENSAGEM_PCK.get_texto(278752) || CHR(13) || CHR(10),1,4000);

		CALL gravar_nota_fiscal_consist(
			nr_sequencia_p,
			WHEB_MENSAGEM_PCK.get_texto(278209) || nr_item_nf_p || WHEB_MENSAGEM_PCK.get_texto(278607),
			ie_obriga_conta_cont_proc_w,'I',
			WHEB_MENSAGEM_PCK.get_texto(278608),
			nm_usuario_p,'S',nr_item_nf_p);
	END IF;


	IF (qt_rateio_w > 0) AND (qt_item_rateio_w > 0) AND (qt_rateio_w <> qt_item_nf_w) THEN
		ds_erro_w := SUBSTR(ds_erro_w || nr_item_nf_p || '-' || 'S -' || WHEB_MENSAGEM_PCK.get_texto(278593) || CHR(13) || CHR(10),1,4000);

		CALL gravar_nota_fiscal_consist(
			nr_sequencia_p,
			WHEB_MENSAGEM_PCK.get_texto(278209) || nr_item_nf_p || WHEB_MENSAGEM_PCK.get_texto(278594),
			'S','I',
			WHEB_MENSAGEM_PCK.get_texto(278595),
			nm_usuario_p,'S',nr_item_nf_p);
	END IF;


	if 	((coalesce(ie_desp_aces_rateio_itens_w,'N') <> 'S') AND (vl_rateio_w > 0) AND
		(qt_item_rateio_w > 0 AND vl_rateio_w <> vl_total_item_nf_w)) THEN

		ds_erro_w := SUBSTR(ds_erro_w || nr_item_nf_p || '-' || 'S -' || WHEB_MENSAGEM_PCK.get_texto(278590) || CHR(13) || CHR(10),1,4000);

		CALL gravar_nota_fiscal_consist(
			nr_sequencia_p,
			WHEB_MENSAGEM_PCK.get_texto(278209) || nr_item_nf_p || WHEB_MENSAGEM_PCK.get_texto(278591),
			'S','I',
			WHEB_MENSAGEM_PCK.get_texto(278592),
			nm_usuario_p,'S',nr_item_nf_p);

	END IF;
END IF;

ds_erro_p := SUBSTR(ds_erro_w,1,255);

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE consistir_item_nota_fiscal ( nr_sequencia_p bigint, nr_item_nf_p bigint, nm_usuario_p text, ds_erro_p INOUT text, ie_acao_p text DEFAULT 'N') FROM PUBLIC;

