-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE inserir_familia_domicilio ( CD_PESSOA_FISICA_P text, CD_PESSOA_FAMILIA_P text, NR_SEQ_GRAU_PARENTESCO_P text, NM_USUARIO_P text) AS $body$
DECLARE


NM_USUARIO_ATIVO_W                 USUARIO.NM_USUARIO%TYPE;
VALIDAVINCULOPARENTEMORARIA_W      bigint;/* VALIDA SE A PESSOA SELECIONADA TEM RELACAO DE PARENTESCO COM A DA PATIENT BAR, NA TABELA PESSOA_DOMICILIO_MORADIA */
VALIDAVINCULOINVERSOMORARIA_W      bigint;/* VALIDO SE É NECESSÁRIO INSERIR O INVERSO.*/
VALIDA_EXISTE_W                    bigint;/*VALIDA SE A PESSOA SELECIONADA JÁ POSSUI UM DOMICILIO*/
CD_DOMCILIO_PF_W		   bigint;/* ARMAZENA O CÓDIGO DO DOMICILIO DA PESSOA SELECIONADA, CASO ELE EXISTA*/
VALIDA_SI_MESMO_W		   bigint;/*VALIDA SE É NECESSÁRIO INSERIR O PACIENTE SELECIONADO NO PRÓPRIO DOMICILIO */
VALIDA_RESIDENCIA_W                bigint;/* VALIDA SE É NECESSÁRIO INSERIR NA TABELA COMPL_PESSOA_FISICA */
NR_SEQUENCIA_COMPL_W               bigint;/*ARMAZENA A SEQUENCIA DA COMPL_PESSOA_FISICA CASO EXISTA UM REGISTRO CADASTRADO */
CD_DOMICILIO_W                     varchar(16);
DS_BAIRRO_W                        varchar(30);
DS_COMPLEMENTO_W                   varchar(15);
NR_SEQ_TIPO_LOGRADOURO_W           bigint;
DS_ENDERECO_W                      varchar(50);
NR_ENDERECO_W                      varchar(7);
CD_DOMICILIO_MUNICIPIO_W           varchar(48);
DS_REFERENCIA_W                    varchar(50);
DS_REF_RESIDENCIAL_W               varchar(50);
NR_DDI_RESIDENCIAL_W               varchar(3);
NR_TEL_RESIDENCIAL_W               varchar(20);
NR_DDI_RECADO_W                    varchar(3);
CD_PESSOA_FISICA_W                 varchar(10);
NR_TEL_RECADO_W                    varchar(20);
NR_DDI_CELULAR_W                   varchar(3);
NR_CELULAR_W                       varchar(20);
NR_SEQ_AREA_W                      bigint;
NR_SEQ_MICROAREA_W                 bigint;
IE_TRATAMENTO_AGUA_W               varchar(1);
IE_TIPO_AGUA_W                     varchar(1);
IE_ENERGIA_ELETRICA_W              varchar(1);
IE_TIPO_DOMICILIO_W                varchar(1);
IE_DESTINO_LIXO_W                  varchar(1);
IE_ESGOTO_SANITARIO_W              varchar(1);
QT_COMODO_W                        smallint;
IE_TIPO_DOENCA_W                   varchar(1);
IE_TIPO_TRANSPORTE_W               varchar(1);
IE_TIPO_COMUNICACAO_W              varchar(1);
CD_CEP_W                           varchar(15);
NM_PESSOA_RESPONSAVEL_W            varchar(255);
NR_SEQ_EQUIPE_W                    bigint;
IE_MUDOU_SE_W                      varchar(1);



C01 CURSOR FOR
	SELECT
	CD_DOMICILIO,
	DS_BAIRRO,
	DS_COMPLEMENTO,
	DS_ENDERECO,
	NR_ENDERECO,
	CD_DOMICILIO_MUNICIPIO,
	NR_TEL_RESIDENCIAL,
	CD_PESSOA_FISICA,
	CD_CEP,
	NM_PESSOA_RESPONSAVEL,
	IE_MUDOU_SE,
	DS_REFERENCIA,
	IE_TIPO_DOMICILIO,
	IE_TRATAMENTO_AGUA,
	IE_TIPO_AGUA,
	IE_DESTINO_LIXO,
	IE_ESGOTO_SANITARIO,
	IE_TIPO_COMUNICACAO,
	IE_TIPO_DOENCA,
	IE_TIPO_TRANSPORTE,
	IE_ENERGIA_ELETRICA,
	DS_REF_RESIDENCIAL,
	NR_DDI_RESIDENCIAL,
	NR_SEQ_AREA,
	NR_SEQ_EQUIPE,
	NR_SEQ_MICROAREA,
	QT_COMODO,
	NR_SEQ_TIPO_LOGRADOURO
	FROM DOMICILIO_FAMILIA
	WHERE IE_MUDOU_SE = 'N'
	AND CD_PESSOA_FISICA = CD_PESSOA_FISICA_P;

  REG1 RECORD;
  REG2 RECORD;

BEGIN

OPEN C01;
FETCH C01 INTO
	CD_DOMICILIO_W,
	DS_BAIRRO_W,
	DS_COMPLEMENTO_W,
	DS_ENDERECO_W,
	NR_ENDERECO_W,
	CD_DOMICILIO_MUNICIPIO_W,
	NR_TEL_RESIDENCIAL_W,
	CD_PESSOA_FISICA_W,
	CD_CEP_W,
	NM_PESSOA_RESPONSAVEL_W,
	IE_MUDOU_SE_W,
	DS_REFERENCIA_W,
	IE_TIPO_DOMICILIO_W,
	IE_TRATAMENTO_AGUA_W,
	IE_TIPO_AGUA_W,
	IE_DESTINO_LIXO_W,
	IE_ESGOTO_SANITARIO_W,
	IE_TIPO_COMUNICACAO_W,
	IE_TIPO_DOENCA_W,
	IE_TIPO_TRANSPORTE_W,
	IE_ENERGIA_ELETRICA_W,
	DS_REF_RESIDENCIAL_W,
	NR_DDI_RESIDENCIAL_W,
	NR_SEQ_AREA_W,
	NR_SEQ_EQUIPE_W,
	NR_SEQ_MICROAREA_W,
	QT_COMODO_W,
	NR_SEQ_TIPO_LOGRADOURO_W;
CLOSE C01;

VALIDA_EXISTE_W := 0;
CD_DOMCILIO_PF_W := 0;
VALIDA_RESIDENCIA_W := 0;
VALIDAVINCULOPARENTEMORARIA_W := 0;
VALIDAVINCULOINVERSOMORARIA_W := 0;


SELECT COUNT(CD_DOMICILIO)
	INTO STRICT VALIDA_EXISTE_W
	FROM DOMICILIO_FAMILIA
	WHERE CD_PESSOA_FISICA = CD_PESSOA_FAMILIA_P
	AND IE_MUDOU_SE = 'N';

SELECT COUNT(NR_SEQUENCIA)
	INTO STRICT VALIDAVINCULOPARENTEMORARIA_W
	FROM PESSOA_DOMICILIO_MORADIA
	WHERE CD_PESSOA_FAMILIA = CD_PESSOA_FAMILIA_P
	AND CD_PESSOA_FISICA = CD_PESSOA_FISICA_P
	AND (IE_MUDOU_SE = 'N' OR coalesce(IE_MUDOU_SE::text, '') = '');

IF (VALIDA_EXISTE_W > 0) THEN
	SELECT MAX(CD_DOMICILIO)
	INTO STRICT CD_DOMCILIO_PF_W
	FROM DOMICILIO_FAMILIA
	WHERE CD_PESSOA_FISICA = CD_PESSOA_FAMILIA_P
	AND IE_MUDOU_SE = 'N';
END IF;


IF (CD_DOMCILIO_PF_W > 0 AND CD_DOMCILIO_PF_W <> CD_DOMICILIO_W) THEN

	UPDATE DOMICILIO_FAMILIA
	SET IE_MUDOU_SE = 'S'
	WHERE CD_PESSOA_FISICA = CD_PESSOA_FAMILIA_P;


	UPDATE PESSOA_DOMICILIO_MORADIA
	SET IE_MUDOU_SE = 'S'
	WHERE CD_PESSOA_FAMILIA = CD_PESSOA_FAMILIA_P;
	END IF;

	IF (CD_DOMCILIO_PF_W <> CD_DOMICILIO_W) THEN

		INSERT INTO DOMICILIO_FAMILIA(NR_SEQUENCIA,
			DT_ATUALIZACAO,
			DT_ATUALIZACAO_NREC,
			NM_USUARIO,
			NM_USUARIO_NREC,
			CD_DOMICILIO,
			DS_BAIRRO,
			DS_COMPLEMENTO,
			DS_ENDERECO,
			NR_ENDERECO,
			CD_DOMICILIO_MUNICIPIO,
			NR_TEL_RESIDENCIAL,
			CD_PESSOA_FISICA,
			CD_CEP,
			NM_PESSOA_RESPONSAVEL,
			IE_MUDOU_SE,
			DS_REFERENCIA,
			IE_TIPO_DOMICILIO,
			IE_TRATAMENTO_AGUA,
			IE_TIPO_AGUA,
			IE_DESTINO_LIXO,
			IE_ESGOTO_SANITARIO,
			IE_TIPO_COMUNICACAO,
			IE_TIPO_DOENCA,
			IE_TIPO_TRANSPORTE,
			IE_ENERGIA_ELETRICA,
			DS_REF_RESIDENCIAL,
			NR_DDI_RESIDENCIAL,
			NR_SEQ_AREA,
			NR_SEQ_EQUIPE,
			NR_SEQ_MICROAREA,
			QT_COMODO,
			NR_SEQ_TIPO_LOGRADOURO)
		VALUES (nextval('domicilio_familia_seq'),
			clock_timestamp(),
			clock_timestamp(),
			NM_USUARIO_P,
			NM_USUARIO_P,
			CD_DOMICILIO_W,
			DS_BAIRRO_W,
			DS_COMPLEMENTO_W,
			DS_ENDERECO_W,
			NR_ENDERECO_W,
			CD_DOMICILIO_MUNICIPIO_W,
			NR_TEL_RESIDENCIAL_W,
			CD_PESSOA_FAMILIA_P,
			CD_CEP_W,
			NM_PESSOA_RESPONSAVEL_W,
			'N',
			DS_REFERENCIA_W,
			IE_TIPO_DOMICILIO_W,
			IE_TRATAMENTO_AGUA_W,
			IE_TIPO_AGUA_W,
			IE_DESTINO_LIXO_W,
			IE_ESGOTO_SANITARIO_W,
			IE_TIPO_COMUNICACAO_W,
			IE_TIPO_DOENCA_W,
			IE_TIPO_TRANSPORTE_W,
			IE_ENERGIA_ELETRICA_W,
			DS_REF_RESIDENCIAL_W,
			NR_DDI_RESIDENCIAL_W,
			NR_SEQ_AREA_W,
			NR_SEQ_EQUIPE_W,
			NR_SEQ_MICROAREA_W,
			QT_COMODO_W,
			NR_SEQ_TIPO_LOGRADOURO_W);

	END IF;

	IF (VALIDAVINCULOPARENTEMORARIA_W = 0) THEN

  BEGIN

		FOR REG1 IN (
			SELECT DISTINCT CD_PESSOA_FAMILIA
			FROM PESSOA_DOMICILIO_MORADIA
			WHERE NR_SEQ_DOMICILIO = CD_DOMICILIO_W
			AND IE_MUDOU_SE <> 'S'
			AND CD_PESSOA_FAMILIA NOT IN (
				SELECT CD_PESSOA_FAMILIA
				FROM PESSOA_DOMICILIO_MORADIA
				WHERE NR_SEQ_DOMICILIO = CD_DOMICILIO_W
				AND CD_PESSOA_FISICA = CD_PESSOA_FAMILIA_P
				AND IE_MUDOU_SE = 'N'))
		LOOP
		INSERT INTO PESSOA_DOMICILIO_MORADIA(NR_SEQUENCIA,
			NR_SEQ_DOMICILIO,
			DT_ATUALIZACAO,
			NM_USUARIO,
			DT_ATUALIZACAO_NREC,
			NM_USUARIO_NREC,
			CD_PESSOA_FAMILIA,
			CD_PESSOA_FISICA,
			NR_SEQ_GRAU_PARENT,
			IE_MUDOU_SE)
			VALUES (nextval('pessoa_domicilio_moradia_seq'),
			CD_DOMICILIO_W,
			clock_timestamp(),
			NM_USUARIO_P,
			clock_timestamp(),
			NM_USUARIO_P,
			REG1.CD_PESSOA_FAMILIA,
			CD_PESSOA_FAMILIA_P,
			OBTER_VINCULO_PARENTESCO(CD_PESSOA_FAMILIA_P, REG1.CD_PESSOA_FAMILIA),
			'N');
			COMMIT;

		END LOOP;

		FOR REG2 IN (
			SELECT CD_PESSOA_FAMILIA PESSOA2
			FROM PESSOA_DOMICILIO_MORADIA
			WHERE NR_SEQ_DOMICILIO = CD_DOMICILIO_W
			AND CD_PESSOA_FISICA = CD_PESSOA_FISICA_P
			AND IE_MUDOU_SE = 'N'
			AND CD_PESSOA_FAMILIA NOT IN (
				SELECT CD_PESSOA_FISICA
				FROM PESSOA_DOMICILIO_MORADIA
				WHERE CD_PESSOA_FAMILIA = CD_PESSOA_FAMILIA_P
				AND NR_SEQ_DOMICILIO = CD_DOMICILIO_W
				AND IE_MUDOU_SE = 'N'))
		LOOP
			INSERT INTO PESSOA_DOMICILIO_MORADIA(	NR_SEQUENCIA,
			NR_SEQ_DOMICILIO,
			DT_ATUALIZACAO,
			NM_USUARIO,
			DT_ATUALIZACAO_NREC,
			NM_USUARIO_NREC,
			CD_PESSOA_FISICA,
			CD_PESSOA_FAMILIA,
			NR_SEQ_GRAU_PARENT,
			IE_MUDOU_SE)
			VALUES (nextval('pessoa_domicilio_moradia_seq'),
			CD_DOMICILIO_W,
			clock_timestamp(),
			NM_USUARIO_P,
			clock_timestamp(),
			NM_USUARIO_P,
			REG2.PESSOA2,
			CD_PESSOA_FAMILIA_P,
			OBTER_VINCULO_PARENTESCO(REG2.PESSOA2, CD_PESSOA_FAMILIA_P),
			'N');
			COMMIT;
		END LOOP;
  END;
	END IF;

	SELECT COUNT(NR_SEQUENCIA)
		INTO STRICT VALIDA_SI_MESMO_W
		FROM PESSOA_DOMICILIO_MORADIA
		WHERE CD_PESSOA_FISICA = CD_PESSOA_FAMILIA_P
		AND CD_PESSOA_FAMILIA = CD_PESSOA_FAMILIA_P
		AND IE_MUDOU_SE <> 'S'
		AND NR_SEQ_DOMICILIO = CD_DOMICILIO_W;


	IF (VALIDA_SI_MESMO_W = 0) THEN

		INSERT INTO PESSOA_DOMICILIO_MORADIA(	NR_SEQUENCIA,
			NR_SEQ_DOMICILIO,
			DT_ATUALIZACAO,
			NM_USUARIO,
			DT_ATUALIZACAO_NREC,
			NM_USUARIO_NREC,
			CD_PESSOA_FISICA,
			CD_PESSOA_FAMILIA,
			NR_SEQ_GRAU_PARENT,
			IE_MUDOU_SE)
		VALUES (nextval('pessoa_domicilio_moradia_seq'),
			CD_DOMICILIO_W,
			clock_timestamp(),
			NM_USUARIO_P,
			clock_timestamp(),
			NM_USUARIO_P,
			CD_PESSOA_FAMILIA_P,
			CD_PESSOA_FAMILIA_P,
			NULL,
			'N');
			COMMIT;

	END IF;

	SELECT COUNT(NR_SEQUENCIA)
		INTO STRICT VALIDA_RESIDENCIA_W
		FROM COMPL_PESSOA_FISICA
		WHERE IE_TIPO_COMPLEMENTO = 1
		AND CD_PESSOA_FISICA = CD_PESSOA_FAMILIA_P;

	IF (VALIDA_RESIDENCIA_W = 0) THEN

		SELECT	coalesce(MAX(NR_SEQUENCIA),0) + 1
			INTO STRICT	NR_SEQUENCIA_COMPL_W
			FROM	COMPL_PESSOA_FISICA
			WHERE	CD_PESSOA_FISICA = CD_PESSOA_FISICA_P;

		INSERT INTO COMPL_PESSOA_FISICA(NR_SEQUENCIA,
			CD_PESSOA_FISICA,
			IE_TIPO_COMPLEMENTO,
			DT_ATUALIZACAO,
			DT_ATUALIZACAO_NREC,
			NM_USUARIO,
			NM_USUARIO_NREC,
			CD_CEP,
			DS_BAIRRO,
			DS_COMPLEMENTO,
			DS_MUNICIPIO,
			NR_ENDERECO,
			DS_ENDERECO)
		VALUES (NR_SEQUENCIA_COMPL_W,
			CD_PESSOA_FAMILIA_P,
			'1',
			clock_timestamp(),
			clock_timestamp(),
			NM_USUARIO_P,
			NM_USUARIO_P,
			CD_CEP_W,
			DS_BAIRRO_W,
			DS_COMPLEMENTO_W,
			CD_DOMICILIO_MUNICIPIO_W,
			NR_ENDERECO_W,
			DS_ENDERECO_W);

		END IF;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE inserir_familia_domicilio ( CD_PESSOA_FISICA_P text, CD_PESSOA_FAMILIA_P text, NR_SEQ_GRAU_PARENTESCO_P text, NM_USUARIO_P text) FROM PUBLIC;

