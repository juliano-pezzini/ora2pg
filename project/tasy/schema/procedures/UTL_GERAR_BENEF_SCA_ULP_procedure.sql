-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE utl_gerar_benef_sca_ulp ( nr_seq_lote_p bigint, nm_arquivo_p text) AS $body$
DECLARE

 
ds_colunas_w			varchar(4000) 		:= '';
arq_texto_w			utl_file.file_type;
ds_local_w			varchar(255) 		:= null;
ds_erro_w			varchar(255);
nr_seq_segurado_w		pls_segurado.nr_sequencia%type;
cd_usuario_plano_w		varchar(50);
nm_pessoa_fisica_w		pessoa_fisica.nm_pessoa_fisica%type;
nm_mae_w			compl_pessoa_fisica.nm_contato%type;
nr_seq_contrato_w		pls_segurado.nr_seq_contrato%type;
dt_contratacao_w		pls_segurado.dt_contratacao%type;
cd_matricula_estipulante_w	pls_segurado.cd_matricula_estipulante%type;
ie_titularidade_w		pls_segurado.ie_titularidade%type;
nr_seq_titular_w		pls_segurado.nr_seq_titular%type;
nm_titular_w			varchar(255);
dt_nascimento_w			pessoa_fisica.dt_nascimento%type;
ie_sexo_w			varchar(10);
ie_estado_civil_w		varchar(255);
nr_cpf_w			pessoa_fisica.nr_cpf%type;
cd_cooperativa_f_w		bigint;
ds_congenere_w			varchar(255);
ds_plano_w			pls_plano.ds_plano%type;
ds_planos_w			varchar(4000);
nr_seq_parentesco_w		pls_segurado.nr_seq_parentesco%type;
ds_parentesco_w			grau_parentesco.ds_parentesco%type;
dt_rescisao_w			pls_segurado.dt_rescisao%type;
cd_pessoa_fisica_w		pessoa_fisica.cd_pessoa_fisica%type;
qt_idade_w			smallint;

file_exist_w			boolean;
size_w				bigint;
block_size_w			bigint;

C01 CURSOR FOR 
	SELECT	nr_seq_segurado 
	from	pls_movimentacao_benef 
	where	nr_seq_lote	= nr_seq_lote_p;

C02 CURSOR FOR 
	SELECT	b.ds_plano 
	from	pls_sca_vinculo a, 
		pls_plano b 
	where	a.nr_seq_plano 	 = b.nr_sequencia 
	and	a.nr_seq_segurado = nr_seq_segurado_w;


BEGIN 
 
--Obtém os dados do arquivo no diretório 
utl_file.fgetattr(ds_local_w,nm_arquivo_p,file_exist_w,size_w,block_size_w);
 
--Caso existir, remove ele para não criar registros no arquivo já criado 
if (file_exist_w) then 
	utl_file.fremove(ds_local_w,nm_arquivo_p);
end if;
 
begin 
SELECT * FROM obter_evento_utl_file(12, null, ds_local_w, ds_erro_w) INTO STRICT ds_local_w, ds_erro_w;
exception 
when others then 
	ds_local_w := null;
end;
 
if (ds_erro_w IS NOT NULL AND ds_erro_w::text <> '') then 
	CALL wheb_mensagem_pck.exibir_mensagem_abort(ds_erro_w);
end if;
 
begin 
arq_texto_w := utl_file.fopen(ds_local_w,nm_arquivo_p,'W',32767);
exception 
when others then 
	ds_erro_w := obter_erro_utl_open(SQLSTATE);
	CALL wheb_mensagem_pck.exibir_mensagem_abort(ds_erro_w);
end;
 
utl_file.put_line(arq_texto_w, 'NR_SEQUENCIA;NR_CARTAO;NM_BENEFICIARIO;NM_MAE;NR_SEQ_CONTRATO;DT_CONTRATACAO;'|| 
				'CD_MATRICULA_ESTIPULANTE;IE_TITULARIDADE;NR_SEQ_PARENTESCO;DS_GRAU;NR_SEQ_TITULAR;NM_TITULAR;'|| 
				'DT_NASCIMENTO;QT_IDADE;IE_SEXO;IE_ESTADO_CIVIL;NR_CPF;CD_COOPERATIVA_F;DS_CONGENERE;'|| 
				'SCA1;SCA2;SCA3;SCA4;SCA5;SCA6;'|| 
				'SCA7;SCA8;SCA9;SCA10;SCA11;SCA12;'|| 
				'SCA13;SCA14;SCA15;SCA16;SCA17;'||chr(13));
utl_file.fflush(arq_texto_w);
 
open C01;
loop 
fetch C01 into	 
	nr_seq_segurado_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin 
	 
	select	max(pls_obter_carteira_mascara(a.nr_sequencia)) cd_usuario_plano, 
		max(b.nm_pessoa_fisica), 
		max(a.nr_seq_contrato), 
		max(a.dt_contratacao), 
		max(a.cd_matricula_estipulante), 
		max(a.ie_titularidade), 
		max(a.nr_seq_titular), 
		max(pls_obter_dados_segurado(a.nr_seq_titular,'N')) nm_titular, 
		max(b.dt_nascimento), 
		max(b.ie_sexo), 
		max(b.ie_estado_civil), 
		max(b.nr_cpf), 
		max(a.nr_seq_parentesco), 
		max(a.dt_rescisao), 
		max(b.cd_pessoa_fisica) 
	into STRICT	cd_usuario_plano_w, 
		nm_pessoa_fisica_w, 
		nr_seq_contrato_w, 
		dt_contratacao_w, 
		cd_matricula_estipulante_w, 
		ie_titularidade_w, 
		nr_seq_titular_w, 
		nm_titular_w, 
		dt_nascimento_w, 
		ie_sexo_w, 
		ie_estado_civil_w, 
		nr_cpf_w, 
		nr_seq_parentesco_w, 
		dt_rescisao_w, 
		cd_pessoa_fisica_w 
	from	pls_segurado 		a, 
		pessoa_fisica 		b 
	where	a.cd_pessoa_fisica = b.cd_pessoa_fisica 
	and	a.nr_sequencia = nr_seq_segurado_w;
	 
	select	max(nm_contato) 
	into STRICT	nm_mae_w 
	from	compl_pessoa_fisica 
	where	cd_pessoa_fisica = cd_pessoa_fisica_w 
	and	ie_tipo_complemento = '5';
	 
	select	max(substr(pls_obter_cd_seq_congenere(d.nr_seq_congenere,'CD'),1,255)) cd_cooperativa_f, 
		max(substr(pls_obter_nome_congenere(d.nr_seq_congenere),1,255)) ds_congenere 
	into STRICT	cd_cooperativa_f_w, 
		ds_congenere_w 
	from	pls_segurado_repasse 	d 
	where	d.nr_seq_segurado = nr_seq_segurado_w;
	 
	if (nr_seq_parentesco_w IS NOT NULL AND nr_seq_parentesco_w::text <> '') then 
		select	ds_parentesco 
		into STRICT	ds_parentesco_w 
		from	grau_parentesco 
		where	nr_sequencia = nr_seq_parentesco_w;
	end if;
	 
	select trunc((months_between(clock_timestamp(), dt_nascimento_w))/12) 
	into STRICT	qt_idade_w 
	;
	 
	ds_planos_w	:= '';
	 
	open C02;
	loop 
	fetch C02 into 
		ds_plano_w;
	EXIT WHEN NOT FOUND; /* apply on C02 */
		begin 
		ds_planos_w := ds_planos_w || ds_plano_w ||';';
		end;
	end loop;
	close C02;
	 
	utl_file.put_line(arq_texto_w,nr_seq_segurado_w||';'||cd_usuario_plano_w||';'||nm_pessoa_fisica_w||';'||nm_mae_w||';'||nr_seq_contrato_w||';'||to_char(dt_contratacao_w,'dd/mm/yyyy')||';'|| 
				cd_matricula_estipulante_w||';'||ie_titularidade_w||';'||nr_seq_parentesco_w||';'||ds_parentesco_w||';'||nr_seq_titular_w||';'||nm_titular_w||';'|| 
				to_char(dt_nascimento_w,'dd/mm/yyyy')||';'||qt_idade_w||';'||ie_sexo_w||';'||ie_estado_civil_w||';'||nr_cpf_w||';'||cd_cooperativa_f_w||';'||ds_congenere_w||';'|| 
				ds_planos_w||';'||chr(13));
	utl_file.fflush(arq_texto_w);
	end;
end loop;
close C01;
 
utl_file.fclose(arq_texto_w);
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE utl_gerar_benef_sca_ulp ( nr_seq_lote_p bigint, nm_arquivo_p text) FROM PUBLIC;

