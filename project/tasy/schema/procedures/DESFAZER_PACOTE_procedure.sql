-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE desfazer_pacote ( nr_seq_proc_pacote_p bigint, ie_recalcular_conta_p text, nm_usuario_p text, ie_commit_p text default 'S') AS $body$
DECLARE


nr_sequencia_w			bigint;
cd_convenio_w			integer;
qt_procedimento_w		double precision;
nr_interno_conta_w		bigint;
qt_reg_w			bigint;
IE_VALOR_INF_PACOTE_W		varchar(01);
cd_estabelecimento_w		bigint;
NR_SEQ_VALOR_DESC_W		bigint;
vl_procedimento_w		double precision	:= 0;
vl_medico_w			double precision	:= 0;
vl_custo_operacional_w		double precision	:= 0;
vl_materiais_w			double precision	:= 0;
vl_anestesista_w		double precision	:= 0;
vl_auxiliares_w			double precision	:= 0;
vl_medico_conta_w		double precision	:= 0;
VL_material_w			double precision	:= 0;
nr_interno_conta_ww		bigint	:= 0;
ie_proc_glosa_w			varchar(1)	:= 'N';

cd_situacao_glosa_w		procedimento_paciente.cd_situacao_glosa%type;
nr_seq_proc_princ_w		procedimento_paciente.nr_seq_proc_princ%type;
ie_resp_cred_manual_w		procedimento_paciente.ie_resp_cred_manual%type;
ie_resp_cred_proc_w		procedimento_paciente.ie_responsavel_credito%type;
ie_atualizar_resp_partic_w	varchar(1);

nr_seq_proc_pac_desc_w		procedimento_paciente.nr_sequencia%type;
cd_conv_proc_desc_w		procedimento_paciente.cd_convenio%type;

nr_seq_mat_pac_desc_w		material_atend_paciente.nr_sequencia%type;

c010 CURSOR FOR
SELECT 	nr_sequencia,
	cd_convenio,
	qt_procedimento,
	nr_interno_conta,
	nr_seq_proc_princ,
	ie_resp_cred_manual,
	ie_responsavel_credito
from 	Procedimento_paciente
where nr_seq_proc_pacote	= nr_seq_proc_pacote_p;

c020 CURSOR FOR
	SELECT	nr_sequencia,
		nr_interno_conta
	from	material_atend_paciente
	where 	nr_seq_proc_pacote	= nr_seq_proc_pacote_p;

-- Procedimentos excedentes com desconto gerado pelo pacote
C030 CURSOR FOR
	SELECT	nr_seq_propaci
	from	proc_pac_desc_pacote
	where	nr_seq_proc_pacote = nr_seq_proc_pacote_p;

-- Materiais excedentes com desconto gerado pelo pacote
C040 CURSOR FOR
	SELECT	nr_seq_matpaci
	from	mat_atend_pac_desc_pacote
	where	nr_seq_proc_pacote = nr_seq_proc_pacote_p;


BEGIN

CALL Calcula_regra_tx_pck.set_calcula_regra_tx('N');

ie_atualizar_resp_partic_w 	:=	obter_valor_param_usuario(67,516,Obter_Perfil_ativo, nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento);

/* Edgar 25/03/2004 OS 7288, coloquei este update aqui */

open C020;
loop
fetch C020 into
	nr_sequencia_w,
	nr_interno_conta_w;
EXIT WHEN NOT FOUND; /* apply on C020 */
	begin

	select	max(cd_estabelecimento)
	into STRICT	cd_estabelecimento_w
	from	conta_paciente
	where	nr_interno_conta	= nr_interno_conta_w;

	select	coalesce(max(IE_VALOR_INF_PACOTE), 'N')
	into STRICT	IE_VALOR_INF_PACOTE_w
	from	parametro_faturamento
	where	cd_estabelecimento	= cd_estabelecimento_w;

	if (IE_VALOR_INF_PACOTE_w	= 'S') then
		begin

		select	coalesce(max(nr_sequencia),0)
		into STRICT	nr_seq_valor_desc_w
		from	MAT_ATEND_PACIENTE_VALOR
		where	nr_seq_material	= nr_sequencia_w
		and	ie_tipo_valor		= 96;

		if (nr_seq_valor_desc_w 	<> 0) then
			select	coalesce(VL_material,0)
			into STRICT	VL_material_w
			from 	MAT_ATEND_PACIENTE_VALOR
			where 	nr_seq_material		= nr_sequencia_w
			and	ie_tipo_valor		= 96
			and	nr_sequencia		= nr_seq_valor_desc_w;

			update	Material_atend_paciente
			set 	nr_seq_proc_pacote	 = NULL,
				vl_material		= VL_material_w,
				vl_tabela_original	 = NULL,
				ie_dispersao		= 'N',
				ie_valor_informado	= 'S'
			where 	nr_sequencia		= nr_sequencia_w;

		else
			update	Material_atend_paciente
			set 	nr_seq_proc_pacote	 = NULL,
				vl_material		= coalesce(vl_tabela_original,0),
				vl_tabela_original	 = NULL,
				ie_dispersao		= 'N',
				ie_valor_informado	= 'N'
			where 	nr_sequencia		= nr_sequencia_w;

		end if;
		end;
	else
		update	Material_atend_paciente
		set 	nr_seq_proc_pacote	 = NULL,
			vl_material		= coalesce(vl_tabela_original,0),
			vl_tabela_original	 = NULL,
			ie_dispersao		= 'N',
			ie_valor_informado	= 'N'
		where 	nr_sequencia		= nr_sequencia_w;
	end if;

	end;
end loop;
close C020;

-- Desfazer o desconto dos materiais excedentes do pacote
open C040;
loop
fetch C040 into
	nr_seq_mat_pac_desc_w;
EXIT WHEN NOT FOUND; /* apply on C040 */
	begin

	update 	material_atend_paciente
	set 	ie_valor_informado	= 'N'
	where 	nr_sequencia		= nr_seq_mat_pac_desc_w;

	CALL atualiza_preco_material( nr_seq_mat_pac_desc_w, nm_usuario_p);

	end;
end loop;
close C040;


OPEN C010;
LOOP
FETCH C010 into
	nr_sequencia_w,
	cd_convenio_w,
	qt_procedimento_w,
	nr_interno_conta_w,
	nr_seq_proc_princ_w,
	ie_resp_cred_manual_w,
	ie_resp_cred_proc_w;
EXIT WHEN NOT FOUND; /* apply on C010 */
	begin

	ie_proc_glosa_w	:= 'N';
	if (nr_seq_proc_princ_w IS NOT NULL AND nr_seq_proc_princ_w::text <> '') then
		select	max(cd_situacao_glosa)
		into STRICT	cd_situacao_glosa_w
		from	procedimento_paciente
		where	nr_sequencia = nr_seq_proc_princ_w;

		if (coalesce(cd_situacao_glosa_w,0) in (8,10,23)) then
			ie_proc_glosa_w	:= 'S';
		end if;
	end if;

	if (qt_procedimento_w = 0) and (ie_proc_glosa_w = 'N') then
		begin

		delete from proc_paciente_valor
		where 	nr_seq_procedimento	= nr_sequencia_w
		and 	ie_tipo_valor		= 1;

		update	procedimento_paciente
		set	nr_seq_proc_princ	 = NULL
		where	nr_seq_proc_princ	= nr_sequencia_w;

		begin
		delete from procedimento_paciente
		where nr_sequencia	= nr_sequencia_w;
		exception
			when others then
				nr_sequencia_w := nr_sequencia_w;
		end;
		end;
	else
		begin
		RAISE NOTICE 'nr_sequencia_w = %', nr_sequencia_w;
		update 	procedimento_paciente
		set 	nr_seq_proc_pacote		 = NULL,
			ie_ratear_item		 = NULL,
			ie_valor_informado	= 'N',
			ie_dispersao		= 'N'
		where 	nr_sequencia		= nr_sequencia_w
		and	coalesce(cd_situacao_glosa,0) not in (8,10,23);

		update 	procedimento_paciente
		set 	nr_seq_proc_pacote	 = NULL,
			ie_ratear_item		 = NULL,
			ie_dispersao		= 'N'
		where 	nr_sequencia		= nr_sequencia_w
		and	coalesce(cd_situacao_glosa,0) in (8,10,23);


		select	count(*)
		into STRICT	qt_reg_w
		from	procedimento_paciente
		where	nr_sequencia		= nr_sequencia_w
		and	coalesce(cd_situacao_glosa,0) not in (8,10,23);


		if (qt_reg_w > 0) then
			CALL atualiza_preco_procedimento(
				nr_sequencia_w,
				cd_convenio_w,
				nm_usuario_p);

			nr_interno_conta_ww:=  nr_interno_conta_w;

			select 	coalesce(max(nr_interno_conta), nr_interno_conta_w)
			into STRICT	nr_interno_conta_ww
			from 	procedimento_paciente
			where 	nr_sequencia = nr_sequencia_w;

		end if;

		delete from proc_paciente_valor
		where nr_seq_procedimento	= nr_sequencia_w
		and ie_tipo_valor		= 1;

		select	max(cd_estabelecimento)
		into STRICT	cd_estabelecimento_w
		from	conta_paciente
		where	nr_interno_conta	= nr_interno_conta_w;

		select	coalesce(max(IE_VALOR_INF_PACOTE), 'N')
		into STRICT	IE_VALOR_INF_PACOTE_w
		from	parametro_faturamento
		where	cd_estabelecimento	= cd_estabelecimento_w;

		if (IE_VALOR_INF_PACOTE_w	= 'S') then
			begin

			select	coalesce(max(nr_sequencia),0)
			into STRICT	nr_seq_valor_desc_w
			from	proc_paciente_valor
			where	nr_seq_procedimento	= nr_sequencia_w
			and	ie_tipo_valor		= 96;

			if (nr_seq_valor_desc_w 	<> 0) then
				select	coalesce(VL_PROCEDIMENTO,0),
					coalesce(VL_MEDICO,0),
					coalesce(VL_ANESTESISTA,0),
					coalesce(VL_MATERIAIS,0),
					coalesce(VL_AUXILIARES,0),
					coalesce(VL_CUSTO_OPERACIONAL,0)
				into STRICT	VL_PROCEDIMENTO_w,
					VL_MEDICO_w,
					VL_ANESTESISTA_w,
					VL_MATERIAIS_w,
					VL_AUXILIARES_w,
					VL_CUSTO_OPERACIONAL_w
				from 	proc_paciente_valor
				where 	nr_seq_procedimento	= nr_sequencia_w
				and	ie_tipo_valor		= 96
				and	nr_sequencia		= nr_seq_valor_desc_w;

				update	procedimento_paciente
				set	ie_valor_informado	= 'S',
					vl_procedimento		= VL_PROCEDIMENTO_w,
					VL_MEDICO		= VL_MEDICO_w,
					VL_ANESTESISTA		= VL_ANESTESISTA_w,
					VL_MATERIAIS		= VL_MATERIAIS_w,
					VL_AUXILIARES		= VL_AUXILIARES_w,
					VL_CUSTO_OPERACIONAL	= VL_CUSTO_OPERACIONAL_w
				where	nr_sequencia		= nr_sequencia_w;


			end if;
			end;
		end if;

		if (coalesce(ie_resp_cred_manual_w,'N') = 'S') then
			CALL Atualizar_Resp_Credito_Conta(nr_sequencia_w, null, cd_estabelecimento_w, ie_resp_cred_proc_w, ie_atualizar_resp_partic_w, nm_usuario_p);
		end if;
		end;
	end if;
---- procedimento_participante
	end;
END LOOP;
close c010;

-- Desfazer o desconto dos procedimentos excedentes do pacote
open C030;
loop
fetch C030 into
	nr_seq_proc_pac_desc_w;
EXIT WHEN NOT FOUND; /* apply on C030 */
	begin

	select	max(cd_convenio)
	into STRICT	cd_conv_proc_desc_w
	from	procedimento_paciente
	where	nr_sequencia = nr_seq_proc_pac_desc_w;

	update 	procedimento_paciente
	set 	ie_valor_informado	= 'N'
	where 	nr_sequencia		= nr_seq_proc_pac_desc_w;

	CALL atualiza_preco_procedimento( nr_seq_proc_pac_desc_w, cd_conv_proc_desc_w, nm_usuario_p);

	end;
end loop;
close C030;

-- Limpar as tabelas com os descontos, para o pacote desfeito
delete	from proc_pac_desc_pacote
where	nr_seq_proc_pacote = nr_seq_proc_pacote_p;

delete	from mat_atend_pac_desc_pacote
where	nr_seq_proc_pacote = nr_seq_proc_pacote_p;

update	procedimento_paciente
set 	ie_valor_informado	= 'N'
where 	nr_interno_conta	= nr_interno_conta_w
  and 	ie_valor_informado= 'S'
  and 	IE_VALOR_INF_PACOTE_w = 'N'
  and 	coalesce(cd_situacao_glosa,0) not in (8,10,23);

/* Edgar 25/03/2004 OS 7288, coloquei este update para antes do looping, pois dava erro ao tentar excluir o procedimento

update Material_atend_paciente
set 	nr_seq_proc_pacote	= null,
	vl_material			= nvl(vl_tabela_original,0),
	vl_tabela_original	= null
where nr_seq_proc_pacote	= nr_seq_proc_pacote_p;
*/
update	procedimento_paciente
set	nr_seq_proc_princ	 = NULL
where	nr_seq_proc_princ	= nr_seq_proc_pacote_p;

update	procedimento_paciente
set	nr_seq_proc_pacote	 = NULL
where	nr_seq_proc_pacote	= nr_seq_proc_pacote_p;

update	material_atend_paciente
set	nr_seq_proc_princ	 = NULL
where	nr_seq_proc_princ	= nr_seq_proc_pacote_p;

update	material_atend_paciente
set	nr_seq_proc_pacote	 = NULL
where	nr_seq_proc_pacote	= nr_seq_proc_pacote_p;

begin
delete from procedimento_paciente
where nr_sequencia		= nr_seq_proc_pacote_p;
exception
	when others then
		CALL WHEB_MENSAGEM_PCK.Exibir_Mensagem_Abort(279959, 'SQLERM=' || sqlerrm || ';' || 'NR_SEQ_PROC=' || nr_seq_proc_pacote_p);

end;

if (coalesce(ie_recalcular_conta_p,'S') = 'S') then
	CALL recalcular_conta_paciente(nr_interno_conta_w, nm_usuario_p);
end if;

if (nr_interno_conta_ww <> nr_interno_conta_w) and (coalesce(ie_recalcular_conta_p,'S') = 'S') then --Essa situação acontece quando o procedimento pacote não está na edição do convênio (OS 117696  Fabrício em  18/11/2008)
	CALL recalcular_conta_paciente(nr_interno_conta_ww, nm_usuario_p);
end if;

CALL Calcula_regra_tx_pck.set_calcula_regra_tx('S');

if (ie_commit_p = 'S') then
	commit;
end if;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE desfazer_pacote ( nr_seq_proc_pacote_p bigint, ie_recalcular_conta_p text, nm_usuario_p text, ie_commit_p text default 'S') FROM PUBLIC;

