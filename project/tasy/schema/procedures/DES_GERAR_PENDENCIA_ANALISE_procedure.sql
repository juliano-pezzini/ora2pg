-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE des_gerar_pendencia_analise ( nr_seq_gerencia_p bigint, nr_seq_grupo_des_p bigint, nr_seq_ordem_serv_p bigint, ie_pendencia_triagem_p text default 'S', ie_nao_lida_p text default 'N', ie_em_execucao_p text default 'N', nm_usuario_p text DEFAULT NULL, nm_usuario_lider_p text DEFAULT NULL, ie_somente_sla_p text default 'N') AS $body$
DECLARE


nr_seq_gerencia_ww	bigint;
nr_seq_grupo_des_ww	bigint;

nr_seq_ordem_serv_w	bigint;
nr_seq_gerencia_w		bigint;
nr_seq_grupo_des_w	bigint	:= 0;
nr_seq_grupo_des_old_w	bigint	:= 0;

nm_usuario_manutencao_w	varchar(15);
nm_usuario_lider_w		varchar(15);
nm_usuario_negonio_w	varchar(15);

nm_usuario_exec_w	varchar(15);

ie_tipo_prev_w		varchar(3);
dt_atual_w		timestamp := trunc(clock_timestamp(),'dd');
ie_novo_hist_w		varchar(1);
ie_nao_lida_w		varchar(1);
nr_seq_estagio_w		bigint;
ie_tipo_w			varchar(1);

c01 CURSOR FOR
SELECT	a.nr_sequencia,
	c.nr_seq_gerencia,
	a.nr_seq_grupo_des,
	a.nr_seq_estagio
from	grupo_desenvolvimento c,
	man_estagio_processo b,
	man_ordem_servico a
where	a.nr_seq_estagio		= b.nr_sequencia
and	a.nr_seq_grupo_des	= c.nr_sequencia
and	b.ie_desenv		= 'S'
and	ie_tipo_w			= 'D'
and((coalesce(nm_usuario_lider_p::text, '') = ''
and (nr_seq_gerencia_ww = 0 	or nr_seq_gerencia_ww = c.nr_seq_gerencia)
and (nr_seq_grupo_des_ww = 0 	or nr_seq_grupo_des_ww = a.nr_seq_grupo_des))
or ((nm_usuario_lider_p IS NOT NULL AND nm_usuario_lider_p::text <> '') and c.nm_usuario_lider = nm_usuario_lider_p))
and (coalesce(nr_seq_ordem_serv_p,0) = 0 or a.nr_sequencia = nr_seq_ordem_serv_p)
and	(a.nr_seq_grupo_des IS NOT NULL AND a.nr_seq_grupo_des::text <> '')
and	a.ie_status_ordem <> '3'
and (ie_somente_sla_p = 'N' or 
     exists (SELECT s.nr_seq_ordem
            from man_ordem_serv_SLA s
            where a.nr_sequencia = s.nr_seq_ordem))

union

select	a.nr_sequencia,
	c.nr_seq_gerencia_sup,
	a.nr_seq_grupo_sup nr_seq_grupo_des,
	a.nr_seq_estagio
from	grupo_suporte c,
	man_estagio_processo b,
	man_ordem_servico a
where	a.nr_seq_estagio		= b.nr_sequencia
and	a.nr_seq_grupo_sup	= c.nr_sequencia
and	b.ie_suporte		= 'S'
and	ie_tipo_w			= 'S'
and((coalesce(nm_usuario_lider_p::text, '') = ''
and (nr_seq_gerencia_ww = 0 	or nr_seq_gerencia_ww = c.nr_seq_gerencia_sup)
and (nr_seq_grupo_des_ww = 0 	or nr_seq_grupo_des_ww = a.nr_seq_grupo_sup)) 
or ((nm_usuario_lider_p IS NOT NULL AND nm_usuario_lider_p::text <> '') and c.nm_usuario_lider = nm_usuario_lider_p))
and (coalesce(nr_seq_ordem_serv_p,0) = 0 or a.nr_sequencia = nr_seq_ordem_serv_p)
and	(a.nr_seq_grupo_sup IS NOT NULL AND a.nr_seq_grupo_sup::text <> '')
and	a.ie_status_ordem <> '3'
and (ie_somente_sla_p = 'N' or 
     exists (select s.nr_seq_ordem
            from man_ordem_serv_SLA s
            where a.nr_sequencia = s.nr_seq_ordem))
order by	nr_seq_grupo_des;

c02 CURSOR FOR
SELECT	b.nm_usuario_exec
from	man_ordem_servico a,
	usuario_grupo_des c,
	man_ordem_servico_exec b
where	b.nm_usuario_exec = c.nm_usuario_grupo
and	coalesce(b.dt_fim_execucao::text, '') = ''
and	ie_tipo_w		= 'D'
and	((b.nm_usuario_exec not(	SELECT	coalesce(x.nm_usuario_lider,'X')
				from	grupo_desenvolvimento x
				
union all
 
				select	coalesce(x.nm_usuario_negonio,'X')
				from	grupo_desenvolvimento x
				
union all

				select	coalesce(x.nm_usuario_grupo,'X')
				from	usuario_grupo_des x
				where	x.ie_funcao_usuario in ('S','N')
				and     clock_timestamp() between x.dt_inicio_vigencia and coalesce(x.dt_fim_vigencia, clock_timestamp()))) or (a.nr_seq_estagio = 1051))
and	b.nm_usuario_exec in (	select	x.nm_usuario_grupo
				from	gerencia_wheb w,
					grupo_desenvolvimento g,
					usuario_grupo_des x
				where	x.nr_seq_grupo = g.nr_sequencia
				and	g.ie_situacao = 'A'
				and	w.nr_sequencia = g.nr_seq_gerencia
				and	w.ie_area_gerencia = 'DES'
				and clock_timestamp() between x.dt_inicio_vigencia and coalesce(x.dt_fim_vigencia, clock_timestamp()))
and	b.nr_seq_ordem = nr_seq_ordem_serv_w
and	a.nr_sequencia = b.nr_seq_ordem

union

select	b.nm_usuario_exec
from	usuario_grupo_sup c,
	man_ordem_servico_exec b
where	b.nm_usuario_exec = c.nm_usuario_grupo
and	coalesce(b.dt_fim_execucao::text, '') = ''
and	ie_tipo_w		= 'S'
and	b.nm_usuario_exec not in (	select	coalesce(x.nm_usuario_lider,'X')
					from	grupo_suporte x
					
union all

					select	coalesce(x.nm_usuario_grupo,'X')
					from	usuario_grupo_sup x
					where	x.ie_funcao_usuario = 'S'
					    and clock_timestamp() between x.dt_inicio_vigencia and coalesce(x.dt_fim_vigencia, clock_timestamp()))
and	b.nr_seq_ordem = nr_seq_ordem_serv_w
group by	nm_usuario_exec;


BEGIN
nr_seq_gerencia_ww	:= coalesce(nr_seq_gerencia_p,0);
nr_seq_grupo_des_ww	:= coalesce(nr_seq_grupo_des_p,0);

select	coalesce(max('S'),'D')
into STRICT	ie_tipo_w
from	usuario_grupo_sup
where	nm_usuario_grupo = nm_usuario_p
    and clock_timestamp() between dt_inicio_vigencia and coalesce(dt_fim_vigencia, clock_timestamp());

ie_nao_lida_w	:=	coalesce(ie_nao_lida_p,'X');

if (ie_tipo_w = 'D') then
	ie_nao_lida_w	:= 'N';
end if;

delete	FROM w_resumo_prev_os_item
where	nm_usuario = nm_usuario_p;
commit;

open c01;
loop
fetch c01 into
	nr_seq_ordem_serv_w,
	nr_seq_gerencia_w,
	nr_seq_grupo_des_w,
	nr_seq_estagio_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	begin
	if (coalesce(ie_pendencia_triagem_p,'S') <> 'X') then
		begin
		if (nr_seq_grupo_des_w <> nr_seq_grupo_des_old_w) then
			begin
			select	max(x.nm_usuario_lider),
				max(x.nm_usuario_manutencao),
				max(x.nm_usuario_negonio)
			into STRICT	nm_usuario_lider_w,
				nm_usuario_manutencao_w,
				nm_usuario_negonio_w
			from (SELECT	coalesce(nm_usuario_lider,'X') nm_usuario_lider,
					coalesce(nm_usuario_manutencao,'X') nm_usuario_manutencao,
					coalesce(nm_usuario_negonio,'X') nm_usuario_negonio
				 from	grupo_desenvolvimento
				 where	nr_sequencia = nr_seq_grupo_des_w
				 and	ie_tipo_w		= 'D'
				
union

				 SELECT	coalesce(nm_usuario_lider,'X') nm_usuario_lider,
					'X' nm_usuario_manutencao,
					'X' nm_usuario_negonio
				 from	grupo_suporte
				 where	nr_sequencia = nr_seq_grupo_des_w
				 and	ie_tipo_w		= 'S') x;

			nr_seq_grupo_des_old_w	:= nr_seq_grupo_des_w;
			end;
		end if;

		ie_tipo_prev_w	:= null;

		open c02;
		loop
		fetch c02 into
			nm_usuario_exec_w;
		exit when ((c02%notfound) or (coalesce(ie_tipo_prev_w,'OK') <> 'OK'));
			begin
			/*se tiver data prevista para a data atual ou para data futura, esta ok*/

			begin
			select	'OK'
			into STRICT	ie_tipo_prev_w
			from	man_ordem_ativ_prev
			where	nr_seq_ordem_serv	= nr_seq_ordem_serv_w
			and	nm_usuario_prev	= nm_usuario_exec_w
			and	dt_prevista	>= dt_atual_w
			and	coalesce(dt_real::text, '') = ''  LIMIT 1;
			exception
			when others then
				begin
				select	'EXC'
				into STRICT	ie_tipo_prev_w
				from	man_ordem_ativ_prev
				where	nr_seq_ordem_serv	= nr_seq_ordem_serv_w
				and	nm_usuario_prev	= nm_usuario_exec_w
				and	dt_prevista	>= dt_atual_w  LIMIT 1;
				exception
				when others then
					/*se ja teve data prevista para o passado*/

					begin
					select	'ATR'
					into STRICT	ie_tipo_prev_w
					from	man_ordem_ativ_prev
					where	nr_seq_ordem_serv	= nr_seq_ordem_serv_w
					and	nm_usuario_prev	= nm_usuario_exec_w
					and	dt_prevista	< dt_atual_w  LIMIT 1;
					exception
					when others then
						/*verifica se existe atividade prevista*/

						begin
						select	'SDP'
						into STRICT	ie_tipo_prev_w
						from	man_ordem_ativ_prev
						where	nr_seq_ordem_serv	= nr_seq_ordem_serv_w
						and	nm_usuario_prev	= nm_usuario_exec_w
						and	coalesce(dt_prevista::text, '') = ''  LIMIT 1;
						exception
						when others then
							ie_tipo_prev_w := 'SAP';
						end;
					end;
				end;
			end;

			end;
		end loop;
		close c02;

		if (coalesce(ie_tipo_prev_w::text, '') = '') then
			/*sem executores previstos*/

			begin
			select	'OK'
			into STRICT	ie_tipo_prev_w
			from	man_ordem_servico_exec b
			where	b.nr_seq_ordem	= nr_seq_ordem_serv_w
			and	b.nm_usuario_exec in (	SELECT	coalesce(x.nm_usuario_lider,'X')
							from	grupo_desenvolvimento x
							where	ie_tipo_w		= 'D'
							
union all

							SELECT	coalesce(w.nm_usuario_lider,'X')
							from	grupo_suporte w
							where	ie_tipo_w		= 'S'
							
union all

							select	coalesce(z.nm_usuario_negonio,'X')
							from	grupo_desenvolvimento z
							where	ie_tipo_w		= 'D'
							
union all

							select	coalesce(r.nm_usuario_grupo,'X')
							from	usuario_grupo_des r
							where	r.ie_funcao_usuario in ('S','N')
							and	ie_tipo_w		= 'D'
							and clock_timestamp() between r.dt_inicio_vigencia and coalesce(r.dt_fim_vigencia, clock_timestamp()))
			and	coalesce(b.dt_fim_execucao::text, '') = ''  LIMIT 1;
			exception
			when others then
				begin
				select	'OK'
				into STRICT	ie_tipo_prev_w
				from	cadastro_fila c,
					man_ordem_servico_exec b
				where	b.nr_seq_ordem	= nr_seq_ordem_serv_w
				and	b.nm_usuario_exec	= c.nm_usuario_fila
				and	coalesce(b.dt_fim_execucao::text, '') = ''
				and	not exists (	SELECT	1
							from	man_ordem_serv_skill x
							where	x.nr_seq_ordem_serv = b.nr_seq_ordem)  LIMIT 1;
				exception
				when others then
					begin
					select	'OK'
					into STRICT	ie_tipo_prev_w
					from	cadastro_fila c,
						man_ordem_servico_exec b
					where	b.nr_seq_ordem	= nr_seq_ordem_serv_w
					and	b.nm_usuario_exec	= c.nm_usuario_fila
					and	coalesce(b.dt_fim_execucao::text, '') = ''
					and	exists (	SELECT	1
							from	man_ordem_serv_skill x,
								lista_usuario_os y,
								skill_desenv_usuario z
							where	x.nr_seq_ordem_serv = b.nr_seq_ordem
							and	y.nm_usuario_lista = z.nm_usuario_des
							and	y.nr_seq_fila = c.nr_sequencia
							and	z.nr_seq_skill = x.nr_seq_skill)  LIMIT 1;
					exception
					when others then
						ie_tipo_prev_w	:= 'SEC';
					end;
				end;
			end;
		end if;
		
		if (ie_tipo_prev_w = 'OK') then
			select	coalesce(max('ERR'),'OK')
			into STRICT	ie_tipo_prev_w
			from (	SELECT	1
				from	man_ordem_servico_v a,
					man_ordem_servico_exec b
				where	a.nr_sequencia = b.nr_seq_ordem
				and	b.nm_usuario in (select coalesce(x.nm_usuario_fila,'X') from cadastro_fila x)
				and	coalesce(b.dt_fim_execucao::text, '') = ''
				and	a.nr_sequencia = nr_seq_ordem_serv_w
				GROUP BY	b.nr_seq_ordem) alias6;
		end if;
		
		if (ie_tipo_prev_w <> 'OK' HAVING	count(*) > 1
				) or (nr_seq_estagio_w in (1051, 231)) then
			begin	
			insert into w_resumo_prev_os_item(
				nm_usuario,
				dt_previsao,
				nr_seq_gerencia,
				nr_seq_grupo_des,
				nr_seq_ordem,
				ie_tipo_prev)
			values (nm_usuario_p,
				clock_timestamp(),
				nr_seq_gerencia_w,
				nr_seq_grupo_des_w,
				nr_seq_ordem_serv_w,
				ie_tipo_prev_w);
			exception
			when others then
				null;
			end;
		end if;
		end;
	end if;
	
	if (coalesce(ie_nao_lida_w,'N') = 'S') then
		begin
		ie_novo_hist_w := substr(coalesce(man_obter_se_novo_hist(nr_seq_ordem_serv_w, nm_usuario_p),'N'),1,1);

		if (ie_novo_hist_w = 'S') then
			begin	
			insert into w_resumo_prev_os_item(
				nm_usuario,
				dt_previsao,
				nr_seq_gerencia,
				nr_seq_grupo_des,
				nr_seq_ordem,
				ie_tipo_prev)
			values (nm_usuario_p,
				clock_timestamp(),
				nr_seq_gerencia_w,
				nr_seq_grupo_des_w,
				nr_seq_ordem_serv_w,
				'NH');
			exception
			when others then
				null;
			end;
		end if;
		end;
	end if;
	
	if (coalesce(ie_em_execucao_p,'N') = 'S') then
		begin
		
		begin
		select	'EEX'
		into STRICT	ie_tipo_prev_w
		from	man_ordem_serv_ativ y,
			man_ordem_ativ_prev x
		where	x.nr_seq_ordem_serv = nr_seq_ordem_serv_w
		and	x.nr_sequencia	= y.nr_seq_ativ_prev
		and	trunc(x.dt_prevista)	= trunc(clock_timestamp())
		and	trunc(y.dt_atividade)	= trunc(clock_timestamp())
		and	coalesce(y.dt_fim_atividade::text, '') = ''  LIMIT 1;
		exception
		when others then
			ie_tipo_prev_w := 'OK';
		end;
		
		if (ie_tipo_prev_w = 'EEX') then
			begin	
			insert into w_resumo_prev_os_item(
				nm_usuario,
				dt_previsao,
				nr_seq_gerencia,
				nr_seq_grupo_des,
				nr_seq_ordem,
				ie_tipo_prev)
			values (nm_usuario_p,
				clock_timestamp(),
				nr_seq_gerencia_w,
				nr_seq_grupo_des_w,
				nr_seq_ordem_serv_w,
				'EEX');
			exception
			when others then
				null;
			end;
		end if;
		end;
	end if;
	end;
end loop;
close c01;

if (coalesce(nr_seq_ordem_serv_p,0) > 0) then
	begin
	select	'OK'
	into STRICT	ie_tipo_prev_w
	from	w_resumo_prev_os_item
	where	nm_usuario	= nm_usuario_p
	and	nr_seq_ordem	= nr_seq_ordem_serv_p  LIMIT 1;
	exception
	when others then
		begin
		insert into w_resumo_prev_os_item(
			nm_usuario,
			dt_previsao,
			nr_seq_gerencia,
			nr_seq_grupo_des,
			nr_seq_ordem,
			ie_tipo_prev)
		values (nm_usuario_p,
			clock_timestamp(),
			nr_seq_gerencia_w,
			nr_seq_grupo_des_w,
			nr_seq_ordem_serv_p,
			'CNS');
		exception
		when others then
			null;
		end;
	end;
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE des_gerar_pendencia_analise ( nr_seq_gerencia_p bigint, nr_seq_grupo_des_p bigint, nr_seq_ordem_serv_p bigint, ie_pendencia_triagem_p text default 'S', ie_nao_lida_p text default 'N', ie_em_execucao_p text default 'N', nm_usuario_p text DEFAULT NULL, nm_usuario_lider_p text DEFAULT NULL, ie_somente_sla_p text default 'N') FROM PUBLIC;

