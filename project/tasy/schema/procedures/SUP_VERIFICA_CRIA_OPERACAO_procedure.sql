-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE sup_verifica_cria_operacao ( cd_estabelecimento_p bigint, ie_tipo_virada_p bigint, nm_usuario_p text, cd_operacao_p INOUT bigint) AS $body$
DECLARE


/*ie_tipo_virada_p
0	Saldo normal
1	Saldo consignado
5	Consumo entrada
55	Consumo saida
6	Ajuste de custo medio
7	Ajuste custo medio consignado
11	Entrada unitarizacao
12	Saida unitarizacao
13	Transferencia Unitarizacao - Saida
14	Transferencia Unitarizacao - Entrada
15	Inventario Normal - Entrada
16	Inventario Normal - Saida
17	Inventario Consignado - Entrada
18	Inventario Consignado - Saida
*/
cd_operacao_estoque_w		smallint;


BEGIN

if (ie_tipo_virada_p = 0) then
	begin

	select	coalesce(max(cd_operacao_estoque), 0)
	into STRICT	cd_operacao_estoque_w
	from	operacao_estoque
	where	ie_entrada_saida	= 'E'
	and	ie_atualiza_estoque	= 'S'
	and	ie_tipo_requisicao	= '90'
	and	ie_situacao		= 'A'
	and	ie_altera_custo		= 'S'
	and	ie_consumo		= 'N'
	and	ie_consignado		= '0';

	if (cd_operacao_estoque_w = 0) then
		begin

		select	coalesce(max(cd_operacao_estoque), 0) + 1
		into STRICT	cd_operacao_estoque_w
		from	operacao_estoque;

		insert into operacao_estoque(
			cd_operacao_estoque,
			ds_operacao,
			ie_entrada_saida,
			ie_permite_digitacao,
			ie_atualiza_estoque,
			ie_tipo_requisicao,
			ie_situacao,
			dt_atualizacao,
			nm_usuario,
			ie_altera_custo,
			ie_consumo,
			ie_consignado,
			ie_coluna_resumo,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			ie_desconsidera_cons_ressup,
			ie_desconsidera_cons_padrao)
		values ( cd_operacao_estoque_w,
			wheb_mensagem_pck.get_texto(310511),--'Implantacao inicial saldo de estoque',
			'E',
			'S',
			'S',
			'90',
			'A',
			clock_timestamp(),
			nm_usuario_p,
			'S',
			'N',
			'0',
			'C',
			clock_timestamp(),
			nm_usuario_p,
			'N',
			'N');
		commit;
		end;
	end if;
	end;
elsif (ie_tipo_virada_p in (1, 9)) then
	begin

	select	coalesce(max(cd_operacao_estoque), 0)
	into STRICT	cd_operacao_estoque_w
	from	operacao_estoque
	where	ie_entrada_saida	= 'E'
	and	ie_atualiza_estoque	= 'N'
	and	ie_tipo_requisicao	= '90'
	and	ie_situacao		= 'A'
	and	ie_altera_custo		= 'X'
	and	ie_consumo		= 'N'
	and	ie_consignado		= '3';

	if (cd_operacao_estoque_w = 0) then
		begin

		select	coalesce(max(cd_operacao_estoque), 0) + 1
		into STRICT	cd_operacao_estoque_w
		from	operacao_estoque;

		insert into operacao_estoque(
			cd_operacao_estoque,
			ds_operacao,
			ie_entrada_saida,
			ie_permite_digitacao,
			ie_atualiza_estoque,
			ie_tipo_requisicao,
			ie_situacao,
			dt_atualizacao,
			nm_usuario,
			ie_altera_custo,
			ie_consumo,
			ie_consignado,
			ie_coluna_resumo,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			ie_desconsidera_cons_ressup,
			ie_desconsidera_cons_padrao)
		values ( cd_operacao_estoque_w,
			wheb_mensagem_pck.get_texto(310520),--'Implantacao inicial saldo consignado'
			'E',
			'S',
			'N',
			'90',
			'A',
			clock_timestamp(),
			nm_usuario_p,
			'X',
			'N',
			'3',
			'C',
			clock_timestamp(),
			nm_usuario_p,
			'N',
			'N');
		commit;
		end;
	end if;
	end;
elsif (ie_tipo_virada_p = 5) then
	begin

	select	coalesce(max(cd_operacao_estoque), 0)
	into STRICT	cd_operacao_estoque_w
	from	operacao_estoque
	where	ie_entrada_saida	= 'E'
	and	ie_atualiza_estoque	= 'S'
	and	ie_tipo_requisicao	= '91'
	and	ie_situacao		= 'A'
	and	ie_altera_custo		= 'S'
	and	ie_consumo		= 'N'
	and	ie_consignado		= '0';

	if (cd_operacao_estoque_w = 0) then
		begin

		select	coalesce(max(cd_operacao_estoque), 0) + 1
		into STRICT	cd_operacao_estoque_w
		from	operacao_estoque;

		insert into operacao_estoque(
			cd_operacao_estoque,
			ds_operacao,
			ie_entrada_saida,
			ie_permite_digitacao,
			ie_atualiza_estoque,
			ie_tipo_requisicao,
			ie_situacao,
			dt_atualizacao,
			nm_usuario,
			ie_altera_custo,
			ie_consumo,
			ie_consignado,
			ie_coluna_resumo,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			ie_desconsidera_cons_ressup,
			ie_desconsidera_cons_padrao)
		values ( cd_operacao_estoque_w,
			wheb_mensagem_pck.get_texto(310523),--'Implantacao inicial de consumos(Entrada)',
			'E',
			'S',
			'S',
			'91',
			'A',
			clock_timestamp(),
			nm_usuario_p,
			'S',
			'N',
			'0',
			'C',
			clock_timestamp(),
			nm_usuario_p,
			'N',
			'N');
		commit;
		end;
	end if;
	end;
elsif (ie_tipo_virada_p = 55) then
	begin

	select	coalesce(max(cd_operacao_estoque), 0)
	into STRICT	cd_operacao_estoque_w
	from	operacao_estoque
	where	ie_entrada_saida	= 'S'
	and	ie_atualiza_estoque	= 'S'
	and	ie_tipo_requisicao	= '91'
	and	ie_situacao		= 'A'
	and	ie_altera_custo		= 'S'
	and	ie_consumo		= 'A'
	and	ie_consignado		= '0';

	if (cd_operacao_estoque_w = 0) then
		begin

		select	coalesce(max(cd_operacao_estoque), 0) + 1
		into STRICT	cd_operacao_estoque_w
		from	operacao_estoque;

		insert into operacao_estoque(
			cd_operacao_estoque,
			ds_operacao,
			ie_entrada_saida,
			ie_permite_digitacao,
			ie_atualiza_estoque,
			ie_tipo_requisicao,
			ie_situacao,
			dt_atualizacao,
			nm_usuario,
			ie_altera_custo,
			ie_consumo,
			ie_consignado,
			ie_coluna_resumo,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			ie_desconsidera_cons_ressup,
			ie_desconsidera_cons_padrao)
		values ( cd_operacao_estoque_w,
			wheb_mensagem_pck.get_texto(310524),--'Implantacao inicial de consumos(Saida)',
			'S',
			'S',
			'S',
			'91',
			'A',
			clock_timestamp(),
			nm_usuario_p,
			'S',
			'A',
			'0',
			'P',
			clock_timestamp(),
			nm_usuario_p,
			'N',
			'N');
		commit;
		end;
	end if;
	end;
elsif (ie_tipo_virada_p = 6) then
	begin

	select	coalesce(max(cd_oper_ajuste_cm), 0)
	into STRICT	cd_operacao_estoque_w
	from	parametro_estoque
	where	cd_estabelecimento	= cd_estabelecimento_p;

	if (cd_operacao_estoque_w = 0) then
		begin
		select	coalesce(max(cd_operacao_estoque), 0)
		into STRICT	cd_operacao_estoque_w
		from	operacao_estoque
		where	ie_entrada_saida	= 'E'
		and	ie_atualiza_estoque	= 'S'
		and	ie_tipo_requisicao	= '6'
		and	ie_situacao	= 'A'
		and	ie_altera_custo	= 'S'
		and	ie_consumo	= 'N'
		and	ie_consignado	= '0';

		if (cd_operacao_estoque_w = 0) then
			begin

			select	coalesce(max(cd_operacao_estoque), 0) + 1
			into STRICT	cd_operacao_estoque_w
			from	operacao_estoque;

			insert into operacao_estoque(
				cd_operacao_estoque,
				ds_operacao,
				ie_entrada_saida,
				ie_permite_digitacao,
				ie_atualiza_estoque,
				ie_tipo_requisicao,
				ie_situacao,
				dt_atualizacao,
				nm_usuario,
				ie_altera_custo,
				ie_consumo,
				ie_consignado,
				ie_coluna_resumo,
				dt_atualizacao_nrec,
				nm_usuario_nrec,
				ie_desconsidera_cons_ressup,
				ie_desconsidera_cons_padrao)
			values ( cd_operacao_estoque_w,
				wheb_mensagem_pck.get_texto(310525),--'Ajuste custo medio material',
				'E',
				'S',
				'S',
				'6',
				'A',
				clock_timestamp(),
				nm_usuario_p,
				'S',
				'N',
				'0',
				'C',
				clock_timestamp(),
				nm_usuario_p,
				'N',
				'N');

			commit;

			end;
		end if;
		end;
	end if;
	end;
elsif (ie_tipo_virada_p = 7) then
	begin
	select	coalesce(max(cd_oper_ajuste_cm_consig), 0)
	into STRICT	cd_operacao_estoque_w
	from	parametro_estoque
	where	cd_estabelecimento	= cd_estabelecimento_p;

	if (cd_operacao_estoque_w = 0) then
		select	coalesce(max(cd_operacao_estoque), 0)
		into STRICT	cd_operacao_estoque_w
		from	operacao_estoque
		where	ie_entrada_saida	= 'E'
		and	ie_atualiza_estoque	= 'N'
		and	ie_tipo_requisicao	= '6'
		and	ie_situacao	= 'A'
		and	ie_altera_custo	= 'S'
		and	ie_consumo	= 'N'
		and	ie_consignado	= '2';
	end if;

	if (cd_operacao_estoque_w = 0) then
		begin

		select	coalesce(max(cd_operacao_estoque), 0) + 1
		into STRICT	cd_operacao_estoque_w
		from	operacao_estoque;

		insert into operacao_estoque(
			cd_operacao_estoque,
			ds_operacao,
			ie_entrada_saida,
			ie_permite_digitacao,
			ie_atualiza_estoque,
			ie_tipo_requisicao,
			ie_situacao,
			dt_atualizacao,
			nm_usuario,
			ie_altera_custo,
			ie_consumo,
			ie_consignado,
			ie_coluna_resumo,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			ie_desconsidera_cons_ressup,
			ie_desconsidera_cons_padrao)
		values (	cd_operacao_estoque_w,
			wheb_mensagem_pck.get_texto(310526),--'Ajuste custo medio consignado',
			'E',
			'S',
			'N',
			'6',
			'A',
			clock_timestamp(),
			nm_usuario_p,
			'S',
			'N',
			'2',
			'C',
			clock_timestamp(),
			nm_usuario_p,
			'N',
			'N');

		commit;

		end;
	end if;
	end;
elsif (ie_tipo_virada_p = 11) then
	begin
	select	coalesce(max(cd_oper_entr_unitarizacao), 0)
	into STRICT	cd_operacao_estoque_w
	from	parametro_estoque
	where	cd_estabelecimento	= cd_estabelecimento_p;

	if (cd_operacao_estoque_w = 0) then
		select	coalesce(min(cd_operacao_estoque), 0)
		into STRICT	cd_operacao_estoque_w
		from	operacao_estoque
		where	ie_entrada_saida	= 'E'
		and	ie_atualiza_estoque	= 'S'
		and	ie_tipo_requisicao	= '11'
		and	ie_situacao	= 'A'
		and	ie_altera_custo	= 'N'
		and	ie_consumo	= 'N'
		and	coalesce(ie_consignado,'0')	= '0';
	end if;

	if (cd_operacao_estoque_w = 0) then
		begin

		select	coalesce(max(cd_operacao_estoque), 0) + 1
		into STRICT	cd_operacao_estoque_w
		from	operacao_estoque;

		insert into operacao_estoque(
			cd_operacao_estoque,
			ds_operacao,
			ie_entrada_saida,
			ie_permite_digitacao,
			ie_atualiza_estoque,
			ie_tipo_requisicao,
			ie_situacao,
			dt_atualizacao,
			nm_usuario,
			ie_altera_custo,
			ie_consumo,
			ie_consignado,
			ie_coluna_resumo,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			ie_desconsidera_cons_ressup,
			ie_desconsidera_cons_padrao)
		values (	cd_operacao_estoque_w,
			wheb_mensagem_pck.get_texto(310528),--'Entrada unitarizacao',
			'E',
			'S',
			'S',
			'11',
			'A',
			clock_timestamp(),
			nm_usuario_p,
			'N',
			'N',
			'0',
			'A',
			clock_timestamp(),
			nm_usuario_p,
			'N',
			'N');

		commit;

		end;
	end if;
	end;
elsif (ie_tipo_virada_p = 12) then
	begin
	select	coalesce(max(cd_oper_saida_unitarizacao), 0)
	into STRICT	cd_operacao_estoque_w
	from	parametro_estoque
	where	cd_estabelecimento	= cd_estabelecimento_p;

	if (cd_operacao_estoque_w = 0) then
		select	coalesce(min(cd_operacao_estoque), 0)
		into STRICT	cd_operacao_estoque_w
		from	operacao_estoque
		where	ie_entrada_saida	= 'S'
		and	ie_atualiza_estoque	= 'S'
		and	ie_tipo_requisicao	= '11'
		and	ie_situacao	= 'A'
		and	ie_altera_custo	= 'N'
		and	ie_consumo	= 'N'
		and	coalesce(ie_consignado,'0')	= '0';
	end if;

	if (cd_operacao_estoque_w = 0) then
		begin

		select	coalesce(max(cd_operacao_estoque), 0) + 1
		into STRICT	cd_operacao_estoque_w
		from	operacao_estoque;

		insert into operacao_estoque(
			cd_operacao_estoque,
			ds_operacao,
			ie_entrada_saida,
			ie_permite_digitacao,
			ie_atualiza_estoque,
			ie_tipo_requisicao,
			ie_situacao,
			dt_atualizacao,
			nm_usuario,
			ie_altera_custo,
			ie_consumo,
			ie_consignado,
			ie_coluna_resumo,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			ie_desconsidera_cons_ressup,
			ie_desconsidera_cons_padrao)
		values (	cd_operacao_estoque_w,
			wheb_mensagem_pck.get_texto(310530),--'Saida unitarizacao',
			'S',
			'S',
			'S',
			'11',
			'A',
			clock_timestamp(),
			nm_usuario_p,
			'N',
			'N',
			'0',
			'A',
			clock_timestamp(),
			nm_usuario_p,
			'N',
			'N');
		commit;
		end;
	end if;
	end;
elsif (ie_tipo_virada_p = 13) then
	begin
	select	coalesce(min(cd_operacao_estoque),0)
	into STRICT	cd_operacao_estoque_w
	from	operacao_estoque
	where	ie_situacao = 'A'
	and	coalesce(ie_consignado,'0') = '0'
	and	ie_tipo_requisicao = '21'
	and	ie_entrada_saida = 'S'
	and	ie_atualiza_estoque = 'S';

	if (cd_operacao_estoque_w = 0) then
		begin
		select	coalesce(max(cd_operacao_estoque), 0) + 1
		into STRICT	cd_operacao_estoque_w
		from	operacao_estoque;

		insert into operacao_estoque(
			cd_operacao_estoque,
			ds_operacao,
			ie_entrada_saida,
			ie_permite_digitacao,
			ie_atualiza_estoque,
			ie_tipo_requisicao,
			ie_situacao,
			dt_atualizacao,
			nm_usuario,
			ie_altera_custo,
			ie_consumo,
			ie_consignado,
			ie_coluna_resumo,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			ie_desconsidera_cons_ressup,
			ie_desconsidera_cons_padrao)
		values (	cd_operacao_estoque_w,
			wheb_mensagem_pck.get_texto(310533),--'Transferencia unitarizacao - Saida',
			'S',
			'N',
			'S',
			'21',
			'A',
			clock_timestamp(),
			nm_usuario_p,
			'N',
			'N',
			'0',
			'D',
			clock_timestamp(),
			nm_usuario_p,
			'N',
			'N');
		commit;
		end;
	end if;
	end;
elsif (ie_tipo_virada_p = 14) then
	begin
	select	coalesce(min(cd_operacao_estoque),0)
	into STRICT	cd_operacao_estoque_w
	from	operacao_estoque
	where	ie_situacao = 'A'
	and	coalesce(ie_consignado,'0') = '0'
	and	ie_tipo_requisicao = '21'
	and	ie_entrada_saida = 'E'
	and	ie_atualiza_estoque = 'S';

	if (cd_operacao_estoque_w = 0) then
		begin
		select	coalesce(max(cd_operacao_estoque), 0) + 1
		into STRICT	cd_operacao_estoque_w
		from	operacao_estoque;

		insert into operacao_estoque(
			cd_operacao_estoque,
			ds_operacao,
			ie_entrada_saida,
			ie_permite_digitacao,
			ie_atualiza_estoque,
			ie_tipo_requisicao,
			ie_situacao,
			dt_atualizacao,
			nm_usuario,
			ie_altera_custo,
			ie_consumo,
			ie_consignado,
			ie_coluna_resumo,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			ie_desconsidera_cons_ressup,
			ie_desconsidera_cons_padrao)
		values (	cd_operacao_estoque_w,
			wheb_mensagem_pck.get_texto(310534),--'Transferencia unitarizacao - Entrada',
			'E',
			'N',
			'S',
			'21',
			'A',
			clock_timestamp(),
			nm_usuario_p,
			'N',
			'N',
			'0',
			'A',
			clock_timestamp(),
			nm_usuario_p,
			'N',
			'N');
		commit;
		end;
	end if;
	end;
elsif (ie_tipo_virada_p = 15) then	
	select	min(cd_operacao_estoque)
	into STRICT	cd_operacao_estoque_w
	from	operacao_estoque
	where	ie_tipo_requisicao	= 5
	and	ie_entrada_saida	= 'E'
	and	ie_consignado	= '0'
	and	ie_situacao	= 'A';	
elsif (ie_tipo_virada_p = 16) then
	select	min(cd_operacao_estoque)
	into STRICT	cd_operacao_estoque_w
	from	operacao_estoque
	where	ie_tipo_requisicao	= 5
	and	ie_entrada_saida	= 'S'
	and	ie_consignado	= '0'
	and	ie_situacao	= 'A';	
elsif (ie_tipo_virada_p = 17) then
	select	min(cd_operacao_estoque)
	into STRICT	cd_operacao_estoque_w
	from	operacao_estoque
	where	ie_tipo_requisicao	= 5
	and	ie_entrada_saida 	= 'E'
	and	ie_consignado 		= '7'
	and	ie_situacao 		= 'A';
elsif (ie_tipo_virada_p = 18) then
	select	min(cd_operacao_estoque)
	into STRICT	cd_operacao_estoque_w
	from	operacao_estoque
	where	ie_tipo_requisicao	= 5
	and	ie_entrada_saida 	= 'S'
	and	ie_consignado 		= '7'
	and	ie_situacao 		= 'A';
end if;

cd_operacao_p	:= cd_operacao_estoque_w;


end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE sup_verifica_cria_operacao ( cd_estabelecimento_p bigint, ie_tipo_virada_p bigint, nm_usuario_p text, cd_operacao_p INOUT bigint) FROM PUBLIC;

