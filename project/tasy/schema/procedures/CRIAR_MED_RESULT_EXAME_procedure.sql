-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE criar_med_result_exame (nr_seq_cliente_p bigint, nm_usuario_p text) AS $body$
DECLARE



cd_medico_w			varchar(10);
dt_exame_w			timestamp;
ds_atributos_w		varchar(10000) := '';
ds_comando_w		varchar(1000);
nr_seq_exame_w		bigint;
vl_exame_w			varchar(100);
ds_valor_exame_w		varchar(255);
nm_atributo_w		varchar(30);
qt_decimais_w		integer;
ds_sep_bv_w		varchar(50);
ie_valido_w		varchar(1);
nr_prescricao_w		bigint;
nr_seq_prescricao_w	bigint;

c01 CURSOR FOR
	SELECT	trunc(dt_exame)
	from	med_result_exame
	where	nr_seq_cliente	= nr_seq_cliente_p
	group 	by trunc(dt_exame)
	order 	by 1 desc;

c02 CURSOR FOR
	SELECT	a.nr_seq_exame,
		substr(campo_mascara(a.vl_exame, coalesce(b.qt_decimais,0)),1,50),
		substr(a.ds_valor_exame,1,50),
		'DIA_' || to_char(a.dt_exame, 'ddmmyyyy'),
		coalesce(b.qt_decimais,0),
		ie_valido
	from	med_result_exame a, med_exame_padrao b
	where	a.nr_seq_exame		= b.nr_sequencia
	and	a.nr_seq_cliente 	= nr_seq_cliente_p;


BEGIN
ds_sep_bv_w := obter_separador_bv;

select	cd_medico
into STRICT	cd_medico_w
from	med_cliente
where	nr_sequencia	= nr_seq_cliente_p;


CALL exec_sql_dinamico('TASY', ' drop table w_med_res_ex_' || replace(nm_usuario_p,' ',''));


open	c01;
loop
fetch	c01 into dt_exame_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	ds_atributos_w	:= ds_atributos_w || ' DIA_' || to_char(dt_exame_w,'ddmmyyyy') ||' VARCHAR2(50),';
end loop;
close c01;

CALL exec_sql_dinamico('TASY', ' create table w_med_res_ex_' || replace(nm_usuario_p,' ','') ||
			  ' (NR_SEQ_EXAME		NUMBER(10,0), 	' ||
			  '  EXAME			VARCHAR2(240), 	' ||
			  '  IE_FORMATO_RESULTADO	VARCHAR2(01),	' ||
			  '  NR_SEQ_APRESENT		NUMBER(10,0), 	' ||
			  ds_atributos_w ||
			  '  DS_TIPO_RESULTADO		VARCHAR2(4000), ' ||
			  '  IE_VALIDO			VARCHAR2(1),	'||
			  '  DS_VALIDO 			VARCHAR2(4000))	');

CALL exec_sql_dinamico('TASY', ' create index WMEDRES_FK on w_med_res_ex_' || replace(nm_usuario_p,' ','') || ' (NR_SEQ_EXAME) ');

CALL exec_sql_dinamico('TASY', ' delete from w_med_res_ex_' || replace(nm_usuario_p,' ',''));



ds_comando_w  := ' insert into w_med_res_ex_' || replace(nm_usuario_p,' ','') ||
		'	(nr_seq_exame, exame, ie_formato_resultado, nr_seq_apresent, ds_tipo_resultado,ds_valido) ' ||
		' 	(select a.nr_seq_exame, b.ds_exame, b.ie_formato_resultado, b.nr_seq_apresent, ' ||
		' 	substr(obter_tipo_result_exame(a.nr_seq_exame, a.nr_seq_cliente),1,4000), 	'||
		'  	substr(Obter_valido_Exame(a.nr_seq_exame, a.nr_seq_cliente),1,4000) 		'||
        	' 	from med_exame_padrao b, med_result_exame a 						 	'||
        	' 	where a.nr_seq_exame   = b.nr_sequencia and a.nr_seq_aval is null 		'||
        	'   	and a.nr_seq_cliente = :nr_seq_cliente ' ||
        	' 	group by b.ds_exame, a.nr_seq_exame, b.ie_formato_resultado, b.nr_seq_apresent, a.nr_seq_cliente) ';

CALL exec_sql_dinamico_bv('TASY', ds_comando_w, 'nr_seq_cliente='||to_char(nr_seq_cliente_p));


open	c02;
loop
fetch	c02 into nr_seq_exame_w,
		 vl_exame_w,
		 ds_valor_exame_w,
		 nm_atributo_w,
		 qt_decimais_w,
		 ie_valido_w;
EXIT WHEN NOT FOUND; /* apply on c02 */
	begin


	if (vl_exame_w IS NOT NULL AND vl_exame_w::text <> '') then
		begin
		ds_comando_w	:=	' update w_med_res_ex_' || replace(nm_usuario_p,' ','') ||
				   	' set '||nm_atributo_w ||' = :vl_exame, ie_valido = :ie_valido ' ||
					' where nr_seq_exame	= :nr_seq_exame';

		CALL exec_sql_dinamico_bv('TASY', ds_comando_w,	'vl_exame='||replace(vl_exame_w,'.',',') ||ds_sep_bv_w ||
								'nr_seq_exame='||to_char(nr_seq_exame_w) ||ds_sep_bv_w ||
								'ie_valido=' || ie_valido_w);

		end;
	end if;

	if (ds_valor_exame_w IS NOT NULL AND ds_valor_exame_w::text <> '') then
		begin
		ds_comando_w	:=	' update w_med_res_ex_' || replace(nm_usuario_p,' ','') ||
				   	' set ' || nm_atributo_w || ' = :ds_valor_exame, ie_valido = :ie_valido' ||
					' where nr_seq_exame	= :nr_seq_exame';

		CALL exec_sql_dinamico_bv('TASY', ds_comando_w, 	'ds_valor_exame='|| ds_valor_exame_w || ds_sep_bv_w ||
								'nr_seq_exame=' ||to_char(nr_seq_exame_w) || ds_sep_bv_w ||
								'ie_valido=' || ie_valido_w);
		end;
	end if;
	end;
end loop;
close c02;


end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE criar_med_result_exame (nr_seq_cliente_p bigint, nm_usuario_p text) FROM PUBLIC;

