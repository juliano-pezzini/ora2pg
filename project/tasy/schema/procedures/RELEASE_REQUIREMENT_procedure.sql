-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE release_requirement ( nr_sequencia_p LATAM_REQUISITO.NR_SEQUENCIA%type, ie_opcao_liberacao_p text DEFAULT 'L') AS $body$
DECLARE

    ie_liberar_desenv_old_w             LATAM_REQUISITO.IE_LIBERAR_DESENV%type;
    ie_liberar_desenv_analista_s        CONSTANT  LATAM_REQUISITO.IE_LIBERAR_DESENV%type := 'H';
    ie_liberar_desenv_consultor_s       CONSTANT  LATAM_REQUISITO.IE_LIBERAR_DESENV%type := 'K';
    nm_usuario_s                        CONSTANT  LATAM_REQUISITO_HISTORICO.NM_USUARIO%TYPE     := WHEB_USUARIO_PCK.GET_NM_USUARIO;
    dt_atual_s                          CONSTANT  LATAM_REQUISITO_HISTORICO.DT_ATUALIZACAO%TYPE := clock_timestamp();
    ie_opcao_liberar_s                  CONSTANT  varchar(1) := 'L';
    cd_expressao_liberar_s              CONSTANT  DIC_EXPRESSAO.CD_EXPRESSAO%TYPE := '1065772';
    cd_expressao_desfazer_lib_s         CONSTANT  DIC_EXPRESSAO.CD_EXPRESSAO%TYPE := '1065760';

BEGIN

IF (nr_sequencia_p IS NOT NULL AND nr_sequencia_p::text <> '') THEN
    SELECT IE_LIBERAR_DESENV
    INTO STRICT   ie_liberar_desenv_old_w
    FROM   LATAM_REQUISITO
    WHERE  NR_SEQUENCIA = nr_sequencia_p;

    UPDATE  LATAM_REQUISITO
    SET     DT_LIBERACAO_CONSULT = CASE WHEN ie_opcao_liberacao_p=ie_opcao_liberar_s THEN  dt_atual_s  ELSE NULL END ,
            IE_LIBERAR_DESENV =  CASE WHEN ie_opcao_liberacao_p=ie_opcao_liberar_s THEN  ie_liberar_desenv_analista_s  ELSE ie_liberar_desenv_consultor_s END ,
            NM_USUARIO        = nm_usuario_s,
            DT_ATUALIZACAO    = dt_atual_s
    WHERE   NR_SEQUENCIA = nr_sequencia_p;

    CALL generate_latam_log(nr_sequencia_p, ie_liberar_desenv_old_w, CASE WHEN ie_opcao_liberacao_p = ie_opcao_liberar_s
                                                                    THEN cd_expressao_liberar_s
                                                                    ELSE cd_expressao_desfazer_lib_s
                                                                END);
    COMMIT;
END IF;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE release_requirement ( nr_sequencia_p LATAM_REQUISITO.NR_SEQUENCIA%type, ie_opcao_liberacao_p text DEFAULT 'L') FROM PUBLIC;

