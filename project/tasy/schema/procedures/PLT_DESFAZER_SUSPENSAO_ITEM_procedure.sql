-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE plt_desfazer_suspensao_item ( nr_prescricao_p bigint, nr_sequencia_p bigint, nm_tabela_p text, dt_suspensao_p timestamp, nm_usuario_p text) AS $body$
DECLARE


ie_agrupador_w			smallint;
nr_agrupamento_w		double precision;
nr_sequencia_w			integer;
nr_seq_dieta_hor_w		bigint;
cd_estabelecimento_w		smallint;
cd_item_w			varchar(15);
ie_ctrl_glic_w			varchar(15);
nr_seq_solic_sangue_w		bigint;
nr_seq_derivado_w		bigint;
ie_se_necessario_w		varchar(1);
ie_acm_w			varchar(2);
Ie_susp_futuro_w		varchar(1);
ie_cancelar_laudo_suspensao_w	varchar(10);
dt_horario_w			timestamp;
nr_seq_evento_w			bigint;

c01 CURSOR FOR
SELECT	a.nr_sequencia
from	prescr_dieta b,
	prescr_dieta_hor a
where	a.nr_prescricao = b.nr_prescricao
and	a.nr_seq_dieta = b.nr_sequencia
and	(a.dt_suspensao IS NOT NULL AND a.dt_suspensao::text <> '')
and	a.dt_suspensao	>= dt_suspensao_p
and	a.nr_prescricao	= nr_prescricao_p
and	a.nr_seq_dieta	= nr_sequencia_p
and	Obter_se_horario_liberado(a.dt_lib_horario, a.dt_horario) = 'S';

C02 CURSOR FOR
SELECT	nr_sequencia
from	prescr_material
where	nr_prescricao	= nr_prescricao_p
and	ie_agrupador	= 1
and	nr_agrupamento	= nr_agrupamento_w
and	nr_sequencia 	<> nr_sequencia_p;


BEGIN

select	max(cd_estabelecimento)
into STRICT	cd_estabelecimento_w
from	prescr_medica
where	nr_prescricao	= nr_prescricao_p;

Ie_susp_futuro_w := obter_param_usuario(924, 676, Obter_perfil_Ativo, nm_usuario_p, cd_estabelecimento_w, Ie_susp_futuro_w);

select	max(ie_cancelar_laudo_suspensao)
into STRICT	ie_cancelar_laudo_suspensao_w
from	parametro_medico
where	cd_estabelecimento	= cd_estabelecimento_w;

if (upper(nm_tabela_p) = 'PRESCR_MATERIAL') then

	select	coalesce(max(ie_se_necessario), 'N'),
		max(cd_material),
		max(ie_acm)
	into STRICT	ie_se_necessario_w,
		cd_item_w,
		ie_acm_w
	from	prescr_material
	where	nr_prescricao	= nr_prescricao_p
	and	nr_sequencia	= nr_sequencia_p;

	if (ie_se_necessario_w  = 'S') or (ie_acm_w = 'S') then

		select	to_date(to_char(coalesce(dt_inicio_prescr, clock_timestamp()),'dd/mm/yyyy hh24:mi') || ':00','dd/mm/yyyy hh24:mi:ss')
		into STRICT	dt_horario_w
		from	prescr_medica
		where	nr_prescricao = nr_prescricao_p;

		delete	FROM prescr_mat_hor
		where	nr_prescricao	= nr_prescricao_p
		and	nr_seq_material	= nr_sequencia_p
		and	ie_agrupador	= 1
		and	cd_material	= cd_item_w
		and	dt_horario	= dt_horario_w
		and	dt_atualizacao_nrec	>= dt_suspensao_p;

		delete	FROM prescr_mat_hor
		where	nr_prescricao	= nr_prescricao_p
		and	nr_seq_superior	= nr_sequencia_p
		and	dt_horario	= dt_horario_w
		and	dt_atualizacao_nrec	>= dt_suspensao_p;

	end if;

end if;

if (upper(nm_tabela_p) = 'PRESCR_DIETA') then
	update	prescr_dieta
	set	ie_suspenso	= 'N',
		nm_usuario	= nm_usuario_p,
		dt_atualizacao	= clock_timestamp(),
		dt_suspensao	 = NULL,
		nm_usuario_susp	 = NULL,
		ds_motivo_susp   = NULL,
		nr_seq_motivo_susp  = NULL
	where	nr_prescricao	= nr_prescricao_p
	and	nr_sequencia	= nr_sequencia_p
	and	dt_suspensao	>= dt_suspensao_p;

	update	prescr_material
	set	ie_suspenso	= 'N',
		nm_usuario	= nm_usuario_p,
		dt_atualizacao	= clock_timestamp(),
		dt_suspensao	 = NULL,
		nm_usuario_susp	 = NULL,
		ds_motivo_susp   = NULL,
		nr_seq_motivo_susp  = NULL
	where	nr_prescricao	= nr_prescricao_p
	and	nr_sequencia_dieta = nr_sequencia_p
	and	dt_suspensao	>= dt_suspensao_p;

	open c01;
	loop
	fetch c01 into
		nr_seq_dieta_hor_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
		UPDATE	prescr_dieta_hor
		SET	dt_suspensao 		 = NULL,
			nm_usuario_susp		 = NULL
		WHERE	nr_sequencia 		= nr_seq_dieta_hor_w;

		delete	FROM prescr_mat_alteracao
		where	nr_seq_horario_dieta	= nr_seq_dieta_hor_w
		and	nr_prescricao		= nr_prescricao_p
		and	ie_alteracao		in (1,12,13,30,31,5)
		and	dt_atualizacao_nrec	>= dt_suspensao_p;
	end loop;
	close c01;

elsif (upper(nm_tabela_p) = 'REP_JEJUM') then
	update	rep_jejum
	set	ie_suspenso	= 'N',
		nm_usuario	= nm_usuario_p,
		dt_atualizacao	= clock_timestamp()
	where	nr_prescricao	= nr_prescricao_p
	and	nr_sequencia	= nr_sequencia_p
	and	dt_atualizacao	>= dt_suspensao_p;

elsif (upper(nm_tabela_p) = 'NUT_PAC') then
	update	NUT_PAC
	set	ie_suspenso	= 'N',
		dt_suspensao	 = NULL,
		nm_usuario	= nm_usuario_p,
		dt_atualizacao	= clock_timestamp()
	where	nr_sequencia	= nr_sequencia_p
	and	dt_suspensao	>= dt_suspensao_p;

	delete	FROM prescr_solucao_evento
	where	nr_prescricao	= nr_prescricao_p
	and	nr_seq_nut_neo	= nr_sequencia_p
	and	ie_alteracao	in (10,24,25,7)
	and	dt_atualizacao_nrec	>= dt_suspensao_p;

elsif (upper(nm_tabela_p) = 'NUT_PACIENTE') then
	update	NUT_PACIENTE
	set	ie_suspenso	= 'N',
		dt_suspensao	 = NULL,
		nm_usuario	= nm_usuario_p,
		dt_atualizacao	= clock_timestamp()
	where	nr_sequencia	= nr_sequencia_p
	and	dt_suspensao	>= dt_suspensao_p;

elsif (upper(nm_tabela_p) = 'PRESCR_SOLUCAO') then

	select	max(nr_sequencia)
	into STRICT	nr_seq_evento_w
	from	prescr_solucao_evento
	where	nr_prescricao	= nr_prescricao_p
	and	nr_seq_solucao	= nr_sequencia_p
	and	dt_atualizacao_nrec	< dt_suspensao_p;

	update	prescr_solucao
	set	ie_suspenso	= 'N',
		nm_usuario	= nm_usuario_p,
		dt_atualizacao	= clock_timestamp(),
		dt_suspensao	 = NULL,
		nm_usuario_susp	 = NULL,
		ds_motivo_susp   = NULL,
		nr_seq_motivo_susp  = NULL,
		nr_seq_evento	= nr_seq_evento_w
	where	nr_prescricao	= nr_prescricao_p
	and	nr_seq_solucao	= nr_sequencia_p
	and	dt_suspensao	>= dt_suspensao_p;

	update	prescr_material
	set	ie_suspenso	= 'N',
		nm_usuario	= nm_usuario_p,
		dt_atualizacao	= clock_timestamp(),
		dt_suspensao	 = NULL,
		nm_usuario_susp	 = NULL,
		ds_motivo_susp   = NULL,
		nr_seq_motivo_susp  = NULL
	where	nr_prescricao	= nr_prescricao_p
	and	nr_sequencia_solucao = nr_sequencia_p
	and	dt_suspensao	>= dt_suspensao_p;

	delete	FROM prescr_solucao_evento
	where	nr_prescricao	= nr_prescricao_p
	and	nr_seq_solucao	= nr_sequencia_p
	and	ie_alteracao	in (10,24,25,7)
	and	dt_atualizacao_nrec	>= dt_suspensao_p;

elsif (upper(nm_tabela_p) = 'PRESCR_GASOTERAPIA') then
	update	prescr_gasoterapia
	set	ie_suspenso	= 'N',
		dt_suspensao	 = NULL,
		nm_usuario	= nm_usuario_p,
		dt_atualizacao	= clock_timestamp()
	where	nr_prescricao	= nr_prescricao_p
	and	nr_sequencia	= nr_sequencia_p
	and	dt_suspensao	>= dt_suspensao_p;

	delete	FROM prescr_gasoterapia_evento
	where	nr_seq_gasoterapia	= nr_sequencia_p
	and	((ie_evento		= 'S') or (ie_evento		= 'SM') or (ie_evento		= 'SS'))
	and	dt_atualizacao_nrec	>= dt_suspensao_p;

elsif (upper(nm_tabela_p) = 'PRESCR_PROCEDIMENTO') then

	update	prescr_procedimento
	set	ie_suspenso		= 'N',
		nm_usuario		= nm_usuario_p,
		dt_atualizacao		= clock_timestamp(),
		dt_suspensao		 = NULL,
		ds_motivo_susp  	 = NULL,
		cd_motivo_suspensao	 = NULL,
		nm_usuario_susp		 = NULL
	where	nr_prescricao		= nr_prescricao_p
	and	nr_sequencia		= nr_sequencia_p
	and	dt_suspensao		>= dt_suspensao_p;

	update	prescr_procedimento
	set	ie_suspenso		= 'N',
		nm_usuario		= nm_usuario_p,
		dt_atualizacao		= clock_timestamp(),
		dt_suspensao		 = NULL,
		ds_motivo_susp  	 = NULL,
		cd_motivo_suspensao	 = NULL,
		nm_usuario_susp		 = NULL
	where	nr_prescricao		= nr_prescricao_p
	and	nr_seq_origem		= nr_sequencia_p
	and	(nr_seq_origem IS NOT NULL AND nr_seq_origem::text <> '')
	and	dt_suspensao		>= dt_suspensao_p;

	update	prescr_material
	set	ie_suspenso	= 'N',
		nm_usuario	= nm_usuario_p,
		dt_atualizacao	= clock_timestamp(),
		dt_suspensao	 = NULL,
		nm_usuario_susp	 = NULL,
		ds_motivo_susp   = NULL,
		nr_seq_motivo_susp  = NULL
	where	nr_prescricao	= nr_prescricao_p
	and	nr_sequencia_proc = nr_sequencia_p
	and	dt_suspensao	>= dt_suspensao_p;

	if (ie_cancelar_laudo_suspensao_w	= 'S') then
		update	laudo_paciente
		set	dt_cancelamento	 = NULL
		where	nr_prescricao	= nr_prescricao_p
		and	nr_seq_prescricao = nr_sequencia_p
		and	dt_cancelamento	>= dt_suspensao_p;
	end if;

	select	max(coalesce(obter_ctrl_glic_proc(nr_seq_proc_interno),'NC')),
		max(coalesce(nr_seq_solic_sangue,0)),
		max(coalesce(nr_seq_derivado,0))
	into STRICT	ie_ctrl_glic_w,
		nr_seq_solic_sangue_w,
		nr_seq_derivado_w
	from	prescr_procedimento
	where	nr_prescricao = nr_prescricao_p
	and	nr_sequencia = nr_sequencia_p;

	if (nr_seq_solic_sangue_w > 0) and (nr_seq_derivado_w > 0) then

		delete	FROM prescr_solucao_evento
		where	nr_prescricao		= nr_prescricao_p
		and	nr_seq_procedimento	= nr_sequencia_p
		and	ie_alteracao		in (10,24,25,7)
		and	dt_atualizacao_nrec	>= dt_suspensao_p;

	elsif (ie_ctrl_glic_w = 'NC') then

		delete	FROM prescr_mat_alteracao
		where	nr_seq_procedimento	= nr_sequencia_p
		and	nr_prescricao		= nr_prescricao_p
		and	ie_alteracao		in (1,12,13,30,31,5)
		and	dt_atualizacao_nrec	>= dt_suspensao_p;

	elsif (ie_ctrl_glic_w = 'CIG') or (ie_ctrl_glic_w = 'CCG') then

		update	atend_glicemia
		set	ie_status_glic	= 'N'
		where	nr_prescricao	= nr_prescricao_p
		and	nr_seq_procedimento = nr_sequencia_p
		and	dt_atualizacao	>= dt_suspensao_p;

		delete	FROM prescr_mat_alteracao
		where	nr_seq_procedimento	= nr_sequencia_p
		and	nr_prescricao	= nr_prescricao_p
		and	ie_alteracao	in (1,12,13,30,31,5)
		and	dt_atualizacao_nrec	>= dt_suspensao_p;

	end if;

elsif (upper(nm_tabela_p) = 'PRESCR_RECOMENDACAO') then
	update	prescr_recomendacao
	set	ie_suspenso	= 'N',
		nm_usuario	= nm_usuario_p,
		dt_atualizacao	= clock_timestamp(),
		dt_suspensao	 = NULL,
		nm_usuario_susp	 = NULL,
		ds_motivo_susp   = NULL,
		nr_seq_motivo_susp  = NULL
	where	nr_prescricao	= nr_prescricao_p
	and	nr_sequencia	= nr_sequencia_p
	and	dt_suspensao	>= dt_suspensao_p;

	update	prescr_material
	set	ie_suspenso	= 'N',
		dt_suspensao	 = NULL,
		nm_usuario_susp	 = NULL,
		dt_atualizacao	= clock_timestamp(),
		nm_usuario	= nm_usuario_p,
		ds_motivo_susp   = NULL,
		nr_seq_motivo_susp  = NULL
	where	nr_prescricao	= nr_prescricao_p
	and	nr_seq_recomendacao	= nr_sequencia_p
	and	dt_suspensao	>= dt_suspensao_p;

	update	prescr_rec_hor
	set	dt_suspensao	 = NULL,
		nm_usuario_susp  = NULL
	where	nr_prescricao	= nr_prescricao_p
	and	nr_seq_recomendacao = nr_sequencia_p
	and	coalesce(dt_fim_horario::text, '') = ''
	and	dt_suspensao	>= dt_suspensao_p;

	delete	FROM prescr_mat_alteracao
	where	nr_seq_recomendacao	= nr_sequencia_p
	and	nr_prescricao	= nr_prescricao_p
	and	ie_alteracao	in (1,12,13,30,31,5)
	and	dt_atualizacao_nrec	>= dt_suspensao_p;

elsif (upper(nm_tabela_p) = 'PRESCR_MATERIAL') then

	update	prescr_material
	set	ie_suspenso	= 'N',
		nm_usuario	= nm_usuario_p,
		dt_atualizacao	= clock_timestamp(),
		dt_suspensao	 = NULL,
		nm_usuario_susp	 = NULL,
		ds_motivo_susp   = NULL,
		nr_seq_motivo_susp  = NULL
	where	nr_prescricao	= nr_prescricao_p
	and	((nr_sequencia	= nr_sequencia_p) or (nr_sequencia_diluicao = nr_sequencia_p))
	and	dt_suspensao	>= dt_suspensao_p;

	update	prescr_material
	set	ie_suspenso	= 'N',
		dt_suspensao	 = NULL,
		nm_usuario_susp	 = NULL,
		dt_atualizacao	= clock_timestamp(),
		nm_usuario	= nm_usuario_p,
		ds_motivo_susp   = NULL,
		nr_seq_motivo_susp  = NULL
	where	nr_prescricao	= nr_prescricao_p
	and	nr_seq_kit	= nr_sequencia_p
	and	dt_suspensao	>= dt_suspensao_p;

	select	max(ie_agrupador),
		max(nr_agrupamento)
	into STRICT	ie_agrupador_w,
		nr_agrupamento_w
	from	prescr_material
	where	nr_prescricao	= nr_prescricao_p
	and	nr_sequencia	= nr_sequencia_p;

	if (ie_agrupador_w = 1) then
		select	min(nr_sequencia)
		into STRICT	nr_sequencia_w
		from	prescr_material
		where	nr_prescricao	= nr_prescricao_p
		and	nr_agrupamento	= nr_agrupamento_w;

		if (nr_sequencia_w = nr_sequencia_p) then

			open C02;
			loop
			fetch C02 into
				nr_sequencia_w;
			EXIT WHEN NOT FOUND; /* apply on C02 */
				begin
				update	prescr_material
				set	ie_suspenso	= 'N',
					nm_usuario	= nm_usuario_p,
					dt_atualizacao	= clock_timestamp(),
					dt_suspensao	 = NULL,
					nm_usuario_susp	 = NULL,
					ds_motivo_susp   = NULL,
					nr_seq_motivo_susp  = NULL
				where	nr_prescricao	= nr_prescricao_p
				and	nr_sequencia	= nr_sequencia_w
				and	dt_suspensao	>= dt_suspensao_p;

				delete	FROM prescr_mat_alteracao
				where	nr_seq_prescricao	= nr_sequencia_w
				and	nr_prescricao		= nr_prescricao_p
				and	ie_alteracao		in (1,12,13,30,31,5)
				and	dt_atualizacao_nrec	>= dt_suspensao_p;
				end;
			end loop;
			close C02;

		end if;
	end if;

	update	can_ordem_prod a
	set	a.ie_cancelada	= 'N'
	where	coalesce(a.dt_inicio_preparo::text, '') = ''
	and	exists (SELECT	1
			from	can_ordem_item_prescr b
			where	a.nr_sequencia		= b.nr_seq_ordem
			and	b.nr_prescricao		= nr_prescricao_p
			and	b.nr_seq_prescricao	= nr_sequencia_p);

	if (ie_agrupador_w = 8) then
		delete	FROM prescr_solucao_evento
		where	nr_prescricao		= nr_prescricao_p
		and	nr_seq_material		= nr_sequencia_p
		and	ie_alteracao		in (10,24,25,7)
		and	dt_atualizacao_nrec	>= dt_suspensao_p;
	else
		delete	FROM prescr_mat_alteracao
		where	nr_seq_prescricao	= nr_sequencia_p
		and	nr_prescricao		= nr_prescricao_p
		and	ie_alteracao		in (1,12,13,30,31,5)
		and	dt_atualizacao_nrec	>= dt_suspensao_p;
	end if;
end if;

update	prescr_mat_hor
set	dt_suspensao	 = NULL,
	nm_usuario_susp	 = NULL,
	nr_seq_motivo_susp  = NULL,
	ds_motivo_susp	 = NULL
where	nr_prescricao	= nr_prescricao_p
and	dt_suspensao	>= dt_suspensao_p
and	nm_usuario_susp	= nm_usuario_p;

update	prescr_proc_hor
set	dt_suspensao 	 = NULL,
	nm_usuario_susp  = NULL
where	nr_prescricao	= nr_prescricao_p
and	dt_suspensao	>= dt_suspensao_p
and	nm_usuario_susp	= nm_usuario_p;

CALL Atualiza_ie_horario_susp(nr_prescricao_p, nr_sequencia_p, nm_tabela_p);

commit;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE plt_desfazer_suspensao_item ( nr_prescricao_p bigint, nr_sequencia_p bigint, nm_tabela_p text, dt_suspensao_p timestamp, nm_usuario_p text) FROM PUBLIC;

