-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_mat_conta_check_list ( nr_seq_check_list_p bigint, nr_atendimento_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) AS $body$
DECLARE

 
cd_material_w		integer;
cd_convenio_w		integer;
cd_categoria_w		varchar(10);	
nr_seq_Atepacu_w	bigint;
nr_seq_proc_pac_w	bigint;
cd_local_estoque_w	smallint;
cd_setor_atendimento_w	integer;
	
C01 CURSOR FOR 
	SELECT	b.cd_material 
	from	sl_item_check_list b, 
		sl_check_list_unid_item a 
	where	a.nr_seq_checklist		= nr_seq_check_list_p 
	and	a.nr_seq_item_check_list	= b.nr_sequencia 
	and	a.ie_resultado			= 'S' 
	and	(b.cd_material IS NOT NULL AND b.cd_material::text <> '');
					

BEGIN 
 
nr_seq_atepacu_w	:= obter_atepacu_paciente(nr_atendimento_p, 'A');
 
select	cd_setor_Atendimento 
into STRICT	cd_setor_atendimento_w 
from	atend_paciente_unidade 
where	nr_seq_interno	= nr_seq_atepacu_w;
 
cd_local_estoque_w	:= obter_local_estoque_setor(cd_setor_atendimento_w, cd_estabelecimento_p);
 
select	coalesce(max(cd_convenio),0), 
	coalesce(max(cd_categoria),0) 
into STRICT	cd_convenio_w, 
	cd_categoria_w 
from 	Atend_categoria_convenio a 
where	a.nr_atendimento		= nr_atendimento_p 
and	a.dt_inicio_vigencia	= 
		(	SELECT	max(dt_inicio_vigencia) 
			from	Atend_categoria_convenio b 
			where	nr_atendimento		= nr_atendimento_p);
 
open C01;
loop 
fetch C01 into	 
	cd_material_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin 
	nr_seq_proc_pac_w := Inserir_Mat_Conta_Check_List( 
					nr_atendimento_p, cd_material_w, clock_timestamp(), cd_convenio_w, cd_categoria_w, nr_seq_atepacu_w, nm_usuario_p, 1, cd_local_estoque_w, 1, 'N', nr_seq_proc_pac_w);
	 
	CALL atualiza_preco_material(nr_seq_proc_pac_w,nm_usuario_p);
	end;
end loop;
close C01;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_mat_conta_check_list ( nr_seq_check_list_p bigint, nr_atendimento_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) FROM PUBLIC;

