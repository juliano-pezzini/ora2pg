-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE sup_consiste_inv_palm ( nr_seq_inv_p bigint, cd_local_estoque_p bigint default 0, cd_setor_atendimento_p bigint DEFAULT NULL, nm_usuario_p text DEFAULT NULL, cd_estabelecimento_p bigint DEFAULT NULL) AS $body$
DECLARE


qt_existe_w		integer;
ds_retorno_w		varchar(200);
ie_permite_local_adicional_w	varchar(1);

/*Local de estoque do usuário logado no aplicativo*/

cd_local_estoque_w 	integer := 0;


BEGIN

ie_permite_local_adicional_w := Obter_Param_Usuario(88, 211, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_permite_local_adicional_w);

cd_local_estoque_w := coalesce(cd_local_estoque_p,0);

select	count(*)
into STRICT	qt_existe_w
from	inventario
where	nr_sequencia = nr_seq_inv_p;
if (qt_existe_w = 0) then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(217966);
	--R.aise_application_error(-20011,'Este inventário não existe.' || '#@#@');
end if;

select	count(*)
into STRICT	qt_existe_w
from	inventario
where	(dt_bloqueio IS NOT NULL AND dt_bloqueio::text <> '')
and	nr_sequencia = nr_seq_inv_p;
if (qt_existe_w = 0) then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(217967);
	--R.aise_application_error(-20011,'Este inventário não está bloqueado.' || '#@#@');
end if;

select	count(*)
into STRICT	qt_existe_w
from	inventario
where	coalesce(dt_aprovacao::text, '') = ''
and	nr_sequencia = nr_seq_inv_p;
if (qt_existe_w = 0) then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(217968);
	--R.aise_application_error(-20011,'Este inventário já está aprovado.' || '#@#@');
end if;

select	count(*)
into STRICT	qt_existe_w
from	inventario
where	coalesce(dt_atualizacao_saldo::text, '') = ''
and	nr_sequencia = nr_seq_inv_p;
if (qt_existe_w = 0) then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(217969);
	--R.aise_application_error(-20011,'Este inventário já foi atualizado.' || '#@#@');
end if;

if (cd_local_estoque_w > 0) or (ie_permite_local_adicional_w = 'S') then
	if (ie_permite_local_adicional_w = 'S') then
		begin
		select	count(*)
		into STRICT	qt_existe_w
		from	inventario
		where	nr_sequencia = nr_seq_inv_p
		and (cd_local_estoque in (	SELECT  coalesce(cd_local_estoque,0)
						from    setor_local
                                                where   cd_setor_atendimento = cd_setor_atendimento_p) or (cd_local_estoque = cd_local_estoque_p));
		end;
	else
		begin
		select	count(*)
		into STRICT	qt_existe_w
		from	inventario
		where	nr_sequencia = nr_seq_inv_p
		and	cd_local_estoque = cd_local_estoque_p;
		end;
	end if;

	if (qt_existe_w = 0) then
		CALL wheb_mensagem_pck.exibir_mensagem_abort(217970);
		--R.aise_application_error(-20011,'Somente é possível a consulta de inventários para seu local de estoque.' || '#@#@');
	end if;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE sup_consiste_inv_palm ( nr_seq_inv_p bigint, cd_local_estoque_p bigint default 0, cd_setor_atendimento_p bigint DEFAULT NULL, nm_usuario_p text DEFAULT NULL, cd_estabelecimento_p bigint DEFAULT NULL) FROM PUBLIC;

