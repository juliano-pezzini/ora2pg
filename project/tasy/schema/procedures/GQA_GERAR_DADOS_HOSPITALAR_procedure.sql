-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gqa_gerar_dados_hospitalar ( nr_atendimento_p bigint, nr_seq_reg_p bigint, dt_referencia_p timestamp, nm_usuario_p text) AS $body$
DECLARE


ie_uso_resp_w		varchar(1);
dt_uso_resp_w		timestamp;
dt_uso_disp_w		timestamp;
dt_fator_risco_w	timestamp;
dt_fator_risco_CIH_w	timestamp;
dt_proc_rep_w		timestamp;
dt_dialise_proc_w	timestamp;


BEGIN
/*
Ventilação mecânica
Monit. Respiratória Campo respiração (Não pode utilizar a opção espontânea)	*/
select	CASE WHEN max(ie_respiracao)='' THEN 'N'  ELSE 'S' END ,
	max(dt_monitorizacao)
into STRICT	ie_uso_resp_w,
	dt_uso_resp_w
from	atendimento_monit_resp a
where	a.nr_sequencia = (	SELECT	min(x.nr_sequencia)
				from	atendimento_monit_resp x
				where	nr_atendimento = nr_atendimento_p
				and	(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
				and	coalesce(dt_inativacao::text, '') = ''
				and	trunc(dt_monitorizacao) = trunc(dt_referencia_p))
and		a.ie_respiracao <> 'ESPONT';

if (dt_uso_resp_w IS NOT NULL AND dt_uso_resp_w::text <> '') then
	update	w_gestao_sepsis_sofa
	set	dt_uso_resp = dt_uso_resp_w
	where	nr_sequencia = nr_seq_reg_p;

	commit;
end if;

/*	Verificar do item dispositivos   */

select	max(x.dt_instalacao)
into STRICT	dt_uso_disp_w
from	atend_pac_dispositivo x
where	x.nr_sequencia = (	SELECT	min(a.nr_sequencia)
				from	atend_pac_dispositivo a,
					dispositivo b
				where	a.nr_seq_dispositivo = b.nr_sequencia
				and	b.ie_classif_disp_niss = 'VMI'
				and	a.nr_atendimento = nr_atendimento_p
				and	trunc(a.dt_instalacao) = trunc(dt_referencia_p));

if (dt_uso_disp_w IS NOT NULL AND dt_uso_disp_w::text <> '') then
	update	w_gestao_sepsis_sofa
	set	dt_uso_disp = dt_uso_disp_w
	where	nr_sequencia = nr_seq_reg_p;

	commit;
end if;

/*	Função CCIH  itens: Fator de risco (Entubação, Tubo ori traqueal e tudo mais que for ventilação)  */

select	max(a.dt_registro)
into STRICT	dt_fator_risco_w
from	cih_pac_fat_risco a
where	a.nr_sequencia = (	SELECT	min(x.nr_sequencia)
				from	cih_pac_fat_risco x
				where	x.nr_atendimento = nr_atendimento_p
	--			and	x.nr_seq_fator_risco in ()
				and	trunc(x.dt_registro) = trunc(dt_referencia_p));

if (dt_fator_risco_w IS NOT NULL AND dt_fator_risco_w::text <> '') then
	update	w_gestao_sepsis_sofa
	set	dt_fator_risco = dt_fator_risco_w
	where	nr_sequencia = nr_seq_reg_p;

	commit;
end if;

/*	Função REP item: Procedimentos (Codigo da ventilação mecânica  */

select	max(a.dt_prescricao)
into STRICT	dt_proc_rep_w
from	prescr_medica a
where	a.nr_prescricao = (	SELECT	min(x.nr_prescricao)
				from	prescr_procedimento x,
					prescr_medica z
				where	x.nr_prescricao = z.nr_prescricao
				and	z.nr_atendimento = nr_atendimento_p
			--	and	x.cd_procedimento in ()
				and	(z.dt_liberacao_medico IS NOT NULL AND z.dt_liberacao_medico::text <> '')
				and	coalesce(x.dt_suspensao::text, '') = ''
				and	coalesce(z.dt_suspensao::text, '') = ''
				and	trunc(z.dt_prescricao) = trunc(dt_referencia_p));

if (dt_proc_rep_w IS NOT NULL AND dt_proc_rep_w::text <> '') then
	update	w_gestao_sepsis_sofa
	set	dt_proc_rep = dt_proc_rep_w
	where	nr_sequencia = nr_seq_reg_p;

	commit;
end if;

/*	Qualquer vasopressor (noradrenalina ou dopamina ou vasopressina ou adrenalina   */

/*	Terapia de substituição renal
	Diálise  -  REP nas pastas: Diálise, Procedimento (Código diálise)   */
	select	max(a.dt_inicio_dialise)
	into STRICT	dt_dialise_proc_w
	from	hd_prescricao a
	where	a.nr_prescricao = (	SELECT	min(z.nr_prescricao)
					from	prescr_medica z
					where	z.nr_atendimento = nr_atendimento_p
					and	coalesce(z.dt_suspensao::text, '') = ''
					and	(z.dt_liberacao_medico IS NOT NULL AND z.dt_liberacao_medico::text <> '')
					and	trunc(z.dt_prescricao) = trunc(dt_referencia_p));

	if (coalesce(dt_dialise_proc_w::text, '') = '') then
		select	max(a.dt_inicio)
		into STRICT	dt_dialise_proc_w
		from	prescr_procedimento a
		where	a.nr_prescricao = (	SELECT	min(z.nr_prescricao)
						from	prescr_medica z,
							prescr_procedimento x
						where	x.nr_prescricao = z.nr_prescricao
						and	z.nr_atendimento = nr_atendimento_p
					--	and	x.cd_procedimento in ()
						and	coalesce(z.dt_suspensao::text, '') = ''
						and	coalesce(x.dt_suspensao::text, '') = ''
						and	(z.dt_liberacao_medico IS NOT NULL AND z.dt_liberacao_medico::text <> '')
						and	trunc(z.dt_prescricao) = trunc(dt_referencia_p));
	end if;

if (dt_dialise_proc_w IS NOT NULL AND dt_dialise_proc_w::text <> '') then
	update	w_gestao_sepsis_sofa
	set	dt_dialise_proc = dt_dialise_proc_w
	where	nr_sequencia = nr_seq_reg_p;

	commit;

end if;

/*	CIH
	Fator de risco  /  Gestão de insuficiência renal  /  Dispositivos (Cateter diálise)  /  SAE    */
	select	max(a.dt_registro)
	into STRICT	dt_fator_risco_CIH_w
	from	cih_pac_fat_risco a
	where	a.nr_sequencia = (	SELECT	min(x.nr_sequencia)
					from	cih_pac_fat_risco x
					where	x.nr_atendimento = nr_atendimento_p
		--			and	x.nr_seq_fator_risco in ()
					and	trunc(x.dt_registro) = trunc(dt_referencia_p));

if (dt_fator_risco_CIH_w IS NOT NULL AND dt_fator_risco_CIH_w::text <> '') then
	update	w_gestao_sepsis_sofa
	set	dt_fator_risco_CIH = dt_fator_risco_CIH_w
	where	nr_sequencia = nr_seq_reg_p;

	commit;

end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gqa_gerar_dados_hospitalar ( nr_atendimento_p bigint, nr_seq_reg_p bigint, dt_referencia_p timestamp, nm_usuario_p text) FROM PUBLIC;

