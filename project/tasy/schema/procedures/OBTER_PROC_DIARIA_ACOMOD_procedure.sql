-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE obter_proc_diaria_acomod (cd_estabelecimento_p bigint, nr_seq_agenda_p bigint, nr_atendimento_p bigint, cd_procedimento_p INOUT bigint, ie_origem_proced_p INOUT bigint, nr_seq_proc_interno_p INOUT bigint, cd_tipo_acomod_atual_p bigint) AS $body$
DECLARE


cd_convenio_w			bigint;
cd_categoria_w			bigint;
cd_tipo_acomodacao_w		bigint;
ie_clinica_w			bigint;
cd_setor_atendimento_w		bigint;
ie_carater_internacao_w		varchar(10);
nr_seq_classificacao_w		bigint;
ie_origem_proc_conv_w		bigint;
cd_procedimento_w		bigint	:= null;
ie_origem_proced_w		bigint	:= null;
ie_tipo_convenio_w		smallint;
ie_tipo_atendimento_w		smallint;
nr_seq_proc_interno_w		bigint	:= null;
cd_plano_w			varchar(10);
cd_pessoa_fisica_w		varchar(10);
qt_idade_w			double precision;
nr_acompanhante_w		smallint;
ie_sexo_w			varchar(1);
ie_paciente_isolado_w		varchar(1);

c01 CURSOR FOR
SELECT 	cd_procedimento,
	ie_origem_proced,
	nr_seq_proced_int
from 	tipo_acomod_convenio
where	cd_tipo_acomodacao						= coalesce(cd_tipo_acomod_atual_p,cd_tipo_acomodacao_w)
and 	coalesce(cd_convenio, coalesce(cd_convenio_w,0))				= coalesce(cd_convenio_w,0)
and 	coalesce(cd_categoria, coalesce(cd_categoria_w,0))			= coalesce(cd_categoria_w,0)
and	coalesce(cd_plano, coalesce(cd_plano_w,'0'))				= coalesce(cd_plano_w,'0')
and 	coalesce(ie_clinica, coalesce(ie_clinica_w,0))				= coalesce(ie_clinica_w,0)
and 	coalesce(cd_setor_atendimento, coalesce(cd_setor_atendimento_w,0))	= coalesce(cd_setor_atendimento_W,0)
and 	coalesce(ie_carater_internacao, coalesce(ie_carater_internacao_w,0))	= coalesce(ie_carater_internacao_w,0)
and 	coalesce(nr_seq_classificacao, coalesce(nr_seq_classificacao_w,0))	= coalesce(nr_seq_classificacao_w,0)
and 	coalesce(ie_origem_proc_conv, coalesce(ie_origem_proc_conv_w,0)) 		= coalesce(ie_origem_proc_conv_w,0)
and	coalesce(qt_idade_w,0) between coalesce(obter_idade_tipo_acomod_conv(nr_sequencia,'MIN'),0) and coalesce(obter_idade_tipo_acomod_conv(nr_sequencia,'MAX'),9999999)
and	coalesce(nr_acompanhante_w, 0) between coalesce(nr_acomp_inicial, 0) and coalesce(nr_acomp_final, coalesce(nr_acompanhante_w, 0))
and	coalesce(ie_sexo, coalesce(ie_sexo_w, 'I')) = coalesce(ie_sexo_w, 'I')
and	((coalesce(ie_paciente_isolado,'A') = 'A') or (coalesce(ie_paciente_isolado,'A') = ie_paciente_isolado_w))
order by
	coalesce(cd_convenio,0),
	coalesce(cd_categoria,0),
	coalesce(cd_plano,'0'),
	coalesce(ie_clinica,0),
 	coalesce(cd_setor_atendimento,0),
 	coalesce(ie_carater_internacao,0),
 	coalesce(nr_seq_classificacao,0),
	coalesce(ie_origem_proc_conv,0);


BEGIN

if (nr_seq_agenda_p IS NOT NULL AND nr_seq_agenda_p::text <> '') then
	select	max(a.cd_convenio),
		max(a.cd_categoria),
		max(a.cd_tipo_acomodacao),
		null,
		null,
		null,
		max(a.ie_tipo_atendimento),
		max(a.cd_pessoa_fisica)
	into STRICT	cd_convenio_w,
		cd_categoria_w,
		cd_tipo_acomodacao_w,
		ie_clinica_w,
		ie_carater_internacao_w,
		nr_seq_classificacao_w,
		ie_tipo_atendimento_w,
		cd_pessoa_fisica_w
	from 	agenda_paciente a
	where	a.nr_sequencia		= nr_seq_agenda_p;

else
	select	max(b.cd_convenio),
		max(b.cd_categoria),
		max(b.cd_tipo_acomodacao),
		max(a.ie_clinica),
		max(a.ie_carater_inter_sus),
		max(a.nr_seq_classificacao),
		max(a.ie_tipo_atendimento),
		max(b.cd_plano_convenio),
		max(a.cd_pessoa_fisica),
		max(b.nr_acompanhante),
		max(a.ie_paciente_isolado)
	into STRICT	cd_convenio_w,
		cd_categoria_w,
		cd_tipo_acomodacao_w,
		ie_clinica_w,
		ie_carater_internacao_w,
		nr_seq_classificacao_w,
		ie_tipo_atendimento_w,
		cd_plano_w,
		cd_pessoa_fisica_w,
		nr_acompanhante_w,
		ie_paciente_isolado_w
	from 	atendimento_paciente a,
		atend_categoria_convenio b
	where	a.nr_atendimento	= nr_atendimento_p
	and 	a.nr_atendimento	= b.nr_atendimento
	and 	b.nr_seq_interno	= obter_atecaco_atendimento(nr_atendimento_p);
end if;

if (cd_pessoa_fisica_w IS NOT NULL AND cd_pessoa_fisica_w::text <> '') then
	select	coalesce(max(obter_idade(b.dt_nascimento,coalesce(b.dt_obito,clock_timestamp()),'DIA')),0),
		max(ie_sexo)
	into STRICT	qt_idade_w,
		ie_sexo_w
	from	pessoa_fisica b
	where	b.cd_pessoa_fisica = cd_pessoa_fisica_w;
end if;

select 	max(ie_tipo_convenio)
into STRICT	ie_tipo_convenio_w
from 	convenio
where 	cd_convenio = cd_convenio_w;

ie_origem_proc_conv_w	:= Obter_Origem_Proced_Cat(cd_estabelecimento_p, ie_tipo_atendimento_w, ie_tipo_convenio_w, cd_convenio_w, cd_categoria_w);

select 	max(a.cd_setor_atendimento)
into STRICT 	cd_setor_atendimento_w
from 	atend_paciente_unidade a
where	a.nr_atendimento	= nr_atendimento_p
and 	a.nr_seq_interno	= (SELECT 	max(x.nr_seq_interno)
				   from 	atend_paciente_unidade x
				   where 	x.nr_atendimento = nr_atendimento_p);

cd_procedimento_p	:= null;
ie_origem_proced_p	:= null;
nr_seq_proc_interno_p	:= null;

open c01;
loop
fetch c01 into
	cd_procedimento_w,
	ie_origem_proced_w,
	nr_seq_proc_interno_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	if (coalesce(nr_seq_proc_interno_w,0) <> 0) then
		select 	max(cd_procedimento),
			max(ie_origem_proced)
		into STRICT 	cd_procedimento_w,
			ie_origem_proced_w
		from 	proc_interno
		where	nr_sequencia	= nr_seq_proc_interno_w;
	end if;
end loop;
close c01;

if (coalesce(cd_procedimento_w,0) = 0) then
	select 	max(cd_procedimento),
		max(ie_origem_proced),
		max(nr_seq_proced_int)
	into STRICT 	cd_procedimento_w,
		ie_origem_proced_w,
		nr_seq_proc_interno_w
	from 	tipo_acomodacao
	where	cd_tipo_acomodacao	= coalesce(cd_tipo_acomod_atual_p,cd_tipo_acomodacao_w);
end if;

if (coalesce(nr_seq_proc_interno_w,0) <> 0) then
	select 	max(cd_procedimento),
		max(ie_origem_proced)
	into STRICT 	cd_procedimento_w,
		ie_origem_proced_w
	from 	proc_interno
	where	nr_sequencia	= nr_seq_proc_interno_w;
end if;

cd_procedimento_p	:= cd_procedimento_w;
ie_origem_proced_p	:= ie_origem_proced_w;
nr_seq_proc_interno_p	:= nr_seq_proc_interno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE obter_proc_diaria_acomod (cd_estabelecimento_p bigint, nr_seq_agenda_p bigint, nr_atendimento_p bigint, cd_procedimento_p INOUT bigint, ie_origem_proced_p INOUT bigint, nr_seq_proc_interno_p INOUT bigint, cd_tipo_acomod_atual_p bigint) FROM PUBLIC;

