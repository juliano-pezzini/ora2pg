-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE inserir_itens_carta_medica ((nr_seq_carta_p bigint, nm_usuario_p text) is nr_seq_modelo_w carta_medica.nr_seq_modelo%type) RETURNS varchar AS $body$
DECLARE


ds_retorno_w		varchar(50) := '';

	
BEGIN
	
	if (ie_classif_diag_p =  'DPE') then
		ds_retorno_w 	:= 'IE_DIAG_PRINC_EPISODIO';
	elsif (ie_classif_diag_p = 'UBE') then
		ds_retorno_w 	:= 'IE_DIAG_REFERENCIA';
	elsif (ie_classif_diag_p = 'BEH') then
		ds_retorno_w 	:= 'IE_DIAG_TRATAMENTO';		
	elsif (ie_classif_diag_p = 'AUF') then
		ds_retorno_w 	:= 'IE_DIAG_ADMISSAO';		
	elsif (ie_classif_diag_p = 'ENT') then
		ds_retorno_w 	:= 'IE_DIAG_ALTA';		
	elsif (ie_classif_diag_p = 'OPD') then
		ds_retorno_w 	:= 'IE_DIAG_CIRURGIA';		
	elsif (ie_classif_diag_p = 'TOD') then
		ds_retorno_w 	:= 'IE_DIAG_OBITO';		
	elsif (ie_classif_diag_p = 'POD') then
		ds_retorno_w 	:= 'IE_DIAG_PRE_CIR';		
	elsif (ie_classif_diag_p = 'FAC') then
		ds_retorno_w 	:= 'IE_DIAG_PRINC_DEPART';		
	elsif (ie_classif_diag_p = 'BHS') then
		ds_retorno_w 	:= 'IE_DIAG_TRAT_CERT';		
	elsif (ie_classif_diag_p = 'FAL') then
		ds_retorno_w 	:= 'IE_DIAG_CRONICO';	
	elsif (ie_classif_diag_p = 'ASV') then
		ds_retorno_w 	:= 'IE_DIAG_TRAT_ESPECIAL';
	end if;
	
	
	return ds_retorno_w;
	end;	

begin

SQLRestricaoCase := ' and 	nr_atendimento in (select  a.nr_atendimento '||
					' 							from    atendimento_paciente a, episodio_paciente b '||
					'  							where   a.nr_Seq_episodio   = b.nr_Sequencia '||
					'  							and     b.nr_sequencia      = :nr_seq_episodio) ';
					
SQLRestricaoPF := 	' and 	nr_atendimento in (	select  a.nr_atendimento '||
					' 							from    atendimento_paciente a '||
					'  							where   a.cd_pessoa_fisica   = :cd_pessoa_fisica) ';
					
SQLRestricaoAtendimento	:= ' and nr_atendimento = :nr_atendimento ';

select	coalesce((select max(y.dt_atualizacao) from carta_conteudo y where y.nr_seq_carta = coalesce(a.nr_seq_carta_mae,a.nr_sequencia) and coalesce(IE_INCLUIR_AUT, 'N') = 'S'),pkg_date_utils.get_date(1900,1,1)),
		nr_atendimento,
		nr_seq_modelo,
		coalesce(a.nr_seq_carta_mae,a.nr_sequencia),
		(select	max(c.nr_seq_episodio) from	atendimento_paciente c where c.nr_atendimento = a.nr_atendimento),
		nr_cirurgia,
		cd_pessoa_fisica
into STRICT	dt_inicio_carta_w,
		nr_atendimento_w,
		nr_seq_modelo_w,
		nr_seq_carta_mae_w,
		nr_seq_episodio_w,
		nr_cirurgia_w,
		cd_pessoa_fisica_w
from	carta_medica a
where	nr_sequencia = nr_seq_carta_p;

if (coalesce(nr_cirurgia_w,0) > 0) then
		select 	max(dt_inicio_real),
				max(dt_termino)
		into STRICT	dt_cirurgia_w,
				dt_fim_cirurgia_w
		from	cirurgia
		where	nr_cirurgia = nr_cirurgia_w;
end if;

open CRegras;
loop
fetch CRegras into
	cRegras_w;
EXIT WHEN NOT FOUND; /* apply on CRegras */
	begin
	SQLItensInserir 		:= null;
	if ((cRegras_w.ie_secao = const_diagnostico_w)OR (cRegras_w.ie_secao = const_diag_paciente_w)) then
		if (cRegras_w.ie_incluir_inf_adic = 'N') then
			get_texto_conteudo_w := get_text_conteudo(const_diagnostico_w, get_texto_conteudo_w);

			SQLItensInserir := 	'	select	nr_seq_interno, '||
								'      		dt_diagnostico, '||
								get_texto_conteudo_w	||
								'      		null nr_seq_result, '||
								'      		0 nr_seq_result_item '||
								' 	from	diagnostico_doenca a '||
								' 	where	1 = 1 ';
			if (cRegras_w.ie_metodo_busca_info = 'C') then
				SQLItensInserir := 	SQLItensInserir || SQLRestricaoPF;
			elsif (cRegras_w.ie_metodo_busca_info = 'N') then
				SQLItensInserir := 	SQLItensInserir || SQLRestricaoAtendimento;
			else
				SQLItensInserir := 	SQLItensInserir || SQLRestricaoCase;
			end if;
			SQLItensInserir := 	SQLItensInserir ||
								'	and		dt_liberacao is not null '||
								'	and		dt_inativacao is null ';
			if (cRegras_w.ie_todos = 'N') then
				SQLItensInserir := 	SQLItensInserir ||
								' 	and		(:ie_classif_diag = ''XXX'' or a.ie_classificacao_doenca 	= :ie_classif_diag ) ' ||
								' 	and		(:ie_tipo_diagnostico = 0 or a.ie_tipo_diagnostico			=  :ie_tipo_diagnostico ) ';
								
				if (cRegras_w.ie_classificacao_diagnostico <> 'ABC') then
					SQLItensInserir := 	SQLItensInserir ||
								'	and		(('|| obter_atribut_classif_diag(cRegras_w.ie_classificacao_diagnostico) ||' = ''S'') ' ||
								'   or exists (select 1 from diagnostico_doenca_depart b where a.nr_seq_interno = b.nr_seq_interno and b.ie_situacao = ''A'' and '|| obter_atribut_classif_diag(cRegras_w.ie_classificacao_diagnostico) ||' = ''S'')) ';
				end if;
				
			end if;
			SQLItensInserir := 	SQLItensInserir ||
								' 	and		dt_liberacao between :dt_inicial and sysdate ' ||
								'	order by  dt_diagnostico, ie_classificacao_doenca ';

			
			if (cRegras_w.ie_metodo_busca_info = 'C') then
				if (cRegras_w.ie_todos = 'N') then
					open cursor_itens_carta_medica_w for EXECUTE SQLItensInserir using cd_pessoa_fisica_w, cRegras_w.ie_classif_diag, cRegras_w.ie_classif_diag,
																			cRegras_w.ie_tipo_diagnostico, cRegras_w.ie_tipo_diagnostico, dt_inicio_carta_w;
				else
					open cursor_itens_carta_medica_w for EXECUTE SQLItensInserir using cd_pessoa_fisica_w, dt_inicio_carta_w;
				end if;
			elsif (cRegras_w.ie_metodo_busca_info = 'N') then
				if (cRegras_w.ie_todos = 'N') then
					open cursor_itens_carta_medica_w for EXECUTE SQLItensInserir using nr_atendimento_w, cRegras_w.ie_classif_diag, cRegras_w.ie_classif_diag,
																			cRegras_w.ie_tipo_diagnostico, cRegras_w.ie_tipo_diagnostico, dt_inicio_carta_w;
				else
					open cursor_itens_carta_medica_w for EXECUTE SQLItensInserir using nr_atendimento_w, dt_inicio_carta_w;
				end if;
			else
				if (cRegras_w.ie_todos = 'N') then
					open cursor_itens_carta_medica_w for EXECUTE SQLItensInserir using nr_seq_episodio_w, cRegras_w.ie_classif_diag, cRegras_w.ie_classif_diag,
																			cRegras_w.ie_tipo_diagnostico, cRegras_w.ie_tipo_diagnostico, dt_inicio_carta_w;
				else
					open cursor_itens_carta_medica_w for EXECUTE SQLItensInserir using nr_seq_episodio_w, dt_inicio_carta_w;
				end if;
			end if;
		else	
                     get_texto_conteudo_w :=  '  decode(ie_tipo, ''D'', '||chr(39) ||
                                     '      <span id="' ||chr(39)|| '||nr_seq_interno||' ||chr(39)|| '"><b>' ||chr(39)||
                                     '    || obter_desc_info_cid_doenca(cd_doenca,nr_atendimento,dt_diagnostico,'|| chr(39)|| 'DS_CID_COMPLETO' || chr(39)|| ') ||' || chr(39)||
                                     ' - ' ||chr(39)||'||obter_valor_dominio(13,ie_tipo_diagnostico)||' || chr(39) || 
                                     ' - ' ||chr(39)||'||Obter_Valor_Dominio(1758,IE_TIPO_DOENCA)||' || chr(39) ||
                                     ' - ' ||chr(39)||'||Obter_Valor_Dominio(58,IE_CLASSIFICACAO_DOENCA)||' || chr(39) ||                                      
                                     '      </span></b>'|| chr(39)||
                                     ',' || chr(39)|| 
                                     '      <span id="' ||chr(39)|| '||nr_seq_interno||' || chr(39)|| '">' ||chr(39)|| 
                                     '      || decode(DS_TITULO, null, '''', DS_TITULO' || ')||'|| chr(39)|| 
                                     '      </span>'|| chr(39)||
                                     '  )  ds_cid_doenca,';

                    SQLItensInserir := '	select  nr_seq_interno,	'||
					'		dt_diagnostico,	'||
							get_texto_conteudo_w ||
					'			nr_seq_inf_adc nr_seq_result, '||
					'			0 nr_seq_result_item '||
					'	from ( '||
					'		select  a.cd_doenca, '||
                                        '			a.nr_atendimento, '||
					'		max(a.nr_seq_interno) nr_seq_interno, '||
					'		max(a.dt_diagnostico) dt_diagnostico, '||
					'		''D'' ie_tipo, '||
					'		'''' DS_TITULO, '||
					'		null CD_PROFISSIONAL, '||
					'		null nr_seq_inf_adc, '||
                                        '		a.ie_tipo_diagnostico ie_tipo_diagnostico, '||
                                        '               a.ie_classificacao_doenca ie_classificacao_doenca, '||
                                        '               a.ie_tipo_doenca ie_tipo_doenca '||
					'		from    diagnostico_doenca a '||
					'		inner join cid_doenca b on a.cd_doenca = b.cd_doenca_cid '||
					'		where	1 = 1 ';
					if (cRegras_w.ie_metodo_busca_info = 'C') then
						SQLItensInserir := 	SQLItensInserir || '		and	a.nr_atendimento in ( 	select  z.nr_atendimento  '||
																			'						from    atendimento_paciente z  '||
																			'
																			and     z.cd_pessoa_fisica      = :cd_pessoa_fisica)  ';
					
					elsif (cRegras_w.ie_metodo_busca_info = 'N') then
						SQLItensInserir := 	SQLItensInserir || '		and	a.nr_atendimento = :nr_atendimento ';
					else
					SQLItensInserir := 	SQLItensInserir ||
					'		and	a.nr_atendimento in ( 	select  a.nr_atendimento  '||
					'						from    atendimento_paciente a, episodio_paciente b  '||
					'						where   a.nr_Seq_episodio   = b.nr_Sequencia  '||
					'						and     b.nr_sequencia      = :nr_seq_episodio)  ';
					end if;
					SQLItensInserir := 	SQLItensInserir ||
					'		and	a.dt_liberacao is not null  '||
                                        '               and     (case when nvl(a.cd_doenca_superior,a.cd_doenca) = a.cd_doenca then 1 else 2 end) = 1' ||
								'		and		a.dt_inativacao is null ';
			if (cRegras_w.ie_todos = 'N') then
				SQLItensInserir := 	SQLItensInserir ||
								' 	and		(:ie_classif_diag = ''XXX'' or a.ie_classificacao_doenca 	= :ie_classif_diag ) ' ||
								' 	and		(:ie_tipo_diagnostico = 0 or a.ie_tipo_diagnostico			=  :ie_tipo_diagnostico ) ';
								
				if (cRegras_w.ie_classificacao_diagnostico <> 'ABC') then
					SQLItensInserir := 	SQLItensInserir ||
								'	and		(('|| obter_atribut_classif_diag(cRegras_w.ie_classificacao_diagnostico) ||' = ''S'') ' ||
								'   or exists (select 1 from diagnostico_doenca_depart b where a.nr_seq_interno = b.nr_seq_interno and b.ie_situacao = ''A'' and '|| obter_atribut_classif_diag(cRegras_w.ie_classificacao_diagnostico) ||' = ''S'')) ';
				end if;							
			end if;
			SQLItensInserir := 	SQLItensInserir ||
								' 		and		a.dt_liberacao between :dt_inicial and sysdate ';
			SQLItensInserir := 	SQLItensInserir ||
								'		group   by a.CD_DOENCA, '||
                                                                '		        a.nr_atendimento, '||
                                                                '		        a.ie_tipo_diagnostico,  '||
                                                                '                       a.ie_classificacao_doenca, '||
                                                                '                       a.ie_tipo_doenca  '||
								'		union all '||
								'		select	a.cd_doenca, '||
                                                                '			a.nr_atendimento, '||
								'			c.NR_SEQ_DIAG_DOENCA nr_seq_interno, '||
								'			c.DT_REGISTRO dt_diagnostico, '||
								'			''A'' ie_tipo, '||
								'			DS_TITULO, '||
								'			CD_PROFISSIONAL, '||
								'			c.nr_sequencia nr_seq_inf_adc, '||
                                                                '               a.ie_tipo_diagnostico ie_tipo_diagnostico, '||
                                                                '               a.ie_classificacao_doenca ie_classificacao_doenca, '||
                                                                '               a.ie_tipo_doenca ie_tipo_doenca '||
								'		from	diagnostico_doenca a '||
								'		inner join diag_doenca_inf_adic c on c.nr_seq_diag_doenca  = a.nr_seq_interno and c.dt_liberacao is not null and c.dt_inativacao is null and (c.ie_revisado is null or c.ie_revisado <> ''S'') ';
			if (cRegras_w.ie_metodo_busca_info = 'C') then
						SQLItensInserir := 	SQLItensInserir || '		and	a.nr_atendimento in ( 	select  z.nr_atendimento  '||
																			'						from    atendimento_paciente z  '||
																			'						and     z.cd_pessoa_fisica      = :cd_pessoa_fisica)  ';
			elsif (cRegras_w.ie_metodo_busca_info = 'N') then
						SQLItensInserir := 	SQLItensInserir || '		and	a.nr_atendimento = :nr_atendimento ';
				
			else
				SQLItensInserir := 	SQLItensInserir ||
								'		where	a.nr_atendimento in ( 	select  a.nr_atendimento  '||
								'										from    atendimento_paciente a, episodio_paciente b  '||
								'										where   a.nr_Seq_episodio   = b.nr_Sequencia  '||
								'										and     b.nr_sequencia      = :nr_seq_episodio)  ';
			end if;
			if (cRegras_w.ie_todos = 'N') then
				SQLItensInserir := 	SQLItensInserir ||
								' 	and		(:ie_classif_diag = ''XXX'' or a.ie_classificacao_doenca 	= :ie_classif_diag ) ' ||
								' 	and		(:ie_tipo_diagnostico = 0 or a.ie_tipo_diagnostico			=  :ie_tipo_diagnostico ) ';
				if (cRegras_w.ie_classificacao_diagnostico <> 'ABC') then
					SQLItensInserir := 	SQLItensInserir ||
								'	and		(('|| obter_atribut_classif_diag(cRegras_w.ie_classificacao_diagnostico) ||' = ''S'') ' ||
								'   or exists (select 1 from diagnostico_doenca_depart b where a.nr_seq_interno = b.nr_seq_interno and b.ie_situacao = ''A'' and '|| obter_atribut_classif_diag(cRegras_w.ie_classificacao_diagnostico) ||' = ''S'')) ';
				end if;							
			end if;
			SQLItensInserir := 	SQLItensInserir ||
								' 		and		c.dt_liberacao between :dt_inicial and sysdate ';
			SQLItensInserir := 	SQLItensInserir ||
								'		and		  a.dt_liberacao is not null  '||
                                                                '       and     (case when nvl(a.cd_doenca_superior,a.cd_doenca) = a.cd_doenca then 1 else 2 end) = 1' ||
								'		and		  a.dt_inativacao is null) '||
								'	order by nr_seq_interno desc, dt_diagnostico ';
			if (cRegras_w.ie_metodo_busca_info = 'C') then
				if (cRegras_w.ie_todos = 'N') then
					open cursor_itens_carta_medica_w for EXECUTE SQLItensInserir using cd_pessoa_fisica_w, cRegras_w.ie_classif_diag, cRegras_w.ie_classif_diag,
																			cRegras_w.ie_tipo_diagnostico, cRegras_w.ie_tipo_diagnostico, dt_inicio_carta_w,
																			cd_pessoa_fisica_w, cRegras_w.ie_classif_diag, cRegras_w.ie_classif_diag,
																			cRegras_w.ie_tipo_diagnostico, cRegras_w.ie_tipo_diagnostico, dt_inicio_carta_w;
				else
					open cursor_itens_carta_medica_w for EXECUTE SQLItensInserir using cd_pessoa_fisica_w, dt_inicio_carta_w, cd_pessoa_fisica_w, dt_inicio_carta_w;
				end if;
			elsif (cRegras_w.ie_metodo_busca_info = 'N') then
				if (cRegras_w.ie_todos = 'N') then
					open cursor_itens_carta_medica_w for EXECUTE SQLItensInserir using nr_atendimento_w, cRegras_w.ie_classif_diag, cRegras_w.ie_classif_diag,
																			cRegras_w.ie_tipo_diagnostico, cRegras_w.ie_tipo_diagnostico, dt_inicio_carta_w,
																			cd_pessoa_fisica_w, cRegras_w.ie_classif_diag, cRegras_w.ie_classif_diag,
																			cRegras_w.ie_tipo_diagnostico, cRegras_w.ie_tipo_diagnostico, dt_inicio_carta_w;
				else
					open cursor_itens_carta_medica_w for EXECUTE SQLItensInserir using nr_atendimento_w, dt_inicio_carta_w, cd_pessoa_fisica_w, dt_inicio_carta_w;
				end if;
			else
				if (cRegras_w.ie_todos = 'N') then
					open cursor_itens_carta_medica_w for EXECUTE SQLItensInserir using nr_seq_episodio_w, cRegras_w.ie_classif_diag, cRegras_w.ie_classif_diag,
																			cRegras_w.ie_tipo_diagnostico, cRegras_w.ie_tipo_diagnostico, dt_inicio_carta_w,
																			nr_seq_episodio_w, cRegras_w.ie_classif_diag, cRegras_w.ie_classif_diag,
																			cRegras_w.ie_tipo_diagnostico, cRegras_w.ie_tipo_diagnostico, dt_inicio_carta_w;
				else
					open cursor_itens_carta_medica_w for EXECUTE SQLItensInserir using nr_seq_episodio_w, dt_inicio_carta_w, nr_seq_episodio_w, dt_inicio_carta_w;
				end if;
			end if;
		end if;
	elsif (cRegras_w.ie_secao = const_comorbidades_w and cRegras_w.ie_todos = 'S') then
		get_texto_conteudo_w := get_text_conteudo(const_comorbidades_w, get_texto_conteudo_w);

		SQLItensInserir := 	'	select	nr_sequencia, '||
							'			dt_registro, '||
							get_texto_conteudo_w	||
							'      		0 nr_seq_result, '||
							'      		0 nr_seq_result_item '||
							'	from	paciente_antec_clinico ';
		if (cRegras_w.ie_metodo_busca_info = 'C') then
			SQLItensInserir := SQLItensInserir ||
				' 	where	cd_pessoa_fisica = :cd_pessoa_fisica ';
		else
			SQLItensInserir := SQLItensInserir ||
				'	where	cd_pessoa_fisica = obter_pessoa_atendimento(:nr_atendimento,''C'') ';
		end if;
		SQLItensInserir := SQLItensInserir ||
							'	and		dt_liberacao is not null '||
							'	and		dt_inativacao is null '||
							' 	and		dt_liberacao between :dt_inicial and sysdate '||
							'	order by dt_registro desc ';
		open cursor_itens_carta_medica_w for EXECUTE SQLItensInserir using nr_atendimento_w,dt_inicio_carta_w;
	elsif (cRegras_w.ie_secao = const_medicamentos_em_uso_w) then
		get_texto_conteudo_w := get_text_conteudo(const_medicamentos_em_uso_w, get_texto_conteudo_w);

		SQLItensInserir := 	'	select	nr_sequencia, '||
							'			dt_registro, '||
							get_texto_conteudo_w	||
							'      	,	0 nr_seq_result, '||
							'      		0 nr_seq_result_item '||
							' 	from	paciente_medic_uso ';
		if (cRegras_w.ie_metodo_busca_info = 'C') then
			SQLItensInserir := SQLItensInserir ||
				' 	where	cd_pessoa_fisica = :cd_pessoa_fisica ';
		else
			SQLItensInserir := SQLItensInserir ||
				' 	where	cd_pessoa_fisica = obter_pessoa_atendimento(:nr_atendimento,''C'') ';
		end if;
		if (cRegras_w.ie_todos = 'N') then
			SQLItensInserir := SQLItensInserir ||
							' 	and		(:cd_material = 0 or cd_material = :cd_material) '||
							' 	and		(:cd_grupo_material = 0 or obter_estrutura_material(cd_material,''G'') = :cd_grupo_material) '||
							' 	and		(:cd_subgrupo_material = 0 or obter_estrutura_material(cd_material,''S'') = :cd_subgrupo_material) '||
							' 	and		(:cd_classe_material = 0 or obter_estrutura_material(cd_material,''C'') = :cd_classe_material )';
		end if;
		SQLItensInserir :=	SQLItensInserir ||
							'	and 		nr_seq_versao is null '||
							' 	and		dt_liberacao between :dt_inicial and sysdate '||
							'	and		dt_inativacao is null'||
							' 	order by dt_registro desc ';
		if (cRegras_w.ie_metodo_busca_info = 'C') then
			if (cRegras_w.ie_todos = 'N') then
				open cursor_itens_carta_medica_w for EXECUTE SQLItensInserir using cd_pessoa_fisica_w,cRegras_w.cd_material,cRegras_w.cd_material,cRegras_w.cd_grupo_material,cRegras_w.cd_grupo_material,cRegras_w.cd_subgrupo_material,
																		cRegras_w.cd_subgrupo_material,cRegras_w.cd_classe_material,cRegras_w.cd_classe_material,dt_inicio_carta_w;
			else
				open cursor_itens_carta_medica_w for EXECUTE SQLItensInserir using cd_pessoa_fisica_w,dt_inicio_carta_w;
			end if;
		else
			if (cRegras_w.ie_todos = 'N') then
				open cursor_itens_carta_medica_w for EXECUTE SQLItensInserir using nr_atendimento_w,cRegras_w.cd_material,cRegras_w.cd_material,cRegras_w.cd_grupo_material,cRegras_w.cd_grupo_material,cRegras_w.cd_subgrupo_material,
																		cRegras_w.cd_subgrupo_material,cRegras_w.cd_classe_material,cRegras_w.cd_classe_material,dt_inicio_carta_w;
			else
				open cursor_itens_carta_medica_w for EXECUTE SQLItensInserir using nr_atendimento_w,dt_inicio_carta_w;
			end if;
		end if;
	elsif (cRegras_w.ie_secao = const_mk_receitas_w) then
		get_texto_conteudo_w := get_text_conteudo(const_medicamentos_em_uso_w, get_texto_conteudo_w, 'S');

		SQLItensInserir := 	'	select	nr_sequencia, '||
							'			DT_ATUALIZACAO_NREC, '||
							get_texto_conteudo_w	||
							'      	,	0 nr_seq_result, '||
							'      		0 nr_seq_result_item '||
							' 	from	kv_receita_farmacia_item b ';
							if (cRegras_w.ie_metodo_busca_info = 'S' or cRegras_w.ie_metodo_busca_info = 'C') then
								SQLItensInserir := SQLItensInserir || '	where	b.nr_seq_receita in (select	a.nr_sequencia ';
							else
								SQLItensInserir := SQLItensInserir || '	where	b.nr_seq_receita = (select	max(a.nr_sequencia) ';
							end if;
							
							SQLItensInserir := SQLItensInserir ||
							'				  				from	kv_receita_farmacia a '||
							'								where 1 = 1						';
							if (cRegras_w.ie_metodo_busca_info = 'S') then
								SQLItensInserir := SQLItensInserir || SQLRestricaoCase;
							elsif (cRegras_w.ie_metodo_busca_info = 'C') then
								SQLItensInserir := SQLItensInserir || SQLRestricaoPF;
							else
								SQLItensInserir := SQLItensInserir || '	and	a.nr_atendimento = :nr_atendimento ';
							end if;

							SQLItensInserir := SQLItensInserir ||
							'								and		a.dt_liberacao is not null  '||
							'								and		a.dt_inativacao is null ) ';
		if (cRegras_w.ie_todos = 'N') then
			SQLItensInserir := SQLItensInserir ||
							' 	and		(:cd_material = 0 or cd_material = :cd_material) '||
							' 	and		(:cd_grupo_material = 0 or obter_estrutura_material(cd_material,''G'') = :cd_grupo_material) '||
							' 	and		(:cd_subgrupo_material = 0 or obter_estrutura_material(cd_material,''S'') = :cd_subgrupo_material) '||
							' 	and		(:cd_classe_material = 0 or obter_estrutura_material(cd_material,''C'') = :cd_classe_material )';
		end if;
		SQLItensInserir :=	SQLItensInserir ||
							' 	order by DT_ATUALIZACAO_NREC desc ';

		if (cRegras_w.ie_metodo_busca_info = 'S') then
			if (cRegras_w.ie_todos = 'N') then
				open cursor_itens_carta_medica_w for EXECUTE SQLItensInserir using nr_seq_episodio_w,cRegras_w.cd_material,cRegras_w.cd_material,cRegras_w.cd_grupo_material,cRegras_w.cd_grupo_material,cRegras_w.cd_subgrupo_material,
																		cRegras_w.cd_subgrupo_material,cRegras_w.cd_classe_material,cRegras_w.cd_classe_material;
			else
				open cursor_itens_carta_medica_w for EXECUTE SQLItensInserir using nr_seq_episodio_w;
			end if;
		elsif (cRegras_w.ie_metodo_busca_info = 'C') then
			if (cRegras_w.ie_todos = 'N') then
				open cursor_itens_carta_medica_w for EXECUTE SQLItensInserir using cd_pessoa_fisica_w,cRegras_w.cd_material,cRegras_w.cd_material,cRegras_w.cd_grupo_material,cRegras_w.cd_grupo_material,cRegras_w.cd_subgrupo_material,
																		cRegras_w.cd_subgrupo_material,cRegras_w.cd_classe_material,cRegras_w.cd_classe_material;
			else
				open cursor_itens_carta_medica_w for EXECUTE SQLItensInserir using nr_seq_episodio_w;
			end if;
		else
			if (cRegras_w.ie_todos = 'N') then
				open cursor_itens_carta_medica_w for EXECUTE SQLItensInserir using cd_pessoa_fisica_w,cRegras_w.cd_material,cRegras_w.cd_material,cRegras_w.cd_grupo_material,cRegras_w.cd_grupo_material,cRegras_w.cd_subgrupo_material,
																		cRegras_w.cd_subgrupo_material,cRegras_w.cd_classe_material,cRegras_w.cd_classe_material;
			else
				open cursor_itens_carta_medica_w for EXECUTE SQLItensInserir using nr_atendimento_w;
			end if;
		end if;
	elsif (cRegras_w.ie_secao = const_plano_medicamentos_w and cRegras_w.ie_todos = 'S') then
		get_texto_conteudo_w := get_text_conteudo(const_plano_medicamentos_w, get_texto_conteudo_w);

		SQLItensInserir := 	'	select	b.nr_sequencia, '||
							'			b.dt_registro, '||
							get_texto_conteudo_w	||
							'      		0 nr_seq_result, '||
							'      		0 nr_seq_result_item '||
							'	from	PLANO_VERSAO_MEDIC b 	'||
							'	where 	b.nr_seq_versao = (	select	max(a.nr_sequencia) '||
							'								from	plano_versao a ';
							if (cRegras_w.ie_metodo_busca_info = 'C') then
								SQLItensInserir := SQLItensInserir ||  '								where	a.cd_pessoa_fisica = :cd_pessoa_fisica ';
							else
								SQLItensInserir := SQLItensInserir || '								where	a.cd_pessoa_fisica = obter_pessoa_atendimento(:nr_atendimento,''C'') ';
							end if;
							SQLItensInserir := SQLItensInserir ||
							'								and		a.dt_liberacao between :dt_inicial and sysdate '||
							'								and		a.dt_liberacao = (	select max(c.dt_liberacao) '||
							'															from plano_versao c '||
							'															where a.cd_pessoa_fisica = c.cd_pessoa_fisica) ) '||
							'	order by b.dt_registro ';
		
		if (cRegras_w.ie_metodo_busca_info = 'C') then
			open cursor_itens_carta_medica_w for EXECUTE SQLItensInserir using cd_pessoa_fisica_w,dt_inicio_carta_w;
		else
			open cursor_itens_carta_medica_w for EXECUTE SQLItensInserir using nr_atendimento_w,dt_inicio_carta_w;
		end if;
	elsif (cRegras_w.ie_secao = const_epicrise_w) then
		if (cRegras_w.ie_tipo_regra = 'C') then
			SQLItensInserir := 	'	select	cd_evolucao, '||
								'			dt_evolucao, '||
								chr(39)|| ' ' ||chr(39)||
								'      		,0 nr_seq_result, '||
								'      		0 nr_seq_result_item '||
								'	from	evolucao_paciente '||
								'	where 	1 = 1';
								if (cRegras_w.ie_metodo_busca_info = 'S') then
									SQLItensInserir := SQLItensInserir || SQLRestricaoCase;
								elsif (cRegras_w.ie_metodo_busca_info = 'C') then
									SQLItensInserir := SQLItensInserir || SQLRestricaoPF;
								else
									SQLItensInserir := SQLItensInserir || '	and	nr_atendimento = :nr_atendimento ';
								end if;
								
								SQLItensInserir := SQLItensInserir ||
								'	and		dt_liberacao is not null '||
								'	and		dt_inativacao is null '||
								'	and		ie_evolucao_clinica = :ie_evolucao_clinica'||
								' 	and		dt_liberacao between :dt_inicial and sysdate '||
								'	order by dt_evolucao desc ';

			if (cRegras_w.ie_metodo_busca_info = 'S') then
				open cursor_itens_carta_medica_w for EXECUTE SQLItensInserir using nr_seq_episodio_w,cRegras_w.ie_evolucao_clinica,dt_inicio_carta_w;
			elsif (cRegras_w.ie_metodo_busca_info = 'C') then
				open cursor_itens_carta_medica_w for EXECUTE SQLItensInserir using cd_pessoa_fisica_w,cRegras_w.ie_evolucao_clinica,dt_inicio_carta_w;
			else
				open cursor_itens_carta_medica_w for EXECUTE SQLItensInserir using nr_atendimento_w,cRegras_w.ie_evolucao_clinica,dt_inicio_carta_w;
			end if;
		elsif (cRegras_w.ie_tipo_regra = 'M') then
			get_texto_conteudo_w := get_text_conteudo(const_epicrise_w, get_texto_conteudo_w);
			SQLItensInserir := 	'	SELECT  c.nr_sequencia nr_sequencia,'||
								'			a.DT_PRESCRICAO,'||
								get_texto_conteudo_w	||
								',0 nr_seq_result, '||
								'      		0 nr_seq_result_item '||
								'	FROM	prescr_medica a,'||
								'			prescr_material b,'||
								'			cpoe_material c'||
								'	WHERE	a.nr_prescricao = b.nr_prescricao'||
								'	AND		b.nr_seq_mat_cpoe = c.nr_sequencia';
								if (cRegras_w.ie_metodo_busca_info = 'S') then
									SQLItensInserir := SQLItensInserir || ' and 	c.nr_atendimento in (select  a.nr_atendimento '||
																		  ' 							 from    atendimento_paciente a, episodio_paciente b '||
																		  '  							 where   a.nr_Seq_episodio   = b.nr_Sequencia '||
																		  '  							 and     b.nr_sequencia      = :nr_seq_episodio) ';
								elsif (cRegras_w.ie_metodo_busca_info = 'C') then
									SQLItensInserir := SQLItensInserir || ' and 	c.nr_atendimento in (select  a.nr_atendimento '||
																		  ' 							 from    atendimento_paciente a '||
																		  '  							 and     a.cd_pessoa_fisica      = :cd_pessoa_fisica) ';

								else
									SQLItensInserir := SQLItensInserir || '	AND		c.nr_atendimento = :nr_atendimento';
								end if;
								
								SQLItensInserir := SQLItensInserir ||
								' 	and		a.DT_PRESCRICAO between :dt_inicial and sysdate '||
								'	AND		NVL(c.ie_material,''N'') = ''N'' '||
								'	AND		b.ie_agrupador IN (1,4)'||
								'	AND		a.dt_suspensao IS NULL'||
								'	AND		c.DT_LIB_SUSPENSAO IS NULL'||
								' 	and		(:cd_material = 0 or b.cd_material = :cd_material) '||
								' 	and		(:cd_grupo_material = 0 or obter_estrutura_material(b.cd_material,''G'') = :cd_grupo_material) '||
								' 	and		(:cd_subgrupo_material = 0 or obter_estrutura_material(b.cd_material,''S'') = :cd_subgrupo_material) '||
								' 	and		(:cd_classe_material = 0 or obter_estrutura_material(b.cd_material,''C'') = :cd_classe_material )' ||
								'	AND		c.DT_SUSPENSAO IS NULL';
			if (cRegras_w.ie_metodo_busca_info = 'S') then
				open cursor_itens_carta_medica_w for EXECUTE SQLItensInserir using nr_seq_episodio_w,dt_inicio_carta_w,cRegras_w.cd_material,cRegras_w.cd_material,cRegras_w.cd_grupo_material,cRegras_w.cd_grupo_material,cRegras_w.cd_subgrupo_material,
																		cRegras_w.cd_subgrupo_material,cRegras_w.cd_classe_material,cRegras_w.cd_classe_material;
			elsif (cRegras_w.ie_metodo_busca_info = 'C') then
				open cursor_itens_carta_medica_w for EXECUTE SQLItensInserir using cd_pessoa_fisica_w,dt_inicio_carta_w,cRegras_w.cd_material,cRegras_w.cd_material,cRegras_w.cd_grupo_material,cRegras_w.cd_grupo_material,cRegras_w.cd_subgrupo_material,
																		cRegras_w.cd_subgrupo_material,cRegras_w.cd_classe_material,cRegras_w.cd_classe_material;
			
			else
				open cursor_itens_carta_medica_w for EXECUTE SQLItensInserir using nr_atendimento_w,dt_inicio_carta_w,cRegras_w.cd_material,cRegras_w.cd_material,cRegras_w.cd_grupo_material,cRegras_w.cd_grupo_material,cRegras_w.cd_subgrupo_material,
																	cRegras_w.cd_subgrupo_material,cRegras_w.cd_classe_material,cRegras_w.cd_classe_material;
			end if;														
		elsif (cRegras_w.ie_tipo_regra = 'R') then
			SQLItensInserir := 	'	SELECT	c.nr_sequencia nr_seq_cpoe,'||
								'			a.DT_PRESCRICAO,'||
								chr(39) || '<li data-tasy-advancedtexteditor-section="1" class="paragraph" style="margin-left: -0.4095px;" data-tasy-advancedtexteditor-page="1">' || chr(39) || '	||		SUBSTR((select cpoe_obter_desc_recomendacao(c.cd_recomendacao,c.dt_liberacao) from dual),1,255) ||'||	chr(39) || ' </li>   </ul> ' || chr(39) ||
								'			, 0 nr_seq_result, '||
								'      		0 nr_seq_result_item '||
								'	FROM	prescr_medica a, '||
								'			prescr_recomendacao b, '||
								'			cpoe_recomendacao c, '||
								'			tipo_recomendacao d '||
								'	WHERE	a.nr_prescricao = b.nr_prescricao'||
								'	AND		b.nr_seq_rec_cpoe = c.nr_sequencia'||
								'	AND		d.cd_tipo_recomendacao = c.cd_recomendacao ';
								if (cRegras_w.ie_metodo_busca_info = 'S') then
									SQLItensInserir := SQLItensInserir || ' and 	c.nr_atendimento in (select  a.nr_atendimento '||
																		  ' 							 from    atendimento_paciente a, episodio_paciente b '||
																		  '  							 where   a.nr_Seq_episodio   = b.nr_Sequencia '||
																		  '  							 and     b.nr_sequencia      = :nr_seq_episodio) ';
								elsif (cRegras_w.ie_metodo_busca_info = 'C') then
									SQLItensInserir := SQLItensInserir ||	' and 	c.nr_atendimento in (select  a.nr_atendimento '||
																			' 							 from    atendimento_paciente a '||
																			'  							 and     a.cd_pessoa_fisica      = :cd_pessoa_fisica) ';
								else
									SQLItensInserir := SQLItensInserir || '	AND		c.nr_atendimento = :nr_atendimento';
								end if;
								
								SQLItensInserir := SQLItensInserir ||
								' 	and		a.DT_PRESCRICAO between :dt_inicial and sysdate '||
								'	and		(:cd_tipo_recomendacao = 0 or d.cd_tipo_recomendacao = :cd_tipo_recomendacao) '||
								'	and		(:nr_seq_classif_recomendacao = 0 or d.nr_seq_classif = :nr_seq_classif_recomendacao) '||
								'	AND		a.dt_suspensao IS NULL'||
								'	AND		c.DT_LIB_SUSPENSAO IS NULL'||
								'	AND		c.DT_SUSPENSAO IS NULL';
			
			if (cRegras_w.ie_metodo_busca_info = 'S') then
				open cursor_itens_carta_medica_w for EXECUTE SQLItensInserir using nr_seq_episodio_w,dt_inicio_carta_w,
													cRegras_w.cd_tipo_recomendacao,cRegras_w.cd_tipo_recomendacao,cRegras_w.nr_seq_classif_recomendacao,cRegras_w.nr_seq_classif_recomendacao;
			elsif (cRegras_w.ie_metodo_busca_info = 'C') then
				open cursor_itens_carta_medica_w for EXECUTE SQLItensInserir using cd_pessoa_fisica_w,dt_inicio_carta_w,
													cRegras_w.cd_tipo_recomendacao,cRegras_w.cd_tipo_recomendacao,cRegras_w.nr_seq_classif_recomendacao,cRegras_w.nr_seq_classif_recomendacao;
			else
				open cursor_itens_carta_medica_w for EXECUTE SQLItensInserir using nr_atendimento_w,dt_inicio_carta_w,
													cRegras_w.cd_tipo_recomendacao,cRegras_w.cd_tipo_recomendacao,cRegras_w.nr_seq_classif_recomendacao,cRegras_w.nr_seq_classif_recomendacao;
			end if;										
		end if;

	elsif (cRegras_w.ie_secao = const_anamnese_w or cRegras_w.ie_secao = const_notas_clinicas_w) then
		SQLItensInserir := 	'	select	cd_evolucao, '||
							'			dt_evolucao, '||
							chr(39)|| ' ' ||chr(39)||
							'      		,0 nr_seq_result, '||
							'      		0 nr_seq_result_item '||
							'	from	evolucao_paciente ' ||
							'	where 	1 = 1';
							if (cRegras_w.ie_metodo_busca_info = 'S') then
								SQLItensInserir := SQLItensInserir || SQLRestricaoCase;
							elsif (cRegras_w.ie_metodo_busca_info = 'C') then
								SQLItensInserir := SQLItensInserir || SQLRestricaoPF;
							else
								SQLItensInserir := SQLItensInserir || '	and nr_atendimento = :nr_atendimento ';
							end if;							
							SQLItensInserir := SQLItensInserir ||
							'	and		dt_liberacao is not null '||
							'	and		dt_inativacao is null '||
							'	and		ie_evolucao_clinica = :ie_evolucao_clinica'||
							' 	and		dt_liberacao between :dt_inicial and sysdate '||
							'	order by dt_evolucao desc ';

		if (cRegras_w.ie_metodo_busca_info = 'S') then
			open cursor_itens_carta_medica_w for EXECUTE SQLItensInserir using nr_seq_episodio_w,cRegras_w.ie_evolucao_clinica,dt_inicio_carta_w;
		elsif (cRegras_w.ie_metodo_busca_info = 'C') then
			open cursor_itens_carta_medica_w for EXECUTE SQLItensInserir using cd_pessoa_fisica_w,cRegras_w.ie_evolucao_clinica,dt_inicio_carta_w;
		else
			open cursor_itens_carta_medica_w for EXECUTE SQLItensInserir using nr_atendimento_w,cRegras_w.ie_evolucao_clinica,dt_inicio_carta_w;
		end if;
	elsif (cRegras_w.ie_secao = const_alergias_reac_adv_w and cRegras_w.ie_todos = 'S') then
		get_texto_conteudo_w := get_text_conteudo(const_alergias_reac_adv_w, get_texto_conteudo_w);

		SQLItensInserir := 	'	select	nr_sequencia, '||
							'			dt_registro, '||
							get_texto_conteudo_w	||
							'      		,0 nr_seq_result, '||
							'      		0 nr_seq_result_item '||
							'	from	paciente_alergia ';
							if (cRegras_w.ie_metodo_busca_info = 'C') then
								SQLItensInserir := SQLItensInserir ||
									'	where	cd_pessoa_fisica = :cd_pessoa_fisica ';
							else
								SQLItensInserir := SQLItensInserir ||
									'	where	cd_pessoa_fisica = obter_pessoa_atendimento(:nr_atendimento,''C'') ';
							end if;
							SQLItensInserir := SQLItensInserir ||
							'	and		dt_liberacao is not null '||
							'	and		dt_inativacao is null '||
							'	and     ie_nega_alergias = ''N'''||
							' 	and		dt_liberacao between :dt_inicial and sysdate '||
							'	order by dt_registro desc ';
		if (cRegras_w.ie_metodo_busca_info = 'C') then
			open cursor_itens_carta_medica_w for EXECUTE SQLItensInserir using cd_pessoa_fisica_w,dt_inicio_carta_w;
		else
			open cursor_itens_carta_medica_w for EXECUTE SQLItensInserir using nr_atendimento_w,dt_inicio_carta_w;
		end if;
	elsif (cRegras_w.ie_secao = const_cirurgias_w) then
		get_texto_conteudo_w := get_text_conteudo(const_cirurgias_w, get_texto_conteudo_w);

		SQLItensInserir := 	'	select	a.nr_cirurgia, '||
							'			a.dt_inicio_cirurgia, '||
							get_texto_conteudo_w	||
							'      		,0 nr_seq_result, '||
							'      		0 nr_seq_result_item '||
							'	from	cirurgia a '||
							' 	where 	1 = 1';
							if (cRegras_w.ie_metodo_busca_info = 'S') then
								SQLItensInserir := SQLItensInserir || SQLRestricaoCase;
							elsif (cRegras_w.ie_metodo_busca_info = 'C') then
								SQLItensInserir := SQLItensInserir || SQLRestricaoPF;
							else
								SQLItensInserir := SQLItensInserir || '	and	a.nr_atendimento = :nr_atendimento ';
							end if;							
							SQLItensInserir := SQLItensInserir ||
							'	and		a.dt_cancelamento is null '||
							'	and		a.dt_termino is not null ';
		if (cRegras_w.ie_todos = 'N') then
			SQLItensInserir := SQLItensInserir ||
							'	and		(:nr_proc_interno = 0 or a.nr_seq_proc_interno = :nr_proc_interno) ';
		end if;
		SQLItensInserir := 	SQLItensInserir ||
							'	order by a.dt_inicio_cirurgia ';

		if (cRegras_w.ie_metodo_busca_info = 'S') then
			if (cRegras_w.ie_todos = 'N') then
				open cursor_itens_carta_medica_w for EXECUTE SQLItensInserir using nr_seq_episodio_w,cRegras_w.nr_proc_interno,cRegras_w.nr_proc_interno;
			else
				open cursor_itens_carta_medica_w for EXECUTE SQLItensInserir using nr_seq_episodio_w;
			end if;
		elsif (cRegras_w.ie_metodo_busca_info = 'C') then
			if (cRegras_w.ie_todos = 'N') then
				open cursor_itens_carta_medica_w for EXECUTE SQLItensInserir using cd_pessoa_fisica_w,cRegras_w.nr_proc_interno,cRegras_w.nr_proc_interno;
			else
				open cursor_itens_carta_medica_w for EXECUTE SQLItensInserir using cd_pessoa_fisica_w;
			end if;
		else		
			if (cRegras_w.ie_todos = 'N') then
				open cursor_itens_carta_medica_w for EXECUTE SQLItensInserir using nr_atendimento_w,cRegras_w.nr_proc_interno,cRegras_w.nr_proc_interno;
			else
				open cursor_itens_carta_medica_w for EXECUTE SQLItensInserir using nr_atendimento_w;
			end if;
		end if;
		elsif (cRegras_w.ie_secao = const_exames_nao_lab_w) then
		get_texto_conteudo_w := get_text_conteudo(const_exames_nao_lab_w, get_texto_conteudo_w, 'S');

		SQLItensInserir := 		'	select	x.nr_sequencia, '||
								'			c.dt_procedimento, '||
								--get_texto_conteudo_w	||
								chr(39)|| chr(39)||
								'      		,0 nr_seq_result, '||
								'      		0 nr_seq_result_item '||
								'	from   	laudo_paciente_v x, '||
								'			procedimento_paciente c, '||
								'			procedimento b '||
								'	where   x.nr_seq_proc = c.nr_sequencia '||
								'	and    	c.cd_procedimento = b.cd_procedimento '||
								'	and    	c.ie_origem_proced = b.ie_origem_proced '||
								'	and    	x.dt_liberacao is not null '||
								'	and		x.dt_cancelamento is null ';
								if (cRegras_w.ie_metodo_busca_info = 'S') then
									SQLItensInserir := SQLItensInserir || ' and 	c.nr_atendimento in (select  a.nr_atendimento '||
																		  ' 							 from    atendimento_paciente a, episodio_paciente b '||
																		  '  							 where   a.nr_Seq_episodio   = b.nr_Sequencia '||
																		  '  							 and     b.nr_sequencia      = :nr_seq_episodio) ';
								elsif (cRegras_w.ie_metodo_busca_info = 'C') then
									SQLItensInserir := SQLItensInserir || 	' and 	d.nr_atendimento in (	select  a.nr_atendimento '||
																			' 							from    atendimento_paciente a '||
																			'  							where   a.cd_pessoa_fisica   = :cd_pessoa_fisica) ';								
								else
									SQLItensInserir := SQLItensInserir || '	and	c.nr_atendimento = :nr_atendimento ';
								end if;
		if (cRegras_w.ie_todos = 'N') then
			SQLItensInserir := 	SQLItensInserir ||
							'	and		c.nr_seq_proc_interno 		= :nr_proc_interno ';
		end if;

		SQLItensInserir := 	SQLItensInserir ||
							' 	and		NVL(x.dt_exame, obter_dt_exame_externo(x.nr_sequencia)) between :dt_inicial and sysdate '||
							'	order by c.dt_procedimento desc ';

		
		if (cRegras_w.ie_metodo_busca_info = 'S') then
			if (cRegras_w.ie_todos = 'N') then
				open cursor_itens_carta_medica_w for EXECUTE SQLItensInserir using nr_seq_episodio_w,cRegras_w.nr_proc_interno,dt_inicio_carta_w;
			else
				open cursor_itens_carta_medica_w for EXECUTE SQLItensInserir using nr_seq_episodio_w,dt_inicio_carta_w;
			end if;
		elsif (cRegras_w.ie_metodo_busca_info = 'C') then
			if (cRegras_w.ie_todos = 'N') then
				open cursor_itens_carta_medica_w for EXECUTE SQLItensInserir using cd_pessoa_fisica_w,cRegras_w.nr_proc_interno,dt_inicio_carta_w;
			else
				open cursor_itens_carta_medica_w for EXECUTE SQLItensInserir using cd_pessoa_fisica_w,dt_inicio_carta_w;
			end if;
		else
			if (cRegras_w.ie_todos = 'N') then
				open cursor_itens_carta_medica_w for EXECUTE SQLItensInserir using nr_atendimento_w,cRegras_w.nr_proc_interno,dt_inicio_carta_w;
			else
				open cursor_itens_carta_medica_w for EXECUTE SQLItensInserir using nr_atendimento_w,dt_inicio_carta_w;
			end if;
		end if;
	elsif (cRegras_w.ie_secao = const_procedimentos_w) then
		if (cRegras_w.ie_incluir_inf_adic = 'N') then
			get_texto_conteudo_w := get_text_conteudo(const_procedimentos_w, get_texto_conteudo_w);

			SQLItensInserir := 	'	select	nr_sequencia, '||
								'			dt_procedimento, '||
								get_texto_conteudo_w	||
								'      		,0 nr_seq_result, '||
								'      		0 nr_seq_result_item '||
								'	from	procedimento_paciente a '||
								' 	where 	1 = 1';
								if (cRegras_w.ie_metodo_busca_info = 'S') then
									SQLItensInserir := SQLItensInserir || SQLRestricaoCase;
								elsif (cRegras_w.ie_metodo_busca_info = 'C') then
									SQLItensInserir := SQLItensInserir || SQLRestricaoPF;
								else
									SQLItensInserir := SQLItensInserir || '	and	a.nr_atendimento = :nr_atendimento ';
								end if;				
								SQLItensInserir := SQLItensInserir ||
								'   and     exists ' ||
								'   ( ' ||
								'           select 1 ' ||
								'           from   procedimento_pac_medico x ' ||
								'           where  x.nr_seq_propaci = a.nr_sequencia ' ||
								'			and	   dt_inativacao is null'||
								'   ) ';
			if (cRegras_w.ie_todos = 'N') then
				SQLItensInserir := SQLItensInserir ||
								'	and		(:nr_proc_interno = 0 or nr_seq_proc_interno = :nr_proc_interno) ';
			end if;		
			if (cRegras_w.ie_somente_proc_cirurgia = 'S') then
								SQLItensInserir := SQLItensInserir ||
								'   and     exists ' ||
								'   ( ' ||
								'           select 1 ' ||
								'           from   procedimento_pac_medico x ' ||
								'           where  x.nr_seq_propaci = a.nr_sequencia ' ||
								'			and	   x.nr_cirurgia = ' || chr(39)|| nr_cirurgia_w || chr(39) ||
								'			and	   dt_inativacao is null'||
								'   ) ';		
			
			end if;		
			SQLItensInserir := 	SQLItensInserir ||
								' 	and		dt_procedimento between :dt_inicial and sysdate '||
								'	order by dt_procedimento ';
		else
			get_texto_conteudo_w :=
								'  decode(ie_tipo, ''D'', '||chr(39) ||
                                '      <span id="' ||chr(39)|| '||nr_sequencia||' || chr(39)|| '"><b>'|| chr(39) ||
                                '      || (select max(x.cd_procedimento_loc) from procedimento x where x.cd_procedimento = a.cd_procedimento and x.ie_origem_proced = a.ie_origem_proced) ||'|| chr(39)|| ' - ' ||chr(39)||'|| substr(nvl(obter_desc_curta_proc_rotina(nr_seq_proc_interno,cd_procedimento,ie_origem_proced),obter_desc_procedimento(cd_procedimento, ie_origem_proced)),1,150) ||' || chr(39)|| 
                                '      </span></b>'|| chr(39)||
                                ',' || chr(39)|| 
                                '      <span id="' ||chr(39)|| '||nr_sequencia||' || chr(39)|| '">' ||chr(39)|| 
                                '      || decode(DS_TITULO, null, '''', DS_TITULO' || ')||'|| chr(39)|| 
                                '      </span>'|| chr(39)||
                                '  )  ds_procedimento,';

			SQLItensInserir := 	'	select 	a.nr_sequencia, '||
								'			a.dt_procedimento, '||
								get_texto_conteudo_w	||
								'			c.ds_titulo, '||
								'			,0 nr_seq_result, '||
								'			0 nr_seq_result_item '||
								'	from 	procedimento_paciente a, '||
								'			procedimento_pac_medico b, '||
								'			proc_pac_medico_inf_adic c '||
								'	where	b.nr_sequencia = c.nr_seq_proc_pac_med '||
								'	and		b.nr_seq_propaci = a.nr_sequencia '||
								'	and		b.dt_inativacao is null ';
								
		end if;
			
			if (cRegras_w.ie_metodo_busca_info = 'S') then
				if (cRegras_w.ie_todos = 'N') then
					open cursor_itens_carta_medica_w for EXECUTE SQLItensInserir using nr_seq_episodio_w,cRegras_w.nr_proc_interno,cRegras_w.nr_proc_interno,dt_inicio_carta_w;
				else
					open cursor_itens_carta_medica_w for EXECUTE SQLItensInserir using nr_seq_episodio_w,dt_inicio_carta_w;
				end if;
			elsif (cRegras_w.ie_metodo_busca_info = 'C') then
				if (cRegras_w.ie_todos = 'N') then
					open cursor_itens_carta_medica_w for EXECUTE SQLItensInserir using cd_pessoa_fisica_w,cRegras_w.nr_proc_interno,cRegras_w.nr_proc_interno,dt_inicio_carta_w;
				else
					open cursor_itens_carta_medica_w for EXECUTE SQLItensInserir using cd_pessoa_fisica_w,dt_inicio_carta_w;
				end if;
			else
				if (cRegras_w.ie_todos = 'N') then
					open cursor_itens_carta_medica_w for EXECUTE SQLItensInserir using nr_atendimento_w,cRegras_w.nr_proc_interno,cRegras_w.nr_proc_interno,dt_inicio_carta_w;
				else
					open cursor_itens_carta_medica_w for EXECUTE SQLItensInserir using nr_atendimento_w,dt_inicio_carta_w;
				end if;
			end if;
	elsif (cRegras_w.ie_secao = const_laboratorio_w) then
		get_texto_conteudo_w := get_text_conteudo(const_laboratorio_w, get_texto_conteudo_w, 'S');

		SQLItensInserir := 	'	select	0 nr_seq_interno, '||
							'			d.dt_resultado, '||
							get_texto_conteudo_w	||
							'      	,	d.nr_prescricao, '||
							'      		e.nr_seq_prescr '||
							'	from   	exame_lab_resultado d, '||
							'			exame_lab_result_item e, '||
							'			prescr_procedimento f '||
							'	where  	d.nr_seq_resultado 	= e.nr_seq_resultado ';
							if (cRegras_w.ie_metodo_busca_info = 'S') then
								SQLItensInserir := SQLItensInserir || ' and 	d.nr_atendimento in (select  a.nr_atendimento '||
																	  ' 							 from    atendimento_paciente a, episodio_paciente b '||
																	  '  							 where   a.nr_Seq_episodio   = b.nr_Sequencia '||
																	  '  							 and     b.nr_sequencia      = :nr_seq_episodio) ';
							elsif (cRegras_w.ie_metodo_busca_info = 'C') then
								SQLItensInserir := SQLItensInserir || 	' and 	d.nr_atendimento in (	select  a.nr_atendimento '||
																		' 							from    atendimento_paciente a '||
																		'  							where   a.cd_pessoa_fisica   = :cd_pessoa_fisica) ';
							else
								SQLItensInserir := SQLItensInserir || '	and		d.nr_atendimento 	= :nr_atendimento ';
							end if;
							
							SQLItensInserir := SQLItensInserir ||
							'	and		(:nr_seq_exame 		= 0 or e.nr_seq_exame = :nr_seq_exame) '||
							'	and   	d.nr_prescricao = f.nr_prescricao '||
							'	and   	e.NR_SEQ_PRESCR = f.nr_sequencia '||
							'	and   	f.IE_STATUS_ATEND >= 35 '||
							'	and		d.nr_prescricao is not null '||
							'	and		e.nr_seq_prescr is not null '||
							'	and 	d.dt_resultado between :dt_inicial and sysdate ';
		if (cRegras_w.ie_fora_faixa = 'S') then
		SQLItensInserir := 	SQLItensInserir ||
							'	and suep_obter_se_lab_ref(d.nr_prescricao,0,e.nr_seq_exame,e.nr_seq_material,e.ds_resultado,e.qt_resultado,e.pr_resultado)  = ''S'' ';
		end if;
		SQLItensInserir := 	SQLItensInserir ||
							'	order by dt_resultado desc ';

		if (cRegras_w.ie_metodo_busca_info = 'S') then
			open cursor_itens_carta_medica_w for EXECUTE SQLItensInserir using nr_seq_episodio_w,cRegras_w.nr_seq_exame,cRegras_w.nr_seq_exame,dt_inicio_carta_w;
		elsif (cRegras_w.ie_metodo_busca_info = 'C') then
			open cursor_itens_carta_medica_w for EXECUTE SQLItensInserir using cd_pessoa_fisica_w,cRegras_w.nr_seq_exame,cRegras_w.nr_seq_exame,dt_inicio_carta_w;
		else
			open cursor_itens_carta_medica_w for EXECUTE SQLItensInserir using nr_atendimento_w,cRegras_w.nr_seq_exame,cRegras_w.nr_seq_exame,dt_inicio_carta_w;
		end if;
	elsif (cRegras_w.ie_secao in ('STM', 'STC', 'SP', 'ST', 'SE', 'SDI','SD') and (nr_cirurgia_w IS NOT NULL AND nr_cirurgia_w::text <> '')) then			
		SQLItensInserir := get_sql_regra_automatica_carta(SQLItensInserir, cRegras_w.ie_secao, cRegras_w.ie_todos, cRegras_w.ie_metodo_busca_info, get_texto_conteudo_w);

		open cursor_itens_carta_medica_w for EXECUTE SQLItensInserir using nr_cirurgia_w,dt_inicio_carta_w;
	end if;
	
	if (cRegras_w.ie_secao = 'NC') then
		ie_secao_w := cRegras_w.ie_secao || cRegras_w.NR_SEQ_SECAO;
	else
		ie_secao_w := cRegras_w.ie_secao;
	end if;
	
	if (SQLItensInserir IS NOT NULL AND SQLItensInserir::text <> '') then
		loop
		fetch cursor_itens_carta_medica_w into
			cd_registro_inserir_w,
			dt_registro_w,
			texto_sugerido_w,
			nr_seq_result_w,
			nr_seq_result_item_w;
		EXIT WHEN NOT FOUND; /* apply on cursor_itens_carta_medica_w */
			begin
			nr_seq_carta_conteudo_w := inserir_log_carta(nr_seq_carta_p, ie_secao_w, cd_registro_inserir_w, texto_sugerido_w, nm_usuario_p, nr_seq_result_w, nr_seq_result_item_w, cRegras_w.ie_inserir_aut, nr_seq_carta_conteudo_w, cRegras_w.ie_tipo_regra, 'N', nr_seq_carta_mae_w);
			end;
		end loop;
		close cursor_itens_carta_medica_w;
	end if;
	end;
end loop;
close CRegras;

commit;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE inserir_itens_carta_medica ((nr_seq_carta_p bigint, nm_usuario_p text) is nr_seq_modelo_w carta_medica.nr_seq_modelo%type) FROM PUBLIC;

