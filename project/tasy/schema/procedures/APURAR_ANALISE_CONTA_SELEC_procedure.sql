-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';



CREATE TYPE campos AS (qt_item 	double precision);


CREATE OR REPLACE PROCEDURE apurar_analise_conta_selec ( nr_sequencia_p bigint, nr_interno_conta_p bigint, ie_opcao_p text, qt_contas_p bigint, nm_usuario_p text) AS $body$
DECLARE

type vetor is table of campos index 	by integer;
vetor_w			vetor;
i			integer 	:= 0;
k			integer 	:= 0;
nr_seq_item_w		bigint	:= 0;
nr_seq_classif_w	bigint;
qt_ocorrencia_w		integer;
qt_frequencia_w		double precision;
qt_media_w		double precision;
qt_mediana_w		double precision;
qt_total_w		double precision;
qt_moda_w		double precision;
qt_resumo_w		double precision;
vl_preco_medio_w	double precision;
vl_custo_unitario_w	double precision;
vl_custo_total_w	double precision;
vl_receita_hosp_w	double precision;
vl_result_oper_w	double precision;
vl_original_w		double precision;
cd_material_w		integer;
cd_procedimento_w	bigint;
ie_origem_proced_w	bigint;
cd_classif_setor_w	smallint;
nr_seq_local_w		bigint;
qt_conta_w		bigint;
ds_filtro_setor_atendimento_w	varchar(4000);
ds_filtro_estrutura_conta_w	varchar(4000);
ds_filtro_carater_cirurgia_w	varchar(4000);
ie_agrupa_setor_w		varchar(1);
qt_frequencia_imp_w		double precision	:= 0;
inserir_w			varchar(1);
ie_local_analise_w		varchar(1);
qt_freq_analise_w		double precision;
qt_minima_w			double precision;
qt_maxima_w			double precision;
nr_seq_proc_interno_w		analise_conta_movto.nr_seq_proc_interno%type;
nr_seq_exame_w				analise_conta_movto.nr_seq_exame%type;
vl_preco_medio_rec_w		double precision;
ie_FILTRO_ESTRUTURA_CONTA_w	varchar(1);
ie_FILTRO_CARATER_CIRURGIA_w	varchar(1);
ie_FILTRO_SETOR_ATENDIMENTO_w	varchar(1);

c01 CURSOR FOR
SELECT
	count(distinct nr_interno_conta) qt_ocorrencia,
	avg(qt_resumo) qt_media,
	sum(qt_resumo) qt_total,
	sum(vl_custo) vl_custo_total, 
	sum(vl_original) vl_original, 
	sum(vl_receita) vl_receita_hosp,
	cd_material cd_material,
	cd_procedimento, 
	ie_origem_proced,
	nr_seq_local,
	nr_seq_classif,
	min(qt_resumo) qt_minima,
	max(qt_resumo) qt_maxima,
	nr_seq_proc_interno,
	nr_seq_exame
from	analise_conta_movto
where	nr_sequencia 		= nr_sequencia_p
group by 
	cd_material,
	cd_procedimento,
	ie_origem_proced,
	nr_seq_local,
	nr_seq_classif,
	nr_seq_proc_interno,
	nr_seq_exame;

c02 CURSOR FOR
SELECT	qt_resumo
from	analise_conta_movto
where	nr_sequencia 		= nr_sequencia_p
and	coalesce(nr_seq_local,0)	= coalesce(nr_seq_local_w,0)
and	nr_seq_classif		= nr_seq_classif_w
and	coalesce(cd_material,0)	= coalesce(cd_material_w,0)
and	coalesce(cd_procedimento,0)	= coalesce(cd_procedimento_w,0)
and	coalesce(ie_origem_proced,0)	= coalesce(ie_origem_proced_w,0)
order by 1;

c03 CURSOR FOR
SELECT	qt_resumo, count(*)
from	analise_conta_movto
where	nr_sequencia 		= nr_sequencia_p
and	coalesce(nr_seq_local,0)	= coalesce(nr_seq_local_w,0)
and	nr_seq_classif		= nr_seq_classif_w
and	coalesce(cd_material,0)	= coalesce(cd_material_w,0)
and	coalesce(cd_procedimento,0)	= coalesce(cd_procedimento_w,0)
and	coalesce(ie_origem_proced,0)	= coalesce(ie_origem_proced_w,0)
group by qt_resumo
order by 2;



BEGIN

if (ie_opcao_p = '1') then -- Acumular as contas  na tabela movto
	ie_agrupa_setor_w	:= obter_valor_param_usuario(232,1,obter_perfil_ativo,nm_usuario_p,0);

	select	max(ds_filtro_setor_atendimento),
		max(ds_filtro_estrutura_conta),
		max(ds_filtro_carater_cirurgia),
		coalesce(max(ie_local_analise),'P'),
		max(pr_frequencia)
	into STRICT	ds_filtro_setor_atendimento_w,
		ds_filtro_estrutura_conta_w,
		ds_filtro_carater_cirurgia_w,
		ie_local_analise_w,
		qt_freq_analise_w
	from	analise_conta
	where	nr_sequencia	= nr_sequencia_p;
	
	--Setor Atendimento
	if (ds_filtro_setor_atendimento_w like '%!%') then
		begin
		ie_filtro_setor_atendimento_w := '2';
		ds_filtro_setor_atendimento_w := replace(ds_filtro_setor_atendimento_w,'!','');
		end;
	else	
		begin
		ie_filtro_setor_atendimento_w := '1';
		end;
	end if;
	
	--Estrutura Conta
	if (ds_filtro_estrutura_conta_w like '%!%') then
		begin
		ie_filtro_estrutura_conta_w := '2';
		ds_filtro_estrutura_conta_w := replace(ds_filtro_estrutura_conta_w,'!','');
		end;
	else	
		begin
		ie_filtro_estrutura_conta_w := '1';
		end;
	end if;

	--Carater Cirurgia
	if (ds_filtro_carater_cirurgia_w like '%!%') then
		begin
		ie_filtro_carater_cirurgia_w := '2';
		ds_filtro_carater_cirurgia_w := replace(ds_filtro_carater_cirurgia_w,'!','');
		end;
	else	
		begin
		ie_filtro_carater_cirurgia_w := '1';
		end;
	end if;
	
	insert into analise_conta_movto(
		nr_sequencia, nr_seq_conta, nr_interno_conta,
		nr_seq_classif, nr_seq_local, qt_resumo,
		vl_receita, vl_custo, vl_original,
		cd_material, cd_procedimento, ie_origem_proced, nr_seq_proc_interno, nr_seq_exame)
	SELECT
		a.nr_sequencia, max(b.nr_sequencia), b.nr_interno_conta,
		obter_classif_analise_conta(b.cd_procedimento, b.ie_origem_proced,b.cd_material),
		CASE WHEN ie_agrupa_setor_w='S' THEN  coalesce(cd_classif_setor,99)  ELSE CASE WHEN ie_local_analise_w='S' THEN coalesce(cd_classif_setor,99) END  END  nr_seq_local,
		sum(qt_resumo),
		sum(coalesce(vl_material,0) + coalesce(vl_procedimento,0)),
		sum(coalesce(vl_custo,0)),
		sum(coalesce(vl_original,0)),
		coalesce(d.cd_material_agrup, b.cd_material) cd_material,
		cd_procedimento,
		ie_origem_proced,
		b.nr_seq_proc_interno,
		b.nr_seq_exame
	FROM conta_analise a, conta_paciente_resumo b
LEFT OUTER JOIN setor_atendimento c ON (b.cd_setor_atendimento = c.cd_setor_atendimento)
LEFT OUTER JOIN material_agrup d ON (b.cd_material = d.cd_material AND 1 = d.ie_motivo)
WHERE a.nr_interno_conta 	= b.nr_interno_conta and a.nr_sequencia 		= nr_sequencia_p  and a.nr_interno_conta	= nr_interno_conta_p   and qt_resumo		> 0 and ((coalesce(ds_filtro_setor_atendimento_w::text, '') = '') or 
		((ie_filtro_setor_atendimento_w = '1') and (obter_se_contido(b.cd_setor_atendimento, replace(ds_filtro_setor_atendimento_w,chr(39),''))= 'S')) or 
		((ie_filtro_setor_atendimento_w = '2') and (not obter_se_contido(b.cd_setor_atendimento, replace(ds_filtro_setor_atendimento_w,chr(39),''))= 'S'))) and ((coalesce(ds_filtro_estrutura_conta_w::text, '') = '') or 
		((ie_filtro_estrutura_conta_w = '1') and (obter_se_contido(b.cd_estrutura_conta, replace(ds_filtro_estrutura_conta_w,chr(39),''))= 'S')) or
		((ie_filtro_estrutura_conta_w = '2') and (not obter_se_contido(b.cd_estrutura_conta, replace(ds_filtro_estrutura_conta_w,chr(39),''))= 'S'))) and ((coalesce(ds_filtro_carater_cirurgia_w::text, '') = '') or
		((ie_filtro_carater_cirurgia_w = '1') and ( exists (	SELECT	1
										from	cirurgia x
										where	x.nr_cirurgia	= b.nr_cirugia
										and	obter_se_contido(x.ie_carater_cirurgia, replace(ds_filtro_carater_cirurgia_w,chr(39),''))= 'S'))) or
		((ie_filtro_carater_cirurgia_w = '2') and (not  exists (	select	1
										from	cirurgia x
										where	x.nr_cirurgia	= b.nr_cirugia
										and	obter_se_contido(x.ie_carater_cirurgia, replace(ds_filtro_carater_cirurgia_w,chr(39),''))= 'S')))) group by
		a.nr_sequencia, b.nr_interno_conta,
		obter_classif_analise_conta(b.cd_procedimento, b.ie_origem_proced,b.cd_material),
		coalesce(cd_classif_setor,99),
		coalesce(d.cd_material_agrup, b.cd_material),
		cd_procedimento, 
		ie_origem_proced,
		b.nr_seq_proc_interno,
		b.nr_seq_exame;

elsif 	((ie_opcao_p = '2') and (coalesce(qt_contas_p,0) > 0)) then

	qt_frequencia_imp_w	:= obter_valor_param_usuario(232,2,obter_perfil_ativo,nm_usuario_p,0);

	select	max(pr_frequencia)
	into STRICT	qt_freq_analise_w
	from	analise_conta
	where	nr_sequencia	= nr_sequencia_p;
	
	qt_conta_w:= coalesce(qt_contas_p,0);

	open  c01;
	loop
	fetch c01 into
		qt_ocorrencia_w, 
		qt_media_w, 
		qt_total_w,
		vl_custo_total_w, 
		vl_original_w,
		vl_receita_hosp_w,
		cd_material_w, 
		cd_procedimento_w, 
		ie_origem_proced_w,
		nr_seq_local_w,
		nr_seq_classif_w,
		qt_minima_w,
		qt_maxima_w,
		nr_seq_proc_interno_w,
		nr_seq_exame_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
		nr_seq_item_w		:= nr_seq_item_w + 1;
		qt_frequencia_w		:= qt_ocorrencia_w / qt_conta_w;
		vl_result_oper_w	:= vl_receita_hosp_w - vl_custo_total_w;
		
		inserir_w	:= 'S';
		
		if (qt_freq_analise_w IS NOT NULL AND qt_freq_analise_w::text <> '') then
			qt_frequencia_imp_w:= qt_freq_analise_w;
		end if;
		
		if (qt_frequencia_imp_w	>0 )and (qt_frequencia_w *100 < qt_frequencia_imp_w) then
			inserir_w	:= 'N';
		end if;


	/*	apuracao da mediana   */

		qt_mediana_w			:= 0;
		i				:= 0;
		vetor_w.delete;
		open  c02;
		loop
		fetch c02 into 	qt_resumo_w;
		EXIT WHEN NOT FOUND; /* apply on c02 */
			i 			:= i + 1;
			vetor_w[i].qt_item 	:= qt_resumo_w;
		end loop;
		close c02;
		k	:= trunc((i / 2),0);
		if (i = 0) then
			qt_mediana_w		:= 0;
		elsif (i = 1) then
			qt_mediana_w		:= vetor_w[1].qt_item;
		elsif	((k * 2) = i) then
			qt_mediana_w		:= ((vetor_w[k].qt_item + vetor_w[k + 1].qt_item) /2);
		else
			qt_mediana_w		:= vetor_w[k + 1].qt_item;
		end if;
	/*	fim apuracao da mediana   */


		

	/*	apuracao da moda */

		qt_moda_w			:= 0;
		open  c03;
		loop
		fetch c03 into 	qt_moda_w, qt_resumo_w;
		EXIT WHEN NOT FOUND; /* apply on c03 */
			qt_moda_w	:= qt_moda_w;
		end loop;
		close c03;
		
		
	/*	fim apuracao da moda */

		if (coalesce(qt_total_w,0) = 0) then
			vl_preco_medio_w	:= 0;
			vl_custo_unitario_w	:= 0;
			vl_preco_medio_rec_w	:= 0;
		else
			vl_preco_medio_w	:= vl_original_w / qt_total_w;
			vl_custo_unitario_w	:= vl_custo_total_w / qt_total_w;			
			vl_preco_medio_rec_w	:= vl_receita_hosp_w / qt_total_w;
		end if;
		
		if (inserir_w	= 'S') then
			insert into analise_conta_item(
				nr_sequencia, nr_seq_item, dt_atualizacao, nm_usuario,
				nr_seq_classif, nr_seq_local, qt_ocorrencia, 
				qt_frequencia, qt_media, qt_mediana, vl_preco_medio,
				vl_custo_unitario, vl_custo_total, vl_receita_hosp,
				cd_material, cd_procedimento, ie_origem_proced,
				vl_result_oper, vl_original, qt_moda, qt_minima, qt_maxima, vl_preco_medio_rec, nr_seq_proc_interno, nr_seq_exame)
			values (
				nr_sequencia_p, nr_seq_item_w, clock_timestamp(), nm_usuario_p, 
				nr_seq_classif_w,  nr_seq_local_w, qt_ocorrencia_w, 
				qt_frequencia_w, qt_media_w, qt_mediana_w, vl_preco_medio_w,
				vl_custo_unitario_w, vl_custo_total_w, vl_receita_hosp_w,
				cd_material_w, cd_procedimento_w, ie_origem_proced_w,
				vl_result_oper_w, vl_original_w, qt_moda_w, qt_minima_w, qt_maxima_w, vl_preco_medio_rec_w, nr_seq_proc_interno_w, nr_seq_exame_w);
		end if;
	end loop;
	close c01;
	
--	delete 	from analise_conta_movto

--	where 	nr_sequencia = nr_sequencia_p;
	
	commit;
	
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE apurar_analise_conta_selec ( nr_sequencia_p bigint, nr_interno_conta_p bigint, ie_opcao_p text, qt_contas_p bigint, nm_usuario_p text) FROM PUBLIC;

