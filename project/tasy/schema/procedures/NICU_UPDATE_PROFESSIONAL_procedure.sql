-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE nicu_update_professional ( nr_encounter_p bigint, nm_usuario_p text, ds_label_p text, ds_professional_p text) AS $body$
DECLARE


vl_count bigint;
r_dominio varchar(50);


BEGIN
     select  vl_dominio
     into STRICT    r_dominio
     from    valor_dominio
     where   cd_dominio = 10497
     and     obter_desc_expressao(cd_exp_valor_dominio, ds_valor_dominio) = ds_label_p;

    select count(*)
    into STRICT    vl_count
    from    nicu_encounter_staff
    where   nr_seq_encounter = nr_encounter_p
    and     ie_type = ( SELECT  vl_dominio
                        from    valor_dominio
                        where   cd_dominio = 10497
                        and     obter_desc_expressao(cd_exp_valor_dominio, ds_valor_dominio) = ds_label_p);

    if (vl_count > 0) then
        UPDATE  nicu_encounter_staff
        set     dt_atualizacao = clock_timestamp(),
                nm_usuario = nm_usuario_p,
                dt_atualizacao_nrec = clock_timestamp(),
                nm_usuario_nrec = nm_usuario_p,
                nm_employee = ds_professional_p,
                ie_type = r_dominio
        where   nr_seq_encounter = nr_encounter_p
        and     ie_type = (     SELECT  vl_dominio
                                from    valor_dominio
                                where   cd_dominio = 10497
                                and     obter_desc_expressao(cd_exp_valor_dominio, ds_valor_dominio) = ds_label_p);
    else
        insert into nicu_encounter_staff(NR_SEQUENCIA,
        dt_atualizacao,
        nm_usuario,
        dt_atualizacao_nrec,
        nm_usuario_nrec,
        nm_employee,
        nr_seq_encounter,
        ie_type)
        values ( nextval('nicu_encounter_staff_seq'),
        clock_timestamp(),
        nm_usuario_p,
        clock_timestamp(),
        nm_usuario_p,
        ds_professional_p,
        nr_encounter_p,
        r_dominio
        );
    end if;
    commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE nicu_update_professional ( nr_encounter_p bigint, nm_usuario_p text, ds_label_p text, ds_professional_p text) FROM PUBLIC;

