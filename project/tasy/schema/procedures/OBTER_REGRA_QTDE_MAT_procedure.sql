-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE obter_regra_qtde_mat (nr_atendimento_p bigint, cd_material_p bigint, nr_sequencia_p bigint, ie_acao_excesso_p INOUT text, ds_erro_p INOUT text, qt_excedida_p INOUT bigint) AS $body$
DECLARE

 
 
/*	ie_tipo_qtde =		D - Dia 
				H - Horas (período) 
				A - Atendimento 	*/
 
 
/*	ie_acao_excesso = 	I - Impede Execução 
				P - Conta Particular 
				J - Exige Justificativa	*/
 
 
 
 
cd_convenio_w			integer;
ie_tipo_atendimento_w		smallint;
qt_permitida_w			double precision;
ie_acao_excesso_w		varchar(5);
qt_horas_intervalo_w		integer;
qt_registros_w			integer;
qt_excedida_w			double precision;
dt_atendimento_w			timestamp;
qt_executada_w			double precision;
qt_executada_dia_w		double precision;
qt_executada_atend_w		double precision;
qt_executada_periodo_w		double precision;
ds_erro_w			varchar(255);
ie_tipo_qtde_w			varchar(1);
cd_estabelecimento_w		smallint;
qt_minutos_intervalo_w		bigint;
ds_mensagem_w			varchar(255);
ie_paciente_isolado_w		varchar(1);


BEGIN 
 
ds_erro_w		:= '';
ie_acao_excesso_w	:= '';
 
 
select	count(*) 
into STRICT	qt_registros_w 
from	convenio_regra_qtde_mat 
where	cd_material = cd_material_p 
and	coalesce(ie_situacao,'A') = 'A';
 
 
if (qt_registros_w	> 0) then 
 
	select	coalesce(obter_convenio_atendimento(nr_atendimento_p),0) 
	into STRICT	cd_convenio_w 
	;
 
	select 	coalesce(ie_tipo_atendimento,0), 
		coalesce(cd_estabelecimento,0), 
		coalesce(ie_paciente_isolado,'A') 
	into STRICT	ie_tipo_atendimento_w, 
		cd_estabelecimento_w, 
		ie_paciente_isolado_w 
	from	atendimento_paciente 
	where	nr_atendimento	= nr_atendimento_p;
 
	begin 
	select 	a.qt_permitida, 
		a.ie_acao_excesso, 
		a.qt_horas_intervalo, 
		a.ie_tipo_qtde, 
		a.qt_minutos_intervalo, 
		ds_mensagem 
	into STRICT	qt_permitida_w, 
		ie_acao_excesso_w, 
		qt_horas_intervalo_w, 
		ie_tipo_qtde_w, 
		qt_minutos_intervalo_w, 
		ds_mensagem_w 
   	from 	convenio_regra_qtde_mat a 
	where	a.cd_material				= cd_material_p 
	and	a.cd_convenio				= cd_convenio_w 
	and ((coalesce(a.ie_paciente_isolado,'A') = 'A') or (coalesce(a.ie_paciente_isolado,'A') = ie_paciente_isolado_w)) 
	and 	coalesce(a.ie_tipo_atendimento,ie_tipo_atendimento_w) = ie_tipo_atendimento_w 
	and	coalesce(a.cd_estabelecimento, coalesce(cd_estabelecimento_w,0))	= coalesce(cd_estabelecimento_w,0) 
	and	coalesce(a.ie_situacao,'A') = 'A';
	exception 
		when others then 
			ie_tipo_qtde_w := 'X';
		--#@DS_ERRO#@ 
		CALL Wheb_mensagem_pck.exibir_mensagem_abort(185340,'DS_ERRO=' || sqlerrm);
	end;
 
	if (ie_tipo_qtde_w <> 'X') then 
		select 	coalesce(qt_material,0), 
			dt_atendimento 
		into STRICT	qt_executada_w, 
			dt_atendimento_w 
		from	material_atend_paciente 
		where	nr_sequencia	= nr_sequencia_p;
	end if;
 
 
	if (ie_tipo_qtde_w = 'D') then 
		select 	coalesce(sum(qt_material),0) 
		into STRICT	qt_executada_dia_w 
		from	material_atend_paciente 
		where	nr_atendimento		= nr_atendimento_p 
		and	cd_material		= cd_material_p 
		and	trunc(dt_atendimento)	= trunc(dt_atendimento_w);
 
		if (qt_executada_dia_w > qt_permitida_w) then 
			ds_erro_w 	:= WHEB_MENSAGEM_PCK.get_texto(277817);
			qt_excedida_w	:= qt_executada_dia_w - qt_permitida_w;
		end if;
	end if;
 
 
	if (ie_tipo_qtde_w = 'A') then 
		select 	coalesce(sum(qt_material),0) 
		into STRICT	qt_executada_atend_w 
		from	material_atend_paciente 
		where	nr_atendimento		= nr_atendimento_p 
		and	cd_material		= cd_material_p;
 
		if (qt_executada_atend_w > qt_permitida_w) then 
			ds_erro_w	:= WHEB_MENSAGEM_PCK.get_texto(277823);
			qt_excedida_w	:= qt_executada_atend_w - qt_permitida_w;
		end if;
	end if;
 
 
	if (ie_tipo_qtde_w = 'H') then 
		select 	coalesce(sum(qt_material),0) 
		into STRICT	qt_executada_periodo_w 
		from	material_atend_paciente 
		where	nr_atendimento		= nr_atendimento_p 
		and	cd_material		= cd_material_p 
		and	dt_atendimento between 
			(dt_atendimento_w - (qt_horas_intervalo_w * 60 /1440)) and dt_atendimento_w;
 
		if (qt_executada_periodo_w > qt_permitida_w) then 
			ds_erro_w	:= WHEB_MENSAGEM_PCK.get_texto(277826);
			qt_excedida_w	:= qt_executada_periodo_w - qt_permitida_w;
		end if;
	end if;
	 
	if (ie_tipo_qtde_w = 'B') then 
		select 	coalesce(sum(qt_material),0) 
		into STRICT	qt_executada_periodo_w 
		from	material_atend_paciente 
		where	nr_atendimento		= nr_atendimento_p 
		and	cd_material		= cd_material_p 
		and	dt_atendimento between 
			(dt_atendimento_w - (qt_minutos_intervalo_w / 1440)) and dt_atendimento_w;
 
		if (qt_executada_periodo_w > qt_permitida_w) then 
			ds_erro_w	:= WHEB_MENSAGEM_PCK.get_texto(277826);
			qt_excedida_w	:= qt_executada_periodo_w - qt_permitida_w;
		end if;
	end if;
 
	if (ds_mensagem_w IS NOT NULL AND ds_mensagem_w::text <> '') and (ds_erro_w IS NOT NULL AND ds_erro_w::text <> '') then 
		ds_erro_w := ds_mensagem_w;
	end if;
	ds_erro_p := ds_erro_w;
	ie_acao_excesso_p	:= ie_acao_excesso_w;
	if (coalesce(ds_erro_w::text, '') = '') then 
		ie_acao_excesso_p	:= '';
	end if;
	qt_excedida_p		:= qt_excedida_w;
 
end if;
 
 
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE obter_regra_qtde_mat (nr_atendimento_p bigint, cd_material_p bigint, nr_sequencia_p bigint, ie_acao_excesso_p INOUT text, ds_erro_p INOUT text, qt_excedida_p INOUT bigint) FROM PUBLIC;

