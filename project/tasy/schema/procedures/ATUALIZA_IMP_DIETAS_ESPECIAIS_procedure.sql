-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE atualiza_imp_dietas_especiais ( nm_usuario_p text) AS $body$
DECLARE


nr_prescricao_w		bigint;

C01 CURSOR FOR
	SELECT 	distinct a.nr_prescricao
	FROM	prescr_dieta a,
		prescr_medica b
	WHERE	a.nr_prescricao = b.nr_prescricao
	aND	coalesce(ie_suspenso,'N') <> 'S'
	and (a.IE_URGENCIA = 'S' or a.IE_DOSE_ESPEC_AGORA = 'S')
	and	(coalesce(b.dt_liberacao,b.dt_liberacao_medico) IS NOT NULL AND (coalesce(b.dt_liberacao,b.dt_liberacao_medico))::text <> '')
	and	not exists (	SELECT 	1
		    		from   	nut_impressao_relatorio c,
					prescr_medica d
				where  	c.nr_prescricao = d.nr_prescricao
				and	d.nr_prescricao = a.nr_prescricao
				and    	c.ie_tipo_relatorio = 'HE')
	and	to_char(clock_timestamp(),'dd/mm/yyyy') = to_char(coalesce(b.dt_liberacao,b.dt_liberacao_medico),'dd/mm/yyyy')
	and	to_date(to_char(clock_timestamp(),'hh24:mi'),'hh24:mi') >=
		--to_date(to_char(nvl(OBTER_DATA_MAIOR(nvl(to_date((select to_char(max(x.dt_fim),'hh24:mi') from rep_jejum x where x.nr_prescricao = a.nr_prescricao),'hh24:mi')+(1/24)/60,to_date(HR_DOSE_ESPECIAL,'hh24:mi')-(1/24)/60),to_date(HR_DOSE_ESPECIAL,'hh24:mi')+(1/24)/60),sysdate),'hh24:mi'),'hh24:mi');
		--to_date(to_char(nvl(OBTER_DATA_MAIOR(nvl(to_date((select to_char(max(x.dt_fim),'hh24:mi') from rep_jejum x where x.nr_prescricao = a.nr_prescricao),'hh24:mi')+(1/24)/60,to_date(decode(replace(HR_DOSE_ESPECIAL,' ',''),':',to_char(sysdate,'hh24:mi')),'hh24:mi')-(1/24)/60),to_date(decode(replace(HR_DOSE_ESPECIAL,' ',''),':',to_char(sysdate,'hh24:mi')),'hh24:mi')+(1/24)/60),sysdate),'hh24:mi'),'hh24:mi');
		to_date(to_char(coalesce(OBTER_DATA_MAIOR(coalesce(to_date((select to_char(max(x.dt_fim),'hh24:mi') from rep_jejum x where x.nr_prescricao = a.nr_prescricao),'hh24:mi')+(1/24)/60,to_date(CASE WHEN replace(HR_DOSE_ESPECIAL,' ','')=':' THEN to_char(clock_timestamp(),'hh24:mi') END ,'hh24:mi')-(1/24)/60),to_date(CASE WHEN replace(HR_DOSE_ESPECIAL,' ','')=':' THEN to_char(clock_timestamp()-((1/24)/60),'hh24:mi') END ,'hh24:mi')+(1/24)/60),clock_timestamp()),'hh24:mi'),'hh24:mi');


BEGIN

open C01;
loop
fetch C01 into
	nr_prescricao_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	insert into nut_impressao_relatorio(nr_sequencia,
		dt_impressao,
		nm_usuario,
		nm_usuario_nrec,
		dt_atualizacao,
		dt_atualizacao_nrec,
		nr_prescricao,
		ie_tipo_relatorio)
	values (nextval('nut_impressao_relatorio_seq'),
		clock_timestamp(),
		nm_usuario_p,
		nm_usuario_p,
		clock_timestamp(),
		clock_timestamp(),
		nr_prescricao_w,
		'HE');

	end;
end loop;
close C01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE atualiza_imp_dietas_especiais ( nm_usuario_p text) FROM PUBLIC;

