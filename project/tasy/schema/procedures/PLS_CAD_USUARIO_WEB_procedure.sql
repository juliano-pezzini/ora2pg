-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_cad_usuario_web (cd_usuario_plano_p text, ds_senha_p text, ds_hash_p text, ds_obervacao_p text, cd_estabelecimento_p bigint, nm_usuario_p text, nr_seq_segurado_web_p INOUT bigint, nr_seq_segurado_p INOUT bigint) AS $body$
DECLARE


nr_seq_segurado_web_w	pls_segurado_web.nr_sequencia%type;
nr_seq_segurado_w	pls_segurado_web.nr_seq_segurado%type;
nr_seq_termo_w		wsuite_termo_uso.nr_sequencia%type;
nm_usuario_benef_w	varchar(255);
qt_senha_w		bigint;
ds_salt_w				varchar(15);
ds_senha_sha256_w		varchar(64);


BEGIN

nr_seq_segurado_w :=  pls_obter_dados_carteira(null,cd_usuario_plano_p, 'S');

if (nr_seq_segurado_w IS NOT NULL AND nr_seq_segurado_w::text <> '') then

	nm_usuario_benef_w := substr(tws_get_name_person(pls_obter_dados_segurado(nr_seq_segurado_w,'PF'),cd_estabelecimento_p),1,10);

	CALL pls_del_cad_usuario_web(cd_usuario_plano_p,'P', nm_usuario_benef_w ,cd_estabelecimento_p,'N');
	
	select	count(1) 
	into STRICT	qt_senha_w
	from	pls_segurado_web
	where	nr_seq_segurado  = nr_seq_segurado_w
	and	coalesce(ds_senha::text, '') = ''
	and	ie_situacao = 'A';
	
	select 	replace(replace(dbms_random.string('P', 15), chr(39), ''), ';', '')
	into STRICT	ds_salt_w
	;
	
	ds_senha_sha256_w := obter_sha2(upper(ds_senha_p) || ds_salt_w, 256);
	
	if (qt_senha_w > 0) then
	
		select	max(nr_sequencia)
		into STRICT	nr_seq_segurado_web_w
		from	pls_segurado_web
		where	nr_seq_segurado = nr_seq_segurado_w
		and		ie_situacao = 'A';
	
		update	pls_segurado_web
		set		ds_senha = ds_senha_sha256_w,
				ds_tec = ds_salt_w,
				ie_situacao = 'P',
				ds_hash = ds_hash_p,
				dt_atualizacao = clock_timestamp() ,
				nm_usuario = nm_usuario_p, 
				ds_observacao = ds_obervacao_p,
				cd_estabelecimento = cd_estabelecimento_p, 
				ie_origem_login = 'AB'
		where	nr_sequencia = nr_seq_segurado_web_w;		
		
	else
	
		select	nextval('pls_segurado_web_seq')
		into STRICT	nr_seq_segurado_web_w
		;

		insert	into	pls_segurado_web(nr_sequencia, nr_seq_segurado, ds_senha, ds_tec,
						 ie_situacao, ds_hash, dt_atualizacao,
						 nm_usuario,dt_atualizacao_nrec, nm_usuario_nrec,
						 ds_observacao, cd_estabelecimento, ie_origem_login)
					values (nr_seq_segurado_web_w, nr_seq_segurado_w, ds_senha_sha256_w, ds_salt_w,
						 'P', ds_hash_p, clock_timestamp(),
						 nm_usuario_p,  clock_timestamp(), nm_usuario_p,
						 ds_obervacao_p, cd_estabelecimento_p, 'AB');						
		
	end if;

	select 	max(nr_sequencia) nr_seq_termo_uso
	into STRICT	nr_seq_termo_w
	from 	wsuite_termo_uso
	where 	coalesce(ie_aplicacao::text, '') = ''
	and 	ie_aplicacao_ant	= 5
	and 	ie_situacao		= 'A'
	and 	ie_tipo_termo		= 'TU'
	and (coalesce(cd_estabelecimento_p::text, '') = '' or cd_estabelecimento = cd_estabelecimento_p)
	and 	(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
	and 	dt_inicio_vigencia <= clock_timestamp()
	and (coalesce(dt_fim_vigencia::text, '') = '' or trunc(dt_fim_vigencia) > trunc(clock_timestamp()));
	
	if (nr_seq_termo_w IS NOT NULL AND nr_seq_termo_w::text <> '') then
		CALL pls_gerar_aceite_termo_respons('TU', nr_seq_termo_w, nr_seq_segurado_web_w,
		nm_usuario_benef_w,cd_estabelecimento_p,'N');
	end if;	
	
	select	max(nr_sequencia) nr_seq_aviso_priv
	into STRICT	nr_seq_termo_w
	from 	wsuite_termo_uso
	where	coalesce(ie_aplicacao::text, '') = ''
	and (ie_aplicacao_ant 	= 5 or coalesce(ie_aplicacao_ant::text, '') = '')
	and	ie_situacao		= 'A'
	and	ie_tipo_termo		= 'AP'
	and (coalesce(cd_estabelecimento_p::text, '') = '' or cd_estabelecimento	= cd_estabelecimento_p)
	and	(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
	and	dt_inicio_vigencia <= clock_timestamp()
	and (coalesce(dt_fim_vigencia::text, '') = '' or trunc(dt_fim_vigencia) > trunc(clock_timestamp()));
	
	if (nr_seq_termo_w IS NOT NULL AND nr_seq_termo_w::text <> '') then
		CALL pls_gerar_aceite_termo_respons('AP', nr_seq_termo_w, nr_seq_segurado_web_w,
		nm_usuario_benef_w,cd_estabelecimento_p,'N');
	end if;

	nr_seq_segurado_web_p := nr_seq_segurado_web_w;
	nr_seq_segurado_p := nr_seq_segurado_w;
					
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_cad_usuario_web (cd_usuario_plano_p text, ds_senha_p text, ds_hash_p text, ds_obervacao_p text, cd_estabelecimento_p bigint, nm_usuario_p text, nr_seq_segurado_web_p INOUT bigint, nr_seq_segurado_p INOUT bigint) FROM PUBLIC;

