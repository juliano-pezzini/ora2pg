-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE obter_motivo_bloqueio_agenda (cd_agenda_p bigint, dt_horario_p timestamp, ie_dia_semana_p bigint, nr_seq_motivo_p INOUT text) AS $body$
DECLARE


nr_seq_motivo_bloq_ag_w		bigint;


BEGIN
nr_seq_motivo_bloq_ag_w	:= null;

if (cd_agenda_p IS NOT NULL AND cd_agenda_p::text <> '') and (dt_horario_p IS NOT NULL AND dt_horario_p::text <> '') and (ie_dia_semana_p IS NOT NULL AND ie_dia_semana_p::text <> '') then
	/* consistir bloqueio período */

	select	max(nr_seq_motivo_bloq_ag)
	into STRICT	nr_seq_motivo_bloq_ag_w
	from	agenda_bloqueio
	where	cd_agenda = cd_agenda_p
	and	trunc(dt_horario_p) between dt_inicial and dt_final
	and	coalesce(hr_inicio_bloqueio::text, '') = ''
	and	coalesce(hr_final_bloqueio::text, '') = ''
	and	coalesce(ie_dia_semana::text, '') = '';


	/* consistir bloqueio horário */

	if (coalesce(nr_seq_motivo_bloq_ag_w::text, '') = '') then
		select	max(nr_seq_motivo_bloq_ag)
		into STRICT	nr_seq_motivo_bloq_ag_w
		from	agenda_bloqueio
		where	cd_agenda = cd_agenda_p
		and	trunc(dt_horario_p) between dt_inicial and dt_final
		and	dt_horario_p between	to_date(to_char(dt_horario_p,'dd/mm/yyyy') ||' '|| to_char(hr_inicio_bloqueio,'hh24:mi:ss'),'dd/mm/yyyy hh24:mi:ss') and 						to_date(to_char(dt_horario_p,'dd/mm/yyyy') ||' '|| to_char(hr_final_bloqueio,'hh24:mi:ss'),'dd/mm/yyyy hh24:mi:ss')
		and	(hr_inicio_bloqueio IS NOT NULL AND hr_inicio_bloqueio::text <> '')
		and	(hr_final_bloqueio IS NOT NULL AND hr_final_bloqueio::text <> '')
		and	hr_inicio_bloqueio < hr_final_bloqueio
		and	coalesce(ie_dia_semana::text, '') = '';
	end if;
	/* consistir bloqueio dia */

	if (coalesce(nr_seq_motivo_bloq_ag_w::text, '') = '') then
		select	max(nr_seq_motivo_bloq_ag)
		into STRICT	nr_seq_motivo_bloq_ag_w
		from	agenda_bloqueio
		where	cd_agenda = cd_agenda_p
		and	trunc(dt_horario_p) between dt_inicial and dt_final
		and	coalesce(hr_inicio_bloqueio::text, '') = ''
		and	coalesce(hr_final_bloqueio::text, '') = ''
		and	(ie_dia_semana IS NOT NULL AND ie_dia_semana::text <> '')
		and	((ie_dia_semana = ie_dia_semana_p) or (ie_dia_semana = 9));
	end if;
	/* consistir bloqueio dia e horário */

	if (coalesce(nr_seq_motivo_bloq_ag_w::text, '') = '') then
		select	max(nr_seq_motivo_bloq_ag)
		into STRICT	nr_seq_motivo_bloq_ag_w
		from	agenda_bloqueio
		where	cd_agenda = cd_agenda_p
		and	trunc(dt_horario_p) between dt_inicial and dt_final
		and	dt_horario_p between	to_date(to_char(dt_horario_p,'dd/mm/yyyy') ||' '|| to_char(hr_inicio_bloqueio,'hh24:mi:ss'),'dd/mm/yyyy hh24:mi:ss') and 						to_date(to_char(dt_horario_p,'dd/mm/yyyy') ||' '|| to_char(hr_final_bloqueio,'hh24:mi:ss'),'dd/mm/yyyy hh24:mi:ss')
		and	(hr_inicio_bloqueio IS NOT NULL AND hr_inicio_bloqueio::text <> '')
		and	(hr_final_bloqueio IS NOT NULL AND hr_final_bloqueio::text <> '')
		and	hr_inicio_bloqueio < hr_final_bloqueio
		and	(ie_dia_semana IS NOT NULL AND ie_dia_semana::text <> '')
		and	((ie_dia_semana = ie_dia_semana_p) or (ie_dia_semana = 9));
	end if;
end if;

nr_seq_motivo_p := nr_seq_motivo_bloq_ag_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE obter_motivo_bloqueio_agenda (cd_agenda_p bigint, dt_horario_p timestamp, ie_dia_semana_p bigint, nr_seq_motivo_p INOUT text) FROM PUBLIC;

