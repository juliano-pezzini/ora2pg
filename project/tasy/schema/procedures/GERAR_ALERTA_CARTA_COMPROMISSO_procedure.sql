-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_alerta_carta_compromisso ( cd_pessoa_fisica_p text, nr_sequencia_p bigint) AS $body$
DECLARE

			
nr_sequencia_w	alerta_paciente.nr_sequencia%type;
ie_situacao_w	alerta_paciente.ie_situacao%type;
qt_alerta_w		integer;


BEGIN


if (cd_pessoa_fisica_p IS NOT NULL AND cd_pessoa_fisica_p::text <> '') then

	select	count(*),
			max(ie_situacao)
	into STRICT	qt_alerta_w,
			ie_situacao_w
	from	alerta_paciente	
	where	cd_pessoa_fisica = cd_pessoa_fisica_p
	and		ds_observacao like '%'|| nr_Sequencia_p || '%';

	if (qt_alerta_w = 0 and coalesce(ie_situacao_w::text, '') = '') then
	
		select nextval('alerta_paciente_seq')
		into STRICT nr_sequencia_w
		;

		insert into alerta_paciente(
			nr_sequencia,
			cd_estabelecimento,
			cd_pessoa_fisica,
			dt_alerta,
			dt_atualizacao,
			nm_usuario,
			ds_alerta,
			ie_situacao,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			dt_liberacao,
			ds_observacao)
			values (
			nr_sequencia_w,
			wheb_usuario_pck.get_cd_estabelecimento,
			cd_pessoa_fisica_p,
			clock_timestamp(),
			clock_timestamp(),
			wheb_usuario_pck.get_nm_usuario,
			expressao_pck.obter_desc_expressao(947870),
			'A',
			clock_timestamp(),
			wheb_usuario_pck.get_nm_usuario,
			clock_timestamp(),
			expressao_pck.obter_desc_expressao(947876) || nr_sequencia_p
			);
			
		commit;
		
	elsif (qt_alerta_w > 0 and (ie_situacao_w IS NOT NULL AND ie_situacao_w::text <> '')) then
		
		update	alerta_paciente
		set		dt_inativacao  = NULL,
				ie_situacao = 'A',
				dt_atualizacao = clock_timestamp(),
				nm_usuario = wheb_usuario_pck.get_nm_usuario
		where 	cd_pessoa_fisica = cd_pessoa_fisica_p
		and		ds_observacao like '%'|| nr_sequencia_p || '%';
		
		commit;
		
	end if;
	
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_alerta_carta_compromisso ( cd_pessoa_fisica_p text, nr_sequencia_p bigint) FROM PUBLIC;

