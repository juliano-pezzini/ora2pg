-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE desdobramento_titulo_pagar ( nr_titulo_p bigint, nm_usuario_p text, dt_alteracao_p timestamp, ie_gera_tributos_p text) AS $body$
DECLARE


nr_seq_titulo_w			bigint;
conta_titulo_w			smallint := 0;
vl_desdob_w			double precision;
vl_titulo_p1_w			double precision;
vl_titulo_parcela_w		double precision;
cd_estabelecimento_w		smallint;
dt_emissao_w			timestamp;
dt_vencimento_w			timestamp;
dt_pagamento_previsto_w		timestamp;
dt_contabil_w			timestamp;
vl_titulo_w			double precision;
vl_saldo_titulo_w		double precision;
cd_moeda_w			integer;
cd_tipo_taxa_juro_w		bigint;
cd_tipo_taxa_multa_w		bigint;
tx_desc_antecipacao_w		double precision;
ie_situacao_w			varchar(3);
ie_origem_titulo_w		varchar(10);
ie_tipo_titulo_w		varchar(3);
cd_pessoa_fisica_w		varchar(10);
cd_cgc_w			varchar(14);
nr_documento_w			numeric(20);
nr_bloqueto_w			varchar(254);
dt_vencimento_original_w	timestamp;
nr_seq_nota_fiscal_w		bigint := 0;
dt_desdobramento_w		timestamp;
vl_desdobramento_w		double precision := 0;
nr_seq_desdob_w			bigint := 0;
nr_desdobramentos_w		integer := 0;
ds_desdobramentos_w		varchar(4000);
nr_repasse_terceiro_w		bigint;
nr_seq_tributo_w		bigint;

nr_seq_classif_w		bigint;
vl_classif_w			double precision;
cd_conta_contabil_w		varchar(20);
cd_centro_custo_w		bigint;
nr_seq_conta_financ_w		bigint;
nr_seq_trans_fin_baixa_w	bigint;
nr_seq_trans_fin_contab_tit_w	bigint;
nr_seq_alt_valor_w		bigint;
nr_seq_trans_fin_classif_w	bigint;
nr_titulo_imposto_w		bigint;
cd_estab_financeiro_w		bigint;
vl_saldo_juros_w		double precision;
vl_saldo_multa_w		double precision;
ds_observacao_titulo_w		varchar(4000);
nr_seq_trans_fin_contab_w	bigint;
NR_SEQ_CLASSE_w			bigint;
ie_centro_custo_w		varchar(1);
ie_desdobra_param_w		varchar(1);
ie_param_contab_tit_w		varchar(1);
nr_seq_reembolso_w		bigint;
DT_LIBERACAO_W			timestamp;
NM_USUARIO_LIB_W		varchar(15);
ie_liberar_tit_desdobrado_w	varchar(1);
/* Projeto Multimoeda */

vl_cotacao_w			cotacao_moeda.vl_cotacao%type;
vl_desdob_estrang_w		double precision;
vl_cotacao_titulo_w		double precision;
vl_titulo_estrang_w		double precision;
nr_seq_proj_rec_w		titulo_pagar.nr_seq_proj_rec%type;

ie_tipo_data_emissao_w		varchar(3);
ie_tipo_data_contabil_w		varchar(3);
dt_emissao_tit_desd_w			timestamp;
dt_contabil_tit_desd_w		timestamp;

c01 CURSOR FOR
SELECT	dt_vencimento,
	vl_titulo,
	nr_sequencia,
	coalesce(vl_saldo_juros, 0),
	coalesce(vl_saldo_multa, 0)
from	titulo_pagar_desdob
where	nr_titulo	= nr_titulo_p
order	by dt_vencimento asc;


c02 CURSOR FOR
SELECT	nr_sequencia,
	vl_titulo,
	cd_conta_contabil,
	cd_centro_custo,
	nr_seq_conta_financ,
	nr_seq_trans_fin
from	titulo_pagar_classif
where	nr_titulo = nr_titulo_p;

c03 CURSOR FOR
SELECT	obter_titulo_imposto(nr_sequencia)
from	titulo_pagar_imposto
where	nr_titulo = nr_titulo_p
and	coalesce(obter_titulo_imposto(nr_sequencia),0) <> 0
and	coalesce(ie_gera_tributos_p,'N') = 'S';


BEGIN

/*  obter valores do titulo a desdobrar */
begin
select	cd_estabelecimento,
	dt_emissao,
	dt_vencimento_atual,
	dt_vencimento_original,
	vl_titulo,
	vl_titulo_estrang,
	vl_saldo_titulo,
	cd_moeda,
	vl_cotacao,
	cd_tipo_taxa_juro,
	cd_tipo_taxa_multa,
	tx_desc_antecipacao,
	ie_situacao,
      	ie_origem_titulo,
      	ie_tipo_titulo,
      	cd_pessoa_fisica,
      	cd_cgc,
      	nr_documento,
      	nr_bloqueto,
      	nr_seq_nota_fiscal,
	dt_contabil,
	nr_repasse_terceiro,
	nr_seq_tributo,
	nr_seq_trans_fin_baixa,
	nr_seq_trans_fin_contab,
	ds_observacao_titulo,
	NR_SEQ_CLASSE,
	nr_seq_reembolso,
	DT_LIBERACAO,
	NM_USUARIO_LIB,
	nr_seq_proj_rec
into STRICT	cd_estabelecimento_w,
	dt_emissao_w,
	dt_vencimento_w,
	dt_vencimento_original_w,
	vl_titulo_w,
	vl_titulo_estrang_w,
	vl_saldo_titulo_w, 
	cd_moeda_w,
	vl_cotacao_titulo_w,
	cd_tipo_taxa_juro_w,
	cd_tipo_taxa_multa_w,
	tx_desc_antecipacao_w,
	ie_situacao_w,
	ie_origem_titulo_w,
	ie_tipo_titulo_w,
	cd_pessoa_fisica_w,
	cd_cgc_w,
	nr_documento_w,
	nr_bloqueto_w,
	nr_seq_nota_fiscal_w,
	dt_contabil_w,
	nr_repasse_terceiro_w,
	nr_seq_tributo_w,
	nr_seq_trans_fin_baixa_w,
	nr_seq_trans_fin_contab_tit_w,
	ds_observacao_titulo_w,
	NR_SEQ_CLASSE_w,
	nr_seq_reembolso_w,
	DT_LIBERACAO_W,
	NM_USUARIO_LIB_W,
	nr_seq_proj_rec_w
from   	titulo_pagar
where 	nr_titulo  = nr_titulo_p;
end;

select	coalesce(cd_estab_financeiro, cd_estabelecimento)
into STRICT	cd_estab_financeiro_w
from	estabelecimento
where	cd_estabelecimento	= cd_estabelecimento_w;

select	nr_seq_trans_fin_desdob
into STRICT	nr_seq_trans_fin_contab_w
from	parametros_contas_pagar
where	cd_estabelecimento	= cd_estabelecimento_w;

ie_param_contab_tit_w := obter_param_usuario(851, 194, Obter_perfil_ativo, nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento, ie_param_contab_tit_w);
ie_liberar_tit_desdobrado_w := obter_param_usuario(851, 216, Obter_perfil_ativo, nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento, ie_liberar_tit_desdobrado_w);
if (ie_param_contab_tit_w = 'S') then
	nr_seq_trans_fin_contab_w := nr_seq_trans_fin_contab_tit_w;
end if;

select	count(*)
into STRICT	nr_desdobramentos_w
from	titulo_pagar_desdob
where	nr_titulo	= nr_titulo_p;

ds_desdobramentos_w := '';

/* Projeto Multimoeda - Se o titulo for em moeda estrangeira, busca a cotacao do dia para o desdobramento */

if (coalesce(vl_titulo_estrang_w,0) > 0 and coalesce(vl_cotacao_titulo_w,0) <> 0) then
	--vl_cotacao_w := obter_cotacao_moeda_financ(cd_moeda_w,sysdate);

	/*AAMFIRMO OS 1071939 - Se estou desdobrando um titulo, nao pode pegar a cotacao do dia em que a acao esta feita e sim pegar a cotacao do titulo original qdo o mesmo foi gerado.*/

	vl_cotacao_w:= vl_cotacao_titulo_w;
end if;

ie_tipo_data_emissao_w := obter_param_usuario(851, 264, obter_perfil_ativo, nm_usuario_p, obter_estabelecimento_ativo, ie_tipo_data_emissao_w);
if (ie_tipo_data_emissao_w = 'DA') then
	dt_emissao_tit_desd_w := clock_timestamp();
elsif (ie_tipo_data_emissao_w = 'DE')  then
	dt_emissao_tit_desd_w := dt_emissao_w;
end if;

ie_tipo_data_contabil_w := obter_param_usuario(851, 265, obter_perfil_ativo, nm_usuario_p, obter_estabelecimento_ativo, ie_tipo_data_contabil_w);
if (ie_tipo_data_contabil_w = 'DA') then
	dt_contabil_tit_desd_w := clock_timestamp();
elsif (ie_tipo_data_contabil_w = 'DC')  then
	dt_contabil_tit_desd_w := dt_contabil_w;
elsif (ie_tipo_data_contabil_w = 'DV')  then
	dt_contabil_tit_desd_w := dt_vencimento_w;
end if;

open	c01;
loop
fetch	c01 into
	dt_desdobramento_w,
	vl_desdobramento_w,
	nr_seq_desdob_w,
	vl_saldo_juros_w,
	vl_saldo_multa_w;
EXIT WHEN NOT FOUND; /* apply on c01 */

	begin

	/* ricardo 05/04/2006 - a pedido do marcus, inclui em todos os inserts da titulo pagar o campo nr_lote_transf_trib como 0 (zero) */

	select nextval('titulo_pagar_seq')
	into STRICT nr_seq_titulo_w
	;
	
	/* Projeto Multimoeda - Se o titulo for em moeda estrangeira, lanca o desdobramento na mesma moeda */

	if (coalesce(vl_titulo_estrang_w,0) > 0 and coalesce(vl_cotacao_titulo_w,0) <> 0) then
		vl_desdob_estrang_w := vl_desdobramento_w / coalesce(vl_cotacao_w,1);
	else
		vl_desdob_estrang_w := null;
		vl_cotacao_w := null;
	end if;

	insert into titulo_pagar(
		nr_titulo,
		cd_estabelecimento, 
		dt_atualizacao, 
		nm_usuario, 
		dt_emissao,
		dt_vencimento_original, 
		dt_vencimento_atual, 
		vl_titulo,
		vl_titulo_estrang,
		vl_saldo_titulo, 
		vl_saldo_juros, 
		vl_saldo_multa, 
		cd_moeda, 
		vl_cotacao,
		tx_juros, 
		tx_multa, 
		cd_tipo_taxa_juro, 
		cd_tipo_taxa_multa, 
		tx_desc_antecipacao, 
		ie_situacao, 
		ie_origem_titulo,
		ie_tipo_titulo, 
		cd_pessoa_fisica, 
		cd_cgc, 
		nr_documento, 
		nr_bloqueto, 
		nr_titulo_original, 
		nr_parcelas, 
		nr_total_parcelas, 
		dt_contabil, 
		nr_lote_contabil, 
		nr_seq_nota_fiscal, 	
		nr_repasse_terceiro,	
		nr_seq_tributo, 
		ie_status_tributo,
		nr_lote_transf_trib, 
		nr_seq_trans_fin_baixa, 
		cd_estab_financeiro,
		ds_observacao_titulo,
		nr_seq_trans_fin_contab,
		NR_SEQ_CLASSE,
		ie_status,
		nr_seq_reembolso,
		nr_seq_proj_rec)
	values (	nr_seq_titulo_w, 
		cd_estabelecimento_w, 
		clock_timestamp(), 
		nm_usuario_p, 
		dt_emissao_tit_desd_w, 
		dt_vencimento_original_w, 
		dt_desdobramento_w, 
		vl_desdobramento_w, 
		vl_desdob_estrang_w,
		vl_desdobramento_w, 
		vl_saldo_juros_w,
		vl_saldo_multa_w,
		cd_moeda_w, 
		vl_cotacao_w,
		0, 
		0, 
		cd_tipo_taxa_juro_w, 
		cd_tipo_taxa_multa_w, 
		tx_desc_antecipacao_w, 
		ie_situacao_w, 
		ie_origem_titulo_w, 
		ie_tipo_titulo_w, 
		cd_pessoa_fisica_w, 
		cd_cgc_w, 
		nr_documento_w, 
		nr_bloqueto_w, 
		nr_titulo_p, 
		(conta_titulo_w + 1), 
		nr_desdobramentos_w,
		dt_contabil_tit_desd_w, 
		0, 
		nr_seq_nota_fiscal_w, 	
		nr_repasse_terceiro_w,
		nr_seq_tributo_w, 
		'N',
		0,
		nr_seq_trans_fin_baixa_w, 
		cd_estab_financeiro_w,
		ds_observacao_titulo_w,
		nr_seq_trans_fin_contab_w,
		NR_SEQ_CLASSE_w,
		'D',
		nr_seq_reembolso_w,
		nr_seq_proj_rec_w);
	CALL ATUALIZAR_INCLUSAO_TIT_PAGAR(nr_seq_titulo_w, nm_usuario_p);

	update	titulo_pagar_desdob
	set	nr_titulo_dest	= nr_seq_titulo_w
	where	nr_sequencia	= nr_seq_desdob_w;
	/*aamfirmo 16/08/2013 OS 633168 - Liberar os titulos gerados no desdobramento se o titulo origem estiver liberado*/

	if (coalesce(ie_liberar_tit_desdobrado_w,'N') = 'S') and (dt_liberacao_w IS NOT NULL AND dt_liberacao_w::text <> '') and (nm_usuario_lib_w IS NOT NULL AND nm_usuario_lib_w::text <> '')  then
		update	titulo_pagar
		set	dt_liberacao	= clock_timestamp(),
		        nm_usuario_lib	= nm_usuario_lib_w
		where   nr_titulo	= nr_seq_titulo_w;	
	end if;

	/* fabio 17/09/2004 - inclui o cursor abaixo para gerar a classf ao fazer o desdobramento*/

	open	c02;
	loop
		fetch	c02 into
			nr_seq_classif_w,
			vl_classif_w,
			cd_conta_contabil_w,
			cd_centro_custo_w,
			nr_seq_conta_financ_w,
			nr_seq_trans_fin_classif_w;
		EXIT WHEN NOT FOUND; /* apply on c02 */
		begin
				
		select	max(ie_situacao)
		into STRICT	ie_centro_custo_w
		from	centro_custo
		where	cd_centro_custo = cd_centro_custo_w;

		ie_desdobra_param_w := obter_param_usuario(851, 136, Obter_perfil_ativo, nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento, ie_desdobra_param_w);	
	
		if (ie_centro_custo_w = 'I') and (ie_desdobra_param_w = 'S') then
			cd_centro_custo_w	:= null;
		end if;			

		insert into titulo_pagar_classif(
				nr_titulo,
				nr_sequencia,
				vl_titulo,
				dt_atualizacao,
				nm_usuario,
				cd_conta_contabil,
				cd_centro_custo,
				nr_seq_conta_financ,
				nr_seq_trans_fin)
			values (	nr_seq_titulo_w,
				nr_seq_classif_w,
				dividir_sem_round(vl_desdobramento_w,vl_titulo_w) * vl_classif_w,
				clock_timestamp(),
				nm_usuario_p,
				cd_conta_contabil_w,
				cd_centro_custo_w,
				nr_seq_conta_financ_w,
				nr_seq_trans_fin_classif_w);
		end;
	end loop;
	close c02;

	select	coalesce(sum(vl_titulo),0)
	into STRICT	vl_classif_w
	from	titulo_pagar_classif
	where	nr_titulo	= nr_seq_titulo_w;

	if (vl_classif_w > 0) and (vl_classif_w <> vl_desdobramento_w) then
		update	titulo_pagar_classif
		set	vl_titulo	= vl_titulo + (vl_desdobramento_w - vl_classif_w)
		where	nr_titulo	= nr_seq_titulo_w
		and	nr_sequencia	= 1;

	end if;

	ds_desdobramentos_w := ds_desdobramentos_w || ', ' || nr_seq_titulo_w;

	conta_titulo_w := conta_titulo_w + 1;
	end;
end loop;
close c01;

open c03; /* francisco - os 60897 - 04/07/2007 - criada a rotina para cancelar os titulos de impostos do titulo principal */
loop
fetch c03 into
	nr_titulo_imposto_w;
EXIT WHEN NOT FOUND; /* apply on c03 */
	CALL cancelar_titulo_pagar(nr_titulo_imposto_w,nm_usuario_p, clock_timestamp());
end loop;
close c03;

if (ds_desdobramentos_w IS NOT NULL AND ds_desdobramentos_w::text <> '') then
	--ds_desdobramentos_w := 'Desdobramentos: ' || substr(ds_desdobramentos_w, 2, length(ds_desdobramentos_w));
	ds_desdobramentos_w := wheb_mensagem_pck.get_texto(303969,'DS_DESDOBRAMENTOS_W='||substr(ds_desdobramentos_w, 2, length(ds_desdobramentos_w)));
	ds_desdobramentos_w := substr(ds_desdobramentos_w, 1,255);
end if;

/* paulo - os 54992 - 20/04/2007 - criada a rotina abaixo para lancar alteracao de valor ao desdobrar um titulo */

select	coalesce(max(nr_sequencia),0)+1
into STRICT	nr_seq_alt_valor_w
from	titulo_pagar_alt_valor
where	nr_titulo	= nr_titulo_p;

insert into titulo_pagar_alt_valor(
	cd_moeda,
	ds_observacao,
	dt_alteracao,
	dt_atualizacao,
	nm_usuario,
	nr_sequencia,
	nr_titulo,
	vl_alteracao,
	vl_anterior)
values (	cd_moeda_w,
	'',
	coalesce(dt_alteracao_p, clock_timestamp()),
	clock_timestamp(),
	nm_usuario_p,
	nr_seq_alt_valor_w,
	nr_titulo_p,
	0,
	vl_saldo_titulo_w);

CALL atualizar_tit_pagar_classif(nr_titulo_p,'N',nm_usuario_p);

CALL atualizar_saldo_tit_pagar(nr_titulo_p, nm_usuario_p);
CALL Gerar_W_Tit_Pag_imposto(nr_titulo_p,nm_usuario_p);

if	((coalesce(length(ds_observacao_titulo_w),0) + length(ds_desdobramentos_w) + 1) <= 4000) then	/* ahoffelder - OS 358446 - 06/09/2011 */
	
	update 	titulo_pagar
	set 	ds_observacao_titulo = 	substr(ds_observacao_titulo || CASE WHEN ds_observacao_titulo='' THEN ''  ELSE chr(13) END  || ds_desdobramentos_w, 1, 254)
	where	nr_titulo = nr_titulo_p;	
	
end if;

commit;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE desdobramento_titulo_pagar ( nr_titulo_p bigint, nm_usuario_p text, dt_alteracao_p timestamp, ie_gera_tributos_p text) FROM PUBLIC;

