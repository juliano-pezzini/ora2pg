-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_horario_escala_gestao ( nr_seq_escala_p bigint, dt_inicial_p timestamp, dt_final_p timestamp, ie_forma_tratar_horario_p bigint, nm_usuario_p text) AS $body$
DECLARE


cont_fds_w		smallint := 0;
ie_dia_semana_ww		smallint;
ie_gerar_escala_w		boolean := false;
ie_alternar_dias_w		varchar(1);
ie_dia_semana_w		smallint;
cd_estabelecimento_w	integer;
dt_inicial_w		timestamp;
dt_final_w		timestamp;
dt_escala_w		timestamp;
dt_escala_aux_w		timestamp;
hr_atual_w		timestamp;
hr_inicial_w		timestamp;
dt_atual_ww		timestamp;
hr_final_w		timestamp;
qt_escala_w		integer;
nr_sequencia_w		bigint    := 0;
ie_completa_w		varchar(1);
ie_feriado_w		varchar(1);
ie_gerar_todos_hor_w	varchar(1);
cd_pessoa_fisica_w	varchar(10);
qt_escala_dup_w		integer;
qt_dia_semana_w		integer;
ie_dia_semana_mes_w	varchar(5);
cd_cbo_sus_w		integer;
cd_profissional_w		varchar(10);
nr_seq_escala_horario_w	bigint;
qt_dias_periodo_p		bigint;

C01 CURSOR FOR
SELECT 	a.hr_inicial,
	a.hr_final,
	a.cd_pessoa_fisica,
	a.ie_dia_semana_mes,
	a.cd_cbo_sus,
	a.nr_sequencia,
	coalesce(ie_alternar_dias,'N'),
	ie_dia_semana
From 	Escala_Horario a
where 	a.nr_seq_escala	= nr_seq_escala_p
and	(((a.ie_dia_semana	= ie_dia_Semana_w) or (a.ie_dia_semana = 0)) or (a.ie_dia_semana = 10) and ie_dia_semana_w in (7,1))
and	((coalesce(a.ie_dia_semana_mes::text, '') = '') or (a.ie_dia_semana_mes = ie_dia_semana_mes_w))
and	CASE WHEN ie_feriado='S' THEN CASE WHEN ie_feriado_w='S' THEN 'S'  ELSE 'N' END  WHEN ie_feriado='F' THEN CASE WHEN ie_feriado_w='S' THEN 'N'  ELSE 'S' END   ELSE 'S' END  = 'S'
and	trunc(coalesce(dt_inicio_vigencia,dt_escala_w-1),'dd') <= dt_escala_w

Union

Select	hr_inicial,
	hr_final,
	cd_pessoa_fisica,
	ie_dia_semana_mes,
	cd_cbo_sus,
	nr_sequencia,
	coalesce(ie_alternar_dias,'N'),
	ie_dia_semana
From 	Escala_Horario
Where 	nr_seq_escala	= nr_seq_escala_p
and	ie_dia_semana	= 9
and	ie_dia_semana_w between 2 and 6
and	CASE WHEN ie_feriado='S' THEN CASE WHEN ie_feriado_w='S' THEN 'S'  ELSE 'N' END  WHEN ie_feriado='F' THEN CASE WHEN ie_feriado_w='S' THEN 'N'  ELSE 'S' END   ELSE 'S' END  = 'S'
and	trunc(coalesce(dt_inicio_vigencia,dt_escala_w-1),'dd') <= dt_escala_w
and	(not exists (
	SELECT 1
	from 	Escala_horario
	where 	nr_seq_escala	= nr_seq_escala_p
	and 	((ie_dia_semana	= ie_dia_Semana_w) or (ie_dia_Semana = '0'))) or (ie_gerar_todos_hor_w = 'S'))
order by 1,2;

C02 CURSOR FOR
SELECT	dt_inicio,
	dt_fim
From 	Escala_Diaria
where 	nr_seq_escala		= nr_seq_escala_p
and	dt_inicio between dt_inicial_w and dt_final_w
and	ie_completa_w		= 'S'
order by 1,2;

C03 CURSOR FOR
	SELECT	cd_profissional
	from	escala_horario_adic
	where	nr_seq_escala = nr_seq_escala_horario_w
	order by cd_profissional;


BEGIN

dt_inicial_w		:= trunc(dt_inicial_p,'dd');
dt_final_w		:= fim_dia(dt_final_p);

select	coalesce(max(ie_completa),'N'),
	coalesce(max(ie_gerar_todos_hor),'N')
into STRICT	ie_completa_w,
	ie_gerar_todos_hor_w
from	escala
where	nr_sequencia	= nr_seq_escala_p;

select	c.cd_estabelecimento
into STRICT	cd_estabelecimento_w
from	escala_classif c,
	escala_grupo b,
	escala a
where	a.nr_sequencia	= nr_seq_escala_p
and	a.nr_seq_grupo	= b.nr_sequencia
and	b.nr_seq_classif	= c.nr_sequencia;

delete	from escala_diaria
where	nr_seq_escala	= nr_seq_escala_p
and	coalesce(cd_pessoa_fisica::text, '') = ''
and	dt_inicio		>= dt_inicial_w
and	dt_fim		<= dt_final_w
and	ie_forma_tratar_horario_p = 1;
commit;

dt_escala_w	:= dt_inicial_w;

WHILE dt_escala_w <= dt_final_w LOOP

	select	pkg_date_utils.get_WeekDay(dt_escala_w)
	into STRICT	ie_dia_semana_w
	;

	select	CASE WHEN obter_se_feriado(cd_estabelecimento_w, trunc(dt_escala_w,'dd'))=0 THEN 'N'  ELSE 'S' END
	into STRICT	ie_feriado_w
	;

	qt_dia_semana_w		:= 0;
	ie_dia_semana_mes_w	:= 0;
	dt_escala_aux_w		:= trunc(dt_final_w,'mm');

	while	dt_escala_aux_w <= trunc(dt_escala_w, 'dd') loop

		if (pkg_date_utils.get_WeekDay(dt_escala_aux_w) = ie_dia_semana_w) then
			qt_dia_semana_w		:= qt_dia_semana_w + 1;
			ie_dia_semana_mes_w	:= qt_dia_semana_w;
		end if;

		if (qt_dia_semana_w = 6) then
			qt_dia_semana_w		:= 1;
			ie_dia_semana_mes_w	:= 1;
		end if;

		dt_escala_aux_w	:= dt_escala_aux_w + 1;

	end loop;


	OPEN C01;
	LOOP
	FETCH C01 into
		hr_inicial_w,
		hr_final_w,
		cd_pessoa_fisica_w,
		ie_dia_semana_mes_w,
		cd_cbo_sus_w,
		nr_seq_escala_horario_w,
		ie_alternar_dias_w,
		ie_dia_semana_ww;
	EXIT WHEN NOT FOUND; /* apply on c01 */

		select	coalesce(qt_dias_periodo_escala,0)
		into STRICT	qt_dias_periodo_p
		from	escala_horario
		where	nr_sequencia = nr_seq_escala_horario_w;

		hr_inicial_w	:= to_date(to_char(dt_escala_w,'dd/mm/yyyy') || ' ' ||
				to_char(hr_inicial_w,'hh24:mi:ss'),
				'dd/mm/yyyy hh24:mi:ss');

		hr_final_w	:= to_date(to_char(dt_escala_w,'dd/mm/yyyy') || ' ' ||
				to_char(hr_final_w,'hh24:mi:ss'),
				'dd/mm/yyyy hh24:mi:ss');

		if (qt_dias_periodo_p > 0) then
			hr_final_w := hr_final_w + qt_dias_periodo_p;
		end if;

		select	count(*)
		into STRICT	qt_escala_w
		from	escala_diaria a
		where	nr_seq_escala		= nr_seq_escala_p
		and		dt_inicio		= hr_inicial_w;

		if (hr_final_w < hr_inicial_w) then
			hr_final_w	:= hr_final_w + 1;
		end if;

		qt_escala_dup_w := 0;

		if (ie_forma_tratar_horario_p = 0) then

			select	count(*)
			into STRICT	qt_escala_dup_w
			from	escala_diaria a
			where	nr_seq_escala		= nr_seq_escala_p
			and	dt_inicio		= hr_inicial_w
			and	dt_fim			= hr_final_w
			and	ie_feriado		= coalesce(ie_feriado_w,'N');

		end if;

		if (qt_escala_w = 0) and (qt_escala_dup_w = 0) then

			if (ie_alternar_dias_w = 'S') then
					ie_gerar_escala_w := not ie_gerar_escala_w;
					if (ie_dia_semana_ww = 10) then
							ie_gerar_escala_w := true;
							cont_fds_w := cont_fds_w + 1;
							if (cont_fds_w > 2) then
								ie_gerar_escala_w := false;
								if (cont_fds_w = 4) then
									cont_fds_w := 0;
								end if;
							end if;
					end if;
			end if;

			if		(ie_alternar_dias_w = 'S' AND ie_gerar_escala_w) or (ie_alternar_dias_w = 'N') then
			begin

			select	nextval('escala_diaria_seq')
			into STRICT	nr_sequencia_w
			;

			insert into escala_diaria(
				nr_sequencia,
				nr_seq_escala,
				dt_atualizacao,
				nm_usuario,
				dt_inicio,
				dt_fim,
				ie_feriado,
				cd_pessoa_fisica,
				cd_cbo_sus,
				ie_profis_aleatorio,
				dt_atualizacao_nrec,
				nm_usuario_nrec)
			values (
				nr_sequencia_w,
				nr_seq_escala_p,
				clock_timestamp(),
				nm_usuario_p,
				hr_inicial_w,
				hr_final_w,
				coalesce(ie_feriado_w,'N'),
				cd_pessoa_fisica_w,
				cd_cbo_sus_w,
				'N',
				clock_timestamp(),
				nm_usuario_p);

			open C03;
			loop
			fetch C03 into
				cd_profissional_w;
			EXIT WHEN NOT FOUND; /* apply on C03 */
				begin

				insert	into escala_diaria_adic(
					cd_pessoa_fisica,
					dt_atualizacao,
					dt_atualizacao_nrec,
					nm_usuario,
					nm_usuario_nrec,
					nr_seq_escala_diaria,
					nr_sequencia)
				values (	cd_profissional_w,
					clock_timestamp(),
					clock_timestamp(),
					nm_usuario_p,
					nm_usuario_p,
					nr_sequencia_w,
					nextval('escala_diaria_adic_seq'));

				end;
			end loop;
			close C03;
			end;
			end if;
		end if;
	END LOOP;
	CLOSE C01;
dt_escala_w		:= dt_escala_w + 1;
END LOOP;
commit;

hr_atual_w		:= trunc(dt_inicial_w,'dd');
OPEN C02;
LOOP
FETCH C02 into
	hr_inicial_w,
	hr_final_w;
EXIT WHEN NOT FOUND; /* apply on c02 */

	qt_escala_dup_w := 0;

	if (ie_forma_tratar_horario_p = 0) then

		select	count(*)
		into STRICT	qt_escala_dup_w
		from	escala_diaria a
		where	nr_seq_escala	= nr_seq_escala_p
		and	dt_inicio		= coalesce(dt_atual_ww,hr_atual_w)
		and	dt_fim		= hr_inicial_w
		and	ie_feriado		= coalesce(ie_feriado_w,'N');
	end if;

	if (hr_atual_w < hr_inicial_w)and (qt_escala_dup_w = 0)  then

		select	nextval('escala_diaria_seq')
		into STRICT	nr_sequencia_w
		;

		insert into escala_diaria(
			nr_sequencia,
			nr_seq_escala,
			dt_atualizacao,
			nm_usuario,
			dt_inicio,
			dt_fim,
			ie_feriado,
			ie_profis_aleatorio,
			dt_atualizacao_nrec,
			nm_usuario_nrec)
		values (	nr_sequencia_w,
			nr_seq_escala_p,
			clock_timestamp(),
			nm_usuario_p,
			coalesce(dt_atual_ww,hr_atual_w),
			hr_inicial_w,
			coalesce(ie_feriado_w,'N'),
			'N',
			clock_timestamp(),
			nm_usuario_p);

	end if;

	hr_atual_w			  := hr_inicial_w;
	dt_atual_ww			  := to_date(to_char(hr_atual_w,'dd/mm/yyyy') || ' ' ||	to_char(hr_final_w,'hh24:mi:ss'),'dd/mm/yyyy hh24:mi:ss');

END LOOP;
CLOSE C02;
commit;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_horario_escala_gestao ( nr_seq_escala_p bigint, dt_inicial_p timestamp, dt_final_p timestamp, ie_forma_tratar_horario_p bigint, nm_usuario_p text) FROM PUBLIC;

