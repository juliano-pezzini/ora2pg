-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE define_conta_terceiro (nr_seq_pep_med_fatur_p bigint, nm_usuario_p text) AS $body$
DECLARE

 
dt_liberacao_w		timestamp;	
qt_conta_aberta_w		bigint;	
nr_seq_conta_w		bigint;	
dt_faturamento_w	timestamp;
ie_permite_valor_w	varchar(1);
nr_atendimento_w	bigint;
nr_seq_conta_terceiro_w	bigint;
ie_trat_conta_rn_w	varchar(15);
nr_atendimento_mae_w	bigint;
				

BEGIN 
 
ie_permite_valor_w:= 'N';
begin 
select 	dt_faturamento, 
	coalesce(Obter_se_permite_valor(nr_seq_regra_cobranca),'N'), 
	nr_atendimento, 
	dt_liberacao, 
	coalesce(nr_seq_conta_terceiro,0) 
into STRICT	dt_faturamento_w, 
	ie_permite_valor_w, 
	nr_atendimento_w, 
	dt_liberacao_w, 
	nr_seq_conta_terceiro_w 
from 	pep_med_fatur 
where	nr_sequencia = nr_seq_pep_med_fatur_p;
exception 
	when others then 
	dt_faturamento_w:= null;
	ie_permite_valor_w:= 'N';
	nr_atendimento_w:= 0;
	dt_liberacao_w:= null;
	nr_seq_conta_terceiro_w:= 0;
end;	
 
if (ie_permite_valor_w = 'S') and (nr_seq_conta_terceiro_w = 0) then 
	 
	select 	max(ie_trat_conta_rn), 
		max(nr_atendimento_mae) 
	into STRICT	ie_trat_conta_rn_w, 
		nr_atendimento_mae_w 
	from 	atendimento_paciente 
	where	nr_atendimento = nr_atendimento_w;
	 
	if (ie_trat_conta_rn_w = 'Mãe') and (coalesce(nr_atendimento_mae_w,0) > 0) then 
		nr_atendimento_w := nr_atendimento_mae_w;
	end if;
	 
	-- Ver se tem alguma conta aberta para o mês 
	select	count(*) 
	into STRICT	qt_conta_aberta_w 
	from	conta_terceiro 
	where 	trunc(dt_mesano_referencia,'month') = trunc(dt_faturamento_w,'month') 
	and 	nr_atendimento = nr_atendimento_w 
	and 	ie_status = 1;
 
	if (qt_conta_aberta_w > 0) then		 
	 
		select	max(nr_sequencia)		 
		into STRICT	nr_seq_conta_w 
		from	conta_terceiro 
		where 	trunc(dt_mesano_referencia,'month') = trunc(dt_faturamento_w,'month') 
		and 	coalesce(nr_atendimento,nr_atendimento_w) = nr_atendimento_w 
		and 	ie_status = 1;
		 
		update	pep_med_fatur 
		set	nr_seq_conta_terceiro = nr_seq_conta_w 
		where 	nr_sequencia = nr_seq_pep_med_fatur_p;
		 
	else 
	 
 
		select 	nextval('conta_terceiro_seq') 
		into STRICT	nr_seq_conta_w 
		;
				 
		insert into conta_terceiro(nr_sequencia, 
			dt_atualizacao, 
			nm_usuario, 
			dt_atualizacao_nrec, 
			nm_usuario_nrec, 
			dt_mesano_referencia, 
			nr_atendimento, 
			ie_status) 
		values (nr_seq_conta_w, 
			clock_timestamp(), 
			nm_usuario_p, 
			clock_timestamp(), 
			nm_usuario_p, 
			trunc(dt_faturamento_w,'month'), 
			nr_atendimento_w, 
			1);
 
		update	pep_med_fatur 
		set	nr_seq_conta_terceiro = nr_seq_conta_w 
		where 	nr_sequencia = nr_seq_pep_med_fatur_p;
	 
	end if;
	 
end if;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE define_conta_terceiro (nr_seq_pep_med_fatur_p bigint, nm_usuario_p text) FROM PUBLIC;

