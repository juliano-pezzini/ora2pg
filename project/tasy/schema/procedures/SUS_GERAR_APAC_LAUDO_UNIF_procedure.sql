-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE sus_gerar_apac_laudo_unif ( nr_apac_p bigint, nr_atendimento_p bigint, cd_motivo_cobranca_p bigint, cd_medico_p text, cd_setor_atendimento_p bigint, nm_usuario_p text) AS $body$
DECLARE



cd_procedimento_w	bigint;
ie_origem_proced_w	bigint;
dt_emissao_w		timestamp;
cd_estabelecimento_w	smallint;
cd_estab_usuario_w	smallint;
cd_medico_resp_w		varchar(10);
cd_pessoa_fisica_w	varchar(10);
nr_sequencia_w		bigint;
cd_motivo_cobranca_w	smallint;
cd_setor_atendimento_w	integer;
dt_competencia_apac_w	timestamp;
dt_inicio_val_apac_w	timestamp;
dt_fim_val_apac_w		timestamp;
cd_medico_autorizador_w	varchar(10);
cd_cid_principal_w		varchar(4);
cd_cid_secundario_w	varchar(4);
cd_cid_causa_assoc_w	varchar(4);
dt_inicio_trat_solic_w	timestamp;
dt_diagnostico_w		timestamp;
dt_pri_tratamento_w	timestamp;
dt_seg_tratamento_w	timestamp;
dt_ter_tratamento_w	timestamp;
ie_finalidade_w		varchar(3);
ie_lifonodos_reg_inval_w 	varchar(1);
ie_tratamento_ant_w	varchar(1);
cd_grau_histopat_w	integer;
dt_diag_cito_hist_w		timestamp;
ie_carater_inter_sus_w	varchar(2);
ds_sigla_esquema_w	varchar(40);
qt_meses_prev_w		smallint;
qt_meses_autorizado_w	integer;
cd_estadio_w		smallint;
cd_cid_pri_radiacao_w	varchar(4);
cd_cid_seg_radiacao_w	varchar(4);
cd_cid_ter_radiacao_w	varchar(4);
nr_campos_pri_radi_w	smallint;
nr_campos_seg_radi_w	smallint;
nr_campos_ter_radi_w	smallint;
cd_doenca_cid_w		varchar(4);
qt_cursor_w		bigint := 1;
nr_seq_interno_w		bigint;
nr_seq_interno_ww		bigint;
qt_insercoes_area_w	smallint;
cd_cid_topografia_w	varchar(10);
cd_cid_prim_trat_w		varchar(4);
cd_cid_seg_trat_w		varchar(4);
cd_cid_terc_trat_w		varchar(4);
dt_inicio_pri_radi_w		timestamp;
dt_inicio_seg_radi_w	timestamp;
dt_inicio_ter_radi_w		timestamp;
dt_fim_pri_radi_w		timestamp;
dt_fim_seg_radi_w		timestamp;
dt_fim_ter_radi_w		timestamp;
dt_inicio_rad_w		timestamp;
dt_fim_rad_w		timestamp;
dt_ocorrencia_w		timestamp	:= null;
dt_pri_dialise_w		timestamp;
qt_altura_cm_w		smallint;
qt_peso_w		real;
qt_diurese_w		smallint;
qt_glicose_w		smallint;
pr_albumina_w		real;
pr_hb_w			real;
nr_tru_w			double precision;
ie_acesso_vascular_w	varchar(1);
ie_hiv_w			varchar(1);
ie_hcv_w			varchar(1);
ie_hb_sangue_w		varchar(1);
ie_ultra_abdomen_w	varchar(1);
ie_inscrito_cncdo_w	varchar(1);
nr_seq_pri_trat_w		bigint;
nr_seq_seg_trat_w		bigint;
nr_seq_ter_trat_w		bigint;
nr_interno_conta_w		bigint;
qt_conta_apac_w		bigint;
ie_atualiza_medico_resp_w	varchar(10) := 'N';
ie_gerar_proced_w		varchar(1) := 'N';
ie_verif_conta_proc_w	varchar(15) := 'N';
ie_verif_conta_apac_w	varchar(15) := 'N';
ie_medico_laudo_w	varchar(15) := 'N';
cd_medico_requisitante_w	varchar(10);
ie_verf_conta_compet_w	varchar(15) := 'N';
dt_retorno_secr_w		timestamp;
dt_autorizacao_w		timestamp;
ie_utiliza_dt_retorno_w	varchar(15) := 'N';
ie_reabre_atendimento_w		varchar(15) := 'N';
qt_atendimento_fechado_w	bigint := 0;
ie_tipo_apac_w			sus_apac_unif.ie_tipo_apac%type;
ie_dt_final_apac_w		varchar(15) := 'N';
dt_inicio_dialise_cli_w		sus_laudo_paciente.dt_inicio_dialise_cli%type;
ie_caract_tratamento_w          sus_laudo_paciente.ie_caract_tratamento%type;
ie_acesso_vasc_dial_w           sus_laudo_paciente.ie_acesso_vasc_dial%type;
ie_acomp_nefrol_w               sus_laudo_paciente.ie_acomp_nefrol%type;
ie_situacao_usu_ini_w           sus_laudo_paciente.ie_situacao_usu_ini%type;
ie_situacao_trasp_w             sus_laudo_paciente.ie_situacao_trasp%type;
ie_dados_apto_w                 sus_laudo_paciente.ie_dados_apto%type;
qt_fosforo_w                    sus_laudo_paciente.qt_fosforo%type;
qt_ktv_semanal_w                sus_laudo_paciente.qt_ktv_semanal%type;
qt_pth_w                        sus_laudo_paciente.qt_pth%type;
ie_inter_clinica_w              sus_laudo_paciente.ie_inter_clinica%type;
ie_peritonite_diag_w            sus_laudo_paciente.ie_peritonite_diag%type;
ie_encaminhado_fav_w            sus_laudo_paciente.ie_encaminhado_fav%type;
ie_encam_imp_cateter_w          sus_laudo_paciente.ie_encam_imp_cateter%type;
ie_situacao_vacina_w            sus_laudo_paciente.ie_situacao_vacina%type;
ie_anti_hbs_w                   sus_laudo_paciente.ie_anti_hbs%type;
ie_influenza_w                  sus_laudo_paciente.ie_influenza%type;
ie_difteria_tetano_w            sus_laudo_paciente.ie_difteria_tetano%type;
ie_pneumococica_w               sus_laudo_paciente.ie_pneumococica%type;
ie_ieca_w                       sus_laudo_paciente.ie_ieca%type;
ie_bra_w                        sus_laudo_paciente.ie_bra%type;
ie_duplex_previo_w              sus_laudo_paciente.ie_duplex_previo%type;
ie_cateter_outros_w             sus_laudo_paciente.ie_cateter_outros%type;
ie_fav_previas_w                sus_laudo_paciente.ie_fav_previas%type;
ie_flebites_w                   sus_laudo_paciente.ie_flebites%type;
ie_hematomas_w                  sus_laudo_paciente.ie_hematomas%type;
ie_veia_visivel_w               sus_laudo_paciente.ie_veia_visivel%type;
ie_presenca_pulso_w             sus_laudo_paciente.ie_presenca_pulso%type;
qt_diametro_veia_w              sus_laudo_paciente.qt_diametro_veia%type;
qt_diametro_arteria_w           sus_laudo_paciente.qt_diametro_arteria%type;
ie_fremito_traj_fav_w           sus_laudo_paciente.ie_fremito_traj_fav%type;
ie_pulso_fremito_w              sus_laudo_paciente.ie_pulso_fremito%type;
cd_convenio_sus_w		parametro_faturamento.cd_convenio_sus%type;
cd_pessoa_fis_laudo_w		varchar(10);
ie_comorbidades_w		sus_laudo_bariatrico.ie_comorbidades%type;
cd_cid_w			sus_laudo_bariatrico.cd_cid%type;
ie_uso_medicamentos_w		sus_laudo_bariatrico.ie_uso_medicamentos%type;
ie_prat_ativ_fisica_w		sus_laudo_bariatrico.ie_prat_ativ_fisica%type;
qt_imc_atual_w			sus_laudo_bariatrico.qt_imc_atual%type;
qt_perc_exc_peso_w		sus_laudo_bariatrico.qt_perc_exc_peso%type;
qt_kg_perdidos_w		sus_laudo_bariatrico.qt_kg_perdidos%type;
ie_gastrec_duodenal_w		sus_laudo_bariatrico.ie_gastrec_duodenal%type;
ie_gastrec_vertical_w		sus_laudo_bariatrico.ie_gastrec_vertical%type;
ie_gastrop_intestinal_w		sus_laudo_bariatrico.ie_gastrop_intestinal%type;
ie_gastrop_vertical_w		sus_laudo_bariatrico.ie_gastrop_vertical%type;
ie_dermo_abdominal_w		sus_laudo_bariatrico.ie_dermo_abdominal%type;
ie_mamoplastia_w		sus_laudo_bariatrico.ie_mamoplastia%type;
ie_dermo_braquial_w		sus_laudo_bariatrico.ie_dermo_braquial%type;
ie_dermo_crural_w		sus_laudo_bariatrico.ie_dermo_crural%type;
ie_dermo_circun_w		sus_laudo_bariatrico.ie_dermo_circun%type;
qt_tempo_dermo_abdominal_w	sus_laudo_bariatrico.qt_tempo_dermo_abdominal%type;
qt_tempo_mamoplastia_w		sus_laudo_bariatrico.qt_tempo_mamoplastia%type;
qt_tempo_dermo_braquial_w	sus_laudo_bariatrico.qt_tempo_dermo_braquial%type;
qt_tempo_dermo_crural_w		sus_laudo_bariatrico.qt_tempo_dermo_crural%type;
qt_tempo_dermo_circun_w		sus_laudo_bariatrico.qt_tempo_dermo_circun%type;
qt_mes_acompanhamento_w		sus_laudo_bariatrico.qt_mes_acompanhamento%type;
qt_ano_acompanhamento_w		sus_laudo_bariatrico.qt_ano_acompanhamento%type;
ie_uso_polivitaminico_w		sus_laudo_bariatrico.ie_uso_polivitaminico%type;
ie_houve_reganho_peso_w		sus_laudo_bariatrico.ie_houve_reganho_peso%type;
ie_houve_adesao_w		sus_laudo_bariatrico.ie_houve_adesao%type;
dt_cirur_bariatrica_w		sus_laudo_bariatrico.dt_cirur_bariatrica%type;
nr_aih_bariatrica_w		sus_laudo_bariatrico.nr_aih_bariatrica%type;
ie_hipertensao_w		sus_laudo_bariatrico.ie_hipertensao%type;
ie_diabetes_w			sus_laudo_bariatrico.ie_diabetes%type;
ie_dislipidemia_w		sus_laudo_bariatrico.ie_dislipidemia%type;
ie_artrose_w			sus_laudo_bariatrico.ie_artrose%type;
ie_apneia_w			sus_laudo_bariatrico.ie_apneia%type;

c01 CURSOR FOR
	SELECT	cd_doenca_cid,
		qt_insercoes_area,
		dt_inicio,
		dt_termino
	from	sus_laudo_area_irradiada
	where	nr_seq_laudo	= nr_seq_interno_w  LIMIT 3;


BEGIN

begin
cd_estab_usuario_w := wheb_usuario_pck.get_cd_estabelecimento;
exception
when others then
	cd_estab_usuario_w := 0;
end;

ie_atualiza_medico_resp_w	:= obter_valor_param_usuario(1124,27,obter_perfil_ativo,nm_usuario_p,coalesce(cd_estab_usuario_w,0));
ie_gerar_proced_w		:= obter_valor_param_usuario(1124,42,obter_perfil_ativo,nm_usuario_p,coalesce(cd_estab_usuario_w,0));
ie_verif_conta_proc_w	:= obter_valor_param_usuario(1124,53,obter_perfil_ativo,nm_usuario_p,coalesce(cd_estab_usuario_w,0));
ie_verif_conta_apac_w	:= obter_valor_param_usuario(1124,54,obter_perfil_ativo,nm_usuario_p,coalesce(cd_estab_usuario_w,0));
ie_medico_laudo_w		:= obter_valor_param_usuario(1124,66,obter_perfil_ativo,nm_usuario_p,coalesce(cd_estab_usuario_w,0));
ie_verf_conta_compet_w	:= obter_valor_param_usuario(1124,69,obter_perfil_ativo,nm_usuario_p,coalesce(cd_estab_usuario_w,0));
ie_utiliza_dt_retorno_w	:= obter_valor_param_usuario(1124,91,obter_perfil_ativo,nm_usuario_p,coalesce(cd_estab_usuario_w,0));
ie_reabre_atendimento_w	:= coalesce(obter_valor_param_usuario(1124,127,obter_perfil_ativo,nm_usuario_p,cd_estab_usuario_w),'N');
ie_dt_final_apac_w	:= coalesce(obter_valor_param_usuario(1124,90,obter_perfil_ativo,nm_usuario_p,cd_estab_usuario_w),'N');

/* Obter dados do atendimento */

select	cd_estabelecimento,
	cd_medico_resp,
	cd_pessoa_fisica,
	ie_carater_inter_sus
into STRICT	cd_estabelecimento_w,
	cd_medico_resp_w,
	cd_pessoa_fisica_w,
	ie_carater_inter_sus_w
from	atendimento_paciente
where	nr_atendimento	= nr_atendimento_p;

/* Obter dados do laudo */

if (coalesce(nr_apac_p,0) <> 0) then
	begin
	
	begin
	select	coalesce(a.cd_pessoa_fisica,'X')
	into STRICT	cd_pessoa_fis_laudo_w
	from	atendimento_paciente a,
		sus_laudo_paciente b
	where	a.nr_atendimento = b.nr_atendimento
	and	b.nr_apac = nr_apac_p;	
	exception
	when others then
		cd_pessoa_fis_laudo_w := 'X';
	end;
	
	if (coalesce(cd_pessoa_fis_laudo_w,'X') <> coalesce(cd_pessoa_fisica_w,'X')) then
		begin
		CALL wheb_mensagem_pck.exibir_mensagem_abort(1012115);
		end;
	end if;
	
	begin
	select	cd_procedimento_solic,
		ie_origem_proced,
		dt_emissao,
		coalesce(dt_inicio_val_apac,clock_timestamp()),
		coalesce(dt_fim_val_apac,clock_timestamp()),
		dt_inicio_trat_solic,
		dt_diagnostico,
		dt_pri_tratamento,
		dt_seg_tratamento,
		dt_ter_tratamento,
		CASE WHEN ie_finalidade=2 THEN 4 WHEN ie_finalidade=3 THEN 5 WHEN ie_finalidade=5 THEN 2 WHEN ie_finalidade=6 THEN 6 WHEN ie_finalidade=7 THEN 3 WHEN ie_finalidade=9 THEN 1  ELSE 1 END ,
		ie_lifonodos_reg_inval,
		ie_tratamento_ant,
		cd_grau_histopat,
		dt_diag_cito_hist,
		ds_sigla_esquema,
		qt_meses_prev,
		qt_meses_autorizado,
		cd_cid_principal,
		nr_seq_interno,
		replace(cd_cid_topografia,'.',''),
		cd_cid_prim_trat,
		cd_cid_seg_trat,
		cd_cid_terc_trat,
		cd_cid_secundario,
		cd_cid_causa_assoc,
		dt_pri_dialise,
		qt_altura_cm,
		qt_peso,
		qt_diurese,
		qt_glicose,
		pr_albumina,
		pr_hb,
		nr_tru,
		ie_acesso_vascular,
		ie_hiv,
		ie_hcv,
		ie_hb_sangue,
		ie_ultra_abdomen,
		ie_inscrito_cncdo,
		nr_seq_pri_trat,
		nr_seq_seg_trat,
		nr_seq_ter_trat,
		coalesce(cd_medico_requisitante,cd_profis_requisitante),
		coalesce(dt_retorno_secr,clock_timestamp()),
		dt_inicio_dialise_cli,
		ie_caract_tratamento,
		ie_acesso_vasc_dial,
		ie_acomp_nefrol,
		ie_situacao_usu_ini,
		ie_situacao_trasp,
		ie_dados_apto,
		qt_fosforo,
		qt_ktv_semanal,
		qt_pth,
		ie_inter_clinica,
		ie_peritonite_diag,
		ie_encaminhado_fav,
		ie_encam_imp_cateter,
		ie_situacao_vacina,
		ie_anti_hbs,
		ie_influenza,
		ie_difteria_tetano,
		ie_pneumococica,
		ie_ieca,
		ie_bra,
		ie_duplex_previo,
		ie_cateter_outros,
		ie_fav_previas,
		ie_flebites,
		ie_hematomas,
		ie_veia_visivel,
		ie_presenca_pulso,
		qt_diametro_veia,
		qt_diametro_arteria,
		ie_fremito_traj_fav,
		ie_pulso_fremito
	into STRICT	cd_procedimento_w,
		ie_origem_proced_w,
		dt_emissao_w,
		dt_inicio_val_apac_w,
		dt_fim_val_apac_w,
		dt_inicio_trat_solic_w,
		dt_diagnostico_w,
		dt_pri_tratamento_w,
		dt_seg_tratamento_w,
		dt_ter_tratamento_w,
		ie_finalidade_w,
		ie_lifonodos_reg_inval_w,
		ie_tratamento_ant_w,
		cd_grau_histopat_w,
		dt_diag_cito_hist_w,
		ds_sigla_esquema_w,
		qt_meses_prev_w,
		qt_meses_autorizado_w,
		cd_cid_principal_w,
		nr_seq_interno_w,
		cd_cid_topografia_w,
		cd_cid_prim_trat_w,
		cd_cid_seg_trat_w,
		cd_cid_terc_trat_w,
		cd_cid_secundario_w,
		cd_cid_causa_assoc_w,
		dt_pri_dialise_w,
		qt_altura_cm_w,
		qt_peso_w,
		qt_diurese_w,
		qt_glicose_w,
		pr_albumina_w,
		pr_hb_w,
		nr_tru_w,
		ie_acesso_vascular_w,
		ie_hiv_w,
		ie_hcv_w,
		ie_hb_sangue_w,
		ie_ultra_abdomen_w,
		ie_inscrito_cncdo_w,
		nr_seq_pri_trat_w,
		nr_seq_seg_trat_w,
		nr_seq_ter_trat_w,
		cd_medico_requisitante_w,
		dt_retorno_secr_w,
		dt_inicio_dialise_cli_w,
		ie_caract_tratamento_w,
		ie_acesso_vasc_dial_w,
		ie_acomp_nefrol_w,
		ie_situacao_usu_ini_w,
		ie_situacao_trasp_w,
		ie_dados_apto_w,
		qt_fosforo_w,
		qt_ktv_semanal_w,
		qt_pth_w,
		ie_inter_clinica_w,
		ie_peritonite_diag_w,
		ie_encaminhado_fav_w,
		ie_encam_imp_cateter_w,
		ie_situacao_vacina_w,
		ie_anti_hbs_w,
		ie_influenza_w,
		ie_difteria_tetano_w,
		ie_pneumococica_w,
		ie_ieca_w,
		ie_bra_w,
		ie_duplex_previo_w,
		ie_cateter_outros_w,
		ie_fav_previas_w,
		ie_flebites_w,
		ie_hematomas_w,
		ie_veia_visivel_w,
		ie_presenca_pulso_w,
		qt_diametro_veia_w,
		qt_diametro_arteria_w,
		ie_fremito_traj_fav_w,
		ie_pulso_fremito_w
	from	sus_laudo_paciente
	where	nr_apac	= nr_apac_p;
	exception
		when no_data_found then
		CALL wheb_mensagem_pck.exibir_mensagem_abort(221456);
		/*Numero de APAC invalido pois nao existe nenhum laudo vinculado a esta APAC!*/

		when others then
		CALL wheb_mensagem_pck.exibir_mensagem_abort(221457);
		/*Existe mais de um Laudo com o mesmo numero de APAC!*/

	end;
	
	begin
	select	max((ds_estadio_uicc)::numeric )
	into STRICT	cd_estadio_w
	from	sus_laudo_paciente
	where	nr_apac	= nr_apac_p;
	exception
	when others then
		select	max(CASE WHEN upper(ds_estadio_uicc)='I' THEN 1 WHEN upper(ds_estadio_uicc)='II' THEN 2 WHEN upper(ds_estadio_uicc)='III' THEN 3 WHEN upper(ds_estadio_uicc)='IV' THEN 4 END )
		into STRICT	cd_estadio_w
		from	sus_laudo_paciente
		where	nr_apac	= nr_apac_p;
	end;
	
	end;
else
	begin
	begin
	select	max(a.nr_seq_interno)
	into STRICT	nr_seq_interno_ww
	from	sus_laudo_paciente a
	where	a.nr_atendimento 	 = nr_atendimento_p
	and	a.ie_classificacao not in (1,15)
	and	not exists (	SELECT 	1
				from	sus_apac_unif b
				where	b.cd_procedimento = a.cd_procedimento_solic
				and	clock_timestamp() between b.dt_inicio_validade and b.dt_fim_validade
				and	b.nr_atendimento = a.nr_atendimento);
	exception
		when others then
		nr_seq_interno_ww := null;
		end;

	if (coalesce(nr_seq_interno_ww,0) = 0) then
		begin
		CALL wheb_mensagem_pck.exibir_mensagem_abort(221458);
		/*Nao ha laudo APAC para este atendimento!*/

		end;
	end if;

	begin
	select	cd_procedimento_solic,
		ie_origem_proced,
		dt_emissao,
		coalesce(dt_inicio_val_apac,clock_timestamp()),
		coalesce(dt_fim_val_apac,clock_timestamp()),
		dt_inicio_trat_solic,
		dt_diagnostico,
		dt_pri_tratamento,
		dt_seg_tratamento,
		dt_ter_tratamento,
		CASE WHEN ie_finalidade=2 THEN 4 WHEN ie_finalidade=3 THEN 5 WHEN ie_finalidade=5 THEN 2 WHEN ie_finalidade=6 THEN 6 WHEN ie_finalidade=7 THEN 3 WHEN ie_finalidade=9 THEN 1  ELSE 1 END ,
		ie_lifonodos_reg_inval,
		ie_tratamento_ant,
		cd_grau_histopat,
		dt_diag_cito_hist,
		ds_sigla_esquema,
		qt_meses_prev,
		qt_meses_autorizado,
		cd_cid_principal,
		nr_seq_interno,
		replace(cd_cid_topografia,'.',''),
		cd_cid_prim_trat,
		cd_cid_seg_trat,
		cd_cid_terc_trat,
		cd_cid_secundario,
		cd_cid_causa_assoc,
		dt_pri_dialise,
		qt_altura_cm,
		qt_peso,
		qt_diurese,
		qt_glicose,
		pr_albumina,
		pr_hb,
		nr_tru,
		ie_acesso_vascular,
		ie_hiv,
		ie_hcv,
		ie_hb_sangue,
		ie_ultra_abdomen,
		ie_inscrito_cncdo,
		nr_seq_pri_trat,
		nr_seq_seg_trat,
		nr_seq_ter_trat,
		coalesce(cd_medico_requisitante,cd_profis_requisitante),
		coalesce(dt_retorno_secr,clock_timestamp()),
		dt_inicio_dialise_cli,
		ie_caract_tratamento,
		ie_acesso_vasc_dial,
		ie_acomp_nefrol,
		ie_situacao_usu_ini,
		ie_situacao_trasp,
		ie_dados_apto,
		qt_fosforo,
		qt_ktv_semanal,
		qt_pth,
		ie_inter_clinica,
		ie_peritonite_diag,
		ie_encaminhado_fav,
		ie_encam_imp_cateter,
		ie_situacao_vacina,
		ie_anti_hbs,
		ie_influenza,
		ie_difteria_tetano,
		ie_pneumococica,
		ie_ieca,
		ie_bra,
		ie_duplex_previo,
		ie_cateter_outros,
		ie_fav_previas,
		ie_flebites,
		ie_hematomas,
		ie_veia_visivel,
		ie_presenca_pulso,
		qt_diametro_veia,
		qt_diametro_arteria,
		ie_fremito_traj_fav,
		ie_pulso_fremito
	into STRICT	cd_procedimento_w,
		ie_origem_proced_w,
		dt_emissao_w,
		dt_inicio_val_apac_w,
		dt_fim_val_apac_w,
		dt_inicio_trat_solic_w,
		dt_diagnostico_w,
		dt_pri_tratamento_w,
		dt_seg_tratamento_w,
		dt_ter_tratamento_w,
		ie_finalidade_w,
		ie_lifonodos_reg_inval_w,
		ie_tratamento_ant_w,
		cd_grau_histopat_w,
		dt_diag_cito_hist_w,
		ds_sigla_esquema_w,
		qt_meses_prev_w,
		qt_meses_autorizado_w,
		cd_cid_principal_w,
		nr_seq_interno_w,
		cd_cid_topografia_w,
		cd_cid_prim_trat_w,
		cd_cid_seg_trat_w,
		cd_cid_terc_trat_w,
		cd_cid_secundario_w,
		cd_cid_causa_assoc_w,
		dt_pri_dialise_w,
		qt_altura_cm_w,
		qt_peso_w,
		qt_diurese_w,
		qt_glicose_w,
		pr_albumina_w,
		pr_hb_w,
		nr_tru_w,
		ie_acesso_vascular_w,
		ie_hiv_w,
		ie_hcv_w,
		ie_hb_sangue_w,
		ie_ultra_abdomen_w,
		ie_inscrito_cncdo_w,
		nr_seq_pri_trat_w,
		nr_seq_seg_trat_w,
		nr_seq_ter_trat_w,
		cd_medico_requisitante_w,
		dt_retorno_secr_w,
		dt_inicio_dialise_cli_w,
		ie_caract_tratamento_w,
		ie_acesso_vasc_dial_w,
		ie_acomp_nefrol_w,
		ie_situacao_usu_ini_w,
		ie_situacao_trasp_w,
		ie_dados_apto_w,
		qt_fosforo_w,
		qt_ktv_semanal_w,
		qt_pth_w,
		ie_inter_clinica_w,
		ie_peritonite_diag_w,
		ie_encaminhado_fav_w,
		ie_encam_imp_cateter_w,
		ie_situacao_vacina_w,
		ie_anti_hbs_w,
		ie_influenza_w,
		ie_difteria_tetano_w,
		ie_pneumococica_w,
		ie_ieca_w,
		ie_bra_w,
		ie_duplex_previo_w,
		ie_cateter_outros_w,
		ie_fav_previas_w,
		ie_flebites_w,
		ie_hematomas_w,
		ie_veia_visivel_w,
		ie_presenca_pulso_w,
		qt_diametro_veia_w,
		qt_diametro_arteria_w,
		ie_fremito_traj_fav_w,
		ie_pulso_fremito_w
	from	sus_laudo_paciente
	where	nr_seq_interno = nr_seq_interno_ww;
	exception
		when others then
		CALL wheb_mensagem_pck.exibir_mensagem_abort(221459);
		/*O sistema encontrou problemas para ler as informacoes do laudo!*/

		end;
		
	begin
	select	max((ds_estadio_uicc)::numeric )
	into STRICT	cd_estadio_w
	from	sus_laudo_paciente
	where	nr_seq_interno = nr_seq_interno_ww;
	exception
	when others then
		select	max(CASE WHEN upper(ds_estadio_uicc)='I' THEN 1 WHEN upper(ds_estadio_uicc)='II' THEN 2 WHEN upper(ds_estadio_uicc)='III' THEN 3 WHEN upper(ds_estadio_uicc)='IV' THEN 4 END )
		into STRICT	cd_estadio_w
		from	sus_laudo_paciente
		where	nr_seq_interno = nr_seq_interno_ww;
	end;
	
	end;	
end if;

cd_convenio_sus_w := coalesce(somente_numero(obter_dados_param_faturamento(cd_estabelecimento_w,'CSUS')),0);

if (coalesce(ie_carater_inter_sus_w::text, '') = '') then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(221460);
	/*Carater de internacao nao preenchido na Entrada Unica de Pacientes.*/

end if;

select	dt_competencia_apac,
	cd_medico_autorizador
into STRICT	dt_competencia_apac_w,
	cd_medico_autorizador_w
from	sus_parametros_apac
where	cd_estabelecimento	= cd_estabelecimento_w;

if (coalesce(cd_medico_p,0) <> 0) then
	cd_medico_autorizador_w := cd_medico_p;
end if;

select	nextval('sus_apac_unif_seq')
into STRICT	nr_sequencia_w
;

if (coalesce(ie_reabre_atendimento_w,'N') = 'S') then
	begin
	select	count(1)
	into STRICT	qt_atendimento_fechado_w
	from	atendimento_paciente
	where	nr_atendimento = nr_atendimento_p
	and	((dt_fim_conta IS NOT NULL AND dt_fim_conta::text <> '') or (ie_fim_conta = 'F'))  LIMIT 1;

	if (qt_atendimento_fechado_w > 0) then
		CALL Abrir_Atendimento(nr_atendimento_p,nm_usuario_p);
	end if;
	end;
end if;

begin

select	obter_setor_atendimento(nr_atendimento_p)
into STRICT	cd_setor_atendimento_w
;
exception
	when others then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(221461);
	/*Atendimento sem registro de unidade/setor*/

end;

cd_motivo_cobranca_w	:= cd_motivo_cobranca_p;

open c01;
loop
fetch c01 into
	cd_doenca_cid_w,
	qt_insercoes_area_w,
	dt_inicio_rad_w,
	dt_fim_rad_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	begin
	if (qt_cursor_w	= 1) then
		cd_cid_pri_radiacao_w	:= cd_doenca_cid_w;
		nr_campos_pri_radi_w	:= qt_insercoes_area_w;
		dt_inicio_pri_radi_w	:= dt_inicio_rad_w;
		dt_fim_pri_radi_w	:= dt_fim_rad_w;
	elsif (qt_cursor_w	= 2) then
		cd_cid_seg_radiacao_w	:= cd_doenca_cid_w;
		nr_campos_seg_radi_w	:= qt_insercoes_area_w;
		dt_inicio_seg_radi_w	:= dt_inicio_rad_w;
		dt_fim_seg_radi_w	:= dt_fim_rad_w;
	elsif (qt_cursor_w	= 3) then
		cd_cid_ter_radiacao_w	:= cd_doenca_cid_w;
		nr_campos_ter_radi_w	:= qt_insercoes_area_w;
		dt_inicio_ter_radi_w	:= dt_inicio_rad_w;
		dt_fim_ter_radi_w	:= dt_fim_rad_w;
	end if;
	qt_cursor_w	:= qt_cursor_w + 1;
	end;
end loop;
close c01;

if (cd_motivo_cobranca_p in (11, 12, 14, 15, 16, 18, 31, 41, 42, 43, 51)) then
	begin
	dt_ocorrencia_w	:= clock_timestamp();
	end;
end if;

if (coalesce(ie_atualiza_medico_resp_w,'N') = 'S') then
	cd_medico_resp_w	:= sus_obter_diretor_ups(cd_procedimento_w,ie_origem_proced_w);
end if;

if (coalesce(ie_medico_laudo_w,'N') = 'S') then
	cd_medico_resp_w	:= cd_medico_requisitante_w;
end if;

if (coalesce(ie_utiliza_dt_retorno_w,'N') = 'S') then
	dt_autorizacao_w := dt_retorno_secr_w;
else		
	dt_autorizacao_w := clock_timestamp();
end if;

if (sus_obter_se_detalhe_proc(cd_procedimento_w,ie_origem_proced_w,'014',dt_emissao_w) = 0) then
	ie_tipo_apac_w := 3;
else
	ie_tipo_apac_w := 1;
end if;

if (ie_dt_final_apac_w = 'S') and (ie_tipo_apac_w = 3) then	
	dt_fim_val_apac_w	:= dt_inicio_val_apac_w;
end if;

if (coalesce(sus_obter_tipo_laudo_apac_proc(cd_procedimento_w,ie_origem_proced_w),'00') = '05') then
	begin
	
	begin
	select	ie_comorbidades,
		cd_cid,
		ie_uso_medicamentos,
		ie_prat_ativ_fisica,
		qt_imc_atual,
		qt_perc_exc_peso,
		qt_kg_perdidos,
		ie_gastrec_duodenal,
		ie_gastrec_vertical,
		ie_gastrop_intestinal,
		ie_gastrop_vertical,
		ie_dermo_abdominal,
		ie_mamoplastia,
		ie_dermo_braquial,
		ie_dermo_crural,
		ie_dermo_circun,
		qt_tempo_dermo_abdominal,
		qt_tempo_mamoplastia,
		qt_tempo_dermo_braquial,
		qt_tempo_dermo_crural,
		qt_tempo_dermo_circun,
		qt_mes_acompanhamento,
		qt_ano_acompanhamento,
		ie_uso_polivitaminico,
		ie_houve_reganho_peso,
		ie_houve_adesao,
		dt_cirur_bariatrica,
		nr_aih_bariatrica,
		ie_hipertensao,
		ie_diabetes,
		ie_dislipidemia,
		ie_artrose,
		ie_apneia	
	into STRICT	ie_comorbidades_w,
		cd_cid_w,
		ie_uso_medicamentos_w,
		ie_prat_ativ_fisica_w,
		qt_imc_atual_w,
		qt_perc_exc_peso_w,
		qt_kg_perdidos_w,
		ie_gastrec_duodenal_w,
		ie_gastrec_vertical_w,
		ie_gastrop_intestinal_w,
		ie_gastrop_vertical_w,
		ie_dermo_abdominal_w,
		ie_mamoplastia_w,
		ie_dermo_braquial_w,
		ie_dermo_crural_w,
		ie_dermo_circun_w,
		qt_tempo_dermo_abdominal_w,
		qt_tempo_mamoplastia_w,
		qt_tempo_dermo_braquial_w,
		qt_tempo_dermo_crural_w,
		qt_tempo_dermo_circun_w,
		qt_mes_acompanhamento_w,
		qt_ano_acompanhamento_w,
		ie_uso_polivitaminico_w,
		ie_houve_reganho_peso_w,
		ie_houve_adesao_w,
		dt_cirur_bariatrica_w,
		nr_aih_bariatrica_w,
		ie_hipertensao_w,
		ie_diabetes_w,
		ie_dislipidemia_w,
		ie_artrose_w,
		ie_apneia_w
	from	sus_laudo_bariatrico
	where	nr_seq_laudo = nr_seq_interno_w;	
	exception
	when others then
		ie_comorbidades_w		:= '';
		cd_cid_w			:= '';
		ie_uso_medicamentos_w		:= '';
		ie_prat_ativ_fisica_w		:= '';
		qt_imc_atual_w			:= null;
		qt_perc_exc_peso_w		:= null;
		qt_kg_perdidos_w		:= null;
		ie_gastrec_duodenal_w		:= '';
		ie_gastrec_vertical_w		:= '';
		ie_gastrop_intestinal_w		:= '';
		ie_gastrop_vertical_w		:= '';
		ie_dermo_abdominal_w		:= '';
		ie_mamoplastia_w		:= '';
		ie_dermo_braquial_w		:= '';
		ie_dermo_crural_w		:= '';
		ie_dermo_circun_w		:= '';
		qt_tempo_dermo_abdominal_w	:= null;
		qt_tempo_mamoplastia_w		:= null;
		qt_tempo_dermo_braquial_w	:= null;
		qt_tempo_dermo_crural_w		:= null;
		qt_tempo_dermo_circun_w		:= null;
		qt_mes_acompanhamento_w		:= null;
		qt_ano_acompanhamento_w		:= null;
		ie_uso_polivitaminico_w		:= '';
		ie_houve_reganho_peso_w		:= '';
		ie_houve_adesao_w		:= '';
		dt_cirur_bariatrica_w		:= null;
		nr_aih_bariatrica_w		:= null;
		ie_hipertensao_w		:= '';
		ie_diabetes_w			:= '';
		ie_dislipidemia_w		:= '';
		ie_artrose_w			:= '';
		ie_apneia_w			:= '';
	end;
	
	end;
end if;
	
insert into sus_apac_unif(
	nr_sequencia,
	nr_apac,
	cd_estabelecimento,
	nr_atendimento,
	cd_procedimento,
	ie_origem_proced,
	dt_competencia,
	dt_inicio_validade,
	dt_fim_validade,
	dt_emissao,
	dt_atualizacao,
	nm_usuario,
	dt_atualizacao_nrec,
	nm_usuario_nrec,
	ie_tipo_apac,
	cd_motivo_cobranca,
	cd_medico_responsavel,
	dt_solicitacao,
	cd_medico_autorizador,
	dt_autorizacao,
	nr_apac_anterior,
	dt_ocorrencia,
	cd_cid_principal,
	cd_cid_secundario,
	cd_cid_causa_assoc,
	nr_interno_conta,
	dt_inicio_tratamento,
	dt_diagnostico,
	dt_pri_tratamento,
	dt_seg_tratamento,
	dt_ter_tratamento,
	ie_finalidade,
	ie_linfonodos_reg_inv,
	ie_tratamento_ant,
	cd_grau_histopat,
	dt_diag_cito_hist,
	cd_carater_internacao,
	ds_sigla_esquema,
	qt_meses_planejados,
	qt_meses_autorizados,
	cd_estadio,
	cd_cid_pri_radiacao,
	cd_cid_seg_radiacao,
	cd_cid_ter_radiacao,
	nr_campos_pri_radi,
	nr_campos_seg_radi,
	nr_campos_ter_radi,
	cd_cid_topografia,
	cd_cid_primeiro_trat,
	cd_cid_segundo_trat,
	cd_cid_terceiro_trat,
	dt_inicio_pri_radi,
	dt_inicio_seg_radi,
	dt_inicio_ter_radi,
	dt_fim_pri_radi,
	dt_fim_seg_radi,
	dt_fim_ter_radi,
	dt_pri_dialise,
	qt_altura_cm,
	qt_peso,
	qt_diurese,
	qt_glicose,
	pr_albumina,
	pr_hb,
	nr_tru,
	ie_acesso_vascular,
	ie_hiv,
	ie_hcv,
	ie_hb_sangue,
	ie_ultra_abdomen,
	ie_inscrito_cncdo,
	nr_seq_pri_trat,
	nr_seq_seg_trat,
	nr_seq_ter_trat,
	dt_inicio_dialise_cli,
	ie_caract_tratamento,
	ie_acesso_vasc_dial,
	ie_acomp_nefrol,
	ie_situacao_usu_ini,
	ie_situacao_trasp,
	ie_dados_apto,
	qt_fosforo,
	qt_ktv_semanal,
	qt_pth,
	ie_inter_clinica,
	ie_peritonite_diag,
	ie_encaminhado_fav,
	ie_encam_imp_cateter,
	ie_situacao_vacina,
	ie_anti_hbs,
	ie_influenza,
	ie_difteria_tetano,
	ie_pneumococica,
	ie_ieca,
	ie_bra,
	ie_duplex_previo,
	ie_cateter_outros,
	ie_fav_previas,
	ie_flebites,
	ie_hematomas,
	ie_veia_visivel,
	ie_presenca_pulso,
	qt_diametro_veia,
	qt_diametro_arteria,
	ie_fremito_traj_fav,
	ie_pulso_fremito,
	qt_icm_atual_pac,
	pr_exces_peso_perd,
	qt_kilogr_perdido,
	ie_gastrec_desv_duode,
	ie_gastrec_vert_manga,
	ie_gastrec_deri_intes,
	ie_gastrec_vert_banda,
	dt_cirur_bariatrica,
	nr_aih_bariatrica,
	ie_comorbidades,
	ie_cid_i10,
	ie_cid_o243,
	ie_cid_e780,
	ie_cid_m190,
	ie_cid_g473,
	cd_cid_outro_comor,
	ie_reconst_microcir,
	qt_reconst_microcir,
	ie_dermo_abdominal,
	qt_dermo_abdominal,
	ie_mamoplastia,
	qt_mamoplastia,
	ie_dermo_braquial,
	qt_dermo_braquial,
	ie_dermo_crural,
	qt_dermo_crural,
	qt_meses_acompanha,
	qt_anos_acompanha,
	ie_uso_medicamento,
	ie_uso_polivitaminico,
	ie_pratica_ativ_fisica,
	ie_reganho_peso,
	ie_ades_alim_saud)
values (	nr_sequencia_w,
	nr_apac_p,
	cd_estabelecimento_w,
	nr_atendimento_p,
	cd_procedimento_w,
	ie_origem_proced_w,
	dt_competencia_apac_w,
	dt_inicio_val_apac_w,
	dt_fim_val_apac_w,
	dt_emissao_w,
	clock_timestamp(),
	nm_usuario_p,
	clock_timestamp(),
	nm_usuario_p,
	ie_tipo_apac_w,
	cd_motivo_cobranca_p,
	cd_medico_resp_w,
	dt_emissao_w,
	cd_medico_autorizador_w,
	dt_autorizacao_w,
	null,
	dt_ocorrencia_w,
	cd_cid_principal_w,
	cd_cid_secundario_w,
	cd_cid_causa_assoc_w,
	null,
	dt_inicio_trat_solic_w,
	dt_diagnostico_w,
	dt_pri_tratamento_w,
	dt_seg_tratamento_w,
	dt_ter_tratamento_w,
	ie_finalidade_w,
	ie_lifonodos_reg_inval_w,
	ie_tratamento_ant_w,
	cd_grau_histopat_w,
	dt_diag_cito_hist_w,
	ie_carater_inter_sus_w,
	ds_sigla_esquema_w,
	qt_meses_prev_w,
	qt_meses_autorizado_w,
	cd_estadio_w,
	cd_cid_pri_radiacao_w,
	cd_cid_seg_radiacao_w,
	cd_cid_ter_radiacao_w,
	nr_campos_pri_radi_w,
	nr_campos_seg_radi_w,
	nr_campos_ter_radi_w,
	cd_cid_topografia_w,
	cd_cid_prim_trat_w,
	cd_cid_seg_trat_w,
	cd_cid_terc_trat_w,
	dt_inicio_pri_radi_w,
	dt_inicio_seg_radi_w,
	dt_inicio_ter_radi_w,
	dt_fim_pri_radi_w,
	dt_fim_seg_radi_w,
	dt_fim_ter_radi_w,
	dt_pri_dialise_w,
	qt_altura_cm_w,
	qt_peso_w,
	qt_diurese_w,
	qt_glicose_w,
	pr_albumina_w,
	pr_hb_w,
	nr_tru_w,
	ie_acesso_vascular_w,
	ie_hiv_w,
	ie_hcv_w,
	ie_hb_sangue_w,
	ie_ultra_abdomen_w,
	ie_inscrito_cncdo_w,
	nr_seq_pri_trat_w,
	nr_seq_seg_trat_w,
	nr_seq_ter_trat_w,
	dt_inicio_dialise_cli_w,
	ie_caract_tratamento_w,
	ie_acesso_vasc_dial_w,
	ie_acomp_nefrol_w,
	ie_situacao_usu_ini_w,
	ie_situacao_trasp_w,
	ie_dados_apto_w,
	qt_fosforo_w,
	qt_ktv_semanal_w,
	qt_pth_w,
	ie_inter_clinica_w,
	ie_peritonite_diag_w,
	ie_encaminhado_fav_w,
	ie_encam_imp_cateter_w,
	ie_situacao_vacina_w,
	ie_anti_hbs_w,
	ie_influenza_w,
	ie_difteria_tetano_w,
	ie_pneumococica_w,
	ie_ieca_w,
	ie_bra_w,
	ie_duplex_previo_w,
	ie_cateter_outros_w,
	ie_fav_previas_w,
	ie_flebites_w,
	ie_hematomas_w,
	ie_veia_visivel_w,
	ie_presenca_pulso_w,
	qt_diametro_veia_w,
	qt_diametro_arteria_w,
	ie_fremito_traj_fav_w,
	ie_pulso_fremito_w,
	substr(qt_imc_atual_w,1,3),
	substr(qt_perc_exc_peso_w,1,3),
	substr(qt_kg_perdidos_w,1,3),
	substr(coalesce(ie_gastrec_duodenal_w,'N'),1,1),
	substr(coalesce(ie_gastrec_vertical_w,'N'),1,1),
	substr(coalesce(ie_gastrop_intestinal_w,'N'),1,1),
	substr(coalesce(ie_gastrop_vertical_w,'N'),1,1),
	dt_cirur_bariatrica_w,
	substr(nr_aih_bariatrica_w,1,13),
	substr(coalesce(ie_comorbidades_w,'N'),1,1),
	substr(coalesce(ie_hipertensao_w,'N'),1,1),
	substr(coalesce(ie_diabetes_w,'N'),1,1),
	substr(coalesce(ie_dislipidemia_w,'N'),1,1),
	substr(coalesce(ie_artrose_w,'N'),1,1),
	substr(coalesce(ie_apneia_w,'N'),1,1),
	substr(coalesce(cd_cid_w,''),1,4),
	substr(coalesce(ie_dermo_circun_w,'N'),1,1),
	substr(qt_tempo_dermo_circun_w,1,3),
	substr(coalesce(ie_dermo_abdominal_w,'N'),1,1),
	substr(qt_tempo_dermo_abdominal_w,1,3),
	substr(coalesce(ie_mamoplastia_w,'N'),1,1),
	substr(qt_tempo_mamoplastia_w,1,3),
	substr(coalesce(ie_dermo_braquial_w,'N'),1,1),
	substr(qt_tempo_dermo_braquial_w,1,3),
	substr(coalesce(ie_dermo_crural_w,'N'),1,1),
	substr(qt_tempo_dermo_crural_w,1,3),
	substr(qt_mes_acompanhamento_w,1,3),
	substr(qt_ano_acompanhamento_w,1,3),
	substr(coalesce(ie_uso_medicamentos_w,'N'),1,1),
	substr(coalesce(ie_uso_polivitaminico_w,'N'),1,1),
	substr(coalesce(ie_prat_ativ_fisica_w,'N'),1,1),
	substr(coalesce(ie_houve_reganho_peso_w,'N'),1,1),
	substr(coalesce(ie_houve_adesao_w,'N'),1,1));

if (coalesce(ie_verif_conta_apac_w,'N') = 'S') then
	begin

	begin
	select	coalesce(max(x.nr_interno_conta),0)
	into STRICT	nr_interno_conta_w
	from (
	SELECT 	coalesce(max(a.nr_interno_conta),0) nr_interno_conta
	from	conta_paciente a
	where	a.nr_atendimento	= nr_atendimento_p
	and	a.ie_status_acerto	= 1
	and	a.cd_convenio_parametro = cd_convenio_sus_w
	and	not exists (SELECT	1
			from	procedimento_paciente p
			where	p.nr_interno_conta 	= a.nr_interno_conta
			and	sus_obter_tiporeg_proc(cd_procedimento,ie_origem_proced,'C',0) in (1,2,3,4,5)
			and 	coalesce(p.cd_motivo_exc_conta::text, '') = '')
	and	not exists (select	1
			from	sus_apac_unif w
			where	w.nr_interno_conta = a.nr_interno_conta)
	
union

	select 	coalesce(max(a.nr_interno_conta),0) nr_interno_conta
	from	conta_paciente a
	where	a.nr_atendimento	= nr_atendimento_p
	and	a.ie_status_acerto	= 1
	and	a.cd_convenio_parametro = cd_convenio_sus_w
	and	not exists (	select	1
				from	procedimento_paciente p
				where	p.nr_interno_conta 	= a.nr_interno_conta
				and 	coalesce(p.cd_motivo_exc_conta::text, '') = ''
				and	p.ie_origem_proced = 7)
	and	not exists (select	1
			from	sus_apac_unif w
			where	w.nr_interno_conta = a.nr_interno_conta)) x;
	exception
		when others then
		nr_interno_conta_w := 0;
	end;

	if (coalesce(nr_interno_conta_w,0) <> 0) and (ie_gerar_proced_w = 'S') then
		begin
		CALL sus_gerar_proced_apac_unif(
				nr_sequencia_w,
				nr_atendimento_p,
				nr_interno_conta_w,
				nr_seq_interno_w,
				nm_usuario_p,
				cd_estabelecimento_w,
				cd_setor_atendimento_p,
				1);
		end;
	end if;

	end;
end if;

if (coalesce(ie_verf_conta_compet_w,'N') = 'S') then
	begin

	begin
	select 	coalesce(max(a.nr_interno_conta),0)
	into STRICT	nr_interno_conta_w
	from	conta_paciente a
	where	a.nr_atendimento 	= nr_atendimento_p
	and	a.ie_status_acerto	= 1
	and	a.cd_convenio_parametro = cd_convenio_sus_w
	and (trunc(a.dt_mesano_referencia,'mm') = trunc(dt_competencia_apac_w,'mm'))
	and (trunc(a.dt_periodo_inicial,'mm') <= trunc(dt_fim_val_apac_w,'mm'))
	and	exists (SELECT	1
			from	procedimento_paciente p
			where	p.nr_interno_conta 	= a.nr_interno_conta)
	and	not exists (select	1
			from	sus_apac_unif w
			where	w.nr_interno_conta = a.nr_interno_conta);
	exception
	when others then
		nr_interno_conta_w := 0;
	end;
	
	if (coalesce(nr_interno_conta_w,0) > 0) and (ie_gerar_proced_w = 'S') then
		begin
		CALL sus_gerar_proced_apac_unif(
				nr_sequencia_w,
				nr_atendimento_p,
				nr_interno_conta_w,
				nr_seq_interno_w,
				nm_usuario_p,
				cd_estabelecimento_w,
				cd_setor_atendimento_w,
				ie_tipo_apac_w);
		end;
	end if;

	end;
end if;

if (coalesce(ie_verif_conta_proc_w,'N') = 'S') 	then
	begin
	if	(((coalesce(ie_verif_conta_apac_w,'N') = 'S') and (coalesce(nr_interno_conta_w,0) = 0))  or (coalesce(ie_verif_conta_apac_w,'N') = 'N'))
		and
		(((coalesce(ie_verf_conta_compet_w,'N') = 'S') and (coalesce(nr_interno_conta_w,0) = 0))  or (coalesce(ie_verf_conta_compet_w,'N') = 'N')) then
		begin

		begin
		select 	coalesce(max(a.nr_interno_conta),0)
		into STRICT	nr_interno_conta_w
		from	procedimento_paciente a,
			conta_paciente b
		where	a.nr_atendimento 	= nr_atendimento_p
		and	a.cd_procedimento	= cd_procedimento_w
		and	a.ie_origem_proced 	= ie_origem_proced_w
		and	a.cd_convenio		= cd_convenio_sus_w
		and	a.nr_interno_conta	= b.nr_interno_conta
		and	trunc(b.dt_periodo_inicial,'month') <= trunc(dt_fim_val_apac_w,'month')
		and	b.ie_status_acerto = 1
		and	not exists (SELECT	1
				from	sus_apac_unif w
				where	w.nr_interno_conta = b.nr_interno_conta);
		exception
			when others then
			nr_interno_conta_w := 0;
		end;

		end;
	end if;
	end;
end if;

if (coalesce(nr_interno_conta_w,0) = 0) then
	nr_interno_conta_w := sus_gerar_conta_apac_unif(	nr_atendimento_p, cd_estabelecimento_w, nm_usuario_p, nr_interno_conta_w, dt_inicio_val_apac_w, dt_fim_val_apac_w);

	if (ie_gerar_proced_w = 'S') then
		begin
		CALL sus_gerar_proced_apac_unif(
				nr_sequencia_w,
				nr_atendimento_p,
				nr_interno_conta_w,
				nr_seq_interno_w,
				nm_usuario_p,
				cd_estabelecimento_w,
				cd_setor_atendimento_p,
				1);
		end;
	end if;
end if;

CALL sus_definir_apac_conta_unif(	nr_sequencia_w,
			nr_interno_conta_w,
			nm_usuario_p);

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE sus_gerar_apac_laudo_unif ( nr_apac_p bigint, nr_atendimento_p bigint, cd_motivo_cobranca_p bigint, cd_medico_p text, cd_setor_atendimento_p bigint, nm_usuario_p text) FROM PUBLIC;

