-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE baixa_titulo_pagar_emprest (nr_seq_parcela_p bigint, nr_titulo_p bigint, dt_baixa_p timestamp, vl_baixa_p bigint, nr_seq_trans_fin_p bigint, nr_seq_conta_bco_p bigint, nm_usuario_p text) AS $body$
DECLARE

							 
cd_tipo_baixa_w		bigint;
nr_sequencia_w		bigint;
cd_estabelecimento_w	integer;
dt_cancelamento_w	timestamp;


BEGIN 
 
select	max(cd_estabelecimento), 
	max(dt_cancelamento) 
into STRICT	cd_estabelecimento_w, 
	dt_cancelamento_w 
from	emprest_financ_parc 
where	nr_sequencia = nr_seq_parcela_p;
 
select	max(cd_tipo_baixa_padrao) 
into STRICT	cd_tipo_baixa_w 
from	parametros_contas_pagar 
where	cd_estabelecimento = cd_estabelecimento_w;
 
if (dt_cancelamento_w IS NOT NULL AND dt_cancelamento_w::text <> '') then 
	--Parcela cancelada. Título não pode ser baixado. 
	CALL wheb_mensagem_pck.exibir_mensagem_abort(370542);
end if;
 
CALL baixa_titulo_pagar(cd_estabelecimento_w, 
		cd_tipo_baixa_w, 
		nr_titulo_p, 
		vl_baixa_p, 
		nm_usuario_p, 
		nr_seq_trans_fin_p, 
		null, 
		null, 
		dt_baixa_p, 
		nr_seq_conta_bco_p);
 
select	max(nr_sequencia) 
into STRICT	nr_sequencia_w 
from	titulo_pagar_baixa 
where	nr_titulo	= nr_titulo_p;
 
CALL gerar_movto_tit_baixa(nr_titulo_p,nr_sequencia_w,'P',nm_usuario_p,'N');
		 
CALL atualizar_saldo_tit_pagar(nr_titulo_p,nm_usuario_p);
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE baixa_titulo_pagar_emprest (nr_seq_parcela_p bigint, nr_titulo_p bigint, dt_baixa_p timestamp, vl_baixa_p bigint, nr_seq_trans_fin_p bigint, nr_seq_conta_bco_p bigint, nm_usuario_p text) FROM PUBLIC;

