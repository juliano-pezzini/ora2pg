-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_relatorio_rat (cd_executor_p bigint, dt_inicio_p timestamp, dt_fim_p timestamp) AS $body$
DECLARE


cd_executor_w		bigint;
nr_seq_proj_w		bigint;
nr_seq_rat_w		bigint;
qt_horas_rat_w		double precision;

c01 CURSOR FOR
	--Trazer os executores
	SELECT  distinct
		a.cd_executor
	from    proj_rat a,
		proj_rat_ativ b,
		proj_projeto c
	where   b.nr_seq_rat = a.nr_sequencia
	and	a.nr_seq_proj = c.nr_sequencia
	and	c.nr_seq_classif not in (15,17)
	and     b.dt_inicio_ativ between dt_inicio_p and fim_dia(dt_fim_p)
	and     b.dt_fim_ativ  between dt_inicio_p and fim_dia(dt_fim_p)
	and     ((a.cd_executor = coalesce(cd_executor_p,'0')) or (coalesce(cd_executor_p,'0') = '0'));

c02 CURSOR FOR
	--Trazer os projetos dos executores
	SELECT  distinct
		a.nr_seq_proj
	from    proj_rat a,
		proj_rat_ativ b,
		proj_projeto c
	where   b.nr_seq_rat = a.nr_sequencia
	and	a.nr_seq_proj = c.nr_sequencia
	and	c.nr_seq_classif not in (15,17)
	and     b.dt_inicio_ativ between dt_inicio_p and fim_dia(dt_fim_p)
	and     b.dt_fim_ativ  between dt_inicio_p and fim_dia(dt_fim_p)
	and     a.cd_executor = cd_executor_w;

c03 CURSOR FOR
	--trazer os rats e a quantidade de horas
	SELECT  distinct
		a.nr_sequencia,
		obter_horas_noturnas(a.nr_sequencia)
	from    proj_rat a,
		proj_rat_ativ b,
		proj_projeto c
	where   b.nr_seq_rat = a.nr_sequencia
	and	a.nr_seq_proj = c.nr_sequencia
	and	c.nr_seq_classif not in (15,17)
	and     b.dt_inicio_ativ between dt_inicio_p and fim_dia(dt_fim_p)
	and     b.dt_fim_ativ  between dt_inicio_p and fim_dia(dt_fim_p)
	and     a.cd_executor = cd_executor_w
	and	a.nr_seq_proj = nr_seq_proj_w;


BEGIN
delete from w_horas_noturnas;
commit;

open C01;
loop
fetch C01 into
	cd_executor_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	open C02;
	loop
	fetch C02 into
		nr_seq_proj_w;
	EXIT WHEN NOT FOUND; /* apply on C02 */
		begin
		open C03;
		loop
		fetch C03 into
			nr_seq_rat_w,
			qt_horas_rat_w;
		EXIT WHEN NOT FOUND; /* apply on C03 */
			begin
			insert into w_horas_noturnas(	cd_executor,
							nr_seq_proj,
							nr_seq_rat,
							qt_horas_rat)
					      values (	cd_executor_w,
							nr_seq_proj_w,
							nr_seq_rat_w,
							qt_horas_rat_w);
			end;
		end loop;
		close C03;
		end;
	end loop;
	close C02;
	end;
end loop;
close C01;
commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_relatorio_rat (cd_executor_p bigint, dt_inicio_p timestamp, dt_fim_p timestamp) FROM PUBLIC;

