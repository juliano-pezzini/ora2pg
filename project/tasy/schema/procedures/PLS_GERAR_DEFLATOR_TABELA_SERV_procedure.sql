-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_gerar_deflator_tabela_serv ( cd_tabela_servico_p bigint, vl_reajuste_p bigint, dt_inicio_vigencia_p timestamp, nr_seq_motivo_def_p bigint, ds_observacao_p text, nm_usuario_p text, cd_estabelecimento_p bigint) AS $body$
DECLARE


cd_estabelecimento_w		smallint;
cd_tabela_servico_w			smallint;
cd_procedimento_w			bigint;
dt_inicio_vigencia_w		timestamp;
vl_servico_w				double precision;
vl_reajustado_w				double precision;
ds_motivo_w					varchar(255);
ie_origem_proced_w			bigint;
nr_seq_log_w				bigint;
dt_vigencia_w				timestamp;

C01 CURSOR FOR
	SELECT	max(a.cd_estabelecimento),
			max(a.cd_tabela_servico),
			max(a.cd_procedimento),
			max(a.dt_inicio_vigencia),
			max(a.vl_servico),
			max(a.ie_origem_proced),
			max(a.dt_inicio_vigencia)
	from	preco_servico	a
	where	a.cd_tabela_servico		= cd_tabela_servico_p
	and		a.cd_estabelecimento	= cd_estabelecimento_p
	and		coalesce(a.dt_vigencia_final::text, '') = ''
	and		to_date(dt_inicio_vigencia,'dd/mm/yy')  	< to_date(dt_inicio_vigencia_p,'dd/mm/yy')
	group by
		cd_procedimento;


BEGIN
if (coalesce(nr_seq_motivo_def_p,0) = 0) then
	ds_motivo_w	:= '';
else
	select	ds_motivo
	into STRICT	ds_motivo_w
	from	pls_motivo_reaj_deflator
	where	nr_sequencia	= nr_seq_motivo_def_p;
end if;


open C01;
loop
fetch C01 into
	cd_estabelecimento_w,
	cd_tabela_servico_w,
	cd_procedimento_w,
	dt_inicio_vigencia_w,
	vl_servico_w,
	ie_origem_proced_W,
	dt_vigencia_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	vl_reajustado_w	:= vl_servico_w - ((vl_servico_w * vl_reajuste_p) / 100);

	insert 	into preco_servico(	cd_estabelecimento, cd_tabela_servico, cd_procedimento,
								dt_inicio_vigencia, vl_servico, cd_moeda,
								dt_atualizacao, nm_usuario, ie_origem_proced,
								cd_unidade_medida, dt_atualizacao_nrec, nm_usuario_nrec,
								dt_inativacao, dt_vigencia_final)
							(	SELECT	cd_estabelecimento, cd_tabela_servico, cd_procedimento,
								(dt_inicio_vigencia_p), vl_reajustado_w, cd_moeda,
								clock_timestamp(), nm_usuario_p, ie_origem_proced,
								cd_unidade_medida, clock_timestamp(), nm_usuario_p,
								null, null
								from	preco_servico
								where	cd_estabelecimento	= cd_estabelecimento_w
								and		cd_tabela_servico	= cd_tabela_servico_w
								and		cd_procedimento		= cd_procedimento_w
								and		ie_origem_proced	= ie_origem_proced_w
								and		trunc(dt_inicio_vigencia,'dd')	= trunc(dt_inicio_vigencia_w,'dd')
								and		coalesce(dt_vigencia_final::text, '') = '');


	update	preco_servico
	set		dt_vigencia_final		= dt_inicio_vigencia_p - 1
	where	cd_estabelecimento		= cd_estabelecimento_w
	and		cd_tabela_servico		= cd_tabela_servico_w
	and		cd_procedimento			= cd_procedimento_w
	and		trunc(dt_inicio_vigencia,'dd')  	< trunc(dt_inicio_vigencia_p,'dd')
	and		coalesce(dt_vigencia_final::text, '') = ''
	and		ie_origem_proced		= ie_origem_proced_w;

	end;
end loop;
close C01;
select	nextval('tabela_servico_log_seq')
into STRICT	nr_seq_log_w
;

insert into	tabela_servico_log(	nr_sequencia,cd_tabela_servico, cd_estabelecimento, dt_atualizacao,
									nm_usuario, dt_atualizacao_nrec, nm_usuario_nrec,
									dt_log, ds_log )
						values	(	nr_seq_log_w, cd_tabela_servico_p, cd_estabelecimento_p, clock_timestamp(),
									nm_usuario_p, clock_timestamp(), nm_usuario_p,
									clock_timestamp(),'Aplicação de ajuste deflator de preço '||(vl_reajuste_p)||' %, motivo: '||ds_motivo_w||' observação: '||ds_observacao_p);
commit;


end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_gerar_deflator_tabela_serv ( cd_tabela_servico_p bigint, vl_reajuste_p bigint, dt_inicio_vigencia_p timestamp, nr_seq_motivo_def_p bigint, ds_observacao_p text, nm_usuario_p text, cd_estabelecimento_p bigint) FROM PUBLIC;

