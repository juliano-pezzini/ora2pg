-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE fis_gerar_arquivo_lfpd ( nr_seq_controle_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) AS $body$
DECLARE

 
cd_registro_w		varchar(15);
cd_estabelecimento_w	smallint;
dt_inicio_w		timestamp;
dt_fim_w		timestamp;
ds_separador_w		varchar(1);
ie_gerar_w		varchar(1);
nr_seq_regra_w		bigint;
qt_linha_w		bigint := 0;
nr_sequencia_w		bigint;
			
c01 CURSOR FOR 
	SELECT	cd_registro, 
		ie_gerar 
	from	fis_regra_lfpd_reg 
	where	nr_seq_regra_lfpd	= nr_seq_regra_w 
	order by nr_sequencia;


BEGIN 
/* Limpar a tabela */
 
delete 	FROM fis_lfpd_arquivo 
where	nm_usuario	= nm_usuario_p;
 
commit;
 
 
 
 
select	r.cd_estabelecimento, 
	c.dt_inicial, 
	fim_dia(c.dt_final), 
	r.ds_separador, 
	c.nr_seq_regra_lfpd 
into STRICT	cd_estabelecimento_w, 
	dt_inicio_w, 
	dt_fim_w, 
	ds_separador_w, 
	nr_seq_regra_w 
from	fis_lfpd_regra r, 
	fis_lfpd_controle c 
where	r.nr_sequencia		= c.nr_seq_regra_lfpd 
and	r.cd_estabelecimento	= cd_estabelecimento_p 
and	c.nr_sequencia		= nr_seq_controle_p;
 
open c01;
loop 
fetch c01 into	 
	cd_registro_w, 
	ie_gerar_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	begin 
	 
	begin 
	/* Bloco Zero */
 
	if	(cd_registro_w = '0000' AND ie_gerar_w = 'S') then 
		SELECT * FROM lfpd_registro_0000(	nr_seq_controle_p, nm_usuario_p, cd_estabelecimento_w, dt_inicio_w, dt_fim_w, ds_separador_w, qt_linha_w, nr_sequencia_w) INTO STRICT qt_linha_w, nr_sequencia_w;
	elsif	(cd_registro_w = '0001' AND ie_gerar_w = 'S') then 
		SELECT * FROM lfpd_gerar_reg_abertura(	nr_seq_controle_p, nm_usuario_p, cd_registro_w, 'S', '', '', ds_separador_w, qt_linha_w, nr_sequencia_w) INTO STRICT qt_linha_w, nr_sequencia_w;
	elsif	(cd_registro_w = '0005' AND ie_gerar_w = 'S') then 
		SELECT * FROM lfpd_registro_0005(	nr_seq_controle_p, nm_usuario_p, cd_estabelecimento_w, dt_inicio_w, dt_fim_w, ds_separador_w, qt_linha_w, nr_sequencia_w) INTO STRICT qt_linha_w, nr_sequencia_w;
	elsif	(cd_registro_w = '0100' AND ie_gerar_w = 'S') then 
		SELECT * FROM lfpd_registro_0100(	nr_seq_controle_p, nm_usuario_p, cd_estabelecimento_w, dt_inicio_w, dt_fim_w, ds_separador_w, qt_linha_w, nr_sequencia_w) INTO STRICT qt_linha_w, nr_sequencia_w;
	elsif	(cd_registro_w = '0125' AND ie_gerar_w = 'S') then 
		SELECT * FROM lfpd_registro_0125(	nr_seq_controle_p, nm_usuario_p, cd_estabelecimento_w, dt_inicio_w, dt_fim_w, ds_separador_w, qt_linha_w, nr_sequencia_w) INTO STRICT qt_linha_w, nr_sequencia_w;
	elsif	(cd_registro_w = '0150' AND ie_gerar_w = 'S') then 
		SELECT * FROM lfpd_registro_0150(nr_seq_controle_p, nm_usuario_p, cd_estabelecimento_w, dt_inicio_w, dt_fim_w, ds_separador_w, qt_linha_w, nr_sequencia_w) INTO STRICT qt_linha_w, nr_sequencia_w;
	elsif	(cd_registro_w = '0200' AND ie_gerar_w = 'S') then 
		SELECT * FROM lfpd_registro_0200(nr_seq_controle_p, nm_usuario_p, cd_estabelecimento_w, dt_inicio_w, dt_fim_w, ds_separador_w, qt_linha_w, nr_sequencia_w) INTO STRICT qt_linha_w, nr_sequencia_w;
	elsif	(cd_registro_w = '0400' AND ie_gerar_w = 'S') then 
		SELECT * FROM lfpd_registro_0400(nr_seq_controle_p, nm_usuario_p, cd_estabelecimento_w, dt_inicio_w, dt_fim_w, ds_separador_w, qt_linha_w, nr_sequencia_w) INTO STRICT qt_linha_w, nr_sequencia_w;
	elsif	(cd_registro_w = '0450' AND ie_gerar_w = 'S') then		 
		SELECT * FROM lfpd_registro_0450(nr_seq_controle_p, nm_usuario_p, cd_estabelecimento_w, dt_inicio_w, dt_fim_w, ds_separador_w, qt_linha_w, nr_sequencia_w) INTO STRICT qt_linha_w, nr_sequencia_w;
	elsif	(cd_registro_w = '0990' AND ie_gerar_w = 'S') then 
		SELECT * FROM lfpd_gerar_reg_encerramento(nr_seq_controle_p, nm_usuario_p, cd_registro_w, ds_separador_w, qt_linha_w, nr_sequencia_w) INTO STRICT qt_linha_w, nr_sequencia_w;
	 
	/* Bloco A */
 
	elsif	(cd_registro_w = 'A001' AND ie_gerar_w = 'S') then 
		SELECT * FROM lfpd_gerar_reg_abertura(nr_seq_controle_p, nm_usuario_p, cd_registro_w, 'S', '5300108', '', ds_separador_w, qt_linha_w, nr_sequencia_w) INTO STRICT qt_linha_w, nr_sequencia_w;
	elsif	(cd_registro_w = 'A020' AND ie_gerar_w = 'S') then 
		SELECT * FROM lfpd_registro_A020(nr_seq_controle_p, nm_usuario_p, cd_estabelecimento_w, dt_inicio_w, dt_fim_w, ds_separador_w, qt_linha_w, nr_sequencia_w) INTO STRICT qt_linha_w, nr_sequencia_w;
	elsif	(cd_registro_w = 'A300' AND ie_gerar_w = 'S') then 
		SELECT * FROM lfpd_registro_A300(nr_seq_controle_p, nm_usuario_p, cd_estabelecimento_w, dt_inicio_w, dt_fim_w, ds_separador_w, qt_linha_w, nr_sequencia_w) INTO STRICT qt_linha_w, nr_sequencia_w;
	elsif	(cd_registro_w = 'A990' AND ie_gerar_w = 'S') then	 
			SELECT * FROM lfpd_gerar_reg_encerramento(nr_seq_controle_p, nm_usuario_p, cd_registro_w, ds_separador_w, qt_linha_w, nr_sequencia_w) INTO STRICT qt_linha_w, nr_sequencia_w;	
	 
	/* Bloco B */
 
	elsif	(cd_registro_w = 'B001' AND ie_gerar_w = 'S') then 
		SELECT * FROM lfpd_gerar_reg_abertura(nr_seq_controle_p, nm_usuario_p, cd_registro_w, 'S', '5300108', '', ds_separador_w, qt_linha_w, nr_sequencia_w) INTO STRICT qt_linha_w, nr_sequencia_w;
	elsif	(cd_registro_w = 'B020' AND ie_gerar_w = 'S') then	 
		SELECT * FROM lfpd_registro_B020(nr_seq_controle_p, nm_usuario_p, cd_estabelecimento_w, dt_inicio_w, dt_fim_w, ds_separador_w, qt_linha_w, nr_sequencia_w) INTO STRICT qt_linha_w, nr_sequencia_w;
	elsif	(cd_registro_w = 'B030' AND ie_gerar_w = 'S') then	 
		SELECT * FROM lfpd_registro_B030(nr_seq_controle_p, nm_usuario_p, cd_estabelecimento_w, dt_inicio_w, dt_fim_w, ds_separador_w, qt_linha_w, nr_sequencia_w) INTO STRICT qt_linha_w, nr_sequencia_w;
	elsif	(cd_registro_w = 'B400' AND ie_gerar_w = 'S') then	 
		SELECT * FROM lfpd_registro_B400(nr_seq_controle_p, nm_usuario_p, cd_estabelecimento_w, dt_inicio_w, dt_fim_w, ds_separador_w, qt_linha_w, nr_sequencia_w) INTO STRICT qt_linha_w, nr_sequencia_w;
	/*elsif	((cd_registro_w = 'B410') and (ie_gerar_w = 'S')) then	 
			lfpd_registro_B410(nr_seq_controle_p, nm_usuario_p, cd_estabelecimento_w, dt_inicio_w, dt_fim_w, ds_separador_w, qt_linha_w, nr_sequencia_w); 
	elsif	((cd_registro_w = 'B440') and (ie_gerar_w = 'S')) then	 
			lfpd_registro_B440(nr_seq_controle_p, nm_usuario_p, cd_estabelecimento_w, dt_inicio_w, dt_fim_w, ds_separador_w, qt_linha_w, nr_sequencia_w); 
	elsif	((cd_registro_w = 'B450') and (ie_gerar_w = 'S')) then	 
			lfpd_registro_B450(nr_seq_controle_p, nm_usuario_p, cd_estabelecimento_w, dt_inicio_w, dt_fim_w, ds_separador_w, qt_linha_w, nr_sequencia_w); 
	elsif	((cd_registro_w = 'B470') and (ie_gerar_w = 'S')) then	 
			lfpd_registro_B470(nr_seq_controle_p, nm_usuario_p, cd_estabelecimento_w, dt_inicio_w, dt_fim_w, ds_separador_w, qt_linha_w, nr_sequencia_w);*/
 
	elsif	(cd_registro_w = 'B990' AND ie_gerar_w = 'S') then	 
			SELECT * FROM lfpd_gerar_reg_encerramento(nr_seq_controle_p, nm_usuario_p, cd_registro_w, ds_separador_w, qt_linha_w, nr_sequencia_w) INTO STRICT qt_linha_w, nr_sequencia_w;	
	 
	/* Bloco C */
 
	elsif	(cd_registro_w = 'C001' AND ie_gerar_w = 'S') then 
			SELECT * FROM lfpd_gerar_reg_abertura(nr_seq_controle_p, nm_usuario_p, cd_registro_w, 'N', '', '', ds_separador_w, qt_linha_w, nr_sequencia_w) INTO STRICT qt_linha_w, nr_sequencia_w;
	elsif	(cd_registro_w = 'C990' AND ie_gerar_w = 'S') then	 
			SELECT * FROM lfpd_gerar_reg_encerramento(nr_seq_controle_p, nm_usuario_p, cd_registro_w, ds_separador_w, qt_linha_w, nr_sequencia_w) INTO STRICT qt_linha_w, nr_sequencia_w;
 
	/* Bloco D */
 
	elsif	(cd_registro_w = 'D001' AND ie_gerar_w = 'S') then 
			SELECT * FROM lfpd_gerar_reg_abertura(nr_seq_controle_p, nm_usuario_p, cd_registro_w, 'N', '', '', ds_separador_w, qt_linha_w, nr_sequencia_w) INTO STRICT qt_linha_w, nr_sequencia_w;
	elsif	(cd_registro_w = 'D990' AND ie_gerar_w = 'S') then	 
			SELECT * FROM lfpd_gerar_reg_encerramento(nr_seq_controle_p, nm_usuario_p, cd_registro_w, ds_separador_w, qt_linha_w, nr_sequencia_w) INTO STRICT qt_linha_w, nr_sequencia_w;
	 
	/* Bloco E */
 
	elsif	(cd_registro_w = 'E001' AND ie_gerar_w = 'S') then 
			SELECT * FROM lfpd_gerar_reg_abertura(nr_seq_controle_p, nm_usuario_p, cd_registro_w, 'S', '', '', ds_separador_w, qt_linha_w, nr_sequencia_w) INTO STRICT qt_linha_w, nr_sequencia_w;
	elsif	(cd_registro_w = 'E300' AND ie_gerar_w = 'S') then	 
			SELECT * FROM lfpd_registro_E300(nr_seq_controle_p, nm_usuario_p, cd_estabelecimento_w, dt_inicio_w, dt_fim_w, ds_separador_w, qt_linha_w, nr_sequencia_w) INTO STRICT qt_linha_w, nr_sequencia_w;
	elsif	(cd_registro_w = 'E360' AND ie_gerar_w = 'S') then	 
			SELECT * FROM lfpd_registro_E360(nr_seq_controle_p, nm_usuario_p, cd_estabelecimento_w, dt_inicio_w, dt_fim_w, ds_separador_w, qt_linha_w, nr_sequencia_w) INTO STRICT qt_linha_w, nr_sequencia_w;
	elsif	(cd_registro_w = 'E990' AND ie_gerar_w = 'S') then	 
			SELECT * FROM lfpd_gerar_reg_encerramento(nr_seq_controle_p, nm_usuario_p, cd_registro_w, ds_separador_w, qt_linha_w, nr_sequencia_w) INTO STRICT qt_linha_w, nr_sequencia_w;
		 
	/* Bloco H */
 
	elsif	(cd_registro_w = 'H001' AND ie_gerar_w = 'S') then 
			SELECT * FROM lfpd_gerar_reg_abertura(nr_seq_controle_p, nm_usuario_p, cd_registro_w, 'S', '', '', ds_separador_w, qt_linha_w, nr_sequencia_w) INTO STRICT qt_linha_w, nr_sequencia_w;
	elsif	(cd_registro_w = 'H020' AND ie_gerar_w = 'S') then	 
			SELECT * FROM lfpd_registro_H020(nr_seq_controle_p, nm_usuario_p, cd_estabelecimento_w, dt_inicio_w, dt_fim_w, ds_separador_w, qt_linha_w, nr_sequencia_w) INTO STRICT qt_linha_w, nr_sequencia_w;
	elsif	(cd_registro_w = 'H990' AND ie_gerar_w = 'S') then	 
			SELECT * FROM lfpd_gerar_reg_encerramento(nr_seq_controle_p, nm_usuario_p, cd_registro_w, ds_separador_w, qt_linha_w, nr_sequencia_w) INTO STRICT qt_linha_w, nr_sequencia_w;
	 
	/* Bloco 8 */
 
	elsif	(cd_registro_w = '8001' AND ie_gerar_w = 'S') then 
			SELECT * FROM lfpd_gerar_reg_abertura(nr_seq_controle_p, nm_usuario_p, cd_registro_w, 'N', '', 'DF', ds_separador_w, qt_linha_w, nr_sequencia_w) INTO STRICT qt_linha_w, nr_sequencia_w;
	elsif	(cd_registro_w = '8990' AND ie_gerar_w = 'S') then	 
			SELECT * FROM lfpd_gerar_reg_encerramento(nr_seq_controle_p, nm_usuario_p, cd_registro_w, ds_separador_w, qt_linha_w, nr_sequencia_w) INTO STRICT qt_linha_w, nr_sequencia_w;
 
	/* Bloco 9 */
 
	elsif	(cd_registro_w = '9001' AND ie_gerar_w = 'S') then 
			SELECT * FROM lfpd_gerar_reg_abertura(nr_seq_controle_p, nm_usuario_p, cd_registro_w, 'S', '', '', ds_separador_w, qt_linha_w, nr_sequencia_w) INTO STRICT qt_linha_w, nr_sequencia_w;
	elsif	(cd_registro_w = '9900' AND ie_gerar_w = 'S') then	 
			SELECT * FROM lfpd_registro_9900(nr_seq_controle_p, nm_usuario_p, cd_estabelecimento_w, dt_inicio_w, dt_fim_w, ds_separador_w, qt_linha_w, nr_sequencia_w) INTO STRICT qt_linha_w, nr_sequencia_w;
	elsif	(cd_registro_w = '9990' AND ie_gerar_w = 'S') then 
			SELECT * FROM lfpd_registro_9990(nr_seq_controle_p, nm_usuario_p, cd_estabelecimento_w, dt_inicio_w, dt_fim_w, ds_separador_w, qt_linha_w, nr_sequencia_w) INTO STRICT qt_linha_w, nr_sequencia_w;
	elsif	(cd_registro_w = '9999' AND ie_gerar_w = 'S') then	 
			SELECT * FROM lfpd_registro_9999(nr_seq_controle_p, nm_usuario_p, cd_estabelecimento_w, dt_inicio_w, dt_fim_w, ds_separador_w, qt_linha_w, nr_sequencia_w) INTO STRICT qt_linha_w, nr_sequencia_w;
		 
	end if;
		 
	end;
	 
exception 
when no_data_found then 
CALL wheb_mensagem_pck.exibir_mensagem_abort(737743);
 
end;		
	 
end loop;
close c01;
commit;
 
 
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE fis_gerar_arquivo_lfpd ( nr_seq_controle_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) FROM PUBLIC;

