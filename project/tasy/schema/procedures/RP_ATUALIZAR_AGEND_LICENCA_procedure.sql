-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE rp_atualizar_agend_licenca (cd_pessoa_fisica_p text, dt_inicial_P timestamp, dt_final_p timestamp, nr_seq_motivo_licenca_p bigint, nm_usuario_p text, ie_justificada_p text) AS $body$
DECLARE


ds_motivo_licenca_w	varchar(255);				
nr_seq_agenda_w		    agenda_consulta.nr_sequencia%type;
nr_seq_rp_mod_item_w	rp_pac_modelo_agend_item.nr_sequencia%type;
nr_seq_rp_item_ind_w	rp_pac_agend_individual.nr_sequencia%type;
dt_agenda_w				agenda_consulta.dt_agenda%type;
nr_seq_hora_w			agenda_consulta.nr_seq_hora%type;
cd_agenda_w				agenda_consulta.cd_agenda%type;

C01 CURSOR FOR
	SELECT	b.nr_seq_rp_mod_item,
		b.nr_seq_rp_item_ind,
		b.nr_sequencia,
		b.cd_agenda,
		b.dt_agenda
	from	agenda a,
		agenda_consulta b
	where	a.cd_agenda = b.cd_agenda
	and	a.cd_tipo_agenda = 5
	and	b.cd_pessoa_fisica = cd_pessoa_fisica_p
	and	b.dt_agenda between trunc(dt_inicial_p) and trunc(dt_final_p) + 86399/86400
	and	((b.nr_seq_rp_mod_item IS NOT NULL AND b.nr_seq_rp_mod_item::text <> '') or (b.nr_seq_rp_item_ind IS NOT NULL AND b.nr_seq_rp_item_ind::text <> ''))
	and	b.ie_status_agenda not in ('C','E')
	and	a.cd_Estabelecimento = wheb_usuario_pck.get_cd_estabelecimento;

				

BEGIN
	
select 	substr(ds_motivo_licenca,1,255)
into STRICT	ds_motivo_licenca_w
from	rp_motivo_licenca
where	nr_sequencia = nr_seq_motivo_licenca_p;

open C01;
loop
fetch C01 into	
	nr_seq_rp_mod_item_w,
	nr_seq_rp_item_ind_w,	
	nr_seq_agenda_w,
	cd_agenda_w,
	dt_agenda_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	
	if (ie_justificada_p = 'N') then	
	
		select 	coalesce(max(nr_seq_hora), 0) + 1
		into STRICT	nr_seq_hora_w
		from agenda_consulta
		where cd_agenda = cd_agenda_w
		and ie_status_agenda	= 'I'
		and dt_agenda = dt_agenda_w;
		
		update	agenda_consulta
		set	ie_status_agenda	= 'I',
			nr_seq_hora			= nr_seq_hora_w
		where	nr_sequencia 		= nr_seq_agenda_w;
		
	end if;
				
	if (ie_justificada_p = 'J') then

		select 	coalesce(max(nr_seq_hora), 0) + 1
		into STRICT	nr_seq_hora_w
		from agenda_consulta
		where cd_agenda = cd_agenda_w
		and ie_status_agenda	= 'F'
		and dt_agenda = dt_agenda_w;
		
		update	agenda_consulta
		set	ie_status_agenda	= 'F',
			ds_motivo_status 	= ds_motivo_licenca_w,
			nr_seq_hora			= nr_seq_hora_w
		where	nr_sequencia 		= nr_seq_agenda_w;
		
	end if;

	CALL rp_consistir_falta_agend(nr_seq_rp_mod_item_w, nr_seq_rp_item_ind_w, nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento, nr_seq_agenda_w);
	
	end;
end loop;
close C01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE rp_atualizar_agend_licenca (cd_pessoa_fisica_p text, dt_inicial_P timestamp, dt_final_p timestamp, nr_seq_motivo_licenca_p bigint, nm_usuario_p text, ie_justificada_p text) FROM PUBLIC;

