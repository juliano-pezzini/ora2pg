-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE verifica_maximo_dias ( nr_prescricao_p bigint, nr_sequencia_p bigint, ds_erro_p INOUT text) AS $body$
DECLARE


nr_dia_util_w     			bigint;
cd_setor_atendimento_w    	integer;
qt_dias_maximo_w    		smallint;
ie_via_aplicacao_w    		varchar(5);
cd_material_w     			integer;
ie_agrupador_w      		prescr_material.ie_agrupador%type;
ie_permite_liberar_w 		varchar(1);
dt_inicio_w     			timestamp;
dt_fim_w      				timestamp;
ds_justificativa_w          cpoe_material.ds_justificativa%type;
nr_seq_cpoe_w 				bigint;
total_dias_solicit_w 		smallint;

c01 CURSOR FOR
	SELECT  coalesce(qt_dias_maximo,0),
			ie_permite_liberar
	from	material_prescr
	where	cd_material	= cd_material_w
	and		ie_tipo	= '2'
	and		coalesce(cd_setor_atendimento, coalesce(cd_setor_atendimento_w,0)) = coalesce(cd_setor_atendimento_w,0)
	and		coalesce(ie_via_aplicacao, coalesce(ie_via_aplicacao_w,0)) = coalesce(ie_via_aplicacao_w,0)
	and		(qt_dias_maximo IS NOT NULL AND qt_dias_maximo::text <> '')
	and		(((coalesce(ie_tipo_item,'TOD') = 'SOL') and (ie_agrupador_w = 4)) or
			((coalesce(ie_tipo_item,'TOD') = 'OUT') and (ie_agrupador_w <> 4)) or (coalesce(ie_tipo_item,'TOD') = 'TOD'))
	order by 	coalesce(cd_setor_atendimento,999999),
				coalesce(ie_via_aplicacao,'zzzzz');


BEGIN

ds_erro_p := '';

select	cd_material,
		coalesce(nr_dia_util,0),
		ie_via_aplicacao,
		ie_agrupador,
		nr_seq_mat_cpoe
into STRICT	cd_material_w,
		nr_dia_util_w,
		ie_via_aplicacao_w,
		ie_agrupador_w,
		nr_seq_cpoe_w
from	prescr_material
where	nr_prescricao	= nr_prescricao_p
and		nr_sequencia	= nr_sequencia_p;

if (nr_seq_cpoe_w IS NOT NULL AND nr_seq_cpoe_w::text <> '') then

	select  dt_inicio,
			dt_fim,
			ds_justificativa
	into STRICT    dt_inicio_w,
			dt_fim_w,
			ds_justificativa_w
	from  	cpoe_material
	where 	nr_sequencia   = nr_seq_cpoe_w;
	
end if;

if (nr_dia_util_w > 0 or (dt_inicio_w IS NOT NULL AND dt_inicio_w::text <> '')) then

  select	max(cd_setor_atendimento)
  into STRICT  	cd_setor_atendimento_w
  from  	prescr_medica
  where 	nr_prescricao = nr_prescricao_p;

  open c01;
  loop
  fetch c01 into
    qt_dias_maximo_w,
    ie_permite_liberar_w;
  EXIT WHEN NOT FOUND; /* apply on c01 */

		total_dias_solicit_w := pkg_date_utils.get_diffdate(dt_inicio_w, dt_fim_w, 'DAY');
		
		if ((nr_dia_util_w > qt_dias_maximo_w) or (coalesce(dt_fim_w::text, '') = '' and (nr_seq_cpoe_w IS NOT NULL AND nr_seq_cpoe_w::text <> '')) or (total_dias_solicit_w > qt_dias_maximo_w)) then
			
			if (ie_permite_liberar_w = 'S' and coalesce(ds_justificativa_w::text, '') = '') then
				ds_erro_p := wheb_mensagem_pck.get_texto(278168, 'QT_DIAS_MAXIMO_P=' || qt_dias_maximo_w);
			end if;
			if (ie_permite_liberar_w = 'N') then
				ds_erro_p := wheb_mensagem_pck.get_texto(278168, 'QT_DIAS_MAXIMO_P=' || qt_dias_maximo_w);
			end if;
		
      end if;

  end loop;
  close c01;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE verifica_maximo_dias ( nr_prescricao_p bigint, nr_sequencia_p bigint, ds_erro_p INOUT text) FROM PUBLIC;

