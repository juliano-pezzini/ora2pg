-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE m1_dirf_registro_tipo_2_3 (nr_seq_lote_dirf_p bigint, nr_seq_arquivo_p bigint, cd_cgc_estab_p text, nm_usuario_p text) AS $body$
DECLARE

				 
dt_lote_w		timestamp;
cd_darf_w		varchar(10);
cd_cgc_w		varchar(20);
vl_min_ano_pf_w		double precision;
ie_data_w		smallint;

vl_rendimento_w		double precision;
vl_irrf_w		double precision;
ie_mes_w		varchar(2);
ds_arquivo_w		varchar(2000);
nr_seq_arquivo_w	bigint;

cd_pessoa_fisica_w	varchar(25);
vl_total_w		double precision;
nr_mes_w		smallint;
qt_dif_mes_w		bigint;
ie_contador_w		bigint;
ie_entou_w		boolean;

nr_titulo_w		varchar(20);
				
C01 CURSOR FOR  -- busca todas as pessoas juridicas que possuem tituloas a pagar com retenção de imposto. 
SELECT	distinct 
	p.cd_cgc, 
	coalesce(i.cd_darf,'1708'), 
	1 
from	titulo_pagar p, 
	titulo_pagar_imposto i 
where	p.nr_titulo = i.nr_titulo 
and	trunc(p.dt_contabil,'YYYY') = trunc(dt_lote_w,'YYYY') 
and	(p.cd_cgc IS NOT NULL AND p.cd_cgc::text <> '') 
and	coalesce(i.cd_darf,'9999') in ('1708','8045','3280') 
and	p.ie_situacao <> 'C' 

union all
 
SELECT	distinct 
	p.cd_cgc, 
	coalesce(i.cd_darf,'1708'), 
	2 
from	titulo_pagar p, 
	titulo_pagar_imposto i 
where	p.nr_titulo = i.nr_titulo 
and	trunc(p.dt_liquidacao,'YYYY') = trunc(dt_lote_w,'YYYY') 
and	(p.cd_cgc IS NOT NULL AND p.cd_cgc::text <> '') 
and	coalesce(i.cd_darf,'1708') in ('5952','5960','5979','5987') 
and	p.ie_situacao <> 'C';

 
C02 CURSOR FOR  -- busca os titulos a pagar da pessoa filtrada no cursor C01 
 
	SELECT 	sum(vl_rendimento), 
		sum(vl_imposto) 
	from (SELECT coalesce(obter_rendimento_cofins_ir_pj(p.nr_titulo,'RET','IR'),0) vl_rendimento, 
		coalesce(obter_rendimento_cofins_ir_pj(p.nr_titulo,'IMP','IR'),0) vl_imposto 
	FROM titulo_pagar p
LEFT OUTER JOIN titulo_pagar_imposto i ON (p.nr_titulo = i.nr_titulo)
LEFT OUTER JOIN tributo t ON (i.cd_tributo = t.cd_tributo)
WHERE   --and 	trunc(p.dt_emissao,'YYYY') = trunc(dt_lote_w,'YYYY') 
   trunc(CASE WHEN ie_data_w=1 THEN p.dt_contabil  ELSE p.dt_liquidacao END ,'YYYY') = trunc(dt_lote_w,'YYYY') and p.cd_cgc = cd_cgc_w and coalesce(i.cd_darf,'1708') = CASE WHEN cd_darf_w='5952' THEN '9999'  ELSE cd_darf_w END and p.ie_situacao <> 'C' and coalesce(to_char(CASE WHEN ie_data_w=1 THEN p.dt_contabil  ELSE p.dt_liquidacao END ,'mm'),'00') = lpad(ie_mes_w,2,'0') and exists (select 	1 
		from 	titulo_pagar x, 
			titulo_pagar_imposto z, 
			tributo t 
		where	x.nr_titulo = z.nr_titulo 
		and	t.cd_tributo = z.cd_tributo 
		and	x.cd_cgc = P.cd_cgc 
		and	z.vl_imposto > 0 
		and 	t.ie_tipo_tributo = 'IR') 
	 
union all
 
	select 	coalesce(obter_rendimento_cofins_ir_pj(p.nr_titulo,'RET','COFINS'),0) vl_rendimento, 
		coalesce(obter_rendimento_cofins_ir_pj(p.nr_titulo,'IMP','COFINS'),0) vl_imposto 
	from	titulo_pagar p 
	
	where 	trunc(CASE WHEN ie_data_w=1 THEN p.dt_contabil  ELSE p.dt_liquidacao END ,'YYYY') = trunc(dt_lote_w,'YYYY') 
	and	p.cd_cgc = cd_cgc_w 
	and	p.ie_situacao <> 'C' 
	and	cd_darf_w = '5952' 
	and	coalesce(to_char(CASE WHEN ie_data_w=1 THEN p.dt_contabil  ELSE p.dt_liquidacao END ,'mm'),'00') = lpad(ie_mes_w,2,'0') 
	and	exists (select 	1 
		from 	titulo_pagar x, 
			titulo_pagar_imposto z, 
			tributo t 
		where	x.nr_titulo = z.nr_titulo 
		and	t.cd_tributo = z.cd_tributo 
		and	x.cd_cgc = P.cd_cgc 
		and	z.vl_imposto > 0 
		and 	t.ie_tipo_tributo = 'COFINS')) alias23;
	
	 
	 
	/*select 	 
		nvl(sum(decode(i.vl_base_calculo,null,to_number(obter_dados_tit_pagar(p.nr_titulo,'V')),i.vl_base_calculo)),0), 
		nvl(sum(i.vl_imposto),0) 
	from 	titulo_pagar p, 
		titulo_pagar_imposto i 
	where	p.nr_titulo = i.nr_titulo(+) 
	and 	trunc(decode(ie_data_w,1,p.dt_contabil,p.dt_liquidacao),'YYYY') = trunc(dt_lote_w,'YYYY') 
	and	p.cd_cgc = cd_cgc_w 
	and	nvl(i.cd_darf,'9999') = cd_darf_w 
	and	p.ie_situacao <> 'C' 
	and	nvl(to_char(p.dt_contabil,'mm'),'00') = lpad(ie_mes_w,2,'0'); */
 
 
C03 CURSOR FOR  --Pessoa fisica que teve ganho maior que 6000 no ano ou pessoa fisicas com ganho menor que 6000, mais que houve retencao 
	SELECT	distinct p.cd_pessoa_fisica, 
		coalesce(j.cd_darf,'0588') 
	FROM titulo_pagar p
LEFT OUTER JOIN titulo_pagar_imposto j ON (p.nr_titulo = j.nr_titulo)
WHERE trunc(p.dt_liquidacao,'YYYY') = trunc(dt_lote_w,'YYYY') and (p.cd_pessoa_fisica IS NOT NULL AND p.cd_pessoa_fisica::text <> '') and coalesce(j.cd_darf,'0588') in ('0588','3208') and p.ie_tipo_titulo in (SELECT z.ie_tipo_titulo from dirf_regra_tipo_tit z) --and	p.ie_tipo_titulo in ('0','11','13','5') 
  and p.vl_titulo >= vl_min_ano_pf_w 
	 
union
 
	select	distinct a.cd_pessoa_fisica, 
		coalesce(i.cd_darf,'0588') 
	from	titulo_pagar a, 
		titulo_pagar_imposto i 
	where	a.nr_titulo = i.nr_titulo 
	and	trunc(a.dt_liquidacao,'YYYY') = trunc(dt_lote_w,'YYYY') 
	and	coalesce(i.cd_darf,'0588') in ('0588','3208') 
	and	a.ie_tipo_titulo in (select z.ie_tipo_titulo from dirf_regra_tipo_tit z) 
	--and	a.ie_tipo_titulo in ('0','11','13','5') 
	and	(a.cd_pessoa_fisica IS NOT NULL AND a.cd_pessoa_fisica::text <> '') 
	and	a.vl_titulo < coalesce(vl_min_ano_pf_w,6000);
	
C04 CURSOR FOR  -- titulos das pessoas fisicas. 
	 
	SELECT 	distinct p.nr_titulo 
	FROM titulo_pagar p
LEFT OUTER JOIN titulo_pagar_imposto i ON (p.nr_titulo = i.nr_titulo)
WHERE trunc(p.dt_liquidacao,'YYYY') = trunc(dt_lote_w,'YYYY') and p.cd_pessoa_fisica = cd_pessoa_fisica_w and coalesce(i.cd_darf,'0588') = cd_darf_w and coalesce(to_char(p.dt_liquidacao,'mm'),'00') = lpad(ie_mes_w,2,'0') --and	p.ie_tipo_titulo in ('0','11','13','5') 
  and p.ie_tipo_titulo in (SELECT z.ie_tipo_titulo from dirf_regra_tipo_tit z) and p.ie_situacao <> 'C';
	
	/*select 	 
		nvl(sum(decode(i.vl_base_calculo,null,to_number(obter_dados_tit_pagar(p.nr_titulo,'V')),i.vl_base_calculo)),0), 
		nvl(sum(i.vl_imposto),0) 
	from 	titulo_pagar p, 
		titulo_pagar_imposto i 
	where	p.nr_titulo = i.nr_titulo(+) 
	and 	trunc(p.dt_liquidacao,'YYYY') = trunc(dt_lote_w,'YYYY') 
	and	p.cd_pessoa_fisica = cd_pessoa_fisica_w 
	and	nvl(i.cd_darf,'0588') = cd_darf_w 
	and	nvl(to_char(p.dt_liquidacao,'mm'),'00') = lpad(ie_mes_w,2,'0') 
	and	p.ie_situacao <> 'C';*/
 
	 
	 
	 
	 
		 
c05 CURSOR FOR 	--GPS 
	SELECT	distinct p.cd_pessoa_fisica 
	from	dirf_lote a, 
		gps d, 
		gps_titulo e, 
		titulo_pagar p,  
		titulo_pagar f  
	where	a.nr_sequencia 	= d.nr_seq_dirf 
	and	d.nr_sequencia 	= e.nr_seq_gps 
	and	f.nr_titulo	= e.nr_titulo 
	and	f.nr_titulo_original = p.nr_titulo 
	and	trunc(f.dt_liquidacao,'YYYY') = trunc(dt_lote_w,'YYYY') 
	and	a.nr_sequencia = nr_seq_lote_dirf_p 
	order by p.cd_pessoa_fisica;	
 
c06 CURSOR FOR  --Relaciona todos os darf´s utilizados na dirf 
SELECT cd_darf 
from (select	distinct 
		coalesce(i.cd_darf,'1708') cd_darf 
	from	titulo_pagar p, 
		titulo_pagar_imposto i 
	where	p.nr_titulo = i.nr_titulo 
	and	trunc(p.dt_contabil,'YYYY') = trunc(dt_lote_w,'YYYY') 
	and	(p.cd_cgc IS NOT NULL AND p.cd_cgc::text <> '') 
	and	coalesce(i.cd_darf,'1708') in ('1708','8045','3280') 
	and	p.ie_situacao <> 'C' 
	
union
 
	SELECT	distinct 
		coalesce(i.cd_darf,'1708') cd_darf 
	from	titulo_pagar p, 
		titulo_pagar_imposto i 
	where	p.nr_titulo = i.nr_titulo 
	and	trunc(p.dt_liquidacao,'YYYY') = trunc(dt_lote_w,'YYYY') 
	and	(p.cd_cgc IS NOT NULL AND p.cd_cgc::text <> '') 
	and	coalesce(i.cd_darf,'1708') in ('5952','5960','5979','5987') 
	and	p.ie_situacao <> 'C' 
	
union
 
	select	distinct 
		coalesce(j.cd_darf,'0588') cd_darf 
	FROM titulo_pagar p
LEFT OUTER JOIN titulo_pagar_imposto j ON (p.nr_titulo = j.nr_titulo)
WHERE trunc(p.dt_liquidacao,'YYYY') = trunc(dt_lote_w,'YYYY') and (p.cd_pessoa_fisica IS NOT NULL AND p.cd_pessoa_fisica::text <> '') 
	 
union
 
	select	distinct 
		coalesce(i.cd_darf,'0588') cd_darf 
	from	titulo_pagar a, 
		titulo_pagar_imposto i 
	where	a.nr_titulo = i.nr_titulo 
	and	trunc(a.dt_liquidacao,'YYYY') = trunc(dt_lote_w,'YYYY') 
	and	(a.cd_pessoa_fisica IS NOT NULL AND a.cd_pessoa_fisica::text <> '')) alias20 
where	cd_darf in ('5952','5960','5979','5987','0588','1708','8045','3280');

 
c07 CURSOR FOR  -- tipo de registro 3 - Totaliza os valores por codigo da darf 
SELECT lpad(replace(coalesce(sum(vl_rendimento),'0'),',',''),15,'0'), 
	lpad(replace(coalesce(sum(vl_imposto),'0'),',',''),15,'0') 
from (select	lpad(coalesce(sum(p.vl_titulo),0),15,'0' ) vl_rendimento, 
		lpad(coalesce(sum(i.vl_imposto),0),15,'0') vl_imposto 
	FROM titulo_pagar p
LEFT OUTER JOIN titulo_pagar_imposto i ON (p.nr_titulo = i.nr_titulo)
WHERE trunc(CASE WHEN coalesce(i.cd_darf,'1708')='1708' THEN p.dt_contabil WHEN coalesce(i.cd_darf,'1708')='8045' THEN p.dt_contabil WHEN coalesce(i.cd_darf,'1708')='3280' THEN p.dt_contabil  ELSE p.dt_liquidacao END ,'YYYY') = trunc(dt_lote_w,'YYYY') and coalesce(i.cd_darf,'1708') = cd_darf_w and p.ie_situacao <> 'C' and to_char(CASE WHEN coalesce(i.cd_darf,'1708')='1708' THEN p.dt_contabil WHEN coalesce(i.cd_darf,'1708')='8045' THEN p.dt_contabil WHEN coalesce(i.cd_darf,'1708')='3280' THEN p.dt_contabil  ELSE p.dt_liquidacao END ,'mm') = lpad(ie_mes_w,2,'0') 
	 
union all
 
	SELECT 	lpad(coalesce(sum(p.vl_titulo),0),15,'0' ) vl_rendimento, 
		lpad(coalesce(sum(i.vl_imposto),0),15,'0') vl_imposto 
	FROM titulo_pagar p
LEFT OUTER JOIN titulo_pagar_imposto i ON (p.nr_titulo = i.nr_titulo)
WHERE trunc(p.dt_liquidacao,'YYYY') = trunc(dt_lote_w,'YYYY') and coalesce(i.cd_darf,'0588') = cd_darf_w and p.ie_situacao <> 'C' and to_char(p.dt_liquidacao,'mm') = lpad(ie_mes_w,2,'0') 
	 
union all
 
	select	lpad(0,15,'0' ) vl_rentidimento, 
		lpad(coalesce(sum(f.vl_titulo),0),15,'0') vl_imposto 
	from	dirf_lote a, 
		gps d, 
		gps_titulo e, 
		titulo_pagar p,
		titulo_pagar f 
	where	a.nr_sequencia 	= d.nr_seq_dirf 
	and	d.nr_sequencia 	= e.nr_seq_gps 
	and	f.nr_titulo	= e.nr_titulo 
	and	f.nr_titulo_original = p.nr_titulo 
	and	trunc(f.dt_liquidacao,'YYYY') = trunc(dt_lote_w,'YYYY') 
	and	a.nr_sequencia = nr_seq_lote_dirf_p 
	and	cd_darf_w = '0588' 
	and	to_char(f.dt_liquidacao,'mm') = ie_mes_w) alias43;
	
C08 CURSOR FOR 
	SELECT	coalesce(sum((obter_dados_tit_pagar(f.nr_titulo,'V'))::numeric ),0) 
	from	dirf_lote a, 
		gps d, 
		gps_titulo e, 
		titulo_pagar p,  
		titulo_pagar f  
	where	a.nr_sequencia 	= d.nr_seq_dirf 
	and	d.nr_sequencia 	= e.nr_seq_gps 
	and	f.nr_titulo	= e.nr_titulo 
	and	f.nr_titulo_original = p.nr_titulo 
	and	trunc(f.dt_liquidacao,'YYYY') = trunc(dt_lote_w,'YYYY') 
	and	a.nr_sequencia = nr_seq_lote_dirf_p 
	and	p.cd_pessoa_fisica = cd_pessoa_fisica_w 
	and	to_char(p.dt_liquidacao,'mm') = lpad(ie_mes_w,2,'0');	
 

BEGIN 
 
nr_seq_arquivo_w := 2;
 
select 	coalesce(dt_lote,clock_timestamp()), 
	coalesce(vl_min_ano_pf,6000) 
into STRICT	dt_lote_w, 
	vl_min_ano_pf_w 
from	dirf_lote 
where	nr_sequencia = nr_seq_lote_dirf_p;
 
/* PESSOA JURIDICA */
 
nr_mes_w := 1;
OPEN c01;
LOOP 
FETCH c01 INTO 
	cd_cgc_w, 
	cd_darf_w, 
	ie_data_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	if (coalesce(cd_cgc_w,'X') <> 'X') then 
		select 	--lpad(to_char(nr_seq_arquivo_w),8,'0') || --nr_seq_arquivo 
			'2' || 
			lpad(cd_cgc_estab_p,14,'0') || 
			lpad(cd_darf_w,4,'0') || 
			'2' || 
			lpad(cd_cgc_w,14,'0') || 
			rpad(coalesce(substr(elimina_caractere_especial(nfe_obter_dados_pj(cd_cgc_w,'RZ')),1,60),' '),60,' ') 
		into	ds_arquivo_w 
		;
		 
		--insert into bruno_log values (2000,20000,'cgc: ' || cd_cgc_w || ' - nome: ' || rpad(nvl(substr(nfe_obter_dados_pj(cd_cgc_w,'RZ'),1,60),' '),60,' ') || ' - Arquivo: ' || ds_arquivo_w); 
		--commit; 
		ie_mes_w := '01';
		ie_entou_w := false;
		 
		while (ie_mes_w)::numeric  <= 13 loop 
			OPEN c02;
			LOOP 
			FETCH c02 INTO 
				vl_rendimento_w, 
				vl_irrf_w;				
			EXIT WHEN NOT FOUND; /* apply on c02 */
				ds_arquivo_w := ds_arquivo_w || lpad(replace(campo_mascara(coalesce(vl_rendimento_w,'0'),2),'.',''),15,'0') || lpad('0',15,'0') || lpad(replace(campo_mascara(coalesce(vl_irrf_w,'0'),2),'.',''),15,'0');
				ie_entou_w := true;
			END LOOP;
			CLOSE c02;	
			 
			if (not ie_entou_w) then 
				ds_arquivo_w := ds_arquivo_w || lpad('0',15,'0') || lpad('0',15,'0') || lpad('0',15,'0');			
			end if;
			ie_entou_w := false;	
			ie_mes_w := to_char((ie_mes_w + 1)::numeric );		
		end loop;
		 
		ds_arquivo_w := ds_arquivo_w || '0'; -- identificacao da situacao do rendimento 
		ds_arquivo_w := ds_arquivo_w || '0'; --especializacao das deducoes 
		ds_arquivo_w := ds_arquivo_w || lpad(' ',8,' '); --para uso do rfb 
		ds_arquivo_w := ds_arquivo_w || lpad(' ',32,' '); --para uso do declarante 
		ds_arquivo_w := ds_arquivo_w || '9'; --problemas com o windows (grande porte) 
		nr_seq_arquivo_w := nr_seq_arquivo_w + 1; --incremento de cada linha do arquivo 
		
		insert 	into w_dirf_arquivo(nr_sequencia, 
					   nm_usuario, 
					   nm_usuario_nrec, 
					   dt_atualizacao, 
					   dt_atualizacao_nrec, 
					   ds_arquivo, 
					   nr_seq_apresentacao, 
					   nr_seq_registro, 
					   cd_cgc) 
		values (nextval('w_dirf_arquivo_seq'), 
					   nm_usuario_p, 
					   nm_usuario_p, 
					   clock_timestamp(), 
					   clock_timestamp(), 
					   ds_arquivo_w, 
					   cd_darf_w, 
					   1, 
					   cd_cgc_w);	
	end if;
END LOOP;
CLOSE c01;
 
nr_mes_w := 1;
/*PESSOA FISICA*/
 
OPEN c03;
LOOP 
FETCH c03 INTO 
	cd_pessoa_fisica_w, 
	cd_darf_w;
EXIT WHEN NOT FOUND; /* apply on c03 */
	if (cd_pessoa_fisica_w IS NOT NULL AND cd_pessoa_fisica_w::text <> '') then 
		select 	--lpad(to_char(nr_seq_arquivo_w),8,'0') || --nr_seq_arquivo 
			'2' || 
			lpad(cd_cgc_estab_p,14,'0') || 
			lpad(cd_darf_w,4,'0') || 
			'1' || 
			lpad(coalesce(Obter_Cpf_Pessoa_Fisica(cd_pessoa_fisica_w),'0'),14,'0') || 
			rpad(substr(elimina_caractere_especial(obter_nome_pf(cd_pessoa_fisica_w)),1,60),60,' ') 
		into	ds_arquivo_w 
		;
		--insert into bruno_log values (2000,20000,'cpf:' || lpad(nvl(Obter_Cpf_Pessoa_Fisica(cd_pessoa_fisica_w),'0'),14,'0') || ' - nome: ' || rpad(substr(obter_nome_pf(cd_pessoa_fisica_w),1,60),60,' ') || ' - Arquivo: ' || ds_arquivo_w); 
		--commit; 
		ie_mes_w := '01';
		ie_entou_w := false;
		 
		while (ie_mes_w)::numeric  <= 13 loop 
			vl_rendimento_w := 0;
			vl_irrf_w := 0;
			OPEN c04;
			LOOP 
			FETCH c04 INTO 
				nr_titulo_w;	
			EXIT WHEN NOT FOUND; /* apply on c04 */
				vl_rendimento_w := vl_rendimento_w + coalesce(obter_valor_rendimento_dirf_pf(nr_titulo_w,'N'),0);
				vl_irrf_w := vl_irrf_w + coalesce(obter_valor_imposto_pf(nr_titulo_w,'IR'),0);
				ie_entou_w := true;
			END LOOP;
			CLOSE c04;
		 
			if (not ie_entou_w) then 
				ds_arquivo_w := ds_arquivo_w || lpad('0',15,'0') || lpad('0',15,'0') || lpad('0',15,'0');			
			else 
				ds_arquivo_w := ds_arquivo_w || lpad(replace(campo_mascara(coalesce(vl_rendimento_w,'0'),2),'.',''),15,'0') || lpad('0',15,'0') || lpad(replace(campo_mascara(coalesce(vl_irrf_w,'0'),2),'.',''),15,'0');
			end if;
			 
			ie_entou_w := false;	
			ie_mes_w := to_char((ie_mes_w + 1)::numeric );
		end loop;
		 
		ds_arquivo_w := ds_arquivo_w || '0'; -- identificacao da situacao do rendimento 
		ds_arquivo_w := ds_arquivo_w || '0'; --especializacao das deducoes 
		ds_arquivo_w := ds_arquivo_w || lpad(' ',8,' '); --para uso do rfb 
		ds_arquivo_w := ds_arquivo_w || lpad(' ',32,' '); --para uso do declarante 
		ds_arquivo_w := ds_arquivo_w || '9'; --problemas com o windows (grande porte) 
		nr_seq_arquivo_w := nr_seq_arquivo_w + 1; --incremento de cada linha do arquivo 
		
		insert 	into w_dirf_arquivo(nr_sequencia, 
				   nm_usuario, 
				   nm_usuario_nrec, 
				   dt_atualizacao, 
				   dt_atualizacao_nrec, 
				   ds_arquivo, 
				   nr_seq_apresentacao, 
				   nr_seq_registro, 
				   cd_pessoa_fisica) 
		values (nextval('w_dirf_arquivo_seq'), 
				   nm_usuario_p, 
				   nm_usuario_p, 
				   clock_timestamp(), 
				   clock_timestamp(), 
				   ds_arquivo_w, 
				   '0588', 
				   1, 
				   cd_pessoa_fisica_w);
	end if;
END LOOP;
CLOSE c03;
 
 
OPEN c05;
LOOP 
FETCH c05 INTO 
--	ie_mes_w, 
--	cd_darf_w, 
--	vl_rendimento_w, 
--	vl_irrf_w, 
	cd_pessoa_fisica_w;	
EXIT WHEN NOT FOUND; /* apply on c05 */
	if (cd_pessoa_fisica_w IS NOT NULL AND cd_pessoa_fisica_w::text <> '') then 
	 
		select 	--lpad(to_char(nr_seq_arquivo_w),8,'0') || --nr_seq_arquivo 
			'2' || 
			lpad(cd_cgc_estab_p,14,'0') || 
			'0588' || 
			'1' || 
			lpad(coalesce(Obter_Cpf_Pessoa_Fisica(cd_pessoa_fisica_w),'0'),14,'0') || 
			rpad(substr(elimina_caractere_especial(obter_nome_pf(cd_pessoa_fisica_w)),1,60),60,' ') 
		into	ds_arquivo_w 
		;
		 
		ie_mes_w := '01';
		ie_entou_w := false;
		 
		while (ie_mes_w)::numeric  <= 13 loop 
			OPEN c08;
			LOOP 
			FETCH c08 INTO 
				vl_rendimento_w;
			EXIT WHEN NOT FOUND; /* apply on c08 */
				vl_irrf_w := 0;
				ds_arquivo_w := ds_arquivo_w || lpad(replace(campo_mascara(coalesce(vl_rendimento_w,'0'),2),'.',''),15,'0') || lpad('0',15,'0') || lpad(replace(campo_mascara(coalesce(vl_irrf_w,'0'),2),'.',''),15,'0');
				ie_entou_w := true;
			END LOOP;
			CLOSE c08;
		 
			if (not ie_entou_w) then 
				ds_arquivo_w := ds_arquivo_w || lpad('0',15,'0') || lpad('0',15,'0') || lpad('0',15,'0');			
			end if;
			ie_entou_w := false;	
			ie_mes_w := to_char((ie_mes_w + 1)::numeric );
		end loop;
		 
		ds_arquivo_w := ds_arquivo_w || '0'; -- identificacao da situacao do rendimento 
		ds_arquivo_w := ds_arquivo_w || '1'; --especializacao das deducoes 
		ds_arquivo_w := ds_arquivo_w || lpad(' ',8,' '); --para uso do rfb 
		ds_arquivo_w := ds_arquivo_w || lpad(' ',32,' '); --para uso do declarante 
		ds_arquivo_w := ds_arquivo_w || '9'; --problemas com o windows (grande porte) 
		nr_seq_arquivo_w := nr_seq_arquivo_w + 1; --incremento de cada linha do arquivo 
		
		insert 	into w_dirf_arquivo(nr_sequencia, 
					   nm_usuario, 
					   nm_usuario_nrec, 
					   dt_atualizacao, 
					   dt_atualizacao_nrec, 
					   ds_arquivo, 
					   nr_seq_apresentacao, 
					   nr_seq_registro, 
					   cd_pessoa_fisica) 
		values (nextval('w_dirf_arquivo_seq'), 
					   nm_usuario_p, 
					   nm_usuario_p, 
					   clock_timestamp(), 
					   clock_timestamp(), 
					   ds_arquivo_w, 
					   '0588', 
					   1, 
					   cd_pessoa_fisica_w);		
	end if;
 
END LOOP;
CLOSE c05;
 
 
--Registro 03 
OPEN c06;
LOOP 
FETCH c06 INTO 
	cd_darf_w;
EXIT WHEN NOT FOUND; /* apply on c06 */
	ds_arquivo_w	:= 	--lpad(to_char(nr_seq_arquivo_w),8,'0') || 
				'3' || 
				lpad(coalesce(cd_cgc_estab_p,'0'),14,' ') || 
				lpad(cd_darf_w,4,'0') || 
				lpad('1',8,'0') || 
				lpad(' ',67,' ');
				 
	ie_mes_w := '01';
	ie_entou_w := false;
	 
	while (ie_mes_w)::numeric  <= 13 loop				 
		OPEN c07;
		LOOP 
		FETCH c07 INTO 
			vl_rendimento_w, 
			vl_irrf_w;
		EXIT WHEN NOT FOUND; /* apply on c07 */
			ds_arquivo_w := ds_arquivo_w ||lpad(coalesce(vl_rendimento_w,'0'),15,'0') || lpad('0',15,'0') || lpad(coalesce(vl_irrf_w,'0'),15,'0');
			ie_entou_w := true;
		END LOOP;
		CLOSE c07;
		 
		if (not ie_entou_w) then 
			ds_arquivo_w := ds_arquivo_w || lpad('0',15,'0') || lpad('0',15,'0') || lpad('0',15,'0');			
		end if;
		ie_entou_w := false;	
		ie_mes_w := to_char((ie_mes_w + 1)::numeric );		
	end loop;
	 
	ds_arquivo_w := ds_arquivo_w || lpad(' ',30,' ');
	ds_arquivo_w := ds_arquivo_w || lpad(' ',12,' ');
	ds_arquivo_w := ds_arquivo_w || '9'; --problemas com o windows (grande porte) 
	nr_seq_arquivo_w := nr_seq_arquivo_w + 1; --incremento de cada linha do arquivo 
	
	insert 	into w_dirf_arquivo(nr_sequencia, 
				   nm_usuario, 
				   nm_usuario_nrec, 
				   dt_atualizacao, 
				   dt_atualizacao_nrec, 
				   ds_arquivo, 
				   nr_seq_apresentacao, 
				   nr_seq_registro) 
	values (nextval('w_dirf_arquivo_seq'), 
				   nm_usuario_p, 
				   nm_usuario_p, 
				   clock_timestamp(), 
				   clock_timestamp(), 
				   ds_arquivo_w, 
				   lpad(cd_darf_w,4,'0'), 
				   2);
END LOOP;
CLOSE c06;
 
--nr_seq_arquivo_p := nr_seq_arquivo_w; 
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE m1_dirf_registro_tipo_2_3 (nr_seq_lote_dirf_p bigint, nr_seq_arquivo_p bigint, cd_cgc_estab_p text, nm_usuario_p text) FROM PUBLIC;

