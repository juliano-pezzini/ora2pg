-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE qua_documento_afterpost ( nm_usuario_p text, ie_acao_execut_p bigint, nr_sequencia_p bigint, ie_status_p text, cd_estabelecimento_p text, cd_pessoa_aprov_p text, cd_pessoa_validacao_p text, dt_elaboracao_p timestamp) AS $body$
DECLARE

 
/* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ 
Finalidade: 
------------------------------------------------------------------------------------------------------------------- 
Locais de chamada direta: 
[ ] Objetos do dicionário [ X ] Tasy (Delphi/Java) [ ] Portal [ ] Relatórios [ ] Outros: 
 ------------------------------------------------------------------------------------------------------------------ 
Pontos de atenção: 
------------------------------------------------------------------------------------------------------------------- 
Referências: 
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */
 
 
ie_multi_aprovador_w 			varchar(1);
ie_multi_validador_w			varchar(1);


BEGIN 
ie_multi_aprovador_w := obter_param_usuario(4000, 72, obter_perfil_ativo, wheb_usuario_pck.get_nm_usuario, wheb_usuario_pck.get_cd_estabelecimento, ie_multi_aprovador_w);
ie_multi_validador_w := obter_param_usuario(4000, 85, obter_perfil_ativo, wheb_usuario_pck.get_nm_usuario, wheb_usuario_pck.get_cd_estabelecimento, ie_multi_validador_w);
 
if (ie_acao_execut_p <> 3) then 
	CALL qua_gravar_doc_log_acesso(	nr_sequencia_p, 
					'A', 
					nm_usuario_p);
end if;
 
if (ie_acao_execut_p = 1) then 
	CALL qua_gerar_setor_envolv_doc(	nr_sequencia_p, 
					nm_usuario_p);
end if;
 
if (ie_acao_execut_p = 1) and (ie_status_p = 'P') then 
	CALL qua_gerar_envio_comunicacao(	nr_sequencia_p, 
					'0', 
					nm_usuario_p, 
					'28', 
					cd_estabelecimento_p, 
					0, 
					0, 
					'N');
end if;
 
if (upper(ie_multi_aprovador_w) = 'S') and (cd_pessoa_aprov_p IS NOT NULL AND cd_pessoa_aprov_p::text <> '') then 
	CALL qua_gerar_aprov_doc(	nr_sequencia_p, 
				cd_pessoa_aprov_p, 
				nm_usuario_p);
end if;
 
if (upper(ie_multi_validador_w) = 'S')then 
	CALL qua_gerar_valid_doc(	nr_sequencia_p, 
				cd_pessoa_validacao_p, 
				nm_usuario_p);
end if;
 
if (ie_acao_execut_p = 1) and (dt_elaboracao_p IS NOT NULL AND dt_elaboracao_p::text <> '') then 
	CALL qua_gerar_envio_comunicacao(nr_sequencia_p,'0',nm_usuario_p,'8',cd_estabelecimento_p,0,0,'N');
	 
	CALL qua_gravar_doc_log_acesso(	nr_sequencia_p, 
					'C', 
					nm_usuario_p);
	--QUANDO O WDBPANEL VIER VAZIO POR PADRÃO AO ENTRAR NA FUNÇÃO E FOREM ADICIONADOS DOCUMENTOS, 
	--ATUALIZA A CONSULTA APENAS COM OS DOCUMENTOS ADICIONADOS. 
end if;
 
commit;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE qua_documento_afterpost ( nm_usuario_p text, ie_acao_execut_p bigint, nr_sequencia_p bigint, ie_status_p text, cd_estabelecimento_p text, cd_pessoa_aprov_p text, cd_pessoa_validacao_p text, dt_elaboracao_p timestamp) FROM PUBLIC;

