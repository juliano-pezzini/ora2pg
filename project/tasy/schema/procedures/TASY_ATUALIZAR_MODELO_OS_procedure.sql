-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE tasy_atualizar_modelo_os () AS $body$
DECLARE


nr_sequencia_w		bigint;
ds_modelo_os_w		varchar(2000);
ds_modelo_desenho_os_w	varchar(2000);
ds_grupo_perg_os_w	varchar(2000);
ds_pergunta_os_w		varchar(2000);
ds_perg_result_os_w	varchar(2000);
ds_perg_visual_os_w	varchar(2000);
ds_modelo_conteudo_os_w	varchar(2000);
ds_regra_quest_os_w	varchar(2000);
ds_insert_w		varchar(2000);
ds_comando_w		varchar(2000);
ds_parametros_w		varchar(2000);
qt_existe_w		bigint;


c010  		integer;
retorno_w		integer;

ds_comando_c010_w varchar(2000):= ' select	nr_sequencia ' ||
				' from	tasy_versao.modelo_os ' ||
				' where	dt_atualizacao >= obter_data_geracao_versao ';


BEGIN
select	obter_atributo_tabela('MODELO_OS'),
	obter_atributo_tabela('MODELO_DESENHO_OS'),
	obter_atributo_tabela('GRUPO_PERGUNTA_OS'),
	obter_atributo_tabela('PERGUNTA_OS'),
	obter_atributo_tabela('PERGUNTA_RESULT_OS'),
	obter_atributo_tabela('PERGUNTA_VISUAL_OS'),
	obter_atributo_tabela('MODELO_CONTEUDO_OS'),
	obter_atributo_tabela('REGRA_QUEST_OS_PHILIPS')
into STRICT	ds_modelo_os_w,
	ds_modelo_desenho_os_w,
	ds_grupo_perg_os_w,
	ds_pergunta_os_w,
	ds_perg_result_os_w,
	ds_perg_visual_os_w,
	ds_modelo_conteudo_os_w,
	ds_regra_quest_os_w
;

C010 := DBMS_SQL.OPEN_CURSOR;
DBMS_SQL.PARSE(C010, ds_comando_c010_w, dbms_sql.Native);
DBMS_SQL.DEFINE_COLUMN(C010, 1, nr_sequencia_w);
retorno_w := DBMS_SQL.execute(c010);

while(DBMS_SQL.FETCH_ROWS(C010) > 0) loop
	DBMS_SQL.COLUMN_VALUE(C010, 1, nr_sequencia_w);

	select	count(*)
	into STRICT	qt_existe_w
	from	modelo_os
	where	nr_sequencia = nr_sequencia_w;

	if (qt_existe_w = 0) then
	/*	Inserir a tabela modelo_os */

		ds_insert_w	:= ds_modelo_os_w;
		ds_comando_w	:= 'insert into modelo_os (' || ds_modelo_os_w ||
				') select ' || ds_insert_w || ' from tasy_versao.modelo_os ' ||
				'where nr_sequencia = :NR_SEQUENCIA';
		CALL gravar_processo_longo(ds_comando_w,'TASY_ATUALIZAR_MODELO_OS',null);
		ds_parametros_w := 'NR_SEQUENCIA='  || nr_sequencia_w  ||';';
		CALL Exec_Sql_Dinamico_bv('Insert Modelo OS: ' || nr_sequencia_w, ds_comando_w,ds_parametros_w);
	end if;

	/*	Inserir a tabela modelo_desenho_os */

	ds_insert_w	:= ds_modelo_desenho_os_w;
	ds_comando_w	:= 'insert into modelo_desenho_os (' || ds_modelo_desenho_os_w ||
			') select ' || ds_insert_w || ' from tasy_versao.modelo_desenho_os a ' ||
			' where nr_seq_modelo = :NR_SEQUENCIA and not exists (select 1 from modelo_desenho_os b where b.nr_sequencia = a.nr_sequencia) ';
	CALL gravar_processo_longo(ds_comando_w,'TASY_ATUALIZAR_MODELO_OS',null);
	ds_parametros_w := 'NR_SEQUENCIA='  || nr_sequencia_w  ||';';

	CALL Exec_Sql_Dinamico_bv('Insert Modelo Desenho OS: ' || nr_sequencia_w, ds_comando_w,ds_parametros_w);

	/*	Inserir a tabela grupo_pergunta_os */

	ds_insert_w	:= ds_grupo_perg_os_w;
	ds_comando_w	:= 'insert into grupo_pergunta_os (' || ds_grupo_perg_os_w ||
			') select ' || ds_insert_w || ' from tasy_versao.grupo_pergunta_os a ' ||
			' where :nr_sequencia = :NR_SEQUENCIA and not exists (select 1 from grupo_pergunta_os b where b.nr_sequencia = a.nr_sequencia) ';
	CALL gravar_processo_longo(ds_comando_w,'TASY_ATUALIZAR_MODELO_OS',null);
	ds_parametros_w := 'NR_SEQUENCIA='  || nr_sequencia_w  ||';';
	CALL Exec_Sql_Dinamico_bv('Insert Grupo Pergunta Desenho OS: ' || nr_sequencia_w, ds_comando_w,ds_parametros_w);

	/*	Inserir a tabela pergunta_os */

	ds_insert_w	:= ds_pergunta_os_w;
	ds_comando_w	:= 'insert into pergunta_os (' || ds_pergunta_os_w ||
			') select ' || ds_insert_w || ' from tasy_versao.pergunta_os a ' ||
			' where :nr_sequencia = :NR_SEQUENCIA and not exists (select 1 from pergunta_os b where b.nr_sequencia = a.nr_sequencia) ';
	CALL gravar_processo_longo(ds_comando_w,'TASY_ATUALIZAR_MODELO_OS',null);
	ds_parametros_w := 'NR_SEQUENCIA='  || nr_sequencia_w  ||';';
	CALL Exec_Sql_Dinamico_bv('Insert Pergunta OS: ' || nr_sequencia_w, ds_comando_w,ds_parametros_w);

	/*	Inserir a tabela pergunta_result_os */

	ds_insert_w	:= ds_perg_result_os_w;
	ds_comando_w	:= 'insert into pergunta_result_os (' || ds_perg_result_os_w ||
			') select ' || ds_insert_w || ' from tasy_versao.pergunta_result_os a ' ||
			' where :nr_sequencia = :NR_SEQUENCIA and not exists (select 1 from pergunta_result_os b where b.nr_sequencia = a.nr_sequencia) ';
	CALL gravar_processo_longo(ds_comando_w,'TASY_ATUALIZAR_MODELO_OS',null);
	ds_parametros_w := 'NR_SEQUENCIA='  || nr_sequencia_w  ||';';
	CALL Exec_Sql_Dinamico_bv('Insert Pergunta Result OS: ' || nr_sequencia_w, ds_comando_w,ds_parametros_w);

	/*	Inserir a tabela pergunta_visual_os */

	ds_insert_w	:= ds_perg_visual_os_w;
	ds_comando_w	:= 'insert into pergunta_visual_os (' || ds_perg_visual_os_w ||
			') select ' || ds_insert_w || ' from tasy_versao.pergunta_visual_os a ' ||
			' where :nr_sequencia = :NR_SEQUENCIA and not exists (select 1 from pergunta_visual_os b where b.nr_sequencia = a.nr_sequencia) ';
	CALL gravar_processo_longo(ds_comando_w,'TASY_ATUALIZAR_MODELO_OS',null);
	ds_parametros_w := 'NR_SEQUENCIA='  || nr_sequencia_w  ||';';
	CALL Exec_Sql_Dinamico_bv('Insert Pergunta Visual OS: ' || nr_sequencia_w, ds_comando_w,ds_parametros_w);

	/*	Inserir a tabela modelo_conteudo_os */

	ds_insert_w	:= ds_modelo_conteudo_os_w;
	ds_comando_w	:= 'insert into modelo_conteudo_os (' || ds_modelo_conteudo_os_w ||
			') select ' || ds_insert_w || ' from tasy_versao.modelo_conteudo_os a ' ||
			' where nr_seq_modelo = :NR_SEQUENCIA and not exists (select 1 from modelo_conteudo_os b where b.nr_sequencia = a.nr_sequencia) ';
	CALL gravar_processo_longo(ds_comando_w,'TASY_ATUALIZAR_MODELO_OS',null);
	ds_parametros_w := 'NR_SEQUENCIA='  || nr_sequencia_w  ||';';
	CALL Exec_Sql_Dinamico_bv('Insert Modelo Cont OS: ' || nr_sequencia_w, ds_comando_w,ds_parametros_w);

	/*	Inserir a tabela regra_quest_os_philips */

	ds_insert_w	:= ds_regra_quest_os_w;
	ds_comando_w	:= 'insert into regra_quest_os_philips (' || ds_regra_quest_os_w ||
			') select ' || ds_insert_w || ' from tasy_versao.regra_quest_os_philips a ' ||
			' where nr_seq_modelo_OS = :NR_SEQUENCIA and not exists (select 1 from regra_quest_os_philips b where b.nr_sequencia = a.nr_sequencia) ';
	CALL gravar_processo_longo(ds_comando_w,'TASY_ATUALIZAR_MODELO_OS',null);
	ds_parametros_w := 'NR_SEQUENCIA='  || nr_sequencia_w  ||';';
	CALL Exec_Sql_Dinamico_bv('Insert Regra Quest OS: ' || nr_sequencia_w, ds_comando_w,ds_parametros_w);

END LOOP;
DBMS_SQL.CLOSE_CURSOR(C010);

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE tasy_atualizar_modelo_os () FROM PUBLIC;

