-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE lab_vincula_formato_resultado (nr_prescricao_p bigint, nm_usuario_p text) AS $body$
DECLARE

					 
nr_seq_resultado_w	exame_lab_resultado.nr_seq_resultado%type;
nr_prescricao_w		prescr_procedimento.nr_prescricao%type;
nr_seq_prescr_w		prescr_procedimento.nr_sequencia%type;
nr_seq_exame_w		prescr_procedimento.nr_seq_exame%type;
nr_seq_material_w	exame_lab_result_item.nr_seq_material%type;
dt_prescricao_w		prescr_medica.dt_prescricao%type;
dt_nascimento_w		timestamp;
ie_sexo_w		varchar(1);

C01 CURSOR FOR 
SELECT	c.nr_seq_resultado, 
	b.nr_prescricao, 
	b.nr_sequencia, 
	b.nr_seq_exame, 
	d.nr_seq_material, 
	a.dt_prescricao, 
	obter_nascimento_prescricao(a.nr_prescricao), 
	obter_sexo_prescricao(a.nr_prescricao) 
from	prescr_medica a, 
	prescr_procedimento b, 
	exame_lab_resultado c, 
	exame_lab_result_item d 
where	b.nr_prescricao = a.nr_prescricao 
 and	c.nr_prescricao = a.nr_prescricao 
 and	d.nr_seq_resultado = c.nr_seq_resultado 
 and	d.nr_seq_prescr = b.nr_sequencia 
 and	a.nr_prescricao = nr_prescricao_p 
 and	b.ie_status_atend = 30 
 and	coalesce(b.ie_suspenso, 'N') = 'N' 
 and 	(d.nr_seq_material IS NOT NULL AND d.nr_seq_material::text <> '') 
 and	coalesce(d.nr_seq_formato, 0) = 0;
	
 

BEGIN 
 
open C01;
loop 
	fetch C01 into	 
		nr_seq_resultado_w, 
		nr_prescricao_w, 
		nr_seq_prescr_w, 
		nr_seq_exame_w, 
		nr_seq_material_w, 
		dt_prescricao_w, 
		dt_nascimento_w, 
		ie_sexo_w;
	if C01%found then      				 
		CALL gera_resultado_lab(nr_seq_resultado_w, nr_prescricao_w, nr_seq_prescr_w, nr_seq_exame_w, nr_seq_material_w, (dt_prescricao_w - dt_nascimento_w) / 365.25, ie_sexo_w, nm_usuario_p);
	else 
		exit;
	end if;
end loop;
close C01;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE lab_vincula_formato_resultado (nr_prescricao_p bigint, nm_usuario_p text) FROM PUBLIC;

