-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE tiss_obter_guia_prest_autor ( cd_convenio_p bigint, cd_estabelecimento_p bigint, ie_tipo_autorizacao_p text, nr_atendimento_p bigint, nr_seq_agenda_p bigint, nr_seq_agenda_integ_p bigint, nr_guia_prest_p INOUT text ) AS $body$
DECLARE

/*
EUP - Numero da guia da EUP
IN -	Intervalo de numeracao
SAT - Senha atual do atendimento
CIP - Codigo interno do prestador
GAT - Numero de guia informado na "Agenda Integrada"
GAE - Numero de guia informado na "Agenda de Exames"
NA - Numero do atendimento
*/
nr_guia_prest_w     varchar(20) := null;
ie_forma_w            regra_guia_prest_autor.ie_forma%type;
nr_atual_w             regra_guia_prest_autor.nr_atual%type;
nr_sequencia_w     regra_guia_prest_autor.nr_sequencia%type;

c01 CURSOR FOR
SELECT ie_forma,
        nr_atual,
        nr_sequencia
from regra_guia_prest_autor
where ie_situacao = 'A'
and cd_estabelecimento = cd_estabelecimento_p
and cd_convenio = cd_convenio_p
and ie_tipo_autorizacao = ie_tipo_autorizacao_p
order by ie_prioridade nulls last;--Conforme visto com Ronaldo, caso nao tenha informacao (nr_guia_prest_w = null) deve ir para proxima linha
BEGIN
open c01;
loop
  fetch c01 into
    ie_forma_w,
    nr_atual_w,
    nr_sequencia_w;

  if (ie_forma_w = 'EUP' and coalesce(nr_guia_prest_w::text, '') = '') then --Numero da guia da EUP
	  begin
		  select	b.nr_doc_convenio			
		  into STRICT	nr_guia_prest_w
		  from	atend_categoria_convenio b,
			  atendimento_paciente a			
		  where	a.nr_atendimento		= b.nr_atendimento			
		    and	b.nr_seq_interno		= obter_atecaco_atend_conv(a.nr_atendimento,cd_convenio_p)
		    and	a.nr_atendimento		= nr_atendimento_p  LIMIT 1;
	  exception
	  when others then
		  nr_guia_prest_w	:= null;
	  end;
  elsif (ie_forma_w = 'IN' and coalesce(nr_guia_prest_w::text, '') = '')then    --Intervalo de numeracao
    if (nr_atual_w IS NOT NULL AND nr_atual_w::text <> '') then
		  nr_guia_prest_w	:= nr_atual_w;
		
		  update	regra_guia_prest_autor
		  set	nr_atual 	= nr_atual_w + 1,				
			  dt_atualizacao	= clock_timestamp()		
		  where	nr_sequencia	= nr_sequencia_w;
	  end if;
  elsif (ie_forma_w = 'SAT' and coalesce(nr_guia_prest_w::text, '') = '') then --Senha atual do atendimento
    begin
		  select	b.cd_senha			
		  into STRICT	nr_guia_prest_w
		  from	atend_categoria_convenio b,
			  atendimento_paciente a			
		  where	a.nr_atendimento		= b.nr_atendimento			
		    and	b.nr_seq_interno		= obter_atecaco_atend_conv(a.nr_atendimento,cd_convenio_p)
		    and	a.nr_atendimento		= nr_atendimento_p  LIMIT 1;
	    exception
	    when others then
		    nr_guia_prest_w	:= null;
	  end;
  elsif (ie_forma_w = 'CIP' and coalesce(nr_guia_prest_w::text, '') = '') then --Codigo interno do prestador
    select	max(obter_valor_conv_estab(cd_convenio_p, cd_estabelecimento_p, 'CD_INTERNO'))
	  into STRICT	nr_guia_prest_w
	;
  elsif (ie_forma_w = 'GAT' and coalesce(nr_guia_prest_w::text, '') = '') then --Numero de guia informado na "Agenda Integrada"
    if (nr_seq_agenda_integ_p IS NOT NULL AND nr_seq_agenda_integ_p::text <> '') then
      select a.nr_doc_convenio
      into STRICT nr_guia_prest_w
      from agenda_integrada a
      where a.nr_sequencia = nr_seq_agenda_integ_p;
    end if;
  elsif (ie_forma_w = 'GAE' and coalesce(nr_guia_prest_w::text, '') = '') then --Numero de guia informado na "Agenda de Exames"
    if (nr_seq_agenda_p IS NOT NULL AND nr_seq_agenda_p::text <> '') then
      select a.nr_doc_convenio
      into STRICT nr_guia_prest_w
      from agenda_paciente a
      where a.nr_sequencia = nr_seq_agenda_p;
    end if;
  elsif (ie_forma_w = 'NA' and coalesce(nr_guia_prest_w::text, '') = '') then --Numero do atendimento
    nr_guia_prest_w := nr_atendimento_p;
  end if;

  EXIT WHEN NOT FOUND; /* apply on c01 */
end loop;
close c01;

nr_guia_prest_p := nr_guia_prest_w;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE tiss_obter_guia_prest_autor ( cd_convenio_p bigint, cd_estabelecimento_p bigint, ie_tipo_autorizacao_p text, nr_atendimento_p bigint, nr_seq_agenda_p bigint, nr_seq_agenda_integ_p bigint, nr_guia_prest_p INOUT text ) FROM PUBLIC;

