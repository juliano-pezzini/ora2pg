-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE calcular_complexidade_abemid ( nr_sequencia_p text) AS $body$
DECLARE


sup_terapeutico_total_w		numeric(20) := 0;
quimio_total_w			numeric(20) := 0;
sup_ventilatorio_total_w	numeric(20) := 0;
lesao_vascular_total_w		numeric(20) := 0;
grau_atividade_total_w		numeric(20) := 0;
dep_reabilitacao_total_w	numeric(20) := 0;
ter_nutricional_total_w		numeric(20) := 0;
total_pontos_w			numeric(20) := 0;
ponto_w				numeric(20) := 0;
cont_w				numeric(20) := 0;
ie_complexidade_w		varchar(10);
qt_dias_progr_w			numeric(20);

ie_dr_dependente_w  	   	varchar(10);
ie_dr_independente_w       	varchar(10);
ie_ga_depen_total_w		varchar(10);
ie_ga_independente_w     	varchar(10);
ie_ga_semi_indepen_w    	varchar(10);
ie_lv_ulcera_graui_w     	varchar(10);
ie_lv_ulcera_grauii_w     	varchar(10);
ie_lv_ulcera_grauiii_w     	varchar(10);
ie_lv_ulcera_grauiv_w     	varchar(10);
ie_qu_intra_tecal_w     	varchar(10);
ie_qu_intra_venosa_w     	varchar(10);
ie_qu_oral_w     		varchar(10);
ie_qu_subcutanea_w     		varchar(10);
ie_sp_aces_veneso_peri_w    	varchar(10);
ie_sp_aces_venoso_cont_w    	varchar(10);
ie_sp_aces_venoso_inter_w   	varchar(10);
ie_sp_asp_aerea_sup_w     	varchar(10);
ie_sp_dialise_domi_w     	varchar(10);
ie_sp_sonda_inter_w     	varchar(10);
ie_sp_sonda_perm_w     		varchar(10);
ie_sp_traque_com_asp_w     	varchar(10);
ie_sp_traque_sem_asp_w    	varchar(10);
ie_sv_o2_cont_w     		varchar(10);
ie_sv_o2_inter_w     		varchar(10);
ie_sv_venti_conti_w     	varchar(10);
ie_sv_venti_inter_w     	varchar(10);
ie_tn_gastronomia_w     	varchar(10);
ie_tn_jejuno_w     		varchar(10);
ie_tn_nutricao_w     		varchar(10);
ie_tn_sne_w     		varchar(10);
ie_tn_suple_oral_w		varchar(10);


BEGIN

select
	ie_dr_dependente,
	ie_dr_independente,
	ie_ga_depen_total,
	ie_ga_independente,
	ie_ga_semi_indepen,
	ie_lv_ulcera_graui,
	ie_lv_ulcera_grauii,
	ie_lv_ulcera_grauiii,
	ie_lv_ulcera_grauiv,
	ie_qu_intra_tecal,
	ie_qu_intra_venosa,
	ie_qu_oral,
	ie_qu_subcutanea,
	ie_sp_aces_veneso_peri,
	ie_sp_aces_venoso_cont,
	ie_sp_aces_venoso_inter,
	ie_sp_asp_aerea_sup,
	ie_sp_dialise_domi,
	ie_sp_sonda_inter,
	ie_sp_sonda_perm,
	ie_sp_traque_com_asp,
	ie_sp_traque_sem_asp,
	ie_sv_o2_cont,
	ie_sv_o2_inter,
	ie_sv_venti_conti,
	ie_sv_venti_inter,
	ie_tn_gastronomia,
	ie_tn_jejuno,
	ie_tn_nutricao,
	ie_tn_sne,
	ie_tn_suple_oral
into STRICT
	ie_dr_dependente_w,
	ie_dr_independente_w,
	ie_ga_depen_total_w,
	ie_ga_independente_w,
	ie_ga_semi_indepen_w,
	ie_lv_ulcera_graui_w,
	ie_lv_ulcera_grauii_w,
	ie_lv_ulcera_grauiii_w,
	ie_lv_ulcera_grauiv_w,
	ie_qu_intra_tecal_w,
	ie_qu_intra_venosa_w,
	ie_qu_oral_w,
	ie_qu_subcutanea_w,
	ie_sp_aces_veneso_peri_w,
	ie_sp_aces_venoso_cont_w,
	ie_sp_aces_venoso_inter_w,
	ie_sp_asp_aerea_sup_w,
	ie_sp_dialise_domi_w,
	ie_sp_sonda_inter_w,
	ie_sp_sonda_perm_w,
	ie_sp_traque_com_asp_w,
	ie_sp_traque_sem_asp_w,
	ie_sv_o2_cont_w,
	ie_sv_o2_inter_w,
	ie_sv_venti_conti_w,
	ie_sv_venti_inter_w,
	ie_tn_gastronomia_w,
	ie_tn_jejuno_w,
	ie_tn_nutricao_w,
	ie_tn_sne_w,
	ie_tn_suple_oral_w
from	HC_AVALIACAO_ABEMID
where	nr_sequencia = nr_sequencia_p;

-- soma pontos do suporte teraéutico
if (ie_sp_sonda_perm_w = 'S' ) then
	ponto_w := obter_ponto_abemid('IE_SP_SONDA_PERM');
	if (ponto_w > sup_terapeutico_total_w) then
		sup_terapeutico_total_w := ponto_w;
	end if;
end if;

if (ie_sp_sonda_inter_w = 'S') then
	ponto_w := obter_ponto_abemid('IE_SP_SONDA_INTER');
	if (ponto_w > sup_terapeutico_total_w) then
		sup_terapeutico_total_w := ponto_w;
	end if;
end if;

if (ie_sp_traque_sem_asp_w = 'S') then
	ponto_w := obter_ponto_abemid('IE_SP_TRAQUE_SEM_ASP');
	if (ponto_w > sup_terapeutico_total_w) then
		sup_terapeutico_total_w := ponto_w;
	end if;
end if;

if (ie_sp_traque_com_asp_w = 'S') then
	ponto_w := obter_ponto_abemid('IE_SP_TRAQUE_COM_ASP');
	if (ponto_w > sup_terapeutico_total_w) then
		sup_terapeutico_total_w := ponto_w;
	end if;
	cont_w := cont_w + 1;
end if;

if (ie_sp_asp_aerea_sup_w = 'S') then
	ponto_w := obter_ponto_abemid('IE_SP_ASP_AEREA_SUP');
	if (ponto_w > sup_terapeutico_total_w) then
		sup_terapeutico_total_w := ponto_w;
	end if;
end if;

if (ie_sp_aces_venoso_cont_w = 'S') then
	ponto_w := obter_ponto_abemid('IE_SP_ACES_VENOSO_CONT');
	if (ponto_w > sup_terapeutico_total_w) then
		sup_terapeutico_total_w := ponto_w;
	end if;
	cont_w := cont_w + 1;
end if;

if (ie_sp_aces_venoso_inter_w = 'S') then
	ponto_w := obter_ponto_abemid('IE_SP_ACES_VENOSO_INTER');
	if (ponto_w > sup_terapeutico_total_w) then
		sup_terapeutico_total_w := ponto_w;
	end if;
end if;

if (ie_sp_aces_veneso_peri_w = 'S') then
	ponto_w := obter_ponto_abemid('IE_SP_ACES_VENESO_PERI');
	if (ponto_w > sup_terapeutico_total_w) then
		sup_terapeutico_total_w := ponto_w;
	end if;
	cont_w := cont_w + 1;
end if;

if (ie_sp_dialise_domi_w = 'S') then
	ponto_w := obter_ponto_abemid('IE_SP_DIALISE_DOMI');
	if (ponto_w > sup_terapeutico_total_w) then
		sup_terapeutico_total_w := ponto_w;
	end if;
	cont_w := cont_w + 1;
end if;

total_pontos_w := sup_terapeutico_total_w;
--if (sup_terapeutico_total_w = 5) then
--	cont_w := cont_w + 1;
-- FIM SUPORTE TERAPEUTICA
-- Quimioterapia
if (ie_qu_oral_w = 'S') then
	ponto_w := obter_ponto_abemid('IE_QU_ORAL');
	if (ponto_w > quimio_total_w ) then
		quimio_total_w := ponto_w;
	end if;
	total_pontos_w := total_pontos_w + ponto_w;
end if;

if (ie_qu_subcutanea_w = 'S') then
	ponto_w := obter_ponto_abemid('IE_QU_SUBCUTANEA');
	if (ponto_w > quimio_total_w ) then
		quimio_total_w := ponto_w;
	end if;
	total_pontos_w := total_pontos_w + ponto_w;
end if;

if (ie_qu_intra_venosa_w = 'S') then
	ponto_w := obter_ponto_abemid('IE_QU_INTRA_VENOSA');
	if (ponto_w > quimio_total_w ) then
		quimio_total_w := ponto_w;
	end if;
	total_pontos_w := total_pontos_w + ponto_w;
	if (quimio_total_w = 5) then
		cont_w := cont_w + 1;
	end if;
end if;

if (ie_qu_intra_tecal_w = 'S') then
	ponto_w := obter_ponto_abemid('IE_QU_INTRA_TECAL');
	if (ponto_w > quimio_total_w ) then
		quimio_total_w := ponto_w;
	end if;
	total_pontos_w := total_pontos_w + ponto_w;

	if (quimio_total_w = 5) then
		cont_w := cont_w + 1;
	end if;
end if;




-- Fim Quimioterapia
--Suporte Ventilatório
if (ie_sv_o2_inter_w = 'S') then
	ponto_w := obter_ponto_abemid('IE_SV_O2_INTER');
	if (ponto_w > sup_ventilatorio_total_w ) then
		sup_ventilatorio_total_w := ponto_w;
	end if;
	total_pontos_w := total_pontos_w + ponto_w;
end if;

if (ie_sv_o2_cont_w = 'S') then
	ponto_w := obter_ponto_abemid('IE_SV_O2_CONT');
	if (ponto_w > sup_ventilatorio_total_w ) then
		sup_ventilatorio_total_w := ponto_w;
	end if;
	total_pontos_w := total_pontos_w + ponto_w;
end if;

if (ie_sv_venti_inter_w = 'S') then
	ponto_w := obter_ponto_abemid('IE_SV_VENTI_INTER');
	if (ponto_w > sup_ventilatorio_total_w ) then
		sup_ventilatorio_total_w := ponto_w;
	end if;
	total_pontos_w := total_pontos_w + ponto_w;
end if;

if (ie_sv_venti_conti_w = 'S') then
	ponto_w := obter_ponto_abemid('IE_SV_VENTI_CONTI');
	if (ponto_w > sup_ventilatorio_total_w ) then
		sup_ventilatorio_total_w := ponto_w;
	end if;
	total_pontos_w := total_pontos_w + ponto_w;
end if;

if (sup_ventilatorio_total_w = 5) then
	cont_w := cont_w + 1;
end if;

-- fIM
--Lesão Vascular
if (ie_lv_ulcera_graui_w = 'S') then
	ponto_w := obter_ponto_abemid('IE_LV_ULCERA_GRAUI');
	if (ponto_w > lesao_vascular_total_w ) then
		lesao_vascular_total_w := ponto_w;
	end if;
	total_pontos_w := total_pontos_w + ponto_w;
end if;

if (ie_lv_ulcera_grauii_w = 'S') then
	ponto_w := obter_ponto_abemid('IE_LV_ULCERA_GRAUII');
	if (ponto_w > lesao_vascular_total_w ) then
		lesao_vascular_total_w := ponto_w;
	end if;
	total_pontos_w := total_pontos_w + ponto_w;
end if;

if (ie_lv_ulcera_grauiii_w = 'S') then
	ponto_w := obter_ponto_abemid('IE_LV_ULCERA_GRAUIII');
	if (ponto_w > lesao_vascular_total_w ) then
		lesao_vascular_total_w := ponto_w;
	end if;
	total_pontos_w := total_pontos_w + ponto_w;
end if;

if (ie_lv_ulcera_grauiv_w = 'S') then
	ponto_w := obter_ponto_abemid('IE_LV_ULCERA_GRAUIV');
	if (ponto_w > lesao_vascular_total_w ) then
		lesao_vascular_total_w := ponto_w;
	end if;
	total_pontos_w := total_pontos_w + ponto_w;
end if;

if (lesao_vascular_total_w = 5) then
	cont_w := cont_w + 1;
end if;
-- fim
--Grau de Atividade
if (ie_ga_independente_w = 'S') then
	ponto_w := obter_ponto_abemid('IE_GA_INDEPENDENTE');
	if (ponto_w > grau_atividade_total_w ) then
		grau_atividade_total_w := ponto_w;
	end if;
	total_pontos_w := total_pontos_w + ponto_w;
end if;

if (ie_ga_semi_indepen_w = 'S') then
	ponto_w := obter_ponto_abemid('IE_GA_SEMI_INDEPEN');
	if (ponto_w > grau_atividade_total_w ) then
		grau_atividade_total_w := ponto_w;
	end if;
	total_pontos_w := total_pontos_w + ponto_w;
end if;

if (ie_ga_depen_total_w = 'S') then
	ponto_w := obter_ponto_abemid('IE_GA_DEPEN_TOTAL');
	if (ponto_w > grau_atividade_total_w ) then
		grau_atividade_total_w := ponto_w;
	end if;
	total_pontos_w := total_pontos_w + ponto_w;
end if;

if (grau_atividade_total_w = 5) then
	cont_w := cont_w + 1;
end if;

--Fim
--Dependência de Reabilitação
if (ie_dr_independente_w = 'S') then
	ponto_w := obter_ponto_abemid('IE_DR_INDEPENDENTE');
	if (ponto_w > dep_reabilitacao_total_w ) then
		dep_reabilitacao_total_w := ponto_w;
	end if;
	total_pontos_w := total_pontos_w + ponto_w;
end if;

if (ie_dr_dependente_w = 'S') then
	ponto_w := obter_ponto_abemid('IE_DR_DEPENDENTE');
	if (ponto_w > dep_reabilitacao_total_w ) then
		dep_reabilitacao_total_w := ponto_w;
	end if;
	total_pontos_w := total_pontos_w + ponto_w;
end if;

if (dep_reabilitacao_total_w = 5) then
	cont_w := cont_w + 1;
end if;

-- FIM
--Terapia Nutricional
if (ie_tn_suple_oral_w = 'S') then
	ponto_w := obter_ponto_abemid('IE_TN_SUPLE_ORAL');
	if (ponto_w > ter_nutricional_total_w ) then
		ter_nutricional_total_w := ponto_w;
	end if;
	total_pontos_w := total_pontos_w + ponto_w;
end if;

if (ie_tn_gastronomia_w = 'S') then
	ponto_w := obter_ponto_abemid('IE_TN_GASTRONOMIA');
	if (ponto_w > ter_nutricional_total_w ) then
		ter_nutricional_total_w := ponto_w;
	end if;
	total_pontos_w := total_pontos_w + ponto_w;
end if;

if (ie_tn_sne_w = 'S') then
	ponto_w := obter_ponto_abemid('IE_TN_SNE');
	if (ponto_w > ter_nutricional_total_w ) then
		ter_nutricional_total_w := ponto_w;
	end if;
	total_pontos_w := total_pontos_w + ponto_w;
end if;

if (ie_tn_jejuno_w = 'S') then
	ponto_w := obter_ponto_abemid('IE_TN_JEJUNO');
	if (ponto_w > ter_nutricional_total_w ) then
		ter_nutricional_total_w := ponto_w;
	end if;
	total_pontos_w := total_pontos_w + ponto_w;
end if;

if (ie_tn_nutricao_w = 'S') then
	ponto_w := obter_ponto_abemid('IE_TN_NUTRICAO');
	if (ponto_w > ter_nutricional_total_w ) then
		ter_nutricional_total_w := ponto_w;
	end if;
	total_pontos_w := total_pontos_w + ponto_w;
end if;

if (ter_nutricional_total_w = 5) then
	cont_w := cont_w + 1;
end if;

--FIM
-- complexidade
if (cont_w >= 2) then
	ie_complexidade_w := '4'; --alta
elsif (cont_w = 1) then
	ie_complexidade_w := '2'; --media
elsif (total_pontos_w <= 7) then
	ie_complexidade_w := '0';
elsif (total_pontos_w >= 8) and (total_pontos_w <= 12) then
	ie_complexidade_w := '1';
elsif (total_pontos_w >= 13) and (total_pontos_w <= 18) then
	ie_complexidade_w := '2';
else
	ie_complexidade_w := '4';
end if;

-- qtd horas da programacao de visita
if (ie_ga_independente_w = 'S') then
	qt_dias_progr_w := 6;
elsif (ie_ga_semi_indepen_w = 'S') then
	qt_dias_progr_w := 12;
elsif (ie_ga_depen_total_w = 'S') then
	qt_dias_progr_w := 24;
else
	qt_dias_progr_w := 6;
end if;

if (ie_complexidade_w >= 4 ) then
	qt_dias_progr_w := 24;
end if;

update	HC_AVALIACAO_ABEMID set	IE_COMPLEXIDADE = ie_complexidade_w,
								NR_TOTAL_PONTOS = total_pontos_w,
								QT_PROG_DIAS_ATEND = qt_dias_progr_w
where	nr_sequencia = nr_sequencia_p;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE calcular_complexidade_abemid ( nr_sequencia_p text) FROM PUBLIC;

