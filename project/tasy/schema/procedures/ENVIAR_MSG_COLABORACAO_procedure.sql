-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE enviar_msg_colaboracao (cd_destinatarios_p text, nm_usuario_p text, ds_mensagem_p text, ds_assunto_p text, nr_exame_p text, cd_remetente_p text) AS $body$
WITH RECURSIVE cte AS (
DECLARE

 
c01 is CURSOR 
with data as (SELECT cd_destinatarios_p str ) 
SELECT trim(both regexp_substr(str, '[^,]+', 1, 1)) valor_w 
from data 
instr(str, ',', 1, level - 1) > 0  UNION ALL
DECLARE
 
 
c01 is CURSOR 
with data as (SELECT cd_destinatarios_p str ) 
SELECT trim(both regexp_substr(str, '[^,]+', 1, (c.level+1))) valor_w 
from data 
instr(str, ',', 1, level - 1) > 0 JOIN cte c ON ()

) SELECT * FROM cte;
;

linha_w			     c01%rowtype;


BEGIN 
 begin 
  open C01;
 exception when others then 
  CALL wheb_mensagem_pck.exibir_mensagem_abort(881309);
 end;
 
 loop 
 fetch C01 into 
  linha_w;
 EXIT WHEN NOT FOUND; /* apply on c01 */
  begin 
   if (linha_w.valor_w IS NOT NULL AND linha_w.valor_w::text <> '') then 
    insert into mensagem_colaboracao(nr_sequencia,ie_lido,dt_atualizacao,nm_usuario,ds_mensagem,ds_assunto,ie_excluido,NM_USUARIO_DESTINATARIO,NR_EXAME)     
    values (nextval('mensagem_colaboracao_seq'), 'N', clock_timestamp(), nm_usuario_p, 
        ds_mensagem_p, ds_assunto_p, 'N', linha_w.valor_w, nr_exame_p);
   end if;
  end;
 end loop;
 commit;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE enviar_msg_colaboracao (cd_destinatarios_p text, nm_usuario_p text, ds_mensagem_p text, ds_assunto_p text, nr_exame_p text, cd_remetente_p text) FROM PUBLIC;

