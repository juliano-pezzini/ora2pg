-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_desfazer_fechar_conta_aud (nr_seq_analise_p pls_analise_conta.nr_sequencia%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nm_usuario_p usuario.nm_usuario%type) AS $body$
DECLARE


ie_origem_analise_w	pls_analise_conta.ie_origem_analise%type;
ie_status_w		ptu_fatura.ie_status%type;
nr_seq_fatura_w		ptu_fatura.nr_sequencia%type;
nr_seq_protocolo_w	pls_protocolo_conta.nr_sequencia%type;
cont_w			integer;
qt_coparticipacao_mens_w integer;
qt_lote_fat_w		integer;
nr_seq_lote_recalculo_w	pls_lote_recalculo.nr_sequencia%type;
aux_w			integer;
nr_lote_contabil_w	pls_protocolo_conta.nr_lote_contabil%type;
nr_lote_contabil_prov_w	pls_protocolo_conta.nr_lote_contabil_prov%type;
nr_lote_contab_pag_w	pls_protocolo_conta.nr_lote_contab_pag%type;
nr_lote_prov_copartic_w	pls_protocolo_conta.nr_lote_prov_copartic%type;
nr_seq_lote_pgto_w	pls_conta_medica_resumo.nr_seq_lote_pgto%type;
nr_seq_lote_fat_w	pls_conta_pos_estabelecido.nr_seq_lote_fat%type;
qt_grupo_liberado_w	integer;

/*Cursor que obtem as contas da analise para ser realizado o fechamento*/

C01 CURSOR FOR
	SELECT	b.nr_sequencia nr_seq_conta
	from	pls_analise_conta a,
		pls_conta b
	where	a.nr_sequencia		= nr_seq_analise_p
	and	a.ie_status		= 'T'
	and	b.nr_seq_analise	= a.nr_sequencia;
BEGIN

select	coalesce(max(ie_origem_analise),1)
into STRICT 	ie_origem_analise_w
from 	pls_analise_conta
where 	nr_sequencia = nr_seq_analise_p;

if (ie_origem_analise_w in (1,3))	then
	if (ie_origem_analise_w = 3) then

		select	  max(g.ie_status),
			  max(g.nr_sequencia)
		into STRICT	  ie_status_w,
			  nr_seq_fatura_w
                from      pls_conta f,
                          ptu_fatura g
                where     f.nr_seq_analise  = nr_seq_analise_p
                and       f.nr_seq_fatura   = g.nr_sequencia;

		if (ie_status_w = 'CA') then

			--(-20011,'A fatura da analise '||nr_seq_analise_p||' esta cancelada. Nao e possivel desfazer o fechamento das contas.'||'#@#@');
			CALL wheb_mensagem_pck.exibir_mensagem_abort(183602,  'NR_SEQ_ANALISE='||nr_seq_analise_p);	
			
		elsif (ie_status_w = 'E') then

			--(-20011,'A fatura da analise '||nr_seq_analise_p||' esta encerrada. Nao e possivel desfazer o fechamento das contas.'||'#@#@');	
			CALL wheb_mensagem_pck.exibir_mensagem_abort(183603, 'NR_SEQ_ANALISE='||nr_seq_analise_p);
		end if;
	end if;
	
	for r_c01_w in C01 loop
		
		select	count(1)
		into STRICT	aux_w
		from	sip_nv_dados a
		where	a.ie_conta_enviada_ans = 'S'
		and	a.nr_seq_conta = r_c01_w.nr_seq_conta
		and	exists (	SELECT	1
				from	pls_lote_sip b
				where	b.nr_sequencia = a.nr_seq_lote_sip
				and	(b.dt_envio IS NOT NULL AND b.dt_envio::text <> ''));

		if (aux_w > 0) then

			CALL wheb_mensagem_pck.exibir_mensagem_abort(337915);
		end if;

		select	max(nr_seq_protocolo)
		into STRICT	nr_seq_protocolo_w
		from	pls_conta
		where	nr_sequencia = r_c01_w.nr_seq_conta;

		select	count(1)
		into STRICT	cont_w
		from	pls_prot_conta_titulo a,
			pls_protocolo_conta b,
			pls_conta c
		where	a.nr_seq_protocolo	= b.nr_sequencia
		and	b.nr_sequencia		= c.nr_seq_protocolo
		and	c.nr_sequencia		= r_c01_w.nr_seq_conta;

		select	count(1)
		into STRICT	qt_coparticipacao_mens_w
		from	pls_conta_coparticipacao
		where	nr_seq_conta		= r_c01_w.nr_seq_conta
		and	(nr_seq_mensalidade_seg IS NOT NULL AND nr_seq_mensalidade_seg::text <> '');

		/*Caso tiver pagamento de producao para a conta nao pode desfazer o fechamento*/

		select	max(nr_seq_lote)
		into STRICT	nr_seq_lote_pgto_w
		from (
			SELECT	max(nr_seq_lote_pgto) nr_seq_lote
			from	pls_conta_medica_resumo
			where	nr_seq_conta = r_c01_w.nr_seq_conta
			and	(nr_seq_lote_pgto IS NOT NULL AND nr_seq_lote_pgto::text <> '')
			and	ie_situacao = 'A'
			
union all

			SELECT	max(nr_seq_pp_lote) nr_seq_lote
			from	pls_conta_medica_resumo
			where	nr_seq_conta = r_c01_w.nr_seq_conta
			and	(nr_seq_pp_lote IS NOT NULL AND nr_seq_pp_lote::text <> '')
			and	ie_situacao = 'A'
		) alias5;

		select	max(nr_lote_contabil),
			max(nr_lote_contabil_prov),
			max(nr_lote_contab_pag),
			max(nr_lote_prov_copartic)
		into STRICT	nr_lote_contabil_w,
			nr_lote_contabil_prov_w,
			nr_lote_contab_pag_w,
			nr_lote_prov_copartic_w
		from	pls_protocolo_conta
		where	nr_sequencia	= nr_seq_protocolo_w;
			
		--Aqui nao controlo pelo campo na pls_visible false pois no futuro quando cliente estiver configurado para nova geracao de pos, ele poderia 

		--reabrir analises geradas em modo antigo ja em lote de faturamento, Como e feita verificacao por campo nr_seq_conta, entao posso procurar tanto na 

		--na tabela antiga quanto na nova		
		select	count(1)	
		into STRICT	qt_lote_fat_w
		from	pls_conta_pos_estabelecido a,
			pls_lote_faturamento b
		where	a.nr_seq_lote_fat = b.nr_sequencia
		and	a.nr_seq_conta	= r_c01_w.nr_seq_conta
		and	(a.nr_seq_lote_fat IS NOT NULL AND a.nr_seq_lote_fat::text <> '')
		and	((a.ie_situacao	= 'A') or (coalesce(a.ie_situacao::text, '') = ''))
		and	b.ie_tipo_lote <> 'A';
			
		if (qt_lote_fat_w = 0) then
			select	count(1),
				max(nr_seq_lote_fat)
			into STRICT	qt_lote_fat_w,
				nr_seq_lote_fat_w
			from (
				SELECT	nr_seq_lote_fat
				from	pls_conta_pos_proc
				where	nr_seq_conta	= r_c01_w.nr_seq_conta
				and	(nr_seq_lote_fat IS NOT NULL AND nr_seq_lote_fat::text <> '')
				
union all
	
				SELECT	nr_seq_lote_fat
				from	pls_conta_pos_mat
				where	nr_seq_conta	= r_c01_w.nr_seq_conta
				and	(nr_seq_lote_fat IS NOT NULL AND nr_seq_lote_fat::text <> '')
			) alias5;
		end if;
		
		if (qt_lote_fat_w > 0) then

			CALL wheb_mensagem_pck.exibir_mensagem_abort(190837, 'NR_LOTE=' || nr_seq_lote_fat_w);
		end if;
		
		if (nr_seq_lote_pgto_w IS NOT NULL AND nr_seq_lote_pgto_w::text <> '') then
			
			CALL wheb_mensagem_pck.exibir_mensagem_abort(303581,'NR_SEQ_LOTE=' || nr_seq_lote_pgto_w );
		end if;

		if (qt_coparticipacao_mens_w > 0) then

			CALL wheb_mensagem_pck.exibir_mensagem_abort(190839);
		end if;

		if (cont_w > 0) then

			CALL wheb_mensagem_pck.exibir_mensagem_abort(190841);
		end if;

		/* Lepinski - OSs 389180 e 381715 - Conforme conversa com Adriano, nao permitir desfazer o fechamento da conta, caso a mesma ja esteja em lote de contabilizacao */

		if (coalesce(nr_lote_contabil_w,0) <> 0) then
			CALL wheb_mensagem_pck.exibir_mensagem_abort(190842, 'NR_LOTE_CONTABIL_W=' || nr_lote_contabil_w);
		end if;
		if (coalesce(nr_lote_contab_pag_w,0) <> 0) then
			CALL wheb_mensagem_pck.exibir_mensagem_abort(190845, 'NR_LOTE_CONTABIL_W=' || nr_lote_contab_pag_w);
		end if;
		if (coalesce(nr_lote_prov_copartic_w,0) <> 0) then
			CALL wheb_mensagem_pck.exibir_mensagem_abort(190849, 'NR_LOTE_CONTABIL_W=' || nr_lote_prov_copartic_w);
		end if;

		/* Felipe - 28/07/2011 - OS 338196 - Nao permitir alterar protocolos que estejam em lote de recalculo nao liberado*/

		select	coalesce(max(b.nr_sequencia),0)
		into STRICT	nr_seq_lote_recalculo_w
		from	pls_lote_recalculo	b,
			pls_conta_recalculo	a
		where	a.nr_seq_lote		= b.nr_sequencia
		and	a.nr_seq_protocolo	= nr_seq_protocolo_w
		and	(b.dt_geracao_lote IS NOT NULL AND b.dt_geracao_lote::text <> '')
		and	coalesce(b.dt_aplicacao::text, '') = '';

		if (nr_seq_lote_recalculo_w > 0) then
			CALL wheb_mensagem_pck.exibir_mensagem_abort(190850, 'NR_SEQ_LOTE_RECALCULO_W=' || nr_seq_lote_recalculo_w);
		end if;
	end loop;

	for r_c01_w in C01 loop
		CALL pls_desfazer_fechamento_conta(	r_c01_w.nr_seq_conta, cd_estabelecimento_p, nm_usuario_p,
						'A');
	end loop;

	if (nr_seq_fatura_w IS NOT NULL AND nr_seq_fatura_w::text <> '') then

		CALL ptu_atualizar_status_fatura(	nr_seq_fatura_w, 'A', null,
						nm_usuario_p);
	end if;

--  Tratamento para Pos estabelecido.
elsif (ie_origem_analise_w in (2,7,8)) then

	CALL pls_desfazer_fechar_pos_estab(	nr_seq_analise_p, nm_usuario_p);

-- Tratamento para analise de recurso de glosa
elsif (ie_origem_analise_w = 4) then

	CALL pls_desfazer_fechar_rec_glosa(	nr_seq_analise_p, cd_estabelecimento_p, nm_usuario_p);

--Tratamento para a analise de discussao
elsif (ie_origem_analise_w = 5) then

	select 	count(1)
	into STRICT	qt_grupo_liberado_w
	from 	pls_auditoria_conta_grupo
	where 	nr_seq_analise = nr_seq_analise_p
	and 	(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')  LIMIT 1;

	if (qt_grupo_liberado_w = 0 )then

		ie_status_w := 'G';
	else
		ie_status_w := 'L';
	end if;

	update	pls_analise_conta
	set	ie_status 	= ie_status_w
	where 	nr_sequencia	= nr_seq_analise_p;
end if;

update	pls_analise_conta
set	ie_atende_glosado = 'N'
where	nr_sequencia = nr_seq_analise_p;

-- Se a analise ficou em "Aguardando Analise", deve limpar a data dt_final_analise
update	pls_analise_conta
set	dt_final_analise	 = NULL
where	nr_sequencia		= nr_seq_analise_p
and	ie_status		= 'G';

CALL pls_inserir_hist_analise(	null, nr_seq_analise_p, 29,
				null, 'A', null,
				null, 'Desfeito o fechamento das contas da analise.', null,	
				nm_usuario_p, cd_estabelecimento_p);

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_desfazer_fechar_conta_aud (nr_seq_analise_p pls_analise_conta.nr_sequencia%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nm_usuario_p usuario.nm_usuario%type) FROM PUBLIC;

