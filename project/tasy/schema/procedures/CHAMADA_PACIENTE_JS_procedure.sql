-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE chamada_paciente_js ( ie_opcao_p text, ie_clinica_p text, ie_regra_estab_p text, cd_setores_p text, nm_usuario_p text, cd_lista_grupo_p text default '', nr_atendimento_p INOUT bigint DEFAULT NULL, cd_pessoa_fisica_p INOUT text DEFAULT NULL, nm_pessoa_fisica_p INOUT text DEFAULT NULL, nm_medico_p INOUT text DEFAULT NULL, ds_breve_local_p INOUT text DEFAULT NULL) AS $body$
DECLARE


dt_entrada_w		timestamp;
nr_atendimento_w	bigint;
dt_chamada_pac_w	timestamp;
cd_estabelecimento_w	smallint;
nm_pessoa_fisica_w	varchar(255);
nm_medico_w		varchar(60);
ds_local_w		varchar(255);
cd_pessoa_fisica_w	varchar(255);

c01 CURSOR FOR
SELECT /*+ index (a atepaci_7) */       a.dt_entrada,
       a.nr_atendimento,
       a.dt_chamada_paciente,
       a.cd_estabelecimento,
       substr(obter_nome_pf(p.cd_pessoa_fisica),1,255),
       substr(obter_nome_medico(a.cd_medico_resp,'N'),1,60) nm_medico,
       substr((obter_desc_abrev_local_pa(nr_seq_local_pa)||obter_texto_reav_painel_cham(a.nr_atendimento)),1,200) ds_breve_local,
       a.cd_pessoa_fisica
from   pessoa_fisica p,
       atendimento_paciente a
where  a.cd_pessoa_fisica      = p.cd_pessoa_fisica
and    a.dt_entrada            >= clock_timestamp() - interval '30 days'
and    (((a.dt_chamada_paciente IS NOT NULL AND a.dt_chamada_paciente::text <> '') and coalesce(a.dt_atend_medico::text, '') = '') or ((a.dt_chamada_enfermagem IS NOT NULL AND a.dt_chamada_enfermagem::text <> '') and coalesce(a.dt_inicio_atendimento::text, '') = '') or ((a.dt_chamada_reavaliacao IS NOT NULL AND a.dt_chamada_reavaliacao::text <> '') and coalesce(a.dt_inicio_reavaliacao::text, '') = ''))
and    coalesce(a.ie_chamado::text, '') = ''
and (ie_clinica_p = '0' or a.ie_clinica in (ie_clinica_p))
and (ie_regra_estab_p = '1' or a.cd_estabelecimento in (	select 	x.cd_estabelecimento
									                        from 	usuario_estabelecimento_v x
									                        where 	x.nm_usuario = nm_usuario_p))
and (coalesce(cd_setores_p::text, '') = '' or cd_setores_p = '' or obter_se_contido_char(obter_setor_atendimento(a.nr_atendimento),cd_setores_p) = 'S')
and (coalesce(cd_lista_grupo_p::text, '') = '' or cd_lista_grupo_p = '' or obter_se_contido(nr_seq_local_pa,cd_lista_grupo_p) = 'S')
order by a.dt_entrada;


BEGIN

open C01;
loop
fetch C01 into
	dt_entrada_w,
	nr_atendimento_w,
	dt_chamada_pac_w,
	cd_estabelecimento_w,
	nm_pessoa_fisica_w,
	nm_medico_w,
	ds_local_w,
	cd_pessoa_fisica_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin

	nr_atendimento_p   := nr_atendimento_w;
	cd_pessoa_fisica_p := cd_pessoa_fisica_w;
	nm_pessoa_fisica_p := nm_pessoa_fisica_w;
	nm_medico_p	   := nm_medico_w;
	ds_breve_local_p   := ds_local_w;

	end;
end loop;
close C01;

if (nr_atendimento_w > 0) then
	update  atendimento_paciente
	set		ie_chamado = 'S'
	where 	nr_atendimento = nr_atendimento_w;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE chamada_paciente_js ( ie_opcao_p text, ie_clinica_p text, ie_regra_estab_p text, cd_setores_p text, nm_usuario_p text, cd_lista_grupo_p text default '', nr_atendimento_p INOUT bigint DEFAULT NULL, cd_pessoa_fisica_p INOUT text DEFAULT NULL, nm_pessoa_fisica_p INOUT text DEFAULT NULL, nm_medico_p INOUT text DEFAULT NULL, ds_breve_local_p INOUT text DEFAULT NULL) FROM PUBLIC;

