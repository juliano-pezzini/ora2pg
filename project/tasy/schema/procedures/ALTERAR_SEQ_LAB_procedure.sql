-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE alterar_seq_lab ( nr_prescricao_p bigint, nm_usuario_p text, nr_seq_material_p bigint, nr_seq_prescr_p bigint) AS $body$
DECLARE


cd_material_exame_w	varchar(20);
ie_gerar_sequencia_w	varchar(1);
cd_pessoa_fisica_w	varchar(10);
nr_seq_grupo_imp_w	bigint;
ie_regra_w		varchar(5);
ie_regra_ww		varchar(5);
nr_seq_grupo_w		bigint;

nr_prescricao_w		bigint := 0;
dt_prescricao_w		timestamp;
nr_seq_lab_w		bigint;
nr_sequencia_w		bigint;
nr_seq_imp_w		bigint;
dt_prev_execucao_w	timestamp;

dt_prev_exec_exame_w		timestamp;
dt_prescr_exame_w 		timestamp;
nr_seq_grupo_imp_exame_w	bigint;
ie_regra_seq_exame_w		varchar(5);
ie_regra_seq_exame_ww		varchar(5);
ie_gerado_w			varchar(1);

nr_prescricao_pos_w	bigint;
nr_sequencia_pos_w	integer;
nr_seq_max_mat_w	bigint;
nr_seq_prescr_alt_w	integer;
nr_seq_prescr_ant_w	integer;
nr_prescricao_ant_w	bigint;
nr_seq_origem_w		integer;
nr_Seq_prescr_hor_w	integer;

C01 CURSOR FOR
SELECT 	nr_prescricao,
	nr_sequencia
from 	exame_laboratorio a,
	prescr_procedimento b	
where	a.nr_seq_exame = b.nr_seq_exame
and	cd_material_exame = cd_material_exame_w
and	a.nr_seq_grupo_imp = nr_seq_grupo_imp_exame_w
and	b.nr_prescricao = nr_prescricao_p
and (	((coalesce(nr_seq_origem::text, '') = '') and (nr_seq_origem_w = 0)) or
	(nr_seq_origem	= nr_seq_origem_w AND nr_Sequencia = nr_Seq_prescr_hor_w))
and 	not exists (SELECT 1 from prescr_proc_mat_alteracao e
			 where 	e.nr_prescricao = b.nr_prescricao
			 and 	e.nr_seq_prescr = b.nr_sequencia);

C02 CURSOR FOR
SELECT 	nr_prescricao,
	nr_sequencia
from 	exame_laboratorio a,
	prescr_procedimento b	
where	a.nr_seq_exame = b.nr_seq_exame
and	b.nr_prescricao = nr_prescricao_p
and 	coalesce(nr_seq_origem,0)	= nr_seq_origem_w
and (	((coalesce(nr_seq_origem::text, '') = '') and (nr_seq_origem_w = 0)) or
	(nr_seq_origem	= nr_seq_origem_w AND nr_Sequencia = nr_Seq_prescr_hor_w))
and	exists (SELECT 1 from prescr_proc_mat_alteracao e
			 where 	e.nr_prescricao = b.nr_prescricao
			 and 	e.nr_seq_prescr = b.nr_sequencia);




BEGIN

select  cd_material_exame
into STRICT	cd_material_exame_w
from	material_exame_lab
where	nr_sequencia = nr_seq_material_p;

select	coalesce(max(ie_gerar_sequencia),'N')
into STRICT	ie_gerar_sequencia_w
from	lab_parametro;

select	max(b.nr_seq_grupo_imp),
	max(d.dt_prescricao),
	max(c.ie_regra_sequencia),
	max(ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(coalesce(a.dt_prev_execucao,clock_timestamp()))),
	coalesce(max(nr_seq_origem),0),
	max(CASE WHEN coalesce(nr_seq_origem::text, '') = '' THEN null  ELSE a.nr_sequencia END )
into STRICT	nr_seq_grupo_imp_exame_w,
	dt_prescr_exame_w,
	ie_regra_seq_exame_w,
	dt_prev_exec_exame_w,
	nr_seq_origem_w,
	nr_Seq_prescr_hor_w
from 	prescr_procedimento a,
	exame_laboratorio b,
	lab_grupo_impressao c,
	prescr_medica d
where	a.nr_seq_exame 	= b.nr_seq_exame
and	c.nr_sequencia	= b.nr_seq_grupo_imp
and	d.nr_prescricao	= a.nr_prescricao
and 	a.nr_prescricao = nr_prescricao_p
and	a.nr_sequencia 	= nr_seq_prescr_p;

ie_regra_seq_exame_ww := substr(ie_regra_seq_exame_w,1,1);

lock table lab_seq_grupo_imp in exclusive mode;
select	coalesce(max(nr_valor_seq),0) + 1,
	max(nr_sequencia)
into STRICT	nr_seq_lab_w,
	nr_sequencia_w
from lab_seq_grupo_imp
where nr_sequencia = 	(SELECT max(nr_sequencia)
			from lab_seq_grupo_imp
 			where nr_seq_grupo_imp = nr_seq_grupo_imp_exame_w
			and (((ie_regra_seq_exame_ww = 'D') and
			 ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_sequencia) = ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_prescr_exame_w)) or
			((ie_regra_seq_exame_ww = 'S') and
			 trunc(dt_sequencia,'day') = trunc(dt_prescr_exame_w,'day')) or
			((ie_regra_seq_exame_ww = 'M') and
			 ESTABLISHMENT_TIMEZONE_UTILS.startOfMonth(dt_sequencia) = ESTABLISHMENT_TIMEZONE_UTILS.startOfMonth(dt_prescr_exame_w)) or
			((ie_regra_seq_exame_w = 'A') and
			 ESTABLISHMENT_TIMEZONE_UTILS.startOfYear(dt_sequencia) = ESTABLISHMENT_TIMEZONE_UTILS.startOfYear(dt_prescr_exame_w)) or (ie_regra_seq_exame_ww = 'G')));

update	lab_seq_grupo_imp
set	nr_valor_seq = nr_seq_lab_w
where nr_sequencia = nr_sequencia_w;



if (substr(ie_regra_seq_exame_w,2,1)= 'M') then

	OPEN C01;
	LOOP
	FETCH C01 into
		nr_prescricao_pos_w,
		nr_sequencia_pos_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
		begin

		update	prescr_procedimento b
		set	nr_seq_lab = nr_seq_lab_w
		where 	nr_prescricao = nr_prescricao_pos_w
		and	nr_sequencia = nr_sequencia_pos_w;	

		end;
	END LOOP;
	CLOSE C01;


	OPEN C02;
	LOOP
	FETCH C02 into
		nr_prescricao_ant_w,
		nr_seq_prescr_ant_w;
	EXIT WHEN NOT FOUND; /* apply on c02 */
		begin

		select  max(f.nr_sequencia)
		into STRICT	nr_seq_max_mat_w
		from 	prescr_proc_mat_alteracao f
		where	f.nr_seq_prescr = nr_seq_prescr_ant_w
		and	f.nr_prescricao =  nr_prescricao_ant_w;

		if (nr_seq_max_mat_w > 0) then



			select 	coalesce(max(e.nr_seq_prescr),0)
			 into STRICT	nr_seq_prescr_alt_w
			 from 	prescr_proc_mat_alteracao e
			where 	e.nr_seq_prescr  =  nr_seq_prescr_ant_w
			  and 	e.nr_prescricao	 =  nr_prescricao_ant_w
			  and 	e.nr_seq_mat_atual = nr_seq_material_p
			  and 	e.nr_sequencia	 =  nr_seq_max_mat_w;

			if (nr_seq_prescr_alt_w > 0) then

				update	prescr_procedimento
				set	nr_seq_lab = nr_seq_lab_w
				where	nr_sequencia = nr_seq_prescr_alt_w
				and	nr_prescricao = nr_prescricao_ant_w;

			end if;
		end if;

		end;
	END LOOP;
	CLOSE C02;

elsif (substr(ie_regra_seq_exame_w,2,1)= 'P') then

	update	prescr_procedimento b
	set	nr_seq_lab = nr_seq_lab_w
	where 	cd_material_exame = cd_material_exame_w
	and	nr_prescricao = nr_prescricao_p
	and 	nr_sequencia = nr_seq_prescr_p
	  and	Obter_Grupo_imp_Exame_lab(b.nr_seq_exame) = nr_seq_grupo_imp_exame_w
	  and 	ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(coalesce(b.dt_prev_execucao,clock_timestamp())) 	= dt_prev_exec_exame_w
	  and 	not exists (SELECT 1 from prescr_proc_mat_alteracao e
			 where 	e.nr_prescricao = b.nr_prescricao
			 and 	e.nr_seq_prescr = b.nr_sequencia);


	update	prescr_procedimento b
	set	b.nr_seq_lab = nr_seq_lab_w
	where	b.nr_sequencia in (SELECT e.nr_seq_prescr
				  from prescr_proc_mat_alteracao e
				  where b.nr_sequencia = e.nr_seq_prescr
				    and b.nr_prescricao = e.nr_prescricao	
				    and e.nr_seq_mat_atual = nr_seq_material_p
				    and e.nr_sequencia = (select max(f.nr_sequencia)
							from 	prescr_proc_mat_alteracao f
							where	f.nr_seq_prescr = e.nr_seq_prescr
							and	f.nr_prescricao = e.nr_prescricao ))
	and	nr_prescricao = nr_prescricao_p
	  and	Obter_Grupo_imp_Exame_lab(b.nr_seq_exame) = nr_seq_grupo_imp_exame_w
	  and 	ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(coalesce(b.dt_prev_execucao,clock_timestamp())) 	= dt_prev_exec_exame_w;

end if;


END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE alterar_seq_lab ( nr_prescricao_p bigint, nm_usuario_p text, nr_seq_material_p bigint, nr_seq_prescr_p bigint) FROM PUBLIC;

