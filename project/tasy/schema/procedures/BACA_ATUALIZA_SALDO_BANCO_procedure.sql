-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE baca_atualiza_saldo_banco (nr_seq_conta_p bigint, dt_referencia_p timestamp) AS $body$
DECLARE


vl_atualizacao_w		double precision;
vl_saldo_inicial_w		double precision;
vl_transacao_w			double precision;
NR_SEQ_SALDO_BANCO_W		bigint;
dt_referencia_w			timestamp;
ie_banco_w			varchar(1);

c02 CURSOR FOR
SELECT	nr_sequencia,
	dt_referencia
from	banco_saldo
where	nr_seq_conta			= nr_seq_conta_p
and	trunc(dt_referencia, 'dd')	>= trunc(dt_referencia_p, 'dd')
order	by dt_referencia;

c01 CURSOR FOR
SELECT	a.vl_transacao,
	b.ie_banco
from 	transacao_financeira b,
	movto_trans_financ a
where	b.nr_sequencia 		= a.nr_seq_trans_financ
and	a.nr_seq_saldo_banco	= nr_seq_saldo_banco_w;


BEGIN

open c02;
loop
fetch c02 into
	nr_seq_saldo_banco_w,
	dt_referencia_w;
EXIT WHEN NOT FOUND; /* apply on c02 */
	begin
	select	a.vl_saldo
	into STRICT	vl_saldo_inicial_w
	from	banco_saldo a
	where	a.nr_seq_conta = nr_seq_conta_p
	and	a.dt_referencia = (
		SELECT	max(b.dt_referencia)
		from	banco_saldo b
		where	b.nr_seq_conta	= nr_seq_conta_p
		and	b.dt_referencia	< dt_referencia_w);
	exception
		when no_data_found then -- Francisco - Caso nÃ£o possua saldo anterior
			vl_saldo_inicial_w	:= 0;
	end;

	update	banco_saldo
	set	vl_saldo	= vl_saldo_inicial_w
	where	nr_sequencia	= nr_seq_saldo_banco_w;


	vl_atualizacao_w := 0;

	open c01;
	loop
	fetch c01 into
		vl_transacao_w,
		ie_banco_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */

		if (ie_banco_w = 'C') then
			vl_atualizacao_w := vl_atualizacao_w - vl_transacao_w;
		elsif (ie_banco_w = 'D') then
			vl_atualizacao_w := vl_atualizacao_w + vl_transacao_w;
		elsif (ie_banco_w = 'T') then
			vl_atualizacao_w := vl_atualizacao_w - 0;
		end if;

	end loop;
	close c01;

	update	banco_saldo
	set	vl_saldo	= vl_saldo + vl_atualizacao_w
	where	nr_sequencia	= nr_seq_saldo_banco_w;

end loop;
close c02;


end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE baca_atualiza_saldo_banco (nr_seq_conta_p bigint, dt_referencia_p timestamp) FROM PUBLIC;

