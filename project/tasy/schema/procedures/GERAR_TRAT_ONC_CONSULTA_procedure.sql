-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_trat_onc_consulta ( cd_pessoa_fisica_p text, nm_usuario_p text) AS $body$
DECLARE


nr_seq_paciente_w		bigint;
nr_seq_atendimento_w		bigint;
cd_protocolo_w			bigint;
ds_protocolo_w			varchar(255);
nr_seq_medicacao_w		integer;
ds_subtipo_w			varchar(255);
nr_ciclo_w			smallint;
ds_dia_ciclo_w			varchar(5);
dt_real_w			timestamp;
nr_agrupamento_w		integer;
cd_material_w			integer;
ds_material_w			varchar(255);
qt_dose_prescr_w		double precision;
cd_unid_med_prescr_w		varchar(30);
ie_via_aplicacao_w		varchar(5);
nr_sequencia_w			bigint;
ds_informacao_w			varchar(255);
ie_status_agenda_w		varchar(10);
ie_status_paciente_w		varchar(10);
ie_prescr_suspendida_w		varchar(10);
ie_prescr_liberada_w		varchar(10);
ie_exige_liberacao_w		varchar(10);
ie_ciclo_autorizado_w		varchar(10);
pr_reducao_w			double precision;
nr_prescricao_w			bigint;
dt_real_2_w			timestamp;
ds_administracao_w		varchar(60);

C01 CURSOR FOR
	SELECT	cd_protocolo,
		substr(obter_desc_protocolo(cd_protocolo),1,255),
		nr_seq_medicacao,
		substr(obter_desc_protocolo_medic(nr_seq_medicacao,cd_protocolo),1,255),
		nr_seq_paciente
	from	paciente_setor a
	where	a.cd_pessoa_fisica = cd_pessoa_fisica_p
	and	(cd_protocolo IS NOT NULL AND cd_protocolo::text <> '')
	and	exists (SELECT	1
			from	paciente_atendimento x
			where	x.nr_seq_paciente = a.nr_seq_paciente
			and	coalesce(x.dt_cancelamento::text, '') = ''
			and	coalesce(x.dt_suspensao::text, '') = '')
	order by nr_seq_paciente desc;

C02 CURSOR FOR
	SELECT	nr_ciclo,
		ds_dia_ciclo,
		coalesce(dt_real,dt_prevista) dt_dia,
		nr_seq_atendimento,
		substr(Qt_Obter_Status_Agenda(nr_seq_atendimento),1,50),
		substr(Obter_status_Paciente_qt(NR_SEQ_ATENDIMENTO,dt_inicio_adm,dt_fim_adm,nr_seq_local,ie_exige_liberacao,dt_chegada,'C'),1,60),
		substr(Obter_prescricao_suspenca(nr_prescricao),1,2),
		substr(obter_se_prescricao_liberada(nr_prescricao,'E'),1,2),
		ie_exige_liberacao,
		substr(Obter_Se_Dia_Ciclo_Autorizado(nr_seq_atendimento,nr_ciclo),1,255),
		pr_reducao,
		nr_prescricao,
		dt_real
	from	paciente_atendimento
	where	nr_seq_paciente = nr_seq_paciente_w
	and	coalesce(dt_cancelamento::text, '') = ''
	and	coalesce(dt_suspensao::text, '') = ''
	order by nr_ciclo, dt_dia;

C03 CURSOR FOR
	SELECT	nr_agrupamento,
		cd_material,
		substr(obter_desc_material(cd_material),1,60),
		coalesce(qt_dose_prescricao,qt_dose) dose,
		coalesce(cd_unid_med_prescr,cd_unid_med_dose),
		ie_via_aplicacao,
		substr(obter_valor_dominio(1853,ie_administracao),1,255)
	from	paciente_atend_medic
	where	nr_seq_atendimento = nr_seq_atendimento_w
	and	coalesce(dt_cancelamento::text, '') = ''
	and	coalesce(nr_seq_diluicao::text, '') = ''
	and	coalesce(nr_seq_medic_material::text, '') = ''
	and	coalesce(nr_seq_procedimento::text, '') = ''
	order by 1, 3;


BEGIN

delete	from w_consulta_onc
where	dt_atualizacao < clock_timestamp() - interval '12 days'/24;

delete	from w_consulta_onc
where	cd_pessoa_fisica	= cd_pessoa_fisica_p
and	nm_usuario		= nm_usuario_p;

commit;

select	nextval('w_consulta_onc_seq')
into STRICT	nr_sequencia_w
;

open C01;
loop
fetch C01 into
	cd_protocolo_w,
	ds_protocolo_w,
	nr_seq_medicacao_w,
	ds_subtipo_w,
	nr_seq_paciente_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	insert into w_consulta_onc(	
			nr_sequencia,
			cd_pessoa_fisica,
			dt_atualizacao,
			nm_usuario,
			ds_informacao)
	values (		nextval('w_consulta_onc_seq'),
			cd_pessoa_fisica_p,
			clock_timestamp(),
			nm_usuario_p,
			substr(ds_protocolo_w || ' - ' || ds_subtipo_w,1,255));

	open C02;
	loop
	fetch C02 into	
		nr_ciclo_w,
		ds_dia_ciclo_w,
		dt_real_w,
		nr_seq_atendimento_w,
		ie_status_agenda_w,
		ie_status_paciente_w,
		ie_prescr_suspendida_w,
		ie_prescr_liberada_w,
		ie_exige_liberacao_w,
		ie_ciclo_autorizado_w,
		pr_reducao_w,
		nr_prescricao_w,
		dt_real_2_w;
	EXIT WHEN NOT FOUND; /* apply on C02 */
		begin
		ds_informacao_w	:= '    C'||nr_ciclo_w || ' - ' || ds_dia_ciclo_w || ' - ' || dt_real_w;
		
		insert into w_consulta_onc(	
				nr_sequencia,
				cd_pessoa_fisica,
				dt_atualizacao,
				nm_usuario,
				ds_informacao,
				ie_status_agenda,
				ie_status_paciente,
				ie_prescr_suspendida,
				ie_prescr_liberada,
				ie_exige_liberacao,
				ie_ciclo_autorizado,
				pr_reducao,
				nr_prescricao,
				dt_real)
		values (		nextval('w_consulta_onc_seq'),
				cd_pessoa_fisica_p,
				clock_timestamp(),
				nm_usuario_p,
				substr(ds_informacao_w,1,255),
				ie_status_agenda_w,
				ie_status_paciente_w,
				ie_prescr_suspendida_w,
				ie_prescr_liberada_w,
				ie_exige_liberacao_w,
				ie_ciclo_autorizado_w,
				pr_reducao_w,
				nr_prescricao_w,
				dt_real_2_w);
		open C03;
		loop

		fetch C03 into	
			nr_agrupamento_w,
			cd_material_w,
			ds_material_w,
			qt_dose_prescr_w,
			cd_unid_med_prescr_w,
			ie_via_aplicacao_w,
			ds_administracao_w;
		EXIT WHEN NOT FOUND; /* apply on C03 */

			begin
			insert into w_consulta_onc(	
					nr_sequencia,
					cd_pessoa_fisica,
					dt_atualizacao,
					nm_usuario,
					ds_informacao,
					qt_dose_prescricao,
					cd_unid_med_prescr,
					ie_via_aplicacao,
					ds_administracao)
			values (		nextval('w_consulta_onc_seq'),
					cd_pessoa_fisica_p,
					clock_timestamp(),
					nm_usuario_p,
					substr('        '||ds_material_w,1,255),
					qt_dose_prescr_w,
					cd_unid_med_prescr_w,
					ie_via_aplicacao_w,
					ds_administracao_w);
			end;
		end loop;
		
		close C03;
		end;
	end loop;

	close C02;
	end;
end loop;

close C01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_trat_onc_consulta ( cd_pessoa_fisica_p text, nm_usuario_p text) FROM PUBLIC;

