-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE apurar_custo_consumo_consig ( dt_mesano_referencia_p timestamp, cd_estabelecimento_p bigint, nm_usuario_p text) AS $body$
DECLARE


nr_sequencia_w		bigint;
cd_operacao_w		integer;
cd_material_w		integer;
qt_estoque_w		double precision;
vl_consignado_w		double precision;
vl_unitario_w		double precision;
cd_fornecedor_w		varchar(14);
dt_mesano_referencia_w	timestamp;

c01 CURSOR FOR
SELECT	a.nr_sequencia,
	a.cd_operacao_estoque,
	a.cd_material,
	a.cd_fornecedor,
	a.qt_estoque
FROM  	operacao_estoque b,
	Resumo_movto_estoque a
WHERE 	a.dt_mesano_referencia	= dt_mesano_referencia_w
AND   	a.cd_estabelecimento	= cd_estabelecimento_p
AND	(a.cd_fornecedor IS NOT NULL AND a.cd_fornecedor::text <> '')
and	(a.cd_material IS NOT NULL AND a.cd_material::text <> '')
and	a.cd_operacao_estoque	= b.cd_operacao_estoque
and	b.ie_consignado in (4,5,7);


BEGIN
dt_mesano_referencia_w	:=	PKG_DATE_UTILS.START_OF(dt_mesano_referencia_p,'month');

OPEN C01;
LOOP
FETCH C01 into
	nr_sequencia_w,
	cd_operacao_w,
	cd_material_w,
	cd_fornecedor_w,
	qt_estoque_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	vl_unitario_w		:= 0;

	select	dividir(sum(vl_estoque), sum(qt_estoque))
	into STRICT	vl_unitario_w
	from	operacao_estoque b,
		resumo_movto_estoque a
	WHERE 	a.dt_mesano_referencia	= dt_mesano_referencia_w
	AND   	a.cd_estabelecimento	= cd_estabelecimento_p
	AND	a.cd_fornecedor		= cd_fornecedor_w
	and	a.cd_material		 = cd_material_w
	and	a.cd_operacao_estoque	= b.cd_operacao_estoque
	and	b.ie_consignado in (1,2,3);

	if (vl_unitario_w = 0) then
		select	dividir(sum(coalesce(vl_estoque,0)), sum(qt_estoque))
		into STRICT	vl_unitario_w
		from	fornecedor_mat_consignado a
		WHERE 	a.dt_mesano_referencia	= dt_mesano_referencia_w
		AND   	a.cd_estabelecimento	= cd_estabelecimento_p
		AND	a.cd_fornecedor		= cd_fornecedor_w
		and	a.cd_material		= cd_material_w;
	end if;

	vl_consignado_w	:= vl_unitario_w * qt_estoque_w;

	if (vl_consignado_w	<> 0) then
		update Resumo_Movto_Estoque
		set	vl_consignado		= vl_consignado_w
		where	nr_sequencia		= nr_sequencia_w;
	end if;
END LOOP;
close C01;
COMMIT;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE apurar_custo_consumo_consig ( dt_mesano_referencia_p timestamp, cd_estabelecimento_p bigint, nm_usuario_p text) FROM PUBLIC;

