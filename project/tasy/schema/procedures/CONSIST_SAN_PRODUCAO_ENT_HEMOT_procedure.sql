-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE consist_san_producao_ent_hemot ( nr_sangue_p text, nr_seq_producao_p bigint, nr_seq_derivado_p bigint, cd_barras_p text, dt_vencimento_p timestamp default null, cd_estabelecimento_p bigint DEFAULT NULL, nm_usuario_p text DEFAULT NULL, ds_pergunta_p INOUT text DEFAULT NULL, ds_erro_p INOUT text DEFAULT NULL, ds_erro_2_p INOUT text DEFAULT NULL) AS $body$
DECLARE


ie_duplic_sangue_w	varchar(3);
ie_impedir_sangue_duplo_w	varchar(1);
ie_n_sangue_barras_w	varchar(1);
qt_n_sangue_barras_w	bigint;
ds_sql_w			varchar(2000);


BEGIN

/* Hemoterapia - Parametro [24] -  Forma de tratar a duplicidade de hemocomponente */

ie_duplic_sangue_w := obter_param_usuario(450, 24, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_duplic_sangue_w);
if	(ie_duplic_sangue_w = 'SH' AND nr_seq_derivado_p IS NOT NULL AND nr_seq_derivado_p::text <> '') then
	begin
	select	CASE WHEN count(*)=0 THEN  'N'  ELSE 'S' END
	into STRICT	ds_sql_w
	from	san_producao
	where	nr_sangue = nr_sangue_p
	and	nr_sequencia <> nr_seq_producao_p;
	end;
elsif	((ie_duplic_sangue_w = 'SV') and (nr_sangue_p IS NOT NULL AND nr_sangue_p::text <> '') and (dt_vencimento_p IS NOT NULL AND dt_vencimento_p::text <> '')) then
	begin
	        select CASE WHEN count(*)=0 THEN  'N'  ELSE 'S' END
		into STRICT	ds_sql_w
		from	san_producao
		where nr_sequencia <> nr_seq_producao_p
		and nr_sangue = nr_sangue_p
		and dt_vencimento >= clock_timestamp();
	end;
else	
	begin
	select	CASE WHEN count(*)=0 THEN  'N'  ELSE 'S' END
	into STRICT	ds_sql_w
	from	san_producao
	where	nr_sangue = nr_sangue_p
	and	nr_sequencia <> nr_seq_producao_p
	and	nr_seq_derivado = nr_seq_derivado_p;
	end;
end if;

if (substr(ds_sql_w, 1,1) = 'S') then
	begin
	/* Hemoterapia - Parametro [23] -  Impedir o lancamento de sangues com o mesmo numero na pasta entrada de hemocomponentes */

	ie_impedir_sangue_duplo_w := obter_param_usuario(450, 23, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_impedir_sangue_duplo_w);

	if (ie_impedir_sangue_duplo_w = 'S') then
		ds_erro_p		:= obter_texto_tasy(74161, wheb_usuario_pck.get_nr_seq_idioma);
	else
		ds_pergunta_p	:= obter_texto_tasy(74162, wheb_usuario_pck.get_nr_seq_idioma);
	end if;
	end;
end if;

if (coalesce(ds_erro_p::text, '') = '') then
	begin
	if (nr_sangue_p = cd_barras_p) then
		begin
		/* Hemoterapia - Parametro [121] - Ao lancar os hemocomponentes no emprestimo de entrada, permite que o codigo de barras seja o mesmo do sangue */

		ie_n_sangue_barras_w := obter_param_usuario(450, 121, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_n_sangue_barras_w);

		if (ie_n_sangue_barras_w = 'N') then
			ds_erro_p	:= obter_texto_tasy(74164, wheb_usuario_pck.get_nr_seq_idioma);
		end if;
		end;
	else
		begin
		/* Hemoterapia - Parametro [130] - Quantidade de caracteres para consistir o numero do sangue e o codigo de barras */

		qt_n_sangue_barras_w := obter_param_usuario(450, 130, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, qt_n_sangue_barras_w);

		if (coalesce(qt_n_sangue_barras_w, 0) > 0) then
			ds_erro_2_p	:= obter_texto_tasy(74204, wheb_usuario_pck.get_nr_seq_idioma);
		end if;
		end;
	end if;
	end;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE consist_san_producao_ent_hemot ( nr_sangue_p text, nr_seq_producao_p bigint, nr_seq_derivado_p bigint, cd_barras_p text, dt_vencimento_p timestamp default null, cd_estabelecimento_p bigint DEFAULT NULL, nm_usuario_p text DEFAULT NULL, ds_pergunta_p INOUT text DEFAULT NULL, ds_erro_p INOUT text DEFAULT NULL, ds_erro_2_p INOUT text DEFAULT NULL) FROM PUBLIC;

