-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE consiste_nota_integra ( nr_seq_nota_p bigint, nm_usuario_p text, qt_inconsistencia_p INOUT bigint, ie_devolucao_integracao_p text default 'N') AS $body$
DECLARE


/*
	procedure responsible for checking invoice inconsistencies for integration

	nr_seq_nota_p 		invoice number
	qt_inconsistencia_p amount of inconsistencies
*/


/*Consistir_Nota_Fiscal*/

ds_erro_item_w		varchar(400);
ds_erro_nota_w		varchar(400);


BEGIN

begin
   delete from	nota_fiscal_consist
   where	nr_seq_nota = nr_seq_nota_p;

   SELECT * FROM Consistir_Nota_Fiscal(	nr_seq_nota_p, nm_usuario_p, ds_erro_item_w, ds_erro_nota_w, 'N', ie_devolucao_integracao_p) INTO STRICT ds_erro_item_w, ds_erro_nota_w;

   select 	count(*)
   into STRICT 	qt_inconsistencia_p
   from 	nota_fiscal_consist
   where 	nr_seq_nota = nr_seq_nota_p
   and 	ie_forma_consistencia = 'S';

   if ((ds_erro_item_w IS NOT NULL AND ds_erro_item_w::text <> '') or (ds_erro_nota_w IS NOT NULL AND ds_erro_nota_w::text <> '')) then
   		qt_inconsistencia_p := 1;				
   end if;

exception
when others then
   qt_inconsistencia_p := 1;
end;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE consiste_nota_integra ( nr_seq_nota_p bigint, nm_usuario_p text, qt_inconsistencia_p INOUT bigint, ie_devolucao_integracao_p text default 'N') FROM PUBLIC;

