-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE inserir_hdm_contas (Vl_Conta_P bigint Default Null, Cd_Guia_Principal_P text Default Null, Cd_Medico_Executor_P text default null, Cd_Medico_Solicitante_P text default null, Dt_Atendimento_P timestamp Default Null, Dt_Mes_Competencia_P timestamp Default Null, Ie_Carater_Internacao_P text Default Null, Ie_Tipo_Guia_P text Default Null, Nm_Medico_Exec_P text Default Null, Nm_Medico_Solic_P text Default Null, Nm_Prestador_Exec_P text Default Null, Nm_Usuario_P text Default Null, Nr_Crm_Medico_Exec_P text Default Null, Nr_Crm_Medico_Solic_P text Default Null, Seq_Hdm_Benef_Cubo_P bigint DEFAULT NULL, Nr_Seq_Clinica_P bigint Default Null, Nr_Seq_Prestador_Exec_P bigint Default Null, Nr_Seq_Tipo_Atendimento_P bigint Default Null, Cd_Especialidade_P bigint Default Null, Cd_Guia_P text Default Null, Ie_Origem_P text Default Null, Seq_Hdm_Conta_Cubo_p INOUT bigint DEFAULT NULL) AS $body$
DECLARE



Seq_Hdm_Conta_Cubo_W bigint;
Ds_Especialidade_Solic_W varchar(180);
Sql_Errm_W varchar(255);


BEGIN


select coalesce(max(ds_especialidade),'NE') into STRICT Ds_Especialidade_Solic_W from especialidade_medica where cd_especialidade = Cd_Especialidade_P;

Select coalesce(max(nr_sequencia),0) Into STRICT Seq_Hdm_Conta_Cubo_W From Hdm_Conta_Cubo Where  Nr_Seq_Benef_Cubo = Seq_Hdm_Benef_Cubo_P And Cd_Guia = Cd_Guia_P;

if (Seq_Hdm_Conta_Cubo_W = 0) then
	Select nextval('hdm_conta_cubo_seq') Into STRICT Seq_Hdm_Conta_Cubo_W;
	begin
	Insert Into Hdm_Conta_Cubo(Nr_Sequencia,
		Vl_Conta,
		Cd_Guia_Principal,
		Cd_Medico_Executor,
		Cd_Medico_Solicitante,
		Ds_Especialidade_Solic,
		Ds_Tipo_Atendimento,
		Ds_Tipo_Internacao,
		Dt_Atendimento,
		Dt_Atualizacao,
		Dt_Atualizacao_nrec,
		Dt_Mes_Competencia,
		Ie_Carater_Internacao,
		Ie_Tipo_Guia,
		Nm_Medico_Exec,
		Nm_Medico_Solic,
		Nm_Prestador_Exec,
		Nm_Usuario,
		Nm_Usuario_nrec,
		Nr_Crm_Medico_Exec,
		Nr_Crm_Medico_Solic,
		Nr_Seq_Benef_Cubo,
		Nr_Seq_Clinica,
		Nr_Seq_Prestador_Exec,
		Nr_Seq_Tipo_Atendimento,
		Cd_Especialidade,
		Cd_Guia,
		Ie_Origem)
	Values(Seq_Hdm_Conta_Cubo_W,
		Vl_Conta_P,
		Cd_Guia_Principal_P,
		Cd_Medico_Executor_P,
		Cd_Medico_Solicitante_P,
		CASE WHEN Ds_Especialidade_Solic_W='NE' THEN Null  ELSE Ds_Especialidade_Solic_W END ,
		(SELECT Max(Ds_Tipo_Atendimento) From Pls_Tipo_Atendimento Where Cd_Tipo_Atendimento = Nr_Seq_Tipo_Atendimento_P),
		(select max(ds_clinica) from PLS_CLINICA where cd_clinica = NR_SEQ_CLINICA_P),
		Dt_Atendimento_P,
		clock_timestamp(),
		clock_timestamp(),
		Dt_Mes_Competencia_P,
		Ie_Carater_Internacao_P,
		Ie_Tipo_Guia_P,
		Nm_Medico_Exec_P,
		Nm_Medico_Solic_P,
		Nm_Prestador_Exec_P,
		Nm_Usuario_P,
		Nm_Usuario_P,
		Nr_Crm_Medico_Exec_P,
		Nr_Crm_Medico_Solic_P,
		Seq_Hdm_Benef_Cubo_P,
		Nr_Seq_Clinica_P,
		Nr_Seq_Prestador_Exec_P,
		Nr_Seq_Tipo_Atendimento_P,
		Cd_Especialidade_P,
		Cd_Guia_P,
		Ie_Origem_P);

	Exception
	When Others Then
	Sql_Errm_W	:= Sqlerrm;
	Insert Into Hdm_Log_Integracao(Nr_Sequencia,
		Dt_Atualizacao,
		Nm_Usuario,
		Dt_Atualizacao_Nrec,
		Nm_Usuario_Nrec,
		Ie_Tipo_Log,
		Ds_Titulo,
		Ds_Log_Hdm)
	Values (nextval('hdm_log_integracao_seq'),
		clock_timestamp(),
		Nm_Usuario_P,
		clock_timestamp(),
		Nm_Usuario_P,
		'I',
		'Inserir HDM_CONTA_CUBO (Contas)',
		Sql_Errm_W);
	end;
End If;


if (coalesce(Sql_Errm_W::text, '') = '') then
	Seq_Hdm_Conta_Cubo_P := Seq_Hdm_Conta_Cubo_W;
Else
	Seq_Hdm_Conta_Cubo_P := null;
end if;

commit;
End;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE inserir_hdm_contas (Vl_Conta_P bigint Default Null, Cd_Guia_Principal_P text Default Null, Cd_Medico_Executor_P text default null, Cd_Medico_Solicitante_P text default null, Dt_Atendimento_P timestamp Default Null, Dt_Mes_Competencia_P timestamp Default Null, Ie_Carater_Internacao_P text Default Null, Ie_Tipo_Guia_P text Default Null, Nm_Medico_Exec_P text Default Null, Nm_Medico_Solic_P text Default Null, Nm_Prestador_Exec_P text Default Null, Nm_Usuario_P text Default Null, Nr_Crm_Medico_Exec_P text Default Null, Nr_Crm_Medico_Solic_P text Default Null, Seq_Hdm_Benef_Cubo_P bigint DEFAULT NULL, Nr_Seq_Clinica_P bigint Default Null, Nr_Seq_Prestador_Exec_P bigint Default Null, Nr_Seq_Tipo_Atendimento_P bigint Default Null, Cd_Especialidade_P bigint Default Null, Cd_Guia_P text Default Null, Ie_Origem_P text Default Null, Seq_Hdm_Conta_Cubo_p INOUT bigint DEFAULT NULL) FROM PUBLIC;

