-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE consistir_item_requisicao ( cd_material_p bigint, nr_requisicao_p bigint, VarConsisteMaterialCCusto_p text, VarObrigaMaterialpadr_p text, VarConsisteMaterialLocal_p text, VarConsisteEstoqueDisp_p text, VarPermiteEstoqueMax_p text, ie_consiste_consignado_p text, nm_usuario_p text, ie_deleta_consistencia_p text, cd_cgc_fornecedor_p INOUT text, ds_erro INOUT text) AS $body$
DECLARE



ie_req_mat_estoque_w			varchar(1);
ie_material_estoque_w			varchar(1);
ie_situacao_w				varchar(1);
ie_situacao_est_w				varchar(1);
ie_padronizado_w				varchar(1);
ie_consignado_material_w			varchar(1);
ie_consignado_w				numeric(20);
ie_permite_w				varchar(1);
ie_local_valido_baixa_w			varchar(1);
ie_local_valido_destino_w			varchar(1);
cd_operacao_estoque_w			operacao_estoque.cd_operacao_estoque%type;
cd_centro_custo_w				numeric(20);
cd_estabelecimento_w			bigint;
ie_local_valido_w				varchar(1);
cd_local_estoque_destino_w			numeric(20);
Valida_material_w				varchar(1);
cd_local_estoque_w			numeric(20);
ds_erro_w				varchar(20000);
ds_material_w				varchar(255);
ds_ambiente_w       v$session.program%type;
cd_kit_material_w				integer;
ie_tipo_requisicao_w			varchar(3);
cd_material_estoque_w			integer;
ie_requisicao_w				varchar(1);
dt_solicitacao_requisicao_w			timestamp;
cd_pessoa_requisitante_w			varchar(10);
qt_material_requisitada_w			double precision;
qt_regra_w				double precision;
qt_estoque_w				double precision;
qt_estoque_maximo_w			double precision;
ie_consiste_sem_movto_w			varchar(1);
ie_possui_movto_w				varchar(1);
ie_regra_custo_medio_zerado_w	varchar(1);
ie_busca_fornec_consig_w			varchar(255);
cd_material_substituto_w		sup_lista_subs_material.cd_material%type;
ds_material_substituto_w		varchar(255);
ds_consistencia_substituto_w		varchar(255);
ie_geracao_w				requisicao_material.ie_geracao%type;
cd_exp_w                    dic_objeto.cd_exp_texto%type;
ie_possui_consist_w           varchar(255);
ie_requisicao_transferencia_w	varchar(1) := 'N';
ie_requisicao_transf_mexico_w	varchar(1) := 'N';
audsid_w v$session.audsid%type;

c01 CURSOR FOR
SELECT ds_consistencia
from requisicao_mat_consist
where ds_consistencia = WHEB_MENSAGEM_PCK.get_texto(cd_exp_w)
and cd_material = cd_material_p
and nr_requisicao = nr_requisicao_p;


BEGIN
ds_erro := '';

begin
select	distinct
	b.cd_operacao_estoque,
	b.cd_centro_custo,
	b.cd_estabelecimento,
	b.cd_local_estoque_destino,
	b.cd_local_estoque,
	c.ie_consignado,
	ie_tipo_requisicao,
	b.dt_solicitacao_requisicao,
	b.cd_pessoa_requisitante,
	b.ie_geracao
into STRICT	cd_operacao_estoque_w,
	cd_centro_custo_w,
	cd_estabelecimento_w,
	cd_local_estoque_destino_w,
	cd_local_estoque_w,
	ie_consignado_w,
	ie_tipo_requisicao_w,
	dt_solicitacao_requisicao_w,
	cd_pessoa_requisitante_w,
	ie_geracao_w
from	requisicao_material b,
	operacao_estoque C
where	c.cd_operacao_estoque = b.cd_operacao_estoque
and	b.nr_requisicao = nr_requisicao_p;
exception when no_data_found then
	--Nao existe registro no cadastro dos parametros de compras.
	CALL Wheb_mensagem_pck.exibir_mensagem_abort(1038470);
end;

ie_consiste_sem_movto_w		:= obter_valor_param_usuario(919, 75, Obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w);
ie_busca_fornec_consig_w	:= obter_valor_param_usuario(919, 97, Obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w);
ie_regra_custo_medio_zerado_w := obter_valor_param_usuario(919, 127, Obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w);

begin

if (ie_deleta_consistencia_p = 'S') then
	delete from requisicao_mat_consist
	where nr_requisicao = nr_requisicao_p;
end if;

select	coalesce(sum(qt_material_requisitada), 0),
	coalesce(sum(qt_estoque), 0)
into STRICT	qt_material_requisitada_w,
	qt_estoque_w
from	item_requisicao_material
where	nr_requisicao	= nr_requisicao_p
and	cd_material	= cd_material_p;
exception
	when others then
		qt_material_requisitada_w	:= 0;
end;

select	a.ie_situacao,
	coalesce(a.ie_consignado,'X'),
	a.ds_material,
	a.cd_material_estoque
into STRICT	ie_situacao_w,
	ie_consignado_material_w,
	ds_material_w,
	cd_material_estoque_w
from	material a
where	a.cd_material = cd_material_p;

begin
select	b.ie_padronizado,
	b.cd_kit_material,
	coalesce(b.ie_requisicao,'S'),
	coalesce(b.ie_material_estoque,'S')
into STRICT	ie_padronizado_w,
	cd_kit_material_w,
	ie_requisicao_w,
	ie_material_estoque_w
from	material_estab b
where	b.cd_estabelecimento = cd_estabelecimento_w
and	b.cd_material = cd_material_p;
exception
when others then
	if (ie_deleta_consistencia_p = 'N') then
		cd_exp_w := 300028;
		open 	c01;
		loop
		fetch c01 into
		ie_possui_consist_w;
		EXIT WHEN NOT FOUND; /* apply on c01 */
		end loop;
		close c01;
		cd_exp_w := null;
	end if;
    if (coalesce(ie_possui_consist_w::text, '') = '') then
        CALL gravar_consistencia_requisicao(
		nr_requisicao_p, cd_material_p,'1',
		WHEB_MENSAGEM_PCK.get_texto(300028),
		'C', WHEB_MENSAGEM_PCK.get_texto(300029), nm_usuario_p);
    end if;
end;

select	ie_situacao
into STRICT	ie_situacao_est_w
from	material
where	cd_material = cd_material_estoque_w;

if (ie_consiste_sem_movto_w = 'S') and (ie_tipo_requisicao_w in (3,9)) then

	select	obter_se_mat_possui_movto(cd_material_p, cd_estabelecimento_w, 0)
	into STRICT	ie_possui_movto_w
	;

	if (ie_possui_movto_w = 'N') then
		if (ie_deleta_consistencia_p = 'N') then
			cd_exp_w := 300030;
			open 	c01;
			loop
			fetch c01 into
			ie_possui_consist_w;
			EXIT WHEN NOT FOUND; /* apply on c01 */
			end loop;
			close c01;
			cd_exp_w := null;
		end if;
        if (coalesce(ie_possui_consist_w::text, '') = '') then
            CALL gravar_consistencia_requisicao(
            nr_requisicao_p, cd_material_p,'1',
            WHEB_MENSAGEM_PCK.get_texto(300030),
            'C',WHEB_MENSAGEM_PCK.get_texto(300031), nm_usuario_p);
        end if;
    end if;
end if;

if (ie_requisicao_w = 'N') then
	if (ie_deleta_consistencia_p = 'N') then
		cd_exp_w := 300034;
		open 	c01;
		loop
		fetch c01 into
		ie_possui_consist_w;
		EXIT WHEN NOT FOUND; /* apply on c01 */
		end loop;
		close c01;
		cd_exp_w := null;
	end if;
    if (coalesce(ie_possui_consist_w::text, '') = '') then
        ds_erro := substr(WHEB_MENSAGEM_PCK.get_texto(300032, 'CD_MATERIAL=' || cd_material_p || ';DS_MATERIAL=' || ds_material_w),1,255);
        CALL gravar_consistencia_requisicao(
            nr_requisicao_p, cd_material_p,'1',
            WHEB_MENSAGEM_PCK.get_texto(300034),
            'C',WHEB_MENSAGEM_PCK.get_texto(300035), nm_usuario_p);
    end if;
end if;

select	coalesce(max(ie_req_mat_estoque),'S')
into STRICT	ie_req_mat_estoque_w
from	local_estoque
where	cd_local_estoque = cd_local_estoque_w;

if (coalesce(ie_geracao_w,'X') <> 'I') and (ie_req_mat_estoque_w = 'S') and (ie_material_estoque_w = 'N') and (coalesce(cd_kit_material_w::text, '') = '') then
	if (ie_deleta_consistencia_p = 'N') then
		cd_exp_w := 300045;
		open 	c01;
		loop
		fetch c01 into
		ie_possui_consist_w;
		EXIT WHEN NOT FOUND; /* apply on c01 */
		end loop;
		close c01;
		cd_exp_w := null;
	end if;
    if (coalesce(ie_possui_consist_w::text, '') = '') then
        ds_erro := substr(WHEB_MENSAGEM_PCK.get_texto(300042, 'CD_MATERIAL=' || cd_material_p || ';DS_MATERIAL=' || ds_material_w),1,255);
        CALL gravar_consistencia_requisicao(
            nr_requisicao_p, cd_material_p,'1',
            WHEB_MENSAGEM_PCK.get_texto(300045) /*'Este material nao e um material de estoque.'*/
,
            'C',WHEB_MENSAGEM_PCK.get_texto(300049), nm_usuario_p);
    end if;
end if;

if (ie_consignado_material_w = 'X') then
	if (ie_deleta_consistencia_p = 'N') then
		cd_exp_w := 280507;
		open 	c01;
		loop
		fetch c01 into
		ie_possui_consist_w;
		EXIT WHEN NOT FOUND; /* apply on c01 */
		end loop;
		close c01;
		cd_exp_w := null;
	end if;
    if (coalesce(ie_possui_consist_w::text, '') = '') then
        ds_erro := substr(WHEB_MENSAGEM_PCK.get_texto(300050, 'CD_MATERIAL=' || cd_material_p || ';DS_MATERIAL=' || ds_material_w),1,255);
        CALL gravar_consistencia_requisicao(
            nr_requisicao_p, cd_material_p,'1',
            WHEB_MENSAGEM_PCK.get_texto(280507),
            'C',WHEB_MENSAGEM_PCK.get_texto(280508), nm_usuario_p);
    end if;
end if;

if (ie_situacao_w = 'I') then
	if (ie_deleta_consistencia_p = 'N') then
		cd_exp_w := 300077;
		open 	c01;
		loop
		fetch c01 into
		ie_possui_consist_w;
		EXIT WHEN NOT FOUND; /* apply on c01 */
		end loop;
		close c01;
		cd_exp_w := null;
	end if;
    if (coalesce(ie_possui_consist_w::text, '') = '') then
        ds_erro := substr(WHEB_MENSAGEM_PCK.get_texto(300073, 'CD_MATERIAL=' || cd_material_p || ';DS_MATERIAL=' || ds_material_w),1,255);
        CALL gravar_consistencia_requisicao(
            nr_requisicao_p, cd_material_p,'1',
            WHEB_MENSAGEM_PCK.get_texto(300077),
            'C',WHEB_MENSAGEM_PCK.get_texto(300078), nm_usuario_p);
    end if;
end if;

begin
select	cd_material
into STRICT	cd_material_substituto_w
from (
SELECT	a.cd_material
from	sup_lista_subs_material a,
	sup_regra_subs_material b
where	b.cd_material = cd_material_p
and	a.nr_seq_regra = b.nr_sequencia
order by coalesce(ie_ordem,999)) alias1 LIMIT 1;
exception
when others then
	cd_material_substituto_w	:=	null;
end;

if (cd_material_substituto_w IS NOT NULL AND cd_material_substituto_w::text <> '') then
	select	ds_material
	into STRICT	ds_material_substituto_w
	from	material
	where	cd_material = cd_material_substituto_w;
	ds_consistencia_substituto_w := substr(obter_texto_tasy(287854,wheb_usuario_pck.get_nr_seq_idioma) ||
					cd_material_substituto_w || obter_texto_tasy(287859,wheb_usuario_pck.get_nr_seq_idioma) || ds_material_substituto_w, 1, 255);
end if;

if (ie_situacao_est_w = 'I') then
	if (ie_deleta_consistencia_p = 'N') then
		cd_exp_w := 300081;
		open 	c01;
		loop
		fetch c01 into
		ie_possui_consist_w;
		EXIT WHEN NOT FOUND; /* apply on c01 */
		end loop;
		close c01;
	    cd_exp_w := null;
	end if;
    if (coalesce(ie_possui_consist_w::text, '') = '') then
        ds_erro := substr(WHEB_MENSAGEM_PCK.get_texto(300080, 'CD_MATERIAL=' || cd_material_p || ';DS_MATERIAL=' || ds_material_w),1,255);
        CALL gravar_consistencia_requisicao(
            nr_requisicao_p, cd_material_p,'1',
            WHEB_MENSAGEM_PCK.get_texto(300081),
            'C',WHEB_MENSAGEM_PCK.get_texto(300082, 'CD_MATERIAL_ESTOQUE=' || cd_material_estoque_w || ';DS_CONSISTENCIA_SUBSTITUTO=' || ds_consistencia_substituto_w), nm_usuario_p);
    end if;
end if;

if (ie_padronizado_w <> 'S') and (VarObrigaMaterialpadr_p = 'S') then
	if (ie_deleta_consistencia_p = 'N') then	
		cd_exp_w := 300084;
		open 	c01;
		loop
		fetch c01 into
		ie_possui_consist_w;
		EXIT WHEN NOT FOUND; /* apply on c01 */
		end loop;
		close c01;
        cd_exp_w := null;
	end if;
    if (coalesce(ie_possui_consist_w::text, '') = '') then
        ds_erro := substr(WHEB_MENSAGEM_PCK.get_texto(300083, 'CD_MATERIAL=' || cd_material_p || ';DS_MATERIAL=' || ds_material_w),1,255);
        CALL gravar_consistencia_requisicao(
            nr_requisicao_p, cd_material_p,'1',
            WHEB_MENSAGEM_PCK.get_texto(300084),
            'C',WHEB_MENSAGEM_PCK.get_texto(342840), nm_usuario_p);
    end if;
end if;

ie_requisicao_transf_mexico_w := obter_se_transf_local_mexico(
							cd_estabelecimento_p	=> cd_estabelecimento_w,
							cd_operacao_estoque_p	=> cd_operacao_estoque_w);

if (coalesce(ie_consiste_consignado_p,'S') = 'S') and
	((ie_consignado_w <> 0  AND ie_consignado_material_w = '0') or
	(ie_consignado_w = 0 AND ie_consignado_material_w = '1')) or
	(ie_requisicao_transf_mexico_w = 'S' AND ie_consignado_material_w <> '2') then
	if (ie_deleta_consistencia_p = 'N') then
		cd_exp_w := 300085;
		open 	c01;
		loop
		fetch c01 into
		ie_possui_consist_w;
		EXIT WHEN NOT FOUND; /* apply on c01 */
		end loop;
		close c01;
        cd_exp_w := null;
	end if;
    if (coalesce(ie_possui_consist_w::text, '') = '') then
        ds_erro := substr(WHEB_MENSAGEM_PCK.get_texto(300087, 'CD_MATERIAL=' || cd_material_p || ';DS_MATERIAL=' || ds_material_w),1,255);
        CALL gravar_consistencia_requisicao(
            nr_requisicao_p, cd_material_p,'1',
            WHEB_MENSAGEM_PCK.get_texto(300085),
            'C',WHEB_MENSAGEM_PCK.get_texto(300089), nm_usuario_p);
    end if;
end if;

/* Tratamento transferencia entre locais Mexico */

if (ie_tipo_requisicao_w in ('2','21')) or (ie_requisicao_transf_mexico_w = 'S') then
	ie_requisicao_transferencia_w := 'S';
end if;

if (VarPermiteEstoqueMax_p = 'N') and (ie_requisicao_transferencia_w = 'S') and (cd_local_estoque_destino_w > 0) then
	qt_estoque_maximo_w	:= coalesce(obter_regra_padrao_local(cd_material_p, cd_local_estoque_destino_w, cd_estabelecimento_w, 'qt_max'),0);

	if (qt_estoque_maximo_w > 0) and (qt_estoque_w > qt_estoque_maximo_w) then
		if (ie_deleta_consistencia_p = 'N') then
			cd_exp_w := 300091;
			open 	c01;
			loop
			fetch c01 into
			ie_possui_consist_w;
			EXIT WHEN NOT FOUND; /* apply on c01 */
			end loop;
			close c01;
            cd_exp_w := null;
		end if;
        if (coalesce(ie_possui_consist_w::text, '') = '') then
            ds_erro := substr(WHEB_MENSAGEM_PCK.get_texto(300090, 'CD_MATERIAL=' || cd_material_p || ';DS_MATERIAL=' || ds_material_w),1,255);
            CALL gravar_consistencia_requisicao(
                nr_requisicao_p, cd_material_p,'1',
                WHEB_MENSAGEM_PCK.get_texto(300091),
                'C', WHEB_MENSAGEM_PCK.get_texto(300092, 'DS_LOCAL_ESTOQUE=' || obter_desc_local_estoque(cd_local_estoque_destino_w) ||
                                                        ';QT_ESTOQUE=' || qt_estoque_w ||
                                                        ';QT_ESTOQUE_MAXIMO=' || qt_estoque_maximo_w), nm_usuario_p);
        end if;
	end if;
end if;

if (VarConsisteMaterialCCusto_p = 'S') and (cd_centro_custo_w IS NOT NULL AND cd_centro_custo_w::text <> '') then
	begin
	valida_material_w := valida_material_centro_custo(
		cd_material_p, cd_centro_custo_w, valida_material_w, cd_local_estoque_w, cd_operacao_estoque_w);
	if (valida_material_w <> 'S') then
		if (ie_deleta_consistencia_p = 'N') then
			cd_exp_w := 300094;
			open 	c01;
			loop
			fetch c01 into
			ie_possui_consist_w;
			EXIT WHEN NOT FOUND; /* apply on c01 */
			end loop;
			close c01;
            cd_exp_w := null;
		end if;
        if (coalesce(ie_possui_consist_w::text, '') = '') then
            ds_erro := substr(WHEB_MENSAGEM_PCK.get_texto(300093, 'CD_MATERIAL=' || cd_material_p || ';DS_MATERIAL=' || ds_material_w),1,255);
            CALL gravar_consistencia_requisicao(
                nr_requisicao_p, cd_material_p,'1',
                WHEB_MENSAGEM_PCK.get_texto(300094),
                'C',WHEB_MENSAGEM_PCK.get_texto(342850), nm_usuario_p);
        end if;
	end if;

	if (qt_material_requisitada_w > 0) then
		SELECT * FROM valida_material_ccusto_qt(
			cd_material_p, cd_centro_custo_w, valida_material_w, cd_local_estoque_w, cd_operacao_estoque_w, qt_material_requisitada_w, qt_regra_w) INTO STRICT valida_material_w, qt_regra_w;
		if (valida_material_w <> 'S') then
			if (ie_deleta_consistencia_p = 'N') then
				cd_exp_w := 300095;
				open 	c01;
				loop
				fetch c01 into
				ie_possui_consist_w;
				EXIT WHEN NOT FOUND; /* apply on c01 */
				end loop;
				close c01;
		        cd_exp_w := null;
			end if;
            if (coalesce(ie_possui_consist_w::text, '') = '') then
                ds_erro := Substr(WHEB_MENSAGEM_PCK.get_texto(300096, 'CD_MATERIAL=' || cd_material_p || ';DS_MATERIAL=' || ds_material_w),1,255);
                CALL gravar_consistencia_requisicao(
                    nr_requisicao_p, cd_material_p,'1',
                    WHEB_MENSAGEM_PCK.get_texto(300095),
                    'C',WHEB_MENSAGEM_PCK.get_texto(300098), nm_usuario_p);
            end if;
		end if;
	end if;
	end;
end if;

if (VarConsisteMaterialLocal_p = 'S') then
	begin
	ie_local_valido_w := obter_local_valido(cd_estabelecimento_w, cd_local_estoque_w, cd_material_p, 2, ie_local_valido_w);
	if (ie_local_valido_w <> 'S') then
		if (ie_deleta_consistencia_p = 'N') then
			cd_exp_w := 300100;
			open 	c01;
			loop
			fetch c01 into
			ie_possui_consist_w;
			EXIT WHEN NOT FOUND; /* apply on c01 */
			end loop;
			close c01;
            cd_exp_w := null;
		end if;
        if (coalesce(ie_possui_consist_w::text, '') = '') then
            ds_erro := substr(WHEB_MENSAGEM_PCK.get_texto(300099, 'CD_MATERIAL=' || cd_material_p || ';DS_MATERIAL=' || ds_material_w),1,255);
            CALL gravar_consistencia_requisicao(
                nr_requisicao_p, cd_material_p,'1',
                WHEB_MENSAGEM_PCK.get_texto(300100),
                'C',WHEB_MENSAGEM_PCK.get_texto(300101) /*'Verifique na funcao administracao de estoque, pasta padroes, subaba liberacao.'*/, nm_usuario_p);
        end if;


	end if;
	if (cd_local_estoque_destino_w IS NOT NULL AND cd_local_estoque_destino_w::text <> '') then
		ie_local_valido_w := obter_local_valido(
			cd_estabelecimento_w, cd_local_estoque_destino_w, cd_material_p, 2, ie_local_valido_w);
		if (ie_local_valido_w <> 'S') then
			if (ie_deleta_consistencia_p = 'N') then
				cd_exp_w := 300103;
				open 	c01;
				loop
				fetch c01 into
				ie_possui_consist_w;
				EXIT WHEN NOT FOUND; /* apply on c01 */
				end loop;
				close c01;
				cd_exp_w := null;
			end if;
            if (coalesce(ie_possui_consist_w::text, '') = '') then
                ds_erro := substr(WHEB_MENSAGEM_PCK.get_texto(300102, 'CD_MATERIAL=' || cd_material_p || ';DS_MATERIAL=' || ds_material_w),1,255);
                CALL gravar_consistencia_requisicao(
                    nr_requisicao_p, cd_material_p,'1',
                    WHEB_MENSAGEM_PCK.get_texto(300103),
                    'C',WHEB_MENSAGEM_PCK.get_texto(300101) /*'Verifique na funcao administracao de estoque, pasta padroes, subaba liberacao.'*/ , nm_usuario_p);
            end if;
		end if;
	end if;
	end;
end if;

begin
  select userenv('sessionid')
  into STRICT audsid_w LIMIT 1;
  
  select program
  into STRICT ds_ambiente_w
  from v$session
  where audsid = audsid_w  LIMIT 1;
  exception
    when no_data_found then
    ds_ambiente_w := null;
    audsid_w := null;
end;

if (upper(ds_ambiente_w) <> 'TASY.EXE') then
  if (ie_regra_custo_medio_zerado_w = 'S') then
    if (ie_consignado_material_w in ('0', '2') and coalesce(ie_consignado_w, 0) = 0 and obter_custo_medio_material(cd_estabelecimento_w, clock_timestamp(), cd_material_p, null) <= 0) then
      ds_erro := substr(WHEB_MENSAGEM_PCK.get_texto(1203007), 1, 255);
          CALL gravar_consistencia_requisicao(
            nr_requisicao_p, cd_material_p,'1',
              WHEB_MENSAGEM_PCK.get_texto(1203007),
              'C', WHEB_MENSAGEM_PCK.get_texto(1203007), nm_usuario_p);
      elsif (ie_consignado_material_w in ('1', '2') and coalesce(ie_consignado_w, 0) > 0 and obter_custo_medio_consig(cd_estabelecimento_w, null, cd_material_p, null, clock_timestamp()) <= 0) then
      ds_erro := substr(WHEB_MENSAGEM_PCK.get_texto(1203007), 1, 255);
          CALL gravar_consistencia_requisicao(
            nr_requisicao_p, cd_material_p,'1',
              WHEB_MENSAGEM_PCK.get_texto(1203007),
              'C', WHEB_MENSAGEM_PCK.get_texto(1203007), nm_usuario_p);
    end if;
  end if;
end if;

if (ie_busca_fornec_consig_w <> 'L') then
	begin
	cd_local_estoque_w := null;
	end;
end if;

if (ie_consignado_w <> 0) and (ie_consignado_material_w <> '0') then
	select	obter_fornecedor_regra_consig(cd_estabelecimento_w, cd_material_estoque_w, '1',cd_local_estoque_w)
	into STRICT	cd_cgc_fornecedor_p
	;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE consistir_item_requisicao ( cd_material_p bigint, nr_requisicao_p bigint, VarConsisteMaterialCCusto_p text, VarObrigaMaterialpadr_p text, VarConsisteMaterialLocal_p text, VarConsisteEstoqueDisp_p text, VarPermiteEstoqueMax_p text, ie_consiste_consignado_p text, nm_usuario_p text, ie_deleta_consistencia_p text, cd_cgc_fornecedor_p INOUT text, ds_erro INOUT text) FROM PUBLIC;

