-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_recalcular_proposta_online (nr_seq_prop_online_p bigint, nm_usuario_p text) AS $body$
DECLARE



nr_seq_tabela_w			pls_tabela_preco.nr_sequencia%type;
qt_idade_w			integer;
nr_seq_prop_benef_online_w	pls_proposta_benef_online.nr_sequencia%type;
vl_preco_atual_w		double precision 	:= 0;
vl_simulacao_w			double precision	:= 0;
cd_estabelecimento_w		estabelecimento.cd_estabelecimento%type;
tx_desconto_w			pls_proposta_benef_online.tx_desconto%type;
nr_seq_regra_desconto_w		pls_regra_desconto.nr_sequencia%type;
vl_mensal_sem_desc_w		pls_proposta_benef_online.vl_mensal_sem_desc%type;
nr_seq_plano_w			pls_plano.nr_sequencia%type;
vl_minimo_w			double precision;
nr_seq_parentesco_w		grau_parentesco.nr_sequencia%type;
ie_tipo_benef_w			pls_proposta_benef_online.ie_tipo_benef%type;
qt_vidas_prop_benef_w		integer;
ie_preco_vidas_contrato_w	pls_tabela_preco.ie_preco_vidas_contrato%type;
ie_calculo_vidas_w		pls_tabela_preco.ie_calculo_vidas%type;
vl_inscricao_w			pls_proposta_benef_online.vl_inscricao%type;
nr_seq_regra_seg_cart_w		pls_regra_segurado_cart.nr_sequencia%type;
vl_via_carteira_ww		pls_regra_segurado_cart.vl_via_adicional%type;
tx_via_carteira_w		pls_regra_segurado_cart.tx_via_adicional%type;
vl_via_carteira_w		pls_regra_segurado_cart.vl_via_adicional%type;

C01 CURSOR FOR
	SELECT	b.nr_sequencia,
		obter_idade(b.dt_nascimento, clock_timestamp(), 'A') qt_idade,
		a.nr_seq_tabela,
		b.nr_seq_parentesco,
		a.nr_seq_plano,
		b.ie_tipo_benef,
		1 --a.cd_estabelecimento
	from	pls_proposta_online a,
		pls_proposta_benef_online b
	where	b.nr_seq_prop_online	= a.nr_sequencia
	and	a.nr_sequencia		= nr_seq_prop_online_p;

C08 CURSOR FOR
	SELECT	vl_preco_atual,
		vl_minimo
	from	pls_plano_preco
	where	nr_seq_tabela	= nr_seq_tabela_w
	and	qt_idade_w between qt_idade_inicial and qt_idade_final
	and 	((substr(ie_grau_titularidade,1,1) = ie_tipo_benef_w) or (coalesce(ie_grau_titularidade::text, '') = ''))
	and	((ie_preco_vidas_contrato_w = 'S' and
		qt_vidas_prop_benef_w between coalesce(qt_vidas_inicial,qt_vidas_prop_benef_w) and coalesce(qt_vidas_final,qt_vidas_prop_benef_w)) or (ie_preco_vidas_contrato_w = 'N'))
	order by coalesce(ie_grau_titularidade,' ');


BEGIN

open C01;
loop
fetch C01 into
	nr_seq_prop_benef_online_w,
	qt_idade_w,
	nr_seq_tabela_w,
	nr_seq_parentesco_w,
	nr_seq_plano_w,
	ie_tipo_benef_w,
	cd_estabelecimento_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin

	SELECT * FROM pls_obter_regra_desconto(nr_seq_prop_benef_online_w, 5, cd_estabelecimento_w, tx_desconto_w, nr_seq_regra_desconto_w) INTO STRICT tx_desconto_w, nr_seq_regra_desconto_w;
	vl_mensal_sem_desc_w 	:= 0;

	begin
	select	coalesce(ie_preco_vidas_contrato,'N'),
		coalesce(ie_calculo_vidas,'A')
	into STRICT	ie_preco_vidas_contrato_w,
		ie_calculo_vidas_w
	from	pls_tabela_preco
	where	nr_sequencia = nr_seq_tabela_w;
	exception
	when others then
		ie_preco_vidas_contrato_w	:= 'N';
		ie_calculo_vidas_w		:= 'A';
	end;

	if (ie_preco_vidas_contrato_w = 'S') then
		qt_vidas_prop_benef_w := 0;

		if (ie_calculo_vidas_w in ('A','F')) then
			select	count(1)
			into STRICT	qt_vidas_prop_benef_w
			from	pls_proposta_benef_online
			where	nr_seq_prop_online = nr_seq_prop_online_p;
		elsif (ie_calculo_vidas_w = 'T') then
			select	count(1)
			into STRICT	qt_vidas_prop_benef_w
			from	pls_proposta_benef_online
			where	nr_seq_prop_online = nr_seq_prop_online_p
			and	ie_tipo_benef = 'T';
		elsif (ie_calculo_vidas_w = 'D') then
			select	count(1)
			into STRICT	qt_vidas_prop_benef_w
			from	pls_proposta_benef_online
			where	nr_seq_prop_online = nr_seq_prop_online_p
			and	ie_tipo_benef = 'D';
		elsif (ie_calculo_vidas_w = 'TD') then
			select	count(1)
			into STRICT	qt_vidas_prop_benef_w
			from	pls_proposta_benef_online a
			where	a.nr_seq_prop_online = nr_seq_prop_online_p
			and	((ie_tipo_benef = 'T') or ((ie_tipo_benef = 'D') and ((	SELECT	count(1)
											from	grau_parentesco x
											where	x.nr_sequencia = a.nr_seq_parentesco
											and	x.ie_tipo_parentesco = '1') > 0)));
		end if;
	end if;

	open C08;
	loop
	fetch C08 into
		vl_preco_atual_w,
		vl_minimo_w;
	EXIT WHEN NOT FOUND; /* apply on C08 */
	end loop;
	close C08;

	if (coalesce(vl_preco_atual_w,0) > 0) then
		vl_mensal_sem_desc_w 	:= vl_preco_atual_w;
		vl_preco_atual_w	:= vl_preco_atual_w - dividir((vl_preco_atual_w * tx_desconto_w), 100);
	end if;

	update	pls_proposta_benef_online
	set	vl_mensal_sem_desc	= vl_mensal_sem_desc_w
	where	nr_sequencia		= nr_seq_prop_benef_online_w;

	CALL pls_gerar_valor_inscr_simul(0,0,nr_seq_prop_benef_online_w);

	select	max(vl_inscricao)
	into STRICT	vl_inscricao_w
	from	pls_proposta_benef_online
	where	nr_sequencia	= nr_seq_prop_benef_online_w;

	if (coalesce(vl_inscricao_w::text, '') = '') then
		vl_inscricao_w	:= 0;
	end if;

	if (coalesce(vl_preco_atual_w,0) < coalesce(vl_minimo_w,0)) then
		vl_preco_atual_w := coalesce(vl_minimo_w,0);
	end if;

	SELECT * FROM pls_obter_regra_via_adic(null, null, nr_seq_plano_w, 1, 'N', nm_usuario_p, cd_estabelecimento_w, clock_timestamp(), nr_seq_regra_seg_cart_w, vl_via_carteira_ww, tx_via_carteira_w) INTO STRICT nr_seq_regra_seg_cart_w, vl_via_carteira_ww, tx_via_carteira_w;

	if (coalesce(tx_via_carteira_w,0) <> 0) then
		vl_via_carteira_w := dividir((vl_preco_atual_w * tx_via_carteira_w), 100);
	elsif (coalesce(vl_via_carteira_ww,0) <> 0) then
		vl_via_carteira_w := vl_via_carteira_ww;
	end if;

	update	pls_proposta_benef_online
	set	vl_mensalidade		= coalesce(vl_preco_atual_w,0) + vl_inscricao_w + coalesce(vl_via_carteira_w,0),
		nr_seq_regra_desconto	= nr_seq_regra_desconto_w,
		tx_desconto		= tx_desconto_w,
		nm_usuario		= nm_usuario_p,
		dt_atualizacao		= clock_timestamp()
	where	nr_sequencia		= nr_seq_prop_benef_online_w;

	vl_simulacao_w	:= vl_simulacao_w + coalesce(vl_preco_atual_w,0) + vl_inscricao_w + coalesce(vl_via_carteira_w,0);
	end;
end loop;
close C01;

update	pls_proposta_online
set	vl_simulacao		= vl_simulacao_w,
	nm_usuario		= nm_usuario_p,
	dt_atualizacao		= clock_timestamp()
where	nr_sequencia		= nr_seq_prop_online_p;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_recalcular_proposta_online (nr_seq_prop_online_p bigint, nm_usuario_p text) FROM PUBLIC;

