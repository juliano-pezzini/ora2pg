-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_gerar_env_arq_fundacao_txt ( nr_seq_pls_fatura_p pls_fatura.nr_sequencia%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nm_usuario_p usuario.nm_usuario%type) AS $body$
DECLARE


nr_seq_registro_w		w_ptu_envio_arq.nr_seq_apres%type := 0;
ds_conteudo_w			varchar(4000);
nr_documento_w			pls_movto_arq_fundacao_txt.nr_documento%type;
vl_servico_integral_w		varchar(30);

c01 CURSOR(nr_seq_pls_fatura_pc	pls_fatura.nr_sequencia%type) FOR
	SELECT	nr_sequencia,
		dt_atualizacao,
		nm_usuario,
		dt_atualizacao_nrec,
		nm_usuario_nrec,
		nr_seq_pls_fatura,
		cd_unimed,
		nr_contrato,
		cd_usuario,
		cd_dependente,
		nr_fatura,
		dt_mes_fatura,
		dt_ano_fatura,
		vl_total_servico,
		vl_retencao_irrf,
		nr_seq_lote_fat
	from	pls_lote_arq_fundacao_txt
	where	nr_seq_pls_fatura	= nr_seq_pls_fatura_pc;

c02 CURSOR(nr_seq_lote_pc	pls_lote_arq_fundacao_txt.nr_sequencia%type) FOR
	SELECT	nr_seq_conta,
		nr_seq_conta_proc,
		nr_seq_conta_mat,
		nm_usuario,
		nr_sequencia,
		dt_atualizacao,
		dt_atualizacao_nrec,
		nm_usuario_nrec,
		cd_cid,
		nr_cons_profissional_exec,
		cd_operadora_cnpj_cpf,
		sg_cons_profissional_exec,
		uf_cons_profissional_exec,
		cd_tipo_consulta,
		cd_tipo_saida,
		cd_dependente,
		cd_especialidade_prest,
		cd_prestador_executante,
		cd_servico,
		cd_sublocal,
		cd_unimed,
		cd_usuario,
		ds_especialidade_prest,
		ds_prestador_contratado,
		cd_carater_solic,
		ds_indicacao_clinica,
		cd_cnes_exec,
		cd_tipo_atendimento,
		ie_carater_atendimento,
		cd_tipo_internacao,
		cd_regime_internacao,
		qt_diaria_solicitada,
		ie_tipo_acomodacao_aut,
		cd_motivo_saida,
		ie_tipo_faturamento,
		nr_guia_referencia,
		nr_seq_referencia_servico,
		cd_despesa,
		cd_tabela,
		cd_cpf_cnpj_executante,
		dt_atendimento,
		cd_cpf_cnpj_solicitante,
		ie_obito_mulher,
		ie_obito_neonatal_precoce,
		ie_obito_neonatal_tardio,
		nr_nasc_vivos,
		nr_nasc_vivos_termo,
		nr_nasc_mortos,
		nr_nasc_prematuros,
		cid_obito,
		nr_decl_obito,
		ie_tipo_guia,
		cd_senha_aut,
		dt_ano_senha_aut,
		nr_lote,
		cd_guia,
		nr_seq_servico_guia,
		cd_unimed_executora,
		ds_servico,
		ds_tipo_prestador,
		dt_alta,
		dt_emissao,
		dt_internacao,
		hr_entrada_hospital,
		hr_saida_hospital,
		hr_servico_executado,
		ie_ato_cooperativo,
		ie_nivel_hospital,
		ie_tipo_ato,
		ie_tipo_participacao,
		ie_via_acesso,
		nm_prestador_solicitante,
		nm_usuario_benef,
		nr_contrato,
		nr_contrato_interno,
		nr_documento,
		nr_matricula,
		nr_seq_lote,
		qt_servico,
		tx_adm,
		vl_servico,
		vl_servico_ch,
		vl_servico_filme,
		vl_servico_integral,
		ie_int_obst_gestacao,
		ie_int_obst_aborto,
		ie_int_obst_transt_mat,
		ie_int_obst_puerperio,
		ie_int_obst_atend_parto,
		ie_int_obst_compl_neonatal,
		ie_int_obst_baixo_peso,
		ie_int_obst_parto_cesareo,
		ie_int_obst_parto_normal
	from	pls_movto_arq_fundacao_txt
	where	nr_seq_lote	= nr_seq_lote_pc;
BEGIN
delete	FROM w_ptu_envio_arq
where	nm_usuario = nm_usuario_p;

-- RodapÃ©
for r_C01_w in C01( nr_seq_pls_fatura_p ) loop

	-- Conteudo do arquivo
	for r_C02_w in C02( r_C01_w.nr_sequencia ) loop
		nr_seq_registro_w	:= nr_seq_registro_w + 1;

		if (length(r_C02_w.nr_documento) > 11) then
			nr_documento_w := substr(r_C02_w.nr_documento, length(r_C02_w.nr_documento) - 10, 11);
		else
			nr_documento_w := lpad(r_C02_w.nr_documento,11,0);
		end if;

		ds_conteudo_w	:= 	lpad(coalesce(r_C02_w.cd_unimed,' '),3,' ') ||
					lpad(coalesce(r_C02_w.nr_contrato,' '),4,' ') ||
					lpad(coalesce(r_C02_w.cd_usuario,' '),6,' ') ||
					lpad(coalesce(r_C02_w.cd_dependente,' '),2,' ') ||
					rpad(coalesce(r_C02_w.nm_usuario_benef,' '),25,' ') ||
					lpad(coalesce(nr_documento_w,0),11,0) ||
					lpad(coalesce(r_C02_w.dt_emissao,' '),8,' ') ||
					lpad(coalesce(r_C02_w.ds_tipo_prestador,' '),2,' ') ||
					rpad(coalesce(r_C02_w.ds_prestador_contratado,' '),40,' ') ||
					rpad(coalesce(r_C02_w.ds_especialidade_prest,' '),11,' ') ||
					lpad(coalesce(substr(r_C02_w.cd_servico,1,7),' '),7,' ') ||
					rpad(coalesce(r_C02_w.ds_servico,' '),50,' ') ||
					rpad(coalesce(r_C02_w.nm_prestador_solicitante,' '),30,' ') ||
					lpad(coalesce(r_C02_w.qt_servico,'1'),5,'0') ||
					lpad(substr(replace(replace(campo_mascara_virgula(coalesce(replace(r_C02_w.vl_servico_ch,'.',''),'0')),',',''),'.',''),1,6),6,'0') ||
					lpad(substr(replace(replace(campo_mascara_virgula(coalesce(replace(r_C02_w.vl_servico,'.',''),'0')),',',''),'.',''),1,13),13,'0') ||
					lpad(substr(replace(replace(campo_mascara_virgula(coalesce(replace(r_C02_w.vl_servico_filme,'.',''),'0')),',',''),'.',''),1,13),13,'0') ||
					coalesce(r_C02_w.ie_tipo_participacao,'0') ||
					lpad(coalesce(r_C02_w.hr_servico_executado,'0'),4,'0') ||
					lpad(coalesce(r_C02_w.cd_especialidade_prest,' '),3,' ') ||
					lpad(coalesce(r_C02_w.dt_internacao,' '),8,' ') ||
					lpad(coalesce(r_C02_w.dt_alta,' '),8,' ') ||
					coalesce(r_C02_w.ie_tipo_ato,' ') ||
					rpad(coalesce(r_C02_w.cd_cid,' '),6,' ') ||
					coalesce(r_C02_w.ie_ato_cooperativo,' ') ||
					lpad(coalesce(r_C02_w.tx_adm,'0'),6,'0') ||
					coalesce(r_C02_w.ie_via_acesso,' ') ||
					lpad(coalesce(r_C02_w.hr_entrada_hospital,'0'),4,'0') ||
					lpad(coalesce(r_C02_w.hr_saida_hospital,'0'),4,'0') ||
					lpad(coalesce(r_C02_w.cd_prestador_executante,'0'),8,'0') ||
					coalesce(r_C02_w.ie_nivel_hospital,' ') ||
					lpad(coalesce(r_C02_w.nr_contrato_interno,' '),4,' ') ||
					lpad(coalesce(r_C02_w.cd_sublocal,' '),5,' ') ||
					lpad('0',39,'0') ||
					lpad(substr(replace(replace(campo_mascara_virgula(coalesce(replace(r_C02_w.vl_servico_integral,'.',''),'0')),',',''),'.',''),1,13),13,'0') ||
					lpad(coalesce(r_C02_w.nr_matricula,' '),10,' ') ||
					lpad(coalesce(r_C02_w.cd_operadora_cnpj_cpf,' '),14,'0') ||
					lpad(coalesce(r_C02_w.sg_cons_profissional_exec,' '),7,' ') ||
					lpad(coalesce(r_C02_w.nr_cons_profissional_exec,' '),15,' ') ||
					coalesce(r_C02_w.uf_cons_profissional_exec,'  ') ||
					coalesce(r_C02_w.cd_tipo_consulta,' ') ||
					coalesce(r_C02_w.cd_tipo_saida,' ') ||
					coalesce(r_C02_w.cd_carater_solic,' ') ||
					rpad(coalesce(r_C02_w.ds_indicacao_clinica,' '),100,' ') ||
					lpad(coalesce(r_C02_w.cd_cnes_exec,' '),7,' ') ||
					lpad(coalesce(r_C02_w.cd_tipo_atendimento,' '),2,' ') ||
					coalesce(r_C02_w.ie_carater_atendimento,' ') ||
					coalesce(r_C02_w.cd_tipo_internacao,' ') ||
					coalesce(r_C02_w.cd_regime_internacao,' ') ||
					lpad(coalesce(r_C02_w.qt_diaria_solicitada,'0'),3,'0') ||
					lpad(coalesce(r_C02_w.ie_tipo_acomodacao_aut,' '),2,' ') ||
					lpad(coalesce(r_C02_w.cd_motivo_saida,' '),2,' ') ||
					lpad(coalesce(r_C02_w.nr_seq_referencia_servico,' '),2,' ') ||
					coalesce(r_C02_w.ie_tipo_faturamento,' ') ||
					rpad(coalesce(r_C02_w.nr_guia_referencia,' '),20,' ') ||
					coalesce(r_C02_w.cd_despesa,' ') ||
					lpad(coalesce(r_C02_w.cd_tabela,' '),2,' ') ||
					lpad(coalesce(r_C02_w.cd_cpf_cnpj_executante,' '),14,'0') ||
					lpad(coalesce(r_C02_w.dt_atendimento,' '),8,' ') ||
					lpad(coalesce(r_C02_w.cd_cpf_cnpj_solicitante,' '),14,'0') ||
					' ' ||
					coalesce(r_C02_w.ie_obito_mulher,' ') ||
					coalesce(r_C02_w.ie_obito_neonatal_precoce,' ') ||
					coalesce(r_C02_w.ie_obito_neonatal_tardio,' ') ||
					lpad(coalesce(r_C02_w.nr_nasc_vivos,' '),15,' ') ||
					lpad(coalesce(r_C02_w.nr_nasc_vivos_termo,' '),2,' ') ||
					lpad(coalesce(r_C02_w.nr_nasc_mortos,' '),2,' ') ||
					lpad(coalesce(r_C02_w.nr_nasc_prematuros,' '),2,' ') ||
					rpad(coalesce(r_C02_w.cid_obito,' '),5,' ') ||
					lpad(coalesce(r_C02_w.nr_decl_obito,' '),7,' ') ||
					coalesce(r_C02_w.ie_tipo_guia,' ') ||
					lpad(coalesce(r_C02_w.cd_senha_aut,' '),10,' ') ||
					lpad(coalesce(r_C02_w.dt_ano_senha_aut,' '),4,' ') ||
					lpad(coalesce(r_C02_w.nr_lote,' '),8,' ') ||
					lpad(coalesce(r_C02_w.cd_guia,' '),18,' ') ||
					lpad(coalesce(r_C02_w.nr_seq_servico_guia,0),5,0) ||
					lpad(coalesce(r_C02_w.cd_unimed_executora,' '),4,' ') ||
					coalesce(r_C02_w.ie_int_obst_gestacao,' ') ||
					coalesce(r_C02_w.ie_int_obst_aborto,' ') ||
					coalesce(r_C02_w.ie_int_obst_transt_mat,' ') ||
					coalesce(r_C02_w.ie_int_obst_puerperio,' ') ||
					coalesce(r_C02_w.ie_int_obst_atend_parto,' ') ||
					coalesce(r_C02_w.ie_int_obst_compl_neonatal,' ') ||
					coalesce(r_C02_w.ie_int_obst_baixo_peso,' ') ||
					coalesce(r_C02_w.ie_int_obst_parto_cesareo,' ') ||
					coalesce(r_C02_w.ie_int_obst_parto_normal,' ');

		insert into w_ptu_envio_arq(nr_sequencia,
			dt_atualizacao,
			nm_usuario,
			ds_conteudo,
			nr_seq_apres)
		values (nextval('w_ptu_envio_arq_seq'),
			clock_timestamp(),
			nm_usuario_p,
			ds_conteudo_w,
			nr_seq_registro_w);

	end loop;

	nr_seq_registro_w := nr_seq_registro_w + 1;

	ds_conteudo_w	:= 	r_C01_w.cd_unimed ||
				r_C01_w.nr_contrato||
				r_C01_w.cd_usuario ||
				r_C01_w.cd_dependente ||
				rpad(r_C01_w.nr_fatura,11,' ') ||
				r_C01_w.dt_mes_fatura ||
				r_C01_w.dt_ano_fatura ||
				lpad(r_C01_w.vl_total_servico,13,'0') ||
				lpad(r_C01_w.vl_retencao_irrf,13,'0');

	insert into w_ptu_envio_arq(nr_sequencia,
		dt_atualizacao,
		nm_usuario,
		ds_conteudo,
		nr_seq_apres)
	values (nextval('w_ptu_envio_arq_seq'),
		clock_timestamp(),
		nm_usuario_p,
		ds_conteudo_w,
		nr_seq_registro_w);

end loop;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_gerar_env_arq_fundacao_txt ( nr_seq_pls_fatura_p pls_fatura.nr_sequencia%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nm_usuario_p usuario.nm_usuario%type) FROM PUBLIC;

