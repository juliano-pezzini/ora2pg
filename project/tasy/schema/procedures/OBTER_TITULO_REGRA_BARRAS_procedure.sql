-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE obter_titulo_regra_barras (cd_banco_p bigint, nr_documento_p text, cd_cgc_p text, cd_barras_p text, nr_titulo_p INOUT bigint, ie_vinculo_automatico_p text default 'N', nr_seq_escrit_barras_p bigint default null) AS $body$
DECLARE


nr_titulo_w		bigint;
cd_banco_w		smallint;
ie_permite_estab_w  varchar(1);
nm_atributo_w		varchar(15);
ds_nr_titulo_w		varchar(10);
ds_select_w		varchar(1000);
ds_from_w		varchar(1000);
ds_where_w		varchar(1000);
ds_parametros_w		varchar(1000);
dt_vencimento_w		timestamp;
vl_bloqueto_w		double precision;
nr_seq_regra_barras_w	bigint;
cd_estab_ativo_w     bigint;
cd_cnpj_raiz_w		varchar(8);
qt_atributo_w		bigint;
nr_documento_w		varchar(255);
vl_desconto_w		banco_escrit_barras.vl_desconto%type;
vl_acrescimo_w		banco_escrit_barras.vl_acrescimo%type;
vl_total_bloqueto_w	double precision;
ie_campo_w			banco_regra_barras_valor.ie_campo%type;
vl_campo_w			banco_regra_barras_valor.vl_campo%type;
dt_fim_vencimento_w timestamp;

c01 CURSOR FOR
SELECT	a.nr_sequencia,
	(SELECT	count(*)
	from	banco_regra_barras_atrib x
	where	x.nr_seq_regra_barras	= a.nr_sequencia) qt_atributo
from	banco_regra_barras a
where	exists (select	1
	from	banco_regra_barras_atrib x
	where	x.nr_seq_regra_barras	= a.nr_sequencia)
and (coalesce(ie_vinculo_automatico_p,'N') = 'N' or coalesce(a.ie_vincular_titulo,'S') = 'S')
and	trunc(clock_timestamp(),'dd')	between trunc(a.dt_inicio_vigencia,'dd') and trunc(coalesce(a.dt_fim_vigencia,clock_timestamp()),'dd')
and	a.cd_banco	= coalesce(cd_banco_p,cd_banco_w)
order by 2 desc;

c02 CURSOR FOR
SELECT	a.nm_atributo
from	banco_regra_barras_atrib a
where	a.nr_seq_regra_barras	= nr_seq_regra_barras_w;

c03 CURSOR FOR
SELECT	a.ie_campo, '('||rtrim(xmlagg(XMLELEMENT(name e, a.vl_campo||',')).extract('//text()'),',')||')'
from	banco_regra_barras_valor a
where	a.nr_seq_regra_barras	= nr_seq_regra_barras_w
group by a.ie_campo;


BEGIN

cd_estab_ativo_w := obter_estabelecimento_ativo;
ie_permite_estab_w := obter_param_usuario(857, 68, obter_perfil_ativo, wheb_usuario_pck.get_nm_usuario, cd_estab_ativo_w, ie_permite_estab_w);

select	to_date(obter_dados_cod_barras(cd_barras_p,'DT'),'dd/mm/yyyy') dt_vencimento,
	(obter_dados_cod_barras(Elimina_aspas(cd_barras_p),'B'))::numeric  cd_banco,
	(obter_dados_cod_barras(cd_barras_p,'V'))::numeric  vl_bloqueto,
	substr(obter_cnpj_raiz(cd_cgc_p),1,255) cd_cnpj_raiz
into STRICT	dt_vencimento_w,
	cd_banco_w,
	vl_bloqueto_w,
	cd_cnpj_raiz_w
;

dt_fim_vencimento_w := fim_dia(dt_vencimento_w);

if (position(' ' in trim(both nr_documento_p)) = 0) then
	nr_documento_w	:= nr_documento_p;
else
	nr_documento_w	:= substr(trim(both nr_documento_p),1,position(' ' in trim(both nr_documento_p)) - 1);
end if;

if (nr_seq_escrit_barras_p IS NOT NULL AND nr_seq_escrit_barras_p::text <> '') then

	select	max(a.vl_desconto),
		max(a.vl_acrescimo)
	into STRICT	vl_desconto_w,
		vl_acrescimo_w
	from	banco_escrit_barras a
	where	a.nr_sequencia	= nr_seq_escrit_barras_p;

end if;

vl_total_bloqueto_w	:= coalesce(vl_bloqueto_w,0) - coalesce(vl_desconto_w,0) + coalesce(vl_acrescimo_w,0);

open	c01;
loop
fetch	c01 into
	nr_seq_regra_barras_w,
	qt_atributo_w;
exit	when(c01%notfound or coalesce(ds_nr_titulo_w,'0') <> '0');

	ds_select_w	:= 'select max(a.nr_titulo)';
	ds_from_w	:= ' from titulo_pagar a';
	ds_where_w	:= ' where 1 = 1';
	ds_parametros_w	:= null;
	
	if (coalesce(ie_permite_estab_w,'S') = 'N') then		
		ds_where_w	:= ds_where_w || ' and (a.cd_estabelecimento = :cd_estab_ativo_w or a.cd_estab_financeiro = :cd_estab_ativo_w) ';
		ds_parametros_w	:= ds_parametros_w || 'cd_estab_ativo_w=' || cd_estab_ativo_w || ';';
	end if;

	open	c02;
	loop
	fetch	c02 into
		nm_atributo_w;
	EXIT WHEN NOT FOUND; /* apply on c02 */

		if (nm_atributo_w	= 'NFNRNF') then
			ds_from_w	:= ds_from_w || ', nota_fiscal d';
			ds_where_w	:= ds_where_w || ' and a.nr_seq_nota_fiscal = d.nr_sequencia and (d.nr_nota_fiscal = :nr_nota_fiscal or d.nr_nota_fiscal = :nr_nf or d.nr_nota_fiscal = :nr_nota_fc)';
			ds_parametros_w	:= ds_parametros_w ||	'nr_nota_fiscal=' || coalesce(nr_documento_p,'0') || ';' ||
								'nr_nf=' || coalesce(nr_documento_w,'0') || ';' ||
								'nr_nota_fc=' || trim(both coalesce(nr_documento_p,'0')) || ';';
		end if;

		if (nm_atributo_w	= 'NFNRNFPT') then
			ds_from_w	:= ds_from_w || ', nota_fiscal d';
			ds_where_w	:= ds_where_w || ' and a.nr_seq_nota_fiscal = d.nr_sequencia and (d.nr_nota_fiscal = :nr_nf or d.nr_nota_fiscal = :nr_nota_fc or :nr_nota_fiscal like ' || chr(39) || '%' || chr(39) || ' || d.nr_nota_fiscal || ' || chr(39) || '%' || chr(39) || ')';
			ds_parametros_w	:= ds_parametros_w ||	'nr_nf=' || coalesce(nr_documento_w,'0') || ';' ||
								'nr_nota_fc=' || trim(both coalesce(nr_documento_p,'0')) || ';' ||
								'nr_nota_fiscal=' || coalesce(nr_documento_p,'0') || ';';
		end if;

		if (nm_atributo_w	= 'TPCDCG') then
			ds_where_w	:= ds_where_w || ' and somente_numero(a.cd_cgc) = somente_numero(:cd_cgc)';
			ds_parametros_w	:= ds_parametros_w || 'cd_cgc=' || cd_cgc_p || ';';
		end if;

		if (nm_atributo_w	= 'TPDTVA') then
			--ds_where_w	:= ds_where_w || ' and trunc(a.dt_vencimento_atual,' || chr(39) || 'dd' || chr(39) || ') = trunc(to_date(:dt_vencimento,' || chr(39) || 'dd/mm/yyyy' || chr(39) || '),' || chr(39) || 'dd' || chr(39) || ')';
			ds_where_w	:= ds_where_w || ' and a.dt_vencimento_atual between to_date(:dt_vencimento,' || chr(39) || 'dd/mm/yyyy hh24:mi:ss' || chr(39) || ') and to_date(:dt_fim_vencimento,' || chr(39) || 'dd/mm/yyyy hh24:mi:ss' || chr(39) || ')';
			ds_parametros_w	:= ds_parametros_w || 'dt_vencimento=' || to_char(dt_vencimento_w,'dd/mm/yyyy') || ';' ||
								'dt_fim_vencimento=' || to_char(to_date(dt_fim_vencimento_w,'dd/mm/yyyy hh24:mi:ss')) || ';';
		end if;

		if (nm_atributo_w	= 'TPVLST') then
			ds_where_w	:= ds_where_w || ' and a.vl_saldo_titulo = :vl_bloqueto';
			ds_parametros_w	:= ds_parametros_w || 'vl_bloqueto=' || vl_bloqueto_w || ';';
		end if;

		if (nm_atributo_w	= 'PJCDRZ') then
			ds_from_w	:= ds_from_w || ', pessoa_juridica c';
			ds_where_w	:= ds_where_w || ' and a.cd_cgc = c.cd_cgc and c.cd_cnpj_raiz = :cd_cnpj_raiz';
			ds_parametros_w	:= ds_parametros_w || 'cd_cnpj_raiz=' || coalesce(cd_cnpj_raiz_w,'0') || ';';
		end if;

		if (nm_atributo_w	= 'TPVLSTDA') then
			ds_where_w	:= ds_where_w || ' and a.vl_saldo_titulo = :vl_bloqueto';
			ds_parametros_w	:= ds_parametros_w || 'vl_bloqueto=' || vl_total_bloqueto_w || ';';
		end if;

	end	loop;
	close	c02;
	
	if qt_atributo_w > 0 then
		open	c03;
		loop
		fetch	c03 into
			ie_campo_w,
			vl_campo_w;
		EXIT WHEN NOT FOUND; /* apply on c03 */
		
			if (ie_campo_w	= 'ORI') then
				ds_where_w	:= ds_where_w || ' and to_number(a.IE_ORIGEM_TITULO) in '||vl_campo_w;
			end if;
		
			if (ie_campo_w	= 'TIP') then
				ds_where_w	:= ds_where_w || ' and to_number(a.IE_TIPO_TITULO)  in '||vl_campo_w;
			end if;
		
			if (ie_campo_w	= 'CLA') then
				ds_where_w	:= ds_where_w || ' and a.NR_SEQ_CLASSE in '||vl_campo_w;
			end if;
		
		end	loop;
		close	c03;
		
	end if;

	ds_nr_titulo_w := obter_valor_dinamico_bv(ds_select_w || ds_from_w || ds_where_w, ds_parametros_w, ds_nr_titulo_w);

end	loop;
close	c01;

if (coalesce(ds_nr_titulo_w,'0') <> '0') then
	nr_titulo_w	:= (ds_nr_titulo_w)::numeric;
end if;

nr_titulo_p	:= nr_titulo_w;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE obter_titulo_regra_barras (cd_banco_p bigint, nr_documento_p text, cd_cgc_p text, cd_barras_p text, nr_titulo_p INOUT bigint, ie_vinculo_automatico_p text default 'N', nr_seq_escrit_barras_p bigint default null) FROM PUBLIC;

