-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_solic_compra_opme ( nr_lote_producao_p bigint, nr_solic_compra_p INOUT bigint, nm_usuario_p text) AS $body$
DECLARE

 
cd_pessoa_fisica_w		varchar(10);
cd_estabelecimento_w		smallint;
cd_local_estoque_w		smallint;
cd_material_w			bigint;
qt_prevista_w			double precision;	
 
C01 CURSOR FOR 
	SELECT	cd_material, 
		qt_prevista 
	from	lote_producao_comp 
	where	nr_lote_producao = nr_lote_producao_p;

BEGIN
if (nr_lote_producao_p IS NOT NULL AND nr_lote_producao_p::text <> '') then 
	select 	max(cd_estabelecimento), 
		max(cd_local_estoque) 
	into STRICT	cd_estabelecimento_w, 
		cd_local_estoque_w 
	from 	lote_producao 
	where 	nr_lote_producao = nr_lote_producao_p;
 
	select	cd_pessoa_fisica 
	into STRICT	cd_pessoa_fisica_w 
	from	usuario 
	where	nm_usuario = nm_usuario_p;
			 
	if (coalesce(cd_pessoa_fisica_w::text, '') = '') then 
		-- erro ao gerar solicitação de compras. o usuário ' || nm_usuario_p || ' não possui nenhuma pessoa física vinculada. 
		CALL Wheb_mensagem_pck.exibir_mensagem_abort(264495,'NM_USUARIO_P=' || NM_USUARIO_P);
	end if;
 
	select	nextval('solic_compra_seq') 
	into STRICT	nr_solic_compra_p 
	;
 
	insert into solic_compra( 
		nr_solic_compra, 
		cd_estabelecimento, 
		dt_solicitacao_compra, 
		dt_atualizacao, 
		nm_usuario, 
		ie_situacao, 
		cd_pessoa_solicitante, 
		ds_observacao, 
		ie_aviso_chegada, 
		ie_aviso_aprov_oc, 
		ie_urgente, 
		ie_tipo_solicitacao, 
		ie_comodato, 
		ie_semanal, 
		cd_local_estoque, 
		nr_lote_producao, 
		nm_usuario_nrec, 
		dt_atualizacao_nrec) 
	values (	nr_solic_compra_p, 
		cd_estabelecimento_w, 
		clock_timestamp(), 
		clock_timestamp(), 
		nm_usuario_p, 
		'A', 
		cd_pessoa_fisica_w, 
		'', 
		'N', 
		'N', 
		'N', 
		'7', 
		'N', 
		'N', 
		cd_local_estoque_w, 
		nr_lote_producao_p, 
		nm_usuario_p, 
		clock_timestamp());		
	 
	commit;
	 
	open C01;
	loop 
	fetch C01 into	 
		cd_material_w, 
		qt_prevista_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin 
		CALL Gerar_Solic_Compra_Item(nr_solic_compra_p,cd_material_w,'C',qt_prevista_w,clock_timestamp() + interval '7 days',nm_usuario_p,'N',0,'');
		end;
	end loop;
	close C01;
end if;		
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_solic_compra_opme ( nr_lote_producao_p bigint, nr_solic_compra_p INOUT bigint, nm_usuario_p text) FROM PUBLIC;

