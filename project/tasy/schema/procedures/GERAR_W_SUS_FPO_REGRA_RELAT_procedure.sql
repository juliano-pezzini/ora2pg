-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_w_sus_fpo_regra_relat ( dt_competencia_p timestamp, nm_usuario_p text) AS $body$
DECLARE

 
cd_carater_internacao_w 	varchar(2);
cd_cbo_w 			varchar(6);
cd_forma_organizacao_w 		integer;
cd_grupo_w 			smallint;
cd_procedimento_w 		bigint;
cd_subgrupo_w 			smallint;
ds_cbo_w 			varchar(600);
ds_forma_organizacao_w 		varchar(100);
ds_grupo_w 			varchar(100);
ds_procedimento_w 		varchar(255);
ds_subgrupo_w 			varchar(100);
dt_competencia_w 		timestamp;
ie_complexidade_w 		varchar(2);
ie_origem_proced_w 		bigint;
ie_tipo_atendimento_w 		varchar(20);
ie_tipo_financiamento_w 	varchar(4);
nm_usuario_resp_w 		varchar(15);
nr_seq_estrutura_regra_w	bigint;
nr_seq_forma_org_w 		bigint;
nr_seq_fpo_regra_w 		bigint;
nr_seq_grupo_w 			bigint;
nr_seq_subgrupo_w 		bigint;
qt_executado_w 			double precision;
qt_fisico_w 			double precision;
qt_protocolo_w 			double precision;
vl_executado_w 			double precision;
vl_orcamento_w 			double precision;
vl_protocolo_w 			double precision;
qt_saldo_fisico_w		double precision;
vl_saldo_orcamentario_w		double precision;
ds_tipo_w			varchar(2000);

C01 CURSOR FOR 
	SELECT	a.nr_sequencia, 
		a.nr_seq_grupo, 
		b.cd_grupo, 
		b.ds_grupo, 
		a.nr_seq_subgrupo, 
		c.cd_subgrupo, 
		c.ds_subgrupo, 
		a.nr_seq_forma_org, 
		d.cd_forma_organizacao, 
		d.ds_forma_organizacao, 
		a.cd_procedimento, 
		a.ie_origem_proced, 
		substr(obter_descricao_procedimento(a.cd_procedimento,a.ie_origem_proced),1,255) ds_procedimento, 
		a.cd_cbo, 
		substr(sus_obter_desc_cbo(a.cd_cbo),1,255) ds_cbo, 
		a.qt_fisico, 
		a.vl_orcamento, 
		sus_obter_resultado_fpo(a.nr_sequencia,1,'E') qt_executado, 
		sus_obter_resultado_fpo(a.nr_sequencia,2,'E') vl_executado, 
		sus_obter_resultado_fpo(a.nr_sequencia,1,'P') qt_protocolo, 
		sus_obter_resultado_fpo(a.nr_sequencia,2,'P') vl_protocolo, 
		a.cd_carater_internacao, 
		a.ie_tipo_atendimento, 
		a.dt_competencia, 
		a.ie_tipo_financiamento, 
		a.ie_complexidade, 
		a.nr_seq_estrutura_regra, 
		a.nm_usuario_resp 
	FROM sus_fpo_regra a
LEFT OUTER JOIN sus_grupo b ON (a.nr_seq_grupo = b.nr_sequencia)
LEFT OUTER JOIN sus_subgrupo c ON (a.nr_seq_subgrupo = c.nr_sequencia)
LEFT OUTER JOIN sus_forma_organizacao d ON (a.nr_seq_forma_org = d.nr_sequencia)
WHERE a.dt_competencia = dt_competencia_p    group by	a.nr_sequencia, 
		a.nr_seq_grupo, 
		b.cd_grupo, 
		b.ds_grupo, 
		a.nr_seq_subgrupo, 
		c.cd_subgrupo, 
		c.ds_subgrupo, 
		a.nr_seq_forma_org, 
		d.cd_forma_organizacao, 
		d.ds_forma_organizacao, 
		a.cd_procedimento, 
		a.ie_origem_proced, 
		substr(obter_descricao_procedimento(a.cd_procedimento,a.ie_origem_proced),1,255), 
		a.cd_cbo, 
		substr(sus_obter_desc_cbo(a.cd_cbo),1,255), 
		a.qt_fisico, 
		a.vl_orcamento, 
		sus_obter_resultado_fpo(a.nr_sequencia,1,'E'), 
		sus_obter_resultado_fpo(a.nr_sequencia,2,'E'), 
		sus_obter_resultado_fpo(a.nr_sequencia,1,'P'), 
		sus_obter_resultado_fpo(a.nr_sequencia,2,'P'), 
		a.cd_carater_internacao, 
		a.ie_tipo_atendimento, 
		a.dt_competencia, 
		a.ie_tipo_financiamento, 
		a.ie_complexidade, 
		a.nr_seq_estrutura_regra, 
		a.nm_usuario_resp 
	order by nr_sequencia;


BEGIN 
 
delete from w_sus_fpo_regra_relat 
where nm_usuario = nm_usuario_p;
 
open C01;
loop 
fetch C01 into	 
	nr_seq_fpo_regra_w, 
	nr_seq_grupo_w, 
	cd_grupo_w, 
	ds_grupo_w, 
	nr_seq_subgrupo_w, 
	cd_subgrupo_w, 
	ds_subgrupo_w, 
	nr_seq_forma_org_w, 
	cd_forma_organizacao_w, 
	ds_forma_organizacao_w, 
	cd_procedimento_w, 
	ie_origem_proced_w, 
	ds_procedimento_w, 
	cd_cbo_w, 
	ds_cbo_w, 
	qt_fisico_w, 
	vl_orcamento_w, 
	qt_executado_w, 
	vl_executado_w, 
	qt_protocolo_w, 
	vl_protocolo_w, 
	cd_carater_internacao_w, 
	ie_tipo_atendimento_w, 
	dt_competencia_w, 
	ie_tipo_financiamento_w, 
	ie_complexidade_w, 
	nr_seq_estrutura_regra_w, 
	nm_usuario_resp_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin 
	 
	qt_saldo_fisico_w	:= qt_fisico_w - qt_executado_w;
	vl_saldo_orcamentario_w	:= vl_orcamento_w - vl_executado_w;
	 
	if (coalesce(cd_grupo_w,0) <> 0) then 
		ds_tipo_w := substr( cd_grupo_w ||' - '|| ds_grupo_w ||' . ',1,2000);
	end if;
	if (coalesce(cd_subgrupo_w,0) <> 0) then 
		ds_tipo_w := substr( cd_subgrupo_w ||' - '|| ds_subgrupo_w ||' . ',1,2000);
	end if;
	if (coalesce(cd_forma_organizacao_w,0) <> 0) then 
		ds_tipo_w := substr( cd_forma_organizacao_w ||' - '|| ds_forma_organizacao_w ||' . ',1,2000);
	end if;
	if (coalesce(cd_procedimento_w,0) <> 0) then 
		ds_tipo_w := substr( cd_procedimento_w ||' - '|| ds_procedimento_w ||' . ',1,2000);
	end if;
	if (coalesce(cd_cbo_w,0) <> 0) then 
		ds_tipo_w := substr( ds_cbo_w ,1,2000);
	end if;
	 
	insert into w_sus_fpo_regra_relat(	 
		nr_sequencia, 
		nr_seq_fpo_regra, 
		nm_usuario,  
		dt_atualizacao,  
		dt_competencia,  
		cd_carater_internacao, 
		cd_cbo, 
		cd_forma_organizacao, 
		cd_grupo, 
		cd_procedimento, 
		cd_subgrupo, 
		ds_cbo, 
		ds_forma_organizacao, 
		ds_grupo, 
		ds_procedimento, 
		ds_subgrupo, 
		ie_complexidade, 
		ie_origem_proced, 
		ie_tipo_atendimento,  
		ie_tipo_financiamento, 
		nm_usuario_resp, 
		nr_seq_estrutura_regra, 
		nr_seq_forma_org, 
		nr_seq_grupo, 
		nr_seq_subgrupo, 
		qt_executado, 
		qt_fisico, 
		qt_protocolo, 
		vl_executado, 
		vl_orcamento, 
		vl_protocolo, 
		qt_saldo_fisico, 
		vl_saldo_orcamentario, 
		ds_tipo) 
	values (	nextval('w_sus_fpo_regra_relat_seq'), 
		nr_seq_fpo_regra_w, 
		nm_usuario_p, 
		clock_timestamp(), 
		dt_competencia_w, 
		cd_carater_internacao_w, 
		cd_cbo_w, 
		cd_forma_organizacao_w, 
		cd_grupo_w, 
		cd_procedimento_w, 
		cd_subgrupo_w, 
		ds_cbo_w, 
		ds_forma_organizacao_w, 
		ds_grupo_w, 
		ds_procedimento_w, 
		ds_subgrupo_w, 
		ie_complexidade_w, 
		ie_origem_proced_w, 
		ie_tipo_atendimento_w, 
		ie_tipo_financiamento_w, 
		nm_usuario_resp_w, 
		nr_seq_estrutura_regra_w, 
		nr_seq_forma_org_w, 
		nr_seq_grupo_w, 
		nr_seq_subgrupo_w, 
		coalesce(qt_executado_w,0), 
		coalesce(qt_fisico_w,0), 
		coalesce(qt_protocolo_w,0), 
		coalesce(vl_orcamento_w,0), 
		coalesce(vl_executado_w,0), 
		coalesce(vl_protocolo_w,0), 
		coalesce(qt_saldo_fisico_w,0), 
		coalesce(vl_saldo_orcamentario_w,0), 
		substr(ds_tipo_w,1,2000));
	 
	end;
end loop;
close C01;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_w_sus_fpo_regra_relat ( dt_competencia_p timestamp, nm_usuario_p text) FROM PUBLIC;

