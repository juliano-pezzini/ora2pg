-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE atualizar_itens_barra_oc_nf ( nr_sequencia_p bigint, nr_item_nf_p bigint, qt_material_p bigint, nm_usuario_p text) AS $body$
DECLARE


qt_original_w			double precision;
cd_material_w			integer;
qt_existe_w			bigint;
cd_unidade_medida_w		varchar(30);
nr_seq_marca_w			bigint;
vl_unitario_item_nf_w		double precision;
pr_descontos_w			double precision;
nr_ordem_compra_w		bigint;
nr_item_oci_w			bigint;
cd_estabelecimento_w		integer;
cd_cgc_w			varchar(14);
vl_desconto_oci_w			double precision;
vl_total_item_nf_w			double precision;
vl_desconto_w			double precision;
vl_liquido_w			double precision;
qt_item_estoque_w		double precision;


BEGIN

select	qt_item_nf
into STRICT	qt_original_w
from	nota_fiscal_item
where	nr_sequencia = nr_sequencia_p
and	nr_item_nf = nr_item_nf_p;

if (qt_material_p = 0) then
	begin

	select	cd_material
	into STRICT	cd_material_w
	from	nota_fiscal_item
	where	nr_sequencia = nr_sequencia_p
	and	nr_item_nf = nr_item_nf_p;

	delete
	from	nota_fiscal_item
	where	nr_sequencia = nr_sequencia_p
	and	nr_item_nf = nr_item_nf_p;

	select	count(*)
	into STRICT	qt_existe_w
	from	nota_fiscal_item
	where	nr_sequencia = nr_sequencia_p
	and	cd_material = cd_material_w;

	if (qt_existe_w = 0) then
		begin

		delete
		from	w_consist_disp_mercado
		where	cd_funcao = 40
		and	nm_usuario = nm_usuario_p
		and	cd_material = cd_material_w;

		end;
	end if;

	end;
elsif (qt_material_p <> qt_original_w) then
	begin

	select	a.cd_material,
		a.cd_unidade_medida_compra,
		a.nr_seq_marca,
		a.vl_unitario_item_nf,
		a.pr_desconto,
		a.nr_ordem_compra,
		a.nr_item_oci,
		b.cd_estabelecimento,
		b.cd_cgc
	into STRICT	cd_material_w,
		cd_unidade_medida_w,
		nr_seq_marca_w,
		vl_unitario_item_nf_w,
		pr_descontos_w,
		nr_ordem_compra_w,
		nr_item_oci_w,
		cd_estabelecimento_w,
		cd_cgc_w
	from	nota_fiscal_item a,
		nota_fiscal b
	where	b.nr_sequencia = nr_sequencia_p
	and	a.nr_sequencia = b.nr_sequencia
	and	a.nr_item_nf = nr_item_nf_p;

	select	vl_desconto
	into STRICT	vl_desconto_oci_w
	from	ordem_compra_item
	where	nr_ordem_compra = nr_ordem_compra_w
	and	nr_item_oci = nr_item_oci_w;

	vl_total_item_nf_w		:= (qt_material_p * vl_unitario_item_nf_w);
	vl_desconto_w		:= (vl_total_item_nf_w * pr_descontos_w) / 100 + coalesce(vl_desconto_oci_w,0);
	vl_liquido_w		:=  vl_total_item_nf_w - vl_desconto_w;

	select	obter_qt_convertida_compra_est(cd_material_w,qt_material_p,cd_unidade_medida_w,nr_seq_marca_w,cd_cgc_w,cd_estabelecimento_w)
	into STRICT	qt_item_estoque_w
	;

	update	nota_fiscal_item
	set	qt_item_nf	= qt_material_p,
		qt_item_estoque	= qt_item_estoque_w,
		vl_total_item_nf	= vl_total_item_nf_w,
		vl_desconto	= vl_desconto_w,
		vl_liquido		= vl_liquido_w,
		ie_barras_lido	= 'S'
	where	nr_sequencia	= nr_sequencia_p
	and	nr_item_nf	= nr_item_nf_p;

	end;
else
	begin

	update	nota_fiscal_item
	set	ie_barras_lido	= 'S'
	where	nr_sequencia	= nr_sequencia_p
	and	nr_item_nf	= nr_item_nf_p;

	end;
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE atualizar_itens_barra_oc_nf ( nr_sequencia_p bigint, nr_item_nf_p bigint, qt_material_p bigint, nm_usuario_p text) FROM PUBLIC;

