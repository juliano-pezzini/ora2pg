-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE regra_atend_bg_empregador ( nr_atendimento_p atendimento_paciente.nr_atendimento%type, nr_seq_tipo_admissao_fat_p atendimento_paciente.nr_seq_tipo_admissao_fat%type, cd_pessoa_fisica_p atendimento_paciente.cd_pessoa_fisica%type, dt_entrada_p atendimento_paciente.dt_entrada%type, cd_cgc_p INOUT pessoa_fisica_empregador.cd_cgc%type, dt_inicio_trabalho_p INOUT pessoa_fisica_empregador.dt_inicio_trabalho%type, ds_empresa_texto_p INOUT pessoa_fisica_empregador.ds_empresa_texto%type) AS $body$
DECLARE


qt_encounters_w		integer;
ie_tipo_admissao_fat	varchar(1);


BEGIN

cd_cgc_p := 0;
dt_inicio_trabalho_p := clock_timestamp();
ds_empresa_texto_p	:= '';

if ((nr_atendimento_p IS NOT NULL AND nr_atendimento_p::text <> '') and (nr_seq_tipo_admissao_fat_p IS NOT NULL AND nr_seq_tipo_admissao_fat_p::text <> '') and
		(cd_pessoa_fisica_p IS NOT NULL AND cd_pessoa_fisica_p::text <> '') and (dt_entrada_p IS NOT NULL AND dt_entrada_p::text <> '')) then

	select  count(*)
	into STRICT	qt_encounters_w
	from    episodio_paciente ep,
		atendimento_paciente ap
	where   ep.nr_sequencia = ap.nr_seq_episodio
	and     ep.nr_sequencia = (SELECT  ap2.nr_seq_episodio
				   from    atendimento_paciente ap2
				   where   ap2.nr_atendimento = nr_atendimento_p
				   )
	and     ap.nr_atendimento <> nr_atendimento_p;
	
	if (qt_encounters_w = 0) then
	
		select	CASE WHEN count(1)=0 THEN  'N'  ELSE 'S' END
		into STRICT	ie_tipo_admissao_fat
		from    tipo_admissao_fat ta
		where   ta.nr_sequencia = nr_seq_tipo_admissao_fat_p
		and     ta.ie_tipo_bg = 'S';
		
		if (ie_tipo_admissao_fat = 'S') then
			
			select	max(pfe.cd_cgc),
				max(pfe.dt_inicio_trabalho),
				max(pfe.ds_empresa_texto)
			into STRICT	cd_cgc_p,
				dt_inicio_trabalho_p,
				ds_empresa_texto_p
			from    pessoa_fisica_empregador pfe
			where   pfe.cd_pessoa_fisica = cd_pessoa_fisica_p
			and 	((dt_entrada_p between pfe.dt_inicio_trabalho and pfe.dt_fim_trabalho) or (dt_entrada_p >= pfe.dt_inicio_trabalho and coalesce(pfe.dt_fim_trabalho::text, '') = ''));
			
		end if;
	
	end if;

end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE regra_atend_bg_empregador ( nr_atendimento_p atendimento_paciente.nr_atendimento%type, nr_seq_tipo_admissao_fat_p atendimento_paciente.nr_seq_tipo_admissao_fat%type, cd_pessoa_fisica_p atendimento_paciente.cd_pessoa_fisica%type, dt_entrada_p atendimento_paciente.dt_entrada%type, cd_cgc_p INOUT pessoa_fisica_empregador.cd_cgc%type, dt_inicio_trabalho_p INOUT pessoa_fisica_empregador.dt_inicio_trabalho%type, ds_empresa_texto_p INOUT pessoa_fisica_empregador.ds_empresa_texto%type) FROM PUBLIC;

