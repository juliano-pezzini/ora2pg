-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE sus_obter_dados_fpo_unif ( cd_procedimento_p bigint, ie_origem_proced_p bigint, ie_tipo_atendimento_p bigint, dt_vigencia_p timestamp, cd_cbo_p text, ie_tipo_p bigint, cd_estabelecimento_p bigint, nr_aih_p bigint, cd_setor_atendimento_p bigint, cd_procedencia_p bigint, qt_fisico_p INOUT bigint, vl_orcamentario_p INOUT bigint, nr_sequencia_p INOUT bigint, ie_carater_inter_sus_p text) AS $body$
DECLARE


nr_seq_grupo_w			sus_fpo_regra.nr_seq_grupo%type;
nr_seq_subgrupo_w		sus_fpo_regra.nr_seq_subgrupo%type;
nr_seq_forma_org_w		sus_fpo_regra.nr_seq_forma_org%type;
qt_fisico_w			sus_fpo_regra.qt_fisico%type;
vl_orcamentario_w		sus_fpo_regra.vl_orcamento%type;
nr_sequencia_w			sus_fpo_regra.nr_sequencia%type;
ie_tipo_financiamento_w		sus_procedimento.ie_tipo_financiamento%type;
ie_tipo_financ_proc_w		sus_procedimento.ie_tipo_financiamento%type;
ie_complexidade_w		sus_procedimento.ie_complexidade%type;
cd_carater_internacao_w		sus_aih_unif.cd_carater_internacao%type;

c01 CURSOR FOR
	SELECT	coalesce(a.qt_fisico,0),
		coalesce(a.vl_orcamento,0),
		a.nr_sequencia
	from	sus_fpo_regra a
	where	((coalesce(sus_obter_fpo_regra_proc(cd_procedimento_p,ie_origem_proced_p,a.nr_sequencia),'N') = 'S') or
		((coalesce(a.ie_origem_proced,ie_origem_proced_p)		= ie_origem_proced_p) and (coalesce(a.cd_procedimento,cd_procedimento_p)		= cd_procedimento_p)))
	and (coalesce(sus_obter_fpo_regra_setor(cd_setor_atendimento_p,a.nr_sequencia),'N') = 'S')	
	and	coalesce(a.nr_seq_grupo,nr_seq_grupo_w)			= nr_seq_grupo_w
	and	coalesce(a.nr_seq_subgrupo,nr_seq_subgrupo_w)		= nr_seq_subgrupo_w
	and	coalesce(a.nr_seq_forma_org,nr_seq_forma_org_w)		= nr_seq_forma_org_w
	and	obter_se_contido(coalesce(ie_tipo_atendimento_p,0),coalesce(a.ie_tipo_atendimento,coalesce(ie_tipo_atendimento_p,'0'))) = 'S'
	and	obter_se_contido(coalesce(cd_procedencia_p,0),coalesce(a.cd_procedencia,coalesce(cd_procedencia_p,'0'))) = 'S'
	and	coalesce(a.ie_tipo_financiamento,ie_tipo_financiamento_w) 	= ie_tipo_financiamento_w
	and	coalesce(a.ie_complexidade,ie_complexidade_w)		= ie_complexidade_w
	and	((coalesce(sus_obter_fpo_cbo(coalesce(cd_cbo_p,'X'),a.nr_sequencia),'N')	= 'S') or (coalesce(a.cd_cbo,coalesce(cd_cbo_p,'X'))				= coalesce(cd_cbo_p,'X')))
	and	a.cd_estabelecimento				= cd_estabelecimento_p
	and	establishment_timezone_utils.startOfMonth(a.dt_competencia)			= establishment_timezone_utils.startOfMonth(dt_vigencia_p)
	and	coalesce(a.cd_carater_internacao,cd_carater_internacao_w)	= cd_carater_internacao_w
	and	not exists (	SELECT	1
				from	sus_fpo_regra_desconsid x
				where	x.nr_seq_fpo_regra	= a.nr_sequencia
				and	coalesce(a.cd_cbo,'0')	= coalesce(x.cd_cbo,coalesce(a.cd_cbo,'0'))
				and	a.cd_procedimento	= coalesce(x.cd_procedimento,a.cd_procedimento)
				and	a.ie_origem_proced	= coalesce(x.ie_origem_proced,a.ie_origem_proced)
				and	a.nr_seq_forma_org	= coalesce(x.nr_seq_forma_org,a.nr_seq_forma_org)
				and	a.nr_seq_grupo	= coalesce(x.nr_seq_grupo,a.nr_seq_grupo)
				and	a.nr_seq_subgrupo	= coalesce(x.nr_seq_subgrupo,a.nr_seq_subgrupo))
	and	coalesce(a.ie_situacao,'A') = 'A'
	order by coalesce(cd_procedimento,0),
		 coalesce(nr_seq_forma_org,0),
		 coalesce(nr_seq_subgrupo,0),
		 coalesce(nr_seq_grupo,0),
		 dt_competencia;


BEGIN

begin
select	nr_seq_grupo,
	nr_seq_subgrupo,
	nr_seq_forma_org
into STRICT	nr_seq_grupo_w,
	nr_seq_subgrupo_w,
	nr_seq_forma_org_w
from	sus_estrutura_procedimento_v
where	cd_procedimento		= cd_procedimento_p
and	ie_origem_proced	= ie_origem_proced_p;
exception
	when others then
	nr_seq_grupo_w		:= null;
	nr_seq_subgrupo_w	:= null;
	nr_seq_forma_org_w	:= null;
end;

select	coalesce(max(ie_tipo_financiamento),'X'),
	coalesce(max(ie_complexidade),'X')
into STRICT	ie_tipo_financ_proc_w,
	ie_complexidade_w
from	sus_procedimento
where	cd_procedimento		= cd_procedimento_p
and	ie_origem_proced	= ie_origem_proced_p;

if (coalesce(nr_aih_p,0) = 0) then
	begin
	cd_carater_internacao_w := coalesce(ie_carater_inter_sus_p,'00');
	ie_tipo_financiamento_w	:= ie_tipo_financ_proc_w;
	end;
else
	begin
	
	begin
	select	coalesce(max(cd_carater_internacao),'00'),
		coalesce(max(ie_tipo_financiamento),ie_tipo_financ_proc_w)
	into STRICT	cd_carater_internacao_w,
		ie_tipo_financiamento_w
	from	sus_aih_unif
	where	nr_aih = nr_aih_p;
	exception
	when others then
		cd_carater_internacao_w := '00';
		ie_tipo_financiamento_w := ie_tipo_financ_proc_w;
	end;

	end;
end if;

open c01;
loop
fetch c01 into
	qt_fisico_w,
	vl_orcamentario_w,
	nr_sequencia_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
	begin
	qt_fisico_p	:= qt_fisico_w;
	vl_orcamentario_p	:= vl_orcamentario_w;
	nr_sequencia_p	:= nr_sequencia_w;
	end;
end loop;
close c01;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE sus_obter_dados_fpo_unif ( cd_procedimento_p bigint, ie_origem_proced_p bigint, ie_tipo_atendimento_p bigint, dt_vigencia_p timestamp, cd_cbo_p text, ie_tipo_p bigint, cd_estabelecimento_p bigint, nr_aih_p bigint, cd_setor_atendimento_p bigint, cd_procedencia_p bigint, qt_fisico_p INOUT bigint, vl_orcamentario_p INOUT bigint, nr_sequencia_p INOUT bigint, ie_carater_inter_sus_p text) FROM PUBLIC;

