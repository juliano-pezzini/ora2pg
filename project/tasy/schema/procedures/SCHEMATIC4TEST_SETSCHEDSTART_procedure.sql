-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE schematic4test_setschedstart (NR_SEQ_SCHEDULE_P bigint, NR_SEQ_SUITE_P bigint) AS $body$
DECLARE

NR_SEQ_PACKAGE_W bigint;
NR_SEQ_SUITE_W bigint;
QTD_W bigint;
QTD_W2 bigint;
QTD_W3 bigint;
DT_SCHEDULE_W timestamp;


BEGIN
  --procedure that start scheduele
  UPDATE SCHEM_TEST_SCHEDULE SET IE_STATUS = '2', DT_SCHEDULE = clock_timestamp() WHERE NR_SEQUENCIA = NR_SEQ_SCHEDULE_P;
  COMMIT;

  SELECT COUNT(NR_SEQUENCIA) NR_SEQUENCIA
      INTO STRICT QTD_W
  FROM SCHEM_TEST_SCHEDULE 
	WHERE NR_SEQUENCIA = NR_SEQ_SCHEDULE_P 
  AND (NR_SEQ_PACKAGE IS NOT NULL AND NR_SEQ_PACKAGE::text <> '');
			
	IF (QTD_W <> 0) THEN
      SELECT NR_SEQ_PACKAGE NR_SEQ_PACKAGE, NR_SEQ_SUITE NR_SEQ_SUITE
          INTO STRICT NR_SEQ_PACKAGE_W, NR_SEQ_SUITE_W
      FROM SCHEM_TEST_SCHEDULE 
      WHERE NR_SEQUENCIA = NR_SEQ_SCHEDULE_P      
      AND (NR_SEQ_PACKAGE IS NOT NULL AND NR_SEQ_PACKAGE::text <> '')
      GROUP BY NR_SEQ_PACKAGE, NR_SEQ_SUITE;

      UPDATE SCHEM_TEST_PACKAGE_SCHED SET IE_STATUS = '2' WHERE NR_SEQUENCIA = NR_SEQ_PACKAGE_W;
      COMMIT;
	
      SELECT COUNT(sched.DT_SCHEDULE) DT_SCHEDULE
          INTO STRICT QTD_W3
      FROM SCHEM_TEST_SCHEDULE sched
      WHERE sched.NR_SEQ_PACKAGE = NR_SEQ_PACKAGE_W 
      ORDER BY sched.DT_SCHEDULE ASC;

      IF (QTD_W3 <> 0) THEN
        SELECT MIN(sched.DT_SCHEDULE) DT_SCHEDULE
          INTO STRICT DT_SCHEDULE_W
        FROM SCHEM_TEST_SCHEDULE sched      
        WHERE sched.NR_SEQ_PACKAGE = NR_SEQ_PACKAGE_W 
        ORDER BY sched.DT_SCHEDULE ASC;

        UPDATE SCHEM_TEST_PACKAGE_SCHED SET DT_SCHEDULE = DT_SCHEDULE_W WHERE NR_SEQUENCIA = NR_SEQ_PACKAGE_W;			
        COMMIT;
      END IF;
  END IF;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE schematic4test_setschedstart (NR_SEQ_SCHEDULE_P bigint, NR_SEQ_SUITE_P bigint) FROM PUBLIC;

