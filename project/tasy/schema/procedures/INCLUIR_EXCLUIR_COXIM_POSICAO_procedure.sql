-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE incluir_excluir_coxim_posicao ( nr_seq_posicao_p bigint, nr_seq_coxim_p bigint, ds_lista_topografia_p text, ie_opcao_p text, ie_lado_p text default null, ie_apresenta_mensagem_p INOUT text DEFAULT NULL) AS $body$
DECLARE

														
nm_usuario_w				usuario.nm_usuario%type	:= wheb_usuario_pck.get_nm_usuario;
ie_apresenta_mensagem_w	varchar(1) := 'S';
nr_seq_topografia_w     topografia_dor.nr_sequencia%type;

c01 CURSOR FOR
	SELECT 	b.nr_sequencia
	from 		table(lista_pck.obter_lista(ds_lista_topografia_p)) a,
				topografia_dor b
	where		a.nr_registro = b.nr_sequencia
   and      not exists (SELECT   1
                        from     posicao_cirurgia_coxim c 
                        where    c.nr_seq_posicao        = nr_seq_posicao_p 
                        and      c.nr_seq_coxim          = nr_seq_coxim_p 
                        and      c.nr_seq_topografia     = b.nr_sequencia);


BEGIN

if (coalesce(nr_seq_posicao_p,0) > 0) then
	if (ie_opcao_p = 'I') and (coalesce(nr_seq_coxim_p,0) > 0) then
      		if (ds_lista_topografia_p IS NOT NULL AND ds_lista_topografia_p::text <> '') then
         			open C01;
         			loop
         			fetch C01 into	
            				nr_seq_topografia_w;
        			EXIT WHEN NOT FOUND; /* apply on C01 */
            			begin
           				insert into posicao_cirurgia_coxim(
                                                			nr_sequencia,
                                                			dt_atualizacao, 
                                                			nm_usuario, 
                                               				dt_atualizacao_nrec, 
                                                			nm_usuario_nrec, 
                                                			nr_seq_posicao, 
                                                			nr_seq_coxim,
                                                			nr_seq_topografia,
						ie_lado)
            				values (nextval('posicao_cirurgia_coxim_seq'),
                                                			clock_timestamp(), 
                                                			nm_usuario_w, 
                                                			clock_timestamp(), 
                                                			nm_usuario_w, 
                                                			nr_seq_posicao_p, 
                                                			nr_seq_coxim_p,
                                                			nr_seq_topografia_w,
						ie_lado_p);
            				end;
         			end loop;
         			close C01;
      		else
         			insert into posicao_cirurgia_coxim(
                                                		nr_sequencia,
		                                                dt_atualizacao, 
                                		                nm_usuario, 
                                                		dt_atualizacao_nrec, 
                                                		nm_usuario_nrec, 
                                                		nr_seq_posicao, 
                                                		nr_seq_coxim,
                                                		nr_seq_topografia,
					ie_lado)
		            values (nextval('posicao_cirurgia_coxim_seq'),
                                		                clock_timestamp(), 
                                                		nm_usuario_w, 
                                                		clock_timestamp(), 
                                                		nm_usuario_w, 
                                                		nr_seq_posicao_p, 
                                                		nr_seq_coxim_p,
                                                		null,
					ie_lado_p);
      	end if;
	elsif (ie_opcao_p = 'D') then
		delete	from 	posicao_cirurgia_coxim
		where		nr_seq_posicao = nr_seq_posicao_p;
		IF	NOT FOUND THEN
			ie_apresenta_mensagem_w := 'N';
		end if;	
	end if;	
end if;	

ie_apresenta_mensagem_p := ie_apresenta_mensagem_w;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE incluir_excluir_coxim_posicao ( nr_seq_posicao_p bigint, nr_seq_coxim_p bigint, ds_lista_topografia_p text, ie_opcao_p text, ie_lado_p text default null, ie_apresenta_mensagem_p INOUT text DEFAULT NULL) FROM PUBLIC;

