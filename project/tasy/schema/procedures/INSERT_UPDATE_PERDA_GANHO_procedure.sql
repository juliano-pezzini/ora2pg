-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE insert_update_perda_ganho ( nr_atendimento_p bigint, dt_medida_p text, nr_seq_tipo_p bigint, qt_volume_p bigint, dt_referencia_p text, qt_ocorrencia_p bigint, nr_hora_p bigint, nm_usuario_p text, cd_setor_atendimento_p bigint, cd_profissional_p bigint, ie_exige_liberacao text, nr_seq_topografia_p bigint default null, ie_lado_p text default null, nr_sequencia_p INOUT bigint DEFAULT NULL, ds_observacao_p text default null, ds_lista_inf_adic_p text default null) AS $body$
DECLARE



dt_liberacao_w	timestamp	:= null;
nr_sequencia_w	bigint;


BEGIN

if (ie_exige_liberacao = 'S') then
	dt_liberacao_w := clock_timestamp();
end if;

if (nr_sequencia_p IS NOT NULL AND nr_sequencia_p::text <> '') then

	update	atendimento_perda_ganho set
                nr_atendimento	 	= nr_atendimento_p,  
                dt_medida     	 	= to_date(dt_medida_p, 'dd/mm/yy hh24:mi:ss'),    
                dt_atualizacao	 	= clock_timestamp(),  
                nr_seq_tipo   	 	= nr_seq_tipo_p,  
                qt_volume     	 	= qt_volume_p,  
                nm_usuario    	 	= nm_usuario_p, 
                cd_setor_atendimento 	= cd_setor_atendimento_p, 
                cd_profissional 	= cd_profissional_p,
                qt_ocorrencia   	= qt_ocorrencia_p,
                nr_hora         	= nr_hora_p,
		dt_liberacao		= dt_liberacao_w,
		ds_observacao		= ds_observacao_p,
		ie_lado			= ie_lado_p,
		nr_seq_topografia	= nr_seq_topografia_p
        where 	nr_sequencia 		= nr_sequencia_p;
else
	select 	nextval('atendimento_perda_ganho_seq')
	into STRICT	nr_sequencia_w
	;

	insert into atendimento_perda_ganho(
                  nr_atendimento,  
                  dt_medida, 
                  dt_atualizacao ,  
                  nr_seq_tipo,  
                  qt_volume,  
                  dt_referencia,  
                  qt_ocorrencia,
                  nr_hora,
                  nr_sequencia,
                  nm_usuario, 
                  cd_setor_atendimento, 
                  cd_profissional,
                  ie_lado,
                  nr_seq_topografia, 
                  dt_liberacao,
                  ie_situacao,
                  ds_observacao,
                  cd_turno) 
        values ( 
                  nr_atendimento_p, 
                  to_date(dt_medida_p, 'dd/mm/yyyy hh24:mi:ss'),
                  clock_timestamp(),
                  nr_seq_tipo_p,
                  qt_volume_p,
                  to_date(dt_referencia_p, 'dd/mm/yyyy hh24:mi:ss'), 
                  qt_ocorrencia_p,
                  nr_hora_p,
                  nr_sequencia_w,
                  nm_usuario_p,
                  cd_setor_atendimento_p,
                  cd_profissional_p,
                  ie_lado_p,
                  nr_seq_topografia_p,		  
                  dt_liberacao_w ,
                  'A',
                  ds_observacao_p,
                  Obter_Turno_Atendimento(clock_timestamp(),(obter_estab_atendimento(nr_atendimento_p))::numeric ,'D')
              );
				
		CALL Inserir_info_adic_perda(ds_lista_inf_adic_p, nr_sequencia_w, nm_usuario_p);
		
end if;

nr_sequencia_p := nr_sequencia_w;

if (ie_exige_liberacao = 'S' and (nr_sequencia_p IS NOT NULL AND nr_sequencia_p::text <> '')) then
    CALL gerar_lancamento_automatico(nr_atendimento_p, null, 381, nm_usuario_p, null, nr_seq_tipo_p, nr_sequencia_p, null,null,null);
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE insert_update_perda_ganho ( nr_atendimento_p bigint, dt_medida_p text, nr_seq_tipo_p bigint, qt_volume_p bigint, dt_referencia_p text, qt_ocorrencia_p bigint, nr_hora_p bigint, nm_usuario_p text, cd_setor_atendimento_p bigint, cd_profissional_p bigint, ie_exige_liberacao text, nr_seq_topografia_p bigint default null, ie_lado_p text default null, nr_sequencia_p INOUT bigint DEFAULT NULL, ds_observacao_p text default null, ds_lista_inf_adic_p text default null) FROM PUBLIC;

