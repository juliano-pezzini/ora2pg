-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE desvincular_titulo_barras ( nr_titulo_p bigint, nr_sequencia_p bigint) AS $body$
DECLARE


				
ie_desv_barras_titulo_w	varchar(1);
nr_seq_escrit_w			titulo_pagar_escrit.nr_seq_escrit%type;
				

BEGIN

ie_desv_barras_titulo_w := obter_param_usuario(857, 69, obter_perfil_ativo, wheb_usuario_pck.get_nm_usuario, wheb_usuario_pck.get_cd_estabelecimento, ie_desv_barras_titulo_w);

if (coalesce(ie_desv_barras_titulo_w,'N') = 'N') then
	select coalesce(max(nr_seq_escrit),0)
	into STRICT nr_seq_escrit_w
	from titulo_pagar_escrit
	where nr_titulo = nr_titulo_p;
	
	if (nr_seq_escrit_w > 0) then
		-- Não é permitido desvincular o código de barras deste títulos, pois ele já está ligado a um lote de pagamento. Parâmetro [69].
		CALL wheb_mensagem_pck.exibir_mensagem_abort(458569);
	end if;
end if;

update titulo_pagar
set nr_bloqueto  = NULL,
	ie_bloqueto = 'N'
where nr_titulo = nr_titulo_p;

update banco_escrit_barras
set nr_titulo  = NULL,  
	dt_atualizacao = clock_timestamp()  
where nr_sequencia = nr_sequencia_p;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE desvincular_titulo_barras ( nr_titulo_p bigint, nr_sequencia_p bigint) FROM PUBLIC;

