-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_inconsistencia_oftalmo ( nr_seq_consulta_p text, ie_momento_p text, nm_usuario_p text, cd_estabelecimento_p bigint, ie_permite_gerar_p INOUT text, ie_habilita_liberar_p INOUT text) AS $body$
DECLARE

				

ds_alerta_w					varchar(2000);
ds_sql_w					varchar(2000);
cd_perfil_w					integer;
ie_forma_consistir_w		varchar(15);
ds_consistencia_w			varchar(2000);
qt_retorno_w				bigint;
ie_permite_gerar_w			varchar(1) := 'S';
ie_util_botao_lib_todas_w	regra_consulta_oftalmo.ie_util_botao_lib_todas%type;
ds_comando_adic_w			regra_consulta_oftalmo.ds_comando_adic%type;
ds_retorno_adic_w			varchar(32000);
								
c01 CURSOR FOR
	SELECT  a.ds_sql,
		a.ie_forma_consistir,
		a.ds_consistencia,
		a.ie_util_botao_lib_todas,
		a.ds_comando_adic
	FROM	REGRA_CONSULTA_OFTALMO a
	WHERE	ie_momento = ie_momento_p
	AND	coalesce(a.ie_situacao,'A') 		= 'A'
	order by coalesce(a.nr_sequencia,0);
				

BEGIN

cd_perfil_w	:= wheb_usuario_pck.get_cd_perfil;
ie_habilita_liberar_p := 'N';

delete	from CONSISTENCIA_OFTALMOLOGIA
where 	nr_seq_consulta = nr_seq_consulta_p;
commit;

open C01;
loop
fetch C01 into	
	ds_sql_w,
	ie_forma_consistir_w,
	ds_consistencia_w,
	ie_util_botao_lib_todas_w,
	ds_comando_adic_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin

	qt_retorno_w := Obter_valor_Dinamico_bv(ds_sql_w, 'NR_SEQUENCIA='||nr_seq_consulta_p||';', qt_retorno_w);
	
	if (ds_comando_adic_w IS NOT NULL AND ds_comando_adic_w::text <> '') then
		BEGIN
			ds_retorno_adic_w := obter_select_concat_extendido(ds_comando_adic_w, 'NR_SEQUENCIA='||nr_seq_consulta_p||';', ', ', ds_retorno_adic_w);
			ds_consistencia_w := substr(ds_consistencia_w||ds_retorno_adic_w, 0, 2000);
		EXCEPTION
		WHEN OTHERS THEN
			NULL;
		END;
	end if;
	
		if (qt_retorno_w 	<> 0) then
			insert	into	CONSISTENCIA_OFTALMOLOGIA(	nr_sequencia,
					dt_atualizacao,
					nm_usuario,
					nm_usuario_nrec,
					dt_atualizacao_nrec,
					nr_seq_consulta,
					ie_forma_consistencia,
					ds_consistencia)
			values (nextval('consistencia_oftalmologia_seq'),
					clock_timestamp(),
					nm_usuario_p,
					nm_usuario_p,
					clock_timestamp(),
					nr_seq_consulta_p,
					ie_forma_consistir_w,
					ds_consistencia_w);
			commit;
			
		select	coalesce(max('N'),'S')
		into STRICT	ie_permite_gerar_w
		from	consistencia_oftalmologia
		where	nr_seq_consulta	= nr_seq_consulta_p
		and	ie_forma_consistencia = 'B';

		ie_permite_gerar_p := ie_permite_gerar_w;	
		
		if (ie_util_botao_lib_todas_w = 'S') then
			ie_habilita_liberar_p := 'S';
		end if;
			
		end if;
		
	end;		
end loop;
close C01;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_inconsistencia_oftalmo ( nr_seq_consulta_p text, ie_momento_p text, nm_usuario_p text, cd_estabelecimento_p bigint, ie_permite_gerar_p INOUT text, ie_habilita_liberar_p INOUT text) FROM PUBLIC;

