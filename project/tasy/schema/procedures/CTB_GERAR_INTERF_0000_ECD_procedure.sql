-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE ctb_gerar_interf_0000_ecd ( nr_seq_controle_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint, dt_inicio_p timestamp, dt_fim_p timestamp, cd_empresa_p bigint, qt_linha_p INOUT bigint, nr_sequencia_p INOUT bigint) AS $body$
DECLARE


/* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Finalidade:
-------------------------------------------------------------------------------------------------------------------

Locais de chamada direta:
[ X ]  Objetos do dicionario [  ] Tasy (Delphi/Java) [  ] Portal [  ]  Relatorios [ ] Outros:
 ------------------------------------------------------------------------------------------------------------------

Pontos de atenc?o:
-------------------------------------------------------------------------------------------------------------------

Referencias:
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */
ds_arquivo_w			varchar(4000);
ds_compl_arquivo_w		varchar(4000);
ds_linha_w			varchar(8000);
ie_arquivo_w			varchar(15);
cd_municipio_ibge_w		varchar(7);
ds_lecd_w			varchar(5);
tp_registro_w			varchar(4);
cd_ind_situacao_especial_w 	varchar(2);
ie_gerar_157_w			varchar(1);
ie_gerar_I051_w			varchar(1);
ie_houve_troca_w		varchar(1)	:= 'N';
sep_w				varchar(1)	:= '|';
ind_centralizada_w		smallint	:= 0;
ind_mudanc_pc_w			smallint	:= 0;
nr_linha_w			bigint	:= qt_linha_p;
nr_seq_registro_w		bigint	:= nr_sequencia_p;
cd_empresa_controladora_w			empresa.cd_empresa%type;

ds_razao_social_w		pessoa_juridica.ds_razao_social%type;
cd_cnpj_w			estabelecimento.cd_cgc%type;
cd_cnpj_matriz_w			estabelecimento.cd_cgc%type;
cd_scp_w			estabelecimento.cd_cgc%type := '';
sg_estado_w			pessoa_juridica.sg_estado%type;
cd_inscricao_estadual_w		estabelecimento.cd_inscricao_estadual%type;
nr_inscrisao_municipal_w	estabelecimento.cd_inscricao_municipal%type;
ie_inicio_periodo_w		ctb_regra_sped.ie_inicio_periodo%type;
ie_nire_w			ctb_regra_sped.ie_nire%type;
ie_finalidade_escrit_w		ctb_regra_sped.ie_finalidade_escrit%type;
cd_hash_substituida_w		ctb_regra_sped.cd_hash_substituida%type;
nr_nire_subst_w			ctb_regra_sped.nr_nire_subst%type;
ie_porte_empresa_w		empresa.ie_porte_empresa%type;
cd_versao_w			ctb_regra_sped.cd_versao%type;
dt_inicial_w			timestamp;
dt_final_w			timestamp;
ie_tipo_ecd_w			ctb_regra_sped.ie_tipo_ecd%type;
ie_consolida_multi_empresa_w    ctb_regra_sped.ie_consolida_multi_empresa%type;
ie_sit_especial_ecd_w		ctb_regra_sped.ie_sit_especial_ecd%type;
ie_consolida_empresa_w		ctb_regra_sped.ie_consolida_empresa%type;
nr_sequencia_ctb_regra_sped_w	ctb_regra_sped.nr_sequencia%type;
cod_plan_ref_w			ctb_regra_sped.cd_empresa_resp%type;

c_establecimento CURSOR FOR
	SELECT  '0000' tp_registro,
		substr(CASE WHEN ie_arquivo_w='ECD' THEN 'LECD' WHEN ie_arquivo_w='FCONT' THEN 'LALU' END ,1,4) ds_lecd,
		substr(OBTER_RAZAO_SOCIAL(a.cd_cgc),1,255) ds_razao_social,
		a.cd_cgc cd_cnpj,
		substr(obter_dados_pf_pj(null, a.cd_cgc, 'UF'),1,2) sg_estado,
		a.cd_inscricao_estadual,
		lpad(coalesce(substr(obter_dados_pf_pj(null, a.cd_cgc, 'CDMDV'),1,7),a.cd_localidade),7,0) cd_municipio_ibge,
		a.cd_inscricao_municipal nr_inscricao_municipal,
		null cd_ind_situacao_especial  --'0' cd_ind_situacao_especial
	from	estabelecimento	a
	where	a.cd_estabelecimento	= cd_estabelecimento_p;


BEGIN
dt_inicial_w	:= dt_inicio_p;
dt_final_w	:= dt_fim_p;

select	coalesce(max(a.ie_arquivo),'ECD'),
	max(a.ie_inicio_periodo),
	max(a.ie_nire),
	max(a.ie_finalidade_escrit),
	max(a.cd_hash_substituida),
	max(a.nr_nire_subst),
	coalesce(max(a.cd_versao),'9.0'),
	coalesce(max(a.ie_tipo_ecd),0),
	coalesce(max(a.ie_consolida_multi_empresa),'N'),
	max(a.ie_sit_especial_ecd),
	max(a.ie_consolida_empresa),
	max(a.nr_sequencia),
	max(a.cd_empresa_resp)
into STRICT	ie_arquivo_w,
	ie_inicio_periodo_w,
	ie_nire_w,
	ie_finalidade_escrit_w,
	cd_hash_substituida_w,
	nr_nire_subst_w,
	cd_versao_w,
	ie_tipo_ecd_w,
	ie_consolida_multi_empresa_w,
	ie_sit_especial_ecd_w,
	ie_consolida_empresa_w,
	nr_sequencia_ctb_regra_sped_w,
	cod_plan_ref_w
from	ctb_regra_sped		a,
	ctb_sped_controle	b
where	a.nr_sequencia	= b.nr_seq_regra_sped
and	b.nr_sequencia	= nr_seq_controle_p;


ie_consolida_multi_empresa_w 	:= 'N';
cd_empresa_controladora_w 	:=  holding_pck.get_emp_controladora_grupo(NULL, cd_empresa_p);
if (cd_empresa_controladora_w = cd_empresa_p) then
	ie_consolida_multi_empresa_w := 'S';
end if;

open c_establecimento;
loop
fetch c_establecimento into
	tp_registro_w,
	ds_lecd_w,
	ds_razao_social_w,
	cd_cnpj_w,
	sg_estado_w,
	cd_inscricao_estadual_w,
	cd_municipio_ibge_w,
	nr_inscrisao_municipal_w,
	cd_ind_situacao_especial_w;
EXIT WHEN NOT FOUND; /* apply on c_establecimento */
	begin
	begin
	select	coalesce(ie_porte_empresa,'P')
	into STRICT	ie_porte_empresa_w
	from	empresa
	where	cd_empresa	= cd_empresa_p;
	exception
		when others then
		ie_porte_empresa_w	:= 'P';
	end;

	if (ie_porte_empresa_w = 'G') then
		ie_porte_empresa_w	:= '1';
	else
		ie_porte_empresa_w	:= '0';
	end if;

	if (cd_versao_w = '1.0') then
		ds_linha_w	:= substr(	sep_w || tp_registro_w				||
						sep_w || ds_lecd_w 				||
						sep_w || to_char(dt_inicial_w,'ddmmyyyy') 	||
						sep_w || to_char(dt_final_w,'ddmmyyyy')		||
						sep_w || ds_razao_social_w  			||
						sep_w || cd_cnpj_w  				||
						sep_w || sg_estado_w				||
						sep_w || cd_inscricao_estadual_w  		||
						sep_w || cd_municipio_ibge_w  			||
						sep_w || nr_inscrisao_municipal_w		||
						sep_w || cd_ind_situacao_especial_w		||
						sep_w, 1, 8000);
	elsif (cd_versao_w = '2.0') then
		ds_linha_w	:= substr(	sep_w || tp_registro_w				||
						sep_w || ds_lecd_w 				||
						sep_w || to_char(dt_inicial_w,'ddmmyyyy') 	||
						sep_w || to_char(dt_final_w,'ddmmyyyy')		||
						sep_w || ds_razao_social_w  			||
						sep_w || cd_cnpj_w  				||
						sep_w || sg_estado_w				||
						sep_w || cd_inscricao_estadual_w  		||
						sep_w || cd_municipio_ibge_w  			||
						sep_w || nr_inscrisao_municipal_w		||
						sep_w || cd_ind_situacao_especial_w		||
						sep_w || ie_inicio_periodo_w			||
						sep_w || ie_nire_w				||
						sep_w || ie_finalidade_escrit_w			||
						sep_w || cd_hash_substituida_w			||
						sep_w || nr_nire_subst_w			||
						sep_w || ie_porte_empresa_w			||
						sep_w, 1, 8000);
	elsif (cd_versao_w = '3.0') then
		ds_linha_w	:= substr(	sep_w || tp_registro_w				||
						sep_w || ds_lecd_w 				||
						sep_w || to_char(dt_inicial_w,'ddmmyyyy') 	||
						sep_w || to_char(dt_final_w,'ddmmyyyy')		||
						sep_w || ds_razao_social_w  			||
						sep_w || cd_cnpj_w  				||
						sep_w || sg_estado_w				||
						sep_w || cd_inscricao_estadual_w  		||
						sep_w || cd_municipio_ibge_w  			||
						sep_w || nr_inscrisao_municipal_w		||
						sep_w || cd_ind_situacao_especial_w		||
						sep_w || ie_inicio_periodo_w			||
						sep_w || ie_nire_w				||
						sep_w || ie_finalidade_escrit_w			||
						sep_w || cd_hash_substituida_w			||
						sep_w || nr_nire_subst_w			||
						sep_w || ie_porte_empresa_w			||
						sep_w || ie_tipo_ecd_w				||
						sep_w || ''					||
						sep_w, 1, 8000);
	elsif (cd_versao_w = '4.0') then
		ds_linha_w	:= substr(	sep_w || tp_registro_w				||
						sep_w || ds_lecd_w 				||
						sep_w || to_char(dt_inicial_w,'ddmmyyyy') 	||
						sep_w || to_char(dt_final_w,'ddmmyyyy')		||
						sep_w || ds_razao_social_w  			||
						sep_w || cd_cnpj_w  				||
						sep_w || sg_estado_w				||
						sep_w || cd_inscricao_estadual_w  		||
						sep_w || cd_municipio_ibge_w  			||
						sep_w || nr_inscrisao_municipal_w		||
						sep_w || cd_ind_situacao_especial_w		||
						sep_w || ie_inicio_periodo_w			||
						sep_w || ie_nire_w				||
						sep_w || ie_finalidade_escrit_w			||
						sep_w || cd_hash_substituida_w			||
						sep_w || nr_nire_subst_w			||
						sep_w || ie_porte_empresa_w			||
						sep_w || ie_tipo_ecd_w				||
						sep_w || ''					||
						sep_w || 'N'				||
						sep_w, 1, 8000);
	elsif (cd_versao_w in ('5.0','6.0','7.0')) then

		if (cd_versao_w = '7.0') and (ie_tipo_ecd_w = '2') then
			cd_scp_w := cd_cnpj_w;
			begin
			select	cd_cgc
			into STRICT	cd_cnpj_matriz_w
			from	estabelecimento
			where	cd_empresa = cd_empresa_p
			and	ie_tipo_estab = 'M';

			cd_cnpj_w := coalesce(cd_cnpj_matriz_w, cd_cnpj_w);

			exception when others then
				cd_cnpj_w := coalesce(cd_cnpj_matriz_w, cd_cnpj_w);
			end;
		end if;
		
		

		ds_linha_w	:= substr(	sep_w || tp_registro_w				||
						sep_w || ds_lecd_w 				||
						sep_w || to_char(dt_inicial_w,'ddmmyyyy') 	||
						sep_w || to_char(dt_final_w,'ddmmyyyy')		||
						sep_w || ds_razao_social_w  			||
						sep_w || cd_cnpj_w  				||
						sep_w || sg_estado_w				||
						sep_w || cd_inscricao_estadual_w  		||
						sep_w || cd_municipio_ibge_w  			||
						sep_w || nr_inscrisao_municipal_w		||
						sep_w || ie_sit_especial_ecd_w			||
						sep_w || ie_inicio_periodo_w			||
						sep_w || ie_nire_w				||
						sep_w || ie_finalidade_escrit_w			||
						sep_w || cd_hash_substituida_w			||
						sep_w || ie_porte_empresa_w			||
						sep_w || ie_tipo_ecd_w				||
						sep_w || cd_scp_w				||
						sep_w || 'N'					||
						sep_w || ie_consolida_multi_empresa_w 		||
						sep_w, 1, 8000);
	elsif (cd_versao_w  in ('8.0','9.0')) then

		if (ie_tipo_ecd_w = '2') then
			cd_scp_w := cd_cnpj_w;
			begin
			select	cd_cgc
			into STRICT	cd_cnpj_matriz_w
			from	estabelecimento
			where	cd_empresa = cd_empresa_p
			and	ie_tipo_estab = 'M';

			cd_cnpj_w := coalesce(cd_cnpj_matriz_w, cd_cnpj_w);

			exception when others then
				cd_cnpj_w := coalesce(cd_cnpj_matriz_w, cd_cnpj_w);
			end;
		end if;
		
		if (ie_consolida_empresa_w = 'N') then
			ind_centralizada_w := 1;
		end if;

		select	max(coalesce(ie_gerar,'N'))
		into STRICT	ie_gerar_157_w
		from	ctb_regra_sped_registro
		where	nr_seq_regra_sped = nr_sequencia_ctb_regra_sped_w
		and	cd_registro = 'I157';
		
		if (ie_gerar_157_w = 'S') then
			select	coalesce(max('S'),'N')
			into STRICT	ie_houve_troca_w
			from	ctb_mes_ref			b,
				ctb_saldo_alteracao_conta	a
			where	b.nr_sequencia		= a.nr_seq_mes_ref
			and	b.dt_referencia	between trunc(dt_inicio_p,'mm') and fim_dia(dt_fim_p)  LIMIT 1;
		end if;
		
		if (ie_gerar_157_w =  'S' and ie_houve_troca_w = 'S') then
			ind_mudanc_pc_w := 1;
		end if;
		
		select	coalesce(max(ie_gerar),'N')
		into STRICT	ie_gerar_I051_w
		from	ctb_regra_sped_registro a
		where	a.nr_seq_regra_sped = nr_sequencia_ctb_regra_sped_w
		and	a.cd_registro = 'I051';
		
		if (ie_gerar_I051_w =  'N') then
			cod_plan_ref_w := null;
		end if;
		
		ds_linha_w	:= substr(	sep_w || tp_registro_w				||
						sep_w || ds_lecd_w 				||
						sep_w || to_char(dt_inicial_w,'ddmmyyyy') 	||
						sep_w || to_char(dt_final_w,'ddmmyyyy')		||
						sep_w || ds_razao_social_w  			||
						sep_w || cd_cnpj_w  				||
						sep_w || sg_estado_w				||
						sep_w || cd_inscricao_estadual_w  		||
						sep_w || cd_municipio_ibge_w  			||
						sep_w || nr_inscrisao_municipal_w		||
						sep_w || ie_sit_especial_ecd_w			||
						sep_w || ie_inicio_periodo_w			||
						sep_w || ie_nire_w				||
						sep_w || ie_finalidade_escrit_w			||
						sep_w || cd_hash_substituida_w			||
						sep_w || ie_porte_empresa_w			||
						sep_w || ie_tipo_ecd_w				||
						sep_w || cd_scp_w				||
						sep_w || 'N'					||
						sep_w || ie_consolida_multi_empresa_w 		||
						sep_w || ind_centralizada_w	 		||
						sep_w || ind_mudanc_pc_w	 		||
						sep_w || cod_plan_ref_w		 		||
						sep_w, 1, 8000);						
	end if;

	ds_arquivo_w		:= substr(ds_linha_w,1,4000);
	ds_compl_arquivo_w	:= substr(ds_linha_w,4001,4000);
	nr_seq_registro_w	:= nr_seq_registro_w + 1;
	nr_linha_w		:= nr_linha_w + 1;

	insert into ctb_sped_registro(nr_sequencia,
		ds_arquivo,
		dt_atualizacao,
		nm_usuario,
		dt_atualizacao_nrec,
		nm_usuario_nrec,
		nr_seq_controle_sped,
		ds_arquivo_compl,
		cd_registro,
		nr_linha)
	values (nr_seq_registro_w,
		ds_arquivo_w,
		clock_timestamp(),
		nm_usuario_p,
		clock_timestamp(),
		nm_usuario_p,
		nr_seq_controle_p,
		ds_compl_arquivo_w,
		'0000',
		nr_linha_w);


	end;
end loop;
close c_establecimento;

commit;

qt_linha_p	:= nr_linha_w;
nr_sequencia_p	:= nr_seq_registro_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ctb_gerar_interf_0000_ecd ( nr_seq_controle_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint, dt_inicio_p timestamp, dt_fim_p timestamp, cd_empresa_p bigint, qt_linha_p INOUT bigint, nr_sequencia_p INOUT bigint) FROM PUBLIC;

