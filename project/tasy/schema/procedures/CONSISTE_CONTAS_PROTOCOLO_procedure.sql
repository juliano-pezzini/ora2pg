-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE consiste_contas_protocolo (nr_seq_protocolo_p bigint) AS $body$
DECLARE

nr_interno_conta_w			bigint;
nr_atendimento_w				bigint;
ds_erro_w					varchar(255) 		:= '';
ie_tipo_convenio_w			smallint		:= 0;
ie_fecha_atendimento_w			varchar(1)		:= '';
ie_fecha_conta_w				varchar(1)		:= '';
qt_processo_pendente_w			bigint	:= 0;

C01 CURSOR FOR
       SELECT nr_interno_conta, nr_atendimento
       from   conta_paciente
       where  nr_seq_protocolo = nr_seq_protocolo_p;


BEGIN
OPEN C01;
LOOP
	FETCH C01 into nr_interno_conta_w, nr_atendimento_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin
		select	b.ie_tipo_convenio
		into STRICT		ie_tipo_convenio_w
		from		conta_paciente a,
				convenio b
		where		a.cd_convenio_parametro	= b.cd_convenio
		and 		a.nr_interno_conta 	= nr_interno_conta_w;
		exception
				when others then
		     			ie_tipo_convenio_w := 0;
		end;

		SELECT * FROM Consiste_Conta_Paciente(nr_interno_conta_w, nr_atendimento_w, ie_fecha_atendimento_w, ie_fecha_conta_w, qt_processo_pendente_w, ds_erro_w) INTO STRICT ie_fecha_atendimento_w, ie_fecha_conta_w, qt_processo_pendente_w, ds_erro_w;

		update conta_paciente
		set ds_inconsistencia = ds_erro_w
		where nr_interno_conta = nr_interno_conta_w;
END LOOP;
commit;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE consiste_contas_protocolo (nr_seq_protocolo_p bigint) FROM PUBLIC;

