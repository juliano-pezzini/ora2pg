-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE atualiza_status_dados_ura (NR_SEQUENCIA_P bigint, IE_STATUS_P text, NM_USUARIO_P text) AS $body$
DECLARE

  NR_SEQUENCIA_W AGEINT_DADOS_URA.NR_SEQUENCIA%TYPE;
  IE_STATUS_W    AGEINT_DADOS_URA.IE_STATUS%TYPE;

BEGIN
  IF (IE_STATUS_P = 'E') THEN
     SELECT coalesce(MAX(ADU.NR_SEQUENCIA), 0)
       INTO STRICT NR_SEQUENCIA_W
       FROM AGEINT_DADOS_URA ADU
      WHERE ADU.NR_SEQUENCIA <> NR_SEQUENCIA_P
        AND ADU.ID_OPERADOR = NM_USUARIO_P
        AND ADU.IE_STATUS = IE_STATUS_P;

     IF (NR_SEQUENCIA_W > 0) THEN
        CALL WHEB_MENSAGEM_PCK.EXIBIR_MENSAGEM_ABORT(1097775);
     END IF;
  ELSIF (IE_STATUS_P = 'F') THEN
     BEGIN
       SELECT ADU.IE_STATUS
         INTO STRICT IE_STATUS_W
         FROM AGEINT_DADOS_URA ADU
        WHERE ADU.NR_SEQUENCIA = NR_SEQUENCIA_P;

       IF (IE_STATUS_W <> 'E') THEN
          CALL WHEB_MENSAGEM_PCK.EXIBIR_MENSAGEM_ABORT(1097776);
       END IF;
     EXCEPTION
       WHEN no_data_found THEN
            NULL;
     END;
  END IF;

  UPDATE AGEINT_DADOS_URA ADU
     SET ADU.IE_STATUS = IE_STATUS_P,
         ADU.DT_ATUALIZACAO = clock_timestamp(),
         ADU.NM_USUARIO = NM_USUARIO_P
   WHERE ADU.NR_SEQUENCIA = NR_SEQUENCIA_P;

  COMMIT;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE atualiza_status_dados_ura (NR_SEQUENCIA_P bigint, IE_STATUS_P text, NM_USUARIO_P text) FROM PUBLIC;

