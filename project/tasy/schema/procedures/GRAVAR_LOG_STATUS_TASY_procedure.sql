-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gravar_log_status_tasy (ie_status_aplicacao_p text,cd_aplicacao_tasy_p text) AS $body$
DECLARE


/*chamada pela TRIGGER APLICACAO_TASY_ATUAL*/

nr_sequencia_w 		bigint;
nm_maquina_w		varchar(60);
nm_programa_w		varchar(60);


BEGIN

select	substr(coalesce(max(machine), obter_desc_expressao(488309)/*'Desconhecido'*/
),1,60),
	substr(coalesce(max(program),obter_desc_expressao(488309)/*'Desconhecido'*/
),1,60)
into STRICT	nm_maquina_w,
	nm_programa_w
from	v$session
where	audsid = (SELECT userenv('sessionid') );

if (ie_status_aplicacao_p = 'A' ) then

	select 	max(nr_sequencia)
	into STRICT	nr_sequencia_w
	from	log_status_tasy
	where	coalesce(dt_ativacao::text, '') = '';

	update	log_status_tasy
	set		dt_ativacao 		= clock_timestamp(),
			nm_programa_ativou  = nm_programa_w,
			nm_maquina_ativou	= nm_maquina_w
	where	nr_sequencia = nr_sequencia_w;

else

	insert 	into log_status_tasy(
		nr_sequencia,
		dt_ativacao,
		dt_inativacao,
		nm_programa_inativou,
		nm_programa_ativou,
		nm_maquina_inativou,
		nm_maquina_ativou,
		cd_aplicacao_tasy,
		nm_usuario,
		dt_atualizacao
	) values (
		nextval('log_status_tasy_seq'),
		null,
		clock_timestamp(),
		nm_programa_w,
		null,
		nm_maquina_w,
		null,
		cd_aplicacao_tasy_p,
		'Tasy',
		clock_timestamp()
	);

end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gravar_log_status_tasy (ie_status_aplicacao_p text,cd_aplicacao_tasy_p text) FROM PUBLIC;

