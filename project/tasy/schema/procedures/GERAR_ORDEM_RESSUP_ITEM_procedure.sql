-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_ordem_ressup_item ( nr_ordem_compra_p bigint, qt_comprar_p bigint, cd_material_p bigint, nm_usuario_p text) AS $body$
DECLARE


nr_item_oci_w				integer;
cd_unidade_medida_compra_w		varchar(30);
vl_unitario_material_w			double precision;
cd_pessoa_solicitante_w			varchar(10);
vl_item_liquido_w				double precision;
cd_estabelecimento_w			smallint;
dt_entrega_w				timestamp;


BEGIN
select	cd_estabelecimento,
	dt_entrega
into STRICT	cd_estabelecimento_w,
	dt_entrega_w
from	ordem_compra
where	nr_ordem_compra = nr_ordem_compra_p;

select	coalesce(max(nr_item_oci),0) + 1
into STRICT	nr_item_oci_w
from	ordem_compra_item
where	nr_ordem_compra = nr_ordem_compra_p;

select	substr(obter_dados_material_estab(cd_material,cd_estabelecimento_w,'UMC'),1,30) cd_unidade_medida_compra
into STRICT	cd_unidade_medida_compra_w
from	material
where	cd_material = cd_material_p;

select	obter_dados_ult_compra_data(cd_estabelecimento_w,cd_material_p, null, clock_timestamp(),0,'VU')
into STRICT	vl_unitario_material_w
;

vl_item_liquido_w	:= vl_unitario_material_w * qt_comprar_p;

begin
select	coalesce(max(cd_pessoa_fisica),'0')
into STRICT	cd_pessoa_solicitante_w
from	usuario
where	nm_usuario = nm_usuario_p;
if (cd_pessoa_solicitante_w = '0') then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(266018,'NM_USUARIO=' || nm_usuario_p);
	--'Pessoa física não informada no cadastro do usuario ' || nm_usuario_p
end if;
end;

insert into ordem_compra_item(
	nr_ordem_compra,
	nr_item_oci,
	cd_material,
	cd_unidade_medida_compra,
	vl_unitario_material,
	qt_material,
	qt_original,
	dt_atualizacao,
	nm_usuario,
	ie_situacao,
	cd_pessoa_solicitante,
	vl_item_liquido,
	ie_geracao_solic,
	vl_total_item)
values (nr_ordem_compra_p,
	nr_item_oci_w,
	cd_material_p,
	cd_unidade_medida_compra_w,
	vl_unitario_material_w,
	qt_comprar_p,
	qt_comprar_p,
	clock_timestamp(),
	nm_usuario_p,
	'A',
	cd_pessoa_solicitante_w,
	vl_item_liquido_w,
	'U',
	round((qt_comprar_p * vl_unitario_material_w)::numeric,4));

insert into ordem_compra_item_entrega(
	nr_sequencia,
	nr_ordem_compra,
	nr_item_oci,
	dt_prevista_entrega,
	dt_real_entrega,
	dt_entrega_original,
	dt_entrega_limite,
	qt_prevista_entrega,
	qt_real_entrega,
	dt_atualizacao,
	nm_usuario,
	ds_observacao)
values (	nextval('ordem_compra_item_entrega_seq'),
	nr_ordem_compra_p,
	nr_item_oci_w,
	dt_entrega_w,
	null,
	dt_entrega_w,
	dt_entrega_w,
	qt_comprar_p,
	null,
	clock_timestamp(),
	nm_usuario_p,
	null);

commit;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_ordem_ressup_item ( nr_ordem_compra_p bigint, qt_comprar_p bigint, cd_material_p bigint, nm_usuario_p text) FROM PUBLIC;

