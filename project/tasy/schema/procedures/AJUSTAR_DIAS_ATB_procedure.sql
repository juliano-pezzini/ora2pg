-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE ajustar_dias_atb ( nr_atendimento_p bigint, nr_prescricao_p bigint, nm_usuario_p text) AS $body$
DECLARE

 
nr_dia_util_ww			bigint;
ie_dias_util_medic_w		varchar(1);
ds_erro_w			varchar(4000);
ds_usuario_w			varchar(4000);
ds_perfil_w			varchar(4000);
ds_proced_glosa_w		varchar(4000);
nr_sequencia_w			bigint;
cd_material_w			bigint;
qt_total_dias_lib_ww		bigint;
dt_prescricao_w			timestamp;

c01 CURSOR FOR 
SELECT	b.ie_dias_util_medic, 
	a.nr_sequencia, 
	a.cd_material 
From	Material b, 
	Prescr_Material a 
where	a.nr_prescricao 	= nr_prescricao_p 
and	coalesce(a.ie_suspenso,'N') 	<> 'S' 
--and	nvl(a.qt_total_dias_lib,0) > 0 
and	a.NR_DIA_UTIL		> 0 
and	b.ie_controle_medico	<> 0 
and	b.ie_situacao		= 'A' 
and	a.ie_agrupador		= 1;


BEGIN 
 
select	max(dt_prescricao) 
into STRICT	dt_prescricao_w 
from	prescr_medica 
where	nr_prescricao	= nr_prescricao_p;
 
open C01;
loop 
fetch C01 into	 
	ie_dias_util_medic_w, 
	nr_sequencia_w, 
	cd_material_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
 
	if (ie_dias_util_medic_w <> 'N')then 
 
		select max(a.qt_total_dias_lib) 
		into STRICT	qt_total_dias_lib_ww 
		from  prescr_material a, 
			prescr_medica b 
		where  a.nr_prescricao     = b.nr_prescricao 
		and   trunc(b.dt_prescricao)  = trunc(dt_prescricao_w - 1) 
		and   b.nr_atendimento	 = nr_atendimento_p 
		and   a.cd_material		 = cd_material_w 
		and   b.nr_prescricao     <> nr_prescricao_p 
		and	a.qt_total_dias_lib	> a.nr_dia_util 
		and   coalesce(b.dt_suspensao::text, '') = '' 
		and   coalesce(a.dt_suspensao::text, '') = '';
		 
		update	prescr_material 
		set	qt_total_dias_lib	= qt_total_dias_lib_ww 
		where	nr_prescricao	= nr_prescricao_p 
		and	coalesce(qt_total_dias_lib,0) = 0 
		and	nr_sequencia	= nr_sequencia_w;
 
		select coalesce(max(a.nr_dia_util),coalesce(nr_dia_util_ww,0)) + 1 
		into STRICT	nr_dia_util_ww 
		from  prescr_material a, 
			prescr_medica b 
		where  a.nr_prescricao     = b.nr_prescricao 
		and   trunc(b.dt_prescricao)  = trunc(dt_prescricao_w - 1) 
		and   b.nr_atendimento	 = nr_atendimento_p 
		and   a.cd_material		 = cd_material_w 
		and   b.nr_prescricao     <> nr_prescricao_p 
		and   coalesce(b.dt_suspensao::text, '') = '' 
		and   coalesce(a.dt_suspensao::text, '') = '';
		 
		update	prescr_material 
		set	nr_dia_util	= nr_dia_util_ww, 
			ie_novo_ciclo_ccih = 'N' 
		where	nr_prescricao	= nr_prescricao_p 
		and	nr_dia_util_ww	<= qt_total_dias_lib_ww 
		and	nr_sequencia	= nr_sequencia_w;
	end if;
 
	commit;
 
end loop;
close C01;
 
consistir_prescricao(nr_prescricao_p, obter_perfil_ativo, nm_usuario_p, ds_erro_w, ds_usuario_w, ds_perfil_w, ds_proced_glosa_w);
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ajustar_dias_atb ( nr_atendimento_p bigint, nr_prescricao_p bigint, nm_usuario_p text) FROM PUBLIC;

