-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE far_obter_valor_promocao ( cd_material_p bigint, vl_preco_p bigint, cd_estabelecimento_p bigint, vl_preco_tabela_w INOUT bigint, vl_preco_fixo_w INOUT bigint, vl_desconto_w INOUT bigint) AS $body$
DECLARE


cd_grupo_material_w		smallint;
cd_subgrupo_material_w		smallint;
cd_classe_material_w 		integer;
qt_existe_w                                             integer;
ie_tipo_regra_w			varchar(15);
cd_tab_preco_mat_w		bigint;
nr_seq_promocao_w	               bigint;
qt_item_tabela_w	                               bigint;
vl_fixo_w			               double precision;


BEGIN

select 	cd_grupo_material,
	cd_subgrupo_material,
	cd_classe_material
into STRICT	cd_grupo_material_w,
	cd_subgrupo_material_w,
	cd_classe_material_w
from 	estrutura_material_v
where	cd_material = cd_material_p;

select	count(*)
into STRICT	qt_existe_w
from	far_regra_promocao a
where (clock_timestamp() between dt_inicio_vigencia and dt_final_vigencia)
and	coalesce(a.cd_subgrupo_material,cd_subgrupo_material_w)  = cd_subgrupo_material_w
and	coalesce(a.cd_classe_material,cd_classe_material_w) 	        = cd_classe_material_w
and	coalesce(a.cd_material,cd_material_p) 		        = cd_material_p
and	cd_estabelecimento				        = cd_estabelecimento_p;

if (qt_existe_w > 0) then

	select	nr_sequencia,
			ie_tipo_regra,
			cd_tab_preco_mat,
			vl_fixo
	into STRICT	nr_seq_promocao_w,
			ie_tipo_regra_w,
			cd_tab_preco_mat_w,
			vl_fixo_w
	from	far_regra_promocao a
	where (clock_timestamp() between dt_inicio_vigencia and dt_final_vigencia)
	and	coalesce(a.cd_subgrupo_material,cd_subgrupo_material_w)	= cd_subgrupo_material_w
	and	coalesce(a.cd_classe_material,cd_classe_material_w) 	                = cd_classe_material_w
	and	coalesce(a.cd_material,cd_material_p) 			= cd_material_p
	and	cd_estabelecimento				                = cd_estabelecimento_p;

	if (ie_tipo_regra_w = 'T') then

		select	count(*)
		into STRICT	qt_item_tabela_w
		from	preco_material a
		where	a.cd_tab_preco_mat = cd_tab_preco_mat_w
		and		a.cd_material      = cd_material_p
		and		a.ie_situacao = 'A'
		and		a.dt_inicio_vigencia =	( SELECT	max(dt_inicio_vigencia)
							from	preco_material x
							where	x.cd_tab_preco_mat = a.cd_tab_preco_mat
							and		x.cd_material = a.cd_material
							and		x.ie_situacao = 'A'
							and		dt_inicio_vigencia < clock_timestamp() );

		if (qt_item_tabela_w > 0) then

			select	max(a.vl_preco_venda)
			into STRICT	vl_preco_tabela_w
			from	preco_material a
			where	a.cd_tab_preco_mat = cd_tab_preco_mat_w
			and		a.cd_material      = cd_material_p
			and		a.ie_situacao = 'A'
			and		a.dt_inicio_vigencia =	( SELECT	max(dt_inicio_vigencia)
								from	preco_material x
								where	x.cd_tab_preco_mat = a.cd_tab_preco_mat
								and		x.cd_material = a.cd_material
								and		x.ie_situacao = 'A'
								and		dt_inicio_vigencia < clock_timestamp() );
		end if;

	elsif (ie_tipo_regra_w = 'D') then

			vl_desconto_w:= vl_fixo_w;

	elsif (ie_tipo_regra_w = 'F') then

			vl_preco_fixo_w:= vl_fixo_w;

	end if;

end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE far_obter_valor_promocao ( cd_material_p bigint, vl_preco_p bigint, cd_estabelecimento_p bigint, vl_preco_tabela_w INOUT bigint, vl_preco_fixo_w INOUT bigint, vl_desconto_w INOUT bigint) FROM PUBLIC;

