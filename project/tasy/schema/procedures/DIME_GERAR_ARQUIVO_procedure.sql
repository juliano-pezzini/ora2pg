-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE dime_gerar_arquivo ( nr_seq_controle_p bigint, cd_estabelecimento_p text, nm_usuario_p text) AS $body$
DECLARE

 
cd_registro_w		varchar(2);
dt_referencia_w		timestamp;
ds_separador_w		varchar(1);
nr_sequencia_w		bigint;
qt_linha_w		bigint := 0;
qt_registro_w		bigint := 0;
nr_seq_regra_dime_w	fis_dime_controle.nr_seq_regra_dime%type;

 
c01 CURSOR FOR 
SELECT	f.cd_registro 
from	fis_regra_dime_reg f, 
	valor_dominio v 
where	f.cd_registro = v.vl_dominio 
and	v.cd_dominio = 4650 
and	nr_seq_regra_dime = nr_seq_regra_dime_w 
and	f.ie_gerar = 'S' 
order by v.nr_seq_apresent;

 

BEGIN 
 
delete	from w_dime_arquivo	where nm_usuario = nm_usuario_p;
commit;
 
ds_separador_w := '';
 
select	dt_referencia 
into STRICT	dt_referencia_w 
from	fis_dime_controle 
where	nr_sequencia = nr_seq_controle_p;
 
select	nr_seq_regra_dime 
into STRICT	nr_seq_regra_dime_w 
from	fis_dime_controle 
where	nr_sequencia = nr_seq_controle_p;
 
open c01;
loop 
fetch c01 into 
	cd_registro_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	begin 
 
	if (cd_registro_w = '20') then 
		SELECT * FROM dime_reg_contador(nr_seq_controle_p, cd_estabelecimento_p, nm_usuario_p, dt_referencia_w, ds_separador_w, qt_linha_w, nr_sequencia_w) INTO STRICT qt_linha_w, nr_sequencia_w;
 
	elsif (cd_registro_w = '98') then 
		SELECT * FROM dime_reg_encerramento(nr_seq_controle_p, cd_estabelecimento_p, nm_usuario_p, dt_referencia_w, ds_separador_w, qt_linha_w, nr_sequencia_w) INTO STRICT qt_linha_w, nr_sequencia_w;
 
	elsif (cd_registro_w = '99') then 
		SELECT * FROM dime_fim_declaracao(nr_seq_controle_p, cd_estabelecimento_p, nm_usuario_p, dt_referencia_w, ds_separador_w, qt_linha_w, nr_sequencia_w) INTO STRICT qt_linha_w, nr_sequencia_w;
 
	end if;
 
	end;
end loop;
close c01;
 
begin 
 
select	1 
into STRICT	qt_registro_w 
from	w_dime_arquivo 
where	nm_usuario = nm_usuario_p  LIMIT 1;
 
exception 
when others then 
	qt_registro_w := 0;
end;
 
if (qt_registro_w = 1) then 
	begin	 
	update	fis_dime_controle 
	set	dt_geracao = clock_timestamp(), 
		dt_atualizacao = clock_timestamp(), 
		nm_usuario = nm_usuario_p 
	where	nr_sequencia = nr_seq_controle_p;
	commit;
	end;
end if;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE dime_gerar_arquivo ( nr_seq_controle_p bigint, cd_estabelecimento_p text, nm_usuario_p text) FROM PUBLIC;

