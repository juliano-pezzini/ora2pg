-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE diops_consistir_dados_cadastro ( nr_seq_periodo_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint) AS $body$
DECLARE


ds_tipo_endereco_w		varchar(50);
ds_logradouro_w			varchar(40);
ds_bairro_w			varchar(40);
ds_complemento_w		varchar(20);
cd_cep_w			varchar(15);
nr_logradouro_w			varchar(10);
cd_pessoa_fisica_w		varchar(10);
cd_municipio_ibge_w		varchar(6);
sg_uf_w				valor_dominio.vl_dominio%type;
nr_seq_operadora_w		bigint;

C01 CURSOR FOR
	SELECT	nr_seq_operadora
	from	w_diops_cad_identif
	where	nr_seq_periodo	= nr_seq_periodo_p;

C02 CURSOR FOR
	SELECT	CASE WHEN ie_tipo_endereco='M' THEN  'Matriz' WHEN ie_tipo_endereco='C' THEN  'Correspondência' END  ds_tipo_endereco,
		ds_logradouro,
		nr_logradouro,
		ds_complemento,
		cd_cep,
		ds_bairro,
		cd_municipio_ibge,
		sg_uf,
		cd_pessoa_fisica
	from	w_diops_cad_endereco
	where	ie_tipo_endereco in ('M', 'C')
	and     nr_seq_periodo	= nr_seq_periodo_p;


BEGIN
open C01;
loop
fetch C01 into
	nr_seq_operadora_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	open C02;
	loop
	fetch C02 into
		ds_tipo_endereco_w,
		ds_logradouro_w,
		nr_logradouro_w,
		ds_complemento_w,
		cd_cep_w,
		ds_bairro_w,
		cd_municipio_ibge_w,
		sg_uf_w,
		cd_pessoa_fisica_w;
	EXIT WHEN NOT FOUND; /* apply on C02 */
		begin
		/* 10 - UF do endereço da operadora não informado */

		if (coalesce(sg_uf_w::text, '') = '') then
			CALL diops_gravar_inconsistencia(	nr_seq_periodo_p,
							10,
							ds_tipo_endereco_w || ' - ' || ds_logradouro_w || ' - ' || nr_logradouro_w,
							cd_pessoa_fisica_w,
							nm_usuario_p,
							cd_estabelecimento_p);
		end if;

		/* 12 - Logradouro do endereço da operadora não informado */

		if (coalesce(ds_logradouro_w::text, '') = '') then
			CALL diops_gravar_inconsistencia(	nr_seq_periodo_p,
							12,
							ds_tipo_endereco_w || ' - ' || ds_logradouro_w || ' - ' || nr_logradouro_w,
							cd_pessoa_fisica_w,
							nm_usuario_p,
							cd_estabelecimento_p);
		end if;

		/* 13 - Número logradouro do endereço da operadora não informado */

		if (coalesce(nr_logradouro_w::text, '') = '') then
			CALL diops_gravar_inconsistencia(	nr_seq_periodo_p,
							13,
							ds_tipo_endereco_w || ' - ' || ds_logradouro_w || ' - ' || nr_logradouro_w,
							cd_pessoa_fisica_w,
							nm_usuario_p,
							cd_estabelecimento_p);
		end if;

		/* 14 - Complemento do endereço da operadora não informado */

		if (coalesce(ds_complemento_w::text, '') = '') then
			CALL diops_gravar_inconsistencia(	nr_seq_periodo_p,
							14,
							ds_tipo_endereco_w || ' - ' || ds_logradouro_w || ' - ' || nr_logradouro_w,
							cd_pessoa_fisica_w,
							nm_usuario_p,
							cd_estabelecimento_p);
		end if;

		/* 15 - Bairro do endereço da operadora não informado */

		if (coalesce(ds_bairro_w::text, '') = '') then
			CALL diops_gravar_inconsistencia(	nr_seq_periodo_p,
							15,
							ds_tipo_endereco_w || ' - ' || ds_logradouro_w || ' - ' || nr_logradouro_w,
							cd_pessoa_fisica_w,
							nm_usuario_p,
							cd_estabelecimento_p);
		end if;

		/* 16 - Município IBGE do endereço da operadora não informado */

		if (coalesce(cd_municipio_ibge_w::text, '') = '') then
			CALL diops_gravar_inconsistencia(	nr_seq_periodo_p,
							16,
							ds_tipo_endereco_w || ' - ' || ds_logradouro_w || ' - ' || nr_logradouro_w,
							null,
							nm_usuario_p,
							cd_estabelecimento_p);
		end if;

		/* 17 - CEP do endereço da operadora não informado */

		if (coalesce(cd_cep_w::text, '') = '') then
			CALL diops_gravar_inconsistencia(	nr_seq_periodo_p,
							17,
							ds_tipo_endereco_w || ' - ' || ds_logradouro_w || ' - ' || nr_logradouro_w,
							cd_pessoa_fisica_w,
							nm_usuario_p,
							cd_estabelecimento_p);
		end if;
		end;
	end loop;
	close C02;
	end;
end loop;
close C01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE diops_consistir_dados_cadastro ( nr_seq_periodo_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint) FROM PUBLIC;

