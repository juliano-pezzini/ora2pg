-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE obter_tempo_padrao_agenda (nr_seq_proc_interno_p bigint, cd_procedimento_p bigint, ie_origem_proced_p bigint, cd_medico_p text, cd_agenda_p bigint, cd_pessoa_fisica_p text, nr_seq_agenda_p bigint default null, ie_dia_semana_p bigint default null, qt_minuto_p INOUT bigint DEFAULT NULL) AS $body$
DECLARE

 
qt_minuto_w	bigint	:= 0;
qt_anos_w	integer;
cd_estab_agenda_w	smallint;

dt_agenda_w		timestamp;
ie_dia_semana_w		smallint;

c01 CURSOR FOR 
	SELECT	qt_minuto 
	from	tempo_procedimento 
	where	coalesce(nr_seq_proc_interno, coalesce(nr_seq_proc_interno_p, 0))	= coalesce(nr_seq_proc_interno_p, 0) 
	and	coalesce(cd_procedimento, cd_procedimento_p)			= cd_procedimento_p 
	and	coalesce(ie_origem_proced, ie_origem_proced_p)		= ie_origem_proced_p 
	and	coalesce(cd_pessoa_fisica, coalesce(cd_medico_p, '0'))		= coalesce(cd_medico_p, '0') 
	and	coalesce(cd_agenda, cd_agenda_p)				= cd_agenda_p 
	and	qt_anos_w between coalesce(qt_idade_minima,0) and coalesce(qt_idade_maxima,999) 
	and	((cd_estabelecimento 	= cd_estab_agenda_w) or (coalesce(cd_estabelecimento::text, '') = '')) 
	and	((ie_dia_semana = ie_dia_semana_w) or ((ie_dia_semana = 9) and (ie_dia_semana_w not in (1,7))) or (coalesce(ie_dia_semana::text, '') = ''));


BEGIN 
 
if (nr_seq_agenda_p IS NOT NULL AND nr_seq_agenda_p::text <> '') and (coalesce(ie_dia_semana_p::text, '') = '') then 
 
	select	max(hr_inicio) 
	into STRICT	dt_agenda_w 
	from	agenda_paciente 
	where	nr_sequencia = nr_seq_agenda_p;
	 
	if (dt_agenda_w IS NOT NULL AND dt_agenda_w::text <> '') then 
		ie_dia_semana_w	:= obter_cod_dia_semana(dt_agenda_w);
	else 
		ie_dia_semana_w	:= null;
	end if;
	 
else 
 
	ie_dia_semana_w	:= ie_dia_semana_p;
	 
end if;
 
begin 
select	(obter_idade(dt_nascimento, clock_timestamp(), 'A'))::numeric  
into STRICT	qt_anos_w 
from	pessoa_fisica 
where	cd_pessoa_fisica = cd_pessoa_fisica_p;
exception 
when others then 
	qt_anos_w := 0;
end;
 
select	max(cd_estabelecimento) 
into STRICT	cd_estab_agenda_w 
from	agenda 
where	cd_agenda = cd_agenda_p;
 
Open 	c01;
loop 
fetch	c01 into qt_minuto_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
		begin 
 
		qt_minuto_w	:= qt_minuto_w;
 
		end;
end loop;
close c01;
 
qt_minuto_p	:= qt_minuto_w;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE obter_tempo_padrao_agenda (nr_seq_proc_interno_p bigint, cd_procedimento_p bigint, ie_origem_proced_p bigint, cd_medico_p text, cd_agenda_p bigint, cd_pessoa_fisica_p text, nr_seq_agenda_p bigint default null, ie_dia_semana_p bigint default null, qt_minuto_p INOUT bigint DEFAULT NULL) FROM PUBLIC;

