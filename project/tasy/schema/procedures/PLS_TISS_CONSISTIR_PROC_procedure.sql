-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_tiss_consistir_proc ( nr_sequencia_p bigint, ie_tipo_glosa_p text, ie_evento_p text, nr_seq_prestador_p bigint, nr_seq_ocorrencia_p bigint, ds_parametro_um_p text, nm_usuario_p text, cd_estabelecimento_p bigint, ie_origem_proced_p bigint) AS $body$
DECLARE


/* IE_TIPO_GLOSA_P
	C - Conta
	CP - Conta procedimento
	CM - Conta material
	A - Autorização
	AP - Autorização procedimento
	AM - Autorização material
*/
qt_procedimento_w		double precision := null;
cd_procedimento_w		bigint;
ie_origem_proced_w		integer;
ie_cid_proc_w			varchar(1) := 'S';
nr_seq_conta_w			bigint;
ie_tipo_guia_w			varchar(2);
cd_guia_w			varchar(20);


BEGIN

if (ie_tipo_glosa_p	= 'CP') then
	begin
		select	coalesce(qt_procedimento_imp,0),
			coalesce(cd_procedimento,cd_procedimento_imp),
			coalesce(ie_origem_proced,ie_origem_proced_p),
			nr_seq_conta
		into STRICT	qt_procedimento_w,
			cd_procedimento_w,
			ie_origem_proced_w,
			nr_seq_conta_w
		from	pls_conta_proc
		where	nr_sequencia = nr_sequencia_p;
	exception
	when others then
		qt_procedimento_w := 0;
	end;

	begin
		select	ie_tipo_guia,
			coalesce(cd_guia_referencia,cd_guia)
		into STRICT	ie_tipo_guia_w,
			cd_guia_w
		from	pls_conta
		where	nr_sequencia = nr_seq_conta_w;
	exception
	when others then
		ie_tipo_guia_w := null;
	end;

	if (ie_tipo_guia_w = '6') and (cd_guia_w IS NOT NULL AND cd_guia_w::text <> '') then
		select  max(nr_sequencia)
		into STRICT    nr_seq_conta_w
		from    pls_conta
		where   ie_tipo_guia = '5'
		and     ((cd_guia_referencia = cd_guia_w) or (cd_guia = cd_guia_w and coalesce(cd_guia_referencia::text, '') = ''));
	end if;

	ie_cid_proc_w	:= pls_obter_se_cid_procedimento(nr_seq_conta_w,cd_procedimento_w,ie_origem_proced_w);

elsif (ie_tipo_glosa_p	= 'AP') then
	begin
		select	qt_solicitada
		into STRICT	qt_procedimento_w
		from	pls_guia_plano_proc
		where	nr_sequencia = nr_sequencia_p;
	exception
	when others then
		qt_procedimento_w := 0;
	end;
end if;

/* 1806 - Quantidade de procedimento deve ser maior que zero*/

if (qt_procedimento_w <= 0) then /*Diego OS - 331185 - Deve considerar quantidade negativas.*/
	CALL pls_gravar_glosa_tiss('1806',
		null, ie_evento_p,
		nr_sequencia_p, ie_tipo_glosa_p, nr_seq_prestador_p,
		nr_seq_ocorrencia_p, '', nm_usuario_p,
		cd_estabelecimento_p, nr_seq_conta_w);
end if;

/* 1808 - Procedimento não conforme com CID*/

if (ie_cid_proc_w = 'N') then
	CALL pls_gravar_glosa_tiss('1808',
		null, ie_evento_p,
		nr_sequencia_p, ie_tipo_glosa_p, nr_seq_prestador_p,
		nr_seq_ocorrencia_p, '', nm_usuario_p,
		cd_estabelecimento_p, nr_seq_conta_w);
end if;
/*
commit;
*/
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_tiss_consistir_proc ( nr_sequencia_p bigint, ie_tipo_glosa_p text, ie_evento_p text, nr_seq_prestador_p bigint, nr_seq_ocorrencia_p bigint, ds_parametro_um_p text, nm_usuario_p text, cd_estabelecimento_p bigint, ie_origem_proced_p bigint) FROM PUBLIC;

