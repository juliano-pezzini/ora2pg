-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE qua_atualiza_status_nc ( nr_seq_nao_conform_p bigint, ie_status_p text, nm_usuario_p text) AS $body$
DECLARE

	 
nm_user_w			varchar(50);
	

BEGIN 
 
if (nr_seq_nao_conform_p IS NOT NULL AND nr_seq_nao_conform_p::text <> '') then 
 
	update	qua_nao_conformidade 
	set	ie_status = ie_status_p, 
		nm_usuario = nm_usuario_p, 
		dt_atualizacao = clock_timestamp() 
	where	nr_sequencia = nr_seq_nao_conform_p;
	 
-- Código abaixo alterado temporáriamente para monitoramento dentro da Philips	 
	if (nr_seq_nao_conform_p IS NOT NULL AND nr_seq_nao_conform_p::text <> '') then 
	begin 
		CALL qua_gerar_envio_comunicacao(nr_seq_nao_conform_p,'0',wheb_usuario_pck.get_nm_usuario,'39',wheb_usuario_pck.get_cd_estabelecimento,0,0,'N');
		exception 
		when others then 
		begin 
			select	username 
			into STRICT	nm_user_w 
			from	user_users;
			 
			if (nm_user_w = 'CORP') then 
				INSERT INTO comunic_interna(dt_comunicado, ds_titulo, ds_comunicado, nm_usuario, dt_atualizacao, ie_geral, nm_usuario_destino, nr_sequencia, ie_gerencial, nr_seq_classif, dt_liberacao, ds_setor_adicional, ds_grupo, ds_perfil_adicional, cd_estab_destino) 
				VALUES (clock_timestamp(), 'Monitoramento alteração status NC', nr_seq_nao_conform_p || ie_status_p, 'CRMULLER', clock_timestamp(), 'N', 'CRMULLER', nextval('comunic_interna_seq'), 'N', NULL, clock_timestamp(), '', '', '', '');				
			end if;	
		exception 
					when others then 
						nm_user_w := '';	
		end;
	end;	
	end if;	
				 
	 
	commit;	
end if;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE qua_atualiza_status_nc ( nr_seq_nao_conform_p bigint, ie_status_p text, nm_usuario_p text) FROM PUBLIC;

