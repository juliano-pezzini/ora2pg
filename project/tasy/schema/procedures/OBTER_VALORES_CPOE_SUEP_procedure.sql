-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE obter_valores_cpoe_suep ( nr_atendimento_p text, qt_total_p INOUT bigint, qt_nutricao_p INOUT bigint, qt_medicamentos_p INOUT bigint, qt_procedimentos_p INOUT bigint, qt_gaso_p INOUT bigint, qt_recomendacao_p INOUT bigint, qt_hemoterapia_p INOUT bigint, qt_dialise_p INOUT bigint, qt_intervencoes_p INOUT bigint, qt_materiais_p INOUT bigint, qt_proc_anatomo_p INOUT bigint, nr_seq_item_p bigint default null) AS $body$
BEGIN

select	count(*)
into STRICT	qt_nutricao_p
from	prescr_medica a,
		prescr_dieta b,
		cpoe_dieta c
where	a.nr_prescricao = b.nr_prescricao
and		b.nr_seq_dieta_cpoe = c.nr_sequencia
and		a.nr_atendimento 	= coalesce(nr_atendimento_p,0)
and		coalesce(a.dt_suspensao::text, '') = ''
and		coalesce(c.DT_LIB_SUSPENSAO::text, '') = ''
and		coalesce(c.DT_SUSPENSAO::text, '') = ''
and		clock_timestamp() between a.dt_inicio_prescr and coalesce(a.dt_validade_prescr,clock_timestamp() + interval '1 days');

select	count(*)
into STRICT	qt_medicamentos_p
from	prescr_medica a,
		prescr_material b,
		cpoe_material c left join informacao_suep s on nr_seq_item = nr_seq_item_p
where	a.nr_prescricao 	= b.nr_prescricao
and		b.nr_seq_mat_cpoe 	= c.nr_sequencia
and		a.nr_atendimento 	= coalesce(nr_atendimento_p,0)
and		coalesce(ie_material,'N') = 'N'
and		b.ie_agrupador in (1,4)
and		coalesce(a.dt_suspensao::text, '') = ''
and		coalesce(c.DT_LIB_SUSPENSAO::text, '') = ''
and		coalesce(c.DT_SUSPENSAO::text, '') = ''
and (c.cd_material = s.cd_material or coalesce(s.cd_material::text, '') = '')
and (obter_familia_material(c.cd_material) = s.nr_seq_familia or coalesce(s.nr_seq_familia::text, '') = '')
and (obter_dados_material(c.cd_material, 'CGRU') = s.cd_grupo_material or coalesce(s.cd_grupo_material::text, '') = '')
and (obter_dados_material(c.cd_material, 'CSUB') = s.cd_subgrupo_material or coalesce(s.cd_subgrupo_material::text, '') = '')
and		clock_timestamp() between a.dt_inicio_prescr and coalesce(a.dt_validade_prescr,clock_timestamp() + interval '1 days');

select	count(*)
into STRICT	qt_procedimentos_p
from	prescr_medica a,
		prescr_procedimento b,
		cpoe_procedimento c
where	a.nr_prescricao 	= b.nr_prescricao
and		b.nr_seq_proc_cpoe 	= c.nr_sequencia
and		coalesce(a.dt_suspensao::text, '') = ''
and		coalesce(c.dt_lib_suspensao::text, '') = ''
and		coalesce(c.dt_suspensao::text, '') = ''
and		a.nr_atendimento 	= coalesce(nr_atendimento_p,0)
and		clock_timestamp() between a.dt_inicio_prescr and coalesce(a.dt_validade_prescr,clock_timestamp() + interval '1 days');

select	count(*)
into STRICT	qt_gaso_p
from	prescr_medica a,
		prescr_gasoterapia b,
		cpoe_gasoterapia c
where	a.nr_prescricao 	= b.nr_prescricao
and		b.nr_seq_gas_cpoe 	= c.nr_sequencia
and		coalesce(a.dt_suspensao::text, '') = ''
and		coalesce(c.dt_lib_suspensao::text, '') = ''
and		coalesce(c.dt_suspensao::text, '') = ''
and		a.nr_atendimento 	= coalesce(nr_atendimento_p,0)
and		clock_timestamp() between a.dt_inicio_prescr and coalesce(a.dt_validade_prescr,clock_timestamp() + interval '1 days');

select	count(*)
into STRICT	qt_recomendacao_p
from	prescr_medica a,
		prescr_recomendacao b,
		cpoe_recomendacao c
where	a.nr_prescricao 	= b.nr_prescricao
and		b.nr_seq_rec_cpoe 	= c.nr_sequencia
and		coalesce(a.dt_suspensao::text, '') = ''
and		coalesce(c.dt_lib_suspensao::text, '') = ''
and		coalesce(c.dt_suspensao::text, '') = ''
and		a.nr_atendimento 	= coalesce(nr_atendimento_p,0)
and		clock_timestamp() between a.dt_inicio_prescr and coalesce(a.dt_validade_prescr,clock_timestamp() + interval '1 days');

select	count(*)
into STRICT	qt_hemoterapia_p
from	prescr_medica a,
		prescr_solic_bco_sangue b,
		cpoe_hemoterapia c
where	a.nr_prescricao 	= b.nr_prescricao
and		b.nr_seq_hemo_cpoe 	= c.nr_sequencia
and		coalesce(a.dt_suspensao::text, '') = ''
and		coalesce(c.dt_lib_suspensao::text, '') = ''
and		coalesce(c.dt_suspensao::text, '') = ''
and		a.nr_atendimento 	= coalesce(nr_atendimento_p,0)
and		clock_timestamp() between a.dt_inicio_prescr and coalesce(a.dt_validade_prescr,clock_timestamp() + interval '1 days');

select	count(*)
into STRICT	qt_dialise_p
from	prescr_medica a,
		hd_prescricao b,
		cpoe_dialise c
where	a.nr_prescricao 	= b.nr_prescricao
and		coalesce(a.dt_suspensao::text, '') = ''
and		coalesce(c.dt_lib_suspensao::text, '') = ''
and		coalesce(c.dt_suspensao::text, '') = ''
and		a.nr_atendimento 	= coalesce(nr_atendimento_p,0)
and		clock_timestamp() between a.dt_inicio_prescr and coalesce(a.dt_validade_prescr,clock_timestamp() + interval '1 days')
and		b.nr_seq_dialise_cpoe = c.nr_sequencia;

select	count(*)
into STRICT	qt_intervencoes_p
FROM cpoe_intervencao c, pe_prescricao a, pe_prescr_proc b
LEFT OUTER JOIN intervalo_prescricao x ON (b.cd_intervalo = x.cd_intervalo)
WHERE a.nr_sequencia 		= b.nr_seq_prescr and b.nr_seq_cpoe_interv = c.nr_sequencia  and coalesce(a.dt_suspensao::text, '') = '' and coalesce(c.dt_lib_suspensao::text, '') = '' and coalesce(c.dt_suspensao::text, '') = '' and a.nr_atendimento 	= coalesce(nr_atendimento_p,0) and clock_timestamp() between a.dt_inicio_prescr and coalesce(a.dt_validade_prescr,clock_timestamp() + interval '1 days');

select	count(*)
into STRICT	qt_materiais_p
from	prescr_medica a,
		prescr_material b,
		cpoe_material c left join informacao_suep s on nr_seq_item = nr_seq_item_p
where	a.nr_prescricao 	= b.nr_prescricao
and		b.nr_seq_mat_cpoe 	= c.nr_sequencia
and		coalesce(a.dt_suspensao::text, '') = ''
and		coalesce(c.dt_lib_suspensao::text, '') = ''
and		coalesce(c.dt_suspensao::text, '') = ''
and (c.cd_material = s.cd_material or coalesce(s.cd_material::text, '') = '')
and (obter_familia_material(c.cd_material) = s.nr_seq_familia or coalesce(s.nr_seq_familia::text, '') = '')
and (obter_dados_material(c.cd_material, 'CGRU') = s.cd_grupo_material or coalesce(s.cd_grupo_material::text, '') = '')
and (obter_dados_material(c.cd_material, 'CSUB') = s.cd_subgrupo_material or coalesce(s.cd_subgrupo_material::text, '') = '')
and		a.nr_atendimento 	= coalesce(nr_atendimento_p,0)
and		ie_material 		= 'S'
and		clock_timestamp() between a.dt_inicio_prescr and coalesce(a.dt_validade_prescr,clock_timestamp() + interval '1 days');

select	count(*)
into STRICT	qt_proc_anatomo_p
from	prescr_medica a,
		prescr_procedimento b,
		cpoe_anatomia_patologica c
where	a.nr_prescricao 	= b.nr_prescricao
and		b.nr_seq_proc_cpoe 	= c.nr_sequencia
and		coalesce(a.dt_suspensao::text, '') = ''
and		coalesce(c.dt_lib_suspensao::text, '') = ''
and		coalesce(c.dt_suspensao::text, '') = ''
and		a.nr_atendimento 	= coalesce(nr_atendimento_p,0)
and		clock_timestamp() between a.dt_inicio_prescr and coalesce(a.dt_validade_prescr,clock_timestamp() + interval '1 days');

qt_total_p := qt_nutricao_p + qt_medicamentos_p + qt_procedimentos_p + qt_gaso_p + qt_recomendacao_p + qt_hemoterapia_p + qt_dialise_p + qt_intervencoes_p + qt_materiais_p + qt_proc_anatomo_p;


commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE obter_valores_cpoe_suep ( nr_atendimento_p text, qt_total_p INOUT bigint, qt_nutricao_p INOUT bigint, qt_medicamentos_p INOUT bigint, qt_procedimentos_p INOUT bigint, qt_gaso_p INOUT bigint, qt_recomendacao_p INOUT bigint, qt_hemoterapia_p INOUT bigint, qt_dialise_p INOUT bigint, qt_intervencoes_p INOUT bigint, qt_materiais_p INOUT bigint, qt_proc_anatomo_p INOUT bigint, nr_seq_item_p bigint default null) FROM PUBLIC;

