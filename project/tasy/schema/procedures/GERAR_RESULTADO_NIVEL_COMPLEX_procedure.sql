-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_resultado_nivel_complex (nr_seq_prescricao bigint) AS $body$
DECLARE

ds_general_care_w varchar(10);
ds_special_care_w varchar(10);
ds_nivel_comp_w	varchar(10);
nm_usuario_log_w	varchar(255);
qtd_s3_w integer;
ie_dominio_w integer;
ie_alemanha_w integer;

  item RECORD;

BEGIN
	ie_alemanha_w := 7;

	SELECT OBTER_USUARIO_ATIVO() INTO STRICT nm_usuario_log_w;

	IF (nm_usuario_log_w IS NOT NULL AND nm_usuario_log_w::text <> '') AND OBTER_NR_SEQ_LOCALE(OBTER_USUARIO_ATIVO()) = ie_alemanha_w THEN
		ds_general_care_w := 'A1';
		ds_special_care_w := 'S1';
		qtd_s3_w := 0;
		ie_dominio_w := 8694;

		FOR item IN (
			SELECT coalesce(ie_nivel_complexidade, 0) AS ie_nivel_complexidade,
				SUM(1) AS qtd
			 FROM pe_procedimento
			WHERE nr_sequencia IN (SELECT nr_seq_proc
									FROM pe_prescr_proc
									WHERE nr_seq_prescr = nr_seq_prescricao)
				AND ie_nivel_complexidade > 0
			GROUP BY ie_nivel_complexidade
			ORDER BY ie_nivel_complexidade DESC
		)
		LOOP
			IF item.ie_nivel_complexidade = 2 AND item.qtd > 1 THEN
				ds_general_care_w := 'A3';
			ELSE
				IF item.ie_nivel_complexidade = 1 AND ds_general_care_w <> 'A3' THEN
					ds_general_care_w := 'A2';
				END IF;
			END IF;

			IF item.ie_nivel_complexidade = 4 AND item.qtd > 0 THEN
				ds_special_care_w := 'S3';
				qtd_s3_w := item.qtd;
			ELSE
				IF item.ie_nivel_complexidade = 3 THEN
					IF item.qtd > 0 THEN
						ds_special_care_w := 'S2';

						IF qtd_s3_w > 0 AND item.qtd < 3 THEN
							ds_special_care_w := 'S3';
						END IF;
					END IF;
				END IF;
			END IF;
		END LOOP;

		ds_nivel_comp_w := ds_general_care_w || '/' || ds_special_care_w;
		UPDATE pe_prescricao SET ds_nivel_complexidade = ds_nivel_comp_w, ie_nivel_compl = OBTER_VALOR_DESCRICAO_DOMINIO(ie_dominio_w, ds_nivel_comp_w) WHERE nr_sequencia = nr_seq_prescricao;
		COMMIT;
	END IF;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_resultado_nivel_complex (nr_seq_prescricao bigint) FROM PUBLIC;

