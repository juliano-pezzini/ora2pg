-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE cpoe_gerar_prot_dieta_jejum ( cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, cd_perfil_p perfil.cd_perfil%type, nm_usuario_p usuario.nm_usuario%type, cd_protocolo_p protocolo_medic_jejum.cd_protocolo%type, nr_seq_protocolo_p protocolo_medic_jejum.nr_sequencia%type, nr_seq_item_p protocolo_medic_jejum.nr_seq_jejum%type, nr_atendimento_p atendimento_paciente.nr_atendimento%type, nr_seq_item_gerado_p INOUT cpoe_dieta.nr_sequencia%type, cd_pessoa_fisica_p pessoa_fisica.cd_pessoa_fisica%type default null, nr_seq_pend_pac_acao_p gqa_pend_pac_acao.nr_sequencia%type default null, ie_item_alta_p text default 'N', ie_prescritor_aux_p text default 'N', cd_medico_p bigint default null, ie_retrogrado_p text default 'N', dt_inicio_p timestamp default null, nr_seq_pepo_p bigint default null, nr_cirurgia_p bigint default null, nr_cirurgia_patologia_p bigint default null, nr_seq_agenda_p bigint default null, nr_seq_transcricao_p bigint default null, nr_seq_conclusao_apae_p bigint default null, ie_forma_geracao_p text default null, dt_fim_presc_p timestamp default null, dt_inicio_presc_p timestamp default null, ie_futuro_p text default 'N', nr_seq_cpoe_rp_p cpoe_rp.nr_sequencia%type default null, nr_seq_cpoe_order_unit_p cpoe_order_unit.nr_sequencia%type default null) AS $body$
DECLARE


ds_stack_w				log_cpoe.ds_stack%type;
ds_log_cpoe_w			log_cpoe.ds_log%type;
nr_seq_tipo_w			protocolo_medic_jejum.nr_seq_tipo%type;
nr_seq_objetivo_w		protocolo_medic_jejum.nr_seq_objetivo%type;
ie_inicio_w				protocolo_medic_jejum.ie_inicio%type;
dt_inicio_w				protocolo_medic_jejum.dt_inicio%type;
dt_fim_w				protocolo_medic_jejum.dt_fim%type;
dt_evento_w				protocolo_medic_jejum.dt_evento%type;
qt_min_ant_w			protocolo_medic_jejum.qt_min_ant%type;
qt_min_depois_w			protocolo_medic_jejum.qt_min_depois%type;
qt_hora_ant_w			protocolo_medic_jejum.qt_hora_ant%type;
qt_hora_depois_w		protocolo_medic_jejum.qt_hora_depois%type;
ds_observacao_w			protocolo_medic_jejum.ds_observacao%type;
ds_evento_w				protocolo_medic_jejum.ds_evento%type;

ie_duracao_w			cpoe_dieta.ie_duracao%type;
ie_prescr_alta_agora_w			varchar(1);
			
c01 CURSOR FOR
SELECT	a.nr_seq_tipo,
		a.nr_seq_objetivo,
		a.ie_inicio,
		a.dt_inicio,
		a.dt_evento,
		a.qt_min_ant,
		a.qt_min_depois,
		a.qt_hora_ant,
		a.qt_hora_depois,
		a.ds_evento,
		a.ds_observacao,
		coalesce(a.ie_duracao,'C')
from	protocolo_medic_jejum a
where	a.nr_sequencia = nr_seq_protocolo_p
and		a.cd_protocolo = cd_protocolo_p
and		a.nr_seq_jejum = coalesce(nr_seq_item_p,a.nr_seq_jejum);


BEGIN
ie_prescr_alta_agora_w := obter_param_usuario(924, 409, cd_perfil_p, nm_usuario_p, cd_estabelecimento_p, ie_prescr_alta_agora_w);
open c01;
loop
fetch c01 into	
	nr_seq_tipo_w,
	nr_seq_objetivo_w,
	ie_inicio_w,
	dt_inicio_w,
	dt_evento_w,
	qt_min_ant_w,
	qt_min_depois_w,
	qt_hora_ant_w,
	qt_hora_depois_w,
	ds_evento_w,
	ds_observacao_w,
	ie_duracao_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	begin
	
	if (ie_inicio_w in ('P','C')) then
		ie_duracao_w := 'P';
	end if;
	
	if (dt_inicio_w <= clock_timestamp()) or (coalesce(dt_inicio_w::text, '') = '') then
		dt_inicio_w := trunc(clock_timestamp(),'hh');
		if (dt_inicio_w <= clock_timestamp()) then
			dt_inicio_w := dt_inicio_w + 1/24;
		end if;
	end if;
	
	if (ie_duracao_w = 'P') then
		dt_fim_w := ((dt_inicio_w + 1) +(1/86400));
	end if;
	
	if (coalesce(ie_prescr_alta_agora_w,'N') = 'S') and (coalesce(ie_item_alta_p,'N') = 'S')	then	
		dt_inicio_w	:= clock_timestamp();
	end if;
	
	if (dt_inicio_presc_p IS NOT NULL AND dt_inicio_presc_p::text <> '') then
		dt_inicio_w := dt_inicio_presc_p;
	end if;	
	
	if (dt_fim_presc_p IS NOT NULL AND dt_fim_presc_p::text <> '') then
		dt_fim_w := dt_fim_presc_p;
		ie_duracao_w := 'P';
	end if;
	
	if (ie_retrogrado_p = 'S' or ie_futuro_p = 'S') then -- retrograde/backward /futuro item
		dt_inicio_w := dt_inicio_p;
		dt_fim_w := (dt_inicio_w + 1) - 1/1440;
		ie_duracao_w := 'P';
	end if;
		
	select	nextval('cpoe_dieta_seq')
	into STRICT	nr_seq_item_gerado_p
	;
	
	insert into cpoe_dieta(
			nr_sequencia,
			nr_atendimento,
			dt_atualizacao,
			dt_atualizacao_nrec,
			nm_usuario,
			nm_usuario_nrec,
			ie_tipo_dieta,
			ie_inicio,
			dt_evento,
			dt_fim,
			dt_inicio,
			nr_seq_objetivo,
			nr_seq_tipo,
			qt_min_ant,
			qt_min_depois,
			qt_hora_ant,
			qt_hora_depois,
			ds_evento,
			ds_observacao,
			ie_duracao,
			cd_perfil_ativo,
			cd_pessoa_fisica,
			cd_funcao_origem,
			nr_seq_pend_pac_acao,
			ie_prescritor_aux,
			cd_medico,
			ie_retrogrado,
			ie_futuro,
			nr_seq_pepo,
			nr_cirurgia,
			nr_cirurgia_patologia,
			nr_seq_agenda,
			nr_seq_transcricao,
			nr_seq_conclusao_apae,
			ie_forma_geracao,
			ie_administracao,
			nr_seq_cpoe_order_unit)
		values (
			nr_seq_item_gerado_p,
			nr_atendimento_p,
			clock_timestamp(),
			clock_timestamp(),
			nm_usuario_p,
			nm_usuario_p,
			'J',
			ie_inicio_w,
			dt_inicio_w,
			dt_fim_w,
			dt_inicio_w,
			nr_seq_objetivo_w,
			nr_seq_tipo_w,
			qt_min_ant_w,
			qt_min_depois_w,
			qt_hora_ant_w,
			qt_hora_depois_w,
			ds_evento_w,
			ds_observacao_w,
			ie_duracao_w,
			cd_perfil_p,
			cd_pessoa_fisica_p,
			2314,
			nr_seq_pend_pac_acao_p,
			ie_prescritor_aux_p,
			cd_medico_p,
			ie_retrogrado_p,
			ie_futuro_p,
			nr_seq_pepo_p,
			nr_cirurgia_p,
			nr_cirurgia_patologia_p,
			nr_seq_agenda_p,
			nr_seq_transcricao_p,
			nr_seq_conclusao_apae_p,
			ie_forma_geracao_p,
			'P',
			nr_seq_cpoe_order_unit_p);

		CALL cpoe_gerar_plano_protocolo(nr_atendimento_p, dt_fim_presc_p, nr_seq_item_gerado_p, nm_usuario_p, 'N');

		CALL cpoe_utils_pck.set_list_itens(nr_seq_item_gerado_p, 'N');	
	end;
end loop;
close c01;

commit;

exception
   when others then
	rollback;

	ds_stack_w	:= substr(dbms_utility.format_call_stack,1,2000);
	ds_log_cpoe_w := substr('CPOE_GERAR_PROT_DIETA_JEJUM '
		|| chr(13) || ' - cd_estabelecimento_p: ' || cd_estabelecimento_p
		|| chr(13) || ' - cd_perfil_p: ' || cd_perfil_p
		|| chr(13) || ' - nm_usuario_p: ' || nm_usuario_p
		|| chr(13) || ' - cd_protocolo_p: ' || cd_protocolo_p
		|| chr(13) || ' - nr_seq_protocolo_p: ' || nr_seq_protocolo_p
		|| chr(13) || ' - nr_seq_item_p: ' || nr_seq_item_p
		|| chr(13) || ' - nr_atendimento_p: ' || nr_atendimento_p
		|| chr(13) || ' - nr_seq_item_gerado_p: ' || nr_seq_item_gerado_p
		|| chr(13) || ' - cd_pessoa_fisica_p: ' || cd_pessoa_fisica_p
		|| chr(13) || ' - nr_seq_pend_pac_acao_p: ' || nr_seq_pend_pac_acao_p
		|| chr(13) || ' - ie_item_alta_p: ' || ie_item_alta_p
		|| chr(13) || ' - ie_prescritor_aux_p: ' || ie_prescritor_aux_p
		|| chr(13) || ' - cd_medico_p: ' || cd_medico_p
		|| chr(13) || ' - ie_retrogrado_p: ' || ie_retrogrado_p
		|| chr(13) || ' - ie_futuro_p: ' || ie_futuro_p
		|| chr(13) || ' - dt_inicio_p: ' || PKG_DATE_FORMATERS_TZ.TO_VARCHAR(dt_inicio_p,'timestamp',ESTABLISHMENT_TIMEZONE_UTILS.gettimezone)
		|| chr(13) || ' - nr_seq_pepo_p: ' || nr_seq_pepo_p
		|| chr(13) || ' - nr_cirurgia_p: ' || nr_cirurgia_p
		|| chr(13) || ' - nr_cirurgia_patologia_p: ' || nr_cirurgia_patologia_p
		|| chr(13) || ' - nr_seq_agenda_p: ' || nr_seq_agenda_p
		|| chr(13) || ' - nr_seq_transcricao_p: ' || nr_seq_transcricao_p
		|| chr(13) || ' - nr_seq_conclusao_apae_p: ' || nr_seq_conclusao_apae_p
		|| chr(13) || ' - ie_forma_geracao_p: ' || ie_forma_geracao_p
		|| chr(13) || ' - dt_fim_presc_p: ' ||  PKG_DATE_FORMATERS_TZ.TO_VARCHAR(dt_fim_presc_p,'timestamp',ESTABLISHMENT_TIMEZONE_UTILS.gettimezone)
		|| chr(13) || ' - dt_inicio_presc_p: ' || PKG_DATE_FORMATERS_TZ.TO_VARCHAR(dt_inicio_presc_p,'timestamp',ESTABLISHMENT_TIMEZONE_UTILS.gettimezone)
		|| chr(13) || ' - ERRO: ' || sqlerrm
		|| chr(13) || ' - FUNCAO('||to_char(obter_funcao_ativa)||'); PERFIL('||to_char(obter_perfil_ativo)||')',1,2000);

	insert into log_cpoe(
		nr_sequencia,
		nr_atendimento, 
		dt_atualizacao, 
		nm_usuario, 
		ds_log, 
		ds_stack) 
	values (
		nextval('log_cpoe_seq'), 
		nr_atendimento_p, 
		clock_timestamp(), 
		nm_usuario_p, 
		ds_log_cpoe_w, 
		ds_stack_w);
		
	commit;

	CALL wheb_mensagem_pck.exibir_mensagem_abort(sqlerrm);

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cpoe_gerar_prot_dieta_jejum ( cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, cd_perfil_p perfil.cd_perfil%type, nm_usuario_p usuario.nm_usuario%type, cd_protocolo_p protocolo_medic_jejum.cd_protocolo%type, nr_seq_protocolo_p protocolo_medic_jejum.nr_sequencia%type, nr_seq_item_p protocolo_medic_jejum.nr_seq_jejum%type, nr_atendimento_p atendimento_paciente.nr_atendimento%type, nr_seq_item_gerado_p INOUT cpoe_dieta.nr_sequencia%type, cd_pessoa_fisica_p pessoa_fisica.cd_pessoa_fisica%type default null, nr_seq_pend_pac_acao_p gqa_pend_pac_acao.nr_sequencia%type default null, ie_item_alta_p text default 'N', ie_prescritor_aux_p text default 'N', cd_medico_p bigint default null, ie_retrogrado_p text default 'N', dt_inicio_p timestamp default null, nr_seq_pepo_p bigint default null, nr_cirurgia_p bigint default null, nr_cirurgia_patologia_p bigint default null, nr_seq_agenda_p bigint default null, nr_seq_transcricao_p bigint default null, nr_seq_conclusao_apae_p bigint default null, ie_forma_geracao_p text default null, dt_fim_presc_p timestamp default null, dt_inicio_presc_p timestamp default null, ie_futuro_p text default 'N', nr_seq_cpoe_rp_p cpoe_rp.nr_sequencia%type default null, nr_seq_cpoe_order_unit_p cpoe_order_unit.nr_sequencia%type default null) FROM PUBLIC;

