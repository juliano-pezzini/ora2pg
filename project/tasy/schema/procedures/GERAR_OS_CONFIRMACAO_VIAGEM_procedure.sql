-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_os_confirmacao_viagem ( nr_grupo_planej_p bigint, nr_grupo_trabalho_p bigint, nr_seq_localizacao_p bigint, ie_parado_p text, nr_seq_equipamento_p bigint, nr_seq_viagem_p bigint, nr_seq_estagio_p bigint, nm_usuario_p text, nr_seq_ordem_servico_p INOUT bigint) AS $body$
DECLARE

 
cd_pessoa_solicitante_w		varchar(10);
nm_pessoa_solicitante_w		varchar(40);
dt_saida_prev_w			timestamp;
ds_dano_w			varchar(4000);
ds_meio_transporte_w		varchar(80);
nr_seq_transp_w			bigint;
ds_origem_w			varchar(120);
ds_destino_w			varchar(120);
nr_seq_ordem_servico_w		bigint;


BEGIN 
 
select 	max(dt_saida_prev), 
	max(cd_pessoa_fisica) 
into STRICT	dt_saida_prev_w, 
	cd_pessoa_solicitante_w 
from 	via_viagem 
where 	nr_sequencia = nr_seq_viagem_p;
 
select 	substr(obter_nome_pf(cd_pessoa_solicitante_w),1,40) 
into STRICT	nm_pessoa_solicitante_w
;
 
select 	max(nr_sequencia) 
into STRICT	nr_seq_transp_w 
from 	via_transporte 
where 	nr_seq_viagem = nr_seq_viagem_p;
 
if (coalesce(nr_seq_transp_w,0) > 0) then 
	 
	select 	substr(Obter_Desc_Meio_Transp(nr_seq_meio_transp),1,80), 
		substr(Obter_Desc_Loc(nr_seq_loc_origem),1,120), 
		substr(Obter_Desc_Loc(nr_seq_loc_destino),1,120) 
	into STRICT	ds_meio_transporte_w, 
		ds_origem_w, 
		ds_destino_w 
	from 	via_transporte 
	where 	nr_sequencia = nr_seq_transp_w;
 
end if;
 
ds_dano_w:= obter_desc_expressao(326160)/*'Pessoa: '*/
 || nm_pessoa_solicitante_w || chr(13) || chr(10) || 
			obter_desc_expressao(297975)/*'Saida Prevista: '*/
 ||': '|| to_char(dt_saida_prev_w,'dd/mm/yyyy hh24:mi') || chr(13) || chr(10) || 
			obter_desc_expressao(293180)/*'Meio transporte: '*/
 ||': '|| ds_meio_transporte_w || chr(13) || chr(10) || 
			obter_desc_expressao(327633)/*'Origem: '*/
 || ds_origem_w || chr(13) || chr(10) || 
			obter_desc_expressao(329684)/*'Destino: '*/
 || ds_destino_w;
	 
select 	nextval('man_ordem_servico_seq') 
into STRICT	nr_seq_ordem_servico_w
;
 
insert into man_ordem_servico( 
	nr_sequencia, 
	nr_seq_localizacao, 
	nr_seq_equipamento, 
	cd_pessoa_solicitante, 
	dt_ordem_servico, 
	ie_prioridade, 
	ie_parado, 
	ds_dano_breve, 
	dt_atualizacao, 
	nm_usuario, 
	dt_inicio_desejado, 
	ie_tipo_ordem, 
	ie_status_ordem, 
	nr_grupo_planej, 
	nr_grupo_trabalho, 
	nr_seq_estagio, 
	ie_classificacao, 
	ds_dano, 
	dt_atualizacao_nrec, 
	nm_usuario_nrec, 
	dt_inicio_previsto, 
	ie_origem_os) 
values (nr_seq_ordem_servico_w, 
	nr_seq_localizacao_p, 
	nr_seq_equipamento_p, 
	cd_pessoa_solicitante_w, 
	clock_timestamp(), 
	'M', -- Domínio 1046 
	ie_parado_p, 
	'Viagem de ' || nm_pessoa_solicitante_w || ' (Nro. viagem = ' || nr_seq_viagem_p || ')', 
	clock_timestamp(), 
	nm_usuario_p, 
	clock_timestamp(), 
	2, -- Domínio 1091 
	1, 
	nr_grupo_planej_p, 
	nr_grupo_trabalho_p, 
	CASE WHEN nr_seq_estagio_p=0 THEN null  ELSE nr_seq_estagio_p END , 
	null, 
	ds_dano_w, 
	clock_timestamp(), 
	nm_usuario_p, 
	clock_timestamp(), 
	'4');
 
commit;
 
nr_seq_ordem_servico_p:= nr_seq_ordem_servico_w;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_os_confirmacao_viagem ( nr_grupo_planej_p bigint, nr_grupo_trabalho_p bigint, nr_seq_localizacao_p bigint, ie_parado_p text, nr_seq_equipamento_p bigint, nr_seq_viagem_p bigint, nr_seq_estagio_p bigint, nm_usuario_p text, nr_seq_ordem_servico_p INOUT bigint) FROM PUBLIC;

