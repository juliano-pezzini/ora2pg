-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE salvar_adep_proced_partic ( cd_estabelecimento_p bigint, nr_atendimento_p bigint, nr_prescricao_p bigint, nr_seq_procedimento_p bigint, cd_medico_p text, ie_funcao_p bigint, nm_usuario_p text, ie_acao_p text, cd_especialidade_p INOUT bigint, ds_erro_p INOUT text) AS $body$
DECLARE

			 
ie_anestesista_w			varchar(1);
ie_permite_anestesistas_w	varchar(1);
ie_permite_anestesistas_ww	varchar(1);
ds_porte_w					varchar(5);
ie_medico_cadastrado_w		varchar(1);
ie_consiste_anest_porte_w	varchar(1);
ds_valor_w					varchar(255);
nr_seq_proc_pac_w			bigint;
cd_convenio_parametro_w		bigint;
cd_convenio_w				bigint;
cd_categoria_w				bigint;
cd_edicao_amb_w				bigint;
cd_procedimento_w			bigint;
ie_origem_proced_w			bigint;
dt_conta_w					timestamp;
ds_macro_erro_w				varchar(255) := '';
nr_erro_w					bigint := 0;


BEGIN 
 
if (cd_medico_p IS NOT NULL AND cd_medico_p::text <> '') then 
 
	select	coalesce(max('S'),'N') 
	into STRICT	ie_medico_cadastrado_w 
	from	pessoa_fisica 
	where	cd_pessoa_fisica = cd_medico_p;
	 
	if (ie_medico_cadastrado_w = 'N') then 
		-- Médico não cadastrado! 
		nr_erro_w := 195849;
	end if;
end if;	
 
if (nr_erro_w = 0) then 
	 
	select	max(cd_convenio_parametro) 
	into STRICT	cd_convenio_parametro_w 
	from	conta_paciente 
	where	nr_atendimento = nr_atendimento_p;
 
	select	max(nr_sequencia) 
	into STRICT	nr_seq_proc_pac_w 
	from	procedimento_paciente 
	where	nr_prescricao = nr_prescricao_p 
	and		nr_sequencia = nr_seq_procedimento_p;
 
	select	max(cd_convenio), 
			max(cd_categoria), 
			coalesce(max(cd_edicao_amb),0), 
			max(cd_procedimento), 
			max(ie_origem_proced), 
			max(dt_conta) 
	into STRICT	cd_convenio_w, 
			cd_categoria_w, 
			cd_edicao_amb_w, 
			cd_procedimento_w, 
			ie_origem_proced_w, 
			dt_conta_w 
	from	procedimento_paciente 
	where	nr_sequencia = nr_seq_proc_pac_w;
 
	select 	coalesce(max(ie_consiste_anest_porte),'N') 
	into STRICT	ie_consiste_anest_porte_w 
	from 	parametro_faturamento 
	where 	cd_estabelecimento = cd_estabelecimento_p;
 
	if (ie_consiste_anest_porte_w = 'R') then 
		select	coalesce(max(obter_regra_tipo_atend_porte(nr_atendimento_p)),'N') 
		into STRICT	ie_consiste_anest_porte_w 
		;
	end if;
	 
	if (ie_acao_p = 'I') then 
 
		select	coalesce(max(ie_anestesista),'N') 
		into STRICT	ie_anestesista_w 
		from	funcao_medico 
		where	cd_funcao = ie_funcao_p;
		 
		if (ie_anestesista_w = 'S') and (ie_consiste_anest_porte_w in ('S','P')) then 
			select	coalesce(max(Obter_Dados_Preco_Proc(cd_estabelecimento_p, cd_convenio_w, cd_categoria_w, cd_edicao_amb_w, cd_procedimento_w, coalesce(ie_origem_proced_w,0), dt_conta_w, 'P')),'N'), 
					coalesce(max(Obter_Dados_Preco_Proc(cd_estabelecimento_p, cd_convenio_w, cd_categoria_w, cd_edicao_amb_w, cd_procedimento_w, ie_origem_proced_w, dt_conta_w, 'PN')),'N') 
			into STRICT	ie_permite_anestesistas_w, 
					ie_permite_anestesistas_ww 
			from	procedimento_paciente 
			where	nr_sequencia = nr_seq_proc_pac_w;
			 
			if	((ie_consiste_anest_porte_w = 'S' AND ie_permite_anestesistas_w = 'N') or 
				 (ie_consiste_anest_porte_w = 'N' AND ie_permite_anestesistas_ww = 'N')) then 
				-- Não é permitido o lançamento de anestesistas para procedimentos sem porte anestésico. Verifique os parâmetros do faturamento. 
				nr_erro_w := 195860;
			end if;
		end if;
	end if;
 
	if (nr_erro_w = 0) then 
		select	max(Obter_convenio_regra_atend(cd_medico_p, cd_convenio_parametro_w, ie_tipo_atendimento, cd_estabelecimento_p, 'P', null, null)) 
		into STRICT	ie_medico_cadastrado_w 
		from	atendimento_paciente 
		where	nr_atendimento = nr_atendimento_p;
 
		if (ie_medico_cadastrado_w = 'N') then 
			 
			select	max(substr(obter_nome_convenio(cd_convenio_parametro_w),1,255)) 
			into STRICT	ds_valor_w 
			;
			 
			-- O médico não está cadastrado para participar dos procedimentos para o convênio #@DS_CONVENIO#@ 
			nr_erro_w			:= 195842;
			ds_macro_erro_w		:= 'DS_CONVENIO=' || ds_valor_w;
		else if (ie_acao_p in ('I','E')) and (coalesce(cd_especialidade_p,-1) = -1) then 
				 
				select	max(obter_especialidade_medico(cd_medico_p,'C')) 
				into STRICT	cd_especialidade_p 
				;
				 
			end if;
		end if;
	end if;
end if;
 
if (nr_erro_w > 0) then 
	ds_erro_p := obter_texto_dic_objeto(nr_erro_w, 1, ds_macro_erro_w);
end if;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE salvar_adep_proced_partic ( cd_estabelecimento_p bigint, nr_atendimento_p bigint, nr_prescricao_p bigint, nr_seq_procedimento_p bigint, cd_medico_p text, ie_funcao_p bigint, nm_usuario_p text, ie_acao_p text, cd_especialidade_p INOUT bigint, ds_erro_p INOUT text) FROM PUBLIC;

