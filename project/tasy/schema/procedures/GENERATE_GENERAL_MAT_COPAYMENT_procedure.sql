-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE generate_general_mat_copayment ( nr_interno_conta_p conta_paciente.nr_interno_conta%type, nr_seq_conta_pac_dc_p conta_pac_deducao_conv.nr_sequencia%type, pr_coseguro_hosp_p conta_pac_deducao_conv.pr_informado_calculo%type, cd_convenio_p conta_pac_deducao_conv.cd_convenio%type, cd_categoria_p conta_pac_deducao_conv.cd_categoria%type, ie_red_valor_original_p conta_pac_deducao_conv.ie_valor_original%type, vl_coseguro_hosp_p conta_pac_deducao_conv.vl_informado_calculo%type, vl_total_conta_ant_p conta_paciente_valor_v.vl_original%type, nm_usuario_p usuario.nm_usuario%type, vl_coseguro_sum_p INOUT conta_pac_deducao_conv.vl_calculado%type ) AS $body$
DECLARE


vl_material_final_w			material_atend_paciente.vl_material%type;
vl_coseguro_mat_w			material_atend_paciente.vl_material%type;
vl_coseguro_sum_w			conta_pac_deducao_conv.vl_calculado%type := 0;

nr_seq_material_novo_w			material_atend_paciente.nr_sequencia%type;	
nr_seq_matpaci_valor_w			mat_atend_paciente_valor.nr_sequencia%type;
nr_seq_conta_pac_ded_w			conta_pac_ded_conv_item.nr_sequencia%type;
ie_tipo_valor_s				proc_paciente_valor.ie_tipo_valor%type := 95;

nr_seq_material_w			material_atend_paciente.nr_sequencia%type;
cd_material_w				material_atend_paciente.cd_material%type;	
dt_atendimento_w			material_atend_paciente.dt_atendimento%type;
nr_atendimento_w			material_atend_paciente.nr_atendimento%type;
cd_setor_atendimento_w			material_atend_paciente.cd_setor_atendimento%type;
nr_seq_atepacu_w			material_atend_paciente.nr_seq_atepacu%type;
dt_entrada_unidade_w			material_atend_paciente.dt_entrada_unidade%type;
cd_unidade_medida_w			material_atend_paciente.cd_unidade_medida%type;
cd_acao_w				material_atend_paciente.cd_acao%type;
vl_material_w				material_atend_paciente.vl_material%type;

c01 CURSOR FOR
	SELECT	a.nr_sequencia nr_seq_material,
		a.cd_material,
		a.dt_atendimento,
		a.nr_atendimento,
		a.cd_setor_atendimento,
		a.nr_seq_atepacu,
		a.dt_entrada_unidade,
		a.cd_unidade_medida,
		a.cd_acao,
		coalesce(a.vl_material,0) vl_material
	from	material_atend_paciente a
	where 	a.nr_interno_conta = nr_interno_conta_p
	and 	a.nr_sequencia not in (	SELECT	x.nr_seq_mat_pac
					from	conta_pac_deducao_mat x,
						conta_pac_deducao_conv b
					where	x.nr_seq_conta_ded = b.nr_sequencia
					and	b.nr_seq_conta_orig = nr_interno_conta_p
					and	b.ie_coseguro = 'S'
					and	b.ie_copago = 'N'
					and	b.ie_tipo_calculo in ('H','I')      
					and (coalesce(x.pr_informado_calculo, 0) > 0 or coalesce(x.vl_informado_calculo, 0) > 0));
	

BEGIN
		
vl_coseguro_sum_w := vl_coseguro_sum_p;

open c01;
loop
fetch c01 into	
	nr_seq_material_w,
	cd_material_w,
	dt_atendimento_w,
	nr_atendimento_w,
	cd_setor_atendimento_w,
	nr_seq_atepacu_w,
	dt_entrada_unidade_w,
	cd_unidade_medida_w,
	cd_acao_w,
	vl_material_w;
EXIT WHEN NOT FOUND; /* apply on c01 */

	select  coalesce(max(nr_sequencia), 0) + 1
	into STRICT    nr_seq_matpaci_valor_w
	from    mat_atend_paciente_valor
	where   nr_seq_material = nr_seq_material_w;

	insert into mat_atend_paciente_valor(
		nr_sequencia,
		nr_seq_material,
		ie_tipo_valor,
		dt_atualizacao,
		nm_usuario,
		vl_material,
		cd_convenio,
		cd_categoria,
		pr_valor,
		nr_seq_trans_fin,
		nr_lote_contabil,
		nr_seq_desconto,
		nr_codigo_controle
	) values (
		nr_seq_matpaci_valor_w,
		nr_seq_material_w,
		ie_tipo_valor_s,
		clock_timestamp(),
		nm_usuario_p,
		vl_material_w,
		cd_convenio_p,
		cd_categoria_p,
		pr_coseguro_hosp_p,
		null,
		null,
		null,
		null
	);

	if (coalesce(pr_coseguro_hosp_p,0) > 0) then
		vl_coseguro_mat_w := vl_material_w * pr_coseguro_hosp_p/100;
		vl_coseguro_sum_w := vl_coseguro_sum_w + vl_coseguro_mat_w;
	else
		vl_coseguro_mat_w := round((vl_material_w / vl_total_conta_ant_p) * vl_coseguro_hosp_p, 2);
		vl_coseguro_sum_w := vl_coseguro_sum_w + vl_coseguro_mat_w;
	end if;

	if (ie_red_valor_original_p = 'S') then
		vl_material_final_w := vl_material_w - vl_coseguro_mat_w;
	else
		vl_material_final_w := vl_material_w;
	end if;

	update  conta_pac_deducao_mat
	set     vl_calculado = vl_material_final_w,
		vl_base_material = vl_material_w
	where   nr_seq_conta_ded = nr_seq_conta_pac_dc_p and nr_seq_mat_pac = nr_seq_material_w;

	update  material_atend_paciente
	set     vl_material = vl_material_final_w,
		ie_valor_informado = 'S'
	where   nr_sequencia = nr_seq_material_w;

	select  nextval('material_atend_paciente_seq')
	into STRICT    nr_seq_material_novo_w
	;

	CALL inserir_material_ate_pac(
		null,
		null,
		cd_material_w,
		null,
		null,
		null,
		1,
		null,
		dt_atendimento_w,
		cd_unidade_medida_w,
		null,
		null,
		cd_convenio_p,
		cd_categoria_p,
		null,
		cd_setor_atendimento_w,
		nr_seq_atepacu_w,
		dt_entrada_unidade_w,
		null,
		null,
		null,
		null,
		null,
		null,
		null,
		null,
		nr_seq_material_novo_w,
		nr_atendimento_w,
		null,
		null,
		null,
		cd_acao_w,
		vl_coseguro_mat_w,
		null,
		'S',
		null,
		null,
		null,
		null,
		null,
		null,
		null,
		null,
		null,
		null,
		nm_usuario_p,
		null
	);

	update  material_atend_paciente
	set     vl_material = vl_coseguro_mat_w,
		ie_valor_informado = 'S'
	where   nr_sequencia = nr_seq_material_novo_w;

	select  coalesce(max(nr_sequencia), 0) + 1
	into STRICT    nr_seq_matpaci_valor_w
	from    mat_atend_paciente_valor
	where   nr_seq_material = nr_seq_material_novo_w;

	insert into mat_atend_paciente_valor(
		nr_seq_material,
		nr_sequencia,
		ie_tipo_valor,
		vl_material,
		cd_convenio,
		cd_categoria,
		pr_valor,
		dt_atualizacao,
		nm_usuario,
		nr_seq_trans_fin,
		nr_lote_contabil,
		nr_seq_desconto,
		nr_codigo_controle
	) values (
		nr_seq_material_novo_w,
		nr_seq_matpaci_valor_w,
		ie_tipo_valor_s,
		vl_coseguro_mat_w,
		cd_convenio_p,
		cd_categoria_p,
		pr_coseguro_hosp_p,
		clock_timestamp(),
		nm_usuario_p,
		null,
		null,
		null,
		null
	);

	select  nextval('conta_pac_ded_conv_item_seq')
	into STRICT    nr_seq_conta_pac_ded_w
	;

	insert into conta_pac_ded_conv_item(
		nr_sequencia,
		dt_atualizacao,
		nm_usuario,
		dt_atualizacao_nrec,
		nm_usuario_nrec,
		nr_seq_deducao_conv,
		nr_seq_propaci_origem,
		nr_seq_matpaci_origem,
		nr_seq_propaci_dest,
		nr_seq_matpaci_dest,
		vl_rateio,
		nr_seq_propaci_valor_ant,
		nr_seq_mat_atend_pac_valor,
		nr_lote_contabil,
		vl_rateio_com_imp,
		vl_rateio_sem_imp
	) values (
		nr_seq_conta_pac_ded_w,
		clock_timestamp(),
		nm_usuario_p,
		clock_timestamp(),
		nm_usuario_p,
		nr_seq_conta_pac_dc_p,
		null,
		nr_seq_material_w,
		null,
		nr_seq_material_novo_w,
		null,
		null,
		null,
		null,
		null,
		null
	);
end loop;
close c01;

vl_coseguro_sum_p := vl_coseguro_sum_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE generate_general_mat_copayment ( nr_interno_conta_p conta_paciente.nr_interno_conta%type, nr_seq_conta_pac_dc_p conta_pac_deducao_conv.nr_sequencia%type, pr_coseguro_hosp_p conta_pac_deducao_conv.pr_informado_calculo%type, cd_convenio_p conta_pac_deducao_conv.cd_convenio%type, cd_categoria_p conta_pac_deducao_conv.cd_categoria%type, ie_red_valor_original_p conta_pac_deducao_conv.ie_valor_original%type, vl_coseguro_hosp_p conta_pac_deducao_conv.vl_informado_calculo%type, vl_total_conta_ant_p conta_paciente_valor_v.vl_original%type, nm_usuario_p usuario.nm_usuario%type, vl_coseguro_sum_p INOUT conta_pac_deducao_conv.vl_calculado%type ) FROM PUBLIC;

