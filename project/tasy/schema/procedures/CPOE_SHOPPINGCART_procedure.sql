-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE cpoe_shoppingcart (ds_items_p INOUT text, ie_retrogrado_p text, nr_seq_atend_futuro_p bigint default null) AS $body$
DECLARE


ds_items_w		varchar(2000);
ds_items_ww		varchar(2000);
ds_item_w		varchar(30);
ie_tipo_item_w	varchar(30);
nr_seq_item_w	bigint;
ds_retorno_w	varchar(30);


BEGIN

ds_items_w := ds_items_p;
while((ds_items_w IS NOT NULL AND ds_items_w::text <> '') and position(';' in ds_items_w) > 0) loop
	ds_retorno_w:=null;
	ds_item_w := substr(ds_items_w, 1, position(';' in ds_items_w) - 1);
	nr_seq_item_w := (substr(ds_item_w, 1, position(',' in ds_item_w) - 1))::numeric;
	ie_tipo_item_w := substr(ds_item_w, position(',' in ds_item_w) + 1, length(ds_item_w));
	ds_items_w := substr(ds_items_w, position(';' in ds_items_w) + 1, length(ds_items_w));
	
	if (ie_tipo_item_w = 'N') then /*Nutrition*/
		ds_retorno_w := cpoe_shoppingcart_nutrition(nr_seq_item_w, ie_retrogrado_p, ds_retorno_w);
        if (coalesce(nr_seq_atend_futuro_p, 0) > 0) then
			update cpoe_dieta set nr_seq_atend_futuro = nr_seq_atend_futuro_p where nr_sequencia = nr_seq_item_w;
        end if;
	elsif (ie_tipo_item_w = 'M') then /*Medicine*/
		ds_retorno_w := cpoe_shoppingcart_medicine(nr_seq_item_w, ie_retrogrado_p, ds_retorno_w);
        if (coalesce(nr_seq_atend_futuro_p, 0) > 0) then
			update cpoe_material set nr_seq_atend_futuro = nr_seq_atend_futuro_p where nr_sequencia = nr_seq_item_w;
		end if;
	elsif (ie_tipo_item_w = 'DI') then /*Dialysis*/
		ds_retorno_w := cpoe_shoppingcart_dialysis(nr_seq_item_w, ie_retrogrado_p, ds_retorno_w);
        if (coalesce(nr_seq_atend_futuro_p, 0) > 0) then
			update cpoe_dialise set nr_seq_atend_futuro = nr_seq_atend_futuro_p where nr_sequencia = nr_seq_item_w;
        end if;
	elsif (ie_tipo_item_w = 'P') then /*Procedure*/
		ds_retorno_w := cpoe_shoppingcart_procedure(nr_seq_item_w, ie_retrogrado_p);
         if (coalesce(nr_seq_atend_futuro_p, 0) > 0) then
			update cpoe_procedimento set nr_seq_atend_futuro = nr_seq_atend_futuro_p where nr_sequencia = nr_seq_item_w;
         end if;
	elsif (ie_tipo_item_w = 'G') then /*Gas therapy*/
		ds_retorno_w := cpoe_shoppingcart_gastherapy(nr_seq_item_w, ie_retrogrado_p, ds_retorno_w);
        if (coalesce(nr_seq_atend_futuro_p, 0) > 0) then
			update cpoe_gasoterapia set nr_seq_atend_futuro = nr_seq_atend_futuro_p where nr_sequencia = nr_seq_item_w;
         end if;
	elsif (ie_tipo_item_w = 'R') then /*Recomendation*/
		ds_retorno_w := cpoe_shoppingcart_recomend(nr_seq_item_w, ie_retrogrado_p, ds_retorno_w);
        if (coalesce(nr_seq_atend_futuro_p, 0) > 0) then
			update cpoe_recomendacao set nr_seq_atend_futuro = nr_seq_atend_futuro_p where nr_sequencia = nr_seq_item_w;
        end if;
	elsif (ie_tipo_item_w = 'H') then /*Hemotherapy*/
		ds_retorno_w := cpoe_shoppingcart_hemotherapy(nr_seq_item_w, ie_retrogrado_p, ds_retorno_w);
        if (coalesce(nr_seq_atend_futuro_p, 0) > 0) then
			update cpoe_hemoterapia set nr_seq_atend_futuro = nr_seq_atend_futuro_p where nr_sequencia = nr_seq_item_w;
        end if;
	elsif (ie_tipo_item_w = 'MA') then /*Material*/
		ds_retorno_w := cpoe_shoppingcart_material(nr_seq_item_w, ie_retrogrado_p, ds_retorno_w);
          if (coalesce(nr_seq_atend_futuro_p, 0) > 0) then
			update cpoe_material set nr_seq_atend_futuro = nr_seq_atend_futuro_p where nr_sequencia = nr_seq_item_w;
		  end if;
	elsif (ie_tipo_item_w = 'AP') then
		ds_retorno_w := cpoe_shoppingcart_ap(nr_seq_item_w, ie_retrogrado_p, ds_retorno_w);
        if (coalesce(nr_seq_atend_futuro_p, 0) > 0) then
			update cpoe_anatomia_patologica set nr_seq_atend_futuro = nr_seq_atend_futuro_p where nr_sequencia = nr_seq_item_w;
		end if;

	end if;

	
	if ((ds_item_w IS NOT NULL AND ds_item_w::text <> '') and (ie_tipo_item_w IS NOT NULL AND ie_tipo_item_w::text <> '') and (nr_seq_item_w IS NOT NULL AND nr_seq_item_w::text <> '') and (ds_retorno_w IS NOT NULL AND ds_retorno_w::text <> '')) then
		ds_items_ww := ds_items_ww||ds_item_w||','||ds_retorno_w||';';
	end if;
end loop;

ds_items_p := ds_items_ww;

exception when others then
	CALL gravar_log_cpoe(substr('CPOE_SELECT_ITEM_SHOPPINGCART EXCEPTION:'|| substr(to_char(sqlerrm),1,2000) || '//ds_items_p: '|| ds_items_p,1,40000));
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cpoe_shoppingcart (ds_items_p INOUT text, ie_retrogrado_p text, nr_seq_atend_futuro_p bigint default null) FROM PUBLIC;

