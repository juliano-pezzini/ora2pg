-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE inserir_mudou_se_domicilio ( CD_PESSOA_FISICA_P text, NR_SEQ_DOMICILIO_P bigint, NR_SEQ_GRAU_PARENTESCO_P bigint) AS $body$
DECLARE

 
NM_USUARIO_ATIVO_W USUARIO.NM_USUARIO%TYPE;
ANTIGODOMICILIO bigint;
QT_EXISTE   bigint;

BEGIN
  NM_USUARIO_ATIVO_W := WHEB_USUARIO_PCK.GET_NM_USUARIO;
 
 IF ((CD_PESSOA_FISICA_P IS NOT NULL AND CD_PESSOA_FISICA_P::text <> '') AND CD_PESSOA_FISICA_P > 0 
   AND (NR_SEQ_DOMICILIO_P IS NOT NULL AND NR_SEQ_DOMICILIO_P::text <> '') AND NR_SEQ_DOMICILIO_P > 0 ) THEN 
 
   SELECT COUNT(1) INTO STRICT QT_EXISTE FROM PESSOA_DOMICILIO_MORADIA WHERE CD_PESSOA_FISICA = CD_PESSOA_FISICA_P;
   
   IF QT_EXISTE >= 1 THEN 
   
    UPDATE PESSOA_DOMICILIO_MORADIA 
    SET IE_MUDOU_SE = 'S' 
    WHERE CD_PESSOA_FISICA = CD_PESSOA_FISICA_P;
   END IF;
   
   IF (NR_SEQ_DOMICILIO_P IS NOT NULL AND NR_SEQ_DOMICILIO_P::text <> '') THEN 
    SELECT COUNT(NR_SEQ_DOMICILIO) INTO STRICT ANTIGODOMICILIO FROM PESSOA_DOMICILIO_MORADIA WHERE CD_PESSOA_FISICA = CD_PESSOA_FISICA_P AND NR_SEQ_DOMICILIO = NR_SEQ_DOMICILIO_P;
     
    IF ANTIGODOMICILIO > 0 THEN 
      UPDATE PESSOA_DOMICILIO_MORADIA 
      SET IE_MUDOU_SE = 'N' 
      WHERE CD_PESSOA_FISICA = CD_PESSOA_FISICA_P AND NR_SEQ_DOMICILIO = NR_SEQ_DOMICILIO_P;
     
    ELSE 
      INSERT INTO PESSOA_DOMICILIO_MORADIA(NR_SEQUENCIA, NR_SEQ_DOMICILIO, DT_ATUALIZACAO, NM_USUARIO, DT_ATUALIZACAO_NREC, 
                         NM_USUARIO_NREC, CD_PESSOA_FISICA, NR_SEQ_GRAU_PARENT, IE_MUDOU_SE) 
                    VALUES (nextval('pessoa_domicilio_moradia_seq'), NR_SEQ_DOMICILIO_P, clock_timestamp(), NM_USUARIO_ATIVO_W, 
                        clock_timestamp(), NM_USUARIO_ATIVO_W, CD_PESSOA_FISICA_P, NR_SEQ_GRAU_PARENTESCO_P, 'N');
    END IF;
   END IF;
 END IF;
 
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE inserir_mudou_se_domicilio ( CD_PESSOA_FISICA_P text, NR_SEQ_DOMICILIO_P bigint, NR_SEQ_GRAU_PARENTESCO_P bigint) FROM PUBLIC;

