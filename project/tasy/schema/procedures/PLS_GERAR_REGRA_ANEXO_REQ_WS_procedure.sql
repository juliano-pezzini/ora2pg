-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_gerar_regra_anexo_req_ws ( nr_seq_requisicao_p pls_requisicao.nr_sequencia%type, nm_usuario_p text) AS $body$
DECLARE


/* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Finalidade:  Adicionar o anexo na requisição caso a mesma esteja em análise
------------------------------------------------------------------------------------------------
Locais de chamada direta:
[  ]  Objetos do dicionário [ ] Tasy (Delphi/Java) [  ] Portal [  ]  Relatórios [  x] Outros:
WebService
 -----------------------------------------------------------------------------------------------
Pontos de atenção:
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */
ie_tipo_anexo_w			pls_regra_anexo_guia.ie_tipo_anexo%type;
ie_atualiza_guia_w		boolean := false;
ie_tipo_atendimento_w		pls_guia_plano.ie_tipo_atend_tiss%type;


C01 CURSOR FOR
	SELECT	'P' ie_tipo,
		cd_procedimento cd_item,
		ie_origem_proced  ie_origem,
		nr_sequencia
	from    pls_requisicao_proc
	where	nr_seq_requisicao = nr_seq_requisicao_p
	and	coalesce(ie_tipo_anexo::text, '') = ''
	
union

	SELECT	'M' ie_tipo,
		nr_seq_material cd_item,
		null ie_origem,
		nr_sequencia
	from	pls_requisicao_mat
	where   nr_seq_requisicao = nr_seq_requisicao_p
	and	coalesce(ie_tipo_anexo::text, '') = '';


BEGIN

select	ie_tipo_atendimento
into STRICT	ie_tipo_atendimento_w
from	pls_requisicao
where	nr_sequencia = nr_seq_requisicao_p;

for c_01 in c01 loop
	begin
		if (pls_obter_se_controle_estab('RE') = 'S') then
			select  max(a.ie_tipo_anexo)
			into STRICT	ie_tipo_anexo_w
			from    pls_regra_anexo_guia a,
				pls_regra_anexo_guia_itens b
			where   a.nr_sequencia = b.nr_seq_regra_anexo_guia
			and     a.ie_aplica_web_service = 'S'
			and     a.dt_inicio_vigencia <= clock_timestamp()
			and (coalesce(a.dt_fim_vigencia::text, '') = ''
			or      a.dt_fim_vigencia > clock_timestamp())
			and     b.ie_situacao = 'A'
			and	((c_01.ie_tipo = 'P' and (cd_procedimento = c_01.cd_item and ie_origem_proced = c_01.ie_origem and coalesce(ie_tipo_atend_tiss::text, '') = '') or (cd_procedimento = c_01.cd_item and ie_origem_proced = c_01.ie_origem and ie_tipo_atend_tiss = ie_tipo_atendimento_w))
			or	(c_01.ie_tipo = 'M' and
				((nr_seq_material = c_01.cd_item and coalesce(ie_tipo_atend_tiss::text, '') = ''
				or nr_seq_material = c_01.cd_item and ie_tipo_atend_tiss = ie_tipo_atendimento_w)
				or (exists ( SELECT 1
						 from pls_estrutura_material_v es
						 where es.nr_seq_estrutura  = b.nr_seq_estrut_mat
						 and	es.nr_seq_material  = c_01.cd_item)))))
			and 	a.cd_estabelecimento = wheb_usuario_pck.get_cd_estabelecimento;
		else
			select  max(a.ie_tipo_anexo)
			into STRICT	ie_tipo_anexo_w
			from    pls_regra_anexo_guia a,
				pls_regra_anexo_guia_itens b
			where   a.nr_sequencia = b.nr_seq_regra_anexo_guia
			and     a.ie_aplica_web_service = 'S'
			and     a.dt_inicio_vigencia <= clock_timestamp()
			and (coalesce(a.dt_fim_vigencia::text, '') = ''
			or      a.dt_fim_vigencia > clock_timestamp())
			and     b.ie_situacao = 'A'
			and	((c_01.ie_tipo = 'P' and (cd_procedimento = c_01.cd_item and ie_origem_proced = c_01.ie_origem and coalesce(ie_tipo_atend_tiss::text, '') = '') or (cd_procedimento = c_01.cd_item and ie_origem_proced = c_01.ie_origem and coalesce(ie_tipo_atend_tiss::text, '') = ''))
			or	(c_01.ie_tipo = 'M' and
				((nr_seq_material = c_01.cd_item and coalesce(ie_tipo_atend_tiss::text, '') = ''
				or nr_seq_material = c_01.cd_item and ie_tipo_atend_tiss = ie_tipo_atendimento_w)
				or (exists ( SELECT 1
						 from pls_estrutura_material_v es
						 where es.nr_seq_estrutura  = b.nr_seq_estrut_mat
						 and	es.nr_seq_material  = c_01.cd_item)))));
		end if;

		if (ie_tipo_anexo_w IS NOT NULL AND ie_tipo_anexo_w::text <> '') then
			ie_atualiza_guia_w := true;

			if (c_01.ie_tipo = 'P') then
				update	pls_requisicao_proc
				set	ie_tipo_anexo 	= ie_tipo_anexo_w
				where	nr_sequencia 	= c_01.nr_sequencia;
			else
				update	pls_requisicao_mat
				set	ie_tipo_anexo 	= ie_tipo_anexo_w
				where	nr_sequencia 	= c_01.nr_sequencia;
			end if;
		end if;
	end;
end loop;

if ( ie_atualiza_guia_w ) then
	update	pls_requisicao
	set     ie_aguarda_anexo_guia = 'S'
	where	nr_sequencia = nr_seq_requisicao_p;
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_gerar_regra_anexo_req_ws ( nr_seq_requisicao_p pls_requisicao.nr_sequencia%type, nm_usuario_p text) FROM PUBLIC;

