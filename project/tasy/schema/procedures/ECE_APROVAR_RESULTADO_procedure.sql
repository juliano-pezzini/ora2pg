-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE ece_aprovar_resultado ( nr_prescricao_p bigint, nr_seq_interno_p bigint, cd_exame_princ_p text) AS $body$
DECLARE


nr_seq_prescr_w			prescr_procedimento.nr_sequencia%type;
ie_status_atend_w		prescr_procedimento.ie_status_atend%type;

nr_seq_exame_w			exame_laboratorio.nr_seq_exame%type;

nr_seq_resultado_w		exame_lab_resultado.nr_seq_resultado%type;

nr_seq_material_w		exame_lab_result_item.nr_seq_material%type;
qt_resultado_w			exame_lab_result_item.qt_resultado%type;
pr_resultado_w			exame_lab_result_item.pr_resultado%type;
ds_resultado_w			exame_lab_result_item.ds_resultado%type;

ds_erro_w				varchar(4000);

c02 CURSOR FOR
	SELECT	r.nr_seq_exame,
		coalesce(r.qt_resultado,0),
		r.pr_resultado,
		r.ds_resultado
	from    exame_lab_result_item r,
			exame_laboratorio e
	where   r.nr_seq_resultado	= nr_seq_resultado_w
	and   	r.nr_seq_prescr		= nr_seq_prescr_w
	and   	((r.qt_resultado <> 0) or (r.pr_resultado <> 0) or (r.ds_resultado IS NOT NULL AND r.ds_resultado::text <> ''))
	and   	r.nr_seq_exame 		= e.nr_seq_exame
	order   by 	r.nr_sequencia,
		e.nr_seq_apresent;


BEGIN


begin

select	max(a.nr_sequencia),
		coalesce(max(ie_status_atend),0)
into STRICT	nr_seq_prescr_w,
		ie_status_atend_w
from  	prescr_procedimento a
where 	a.nr_prescricao = nr_prescricao_p
and		a.nr_seq_interno = nr_seq_interno_p;

select	max(nr_seq_resultado)
into STRICT	nr_seq_resultado_w
from	exame_lab_resultado
where	nr_prescricao = nr_prescricao_p;

if (nr_seq_resultado_w IS NOT NULL AND nr_seq_resultado_w::text <> '') and (nr_seq_prescr_w IS NOT NULL AND nr_seq_prescr_w::text <> '') /*and
		(ie_status_atend_w <= 30)*/
 then

	select	max(nr_seq_material)
	into STRICT	nr_seq_material_w
	from 	exame_lab_result_item
	where 	nr_seq_resultado	= nr_seq_resultado_w
	and 	nr_seq_prescr		= nr_seq_prescr_w
	and 	(nr_seq_material IS NOT NULL AND nr_seq_material::text <> '');

	open c02;
	loop
	fetch c02 into	nr_seq_exame_w,
			qt_resultado_w,
			pr_resultado_w,
			ds_resultado_w;
		EXIT WHEN NOT FOUND; /* apply on c02 */

		ds_resultado_w := calcular_valores_exame(nr_seq_resultado_w, nr_prescricao_p, nr_seq_prescr_w, nr_seq_material_w, nr_seq_exame_w, qt_resultado_w, pr_resultado_w, ds_resultado_w);


	end loop;
	close c02;

	delete	FROM result_laboratorio
	where	nr_prescricao = nr_prescricao_p
	and		nr_seq_prescricao = nr_seq_prescr_w;

	update	prescr_procedimento
	set		ie_status_atend = 35
	where	nr_prescricao = nr_prescricao_p
	and		nr_sequencia = nr_seq_prescr_w
	and		ie_status_atend < 35;

end if;




exception
when others then
	ds_erro_w	:= substr(sqlerrm,1,1000);
	CALL gravar_log_lab(69999,
			substr('ECE - '||
			obter_desc_expressao(712423)||' '||
			obter_desc_expressao(722599)||' '||nr_seq_resultado_w||' - '||
			obter_desc_expressao(325814)||' '||nr_prescricao_p||' - '||
			'seq_prescricao: '||nr_seq_prescr_w||' - '||
			obter_desc_expressao(326091)||' '||nr_seq_material_w||' - '||
			obter_desc_expressao(621805)||' '||nr_seq_exame_w||' - '||
			'qt_resultado: '||qt_resultado_w||' - '||
			'pr_resultado: '||pr_resultado_w||' - '||
			obter_desc_expressao(504115)||' '||ds_erro_w,1,2000), 'ECE', nr_prescricao_p);
end;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ece_aprovar_resultado ( nr_prescricao_p bigint, nr_seq_interno_p bigint, cd_exame_princ_p text) FROM PUBLIC;

