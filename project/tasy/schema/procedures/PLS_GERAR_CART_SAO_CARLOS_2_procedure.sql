-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_gerar_cart_sao_carlos_2 ( nr_seq_lote_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) AS $body$
DECLARE

 
ds_header_w			varchar(4000);
ds_sub_header_w			varchar(4000);
cd_usuario_plano_w		varchar(24);
nm_beneficiario_w		varchar(250);
tp_contratacao_w		varchar(20);
dt_nascimento_w			varchar(12);
dt_validade_carteira_w		varchar(20);
cd_local_cobranca_w		varchar(20);
ds_produto_w			varchar(50);
cd_abrangencia_w		varchar(50);
ds_abrangencia_w		varchar(50);
ds_registro_ans_w		varchar(50);
ds_acomodacao_w			varchar(50);
ds_mensagem_cpt_w		varchar(15);
nm_empresa_w			varchar(50);
ds_rede_atendimento_w		varchar(50);
ds_carencia1_w			w_pls_interface_carteira.ds_carencia_1%type;
ds_carencia2_w			w_pls_interface_carteira.ds_carencia_2%type;
ds_carencia3_w			w_pls_interface_carteira.ds_carencia_3%type;
ds_carencia4_w			w_pls_interface_carteira.ds_carencia_4%type;
ds_carencia5_w			w_pls_interface_carteira.ds_carencia_5%type;
ds_carencia6_w			w_pls_interface_carteira.ds_carencia_6%type;
ds_carencia7_w			w_pls_interface_carteira.ds_carencia_7%type;
ds_carencia8_w			w_pls_interface_carteira.ds_carencia_8%type;
ds_carencia9_w			w_pls_interface_carteira.ds_carencia_9%type;
ds_carencia10_w			w_pls_interface_carteira.ds_carencia_10%type;
ds_carencia11_w			w_pls_interface_carteira.ds_carencia_11%type;
ds_carencia12_w			w_pls_interface_carteira.ds_carencia_12%type;
nr_via_solicitacao_w		varchar(255);
ds_regiao_w			varchar(4000);
ds_trilha_1_w			w_pls_interface_carteira.ds_trilha_1%type;
ds_trilha_2_w			w_pls_interface_carteira.ds_trilha_2%type;
nr_protocolo_ans_w		varchar(100);
dt_contratacao_w		timestamp;
ds_mensagem_w			varchar(100);
dt_inclusao_operadora_w		timestamp;
nr_seq_contrato_w		bigint;
ds_mensagem_cart_w		varchar(255);
ds_mens_carencia_w		varchar(255);
ds_mensagem_carencia_w		varchar(255);
cd_cgc_estipulante_w		varchar(20);
cd_pf_estipulante_w		varchar(20);
nr_seq_plano_w			bigint;
nr_seq_regiao_w			bigint;
ie_tipo_segurado_w		varchar(10);
ds_congenere_w			varchar(255);
ie_cpt_1044_w			varchar(1);
ds_tipo_acomodacao_w		varchar(255);
cd_rede_refer_ptu_w		pls_plano.cd_rede_refer_ptu%type;
ie_tipo_contratacao_w		pls_plano.ie_tipo_contratacao%type;
nm_fantasia_w			pls_plano.nm_fantasia%type;
nr_seq_localizacao_benef_w	pls_segurado.nr_seq_localizacao_benef%type;
ds_localizacao_w		pls_localizacao_benef.ds_localizacao%type;
nr_seq_intercambio_w		pls_intercambio.nr_sequencia%type;
ds_regiao_1_w			varchar(75);
ds_regiao_2_w			varchar(75);
ds_regiao_3_w			varchar(75);
ds_regiao_4_w			varchar(75);
ds_regiao_5_w			varchar(75);
ie_situacao_trabalhista_w	pls_segurado.ie_situacao_trabalhista%type;

C01 CURSOR(nr_seq_lote_p	pls_lote_carteira.nr_sequencia%type) FOR 
	SELECT	b.nr_sequencia		nr_seq_segurado 
	from	pls_segurado_carteira	a, 
		pls_segurado		b, 
		pls_carteira_emissao	c, 
		pls_lote_carteira	d 
	where	a.nr_seq_segurado	= b.nr_sequencia 
	and	c.nr_seq_seg_carteira	= a.nr_sequencia 
	and	c.nr_seq_lote		= d.nr_sequencia 
	and	d.nr_sequencia		= nr_seq_lote_p;

C02 CURSOR(	nr_seq_plano_p		pls_plano_area.nr_seq_plano%type) FOR 
	SELECT	c.ds_municipio 
	from	pls_plano_area		a, 
		pls_regiao_local	b, 
		sus_municipio		c 
	where	c.cd_municipio_ibge	= b.cd_municipio_ibge 
	and	b.nr_seq_regiao		= a.nr_seq_regiao 
	and	a.nr_seq_plano		= nr_seq_plano_p;

C03 CURSOR(	nr_seq_plano_p		pls_plano_area.nr_seq_plano%type) FOR 
	SELECT	b.sg_uf_municipio 
	from	pls_plano_area		a, 
		pls_regiao_local	b 
	where	b.nr_seq_regiao		= a.nr_seq_regiao 
	and	a.nr_seq_plano		= nr_seq_plano_p;

BEGIN 
 
delete	FROM w_pls_interface_carteira 
where	nr_seq_lote	= nr_seq_lote_p;
 
for c01_w in C01(nr_seq_lote_p) loop 
	select	c.cd_usuario_plano, 
		substr((CASE WHEN (trim(both nm_abreviado) IS NOT NULL AND (trim(both nm_abreviado))::text <> '') THEN upper(nm_abreviado) ELSE pls_gerar_nome_abreviado(a.nm_pessoa_fisica) END), 1, 25), 
		to_char(a.dt_nascimento, 'dd/mm/yyyy'),			 
		substr(coalesce(pls_obter_dados_cart_unimed(b.nr_sequencia, d.nr_sequencia, 'DA', 1), 'NÃO SE APLICA'), 1, 50), 
		to_char(c.dt_validade_carteira, 'dd/mm/yyyy'), 
		CASE WHEN d.ie_tipo_contratacao='I' THEN  '2-FÍSICA' WHEN d.ie_tipo_contratacao='CA' THEN  '4-ADESÃO' WHEN d.ie_tipo_contratacao='CE' THEN  '3-EMPRESARIAL' END , 
		CASE WHEN d.ie_regulamentacao='R' THEN  'Plano Não Regulamentado' WHEN d.ie_regulamentacao='P' THEN  'Plano Regulamentado' WHEN d.ie_regulamentacao='A' THEN  'Plano Adaptado' END , 
		d.ie_abrangencia, 
		CASE WHEN d.ie_abrangencia='N' THEN 'NA' WHEN d.ie_abrangencia='GE' THEN 'RA' WHEN d.ie_abrangencia='GM' THEN 'RB' WHEN d.ie_abrangencia='E' THEN 'ES' WHEN d.ie_abrangencia='M' THEN 'MU' END , 
		lpad(to_char(c.nr_via_solicitacao), 2, '0'), 
		d.nr_sequencia, 
		'Cód. Prod. ANS:' || CASE WHEN d.ie_regulamentacao='R' THEN d.cd_scpa  ELSE d.nr_protocolo_ans END , 
		replace(replace(ds_trilha1, ';', ''),'%',''), 
		replace(ds_trilha2, ';', ''), 
		b.dt_contratacao, 
		b.dt_inclusao_operadora, 
		b.ie_tipo_segurado, 
		b.nr_seq_contrato, 
		CASE WHEN ie_acomodacao='I' THEN  'Individual'  WHEN ie_acomodacao='C' THEN 'Coletivo'  ELSE 'Não se aplica' END  ds_tipo_acomodacao, 
		substr(d.ds_carteira_acomodacao, 1, 17), 
		d.ie_tipo_contratacao, 
		d.nm_fantasia, 
		nr_seq_localizacao_benef, 
		b.nr_seq_intercambio, 
		b.ie_situacao_trabalhista 
	into STRICT	cd_usuario_plano_w, 
		nm_beneficiario_w, 
		dt_nascimento_w, 
		ds_produto_w, 
		dt_validade_carteira_w, 
		tp_contratacao_w, 
		ds_registro_ans_w, 
		cd_abrangencia_w, 
		ds_abrangencia_w, 
		nr_via_solicitacao_w, 
		nr_seq_plano_w, 
		nr_protocolo_ans_w, 
		ds_trilha_1_w, 
		ds_trilha_2_w, 
		dt_contratacao_w, 
		dt_inclusao_operadora_w, 
		ie_tipo_segurado_w, 
		nr_seq_contrato_w, 
		ds_tipo_acomodacao_w, 
		ds_acomodacao_w, 
		ie_tipo_contratacao_w, 
		nm_fantasia_w, 
		nr_seq_localizacao_benef_w, 
		nr_seq_intercambio_w, 
		ie_situacao_trabalhista_w 
	from	pls_plano		d, 
		pls_segurado_carteira	c, 
		pls_segurado		b, 
		pessoa_fisica		a 
	where	c.nr_seq_segurado	= b.nr_sequencia 
	and	b.nr_seq_plano		= d.nr_sequencia 
	and	b.cd_pessoa_fisica	= a.cd_pessoa_fisica 
	and	b.nr_sequencia		= c01_w.nr_seq_segurado;
	 
	if (nr_seq_contrato_w IS NOT NULL AND nr_seq_contrato_w::text <> '') then 
		select	a.cd_pf_estipulante, 
			a.cd_cgc_estipulante 
		into STRICT	cd_pf_estipulante_w, 
			cd_cgc_estipulante_w 
		from	pls_contrato a 
		where	a.nr_sequencia = nr_seq_contrato_w;
		 
		select	max(ds_mensagem) 
		into STRICT	ds_mensagem_carencia_w 
		from	pls_contrato_mensagem_cart 
		where	nr_seq_contrato			= nr_seq_contrato_w 
		and	coalesce(ie_mensagem_carencia,'N')	= 'S' 
		and	ie_mensagem_abrangencia		= 'N' 
		and	ie_situacao			= 'A' 
		and	clock_timestamp() between coalesce(dt_inicio_vigencia,clock_timestamp()) and coalesce(dt_fim_vigencia,clock_timestamp());
	elsif (nr_seq_intercambio_w IS NOT NULL AND nr_seq_intercambio_w::text <> '') then 
		select	a.cd_pessoa_fisica, 
			a.cd_cgc 
		into STRICT	cd_pf_estipulante_w, 
			cd_cgc_estipulante_w 
		from	pls_intercambio a 
		where	a.nr_sequencia = nr_seq_intercambio_w;
		 
		select	max(ds_mensagem) 
		into STRICT	ds_mensagem_carencia_w 
		from	pls_contrato_mensagem_cart 
		where	nr_seq_intercambio		= nr_seq_intercambio_w 
		and	coalesce(ie_mensagem_carencia,'N')	= 'S' 
		and	ie_mensagem_abrangencia		= 'N' 
		and	ie_situacao			= 'A' 
		and	clock_timestamp() between coalesce(dt_inicio_vigencia,clock_timestamp()) and coalesce(dt_fim_vigencia,clock_timestamp());
	end if;
	 
	if (nr_seq_plano_w IS NOT NULL AND nr_seq_plano_w::text <> '') then 
		select	substr(cd_rede_refer_ptu,1,2) 
		into STRICT	cd_rede_refer_ptu_w 
		from	pls_plano 
		where	nr_sequencia = nr_seq_plano_w;
		 
		ds_rede_atendimento_w	:= cd_rede_refer_ptu_w || ' '|| substr(pls_obter_rede_ref_produto(nr_seq_plano_w,cd_estabelecimento_p,'DT'), 1, 30);
	end if;
	 
	cd_usuario_plano_w	:= substr(cd_usuario_plano_w,1,1)||' '||substr(cd_usuario_plano_w,2,3)||' '||substr(cd_usuario_plano_w,5,12)||' '||substr(cd_usuario_plano_w,17,1);
	 
	if (ie_tipo_contratacao_w = 'I') then 
		nm_empresa_w	:= substr(nm_fantasia_w,1,18);
	else 
		nm_empresa_w	:= substr(coalesce(obter_dados_pf_pj('',cd_cgc_estipulante_w,'ABV'),obter_dados_pf_pj('',cd_cgc_estipulante_w,'F')),1,18);
	end if;
	 
	ds_regiao_w	:= '';
	ds_regiao_1_w	:= '';
	ds_regiao_2_w	:= '';
	ds_regiao_3_w	:= '';
	ds_regiao_4_w	:= '';
	ds_regiao_5_w	:= '';
	 
	if (ie_tipo_segurado_w = 'R') then 
		select	max(b.nm_fantasia) 
		into STRICT	ds_congenere_w 
		from	pls_segurado_repasse	c, 
			pessoa_juridica		b, 
			pls_congenere		a 
		where	b.cd_cgc		= a.cd_cgc 
		and	a.nr_sequencia		= c.nr_seq_congenere_atend 
		and	c.nr_seq_segurado	= c01_w.nr_seq_segurado 
		and	(c.dt_liberacao IS NOT NULL AND c.dt_liberacao::text <> '') 
		and	coalesce(c.dt_fim_repasse::text, '') = '';
		 
		ds_regiao_1_w	:= 'REPASSE ATT. ' || ds_congenere_w;
	else 
		if (cd_abrangencia_w = 'GM') then 
			for c02_w in C02(nr_seq_plano_w) loop 
				if (length(ds_regiao_1_w || c02_w.ds_municipio) + 2 <= 42) then 
					ds_regiao_1_w := ' ' || c02_w.ds_municipio || ',' || ds_regiao_1_w;
				elsif (length(ds_regiao_2_w || c02_w.ds_municipio) + 2 <= 75) then 
					ds_regiao_2_w := ' ' || c02_w.ds_municipio || ',' || ds_regiao_2_w;
				elsif (length(ds_regiao_3_w || c02_w.ds_municipio) + 2 <= 75) then 
					ds_regiao_3_w := ' ' || c02_w.ds_municipio || ',' || ds_regiao_3_w;
				elsif (length(ds_regiao_4_w || c02_w.ds_municipio) + 2 <= 75) then 
					ds_regiao_4_w := ' ' || c02_w.ds_municipio || ',' || ds_regiao_4_w;
				elsif (length(ds_regiao_5_w || c02_w.ds_municipio) + 2 <= 75) then 
					ds_regiao_5_w := ' ' || c02_w.ds_municipio || ' ' || ds_regiao_5_w;
				end if;
			end loop;
			 
			ds_regiao_1_w := 'Abrangência Grupo de Municípios:' || ds_regiao_1_w;
		elsif (cd_abrangencia_w = 'GE') then 
			for c03_w in C03(nr_seq_plano_w) loop 
				if (length(ds_regiao_1_w || c03_w.sg_uf_municipio) + 2 <= 45) then 
					ds_regiao_1_w := ' ' || c03_w.sg_uf_municipio || ',' || ds_regiao_1_w;
				elsif (length(ds_regiao_2_w || c03_w.sg_uf_municipio) + 2 <= 75) then 
					ds_regiao_2_w := ' ' || c03_w.sg_uf_municipio || ',' || ds_regiao_2_w;
				elsif (length(ds_regiao_3_w || c03_w.sg_uf_municipio) + 2 <= 75) then 
					ds_regiao_3_w := ' ' || c03_w.sg_uf_municipio || ',' || ds_regiao_3_w;
				elsif (length(ds_regiao_4_w || c03_w.sg_uf_municipio) + 2 <= 75) then 
					ds_regiao_4_w := ' ' || c03_w.sg_uf_municipio || ',' || ds_regiao_4_w;
				elsif (length(ds_regiao_5_w || c03_w.sg_uf_municipio) + 2 <= 75) then 
					ds_regiao_5_w := ' ' || c03_w.sg_uf_municipio || ',' || ds_regiao_5_w;
				end if;
			end loop;
			 
			ds_regiao_1_w := 'Abrangência Grupo de Estados: ' || ds_regiao_1_w;
		end if;
	end if;
	 
	if (ds_regiao_5_w IS NOT NULL AND ds_regiao_5_w::text <> '') then 
		if (substr(ds_regiao_5_w, length(ds_regiao_5_w), 1) = ',') then 
			ds_regiao_5_w:= substr(ds_regiao_5_w, 1, length(ds_regiao_5_w) - 1);
		end if;
	elsif (ds_regiao_4_w IS NOT NULL AND ds_regiao_4_w::text <> '') then 
		if (substr(ds_regiao_4_w, length(ds_regiao_4_w), 1) = ',') then 
			ds_regiao_4_w:= substr(ds_regiao_4_w, 1, length(ds_regiao_4_w) - 1);
		end if;
	elsif (ds_regiao_3_w IS NOT NULL AND ds_regiao_3_w::text <> '') then 
		if (substr(ds_regiao_3_w, length(ds_regiao_3_w), 1) = ',') then 
			ds_regiao_3_w:= substr(ds_regiao_3_w, 1, length(ds_regiao_3_w) - 1);
		end if;
	elsif (ds_regiao_2_w IS NOT NULL AND ds_regiao_2_w::text <> '') then 
		if (substr(ds_regiao_2_w, length(ds_regiao_2_w), 1) = ',') then 
			ds_regiao_2_w:= substr(ds_regiao_2_w, 1, length(ds_regiao_2_w) - 1);
		end if;
	else 
		if (substr(ds_regiao_1_w, length(ds_regiao_1_w), 1) = ',') then 
			ds_regiao_1_w:= substr(ds_regiao_1_w, 1, length(ds_regiao_1_w) - 1);
		end if;
	end if;
	 
	ds_regiao_2_w	:= coalesce(substr(ds_regiao_2_w, 2, length(ds_regiao_2_w) - 1), ' ');
	ds_regiao_3_w	:= coalesce(substr(ds_regiao_3_w, 2, length(ds_regiao_3_w) - 1), ' ');
	ds_regiao_4_w	:= coalesce(substr(ds_regiao_4_w, 2, length(ds_regiao_4_w) - 1), ' ');
	ds_regiao_5_w	:= coalesce(substr(ds_regiao_5_w, 2, length(ds_regiao_5_w) - 1), ' ');
	 
	ds_regiao_w	:= rpad(ds_regiao_1_w, 75) || ' ' || rpad(ds_regiao_2_w, 75) || ' ' || rpad(ds_regiao_3_w, 75) || ' ' || rpad(ds_regiao_4_w, 75) || ' ' || rpad(ds_regiao_5_w, 75);
	 
	ds_mensagem_cpt_w	:= pls_obter_dados_cart_unimed(c01_w.nr_seq_segurado, nr_seq_plano_w,'DCPT',6);
	 
	nm_beneficiario_w	:= Elimina_Acentuacao(nm_beneficiario_w);
	ds_regiao_w		:= Elimina_Acentuacao(ds_regiao_w);
	ds_produto_w		:= Elimina_Acentuacao(ds_produto_w);
	 
	cd_local_cobranca_w	:= lpad(pls_obter_area_cobranca(c01_w.nr_seq_segurado,cd_estabelecimento_p),4,'0');
	 
	if ((trim(both ds_mensagem_carencia_w) IS NOT NULL AND (trim(both ds_mensagem_carencia_w))::text <> '')) then 
		ds_carencia1_w	:= 	ds_mensagem_carencia_w;
	else 
		ds_carencia1_w	:= Elimina_Acentuacao(pls_obter_dados_cart_unimed(c01_w.nr_seq_segurado, nr_seq_plano_w, 'CAM7', 1));
		ds_carencia2_w	:= Elimina_Acentuacao(pls_obter_dados_cart_unimed(c01_w.nr_seq_segurado, nr_seq_plano_w, 'CAM7', 2));
		ds_carencia3_w	:= Elimina_Acentuacao(pls_obter_dados_cart_unimed(c01_w.nr_seq_segurado, nr_seq_plano_w, 'CAM7', 3));
		ds_carencia4_w	:= Elimina_Acentuacao(pls_obter_dados_cart_unimed(c01_w.nr_seq_segurado, nr_seq_plano_w, 'CAM7', 4));
		ds_carencia5_w	:= Elimina_Acentuacao(pls_obter_dados_cart_unimed(c01_w.nr_seq_segurado, nr_seq_plano_w, 'CAM7', 5));
		ds_carencia6_w	:= Elimina_Acentuacao(pls_obter_dados_cart_unimed(c01_w.nr_seq_segurado, nr_seq_plano_w, 'CAM7', 6));
		ds_carencia7_w	:= Elimina_Acentuacao(pls_obter_dados_cart_unimed(c01_w.nr_seq_segurado, nr_seq_plano_w, 'CAM7', 7));
		ds_carencia8_w	:= Elimina_Acentuacao(pls_obter_dados_cart_unimed(c01_w.nr_seq_segurado, nr_seq_plano_w, 'CAM7', 8));
		ds_carencia9_w	:= Elimina_Acentuacao(pls_obter_dados_cart_unimed(c01_w.nr_seq_segurado, nr_seq_plano_w, 'CAM7', 9));
		ds_carencia10_w	:= Elimina_Acentuacao(pls_obter_dados_cart_unimed(c01_w.nr_seq_segurado, nr_seq_plano_w, 'CAM7', 10));
		ds_carencia11_w	:= Elimina_Acentuacao(pls_obter_dados_cart_unimed(c01_w.nr_seq_segurado, nr_seq_plano_w, 'CAM7', 11));
		ds_carencia12_w	:= Elimina_Acentuacao(pls_obter_dados_cart_unimed(c01_w.nr_seq_segurado, nr_seq_plano_w, 'CAM7', 12));
	end if;
	 
	insert into w_pls_interface_carteira(	nr_sequencia, dt_atualizacao, nm_usuario, dt_atualizacao_nrec, nm_usuario_nrec, nr_seq_lote, ie_tipo_reg, 
			cd_usuario_plano, dt_nascimento, ds_tipo_contratacao, dt_validade_carteira, nm_beneficiario, cd_local_cobranca, nm_plano, 
			ds_abrangencia, ds_registro_ans, ds_acomodacao, dt_cpt, ds_rede_atendimento, nr_protocolo_ans, 
			ds_trilha_1, ds_trilha_2, nr_via_cartao, ds_regiao, ds_estipulante, ds_observacao_2, 
			ds_carencia_1, ds_carencia_2, ds_carencia_3, ds_carencia_4, ds_carencia_5, ds_carencia_6, 
			ds_carencia_7, ds_carencia_8, ds_carencia_9, ds_carencia_10, ds_carencia_11, ds_carencia_12) 
	values (	nextval('w_pls_interface_carteira_seq'), clock_timestamp(), nm_usuario_p, clock_timestamp(), nm_usuario_p, nr_seq_lote_p, 2, 
			cd_usuario_plano_w, dt_nascimento_w, tp_contratacao_w, dt_validade_carteira_w, nm_beneficiario_w, cd_local_cobranca_w, ds_produto_w, 
			ds_abrangencia_w||cd_rede_refer_ptu_w, ds_registro_ans_w, ds_acomodacao_w, ds_mensagem_cpt_w, ds_rede_atendimento_w, nr_protocolo_ans_w, 
			rpad(ds_trilha_1_w, 50), rpad(ds_trilha_2_w, 50), nr_via_solicitacao_w, ds_regiao_w, nm_empresa_w,ds_tipo_acomodacao_w, 
			ds_carencia1_w, ds_carencia2_w, ds_carencia3_w, ds_carencia4_w, ds_carencia5_w, ds_carencia6_w, 
			ds_carencia7_w, ds_carencia8_w, ds_carencia9_w, ds_carencia10_w, ds_carencia11_w,ds_carencia12_w);
end loop;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_gerar_cart_sao_carlos_2 ( nr_seq_lote_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) FROM PUBLIC;

