-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_emprestimo_reabilitacao (nr_seq_equip_reab_p bigint, dt_envio_p timestamp, dt_retorno_p timestamp, cd_estabelecimento_p bigint, nm_usuario_p text, ds_mensagem_p INOUT text) AS $body$
DECLARE



cd_pessoa_fisica_w			varchar(10);
cd_material_w				integer;
cd_equipamento_w			bigint;
cd_local_estoque_w			smallint;
nr_emprestimo_w				bigint;
nr_sequencia_w				bigint;
ds_texto_w				varchar(255);


BEGIN

SELECT	b.cd_pessoa_fisica,
	c.cd_material,
	a.nr_seq_equipamento
INTO STRICT	cd_pessoa_fisica_w,
	cd_material_w,
	cd_equipamento_w
FROM	rp_equipamento a,
	rp_paciente_reabilitacao b,
	man_equipamento c
WHERE	b.nr_sequencia = a.nr_seq_pac_reab
AND	c.nr_sequencia = a.nr_seq_equipamento
AND	a.nr_sequencia = nr_seq_equip_reab_p;

-- local de estoque do setor logado:
SELECT	obter_local_estoque_setor(wheb_usuario_pck.get_cd_setor_atendimento, cd_estabelecimento_p)
INTO STRICT	cd_local_estoque_w
;

if (coalesce(cd_local_estoque_w,0) = 0) then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(280369);
end if;

if (coalesce(cd_material_w,0) = 0) then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(281148);
end if;

if (coalesce(dt_envio_p::text, '') = '') then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(282231);
end if;

SELECT	nextval('emprestimo_seq')
INTO STRICT	nr_emprestimo_w
;

INSERT INTO emprestimo(
	nr_emprestimo,
	cd_estabelecimento,
	cd_local_estoque,
	ie_tipo,
	dt_emprestimo,
	dt_atualizacao,
	nm_usuario,
	cd_pessoa_fisica,
	nr_documento,
	nm_usuario_resp,
	dt_prev_retorno,
	ie_situacao)
VALUES (	nr_emprestimo_w,
	cd_estabelecimento_p,
	cd_local_estoque_w,
	'S',
	dt_envio_p,
	clock_timestamp(),
	nm_usuario_p,
	cd_pessoa_fisica_w,
	nr_seq_equip_reab_p,
	nm_usuario_p,
	dt_retorno_p,
	'A');

SELECT	coalesce(MAX(nr_sequencia),0) +1
INTO STRICT	nr_sequencia_w
FROM	emprestimo_material
WHERE	nr_emprestimo = nr_emprestimo_w;

INSERT INTO emprestimo_material(
	nr_sequencia,
	nr_emprestimo,
	cd_material,
	qt_material,
	dt_atualizacao,
	nm_usuario,
	qt_emprestimo)
VALUES (	nr_sequencia_w,
	nr_emprestimo_w,
	cd_material_w,
	1,
	clock_timestamp(),
	nm_usuario_p,
	1);

UPDATE	rp_equipamento
SET	nr_emprestimo 		= nr_emprestimo_w,
	nr_seq_emp_material 	= nr_sequencia_w
where	nr_sequencia 		= nr_seq_equip_reab_p;

ds_texto_w := substr(obter_texto_dic_objeto(279807, 1, 'NR_EMPRESTIMO=' || nr_emprestimo_w),1,255);

-- Registrar Empr√©stimo no historico do equipamento:
CALL man_log_equip_hist_evento(	cd_equipamento_w,
				ds_texto_w,
				'E',
				nm_usuario_p);

COMMIT;

-- Liberar Emprestimo
CALL liberar_emprestimo(nr_emprestimo_w, nm_usuario_p);

ds_mensagem_p := ds_texto_w;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_emprestimo_reabilitacao (nr_seq_equip_reab_p bigint, dt_envio_p timestamp, dt_retorno_p timestamp, cd_estabelecimento_p bigint, nm_usuario_p text, ds_mensagem_p INOUT text) FROM PUBLIC;

