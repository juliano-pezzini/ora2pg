-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_valida_imp_contest (nr_seq_lote_p pls_lote_contestacao.nr_sequencia%type) AS $body$
DECLARE


nr_seq_mensagem_w	bigint :=0;
nr_seq_lote_p_w		pls_lote_contestacao.nr_sequencia%type;

-- Valida se existe algum questionamento que não possui o nr_seq_conta informado, caracterizando que o serviço importado
c01 CURSOR(	nr_seq_lote_pc	 pls_lote_contestacao.nr_sequencia%type) FOR
	SELECT	b.nr_sequencia nr_seq_camara_contest
	from	pls_lote_contestacao	a,
		ptu_camara_contestacao	b,
		ptu_questionamento	c
	where	a.nr_sequencia		= nr_seq_lote_pc
	and	(a.nr_seq_pls_fatura IS NOT NULL AND a.nr_seq_pls_fatura::text <> '')
	and	coalesce(c.nr_seq_conta::text, '') = ''
	and	b.nr_seq_lote_contest	= a.nr_sequencia
	and	c.nr_seq_contestacao	= b.nr_sequencia;
BEGIN
	nr_seq_lote_p_w := nr_seq_lote_p;

	-- Apenas realiza o teste se não possuir nehuma mensagem.
	if (nr_seq_mensagem_w = 0) then

		-- Se não gerou nenhum lote, quer dizer que não foi localizada nenhuma fatura para  contestação
		if (coalesce(nr_seq_lote_p_w::text, '') = '') then
			nr_seq_mensagem_w := 391497; -- 391497 - Não foi localizada a fatura para esta contestação importada.
		end if;
	end if;

	-- Apenas realiza o teste se não possuir nehuma mensagem.
	if (nr_seq_mensagem_w = 0) and (nr_seq_lote_p_w IS NOT NULL AND nr_seq_lote_p_w::text <> '') then
		-- Valida se existe algum questionamento que não possui o nr_seq_conta informado, caracterizando que o serviço importado
		-- não foi faturado pelo PTU
		for r_c01_w in c01(nr_seq_lote_p_w) loop
			-- atualiza o status para "IN" - Inválido
			CALL ptu_atualizar_status_imp_a550(r_c01_w.nr_seq_camara_contest, 'IN', 'S');
			nr_seq_mensagem_w := 391498;
		end loop;
	end if;

	-- Se possui alguma inconsistência, gera a mensagem
	if (nr_seq_mensagem_w <> 0) then
		CALL wheb_mensagem_pck.exibir_mensagem_abort(nr_seq_mensagem_w);
	end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_valida_imp_contest (nr_seq_lote_p pls_lote_contestacao.nr_sequencia%type) FROM PUBLIC;

