-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE rep_copia_recomendacao ( nr_prescricao_orig_p bigint, nr_prescricao_p bigint, nr_seq_regra_p bigint, dt_prescricao_p timestamp, nm_usuario_p text) AS $body$
DECLARE


nr_seq_acum_w			bigint;
cd_estabelecimento_w	bigint;
cd_recomendacao_w		bigint;
cd_convenio_w			bigint;
nr_seq_agrupamento_w	bigint;
cd_setor_prescricao_w	bigint;
ie_seleciona_kit_rec_w	varchar(1);
nr_sequencia_w			bigint;
ie_destino_rec_w		varchar(3);
ds_recomendacao_w		varchar(4000);
qt_recomendacao_w		double precision;
cd_intervalo_w			varchar(15);
nr_seq_classif_w		bigint;
ds_horarios_w			varchar(4000);
ds_horarios2_w			varchar(4000);
ds_observacao_w			varchar(4000);
cd_kit_w				bigint;
ie_copiar_w				varchar(1);
ie_regra_geral_w		varchar(15);
nr_seq_regra_copia_w	bigint;
ie_manter_intervalo_w	varchar(1);
ie_urgencia_w			varchar(1);
dt_inicio_item_w		timestamp;
dt_prescricao_w			timestamp;
dt_inicio_prescr_w		timestamp;
dt_inicio_w				timestamp;
dt_final_w				timestamp;
ie_operacao_w			varchar(15);
qt_operacao_w			double precision;
nr_atendimento_w		bigint;
hr_prim_horario_w		varchar(5);
nr_ocorrencia_w			double precision;
nr_horas_validade_w		bigint;
qt_espacos_w			bigint;
cd_perfil_w				bigint;
qt_regra_w				bigint;
ie_se_necessario_w		varchar(1);
ie_acm_w				varchar(1);
cd_protocolo_prescr_w	prescr_medica.cd_protocolo%type;
nr_seq_prot_prescr_w	prescr_medica.nr_seq_protocolo%type;
ie_atualizar_kit_rec_w 	varchar(1);


c00 CURSOR FOR
SELECT 	a.nr_sequencia + nr_seq_acum_w,
		a.ie_destino_rec,
		a.ds_recomendacao,
		a.qt_recomendacao,
		a.cd_intervalo,
		a.nr_seq_classif,
		a.cd_recomendacao,
		a.ds_horarios,
		a.ds_observacao,
		a.nr_sequencia,
		a.cd_kit,
		coalesce(a.ie_acm,'N'),
		coalesce(a.ie_se_necessario,'N'),
		coalesce(a.ie_urgencia,'N')
FROM prescr_recomendacao a
LEFT OUTER JOIN tipo_recomendacao b ON (a.cd_recomendacao = b.cd_tipo_recomendacao)
WHERE coalesce(b.ie_copia,'S')	= 'S'  and a.ie_suspenso	<> 'S' and a.nr_prescricao	= nr_prescricao_orig_p;

C01 CURSOR FOR
SELECT	cd_kit
from	kit_mat_recomendacao
where	((coalesce(cd_perfil,0) = 0) or (cd_perfil = cd_perfil_w))
and		((coalesce(cd_setor_atendimento,0) = 0) or (cd_setor_atendimento = cd_setor_prescricao_w))
and		((coalesce(cd_convenio::text, '') = '') or (cd_convenio = cd_convenio_w))
and		((coalesce(nr_seq_agrupamento::text, '') = '') or (nr_seq_agrupamento = nr_seq_agrupamento_w))
and		cd_recomendacao  	= cd_recomendacao_w;


BEGIN


cd_perfil_w		:= coalesce(obter_perfil_ativo,0);

select	coalesce(max(nr_sequencia),0)
into STRICT	nr_seq_acum_w
from	prescr_Recomendacao
where	nr_prescricao = nr_prescricao_p;

select	max(cd_estabelecimento),
		max(cd_setor_atendimento),
		max(obter_convenio_atendimento(nr_atendimento)),
		max(dt_prescricao),
		max(dt_inicio_prescr),
		max(nr_atendimento),
		coalesce(max(nr_horas_validade), 24)
into STRICT	cd_estabelecimento_w,
		cd_setor_prescricao_w,
		cd_convenio_w,
		dt_prescricao_w,
		dt_inicio_prescr_w,
		nr_atendimento_w,
		nr_horas_validade_w
from	prescr_medica
where	nr_prescricao	= nr_prescricao_p;

select	max(nr_seq_agrupamento)
into STRICT	nr_seq_agrupamento_w
from	setor_atendimento
where	cd_setor_atendimento = cd_setor_prescricao_w;

ie_seleciona_kit_rec_w := Obter_Param_Usuario(924, 458, cd_perfil_w, nm_usuario_p, cd_estabelecimento_w, ie_seleciona_kit_rec_w);
qt_espacos_w := Obter_Param_Usuario(924, 1033, cd_perfil_w, nm_usuario_p, cd_estabelecimento_w, qt_espacos_w);
ie_atualizar_kit_rec_w := Obter_Param_Usuario(924, 1181, cd_perfil_w, nm_usuario_p, cd_estabelecimento_w, ie_atualizar_kit_rec_w);

if (ie_atualizar_kit_rec_w = 'S') then
	select 	MAX(cd_protocolo),
			MAX(nr_seq_protocolo)
	into STRICT	cd_protocolo_prescr_w,
			nr_seq_prot_prescr_w
	from   	PRESCR_MEDICA
	where 	nr_prescricao = nr_prescricao_p;
end if;

open C00;
loop
fetch C00 into
		nr_sequencia_w,
		ie_destino_rec_w,
		ds_recomendacao_w,
		qt_recomendacao_w,
		cd_intervalo_w,
		nr_seq_classif_w,
		cd_recomendacao_w,
		ds_horarios_w,
		ds_observacao_w,
		nr_sequencia_w,
		cd_kit_w,
		ie_acm_w,
		ie_se_necessario_w,
		ie_urgencia_w;
EXIT WHEN NOT FOUND; /* apply on C00 */

	if (ie_atualizar_kit_rec_w = 'S') then
		if (cd_protocolo_prescr_w IS NOT NULL AND cd_protocolo_prescr_w::text <> '')
			and (nr_seq_prot_prescr_w IS NOT NULL AND nr_seq_prot_prescr_w::text <> '') then
					select	coalesce(max(cd_kit),cd_kit_w)
					into STRICT	cd_kit_w
					from	protocolo_medic_rec
					where	cd_recomendacao = cd_recomendacao_w
					and		cd_protocolo = cd_protocolo_prescr_w
					and		nr_sequencia = nr_seq_prot_prescr_w;
		end if;
	end if;

	select	count(nr_sequencia)
	into STRICT	qt_regra_w
	from	rep_regra_copia_crit
	where	((nr_seq_regra = nr_seq_regra_p) or (coalesce(nr_seq_regra_p,0) = 0))
	and		ie_tipo_item = 'REC';

	if (qt_regra_w	>	0) then
		select	coalesce(max(ie_copiar),'N'),
				max(ie_regra_geral),
				max(nr_sequencia),
				coalesce(max(ie_manter_intervalo), 'N')
		into STRICT	ie_copiar_w,
				ie_regra_geral_w,
				nr_seq_regra_copia_w,
				ie_manter_intervalo_w
		from	rep_regra_copia_crit
		where	((nr_seq_regra = nr_seq_regra_p) or (coalesce(nr_seq_regra_p,0) = 0))
		and		ie_tipo_item = 'REC'
		and (coalesce(ie_agora,'S') = 'S'                or coalesce(ie_urgencia_w,'N') <> 'S');

	else
		ie_copiar_w	:= 'S';
	end if;

	if (ie_copiar_w = 'S') then
		begin
		nr_ocorrencia_w		:= null;
		hr_prim_horario_w	:= null;
		dt_inicio_item_w	:= null;

		if (ie_regra_geral_w = 'H') then
			if (cd_intervalo_w IS NOT NULL AND cd_intervalo_w::text <> '') then

				select	max(ie_operacao),
						max(qt_operacao)
				into STRICT	ie_operacao_w,
						qt_operacao_w
				from	intervalo_prescricao
				where	cd_intervalo	= cd_intervalo_w;

				dt_inicio_w			:= dt_inicio_prescr_w - 5;
				dt_final_w			:= clock_timestamp() + interval '5 days';

				qt_operacao_w		:= obter_ocorrencia_intervalo(cd_intervalo_w, 24, 'H');
				dt_inicio_item_w	:= dt_inicio_prescr_w - qt_operacao_w / 24;

				select	max(c.dt_horario)
				into STRICT	dt_inicio_item_w
				from	prescr_rec_hor c,
						prescr_recomendacao b,
						prescr_medica a
				where	1 = 1
				and		coalesce(c.ie_situacao,'A')	= 'A'
				and		c.nr_seq_recomendacao	= b.nr_sequencia
				and		c.nr_prescricao		= b.nr_prescricao
				and		c.dt_horario		>= dt_inicio_item_w - 220/24
				and 	coalesce(c.ie_horario_especial,'N') <> 'S'
				and		coalesce(b.dt_suspensao::text, '') = ''
				and		(coalesce(a.dt_liberacao_medico, a.dt_liberacao) IS NOT NULL AND (coalesce(a.dt_liberacao_medico, a.dt_liberacao))::text <> '')
				and		b.cd_intervalo		= coalesce(cd_intervalo_w, b.cd_intervalo)
				and 	coalesce(b.qt_recomendacao,0) = coalesce(qt_recomendacao_w, coalesce(b.qt_recomendacao,0))
				and		b.cd_recomendacao	= cd_recomendacao_w
				and		b.nr_prescricao		= a.nr_prescricao
				and		coalesce(a.dt_suspensao::text, '') = ''
				--and	Obter_se_horario_liberado(c.dt_lib_horario, c.dt_horario) = 'S'
				and		a.dt_inicio_prescr between dt_inicio_w and dt_final_w
				and		a.nr_atendimento	= nr_atendimento_w;

				if (dt_inicio_item_w IS NOT NULL AND dt_inicio_item_w::text <> '') then
					dt_inicio_item_w	:= dt_inicio_item_w + qt_operacao_w / 24;
				end if;

				dt_inicio_item_w	:= coalesce(dt_inicio_item_w, dt_inicio_prescr_w);

				if (coalesce(qt_operacao_w,0) > 0) and (ie_operacao_w in ('H')) and (dt_inicio_item_w IS NOT NULL AND dt_inicio_item_w::text <> '') then

					if (ie_operacao_w in ('H')) and (dt_inicio_item_w not between dt_inicio_prescr_w and (dt_inicio_item_w + qt_operacao_w)) then

						while(dt_inicio_item_w not between dt_inicio_prescr_w and (dt_inicio_item_w + qt_operacao_w)) loop
							dt_inicio_item_w	:= dt_inicio_item_w + qt_operacao_w/24;
						end loop;
					end if;
				end if;

				hr_prim_horario_w	:= to_char(dt_inicio_item_w, 'hh24:mi');
				nr_ocorrencia_w	:= 0;
				SELECT * FROM Calcular_Horario_Prescricao(nr_prescricao_p, cd_intervalo_w, dt_inicio_prescr_w, dt_inicio_item_w, nr_horas_validade_w, null, 0/*qt_hora_intervalo_w*/
, 0/*qt_min_intervalo_w*/
, nr_ocorrencia_w, ds_horarios_w, ds_horarios2_w, 'N', null) INTO STRICT nr_ocorrencia_w, ds_horarios_w, ds_horarios2_w;

				ds_horarios_w	:= ds_horarios_w || ds_horarios2_w;

				if (ie_manter_intervalo_w = 'S') then
					ds_horarios_w	:= replace(Eliminar_horarios_vigencia(padroniza_horario_prescr(ds_horarios_w, dt_inicio_prescr_w), cd_intervalo_w, dt_inicio_item_w, dt_inicio_prescr_w, 0/*qt_hora_intervalo_w*/
, 0/*qt_min_intervalo_w*/
, nr_prescricao_p),' ',lpad(' ',qt_espacos_w));
				end if;

			end if;
		else
			dt_inicio_item_w	:= coalesce(dt_inicio_item_w, dt_inicio_prescr_w);
			hr_prim_horario_w	:= to_char(dt_inicio_item_w, 'hh24:mi');
		end if;

		Insert into Prescr_recomendacao(
			nr_prescricao,
			nr_sequencia,
			ie_destino_rec,
			dt_atualizacao,
			nm_usuario,
			ds_recomendacao,
			qt_recomendacao,
			ie_suspenso,
			cd_intervalo,
			nr_seq_classif,
			cd_recomendacao,
			ds_horarios,
			ds_observacao,
			nr_seq_anterior,
			nr_prescricao_original,
			cd_kit,
			ie_se_necessario,
			ie_acm,
			hr_prim_horario,
			nr_ocorrencia)
		values (nr_prescricao_p,
			nr_sequencia_w,
			ie_destino_rec_w,
			dt_prescricao_p,
			nm_usuario_p,
			ds_recomendacao_w,
			qt_recomendacao_w,
			'N',
			cd_intervalo_w,
			nr_seq_classif_w,
			cd_recomendacao_w,
			ds_horarios_w,
			ds_observacao_w,
			nr_sequencia_w,
			nr_prescricao_orig_p,
			cd_kit_w,
			ie_se_necessario_w,
			ie_acm_w,
			hr_prim_horario_w,
			nr_ocorrencia_w);

		if (ie_seleciona_kit_rec_w = 'N') then
			open C01;
			loop
			fetch C01 into
				cd_kit_w;
			EXIT WHEN NOT FOUND; /* apply on C01 */
				CALL Inserir_kit_recomendacao(nm_usuario_p, nr_prescricao_p, nr_sequencia_w, cd_recomendacao_w, cd_kit_w);
			end loop;
			close C01;
		end if;

		end;
	end if;
end loop;
close C00;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE rep_copia_recomendacao ( nr_prescricao_orig_p bigint, nr_prescricao_p bigint, nr_seq_regra_p bigint, dt_prescricao_p timestamp, nm_usuario_p text) FROM PUBLIC;

