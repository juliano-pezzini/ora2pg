-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_tiss_gerar_w_compr_pres (nr_seq_prestador_p text, cd_estabelecimento_p bigint, nm_usuario_p text) AS $body$
DECLARE


cd_guia_w			varchar(20);
cd_ans_w			varchar(6);
cd_operadora_w			varchar(14);
nm_fantasia_w			varchar(70);
cd_cnes_w			varchar(15);
nm_profissional_exec_w		varchar(70);
nr_conselho_w			varchar(2);
nr_pres_conselho_w		varchar(15);
uf_medico_w			varchar(2);
cd_cbos_w			varchar(6);
nr_carteira_w			varchar(20);
nm_beneficiario_w		varchar(70);
nr_seq_guia_principal_w		varchar(20);
qt_beneficiarios_w		bigint;
cd_cgc_w			bigint;
cd_pessoa_fisica_w		bigint;
nr_seq_guia_w			bigint;

c01 CURSOR FOR
	SELECT	substr(pls_obter_dados_segurado(b.nr_seq_segurado,'C'),1,20),
		substr(pls_obter_dados_segurado(b.nr_seq_segurado,'N'),1,70),
		substr(b.nr_seq_guia_principal,1,20)
	from	pls_prestador	a,
		pls_guia_plano	b
	where	b.nr_seq_prestador	= a.nr_sequencia
	and	b.nr_seq_prestador 	= nr_seq_prestador_p;


BEGIN

delete	from w_tiss_contratado_exec
where	nm_usuario		= nm_usuario_p;

delete	from w_tiss_beneficiario
where	nm_usuario		= nm_usuario_p;

commit;

if (nr_seq_prestador_p IS NOT NULL AND nr_seq_prestador_p::text <> '') then
	begin
		select	substr(pls_obter_cod_prestador(nr_seq_prestador_p,null),1,14),
			substr(pls_obter_dados_prestador(nr_seq_prestador_p,'NF'),1,70),
			substr(pls_obter_dados_prestador(nr_seq_prestador_p,'CNES'),1,7),
			substr(obter_dados_medico(b.cd_pessoa_fisica ,'SGCRM'),1,2),
			substr(obter_dados_medico(b.cd_pessoa_fisica ,'CRM'),1,15),
			substr(obter_dados_medico(b.cd_pessoa_fisica ,'UFCRM'),1,2)
		into STRICT	cd_operadora_w,
			nm_fantasia_w,
			cd_cnes_w,
			nr_conselho_w,
			nr_pres_conselho_w,
			uf_medico_w
		from 	pls_guia_plano 	a,
			pls_prestador 	b
		where	a.nr_seq_prestador 	= b.nr_sequencia
		and	a.nr_seq_prestador 	= nr_seq_prestador_p
		and	b.nr_sequencia 		= nr_seq_prestador_p;

		select	b.cd_cgc,
			b.cd_pessoa_fisica
		into STRICT	cd_cgc_w,
			cd_pessoa_fisica_w
		from 	pls_guia_plano 	a,
			pls_prestador 	b
		where	a.nr_seq_prestador 	= b.nr_sequencia
		and	a.nr_seq_prestador 	= nr_seq_prestador_p
		and	b.nr_sequencia 		= nr_seq_prestador_p;

		if (cd_cgc_w IS NOT NULL AND cd_cgc_w::text <> '') then
			select	substr(pls_obter_dados_prestador(nr_seq_prestador_p,'NF'),1,70)
			into STRICT	nm_profissional_exec_w
			from 	pls_guia_plano 	a,
				pls_prestador 	b
			where	a.nr_seq_prestador 	= b.nr_sequencia
			and	a.nr_seq_prestador 	= nr_seq_prestador_p
			and	b.nr_sequencia 		= nr_seq_prestador_p;
		else
			if (cd_pessoa_fisica_w IS NOT NULL AND cd_pessoa_fisica_w::text <> '') then
			select	d.cd_cbo
			into STRICT	cd_cbos_w
			from 	pls_guia_plano 	a,
				pls_prestador 	b,
				pessoa_fisica	c,
				cbo_saude 	d
			where	a.nr_seq_prestador 	= b.nr_sequencia
			and	d.nr_sequencia 		= c.nr_seq_cbo_saude
			and	a.nr_seq_prestador 	= nr_seq_prestador_p
			and	b.nr_sequencia 		= nr_seq_prestador_p
			and	c.cd_pessoa_fisica	= b.cd_pessoa_fisica
			and 	(b.cd_pessoa_fisica IS NOT NULL AND b.cd_pessoa_fisica::text <> '');
			end if;
		end if;
	exception
	when others then
		cd_operadora_w			:= null;
		nm_fantasia_w			:= null;
		cd_cnes_w			:= null;
		nr_conselho_w			:= null;
		nr_pres_conselho_w		:= null;
		uf_medico_w			:= null;
		cd_cbos_w			:= null;
		nm_profissional_exec_w		:= null;
	end;

	select	nextval('w_tiss_guia_seq')
	into STRICT	nr_seq_guia_w
	;

	select	max(cd_ans)
	into STRICT	cd_ans_w
	from	pls_outorgante
	where	(cd_ans IS NOT NULL AND cd_ans::text <> '');

	select	max(cd_guia)
	into STRICT	cd_guia_w
	from	pls_guia_plano
	where	nr_seq_prestador 	= nr_seq_prestador_p;

	insert	into w_tiss_contratado_exec(nr_sequencia,
		dt_atualizacao,
		nm_usuario,
		nr_seq_guia,
		cd_interno,
		nm_contratado,
		cd_cnes,
		nm_medico_executor,
		nr_crm,
		sg_conselho,
		uf_crm,
		cd_cbo_saude)
	values (nextval('w_tiss_contratado_exec_seq'),
		clock_timestamp(),
		nm_usuario_p,
		nr_seq_guia_w,
		cd_operadora_w,
		nm_fantasia_w,
		cd_cnes_w,
		nr_conselho_w,
		nr_pres_conselho_w,
		uf_medico_w,
		cd_cbos_w,
		nm_profissional_exec_w);

	qt_beneficiarios_w := 0;

	open c01;
	loop
	fetch c01 into	nr_carteira_w,
			nm_beneficiario_w,
			nr_seq_guia_principal_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin
		qt_beneficiarios_w := qt_beneficiarios_w + 1;

		insert	into w_tiss_beneficiario(nr_sequencia,
			dt_atualizacao,
			nm_usuario,
			cd_pessoa_fisica,
			cd_usuario_convenio,
			nm_pessoa_fisica,
			nr_seq_guia)
		values (nextval('w_tiss_beneficiario_seq'),
			clock_timestamp(),
			nm_usuario_p,
			cd_pessoa_fisica_w,
			nr_carteira_w,
			nm_beneficiario_w,
			nr_seq_guia_principal_w);

		if (qt_beneficiarios_w = 25) then
			insert	into w_tiss_contratado_exec(nr_sequencia,
				dt_atualizacao,
				nm_usuario,
				nr_seq_guia,
				cd_interno,
				nm_contratado,
				cd_cnes,
				nm_medico_executor,
				nr_crm,
				sg_conselho,
				uf_crm,
				cd_cbo_saude)
			values (nextval('w_tiss_contratado_exec_seq'),
				clock_timestamp(),
				nm_usuario_p,
				nr_seq_guia_w,
				cd_operadora_w,
				nm_fantasia_w,
				cd_cnes_w,
				nr_conselho_w,
				nr_pres_conselho_w,
				uf_medico_w,
				cd_cbos_w,
				nm_profissional_exec_w);

			qt_beneficiarios_w := 0;
		end if;
		end;
	end loop;
	close c01;

end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_tiss_gerar_w_compr_pres (nr_seq_prestador_p text, cd_estabelecimento_p bigint, nm_usuario_p text) FROM PUBLIC;

