-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE incluir_soluc_dil_trat_onc ( nr_seq_paciente_p bigint, nr_seq_interno_p bigint, ie_operacao_p bigint, nm_usuario_p text) AS $body$
DECLARE


nr_seq_int_medic_w	bigint;
nr_seq_atendimento_w	bigint;
nr_seq_material_w	bigint;
nr_seq_mat_dil_w	bigint;
nr_seq_interno_w	bigint;
nr_seq_solucao_w	bigint;


C01 CURSOR FOR
	SELECT	*
	from	paciente_protocolo_medic
	where	nr_seq_paciente = nr_seq_paciente_p
	and	nr_seq_interno = nr_seq_interno_p;

c01_w	c01%rowtype;

C02 CURSOR FOR
	SELECT	distinct a.nr_seq_atendimento
	from	PACIENTE_ATEND_SOLUC a,
			paciente_atendimento b
	where 	a.nr_seq_atendimento = b.nr_seq_atendimento
	and	 	b.nr_seq_paciente	=nr_seq_paciente_p
	and		a.nr_seq_solucao 	= nr_seq_solucao_w;


BEGIN


	open C01;
	loop
	fetch C01 into
		c01_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin

		nr_seq_solucao_w := c01_w.nr_seq_solucao;

		open C02;
		loop
		fetch C02 into
			nr_seq_atendimento_w;
		EXIT WHEN NOT FOUND; /* apply on C02 */
		begin

		if (ie_operacao_p	= 3) then

			DELETE
			from    PACIENTE_ATEND_MEDIC
			where   NR_SEQ_ATENDIMENTO = nr_seq_atendimento_w
			and     NR_SEQ_PROT_MEDIC  = nr_seq_interno_p;

		elsif (ie_operacao_p = 1) then

			select	coalesce(max(nr_seq_material),0) + 1
			into STRICT	nr_seq_mat_dil_w
			from	paciente_atend_medic
			where	nr_seq_atendimento = nr_seq_atendimento_w;

			select	nextval('paciente_atend_medic_seq')
			into STRICT	nr_seq_interno_w
			;

			insert into paciente_atend_medic(
							nr_seq_atendimento,
							nr_seq_material,
							cd_material,
							dt_atualizacao,
							nm_usuario,
							nr_agrupamento,
							qt_dose,
							cd_unid_med_dose,
							ds_recomendacao,
							ds_observacao,
							ie_via_aplicacao,
							qt_min_aplicacao,
							ie_bomba_infusao,
							cd_intervalo,
							qt_hora_aplicacao,
							qt_dias_util,
							nr_seq_interno,
							nr_seq_prot_medic,
							ie_cancelada,
							ie_administracao,
							ie_checado,
							ie_se_necessario,
							ie_urgencia,
							ie_aplic_bolus,
							ie_aplic_lenta,
							qt_dose_prescricao,
							cd_unid_med_prescr,
							nr_seq_int_prot_medic,
							ie_pre_medicacao,
							nr_seq_solucao,
							ie_aplica_reducao,
							ie_medicacao_paciente)
						values (	nr_seq_atendimento_w,
							c01_w.nr_seq_material,
							c01_w.cd_material,
							clock_timestamp(),
							nm_usuario_p,
							c01_w.nr_agrupamento,
							c01_w.qt_dose,
							c01_w.cd_unidade_medida,
							c01_w.ds_recomendacao,
							c01_w.ds_observacao,
							c01_w.ie_via_aplicacao,
							c01_w.qt_min_aplicacao,
							c01_w.ie_bomba_infusao,
							c01_w.cd_intervalo,
							c01_w.qt_hora_aplicacao,
							c01_w.qt_dias_util,
							nr_seq_interno_w,
							c01_w.nr_seq_interno,
							'N',
							'P',
							'N',
							c01_w.ie_se_necessario,
							c01_w.ie_urgencia,
							c01_w.ie_aplic_bolus,
							c01_w.ie_aplic_lenta,
							CASE WHEN obter_se_gerar_dose_um_ciclo(c01_w.cd_unid_med_prescr,c01_w.qt_dose_prescr)='S' THEN  c01_w.qt_dose_prescr  ELSE null END ,
							CASE WHEN obter_se_gerar_dose_um_ciclo(c01_w.cd_unid_med_prescr,c01_w.qt_dose_prescr)='S' THEN  c01_w.cd_unid_med_prescr  ELSE null END ,
							c01_w.nr_seq_interno,
							c01_w.ie_pre_medicacao,
							c01_w.nr_seq_solucao,
							c01_w.ie_aplica_reducao,
							coalesce(c01_w.ie_medicacao_paciente,'N'));
			end if;
		end;
	end loop;
	close C02;




	end;
	end loop;
	close C01;


commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE incluir_soluc_dil_trat_onc ( nr_seq_paciente_p bigint, nr_seq_interno_p bigint, ie_operacao_p bigint, nm_usuario_p text) FROM PUBLIC;

