-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE limpar_objetos_nao_documentos () AS $body$
DECLARE


nm_objeto_w	varchar(50);
nm_tabela_w	varchar(50);

C01 CURSOR FOR
	SELECT	distinct object_name
	from	user_objects	a
	where	not exists (	SELECT	nm_objeto
				from	objeto_sistema	b
				where	a.object_name = b.nm_objeto)
	and	object_type in ('FUNCTION','TRIGGER','PROCEDURE','VIEW','PACKAGE')
	and	created < clock_timestamp() - interval '10 days'
	and	object_name not like '%_TP'
	and	object_name not like 'ONC_%'
	and	not exists (	select	1
				from	user_dependencies c
				where	c.referenced_name = a.object_name);

C02 CURSOR FOR
	SELECT	distinct table_name
	from	user_tables	a
	where	not exists (	SELECT	1
				from	tabela_sistema	b
				where	a.table_name = b.nm_tabela)
	and	not exists (	select	1
				from	user_dependencies c
				where	c.referenced_name = a.table_name)
	and	table_name not like 'ONC_%'
	and	table_name not like 'EHR_CLUSTER_%'
	and	table_name not like 'W_EIS_EVOL_%';

BEGIN

open C01;
loop
fetch C01 into
    	nm_objeto_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	CALL exec_sql_dinamico('Tasy','drop procedure ' || nm_objeto_w);
end loop;
close	C01;

open C02;
loop
fetch C02 into
    	nm_tabela_w;
EXIT WHEN NOT FOUND; /* apply on C02 */
	CALL exec_sql_dinamico('Tasy','truncate table ' || nm_tabela_w);
	CALL exec_sql_dinamico('Tasy','drop table ' || nm_tabela_w);
end loop;
close	C02;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE limpar_objetos_nao_documentos () FROM PUBLIC;

