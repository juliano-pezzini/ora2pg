-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE obter_status_sepse_result ( nr_seq_escala_p bigint, ie_status_p INOUT text, ds_mensagem_p INOUT text) AS $body$
DECLARE


qt_reg_deflagrador_w		bigint;
ie_status_w					varchar(3);
qt_geral_w					bigint;
ds_mensagem_w				varchar(255) := '';
cd_setor_Atendimento_w  	integer;
qt_idade_w              	bigint;
cd_pessoa_fisica_dest_w 	varchar(10);
nr_atendimento_w			bigint;
ie_pessoa_destino_w         varchar(15);
cd_pessoa_usuario_w         varchar(10);
nm_usuario_w                varchar(15);
nm_usuario_sepsis_w         varchar(15);
cd_pessoa_aux_enfer_dest_w  varchar(10);
cd_pf_destino_w             varchar(10);
cd_perfil_w                 integer;
cd_perfil_usuario_w         integer;
cd_equipe_destino_w         bigint;
ie_versao_sepse_w           varchar(10);

C01 CURSOR FOR
SELECT	c.ie_pessoa_destino,
		c.cd_pf_destino,
		c.cd_perfil,
        c.nr_seq_equipe
from	gqa_pendencia_regra a,
		gqa_acao b,
		gqa_acao_regra_prof c,
		gqa_pendencia d
where	d.nr_sequencia = a.nr_seq_pendencia
and 	a.nr_sequencia = b.nr_seq_pend_regra
and		b.nr_sequencia = c.nr_seq_acao
and		d.ie_situacao = 'A'
and		a.ie_situacao = 'A'
and		a.ie_regra_sepse = 'SE'
and 	obter_se_gqa_regra_liberada(a.nr_sequencia) = 'S'
and		coalesce(a.cd_setor_atendimento,coalesce(cd_setor_atendimento_w,0)) = coalesce(cd_setor_atendimento_w,0)
and		coalesce(qt_idade_w,0) between coalesce(qt_idade_min,0) and coalesce(qt_idade_max,99999)
and 	qt_geral_w >= qt_var_suspeita
and		qt_reg_deflagrador_w >= qt_var_confirmada
and (coalesce(b.nr_seq_proc::text, '') = '' and
		  coalesce(b.cd_protocolo::text, '') = '' and
		  coalesce(b.nr_seq_protocolo::text, '') = '');
		
C02 CURSOR FOR
SELECT	coalesce(qt_var_suspeita,0)
from	gqa_pendencia_regra a, gqa_pendencia b
where	a.nr_seq_pendencia = b.nr_sequencia
and		ie_regra_sepse = 'SC'
and     a.nr_seq_escala = 124
and		coalesce(a.ie_situacao,'A') = 'A'
and		coalesce(b.ie_situacao,'A') = 'A';

qt_var_suspeita_w bigint;


BEGIN

select coalesce(ie_versao_sepse,'1')
into STRICT   ie_versao_sepse_w
from   parametro_medico
where  cd_estabelecimento = obter_estabelecimento_ativo;
		
select	count(*)
into STRICT	qt_reg_deflagrador_w
from	escala_sepse_item
where	nr_seq_escala = nr_seq_escala_p
and		ie_resultado = 'S'
and		((ie_versao_sepse_w = '1' and nr_seq_atributo in (8,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,30,31,32,34))
or (ie_versao_sepse_w = '2' and nr_seq_atributo in (41,42,51,59,60,61,62,65,66,72,76,77, 95, 102, 103)));


select	count(*)
into STRICT	qt_geral_w
from	escala_sepse_item
where	nr_seq_escala = nr_seq_escala_p
and		ie_resultado = 'S'
and		((ie_versao_sepse_w = '1' and nr_seq_atributo in (4,5,6,7,8,9,11,17,30,31,32,33,35))
or (ie_versao_sepse_w = '2' and nr_seq_atributo in (47,48,49,50,54,55,56,75)));

If (qt_reg_deflagrador_w > 0) then	
	
	if (ie_versao_sepse_w = '2') then
		ie_status_w := 'RC';
		if (qt_geral_w > 0) then
			ds_mensagem_w := Wheb_mensagem_pck.get_texto(1026028,'qt_geral_w='||qt_geral_w||';qt_reg_deflagrador_w='||qt_reg_deflagrador_w);			
		else
			ds_mensagem_w := Wheb_mensagem_pck.get_texto(1026030,'qt_reg_deflagrador_w='||qt_reg_deflagrador_w);			
		end if;
	else
		if (qt_geral_w > 0) then
			ie_status_w := 'RC';
			ds_mensagem_w := Wheb_mensagem_pck.get_texto(1009719,'qt_geral_w='||qt_geral_w||';qt_reg_deflagrador_w='||qt_reg_deflagrador_w);
		else
			ie_status_w := 'RD';
			ds_mensagem_w := Wheb_mensagem_pck.get_texto(295829,'qt_reg_deflagrador_w='||qt_reg_deflagrador_w);
		end if;
	end if;

else

	if (ie_versao_sepse_w = '2') then
		ds_mensagem_w	:= Wheb_mensagem_pck.get_texto(1026025,'qt_geral_w='||qt_geral_w);
		open C02;
		loop
		fetch C02 into	
			qt_var_suspeita_w;
			EXIT WHEN NOT FOUND; /* apply on C02 */
			begin
			if (qt_geral_w >= qt_var_suspeita_w) then
				ie_status_w := 'SC';
				exit;
			else
				ie_status_w := 'SN';
				if (qt_geral_w <= 1) then
					ds_mensagem_w	:= Wheb_mensagem_pck.get_texto(1026033,'qt_geral_w='||qt_geral_w);
				end if;
			end if;
			end;
		end loop;
	else
		if (qt_geral_w > 2) then
			ds_mensagem_w	:= Wheb_mensagem_pck.get_texto(295832,'qt_geral_w='||qt_geral_w);
			ie_status_w := 'SC';
		else
			ds_mensagem_w	:= Wheb_mensagem_pck.get_texto(295836,'qt_geral_w='||qt_geral_w);
			ie_status_w := 'SN';
		end if;
	end if;
	
	select	max(nr_atendimento),
			max(nm_usuario)
	into STRICT	nr_atendimento_w, 
			nm_usuario_sepsis_w
	from 	escala_sepse
	where	nr_sequencia = nr_seq_escala_p;
	
	if (nr_atendimento_w > 0) then

		select	coalesce(cd_medico_resp,0),
				Obter_Setor_Atendimento(nr_atendimento),
				Obter_Idade_PF(cd_pessoa_fisica,clock_timestamp(),'A')
		into STRICT	cd_pessoa_fisica_dest_w,
				cd_setor_atendimento_w,
				qt_idade_w
		from	atendimento_paciente
		where	nr_atendimento	= nr_atendimento_w;
		
		nm_usuario_w := wheb_usuario_pck.get_nm_usuario;
		cd_pessoa_usuario_w := Obter_Pessoa_Fisica_Usuario(nm_usuario_w,'C');
		cd_perfil_usuario_w := obter_perfil_ativo;
		
		select	max(a.CD_PESSOA_FISICA)
		into STRICT	cd_pessoa_aux_enfer_dest_w
		from	atend_profissional a
		where	a.nr_atendimento = nr_atendimento_w
		and	((ie_profissional		= 'E') or (IS_COPY_BASE_LOCALE('es_MX') = 'S' and ie_profissional = '6'))
		and		a.nr_sequencia	= (	SELECT	max(x.nr_sequencia)
									from	atend_profissional x
									where	x.nr_atendimento = nr_atendimento_w
									and		x.ie_profissional = 'E');

		open C01;
		loop
		fetch C01 into	
			ie_pessoa_destino_w,
			cd_pf_destino_w,
			cd_perfil_w,
			cd_equipe_destino_w;
		EXIT WHEN NOT FOUND; /* apply on C01 */
			begin
			if	(ie_pessoa_destino_w	= 1 AND cd_pessoa_usuario_w = cd_pessoa_fisica_dest_w)                   or
				(ie_pessoa_destino_w	= 3 AND nm_usuario_sepsis_w = nm_usuario_w)                              or
				(ie_pessoa_destino_w	= 4 AND cd_pessoa_aux_enfer_dest_w = cd_pessoa_usuario_w)                or
				(ie_pessoa_destino_w	= 6 AND cd_pf_destino_w = cd_pessoa_usuario_w)                           or
				((ie_pessoa_destino_w	= 8) and (obter_pessoa_escala_gqa(nr_atendimento_w) = cd_pessoa_usuario_w)) or (cd_perfil_w = cd_perfil_usuario_w)                                                                 or
				((cd_equipe_destino_w IS NOT NULL AND cd_equipe_destino_w::text <> '') and (obter_se_medico_equipe(cd_equipe_destino_w, cd_pessoa_usuario_w) = 'S')) then
				if (ie_versao_sepse_w = '2') then
					ds_mensagem_w	:= Wheb_mensagem_pck.get_texto(1026025,'qt_geral_w='||qt_geral_w);
				else
					ds_mensagem_w	:= Wheb_mensagem_pck.get_texto(295832,'qt_geral_w='||qt_geral_w);
				end if;
				ie_status_w := 'SC';
			end if;		
			end;
		end loop;
		close C01;
	end if;
end if;
	
ie_status_p 	:= ie_status_w;
ds_mensagem_p   := ds_mensagem_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE obter_status_sepse_result ( nr_seq_escala_p bigint, ie_status_p INOUT text, ds_mensagem_p INOUT text) FROM PUBLIC;

