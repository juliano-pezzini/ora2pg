-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';



CREATE TYPE campos AS (
	ds	$if dbms_db_version.version <= 10 $then varchar(32760) $else text $end
);


CREATE OR REPLACE PROCEDURE wheb_criar_trigger_campo_log () AS $body$
DECLARE


type Vetor is table of  campos index by integer;
ds_script_vetor			Vetor;

nm_tabela_w 		varchar(50);
nm_atributo_w		varchar(50);
ds_script_trigger_w	text;
ds_chave_simples_proc_w	 varchar(100);
ds_chave_composta_proc_w varchar(1000);
ds_aspa_w		varchar(1) :=chr(39);
ds_pipe_w		varchar(2) :=chr(124)||chr(124);
ie_tipo_atributo_w	varchar(10);
ds_valor_old_w		varchar(100);
ds_valor_new_w		varchar(100);
ie_possui_regra_w   varchar(1) := 'N';
qt_trigger_w		bigint;


c01 CURSOR FOR
	SELECT	DISTINCT a.nm_tabela
	FROM	tabela_atributo a,
		tabela_atrib_regra b
	WHERE	a.nm_tabela = b.nm_tabela
	and	a.nm_atributo = b.nm_atributo
	and	a.ie_tipo_atributo in ('DATE','NUMBER','VARCHAR2')
	and	b.ie_gerar_log in ('S','J');

C02 CURSOR FOR
	SELECT	a.nm_atributo
	from	indice_atributo a,
		indice b
	where	a.nm_indice = b.nm_indice
	and	a.nm_tabela = b.nm_tabela
	and	a.nm_tabela = nm_tabela_w
	and	b.ie_tipo = 'PK'
	order	by a.nr_sequencia;

C03 CURSOR FOR
	SELECT	DISTINCT a.nm_atributo,
		a.ie_tipo_atributo
	from	tabela_atributo a,
		tabela_atrib_regra b
	where	a.nm_tabela = b.nm_tabela
	and	a.nm_atributo = b.nm_atributo
	and	a.nm_tabela = nm_tabela_w
	and	a.ie_tipo_atributo in ('DATE','NUMBER','VARCHAR2')
	and b.ie_gerar_log in ('S','J')         --Sim ou Justificativa   
    and	a.ie_log_update NOT in ('S','D');	--sendo S ou D vai estar sendo gravado log pela trigger "_TP" 
BEGIN
open C01;
loop
fetch C01 into	
	nm_tabela_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	    ie_possui_regra_w := 'N';
		ds_script_vetor[1].ds := '';
		ds_script_vetor[2].ds := '';
		ds_script_vetor[3].ds := '';
		ds_script_vetor[4].ds := '';
		ds_script_vetor[5].ds := '';
		ds_chave_composta_proc_w := null;
		ds_chave_simples_proc_w := null;
		ds_script_trigger_w :=  ' create or replace trigger '|| substr(nm_tabela_w,1,26) ||'_log '||
					' after update on ' || nm_tabela_w ||
					' FOR EACH ROW '||
					' DECLARE'||
					' nr_seq_w number(10);' ||
					' ds_s_w   varchar2(50);' ||
					' ds_c_w   varchar2(500);'||
					' ds_w	   varchar2(500);'||
					' ie_log_w varchar2(1);'||
					' begin'||
					' begin'||
					' if	(wheb_usuario_pck.get_ie_executar_trigger	= '||chr(39)|| 'S' || chr(39)||')  then ';
		open C02;
		loop
		fetch C02 into	
			nm_atributo_w;
		EXIT WHEN NOT FOUND; /* apply on C02 */
			begin
			if (coalesce(ds_chave_composta_proc_w::text, '') = '' ) then
				ds_chave_simples_proc_w  := ' ds_s_w := to_char(:old.'||nm_atributo_w||');';
				ds_chave_composta_proc_w := ' ds_c_w:= '||ds_aspa_w|| nm_atributo_w || '='||ds_aspa_w||ds_pipe_w||'to_char(:old.'||nm_atributo_w||')';
			else
				ds_chave_simples_proc_w := null;
				ds_chave_composta_proc_w := ds_chave_composta_proc_w || ds_pipe_w ||ds_aspa_w || '#@#@' || nm_atributo_w || '='||ds_aspa_w||ds_pipe_w||'to_char(:old.'||nm_atributo_w||')';
			end if;
			end;
		end loop;
		close C02;
		if (ds_chave_simples_proc_w IS NOT NULL AND ds_chave_simples_proc_w::text <> '') then
			ds_chave_composta_proc_w := ' ds_c_w:=null;';
		else
			ds_chave_simples_proc_w  := ' ds_s_w := null;';
			
			if (ds_chave_composta_proc_w IS NOT NULL AND ds_chave_composta_proc_w::text <> '') then
				ds_chave_composta_proc_w := ds_chave_composta_proc_w || ';';
			end if;
		end if;
		ds_script_trigger_w := ds_script_trigger_w || ds_chave_simples_proc_w || ' ' || ds_chave_composta_proc_w;
		open C03;
		loop
		fetch C03 into	
			nm_atributo_w,
			ie_tipo_atributo_w;
		EXIT WHEN NOT FOUND; /* apply on C03 */
			begin
			    ie_possui_regra_w := 'S';
				if (ie_tipo_atributo_w = 'DATE') then
					ds_valor_old_w:='to_char(:old.'||nm_atributo_w||','||ds_aspa_w||'dd/mm/yyyy hh24:mi:ss'||ds_aspa_w||')';
					ds_valor_new_w:='to_char(:new.'||nm_atributo_w||','||ds_aspa_w||'dd/mm/yyyy hh24:mi:ss'||ds_aspa_w||')';
				else
					ds_valor_old_w:='substr(:old.'||nm_atributo_w||',1,2000)';
					ds_valor_new_w:='substr(:new.'||nm_atributo_w||',1,2000)';
				end if;
				ds_script_trigger_w := ds_script_trigger_w ||
					'gravar_log_alteracao('||ds_valor_old_w||','||ds_valor_new_w||',:new.nm_usuario,nr_seq_w,' || ds_aspa_w || nm_atributo_w || ds_aspa_w || ',ie_log_w,ds_w,'||ds_aspa_w||nm_tabela_w||ds_aspa_w||',ds_s_w,ds_c_w); ';
			end;
		end loop;
		close C03;
		
        if (ie_possui_regra_w = 'S') then
            ds_script_trigger_w := ds_script_trigger_w || ' end if; ' || ' exception when others then ds_w:= '||ds_aspa_w || '1' || ds_aspa_w||'; end; end;';
            ds_script_vetor[1].ds := substr(ds_script_trigger_w,1,32000);
            ds_script_vetor[2].ds := substr(ds_script_trigger_w,32001,32000);
            ds_script_vetor[3].ds := substr(ds_script_trigger_w,64001,32000);
            ds_script_vetor[4].ds := substr(ds_script_trigger_w,96001,32000);
            ds_script_vetor[5].ds := substr(ds_script_trigger_w,128001,32000);
            EXECUTE ds_script_vetor[1].ds || ds_script_vetor[2].ds || ds_script_vetor[3].ds || ds_script_vetor[4].ds || ds_script_vetor[5].ds;
        else
		    select COUNT(*)
			into STRICT qt_trigger_w
			from user_objects 
			where OBJECT_NAME = substr(nm_tabela_w,1,26) ||'_LOG'
			AND OBJECT_TYPE = 'TRIGGER';
			
			if (qt_trigger_w > 0) then
				EXECUTE ' drop trigger ' || substr(nm_tabela_w,1,26) ||'_LOG';
			end if;
        end if;
	end;
end loop;
close C01;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE wheb_criar_trigger_campo_log () FROM PUBLIC;

