-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE man_gerar_requisicao_equip ( nr_seq_prot_req_p bigint, nr_seq_ordem_serv_p bigint, ie_libera_requisicao_p text, nm_usuario_p text) AS $body$
DECLARE


/* Variáveis do cursor C01 */

cd_material_w				integer;
qt_material_requisitada_w			double precision;
vl_material_w				double precision;
cd_estabelecimento_w			smallint	:= wheb_usuario_pck.get_cd_estabelecimento;

/* Sequências */

nr_seq_req_material_w 			bigint;
nr_seq_req_item_material_w			bigint;

/* Campos se liberado = 'S' */

ie_liberada_w				varchar(1);
dt_aprovacao_w				timestamp := null;
nm_usuario_aprov_w			varchar(15) := null;

/* Liberação */

dt_liberacao_w				timestamp;
nm_usuario_lib_w				varchar(15);

/* Executor */

qt_existe_exec_w				bigint;
cd_pessoa_requisitante_w			varchar(10);

/* Centro de custo */

nr_seq_localizacao_w			bigint;
qt_existe_centro_custo_w			bigint;
cd_centro_custo_w				integer;
cd_operacao_estoque_w			smallint;
cd_centro_custo_equip_w			integer;

/*Parametros da função*/

ie_consiste_material_ccusto_w		varchar(15);		--4
ie_regra_mat_padrao_w			varchar(15);		--8
ie_consiste_mat_local_w			varchar(15);		--5
ie_consiste_estoque_disp_w			varchar(15);		--16
ie_consiste_devol_consumo_w		varchar(15);		--28
ie_permite_estoque_max_w			varchar(15);		--69
ie_somente_tranf_farmacia_w			varchar(15);		--18
ds_consistencia_w				varchar(2000);
ie_requisitante_w				varchar(15);
cd_pessoa_solicitante_w			varchar(10);
cd_pessoa_req_regra_w			varchar(10);

C01 CURSOR FOR
	SELECT	qt_material,
		0,
		cd_material
	from	prot_requisicao_item
	where	(cd_material IS NOT NULL AND cd_material::text <> '')
	and	nr_seq_prot_requisicao = nr_seq_prot_req_p;


BEGIN

ie_consiste_material_ccusto_w := obter_param_usuario(919, 4, obter_perfil_Ativo, nm_usuario_p, cd_estabelecimento_w, ie_consiste_material_ccusto_w);
ie_consiste_mat_local_w := obter_param_usuario(919, 5, obter_perfil_Ativo, nm_usuario_p, cd_estabelecimento_w, ie_consiste_mat_local_w);
ie_regra_mat_padrao_w := obter_param_usuario(919, 8, obter_perfil_Ativo, nm_usuario_p, cd_estabelecimento_w, ie_regra_mat_padrao_w);
ie_consiste_estoque_disp_w := obter_param_usuario(919, 16, obter_perfil_Ativo, nm_usuario_p, cd_estabelecimento_w, ie_consiste_estoque_disp_w);
ie_somente_tranf_farmacia_w := obter_param_usuario(919, 18, obter_perfil_Ativo, nm_usuario_p, cd_estabelecimento_w, ie_somente_tranf_farmacia_w);
ie_consiste_devol_consumo_w := obter_param_usuario(919, 28, obter_perfil_Ativo, nm_usuario_p, cd_estabelecimento_w, ie_consiste_devol_consumo_w);
ie_permite_estoque_max_w := obter_param_usuario(919, 69, obter_perfil_Ativo, nm_usuario_p, cd_estabelecimento_w, ie_permite_estoque_max_w);
ie_requisitante_w := obter_param_usuario(299, 364, obter_perfil_Ativo, nm_usuario_p, cd_estabelecimento_w, ie_requisitante_w);

/* Procura centro de custo da localização */

select	coalesce(nr_seq_localizacao,0),
	cd_pessoa_solicitante
into STRICT	nr_seq_localizacao_w,
	cd_pessoa_solicitante_w
from	man_ordem_servico
where	nr_sequencia = nr_seq_ordem_serv_p;

select	count(cd_centro_custo)
into STRICT	qt_existe_centro_custo_w
from	man_localizacao
where	nr_sequencia = nr_seq_localizacao_w;

if (qt_existe_centro_custo_w <> 0) then
	select	cd_centro_custo
	into STRICT	cd_centro_custo_w
	from	man_localizacao
	where	nr_sequencia = nr_seq_localizacao_w;
end if;

if (ie_requisitante_w = 'E') then
	/* Procura executor como solicitante */

	select	count(nm_usuario_exec)
	into STRICT	qt_existe_exec_w
	from	man_ordem_servico_exec
	where	nr_seq_ordem = nr_seq_ordem_serv_p;

	if (qt_existe_exec_w <> 0) then
		select	substr(obter_pessoa_fisica_usuario(min(nm_usuario_exec),'C'),1,10)
		into STRICT	cd_pessoa_requisitante_w
		from	man_ordem_servico_exec
		where	nr_seq_ordem = nr_seq_ordem_serv_p;
	end if;
elsif (ie_requisitante_w = 'S') then
	cd_pessoa_requisitante_w := cd_pessoa_solicitante_w;
elsif (ie_requisitante_w = 'R') then
	select	cd_pessoa_requisitante
	into STRICT	cd_pessoa_req_regra_w
	from	prot_requisicao
	where	nr_sequencia = nr_seq_prot_req_p;
end if;

select	nextval('requisicao_seq')
into STRICT	nr_seq_req_material_w
;

select	max(cd_centro_custo)
into STRICT	cd_centro_custo_equip_w
from	man_equipamento a,
	man_ordem_servico b
where	a.nr_sequencia = b.nr_seq_equipamento
and	b.nr_sequencia = nr_seq_ordem_serv_p;

insert into requisicao_material(
	nr_requisicao,
	nr_seq_ordem_serv,
	cd_estabelecimento,
	cd_local_estoque,
	dt_solicitacao_requisicao,
	dt_atualizacao,
	nm_usuario,
	cd_operacao_estoque,
	cd_pessoa_requisitante,
	ie_urgente,
	dt_liberacao,
	nm_usuario_lib,
	dt_aprovacao,
	nm_usuario_aprov,
	cd_centro_custo)
SELECT	nr_seq_req_material_w,
	nr_seq_ordem_serv_p,
	cd_estabelecimento,
	cd_local_estoque,
	clock_timestamp(),
	clock_timestamp(),
	nm_usuario_p,
	cd_operacao_estoque,
	coalesce(cd_pessoa_requisitante_w,cd_pessoa_requisitante),
	'N',
	dt_liberacao_w,
	nm_usuario_lib_w,
	dt_aprovacao_w,
	nm_usuario_aprov_w,
	coalesce(coalesce(cd_centro_custo_w,cd_centro_custo),cd_centro_custo_equip_w)
from	prot_requisicao
where	nr_sequencia = nr_seq_prot_req_p;

open C01;
loop
fetch C01 into	
	qt_material_requisitada_w,
	vl_material_w,
	cd_material_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin

	select	coalesce(max(nr_sequencia),0) + 1
	into STRICT	nr_seq_req_item_material_w
	from	item_requisicao_material;

	insert into	item_requisicao_material(
			nr_requisicao,
			nr_sequencia,
			cd_estabelecimento,
			cd_material,
			qt_material_requisitada,
			vl_material,
			dt_atualizacao,
			nm_usuario,
			cd_motivo_baixa)
		values (	nr_seq_req_material_w,
			nr_seq_req_item_material_w,
			coalesce(cd_estabelecimento_w,0),
			cd_material_w,
			qt_material_requisitada_w,
			vl_material_w,
			clock_timestamp(),
			nm_usuario_p,
			0);
	end;
end loop;
close C01;

select	cd_centro_custo,
	cd_operacao_estoque
into STRICT	cd_centro_custo_w,
	cd_operacao_estoque_w
from	requisicao_material
where	nr_requisicao = nr_seq_req_material_w;

if (coalesce(ie_libera_requisicao_p,'N') = 'S') then
	begin
	ds_consistencia_w := consistir_requisicao(	nr_seq_req_material_w, nm_usuario_p, 0, cd_centro_custo_w, ie_consiste_material_ccusto_w, ie_somente_tranf_farmacia_w, ie_regra_mat_padrao_w, ie_consiste_mat_local_w, ie_consiste_estoque_disp_w, ie_consiste_devol_consumo_w, ie_permite_estoque_max_w, cd_operacao_estoque_w, ds_consistencia_w);
	if (coalesce(ds_consistencia_w,'X') <> 'X') then
		/*(-20011,ds_consistencia_w)*/

		CALL wheb_mensagem_pck.exibir_mensagem_abort(263076,'DS_CONSISTENCIA=' || ds_consistencia_w);
	end if;
	
	commit;
	
	select	dt_liberacao
	into STRICT	dt_liberacao_w
	from	requisicao_material
	where	nr_requisicao = nr_seq_req_material_w;
	
	if (coalesce(dt_liberacao_w::text, '') = '') then
		CALL wheb_mensagem_pck.exibir_mensagem_abort(1069679);
	end if;
	end;
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE man_gerar_requisicao_equip ( nr_seq_prot_req_p bigint, nr_seq_ordem_serv_p bigint, ie_libera_requisicao_p text, nm_usuario_p text) FROM PUBLIC;

