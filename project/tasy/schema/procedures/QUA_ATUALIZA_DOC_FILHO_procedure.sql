-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE qua_atualiza_doc_filho (nr_seq_doc_p bigint, nm_usuario_p text) AS $body$
DECLARE


ie_doc_pai_w			varchar(1);
nr_seq_doc_pai_w		qua_documento.nr_sequencia%type;
nr_seq_doc_superior_w		qua_documento.nr_sequencia%type;
cd_documento_ext_w		qua_documento.cd_documento_ext%type;
cd_estabelecimento_w		qua_documento.cd_estabelecimento%type;
cd_pessoa_aprov_w		qua_documento.cd_pessoa_aprov%type;
cd_pessoa_elaboracao_w		qua_documento.cd_pessoa_elaboracao%type;
cd_pessoa_validacao_w		qua_documento.cd_pessoa_validacao%type;
cd_setor_atendimento_w		qua_documento.cd_setor_atendimento%type;
ie_externo_w			qua_documento.ie_externo%type;
ie_permite_email_w		qua_documento.ie_permite_email%type;
ie_permite_imprimir_w		qua_documento.ie_permite_imprimir%type;
ie_permite_salvar_w		qua_documento.ie_permite_salvar%type;
ie_status_w			qua_documento.ie_status%type;
nm_usuario_revalidacao_w	qua_documento.nm_usuario_revalidacao%type;
nr_seq_loc_w			qua_documento.nr_seq_loc%type;
nr_seq_tipo_ref_doc_w		qua_documento.nr_seq_tipo_ref_doc%type;
nr_seq_tipo_w			qua_documento.nr_seq_tipo%type;
qt_dias_aprovacao_w		qua_documento.qt_dias_aprovacao%type;
qt_dias_revisao_w		qua_documento.qt_dias_revisao%type;
qt_dias_validacao_w		qua_documento.qt_dias_validacao%type;

c_filhos CURSOR(nr_seq_doc_pai bigint) FOR
	SELECT	qd.nr_sequencia nr_seq_doc
	from	qua_documento qd
	where	qd.nr_seq_superior = nr_seq_doc_pai;


BEGIN

	select	nr_seq_superior
	into STRICT	nr_seq_doc_pai_w
	from	qua_documento
	where	nr_sequencia = nr_seq_doc_p;
	
	select	CASE WHEN coalesce(nr_seq_doc_pai_w::text, '') = '' THEN  'S'  ELSE 'N' END
	into STRICT	ie_doc_pai_w
	;
	
	select	CASE WHEN ie_doc_pai_w='N' THEN  nr_seq_doc_pai_w  ELSE nr_seq_doc_p END
	into STRICT	nr_seq_doc_pai_w
	;
	
	select	qd.cd_documento_ext,
		qd.cd_estabelecimento,
		qd.cd_pessoa_aprov,
		qd.cd_pessoa_elaboracao,
		qd.cd_pessoa_validacao,
		qd.cd_setor_atendimento,
		qd.ie_externo,
		qd.ie_permite_email,
		qd.ie_permite_imprimir,
		qd.ie_permite_salvar,
		qd.ie_status,
		qd.nm_usuario_revalidacao,
		qd.nr_seq_loc,
		qd.nr_seq_tipo_ref_doc,
		qd.nr_seq_tipo,
		qd.qt_dias_aprovacao,
		qd.qt_dias_revisao,
		qd.qt_dias_validacao
	into STRICT	cd_documento_ext_w,
		cd_estabelecimento_w,
		cd_pessoa_aprov_w,
		cd_pessoa_elaboracao_w,
		cd_pessoa_validacao_w,
		cd_setor_atendimento_w,
		ie_externo_w,
		ie_permite_email_w,
		ie_permite_imprimir_w,
		ie_permite_salvar_w,
		ie_status_w,
		nm_usuario_revalidacao_w,
		nr_seq_loc_w,
		nr_seq_tipo_ref_doc_w,
		nr_seq_tipo_w,
		qt_dias_aprovacao_w,
		qt_dias_revisao_w,
		qt_dias_validacao_w
	from	qua_documento qd
	where	qd.nr_sequencia = nr_seq_doc_pai_w;
	
	if (ie_doc_pai_w = 'S') then
		begin
			open c_filhos(nr_seq_doc_pai_w);
			loop
			fetch c_filhos into nr_seq_doc_superior_w;
			EXIT WHEN NOT FOUND; /* apply on c_filhos */
				begin
					update	qua_documento
					set	cd_documento_ext	= cd_documento_ext_w,
						cd_estabelecimento	= cd_estabelecimento_w,
						cd_pessoa_aprov		= cd_pessoa_aprov_w,
						cd_pessoa_elaboracao	= cd_pessoa_elaboracao_w,
						cd_pessoa_validacao	= cd_pessoa_validacao_w,
						cd_setor_atendimento	= cd_setor_atendimento_w,
						dt_atualizacao		= clock_timestamp(),
						ie_externo		= ie_externo_w,
						ie_permite_email	= ie_permite_email_w,
						ie_permite_imprimir	= ie_permite_imprimir_w,
						ie_permite_salvar	= ie_permite_salvar_w,
						ie_status		= ie_status_w,
						nm_usuario		= nm_usuario_p,
						nm_usuario_revalidacao	= nm_usuario_revalidacao_w,
						nr_seq_loc		= nr_seq_loc_w,
						nr_seq_tipo_ref_doc	= nr_seq_tipo_ref_doc_w,
						nr_seq_tipo		= nr_seq_tipo_w,
						qt_dias_aprovacao	= qt_dias_aprovacao_w,
						qt_dias_revisao		= qt_dias_revisao_w,
						qt_dias_validacao	= qt_dias_validacao_w
					where	nr_sequencia		= nr_seq_doc_superior_w;
				end;
			end loop;
		end;
	else
		begin
			update	qua_documento
			set	cd_documento_ext	= cd_documento_ext_w,
				cd_estabelecimento	= cd_estabelecimento_w,
				cd_pessoa_aprov		= cd_pessoa_aprov_w,
				cd_pessoa_elaboracao	= cd_pessoa_elaboracao_w,
				cd_pessoa_validacao	= cd_pessoa_validacao_w,
				cd_setor_atendimento	= cd_setor_atendimento_w,
				dt_atualizacao		= clock_timestamp(),
				ie_externo		= ie_externo_w,
				ie_permite_email	= ie_permite_email_w,
				ie_permite_imprimir	= ie_permite_imprimir_w,
				ie_permite_salvar	= ie_permite_salvar_w,
				ie_status		= ie_status_w,
				nm_usuario		= nm_usuario_p,
				nm_usuario_revalidacao	= nm_usuario_revalidacao_w,
				nr_seq_loc		= nr_seq_loc_w,
				nr_seq_tipo_ref_doc	= nr_seq_tipo_ref_doc_w,
				nr_seq_tipo		= nr_seq_tipo_w,
				qt_dias_aprovacao	= qt_dias_aprovacao_w,
				qt_dias_revisao		= qt_dias_revisao_w,
				qt_dias_validacao	= qt_dias_validacao_w
			where	nr_sequencia		= nr_seq_doc_p;
		end;
	end if;
	commit;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE qua_atualiza_doc_filho (nr_seq_doc_p bigint, nm_usuario_p text) FROM PUBLIC;

