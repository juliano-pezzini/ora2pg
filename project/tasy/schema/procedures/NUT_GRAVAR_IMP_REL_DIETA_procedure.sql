-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE nut_gravar_imp_rel_dieta ( dt_servico_p timestamp, nr_Seq_Tipo_imp_p bigint, nm_usuario_p text) AS $body$
DECLARE


nr_seq_serv_dia_w	bigint;

C01 CURSOR FOR
	SELECT	a.nr_sequencia
	from	nut_atend_serv_dia a,
		prescr_medica b,
		prescr_dieta c,
		nut_servico d
	where	a.nr_atendimento = b.nr_atendimento
	and	((a.dt_servico between b.dt_inicio_prescr and b.dt_validade_prescr) or (coalesce(b.dt_validade_prescr::text, '') = ''))
	and	(coalesce(b.dt_liberacao,b.dt_liberacao_medico) IS NOT NULL AND (coalesce(b.dt_liberacao,b.dt_liberacao_medico))::text <> '')
	and	b.nr_prescricao = c.nr_prescricao
	and	a.nr_seq_servico = d.nr_sequencia
	and	exists (SELECT	 1
			from	 nut_servico_horario e
			where	 e.nr_seq_servico = d.nr_sequencia
			and	 dt_servico_p between to_date(to_char(dt_servico_p,'dd/mm/yyyy')||coalesce(e.ds_horario_corte_inic,' 00:00'),'dd/mm/yyyy hh24:mi') and to_date(to_char(dt_servico_p,'dd/mm/yyyy')||coalesce(e.ds_horario_corte_fim,' 23:59'),'dd/mm/yyyy hh24:mi'))
	and	trunc(a.dt_servico) = trunc(dt_servico_p)
	group by a.nr_sequencia;


BEGIN

open c01;
loop
fetch c01 into nr_seq_serv_dia_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
		begin

		insert into nut_pac_servico_imp(
						nr_sequencia,
						dt_atualizacao,
						nm_usuario,
						dt_atualizacao_nrec,
						nm_usuario_nrec,
						nr_seq_atend_serv_dia,
						dt_impressao,
						nr_seq_tipo_imp)
		values (
						nextval('nut_pac_servico_imp_seq'),
						clock_timestamp(),
						nm_usuario_p,
						clock_timestamp(),
						nm_usuario_p,
						nr_seq_serv_dia_w,
						clock_timestamp(),
						nr_Seq_Tipo_imp_p);
		end;
end loop;
close c01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE nut_gravar_imp_rel_dieta ( dt_servico_p timestamp, nr_Seq_Tipo_imp_p bigint, nm_usuario_p text) FROM PUBLIC;

