-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE tiss_define_guia_exame_ext (nr_seq_pedido_p bigint, nm_usuario_p text) AS $body$
DECLARE

 
ie_regra_w		varchar(10);
ie_mesma_guia_w		varchar(1);
ie_guia_pedido_exame_w	varchar(1);			
cd_autorizacao_w	varchar(20);	
nr_doc_conv_principal_w	varchar(20);
cd_senha_regra_w	varchar(20);
cd_autorizacao_regra_w	varchar(20);
ie_guia_w		varchar(255);	
nr_atendimento_w	bigint;
ie_pendente_w	varchar(1);
cd_convenio_w		atend_categoria_convenio.cd_convenio%type;			
cd_estabelecimento_w	atendimento_paciente.cd_estabelecimento%type;


BEGIN 
	 
begin	 
select	a.cd_convenio, 
	b.cd_estabelecimento, 
	b.nr_atendimento, 
	c.ie_pendente 
into STRICT	cd_convenio_w, 
	cd_estabelecimento_w, 
	nr_atendimento_w, 
	ie_pendente_w 
from	atendimento_paciente b, 
	atend_categoria_convenio a, 
	pedido_exame_externo c 
where	a.nr_atendimento	= b.nr_atendimento 
and	c.nr_atendimento	= b.nr_atendimento 
and	a.nr_seq_interno	= obter_atecaco_atendimento(b.nr_atendimento) 
and	c.nr_sequencia		= nr_seq_pedido_p  LIMIT 1;
exception 
when others then 
	cd_convenio_w		:= null;
	cd_estabelecimento_w	:= null;
end;	
 
cd_autorizacao_w	:= null;
 
if (cd_convenio_w IS NOT NULL AND cd_convenio_w::text <> '') and (cd_estabelecimento_w IS NOT NULL AND cd_estabelecimento_w::text <> '') then 
	 
	select	coalesce(max(ie_guia_pedido_exame),'R') 
	into STRICT	ie_guia_pedido_exame_w 
	from	tiss_parametros_convenio 
	where	cd_estabelecimento	= cd_estabelecimento_w 
	and	cd_convenio		= cd_convenio_w;
		 
	if (ie_guia_pedido_exame_w = 'A') then 
		 
		select	max(tiss_obter_guia_data(nr_atendimento_w, cd_convenio_w, clock_timestamp(), null, 'A')) 
		into STRICT	cd_autorizacao_w 
		;		
	 
	elsif (ie_guia_pedido_exame_w = 'R') and (ie_pendente_w <> 'S') then 
		SELECT * FROM TISS_OBTER_GUIA('4', null, cd_autorizacao_w, 'N', null, null, null, null, null, ie_guia_w, nr_seq_pedido_p, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null) INTO STRICT cd_autorizacao_w, ie_guia_w;
	end if;
 
	update 	pedido_exame_externo 
	set 	cd_autorizacao	= cd_autorizacao_w, 
		nm_usuario	= nm_usuario_p, 
		dt_atualizacao	= clock_timestamp() 
	where 	nr_sequencia 	= nr_seq_pedido_p;
	 
	commit;	
 
end if;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE tiss_define_guia_exame_ext (nr_seq_pedido_p bigint, nm_usuario_p text) FROM PUBLIC;

