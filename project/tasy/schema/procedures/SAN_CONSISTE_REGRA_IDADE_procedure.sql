-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE san_consiste_regra_idade ( cd_pessoa_fisica_p text, cd_estabelecimento_p bigint, ds_mensagem_p INOUT text, ie_acao_p INOUT text) AS $body$
DECLARE


nr_idade_doador_w	bigint;
nr_idade_min_w		bigint;
nr_idade_max_w		bigint;
ie_acao_w		varchar(1);


BEGIN
if (cd_pessoa_fisica_p IS NOT NULL AND cd_pessoa_fisica_p::text <> '') then
	select  max((substr(obter_idade(dt_nascimento,clock_timestamp(),'A'),1,50))::numeric )
	into STRICT	nr_idade_doador_w
	from    pessoa_fisica
	where   cd_pessoa_Fisica = cd_pessoa_Fisica_p;

	select	max(nr_idade_min),
		max(nr_idade_max),
		max(ie_acao)
	into STRICT	nr_idade_min_w,
		nr_idade_max_w,
		ie_acao_w
	from 	san_regra_idade
	where	nr_sequencia = ( SELECT max(nr_sequencia)
				from	san_regra_idade
				where 	ie_situacao = 'A'
				and	cd_estabelecimento = cd_estabelecimento_p);


	if (nr_idade_min_w IS NOT NULL AND nr_idade_min_w::text <> '') and (nr_idade_max_w IS NOT NULL AND nr_idade_max_w::text <> '') and (ie_acao_w IS NOT NULL AND ie_acao_w::text <> '') then
		if (nr_idade_doador_w < nr_idade_min_w) then
			if (ie_acao_w = 'A') then
				ds_mensagem_p := wheb_mensagem_pck.get_texto(309906, 'NR_IDADE_MIN_W=' || to_char(nr_idade_min_w)); -- Idade inferior a #@NR_IDADE_MIN_W#@ anos.
				ie_acao_p := 'A';
			elsif (ie_acao_w = 'Q') then
				ds_mensagem_p := wheb_mensagem_pck.get_texto(309906, 'NR_IDADE_MIN_W=' || to_char(nr_idade_min_w)) || ' ' || wheb_mensagem_pck.get_texto(309910); -- Idade inferior a #@NR_IDADE_MIN_W#@ anos. Deseja continuar?
				ie_acao_p := 'Q';
			elsif (ie_acao_w = 'B') then
				ds_mensagem_p := wheb_mensagem_pck.get_texto(309906, 'NR_IDADE_MIN_W=' || to_char(nr_idade_min_w)); -- Idade inferior a #@NR_IDADE_MIN_W#@ anos.
				ie_acao_p := 'B';
			end if;
		elsif (nr_idade_doador_w > nr_idade_max_w) then
			if (ie_acao_w = 'A') then
				ds_mensagem_p := wheb_mensagem_pck.get_texto(309914, 'NR_IDADE_MAX_W='|| to_char(nr_idade_max_w)); -- Idade superior a #@NR_IDADE_MAX_W#@ anos.
				ie_acao_p := 'A';
			elsif (ie_acao_w = 'Q') then
				ds_mensagem_p := wheb_mensagem_pck.get_texto(309914, 'NR_IDADE_MAX_W='|| to_char(nr_idade_max_w)) || ' ' || wheb_mensagem_pck.get_texto(309910); --  Idade superior a #@NR_IDADE_MAX_W#@ anos.
				ie_acao_p := 'Q';
			elsif (ie_acao_w = 'B') then
				ds_mensagem_p := wheb_mensagem_pck.get_texto(309914, 'NR_IDADE_MAX_W='|| to_char(nr_idade_max_w)); -- Idade superior a #@NR_IDADE_MAX_W#@ anos.
				ie_acao_p := 'B';
			end if;
		end if;
	else
		if (nr_idade_doador_w < 18) then
			ds_mensagem_p := wheb_mensagem_pck.get_texto(309906, 'NR_IDADE_MIN_W=18') || ' ' || wheb_mensagem_pck.get_texto(309910); -- Idade inferior a #@NR_IDADE_MIN_W#@ anos. Deseja continuar?
			ie_acao_p := 'N';
		elsif (nr_idade_doador_w > 65) then
			ds_mensagem_p := wheb_mensagem_pck.get_texto(309914, 'NR_IDADE_MAX_W=65') || ' ' || wheb_mensagem_pck.get_texto(309910); -- Idade superior a #@NR_IDADE_MAX_W#@ anos. Deseja continuar?
			ie_acao_p := 'N';
		end if;
	end if;


end if;
commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE san_consiste_regra_idade ( cd_pessoa_fisica_p text, cd_estabelecimento_p bigint, ds_mensagem_p INOUT text, ie_acao_p INOUT text) FROM PUBLIC;

