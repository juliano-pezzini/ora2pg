-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE lab_baixar_exame_pendente ( qt_hora_adicional_p bigint, cd_motivo_baixa_p bigint, dt_parametro_p timestamp, dt_inicio_validacao_p timestamp, ie_status_atend_p bigint, ie_tipo_atendimento_p bigint) AS $body$
DECLARE

 
qt_dia_adicional_w	double precision;
			

BEGIN 
 
qt_dia_adicional_w := qt_hora_adicional_p / 24;
 
update	prescr_procedimento a 
set	cd_motivo_baixa = cd_motivo_baixa_p, 
	dt_baixa = clock_timestamp(), 
	nm_usuario_baixa = 'TasyJob', 
	dt_suspensao = clock_timestamp(), 
	nm_usuario_susp = 'TasyJob', 
	ie_suspenso = 'S' 
where	cd_motivo_baixa = 0 
and	coalesce(ie_status_atend,1) <= ie_status_atend_p 
and	(nr_seq_exame IS NOT NULL AND nr_seq_exame::text <> '') 
and	coalesce(dt_cancelamento::text, '') = '' 
and	exists (SELECT	1 
     from	prescr_medica b, 
     	atendimento_paciente c 
     where	a.nr_prescricao	= b.nr_prescricao 
     and	b.nr_atendimento = c.nr_atendimento 
     and	b.dt_prescricao + qt_dia_adicional_w < dt_parametro_p 
	 and 	b.dt_prescricao > dt_inicio_validacao_p 
     and	c.ie_tipo_atendimento = ie_tipo_atendimento_p) 
and not exists (select	1 
	 from	procedimento_paciente x, 
		convenio y 
	 where	x.nr_prescricao = a.nr_prescricao 
	 and	x.nr_sequencia_prescricao = a.nr_sequencia 
	 and	x.cd_convenio = y.cd_convenio 
	 and 	y.ie_tipo_convenio <> 1);
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE lab_baixar_exame_pendente ( qt_hora_adicional_p bigint, cd_motivo_baixa_p bigint, dt_parametro_p timestamp, dt_inicio_validacao_p timestamp, ie_status_atend_p bigint, ie_tipo_atendimento_p bigint) FROM PUBLIC;

