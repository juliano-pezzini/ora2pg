-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_escala_mews_integracao (nr_seq_sinal_vital_p bigint, qt_nivel_con_w bigint default null) AS $body$
DECLARE


qt_freq_cardiaca_p	atendimento_sinal_vital.QT_FREQ_CARDIACA%type;
qt_freq_resp_p	    atendimento_sinal_vital.QT_FREQ_RESP%type;
qt_pa_sistolica_p	atendimento_sinal_vital.QT_PA_SISTOLICA%type;
qt_temp_p           atendimento_sinal_vital.QT_TEMP%type;
nr_atendimento_w    atendimento_sinal_vital.NR_ATENDIMENTO%type;
cd_profissional_w   ESCALA_MEWS.CD_PROFISSIONAL%type;


BEGIN

IF (coalesce(nr_seq_sinal_vital_p,0) > 0) then

    select coalesce(max(QT_FREQ_CARDIACA),0),
           coalesce(max(QT_FREQ_RESP),0),
           coalesce(max(QT_PA_SISTOLICA),0),
           coalesce(max(QT_TEMP),0),
           coalesce(max(cd_pessoa_fisica),0)
    into STRICT   qt_freq_cardiaca_p,
           qt_freq_resp_p,
           qt_pa_sistolica_p,
           qt_temp_p,
           cd_profissional_w
    from ATENDIMENTO_SINAL_VITAL
    where nr_sequencia = nr_seq_sinal_vital_p;

    select max(nr_atendimento)
    into STRICT nr_atendimento_w
    from atendimento_sinal_vital
    where nr_sequencia = nr_seq_sinal_vital_p;

if (coalesce(cd_profissional_w::text, '') = '' or cd_profissional_w = 0) then
    select max(CD_EXTERNO)
    into STRICT cd_profissional_w
    from CONVERSAO_MEIO_EXTERNO
    where NM_TABELA = 'ESCALA_MEWS'
    and NM_ATRIBUTO = 'CD_PROFISSIONAL'
    and CD_INTERNO = 'Welch';
end if;

            if ((qt_freq_cardiaca_p > 0 or
                qt_freq_resp_p > 0 or
                qt_pa_sistolica_p > 0 or
                qt_temp_p > 0 or
                qt_nivel_con_w > 0) and ((cd_profissional_w IS NOT NULL AND cd_profissional_w::text <> '') and cd_profissional_w > 0) and
                (nr_atendimento_w IS NOT NULL AND nr_atendimento_w::text <> '')) then

                    insert into ESCALA_MEWS(DT_AVALIACAO,
                                             CD_PROFISSIONAL,
                                             DT_ATUALIZACAO,
                                             NR_SEQUENCIA,
                                             NM_USUARIO,
                                             IE_SITUACAO,
                                             NR_ATENDIMENTO,
                                             QT_TEMP,
                                             DT_LIBERACAO,
                                             QT_FREQ_RESP,
                                             QT_FREQ_CARDIACA,
                                             QT_PA_SISTOLICA,
                                             IE_NIVEL_CONSCIENCIA,
                                             NR_SEQ_SINAL_VITAL)
                                     values (clock_timestamp(),
                                             cd_profissional_w,
                                             clock_timestamp(),
                                             nextval('escala_mews_seq'),
                                             'Welch Allyn',
                                             'A',
                                             nr_atendimento_w,
                                             qt_temp_p,
                                             clock_timestamp(),
                                             qt_freq_resp_p,
                                             qt_freq_cardiaca_p,
                                             qt_pa_sistolica_p,
                                             qt_nivel_con_w,
                                             nr_seq_sinal_vital_p);

            end if;
commit;

end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_escala_mews_integracao (nr_seq_sinal_vital_p bigint, qt_nivel_con_w bigint default null) FROM PUBLIC;

