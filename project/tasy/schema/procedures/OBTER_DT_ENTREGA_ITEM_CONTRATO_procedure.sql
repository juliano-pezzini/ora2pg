-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE obter_dt_entrega_item_contrato ( cd_estabelecimento_p bigint, cd_material_p bigint, qt_dias_parametro_p bigint, ie_dias_uteis_p text, dt_entrega_p INOUT timestamp) AS $body$
DECLARE


ie_item_contrato_w		varchar(1) := 'N';
qt_dias_w		bigint;
dt_entrega_w		timestamp;
dt_base_w		timestamp;
qt_dia_corrido_w		bigint := 0;
qt_dia_util_w		bigint := 0;
qt_registro_w		bigint := 0;


BEGIN

dt_base_w		:= trunc(clock_timestamp(), 'dd');
qt_dias_w		:= coalesce(qt_dias_parametro_p,7);

if (cd_material_p IS NOT NULL AND cd_material_p::text <> '') then
	select count(*)
	into STRICT	qt_registro_w
	from   (SELECT	1
		from	contrato_regra_nf a,
			contrato b
		where	a.nr_seq_contrato = b.nr_sequencia
		and	((coalesce(a.cd_material, cd_material_p) = cd_material_p) or (obter_dados_material(a.cd_material,'EST') = obter_dados_material(cd_material_p,'EST')))
		and	substr(obter_dados_pf_pj(null,b.cd_cgc_contratado,'S'),1,1) = 'A'
		and	((coalesce(a.dt_inicio_vigencia::text, '') = '') or (trunc(a.dt_inicio_vigencia,'dd') <= trunc(clock_timestamp(),'dd')))
		and	((coalesce(a.dt_fim_vigencia::text, '') = '') or (trunc(a.dt_fim_vigencia,'dd') >= trunc(clock_timestamp(),'dd')))
        and (coalesce(a.ie_situacao::text, '') = '' or a.ie_situacao = 'A')
		and	coalesce(cd_pessoa_contratada::text, '') = ''
		and	coalesce(b.ie_situacao,'A') = 'A'
		and	coalesce(a.ie_tipo_regra,'NF') = 'NF'
		
union all

		SELECT	1
		from	contrato_regra_nf a,
			contrato b
		where	a.nr_seq_contrato = b.nr_sequencia
		and	((coalesce(a.cd_material, cd_material_p) = cd_material_p) or (obter_dados_material(a.cd_material,'EST') = obter_dados_material(cd_material_p,'EST')))
		and	((coalesce(a.dt_inicio_vigencia::text, '') = '') or (trunc(a.dt_inicio_vigencia,'dd') <= trunc(clock_timestamp(),'dd')))
		and	((coalesce(a.dt_fim_vigencia::text, '') = '') or (trunc(a.dt_fim_vigencia,'dd') >= trunc(clock_timestamp(),'dd')))
        and (coalesce(a.ie_situacao::text, '') = '' or a.ie_situacao = 'A')
		and	(cd_pessoa_contratada IS NOT NULL AND cd_pessoa_contratada::text <> '')
		and	coalesce(b.ie_situacao,'A') = 'A'
		and	coalesce(a.ie_tipo_regra,'NF') = 'NF') alias54;

	if (qt_registro_w > 0) then
		ie_item_contrato_w := 'S';
	end if;
end if;

if (ie_item_contrato_w = 'S') then	
	select	coalesce(obter_dias_entrega_item_contr(cd_material_p, cd_estabelecimento_p),0)
	into STRICT	qt_dias_w
	;
end if;
	
if (ie_dias_uteis_p = 'S') and (qt_dias_w > 0) then
	begin
	
	while(qt_dia_util_w <= qt_dias_w) loop
			
	if (obter_se_dia_util(dt_base_w + qt_dia_corrido_w, cd_estabelecimento_p) = 'S') then
		qt_dia_util_w	:= qt_dia_util_w + 1;
	end if;
				
	qt_dia_corrido_w	:= qt_dia_corrido_w + 1;
	
	end loop;
	
	dt_entrega_w	:= dt_base_w + qt_dia_corrido_w - 1;
	end;
else
	select	CASE WHEN coalesce(qt_dias_w,0)=0 THEN qt_dias_parametro_p  ELSE qt_dias_w END
	into STRICT	qt_dias_w
	;
	
	dt_entrega_w	:= trunc(clock_timestamp(),'dd') + qt_dias_w;
end if;	

dt_entrega_p := dt_entrega_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE obter_dt_entrega_item_contrato ( cd_estabelecimento_p bigint, cd_material_p bigint, qt_dias_parametro_p bigint, ie_dias_uteis_p text, dt_entrega_p INOUT timestamp) FROM PUBLIC;

