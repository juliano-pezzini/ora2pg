-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_w_ranking_fornec ( ie_analitico_sintetico_p text, ie_considera_cancel_p text, dt_inicial_p timestamp, dt_final_p timestamp, ds_lista_pessoa_p text, ds_lista_cgc_p text, vl_inicial_p bigint, vl_final_p bigint, qtd_registros_p bigint, nm_usuario_p text, ds_lista_estab_p text) AS $body$
DECLARE

 
 
 
cd_cgc_w		varchar(14);
cd_classif_w      integer;
cd_estabelecimento_w	smallint;
cd_pessoa_fisica_w   varchar(10);
ds_fornecedor_w     varchar(80);
dt_baixa_w       timestamp;
dt_contabil_w      timestamp;
dt_emissao_w      timestamp;
nr_sequencia_w     bigint;
nr_titulo_w       bigint;
vl_desconto_w      double precision;
vl_juros_w       double precision;
vl_multa_w       double precision;
vl_original_w      double precision;
vl_pago_w        double precision;
vl_tot_pago_w      double precision;
ie_continua_w		varchar(1);
nr_tit_anterior_w	bigint;
ds_lista_pessoa_w	varchar(4000);
ds_lista_cgc_w		varchar(4000);
ie_todos_menos_cgc_w	varchar(1)	:= 'N';
ie_todos_menos_pf_w	varchar(1)	:= 'N';
ds_lista_estab_w	varchar(4000);

/* maiores fornecedores */
 
c01 CURSOR FOR 
SELECT	cd_pessoa_fisica, 
	cd_cgc, 
	sum(vl) vl_pago 
from		 
	(SELECT	a.cd_pessoa_fisica, 
		a.cd_cgc, 
		sum(coalesce(b.vl_pago,0)) vl	 
	from	titulo_pagar_baixa b, 
		titulo_pagar a	 
	where	b.nr_titulo		= a.nr_titulo 
	/* ahoffelder - OS 262677 - 09/11/2010 - tirei todas as restrições por estabelecimento, pq foi incluído filtro no relatório 
	and	a.cd_estabelecimento	= cd_estabelecimento_p */
 
	and	b.dt_baixa between dt_inicial_p and dt_final_p 
	and	coalesce(ds_lista_cgc_p::text, '') = '' 
	and	coalesce(ds_lista_pessoa_p::text, '') = '' 
	and	(('N' = ie_considera_cancel_p and a.ie_situacao <> 'C') or ('S' = ie_considera_cancel_p and (a.ie_situacao IS NOT NULL AND a.ie_situacao::text <> ''))) 
	and (coalesce(ds_lista_estab_p::text, '') = '' or ds_lista_estab_w like '% ' || to_char(a.cd_estabelecimento) || ' %') 
	group by 
		a.cd_pessoa_fisica, 
		a.cd_cgc 
	
union all
 
	select	a.cd_pessoa_fisica, 
		a.cd_cgc, 
		sum(coalesce(b.vl_pago,0)) vl	 
	from	titulo_pagar_baixa b, 
		titulo_pagar a	 
	where	b.nr_titulo		= a.nr_titulo 
	-- and	a.cd_estabelecimento	= cd_estabelecimento_p 
	and	b.dt_baixa between dt_inicial_p and dt_final_p 
	and	(a.cd_cgc IS NOT NULL AND a.cd_cgc::text <> '') 
	and	(ds_lista_cgc_p IS NOT NULL AND ds_lista_cgc_p::text <> '') 
	and	(('N' = ie_considera_cancel_p and a.ie_situacao <> 'C') or ('S' = ie_considera_cancel_p and (a.ie_situacao IS NOT NULL AND a.ie_situacao::text <> '')))	 
	and	ds_lista_cgc_w like '% ' || a.cd_cgc || ' %' 
	and	ie_todos_menos_cgc_w = 'N' 
	and (coalesce(ds_lista_estab_p::text, '') = '' or ds_lista_estab_w like '% ' || to_char(a.cd_estabelecimento) || ' %') 
	group by 
		a.cd_pessoa_fisica, 
		a.cd_cgc 
	
union all
 
	select	a.cd_pessoa_fisica, 
		a.cd_cgc, 
		sum(coalesce(b.vl_pago,0)) vl	 
	from	titulo_pagar_baixa b, 
		titulo_pagar a	 
	where	b.nr_titulo		= a.nr_titulo 
	-- and	a.cd_estabelecimento	= cd_estabelecimento_p 
	and	b.dt_baixa between dt_inicial_p and dt_final_p 
	and	(a.cd_cgc IS NOT NULL AND a.cd_cgc::text <> '') 
	and	(ds_lista_cgc_p IS NOT NULL AND ds_lista_cgc_p::text <> '') 
	and	(('N' = ie_considera_cancel_p and a.ie_situacao <> 'C') or ('S' = ie_considera_cancel_p and (a.ie_situacao IS NOT NULL AND a.ie_situacao::text <> ''))) 
	and	ds_lista_cgc_w not like '% ' || a.cd_cgc || ' %' 
	and	ie_todos_menos_cgc_w = 'S' 
	and (coalesce(ds_lista_estab_p::text, '') = '' or ds_lista_estab_w like '% ' || to_char(a.cd_estabelecimento) || ' %') 
	group by 
		a.cd_pessoa_fisica, 
		a.cd_cgc 
	
union all
 
	select	a.cd_pessoa_fisica, 
		a.cd_cgc, 
		sum(coalesce(b.vl_pago,0)) vl	 
	from	titulo_pagar_baixa b, 
		titulo_pagar a	 
	where	b.nr_titulo		= a.nr_titulo 
	-- and	a.cd_estabelecimento	= cd_estabelecimento_p 
	and	b.dt_baixa between dt_inicial_p and dt_final_p 
	and	(a.cd_pessoa_fisica IS NOT NULL AND a.cd_pessoa_fisica::text <> '') 
	and	(ds_lista_pessoa_p IS NOT NULL AND ds_lista_pessoa_p::text <> '') 
	and	(('N' = ie_considera_cancel_p and a.ie_situacao <> 'C') or ('S' = ie_considera_cancel_p and (a.ie_situacao IS NOT NULL AND a.ie_situacao::text <> ''))) 
	and	ds_lista_pessoa_w like '% ' || a.cd_pessoa_fisica || ' %' 
	and	ie_todos_menos_pf_w = 'N' 
	and (coalesce(ds_lista_estab_p::text, '') = '' or ds_lista_estab_w like '% ' || to_char(a.cd_estabelecimento) || ' %') 
	group by 
		a.cd_pessoa_fisica, 
		a.cd_cgc 
	
union all
 
	select	a.cd_pessoa_fisica, 
		a.cd_cgc, 
		sum(coalesce(b.vl_pago,0)) vl	 
	from	titulo_pagar_baixa b, 
		titulo_pagar a	 
	where	b.nr_titulo		= a.nr_titulo 
	-- and	a.cd_estabelecimento	= cd_estabelecimento_p 
	and	b.dt_baixa between dt_inicial_p and dt_final_p 
	and	(a.cd_pessoa_fisica IS NOT NULL AND a.cd_pessoa_fisica::text <> '') 
	and	(ds_lista_pessoa_p IS NOT NULL AND ds_lista_pessoa_p::text <> '') 
	and	(('N' = ie_considera_cancel_p and a.ie_situacao <> 'C') or ('S' = ie_considera_cancel_p and (a.ie_situacao IS NOT NULL AND a.ie_situacao::text <> ''))) 
	and	ds_lista_pessoa_w not like '% ' || a.cd_pessoa_fisica || ' %' 
	and	ie_todos_menos_pf_w = 'S' 
	and (coalesce(ds_lista_estab_p::text, '') = '' or ds_lista_estab_w like '% ' || to_char(a.cd_estabelecimento) || ' %') 
	group by 
		a.cd_pessoa_fisica, 
		a.cd_cgc 
	) alias56 
GROUP BY 
	cd_pessoa_fisica, 
	cd_cgc 
 HAVING sum(vl) between coalesce(vl_inicial_p,0) and coalesce(vl_final_p,9999999999) 
order by 
	vl_pago desc;

 
/* titulos por fornecedores */
 
c02 CURSOR FOR 
SELECT	a.dt_contabil,       
	a.dt_emissao,        
	a.nr_titulo,        
	b.dt_baixa,	 
	coalesce(b.vL_descontos,0),       
	coalesce(b.vl_juros,0), 
	coalesce(b.vl_multa,0),       
	coalesce(a.vl_titulo,0),       
	coalesce(b.vl_pago,0), 
	a.cd_estabelecimento	 
from	titulo_pagar_baixa b, 
	titulo_pagar a	 
where	b.dt_baixa between dt_inicial_p and dt_final_p		 
and	b.nr_titulo 		= a.nr_titulo 
-- and	a.cd_estabelecimento	= cd_estabelecimento_p 
and	a.cd_pessoa_fisica	= cd_pessoa_fisica_w     
and	(('N' = ie_considera_cancel_p and a.ie_situacao <> 'C') or ('S' = ie_considera_cancel_p and (a.ie_situacao IS NOT NULL AND a.ie_situacao::text <> ''))) 
and (coalesce(ds_lista_estab_p::text, '') = '' or ds_lista_estab_w like '% ' || to_char(a.cd_estabelecimento) || ' %') 

union all
 
SELECT	a.dt_contabil,       
	a.dt_emissao,        
	a.nr_titulo,        
	b.dt_baixa, 
	coalesce(b.vL_descontos,0),       
	coalesce(b.vl_juros,0), 
	coalesce(b.vl_multa,0),       
	coalesce(a.vl_titulo,0),       
	coalesce(b.vl_pago,0), 
	a.cd_estabelecimento 
from	titulo_pagar_baixa b, 
	titulo_pagar a	 
where	b.dt_baixa between dt_inicial_p and dt_final_p		 
and	b.nr_titulo 		= a.nr_titulo 
-- and	a.cd_estabelecimento	= cd_estabelecimento_p 
and	a.cd_cgc		= cd_cgc_w  
and	(('N' = ie_considera_cancel_p and a.ie_situacao <> 'C') or ('S' = ie_considera_cancel_p and (a.ie_situacao IS NOT NULL AND a.ie_situacao::text <> ''))) 
and (coalesce(ds_lista_estab_p::text, '') = '' or ds_lista_estab_w like '% ' || to_char(a.cd_estabelecimento) || ' %') 
order by 
	3;
	

BEGIN 
 
delete from w_ranking_fornec where nm_usuario = nm_usuario_p;
 
if (substr(ds_lista_cgc_p,1,1) = '-') then 
	ie_todos_menos_cgc_w	:= 'S';
end if;
 
if (substr(ds_lista_pessoa_p,1,1) = '-') then 
	ie_todos_menos_pf_w	:= 'S';
end if;
 
ds_lista_cgc_w		:= ' ' || replace(replace(replace(replace(ds_lista_cgc_p,'(',' '),')',' '),',',' '),'-','') || ' ';
ds_lista_pessoa_w	:= ' ' || replace(replace(replace(replace(ds_lista_pessoa_p,'(',' '),')',' '),',',' '),'-','') || ' ';
ds_lista_estab_w	:= ' ' || replace(replace(replace(replace(ds_lista_estab_p,'(',' '),')',' '),',',' '),'-','') || ' ';
 
cd_classif_w		:= 1;
ie_continua_w		:= 'S';
 
open c01;
loop 
fetch c01 into 
	cd_pessoa_fisica_w, 
	cd_cgc_w, 
	vl_tot_pago_w;
EXIT WHEN NOT FOUND or ie_continua_w	= 'N';  /* apply on c01 */
 
	ds_fornecedor_w	:= obter_nome_pf_pj(cd_pessoa_fisica_w,cd_cgc_w);
	 
	nr_tit_anterior_w	:= '';
 
	open c02;	
	loop 
	fetch c02 into 
		dt_contabil_w,      
		dt_emissao_w,       
		nr_titulo_w,       
		dt_baixa_w,       	 
		vl_desconto_w,      
		vl_juros_w,        
		vl_multa_w, 
		vl_original_w, 
		vl_pago_w, 
		cd_estabelecimento_w;
	EXIT WHEN NOT FOUND; /* apply on c02 */
 
		if (nr_tit_anterior_w = nr_titulo_w) then 
			vl_original_w := 0;
		end if;
		nr_tit_anterior_w := nr_titulo_w;
	 
		insert into w_ranking_fornec(cd_cgc,          
			cd_classif,        
			cd_estabelecimento,    
			cd_pessoa_fisica,     
			ds_fornecedor,      
			dt_atualizacao,      
			dt_atualizacao_nrec, 
			dt_baixa,         
			dt_contabil,       
			dt_emissao,        
			nm_usuario,        
			nm_usuario_nrec,     
			nr_sequencia,       
			nr_titulo,        
			vl_desconto,       
			vl_juros,         
			vl_multa,         
			vl_original,       
			vl_pago) 
		values (cd_cgc_w,          
			cd_classif_w, 
			cd_estabelecimento_w, 
			cd_pessoa_fisica_w,     
			ds_fornecedor_w, 
			clock_timestamp(), 
			clock_timestamp(),      
			dt_baixa_w,         
			dt_contabil_w,       
			dt_emissao_w, 
			nm_usuario_p,       
			nm_usuario_p, 
			nextval('w_ranking_fornec_seq'),	 
			nr_titulo_w,        
			vl_desconto_w,       
			vl_juros_w,         
			vl_multa_w,         
			vl_original_w,       
			vl_pago_w);
 
	end loop;
	close c02;
 
	cd_classif_w	:= cd_classif_w + 1;
 
	if (cd_classif_w > qtd_registros_p) then 
		ie_continua_w	:= 'N';	
	end if;	
 
end loop;
close c01;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_w_ranking_fornec ( ie_analitico_sintetico_p text, ie_considera_cancel_p text, dt_inicial_p timestamp, dt_final_p timestamp, ds_lista_pessoa_p text, ds_lista_cgc_p text, vl_inicial_p bigint, vl_final_p bigint, qtd_registros_p bigint, nm_usuario_p text, ds_lista_estab_p text) FROM PUBLIC;

