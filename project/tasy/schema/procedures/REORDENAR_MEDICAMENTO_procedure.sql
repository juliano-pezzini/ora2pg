-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';



CREATE TYPE lista AS (
	aa prescr_material.nr_agrupamento%type,
	an prescr_material.nr_agrupamento%type);


CREATE OR REPLACE PROCEDURE reordenar_medicamento ( nr_prescricao_p bigint) AS $body$
DECLARE


nr_sequencia_w		 prescr_material.nr_sequencia%type;
nr_agrupamento_w		 prescr_material.nr_agrupamento%type;
nr_agrupamento_ww	 prescr_material.nr_agrupamento%type;
nr_agrupamento_aux_w	 prescr_material.nr_agrupamento%type;
ie_ordena_via_w		 varchar(3);
cd_estabelecimento_w 	 estabelecimento.cd_estabelecimento%type;
nm_usuario_w		 usuario.nm_usuario%type;
nr_agrupamento_acum_w	 varchar(4000);
qt_contador_w		 bigint := 0;
i			 bigint := 0;
tam_lista_w		 bigint;


c01 REFCURSOR;
type arrayAgrupador is table of lista index by integer;
agrup_parametros_w arrayAgrupador;


BEGIN

if (nr_prescricao_p IS NOT NULL AND nr_prescricao_p::text <> '') then

	select	max(cd_estabelecimento),
		max(nm_usuario_original)
	into STRICT	cd_estabelecimento_w,
		nm_usuario_w
	from	prescr_medica
	where	nr_prescricao	= nr_prescricao_p;

	ie_ordena_via_w := Obter_Param_Usuario(924, 157, obter_perfil_ativo, nm_usuario_w, cd_estabelecimento_w, ie_ordena_via_w);

	nr_agrupamento_ww	:=  0;
	nr_agrupamento_acum_w	:= ',';


	if (ie_ordena_via_w = 'S') then -- c01
		open c01 for
			SELECT	a.nr_sequencia,
				a.nr_agrupamento
			FROM material b, prescr_material a
LEFT OUTER JOIN via_aplicacao c ON (a.ie_via_aplicacao = c.ie_via_aplicacao)
WHERE 1 = 1  --and	b.ie_tipo_material > 1
  and a.cd_material = b.cd_material and a.ie_agrupador = 1 and coalesce(a.nr_sequencia_dieta::text, '') = '' and coalesce(a.nr_sequencia_proc::text, '') = '' and coalesce(a.nr_sequencia_solucao::text, '') = '' and coalesce(a.nr_sequencia_diluicao::text, '') = '' and a.nr_prescricao = nr_prescricao_p order by	c.nr_impressao,
				a.ie_via_aplicacao,
				a.nr_agrupamento,
				a.nr_sequencia;
	elsif (ie_ordena_via_w = 'D')	 then  -- c03
		open c01 for
			SELECT	a.nr_sequencia,
				a.nr_agrupamento
			FROM material b, prescr_material a
LEFT OUTER JOIN via_aplicacao c ON (a.ie_via_aplicacao = c.ie_via_aplicacao)
WHERE 1 = 1  --and	b.ie_tipo_material > 1
  and a.cd_material = b.cd_material and coalesce(a.nr_sequencia_dieta::text, '') = '' and coalesce(a.nr_sequencia_proc::text, '') = '' and coalesce(a.nr_sequencia_solucao::text, '') = '' and coalesce(a.nr_sequencia_diluicao::text, '') = '' and a.ie_agrupador = 1 and a.nr_prescricao = nr_prescricao_p order by	b.ds_material,
				c.nr_impressao,
				a.ie_via_aplicacao,
				a.nr_agrupamento,
				a.nr_sequencia;
	elsif (ie_ordena_via_w = 'V')	 then -- c04
		open c01 for
			SELECT	a.nr_sequencia,
				a.nr_agrupamento
			FROM prescr_material a, material b
LEFT OUTER JOIN classe_material c ON (b.cd_classe_material = c.cd_classe_material)
WHERE 1 = 1  --and	b.ie_tipo_material > 1
  and a.cd_material = b.cd_material and coalesce(a.nr_sequencia_dieta::text, '') = '' and coalesce(a.nr_sequencia_proc::text, '') = '' and coalesce(a.nr_sequencia_solucao::text, '') = '' and coalesce(a.nr_sequencia_diluicao::text, '') = '' and a.ie_agrupador = 1 and a.nr_prescricao = nr_prescricao_p order by	coalesce(c.nr_seq_apres,999),
				a.ie_via_aplicacao,
				b.ds_material,
				a.nr_agrupamento,
				a.nr_sequencia;
	elsif (ie_ordena_via_w = 'F')	 then -- c05
		open c01 for
			SELECT	a.nr_sequencia,
				a.nr_agrupamento
			FROM prescr_material a, material b
LEFT OUTER JOIN material_familia c ON (b.nr_seq_familia = c.nr_sequencia)
WHERE 1 = 1  --and	b.ie_tipo_material > 1
  and a.cd_material = b.cd_material and coalesce(a.nr_sequencia_dieta::text, '') = '' and coalesce(a.nr_sequencia_proc::text, '') = '' and coalesce(a.nr_sequencia_solucao::text, '') = '' and coalesce(a.nr_sequencia_diluicao::text, '') = '' and a.ie_agrupador = 1 and a.nr_prescricao = nr_prescricao_p Order by	c.nr_sequencia,
				a.ie_via_aplicacao,
				b.ds_material,
				a.nr_agrupamento,
				a.nr_sequencia;
	else -- c02
		open c01 for
			SELECT	a.nr_sequencia,
				a.nr_agrupamento
			from	material b,
				prescr_material a
			where	1 = 1
			--and	b.ie_tipo_material > 1
			and	a.cd_material = b.cd_material
			and	a.ie_agrupador = 1
			and	coalesce(a.nr_sequencia_dieta::text, '') = ''
			and	coalesce(a.nr_sequencia_proc::text, '') = ''
			and	coalesce(a.nr_sequencia_solucao::text, '') = ''
			and	coalesce(a.nr_sequencia_diluicao::text, '') = ''
			and	a.nr_prescricao = nr_prescricao_p
			order by	a.nr_agrupamento,
					a.nr_sequencia;
	end if;

	loop
	fetch c01 into
		nr_sequencia_w,
		nr_agrupamento_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
		begin
			if (position(','||nr_agrupamento_w||',' in ','||nr_agrupamento_acum_w||',') = 0) then
				nr_agrupamento_acum_w	:=	nr_agrupamento_acum_w || nr_agrupamento_w || ',';
				nr_agrupamento_ww	:=  nr_agrupamento_ww + 1;
			end if;

			nr_agrupamento_aux_w					:=  null;
			qt_contador_w						:= qt_contador_w +1;
			agrup_parametros_w[qt_contador_w].aa	:= nr_agrupamento_w;
			agrup_parametros_w[qt_contador_w].an	:= nr_agrupamento_ww;

			i := 1;

			tam_lista_w	:= coalesce(agrup_parametros_w.count,0);

			while(i < tam_lista_w) loop
				begin
				if (agrup_parametros_w[i].aa = nr_agrupamento_w) then
					nr_agrupamento_aux_w := agrup_parametros_w[i].an;
					i := tam_lista_w;
				else
					i := i+1;
				end if;
				end;
			end loop;

			update	prescr_material
			set	nr_agrupamento	= coalesce(nr_agrupamento_aux_w, nr_agrupamento_ww)
			where	nr_sequencia	= nr_sequencia_w
			and	nr_prescricao	= nr_prescricao_p;
		end;
	end loop;
	close c01;

	if (coalesce(wheb_usuario_pck.get_ie_commit, 'S') = 'S') then commit; end if;
end if;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE reordenar_medicamento ( nr_prescricao_p bigint) FROM PUBLIC;

