-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE atualiza_etiq_mat_hor ( nr_seq_etiqueta_p bigint, nr_seq_etiqueta_reap_p text, nm_usuario_p text, cd_estabelecimento_p text) AS $body$
DECLARE

								 
nr_sequencia_w		  adep_processo_frac.nr_sequencia%type;
nr_prescricao_w     prescr_medica.nr_prescricao%type;
nr_seq_processo_w    adep_processo.nr_sequencia%type;
nr_seq_etiqueta_w    adep_processo_frac.nr_sequencia%type;
ie_estorna_conta_w   char(1);
								

BEGIN 
if (nr_seq_etiqueta_reap_p IS NOT NULL AND nr_seq_etiqueta_reap_p::text <> '') and (nr_seq_etiqueta_p IS NOT NULL AND nr_seq_etiqueta_p::text <> '')	then 
	-- Aqui é descompactado o código digitado da etiqueta X(9) ______________(Etiqueta) X(Dígito verificador) 
	nr_seq_etiqueta_w	:= substr(nr_seq_etiqueta_reap_p,2,length(nr_seq_etiqueta_reap_p)-1);
	 
	select	max(a.nr_sequencia), 
      max(b.nr_prescricao), 
      max(b.nr_sequencia) 
	into STRICT	nr_sequencia_w, 
      nr_prescricao_w, 
      nr_seq_processo_w 
	from	adep_processo_frac a, 
      adep_processo b 
	where	a.nr_sequencia = nr_seq_etiqueta_w 
  and   a.nr_seq_processo  =  b.nr_sequencia;
 
	if (nr_seq_processo_w IS NOT NULL AND nr_seq_processo_w::text <> '') and (nr_sequencia_w IS NOT NULL AND nr_sequencia_w::text <> '') and (nr_prescricao_w IS NOT NULL AND nr_prescricao_w::text <> '') then 
		ie_estorna_conta_w := Obter_Param_Usuario(3112, 72, somente_numero(wheb_usuario_pck.get_cd_perfil), nm_usuario_p, cd_estabelecimento_p, ie_estorna_conta_w);
		 
		if (ie_estorna_conta_w = 'S') then 
			CALL gedipa_estorna_presc_mat(nr_seq_processo_w,nr_sequencia_w ,nr_prescricao_w,nm_usuario_p);
		end if;
	end if;
   
	update 	prescr_mat_hor 
	set		nr_seq_etiqueta_reaprov 	=	nr_sequencia_w, 
			nm_usuario					=	nm_usuario_p, 
			dt_atualizacao				=	clock_timestamp() 
	where	nr_seq_etiqueta				=	nr_seq_etiqueta_p;
   
	commit;
end if;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE atualiza_etiq_mat_hor ( nr_seq_etiqueta_p bigint, nr_seq_etiqueta_reap_p text, nm_usuario_p text, cd_estabelecimento_p text) FROM PUBLIC;

