-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE dirf_mensal_registro_idrec ( nr_seq_lote_dirf_p bigint, nm_usuario_p text) AS $body$
DECLARE


cd_darf_w	varchar(10);
cd_tributo_w	smallint;
ds_arquivo_w	varchar(100);
separador_w	varchar(1) := '|';
nr_posicao_w	bigint := 4;
nr_sequencia_w	bigint;
qt_registros_w	bigint;
nr_seq_apres_w	bigint;

c01 CURSOR FOR
	SELECT	DISTINCT CASE WHEN t.cd_darf='588' THEN '0588'  ELSE t.cd_darf END
	FROM	dirf_titulo_pagar t,
		dirf_lote_mensal d,
		dirf_agrupar_lote a,
		dirf_lote l
	WHERE	t.nr_seq_lote_dirf = d.nr_sequencia
	AND	d.nr_sequencia 	   = a.nr_seq_lote_mensal
	AND	l.nr_sequencia 	= a.nr_seq_lote_anual
	AND    	a.nr_seq_lote_anual = nr_seq_lote_dirf_p
	AND	t.cd_darf <> '2305'
	AND	t.cd_darf <> '2631'
	and	t.cd_darf <> '2100'
	and	t.cd_darf <> '2127'
	and	t.cd_darf <> 'RIMUN'
	and	t.cd_darf <> 'RISEN'
	and 	coalesce(t.cd_darf,'X') <> 'X'
	ORDER BY CASE WHEN t.cd_darf='588' THEN '0588'  ELSE t.cd_darf END;


BEGIN

OPEN c01;
LOOP
FETCH c01 INTO
	cd_darf_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	BEGIN

	ds_arquivo_w := 'IDREC' || separador_w || LPAD(cd_darf_w,4,'0') || separador_w;

	SELECT	nextval('w_dirf_arquivo_seq')
	INTO STRICT	nr_sequencia_w
	;

	INSERT 	INTO w_dirf_arquivo(nr_sequencia,
				     nm_usuario,
				     nm_usuario_nrec,
				     dt_atualizacao,
				     dt_atualizacao_nrec,
				     ds_arquivo,
				     nr_seq_apresentacao,
				     nr_seq_registro)
	VALUES (nr_sequencia_w,
				     nm_usuario_p,
				     nm_usuario_p,
				     clock_timestamp(),
				     clock_timestamp(),
				     ds_arquivo_w,
				     TO_CHAR(nr_posicao_w),
				     0);

	COMMIT;

	nr_posicao_w := nr_posicao_w + 1;

	SELECT	count(*)
	into STRICT	qt_registros_w
	FROM	dirf_titulo_pagar t,
		dirf_lote_mensal d,
		dirf_agrupar_lote a,
		dirf_lote l
	WHERE	t.nr_seq_lote_dirf = d.nr_sequencia
	AND	d.nr_sequencia = a.nr_seq_lote_mensal
	AND	l.nr_sequencia = a.nr_seq_lote_anual
	AND    	a.nr_seq_lote_anual = nr_seq_lote_dirf_p
	AND	t.cd_darf = '588';

	if (qt_registros_w > 0) and (cd_darf_w = '0588') then
		cd_darf_w := '588';
	end if;

	-- inserir os dados da pessoa fisica referente ao codigo dirf selecionado
	nr_posicao_w := dirf_mensal_registro_bpfdec(nr_seq_lote_dirf_p, nm_usuario_p, nr_posicao_w, cd_darf_w);
	--inserir dados das pessoas jur√≠dicas
	nr_posicao_w := dirf_mensal_registro_bpjdec(nr_seq_lote_dirf_p, nm_usuario_p, nr_posicao_w, cd_darf_w);

	END;
END LOOP;
CLOSE c01;

COMMIT;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE dirf_mensal_registro_idrec ( nr_seq_lote_dirf_p bigint, nm_usuario_p text) FROM PUBLIC;

