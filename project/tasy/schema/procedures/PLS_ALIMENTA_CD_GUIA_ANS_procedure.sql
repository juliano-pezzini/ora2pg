-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_alimenta_cd_guia_ans () AS $body$
DECLARE


tb_sequencia_w			dbms_sql.number_table;
tb_guia_w			dbms_sql.varchar2_table;

c01 CURSOR FOR
	SELECT	a.nr_sequencia nr_seq_conta,
		a.cd_guia_ok
	from	pls_conta a
	where	ie_tipo_guia in ('6', '4')
	and	(nr_seq_conta_referencia IS NOT NULL AND nr_seq_conta_referencia::text <> '')
	and	coalesce(cd_guia_ans::text, '') = '';

BEGIN

pls_util_cta_pck.ie_grava_log_w := 'N';

-- Abrimos o cursor
open c01;

-- abrimos um loop para iterar enquanto ouverem registro do cursor.
loop

-- Limpamos os registros das listas para que não seja processado o mesmo registro mais de uma vez.
tb_sequencia_w.delete;
tb_guia_w.delete;

-- Executamos o fetch de um número determinado de linhas do cursor nas listas definidas, uma para cada campo da consulta.
fetch c01 bulk collect into tb_sequencia_w, tb_guia_w limit 1000;

-- Quando o cursor não tiver mais linhas então sai do loop.
exit when tb_sequencia_w.count = 0;

-- executamos as operações necessárias.
forall	i in tb_sequencia_w.first..tb_sequencia_w.last
	update 	pls_conta set
		cd_guia_ans = substr((tb_guia_w(i) || '-001-' || to_char(nextval('pls_cd_guia_ans_seq'))), 0, 20)
	where	nr_sequencia = tb_sequencia_w(i);

commit;

end loop;
-- Ao terminar fechamos o cursor.
close c01;

pls_util_cta_pck.ie_grava_log_w := 'S';

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_alimenta_cd_guia_ans () FROM PUBLIC;

