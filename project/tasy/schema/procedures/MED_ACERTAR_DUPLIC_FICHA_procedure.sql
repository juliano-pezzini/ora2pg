-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE med_acertar_duplic_ficha (nr_ficha_origem_p text, nr_ficha_destino_p text, cd_medico_p text, nm_usuario_p text) AS $body$
DECLARE


cd_medico_w		varchar(10);
nr_seq_orig_w		bigint;
nr_seq_dest_w		bigint;
qt_diag_w		bigint;
qt_cons_w		bigint;


BEGIN

select	coalesce(max(nr_sequencia),0)
into STRICT	nr_seq_orig_w
from	med_cliente
where	cd_medico		= cd_medico_p
and	cd_pessoa_sist_orig	= nr_ficha_origem_p;

select	coalesce(max(nr_sequencia),0)
into STRICT	nr_seq_dest_w
from	med_cliente
where	cd_medico		= cd_medico_p
and	cd_pessoa_sist_orig	= nr_ficha_destino_p;

if (nr_seq_orig_w <> 0) and (nr_seq_dest_w <> 0) then
	begin


	/* Atendimento */

	update	med_atendimento
	set	nr_seq_cliente	= nr_seq_dest_w
	where	nr_seq_cliente	= nr_seq_orig_w;


	/* CID */

	update	med_pac_cid
	set	nr_seq_cliente	= nr_seq_dest_w
	where	nr_seq_cliente	= nr_seq_orig_w;


	/* Diagnostico */

	select	count(*)
	into STRICT	qt_diag_w
	from 	med_pac_diagnostico
	where	nr_seq_cliente	= nr_seq_dest_w;

	if (qt_diag_w = 0) then
		update	med_pac_diagnostico
		set	nr_seq_cliente	= nr_seq_dest_w
		where	nr_seq_cliente	= nr_seq_orig_w;
	else
		delete	from med_pac_diagnostico
		where	nr_seq_cliente	= nr_seq_orig_w;
	end if;

	/* Pedido Exame */

	update	med_pedido_exame
	set	nr_seq_cliente	= nr_seq_dest_w
	where	nr_seq_cliente	= nr_seq_orig_w;

	/* Evolucao */

	update	med_evolucao
	set	nr_seq_cliente	= nr_seq_dest_w
	where	nr_seq_cliente	= nr_seq_orig_w;

	/* Receita */

	update	med_Receita
	set	nr_seq_cliente	= nr_seq_dest_w
	where	nr_seq_cliente	= nr_seq_orig_w;

	/* Resultado de exames */

	update	med_result_exame
	set	nr_seq_cliente	= nr_seq_dest_w
	where	nr_seq_cliente	= nr_seq_orig_w;

	/* Texto Adicional */

	update	med_texto_adicional
	set	nr_seq_cliente	= nr_seq_dest_w
	where	nr_seq_cliente	= nr_seq_orig_w;

	/* Exame Avaliacao */

	update	med_exame_avaliacao
	set	nr_seq_cliente	= nr_seq_dest_w
	where	nr_seq_cliente	= nr_seq_orig_w;

	/* Consulta */

	select	count(*)
	into STRICT	qt_cons_w
	from 	med_consulta
	where	nr_seq_cliente	= nr_seq_dest_w;

	if (qt_cons_w = 0) then
		update	med_consulta
		set	nr_seq_cliente	= nr_seq_dest_w
		where	nr_seq_cliente	= nr_seq_orig_w;
	else
		delete from med_consulta
		where	nr_seq_cliente	= nr_seq_orig_w;
	end if;

	/* Atestado */

	update	med_atestado
	set	nr_seq_cliente	= nr_seq_dest_w
	where	nr_seq_cliente	= nr_seq_orig_w;

	/* Alerta */

	update	med_alerta
	set	nr_seq_cliente	= nr_seq_dest_w
	where	nr_seq_cliente	= nr_seq_orig_w;

	/* Parecer MÃ©dico */

	update	med_parecer_medico
	set	nr_seq_cliente	= nr_seq_dest_w
	where	nr_seq_cliente	= nr_seq_orig_w;

	/* Seguranca */

	update	med_seguranca
	set	nr_seq_cliente	= nr_seq_dest_w
	where	nr_seq_cliente	= nr_seq_orig_w;

	/* Tratamento */

	update	med_tratamento
	set	nr_seq_cliente	= nr_seq_dest_w
	where	nr_seq_cliente	= nr_seq_orig_w;

	/* Pre Natal */

	update	med_pac_pre_natal
	set	nr_seq_cliente	= nr_seq_dest_w
	where	nr_seq_cliente	= nr_seq_orig_w;

	/* Ginecologia */

	update	med_pac_ginecologia
	set	nr_seq_cliente	= nr_seq_dest_w
	where	nr_seq_cliente	= nr_seq_orig_w;

	/* Avaliacao */

	update	med_aval_completa_pac
	set	nr_seq_cliente	= nr_seq_dest_w
	where	nr_seq_cliente	= nr_seq_orig_w;

	/* Sinal Vital */

	update	med_pac_sinal_vital
	set	nr_seq_cliente	= nr_seq_dest_w
	where	nr_seq_cliente	= nr_seq_orig_w;

	/* Contato */

	update	med_pac_contato
	set	nr_seq_cliente	= nr_seq_dest_w
	where	nr_seq_cliente	= nr_seq_orig_w;

	delete from med_cliente
	where	nr_sequencia	= nr_seq_orig_w;

	end;
end if;
commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE med_acertar_duplic_ficha (nr_ficha_origem_p text, nr_ficha_destino_p text, cd_medico_p text, nm_usuario_p text) FROM PUBLIC;

