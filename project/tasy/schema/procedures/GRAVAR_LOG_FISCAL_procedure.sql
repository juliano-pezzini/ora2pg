-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gravar_log_fiscal (cd_material_p bigint, nr_seq_nota_p text, nr_emprestimo_p text, ie_tipo_log_p bigint, nm_usuario_p text) AS $body$
DECLARE

			   
qt_registros_w	bigint;


BEGIN 
if (nr_seq_nota_p IS NOT NULL AND nr_seq_nota_p::text <> '') then 
 
	select 	count(*) 
	into STRICT	qt_registros_w 
	from	fis_variacao_fiscal_log 
	where	cd_material = cd_material_p 
	and	obter_dados_nota_fiscal(nr_seq_nota_p,31) = obter_dados_nota_fiscal(nr_seq_nota_fiscal,31) 
	and	ie_tipo_log = ie_tipo_log_p;
elsif (nr_emprestimo_p IS NOT NULL AND nr_emprestimo_p::text <> '') then 
	select 	count(*) 
	into STRICT	qt_registros_w 
	from	fis_variacao_fiscal_log 
	where	cd_material = cd_material_p 
	and	nr_emprestimo = nr_emprestimo_p 
	and	ie_tipo_log = ie_tipo_log_p;
end if;
 
if (qt_registros_w <= 0) then 
	insert into fis_variacao_fiscal_log(nr_sequencia, 
					nm_usuario, 
					nm_usuario_nrec, 
					dt_atualizacao, 
					dt_atualizacao_nrec, 
					cd_material, 
					ie_tipo_log, 
					nr_seq_nota_fiscal, 
					nr_emprestimo 
					) 
	values (nextval('fis_variacao_fiscal_log_seq'), 
					nm_usuario_p, 
					nm_usuario_p, 
					clock_timestamp(), 
					clock_timestamp(), 
					cd_material_p, 
					ie_tipo_log_p, 
					nr_seq_nota_p, 
					nr_emprestimo_p);
end if;				
				   
 
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gravar_log_fiscal (cd_material_p bigint, nr_seq_nota_p text, nr_emprestimo_p text, ie_tipo_log_p bigint, nm_usuario_p text) FROM PUBLIC;

