-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE softlab_ws_consistir_result ( nr_prescricao_p bigint, nr_seq_prescr_p bigint, cd_exame_p text, cd_material_exame_p text, cd_erro_p INOUT text, ds_erro_p INOUT text) AS $body$
DECLARE


nr_seq_exame_w	exame_laboratorio.nr_seq_exame%type;
ie_existe_w		varchar(1);


BEGIN
cd_erro_p	:= 0;
ds_erro_p	:= null;

ie_existe_w	:= 'S';

if (coalesce(nr_prescricao_p::text, '') = '') then
	ds_erro_p	:= WHEB_MENSAGEM_PCK.get_texto(278906,null);
	cd_erro_p	:= 412;
elsif (coalesce(nr_seq_prescr_p::text, '') = '') then
	ds_erro_p	:= WHEB_MENSAGEM_PCK.get_texto(280576,null);
	cd_erro_p	:= 412;
elsif (coalesce(cd_exame_p::text, '') = '') then
	ds_erro_p	:= WHEB_MENSAGEM_PCK.get_texto(280578,null);
	cd_erro_p	:= 412;
else

	select	max(a.nr_seq_exame)
	into STRICT	nr_seq_exame_w
	from	lab_exame_equip a,
			equipamento_lab b
	where	a.cd_equipamento = b.cd_equipamento
	and		b.ds_sigla = 'SOFTLABWS'
	and		a.cd_exame_equip = cd_exame_p;

	if (coalesce(nr_seq_exame_w::text, '') = '') then
		ds_erro_p	:= WHEB_MENSAGEM_PCK.get_texto(280581,null)||cd_exame_p;
		cd_erro_p	:= 412;
	else
		/*select	decode(count(*),0,'N','S')
		into	ie_existe_w
		from	prescr_procedimento a
		where	a.nr_prescricao = nr_prescricao_p
		and		a.nr_sequencia = nr_seq_prescr_p
		and		nr_seq_exame = nr_seq_exame_w;*/
		SELECT	CASE WHEN COUNT(*)=0 THEN 'N'  ELSE 'S' END
		INTO STRICT	ie_existe_w
		FROM	prescr_procedimento a,
			lab_exame_equip b,
			equipamento_lab c
		WHERE	a.nr_seq_exame = b.nr_seq_exame
		and	b.cd_equipamento = c.cd_equipamento
		and	c.ds_sigla = 'SOFTLABWS'
		and	a.nr_prescricao = nr_prescricao_p
		AND	a.nr_sequencia = nr_seq_prescr_p
		and	b.cd_exame_equip = cd_exame_p;


		if (ie_existe_w = 'N') then
			ds_erro_p	:= WHEB_MENSAGEM_PCK.get_texto(280582,'NR_PRESCRICAO='||to_char(nr_prescricao_p)||';NR_SEQ_PRESCR='||to_char(nr_seq_prescr_p)||';CD_EXAME='||cd_exame_p);
			cd_erro_p	:= 411;
		end if;
	end if;
end if;

/*if	(ie_existe_w = 'N') then
	cd_erro_p	:= 412;
	ds_erro_p	:= 'Código de procedimento não reconhecido (Problema de mapeamento) - '||ds_erro_p;
end if;*/
commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE softlab_ws_consistir_result ( nr_prescricao_p bigint, nr_seq_prescr_p bigint, cd_exame_p text, cd_material_exame_p text, cd_erro_p INOUT text, ds_erro_p INOUT text) FROM PUBLIC;

