-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE sus_gravar_w_painel_sus_fpo ( dt_competencia_p timestamp, cd_estabelecimento_p bigint, nm_usuario_p text) AS $body$
DECLARE


nr_seq_estrut_regra_w		w_painel_sus_fpo.nr_seq_estrut_regra%type;
nr_seq_forma_visual_w		w_painel_sus_fpo.nr_seq_forma_visual%type;
ds_estrutura_w			w_painel_sus_fpo.ds_estrutura%type;
ds_forma_visual_w		w_painel_sus_fpo.ds_forma_visual%type;
qt_resultado_fisico_w		w_painel_sus_fpo.qt_resultado_fisico%type;
vl_result_orcamento_w		w_painel_sus_fpo.vl_result_orcamento%type;
qt_result_fisico_prot_w		w_painel_sus_fpo.qt_result_fisico_prot%type;
vl_result_orca_prot_w		w_painel_sus_fpo.vl_result_orca_prot%type;
vl_saldo_fisico_w		w_painel_sus_fpo.vl_saldo_fisico%type;
vl_saldo_orcament_w		w_painel_sus_fpo.vl_saldo_orcament%type;
nr_seq_regra_fpo_w		sus_fpo_regra.nr_sequencia%type;
qt_fisico_w			sus_fpo_regra.qt_fisico%type;
vl_orcamento_w			sus_fpo_regra.vl_orcamento%type;
dt_competencia_w		sus_fpo_regra.dt_competencia%type;
qt_procedimento_w		procedimento_paciente.qt_procedimento%type;
vl_procedimento_w		procedimento_paciente.vl_procedimento%type;
cd_estabelecimento_w	        sus_fpo_regra.cd_estabelecimento%type;
cd_procedimento_w	        sus_fpo_regra.cd_procedimento%type;
ie_origem_proced_w	        sus_fpo_regra.ie_origem_proced%type;
nr_seq_grupo_w		        sus_fpo_regra.nr_seq_grupo%type;
nr_seq_subgrupo_w	        sus_fpo_regra.nr_seq_subgrupo%type;
nr_seq_forma_org_w	        sus_fpo_regra.nr_seq_forma_org%type;
ie_tipo_atendimento_w	        sus_fpo_regra.ie_tipo_atendimento%type;
ie_tipo_financiamento_w	        sus_fpo_regra.ie_tipo_financiamento%type;
ie_complexidade_w		sus_fpo_regra.ie_complexidade%type;
cd_cbo_w		        sus_fpo_regra.cd_cbo%type;
cd_convenio_sus_w	        parametro_faturamento.cd_convenio_sus%type;
qt_fisico_exec_w		sus_fpo_regra_externo.qt_fisico_exec%type;
vl_orcamento_exec_w	        sus_fpo_regra_externo.vl_orcamento_exec%type;
cd_carater_internacao_w	        sus_fpo_regra.cd_carater_internacao%type;
cd_procedencia_w	        sus_fpo_regra.cd_procedencia%type;
qt_regra_setor_w                bigint;
ie_soma_proc_w                  varchar(1);
qt_regra_desconsid_w            bigint;
qt_regra_proc_w                 bigint;
qt_regra_cbo_w                  bigint;
qt_sus_aih_unif_w               bigint;
					
C01 CURSOR FOR
	SELECT	nr_seq_estrutura_regra,
		nr_seq_forma_visual,
		nr_sequencia,
		qt_fisico,
		vl_orcamento,
		dt_competencia,
                cd_estabelecimento,
		cd_cbo,
		cd_procedimento,
		coalesce(ie_origem_proced,7) ie_origem_proced,
		ie_complexidade,
		ie_tipo_atendimento,
		ie_tipo_financiamento,
		nr_seq_forma_org,
		nr_seq_grupo,
		nr_seq_subgrupo,
		cd_carater_internacao,
		cd_procedencia
	from	sus_fpo_regra
	where	trunc(dt_competencia,'month') = trunc(dt_competencia_p,'month')	
	and	cd_estabelecimento = cd_estabelecimento_p;
        				
C02 CURSOR FOR
        SELECT	coalesce(a.qt_procedimento,0) qt_procedimento,
                coalesce(a.vl_procedimento,0) vl_procedimento,
                a.nr_sequencia,
                a.cd_setor_atendimento,
                a.cd_cbo,
                a.cd_procedimento,
                a.ie_origem_proced,
                d.nr_seq_forma_org,
                d.nr_seq_grupo,
                d.nr_seq_subgrupo,
                b.nr_interno_conta
        FROM sus_estrutura_procedimento_v d, atendimento_paciente c, procedimento_paciente a, conta_paciente b
LEFT OUTER JOIN sus_aih_unif e ON (b.nr_interno_conta = e.nr_interno_conta)
WHERE a.cd_procedimento		= coalesce(cd_procedimento_w,a.cd_procedimento) and a.ie_origem_proced		= coalesce(ie_origem_proced_w,a.ie_origem_proced) and coalesce(a.cd_cbo,'0') 		= coalesce(cd_cbo_w,coalesce(a.cd_cbo,'0')) and ((coalesce(cd_carater_internacao_w,'X') = 'X') or
                ((coalesce(cd_carater_internacao_w,'X') <> 'X')  and ((	SELECT	count(1)
                                                                                from	sus_aih_unif s
                                                                                where	s.nr_interno_conta 	= b.nr_interno_conta
                                                                                and	s.cd_carater_internacao	= cd_carater_internacao_w) > 0 )) or
                ((coalesce(cd_carater_internacao_w,'X') <> 'X') and (c.ie_carater_inter_sus = cd_carater_internacao_w))) and d.ie_complexidade		= coalesce(ie_complexidade_w,d.ie_complexidade) and ((coalesce(ie_tipo_atendimento_w,'X') = 'X') or (obter_se_contido(c.ie_tipo_atendimento,ie_tipo_atendimento_w) = 'S')) and ((coalesce(cd_procedencia_w,'X') = 'X') or (obter_se_contido(c.cd_procedencia, cd_procedencia_w) = 'S'))  and (e.ie_tipo_financiamento = coalesce(ie_tipo_financiamento_w,e.ie_tipo_financiamento) or (coalesce(e.ie_tipo_financiamento::text, '') = '' and d.ie_tipo_financiamento = coalesce(ie_tipo_financiamento_w,d.ie_tipo_financiamento))) and d.nr_seq_forma_org		= coalesce(nr_seq_forma_org_w,d.nr_seq_forma_org) and d.nr_seq_grupo			= coalesce(nr_seq_grupo_w,d.nr_seq_grupo) and d.nr_seq_subgrupo		= coalesce(nr_seq_subgrupo_w,d.nr_seq_subgrupo) and a.nr_interno_conta 		= b.nr_interno_conta and b.nr_atendimento 		= c.nr_atendimento and a.cd_procedimento		= d.cd_procedimento and coalesce(a.ie_origem_proced,7)	= d.ie_origem_proced and b.cd_estabelecimento	= coalesce(cd_estabelecimento_w,b.cd_estabelecimento) and trunc(a.dt_procedimento,'month') = trunc(dt_competencia_w,'month') and coalesce(a.cd_motivo_exc_conta::text, '') = '' and b.cd_convenio_parametro	= cd_convenio_sus_w LIMIT 1;

C03 CURSOR FOR               
        SELECT	coalesce(a.qt_procedimento,0) qt_procedimento,
                coalesce(a.vl_procedimento,0) vl_procedimento,
                a.nr_sequencia,
                a.cd_setor_atendimento,
                a.cd_cbo,
                a.cd_procedimento,
                a.ie_origem_proced,
                d.nr_seq_forma_org,
                d.nr_seq_grupo,
                d.nr_seq_subgrupo,
                b.nr_interno_conta
        FROM sus_estrutura_procedimento_v d, atendimento_paciente c, procedimento_paciente a, conta_paciente b
LEFT OUTER JOIN sus_aih_unif e ON (b.nr_interno_conta = e.nr_interno_conta)
WHERE a.cd_procedimento		= coalesce(cd_procedimento_w,a.cd_procedimento) and a.ie_origem_proced		= coalesce(ie_origem_proced_w,a.ie_origem_proced) and coalesce(a.cd_cbo,'0') 			= coalesce(cd_cbo_w,coalesce(a.cd_cbo,'0')) and ((coalesce(cd_carater_internacao_w,'X') = 'X') or
                ((coalesce(cd_carater_internacao_w,'X') <> 'X')  and ((	SELECT	count(1)
                                                                        from	sus_aih_unif s
                                                                        where	s.nr_interno_conta 	= b.nr_interno_conta
                                                                        and	s.cd_carater_internacao	= cd_carater_internacao_w  LIMIT 1) > 0)) or
                ((coalesce(cd_carater_internacao_w,'X') <> 'X') and (c.ie_carater_inter_sus = cd_carater_internacao_w))) and b.ie_status_acerto		= 2  and d.ie_complexidade		= coalesce(ie_complexidade_w,d.ie_complexidade) and ((coalesce(ie_tipo_atendimento_w,'X') = 'X') or (obter_se_contido(c.ie_tipo_atendimento,ie_tipo_atendimento_w) = 'S')) and ((coalesce(cd_procedencia_w,'X') = 'X') or (obter_se_contido(c.cd_procedencia, cd_procedencia_w) = 'S')) and (e.ie_tipo_financiamento = coalesce(ie_tipo_financiamento_w,e.ie_tipo_financiamento) or (coalesce(e.ie_tipo_financiamento::text, '') = '' and d.ie_tipo_financiamento = coalesce(ie_tipo_financiamento_w,d.ie_tipo_financiamento))) and d.nr_seq_forma_org		= coalesce(nr_seq_forma_org_w,d.nr_seq_forma_org) and d.nr_seq_grupo			= coalesce(nr_seq_grupo_w,d.nr_seq_grupo) and d.nr_seq_subgrupo		= coalesce(nr_seq_subgrupo_w,d.nr_seq_subgrupo) and (b.nr_seq_protocolo IS NOT NULL AND b.nr_seq_protocolo::text <> '') and coalesce(a.cd_motivo_exc_conta::text, '') = '' and a.nr_interno_conta 		= b.nr_interno_conta and b.nr_atendimento 		= c.nr_atendimento and a.cd_procedimento		= d.cd_procedimento and coalesce(a.ie_origem_proced,7)	= d.ie_origem_proced and b.cd_estabelecimento		= coalesce(cd_estabelecimento_w,b.cd_estabelecimento) and trunc(b.dt_mesano_referencia,'month') = trunc(dt_competencia_w,'month') and b.cd_convenio_parametro		= cd_convenio_sus_w;

BEGIN

CALL exec_sql_dinamico('Tasy','Truncate table w_painel_sus_fpo');

select	coalesce(max(cd_convenio_sus),0)
into STRICT	cd_convenio_sus_w
from	parametro_faturamento
where	cd_estabelecimento = cd_estabelecimento_p;
	
for C01_w in C01 loop
        begin
        nr_seq_estrut_regra_w		:= C01_w.nr_seq_estrutura_regra;
        nr_seq_forma_visual_w		:= C01_w.nr_seq_forma_visual;
        nr_seq_regra_fpo_w		:= C01_w.nr_sequencia;
        qt_fisico_w			:= coalesce(C01_w.qt_fisico,0);
        vl_orcamento_w			:= coalesce(C01_w.vl_orcamento,0);
        ds_estrutura_w			:= substr(coalesce(sus_obter_desc_estrutura(nr_seq_estrut_regra_w),''),1,255);
        ds_forma_visual_w		:= substr(coalesce(sus_obter_desc_forma_visual(nr_seq_forma_visual_w),''),1,255);
        cd_estabelecimento_w            := C01_w.cd_estabelecimento;
        dt_competencia_w                := C01_w.dt_competencia;
        cd_cbo_w                        := C01_w.cd_cbo;
        cd_procedimento_w               := C01_w.cd_procedimento;
        ie_origem_proced_w              := C01_w.ie_origem_proced;
        ie_complexidade_w               := C01_w.ie_complexidade;
        ie_tipo_atendimento_w           := C01_w.ie_tipo_atendimento;
        ie_tipo_financiamento_w         := C01_w.ie_tipo_financiamento;
        nr_seq_forma_org_w              := C01_w.nr_seq_forma_org;
        nr_seq_grupo_w                  := C01_w.nr_seq_grupo;
        nr_seq_subgrupo_w               := C01_w.nr_seq_subgrupo;
        cd_carater_internacao_w         := C01_w.cd_carater_internacao;
        cd_procedencia_w                := C01_w.cd_procedencia;
        qt_resultado_fisico_w           := 0;
        vl_result_orcamento_w           := 0;
        qt_result_fisico_prot_w         := 0;
        vl_result_orca_prot_w           := 0;
        qt_fisico_exec_w                := 0;
        vl_orcamento_exec_w             := 0;
        qt_regra_setor_w                := 0;
        qt_regra_desconsid_w            := 0;
        qt_regra_proc_w                 := 0;
        qt_regra_cbo_w                  := 0;
        qt_sus_aih_unif_w               := 0;
					

        begin
        select	sum(qt_fisico_exec),
                sum(vl_orcamento_exec)
        into STRICT	qt_fisico_exec_w,
                vl_orcamento_exec_w
        from	sus_fpo_regra_externo
        where 	nr_seq_fpo_regra = nr_seq_regra_fpo_w;
        exception
        when others then
                qt_fisico_exec_w        := 0;
                vl_orcamento_exec_w     := 0;
        end;

        begin
        select	1
        into STRICT    qt_regra_proc_w
        from 	sus_fpo_regra_proc w
        where	w.nr_seq_regra	= nr_seq_regra_fpo_w;
        exception
        when others then
                qt_regra_proc_w        := 0;
        end;

        begin
        select	1
        into STRICT    qt_regra_setor_w
        from    sus_fpo_regra_setor y
        where	y.nr_seq_regra	= nr_seq_regra_fpo_w
        and	y.ie_situacao 	= 'A';
        exception
        when others then
                qt_regra_setor_w        := 0;
        end;

        begin
        select	1
        into STRICT    qt_regra_cbo_w        
        from	sus_fpo_regra_cbo z
        where	z.nr_seq_fpo_regra	= nr_seq_regra_fpo_w;
        exception
        when others then
                qt_regra_cbo_w        := 0;
        end;

        begin
        select	1
        into STRICT    qt_regra_desconsid_w
        from	sus_fpo_regra_desconsid x
        where	x.nr_seq_fpo_regra	= nr_seq_regra_fpo_w;
        exception
        when others then
                qt_regra_desconsid_w        := 0;
        end;

        for C02_w in C02 loop
                begin

                ie_soma_proc_w := 'S';

                if (qt_regra_proc_w > 0) then
                
                        begin
                        select	1
                        into STRICT    qt_regra_proc_w
                        from 	sus_fpo_regra_proc w
                        where	w.nr_seq_regra	= nr_seq_regra_fpo_w
                        and	w.cd_procedimento	= C02_w.cd_procedimento
                        and	w.ie_origem_proced	= C02_w.ie_origem_proced
                        and	w.ie_situacao 	= 'A';
                        exception
                        when others then
                                qt_regra_proc_w        := 0;
                        end;

                        if (qt_regra_proc_w = 0) then
                                ie_soma_proc_w := 'N';
                        end if;
                end if;

                if (qt_regra_setor_w > 0) then
                
                        begin
                        select	1
                        into STRICT    qt_regra_setor_w
                        from	sus_fpo_regra_setor q
                        where	q.nr_seq_regra	= nr_seq_regra_fpo_w
                        and	q.ie_situacao	= 'A'
                        and	q.cd_setor_atendimento = C02_w.cd_setor_atendimento;
                        exception
                        when others then
                                qt_regra_setor_w        := 0;
                        end;

                        if (qt_regra_setor_w = 0) then
                                ie_soma_proc_w := 'N';
                        end if;
                end if;

                if (qt_regra_cbo_w > 0) then
                
                        begin
                        select	1
                        into STRICT    qt_regra_cbo_w
                        from	sus_fpo_regra_cbo z
                        where	z.cd_cbo		= coalesce(C02_w.cd_cbo,'0')
                        and	z.nr_seq_fpo_regra	= nr_seq_regra_fpo_w;
                        exception
                        when others then
                                qt_regra_cbo_w        := 0;
                        end;

                        if (qt_regra_cbo_w = 0) then
                                ie_soma_proc_w := 'N';
                        end if;
                end if;

                if (qt_regra_desconsid_w > 0) then
                
                        begin
                        select	1
                        into STRICT    qt_regra_desconsid_w
                        from	sus_fpo_regra_desconsid x
                        where	x.nr_seq_fpo_regra	= nr_seq_regra_fpo_w
                        and	coalesce(C02_w.cd_cbo,'0')	= coalesce(x.cd_cbo,coalesce(C02_w.cd_cbo,'0'))
                        and	C02_w.cd_procedimento	= coalesce(x.cd_procedimento,C02_w.cd_procedimento)
                        and	C02_w.ie_origem_proced	= coalesce(x.ie_origem_proced,C02_w.ie_origem_proced)
                        and	C02_w.nr_seq_forma_org	= coalesce(x.nr_seq_forma_org,C02_w.nr_seq_forma_org)
                        and	C02_w.nr_seq_grupo	= coalesce(x.nr_seq_grupo,C02_w.nr_seq_grupo)
                        and	C02_w.nr_seq_subgrupo	= coalesce(x.nr_seq_subgrupo,C02_w.nr_seq_subgrupo);
                        exception
                        when others then
                                qt_regra_desconsid_w        := 0;
                        end;

                        if (qt_regra_desconsid_w > 0) then
                                ie_soma_proc_w := 'N';
                        end if;
                end if;

                if (ie_soma_proc_w = 'S') then
                        begin
                                qt_resultado_fisico_w		:= (qt_resultado_fisico_w + (C02_w.qt_procedimento + coalesce(qt_fisico_exec_w,0)));
                                vl_result_orcamento_w		:= (vl_result_orcamento_w + (C02_w.vl_procedimento + coalesce(vl_orcamento_exec_w,0)));
                        end;
                end if;

                end;
        end loop;

          for C03_w in C03 loop
                begin
                
                ie_soma_proc_w := 'S';

                if (qt_regra_proc_w > 0) then
                
                        begin
                        select	1
                        into STRICT    qt_regra_proc_w
                        from 	sus_fpo_regra_proc w
                        where	w.nr_seq_regra	= nr_seq_regra_fpo_w
                        and	w.cd_procedimento	= C03_w.cd_procedimento
                        and	w.ie_origem_proced	= C03_w.ie_origem_proced
                        and	w.ie_situacao 	= 'A';
                        exception
                        when others then
                                qt_regra_proc_w        := 0;
                        end;

                        if (qt_regra_proc_w = 0) then
                                ie_soma_proc_w := 'N';
                        end if;
                end if;

                if (qt_regra_setor_w > 0) then
                
                        begin
                        select	1
                        into STRICT    qt_regra_setor_w
                        from	sus_fpo_regra_setor q
                        where	q.nr_seq_regra	= nr_seq_regra_fpo_w
                        and	q.ie_situacao	= 'A'
                        and	q.cd_setor_atendimento = C03_w.cd_setor_atendimento;
                        exception
                        when others then
                                qt_regra_setor_w        := 0;
                        end;

                        if (qt_regra_setor_w = 0) then
                                ie_soma_proc_w := 'N';
                        end if;
                end if;

                if (qt_regra_cbo_w > 0) then
                
                        begin
                        select	1
                        into STRICT    qt_regra_cbo_w
                        from	sus_fpo_regra_cbo z
                        where	z.cd_cbo		= coalesce(C03_w.cd_cbo,'0')
                        and	z.nr_seq_fpo_regra	= nr_seq_regra_fpo_w;
                        exception
                        when others then
                                qt_regra_cbo_w        := 0;
                        end;

                        if (qt_regra_cbo_w = 0) then
                                ie_soma_proc_w := 'N';
                        end if;
                end if;

                if (qt_regra_desconsid_w > 0) then
                
                        begin
                        select	1
                        into STRICT    qt_regra_desconsid_w
                        from	sus_fpo_regra_desconsid x
                        where	x.nr_seq_fpo_regra	= nr_seq_regra_fpo_w
                        and	coalesce(C03_w.cd_cbo,'0')	= coalesce(x.cd_cbo,coalesce(C03_w.cd_cbo,'0'))
                        and	C03_w.cd_procedimento	= coalesce(x.cd_procedimento,C03_w.cd_procedimento)
                        and	C03_w.ie_origem_proced	= coalesce(x.ie_origem_proced,C03_w.ie_origem_proced)
                        and	C03_w.nr_seq_forma_org	= coalesce(x.nr_seq_forma_org,C03_w.nr_seq_forma_org)
                        and	C03_w.nr_seq_grupo	= coalesce(x.nr_seq_grupo,C03_w.nr_seq_grupo)
                        and	C03_w.nr_seq_subgrupo	= coalesce(x.nr_seq_subgrupo,C03_w.nr_seq_subgrupo);
                        exception
                        when others then
                                qt_regra_desconsid_w        := 0;
                        end;

                        if (qt_regra_desconsid_w > 0) then
                                ie_soma_proc_w := 'N';
                        end if;
                end if;

                if (ie_soma_proc_w = 'S') then
                begin   
                        qt_result_fisico_prot_w		:= (qt_result_fisico_prot_w + (C03_w.qt_procedimento + coalesce(qt_fisico_exec_w,0)));
                        vl_result_orca_prot_w		:= (vl_result_orca_prot_w + (C03_w.vl_procedimento + coalesce(vl_orcamento_exec_w,0)));
                end;
                end if;
        end;
        end loop;

        vl_saldo_fisico_w		:= coalesce((qt_fisico_w - qt_resultado_fisico_w),0);
        vl_saldo_orcament_w		:= coalesce((vl_orcamento_w - vl_result_orcamento_w),0);		


        insert into w_painel_sus_fpo(	
                nr_sequencia,
                dt_atualizacao,
                nm_usuario,
                nr_seq_estrut_regra,
                nr_seq_forma_visual,
                ds_estrutura,
                ds_forma_visual,
                qt_resultado_fisico,
                vl_result_orcamento,
                qt_result_fisico_prot,
                vl_result_orca_prot,
                vl_saldo_fisico,
                vl_saldo_orcament,
                dt_competencia,
                cd_estabelecimento)
        values (	nextval('w_painel_sus_fpo_seq'),
                clock_timestamp(),
                nm_usuario_p,
                nr_seq_estrut_regra_w,
                nr_seq_forma_visual_w,
                ds_estrutura_w,
                ds_forma_visual_w,
                qt_resultado_fisico_w,
                vl_result_orcamento_w,
                qt_result_fisico_prot_w,
                vl_result_orca_prot_w,
                vl_saldo_fisico_w,
                vl_saldo_orcament_w,
                dt_competencia_w,
                cd_estabelecimento_p);
        end;
		
end loop;
commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE sus_gravar_w_painel_sus_fpo ( dt_competencia_p timestamp, cd_estabelecimento_p bigint, nm_usuario_p text) FROM PUBLIC;

