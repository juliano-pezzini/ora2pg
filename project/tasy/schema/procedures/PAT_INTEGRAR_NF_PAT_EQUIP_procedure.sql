-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pat_integrar_nf_pat_equip ( nr_sequencia_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text, nr_seq_tipo_p bigint, nr_seq_local_p bigint, cd_conta_contabil_p text, nr_seq_regra_conta_p bigint, dt_inicio_uso_p timestamp, nr_lote_p pat_bem.nr_lote%type) AS $body$
DECLARE


nr_seq_equipamento_w		bigint;
ds_equipamento_w		varchar(100);
dt_aquisicao_w			timestamp;
vl_aquisicao_w			double precision;
cd_moeda_w			bigint;
nr_sequencia_w			bigint;
pr_depreciacao_w		double precision;
cd_centro_custo_w		integer;
nr_seq_nota_w			bigint;
nr_seq_item_w			integer;
cd_imobilizado_w		varchar(20);
cd_serie_w			varchar(20);
nr_nota_fiscal_w		varchar(25);
qt_item_nf_w			double precision;
cd_cgc_emitente_w		varchar(14);
qt_item_w			bigint;
pr_deprec_fiscal_w		double precision;
ie_imobilizado_w		varchar(1);
qt_dia_inicio_uso_w		bigint;
qt_registro_w			bigint;
ie_deprec_tipo_bem_w		varchar(1);
qt_tempo_vida_util_w		bigint;
ie_situacao_nf_w		varchar(1);
cd_bem_externo_w		varchar(20);
nr_seq_proj_rec_w       pat_bem.nr_seq_proj_rec%type;
dt_aquisicao_aux_w		timestamp;
cd_bem_w			pat_bem.cd_bem%type;
ie_consiste_cd_bem_w		varchar(1);
cd_empresa_w			empresa.cd_empresa%type;
ie_desdobrar_itens_w		varchar(1);
dt_fim_garantia_w		pat_bem.dt_garantia%type;
ie_consiste_ultimo_codigo_w	varchar(1);
ie_consiste_cod_emp_w		varchar(1);
cd_conta_contabil_w		pat_conta_contabil.cd_conta_contabil%type;
pat_bem_w			pat_bem%rowtype;
qt_item_d_w			bigint;

BEGIN

cd_empresa_w := obter_empresa_estab(cd_estabelecimento_p);

select	cd_moeda_padrao
into STRICT	cd_moeda_w
from	parametro_compras
where	cd_estabelecimento = cd_estabelecimento_p;

select	obter_dados_nota_fiscal(nr_seq_nota,13),
	obter_dados_nf_item(nr_seq_nota,nr_seq_item,2),
	obter_dados_nf_item(nr_seq_nota,nr_seq_item,4),
	obter_dados_nf_item(nr_seq_nota,nr_seq_item,0) qt_item_nf,
	substr(obter_desc_material(obter_dados_nf_item(nr_seq_nota,nr_seq_item,1)),1,100),
	nr_seq_nota,
	nr_seq_item,
	obter_dados_nota_fiscal(nr_seq_nota,0),
	substr(obter_dados_nota_fiscal(nr_seq_nota,2),1,14) cd_cgc_emitente,
	coalesce(ie_desdobrar_itens,'N')
into STRICT	dt_aquisicao_w,
	vl_aquisicao_w,
	cd_serie_w,
	qt_item_nf_w,
	ds_equipamento_w,
	nr_seq_nota_w,
	nr_seq_item_w,
	nr_nota_fiscal_w,
	cd_cgc_emitente_w,
	ie_desdobrar_itens_w
from	nf_integracao_pat_equip
where	nr_sequencia = nr_sequencia_p;

select	ie_situacao
into STRICT	ie_situacao_nf_w
from	nota_fiscal
where	nr_sequencia = nr_seq_nota_w;

select 	coalesce(sum(y.qt_item_nf), 0)
into STRICT	qt_item_d_w
from	nota_fiscal_item y
where 	y.nr_seq_nf_orig 	= nr_seq_nota_w
and	y.nr_seq_item_nf_orig 	= nr_seq_item_w;

select	max(nr_seq_proj_rec),
	max(a.dt_fim_garantia)
into STRICT	nr_seq_proj_rec_w,
	dt_fim_garantia_w
from	nota_fiscal_item a
where	a.nr_item_nf	= nr_seq_item_w
and	a.nr_sequencia	= nr_seq_nota_w;

if (ie_situacao_nf_w in ('2','3','9')) then
	/*586027 - Nao permitido realizar a integracao com notas fiscais estornadas ou canceladas!*/

	CALL wheb_mensagem_pck.exibir_mensagem_abort(240643);
end if;

select	coalesce(max(b.pr_depreciacao),0),
	coalesce(max(b.pr_deprec_fiscal),0),
	max(cd_conta_contabil)
into STRICT	pr_depreciacao_w,
	pr_deprec_fiscal_w,
	cd_conta_contabil_w
from	pat_conta_contabil b
where	b.nr_sequencia	= nr_seq_regra_conta_p;

ie_imobilizado_w		:= substr(coalesce(Obter_Valor_Param_Usuario(937, 70, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p),'N'),1,1);
ie_deprec_tipo_bem_w		:= substr(coalesce(Obter_Valor_Param_Usuario(937, 66, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p),'N'),1,1);
ie_consiste_ultimo_codigo_w 	:= substr(coalesce(Obter_Valor_Param_Usuario(937, 91, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p),'N'),1,1);
ie_consiste_cod_emp_w 		:= substr(coalesce(Obter_Valor_Param_Usuario(937, 33, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p),'N'),1,1);

if (ie_deprec_tipo_bem_w = 'S') then
	begin
	select	coalesce(max(tx_deprec), pr_depreciacao_w)
	into STRICT	pr_depreciacao_w
	from	pat_tipo_bem
	where	nr_sequencia	= nr_seq_tipo_p;
	end;
end if;

select	coalesce(max(cd_centro_custo),0)
into STRICT	cd_centro_custo_w
from	pat_local
where	nr_sequencia = nr_seq_local_p;

if (cd_centro_custo_w = 0) then
	/*A localizacao informada nao possui centro de custo cadastrado.*/

	CALL wheb_mensagem_pck.exibir_mensagem_abort(455991);
end if;

select	count(*)
into STRICT	qt_item_w
from	nf_integracao_pat_equip
where	nr_seq_item	= nr_seq_item_w
and	nr_seq_nota	= nr_seq_nota_w
and	ie_patrimonio	= 'S'
and	ie_desdobrar_itens = 'S';

qt_item_nf_w := qt_item_nf_w - qt_item_d_w;

if (qt_item_w > 1) or (ie_desdobrar_itens_w = 'U') then
	qt_item_nf_w	:= 1;
end if;

vl_aquisicao_w := pat_obter_valor_integr_nf(nr_sequencia_p, cd_estabelecimento_p);

for i in 1..qt_item_nf_w loop
	begin

	begin
	select	coalesce(qt_dia_inicio_uso,0),
		qt_tempo_vida_util
	into STRICT	qt_dia_inicio_uso_w,
		qt_tempo_vida_util_w
	from	pat_tipo_bem
	where	nr_sequencia = nr_seq_tipo_p;
	exception when others then
		qt_dia_inicio_uso_w	:= 0;
		qt_tempo_vida_util_w	:= null;
	end;

	if (coalesce(dt_inicio_uso_p::text, '') = '') then
		dt_aquisicao_aux_w 	:= coalesce(dt_aquisicao_w, clock_timestamp())+ qt_dia_inicio_uso_w;
	else
		dt_aquisicao_aux_w	:= dt_inicio_uso_p;
	end if;

	select	count(*)
	into STRICT	qt_registro_w
	from	pat_mes_ref b
	where	b.cd_estabelecimento		= cd_estabelecimento_p
	and	trunc(b.dt_mes_ref,'month')	= trunc(dt_aquisicao_aux_w,'month')
	and	(b.dt_calculo IS NOT NULL AND b.dt_calculo::text <> '')
	and	b.ie_situacao			= '1';

	if (trunc(dt_aquisicao_aux_w) < trunc(coalesce(dt_aquisicao_w, clock_timestamp()))) then
		CALL wheb_mensagem_pck.exibir_mensagem_abort(44308);
	end if;

	if (qt_registro_w > 0) then
		CALL wheb_mensagem_pck.exibir_mensagem_abort(269472);
	end if;

	select	nextval('pat_bem_seq')
	into STRICT	pat_bem_w.nr_sequencia
	;

	if (ie_consiste_ultimo_codigo_w = 'S') then
		begin
		if (ie_consiste_cod_emp_w in ('S','O')) then
			begin
			select	substr(obter_ultimo_cd_bem(cd_empresa_w,'E'),1,20) cd_bem
			into STRICT	cd_bem_w
			;
			end;
		else
			begin
			select	substr(obter_ultimo_cd_bem(cd_empresa_w,'G'),1,20) cd_bem
			into STRICT	cd_bem_w
			;
			end;
		end if;
		end;
	else
		begin

		cd_bem_w := pat_bem_w.nr_sequencia;

		select	count(*)
		into STRICT	qt_registro_w
		from	pat_bem a
		where	cd_bem = cd_bem_w;

		if (qt_registro_w <> 0) then
			begin
			select	substr(obter_ultimo_cd_bem(cd_empresa_w,'E'),1,20) cd_bem
			into STRICT	cd_bem_w
			;
			end;
		end if;
		end;
	end if;
		
	pat_bem_w.cd_estabelecimento		:= cd_estabelecimento_p;
	pat_bem_w.cd_bem			:= cd_bem_w;
	pat_bem_w.ds_bem			:= ds_equipamento_w;
	pat_bem_w.dt_aquisicao			:= coalesce(dt_aquisicao_w, clock_timestamp());
	pat_bem_w.nr_seq_tipo			:= nr_seq_tipo_p;
	pat_bem_w.nr_seq_local			:= nr_seq_local_p;
	pat_bem_w.ie_imobilizado		:= ie_imobilizado_w;
	pat_bem_w.ie_situacao			:= 'A';
	pat_bem_w.cd_conta_contabil		:= coalesce(cd_conta_contabil_p,cd_conta_contabil_w);
	pat_bem_w.cd_centro_custo		:= cd_centro_custo_w;
	pat_bem_w.ie_tipo_valor			:= 'O';
	pat_bem_w.tx_deprec			:= pr_depreciacao_w;
	pat_bem_w.vl_original			:= coalesce(vl_aquisicao_w,0);
	pat_bem_w.dt_inicio_uso			:= dt_aquisicao_aux_w;
	pat_bem_w.cd_moeda			:= cd_moeda_w;
	pat_bem_w.nr_seq_nota_fiscal		:= nr_seq_nota_w;
	pat_bem_w.nr_nota_fiscal		:= nr_nota_fiscal_w;
	pat_bem_w.ds_serie			:= cd_serie_w;
	pat_bem_w.cd_cgc			:= cd_cgc_emitente_w;
	pat_bem_w.tx_fiscal			:= pr_deprec_fiscal_w;
	pat_bem_w.ie_propriedade		:= 'P';
	pat_bem_w.nr_seq_regra_conta		:= nr_seq_regra_conta_p;
	pat_bem_w.qt_tempo_vida_util		:= qt_tempo_vida_util_w;
	pat_bem_w.cd_bem_externo		:= to_char(nr_seq_proj_rec_w);
    pat_bem_w.nr_seq_proj_rec		:= nr_seq_proj_rec_w;
	pat_bem_w.dt_garantia			:= dt_fim_garantia_w;
	pat_bem_w.nr_lote			:= nr_lote_p;

	pat_bem_w := philips_patrimonio_pck.gerar_pat_bem('N', nm_usuario_p, pat_bem_w);

	CALL pat_gerar_ficha_aceite(	cd_estabelecimento_p, pat_bem_w.nr_sequencia, 'I', 'N', nm_usuario_p);

	end;
end loop;

update	nf_integracao_pat_equip
set	nr_seq_bem	= pat_bem_w.nr_sequencia
where	nr_sequencia	= nr_sequencia_p;

select	coalesce(max(nr_seq_equipamento),0)
into STRICT	nr_seq_equipamento_w
from	nf_integracao_pat_equip
where	nr_sequencia	= nr_sequencia_p;

if (nr_seq_equipamento_w > 0) then
	select	cd_imobilizado
	into STRICT	cd_imobilizado_w
	from	man_equipamento
	where	nr_sequencia = nr_seq_equipamento_w;

	update	pat_bem
	set	cd_bem		= cd_imobilizado_w
	where	nr_sequencia	= pat_bem_w.nr_sequencia;

elsif (nr_seq_equipamento_w = 0) then

	select	coalesce(max(cd_imobilizado), 'X')
	into STRICT	cd_imobilizado_w
	from	nota_fiscal_item
	where	nr_sequencia	= nr_seq_nota_w
	and	nr_item_nf	= nr_seq_item_w;

	if (cd_imobilizado_w <> 'X') then
		update	pat_bem
		set	cd_bem		= cd_imobilizado_w
		where	nr_sequencia	= pat_bem_w.nr_sequencia;
	elsif (coalesce(cd_bem_w,'X') <> 'X') then
		update	pat_bem
		set	cd_bem		= cd_bem_w
		where	nr_sequencia	= pat_bem_w.nr_sequencia;
	end if;
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pat_integrar_nf_pat_equip ( nr_sequencia_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text, nr_seq_tipo_p bigint, nr_seq_local_p bigint, cd_conta_contabil_p text, nr_seq_regra_conta_p bigint, dt_inicio_uso_p timestamp, nr_lote_p pat_bem.nr_lote%type) FROM PUBLIC;

