-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_tit_rec_liq_cc_convret (nr_titulo_p bigint, nr_seq_liq_p bigint, nm_usuario_p text) AS $body$
DECLARE

 
nr_interno_conta_w			bigint;
cd_centro_custo_w			bigint;
cd_convenio_w			bigint;
cd_centro_custo_receita_w		bigint;
cd_estabelecimento_w		bigint;
nr_seq_tit_rec_liq_cc_w		bigint;
nr_seq_produto_w			bigint;
nr_seq_grupo_w				bigint;
ie_tipo_convenio_w			bigint;

vl_amaior_liq_cc_w			double precision;
vl_amaior_total_w			double precision;
vl_glosa_liq_cc_w			double precision;
vl_glosa_w			double precision;
vl_rec_maior_w			double precision;
vl_conta_w			double precision;
vl_glosa_total_w			double precision;
vl_item_w				double precision;
vl_titulo_w			double precision;

ie_tipo_atendimento_w		varchar(255);
ie_tipo_protocolo_w			varchar(255);
cd_conta_contabil_w		varchar(255);
ie_cc_receita_glosa_w		varchar(255);
cd_cgc_w			varchar(255);

dt_recebimento_w			timestamp;

c01 CURSOR FOR 
SELECT	a.nr_interno_conta 
from	titulo_receber a 
where	a.nr_titulo		= nr_titulo_p 
and	(a.nr_interno_conta IS NOT NULL AND a.nr_interno_conta::text <> '') 

union
 
SELECT	b.nr_interno_conta 
from	conta_paciente b, 
	titulo_receber a 
where	a.nr_titulo		= nr_titulo_p 
and	coalesce(a.nr_interno_conta::text, '') = '' 
and	a.nr_seq_protocolo	= b.nr_seq_protocolo;

c02 CURSOR FOR 
SELECT	cd_centro_custo, 
	sum(vl_item), 
	ie_tipo_atendimento, 
	cd_centro_custo_receita, 
	ie_tipo_protocolo 
from ( 
	SELECT	coalesce(c.cd_centro_custo, cd_centro_custo_w) cd_centro_custo, 
		sum(b.vl_procedimento) vl_item, 
		d.ie_tipo_atendimento, 
		c.cd_centro_custo_receita, 
		obter_tipo_protocolo(obter_protocolo_conpaci(b.nr_interno_conta)) ie_tipo_protocolo 
	from	atendimento_paciente d, 
		setor_atendimento c, 
		procedimento_paciente b 
	where	b.cd_setor_atendimento	= c.cd_setor_atendimento 
	and	b.nr_interno_conta	= nr_interno_conta_w 
	and	coalesce(b.nr_seq_proc_pacote, b.nr_sequencia) = b.nr_sequencia 
	and	b.nr_atendimento	= d.nr_atendimento 
	and	coalesce(b.cd_motivo_exc_conta::text, '') = '' 
	group	by coalesce(c.cd_centro_custo, cd_centro_custo_w), 
		d.ie_tipo_atendimento, 
		c.cd_centro_custo_receita, 
		obter_tipo_protocolo(obter_protocolo_conpaci(b.nr_interno_conta)) 
	
union 	all
 
	select	coalesce(c.cd_centro_custo, cd_centro_custo_w), 
		sum(b.vl_material) vl_item, 
		d.ie_tipo_atendimento, 
		c.cd_centro_custo_receita, 
		obter_tipo_protocolo(obter_protocolo_conpaci(b.nr_interno_conta)) ie_tipo_protocolo 
	from	atendimento_paciente d, 
		setor_atendimento c, 
		material_atend_paciente b 
	where	b.cd_setor_atendimento	= c.cd_setor_atendimento 
	and	b.nr_interno_conta	= nr_interno_conta_w 
	and	b.nr_atendimento	= d.nr_atendimento 
	and	coalesce(b.nr_seq_proc_pacote::text, '') = '' 
	and	coalesce(b.cd_motivo_exc_conta::text, '') = '' 
	group	by coalesce(c.cd_centro_custo, cd_centro_custo_w), 
		d.ie_tipo_atendimento, 
		c.cd_centro_custo_receita, 
		obter_tipo_protocolo(obter_protocolo_conpaci(b.nr_interno_conta))	 
	) alias19 
group	by cd_centro_custo, 
	ie_tipo_atendimento, 
	cd_centro_custo_receita, 
	ie_tipo_protocolo;


BEGIN 
 
delete	from titulo_rec_liq_cc 
where	nr_titulo	= nr_titulo_p 
and	nr_seq_baixa	= nr_seq_liq_p;
 
select	vl_glosa, 
	vl_rec_maior, 
	dt_recebimento 
into STRICT	vl_glosa_w, 
	vl_rec_maior_w, 
	dt_recebimento_w 
from	titulo_receber_liq 
where	nr_titulo		= nr_titulo_p 
and	nr_sequencia		= nr_seq_liq_p;
 
if (vl_glosa_w <> 0) or (vl_rec_maior_w <> 0) then 
 
	select	cd_estabelecimento, 
		vl_titulo, 
		cd_convenio_conta, 
		cd_cgc 
	into STRICT	cd_estabelecimento_w, 
		vl_titulo_w, 
		cd_convenio_w, 
		cd_cgc_w 
	from	titulo_receber 
	where	nr_titulo		= nr_titulo_p;
 
	select	cd_centro_custo_glosa, 
		ie_cc_receita_glosa 
	into STRICT	cd_centro_custo_w, 
		ie_cc_receita_glosa_w 
	from	parametro_contas_receber 
	where	cd_estabelecimento	= cd_estabelecimento_w;
 
	select	ie_tipo_convenio 
	into STRICT	ie_tipo_convenio_w 
	from	convenio 
	where	cd_convenio		= cd_convenio_w;
 
	SELECT * FROM obter_produto_financeiro(cd_estabelecimento_w, cd_convenio_w, cd_cgc_w, nr_seq_produto_w, ie_tipo_convenio_w, null, nr_seq_grupo_w) INTO STRICT nr_seq_produto_w, nr_seq_grupo_w;
	open c01;
	loop 
	fetch c01 into 
		nr_interno_conta_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
 
		select	vl_conta, 
			cd_convenio_parametro 
		into STRICT	vl_conta_w, 
			cd_convenio_w 
		from	conta_paciente 
		where	nr_interno_conta	= nr_interno_conta_w;
 
		open c02;
		loop 
		fetch c02 into 
			cd_centro_custo_w, 
			vl_item_w, 
			ie_tipo_atendimento_w, 
			cd_centro_custo_receita_w, 
			ie_tipo_protocolo_w;
		EXIT WHEN NOT FOUND; /* apply on c02 */
 
			cd_conta_contabil_w	:= OBTER_CONTA_CONVENIO(cd_estabelecimento_w, 
									cd_convenio_w, 
									ie_tipo_atendimento_w, 
									'G', 
									dt_recebimento_w, 
									ie_tipo_protocolo_w, 
									null, 
									null, 
									null,null,null);
			if (ie_cc_receita_glosa_w = 'S') and (vl_glosa_liq_cc_w <> 0) then 
				cd_centro_custo_w		:= coalesce(cd_centro_custo_receita_w, cd_centro_custo_w);
			end if;
 
			select	nextval('titulo_rec_liq_cc_seq') 
			into STRICT	nr_seq_tit_rec_liq_cc_w 
			;
 
			insert	into	titulo_rec_liq_cc(nr_sequencia, 
					nr_titulo, 
					nr_seq_baixa, 
					dt_atualizacao, 
					nm_usuario, 
					cd_centro_custo, 
					vl_baixa, 
					vl_amaior, 
					dt_atualizacao_nrec, 
					nm_usuario_nrec, 
					cd_conta_contabil, 
					nr_seq_produto, 
					ie_origem_classif) 
			values		(nr_seq_tit_rec_liq_cc_w, 
					nr_titulo_p, 
					nr_seq_liq_p, 
					clock_timestamp(), 
					nm_usuario_p, 
					cd_centro_custo_w, 
					(vl_item_w * dividir_sem_round(vl_titulo_w, vl_conta_w)) * (dividir_sem_round(vl_glosa_w, vl_titulo_w)), 
					(vl_item_w * dividir_sem_round(vl_titulo_w, vl_conta_w)) * (dividir_sem_round(vl_rec_maior_w, vl_titulo_w)), 
					clock_timestamp(), 
					nm_usuario_p, 
					cd_conta_contabil_w, 
					nr_seq_produto_w, 
					'FP');
		end loop;
		close c02;
 
		select	sum(vl_baixa) 
		into STRICT	vl_glosa_total_w 
		from	titulo_rec_liq_cc 
		where	nr_titulo	= nr_titulo_p 
		and	nr_seq_baixa	= nr_seq_liq_p;
 
		if (vl_glosa_total_w <> vl_glosa_w) then 
			update	titulo_rec_liq_cc 
			set	vl_baixa	= vl_baixa + (vl_glosa_w - vl_glosa_total_w) 
			where	nr_sequencia	= nr_seq_tit_rec_liq_cc_w;
		end if;
 
		select	sum(vl_amaior) 
		into STRICT	vl_amaior_total_w 
		from	titulo_rec_liq_cc 
		where	nr_titulo	= nr_titulo_p 
		and	nr_seq_baixa	= nr_seq_liq_p;
 
		if (vl_amaior_total_w <> vl_rec_maior_w) then 
			update	titulo_rec_liq_cc 
			set	vl_amaior	= vl_amaior + (vl_rec_maior_w - vl_amaior_total_w) 
			where	nr_sequencia	= nr_seq_tit_rec_liq_cc_w;
		end if;
 
	end loop;
	close c01;
 
end if;
 
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_tit_rec_liq_cc_convret (nr_titulo_p bigint, nr_seq_liq_p bigint, nm_usuario_p text) FROM PUBLIC;

