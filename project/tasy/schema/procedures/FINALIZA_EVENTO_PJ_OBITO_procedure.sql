-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE finaliza_evento_pj_obito (cd_pessoa_fisica_p text, dt_obito_p timestamp, nm_usuario_p text, ie_commit_p text DEFAULT 'S') AS $body$
DECLARE


    nr_seq_evento_w protocolo_int_pac_evento.nr_sequencia%TYPE;
    ds_motivo_atraso_w protocolo_int_pac_evento.ds_motivo_atraso%TYPE;
    ds_expressao_obito_w dic_expressao.ds_expressao_br%TYPE;
    ds_data_obito_w varchar(100);

    c01 CURSOR FOR
        SELECT evento.nr_sequencia, evento.ds_motivo_atraso
          FROM protocolo_int_pac_evento evento
         INNER JOIN protocolo_int_paciente protocolo
            ON protocolo.cd_pessoa_fisica = cd_pessoa_fisica_p
         INNER JOIN protocolo_int_pac_etapa etapa
            ON etapa.nr_seq_protocolo_int_pac = protocolo.nr_sequencia
         WHERE evento.nr_seq_prt_int_pac_etapa = etapa.nr_sequencia
           AND evento.dt_prevista >= dt_obito_p;


BEGIN

    OPEN c01;
    LOOP
        FETCH c01
            INTO nr_seq_evento_w,
            ds_motivo_atraso_w;
        EXIT WHEN NOT FOUND; /* apply on c01 */

        ds_expressao_obito_w := obter_desc_expressao(286749);
        ds_data_obito_w := substr(PKG_DATE_FORMATERS.to_varchar(dt_obito_p, 'short', wheb_usuario_pck.get_cd_estabelecimento, nm_usuario_p), 1, 100);

        UPDATE protocolo_int_pac_evento ev
           SET ev.ie_desconsiderar_atraso = 'S',
               ev.nm_usuario              = nm_usuario_p,
               ev.ds_motivo_atraso = substr(ds_motivo_atraso_w || chr(13) || chr(10) ||
                  ds_expressao_obito_w || ': ' || ds_data_obito_w, 1, 255),
               dt_atualizacao             = clock_timestamp()
         WHERE ev.nr_sequencia = nr_seq_evento_w;
        IF (ie_commit_p = 'S') THEN
            COMMIT;
        END IF;
    END LOOP;
    CLOSE c01;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE finaliza_evento_pj_obito (cd_pessoa_fisica_p text, dt_obito_p timestamp, nm_usuario_p text, ie_commit_p text DEFAULT 'S') FROM PUBLIC;

