-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_atualizar_compl_pf ( cd_pessoa_fisica_p text, nr_seq_compl_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text, ie_lancar_mensagem_p out text, ie_tipo_chamada_p text default null) is cd_pessoa_fisica_w varchar(10) AS $body$
DECLARE


qt_regra_tributo_w	bigint;

BEGIN

select	count(1)
into STRICT	qt_regra_tributo_w
from	pls_regra_alt_pf_ref_atrib
where	nr_seq_regra = nr_seq_regra_alt_pf_ref_w
and	nm_atributo = nm_atributo_p;

if (qt_regra_tributo_w > 0) then
	return;
else
	return;
end if;

end;

procedure verificar_regra_alteracao_camp is

begin

if (verifica_se_att_campo('CD_MUNICIPIO_IBGE') = 'N') then
	ie_att_cd_municipio_ibge_w	:= 'N';
end if;

if (verifica_se_att_campo('CD_CEP') = 'N') then
	ie_att_cd_cep_w			:= 'N';
end if;

if (verifica_se_att_campo('DS_COMPLEMENTO') = 'N') then
	ie_att_ds_complemento_w		:= 'N';
end if;

if (verifica_se_att_campo('DS_BAIRRO') = 'N') then
	ie_att_ds_bairro_w		:= 'N';
end if;

if (verifica_se_att_campo('SG_ESTADO') = 'N') then
	ie_att_sg_estado_w		:= 'N';
end if;
if (verifica_se_att_campo('NR_RAMAL') = 'N') then
	ie_att_nr_ramal_w		:= 'N';
end if;

if (verifica_se_att_campo('CD_EMPRESA_REFER') = 'N') then
	ie_att_cd_empresa_refer_w	:= 'N';
end if;

if (verifica_se_att_campo('CD_PROFISSAO') = 'N') then
	ie_att_cd_profissao_w		:= 'N';
end if;

if (verifica_se_att_campo('DS_ENDERECO') = 'N') then
	ie_att_ds_endereco_w		:= 'N';
end if;

if (verifica_se_att_campo('NR_TELEFONE') = 'N') then
	ie_att_nr_telefone_w		:= 'N';
end if;

if (verifica_se_att_campo('DS_EMAIL') = 'N') then
	ie_att_ds_email_w		:= 'N';
end if;

if (verifica_se_att_campo('NM_CONTATO') = 'N') then
	ie_att_nm_contato_w		:= 'N';
end if;

if (verifica_se_att_campo('NR_ENDERECO') = 'N') then
	ie_att_nr_endereco_w		:= 'N';
end if;

if (verifica_se_att_campo('DS_OBSERVACAO') = 'N') then
	ie_att_ds_observacao_w		:= 'N';
end if;

if (verifica_se_att_campo('NR_SEQ_PARENTESCO') = 'N') then
	ie_att_nr_seq_parentesco_w	:= 'N';
end if;

if (verifica_se_att_campo('DS_FONE_ADIC') = 'N') then
	ie_att_ds_fone_adic_w		:= 'N';
end if;

if (verifica_se_att_campo('DS_FAX') = 'N') then
	ie_att_ds_fax_w			:= 'N';
end if;

if (verifica_se_att_campo('NR_SEQ_PAIS') = 'N') then
	ie_att_nr_seq_pais_w		:= 'N';
end if;

if (verifica_se_att_campo('DS_FONETICA') = 'N') then
	ie_att_ds_fonetica_w		:= 'N';
end if;

if (verifica_se_att_campo('NR_DDD_TELEFONE') = 'N') then
	ie_att_nr_ddd_telefone_w	:= 'N';
end if;

if (verifica_se_att_campo('NR_DDI_TELEFONE') = 'N') then
	ie_att_nr_ddi_telefone_w	:= 'N';
end if;

if (verifica_se_att_campo('NR_DDI_FAX') = 'N') then
	ie_att_nr_ddi_fax_w		:= 'N';
end if;

if (verifica_se_att_campo('NR_DDD_FAX') = 'N') then
	ie_att_nr_ddd_fax_w		:= 'N';
end if;

if (verifica_se_att_campo('CD_TIPO_LOGRADOURO') = 'N') then
	ie_att_cd_tipo_logradouro_w	:= 'N';
end if;

if (verifica_se_att_campo('DS_WEBSITE') = 'N') then
	ie_att_ds_website_w		:= 'N';
end if;

if (verifica_se_att_campo('NM_CONTATO_PESQUISA') = 'N') then
	ie_att_nm_contato_pesquisa_w	:= 'N';
end if;

if (verifica_se_att_campo('IE_NF_CORREIO') = 'N') then
	ie_att_ie_nf_correio_w		:= 'N';
end if;

if (verifica_se_att_campo('CD_ZONA_PROCEDENCIA') = 'N') then
	ie_att_cd_zona_procedencia_w	:= 'N';
end if;

if (verifica_se_att_campo('IE_MALA_DIRETA') = 'N') then
	ie_att_ie_mala_direta_w		:= 'N';
end if;
	
if (verifica_se_att_campo('IE_FATOR_RH') = 'N') then
	ie_att_ie_fator_rh_w		:= 'N';
end if;

if (verifica_se_att_campo('IE_TIPO_SANGUE') = 'N') then
	ie_att_ie_tipo_sangue_w		:= 'N';
end if;

if (verifica_se_att_campo('NR_SEQ_LOCAL_ATEND_MED') = 'N') then
	ie_att_nr_seq_local_atend_me_w	:= 'N';
end if;

if (verifica_se_att_campo('IE_OBRIGA_EMAIL') = 'N') then
	ie_att_ie_obriga_email_w	:= 'N';
end if;

if (verifica_se_att_campo('NR_SEQ_IDENT_CNES') = 'N') then
	ie_att_nr_seq_ident_cnes_w	:= 'N';
end if;

if (verifica_se_att_campo('DS_MUNICIPIO') = 'N') then
	ie_att_ds_municipio_w		:= 'N';
end if;

if (verifica_se_att_campo('NR_DDD_FONE_ADIC') = 'N') then
	ie_att_nr_ddd_fone_adic_w	:= 'N';
end if;

if (verifica_se_att_campo('NR_DDI_FONE_ADIC') = 'N') then
	ie_att_nr_ddi_fone_adic_w	:= 'N';
end if;

if (verifica_se_att_campo('DS_COMPL_END') = 'N') then
	ie_att_ds_compl_end_w		:= 'N';
end if;

end;

procedure atualizar_dados_pessoa(	cd_pessoa_fisica_ref_p		pessoa_fisica.cd_pessoa_fisica%type,
					cd_pessoa_fisica_att_p		pessoa_fisica.cd_pessoa_fisica%type,
					nr_seq_compl_pessoa_fisica_p	compl_pessoa_fisica.nr_sequencia%type,
					nr_seq_compl_p			compl_pessoa_fisica.nr_sequencia%type,
					ie_tipo_pessoa_p		varchar2) is

begin

select	max(cd_municipio_ibge),
	max(cd_cep),
	max(ds_complemento),
	max(ds_bairro),
	max(ds_municipio),
	max(sg_estado),
	max(nr_ramal),
	max(cd_empresa_refer),
	max(cd_profissao),
	max(ds_endereco),
	max(nr_telefone),
	max(ds_email),
	max(nm_contato),
	max(nr_endereco),
	max(ds_observacao),
	max(nr_seq_parentesco),
	max(ds_fone_adic),
	max(ds_fax),
	max(nr_seq_pais),
	max(ds_fonetica),
	max(nr_ddd_telefone),
	max(nr_ddi_telefone),
	max(nr_ddi_fax),
	max(nr_ddd_fax),
	max(cd_tipo_logradouro),
	max(ds_website),
	max(nm_contato_pesquisa),
	max(ie_nf_correio),
	max(cd_zona_procedencia),
	max(ie_mala_direta),
	max(ie_fator_rh),
	max(ie_tipo_sangue),
	max(nr_seq_local_atend_med),
	max(ie_obriga_email),
	max(nr_seq_ident_cnes),
	max(nr_ddd_fone_adic),
	max(nr_ddi_fone_adic),
	max(ds_compl_end)
into STRICT	cd_municipio_ibge_w,
	cd_cep_w,
	ds_complemento_w,
	ds_bairro_w,
	ds_municipio_w,
	sg_estado_w,
	nr_ramal_w,
	cd_empresa_refer_w,
	cd_profissao_w,
	ds_endereco_w,
	nr_telefone_w,
	ds_email_w,
	nm_contato_w,
	nr_endereco_w,
	ds_observacao_w,
	nr_seq_parentesco_w,
	ds_fone_adic_w,
	ds_fax_w,
	nr_seq_pais_w,
	ds_fonetica_w,
	nr_ddd_telefone_w,
	nr_ddi_telefone_w,
	nr_ddi_fax_w,
	nr_ddd_fax_w,
	cd_tipo_logradouro_w,
	ds_website_w,
	nm_contato_pesquisa_w,
	ie_nf_correio_w,
	cd_zona_procedencia_w,
	ie_mala_direta_w,
	ie_fator_rh_w,
	ie_tipo_sangue_w,
	nr_seq_local_atend_med_w,
	ie_obriga_email_w,
	nr_seq_ident_cnes_w,
	nr_ddd_fone_adic_w,
	nr_ddi_fone_adic_w,
	ds_compl_end_w
from	compl_pessoa_fisica
where	cd_pessoa_fisica	= cd_pessoa_fisica_ref_p
and	nr_sequencia		= nr_seq_compl_pessoa_fisica_p;

update	compl_pessoa_fisica
set	cd_municipio_ibge	= CASE WHEN ie_att_cd_municipio_ibge_w='S' THEN  cd_municipio_ibge_w  ELSE cd_municipio_ibge END ,
	cd_cep			= CASE WHEN ie_att_cd_cep_w='S' THEN  cd_cep_w  ELSE cd_cep END ,
	ds_complemento		= CASE WHEN ie_att_ds_complemento_w='S' THEN  ds_complemento_w  ELSE ds_complemento END ,
	ds_bairro		= CASE WHEN ie_att_ds_bairro_w='S' THEN  ds_bairro_w  ELSE ds_bairro END ,
	sg_estado		= CASE WHEN ie_att_sg_estado_w='S' THEN  sg_estado_w  ELSE sg_estado END ,
	nr_ramal		= CASE WHEN ie_att_nr_ramal_w='S' THEN  nr_ramal_w  ELSE nr_ramal END ,
	cd_empresa_refer	= CASE WHEN ie_tipo_pessoa_p='1' THEN  CASE WHEN ie_att_cd_empresa_refer_w='S' THEN  cd_empresa_refer_w  ELSE cd_empresa_refer END   ELSE cd_empresa_refer END ,
	cd_profissao		= CASE WHEN ie_tipo_pessoa_p='1' THEN  CASE WHEN ie_att_cd_profissao_w='S' THEN  cd_profissao_w  ELSE cd_profissao END   ELSE cd_profissao END ,
	ds_endereco		= CASE WHEN ie_att_ds_endereco_w='S' THEN  ds_endereco_w  ELSE ds_endereco END ,
	nr_telefone		= CASE WHEN ie_att_nr_telefone_w='S' THEN  nr_telefone_w  ELSE nr_telefone END ,
	ds_email		= CASE WHEN ie_att_ds_email_w='S' THEN  ds_email_w  ELSE ds_email END ,
	nm_contato		= CASE WHEN ie_att_nm_contato_w='S' THEN  coalesce(nm_contato_w,' ')  ELSE nm_contato END ,
	nr_endereco		= CASE WHEN ie_att_nr_endereco_w='S' THEN  nr_endereco_w  ELSE nr_endereco END ,
	ds_observacao		= CASE WHEN ie_att_ds_observacao_w='S' THEN  ds_observacao_w  ELSE ds_observacao END ,
	nr_seq_parentesco	= CASE WHEN ie_att_nr_seq_parentesco_w='S' THEN  nr_seq_parentesco_w  ELSE nr_seq_parentesco END ,
	ds_fone_adic		= CASE WHEN ie_att_ds_fone_adic_w='S' THEN  ds_fone_adic_w  ELSE ds_fone_adic END ,
	ds_fax			= CASE WHEN ie_att_ds_fax_w='S' THEN  ds_fax_w  ELSE ds_fax END ,
	nr_seq_pais		= CASE WHEN ie_att_nr_seq_pais_w='S' THEN  nr_seq_pais_w  ELSE nr_seq_pais END ,
	ds_fonetica		= CASE WHEN ie_att_ds_fonetica_w='S' THEN  ds_fonetica_w  ELSE ds_fonetica END ,
	nr_ddd_telefone		= CASE WHEN ie_att_nr_ddd_telefone_w='S' THEN  nr_ddd_telefone_w  ELSE nr_ddd_telefone END ,
	nr_ddi_telefone		= CASE WHEN ie_att_nr_ddi_telefone_w='S' THEN  nr_ddi_telefone_w  ELSE nr_ddi_telefone END ,
	nr_ddi_fax		= CASE WHEN ie_att_nr_ddi_fax_w='S' THEN  nr_ddi_fax_w  ELSE nr_ddi_fax END ,
	nr_ddd_fax		= CASE WHEN ie_att_nr_ddd_fax_w='S' THEN  nr_ddd_fax_w  ELSE nr_ddd_fax END ,
	cd_tipo_logradouro	= CASE WHEN ie_att_cd_tipo_logradouro_w='S' THEN  cd_tipo_logradouro_w  ELSE cd_tipo_logradouro END ,
	ds_website		= CASE WHEN ie_att_ds_website_w='S' THEN  ds_website_w  ELSE ds_website END ,
	nm_contato_pesquisa	= CASE WHEN ie_att_nm_contato_pesquisa_w='S' THEN  nm_contato_pesquisa_w  ELSE nm_contato_pesquisa END ,
	ie_nf_correio		= CASE WHEN ie_att_ie_nf_correio_w='S' THEN  ie_nf_correio_w  ELSE ie_nf_correio END ,
	cd_zona_procedencia	= CASE WHEN ie_att_cd_zona_procedencia_w='S' THEN  cd_zona_procedencia_w  ELSE cd_zona_procedencia END ,
	ie_mala_direta		= CASE WHEN ie_att_ie_mala_direta_w='S' THEN  ie_mala_direta_w  ELSE ie_mala_direta END ,
	ie_fator_rh		= CASE WHEN ie_att_ie_fator_rh_w='S' THEN  ie_fator_rh_w  ELSE ie_fator_rh END ,
	ie_tipo_sangue		= CASE WHEN ie_att_ie_tipo_sangue_w='S' THEN  ie_tipo_sangue_w  ELSE ie_tipo_sangue END ,
	nr_seq_local_atend_med	= CASE WHEN ie_att_nr_seq_local_atend_me_w='S' THEN  nr_seq_local_atend_med_w  ELSE nr_seq_local_atend_med END ,
	ie_obriga_email		= CASE WHEN ie_att_ie_obriga_email_w='S' THEN  ie_obriga_email_w  ELSE ie_obriga_email END ,
	nr_seq_ident_cnes	= CASE WHEN ie_att_nr_seq_ident_cnes_w='S' THEN  nr_seq_ident_cnes_w  ELSE nr_seq_ident_cnes END ,
	ds_municipio		= CASE WHEN ie_att_ds_municipio_w='S' THEN  ds_municipio_w  ELSE ds_municipio END ,
	nr_ddd_fone_adic	= CASE WHEN ie_att_nr_ddd_fone_adic_w='S' THEN  nr_ddd_fone_adic_w  ELSE nr_ddd_fone_adic END ,
	nr_ddi_fone_adic	= CASE WHEN ie_att_nr_ddi_fone_adic_w='S' THEN  nr_ddi_fone_adic_w  ELSE nr_ddi_fone_adic END ,
	ds_compl_end		= CASE WHEN ie_att_ds_compl_end_w='S' THEN  ds_compl_end_w  ELSE ds_compl_end END ,
	dt_atualizacao		= clock_timestamp(),
	nm_usuario		= nm_usuario_p
where	cd_pessoa_fisica	= cd_pessoa_fisica_att_p
and	nr_sequencia		= nr_seq_compl_p;

ie_lancar_mensagem_alt_w	:= pls_usuario_pck.get_ie_lancar_mensagem_alt;

end;

begin

ie_tipo_chamada_w	:= coalesce(ie_tipo_chamada_p, 'U');

select	max(a.nr_sequencia)
into STRICT	nr_seq_regra_alt_pf_ref_w
from	pls_regra_alt_pf_ref a,
	pls_regra_alt_pf_ref_atrib b
where	a.nr_sequencia = b.nr_seq_regra
and	a.cd_estabelecimento = cd_estabelecimento_p
and	((a.ie_acao = ie_tipo_chamada_w) or (a.ie_acao = 'A'));

if (nr_seq_regra_alt_pf_ref_w IS NOT NULL AND nr_seq_regra_alt_pf_ref_w::text <> '') then
	verificar_regra_alteracao_camp;
end if;

select	max(cd_pessoa_end_ref),
	max(nr_seq_end_ref)
into STRICT	cd_pessoa_end_ref_w,
	nr_seq_end_ref_w
from	compl_pessoa_fisica
where	cd_pessoa_fisica	= cd_pessoa_fisica_p
and	nr_sequencia		= nr_seq_compl_p;

/*Tratamento para a apresentacao da mensagem de alteracao enviada a analise*/

ie_lancar_mensagem_alt_w	:= pls_usuario_pck.get_ie_lancar_mensagem_alt;

if (nr_seq_end_ref_w IS NOT NULL AND nr_seq_end_ref_w::text <> '') and (cd_pessoa_end_ref_w IS NOT NULL AND cd_pessoa_end_ref_w::text <> '') then
	atualizar_dados_pessoa(cd_pessoa_end_ref_w, cd_pessoa_fisica_p, nr_seq_end_ref_w, nr_seq_compl_p, '1');
else
	for r_c01_w in c01 loop
		begin
		atualizar_dados_pessoa(cd_pessoa_fisica_p, r_c01_w.cd_pessoa_fisica, nr_seq_compl_p, r_c01_w.nr_seq_compl, '2');
		end;
	end loop;
end if;

CALL pls_usuario_pck.set_ie_lancar_mensagem_alt(ie_lancar_mensagem_alt_w);

--Criado retorno para a plataforma HTML5, devido a mudanca constante de sessoes realizando a perda do valores das variaveis da package pls_usuario_pck.
ie_lancar_mensagem_p	:= ie_lancar_mensagem_alt_w;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_atualizar_compl_pf ( cd_pessoa_fisica_p text, nr_seq_compl_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text, ie_lancar_mensagem_p out text, ie_tipo_chamada_p text default null) is cd_pessoa_fisica_w varchar(10) FROM PUBLIC;

