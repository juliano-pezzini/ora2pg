-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE med_gerar_tratamento (nr_seq_tratamento_p bigint, nr_seq_visita_p bigint, nr_seq_valor_p bigint, ie_tipo_arvore_p bigint, ie_level_arvore_p bigint, nm_usuario_p text) AS $body$
DECLARE


/* ie_tipo_arvore_p

	0 - Objetivos
	1 - Problemas
	2 - Cuidados

*/
/* ie_level_arvore_p

	0 - Objetivos
		0 - Sistema
		1 - Grupo Objetivo
		2 - Objetivo
	1 - Problemas
		0 - Sistema
		1 - Problema
	2 - Cuidados
		0 - Sistema
		1 - Grupo Cuidados
		2 - Cuidados
*/
nr_sequencia_w		bigint;
nr_seq_objetivo_w	bigint;
nr_seq_problema_w	bigint;
nr_seq_cuidado_w	bigint;

c01 CURSOR FOR
	SELECT	a.nr_sequencia
	from	med_objetivo a
	where	a.nr_sequencia	  = nr_seq_valor_p
	and	ie_level_arvore_p = 2
	and	not exists (SELECT 1
		from	med_objetivo_pac x
		where	x.nr_seq_tratamento	= nr_seq_tratamento_p
		and	x.nr_seq_objetivo	= nr_seq_valor_p)
	
union

	select	a.nr_sequencia
	from	med_objetivo a
	where	a.nr_seq_grupo_obj = nr_seq_valor_p
	and	ie_level_arvore_p  = 1
	and	not exists (select 1
		from	med_objetivo_pac x
		where	x.nr_seq_tratamento	= nr_seq_tratamento_p
		and	x.nr_seq_objetivo	= a.nr_sequencia)
	
union

	select	a.nr_sequencia
	from	med_grupo_objetivo b,
		med_objetivo a
	where	a.nr_seq_grupo_obj = b.nr_sequencia
	and	ie_level_arvore_p  = 0
	and	b.nr_seq_sistema   = nr_seq_valor_p
	and	not exists (select 1
		from	med_objetivo_pac x
		where	x.nr_seq_tratamento	= nr_seq_tratamento_p
		and	x.nr_seq_objetivo	= a.nr_sequencia);

c02 CURSOR FOR
	SELECT	a.nr_sequencia
	from	med_problema a
	where	a.nr_sequencia	  = nr_seq_valor_p
	and	ie_level_arvore_p = 1
	and	not exists (SELECT 1
		from	med_problema_pac x
		where	x.nr_seq_tratamento	= nr_seq_tratamento_p
		and	x.nr_seq_problema	= nr_seq_valor_p)
	
union

	select	a.nr_sequencia
	from	med_problema a
	where	ie_level_arvore_p  = 0
	and	a.nr_seq_sistema   = nr_seq_valor_p
	and	not exists (select 1
		from	med_problema_pac x
		where	x.nr_seq_tratamento	= nr_seq_tratamento_p
		and	x.nr_seq_problema	= a.nr_sequencia);

c03 CURSOR FOR
	SELECT	a.nr_sequencia
	from	med_cuidado a
	where	a.nr_sequencia	  = nr_seq_valor_p
	and	ie_level_arvore_p = 2
	and	not exists (SELECT 1
		from	Med_Cuidado_pac x
		where	x.nr_seq_visita	= nr_seq_visita_p
		and	x.nr_seq_cuidado	= nr_seq_valor_p)
	
union

	select	a.nr_sequencia
	from	med_cuidado a
	where	a.nr_seq_grupo = nr_seq_valor_p
	and	ie_level_arvore_p  = 1
	and	not exists (select 1
		from	Med_Cuidado_pac x
		where	x.nr_seq_visita		= nr_seq_visita_p
		and	x.nr_seq_cuidado	= a.nr_sequencia)
	
union

	select	a.nr_sequencia
	from	med_grupo_cuidado b,
		med_cuidado a
	where	a.nr_seq_grupo = b.nr_sequencia
	and	ie_level_arvore_p  = 0
	and	b.nr_seq_sistema   = nr_seq_valor_p
	and	not exists (select 1
		from	Med_Cuidado_pac x
		where	x.nr_seq_visita		= nr_seq_visita_p
		and	x.nr_seq_cuidado	= a.nr_sequencia);



BEGIN


if (ie_tipo_arvore_p	= 0) then
	begin

	open	c01;
	loop
	fetch	c01 into nr_seq_objetivo_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
		begin

		select	nextval('med_objetivo_pac_seq')
		into STRICT	nr_sequencia_w
		;


		insert	into med_objetivo_pac(nr_sequencia,
			nr_seq_tratamento,
			nr_seq_objetivo,
			dt_objetivo,
			dt_atualizacao,
			nm_usuario,
			qt_objetivo,
			ds_objetivo,
			ds_observacao)
		values (nr_sequencia_w,
			nr_seq_tratamento_p,
			nr_seq_objetivo_w,
			trunc(clock_timestamp()),
			clock_timestamp(),
			nm_usuario_p,
			1, null, null);
		end;
	end loop;
	close c01;
	end;

end if;

if (ie_tipo_arvore_p	= 1) then
	begin

	open	c02;
	loop
	fetch	c02 into nr_seq_problema_w;
	EXIT WHEN NOT FOUND; /* apply on c02 */
		begin

		select	nextval('med_problema_pac_seq')
		into STRICT	nr_sequencia_w
		;

		insert	into med_problema_pac(nr_sequencia,
			nr_seq_tratamento,
			nr_seq_problema,
			dt_atualizacao,
			nm_usuario,
			ie_resultado,
			ds_observacao)
		values (nr_sequencia_w,
			nr_seq_tratamento_p,
			nr_seq_problema_w,
			clock_timestamp(),
			nm_usuario_p,
			'N', null);
		end;
	end loop;
	close c02;
	end;

end if;


if (ie_tipo_arvore_p	= 2) then
	begin

	open	c03;
	loop
	fetch	c03 into nr_seq_cuidado_w;
	EXIT WHEN NOT FOUND; /* apply on c03 */
		begin

		select	nextval('med_cuidado_pac_seq')
		into STRICT	nr_sequencia_w
		;


		insert	into med_cuidado_pac(nr_sequencia,
			nr_seq_visita,
			nr_seq_cuidado,
			dt_atualizacao,
			nm_usuario,
			ds_observacao)
		values (nr_sequencia_w,
			nr_seq_visita_p,
			nr_seq_cuidado_w,
			clock_timestamp(),
			nm_usuario_p,
			null);
		end;
	end loop;
	close c03;
	end;

end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE med_gerar_tratamento (nr_seq_tratamento_p bigint, nr_seq_visita_p bigint, nr_seq_valor_p bigint, ie_tipo_arvore_p bigint, ie_level_arvore_p bigint, nm_usuario_p text) FROM PUBLIC;

