-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE retornar_senha_unitilizada_why (nr_seq_senha_p bigint, ds_return_p INOUT text) AS $body$
DECLARE

                 
ora2pg_rowcount int;
ie_sistema_externo_w    paciente_senha_fila.ie_sistema_externo%type;


BEGIN

if (coalesce(nr_seq_senha_p,0) > 0) then

  select  ie_sistema_externo
  into STRICT    ie_sistema_externo_w
  from    paciente_senha_fila
  where   nr_sequencia = nr_seq_senha_p;

	delete	FROM atendimentos_senha
	where	nr_seq_pac_senha_fila	=	nr_seq_senha_p
	and	coalesce(dt_fim_atendimento::text, '') = '';

	update		paciente_senha_fila
	set		dt_inutilizacao			 = NULL,
			nr_seq_motivo_inutilizacao	 = NULL,
			dt_retorno_senha		=	clock_timestamp(),
			qt_chamadas			= 	0,
			DT_FIM_ATENDIMENTO		 = NULL,
			DT_INICIO_ATENDIMENTO		 = NULL,
			nm_usuario_inutilizacao		 = NULL,
			ds_maquina_inutilizacao		 = NULL,
			DT_PRIMEIRA_CHAMADA		 = NULL,
			DT_CHAMADA			 = NULL,
			NM_USUARIO_CHAMADA		 = NULL,
			DS_MAQUINA_CHAMADA		 = NULL,
			nr_seq_local_senha		 = NULL,
			ie_sistema_externo    		 = NULL
	where		nr_sequencia 			=	nr_seq_senha_p;
	GET DIAGNOSTICS ora2pg_rowcount = ROW_COUNT;

	if ( ora2pg_rowcount = 0) then
		ds_return_p := 'N';
	end if;
	commit;

  update	paciente_senha_fila
  set		ie_sistema_externo = ie_sistema_externo_w
  where		nr_sequencia = nr_seq_senha_p;

  commit;

end if;



end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE retornar_senha_unitilizada_why (nr_seq_senha_p bigint, ds_return_p INOUT text) FROM PUBLIC;

