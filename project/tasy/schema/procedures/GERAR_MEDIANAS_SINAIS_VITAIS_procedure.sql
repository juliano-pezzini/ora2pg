-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_medianas_sinais_vitais (ie_ciclo_p bigint) AS $body$
DECLARE


ds_filtro_w		varchar(100);
nr_seq_sinal_vital_w	w_atendimento_ciclo_sv.nr_seq_sinal_vital%type;
ciclo_w			smallint;

C01 CURSOR FOR
	SELECT	nr_seq_sinal_vital
	from	w_atendimento_ciclo_sv
	where	ie_ciclo = to_char(ie_ciclo_p);	


BEGIN

ds_filtro_w := ' and ie_mediana is null ' ||
	       ' and ie_mediana_gerada is null ';

if (ie_ciclo_p <> 1) then
	ds_filtro_w := ' and ie_mediana = ''1'' ';
end if;

if (ie_ciclo_p = 1) then
	ciclo_w := ie_ciclo_p + 1;
else
	ciclo_w := ie_ciclo_p;
end if;


CALL exec_sql_dinamico('TASY', 'insert into w_atendimento_ciclo_sv ( ' ||
		    ' nr_sequencia, ' ||
		    ' dt_atualizacao, ' ||
		    ' nr_atendimento, ' ||
		    ' nm_usuario, ' ||
		    ' nr_seq_sinal_vital, ' ||
		    ' dt_atualizacao_nrec, ' ||
		    ' cd_paciente, ' ||
		    ' ie_ciclo, ' ||
		    ' dt_sinal_vital, ' ||
		    ' qt_pa_sistolica,  ' ||
		    ' qt_pa_diastolica, ' ||
		    ' qt_pam, ' ||
		    ' qt_freq_cardiaca, ' ||
		    ' qt_freq_resp, ' ||
		    ' qt_temp, ' ||
		    ' qt_peso, ' ||
		    ' qt_altura_cm, ' ||
		    ' qt_imc, ' ||
		    ' qt_superf_corporia, ' ||
		    ' qt_glicemia_capilar, ' ||
		    ' qt_saturacao_o2, ' ||
		    ' qt_pvc, ' ||
		    ' qt_pae, ' ||
		    ' qt_pressao_intra_cranio, ' ||
		    ' qt_pressao_intra_abd, ' ||
		    ' qt_bcf, ' ||
		    ' qt_bcf_2, ' ||
		    ' qt_bcf_3, ' ||
		    ' qt_temp_incubadora, ' ||
		    ' qt_circunf_panturrilha, ' ||
		    ' qt_circunf_braco, ' ||
		    ' qt_cmb, ' ||
		    ' qt_glicemia_mmol ' ||
		    ' ) ' ||
		' select   w_atendimento_ciclo_sv_seq.nextval, ' ||
		    ' sysdate, ' ||
		    ' a.nr_atendimento, ' ||
		    ' a.nm_usuario, ' ||
		    ' a.nr_sequencia, ' ||
		    ' sysdate, ' ||
		    ' cd_paciente, ' ||
		    ' ' || ie_ciclo_p || ', ' ||
		    ' a.dt_sinal_vital, ' ||
		    ' a.qt_pa_sistolica, ' ||
		    ' a.qt_pa_diastolica, ' ||
		    ' a.qt_pam, ' ||
		    ' a.qt_freq_cardiaca, ' ||
		    ' a.qt_freq_resp, ' ||
		    ' a.qt_temp, ' ||
		    ' a.qt_peso, ' ||
		    ' a.qt_altura_cm, ' ||
		    ' a.qt_imc, ' ||
		    ' a.qt_superf_corporia, ' ||
		    ' a.qt_glicemia_capilar, ' ||
		    ' a.qt_saturacao_o2, ' ||
		    ' a.qt_pvc, ' ||
		    ' a.qt_pae, ' ||
		    ' a.qt_pressao_intra_cranio, ' ||
		    ' a.qt_pressao_intra_abd, ' ||
		    ' a.qt_bcf, ' ||
		    ' a.qt_bcf_2, ' ||
		    ' a.qt_bcf_3, ' ||
		    ' a.qt_temp_incubadora, ' ||
		    ' a.qt_circunf_panturrilha,  ' ||
		    ' a.qt_circunf_braco,  ' ||
		    ' (a.qt_circunf_braco - (0.314 * a.qt_prega_cutanea_triceps)), ' ||
		    ' a.qt_glicemia_mmol  ' ||
		' from   atendimento_sinal_vital a ' || 		
		' where dt_inativacao is null ' ||
		' and 	nvl(a.ie_situacao,''A'') = ''A'' '||		
		' and 	dt_sinal_vital >= trunc(sysdate - (' || ciclo_w || '/1440), ''mi'') ' ||
		' and   ie_integracao = ''S'' ' ||
		ds_filtro_w);
	
	CALL calc_medianas_sinais_vitais(ie_ciclo_p);
	
	if (ie_ciclo_p = 1) then
		open C01;
		loop
		fetch C01 into	
			nr_seq_sinal_vital_w;
		EXIT WHEN NOT FOUND; /* apply on C01 */
			begin		
				update 	atendimento_sinal_vital
				set 	ie_mediana_gerada = 'S'	
				where nr_sequencia = nr_seq_sinal_vital_w;
			end;
		end loop;
		close C01;
	end if;	
		
	delete from w_atendimento_ciclo_sv where ie_ciclo = ie_ciclo_p;

	commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_medianas_sinais_vitais (ie_ciclo_p bigint) FROM PUBLIC;

