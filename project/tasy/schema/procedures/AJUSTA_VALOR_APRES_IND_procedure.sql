-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';


procedure ajusta_valor_apres_ind is 
 
			/* Essa rotina de ajuste tem como finalidade, popular o campo vl_apres_ind, utilizado pelo contábil como valor apresentado na pls_conta_medica_resumo*/
 
 
dt_comp_w		date; 
ind_w			pls_integer := 0; 
vl_apres_ind_w	pls_conta_medica_resumo.vl_apres_ind%type; 
tb_vl_apres_w	pls_util_cta_pck.t_number_table; 
tb_seq_resumo_w pls_util_cta_pck.t_number_table; 
tb_seq_conta_w pls_util_cta_pck.t_number_table; 
 
cursor C01(	dt_competencia_pc	pls_conta_medica_resumo.dt_competencia%type) is 
	select	nr_sequencia, 
		nr_seq_conta, 
			vl_lib_original, 
			vl_glosa 
	from	pls_conta_medica_resumo 
	where	dt_competencia > dt_competencia_pc; 
 



CREATE OR REPLACE PROCEDURE atualiza_registros_resumo ( tb_seq_resumo_p pls_util_cta_pck.t_number_table, tb_seq_conta_p pls_util_cta_pck.t_number_table, tb_vl_apres_p pls_util_cta_pck.t_number_table) AS $body$
BEGIN
 
	if (tb_seq_resumo_p.count > 0) then 
 
		forall i in tb_seq_resumo_p.first..tb_seq_resumo_p.last 
			update	pls_conta_medica_resumo 
			set	vl_apres_ind = tb_vl_apres_p(i) 
			where	nr_sequencia = tb_seq_resumo_p(i) 
			and	nr_seq_conta = tb_seq_conta_p(i);
			commit;
	end if;
 
 
end;
 
begin 
 
dt_comp_w := to_date('01/01/2015 00:00:00','dd/mm/yyyy hh24:mi:ss');
 
for r_c01_w in C01(dt_comp_w) loop 
 
	ind_w := ind_w + 1;
	tb_vl_apres_w(ind_w) 	:= r_c01_w.vl_lib_original - r_c01_w.vl_glosa;
	tb_seq_resumo_w(ind_w) 	:= r_c01_w.nr_sequencia;
	tb_seq_conta_w(ind_w)  := r_c01_w.nr_seq_conta;
	if (ind_w > pls_util_pck.qt_registro_transacao_w) then 
 
		CALL atualiza_registros_resumo(tb_seq_resumo_w, tb_seq_conta_w, tb_vl_apres_w);
		tb_seq_resumo_w.delete;
		tb_vl_apres_w.delete;
		tb_seq_conta_w.delete;
		ind_w := 0;
	end if;
 
end loop;
--Se sobrarem registros nas variaveis tabela, então manda para o banco. 
CALL atualiza_registros_resumo(tb_seq_resumo_w, tb_seq_conta_w, tb_vl_apres_w);
 
end;
$body$
LANGUAGE PLPGSQL
;
-- REVOKE ALL ON PROCEDURE atualiza_registros_resumo ( tb_seq_resumo_p pls_util_cta_pck.t_number_table, tb_seq_conta_p pls_util_cta_pck.t_number_table, tb_vl_apres_p pls_util_cta_pck.t_number_table) FROM PUBLIC;

