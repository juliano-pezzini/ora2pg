-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE proj_duplicar_cronograma ( nm_usuario_p text, nr_seq_cron_p bigint) AS $body$
DECLARE


nr_seq_cron_w		bigint;
nr_seq_etapa_w		bigint;
nr_seq_etapa_novo_w	bigint;
nr_seq_superior_w	bigint;
nr_seq_etapa_nova_w	bigint;

C01 CURSOR FOR
	SELECT	nr_sequencia,
		nr_seq_superior
	from	proj_cron_etapa
	where	nr_seq_cronograma = nr_seq_cron_p
	order by
		nr_sequencia;


BEGIN

select	nextval('proj_cronograma_seq')
into STRICT	nr_seq_cron_w
;

insert into proj_cronograma(
	nr_sequencia,
	nr_seq_cliente,
	cd_empresa,
	dt_atualizacao,
	nm_usuario,
	ds_objetivo,
	cd_pessoa_cliente,
	dt_inicio,
	dt_fim,
	dt_aprovacao,
	nm_usuario_aprov,
	dt_fim_real,
	qt_total_horas,
	qt_horas_realizado,
	qt_horas_saldo,
	dt_atualizacao_nrec,
	nm_usuario_nrec,
	ie_estrutura,
	qt_horas_contrato,
	nr_seq_canal,
	nr_seq_proj,
	ie_cobrado,
	ie_tipo_cronograma,
	pr_realizacao,
	pr_previsao,
	ie_situacao,
	ie_tipo_baseline) -- principal
(SELECT	nr_seq_cron_w,
	nr_seq_cliente,
	cd_empresa,
	clock_timestamp(),
	nm_usuario_p,
	ds_objetivo,
	cd_pessoa_cliente,
	dt_inicio,
	dt_fim,
	dt_aprovacao,
	nm_usuario_aprov,
	dt_fim_real,
	qt_total_horas,
	qt_horas_realizado,
	qt_horas_saldo,
	clock_timestamp(),
	nm_usuario_p,
	ie_estrutura,
	qt_horas_contrato,
	nr_seq_canal,
	nr_seq_proj,
	ie_cobrado,
	ie_tipo_cronograma,
	pr_realizacao,
	pr_previsao,
	ie_situacao,
	'PA' -- parcial
from	proj_cronograma
where	nr_sequencia = nr_seq_cron_p);

open C01;
loop
fetch C01 into
	nr_seq_etapa_w,
	nr_seq_superior_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin

	select	nextval('proj_cron_etapa_seq')
	into STRICT	nr_seq_etapa_novo_w
	;

	/*  controle a etapa superior do novo cronograma */

        insert into proj_controle_superior(
        	nr_sequencia,
		dt_atualizacao,
		nm_usuario,
		dt_atualizacao_nrec,
		nm_usuario_nrec,
		nr_cronograma,
		nr_etapa_anterior,
		nr_etapa_nova,
		nr_etapa_superior)
        values (	nextval('proj_controle_superior_seq'),
		clock_timestamp(),
		nm_usuario_p,
		clock_timestamp(),
		nm_usuario_p,
		nr_seq_cron_w,
		nr_seq_etapa_w,
		nr_seq_etapa_novo_w,
		nr_seq_superior_w);

	select	max(nr_etapa_nova)
	into STRICT	nr_seq_etapa_nova_w
	from 	proj_controle_superior
	where 	nr_etapa_anterior = (SELECT nr_etapa_superior from proj_controle_superior where nr_etapa_anterior = nr_seq_etapa_w and nr_cronograma = nr_seq_cron_w)
	and 	nr_cronograma = nr_seq_cron_w;

	insert into proj_cron_etapa(
		nr_sequencia,
		nr_seq_cronograma,
		dt_atualizacao,
		nm_usuario,
		nr_seq_apres,
		ds_etapa,
		ie_fase,
		dt_inicio_prev,
		dt_fim_prev,
		dt_inicio_real,
		dt_fim_real,
		qt_hora_prev,
		qt_hora_real,
		nr_seq_etapa,
		qt_hora_saldo,
		pr_etapa,
		dt_cadastro,
		dt_final_multiplic,
		dt_piloto,
		dt_ativacao,
		dt_atualizacao_nrec,
		nm_usuario_nrec,
		nr_seq_estrutura,
		ds_atividade,
		nr_seq_superior,
		cd_classificacao,
		nr_seq_ordenacao,
		ie_modulo,
		cd_funcao,
		ie_etapa_exec_desenv,
		ie_mpo,
		ie_aderencia,
		ie_cadastros,
		ie_parametrizacao,
		ie_treinamento,
		ie_teste_piloto,
		pr_previsto,
		ie_obrigatorio,
		ie_tipo_obj_proj_migr,
		ie_atividade_adicional,
		ie_situacao,
		ie_tipo_ativ_met,
		pr_consultoria,
		nr_predecessora,
		ie_regra_ini_fim,
		nr_seq_interno)
	(SELECT	nr_seq_etapa_novo_w,
		nr_seq_cron_w,
		clock_timestamp(),
		nm_usuario_p,
		nr_seq_apres,
		ds_etapa,
		ie_fase,
		dt_inicio_prev,
		dt_fim_prev,
		dt_inicio_real,
		dt_fim_real,
		qt_hora_prev,
		qt_hora_real,
		nr_seq_etapa,
		qt_hora_saldo,
		pr_etapa,
		dt_cadastro,
		dt_final_multiplic,
		dt_piloto,
		dt_ativacao,
		clock_timestamp(),
		nm_usuario_p,
		nr_seq_estrutura,
		ds_atividade,
		nr_seq_etapa_nova_w,
		cd_classificacao,
		nr_seq_ordenacao,
		ie_modulo,
		cd_funcao,
		ie_etapa_exec_desenv,
		ie_mpo,
		ie_aderencia,
		ie_cadastros,
		ie_parametrizacao,
		ie_treinamento,
		ie_teste_piloto,
		pr_previsto,
		ie_obrigatorio,
		ie_tipo_obj_proj_migr,
		ie_atividade_adicional,
		ie_situacao,
		ie_tipo_ativ_met,
		pr_consultoria,
		nr_predecessora,
		ie_regra_ini_fim,
		nr_seq_interno
	from	proj_cron_etapa
	where	nr_sequencia = nr_seq_etapa_w);

	insert into proj_controle_baseline(
		nr_sequencia,
		dt_atualizacao,
		nm_usuario,
		dt_atualizacao_nrec,
		nm_usuario_nrec,
		nr_cronograma,
		nr_etapa_principal,
		nr_etapa_parcial)
	values (	nextval('proj_controle_baseline_seq'),
		clock_timestamp(),
		nm_usuario_p,
		clock_timestamp(),
		nm_usuario_p,
		nr_seq_cron_w,
		nr_seq_etapa_w,
		nr_seq_etapa_novo_w);

	end;
end loop;
close C01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE proj_duplicar_cronograma ( nm_usuario_p text, nr_seq_cron_p bigint) FROM PUBLIC;

