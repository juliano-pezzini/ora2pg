-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE cm_alterar_mot_baixa_item_req (nr_requisicao_p bigint, nr_seq_item_p bigint, cd_motivo_baixa_p bigint, qt_atend_p bigint, nm_usuario_p text) AS $body$
DECLARE


qt_item_atend_w			integer;
nr_seq_classif_w		bigint;
ds_setor_requisicao_w		varchar(255);
nm_usuario_requisitante_w	varchar(15);
cd_estabelecimento_w		integer;
ie_envia_ci_w			varchar(1);
qt_conjunto_w			bigint;
nr_seq_conjunto_w		bigint;


BEGIN

select	substr(obter_nome_setor(cd_setor_atendimento),1,255),
	substr(obter_usuario_pessoa(cd_pessoa_requisitante),1,15),
	cd_estabelecimento
into STRICT	ds_setor_requisicao_w,
	nm_usuario_requisitante_w,
	cd_estabelecimento_w
from	cm_requisicao
where	nr_sequencia = nr_requisicao_p;

select	coalesce(max(obter_valor_param_usuario(410, 37, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w)),'S')
into STRICT	ie_envia_ci_w
;

select	coalesce(max(qt_conjunto),0)
into STRICT	qt_conjunto_w
from	cm_requisicao_item
where	nr_sequencia = nr_seq_item_p
and	nr_seq_requisicao = nr_requisicao_p
and	coalesce(cd_motivo_baixa,0) = 0;

if (qt_atend_p > 0) and (qt_atend_p < qt_conjunto_w) then

	select	nr_seq_conjunto
	into STRICT	nr_seq_conjunto_w
	from	cm_requisicao_item
	where	nr_sequencia = nr_seq_item_p
	and	nr_seq_requisicao = nr_requisicao_p
	and	coalesce(cd_motivo_baixa,0) = 0;

	insert into cm_requisicao_item(
		nr_sequencia,
		nr_seq_requisicao,
		dt_atualizacao,
		nm_usuario,
		dt_atualizacao_nrec,
		nm_usuario_nrec,
		nr_seq_conjunto,
		qt_conjunto)
	values(	nextval('cm_requisicao_item_seq'),
		nr_requisicao_p,
		clock_timestamp(),
		nm_usuario_p,
		clock_timestamp(),
		nm_usuario_p,
		nr_seq_conjunto_w,
		(coalesce(qt_conjunto_w,0) - coalesce(qt_atend_p,0)));

	update	cm_requisicao_item
	set	qt_conjunto = qt_atend_p
	where	nr_sequencia = nr_seq_item_p
	and	nr_seq_requisicao = nr_requisicao_p;

end if;

update	cm_requisicao_item
set	cd_motivo_baixa = cd_motivo_baixa_p,
	dt_atualizacao = clock_timestamp(),
	nm_usuario = nm_usuario_p,
	nm_usuario_atend = nm_usuario_p
where	nr_sequencia = nr_seq_item_p
and	nr_seq_requisicao = nr_requisicao_p;

select	count(*)
into STRICT	qt_item_atend_w
from	cm_requisicao_item
where	nr_seq_requisicao = nr_requisicao_p
and	coalesce(cd_motivo_baixa,0) = 0;

if (qt_item_atend_w = 0) then
	begin

	update	cm_requisicao
	set	dt_baixa = clock_timestamp(),
		nm_usuario = nm_usuario_p
	where	nr_sequencia = nr_requisicao_p;

	if (ie_envia_ci_w = 'S') then

		select	obter_classif_comunic('F')
		into STRICT	nr_seq_classif_w
		;

		CALL gerar_comunic_padrao(	clock_timestamp(),
					wheb_mensagem_pck.get_texto(311022,'NR_REQUISICAO='||nr_requisicao_p),
					wheb_mensagem_pck.get_texto(311023,'NR_REQUISICAO='||nr_requisicao_p||';DS_SETOR_REQUISICAO='||ds_setor_requisicao_w),
					nm_usuario_p,
					'N',
					nm_usuario_requisitante_w || ',',
					'N',
					nr_seq_classif_w,
					'',
					'',
					'',
					clock_timestamp(),
					'',
					'');
	end if;

	end;
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cm_alterar_mot_baixa_item_req (nr_requisicao_p bigint, nr_seq_item_p bigint, cd_motivo_baixa_p bigint, qt_atend_p bigint, nm_usuario_p text) FROM PUBLIC;

