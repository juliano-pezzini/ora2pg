-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE labweb_solic_lib_acesso_dados (NR_SEQ_SOLIC_P text, cd_estabelecimento_p bigint, nm_usuario_p text, UF_CRM_P text, DS_FONE_P text, DS_RG_P text, DS_CPF_P text, DS_ENDERECO_P text, DS_ESPEC_P text, cd_perfil_p bigint default null) AS $body$
DECLARE



nr_seq_solic_w			bigint;
ds_email_w				varchar(255);
ds_email_medico_ww		varchar(255);
ds_titulo_w				varchar(255);
ds_mensagem_w			varchar(255);
ds_mensagem_ww			varchar(4000);
nr_crm_w				varchar(20);
nm_solicitante_w		varchar(60);
nm_usuario_email_w		varchar(15);
cd_perfil_w				integer;



BEGIN
if (nr_seq_solic_p IS NOT NULL AND nr_seq_solic_p::text <> '')then

	begin
	select 	ds_email,
		nr_crm,
		nm_solicitante
	into STRICT	ds_email_medico_ww,
		nr_crm_w,
		nm_solicitante_w
	from	lab_solic_acesso_portal
	where	nr_sequencia =  nr_seq_solic_p;

	select CASE WHEN obter_perfil_ativo=0 THEN cd_perfil_p  ELSE obter_perfil_ativo END
	into STRICT cd_perfil_w
	;

	ds_email_w := obter_param_usuario(80, 21, cd_perfil_w, nm_usuario_p, cd_estabelecimento_p, ds_email_w);
	ds_titulo_w := obter_param_usuario(80, 22, cd_perfil_w, nm_usuario_p, cd_estabelecimento_p, ds_titulo_w);
	ds_mensagem_w := obter_param_usuario(80, 23, cd_perfil_w, nm_usuario_p, cd_estabelecimento_p, ds_mensagem_w);
	nm_usuario_email_w := obter_param_usuario(80, 29, cd_perfil_w, nm_usuario_p, cd_estabelecimento_p, nm_usuario_email_w);

	if (ds_email_w IS NOT NULL AND ds_email_w::text <> '') and (ds_titulo_w IS NOT NULL AND ds_titulo_w::text <> '') and (ds_mensagem_w IS NOT NULL AND ds_mensagem_w::text <> '') then
		begin
		ds_mensagem_ww := substr(ds_mensagem_w || chr(13) || chr(10) ||obter_desc_expressao(329239)||' ' /*'Solicitante: '*/||nm_solicitante_w|| chr(13) || chr(10) ||
						  'CRM: '||nr_crm_w||' '||UF_CRM_P|| chr(13) || chr(10) ||
						  obter_desc_expressao(612285)||' '/*'Telefone: '*/||DS_FONE_P|| chr(13) || chr(10) ||
						  'RG: '||DS_RG_P|| chr(13) || chr(10) ||
						  'Cpf: '||DS_CPF_P|| chr(13) || chr(10) ||
						  obter_desc_expressao(612260) || ' '/*'Endereço: '*/||DS_ENDERECO_P|| chr(13) || chr(10) ||
						  obter_desc_expressao(328766) || ' '/*'Especialidade: '*/||DS_ESPEC_P|| chr(13) || chr(10) ||
						  obter_desc_expressao(612263) || ' '/*'E-mail: '*/||ds_email_medico_ww|| chr(13) || chr(10) ||
						  obter_desc_expressao(799184)|| ' '/*'Código da solicitação: '*/ || to_char(nr_seq_solic_p),1,4000);
		CALL enviar_email(ds_titulo_w, ds_mensagem_ww, ds_email_w, ds_email_w, nm_usuario_email_w, 'A');
		end;
	end if;
	end;
end if;
commit;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE labweb_solic_lib_acesso_dados (NR_SEQ_SOLIC_P text, cd_estabelecimento_p bigint, nm_usuario_p text, UF_CRM_P text, DS_FONE_P text, DS_RG_P text, DS_CPF_P text, DS_ENDERECO_P text, DS_ESPEC_P text, cd_perfil_p bigint default null) FROM PUBLIC;

