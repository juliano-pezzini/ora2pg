-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE obter_se_saldo_estoque ( cd_estabelecimento_p bigint, cd_local_estoque_p bigint, cd_material_p prescr_material.cd_material%type, qt_material_p prescr_material.qt_total_dispensar%type, cd_setor_atendimento_p prescr_medica.cd_setor_atendimento%type, cd_unidade_medida_dose_p prescr_material.cd_unidade_medida_dose%type, nr_seq_lote_fornec_p prescr_material.nr_seq_lote_fornec%type ) AS $body$
DECLARE


ie_atualiza_estoque_w       operacao_estoque.ie_atualiza_estoque%type := '0';
qt_estoque_w                prescr_material.qt_total_dispensar%type;
ie_permite_estoque_negativo_w   parametro_estoque.ie_permite_estoque_negativo%type;
qt_saldo_w                  saldo_estoque_lote.qt_estoque%type;
qt_emprestimo_entrada_w     emprestimo_material.qt_material%type;
ds_local_estoque_w          varchar(100);
ds_material_w               varchar(255);
ie_disp_nf_emprestimo_w     parametro_estoque.ie_disp_nf_emprestimo%type;
ie_disp_emprestimo_lib_w    parametro_estoque.ie_disp_emprestimo_lib%type;
cd_material_w               prescr_material.cd_material%type;
cd_operacao_estoque_w       parametro_estoque.cd_operacao_cons_paciente%type;
ie_entrada_saida_w          operacao_estoque.ie_entrada_saida%type;
ie_baixa_estoq_pac_w        varchar(1);
cd_setor_atendimento_w      prescr_medica.cd_setor_atendimento%type;
cd_unidade_medida_dose_w    prescr_material.cd_unidade_medida_dose%type;
nr_seq_lote_fornec_w        prescr_material.nr_seq_lote_fornec%type;
ie_estoque_lote_w           material_estab.ie_estoque_lote%type;


BEGIN

cd_material_w := cd_material_p;
qt_estoque_w := qt_material_p;
cd_setor_atendimento_w := cd_setor_atendimento_p;
cd_unidade_medida_dose_w := cd_unidade_medida_dose_p;
nr_seq_lote_fornec_w := nr_seq_lote_fornec_p;

select  coalesce(max(ie_permite_estoque_negativo),'S'),
        coalesce(max(ie_disp_nf_emprestimo),'N'),
        coalesce(max(ie_disp_emprestimo_lib),'N'),
        coalesce(max(cd_operacao_cons_paciente),0)
into STRICT    ie_permite_estoque_negativo_w,
        ie_disp_nf_emprestimo_w,
        ie_disp_emprestimo_lib_w,
        cd_operacao_estoque_w
from    parametro_estoque
where   cd_estabelecimento  = cd_estabelecimento_p;

if (ie_permite_estoque_negativo_w = 'L') then
    select  coalesce(max(ie_permite_estoque_negativo),'S')
    into STRICT    ie_permite_estoque_negativo_w
    from    local_estoque
    where   cd_local_estoque = cd_local_estoque_p;
end if;

begin

select  ie_atualiza_estoque,
        ie_entrada_saida
into STRICT    ie_atualiza_estoque_w,
        ie_entrada_saida_w
from    operacao_estoque
where   cd_operacao_estoque  = cd_operacao_estoque_w;
exception
    when ACCESS_INTO_NULL or
            data_exception or
            no_data_found or
            ROWTYPE_MISMATCH or
            too_many_rows or
            data_exception then
        ie_entrada_saida_w := 'N';
end;

if (cd_local_estoque_p IS NOT NULL AND cd_local_estoque_p::text <> '') then

    select  coalesce(max(ie_estoque_lote),'N')
    into STRICT    ie_estoque_lote_w
    from    material_estab
    where   cd_material = cd_material_w
    and     cd_estabelecimento = cd_estabelecimento_p;

    qt_estoque_w := obter_quantidade_convertida(cd_material_w, qt_estoque_w, cd_unidade_medida_dose_w, 'UME');
    if (coalesce(nr_seq_lote_fornec_w, 0) > 0 and
        ie_estoque_lote_w = 'S') then
        if (ie_entrada_saida_w = 'S') then
            qt_estoque_w := qt_estoque_w * -1;
        end if;
        if (qt_estoque_w < 0) then
            if (ie_permite_estoque_negativo_w in ('N','EE')) and (ie_atualiza_estoque_w = 'S') then
                select  coalesce(max(a.qt_estoque),0)
                into STRICT    qt_saldo_w
                from    saldo_estoque_lote a
                where   a.cd_estabelecimento    = cd_estabelecimento_p
                and     a.cd_local_estoque      = cd_local_estoque_p
                and     substr(obter_dados_material(a.cd_material, 'EST'),1,30) = substr(obter_dados_material(cd_material_w,'EST'),1,30)
                and     a.dt_mesano_referencia  = PKG_DATE_UTILS.start_of(clock_timestamp(), 'month', 0)
                and     a.nr_seq_lote           = nr_seq_lote_fornec_w;

                if (qt_saldo_w < abs(qt_estoque_w)) then
                    ds_material_w       := substr(obter_desc_material(cd_material_w),1,255);
                    ds_local_estoque_w  := substr(obter_desc_local_estoque(cd_local_estoque_p),1,100);
                    CALL wheb_mensagem_pck.exibir_mensagem_abort(182539, --Nao existe saldo para o material:
                                        'CD_MATERIAL='||cd_material_w||';'||
                                        'DS_MATERIAL='||ds_material_w||';'||
                                        'CD_LOCAL_ESTOQUE='||cd_local_estoque_p||';'||
                                        'DS_LOCAL_ESTOQUE='||ds_local_estoque_w||';'||
                                        'QT_SALDO='||qt_saldo_w||';'||
                                        'QT_EMPRESTIMO='||qt_emprestimo_entrada_w||';'||
                                        'QT_ESTOQUE='||qt_estoque_w);
                end if;
            end if;
        end if;
    else
        if (ie_entrada_saida_w = 'S') then
            qt_estoque_w := qt_estoque_w * -1;
        end if;

        select  coalesce(max(cd_material_estoque), max(cd_material_w))
        into STRICT    cd_material_w
        from    material
        where   cd_material     = cd_material_w;

        ie_baixa_estoq_pac_w := obter_se_baixa_estoque_pac(cd_setor_atendimento_w, cd_material_w,null,0);

        if (qt_estoque_w < 0) and (ie_baixa_estoq_pac_w = 'S') then
            begin
            if (ie_permite_estoque_negativo_w = 'N') then
                select  coalesce(max(a.qt_estoque),0)
                into STRICT    qt_saldo_w
                from    saldo_estoque a
                where   a.cd_estabelecimento  = cd_estabelecimento_p
                and     a.cd_local_estoque    = cd_local_estoque_p
                and     a.cd_material = cd_material_w
                and     a.dt_mesano_referencia    = PKG_DATE_UTILS.start_of(clock_timestamp(), 'month', 0);

                if (ie_atualiza_estoque_w  = 'S') and (qt_saldo_w < abs(qt_estoque_w)) then
                    ds_material_w       := substr(obter_desc_material(cd_material_w),1,255);
                    ds_local_estoque_w  := substr(obter_desc_local_estoque(cd_local_estoque_p),1,100);
                    CALL wheb_mensagem_pck.exibir_mensagem_abort(182536, --Nao existe saldo para o material:
                                            'CD_MATERIAL='||cd_material_w||';'||
                                            'DS_MATERIAL='||ds_material_w||';'||
                                            'CD_LOCAL_ESTOQUE='||cd_local_estoque_p||';'||
                                            'DS_LOCAL_ESTOQUE='||ds_local_estoque_w||';'||
                                            'QT_SALDO='||qt_saldo_w||';'||
                                            'QT_ESTOQUE='||qt_estoque_w);

                end if;
            elsif (ie_permite_estoque_negativo_w = 'EE') then
                begin

                select  coalesce(max(a.qt_estoque),0)
                into STRICT    qt_saldo_w
                from    saldo_estoque a
                where   a.cd_estabelecimento  = cd_estabelecimento_p
                and     a.cd_local_estoque    = cd_local_estoque_p
                and     a.cd_material = cd_material_w
                and     a.dt_mesano_referencia    = PKG_DATE_UTILS.start_of(clock_timestamp(), 'month', 0);

                    if (ie_disp_nf_emprestimo_w = 'S') then
                        begin
                        if (ie_disp_emprestimo_lib_w = 'S') then
                            select  coalesce(sum(b.qt_material - coalesce(b.qt_nota_fiscal,0)),0)
                            into STRICT    qt_emprestimo_entrada_w
                            from    emprestimo c,
                                emprestimo_material b
                            where   b.nr_emprestimo     = c.nr_emprestimo
                            and b.qt_material       > 0
                            and coalesce(b.ie_atualiza_estoque,'X') <> 'S'
                            and c.ie_situacao       <> 'I'
                            and c.ie_tipo       = 'E'
                            and (c.dt_liberacao IS NOT NULL AND c.dt_liberacao::text <> '')
                            and c.cd_estabelecimento    = cd_estabelecimento_p
                            and c.cd_local_estoque  = cd_local_estoque_p
                            and exists (SELECT  1
                                    from    material a
                                    where   a.cd_material = b.cd_material
                                    and a.cd_material_estoque   = cd_material_w);
                        else
                            select  coalesce(sum(b.qt_material - coalesce(b.qt_nota_fiscal,0)),0)
                            into STRICT    qt_emprestimo_entrada_w
                            from    emprestimo c,
                                emprestimo_material b
                            where   b.nr_emprestimo     = c.nr_emprestimo
                            and b.qt_material       > 0
                            and coalesce(b.ie_atualiza_estoque,'X') <> 'S'
                            and c.ie_situacao       <> 'I'
                            and c.ie_tipo       = 'E'
                            and c.cd_estabelecimento    = cd_estabelecimento_p
                            and c.cd_local_estoque  = cd_local_estoque_p
                            and exists (SELECT  1
                                    from    material a
                                    where   a.cd_material = b.cd_material
                                    and a.cd_material_estoque   = cd_material_w);
                        end if;
                        end;
                    else
                        begin
                        if (ie_disp_emprestimo_lib_w = 'S') then
                            select  coalesce(sum(b.qt_material),0)
                            into STRICT    qt_emprestimo_entrada_w
                            from    emprestimo c,
                                emprestimo_material b
                            where   b.nr_emprestimo     = c.nr_emprestimo
                            and b.qt_material       > 0
                            and coalesce(b.ie_atualiza_estoque,'X') <> 'S'
                            and c.ie_situacao       <> 'I'
                            and c.ie_tipo       = 'E'
                            and (c.dt_liberacao IS NOT NULL AND c.dt_liberacao::text <> '')
                            and c.cd_estabelecimento    = cd_estabelecimento_p
                            and c.cd_local_estoque  = cd_local_estoque_p
                            and exists (SELECT  1
                                    from    material a
                                    where   a.cd_material = b.cd_material
                                    and a.cd_material_estoque   = cd_material_w);
                        else
                            select  /*+ index(b empmate_i1) index (c emprest_pk) */                                coalesce(sum(b.qt_material),0)
                            into STRICT    qt_emprestimo_entrada_w
                            from    emprestimo c,
                                emprestimo_material b
                            where   b.nr_emprestimo     = c.nr_emprestimo
                            and b.qt_material       > 0
                            and coalesce(b.ie_atualiza_estoque,'X') <> 'S'
                            and c.ie_situacao       <> 'I'
                            and c.ie_tipo       = 'E'
                            and c.cd_estabelecimento    = cd_estabelecimento_p
                            and c.cd_local_estoque  = cd_local_estoque_p
                            and exists (SELECT  1
                                    from    material a
                                    where   a.cd_material = b.cd_material
                                    and a.cd_material_estoque   = cd_material_w);
                        end if;
                        end;
                    end if;

                    if (ie_atualiza_estoque_w = 'S') and
                        ((qt_saldo_w + qt_emprestimo_entrada_w) < abs(qt_estoque_w)) then
                        ds_material_w       := substr(obter_desc_material(cd_material_w),1,255);
                        ds_local_estoque_w  := substr(obter_desc_local_estoque(cd_local_estoque_p),1,100);
                        CALL wheb_mensagem_pck.exibir_mensagem_abort(182539,--Nao existe saldo para o material:
                                            'CD_MATERIAL='||cd_material_w||';'||
                                            'DS_MATERIAL='||ds_material_w||';'||
                                            'CD_LOCAL_ESTOQUE='||cd_local_estoque_p||';'||
                                            'DS_LOCAL_ESTOQUE='||ds_local_estoque_w||';'||
                                            'QT_SALDO='||qt_saldo_w||';'||
                                            'QT_EMPRESTIMO='||qt_emprestimo_entrada_w||';'||
                                            'QT_ESTOQUE='||qt_estoque_w);

                    end if;
                end;
            end if;
            end;
        end if;
    end if;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE obter_se_saldo_estoque ( cd_estabelecimento_p bigint, cd_local_estoque_p bigint, cd_material_p prescr_material.cd_material%type, qt_material_p prescr_material.qt_total_dispensar%type, cd_setor_atendimento_p prescr_medica.cd_setor_atendimento%type, cd_unidade_medida_dose_p prescr_material.cd_unidade_medida_dose%type, nr_seq_lote_fornec_p prescr_material.nr_seq_lote_fornec%type ) FROM PUBLIC;

