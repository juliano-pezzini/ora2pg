-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_log_diag_doenca (nr_seq_interno_p bigint, nm_usuario_p text, ie_acao_p text) AS $body$
DECLARE


dt_diagnostico_w			diagnostico_doenca.dt_diagnostico%type;
cd_doenca_w 				diagnostico_doenca.cd_doenca%type;
nr_atendimento_w  			diagnostico_doenca.nr_atendimento%type;
ie_diag_referencia_w  		diagnostico_doenca.ie_diag_referencia%type;
ie_diag_tratamento_w  		diagnostico_doenca.ie_diag_tratamento%type;
ie_diag_admissao_w  		diagnostico_doenca.ie_diag_admissao%type;
ie_diag_trat_cert_w 		diagnostico_doenca.ie_diag_trat_cert%type;
ie_diag_pre_cir_w 			diagnostico_doenca.ie_diag_pre_cir%type;
ie_diag_cirurgia_w  		diagnostico_doenca.ie_diag_cirurgia%type;
ie_diag_alta_w  			diagnostico_doenca.ie_diag_alta%type;
ie_diag_obito_w 			diagnostico_doenca.ie_diag_obito%type;
ie_diag_princ_depart_w  	diagnostico_doenca.ie_diag_princ_depart%type;
ie_diag_princ_episodio_w 	diagnostico_doenca.ie_diag_princ_episodio%type;
ie_tipo_diagnostico_w 		diagnostico_doenca.ie_tipo_diagnostico%type;
ie_classificacao_doenca_w 	diagnostico_doenca.ie_classificacao_doenca%type;
nr_seq_interno_w 			diagnostico_doenca.nr_seq_interno%type;
nm_usuario_nrec_w			diagnostico_doenca.nm_usuario%type;
cd_setor_atendimento_w		diagnostico_doenca.cd_setor_atendimento%type;
cd_medico_w					diagnostico_doenca.cd_medico%type;
nr_seq_log_w				diagnostico_doenca_depart.nr_sequencia%type;
cd_pessoa_fisica_w			diagnostico_doenca_depart.cd_pessoa_fisica%type;
ie_situacao_w				varchar(1) := 'S';
ie_diag_filho_w				varchar(1)	:= 'N';
ds_stack_w				varchar(4000);


BEGIN
select	CASE WHEN count(*)=1 THEN 'S'  ELSE 'N' END
into STRICT	ie_diag_filho_w
from	diagnostico_doenca a
where	nr_seq_interno = nr_seq_interno_p
and 	(cd_doenca_superior IS NOT NULL AND cd_doenca_superior::text <> '');

if (ie_diag_filho_w = 'N') then

		select 	dt_diagnostico,
			cd_doenca,
			nr_atendimento,
			cd_medico,
			obter_setor_atendimento(nr_atendimento),
			obter_pessoa_atendimento(nr_atendimento, 'C'),
			ie_diag_referencia,
			ie_diag_tratamento,
			ie_diag_admissao,
			ie_diag_trat_cert,
			ie_diag_pre_cir,
			ie_diag_cirurgia,
			ie_diag_alta,
			ie_diag_obito,
			ie_diag_princ_depart,
			ie_diag_princ_episodio,
			'A',
			ie_tipo_diagnostico,
			ie_classificacao_doenca,
			nr_seq_interno
		into STRICT 	dt_diagnostico_w,
			cd_doenca_w,
			nr_atendimento_w,
			cd_medico_w,
			cd_setor_atendimento_w,
			cd_pessoa_fisica_w,
			ie_diag_referencia_w,
			ie_diag_tratamento_w,
			ie_diag_admissao_w,
			ie_diag_trat_cert_w,
			ie_diag_pre_cir_w,
			ie_diag_cirurgia_w,
			ie_diag_alta_w,
			ie_diag_obito_w,
			ie_diag_princ_depart_w,
			ie_diag_princ_episodio_w,
			ie_situacao_w,
			ie_tipo_diagnostico_w,
			ie_classificacao_doenca_w,
			nr_seq_interno_w 		
		from	diagnostico_doenca
		where	nr_seq_interno = nr_seq_interno_p;

		if (ie_acao_p = 'U') then
			
			select 	coalesce(max(nr_sequencia), 0)
			into STRICT 	nr_seq_log_w
			from 	diagnostico_doenca_depart
			where 	nr_atendimento = nr_atendimento_w
			and 	cd_doenca = cd_doenca_w
			and	coalesce(obter_departamento_data_diag(nr_atendimento, dt_atualizacao_nrec), 0) = coalesce(obter_departamento_data_diag(nr_atendimento_w,clock_timestamp()),0);
			
			if (nr_seq_log_w > 0) then
				update	diagnostico_doenca_depart
				set	ie_situacao = 'I'
				where	nr_sequencia = nr_seq_log_w;
				commit;
			end if;
		end if;

    if (cd_setor_atendimento_w IS NOT NULL AND cd_setor_atendimento_w::text <> '') and (obter_sigla_pais_locale(nm_usuario_p) <> 'ja_JP') then
      insert into diagnostico_doenca_depart(
        nr_sequencia,
        dt_diagnostico,
        cd_doenca,
        nr_atendimento,
        cd_profissional,
        cd_pessoa_fisica,
        nm_usuario_nrec,
        dt_atualizacao_nrec,
        dt_atualizacao,
        dt_registro,
        cd_setor_atendimento,
        ie_diag_referencia,
        ie_diag_tratamento,
        ie_diag_admissao,
        ie_diag_trat_cert,
        ie_diag_pre_cir,
        ie_diag_cirurgia,
        ie_diag_alta,
        ie_diag_obito,
        ie_diag_princ_depart,
        ie_diag_princ_episodio,
        nm_usuario,
        ie_situacao,
        nr_seq_episodio,
        ie_tipo_diagnostico,
        ie_classificacao_doenca,
        nr_seq_interno
      ) values (
        nextval('diagnostico_doenca_depart_seq'),
        dt_diagnostico_w,
        cd_doenca_w,
        nr_atendimento_w,
        cd_medico_w,
        cd_pessoa_fisica_w,
        nm_usuario_p,
        clock_timestamp(),
        clock_timestamp(),
        clock_timestamp(),
        cd_setor_atendimento_w,
        ie_diag_referencia_w,
        ie_diag_tratamento_w,
        ie_diag_admissao_w,
        ie_diag_trat_cert_w,
        ie_diag_pre_cir_w,
        ie_diag_cirurgia_w,
        ie_diag_alta_w,
        ie_diag_obito_w,
        ie_diag_princ_depart_w,
        ie_diag_princ_episodio_w,
        coalesce(nm_usuario_nrec_w, nm_usuario_p),
        ie_situacao_w,
        CASE WHEN obter_episodio_atendimento(nr_atendimento_w)=0 THEN null  ELSE obter_episodio_atendimento(nr_atendimento_w) END ,
        ie_tipo_diagnostico_w,
        ie_classificacao_doenca_w,
        nr_seq_interno_w
      );
    end if;
		
		select	dbms_utility.format_call_stack
		into STRICT	ds_stack_w
		;
		
		if (position('ISH_DIAGNOSIS_PCK' in ds_stack_w) = 0) then
			commit;
		end if;
end if;		
	
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_log_diag_doenca (nr_seq_interno_p bigint, nm_usuario_p text, ie_acao_p text) FROM PUBLIC;

