-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE san_desfazer_registro_bolsa ( nr_seq_proc_bolsa_p bigint, nr_seq_reserva_p bigint, nr_seq_item_p bigint, nm_usuario_p text) AS $body$
DECLARE


qt_volume_w		double precision;
qt_volume_alterado_w	double precision;
nr_seq_horario_w	bigint;
nr_prescricao_w		prescr_procedimento.nr_prescricao%type;
nr_seq_procedimento_w	prescr_procedimento.nr_sequencia%type;
nr_sequencia_w		bigint;


BEGIN

if (nr_seq_proc_bolsa_p IS NOT NULL AND nr_seq_proc_bolsa_p::text <> '') and (nr_seq_reserva_p IS NOT NULL AND nr_seq_reserva_p::text <> '') and (nr_seq_item_p IS NOT NULL AND nr_seq_item_p::text <> '') then

	select	max(qt_volume),
		max(nr_seq_horario)
	into STRICT	qt_volume_w,
		nr_seq_horario_w
	from	prescr_proc_bolsa
	where	nr_sequencia = nr_seq_proc_bolsa_p;

	update	prescr_proc_bolsa
	set	dt_cancelamento = clock_timestamp(),
		nm_usuario_cancel = nm_usuario_p
	where	nr_sequencia = nr_seq_proc_bolsa_p;

	/*if	(nr_seq_horario_w is not null) and
		(nr_seq_horario_w > 0) then
		suspender_prescr_proc_hor(nr_seq_horario_w, nm_usuario_p);
	end if;*/
	select	coalesce(qt_volume_atend,0) - qt_volume_w
	into STRICT	qt_volume_alterado_w
	from	san_reserva_item
	where	nr_seq_reserva = nr_seq_reserva_p
	and	nr_seq_item = nr_seq_item_p;

	update	san_reserva_item
	set	qt_volume_atend = qt_volume_alterado_w
	where	nr_seq_reserva = nr_seq_reserva_p
	and	nr_seq_item = nr_seq_item_p;

	select	max(nr_prescricao),
		max(nr_seq_prescr)
	into STRICT	nr_prescricao_w,
		nr_seq_procedimento_w
	from	san_reserva_item
	where	nr_seq_reserva = nr_seq_reserva_p
	and	nr_seq_item = nr_seq_item_p;

	if (coalesce(nr_prescricao_w,0) > 0) then
		/* obter sequencia */

		select	nextval('prescr_solucao_evento_seq')
		into STRICT	nr_sequencia_w
		;

		/* gerar evento */

		insert into prescr_solucao_evento(
			nr_sequencia,
			dt_atualizacao,
			nm_usuario,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			nr_prescricao,
			nr_seq_solucao,
			nr_seq_material,
			nr_seq_procedimento,
			nr_seq_nut,
			nr_seq_nut_neo,
			ie_forma_infusao,
			ie_tipo_dosagem,
			qt_dosagem,
			qt_vol_infundido,
			qt_vol_desprezado,
			qt_volume_parcial,
			cd_pessoa_fisica,
			ie_alteracao,
			dt_alteracao,
			ie_evento_valido,
			nr_seq_motivo,
			ds_observacao,
			ie_tipo_solucao,
			qt_volume_fase,
			nr_etapa_evento)
		values (
			nr_sequencia_w,
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			nr_prescricao_w,
			null,
			null,
			nr_seq_procedimento_w,
			null,
			null,
			null,
			null,
			null,
			null,
			null,
			null,
			obter_dados_usuario_opcao(nm_usuario_p, 'C'),
			29,
			clock_timestamp(),
			'S',
			null,
			null,
			3,
			null,
			null);
	end if;

end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE san_desfazer_registro_bolsa ( nr_seq_proc_bolsa_p bigint, nr_seq_reserva_p bigint, nr_seq_item_p bigint, nm_usuario_p text) FROM PUBLIC;

