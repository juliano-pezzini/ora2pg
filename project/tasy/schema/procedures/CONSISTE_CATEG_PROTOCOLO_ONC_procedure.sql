-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE consiste_categ_protocolo_onc ( cd_protocolo_p bigint, nr_sequencia_p bigint, cd_pessoa_fisica_p text, nr_seq_loco_regional_p bigint, nm_usuario_p text, ie_permite_p INOUT text) AS $body$
DECLARE


qt_registro_w	                bigint;
qt_reg_topografia_protocolo_w   bigint;
ie_permite_w	                varchar(10);
ie_param_992_w	                varchar(10);
cd_topografia_w                 can_loco_regional.cd_topografia%type;


BEGIN
ie_param_992_w	:= Obter_Valor_Param_Usuario(281, 992, Obter_perfil_Ativo, Wheb_Usuario_Pck.Get_nm_Usuario, 0);
if (coalesce(ie_param_992_w,'S') = 'S') then
    ie_permite_w	:= 'N';
	
    select	count(*)
    into STRICT	qt_registro_w
    from	PROT_MEDIC_CAT_TOPOGRAFICA
    where	cd_protocolo		= cd_protocolo_p
    and	    nr_sequencia		= nr_sequencia_p
    and	    coalesce(ie_situacao,'A')	= 'A';

    select  cd_topografia
    into STRICT    cd_topografia_w
    from    can_loco_regional
    where   nr_sequencia        = nr_seq_loco_regional_p
    and     cd_pessoa_fisica    = cd_pessoa_fisica
    and     coalesce(dt_inativacao::text, '') = ''
    and     (CD_TOPOGRAFIA IS NOT NULL AND CD_TOPOGRAFIA::text <> '')
    and     ie_situacao         = 'A';

    if (qt_registro_w	> 0) then
        
        select	count(*)
        into STRICT	qt_registro_w
        from	can_loco_regional a,
                cido_topografia b,
                PROT_MEDIC_CAT_TOPOGRAFICA c
        where   a.cd_pessoa_fisica	= cd_pessoa_fisica_p
        and	    b.cd_topografia		= cd_topografia_w
        and	    c.cd_categoria		= b.cd_categoria
        and	    c.cd_protocolo		= cd_protocolo_p
        and	    c.nr_sequencia		= nr_sequencia_p
        and	    coalesce(c.ie_situacao,'A')	= 'A';

        if (qt_registro_w	> 0) then
            ie_permite_w	:= 'S';
        end if;
    end if;

    select	coalesce(count(*),0)
    into STRICT	qt_reg_topografia_protocolo_w
    from	can_loco_regional a,
            cido_topografia b,
            PROT_MEDIC_CAT_TOPOGRAFICA c
    where   a.cd_pessoa_fisica	= cd_pessoa_fisica_p
    and	    b.cd_topografia		= cd_topografia_w
    and	    c.cd_categoria		= b.cd_categoria
    and	    c.cd_protocolo		= cd_protocolo_p
    and	    coalesce(c.ie_situacao,'A')	= 'A';

    if (qt_reg_topografia_protocolo_w	= 0) then
        ie_permite_w	:= 'S';
    end if;

else
    ie_permite_w	:= 'S';
end if;
ie_permite_p	:= ie_permite_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE consiste_categ_protocolo_onc ( cd_protocolo_p bigint, nr_sequencia_p bigint, cd_pessoa_fisica_p text, nr_seq_loco_regional_p bigint, nm_usuario_p text, ie_permite_p INOUT text) FROM PUBLIC;

