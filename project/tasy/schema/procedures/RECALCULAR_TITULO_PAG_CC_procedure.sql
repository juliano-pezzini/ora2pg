-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE recalcular_titulo_pag_cc (nr_titulo_p bigint, nr_seq_baixa_p bigint, nm_usuario_p text) AS $body$
DECLARE

 
cd_estabelecimento_w	bigint;
nr_seq_baixa_w		integer;
nr_titulo_contab_w	bigint;
nr_lote_contabilizado_w	titulo_pagar_baixa.nr_lote_contabil%TYPE;

 
C01 CURSOR FOR 
SELECT	nr_sequencia 
FROM	titulo_pagar_baixa 
WHERE	nr_titulo = nr_titulo_p 
AND (coalesce(nr_seq_baixa_p,0) = 0 OR nr_sequencia = nr_seq_baixa_p);

 

BEGIN 
 
 
SELECT	cd_estabelecimento 
INTO STRICT	cd_estabelecimento_w 
FROM	titulo_pagar 
WHERE	nr_titulo	= nr_titulo_p;
 
OPEN C01;
LOOP 
FETCH C01 INTO 
	nr_seq_baixa_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	BEGIN 
 
	DELETE	FROM titulo_pagar_baixa_cc 
	WHERE	nr_titulo	= nr_titulo_p 
	AND	nr_seq_baixa	= nr_seq_baixa_w;
 
	SELECT	MAX(a.nr_lote_contabil) 
	INTO STRICT	nr_lote_contabilizado_w 
	FROM	titulo_pagar_baixa a 
	WHERE	a.nr_titulo	= nr_titulo_p 
	AND	a.nr_sequencia	= nr_seq_baixa_w 
	AND	a.nr_lote_contabil <> 0;
 
	IF (coalesce(nr_lote_contabilizado_w::text, '') = '') THEN 
	/*Somente recalcular se a baixa do titulo nao estiver contabilizada. Isso ja consite na rotina consiste_recalc_classif_tit_cp, que chama no delphi antes dessa 
	mas tive que colocar aqui tambem pois na gerar_titulo_pagar_baixa_cc nao consite, e deveria ter essa consitencia la. */
 
		CALL gerar_titulo_pagar_baixa_cc(nr_titulo_p, nr_seq_baixa_w,'S',nm_usuario_p);
	ELSIF (nr_lote_contabilizado_w <> 0) THEN 
 
		insert into w_recalc_tit_pag_cc( 
					NR_SEQUENCIA, 
					NR_TITULO, 
					NR_SEQ_BAIXA, 
					DT_ATUALIZACAO, 
					NM_USUARIO, 
					DT_ATUALIZACAO_NREC, 
					NM_USUARIO_NREC ) 
					values ( 
					nextval('w_recalc_tit_pag_cc_seq'), 
					nr_titulo_p, 
					nr_seq_baixa_w, 
					clock_timestamp(), 
					nm_usuario_p, 
					clock_timestamp(), 
					nm_usuario_p);
					 
	 
					 
	END IF;
 
	END;
END LOOP;
CLOSE C01;
 
 
 
COMMIT;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE recalcular_titulo_pag_cc (nr_titulo_p bigint, nr_seq_baixa_p bigint, nm_usuario_p text) FROM PUBLIC;

