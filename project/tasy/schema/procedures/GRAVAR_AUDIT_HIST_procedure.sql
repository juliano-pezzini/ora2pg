-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gravar_audit_hist ( ie_tipo_item_p text, nr_seq_audit_proc_p bigint, nr_seq_audit_mat_p bigint, vl_item_p bigint, nr_conta_origem_p bigint, nr_seq_audit_origem_p bigint, nm_usuario_p text) AS $body$
DECLARE

 
ie_Gerar_Pendencia_w		varchar(1);	
cd_estabelecimento_w		smallint;	
nr_seq_auditoria_w		bigint;		
nr_seq_pend_w			bigint;
nr_atendimento_w		bigint;
qt_reg_hist_w			bigint;
nr_interno_conta_w		bigint;
				

BEGIN 
 
insert into audit_hist_transferencia(nr_sequencia, 
		dt_atualizacao, 
		nm_usuario, 
		dt_atualizacao_nrec, 
		nm_usuario_nrec, 
		ie_tipo_item, 
		nr_seq_audit_mat, 
		nr_seq_audit_proc, 
		vl_item, 
		nr_conta_origem, 
		nr_seq_audit_origem) 
	values (nextval('audit_hist_transferencia_seq'), 
		clock_timestamp(), 
		nm_usuario_p, 
		clock_timestamp(), 
		nm_usuario_p, 
		ie_tipo_item_p, 
		nr_seq_audit_mat_p, 
		nr_seq_audit_proc_p, 
		vl_item_p, 
		nr_conta_origem_p, 
		nr_seq_audit_origem_p);
		 
 
nr_seq_auditoria_w:= 0;
		 
if (ie_tipo_item_p = 'M') then 
	select 	coalesce(max(nr_seq_auditoria),0) 
	into STRICT	nr_seq_auditoria_w 
	from 	auditoria_matpaci 
	where 	nr_sequencia = nr_seq_audit_mat_p;
elsif (ie_tipo_item_p = 'P') then 
	select 	coalesce(max(nr_seq_auditoria),0) 
	into STRICT	nr_seq_auditoria_w 
	from 	auditoria_propaci 
	where 	nr_sequencia = nr_seq_audit_proc_p;
end if;
 
select 	max(cd_estabelecimento), 
	max(nr_atendimento) 
into STRICT	cd_estabelecimento_w, 
	nr_atendimento_w 
from 	conta_paciente 
where 	nr_interno_conta = nr_conta_origem_p;
 
ie_Gerar_Pendencia_w 	:= coalesce(obter_valor_param_usuario(1116, 136, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w),'N');
 
if (ie_Gerar_Pendencia_w = 'V') and (nr_seq_auditoria_w > 0) then 
	 
	update	auditoria_conta_paciente 
	set	vl_auditoria_orig = Obter_valor_Orig_Audit(nr_sequencia) 
	where	nr_sequencia = nr_seq_auditoria_w;
	 
	select 	coalesce(max(nr_sequencia),0), 
		coalesce(max(nr_interno_conta),0) 
	into STRICT	nr_seq_pend_w, 
		nr_interno_conta_w 
	from 	cta_pendencia 
	where 	nr_seq_auditoria = nr_seq_auditoria_w 
	and 	nr_atendimento = nr_atendimento_w;
	 
	select 	count(*) 
	into STRICT	qt_reg_hist_w 
	from 	cta_pendencia_hist 
	where 	nr_seq_pend = nr_seq_pend_w;
	 
	if (nr_seq_pend_w > 0) and (qt_reg_hist_w = 1) then 
		 
		update	cta_pendencia_hist 
		set 	vl_auditoria	 = coalesce(Obter_valor_Orig_Audit(nr_seq_auditoria_w),0), 
			vl_conta_estagio = coalesce(obter_valor_conta(nr_interno_conta_w,0),0) 
		where	nr_seq_pend = nr_seq_pend_w;
		 
	end if;
	 
end if;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gravar_audit_hist ( ie_tipo_item_p text, nr_seq_audit_proc_p bigint, nr_seq_audit_mat_p bigint, vl_item_p bigint, nr_conta_origem_p bigint, nr_seq_audit_origem_p bigint, nm_usuario_p text) FROM PUBLIC;

