-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE oft_obter_diag_doenca ( nr_seq_consulta_p bigint, nr_seq_consulta_form_p bigint, cd_pessoa_fisica_p text, ie_opcao_p text, vListaDiagDoenca INOUT strRecTypeFormOft) AS $body$
DECLARE



cd_doenca_w						diagnostico_doenca.cd_doenca%TYPE;
ds_diagnostico_w				diagnostico_doenca.ds_diagnostico%TYPE;
dt_fim_w							diagnostico_doenca.dt_fim%TYPE;
dt_inicio_w						diagnostico_doenca.dt_inicio%TYPE;
dt_manifestacao_w				diagnostico_doenca.dt_manifestacao%TYPE;
ie_classificacao_doenca_w	diagnostico_doenca.ie_classificacao_doenca%TYPE;
ie_lado_w						diagnostico_doenca.ie_lado%TYPE;
ie_tipo_diagnostico_w		diagnostico_doenca.ie_tipo_diagnostico%TYPE;
ie_tipo_doenca_w				diagnostico_doenca.ie_tipo_doenca%TYPE;
ie_unidade_tempo_w			diagnostico_doenca.ie_unidade_tempo%TYPE;
nr_seq_etiologia_w			diagnostico_doenca.nr_seq_etiologia%TYPE;
qt_tempo_w						diagnostico_doenca.qt_tempo%TYPE;
nr_atendimento_w				diagnostico_doenca.nr_atendimento%TYPE;
dt_diagnostico_w 				diagnostico_doenca.dt_diagnostico%TYPE;
ie_tipo_atendimento_w		diagnostico_doenca.ie_tipo_atendimento%TYPE;
nr_seq_interno_w				diagnostico_doenca.nr_seq_interno%TYPE;
dt_liberacao_w					diagnostico_doenca.dt_liberacao%TYPE;
cd_medico_w						diagnostico_doenca.cd_medico%TYPE;
nm_usuario_w					usuario.nm_usuario%TYPE := wheb_usuario_pck.get_nm_usuario;
ds_erro_w						varchar(4000);

diagnostico_form CURSOR FOR
	SELECT	a.*
	FROM		diagnostico_doenca a,
				oft_consulta_formulario b,
				oft_consulta c
	WHERE		a.nr_seq_consulta_form 	=	b.nr_sequencia
	AND		a.nr_seq_consulta_form 	=	nr_seq_consulta_form_p
	AND		a.nr_atendimento			=	c.nr_atendimento
	AND		c.nr_sequencia				=	nr_seq_consulta_p
	AND		((a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '') OR (a.nm_usuario = nm_usuario_w))
	AND		((coalesce(a.dt_inativacao::text, '') = '') OR (b.dt_inativacao IS NOT NULL AND b.dt_inativacao::text <> ''))
	ORDER BY a.dt_diagnostico;

diagnostico_paciente CURSOR FOR
	SELECT	a.*
	FROM		diagnostico_doenca a,
				oft_consulta c
	WHERE		a.nr_seq_consulta_form 	=	nr_seq_consulta_form_p
	AND		a.nr_atendimento			=	c.nr_atendimento
	AND		c.cd_pessoa_fisica		=	cd_pessoa_fisica_p
	and		(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
	and		coalesce(a.dt_inativacao::text, '') = ''
	and		c.nr_sequencia 		<> nr_seq_consulta_p
	ORDER BY a.dt_diagnostico;



BEGIN
begin

IF (coalesce(nr_seq_consulta_p,0) > 0) AND (vListaDiagDoenca.COUNT > 0) THEN
	if (ie_opcao_p = 'F') then
		FOR c_diagnostico IN diagnostico_form LOOP
			BEGIN
			cd_medico_w							:=	c_diagnostico.cd_medico;
			cd_doenca_w							:=	c_diagnostico.cd_doenca;
			ds_diagnostico_w					:=	c_diagnostico.ds_diagnostico;
			dt_fim_w								:=	c_diagnostico.dt_fim;
			dt_inicio_w							:=	c_diagnostico.dt_inicio;
			dt_manifestacao_w					:=	c_diagnostico.dt_manifestacao;
			ie_classificacao_doenca_w		:=	c_diagnostico.ie_classificacao_doenca;
			ie_lado_w							:=	c_diagnostico.ie_lado;
			ie_tipo_diagnostico_w			:=	c_diagnostico.ie_tipo_diagnostico;
			ie_tipo_doenca_w					:=	c_diagnostico.ie_tipo_doenca;
			ie_unidade_tempo_w				:=	c_diagnostico.ie_unidade_tempo;
			nr_seq_etiologia_w				:=	c_diagnostico.nr_seq_etiologia;
			qt_tempo_w							:=	c_diagnostico.qt_tempo;
			dt_diagnostico_w 					:=	c_diagnostico.dt_diagnostico;
			ie_tipo_atendimento_w			:=	c_diagnostico.ie_tipo_atendimento;
			dt_liberacao_w						:=	c_diagnostico.dt_liberacao;
			END;
		END LOOP;
	else
		FOR c_diagnostico IN diagnostico_paciente LOOP
			BEGIN
			cd_doenca_w						:=	c_diagnostico.cd_doenca;
			ds_diagnostico_w				:=	c_diagnostico.ds_diagnostico;
			dt_fim_w							:=	c_diagnostico.dt_fim;
			dt_inicio_w						:=	c_diagnostico.dt_inicio;
			dt_manifestacao_w				:=	c_diagnostico.dt_manifestacao;
			ie_classificacao_doenca_w	:=	c_diagnostico.ie_classificacao_doenca;
			ie_lado_w						:=	c_diagnostico.ie_lado;
			ie_tipo_diagnostico_w		:=	c_diagnostico.ie_tipo_diagnostico;
			ie_tipo_doenca_w				:=	c_diagnostico.ie_tipo_doenca;
			ie_unidade_tempo_w			:=	c_diagnostico.ie_unidade_tempo;
			nr_seq_etiologia_w			:=	c_diagnostico.nr_seq_etiologia;
			qt_tempo_w						:=	c_diagnostico.qt_tempo;
			ie_tipo_atendimento_w		:=	c_diagnostico.ie_tipo_atendimento;
			cd_medico_w						:=	obter_pf_usuario(nm_usuario_w,'C');
			END;
		END LOOP;
	end if;

	FOR i IN 1..vListaDiagDoenca.COUNT LOOP
		BEGIN
		if (ie_opcao_p = 'F') or (vListaDiagDoenca[i].ie_obter_resultado = 'S') then
			vListaDiagDoenca[i].dt_liberacao	:= dt_liberacao_w;
			CASE UPPER(vListaDiagDoenca[i].nm_campo)
				WHEN 'CD_MEDICO' THEN
					vListaDiagDoenca[i].ds_valor	:= cd_medico_w;
				WHEN 'CD_DOENCA' THEN
					vListaDiagDoenca[i].ds_valor	:= CD_DOENCA_w;
				WHEN 'DS_DIAGNOSTICO' THEN
					vListaDiagDoenca[i].ds_valor	:= DS_DIAGNOSTICO_w;
				WHEN 'DT_FIM' THEN
					vListaDiagDoenca[i].dt_valor	:=	DT_FIM_w;
				WHEN 'DT_INICIO' THEN
					vListaDiagDoenca[i].dt_valor	:=	DT_INICIO_w;
				WHEN 'DT_MANIFESTACAO' THEN
					vListaDiagDoenca[i].dt_valor	:=	DT_MANIFESTACAO_w;
				WHEN 'IE_CLASSIFICACAO_DOENCA' THEN
					vListaDiagDoenca[i].ds_valor	:= IE_CLASSIFICACAO_DOENCA_w;
				WHEN 'IE_LADO' THEN
					vListaDiagDoenca[i].ds_valor	:=	IE_LADO_w;
				WHEN 'IE_TIPO_DIAGNOSTICO' THEN
					vListaDiagDoenca[i].nr_valor	:=	IE_TIPO_DIAGNOSTICO_w;
				WHEN 'IE_TIPO_DOENCA' THEN
					vListaDiagDoenca[i].ds_valor	:=	IE_TIPO_DOENCA_w;
				WHEN 'IE_UNIDADE_TEMPO' THEN
					vListaDiagDoenca[i].ds_valor	:=	IE_UNIDADE_TEMPO_w;
				WHEN 'NR_SEQ_ETIOLOGIA' THEN
					vListaDiagDoenca[i].nr_valor	:=	NR_SEQ_ETIOLOGIA_w;
				WHEN 'QT_TEMPO' THEN
					vListaDiagDoenca[i].nr_valor	:=	QT_TEMPO_w;
				ELSE
					null;
			END CASE;
		end if;
		END;
		END LOOP;
END IF;

exception
when others then
	ds_erro_w	:= substr(sqlerrm,1,4000);
end;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE oft_obter_diag_doenca ( nr_seq_consulta_p bigint, nr_seq_consulta_form_p bigint, cd_pessoa_fisica_p text, ie_opcao_p text, vListaDiagDoenca INOUT strRecTypeFormOft) FROM PUBLIC;

