-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE obter_dados_ativ_continuo ( nr_seq_graf_atual_p bigint, dt_value_x_p text, ie_agente_gas_p INOUT text, ie_modo_registro_p INOUT text, ds_agente_p INOUT text, ds_dosagem_p INOUT text, ie_fim_administracao_p INOUT text, nr_seq_agente_p INOUT bigint, ie_disp_infusao_p INOUT text, qt_agente_anest_ocor_p INOUT bigint, qt_velocidade_inf_p INOUT bigint, qt_halog_ins_p INOUT bigint, qt_dose_total_p INOUT bigint, dt_inicio_p INOUT text, dt_inicio_continuo_date_p INOUT timestamp, ie_npt_p INOUT text, dt_value_x_date_p timestamp default null) AS $body$
DECLARE


ie_agente_gas_w		varchar(5);
ie_modo_registro_w	varchar(1);
ds_agente_w		varchar(60);
ds_dosagem_w		varchar(255);
ie_fim_administracao_w	varchar(1);
nr_seq_agente_w		bigint;
ie_disp_infusao_w	varchar(1);
qt_agente_anest_ocor_w	bigint;
qt_velocidade_inf_w	double precision;
qt_halog_ins_w		double precision;
qt_dose_total_w		double precision;
dt_inicio_w		timestamp;
dt_value_w		timestamp;
ie_terapia_atual_w cirurgia_agente_anestesico.ie_terapia_atual%type;
cd_material_w cirurgia_agente_anestesico.cd_material%type;
nr_seq_diet_cpoe_w cirurgia_agente_anestesico.nr_seq_diet_cpoe%type;


BEGIN
if (dt_value_x_date_p IS NOT NULL AND dt_value_x_date_p::text <> '') then
	dt_value_w	:= dt_value_x_date_p;
else
	dt_value_w	:= to_date(dt_value_X_p, 'dd/mm/yyyy hh24:mi:ss');
end if;

select	obter_se_agente_gas(nr_seq_agente) ie_agente_gas,
	obter_modo_registro_agente(nr_sequencia) ie_modo_registro,
	obter_desc_agente(nr_seq_agente) ds_agente,
	obter_desc_dosagem_agente(nr_sequencia,1) ds_dosagem,
	obter_se_fim_administracao(nr_sequencia) ie_fim_administracao,
	nr_seq_agente,
	ie_disp_infusao,
  ie_terapia_atual,
  cd_material,
  nr_seq_diet_cpoe
into STRICT	ie_agente_gas_w,
	ie_modo_registro_w,
	ds_agente_w,
	ds_dosagem_w,
	ie_fim_administracao_w,
	nr_seq_agente_w,
	ie_disp_infusao_w,
  ie_terapia_atual_w, 
  cd_material_w, 
  nr_seq_diet_cpoe_w
from	cirurgia_agente_anestesico
where	nr_sequencia = nr_seq_graf_atual_p
and	coalesce(ie_situacao,'A') = 'A';

if (ie_terapia_atual_w = 'S' and coalesce(cd_material_w::text, '') = '' and (nr_seq_diet_cpoe_w IS NOT NULL AND nr_seq_diet_cpoe_w::text <> '')) then
    ie_npt_p := 'S';
else
    ie_npt_p := 'N';
end if;

if (coalesce(ie_disp_infusao_w::text, '') = '') then
	begin
	select	max(ie_disp_infusao)
	into STRICT	ie_disp_infusao_w
	from	agente_anestesico
	where	nr_sequencia = nr_seq_agente_w;
	end;
end if;

select	count(*)
into STRICT	qt_agente_anest_ocor_w
from	cirurgia_agente_anest_ocor
where	nr_seq_cirur_agente = nr_seq_graf_atual_p
and	coalesce(ie_situacao,'A') = 'A';

if (ie_fim_administracao_w = 'S') then
	begin
	select	max(qt_velocidade_inf) qt_velocidade_inf,
		max(qt_halog_ins) qt_halog_ins,
		max(qt_dose_total) qt_dose_total
	into STRICT	qt_velocidade_inf_w,
		qt_halog_ins_w,
		qt_dose_total_w
	from	cirurgia_agente_anest_ocor
	where	coalesce(dt_final_adm::text, '') = ''
	and	coalesce(ie_situacao,'A') = 'A'
	and	nr_seq_cirur_agente = nr_seq_graf_atual_p;
	end;
end if;

select   coalesce(max(dt_inicio_adm), dt_value_w) dt_inicio
into STRICT	dt_inicio_w
from	cirurgia_agente_anest_ocor
where	nr_seq_cirur_agente = nr_seq_graf_atual_p
and	coalesce(ie_situacao,'A') = 'A';

ie_agente_gas_p		:= ie_agente_gas_w;
ie_modo_registro_p	:= ie_modo_registro_w;
ds_agente_p		:= ds_agente_w;
ds_dosagem_p		:= ds_dosagem_w;
ie_fim_administracao_p	:= ie_fim_administracao_w;
nr_seq_agente_p		:= nr_seq_agente_w;
ie_disp_infusao_p	:= ie_disp_infusao_w;
qt_agente_anest_ocor_p	:= qt_agente_anest_ocor_w;
qt_velocidade_inf_p	:= qt_velocidade_inf_w;
qt_halog_ins_p		:= qt_halog_ins_w;
qt_dose_total_p		:= qt_dose_total_w;

if (coalesce(dt_value_x_date_p::text, '') = '') then
   dt_inicio_p	:= to_char(dt_inicio_w,'dd/mm/yyyy hh24:mi:ss');
end if;

dt_inicio_continuo_date_p:= dt_inicio_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE obter_dados_ativ_continuo ( nr_seq_graf_atual_p bigint, dt_value_x_p text, ie_agente_gas_p INOUT text, ie_modo_registro_p INOUT text, ds_agente_p INOUT text, ds_dosagem_p INOUT text, ie_fim_administracao_p INOUT text, nr_seq_agente_p INOUT bigint, ie_disp_infusao_p INOUT text, qt_agente_anest_ocor_p INOUT bigint, qt_velocidade_inf_p INOUT bigint, qt_halog_ins_p INOUT bigint, qt_dose_total_p INOUT bigint, dt_inicio_p INOUT text, dt_inicio_continuo_date_p INOUT timestamp, ie_npt_p INOUT text, dt_value_x_date_p timestamp default null) FROM PUBLIC;

