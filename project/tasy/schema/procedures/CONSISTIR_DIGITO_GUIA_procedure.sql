-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE consistir_digito_guia ( cd_convenio_p bigint, nr_guia_p text, nr_atendimento_p bigint, ds_consistencia_p INOUT text) AS $body$
DECLARE

 
ds_rotina_digito_guia_w	varchar(50);
ie_tipo_atendimento_w	smallint;

cd_codigo_w		varchar(255);
peso_string_w		varchar(255);
x		varchar(255);
y		varchar(255);
cd_digito_w		smallint;
i			bigint;
soma			bigint;
tamanho		 	bigint;
aux_tam_w	 	bigint;


BEGIN 
ds_consistencia_p	:= 'S';
select	max(ds_rotina_digito_guia) 
into STRICT	ds_rotina_digito_guia_w 
from	convenio 
where	cd_convenio		= cd_convenio_p;
 
select	max(ie_tipo_atendimento) 
into STRICT	ie_tipo_atendimento_w 
from	atendimento_paciente 
where	nr_atendimento = nr_atendimento_p;
 
if (ds_rotina_digito_guia_w IS NOT NULL AND ds_rotina_digito_guia_w::text <> '') and (ie_tipo_atendimento_w <> 1) then 
	if (upper(ds_rotina_digito_guia_w) = 'ASSIM') then 
		if (consiste_digito_guia(nr_guia_p)) then 
			ds_consistencia_p	:= 'S';
		else 
			ds_consistencia_p	:= 'N';
		end if;
	elsif (upper(ds_rotina_digito_guia_w) = 'M11_BH') then 
		begin 
		tamanho			:= length(nr_guia_p) - 1;
		peso_string_w	:= '987654329876543298765432';
		aux_tam_w		:= length('987654329876543298765432');
		soma	:= 0;
		FOR i IN REVERSE aux_tam_w..1 loop 
			x := x || substr(peso_string_w,i,1);
			if (length(x) = tamanho) then 
				exit;
			end if;
		end loop;
 
		FOR i IN REVERSE length(x)..1 loop 
			y := y || substr(x,i,1);
		end loop;
 
		for i in 1..tamanho loop 
			soma := soma + ((substr(nr_guia_p,i,1))::numeric  * 
				  (substr(y,i,1))::numeric );
		end loop;
		cd_digito_w := 11 - (soma mod 11);
		if (cd_digito_w > 9) then 
	   		cd_digito_w	:= 0;
		end if;
		if (cd_digito_w = substr(nr_guia_p, length(nr_guia_p),1))	then 
			ds_consistencia_p := 'S';	
		else 
			ds_consistencia_p := 'N';
		end if;
		end;
	end if;
end if;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE consistir_digito_guia ( cd_convenio_p bigint, nr_guia_p text, nr_atendimento_p bigint, ds_consistencia_p INOUT text) FROM PUBLIC;

