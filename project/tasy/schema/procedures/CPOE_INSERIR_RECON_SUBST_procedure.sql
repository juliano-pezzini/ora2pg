-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE cpoe_inserir_recon_subst ( nr_prescricao_p bigint, nr_sequencia_p bigint ) AS $body$
DECLARE


cd_material_w				prescr_material.cd_material%type;
cd_unidade_medida_dose_w	prescr_material.cd_unidade_medida_dose%type;
qt_dose_w					prescr_material.qt_dose%type;			
ds_diluicao_edit_w			prescr_material.ds_diluicao_edit%type;		
nr_seq_mat_cpoe_w			prescr_material.nr_seq_mat_cpoe%type;
nr_seq_pai_w				prescr_material.nr_sequencia_diluicao%type;
qt_solucao_w				prescr_material.qt_solucao%type;
							

BEGIN

select	max(cd_material),
		max(cd_unidade_medida_dose),
		max(qt_dose),
		max(ds_diluicao_edit),
		max(nr_seq_mat_cpoe),
		max(nr_sequencia_diluicao),
		max(qt_solucao)
into STRICT	cd_material_w,
		cd_unidade_medida_dose_w,
		qt_dose_w,
		ds_diluicao_edit_w,
		nr_seq_mat_cpoe_w,
		nr_seq_pai_w,
		qt_solucao_w
from	prescr_material
where	nr_prescricao 	= nr_prescricao_p
and		nr_sequencia 	= nr_sequencia_p;

if (cd_material_w IS NOT NULL AND cd_material_w::text <> '') then

	/* Atualizar reg. do reconstituinte */

	update	cpoe_material
	set		cd_mat_recons 				= cd_material_w,
			cd_unid_med_dose_recons 	= cd_unidade_medida_dose_w,
			qt_dose_recons				= qt_dose_w,
			ds_orientacao_preparo		= CASE WHEN ds_diluicao_edit_w = NULL THEN  substr(Obter_Diluicao_Medic(nr_seq_pai_w, nr_prescricao_p),1,2000)  ELSE ds_diluicao_edit_w END ,
			dt_atualizacao				= clock_timestamp()
	where	nr_sequencia 				= nr_seq_mat_cpoe_w;

	commit;

end if;	
	
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cpoe_inserir_recon_subst ( nr_prescricao_p bigint, nr_sequencia_p bigint ) FROM PUBLIC;

