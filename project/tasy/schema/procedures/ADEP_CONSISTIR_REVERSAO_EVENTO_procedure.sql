-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE adep_consistir_reversao_evento ( ie_tipo_item_p text, nr_seq_horario_p bigint, qt_tempo_rev_p bigint) AS $body$
DECLARE

ie_ok_w		varchar(1) := 'S';
dt_evento_w	timestamp;
dt_ref_rev_w	timestamp;

BEGIN
if (nr_seq_horario_p IS NOT NULL AND nr_seq_horario_p::text <> '') and (ie_tipo_item_p IS NOT NULL AND ie_tipo_item_p::text <> '') and (coalesce(qt_tempo_rev_p,0) > 0) then
	dt_ref_rev_w	:= (clock_timestamp() - qt_tempo_rev_p/1440);
/*	if	(ie_tipo_item_p in ('D','DE')) then

		Select	max(dt_alteracao)
		into	dt_evento_w
		from	prescr_mat_alteracao
		where	nr_seq_horario_dieta = nr_seq_horario_p
		and 	ie_alteracao not in (4,6);
		
		if	(dt_evento_w < dt_ref_rev_w) then
			ie_ok_w := 'N';
		end if;
		
	els*/
	if (ie_tipo_item_p in ('M'/*,'S'*/,'LD', 'IAH')) then
		
		Select	max(dt_alteracao)
		into STRICT	dt_evento_w
		from	prescr_mat_alteracao
		where	nr_seq_horario = nr_seq_horario_p
		and 	ie_alteracao not in (4,6);
		
		if (dt_evento_w < dt_ref_rev_w) then
			ie_ok_w := 'N';
		end if;
		
	elsif (ie_tipo_item_p in (/*'P',*/
'G','C')) then

		Select	max(dt_alteracao)
		into STRICT	dt_evento_w
		from	prescr_mat_alteracao
		where	nr_seq_horario_proc = nr_seq_horario_p
		and 	ie_alteracao not in (4,6);
		
		if (dt_evento_w < dt_ref_rev_w) then
			ie_ok_w := 'N';
		end if;
	
	/*
	elsif	(ie_tipo_item_p = 'R') then

		Select	max(dt_alteracao)
		into	dt_evento_w
		from	prescr_mat_alteracao
		where	nr_seq_horario_rec = nr_seq_horario_p
		and 	ie_alteracao not in (4,6);
		
		if	(dt_evento_w < dt_ref_rev_w) then
			ie_ok_w := 'N';
		end if;
*/
	elsif (ie_tipo_item_p = 'E') then

		Select	max(dt_alteracao)
		into STRICT	dt_evento_w
		from	prescr_mat_alteracao
		where	nr_seq_horario_sae = nr_seq_horario_p
		and 	ie_alteracao not in (4,6);
		
		if (dt_evento_w < dt_ref_rev_w) then
			ie_ok_w := 'N';
		end if;

	end if;

	if (ie_ok_w = 'N') then
		-- O último evento foi registrado fora da margem de #@QT_MIN_REV_W#@ minuto(s). Não é possível reverter! Parâmetro[447]
		CALL Wheb_mensagem_pck.exibir_mensagem_abort( 209793 , 'QT_MIN_REV_W='||qt_tempo_rev_p);
	end if;

end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE adep_consistir_reversao_evento ( ie_tipo_item_p text, nr_seq_horario_p bigint, qt_tempo_rev_p bigint) FROM PUBLIC;

