-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE plt_suspender_item ( nr_prescricao_p bigint, nr_sequencia_p bigint, cd_motivo_p bigint, ds_motivo_p text, nm_tabela_p text, ie_gerar_evento_p text, cd_funcao_p bigint, nm_usuario_p text, cd_perfil_p bigint) AS $body$
DECLARE

 
dt_item_suspender_w		timestamp;
nr_prescricao_original_w	bigint;
nr_seq_anterior_w		bigint;
nr_atendimento_w		bigint;
cd_pessoa_fisica_w		varchar(10);
nr_prescricao_w			bigint;
nr_sequencia_w			bigint;

 
c01 REFCURSOR;


BEGIN 
 
nr_prescricao_original_w	:= PLT_obter_item_orig(nr_prescricao_p, nr_sequencia_p, upper(nm_tabela_p),'P');
nr_seq_anterior_w		:= PLT_obter_item_orig(nr_prescricao_p, nr_sequencia_p, upper(nm_tabela_p),'S');
 
select	max(dt_inicio_prescr), 
	max(nr_atendimento), 
	max(cd_pessoa_fisica) 
into STRICT	dt_item_suspender_w, 
	nr_atendimento_w, 
	cd_pessoa_fisica_w 
from	prescr_medica 
where	nr_prescricao	= nr_prescricao_p;
 
CALL suspender_item_prescricao(nr_prescricao_p,nr_sequencia_p,cd_motivo_p,ds_motivo_p,nm_tabela_p,nm_usuario_p,ie_gerar_evento_p,cd_funcao_p);
 
if (upper(nm_tabela_p) = 'PRESCR_DIETA') then 
 
	open	c01 for 
	SELECT	b.nr_prescricao, 
		b.nr_sequencia 
	from	prescr_medica a, 
		prescr_dieta b 
	where	a.nr_prescricao			= b.nr_prescricao 
	and	b.nr_prescricao_original	= nr_prescricao_original_w 
	and	b.nr_seq_anterior		= nr_seq_anterior_w 
	and	a.nr_atendimento		= nr_atendimento_w 
	and	coalesce(b.ie_suspenso, 'N')		= 'N' 
	and	coalesce(a.dt_suspensao::text, '') = '' 
	and	coalesce(b.dt_suspensao::text, '') = '' 
	and	a.dt_inicio_prescr		> dt_item_suspender_w 
	
union all
 
	SELECT	b.nr_prescricao, 
		b.nr_sequencia 
	from	prescr_medica a, 
		prescr_dieta b 
	where	a.nr_prescricao			= b.nr_prescricao 
	and	b.nr_prescricao_original	= nr_prescricao_original_w 
	and	b.nr_seq_anterior		= nr_seq_anterior_w 
	and	a.cd_pessoa_fisica		= cd_pessoa_fisica_w 
	and	coalesce(a.nr_atendimento::text, '') = '' 
	and	coalesce(nr_atendimento_w::text, '') = '' 
	and	coalesce(b.ie_suspenso, 'N')		= 'N' 
	and	coalesce(a.dt_suspensao::text, '') = '' 
	and	coalesce(b.dt_suspensao::text, '') = '' 
	and	a.dt_inicio_prescr		> dt_item_suspender_w;
 
elsif (upper(nm_tabela_p) = 'REP_JEJUM') then 
	 
	open	c01 for 
	SELECT	b.nr_prescricao, 
		b.nr_sequencia 
	from	prescr_medica a, 
		rep_jejum b 
	where	a.nr_prescricao			= b.nr_prescricao 
	and	b.nr_seq_anterior		= nr_seq_anterior_w 
	and	a.nr_atendimento		= nr_atendimento_w 
	and	coalesce(b.ie_suspenso, 'N')		= 'N' 
	and	coalesce(a.dt_suspensao::text, '') = '' 
	and	a.dt_inicio_prescr		> dt_item_suspender_w 
	
union all
 
	SELECT	b.nr_prescricao, 
		b.nr_sequencia 
	from	prescr_medica a, 
		rep_jejum b 
	where	a.nr_prescricao			= b.nr_prescricao 
	and	b.nr_seq_anterior		= nr_seq_anterior_w 
	and	a.cd_pessoa_fisica		= cd_pessoa_fisica_w 
	and	coalesce(a.nr_atendimento::text, '') = '' 
	and	coalesce(nr_atendimento_w::text, '') = '' 
	and	coalesce(b.ie_suspenso, 'N')		= 'N' 
	and	coalesce(a.dt_suspensao::text, '') = '' 
	and	a.dt_inicio_prescr		> dt_item_suspender_w;
 
elsif (upper(nm_tabela_p) = 'NUT_PAC') then 
 
	open	c01 for 
	SELECT	b.nr_prescricao, 
		b.nr_sequencia 
	from	prescr_medica a, 
		nut_pac b 
	where	a.nr_prescricao			= b.nr_prescricao 
	and	b.nr_seq_anterior		= nr_seq_anterior_w 
	and	a.nr_atendimento		= nr_atendimento_w 
	and	coalesce(b.ie_suspenso, 'N')		= 'N' 
	and	coalesce(a.dt_suspensao::text, '') = '' 
	and	coalesce(b.dt_suspensao::text, '') = ''		 
	and	a.dt_inicio_prescr		> dt_item_suspender_w 
	
union all
 
	SELECT	b.nr_prescricao, 
		b.nr_sequencia 
	from	prescr_medica a, 
		nut_pac b 
	where	a.nr_prescricao			= b.nr_prescricao 
	and	b.nr_seq_anterior		= nr_seq_anterior_w 
	and	a.cd_pessoa_fisica		= cd_pessoa_fisica_w 
	and	coalesce(a.nr_atendimento::text, '') = '' 
	and	coalesce(nr_atendimento_w::text, '') = '' 
	and	coalesce(b.ie_suspenso, 'N')		= 'N' 
	and	coalesce(a.dt_suspensao::text, '') = '' 
	and	coalesce(b.dt_suspensao::text, '') = ''	 
	and	a.dt_inicio_prescr		> dt_item_suspender_w;
 
elsif (upper(nm_tabela_p) = 'PRESCR_SOLUCAO') then 
 
	open	c01 for 
	SELECT	b.nr_prescricao, 
		b.nr_seq_solucao 
	from	prescr_medica a, 
		prescr_solucao b 
	where	a.nr_prescricao			= b.nr_prescricao 
	and	b.nr_prescricao_original	= nr_prescricao_original_w 
	and	b.nr_seq_anterior		= nr_seq_anterior_w 
	and	a.nr_atendimento		= nr_atendimento_w 
	and	coalesce(b.ie_suspenso, 'N')		= 'N' 
	and	coalesce(a.dt_suspensao::text, '') = '' 
	and	coalesce(b.dt_suspensao::text, '') = ''		 
	and	a.dt_inicio_prescr		> dt_item_suspender_w 
	
union all
 
	SELECT	b.nr_prescricao, 
		b.nr_seq_solucao 
	from	prescr_medica a, 
		prescr_solucao b 
	where	a.nr_prescricao			= b.nr_prescricao 
	and	b.nr_prescricao_original	= nr_prescricao_original_w	 
	and	b.nr_seq_anterior		= nr_seq_anterior_w 
	and	a.cd_pessoa_fisica		= cd_pessoa_fisica_w 
	and	coalesce(a.nr_atendimento::text, '') = '' 
	and	coalesce(nr_atendimento_w::text, '') = '' 
	and	coalesce(b.ie_suspenso, 'N')		= 'N' 
	and	coalesce(a.dt_suspensao::text, '') = '' 
	and	coalesce(b.dt_suspensao::text, '') = ''	 
	and	a.dt_inicio_prescr		> dt_item_suspender_w;
 
elsif (upper(nm_tabela_p) = 'PRESCR_GASOTERAPIA') then 
 
	open	c01 for 
	SELECT	b.nr_prescricao, 
		b.nr_sequencia 
	from	prescr_medica a, 
		prescr_gasoterapia b 
	where	a.nr_prescricao			= b.nr_prescricao 
	and	b.nr_seq_anterior		= nr_seq_anterior_w 
	and	a.nr_atendimento		= nr_atendimento_w 
	and	coalesce(b.ie_suspenso, 'N')		= 'N' 
	and	coalesce(a.dt_suspensao::text, '') = '' 
	and	coalesce(b.dt_suspensao::text, '') = ''		 
	and	a.dt_inicio_prescr		> dt_item_suspender_w 
	
union all
 
	SELECT	b.nr_prescricao, 
		b.nr_sequencia 
	from	prescr_medica a, 
		prescr_gasoterapia b 
	where	a.nr_prescricao			= b.nr_prescricao 
	and	b.nr_seq_anterior		= nr_seq_anterior_w 
	and	a.cd_pessoa_fisica		= cd_pessoa_fisica_w 
	and	coalesce(a.nr_atendimento::text, '') = '' 
	and	coalesce(nr_atendimento_w::text, '') = '' 
	and	coalesce(b.ie_suspenso, 'N')		= 'N' 
	and	coalesce(a.dt_suspensao::text, '') = '' 
	and	coalesce(b.dt_suspensao::text, '') = ''	 
	and	a.dt_inicio_prescr		> dt_item_suspender_w;
 
elsif (upper(nm_tabela_p) = 'PRESCR_PROCEDIMENTO') then 
 
	open	c01 for 
	SELECT	b.nr_prescricao, 
		b.nr_sequencia 
	from	prescr_medica a, 
		prescr_procedimento b 
	where	a.nr_prescricao			= b.nr_prescricao 
	and	b.nr_prescricao_original	= nr_prescricao_original_w 
	and	b.nr_seq_anterior		= nr_seq_anterior_w 
	and	a.nr_atendimento		= nr_atendimento_w 
	and	coalesce(b.ie_suspenso, 'N')		= 'N' 
	and	coalesce(a.dt_suspensao::text, '') = '' 
	and	coalesce(b.dt_suspensao::text, '') = ''		 
	and	a.dt_inicio_prescr		> dt_item_suspender_w 
	
union all
 
	SELECT	b.nr_prescricao, 
		b.nr_sequencia 
	from	prescr_medica a, 
		prescr_procedimento b 
	where	a.nr_prescricao			= b.nr_prescricao 
	and	b.nr_prescricao_original	= nr_prescricao_original_w	 
	and	b.nr_seq_anterior		= nr_seq_anterior_w 
	and	a.cd_pessoa_fisica		= cd_pessoa_fisica_w 
	and	coalesce(a.nr_atendimento::text, '') = '' 
	and	coalesce(nr_atendimento_w::text, '') = '' 
	and	coalesce(b.ie_suspenso, 'N')		= 'N' 
	and	coalesce(a.dt_suspensao::text, '') = '' 
	and	coalesce(b.dt_suspensao::text, '') = ''	 
	and	a.dt_inicio_prescr		> dt_item_suspender_w;
 
elsif (upper(nm_tabela_p) = 'PRESCR_RECOMENDACAO') then 
 
	open	c01 for 
	SELECT	b.nr_prescricao, 
		b.nr_sequencia 
	from	prescr_medica a, 
		prescr_recomendacao b 
	where	a.nr_prescricao			= b.nr_prescricao 
	and	b.nr_prescricao_original	= nr_prescricao_original_w 
	and	b.nr_seq_anterior		= nr_seq_anterior_w 
	and	a.nr_atendimento		= nr_atendimento_w 
	and	coalesce(b.ie_suspenso, 'N')		= 'N' 
	and	coalesce(a.dt_suspensao::text, '') = '' 
	and	coalesce(b.dt_suspensao::text, '') = ''		 
	and	a.dt_inicio_prescr		> dt_item_suspender_w 
	
union all
 
	SELECT	b.nr_prescricao, 
		b.nr_sequencia 
	from	prescr_medica a, 
		prescr_recomendacao b 
	where	a.nr_prescricao			= b.nr_prescricao 
	and	b.nr_prescricao_original	= nr_prescricao_original_w	 
	and	b.nr_seq_anterior		= nr_seq_anterior_w 
	and	a.cd_pessoa_fisica		= cd_pessoa_fisica_w 
	and	coalesce(a.nr_atendimento::text, '') = '' 
	and	coalesce(nr_atendimento_w::text, '') = '' 
	and	coalesce(b.ie_suspenso, 'N')		= 'N' 
	and	coalesce(a.dt_suspensao::text, '') = '' 
	and	coalesce(b.dt_suspensao::text, '') = ''	 
	and	a.dt_inicio_prescr		> dt_item_suspender_w;
 
elsif (upper(nm_tabela_p) = 'PRESCR_MATERIAL') then 
 
	open	c01 for 
	SELECT	b.nr_prescricao, 
		b.nr_sequencia 
	from	prescr_medica a, 
		prescr_material b 
	where	a.nr_prescricao			= b.nr_prescricao 
	and	b.nr_prescricao_original	= nr_prescricao_original_w 
	and	b.nr_seq_anterior		= nr_seq_anterior_w 
	and	a.nr_atendimento		= nr_atendimento_w 
	and	coalesce(b.ie_suspenso, 'N')		= 'N' 
	and	coalesce(a.dt_suspensao::text, '') = '' 
	and	coalesce(b.dt_suspensao::text, '') = ''		 
	and	a.dt_inicio_prescr		> dt_item_suspender_w 
	
union all
 
	SELECT	b.nr_prescricao, 
		b.nr_sequencia 
	from	prescr_medica a, 
		prescr_material b 
	where	a.nr_prescricao			= b.nr_prescricao 
	and	b.nr_prescricao_original	= nr_prescricao_original_w	 
	and	b.nr_seq_anterior		= nr_seq_anterior_w 
	and	a.cd_pessoa_fisica		= cd_pessoa_fisica_w 
	and	coalesce(a.nr_atendimento::text, '') = '' 
	and	coalesce(nr_atendimento_w::text, '') = '' 
	and	coalesce(b.ie_suspenso, 'N')		= 'N' 
	and	coalesce(a.dt_suspensao::text, '') = '' 
	and	coalesce(b.dt_suspensao::text, '') = ''	 
	and	a.dt_inicio_prescr		> dt_item_suspender_w;
 
end if;
 
loop 
fetch C01 into	 
	nr_prescricao_w, 
	nr_sequencia_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin 
	CALL suspender_item_prescricao(nr_prescricao_w,nr_sequencia_w,cd_motivo_p, obter_desc_expressao(781901,nr_prescricao_p)/*'Conforme suspensão na prescrição '*/
,nm_tabela_p,nm_usuario_p,ie_gerar_evento_p,cd_funcao_p);
	end;
end loop;
close C01;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE plt_suspender_item ( nr_prescricao_p bigint, nr_sequencia_p bigint, cd_motivo_p bigint, ds_motivo_p text, nm_tabela_p text, ie_gerar_evento_p text, cd_funcao_p bigint, nm_usuario_p text, cd_perfil_p bigint) FROM PUBLIC;

