-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE tiss_gerar_conta_proc ( nr_interno_conta_p bigint, nr_seq_med_fatur_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text, nr_atend_med_p bigint, nr_seq_prot_med_p bigint) AS $body$
DECLARE


tx_ajuste_w			double precision;
tx_medico_w			double precision;
cd_convenio_w			bigint;
ie_tiss_tipo_guia_w		varchar(255);
ie_tiss_tipo_guia_partic_w	varchar(255);
nr_seq_proc_w			bigint;
dt_procedimento_w		timestamp;
cd_procedimento_w		varchar(255);
cd_procedimento_tuss_w		varchar(255);
ie_proc_tuss_w			varchar(255);
ie_origem_proced_w		bigint;
qt_procedimento_w		double precision;
vl_proced_regra_w		double precision;
vl_procedimento_w		double precision;
nr_cirurgia_w			bigint;
cont_w				bigint;
nr_seq_exame_w			bigint;
cd_autorizacao_w		varchar(255);
ds_prestador_tiss_w		varchar(255);
ie_via_acesso_w			varchar(255);
cd_proc_conv_w			varchar(255);
cd_medico_executor_w		varchar(255);
cd_medico_executor_solic_w	varchar(255);
cd_funcionario_w		varchar(255);
cd_medico_convenio_w		varchar(255);
cd_cgc_prestador_w		varchar(255);
cd_cgc_prest_solic_tiss_w	varchar(255);
cd_medico_conveniado_w		varchar(255);
cd_medico_atend_w		varchar(255);
cd_cbo_exec_w			varchar(255);
cd_cgc_prestador_proc_w		varchar(255);
ie_enviar_partic_w		varchar(255);
nr_cpf_partic_w			varchar(255);
ds_versao_w			varchar(255);
ie_partic_spsadt_w		varchar(255);
ie_honor_zerado_w		varchar(255);
ie_participante_ri_w		varchar(255);
ie_reducao_acresc_w		varchar(255);
ie_envio_w			varchar(255);
ie_exec_ri_w			varchar(255);
ie_especialidade_exec_w		varchar(255);
cd_prestador_tiss_w		varchar(255);
cd_medico_exec_tiss_w		varchar(255);
ie_regra_w			varchar(255);
ie_beneficiario_med_w		varchar(255);
sg_conselho_regra_w		varchar(255);
cd_funcionario_partic_w		varchar(255);
ie_regra_valor_w		varchar(255);
nr_conselho_w			varchar(255);
uf_conselho_w			varchar(255);
ie_partic_conveniado_w		varchar(255);
ie_formato_red_acres_w		varchar(255);
ie_tipo_atend_tiss_w		varchar(255);
ie_tipo_atend_tiss_conta_w	varchar(255);
ie_agrup_resp_cred_w		varchar(255);
cd_edicao_amb_w			varchar(255);
cd_edicao_w			varchar(255);
tx_hora_extra_w			double precision;
tx_desconto_w			double precision;
tx_procedimento_w		double precision;
ds_procedimento_w		varchar(255);
dt_inicio_cir_w				timestamp;
dt_fim_cir_w				timestamp;
vl_partic_w			double precision;
vl_unitario_w			double precision;
vl_original_w			double precision;
nr_seq_ajuste_proc_w		bigint;
ie_funcao_medico_tasy_w		varchar(255);
ie_funcao_medico_w		varchar(255);
ie_func_medico_w		varchar(255);
nr_seq_conselho_w		bigint;
nm_medico_executor_w		varchar(255);
sg_conselho_w			varchar(255);
uf_crm_w			varchar(255);
nr_crm_w			varchar(255);
cd_cbo_saude_w			varchar(255);
nr_cpf_w				varchar(255);
vl_participante_w			double precision;
nr_seq_tiss_tabela_w		bigint;
nr_atendimento_w			bigint;
nr_atendimento_med_w		bigint;
cd_setor_entrada_w		bigint;
cd_setor_exec_proc_w		bigint;
cd_setor_entrada_pac_w		bigint;
nr_seq_partic_adic_w		bigint;
cd_cgc_estab_w			varchar(255);
cd_estabelecimento_w		bigint;
nr_seq_conta_proc_w		bigint;
cd_cgc_prestador_partic_w		varchar(255);
ie_funcao_medico_partic_w		varchar(255);
ie_exec_spsadt_w			varchar(255);
cd_medico_exec_proc_w		varchar(255);
ie_tecnica_utilizada_w		varchar(255);
cd_especialidade_w		bigint;
ie_tipo_atendimento_w		bigint;
cd_categoria_conv_w		varchar(255);
ie_honorario_w			varchar(255);
ie_spsadt_zerado_w		varchar(255);
ie_ri_zerado_w			varchar(255);
ie_valor_unitario_w		varchar(255);
vl_medico_w			double precision;
vl_custo_operacional_w		double precision;
vl_materiais_w			double precision;
ie_responsavel_credito_w		varchar(255);
ie_resp_credito_regra_w		varchar(255);
cd_especialidade_proc_w		bigint;
ie_funcao_medico_proc_w		varchar(255);
ie_proc_partic_w			varchar(255);
nr_seq_partic_w			bigint;
nr_seq_proc_interno_w		bigint;
cd_area_procedimento_w		bigint;
cd_especialidade_proc_exec_w	bigint;
cd_grupo_proc_w			bigint;
ie_data_proc_w			varchar(255);
ie_emitir_spsadt_zerado_w		varchar(255);
cd_senha_w			varchar(255);
ie_senha_guia_w			varchar(255);
ie_resp_credito_partic_w		varchar(255);
ie_honor_partic_w			varchar(255);
ds_proc_tiss_w			varchar(255);
ie_desc_proc_interno_w		varchar(255);
ie_valor_desconto_w		varchar(255);
ds_proc_esp_w			varchar(255);
dt_inicio_w				timestamp;
dt_fim_w					timestamp;
dt_inicio_proc_w				timestamp;
dt_fim_proc_w				timestamp;
cd_med_solic_tasymed_w		varchar(255);
cd_medico_laudo_w		varchar(255);
ie_pacote_w			varchar(255);
ie_proc_pacote_w			varchar(255);
cd_medico_solic_tiss_w		varchar(255);
CD_MEDICO_PROF_SOLIC_TISS_W	varchar(255);
nr_seq_crit_hor_w			bigint;
tx_custo_oper_qt_w		double precision;
ie_clinica_w			bigint;
ie_dt_proc_tasymed_w		varchar(255);
dt_entrada_tasymed_w		timestamp;
cd_proc_conv_regra_w		varchar(255);
ds_proc_conv_regra_w		varchar(255);
cd_func_honor_w				varchar(255);
ie_agrup_exame_w		varchar(255);
ie_forcar_agrup_w		varchar(255);
nr_seq_classif_atend_w		bigint;
ds_adicional_crm_w		varchar(255);
cd_prestador_solic_w		varchar(255);
ds_prestador_solic_w		varchar(255);
cd_medico_exec_regra_w		varchar(255);
cd_medico_honor_tiss_w		varchar(255);
cd_medico_partic_tiss_w		varchar(255);
cd_setor_atendimento_w		bigint;
nr_seq_proc_pacote_w		bigint;
ie_proc_pacote_regra_w		varchar(255);
ie_membro_exec_w		varchar(10);
ie_xml_w			varchar(5);
ie_codigo_tuss_w		varchar(2);
ie_desc_tuss_w			varchar(2);
ds_mascara_crm_w		varchar(255);
qt_digitos_crm_w		double precision;
nr_crm_mascara_w		varchar(255);
w_40ASADT_w			varchar(255);
w_41SADT_w			varchar(255);
w_40ASADTH_w			varchar(255);
w_41SADTH_w			varchar(255);
w_45ASADT_w			varchar(255);
w_45ASADTH_w			varchar(255);
ie_periodo_desp_w		varchar(255);
cd_medico_convenio_proc_w	varchar(255);
cd_medico_convenio_tiss_w	varchar(255);
ie_medico_convenio_w		varchar(2);
cd_plano_convenio_w		varchar(10);
ie_prestador_w			varchar(255);
ie_exec_compl_w			varchar(255);
cd_cgc_prest_honor_tiss_w	varchar(255);
cd_medico_convenio_partic_w	varchar(255);
ie_lado_conta_w			varchar(255);
ds_lado_proc_w			varchar(255);
ie_classif_proced_w		varchar(255);
ie_nao_honorario_sadt_w		varchar(255);
cd_medico_solic_w		varchar(10);
ie_medico_solic_atend_regra_w	varchar(255);
cd_medico_regra_solic_tiss_w	varchar(255);
ie_medico_solic_atend_w		varchar(255);
ie_gravar_log_conta_w		varchar(255);
nr_sequencia_autor_w		bigint;
crm_medico_externo_w		varchar(30);
nm_medico_externo_w		varchar(255);
ie_tipo_atend_conta_w		smallint;
ie_agrupar_honor_w		varchar(255);
ie_xml_regra_w			varchar(255) := 'S';
ds_irrelevante_w		varchar(255);
ie_regra_exec_honor_w		varchar(255) := null;
ie_contrat_exec_hi_w		varchar(255);
cd_medico_exec_proc_honor_w	varchar(10);
ds_proc_tabela_w		varchar(255);
nr_seq_interno_w		bigint;
nr_seq_regra_adic_hora_w	bigint;
ds_versao_3_w			varchar(1);
ie_setor_exec_proc_w		varchar(1);
dt_mesano_referencia_w		timestamp;
ie_item_tuss_w			varchar(1);
ds_indicacao_proc_prescr_w	varchar(255);
ie_indicacao_proc_prescr_w	varchar(1);
nr_dente_w			tiss_conta_proc.cd_dente%type;
ds_face_dente_w			tiss_conta_proc.ds_face_dente%type;
nr_guia_prestador_w		varchar(20);
nr_seq_regra_exec_honor_w	bigint;
ie_guia_operadora_w		varchar(5);
nr_guia_operadora_w		varchar(255) := null;
cd_senha_atend_w		varchar(255);
ie_funcao_regra_prest_w		funcao_medico.cd_funcao%type;
cd_regiao_boca_w    tiss_conta_proc.cd_regiao_boca%type;
ie_carater_internacao_w		tiss_conta_atend.ie_carater_internacao%type;
qt_regra_opme_w			integer := 0;
c01 CURSOR FOR
SELECT	'N' ie_honorario,
	a.ie_tiss_tipo_guia,					--  gerar guia do procedimento
	CASE WHEN a.ie_tiss_tipo_guia='5' THEN  CASE WHEN ie_participante_ri_w='S' THEN  tiss_obter_se_partic(a.nr_sequencia)  ELSE 0 END  WHEN a.ie_tiss_tipo_guia='4' THEN  CASE WHEN ie_partic_spsadt_w='S' THEN  tiss_obter_se_partic(a.nr_sequencia)  ELSE 0 END  WHEN a.ie_tiss_tipo_guia='6' THEN  CASE WHEN ie_agrupar_honor_w='N' THEN  tiss_obter_se_partic(a.nr_sequencia)  ELSE 0 END   ELSE tiss_obter_se_partic(a.nr_sequencia) END ,
	ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(tiss_obter_data_proc(a.nr_sequencia, cd_convenio_w, ie_tipo_atendimento_w, 'N', 'E')),				/*tem que ter o trunc senao nao agrupa os procedimentos!! os73828 - 08/11/2007. */
	a.cd_procedimento,
	a.ie_origem_proced,
	sum(a.qt_procedimento),
	CASE WHEN ie_valor_desconto_w='N' THEN  sum(a.vl_procedimento)  ELSE sum(a.vl_procedimento) + sum(coalesce(obter_desconto_matproc(a.nr_sequencia,'P'),0)) END ,
	a.nr_cirurgia,
	a.nr_doc_convenio,
	a.ie_via_acesso,
	a.cd_procedimento_convenio,
	a.nr_seq_tiss_tabela,
	coalesce(a.cd_cgc_prestador_tiss, a.cd_cgc_prestador),
	tiss_obter_grau_partic(a.ie_funcao_medico),
	a.cd_medico_executor,				-- gerar medico honorario se a guia for de honorario
	a.cd_especialidade,
	CASE WHEN ie_agrup_exame_w='N' THEN  a.nr_seq_exame  ELSE null END ,
	sum(a.vl_medico),
	sum(a.vl_custo_operacional),
	CASE WHEN ie_agrup_resp_cred_w='S' THEN  a.ie_responsavel_credito  ELSE null END ,
	(null)::numeric  nr_seq_partic,
	a.ie_tecnica_utilizada,
	TISS_OBTER_REGRA_SENHA(cd_estabelecimento_w,cd_convenio_w,ie_tipo_atend_tiss_conta_w,a.ie_tiss_tipo_guia,ie_senha_guia_w, a.cd_senha) cd_senha,
	a.tx_hora_extra,
	substr(tiss_eliminar_caractere(coalesce(tiss_obter_desc_proced(a.nr_sequencia, 0, CASE WHEN a.ie_tiss_tipo_guia='4' THEN  'DS_PROC_SPSADT' WHEN a.ie_tiss_tipo_guia='5' THEN  'DS_PROC_RI' END ),
					coalesce(a.ds_proc_tiss, coalesce(obter_desc_proc_convenio(a.nr_sequencia, null), obter_descricao_procedimento(a.cd_procedimento, a.ie_origem_proced))))), 1, 150),
	a.nr_seq_proc_interno,
	a.dt_inicio_procedimento,	
	tiss_obter_data_proc(a.nr_sequencia, cd_convenio_w, ie_tipo_atendimento_w, 'N', 'F'),  --elton os120472, alterado o a.dt_procedimento (dt_fim_proc_w), pois nao estava agrupando os procedimentos.
	tiss_obter_data_proc(a.nr_sequencia, cd_convenio_w, ie_tipo_atendimento_w, 'N', 'I'),
	tiss_obter_data_proc(a.nr_sequencia, cd_convenio_w, ie_tipo_atendimento_w, 'N', 'F'),
	a.tx_procedimento,
	a.cd_prestador_tiss,
	sum(a.vl_materiais),
	CASE WHEN a.ie_tiss_tipo_guia=5 THEN  null  ELSE a.cd_cgc_prest_solic_tiss END ,
	CASE WHEN a.ie_tiss_tipo_guia=5 THEN  null  ELSE a.cd_medico_solic_tiss END ,
	CASE WHEN a.ie_tiss_tipo_guia=5 THEN  null  ELSE a.cd_medico_prof_solic_tiss END ,
	a.cd_medico_exec_tiss,
	a.ds_proc_tiss,
	sum(a.vl_procedimento),
	a.cd_pessoa_fisica,
	a.cd_cgc_prestador cd_prestador_proc,
	a.ds_prestador_tiss,
	CASE WHEN ie_reducao_acresc_w='RA' THEN  a.nr_seq_ajuste_proc WHEN ie_reducao_acresc_w='TA' THEN  a.nr_seq_ajuste_proc WHEN ie_reducao_acresc_w='AC' THEN  a.nr_seq_ajuste_proc  ELSE 0 END  nr_seq_ajuste_proc,
	CASE WHEN ie_reducao_acresc_w='AC' THEN  a.nr_seq_proc_crit_hor  ELSE 0 END  nr_seq_crit_hor,
	null ie_beneficiario,
	a.cd_edicao_amb,
	a.ie_tipo_atend_tiss,
	tiss_obter_desc_proced(a.nr_sequencia, 0, CASE WHEN a.ie_tiss_tipo_guia='4' THEN  'DS_PROC_SPSADT' WHEN a.ie_tiss_tipo_guia='5' THEN  'DS_PROC_RI' END ),
	(null)::numeric  nr_seq_partic_adic,
	CASE WHEN ie_reducao_acresc_w='TD' THEN  tiss_obter_pr_desc(a.nr_sequencia)  ELSE 0 END  tx_desconto,
	coalesce(CASE WHEN ie_valor_unitario_w='O' THEN  (substr(tiss_obter_dados_proc_mat(a.nr_sequencia, null, 'UP'),1,254))::numeric   ELSE 0 END ,0) vl_original,
	a.ie_funcao_medico,
	sum(obter_valor_participante(a.nr_sequencia)),
	null cd_med_solic_tasymed,
	obter_medico_laudo_sequencia(a.nr_laudo, 'C'),
	a.cd_procedimento_tuss,
	obter_se_pacote(a.nr_sequencia, a.nr_seq_proc_pacote),
	CASE WHEN ie_reducao_acresc_w='QE' THEN  a.tx_custo_oper_qt  ELSE 0 END  tx_custo_oper_qt,
	CASE WHEN a.ie_tiss_tipo_guia=5 THEN  null  ELSE a.cd_prestador_solic_tiss END ,
	CASE WHEN a.ie_tiss_tipo_guia=5 THEN  null  ELSE a.ds_prestador_solic_tiss END ,
	a.cd_medico_honor_tiss,
	TISS_OBTER_VALOR_CAMPO_PREST(a.nr_sequencia,1),
	TISS_OBTER_VALOR_CAMPO_PREST(a.nr_sequencia,2),
	TISS_OBTER_VALOR_CAMPO_PREST(a.nr_sequencia,3),
	TISS_OBTER_VALOR_CAMPO_PREST(a.nr_sequencia,4),
	TISS_OBTER_VALOR_CAMPO_PREST(a.nr_sequencia,5),
	TISS_OBTER_VALOR_CAMPO_PREST(a.nr_sequencia,6),
	CASE WHEN ie_medico_convenio_w='S' THEN a.cd_medico_convenio  ELSE null END ,
	a.cd_cgc_prest_honor_tiss,
	CASE WHEN ie_lado_conta_w='S' THEN TISS_OBTER_LADO_PROC_PRESCR(a.nr_sequencia,a.nr_prescricao,a.nr_sequencia_prescricao)  ELSE 'N' END  ds_lado_proc,
	CASE WHEN ie_setor_exec_proc_w='S' THEN a.cd_setor_atendimento  ELSE null END  cd_setor_exec_proc,
	CASE WHEN ie_indicacao_proc_prescr_w='S' THEN TISS_OBTER_INDIC_PROC_PRESCR(a.nr_prescricao,a.nr_sequencia_prescricao,a.ie_tiss_tipo_guia)  ELSE null END  ds_indicacao_proc_prescr,
	TISS_OBTER_DADOS_ODONTO(a.nr_sequencia,a.ie_tiss_tipo_guia,'D') nr_dente,
	TISS_OBTER_DADOS_ODONTO(a.nr_sequencia,a.ie_tiss_tipo_guia,'F') ds_face_dente,
	TISS_OBTER_GUIA_PREST_PROC(a.nr_sequencia,NULL,'N') nr_guia_prest_tiss,
  TISS_OBTER_DADOS_ODONTO(a.nr_sequencia,a.ie_tiss_tipo_guia,'R') cd_regiao_boca
from	procedimento_paciente a
where	a.nr_interno_conta 				= nr_interno_conta_p
and	coalesce(a.cd_motivo_exc_conta::text, '') = ''
and	a.ie_tiss_tipo_guia 				in ('3','4','5','6','11') -- edgar 25/09/2007, os 69498, incluido '3' - guia de consulta
and	(((ie_pacote_w = 'P') and (coalesce(a.nr_seq_proc_pacote, a.nr_sequencia) = a.nr_sequencia)) or
	 ((ie_pacote_w = 'I') and (coalesce(a.nr_seq_proc_pacote, 0) <> a.nr_sequencia)) or (ie_pacote_w = 'A'))
and	((ie_proc_partic_w = 'N') or (a.ie_tiss_tipo_guia in ('6','11')) or
	 (ie_proc_partic_w = 'RI' AND a.ie_tiss_tipo_guia <> '5') or  --lhalves 18/10/10 OS251262
	 (ie_proc_partic_w = 'SP' AND a.ie_tiss_tipo_guia <> '4')
	)
group by a.ie_tiss_tipo_guia,
	CASE WHEN a.ie_tiss_tipo_guia='5' THEN  CASE WHEN ie_participante_ri_w='S' THEN  tiss_obter_se_partic(a.nr_sequencia)  ELSE 0 END  WHEN a.ie_tiss_tipo_guia='4' THEN  CASE WHEN ie_partic_spsadt_w='S' THEN  tiss_obter_se_partic(a.nr_sequencia)  ELSE 0 END  WHEN a.ie_tiss_tipo_guia='6' THEN  CASE WHEN ie_agrupar_honor_w='N' THEN  tiss_obter_se_partic(a.nr_sequencia)  ELSE 0 END   ELSE tiss_obter_se_partic(a.nr_sequencia) END ,
	ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(tiss_obter_data_proc(a.nr_sequencia, cd_convenio_w, ie_tipo_atendimento_w, 'N', 'E')),
	a.cd_procedimento,
	a.ie_origem_proced,
	a.nr_cirurgia,
	a.nr_doc_convenio,
	a.ie_via_acesso,
	a.cd_procedimento_convenio,
	a.nr_seq_tiss_tabela,
	coalesce(a.cd_cgc_prestador_tiss, a.cd_cgc_prestador),
	tiss_obter_grau_partic(a.ie_funcao_medico),
	a.cd_medico_executor,
	a.cd_especialidade,
	CASE WHEN ie_agrup_exame_w='N' THEN  a.nr_seq_exame  ELSE null END ,
	CASE WHEN ie_agrup_resp_cred_w='S' THEN  a.ie_responsavel_credito  ELSE null END ,
	a.ie_tecnica_utilizada,
	TISS_OBTER_REGRA_SENHA(cd_estabelecimento_w,cd_convenio_w,ie_tipo_atend_tiss_conta_w,a.ie_tiss_tipo_guia,ie_senha_guia_w, a.cd_senha),
	a.tx_hora_extra,
	substr(tiss_eliminar_caractere(coalesce(tiss_obter_desc_proced(a.nr_sequencia, 0, CASE WHEN a.ie_tiss_tipo_guia='4' THEN  'DS_PROC_SPSADT' WHEN a.ie_tiss_tipo_guia='5' THEN  'DS_PROC_RI' END ), 
					coalesce(a.ds_proc_tiss, coalesce(obter_desc_proc_convenio(a.nr_sequencia, null), obter_descricao_procedimento(a.cd_procedimento, a.ie_origem_proced))))), 1, 150),
	a.nr_seq_proc_interno,
	a.dt_inicio_procedimento,
	tiss_obter_data_proc(a.nr_sequencia, cd_convenio_w, ie_tipo_atendimento_w, 'N', 'F'),
	a.tx_procedimento,
	tiss_obter_data_proc(a.nr_sequencia, cd_convenio_w, ie_tipo_atendimento_w, 'N', 'I'),
	tiss_obter_data_proc(a.nr_sequencia, cd_convenio_w, ie_tipo_atendimento_w, 'N', 'F'),
	a.cd_prestador_tiss,
	CASE WHEN a.ie_tiss_tipo_guia=5 THEN  null  ELSE a.cd_cgc_prest_solic_tiss END ,
	CASE WHEN a.ie_tiss_tipo_guia=5 THEN  null  ELSE a.cd_medico_solic_tiss END ,
	CASE WHEN a.ie_tiss_tipo_guia=5 THEN  null  ELSE a.cd_medico_prof_solic_tiss END ,
	a.cd_medico_exec_tiss,
	a.ds_proc_tiss,
	a.cd_pessoa_fisica,
	a.cd_cgc_prestador,
	a.ds_prestador_tiss,
	CASE WHEN ie_reducao_acresc_w='RA' THEN  a.nr_seq_ajuste_proc WHEN ie_reducao_acresc_w='TA' THEN  a.nr_seq_ajuste_proc WHEN ie_reducao_acresc_w='AC' THEN  a.nr_seq_ajuste_proc  ELSE 0 END ,
	CASE WHEN ie_reducao_acresc_w='AC' THEN  a.nr_seq_proc_crit_hor  ELSE 0 END ,
	a.cd_edicao_amb,
	tiss_obter_desc_proced(a.nr_sequencia, 0, CASE WHEN a.ie_tiss_tipo_guia='4' THEN  'DS_PROC_SPSADT' WHEN a.ie_tiss_tipo_guia='5' THEN  'DS_PROC_RI' END ),
	CASE WHEN ie_reducao_acresc_w='TD' THEN  tiss_obter_pr_desc(a.nr_sequencia)  ELSE 0 END ,
	coalesce(CASE WHEN ie_valor_unitario_w='O' THEN  (substr(tiss_obter_dados_proc_mat(a.nr_sequencia, null, 'UP'),1,254))::numeric   ELSE 0 END ,0),
	a.ie_funcao_medico,
	obter_medico_laudo_sequencia(a.nr_laudo, 'C'),
	a.ie_tipo_atend_tiss,
	a.cd_procedimento_tuss,
	obter_se_pacote(a.nr_sequencia, a.nr_seq_proc_pacote),
	CASE WHEN ie_reducao_acresc_w='QE' THEN  a.tx_custo_oper_qt  ELSE 0 END ,
	CASE WHEN a.ie_tiss_tipo_guia=5 THEN  null  ELSE a.cd_prestador_solic_tiss END ,
	CASE WHEN a.ie_tiss_tipo_guia=5 THEN  null  ELSE a.ds_prestador_solic_tiss END ,
	a.cd_medico_honor_tiss,
	TISS_OBTER_VALOR_CAMPO_PREST(a.nr_sequencia,1),
	TISS_OBTER_VALOR_CAMPO_PREST(a.nr_sequencia,2),
	TISS_OBTER_VALOR_CAMPO_PREST(a.nr_sequencia,3),
	TISS_OBTER_VALOR_CAMPO_PREST(a.nr_sequencia,4),
	TISS_OBTER_VALOR_CAMPO_PREST(a.nr_sequencia,5),
	TISS_OBTER_VALOR_CAMPO_PREST(a.nr_sequencia,6),
	CASE WHEN ie_medico_convenio_w='S' THEN a.cd_medico_convenio  ELSE null END ,
	a.cd_cgc_prest_honor_tiss,
	CASE WHEN ie_lado_conta_w='S' THEN TISS_OBTER_LADO_PROC_PRESCR(a.nr_sequencia,a.nr_prescricao,a.nr_sequencia_prescricao)  ELSE 'N' END ,
	CASE WHEN ie_setor_exec_proc_w='S' THEN a.cd_setor_atendimento  ELSE null END ,
	CASE WHEN ie_indicacao_proc_prescr_w='S' THEN TISS_OBTER_INDIC_PROC_PRESCR(a.nr_prescricao,a.nr_sequencia_prescricao,a.ie_tiss_tipo_guia)  ELSE null END ,
	TISS_OBTER_DADOS_ODONTO(a.nr_sequencia,a.ie_tiss_tipo_guia,'D'),
	TISS_OBTER_DADOS_ODONTO(a.nr_sequencia,a.ie_tiss_tipo_guia,'F'),
	TISS_OBTER_GUIA_PREST_PROC(a.nr_sequencia,NULL,'N'),
  TISS_OBTER_DADOS_ODONTO(a.nr_sequencia,a.ie_tiss_tipo_guia,'R')

union all

SELECT	'S' ie_honorario,
	a.ie_tiss_tipo_guia_honor,				--  gerar guia do honorario do procedimento, qdo a guia do honorario nao e a mesma do procedimento
	CASE WHEN a.ie_tiss_tipo_guia_honor='5' THEN  CASE WHEN ie_participante_ri_w='S' THEN  tiss_obter_se_partic(a.nr_sequencia)  ELSE 0 END  WHEN a.ie_tiss_tipo_guia_honor='4' THEN  CASE WHEN ie_partic_spsadt_w='S' THEN  tiss_obter_se_partic(a.nr_sequencia)  ELSE 0 END  WHEN a.ie_tiss_tipo_guia_honor='6' THEN  CASE WHEN ie_agrupar_honor_w='N' THEN  tiss_obter_se_partic(a.nr_sequencia)  ELSE 0 END   ELSE tiss_obter_se_partic(a.nr_sequencia) END ,
	ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(tiss_obter_data_proc(a.nr_sequencia, cd_convenio_w, ie_tipo_atendimento_w, 'N', 'E')),
	a.cd_procedimento,
	a.ie_origem_proced,
	sum(a.qt_procedimento),
	sum(a.vl_medico),
	a.nr_cirurgia,
	coalesce(a.nr_doc_honor_conv, a.nr_doc_convenio),
	a.ie_via_acesso,
	a.cd_procedimento_convenio,
	a.nr_seq_tiss_tabela,
	coalesce(a.cd_cgc_honorario_tiss, a.cd_cgc_prestador),
	tiss_obter_grau_partic(a.ie_funcao_medico),
	a.cd_medico_executor,			-- gerar medico honorario se a guia for de honorario
	a.cd_especialidade,
	CASE WHEN ie_agrup_exame_w='N' THEN  a.nr_seq_exame  ELSE null END ,
	sum(a.vl_medico),
	sum(a.vl_custo_operacional),
	CASE WHEN ie_agrup_resp_cred_w='S' THEN  a.ie_responsavel_credito  ELSE null END ,
	(null)::numeric  nr_seq_partic,
	a.ie_tecnica_utilizada,
	TISS_OBTER_REGRA_SENHA(cd_estabelecimento_w,cd_convenio_w,ie_tipo_atend_tiss_conta_w,a.ie_tiss_tipo_guia_honor,ie_senha_guia_w, a.cd_senha) cd_senha,
	a.tx_hora_extra,
	substr(tiss_eliminar_caractere(coalesce(tiss_obter_desc_proced(a.nr_sequencia, 0, CASE WHEN a.ie_tiss_tipo_guia_honor='4' THEN  'DS_PROC_SPSADTH' WHEN a.ie_tiss_tipo_guia_honor='5' THEN  'DS_PROC_RIH' END ),
					coalesce(a.ds_proc_tiss, coalesce(obter_desc_proc_convenio(a.nr_sequencia, null), obter_descricao_procedimento(a.cd_procedimento, a.ie_origem_proced))))), 1, 150),
	a.nr_seq_proc_interno,
	a.dt_inicio_procedimento,
	tiss_obter_data_proc(a.nr_sequencia, cd_convenio_w, ie_tipo_atendimento_w, 'N', 'F'),  --elton os120472, alterado o a.dt_procedimento (dt_fim_proc_w), pois nao estava agrupando os procedimentos.
	tiss_obter_data_proc(a.nr_sequencia, cd_convenio_w, ie_tipo_atendimento_w, 'N', 'I'),
	tiss_obter_data_proc(a.nr_sequencia, cd_convenio_w, ie_tipo_atendimento_w, 'N', 'F'),
	a.tx_procedimento,
	a.cd_prestador_tiss,
	sum(a.vl_materiais),
	CASE WHEN a.ie_tiss_tipo_guia=5 THEN  null  ELSE a.cd_cgc_prest_solic_tiss END ,
	CASE WHEN a.ie_tiss_tipo_guia=5 THEN  null  ELSE a.cd_medico_solic_tiss END ,
	CASE WHEN a.ie_tiss_tipo_guia=5 THEN  null  ELSE a.cd_medico_prof_solic_tiss END ,
	a.cd_medico_exec_tiss,
	a.ds_proc_tiss,
	sum(a.vl_medico),
	a.cd_pessoa_fisica,
	a.cd_cgc_prestador cd_prestador_proc,
	a.ds_prestador_tiss,
	CASE WHEN ie_reducao_acresc_w='RA' THEN  a.nr_seq_ajuste_proc WHEN ie_reducao_acresc_w='TA' THEN  a.nr_seq_ajuste_proc WHEN ie_reducao_acresc_w='AC' THEN  a.nr_seq_ajuste_proc  ELSE 0 END  nr_seq_ajuste_proc,
	CASE WHEN ie_reducao_acresc_w='AC' THEN  a.nr_seq_proc_crit_hor  ELSE 0 END  nr_seq_crit_hor,
	null ie_beneficiario,
	a.cd_edicao_amb,
	a.ie_tipo_atend_tiss,
	tiss_obter_desc_proced(a.nr_sequencia, 0, CASE WHEN a.ie_tiss_tipo_guia_honor='4' THEN  'DS_PROC_SPSADTH' WHEN a.ie_tiss_tipo_guia_honor='5' THEN  'DS_PROC_RIH' END ),
	(null)::numeric  nr_seq_partic_adic,
	CASE WHEN ie_reducao_acresc_w='TD' THEN  tiss_obter_pr_desc(a.nr_sequencia)  ELSE 0 END  tx_desconto,
	coalesce(CASE WHEN ie_valor_unitario_w='O' THEN  (substr(tiss_obter_dados_proc_mat(a.nr_sequencia, null, 'UP'),1,254))::numeric   ELSE 0 END ,0) vl_original,
	a.ie_funcao_medico,
	sum(obter_valor_participante(a.nr_sequencia)),
	null,
	obter_medico_laudo_sequencia(a.nr_laudo, 'C'),
	a.cd_procedimento_tuss,
	obter_se_pacote(a.nr_sequencia, a.nr_seq_proc_pacote),
	CASE WHEN ie_reducao_acresc_w='QE' THEN  a.tx_custo_oper_qt  ELSE 0 END  tx_custo_oper_qt,
	CASE WHEN a.ie_tiss_tipo_guia=5 THEN  null  ELSE a.cd_prestador_solic_tiss END ,
	CASE WHEN a.ie_tiss_tipo_guia=5 THEN  null  ELSE a.ds_prestador_solic_tiss END ,
	a.cd_medico_honor_tiss,
	TISS_OBTER_VALOR_CAMPO_PREST(a.nr_sequencia,1),
	TISS_OBTER_VALOR_CAMPO_PREST(a.nr_sequencia,2),
	TISS_OBTER_VALOR_CAMPO_PREST(a.nr_sequencia,3),
	TISS_OBTER_VALOR_CAMPO_PREST(a.nr_sequencia,4),
	TISS_OBTER_VALOR_CAMPO_PREST(a.nr_sequencia,5),
	TISS_OBTER_VALOR_CAMPO_PREST(a.nr_sequencia,6),
	CASE WHEN ie_medico_convenio_w='S' THEN a.cd_medico_convenio  ELSE null END ,
	a.cd_cgc_prest_honor_tiss,
	CASE WHEN ie_lado_conta_w='S' THEN TISS_OBTER_LADO_PROC_PRESCR(a.nr_sequencia,a.nr_prescricao,a.nr_sequencia_prescricao)  ELSE 'N' END  ds_lado_proc,
	CASE WHEN ie_setor_exec_proc_w='S' THEN a.cd_setor_atendimento  ELSE null END  cd_setor_exec_proc,
	CASE WHEN ie_indicacao_proc_prescr_w='S' THEN TISS_OBTER_INDIC_PROC_PRESCR(a.nr_prescricao,a.nr_sequencia_prescricao,a.ie_tiss_tipo_guia_honor)  ELSE null END  ds_indicacao_proc_prescr,
	null nr_dente,
	null ds_face_dente,
	TISS_OBTER_GUIA_PREST_PROC(a.nr_sequencia,NULL,'S') nr_guia_prest_tiss,
  null cd_regiao_boca
from	procedimento_paciente a
where	a.nr_interno_conta 				= nr_interno_conta_p
and	coalesce(a.cd_motivo_exc_conta::text, '') = ''
and	a.ie_tiss_tipo_guia_honor 			in ('4','5','6')
and	((coalesce(a.ie_tiss_tipo_guia_honor, '0')		<> a.ie_tiss_tipo_guia) or
	 (((a.ie_tiss_tipo_guia_honor = '4') and (tiss_obter_se_honor_spsadt(cd_convenio_w, cd_estabelecimento_w, a.ie_responsavel_credito, ie_tipo_atendimento_w, cd_setor_entrada_w, 'S') = 'S')
	  )
         ) or
	  ((a.ie_tiss_tipo_guia_honor = '5') and (tiss_obter_se_honor_ri(cd_convenio_w, cd_estabelecimento_w, a.ie_responsavel_credito, ie_tipo_atendimento_w, cd_setor_entrada_w, a.cd_procedimento, a.ie_origem_proced) = 'S')
	  )
        )
and	(a.cd_medico_executor IS NOT NULL AND a.cd_medico_executor::text <> '')
and	(((ie_pacote_w = 'P') and (coalesce(a.nr_seq_proc_pacote, a.nr_sequencia) = a.nr_sequencia)) or
	 ((ie_pacote_w = 'I') and (coalesce(a.nr_seq_proc_pacote, 0) <> a.nr_sequencia)) or (ie_pacote_w = 'A'))
and	((ie_proc_partic_w = 'N') or (a.ie_tiss_tipo_guia_honor = '6') or
	 (ie_proc_partic_w = 'N' AND a.ie_tiss_tipo_guia_honor <> '5') or  --lhalves 18/10/10 OS251262
	 (ie_proc_partic_w = 'N' AND a.ie_tiss_tipo_guia_honor <> '4')
	)
group by a.ie_tiss_tipo_guia_honor,
	CASE WHEN a.ie_tiss_tipo_guia_honor='5' THEN  CASE WHEN ie_participante_ri_w='S' THEN  tiss_obter_se_partic(a.nr_sequencia)  ELSE 0 END  WHEN a.ie_tiss_tipo_guia_honor='4' THEN  CASE WHEN ie_partic_spsadt_w='S' THEN  tiss_obter_se_partic(a.nr_sequencia)  ELSE 0 END  WHEN a.ie_tiss_tipo_guia_honor='6' THEN  CASE WHEN ie_agrupar_honor_w='N' THEN  tiss_obter_se_partic(a.nr_sequencia)  ELSE 0 END   ELSE tiss_obter_se_partic(a.nr_sequencia) END ,
	ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(tiss_obter_data_proc(a.nr_sequencia, cd_convenio_w, ie_tipo_atendimento_w, 'N', 'E')),
	a.cd_procedimento,
	a.ie_origem_proced,
	a.nr_cirurgia,
	coalesce(a.nr_doc_honor_conv, a.nr_doc_convenio),
	a.ie_via_acesso,
	a.cd_procedimento_convenio,
	a.nr_seq_tiss_tabela,
	coalesce(a.cd_cgc_honorario_tiss, a.cd_cgc_prestador),
	tiss_obter_grau_partic(a.ie_funcao_medico),
	a.cd_medico_executor,
	a.cd_especialidade,
	CASE WHEN ie_agrup_exame_w='N' THEN  a.nr_seq_exame  ELSE null END ,
	CASE WHEN ie_agrup_resp_cred_w='S' THEN  a.ie_responsavel_credito  ELSE null END ,
	a.ie_tecnica_utilizada,
	TISS_OBTER_REGRA_SENHA(cd_estabelecimento_w,cd_convenio_w,ie_tipo_atend_tiss_conta_w,a.ie_tiss_tipo_guia_honor,ie_senha_guia_w, a.cd_senha),
	a.tx_hora_extra,
	substr(tiss_eliminar_caractere(coalesce(tiss_obter_desc_proced(a.nr_sequencia, 0, CASE WHEN a.ie_tiss_tipo_guia_honor='4' THEN  'DS_PROC_SPSADTH' WHEN a.ie_tiss_tipo_guia_honor='5' THEN  'DS_PROC_RIH' END ),
					coalesce(a.ds_proc_tiss, coalesce(obter_desc_proc_convenio(a.nr_sequencia, null), obter_descricao_procedimento(a.cd_procedimento, a.ie_origem_proced))))), 1, 150),
	a.nr_seq_proc_interno,
	a.dt_inicio_procedimento,
	tiss_obter_data_proc(a.nr_sequencia, cd_convenio_w, ie_tipo_atendimento_w, 'N', 'F'), 
	tiss_obter_data_proc(a.nr_sequencia, cd_convenio_w, ie_tipo_atendimento_w, 'N', 'I'),
	tiss_obter_data_proc(a.nr_sequencia, cd_convenio_w, ie_tipo_atendimento_w, 'N', 'F'),
	a.tx_procedimento,
	a.cd_prestador_tiss,
	CASE WHEN a.ie_tiss_tipo_guia=5 THEN  null  ELSE a.cd_cgc_prest_solic_tiss END ,
	CASE WHEN a.ie_tiss_tipo_guia=5 THEN  null  ELSE a.cd_medico_solic_tiss END ,
	CASE WHEN a.ie_tiss_tipo_guia=5 THEN  null  ELSE a.cd_medico_prof_solic_tiss END ,
	a.cd_medico_exec_tiss,
	a.ds_proc_tiss,
	a.cd_pessoa_fisica,
	a.cd_cgc_prestador,
	a.ds_prestador_tiss,
	CASE WHEN ie_reducao_acresc_w='RA' THEN  a.nr_seq_ajuste_proc WHEN ie_reducao_acresc_w='TA' THEN  a.nr_seq_ajuste_proc WHEN ie_reducao_acresc_w='AC' THEN  a.nr_seq_ajuste_proc  ELSE 0 END ,
	CASE WHEN ie_reducao_acresc_w='AC' THEN  a.nr_seq_proc_crit_hor  ELSE 0 END ,
	a.cd_edicao_amb,
	tiss_obter_desc_proced(a.nr_sequencia, 0, CASE WHEN a.ie_tiss_tipo_guia_honor='4' THEN  'DS_PROC_SPSADTH' WHEN a.ie_tiss_tipo_guia_honor='5' THEN  'DS_PROC_RIH' END ),
	CASE WHEN ie_reducao_acresc_w='TD' THEN  tiss_obter_pr_desc(a.nr_sequencia)  ELSE 0 END ,
	coalesce(CASE WHEN ie_valor_unitario_w='O' THEN  (substr(tiss_obter_dados_proc_mat(a.nr_sequencia, null, 'UP'),1,254))::numeric   ELSE 0 END ,0),
	a.ie_funcao_medico,
	obter_medico_laudo_sequencia(a.nr_laudo, 'C'),
	a.ie_tipo_atend_tiss,
	a.cd_procedimento_tuss,
	obter_se_pacote(a.nr_sequencia, a.nr_seq_proc_pacote),
	CASE WHEN ie_reducao_acresc_w='QE' THEN  a.tx_custo_oper_qt  ELSE 0 END ,
	CASE WHEN a.ie_tiss_tipo_guia=5 THEN  null  ELSE a.cd_prestador_solic_tiss END ,
	CASE WHEN a.ie_tiss_tipo_guia=5 THEN  null  ELSE a.ds_prestador_solic_tiss END ,
	a.cd_medico_honor_tiss,
	TISS_OBTER_VALOR_CAMPO_PREST(a.nr_sequencia,1),
	TISS_OBTER_VALOR_CAMPO_PREST(a.nr_sequencia,2),
	TISS_OBTER_VALOR_CAMPO_PREST(a.nr_sequencia,3),
	TISS_OBTER_VALOR_CAMPO_PREST(a.nr_sequencia,4),
	TISS_OBTER_VALOR_CAMPO_PREST(a.nr_sequencia,5),
	TISS_OBTER_VALOR_CAMPO_PREST(a.nr_sequencia,6),
	CASE WHEN ie_medico_convenio_w='S' THEN a.cd_medico_convenio  ELSE null END ,
	a.cd_cgc_prest_honor_tiss,
	CASE WHEN ie_lado_conta_w='S' THEN TISS_OBTER_LADO_PROC_PRESCR(a.nr_sequencia,a.nr_prescricao,a.nr_sequencia_prescricao)  ELSE 'N' END ,
	CASE WHEN ie_setor_exec_proc_w='S' THEN a.cd_setor_atendimento  ELSE null END ,
	CASE WHEN ie_indicacao_proc_prescr_w='S' THEN TISS_OBTER_INDIC_PROC_PRESCR(a.nr_prescricao,a.nr_sequencia_prescricao,a.ie_tiss_tipo_guia_honor)  ELSE null END ,
	TISS_OBTER_GUIA_PREST_PROC(a.nr_sequencia,NULL,'S')

union all

select	'S' ie_honorario,
	b.ie_tiss_tipo_guia, 				--  gerar guia do participante do procedimento
	CASE WHEN b.ie_tiss_tipo_guia='5' THEN  CASE WHEN ie_participante_ri_w='S' THEN  tiss_obter_se_partic(a.nr_sequencia)  ELSE 0 END  WHEN b.ie_tiss_tipo_guia='4' THEN  CASE WHEN ie_partic_spsadt_w='S' THEN  tiss_obter_se_partic(a.nr_sequencia)  ELSE 0 END  WHEN b.ie_tiss_tipo_guia='6' THEN  CASE WHEN ie_agrupar_honor_w='N' THEN  tiss_obter_se_partic(a.nr_sequencia)  ELSE 0 END   ELSE tiss_obter_se_partic(a.nr_sequencia) END ,
	ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(tiss_obter_data_proc(a.nr_sequencia, cd_convenio_w, ie_tipo_atendimento_w, 'N', 'E')),
	a.cd_procedimento,
	a.ie_origem_proced,
	sum(a.qt_procedimento),
	sum(b.vl_participante),
	a.nr_cirurgia,
	coalesce(b.nr_doc_honor_conv, a.nr_doc_convenio),
	a.ie_via_acesso,
	CASE WHEN b.cd_proc_conv='0' THEN  a.cd_procedimento_convenio  ELSE b.cd_proc_conv END ,
	a.nr_seq_tiss_tabela,
	coalesce(b.cd_cgc_prestador_tiss, coalesce(a.cd_cgc_prestador_tiss, a.cd_cgc_prestador)),
	tiss_obter_grau_partic(b.ie_funcao),
	b.cd_pessoa_fisica cd_medico_executor,	-- gerar medico honorario se a guia for de honorario
	b.cd_especialidade,
	CASE WHEN ie_agrup_exame_w='N' THEN  a.nr_seq_exame  ELSE null END ,
	sum(b.vl_participante),
	0 vl_custo_operacional,
	CASE WHEN ie_agrup_resp_cred_w='S' THEN  b.ie_responsavel_credito  ELSE null END ,
	CASE WHEN ds_versao_3_w='S' THEN CASE WHEN b.ie_tiss_tipo_guia='6' THEN b.nr_seq_partic  ELSE null END   ELSE null END  nr_seq_partic,
	a.ie_tecnica_utilizada,
	TISS_OBTER_REGRA_SENHA(cd_estabelecimento_w,cd_convenio_w,ie_tipo_atend_tiss_conta_w,b.ie_tiss_tipo_guia,ie_senha_guia_w, a.cd_senha) cd_senha,
	a.tx_hora_extra,
	substr(tiss_eliminar_caractere(coalesce(tiss_obter_desc_proced(a.nr_sequencia, b.nr_seq_partic, CASE WHEN b.ie_tiss_tipo_guia='4' THEN  'DS_PROC_SPSADTH' WHEN b.ie_tiss_tipo_guia='5' THEN  'DS_PROC_RIH' END ),
					coalesce(b.ds_proc_tiss, coalesce(coalesce(b.ds_proc_conv, obter_desc_proc_convenio(a.nr_sequencia, null)), obter_descricao_procedimento(a.cd_procedimento, a.ie_origem_proced))))), 1, 150),
	a.nr_seq_proc_interno,
	a.dt_inicio_procedimento,
	tiss_obter_data_proc(a.nr_sequencia, cd_convenio_w, ie_tipo_atendimento_w, 'N', 'F'),  --elton os120472, alterado o a.dt_procedimento (dt_fim_proc_w), pois nao estava agrupando os procedimentos.
	tiss_obter_data_proc(a.nr_sequencia, cd_convenio_w, ie_tipo_atendimento_w, 'N', 'I'),
	tiss_obter_data_proc(a.nr_sequencia, cd_convenio_w, ie_tipo_atendimento_w, 'N', 'F'),
	coalesce(b.pr_faturar,a.tx_procedimento) tx_procedimento, --OS 829245
	coalesce(b.cd_prestador_tiss, a.cd_prestador_tiss),
	sum(a.vl_materiais),
	CASE WHEN a.ie_tiss_tipo_guia=5 THEN  null  ELSE b.cd_cgc_prest_solic_tiss END ,
	CASE WHEN a.ie_tiss_tipo_guia=5 THEN  null  ELSE a.cd_medico_solic_tiss END ,
	CASE WHEN a.ie_tiss_tipo_guia=5 THEN  null  ELSE a.cd_medico_prof_solic_tiss END ,
	b.cd_medico_exec_tiss,
	b.ds_proc_tiss,
	sum(b.vl_participante),
	a.cd_pessoa_fisica,
	a.cd_cgc_prestador cd_prestador_proc,
	b.ds_prestador_tiss,
	CASE WHEN ie_reducao_acresc_w='RA' THEN  a.nr_seq_ajuste_proc WHEN ie_reducao_acresc_w='TA' THEN  a.nr_seq_ajuste_proc WHEN ie_reducao_acresc_w='AC' THEN  a.nr_seq_ajuste_proc  ELSE 0 END  nr_seq_ajuste_proc,
	CASE WHEN ie_reducao_acresc_w='AC' THEN  a.nr_seq_proc_crit_hor  ELSE 0 END  nr_seq_crit_hor,
	null ie_beneficiario,
	a.cd_edicao_amb,
	a.ie_tipo_atend_tiss,
	tiss_obter_desc_proced(a.nr_sequencia, b.nr_seq_partic, CASE WHEN b.ie_tiss_tipo_guia='4' THEN  'DS_PROC_SPSADTH' WHEN b.ie_tiss_tipo_guia='5' THEN  'DS_PROC_RIH' END ),
	(null)::numeric  nr_seq_partic_adic,
	CASE WHEN ie_reducao_acresc_w='TD' THEN  tiss_obter_pr_desc(a.nr_sequencia)  ELSE 0 END  tx_desconto,
	coalesce(CASE WHEN ie_valor_unitario_w='O' THEN  (substr(tiss_obter_dados_proc_mat(a.nr_sequencia, null, 'UP'),1,254))::numeric   ELSE 0 END ,0) vl_original,
	b.ie_funcao,
	sum(obter_valor_participante(a.nr_sequencia)),
	null,
	obter_medico_laudo_sequencia(a.nr_laudo, 'C'),
	a.cd_procedimento_tuss,
	obter_se_pacote(a.nr_sequencia, a.nr_seq_proc_pacote),
	CASE WHEN ie_reducao_acresc_w='QE' THEN  a.tx_custo_oper_qt  ELSE 0 END  tx_custo_oper_qt,
	CASE WHEN a.ie_tiss_tipo_guia=5 THEN  null  ELSE a.cd_prestador_solic_tiss END ,
	CASE WHEN a.ie_tiss_tipo_guia=5 THEN  null  ELSE a.ds_prestador_solic_tiss END ,
	b.cd_medico_honor_tiss,
	TISS_OBTER_VALOR_CAMPO_PREST(a.nr_sequencia,1),
	TISS_OBTER_VALOR_CAMPO_PREST(a.nr_sequencia,2),
	TISS_OBTER_VALOR_CAMPO_PREST(a.nr_sequencia,3),
	TISS_OBTER_VALOR_CAMPO_PREST(a.nr_sequencia,4),
	TISS_OBTER_VALOR_CAMPO_PREST(a.nr_sequencia,5),
	TISS_OBTER_VALOR_CAMPO_PREST(a.nr_sequencia,6),
	CASE WHEN ie_medico_convenio_w='S' THEN b.cd_medico_convenio  ELSE null END ,
	b.cd_cgc_prest_honor_tiss,
	CASE WHEN ie_lado_conta_w='S' THEN TISS_OBTER_LADO_PROC_PRESCR(a.nr_sequencia,a.nr_prescricao,a.nr_sequencia_prescricao)  ELSE 'N' END  ds_lado_proc,
	CASE WHEN ie_setor_exec_proc_w='S' THEN a.cd_setor_atendimento  ELSE null END  cd_setor_exec_proc,
	CASE WHEN ie_indicacao_proc_prescr_w='S' THEN TISS_OBTER_INDIC_PROC_PRESCR(a.nr_prescricao,a.nr_sequencia_prescricao,b.ie_tiss_tipo_guia)  ELSE null END  ds_indicacao_proc_prescr,
	null nr_dente,
	null ds_face_dente,
	TISS_OBTER_GUIA_PREST_PROC(a.nr_sequencia,b.nr_seq_partic,'S') nr_guia_prest_tiss,
  null cd_regiao_boca
from	procedimento_participante b,
	procedimento_paciente a
where	a.nr_interno_conta 					= nr_interno_conta_p
and	coalesce(a.cd_motivo_exc_conta::text, '') = ''
and	a.nr_sequencia					= b.nr_sequencia
and	((coalesce(b.ie_tiss_tipo_guia, a.ie_tiss_tipo_guia) <> a.ie_tiss_tipo_guia) or 	-- edgar 20/09/2007, os 68614, separar honor partic na guia de sp/sadt
	 (b.ie_tiss_tipo_guia = '6') or 	 	-- edgar 15/10/2007, os 71469, forcar emissco de guia de honorario individual
	 ((b.ie_tiss_tipo_guia = '4') and (tiss_obter_se_honor_spsadt(cd_convenio_w, cd_estabelecimento_w, b.ie_responsavel_credito, ie_tipo_atendimento_w, cd_setor_entrada_w, 'N') = 'S')) or
	 ((b.ie_tiss_tipo_guia = '5') and (tiss_obter_se_honor_ri(cd_convenio_w, cd_estabelecimento_w, b.ie_responsavel_credito, ie_tipo_atendimento_w, cd_setor_entrada_w, a.cd_procedimento, a.ie_origem_proced) = 'S')))
and	coalesce(b.ie_tiss_tipo_guia, a.ie_tiss_tipo_guia)		in ('4','5','6')
and	(((ie_pacote_w = 'P') and (coalesce(a.nr_seq_proc_pacote, a.nr_sequencia) = a.nr_sequencia)) or
	 ((ie_pacote_w = 'I') and (coalesce(a.nr_seq_proc_pacote, 0) <> a.nr_sequencia)) or (ie_pacote_w = 'A'))
and	((ie_proc_partic_w = 'N') or (coalesce(b.ie_tiss_tipo_guia, a.ie_tiss_tipo_guia) = '6') or
	 ((ie_proc_partic_w = 'RI') and (coalesce(b.ie_tiss_tipo_guia, a.ie_tiss_tipo_guia) <> '5')) or  --lhalves 18/10/10 OS251262
	 ((ie_proc_partic_w = 'SP') and (coalesce(b.ie_tiss_tipo_guia, a.ie_tiss_tipo_guia) <> '4'))
	)
group by b.ie_tiss_tipo_guia,
	CASE WHEN b.ie_tiss_tipo_guia='5' THEN  CASE WHEN ie_participante_ri_w='S' THEN  tiss_obter_se_partic(a.nr_sequencia)  ELSE 0 END  WHEN b.ie_tiss_tipo_guia='4' THEN  CASE WHEN ie_partic_spsadt_w='S' THEN  tiss_obter_se_partic(a.nr_sequencia)  ELSE 0 END  WHEN b.ie_tiss_tipo_guia='6' THEN  CASE WHEN ie_agrupar_honor_w='N' THEN  tiss_obter_se_partic(a.nr_sequencia)  ELSE 0 END   ELSE tiss_obter_se_partic(a.nr_sequencia) END ,
	ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(tiss_obter_data_proc(a.nr_sequencia, cd_convenio_w, ie_tipo_atendimento_w, 'N', 'E')),
	a.cd_procedimento,
	a.ie_origem_proced,
	a.nr_cirurgia,
	coalesce(b.nr_doc_honor_conv, a.nr_doc_convenio),
	a.ie_via_acesso,
	CASE WHEN b.cd_proc_conv='0' THEN  a.cd_procedimento_convenio  ELSE b.cd_proc_conv END ,
	a.nr_seq_tiss_tabela,
	coalesce(b.cd_cgc_prestador_tiss, coalesce(a.cd_cgc_prestador_tiss, a.cd_cgc_prestador)),
	tiss_obter_grau_partic(b.ie_funcao),
	b.cd_pessoa_fisica,
	b.cd_especialidade,
	CASE WHEN ie_agrup_exame_w='N' THEN  a.nr_seq_exame  ELSE null END ,
	CASE WHEN ie_agrup_resp_cred_w='S' THEN  b.ie_responsavel_credito  ELSE null END ,
	CASE WHEN ds_versao_3_w='S' THEN CASE WHEN b.ie_tiss_tipo_guia='6' THEN b.nr_seq_partic  ELSE null END   ELSE null END ,
	a.ie_tecnica_utilizada,
	TISS_OBTER_REGRA_SENHA(cd_estabelecimento_w,cd_convenio_w,ie_tipo_atend_tiss_conta_w,b.ie_tiss_tipo_guia,ie_senha_guia_w, a.cd_senha),
	a.tx_hora_extra,
	substr(tiss_eliminar_caractere(coalesce(tiss_obter_desc_proced(a.nr_sequencia, b.nr_seq_partic, CASE WHEN b.ie_tiss_tipo_guia='4' THEN  'DS_PROC_SPSADTH' WHEN b.ie_tiss_tipo_guia='5' THEN  'DS_PROC_RIH' END ),
					coalesce(b.ds_proc_tiss, coalesce(coalesce(b.ds_proc_conv, obter_desc_proc_convenio(a.nr_sequencia, null)), obter_descricao_procedimento(a.cd_procedimento, a.ie_origem_proced))))), 1, 150),
	a.nr_seq_proc_interno,
	a.dt_inicio_procedimento,
	tiss_obter_data_proc(a.nr_sequencia, cd_convenio_w, ie_tipo_atendimento_w, 'N', 'F'),
	tiss_obter_data_proc(a.nr_sequencia, cd_convenio_w, ie_tipo_atendimento_w, 'N', 'I'),
	tiss_obter_data_proc(a.nr_sequencia, cd_convenio_w, ie_tipo_atendimento_w, 'N', 'F'),
	coalesce(b.pr_faturar,a.tx_procedimento),
	coalesce(b.cd_prestador_tiss, a.cd_prestador_tiss),
	CASE WHEN a.ie_tiss_tipo_guia=5 THEN  null  ELSE b.cd_cgc_prest_solic_tiss END ,
	CASE WHEN a.ie_tiss_tipo_guia=5 THEN  null  ELSE a.cd_medico_solic_tiss END ,
	CASE WHEN a.ie_tiss_tipo_guia=5 THEN  null  ELSE a.cd_medico_prof_solic_tiss END ,
	b.cd_medico_exec_tiss,
	b.ds_proc_tiss,
	a.cd_pessoa_fisica,
	a.cd_cgc_prestador,
	b.ds_prestador_tiss,
	CASE WHEN ie_reducao_acresc_w='RA' THEN  a.nr_seq_ajuste_proc WHEN ie_reducao_acresc_w='TA' THEN  a.nr_seq_ajuste_proc WHEN ie_reducao_acresc_w='AC' THEN  a.nr_seq_ajuste_proc  ELSE 0 END ,
	CASE WHEN ie_reducao_acresc_w='AC' THEN  a.nr_seq_proc_crit_hor  ELSE 0 END ,
	a.cd_edicao_amb,
	tiss_obter_desc_proced(a.nr_sequencia, b.nr_seq_partic, CASE WHEN b.ie_tiss_tipo_guia='4' THEN  'DS_PROC_SPSADTH' WHEN b.ie_tiss_tipo_guia='5' THEN  'DS_PROC_RIH' END ),
	CASE WHEN ie_reducao_acresc_w='TD' THEN  tiss_obter_pr_desc(a.nr_sequencia)  ELSE 0 END ,
	coalesce(CASE WHEN ie_valor_unitario_w='O' THEN  (substr(tiss_obter_dados_proc_mat(a.nr_sequencia, null, 'UP'),1,254))::numeric   ELSE 0 END ,0),
	b.ie_funcao,
	obter_medico_laudo_sequencia(a.nr_laudo, 'C'),
	a.ie_tipo_atend_tiss,
	a.cd_procedimento_tuss,
	obter_se_pacote(a.nr_sequencia, a.nr_seq_proc_pacote),
	CASE WHEN ie_reducao_acresc_w='QE' THEN  a.tx_custo_oper_qt  ELSE 0 END ,
	CASE WHEN a.ie_tiss_tipo_guia=5 THEN  null  ELSE a.cd_prestador_solic_tiss END ,
	CASE WHEN a.ie_tiss_tipo_guia=5 THEN  null  ELSE a.ds_prestador_solic_tiss END ,
	b.cd_medico_honor_tiss,
	TISS_OBTER_VALOR_CAMPO_PREST(a.nr_sequencia,1),
	TISS_OBTER_VALOR_CAMPO_PREST(a.nr_sequencia,2),
	TISS_OBTER_VALOR_CAMPO_PREST(a.nr_sequencia,3),
	TISS_OBTER_VALOR_CAMPO_PREST(a.nr_sequencia,4),
	TISS_OBTER_VALOR_CAMPO_PREST(a.nr_sequencia,5),
	TISS_OBTER_VALOR_CAMPO_PREST(a.nr_sequencia,6),
	CASE WHEN ie_medico_convenio_w='S' THEN b.cd_medico_convenio  ELSE null END ,
	b.cd_cgc_prest_honor_tiss,
	CASE WHEN ie_lado_conta_w='S' THEN TISS_OBTER_LADO_PROC_PRESCR(a.nr_sequencia,a.nr_prescricao,a.nr_sequencia_prescricao)  ELSE 'N' END ,
	CASE WHEN ie_setor_exec_proc_w='S' THEN a.cd_setor_atendimento  ELSE null END ,
	CASE WHEN ie_indicacao_proc_prescr_w='S' THEN TISS_OBTER_INDIC_PROC_PRESCR(a.nr_prescricao,a.nr_sequencia_prescricao,b.ie_tiss_tipo_guia)  ELSE null END ,
	TISS_OBTER_GUIA_PREST_PROC(a.nr_sequencia,b.nr_seq_partic,'S')

union all

--

-- 	!!!! edgar 27/08/2007, union para gerar um procedimento para cada participante do proceidmento !!!!!

--
select	'S' ie_honorario,				-- ie_tiss_tipo_guia_honor
	a.ie_tiss_tipo_guia_honor,			-- gerar guia do honorario do procedimento, qdo a guia do honorario nao e a mesma do procedimento
	CASE WHEN a.ie_tiss_tipo_guia_honor='5' THEN  CASE WHEN ie_participante_ri_w='S' THEN  tiss_obter_se_partic(a.nr_sequencia)  ELSE 0 END  WHEN a.ie_tiss_tipo_guia_honor='4' THEN  CASE WHEN ie_partic_spsadt_w='S' THEN  tiss_obter_se_partic(a.nr_sequencia)  ELSE 0 END  WHEN a.ie_tiss_tipo_guia_honor='6' THEN  CASE WHEN ie_agrupar_honor_w='N' THEN  tiss_obter_se_partic(a.nr_sequencia)  ELSE 0 END   ELSE tiss_obter_se_partic(a.nr_sequencia) END ,
	ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(tiss_obter_data_proc(a.nr_sequencia, cd_convenio_w, ie_tipo_atendimento_w, 'N', 'E')),
	a.cd_procedimento,
	a.ie_origem_proced,
	sum(a.qt_procedimento),
	CASE WHEN ie_valor_desconto_w='N' THEN  CASE WHEN coalesce(a.nr_seq_proc_pacote::text, '') = '' THEN  sum(a.vl_medico)  ELSE sum(a.vl_procedimento) END   ELSE CASE WHEN coalesce(a.nr_seq_proc_pacote::text, '') = '' THEN  sum(a.vl_medico)  ELSE sum(a.vl_procedimento) END  + sum(coalesce(obter_desconto_matproc(a.nr_sequencia,'P'),0)) END ,
	a.nr_cirurgia,
	coalesce(a.nr_doc_honor_conv, a.nr_doc_convenio) nr_doc_convenio,
	a.ie_via_acesso,
	a.cd_procedimento_convenio,
	a.nr_seq_tiss_tabela,
	coalesce(a.cd_cgc_honorario_tiss, a.cd_cgc_prestador),
	tiss_obter_grau_partic(a.ie_funcao_medico),
	a.cd_medico_executor,				-- gerar medico honorario se a guia for de honorario
	a.cd_especialidade,
	CASE WHEN ie_agrup_exame_w='N' THEN  a.nr_seq_exame  ELSE null END ,
	sum(a.vl_medico), 
	sum(a.vl_custo_operacional),
	CASE WHEN ie_agrup_resp_cred_w='S' THEN  a.ie_responsavel_credito  ELSE null END ,
	(null)::numeric  nr_seq_partic,
	a.ie_tecnica_utilizada,
	TISS_OBTER_REGRA_SENHA(cd_estabelecimento_w,cd_convenio_w,ie_tipo_atend_tiss_conta_w,a.ie_tiss_tipo_guia_honor,ie_senha_guia_w, a.cd_senha) cd_senha,
	a.tx_hora_extra,
	substr(tiss_eliminar_caractere(coalesce(tiss_obter_desc_proced(a.nr_sequencia, 0, CASE WHEN a.ie_tiss_tipo_guia_honor='4' THEN  'DS_PROC_SPSADTH' WHEN a.ie_tiss_tipo_guia_honor='5' THEN  'DS_PROC_RIH' END ),
					coalesce(a.ds_proc_tiss, coalesce(obter_desc_proc_convenio(a.nr_sequencia, null), obter_descricao_procedimento(a.cd_procedimento, a.ie_origem_proced))))), 1, 150),
	a.nr_seq_proc_interno,
	a.dt_inicio_procedimento,
	tiss_obter_data_proc(a.nr_sequencia, cd_convenio_w, ie_tipo_atendimento_w, 'N', 'F'),  --elton os120472, alterado o a.dt_procedimento (dt_fim_proc_w), pois nao estava agrupando os procedimentos.
	tiss_obter_data_proc(a.nr_sequencia, cd_convenio_w, ie_tipo_atendimento_w, 'N', 'I'),
	tiss_obter_data_proc(a.nr_sequencia, cd_convenio_w, ie_tipo_atendimento_w, 'N', 'F'),
	a.tx_procedimento,
	a.cd_prestador_tiss,
	sum(a.vl_materiais),
	CASE WHEN a.ie_tiss_tipo_guia=5 THEN  null  ELSE a.cd_cgc_prest_solic_tiss END ,
	CASE WHEN a.ie_tiss_tipo_guia=5 THEN  null  ELSE a.cd_medico_solic_tiss END ,
	CASE WHEN a.ie_tiss_tipo_guia=5 THEN  null  ELSE a.cd_medico_prof_solic_tiss END ,
	a.cd_medico_exec_tiss,
	a.ds_proc_tiss,
	sum(a.vl_procedimento),
	a.cd_pessoa_fisica,
	a.cd_cgc_prestador cd_prestador_proc,
	a.ds_prestador_tiss,
	CASE WHEN ie_reducao_acresc_w='RA' THEN  a.nr_seq_ajuste_proc WHEN ie_reducao_acresc_w='TA' THEN  a.nr_seq_ajuste_proc WHEN ie_reducao_acresc_w='AC' THEN  a.nr_seq_ajuste_proc  ELSE 0 END  nr_seq_ajuste_proc,
	CASE WHEN ie_reducao_acresc_w='AC' THEN  a.nr_seq_proc_crit_hor  ELSE 0 END  nr_seq_crit_hor,
	null ie_beneficiario,
	a.cd_edicao_amb,
	a.ie_tipo_atend_tiss,
	tiss_obter_desc_proced(a.nr_sequencia, 0, CASE WHEN a.ie_tiss_tipo_guia_honor='4' THEN  'DS_PROC_SPSADTH' WHEN a.ie_tiss_tipo_guia_honor='5' THEN  'DS_PROC_RIH' END ),
	(null)::numeric  nr_seq_partic_adic,
	CASE WHEN ie_reducao_acresc_w='TD' THEN  tiss_obter_pr_desc(a.nr_sequencia)  ELSE 0 END  tx_desconto,
	coalesce(CASE WHEN ie_valor_unitario_w='O' THEN  (substr(tiss_obter_dados_proc_mat(a.nr_sequencia, null, 'UP'),1,254))::numeric   ELSE 0 END ,0) vl_unitario,
	a.ie_funcao_medico,
	sum(obter_valor_participante(a.nr_sequencia)),
	null,
	obter_medico_laudo_sequencia(a.nr_laudo, 'C'),
	a.cd_procedimento_tuss,
	obter_se_pacote(a.nr_sequencia, a.nr_seq_proc_pacote),
	CASE WHEN ie_reducao_acresc_w='QE' THEN  a.tx_custo_oper_qt  ELSE 0 END  tx_custo_oper_qt,
	CASE WHEN a.ie_tiss_tipo_guia=5 THEN  null  ELSE a.cd_prestador_solic_tiss END ,
	CASE WHEN a.ie_tiss_tipo_guia=5 THEN  null  ELSE a.ds_prestador_solic_tiss END ,
	a.cd_medico_honor_tiss,
	TISS_OBTER_VALOR_CAMPO_PREST(a.nr_sequencia,1),
	TISS_OBTER_VALOR_CAMPO_PREST(a.nr_sequencia,2),
	TISS_OBTER_VALOR_CAMPO_PREST(a.nr_sequencia,3),
	TISS_OBTER_VALOR_CAMPO_PREST(a.nr_sequencia,4),
	TISS_OBTER_VALOR_CAMPO_PREST(a.nr_sequencia,5),
	TISS_OBTER_VALOR_CAMPO_PREST(a.nr_sequencia,6),
	CASE WHEN ie_medico_convenio_w='S' THEN a.cd_medico_convenio  ELSE null END ,
	a.cd_cgc_prest_honor_tiss,
	CASE WHEN ie_lado_conta_w='S' THEN TISS_OBTER_LADO_PROC_PRESCR(a.nr_sequencia,a.nr_prescricao,a.nr_sequencia_prescricao)  ELSE 'N' END  ds_lado_proc,
	CASE WHEN ie_setor_exec_proc_w='S' THEN a.cd_setor_atendimento  ELSE null END  cd_setor_exec_proc,
	CASE WHEN ie_indicacao_proc_prescr_w='S' THEN TISS_OBTER_INDIC_PROC_PRESCR(a.nr_prescricao,a.nr_sequencia_prescricao,a.ie_tiss_tipo_guia_honor)  ELSE null END  ds_indicacao_proc_prescr,
	null nr_dente,
	null ds_face_dente,
	TISS_OBTER_GUIA_PREST_PROC(a.nr_sequencia,NULL,'S') nr_guia_prest_tiss,
  null cd_regiao_boca
from	procedimento_paciente a
where	a.nr_interno_conta 				= nr_interno_conta_p
and	coalesce(a.cd_motivo_exc_conta::text, '') = ''
and	a.ie_tiss_tipo_guia_honor 			in ('4','5')
and	a.ie_tiss_tipo_guia				<> '7'
and	((coalesce(a.ie_tiss_tipo_guia_honor, '0')		<> a.ie_tiss_tipo_guia) or
	 ((a.ie_tiss_tipo_guia_honor = '4') and (tiss_obter_se_honor_spsadt(cd_convenio_w, cd_estabelecimento_w, a.ie_responsavel_credito, ie_tipo_atendimento_w, cd_setor_entrada_w, 'S') = 'S')
	 ) or
	 ((a.ie_tiss_tipo_guia_honor = '5') and (tiss_obter_se_honor_ri(cd_convenio_w, cd_estabelecimento_w, a.ie_responsavel_credito, ie_tipo_atendimento_w, cd_setor_entrada_w, a.cd_procedimento, a.ie_origem_proced) = 'S')
	 )
        )
and	(a.cd_medico_executor IS NOT NULL AND a.cd_medico_executor::text <> '')
and	(((ie_pacote_w = 'P') and (coalesce(a.nr_seq_proc_pacote, a.nr_sequencia) = a.nr_sequencia)) or
	 ((ie_pacote_w = 'I') and (coalesce(a.nr_seq_proc_pacote, 0) <> a.nr_sequencia)) or (ie_pacote_w = 'A'))
and	((ie_proc_partic_w = 'S') or
	 (ie_proc_partic_w = 'RI' AND a.ie_tiss_tipo_guia = '5') or  --lhalves 18/10/10 OS251262
	 (ie_proc_partic_w = 'SP' AND a.ie_tiss_tipo_guia = '4')
	)
group by a.ie_tiss_tipo_guia_honor,
	CASE WHEN a.ie_tiss_tipo_guia_honor='5' THEN  CASE WHEN ie_participante_ri_w='S' THEN  tiss_obter_se_partic(a.nr_sequencia)  ELSE 0 END  WHEN a.ie_tiss_tipo_guia_honor='4' THEN  CASE WHEN ie_partic_spsadt_w='S' THEN  tiss_obter_se_partic(a.nr_sequencia)  ELSE 0 END  WHEN a.ie_tiss_tipo_guia_honor='6' THEN  CASE WHEN ie_agrupar_honor_w='N' THEN  tiss_obter_se_partic(a.nr_sequencia)  ELSE 0 END   ELSE tiss_obter_se_partic(a.nr_sequencia) END ,
	ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(tiss_obter_data_proc(a.nr_sequencia, cd_convenio_w, ie_tipo_atendimento_w, 'N', 'E')),
	a.cd_procedimento,
	a.nr_seq_proc_pacote,
	a.ie_origem_proced,
	a.nr_cirurgia,
	coalesce(a.nr_doc_honor_conv, a.nr_doc_convenio),
	a.ie_via_acesso,
	a.cd_procedimento_convenio,
	a.nr_seq_tiss_tabela,
	coalesce(a.cd_cgc_honorario_tiss, a.cd_cgc_prestador),
	tiss_obter_grau_partic(a.ie_funcao_medico),
	a.cd_medico_executor,
	a.cd_especialidade,
	CASE WHEN ie_agrup_exame_w='N' THEN  a.nr_seq_exame  ELSE null END ,
	CASE WHEN ie_agrup_resp_cred_w='S' THEN  a.ie_responsavel_credito  ELSE null END ,
	a.ie_tecnica_utilizada,
	TISS_OBTER_REGRA_SENHA(cd_estabelecimento_w,cd_convenio_w,ie_tipo_atend_tiss_conta_w,a.ie_tiss_tipo_guia_honor,ie_senha_guia_w, a.cd_senha),
	a.tx_hora_extra,
	substr(tiss_eliminar_caractere(coalesce(tiss_obter_desc_proced(a.nr_sequencia, 0, CASE WHEN a.ie_tiss_tipo_guia_honor='4' THEN  'DS_PROC_SPSADTH' WHEN a.ie_tiss_tipo_guia_honor='5' THEN  'DS_PROC_RIH' END ),
					coalesce(a.ds_proc_tiss, coalesce(obter_desc_proc_convenio(a.nr_sequencia, null), obter_descricao_procedimento(a.cd_procedimento, a.ie_origem_proced))))), 1, 150),
	a.nr_seq_proc_interno,
	a.dt_inicio_procedimento,
	tiss_obter_data_proc(a.nr_sequencia, cd_convenio_w, ie_tipo_atendimento_w, 'N', 'F'),
	tiss_obter_data_proc(a.nr_sequencia, cd_convenio_w, ie_tipo_atendimento_w, 'N', 'I'),
	tiss_obter_data_proc(a.nr_sequencia, cd_convenio_w, ie_tipo_atendimento_w, 'N', 'F'),
	a.tx_procedimento,
	a.cd_prestador_tiss,
	CASE WHEN a.ie_tiss_tipo_guia=5 THEN  null  ELSE a.cd_cgc_prest_solic_tiss END ,
	CASE WHEN a.ie_tiss_tipo_guia=5 THEN  null  ELSE a.cd_medico_solic_tiss END ,
	CASE WHEN a.ie_tiss_tipo_guia=5 THEN  null  ELSE a.cd_medico_prof_solic_tiss END ,
	a.cd_medico_exec_tiss,
	a.ds_proc_tiss,
	a.cd_pessoa_fisica,
	a.cd_cgc_prestador,
	a.ds_prestador_tiss,
	CASE WHEN ie_reducao_acresc_w='RA' THEN  a.nr_seq_ajuste_proc WHEN ie_reducao_acresc_w='TA' THEN  a.nr_seq_ajuste_proc WHEN ie_reducao_acresc_w='AC' THEN  a.nr_seq_ajuste_proc  ELSE 0 END ,
	CASE WHEN ie_reducao_acresc_w='AC' THEN  a.nr_seq_proc_crit_hor  ELSE 0 END ,
	a.cd_edicao_amb,
	tiss_obter_desc_proced(a.nr_sequencia, 0, CASE WHEN a.ie_tiss_tipo_guia_honor='4' THEN  'DS_PROC_SPSADTH' WHEN a.ie_tiss_tipo_guia_honor='5' THEN  'DS_PROC_RIH' END ),
	CASE WHEN ie_reducao_acresc_w='TD' THEN  tiss_obter_pr_desc(a.nr_sequencia)  ELSE 0 END ,
	coalesce(CASE WHEN ie_valor_unitario_w='O' THEN  (substr(tiss_obter_dados_proc_mat(a.nr_sequencia, null, 'UP'),1,254))::numeric   ELSE 0 END ,0),
	a.ie_funcao_medico,
	obter_medico_laudo_sequencia(a.nr_laudo, 'C'),
	a.ie_tipo_atend_tiss,
	a.cd_procedimento_tuss,
	obter_se_pacote(a.nr_sequencia, a.nr_seq_proc_pacote),
	CASE WHEN ie_reducao_acresc_w='QE' THEN  a.tx_custo_oper_qt  ELSE 0 END ,
	CASE WHEN a.ie_tiss_tipo_guia=5 THEN  null  ELSE a.cd_prestador_solic_tiss END ,
	CASE WHEN a.ie_tiss_tipo_guia=5 THEN  null  ELSE a.ds_prestador_solic_tiss END ,
	a.cd_medico_honor_tiss,
	TISS_OBTER_VALOR_CAMPO_PREST(a.nr_sequencia,1),
	TISS_OBTER_VALOR_CAMPO_PREST(a.nr_sequencia,2),
	TISS_OBTER_VALOR_CAMPO_PREST(a.nr_sequencia,3),
	TISS_OBTER_VALOR_CAMPO_PREST(a.nr_sequencia,4),
	TISS_OBTER_VALOR_CAMPO_PREST(a.nr_sequencia,5),
	TISS_OBTER_VALOR_CAMPO_PREST(a.nr_sequencia,6),
	CASE WHEN ie_medico_convenio_w='S' THEN a.cd_medico_convenio  ELSE null END ,
	a.cd_cgc_prest_honor_tiss,
	CASE WHEN ie_lado_conta_w='S' THEN TISS_OBTER_LADO_PROC_PRESCR(a.nr_sequencia,a.nr_prescricao,a.nr_sequencia_prescricao)  ELSE 'N' END ,
	CASE WHEN ie_setor_exec_proc_w='S' THEN a.cd_setor_atendimento  ELSE null END ,
	CASE WHEN ie_indicacao_proc_prescr_w='S' THEN TISS_OBTER_INDIC_PROC_PRESCR(a.nr_prescricao,a.nr_sequencia_prescricao,a.ie_tiss_tipo_guia_honor)  ELSE null END ,
	TISS_OBTER_GUIA_PREST_PROC(a.nr_sequencia,NULL,'S')

union all

select	'N' ie_honorario,					-- ie_tiss_tipo_guia
	a.ie_tiss_tipo_guia,					-- gerar guia do procedimento
	CASE WHEN a.ie_tiss_tipo_guia='5' THEN  CASE WHEN ie_participante_ri_w='S' THEN  tiss_obter_se_partic(a.nr_sequencia)  ELSE 0 END  WHEN a.ie_tiss_tipo_guia='4' THEN  CASE WHEN ie_partic_spsadt_w='S' THEN  tiss_obter_se_partic(a.nr_sequencia)  ELSE 0 END  WHEN a.ie_tiss_tipo_guia='6' THEN  CASE WHEN ie_agrupar_honor_w='N' THEN  tiss_obter_se_partic(a.nr_sequencia)  ELSE 0 END   ELSE tiss_obter_se_partic(a.nr_sequencia) END ,
	ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(tiss_obter_data_proc(a.nr_sequencia, cd_convenio_w, ie_tipo_atendimento_w, 'N', 'E')),
	a.cd_procedimento,
	a.ie_origem_proced,
	sum(a.qt_procedimento),
	CASE WHEN ie_valor_desconto_w='N' THEN  CASE WHEN coalesce(a.nr_seq_proc_pacote::text, '') = '' THEN  sum(tiss_obter_valor_med_exec(a.nr_sequencia, 'N'))  ELSE sum(a.vl_procedimento) END   ELSE CASE WHEN coalesce(a.nr_seq_proc_pacote::text, '') = '' THEN  sum(tiss_obter_valor_med_exec(a.nr_sequencia, 'N'))  ELSE sum(a.vl_procedimento) END  + sum(coalesce(obter_desconto_matproc(a.nr_sequencia,'P'),0)) END  vl_procedimento,
	a.nr_cirurgia,
	a.nr_doc_convenio,
	a.ie_via_acesso,
	a.cd_procedimento_convenio,
	a.nr_seq_tiss_tabela,
	coalesce(a.cd_cgc_prestador_tiss, a.cd_cgc_prestador),
	tiss_obter_grau_partic(a.ie_funcao_medico),
	a.cd_medico_executor,					-- gerar medico honorario se a guia for de honorario
	a.cd_especialidade,
	CASE WHEN ie_agrup_exame_w='N' THEN  a.nr_seq_exame  ELSE null END ,
	sum(a.vl_medico),
	sum(a.vl_custo_operacional),
	CASE WHEN ie_agrup_resp_cred_w='S' THEN  a.ie_responsavel_credito  ELSE null END ,
	(null)::numeric  nr_seq_partic,
	a.ie_tecnica_utilizada,
	TISS_OBTER_REGRA_SENHA(cd_estabelecimento_w,cd_convenio_w,ie_tipo_atend_tiss_conta_w,a.ie_tiss_tipo_guia,ie_senha_guia_w, a.cd_senha) cd_senha,
	a.tx_hora_extra,
	substr(tiss_eliminar_caractere(coalesce(tiss_obter_desc_proced(a.nr_sequencia, 0, CASE WHEN a.ie_tiss_tipo_guia='4' THEN  'DS_PROC_SPSADT' WHEN a.ie_tiss_tipo_guia='5' THEN  'DS_PROC_RI' END ),
					coalesce(a.ds_proc_tiss, coalesce(obter_desc_proc_convenio(a.nr_sequencia, null), obter_descricao_procedimento(a.cd_procedimento, a.ie_origem_proced))))), 1, 150),
	a.nr_seq_proc_interno,
	a.dt_inicio_procedimento,
	tiss_obter_data_proc(a.nr_sequencia, cd_convenio_w, ie_tipo_atendimento_w, 'N', 'F'),  --elton os120472, alterado o a.dt_procedimento (dt_fim_proc_w), pois nao estava agrupando os procedimentos.
	tiss_obter_data_proc(a.nr_sequencia, cd_convenio_w, ie_tipo_atendimento_w, 'N', 'I'),
	tiss_obter_data_proc(a.nr_sequencia, cd_convenio_w, ie_tipo_atendimento_w, 'N', 'F'),
	a.tx_procedimento,
	a.cd_prestador_tiss,
	sum(a.vl_materiais),
	CASE WHEN a.ie_tiss_tipo_guia=5 THEN  null  ELSE a.cd_cgc_prest_solic_tiss END ,
	CASE WHEN a.ie_tiss_tipo_guia=5 THEN  null  ELSE a.cd_medico_solic_tiss END ,
	CASE WHEN a.ie_tiss_tipo_guia=5 THEN  null  ELSE a.cd_medico_prof_solic_tiss END ,
	a.cd_medico_exec_tiss,
	a.ds_proc_tiss,
	sum(a.vl_procedimento),
	a.cd_pessoa_fisica,
	a.cd_cgc_prestador cd_prestador_proc,
	a.ds_prestador_tiss,
	CASE WHEN ie_reducao_acresc_w='RA' THEN  a.nr_seq_ajuste_proc WHEN ie_reducao_acresc_w='TA' THEN  a.nr_seq_ajuste_proc WHEN ie_reducao_acresc_w='AC' THEN  a.nr_seq_ajuste_proc  ELSE 0 END  nr_seq_ajuste_proc,
	CASE WHEN ie_reducao_acresc_w='AC' THEN  a.nr_seq_proc_crit_hor  ELSE 0 END  nr_seq_crit_hor,
	null ie_beneficiario,
	a.cd_edicao_amb,
	a.ie_tipo_atend_tiss,
	tiss_obter_desc_proced(a.nr_sequencia, 0, CASE WHEN a.ie_tiss_tipo_guia='4' THEN  'DS_PROC_SPSADT' WHEN a.ie_tiss_tipo_guia='5' THEN  'DS_PROC_RI' END ),
	(null)::numeric  nr_seq_partic_adic,
	CASE WHEN ie_reducao_acresc_w='TD' THEN  tiss_obter_pr_desc(a.nr_sequencia)  ELSE 0 END  tx_desconto,
	coalesce(CASE WHEN ie_valor_unitario_w='O' THEN  (substr(tiss_obter_dados_proc_mat(a.nr_sequencia, null, 'UP'),1,254))::numeric   ELSE 0 END ,0) vl_unitario,
	a.ie_funcao_medico,
	sum(obter_valor_participante(a.nr_sequencia)),
	null,
	obter_medico_laudo_sequencia(a.nr_laudo, 'C'),
	a.cd_procedimento_tuss,
	obter_se_pacote(a.nr_sequencia, a.nr_seq_proc_pacote),
	CASE WHEN ie_reducao_acresc_w='QE' THEN  a.tx_custo_oper_qt  ELSE 0 END  tx_custo_oper_qt,
	CASE WHEN a.ie_tiss_tipo_guia=5 THEN  null  ELSE a.cd_prestador_solic_tiss END ,
	CASE WHEN a.ie_tiss_tipo_guia=5 THEN  null  ELSE a.ds_prestador_solic_tiss END ,
	a.cd_medico_honor_tiss,
	TISS_OBTER_VALOR_CAMPO_PREST(a.nr_sequencia,1),
	TISS_OBTER_VALOR_CAMPO_PREST(a.nr_sequencia,2),
	TISS_OBTER_VALOR_CAMPO_PREST(a.nr_sequencia,3),
	TISS_OBTER_VALOR_CAMPO_PREST(a.nr_sequencia,4),
	TISS_OBTER_VALOR_CAMPO_PREST(a.nr_sequencia,5),
	TISS_OBTER_VALOR_CAMPO_PREST(a.nr_sequencia,6),
	CASE WHEN ie_medico_convenio_w='S' THEN a.cd_medico_convenio  ELSE null END ,
	a.cd_cgc_prest_honor_tiss,
	CASE WHEN ie_lado_conta_w='S' THEN TISS_OBTER_LADO_PROC_PRESCR(a.nr_sequencia,a.nr_prescricao,a.nr_sequencia_prescricao)  ELSE 'N' END  ds_lado_proc,
	CASE WHEN ie_setor_exec_proc_w='S' THEN a.cd_setor_atendimento  ELSE null END  cd_setor_exec_proc,
	CASE WHEN ie_indicacao_proc_prescr_w='S' THEN TISS_OBTER_INDIC_PROC_PRESCR(a.nr_prescricao,a.nr_sequencia_prescricao,a.ie_tiss_tipo_guia)  ELSE null END  ds_indicacao_proc_prescr,
	null nr_dente,
	null ds_face_dente,
	TISS_OBTER_GUIA_PREST_PROC(a.nr_sequencia,NULL,'N') nr_guia_prest_tiss,
  null cd_regiao_boca
from	procedimento_paciente a
where	a.nr_interno_conta 				= nr_interno_conta_p
and	coalesce(a.cd_motivo_exc_conta::text, '') = ''
and	a.ie_tiss_tipo_guia 				in ('3','4','5')
and	(((ie_pacote_w = 'P') and (coalesce(a.nr_seq_proc_pacote, a.nr_sequencia) = a.nr_sequencia)) or
	 ((ie_pacote_w = 'I') and (coalesce(a.nr_seq_proc_pacote, 0) <> a.nr_sequencia)) or (ie_pacote_w = 'A'))
and	((ie_proc_partic_w = 'S') or
	 (ie_proc_partic_w = 'RI' AND a.ie_tiss_tipo_guia = '5') or  --lhalves 18/10/10 OS251262
	 (ie_proc_partic_w = 'SP' AND a.ie_tiss_tipo_guia = '4')
	)
group by a.ie_tiss_tipo_guia,
	CASE WHEN a.ie_tiss_tipo_guia='5' THEN  CASE WHEN ie_participante_ri_w='S' THEN  tiss_obter_se_partic(a.nr_sequencia)  ELSE 0 END  WHEN a.ie_tiss_tipo_guia='4' THEN  CASE WHEN ie_partic_spsadt_w='S' THEN  tiss_obter_se_partic(a.nr_sequencia)  ELSE 0 END  WHEN a.ie_tiss_tipo_guia='6' THEN  CASE WHEN ie_agrupar_honor_w='N' THEN  tiss_obter_se_partic(a.nr_sequencia)  ELSE 0 END   ELSE tiss_obter_se_partic(a.nr_sequencia) END ,
	ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(tiss_obter_data_proc(a.nr_sequencia, cd_convenio_w, ie_tipo_atendimento_w, 'N', 'E')),
	a.cd_procedimento,
	a.ie_origem_proced,
	a.nr_cirurgia,
	a.nr_doc_convenio,
	a.nr_seq_proc_pacote,
	a.ie_via_acesso,
	a.cd_procedimento_convenio,
	a.nr_seq_tiss_tabela,
	coalesce(a.cd_cgc_prestador_tiss, a.cd_cgc_prestador),
	tiss_obter_grau_partic(a.ie_funcao_medico),
	a.cd_medico_executor,
	a.cd_especialidade,
	CASE WHEN ie_agrup_exame_w='N' THEN  a.nr_seq_exame  ELSE null END ,
	CASE WHEN ie_agrup_resp_cred_w='S' THEN  a.ie_responsavel_credito  ELSE null END ,
	a.ie_tecnica_utilizada,
	TISS_OBTER_REGRA_SENHA(cd_estabelecimento_w,cd_convenio_w,ie_tipo_atend_tiss_conta_w,a.ie_tiss_tipo_guia,ie_senha_guia_w, a.cd_senha),
	a.tx_hora_extra,
	substr(tiss_eliminar_caractere(coalesce(tiss_obter_desc_proced(a.nr_sequencia, 0, CASE WHEN a.ie_tiss_tipo_guia='4' THEN  'DS_PROC_SPSADT' WHEN a.ie_tiss_tipo_guia='5' THEN  'DS_PROC_RI' END ),
					coalesce(a.ds_proc_tiss, coalesce(obter_desc_proc_convenio(a.nr_sequencia, null), obter_descricao_procedimento(a.cd_procedimento, a.ie_origem_proced))))), 1, 150),
	a.nr_seq_proc_interno,
	a.dt_inicio_procedimento,
	tiss_obter_data_proc(a.nr_sequencia, cd_convenio_w, ie_tipo_atendimento_w, 'N', 'F'),
	tiss_obter_data_proc(a.nr_sequencia, cd_convenio_w, ie_tipo_atendimento_w, 'N', 'I'),
	tiss_obter_data_proc(a.nr_sequencia, cd_convenio_w, ie_tipo_atendimento_w, 'N', 'F'),
	a.tx_procedimento,
	a.cd_prestador_tiss,
	CASE WHEN a.ie_tiss_tipo_guia=5 THEN  null  ELSE a.cd_cgc_prest_solic_tiss END ,
	CASE WHEN a.ie_tiss_tipo_guia=5 THEN  null  ELSE a.cd_medico_solic_tiss END ,
	CASE WHEN a.ie_tiss_tipo_guia=5 THEN  null  ELSE a.cd_medico_prof_solic_tiss END ,
	a.cd_medico_exec_tiss,
	a.ds_proc_tiss,
	a.cd_pessoa_fisica,
	a.cd_cgc_prestador,
	a.ds_prestador_tiss,
	CASE WHEN ie_reducao_acresc_w='RA' THEN  a.nr_seq_ajuste_proc WHEN ie_reducao_acresc_w='TA' THEN  a.nr_seq_ajuste_proc WHEN ie_reducao_acresc_w='AC' THEN  a.nr_seq_ajuste_proc  ELSE 0 END ,
	CASE WHEN ie_reducao_acresc_w='AC' THEN  a.nr_seq_proc_crit_hor  ELSE 0 END ,
	a.cd_edicao_amb,
	tiss_obter_desc_proced(a.nr_sequencia, 0, CASE WHEN a.ie_tiss_tipo_guia='4' THEN  'DS_PROC_SPSADT' WHEN a.ie_tiss_tipo_guia='5' THEN  'DS_PROC_RI' END ),
	CASE WHEN ie_reducao_acresc_w='TD' THEN  tiss_obter_pr_desc(a.nr_sequencia)  ELSE 0 END ,
	coalesce(CASE WHEN ie_valor_unitario_w='O' THEN  (substr(tiss_obter_dados_proc_mat(a.nr_sequencia, null, 'UP'),1,254))::numeric   ELSE 0 END ,0),
	a.ie_funcao_medico,
	obter_medico_laudo_sequencia(a.nr_laudo, 'C'),
	a.ie_tipo_atend_tiss,
	a.cd_procedimento_tuss,
	obter_se_pacote(a.nr_sequencia, a.nr_seq_proc_pacote),
	CASE WHEN ie_reducao_acresc_w='QE' THEN  a.tx_custo_oper_qt  ELSE 0 END ,
	CASE WHEN a.ie_tiss_tipo_guia=5 THEN  null  ELSE a.cd_prestador_solic_tiss END ,
	CASE WHEN a.ie_tiss_tipo_guia=5 THEN  null  ELSE a.ds_prestador_solic_tiss END ,
	a.cd_medico_honor_tiss,
	TISS_OBTER_VALOR_CAMPO_PREST(a.nr_sequencia,1),
	TISS_OBTER_VALOR_CAMPO_PREST(a.nr_sequencia,2),
	TISS_OBTER_VALOR_CAMPO_PREST(a.nr_sequencia,3),
	TISS_OBTER_VALOR_CAMPO_PREST(a.nr_sequencia,4),
	TISS_OBTER_VALOR_CAMPO_PREST(a.nr_sequencia,5),
	TISS_OBTER_VALOR_CAMPO_PREST(a.nr_sequencia,6),
	CASE WHEN ie_medico_convenio_w='S' THEN a.cd_medico_convenio  ELSE null END ,
	a.cd_cgc_prest_honor_tiss,
	CASE WHEN ie_lado_conta_w='S' THEN TISS_OBTER_LADO_PROC_PRESCR(a.nr_sequencia,a.nr_prescricao,a.nr_sequencia_prescricao)  ELSE 'N' END ,
	CASE WHEN ie_setor_exec_proc_w='S' THEN a.cd_setor_atendimento  ELSE null END ,
	CASE WHEN ie_indicacao_proc_prescr_w='S' THEN TISS_OBTER_INDIC_PROC_PRESCR(a.nr_prescricao,a.nr_sequencia_prescricao,a.ie_tiss_tipo_guia)  ELSE null END ,
	TISS_OBTER_GUIA_PREST_PROC(a.nr_sequencia,NULL,'N')

union all

select	'N' ie_honorario,
	a.ie_tiss_tipo_guia,					--  gerar guia do procedimento
	CASE WHEN a.ie_tiss_tipo_guia='5' THEN  CASE WHEN ie_participante_ri_w='S' THEN  tiss_obter_se_partic(a.nr_sequencia)  ELSE 0 END  WHEN a.ie_tiss_tipo_guia='4' THEN  CASE WHEN ie_partic_spsadt_w='S' THEN  tiss_obter_se_partic(a.nr_sequencia)  ELSE 0 END  WHEN a.ie_tiss_tipo_guia='6' THEN  CASE WHEN ie_agrupar_honor_w='N' THEN  tiss_obter_se_partic(a.nr_sequencia)  ELSE 0 END   ELSE tiss_obter_se_partic(a.nr_sequencia) END ,
	ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(tiss_obter_data_proc(a.nr_sequencia, cd_convenio_w, ie_tipo_atendimento_w, 'N', 'E')),
	a.cd_procedimento,
	a.ie_origem_proced,
	sum(a.qt_procedimento),
	CASE WHEN ie_valor_desconto_w='N' THEN  CASE WHEN coalesce(a.nr_seq_proc_pacote::text, '') = '' THEN  sum(b.vl_participante)  ELSE sum(a.vl_procedimento) END   ELSE CASE WHEN coalesce(a.nr_seq_proc_pacote::text, '') = '' THEN  sum(b.vl_participante)  ELSE sum(a.vl_procedimento) END  + sum(coalesce(obter_desconto_matproc(a.nr_sequencia,'P'),0)) END  vl_procedimento,
	a.nr_cirurgia,
	coalesce(b.nr_doc_honor_conv, a.nr_doc_convenio),
	a.ie_via_acesso,
	CASE WHEN b.cd_proc_conv='0' THEN  a.cd_procedimento_convenio  ELSE b.cd_proc_conv END ,
	a.nr_seq_tiss_tabela,
	coalesce(b.cd_cgc_prestador_tiss, coalesce(a.cd_cgc_prestador_tiss, a.cd_cgc_prestador)),
	tiss_obter_grau_partic(b.ie_funcao),
	b.cd_pessoa_fisica,	-- gerar medico honorario se a guia for de honorario
	b.cd_especialidade,
	CASE WHEN ie_agrup_exame_w='N' THEN  a.nr_seq_exame  ELSE null END ,
	sum(b.vl_participante) vl_medico,
	0 vl_custo_operacional,
	CASE WHEN ie_agrup_resp_cred_w='S' THEN  coalesce(b.ie_responsavel_credito, a.ie_responsavel_credito)  ELSE null END ,
	b.nr_seq_partic,
	a.ie_tecnica_utilizada,
	TISS_OBTER_REGRA_SENHA(cd_estabelecimento_w,cd_convenio_w,ie_tipo_atend_tiss_conta_w,a.ie_tiss_tipo_guia,ie_senha_guia_w, a.cd_senha) cd_senha,
	a.tx_hora_extra,
	substr(tiss_eliminar_caractere(coalesce(tiss_obter_desc_proced(a.nr_sequencia, b.nr_seq_partic, CASE WHEN a.ie_tiss_tipo_guia='4' THEN  'DS_PROC_SPSADT' WHEN a.ie_tiss_tipo_guia='5' THEN  'DS_PROC_RI' END ),
					coalesce(b.ds_proc_tiss, coalesce(coalesce(b.ds_proc_conv, obter_desc_proc_convenio(a.nr_sequencia, null)), obter_descricao_procedimento(a.cd_procedimento, a.ie_origem_proced))))), 1, 150),
	a.nr_seq_proc_interno,
	a.dt_inicio_procedimento,
	tiss_obter_data_proc(a.nr_sequencia, cd_convenio_w, ie_tipo_atendimento_w, 'N', 'F'),  --elton os120472, alterado o a.dt_procedimento (dt_fim_proc_w), pois nao estava agrupando os procedimentos.
	tiss_obter_data_proc(a.nr_sequencia, cd_convenio_w, ie_tipo_atendimento_w, 'N', 'I'),
	tiss_obter_data_proc(a.nr_sequencia, cd_convenio_w, ie_tipo_atendimento_w, 'N', 'F'),
	coalesce(b.pr_faturar,a.tx_procedimento) tx_procedimento, --OS 829245
	coalesce(b.cd_prestador_tiss, a.cd_prestador_tiss),
	sum(a.vl_materiais),
	CASE WHEN a.ie_tiss_tipo_guia=5 THEN  null  ELSE b.cd_cgc_prest_solic_tiss END ,
	CASE WHEN a.ie_tiss_tipo_guia=5 THEN  null  ELSE a.cd_medico_solic_tiss END ,
	CASE WHEN a.ie_tiss_tipo_guia=5 THEN  null  ELSE a.cd_medico_prof_solic_tiss END ,
	b.cd_medico_exec_tiss,
	b.ds_proc_tiss,
	sum(a.vl_procedimento),
	a.cd_pessoa_fisica,
	a.cd_cgc_prestador cd_prestador_proc,
	b.ds_prestador_tiss,
	CASE WHEN ie_reducao_acresc_w='RA' THEN  a.nr_seq_ajuste_proc WHEN ie_reducao_acresc_w='TA' THEN  a.nr_seq_ajuste_proc WHEN ie_reducao_acresc_w='AC' THEN  a.nr_seq_ajuste_proc  ELSE 0 END  nr_seq_ajuste_proc,
	CASE WHEN ie_reducao_acresc_w='AC' THEN  a.nr_seq_proc_crit_hor  ELSE 0 END  nr_seq_crit_hor,
	null ie_beneficiario,
	a.cd_edicao_amb,
	a.ie_tipo_atend_tiss,
	tiss_obter_desc_proced(a.nr_sequencia, b.nr_seq_partic, CASE WHEN a.ie_tiss_tipo_guia='4' THEN  'DS_PROC_SPSADT' WHEN a.ie_tiss_tipo_guia='5' THEN  'DS_PROC_RI' END ),
	(null)::numeric  nr_seq_partic_adic,
	CASE WHEN ie_reducao_acresc_w='TD' THEN  tiss_obter_pr_desc(a.nr_sequencia)  ELSE 0 END  tx_desconto,
	coalesce(CASE WHEN ie_valor_unitario_w='O' THEN  (substr(tiss_obter_dados_proc_mat(a.nr_sequencia, null, 'UP'),1,254))::numeric   ELSE 0 END ,0) vl_unitario,
	b.ie_funcao,
	sum(obter_valor_participante(a.nr_sequencia)),
	null,
	obter_medico_laudo_sequencia(a.nr_laudo, 'C'),
	a.cd_procedimento_tuss,
	obter_se_pacote(a.nr_sequencia, a.nr_seq_proc_pacote),
	CASE WHEN ie_reducao_acresc_w='QE' THEN  a.tx_custo_oper_qt  ELSE 0 END  tx_custo_oper_qt,
	CASE WHEN a.ie_tiss_tipo_guia=5 THEN  null  ELSE a.cd_prestador_solic_tiss END ,
	CASE WHEN a.ie_tiss_tipo_guia=5 THEN  null  ELSE a.ds_prestador_solic_tiss END ,
	b.cd_medico_honor_tiss,
	TISS_OBTER_VALOR_CAMPO_PREST(a.nr_sequencia,1),
	TISS_OBTER_VALOR_CAMPO_PREST(a.nr_sequencia,2),
	TISS_OBTER_VALOR_CAMPO_PREST(a.nr_sequencia,3),
	TISS_OBTER_VALOR_CAMPO_PREST(a.nr_sequencia,4),
	TISS_OBTER_VALOR_CAMPO_PREST(a.nr_sequencia,5),
	TISS_OBTER_VALOR_CAMPO_PREST(a.nr_sequencia,6),
	CASE WHEN ie_medico_convenio_w='S' THEN b.cd_medico_convenio  ELSE null END ,
	b.cd_cgc_prest_honor_tiss,
	CASE WHEN ie_lado_conta_w='S' THEN TISS_OBTER_LADO_PROC_PRESCR(a.nr_sequencia,a.nr_prescricao,a.nr_sequencia_prescricao)  ELSE 'N' END  ds_lado_proc,
	CASE WHEN ie_setor_exec_proc_w='S' THEN a.cd_setor_atendimento  ELSE null END  cd_setor_exec_proc,
	CASE WHEN ie_indicacao_proc_prescr_w='S' THEN TISS_OBTER_INDIC_PROC_PRESCR(a.nr_prescricao,a.nr_sequencia_prescricao,a.ie_tiss_tipo_guia)  ELSE null END  ds_indicacao_proc_prescr,
	null nr_dente,
	null ds_face_dente,
	TISS_OBTER_GUIA_PREST_PROC(a.nr_sequencia,b.nr_seq_partic,'N') nr_guia_prest_tiss,
  null cd_regiao_boca
from	procedimento_participante b,
	procedimento_paciente a
where	a.nr_interno_conta 				= nr_interno_conta_p
and	a.nr_sequencia					= b.nr_sequencia
and	coalesce(a.cd_motivo_exc_conta::text, '') = ''
and	((b.ie_tiss_tipo_guia 				in ('3', '4', '5')) or (ie_honor_partic_w	= 'S'))
and	(((ie_pacote_w = 'P') and (coalesce(a.nr_seq_proc_pacote, a.nr_sequencia) = a.nr_sequencia)) or
	 ((ie_pacote_w = 'I') and (coalesce(a.nr_seq_proc_pacote, 0) <> a.nr_sequencia)) or (ie_pacote_w = 'A'))
and	((ie_proc_partic_w = 'S') or
	 (ie_proc_partic_w = 'RI' AND b.ie_tiss_tipo_guia = '5') or  --lhalves 18/10/10 OS251262
	 (ie_proc_partic_w = 'SP' AND b.ie_tiss_tipo_guia = '4')
	)
and	(b.cd_pessoa_fisica IS NOT NULL AND b.cd_pessoa_fisica::text <> '')
group by a.ie_tiss_tipo_guia,
	CASE WHEN a.ie_tiss_tipo_guia='5' THEN  CASE WHEN ie_participante_ri_w='S' THEN  tiss_obter_se_partic(a.nr_sequencia)  ELSE 0 END  WHEN a.ie_tiss_tipo_guia='4' THEN  CASE WHEN ie_partic_spsadt_w='S' THEN  tiss_obter_se_partic(a.nr_sequencia)  ELSE 0 END  WHEN a.ie_tiss_tipo_guia='6' THEN  CASE WHEN ie_agrupar_honor_w='N' THEN  tiss_obter_se_partic(a.nr_sequencia)  ELSE 0 END   ELSE tiss_obter_se_partic(a.nr_sequencia) END ,
	ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(tiss_obter_data_proc(a.nr_sequencia, cd_convenio_w, ie_tipo_atendimento_w, 'N', 'E')),
	a.cd_procedimento,
	a.ie_origem_proced,
	a.nr_cirurgia,
	coalesce(b.nr_doc_honor_conv, a.nr_doc_convenio),
	a.nr_seq_proc_pacote,
	a.ie_via_acesso,
	CASE WHEN b.cd_proc_conv='0' THEN  a.cd_procedimento_convenio  ELSE b.cd_proc_conv END ,
	a.nr_seq_tiss_tabela,
	coalesce(b.cd_cgc_prestador_tiss, coalesce(a.cd_cgc_prestador_tiss, a.cd_cgc_prestador)),
	tiss_obter_grau_partic(b.ie_funcao),
	b.cd_pessoa_fisica,
	b.cd_especialidade,
	CASE WHEN ie_agrup_exame_w='N' THEN  a.nr_seq_exame  ELSE null END ,
	CASE WHEN ie_agrup_resp_cred_w='S' THEN  coalesce(b.ie_responsavel_credito, a.ie_responsavel_credito)  ELSE null END ,
	b.nr_seq_partic,
	a.ie_tecnica_utilizada,
	TISS_OBTER_REGRA_SENHA(cd_estabelecimento_w,cd_convenio_w,ie_tipo_atend_tiss_conta_w,a.ie_tiss_tipo_guia,ie_senha_guia_w, a.cd_senha),
	a.tx_hora_extra,
	substr(tiss_eliminar_caractere(coalesce(tiss_obter_desc_proced(a.nr_sequencia, b.nr_seq_partic, CASE WHEN a.ie_tiss_tipo_guia='4' THEN  'DS_PROC_SPSADT' WHEN a.ie_tiss_tipo_guia='5' THEN  'DS_PROC_RI' END ),
					coalesce(b.ds_proc_tiss, coalesce(coalesce(b.ds_proc_conv, obter_desc_proc_convenio(a.nr_sequencia, null)), obter_descricao_procedimento(a.cd_procedimento, a.ie_origem_proced))))), 1, 150),
	a.nr_seq_proc_interno,
	a.dt_inicio_procedimento,
	tiss_obter_data_proc(a.nr_sequencia, cd_convenio_w, ie_tipo_atendimento_w, 'N', 'F'),
	tiss_obter_data_proc(a.nr_sequencia, cd_convenio_w, ie_tipo_atendimento_w, 'N', 'I'),
	tiss_obter_data_proc(a.nr_sequencia, cd_convenio_w, ie_tipo_atendimento_w, 'N', 'F'),
	coalesce(b.pr_faturar,a.tx_procedimento),
	coalesce(b.cd_prestador_tiss, a.cd_prestador_tiss),
	CASE WHEN a.ie_tiss_tipo_guia=5 THEN  null  ELSE b.cd_cgc_prest_solic_tiss END ,
	CASE WHEN a.ie_tiss_tipo_guia=5 THEN  null  ELSE a.cd_medico_solic_tiss END ,
	CASE WHEN a.ie_tiss_tipo_guia=5 THEN  null  ELSE a.cd_medico_prof_solic_tiss END ,
	b.cd_medico_exec_tiss,
	b.ds_proc_tiss,
	a.cd_pessoa_fisica,
	a.cd_cgc_prestador,
	b.ds_prestador_tiss,
	CASE WHEN ie_reducao_acresc_w='RA' THEN  a.nr_seq_ajuste_proc WHEN ie_reducao_acresc_w='TA' THEN  a.nr_seq_ajuste_proc WHEN ie_reducao_acresc_w='AC' THEN  a.nr_seq_ajuste_proc  ELSE 0 END ,
	CASE WHEN ie_reducao_acresc_w='AC' THEN  a.nr_seq_proc_crit_hor  ELSE 0 END ,
	a.cd_edicao_amb,
	tiss_obter_desc_proced(a.nr_sequencia, b.nr_seq_partic, CASE WHEN a.ie_tiss_tipo_guia='4' THEN  'DS_PROC_SPSADT' WHEN a.ie_tiss_tipo_guia='5' THEN  'DS_PROC_RI' END ),
	CASE WHEN ie_reducao_acresc_w='TD' THEN  tiss_obter_pr_desc(a.nr_sequencia)  ELSE 0 END ,
	coalesce(CASE WHEN ie_valor_unitario_w='O' THEN  (substr(tiss_obter_dados_proc_mat(a.nr_sequencia, null, 'UP'),1,254))::numeric   ELSE 0 END ,0),
	b.ie_funcao,
	obter_medico_laudo_sequencia(a.nr_laudo, 'C'),
	a.ie_tipo_atend_tiss,
	a.cd_procedimento_tuss,
	obter_se_pacote(a.nr_sequencia, a.nr_seq_proc_pacote),
	CASE WHEN ie_reducao_acresc_w='QE' THEN  a.tx_custo_oper_qt  ELSE 0 END ,
	CASE WHEN a.ie_tiss_tipo_guia=5 THEN  null  ELSE a.cd_prestador_solic_tiss END ,
	CASE WHEN a.ie_tiss_tipo_guia=5 THEN  null  ELSE a.ds_prestador_solic_tiss END ,
	b.cd_medico_honor_tiss,
	TISS_OBTER_VALOR_CAMPO_PREST(a.nr_sequencia,1),
	TISS_OBTER_VALOR_CAMPO_PREST(a.nr_sequencia,2),
	TISS_OBTER_VALOR_CAMPO_PREST(a.nr_sequencia,3),
	TISS_OBTER_VALOR_CAMPO_PREST(a.nr_sequencia,4),
	TISS_OBTER_VALOR_CAMPO_PREST(a.nr_sequencia,5),
	TISS_OBTER_VALOR_CAMPO_PREST(a.nr_sequencia,6),
	CASE WHEN ie_medico_convenio_w='S' THEN b.cd_medico_convenio  ELSE null END ,
	b.cd_cgc_prest_honor_tiss,
	CASE WHEN ie_lado_conta_w='S' THEN TISS_OBTER_LADO_PROC_PRESCR(a.nr_sequencia,a.nr_prescricao,a.nr_sequencia_prescricao)  ELSE 'N' END ,
	CASE WHEN ie_setor_exec_proc_w='S' THEN a.cd_setor_atendimento  ELSE null END ,
	CASE WHEN ie_indicacao_proc_prescr_w='S' THEN TISS_OBTER_INDIC_PROC_PRESCR(a.nr_prescricao,a.nr_sequencia_prescricao,a.ie_tiss_tipo_guia)  ELSE null END ,
	TISS_OBTER_GUIA_PREST_PROC(a.nr_sequencia,b.nr_seq_partic,'N')

union all

select	'S' ie_honorario,
	b.ie_tiss_tipo_guia,		--  gerar guia do honorario (participante) do procedimento, qdo a guia do honorario nao e a mesma do procedimento
	CASE WHEN b.ie_tiss_tipo_guia='5' THEN  CASE WHEN ie_participante_ri_w='S' THEN  tiss_obter_se_partic(a.nr_sequencia)  ELSE 0 END  WHEN b.ie_tiss_tipo_guia='4' THEN  CASE WHEN ie_partic_spsadt_w='S' THEN  tiss_obter_se_partic(a.nr_sequencia)  ELSE 0 END  WHEN b.ie_tiss_tipo_guia='6' THEN  CASE WHEN ie_agrupar_honor_w='N' THEN  tiss_obter_se_partic(a.nr_sequencia)  ELSE 0 END   ELSE tiss_obter_se_partic(a.nr_sequencia) END ,
	ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(tiss_obter_data_proc(a.nr_sequencia, cd_convenio_w, ie_tipo_atendimento_w, 'N', 'E')),
	a.cd_procedimento,
	a.ie_origem_proced,
	sum(a.qt_procedimento),
	CASE WHEN ie_valor_desconto_w='N' THEN  CASE WHEN coalesce(a.nr_seq_proc_pacote::text, '') = '' THEN  sum(b.vl_participante)  ELSE sum(a.vl_procedimento) END   ELSE CASE WHEN coalesce(a.nr_seq_proc_pacote::text, '') = '' THEN  sum(b.vl_participante)  ELSE sum(a.vl_procedimento) END  + sum(coalesce(obter_desconto_matproc(a.nr_sequencia,'P'),0)) END  vl_procedimento,
	a.nr_cirurgia,
	coalesce(b.nr_doc_honor_conv, a.nr_doc_convenio),
	a.ie_via_acesso,
	CASE WHEN b.cd_proc_conv='0' THEN  a.cd_procedimento_convenio  ELSE b.cd_proc_conv END ,
	a.nr_seq_tiss_tabela,
	coalesce(b.cd_cgc_prestador_tiss, coalesce(a.cd_cgc_honorario_tiss, a.cd_cgc_prestador)),
	tiss_obter_grau_partic(a.ie_funcao_medico),
	a.cd_medico_executor,			-- gerar medico honorario se a guia for de honorario
	a.cd_especialidade,
	CASE WHEN ie_agrup_exame_w='N' THEN  a.nr_seq_exame  ELSE null END ,
	sum(b.vl_participante) vl_medico,
	sum(a.vl_custo_operacional),
	CASE WHEN ie_agrup_resp_cred_w='S' THEN  a.ie_responsavel_credito  ELSE null END ,
	b.nr_seq_partic,
	a.ie_tecnica_utilizada,
	TISS_OBTER_REGRA_SENHA(cd_estabelecimento_w,cd_convenio_w,ie_tipo_atend_tiss_conta_w,b.ie_tiss_tipo_guia,ie_senha_guia_w, a.cd_senha) cd_senha,
	a.tx_hora_extra,
	substr(tiss_eliminar_caractere(coalesce(tiss_obter_desc_proced(a.nr_sequencia, b.nr_seq_partic, CASE WHEN b.ie_tiss_tipo_guia='4' THEN  'DS_PROC_SPSADTH' WHEN b.ie_tiss_tipo_guia='5' THEN  'DS_PROC_RIH' END ),
					coalesce(b.ds_proc_tiss, coalesce(coalesce(b.ds_proc_conv, obter_desc_proc_convenio(a.nr_sequencia, null)), obter_descricao_procedimento(a.cd_procedimento, a.ie_origem_proced))))), 1, 150),
	a.nr_seq_proc_interno,
	a.dt_inicio_procedimento,
	tiss_obter_data_proc(a.nr_sequencia, cd_convenio_w, ie_tipo_atendimento_w, 'N', 'F'),  --elton os120472, alterado o a.dt_procedimento (dt_fim_proc_w), pois nao estava agrupando os procedimentos.
	tiss_obter_data_proc(a.nr_sequencia, cd_convenio_w, ie_tipo_atendimento_w, 'N', 'I'),
	tiss_obter_data_proc(a.nr_sequencia, cd_convenio_w, ie_tipo_atendimento_w, 'N', 'F'),
	coalesce(b.pr_faturar,a.tx_procedimento) tx_procedimento, --OS 829245
	coalesce(b.cd_prestador_tiss, a.cd_prestador_tiss),
	sum(a.vl_materiais),
	CASE WHEN a.ie_tiss_tipo_guia=5 THEN  null  ELSE b.cd_cgc_prest_solic_tiss END ,
	CASE WHEN a.ie_tiss_tipo_guia=5 THEN  null  ELSE a.cd_medico_solic_tiss END ,
	CASE WHEN a.ie_tiss_tipo_guia=5 THEN  null  ELSE a.cd_medico_prof_solic_tiss END ,
	b.cd_medico_exec_tiss,
	b.ds_proc_tiss,
	sum(a.vl_procedimento),
	a.cd_pessoa_fisica,
	a.cd_cgc_prestador cd_prestador_proc,
	b.ds_prestador_tiss,
	CASE WHEN ie_reducao_acresc_w='RA' THEN  a.nr_seq_ajuste_proc WHEN ie_reducao_acresc_w='TA' THEN  a.nr_seq_ajuste_proc WHEN ie_reducao_acresc_w='AC' THEN  a.nr_seq_ajuste_proc  ELSE 0 END  nr_seq_ajuste_proc,
	CASE WHEN ie_reducao_acresc_w='AC' THEN  a.nr_seq_proc_crit_hor  ELSE 0 END  nr_seq_crit_hor,
	null ie_beneficiario,
	a.cd_edicao_amb,
	a.ie_tipo_atend_tiss,
	tiss_obter_desc_proced(a.nr_sequencia, b.nr_seq_partic, CASE WHEN b.ie_tiss_tipo_guia='4' THEN  'DS_PROC_SPSADTH' WHEN b.ie_tiss_tipo_guia='5' THEN  'DS_PROC_RIH' END ),
	(null)::numeric  nr_seq_partic_adic,
	CASE WHEN ie_reducao_acresc_w='TD' THEN  tiss_obter_pr_desc(a.nr_sequencia)  ELSE 0 END  tx_desconto,
	coalesce(CASE WHEN ie_valor_unitario_w='O' THEN  (substr(tiss_obter_dados_proc_mat(a.nr_sequencia, null, 'UP'),1,254))::numeric   ELSE 0 END ,0) vl_unitario,
	b.ie_funcao,
	sum(obter_valor_participante(a.nr_sequencia)),
	null,
	obter_medico_laudo_sequencia(a.nr_laudo, 'C'),
	a.cd_procedimento_tuss,
	obter_se_pacote(a.nr_sequencia, a.nr_seq_proc_pacote),
	CASE WHEN ie_reducao_acresc_w='QE' THEN  a.tx_custo_oper_qt  ELSE 0 END  tx_custo_oper_qt,
	CASE WHEN a.ie_tiss_tipo_guia=5 THEN  null  ELSE a.cd_prestador_solic_tiss END ,
	CASE WHEN a.ie_tiss_tipo_guia=5 THEN  null  ELSE a.ds_prestador_solic_tiss END ,
	b.cd_medico_honor_tiss,
	TISS_OBTER_VALOR_CAMPO_PREST(a.nr_sequencia,1),
	TISS_OBTER_VALOR_CAMPO_PREST(a.nr_sequencia,2),
	TISS_OBTER_VALOR_CAMPO_PREST(a.nr_sequencia,3),
	TISS_OBTER_VALOR_CAMPO_PREST(a.nr_sequencia,4),
	TISS_OBTER_VALOR_CAMPO_PREST(a.nr_sequencia,5),
	TISS_OBTER_VALOR_CAMPO_PREST(a.nr_sequencia,6),
	CASE WHEN ie_medico_convenio_w='S' THEN b.cd_medico_convenio  ELSE null END ,
	b.cd_cgc_prest_honor_tiss,
	CASE WHEN ie_lado_conta_w='S' THEN TISS_OBTER_LADO_PROC_PRESCR(a.nr_sequencia,a.nr_prescricao,a.nr_sequencia_prescricao)  ELSE 'N' END  ds_lado_proc,
	CASE WHEN ie_setor_exec_proc_w='S' THEN a.cd_setor_atendimento  ELSE null END  cd_setor_exec_proc,
	CASE WHEN ie_indicacao_proc_prescr_w='S' THEN TISS_OBTER_INDIC_PROC_PRESCR(a.nr_prescricao,a.nr_sequencia_prescricao,b.ie_tiss_tipo_guia)  ELSE null END  ds_indicacao_proc_prescr,
	null nr_dente,
	null ds_face_dente,
	TISS_OBTER_GUIA_PREST_PROC(a.nr_sequencia,b.nr_seq_partic,'S') nr_guia_prest_tiss,
  null cd_regiao_boca
from	procedimento_participante b,
	procedimento_paciente a
where	a.nr_interno_conta 				= nr_interno_conta_p
and	a.nr_sequencia					= b.nr_sequencia
and	coalesce(a.cd_motivo_exc_conta::text, '') = ''
and	b.ie_tiss_tipo_guia	 			in ('4','5')
and	((coalesce(b.ie_tiss_tipo_guia, '0')		<> a.ie_tiss_tipo_guia) or
	 ((b.ie_tiss_tipo_guia = '4') and  							-- edgar 02/08/2007, os 64213
	  (tiss_obter_se_honor_spsadt(cd_convenio_w, cd_estabelecimento_w, b.ie_responsavel_credito, ie_tipo_atendimento_w, cd_setor_entrada_w, 'N') = 'S')
	 )
	)
and	(((ie_pacote_w = 'P') and (coalesce(a.nr_seq_proc_pacote, a.nr_sequencia) = a.nr_sequencia)) or
	 ((ie_pacote_w = 'I') and (coalesce(a.nr_seq_proc_pacote, 0) <> a.nr_sequencia)) or (ie_pacote_w = 'A'))
and	((ie_proc_partic_w = 'S') or
	 (ie_proc_partic_w = 'RI' AND b.ie_tiss_tipo_guia = '5') or  --lhalves 18/10/10 OS251262
	 (ie_proc_partic_w = 'SP' AND b.ie_tiss_tipo_guia = '4')
	)
and	(b.cd_pessoa_fisica IS NOT NULL AND b.cd_pessoa_fisica::text <> '')
group by b.ie_tiss_tipo_guia,
	CASE WHEN b.ie_tiss_tipo_guia='5' THEN  CASE WHEN ie_participante_ri_w='S' THEN  tiss_obter_se_partic(a.nr_sequencia)  ELSE 0 END  WHEN b.ie_tiss_tipo_guia='4' THEN  CASE WHEN ie_partic_spsadt_w='S' THEN  tiss_obter_se_partic(a.nr_sequencia)  ELSE 0 END  WHEN b.ie_tiss_tipo_guia='6' THEN  CASE WHEN ie_agrupar_honor_w='N' THEN  tiss_obter_se_partic(a.nr_sequencia)  ELSE 0 END   ELSE tiss_obter_se_partic(a.nr_sequencia) END ,
	ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(tiss_obter_data_proc(a.nr_sequencia, cd_convenio_w, ie_tipo_atendimento_w, 'N', 'E')),
	a.cd_procedimento,
	a.ie_origem_proced,
	a.nr_cirurgia,
	coalesce(b.nr_doc_honor_conv, a.nr_doc_convenio),
	a.nr_seq_proc_pacote,
	a.ie_via_acesso,
	CASE WHEN b.cd_proc_conv='0' THEN  a.cd_procedimento_convenio  ELSE b.cd_proc_conv END ,
	a.nr_seq_tiss_tabela,
	coalesce(b.cd_cgc_prestador_tiss, coalesce(a.cd_cgc_honorario_tiss, a.cd_cgc_prestador)),
	tiss_obter_grau_partic(a.ie_funcao_medico),
	a.cd_medico_executor,
	a.cd_especialidade,
	CASE WHEN ie_agrup_exame_w='N' THEN  a.nr_seq_exame  ELSE null END ,
	CASE WHEN ie_agrup_resp_cred_w='S' THEN  a.ie_responsavel_credito  ELSE null END ,
	b.nr_seq_partic,
	a.ie_tecnica_utilizada,
	TISS_OBTER_REGRA_SENHA(cd_estabelecimento_w,cd_convenio_w,ie_tipo_atend_tiss_conta_w,b.ie_tiss_tipo_guia,ie_senha_guia_w, a.cd_senha),
	a.tx_hora_extra,
	substr(tiss_eliminar_caractere(coalesce(tiss_obter_desc_proced(a.nr_sequencia, b.nr_seq_partic, CASE WHEN b.ie_tiss_tipo_guia='4' THEN  'DS_PROC_SPSADTH' WHEN b.ie_tiss_tipo_guia='5' THEN  'DS_PROC_RIH' END ),
					coalesce(b.ds_proc_tiss, coalesce(coalesce(b.ds_proc_conv, obter_desc_proc_convenio(a.nr_sequencia, null)), obter_descricao_procedimento(a.cd_procedimento, a.ie_origem_proced))))), 1, 150),
	a.nr_seq_proc_interno,
	a.dt_inicio_procedimento,
	tiss_obter_data_proc(a.nr_sequencia, cd_convenio_w, ie_tipo_atendimento_w, 'N', 'F'),
	tiss_obter_data_proc(a.nr_sequencia, cd_convenio_w, ie_tipo_atendimento_w, 'N', 'I'),
	tiss_obter_data_proc(a.nr_sequencia, cd_convenio_w, ie_tipo_atendimento_w, 'N', 'F'),
	coalesce(b.pr_faturar,a.tx_procedimento),
	coalesce(b.cd_prestador_tiss, a.cd_prestador_tiss),
	CASE WHEN a.ie_tiss_tipo_guia=5 THEN  null  ELSE b.cd_cgc_prest_solic_tiss END ,
	CASE WHEN a.ie_tiss_tipo_guia=5 THEN  null  ELSE a.cd_medico_solic_tiss END ,
	CASE WHEN a.ie_tiss_tipo_guia=5 THEN  null  ELSE a.cd_medico_prof_solic_tiss END ,
	b.cd_medico_exec_tiss,
	b.ds_proc_tiss,
	a.cd_pessoa_fisica,
	a.cd_cgc_prestador,
	b.ds_prestador_tiss,
	CASE WHEN ie_reducao_acresc_w='RA' THEN  a.nr_seq_ajuste_proc WHEN ie_reducao_acresc_w='TA' THEN  a.nr_seq_ajuste_proc WHEN ie_reducao_acresc_w='AC' THEN  a.nr_seq_ajuste_proc  ELSE 0 END ,
	CASE WHEN ie_reducao_acresc_w='AC' THEN  a.nr_seq_proc_crit_hor  ELSE 0 END ,
	a.cd_edicao_amb,
	tiss_obter_desc_proced(a.nr_sequencia, b.nr_seq_partic, CASE WHEN b.ie_tiss_tipo_guia='4' THEN  'DS_PROC_SPSADTH' WHEN b.ie_tiss_tipo_guia='5' THEN  'DS_PROC_RIH' END ),
	CASE WHEN ie_reducao_acresc_w='TD' THEN  tiss_obter_pr_desc(a.nr_sequencia)  ELSE 0 END ,
	coalesce(CASE WHEN ie_valor_unitario_w='O' THEN  (substr(tiss_obter_dados_proc_mat(a.nr_sequencia, null, 'UP'),1,254))::numeric   ELSE 0 END ,0),
	b.ie_funcao,
	obter_medico_laudo_sequencia(a.nr_laudo, 'C'),
	a.ie_tipo_atend_tiss,
	a.cd_procedimento_tuss,
	obter_se_pacote(a.nr_sequencia, a.nr_seq_proc_pacote),
	CASE WHEN ie_reducao_acresc_w='QE' THEN  a.tx_custo_oper_qt  ELSE 0 END ,
	CASE WHEN a.ie_tiss_tipo_guia=5 THEN  null  ELSE a.cd_prestador_solic_tiss END ,
	CASE WHEN a.ie_tiss_tipo_guia=5 THEN  null  ELSE a.ds_prestador_solic_tiss END ,
	b.cd_medico_honor_tiss,
	TISS_OBTER_VALOR_CAMPO_PREST(a.nr_sequencia,1),
	TISS_OBTER_VALOR_CAMPO_PREST(a.nr_sequencia,2),
	TISS_OBTER_VALOR_CAMPO_PREST(a.nr_sequencia,3),
	TISS_OBTER_VALOR_CAMPO_PREST(a.nr_sequencia,4),
	TISS_OBTER_VALOR_CAMPO_PREST(a.nr_sequencia,5),
	TISS_OBTER_VALOR_CAMPO_PREST(a.nr_sequencia,6),
	CASE WHEN ie_medico_convenio_w='S' THEN b.cd_medico_convenio  ELSE null END ,
	b.cd_cgc_prest_honor_tiss,
	CASE WHEN ie_lado_conta_w='S' THEN TISS_OBTER_LADO_PROC_PRESCR(a.nr_sequencia,a.nr_prescricao,a.nr_sequencia_prescricao)  ELSE 'N' END ,
	CASE WHEN ie_setor_exec_proc_w='S' THEN a.cd_setor_atendimento  ELSE null END ,
	CASE WHEN ie_indicacao_proc_prescr_w='S' THEN TISS_OBTER_INDIC_PROC_PRESCR(a.nr_prescricao,a.nr_sequencia_prescricao,b.ie_tiss_tipo_guia)  ELSE null END ,
	TISS_OBTER_GUIA_PREST_PROC(a.nr_sequencia,b.nr_seq_partic,'S')

union all

/* inicio alteracao -- edgar 19/02/2009, os 128872 */

select	'N' ie_honorario,
	a.ie_tiss_tipo_guia,
	CASE WHEN a.ie_tiss_tipo_guia='5' THEN  CASE WHEN ie_participante_ri_w='S' THEN  a.nr_sequencia  ELSE 0 END  WHEN a.ie_tiss_tipo_guia='4' THEN  CASE WHEN ie_partic_spsadt_w='S' THEN  a.nr_sequencia  ELSE 0 END  WHEN a.ie_tiss_tipo_guia='6' THEN  CASE WHEN ie_agrupar_honor_w='N' THEN  tiss_obter_se_partic(a.nr_sequencia)  ELSE 0 END   ELSE tiss_obter_se_partic(a.nr_sequencia) END ,
	ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(tiss_obter_data_proc(a.nr_sequencia, cd_convenio_w, ie_tipo_atendimento_w, 'N', 'E')),
	a.cd_procedimento,
	a.ie_origem_proced,
	sum(a.qt_procedimento),
	sum(b.vl_participante) vl_procedimento,
	a.nr_cirurgia,
	a.nr_doc_convenio,
	a.ie_via_acesso,
	a.cd_procedimento_convenio,
	a.nr_seq_tiss_tabela,
	coalesce(a.cd_cgc_honorario_tiss, a.cd_cgc_prestador),
	tiss_obter_grau_partic(b.ie_funcao),
	null cd_medico_executor,			-- gerar medico honorario se a guia for de honorario
	null especialidade,
	CASE WHEN ie_agrup_exame_w='N' THEN  a.nr_seq_exame  ELSE null END ,
	sum(b.vl_participante) vl_medico,
	sum(a.vl_custo_operacional),
	CASE WHEN ie_agrup_resp_cred_w='S' THEN  a.ie_responsavel_credito  ELSE null END ,
	(null)::numeric  nr_seq_partic,
	a.ie_tecnica_utilizada,
	TISS_OBTER_REGRA_SENHA(cd_estabelecimento_w,cd_convenio_w,ie_tipo_atend_tiss_conta_w,a.ie_tiss_tipo_guia,ie_senha_guia_w, a.cd_senha) cd_senha,
	a.tx_hora_extra,
	substr(tiss_eliminar_caractere(b.ds_proc_tiss), 1, 150),
	a.nr_seq_proc_interno,
	a.dt_inicio_procedimento,
	tiss_obter_data_proc(a.nr_sequencia, cd_convenio_w, ie_tipo_atendimento_w, 'N', 'F'),  --elton os120472, alterado o a.dt_procedimento (dt_fim_proc_w), pois nao estava agrupando os procedimentos.
	tiss_obter_data_proc(a.nr_sequencia, cd_convenio_w, ie_tipo_atendimento_w, 'N', 'I'),
	tiss_obter_data_proc(a.nr_sequencia, cd_convenio_w, ie_tipo_atendimento_w, 'N', 'F'),
	a.tx_procedimento,
	a.cd_prestador_tiss,
	sum(a.vl_materiais),
	CASE WHEN a.ie_tiss_tipo_guia=5 THEN  null  ELSE a.cd_cgc_prest_solic_tiss END ,
	CASE WHEN a.ie_tiss_tipo_guia=5 THEN  null  ELSE a.cd_medico_solic_tiss END ,
	CASE WHEN a.ie_tiss_tipo_guia=5 THEN  null  ELSE a.cd_medico_prof_solic_tiss END ,
	null cd_medico_exec_tiss,
	b.ds_proc_tiss,
	sum(a.vl_procedimento),
	null cd_pessoa_fisica,
	a.cd_cgc_prestador cd_prestador_proc,
	a.ds_prestador_tiss,
	CASE WHEN ie_reducao_acresc_w='RA' THEN  a.nr_seq_ajuste_proc WHEN ie_reducao_acresc_w='TA' THEN  a.nr_seq_ajuste_proc WHEN ie_reducao_acresc_w='AC' THEN  a.nr_seq_ajuste_proc  ELSE 0 END  nr_seq_ajuste_proc,
	CASE WHEN ie_reducao_acresc_w='AC' THEN  a.nr_seq_proc_crit_hor  ELSE 0 END  nr_seq_crit_hor,
	null ie_beneficiario,
	a.cd_edicao_amb,
	a.ie_tipo_atend_tiss,
	b.ds_proc_tiss,
	b.nr_sequencia nr_seq_partic_adic,
	CASE WHEN ie_reducao_acresc_w='TD' THEN  tiss_obter_pr_desc(a.nr_sequencia)  ELSE 0 END  tx_desconto,
	coalesce(CASE WHEN ie_valor_unitario_w='O' THEN  (substr(tiss_obter_dados_proc_mat(a.nr_sequencia, null, 'UP'),1,254))::numeric   ELSE 0 END ,0) vl_unitario,
	b.ie_funcao,
	sum(obter_valor_participante(a.nr_sequencia)),
	null,
	obter_medico_laudo_sequencia(a.nr_laudo, 'C'),
	a.cd_procedimento_tuss,
	obter_se_pacote(a.nr_sequencia, a.nr_seq_proc_pacote),
	CASE WHEN ie_reducao_acresc_w='QE' THEN  a.tx_custo_oper_qt  ELSE 0 END  tx_custo_oper_qt,
	CASE WHEN a.ie_tiss_tipo_guia=5 THEN  null  ELSE a.cd_prestador_solic_tiss END ,
	CASE WHEN a.ie_tiss_tipo_guia=5 THEN  null  ELSE a.ds_prestador_solic_tiss END ,
	a.cd_medico_honor_tiss,
	TISS_OBTER_VALOR_CAMPO_PREST(a.nr_sequencia,1),
	TISS_OBTER_VALOR_CAMPO_PREST(a.nr_sequencia,2),
	TISS_OBTER_VALOR_CAMPO_PREST(a.nr_sequencia,3),
	TISS_OBTER_VALOR_CAMPO_PREST(a.nr_sequencia,4),
	TISS_OBTER_VALOR_CAMPO_PREST(a.nr_sequencia,5),
	TISS_OBTER_VALOR_CAMPO_PREST(a.nr_sequencia,6),
	null cd_medico_convenio,
	null cd_cgc_prest_honor_tiss,
	CASE WHEN ie_lado_conta_w='S' THEN TISS_OBTER_LADO_PROC_PRESCR(a.nr_sequencia,a.nr_prescricao,a.nr_sequencia_prescricao)  ELSE 'N' END  ds_lado_proc,
	CASE WHEN ie_setor_exec_proc_w='S' THEN a.cd_setor_atendimento  ELSE null END  cd_setor_exec_proc,
	CASE WHEN ie_indicacao_proc_prescr_w='S' THEN TISS_OBTER_INDIC_PROC_PRESCR(a.nr_prescricao,a.nr_sequencia_prescricao,a.ie_tiss_tipo_guia)  ELSE null END  ds_indicacao_proc_prescr,
	null nr_dente,
	null ds_face_dente,
	TISS_OBTER_GUIA_PREST_PROC(a.nr_sequencia,NULL,'N') nr_guia_prest_tiss,
  null cd_regiao_boca
from	tiss_conta_partic_adic b,
	procedimento_paciente a
where	a.nr_interno_conta 				= nr_interno_conta_p
and	a.nr_sequencia					= b.nr_seq_procedimento
and	coalesce(a.cd_motivo_exc_conta::text, '') = ''
and	a.ie_tiss_tipo_guia	 			in ('4','5')
and	(((ie_pacote_w = 'P') and (coalesce(a.nr_seq_proc_pacote, a.nr_sequencia) = a.nr_sequencia)) or
	 ((ie_pacote_w = 'I') and (coalesce(a.nr_seq_proc_pacote, 0) <> a.nr_sequencia)) or (ie_pacote_w = 'A'))
and	((ie_proc_partic_w = 'S') or
	 (ie_proc_partic_w = 'RI' AND a.ie_tiss_tipo_guia = '5') or  --lhalves 18/10/10 OS251262
	 (ie_proc_partic_w = 'SP' AND a.ie_tiss_tipo_guia = '4')
	)
group by a.ie_tiss_tipo_guia,
	CASE WHEN a.ie_tiss_tipo_guia='5' THEN  CASE WHEN ie_participante_ri_w='S' THEN  a.nr_sequencia  ELSE 0 END  WHEN a.ie_tiss_tipo_guia='4' THEN  CASE WHEN ie_partic_spsadt_w='S' THEN  a.nr_sequencia  ELSE 0 END  WHEN a.ie_tiss_tipo_guia='6' THEN  CASE WHEN ie_agrupar_honor_w='N' THEN  tiss_obter_se_partic(a.nr_sequencia)  ELSE 0 END   ELSE tiss_obter_se_partic(a.nr_sequencia) END ,
	ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(tiss_obter_data_proc(a.nr_sequencia, cd_convenio_w, ie_tipo_atendimento_w, 'N', 'E')),
	a.cd_procedimento,
	a.ie_origem_proced,
	a.nr_cirurgia,
	a.nr_doc_convenio,
	a.nr_seq_proc_pacote,
	a.ie_via_acesso,
	a.cd_procedimento_convenio,
	a.nr_seq_tiss_tabela,
	coalesce(a.cd_cgc_honorario_tiss, a.cd_cgc_prestador),
	tiss_obter_grau_partic(a.ie_funcao_medico),
	CASE WHEN ie_agrup_exame_w='N' THEN  a.nr_seq_exame  ELSE null END ,
	CASE WHEN ie_agrup_resp_cred_w='S' THEN  a.ie_responsavel_credito  ELSE null END ,
	a.ie_tecnica_utilizada,
	TISS_OBTER_REGRA_SENHA(cd_estabelecimento_w,cd_convenio_w,ie_tipo_atend_tiss_conta_w,a.ie_tiss_tipo_guia,ie_senha_guia_w, a.cd_senha),
	a.tx_hora_extra,
	substr(tiss_eliminar_caractere(b.ds_proc_tiss), 1, 150),
	a.nr_seq_proc_interno,
	a.dt_inicio_procedimento,
	tiss_obter_data_proc(a.nr_sequencia, cd_convenio_w, ie_tipo_atendimento_w, 'N', 'F'),
	tiss_obter_data_proc(a.nr_sequencia, cd_convenio_w, ie_tipo_atendimento_w, 'N', 'I'),
	tiss_obter_data_proc(a.nr_sequencia, cd_convenio_w, ie_tipo_atendimento_w, 'N', 'F'),
	a.tx_procedimento,
	a.cd_prestador_tiss,
	CASE WHEN a.ie_tiss_tipo_guia=5 THEN  null  ELSE a.cd_cgc_prest_solic_tiss END ,
	CASE WHEN a.ie_tiss_tipo_guia=5 THEN  null  ELSE a.cd_medico_solic_tiss END ,
	CASE WHEN a.ie_tiss_tipo_guia=5 THEN  null  ELSE a.cd_medico_prof_solic_tiss END ,
	b.ds_proc_tiss,
	a.cd_cgc_prestador,
	a.ds_prestador_tiss,
	CASE WHEN ie_reducao_acresc_w='RA' THEN  a.nr_seq_ajuste_proc WHEN ie_reducao_acresc_w='TA' THEN  a.nr_seq_ajuste_proc WHEN ie_reducao_acresc_w='AC' THEN  a.nr_seq_ajuste_proc  ELSE 0 END ,
	CASE WHEN ie_reducao_acresc_w='AC' THEN  a.nr_seq_proc_crit_hor  ELSE 0 END ,
	a.cd_edicao_amb,
	b.ds_proc_tiss,
	b.nr_sequencia,
	CASE WHEN ie_reducao_acresc_w='TD' THEN  tiss_obter_pr_desc(a.nr_sequencia)  ELSE 0 END ,
	coalesce(CASE WHEN ie_valor_unitario_w='O' THEN  (substr(tiss_obter_dados_proc_mat(a.nr_sequencia, null, 'UP'),1,254))::numeric   ELSE 0 END ,0),
	b.ie_funcao,
	obter_medico_laudo_sequencia(a.nr_laudo, 'C'),
	a.ie_tipo_atend_tiss,
	a.cd_procedimento_tuss,
	obter_se_pacote(a.nr_sequencia, a.nr_seq_proc_pacote),
	CASE WHEN ie_reducao_acresc_w='QE' THEN  a.tx_custo_oper_qt  ELSE 0 END ,
	CASE WHEN a.ie_tiss_tipo_guia=5 THEN  null  ELSE a.cd_prestador_solic_tiss END ,
	CASE WHEN a.ie_tiss_tipo_guia=5 THEN  null  ELSE a.ds_prestador_solic_tiss END ,
	a.cd_medico_honor_tiss,
	TISS_OBTER_VALOR_CAMPO_PREST(a.nr_sequencia,1),
	TISS_OBTER_VALOR_CAMPO_PREST(a.nr_sequencia,2),
	TISS_OBTER_VALOR_CAMPO_PREST(a.nr_sequencia,3),
	TISS_OBTER_VALOR_CAMPO_PREST(a.nr_sequencia,4),
	TISS_OBTER_VALOR_CAMPO_PREST(a.nr_sequencia,5),
	TISS_OBTER_VALOR_CAMPO_PREST(a.nr_sequencia,6),
	CASE WHEN ie_lado_conta_w='S' THEN TISS_OBTER_LADO_PROC_PRESCR(a.nr_sequencia,a.nr_prescricao,a.nr_sequencia_prescricao)  ELSE 'N' END ,
	CASE WHEN ie_setor_exec_proc_w='S' THEN a.cd_setor_atendimento  ELSE null END ,
	CASE WHEN ie_indicacao_proc_prescr_w='S' THEN TISS_OBTER_INDIC_PROC_PRESCR(a.nr_prescricao,a.nr_sequencia_prescricao,a.ie_tiss_tipo_guia)  ELSE null END ,
	TISS_OBTER_GUIA_PREST_PROC(a.nr_sequencia,NULL,'N')
/* fim alteracao  -- edgar 19/02/2009, os 128872 */

union all

select	'N' ie_honorario,
	CASE WHEN x.ie_tipo_guia='C' THEN  '3'  ELSE '2' END  ie_tiss_tipo_guia,
	(null)::numeric  nr_seq_procedimento,
	ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(x.dt_referencia),
	somente_numero(lpad(c.cd_item_convenio,8,0)) cd_procedimento,
	(null)::numeric  ie_origem_proced,
	sum(a.qt_item),
	sum(a.vl_item) vl_procedimento,
	(null)::numeric  nr_cirurgia,
	a.cd_guia,
	null ie_via_acesso,
	lpad(c.cd_item_convenio,8,'0') cd_procedimento_convenio,
	coalesce(c.nr_seq_tiss_tabela,0) nr_seq_tiss_tabela,
	x.cd_cgc cd_cgc_prestador,
	tiss_obter_grau_partic(b.ie_funcao_medico),
	x.cd_medico cd_medico_executor,
	(null)::numeric  cd_especialidade,
	(null)::numeric  nr_seq_exame,
	(null)::numeric  vl_medico,
	(null)::numeric  vl_custo_operacional,
	null ie_responsavel_credito,
	(null)::numeric  nr_seq_partic,
	null ie_tecnica_utilizada,
	null cd_senha,
	(null)::numeric  tx_hora_extra,
	substr(b.ds_item, 1, 60) ds_procedimento,
	(null)::numeric  nr_seq_proc_interno,
	e.dt_entrada dt_inicio_procedimento,
	e.dt_entrada dt_procedimento,
	e.dt_entrada dt_inicio_proc,
	e.dt_entrada dt_fim_proc,
	(null)::numeric  tx_procedimento,
	null cd_prestador_tiss,
	(null)::numeric  vl_materiais,
	x.cd_cgc cd_cgc_prest_solic_tiss,
	null,
	null,
	CASE WHEN x.ie_beneficiario='C' THEN null  ELSE x.cd_medico END  cd_medico_exec_tiss,
	substr(b.ds_item, 1, 60) ds_proc_tiss,
	sum(a.vl_item),
	x.cd_medico cd_funcionario,
	null cd_prestador_proc,
	null ds_prestador_tiss,
	(null)::numeric  nr_seq_ajuste_proc,
	(null)::numeric  nr_seq_crit_hor,
	x.ie_beneficiario,
	null cd_edicao_amb,
	a.ie_tipo_atend_tiss,
	null ds_proc_esp,
	(null)::numeric  nr_seq_partic_adic,
	(null)::numeric  tx_desconto,
	(null)::numeric  vl_unitario,
	b.ie_funcao_medico,
	(null)::numeric ,
	a.cd_medico_solic,
	null,
	null,
	null cd_procedimento_tuss,
	null,
	null,
	null,
	null,
	null,
	null,
	null,
	null,
	null,
	null,
	null cd_medico_convenio,
	null cd_cgc_prest_honor_tiss,
	null ds_lado_proc,
	null cd_setor_exec_proc,
	null ds_indicacao_proc_prescr,
	null nr_dente,
	null ds_face_dente,
	null nr_guia_prest_tiss,
  null cd_regiao_boca
from	med_prot_convenio x,
	med_item_convenio c,
	med_atendimento e,
	med_item b,
	med_faturamento a
where	a.nr_seq_item		= b.nr_sequencia
and	b.nr_sequencia		= c.nr_seq_item
and	c.nr_seq_plano		= e.nr_seq_plano
and	e.nr_atendimento		= a.nr_atendimento
and	a.nr_seq_protocolo		= x.nr_sequencia
and	a.nr_atendimento		= nr_atend_med_p
and	a.nr_seq_protocolo		= nr_seq_prot_med_p
and	((coalesce(b.ie_tipo_item,3)	= 3) or (x.ie_tipo_guia	= 'C'))
group by x.cd_medico,
	ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(x.dt_referencia),
	x.ie_tipo_guia,
	e.dt_entrada,
	somente_numero(lpad(c.cd_item_convenio,8,0)),
	lpad(c.cd_item_convenio,8,'0'),
	a.cd_guia,
	tiss_obter_grau_partic(b.ie_funcao_medico),
	x.cd_cgc,
	substr(b.ds_item, 1, 60),
	x.ie_beneficiario,
	a.ie_tipo_atend_tiss,
	b.ie_funcao_medico,
	a.cd_medico_solic,
	c.nr_seq_tiss_tabela
--dsantos em 23/11/09 - gerar OPM como procedimento
union all

select	'N' ie_honorario,
	CASE WHEN qt_regra_opme_w=0 THEN '0'  ELSE CASE WHEN TISS_OBTER_REGRA_MAT_OPM(b.cd_convenio_parametro, b.cd_estabelecimento, a.cd_material, h.cd_classe_material, 					  g.cd_subgrupo_material, i.cd_grupo_material, c.ie_tipo_atendimento,a.vl_unitario)='SADT' THEN '4' WHEN TISS_OBTER_REGRA_MAT_OPM(b.cd_convenio_parametro, b.cd_estabelecimento, a.cd_material, h.cd_classe_material, 					  g.cd_subgrupo_material, i.cd_grupo_material, c.ie_tipo_atendimento,a.vl_unitario)='RI' THEN '5'  ELSE '0' END  END ,
	null,
	trunc(TISS_OBTER_DT_PER_DESP(ie_periodo_desp_w, a.ie_tiss_tipo_despesa, tiss_obter_dt_despesa(b.cd_estabelecimento, b.cd_convenio_parametro, a.dt_atendimento, b.dt_periodo_inicial, b.dt_periodo_final, 'S',b.ie_tipo_atend_conta,b.nr_interno_conta,'D',a.ie_tiss_tipo_despesa,a.cd_material,c.dt_entrada,c.dt_alta,b.DT_MESANO_REFERENCIA),ds_versao_w)),
	a.cd_material,
	null,
	sum(a.qt_material),
	CASE WHEN ie_valor_desconto_w='N' THEN  sum(coalesce(a.vl_material,0))  ELSE sum(coalesce(a.vl_material,0)) + sum(coalesce(obter_desconto_matproc(a.nr_sequencia,'M'),0)) END ,
	a.nr_cirurgia,
	a.nr_doc_convenio,
	null,
	a.cd_material_convenio,
	a.nr_seq_tiss_tabela,
	coalesce(a.cd_cgc_prestador_tiss, a.cd_cgc_prestador),
	null,
	a.cd_medico_exec_tiss,
	a.cd_especialidade,
	null,
	(null)::numeric ,
	(null)::numeric ,
	CASE WHEN ie_agrup_resp_cred_w='S' THEN  a.ie_responsavel_credito  ELSE null END ,
	(null)::numeric  nr_seq_partic,
	null,
	TISS_OBTER_REGRA_SENHA(cd_estabelecimento_w,cd_convenio_w,ie_tipo_atend_tiss_conta_w,null,ie_senha_guia_w, a.cd_senha) cd_senha,
	null,
	substr(TISS_ELIMINAR_CARACTERE(coalesce(a.ds_material_tiss, f.ds_material)),1,60),
	null,
	to_date(null),	
	to_date(null),
	TISS_OBTER_DT_PER_DESP(ie_periodo_desp_w, a.ie_tiss_tipo_despesa, tiss_obter_dt_despesa(b.cd_estabelecimento, b.cd_convenio_parametro, a.dt_conta, b.dt_periodo_inicial, b.dt_periodo_final, 'S',b.ie_tipo_atend_conta,b.nr_interno_conta,'DI',a.ie_tiss_tipo_despesa,a.cd_material,c.dt_entrada,c.dt_alta,b.DT_MESANO_REFERENCIA),ds_versao_w) dt_inicio_proc,
	TISS_OBTER_DT_PER_DESP(ie_periodo_desp_w, a.ie_tiss_tipo_despesa, tiss_obter_dt_despesa(b.cd_estabelecimento, b.cd_convenio_parametro, a.dt_conta, b.dt_periodo_inicial, b.dt_periodo_final, 'S',b.ie_tipo_atend_conta,b.nr_interno_conta,'DF',a.ie_tiss_tipo_despesa,a.cd_material,c.dt_entrada,c.dt_alta,b.DT_MESANO_REFERENCIA),ds_versao_w) dt_inicio_fim,
	a.tx_material,
	a.cd_prestador_tiss,
	(null)::numeric ,
	null,
	null,
	null,
	a.cd_medico_exec_tiss,
	a.ds_material_tiss,
	sum(a.vl_material),
	null,
	a.cd_cgc_prestador cd_prestador_proc,
	a.ds_prestador_tiss,
	null,
	null,
	null ie_beneficiario,
	null,
	null,
	null,
	(null)::numeric  nr_seq_partic_adic,
	null,
	coalesce(CASE WHEN ie_valor_unitario_w='O' THEN  (substr(tiss_obter_dados_proc_mat(null, a.nr_sequencia, 'UP'),1,254))::numeric   ELSE 0 END ,0) vl_original,
	null,
	null,
	null cd_med_solic_tasymed,
	null,
	null,
	obter_se_pacote(a.nr_sequencia, a.nr_seq_proc_pacote),
	null,
	null,
	null,
	null,
	null,
	null,
	null,
	null,
	null,
	null,
	null cd_medico_convenio,
	null cd_cgc_prest_honor_tiss,
	null ds_lado_proc,
	null cd_setor_exec_proc,
	null ds_indicacao_proc_prescr,
	null nr_dente,
	null ds_face_dente,
	null nr_guia_prest_tiss,
  null cd_regiao_boca
FROM subgrupo_material i, material h, classe_material g, atendimento_paciente c, conta_paciente b, material_atend_paciente a
LEFT OUTER JOIN mat_atend_pac_convenio f ON (a.nr_sequencia = f.nr_seq_material)
WHERE a.nr_interno_conta 			= nr_interno_conta_p and qt_regra_opme_w				> 0 and c.nr_atendimento			= b.nr_atendimento and b.nr_interno_conta				= a.nr_interno_conta  and coalesce(a.cd_motivo_exc_conta::text, '') = '' and h.cd_classe_material			= g.cd_classe_material and g.cd_subgrupo_material			= i.cd_subgrupo_material and h.cd_material				= a.cd_material and (qt_regra_opme_w = 0 or (TISS_OBTER_REGRA_MAT_OPM(b.cd_convenio_parametro, b.cd_estabelecimento, a.cd_material, h.cd_classe_material, 
					  g.cd_subgrupo_material, i.cd_grupo_material, c.ie_tipo_atendimento,a.vl_unitario) in ('RI','SADT'))) and (((ie_pacote_w = 'P') and (coalesce(a.nr_seq_proc_pacote, a.nr_sequencia) = a.nr_sequencia)) or
	 ((ie_pacote_w = 'I') and (coalesce(a.nr_seq_proc_pacote, 0) <> a.nr_sequencia)) or (ie_pacote_w = 'A')) group by trunc(TISS_OBTER_DT_PER_DESP(ie_periodo_desp_w, a.ie_tiss_tipo_despesa, tiss_obter_dt_despesa(b.cd_estabelecimento, b.cd_convenio_parametro, a.dt_atendimento, b.dt_periodo_inicial, b.dt_periodo_final, 'S',b.ie_tipo_atend_conta,b.nr_interno_conta,'D',a.ie_tiss_tipo_despesa,a.cd_material,c.dt_entrada,c.dt_alta,b.DT_MESANO_REFERENCIA),ds_versao_w)),
	CASE WHEN qt_regra_opme_w=0 THEN '0'  ELSE CASE WHEN TISS_OBTER_REGRA_MAT_OPM(b.cd_convenio_parametro, b.cd_estabelecimento, a.cd_material, h.cd_classe_material, 					  g.cd_subgrupo_material, i.cd_grupo_material, c.ie_tipo_atendimento,a.vl_unitario)='SADT' THEN '4' WHEN TISS_OBTER_REGRA_MAT_OPM(b.cd_convenio_parametro, b.cd_estabelecimento, a.cd_material, h.cd_classe_material, 					  g.cd_subgrupo_material, i.cd_grupo_material, c.ie_tipo_atendimento,a.vl_unitario)='RI' THEN '5'  ELSE '0' END  END ,
	a.cd_material,
	a.nr_cirurgia,
	a.nr_doc_convenio,
	a.cd_material_convenio,
	a.nr_seq_tiss_tabela,
	coalesce(a.cd_cgc_prestador_tiss, a.cd_cgc_prestador),
	a.cd_medico_exec_tiss,
	a.cd_especialidade,
	CASE WHEN ie_agrup_resp_cred_w='S' THEN  a.ie_responsavel_credito  ELSE null END ,
	TISS_OBTER_REGRA_SENHA(cd_estabelecimento_w,cd_convenio_w,ie_tipo_atend_tiss_conta_w,null,ie_senha_guia_w, a.cd_senha),
	substr(TISS_ELIMINAR_CARACTERE(coalesce(a.ds_material_tiss, f.ds_material)),1,60),
	TISS_OBTER_DT_PER_DESP(ie_periodo_desp_w, a.ie_tiss_tipo_despesa, tiss_obter_dt_despesa(b.cd_estabelecimento, b.cd_convenio_parametro, a.dt_conta, b.dt_periodo_inicial, b.dt_periodo_final, 'S',b.ie_tipo_atend_conta,b.nr_interno_conta,'DI',a.ie_tiss_tipo_despesa,a.cd_material,c.dt_entrada,c.dt_alta,b.DT_MESANO_REFERENCIA),ds_versao_w),
	TISS_OBTER_DT_PER_DESP(ie_periodo_desp_w, a.ie_tiss_tipo_despesa, tiss_obter_dt_despesa(b.cd_estabelecimento, b.cd_convenio_parametro, a.dt_conta, b.dt_periodo_inicial, b.dt_periodo_final, 'S',b.ie_tipo_atend_conta,b.nr_interno_conta,'DF',a.ie_tiss_tipo_despesa,a.cd_material,c.dt_entrada,c.dt_alta,b.DT_MESANO_REFERENCIA),ds_versao_w),
	a.tx_material,
	a.cd_prestador_tiss,
	a.cd_medico_exec_tiss,
	a.ds_material_tiss,
	a.cd_cgc_prestador,
	a.ds_prestador_tiss,
 	coalesce(CASE WHEN ie_valor_unitario_w='O' THEN  (substr(tiss_obter_dados_proc_mat(null, a.nr_sequencia, 'UP'),1,254))::numeric   ELSE 0 END ,0),
	obter_se_pacote(a.nr_sequencia, a.nr_seq_proc_pacote)

union all

select	'N' ie_honorario,
	a.ie_tiss_tipo_guia ie_tiss_tipo_guia,
	CASE WHEN a.ie_tiss_tipo_guia='5' THEN  CASE WHEN ie_participante_ri_w='S' THEN  a.nr_sequencia  ELSE 0 END  WHEN a.ie_tiss_tipo_guia='4' THEN  CASE WHEN ie_partic_spsadt_w='S' THEN  a.nr_sequencia  ELSE 0 END  WHEN a.ie_tiss_tipo_guia='6' THEN  CASE WHEN ie_agrupar_honor_w='N' THEN  tiss_obter_se_partic(a.nr_sequencia)  ELSE 0 END   ELSE tiss_obter_se_partic(a.nr_sequencia) END ,
	fim_dia(trunc(tiss_obter_data_proc(a.nr_sequencia, cd_convenio_w, ie_tipo_atendimento_w, 'N', 'E'))) + 1, --tem que ser o dia do pacote + 1
	c.cd_procedimento,
	c.ie_origem_proced,
	coalesce(tiss_obter_qt_proc_pacote(e.nr_interno_conta,g.cd_procedimento),1),
	coalesce(c.vl_total_item,0) * coalesce(tiss_obter_qt_proc_pacote(e.nr_interno_conta,g.cd_procedimento),1) vl_procedimento,
	a.nr_cirurgia,
	a.nr_doc_convenio,
	a.ie_via_acesso,
	obter_codigo_item_conv(e.cd_convenio_parametro,1,c.cd_procedimento,c.ie_origem_proced,'S',null,null,f.ie_tipo_atendimento,e.nr_atendimento) cd_procedimento_convenio,
	a.nr_seq_tiss_tabela,
	coalesce(a.cd_cgc_honorario_tiss, a.cd_cgc_prestador),
	null ,
	a.cd_medico_executor cd_medico_executor,			-- gerar medico honorario se a guia for de honorario
	null especialidade,
	CASE WHEN ie_agrup_exame_w='N' THEN  a.nr_seq_exame  ELSE null END ,
	null vl_medico,
	null,
	CASE WHEN ie_agrup_resp_cred_w='S' THEN  a.ie_responsavel_credito  ELSE null END ,
	(null)::numeric  nr_seq_partic,
	a.ie_tecnica_utilizada,
	TISS_OBTER_REGRA_SENHA(cd_estabelecimento_w,cd_convenio_w,ie_tipo_atend_tiss_conta_w,a.ie_tiss_tipo_guia,ie_senha_guia_w, a.cd_senha) cd_senha,
	a.tx_hora_extra,
	substr(TISS_ELIMINAR_CARACTERE(d.ds_procedimento),1,150),
	a.nr_seq_proc_interno,
	--fim_dia(a.dt_inicio_procedimento) + 1,--tem que ser o dia do pacote + 1

	--fim_dia(tiss_obter_data_proc(a.nr_sequencia, cd_convenio_w, ie_tipo_atendimento_w, 'N', 'F')) + 1,  --elton os120472, alterado o a.dt_procedimento (dt_fim_proc_w), pois nao estava agrupando os procedimentos.

	--fim_dia(tiss_obter_data_proc(a.nr_sequencia, cd_convenio_w, ie_tipo_atendimento_w, 'N', 'I')) + 1,--tem que ser o dia do pacote + 1

	--fim_dia(tiss_obter_data_proc(a.nr_sequencia, cd_convenio_w, ie_tipo_atendimento_w, 'N', 'F')) + 1,--tem que ser o dia do pacote + 1
	a.dt_procedimento,
	a.dt_procedimento,
	a.dt_procedimento,
	a.dt_procedimento,
	a.tx_procedimento,
	a.cd_prestador_tiss,
	null,
	CASE WHEN a.ie_tiss_tipo_guia=5 THEN  null  ELSE a.cd_cgc_prest_solic_tiss END ,
	CASE WHEN a.ie_tiss_tipo_guia=5 THEN  null  ELSE a.cd_medico_solic_tiss END ,
	CASE WHEN a.ie_tiss_tipo_guia=5 THEN  null  ELSE a.cd_medico_prof_solic_tiss END ,
	null cd_medico_exec_tiss,
	null,
	coalesce(c.vl_total_item,0) * coalesce(tiss_obter_qt_proc_pacote(e.nr_interno_conta,g.cd_procedimento),1),
	null cd_pessoa_fisica,
	a.cd_cgc_prestador cd_prestador_proc,
	a.ds_prestador_tiss,
	CASE WHEN ie_reducao_acresc_w='RA' THEN  a.nr_seq_ajuste_proc WHEN ie_reducao_acresc_w='TA' THEN  a.nr_seq_ajuste_proc WHEN ie_reducao_acresc_w='AC' THEN  a.nr_seq_ajuste_proc  ELSE 0 END  nr_seq_ajuste_proc,
	CASE WHEN ie_reducao_acresc_w='AC' THEN  a.nr_seq_proc_crit_hor  ELSE 0 END  nr_seq_crit_hor,
	null ie_beneficiario,
	a.cd_edicao_amb,
	a.ie_tipo_atend_tiss,
	null ,
	null nr_seq_partic_adic,
	CASE WHEN ie_reducao_acresc_w='TD' THEN  tiss_obter_pr_desc(a.nr_sequencia)  ELSE 0 END  tx_desconto,
	coalesce(c.vl_total_item,0) vl_unitario,
	null,
	null,
	null,
	obter_medico_laudo_sequencia(a.nr_laudo, 'C'),
	null,
	obter_se_pacote(a.nr_sequencia, a.nr_seq_proc_pacote),
	CASE WHEN ie_reducao_acresc_w='QE' THEN  a.tx_custo_oper_qt  ELSE 0 END  tx_custo_oper_qt,
	CASE WHEN a.ie_tiss_tipo_guia=5 THEN  null  ELSE a.cd_prestador_solic_tiss END ,
	CASE WHEN a.ie_tiss_tipo_guia=5 THEN  null  ELSE a.ds_prestador_solic_tiss END ,
	a.cd_medico_honor_tiss,
	TISS_OBTER_VALOR_CAMPO_PREST(a.nr_sequencia,1),
	TISS_OBTER_VALOR_CAMPO_PREST(a.nr_sequencia,2),
	TISS_OBTER_VALOR_CAMPO_PREST(a.nr_sequencia,3),
	TISS_OBTER_VALOR_CAMPO_PREST(a.nr_sequencia,4),
	TISS_OBTER_VALOR_CAMPO_PREST(a.nr_sequencia,5),
	TISS_OBTER_VALOR_CAMPO_PREST(a.nr_sequencia,6),
	null cd_medico_convenio,
	null cd_cgc_prest_honor_tiss,
	CASE WHEN ie_lado_conta_w='S' THEN TISS_OBTER_LADO_PROC_PRESCR(a.nr_sequencia,a.nr_prescricao,a.nr_sequencia_prescricao)  ELSE 'N' END  ds_lado_proc,
	CASE WHEN ie_setor_exec_proc_w='S' THEN a.cd_setor_atendimento  ELSE null END  cd_setor_exec_proc,
	null ds_indicacao_proc_prescr,
	null nr_dente,
	null ds_face_dente,
	null nr_guia_prest_tiss,
  null cd_regiao_boca
from	procedimento_paciente a,
	pacote_tipo_acomodacao g,
	atendimento_pacote b,
	pacote_tipo_acomod_tiss c,
	procedimento d,
	conta_paciente e,
	atendimento_paciente f	
where	a.nr_seq_proc_pacote	= a.nr_sequencia
and	a.nr_sequencia		= b.nr_seq_procedimento
and	a.nr_atendimento	= b.nr_atendimento
and	b.nr_seq_tipo_acomod	= c.nr_seq_tipo_acomod
and	c.nr_seq_tipo_acomod	= g.nr_sequencia	
and	c.cd_procedimento	= d.cd_procedimento
and	c.ie_origem_proced	= d.ie_origem_proced
and	d.ie_classificacao	= '1'
and	a.nr_interno_conta	= e.nr_interno_conta
and	e.nr_atendimento	= f.nr_atendimento
and	a.nr_interno_conta	= nr_interno_conta_p
and	coalesce(a.cd_motivo_exc_conta::text, '') = '';

c02 CURSOR FOR
SELECT	a.ie_tiss_tipo_guia,
	a.ie_funcao_medico,
	a.vl_medico,
	coalesce(a.nr_doc_convenio, cd_autorizacao_w),
	a.cd_medico_executor,
	a.cd_cbos,
	a.cd_cgc_prestador_tiss,
	a.ie_responsavel_credito,
	a.ie_regra,
	a.sg_conselho,
	a.nr_conselho,
	a.uf_conselho,
	a.cd_funcionario,
	a.cd_setor_atendimento,
	a.cd_medico_convenio
from	(
	SELECT	ie_tiss_tipo_guia,
		ie_funcao_medico,
		vl_medico,
		coalesce(nr_doc_convenio, cd_autorizacao_w) nr_doc_convenio,
		cd_medico_executor,
		tiss_obter_cbos_medico(coalesce(cd_medico_executor,cd_pessoa_fisica), cd_especialidade, ds_versao_w, cd_convenio_w) cd_cbos,
		cd_cgc_prestador_tiss,
		ie_responsavel_credito,
		'N' ie_regra,
		null sg_conselho,
		null nr_conselho,
		null uf_conselho,
		cd_pessoa_fisica cd_funcionario,
		cd_setor_atendimento,
		CASE WHEN ie_medico_convenio_w='S' THEN cd_medico_convenio  ELSE null END  cd_medico_convenio
	from	procedimento_paciente
	where	nr_sequencia		= nr_seq_proc_w
	and	((cd_medico_executor IS NOT NULL AND cd_medico_executor::text <> '') or
		 ((ie_exec_ri_w = 'S') and (ie_tiss_tipo_guia = '5') and (cd_pessoa_fisica IS NOT NULL AND cd_pessoa_fisica::text <> ''))
		)
	and	((tiss_obter_se_partic_conv(cd_estabelecimento_w, cd_convenio_w, cd_medico_executor) = 'S') or
		 ((ie_exec_ri_w = 'S') and (ie_tiss_tipo_guia = '5') and (tiss_obter_se_partic_conv(cd_estabelecimento_w, cd_convenio_w, cd_pessoa_fisica) = 'S'))
		)
	and	((ie_proc_partic_w = 'N') or
		 (ie_proc_partic_w = 'RI' AND ie_tiss_tipo_guia <> '5') or  --lhalves 18/10/10 OS251262
		 (ie_proc_partic_w = 'SP' AND ie_tiss_tipo_guia <> '4')
		)
	and	((ie_tiss_tipo_guia = '5') or (ie_partic_spsadt_w = 'S'))
	--and	((ie_enviar_partic_w = 'S') or ((ie_enviar_partic_w = 'Z') and (vl_medico > 0)))  lhalves OS 379368 em 14/11/2011
	
union all

	select	coalesce(a.ie_tiss_tipo_guia, b.ie_tiss_tipo_guia),
		a.ie_funcao,
		a.vl_conta,
		coalesce(a.nr_doc_honor_conv, cd_autorizacao_w),
		a.cd_pessoa_fisica,
		tiss_obter_cbos_medico(a.cd_pessoa_fisica, a.cd_especialidade, ds_versao_w, cd_convenio_w),
		coalesce(a.cd_cgc, coalesce(b.cd_cgc_honorario_tiss, b.cd_cgc_prestador)),
		a.ie_responsavel_credito,
		'N' ie_regra,
		null sg_conselho,
		null nr_conselho,
		null uf_conselho,
		null cd_funcionario,
		b.cd_setor_atendimento,
		CASE WHEN ie_medico_convenio_w='S' THEN a.cd_medico_convenio  ELSE null END  cd_medico_convenio
	from	procedimento_participante a,
		procedimento_paciente b
	where	b.nr_sequencia					= nr_seq_proc_w
	and	a.nr_sequencia					= b.nr_sequencia
	and	(a.cd_pessoa_fisica IS NOT NULL AND a.cd_pessoa_fisica::text <> '')
	and	tiss_obter_se_partic_conv(cd_estabelecimento_w, cd_convenio_w, a.cd_pessoa_fisica) = 'S'
	and	((ie_proc_partic_w = 'N') or
		 ((ie_proc_partic_w = 'RI') and (coalesce(a.ie_tiss_tipo_guia, b.ie_tiss_tipo_guia) <> '5')) or  --lhalves 18/10/10 OS251262
		 ((ie_proc_partic_w = 'SP') and (coalesce(a.ie_tiss_tipo_guia, b.ie_tiss_tipo_guia) <> '4'))
		)
	and	((
		(coalesce(a.ie_tiss_tipo_guia, b.ie_tiss_tipo_guia) = '5') or (ie_partic_spsadt_w = 'S')) or
		((coalesce(a.ie_tiss_tipo_guia, b.ie_tiss_tipo_guia) = '6') and (ie_honor_partic_w	= 'S'))
		)
	--and	((ie_enviar_partic_w = 'S') or ((ie_enviar_partic_w = 'Z') and (vl_conta > 0)))  lhalves OS 379368 em 14/11/2011
	
union

	select	ie_tiss_tipo_guia,
		ie_funcao_medico,
		vl_medico,
		coalesce(nr_doc_convenio, cd_autorizacao_w),
		cd_medico_executor,
		tiss_obter_cbos_medico(coalesce(cd_medico_executor,cd_pessoa_fisica), cd_especialidade, ds_versao_w, cd_convenio_w),
		cd_cgc_prestador_tiss,
		ie_responsavel_credito,
		'N' ie_regra,
		null sg_conselho,
		null nr_conselho,
		null uf_conselho,
		cd_pessoa_fisica cd_funcionario,
		cd_setor_atendimento,
		CASE WHEN ie_medico_convenio_w='S' THEN cd_medico_convenio  ELSE null END  cd_medico_convenio
	from	procedimento_paciente
	where	nr_sequencia					= nr_seq_proc_w
	and	((cd_medico_executor IS NOT NULL AND cd_medico_executor::text <> '') or
		 ((ie_exec_ri_w = 'S') and (ie_tiss_tipo_guia = '5') and (cd_pessoa_fisica IS NOT NULL AND cd_pessoa_fisica::text <> ''))
		)
	and	((tiss_obter_se_partic_conv(cd_estabelecimento_w, cd_convenio_w, cd_medico_executor) = 'S') or
		 ((ie_exec_ri_w = 'S') and (ie_tiss_tipo_guia = '5') and (tiss_obter_se_partic_conv(cd_estabelecimento_w, cd_convenio_w, cd_pessoa_fisica) = 'S'))
		)
	and	coalesce(nr_seq_partic_w::text, '') = ''
	and	((ie_proc_partic_w = 'S') or
		 (ie_proc_partic_w = 'RI' AND ie_tiss_tipo_guia = '5') or  --lhalves 18/10/10 OS251262
		 (ie_proc_partic_w = 'SP' AND ie_tiss_tipo_guia = '4')
		)
	--and	((ie_enviar_partic_w = 'S') or ((ie_enviar_partic_w = 'Z') and (vl_medico > 0)))  lhalves OS 379368 em 14/11/2011
	
union all

	select	coalesce(a.ie_tiss_tipo_guia, b.ie_tiss_tipo_guia),
		a.ie_funcao,
		a.vl_conta,
		coalesce(a.nr_doc_honor_conv, cd_autorizacao_w),
		a.cd_pessoa_fisica,
		tiss_obter_cbos_medico(a.cd_pessoa_fisica, a.cd_especialidade, ds_versao_w, cd_convenio_w),
		coalesce(a.cd_cgc, coalesce(b.cd_cgc_honorario_tiss, b.cd_cgc_prestador)),
		a.ie_responsavel_credito,
		'N' ie_regra,
		null sg_conselho,
		null nr_conselho,
		null uf_conselho,
		null cd_funcionario,
		b.cd_setor_atendimento,
		CASE WHEN ie_medico_convenio_w='S' THEN a.cd_medico_convenio  ELSE null END  cd_medico_convenio
	from	procedimento_participante a,
		procedimento_paciente b
	where	b.nr_sequencia					= nr_seq_proc_w
	and	a.nr_sequencia					= b.nr_sequencia
	and	(a.cd_pessoa_fisica IS NOT NULL AND a.cd_pessoa_fisica::text <> '')
	and	tiss_obter_se_partic_conv(cd_estabelecimento_w, cd_convenio_w, a.cd_pessoa_fisica) = 'S'
	and	a.nr_seq_partic					= nr_seq_partic_w
	and	((ie_proc_partic_w = 'S') or
		 ((ie_proc_partic_w = 'RI') and (coalesce(a.ie_tiss_tipo_guia, b.ie_tiss_tipo_guia) = '5')) or  --lhalves 18/10/10 OS251262
		 ((ie_proc_partic_w = 'SP') and (coalesce(a.ie_tiss_tipo_guia, b.ie_tiss_tipo_guia) = '4'))
		)
	--and	((ie_enviar_partic_w = 'S') or ((ie_enviar_partic_w = 'Z') and (vl_conta > 0)))  lhalves OS 379368 em 14/11/2011
	
union all

	select	b.ie_tiss_tipo_guia,
		b.ie_grau_partic,
		a.vl_procedimento,
		coalesce(a.nr_doc_convenio, cd_autorizacao_w),
		a.cd_medico_executor,
		b.cd_cbos cd_cbos,
		b.cd_cgc_prestador,
		a.ie_responsavel_credito,
		'S' ie_regra,
		b.sg_conselho,
		b.nr_conselho,
		b.uf_conselho,
		null cd_funcionario,
		null cd_setor_atendimento,
		CASE WHEN ie_medico_convenio_w='S' THEN a.cd_medico_convenio  ELSE null END  cd_medico_convenio
	from	tiss_regra_prest_equipe b,
		procedimento_paciente a
	where	a.nr_sequencia		= nr_seq_proc_w
	and	b.ie_tiss_tipo_guia	= a.ie_tiss_tipo_guia
	and	a.cd_cgc_prestador	= b.cd_cgc_prestador
	and	((coalesce(b.ie_responsavel_credito::text, '') = '') or (b.ie_responsavel_credito = a.ie_responsavel_credito))
	and	coalesce(nr_seq_partic_w::text, '') = ''
	and	(b.cd_cgc_prestador IS NOT NULL AND b.cd_cgc_prestador::text <> '')
	and	b.cd_estabelecimento	= cd_estabelecimento_w
	and	b.cd_convenio		= cd_convenio_w
	and 	((b.cd_setor_atendimento	= a.cd_setor_atendimento) or (coalesce(b.cd_setor_atendimento::text, '') = '')) /*lhalves OS256432 em 07/10/2010*/
) a
where	coalesce(nr_seq_partic_adic_w, 0) = 0
and	((ds_versao_3_w <> 'S') or (ie_tiss_tipo_guia_w <> '6'))

union all
 /*Tratamento para gerar os participantes de honorario individual para a versao 3.01.00*/
select	a.ie_tiss_tipo_guia,
	a.ie_funcao_medico,
	a.vl_medico,
	coalesce(a.nr_doc_convenio, cd_autorizacao_w),
	a.cd_medico_executor,
	a.cd_cbos,
	a.cd_cgc_prestador_tiss,
	a.ie_responsavel_credito,
	a.ie_regra,
	a.sg_conselho,
	a.nr_conselho,
	a.uf_conselho,
	a.cd_funcionario,
	a.cd_setor_atendimento,
	a.cd_medico_convenio
from	(
	select	ie_tiss_tipo_guia,
		ie_funcao_medico,
		vl_medico,
		coalesce(nr_doc_convenio, cd_autorizacao_w) nr_doc_convenio,
		cd_medico_executor,
		tiss_obter_cbos_medico(coalesce(cd_medico_executor,cd_pessoa_fisica), cd_especialidade, ds_versao_w, cd_convenio_w) cd_cbos,
		cd_cgc_prestador_tiss,
		ie_responsavel_credito,
		'N' ie_regra,
		null sg_conselho,
		null nr_conselho,
		null uf_conselho,
		cd_pessoa_fisica cd_funcionario,
		cd_setor_atendimento,
		CASE WHEN ie_medico_convenio_w='S' THEN cd_medico_convenio  ELSE null END  cd_medico_convenio
	from	procedimento_paciente
	where	nr_sequencia		= nr_seq_proc_w
	and	ie_tiss_tipo_guia	= '6'
	and	ie_honor_partic_w	= 'S'
	and	coalesce(nr_seq_partic_w::text, '') = ''
	and	(cd_medico_executor IS NOT NULL AND cd_medico_executor::text <> '')
	and	tiss_obter_se_partic_conv(cd_estabelecimento_w, cd_convenio_w, cd_medico_executor) = 'S'
	
union all
	
	select	ie_tiss_tipo_guia_honor,
		ie_funcao_medico,
		vl_medico,
		coalesce(nr_doc_convenio, cd_autorizacao_w) nr_doc_convenio,
		cd_medico_executor,
		tiss_obter_cbos_medico(coalesce(cd_medico_executor,cd_pessoa_fisica), cd_especialidade, ds_versao_w, cd_convenio_w) cd_cbos,
		cd_cgc_prestador_tiss,
		ie_responsavel_credito,
		'N' ie_regra,
		null sg_conselho,
		null nr_conselho,
		null uf_conselho,
		cd_pessoa_fisica cd_funcionario,
		cd_setor_atendimento,
		CASE WHEN ie_medico_convenio_w='S' THEN cd_medico_convenio  ELSE null END  cd_medico_convenio
	from	procedimento_paciente
	where	nr_sequencia		= nr_seq_proc_w	
	and	ie_tiss_tipo_guia_honor	= '6'
	and	ie_tiss_tipo_guia_honor <> ie_tiss_tipo_guia
	and	ie_honor_partic_w	= 'S'
	and	(cd_medico_executor IS NOT NULL AND cd_medico_executor::text <> '')
	and	coalesce(nr_seq_partic_w::text, '') = ''
	and	tiss_obter_se_partic_conv(cd_estabelecimento_w, cd_convenio_w, cd_medico_executor) = 'S'
	
union all

	select	a.ie_tiss_tipo_guia,
		a.ie_funcao,
		a.vl_participante,
		coalesce(a.nr_doc_honor_conv, cd_autorizacao_w),
		a.cd_pessoa_fisica,
		tiss_obter_cbos_medico(a.cd_pessoa_fisica, a.cd_especialidade, ds_versao_w, cd_convenio_w),
		coalesce(a.cd_cgc, coalesce(b.cd_cgc_honorario_tiss, b.cd_cgc_prestador)),
		a.ie_responsavel_credito,
		'N' ie_regra,
		null sg_conselho,
		null nr_conselho,
		null uf_conselho,
		null cd_funcionario,
		b.cd_setor_atendimento,
		CASE WHEN ie_medico_convenio_w='S' THEN a.cd_medico_convenio  ELSE null END  cd_medico_convenio
	from	procedimento_participante a,
		procedimento_paciente b
	where	b.nr_sequencia		= nr_seq_proc_w
	and	a.nr_sequencia		= b.nr_sequencia
	and	a.nr_seq_partic		= nr_seq_partic_w
	and	a.ie_tiss_tipo_guia	= '6'
	and	ie_honor_partic_w	= 'S'
	and	(a.cd_pessoa_fisica IS NOT NULL AND a.cd_pessoa_fisica::text <> '')
	and	tiss_obter_se_partic_conv(cd_estabelecimento_w, cd_convenio_w, a.cd_pessoa_fisica) = 'S'	
	
union all

	select	b.ie_tiss_tipo_guia,
		b.ie_grau_partic,
		a.vl_procedimento,
		coalesce(a.nr_doc_convenio, cd_autorizacao_w),
		a.cd_medico_executor,
		b.cd_cbos cd_cbos,
		b.cd_cgc_prestador,
		a.ie_responsavel_credito,
		'S' ie_regra,
		b.sg_conselho,
		b.nr_conselho,
		b.uf_conselho,
		null cd_funcionario,
		null cd_setor_atendimento,
		CASE WHEN ie_medico_convenio_w='S' THEN a.cd_medico_convenio  ELSE null END  cd_medico_convenio
	from	tiss_regra_prest_equipe b,
		procedimento_paciente a
	where	a.nr_sequencia		= nr_seq_proc_w
	and	b.ie_tiss_tipo_guia	= a.ie_tiss_tipo_guia
	and	a.cd_cgc_prestador	= b.cd_cgc_prestador
	and	((coalesce(b.ie_responsavel_credito::text, '') = '') or (b.ie_responsavel_credito = a.ie_responsavel_credito))
	and	coalesce(nr_seq_partic_w::text, '') = ''
	and	(b.cd_cgc_prestador IS NOT NULL AND b.cd_cgc_prestador::text <> '')
	and	b.cd_estabelecimento	= cd_estabelecimento_w
	and	b.cd_convenio		= cd_convenio_w
	and 	((b.cd_setor_atendimento	= a.cd_setor_atendimento) or (coalesce(b.cd_setor_atendimento::text, '') = '')) /*lhalves OS256432 em 07/10/2010*/
) a
where	coalesce(nr_seq_partic_adic_w, 0) = 0
and	(ds_versao_3_w = 'S' AND ie_tiss_tipo_guia_w = '6')
order by ie_funcao_medico desc;

c03 CURSOR FOR
SELECT	ie_emitir_zerado
from	tiss_regra_item_zerado
where	cd_estabelecimento				= cd_estabelecimento_w
and	coalesce(cd_convenio, cd_convenio_w)			= cd_convenio_w
and	coalesce(ie_tipo_atendimento, ie_tipo_atendimento_w) = ie_tipo_atendimento_w
and	coalesce(cd_area_procedimento, coalesce(cd_area_procedimento_w,0))	= coalesce(cd_area_procedimento_w,0)
and	coalesce(cd_especialidade, coalesce(cd_especialidade_proc_exec_w,0))	= coalesce(cd_especialidade_proc_exec_w,0)
and	coalesce(cd_grupo_proc, coalesce(cd_grupo_proc_w,0))			= coalesce(cd_grupo_proc_w,0)
and	coalesce(cd_procedimento, coalesce(cd_procedimento_w,0))			= coalesce(cd_procedimento_w,0)
and	coalesce(ie_responsavel_credito, coalesce(ie_responsavel_credito_w,'X'))	= coalesce(ie_responsavel_credito_w,'X')
and	coalesce(cd_plano_convenio, coalesce(cd_plano_convenio_w,'X'))		= coalesce(cd_plano_convenio_w,'X')
and	coalesce(ie_funcao_medico, coalesce(ie_funcao_medico_tasy_w,0))		= coalesce(ie_funcao_medico_tasy_w,0)
order 	by coalesce(cd_procedimento, 0),
	coalesce(cd_grupo_proc, 0),
	coalesce(cd_especialidade, 0),
	coalesce(cd_area_procedimento, 0),
	coalesce(cd_convenio, 0),
	coalesce(ie_tipo_atendimento, 0),
	coalesce(ie_responsavel_credito,'X') desc,
	coalesce(ie_funcao_medico,0);

c04 CURSOR FOR
SELECT	ie_grau_partic,
	cd_cgc_prestador,
	sg_conselho,
	nr_conselho,
	uf_conselho,
	cd_cbos
from	tiss_regra_prest_equipe
where	ie_tiss_tipo_guia	= ie_tiss_tipo_guia_w
and	cd_cgc_prestador	= cd_cgc_prestador_proc_w
and	cd_estabelecimento	= cd_estabelecimento_w
and	cd_convenio		= cd_convenio_w
and	((coalesce(ie_responsavel_credito::text, '') = '') or (ie_responsavel_credito = ie_responsavel_credito_w))
and 	((cd_setor_atendimento	= cd_setor_atendimento_w) or (coalesce(cd_setor_atendimento::text, '') = ''))
and	(cd_cgc_prestador IS NOT NULL AND cd_cgc_prestador::text <> '');

c05 CURSOR FOR
SELECT	CD_PROCEDIMENTO_CONVENIO,
	DS_PROCEDIMENTO_CONVENIO
from	tiss_regra_tabela_proc
where	cd_estabelecimento					= cd_estabelecimento_p
and	cd_convenio						= cd_convenio_w
and	coalesce(cd_categoria, coalesce(cd_categoria_conv_w,'X'))		= coalesce(cd_categoria_conv_w, 'X')
and 	coalesce(ie_tipo_atendimento,ie_tipo_atendimento_w) 		= ie_tipo_atendimento_w
and	coalesce(ie_clinica,coalesce(ie_clinica_w,0))			= coalesce(ie_clinica_w,0)
and	coalesce(cd_procedimento,cd_procedimento_w)			= cd_procedimento_w
and	((coalesce(cd_procedimento::text, '') = '') or (coalesce(ie_origem_proced,ie_origem_proced_w)		= ie_origem_proced_w))
and	coalesce(CD_GRUPO_PROC,cd_grupo_proc_w)			= cd_grupo_proc_w
and	coalesce(CD_ESPECIALIDADE,cd_especialidade_proc_exec_w)	= cd_especialidade_proc_exec_w
and	coalesce(CD_AREA_PROCEDIMENTO, cd_area_procedimento_w)	= cd_area_procedimento_w
and	((coalesce(ie_pacote, 'T') = 'T') or (coalesce(ie_pacote, 'T') 	= ie_proc_pacote_regra_w))
and	coalesce(dt_procedimento_w,clock_timestamp()) between dt_inicio_vigencia and coalesce(dt_fim_vigencia,to_date('01/01/2199','dd/mm/yyyy'))
and	((coalesce(IE_PROC_TUSS,'A') = 'A') or (IE_PROC_TUSS = ie_item_tuss_w))
and	coalesce(nr_seq_proc_interno,coalesce(nr_seq_proc_interno_w,0))	= 	coalesce(nr_seq_proc_interno_w,0)
and	coalesce(cd_plano, coalesce(cd_plano_convenio_w,'X'))					= coalesce(cd_plano_convenio_w,'X')
order by 	coalesce(nr_seq_proc_interno,0),
		coalesce(cd_procedimento, 0),
		coalesce(CD_GRUPO_PROC, 0),
		coalesce(CD_ESPECIALIDADE, 0),
		coalesce(CD_AREA_PROCEDIMENTO, 0),
		cd_categoria,
		ie_pacote,
		dt_inicio_vigencia,
		coalesce(IE_PROC_TUSS,'A');

c06 CURSOR FOR
SELECT 	a.ie_codigo_tuss,
	a.ie_desc_tuss
from 	tiss_regra_tuss a
where	a.cd_estabelecimento	= cd_estabelecimento_p
and 	a.cd_convenio		= cd_convenio_w
and 	a.dt_inicio_vigencia	<= dt_procedimento_w
and (exists (SELECT	1
			from	tiss_regra_tuss_filtro x
			where	x.nr_seq_regra						= a.nr_sequencia
			and	coalesce(x.ie_classif_proced,coalesce(ie_classif_proced_w,'X'))	= coalesce(ie_classif_proced_w,'X')) or
	not exists (select	1
			from	tiss_regra_tuss_filtro x
			where	x.nr_seq_regra				= a.nr_sequencia))		
order by a.dt_inicio_vigencia;

c07 CURSOR FOR
SELECT	ie_regra,
	cd_medico_solic_tiss
from	tiss_regra_medico_solic
where	cd_estabelecimento						= cd_estabelecimento_w
and	coalesce(cd_convenio, cd_convenio_w)					= cd_convenio_w
and	coalesce(ie_tipo_atendimento, coalesce(ie_tipo_atendimento_w,0))		= coalesce(ie_tipo_atendimento_w,0)
and	coalesce(ie_clinica, coalesce(ie_clinica_w,0))		= coalesce(ie_clinica_w,0)
and	coalesce(cd_setor_entrada, coalesce(cd_setor_entrada_w,0))		= coalesce(cd_setor_entrada_w,0)
and	coalesce(cd_medico_atend, coalesce(cd_medico_atend_w,'X'))		= coalesce(cd_medico_atend_w,'X')
--and	nvl(ie_autorizacao,'N')						= 'N'
and	coalesce(cd_grupo_proc,coalesce(cd_grupo_proc_w,0))			= coalesce(cd_grupo_proc_w,0)
and	coalesce(cd_especialidade,coalesce(cd_especialidade_proc_exec_w,0))	= coalesce(cd_especialidade_proc_exec_w,0)
and	coalesce(cd_area_procedimento,coalesce(cd_area_procedimento_w,0))		= coalesce(cd_area_procedimento_w,0)
and	coalesce(cd_procedimento,coalesce(cd_procedimento_w,0))			= coalesce(cd_procedimento_w,0)
and (ie_origem_proced	= ie_origem_proced_w or coalesce(ie_origem_proced::text, '') = '')
and	coalesce(ie_tipo_atend_conta,coalesce(ie_tipo_atend_conta_w,0))	= coalesce(ie_tipo_atend_conta_w,0)
order by	coalesce(cd_convenio, 0),
	coalesce(ie_tipo_atendimento, 0),
	coalesce(cd_medico_atend,'X'),
	coalesce(cd_grupo_proc,0),
	coalesce(cd_especialidade,0),
	coalesce(cd_area_procedimento,0),
	coalesce(cd_procedimento,0),
	coalesce(ie_tipo_atend_conta,0);


BEGIN

if (coalesce(nr_interno_conta_p,0) > 0) then

	begin
	select	a.cd_convenio_parametro,
		b.cd_cgc,
		b.cd_estabelecimento,
		c.ie_tipo_atendimento,
		a.cd_categoria_parametro,
		obter_medico_resp_atend(a.nr_atendimento,'C'),
		a.nr_atendimento,
		obter_setor_atendimento(a.nr_atendimento),
		a.ie_tipo_atend_conta,
		a.ie_tipo_atend_tiss,
		(obter_primeiro_setor_atend(c.nr_atendimento,'C'))::numeric ,
		(obter_clinica_atend(c.nr_atendimento, 'C'))::numeric ,
		(Obter_Classificacao_Atend(c.nr_atendimento,'C'))::numeric ,
		a.dt_mesano_referencia
	into STRICT	cd_convenio_w,
		cd_cgc_estab_w,
		cd_estabelecimento_w,
		ie_tipo_atendimento_w,
		cd_categoria_conv_w,
		cd_medico_atend_w,
		nr_atendimento_w,
		cd_setor_entrada_w,
		ie_tipo_atend_conta_w,
		ie_tipo_atend_tiss_conta_w,
		cd_setor_entrada_pac_w,
		ie_clinica_w,
		nr_seq_classif_atend_w,
		dt_mesano_referencia_w		
	from	estabelecimento b,
		atendimento_paciente c,
		conta_paciente a,
		atend_categoria_convenio x
	where	a.cd_estabelecimento		= b.cd_estabelecimento
	and	a.nr_atendimento		= c.nr_atendimento
	and	a.nr_interno_conta		= nr_interno_conta_p  LIMIT 1;
	exception
	when others then
		cd_convenio_w		:= null;
		cd_estabelecimento_w	:= null;
		nr_atendimento_w	:= null;
	end;
	
	
	select	max(IE_CARATER_INTERNACAO)
	into STRICT	ie_carater_internacao_w
	from	tiss_conta_atend
	where 	nr_interno_conta = nr_interno_conta_p;

elsif (coalesce(nr_atend_med_p,0) > 0) and (coalesce(nr_seq_prot_med_p,0) > 0) then

	select	max(c.cd_convenio),
		max(b.cd_cgc),
		max(b.cd_estabelecimento),
		max(x.cd_medico),
		max(a.nr_atendimento)
	into STRICT	cd_convenio_w,
		cd_cgc_estab_w,
		cd_estabelecimento_w,
		cd_medico_atend_w,
		nr_atendimento_med_w
	from	estabelecimento b,
		med_prot_convenio x,
		med_atendimento c,
		med_faturamento a
	where	x.nr_sequencia		= a.nr_seq_protocolo
	and	a.nr_atendimento		= c.nr_atendimento
	and	b.cd_estabelecimento	= cd_estabelecimento_p
	and	a.nr_atendimento		= nr_atend_med_p
	and	a.nr_seq_protocolo		= nr_seq_prot_med_p;

end if;

if (coalesce(nr_atendimento_w, 0) > 0) then

	nr_seq_interno_w	:= obter_atecaco_atendimento(nr_atendimento_w);
	
	begin
	select	b.cd_plano_convenio,
		b.cd_senha
	into STRICT	cd_plano_convenio_w,
		cd_senha_atend_w
	from	atend_categoria_convenio b,
		atendimento_paciente a
	where	a.nr_atendimento	= b.nr_atendimento
	and	b.nr_seq_interno	= nr_seq_interno_w	
	and	a.nr_atendimento	= nr_atendimento_w  LIMIT 1;
	exception
	when others then
		cd_plano_convenio_w	:= null;
		cd_senha_atend_w	:= null;
	end;

end if;

select	coalesce(max(ie_exec_spsadt),'N'),
	coalesce(max(ie_spsadt_zerado),'S'),
	coalesce(max(ie_ri_zerado),'S'),
	coalesce(max(ie_proc_partic),'N'),
	coalesce(max(ie_data_proc), 'CP'),
	coalesce(max(ie_senha_guia),'ACA'),
	coalesce(max(ie_desc_proc_interno), 'N'),
	coalesce(max(ie_honor_partic),'S'),
	coalesce(max(ie_partic_spsadt), 'S'),
	coalesce(max(ie_reducao_acresc), 'TH'),
	coalesce(max(ie_participante_ri), 'S'),
	coalesce(max(ie_valor_desconto), 'N'),
	coalesce(max(ie_exec_ri), 'N'),
	coalesce(max(ie_partic_conveniado), 'N'),
	coalesce(max(ie_formato_red_acres), 'V'),
	coalesce(max(ie_honor_zerado), 'S'),
	coalesce(max(ie_especialidade_exec), 'S'),
	coalesce(max(ie_valor_unitario), 'C'),
	coalesce(max(ie_agrup_resp_cred), 'S'),
	coalesce(max(ie_pacote),'P'),
	coalesce(max(ie_proc_tuss), 'N'),
	coalesce(max(ie_dt_proc_tasymed), 'D'),
	coalesce(max(ie_agrup_exame), 'N'),
	coalesce(max(ie_forcar_agrup), 'N'),
	coalesce(max(ie_membro_exec), 'N'),
	max(cd_adic_crm),
	max(ds_mascara_crm),
	coalesce(max(ie_periodo_desp), 'N'),
	coalesce(max(ie_medico_convenio),'N'),
	coalesce(max(ie_lado_conta),'N'),
	coalesce(max(ie_nao_honorario_sadt),'N'),
	coalesce(max(ie_medico_solic_atend), 'N'),
	coalesce(max(ie_gravar_log_conta),'N'),
	coalesce(max(ie_agrupar_honor),'N'),
	coalesce(max(ie_contrat_exec_hi), 'M'),
	coalesce(max(ie_setor_exec_proc),'N'),
	coalesce(max(ie_indicacao_proc_prescr),'N')
into STRICT	ie_exec_spsadt_w,
	ie_spsadt_zerado_w,
	ie_ri_zerado_w,
	ie_proc_partic_w,
	ie_data_proc_w,
	ie_senha_guia_w,
	ie_desc_proc_interno_w,
	ie_honor_partic_w,
	ie_partic_spsadt_w,
	ie_reducao_acresc_w,
	ie_participante_ri_w,
	ie_valor_desconto_w,
	ie_exec_ri_w,
	ie_partic_conveniado_w,
	ie_formato_red_acres_w,
	ie_honor_zerado_w,
	ie_especialidade_exec_w,
	ie_valor_unitario_w,
	ie_agrup_resp_cred_w,
	ie_pacote_w,
	ie_proc_tuss_w,
	ie_dt_proc_tasymed_w,
	ie_agrup_exame_w,
	ie_forcar_agrup_w,
	ie_membro_exec_w,
	ds_adicional_crm_w,
	ds_mascara_crm_w,
	ie_periodo_desp_w,
	ie_medico_convenio_w, /*lhalves OS337756 em 15/07/2011*/
	ie_lado_conta_w,
	ie_nao_honorario_sadt_w,
	ie_medico_solic_atend_w,
	ie_gravar_log_conta_w,
	ie_agrupar_honor_w,
	ie_contrat_exec_hi_w,
	ie_setor_exec_proc_w,
	ie_indicacao_proc_prescr_w
from	tiss_parametros_convenio
where	cd_convenio		= cd_convenio_w
and	cd_estabelecimento	= cd_estabelecimento_w;

select	max(tiss_obter_versao(cd_convenio_w, cd_estabelecimento_w,dt_mesano_referencia_w))
into STRICT	ds_versao_w
;

ds_versao_3_w	:= 'N';
if (obter_se_projeto_versao(0,12,ds_versao_w,0) = 'S') then
	ds_versao_3_w	:= 'S';
end if;

select  count(*)
into STRICT	qt_regra_opme_w
from 	tiss_regra_mat_opm
where	cd_convenio		= cd_convenio_w
and	cd_estabelecimento	= cd_estabelecimento_w
and	ie_opm in ('SADT','RI');

open c01;
loop
fetch c01 into
	ie_honorario_w,
	ie_tiss_tipo_guia_w,
	nr_seq_proc_w,
	dt_procedimento_w,
	cd_procedimento_w,
	ie_origem_proced_w,
	qt_procedimento_w,
	vl_procedimento_w,
	nr_cirurgia_w,
	cd_autorizacao_w,
	ie_via_acesso_w,
	cd_proc_conv_w,
	nr_seq_tiss_tabela_w,
	cd_cgc_prestador_w,
	ie_funcao_medico_proc_w,
	cd_medico_exec_proc_w,
	cd_especialidade_proc_w,
	nr_seq_exame_w,
	vl_medico_w,
	vl_custo_operacional_w,
	ie_responsavel_credito_w,
	nr_seq_partic_w,
	ie_tecnica_utilizada_w,
	cd_senha_w,
	tx_hora_extra_w,
	ds_procedimento_w,
	nr_seq_proc_interno_w,
	dt_inicio_proc_w,
	dt_fim_proc_w,
	dt_inicio_w,
	dt_fim_w,
	tx_procedimento_w,
	cd_prestador_tiss_w,
	vl_materiais_w,
	cd_cgc_prest_solic_tiss_w,
	cd_medico_solic_tiss_w,
	cd_medico_prof_solic_tiss_w,
	cd_medico_exec_tiss_w,
	ds_proc_tiss_w,
	vl_proced_regra_w,
	cd_funcionario_w,
	cd_cgc_prestador_proc_w,
	ds_prestador_tiss_w,
	nr_seq_ajuste_proc_w,
	nr_seq_crit_hor_w,
	ie_beneficiario_med_w,
	cd_edicao_w,
	ie_tipo_atend_tiss_w,
	ds_proc_esp_w,
	nr_seq_partic_adic_w,
	tx_desconto_w,
	vl_original_w,
	ie_funcao_medico_tasy_w,
	vl_partic_w,
	cd_med_solic_tasymed_w,
	cd_medico_laudo_w,
	cd_procedimento_tuss_w,
	ie_proc_pacote_w,
	tx_custo_oper_qt_w,
	cd_prestador_solic_w,
	ds_prestador_solic_w,
	cd_medico_honor_tiss_w,
	w_40ASADT_w,
	w_41SADT_w,
	w_40ASADTH_w,
	w_41SADTH_w,
	w_45ASADT_w,
	w_45ASADTH_w,
	cd_medico_convenio_proc_w,
	cd_cgc_prest_honor_tiss_w,
	ds_lado_proc_w,
	cd_setor_exec_proc_w,
	ds_indicacao_proc_prescr_w,
	nr_dente_w,
	ds_face_dente_w,
	nr_guia_prestador_w,
  cd_regiao_boca_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	
	
	cd_medico_exec_proc_honor_w	:= null;

	if (coalesce(ds_versao_w,'0') <> '0') then
		ie_tipo_atend_tiss_w	:= lpad(ie_tipo_atend_tiss_w, 2, 0);
	end if;	

	if (ie_senha_guia_w		not in ('P','PM')) and (coalesce(nr_interno_conta_p,0)	> 0) then
		
		cont_w	:= 0;
		if (cd_autorizacao_w IS NOT NULL AND cd_autorizacao_w::text <> '') then
		
			begin
			select	count(1)
			into STRICT	cont_w
			from	autorizacao_convenio a
			where	a.nr_atendimento	= nr_atendimento_w
			and	a.cd_autorizacao	= cd_autorizacao_w  LIMIT 1;
			exception
			when others then
				cont_w	:= 0;
			end;
		
		end if;
		

		if (cont_w > 0) then

			select	coalesce(cd_senha_w, max(a.cd_senha))  -- edgar 05/10/2007 os 70032, tratar senha do procedimento
			into STRICT	cd_senha_w
			from	autorizacao_convenio a
			where	a.nr_atendimento	= nr_atendimento_w
			and	a.cd_autorizacao	= cd_autorizacao_w
			and	a.nr_sequencia		=
				(SELECT		max(x.nr_sequencia)
				from		autorizacao_convenio x
				where		x.nr_atendimento		= a.nr_atendimento
				and		x.cd_autorizacao		= a.cd_autorizacao
				and		dt_procedimento_w between coalesce(x.dt_inicio_vigencia,dt_procedimento_w) and coalesce(x.dt_fim_vigencia,dt_procedimento_w));
		else
			select	coalesce(cd_senha_w, max(cd_senha))  -- edgar 05/10/2007 os 70032, tratar senha do procedimento
			into STRICT	cd_senha_w
			from	atend_categoria_convenio
			where	nr_atendimento	= nr_atendimento_w
			and	cd_convenio	= cd_convenio_w
			and	nr_seq_interno	= nr_seq_interno_w;
		end if;
		
		if (coalesce(cd_senha_w::text, '') = '') then
			select	max(cd_senha)
			into STRICT	cd_senha_w
			from	atend_categoria_convenio
			where	nr_atendimento	= nr_atendimento_w
			and	cd_convenio	= cd_convenio_w
			and	nr_seq_interno	= nr_seq_interno_w;
		end if;

	end if;

	cd_senha_w := tiss_obter_regra_campo_proc(cd_senha_w, '6', cd_convenio_w, cd_estabelecimento_w, cd_procedimento_w, ie_origem_proced_w, null,cd_categoria_conv_w, cd_plano_convenio_w,ie_tipo_atendimento_w,ie_carater_internacao_w, ie_tiss_tipo_guia_w);

	if (coalesce(cd_cgc_prestador_w::text, '') = '') then
		cd_cgc_prestador_w		:= cd_cgc_estab_w;
	end if;

	-- dsantos em 09/07/2009, os150547 -> se houver medico executor tiss, nao deve haver cd_cgc_prestador, da mesma forma que para os procedimento.	
	if (cd_medico_exec_tiss_w IS NOT NULL AND cd_medico_exec_tiss_w::text <> '') or (cd_medico_honor_tiss_w IS NOT NULL AND cd_medico_honor_tiss_w::text <> '') then
		cd_cgc_prestador_w	:= null;
	end if;

	SELECT * FROM tiss_obter_regra_valor_proc(cd_estabelecimento_w, cd_convenio_w, ie_tiss_tipo_guia_w, cd_cgc_prestador_w, ie_responsavel_credito_w, cd_procedimento_w, ie_origem_proced_w, vl_medico_w, vl_custo_operacional_w, vl_materiais_w, vl_procedimento_w, ie_regra_valor_w, 0, ie_funcao_medico_tasy_w, vl_partic_w, ie_honorario_w, nr_seq_proc_w, cd_plano_convenio_w, dt_procedimento_w, ie_proc_pacote_w) INTO STRICT vl_procedimento_w, ie_regra_valor_w;

	if (cd_medico_exec_tiss_w IS NOT NULL AND cd_medico_exec_tiss_w::text <> '') then
		cd_cgc_prestador_w	:= null;
	end if;

	
	select	max(cd_area_procedimento),
		max(cd_especialidade),
		max(cd_grupo_proc),
		max(ie_classificacao)
	into STRICT	cd_area_procedimento_w,
		cd_especialidade_proc_exec_w,
		cd_grupo_proc_w,
		ie_classif_proced_w
	from	estrutura_procedimento_v
	where	cd_procedimento		= cd_procedimento_w
	and	ie_origem_proced	= ie_origem_proced_w;
	
	
	ie_guia_operadora_w := Obter_Tiss_Guia_Operadora(ie_tipo_atendimento_w, ie_tiss_tipo_guia_w, nm_usuario_p, cd_convenio_w, cd_setor_entrada_w, cd_area_procedimento_w, cd_especialidade_proc_exec_w, cd_grupo_proc_w, cd_procedimento_w, ie_origem_proced_w, ie_guia_operadora_w);
					
	if (ie_guia_operadora_w = 'S') then
		nr_guia_operadora_w := cd_senha_w;
	elsif (ie_guia_operadora_w = 'A') then
		nr_guia_operadora_w := cd_senha_atend_w;
	else	
		nr_guia_operadora_w := null;
	end if;
	

	/*lhalves OS208454 em 17/04/2010 - incluido ie_tiss_tipo_guia_w	'5', para aplicar a regra de geracao de itens zerador tambem para RI*/

	ie_emitir_spsadt_zerado_w		:= ie_spsadt_zerado_w;
	if	(ie_tiss_tipo_guia_w	= '4' AND ie_spsadt_zerado_w	= 'R') or
		(ie_tiss_tipo_guia_w	= '5' AND ie_ri_zerado_w	= 'R') then
		ie_emitir_spsadt_zerado_w		:= 'S';
		open c03;
		loop
		fetch c03 into
			ie_emitir_spsadt_zerado_w;
		EXIT WHEN NOT FOUND; /* apply on c03 */
		end loop;
		close c03;
	end if;
	
	
	if (ie_tiss_tipo_guia_w = '3') or (ie_tiss_tipo_guia_w = '2') or
		((ie_honorario_w	= 'S') and
		 ((ie_tiss_tipo_guia_w	<> '6') or
		  ((vl_procedimento_w	<> 0) or (ie_honor_zerado_w	= 'S'))
		 )
		) or
		((vl_procedimento_w	<> 0) or
		 (ie_tiss_tipo_guia_w	= '6' AND ie_honor_zerado_w = 'S') or
		 ((ie_tiss_tipo_guia_w	= '4') and (ie_emitir_spsadt_zerado_w in ('S','ZX'))) or
		 ((ie_tiss_tipo_guia_w	= '5') and ((ie_ri_zerado_w in ('S','G','ZX')) or (ie_emitir_spsadt_zerado_w in ('S','ZX')))))
		or 
		((qt_procedimento_w 	<> 0) and (ie_tiss_tipo_guia_w in ('4','5') and (ie_emitir_spsadt_zerado_w = 'Q'))) then

		cd_medico_executor_w				:= null;
		cd_especialidade_w				:= null;
		cd_cbo_exec_w					:= null;
		ie_funcao_medico_w				:= null;
		cd_medico_convenio_tiss_w			:= null;
		
		if (ie_tiss_tipo_guia_w = '6') then				-- so gravar medico se for proc de honorario
			cd_medico_executor_w			:= cd_medico_exec_proc_w;
			cd_especialidade_w			:= cd_especialidade_proc_w;
			ie_funcao_medico_w			:= ie_funcao_medico_proc_w;			
			cd_cbo_exec_w				:= tiss_obter_cbos_medico(cd_medico_executor_w, cd_especialidade_w, ds_versao_w, cd_convenio_w);
			
			if (coalesce(ie_contrat_exec_hi_w,'M') = 'R') and (coalesce(nr_seq_proc_w,0) > 0) then
			
				SELECT * FROM tiss_obter_regra_exec_honor(	cd_estabelecimento_w, cd_convenio_w, ie_responsavel_credito_w, cd_setor_entrada_pac_w, cd_medico_exec_proc_w, ie_regra_exec_honor_w, ds_irrelevante_w, ds_irrelevante_w, 'N', lpad(ie_funcao_medico_w,2,'0'), ds_irrelevante_w, ds_irrelevante_w, nr_seq_regra_exec_honor_w) INTO STRICT ie_regra_exec_honor_w, ds_irrelevante_w, ds_irrelevante_w, ds_irrelevante_w, ds_irrelevante_w, nr_seq_regra_exec_honor_w;
								
				if (ie_gravar_log_conta_w = 'S') then
					CALL TISS_GERAR_LOG_CONTA(	nr_interno_conta_p,
								'Regra Contratado Honor (Gerar conta proc)  > '||
								' Seq Proc Paci: '||nr_seq_proc_w||								
								' Resp Credito: '||ie_responsavel_credito_w||
								' medico Guia: '||cd_medico_exec_proc_w||
								' Funcao medico: '||lpad(ie_funcao_medico_w,2,'0')||
								' Retorno Regra > '||
								' Regra Exec: '||ie_regra_exec_honor_w,
								nm_usuario_p);
				end if;				
								
				if (ie_regra_exec_honor_w = 'E') then
					
					select	max(cd_medico_executor)
					into STRICT	cd_medico_exec_proc_honor_w
					from	procedimento_paciente
					where	nr_sequencia	= nr_seq_proc_w;
				
				end if;
				
				if (nr_seq_regra_exec_honor_w IS NOT NULL AND nr_seq_regra_exec_honor_w::text <> '') and (ds_versao_3_w = 'S') then
				
					--Se e a versao 3 e foi feita a regra por funcao, entao grava a funcao no ie_funcao_medico_w, caso contrario, ele deve ficar null para nao ter problema de agrupamento na TISS_GERAR_CONTA_GUI
					select	max(ie_funcao_medico_proc_w)
					into STRICT	ie_funcao_medico_w
					from	tiss_regra_exec_honor
					where	nr_sequencia		= nr_seq_regra_exec_honor_w
					and	(ie_grau_partic_tiss IS NOT NULL AND ie_grau_partic_tiss::text <> '');
				end if;	
			else
				if (ds_versao_3_w = 'S') then --Se for versao 3 e nao for por regra, entao fica sempre null para nao ter problema de agrupamento na TISS_GERAR_CONTA_GUI
					ie_funcao_medico_w	:= null;				
				end if;				
			end if;			
			
		elsif (ie_tiss_tipo_guia_w = '4') then
		
			cd_medico_executor_solic_w := cd_medico_exec_proc_w;
			
			if (ie_exec_spsadt_w = 'R') then

				if (ie_honorario_w = 'N') then
					ie_resp_credito_regra_w	:= null;
				else
					ie_resp_credito_regra_w	:= ie_responsavel_credito_w;
				end if;

				SELECT * FROM tiss_obter_regra_exec_compl(	cd_convenio_w, cd_estabelecimento_w, cd_procedimento_w, ie_origem_proced_w, cd_area_procedimento_w, cd_especialidade_proc_exec_w, cd_grupo_proc_w, ie_tipo_atendimento_w, cd_setor_entrada_w, ie_resp_credito_regra_w, ie_tiss_tipo_guia_w, cd_medico_exec_proc_w, ie_envio_w, cd_medico_exec_regra_w, cd_setor_entrada_pac_w, cd_setor_exec_proc_w) INTO STRICT ie_envio_w, cd_medico_exec_regra_w;
								
				

				if (ie_envio_w	= 'ME') then
					cd_medico_executor_w 	:= coalesce(cd_medico_solic_tiss_w, cd_medico_exec_proc_w);
					
					select	CASE WHEN coalesce(cd_medico_executor_w::text, '') = '' THEN  null  ELSE ie_funcao_medico_proc_w END
					into STRICT	ie_func_medico_w
					;
					
					ie_funcao_medico_w	:= ie_func_medico_w;
					
					/*Se medico definido pela regra diferente do medico executor do procedimento, busca a especialidade da function OBTER_ESPECIALIDADE_MEDICO*/

					if (cd_medico_executor_w <> cd_medico_exec_proc_w) then
						cd_especialidade_w	:= obter_especialidade_medico(cd_medico_executor_w, 'C');
					else --Se nao, pega a especialidade do procedimento
						cd_especialidade_w	:= cd_especialidade_proc_w;
					end if;				

					cd_cbo_exec_w		:= tiss_obter_cbos_medico(cd_medico_executor_w, cd_especialidade_w, ds_versao_w, cd_convenio_w);				
										
				elsif (ie_envio_w	= 'MA') then
					cd_medico_executor_w		:= coalesce(cd_medico_solic_tiss_w, cd_medico_atend_w);
					
					/*Se medico definido pela regra diferente do medico executor do procedimento, busca a especialidade da function OBTER_ESPECIALIDADE_MEDICO*/

					if (cd_medico_executor_w <> cd_medico_exec_proc_w) then
						cd_especialidade_w	:= obter_especialidade_medico(cd_medico_executor_w, 'C');
					else --Se nao, pega a especialidade do procedimento
						cd_especialidade_w	:= cd_especialidade_proc_w;
					end if;
					
					ie_funcao_medico_w		:= null;
					cd_cbo_exec_w			:= tiss_obter_cbos_medico(cd_medico_executor_w, cd_especialidade_w, ds_versao_w, cd_convenio_w);
					
										
				elsif (ie_envio_w	= 'IR') then
					cd_medico_executor_w		:= coalesce(cd_medico_exec_regra_w, cd_medico_exec_proc_w);
					
					select	CASE WHEN coalesce(cd_medico_exec_regra_w::text, '') = '' THEN  null  ELSE ie_funcao_medico_proc_w END
					into STRICT	ie_func_medico_w
					;
					
					ie_funcao_medico_w		:= ie_func_medico_w;
					cd_especialidade_w		:= obter_especialidade_medico(cd_medico_exec_regra_w, 'C');
					cd_cbo_exec_w			:= tiss_obter_cbos_medico(cd_medico_exec_regra_w, cd_especialidade_w, ds_versao_w, cd_convenio_w);
				elsif (ie_envio_w	= 'L') then --lhalves OS252373 em 25/09/2010
					cd_medico_executor_w		:= coalesce(cd_medico_exec_proc_w, cd_medico_laudo_w);
					ie_funcao_medico_w		:= ie_funcao_medico_proc_w;
					cd_especialidade_w		:= cd_especialidade_proc_w;
					cd_cbo_exec_w			:= tiss_obter_cbos_medico(coalesce(cd_medico_exec_proc_w, cd_medico_laudo_w), cd_especialidade_w, ds_versao_w, cd_convenio_w);
					
				end if;

			elsif (ie_exec_spsadt_w = 'S') then
				cd_medico_executor_w		:= cd_medico_exec_proc_w;
				ie_funcao_medico_w		:= ie_funcao_medico_proc_w;
				cd_especialidade_w		:= cd_especialidade_proc_w;
				cd_cbo_exec_w			:= tiss_obter_cbos_medico(cd_medico_executor_w, cd_especialidade_w, ds_versao_w, cd_convenio_w);				
			elsif (ie_exec_spsadt_w = 'MC') then
				if (obter_se_medico_conveniado(cd_estabelecimento_w, cd_medico_exec_proc_w, cd_convenio_w, null, null,null,null,null,dt_procedimento_w, null, null) = 'S') then
					cd_medico_executor_w	:= cd_medico_exec_proc_w;
					ie_funcao_medico_w	:= ie_funcao_medico_proc_w;
					cd_especialidade_w	:= cd_especialidade_proc_w;
					cd_cbo_exec_w		:= tiss_obter_cbos_medico(cd_medico_executor_w, cd_especialidade_w, ds_versao_w, cd_convenio_w);					
				end if;
			elsif (ie_exec_spsadt_w = 'N') then
				cd_medico_executor_w		:= cd_medico_atend_w;
				if (ie_especialidade_exec_w = 'S') then
					cd_especialidade_w := cd_especialidade_proc_w;
				else
					cd_especialidade_w := obter_especialidade_medico(cd_medico_atend_w, 'C');	-- os84309 - 28/02/2008 - busca o cbo errado.
				end if;
				ie_funcao_medico_w		:= ie_funcao_medico_proc_w;
				cd_cbo_exec_w			:= tiss_obter_cbos_medico(cd_medico_atend_w, cd_especialidade_w, ds_versao_w, cd_convenio_w);
			elsif (ie_exec_spsadt_w = 'F') then
				cd_medico_executor_w		:= coalesce(cd_medico_exec_proc_w, cd_funcionario_w);
				ie_funcao_medico_w		:= ie_funcao_medico_proc_w;
				cd_especialidade_w		:= cd_especialidade_proc_w;
				cd_cbo_exec_w			:= tiss_obter_cbos_medico(cd_funcionario_w, cd_especialidade_w, ds_versao_w, cd_convenio_w);
			elsif (ie_exec_spsadt_w = 'L') then
				cd_medico_executor_w		:= coalesce(cd_medico_exec_proc_w, cd_medico_laudo_w);
				ie_funcao_medico_w		:= ie_funcao_medico_proc_w;
				cd_especialidade_w		:= cd_especialidade_proc_w;
				cd_cbo_exec_w			:= tiss_obter_cbos_medico(coalesce(cd_medico_exec_proc_w, cd_medico_laudo_w), cd_especialidade_w, ds_versao_w, cd_convenio_w);
			end if;
		elsif (ie_tiss_tipo_guia_w = '3') then
			SELECT * FROM tiss_obter_regra_exec_compl(	cd_convenio_w, cd_estabelecimento_w, cd_procedimento_w, ie_origem_proced_w, cd_area_procedimento_w, cd_especialidade_proc_exec_w, cd_grupo_proc_w, ie_tipo_atendimento_w, cd_setor_entrada_w, ie_responsavel_credito_w, ie_tiss_tipo_guia_w, cd_medico_exec_proc_w, ie_envio_w, cd_medico_exec_regra_w, cd_setor_entrada_pac_w, cd_setor_exec_proc_w) INTO STRICT ie_envio_w, cd_medico_exec_regra_w;
			if (ie_envio_w	= 'ME') then
				cd_medico_executor_w	:= cd_medico_exec_proc_w;
				ie_funcao_medico_w	:= ie_funcao_medico_proc_w;
				cd_especialidade_w	:= cd_especialidade_proc_w;
				cd_cbo_exec_w		:= tiss_obter_cbos_medico(cd_medico_executor_w, cd_especialidade_w, ds_versao_w, cd_convenio_w);
			elsif (ie_envio_w	= 'MA') then
				cd_medico_executor_w		:= cd_medico_atend_w;
				cd_especialidade_w		:= cd_especialidade_proc_w;
				ie_funcao_medico_w		:= ie_funcao_medico_proc_w;
				cd_cbo_exec_w			:= tiss_obter_cbos_medico(cd_medico_atend_w, cd_especialidade_w, ds_versao_w, cd_convenio_w);
			elsif (ie_envio_w	= 'IR') then
				cd_medico_executor_w	:= cd_medico_exec_regra_w;
				ie_funcao_medico_w	:= ie_funcao_medico_proc_w;
				cd_especialidade_w	:= cd_especialidade_proc_w;
				cd_cbo_exec_w		:= tiss_obter_cbos_medico(cd_medico_exec_regra_w, cd_especialidade_w, ds_versao_w, cd_convenio_w);
			elsif (ie_envio_w	= 'L') then --lhalves OS252373 em 25/09/2010
					cd_medico_executor_w		:= coalesce(cd_medico_exec_proc_w, cd_medico_laudo_w);
					ie_funcao_medico_w		:= ie_funcao_medico_proc_w;
					cd_especialidade_w		:= cd_especialidade_proc_w;
					cd_cbo_exec_w			:= tiss_obter_cbos_medico(coalesce(cd_medico_exec_proc_w, cd_medico_laudo_w), cd_especialidade_w, ds_versao_w, cd_convenio_w);
			end if;
		elsif (ie_tiss_tipo_guia_w = '2') then
			cd_medico_executor_w		:= cd_medico_exec_proc_w;
			cd_especialidade_w		:= cd_especialidade_proc_w;
			ie_funcao_medico_w		:= ie_funcao_medico_proc_w;
			cd_cbo_exec_w			:= tiss_obter_cbos_medico(cd_medico_executor_w, cd_especialidade_w, ds_versao_w, cd_convenio_w);
		elsif (ie_tiss_tipo_guia_w = '11') then --Odonto
			cd_medico_executor_w		:= cd_medico_exec_proc_w;
			cd_especialidade_w		:= cd_especialidade_proc_w;
			ie_funcao_medico_w		:= ie_funcao_medico_proc_w;
			cd_cbo_exec_w			:= tiss_obter_cbos_medico(cd_medico_executor_w, cd_especialidade_w, ds_versao_w, cd_convenio_w);
		end if;

		cd_cbo_exec_w		:= tiss_obter_regra_campo(ie_tiss_tipo_guia_w, 'CD_CBOS', cd_convenio_w, cd_cbo_exec_w, ie_tipo_atendimento_w, cd_categoria_conv_w,'N',0, cd_estabelecimento_w, ie_clinica_w, nr_seq_classif_atend_w, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@', cd_setor_exec_proc_w);						
		
		select	coalesce(max(cd_tabela_xml), '00')
		into STRICT	cd_edicao_amb_w
		from	tiss_tipo_tabela
		where	nr_sequencia		= nr_seq_tiss_tabela_w;

		if (coalesce(cd_procedimento_tuss_w,'0') <> '0') then
			open c06;
			loop
			fetch c06 into
				ie_codigo_tuss_w,
				ie_desc_tuss_w;
			EXIT WHEN NOT FOUND; /* apply on c06 */
				ie_proc_tuss_w		:= ie_codigo_tuss_w;
				ie_desc_proc_interno_w	:= ie_desc_tuss_w;
			end loop;
			close c06;		
		end if;

		if (ie_desc_proc_interno_w = 'S') then

			select	substr(coalesce(ds_proc_esp_w, tiss_eliminar_caractere(coalesce(coalesce(tiss_obter_desc_proc_interno(cd_procedimento_w,
												ie_origem_proced_w, 
												nr_seq_proc_interno_w, 
												nr_seq_exame_w), ds_proc_tiss_w), 
								   ds_procedimento_w))), 1, 150)
			into STRICT	ds_procedimento_w
			;

		elsif (ie_desc_proc_interno_w = 'P') then

			ds_procedimento_w	:= substr(coalesce(ds_proc_esp_w, tiss_eliminar_caractere(coalesce(coalesce(ds_proc_tiss_w, ds_procedimento_w), obter_descricao_procedimento(cd_procedimento_w, ie_origem_proced_w)))), 1, 150);

		elsif (ie_desc_proc_interno_w = 'T') and (coalesce(cd_procedimento_tuss_w,'0') <> '0') then --lhalves OS200562 09/03, gerar descricao TUSS.
			
			ds_procedimento_w	:= substr(coalesce(ds_proc_esp_w, tiss_eliminar_caractere(coalesce(obter_descricao_procedimento(cd_procedimento_tuss_w, '8'),coalesce(ds_proc_tiss_w, ds_procedimento_w)))), 1, 150);
			
		elsif (ie_desc_proc_interno_w = 'C')	then
		
			select	substr(Obter_Desc_Procedimento(cd_procedimento_w,ie_origem_proced_w),1,150)
			into STRICT	ds_proc_tabela_w
			;
		
			if (ds_procedimento_w = ds_proc_tabela_w) and --Se for igual, nao possui conversao
				(coalesce(cd_procedimento_tuss_w,'0') <> '0') then --Possui proc TUSS
				ds_procedimento_w	:= substr(coalesce(ds_proc_esp_w, tiss_eliminar_caractere(coalesce(obter_descricao_procedimento(cd_procedimento_tuss_w, '8'),coalesce(ds_proc_tiss_w, ds_procedimento_w)))), 1, 150);
			end if;
			
		end if;
		
		if (coalesce(ie_lado_conta_w,'N') = 'S') and (ds_lado_proc_w IS NOT NULL AND ds_lado_proc_w::text <> '') then /*lhalves OS 375173 em 27/10/2011*/
			ds_procedimento_w	:= substr(ds_procedimento_w,1,50);
			ds_procedimento_w	:= substr(ds_procedimento_w||'-'||ds_lado_proc_w,1,60);			
		end if;

		cd_autorizacao_w	:= coalesce(cd_autorizacao_w, wheb_mensagem_pck.get_texto(1097738));

		select	CASE WHEN ie_via_acesso_w='B' THEN  'U'  ELSE ie_via_acesso_w END
		into STRICT	ie_via_acesso_w
		;

		if (ie_proc_tuss_w = 'S') and (coalesce(cd_procedimento_tuss_w,'0') <> '0') then
			cd_proc_conv_w	:= coalesce(cd_procedimento_tuss_w,cd_proc_conv_w);
		elsif (ie_proc_tuss_w = 'P') and (ie_proc_pacote_w <> 'S') then
			cd_proc_conv_w	:= coalesce(cd_procedimento_tuss_w,cd_proc_conv_w);
		elsif (ie_proc_tuss_w	= 'C') then
			if (coalesce(cd_proc_conv_w,'0') <> '0') and (cd_proc_conv_w <> cd_procedimento_w) then --Conversao
				cd_proc_conv_w	:= cd_proc_conv_w;
			elsif	(((coalesce(cd_proc_conv_w,'0') = '0') or (cd_proc_conv_w = cd_procedimento_w)) and --Proc TUSS
				 (coalesce(cd_procedimento_tuss_w,'0') <> '0'))  then
				cd_proc_conv_w	:= cd_procedimento_tuss_w;
			elsif	((coalesce(cd_procedimento_tuss_w,'0') = '0') and --Sem Conversao e Sem Proc TUSS
				 (cd_proc_conv_w = cd_procedimento_w)) then
				cd_proc_conv_w	:=  cd_procedimento_w;
			end if;
		
			
		end if;	

		cd_proc_conv_w		:= coalesce(cd_proc_conv_w, cd_procedimento_w);
		cd_proc_conv_w		:= replace(replace(cd_proc_conv_w, '.',''),'-','');
		cd_proc_conv_w		:= tiss_obter_regra_campo_proc(cd_proc_conv_w, '3', cd_convenio_w, cd_estabelecimento_w, cd_procedimento_w, ie_origem_proced_w, null,cd_categoria_conv_w, cd_plano_convenio_w,ie_tipo_atendimento_w,ie_carater_internacao_w, ie_tiss_tipo_guia_w);

		cd_proc_conv_w := TISS_FORMATAR_CD_PROCEDIMENTO(cd_proc_conv_w, nr_sequencia_autor_w, nr_interno_conta_p);

		select	max(dt_inicio_real),
			max(dt_termino)
		into STRICT	dt_inicio_cir_w,
			dt_fim_cir_w
		from	cirurgia
		where	nr_cirurgia		= nr_cirurgia_w;

		if (ie_data_proc_w = 'CP') then
			dt_inicio_w	:= coalesce(dt_inicio_cir_w, coalesce(dt_inicio_proc_w, dt_fim_proc_w));
			dt_fim_w	:= coalesce(dt_fim_cir_w, dt_fim_proc_w);
		elsif (ie_data_proc_w = 'P') then
			dt_inicio_w	:= coalesce(dt_inicio_proc_w, dt_fim_proc_w);
			dt_fim_w	:= dt_fim_proc_w;
		elsif (ie_data_proc_w = 'C') then
			dt_inicio_w	:= dt_inicio_cir_w;
			dt_fim_w	:= dt_fim_cir_w;
		end if;

		if (coalesce(dt_inicio_w::text, '') = '') or (coalesce(dt_fim_w::text, '') = '') then
			dt_inicio_w	:= null;
			dt_fim_w	:= null;
		end if;
	
		if (dt_inicio_w IS NOT NULL AND dt_inicio_w::text <> '') and (dt_fim_w IS NOT NULL AND dt_fim_w::text <> '') then
			begin			
			select	to_date(tiss_obter_regra_campo(ie_tiss_tipo_guia_w, 'DT_HORA_PROCED', cd_convenio_w, to_char(dt_inicio_w, 'dd/mm/yyyy hh24:mi:ss'), ie_tipo_atendimento_w, cd_categoria_conv_w, 'N',0, cd_estabelecimento_w, ie_clinica_w, nr_seq_classif_atend_w, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@',cd_setor_exec_proc_w), 'dd/mm/yyyy hh24:mi:ss'),
				to_date(tiss_obter_regra_campo(ie_tiss_tipo_guia_w, 'DT_HORA_PROCED', cd_convenio_w, to_char(dt_fim_w, 'dd/mm/yyyy hh24:mi:ss'), ie_tipo_atendimento_w, cd_categoria_conv_w, 'N',0, cd_estabelecimento_w, ie_clinica_w, nr_seq_classif_atend_w, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@',cd_setor_exec_proc_w), 'dd/mm/yyyy hh24:mi:ss')
			into STRICT	dt_inicio_w,
				dt_fim_w
			;
			exception
			when others then
				null;
			end;
		end if;

		if	(dt_inicio_w IS NOT NULL AND dt_inicio_w::text <> '') and
			dt_inicio_w = coalesce(dt_fim_w,dt_inicio_w) then
		
			dt_fim_w := to_date(tiss_obter_regra_campo_proc(to_char(coalesce(dt_fim_w,dt_inicio_w),'dd/mm/yyyy hh24:mi:ss'), '9', cd_convenio_w, cd_estabelecimento_w, cd_procedimento_w, ie_origem_proced_w, null,cd_categoria_conv_w, cd_plano_convenio_w,ie_tipo_atendimento_w,ie_carater_internacao_w, ie_tiss_tipo_guia_w),'dd/mm/yyyy hh24:mi:ss');
			
		end if;

		select	(tiss_obter_regra_campo(ie_tiss_tipo_guia_w, 'VL_PROCEDIMENTO', cd_convenio_w, vl_procedimento_w, ie_tipo_atendimento_w, cd_categoria_conv_w,'N',0, cd_estabelecimento_w, ie_clinica_w, nr_seq_classif_atend_w, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@',cd_setor_exec_proc_w))::numeric
		into STRICT	vl_procedimento_w
		;

		if (coalesce(ie_reducao_acresc_w, 'TH') = 'TP') then					

			if (coalesce(tx_procedimento_w,0) = 0) then
				tx_hora_extra_w	:= 0;
			else
				
				if (coalesce(ie_formato_red_acres_w,'V') = 'V') then
					-- dsantos em 05/10/2009 OS170084, trunc para nao arredondar
					tx_hora_extra_w	:= trunc((tx_procedimento_w / 100),2);
								
				elsif (coalesce(ie_formato_red_acres_w,'V') = 'C') then
					tx_hora_extra_w	:= 100 - (tx_procedimento_w * 100);
				elsif (coalesce(ie_formato_red_acres_w,'V') = 'F') then
					tx_hora_extra_w	:= (tx_procedimento_w * 100) - 100;
				else
					tx_hora_extra_w	:= tx_procedimento_w;
				end if;
			end if;
		elsif (coalesce(ie_reducao_acresc_w, 'TH') = 'TA') then
		
			if (ie_proc_pacote_w = 'S') and (coalesce(tx_hora_extra_w::text, '') = '') then
				
				select	max(nr_seq_regra_adic_hora)
				into STRICT	nr_seq_regra_adic_hora_w
				from	atendimento_pacote
				where	nr_atendimento		= nr_atendimento_w
				and	nr_seq_procedimento	= nr_seq_proc_w;
				
				select	max(tx_procedimento)
				into STRICT	tx_hora_extra_w
				from	proc_criterio_horario
				where	nr_sequencia	= nr_seq_regra_adic_hora_w;			
				
			end if;

			if (coalesce(tx_procedimento_w,0) <> 100) then
				if (coalesce(ie_formato_red_acres_w,'V') = 'V') then
					-- dsantos em 05/10/2009 OS170084, para nao arredondar
					tx_hora_extra_w	:= trunc((tx_procedimento_w / 100),2);
				elsif (coalesce(ie_formato_red_acres_w,'V') = 'C') then
					tx_hora_extra_w	:= 100 - (tx_procedimento_w * 100);
				elsif (coalesce(ie_formato_red_acres_w,'V') = 'F') then
					tx_hora_extra_w	:= (tx_procedimento_w * 100) - 100;
				else
					tx_hora_extra_w	:= tx_procedimento_w;
				end if;
			elsif (coalesce(tx_hora_extra_w,0) = 1) then
				select	coalesce(max(tx_ajuste),0)
				into STRICT	tx_hora_extra_w
				from	regra_ajuste_proc
				where	nr_sequencia	= nr_seq_ajuste_proc_w;
				if (coalesce(tx_hora_extra_w,0) = 0) then
					tx_hora_extra_w := 1;
				end if;

				-- edgar 09/04/2009, os 136473 incluido tratamento abaixo
				if (coalesce(ie_formato_red_acres_w,'V') = 'P') then
					tx_hora_extra_w	:= tx_hora_extra_w * 100;
				elsif (coalesce(ie_formato_red_acres_w,'V') = 'C') then
					tx_hora_extra_w	:= 100 - (tx_hora_extra_w * 100);
				elsif (coalesce(ie_formato_red_acres_w,'V') = 'F') then
					tx_hora_extra_w	:= (tx_hora_extra_w * 100) - 100;
				end if;
			end if;			
			
		elsif (coalesce(ie_reducao_acresc_w, 'TH') = 'RA') then
			select	coalesce(max(tx_ajuste),0)
			into STRICT	tx_hora_extra_w
			from	regra_ajuste_proc
			where	nr_sequencia	= nr_seq_ajuste_proc_w;
			if (coalesce(tx_hora_extra_w,0) = 0) then
				tx_hora_extra_w := 1;
			end if;
			-- edgar 09/04/2009, os 136473 incluido tratamento abaixo
			if (coalesce(ie_formato_red_acres_w,'V') = 'P') then
				tx_hora_extra_w	:= tx_hora_extra_w * 100;
			elsif (coalesce(ie_formato_red_acres_w,'V') = 'C') then
				tx_hora_extra_w	:= 100 - (tx_hora_extra_w * 100);
			elsif (coalesce(ie_formato_red_acres_w,'V') = 'F') then
				tx_hora_extra_w	:= (tx_hora_extra_w * 100) - 100;
			end if;
		elsif (coalesce(ie_reducao_acresc_w, 'TH') = 'AC') then
			select	coalesce(max(tx_ajuste),0)
			into STRICT	tx_ajuste_w
			from	regra_ajuste_proc
			where	nr_sequencia	= nr_seq_ajuste_proc_w;

			select	coalesce(max(tx_medico),0)
			into STRICT	tx_medico_w
			from	proc_criterio_horario
			where	nr_sequencia	= nr_seq_crit_hor_w;

			tx_hora_extra_w	:= (tx_ajuste_w + tx_medico_w) -1;

			if	(tx_ajuste_w <> 0 AND tx_medico_w = 0) then
				tx_hora_extra_w	:= tx_ajuste_w;
			elsif	(tx_ajuste_w = 0 AND tx_medico_w = 0) then
				tx_hora_extra_w	:= 1;
			end if;
		
			-- edgar 09/04/2009, os 136473 incluido tratamento abaixo
			if (coalesce(ie_formato_red_acres_w,'V') = 'P') then
				tx_hora_extra_w	:= tx_hora_extra_w * 100;
			elsif (coalesce(ie_formato_red_acres_w,'V') = 'C') then
				tx_hora_extra_w	:= 100 - (tx_hora_extra_w * 100);
			elsif (coalesce(ie_formato_red_acres_w,'V') = 'F') then
				tx_hora_extra_w	:= (tx_hora_extra_w * 100) - 100;
			end if;
		elsif (coalesce(ie_reducao_acresc_w, 'TH') = 'TH') then
		
			--lhalves OS 733503 em 14/05/2014 - Quando e pacote nao grava a tx_hora_extra, entao tem que bucar da atendimento_pacote
			if (ie_proc_pacote_w = 'S') and (coalesce(tx_hora_extra_w::text, '') = '') then
				
				select	max(nr_seq_regra_adic_hora)
				into STRICT	nr_seq_regra_adic_hora_w
				from	atendimento_pacote
				where	nr_atendimento		= nr_atendimento_w
				and	nr_seq_procedimento	= nr_seq_proc_w;
				
				select	max(tx_procedimento)
				into STRICT	tx_hora_extra_w
				from	proc_criterio_horario
				where	nr_sequencia	= nr_seq_regra_adic_hora_w;			
				
			end if;		
			if (coalesce(ie_formato_red_acres_w,'V') <> 'V') then
				tx_hora_extra_w	:= (tx_hora_extra_w * 100);
			elsif (coalesce(ie_formato_red_acres_w,'V') = 'C') then
				tx_hora_extra_w	:= 100 - (tx_hora_extra_w * 100);
			elsif (coalesce(ie_formato_red_acres_w,'V') = 'F') then
				tx_hora_extra_w	:= (tx_hora_extra_w * 100) - 100;
			end if;

		elsif (coalesce(ie_reducao_acresc_w, 'TH') = 'E') or (coalesce(ie_reducao_acresc_w, 'TH') = 'EM') then
			select	max(tiss_obter_dados_amb(cd_estabelecimento_w, cd_convenio_w, cd_categoria_conv_w, cd_edicao_w, dt_procedimento_w))
			into STRICT	tx_hora_extra_w
			;
		elsif (coalesce(ie_reducao_acresc_w, 'TH') = 'TD') then
			tx_hora_extra_w := tx_desconto_w;
		elsif (coalesce(ie_reducao_acresc_w, 'TH') = 'QE') then
			if (coalesce(ie_formato_red_acres_w,'V') = 'V') then
			/*lhalves OS 203418 01/04/2010 -  Se o procedimento nao tiver taxa de custo operacional ira gerar a taxa do procedimento*/
				
				tx_hora_extra_w	:= trunc(((coalesce(tx_custo_oper_qt_w,tx_procedimento_w)) / 100),2);
			elsif (coalesce(ie_formato_red_acres_w,'V') = 'C') then
				tx_hora_extra_w	:= 100 - ((coalesce(tx_custo_oper_qt_w,tx_procedimento_w)) * 100);
			elsif (coalesce(ie_formato_red_acres_w,'V') = 'F') then
				tx_hora_extra_w	:= ((coalesce(tx_custo_oper_qt_w,tx_procedimento_w)) * 100) - 100;
			else			
			tx_hora_extra_w := tx_custo_oper_qt_w;
			end if;
		elsif (coalesce(ie_reducao_acresc_w, 'TH') = 'TV') then --lhalves 20/02/2010 OS 192790
			tx_procedimento_w := TISS_OBTER_TAXA_PROC_REGRA(nr_seq_proc_w,vl_medico_w,ie_via_acesso_w,tx_procedimento_w);
			if (coalesce(ie_formato_red_acres_w,'V') = 'V') then
				tx_hora_extra_w	:= trunc((tx_procedimento_w / 100),2);
			elsif (coalesce(ie_formato_red_acres_w,'V') = 'C') then
				tx_hora_extra_w	:= 100 - (tx_procedimento_w * 100);
			elsif (coalesce(ie_formato_red_acres_w,'V') = 'F') then
				tx_hora_extra_w	:= (tx_procedimento_w * 100) - 100;
			else
			tx_hora_extra_w	:= tx_procedimento_w;
			end if;
		end if;	
		
		/*if	(nvl(tx_hora_extra_w,0) = 0) and --Na versao 3 e obrigatorio, entao envia 0 se vazio conforme parametro acima.
			(ds_versao_3_w = 'S') then			
			tx_hora_extra_w	:= 0;	
		end if;*/


		/*lhalves OS 845708 em 12/02/2015
		- Na versao 3 e obrigatorio, entao envia 1 de Padrao.
		#########
		Documentacao ANS v3.02.00 para o campo "Fator de reducao ou acrescimo":
		Preenchimento: Condicionado. Deve ser preenchido sempre que houver procedimento realizado sendo informado. Caso nao haja reducao ou acrescimo sobre o valor do procedimento o fator e igual a 1,00.
		Fonte: Padrao TISS_Componente de conteudo e Estrutura_201405.pdf, pagina 170
		#########
		*/
		if (coalesce(tx_hora_extra_w,0) = 0) and (ds_versao_3_w = 'S') then
			
			tx_hora_extra_w	:= 1;

			if (coalesce(ie_formato_red_acres_w,'V') = 'P') then
				tx_hora_extra_w	:= tx_hora_extra_w * 100;
			elsif (coalesce(ie_formato_red_acres_w,'V') = 'C') then
				tx_hora_extra_w	:= 100 - (tx_hora_extra_w * 100);
			elsif (coalesce(ie_formato_red_acres_w,'V') = 'F') then
				tx_hora_extra_w	:= (tx_hora_extra_w * 100) - 100;
			end if;
		end if;	
	
		select	(tiss_obter_regra_campo(ie_tiss_tipo_guia_w, 'PR_RED_ACRESCIMO', cd_convenio_w, tx_hora_extra_w, ie_tipo_atendimento_w, cd_categoria_conv_w,'N',0, cd_estabelecimento_w, ie_clinica_w, nr_seq_classif_atend_w, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@',cd_setor_exec_proc_w))::numeric
		into STRICT	tx_hora_extra_w
		;
		
		if (tx_hora_extra_w IS NOT NULL AND tx_hora_extra_w::text <> '') then
			select	(tiss_obter_regra_campo_proc(tx_hora_extra_w, '1', cd_convenio_w, cd_estabelecimento_w, cd_procedimento_w, ie_origem_proced_w, ie_clinica_w,cd_categoria_conv_w, cd_plano_convenio_w,ie_tipo_atendimento_w,ie_carater_internacao_w, ie_tiss_tipo_guia_w))::numeric
			into STRICT	tx_hora_extra_w
			;
		end if;
		
		if (qt_procedimento_w IS NOT NULL AND qt_procedimento_w::text <> '') then
			select	Campo_numerico(tiss_obter_regra_campo_proc(qt_procedimento_w, '2', cd_convenio_w, cd_estabelecimento_w, cd_procedimento_w, ie_origem_proced_w, ie_clinica_w,cd_categoria_conv_w, cd_plano_convenio_w,ie_tipo_atendimento_w,ie_carater_internacao_w, ie_tiss_tipo_guia_w))
			into STRICT	qt_procedimento_w
			;
		end if;
		
		if (ie_valor_unitario_w = 'O') then
			vl_unitario_w 		:= dividir_sem_round(vl_original_w, qt_procedimento_w);
		elsif (ie_valor_unitario_w = 'E') then
			vl_unitario_w		:= dividir_sem_round(vl_procedimento_w, qt_procedimento_w);
			if (coalesce(ie_formato_red_acres_w,'V') = 'V') then			
				vl_unitario_w := 	dividir_sem_round((100 * vl_unitario_w), trunc((tx_hora_extra_w * 100),2));				
			elsif (coalesce(ie_formato_red_acres_w,'V') = 'P') then
				vl_unitario_w := 	dividir_sem_round((100 * vl_unitario_w), tx_hora_extra_w);
			end if;			
		else
			vl_unitario_w		:= dividir_sem_round(vl_procedimento_w, qt_procedimento_w);
		end if;		
			

		select	tiss_obter_regra_campo(ie_tiss_tipo_guia_w, 'IE_VIA_ACESSO', cd_convenio_w, ie_via_acesso_w, ie_tipo_atendimento_w, cd_categoria_conv_w,'N',0, cd_estabelecimento_w, ie_clinica_w, nr_seq_classif_atend_w, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@',cd_setor_exec_proc_w)
		into STRICT	ie_via_acesso_w
		;

		select	tiss_obter_regra_campo(ie_tiss_tipo_guia_w, 'IE_TECNICA_UTILIZADA', cd_convenio_w, ie_tecnica_utilizada_w, ie_tipo_atendimento_w, cd_categoria_conv_w,'N',0, cd_estabelecimento_w, ie_clinica_w, nr_seq_classif_atend_w, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@',cd_setor_exec_proc_w)
		into STRICT	ie_tecnica_utilizada_w
		;

		if (ie_tecnica_utilizada_w IS NOT NULL AND ie_tecnica_utilizada_w::text <> '') then
			select	tiss_obter_regra_campo_proc(ie_tecnica_utilizada_w, '4', cd_convenio_w, cd_estabelecimento_w, cd_procedimento_w, ie_origem_proced_w, ie_clinica_w,cd_categoria_conv_w, cd_plano_convenio_w,ie_tipo_atendimento_w,ie_carater_internacao_w, ie_tiss_tipo_guia_w)
			into STRICT	ie_tecnica_utilizada_w
			;
		end if;

		select	tiss_obter_regra_campo_proc(ie_funcao_medico_w, '5', cd_convenio_w, cd_estabelecimento_w, cd_procedimento_w, ie_origem_proced_w, ie_clinica_w, cd_categoria_conv_w, cd_plano_convenio_w,ie_tipo_atendimento_w,ie_carater_internacao_w, ie_tiss_tipo_guia_w)
		into STRICT	ie_funcao_medico_w
		;

		if (ie_via_acesso_w IS NOT NULL AND ie_via_acesso_w::text <> '') then
			select	tiss_obter_regra_campo_proc(ie_via_acesso_w, '7', cd_convenio_w, cd_estabelecimento_w, cd_procedimento_w, ie_origem_proced_w, ie_clinica_w, cd_categoria_conv_w, cd_plano_convenio_w,ie_tipo_atendimento_w,ie_carater_internacao_w, ie_tiss_tipo_guia_w)
			into STRICT	ie_via_acesso_w
			;
		end if;


		select	nextval('tiss_conta_proc_seq')
		into STRICT	nr_seq_conta_proc_w
		;

		if ((coalesce(nr_atend_med_p,0) > 0) and (coalesce(nr_seq_prot_med_p,0) > 0)) then
			
			if (coalesce(ie_dt_proc_tasymed_w,'D') = 'A') then  --lhalves 26/01 OS 190966, gerar data de entrada do tasymed como data do procedimento
				select 	ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_entrada)
				into STRICT 	dt_entrada_tasymed_w
				from 	med_atendimento 
				where	nr_atendimento	= nr_atend_med_p;

				dt_procedimento_w := dt_entrada_tasymed_w;						
			end if;
		end if;
		
		--lhalves OS 239427 14/08/2010 - Verificar se o procedimento e do pacote ou nao
		if (nr_seq_proc_w IS NOT NULL AND nr_seq_proc_w::text <> '') then
			select 	max(nr_seq_proc_pacote)
			into STRICT 	nr_seq_proc_pacote_w
			from 	procedimento_paciente
			where 	nr_sequencia 	= nr_seq_proc_w;
			
			if (coalesce(nr_seq_proc_pacote_w, 0) = 0) then				-- Se nao tem pacote informado, entao nao e pacote
				ie_proc_pacote_regra_w		:= 'F';
			elsif (coalesce(nr_seq_proc_w, 0) = coalesce(nr_seq_proc_pacote_w, 0)) then	-- Se pacote informado e o pacote e igual ao nr_sequencia, entao e o proprio pacote
				ie_proc_pacote_regra_w		:= 'P';
			else									-- Se pacote informado e o pacote e diferente do nr_sequencia, entao e item de pacote
				ie_proc_pacote_regra_w		:= 'I';
			end if;
		end if;		
 		-- lhalves OS 197868 24/02/2010.	
		
		
		begin
		select	'S'
		into STRICT	ie_item_tuss_w
		
		where	coalesce(cd_procedimento_tuss_w,0) <> 0;
		exception
		when others then
			ie_item_tuss_w := 'N';
		end;
		
		open c05;
		loop
		fetch c05 into
			cd_proc_conv_regra_w,
			ds_proc_conv_regra_w;
		EXIT WHEN NOT FOUND; /* apply on c05 */
			if	((coalesce(cd_proc_conv_regra_w,'X') <> 'X') or (ds_proc_conv_regra_w IS NOT NULL AND ds_proc_conv_regra_w::text <> '')) then
				cd_proc_conv_w 		:= coalesce(cd_proc_conv_regra_w,cd_proc_conv_w);
				ds_procedimento_w	:= coalesce(ds_proc_conv_regra_w,ds_procedimento_w);

				cd_proc_conv_w := TISS_FORMATAR_CD_PROCEDIMENTO(cd_proc_conv_w, nr_sequencia_autor_w, nr_interno_conta_p);
			end if;				
		end loop;
		close c05;
		
		if (ie_tiss_tipo_guia_w = '6') then --lhalves OS197269 
			cd_func_honor_w := cd_funcionario_w;
		else
			cd_func_honor_w := null;
		end if;	
		
		if (coalesce(ie_medico_solic_atend_w,'N') = 'R') then
		
			ie_medico_solic_atend_regra_w	:= 'N';
			open c07;
			loop
			fetch c07 into
				ie_medico_solic_atend_regra_w,
				cd_medico_regra_solic_tiss_w;
			EXIT WHEN NOT FOUND; /* apply on c07 */		
			end loop;
			close c07;
		else			
			ie_medico_solic_atend_regra_w	:= ie_medico_solic_atend_w;
		end if;

		cd_medico_solic_w	:= '';	

		if (ie_tiss_tipo_guia_w <> '5') then --Apenas se diferente de Resumo de Internacao, pois no resumo nao tem solicitante, evitar problema de agrupamento		
			if (coalesce(ie_medico_solic_atend_regra_w,'X') in ('MP','MSP','MRP','IR','PA')) then
				cd_medico_solic_w	:= cd_medico_prof_solic_tiss_w;			
			elsif (coalesce(ie_medico_solic_atend_regra_w,'X') = 'MRF') then
				select	max(cd_medico_referido)
				into STRICT	cd_medico_solic_w
				from	atendimento_paciente
				where	nr_atendimento	= nr_atendimento_w;		
			elsif (coalesce(ie_medico_solic_atend_regra_w,'X') = 'RMP') then
				cd_medico_solic_w	:= cd_medico_prof_solic_tiss_w;
				if (coalesce(cd_medico_solic_w, '0') = '0') then
					select	max(cd_medico)
					into STRICT	cd_medico_solic_w
					from	prescr_medica
					where	nr_atendimento	= nr_atendimento_w;		
				end if;
			elsif (coalesce(ie_medico_solic_atend_regra_w,'X') = 'RMA') then
				cd_medico_solic_w	:= cd_medico_prof_solic_tiss_w;	
				if (coalesce(cd_medico_solic_w, '0') = '0') then
					select	max(cd_medico_resp)
					into STRICT	cd_medico_solic_w
					from	atendimento_paciente
					where	nr_atendimento	= nr_atendimento_w;	
				end if;
			elsif (coalesce(ie_medico_solic_atend_regra_w,'X') = 'MR')  then
				select	coalesce(max(cd_medico_atendimento), max(cd_medico_resp))
				into STRICT	cd_medico_solic_w
				from	atendimento_paciente
				where	nr_atendimento	= nr_atendimento_w;			
			elsif (coalesce(ie_medico_solic_atend_regra_w,'X') = 'S') then
				select	max(cd_medico_resp)
				into STRICT	cd_medico_solic_w
				from	atendimento_paciente
				where	nr_atendimento	= nr_atendimento_w;				
			elsif (coalesce(ie_medico_solic_atend_regra_w,'X') = 'N') then
				select	max(nr_sequencia)
				into STRICT	nr_sequencia_autor_w
				from	autorizacao_convenio
				where	nr_atendimento	= nr_atendimento_w
				and	cd_autorizacao	= cd_autorizacao_w;
				if (nr_sequencia_autor_w IS NOT NULL AND nr_sequencia_autor_w::text <> '') then
					select	max(cd_medico_solicitante)
					into STRICT	cd_medico_solic_w
					from	autorizacao_convenio
					where	nr_sequencia	= nr_sequencia_autor_w;
				end if;
			elsif (coalesce(ie_medico_solic_atend_regra_w,'X') = 'E') then
				cd_medico_solic_w	:= cd_medico_executor_solic_w;						
			elsif (coalesce(ie_medico_solic_atend_regra_w,'X') = 'SMC') then
				cd_medico_solic_w	:= cd_medico_exec_proc_w;			
				if (coalesce(cd_medico_solic_w::text, '') = '') then
					select	max(cd_medico_resp)
					into STRICT	cd_medico_solic_w
					from	atendimento_paciente
					where	nr_atendimento	= nr_atendimento_w;
				end if;
			elsif (coalesce(ie_medico_solic_atend_regra_w,'X') = 'ME') then
				select	substr(max(crm_medico_externo),1,30),
					max(nm_medico_externo),
					max(cd_medico_resp)			
				into STRICT	crm_medico_externo_w,			
					nm_medico_externo_w,
					cd_medico_solic_w
				from	atendimento_paciente
				where	nr_atendimento		= nr_atendimento_w;		
			end if;
		end if;
		
		if (ie_gravar_log_conta_w = 'S') then
			CALL TISS_GERAR_LOG_CONTA(	nr_interno_conta_p,
						'Regra medico Solicitante (Gerar Conta Proc) > '||
						' Procedimento :' || cd_procedimento_w || 							
						' Retorno Regra: '|| ie_medico_solic_atend_regra_w||
						' medico Solic TISS: '||cd_medico_solic_w,
						nm_usuario_p);
		end if;		

		/*lhalves OS241129 em 24/08/2010 -Definir se o procedimento zerado sera gerado no arquivo xml*/
		
		ie_xml_w	:= 'S';
		
		ie_xml_regra_w	:= coalesce(TISS_OBTER_SE_PROC_XML(cd_estabelecimento_w, cd_convenio_w, ie_tiss_tipo_guia_w, ie_responsavel_credito_w, cd_procedimento_w, ie_origem_proced_w),'S');
		

		if	(vl_procedimento_w	= 0 AND ( or
			  )) or (ie_xml_regra_w = 'N') then			
			ie_xml_w	:= 'N';		
		end if;
		
		/*lhalves OS 360554 em 15/09/2011 */

		if (ie_tiss_tipo_guia_w = '4') and (ie_honorario_w = 'S') then
			
			SELECT * FROM tiss_obter_regra_honor_spsadt(cd_convenio_w, cd_estabelecimento_w, ie_responsavel_credito_w, ie_tipo_atendimento_w, cd_setor_entrada_w, ie_prestador_w, ie_exec_compl_w) INTO STRICT ie_prestador_w, ie_exec_compl_w;
					
			if (ie_prestador_w = 'M') then
				cd_medico_honor_tiss_w	:= cd_medico_exec_proc_w;
			end if;	
			if (ie_exec_compl_w = 'M') then
				cd_medico_executor_w	:= cd_medico_exec_proc_w;
			end if;				
		end if;
		
		/*lhalves OS 387641 em 09/12/2011 - emitir o honorario do procedimento na mesma guia do hospital, para nao separrar as guias*/

		if (ie_tiss_tipo_guia_w = '4') and (coalesce(ie_nao_honorario_sadt_w,'N') = 'S') and (ie_honorario_w = 'S') then
			ie_honorario_w := 'N';
			CALL tiss_gerar_log_conta(	nr_interno_conta_p,
						'Emitir honorario de SP/SADT na mesma guia do hospital (WHEB NAO RECOMENDA)',
						nm_usuario_p);
		end if;
		
		if (cd_medico_exec_tiss_w IS NOT NULL AND cd_medico_exec_tiss_w::text <> '') or (cd_medico_honor_tiss_w IS NOT NULL AND cd_medico_honor_tiss_w::text <> '') then
			cd_cgc_prestador_w	:= null;
		end if;
		
		if (ds_versao_3_w = 'S') then
			if (ie_via_acesso_w = 'U') then --unica ou principal
				ie_via_acesso_w := '1';
			elsif (ie_via_acesso_w = 'M') then --Mesma via de acesso
				ie_via_acesso_w := '2';
			elsif (ie_via_acesso_w = 'D') then --Via de acesso Diferente
				ie_via_acesso_w	:= '3';
			end if;	

			if (ie_tecnica_utilizada_w = 'C') then --Convencional
				ie_tecnica_utilizada_w := '1';
			elsif (ie_tecnica_utilizada_w = 'V') then --Video
				ie_tecnica_utilizada_w := '2';
			elsif (ie_tecnica_utilizada_w = 'R') then --Robotica
				ie_tecnica_utilizada_w := '3';
			end if;			
		end if;
		
		ds_indicacao_proc_prescr_w	:= tiss_obter_regra_campo_proc(ds_indicacao_proc_prescr_w, '8', cd_convenio_w, cd_estabelecimento_w, cd_procedimento_w, ie_origem_proced_w, null,cd_categoria_conv_w, cd_plano_convenio_w,ie_tipo_atendimento_w,ie_carater_internacao_w, ie_tiss_tipo_guia_w);

		begin
		insert	into tiss_conta_proc(nr_sequencia,
			nr_interno_conta,
			ie_tiss_tipo_guia,
			cd_autorizacao,
			nr_seq_proc,
			dt_atualizacao,
			nm_usuario,
			cd_procedimento,
			cd_edicao_amb,
			qt_procedimento,
			vl_reducao_acrescimo,
			vl_procedimento,
			ie_via_acesso,
			vl_unitario,
			ds_procedimento,
			dt_procedimento,
			cd_cgc_prestador,
			ie_funcao_medico,
			cd_medico_executor,
			cd_especialidade,
			dt_inicio_cir,
			dt_fim_cir,
			ie_honorario,
			ie_tecnica_utilizada,
			ie_responsavel_credito,
			cd_senha,
			cd_cbos,
			cd_prestador_tiss,
			cd_cgc_prest_solic_tiss,
			cd_medico_exec_tiss,
			nr_seq_med_fatur,
			ds_prestador_tiss,
			ie_contrat_med,
			ie_tipo_atend_tiss,
			nr_atend_med,
			nr_seq_prot_med,
			cd_med_solic_tasymed,
			cd_medico_solic_tiss,
			cd_medico_prof_solic_tiss,
			cd_funcionario_honor,
			cd_prestador_solic_tiss,
			ds_prestador_solic_tiss,
			cd_medico_honor_tiss,
			ie_xml,
			cd_medico_convenio,
			cd_cgc_prest_honor_tiss,
			crm_medico_externo,
			nm_medico_externo,
			cd_medico_exec_proc_honor,
			ds_indicacao_proc,
			cd_dente,
			ds_face_dente,
			nr_guia_prestador,
			nr_guia_operadora,
			cd_setor_execucao,
      cd_regiao_boca)
		values (nr_seq_conta_proc_w,
			nr_interno_conta_p,
			ie_tiss_tipo_guia_w,
			cd_autorizacao_w,
			CASE WHEN coalesce(nr_seq_proc_w, 0)=0 THEN  null  ELSE nr_seq_proc_w END ,
			clock_timestamp(),
			nm_usuario_p,
			cd_proc_conv_w,
			cd_edicao_amb_w,
			qt_procedimento_w,
			tx_hora_extra_w,
			(tiss_obter_regra_campo(ie_tiss_tipo_guia_w, 'VL_PROCEDIMENTO', cd_convenio_w, vl_procedimento_w, ie_tipo_atendimento_w, cd_categoria_conv_w,'N',0, cd_estabelecimento_w, ie_clinica_w, nr_seq_classif_atend_w, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@',cd_setor_exec_proc_w))::numeric ,
			tiss_obter_regra_campo(ie_tiss_tipo_guia_w, 'IE_VIA_ACESSO', cd_convenio_w, ie_via_acesso_w, ie_tipo_atendimento_w, cd_categoria_conv_w,'N',0, cd_estabelecimento_w, ie_clinica_w, nr_seq_classif_atend_w, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@',cd_setor_exec_proc_w),
			(tiss_obter_regra_campo(ie_tiss_tipo_guia_w, 'VL_UNITARIO', cd_convenio_w, vl_unitario_w, ie_tipo_atendimento_w, cd_categoria_conv_w,'N',0, cd_estabelecimento_w, ie_clinica_w, nr_seq_classif_atend_w, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@',cd_setor_exec_proc_w))::numeric ,
			tiss_eliminar_caractere(ds_procedimento_w),
			dt_procedimento_w,
			cd_cgc_prestador_w,
			tiss_obter_regra_campo(ie_tiss_tipo_guia_w, 'IE_GRAU_PARTIC', cd_convenio_w, lpad(ie_funcao_medico_w,2,0), ie_tipo_atendimento_w, cd_categoria_conv_w,'N',0, cd_estabelecimento_w, ie_clinica_w, nr_seq_classif_atend_w, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@',cd_setor_exec_proc_w),
			cd_medico_executor_w,
			cd_especialidade_w,
			dt_inicio_w,
			dt_fim_w,
			ie_honorario_w,
			tiss_obter_regra_campo(ie_tiss_tipo_guia_w, 'IE_TECNICA_UTILIZADA', cd_convenio_w, ie_tecnica_utilizada_w, ie_tipo_atendimento_w, cd_categoria_conv_w,'N',0, cd_estabelecimento_w, ie_clinica_w, nr_seq_classif_atend_w, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@',cd_setor_exec_proc_w),			
			ie_responsavel_credito_w,
			cd_senha_w,
			cd_cbo_exec_w,
			cd_prestador_tiss_w,
			cd_cgc_prest_solic_tiss_w,
			cd_medico_exec_tiss_w,
			nr_seq_med_fatur_p,
			ds_prestador_tiss_w,
			ie_beneficiario_med_w,
			ie_tipo_atend_tiss_w,
			nr_atend_med_p,
			nr_seq_prot_med_p,
			cd_med_solic_tasymed_w,
			cd_medico_solic_tiss_w,
			coalesce(cd_medico_solic_w,cd_medico_prof_solic_tiss_w),
			cd_func_honor_w,
			cd_prestador_solic_w,
			ds_prestador_solic_w,
			cd_medico_honor_tiss_w,
			ie_xml_w,
			cd_medico_convenio_proc_w,
			cd_cgc_prest_honor_tiss_w,
			crm_medico_externo_w,			
			nm_medico_externo_w,
			cd_medico_exec_proc_honor_w,
			ds_indicacao_proc_prescr_w,
			nr_dente_w,
			ds_face_dente_w,
			nr_guia_prestador_w,
			nr_guia_operadora_w,
			cd_setor_exec_proc_w,
      cd_regiao_boca_w);

		if (w_40ASADT_w IS NOT NULL AND w_40ASADT_w::text <> '') then

			insert into tiss_conta_proc_prest(nr_sequencia,
				dt_atualizacao,
				nm_usuario,
				dt_atualizacao_nrec,
				nm_usuario_nrec,
				nr_seq_conta_proc,
				nr_seq_campo_prest,
				ds_valor)
			values (nextval('tiss_conta_proc_prest_seq'),
				clock_timestamp(),
				nm_usuario_p,
				clock_timestamp(),
				nm_usuario_p,
				nr_seq_conta_proc_w,
				OBTER_VALOR_CAMPO_SEPARADOR(w_40ASADT_w,1,';'),
				OBTER_VALOR_CAMPO_SEPARADOR(w_40ASADT_w,2,';'));
		end if;

		if (w_41SADT_w IS NOT NULL AND w_41SADT_w::text <> '') then

			insert into tiss_conta_proc_prest(nr_sequencia,
				dt_atualizacao,
				nm_usuario,
				dt_atualizacao_nrec,
				nm_usuario_nrec,
				nr_seq_conta_proc,
				nr_seq_campo_prest,
				ds_valor)
			values (nextval('tiss_conta_proc_prest_seq'),
				clock_timestamp(),
				nm_usuario_p,
				clock_timestamp(),
				nm_usuario_p,
				nr_seq_conta_proc_w,
				OBTER_VALOR_CAMPO_SEPARADOR(w_41SADT_w,1,';'),
				OBTER_VALOR_CAMPO_SEPARADOR(w_41SADT_w,2,';'));
		end if;

		if (w_40ASADTH_w IS NOT NULL AND w_40ASADTH_w::text <> '') then

			insert into tiss_conta_proc_prest(nr_sequencia,
				dt_atualizacao,
				nm_usuario,
				dt_atualizacao_nrec,
				nm_usuario_nrec,
				nr_seq_conta_proc,
				nr_seq_campo_prest,
				ds_valor)
			values (nextval('tiss_conta_proc_prest_seq'),
				clock_timestamp(),
				nm_usuario_p,
				clock_timestamp(),
				nm_usuario_p,
				nr_seq_conta_proc_w,
				OBTER_VALOR_CAMPO_SEPARADOR(w_40ASADTH_w,1,';'),
				OBTER_VALOR_CAMPO_SEPARADOR(w_40ASADTH_w,2,';'));
		end if;

		if (w_41SADTH_w IS NOT NULL AND w_41SADTH_w::text <> '') then

			insert into tiss_conta_proc_prest(nr_sequencia,
				dt_atualizacao,
				nm_usuario,
				dt_atualizacao_nrec,
				nm_usuario_nrec,
				nr_seq_conta_proc,
				nr_seq_campo_prest,
				ds_valor)
			values (nextval('tiss_conta_proc_prest_seq'),
				clock_timestamp(),
				nm_usuario_p,
				clock_timestamp(),
				nm_usuario_p,
				nr_seq_conta_proc_w,
				OBTER_VALOR_CAMPO_SEPARADOR(w_41SADTH_w,1,';'),
				OBTER_VALOR_CAMPO_SEPARADOR(w_41SADTH_w,2,';'));
		end if;
		
		if (w_45ASADT_w IS NOT NULL AND w_45ASADT_w::text <> '') then			
			
			insert into tiss_conta_proc_prest(nr_sequencia,
				dt_atualizacao,
				nm_usuario,
				dt_atualizacao_nrec,
				nm_usuario_nrec,
				nr_seq_conta_proc,
				nr_seq_campo_prest,
				ds_valor)
			values (nextval('tiss_conta_proc_prest_seq'),
				clock_timestamp(),
				nm_usuario_p,
				clock_timestamp(),
				nm_usuario_p,
				nr_seq_conta_proc_w,
				OBTER_VALOR_CAMPO_SEPARADOR(w_45ASADT_w,1,';'),
				OBTER_VALOR_CAMPO_SEPARADOR(w_45ASADT_w,2,';'));
		end if;
		
		if (w_45ASADTH_w IS NOT NULL AND w_45ASADTH_w::text <> '') then		
			insert into tiss_conta_proc_prest(nr_sequencia,
				dt_atualizacao,
				nm_usuario,
				dt_atualizacao_nrec,
				nm_usuario_nrec,
				nr_seq_conta_proc,
				nr_seq_campo_prest,
				ds_valor)
			values (nextval('tiss_conta_proc_prest_seq'),
				clock_timestamp(),
				nm_usuario_p,
				clock_timestamp(),
				nm_usuario_p,
				nr_seq_conta_proc_w,
				OBTER_VALOR_CAMPO_SEPARADOR(w_45ASADTH_w,1,';'),
				OBTER_VALOR_CAMPO_SEPARADOR(w_45ASADTH_w,2,';'));
		end if;

		exception
		when others then
			CALL wheb_mensagem_pck.exibir_mensagem_abort(183154,'sqlerrm='||sqlerrm||
									';nr_seq_proc_w='||nr_seq_proc_w);
			--r.aise_application_error(-20011, sqlerrm || chr(13) || 'nr_seq_proc_w = ' || nr_seq_proc_w);
		end;

		/* edgar 19/02/2009, os 128872, inserir os participantes adicionais */

		if (coalesce(nr_seq_partic_adic_w,0) > 0) then

			insert into tiss_conta_partic(nr_sequencia,
				nr_interno_conta,
				ie_tiss_tipo_guia,
				cd_autorizacao,
				dt_atualizacao,
				nm_usuario,
				nr_seq_proc,
				ie_funcao_medico,
				cd_medico_convenio,
				nm_medico_executor,
				sg_conselho,
				nr_crm,
				uf_crm,
				nr_cpf,
				cd_cgc,
				vl_participante,
				cd_cbos,
				nr_cpf_relat,
				dt_procedimento)
			SELECT	nextval('tiss_conta_partic_seq'),
				nr_interno_conta_p,
				ie_tiss_tipo_guia_w,
				cd_autorizacao_w,
				clock_timestamp(),
				nm_usuario_p,
				nr_seq_conta_proc_w,
				tiss_obter_regra_campo_proc(lpad(tiss_obter_grau_partic(ie_funcao),2,0), '5', cd_convenio_w, cd_estabelecimento_w, cd_procedimento_w, ie_origem_proced_w, ie_clinica_w, cd_categoria_conv_w, cd_plano_convenio_w,ie_tipo_atendimento_w,ie_carater_internacao_w, ie_tiss_tipo_guia_w),
				tiss_obter_regra_campo(ie_tiss_tipo_guia_w, 'CD_IDENTIFICACAO', cd_convenio_w, cd_interno, ie_tipo_atendimento_w, cd_categoria_conv_w,'N',0, cd_estabelecimento_w, ie_clinica_w, nr_seq_classif_atend_w, cd_setor_entrada_w, coalesce(ie_tipo_atend_tiss_w,ie_tipo_atend_conta_w)||'#@',cd_setor_exec_proc_w),
				nm_participante,
				sg_conselho,
				nr_crm,
				uf_crm,
				nr_cpf,
				null,
				vl_participante,
				cd_cbos,
				nr_cpf,
				dt_procedimento_w
			from	tiss_conta_partic_adic
			where	nr_sequencia	= nr_seq_partic_adic_w;
		end if;
		

		/* o if para ver se agrupa os procedimentos da guia, pois se tem participantes nao deve agrupar;
		   o else serve para agrupar se tiver o executor.
		   os73828 - 08/11/2007.
		*/


-- dsantos em 06/05/2009 para fazer a tiss_obter_se_envia_partic dentro do cursor02

		/*
		lhalves OS 379368 em 14/11/2011 - Aplicar a regra a nivel de participante, dentor do c02, antes a regra era aplicada a nivel de procedimento, onde era considerado o resp credito do procedimento e nao do participante.
		tiss_obter_se_envia_partic(	cd_convenio_w,  
						cd_estabelecimento_w,
						cd_procedimento_w,
						ie_origem_proced_w,
						ie_tiss_tipo_guia_w,
						ie_enviar_partic_w,
						ie_responsavel_credito_w,
						ie_proc_pacote_regra_w);*/
				
		
		if (coalesce(nr_seq_proc_w, 0)		> 0) and
			((ie_tiss_tipo_guia_w		<> '5') or (coalesce(ie_participante_ri_w,'S')	= 'S')) then

			open c02;
			loop
			fetch c02 into				
				ie_tiss_tipo_guia_partic_w,
				ie_funcao_medico_partic_w,
				vl_participante_w,
				cd_autorizacao_w,
				cd_medico_executor_w,
				cd_cbo_saude_w,
				cd_cgc_prestador_partic_w,
				ie_resp_credito_partic_w,
				ie_regra_w,
				sg_conselho_regra_w,
				nr_conselho_w,
				uf_conselho_w,
				cd_funcionario_partic_w,
				cd_setor_atendimento_w,
				cd_medico_convenio_partic_w;
			EXIT WHEN NOT FOUND; /* apply on c02 */
			
				ie_funcao_regra_prest_w := ie_funcao_medico_partic_w;
			
				if (cd_funcionario_partic_w IS NOT NULL AND cd_funcionario_partic_w::text <> '') and (ie_tiss_tipo_guia_partic_w	= '5') and (ie_exec_ri_w			= 'S') and (coalesce(cd_medico_executor_w::text, '') = '') then
					cd_medico_executor_w	:= cd_funcionario_partic_w;
				end if;
			
				/*lhalves OS 379368 em 14/11/2011 - Aplicar a regra a nivel de participante */

				ie_enviar_partic_w := tiss_obter_se_envia_partic(	cd_convenio_w, cd_estabelecimento_w, cd_procedimento_w, ie_origem_proced_w, ie_tiss_tipo_guia_w, ie_enviar_partic_w, ie_resp_credito_partic_w, ie_proc_pacote_regra_w, somente_numero(ie_funcao_medico_partic_w), cd_medico_executor_w, cd_setor_atendimento_w, nr_seq_proc_interno_w, dt_procedimento_w);
												
				if (ie_enviar_partic_w = 'S') or (ie_enviar_partic_w = 'Z' and vl_participante_w > 0) then
					
					/*lhalves OS 238167*/

					cd_medico_partic_tiss_w := tiss_converte_membro_equipe(cd_estabelecimento_p, cd_convenio_w, nm_usuario_p, cd_medico_executor_w, cd_setor_atendimento_w, cd_procedimento_w, ie_origem_proced_w, ie_funcao_medico_partic_w, ie_resp_credito_partic_w, dt_inicio_w, cd_medico_partic_tiss_w);

					if (cd_medico_partic_tiss_w IS NOT NULL AND cd_medico_partic_tiss_w::text <> '') then
						cd_medico_executor_w	:= cd_medico_partic_tiss_w;
					end if;	

					select	max(cd_pessoa_fisica)
					into STRICT	cd_medico_conveniado_w
					from	medico_convenio
					where	cd_pessoa_fisica	= cd_medico_executor_w
					and	cd_convenio		= cd_convenio_w
					and	ie_conveniado		= 'S';

					/* lhalves OS239719 em 18/08/2010. 
					Este if abaixo, verifica o parametro ie_membro_exec_w, para determinar se para SP/SADT 
					deve gerar como membro equipe, apenas o medico executor complementar da guia e nao todos 
					os participantes do procedimento
					Para RI deve gerar todos, sem considerar o parametro*/
					if	((ie_membro_exec_w 	= 'N') or
						 ((ie_membro_exec_w 	= 'S') and (ie_tiss_tipo_guia_w 	not in ('4'))) or
						 ((ie_membro_exec_w 	= 'S') and (ie_tiss_tipo_guia_w 	= '4') and (cd_medico_exec_proc_w = cd_medico_executor_w))					
						) then

						if (ie_honor_partic_w		= 'S') or (ie_regra_w			= 'S') or
							((ie_honor_partic_w		= 'N') and (coalesce(cd_medico_conveniado_w,0)	= 0)   and (ie_tiss_tipo_guia_partic_w	in ('4','5'))) then

							if (ie_regra_w = 'N') then

								select	max(tiss_obter_grau_partic(ie_funcao_medico_partic_w))
								into STRICT	ie_funcao_medico_partic_w
								;								

								select	max(nr_crm),
									max(uf_crm)
								into STRICT	nr_crm_w,
									uf_crm_w
								from	medico
								where	cd_pessoa_fisica	= cd_medico_executor_w;
								
								select	max(nm_pessoa_fisica),
									max(nr_seq_conselho),
									coalesce(nr_crm_w,max(ds_codigo_prof)),
									coalesce(uf_crm_w,max(uf_conselho))
								into STRICT	nm_medico_executor_w,
									nr_seq_conselho_w,
									nr_crm_w,
									uf_crm_w
								from	pessoa_fisica
								where	cd_pessoa_fisica	= cd_medico_executor_w;

								select	max(coalesce(ie_conselho_prof_tiss,sg_conselho))
								into STRICT	sg_conselho_w
								from	conselho_profissional
								where	nr_sequencia		= nr_seq_conselho_w;

								if	((coalesce(nr_atend_med_p,0) > 0) and (coalesce(nr_seq_prot_med_p,0) > 0)) then
									select	max(tiss_obter_codigo_medico(cd_estabelecimento_w, cd_convenio_w, cd_medico_executor_w, 'CIM')),
										max(tiss_obter_codigo_medico(cd_estabelecimento_w, cd_convenio_w, cd_medico_executor_w, 'CPF'))
									into STRICT	cd_medico_convenio_w,
										nr_cpf_w
									;							
								else
									select	max(tiss_obter_codigo_prestador(cd_convenio_w, cd_estabelecimento_w, cd_medico_executor_w, null, coalesce(cd_setor_exec_proc_w, cd_setor_entrada_w) , 'CI', dt_procedimento_w,ie_tipo_atendimento_w,cd_categoria_conv_w,ie_funcao_regra_prest_w)),
										max(tiss_obter_codigo_prestador(cd_convenio_w, cd_estabelecimento_w, cd_medico_executor_w, null, coalesce(cd_setor_exec_proc_w, cd_setor_entrada_w) , 'CPF', dt_procedimento_w,ie_tipo_atendimento_w,cd_categoria_conv_w,ie_funcao_regra_prest_w))
									into STRICT	cd_medico_convenio_w,
										nr_cpf_w
									;
									
									if (cd_medico_convenio_w IS NOT NULL AND cd_medico_convenio_w::text <> '') then
										nm_medico_executor_w := coalesce(Obter_Nome_Medico_Convenio(cd_estabelecimento_w, cd_medico_executor_w, cd_convenio_w, null, cd_especialidade_w, cd_categoria_conv_w, cd_setor_entrada_w,ie_tipo_atendimento_w), nm_medico_executor_w);
									end if;			
									
								end if;							

								select	max(nr_cpf)
								into STRICT	nr_cpf_partic_w
								from	pessoa_fisica
								where	cd_pessoa_fisica	= cd_medico_executor_w;

							else

								select	substr(obter_nome_pf_pj(null, cd_cgc_prestador_partic_w),1,200),
									max(tiss_obter_codigo_prestador(cd_convenio_w, cd_estabelecimento_w, null, cd_cgc_prestador_partic_w, coalesce(cd_setor_exec_proc_w, cd_setor_entrada_w) , 'CI', dt_procedimento_w,ie_tipo_atendimento_w,cd_categoria_conv_w,ie_funcao_regra_prest_w))
								into STRICT	nm_medico_executor_w,
									cd_medico_convenio_w
								;

								sg_conselho_w	:= sg_conselho_regra_w;
								nr_crm_w	:= nr_conselho_w;
								uf_crm_w	:= uf_conselho_w;
								nr_cpf_w	:= null;
								nr_cpf_partic_w	:= null;

							end if;

							if (coalesce(cd_cgc_prestador_partic_w::text, '') = '') then
								cd_cgc_prestador_partic_w		:= cd_cgc_prestador_w;
							end if;
						
							if (ds_mascara_crm_w IS NOT NULL AND ds_mascara_crm_w::text <> '') then

								if (length(nr_crm_w) < length(ds_mascara_crm_w)) then
									qt_digitos_crm_w	:= length(ds_mascara_crm_w);
									nr_crm_w		:= lpad(nr_crm_w, qt_digitos_crm_w,0);
								end if;			
					
								begin
								select	TISS_OBTER_COD_USUARIO_MASC(nr_crm_w, ds_mascara_crm_w)
								into STRICT	nr_crm_mascara_w
								;
								
								exception
								when others then
									nr_crm_mascara_w	:= null;
								end;
					
								if (nr_crm_mascara_w IS NOT NULL AND nr_crm_mascara_w::text <> '') then
									nr_crm_w	:= nr_crm_mascara_w;
								end if;
							end if;
							
							if (cd_medico_convenio_partic_w IS NOT NULL AND cd_medico_convenio_partic_w::text <> '') then
								cd_medico_convenio_w	:= cd_medico_convenio_partic_w;
								nr_cpf_w		:= null;
							end if;					
							
							insert	into tiss_conta_partic(nr_sequencia,
								nr_interno_conta,
								ie_tiss_tipo_guia,
								cd_autorizacao,
								dt_atualizacao,
								nm_usuario,
								nr_seq_proc,
								ie_funcao_medico,
								cd_medico_convenio,
								nm_medico_executor,
								sg_conselho,
								nr_crm,
								uf_crm,
								nr_cpf,
								cd_cgc,
								vl_participante,
								cd_cbos,
								nr_cpf_relat,
								dt_procedimento)
							values (nextval('tiss_conta_partic_seq'),
								nr_interno_conta_p,
								ie_tiss_tipo_guia_partic_w,
								cd_autorizacao_w,
								clock_timestamp(),
								nm_usuario_p,
								nr_seq_conta_proc_w,
								tiss_obter_regra_campo_proc(lpad(ie_funcao_medico_partic_w,2,0), '5', cd_convenio_w, cd_estabelecimento_w, cd_procedimento_w, ie_origem_proced_w, ie_clinica_w, cd_categoria_conv_w, cd_plano_convenio_w,ie_tipo_atendimento_w,ie_carater_internacao_w, ie_tiss_tipo_guia_w),
								tiss_obter_regra_campo(ie_tiss_tipo_guia_w, 'CD_IDENTIFICACAO', cd_convenio_w, cd_medico_convenio_w, ie_tipo_atendimento_w, cd_categoria_conv_w,'N',0, cd_estabelecimento_w, ie_clinica_w, nr_seq_classif_atend_w, cd_setor_entrada_w, coalesce(ie_tipo_atend_tiss_w,ie_tipo_atend_conta_w)||'#@',cd_setor_exec_proc_w),
								tiss_eliminar_caractere(nm_medico_executor_w),
								sg_conselho_w,
								substr(tiss_obter_regra_campo(ie_tiss_tipo_guia_w, 'NR_CRM', cd_convenio_w, nr_crm_w, ie_tipo_atendimento_w, cd_categoria_conv_w,'N',0, cd_estabelecimento_w, ie_clinica_w, nr_seq_classif_atend_w, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@',cd_setor_exec_proc_w), 1, 20),
								uf_crm_w,
								nr_cpf_w,
								cd_cgc_prestador_partic_w,
								vl_participante_w,
								tiss_obter_regra_campo(ie_tiss_tipo_guia_w, 'CD_CBOS_EQUIPE', cd_convenio_w, cd_cbo_saude_w, ie_tipo_atendimento_w, cd_categoria_conv_w,'N',0, cd_estabelecimento_w, ie_clinica_w, nr_seq_classif_atend_w, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@',cd_setor_exec_proc_w),
								nr_cpf_partic_w,
								dt_procedimento_w);

						end if;
					end if;
				end if;
			end loop;
			close c02;			

		else

			if	((ie_tiss_tipo_guia_w		<> '5') or (coalesce(ie_participante_ri_w,'S')	= 'S')) then

				open c04;
				loop
				fetch c04 into
					ie_funcao_medico_proc_w,
					cd_cgc_prestador_partic_w,
					sg_conselho_w,
					nr_crm_w,
					uf_crm_w,
					cd_cbo_saude_w;
				EXIT WHEN NOT FOUND; /* apply on c04 */

					select	substr(obter_nome_pf_pj(null, cd_cgc_prestador_partic_w),1,200),
						max(tiss_obter_codigo_prestador(cd_convenio_w, cd_estabelecimento_w, null, cd_cgc_prestador_partic_w, coalesce(cd_setor_exec_proc_w, cd_setor_entrada_w) , 'CI', dt_procedimento_w,ie_tipo_atendimento_w,cd_categoria_conv_w))
					into STRICT	nm_medico_executor_w,
						cd_medico_convenio_w
					;									

					nr_cpf_w	:= null;
					nr_cpf_partic_w	:= null;

					if (ds_mascara_crm_w IS NOT NULL AND ds_mascara_crm_w::text <> '') then

						if (length(nr_crm_w) < length(ds_mascara_crm_w)) then
							qt_digitos_crm_w	:= length(ds_mascara_crm_w);
							nr_crm_w		:= lpad(nr_crm_w, qt_digitos_crm_w,0);
						end if;			
				
						begin
						select	TISS_OBTER_COD_USUARIO_MASC(nr_crm_w, ds_mascara_crm_w)
						into STRICT	nr_crm_mascara_w
						;
						
						exception
						when others then
							nr_crm_mascara_w	:= null;
						end;
				
						if (nr_crm_mascara_w IS NOT NULL AND nr_crm_mascara_w::text <> '') then
							nr_crm_w	:= nr_crm_mascara_w;
						end if;
					end if;

					insert	into tiss_conta_partic(nr_sequencia,
						nr_interno_conta,
						ie_tiss_tipo_guia,
						cd_autorizacao,
						dt_atualizacao,
						nm_usuario,
						nr_seq_proc,
						ie_funcao_medico,
						cd_medico_convenio,
						nm_medico_executor,
						sg_conselho,
						nr_crm,
						uf_crm,
						nr_cpf,
						cd_cgc,
						vl_participante,
						cd_cbos,
						nr_cpf_relat,
						nr_seq_med_fatur,
						dt_procedimento)
					values (nextval('tiss_conta_partic_seq'),
						nr_interno_conta_p,
						ie_tiss_tipo_guia_w,
						cd_autorizacao_w,
						clock_timestamp(),
						nm_usuario_p,
						nr_seq_conta_proc_w,
						tiss_obter_regra_campo_proc(lpad(ie_funcao_medico_proc_w,2,0), '5', cd_convenio_w, cd_estabelecimento_w, cd_procedimento_w, ie_origem_proced_w, ie_clinica_w, cd_categoria_conv_w, cd_plano_convenio_w,ie_tipo_atendimento_w,ie_carater_internacao_w, ie_tiss_tipo_guia_w),
						tiss_obter_regra_campo(ie_tiss_tipo_guia_w, 'CD_IDENTIFICACAO', cd_convenio_w, cd_medico_convenio_w, ie_tipo_atendimento_w, cd_categoria_conv_w,'N',0, cd_estabelecimento_w, ie_clinica_w, nr_seq_classif_atend_w, cd_setor_entrada_w, coalesce(ie_tipo_atend_tiss_w,ie_tipo_atend_conta_w)||'#@',cd_setor_exec_proc_w),
						tiss_eliminar_caractere(nm_medico_executor_w),
						sg_conselho_w,
						nr_crm_w,
						uf_crm_w,
						nr_cpf_w,
						cd_cgc_prestador_partic_w,
						vl_participante_w,
						tiss_obter_regra_campo(ie_tiss_tipo_guia_w, 'CD_CBOS_EQUIPE', cd_convenio_w, cd_cbo_saude_w, ie_tipo_atendimento_w, cd_categoria_conv_w,'N',0, cd_estabelecimento_w, ie_clinica_w, nr_seq_classif_atend_w, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@',cd_setor_exec_proc_w),
						nr_cpf_partic_w,
						nr_seq_med_fatur_p,
						dt_procedimento_w);

				end loop;
				close c04;

				if (cd_medico_exec_proc_w IS NOT NULL AND cd_medico_exec_proc_w::text <> '') then

					select	max(cd_pessoa_fisica)
					into STRICT	cd_medico_conveniado_w
					from	medico_convenio
					where	cd_pessoa_fisica	= cd_medico_exec_proc_w
					and	cd_convenio		= cd_convenio_w
					and	ie_conveniado		= 'S';

					if	((ie_honor_partic_w		= 'S') or
						 ((ie_honor_partic_w		= 'N') and (coalesce(cd_medico_conveniado_w,0)	= 0)   and (ie_tiss_tipo_guia_partic_w	in ('4','5')))) and (ie_partic_spsadt_w		= 'S') and
						((ie_partic_conveniado_w	= 'N') or (tiss_obter_se_partic_conv(cd_estabelecimento_w, cd_convenio_w, cd_medico_exec_proc_w) = 'S')) then					

						select	max(nr_crm),
							max(uf_crm),
							max(tiss_obter_cbos_medico(cd_medico_exec_proc_w, cd_especialidade_proc_w, ds_versao_w, cd_convenio_w))
						into STRICT	nr_crm_w,
							uf_crm_w,
							cd_cbo_saude_w
						from	medico
						where	cd_pessoa_fisica	= cd_medico_exec_proc_w;
						
						select	max(nm_pessoa_fisica),
							max(nr_seq_conselho),
							coalesce(nr_crm_w,max(ds_codigo_prof)),
							coalesce(uf_crm_w,max(uf_conselho))
						into STRICT	nm_medico_executor_w,
							nr_seq_conselho_w,
							nr_crm_w,
							uf_crm_w
						from	pessoa_fisica
						where	cd_pessoa_fisica	= cd_medico_exec_proc_w;

						select	max(coalesce(ie_conselho_prof_tiss,sg_conselho))
						into STRICT	sg_conselho_w
						from	conselho_profissional
						where	nr_sequencia		= nr_seq_conselho_w;

						if	((coalesce(nr_atend_med_p,0) > 0) and (coalesce(nr_seq_prot_med_p,0) > 0)) then
							select	max(tiss_obter_codigo_medico(cd_estabelecimento_w,cd_convenio_w,cd_medico_exec_proc_w,'CIM')),
								max(tiss_obter_codigo_medico(cd_estabelecimento_w,cd_convenio_w,cd_medico_exec_proc_w,'CPF'))
							into STRICT	cd_medico_convenio_w,
								nr_cpf_w
							;
						else
							select	max(tiss_obter_codigo_prestador(cd_convenio_w, cd_estabelecimento_w, cd_medico_exec_proc_w, null, coalesce(cd_setor_exec_proc_w, cd_setor_entrada_w) , 'CI', dt_procedimento_w,ie_tipo_atendimento_w,cd_categoria_conv_w,ie_funcao_medico_w)),
								max(tiss_obter_codigo_prestador(cd_convenio_w, cd_estabelecimento_w, cd_medico_exec_proc_w, null, coalesce(cd_setor_exec_proc_w, cd_setor_entrada_w) , 'CPF', dt_procedimento_w,ie_tipo_atendimento_w,cd_categoria_conv_w,ie_funcao_medico_w))
							into STRICT	cd_medico_convenio_w,
								nr_cpf_w
							;
						end if;
						
						if (cd_medico_convenio_partic_w IS NOT NULL AND cd_medico_convenio_partic_w::text <> '') then
							cd_medico_convenio_w	:= cd_medico_convenio_partic_w;
							nr_cpf_w 		:= null;
						end if;						

						select	max(nr_cpf)
						into STRICT	nr_cpf_partic_w
						from	pessoa_fisica
						where	cd_pessoa_fisica	= cd_medico_exec_proc_w;

						if (coalesce(cd_cgc_prestador_partic_w::text, '') = '') then
							cd_cgc_prestador_partic_w		:= cd_cgc_prestador_w;
						end if;

						if (ds_mascara_crm_w IS NOT NULL AND ds_mascara_crm_w::text <> '') then

							if (length(nr_crm_w) < length(ds_mascara_crm_w)) then
								qt_digitos_crm_w	:= length(ds_mascara_crm_w);
								nr_crm_w		:= lpad(nr_crm_w, qt_digitos_crm_w,0);
							end if;			
				
							begin
							select	TISS_OBTER_COD_USUARIO_MASC(nr_crm_w, ds_mascara_crm_w)
							into STRICT	nr_crm_mascara_w
							;
							
							exception
							when others then
								nr_crm_mascara_w	:= null;
							end;
				
							if (nr_crm_mascara_w IS NOT NULL AND nr_crm_mascara_w::text <> '') then
								nr_crm_w	:= nr_crm_mascara_w;
							end if;
						end if;

						insert	into tiss_conta_partic(nr_sequencia,
							nr_interno_conta,
							ie_tiss_tipo_guia,
							cd_autorizacao,
							dt_atualizacao,
							nm_usuario,
							nr_seq_proc,
							ie_funcao_medico,
							cd_medico_convenio,
							nm_medico_executor,
							sg_conselho,
							nr_crm,
							uf_crm,
							nr_cpf,
							cd_cgc,
							vl_participante,
							cd_cbos,
							nr_cpf_relat,
							nr_seq_med_fatur,
							dt_procedimento)
						values (nextval('tiss_conta_partic_seq'),
							nr_interno_conta_p,
							ie_tiss_tipo_guia_w,
							cd_autorizacao_w,
							clock_timestamp(),
							nm_usuario_p,
							nr_seq_conta_proc_w,
							tiss_obter_regra_campo_proc(lpad(ie_funcao_medico_proc_w,2,0), '5', cd_convenio_w, cd_estabelecimento_w, cd_procedimento_w, ie_origem_proced_w, ie_clinica_w, cd_categoria_conv_w, cd_plano_convenio_w,ie_tipo_atendimento_w,ie_carater_internacao_w, ie_tiss_tipo_guia_w),
							tiss_obter_regra_campo(ie_tiss_tipo_guia_w, 'CD_IDENTIFICACAO', cd_convenio_w, cd_medico_convenio_w, ie_tipo_atendimento_w, cd_categoria_conv_w,'N',0, cd_estabelecimento_w, ie_clinica_w, nr_seq_classif_atend_w, cd_setor_entrada_w, coalesce(ie_tipo_atend_tiss_w,ie_tipo_atend_conta_w)||'#@',cd_setor_exec_proc_w),
							tiss_eliminar_caractere(nm_medico_executor_w),
							sg_conselho_w,
							nr_crm_w,
							uf_crm_w,
							nr_cpf_w,
							cd_cgc_prestador_partic_w,
							vl_participante_w,
							tiss_obter_regra_campo(ie_tiss_tipo_guia_w, 'CD_CBOS_EQUIPE', cd_convenio_w, cd_cbo_saude_w, ie_tipo_atendimento_w, cd_categoria_conv_w,'N',0, cd_estabelecimento_w, ie_clinica_w, nr_seq_classif_atend_w, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@',cd_setor_exec_proc_w),
							nr_cpf_partic_w,
							nr_seq_med_fatur_p,
							dt_procedimento_w);
					end if;
				end if;
			end if;
		end if;

	end if;	
end loop;
close c01;

if (coalesce(wheb_usuario_pck.get_ie_commit, 'S') = 'S') then commit; end if;
if (coalesce(ie_forcar_agrup_w, 'N') = 'S') then

	CALL tiss_gerar_log_conta(	nr_interno_conta_p,
				'Forcar agrupamento dos procedimentos com participantes (PHILIPS NaO RECOMENDA)',
				nm_usuario_p);
	
	CALL TISS_GERAR_CONTA_PROC_W(nr_interno_conta_p, nm_usuario_p, ie_emitir_spsadt_zerado_w, ie_ri_zerado_w);
end if;

if (coalesce(wheb_usuario_pck.get_ie_commit, 'S') = 'S') then commit; end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE tiss_gerar_conta_proc ( nr_interno_conta_p bigint, nr_seq_med_fatur_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text, nr_atend_med_p bigint, nr_seq_prot_med_p bigint) FROM PUBLIC;

