-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE cus_w_centro_relevancia ( cd_estab_p bigint, cd_grupo_natureza_gasto_p text, dt_referencia_p timestamp, ie_orcado_real_p text) AS $body$
DECLARE


/*Utilizada na geração do relatório WCUS 6013 criado a partir do CCUS 5891 por Matheus e Fábio em 29-09-2006*/

varsql					varchar(1) := chr(39);
ds_comando_w				varchar(2000);
dt_referencia_w				timestamp;
cd_centro_controle_w			integer;
vl_orcado_mes_w				double precision;
vl_orcado_total_w			double precision;
ie_relevancia_w				integer;
qt_percentual_w				double precision;
cd_grupo_natureza_gasto_w		varchar(400);
qt_tabela_w				bigint;
ie_orcado_real_w			varchar(1);


C00 CURSOR FOR
SELECT	distinct(t.dt_mes_referencia)
from 	grupo_natureza_gasto b,
	tabela_custo t,
	orcamento_custo a
where 	a.cd_estabelecimento	= cd_estab_p
and 	t.cd_tipo_tabela_custo	= 5
and	t.cd_tabela_custo	= a.cd_tabela_custo
and	((ie_orcado_real_w	= 'X') or (t.ie_orcado_real	= ie_orcado_real_w))
and	t.dt_mes_referencia between pkg_date_utils.add_month(dt_referencia_p, -6,0) and dt_referencia_p
order by 1;

C01 CURSOR FOR
SELECT	a.cd_centro_controle,
	sum(a.vl_orcado) vl_orcado_mes
from 	natureza_gasto c,
	grupo_natureza_gasto b,
	tabela_custo t,
	orcamento_custo a
where 	a.cd_estabelecimento		= cd_estab_p
and 	t.cd_tipo_tabela_custo		= 5
and 	a.cd_natureza_gasto		= c.cd_natureza_gasto
and 	c.cd_grupo_natureza_gasto	= b.cd_grupo_natureza_gasto
and	a.nr_seq_ng			= c.nr_sequencia
and	c.nr_seq_gng			= b.nr_sequencia
and	t.cd_tabela_custo		= a.cd_tabela_custo
and	t.dt_mes_referencia 		= dt_referencia_w
and	((ie_orcado_real_w	= 'X') or (t.ie_orcado_real	= ie_orcado_real_w))
and	((coalesce(cd_grupo_natureza_gasto_p::text, '') = '') or (obter_se_contido(b.cd_grupo_natureza_gasto, cd_grupo_natureza_gasto_p) = 'S'))
group by a.cd_centro_controle
order by vl_orcado_mes desc;


BEGIN
delete from w_centro_relevancia;

ie_orcado_real_w := coalesce(ie_orcado_real_p,'X');

open C00;
loop
fetch C00 into
	dt_referencia_w;
EXIT WHEN NOT FOUND; /* apply on c00 */
	begin
	ie_relevancia_w		:= 0;
	/* Matheus OS 54738 16/04/2007 adicionei restricao por GNG*/

	select	sum(a.vl_orcado)
	into STRICT	vl_orcado_total_w
	from 	natureza_gasto c,
		grupo_natureza_gasto b,
		tabela_custo t,
		orcamento_custo a
	where 	a.cd_estabelecimento		= cd_estab_p
	and 	t.cd_tipo_tabela_custo		= 5
	and 	a.cd_natureza_gasto		= c.cd_natureza_gasto
	and 	c.cd_grupo_natureza_gasto	= b.cd_grupo_natureza_gasto
	and	a.nr_seq_ng			= c.nr_sequencia
	and	c.nr_seq_gng			= b.nr_sequencia
	and	t.cd_tabela_custo		= a.cd_tabela_custo
	and	t.dt_mes_referencia 		= dt_referencia_w
	and	((ie_orcado_real_w	= 'X') or (t.ie_orcado_real	= ie_orcado_real_w))
	and	((coalesce(cd_grupo_natureza_gasto_p::text, '') = '') or (obter_se_contido(b.cd_grupo_natureza_gasto, cd_grupo_natureza_gasto_p) = 'S'));

	open C01;
	loop
	fetch C01 into
		cd_centro_controle_w,
		vl_orcado_mes_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
		begin

		qt_percentual_w	:= dividir(vl_orcado_mes_w * 100, vl_orcado_total_w);
		ie_relevancia_w	:= ie_relevancia_w + 1;
		insert into w_centro_relevancia(
			dt_referencia,
			cd_centro_controle,
			ie_relevancia,
			qt_percentual,
			vl_orcado_mes)
		values (	dt_referencia_w,
			cd_centro_controle_w,
			ie_relevancia_w,
			qt_percentual_w,
			vl_orcado_mes_w);

		end;
	end loop;
	close C01;
	end;
end loop;
close C00;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cus_w_centro_relevancia ( cd_estab_p bigint, cd_grupo_natureza_gasto_p text, dt_referencia_p timestamp, ie_orcado_real_p text) FROM PUBLIC;

