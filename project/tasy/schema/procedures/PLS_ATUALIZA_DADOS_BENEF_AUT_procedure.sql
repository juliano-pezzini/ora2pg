-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_atualiza_dados_benef_aut ( nr_seq_analise_p bigint, nr_seq_segurado_p bigint, nr_telef_secretaria_p text, nm_secretaria_p text, nr_telef_beneficiario_p text, nr_telef_celular_benef_p text, ds_email_beneficiario_p text, ie_parametro_regra_p text, /* Valor do parâmetro [62] da função OPS - Gestão de Análise de autorizações  */
 cd_estabelecimento_p bigint, nm_usuario_p text ) AS $body$
DECLARE

					

nr_seq_regra_atualizacao_w	varchar(10);
ie_funcao_validacao_w		varchar(2);
cd_pessoa_fisica_w		varchar(10);
nr_ddd_celular_w		varchar(2);
nr_ddd_telef_benef_w		varchar(2);
nr_ddd_telef_secretaria_w	varchar(2);
nr_telef_celular_benef_w	varchar(4000);
nr_telef_beneficiario_w		varchar(4000);
nr_telef_secretaria_w		varchar(4000);



BEGIN

SELECT * FROM pls_verifica_atualizacao_cad( nr_seq_segurado_p, 'A', nr_seq_regra_atualizacao_w, ie_funcao_validacao_w, cd_pessoa_fisica_w) INTO STRICT nr_seq_regra_atualizacao_w, ie_funcao_validacao_w, cd_pessoa_fisica_w;

nr_telef_celular_benef_w 	:= SubStr(nr_telef_celular_benef_p, position(')' in nr_telef_celular_benef_p) + 1 ,length(nr_telef_celular_benef_p) + 1);
nr_telef_beneficiario_w 	:= SubStr(nr_telef_beneficiario_p, position(')' in nr_telef_beneficiario_p) + 1 ,length(nr_telef_beneficiario_p) + 1);
nr_telef_secretaria_w 		:= SubStr(nr_telef_secretaria_p, position(')' in nr_telef_secretaria_p) + 1 ,length(nr_telef_secretaria_p) + 1);


if (position('()' in nr_telef_celular_benef_p) > 0) and (nr_telef_celular_benef_w IS NOT NULL AND nr_telef_celular_benef_w::text <> '') then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(444259); -- DDD do celular do beneficiário não informado! Favor verificar!
	
elsif (nr_telef_celular_benef_p = '()') then
	nr_ddd_celular_w		:= '';
	
else
	nr_ddd_celular_w 		:= SubStr(nr_telef_celular_benef_p, position('(' in nr_telef_celular_benef_p)+1 ,2);
end if;

if (position('()' in nr_telef_beneficiario_p) > 0)  and (nr_telef_beneficiario_w IS NOT NULL AND nr_telef_beneficiario_w::text <> '') then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(444260); -- DDD do telefone do beneficiário não informado! Favor verificar!
	
elsif (nr_telef_beneficiario_p = '()') then	
	nr_ddd_telef_benef_w		:= '';
	
else
	nr_ddd_telef_benef_w 		:= SubStr(nr_telef_beneficiario_p, position('(' in nr_telef_beneficiario_p)+1 ,2);
end if;

if (position('()' in nr_telef_secretaria_p) > 0)  and (nr_telef_secretaria_w IS NOT NULL AND nr_telef_secretaria_w::text <> '') then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(449072); -- DDD do telefone da secretária não informado! Favor verificar!
end if;

nr_ddd_celular_w		:= elimina_caractere_especial(nr_ddd_celular_w);
nr_telef_celular_benef_w	:= elimina_caractere_especial(nr_telef_celular_benef_w);
nr_ddd_telef_benef_w		:= elimina_caractere_especial(nr_ddd_telef_benef_w);
nr_telef_beneficiario_w		:= elimina_caractere_especial(nr_telef_beneficiario_w);

nr_ddd_celular_w		:= pls_elimina_caracteres(nr_ddd_celular_w);
nr_telef_celular_benef_w	:= pls_elimina_caracteres(nr_telef_celular_benef_w);
nr_ddd_telef_benef_w		:= pls_elimina_caracteres(nr_ddd_telef_benef_w);
nr_telef_beneficiario_w		:= pls_elimina_caracteres(nr_telef_beneficiario_w);

update	pls_auditoria
set	nr_telef_secretaria		= nr_telef_secretaria_p,
	nm_secretaria			= nm_secretaria_p,
	nr_telef_beneficiario		= nr_telef_beneficiario_p,
	nr_telef_celular_benef		= nr_telef_celular_benef_p,
	ds_email_beneficiario		= ds_email_beneficiario_p
where 	nr_sequencia	= nr_seq_analise_p;

if (ie_parametro_regra_p = 'CR') then
	if (coalesce(nr_seq_regra_atualizacao_w, 0) 	= 0) then	
		update	pessoa_fisica
		set	nr_ddd_celular		= nr_ddd_celular_w,
			nr_telefone_celular	= nr_telef_celular_benef_w,
			dt_atualizacao		= clock_timestamp(),
			nm_usuario		= nm_usuario_p
		where	cd_pessoa_fisica	= cd_pessoa_fisica_w;
		
		update	compl_pessoa_fisica
		set	ds_email		= ds_email_beneficiario_p,
			nr_ddd_telefone		= nr_ddd_telef_benef_w, 
			nr_telefone		= nr_telef_beneficiario_w,
			dt_atualizacao		= clock_timestamp(),
			nm_usuario		= nm_usuario_p
		where	cd_pessoa_fisica = cd_pessoa_fisica_w
		and	ie_tipo_complemento = 1;
		
	else 	
		CALL pls_solic_alteracao_aut_benef(	cd_pessoa_fisica_w, nr_ddd_celular_w, nr_telef_celular_benef_w,
						nr_ddd_telef_benef_w, nr_telef_beneficiario_w, ds_email_beneficiario_p,
						cd_estabelecimento_p, nm_usuario_p);
	end if;

else
	CALL pls_solic_alteracao_aut_benef(	cd_pessoa_fisica_w, nr_ddd_celular_w, nr_telef_celular_benef_w,
					nr_ddd_telef_benef_w, nr_telef_beneficiario_w, ds_email_beneficiario_p,
					cd_estabelecimento_p, nm_usuario_p);
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_atualiza_dados_benef_aut ( nr_seq_analise_p bigint, nr_seq_segurado_p bigint, nr_telef_secretaria_p text, nm_secretaria_p text, nr_telef_beneficiario_p text, nr_telef_celular_benef_p text, ds_email_beneficiario_p text, ie_parametro_regra_p text,  cd_estabelecimento_p bigint, nm_usuario_p text ) FROM PUBLIC;

