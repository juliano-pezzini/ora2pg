-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE iniciar_coleta_doacao_js ( nr_seq_doacao_p bigint, ie_tipo_coleta_p bigint, ie_auto_exclusao_p text, ie_possui_impedimento_p text, dt_lib_impedimento_p timestamp, cd_estabelecimento_p bigint, nm_usuario_p text, ds_msg_regra_hora_coleta_p INOUT text, ds_msg_auto_exclusao_p INOUT text, ds_erro_p INOUT text, dt_inicio_coleta_p timestamp default clock_timestamp()) AS $body$
DECLARE


ie_confirma_auto_exc_w	varchar(1);
ie_regra_hora_coleta_w	varchar(2);
dt_inicio_coleta_w      timestamp;


BEGIN

dt_inicio_coleta_w := to_date(to_char(clock_timestamp(),'dd/mm/yyyy') ||' '|| to_char(coalesce(dt_inicio_coleta_p, clock_timestamp()),'hh24:mi:ss'), 'dd/mm/yyyy hh24:mi:ss');

ie_regra_hora_coleta_w	:= san_consiste_regra_hora_coleta(nr_seq_doacao_p, ie_tipo_coleta_p);

if (ie_regra_hora_coleta_w = 'S') then
	ds_msg_regra_hora_coleta_p	:= obter_texto_tasy(63791, wheb_usuario_pck.get_nr_seq_idioma);
end if;

if (coalesce(ie_auto_exclusao_p::text, '') = '') then
	begin
	/* Hemoterapia - Parâmetro [227] - Ao iniciar a coleta consistir se a auto-exclusão esta informada */

	ie_confirma_auto_exc_w := obter_param_usuario(450, 227, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_confirma_auto_exc_w);

	if (ie_confirma_auto_exc_w = 'S') then
		ds_msg_auto_exclusao_p	:= obter_texto_tasy(53325, wheb_usuario_pck.get_nr_seq_idioma);
	end if;
	end;
end if;

if (coalesce(ds_msg_regra_hora_coleta_p::text, '') = '') then
	if (coalesce(ds_msg_auto_exclusao_p::text, '') = '') then
		begin
		if (ie_possui_impedimento_p = 'S') and (coalesce(dt_lib_impedimento_p::text, '') = '') then
			ds_erro_p	:= obter_texto_tasy(81764, wheb_usuario_pck.get_nr_seq_idioma);
		else
			CALL iniciar_coleta_doacao(nr_seq_doacao_p, nm_usuario_p, dt_inicio_coleta_w);
		end if;
		end;
	end if;
end if;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE iniciar_coleta_doacao_js ( nr_seq_doacao_p bigint, ie_tipo_coleta_p bigint, ie_auto_exclusao_p text, ie_possui_impedimento_p text, dt_lib_impedimento_p timestamp, cd_estabelecimento_p bigint, nm_usuario_p text, ds_msg_regra_hora_coleta_p INOUT text, ds_msg_auto_exclusao_p INOUT text, ds_erro_p INOUT text, dt_inicio_coleta_p timestamp default clock_timestamp()) FROM PUBLIC;

