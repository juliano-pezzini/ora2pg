-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE alterar_data_entrega_aprovacao ( nr_sequencia_p bigint, ie_tipo_p text, ie_forma_altera_p text, ds_erro_p INOUT text) AS $body$
DECLARE

 
 
cd_cgc_w			varchar(14);
cd_estabelecimento_w		integer;
qt_prazo_entrega_w		bigint;
nr_item_oci_w			integer;
dt_prevista_entrega_w	timestamp;
dt_prevista_menor_w		timestamp;
qt_existe_w			bigint;
ds_erro_w			varchar(255)	:= '';

/*ie_forma_altera_p 
N = Nunca alterar as datas de entrega 
F = Considerar (Dias entrega) do fornecedor 
C = Considerar (Dias entrega) do parâmetro compras 
A = Considerar (Dias Fornecedor ou Parâmetro compras) 
CF = Considerar (Dias entrega) do fornecedor da cotação 
*/
 
 
 
C01 CURSOR FOR 
	SELECT	a.nr_item_oci, 
		a.dt_prevista_entrega, 
		obter_menor_data_entrega_oci(a.nr_ordem_compra, a.nr_item_oci) 
	from	ordem_compra_item_entrega a 
	where	a.nr_ordem_compra = nr_sequencia_p 
	order by 
		a.nr_item_oci, 
		a.dt_prevista_entrega desc;


BEGIN 
if (ie_tipo_p = 'O') and (ie_forma_altera_p <> 'N') then 
	begin 
	select	coalesce(max(cd_cgc_fornecedor),'X'), 
		max(cd_estabelecimento) 
	into STRICT	cd_cgc_w, 
		cd_estabelecimento_w 
	from	ordem_compra 
	where	nr_ordem_compra = nr_sequencia_p;
	 
	select	count(*) 
	into STRICT	qt_existe_w 
	from	cot_compra_forn a, 
		cot_compra_forn_item b 
	where  	a.nr_sequencia 		= b.nr_seq_cot_forn 
	and	b.nr_ordem_compra 	= nr_sequencia_p 
	and	a.cd_cgc_fornecedor	= cd_cgc_w;
	 
 
	if (ie_forma_altera_p = 'C') then 
		begin 
		select	coalesce(max(qt_dias_entrega_padrao),-1) 
		into STRICT	qt_prazo_entrega_w 
		from	parametro_compras 
		where	cd_estabelecimento = cd_estabelecimento_w;
		if (qt_prazo_entrega_w < 0) then 
			ds_erro_w	:= substr(ds_erro_w || WHEB_MENSAGEM_PCK.get_texto(279013) ,1,255);
		end if;
		end;
	elsif (ie_forma_altera_p = 'F') and (cd_cgc_w <> 'X') then 
		begin 
		select	coalesce(max(obter_dados_pf_pj_estab(cd_estabelecimento_w, null, cd_cgc_w, 'EPE')), '-1') 
		into STRICT	qt_prazo_entrega_w 
		;
		if (qt_prazo_entrega_w < 0) then 
			ds_erro_w	:= substr(ds_erro_w || WHEB_MENSAGEM_PCK.get_texto(279022) ,1,255);
		end if;
		end;
	elsif (ie_forma_altera_p = 'A') then 
		begin 
		select	coalesce(max(coalesce(obter_dados_pf_pj_estab(cd_estabelecimento, null, cd_cgc_w, 'EPE'), qt_dias_entrega_padrao)), '-1') 
		into STRICT	qt_prazo_entrega_w 
		from	parametro_compras 
		where	cd_estabelecimento = cd_estabelecimento_w;
		if (qt_prazo_entrega_w < 0) then 
			ds_erro_w	:= substr(ds_erro_w || WHEB_MENSAGEM_PCK.get_texto(279023) ,1,255);
		end if;
		end;
	elsif (ie_forma_altera_p = 'CF') and (qt_existe_w > 0) and (cd_cgc_w <> 'X') then 
		begin 
		select	coalesce(max(qt_dias_entrega),-1) 
		into STRICT	qt_prazo_entrega_w 
		from	cot_compra_forn a, 
			cot_compra_forn_item b 
		where 	 a.nr_sequencia 		= b.nr_seq_cot_forn 
		and	b.nr_ordem_compra 	= nr_sequencia_p 
		and	a.cd_cgc_fornecedor 	= cd_cgc_w;		
		if (qt_prazo_entrega_w < 0) then 
			ds_erro_w	:= substr(ds_erro_w || WHEB_MENSAGEM_PCK.get_texto(279025) ,1,255);
		end if;
		end;	
	end if;
	if (qt_prazo_entrega_w IS NOT NULL AND qt_prazo_entrega_w::text <> '') and (qt_prazo_entrega_w >= 0) then 
	 	open c01;
		loop 
		FETCH c01 into 
			nr_item_oci_w, 
			dt_prevista_entrega_w, 
			dt_prevista_menor_w;
		EXIT WHEN NOT FOUND; /* apply on c01 */
			begin 
			if (dt_prevista_entrega_w = dt_prevista_menor_w) then 
				update	ordem_compra_item_entrega 
				set	dt_prevista_entrega	= obter_proximo_dia_util(cd_estabelecimento_w,trunc(clock_timestamp() + qt_prazo_entrega_w,'dd')) 
				where	nr_ordem_compra		= nr_sequencia_p 
				and	nr_item_oci		= nr_item_oci_w 
				and	dt_prevista_entrega	= dt_prevista_entrega_w;
			else 
				update	ordem_compra_item_entrega 
				set	dt_prevista_entrega	= obter_proximo_dia_util(cd_estabelecimento_w,trunc(clock_timestamp() + qt_prazo_entrega_w + (dt_prevista_entrega - dt_prevista_menor_w),'dd')) 
				where	nr_ordem_compra		= nr_sequencia_p 
				and	nr_item_oci		= nr_item_oci_w 
				and	dt_prevista_entrega	= dt_prevista_entrega_w;
			end if;			
			end;
		end loop;
		close c01;		
	 
	select	min(dt_prevista_entrega) 
	into STRICT	dt_prevista_entrega_w 
	from	ordem_compra_item_entrega 
	where	nr_ordem_compra		= nr_sequencia_p;
	 
	if (dt_prevista_entrega_w IS NOT NULL AND dt_prevista_entrega_w::text <> '') then 
		update	ordem_compra 
		set	dt_entrega = obter_proximo_dia_util(cd_estabelecimento_w,dt_prevista_entrega_w) 
		where	nr_ordem_compra		= nr_sequencia_p;
	end if;
	 
	end if;
	end;
end if;
 
if (ds_erro_w IS NOT NULL AND ds_erro_w::text <> '') then 
	ds_erro_p	:= substr(ds_erro_w ,1,255);
end if;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE alterar_data_entrega_aprovacao ( nr_sequencia_p bigint, ie_tipo_p text, ie_forma_altera_p text, ds_erro_p INOUT text) FROM PUBLIC;

