-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE insert_med_guid_addition ( nr_atendimento_p bigint, ie_tipo_p text, nr_seq_order_unit_p bigint, cd_estabelecimento_p bigint, nm_usuario_p medical_guidance_order.nm_usuario%type, nr_seq_mat_cpoe_p cpoe_material.nr_sequencia%type default null) AS $body$
DECLARE


/*
IE_TIPO_P
APD - Addition for Psychotropic drug
SPD - The patient has been taking a psychotropic drug with the same dose for the same purpose for 12 months or more.
*/
cd_pessoa_fisica_w      atendimento_paciente.cd_pessoa_fisica%type;
nr_seq_w                medical_guidance_order.nr_sequencia%type;
nr_seq_proc_interno_w   medical_guidance_order.nr_seq_proc_interno%type;
ie_origem_proced_w      medical_guidance_order.ie_origem_proced%type;
cd_procedimento_w       medical_guidance_order.cd_procedimento%type;
nr_seq_med_fee_event_w	MED_GUID_FEE_EVENT.nr_sequencia%type;
qt_medical_fee_w	bigint;


BEGIN

select	max(nr_sequencia)
into STRICT	nr_seq_med_fee_event_w
from	MED_GUID_FEE_EVENT
where	ie_trigger_event = IE_TIPO_P;

if (nr_seq_med_fee_event_w IS NOT NULL AND nr_seq_med_fee_event_w::text <> '') then

	select	count(*)
	into STRICT	qt_medical_fee_w
	from	medical_guidance_order
	where	nr_seq_order_unit = nr_seq_order_unit_p
	and	ie_origin_event = ie_tipo_p;

	if (qt_medical_fee_w = 0) then
	
		SELECT	max(nr_seq_proc_interno),
			max(ie_origem_proced),
			max(cd_procedimento)
		into STRICT	nr_seq_proc_interno_w,
			ie_origem_proced_w,
			cd_procedimento_w
		from	MED_GUID_FEE_EVENT
		where	nr_sequencia = nr_seq_med_fee_event_w;

		select	max(cd_pessoa_fisica)
		into STRICT	cd_pessoa_fisica_w
		from	atendimento_paciente
		where	nr_atendimento = nr_atendimento_p;
			   
		select	nextval('medical_guidance_order_seq')
		into STRICT	nr_seq_w
		;

		insert into medical_guidance_order(
					nr_sequencia,
					cd_estabelecimento,
					dt_atualizacao,
					nm_usuario,
					dt_atualizacao_nrec,
					nm_usuario_nrec,
					nr_atendimento,
					nr_seq_proc_interno,
					ie_origem_proced,
					cd_procedimento,
					ie_situacao,
					dt_liberacao,
					cd_pessoa_fisica,
					dt_guidance,
					dt_calculation,
					nr_seq_order_unit,
					ie_origin_event,
					nr_seq_mat_cpoe)
			values (       nr_seq_w,
					cd_estabelecimento_p,
					clock_timestamp(),
					nm_usuario_p,
					clock_timestamp(),
					nm_usuario_p,
					nr_atendimento_p,
					nr_seq_proc_interno_w,
					ie_origem_proced_w,
					cd_procedimento_w,
					'A',
					clock_timestamp(),
					cd_pessoa_fisica_w,
					clock_timestamp(),
					clock_timestamp(),
					nr_seq_order_unit_p,
					ie_tipo_p,
					nr_seq_mat_cpoe_p);
	CALL MED_GUIDANCE_PKG.SUBMIT_MED_GUID_ORDER(nr_seq_w,nm_usuario_p,wheb_usuario_pck.get_cd_estabelecimento);
	end if;
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE insert_med_guid_addition ( nr_atendimento_p bigint, ie_tipo_p text, nr_seq_order_unit_p bigint, cd_estabelecimento_p bigint, nm_usuario_p medical_guidance_order.nm_usuario%type, nr_seq_mat_cpoe_p cpoe_material.nr_sequencia%type default null) FROM PUBLIC;

