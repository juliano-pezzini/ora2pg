-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE ctb_gerar_interf_j310_ecd ( nr_seq_controle_p bigint, nm_usuario_p text, dt_inicio_p timestamp, dt_fim_p timestamp, qt_linha_p INOUT bigint, nr_sequencia_p INOUT bigint) AS $body$
DECLARE



ds_identificador_w			varchar(5);
cd_aglutinacao_w			varchar(40);
ds_aglutinacao_w			varchar(255);
ds_arquivo_w			varchar(4000);
ds_compl_arquivo_w		varchar(4000);
ds_linha_w			varchar(8000);
nr_linha_w			bigint := qt_linha_p;
nr_seq_registro_w			bigint := nr_sequencia_p;
sep_w				varchar(1) := '|';
tp_registro_w			varchar(15) := 'J310';
nr_seq_demo_dfc_w			bigint;

c01 CURSOR FOR
SELECT	a.nr_seq_rubrica	cd_aglutinacao,
	a.qt_desl_esq		nr_nivel,
	b.ie_grupo_balanco_ecd,
	a.ds_rubrica ds_aglutinacao,
	a.vl_1_coluna vl_conta,
	substr(ctb_obter_situacao_saldo_ecd(a.nr_seq_rubrica, 'J100',dt_fim_p,  a.vl_1_coluna),1,1) ie_saldo,
	a.vl_2_coluna,
	substr(ctb_obter_situacao_saldo_ecd(a.nr_seq_rubrica,'J100',dt_inicio_p,a.vl_2_coluna),1,1) ie_saldo_ini,
	b.ie_tipo_linha_sped,
	a.vl_3_coluna,
	substr(ctb_obter_situacao_saldo_ecd(a.nr_seq_rubrica,'J100',dt_inicio_p,a.vl_3_coluna),1,1) ie_saldo_col3
from	ctb_modelo_rubrica b,
	ctb_demo_rubrica_v a
where	a.nr_seq_rubrica	= b.nr_sequencia
and	a.nr_seq_demo		= nr_seq_demo_dfc_w
order 	by a.nr_seq_apres;

vet01	c01%RowType;


BEGIN

select	coalesce(max(nr_seq_demo_dfc),0)
into STRICT	nr_seq_demo_dfc_w
from	ctb_sped_controle
where	nr_sequencia	= nr_seq_controle_p;



begin
open c01;
loop
fetch c01 into
	vet01;
EXIT WHEN NOT FOUND; /* apply on c01 */
	begin

	ds_linha_w	:= substr(	sep_w || tp_registro_w							||
					sep_w || vet01.ie_tipo_linha_sped				||
					sep_w || 'SF'									|| --Precisa ser verificado, está passando como fixo (Indicador de situação do saldo)
					sep_w || vet01.cd_aglutinacao 					||
					sep_w || vet01.ds_aglutinacao					||
					sep_w || sped_obter_campo_valor(vet01.vl_conta)		||
					sep_w || vet01.ie_saldo								||
					sep_w || sped_obter_campo_valor(vet01.vl_2_coluna)	||
					sep_w || vet01.ie_saldo_ini							||
					sep_w || sped_obter_campo_valor(vet01.vl_3_coluna)	||
					sep_w || vet01.ie_saldo_col3						||sep_w,1,8000);

	ds_arquivo_w			:= substr(ds_linha_w,1,4000);
	ds_compl_arquivo_w		:= substr(ds_linha_w,4001,4000);
	nr_seq_registro_w		:= nr_seq_registro_w + 1;
	nr_linha_w				:= nr_linha_w + 1;


	insert into ctb_sped_registro(
		nr_sequencia,
		ds_arquivo,
		dt_atualizacao,
		nm_usuario,
		dt_atualizacao_nrec,
		nm_usuario_nrec,
		nr_seq_controle_sped,
		ds_arquivo_compl,
		cd_registro,
		nr_linha)
	values (	nr_seq_registro_w,
		ds_arquivo_w,
		clock_timestamp(),
		nm_usuario_p,
		clock_timestamp(),
		nm_usuario_p,
		nr_seq_controle_p,
		ds_compl_arquivo_w,
		tp_registro_w,
		nr_linha_w);
	end;
end loop;
close c01;
end;

commit;

qt_linha_p	:= nr_linha_w;
nr_sequencia_p	:= nr_seq_registro_w;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ctb_gerar_interf_j310_ecd ( nr_seq_controle_p bigint, nm_usuario_p text, dt_inicio_p timestamp, dt_fim_p timestamp, qt_linha_p INOUT bigint, nr_sequencia_p INOUT bigint) FROM PUBLIC;

