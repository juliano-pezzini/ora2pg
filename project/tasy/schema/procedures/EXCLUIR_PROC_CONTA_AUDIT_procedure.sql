-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE excluir_proc_conta_audit (nr_sequencia_p bigint, nr_seq_propaci_p bigint, cd_motivo_exc_conta_p bigint, ds_compl_motivo_excon_p text, nr_seq_motivo_auditoria_p bigint, nm_usuario_p text) AS $body$
DECLARE


nr_atendimento_w	bigint;
cd_estabelecimento_w		estabelecimento.cd_estabelecimento%type := wheb_usuario_pck.get_cd_estabelecimento;
ie_altera_item_repasse_w	varchar(1) := 'S';

BEGIN

ie_altera_item_repasse_w := obter_param_usuario(1116, 189, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_altera_item_repasse_w);

select	max(nr_atendimento)
into STRICT	nr_atendimento_w
from	procedimento_paciente
where	nr_sequencia = nr_seq_propaci_p;

Update	procedimento_paciente a
set 	a.cd_motivo_exc_conta = cd_motivo_exc_conta_p,
	a.ds_compl_motivo_excon = ds_compl_motivo_excon_p,
	a.nm_usuario = nm_usuario_p,
	a.dt_atualizacao = clock_timestamp(),
	a.DT_ACERTO_CONTA  = NULL,
	a.NR_INTERNO_CONTA  = NULL
where 	a.nr_sequencia = nr_seq_propaci_p
and	not exists (	SELECT	1
			from	procedimento_repasse x
			where	x.nr_seq_procedimento = a.nr_sequencia
			and	coalesce(ie_altera_item_repasse_w,'S') = 'N');

/*insert into log_xxxxxtasy(cd_log, ds_log, dt_atualizacao, nm_usuario)
	values (66985, 'Item Excluído pela função Auditoria, Seq = ' || nr_seq_propaci_p || ', Atendimento = ' || nr_atendimento_w, sysdate, nm_usuario_p); */
update	auditoria_propaci a
set 	a.ie_tipo_auditoria = 'X',
	a.qt_ajuste = CASE WHEN ds_compl_motivo_excon_p='999#' THEN  a.qt_ajuste  ELSE null END ,
	a.nm_usuario = nm_usuario_p,
	a.dt_atualizacao = clock_timestamp(),
	a.nr_seq_motivo = CASE WHEN nr_seq_motivo_auditoria_p=0 THEN  a.nr_seq_motivo  ELSE nr_seq_motivo_auditoria_p END
where 	a.nr_sequencia = nr_sequencia_p
and	not exists (	SELECT	1
			from	procedimento_repasse x
			where	x.nr_seq_procedimento = a.nr_seq_propaci
			and	coalesce(ie_altera_item_repasse_w,'S') = 'N');

commit;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE excluir_proc_conta_audit (nr_sequencia_p bigint, nr_seq_propaci_p bigint, cd_motivo_exc_conta_p bigint, ds_compl_motivo_excon_p text, nr_seq_motivo_auditoria_p bigint, nm_usuario_p text) FROM PUBLIC;

