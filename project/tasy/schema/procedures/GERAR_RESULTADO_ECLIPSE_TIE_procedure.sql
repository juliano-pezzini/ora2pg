-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_resultado_eclipse_tie ( nr_prescricao_p bigint, cd_exame_p text, nr_seq_interno_p bigint, ds_tipo_resultado_p text, ds_resultado_p text, ds_observacao_p text, ds_referencia_p text, ds_result_status_p text, ds_date_time_obs_p timestamp, ds_units_p text, nm_usuario_p text) AS $body$
DECLARE



nr_seq_prescr_w    		prescr_procedimento.nr_sequencia%TYPE;
ie_status_atend_w		prescr_procedimento.ie_status_atend%TYPE;
ie_status_receb_w		prescr_procedimento.ie_status_atend%TYPE;

cd_exame_princ_w		exame_laboratorio.cd_exame%TYPE;
cd_estabelecimento_w	estabelecimento.cd_estabelecimento%TYPE;
ie_sexo_w				pessoa_fisica.ie_sexo%TYPE;
nr_seq_resultado_w		exame_lab_resultado.nr_seq_resultado%TYPE;
nr_seq_exame_princ_w	exame_laboratorio.nr_seq_exame%TYPE;

cd_analito_w			exame_laboratorio.cd_exame%TYPE;
nr_seq_analito_w		exame_laboratorio.nr_seq_exame%TYPE;

nr_seq_material_w		material_exame_lab.nr_sequencia%TYPE;

ds_resultado_w			exame_lab_result_item.ds_resultado%TYPE;
qt_resultado_w			exame_lab_result_item.qt_resultado%TYPE;
pr_resultado_w			exame_lab_result_item.pr_resultado%TYPE;

nr_anos_w				integer;
ds_erro_w				varchar(4000);

ie_campo_calculo_w		varchar(1);
ie_formato_resultado_w	varchar(3);


BEGIN

CALL gravar_log_lab_pragma(6644,'gerar_resultado_eclipse_tie - '|| nr_prescricao_p	|| ' -- '||cd_exame_p	|| ' -- '||nr_seq_interno_p	|| ' -- '||ds_tipo_resultado_p|| ' -- '||ds_resultado_p	|| ' -- '||ds_observacao_p|| ' -- '||ds_referencia_p|| ' -- '||ds_result_status_p|| ' -- '||ds_date_time_obs_p|| ' -- '||ds_units_p,nm_usuario_p);

BEGIN
SELECT 	a.nr_sequencia,
		a.ie_status_atend,
		coalesce(b.cd_exame_integracao, b.cd_exame),
		a.nr_seq_exame
INTO STRICT	nr_seq_prescr_w,
		ie_status_atend_w,
		cd_exame_princ_w,
		nr_seq_exame_princ_w
FROM 	prescr_procedimento a,
		exame_laboratorio b
WHERE 	a.nr_seq_exame = b.nr_seq_exame
AND		a.nr_prescricao = nr_prescricao_p
AND		a.nr_seq_interno = nr_seq_interno_p
AND		coalesce(a.ie_suspenso,'N') = 'N'
AND		coalesce(b.ie_situacao,'A') = 'A';
EXCEPTION
    WHEN no_data_found THEN
        CALL gravar_log_lab_pragma(6644,'Problema ao buscar exame principal' ,nm_usuario_p);
END;

SELECT	cd_estabelecimento,
        obter_sexo_prescricao(nr_prescricao)
INTO STRICT	cd_estabelecimento_w,
        ie_sexo_w
FROM	prescr_medica
WHERE	nr_prescricao = nr_prescricao_p;

SELECT	ie_status_receb
INTO STRICT	ie_status_receb_w
FROM	lab_parametro
WHERE	cd_estabelecimento = cd_estabelecimento_w;

SELECT  obter_idade(b.dt_nascimento, clock_timestamp(), 'A')
INTO STRICT   	nr_anos_w
FROM 	prescr_medica a,
        pessoa_fisica b
WHERE 	a.cd_pessoa_fisica = b.cd_pessoa_fisica
AND		a.nr_prescricao = nr_prescricao_p;

begin
SELECT  a.nr_seq_resultado,
        b.nr_seq_material
INTO STRICT	nr_seq_resultado_w,
        nr_seq_material_w
FROM	exame_lab_resultado a,
        exame_lab_result_item b
WHERE	a.nr_seq_resultado = b.nr_seq_resultado
AND		a.nr_prescricao = nr_prescricao_p
AND		b.nr_seq_prescr	= nr_seq_prescr_w
AND		(b.nr_seq_material IS NOT NULL AND b.nr_seq_material::text <> '');
EXCEPTION
    WHEN too_many_rows THEN
        CALL gravar_log_lab_pragma(6644,'Problema ao buscar resultado' ,nm_usuario_p);
    WHEN no_data_found THEN
        CALL gera_exame_result_lab(nr_prescricao_p, nr_seq_prescr_w, 'N', 'N', 'S', nm_usuario_p);

        BEGIN
            SELECT 	a.nr_seq_resultado,
                    b.nr_seq_material
            INTO STRICT	nr_seq_resultado_w,
                    nr_seq_material_w
            FROM	exame_lab_resultado a,
                    exame_lab_result_item b
            WHERE	a.nr_seq_resultado = b.nr_seq_resultado
            AND		a.nr_prescricao = nr_prescricao_p
            AND		b.nr_seq_prescr	= nr_seq_prescr_w
            AND 	(b.nr_seq_material IS NOT NULL AND b.nr_seq_material::text <> '');
        EXCEPTION
            WHEN too_many_rows THEN
                CALL gravar_log_lab_pragma(6644,'Problema ao gerar novo resultado' ,nm_usuario_p);
        END;
END;WITH RECURSIVE cte AS (


BEGIN
    SELECT	coalesce(e.cd_exame_integracao, e.cd_exame),e.nr_seq_exame
    INTO STRICT 	cd_analito_w,nr_seq_analito_w
    FROM	exame_laboratorio e WHERE nr_seq_superior = nr_seq_exame_princ_w
  UNION ALL


BEGIN
    SELECT	coalesce(e.cd_exame_integracao, e.cd_exame),e.nr_seq_exame
    INTO STRICT 	cd_analito_w,nr_seq_analito_w
    FROM	exame_laboratorio e JOIN cte c ON (c.nr_seq_exame = e.nr_seq_superior)

) SELECT * FROM cte WHERE nr_seq_exame = (	SELECT 	nr_seq_exame
                                FROM 	equipamento_lab b,
                                        lab_exame_equip a
                                WHERE	a.cd_equipamento = b.cd_equipamento
                                AND		a.cd_exame_equip = cd_exame_p
                                AND		UPPER(b.ds_sigla) = lab_obter_conversao_externa(NULL, 'EQUIPAMENTO_LAB', 'CD_EQUIPAMENTO', a.cd_equipamento)
                                AND		a.nr_seq_exame = e.nr_seq_exame);
;
EXCEPTION
    WHEN too_many_rows THEN
        CALL gravar_log_lab_pragma(6644,'Problema ao buscar analito' ,nm_usuario_p);
    WHEN no_data_found THEN
        CALL gravar_log_lab_pragma(6644,'Nao encontrou analito' ,nm_usuario_p);
        cd_analito_w := null;
        nr_seq_analito_w := null;
END;

CALL gravar_log_lab_pragma(6644,'gerar_resultado_eclipse_tie - '||nr_seq_resultado_w|| ' -- '||	nr_prescricao_p|| ' -- '||nr_seq_prescr_w|| ' -- '|| nr_seq_exame_princ_w|| ' -- '|| nr_seq_material_w|| ' -- '|| nr_anos_w|| ' -- '|| ie_sexo_w|| ' -- '||	nm_usuario_p,nm_usuario_p);
CALL gera_resultado_lab( nr_seq_resultado_w,	nr_prescricao_p,nr_seq_prescr_w, nr_seq_exame_princ_w, nr_seq_material_w, nr_anos_w, ie_sexo_w,	nm_usuario_p);

SELECT	ie_formato_resultado
INTO STRICT	ie_formato_resultado_w
FROM	exame_laboratorio
WHERE	nr_seq_exame	 = coalesce(nr_seq_analito_w, nr_seq_exame_princ_w);

IF (SUBSTR(ie_formato_resultado_w,1,1) = 'P') THEN
    SELECT 	(coalesce(REPLACE(ds_resultado_p, '.', ','),0))::numeric
    INTO STRICT   	pr_resultado_w
;
ELSIF (SUBSTR(ie_formato_resultado_w,1,1) = 'V') OR (SUBSTR(ie_formato_resultado_w,2,1) = 'V') THEN
    BEGIN
    SELECT 	(coalesce(ds_resultado_p,0))::numeric
    INTO STRICT 	qt_resultado_w
;
    EXCEPTION
        WHEN OTHERS THEN
        BEGIN
        SELECT 	(coalesce(REPLACE(ds_resultado_p, '.', ','),0))::numeric
        INTO STRICT 	qt_resultado_w
;
        EXCEPTION
            WHEN OTHERS THEN
                BEGIN
                SELECT 	(coalesce(REPLACE(ds_resultado_p, ',', '.'),0))::numeric
                INTO STRICT 	qt_resultado_w
;
                EXCEPTION
                    WHEN OTHERS THEN
                    ds_resultado_w := trim(both ds_resultado_p);
                END;
        END;
    END;
ELSE
    ds_resultado_w := trim(both ds_resultado_p);
END IF;

ds_erro_w := atualizar_lab_result_item(nr_prescricao_p, nr_seq_prescr_w, coalesce(cd_analito_w,cd_exame_princ_w), qt_resultado_w, pr_resultado_w, ds_resultado_w, ds_observacao_p, null, 'N', nm_usuario_p, ds_date_time_obs_p, ds_referencia_p, ds_units_p, null, null, ds_erro_w, nr_seq_analito_w);
CALL gravar_log_lab_pragma(6644,'atualizar_lab_result_item('||nr_prescricao_p||', '||nr_seq_prescr_w||', '||coalesce(cd_analito_w,cd_exame_princ_w)||','|| qt_resultado_w||', '||pr_resultado_w||', '||ds_resultado_w||','|| ds_observacao_p||', null, ''N'', '||nm_usuario_p||', '||ds_date_time_obs_p||', '||ds_referencia_p||', '||ds_units_p||', null, null, '||'ds_erro_w'||','|| nr_seq_analito_w||');' ,nm_usuario_p);

COMMIT;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_resultado_eclipse_tie ( nr_prescricao_p bigint, cd_exame_p text, nr_seq_interno_p bigint, ds_tipo_resultado_p text, ds_resultado_p text, ds_observacao_p text, ds_referencia_p text, ds_result_status_p text, ds_date_time_obs_p timestamp, ds_units_p text, nm_usuario_p text) FROM PUBLIC;

