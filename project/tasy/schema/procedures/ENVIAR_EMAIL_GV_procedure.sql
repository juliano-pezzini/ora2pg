-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE enviar_email_gv (nm_usuario_p text) AS $body$
DECLARE


ds_assunto_w		varchar(255);
ds_mensagem_w		varchar(4000);
nr_seq_gv_w		bigint;
dt_saida_w		timestamp;
dt_chegada_w		timestamp;
nm_pessoa_viagem_w	varchar(255);
ds_status_viagem_w	varchar(40);
cd_pessoa_viagem_w	varchar(10);
ds_email_origem_w	varchar(255);
ds_email_destino_w	varchar(255);

C01 CURSOR FOR
	/* Seleciona todas as pessoas que  estão com mais de 25 dias em status de viagem */

	SELECT	obter_nome_pf(a.cd_pessoa_fisica),
		a.nr_sequencia,
		trunc(a.dt_saida_prev),
		trunc(a.dt_retorno_prev),
		obter_valor_dominio(1752, a.ie_etapa_viagem),
		coalesce(obter_email_pf(a.cd_pessoa_fisica), (SELECT max(ds_email) from usuario b where a.cd_pessoa_fisica = b.cd_pessoa_fisica and b.ie_situacao = 'A'))
	from	via_viagem a
	where	a.ie_etapa_viagem in (0,1,2,3,4,8)
	and	trunc(a.dt_saida_prev) >= to_date('01/01/2018','dd/mm/yyyy');
	

BEGIN

ds_email_origem_w := 'financeiropci@philips.com';
ds_assunto_w := 'Política de viagens Philips';

open C01;
loop
fetch C01 into	
		nm_pessoa_viagem_w,
		nr_seq_gv_w,
		dt_saida_w,
		dt_chegada_w,
		ds_status_viagem_w,
		ds_email_destino_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
		/* Montagem do email para encaminhar */

		ds_mensagem_w := 'Prezado ' || nm_pessoa_viagem_w || '. '|| chr(13) || chr(10) || chr(13) || chr(10) || 'Conforme política de viagens Philips, os relatórios de viagens precisam ser entregues dentro do prazo de 30 dias após data fim da viagem. A não entrega dos relatórios no prazo ao setor  financeiro afeta o fluxo de caixa da empresa, pois impacta no processo de cobrança aos clientes bem como poderá afetar o viajante com o não reembolso.' || chr(13) || chr(10) || chr(13) || chr(10) || 'Levantamos que você possuí pendencias de viagens confomre abaixo. Pedimos que regularize as mesmas dentro do prazo (Você ainda possuí 5 dias) . Sendo que entende-se regularizada quando entregue ao Setor Financiero/Projetos.' || chr(13) || chr(10) || chr(13) || chr(10) ||
	'Numero da GV: ' || nr_seq_gv_w || 
	' | Data Da viagem: ' || dt_saida_w || 
	' | Data de Retorno: ' || dt_chegada_w || 
	' | Status: ' || ds_status_viagem_w || '.' || chr(13) || chr(10) || chr(13) || chr(10) ||
	'Obrigado.';

	CALL enviar_email(	ds_assunto_w,
			ds_mensagem_w,
			ds_email_destino_w,
			ds_email_destino_w,
			nm_usuario_p,
			'A',
			'luiz.poltronieri@philips.com;anapaula.luz@philips.com;maisa.schmitt@philips.com;financeiropci@philips.com');	
	EXCEPTION
		WHEN OTHERS THEN
			null;
	end;		
end loop;
close C01;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE enviar_email_gv (nm_usuario_p text) FROM PUBLIC;

