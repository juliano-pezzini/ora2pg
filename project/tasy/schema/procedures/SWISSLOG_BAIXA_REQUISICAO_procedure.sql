-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE swisslog_baixa_requisicao ( nr_requisicao_p bigint, cd_material_p bigint, qt_baixar_p bigint, nr_seq_lote_fornec_p text, cd_motivo_baixa_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) AS $body$
DECLARE


cd_material_w			material.cd_material%type;
cd_operacao_estoque_w		operacao_estoque.cd_operacao_estoque%type;
cd_local_estoque_w		local_estoque.cd_local_estoque%type;
nr_seq_lote_w			material_lote_fornec.nr_sequencia%type;
ie_baixa_sem_saldo_w		varchar(1);
dt_atendimento_w		timestamp;
dt_baixa_w			timestamp;
cd_barras_w			bigint;
ie_mat_inventario_w		varchar(1);
ds_retorno_w			varchar(2000) := null;
qt_registro_w			integer;
qt_mat_barras_w			double precision;
nr_seq_lote_agrup_w		bigint;
cd_kit_mat_w			bigint;
ds_validade_w			varchar(255);
ds_material_w			varchar(255);
cd_unid_med_w			varchar(30);
nr_etiqueta_lp_w		varchar(255);


BEGIN
ie_baixa_sem_saldo_w	:= 'N';
dt_atendimento_w	:= clock_timestamp();
cd_barras_w		:= null;

select	cd_operacao_estoque,
	cd_local_estoque,
	dt_baixa
into STRICT	cd_operacao_estoque_w,
	cd_local_estoque_w,
	dt_baixa_w
from	requisicao_material
where	nr_requisicao = nr_requisicao_p;

if (nr_seq_lote_fornec_p IS NOT NULL AND nr_seq_lote_fornec_p::text <> '') then
	SELECT * FROM converte_codigo_barras(	nr_seq_lote_fornec_p, cd_estabelecimento_p, null, 'N', cd_material_w, qt_mat_barras_w, nr_seq_lote_w, nr_seq_lote_agrup_w, cd_kit_mat_w, ds_validade_w, ds_material_w, cd_unid_med_w, nr_etiqueta_lp_w, ds_retorno_w) INTO STRICT cd_material_w, qt_mat_barras_w, nr_seq_lote_w, nr_seq_lote_agrup_w, cd_kit_mat_w, ds_validade_w, ds_material_w, cd_unid_med_w, nr_etiqueta_lp_w, ds_retorno_w;
end if;

ie_mat_inventario_w := coalesce(Obter_Se_Material_Bloqueio_Inv(cd_estabelecimento_p,cd_material_w,cd_local_estoque_w),'N');

if (ie_mat_inventario_w = 'S') then
	--ds_retorno_w := 'Material bloqueado para invet√°rio.';
	ds_retorno_w := wheb_mensagem_pck.get_texto(314227);
end if;

if (coalesce(ds_retorno_w::text, '') = '') then
	CALL baixar_item_requisicao(	nr_requisicao_p,
				cd_material_w,
				cd_material_w,
				qt_baixar_p,
				nr_seq_lote_w,
				cd_motivo_baixa_p,
				cd_operacao_estoque_w,
				ie_baixa_sem_saldo_w,
				dt_atendimento_w,
				nr_seq_lote_fornec_p,
				nm_usuario_p);
end if;

if (coalesce(dt_baixa_w::text, '') = '') then
	CALL atualizar_dt_baixa_requisicao(nr_requisicao_p);
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE swisslog_baixa_requisicao ( nr_requisicao_p bigint, cd_material_p bigint, qt_baixar_p bigint, nr_seq_lote_fornec_p text, cd_motivo_baixa_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) FROM PUBLIC;

