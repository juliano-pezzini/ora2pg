-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE wsuite_inserir_lista_espera ( nr_seq_ageint_p bigint, nr_seq_ageint_item_p bigint, cd_estabelecimento_p bigint, cd_agenda_p bigint, nm_usuario_p text, dt_desejada_p timestamp, dt_periodo_inicial_p timestamp, dt_periodo_final_p timestamp, nr_telefone_p agenda_lista_espera.nr_telefone%type, nm_pessoa_contato_p agenda_lista_espera.nm_pessoa_contato%type, ds_observacao_p agenda_lista_espera.ds_observacao%type, nr_seq_motivo_urg_p agenda_lista_espera.nr_seq_motivo_urg%type, ie_urgente_p agenda_lista_espera.ie_urgente%type default 'N', nr_seq_lista_espera_p INOUT agenda_integrada.nr_sequencia%type DEFAULT NULL) AS $body$
DECLARE

cd_convenio_w				agenda_integrada.cd_convenio%type;		
cd_categoria_w				agenda_integrada.cd_categoria%type;
cd_medico_exec_w            agenda_lista_espera.cd_medico_exec%type;
cd_plano_w					agenda_integrada.cd_plano%type;
cd_pessoa_fisica_w			agenda_integrada.cd_pessoa_fisica%type;
cd_procedimento_w			agenda_integrada_item.cd_procedimento%type;
nr_seq_proc_interno_w		agenda_integrada_item.nr_seq_proc_interno%type;
ie_origem_proced_w			agenda_integrada_item.ie_origem_proced%type;
cd_especialidade_w			agenda_integrada_item.cd_especialidade%type;
ie_lado_w					agenda_integrada_item.ie_lado%type;
nm_paciente_w				agenda_lista_espera.nm_pessoa_lista%type;
ie_classif_agenda_w			agenda_integrada_item.ie_classif_agenda%type;
nr_seq_tipo_classif_pac_w  	agenda_integrada.nr_seq_tipo_classif_pac%type;			
ie_prioridade_w            	tipo_classificao_paciente.ie_prioridade%type;
cd_usuario_convenio_w 		agenda_integrada.cd_usuario_convenio%type;
dt_validade_carteira_w		agenda_integrada.dt_validade_carteira%type;
cd_procedencia_w			agenda_integrada.cd_procedencia%type;
nr_seq_lista_espera_w		agenda_integrada.nr_sequencia%type;

BEGIN

	if (nr_seq_ageint_p IS NOT NULL AND nr_seq_ageint_p::text <> '') then
		select
			max(cd_convenio),
			max(cd_categoria),
			max(cd_plano),
			max(cd_pessoa_fisica),
			max(nr_seq_tipo_classif_pac),
			max(cd_usuario_convenio),
			max(dt_validade_carteira),
			max(cd_procedencia)
		into STRICT	
			cd_convenio_w,
			cd_categoria_w,
			cd_plano_w,
			cd_pessoa_fisica_w,
			nr_seq_tipo_classif_pac_w,
			cd_usuario_convenio_w,
			dt_validade_carteira_w,
			cd_procedencia_w
		from agenda_integrada
		where nr_sequencia = nr_seq_ageint_p;


		select	
			max(cd_procedimento),
			max(nr_seq_proc_interno),
			max(ie_origem_proced),
			max(cd_especialidade),
			max(ie_lado),
			max(ie_classif_agenda),
            max(cd_medico)
		into STRICT	
			cd_procedimento_w,
			nr_seq_proc_interno_w,
			ie_origem_proced_w,
			cd_especialidade_w,
			ie_lado_w,
			ie_classif_agenda_w,
            cd_medico_exec_w
		from agenda_integrada_item
		where nr_sequencia = nr_seq_ageint_item_p;


		select	max(substr(coalesce(OBTER_NOME_PF(cd_pessoa_fisica_w), TWS_GET_USER_NAME(nm_usuario_p)), 0, 60))
		into STRICT 	nm_paciente_w
		;

		select	max(ie_prioridade)
		into STRICT 	ie_prioridade_w
		from 	tipo_classificao_paciente
		where 	nr_sequencia = nr_seq_tipo_classif_pac_w
		and		ie_situacao = 'A';

		select nextval('agenda_lista_espera_seq')
		into STRICT nr_seq_lista_espera_w
		;

		insert into agenda_lista_espera(
			nr_sequencia,
			nm_pessoa_lista,
			cd_especialidade,
			cd_medico_exec,
			cd_agenda,
			cd_pessoa_fisica,
			cd_procedimento,
			nr_seq_proc_interno,
			ie_origem_proced,
			ie_lado,
			cd_convenio,
			cd_categoria,
			cd_plano,
			nr_telefone,
			ie_urgente,
			ie_status_espera,
			dt_agendamento,
			dt_desejada,
			dt_periodo_inicial,
			dt_periodo_final,
			nm_usuario_agenda,
			nm_usuario,
			nm_usuario_nrec,
			dt_atualizacao,
			dt_atualizacao_nrec,
			nm_pessoa_contato,
			ie_classif_agenda,
			nr_seq_agenda_int,
			ie_prioridade,
			ds_observacao,
			nr_seq_motivo_urg,
			cd_usuario_convenio,
			dt_validade_carteira,
			cd_procedencia,
			cd_estabelecimento)
		values (
			nr_seq_lista_espera_w,
			nm_paciente_w,
			cd_especialidade_w,
			cd_medico_exec_w,
			cd_agenda_p,
			cd_pessoa_fisica_w,
			cd_procedimento_w,
			nr_seq_proc_interno_w,
			ie_origem_proced_w,
			ie_lado_w,
			cd_convenio_w,
			cd_categoria_w,
			cd_plano_w,
			nr_telefone_p,
			ie_urgente_p,
			'A',
			clock_timestamp(),
			dt_desejada_p,
			dt_periodo_inicial_p,
			dt_periodo_final_p,
			nm_usuario_p,
			nm_usuario_p,
			nm_usuario_p,
			clock_timestamp(),
			clock_timestamp(),
			nm_pessoa_contato_p,
			ie_classif_agenda_w,
			nr_seq_ageint_p,
			ie_prioridade_w,
			ds_observacao_p,
			nr_seq_motivo_urg_p,
			cd_usuario_convenio_w,
			dt_validade_carteira_w,
			cd_procedencia_w,
			cd_estabelecimento_p);
		commit;

		nr_seq_lista_espera_p := nr_seq_lista_espera_w;
	end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE wsuite_inserir_lista_espera ( nr_seq_ageint_p bigint, nr_seq_ageint_item_p bigint, cd_estabelecimento_p bigint, cd_agenda_p bigint, nm_usuario_p text, dt_desejada_p timestamp, dt_periodo_inicial_p timestamp, dt_periodo_final_p timestamp, nr_telefone_p agenda_lista_espera.nr_telefone%type, nm_pessoa_contato_p agenda_lista_espera.nm_pessoa_contato%type, ds_observacao_p agenda_lista_espera.ds_observacao%type, nr_seq_motivo_urg_p agenda_lista_espera.nr_seq_motivo_urg%type, ie_urgente_p agenda_lista_espera.ie_urgente%type default 'N', nr_seq_lista_espera_p INOUT agenda_integrada.nr_sequencia%type DEFAULT NULL) FROM PUBLIC;

