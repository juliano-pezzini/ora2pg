-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE validar_carga_tuss_hist ( nr_sequencia_p tuss_historico.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type) AS $body$
DECLARE


ds_versao_historico_w		tuss_historico.ds_versao_historico%type;
dt_validacao_w			tuss_historico.dt_validacao%type;
ie_terminologia_w		tuss_historico.ie_terminologia%type;
nr_seq_tuss_material_w		tuss_historico.nr_seq_tuss_material%type;
nr_seq_tuss_medicamento_w	tuss_historico.nr_seq_tuss_medicamento%type;
nr_seq_tuss_procedimento_w	tuss_historico.nr_seq_tuss_procedimento%type;
nr_seq_tuss_servico_w		tuss_historico.nr_seq_tuss_servico%type;
cd_item_tuss_w			tuss_historico_item.cd_item_tuss%type;
ds_item_tuss_w			tuss_historico_item.ds_item_tuss%type;
ds_tipo_acao_hist_w		tuss_historico_item.ds_tipo_acao_hist%type;
dt_final_vigencia_w		tuss_historico_item.dt_final_vigencia%type;
dt_importacao_w			tuss_historico_item.dt_importacao%type;
dt_inicio_vigencia_w		tuss_historico_item.dt_inicio_vigencia%type;
nr_seq_hist_item_w		tuss_historico_item.nr_sequencia%type;
nr_seq_val_tuss_w		w_validacao_tuss_matmed.nr_sequencia%type;

qt_contador_pb_w			bigint;

c_tuss_hist_item CURSOR FOR
	SELECT	cd_item_tuss,
		ds_item_tuss,
		ds_tipo_acao_hist,
		dt_final_vigencia,
		dt_importacao,
		dt_inicio_vigencia,
		ie_terminologia,
		nr_sequencia
	from	tuss_historico_item
	where	nr_seq_historico = nr_sequencia_p;

c_material_tuss CURSOR FOR
	SELECT	nr_sequencia,
		cd_material,
		dt_vigencia_inicial
	from	material_tuss
	where	nr_seq_tuss_mat = nr_seq_tuss_material_w
	and	cd_material_tuss = cd_item_tuss_w
	and	coalesce(dt_vigencia_final::text, '') = '';

c_medicamento_tuss CURSOR FOR
	SELECT	nr_sequencia,
		cd_material,
		dt_vigencia_inicial
	from	material_tuss
	where	nr_seq_tuss_mat = nr_seq_tuss_medicamento_w
	and	cd_material_tuss = cd_item_tuss_w
	and	coalesce(dt_vigencia_final::text, '') = '';

c_material_brasindice CURSOR FOR
	SELECT	*
	from	(
		SELECT	a.nr_sequencia,
			a.cd_material,
			a.dt_vigencia,
			(select substr(obter_tuss_brasindice(a.cd_apresentacao, a.cd_laboratorio, a.cd_medicamento),1,15) ) cd_tuss
		from	material_brasindice a
		where	coalesce(a.dt_final_vigencia::text, '') = ''
		and	a.ie_situacao = 'A') x
	where	x.cd_tuss = cd_item_tuss_w;

c_material_simpro CURSOR FOR
	SELECT	*
	from 	(
		SELECT	a.nr_sequencia,
			a.cd_material,
			a.dt_vigencia,
			(select substr(obter_tuss_simpro_preco(a.nr_sequencia,a.dt_vigencia),1,15) ) cd_tuss
		from	material_simpro a
		where	coalesce(a.dt_final_vigencia::text, '') = ''
		and	a.ie_situacao = 'A') x
	where	x.cd_tuss = cd_item_tuss_w;

c_proc_int_conv_tuss CURSOR FOR
	SELECT	nr_sequencia,
		nr_seq_proc_interno,
		dt_inicio_vigencia,
		cd_procedimento,
		ie_origem_proced
	from	proc_interno_conv_tuss
	where	cd_procedimento = cd_item_tuss_w
	and	ie_situacao = 'A';

c_proc_interno CURSOR FOR
	SELECT	nr_sequencia,
		cd_procedimento_tuss,
		ie_origem_proc_tuss
	from	proc_interno
	where	cd_procedimento_tuss = cd_item_tuss_w
	and	ie_situacao = 'A';

c_exame_lab_conv_tuss CURSOR FOR
	SELECT	nr_sequencia,
		nr_seq_exame,
		cd_procedimento,
		ie_origem_proced
	from	exame_lab_conv_tuss
	where	cd_procedimento = cd_item_tuss_w
	and	ie_situacao = 'A';


c_exame_laboratorio CURSOR FOR
	SELECT	nr_seq_exame,
		nr_seq_proc_interno,
		cd_procedimento_tuss,
		ie_origem_proc_tuss
	from	exame_laboratorio
	where	CD_PROCEDIMENTO_TUSS = cd_item_tuss_w
	and	ie_situacao = 'A';
BEGIN

qt_contador_pb_w := 0;
CALL gravar_processo_longo(WHEB_MENSAGEM_PCK.get_texto(1044748) ,'VALIDAR_CARGA_TUSS_HIST',qt_contador_pb_w);

delete	from w_validacao_tuss_matmed
where	nm_usuario = nm_usuario_p;

delete	from w_validacao_tuss_procserv
where	nm_usuario = nm_usuario_p;

select	nr_seq_tuss_material,
	nr_seq_tuss_medicamento,
	nr_seq_tuss_procedimento,
	nr_seq_tuss_servico
into STRICT	nr_seq_tuss_material_w,
	nr_seq_tuss_medicamento_w,
	nr_seq_tuss_procedimento_w,
	nr_seq_tuss_servico_w
from	tuss_historico
where	nr_sequencia = nr_sequencia_p;

for r_tuss_hist_item in c_tuss_hist_item loop
	begin

	qt_contador_pb_w := qt_contador_pb_w + 1;
	CALL gravar_processo_longo(substr(r_tuss_hist_item.cd_item_tuss || ' - ' || r_tuss_hist_item.ds_item_tuss,1,50),'VALIDAR_CARGA_TUSS_HIST',qt_contador_pb_w);

	cd_item_tuss_w	:= r_tuss_hist_item.cd_item_tuss;

	if (upper(r_tuss_hist_item.ds_tipo_acao_hist) = 'INATIVADO') then
		begin

		if (coalesce(r_tuss_hist_item.ie_terminologia,'X') = '19') then
			begin

			for r_material_tuss in c_material_tuss loop
				begin

				update	material_tuss
				set	dt_vigencia_final = r_tuss_hist_item.dt_final_vigencia,
					dt_atualizacao = clock_timestamp(),
					nm_usuario = nm_usuario_p
				where	nr_sequencia = r_material_tuss.nr_sequencia;

				select	nextval('w_validacao_tuss_matmed_seq')
				into STRICT	nr_seq_val_tuss_w
				;

				insert into w_validacao_tuss_matmed(
					nr_sequencia,
					dt_atualizacao,
					nm_usuario,
					cd_material,
					cd_material_tuss,
					dt_vigencia_inicial,
					dt_vigencia_final,
					nr_seq_tuss_hist,
					nr_seq_tuss_mat,
					nr_seq_tabela_origem)
				values (	nr_seq_val_tuss_w,
					clock_timestamp(),
					nm_usuario_p,
					r_material_tuss.cd_material,
					cd_item_tuss_w,
					r_material_tuss.dt_vigencia_inicial,
					r_tuss_hist_item.dt_final_vigencia,
					nr_sequencia_p,
					nr_seq_tuss_material_w,
					r_material_tuss.nr_sequencia);
				end;
			end loop;

			end;
		end if;

		if (coalesce(r_tuss_hist_item.ie_terminologia,'X') = '20') then
			begin

			for r_medicamento_tuss in c_medicamento_tuss loop
				begin

				update	material_tuss
				set	dt_vigencia_final = r_tuss_hist_item.dt_final_vigencia,
					dt_atualizacao = clock_timestamp(),
					nm_usuario = nm_usuario_p
				where	nr_sequencia = r_medicamento_tuss.nr_sequencia;

				select	nextval('w_validacao_tuss_matmed_seq')
				into STRICT	nr_seq_val_tuss_w
				;

				insert into w_validacao_tuss_matmed(
					nr_sequencia,
					dt_atualizacao,
					nm_usuario,
					cd_material,
					cd_material_tuss,
					dt_vigencia_inicial,
					dt_vigencia_final,
					nr_seq_tuss_hist,
					nr_seq_tuss_mat,
					nr_seq_tabela_origem)
				values (	nr_seq_val_tuss_w,
					clock_timestamp(),
					nm_usuario_p,
					r_medicamento_tuss.cd_material,
					cd_item_tuss_w,
					r_medicamento_tuss.dt_vigencia_inicial,
					r_tuss_hist_item.dt_final_vigencia,
					nr_sequencia_p,
					nr_seq_tuss_medicamento_w,
					r_medicamento_tuss.nr_sequencia);
				end;
			end loop;

			end;
		end if;

		if (coalesce(r_tuss_hist_item.ie_terminologia,'X') in ('19','20')) then
			begin

			for r_material_simpro in c_material_simpro loop
				begin

				select	nextval('w_validacao_tuss_matmed_seq')
				into STRICT	nr_seq_val_tuss_w
				;

				insert into w_validacao_tuss_matmed(
					nr_sequencia,
					dt_atualizacao,
					nm_usuario,
					cd_material,
					cd_material_tuss,
					dt_vigencia_inicial,
					dt_vigencia_final,
					ie_tipo_preco_item,
					nr_seq_tuss_hist,
					nr_seq_tuss_mat,
					nr_seq_tabela_origem)
				values (	nr_seq_val_tuss_w,
					clock_timestamp(),
					nm_usuario_p,
					r_material_simpro.cd_material,
					cd_item_tuss_w,
					r_material_simpro.dt_vigencia,
					r_tuss_hist_item.dt_final_vigencia,
					'Simpro',
					nr_sequencia_p,
					null,
					r_material_simpro.nr_sequencia);
				end;
			end loop;

			for r_material_brasindice in c_material_brasindice loop
				begin

				select	nextval('w_validacao_tuss_matmed_seq')
				into STRICT	nr_seq_val_tuss_w
				;

				insert into w_validacao_tuss_matmed(
					nr_sequencia,
					dt_atualizacao,
					nm_usuario,
					cd_material,
					cd_material_tuss,
					dt_vigencia_inicial,
					dt_vigencia_final,
					ie_tipo_preco_item,
					nr_seq_tuss_hist,
					nr_seq_tuss_mat,
					nr_seq_tabela_origem)
				values (	nr_seq_val_tuss_w,
					clock_timestamp(),
					nm_usuario_p,
					r_material_brasindice.cd_material,
					cd_item_tuss_w,
					r_material_brasindice.dt_vigencia,
					r_tuss_hist_item.dt_final_vigencia,
					'Bras√≠ndice',
					nr_sequencia_p,
					null,
					r_material_brasindice.nr_sequencia);
				end;
			end loop;

			end;
		end if;

		if (coalesce(r_tuss_hist_item.ie_terminologia,'X') in ('18','22')) then
			begin

			for r_proc_int_conv_tuss in c_proc_int_conv_tuss loop
				begin

				update	proc_interno_conv_tuss
				set	dt_final_vigencia = r_tuss_hist_item.dt_final_vigencia,
					dt_atualizacao = clock_timestamp(),
					nm_usuario = nm_usuario_p
				where	nr_sequencia = r_proc_int_conv_tuss.nr_sequencia;

				select	nextval('w_validacao_tuss_procserv_seq')
				into STRICT	nr_seq_val_tuss_w
				;

				insert into w_validacao_tuss_procserv(
					cd_procedimento_tuss,
					cd_proced_tuss_novo,
					dt_atualizacao,
					dt_vigencia_final,
					dt_vigencia_inicial,
					ie_origem_proced,
					ie_tipo_preco_item,
					nm_usuario,
					nr_seq_exame,
					nr_seq_proc_interno,
					nr_seq_tuss_hist,
					nr_seq_tuss_serv,
					nr_seq_tuss_proc,
					nr_seq_tabela_origem,
					nr_sequencia)
				values (	r_proc_int_conv_tuss.cd_procedimento,
					null,
					clock_timestamp(),
					r_proc_int_conv_tuss.dt_inicio_vigencia,
					r_tuss_hist_item.dt_final_vigencia,
					r_proc_int_conv_tuss.ie_origem_proced,
					'Proc interno conv',
					nm_usuario_p,
					null,
					r_proc_int_conv_tuss.nr_seq_proc_interno,
					nr_sequencia_p,
					nr_seq_tuss_servico_w,
					nr_seq_tuss_procedimento_w,
					r_proc_int_conv_tuss.nr_sequencia,
					nr_seq_val_tuss_w);

				end;
			end loop;

			for r_proc_interno in c_proc_interno loop
				begin

				select	nextval('w_validacao_tuss_procserv_seq')
				into STRICT	nr_seq_val_tuss_w
				;

				insert into w_validacao_tuss_procserv(
					cd_procedimento_tuss,
					cd_proced_tuss_novo,
					dt_atualizacao,
					dt_vigencia_final,
					dt_vigencia_inicial,
					ie_origem_proced,
					ie_tipo_preco_item,
					nm_usuario,
					nr_seq_exame,
					nr_seq_proc_interno,
					nr_seq_tuss_hist,
					nr_seq_tuss_serv,
					nr_seq_tuss_proc,
					nr_seq_tabela_origem,
					nr_sequencia)
				values (	r_proc_interno.cd_procedimento_tuss,
					null,
					clock_timestamp(),
					null,
					r_tuss_hist_item.dt_final_vigencia,
					r_proc_interno.ie_origem_proc_tuss,
					'Proc interno',
					nm_usuario_p,
					null,
					r_proc_interno.nr_sequencia,
					nr_sequencia_p,
					nr_seq_tuss_servico_w,
					nr_seq_tuss_procedimento_w,
					r_proc_interno.nr_sequencia,
					nr_seq_val_tuss_w);

				end;
			end loop;

			for r_exame_lab_conv_tuss in c_exame_lab_conv_tuss loop
				begin

				select	nextval('w_validacao_tuss_procserv_seq')
				into STRICT	nr_seq_val_tuss_w
				;

				insert into w_validacao_tuss_procserv(
					cd_procedimento_tuss,
					cd_proced_tuss_novo,
					dt_atualizacao,
					dt_vigencia_final,
					dt_vigencia_inicial,
					ie_origem_proced,
					ie_tipo_preco_item,
					nm_usuario,
					nr_seq_exame,
					nr_seq_proc_interno,
					nr_seq_tuss_hist,
					nr_seq_tuss_serv,
					nr_seq_tuss_proc,
					nr_seq_tabela_origem,
					nr_sequencia)
				values (	r_exame_lab_conv_tuss.cd_procedimento,
					null,
					clock_timestamp(),
					null,
					r_tuss_hist_item.dt_final_vigencia,
					r_exame_lab_conv_tuss.ie_origem_proced,
					'Exame lab convenio',
					nm_usuario_p,
					r_exame_lab_conv_tuss.nr_seq_exame,
					null,
					nr_sequencia_p,
					nr_seq_tuss_servico_w,
					nr_seq_tuss_procedimento_w,
					r_exame_lab_conv_tuss.nr_sequencia,
					nr_seq_val_tuss_w);

				end;
			end loop;

			for r_exame_laboratorio in c_exame_laboratorio loop
				begin

				select	nextval('w_validacao_tuss_procserv_seq')
				into STRICT	nr_seq_val_tuss_w
				;

				insert into w_validacao_tuss_procserv(
					cd_procedimento_tuss,
					cd_proced_tuss_novo,
					dt_atualizacao,
					dt_vigencia_final,
					dt_vigencia_inicial,
					ie_origem_proced,
					ie_tipo_preco_item,
					nm_usuario,
					nr_seq_exame,
					nr_seq_proc_interno,
					nr_seq_tuss_hist,
					nr_seq_tuss_serv,
					nr_seq_tuss_proc,
					nr_seq_tabela_origem,
					nr_sequencia)
				values (	r_exame_laboratorio.cd_procedimento_tuss,
					null,
					clock_timestamp(),
					null,
					r_tuss_hist_item.dt_final_vigencia,
					r_exame_laboratorio.ie_origem_proc_tuss,
					'Exame laboratorio',
					nm_usuario_p,
					r_exame_laboratorio.nr_seq_exame,
					null,
					nr_sequencia_p,
					nr_seq_tuss_servico_w,
					nr_seq_tuss_procedimento_w,
					r_exame_laboratorio.nr_seq_exame,
					nr_seq_val_tuss_w);

				end;
			end loop;

			end;
		end if;

		end;
	end if;

	end;
end loop;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE validar_carga_tuss_hist ( nr_sequencia_p tuss_historico.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type) FROM PUBLIC;

