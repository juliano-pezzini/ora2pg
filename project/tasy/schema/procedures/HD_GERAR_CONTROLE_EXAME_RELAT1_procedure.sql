-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE hd_gerar_controle_exame_relat1 (cd_pessoa_fisica_p text, dt_parametro_p timestamp, dt_inicial_p timestamp, dt_final_p timestamp, nr_seq_protocolo_p bigint, ds_itens_p text, nm_usuario_p text, NR_SEQ_UNIDADE_p bigint, ie_forma_impressao_p text default 'O') AS $body$
DECLARE

dt_referencia_w		timestamp;
dt_inicial_w		timestamp;
dt_final_w		timestamp;
cd_pessoa_fisica_w	varchar(255);

ds_resultado31_w	hd_exame_grid_controle.ds_resultado31%type;
ds_resultado32_w	hd_exame_grid_controle.ds_resultado32%type;
ds_resultado33_w	hd_exame_grid_controle.ds_resultado33%type;
ds_resultado34_w	hd_exame_grid_controle.ds_resultado34%type;
ds_resultado35_w	hd_exame_grid_controle.ds_resultado35%type;
ds_resultado36_w	hd_exame_grid_controle.ds_resultado36%type;
ds_resultado37_w	hd_exame_grid_controle.ds_resultado37%type;
ds_resultado38_w	hd_exame_grid_controle.ds_resultado38%type;
ds_resultado39_w	hd_exame_grid_controle.ds_resultado39%type;
ds_resultado40_w	hd_exame_grid_controle.ds_resultado40%type;
ds_resultado41_w	hd_exame_grid_controle.ds_resultado41%type;
ds_resultado42_w	hd_exame_grid_controle.ds_resultado42%type;
ds_resultado43_w	hd_exame_grid_controle.ds_resultado43%type;
ds_resultado44_w	hd_exame_grid_controle.ds_resultado44%type;
ds_resultado45_w	hd_exame_grid_controle.ds_resultado45%type;
ds_resultado46_w	hd_exame_grid_controle.ds_resultado46%type;
ds_resultado47_w	hd_exame_grid_controle.ds_resultado47%type;
ds_resultado48_w	hd_exame_grid_controle.ds_resultado48%type;
ds_resultado49_w	hd_exame_grid_controle.ds_resultado49%type;
ds_resultado50_w	hd_exame_grid_controle.ds_resultado50%type;

c01 CURSOR FOR
	SELECT	cd_pessoa_fisica
	from	hd_pac_renal_cronico
	where	hd_obter_se_pac_ativo_data(cd_pessoa_fisica,dt_referencia_w) = 'S'
	and	((cd_pessoa_fisica = cd_pessoa_fisica_p) or (coalesce( cd_pessoa_fisica_p,'0') = '0'))
	and (coalesce(hd_obter_unidade_prc(CD_PESSOA_FISICA,'C'),NR_SEQ_UNID_DIALISE) = NR_SEQ_UNIDADE_p or coalesce(NR_SEQ_UNIDADE_p,0) = 0)
	order by cd_pessoa_fisica;


BEGIN

dt_referencia_w	:= clock_timestamp();
dt_inicial_w	:= clock_timestamp();
dt_final_w	:= clock_timestamp();

if (dt_parametro_p IS NOT NULL AND dt_parametro_p::text <> '') then
	dt_referencia_w := dt_parametro_p;
end if;
if (dt_inicial_p IS NOT NULL AND dt_inicial_p::text <> '') then
	dt_inicial_w := dt_inicial_p;
end if;
if (dt_final_p IS NOT NULL AND dt_final_p::text <> '') then
	dt_final_w := dt_final_p;
end if;

if (ie_forma_impressao_p = 'O') then
	begin
	open c01;
	loop
	fetch c01 into
		cd_pessoa_fisica_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
		begin

		CALL hd_gerar_controle_exame_1(cd_pessoa_fisica_w,
					nr_seq_protocolo_p,
					dt_referencia_w,
					dt_inicial_w,
					dt_final_w,
					ds_itens_p,
					'N',
					NR_SEQ_UNIDADE_p,
					nm_usuario_p);

		end;
	end loop;
	close c01;
	end;

	select	'          '||SUBSTR(HD_obter_dados_rel( nm_usuario_p, dt_inicial_w, dt_final_w, cd_pessoa_fisica_p, NR_SEQ_UNIDADE_p, CASE WHEN  dt_referencia_w='0' THEN  null  ELSE dt_referencia_w END , 'NUTRICAO', 'PTPC'),1,20)||'%        ' ds_ptpc_nutricao,
			SUBSTR(HD_obter_dados_rel( nm_usuario_p, dt_inicial_w, dt_final_w, cd_pessoa_fisica_p, NR_SEQ_UNIDADE_p, CASE WHEN  dt_referencia_w='0' THEN  null  ELSE dt_referencia_w END , 'METABOLISMO', 'PCQ'),1,20)||'%' ds_pcq_metabolismo,
			SUBSTR(HD_obter_dados_rel( nm_usuario_p, dt_inicial_w, dt_final_w, cd_pessoa_fisica_p, NR_SEQ_UNIDADE_p, CASE WHEN  dt_referencia_w='0' THEN  null  ELSE dt_referencia_w END , 'METABOLISMO', 'PMECEM'),1,20)||'%' ds_pmecem_metabolismo,
			SUBSTR(HD_obter_dados_rel( nm_usuario_p, dt_inicial_w, dt_final_w, cd_pessoa_fisica_p, NR_SEQ_UNIDADE_p, CASE WHEN  dt_referencia_w='0' THEN  null  ELSE dt_referencia_w END , 'METABOLISMO', 'PMAQ'),1,20)||'%' ds_pmaq_metabolismo,
			SUBSTR(HD_obter_dados_rel( nm_usuario_p, dt_inicial_w, dt_final_w, cd_pessoa_fisica_p, NR_SEQ_UNIDADE_p, CASE WHEN  dt_referencia_w='0' THEN  null  ELSE dt_referencia_w END , 'METABOLISMO', 'PFOS'),1,20)||'%' ds_pfos_metabolismo,
			SUBSTR(HD_obter_dados_rel( nm_usuario_p, dt_inicial_w, dt_final_w, cd_pessoa_fisica_p, NR_SEQ_UNIDADE_p, CASE WHEN  dt_referencia_w='0' THEN  null  ELSE dt_referencia_w END , 'METABOLISMO', 'PCALPOT'),1,20)||'%' ds_pcalpot_metabolismo,
			SUBSTR(HD_obter_dados_rel( nm_usuario_p, dt_inicial_w, dt_final_w, cd_pessoa_fisica_p, NR_SEQ_UNIDADE_p, CASE WHEN  dt_referencia_w='0' THEN  null  ELSE dt_referencia_w END , 'FAV', 'PMANOV'),1,20)||'%' ds_pmanov_fav,
			SUBSTR(HD_obter_dados_rel( nm_usuario_p, dt_inicial_w, dt_final_w, cd_pessoa_fisica_p, NR_SEQ_UNIDADE_p, CASE WHEN  dt_referencia_w='0' THEN  null  ELSE dt_referencia_w END , 'GPID', 'PMECIN'),1,20)||'%' ds_pmecin_gpid,
			SUBSTR(HD_obter_dados_rel( nm_usuario_p, dt_inicial_w, dt_final_w, cd_pessoa_fisica_p, NR_SEQ_UNIDADE_p, CASE WHEN  dt_referencia_w='0' THEN  null  ELSE dt_referencia_w END , 'ATEND', 'ATEND'),1,20) ds_nr_atend,
			CASE WHEN SUBSTR(HD_obter_dados_rel( nm_usuario_p, dt_inicial_w, dt_final_w, cd_pessoa_fisica_p, NR_SEQ_UNIDADE_p, CASE WHEN  dt_referencia_w='0' THEN  null  ELSE dt_referencia_w END , 'OBITO', 'OBITO'),1,20)=2 THEN obter_desc_expressao(327113)  ELSE obter_desc_expressao(327114) END  ds_obito,
			substr(HD_obter_dados_rel( nm_usuario_p, dt_inicial_w, dt_final_w, cd_pessoa_fisica_p, NR_SEQ_UNIDADE_p, CASE WHEN  dt_referencia_w='0' THEN  null  ELSE dt_referencia_w END , 'KTV', 'PA'),1,20)||'%'||'              '||SUBSTR(HD_obter_dados_rel( nm_usuario_p, dt_inicial_w, dt_final_w, cd_pessoa_fisica_p, NR_SEQ_UNIDADE_p, CASE WHEN  dt_referencia_w='0' THEN  null  ELSE dt_referencia_w END , 'KTV', 'PT'),1,20)||'%',
			substr(HD_obter_dados_rel( nm_usuario_p, dt_inicial_w, dt_final_w, cd_pessoa_fisica_p, NR_SEQ_UNIDADE_p, CASE WHEN  dt_referencia_w='0' THEN  null  ELSE dt_referencia_w END , 'ANEMIA', 'POT'),1,20)||'%',
			substr(HD_obter_dados_rel( nm_usuario_p, dt_inicial_w, dt_final_w, cd_pessoa_fisica_p, NR_SEQ_UNIDADE_p, CASE WHEN  dt_referencia_w='0' THEN  null  ELSE dt_referencia_w END , 'ANEMIA', 'PMEO'),1,20)||'%',
			substr(HD_obter_dados_rel( nm_usuario_p, dt_inicial_w, dt_final_w, cd_pessoa_fisica_p, NR_SEQ_UNIDADE_p, CASE WHEN  dt_referencia_w='0' THEN  null  ELSE dt_referencia_w END , 'ANEMIA', 'PMAT'),1,20)||'%',
			substr(HD_obter_dados_rel( nm_usuario_p, dt_inicial_w, dt_final_w, cd_pessoa_fisica_p, NR_SEQ_UNIDADE_p, CASE WHEN  dt_referencia_w='0' THEN  null  ELSE dt_referencia_w END , 'FERRITINA', 'PCS'),1,20)||'%',
			substr(HD_obter_dados_rel( nm_usuario_p, dt_inicial_w, dt_final_w, cd_pessoa_fisica_p, NR_SEQ_UNIDADE_p, CASE WHEN  dt_referencia_w='0' THEN  null  ELSE dt_referencia_w END , 'FERRITINA', 'PMEC'),1,20)||'%',
			substr(HD_obter_dados_rel( nm_usuario_p, dt_inicial_w, dt_final_w, cd_pessoa_fisica_p, NR_SEQ_UNIDADE_p, CASE WHEN  dt_referencia_w='0' THEN  null  ELSE dt_referencia_w END , 'FERRITINA', 'PMAS'),1,20)||'%',
			substr(HD_obter_dados_rel( nm_usuario_p, dt_inicial_w, dt_final_w, cd_pessoa_fisica_p, NR_SEQ_UNIDADE_p, CASE WHEN  dt_referencia_w='0' THEN  null  ELSE dt_referencia_w END , 'TRANSFERRINA', 'PVQC'),1,20)||'%',
			substr(HD_obter_dados_rel( nm_usuario_p, dt_inicial_w, dt_final_w, cd_pessoa_fisica_p, NR_SEQ_UNIDADE_p, CASE WHEN  dt_referencia_w='0' THEN  null  ELSE dt_referencia_w END , 'TRANSFERRINA', 'PMEV'),1,20)||'%',
			substr(HD_obter_dados_rel( nm_usuario_p, dt_inicial_w, dt_final_w, cd_pessoa_fisica_p, NR_SEQ_UNIDADE_p, CASE WHEN  dt_referencia_w='0' THEN  null  ELSE dt_referencia_w END , 'TRANSFERRINA', 'PMAQC'),1,20)||'%'
	into STRICT		ds_resultado31_w,
			ds_resultado32_w,
			ds_resultado33_w,
			ds_resultado34_w,
			ds_resultado35_w,
			ds_resultado36_w,
			ds_resultado37_w,
			ds_resultado38_w,
			ds_resultado39_w,
			ds_resultado40_w,
			ds_resultado41_w,
			ds_resultado42_w,
			ds_resultado43_w,
			ds_resultado44_w,
			ds_resultado45_w,
			ds_resultado46_w,
			ds_resultado47_w,
			ds_resultado48_w,
			ds_resultado49_w,
			ds_resultado50_w
	;

	delete from hd_exame_grid_controle
	where	nm_usuario	= nm_usuario_p
	and	ie_ordem	= 10;

	insert into hd_exame_grid_controle(
		nr_sequencia,
		nm_usuario,
		ie_ordem,
		dt_referencia,
		ds_resultado31,
		ds_resultado32,
		ds_resultado33,
		ds_resultado34,
		ds_resultado35,
		ds_resultado36,
		ds_resultado37,
		ds_resultado38,
		ds_resultado39,
		ds_resultado40,
		ds_resultado41,
		ds_resultado42,
		ds_resultado43,
		ds_resultado44,
		ds_resultado45,
		ds_resultado46,
		ds_resultado47,
		ds_resultado48,
		ds_resultado49,
		ds_resultado50,
		dt_atualizacao)
	Values ( nextval('hd_exame_grid_controle_seq'),
		nm_usuario_p,
		10,
		dt_referencia_w,
		ds_resultado31_w,
		ds_resultado32_w,
		ds_resultado33_w,
		ds_resultado34_w,
		ds_resultado35_w,
		ds_resultado36_w,
		ds_resultado37_w,
		ds_resultado38_w,
		ds_resultado39_w,
		ds_resultado40_w,
		ds_resultado41_w,
		ds_resultado42_w,
		ds_resultado43_w,
		ds_resultado44_w,
		ds_resultado45_w,
		ds_resultado46_w,
		ds_resultado47_w,
		ds_resultado48_w,
		ds_resultado49_w,
		ds_resultado50_w,
		clock_timestamp());
	commit;

end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE hd_gerar_controle_exame_relat1 (cd_pessoa_fisica_p text, dt_parametro_p timestamp, dt_inicial_p timestamp, dt_final_p timestamp, nr_seq_protocolo_p bigint, ds_itens_p text, nm_usuario_p text, NR_SEQ_UNIDADE_p bigint, ie_forma_impressao_p text default 'O') FROM PUBLIC;

