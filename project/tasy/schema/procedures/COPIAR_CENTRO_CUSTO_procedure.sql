-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE copiar_centro_custo (nm_usuario_p text, cd_estabelecimento_p bigint, cd_centro_custo_p INOUT bigint) AS $body$
DECLARE


cd_centro_custo_w	centro_custo.cd_centro_custo%type;
ie_tipo_estab_w		estabelecimento.ie_tipo_estab%type;
cd_empresa_w		empresa.cd_empresa%type;
cd_grupo_emp_w		grupo_empresa.nr_sequencia%type;
cd_emp_controladora_w	empresa.cd_empresa%type;
ie_permissao_acesso_w 	varchar(1)   := 'N';


BEGIN

cd_empresa_w		:= obter_empresa_estab(cd_estabelecimento_p);
cd_grupo_emp_w		:= holding_pck.get_grupo_emp_usuario_vigente(cd_empresa_w);
cd_emp_controladora_w	:= holding_pck.get_emp_controladora_grupo(cd_grupo_emp_w, cd_empresa_w);
ie_permissao_acesso_w := holding_pck.get_emp_grupo_empresa(	cd_empresa_w,
							wheb_usuario_pck.get_cd_funcao,
                                                          				wheb_usuario_pck.get_cd_perfil,
                                                          				wheb_usuario_pck.get_nm_usuario, 
                                                          				null, 
                                                          				'GEM');

select	coalesce(max(cd_centro_custo),0) + 1
into STRICT	cd_centro_custo_w
from	centro_custo;

insert	into centro_custo(
		cd_centro_custo,
		ds_centro_custo,
		ie_situacao,
		dt_atualizacao,
		nm_usuario,
		nr_seq_terceiro,
		cd_classificacao,
		ie_tipo,
		cd_grupo,
		cd_estabelecimento,
		cd_centro_custo_consumo,
		cd_sistema_contabil,
		ie_tipo_custo,
		dt_atualizacao_nrec,
		nm_usuario_nrec,
		cd_centro_custo_ref)
	(SELECT	cd_centro_custo_w,
		substr(obter_desc_expressao(347811)|| nm_usuario_p || ' - ' || ds_centro_custo,1,80),
		'A',
		clock_timestamp(),
		nm_usuario_p,
		nr_seq_terceiro,
		cd_classificacao,
		ie_tipo,
		cd_grupo,
		cd_estabelecimento_p,
		cd_centro_custo_consumo,
		cd_sistema_contabil,
		ie_tipo_custo,
		clock_timestamp(),
		nm_usuario_p,
		CASE WHEN cd_empresa_w=cd_emp_controladora_w THEN  cd_centro_custo_ref  ELSE null END
	from	centro_custo
	where	cd_centro_custo = cd_centro_custo_p);

	insert	into centro_custo_material(
		nr_sequencia,
		cd_centro_custo,
		dt_atualizacao,
		nm_usuario,
		cd_grupo_material,
		cd_subgrupo_material,
		cd_classe_material,
		cd_material,
		ie_requisicao,
		ie_exclui)
	(SELECT	nextval('centro_custo_material_seq'),
		cd_centro_custo_w,
		clock_timestamp(),
		nm_usuario_p,
		cd_grupo_material,
		cd_subgrupo_material,
		cd_classe_material,
		cd_material,
		ie_requisicao,
		ie_exclui
	from	centro_custo_material
	where	cd_centro_custo = cd_centro_custo_p);

cd_centro_custo_p := cd_centro_custo_w;

/* OS 2048079 -  Validar permiss√£o Grupo Empresa */

if (ie_permissao_acesso_w = 'S' and cd_empresa_w = cd_emp_controladora_w) then
	begin
	/* OS 2039956 - Copiar para estabelecimentos matriz da holding */

	select 	coalesce(es.ie_tipo_estab, 'F')
	into STRICT	ie_tipo_estab_w
	from 	estabelecimento es,
		empresa e,
		grupo_emp_estrutura g
	where  	es.cd_empresa = e.cd_empresa
	and    	e.cd_empresa = g.cd_empresa
	and   	g.ie_tipo_estrutura = 1
	and    	es.cd_estabelecimento = cd_estabelecimento_p;
	end;
	
	if (ie_tipo_estab_w = 'M') then	
	begin
		CALL copiar_centro_custo_holding(cd_centro_custo_w, 1, nm_usuario_p);
	end;
	end if;
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE copiar_centro_custo (nm_usuario_p text, cd_estabelecimento_p bigint, cd_centro_custo_p INOUT bigint) FROM PUBLIC;

