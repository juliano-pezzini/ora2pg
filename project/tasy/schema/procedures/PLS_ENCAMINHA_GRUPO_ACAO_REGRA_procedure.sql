-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_encaminha_grupo_acao_regra ( nr_seq_auditoria_p bigint, ie_tipo_acao_p bigint, nm_usuario_p text, ie_gerar_grupo_regra_p INOUT text) AS $body$
DECLARE

 
nr_seq_grupo_w			bigint;
nr_seq_aud_grupo_w		bigint;
qt_acao_executada_w		bigint;
nr_seq_guia_w			bigint;
nr_seq_requisicao_w		bigint;
nr_seq_grupo_regra_w		bigint;
ie_gerar_grupo_regra_w		varchar(2)	:= 'N';
nr_seq_enca_grupo_aut_w		bigint;
qt_grupo_inserido_w		bigint;

C01 CURSOR FOR 
	SELECT	nr_sequencia, 
		nr_seq_grupo_auditor 
	from	pls_encaminha_grupo_aut 
	where	ie_tipo_acao		= ie_tipo_acao_p 
	and 	ie_situacao		= 'A' 
	and	qt_aplicacao_regra	<= qt_acao_executada_w;


BEGIN 
 
begin 
	select	coalesce(nr_seq_guia,0), 
		coalesce(nr_seq_requisicao,0) 
	into STRICT	nr_seq_guia_w, 
		nr_seq_requisicao_w 
	from	pls_auditoria 
	where	nr_sequencia	= nr_seq_auditoria_p;
exception 
when others then 
	nr_seq_guia_w		:= 0;
	nr_seq_requisicao_w	:= 0;
end;
	 
	 
--Solicitar justificativa do prestador 
if ( ie_tipo_acao_p	= 1 ) then 
	nr_seq_aud_grupo_w	:= pls_obter_grupo_analise_atual(nr_seq_auditoria_p);
	 
	select	max(nr_seq_grupo) 
	into STRICT	nr_seq_grupo_w 
	from	pls_auditoria_grupo 
	where	nr_sequencia	= nr_seq_aud_grupo_w;
 
	begin 
		select	coalesce(nr_seq_guia,0), 
			coalesce(nr_seq_requisicao,0) 
		into STRICT	nr_seq_guia_w, 
			nr_seq_requisicao_w 
		from	pls_auditoria 
		where	nr_sequencia	= nr_seq_auditoria_p;
	exception 
	when others then 
		nr_seq_guia_w		:= 0;
		nr_seq_requisicao_w	:= 0;
	end;
 
	if (nr_seq_guia_w	<> 0) then 
		select	count(1) 
		into STRICT	qt_acao_executada_w 
		from	pls_guia_plano_historico 
		where	nr_seq_grupo		= nr_seq_grupo_w 
		and	ie_tipo_historico	= 'J' 
		and	nr_seq_guia		= nr_seq_guia_w;
	elsif (nr_seq_requisicao_w	<> 0) then 
		select	count(1) 
		into STRICT	qt_acao_executada_w 
		from	pls_requisicao_historico 
		where	nr_seq_grupo		= nr_seq_grupo_w 
		and	ie_tipo_historico	= 'J' 
		and	nr_seq_requisicao	= nr_seq_requisicao_w;
	end if;
	 
	/* É necessário adicionar + 1 na variavel, porque se já existir alguma solicitação de justificativa 
	esta sendo criada uma nova que ainda não existe registro na base*/
 
	qt_acao_executada_w := qt_acao_executada_w + 1;
 
--Recebimento do lote de anexo de guias 
elsif ( ie_tipo_acao_p = 2 ) then	 
	select	count(1) 
	into STRICT	qt_acao_executada_w 
	from	pls_auditoria 
	where	nr_sequencia = nr_seq_auditoria_p 
	and	ie_status = 'AAG';	
end if;
 
open C01;
loop 
fetch C01 into 
	nr_seq_enca_grupo_aut_w, 
	nr_seq_grupo_regra_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin 
	ie_gerar_grupo_regra_w	:= 'S';
	CALL pls_inserir_grupo_auditor( nr_seq_grupo_regra_w, nr_seq_auditoria_p, null, nm_usuario_p );
	if (nr_seq_guia_w	<> 0) then 
		CALL pls_guia_gravar_historico(	nr_seq_guia_w, null, substr('Inserido o grupo '||substr(pls_obter_nome_grupo_auditor(nr_seq_grupo_regra_w),1,120)|| 
						', através da regra '||nr_seq_enca_grupo_aut_w|| 
						', cadastrada na função OPS - Controle dos Grupos de Análise, pastas Regras > Autorização > Regra encaminhamento x ação executada.',1,4000), 
						null, nm_usuario_p);
	elsif (nr_seq_requisicao_w	<> 0) then 
		CALL pls_requisicao_gravar_hist(	nr_seq_requisicao_w, 'L', substr('Inserido o grupo '||substr(pls_obter_nome_grupo_auditor(nr_seq_grupo_regra_w),1,120)|| 
						', através da regra '||nr_seq_enca_grupo_aut_w|| 
						', cadastrada na função OPS - Controle dos Grupos de Análise, pastas Regras > Autorização > Regra encaminhamento x ação executada.',1,4000), 
						null, nm_usuario_p);
	end if;
	 
	--Recebimento lote de anexo guias 
	if ( ie_tipo_acao_p = 2 ) then 
		update	pls_auditoria 
		set	ie_status 	= 'A', 
			nm_usuario	= nm_usuario_p, 
			dt_atualizacao	= clock_timestamp() 
		where	nr_sequencia	= nr_seq_auditoria_p;		
	end if;
	 
	end;
end loop;
close C01;
	 
 
ie_gerar_grupo_regra_p	:= ie_gerar_grupo_regra_w;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_encaminha_grupo_acao_regra ( nr_seq_auditoria_p bigint, ie_tipo_acao_p bigint, nm_usuario_p text, ie_gerar_grupo_regra_p INOUT text) FROM PUBLIC;

