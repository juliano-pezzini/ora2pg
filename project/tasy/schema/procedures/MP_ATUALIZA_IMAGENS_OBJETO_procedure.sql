-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE mp_atualiza_imagens_objeto (nr_sequencia_p bigint, nm_usuario_p text) AS $body$
DECLARE


ie_imagem_w		varchar(2)	:= null;
ie_imagem_1_w		varchar(2)	:= null;
ie_imagem_2_w		varchar(2)	:= null;
ie_imagem_3_w		varchar(2)	:= null;
ie_imagem_4_w		varchar(2)	:= null;
indice_w		bigint;
imagem_ind_w		varchar(2)	:= null;
qt_qualidade_w		integer	:= 0;
qt_documento_w		integer	:= 0;
qt_sistema_w		integer	:= 0;
qt_equip_w		integer	:= 0;
qt_pessoa_w		integer	:= 0;
ie_tipo_grupo_w		varchar(1);
nr_seq_processo_ref_w	bigint;
ie_imagem_anterior_w	varchar(2)	:= null;


BEGIN

if (nr_sequencia_p IS NOT NULL AND nr_sequencia_p::text <> '') then
	select	c.ie_tipo_grupo,
		a.nr_seq_processo_ref,
		a.ie_imagem
	into STRICT	ie_tipo_grupo_w,
		nr_seq_processo_ref_w,
		ie_imagem_anterior_w
	from	mp_grupo_objeto c,
		mp_objeto b,
		mp_processo_objeto a
	where	c.nr_sequencia	= b.nr_seq_grupo
	and	b.nr_sequencia	= a.nr_seq_objeto
	and	a.nr_sequencia	= nr_sequencia_p;


	if (ie_tipo_grupo_w = 'P') then
		select	count(*)
		into STRICT	qt_qualidade_w
		from	mp_processo_doc a
		where	a.nr_seq_processo	= nr_seq_processo_ref_w;
	elsif (ie_tipo_grupo_w = 'A') then
		select	count(*)
		into STRICT	qt_qualidade_w
		from	mp_processo_doc a
		where	a.nr_seq_proc_obj	= nr_sequencia_p;

		select	count(*)
		into STRICT	qt_equip_w
		from	mp_processo_obj_rec a
		where	a.nr_seq_obj_proc	= nr_sequencia_p
		and	(a.nr_seq_tipo_equip IS NOT NULL AND a.nr_seq_tipo_equip::text <> '');

		select	count(*)
		into STRICT	qt_pessoa_w
		from	mp_processo_obj_rec a
		where	a.nr_seq_obj_proc	= nr_sequencia_p
		and	(a.cd_cargo IS NOT NULL AND a.cd_cargo::text <> '');

		select	count(*)
		into STRICT	qt_documento_w
		from	mp_proc_obj_doc_ext a
		where	a.nr_seq_obj_proc	= nr_sequencia_p;

		select	sum(qt_registro)
		into STRICT	qt_sistema_w
		from (SELECT	count(*) qt_registro
			from	mp_proc_obj_tasy_rel a
			where	a.nr_seq_obj_proc	= nr_sequencia_p
			
union all

			SELECT	count(*) qt_registro
			from	mp_proc_obj_tasy_funcao a
			where	a.nr_seq_obj_proc	= nr_sequencia_p
			
union all

			select	count(*) qt_registro
			from	mp_proc_obj_tasy_cad a
			where	a.nr_seq_obj_proc	= nr_sequencia_p) alias4;
	end if;

	indice_w	:= 0;
	while	((qt_qualidade_w > 0) or (qt_documento_w > 0) or (qt_sistema_w > 0) or (qt_pessoa_w > 0) or (qt_equip_w > 0)) loop

		if (qt_qualidade_w > 0) then
			imagem_ind_w	:= 'Q';
			qt_qualidade_w	:= 0;
		elsif (qt_documento_w > 0) then
			imagem_ind_w	:= 'D';
			qt_documento_w	:= 0;
		elsif (qt_sistema_w > 0) then
			imagem_ind_w	:= 'S';
			qt_sistema_w	:= 0;
		elsif (qt_pessoa_w > 0) then
			imagem_ind_w	:= 'P';
			qt_pessoa_w	:= 0;
		elsif (qt_equip_w > 0) then
			imagem_ind_w	:= 'E';
			qt_equip_w	:= 0;
		end if;

		if (indice_w = 0) then
			ie_imagem_w	:= imagem_ind_w;
		elsif (indice_w = 1) then
			ie_imagem_1_w	:= imagem_ind_w;
		elsif (indice_w = 2) then
			ie_imagem_2_w	:= imagem_ind_w;
		elsif (indice_w = 3) then
			ie_imagem_3_w	:= imagem_ind_w;
		elsif (indice_w = 4) then
			ie_imagem_4_w	:= imagem_ind_w;
		end if;

		indice_w	:= indice_w + 1;
	end loop;

	if (ie_imagem_w IS NOT NULL AND ie_imagem_w::text <> '') or (ie_imagem_anterior_w IS NOT NULL AND ie_imagem_anterior_w::text <> '') then
		update	mp_processo_objeto
		set	ie_imagem	= ie_imagem_w,
			ie_imagem_1	= ie_imagem_1_w,
			ie_imagem_2	= ie_imagem_2_w,
			ie_imagem_3	= ie_imagem_3_w,
			ie_imagem_4	= ie_imagem_4_w
		where	nr_sequencia	= nr_sequencia_p;
	end if;
end if;

/* NÃ£o pode ter commit nesta procedure */

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE mp_atualiza_imagens_objeto (nr_sequencia_p bigint, nm_usuario_p text) FROM PUBLIC;

