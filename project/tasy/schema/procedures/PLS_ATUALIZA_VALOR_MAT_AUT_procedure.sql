-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_atualiza_valor_mat_aut ( nr_seq_material_p bigint, ie_tipo_p text, nm_usuario_p text) AS $body$
DECLARE


_ora2pg_r RECORD;
/*
ie_tipo_p	
   COMPL - 	Complemento de pedido de autorizacao
   A -	Autorizacao
   R - 	Requisicao
   AA- 	Analise de Autorizacao
   AR-	Analise de Requisicao
   AG-  Anexo Guia
*/
cd_estabelecimento_w		bigint;
nr_seq_prestador_w		bigint;
dt_solicitacao_w		timestamp;
nr_seq_material_w		bigint;
ie_tipo_despesa_w		varchar(1);
ie_origem_preco_w		smallint;
ie_tipo_tabela_w		varchar(1)	:= '';
nr_seq_outorgante_w		bigint;
nr_seq_segurado_w		bigint;
vl_material_w			double precision;
dt_ult_vigencia_w		timestamp;
nr_seq_material_preco_w		bigint;
vl_material_simpro_w		double precision;
vl_material_brasindice_w	double precision;
vl_material_tabela_w		double precision;
nr_seq_regra_w			bigint;
nr_seq_guia_w			bigint;
nr_seq_plano_w			bigint;
nr_seq_prest_fornec_w		bigint;
cd_material_w			bigint;
vl_servico_w			varchar(14);
nr_seq_requisicao_w		bigint;
nr_seq_tipo_acomodacao_w	bigint;
nr_seq_categoria_w		bigint;
nr_seq_tipo_atendimento_w	bigint;
ie_tipo_atend_tiss_w		varchar(2);
nr_seq_clinica_w		bigint;
ie_tipo_guia_w			varchar(2);
qt_autorizacao_espec_w		bigint;
ie_autorizacao_espec_w		varchar(10)	:= 'N';
nr_seq_plano_espec_w		bigint;
cd_guia_referencia_w		varchar(20);
vl_item_w			double precision;
dados_regra_preco_material_w	pls_cta_valorizacao_pck.dados_regra_preco_material;
ie_prestador_preco_w		pls_param_requisicao.ie_prestador_preco%type;
nr_seq_uni_exec_w		pls_guia_plano.nr_seq_uni_exec%type;
ie_regime_atendimento_w		pls_conta.ie_regime_atendimento%type;
ie_saude_ocupacional_w		pls_conta.ie_saude_ocupacional%type;


BEGIN
/*Gerar preco para os servicos do  PTU - Pedido de Complemento de Autorizacao [00505] */

if (ie_tipo_p	= 'COMPL') then
	/*Obter dados do complemento*/

	select	a.nr_seq_guia,
		b.cd_servico,
		b.nr_seq_prest_fornec
	into STRICT	nr_seq_guia_w,
		cd_material_w,
		nr_seq_prest_fornec_w
	from	ptu_pedido_compl_aut_serv	b,
		ptu_pedido_compl_aut		a
	where	b.nr_sequencia	= nr_seq_material_p
	and	b.nr_seq_pedido	= a.nr_sequencia;
	
	/*Obter dados guia*/

	select	a.cd_estabelecimento,
		a.nr_seq_prestador,
		a.dt_solicitacao,
		a.nr_seq_segurado,
		a.nr_seq_plano,
		a.nr_seq_tipo_acomodacao,
		a.ie_tipo_atend_tiss,
		a.nr_seq_clinica,
		a.ie_tipo_guia,
		a.nr_seq_uni_exec,
		a.ie_regime_atendimento,
		a.ie_saude_ocupacional
	into STRICT	cd_estabelecimento_w,
		nr_seq_prestador_w,
		dt_solicitacao_w,
		nr_seq_segurado_w,
		nr_seq_plano_w,
		nr_seq_tipo_acomodacao_w,
		ie_tipo_atend_tiss_w,
		nr_seq_clinica_w,
		ie_tipo_guia_w,
		nr_seq_uni_exec_w,
		ie_regime_atendimento_w,
		ie_saude_ocupacional_w
	from	pls_guia_plano a
	where	a.nr_sequencia = nr_seq_guia_w;
	
	/*Obter sequencia da autorizacao especial*/

	select	max(nr_sequencia)
	into STRICT	nr_seq_plano_espec_w
	from	pls_guia_plano
	where	cd_guia	= cd_guia_referencia_w;
	
	/*Obter se existe material especial*/

	select	count(*)
	into STRICT	qt_autorizacao_espec_w
	from	pls_solic_lib_mat_med	a,
		pls_guia_plano		b
	where	a.nr_seq_guia	= b.nr_sequencia
	and	b.nr_sequencia	= nr_seq_plano_espec_w;

	if (qt_autorizacao_espec_w	> 0) then
		ie_autorizacao_espec_w	:= 'S';
	end if;

	/* Obter a categoria do tipo de acomodacao */
	if (nr_seq_tipo_acomodacao_w IS NOT NULL AND nr_seq_tipo_acomodacao_w::text <> '') then
		select	max(nr_seq_categoria) 
		into STRICT	nr_seq_categoria_w
		from	pls_regra_categoria 
		where	nr_seq_tipo_acomodacao	= nr_seq_tipo_acomodacao_w;
	end if;
	
	begin
	select	nr_sequencia
	into STRICT	nr_seq_tipo_atendimento_w
	from	pls_tipo_atendimento
	where	somente_numero(cd_tiss)	= ie_tipo_atend_tiss_w;
	exception
	when others then
		nr_seq_tipo_atendimento_w	:= null;
	end;

	/*Obter dados do plano*/

	begin
	select	nr_seq_outorgante
	into STRICT	nr_seq_outorgante_w
	from	pls_plano
	where	nr_sequencia	= nr_seq_plano_w;
	exception
		when others then
		nr_seq_outorgante_w	:= 0;
	end;
	
	/*Obter dados do material*/

	select	ie_tipo_despesa,
		nr_sequencia
	into STRICT	ie_tipo_despesa_w,
		nr_seq_material_w
	from	pls_material
	where	cd_material_ops	= cd_material_w;
	
	SELECT * FROM pls_define_preco_material(	cd_estabelecimento_w, nr_seq_prestador_w, dt_solicitacao_w, nr_seq_material_w, 4, ie_tipo_despesa_w, null, 'A', nr_seq_outorgante_w, nr_seq_segurado_w, null, nr_seq_prest_fornec_w, nr_seq_categoria_w, nr_seq_tipo_acomodacao_w, nr_seq_tipo_atendimento_w, nr_seq_clinica_w, ie_tipo_guia_w, ie_autorizacao_espec_w, nr_seq_plano_espec_w, 'S', null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, vl_material_w, dt_ult_vigencia_w, nr_seq_material_preco_w, vl_material_simpro_w, vl_material_brasindice_w, vl_material_tabela_w, dados_regra_preco_material_w, nr_seq_uni_exec_w, ie_regime_atendimento_w, ie_saude_ocupacional_w) INTO STRICT _ora2pg_r;
 vl_material_w := _ora2pg_r.vl_material_p; dt_ult_vigencia_w := _ora2pg_r.dt_ult_vigencia_p; nr_seq_material_preco_w := _ora2pg_r.nr_seq_material_preco_p; vl_material_simpro_w := _ora2pg_r.vl_material_simpro_p; vl_material_brasindice_w := _ora2pg_r.vl_material_brasindice_p; vl_material_tabela_w := _ora2pg_r.vl_material_tabela_p; dados_regra_preco_material_w := _ora2pg_r.dados_regra_preco_material_p;
					
	nr_seq_regra_w	:= dados_regra_preco_material_w.nr_sequencia;
	
	update	ptu_pedido_compl_aut_serv
	set	vl_servico		= vl_material_w
	where	nr_sequencia		= nr_seq_material_p;
elsif (ie_tipo_p	in ('A','AA','AG')) then
	begin
	if (ie_tipo_p = 'A') then
		select	nr_seq_guia,
			nr_seq_material,
			nr_seq_prest_fornec
		into STRICT	nr_seq_guia_w,
			nr_seq_material_w,
			nr_seq_prest_fornec_w
		from	pls_guia_plano_mat
		where	nr_sequencia	= nr_seq_material_p;
	elsif (ie_tipo_p = 'AA') then
		select	a.nr_seq_guia,
			b.nr_seq_material,
			b.nr_seq_prest_fornec
		into STRICT	nr_seq_guia_w,
			nr_seq_material_w,
			nr_seq_prest_fornec_w
		from	pls_auditoria_item	b,
			pls_auditoria		a			
		where	b.nr_sequencia	= nr_seq_material_p
		and	a.nr_sequencia	= b.nr_seq_auditoria;
	elsif (ie_tipo_p = 'AG') then
		select	a.nr_seq_guia,
			b.nr_seq_material
		into STRICT	nr_seq_guia_w,
			nr_seq_material_w
		from	pls_lote_anexo_guias_aut a,
			pls_lote_anexo_mat_aut b
		where	a.nr_sequencia	= b.nr_seq_lote_anexo_guia
		and	b.nr_sequencia	= nr_seq_material_p;	
	end if;	
	exception
	when others then
		nr_seq_guia_w := null;
	end;
	
	if (nr_seq_guia_w IS NOT NULL AND nr_seq_guia_w::text <> '') then
		select	a.cd_estabelecimento,
			a.nr_seq_prestador,
			a.dt_solicitacao,
			a.nr_seq_segurado,
			a.nr_seq_plano,
			a.nr_seq_tipo_acomodacao,
			a.ie_tipo_atend_tiss,
			a.nr_seq_clinica,
			a.ie_tipo_guia,
			a.nr_seq_uni_exec,
			a.ie_regime_atendimento,
			a.ie_saude_ocupacional
		into STRICT	cd_estabelecimento_w,
			nr_seq_prestador_w,
			dt_solicitacao_w,
			nr_seq_segurado_w,
			nr_seq_plano_w,
			nr_seq_tipo_acomodacao_w,
			ie_tipo_atend_tiss_w,
			nr_seq_clinica_w,
			ie_tipo_guia_w,
			nr_seq_uni_exec_w,
			ie_regime_atendimento_w,
			ie_saude_ocupacional_w
		from	pls_guia_plano a
		where	a.nr_sequencia = nr_seq_guia_w;
		
		/*Obter sequencia da autorizacao especial*/

		select	max(nr_sequencia)
		into STRICT	nr_seq_plano_espec_w
		from	pls_guia_plano
		where	cd_guia	= cd_guia_referencia_w;
		/*Obter se existe material especial*/

		select	count(*)
		into STRICT	qt_autorizacao_espec_w
		from	pls_solic_lib_mat_med	a,
			pls_guia_plano		b
		where	a.nr_seq_guia	= b.nr_sequencia
		and	b.nr_sequencia	= nr_seq_plano_espec_w;

		if (qt_autorizacao_espec_w	> 0) then
			ie_autorizacao_espec_w	:= 'S';
		end if;
		
		/* Obter a categoria do tipo de acomodacao */
		if (nr_seq_tipo_acomodacao_w IS NOT NULL AND nr_seq_tipo_acomodacao_w::text <> '') then
			select	max(nr_seq_categoria) 
			into STRICT	nr_seq_categoria_w
			from	pls_regra_categoria 
			where	nr_seq_tipo_acomodacao	= nr_seq_tipo_acomodacao_w;
		end if;
		
		begin
		select	nr_sequencia
		into STRICT	nr_seq_tipo_atendimento_w
		from	pls_tipo_atendimento
		where	somente_numero(cd_tiss)	= ie_tipo_atend_tiss_w;
		exception
		when others then
			nr_seq_tipo_atendimento_w	:= null;
		end;


		begin
		select	nr_seq_outorgante
		into STRICT	nr_seq_outorgante_w
		from	pls_plano
		where	nr_sequencia	= nr_seq_plano_w;
		exception
			when others then
			nr_seq_outorgante_w	:= 0;
		end;

		select	ie_tipo_despesa
		into STRICT	ie_tipo_despesa_w
		from	pls_material
		where	nr_sequencia	= nr_seq_material_w;
		
		SELECT * FROM pls_define_preco_material(	cd_estabelecimento_w, nr_seq_prestador_w, dt_solicitacao_w, nr_seq_material_w, 4, ie_tipo_despesa_w, null, 'A', nr_seq_outorgante_w, nr_seq_segurado_w, null, nr_seq_prest_fornec_w, nr_seq_categoria_w, nr_seq_tipo_acomodacao_w, nr_seq_tipo_atendimento_w, nr_seq_clinica_w, ie_tipo_guia_w, ie_autorizacao_espec_w, nr_seq_plano_espec_w, 'S', null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, vl_material_w, dt_ult_vigencia_w, nr_seq_material_preco_w, vl_material_simpro_w, vl_material_brasindice_w, vl_material_tabela_w, dados_regra_preco_material_w, nr_seq_uni_exec_w, ie_regime_atendimento_w, ie_saude_ocupacional_w) INTO STRICT _ora2pg_r;
 vl_material_w := _ora2pg_r.vl_material_p; dt_ult_vigencia_w := _ora2pg_r.dt_ult_vigencia_p; nr_seq_material_preco_w := _ora2pg_r.nr_seq_material_preco_p; vl_material_simpro_w := _ora2pg_r.vl_material_simpro_p; vl_material_brasindice_w := _ora2pg_r.vl_material_brasindice_p; vl_material_tabela_w := _ora2pg_r.vl_material_tabela_p; dados_regra_preco_material_w := _ora2pg_r.dados_regra_preco_material_p;
						
		nr_seq_regra_w	:= dados_regra_preco_material_w.nr_sequencia;
		if (ie_tipo_p = 'A') then
			update	pls_guia_plano_mat
			set	vl_material	= vl_material_w,
				nr_seq_regra	= nr_seq_regra_w
			where	nr_sequencia	= nr_seq_material_p;
		elsif (ie_tipo_p = 'AA') then
			update	pls_auditoria_item
			set	vl_item		= vl_material_w,
				nr_seq_regra_vl_mat = nr_seq_regra_w
			where	nr_sequencia	= nr_seq_material_p;
		elsif (ie_tipo_p = 'AG') then
			update	pls_lote_anexo_mat_aut
			set	vl_unit_material_solic	= vl_material_w,
				vl_unit_material_aut	= vl_material_w
			where	nr_sequencia	= nr_seq_material_p;
		end if;
	end if;
elsif (ie_tipo_p	in ('R','AR')) then
	
	begin
	if (ie_tipo_p = 'R') then
		select	nr_seq_requisicao,
			nr_seq_material,
			nr_seq_prest_fornec
		into STRICT	nr_seq_requisicao_w,
			nr_seq_material_w,
			nr_seq_prest_fornec_w
		from	pls_requisicao_mat
		where	nr_sequencia	= nr_seq_material_p;
	elsif (ie_tipo_p = 'AR') then
		select	a.nr_seq_requisicao,
			b.nr_seq_material,
			b.nr_seq_prest_fornec,
			b.vl_item
		into STRICT	nr_seq_requisicao_w,
			nr_seq_material_w,
			nr_seq_prest_fornec_w,
			vl_item_w
		from	pls_auditoria_item	b,
			pls_auditoria		a			
		where	b.nr_sequencia	= nr_seq_material_p
		and	a.nr_sequencia	= b.nr_seq_auditoria;
	end if;	
	exception
	when others then
		nr_seq_requisicao_w := null;
	end;

	if (nr_seq_requisicao_w IS NOT NULL AND nr_seq_requisicao_w::text <> '') then
		select	a.cd_estabelecimento,
			a.nr_seq_prestador,
			a.dt_requisicao,
			a.nr_seq_segurado,
			a.nr_seq_plano,
			a.nr_seq_tipo_acomodacao,
			a.ie_tipo_atendimento,
			a.nr_seq_clinica,
			a.ie_tipo_guia,
			a.nr_seq_uni_exec,
			a.ie_regime_atendimento,
			a.ie_saude_ocupacional
		into STRICT	cd_estabelecimento_w,
			nr_seq_prestador_w,
			dt_solicitacao_w,
			nr_seq_segurado_w,
			nr_seq_plano_w,
			nr_seq_tipo_acomodacao_w,
			ie_tipo_atend_tiss_w,
			nr_seq_clinica_w,
			ie_tipo_guia_w,
			nr_seq_uni_exec_w,
			ie_regime_atendimento_w,
			ie_saude_ocupacional_w
		from	pls_requisicao a
		where	a.nr_sequencia = nr_seq_requisicao_w;
		
			/* Obter a categoria do tipo de acomodacao */
		if (nr_seq_tipo_acomodacao_w IS NOT NULL AND nr_seq_tipo_acomodacao_w::text <> '') then
			select	max(nr_seq_categoria) 
			into STRICT	nr_seq_categoria_w
			from	pls_regra_categoria 
			where	nr_seq_tipo_acomodacao	= nr_seq_tipo_acomodacao_w;
		end if;
		
		begin
		select	nr_sequencia
		into STRICT	nr_seq_tipo_atendimento_w
		from	pls_tipo_atendimento
		where	somente_numero(cd_tiss)	= ie_tipo_atend_tiss_w;
		exception
		when others then
			nr_seq_tipo_atendimento_w	:= null;
		end;

		begin
		select	nr_seq_outorgante
		into STRICT	nr_seq_outorgante_w
		from	pls_plano
		where	nr_sequencia	= nr_seq_plano_w;
		exception
			when others then
			nr_seq_outorgante_w	:= 0;
		end;

		select	ie_tipo_despesa
		into STRICT	ie_tipo_despesa_w
		from	pls_material
		where	nr_sequencia	= nr_seq_material_w;

		select	coalesce(max(ie_prestador_preco),'N')
		into STRICT	ie_prestador_preco_w
		from	pls_param_requisicao
		where	cd_estabelecimento = cd_estabelecimento_w;
		
		if (ie_prestador_preco_w = 'S') then
			select	coalesce(nr_seq_prestador_exec, nr_seq_prestador)
			into STRICT	nr_seq_prestador_w
			from	pls_requisicao
			where	nr_sequencia = nr_seq_requisicao_w;
		end if;
		
		SELECT * FROM pls_define_preco_material(	cd_estabelecimento_w, nr_seq_prestador_w, dt_solicitacao_w, nr_seq_material_w, 4, ie_tipo_despesa_w, null, 'A', nr_seq_outorgante_w, nr_seq_segurado_w, null, nr_seq_prest_fornec_w, nr_seq_categoria_w, nr_seq_tipo_acomodacao_w, nr_seq_tipo_atendimento_w, nr_seq_clinica_w, ie_tipo_guia_w, null, null, 'S', null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, vl_material_w, dt_ult_vigencia_w, nr_seq_material_preco_w, vl_material_simpro_w, vl_material_brasindice_w, vl_material_tabela_w, dados_regra_preco_material_w, nr_seq_uni_exec_w, ie_regime_atendimento_w, ie_saude_ocupacional_w) INTO STRICT _ora2pg_r;
 vl_material_w := _ora2pg_r.vl_material_p; dt_ult_vigencia_w := _ora2pg_r.dt_ult_vigencia_p; nr_seq_material_preco_w := _ora2pg_r.nr_seq_material_preco_p; vl_material_simpro_w := _ora2pg_r.vl_material_simpro_p; vl_material_brasindice_w := _ora2pg_r.vl_material_brasindice_p; vl_material_tabela_w := _ora2pg_r.vl_material_tabela_p; dados_regra_preco_material_w := _ora2pg_r.dados_regra_preco_material_p;
						
		nr_seq_regra_w	:= dados_regra_preco_material_w.nr_sequencia;
		if (ie_tipo_p = 'R') then
			update	pls_requisicao_mat
			set	vl_material	= vl_material_w,
				nr_seq_regra	= nr_seq_regra_w
			where	nr_sequencia	= nr_seq_material_p;
		elsif (ie_tipo_p = 'AR') and (coalesce(vl_item_w,0) = 0) then
			update	pls_auditoria_item
			set	vl_item		= vl_material_w,
				nr_seq_regra_vl_mat = nr_seq_regra_w
			where	nr_sequencia	= nr_seq_material_p;
		end if;
	end if;
end if;
			
commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_atualiza_valor_mat_aut ( nr_seq_material_p bigint, ie_tipo_p text, nm_usuario_p text) FROM PUBLIC;

