-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE eup_focuslost_guia_js ( NR_ATENDIMENTO_P bigint, cd_procedencia_p bigint, cd_categoria_p text, cd_plano_convenio_p text, nr_seq_classificacao_p bigint, cd_convenio_p bigint, ie_tipo_atendimento_p bigint, ie_carater_inter_sus_p text, ie_clinica_p bigint, nr_doc_convenio_p text, cd_estabelecimento_p bigint, nm_usuario_p text, NR_DOC_CONV_RET_P INOUT text, IE_EXIGE_CONF_GUIA_P INOUT text, ds_msg_abort_guia_p INOUT text) AS $body$
DECLARE

 
ie_completa_zero_esq_w		varchar(1);
nr_doc_conv_ret_w		varchar(20);
ie_consiste_guia_prescr_w	varchar(3);
ie_exige_conf_guia_w		varchar(1);
ds_consist_dig_w		varchar(3);
ie_permite_cod_conv_duplic_w	varchar(1);
ds_consist_guia_w		varchar(1);
qt_tamanho_w			bigint;


BEGIN 
 
ie_consiste_guia_prescr_w := Obter_param_Usuario(916, 159, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_consiste_guia_prescr_w);
ie_exige_conf_guia_w := Obter_param_Usuario(916, 183, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_exige_conf_guia_w);
ie_completa_zero_esq_w := Obter_param_Usuario(916, 438, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_completa_zero_esq_w);
 
if (nr_doc_convenio_p IS NOT NULL AND nr_doc_convenio_p::text <> '') then 
	 
	if (ie_completa_zero_esq_w = 'S') then 
		select 	length(coalesce(ds_mascara_guia, ltrim(nr_doc_convenio_p))) 
		into STRICT 	qt_tamanho_w 
		from 	convenio 
		where 	cd_convenio = cd_convenio_p;
	 
		select	lpad(ltrim(nr_doc_convenio_p),qt_tamanho_w, 0) 
		into STRICT	nr_doc_conv_ret_w 
		;
		 
		if (nr_doc_conv_ret_w IS NOT NULL AND nr_doc_conv_ret_w::text <> '') then 
			nr_doc_conv_ret_p := nr_doc_conv_ret_w;
		end if;
		 
	end if;
	 
	if (ie_consiste_guia_prescr_w <> 'N') and (ie_exige_conf_guia_w = 'S') then 
		 
		ie_exige_conf_guia_p := substr(obter_se_exige_guia_senha(cd_convenio_p, ie_tipo_atendimento_p, 1, 'G', cd_estabelecimento_p, ie_carater_inter_sus_p, ie_clinica_p, null, null, nr_seq_classificacao_p, null, cd_categoria_p, cd_plano_convenio_p, cd_procedencia_p),1,1);
	end if;
	 
	ds_consist_dig_w := consistir_digito_guia(cd_convenio_p, nr_doc_convenio_p, nr_atendimento_p, ds_consist_dig_w);
	if (ds_consist_dig_w IS NOT NULL AND ds_consist_dig_w::text <> '') and (ds_consist_dig_w = 'N') then 
		ds_msg_abort_guia_p := substr(obter_texto_tasy(88521, wheb_usuario_pck.get_nr_seq_idioma),1,255);
		goto final;
	end if;
	 
	select	coalesce(max(ie_permite_cod_convenio_duplic),'N') 
	into STRICT	ie_permite_cod_conv_duplic_w 
	from 	convenio_estabelecimento               
	where 	cd_convenio = cd_convenio_p               
	and  cd_estabelecimento = cd_estabelecimento_p;
	 
	if (ie_permite_cod_conv_duplic_w = 'S') then 
		ds_consist_guia_w := Consistir_Guia_duplic_paciente(cd_convenio_p, nr_doc_convenio_p, nr_atendimento_p, ds_consist_guia_w);
		if (ds_consist_guia_w = 'N') then 
			ds_msg_abort_guia_p := substr(obter_texto_tasy(88526, wheb_usuario_pck.get_nr_seq_idioma),1,255);
			goto final;
		end if;
		 
	end if;
end if;
 
<<final>> 
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eup_focuslost_guia_js ( NR_ATENDIMENTO_P bigint, cd_procedencia_p bigint, cd_categoria_p text, cd_plano_convenio_p text, nr_seq_classificacao_p bigint, cd_convenio_p bigint, ie_tipo_atendimento_p bigint, ie_carater_inter_sus_p text, ie_clinica_p bigint, nr_doc_convenio_p text, cd_estabelecimento_p bigint, nm_usuario_p text, NR_DOC_CONV_RET_P INOUT text, IE_EXIGE_CONF_GUIA_P INOUT text, ds_msg_abort_guia_p INOUT text) FROM PUBLIC;

