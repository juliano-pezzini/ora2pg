-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE sus_substituir_apac_unif ( nr_interno_conta_p bigint, nr_apac_nova_p bigint, nm_usuario_p text, ie_consiste_apac_p text) AS $body$
DECLARE



nr_apac_antiga_w		bigint;
nr_seq_apac_antiga_w	bigint;
nr_apac_nova_w		bigint;
nr_seq_apac_nova_w	bigint;
nr_interno_conta_w		bigint;
ie_digito_apac_w		varchar(1);
qt_registro_w		bigint;
qt_registro_total_w		bigint;
ds_erro_w		varchar(255);
qt_reg_controle_w		bigint	:= 0;
nr_seq_interno_w	sus_laudo_paciente.nr_seq_interno%type;
nr_atendimento_w	atendimento_paciente.nr_atendimento%type;


BEGIN

nr_apac_nova_w	:= substr(nr_apac_nova_p,1,13);

/* consiste digito nova APAC */

if (ie_consiste_apac_p	= 'S') then
	begin
	
	ie_digito_apac_w := consistir_digito('AIH',to_char(nr_apac_nova_w));
	
	if (ie_digito_apac_w	= 'N') then
		CALL wheb_mensagem_pck.exibir_mensagem_abort(263601);
	end if;	
	end;
end if;

/* busca dados da APAC antiga */

select	coalesce(max(nr_apac),null),
	coalesce(max(nr_sequencia),null),
	coalesce(max(nr_atendimento),null)
into STRICT	nr_apac_antiga_w,
	nr_seq_apac_antiga_w,
	nr_atendimento_w
from 	sus_apac_unif
where 	nr_interno_conta	= nr_interno_conta_p;

if (coalesce(nr_apac_antiga_w::text, '') = '') then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(263602);
end if;

/* Verificar se nova APAC ja existe, senao criar a mesma */

select	coalesce(max(nr_sequencia),null),
	coalesce(max(nr_interno_conta),null)
into STRICT	nr_seq_apac_nova_w,
	nr_interno_conta_w
from	sus_apac_unif
where	nr_apac		= nr_apac_nova_w
and	nr_sequencia	= nr_seq_apac_antiga_w;

if (nr_interno_conta_w IS NOT NULL AND nr_interno_conta_w::text <> '') and (nr_interno_conta_w <> nr_interno_conta_p) then
	--r.aise_application_error(-20011,'Nova APAC esta vinculada a outra conta ');
	CALL wheb_mensagem_pck.exibir_mensagem_abort(263603);
end if;

/* Criar nova APAC */

if (coalesce(nr_seq_apac_nova_w::text, '') = '') then

	begin
	select 	nextval('sus_apac_unif_seq')
	into STRICT	nr_seq_apac_nova_w
	;

	insert into sus_apac_unif(
		nr_sequencia, nr_apac, cd_estabelecimento, nr_atendimento, cd_procedimento, ie_origem_proced, dt_competencia, dt_inicio_validade,
		dt_fim_validade,  dt_emissao, dt_atualizacao, nm_usuario, dt_atualizacao_nrec, nm_usuario_nrec, ie_tipo_apac, cd_motivo_cobranca,
		cd_medico_responsavel, dt_solicitacao, cd_medico_autorizador, dt_autorizacao, cd_carater_internacao, nr_apac_anterior, dt_ocorrencia,
		cd_cid_principal, cd_cid_secundario, cd_cid_causa_assoc, nr_interno_conta, dt_inicio_tratamento, dt_diagnostico, cd_cid_topografia,
		cd_cid_primeiro_trat, cd_cid_segundo_trat, cd_cid_terceiro_trat, dt_pri_tratamento, dt_seg_tratamento, dt_ter_tratamento, ie_linfonodos_reg_inv,
		cd_estadio,  cd_grau_histopat, dt_diag_cito_hist, ie_tratamento_ant, ie_finalidade, cd_cid_pri_radiacao, cd_cid_seg_radiacao, cd_cid_ter_radiacao,
		nr_campos_pri_radi, nr_campos_seg_radi, nr_campos_ter_radi, dt_inicio_pri_radi, dt_inicio_seg_radi, dt_inicio_ter_radi, dt_fim_pri_radi,
		dt_fim_seg_radi, dt_fim_ter_radi, ds_sigla_esquema, qt_meses_planejados, qt_meses_autorizados, dt_pri_dialise, qt_altura_cm, qt_peso,
		qt_diurese, qt_glicose, pr_albumina, pr_hb, ie_acesso_vascular, ie_hiv, ie_hcv, ie_hb_sangue, ie_ultra_abdomen, ie_continuidade_trat, qt_interv_fistola,
		ie_inscrito_cncdo, nr_tru, ie_transplantado, qt_transplante, ie_gestante, cd_proc_aih1, cd_proc_aih2, cd_proc_aih3, nr_aih1, nr_aih2, dt_cirurgia1,
		dt_cirurgia2, nr_meses_acomp, dt_acompanhamento, qt_pont_barros, nr_tabela_barros,  nr_seq_pri_trat,nr_seq_seg_trat,
		nr_seq_ter_trat,nr_seq_mot_apac_obt,ds_justificativa,qt_ureia_pre_hemo,qt_ureia_pos_hemo,dt_inicio_dialise_cli,ie_caract_tratamento,
		ie_acesso_vasc_dial,ie_acomp_nefrol,ie_situacao_usu_ini,ie_situacao_trasp,ie_dados_apto,qt_fosforo,qt_ktv_semanal,qt_pth,ie_inter_clinica,
		ie_peritonite_diag,ie_encaminhado_fav,ie_encam_imp_cateter,ie_situacao_vacina,ie_anti_hbs,ie_influenza,ie_difteria_tetano,ie_pneumococica,
		ie_ieca,ie_bra,ie_duplex_previo,ie_cateter_outros,ie_fav_previas,ie_flebites,ie_hematomas,ie_veia_visivel,ie_presenca_pulso,qt_diametro_veia,
		qt_diametro_arteria,ie_fremito_traj_fav,ie_pulso_fremito,
		--novos campos
		qt_icm_atual_pac, pr_exces_peso_perd, qt_kilogr_perdido, ie_gastrec_desv_duode, ie_gastrec_vert_manga, ie_gastrec_deri_intes, ie_gastrec_vert_banda,
		dt_cirur_bariatrica, nr_aih_bariatrica, ie_comorbidades, ie_cid_i10, ie_cid_o243, ie_cid_e780, ie_cid_m190, ie_cid_g473, cd_cid_outro_comor,
		ie_reconst_microcir, qt_reconst_microcir, ie_dermo_abdominal, qt_dermo_abdominal, ie_mamoplastia, qt_mamoplastia, ie_dermo_braquial, qt_dermo_braquial,
		ie_dermo_crural, qt_dermo_crural, qt_meses_acompanha, qt_anos_acompanha, ie_uso_medicamento, ie_uso_polivitaminico, ie_pratica_ativ_fisica,
		ie_reganho_peso, ie_ades_alim_saud, dt_pri_avaliacao, qt_imc_pri_avaliacao, dt_avaliacao_atual, ie_perda_peso_pre_op, ie_aval_nutricionista,
		ie_aval_psicologo, ie_aval_med_clinico, ie_aval_med_psiquiatr, ie_aval_endocrino, ie_aval_cirur_digesti, ie_aval_cirur_geral, ie_grupo_multiprofis,
		ie_aval_risco_cirurg, ie_real_exam_laborat, ie_esofagogastroduo, ie_ultr_abdomen_tot, ie_ecocardio_transt, ie_ultras_doppl_col, ie_prova_pulmon_bro,
		ie_apto_proc_cirurg,  cd_medic_antineo_1,cd_medic_antineo_2,cd_medic_antineo_3,cd_medic_antineo_4,cd_medic_antineo_5,
                cd_medic_antineo_6,cd_medic_antineo_7,cd_medic_antineo_8,cd_medic_antineo_9,cd_medic_antineo_10)
	SELECT	nr_seq_apac_nova_w, nr_apac_nova_w, cd_estabelecimento, nr_atendimento, cd_procedimento, ie_origem_proced, dt_competencia, dt_inicio_validade,
		dt_fim_validade,  dt_emissao, clock_timestamp(), nm_usuario_p, clock_timestamp(), nm_usuario_p, ie_tipo_apac, cd_motivo_cobranca,
		cd_medico_responsavel, dt_solicitacao, cd_medico_autorizador, dt_autorizacao, cd_carater_internacao, nr_apac_anterior, dt_ocorrencia,
		cd_cid_principal, cd_cid_secundario, cd_cid_causa_assoc, nr_interno_conta, dt_inicio_tratamento, dt_diagnostico, cd_cid_topografia,
		cd_cid_primeiro_trat, cd_cid_segundo_trat, cd_cid_terceiro_trat, dt_pri_tratamento, dt_seg_tratamento, dt_ter_tratamento, ie_linfonodos_reg_inv,
		cd_estadio,  cd_grau_histopat, dt_diag_cito_hist, ie_tratamento_ant, ie_finalidade, cd_cid_pri_radiacao, cd_cid_seg_radiacao, cd_cid_ter_radiacao,
		nr_campos_pri_radi, nr_campos_seg_radi, nr_campos_ter_radi, dt_inicio_pri_radi, dt_inicio_seg_radi, dt_inicio_ter_radi, dt_fim_pri_radi,
		dt_fim_seg_radi, dt_fim_ter_radi, ds_sigla_esquema, qt_meses_planejados, qt_meses_autorizados, dt_pri_dialise, qt_altura_cm, qt_peso,
		qt_diurese, qt_glicose, pr_albumina, pr_hb, ie_acesso_vascular, ie_hiv, ie_hcv, ie_hb_sangue, ie_ultra_abdomen, ie_continuidade_trat, qt_interv_fistola,
		ie_inscrito_cncdo, nr_tru, ie_transplantado, qt_transplante, ie_gestante, cd_proc_aih1, cd_proc_aih2, cd_proc_aih3, nr_aih1, nr_aih2, dt_cirurgia1,
		dt_cirurgia2, nr_meses_acomp, dt_acompanhamento, qt_pont_barros, nr_tabela_barros,  nr_seq_pri_trat,nr_seq_seg_trat,
		nr_seq_ter_trat,nr_seq_mot_apac_obt,ds_justificativa,qt_ureia_pre_hemo,qt_ureia_pos_hemo,dt_inicio_dialise_cli,ie_caract_tratamento,
		ie_acesso_vasc_dial,ie_acomp_nefrol,ie_situacao_usu_ini,ie_situacao_trasp,ie_dados_apto,qt_fosforo,qt_ktv_semanal,qt_pth,ie_inter_clinica,
		ie_peritonite_diag,ie_encaminhado_fav,ie_encam_imp_cateter,ie_situacao_vacina,ie_anti_hbs,ie_influenza,ie_difteria_tetano,ie_pneumococica,
		ie_ieca,ie_bra,ie_duplex_previo,ie_cateter_outros,ie_fav_previas,ie_flebites,ie_hematomas,ie_veia_visivel,ie_presenca_pulso,qt_diametro_veia,
		qt_diametro_arteria,ie_fremito_traj_fav,ie_pulso_fremito,
		--novos campos
		qt_icm_atual_pac, pr_exces_peso_perd, qt_kilogr_perdido, ie_gastrec_desv_duode, ie_gastrec_vert_manga, ie_gastrec_deri_intes, ie_gastrec_vert_banda,
		dt_cirur_bariatrica, nr_aih_bariatrica, ie_comorbidades, ie_cid_i10, ie_cid_o243, ie_cid_e780, ie_cid_m190, ie_cid_g473, cd_cid_outro_comor,
		ie_reconst_microcir, qt_reconst_microcir, ie_dermo_abdominal, qt_dermo_abdominal, ie_mamoplastia, qt_mamoplastia, ie_dermo_braquial, qt_dermo_braquial,
		ie_dermo_crural, qt_dermo_crural, qt_meses_acompanha, qt_anos_acompanha, ie_uso_medicamento, ie_uso_polivitaminico, ie_pratica_ativ_fisica, 
		ie_reganho_peso, ie_ades_alim_saud, dt_pri_avaliacao, qt_imc_pri_avaliacao, dt_avaliacao_atual, ie_perda_peso_pre_op, ie_aval_nutricionista,
		ie_aval_psicologo, ie_aval_med_clinico, ie_aval_med_psiquiatr, ie_aval_endocrino, ie_aval_cirur_digesti, ie_aval_cirur_geral, ie_grupo_multiprofis,
		ie_aval_risco_cirurg, ie_real_exam_laborat, ie_esofagogastroduo, ie_ultr_abdomen_tot, ie_ecocardio_transt, ie_ultras_doppl_col, ie_prova_pulmon_bro,
		ie_apto_proc_cirurg,  cd_medic_antineo_1,cd_medic_antineo_2,cd_medic_antineo_3,cd_medic_antineo_4,cd_medic_antineo_5,
                cd_medic_antineo_6,cd_medic_antineo_7,cd_medic_antineo_8,cd_medic_antineo_9,cd_medic_antineo_10	
	from	sus_apac_unif
	where	nr_apac		= nr_apac_antiga_w
	and	nr_sequencia	= nr_seq_apac_antiga_w;
	exception
		when others then
			--r.aise_application_error(-20011,'Ocorreu um erro ao criar nova APAC');
			CALL wheb_mensagem_pck.exibir_mensagem_abort(263606);
	end;

end if;

/*Inicio do processo de alteracao nas tabelas que possuem o numero antigo */

begin
update	sus_apac_proc_adicional
set	nr_apac	= nr_apac_nova_w
where	nr_apac = nr_apac_antiga_w;
exception
when others then
	--r.aise_application_error(-20011,'Ocorreu um problema ao substituir a APAC na tabela SUS_APAC_PROC_ADICIONAL');
	CALL wheb_mensagem_pck.exibir_mensagem_abort(263608);
end;

begin
update	sus_apac_quimio
set	nr_apac	= nr_apac_nova_w
where	nr_apac = nr_apac_antiga_w;
exception
when others then
	--r.aise_application_error(-20011,'Ocorreu um problema ao substituir a APAC na tabela SUS_APAC_QUIMIO');
	CALL wheb_mensagem_pck.exibir_mensagem_abort(263609);
end;

begin
update	sus_apac_af
set	nr_apac	= nr_apac_nova_w
where	nr_apac = nr_apac_antiga_w;
exception
when others then
	--r.aise_application_error(-20011,'Ocorreu um problema ao substituir a APAC na tabela SUS_APAC_AF');
	CALL wheb_mensagem_pck.exibir_mensagem_abort(263610);
end;

begin
update	sus_apac_trs
set	nr_apac	= nr_apac_nova_w
where	nr_apac = nr_apac_antiga_w;
exception
when others then
	--r.aise_application_error(-20011,'Ocorreu um problema ao substituir a APAC na tabela SUS_APAC_TRS');
	CALL wheb_mensagem_pck.exibir_mensagem_abort(263611);
end;

begin
update	sus_apac_radio
set	nr_apac	= nr_apac_nova_w
where	nr_apac = nr_apac_antiga_w;
exception
when others then
	--r.aise_application_error(-20011,'Ocorreu um problema ao substituir a APAC na tabela SUS_APAC_RADIO');
	CALL wheb_mensagem_pck.exibir_mensagem_abort(263612);
end;

begin
update	sus_apac_movto
set	nr_apac	= nr_apac_nova_w
where	nr_apac = nr_apac_antiga_w;
exception
when others then
	--r.aise_application_error(-20011,'Ocorreu um problema ao substituir a APAC na tabela SUS_APAC_MOVTO');
	CALL wheb_mensagem_pck.exibir_mensagem_abort(263613);
end;

begin
update	sus_laudo_paciente
set	nr_apac	= nr_apac_nova_w
where	nr_apac = nr_apac_antiga_w;
exception
when others then
	--r.aise_application_error(-20011,'Ocorreu um problema ao substituir a APAC na tabela SUS_LAUDO_PACIENTE');
	CALL wheb_mensagem_pck.exibir_mensagem_abort(263614);
end;
/*Termino do processo de alteracao nas tabelas que possuem o numero antigo */



/*  Excluir APAC antiga  */

begin
delete	from sus_apac_unif
where	nr_apac		= nr_apac_antiga_w
and	nr_sequencia	= nr_seq_apac_antiga_w;
exception
	when others then
		ds_erro_w	:= sqlerrm(SQLSTATE);
		/*r.aise_application_error(-20011,'Ocorreu um erro ao excluir APAC antiga ' ||
			chr(10) || ds_erro_w);*/
		CALL wheb_mensagem_pck.exibir_mensagem_abort(263615,'ds_erro_w='||ds_erro_w);
end;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE sus_substituir_apac_unif ( nr_interno_conta_p bigint, nr_apac_nova_p bigint, nm_usuario_p text, ie_consiste_apac_p text) FROM PUBLIC;

