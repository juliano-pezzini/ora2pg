-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_desfazer_analise_recurso ( nr_seq_analise_p pls_analise_conta.nr_sequencia%type, nr_seq_protocolo_p pls_rec_glosa_protocolo.nr_sequencia%type, ie_desf_lote_analise_p text, nm_usuario_p usuario.nm_usuario%type) AS $body$
DECLARE


nr_seq_lote_conta_w		pls_rec_glosa_protocolo.nr_seq_lote_conta%type;
nr_seq_protocolo_w		pls_rec_glosa_protocolo.nr_sequencia%type;
qt_registro_w			integer;
ds_log_call_w			varchar(4000) := '';
ds_log_w				pls_hist_rec_glosa.ds_log%type;

C01 CURSOR FOR
	SELECT	a.nr_seq_analise,
		    a.nr_sequencia
	from	pls_rec_glosa_conta a
	where	a.nr_seq_protocolo = nr_seq_protocolo_p
	and	(a.nr_seq_analise IS NOT NULL AND a.nr_seq_analise::text <> '');
	
C02 CURSOR FOR
	SELECT	nr_sequencia
	from	pls_rec_glosa_conta
	where	nr_seq_analise = nr_seq_analise_p;
			
BEGIN

ds_log_call_w := substr( ' Função ativa : '|| obter_funcao_ativa || chr(13) ||chr(10)||
' CallStack: '|| chr(13) || chr(10)|| dbms_utility.format_call_stack,1,1500);

ds_log_w := 'Desfeita análise do recurso';

if (nr_seq_protocolo_p IS NOT NULL AND nr_seq_protocolo_p::text <> '') then

	for r_C01_w in C01 loop
	
		select	sum(contador)
		into STRICT	qt_registro_w
		from (	SELECT	count(1) contador
			from	pls_auditoria_conta_grupo	a
			where	a.nr_seq_analise	= r_C01_w.nr_seq_analise
			and	(a.dt_inicio_analise IS NOT NULL AND a.dt_inicio_analise::text <> '')
			
union all

			SELECT	count(1) contador
			from	pls_auditoria_conta_grupo	a
			where	a.nr_seq_analise	= r_C01_w.nr_seq_analise
			and	(a.dt_final_analise IS NOT NULL AND a.dt_final_analise::text <> '')
			
union all

			select	count(1) contador
			from	pls_auditoria_conta_grupo	a
			where	a.nr_seq_analise	= r_C01_w.nr_seq_analise
			and	(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
			
union all

			select	count(1) contador
			from	pls_auditoria_conta_grupo	a
			where	a.nr_seq_analise	= r_C01_w.nr_seq_analise
			and	(a.nm_auditor_atual IS NOT NULL AND a.nm_auditor_atual::text <> '')) alias10;
		
		if (qt_registro_w > 0) then
			-- Não é permitido desfazer o envio para análise, pois existe análise iniciada.
			CALL wheb_mensagem_pck.exibir_mensagem_abort(357730);
		end if;
		
		select	count(1)
		into STRICT	qt_registro_w
		from	pls_rec_glosa_conta
		where	nr_seq_protocolo = nr_seq_protocolo_p
		and	(nr_seq_analise IS NOT NULL AND nr_seq_analise::text <> '');
		
		delete	FROM pls_analise_parecer_rec
		where	nr_seq_analise	= r_C01_w.nr_seq_analise;

		delete	FROM pls_tempo_conta_grupo
		where	nr_seq_auditoria	in (SELECT nr_sequencia from pls_auditoria_conta_grupo where nr_seq_analise = r_C01_w.nr_seq_analise);

		delete	FROM pls_auditoria_conta_grupo
		where	nr_seq_analise	= r_C01_w.nr_seq_analise;

		delete	FROM pls_hist_analise_conta
		where	nr_seq_analise	= r_C01_w.nr_seq_analise;

		delete	FROM pls_analise_conta_rec
		where	nr_seq_analise	= r_C01_w.nr_seq_analise;

		delete	FROM pls_analise_conta_item
		where	nr_seq_analise	= r_C01_w.nr_seq_analise;

		delete	FROM pls_analise_log_acesso
		where	nr_seq_analise	= r_C01_w.nr_seq_analise;

		update	pls_rec_glosa_conta
		set	nr_seq_analise	 = NULL
		where	nr_seq_analise	= r_C01_w.nr_seq_analise;

		delete	FROM pls_analise_conta
		where	nr_sequencia	= r_C01_w.nr_seq_analise;
		
		if (coalesce(ie_desf_lote_analise_p,'N') = 'S') or (qt_registro_w = 1) then
			
			select	max(nr_seq_lote_conta)
			into STRICT	nr_seq_lote_conta_w
			from	pls_rec_glosa_protocolo
			where	nr_sequencia = nr_seq_protocolo_p;
			
			update	pls_rec_glosa_protocolo
			set	nr_seq_lote_conta	 = NULL
			where	nr_seq_lote_conta	= nr_seq_lote_conta_w;

			delete	FROM pls_analise_conta_temp
			where	nr_seq_lote_protocolo	= nr_seq_lote_conta_w;

			delete	FROM pls_log_lote_prot_conta
			where	nr_seq_lote_protocolo	= nr_seq_lote_conta_w;

			delete	FROM pls_lote_protocolo_conta
			where	nr_sequencia	= nr_seq_lote_conta_w;
		end if;
		
		insert	into	pls_hist_rec_glosa( 			nr_sequencia, ds_log, dt_atualizacao,
						nm_usuario, ds_call_stack, nr_seq_protocolo,
						nr_seq_conta_rec, nr_seq_mat_rec, nr_seq_proc_rec,
						nr_seq_mot_lib_glosa)
		values (		nextval('pls_hist_rec_glosa_seq'), ds_log_w, clock_timestamp(), 
						nm_usuario_p, ds_log_call_w, nr_seq_protocolo_p,
						r_C01_w.nr_sequencia, null, null,
						null);
		
		
	end loop;
else
	
	select	sum(contador)
	into STRICT	qt_registro_w
	from (	SELECT	count(1) contador
		from	pls_auditoria_conta_grupo	a
		where	a.nr_seq_analise	= nr_seq_analise_p
		and	(a.dt_inicio_analise IS NOT NULL AND a.dt_inicio_analise::text <> '')
		
union all

		SELECT	count(1) contador
		from	pls_auditoria_conta_grupo	a
		where	a.nr_seq_analise	= nr_seq_analise_p
		and	(a.dt_final_analise IS NOT NULL AND a.dt_final_analise::text <> '')
		
union all

		select	count(1) contador
		from	pls_auditoria_conta_grupo	a
		where	a.nr_seq_analise	= nr_seq_analise_p
		and	(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
		
union all

		select	count(1) contador
		from	pls_auditoria_conta_grupo	a
		where	a.nr_seq_analise	= nr_seq_analise_p
		and	(a.nm_auditor_atual IS NOT NULL AND a.nm_auditor_atual::text <> '')) alias9;

	if (qt_registro_w > 0) then
		-- Não é permitido desfazer o envio para análise, pois existe análise iniciada.
		CALL wheb_mensagem_pck.exibir_mensagem_abort(357730);
	end if;

	select	max(p.nr_seq_lote_conta),
		max(p.nr_sequencia)
	into STRICT	nr_seq_lote_conta_w,
		nr_seq_protocolo_w
	from	pls_rec_glosa_protocolo	p,
		pls_rec_glosa_conta	a
	where	p.nr_sequencia		= a.nr_seq_protocolo
	and	a.nr_seq_analise	= nr_seq_analise_p;

	select	count(1)
	into STRICT	qt_registro_w
	from	pls_rec_glosa_conta
	where	nr_seq_protocolo	= nr_seq_protocolo_w
	and	(nr_seq_analise IS NOT NULL AND nr_seq_analise::text <> '');

	delete	FROM pls_analise_parecer_rec
	where	nr_seq_analise	= nr_seq_analise_p;

	delete	FROM pls_tempo_conta_grupo
	where	nr_seq_auditoria	in (SELECT nr_sequencia from pls_auditoria_conta_grupo where nr_seq_analise = nr_seq_analise_p);

	delete	FROM pls_auditoria_conta_grupo
	where	nr_seq_analise	= nr_seq_analise_p;

	delete	FROM pls_hist_analise_conta
	where	nr_seq_analise	= nr_seq_analise_p;

	delete	FROM pls_analise_conta_rec
	where	nr_seq_analise	= nr_seq_analise_p;

	delete	FROM pls_analise_conta_item
	where	nr_seq_analise	= nr_seq_analise_p;

	delete	FROM pls_analise_log_acesso
	where	nr_seq_analise	= nr_seq_analise_p;
	
	for r_c02_w in C02 loop
		
		insert	into	pls_hist_rec_glosa( 			nr_sequencia, ds_log, dt_atualizacao,
						nm_usuario, ds_call_stack, nr_seq_protocolo,
						nr_seq_conta_rec, nr_seq_mat_rec, nr_seq_proc_rec,
						nr_seq_mot_lib_glosa)
		values (		nextval('pls_hist_rec_glosa_seq'), ds_log_w, clock_timestamp(), 
						nm_usuario_p, ds_log_call_w, nr_seq_protocolo_p,
						r_C02_w.nr_sequencia, null, null,
						null);
		
	end loop;

	update	pls_rec_glosa_conta
	set	nr_seq_analise	 = NULL
	where	nr_seq_analise	= nr_seq_analise_p;

	delete	FROM pls_analise_conta
	where	nr_sequencia	= nr_seq_analise_p;

	if (coalesce(ie_desf_lote_analise_p,'N') = 'S') or (qt_registro_w = 1) then
		update	pls_rec_glosa_protocolo
		set	nr_seq_lote_conta	 = NULL
		where	nr_seq_lote_conta	= nr_seq_lote_conta_w;

		delete	FROM pls_analise_conta_temp
		where	nr_seq_lote_protocolo	= nr_seq_lote_conta_w;

		delete	FROM pls_log_lote_prot_conta
		where	nr_seq_lote_protocolo	= nr_seq_lote_conta_w;

		delete	FROM pls_lote_protocolo_conta
		where	nr_sequencia	= nr_seq_lote_conta_w;
	end if;
	
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_desfazer_analise_recurso ( nr_seq_analise_p pls_analise_conta.nr_sequencia%type, nr_seq_protocolo_p pls_rec_glosa_protocolo.nr_sequencia%type, ie_desf_lote_analise_p text, nm_usuario_p usuario.nm_usuario%type) FROM PUBLIC;

