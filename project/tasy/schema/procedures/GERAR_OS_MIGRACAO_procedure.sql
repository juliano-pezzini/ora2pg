-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_os_migracao ( nr_seq_os_origem_p bigint, ie_linguagem_p text ) AS $body$
DECLARE


cd_funcao_w			integer;
nr_seq_nec_atualiz_migr_w	bigint;
nr_seq_os_w			bigint;
ds_documentacao_w		varchar(4000);
nr_seq_os_migracao_w		bigint;
nm_form_w			varchar(10);
dt_historico_w			timestamp;
nr_seq_grupo_desenv_w		bigint;
nr_seq_gerencia_w		bigint;
nr_seq_complex_w		bigint;
qt_min_prev_w			bigint;
nm_usuario_doc_w		varchar(15);
ds_cabecalho_dano_w		varchar(255);
ds_documentacao_ww		varchar(4000);
nr_seq_estagio_w		bigint;
nr_seq_classif_w		bigint;
ie_componente_w			varchar(10) := null;
cd_pessoa_solicitante_w		varchar(10) := '4464';
nr_seq_grupo_des_origem_w 	bigint;
nm_usuario_exec_tec_w		varchar(15);
nm_usuario_fila_w		varchar(15);
nm_usuario_exec_fila_w		varchar(15);
ie_os_tecnologia_w		varchar(1);
cd_setor_atendimento_w		integer;
dt_fim_execucao_w		timestamp;
nm_usuario_lider_w		grupo_desenvolvimento.nm_usuario_lider%type;
ds_dano_breve_w			man_ordem_servico.ds_dano_breve%type;
qt_min_prog_w	bigint;
ie_status_func_html5_w	varchar(1);

c01 CURSOR FOR
SELECT	a.nr_sequencia,
	a.cd_funcao,
	a.nr_seq_os,
	a.ds_documentacao,
	a.dt_atualizacao,
	a.nm_usuario_nrec,
	b.nr_seq_grupo_des
from	w_migracao_ordem_servico a,
	man_ordem_servico b
where	coalesce(a.nr_seq_os_migracao::text, '') = ''
and	b.nr_sequencia = a.nr_seq_os
and	a.nr_seq_os = nr_seq_os_origem_p
and	((coalesce(a.ie_tipo_atualizacao,'R') = 'R') or (b.nr_seq_grupo_des in (31,32)))
and	((b.nr_seq_grupo_des in (31,32)) or (obter_situacao_funcao_migracao(a.cd_funcao) <> 'I'))
group by	a.nr_sequencia,
	a.cd_funcao,
	a.nr_seq_os,
	a.ds_documentacao,
	a.dt_atualizacao,
	a.nm_usuario_nrec,
	b.nr_seq_grupo_des
order by	a.cd_funcao,
	a.nr_seq_os;


BEGIN
open c01;
loop
fetch c01 into
	nr_seq_nec_atualiz_migr_w,
	cd_funcao_w,
	nr_seq_os_w,
	ds_documentacao_w,
	dt_historico_w,
	nm_usuario_doc_w,
	nr_seq_grupo_des_origem_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	begin

	cd_pessoa_solicitante_w	:= '';

	nr_seq_gerencia_w	:= obter_gerencia_funcao_2(cd_funcao_w);

	/*aaschlote 30/12/2013 - os 675843*/

	if (cd_funcao_w IS NOT NULL AND cd_funcao_w::text <> '') then
		select	max(b.nm_usuario_lider)
		into STRICT	nm_usuario_lider_w
		from	grupo_desenvolvimento b,
			funcao_grupo_des a
		where	a.nr_seq_grupo	= b.nr_sequencia
		and 	a.cd_funcao	= cd_funcao_w;

		if (nm_usuario_lider_w IS NOT NULL AND nm_usuario_lider_w::text <> '') then
			select	max(cd_pessoa_fisica)
			into STRICT	cd_pessoa_solicitante_w
			from	usuario
			where	nm_usuario = nm_usuario_lider_w;
		end if;

		select	max(ie_status)
		into STRICT	ie_status_func_html5_w
		from	funcoes_html5
		where 	cd_funcao = cd_funcao_w;
	end if;

	if (coalesce(cd_pessoa_solicitante_w::text, '') = '') then
		cd_pessoa_solicitante_w	:= obter_responsavel_gerencia(nr_seq_gerencia_w);
	end if;

	nr_seq_grupo_desenv_w	:= null;

	select	max(ds_form)
	into STRICT	nm_form_w
	from	funcao
	where	cd_funcao = cd_funcao_w;

	select 	max(cd_setor_atendimento)
	into STRICT	cd_setor_atendimento_w
	from 	usuario
	where	nm_usuario	= nm_usuario_doc_w;

	if (cd_setor_atendimento_w = 7) then
		nr_seq_grupo_des_origem_w	:= 31;
	end if;

	if (nr_seq_gerencia_w = 2) or (nr_seq_grupo_des_origem_w in (31,32)) then
		begin
		ie_os_tecnologia_w := 'S';

		--  se gerência tecnologia  --->
		if (nr_seq_grupo_des_origem_w = 31) then -- delphi
			begin
			nr_seq_grupo_desenv_w := 32; -- java
			end;
		else
			begin
			nr_seq_grupo_desenv_w := 31; -- delphi
			end;
		end if;

		cd_pessoa_solicitante_w	:= 4464;
		nr_seq_estagio_w 	:= 131; -- estágio tecnologia
		nr_seq_classif_w 	:= 23; -- classificação: alteração simples de componente
		--retorna o líder do grupo ao qual a os será destinada
		select	max(a.nm_usuario_des)
		into STRICT	nm_usuario_exec_tec_w
		from	usuario_nivel_des a,
			usuario_grupo_des b
		where	b.nr_seq_grupo = nr_seq_grupo_desenv_w
		and	a.nm_usuario_des = b.nm_usuario_grupo
		and	a.nr_seq_nivel = 17;

		--retorna o líder do grupo atual para ser solicitante da os
		/*select	max(obter_pf_usuario(a.nm_usuario_des,'C'))
		into	cd_pessoa_solicitante_w
		from	usuario_nivel_des a,
			usuario_grupo_des b
		where	b.nr_seq_grupo = nr_seq_grupo_des_origem_w
		and	a.nm_usuario_des = b.nm_usuario_grupo
		and	a.nr_seq_nivel = 17;*/
		end;
	else
		begin
		ie_os_tecnologia_w	:= 'N';

		--cd_pessoa_solicitante_w	:= 4464;
		nr_seq_estagio_w 	:= 1191; -- estágio  desenvolvimento aguardando programação.
		if (ie_linguagem_p = 'H') then
			nr_seq_estagio_w 	:= 2143; -- temporariamente, colocado um estágio para ordens de migração de HTML5
		end if;

		nr_seq_classif_w 	:= 58; -- migração tecnológica
		end;
	end if;

	select	max(o.nr_seq_complex),
		max(e.qt_min_prev),
		max(o.ie_componente)
	into STRICT	nr_seq_complex_w,
		qt_min_prev_w,
		ie_componente_w
	from	man_ordem_servico_exec e,
		man_ordem_servico o,
		w_migracao_ordem_servico w
	where	e.nr_seq_ordem = o.nr_sequencia
	--and	e.nm_usuario_exec = w.nm_usuario_nrec
	and	o.nr_sequencia = w.nr_seq_os
	and	w.nr_sequencia = nr_seq_nec_atualiz_migr_w;

	select	nextval('man_ordem_servico_seq')
	into STRICT	nr_seq_os_migracao_w
	;

	if (ie_componente_w IS NOT NULL AND ie_componente_w::text <> '') then
		begin
		ds_cabecalho_dano_w :=	Wheb_mensagem_pck.get_Texto(310346, 'DS_COMPONENTE_W='|| obter_valor_dominio(3520, ie_componente_w)); /*Migração: necessidade de revisão

do componente: #@DS_COMPONENTE_W#@.*/
		end;
	else
		begin
		ds_cabecalho_dano_w :=	WHEB_MENSAGEM_PCK.get_texto(310347,'CD_FUNCAO_W='|| CD_FUNCAO_W ||';DS_FUNCAO_W='|| obter_desc_funcao(cd_funcao_w) ||';NM_FORM_W='||

NM_FORM_W); /*Migração: necessidade de revisão dos projetos referentes à função: #@CD_FUNCAO_W#@ - #@DS_FUNCAO_W#@ (#@NM_FORM_W#@).*/
		end;
	end if;

	if (coalesce(length(ds_documentacao_w),0) < 3745) then
		begin
		ds_documentacao_ww := ds_cabecalho_dano_w || ds_documentacao_w;
		end;
	else
		begin
		ds_documentacao_ww := ds_documentacao_w;
		end;
	end if;

	if (ie_linguagem_p = 'H') then
		begin
			ds_dano_breve_w := 'HTML5 - ' || wheb_mensagem_pck.get_texto(310348); -- Migração: necessidade de revisão dos projetos/componentes.
			if (coalesce(ie_status_func_html5_w::text, '') = '') or (ie_status_func_html5_w in ('P', 'Y', 'E')) then
				nr_seq_grupo_desenv_w := 289; -- Grupo 100 - Das ordens a definir (novas funções)
			end if;
		end;
	elsif (ie_linguagem_p = 'J') then
		ds_dano_breve_w := 'Java - ' || wheb_mensagem_pck.get_texto(310348);
	elsif (ie_linguagem_p = 'D') then
		ds_dano_breve_w := 'Delphi - ' || wheb_mensagem_pck.get_texto(310348);
	else
		ds_dano_breve_w := wheb_mensagem_pck.get_texto(310348);
	end if;

	if (cd_pessoa_solicitante_w IS NOT NULL AND cd_pessoa_solicitante_w::text <> '') then
		insert into man_ordem_servico(
			nr_sequencia,
			dt_ordem_servico,
			cd_pessoa_solicitante,
			nr_seq_localizacao,
			nr_seq_equipamento,
			ds_dano_breve,
			ie_prioridade,
			ds_dano,
			cd_funcao,
			nr_seq_grupo_des,
			ie_classificacao,
			ie_tipo_ordem,
			ie_status_ordem,
			dt_inicio_previsto,
			dt_fim_previsto,
			dt_inicio_desejado,
			dt_conclusao_desejada,
			nr_seq_estagio,
			nr_grupo_trabalho,
			nr_grupo_planej,
			nm_usuario,
			dt_atualizacao,
			ie_parado,
			ie_obriga_news,
			ie_exclusiva,
			ie_origem_os,
			nr_seq_origem,
			nr_seq_classif,
			nr_seq_nivel_valor,
			nr_seq_complex,
			ie_componente,
			ie_atualizacao_migracao,
			ie_resp_teste,
			ie_plataforma)
		values (	nr_seq_os_migracao_w,
			clock_timestamp(),
			cd_pessoa_solicitante_w,
			1272,
			41,
			ds_dano_breve_w,
			'A',
			ds_documentacao_ww,
			cd_funcao_w,
			nr_seq_grupo_desenv_w,
			'S',
			4,
			'2',
			clock_timestamp(),
			clock_timestamp() + interval '7 days',
			clock_timestamp(),
			clock_timestamp() + interval '7 days',
			nr_seq_estagio_w,
			2,
			1,
			'Tasy',
			clock_timestamp(),
			'N',
			'N',
			'P',
			'1',
			nr_seq_os_w,
			nr_seq_classif_w,
			1,
			nr_seq_complex_w,
			ie_componente_w,
			'R',
			'A',
			CASE WHEN ie_linguagem_p='J' THEN 'S' WHEN ie_linguagem_p='H' THEN 'H' WHEN ie_linguagem_p='D' THEN 'D' END );

		update	man_ordem_servico
		set	ie_atualizacao_migracao = 'N',
			ds_just_migr_neg = obter_desc_expressao(790594, 'Necessidade de revisão dos projetos/componentes(Ordem de serviço de migração).'),
			ie_obriga_news = 'N',
			ds_just_ret_news = obter_desc_expressao(790594, 'Necessidade de revisão dos projetos/componentes(Ordem de serviço de migração).')
		where	nr_sequencia = nr_seq_os_origem_p;


		update	w_migracao_ordem_servico
		set	nr_seq_os_migracao = nr_seq_os_migracao_w
		where	nr_sequencia = nr_seq_nec_atualiz_migr_w;

		if (ie_linguagem_p = 'H') and ((coalesce(ie_status_func_html5_w::text, '') = '') or (ie_status_func_html5_w in ('P', 'Y', 'E'))) then
			select	sum(qt_minuto)
			into STRICT	qt_min_prog_w
			from	man_ordem_serv_ativ
			where	nr_seq_funcao in (11, 1288, 551)--Programação, Programação Java
			and		nr_seq_ordem_serv = nr_seq_os_origem_p;

			insert into man_ordem_servico_exec(
				nr_sequencia,
				nr_seq_ordem,
				dt_atualizacao,
				nm_usuario,
				nm_usuario_exec,
				qt_min_prev,
				dt_ult_visao,
				nr_seq_funcao,
				dt_recebimento,
				nr_seq_tipo_exec,
				dt_fim_execucao)
			values (	nextval('man_ordem_servico_exec_seq'),
				nr_seq_os_migracao_w,
				clock_timestamp(),
				'Tasy',
				'fbneuwald',
				qt_min_prog_w,
				null,
				null,
				null,
				1,
				null);
		elsif (nr_seq_gerencia_w = 2) or (nr_seq_grupo_des_origem_w in (31,32)) then
			begin
			insert into man_ordem_servico_exec(
				nr_sequencia,
				nr_seq_ordem,
				dt_atualizacao,
				nm_usuario,
				nm_usuario_exec,
				qt_min_prev,
				dt_ult_visao,
				nr_seq_funcao,
				dt_recebimento,
				nr_seq_tipo_exec,
				dt_fim_execucao)
			values (	nextval('man_ordem_servico_exec_seq'),
				nr_seq_os_migracao_w,
				clock_timestamp(),
				'Tasy',
				nm_usuario_exec_tec_w,
				null,
				null,
				null,
				null,
				1,
				null);
			end;
		/*else      Não será mais vinculadas as OS's de migração ao Projeto - OS1676232
			begin
			vinc_os_nec_atlz_migr_proj_rev(nr_seq_os_migracao_w, cd_funcao_w, qt_min_prev_w, 'Tasy');
			end;*/
		end if;

		/*colocar  os na fila */

		--if	(nr_seq_gerencia_w in (4,60)) then
		  if (1 = 2) then
			begin
			select	coalesce(max(nm_usuario_fila),'X')
			into STRICT	nm_usuario_fila_w
			from	cadastro_fila
			where	nr_seq_gerencia = nr_seq_gerencia_w
			and	coalesce(ie_tipo_fila,'PR') = 'PR'
			and	ie_situacao = 'A';

			if (nm_usuario_fila_w <> 'X') then
				begin
				nm_usuario_exec_fila_w	:=	'X';

				if (nr_seq_gerencia_w = 60) then
					select 	coalesce(max(nm_usuario_doc_w),'X')
					into STRICT	nm_usuario_exec_fila_w
					from	skill_desenv_usuario x
					where	x.nm_usuario_des = nm_usuario_doc_w
					and	x.nr_seq_skill = 1;
				end if;

				if (nm_usuario_exec_fila_w <> 'X') then
					dt_fim_execucao_w	:= clock_timestamp();
				else
					dt_fim_execucao_w	:= null;
				end if;

				insert into man_ordem_servico_exec(
					nr_sequencia,
					nr_seq_ordem,
					dt_atualizacao,
					nm_usuario,
					dt_atualizacao_nrec,
					nm_usuario_nrec,
					nm_usuario_exec,
					qt_min_prev,
					nr_seq_tipo_exec,
					dt_fim_execucao)
				values (	nextval('man_ordem_servico_exec_seq'),
					nr_seq_os_migracao_w,
					clock_timestamp(),
					'Tasy',
					clock_timestamp(),
					'RevJava',
					nm_usuario_fila_w,
					60,
					1,
					dt_fim_execucao_w);

				insert into man_ordem_ativ_prev(
					nr_sequencia,
					nr_seq_ordem_serv,
					dt_atualizacao,
					nm_usuario,
					dt_atualizacao_nrec,
					nm_usuario_nrec,
					dt_prevista,
					qt_min_prev,
					nr_seq_ativ_exec,
					nm_usuario_prev,
					ie_prioridade_desen)
				values (	nextval('man_ordem_ativ_prev_seq'),
					nr_seq_os_migracao_w,
					clock_timestamp(),
					nm_usuario_fila_w,
					clock_timestamp(),
					nm_usuario_fila_w,
					null,
					60,
					91,
					nm_usuario_fila_w,
					1);

				if (nm_usuario_exec_fila_w <> 'X') then
					begin
					insert into man_ordem_servico_exec(
						nr_sequencia,
						nr_seq_ordem,
						dt_atualizacao,
						nm_usuario,
						dt_atualizacao_nrec,
						nm_usuario_nrec,
						nm_usuario_exec,
						qt_min_prev,
						nr_seq_tipo_exec)
					values (	nextval('man_ordem_servico_exec_seq'),
						nr_seq_os_migracao_w,
						clock_timestamp(),
						'Tasy',
						clock_timestamp(),
						'RevJava',
						nm_usuario_exec_fila_w,
						60,
						1);

					insert into man_ordem_ativ_prev(
						nr_sequencia,
						nr_seq_ordem_serv,
						dt_atualizacao,
						nm_usuario,
						dt_atualizacao_nrec,
						nm_usuario_nrec,
						dt_prevista,
						qt_min_prev,
						nr_seq_ativ_exec,
						nm_usuario_prev,
						ie_prioridade_desen)
					values (	nextval('man_ordem_ativ_prev_seq'),
						nr_seq_os_migracao_w,
						clock_timestamp(),
						nm_usuario_fila_w,
						clock_timestamp(),
						nm_usuario_fila_w,
						trunc(clock_timestamp(),'dd'),
						60,
						91,
						nm_usuario_exec_fila_w,
						1);



					end;
				end if;

				insert into man_ordem_serv_skill(
					nr_sequencia,
					nr_seq_ordem_serv,
					nr_seq_skill,
					dt_atualizacao,
					nm_usuario,
					dt_atualizacao_nrec,
					nm_usuario_nrec)
				values (	nextval('man_ordem_serv_skill_seq'),
					nr_seq_os_migracao_w,
					1,
					clock_timestamp(),
					nm_usuario_fila_w,
					clock_timestamp(),
					nm_usuario_fila_w);

				update	man_ordem_servico
				set	dt_atualizacao	= clock_timestamp(),
					nm_usuario	= nm_usuario_fila_w,
					nr_seq_estagio	= 1191,
					ie_status_ordem	= 2
				where	nr_sequencia	= nr_seq_os_migracao_w;
				end;
			end if;
			exception when others then
				null;
			end;
		end if;
	end if;
	exception
	when others then
		CALL wheb_mensagem_pck.exibir_mensagem_abort(121272,'NR_SEQ_OS='||nr_seq_os_w);
	end;
end loop;
close c01;
commit;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_os_migracao ( nr_seq_os_origem_p bigint, ie_linguagem_p text ) FROM PUBLIC;

