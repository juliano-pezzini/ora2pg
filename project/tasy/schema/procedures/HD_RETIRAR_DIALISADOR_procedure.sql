-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE hd_retirar_dialisador ( nr_seq_dialise_dialisador_p bigint, nr_seq_dialisador_p bigint, dt_retirada_p timestamp, nm_usuario_p text, ds_motivo_subst_p text, ds_erro_p INOUT text, ds_retorno_p INOUT text, ie_assinar_p text default 'S') AS $body$
DECLARE

 
qt_reuso_w			smallint;
qt_reuso_max_w			bigint;
ie_tipo_w			varchar(1);
nr_seq_dialise_w		hd_dialise.nr_sequencia%type;
	

BEGIN 
 
if (coalesce(nr_seq_dialisador_p,0) > 0) then 
	select 	max(nr_seq_dialise) 
	into STRICT	nr_seq_dialise_w 
	from	hd_dialise_dialisador 
	where 	nr_sequencia      	= nr_seq_dialise_dialisador_p;
	 
	/* Atualizar dados do dialisador na dialise */
 
	update 	hd_dialise_dialisador 
	set  	dt_retirada      	= dt_retirada_p, 
		cd_pf_retirada     	= substr(obter_pessoa_fisica_usuario(nm_usuario_p,'C'),1,10), 
		ds_motivo_subst		= ds_motivo_subst_p	 
	where 	nr_sequencia      	= nr_seq_dialise_dialisador_p;
 
	/* Atualizar status do dialisador */
 
	update	hd_dializador 
	set  	ie_status       	= 'P' 
	where 	nr_sequencia		= nr_seq_dialisador_p;
 
	/* Verifica se chegou ao reuso máximo, neste caso o dialisador será descartado de forma automática */
 
	select	max(qt_reuso), 
		max(nr_max_reuso), 
		max(ie_tipo) 
	into STRICT	qt_reuso_w, 
		qt_reuso_max_w, 
		ie_tipo_w	 
	from	hd_dializador 
	where	nr_sequencia		= nr_seq_dialisador_p;	
 
	if (ie_tipo_w = 'U') then /* Envia dialisador de único uso para descarte */
 
		CALL HD_Descarte_Dialisador(nr_seq_dialisador_p, 'UU', 'U', nm_usuario_p);		
		ds_retorno_p	:= WHEB_MENSAGEM_PCK.get_texto(281306,null);
	elsif (qt_reuso_w+1 > qt_reuso_max_w) and (qt_reuso_max_w > 0) then /* Envia dialisador com reuso máximo para descarte - SOMENTE PARA DIALISADORES QUE NÃO SÃO DE 1º USO*/
 
		CALL HD_Descarte_Dialisador(nr_seq_dialisador_p, 'RE', 'U', nm_usuario_p);	
		ds_retorno_p	:= WHEB_MENSAGEM_PCK.get_texto(281307,null);
	end if;
 
	if (ie_assinar_p = 'S') then 
		CALL hd_gerar_assinatura(null, null, nr_seq_dialise_w, null, null, null, nr_seq_dialise_dialisador_p, null, null, 'RD', nm_usuario_p, 'N');
	end if;
	 
	commit;
end if;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE hd_retirar_dialisador ( nr_seq_dialise_dialisador_p bigint, nr_seq_dialisador_p bigint, dt_retirada_p timestamp, nm_usuario_p text, ds_motivo_subst_p text, ds_erro_p INOUT text, ds_retorno_p INOUT text, ie_assinar_p text default 'S') FROM PUBLIC;

