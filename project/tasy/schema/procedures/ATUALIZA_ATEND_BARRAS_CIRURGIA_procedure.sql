-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE atualiza_atend_barras_cirurgia ( nr_prescricao_p bigint, cd_material_p bigint, nr_seq_lote_fornec_p bigint, qt_bipada_p bigint, nm_usuario_p text) AS $body$
DECLARE


qt_bipada_w	double precision;
qt_material_w	double precision;
nr_sequencia_w	bigint;
qt_material_ww	double precision;

c01 CURSOR FOR
	SELECT	coalesce(sum(qt_original),0) - coalesce(sum(qt_atendido),0),
		nr_sequencia
	from	prescr_material
	where	nr_prescricao	 	= nr_prescricao_p
	and	cd_material 	 	= cd_material_p
	and	coalesce(qt_atendido,0)	< coalesce(qt_original,0)
	and	coalesce(nr_seq_lote_fornec,coalesce(nr_seq_lote_fornec_p,0)) = coalesce(nr_seq_lote_fornec_p,0)
	and	cd_motivo_baixa = 0
	and	coalesce(dt_baixa::text, '') = ''
	group by cd_kit_material,nr_seq_kit_estoque,cd_material,nr_sequencia
	order by coalesce(cd_kit_material,9999998),coalesce(nr_seq_kit_estoque,9999999),cd_material;


BEGIN

qt_bipada_w := qt_bipada_p;

open C01;
loop
fetch C01
into
	qt_material_w,
	nr_sequencia_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	qt_material_ww := qt_material_w;
	while(qt_bipada_w > 0) loop
		begin
		if (qt_material_ww >= qt_bipada_w) then
			update	prescr_material
			set	qt_atendido 		= coalesce(qt_atendido,0) + qt_bipada_w,
				nr_seq_lote_fornec	= nr_seq_lote_fornec_p
			where	nr_prescricao		= nr_prescricao_p
			and	nr_sequencia 		= nr_sequencia_w;
			commit;
			qt_bipada_w := 0;
		else
			update	prescr_material
			set	qt_atendido 		= qt_material_ww,
				nr_seq_lote_fornec	= nr_seq_lote_fornec_p
			where	nr_prescricao		= nr_prescricao_p
			and	nr_sequencia 		= nr_sequencia_w;
			commit;
			qt_bipada_w := qt_bipada_w - qt_material_ww;
		end if;
		end;
	end loop;
end loop;
close c01;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE atualiza_atend_barras_cirurgia ( nr_prescricao_p bigint, cd_material_p bigint, nr_seq_lote_fornec_p bigint, qt_bipada_p bigint, nm_usuario_p text) FROM PUBLIC;

