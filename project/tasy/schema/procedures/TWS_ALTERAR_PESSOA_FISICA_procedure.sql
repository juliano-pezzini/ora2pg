-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE tws_alterar_pessoa_fisica ( nr_sequencia_p bigint, cd_pessoa_fisica_p bigint, nm_usuario_p text) AS $body$
DECLARE


cd_pessoa_fisica_antigo_w 	varchar(10);
nm_pessoa_fisica_antigo_w 	varchar(255);
nm_pessoa_fisica_novo_w 	varchar(255);
ds_log_w 					varchar(2000);
nr_seq_inclusao_pf_w        bigint;
id_subject_w		wsuite_usuario.id_subject%type;
id_role_w		varchar(255);



BEGIN

--get codigo e nome antigos
select 	max(cd_pessoa_fisica),
		max(obter_nome_pf(cd_pessoa_fisica)),
		max(nr_seq_inclusao_pf),
		max(id_subject)
into STRICT   	cd_pessoa_fisica_antigo_w,
		nm_pessoa_fisica_antigo_w,
		nr_seq_inclusao_pf_w,
		id_subject_w
from 	wsuite_usuario
where 	nr_sequencia = nr_sequencia_p;

-- get nome novo
select 	max(obter_nome_pf(cd_pessoa_fisica_p))
into STRICT 	nm_pessoa_fisica_novo_w
;

-- update para novo codigo
update  wsuite_usuario
set	   	CD_PESSOA_FISICA = CD_PESSOA_FISICA_P,
		nm_usuario = nm_usuario_p,
		dt_atualizacao = clock_timestamp()
where   nr_sequencia = nr_sequencia_p;

update	wsuite_solic_inclusao_pf
set		cd_pessoa_fisica = cd_pessoa_fisica_p,
		dt_atualizacao 	= clock_timestamp(),
		nm_usuario	= nm_usuario_p,
		ie_status	= 2
where	nr_sequencia = nr_seq_inclusao_pf_w;

-- cria express√£o para log
ds_log_w := substr(wheb_mensagem_pck.get_texto(1045811,
	'CD_PESSOA_FISICA_ANTIGO=' 	||	cd_pessoa_fisica_antigo_w || ';' ||
	'CD_PESSOA_FISICA_NOVO=' 	  || 	cd_pessoa_fisica_p || ';' ||
	'NM_PESSOA_FISICA_ANTIGO=' 	||	nm_pessoa_fisica_antigo_w || ';' ||
	'NM_PESSOA_FISICA_NOVO='  	||	nm_pessoa_fisica_novo_w),1,2000);


--Link person with user
if (id_subject_w IS NOT NULL AND id_subject_w::text <> '') then

	select	max(id)
	into STRICT 	id_role_w
	from 	role
	where 	nm_role = 'linkedUser';

	update 	subject_role
	set 	id_role  	= id_role_w
	where 	id_subject	= id_subject_w;

		commit;
end if;

--Generate log
CALL wsuite_save_log( '7', ds_log_w, 'Tasy', nm_usuario_p );


commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE tws_alterar_pessoa_fisica ( nr_sequencia_p bigint, cd_pessoa_fisica_p bigint, nm_usuario_p text) FROM PUBLIC;

