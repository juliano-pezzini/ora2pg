-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_w_cotacao_item ( nr_cot_compra_p bigint) AS $body$
DECLARE



nr_sequencia_w		bigint;
nr_item_cot_compra_w		integer;
cd_material_w			integer;
cd_fornecedor_w		varchar(14);
qt_material_w			double precision;
vl_unitario_material_w	double precision;
cd_fornecedor_1_w		varchar(14);
cd_fornecedor_2_w		varchar(14);
cd_fornecedor_3_w		varchar(14);
cd_fornecedor_4_w		varchar(14);
cd_fornecedor_5_w		varchar(14);
cd_fornecedor_6_w		varchar(14);
cd_fornecedor_7_w		varchar(14);
cd_fornecedor_8_w		varchar(14);
cd_fornecedor_9_w		varchar(14);
cd_fornecedor_10_w		varchar(14);
cd_fornecedor_11_w		varchar(14);
cd_fornecedor_12_w		varchar(14);
cd_fornecedor_13_w		varchar(14);
cd_fornecedor_14_w		varchar(14);
qt_fornecedor_1_w		double precision;
qt_fornecedor_2_w		double precision;
qt_fornecedor_3_w		double precision;
qt_fornecedor_4_w		double precision;
qt_fornecedor_5_w		double precision;
qt_fornecedor_6_w		double precision;
qt_fornecedor_7_w		double precision;
qt_fornecedor_8_w		double precision;
qt_fornecedor_9_w		double precision;
qt_fornecedor_10_w		double precision;
qt_fornecedor_11_w		double precision;
qt_fornecedor_12_w		double precision;
qt_fornecedor_13_w		double precision;
qt_fornecedor_14_w		double precision;
vl_fornecedor_1_w		double precision;
vl_fornecedor_2_w		double precision;
vl_fornecedor_3_w		double precision;
vl_fornecedor_4_w		double precision;
vl_fornecedor_5_w		double precision;
vl_fornecedor_6_w		double precision;
vl_fornecedor_7_w		double precision;
vl_fornecedor_8_w		double precision;
vl_fornecedor_9_w		double precision;
vl_fornecedor_10_w		double precision;
vl_fornecedor_11_w		double precision;
vl_fornecedor_12_w		double precision;
vl_fornecedor_13_w		double precision;
vl_fornecedor_14_w		double precision;

C01 CURSOR FOR
	SELECT	nr_item_cot_compra,
		cd_material
	from	cot_compra_item
	where	nr_cot_compra = nr_cot_compra_p;

C02 CURSOR FOR
	SELECT	coalesce(a.cd_pessoa_fisica, a.cd_cgc_fornecedor),
		b.qt_material,
		b.vl_unitario_material
	from	cot_compra_forn a,
		cot_compra_forn_item b
	where	b.nr_cot_compra = nr_cot_compra_p
	and	b.nr_item_cot_compra = nr_item_cot_compra_w
	and	a.nr_cot_compra = b.nr_cot_compra
	and	a.nr_sequencia = b.nr_seq_cot_forn;

BEGIN

delete from w_cotacao_item_coluna;
delete from w_cotacao_item;
	cd_fornecedor_1_w	:= null;
	cd_fornecedor_2_w	:= null;
	cd_fornecedor_3_w	:= null;
	cd_fornecedor_4_w	:= null;
	cd_fornecedor_5_w	:= null;
	cd_fornecedor_6_w	:= null;
	cd_fornecedor_7_w	:= null;
	cd_fornecedor_8_w	:= null;
	cd_fornecedor_9_w	:= null;
	cd_fornecedor_10_w	:= null;
	cd_fornecedor_11_w	:= null;
	cd_fornecedor_12_w	:= null;
	cd_fornecedor_13_w	:= null;
	cd_fornecedor_14_w	:= null;
	qt_fornecedor_1_w	:= 0;
	qt_fornecedor_2_w	:= 0;
	qt_fornecedor_3_w	:= 0;
	qt_fornecedor_4_w	:= 0;
	qt_fornecedor_5_w	:= 0;
	qt_fornecedor_6_w	:= 0;
	qt_fornecedor_7_w	:= 0;
	qt_fornecedor_8_w	:= 0;
	qt_fornecedor_9_w	:= 0;
	qt_fornecedor_10_w	:= 0;
	qt_fornecedor_11_w	:= 0;
	qt_fornecedor_12_w	:= 0;
	qt_fornecedor_13_w	:= 0;
	qt_fornecedor_14_w	:= 0;
	vl_fornecedor_1_w	:= 0;
	vl_fornecedor_2_w	:= 0;
	vl_fornecedor_3_w	:= 0;
	vl_fornecedor_4_w	:= 0;
	vl_fornecedor_5_w	:= 0;
	vl_fornecedor_6_w	:= 0;
	vl_fornecedor_7_w	:= 0;
	vl_fornecedor_8_w	:= 0;
	vl_fornecedor_9_w	:= 0;
	vl_fornecedor_10_w	:= 0;
	vl_fornecedor_11_w	:= 0;
	vl_fornecedor_12_w	:= 0;
	vl_fornecedor_13_w	:= 0;
	vl_fornecedor_14_w	:= 0;

OPEN C01;
LOOP
	FETCH C01 into
		nr_item_cot_compra_w,
		cd_material_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
	begin
	qt_fornecedor_1_w	:= 0;
	qt_fornecedor_2_w	:= 0;
	qt_fornecedor_3_w	:= 0;
	qt_fornecedor_4_w	:= 0;
	qt_fornecedor_5_w	:= 0;
	qt_fornecedor_6_w	:= 0;
	qt_fornecedor_7_w	:= 0;
	qt_fornecedor_8_w	:= 0;
	qt_fornecedor_9_w	:= 0;
	qt_fornecedor_10_w	:= 0;
	qt_fornecedor_11_w	:= 0;
	qt_fornecedor_12_w	:= 0;
	qt_fornecedor_13_w	:= 0;
	qt_fornecedor_14_w	:= 0;
	vl_fornecedor_1_w	:= 0;
	vl_fornecedor_2_w	:= 0;
	vl_fornecedor_3_w	:= 0;
	vl_fornecedor_4_w	:= 0;
	vl_fornecedor_5_w	:= 0;
	vl_fornecedor_6_w	:= 0;
	vl_fornecedor_7_w	:= 0;
	vl_fornecedor_8_w	:= 0;
	vl_fornecedor_9_w	:= 0;
	vl_fornecedor_10_w	:= 0;
	vl_fornecedor_11_w	:= 0;
	vl_fornecedor_12_w	:= 0;
	vl_fornecedor_13_w	:= 0;
	vl_fornecedor_14_w	:= 0;
	OPEN C02;
	LOOP
		FETCH C02 into
			cd_fornecedor_w,
			qt_material_w,
			vl_unitario_material_w;
		EXIT WHEN NOT FOUND; /* apply on c02 */
		begin

		if (coalesce(cd_fornecedor_1_w::text, '') = '') or (cd_fornecedor_1_w = cd_fornecedor_w) then
			cd_fornecedor_1_w	:= cd_fornecedor_w;
			qt_fornecedor_1_w	:= qt_material_w;
			vl_fornecedor_1_w	:= vl_unitario_material_w;
		elsif (coalesce(cd_fornecedor_2_w::text, '') = '') or (cd_fornecedor_2_w = cd_fornecedor_w) then
			cd_fornecedor_2_w	:= cd_fornecedor_w;
			qt_fornecedor_2_w	:= qt_material_w;
			vl_fornecedor_2_w	:= vl_unitario_material_w;
		elsif (coalesce(cd_fornecedor_3_w::text, '') = '') or (cd_fornecedor_3_w = cd_fornecedor_w) then
			cd_fornecedor_3_w	:= cd_fornecedor_w;
			qt_fornecedor_3_w	:= qt_material_w;
			vl_fornecedor_3_w	:= vl_unitario_material_w;
		elsif (coalesce(cd_fornecedor_4_w::text, '') = '') or (cd_fornecedor_4_w = cd_fornecedor_w) then
			cd_fornecedor_4_w	:= cd_fornecedor_w;
			qt_fornecedor_4_w	:= qt_material_w;
			vl_fornecedor_4_w	:= vl_unitario_material_w;
		elsif (coalesce(cd_fornecedor_5_w::text, '') = '') or (cd_fornecedor_5_w = cd_fornecedor_w) then
			cd_fornecedor_5_w	:= cd_fornecedor_w;
			qt_fornecedor_5_w	:= qt_material_w;
			vl_fornecedor_5_w	:= vl_unitario_material_w;
		elsif (coalesce(cd_fornecedor_6_w::text, '') = '') or (cd_fornecedor_6_w = cd_fornecedor_w) then
			cd_fornecedor_6_w	:= cd_fornecedor_w;
			qt_fornecedor_6_w	:= qt_material_w;
			vl_fornecedor_6_w	:= vl_unitario_material_w;
		elsif (coalesce(cd_fornecedor_7_w::text, '') = '') or (cd_fornecedor_7_w = cd_fornecedor_w) then
			cd_fornecedor_7_w	:= cd_fornecedor_w;
			qt_fornecedor_7_w	:= qt_material_w;
			vl_fornecedor_7_w	:= vl_unitario_material_w;
		elsif (coalesce(cd_fornecedor_8_w::text, '') = '') or (cd_fornecedor_8_w = cd_fornecedor_w) then
			cd_fornecedor_8_w	:= cd_fornecedor_w;
			qt_fornecedor_8_w	:= qt_material_w;
			vl_fornecedor_8_w	:= vl_unitario_material_w;
		elsif (coalesce(cd_fornecedor_9_w::text, '') = '') or (cd_fornecedor_9_w = cd_fornecedor_w) then
			cd_fornecedor_9_w	:= cd_fornecedor_w;
			qt_fornecedor_9_w	:= qt_material_w;
			vl_fornecedor_9_w	:= vl_unitario_material_w;
		elsif (coalesce(cd_fornecedor_10_w::text, '') = '') or (cd_fornecedor_10_w = cd_fornecedor_w) then
			cd_fornecedor_10_w	:= cd_fornecedor_w;
			qt_fornecedor_10_w	:= qt_material_w;
			vl_fornecedor_10_w	:= vl_unitario_material_w;
		elsif (coalesce(cd_fornecedor_11_w::text, '') = '') or (cd_fornecedor_11_w = cd_fornecedor_w) then
			cd_fornecedor_11_w	:= cd_fornecedor_w;
			qt_fornecedor_11_w	:= qt_material_w;
			vl_fornecedor_11_w	:= vl_unitario_material_w;
		elsif (coalesce(cd_fornecedor_12_w::text, '') = '') or (cd_fornecedor_12_w = cd_fornecedor_w) then
			cd_fornecedor_12_w	:= cd_fornecedor_w;
			qt_fornecedor_12_w	:= qt_material_w;
			vl_fornecedor_12_w	:= vl_unitario_material_w;
		elsif (coalesce(cd_fornecedor_13_w::text, '') = '') or (cd_fornecedor_13_w = cd_fornecedor_w) then
			cd_fornecedor_13_w	:= cd_fornecedor_w;
			qt_fornecedor_13_w	:= qt_material_w;
			vl_fornecedor_13_w	:= vl_unitario_material_w;
		elsif (coalesce(cd_fornecedor_14_w::text, '') = '') or (cd_fornecedor_14_w = cd_fornecedor_w) then
			cd_fornecedor_14_w	:= cd_fornecedor_w;
			qt_fornecedor_14_w	:= qt_material_w;
			vl_fornecedor_14_w	:= vl_unitario_material_w;
		end if;
		end;
	END LOOP;
	CLOSE C02;

	select	nextval('w_cotacao_item_seq')
	into STRICT	nr_sequencia_w
	;

	insert into w_cotacao_item(
		nr_sequencia,
		dt_atualizacao,
		nm_usuario,
		cd_material,
		cd_fornecedor_1,
		qt_fornecedor_1,
		vl_fornecedor_1,
		cd_fornecedor_2,
		qt_fornecedor_2,
		vl_fornecedor_2,
		cd_fornecedor_3,
		qt_fornecedor_3,
		vl_fornecedor_3,
		cd_fornecedor_4,
		qt_fornecedor_4,
		vl_fornecedor_4,
		cd_fornecedor_5,
		qt_fornecedor_5,
		vl_fornecedor_5,
		cd_fornecedor_6,
		qt_fornecedor_6,
		vl_fornecedor_6,
		cd_fornecedor_7,
		qt_fornecedor_7,
		vl_fornecedor_7,
		cd_fornecedor_8,
		qt_fornecedor_8,
		vl_fornecedor_8,
		cd_fornecedor_9,
		qt_fornecedor_9,
		vl_fornecedor_9,
		cd_fornecedor_10,
		qt_fornecedor_10,
		vl_fornecedor_10,
		cd_fornecedor_11,
		qt_fornecedor_11,
		vl_fornecedor_11,
		cd_fornecedor_12,
		qt_fornecedor_12,
		vl_fornecedor_12,
		cd_fornecedor_13,
		qt_fornecedor_13,
		vl_fornecedor_13,
		cd_fornecedor_14,
		qt_fornecedor_14,
		vl_fornecedor_14,
		nr_cot_compra)
	values (
		nr_sequencia_w,
		clock_timestamp(),
		'Tasy',
		cd_material_w,
		cd_fornecedor_1_w,
		qt_fornecedor_1_w,
		vl_fornecedor_1_w,
		cd_fornecedor_2_w,
		qt_fornecedor_2_w,
		vl_fornecedor_2_w,
		cd_fornecedor_3_w,
		qt_fornecedor_3_w,
		vl_fornecedor_3_w,
		cd_fornecedor_4_w,
		qt_fornecedor_4_w,
		vl_fornecedor_4_w,
		cd_fornecedor_5_w,
		qt_fornecedor_5_w,
		vl_fornecedor_5_w,
		cd_fornecedor_6_w,
		qt_fornecedor_6_w,
		vl_fornecedor_6_w,
		cd_fornecedor_7_w,
		qt_fornecedor_7_w,
		vl_fornecedor_7_w,
		cd_fornecedor_8_w,
		qt_fornecedor_8_w,
		vl_fornecedor_8_w,
		cd_fornecedor_9_w,
		qt_fornecedor_9_w,
		vl_fornecedor_9_w,
		cd_fornecedor_10_w,
		qt_fornecedor_10_w,
		vl_fornecedor_10_w,
		cd_fornecedor_11_w,
		qt_fornecedor_11_w,
		vl_fornecedor_11_w,
		cd_fornecedor_12_w,
		qt_fornecedor_12_w,
		vl_fornecedor_12_w,
		cd_fornecedor_13_w,
		qt_fornecedor_13_w,
		vl_fornecedor_13_w,
		cd_fornecedor_14_w,
		qt_fornecedor_14_w,
		vl_fornecedor_14_w,
		nr_cot_compra_p);
	commit;
	end;
END LOOP;
CLOSE C01;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_w_cotacao_item ( nr_cot_compra_p bigint) FROM PUBLIC;

