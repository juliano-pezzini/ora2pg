-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE consiste_nec_hidrica_npt ( nr_prescricao_p nut_pac.nr_prescricao%type, nr_seq_nut_pac_p nut_pac.nr_sequencia%type, nm_usuario_p nut_pac.nm_usuario%type, cd_perfil_p bigint, ds_erro_p INOUT text) AS $body$
DECLARE



c00 REFCURSOR;

qt_aporte_hidrico_diario_w		nut_pac.qt_aporte_hidrico_diario%type;
qt_volume_diario_w				nut_pac.qt_volume_diario%type;
nr_sequencia_w					nut_pac.nr_sequencia%type;
nr_seq_erro_w					prescr_medica_erro.nr_sequencia%type;
ie_erro_liberar_prescr_w		prescr_medica_erro.ie_libera%type;
qt_erro_nao_lib_w				bigint;
qt_erro_lib_w					bigint;

BEGIN

if (coalesce(nr_seq_nut_pac_p,0) > 0) then
	delete	FROM prescr_medica_erro
	where	nr_prescricao	= nr_prescricao_p
	and		nr_seq_nut_pac	= nr_seq_nut_pac_p;

	open c00 for
	SELECT	nr_sequencia,
			coalesce(QT_APORTE_HIDRICO_DIARIO,0),
			coalesce(QT_VOLUME_DIARIO,0)
	from	nut_pac
	where	nr_sequencia = nr_seq_nut_pac_p
	and		nr_prescricao = nr_prescricao_p
	and		coalesce(ie_npt_adulta,'S') = 'P';
elsif (coalesce(nr_seq_nut_pac_p,0) = 0) then
	delete	FROM prescr_medica_erro
	where	nr_prescricao	= nr_prescricao_p
	and		(nr_seq_nut_pac IS NOT NULL AND nr_seq_nut_pac::text <> '');

	open c00 for
	SELECT	nr_sequencia,
			coalesce(qt_aporte_hidrico_diario,0),
			coalesce(qt_volume_diario,0)
	from	nut_pac
	where	nr_prescricao = nr_prescricao_p
	and		coalesce(ie_npt_adulta,'S') = 'P';
end if;

loop
fetch c00 into	nr_sequencia_w,
				qt_aporte_hidrico_diario_w,
				qt_volume_diario_w;
EXIT WHEN NOT FOUND; /* apply on c00 */
	begin

	if (qt_volume_diario_w > qt_aporte_hidrico_diario_w) and (wheb_assist_pck.Obter_Se_Consiste_REP(280,cd_perfil_p) = 'S') then
		ie_erro_liberar_prescr_w	:= obter_lib_erro_regra_rep(280, cd_perfil_p);
		nr_seq_erro_w := gerar_erro_nut_pac(nr_prescricao_p, nr_sequencia_w, 280, ie_erro_liberar_prescr_w, null, cd_perfil_p, nm_usuario_p, nr_seq_erro_w);
	end if;

	ie_erro_liberar_prescr_w	:= '';

	select	count(*)
	into STRICT	qt_erro_nao_lib_w
	from	prescr_medica_erro
	where	nr_prescricao	= nr_prescricao_p
	and		nr_seq_nut_pac	= nr_sequencia_w
	and		ie_libera		= 'N'  LIMIT 1;

	if (qt_erro_nao_lib_w > 0) then
		update	nut_pac
		set		ie_erro					= 125,
				dt_atualizacao			= clock_timestamp()
		where	nr_sequencia			= nr_sequencia_w;
		ds_erro_p	:= '125';
	else
		select	count(*)
		into STRICT	qt_erro_lib_w
		from	prescr_medica_erro
		where	nr_prescricao	= nr_prescricao_p
		and		nr_seq_nut_pac	= nr_sequencia_w
		and		ie_libera	= 'S';
		if (qt_erro_lib_w > 0) then
			update	nut_pac
			set		ie_erro					= 124,
					dt_atualizacao			= clock_timestamp()
			where	nr_sequencia			= nr_sequencia_w;
			ds_erro_p := '124';
		else
			update	nut_pac
			set		ie_erro					= 0,
					dt_atualizacao			= clock_timestamp()
			where	nr_sequencia			= nr_sequencia_w;
		end if;
	end if;

	end;
end loop;
close c00;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE consiste_nec_hidrica_npt ( nr_prescricao_p nut_pac.nr_prescricao%type, nr_seq_nut_pac_p nut_pac.nr_sequencia%type, nm_usuario_p nut_pac.nm_usuario%type, cd_perfil_p bigint, ds_erro_p INOUT text) FROM PUBLIC;

