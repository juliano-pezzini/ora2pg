-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE aprov_pagto_envia_comunic ( nr_titulo_p TITULO_PAGAR.nr_titulo%type, cd_estabelecimento_p TITULO_PAGAR.cd_estabelecimento%type, nm_usuario_p conta_pagar_lib.nm_usuario_lib%type ) AS $body$
DECLARE
 				
qt_registros_pendentes_w	integer;
qt_registros_liberados_w	integer;
qt_min_usuario_lib_w 	    regra_lib_cp.qt_min_usuario_lib%TYPE;					

BEGIN

update	conta_pagar_lib
set    	dt_liberacao         = 	clock_timestamp() 
where  	nr_titulo            = 	nr_titulo_p
	and (
		nm_usuario_lib	= nm_usuario_p
		or (cd_perfil 	= obter_perfil_ativo)
	)
	and    	coalesce(nr_bordero::text, '') = '' 
	and    	coalesce(nr_seq_banco_escrit::text, '') = '';
	
commit;

select  	count(*)
into STRICT		qt_registros_pendentes_w
from    	conta_pagar_lib a
where   	coalesce(a.dt_liberacao::text, '') = ''
and     	a.nr_titulo = nr_titulo_p;	

select  	count(*)
into STRICT		qt_registros_liberados_w
from    	conta_pagar_lib a
where   	(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
and     	a.nr_titulo = nr_titulo_p;	
	
select 	max(coalesce(b.qt_min_usuario_lib,0))
into STRICT 	qt_min_usuario_lib_w
from 	conta_pagar_lib a,
		regra_lib_cp b
where	a.nr_seq_regra_lib = b.nr_sequencia
and 	a.nr_titulo = nr_titulo_p;					

if	((qt_registros_pendentes_w = 0) or (qt_min_usuario_lib_w <> 0 AND qt_registros_liberados_w >= qt_min_usuario_lib_w)) then
	update	titulo_pagar
	set    	dt_liberacao = clock_timestamp(), 
			nm_usuario_lib = nm_usuario_p 
	where  	nr_titulo  = nr_titulo_p;
end if;

CALL envia_comunic_aprov_pag(nr_titulo_p,nm_usuario_p,cd_estabelecimento_p);

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE aprov_pagto_envia_comunic ( nr_titulo_p TITULO_PAGAR.nr_titulo%type, cd_estabelecimento_p TITULO_PAGAR.cd_estabelecimento%type, nm_usuario_p conta_pagar_lib.nm_usuario_lib%type ) FROM PUBLIC;

