-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_lote_audit_rec (nr_seq_lote_p bigint, nm_usuario_p text) AS $body$
DECLARE


nr_seq_lote_rec_w	bigint;
nr_sequencia_w		bigint;
nr_interno_conta_w	bigint;
cd_autorizacao_w	varchar(15);
nr_conpaci_ret_w	bigint;

cd_convenio_w		integer;
cd_estabelecimento_w	integer;
ie_status_w		varchar(2);

dt_inicial_w		timestamp;
dt_final_w		timestamp;

c01 CURSOR FOR
SELECT	a.nr_sequencia,
	b.nr_interno_conta,
	b.cd_autorizacao,
	a.nr_seq_conpaci_ret
from	convenio_retorno_item b,
	lote_audit_hist_item a
where	a.nr_seq_lote	= nr_seq_lote_p
and	a.nr_seq_ret_item	= b.nr_sequencia;


BEGIN

select	nextval('lote_audit_recurso_seq')
into STRICT	nr_seq_lote_rec_w
;

select	b.cd_convenio,
	b.cd_estabelecimento,
	a.ie_status
into STRICT	cd_convenio_w,
	cd_estabelecimento_w,
	ie_status_w
from	lote_auditoria b,
	lote_audit_hist a
where	a.nr_sequencia		= nr_seq_lote_p
and	a.nr_seq_lote_audit	= b.nr_sequencia;

select	min(DT_HISTORICO),
	max(DT_HISTORICO)
into STRICT	dt_inicial_w,
	dt_final_w
from	lote_audit_hist_item
where	nr_seq_lote		= nr_seq_lote_p;

insert into lote_audit_recurso(nr_sequencia,
	nr_lote,
	dt_atualizacao,
	nm_usuario,
	dt_inicial,
	dt_final,
	cd_convenio,
	cd_estabelecimento,
	ie_acao_historico,
	dt_geracao,
	dt_envio,
	dt_prev_retorno,
	dt_atualizacao_nrec,
	nm_usuario_nrec,
	ie_situacao_lote,
	nm_usuario_resp,
	ds_observacao)
SELECT	nr_seq_lote_rec_w,
	nr_seq_lote_rec_w,
	clock_timestamp(),
	nm_usuario_p,
	dt_inicial_w,
	dt_final_w,
	cd_convenio_w,
	cd_estabelecimento_w,
	null,
	null,
	null,
	null,
	clock_timestamp(),
	nm_usuario_p,
	'A',
	null,
	null
;

open c01;
loop
fetch c01 into
	nr_sequencia_w,
	nr_interno_conta_w,
	cd_autorizacao_w,
	nr_conpaci_ret_w;
EXIT WHEN NOT FOUND; /* apply on c01 */

	if (nr_conpaci_ret_w IS NOT NULL AND nr_conpaci_ret_w::text <> '') then
		insert	into conta_paciente_ret_hist(nr_sequencia,
			dt_historico,
			vl_historico,
			dt_atualizacao,
			nm_usuario,
			nr_seq_conpaci_ret,
			nr_seq_hist_audit,
			nr_seq_ret_item,
			ds_observacao,
			nr_seq_lote_audit,
			dt_reapresentacao,
			dt_receb_prev,
			cd_motivo_glosa,
			cd_processo_receb,
			nr_seq_lote_recurso,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			cd_resposta,
			nm_usuario_resp)
		SELECT	nextval('conta_paciente_ret_hist_seq'),
			clock_timestamp(),
			vl_historico,
			clock_timestamp(),
			nm_usuario_p,
			nr_conpaci_ret_w,
			nr_seq_hist_audit,
			nr_seq_ret_item,
			ds_observacao,
			null,
			dt_reapresentacao,
			dt_receb_prev,
			cd_motivo_glosa,
			cd_processo_receb,
			nr_seq_lote_rec_w,
			clock_timestamp(),
			nm_usuario_p,
			cd_resposta,
			null
		from	lote_audit_hist_item
		where	nr_sequencia	= nr_sequencia_w;
	end if;
end loop;
close c01;

update	lote_audit_hist
set	dt_geracao_lote_rec	= clock_timestamp(),
	dt_atualizacao		= clock_timestamp(),
	nm_usuario		= nm_usuario_p
where	nr_sequencia		= nr_seq_lote_p;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_lote_audit_rec (nr_seq_lote_p bigint, nm_usuario_p text) FROM PUBLIC;

