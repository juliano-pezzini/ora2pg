-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_eis_evolucao (dt_parametro_p timestamp, ie_opcao_p text, nm_usuario_p text) AS $body$
DECLARE


nr_sequencia_w					bigint;
cd_evolucao_w					evolucao_paciente.cd_evolucao%type;
dt_evolucao_w					evolucao_paciente.dt_evolucao%type;
ie_tipo_evolucao_w				evolucao_paciente.ie_tipo_evolucao%type;
ds_tipo_evolucao_w				tipo_evolucao.ds_tipo_evolucao%type;
ie_evolucao_clinica_w			evolucao_paciente.ie_evolucao_clinica%type;
ds_tipo_evol_clinica_w			tipo_evolucao.ds_tipo_evolucao%type;
nm_profissional_w				varchar(60);
nr_atendimento_w				evolucao_paciente.nr_atendimento%type;
dt_liberacao_w					evolucao_paciente.dt_liberacao%type;
cd_setor_atendimento_w			evolucao_paciente.cd_setor_atendimento%type;
ie_situacao_w					evolucao_paciente.ie_situacao%type;
cd_medico_w						evolucao_paciente.cd_medico%type;
cd_especialidade_medico_w		evolucao_paciente.cd_especialidade_medico%type;
ds_especialidade_medica_w		varchar(50);
cd_convenio_w					atend_categoria_convenio.cd_convenio%type;
ds_convenio_w					convenio.ds_convenio%type;
ds_setor_atendimento_w			varchar(100);
cd_pessoa_fisica_w				evolucao_paciente.cd_pessoa_fisica%type;
nm_pessoa_fisica_w				varchar(60);
cd_estabelecimento_w			varchar(10);	
ie_opcao_w						varchar(2);

c01 CURSOR FOR
SELECT  a.cd_evolucao,
	trunc(a.dt_evolucao),
	a.ie_tipo_evolucao,
	substr(obter_desc_tipo_evolucao(a.ie_tipo_evolucao),1,255),
	a.ie_evolucao_clinica,
	substr(obter_desc_tipo_evolucao(a.ie_evolucao_clinica),1,255),
	substr(obter_nome_pf(a.cd_medico),1,255),
	a.nr_atendimento,
	a.dt_liberacao,
	a.cd_setor_atendimento,
	a.ie_situacao,
	a.cd_medico,
	a.cd_especialidade_medico,
	substr(obter_desc_espec_medica(cd_especialidade_medico),1,50),
	obter_convenio_atendimento(a.nr_atendimento),
	obter_desc_convenio(obter_convenio_atendimento(a.nr_atendimento)),
	obter_nome_setor(a.cd_setor_atendimento),
	a.cd_pessoa_fisica,
	substr(obter_nome_pf(a.cd_pessoa_fisica),1,80),
	(obter_estab_atendimento(a.nr_atendimento))::numeric
from evolucao_paciente a
where trunc(a.dt_evolucao, ie_opcao_w) = trunc(dt_parametro_p, ie_opcao_w);


BEGIN

if (ie_opcao_p = 'D') then
	ie_opcao_w	:= 'DD';
else
	ie_opcao_w	:= 'MM';
end if;

delete FROM eis_evolucao_profissional
where trunc(dt_evolucao,ie_opcao_w) = trunc(dt_parametro_p,ie_opcao_w);

nr_sequencia_w := Gravar_Log_Indicador(1532, obter_desc_expressao(559909), clock_timestamp(), dt_parametro_p, nm_usuario_p, nr_sequencia_w);

open C01;
loop
fetch C01 into	
	cd_evolucao_w,
	dt_evolucao_w,
	ie_tipo_evolucao_w,
	ds_tipo_evolucao_w,
	ie_evolucao_clinica_w,
	ds_tipo_evol_clinica_w,
	nm_profissional_w,
	nr_atendimento_w,
	dt_liberacao_w,
	cd_setor_atendimento_w,
	ie_situacao_w,
	cd_medico_w,
	cd_especialidade_medico_w,
	ds_especialidade_medica_w,
	cd_convenio_w,
	ds_convenio_w,
	ds_setor_atendimento_w,
	cd_pessoa_fisica_w,
	nm_pessoa_fisica_w,
	cd_estabelecimento_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	
	insert into eis_evolucao_profissional(nr_sequencia,	
						cd_evolucao,
						dt_evolucao,
						ie_tipo_evolucao,
						ds_tipo_evolucao,
						ie_evolucao_clinica,
						ds_tipo_evol_clinica,
						nm_profissional,
						nr_atendimento,
						dt_liberacao,
						cd_setor_atendimento,
						ie_situacao,
						cd_medico,
						cd_especialidade_medico,
						ds_especialidade_medica,
                        cd_convenio,
                        ds_convenio,
                        ds_setor_atendimento,
                        cd_pessoa_fisica,
                        nm_pessoa_fisica,
                        cd_estabelecimento,
						dt_atualizacao,
						nm_usuario,
						dt_referencia)
				values (nextval('eis_evolucao_profissional_seq'),
						cd_evolucao_w,
						dt_evolucao_w,
						ie_tipo_evolucao_w,
						ds_tipo_evolucao_w,
						ie_evolucao_clinica_w,
						ds_tipo_evol_clinica_w,
						nm_profissional_w,
						nr_atendimento_w,
						dt_liberacao_w,
						cd_setor_atendimento_w,
						ie_situacao_w,
						cd_medico_w,
						cd_especialidade_medico_w,
						ds_especialidade_medica_w,
						cd_convenio_w,
						ds_convenio_w,
						ds_setor_atendimento_w,
						cd_pessoa_fisica_w,
						nm_pessoa_fisica_w,
						cd_estabelecimento_w,
						clock_timestamp(),
						nm_usuario_p,
						trunc(dt_parametro_p, ie_opcao_w));
						
	end;
end loop;
close C01;

CALL Atualizar_Log_Indicador(clock_timestamp(), nr_sequencia_w);

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_eis_evolucao (dt_parametro_p timestamp, ie_opcao_p text, nm_usuario_p text) FROM PUBLIC;

