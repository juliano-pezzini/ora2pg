-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE cpoe_atualizar_rep ( nr_prescricao_p prescr_medica.nr_prescricao%type, nr_seq_cpoe_p bigint, ie_tipo_item_p text, nm_usuario_p usuario.nm_usuario%type, cd_perfil_p perfil.cd_perfil%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type) AS $body$
DECLARE


ie_via_aplicacao_w				cpoe_material.ie_via_aplicacao%type;
hr_prim_horario_w				cpoe_material.hr_prim_horario%type;
dt_inicio_w						cpoe_material.dt_inicio%type;
ds_horarios_w					cpoe_material.ds_horarios%type;
ie_medicacao_paciente_w			cpoe_material.ie_medicacao_paciente%type;
cd_material_w					cpoe_material.cd_material%type;
ds_justif_troca_disp_w			cpoe_material.ds_justif_troca_disp%type;
ie_bomba_infusao_w				cpoe_material.ie_bomba_infusao%type;
dt_adm_adicional_w				cpoe_material.dt_adm_adicional%type;
nr_ocorrencia_w					cpoe_material.nr_ocorrencia%type;

qt_dia_prim_hor_w				prescr_material.qt_dia_prim_hor%type := 0;
nr_seq_solucao_w				prescr_material.nr_sequencia_solucao%type;
ie_acm_w						prescr_material.ie_acm%type;
cd_intervalo_w					prescr_material.cd_intervalo%type;
nr_seq_via_acesso_w				prescr_material.nr_seq_via_acesso%type;
hr_dose_especial_w				prescr_material.hr_dose_especial%type;
qt_dose_especial_w				prescr_material.qt_dose_especial%type;

qt_min_dose_ataque_w			prescr_solucao.qt_min_dose_ataque%type;
ie_urgencia_w					prescr_solucao.ie_urgencia%type;

nr_seq_proc_interno_w			cpoe_procedimento.nr_seq_proc_interno%type;
ds_observacao_enf_w				cpoe_procedimento.ds_observacao_enf%type;

qt_fase_npt_w					cpoe_dieta.qt_fase_npt%type;

nr_seq_prescr_sangue_w			prescr_procedimento.nr_seq_solic_sangue%type;

ds_observacao_w					prescr_dieta.ds_observacao%type;
qt_parametro_w					prescr_dieta.qt_parametro%type;
cd_dieta_w						prescr_dieta.cd_dieta%type;

dt_inicio_prescr_w				prescr_medica.dt_inicio_prescr%type;
dt_validade_prescr_w			prescr_medica.dt_validade_prescr%type;
nr_prescricao_vigente_w			prescr_medica.nr_prescricao%type;
nr_prescricao_auxiliar_w		prescr_medica.nr_prescricao%type;
nr_horas_diferenca_w			prescr_medica.nr_horas_validade%type;

dt_prev_execucao_w				timestamp;
dt_inicio_item_w				timestamp;
nr_hora_adicional_w				constant smallint := 1;
indice							integer := 0;

type nr_prescricao_t is table of prescr_medica.nr_prescricao%type index by integer;
array_nr_prescricao_w			nr_prescricao_t;

type nr_sequencia_recomendacao_t is table of prescr_recomendacao.nr_sequencia%type index by integer;
array_nr_seq_recomendacao_w		nr_sequencia_recomendacao_t;

type nr_sequencia_gasoterapia_t is table of prescr_gasoterapia.nr_sequencia%type index by integer;
array_nr_seq_gasoterapia_w		nr_sequencia_gasoterapia_t;

type dt_prev_execucao_t is table of timestamp index by integer;
array_dt_prev_execucao_w		dt_prev_execucao_t;

type qt_dia_prim_hor_t is table of bigint index by integer;
array_qt_dia_prim_hor_w			qt_dia_prim_hor_t;

c01 CURSOR(c_nr_prescricao_pc  bigint) FOR
SELECT	a.nr_sequencia
from	prescr_material a
where	a.nr_prescricao = c_nr_prescricao_pc
and		a.nr_seq_mat_cpoe = nr_seq_cpoe_p
and		coalesce(a.ie_suspenso,'N')	= 'N'
and		a.ie_agrupador = 1;

c02 CURSOR FOR
SELECT	distinct a.nr_prescricao
from	prescr_material a
where	a.nr_prescricao >= nr_prescricao_vigente_w
and		a.nr_seq_mat_cpoe = nr_seq_cpoe_p
order by a.nr_prescricao;

c04 CURSOR FOR
SELECT	distinct a.nr_prescricao,
		a.nr_sequencia
from	prescr_recomendacao a
where	a.nr_prescricao >= nr_prescricao_vigente_w
and		a.nr_seq_rec_cpoe = nr_seq_cpoe_p
order by a.nr_prescricao;

c05 CURSOR FOR
SELECT	distinct a.nr_prescricao,
		a.nr_sequencia
from	prescr_procedimento a
where	a.nr_prescricao >= nr_prescricao_vigente_w
and		a.nr_seq_proc_cpoe = nr_seq_cpoe_p
and		a.nr_seq_proc_interno = nr_seq_proc_interno_w
and		coalesce(a.nr_seq_origem::text, '') = ''
order by a.nr_prescricao;

c06 CURSOR FOR
SELECT	distinct a.nr_prescricao,
		a.nr_sequencia
from	prescr_gasoterapia a
where	a.nr_prescricao >= nr_prescricao_vigente_w
and		a.nr_seq_gas_cpoe = nr_seq_cpoe_p
order by a.nr_prescricao;

c07 CURSOR FOR
SELECT	distinct a.nr_prescricao
from	prescr_dieta a
where	a.nr_prescricao >= nr_prescricao_vigente_w
and		a.nr_seq_dieta_cpoe = nr_seq_cpoe_p
order by a.nr_prescricao;

c08 CURSOR FOR
SELECT	distinct a.nr_prescricao
from	prescr_material a
where	a.nr_prescricao >= nr_prescricao_vigente_w
and		a.nr_seq_dieta_cpoe = nr_seq_cpoe_p
and		a.ie_agrupador in (8, 12, 16)
order by a.nr_prescricao;

c09 CURSOR FOR
	SELECT	distinct a.nr_prescricao
	from	nut_pac a
	where	a.nr_prescricao >= nr_prescricao_vigente_w
	and		a.nr_seq_npt_cpoe = nr_seq_cpoe_p
	order by a.nr_prescricao;

procedure atualizar_validade_prescricao(	nr_prescricao_p			 prescr_medica.nr_prescricao%type,
											dt_validade_prescr_p	 prescr_medica.dt_validade_prescr%type,
											dt_inicio_item_p	 	 timestamp) is;
BEGIN
	/*
	Diferenca, em horas, entre o inicio do item e a validade da prescricao
	Difference, in hours, between the start of the item and the validity of the prescription
	*/
	nr_horas_diferenca_w := obter_tempo_entre_datas(dt_inicio_item_p, dt_validade_prescr_p, 'T');
	
	if (nr_horas_diferenca_w < 24) then
		
		update	prescr_medica a
		set		a.nr_horas_validade = a.nr_horas_validade + ((24 + nr_hora_adicional_w) - nr_horas_diferenca_w)
		where	a.nr_prescricao = nr_prescricao_p;
	end if;
end;

begin

nr_prescricao_vigente_w := gpt_obter_prescricao_vigente(nr_sequencia_p => nr_seq_cpoe_p, ie_tipo_item_p => ie_tipo_item_p);

if (ie_tipo_item_p	in ('SOL','M')) then

	select	max(a.ie_via_aplicacao),
			max(a.hr_prim_horario),
			max(a.dt_inicio),
			max(a.ds_horarios),
			max(a.dt_adm_adicional),
			max(a.qt_dose_adicional),
			max(a.ie_medicacao_paciente),
			max(a.ie_bomba_infusao),
			max(a.ds_justif_troca_disp),
			max(a.nr_seq_via_acesso),
			max(a.ds_observacao_enf),
			max(obter_minutos_hora(a.qt_min_fase_ataque)),
			max(CASE WHEN coalesce(a.ie_urgencia::text, '') = '' THEN  'N'  ELSE 'S' END ),
			max(a.nr_ocorrencia),
			max(a.cd_material)
	into STRICT	ie_via_aplicacao_w,
			hr_prim_horario_w,
			dt_inicio_w,
			ds_horarios_w,
			dt_adm_adicional_w,
			qt_dose_especial_w,
			ie_medicacao_paciente_w,
			ie_bomba_infusao_w,
			ds_justif_troca_disp_w,
			nr_seq_via_acesso_w,
			ds_observacao_enf_w,
			qt_min_dose_ataque_w,
			ie_urgencia_w,
			nr_ocorrencia_w,
			cd_material_w
	from	cpoe_material a
	where	a.nr_sequencia = nr_seq_cpoe_p;
	
	dt_inicio_item_w := dt_inicio_w;

	for r_c02_w in c02
	loop
		
		select	max(a.dt_inicio_prescr),
				max(a.dt_validade_prescr)
		into STRICT	dt_inicio_prescr_w,
				dt_validade_prescr_w
		from	prescr_medica a
		where	a.nr_prescricao = r_c02_w.nr_prescricao;

		hr_dose_especial_w := to_char(dt_adm_adicional_w, 'hh24:mi');
		
		if (pkg_date_utils.start_of(source => dt_inicio_prescr_w, date_field => 'dd') < pkg_date_utils.start_of(source => dt_inicio_item_w, date_field => 'dd')) then
			qt_dia_prim_hor_w := 1;
		else
			qt_dia_prim_hor_w := 0;
		end if;

		if (ie_tipo_item_p = 'M') then

			update	prescr_material a
			set		a.ie_via_aplicacao = ie_via_aplicacao_w,
					a.hr_prim_horario = hr_prim_horario_w,
					a.hr_dose_especial = hr_dose_especial_w,
					a.qt_dose_especial = qt_dose_especial_w,
					a.ie_medicacao_paciente = ie_medicacao_paciente_w,
					a.qt_dia_prim_hor = qt_dia_prim_hor_w,
					a.ds_horarios = ds_horarios_w,
					a.ds_observacao_enf = ds_observacao_enf_w,
					a.nr_seq_via_acesso = nr_seq_via_acesso_W,
					a.nm_usuario = nm_usuario_p,
					a.dt_atualizacao = clock_timestamp(),
					a.dt_inicio_medic = dt_inicio_w,
					a.nr_ocorrencia = nr_ocorrencia_w
			where	a.nr_prescricao = r_c02_w.nr_prescricao
			and		a.nr_seq_mat_cpoe = nr_seq_cpoe_p
			and		coalesce(a.ie_suspenso, 'N') = 'N'
			and		a.ie_agrupador in (1, 5);

			CALL ajustar_prescr_material_html5(	nr_prescricao_p => r_c02_w.nr_prescricao,
											nr_seq_cpoe_p => nr_seq_cpoe_p,
											cd_material_p => cd_material_w);

			--atualiza_recon_diluicao_html( nr_prescricao_p, nr_seq_cpoe_p, nm_usuario_p, cd_perfil_p, cd_estabelecimento_p);
			
			for r_c01_w in c01(r_c02_w.nr_prescricao)
			loop
				CALL alterar_dispositivo_infusao(nr_prescricao_p => r_c02_w.nr_prescricao,
											nr_sequencia_p => r_c01_w.nr_sequencia,
											ds_tipo_p => ie_tipo_item_p,
											ie_bomba_infusao_p => ie_bomba_infusao_w,
											ds_justificativa_p => ds_justif_troca_disp_w);
			end loop;
			
			CALL html_atualiza_quant_disp(	nr_prescricao_p => r_c02_w.nr_prescricao,
										nr_seq_cpoe_p => nr_seq_cpoe_p,
										ie_agrupador_p => 1,
										nm_usuario_p => nm_usuario_p,
										cd_estabelecimento_p => cd_estabelecimento_p);

		elsif (ie_tipo_item_p	= 'SOL') then

			select	max(a.nr_sequencia_solucao)
			into STRICT	nr_seq_solucao_w
			from	prescr_material a
			where	a.nr_seq_mat_cpoe = nr_seq_cpoe_p
			and		a.nr_prescricao = r_c02_w.nr_prescricao
			and		coalesce(a.ie_suspenso,'N') = 'N'
			and		a.ie_agrupador = 4;
			
			update	prescr_solucao a
			set		a.qt_min_dose_ataque = qt_min_dose_ataque_w,
					a.hr_prim_horario = hr_prim_horario_w,
					a.ds_orientacao_enf = ds_observacao_enf_w,
					a.ie_urgencia = ie_urgencia_w,
					a.nm_usuario = nm_usuario_p,
					a.dt_atualizacao = clock_timestamp(),
					a.ds_horarios = ds_horarios_w
			where	a.nr_prescricao = r_c02_w.nr_prescricao
			and		a.nr_seq_solucao = nr_seq_solucao_w;
			
			update	prescr_material a
			set		a.qt_dia_prim_hor = qt_dia_prim_hor_w,
					a.ie_gerar_horario = CASE WHEN a.ie_gerar_horario='N' THEN  'S'  ELSE a.ie_gerar_horario END ,
					a.nm_usuario = nm_usuario_p,
					a.dt_atualizacao = clock_timestamp()				
			where	a.nr_prescricao = r_c02_w.nr_prescricao
			and		a.nr_sequencia_solucao = nr_seq_solucao_w
			and		a.nr_seq_mat_cpoe = nr_seq_cpoe_p
			and		coalesce(a.ie_suspenso, 'N') = 'N'
			and		a.ie_agrupador = 4;
		
			CALL alterar_dispositivo_infusao(nr_prescricao_p => r_c02_w.nr_prescricao,
										nr_sequencia_p => nr_seq_solucao_w,
										ds_tipo_p => ie_tipo_item_p,
										ie_bomba_infusao_p => ie_bomba_infusao_w,
										ds_justificativa_p => ds_justif_troca_disp_w);

			CALL html_atualiza_quant_disp(	nr_prescricao_p => r_c02_w.nr_prescricao,
										nr_seq_cpoe_p => nr_seq_cpoe_p,
										ie_agrupador_p => 4,
										nm_usuario_p => nm_usuario_p,
										cd_estabelecimento_p => cd_estabelecimento_p);

			CALL html_atualiza_volume_total_sol(	nr_prescricao_p => r_c02_w.nr_prescricao,
											nr_seq_cpoe_p => nr_seq_cpoe_p,
											nm_usuario_p => nm_usuario_p);

			CALL ajustar_prescr_mat_solucao(	nr_prescricao_p => r_c02_w.nr_prescricao,
										nr_sequencia_p => nr_seq_solucao_w);

		end if;

		if (coalesce(nr_prescricao_auxiliar_w, 0) <> r_c02_w.nr_prescricao) then

			atualizar_validade_prescricao(	nr_prescricao_p => r_c02_w.nr_prescricao,
											dt_validade_prescr_p => dt_validade_prescr_w,
											dt_inicio_item_p => dt_inicio_item_w);

			dt_inicio_item_w := dt_inicio_item_w + 1;
			nr_prescricao_auxiliar_w := r_c02_w.nr_prescricao;

		end if;
	end loop;

elsif (ie_tipo_item_p	= 'MAT') then

	select	max(a.dt_inicio_prescr),
			max(a.dt_validade_prescr)
	into STRICT	dt_inicio_prescr_w,
			dt_validade_prescr_w
	from	prescr_medica a
	where	a.nr_prescricao = nr_prescricao_p;

	select	max(a.dt_inicio),
			max(a.hr_prim_horario),
			max(a.ds_horarios),
			max(a.nr_ocorrencia)
	into STRICT	dt_inicio_w,
			hr_prim_horario_w,
			ds_horarios_w,
			nr_ocorrencia_w
	from	cpoe_material a
	where	a.nr_sequencia = nr_seq_cpoe_p;
	
	dt_inicio_item_w := dt_inicio_w;
	
	if (pkg_date_utils.start_of(source => dt_inicio_prescr_w, date_field => 'dd') < pkg_date_utils.start_of(source => dt_inicio_item_w, date_field => 'dd')) then
		qt_dia_prim_hor_w := 1;
	else
		qt_dia_prim_hor_w := 0;
	end if;

	update	prescr_material a
	set		a.ds_horarios = ds_horarios_w,
			a.hr_prim_horario = hr_prim_horario_w,
			a.dt_inicio_medic = dt_inicio_item_w,
			a.qt_dia_prim_hor = qt_dia_prim_hor_w,
			a.nr_ocorrencia = nr_ocorrencia_w,
			a.nm_usuario = nm_usuario_p,
			a.dt_atualizacao = clock_timestamp()
	where	a.nr_prescricao = nr_prescricao_p
	and		a.nr_seq_mat_cpoe = nr_seq_cpoe_p
	and		coalesce(a.ie_suspenso, 'N')	= 'N'
	and		a.ie_agrupador = 2;

	CALL html_atualiza_quant_disp(	nr_prescricao_p => nr_prescricao_p,
								nr_seq_cpoe_p => nr_seq_cpoe_p,
								ie_agrupador_p => 2,
								nm_usuario_p => nm_usuario_p,
								cd_estabelecimento_p => cd_estabelecimento_p);

	atualizar_validade_prescricao(	nr_prescricao_p => nr_prescricao_p,
									dt_validade_prescr_p => dt_validade_prescr_w,
									dt_inicio_item_p => dt_inicio_item_w);

elsif (ie_tipo_item_p	= 'P') then

	select	max(a.nr_seq_proc_interno),
			max(a.dt_inicio),
			max(a.ds_horarios),
			max(a.ds_observacao_enf),
			max(a.nr_ocorrencia)
	into STRICT	nr_seq_proc_interno_w,
			dt_inicio_w,
			ds_horarios_w,
			ds_observacao_enf_w,
			nr_ocorrencia_w
	from	cpoe_procedimento a
	where	a.nr_sequencia = nr_seq_cpoe_p;

	dt_inicio_item_w := dt_inicio_w;

	for r_c05_w in c05
	loop
		select	max(a.dt_inicio_prescr),
				max(a.dt_validade_prescr)
		into STRICT	dt_inicio_prescr_w,
				dt_validade_prescr_w
		from	prescr_medica a
		where	a.nr_prescricao = r_c05_w.nr_prescricao;
		
		if (dt_inicio_item_w IS NOT NULL AND dt_inicio_item_w::text <> '') then
			dt_prev_execucao_w := dt_inicio_item_w;
		end if;

		update	prescr_procedimento a
		set		a.dt_prev_execucao = dt_prev_execucao_w,
				a.ds_horarios = ds_horarios_w,
				a.nr_ocorrencia = nr_ocorrencia_w,
				a.ds_observacao_enf = ds_observacao_enf_w,
				a.dt_atualizacao = clock_timestamp(),
				a.nm_usuario = nm_usuario_p
		where	a.nr_prescricao = r_c05_w.nr_prescricao
		and		a.nr_sequencia = r_c05_w.nr_sequencia;

		CALL gpt_ajustar_prescr_mat_proc(nr_prescricao_p => r_c05_w.nr_prescricao,
									nr_sequencia_procedimento_p => r_c05_w.nr_sequencia,
									cd_perfil_p => cd_perfil_p,
									nm_usuario_p => nm_usuario_p);

		if (coalesce(nr_prescricao_auxiliar_w, 0) <> r_c05_w.nr_prescricao) then

			atualizar_validade_prescricao(	nr_prescricao_p => r_c05_w.nr_prescricao,
											dt_validade_prescr_p => dt_validade_prescr_w,
											dt_inicio_item_p => dt_inicio_item_w);

			dt_inicio_item_w := dt_inicio_item_w + 1;
			nr_prescricao_auxiliar_w := r_c05_w.nr_prescricao;

		end if;
	end loop;
	
elsif (ie_tipo_item_p = 'S') then

	select	max(a.ds_horarios),
			max(a.hr_prim_horario),
			max(a.cd_intervalo),
			max(a.ie_acm),
			max(a.ds_observacao_enf),
			max(a.dt_inicio)
	into STRICT	ds_horarios_w,
			hr_prim_horario_w,
			cd_intervalo_w,
			ie_acm_w,
			ds_observacao_enf_w,
			dt_inicio_w
	from	cpoe_dieta a
	where	a.nr_sequencia = nr_seq_cpoe_p
	and		a.ie_tipo_dieta = 'S';
	
	dt_inicio_item_w := dt_inicio_w;
	
	for r_c08_w in c08
	loop
		select	max(a.dt_inicio_prescr),
				max(a.dt_validade_prescr)
		into STRICT	dt_inicio_prescr_w,
				dt_validade_prescr_w
		from	prescr_medica a
		where	a.nr_prescricao = r_c08_w.nr_prescricao;
		
		if (pkg_date_utils.start_of(source => dt_inicio_prescr_w, date_field => 'dd') < pkg_date_utils.start_of(source => dt_inicio_item_w, date_field => 'dd')) then
			qt_dia_prim_hor_w := 1;
		else
			qt_dia_prim_hor_w := 0;
		end if;

		CALL html_atualiza_quant_disp(	nr_prescricao_p => r_c08_w.nr_prescricao,
									nr_seq_cpoe_p => nr_seq_cpoe_p,
									ie_agrupador_p => 12,
									nm_usuario_p => nm_usuario_p,
									cd_estabelecimento_p => cd_estabelecimento_p);

		if (coalesce(nr_prescricao_auxiliar_w, 0) <> r_c08_w.nr_prescricao) then

			atualizar_validade_prescricao(	nr_prescricao_p => r_c08_w.nr_prescricao,
											dt_validade_prescr_p => dt_validade_prescr_w,
											dt_inicio_item_p => dt_inicio_item_w);

			dt_inicio_item_w := dt_inicio_item_w + 1;
			nr_prescricao_auxiliar_w := r_c08_w.nr_prescricao;

		end if;

		array_nr_prescricao_w(indice) := r_c08_w.nr_prescricao;
		array_qt_dia_prim_hor_w(indice) := qt_dia_prim_hor_w;

		indice := indice + 1;
	end loop;
	
	if (array_nr_prescricao_w.count > 0) then

		forall i in array_nr_prescricao_w.first .. array_nr_prescricao_w.last
			update	prescr_material a
			set		a.hr_prim_horario = hr_prim_horario_w,
					a.ds_horarios = ds_horarios_w,
					a.qt_dia_prim_hor = array_qt_dia_prim_hor_w(i),
					a.cd_intervalo = cd_intervalo_w,
					a.ie_acm = ie_acm_w,
					a.ds_observacao_enf = ds_observacao_enf_w,
					a.ie_gerar_horario = CASE WHEN a.ie_gerar_horario='N' THEN  'S'  ELSE a.ie_gerar_horario END ,
					a.nm_usuario = nm_usuario_p,
					a.dt_atualizacao = clock_timestamp()
			where	a.nr_prescricao = array_nr_prescricao_w(i)
			and		a.nr_seq_dieta_cpoe = nr_seq_cpoe_p
			and		coalesce(a.ie_suspenso, 'N') = 'N'
			and		a.ie_agrupador = 12;

		forall i in array_nr_prescricao_w.first .. array_nr_prescricao_w.last
			update	prescr_material a
			set		a.ie_gerar_horario = CASE WHEN a.ie_gerar_horario='N' THEN  'S'  ELSE a.ie_gerar_horario END ,
					a.nm_usuario = nm_usuario_p,
					a.dt_atualizacao = clock_timestamp()
			where	a.nr_prescricao = array_nr_prescricao_w(i)
			and		a.nr_seq_kit in (	SELECT	b.nr_sequencia
										from	prescr_material b
										where	b.nr_prescricao = a.nr_prescricao
										and		b.nr_seq_dieta_cpoe = nr_seq_cpoe_p
										and		coalesce(b.ie_suspenso, 'N') = 'N'
										and		b.ie_agrupador = 12)
			and		coalesce(a.nr_seq_recomendacao::text, '') = '';

	end if;
	
elsif (ie_tipo_item_p = 'D') then

	select	max(a.ds_observacao_enf),
			max(a.ds_horarios),
			max(a.hr_prim_horario),
			max(a.qt_dose),
			max(a.cd_dieta),
			max(a.dt_inicio)
	into STRICT	ds_observacao_w,
			ds_horarios_w,
			hr_prim_horario_w,
			qt_parametro_w,
			cd_dieta_w,
			dt_inicio_w
	from	cpoe_dieta a
	where	a.nr_sequencia = nr_seq_cpoe_p
	and		a.ie_tipo_dieta = 'O';
	
	dt_inicio_item_w := dt_inicio_w;
	
	for r_c07_w in c07
	loop
		select	max(a.dt_validade_prescr)
		into STRICT	dt_validade_prescr_w
		from	prescr_medica a
		where	a.nr_prescricao = r_c07_w.nr_prescricao;

		if (coalesce(nr_prescricao_auxiliar_w, 0) <> r_c07_w.nr_prescricao) then

			atualizar_validade_prescricao(	nr_prescricao_p => r_c07_w.nr_prescricao,
											dt_validade_prescr_p => dt_validade_prescr_w,
											dt_inicio_item_p => dt_inicio_item_w);

			dt_inicio_item_w := dt_inicio_item_w + 1;
			nr_prescricao_auxiliar_w := r_c07_w.nr_prescricao;

		end if;

		array_nr_prescricao_w(indice) := r_c07_w.nr_prescricao;

		indice := indice + 1;
	end loop;

	if (array_nr_prescricao_w.count > 0) then

		forall i in array_nr_prescricao_w.first .. array_nr_prescricao_w.last
			update	prescr_dieta a
			set		a.ds_observacao = ds_observacao_w,
					a.ds_horarios = ds_horarios_w,
					a.hr_prim_horario = hr_prim_horario_w,
					a.qt_parametro = qt_parametro_w,
					a.cd_dieta = cd_dieta_w,
					a.ie_gerar_horario = CASE WHEN a.ie_gerar_horario='N' THEN  'S'  ELSE a.ie_gerar_horario END ,
					a.nm_usuario = nm_usuario_p,
					a.dt_atualizacao = clock_timestamp()
			where	a.nr_prescricao = array_nr_prescricao_w(i)
			and		a.nr_seq_dieta_cpoe = nr_seq_cpoe_p;

	end if;
	
elsif (ie_tipo_item_p = 'SNE') then

	select	max(a.hr_prim_horario),
			max(a.dt_inicio),
			max(a.ds_horarios),
			max(a.ds_observacao_enf)
	into STRICT	hr_prim_horario_w,
			dt_inicio_w,
			ds_horarios_w,
			ds_observacao_enf_w
	from	cpoe_dieta a
	where	a.nr_sequencia = nr_seq_cpoe_p
	and		a.ie_tipo_dieta = 'E';

	dt_inicio_item_w := dt_inicio_w;

	for r_c08_w in c08
	loop
		select	max(a.dt_inicio_prescr),
				max(a.dt_validade_prescr)
		into STRICT	dt_inicio_prescr_w,
				dt_validade_prescr_w
		from	prescr_medica a
		where	a.nr_prescricao = r_c08_w.nr_prescricao;
		
		if (pkg_date_utils.start_of(source => dt_inicio_prescr_w, date_field => 'dd') < pkg_date_utils.start_of(source => dt_inicio_item_w, date_field => 'dd')) then
			qt_dia_prim_hor_w := 1;
		else
			qt_dia_prim_hor_w := 0;
		end if;

		CALL html_atualiza_quant_disp(	nr_prescricao_p => r_c08_w.nr_prescricao,
									nr_seq_cpoe_p => nr_seq_cpoe_p,
									ie_agrupador_p => 8,
									nm_usuario_p => nm_usuario_p,
									cd_estabelecimento_p => cd_estabelecimento_p);

		if (coalesce(nr_prescricao_auxiliar_w, 0) <> r_c08_w.nr_prescricao) then

			atualizar_validade_prescricao(	nr_prescricao_p => r_c08_w.nr_prescricao,
											dt_validade_prescr_p => dt_validade_prescr_w,
											dt_inicio_item_p => dt_inicio_item_w);

			dt_inicio_item_w := dt_inicio_item_w + 1;
			nr_prescricao_auxiliar_w := r_c08_w.nr_prescricao;
		end if;

		array_nr_prescricao_w(indice) := r_c08_w.nr_prescricao;
		array_qt_dia_prim_hor_w(indice) := qt_dia_prim_hor_w;

		indice := indice + 1;
	end loop;

	if (array_nr_prescricao_w.count > 0) then

		forall i in array_nr_prescricao_w.first .. array_nr_prescricao_w.last
			update	prescr_material a
			set		a.hr_prim_horario = hr_prim_horario_w,
					a.qt_dia_prim_hor = array_qt_dia_prim_hor_w(i),
					a.ds_horarios = ds_horarios_w,
					a.ds_observacao_enf = ds_observacao_enf_w,
					a.ie_gerar_horario = CASE WHEN a.ie_gerar_horario='N' THEN  'S'  ELSE a.ie_gerar_horario END ,
					a.nm_usuario = nm_usuario_p,
					a.dt_atualizacao = clock_timestamp()
			where	a.nr_prescricao = array_nr_prescricao_w(i)
			and		a.nr_seq_dieta_cpoe = nr_seq_cpoe_p
			and		coalesce(a.ie_suspenso, 'N') = 'N'
			and		a.ie_agrupador = 8;

		forall i in array_nr_prescricao_w.first .. array_nr_prescricao_w.last
			update	prescr_material a
			set		a.ie_gerar_horario = CASE WHEN a.ie_gerar_horario='N' THEN  'S'  ELSE a.ie_gerar_horario END ,
					a.nm_usuario = nm_usuario_p,
					a.dt_atualizacao = clock_timestamp()
			where	a.nr_prescricao = array_nr_prescricao_w(i)
			and		a.nr_seq_kit in (	SELECT	b.nr_sequencia
										from	prescr_material b
										where	b.nr_prescricao = a.nr_prescricao
										and		b.nr_seq_dieta_cpoe = nr_seq_cpoe_p
										and		coalesce(b.ie_suspenso, 'N') = 'N'
										and		b.ie_agrupador = 8)
			and		coalesce(a.nr_seq_recomendacao::text, '') = '';

	end if;
	
elsif (ie_tipo_item_p = 'LD') then

	select	max(a.dt_inicio),
			max(a.hr_prim_horario),
			max(a.cd_intervalo),
			max(a.ds_horarios)
	into STRICT	dt_inicio_w,
			hr_prim_horario_w,
			cd_intervalo_w,
			ds_horarios_w
	from	cpoe_dieta a
	where	a.nr_sequencia = nr_seq_cpoe_p
	and		a.ie_tipo_dieta = 'L';
	
	dt_inicio_item_w := dt_inicio_w;
	
	for r_c08_w in c08
	loop

		select	max(a.dt_inicio_prescr),
				max(a.dt_validade_prescr)
		into STRICT	dt_inicio_prescr_w,
				dt_validade_prescr_w
		from	prescr_medica a
		where	a.nr_prescricao = r_c08_w.nr_prescricao;

		if (pkg_date_utils.start_of(source => dt_inicio_prescr_w, date_field => 'dd') < pkg_date_utils.start_of(source => dt_inicio_item_w, date_field => 'dd')) then
			qt_dia_prim_hor_w := 1;
		else
			qt_dia_prim_hor_w := 0;
		end if;

		if (coalesce(nr_prescricao_auxiliar_w, 0) <> r_c08_w.nr_prescricao) then

			atualizar_validade_prescricao(	nr_prescricao_p => r_c08_w.nr_prescricao,
											dt_validade_prescr_p => dt_validade_prescr_w,
											dt_inicio_item_p => dt_inicio_item_w);

			dt_inicio_item_w := dt_inicio_item_w + 1;
			nr_prescricao_auxiliar_w := r_c08_w.nr_prescricao;

		end if;

		array_nr_prescricao_w(indice) := r_c08_w.nr_prescricao;
		array_qt_dia_prim_hor_w(indice) := qt_dia_prim_hor_w;

		indice := indice + 1;
	end loop;

	if (array_nr_prescricao_w.count > 0) then

		forall i in array_nr_prescricao_w.first .. array_nr_prescricao_w.last
			update	prescr_material a
			set		a.ds_horarios = ds_horarios_w,
					a.hr_prim_horario = hr_prim_horario_w,
					a.qt_dia_prim_hor = array_qt_dia_prim_hor_w(i),
					a.cd_intervalo = cd_intervalo_w,
					a.ie_gerar_horario = CASE WHEN a.ie_gerar_horario='N' THEN  'S'  ELSE a.ie_gerar_horario END ,
					a.nm_usuario = nm_usuario_p,
					a.dt_atualizacao = clock_timestamp()
			where	a.nr_prescricao = array_nr_prescricao_w(i)
			and		a.nr_seq_dieta_cpoe = nr_seq_cpoe_p
			and		coalesce(a.ie_suspenso, 'N') = 'N'
			and		a.ie_agrupador = 16;

		forall i in array_nr_prescricao_w.first .. array_nr_prescricao_w.last
			update	prescr_material a
			set		a.ie_gerar_horario = CASE WHEN a.ie_gerar_horario='N' THEN  'S'  ELSE a.ie_gerar_horario END ,
					a.nm_usuario = nm_usuario_p,
					a.dt_atualizacao = clock_timestamp()
			where	a.nr_prescricao = array_nr_prescricao_w(i)
			and		a.nr_seq_kit in (	SELECT	b.nr_sequencia
										from	prescr_material b
										where	b.nr_prescricao = a.nr_prescricao
										and		b.nr_seq_dieta_cpoe = nr_seq_cpoe_p
										and		coalesce(a.ie_suspenso, 'N') = 'N'
										and		a.ie_agrupador = 16)
			and		coalesce(a.nr_seq_recomendacao::text, '') = '';

	end if;

elsif (ie_tipo_item_p = 'R') then

	select	max(a.ds_observacao),
			max(a.ds_horarios),
			max(a.hr_prim_horario),
			max(a.dt_inicio),
			max(a.cd_intervalo),
			max(a.nr_ocorrencia)
	into STRICT	ds_observacao_w,
			ds_horarios_w,
			hr_prim_horario_w,
			dt_inicio_w,
			cd_intervalo_w,
			nr_ocorrencia_w
	from	cpoe_recomendacao a
	where	a.nr_sequencia = nr_seq_cpoe_p;
	
	dt_inicio_item_w := dt_inicio_w;

	for r_c04_w in c04
	loop
		select	max(a.dt_inicio_prescr),
				max(a.dt_validade_prescr)
		into STRICT	dt_inicio_prescr_w,
				dt_validade_prescr_w
		from	prescr_medica a
		where	a.nr_prescricao = r_c04_w.nr_prescricao;

		if (pkg_date_utils.start_of(source => dt_inicio_prescr_w, date_field => 'dd') < pkg_date_utils.start_of(source => dt_inicio_item_w, date_field => 'dd')) then
			qt_dia_prim_hor_w := 1;
		else
			qt_dia_prim_hor_w := 0;
		end if;

		if (coalesce(nr_prescricao_auxiliar_w, 0) <> r_c04_w.nr_prescricao) then

			atualizar_validade_prescricao(	nr_prescricao_p => r_c04_w.nr_prescricao,
											dt_validade_prescr_p => dt_validade_prescr_w,
											dt_inicio_item_p => dt_inicio_item_w);

			dt_inicio_item_w := dt_inicio_item_w + 1;
			nr_prescricao_auxiliar_w := r_c04_w.nr_prescricao;

		end if;

		array_nr_prescricao_w(indice) := r_c04_w.nr_prescricao;
		array_nr_seq_recomendacao_w(indice) := r_c04_w.nr_sequencia;
		array_qt_dia_prim_hor_w(indice) := qt_dia_prim_hor_w;

		indice := indice + 1;
	end loop;

	if (array_nr_prescricao_w.count > 0) then

		forall i in array_nr_prescricao_w.first .. array_nr_prescricao_w.last
			update	prescr_recomendacao a
			set		a.ds_observacao = ds_observacao_w,
					a.nr_ocorrencia = nr_ocorrencia_w,
					a.ds_horarios = ds_horarios_w,
					a.hr_prim_horario = hr_prim_horario_w,
					a.cd_intervalo = cd_intervalo_w,
					a.qt_dia_prim_hor = array_qt_dia_prim_hor_w(i),
					a.ie_gerar_horario = CASE WHEN a.ie_gerar_horario='N' THEN  'S'  ELSE a.ie_gerar_horario END ,
					a.nm_usuario = nm_usuario_p,
					a.dt_atualizacao = clock_timestamp()
			where	a.nr_prescricao = array_nr_prescricao_w(i)
			and		a.nr_seq_rec_cpoe = nr_seq_cpoe_p;

		forall i in array_nr_prescricao_w.first .. array_nr_prescricao_w.last
			update	prescr_material a
			set		a.ie_gerar_horario = CASE WHEN a.ie_gerar_horario='N' THEN  'S'  ELSE a.ie_gerar_horario END ,
					a.nm_usuario = nm_usuario_p,
					a.dt_atualizacao = clock_timestamp()
			where	a.nr_prescricao = array_nr_prescricao_w(i)
			and		a.nr_seq_kit = array_nr_seq_recomendacao_w(i)
			and		a.nr_seq_recomendacao = array_nr_seq_recomendacao_w(i);

	end if;
	
elsif (ie_tipo_item_p = 'HM') then
	select	max(a.dt_validade_prescr)
	into STRICT	dt_validade_prescr_w
	from	prescr_medica a
	where	a.nr_prescricao = nr_prescricao_p;

	select	max(a.dt_programada),
			max(a.ds_observacao_enf),
			max(a.ds_horarios),
			max(a.cd_intervalo)
	into STRICT	dt_inicio_w,
			ds_observacao_enf_w,
			ds_horarios_w,
			cd_intervalo_w
	from	cpoe_hemoterapia a
	where	a.nr_sequencia = nr_seq_cpoe_p;
	
	select	max(a.nr_sequencia)
	into STRICT	nr_seq_prescr_sangue_w
	from	prescr_solic_bco_sangue a
	where	a.nr_prescricao = nr_prescricao_p
	and		a.nr_seq_hemo_cpoe = nr_seq_cpoe_p;
	
	update	prescr_procedimento a
	set		a.dt_prev_execucao = dt_inicio_w,
			a.ds_observacao_enf = ds_observacao_enf_w,
			a.ds_horarios = ds_horarios_w,
			a.cd_intervalo = cd_intervalo_w,
			a.nm_usuario = nm_usuario_p,
			a.dt_atualizacao = clock_timestamp()
	where	a.nr_prescricao = nr_prescricao_p
	and		a.nr_seq_proc_cpoe = nr_seq_cpoe_p
	and		a.nr_seq_solic_sangue = nr_seq_prescr_sangue_w;

	atualizar_validade_prescricao(	nr_prescricao_p => nr_prescricao_p,
									dt_validade_prescr_p => dt_validade_prescr_w,
									dt_inicio_item_p => dt_inicio_w);
	
elsif (ie_tipo_item_p = 'O') then

	select	max(a.dt_inicio),
			max(a.hr_prim_horario),
			max(a.cd_intervalo),
			max(a.ds_horarios),
			max(a.ds_observacao_enf)
	into STRICT	dt_inicio_w,
			hr_prim_horario_w,
			cd_intervalo_w,
			ds_horarios_w,
			ds_observacao_enf_w
	from	cpoe_gasoterapia a
	where	a.nr_sequencia = nr_seq_cpoe_p;
	
	dt_inicio_item_w := dt_inicio_w;
	
	for r_c06_w in c06
	loop
		select	max(a.dt_inicio_prescr),
				max(a.dt_validade_prescr)
		into STRICT	dt_inicio_prescr_w,
				dt_validade_prescr_w
		from	prescr_medica a
		where	a.nr_prescricao = r_c06_w.nr_prescricao;

		if (dt_inicio_item_w IS NOT NULL AND dt_inicio_item_w::text <> '') then
			dt_prev_execucao_w := dt_inicio_item_w;
		end if;

		if (coalesce(nr_prescricao_auxiliar_w, 0) <> r_c06_w.nr_prescricao) then

			atualizar_validade_prescricao(	nr_prescricao_p => r_c06_w.nr_prescricao,
											dt_validade_prescr_p => dt_validade_prescr_w,
											dt_inicio_item_p => dt_inicio_item_w);

			dt_inicio_item_w := dt_inicio_item_w + 1;
			nr_prescricao_auxiliar_w := r_c06_w.nr_prescricao;

		end if;

		array_nr_prescricao_w(indice) := r_c06_w.nr_prescricao;
		array_nr_seq_gasoterapia_w(indice) := r_c06_w.nr_sequencia;
		array_dt_prev_execucao_w(indice) := dt_prev_execucao_w;

		indice := indice + 1;
	end loop;

	if (array_nr_prescricao_w.count > 0) then

		forall i in array_nr_prescricao_w.first .. array_nr_prescricao_w.last
			update	prescr_gasoterapia a
			set		a.dt_prev_execucao = array_dt_prev_execucao_w(i),
					a.cd_intervalo = cd_intervalo_w,
					a.ds_horarios = ds_horarios_w,
					a.ds_observacao_enf = ds_observacao_enf_w,
					a.ie_gerar_horario = CASE WHEN a.ie_gerar_horario='N' THEN  'S'  ELSE a.ie_gerar_horario END ,
					a.nm_usuario = nm_usuario_p,
					a.dt_atualizacao = clock_timestamp()
			where	a.nr_prescricao = array_nr_prescricao_w(i)
			and		a.nr_seq_gas_cpoe = nr_seq_cpoe_p;

		forall i in array_nr_prescricao_w.first .. array_nr_prescricao_w.last
			update	prescr_material a
			set		a.ie_gerar_horario = CASE WHEN a.ie_gerar_horario='N' THEN  'S'  ELSE a.ie_gerar_horario END ,
					a.nm_usuario = nm_usuario_p,
					a.dt_atualizacao = clock_timestamp()
			where	a.nr_prescricao = array_nr_prescricao_w(i)
			and		a.nr_seq_gasoterapia = array_nr_seq_gasoterapia_w(i);

	end if;

elsif (ie_tipo_item_p in ('NPTA', 'NPTI')) then

	select	max(a.dt_inicio),
			max(to_char(a.dt_inicio, 'hh24:mi')),
			max(a.cd_intervalo),
			max(a.qt_fase_npt)
	into STRICT	dt_inicio_w,
			hr_prim_horario_w,
			cd_intervalo_w,
			qt_fase_npt_w
	from	cpoe_dieta a
	where	a.nr_sequencia = nr_seq_cpoe_p
	and		a.ie_tipo_dieta in ('P', 'I');

	dt_inicio_item_w := dt_inicio_w;

	for r_c09_w in c09
	loop
		select	max(a.dt_inicio_prescr),
				max(a.dt_validade_prescr)
		into STRICT	dt_inicio_prescr_w,
				dt_validade_prescr_w
		from	prescr_medica a
		where	a.nr_prescricao = r_c09_w.nr_prescricao;

		if (coalesce(nr_prescricao_auxiliar_w, 0) <> r_c09_w.nr_prescricao) then

			atualizar_validade_prescricao(	nr_prescricao_p => r_c09_w.nr_prescricao,
											dt_validade_prescr_p => dt_validade_prescr_w,
											dt_inicio_item_p => dt_inicio_item_w);

			dt_inicio_item_w := dt_inicio_item_w + 1;
			nr_prescricao_auxiliar_w := r_c09_w.nr_prescricao;

		end if;

		array_nr_prescricao_w(indice) := r_c09_w.nr_prescricao;

		indice := indice + 1;
	end loop;

	if (array_nr_prescricao_w.count > 0) then

		forall i in array_nr_prescricao_w.first .. array_nr_prescricao_w.last
			update	nut_pac a
			set		a.hr_prim_horario = hr_prim_horario_w,
					a.qt_fase_npt = qt_fase_npt_w,
					a.ie_gerar_horario = CASE WHEN a.ie_gerar_horario='N' THEN  'S'  ELSE a.ie_gerar_horario END ,
					a.nm_usuario = nm_usuario_p,
					a.dt_atualizacao = clock_timestamp()
			where	a.nr_prescricao = array_nr_prescricao_w(i)
			and		a.nr_seq_npt_cpoe = nr_seq_cpoe_p
			and		coalesce(a.ie_suspenso, 'N') = 'N';

	end if;

end if;

CALL gpt_atualizar_gerar_horario(	nr_prescricao_vigente_p => nr_prescricao_vigente_w,
								nr_seq_cpoe_p => nr_seq_cpoe_p,
								ie_tipo_item_p => ie_tipo_item_p,
								nm_usuario_p => nm_usuario_p,
								cd_perfil_p => cd_perfil_p,
								cd_estabelecimento_p => cd_estabelecimento_p);
								
commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cpoe_atualizar_rep ( nr_prescricao_p prescr_medica.nr_prescricao%type, nr_seq_cpoe_p bigint, ie_tipo_item_p text, nm_usuario_p usuario.nm_usuario%type, cd_perfil_p perfil.cd_perfil%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type) FROM PUBLIC;

