-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE enviar_ci_gestor_conta ( nr_seq_ordem_serv_p bigint, nm_usuario_p text ) AS $body$
DECLARE


ds_macro_w		varchar(255);
ds_titulo_w		comunic_interna.ds_titulo%type;
ds_comunic_w		comunic_interna.ds_comunicado%type;
nm_usuario_gestor_w	comunic_interna.nm_usuario_destino%type;
nr_seq_cliente_W	com_cliente.nr_sequencia%type;
nr_seq_rtf_srtring_w	bigint;
ds_historico_os_w	tasy_conversao_rtf.ds_texto%type;


BEGIN

select	obter_usuario_gestor_conta(nr_seq_ordem_serv_p, 'S')
into STRICT	nm_usuario_gestor_w
;

nr_seq_rtf_srtring_w := converte_rtf_string('select ds_relat_tecnico from man_ordem_serv_tecnico where nr_seq_ordem_serv = :nr_sequencia_p', nr_seq_ordem_serv_p, nm_usuario_p, nr_seq_rtf_srtring_w);

ds_macro_w	:= 'NR_SEQ_ORDEM=' || nr_seq_ordem_serv_p;

select	coalesce(substr(ds_texto_clob, 4000, 1), obter_desc_exp_idioma(950391, wheb_usuario_pck.get_nr_seq_idioma, ds_macro_w))
into STRICT	ds_historico_os_w
from	tasy_conversao_rtf
where	nr_sequencia = nr_seq_rtf_srtring_w;

ds_titulo_w	:= obter_desc_exp_idioma(100329035, wheb_usuario_pck.get_nr_seq_idioma, ds_macro_w);
ds_comunic_w	:= substr(obter_desc_exp_idioma(100329037, wheb_usuario_pck.get_nr_seq_idioma, ds_macro_w)
			|| chr(10) || chr(13) || chr(10) || chr(13) ||
			obter_desc_expressao(508099)/*'Último histórico: '*/
			|| chr(10) || chr(13) || ds_historico_os_w,1,4000);


	CALL gerar_comunic_padrao( clock_timestamp(), ds_titulo_w, ds_comunic_w,
			nm_usuario_p, 'N', nm_usuario_gestor_w || ',',
			'N', 5, null,
			null, null, clock_timestamp(),
			null, null);

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE enviar_ci_gestor_conta ( nr_seq_ordem_serv_p bigint, nm_usuario_p text ) FROM PUBLIC;

