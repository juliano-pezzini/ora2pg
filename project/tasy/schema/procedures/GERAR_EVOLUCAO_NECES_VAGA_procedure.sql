-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_evolucao_neces_vaga ( nr_seq_gestao_vaga_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint) AS $body$
DECLARE


ie_evolucao_clinica_w 	varchar(3) := null;
ds_evolucao_w  			varchar(32000);
ds_descricao_tmp		varchar(4000) := null;
nr_atendimento_w  		bigint;
dt_atualizacao_w 		timestamp;
nm_usuario_w 			varchar(15);
dt_solicitacao_w 		timestamp;
ie_solicitacao_w 		varchar(15);
ie_tipo_vaga_w  		varchar(15);
cd_setor_desejado_w 		integer;
cd_acomodacao_desejada_w 	bigint;
cd_motivo_transf_w 		bigint;
ds_hd_w 				varchar(4000);
cd_cid_principal_w 		varchar(10);
ie_necessita_isolamento_w  	varchar(1);
ie_necessita_dialise_w 		varchar(1);
cd_unid_basica_w 		varchar(10);
cd_unid_compl_w 		varchar(10);
cd_funcionario_w 		varchar(10);
nr_seq_classif_medico_w bigint;
qt_dia_w 				smallint;
ie_opme_w 				varchar(1);
ie_quimioterapia_w 		varchar(1);
dt_atualizacao_nrec_w 		timestamp;
qt_acompanhante_w 			bigint;
cd_departamento_desejado_w 	bigint;
ie_tipo_isolamento_w 		varchar(15);
ie_agendamento_cirurgico_w 	varchar(15);
ie_solic_uti_eci_w 			varchar(1);
nr_seq_linha_cuidado_w 		bigint;
nr_seq_prioridade_w 		bigint;
dt_admission_w 			timestamp;
ds_risks_w  			varchar(2048);
CD_SPECIALTY_w 			integer;
IE_PRIVATE_ROOM_w 		varchar(5);

cd_tipo_acomodacao_w	bigint;
cd_convenio_w			bigint;
cd_setor_atendimento_w	bigint;
ie_clinica_w		bigint;
cd_pessoa_fisica_w	varchar(10):=null;
cd_categoria_w		varchar(10);
ds_codigo_usuario_w	varchar(30);
ds_complemento_w	varchar(30);
dt_validade_w		timestamp;
cd_plano_w			varchar(10);
cd_procedimento_w	bigint;
ie_origem_proced_w	bigint;
dt_prevista_w		timestamp;
ie_status_w			varchar(1);
ds_observacao_w		varchar(4000);
cd_especialidade_w	bigint;
nr_seq_proc_interno_w	bigint;
ie_tipo_atend_w			atendimento_paciente.ie_tipo_atendimento%type;
nr_seq_classif_atend_w	atendimento_paciente.nr_seq_classificacao%type;
ie_tipo_evolucao_w 		usuario.ie_tipo_evolucao%type;
cd_medico_w 			usuario.cd_pessoa_fisica%type;

c01 CURSOR FOR
SELECT 	cd_procedimento,
		ie_origem_proced
from 	gestao_vaga_proc
where 	nr_seq_gestao = nr_seq_gestao_vaga_p;


BEGIN

select	coalesce(max(obter_valor_param_usuario(281, 1570, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p)),'N')
into STRICT	ie_evolucao_clinica_w
;

if ((nr_seq_gestao_vaga_p IS NOT NULL AND nr_seq_gestao_vaga_p::text <> '') and ie_evolucao_clinica_w <> 'N') then

	select	max(cd_pessoa_fisica),
			max(dt_atualizacao),
			max(nm_usuario),
			max(dt_solicitacao),
			max(ie_solicitacao),
			max(cd_convenio),
			max(cd_categoria),
			max(ie_status),
			max(ie_tipo_vaga),
			max(nr_atendimento),
			max(cd_tipo_acomod_atual),
			max(cd_setor_atual),
			max(cd_setor_desejado),
			max(cd_tipo_acomod_desej),
			max(cd_medico),
			max(ie_clinica),
			max(nr_seq_motivo_transf),
			max(ds_cod_usuario),
			max(ds_compl),
			max(dt_validade),
			max(cd_plano_convenio),
			max(ds_hd),
			max(cd_procedimento),
			max(ie_origem_proced),
			max(nr_seq_proc_interno),
			max(cd_cid_principal),
			max(ie_necessita_isolamento),
			max(ie_necessita_dialise),
			max(dt_prevista),
			max(ds_observacao),
			max(cd_unidade_basica),
			max(cd_unidade_compl),
			max(cd_especialidade),
			max(cd_funcionario),
			max(nr_seq_classif_medico),
			max(qt_dia),
			max(ie_opme),
			max(ie_quimioterapia),
			max(nm_usuario_nrec),
			max(dt_atualizacao_nrec),
			max(qt_acompanhante),
			max(cd_departamento_desejado),
			max(ie_tipo_isolamento),
			max(ie_agendamento_cirurgico),
			max(ie_solic_uti_eci),
			max(nr_seq_linha_cuidado),
			max(nr_seq_prioridade),
			max(DT_ADMISSION),
			max(DS_RISKS),
			max(CD_SPECIALTY),
			max(IE_PRIVATE_ROOM),
			max(ie_tipo_atendimento),
			max(nr_seq_classif_atend)
	into STRICT
			cd_pessoa_fisica_w,
			dt_atualizacao_w,
			nm_usuario_w,
			dt_solicitacao_w,
			ie_solicitacao_w,
			cd_convenio_w,
			cd_categoria_w,
			ie_status_w,
			ie_tipo_vaga_w,
			nr_atendimento_w,
			cd_tipo_acomodacao_w,
			cd_setor_atendimento_w,
			cd_setor_desejado_w,
			cd_acomodacao_desejada_w,
			cd_medico_w,
			ie_clinica_w,
			cd_motivo_transf_w,
			ds_codigo_usuario_w,
			ds_complemento_w,
			dt_validade_w,
			cd_plano_w,
			ds_hd_w,
			cd_procedimento_w,
			ie_origem_proced_w,
			nr_seq_proc_interno_w,
			cd_cid_principal_w,
			ie_necessita_isolamento_w,
			ie_necessita_dialise_w,
			dt_prevista_w,
			ds_observacao_w,
			cd_unid_basica_w,
			cd_unid_compl_w,
			cd_especialidade_w,
			cd_funcionario_w,
			nr_seq_classif_medico_w,
			qt_dia_w,
			ie_opme_w,
			ie_quimioterapia_w,
			nm_usuario_w,
			dt_atualizacao_nrec_w,
			qt_acompanhante_w,
			cd_departamento_desejado_w,
			ie_tipo_isolamento_w,
			ie_agendamento_cirurgico_w,
			ie_solic_uti_eci_w,
			nr_seq_linha_cuidado_w,
			nr_seq_prioridade_w,
			DT_ADMISSION_w,
			DS_RISKS_w,
			CD_SPECIALTY_w,
			IE_PRIVATE_ROOM_w,
			ie_tipo_atend_w,
			nr_seq_classif_atend_w
	from 	gestao_vaga
	where	nr_sequencia = nr_seq_gestao_vaga_p;

	ds_evolucao_w	:= wheb_rtf_pck.GET_CABECALHO;
	if ((trim(both ie_solicitacao_w) IS NOT NULL AND (trim(both ie_solicitacao_w))::text <> '')) then
		ds_descricao_tmp := wheb_rtf_pck.get_quebra_linha||
		wheb_rtf_pck.get_negrito(true)||obter_expressao_idioma(300009)||': '||
		wheb_rtf_pck.get_negrito(false)||OBTER_DESCRICAO_DOMINIO(1407, ie_solicitacao_w);
		ds_evolucao_w	:= ds_evolucao_w ||wheb_rtf_pck.get_quebra_linha||ds_descricao_tmp;
	end if;
	if ((trim(both ie_tipo_vaga_w) IS NOT NULL AND (trim(both ie_tipo_vaga_w))::text <> '')) then
		ds_descricao_tmp := wheb_rtf_pck.get_negrito(true)|| obter_expressao_idioma(299726)||': '||
		wheb_rtf_pck.get_negrito(false)||OBTER_DESCRICAO_DOMINIO(1410, ie_tipo_vaga_w);
		ds_evolucao_w	:= ds_evolucao_w ||wheb_rtf_pck.get_quebra_linha||ds_descricao_tmp;
	end if;
	if ((trim(both cd_motivo_transf_w) IS NOT NULL AND (trim(both cd_motivo_transf_w))::text <> '')) then
		ds_descricao_tmp := wheb_rtf_pck.get_negrito(true)|| obter_expressao_idioma(325609)||': '||
		wheb_rtf_pck.get_negrito(false)||Obter_desc_motivo_transf_pac(cd_motivo_transf_w);
		ds_evolucao_w	:= ds_evolucao_w ||wheb_rtf_pck.get_quebra_linha||ds_descricao_tmp;
	end if;
	if ((trim(both cd_setor_desejado_w) IS NOT NULL AND (trim(both cd_setor_desejado_w))::text <> '')) then
		ds_descricao_tmp := wheb_rtf_pck.get_negrito(true)|| obter_expressao_idioma(298399)||': '||
		wheb_rtf_pck.get_negrito(false)||obter_nome_setor(cd_setor_desejado_w);
		ds_evolucao_w	:= ds_evolucao_w ||wheb_rtf_pck.get_quebra_linha||ds_descricao_tmp;
	end if;
	if ((trim(both cd_especialidade_w) IS NOT NULL AND (trim(both cd_especialidade_w))::text <> '')) then
		ds_descricao_tmp := wheb_rtf_pck.get_negrito(true)|| obter_expressao_idioma(289431)||': '||
		wheb_rtf_pck.get_negrito(false)||Obter_Desc_Espec_medica(cd_especialidade_w);
		ds_evolucao_w	:= ds_evolucao_w ||wheb_rtf_pck.get_quebra_linha||ds_descricao_tmp;
	end if;
	if ((trim(both nr_seq_prioridade_w) IS NOT NULL AND (trim(both nr_seq_prioridade_w))::text <> '')) then
		ds_descricao_tmp := wheb_rtf_pck.get_negrito(true)|| obter_expressao_idioma(296328)||': '||
		wheb_rtf_pck.get_negrito(false)||OBTER_PRIORIDADE_REGULACAO(nr_seq_prioridade_w);
		ds_evolucao_w	:= ds_evolucao_w ||wheb_rtf_pck.get_quebra_linha||ds_descricao_tmp;
	end if;
	if ((trim(both cd_acomodacao_desejada_w) IS NOT NULL AND (trim(both cd_acomodacao_desejada_w))::text <> '')) then
		ds_descricao_tmp := wheb_rtf_pck.get_negrito(true)|| obter_expressao_idioma(283163)||': '||
		wheb_rtf_pck.get_negrito(false)||OBTER_DESC_TIPO_ACOMOD(cd_acomodacao_desejada_w);
		ds_evolucao_w	:= ds_evolucao_w ||wheb_rtf_pck.get_quebra_linha||ds_descricao_tmp;
	end if;
	if ((trim(both cd_convenio_w) IS NOT NULL AND (trim(both cd_convenio_w))::text <> '')) then
		ds_descricao_tmp := wheb_rtf_pck.get_negrito(true)|| obter_expressao_idioma(286193)||': '||
		wheb_rtf_pck.get_negrito(false)||OBTER_DESC_CONVENIO(cd_convenio_w);
		ds_evolucao_w	:= ds_evolucao_w ||wheb_rtf_pck.get_quebra_linha||ds_descricao_tmp;
	end if;
	if ((trim(both cd_categoria_w) IS NOT NULL AND (trim(both cd_categoria_w))::text <> '')	) then
		ds_descricao_tmp := wheb_rtf_pck.get_negrito(true)|| obter_expressao_idioma(286193)||': '||
		wheb_rtf_pck.get_negrito(false)||OBTER_CATEGORIA_CONVENIO(cd_convenio_w, cd_categoria_w);
		ds_evolucao_w	:= ds_evolucao_w ||wheb_rtf_pck.get_quebra_linha||ds_descricao_tmp;
	end if;
	if ((trim(both cd_plano_w) IS NOT NULL AND (trim(both cd_plano_w))::text <> '')) then
		ds_descricao_tmp := wheb_rtf_pck.get_negrito(true)|| obter_expressao_idioma(295945)||': '||
		wheb_rtf_pck.get_negrito(false)||Obter_Desc_Plano_Conv(cd_convenio_w, cd_plano_w);
		ds_evolucao_w	:= ds_evolucao_w ||wheb_rtf_pck.get_quebra_linha||ds_descricao_tmp;
	end if;
	if ((trim(both IE_PRIVATE_ROOM_w) IS NOT NULL AND (trim(both IE_PRIVATE_ROOM_w))::text <> '')) then
		ds_descricao_tmp := wheb_rtf_pck.get_negrito(true)|| obter_expressao_idioma(489743)||': '||
		wheb_rtf_pck.get_negrito(false)||OBTER_EXPRESSAO_SIM_NAO(IE_PRIVATE_ROOM_w);
		ds_evolucao_w	:= ds_evolucao_w ||wheb_rtf_pck.get_quebra_linha||ds_descricao_tmp;
	end if;
	if ((trim(both nr_seq_classif_medico_w) IS NOT NULL AND (trim(both nr_seq_classif_medico_w))::text <> '')) then
		ds_descricao_tmp := wheb_rtf_pck.get_negrito(true)|| obter_expressao_idioma(285122)||': '||
		wheb_rtf_pck.get_negrito(false)||Obter_classif_medico(nr_seq_classif_medico_w);
		ds_evolucao_w	:= ds_evolucao_w ||wheb_rtf_pck.get_quebra_linha||ds_descricao_tmp;
	end if;
	if ((trim(both cd_funcionario_w) IS NOT NULL AND (trim(both cd_funcionario_w))::text <> '')) then
		ds_descricao_tmp := wheb_rtf_pck.get_negrito(true)|| obter_expressao_idioma(330144)||': '||
		wheb_rtf_pck.get_negrito(false)||obter_nome_pf(cd_funcionario_w);
		ds_evolucao_w	:= ds_evolucao_w ||wheb_rtf_pck.get_quebra_linha||ds_descricao_tmp;
	end if;
	if ((trim(both cd_medico_w) IS NOT NULL AND (trim(both cd_medico_w))::text <> '')) then
		ds_descricao_tmp := wheb_rtf_pck.get_negrito(true)|| obter_expressao_idioma(293090)||': '||
		wheb_rtf_pck.get_negrito(false)||obter_nome_pf(cd_medico_w);
		ds_evolucao_w	:= ds_evolucao_w ||wheb_rtf_pck.get_quebra_linha||ds_descricao_tmp;
	end if;
	if ((trim(both cd_procedimento_w) IS NOT NULL AND (trim(both cd_procedimento_w))::text <> '')) then
		ds_descricao_tmp := wheb_rtf_pck.get_negrito(true)|| obter_expressao_idioma(296422)||': '||
		wheb_rtf_pck.get_negrito(false)||Obter_Desc_Proc_Inter(cd_procedimento_w, ie_origem_proced_w);
		ds_evolucao_w	:= ds_evolucao_w ||wheb_rtf_pck.get_quebra_linha||ds_descricao_tmp;
	end if;
	if ((trim(both ds_hd_w) IS NOT NULL AND (trim(both ds_hd_w))::text <> '')) then
		ds_descricao_tmp := wheb_rtf_pck.get_negrito(true)|| obter_expressao_idioma(291307)||': '||
		wheb_rtf_pck.get_negrito(false)||ds_hd_w;
		ds_evolucao_w	:= ds_evolucao_w ||wheb_rtf_pck.get_quebra_linha||ds_descricao_tmp;
	end if;
	if ((trim(both ie_clinica_w) IS NOT NULL AND (trim(both ie_clinica_w))::text <> '')) then
		ds_descricao_tmp := wheb_rtf_pck.get_negrito(true)|| obter_expressao_idioma(285160)||': '||
		wheb_rtf_pck.get_negrito(false)||OBTER_DESCRICAO_DOMINIO(17, ie_clinica_w);
		ds_evolucao_w	:= ds_evolucao_w ||wheb_rtf_pck.get_quebra_linha||ds_descricao_tmp;
	end if;
	if ((trim(both cd_cid_principal_w) IS NOT NULL AND (trim(both cd_cid_principal_w))::text <> '')) then
		ds_descricao_tmp := wheb_rtf_pck.get_negrito(true)|| obter_expressao_idioma(284902)||': '||
		wheb_rtf_pck.get_negrito(false)||cd_cid_principal_w||' - '|| OBTER_DESC_CID(cd_cid_principal_w);
		ds_evolucao_w	:= ds_evolucao_w ||wheb_rtf_pck.get_quebra_linha||ds_descricao_tmp;
	end if;
	if ((trim(both qt_dia_w) IS NOT NULL AND (trim(both qt_dia_w))::text <> '')) then
		ds_descricao_tmp := wheb_rtf_pck.get_negrito(true)|| obter_expressao_idioma(740579)||': '||
		wheb_rtf_pck.get_negrito(false)||qt_dia_w;
		ds_evolucao_w	:= ds_evolucao_w ||wheb_rtf_pck.get_quebra_linha||ds_descricao_tmp;
	end if;
	if ((trim(both qt_acompanhante_w) IS NOT NULL AND (trim(both qt_acompanhante_w))::text <> '')) then
		ds_descricao_tmp := wheb_rtf_pck.get_negrito(true)|| obter_expressao_idioma(629006)||': '||
		wheb_rtf_pck.get_negrito(false)||qt_acompanhante_w;
		ds_evolucao_w	:= ds_evolucao_w ||wheb_rtf_pck.get_quebra_linha||ds_descricao_tmp;
	end if;
	if ((trim(both ie_necessita_dialise_w) IS NOT NULL AND (trim(both ie_necessita_dialise_w))::text <> '')) then
		ds_descricao_tmp := wheb_rtf_pck.get_negrito(true)|| obter_expressao_idioma(328343)||': '||
		wheb_rtf_pck.get_negrito(false)||OBTER_EXPRESSAO_SIM_NAO(ie_necessita_dialise_w);
		ds_evolucao_w	:= ds_evolucao_w ||wheb_rtf_pck.get_quebra_linha||ds_descricao_tmp;
	end if;
	if ((trim(both ie_necessita_isolamento_w) IS NOT NULL AND (trim(both ie_necessita_isolamento_w))::text <> '')) then
		ds_descricao_tmp := wheb_rtf_pck.get_negrito(true)|| obter_expressao_idioma(328342)||': '||
		wheb_rtf_pck.get_negrito(false)||OBTER_EXPRESSAO_SIM_NAO(ie_necessita_isolamento_w);
		ds_evolucao_w	:= ds_evolucao_w ||wheb_rtf_pck.get_quebra_linha||ds_descricao_tmp;
	end if;
	if ((trim(both ie_opme_w) IS NOT NULL AND (trim(both ie_opme_w))::text <> '')) then
		ds_descricao_tmp := wheb_rtf_pck.get_negrito(true)|| obter_expressao_idioma(657636)||': '||
		wheb_rtf_pck.get_negrito(false)||OBTER_EXPRESSAO_SIM_NAO(ie_opme_w);
		ds_evolucao_w	:= ds_evolucao_w ||wheb_rtf_pck.get_quebra_linha||ds_descricao_tmp;
	end if;
	if ((trim(both ie_quimioterapia_w) IS NOT NULL AND (trim(both ie_quimioterapia_w))::text <> '')) then
		ds_descricao_tmp := wheb_rtf_pck.get_negrito(true)|| obter_expressao_idioma(330866)||': '||
		wheb_rtf_pck.get_negrito(false)||OBTER_EXPRESSAO_SIM_NAO(ie_quimioterapia_w);
		ds_evolucao_w	:= ds_evolucao_w ||wheb_rtf_pck.get_quebra_linha||ds_descricao_tmp;
	end if;
	if ((trim(both ds_observacao_w) IS NOT NULL AND (trim(both ds_observacao_w))::text <> '')) then
		ds_descricao_tmp := wheb_rtf_pck.get_negrito(true)|| obter_expressao_idioma(294639)||': '||
		wheb_rtf_pck.get_negrito(false)||ds_observacao_w;
		ds_evolucao_w	:= ds_evolucao_w ||wheb_rtf_pck.get_quebra_linha||ds_descricao_tmp;
	end if;

	open C01;
	loop
	fetch C01 into
				cd_procedimento_w,
				ie_origem_proced_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
		if ((trim(both cd_procedimento_w) IS NOT NULL AND (trim(both cd_procedimento_w))::text <> '')) then
			ds_descricao_tmp := wheb_rtf_pck.get_negrito(true)|| obter_expressao_idioma(307683)||': '||
			wheb_rtf_pck.get_negrito(false)||Obter_Desc_Proc_Inter(cd_procedimento_w, ie_origem_proced_w);
			ds_evolucao_w	:= ds_evolucao_w ||wheb_rtf_pck.get_quebra_linha||ds_descricao_tmp;
		end if;
	end;
	end loop;
	close C01;

	ds_evolucao_w	:= ds_evolucao_w||wheb_rtf_pck.get_rodape;

	select 	max(ie_tipo_evolucao)
	into STRICT 	ie_tipo_evolucao_w
	from 	usuario
	where 	nm_usuario =  nm_usuario_p;

	insert into evolucao_paciente(	cd_evolucao,
									dt_evolucao,
									ie_tipo_evolucao,
									cd_pessoa_fisica,
									dt_atualizacao,
									nm_usuario,
									nr_atendimento,
									ds_evolucao,
									cd_medico,
									dt_liberacao,
									ie_evolucao_clinica,
									ie_situacao)
			values (	nextval('evolucao_paciente_seq'),
						clock_timestamp(),
						ie_tipo_evolucao_w,
						cd_pessoa_fisica_w,
						clock_timestamp(),
						nm_usuario_w,
						nr_atendimento_w,
						ds_evolucao_w,
						cd_medico_w,
						clock_timestamp(),
						ie_evolucao_clinica_w,
						'A');
	commit;
end if;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_evolucao_neces_vaga ( nr_seq_gestao_vaga_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint) FROM PUBLIC;

