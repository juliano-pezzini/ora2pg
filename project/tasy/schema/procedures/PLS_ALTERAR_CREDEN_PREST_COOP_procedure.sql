-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_alterar_creden_prest_coop (nr_seq_cooperado_p bigint, ie_acao_p text, nm_usuario_p text) AS $body$
DECLARE


/* ######  IE_ACAO_P ##### */

/*    C    -   Credenciamento	*/

/*    D    -   Descredenciamento	*/

/*####################*/

nr_seq_prestador_w		bigint;
cd_pessoa_fisica_w		varchar(10);
cd_cgc_w			varchar(14);
dt_exclusao_w			timestamp;

C01 CURSOR FOR
	SELECT	a.nr_sequencia
	from	pls_prestador a
	where	a.cd_pessoa_fisica	= cd_pessoa_fisica_w
	or	a.cd_cgc		= cd_cgc_w;


BEGIN

if (coalesce(nr_seq_cooperado_p,0) > 0) then
	select	cd_pessoa_fisica,
		cd_cgc,
		dt_exclusao
	into STRICT	cd_pessoa_fisica_w,
		cd_cgc_w,
		dt_exclusao_w
	from	pls_cooperado
	where	nr_sequencia	= nr_seq_cooperado_p;

	open C01;
	loop
	fetch C01 into
		nr_seq_prestador_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin
		CALL pls_alterar_sit_prestador(null, nr_seq_prestador_w, nr_seq_cooperado_p, ie_acao_p , nm_usuario_p);
		end;
	end loop;
	close C01;

	if (ie_acao_p = 'D') and (coalesce(cd_pessoa_fisica_w,'X') <> 'X') then
		update	pls_prestador_medico
		set	nm_usuario	= nm_usuario_p,
			dt_atualizacao	= clock_timestamp(),
			dt_exclusao	= dt_exclusao_w
		where	cd_medico	= cd_pessoa_fisica_w
		and	(cd_medico IS NOT NULL AND cd_medico::text <> '');
	end if;
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_alterar_creden_prest_coop (nr_seq_cooperado_p bigint, ie_acao_p text, nm_usuario_p text) FROM PUBLIC;

