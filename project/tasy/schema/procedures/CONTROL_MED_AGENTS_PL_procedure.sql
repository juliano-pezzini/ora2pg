-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE control_med_agents_pl (nr_seq_pepo_agent_med_p text default null, nr_seq_modelo_secao_p bigint DEFAULT NULL, nm_usuario_p text DEFAULT NULL, nr_seq_agent_anest_mat_p text default null) AS $body$
WITH RECURSIVE cte AS (
DECLARE


ora2pg_rowcount int;
agenListList CURSOR FOR
SELECT (regexp_substr(nr_seq_pepo_agent_med_p,'[^,]+', 1, level))::numeric  as nr_seq_pepo_agent_med, (regexp_substr(nr_seq_agent_anest_mat_p,'[^,]+', 1, level))::numeric  as nr_seq_agent_anest_mat, row_number() OVER () as seq
  (regexp_substr(nr_seq_pepo_agent_med_p, '[^,]+', 1, level) IS NOT NULL AND (regexp_substr(nr_seq_pepo_agent_med_p, '[^,]+', 1, level))::text <> '')
  UNION ALL
DECLARE


agenListList CURSOR FOR
SELECT (regexp_substr(nr_seq_pepo_agent_med_p,'[^,]+', 1, level))::numeric  as nr_seq_pepo_agent_med, (regexp_substr(nr_seq_agent_anest_mat_p,'[^,]+', 1, level))::numeric  as nr_seq_agent_anest_mat, row_number() OVER () as seq 
  (regexp_substr(nr_seq_pepo_agent_med_p, '[^,]+', 1, level) IS NOT NULL AND (regexp_substr(nr_seq_pepo_agent_med_p, '[^,]+', 1, level))::text <> '')
 JOIN cte c ON ()

) SELECT * FROM cte
union

select nr_seq_pepo_agent_med, nr_seq_agent_anest_mat, 0 as seq from pepo_modelo_secao_agt_med
where nr_seq_modelo_secao = nr_seq_modelo_secao_p and nr_seq_agent_anest_mat not in (WITH RECURSIVE cte AS (

select regexp_substr(nr_seq_agent_anest_mat_p,'[^,]+', 1, level)  
  (regexp_substr(nr_seq_agent_anest_mat_p, '[^,]+', 1, level) IS NOT NULL AND (regexp_substr(nr_seq_agent_anest_mat_p, '[^,]+', 1, level))::text <> '')
  UNION ALL

select regexp_substr(nr_seq_agent_anest_mat_p,'[^,]+', 1, level) JOIN cte c ON ()

) SELECT * FROM cte;
)
order by seq;
;

nr_sequencia_reorder_p bigint;
nr_order_p integer;

BEGIN

if (coalesce(nr_seq_agent_anest_mat_p::text, '') = '') then
	delete
	  from pepo_modelo_secao_agt_med
	 where nr_seq_modelo_secao = nr_seq_modelo_secao_p;
else

	for r1 in agenListList loop
		if (r1.seq = 0) then
		delete
		  from pepo_modelo_secao_agt_med
		 where nr_seq_modelo_secao = nr_seq_modelo_secao_p
		   and nr_seq_agent_anest_mat = r1.nr_seq_agent_anest_mat
		   and nr_seq_pepo_agent_med = r1.nr_seq_pepo_agent_med;
	else
		begin
			update pepo_modelo_secao_agt_med
			   set nr_seq_apresentacao = r1.seq
		     where nr_seq_modelo_secao = nr_seq_modelo_secao_p
			   and nr_seq_agent_anest_mat = r1.nr_seq_agent_anest_mat
		       and nr_seq_pepo_agent_med = r1.nr_seq_pepo_agent_med;
			GET DIAGNOSTICS ora2pg_rowcount = ROW_COUNT;
if ora2pg_rowcount = 0 then
				insert into
				pepo_modelo_secao_agt_med(
						nr_sequencia,
						dt_atualizacao,
						nm_usuario,
						dt_atualizacao_nrec,
						nm_usuario_nrec,
						nr_seq_apresentacao,
						nr_seq_pepo_agent_med,
						nr_seq_modelo_secao,
						nr_seq_agent_anest_mat
						) values (
						nextval('pepo_modelo_secao_agt_med_seq'),
						clock_timestamp(),
						nm_usuario_p,
						clock_timestamp(),
						nm_usuario_p,
						r1.seq,
						r1.nr_seq_pepo_agent_med,
						nr_seq_modelo_secao_p,
						r1.nr_seq_agent_anest_mat
						);
			end if;
		end;
    end if;
	end loop;
end if;
commit;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE control_med_agents_pl (nr_seq_pepo_agent_med_p text default null, nr_seq_modelo_secao_p bigint DEFAULT NULL, nm_usuario_p text DEFAULT NULL, nr_seq_agent_anest_mat_p text default null) FROM PUBLIC;

