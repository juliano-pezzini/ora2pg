-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_solic_parecer_cot_compra ( nr_sequencia_p bigint, nm_usuario_p text) AS $body$
DECLARE


nr_cot_compra_w			bigint;
dt_historico_w			timestamp;
ds_titulo_w			varchar(80);
ds_historico_w			varchar(4000);
ie_origem_w			varchar(1);
ie_tipo_w				varchar(1);
dt_liberacao_w			timestamp;
nm_usuario_lib_w 			varchar(15);
ds_usuarios_envio_comunic_w	varchar(255);
nm_usuario_w			varchar(15);
nr_seq_hist_w			bigint;

C01 CURSOR FOR
	SELECT	b.nm_usuario
	from	cot_compra_hist a,
		usuario b
	where	b.nm_usuario <> a.nm_usuario_lib
	and	(a.ds_usuarios_envio_comunic IS NOT NULL AND a.ds_usuarios_envio_comunic::text <> '')
	and	substr(obter_se_contido_char(b.nm_usuario,replace(a.ds_usuarios_envio_comunic,' ',null)),1,1) = 'S'
	and	a.nr_sequencia = nr_sequencia_p
	and	not exists (	SELECT 	1
				from 	cot_compra_hist x
				where 	x.nr_seq_superior = a.nr_sequencia
				and 	x.ds_usuarios_envio_comunic like(b.nm_usuario)
				and	x.ie_evento = 'E')
	group by b.nm_usuario;

BEGIN
select	nr_cot_compra,
	dt_historico,
	ds_titulo,
	ds_historico,
	ie_origem,
	ie_tipo,
	dt_liberacao,
	ds_usuarios_envio_comunic,
	nm_usuario_lib
into STRICT	nr_cot_compra_w,
	dt_historico_w,
	ds_titulo_w,
	ds_historico_w,
	ie_origem_w,
	ie_tipo_w,
	dt_liberacao_w,
	ds_usuarios_envio_comunic_w,
	nm_usuario_lib_w
from	cot_compra_hist
where	nr_sequencia = nr_sequencia_p;

ds_historico_w := substr(WHEB_MENSAGEM_PCK.get_texto(302224,'NR_COT_COMPRA_W='|| NR_COT_COMPRA_W ||';DS_HISTORICO_W='|| DS_HISTORICO_W),1,4000);
			/*Solicitação de parecer cotação de compra #@NR_COT_COMPRA_W#@. #@DS_HISTORICO_W#@*/

open C01;
loop
fetch C01 into
	nm_usuario_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin

	select	nextval('cot_compra_hist_seq')
	into STRICT	nr_seq_hist_w
	;

	insert into cot_compra_hist(
		nr_sequencia,
		nr_cot_compra,
		dt_historico,
		ds_titulo,
		ds_historico,
		ie_origem,
		ie_tipo,
		dt_liberacao,
		ds_usuarios_envio_comunic,
		nm_usuario_nrec,
		nm_usuario,
		nm_usuario_lib,
		dt_atualizacao_nrec,
		dt_atualizacao,
		nr_seq_superior,
		ie_evento)
	values (nr_seq_hist_w,
		nr_cot_compra_w,
		dt_historico_w,
		ds_titulo_w,
		ds_historico_w,
		ie_origem_w,
		ie_tipo_w,
		dt_liberacao_w,
		nm_usuario_w,
		nm_usuario_p,
		nm_usuario_p,
		nm_usuario_lib_w,
		clock_timestamp(),
		clock_timestamp(),
		nr_sequencia_p,
		'E');

	insert into cot_compra_anexo(
		nr_sequencia,
		dt_atualizacao,
		nm_usuario,
		dt_atualizacao_nrec,
		nm_usuario_nrec,
		nr_cot_compra,
		ds_arquivo,
		ie_enviar,
		ie_origem,
		nr_seq_parecer)
	SELECT	nextval('cot_compra_anexo_seq'),
		clock_timestamp(),
		nm_usuario_p,
		clock_timestamp(),
		nm_usuario_p,
		nr_cot_compra,
		ds_arquivo,
		'S',
		'U',
		nr_seq_hist_w
	from	cot_compra_anexo
	where	nr_cot_compra  = nr_cot_compra_w
	and	nr_seq_parecer = nr_sequencia_p;

	end;
end loop;
close C01;

commit;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_solic_parecer_cot_compra ( nr_sequencia_p bigint, nm_usuario_p text) FROM PUBLIC;

