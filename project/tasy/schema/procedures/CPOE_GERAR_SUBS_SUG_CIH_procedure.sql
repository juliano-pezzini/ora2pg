-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE cpoe_gerar_subs_sug_cih ( nr_seq_medic_cih_p bigint, nm_usuario_p text) AS $body$
DECLARE


cd_intervalo_cih_w				medicamento_cih_sug.cd_intervalo%type;
cd_material_cih_w				medicamento_cih_sug.cd_material%type;
cd_material_substituicao_cih_w	medicamento_cih_sug.cd_material_substituicao%type;
cd_unidade_medida_dose_cih_w	medicamento_cih_sug.cd_unidade_medida_dose%type;
ie_via_aplicacao_cih_w			medicamento_cih_sug.ie_via_aplicacao%type;
qt_dias_liberado_cih_w			medicamento_cih_sug.qt_dias_liberado%type;
qt_dias_solicitado_cih_w		medicamento_cih_sug.qt_dias_solicitado%type;
qt_dose_cih_w					medicamento_cih_sug.qt_dose%type;

nr_seq_material_w				cpoe_material.nr_sequencia%type;
nr_seq_material_new_w			cpoe_material.nr_sequencia%type;

nr_prescricao_w                 prescr_material.nr_prescricao%type;
nr_seq_prescricao_w				prescr_material.nr_sequencia%type;

ds_stack_w						log_cpoe.ds_stack%type;
ds_log_cpoe_w					log_cpoe.ds_log%type;


BEGIN

select	max(a.NR_SEQ_MAT_CPOE),
		max(b.nr_prescricao),
		max(b.nr_seq_prescricao)
into STRICT	nr_seq_material_w,
		nr_prescricao_w,
		nr_seq_prescricao_w
from	prescr_material a,
		prescr_mat_comunic_cih b
where	b.nr_sequencia 	= nr_seq_medic_cih_p
and		a.nr_prescricao = b.nr_prescricao
and		a.nr_sequencia  =  b.nr_seq_prescricao;

select	max(cd_intervalo),
		max(cd_material),
		max(cd_material_substituicao),
		max(cd_unidade_medida_dose),
		max(ie_via_aplicacao),
		max(qt_dias_liberado),
		max(qt_dias_solicitado),
		max(qt_dose)
into STRICT	cd_intervalo_cih_w,
		cd_material_cih_w,
		cd_material_substituicao_cih_w,
		cd_unidade_medida_dose_cih_w,
		ie_via_aplicacao_cih_w,
		qt_dias_liberado_cih_w,
		qt_dias_solicitado_cih_w,
		qt_dose_cih_w
from	medicamento_cih_sug
where	nr_prescricao	=	nr_prescricao_w
and		NR_SEQ_MATERIAL	=	nr_seq_prescricao_w;


nr_seq_material_new_w := CPOE_DUPLICAR_REGISTRO('cpoe_material', nm_usuario_p, nr_seq_material_w, nr_seq_material_new_w);

update	CPOE_MATERIAL
set		ie_via_aplicacao		=	coalesce(ie_via_aplicacao_cih_w, ie_via_aplicacao),
		cd_intervalo			=	coalesce(cd_intervalo_cih_w, cd_intervalo),
		qt_dias_liberado		=	coalesce(qt_dias_liberado_cih_w, qt_dias_liberado),
		qt_dias_solicitado		=	coalesce(qt_dias_solicitado_cih_w, qt_dias_solicitado),
		IE_MODIFICADO			=	'C'
where	nr_sequencia			=	nr_seq_material_new_w;

update	CPOE_MATERIAL
set		CD_MATERIAL 			=	coalesce(cd_material_substituicao_cih_w,CD_MAT_COMP1), -- alterar para o cd_material
		QT_DOSE					=	coalesce(qt_dose_cih_w, QT_DOSE),
		CD_UNIDADE_MEDIDA 		=	coalesce(cd_unidade_medida_dose_cih_w, CD_UNIDADE_MEDIDA)
where	nr_sequencia			=	nr_seq_material_new_w 
and		cd_material				=	cd_material_cih_w;

update	CPOE_MATERIAL
set		CD_MAT_COMP1			=	coalesce(cd_material_substituicao_cih_w,CD_MAT_COMP1),
		QT_DOSE_COMP1			=	coalesce(qt_dose_cih_w, QT_DOSE_COMP1),
		CD_UNID_MED_DOSE_COMP1	=	coalesce(cd_unidade_medida_dose_cih_w, CD_UNID_MED_DOSE_COMP1)
where	nr_sequencia			=	nr_seq_material_new_w 
and		CD_MAT_COMP1			=	cd_material_cih_w;

update	CPOE_MATERIAL
set		CD_MAT_COMP2			=	coalesce(cd_material_substituicao_cih_w,CD_MAT_COMP2),
		QT_DOSE_COMP2			=	coalesce(qt_dose_cih_w, QT_DOSE_COMP2),
		CD_UNID_MED_DOSE_COMP2	=	coalesce(cd_unidade_medida_dose_cih_w, CD_UNID_MED_DOSE_COMP2)
where	nr_sequencia			=	nr_seq_material_new_w 
and		CD_MAT_COMP2			=	cd_material_cih_w;
	
update	CPOE_MATERIAL	
set		CD_MAT_COMP3			=	coalesce(cd_material_substituicao_cih_w,CD_MAT_COMP3),
		QT_DOSE_COMP3			=	coalesce(qt_dose_cih_w, QT_DOSE_COMP3),
		CD_UNID_MED_DOSE_COMP3	=	coalesce(cd_unidade_medida_dose_cih_w, CD_UNID_MED_DOSE_COMP3)	
where	nr_sequencia			=	nr_seq_material_new_w
and		CD_MAT_COMP3			=	cd_material_cih_w;


	exception
	   when others then

		ds_stack_w	:= substr(dbms_utility.format_call_stack,1,2000);
		ds_log_cpoe_w := substr('ERROR: CPOE_GERAR_SUBS_SUG_CIH'
			||  CHR(10) || '| nr_seq_medic_cih_p: ' || NR_SEQ_MEDIC_CIH_P
			||  CHR(10) || '| nm_usuario_p: ' || NM_USUARIO_P
			||  CHR(10) || '| nr_seq_material_w: ' || NR_SEQ_MATERIAL_W
			||  CHR(10) || '| nr_seq_material_new_w: ' || NR_SEQ_MATERIAL_NEW_W
			||  CHR(10) || ' - ERRO: ' || sqlerrm 
			|| chr(13) || ' - FUNCAO('||to_char(obter_funcao_ativa)||'); PERFIL('||to_char(obter_perfil_ativo)||')',1,2000);
			
		insert into log_cpoe(
			nr_sequencia,
			dt_atualizacao, 
			nm_usuario, 
			ds_log, 
			ds_stack) 
		values (
			nextval('log_cpoe_seq'),
			clock_timestamp(), 
			nm_usuario_p, 
			ds_log_cpoe_w, 
			ds_stack_w);
			
		commit;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cpoe_gerar_subs_sug_cih ( nr_seq_medic_cih_p bigint, nm_usuario_p text) FROM PUBLIC;

