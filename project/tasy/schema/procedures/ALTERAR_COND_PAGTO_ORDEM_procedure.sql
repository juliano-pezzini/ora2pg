-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE alterar_cond_pagto_ordem ( nr_ordem_compra_p bigint, cd_condicao_pagamento_p text, cd_estabelecimento_p bigint, nm_usuario_p text) AS $body$
DECLARE

 
qt_registros_w			integer;
ds_cond_pagto_original_w	varchar(80);
ds_cond_pagto_alterado_w	varchar(80);
ds_historico_w			varchar(4000);

BEGIN
 
select	count(*) 
into STRICT	qt_registros_w 
from	nota_fiscal_item 
where	nr_ordem_compra = nr_ordem_compra_p;
 
if (qt_registros_w > 0) then 
	CALL wheb_mensagem_pck.exibir_mensagem_abort(240174);
end if;
 
if (cd_condicao_pagamento_p <> '0') then 
	select	obter_desc_cond_pagto(cd_condicao_pagamento), 
		obter_desc_cond_pagto(cd_condicao_pagamento_p) 
	into STRICT	ds_cond_pagto_original_w, 
		ds_cond_pagto_alterado_w 
	from	ordem_compra 
	where	nr_ordem_compra = nr_ordem_compra_p;
 
	update	ordem_compra 
	set	cd_condicao_pagamento = cd_condicao_pagamento_p 
	where	nr_ordem_compra = nr_ordem_compra_p;
 
	delete from ordem_compra_venc where nr_ordem_compra = nr_ordem_compra_p;
 
	CALL gerar_ordem_compra_venc(nr_ordem_compra_p,nm_usuario_p);
	 
	 
	/*Alterado o valor do campo Cond. pagamento, através da opção Alterar condição de pagamento. 
	De: #@DS_VALOR_OLD#@. 
	Para: #@DS_VALOR_NEW#@.*/
 
	ds_historico_w := substr(wheb_mensagem_pck.get_texto(297085, 'DS_VALOR_OLD=' || ds_cond_pagto_original_w || ';DS_VALOR_NEW=' || ds_cond_pagto_alterado_w),1,4000);
 
	CALL inserir_historico_ordem_compra(	nr_ordem_compra_p, 
					'S', 
					wheb_mensagem_pck.get_texto(297086)/*Alteração de Condição de pagamento.*/
, 
					ds_historico_w, 
					nm_usuario_p);
end if;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE alterar_cond_pagto_ordem ( nr_ordem_compra_p bigint, cd_condicao_pagamento_p text, cd_estabelecimento_p bigint, nm_usuario_p text) FROM PUBLIC;

