-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE inserir_med_proc_w_item_prescr ( nr_prescricao_p bigint, nr_seq_item_p bigint, nm_usuario_p text, ie_origem_p bigint, cd_kit_material_p bigint, cd_procedimento_p bigint) AS $body$
DECLARE


/*
Ie_origem_p
1- Procedimento NÃ£o-Laboratorial
2- Procedimento Laboratorial
7- Procedimento Protocolo
*/
cd_procedimento_w		bigint;
ie_origem_proced_w		integer;
cd_procedimento_ww		bigint := null;
ie_origem_proced_ww		integer := null;
nr_proc_interno_w		bigint := null;
cd_pessoa_fisica_w		varchar(15);
qt_idade_pac_w			double precision;
qt_idade_pac_ww			real;
cd_setor_atendimento_w	integer;
cd_material_w			integer;
cd_unidade_medida_w		varchar(30);
ie_mostrar_item_w		varchar(30);
qt_dose_w				double precision;
nr_sequencia_w			bigint;
cont_w					bigint;
ie_duplicar_w			varchar(30);
nr_seq_item_w			bigint;
qt_inseridos_w			integer := 0;
cd_estabelecimento_w	bigint;
cd_medico_w				bigint;
ie_recem_nato_w			varchar(1);
nr_atendimento_w		bigint;
cd_medico_ww			varchar(10);
cd_protocolo_ww			integer;
nr_sequencia_ww			integer;
nr_seq_proc_ww			integer;
nr_seq_item_ww			bigint;
qt_peso_w				prescr_medica.qt_peso%type;

C01 CURSOR FOR
SELECT	a.nr_sequencia,
		a.cd_material,
		a.cd_unidade_medida,
		a.qt_dose,
		'S'
from	procedimento_mat_prescr a
where	1 = 1
and 	not exists (	select	1
					from	W_item_prescr k
					where	1 = 1
					and		a.cd_material		= k.cd_material
					and		k.cd_protocolo(cd_procedimento_w, cd_procedimento_ww, nr_proc_interno_w)
					and		k.ie_origem_inf in ('PI', 'P')
					and		k.nr_prescricao	= nr_prescricao_p)
and		((cd_setor_atendimento_w = a.cd_setor_atendimento) or (coalesce(a.cd_setor_atendimento::text, '') = ''))
and		(((coalesce(qt_idade_pac_ww::text, '') = '') or (coalesce(a.qt_idade_min::text, '') = '' and coalesce(a.qt_idade_max::text, '') = '')) or
		 ((qt_idade_pac_ww IS NOT NULL AND qt_idade_pac_ww::text <> '') and (qt_idade_pac_ww between coalesce(a.qt_idade_min,qt_idade_pac_w) and coalesce(a.qt_idade_max,qt_idade_pac_w))))
and		a.ie_origem_proced	= ie_origem_proced_w
and		a.cd_procedimento	= cd_procedimento_w
order by
	coalesce(a.cd_setor_atendimento,999);

C02 CURSOR FOR
SELECT	a.nr_sequencia,
		a.cd_material,
		a.cd_unidade_medida,
		a.qt_dose,
		coalesce(a.ie_mostrar_item,'S'),
		coalesce(a.ie_duplicar,'S')
from	proc_int_mat_prescr a
where	1 = 1
and		Obter_se_mat_setor(a.nr_sequencia, cd_setor_atendimento_w, a.cd_convenio_exc, obter_tipo_atendimento(nr_atendimento_w)) = 'S'
and		not exists (	Select	1
					from		w_item_prescr k
					where	k.nr_prescricao	= nr_prescricao_p
					and		k.ie_origem_inf in ('PI', 'P')
					and		k.cd_material 	= a.cd_material
					and 		k.cd_protocolo in (cd_procedimento_w, cd_procedimento_ww, nr_proc_interno_w))
and		coalesce(qt_idade_pac_w,1) between coalesce(obter_idade_mat_int_prescr(a.nr_sequencia,'MIN'),0) and coalesce(obter_idade_mat_int_prescr(a.nr_sequencia,'MAX'),9999999)
and		((cd_setor_atendimento_w = a.cd_setor_atendimento) or (coalesce(a.cd_setor_atendimento::text, '') = ''))
and		((coalesce(a.cd_medico::text, '') = '') or (a.cd_medico = cd_medico_ww))
and		((coalesce(a.cd_estabelecimento::text, '') = '') or (a.cd_estabelecimento = wheb_usuario_pck.get_cd_estabelecimento))
and		a.nr_seq_proc_interno	= nr_proc_interno_w
and		coalesce(qt_peso_w,0) between coalesce(a.qt_peso_min,0) and coalesce(a.qt_peso_max,999)
and		coalesce(a.ie_situacao,'A')	= 'A'
order by
	coalesce(a.cd_setor_atendimento,999);

C03 CURSOR FOR
SELECT	distinct c.nr_sequencia,
		c.cd_material,
		c.qt_material,
		coalesce(c.cd_unidade_medida_prescr, substr(obter_dados_material_estab(c.cd_material,cd_estabelecimento_w,'UMS'),1,30))
from	material d,
        componente_kit c,
        kit_material x
where	1 = 1
and		x.cd_kit_material	= c.cd_kit_material
and		c.ie_situacao		= 'A'
and		c.cd_material     	= d.cd_material
and		((coalesce(c.cd_estab_regra::text, '') = '') or (c.cd_estab_regra = cd_estabelecimento_w))
and		((c.ie_recem_nato =  coalesce(ie_recem_nato_w, 'A')) or (coalesce(c.ie_recem_nato, 'A') = 'A'))
and (obter_se_comp_kit_rep(c.cd_kit_material,c.nr_sequencia,cd_medico_w) = 'S')
and 	coalesce(c.cd_convenio,0) = (	select coalesce(max(y.cd_convenio), 0)
									from	componente_kit y
									where	y.cd_kit_material = c.cd_kit_material
									and		y.cd_material	  = c.cd_material
									and		y.cd_convenio     = Obter_Convenio_Atendimento(nr_atendimento_w)
									and		((coalesce(y.cd_estab_regra::text, '') = '') or (y.cd_estab_regra = cd_estabelecimento_w)))
and 	coalesce(c.ie_tipo_convenio,0) = (	select coalesce(max(y.ie_tipo_convenio), 0)
									from	componente_kit y
									where	y.cd_kit_material = c.cd_kit_material
									and		y.cd_material	  = c.cd_material
									and		y.ie_tipo_convenio     = (select ie_tipo_convenio from convenio where cd_convenio = Obter_Convenio_Atendimento(nr_atendimento_w))
									and		((coalesce(y.cd_estab_regra::text, '') = '') or (y.cd_estab_regra = cd_estabelecimento_w)))
and 	not exists (	select	1
					from	W_item_prescr k
					where	c.cd_material	  = k.cd_material
					and		k.cd_procedimento = cd_procedimento_p
					and		k.cd_kit_material = cd_kit_material_p
					and		k.nr_prescricao	  = nr_prescricao_p)
and		x.ie_situacao		= 'A'
and		x.cd_kit_material	= cd_kit_material_p;

C04 CURSOR FOR
SELECT	a.cd_protocolo||a.nr_sequencia||a.cd_material,
		a.cd_material,
		a.cd_unidade_medida,
		a.qt_dose,
		'S'
from	protocolo_medic_material a
where	1 = 1
and 	not exists(	select	1
					from	W_item_prescr k
					where	1 = 1
					and		a.cd_material		= k.cd_material
					and		k.cd_protocolo(cd_procedimento_w, cd_procedimento_ww, nr_proc_interno_w)
					and		k.ie_origem_inf in ('PI', 'P')
					and 	((k.nr_seq_solucao = coalesce(nr_seq_item_p,k.nr_seq_solucao)) or (coalesce(k.nr_seq_solucao::text, '') = ''))
					and		k.nr_prescricao	= nr_prescricao_p)
and		(a.cd_material IS NOT NULL AND a.cd_material::text <> '')
and		a.nr_seq_proc	= nr_seq_proc_ww
and		a.nr_sequencia	= nr_sequencia_ww
and		a.cd_protocolo	= cd_protocolo_ww;


BEGIN

cd_medico_ww	:= Obter_Pf_Usuario(nm_usuario_p,'C');

if (coalesce(cd_procedimento_p::text, '') = '') then
	if (ie_origem_p = 1) then
		select  max(cd_procedimento),
				max(ie_origem_proced),
				max(nr_proc_interno)
		into STRICT	cd_procedimento_w,
				ie_origem_proced_w,
				nr_proc_interno_w
		from 	procedimento_rotina
		where 	nr_sequencia = nr_seq_item_p;
	elsif (ie_origem_p = 7) then
		begin
		select	max(a.cd_procedimento),
				max(a.ie_origem_proced),
				max(a.nr_seq_proc_interno),
				max(a.cd_protocolo),
				max(a.nr_sequencia),
				max(a.nr_seq_proc)
		into STRICT	cd_procedimento_w,
				ie_origem_proced_w,
				nr_proc_interno_w,
				cd_protocolo_ww,
				nr_sequencia_ww,
				nr_seq_proc_ww
		from    protocolo_medic_proc a,
				protocolo_medicacao b,
				protocolo c
		where	b.cd_protocolo = c.cd_protocolo
		and     a.cd_protocolo = b.cd_protocolo
		and     a.nr_sequencia = b.nr_sequencia
		and     coalesce(b.IE_SITUACAO,'A') = 'A'
		and     coalesce(c.IE_SITUACAO,'A') = 'A'
		and		a.cd_protocolo||a.nr_sequencia||a.nr_seq_proc = nr_seq_item_p;
		end;
	else
		select  max(b.cd_procedimento),
				max(b.ie_origem_proced),
				max(null) nr_proc_interno
		into STRICT	cd_procedimento_w,
				ie_origem_proced_w,
				nr_proc_interno_w
		from 	exame_lab_rotina a,
				exame_laboratorio b
		where 	a.nr_seq_exame = b.nr_seq_exame
		and		a.nr_sequencia = nr_seq_item_p;
	end if;

end if;

if (nr_proc_interno_w IS NOT NULL AND nr_proc_interno_w::text <> '') then

	select  max(a.cd_procedimento),
			max(a.ie_origem_proced)
	into STRICT 	cd_procedimento_ww,
			ie_origem_proced_ww
	from 	proc_interno a
	where 	a.nr_sequencia = nr_proc_interno_w;

	if (coalesce(cd_procedimento_w,0) = 0) then
		if (coalesce(cd_procedimento_ww,0) > 0) then
			cd_procedimento_w	:= cd_procedimento_ww;
		else
			cd_procedimento_w	:= nr_proc_interno_w;
		end if;
	end if;

end if;

select	max(cd_pessoa_fisica),
		max(cd_setor_Atendimento),
		max(cd_estabelecimento),
		max(cd_medico),
		coalesce(max(ie_recem_nato),'A'),
		max(nr_atendimento),
		obter_idade_pf(max(cd_pessoa_fisica), clock_timestamp(), 'A'),
		max(coalesce(qt_peso,obter_sinal_vital(nr_atendimento,'PESO')))
into STRICT	cd_pessoa_fisica_w,
		cd_setor_atendimento_w,
		cd_estabelecimento_w,
		cd_medico_w,
		ie_recem_nato_w,
		nr_atendimento_w,
		qt_idade_pac_ww,
		qt_peso_w
from	prescr_medica
where	nr_prescricao = nr_prescricao_p;

begin
select	max(obter_idade(b.dt_nascimento,coalesce(b.dt_obito,clock_timestamp()),'DIA'))
into STRICT	qt_idade_pac_w
from	pessoa_fisica b
where	b.cd_pessoa_fisica	= cd_pessoa_fisica_w;
exception
when others then
	qt_idade_pac_w	:= 0;
end;
qt_inseridos_w	:= 0;

select	max(x.cd_protocolo)||max(x.nr_sequencia)||max(x.cd_material)
into STRICT	nr_seq_item_ww
from	protocolo_medic_material x
where	(x.cd_material IS NOT NULL AND x.cd_material::text <> '')
and		x.nr_seq_proc	= nr_seq_proc_ww
and		x.nr_sequencia	= nr_sequencia_ww
and		x.cd_protocolo	= cd_protocolo_ww;

if (coalesce(cd_procedimento_p::text, '') = '') and (coalesce(cd_kit_material_p::text, '') = '') then
	delete  from w_item_prescr
	where	1 = 1
	and 	(nr_seq_item in (SELECT nr_sequencia
				from	procedimento_mat_prescr a
				where	1 = 1
				and		a.cd_procedimento	in (cd_procedimento_w, cd_procedimento_ww)
				and		a.ie_origem_proced	in (ie_origem_proced_w, ie_origem_proced_ww)
				and		((cd_setor_atendimento_w = a.cd_setor_atendimento) or (coalesce(a.cd_setor_atendimento::text, '') = ''))
				and		(((coalesce(qt_idade_pac_ww::text, '') = '') or (coalesce(a.qt_idade_min::text, '') = '' and coalesce(a.qt_idade_max::text, '') = '')) or
						 ((qt_idade_pac_ww IS NOT NULL AND qt_idade_pac_ww::text <> '') and (qt_idade_pac_ww between coalesce(a.qt_idade_min,qt_idade_pac_w) and coalesce(a.qt_idade_max,qt_idade_pac_w))))
				
union all

				SELECT 	a.nr_sequencia
				from	proc_int_mat_prescr a
				where	1 = 1
				and		a.nr_seq_proc_interno	= nr_proc_interno_w
				and		Obter_se_mat_setor(a.nr_sequencia, cd_setor_atendimento_w, null,obter_tipo_atendimento(nr_atendimento_w)) = 'N'
				and		((cd_setor_atendimento_w = a.cd_setor_atendimento) or (coalesce(a.cd_setor_atendimento::text, '') = ''))
				and		coalesce(qt_idade_pac_w,1) between coalesce(obter_idade_mat_int_prescr(a.nr_sequencia,'MIN'),0) and coalesce(obter_idade_mat_int_prescr(a.nr_sequencia,'MAX'),9999999)
				and		coalesce(qt_peso_w,0) between coalesce(a.qt_peso_min,0) and coalesce(a.qt_peso_max,999)) or
				nr_seq_item = nr_seq_item_ww)
	and 	ie_origem_inf in ('P', 'PI')
	and 	cd_protocolo in (cd_procedimento_w, cd_procedimento_ww, nr_proc_interno_w)
	and		nm_usuario = nm_usuario_p
	and		nr_prescricao = nr_prescricao_p;

	commit;

	open C04;
	loop
	fetch C04 into
		nr_seq_item_w,
		cd_material_w,
		cd_unidade_medida_w,
		qt_dose_w,
		ie_duplicar_w;
	EXIT WHEN NOT FOUND; /* apply on C04 */
		begin

		select 	nextval('w_item_prescr_seq')
		into STRICT	nr_sequencia_w
		;

		insert into W_Item_Prescr(
			nr_sequencia,
			dt_atualizacao,
			nm_usuario,
			nr_prescricao,
			cd_protocolo,
			nr_seq_item,
			qt_dose,
			cd_material,
			ie_origem_inf,
			nr_seq_solucao,
			cd_unidade_medida,
			ie_excluido)
		Values (
			nr_sequencia_w,
			clock_timestamp(),
			nm_usuario_p,
			nr_prescricao_p,
			cd_procedimento_w,
			nr_seq_item_w,
			qt_dose_w,
			cd_material_w,
			'P',
			nr_seq_item_p,
			cd_unidade_medida_w,
			CASE WHEN ie_duplicar_w='S' THEN 'N'  ELSE 'S' END );

			qt_inseridos_w	:= qt_inseridos_w + 1;
		end;
	end loop;
	close C04;

	commit;

	if (qt_inseridos_w = 0 ) then

		open C02;
		loop
		fetch C02 into
			nr_seq_item_w,
			cd_material_w,
			cd_unidade_medida_w,
			qt_dose_w,
			ie_mostrar_item_w,
			ie_duplicar_w;
		EXIT WHEN NOT FOUND; /* apply on C02 */
			begin

			if (ie_duplicar_w = 'N') then
				select	count(*)
				into STRICT	cont_w
				from	W_Item_Prescr
				where	cd_material	= cd_material_w
				and	nr_prescricao	= nr_prescricao_p
				and	nm_usuario = nm_usuario_p;

				if (cont_w = 0) then
					ie_duplicar_w	:= 'S';
				end if;
			end if;

			select 	nextval('w_item_prescr_seq')
			into STRICT	nr_sequencia_w
			;

			insert into W_Item_Prescr(
				nr_sequencia,
				dt_atualizacao,
				nm_usuario,
				nr_prescricao,
				cd_protocolo,
				nr_seq_item,
				qt_dose,
				cd_material,
				ie_origem_inf,
				nr_seq_solucao,
				cd_unidade_medida,
				ie_mostrar_item,
				ie_excluido)
			Values (
				nr_sequencia_w,
				clock_timestamp(),
				nm_usuario_p,
				nr_prescricao_p,
				nr_proc_interno_w,
				nr_seq_item_w,
				qt_dose_w,
				cd_material_w,
				'PI',
				nr_seq_item_p,
				cd_unidade_medida_w,
				ie_mostrar_item_w,
				CASE WHEN ie_duplicar_w='S' THEN 'N'  ELSE 'S' END );

				qt_inseridos_w	:= qt_inseridos_w + 1;
			end;
		end loop;
		close C02;
	end if;

	commit;

	if (qt_inseridos_w = 0 ) then
		open C01;
		loop
		fetch C01 into
			nr_seq_item_w,
			cd_material_w,
			cd_unidade_medida_w,
			qt_dose_w,
			ie_duplicar_w;
		EXIT WHEN NOT FOUND; /* apply on C01 */
			begin

			select 	nextval('w_item_prescr_seq')
			into STRICT	nr_sequencia_w
			;

			insert into W_Item_Prescr(
				nr_sequencia,
				dt_atualizacao,
				nm_usuario,
				nr_prescricao,
				cd_protocolo,
				nr_seq_item,
				qt_dose,
				cd_material,
				ie_origem_inf,
				nr_seq_solucao,
				cd_unidade_medida,
				ie_excluido)
			Values (
				nr_sequencia_w,
				clock_timestamp(),
				nm_usuario_p,
				nr_prescricao_p,
				cd_procedimento_w,
				nr_seq_item_w,
				qt_dose_w,
				cd_material_w,
				'P',
				nr_seq_item_p,
				cd_unidade_medida_w,
				CASE WHEN ie_duplicar_w='S' THEN 'N'  ELSE 'S' END );
			end;
		end loop;
		close C01;

		commit;

		if (cd_procedimento_ww IS NOT NULL AND cd_procedimento_ww::text <> '') then
			cd_procedimento_w	:= cd_procedimento_ww;
			ie_origem_proced_w	:= ie_origem_proced_ww;
			open C01;
			loop
			fetch C01 into
				nr_seq_item_w,
				cd_material_w,
				cd_unidade_medida_w,
				qt_dose_w,
				ie_duplicar_w;
			EXIT WHEN NOT FOUND; /* apply on C01 */
				begin

				select 	nextval('w_item_prescr_seq')
				into STRICT	nr_sequencia_w
				;

				insert into W_Item_Prescr(
					nr_sequencia,
					dt_atualizacao,
					nm_usuario,
					nr_prescricao,
					cd_protocolo,
					nr_seq_item,
					qt_dose,
					cd_material,
					ie_origem_inf,
					nr_seq_solucao,
					cd_unidade_medida,
					ie_excluido)
				Values (
					nr_sequencia_w,
					clock_timestamp(),
					nm_usuario_p,
					nr_prescricao_p,
					cd_procedimento_w,
					nr_seq_item_w,
					qt_dose_w,
					cd_material_w,
					'P',
					nr_seq_item_p,
					cd_unidade_medida_w,
					CASE WHEN ie_duplicar_w='S' THEN 'N'  ELSE 'S' END );

				end;
				qt_inseridos_w	:= qt_inseridos_w + 1;
			end loop;
			close C01;

			commit;
		end if;
	end if;
elsif (cd_kit_material_p IS NOT NULL AND cd_kit_material_p::text <> '') then

	open C03;
	loop
	fetch C03 into
		nr_seq_item_w,
		cd_material_w,
		qt_dose_w,
		cd_unidade_medida_w;
	EXIT WHEN NOT FOUND; /* apply on C03 */
		begin

		select 	nextval('w_item_prescr_seq')
		into STRICT	nr_sequencia_w
		;

		insert into W_Item_Prescr(
					nr_sequencia,
					dt_atualizacao,
					nm_usuario,
					nr_prescricao,
					cd_procedimento,
					nr_seq_item,
					qt_dose,
					cd_material,
					ie_origem_inf,
					nr_seq_solucao,
					cd_unidade_medida,
					ie_excluido,
					cd_kit_material,
					cd_protocolo)
			Values (
					nr_sequencia_w,
					clock_timestamp(),
					nm_usuario_p,
					nr_prescricao_p,
					cd_procedimento_p,
					nr_seq_item_w,
					qt_dose_w,
					cd_material_w,
					'P',
					0,
					cd_unidade_medida_w,
					'N',
					cd_kit_material_p,
					0);
		end;
	end loop;
	close C03;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE inserir_med_proc_w_item_prescr ( nr_prescricao_p bigint, nr_seq_item_p bigint, nm_usuario_p text, ie_origem_p bigint, cd_kit_material_p bigint, cd_procedimento_p bigint) FROM PUBLIC;

