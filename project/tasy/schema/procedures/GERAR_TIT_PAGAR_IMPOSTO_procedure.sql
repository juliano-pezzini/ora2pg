-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_tit_pagar_imposto (nr_sequencia_p bigint, nm_usuario_p text) AS $body$
DECLARE


cd_tributo_w			bigint;
cd_estabelecimento_w		smallint;
cd_cgc_w			varchar(20);
cd_pessoa_fisica_w		varchar(20);
CD_BENEFICIARIO_w		varchar(20);
ie_acumulativo_w		varchar(1);
PR_ALIQUOTA_w			double precision;
CD_COND_PAGTO_w		bigint;
CD_CONTA_FINANC_w		bigint;
NR_SEQ_TRANS_REG_w		bigint;
NR_SEQ_TRANS_BAIXA_w		bigint;
vl_minimo_base_w		double precision;
vl_minimo_tributo_w		double precision;
vl_teto_base_w		double precision;
vl_desc_dependente_w		double precision;
cd_darf_w			varchar(20);
dt_referencia_w			timestamp;
cd_variacao_w			varchar(2)	:= null;
ie_periodicidade_w		varchar(1)	:= null;
ds_irrelevante_w			varchar(4000);
nr_seq_classe_w			bigint;
cd_tipo_baixa_neg_w		integer;
vl_base_calculo_w		double precision;
nr_seq_classe_tit_w		bigint;
nr_seq_trib_cp_w		bigint;
ie_origem_titulo_w		titulo_pagar.ie_origem_titulo%type;
ie_gerar_titulo_pagar_w	tributo.ie_gerar_titulo_pagar%type;
nr_seq_trib_cp_tit_w	titulo_pagar_imposto.nr_seq_trib_cp%type;


BEGIN

select	max(a.cd_tributo),
	max(b.cd_estabelecimento),
	max(b.cd_cgc),
	max(b.cd_pessoa_fisica),
	max(a.vl_base_calculo),
	max(b.nr_seq_classe),
	max(b.ie_origem_titulo),
	max(a.nr_seq_trib_cp)
into STRICT	cd_tributo_w,
	cd_estabelecimento_w,
	cd_cgc_w,
	cd_pessoa_fisica_w,
	vl_base_calculo_w,
	nr_seq_classe_tit_w,
	ie_origem_titulo_w,
	nr_seq_trib_cp_tit_w
from	titulo_pagar b,
	titulo_pagar_imposto a
where	a.nr_titulo	= b.nr_titulo
and	a.nr_sequencia	= nr_sequencia_p;

select	max(a.ie_gerar_titulo_pagar)
into STRICT	ie_gerar_titulo_pagar_w
from	tributo a
where	a.cd_tributo	= cd_tributo_w;

if (coalesce(ie_gerar_titulo_pagar_w,'N') = 'S') or /*OS 1317851 - Tratado para somente gerar o titulo de tributo se estiver parametrizado como Sim no tributo a geração do título*/
   (coalesce(nr_seq_trib_cp_tit_w::text, '') = '') then /*OS 1377873 - Se for um tributo lançado manualmente no título não tera regra vinculado, então deve gerar o título*/
SELECT * FROM obter_dados_trib_tit_pagar(cd_tributo_w, CD_ESTABELECIMENTO_w, cd_cgc_w, cd_pessoa_fisica_w, CD_BENEFICIARIO_w, PR_ALIQUOTA_w, CD_COND_PAGTO_w, CD_CONTA_FINANC_w, NR_SEQ_TRANS_REG_w, NR_SEQ_TRANS_BAIXA_w, vl_minimo_base_w, vl_minimo_tributo_w, ie_acumulativo_w, vl_teto_base_w, vl_desc_dependente_w, cd_darf_w, dt_referencia_w, cd_variacao_w, ie_periodicidade_w, 'M', null, null, null, null, null, nr_seq_trib_cp_w, null, 0, nr_seq_classe_w, --nr_seq_classe_tit_w,
			cd_tipo_baixa_neg_w, vl_base_calculo_w, 'N', nr_seq_classe_tit_w, ie_origem_titulo_w, null, null) INTO STRICT CD_BENEFICIARIO_w, PR_ALIQUOTA_w, CD_COND_PAGTO_w, CD_CONTA_FINANC_w, NR_SEQ_TRANS_REG_w, NR_SEQ_TRANS_BAIXA_w, vl_minimo_base_w, vl_minimo_tributo_w, ie_acumulativo_w, vl_teto_base_w, vl_desc_dependente_w, cd_darf_w, cd_variacao_w, ie_periodicidade_w, nr_seq_trib_cp_w, nr_seq_classe_w, 
			cd_tipo_baixa_neg_w;

update	titulo_pagar_imposto
set	dt_atualizacao 		= clock_timestamp(),
	nm_usuario		= nm_usuario_p,
	cd_beneficiario		= CASE WHEN cd_beneficiario = NULL THEN cd_beneficiario_w  ELSE cd_beneficiario END ,
	cd_cond_pagto		= cd_cond_pagto_w,
	cd_conta_financ		= cd_conta_financ_w,
	nr_seq_trans_reg	= nr_seq_trans_reg_w,
	nr_seq_trans_baixa	= nr_seq_trans_baixa_w,
	nr_seq_trib_cp		= nr_seq_trib_cp_w
where	nr_sequencia		= nr_sequencia_p;

CALL Gerar_Titulo_Tributo(nr_sequencia_p,
			nm_usuario_p);

commit;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_tit_pagar_imposto (nr_sequencia_p bigint, nm_usuario_p text) FROM PUBLIC;

