-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE desfazer_liberacao_laudo_ext ( nr_Seq_pac_protocolo_p bigint, ie_opcao_p text, nm_usuario_p text) AS $body$
DECLARE


nr_Seq_laudo_w			bigint;
nr_atendimento_w		bigint;
dt_exame_w			timestamp;
nr_seq_imagem_prot_ext_w	bigint;
cd_medico_w			varchar(10);
nr_laudo_w			bigint;

/*
P - Protocolo
L - Laudo
*/
c01 CURSOR FOR
	SELECT 	nr_sequencia
	from	laudo_paciente
	where	nr_seq_pac_prot_ext = nr_Seq_pac_protocolo_p;


BEGIN

if (ie_opcao_p = 'P') then

	select 	max(nr_atendimento),
		max(dt_exame),
		max(cd_medico)
	into STRICT	nr_atendimento_w,
		dt_exame_w,
		cd_medico_w
	from	imagem_pac_prot_externo
	where 	nr_sequencia = nr_Seq_pac_protocolo_p;

	open c01;
	loop
	fetch c01 into 	nr_seq_laudo_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */

		-- Gerar a cópia do laudo antes de desaprovar o mesmo.
		CALL gerar_copia_laudo_padrao(nr_seq_laudo_w,nr_seq_laudo_w,'',nm_usuario_p);

		update	laudo_paciente
		set	dt_aprovacao		 = NULL,
			dt_liberacao		 = NULL,
			dt_envelopado		 = NULL,
			nm_usuario_aprovacao	 = NULL,
			dt_seg_aprovacao	 = NULL,
			nm_usuario_seg_aprov	 = NULL,
			dt_desaprovacao		= clock_timestamp(),
			nm_usuario		= nm_usuario_p
		where	nr_sequencia		= nr_seq_laudo_w;

	end loop;
	close c01;

	update imagem_pac_prot_externo
	set dt_liberacao  = NULL
	where nr_sequencia = nr_Seq_pac_protocolo_p;
end if;

if (ie_opcao_p = 'L') then

	-- Gerar a cópia do laudo antes de desaprovar o mesmo.
	CALL gerar_copia_laudo_padrao(nr_seq_laudo_w,nr_seq_laudo_w,'',nm_usuario_p);

	update	laudo_paciente
	set	dt_aprovacao		 = NULL,
		dt_liberacao		 = NULL,
		dt_envelopado		 = NULL,
		nm_usuario_aprovacao	 = NULL,
		dt_seg_aprovacao	 = NULL,
		nm_usuario_seg_aprov	 = NULL,
		dt_desaprovacao		= clock_timestamp(),
		nm_usuario		= nm_usuario_p
	where	nr_sequencia		= nr_Seq_pac_protocolo_p;

end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE desfazer_liberacao_laudo_ext ( nr_Seq_pac_protocolo_p bigint, ie_opcao_p text, nm_usuario_p text) FROM PUBLIC;

