-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE cp_select_interv_plan ( nr_seq_pat_care_plan_p bigint, nr_seq_interv_plan_p bigint, nr_seq_pat_cp_problem_p bigint, nm_usuario_p text, action text, nr_seq_prescr_diag_p bigint DEFAULT NULL, NR_SEQ_INT_PLA_DIAG_P bigint DEFAULT NULL, nr_seq_pat_cp_interv_plan_p INOUT bigint DEFAULT NULL) AS $body$
DECLARE

  nr_seq_pat_cp_interv_plan_w patient_cp_interv_plan.nr_sequencia%type;
  si_selected_w varchar(1) := 'N';

BEGIN
  BEGIN
    SELECT X.NR_SEQUENCIA INTO STRICT nr_seq_pat_cp_interv_plan_w FROM (
    SELECT nr_sequencia
    FROM patient_cp_interv_plan pcpip
    WHERE pcpip.nr_seq_pat_care_plan = nr_seq_pat_care_plan_p
    AND pcpip.nr_seq_interv_plan     = nr_seq_interv_plan_p

union

    SELECT nr_sequencia
    FROM patient_cp_interv_plan pcpip
    WHERE coalesce(pcpip.nr_seq_pat_care_plan,0) = coalesce(nr_seq_pat_care_plan_p,0)
    AND coalesce(pcpip.nr_seq_interv_plan,0) = coalesce(nr_seq_interv_plan_p,0)
    AND pcpip.NR_SEQ_PRESCR_DIAG = nr_seq_prescr_diag_p
    AND pcpip.NR_SEQ_INT_PLA_DIAG = NR_SEQ_INT_PLA_DIAG_p) X;
  EXCEPTION
  WHEN no_data_found THEN
    nr_seq_pat_cp_interv_plan_w := NULL;
  END;
  IF (coalesce(nr_seq_pat_cp_interv_plan_w::text, '') = '') THEN

    SELECT nextval('patient_cp_interv_plan_seq')
    INTO STRICT nr_seq_pat_cp_interv_plan_w
;
    INSERT
    INTO patient_cp_interv_plan(
        nr_sequencia,
        dt_atualizacao,
        nm_usuario,
        dt_atualizacao_nrec,
        nm_usuario_nrec,
        nr_seq_pat_care_plan,
        nr_seq_interv_plan,
        dt_start,
        dt_end,
        dt_release,
        si_selected,
        nr_seq_pat_cp_problem,
        nr_seq_prescr_diag,
        NR_SEQ_INT_PLA_DIAG
      )
      VALUES (
        nr_seq_pat_cp_interv_plan_w,
        clock_timestamp(),
        nm_usuario_p,
        clock_timestamp(),
        nm_usuario_p,
        nr_seq_pat_care_plan_p,
        nr_seq_interv_plan_p,
        NULL,
        NULL,
        NULL,
        'Y',
        nr_seq_pat_cp_problem_p,
        nr_seq_prescr_diag_p,
        NR_SEQ_INT_PLA_DIAG_P
      );
  ELSE
    SELECT CASE WHEN COUNT(1)=0 THEN 'N'  ELSE 'Y' END
    INTO STRICT si_selected_w
    FROM patient_cp_intervention a
    WHERE a.nr_seq_pat_cp_interv_plan = nr_seq_pat_cp_interv_plan_w
    AND a.si_selected                 = 'Y';

    UPDATE patient_cp_interv_plan
    SET si_selected    = si_selected_w,
      nm_usuario       = nm_usuario_p,
      dt_atualizacao   = clock_timestamp()
    WHERE nr_sequencia = nr_seq_pat_cp_interv_plan_w;

  END IF;
  nr_seq_pat_cp_interv_plan_p := nr_seq_pat_cp_interv_plan_w;
  COMMIT;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cp_select_interv_plan ( nr_seq_pat_care_plan_p bigint, nr_seq_interv_plan_p bigint, nr_seq_pat_cp_problem_p bigint, nm_usuario_p text, action text, nr_seq_prescr_diag_p bigint DEFAULT NULL, NR_SEQ_INT_PLA_DIAG_P bigint DEFAULT NULL, nr_seq_pat_cp_interv_plan_p INOUT bigint DEFAULT NULL) FROM PUBLIC;

