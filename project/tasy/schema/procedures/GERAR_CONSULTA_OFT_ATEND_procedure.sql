-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_consulta_oft_atend ( nr_atendimento_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint) AS $body$
DECLARE


cd_medico_w		varchar(10);
nr_sequencia_w		bigint;
nr_seq_status_w		bigint;
cd_pessoa_fisica_w	varchar(10);
ie_possui_consulta_w	varchar(1);
nr_seq_classificacao_w	atendimento_paciente.nr_seq_classificacao%type;
nr_seq_tipo_consulta_w	classificacao_atendimento.nr_seq_tipo_consulta%type;


BEGIN

nr_seq_status_w := obter_param_usuario(3010, 18, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, nr_seq_status_w);

if (coalesce(nr_atendimento_p,0) > 0) then
	select	coalesce(max('S'),'N')
	into STRICT	ie_possui_consulta_w
	from	oft_consulta
	where	nr_atendimento = nr_atendimento_p
	and	coalesce(dt_cancelamento::text, '') = '';

	if (ie_possui_consulta_w = 'N') then
		select	max(cd_medico_resp),
			max(cd_pessoa_fisica)
		into STRICT	cd_medico_w,
			cd_pessoa_fisica_w
		from	atendimento_paciente
		where	nr_atendimento	= nr_atendimento_p;

		CALL consiste_geracao_oftalmologia(nr_atendimento_p,nm_usuario_p,cd_estabelecimento_p);

		if (nr_atendimento_p IS NOT NULL AND nr_atendimento_p::text <> '') and (nr_atendimento_p > 0) then
			select  max(nr_seq_classificacao)
			into STRICT	nr_seq_classificacao_w
			from    atendimento_paciente
			where   nr_atendimento = nr_atendimento_p
			and	cd_estabelecimento = cd_estabelecimento_p;

			if (nr_seq_classificacao_w IS NOT NULL AND nr_seq_classificacao_w::text <> '') then
				select max(nr_seq_tipo_consulta)
				into STRICT   nr_seq_tipo_consulta_w
				from   classificacao_atendimento
				where  nr_sequencia = nr_seq_classificacao_w
				and    coalesce(cd_estabelecimento,cd_estabelecimento_p) = cd_estabelecimento_p
				and    coalesce(ie_situacao,'A') = 'A';
			end if;
		end if;


		select	nextval('oft_consulta_seq')
		into STRICT	nr_sequencia_w
		;

		insert into oft_consulta(
			nr_sequencia,
			dt_atualizacao,
			nm_usuario,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			nr_atendimento,
			nr_atend_consultorio,
			dt_consulta,
			cd_medico,
			dt_fim_consulta,
			nr_seq_status,
			nr_seq_tipo_consulta,
			cd_pessoa_fisica)
		values (
			nr_sequencia_w,
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			nr_atendimento_p,
			null,
			clock_timestamp(),
			cd_medico_w,
			null,
			nr_seq_status_w,
			nr_seq_tipo_consulta_w,
			cd_pessoa_fisica_w);
		commit;

		update	atendimento_paciente
		set	nr_seq_oftalmo	=	nr_sequencia_w
		where	nr_atendimento	=	nr_atendimento_p;
		commit;

	end if;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_consulta_oft_atend ( nr_atendimento_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint) FROM PUBLIC;

