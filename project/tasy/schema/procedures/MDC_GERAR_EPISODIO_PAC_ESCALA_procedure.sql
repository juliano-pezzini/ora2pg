-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE mdc_gerar_episodio_pac_escala ( nr_atendimento_p mdc_episodio_pac_escala.nr_atendimento%type, nr_seq_reg_escala_p mdc_episodio_pac_escala.nr_seq_reg_escala%type, ie_escala_p mdc_episodio_pac_escala.ie_escala%type, nm_usuario_p mdc_episodio_pac_escala.nm_usuario%type, ie_inativar_p text default 'N') AS $body$
DECLARE


qt_regras_w                     bigint;
cd_estabelecimento_w            mdc_regra_escala_indice.cd_estabelecimento%type;
ie_controle_revisao_w           mdc_regra_escala_indice.ie_controle_revisao%type;
nr_seq_episodio_w               atendimento_paciente.nr_seq_episodio%type;
nr_sequencia_w                  mdc_episodio_pac_escala.nr_sequencia%type;
dt_revisao_w                    mdc_episodio_pac_escala.dt_revisao%type;
nm_usuario_revisao_w            mdc_episodio_pac_escala.nm_usuario_revisao%type;
qt_pontos_w                     mdc_episodio_pac_escala.qt_pontos%type;


BEGIN
--
cd_estabelecimento_w := obter_estab_usuario(nm_usuario_p);
--
select  count(*)
into STRICT    qt_regras_w
from    mdc_regra_escala_indice a
where   a.ie_escala =  ie_escala_p
and     a.cd_estabelecimento = cd_estabelecimento_w;
--
qt_pontos_w := mdc_obter_pontuacao_escala(ie_escala_p, nr_seq_reg_escala_p);
--
if (qt_regras_w > 0)then

    if (ie_inativar_p='N')then
        select  ie_controle_revisao
        into STRICT    ie_controle_revisao_w
        from    mdc_regra_escala_indice a
        where   a.ie_escala = ie_escala_p
        and     a.cd_estabelecimento = cd_estabelecimento_w;
        --
        select  nr_seq_episodio
        into STRICT    nr_seq_episodio_w
        from    atendimento_paciente
        where   nr_atendimento = nr_atendimento_p;
        --
        select  nextval('mdc_episodio_pac_escala_seq')
        into STRICT    nr_sequencia_w
;
        --    
        if (ie_controle_revisao_w <> 'S') then
            dt_revisao_w := clock_timestamp();
            nm_usuario_revisao_w := nm_usuario_p;
        end if;
        -- 
        insert into mdc_episodio_pac_escala(    nr_sequencia,
                                                dt_atualizacao,
                                                nm_usuario,
                                                dt_atualizacao_nrec,
                                                nm_usuario_nrec,
                                                nr_seq_episodio,
                                                nr_atendimento,
                                                nr_seq_reg_escala,
                                                ie_escala,
                                                qt_pontos,
                                                dt_revisao,
                                                nm_usuario_revisao)
        values (    nr_sequencia_w,
                    clock_timestamp(),
                    nm_usuario_p,
                    clock_timestamp(),
                    nm_usuario_p,
                    nr_seq_episodio_w,
                    nr_atendimento_p,
                    nr_seq_reg_escala_p,
                    ie_escala_p,
                    qt_pontos_w,
                    dt_revisao_w,
                    nm_usuario_revisao_w);
    else
        update  mdc_episodio_pac_escala
        set     dt_inativacao = clock_timestamp(),
                nm_usuario_inativacao = nm_usuario_p
        where   nr_seq_reg_escala = nr_seq_reg_escala_p
        and     ie_escala = ie_escala_p;
    end if;

end if;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE mdc_gerar_episodio_pac_escala ( nr_atendimento_p mdc_episodio_pac_escala.nr_atendimento%type, nr_seq_reg_escala_p mdc_episodio_pac_escala.nr_seq_reg_escala%type, ie_escala_p mdc_episodio_pac_escala.ie_escala%type, nm_usuario_p mdc_episodio_pac_escala.nm_usuario%type, ie_inativar_p text default 'N') FROM PUBLIC;

