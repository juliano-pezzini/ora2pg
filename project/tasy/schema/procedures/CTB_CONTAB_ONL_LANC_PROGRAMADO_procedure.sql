-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE ctb_contab_onl_lanc_programado ( nm_usuario_p text) AS $body$
DECLARE


/*
===============================================================================
Purpose: Indentacao

Remarks: n/a

Who         When            What
----------  -----------     --------------------------------------------------
chjreinert  13/mai/2021     OS 2444975 - Indentacao

===============================================================================
*/
nr_seq_mes_ref_w        ctb_mes_ref.nr_sequencia%type;
cd_empresa_w            empresa.cd_empresa%type;
qtd_registros_w         bigint;

/* Busca os estabelecimentos que possuem regras de lancamentos programados para o periodo */

c01 CURSOR FOR
        SELECT  a.cd_empresa,
                a.cd_estabelecimento
        from    estabelecimento a,
                empresa b,
                ctb_regra_movto_prog c
        where   a.cd_empresa = b.cd_empresa
        and     a.ie_situacao = 'A'
        and     b.ie_situacao = 'A'
        and     c.ie_situacao = 'A'
        and     a.cd_estabelecimento = c.cd_estabelecimento
        and     ctb_obter_se_vigente(clock_timestamp(),c.dt_inicio_vigencia,c.dt_fim_vigencia) = 'S'
        order by a.cd_empresa,  a.cd_estabelecimento;

c01_w   c01%rowtype;


BEGIN

open c01;
loop
fetch c01 into
        c01_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
begin
        begin
        select  a.nr_sequencia
        into STRICT    nr_seq_mes_ref_w
        from    ctb_mes_ref a
        where   trunc(a.dt_referencia,'MM') = trunc(clock_timestamp(),'MM')
        and     a.cd_empresa = c01_w.cd_empresa;
        exception
        when others then
                nr_seq_mes_ref_w := null;
        end;

        /* Chamada Geracao Lote Lancamento Programado para Cada Estabelecimento da Empresa informada*/

        if (coalesce(nr_seq_mes_ref_w, 0) != 0) then
                begin
                select  count(*)
                into STRICT    qtd_registros_w
                from    lote_contabil
                where   nr_seq_mes_ref          = nr_seq_mes_ref_w
                and     cd_tipo_lote_contabil   = 48 -- Lancamentos programados
                and     cd_estabelecimento      = c01_w.cd_estabelecimento  LIMIT 1;
                exception when others then
                        qtd_registros_w := 0;
                end;

                if (qtd_registros_w = 0) then
                        CALL ctb_gerar_lote_prog( nr_seq_mes_ref_w,
                                clock_timestamp(),
                                c01_w.cd_estabelecimento,
                                nm_usuario_p );
                end if;
        end if;
end;
end loop;
close c01;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ctb_contab_onl_lanc_programado ( nm_usuario_p text) FROM PUBLIC;

