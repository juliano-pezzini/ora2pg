-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE atualizar_atend_triagem ( nr_atendimento_p bigint, cd_pessoa_fisica_p text, nm_usuario_p text, cd_estabelecimento_p bigint) AS $body$
DECLARE

nr_seq_triagem_w	bigint;
qt_horas_validade_w	bigint;
qt_reg_w		bigint;
NR_SEQ_CLASSIF_w	bigint;
NR_SEQ_TRIAGEM_PRIORIDADE_w	bigint;
nr_seq_queixa_w		bigint;
nm_usuario_nrec_w 	varchar(15);


BEGIN 
 
qt_horas_validade_w		:= coalesce(obter_valor_param_usuario(916, 512, Obter_Perfil_Ativo, nm_usuario_p, coalesce(cd_estabelecimento_p,0)),0);
 
RAISE NOTICE 'qt_horas_validade_w=%', qt_horas_validade_w;
if (qt_horas_validade_w	> 0) then 
	select	max(a.nr_sequencia), 
		max(a.NR_SEQ_CLASSIF), 
		max(a.NR_SEQ_TRIAGEM_PRIORIDADE), 
		max(a.NR_SEQ_QUEIXA), 
		max(a.NM_USUARIO_NREC) 
	into STRICT	nr_seq_triagem_w, 
		NR_SEQ_CLASSIF_w, 
		NR_SEQ_TRIAGEM_PRIORIDADE_w, 
		nr_seq_queixa_w, 
		nm_usuario_nrec_w 
	from	triagem_pronto_atend a 
	where	cd_pessoa_fisica	= cd_pessoa_fisica_p 
	and	coalesce(nr_atendimento::text, '') = '' 
	and	dt_atualizacao_nrec between clock_timestamp() - (qt_horas_validade_w / 24) and clock_timestamp();
	 
	select	count(*) 
	into STRICT	qt_reg_w 
	from	triagem_pronto_atend 
	where	nr_atendimento	= nr_atendimento_p;
	 
 
	if (qt_reg_w	= 0) and (nr_seq_triagem_w IS NOT NULL AND nr_seq_triagem_w::text <> '') then 
	 
		update	triagem_pronto_atend 
		set	nr_atendimento	= nr_atendimento_p 
		where	nr_sequencia	= nr_seq_triagem_w;
		 
		update	atendimento_paciente 
		set	NR_SEQ_TRIAGEM	= NR_SEQ_CLASSIF_w, 
			NR_SEQ_TRIAGEM_PRIORIDADE = NR_SEQ_TRIAGEM_PRIORIDADE_w, 
			nr_seq_queixa = nr_seq_queixa_w, 
			nm_usuario 		= nm_usuario_nrec_w 
		where	nr_atendimento	= nr_atendimento_p 
		and	coalesce(nr_seq_triagem::text, '') = '';
		 
		update	atendimento_sinal_vital 
		set	nr_atendimento	= nr_atendimento_p 
		where	nr_seq_triagem	= nr_seq_triagem_w 
		and	coalesce(nr_atendimento::text, '') = '';
		 
		 
		commit;
		 
		CALL atualiza_atendimento_triagem(nr_seq_triagem_w,nm_usuario_p);
	end if;
end if;
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE atualizar_atend_triagem ( nr_atendimento_p bigint, cd_pessoa_fisica_p text, nm_usuario_p text, cd_estabelecimento_p bigint) FROM PUBLIC;

