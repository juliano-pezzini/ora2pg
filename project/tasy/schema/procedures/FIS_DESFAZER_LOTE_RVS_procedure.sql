-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE fis_desfazer_lote_rvs ( nm_usuario_p text, nr_sequencia_p bigint) AS $body$
DECLARE


qt_insert_w	bigint;

c01 CURSOR FOR
	SELECT	nr_sequencia
	from	siscoserv_rvs
	where	1 = 1
	and	nr_seq_lote = nr_sequencia_p
	order by 1;

c01_w		c01%rowtype;

c02 CURSOR FOR
	SELECT	nr_sequencia
	from	siscoserv_rvs_operacao
	where	1 = 1
	and	nr_seq_rvs = c01_w.nr_sequencia
	order by 1;

c02_w		c02%rowtype;

c03 CURSOR FOR
	SELECT	nr_sequencia
	from	siscoserv_rvs_oper_enquad
	where	1 = 1
	and	nr_seq_oper_rvs = c02_w.nr_sequencia
	order by 1;

c03_w		c03%rowtype;

c04 CURSOR FOR
	SELECT	nr_sequencia
	from	siscoserv_fatura
	where	1 = 1
	and	nr_seq_rvs = c01_w.nr_sequencia
	order by 1;

c04_w		c04%rowtype;

c05 CURSOR FOR
	SELECT	nr_sequencia
	from	siscoserv_fatura_item
	where	1 = 1
	and	nr_seq_fatura = c04_w.nr_sequencia
	order by 1;

c05_w		c05%rowtype;


BEGIN
qt_insert_w := 0;

open c01;
loop
fetch c01 into
	c01_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	begin
	open c02;
	loop
	fetch c02 into
		c02_w;
	EXIT WHEN NOT FOUND; /* apply on c02 */
		begin
		open c03;
		loop
		fetch c03 into
			c03_w;
		EXIT WHEN NOT FOUND; /* apply on c03 */
			begin
			delete from siscoserv_rvs_oper_enquad where nr_sequencia = c03_w.nr_sequencia;
			qt_insert_w := qt_insert_w + 1;
			if (qt_insert_w > 100) then
				begin
				commit;
				qt_insert_w := 0;
				end;
			end if;
			end;
		end loop;
		close c03;

		delete from siscoserv_rvs_operacao where nr_sequencia = c02_w.nr_sequencia;
		qt_insert_w := qt_insert_w + 1;
		if (qt_insert_w > 100) then
			begin
			commit;
			qt_insert_w := 0;
			end;
		end if;
		end;
	end loop;
	close c02;

	open c04;
	loop
	fetch c04 into
		c04_w;
	EXIT WHEN NOT FOUND; /* apply on c04 */
		begin

		open c05;
		loop
		fetch c05 into
			c05_w;
		EXIT WHEN NOT FOUND; /* apply on c05 */
			begin
			delete from siscoserv_fatura_item where nr_sequencia = c05_w.nr_sequencia;
			qt_insert_w := qt_insert_w + 1;
			if (qt_insert_w > 100) then
				begin
				commit;
				qt_insert_w := 0;
				end;
			end if;
			end;
		end loop;
		close c05;
		delete from siscoserv_fatura where nr_sequencia = c04_w.nr_sequencia;
		qt_insert_w := qt_insert_w + 1;
		if (qt_insert_w > 100) then
			begin
			commit;
			qt_insert_w := 0;
			end;
		end if;
		end;
	end loop;
	close c04;

	delete from siscoserv_rvs where nr_sequencia = c01_w.nr_sequencia;
	qt_insert_w := qt_insert_w + 1;
	if (qt_insert_w > 100) then
		begin
		commit;
		qt_insert_w := 0;
		end;
	end if;
	end;
end loop;
close c01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE fis_desfazer_lote_rvs ( nm_usuario_p text, nr_sequencia_p bigint) FROM PUBLIC;

