-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_ci_alteracao_convenio ( cd_convenio_p bigint, ds_mensagem_p text, nm_usuario_p text, cd_estabelecimento_p bigint) AS $body$
DECLARE


nm_usuario_envio_w	varchar(15);
cd_perfil_w		integer;
ds_comunicado_w		varchar(20000);
ds_perfil_adicional_w	varchar(4000) := '';
ds_usuario_envio_w	varchar(4000) := '';

C01 CURSOR FOR
	SELECT	nm_usuario_envio,
		cd_perfil
	from	regra_ci_alteracao_conv
	where	coalesce(cd_convenio, cd_convenio_p) = cd_convenio_p;


BEGIN

ds_comunicado_w := wheb_mensagem_pck.get_Texto(311907, 'DS_CONVENIO_W='|| substr(obter_nome_convenio(cd_convenio_p),1,80));
			/*Convênio alterado: #@DS_CONVENIO_W#@*/

ds_comunicado_w	:= ds_comunicado_w	|| chr(13) || chr(10)
					|| chr(13) || chr(10) || ds_mensagem_p;
					
ds_comunicado_w	:= replace(ds_comunicado_w,'>',chr(13) || chr(10));

open C01;
loop
fetch C01 into	
	nm_usuario_envio_w,
	cd_perfil_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	if (nm_usuario_envio_w IS NOT NULL AND nm_usuario_envio_w::text <> '') then
		ds_usuario_envio_w := ds_usuario_envio_w || nm_usuario_envio_w || ', ';
	end if;
	if (cd_perfil_w IS NOT NULL AND cd_perfil_w::text <> '') then
		ds_perfil_adicional_w := ds_perfil_adicional_w || cd_perfil_w || ', ';
	end if;
	end;
end loop;
close C01;
				/*'Alteração na função Cadastro de Convênios '*/

CALL gerar_comunic_padrao(clock_timestamp(), wheb_mensagem_pck.get_Texto(311908), ds_comunicado_w, nm_usuario_p, 'N', ds_usuario_envio_w,
	'N', null, ds_perfil_adicional_w, cd_estabelecimento_p, null, clock_timestamp(), null, null);

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_ci_alteracao_convenio ( cd_convenio_p bigint, ds_mensagem_p text, nm_usuario_p text, cd_estabelecimento_p bigint) FROM PUBLIC;

