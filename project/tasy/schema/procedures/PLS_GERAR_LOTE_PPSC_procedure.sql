-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_gerar_lote_ppsc ( nr_seq_lote_p bigint, ie_opcao_p text, ie_lote_contabil_p text, nm_usuario_p text, cd_estabelecimento_p bigint, ie_recalc_tit_p text default 'N') AS $body$
DECLARE


/* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Finalidade: Gerar as informacoes dos titulos em aberto para serem provisionados conforme as
regras de PPSC
-------------------------------------------------------------------------------------------------------------------

Locais de chamada direta: 
[ X ]  Objetos do dicionario [  ] Tasy (Delphi/Java) [  ] Portal [  ]  Relatorios [ ] Outros:
 ------------------------------------------------------------------------------------------------------------------

Pontos de atencao:
	Verificar que as alteracoes realizadas aqui devem ser realizadas tambem na
	rotina DIOPS_GERAR_IDADESALDO_ATIVO, conforme for necessario.
-------------------------------------------------------------------------------------------------------------------

Referencias:
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */
cd_cgc_w			varchar(14);
cd_pessoa_fisica_w		varchar(10);
ie_data_base_lote_w		pls_ppsc_regra.ie_data_base_lote%type;
ie_preco_w			varchar(2);
ie_tipo_contratacao_w		varchar(2);
ie_tipo_operacao_w		varchar(2);
ie_tipo_pessoa_w		varchar(2);
ie_incidencia_titulo_w		varchar(2);
ie_tipo_item_w			varchar(2);
ie_origem_titulo_w		varchar(1);
ie_pro_rata_mes_w		varchar(1);
ie_titulo_externo_w		varchar(1)	:= 'N';
ie_restringe_produto_w		varchar(1);
vl_saldo_titulo_w		double precision;
vl_pro_rata_dia_w		double precision;
vl_item_w			double precision;
vl_saldo_w			double precision;
vl_titulo_w			double precision;
vl_saldo_contabil_w		double precision;
qt_dias_w			bigint;
nr_titulo_w			bigint;
mr_seq_pagador_w		bigint;
qt_titulo_w			bigint;
nr_titulo_atrasado_w		bigint;
nr_titulo_provisao_w		bigint;
qt_lote_gerado_w		bigint	:= 0;
nr_seq_mensalidade_w		bigint;
nr_seq_movimento_w		bigint;
nr_seq_plano_w			bigint;
nr_seq_sca_w			bigint;
qt_lote_contabil_w		bigint;
qt_lote_contabil_item_w		bigint;
nr_seq_tipo_lanc_w		pls_mensalidade_seg_item.nr_seq_tipo_lanc%type;
nr_seq_regra_ppsc_w		pls_ppsc_regra.nr_sequencia%type;
nr_seq_tipo_acrescimo_w		pls_mensalidade_seg_item.nr_seq_tipo_acrescimo%type;
ie_cheque_w			pls_ppsc_regra.ie_cheque%type;
ie_considera_estab_fin_w	pls_ppsc_lote.ie_considera_estab_fin%type;
nr_seq_cheque_w			cheque_cr.nr_seq_cheque%type;
vl_cheque_w			cheque_cr.vl_cheque%type;
nr_adiantamento_w		adiantamento_pago.nr_adiantamento%type;
vl_adiantamento_w		adiantamento_pago.vl_adiantamento%type;
vl_antecipacao_w		pls_mensalidade_seg_item.vl_antecipacao%type;
nr_seq_mensalidade_item_w       pls_mensalidade_seg_item.nr_sequencia%type;
cd_conta_deb_item_mens_w        pls_mensalidade_seg_item.cd_conta_deb%type;

qt_commit_w			bigint	:= 0;
qt_cheque_w			bigint	:= 0;
dt_lote_w			timestamp;
dt_fim_periodo_w		timestamp;
dt_pagamento_previsto_w		timestamp;
dt_lote_ref_trunc_w		timestamp;

ie_titulo_vencer_w		pls_ppsc_regra.ie_titulo_vencer%type;
nr_titulo_aberto_w		titulo_receber.nr_titulo%type;
dt_fim_lote_ref_w		timestamp;
dt_fim_lote_ref_fd_w		timestamp;
ie_consolida_empresa_w		pls_ppsc_regra.ie_consolida_empresa%type;
qt_dias_adiantamento_w		pls_ppsc_regra.qt_dias_adiantamento%type;
cd_empresa_w			empresa.cd_empresa%type;
cd_estabelecimento_w		estabelecimento.cd_estabelecimento%type;
nr_titulo_original_w	pls_ppsc_movimento.nr_titulo_original%type;
qt_movimento_ppsc_w		bigint := 0;

c_regras_ppsc CURSOR FOR  -- Regra geracao lote PPSC
	SELECT	a.ie_preco,
		a.ie_tipo_contratacao,
		a.qt_dias,
		a.ie_origem_titulo,
		a.ie_tipo_operacao,
		coalesce(a.ie_pro_rata_mes, 'N'),
		a.nr_sequencia,
		coalesce(a.ie_titulo_externo,'N'),
		coalesce(a.ie_data_base_lote,'P'),
		coalesce(a.ie_restringe_produto, 'N'),
		coalesce(ie_cheque, 'N'),
		coalesce(ie_titulo_vencer, 'N'),
		coalesce(qt_dias_adiantamento, 0)
	from	pls_ppsc_regra	a,
		estabelecimento	e
	where 	a.cd_estabelecimento	= e.cd_estabelecimento
	and	((coalesce(cd_estabelecimento_w::text, '') = '')
	or 	(ie_considera_estab_fin_w = 'N' AND a.cd_estabelecimento	= cd_estabelecimento_w)
	or 	((ie_considera_estab_fin_w = 'S') and (coalesce(e.cd_estab_financeiro,e.cd_estabelecimento) = cd_estabelecimento_w)))
	order by 
		ie_origem_titulo,
		ie_preco,
		ie_tipo_contratacao,
		qt_dias desc;

c_pessoas_mensalidade CURSOR FOR  -- Titulo atrasado - Mensalidade
	SELECT	a.cd_pessoa_fisica,
		a.cd_cgc
	FROM pls_contrato_pagador f, titulo_receber a
LEFT OUTER JOIN pls_mensalidade b ON (a.nr_seq_mensalidade = b.nr_sequencia)
LEFT OUTER JOIN estabelecimento g ON (a.cd_estabelecimento = g.cd_estabelecimento)
LEFT OUTER JOIN pls_mensalidade_segurado c ON (b.nr_sequencia = c.nr_seq_mensalidade)
LEFT OUTER JOIN pls_segurado d ON (c.nr_seq_segurado = d.nr_sequencia)
LEFT OUTER JOIN pls_plano e ON (d.nr_seq_plano = e.nr_sequencia)
WHERE ((d.nr_seq_pagador = f.nr_sequencia)
	or (a.nr_seq_pagador = f.nr_sequencia)) and g.cd_empresa = cd_empresa_w and ((coalesce(cd_estabelecimento_w::text, '') = '')
	or 	(ie_considera_estab_fin_w = 'N' AND g.cd_estabelecimento	= cd_estabelecimento_w)
	or 	((ie_considera_estab_fin_w = 'S') and (coalesce(g.cd_estab_financeiro,g.cd_estabelecimento) = cd_estabelecimento_w))) and a.dt_pagamento_previsto < (dt_lote_w - qt_dias_w) and ie_data_base_lote_w	= 'P' and ((coalesce(a.dt_liquidacao::text, '') = '') or (a.dt_liquidacao > dt_fim_periodo_w)) and a.ie_origem_titulo = '3' and (((a.nr_seq_mensalidade IS NOT NULL AND a.nr_seq_mensalidade::text <> '') 
	and	((e.ie_preco		= ie_preco_w) or (coalesce(ie_preco_w::text, '') = ''))
	and	((e.ie_tipo_contratacao	= ie_tipo_contratacao_w) or (coalesce(ie_tipo_contratacao_w::text, '') = '')))
	or	(coalesce(a.nr_seq_mensalidade::text, '') = ''
	and	exists(	SELECT	1
			from	pls_segurado z,
				pls_plano y
			where	z.nr_seq_plano = y.nr_sequencia
			and	z.nr_seq_pagador = f.nr_sequencia
			and	((y.ie_preco = ie_preco_w) or (coalesce(ie_preco_w::text, '') = ''))
			and	((y.ie_tipo_contratacao	= ie_tipo_contratacao_w) or (coalesce(ie_tipo_contratacao_w::text, '') = ''))))) group by
		a.cd_pessoa_fisica,
		a.cd_cgc
	
union all

	select	a.cd_pessoa_fisica,
		a.cd_cgc
	FROM pls_contrato_pagador f, titulo_receber a
LEFT OUTER JOIN pls_mensalidade b ON (a.nr_seq_mensalidade = b.nr_sequencia)
LEFT OUTER JOIN estabelecimento g ON (a.cd_estabelecimento = g.cd_estabelecimento)
LEFT OUTER JOIN pls_mensalidade_segurado c ON (b.nr_sequencia = c.nr_seq_mensalidade)
LEFT OUTER JOIN pls_segurado d ON (c.nr_seq_segurado = d.nr_sequencia)
LEFT OUTER JOIN pls_plano e ON (d.nr_seq_plano = e.nr_sequencia)
WHERE ((d.nr_seq_pagador = f.nr_sequencia)
	or (a.nr_seq_pagador = f.nr_sequencia)) and g.cd_empresa = cd_empresa_w and ((coalesce(cd_estabelecimento_w::text, '') = '') 
	or 	(ie_considera_estab_fin_w = 'N' AND g.cd_estabelecimento	= cd_estabelecimento_w)
	or 	((ie_considera_estab_fin_w = 'S') and (coalesce(g.cd_estab_financeiro,g.cd_estabelecimento) = cd_estabelecimento_w))) and a.dt_vencimento < (dt_lote_w - qt_dias_w) and ie_data_base_lote_w	= 'V' and ((coalesce(a.dt_liquidacao::text, '') = '') or (a.dt_liquidacao > dt_fim_periodo_w)) and a.ie_origem_titulo = '3' and (((a.nr_seq_mensalidade IS NOT NULL AND a.nr_seq_mensalidade::text <> '') 
	and	((e.ie_preco		= ie_preco_w) or (coalesce(ie_preco_w::text, '') = ''))
	and	((e.ie_tipo_contratacao	= ie_tipo_contratacao_w) or (coalesce(ie_tipo_contratacao_w::text, '') = '')))
	or	(coalesce(a.nr_seq_mensalidade::text, '') = ''
	and	exists(	select	1
			from	pls_segurado z,
				pls_plano y
			where	z.nr_seq_plano = y.nr_sequencia
			and	z.nr_seq_pagador = f.nr_sequencia
			and	((y.ie_preco = ie_preco_w) or (coalesce(ie_preco_w::text, '') = ''))
			and	((y.ie_tipo_contratacao	= ie_tipo_contratacao_w) or (coalesce(ie_tipo_contratacao_w::text, '') = ''))))) group by
		a.cd_pessoa_fisica,
		a.cd_cgc;

c_titulos_mensalidade CURSOR FOR  -- Titulos da mesma pessoa que o atrasado - Mensalidade
	SELECT	a.nr_titulo,
		obter_saldo_tit_rec_pos_cont(a.nr_titulo, dt_fim_periodo_w),
		b.vl_pro_rata_dia,
		b.nr_sequencia,
		a.dt_pagamento_previsto,
		a.vl_titulo
	FROM estabelecimento g, titulo_receber a
LEFT OUTER JOIN pls_mensalidade b ON (a.nr_seq_mensalidade = b.nr_sequencia)
LEFT OUTER JOIN pls_mensalidade_segurado c ON (b.nr_sequencia = c.nr_seq_mensalidade)
LEFT OUTER JOIN pls_segurado e ON (c.nr_seq_segurado = e.nr_sequencia)
LEFT OUTER JOIN pls_plano f ON (e.nr_seq_plano = f.nr_sequencia)
WHERE a.cd_estabelecimento = g.cd_estabelecimento and g.cd_empresa = cd_empresa_w and ((coalesce(cd_estabelecimento_w::text, '') = '')
	or 	(ie_considera_estab_fin_w = 'N' AND g.cd_estabelecimento	= cd_estabelecimento_w)
	or 	((ie_considera_estab_fin_w = 'S') and (coalesce(g.cd_estab_financeiro,g.cd_estabelecimento) = cd_estabelecimento_w))) and ((ie_tipo_pessoa_w = 'PF' AND a.cd_pessoa_fisica = cd_pessoa_fisica_w) or
		(ie_tipo_pessoa_w = 'PJ' AND a.cd_cgc = cd_cgc_w)) and ((coalesce(a.dt_liquidacao::text, '') = '') or (a.dt_liquidacao > dt_fim_periodo_w)) and a.ie_origem_titulo = '3' and (((a.nr_seq_mensalidade IS NOT NULL AND a.nr_seq_mensalidade::text <> '') 
	and	((f.ie_preco		= ie_preco_w) or (coalesce(ie_preco_w::text, '') = ''))
	and	((f.ie_tipo_contratacao	= ie_tipo_contratacao_w) or (coalesce(ie_tipo_contratacao_w::text, '') = '')))
	or	(coalesce(a.nr_seq_mensalidade::text, '') = ''
	and	exists(	SELECT	1
			from	pls_segurado z,
				pls_plano y,
				pls_contrato_pagador w
			where	z.nr_seq_plano = y.nr_sequencia
			and	z.nr_seq_pagador = w.nr_sequencia
			and	a.nr_seq_pagador = w.nr_sequencia
			and	((y.ie_preco = ie_preco_w) or (coalesce(ie_preco_w::text, '') = ''))
			and	((y.ie_tipo_contratacao	= ie_tipo_contratacao_w) or (coalesce(ie_tipo_contratacao_w::text, '') = ''))))) and (ie_titulo_vencer_w	= 'S' 
	or (a.dt_pagamento_previsto <= dt_fim_periodo_w --dt_lote_ref_trunc_w
	and	ie_data_base_lote_w	= 'P')) and a.dt_contabil		<= dt_fim_periodo_w group by
		a.nr_titulo,
		b.nr_sequencia,
		b.vl_pro_rata_dia,
		a.dt_pagamento_previsto,
		a.vl_titulo
	
union all

	select	a.nr_titulo,
		obter_saldo_tit_rec_pos_cont(a.nr_titulo, dt_fim_periodo_w),
		b.vl_pro_rata_dia,
		b.nr_sequencia,
		a.dt_vencimento,
		a.vl_titulo
	FROM estabelecimento g, titulo_receber a
LEFT OUTER JOIN pls_mensalidade b ON (a.nr_seq_mensalidade = b.nr_sequencia)
LEFT OUTER JOIN pls_mensalidade_segurado c ON (b.nr_sequencia = c.nr_seq_mensalidade)
LEFT OUTER JOIN pls_segurado e ON (c.nr_seq_segurado = e.nr_sequencia)
LEFT OUTER JOIN pls_plano f ON (e.nr_seq_plano = f.nr_sequencia)
WHERE a.cd_estabelecimento = g.cd_estabelecimento and g.cd_empresa = cd_empresa_w and ((coalesce(cd_estabelecimento_w::text, '') = '') 
	or 	(ie_considera_estab_fin_w = 'N' AND g.cd_estabelecimento	= cd_estabelecimento_w)
	or 	((ie_considera_estab_fin_w = 'S') and (coalesce(g.cd_estab_financeiro,g.cd_estabelecimento) = cd_estabelecimento_w))) and ((ie_tipo_pessoa_w = 'PF' AND a.cd_pessoa_fisica = cd_pessoa_fisica_w) or
		(ie_tipo_pessoa_w = 'PJ' AND a.cd_cgc = cd_cgc_w)) and ((coalesce(a.dt_liquidacao::text, '') = '') or (a.dt_liquidacao > dt_fim_periodo_w)) and a.ie_origem_titulo = '3' and (((a.nr_seq_mensalidade IS NOT NULL AND a.nr_seq_mensalidade::text <> '') 
	and	((f.ie_preco		= ie_preco_w) or (coalesce(ie_preco_w::text, '') = ''))
	and	((f.ie_tipo_contratacao	= ie_tipo_contratacao_w) or (coalesce(ie_tipo_contratacao_w::text, '') = '')))
	or	(coalesce(a.nr_seq_mensalidade::text, '') = ''
	and	exists(	select	1
			from	pls_segurado z,
				pls_plano y,
				pls_contrato_pagador w
			where	z.nr_seq_plano = y.nr_sequencia
			and	z.nr_seq_pagador = w.nr_sequencia
			and	a.nr_seq_pagador = w.nr_sequencia
			and	((y.ie_preco = ie_preco_w) or (coalesce(ie_preco_w::text, '') = ''))
			and	((y.ie_tipo_contratacao	= ie_tipo_contratacao_w) or (coalesce(ie_tipo_contratacao_w::text, '') = ''))))) and (ie_titulo_vencer_w	= 'S' 
	or (a.dt_vencimento <= dt_fim_periodo_w --dt_lote_ref_trunc_w
	and	ie_data_base_lote_w	= 'V')) and a.dt_contabil		<= dt_fim_periodo_w group by
		a.nr_titulo,
		b.nr_sequencia,
		b.vl_pro_rata_dia,
		a.dt_vencimento,
		a.vl_titulo
	order by
		nr_titulo;
		
c_titulos_em_aberto CURSOR FOR  -- Titulos da mesma pessoa que em aberto - Mensalidade
	SELECT	a.nr_titulo,
		obter_saldo_tit_rec_pos_cont(a.nr_titulo, dt_fim_periodo_w),
		b.vl_pro_rata_dia,
		b.nr_sequencia,
		a.dt_pagamento_previsto,
		a.vl_titulo
	FROM estabelecimento g, titulo_receber a
LEFT OUTER JOIN pls_mensalidade b ON (a.nr_seq_mensalidade = b.nr_sequencia)
LEFT OUTER JOIN pls_mensalidade_segurado c ON (b.nr_sequencia = c.nr_seq_mensalidade)
LEFT OUTER JOIN pls_segurado e ON (c.nr_seq_segurado = e.nr_sequencia)
LEFT OUTER JOIN pls_plano f ON (e.nr_seq_plano = f.nr_sequencia)
WHERE a.cd_estabelecimento = g.cd_estabelecimento and g.cd_empresa = cd_empresa_w and ((coalesce(cd_estabelecimento_w::text, '') = '')
	or 	(ie_considera_estab_fin_w = 'N' AND g.cd_estabelecimento	= cd_estabelecimento_w)
	or 	((ie_considera_estab_fin_w = 'S') and (coalesce(g.cd_estab_financeiro,g.cd_estabelecimento) = cd_estabelecimento_w))) and ((ie_tipo_pessoa_w = 'PF' AND a.cd_pessoa_fisica = cd_pessoa_fisica_w) or
		(ie_tipo_pessoa_w = 'PJ' AND a.cd_cgc = cd_cgc_w)) and ((coalesce(a.dt_liquidacao::text, '') = '') or (a.dt_liquidacao > dt_fim_periodo_w)) and a.ie_origem_titulo = '3' and (((ie_restringe_produto_w = 'S') and
		((f.ie_preco = ie_preco_w) or (coalesce(ie_preco_w::text, '') = '')) and
		((f.ie_tipo_contratacao	= ie_tipo_contratacao_w) or (coalesce(ie_tipo_contratacao_w::text, '') = ''))) or (ie_restringe_produto_w = 'N')) and (ie_titulo_vencer_w	= 'S' 
	or (a.dt_pagamento_previsto > dt_fim_periodo_w --dt_fim_lote_ref_w
	and	ie_data_base_lote_w	= 'P')) and a.dt_contabil		<= dt_fim_periodo_w group by
		a.nr_titulo,
		b.nr_sequencia,
		b.vl_pro_rata_dia,
		a.dt_pagamento_previsto,
		a.vl_titulo
	
union all

	/* Intercambio */

	SELECT	a.nr_titulo,
		obter_saldo_tit_rec_pos_cont(a.nr_titulo, dt_fim_periodo_w),
		0 vl_pro_rata_dia,
		null nr_sequencia,
		a.dt_pagamento_previsto,
		a.vl_titulo
	from	titulo_receber			a,
		estabelecimento			g
	where	g.cd_empresa = cd_empresa_w
	and	a.cd_estabelecimento = g.cd_estabelecimento
	and	((coalesce(cd_estabelecimento_w::text, '') = '') 
	or 	(ie_considera_estab_fin_w = 'N' AND g.cd_estabelecimento	= cd_estabelecimento_w)
	or 	((ie_considera_estab_fin_w = 'S') and (coalesce(g.cd_estab_financeiro,g.cd_estabelecimento) = cd_estabelecimento_w)))
	and	((ie_tipo_pessoa_w = 'PF' AND a.cd_pessoa_fisica = cd_pessoa_fisica_w) or
		(ie_tipo_pessoa_w = 'PJ' AND a.cd_cgc = cd_cgc_w))
	and	((coalesce(a.dt_liquidacao::text, '') = '') or (a.dt_liquidacao > dt_fim_periodo_w))
	and (ie_titulo_vencer_w	= 'S' 
	or (a.dt_pagamento_previsto > dt_fim_periodo_w --dt_fim_lote_ref_w
	and	ie_data_base_lote_w	= 'P'))
	and	ie_origem_titulo_w <> 'M'
	and	a.dt_contabil		<= dt_fim_periodo_w
	group by
		a.nr_titulo,
		a.dt_pagamento_previsto,
		a.vl_titulo
	
union all

	select	a.nr_titulo,
		obter_saldo_tit_rec_pos_cont(a.nr_titulo, dt_fim_periodo_w),
		b.vl_pro_rata_dia,
		b.nr_sequencia,
		a.dt_vencimento,
		a.vl_titulo
	FROM estabelecimento g, titulo_receber a
LEFT OUTER JOIN pls_mensalidade b ON (a.nr_seq_mensalidade = b.nr_sequencia)
LEFT OUTER JOIN pls_mensalidade_segurado c ON (b.nr_sequencia = c.nr_seq_mensalidade)
LEFT OUTER JOIN pls_segurado e ON (c.nr_seq_segurado = e.nr_sequencia)
LEFT OUTER JOIN pls_plano f ON (e.nr_seq_plano = f.nr_sequencia)
WHERE a.cd_estabelecimento = g.cd_estabelecimento and g.cd_empresa = cd_empresa_w and ((coalesce(cd_estabelecimento_w::text, '') = '') 
	or 	(ie_considera_estab_fin_w = 'N' AND g.cd_estabelecimento	= cd_estabelecimento_w)
	or 	((ie_considera_estab_fin_w = 'S') and (coalesce(g.cd_estab_financeiro,g.cd_estabelecimento) = cd_estabelecimento_w))) and ((ie_tipo_pessoa_w = 'PF' AND a.cd_pessoa_fisica = cd_pessoa_fisica_w) or
		(ie_tipo_pessoa_w = 'PJ' AND a.cd_cgc = cd_cgc_w)) and ((coalesce(a.dt_liquidacao::text, '') = '') or (a.dt_liquidacao > dt_fim_periodo_w)) and a.ie_origem_titulo = '3' and (((ie_restringe_produto_w = 'S') and
		((f.ie_preco = ie_preco_w) or (coalesce(ie_preco_w::text, '') = '')) and
		((f.ie_tipo_contratacao	= ie_tipo_contratacao_w) or (coalesce(ie_tipo_contratacao_w::text, '') = ''))) or (ie_restringe_produto_w = 'N')) and (ie_titulo_vencer_w	= 'S' 
	or (a.dt_vencimento > dt_fim_periodo_w --dt_fim_lote_ref_w
	and	ie_data_base_lote_w	= 'V')) and a.dt_contabil		<= dt_fim_periodo_w group by
		a.nr_titulo,
		b.nr_sequencia,
		b.vl_pro_rata_dia,
		a.dt_vencimento,
		a.vl_titulo
	
union all

	/* Intercambio */

	select	a.nr_titulo,
		obter_saldo_tit_rec_pos_cont(a.nr_titulo, dt_fim_periodo_w),
		0 vl_pro_rata_dia,
		null nr_sequencia,
		a.dt_vencimento,
		a.vl_titulo
	from	titulo_receber			a,
		estabelecimento			g
	where	g.cd_empresa = cd_empresa_w
	and	a.cd_estabelecimento = g.cd_estabelecimento
	and	((coalesce(cd_estabelecimento_w::text, '') = '') 
	or 	(ie_considera_estab_fin_w = 'N' AND g.cd_estabelecimento	= cd_estabelecimento_w)
	or 	((ie_considera_estab_fin_w = 'S') and (coalesce(g.cd_estab_financeiro,g.cd_estabelecimento) = cd_estabelecimento_w)))
	and	ie_origem_titulo_w <> 'M'
	and	((ie_tipo_pessoa_w = 'PF' AND a.cd_pessoa_fisica = cd_pessoa_fisica_w) or
		(ie_tipo_pessoa_w = 'PJ' AND a.cd_cgc = cd_cgc_w))
	and	((coalesce(a.dt_liquidacao::text, '') = '') or (a.dt_liquidacao > dt_fim_periodo_w))
	and (ie_titulo_vencer_w	= 'S' 
	or (a.dt_vencimento > dt_fim_periodo_w --dt_fim_lote_ref_w
	and	ie_data_base_lote_w	= 'V'))
	and	a.dt_contabil		<= dt_fim_periodo_w
	group by
		a.nr_titulo,
		a.dt_vencimento,
		a.vl_titulo
	order by
		nr_titulo;
		

c_pessoas_outros CURSOR FOR  -- Titulos atrasados - Outros
	SELECT	a.cd_pessoa_fisica,
		a.cd_cgc
	from	titulo_receber		a,
		estabelecimento		g
	where	a.dt_pagamento_previsto < (dt_lote_w - qt_dias_w)
	and	g.cd_empresa = cd_empresa_w
	and	a.cd_estabelecimento = g.cd_estabelecimento
	and	((coalesce(cd_estabelecimento_w::text, '') = '')
	or 	(ie_considera_estab_fin_w = 'N' AND g.cd_estabelecimento	= cd_estabelecimento_w)
	or 	((ie_considera_estab_fin_w = 'S') and (coalesce(g.cd_estab_financeiro,g.cd_estabelecimento) = cd_estabelecimento_w)))
	and	((coalesce(a.dt_liquidacao::text, '') = '') or (a.dt_liquidacao > dt_fim_periodo_w))
	and	coalesce(a.nr_seq_mensalidade::text, '') = ''
	and	((coalesce(a.nr_titulo_externo::text, '') = '' and ie_titulo_externo_w = 'N') or (ie_titulo_externo_w = 'S'))
	and	ie_data_base_lote_w	= 'P'
	group by
		a.cd_pessoa_fisica,
		a.cd_cgc
	
union all

	SELECT	a.cd_pessoa_fisica,
		a.cd_cgc
	from	titulo_receber		a,
		estabelecimento		g
	where	a.dt_vencimento < (dt_lote_w - qt_dias_w)
	and	g.cd_empresa = cd_empresa_w
	and	a.cd_estabelecimento = g.cd_estabelecimento
	and	((coalesce(cd_estabelecimento_w::text, '') = '') 
	or 	(ie_considera_estab_fin_w = 'N' AND g.cd_estabelecimento	= cd_estabelecimento_w)
	or 	((ie_considera_estab_fin_w = 'S') and (coalesce(g.cd_estab_financeiro,g.cd_estabelecimento) = cd_estabelecimento_w)))
	and	((coalesce(a.dt_liquidacao::text, '') = '') or (a.dt_liquidacao > dt_fim_periodo_w))
	and	coalesce(a.nr_seq_mensalidade::text, '') = ''
	and	((coalesce(a.nr_titulo_externo::text, '') = '' and ie_titulo_externo_w = 'N') or (ie_titulo_externo_w = 'S'))
	and	ie_data_base_lote_w	= 'V'
	group by
		a.cd_pessoa_fisica,
		a.cd_cgc;

c_titulos_outros CURSOR FOR  -- Titulos da mesma pessoa que o atrasado - Outros
	SELECT	a.nr_titulo,
		obter_saldo_tit_rec_pos_cont(a.nr_titulo, dt_fim_periodo_w)
	from	titulo_receber		a,
		estabelecimento		g
	where	((coalesce(a.dt_liquidacao::text, '') = '') or (a.dt_liquidacao > dt_fim_periodo_w))
	and	coalesce(a.nr_seq_mensalidade::text, '') = ''
	and	((coalesce(a.nr_titulo_externo::text, '') = '' and ie_titulo_externo_w = 'N') or (ie_titulo_externo_w = 'S'))
	and	g.cd_empresa = cd_empresa_w
	and	a.cd_estabelecimento = g.cd_estabelecimento
	and	((coalesce(cd_estabelecimento_w::text, '') = '')
	or 	(ie_considera_estab_fin_w = 'N' AND g.cd_estabelecimento	= cd_estabelecimento_w)
	or 	((ie_considera_estab_fin_w = 'S') and (coalesce(g.cd_estab_financeiro,g.cd_estabelecimento) = cd_estabelecimento_w)))
	and	((ie_tipo_pessoa_w = 'PF' AND a.cd_pessoa_fisica = cd_pessoa_fisica_w) or
		(ie_tipo_pessoa_w = 'PJ' AND a.cd_cgc = cd_cgc_w))
	and (ie_titulo_vencer_w	= 'S' 
	or (a.dt_pagamento_previsto <= dt_fim_periodo_w --dt_lote_ref_trunc_w
	and	ie_data_base_lote_w	= 'P'))
	and	a.dt_contabil		<= dt_fim_periodo_w
	group by
		a.nr_titulo,
		obter_saldo_tit_rec_pos_cont(a.nr_titulo, dt_fim_periodo_w)
	
union all

	SELECT	a.nr_titulo,
		obter_saldo_tit_rec_pos_cont(a.nr_titulo, dt_fim_periodo_w)
	from	titulo_receber		a,
		estabelecimento		g
	where	((coalesce(a.dt_liquidacao::text, '') = '') or (a.dt_liquidacao > dt_fim_periodo_w))
	and	coalesce(a.nr_seq_mensalidade::text, '') = ''
	and	((coalesce(a.nr_titulo_externo::text, '') = '' and ie_titulo_externo_w = 'N') or (ie_titulo_externo_w = 'S'))
	and	g.cd_empresa = cd_empresa_w
	and	a.cd_estabelecimento = g.cd_estabelecimento
	and	((coalesce(cd_estabelecimento_w::text, '') = '') 
	or 	(ie_considera_estab_fin_w = 'N' AND g.cd_estabelecimento	= cd_estabelecimento_w)
	or 	((ie_considera_estab_fin_w = 'S') and (coalesce(g.cd_estab_financeiro,g.cd_estabelecimento) = cd_estabelecimento_w)))
	and	((ie_tipo_pessoa_w = 'PF' AND a.cd_pessoa_fisica = cd_pessoa_fisica_w) or
		(ie_tipo_pessoa_w = 'PJ' AND a.cd_cgc = cd_cgc_w))
	and (ie_titulo_vencer_w	= 'S' 
	or (a.dt_vencimento <= dt_fim_periodo_w --dt_lote_ref_trunc_w
	and	ie_data_base_lote_w	= 'V'))
	and	a.dt_contabil		<= dt_fim_periodo_w
	group by
		a.nr_titulo,
		obter_saldo_tit_rec_pos_cont(a.nr_titulo, dt_fim_periodo_w)
	order by
		nr_titulo;

c_itens_mensalidade CURSOR FOR
	SELECT	a.ie_tipo_item,
		coalesce(a.nr_seq_plano,b.nr_seq_plano),
		null nr_seq_sca,
		coalesce(sum(a.vl_pro_rata_dia),0) vl_pro_rata_dia,
		coalesce(sum(a.vl_antecipacao),0) vl_antecipacao,
		a.nr_seq_tipo_lanc,
		a.nr_seq_tipo_acrescimo,
                a.nr_sequencia nr_seq_mensalidade_item,
                a.cd_conta_deb cd_conta_deb_mens
	from	pls_mensalidade_seg_item	a,
		pls_mensalidade_segurado	b,
		pls_mensalidade			c
	where	a.nr_seq_mensalidade_seg	= b.nr_sequencia
	and	b.nr_seq_mensalidade		= c.nr_sequencia
	and	c.nr_sequencia			= nr_seq_mensalidade_w
	and	a.ie_tipo_item	not in ('3','6','7','15')
	group	by
		a.ie_tipo_item,
		coalesce(a.nr_seq_plano,b.nr_seq_plano),
		a.nr_seq_tipo_lanc,
		a.nr_seq_tipo_acrescimo,
                a.nr_sequencia,
                a.cd_conta_deb
	
union all

	SELECT	a.ie_tipo_item,
		null,
		coalesce(d.nr_seq_plano,b.nr_seq_plano),
		coalesce(sum(a.vl_pro_rata_dia),0) vl_pro_rata_dia,
		coalesce(sum(a.vl_antecipacao),0) vl_antecipacao,
		a.nr_seq_tipo_lanc,
		a.nr_seq_tipo_acrescimo,
                a.nr_sequencia nr_seq_mensalidade_item,
                a.cd_conta_deb cd_conta_deb_mens
	from	pls_mensalidade_seg_item	a,
		pls_sca_vinculo			d,
		pls_mensalidade_segurado	b,
		pls_mensalidade			c
	where	a.nr_seq_mensalidade_seg	= b.nr_sequencia
	and	b.nr_seq_mensalidade		= c.nr_sequencia
	and	a.nr_seq_vinculo_sca		= d.nr_sequencia
	and	c.nr_sequencia			= nr_seq_mensalidade_w
	and	a.ie_tipo_item			= '15'
	group by
		a.ie_tipo_item,
		coalesce(d.nr_seq_plano,b.nr_seq_plano),
		a.nr_seq_tipo_lanc,
		a.nr_seq_tipo_acrescimo,
                a.nr_sequencia,
                a.cd_conta_deb
	
union all

	select	a.ie_tipo_item,
		coalesce(a.nr_seq_plano,b.nr_seq_plano),
		null nr_seq_sca,
		coalesce(coalesce(sum(d.vl_copartic_mens),sum(d.vl_coparticipacao)),0) vl_pro_rata_dia,
		0 vl_antecipacao,
		a.nr_seq_tipo_lanc,
		a.nr_seq_tipo_acrescimo,
                a.nr_sequencia nr_seq_mensalidade_item,
                coalesce(d.cd_conta_deb, a.cd_conta_deb) cd_conta_deb_mens
	from	pls_conta_coparticipacao	d,
		pls_mensalidade_seg_item	a,
		pls_mensalidade_segurado	b,
		pls_mensalidade			c
	where	a.nr_seq_conta			= d.nr_seq_conta
	and	a.nr_seq_mensalidade_seg	= b.nr_sequencia
	and	b.nr_seq_mensalidade		= c.nr_sequencia
	and	c.nr_sequencia			= nr_seq_mensalidade_w
	and	((c.ie_cancelamento in ('C','E'))
	or (b.nr_sequencia	= d.nr_seq_mensalidade_seg))
	and	d.ie_status_coparticipacao  <> 'N'
	and	not exists (select	1
				from	pls_mensalidade_item_conta	x
				where	d.nr_sequencia = x.nr_seq_conta_copartic)
	and	a.ie_tipo_item	= '3'
	group by
		a.ie_tipo_item,
		coalesce(a.nr_seq_plano,b.nr_seq_plano),
		a.nr_seq_tipo_lanc,
		a.nr_seq_tipo_acrescimo,
                a.nr_sequencia,
		d.cd_conta_deb,
                a.cd_conta_deb
	
union all

	select	a.ie_tipo_item,
		coalesce(a.nr_seq_plano,b.nr_seq_plano),
		null nr_seq_sca,
		coalesce(sum(e.vl_item),0) vl_pro_rata_dia,
		0 vl_antecipacao,
		a.nr_seq_tipo_lanc,
		a.nr_seq_tipo_acrescimo,
                a.nr_sequencia nr_seq_mensalidade_item,
                coalesce(d.cd_conta_deb, a.cd_conta_deb) cd_conta_deb_mens
	from	pls_mensalidade_item_conta	e,
		pls_conta_coparticipacao	d,
		pls_mensalidade_seg_item	a,
		pls_mensalidade_segurado	b,
		pls_mensalidade			c
	where	e.nr_seq_conta_copartic		= d.nr_sequencia
	and	e.nr_seq_item			= a.nr_sequencia
	and	a.nr_seq_conta			= d.nr_seq_conta
	and	a.nr_seq_mensalidade_seg	= b.nr_sequencia
	and	b.nr_seq_mensalidade		= c.nr_sequencia
	and	c.nr_sequencia			= nr_seq_mensalidade_w
	and	((c.ie_cancelamento in ('C','E'))
	or (b.nr_sequencia	= d.nr_seq_mensalidade_seg))
	and	d.ie_status_coparticipacao  <> 'N'
	and	a.ie_tipo_item	= '3'
	group by
		a.ie_tipo_item,
		coalesce(a.nr_seq_plano,b.nr_seq_plano),
		a.nr_seq_tipo_lanc,
		a.nr_seq_tipo_acrescimo,
                a.nr_sequencia,
		d.cd_conta_deb,
                a.cd_conta_deb
	
union all

	select	a.ie_tipo_item,
		coalesce(a.nr_seq_plano,b.nr_seq_plano),
		null nr_seq_sca,
		coalesce(sum(d.vl_beneficiario),0) vl_pro_rata_dia,
		0 vl_antecipacao,
		a.nr_seq_tipo_lanc,
		a.nr_seq_tipo_acrescimo,
                a.nr_sequencia nr_seq_mensalidade_item,
                coalesce(d.cd_conta_deb, a.cd_conta_deb) cd_conta_deb_mens
	from	pls_conta_pos_estabelecido	d,
		pls_mensalidade_seg_item	a,
		pls_mensalidade_segurado	b,
		pls_mensalidade			c
	where	a.nr_seq_conta			= d.nr_seq_conta
	and	a.nr_seq_mensalidade_seg	= b.nr_sequencia
	and	b.nr_seq_mensalidade		= c.nr_sequencia
	and	c.nr_sequencia			= nr_seq_mensalidade_w
	and	((c.ie_cancelamento in ('C','E'))
	or (b.nr_sequencia	= d.nr_seq_mensalidade_seg))
	and	not exists (select	1
				from	pls_mensalidade_item_conta	x
				where	d.nr_sequencia = x.nr_seq_conta_pos_estab)
	and	a.ie_tipo_item in ('6', '7')
	group by
		a.ie_tipo_item,
		coalesce(a.nr_seq_plano,b.nr_seq_plano),
		a.nr_seq_tipo_lanc,
		a.nr_seq_tipo_acrescimo,
                a.nr_sequencia,
		d.cd_conta_deb,
                a.cd_conta_deb
	
union all

	select	a.ie_tipo_item,
		coalesce(a.nr_seq_plano,b.nr_seq_plano),
		null nr_seq_sca,
		coalesce(sum(e.vl_item),0) vl_pro_rata_dia,
		0 vl_antecipacao,
		a.nr_seq_tipo_lanc,
		a.nr_seq_tipo_acrescimo,
                a.nr_sequencia nr_seq_mensalidade_item,
                coalesce(d.cd_conta_deb, a.cd_conta_deb) cd_conta_deb_mens
	from	pls_mensalidade_item_conta	e,
		pls_conta_pos_estabelecido	d,
		pls_mensalidade_seg_item	a,
		pls_mensalidade_segurado	b,
		pls_mensalidade			c
	where	e.nr_seq_conta_copartic		= d.nr_sequencia
	and	e.nr_seq_item			= a.nr_sequencia
	and	a.nr_seq_conta			= d.nr_seq_conta
	and	a.nr_seq_mensalidade_seg	= b.nr_sequencia
	and	b.nr_seq_mensalidade		= c.nr_sequencia
	and	c.nr_sequencia			= nr_seq_mensalidade_w
	and	((c.ie_cancelamento in ('C','E'))
	or (b.nr_sequencia	= d.nr_seq_mensalidade_seg))
	and	a.ie_tipo_item in ('6', '7')
	group by
		a.ie_tipo_item,
		coalesce(a.nr_seq_plano,b.nr_seq_plano),
		a.nr_seq_tipo_lanc,
		a.nr_seq_tipo_acrescimo,
                a.nr_sequencia,
		d.cd_conta_deb,
                a.cd_conta_deb;
		
	
c_pessoas_cheque CURSOR FOR
	SELECT	a.cd_pessoa_fisica,
		a.cd_cgc
	from	cheque_cr		a,
		estabelecimento 	e
	where	e.cd_estabelecimento = a.cd_estabelecimento
	and	e.cd_empresa = cd_empresa_w
	and	coalesce(a.dt_vencimento_atual,a.dt_vencimento) < (dt_lote_w - qt_dias_w)
	and	((coalesce(cd_estabelecimento_w::text, '') = '') 
	or 	(ie_considera_estab_fin_w = 'N' AND e.cd_estabelecimento	= cd_estabelecimento_w)
	or 	((ie_considera_estab_fin_w = 'S') and (coalesce(e.cd_estab_financeiro,e.cd_estabelecimento) = cd_estabelecimento_w)))
	and	((coalesce(a.dt_compensacao::text, '') = '') or (a.dt_compensacao > dt_fim_periodo_w)) -- "baixa"
	and	ie_data_base_lote_w	= 'P' -- Data prorrogada
	group by
		a.cd_pessoa_fisica,
		a.cd_cgc
	
union all

	SELECT	a.cd_pessoa_fisica,
		a.cd_cgc
	from	cheque_cr		a
	where	a.dt_vencimento < (dt_lote_w - qt_dias_w)
	and	((coalesce(a.dt_compensacao::text, '') = '') or (a.dt_compensacao > dt_fim_periodo_w))
	and	ie_data_base_lote_w	= 'V' -- Data de vencimento
	group by
		a.cd_pessoa_fisica,
		a.cd_cgc;
		
c_cheques CURSOR FOR
	SELECT	a.nr_seq_cheque,
		a.vl_cheque
	from	cheque_cr		a,
		estabelecimento 	e
	where	e.cd_estabelecimento = a.cd_estabelecimento
	and	e.cd_empresa = cd_empresa_w
	and	coalesce(a.dt_vencimento_atual,a.dt_vencimento) < (dt_lote_w - qt_dias_w)
	and	((coalesce(cd_estabelecimento_w::text, '') = '') 
	or 	(ie_considera_estab_fin_w = 'N' AND e.cd_estabelecimento	= cd_estabelecimento_w)
	or 	((ie_considera_estab_fin_w = 'S') and (coalesce(e.cd_estab_financeiro,e.cd_estabelecimento) = cd_estabelecimento_w)))
	and	((coalesce(a.dt_compensacao::text, '') = '') or (a.dt_compensacao > dt_fim_periodo_w)) 
	and	ie_data_base_lote_w	= 'P' -- Data prorrogada
	and	((ie_tipo_pessoa_w = 'PF' AND a.cd_pessoa_fisica = cd_pessoa_fisica_w) or
		(ie_tipo_pessoa_w = 'PJ' AND a.cd_cgc = cd_cgc_w))
	
union all

	SELECT	a.nr_seq_cheque,
		a.vl_cheque
	from	cheque_cr		a
	where	a.dt_vencimento < (dt_lote_w - qt_dias_w)
	and	a.cd_estabelecimento = cd_estabelecimento_p
	and	((coalesce(a.dt_compensacao::text, '') = '') or (a.dt_compensacao > dt_fim_periodo_w))
	and	ie_data_base_lote_w	= 'V' -- Data de vencimento
	and	((ie_tipo_pessoa_w = 'PF' AND a.cd_pessoa_fisica = cd_pessoa_fisica_w) or
		(ie_tipo_pessoa_w = 'PJ' AND a.cd_cgc = cd_cgc_w));

c_pessoas_adiant CURSOR FOR
	SELECT	a.cd_pessoa_fisica,
		a.cd_cgc
	from	adiantamento_pago	a,
		estabelecimento 	e
	where	e.cd_estabelecimento = a.cd_estabelecimento
	and	e.cd_empresa = cd_empresa_w
	and (dt_lote_w - a.dt_adiantamento) > qt_dias_adiantamento_w
	and	((coalesce(cd_estabelecimento_w::text, '') = '')
	or 	(ie_considera_estab_fin_w = 'N' AND e.cd_estabelecimento	= cd_estabelecimento_w)
	or 	((ie_considera_estab_fin_w = 'S') and (coalesce(e.cd_estab_financeiro,e.cd_estabelecimento) = cd_estabelecimento_w)))
	and	((coalesce(a.dt_baixa::text, '') = '') or (a.dt_baixa > dt_fim_periodo_w))
	group by
		a.cd_pessoa_fisica,
		a.cd_cgc;

c_adiantamento CURSOR FOR
	SELECT	a.nr_adiantamento,
		a.vl_adiantamento
	from	adiantamento_pago	a,
		estabelecimento 	e
	where	e.cd_estabelecimento = a.cd_estabelecimento
	and	e.cd_empresa = cd_empresa_w
	and (dt_lote_w - a.dt_adiantamento) > qt_dias_adiantamento_w
	and	((coalesce(cd_estabelecimento_w::text, '') = '')
	or 	(ie_considera_estab_fin_w = 'N' AND e.cd_estabelecimento	= cd_estabelecimento_w)
	or 	((ie_considera_estab_fin_w = 'S') and (coalesce(e.cd_estab_financeiro,e.cd_estabelecimento) = cd_estabelecimento_w)))
	and	((coalesce(a.dt_baixa::text, '') = '') or (a.dt_baixa > dt_fim_periodo_w))
	and	((ie_tipo_pessoa_w = 'PF' AND a.cd_pessoa_fisica = cd_pessoa_fisica_w) or
		(ie_tipo_pessoa_w = 'PJ' AND a.cd_cgc = cd_cgc_w));
		
c_ppsc_movimento CURSOR FOR
	SELECT	nr_titulo_original
	from	pls_ppsc_movimento
	where 	nr_seq_lote = nr_seq_lote_p
	and 	coalesce(nr_titulo_original, 0) <> 0;


BEGIN

if (ie_opcao_p = 'G') then
	select	dt_lote,
		coalesce(ie_consolida_empresa,'N'),
		coalesce(ie_considera_estab_fin,'N')
	into STRICT	dt_lote_w,
		ie_consolida_empresa_w,
		ie_considera_estab_fin_w
	from	pls_ppsc_lote
	where	nr_sequencia	= nr_seq_lote_p;

	dt_fim_periodo_w	:= fim_dia(last_day(dt_lote_w));
	dt_lote_ref_trunc_w	:= trunc(dt_fim_periodo_w, 'MONTH');
	dt_fim_lote_ref_w	:= fim_mes(dt_lote_ref_trunc_w);
	
	cd_empresa_w := obter_empresa_estab(cd_estabelecimento_p);
	cd_estabelecimento_w := cd_estabelecimento_p;
	
	if (ie_consolida_empresa_w = 'S') then
		cd_estabelecimento_w := null;
	end if;

	open c_regras_ppsc;
	loop
	fetch c_regras_ppsc into
		ie_preco_w,
		ie_tipo_contratacao_w,
		qt_dias_w,
		ie_origem_titulo_w,
		ie_tipo_operacao_w,
		ie_pro_rata_mes_w,
		nr_seq_regra_ppsc_w,
		ie_titulo_externo_w,
		ie_data_base_lote_w,
		ie_restringe_produto_w,
		ie_cheque_w,
		ie_titulo_vencer_w,
		qt_dias_adiantamento_w;
	EXIT WHEN NOT FOUND; /* apply on c_regras_ppsc */
		begin
		
		if (ie_origem_titulo_w = 'M') then -- Titulos de mensalidade
			open c_pessoas_mensalidade;
			loop
			fetch c_pessoas_mensalidade into
				cd_pessoa_fisica_w,
				cd_cgc_w;
			EXIT WHEN NOT FOUND; /* apply on c_pessoas_mensalidade */
				begin
				if (cd_pessoa_fisica_w IS NOT NULL AND cd_pessoa_fisica_w::text <> '') then
					ie_tipo_pessoa_w	:= 'PF';
					
					if (ie_data_base_lote_w = 'P') then
						select  min(nr_titulo)
						into STRICT	nr_titulo_atrasado_w
						from	pls_mensalidade_segurado	c,
							pls_segurado			d,
							pls_plano			e,
							pls_contrato_pagador		f,
							pls_mensalidade			b,
							titulo_receber			a,
							estabelecimento			g
						where	a.nr_seq_mensalidade	= b.nr_sequencia
						and	c.nr_seq_mensalidade	= b.nr_sequencia
						and	c.nr_seq_segurado	= d.nr_sequencia
						and	d.nr_seq_plano		= e.nr_sequencia
						and	d.nr_seq_pagador	= f.nr_sequencia
						and	g.cd_empresa = cd_empresa_w
						and	a.cd_estabelecimento   	= g.cd_estabelecimento
						and	((coalesce(cd_estabelecimento_w::text, '') = '') or (g.cd_estabelecimento = cd_estabelecimento_w))
						and	a.cd_pessoa_fisica 	= cd_pessoa_fisica_w
						and	((e.ie_preco		= ie_preco_w) or (coalesce(ie_preco_w::text, '') = ''))
						and	((e.ie_tipo_contratacao	= ie_tipo_contratacao_w) or (coalesce(ie_tipo_contratacao_w::text, '') = ''))
						and	a.dt_pagamento_previsto < (dt_lote_w - qt_dias_w)
						and	((coalesce(a.dt_liquidacao::text, '') = '') or (a.dt_liquidacao > dt_fim_periodo_w));
					else
						select  min(nr_titulo)
						into STRICT	nr_titulo_atrasado_w
						from	pls_mensalidade_segurado	c,
							pls_segurado			d,
							pls_plano			e,
							pls_contrato_pagador		f,
							pls_mensalidade			b,
							titulo_receber			a,
							estabelecimento			g
						where	a.nr_seq_mensalidade	= b.nr_sequencia
						and	c.nr_seq_mensalidade	= b.nr_sequencia
						and	c.nr_seq_segurado	= d.nr_sequencia
						and	d.nr_seq_plano		= e.nr_sequencia
						and	d.nr_seq_pagador	= f.nr_sequencia
						and	g.cd_empresa = cd_empresa_w					
						and	a.cd_estabelecimento	= g.cd_estabelecimento
						and	((coalesce(cd_estabelecimento_w::text, '') = '') or (g.cd_estabelecimento = cd_estabelecimento_w))
						and	a.cd_pessoa_fisica 	= cd_pessoa_fisica_w
						and	((e.ie_preco		= ie_preco_w) or (coalesce(ie_preco_w::text, '') = ''))
						and	((e.ie_tipo_contratacao	= ie_tipo_contratacao_w) or (coalesce(ie_tipo_contratacao_w::text, '') = ''))
						and	a.dt_vencimento < (dt_lote_w - qt_dias_w)
						and	((coalesce(a.dt_liquidacao::text, '') = '') or (a.dt_liquidacao > dt_fim_periodo_w));
					end if;
				elsif (cd_cgc_w IS NOT NULL AND cd_cgc_w::text <> '') then
					ie_tipo_pessoa_w	:= 'PJ';
					
					if (ie_data_base_lote_w = 'P') then
						select  min(nr_titulo)
						into STRICT	nr_titulo_atrasado_w
						from	pls_mensalidade_segurado	c,
							pls_segurado			d,
							pls_plano			e,
							pls_contrato_pagador		f,
							pls_mensalidade			b,
							titulo_receber			a,
							estabelecimento			g
						where	a.nr_seq_mensalidade	= b.nr_sequencia
						and	c.nr_seq_mensalidade	= b.nr_sequencia
						and	c.nr_seq_segurado	= d.nr_sequencia
						and	d.nr_seq_plano		= e.nr_sequencia
						and	d.nr_seq_pagador	= f.nr_sequencia
						and	g.cd_empresa = cd_empresa_w							
						and	a.cd_estabelecimento	= g.cd_estabelecimento
						and	((coalesce(cd_estabelecimento_w::text, '') = '') or (g.cd_estabelecimento = cd_estabelecimento_w))
						and	a.cd_cgc 		= cd_cgc_w
						and	((e.ie_preco		= ie_preco_w) or (coalesce(ie_preco_w::text, '') = ''))
						and	((e.ie_tipo_contratacao	= ie_tipo_contratacao_w) or (coalesce(ie_tipo_contratacao_w::text, '') = ''))
						and	a.dt_pagamento_previsto < (dt_lote_w - qt_dias_w)
						and	((coalesce(a.dt_liquidacao::text, '') = '') or (a.dt_liquidacao > dt_fim_periodo_w));
					else
						select  min(nr_titulo)
						into STRICT	nr_titulo_atrasado_w
						from	pls_mensalidade_segurado	c,
							pls_segurado			d,
							pls_plano			e,
							pls_contrato_pagador		f,
							pls_mensalidade			b,
							titulo_receber			a,
							estabelecimento			g
						where	a.nr_seq_mensalidade	= b.nr_sequencia
						and	c.nr_seq_mensalidade	= b.nr_sequencia
						and	c.nr_seq_segurado	= d.nr_sequencia
						and	d.nr_seq_plano		= e.nr_sequencia
						and	d.nr_seq_pagador	= f.nr_sequencia
						and	g.cd_empresa = cd_empresa_w						
						and	a.cd_estabelecimento	= g.cd_estabelecimento
						and	((coalesce(cd_estabelecimento_w::text, '') = '') or (g.cd_estabelecimento = cd_estabelecimento_w))
						and	a.cd_cgc 		= cd_cgc_w
						and	((e.ie_preco		= ie_preco_w) or (coalesce(ie_preco_w::text, '') = ''))
						and	((e.ie_tipo_contratacao	= ie_tipo_contratacao_w) or (coalesce(ie_tipo_contratacao_w::text, '') = ''))
						and	a.dt_vencimento < (dt_lote_w - qt_dias_w)
						and	((coalesce(a.dt_liquidacao::text, '') = '') or (a.dt_liquidacao > dt_fim_periodo_w));
					end if;
				end if;

				open c_titulos_mensalidade;
				loop
				fetch c_titulos_mensalidade into
					nr_titulo_w,
					vl_saldo_titulo_w,
					vl_pro_rata_dia_w,
					nr_seq_mensalidade_w,
					dt_pagamento_previsto_w,
					vl_titulo_w;
				EXIT WHEN NOT FOUND; /* apply on c_titulos_mensalidade */
					begin
					if (ie_pro_rata_mes_w = 'S') then
						if (trunc(dt_pagamento_previsto_w, 'MONTH') = dt_lote_ref_trunc_w) then
							vl_saldo_titulo_w	:= vl_pro_rata_dia_w;
						end if;
					end if;
					
					if (nr_titulo_atrasado_w = nr_titulo_w) then
						ie_incidencia_titulo_w	:= 'P';
						nr_titulo_provisao_w	:= null;
					else
						ie_incidencia_titulo_w	:= 'C';
						nr_titulo_provisao_w	:= nr_titulo_atrasado_w;
					end if;

					select	count(1)
					into STRICT	qt_titulo_w
					from	pls_ppsc_movimento
					where	nr_seq_titulo	= nr_titulo_w
					and	nr_seq_lote	= nr_seq_lote_p  LIMIT 1;

					if (qt_titulo_w = 0) then
						select	nextval('pls_ppsc_movimento_seq')
						into STRICT	nr_seq_movimento_w
						;

						insert into pls_ppsc_movimento(nr_sequencia,
							nr_seq_lote,
							cd_estabelecimento,
							nr_seq_titulo,
							dt_atualizacao,
							nm_usuario,
							dt_atualizacao_nrec,
							nm_usuario_nrec,
							vl_saldo_titulo,
							ie_tipo_operacao,
							ie_incidencia_titulo,
							nr_titulo_original,
							nr_lote_contabil,
							nr_seq_regra_ppsc)
						values (nr_seq_movimento_w,
							nr_seq_lote_p,
							cd_estabelecimento_p,
							nr_titulo_w,
							clock_timestamp(),
							nm_usuario_p,
							clock_timestamp(),
							nm_usuario_p,
							vl_saldo_titulo_w,
							ie_tipo_operacao_w,
							ie_incidencia_titulo_w,
							nr_titulo_provisao_w,
							0,
							nr_seq_regra_ppsc_w);
							
						qt_commit_w	:= qt_commit_w + 1;
						
						if (qt_commit_w > 500) then
							commit;
							qt_commit_w	:= 0;
						end if;

						open c_itens_mensalidade;
						loop
						fetch c_itens_mensalidade into
							ie_tipo_item_w,
							nr_seq_plano_w,
							nr_seq_sca_w,
							vl_pro_rata_dia_w,
							vl_antecipacao_w,
							nr_seq_tipo_lanc_w,
							nr_seq_tipo_acrescimo_w,
                                                        nr_seq_mensalidade_item_w,
                                                        cd_conta_deb_item_mens_w;
						EXIT WHEN NOT FOUND; /* apply on c_itens_mensalidade */
							begin
							if (ie_pro_rata_mes_w = 'S' and trunc(dt_pagamento_previsto_w, 'MONTH') = dt_lote_ref_trunc_w) then
								vl_saldo_contabil_w	:= vl_pro_rata_dia_w;
							else
								vl_saldo_contabil_w	:= dividir_sem_round(vl_saldo_titulo_w, vl_titulo_w) * (vl_pro_rata_dia_w + vl_antecipacao_w);
								
								if (vl_saldo_titulo_w < vl_titulo_w) then
									vl_item_w		:= dividir_sem_round(vl_saldo_titulo_w, vl_titulo_w) * (vl_pro_rata_dia_w + vl_antecipacao_w);
								end if;
							end if;

							insert into pls_ppsc_movimento_item(nr_sequencia,
								nr_seq_movimento,
								cd_estabelecimento,
								dt_atualizacao,
								nm_usuario,
								dt_atualizacao_nrec,
								nm_usuario_nrec,
								nr_seq_plano,
								ie_tipo_item,
								nr_seq_plano_sca,
								vl_item,
								nr_lote_contabil,
								nr_seq_tipo_lancamento,
								vl_saldo_contabil,
								nr_seq_tipo_acrescimo,
                                                                nr_seq_mensalidade_item,
                                                                cd_conta_deb_mens)
							values (nextval('pls_ppsc_movimento_item_seq'),
								nr_seq_movimento_w,
								cd_estabelecimento_p,
								clock_timestamp(),
								nm_usuario_p,
								clock_timestamp(),
								nm_usuario_p,
								nr_seq_plano_w,
								ie_tipo_item_w,
								nr_seq_sca_w,
								vl_item_w,
								0,
								nr_seq_tipo_lanc_w,
								vl_saldo_contabil_w,
								nr_seq_tipo_acrescimo_w,
                                                                nr_seq_mensalidade_item_w,
                                                                cd_conta_deb_item_mens_w);
							end;
						end loop;
						close c_itens_mensalidade;
					end if;
					end;
				end loop;
				close c_titulos_mensalidade;
				
				if (ie_titulo_vencer_w = 'S') then
					open c_titulos_em_aberto;
					loop
					fetch c_titulos_em_aberto into
						nr_titulo_w,
						vl_saldo_titulo_w,
						vl_pro_rata_dia_w,
						nr_seq_mensalidade_w,
						dt_pagamento_previsto_w,
						vl_titulo_w;
					EXIT WHEN NOT FOUND; /* apply on c_titulos_em_aberto */
						begin					
						if (ie_pro_rata_mes_w = 'S') then
							if (trunc(dt_pagamento_previsto_w, 'MONTH') = dt_lote_ref_trunc_w) then
								vl_saldo_titulo_w	:= vl_pro_rata_dia_w;
							end if;
						end if;
						
						if (nr_titulo_aberto_w = nr_titulo_w) then
							ie_incidencia_titulo_w	:= 'P';
							nr_titulo_provisao_w	:= null;
						else
							ie_incidencia_titulo_w	:= 'C';
							nr_titulo_provisao_w	:= nr_titulo_aberto_w;
						end if;

						select	count(1)
						into STRICT	qt_titulo_w
						from	pls_ppsc_movimento
						where	nr_seq_titulo	= nr_titulo_w
						and	nr_seq_lote	= nr_seq_lote_p  LIMIT 1;

						if (qt_titulo_w = 0) then
							select	nextval('pls_ppsc_movimento_seq')
							into STRICT	nr_seq_movimento_w
							;

							insert into pls_ppsc_movimento(nr_sequencia,
								nr_seq_lote,
								cd_estabelecimento,
								nr_seq_titulo,
								dt_atualizacao,
								nm_usuario,
								dt_atualizacao_nrec,
								nm_usuario_nrec,
								vl_saldo_titulo,
								ie_tipo_operacao,
								ie_incidencia_titulo,
								nr_titulo_original,
								nr_lote_contabil,
								nr_seq_regra_ppsc)
							values (nr_seq_movimento_w,
								nr_seq_lote_p,
								cd_estabelecimento_p,
								nr_titulo_w,
								clock_timestamp(),
								nm_usuario_p,
								clock_timestamp(),
								nm_usuario_p,
								vl_saldo_titulo_w,
								ie_tipo_operacao_w,
								ie_incidencia_titulo_w,
								nr_titulo_provisao_w,
								0,
								nr_seq_regra_ppsc_w);
								
							qt_commit_w	:= qt_commit_w + 1;
							
							if (qt_commit_w > 500) then
								commit;
								qt_commit_w	:= 0;
							end if;

							open c_itens_mensalidade;
							loop
							fetch c_itens_mensalidade into
								ie_tipo_item_w,
								nr_seq_plano_w,
								nr_seq_sca_w,
								vl_pro_rata_dia_w,
								vl_antecipacao_w,
								nr_seq_tipo_lanc_w,
								nr_seq_tipo_acrescimo_w,
                                                                nr_seq_mensalidade_item_w,
                                                                cd_conta_deb_item_mens_w;
							EXIT WHEN NOT FOUND; /* apply on c_itens_mensalidade */
								begin
									
								if (ie_pro_rata_mes_w = 'S' and trunc(dt_pagamento_previsto_w, 'MONTH') = dt_lote_ref_trunc_w) then
									vl_saldo_contabil_w	:= vl_pro_rata_dia_w;
								else
									vl_saldo_contabil_w	:= dividir_sem_round(vl_saldo_titulo_w, vl_titulo_w) * (vl_pro_rata_dia_w + vl_antecipacao_w);
									
									if (vl_saldo_titulo_w < vl_titulo_w) then
										vl_item_w		:= dividir_sem_round(vl_saldo_titulo_w, vl_titulo_w) * (vl_pro_rata_dia_w + vl_antecipacao_w);
									end if;
								end if;
								
								insert into pls_ppsc_movimento_item(nr_sequencia,
									nr_seq_movimento,
									cd_estabelecimento,
									dt_atualizacao,
									nm_usuario,
									dt_atualizacao_nrec,
									nm_usuario_nrec,
									nr_seq_plano,
									ie_tipo_item,
									nr_seq_plano_sca,
									vl_item,
									nr_lote_contabil,
									nr_seq_tipo_lancamento,
									vl_saldo_contabil,
									nr_seq_tipo_acrescimo,
                                                                        nr_seq_mensalidade_item,
                                                                        cd_conta_deb_mens)
								values (nextval('pls_ppsc_movimento_item_seq'),
									nr_seq_movimento_w,
									cd_estabelecimento_p,
									clock_timestamp(),
									nm_usuario_p,
									clock_timestamp(),
									nm_usuario_p,
									nr_seq_plano_w,
									ie_tipo_item_w,
									nr_seq_sca_w,
									vl_item_w,
									0,
									nr_seq_tipo_lanc_w,
									vl_saldo_contabil_w,
									nr_seq_tipo_acrescimo_w,
                                                                        nr_seq_mensalidade_item_w,
                                                                        cd_conta_deb_item_mens_w);
								end;
							end loop;
							close c_itens_mensalidade;
						end if;
						end;
					end loop;
					close c_titulos_em_aberto;
				end if;
				end;
			end loop;
			close c_pessoas_mensalidade;
		elsif (ie_origem_titulo_w = 'O') then
			open c_pessoas_outros;
			loop
			fetch c_pessoas_outros into
				cd_pessoa_fisica_w,
				cd_cgc_w;
			EXIT WHEN NOT FOUND; /* apply on c_pessoas_outros */
				begin			
				if (coalesce(cd_pessoa_fisica_w, '0') <> '0') then
					ie_tipo_pessoa_w	:= 'PF';
				elsif (coalesce(cd_cgc_w,'0') <> '0') then
					ie_tipo_pessoa_w	:= 'PJ';
				end if;
				
				if (ie_data_base_lote_w = 'P') then
					select	min(nr_titulo)
					into STRICT	nr_titulo_atrasado_w
					from	titulo_receber		a,
						estabelecimento		g
					where	a.dt_pagamento_previsto < (dt_lote_w - qt_dias_w)
					and	g.cd_empresa = cd_empresa_w
					and	a.cd_estabelecimento	= g.cd_estabelecimento
					and	((coalesce(cd_estabelecimento_w::text, '') = '') or (g.cd_estabelecimento = cd_estabelecimento_w))
					and	((ie_tipo_pessoa_w = 'PF' AND a.cd_pessoa_fisica = cd_pessoa_fisica_w) or
						(ie_tipo_pessoa_w = 'PJ' AND a.cd_cgc = cd_cgc_w))
					and	((coalesce(a.dt_liquidacao::text, '') = '') or (a.dt_liquidacao > dt_fim_periodo_w))
					and	coalesce(a.nr_seq_mensalidade::text, '') = '';
				else
					select	min(nr_titulo)
					into STRICT	nr_titulo_atrasado_w
					from	titulo_receber		a,
						estabelecimento		g
					where	a.dt_vencimento < (dt_lote_w - qt_dias_w)
					and	g.cd_empresa = cd_empresa_w
					and	a.cd_estabelecimento	= g.cd_estabelecimento
					and	((coalesce(cd_estabelecimento_w::text, '') = '') or (g.cd_estabelecimento = cd_estabelecimento_w))
					and	((ie_tipo_pessoa_w = 'PF' AND a.cd_pessoa_fisica = cd_pessoa_fisica_w) or
						(ie_tipo_pessoa_w = 'PJ' AND a.cd_cgc = cd_cgc_w))
					and	((coalesce(a.dt_liquidacao::text, '') = '') or (a.dt_liquidacao > dt_fim_periodo_w))
					and	coalesce(a.nr_seq_mensalidade::text, '') = '';
				end if;

				open c_titulos_outros;
				loop
				fetch c_titulos_outros into
					nr_titulo_w,
					vl_saldo_titulo_w;
				EXIT WHEN NOT FOUND; /* apply on c_titulos_outros */
					begin
					if (nr_titulo_atrasado_w = nr_titulo_w) then
						ie_incidencia_titulo_w	:= 'P';
						nr_titulo_provisao_w	:= null;
					else
						ie_incidencia_titulo_w	:= 'C';
						nr_titulo_provisao_w	:= nr_titulo_atrasado_w;
					end if;

					select	count(1)
					into STRICT	qt_titulo_w
					from	pls_ppsc_movimento
					where	nr_seq_titulo	= nr_titulo_w
					and	nr_seq_lote	= nr_seq_lote_p  LIMIT 1;

					if (qt_titulo_w = 0) then
						insert into pls_ppsc_movimento(nr_sequencia,
							nr_seq_lote,
							cd_estabelecimento,
							nr_seq_titulo,
							dt_atualizacao,
							nm_usuario,
							dt_atualizacao_nrec,
							nm_usuario_nrec,
							vl_saldo_titulo,
							ie_tipo_operacao,
							ie_incidencia_titulo,
							nr_titulo_original,
							nr_lote_contabil)
						values (nextval('pls_ppsc_movimento_seq'),
							nr_seq_lote_p,
							cd_estabelecimento_p,
							nr_titulo_w,
							clock_timestamp(),
							nm_usuario_p,
							clock_timestamp(),
							nm_usuario_p,
							vl_saldo_titulo_w,
							ie_tipo_operacao_w,
							ie_incidencia_titulo_w,
							nr_titulo_provisao_w,
							0);
					end if;
					end;
				end loop;
				close c_titulos_outros;
				end;
			end loop;
			close c_pessoas_outros;
		end if;
		
		if (ie_cheque_w = 'S') then
			open c_pessoas_cheque;
			loop
			fetch c_pessoas_cheque into	
				cd_pessoa_fisica_w,
				cd_cgc_w;
			EXIT WHEN NOT FOUND; /* apply on c_pessoas_cheque */
				begin
				if (cd_pessoa_fisica_w IS NOT NULL AND cd_pessoa_fisica_w::text <> '') then
					ie_tipo_pessoa_w	:= 'PF';
				else
					ie_tipo_pessoa_w	:= 'PJ';
				end if;
				
				open c_cheques;
				loop
				fetch c_cheques into	
					nr_seq_cheque_w,
					vl_cheque_w;
				EXIT WHEN NOT FOUND; /* apply on c_cheques */
					begin
					select	count(1)
					into STRICT	qt_cheque_w
					from	pls_ppsc_movimento
					where	nr_seq_cheque	= nr_seq_cheque_w
					and	nr_seq_lote	= nr_seq_lote_p  LIMIT 1;

					if (qt_cheque_w = 0) then
						insert into pls_ppsc_movimento(nr_sequencia,
							nr_seq_lote,
							cd_estabelecimento,
							nr_seq_cheque,
							dt_atualizacao,
							nm_usuario,
							dt_atualizacao_nrec,
							nm_usuario_nrec,
							vl_saldo_titulo,
							ie_tipo_operacao,
							ie_incidencia_titulo,
							nr_titulo_original,
							nr_lote_contabil)
						values (nextval('pls_ppsc_movimento_seq'),
							nr_seq_lote_p,
							cd_estabelecimento_p,
							nr_seq_cheque_w,
							clock_timestamp(),
							nm_usuario_p,
							clock_timestamp(),
							nm_usuario_p,
							vl_cheque_w,
							ie_tipo_operacao_w,
							'P',
							null,
							0);
					end if;
					end;
				end loop;
				close c_cheques;
				end;
			end loop;
			close c_pessoas_cheque;
		end if;
		end;
		if (qt_dias_adiantamento_w > 0) then
			begin
			open c_pessoas_adiant;
			loop
			fetch c_pessoas_adiant into
				cd_pessoa_fisica_w,
				cd_cgc_w;
			EXIT WHEN NOT FOUND; /* apply on c_pessoas_adiant */
				begin
				if (cd_pessoa_fisica_w IS NOT NULL AND cd_pessoa_fisica_w::text <> '') then
					ie_tipo_pessoa_w	:= 'PF';
				else
					ie_tipo_pessoa_w	:= 'PJ';
				end if;

				open c_adiantamento;
				loop
				fetch c_adiantamento into
					nr_adiantamento_w,
					vl_adiantamento_w;
				EXIT WHEN NOT FOUND; /* apply on c_adiantamento */
					begin
					select	count(1)
					into STRICT	qt_cheque_w
					from	pls_ppsc_movimento
					where	nr_adiantamento	= nr_adiantamento_w
					and	nr_seq_lote	= nr_seq_lote_p  LIMIT 1;

					if (qt_cheque_w = 0) then
						insert into pls_ppsc_movimento(nr_sequencia,
							nr_seq_lote,
							cd_estabelecimento,
							nr_adiantamento,
							dt_atualizacao,
							nm_usuario,
							dt_atualizacao_nrec,
							nm_usuario_nrec,
							vl_saldo_titulo,
							ie_tipo_operacao,
							ie_incidencia_titulo,
							nr_titulo_original,
							nr_lote_contabil)
						values (nextval('pls_ppsc_movimento_seq'),
							nr_seq_lote_p,
							cd_estabelecimento_p,
							nr_adiantamento_w,
							clock_timestamp(),

							nm_usuario_p,
							clock_timestamp(),

							nm_usuario_p,
							vl_cheque_w,
							ie_tipo_operacao_w,
							'P',
							null,

							0);
					end if;
					end;
				end loop;
				close c_adiantamento;
				end;
			end loop;
			close c_pessoas_adiant;
			end;
		end if;
	end loop;
	close c_regras_ppsc;

	update	pls_ppsc_lote
	set	dt_geracao_lote	= clock_timestamp(),
		nm_usuario_lote	= nm_usuario_p
	where	nr_sequencia	= nr_seq_lote_p;
	
	commit;
	
	if (coalesce(ie_recalc_tit_p, 'N') = 'S') then
		begin
		
		open c_ppsc_movimento;
		loop
		fetch c_ppsc_movimento into
			nr_titulo_original_w;
		EXIT WHEN NOT FOUND; /* apply on c_ppsc_movimento */
			begin
			
			CALL consiste_classif_tit_rec_lote(	nr_titulo_original_w,
											nm_usuario_p);
											
			select	count(1)
			into STRICT	qt_movimento_ppsc_w
			from	w_cons_recalc_tit_classif
			where	nr_titulo_receber = nr_titulo_original_w  LIMIT 1;
			
			if (qt_movimento_ppsc_w = 0) then
				begin
				CALL recalcular_titulo_rec_classif(	nr_titulo_original_w,
												nm_usuario_p);
				end;
			end if;
			
			
			end;
		end loop;
		close c_ppsc_movimento;
		
		end;
	end if;
	
elsif (ie_opcao_p = 'A') then
	update	pls_ppsc_lote
	set	ie_status	= 'D'
	where	nr_sequencia	= nr_seq_lote_p;
elsif (ie_opcao_p = 'D') then
	select	dt_lote
	into STRICT	dt_lote_w
	from	pls_ppsc_lote
	where	nr_sequencia	= nr_seq_lote_p;

	select	count(1)
	into STRICT	qt_lote_contabil_item_w
	from	pls_ppsc_movimento b,
		pls_ppsc_movimento_item a
	where	a.nr_seq_movimento	= b.nr_sequencia
	and	b.nr_seq_lote		= nr_seq_lote_p
	and	a.nr_lote_contabil <> 0  LIMIT 1;

	select	count(1)
	into STRICT	qt_lote_contabil_w
	from	pls_ppsc_movimento a
	where	a.nr_seq_lote	= nr_seq_lote_p
	and	a.nr_lote_contabil <> 0  LIMIT 1;

	if (qt_lote_contabil_w > 0) then
		CALL wheb_mensagem_pck.exibir_mensagem_abort(183923);
	end if;

	if (qt_lote_contabil_item_w > 0) then
		CALL wheb_mensagem_pck.exibir_mensagem_abort(183926);
	end if;

	delete	from pls_ppsc_movimento_item a
	where	exists (SELECT	1
			from	pls_ppsc_movimento	x
			where	x.nr_sequencia	= a.nr_seq_movimento
			and	x.nr_seq_lote	= nr_seq_lote_p);

	delete	from pls_ppsc_movimento
	where	nr_seq_lote	= nr_seq_lote_p;

	update	pls_ppsc_lote
	set	dt_geracao_lote	 = NULL,
		nm_usuario_lote	 = NULL
	where	nr_sequencia	= nr_seq_lote_p;
elsif (ie_opcao_p = 'DA') then
	update	pls_ppsc_lote
	set	ie_status	= 'P'
	where	nr_sequencia	= nr_seq_lote_p;
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_gerar_lote_ppsc ( nr_seq_lote_p bigint, ie_opcao_p text, ie_lote_contabil_p text, nm_usuario_p text, cd_estabelecimento_p bigint, ie_recalc_tit_p text default 'N') FROM PUBLIC;

