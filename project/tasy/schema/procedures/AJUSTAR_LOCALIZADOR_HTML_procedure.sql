-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE ajustar_localizador_html (nr_sequencia_p bigint, nm_usuario_p text) AS $body$
DECLARE


qt_pos_y_w	integer;
nr_seq_apresent_w	smallint	:= 10;

c01 CURSOR FOR
SELECT 	coalesce(qt_deslocamento,0) qt_deslocamento,
		nr_sequencia
from   	tipo_localizar_atributo
where  	nr_seq_tipo_localizar = nr_sequencia_p
and 	(ie_tipo_selecao IS NOT NULL AND ie_tipo_selecao::text <> '')
and		coalesce(nr_linha::text, '') = ''
order by nr_seq_apresent, qt_deslocamento;

c02 CURSOR FOR
SELECT 	nr_linha,
		nr_sequencia,
		qt_tam_grid
from   	tipo_localizar_atributo
where  	nr_seq_tipo_localizar = nr_sequencia_p
and 	(ie_tipo_selecao IS NOT NULL AND ie_tipo_selecao::text <> '')
and 	coalesce(qt_tam_span::text, '') = ''
order by nr_linha;

c01_w	c01%rowtype;
c02_w	c02%rowtype;

qt_linha_w				bigint	:= 0;
qt_tamanho_linha_w		bigint;
qt_tamanho_max_w		bigint;


BEGIN

open c01;
loop
fetch c01 into
	c01_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	begin

	if (c01_w.qt_deslocamento = 0) then
			qt_linha_w := qt_linha_w + 1;
	end if;

	update	tipo_localizar_atributo
	set		nr_linha 		= qt_linha_w,
			nm_usuario 		= nm_usuario_p,
			dt_atualizacao 	= clock_timestamp()
	where	nr_sequencia = c01_w.nr_sequencia;

	end;
end loop;
close c01;

commit;

open c02;
loop
fetch c02 into
	c02_w;
EXIT WHEN NOT FOUND; /* apply on c02 */
	begin

	select 	sum(qt_tam_grid)
	into STRICT	qt_tamanho_linha_w
	from   	tipo_localizar_atributo
	where	nr_linha = c02_w.nr_linha
	and		nr_seq_tipo_localizar = nr_sequencia_p;

	select	max(qt_tam_grid)
	into STRICT	qt_tamanho_max_w
	from	tipo_localizar_atributo
	where	nr_seq_tipo_localizar = nr_sequencia_p;

	update 	tipo_localizar_atributo
	set		qt_tam_span =  round((c02_w.qt_tam_grid * 12) / qt_tamanho_max_w),
			nm_usuario 		=  nm_usuario_p,
			dt_atualizacao 	= clock_timestamp()
	where	nr_sequencia = c02_w.nr_sequencia;

	end;
end loop;
close c02;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ajustar_localizador_html (nr_sequencia_p bigint, nm_usuario_p text) FROM PUBLIC;

