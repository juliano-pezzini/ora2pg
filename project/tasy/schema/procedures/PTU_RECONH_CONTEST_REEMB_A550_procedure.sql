-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE ptu_reconh_contest_reemb_a550 ( nr_seq_quest_serv_rrs_p ptu_quest_serv_rrs.nr_sequencia%type, nr_seq_conta_p INOUT pls_conta.nr_sequencia%type, nr_seq_conta_proc_p INOUT pls_conta_proc.nr_sequencia%type, nr_seq_conta_mat_p INOUT pls_conta_mat.nr_sequencia%type, nr_seq_nota_cobr_rrs_p INOUT ptu_nota_cobranca_rrs.nr_sequencia%type, nr_seq_nota_serv_rrs_p INOUT ptu_nota_servico_rrs.nr_sequencia%type) AS $body$
DECLARE


-- Nesta rotina sera passado o item que retornou no A550 e vamos busca lo na forma de pls_conta_proc ou pls_conta_mat
nr_seq_conta_w			pls_conta.nr_sequencia%type;
nr_seq_conta_proc_w 		pls_conta_proc.nr_sequencia%type;
nr_seq_conta_mat_w 		pls_conta_mat.nr_sequencia%type;
nr_seq_nota_serv_rrs_w		ptu_nota_servico_rrs.nr_sequencia%type;
nr_seq_nota_cobr_rrs_w		ptu_nota_cobranca_rrs.nr_sequencia%type;

nr_fatura_w			ptu_camara_contestacao.nr_fatura%type;
nr_seq_a500_w			ptu_quest_serv_rrs.nr_seq_a500%type;
nr_nota_w			ptu_quest_serv_rrs.nr_nota%type;
cd_servico_w			ptu_quest_serv_rrs.cd_servico%type;
nr_seq_pls_fatura_w		pls_fatura.nr_sequencia%type;
ie_tipo_tabela_w		ptu_quest_serv_rrs.tp_tabela%type;
dt_servico_w			ptu_quest_serv_rrs.dt_servico%type;
nr_seq_lote_fat_w		pls_fatura.nr_seq_lote%type;
nr_seq_segurado_w		pls_segurado.nr_sequencia%type;
nr_seq_segurado_ptu_w		pls_segurado.nr_sequencia%type;
cd_usuario_plano_ptu_w		ptu_questionamento_rrs.id_benef%type;
cd_unimed_w			ptu_camara_contestacao.cd_unimed_origem%type;
cd_usuario_plano_w		varchar(50);
nr_nota_numerico_w		ptu_quest_serv_rrs.nr_nota_numerico%type;


BEGIN
nr_seq_conta_p		:= null;
nr_seq_conta_proc_p	:= null;
nr_seq_conta_mat_p	:= null;
nr_seq_nota_cobr_rrs_p	:= null;
nr_seq_nota_serv_rrs_p	:= null;

select	x.nr_fatura,
	s.nr_seq_a500,
	s.nr_nota,
	s.cd_servico,
	s.nr_nota_numerico,
	s.tp_tabela,
	s.dt_servico,
	c.id_benef,
	lpad(c.cd_unimed,4,'0')
into STRICT	nr_fatura_w,
	nr_seq_a500_w,
	nr_nota_w,
	cd_servico_w,
	nr_nota_numerico_w,
	ie_tipo_tabela_w,
	dt_servico_w,
	cd_usuario_plano_ptu_w,
	cd_unimed_w
from	ptu_camara_contestacao	x,
	ptu_questionamento_rrs	c,
	ptu_quest_serv_rrs	s
where	c.nr_sequencia	= s.nr_seq_quest_rrs
and	x.nr_sequencia	= c.nr_seq_contestacao
and	s.nr_sequencia	= nr_seq_quest_serv_rrs_p;

if (nr_fatura_w IS NOT NULL AND nr_fatura_w::text <> '') then
	select	max(pf.nr_sequencia),
		max(pf.nr_seq_lote)
	into STRICT	nr_seq_pls_fatura_w,
		nr_seq_lote_fat_w
	from	pls_fatura	pf,
		ptu_fatura	pt
	where	pf.nr_sequencia	= pt.nr_seq_pls_fatura
	and	pt.nr_fatura	= nr_fatura_w;
end if;

-- TODAS AS INFORMACOES CORRETAS
select	max(c.nr_seq_conta),
	max(s.nr_seq_conta_proc),
	max(s.nr_seq_conta_mat),
	max(s.nr_sequencia),
	max(c.nr_sequencia)
into STRICT	nr_seq_conta_w,
	nr_seq_conta_proc_w,
	nr_seq_conta_mat_w,
	nr_seq_nota_serv_rrs_w,
	nr_seq_nota_cobr_rrs_w
from	ptu_nota_servico_rrs s,
	ptu_nota_cobranca_rrs c,
	ptu_fatura	a
where	a.nr_sequencia		= c.nr_seq_fatura
and	c.nr_sequencia		= s.nr_seq_nota_cobr_rrs
and	s.tp_tabela		= ie_tipo_tabela_w
and	a.nr_seq_pls_fatura	= nr_seq_pls_fatura_w
and	s.cd_servico		= cd_servico_w
and	s.nr_seq_a500		= nr_seq_a500_w
and	c.id_benef		= cd_usuario_plano_ptu_w;

nr_seq_conta_p		:= nr_seq_conta_w;
nr_seq_conta_proc_p 	:= nr_seq_conta_proc_w;
nr_seq_conta_mat_p 	:= nr_seq_conta_mat_w;
nr_seq_nota_cobr_rrs_p	:= nr_seq_nota_cobr_rrs_w;
nr_seq_nota_serv_rrs_p	:= nr_seq_nota_serv_rrs_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ptu_reconh_contest_reemb_a550 ( nr_seq_quest_serv_rrs_p ptu_quest_serv_rrs.nr_sequencia%type, nr_seq_conta_p INOUT pls_conta.nr_sequencia%type, nr_seq_conta_proc_p INOUT pls_conta_proc.nr_sequencia%type, nr_seq_conta_mat_p INOUT pls_conta_mat.nr_sequencia%type, nr_seq_nota_cobr_rrs_p INOUT ptu_nota_cobranca_rrs.nr_sequencia%type, nr_seq_nota_serv_rrs_p INOUT ptu_nota_servico_rrs.nr_sequencia%type) FROM PUBLIC;

