-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_w_cot_item_coluna_rel ( dt_inicio_p timestamp, dt_final_p timestamp, nm_usuario_p text) AS $body$
DECLARE

 
nr_seq_cot_item_w		bigint;
nr_seq_cot_col_w		bigint;
nr_item_cot_compra_w		integer;
cd_material_w			integer;
cd_fornecedor_w			varchar(14);
vl_unitario_material_w		double precision;
nr_seq_coluna_w			integer;
ie_vencedor_w			varchar(1);
nr_seq_cot_item_forn_w		bigint;
nr_cot_compra_w			bigint;
cd_comprador_w			varchar(10);
cd_estabelecimento_w		smallint;

c01 CURSOR FOR 
SELECT	b.nr_item_cot_compra, 
	b.cd_material, 
	a.nr_cot_compra, 
	a.cd_estabelecimento, 
	a.cd_comprador 
from	cot_compra_item b, 
	cot_compra a 
where (a.nr_cot_compra = b.nr_cot_compra) 
and (trunc(a.dt_cot_compra) between trunc(dt_inicio_p) and trunc(dt_final_p)) 
order by a.nr_cot_compra;

c02 CURSOR FOR 
SELECT	a.nr_sequencia, 
	f.cd_cgc_fornecedor, 
	a.vl_unitario_material, 
	substr(coalesce(obter_se_fornec_venc_cotacao(nr_cot_compra_w,a.nr_item_cot_compra,f.nr_sequencia),'N'),1,1) ie_vencedor 
from	cot_compra_forn_item a, 
	cot_compra_forn f, 
	cot_compra_item c 
where	f.nr_sequencia = a.nr_seq_cot_forn 
and	a.nr_cot_compra = nr_cot_compra_w 
and 	c.nr_cot_compra = a.nr_cot_compra 
and	a.nr_item_cot_compra = c.nr_item_cot_compra 
and	a.nr_item_cot_compra = nr_item_cot_compra_w 
order by substr(obter_dados_pf_pj(null, f.cd_cgc_fornecedor,'N'),1,200);


BEGIN 
 
delete from w_cot_item_coluna_rel;
delete from w_cot_item_rel;
 
open c01;
loop 
	fetch c01 into 
		nr_item_cot_compra_w, 
		cd_material_w, 
		nr_cot_compra_w, 
		cd_estabelecimento_w, 
		cd_comprador_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
 
	select	nextval('w_cot_item_rel_seq') 
	into STRICT	nr_seq_cot_item_w 
	;
 
	insert into w_cot_item_rel( 
		nr_sequencia, 
		nm_usuario, 
		cd_material, 
		nr_cot_compra, 
		cd_estabelecimento, 
		cd_comprador) 
	values (	nr_seq_cot_item_w, 
		nm_usuario_p, 
		cd_material_w, 
		nr_cot_compra_w, 
		cd_estabelecimento_w, 
		cd_comprador_w);
	commit;
 
	open c02;
	loop 
		fetch c02 into 
			nr_seq_cot_item_forn_w, 
			cd_fornecedor_w, 
			vl_unitario_material_w, 
			ie_vencedor_w;
		EXIT WHEN NOT FOUND; /* apply on c02 */
 
			select	nextval('w_cot_item_coluna_rel_seq') 
			into STRICT	nr_seq_cot_col_w 
			;
 
			select	coalesce(max(nr_seq_coluna),0) 
			into STRICT	nr_seq_coluna_w 
			from	w_cot_item_coluna_rel 
			where	cd_fornecedor = cd_fornecedor_w 
			and	nr_cot_compra = nr_cot_compra_w;
 
			if (nr_seq_coluna_w = 0) then 
				select	coalesce(max(nr_seq_coluna),0) + 1 
				into STRICT	nr_seq_coluna_w 
				from	w_cot_item_coluna_rel 
				where	nr_cot_compra = nr_cot_compra_w;
			end if;
			if (cd_fornecedor_w IS NOT NULL AND cd_fornecedor_w::text <> '') then 
				insert into w_cot_item_coluna_rel( 
					nr_sequencia, 
					nr_seq_coluna, 
					nm_usuario, 
					nr_seq_cotacao_item, 
					cd_fornecedor, 
					vl_fornecedor, 
					ie_vencedor, 
					nr_cot_compra) 
				values (	nr_seq_cot_col_w, 
					nr_seq_coluna_w, 
					nm_usuario_p, 
					nr_seq_cot_item_w, 
					cd_fornecedor_w, 
					vl_unitario_material_w, 
					ie_vencedor_w, 
					nr_cot_compra_w);
				commit;
			end if;
	end loop;
	close c02;
end loop;
close c01;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_w_cot_item_coluna_rel ( dt_inicio_p timestamp, dt_final_p timestamp, nm_usuario_p text) FROM PUBLIC;

