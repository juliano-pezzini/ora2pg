-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE retirar_cheque_orgao_cobr ( nm_usuario_p text) AS $body$
DECLARE


nr_sequencia_w		bigint;
ds_historico_w		varchar(255);
qt_w			bigint;

c02 CURSOR FOR
	SELECT	nr_seq_cheque,
		nr_seq_cobranca,
		nr_seq_orgao_cobr
	from	cheque_cr_orgao_cobr
	where	ie_selecionado = 'S'
	and 	coalesce(dt_liberacao_exclusao::text, '') = ''
	and 	coalesce(nr_seq_lote::text, '') = '';

vet02	c02%RowType;


BEGIN

select	count(*)
into STRICT	qt_w
from	cheque_cr_orgao_cobr
where	ie_selecionado = 'S';

if (qt_w = 0)then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(682121);
end if;

select	count(*)
into STRICT	qt_w
from	cheque_cr_orgao_cobr
where	ie_selecionado = 'S'
and ((dt_liberacao_exclusao IS NOT NULL AND dt_liberacao_exclusao::text <> '')
or 	(nr_seq_lote IS NOT NULL AND nr_seq_lote::text <> ''));

if (qt_w > 0)then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(338753);
end if;

open c02;
loop
fetch c02 into
	vet02;
EXIT WHEN NOT FOUND; /* apply on c02 */
	begin

	update	cobranca_orgao
	set	dt_retirada = clock_timestamp()
	where	nr_seq_cobranca = vet02.nr_seq_cobranca
	and 	nr_seq_orgao = vet02.nr_seq_orgao_cobr;

	ds_historico_w := wheb_mensagem_pck.get_texto(337785, 'NM_USUARIO=' || nm_usuario_p || ';NR_CHEQUE=' || vet02.nr_seq_cheque || ';DT_ATUALIZACAO=' || to_char(clock_timestamp(),'dd/MM/yyyy hh24:mi:ss'));
	CALL gerar_historico_cobr_orgao(null,vet02.nr_seq_cheque,null,ds_historico_w,nm_usuario_p,'P');

	end;
end loop;
close c02;

delete
from 	cheque_cr_orgao_cobr a
where 	a.ie_selecionado = 'S'
and 	coalesce(a.dt_liberacao_exclusao::text, '') = ''
and 	coalesce(a.nr_seq_lote::text, '') = '';

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE retirar_cheque_orgao_cobr ( nm_usuario_p text) FROM PUBLIC;

