-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE tws_alterar_status_consulta ( nr_sequencia_p bigint, cd_motivo_p bigint, ds_motivo_p text, cd_estabelecimento_p bigint, nm_usuario_p text, cd_type_p text) AS $body$
DECLARE


cd_agenda_w		bigint;
nr_seq_item_w		bigint;
nr_sequencia_ageint_w	bigint;
qt_nao_cancelados_w	smallint;
nr_seq_status_cancel_w	bigint;


BEGIN

if (cd_type_p = 'E') then
	select	max(nr_sequencia),
		max(nr_seq_agenda_int)
	into STRICT	nr_seq_item_w,
		nr_sequencia_ageint_w
	from	agenda_integrada_item
	where nr_seq_agenda_exame = nr_sequencia_p;
ELSE
	select	max(nr_sequencia),
		max(nr_seq_agenda_int)
	into STRICT	nr_seq_item_w,
		nr_sequencia_ageint_w
	from	agenda_integrada_item
	where nr_seq_agenda_cons = nr_sequencia_p;
END IF;

if (coalesce(nr_sequencia_ageint_w::text, '') = '') then

	if (cd_type_p = 'C') then
		select max(cd_agenda)
		into STRICT cd_agenda_w
		from agenda_consulta
		where nr_sequencia = nr_sequencia_p;

		CALL alterar_status_agecons(cd_agenda_w, nr_sequencia_p, 'C', cd_motivo_p, ds_motivo_p, 'N', nm_usuario_p, null);

	elsif (cd_type_p = 'E') then

		select max(cd_agenda)
		into STRICT cd_agenda_w
		from agenda_paciente
		where nr_sequencia = nr_sequencia_p;

		CALL alterar_status_agenda(cd_agenda_w, nr_sequencia_p, 'C', cd_motivo_p, ds_motivo_p, 'N', nm_usuario_p, null);
	end if;

else
	CALL ageint_cancelar_item(nr_sequencia_ageint_w, nr_seq_item_w, ds_motivo_p, cd_motivo_p, nm_usuario_p, cd_estabelecimento_p);
		
	select	count(1)
	into STRICT	qt_nao_cancelados_w
	from (	SELECT	nr_sequencia
		from 	agenda_integrada_item
		where	nr_seq_agenda_int = nr_sequencia_ageint_w
		and		substr(ageint_obter_status_item(nr_seq_agenda_int,nr_sequencia,'C'),1,255) <> 'C' ) alias3;
	
	if (qt_nao_cancelados_w = 0) then
		select	min(nr_sequencia)
		into STRICT	nr_seq_status_cancel_w
		from	agenda_integrada_status
		where	ie_situacao = 'A'
		and		ie_status_tasy = 'CA';
		
		if (nr_seq_status_cancel_w > 0) then
			begin
			CALL ageint_alterar_status(nr_seq_status_cancel_w, nr_sequencia_ageint_w, ds_motivo_p, nm_usuario_p, cd_estabelecimento_p);
			end;
		end if;
	end if;
	
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE tws_alterar_status_consulta ( nr_sequencia_p bigint, cd_motivo_p bigint, ds_motivo_p text, cd_estabelecimento_p bigint, nm_usuario_p text, cd_type_p text) FROM PUBLIC;

