-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_importar_lanc_programados ( nr_seq_lote_p bigint, ds_conteudo_p text, qt_linha_p bigint, cd_interface_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint) AS $body$
DECLARE


ds_conteudo_w			varchar(4000);
nr_uniodonto_copart_w		varchar(255);
nr_uniodonto_mens_w		varchar(255);
ds_segmento_w			varchar(255);
dt_vigencia_w			varchar(255);
id_grupo_w			varchar(255);
ds_erro_w			varchar(255);
id_item_w			varchar(255);
sg_uf_w				varchar(2);
vl_coparticip_w			double precision;
vl_lancamento_w			double precision;
vl_despesa_w			double precision;
nr_seq_titular_w		bigint;
nr_seq_segurado_w		bigint;
nr_seq_pagador_w		bigint;
nr_contrato_w			bigint;
nr_expostos_w			bigint;
nr_eventos_w			bigint;
nr_empresa_w			bigint;
nr_usuario_w			bigint;
dt_trim_ocorr_w			timestamp;
dt_trimestre_w			timestamp;


BEGIN
ds_conteudo_w	:= ds_conteudo_p || ';';
if (cd_interface_p = 1942) then
	if (qt_linha_p <> 0) then
		/* Trimestre */

		dt_trimestre_w	:= to_date(substr(ds_conteudo_w,1,position(';' in ds_conteudo_w) -1),'dd/mm/yyyy');
		ds_conteudo_w	:= substr(ds_conteudo_w,position(';' in ds_conteudo_w) + 1,length(ds_conteudo_w));

		/* Contrato */

		nr_contrato_w	:= substr(ds_conteudo_w,1,position(';' in ds_conteudo_w) -1);
		ds_conteudo_w	:= substr(ds_conteudo_w,position(';' in ds_conteudo_w) + 1,length(ds_conteudo_w));

		/* Trimestre ocorrencia */

		dt_trim_ocorr_w	:= to_date(substr(ds_conteudo_w,1,position(';' in ds_conteudo_w) -1),'dd/mm/yyyy');
		ds_conteudo_w	:= substr(ds_conteudo_w,position(';' in ds_conteudo_w) + 1,length(ds_conteudo_w));

		/* Segmento */

		ds_segmento_w	:= substr(ds_conteudo_w,1,position(';' in ds_conteudo_w) -1);
		ds_conteudo_w	:= substr(ds_conteudo_w,position(';' in ds_conteudo_w) + 1,length(ds_conteudo_w));

		/* UF */

		sg_uf_w		:= substr(ds_conteudo_w,1,position(';' in ds_conteudo_w) -1);
		ds_conteudo_w	:= substr(ds_conteudo_w,position(';' in ds_conteudo_w) + 1,length(ds_conteudo_w));

		/* ID grupo */

		id_grupo_w	:= substr(ds_conteudo_w,1,position(';' in ds_conteudo_w) -1);
		ds_conteudo_w	:= substr(ds_conteudo_w,position(';' in ds_conteudo_w) + 1,length(ds_conteudo_w));

		/* ID item */

		id_item_w	:= substr(ds_conteudo_w,1,position(';' in ds_conteudo_w) -1);
		ds_conteudo_w	:= substr(ds_conteudo_w,position(';' in ds_conteudo_w) + 1,length(ds_conteudo_w));

		/* Nr eventos */

		nr_eventos_w	:= substr(ds_conteudo_w,1,position(';' in ds_conteudo_w) -1);
		ds_conteudo_w	:= substr(ds_conteudo_w,position(';' in ds_conteudo_w) + 1,length(ds_conteudo_w));

		/* Nr expostos */

		nr_expostos_w	:= substr(ds_conteudo_w,1,position(';' in ds_conteudo_w) -1);
		ds_conteudo_w	:= substr(ds_conteudo_w,position(';' in ds_conteudo_w) + 1,length(ds_conteudo_w));

		/* Vl. despesa */

		vl_despesa_w	:= replace(substr(ds_conteudo_w,1,position(';' in ds_conteudo_w) -1),'.',',');
		ds_conteudo_w	:= substr(ds_conteudo_w,position(';' in ds_conteudo_w) + 1,length(ds_conteudo_w));

		insert into pls_lanc_prog_importacao(	nr_sequencia, 				nr_seq_lote, 			cd_estabelecimento,
							dt_atualizacao, 			nm_usuario, 			dt_atualizacao_nrec,
							nm_usuario_nrec, 			nr_seq_segurado, 		ie_tipo_item,
							vl_lancamento, 				dt_trimestre, 			nr_contrato,
							dt_trimestre_ocorr, 			ds_segmento, 			sg_uf,
							id_grupo, 				id_item, 			nr_expostos,
							nr_eventos,				ie_situacao_lanc)
						values (	nextval('pls_lanc_prog_importacao_seq'),	nr_seq_lote_p, 			cd_estabelecimento_p,
							clock_timestamp(), 				nm_usuario_p,			clock_timestamp(),
							nm_usuario_p, 				null,				'3',
							vl_despesa_w,				dt_trimestre_w, 		nr_contrato_w,
							dt_trim_ocorr_w, 			ds_segmento_w, 			sg_uf_w,
							id_grupo_w,				id_item_w, 			nr_expostos_w,
							nr_eventos_w,				'1');
	end if;
elsif (cd_interface_p = 2519) then --Uniodonto - Unimed Blumenau
	if (qt_linha_p <> 0) then

		/* Conteúdo */

		ds_conteudo_w		:= substr(ds_conteudo_w,1,50);

		/* Empresa */

		nr_empresa_w		:= (substr(ds_conteudo_w, 1, 4))::numeric;

		/* Usuario */

		nr_usuario_w		:= substr(ds_conteudo_w, 5, 6);

		/* Vl mensalidade */

		vl_lancamento_w		:= replace(substr(ds_conteudo_w,11,9),'.',',');

		/* Valor Co Participação */

		vl_coparticip_w		:= replace(substr(ds_conteudo_w,20,9),'.',',');

		/* Numero da Uniodonto Mensalidade */

		nr_uniodonto_mens_w	:= substr(ds_conteudo_w, 29, 7);

		/* Numero da Uniodonto Co-Participação */

		nr_uniodonto_copart_w	:= substr(ds_conteudo_w, 36, 7);

		/* Vigência */

		dt_vigencia_w		:= '01/'||substr(ds_conteudo_w, 43, 7);

		if (nr_usuario_w = '000000') then
			select	max(b.nr_sequencia),
				max(a.nr_contrato)
			into STRICT	nr_seq_pagador_w,
				nr_contrato_w
			from	pls_contrato_pagador	b,
				pls_contrato		a
			where	a.nr_sequencia		= b.nr_seq_contrato
			and 	b.ie_tipo_pagador	= 'P'
			and	a.cd_operadora_empresa	= nr_empresa_w;
		else
			select	max(b.nr_sequencia),
				max(a.nr_contrato)
			into STRICT	nr_seq_segurado_w,
				nr_contrato_w
			from	pls_segurado		b,
				pls_contrato		a
			where	a.nr_sequencia		= b.nr_seq_contrato
			and	b.cd_matricula_familia	= nr_usuario_w;
		end if;

		insert into pls_lanc_prog_importacao(	nr_sequencia, 				nr_seq_lote, 			cd_estabelecimento,
							dt_atualizacao, 			nm_usuario,			dt_atualizacao_nrec,
							nm_usuario_nrec, 			nr_seq_segurado,		ie_tipo_item,
							vl_lancamento, 				dt_trimestre, 			nr_contrato,
							dt_trimestre_ocorr,			ds_segmento, 			sg_uf,
							id_grupo, 				id_item,			nr_expostos,
							nr_eventos,				nr_seq_pagador,			ie_situacao_lanc,
							vl_coparticipacao,			dt_competencia,			cd_imp_mens,
							cd_imp_copartic)
						values (	nextval('pls_lanc_prog_importacao_seq'),	nr_seq_lote_p,			cd_estabelecimento_p,
							clock_timestamp(),				nm_usuario_p,			clock_timestamp(),
							nm_usuario_p, 				nr_seq_segurado_w,		'20',
							coalesce(vl_lancamento_w,0),			dt_trimestre_w, 		nr_contrato_w,
							dt_trim_ocorr_w, 			ds_segmento_w, 			sg_uf_w,
							id_grupo_w,				id_item_w, 			nr_expostos_w,
							nr_eventos_w, 				nr_seq_pagador_w,		'1',
							coalesce(vl_coparticip_w,0),			to_date(dt_vigencia_w),		nr_uniodonto_mens_w,
							nr_uniodonto_copart_w);
	end if;
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_importar_lanc_programados ( nr_seq_lote_p bigint, ds_conteudo_p text, qt_linha_p bigint, cd_interface_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint) FROM PUBLIC;

