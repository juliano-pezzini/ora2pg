-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE cm_copiar_cad_item ( nr_seq_item_p bigint, qt_copias_p bigint, nm_usuario_p text) AS $body$
DECLARE


nm_item_w		varchar(255);
ie_situacao_w		varchar(1);
nr_seq_classif_w		bigint;
ds_item_w		varchar(2000);
cd_material_w		integer;
dt_revisao_w		timestamp;
ds_observacao_w		varchar(255);
ds_reduzida_w		varchar(20);
cd_medico_w		varchar(10);
ie_descartavel_w		varchar(1);
ie_controle_cavidade_w	varchar(1);
ie_tamanho_w		varchar(15);
cd_codigo_w		cm_item.cd_codigo%type;

ie_existe_anexo_w		varchar(1);
ie_existe_apelido_w		varchar(1);
ie_existe_fabricante_w	varchar(1);

nr_sequencia_w		bigint;
qt_copias_feitas_w		bigint;
qt_copias_w		bigint;

nr_seq_anexo_w		bigint;
ds_arquivo_w		varchar(255);

nr_seq_apelido_w		bigint;
ds_apelido_w		varchar(255);

nr_seq_fabricante_w	bigint;
cd_referencia_w		varchar(20);
ie_unico_w		cm_item.ie_unico%type;


c01 CURSOR FOR
SELECT	ds_arquivo
from	cm_item_anexo
where	nr_seq_item = nr_seq_item_p;

c02 CURSOR FOR
SELECT	ds_apelido
from	cm_item_apelido
where	nr_seq_item = nr_seq_item_p;

c03 CURSOR FOR
SELECT	nr_seq_fabricante,
	cd_referencia
from	cm_item_fabric
where	nr_seq_item = nr_seq_item_p;


BEGIN

select	nm_item,
	ie_situacao,
	nr_seq_classif,
	ds_item,
	cd_material,
	dt_revisao,
	ds_observacao,
	ds_reduzida,
	cd_medico,
	ie_descartavel,
	ie_controle_cavidade,
	ie_tamanho,
	cd_codigo,
	ie_unico
into STRICT	nm_item_w,
	ie_situacao_w,
	nr_seq_classif_w,
	ds_item_w,
	cd_material_w,
	dt_revisao_w,
	ds_observacao_w,
	ds_reduzida_w,
	cd_medico_w,
	ie_descartavel_w,
	ie_controle_cavidade_w,
	ie_tamanho_w,
	cd_codigo_w,
	ie_unico_w
from	cm_item
where	nr_sequencia = nr_seq_item_p;

select	CASE WHEN count(*)=0 THEN 'N'  ELSE 'S' END
into STRICT	ie_existe_anexo_w
from	cm_item_anexo
where	nr_seq_item = nr_seq_item_p;

select	CASE WHEN count(*)=0 THEN 'N'  ELSE 'S' END
into STRICT	ie_existe_apelido_w
from	cm_item_apelido
where	nr_seq_item = nr_seq_item_p;

select	CASE WHEN count(*)=0 THEN 'N'  ELSE 'S' END
into STRICT	ie_existe_fabricante_w
from	cm_item_fabric
where	nr_seq_item = nr_seq_item_p;

qt_copias_w		:= coalesce(qt_copias_p,1);
qt_copias_feitas_w	:= 0;

while(qt_copias_feitas_w < qt_copias_w) loop
	begin

	select	nextval('cm_item_seq')
	into STRICT	nr_sequencia_w
	;

	insert into cm_item(
		nr_sequencia,
		nm_item,
		dt_atualizacao,
		nm_usuario,
		ie_situacao,
		nr_seq_classif,
		ds_item,
		cd_material,
		dt_revisao,
		ds_observacao,
		ds_reduzida,
		cd_medico,
		ie_descartavel,
		ie_controle_cavidade,
		ie_tamanho,
		cd_codigo,
		ie_unico)
	values (nr_sequencia_w,
		nm_item_w,
		clock_timestamp(),
		nm_usuario_p,
		ie_situacao_w,
		nr_seq_classif_w,
		ds_item_w,
		cd_material_w,
		dt_revisao_w,
		ds_observacao_w,
		ds_reduzida_w,
		cd_medico_w,
		ie_descartavel_w,
		ie_controle_cavidade_w,
		ie_tamanho_w,
		cd_codigo_w,
		ie_unico_w);

	if (ie_existe_anexo_w = 'S') then
		begin

		open c01;
		loop
		fetch c01 into
			ds_arquivo_w;
		EXIT WHEN NOT FOUND; /* apply on c01 */
			begin

			select	nextval('cm_item_anexo_seq')
			into STRICT	nr_seq_anexo_w
			;

			insert into cm_item_anexo(
				nr_sequencia,
				ds_arquivo,
				dt_atualizacao,
				nm_usuario,
				dt_atualizacao_nrec,
				nm_usuario_nrec,
				nr_seq_item) values (
					nr_seq_anexo_w,
					ds_arquivo_w,
					clock_timestamp(),
					nm_usuario_p,
					clock_timestamp(),
					nm_usuario_p,
					nr_sequencia_w);

			end;
		end loop;
		close c01;

		end;
	end if;

	if (ie_existe_apelido_w = 'S') then
		begin

		open c02;
		loop
		fetch c02 into
			ds_apelido_w;
		EXIT WHEN NOT FOUND; /* apply on c02 */
			begin

			select	coalesce(max(nr_sequencia),0) + 1
			into STRICT	nr_seq_apelido_w
			from	cm_item_apelido;

			insert into cm_item_apelido(
				nr_sequencia,
				nr_seq_item,
				ds_apelido,
				dt_atualizacao,
				nm_usuario) values (
					nr_seq_apelido_w,
					nr_sequencia_w,
					ds_apelido_w,
					clock_timestamp(),
					nm_usuario_p);

			end;
		end loop;
		close c02;

		end;
	end if;

	if (ie_existe_fabricante_w = 'S') then
		begin

		open c03;
		loop
		fetch c03 into
			nr_seq_fabricante_w,
			cd_referencia_w;
		EXIT WHEN NOT FOUND; /* apply on c03 */
			begin

			insert into cm_item_fabric(
				nr_seq_item,
				nr_seq_fabricante,
				dt_atualizacao,
				nm_usuario,
				cd_referencia) values (
					nr_sequencia_w,
					nr_seq_fabricante_w,
					clock_timestamp(),
					nm_usuario_p,
					cd_referencia_w);

			end;
		end loop;
		close c03;

		end;
	end if;

	qt_copias_feitas_w	:= (qt_copias_feitas_w + 1);

	end;
end loop;

commit;	

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cm_copiar_cad_item ( nr_seq_item_p bigint, qt_copias_p bigint, nm_usuario_p text) FROM PUBLIC;

