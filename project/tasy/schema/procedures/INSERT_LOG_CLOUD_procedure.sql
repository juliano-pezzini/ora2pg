-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE insert_log_cloud ( cd_versao_p text, cd_versao_dest_p text, nm_usuario_p text, ds_message_p text, ds_comando_p text, nm_fase_atualizacao_p text, generate_notify boolean default false, ie_base_p text default 'C', nr_seq_script_p bigint default null, nr_pacote_p bigint default null, nr_release_p bigint default null, nr_service_pack_p bigint default null) AS $body$
DECLARE


regex_text varchar(50) := '(.*?)(( - )|$)';

NM_TIPO_W CLOUD_UPGRADE_LOG.NM_TIPO%TYPE;

cd_versao_w cloud_upgrade_log.cd_versao_atual%type;
cd_versao_tv_w cloud_upgrade_log.cd_versao_dest%type;
nr_max_log_atualizacao_w bigint;

ds_mensagem_w tasy_client_notification.ds_mensagem%type;
ds_titulo_w tasy_client_notification.ds_titulo%type;



BEGIN

	cd_versao_w := cd_versao_p;
    cd_versao_tv_w := cd_versao_dest_p;

    if (generate_notify) then
        NM_TIPO_W := 'WARNING';
    else
        NM_TIPO_W := NULL;
    end if;

    if (ie_base_p <> 'W') then
        insert into cloud_upgrade_log(
        nr_seq_script,
        nr_pacote,
        nr_release,
        cd_versao_atual,
        cd_versao_dest,
        dt_atualizacao,
        nm_usuario,
        ds_mensagem,
        ds_comando,
        nm_tipo,
        nm_fase_atualizacao,
        nr_service_pack)
        values (
        nr_seq_script_p,
        nr_pacote_p, 
        nr_release_p,
        cd_versao_w,
        cd_versao_tv_w,
        current_timestamp, 
        nm_usuario_p, 
        ds_message_p,
        ds_comando_p,
        nm_tipo_w,
        nm_fase_atualizacao_p,
        nr_service_pack_p);
        Commit;

		if (generate_notify) then
			SELECT REGEXP_SUBSTR( ds_message_p,regex_text, 1, 1) into STRICT ds_titulo_w;
            SELECT REGEXP_SUBSTR( ds_message_p,regex_text, 1, 2) into STRICT ds_mensagem_w;
			CALL insert_tasy_client_notify(ds_titulo_w||' '||nm_fase_atualizacao_p,ds_mensagem_w,'A');
		end if;
	commit;
    end if;

regex_text := '(.*?)(( - )|$)';

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE insert_log_cloud ( cd_versao_p text, cd_versao_dest_p text, nm_usuario_p text, ds_message_p text, ds_comando_p text, nm_fase_atualizacao_p text, generate_notify boolean default false, ie_base_p text default 'C', nr_seq_script_p bigint default null, nr_pacote_p bigint default null, nr_release_p bigint default null, nr_service_pack_p bigint default null) FROM PUBLIC;

