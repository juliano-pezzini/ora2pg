-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_log_lote_prescricao ( nr_prescricao_p bigint, nm_usuario_p text) AS $body$
DECLARE


cd_material_w		material.cd_material%type;
nr_seq_mat_hor_w		prescr_mat_hor.nr_sequencia%type;
cd_unidade_medida_w	unidade_medida.cd_unidade_medida%type;
qt_dispensar_w		double precision;
qt_dispensar_hor_w		double precision;
nr_seq_turno_w		bigint;
dt_horario_w		timestamp;
ds_log_w			varchar(4000) := '';
ds_log_ww		varchar(255) := '';
hr_hora_w		varchar(5);
cd_estabelecimento_w	estabelecimento.cd_estabelecimento%type;
ie_urgente_w		varchar(1);
nr_seq_classif_w		bigint;
cd_local_estoque_w	local_estoque.cd_local_estoque%type;
nr_item_prescr_w		bigint;
ie_aprazado_ww		varchar(1);
ie_gerar_lote_w		varchar(1);
ie_gerar_lote_ww		varchar(1);
ie_gerar_lote_mat_w	varchar(1);
ie_gerar_lote_set_w		varchar(1);
cd_setor_atendimento_w	setor_atendimento.cd_setor_atendimento%type;
nr_seq_regra_local_w	regra_local_dispensacao.nr_sequencia%type;

C01 CURSOR FOR
	SELECT  b.cd_material,
		b.nr_sequencia,
		b.cd_unidade_medida,
		b.qt_dispensar,
		coalesce(b.nr_seq_turno,-1),
		b.dt_horario,
		to_char(b.dt_horario,'hh24:mi'),
		coalesce(a.cd_estabelecimento,1),
		b.ie_urgente,
		b.nr_seq_classif,
		coalesce(b.cd_local_estoque,coalesce(c.cd_local_estoque,a.cd_local_estoque)) cd_local,
		c.nr_sequencia,
		coalesce(c.ie_gerar_lote, 'S'),
		coalesce(b.ie_gerar_lote, 'S'),
		coalesce(x.ie_gerar_lote, 'S'),
		c.nr_seq_regra_local
	from	material x,
		prescr_mat_hor  b,
		prescr_material c,
		prescr_medica   a
	where	a.nr_prescricao = b.nr_prescricao
	and	x.cd_material	= c.cd_material
	and	a.nr_prescricao	= c.nr_prescricao
	and	c.nr_sequencia	= b.nr_seq_material
	and	a.nr_prescricao = nr_prescricao_p
	and	coalesce(b.nr_seq_lote::text, '') = '';



BEGIN

delete from w_log_lote_prescricao
where nr_prescricao = nr_prescricao_p
and nm_usuario = nm_usuario_p;

select	max(cd_setor_atendimento)
into STRICT	cd_setor_atendimento_w
from	prescr_medica
where	nr_prescricao = nr_prescricao_p;

select	coalesce(max(ie_gerar_lote),'S')
into STRICT	ie_gerar_lote_set_w
from	setor_atendimento
where	cd_setor_atendimento = cd_setor_atendimento_w;

if (ie_gerar_lote_set_w = 'N') then
	ds_log_ww := wheb_mensagem_pck.get_texto(790866) ||': ' || chr(10) || Chr(13);
	ds_log_ww := substr(ds_log_ww || 'IE_GERAR_LOTE/SETOR_ATENDIMENTO=''N'';' || chr(10) || Chr(13),1,255);
end if;

open C01;
loop
fetch C01 into
	cd_material_w,
	nr_seq_mat_hor_w,
	cd_unidade_medida_w,
	qt_dispensar_w,
	nr_seq_turno_w,
	dt_horario_w,
	hr_hora_w,
	cd_estabelecimento_w,
	ie_urgente_w,
	nr_seq_classif_w,
	cd_local_estoque_w,
	nr_item_prescr_w,
	ie_gerar_lote_w,
	ie_gerar_lote_ww,
	ie_gerar_lote_mat_w,
	nr_seq_regra_local_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin

	ds_log_w := ds_log_ww;

	if (coalesce(qt_dispensar_w, 0) <= 0) then
		ds_log_w := substr(ds_log_w || wheb_mensagem_pck.get_texto(790867) || chr(10) || Chr(13),1,4000);
	end if;

	if (coalesce(nr_seq_turno_w::text, '') = '') then
		ds_log_w := substr(ds_log_w || wheb_mensagem_pck.get_texto(790868) || chr(10) || Chr(13),1,4000);
	end if;

	if (coalesce(nr_seq_classif_w::text, '') = '') then
		ds_log_w := substr(ds_log_w || wheb_mensagem_pck.get_texto(790869) || chr(10) || Chr(13),1,4000);
	end if;

	if (ie_gerar_lote_w = 'N') then
		ds_log_w := substr(ds_log_w || 'IE_GERAR_LOTE/PRESCR_MATERIAL=''N'';' || chr(10) || Chr(13),1,4000);
	end if;

	if (ie_gerar_lote_ww = 'N') then
		ds_log_w := substr(ds_log_w || 'IE_GERAR_LOTE/PRESCR_MAT_HOR=''N'';' || chr(10) || Chr(13),1,4000);
	end if;

	if (ie_gerar_lote_mat_w = 'N') then
		ds_log_w := substr(ds_log_w || 'IE_GERAR_LOTE/MATERIAL=''N'';' || chr(10) || Chr(13),1,4000);
	end if;

	if (nr_seq_regra_local_w IS NOT NULL AND nr_seq_regra_local_w::text <> '') then
		select	coalesce(max(ie_gerar_ap_lote), 'S')
		into STRICT	ie_gerar_lote_mat_w
		from	regra_local_dispensacao
		where	nr_sequencia = nr_seq_regra_local_w;

		if (ie_gerar_lote_mat_w = 'N') then
			ds_log_w := substr(ds_log_w || 'Regra local disp(IE_GERAR_AP_LOTE=''N''). Seq:' || nr_seq_regra_local_w || chr(10) || Chr(13),1,4000);
		end if;
	end if;

	if (coalesce(cd_local_estoque_w::text, '') = '') then
		ds_log_w := substr(ds_log_w || wheb_mensagem_pck.get_texto(790870) || chr(10) || Chr(13),1,4000);
	else
		select	coalesce(max(ie_gera_lote),'S')
		into STRICT	ie_gerar_lote_mat_w
		from	local_estoque
		where	ie_situacao = 'A'
		and	cd_local_estoque = cd_local_estoque_w;

		if (ie_gerar_lote_mat_w = 'N') then
			ds_log_w := substr(ds_log_w || 'Regra(Local de estoque/IE_GERA_LOTE= ''N'');' || nr_seq_regra_local_w || chr(10) || Chr(13),1,4000);
		end if;
	end if;

	if (ds_log_w IS NOT NULL AND ds_log_w::text <> '') then
		insert into w_log_lote_prescricao(
			dt_atualizacao,
			nm_usuario,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			nr_prescricao,
			nr_seq_mat_hor,
			ds_log,
			dt_horario,
			cd_material)
		values (clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			nr_prescricao_p,
			nr_seq_mat_hor_w,
			ds_log_w,
			dt_horario_w,
			cd_material_w);

	end if;

	end;
end loop;
close C01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_log_lote_prescricao ( nr_prescricao_p bigint, nm_usuario_p text) FROM PUBLIC;

