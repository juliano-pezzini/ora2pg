-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE baca_ajustar_lesoes_angio () AS $body$
DECLARE


nr_seq_lesao_w 		hem_lesao.nr_sequencia%type;

C01 CURSOR FOR
	SELECT 	a.nr_sequencia
	from  	hem_proc a
	where 	ie_classif = 'ATC'
	and not exists (SELECT	1
			from hem_lesao x
			where a.nr_sequencia = x.nr_seq_proc)
	and exists (	select	1
			from 	hem_coronariografia x
			where 	x.NR_SEQ_PROC = a.nr_Sequencia)
	order by 1;

C02 CURSOR(nr_seq_proc_pc bigint) FOR
	SELECT 	nr_sequencia,
		nr_seq_vaso,
		ds_observacao
	from  	hem_coronariografia
	where 	nr_seq_proc = nr_seq_proc_pc;
BEGIN

for r_C01 in C01 loop
	begin
	for r_C02 in C02(r_C01.nr_sequencia) loop
		begin

		select 	nextval('hem_lesao_seq')
		into STRICT	nr_seq_lesao_w
		;

		insert into hem_lesao(
			nr_sequencia,
			dt_atualizacao,
			nm_usuario,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			ds_lesao,
			nr_seq_proc,
			ie_lesao_culpada,
			ds_observacao
		) values (
			nr_seq_lesao_w,
			clock_timestamp(),
			'Tasy',
			clock_timestamp(),
			'Tasy',
			substr(obter_desc_hem_vaso(r_C02.nr_seq_vaso),1,100),
			r_C01.nr_sequencia,
			null,
			r_C02.ds_observacao);

		update	hem_coronariografia
		set	nr_seq_lesao = nr_seq_lesao_w
		where	nr_sequencia = r_C02.nr_sequencia;

		update 	hem_cat_lesao
		set	nr_seq_lesao = nr_seq_lesao_w
		where	NR_SEQ_CORNON = r_C02.nr_sequencia;

		update	hem_atc_balao
		set	nr_seq_lesao = nr_seq_lesao_w
		where	NR_SEQ_CORNON = r_C02.nr_sequencia;

		update 	hem_coro_disp_adjunto
		set	nr_seq_lesao = nr_seq_lesao_w
		where	NR_SEQ_CORON = r_C02.nr_sequencia;

		update	hem_atc
		set	nr_seq_lesao = nr_seq_lesao_w
		where	NR_SEQ_CORON = r_C02.nr_sequencia;

		update 	hem_atc_quant
		set	nr_seq_lesao = nr_seq_lesao_w
		where	NR_SEQ_CORONARIA = r_C02.nr_sequencia;

		end;
	end loop;

	commit;

	end;
end loop;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE baca_ajustar_lesoes_angio () FROM PUBLIC;

