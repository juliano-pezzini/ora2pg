-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE consiste_regra_variacao_oci ( cd_estabelecimento_p bigint, cd_material_p bigint, vl_informacao_p bigint, ie_consistir_p text, ds_retorno_p INOUT text, ie_consiste_avisa_p INOUT text) AS $body$
DECLARE


/*ie_consistir_p
VU	Valor unitÃ¡rio com valor ultima compra
*/
cd_grupo_material_w			grupo_material.cd_grupo_material%type;
cd_subgrupo_material_w			subgrupo_material.cd_subgrupo_material%type;
cd_classe_material_w			classe_material.cd_classe_material%type;
ie_consiste_ult_compra_w			regra_variacao_valor_oci.ie_consiste_ult_compra%type;
pr_variacao_ult_compra_w			regra_variacao_valor_oci.pr_variacao_ult_compra%type;
vl_ultima_compra_w			saldo_estoque.vl_preco_ult_compra%type := 0;
vl_ultima_compra_adic_w			saldo_estoque.vl_preco_ult_compra%type := 0;
qt_registros_w				bigint;
ds_retorno_w				varchar(255) := '';
ie_consiste_avisa_w			varchar(15)  := '';

c01 CURSOR FOR
SELECT	ie_consiste_ult_compra,
	pr_variacao_ult_compra
from	regra_variacao_valor_oci
where	cd_estabelecimento = cd_estabelecimento_p
and	ie_situacao = 'A'
and	coalesce(cd_grupo_material, cd_grupo_material_w)		= cd_grupo_material_w
and	coalesce(cd_subgrupo_material, cd_subgrupo_material_w)	= cd_subgrupo_material_w
and	coalesce(cd_classe_material, cd_classe_material_w)		= cd_classe_material_w
and (coalesce(cd_material, cd_material_p) 			= cd_material_p or cd_material_p = 0)
order by
	coalesce(cd_material, 0),
	coalesce(cd_classe_material, 0),
	coalesce(cd_subgrupo_material, 0),
	coalesce(cd_grupo_material, 0);


BEGIN

select	count(*)
into STRICT	qt_registros_w
from	regra_variacao_valor_oci
where	cd_estabelecimento = cd_estabelecimento_p
and	ie_situacao = 'A';

if (qt_registros_w > 0) then

	select	a.cd_grupo_material,
		a.cd_subgrupo_material,
		a.cd_classe_material
	into STRICT	cd_grupo_material_w,
		cd_subgrupo_material_w,
		cd_classe_material_w
	from	estrutura_material_v a
	where	a.cd_material = cd_material_p;


	open C01;
	loop
	fetch C01 into
		ie_consiste_ult_compra_w,
		pr_variacao_ult_compra_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin
		ie_consiste_ult_compra_w := ie_consiste_ult_compra_w;
		pr_variacao_ult_compra_w := pr_variacao_ult_compra_w;
		end;
	end loop;
	close C01;

	if (ie_consistir_p = 'VU') and (coalesce(ie_consiste_ult_compra_w,'D') <> 'D') and (coalesce(pr_variacao_ult_compra_w,-1) >= 0) and (coalesce(vl_informacao_p,0) > 0) then

		select	obter_dados_ult_compra_data(cd_estabelecimento_p,cd_material_p,null,clock_timestamp(),0,'CM')
		into STRICT	vl_ultima_compra_w
		;

		vl_ultima_compra_adic_w := vl_ultima_compra_w + dividir((vl_ultima_compra_w * pr_variacao_ult_compra_w),100);

		if (vl_informacao_p > vl_ultima_compra_adic_w) and (ie_consiste_ult_compra_w = 'A') then

			ds_retorno_w		:= wheb_mensagem_pck.get_Texto(319979);
			ie_consiste_avisa_w	:= ie_consiste_ult_compra_w;

		elsif (vl_informacao_p > vl_ultima_compra_adic_w) and (ie_consiste_ult_compra_w = 'C') then

			ds_retorno_w		:= wheb_mensagem_pck.get_Texto(319980);
			ie_consiste_avisa_w	:= ie_consiste_ult_compra_w;
		end if;
	end if;
end if;

ds_retorno_p			:= ds_retorno_w;
ie_consiste_avisa_p		:= ie_consiste_avisa_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE consiste_regra_variacao_oci ( cd_estabelecimento_p bigint, cd_material_p bigint, vl_informacao_p bigint, ie_consistir_p text, ds_retorno_p INOUT text, ie_consiste_avisa_p INOUT text) FROM PUBLIC;

