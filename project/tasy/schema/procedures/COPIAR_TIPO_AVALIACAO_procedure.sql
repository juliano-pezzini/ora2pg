-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';



CREATE TYPE campos AS (nr_seq_old bigint, nr_seq_new bigint);


CREATE OR REPLACE PROCEDURE copiar_tipo_avaliacao (nr_tipo_origem_p bigint, nr_tipo_destino_p bigint, nm_usuario_p text) AS $body$
DECLARE

type Vetor is table of campos index by integer;

Item_Avaliar_w			Med_Item_Avaliar%RowType;
Item_Avaliar_Res_w		Med_Item_Avaliar_Res%RowType;

nr_seq_item_new_w			bigint;

i					integer := 1;
Vetor_Item_w			Vetor;

c01 CURSOR FOR
SELECT 	*
from Med_Item_Avaliar
where nr_seq_tipo = nr_tipo_origem_p;


BEGIN

OPEN C01;
LOOP
FETCH C01 into Item_Avaliar_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */

	begin
	select nextval('med_item_avaliar_seq')
	into STRICT nr_seq_item_new_w
	;

	insert into Med_Item_Avaliar(	NR_SEQUENCIA, DS_ITEM, NR_SEQ_TIPO,
						NR_SEQ_APRESENT, IE_RESULTADO, DT_ATUALIZACAO,
						NM_USUARIO, QT_DECIMAIS, DS_UNID_MED,
						QT_MINIMO, QT_MAXIMO, NR_SEQ_SUPERIOR,
						IE_OBRIGATORIO, QT_TAMANHO, QT_DESLOC_DIREITA,
						QT_POS_ESQUERDA, CD_DOMINIO, DS_FORMULA, IE_GRAFICO_AVALIACAO,
						QT_MAX_CARACTER,QT_TAB_ORDER,  IE_SITUACAO,
						DS_COMPLEMENTO,
						QT_ALTURA,
						DS_MASCARA)
	values (nr_seq_item_new_w, Item_Avaliar_w.ds_item, nr_tipo_destino_p,
		  Item_Avaliar_w.nr_seq_apresent, Item_Avaliar_w.ie_resultado, clock_timestamp(),
		  nm_usuario_p, Item_Avaliar_w.qt_decimais, Item_Avaliar_w.ds_unid_med,
		  Item_Avaliar_w.qt_minimo, Item_Avaliar_w.qt_maximo, Item_Avaliar_w.nr_seq_superior,
		  Item_Avaliar_w.ie_obrigatorio, Item_Avaliar_w.qt_tamanho, Item_Avaliar_w.qt_desloc_direita,
		  Item_Avaliar_w.qt_pos_esquerda, Item_Avaliar_w.cd_dominio, Item_Avaliar_w.ds_formula, 'S',
		Item_Avaliar_w.QT_MAX_CARACTER,Item_Avaliar_w.QT_TAB_ORDER,  Item_Avaliar_w.IE_SITUACAO, Item_Avaliar_w.DS_COMPLEMENTO,
		Item_Avaliar_w.QT_ALTURA, Item_Avaliar_w.DS_MASCARA);

	insert into Med_Item_Avaliar_Res(	NR_SEQ_ITEM, NR_SEQ_RES, DT_ATUALIZACAO,
							NM_USUARIO, DS_RESULTADO, QT_RESULTADO,
							NR_SEQ_ITEM_REF, DS_RESULT_REF)
	SELECT nr_seq_item_new_w, nr_seq_res, clock_timestamp(),
		 nm_usuario_p, ds_resultado, qt_resultado,
		 nr_seq_item_ref, ds_result_ref
	from med_item_avaliar_res
	where nr_seq_item = Item_Avaliar_w.nr_sequencia;

	Vetor_Item_w[i].nr_seq_old := Item_Avaliar_w.nr_sequencia;
	Vetor_Item_w[i].nr_seq_new := nr_seq_item_new_w;
	i := i + 1;
	end;
END LOOP;
CLOSE C01;

for i in 1..Vetor_Item_w.Count loop
	update Med_Item_Avaliar
	set nr_seq_superior = Vetor_Item_w[i].nr_seq_new
	where nr_seq_superior = Vetor_Item_w[i].nr_seq_old
	  and nr_seq_tipo = nr_tipo_destino_p;

	update Med_Item_Avaliar_Res
	set nr_seq_item_ref = Vetor_Item_w[i].nr_seq_new
	where nr_seq_item_ref = Vetor_Item_w[i].nr_seq_old
	  and nr_seq_item in (	SELECT nr_sequencia
					from Med_Item_Avaliar
					where nr_seq_tipo = nr_tipo_destino_p);

end loop;

commit;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE copiar_tipo_avaliacao (nr_tipo_origem_p bigint, nr_tipo_destino_p bigint, nm_usuario_p text) FROM PUBLIC;

