-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';



CREATE TYPE linha_pai_r AS (
	nr_sequencia			w_apap_pac_informacao.nr_sequencia%type,
	dt_registro				w_apap_pac_registro.dt_registro%type,
	ds_formato_composto		w_apap_pac_informacao.ds_formato_composto%type,
	nm_atrib_vl_graf		linked_data_atributo.nm_atrib_vl_graf%type,
	ds_result_desc			w_apap_pac_registro.ds_result_desc%type,
	vl_resultado			w_apap_pac_registro.vl_resultado%type,
	ds_resultado			w_apap_pac_registro.ds_resultado%type,
	vl_pas					w_apap_pac_registro.vl_pas%type,
	vl_pam					w_apap_pac_registro.vl_pam%type,
	vl_pad					w_apap_pac_registro.vl_pad%type,
	vl_papd					w_apap_pac_registro.vl_papd%type,
	vl_paps					w_apap_pac_registro.vl_paps%type,
	vl_papm					w_apap_pac_registro.vl_papm%type,
	nr_seq_origem			w_apap_pac_registro.nr_seq_origem%type,
	ie_alerta				w_apap_pac_registro.ie_alerta%type,
	ds_cor					w_apap_pac_registro.ds_cor%type,
	ie_insert				w_apap_pac_registro.ie_alerta%type,
	ie_situacao				w_apap_pac_registro.ie_situacao%type,
	ie_integracao			w_apap_pac_registro.ie_integracao%type,
	ie_status_houdini		w_apap_pac_registro.ie_status_houdini%type,
	ie_status_registro		w_apap_pac_registro.ie_status_registro%type,
	ie_editado				w_apap_pac_registro.ie_editado%type
);
CREATE TYPE linha_filha_r AS (
	nr_sequencia		w_apap_pac_informacao.nr_sequencia%type,
	nm_atributo_linked	w_apap_pac_informacao.nm_atributo_linked%type,
	ds_resultado		w_apap_pac_registro.ds_resultado%type,
	ds_unid_med			w_apap_pac_informacao.ds_unid_med%type,
	vl_resultado		w_apap_pac_registro.vl_resultado%type,
	ie_referencia		documento_atributo_ref.ie_referencia%type,
	nr_seq_origem		w_apap_pac_registro.nr_seq_origem%type,
	ie_alerta			w_apap_pac_registro.ie_alerta%type,
	ds_cor				w_apap_pac_registro.ds_cor%type,
	nm_atributo_tabela	w_apap_pac_informacao.nm_atributo_tabela%type,
	ie_status_houdini	w_apap_pac_registro.ie_status_houdini%type,
	ie_status_registro	w_apap_pac_registro.ie_status_registro%type,
	ie_editado			w_apap_pac_registro.ie_editado%type
);


CREATE OR REPLACE PROCEDURE apap_atualiza_linha_pai (nr_sequencia_p bigint, nr_seq_linha_p bigint) AS $body$
DECLARE

TYPE linha_pai_t IS TABLE OF linha_pai_r;
TYPE linha_filha_t IS TABLE OF linha_filha_r;


linha_pai_row			linha_pai_t;
linha_filha_row			linha_filha_t;

tb_ds_result_desc_w		dbms_sql.varchar2_table;
tb_vl_resultado_w		dbms_sql.number_table;
tb_ds_resultado_w		dbms_sql.varchar2_table;
tb_vl_pas_w				dbms_sql.number_table;
tb_vl_pam_w				dbms_sql.number_table;
tb_vl_pad_w				dbms_sql.number_table;
tb_vl_papd_w			dbms_sql.number_table;
tb_vl_paps_w			dbms_sql.number_table;
tb_vl_papm_w			dbms_sql.number_table;
tb_nr_seq_origem_w		dbms_sql.number_table;
tb_ie_alerta_w			dbms_sql.varchar2_table;
tb_ds_cor_w				dbms_sql.varchar2_table;
tb_dt_registro_w		dbms_sql.date_table;
tb_nr_sequencia_w		dbms_sql.number_table;
tb_ie_insert_w			dbms_sql.varchar2_table;
tb_ie_situacao_w		dbms_sql.varchar2_table;
tb_ie_integracao_w		dbms_sql.varchar2_table;
tb_ie_status_houdini_w	dbms_sql.varchar2_table;
tb_ie_status_registro_w	dbms_sql.varchar2_table;
tb_ie_editado_w			dbms_sql.varchar2_table;


ind_w				integer := 0;

ds_formato_composto_w	w_apap_pac_registro.ds_result_desc%type;
vl_pas_w				w_apap_pac_registro.vl_pas%type;
vl_pam_w				w_apap_pac_registro.vl_pam%type;
vl_pad_w				w_apap_pac_registro.vl_pad%type;
vl_papd_w				w_apap_pac_registro.vl_papd%type;
vl_paps_w				w_apap_pac_registro.vl_paps%type;
vl_papm_w				w_apap_pac_registro.vl_papm%type;
vl_grafico_w			w_apap_pac_registro.vl_resultado%type;
nr_seq_origem_w			w_apap_pac_registro.nr_seq_origem%type;
ie_alerta_w				w_apap_pac_registro.ie_alerta%type;
ds_cor_w				w_apap_pac_registro.ds_cor%type;
indice_w				w_apap_pac_registro.nr_sequencia%type;
ie_status_houdini_w		w_apap_pac_registro.ie_status_houdini%type;
ie_status_registro_w	w_apap_pac_registro.ie_status_registro%type;
ie_editado_w			w_apap_pac_registro.ie_editado%type;
nm_usuario_w			usuario.nm_usuario%type	:= wheb_usuario_pck.get_nm_usuario;
BEGIN


SELECT 	* BULK COLLECT
INTO STRICT 	linha_pai_row 
FROM 	(SELECT	distinct b.nr_sequencia,
				d.dt_registro,
				b.ds_formato_composto,
				(select	max(y.nm_atrib_vl_graf) from linked_data_atributo y where y.nm_atributo_linked = b.nm_atributo_linked and b.nr_seq_linked_data = y.nr_seq_linked_data) nm_atrib_vl_graf,
				null ds_result_desc,
				null vl_resultado,
				null ds_resultado,
				null vl_pas,
				null vl_pam,
				null vl_pad,
				null vl_papd,
				null vl_paps,
				null vl_papm,
				d.nr_seq_origem,
				null ie_alerta,
				null ds_cor,
				(select	CASE WHEN coalesce(max(y.nr_sequencia)::text, '') = '' THEN 'S'  ELSE 'N' END  from w_apap_pac_registro y where y.nr_seq_apap_inf = c.nr_seq_superior and y.dt_registro = d.dt_registro and coalesce(y.ie_status_houdini,'XPTO') = coalesce(d.ie_status_houdini,'XPTO')) ie_insert,
				coalesce(d.ie_situacao,'A') ie_situacao,
				coalesce(d.ie_integracao,'N') ie_integracao,
				d.ie_status_houdini,
				d.ie_status_registro,
				null ie_editado
		from    w_apap_pac_grupo a,
				w_apap_pac_informacao b,
				w_apap_pac_informacao c,
				w_apap_pac_registro d
		where   a.nr_sequencia 			= b.nr_seq_apap_grupo
		and     a.nr_sequencia 			= c.nr_seq_apap_grupo
		and     b.nr_sequencia 			= c.nr_seq_superior
		and     c.nr_sequencia 			= d.nr_seq_apap_inf
		and     a.nr_seq_mod_apap		= nr_sequencia_p
		and		coalesce(nr_sequencia_p,0)	> 0
		
union

		SELECT  distinct b.nr_sequencia,
				d.dt_registro,
				b.ds_formato_composto,
				(select	max(y.nm_atrib_vl_graf) from linked_data_atributo y where y.nm_atributo_linked = b.nm_atributo_linked and b.nr_seq_linked_data = y.nr_seq_linked_data) nm_atrib_vl_graf,
				null ds_result_desc,
				null vl_resultado,
				null ds_resultado,
				null vl_pas,
				null vl_pam,
				null vl_pad,
				null vl_papd,
				null vl_paps,
				null vl_papm,
				null nr_seq_origem,
				null ie_alerta,
				null ds_cor,
				(select	CASE WHEN coalesce(max(y.nr_sequencia)::text, '') = '' THEN 'S'  ELSE 'N' END  from w_apap_pac_registro y where y.nr_seq_apap_inf = c.nr_seq_superior and y.dt_registro = d.dt_registro and coalesce(y.ie_status_houdini,'XPTO') = coalesce(d.ie_status_houdini,'XPTO')) ie_insert,
				coalesce(d.ie_situacao,'A') ie_situacao,
				coalesce(d.ie_integracao,'N') ie_integracao,
				d.ie_status_houdini,
				d.ie_status_registro,
				null ie_editado
		from    w_apap_pac_informacao b,
				w_apap_pac_informacao c,
				w_apap_pac_registro d
		where   b.nr_sequencia 			= c.nr_seq_superior
		and     c.nr_sequencia 			= d.nr_seq_apap_inf
		and		c.nr_sequencia			= nr_seq_linha_p
		and		coalesce(nr_seq_linha_p,0)	> 0) alias20;
		
<<read_linhas_pai>>
FOR indexLinhaPai IN 1 .. linha_pai_row.count LOOP
	ds_formato_composto_w 	:= linha_pai_row[indexLinhaPai].ds_formato_composto;
	ie_alerta_w				:= 'N';
	ds_cor_w				:= null;
	vl_pas_w				:= null;
	vl_pam_w				:= null;
	vl_pad_w				:= null;
	vl_papd_w				:= null;
	vl_paps_w				:= null;
	vl_papm_w				:= null;
	nr_seq_origem_w			:= null;
	vl_grafico_w			:= null;
	ie_status_houdini_w		:= null;
	ie_status_registro_w	:= null;
	ie_editado_w			:= null;
	SELECT 	* BULK COLLECT
	INTO STRICT 	linha_filha_row 
	FROM 	(SELECT	a.nr_sequencia,
					'@'||a.nm_atributo_linked||'#' nm_atributo_linked,
					coalesce(b.ds_result_desc,b.vl_resultado) ds_resultado,
					a.ds_unid_med,
					b.vl_resultado,
					(	select	max(y.ie_referencia) 
						from 	documento_atributo_ref y
						where	y.nm_atributo 			= a.nm_atributo_tabela
						and		y.nr_seq_linked_data 	= a.nr_seq_linked_data
						and		y.ie_referencia in ('PADSV','PASSV','PAMSV','PADHEM','PASHEM','PAMHEM','PAPS','PAPD','PAPM')) ie_referencia,
					b.nr_seq_origem,
					b.ie_alerta,
					b.ds_cor,
					a.nm_atributo_tabela,
					b.ie_status_houdini,
					b.ie_status_registro,
					b.ie_editado
			from    w_apap_pac_informacao a,
					w_apap_pac_registro b
			where   a.nr_sequencia 					= b.nr_seq_apap_inf
			and		a.nr_seq_superior 				= linha_pai_row[indexLinhaPai].nr_sequencia
			and		b.dt_registro					= linha_pai_row[indexLinhaPai].dt_registro
			and		coalesce(b.ie_situacao,'A')			= linha_pai_row[indexLinhaPai].ie_situacao
			and		coalesce(b.ie_integracao,'N')		= linha_pai_row[indexLinhaPai].ie_integracao
			and		coalesce(b.nr_seq_origem,0)			= coalesce(linha_pai_row[indexLinhaPai].nr_seq_origem,0)
			
union

			SELECT	a.nr_sequencia,
					'@'||a.nm_atributo_linked||'#' nm_atributo_linked,
					null ds_resultado,
					null vl_resultado,
					null ds_unid_med,
					(	select	max(y.ie_referencia) 
						from 	documento_atributo_ref y
						where	y.nm_atributo 			= a.nm_atributo_tabela
						and		y.nr_seq_linked_data 	= a.nr_seq_linked_data
						and		y.ie_referencia in ('PADSV','PASSV','PAMSV','PADHEM','PASHEM','PAMHEM','PAPS','PAPD','PAPM')) ie_referencia,
					null nr_seq_origem,
					null ie_alerta,
					null ds_cor,
					a.nm_atributo_tabela,
					null ie_status_houdini,
					null ie_status_registro,
					null ie_editado
			from    w_apap_pac_informacao a
			where	a.nr_seq_superior 	= linha_pai_row[indexLinhaPai].nr_sequencia
			and		not exists (select 	1 
								from 	w_apap_pac_registro b 
								where	a.nr_sequencia 			= b.nr_seq_apap_inf
								and		b.dt_registro			= linha_pai_row[indexLinhaPai].dt_registro
								and		coalesce(b.ie_situacao,'A')	= linha_pai_row[indexLinhaPai].ie_situacao
								and		coalesce(b.ie_integracao,'N')= linha_pai_row[indexLinhaPai].ie_integracao)) alias14;
								
	<<read_linhas_filha>>
	FOR indexLinhaFilha IN 1 .. linha_filha_row.count LOOP
		ds_formato_composto_w	:= replace(ds_formato_composto_w,'.DS',null);
		ds_formato_composto_w	:= replace(ds_formato_composto_w,linha_filha_row[indexLinhaFilha].nm_atributo_linked,coalesce(linha_filha_row[indexLinhaFilha].ds_resultado||' '||linha_filha_row[indexLinhaFilha].ds_unid_med,'-'));
		if (linha_filha_row[indexLinhaFilha](.nr_seq_origem IS NOT NULL AND .nr_seq_origem::text <> '')) then
			nr_seq_origem_w := linha_filha_row[indexLinhaFilha].nr_seq_origem;
		end if;	
		if (linha_filha_row[indexLinhaFilha].ie_alerta = 'S') then
			ie_alerta_w := linha_filha_row[indexLinhaFilha].ie_alerta;
		end if;	
		if (linha_filha_row[indexLinhaFilha](.ds_cor IS NOT NULL AND .ds_cor::text <> '')) then
			ds_cor_w := linha_filha_row[indexLinhaFilha].ds_cor;
		end if;	
		if (linha_filha_row[indexLinhaFilha].nm_atributo_tabela = linha_pai_row[indexLinhaPai].nm_atrib_vl_graf) then
			vl_grafico_w:= linha_filha_row[indexLinhaFilha].vl_resultado;
		end if;
		if (linha_filha_row[indexLinhaFilha](.ie_status_houdini IS NOT NULL AND .ie_status_houdini::text <> '')) then
			ie_status_houdini_w := linha_filha_row[indexLinhaFilha].ie_status_houdini;
		end if;	
		if (linha_filha_row[indexLinhaFilha](.ie_status_registro IS NOT NULL AND .ie_status_registro::text <> '')) then
			ie_status_registro_w := linha_filha_row[indexLinhaFilha].ie_status_registro;
		end if;	
		if (linha_filha_row[indexLinhaFilha](.ie_editado IS NOT NULL AND .ie_editado::text <> '')) then
			ie_editado_w := linha_filha_row[indexLinhaFilha].ie_editado;
		end if;	
		
		
		
		case linha_filha_row[indexLinhaFilha].ie_referencia
			when	'PADSV'		then
				vl_pad_w	:= linha_filha_row[indexLinhaFilha].vl_resultado;
			when	'PASSV'		then
				vl_pas_w	:= linha_filha_row[indexLinhaFilha].vl_resultado;
			when	'PAMSV'		then
				vl_pam_w	:= linha_filha_row[indexLinhaFilha].vl_resultado;
			when	'PADHEM'	then
				vl_pad_w	:= linha_filha_row[indexLinhaFilha].vl_resultado;
			when	'PASHEM'	then
				vl_pas_w	:= linha_filha_row[indexLinhaFilha].vl_resultado;
			when	'PAMHEM'	then
				vl_pam_w	:= linha_filha_row[indexLinhaFilha].vl_resultado;	
			when	'PAPS'		then
				vl_paps_w	:= linha_filha_row[indexLinhaFilha].vl_resultado;
			when	'PAPD'		then
				vl_papd_w	:= linha_filha_row[indexLinhaFilha].vl_resultado;
			when	'PAPM'		then
				vl_papm_w	:= linha_filha_row[indexLinhaFilha].vl_resultado;
			else	
				null;
			end case;
	END LOOP read_linhas_filha;
	ind_w 							:= indexLinhaPai;
	tb_ds_result_desc_w(ind_w) 		:= ds_formato_composto_w;
	tb_vl_resultado_w(ind_w) 		:= vl_grafico_w;
	tb_ds_resultado_w(ind_w)		:= ds_formato_composto_w;
	tb_vl_pas_w(ind_w)				:= vl_pas_w;
	tb_vl_pam_w(ind_w)				:= vl_pam_w;
	tb_vl_pad_w(ind_w)				:= vl_pad_w;
	tb_vl_papd_w(ind_w)				:= vl_papd_w;
	tb_vl_paps_w(ind_w)				:= vl_paps_w;
	tb_vl_papm_w(ind_w)				:= vl_papm_w;
	tb_nr_seq_origem_w(ind_w)		:= nr_seq_origem_w;
	tb_ie_alerta_w(ind_w)			:= ie_alerta_w;
	tb_ds_cor_w(ind_w)				:= ds_cor_w;
	tb_ie_integracao_w(ind_w)		:= linha_pai_row[indexLinhaPai].ie_integracao;
	tb_dt_registro_w(ind_w)			:= linha_pai_row[indexLinhaPai].dt_registro;
	tb_nr_sequencia_w(ind_w)		:= linha_pai_row[indexLinhaPai].nr_sequencia;
	tb_ie_insert_w(ind_w)			:= linha_pai_row[indexLinhaPai].ie_insert;
	tb_ie_situacao_w(ind_w)			:= linha_pai_row[indexLinhaPai].ie_situacao;
	tb_ie_status_houdini_w(ind_w)	:= ie_status_houdini_w;
	tb_ie_status_registro_w(ind_w)	:= ie_status_registro_w;
	tb_ie_editado_w(ind_w)			:= ie_editado_w;
	
	
END LOOP read_linhas_pai;


FORALL i IN tb_ds_result_desc_w.FIRST .. tb_ds_result_desc_w.LAST
	update	w_apap_pac_registro
	set		ds_result_desc 		= 	tb_ds_result_desc_w(i),
			vl_resultado		= 	tb_vl_resultado_w(i),
			ds_resultado		= 	tb_ds_resultado_w(i),
			vl_pas				=	tb_vl_pas_w(i),
			vl_pam				=	tb_vl_pam_w(i),
			vl_pad				=	tb_vl_pad_w(i),
			vl_papd				=	tb_vl_papd_w(i),
			vl_paps				=	tb_vl_paps_w(i),
			vl_papm				= 	tb_vl_papm_w(i),
			nr_seq_origem		= 	tb_nr_seq_origem_w(i),
			ie_alerta			= 	tb_ie_alerta_w(i),
			ds_cor				= 	tb_ds_cor_w(i),
			ie_resumo			=  	'S',
			ie_situacao			= 	tb_ie_situacao_w(i),
			ie_integracao		=	tb_ie_integracao_w(i),
			ie_status_houdini	=	tb_ie_status_houdini_w(i),
			ie_status_registro	=	tb_ie_status_registro_w(i),
			ie_editado			=	tb_ie_editado_w(i)
	where	dt_registro 		= 	tb_dt_registro_w(i)
	and		nr_seq_apap_inf 	= 	tb_nr_sequencia_w(i)
	and		coalesce(ie_situacao,'A')= 	tb_ie_situacao_w(i)
	and		coalesce(nr_seq_origem,0) = 	coalesce(tb_nr_seq_origem_w(i),0)
	and		tb_ie_insert_w(i) 	= 	'N';
		
FORALL i IN tb_ds_result_desc_w.FIRST .. tb_ds_result_desc_w.LAST
	insert	into	w_apap_pac_registro(	nr_sequencia,
											dt_atualizacao,
											nm_usuario,
											dt_atualizacao_nrec,
											nm_usuario_nrec,
											nr_seq_origem,
											dt_registro,
											vl_resultado,
											ds_resultado,
											nr_seq_apap_inf,
											dt_medicao,
											dt_resultado,
											dt_inicio,
											dt_fim,
											vl_pas,
											vl_pam,
											vl_pad,
											vl_papd,
											vl_paps,
											vl_papm,
											ds_profissional,
											ie_alerta,
											ds_cor,
											ds_tooltip,
											vl_grafico,
											ie_status,
											ie_status_houdini,
											qt_dose,
											ds_result_desc,
											ie_resumo,
											ie_situacao,
											ie_integracao,
											ie_status_registro,
											ie_editado)
											SELECT nextval('w_apap_pac_registro_seq'),
											clock_timestamp(),
											nm_usuario_w,
											clock_timestamp(),
											nm_usuario_w,
											tb_nr_seq_origem_w(i),
											tb_dt_registro_w(i),
											tb_vl_resultado_w(i),
											tb_ds_resultado_w(i),
											tb_nr_sequencia_w(i),
											tb_dt_registro_w(i),
											null,
											null,
											null,
											tb_vl_pas_w(i),
											tb_vl_pam_w(i),
											tb_vl_pad_w(i),
											tb_vl_papd_w(i),
											tb_vl_paps_w(i),
											tb_vl_papm_w(i),
											null,
											tb_ie_alerta_w(i),
											tb_ds_cor_w(i),
											null,
											null,
											null,
											tb_ie_status_houdini_w(i),
											null,
											tb_ds_result_desc_w(i),
											'S',
											tb_ie_situacao_w(i),
											tb_ie_integracao_w(i),
											tb_ie_status_registro_w(i),
											tb_ie_editado_w(i)
											 where tb_ie_insert_w(i) = 'S';

commit;	

if (coalesce(nr_seq_linha_p,0) > 0) then
	delete
	from	w_apap_pac_registro a
	where	ie_resumo = 'S'
	and		exists (	SELECT	1
							from	w_apap_pac_informacao b
							where	a.nr_seq_apap_inf	= b.nr_seq_superior
							and		b.nr_sequencia		= nr_seq_linha_p)	
	and		not exists (	select 	1 
							from 	w_apap_pac_registro b,
									w_apap_pac_informacao c
							where	b.nr_seq_apap_inf 	= c.nr_sequencia
							and		a.nr_seq_apap_inf	= c.nr_seq_superior
							and		a.dt_registro		= b.dt_registro
							and		c.nr_sequencia		= nr_seq_linha_p);
	commit;						
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE apap_atualiza_linha_pai (nr_sequencia_p bigint, nr_seq_linha_p bigint) FROM PUBLIC;

