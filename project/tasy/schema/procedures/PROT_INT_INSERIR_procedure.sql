-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE prot_int_inserir ( nr_seq_protocolo_integrado_p protocolo_integrado.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type, dt_inicial_previsto_p protocolo_int_paciente.dt_inicial_previsto%type, nr_sequencia_p protocolo_int_paciente.nr_sequencia%type ) AS $body$
DECLARE


nr_seq_etapa_w                  protocolo_integrado_etapa.nr_sequencia%type;
nr_dias_previsto_w              protocolo_int_paciente.nr_dias_previsto%type;
dt_final_previsto_w             protocolo_int_paciente.dt_final_previsto%type;
nr_seq_prot_int_pac_etapa_w     protocolo_int_pac_etapa.nr_sequencia%type;
nr_seq_prot_int_pac_evento_w    protocolo_int_pac_evento.nr_sequencia%type;
dt_inicial_previsto_etapa_w     protocolo_int_pac_etapa.dt_inicial_previsto%type := dt_inicial_previsto_p;
nr_dias_etapa_ant_w             protocolo_int_pac_etapa.nr_dias_previsto%type := 0;
dt_final_previsto_etapa_w       protocolo_int_pac_etapa.dt_final_previsto%type;
nr_indice_evento_w              bigint := 0;
dt_prevista_evento_w            protocolo_int_pac_evento.dt_prevista%type;
nr_dias_etapa_tot_w             protocolo_integrado_etapa.nr_dias_etapa%type;
nr_seq_prot_int_pac_resul_w		protocolo_int_pac_resul.nr_sequencia%type;
nr_indice_outcome_w             bigint := 0;
nr_seq_resultado_w		        protocolo_int_etapa_resul.nr_sequencia%type;
nr_seq_prot_int_pac_resul_av_w	protocolo_int_pac_resul_av.nr_sequencia%type;
nr_indice_evaluation_w			bigint := 0;

type array_evento is table of protocolo_int_pac_evento%rowtype index by integer;
eventos_w array_evento;

type array_outcome is table of protocolo_int_pac_resul%rowtype index by integer;
outcomes_w array_outcome;

type array_evaluation is table of protocolo_int_pac_resul_av%rowtype index by integer;
evaluations_w array_evaluation;

-----------------------------------Cursores-----------------------------------
etapas CURSOR FOR
        SELECT  nr_sequencia,
                ds_etapa,
                nr_dias_etapa,
                ds_etapa_paciente,
                ie_ocultar_visao_paciente,
                nr_dia_inicial,
                nr_dia_final,
                nr_ordem_inicial,
                nr_ordem_final,
                ie_evento_sumario,
                ds_resultado,
                ds_avaliacao_resultado
        from    protocolo_integrado_etapa
        where   nr_seq_protocolo_integrado = nr_seq_protocolo_integrado_p
        order by nr_sequencia;

eventos CURSOR FOR
        SELECT  ds_evento,
                ie_tipo_evento,
                nr_dia_evento,
                nr_seq_plano,
                nr_seq_ponto_verificacao,
                ds_evento_paciente,
                ie_tipo_agendamento,
                cd_especialidade,
                ie_tipo_atendimento,
                ie_clinica,
                cd_procedimento,
                ie_origem_proced,
                cd_protocolo,
                nr_seq_protocolo,
                nr_seq_dispositivo,
                ie_acao,
                nr_seq_escala,
                nr_seq_score_flex,
                nr_seq_score_flex_ii,
                nr_seq_evento,
                nr_seq_grupo_exame_lab,
                nr_seq_tipo_consulta,
                nr_dias_ant,
                nr_dias_dep,
                ie_dose,
                nr_seq_vacina,
                ie_tipo,
                cd_especialidade_medico,
                nr_seq_programa_saude,
                ie_evolucao_clinica,
                cd_classif_setor,
                dt_avaliacao,
                dt_prov_parto,
                nr_seq_gru_ex_nao_lab,
                nr_seq_classif,
                nr_seq_ordem,
                nr_seq_intervencao,
                ie_ocultar_visao_paciente,
                ds_resultado_evento,
                nr_seq_template,
                nr_seq_avaliacao,
                ie_evento_critico,
                nr_dia_protocolo,
		nr_proc_interno
        from    protocolo_integrado_evento
        where   nr_seq_etapa = nr_seq_etapa_w
        order by nr_dia_evento;
		
outcomes CURSOR FOR
		SELECT ds_resultado,
			   ds_resultado_paciente,
			   ie_critico,
			   ie_situacao,
			   nr_ordem_apresentacao,
			   nr_seq_prot_int_result,
			   nr_sequencia
		from protocolo_int_etapa_resul
		where nr_seq_etapa = nr_seq_etapa_w
		and ie_situacao = 'A'
		order by nr_ordem_apresentacao;
		
evaluations CURSOR FOR
		SELECT ds_avaliacao,
			   ie_situacao,
			   nr_ordem_apresentacao
		from protocolo_int_etapa_res_av
		where nr_seq_resultado = nr_seq_resultado_w
		and ie_situacao = 'A'
		order by nr_ordem_apresentacao;

-----------------------------------Procedures-----------------------------------
procedure insert_etapa(etapa	 etapas%rowtype) is;
BEGIN
	nr_dias_previsto_w := prot_int_obter_nr_dias_etapa(nr_seq_protocolo_integrado_p);
		
        select  nextval('protocolo_int_pac_etapa_seq')
        into STRICT    nr_seq_prot_int_pac_etapa_w
;

        nr_seq_etapa_w := etapa.nr_sequencia;

        if (coalesce(pkg_i18n.get_user_locale, 'pt_BR') = 'ja_JP') then

                if (coalesce(etapa.ie_evento_sumario,'N') = 'N') then

                        dt_inicial_previsto_etapa_w := dt_inicial_previsto_p + (etapa.nr_dia_inicial-1);
                        dt_final_previsto_etapa_w := dt_inicial_previsto_p + (etapa.nr_dia_final-1);

                else

                        dt_final_previsto_etapa_w := dt_inicial_previsto_etapa_w;

                end if;

                nr_dias_etapa_tot_w := nr_dias_previsto_w;

        else

                dt_inicial_previsto_etapa_w := dt_inicial_previsto_etapa_w + nr_dias_etapa_ant_w;
                nr_dias_etapa_ant_w := etapa.nr_dias_etapa;
                dt_final_previsto_etapa_w := dt_inicial_previsto_etapa_w + nr_dias_etapa_ant_w - 1;
                nr_dias_etapa_tot_w := etapa.nr_dias_etapa;

        end if;
		

        insert into protocolo_int_pac_etapa(
                nr_sequencia,
                dt_atualizacao,
                nm_usuario,
                dt_atualizacao_nrec,
                nm_usuario_nrec,
                nr_seq_protocolo_int_pac,
                ds_etapa,
                nr_dias_previsto,
                dt_inicial_previsto,
                dt_final_previsto,
                ds_etapa_paciente,
                ie_ocultar_visao_paciente,
                nr_dia_inicial,
                nr_dia_final,
                nr_ordem_inicial,
                nr_ordem_final,
                ie_evento_sumario,
                ds_resultado,
                ds_avaliacao_resultado
        ) values (
                nr_seq_prot_int_pac_etapa_w,
                clock_timestamp(),
                nm_usuario_p,
                clock_timestamp(),
                nm_usuario_p,
                nr_sequencia_p,
                etapa.ds_etapa,
                nr_dias_etapa_tot_w,
                dt_inicial_previsto_etapa_w,
                dt_final_previsto_etapa_w,
                etapa.ds_etapa_paciente,
                etapa.ie_ocultar_visao_paciente,
                etapa.nr_dia_inicial,
                etapa.nr_dia_final,
                etapa.nr_ordem_inicial,
                etapa.nr_ordem_final,
                etapa.ie_evento_sumario,
                etapa.ds_resultado,
                etapa.ds_avaliacao_resultado
        );
        commit;
end;

procedure insert_evento_array(evento 	in eventos%rowtype) is
begin
        select  nextval('protocolo_int_pac_evento_seq')
        into STRICT    nr_seq_prot_int_pac_evento_w
;

        nr_indice_evento_w := nr_indice_evento_w + 1;
        if (coalesce(pkg_i18n.get_user_locale, 'pt_BR') = 'ja_JP') then
                dt_prevista_evento_w := ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_inicial_previsto_p + evento.nr_dia_protocolo - 1) + 12/24;
        else
                dt_prevista_evento_w := ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_inicial_previsto_etapa_w + evento.nr_dia_evento - 1) + 12/24;
        end if;

        eventos_w[nr_indice_evento_w].nr_sequencia := nr_seq_prot_int_pac_evento_w;
        eventos_w[nr_indice_evento_w].dt_atualizacao := clock_timestamp();
        eventos_w[nr_indice_evento_w].nm_usuario := nm_usuario_p;
        eventos_w[nr_indice_evento_w].dt_atualizacao_nrec := clock_timestamp();
        eventos_w[nr_indice_evento_w].nm_usuario_nrec := nm_usuario_p;
        eventos_w[nr_indice_evento_w].nr_seq_prt_int_pac_etapa := nr_seq_prot_int_pac_etapa_w;
        eventos_w[nr_indice_evento_w].ds_evento_plano := evento.ds_evento;
        eventos_w[nr_indice_evento_w].ie_tipo_evento := evento.ie_tipo_evento;
        eventos_w[nr_indice_evento_w].nr_dia_previsto := evento.nr_dia_evento;
        eventos_w[nr_indice_evento_w].NR_SEQ_PLANO := evento.NR_SEQ_PLANO;
        eventos_w[nr_indice_evento_w].dt_prevista := dt_prevista_evento_w;
        eventos_w[nr_indice_evento_w].nr_seq_ponto_verificacao := evento.nr_seq_ponto_verificacao;
        eventos_w[nr_indice_evento_w].ds_evento_plano_paciente := evento.ds_evento_paciente;
        eventos_w[nr_indice_evento_w].CD_ESPECIALIDADE := evento.CD_ESPECIALIDADE;
        eventos_w[nr_indice_evento_w].CD_PROCEDIMENTO := evento.CD_PROCEDIMENTO;
        eventos_w[nr_indice_evento_w].CD_PROTOCOLO := evento.CD_PROTOCOLO;
        eventos_w[nr_indice_evento_w].IE_CLINICA := evento.IE_CLINICA;
        eventos_w[nr_indice_evento_w].IE_ORIGEM_PROCED := evento.IE_ORIGEM_PROCED;
        eventos_w[nr_indice_evento_w].IE_TIPO_AGENDAMENTO := evento.IE_TIPO_AGENDAMENTO;
        eventos_w[nr_indice_evento_w].IE_TIPO_ATENDIMENTO := evento.IE_TIPO_ATENDIMENTO;
        eventos_w[nr_indice_evento_w].NR_SEQ_DISPOSITIVO := evento.NR_SEQ_DISPOSITIVO;
        eventos_w[nr_indice_evento_w].IE_ACAO := evento.IE_ACAO;
        eventos_w[nr_indice_evento_w].NR_SEQ_ESCALA := evento.NR_SEQ_ESCALA;
        eventos_w[nr_indice_evento_w].NR_SEQ_EVENTO := evento.NR_SEQ_EVENTO;
        eventos_w[nr_indice_evento_w].NR_SEQ_GRUPO_EXAME_LAB := evento.NR_SEQ_GRUPO_EXAME_LAB;
        eventos_w[nr_indice_evento_w].NR_SEQ_PROTOCOLO := evento.NR_SEQ_PROTOCOLO;
        eventos_w[nr_indice_evento_w].NR_SEQ_SCORE_FLEX := evento.NR_SEQ_SCORE_FLEX;
        eventos_w[nr_indice_evento_w].NR_SEQ_SCORE_FLEX_II := evento.NR_SEQ_SCORE_FLEX_II;
        eventos_w[nr_indice_evento_w].NR_SEQ_TIPO_CONSULTA := evento.NR_SEQ_TIPO_CONSULTA;
        eventos_w[nr_indice_evento_w].NR_DIAS_ANT := evento.NR_DIAS_ANT;
        eventos_w[nr_indice_evento_w].NR_DIAS_DEP := evento.NR_DIAS_DEP;
        eventos_w[nr_indice_evento_w].IE_DOSE := evento.IE_DOSE;
        eventos_w[nr_indice_evento_w].NR_SEQ_VACINA := evento.NR_SEQ_VACINA;
        eventos_w[nr_indice_evento_w].IE_TIPO := evento.IE_TIPO;
        eventos_w[nr_indice_evento_w].CD_ESPECIALIDADE_MEDICO := evento.CD_ESPECIALIDADE_MEDICO;
        eventos_w[nr_indice_evento_w].NR_SEQ_PROGRAMA_SAUDE := evento.NR_SEQ_PROGRAMA_SAUDE;
        eventos_w[nr_indice_evento_w].IE_EVOLUCAO_CLINICA := evento.IE_EVOLUCAO_CLINICA;
        eventos_w[nr_indice_evento_w].CD_CLASSIF_SETOR := evento.CD_CLASSIF_SETOR;
        eventos_w[nr_indice_evento_w].DT_AVALIACAO := evento.DT_AVALIACAO;
        eventos_w[nr_indice_evento_w].DT_PROV_PARTO := evento.DT_PROV_PARTO;
        eventos_w[nr_indice_evento_w].NR_SEQ_GRUPO_EXAME_NAO_LAB := evento.NR_SEQ_GRU_EX_NAO_LAB;
        eventos_w[nr_indice_evento_w].DS_RESULTADO_EVENTO := evento.DS_RESULTADO_EVENTO;
        eventos_w[nr_indice_evento_w].IE_EVENTO_CRITICO := evento.IE_EVENTO_CRITICO;
        eventos_w[nr_indice_evento_w].NR_SEQ_CLASSIF := evento.NR_SEQ_CLASSIF;
        eventos_w[nr_indice_evento_w].nr_seq_ordem := evento.nr_seq_ordem;
        eventos_w[nr_indice_evento_w].nr_seq_intervencao := evento.nr_seq_intervencao;
        eventos_w[nr_indice_evento_w].ds_resultado_evento := evento.ds_resultado_evento;
        eventos_w[nr_indice_evento_w].nr_seq_template := evento.nr_seq_template;
        eventos_w[nr_indice_evento_w].nr_seq_avaliacao := evento.nr_seq_avaliacao;
        eventos_w[nr_indice_evento_w].ie_evento_critico := evento.ie_evento_critico;
        eventos_w[nr_indice_evento_w].ie_ocultar_visao_paciente := evento.ie_ocultar_visao_paciente;
        eventos_w[nr_indice_evento_w].nr_dia_protocolo := evento.nr_dia_protocolo;
	eventos_w[nr_indice_evento_w].NR_SEQ_PROC_INTERNO := evento.NR_PROC_INTERNO;
end;


procedure insert_outcome_array(outcome 	in outcomes%rowtype) is
begin
	if (coalesce(pkg_i18n.get_user_locale, 'pt_BR') = 'ja_JP') then
			
		select  nextval('protocolo_int_pac_resul_seq')
		into STRICT    nr_seq_prot_int_pac_resul_w
		;
		
		nr_seq_resultado_w := outcome.nr_sequencia;

		nr_indice_outcome_w := nr_indice_outcome_w + 1;
		
		outcomes_w[nr_indice_outcome_w].nr_sequencia := nr_seq_prot_int_pac_resul_w;
		outcomes_w[nr_indice_outcome_w].ds_resultado := outcome.ds_resultado;
		outcomes_w[nr_indice_outcome_w].ds_resultado_paciente := outcome.ds_resultado_paciente;
		outcomes_w[nr_indice_outcome_w].dt_atualizacao := clock_timestamp();
		outcomes_w[nr_indice_outcome_w].dt_atualizacao_nrec := clock_timestamp();
		outcomes_w[nr_indice_outcome_w].ie_critico := outcome.ie_critico;
		outcomes_w[nr_indice_outcome_w].ie_situacao := outcome.ie_situacao;
		outcomes_w[nr_indice_outcome_w].nm_usuario := nm_usuario_p;
		outcomes_w[nr_indice_outcome_w].nm_usuario_nrec := nm_usuario_p;
		outcomes_w[nr_indice_outcome_w].nr_ordem_apresentacao := outcome.nr_ordem_apresentacao;
		outcomes_w[nr_indice_outcome_w].nr_seq_etapa := nr_seq_prot_int_pac_etapa_w;
		outcomes_w[nr_indice_outcome_w].nr_seq_prot_int_result := outcome.nr_seq_prot_int_result;
		
	end if;
		
end;
	
procedure insert_evaluation_array(evaluation 	in evaluations%rowtype) is
begin

	if (coalesce(pkg_i18n.get_user_locale, 'pt_BR') = 'ja_JP') then
			
		select  nextval('protocolo_int_pac_resul_av_seq')
		into STRICT    nr_seq_prot_int_pac_resul_av_w
		;

		nr_indice_evaluation_w := nr_indice_evaluation_w + 1;
		
		evaluations_w[nr_indice_evaluation_w].nr_sequencia := nr_seq_prot_int_pac_resul_av_w;
		evaluations_w[nr_indice_evaluation_w].ds_avaliacao := evaluation.ds_avaliacao;
		evaluations_w[nr_indice_evaluation_w].dt_atualizacao := clock_timestamp();
		evaluations_w[nr_indice_evaluation_w].dt_atualizacao_nrec := clock_timestamp();
		evaluations_w[nr_indice_evaluation_w].ie_avaliacao := 'NI';
		evaluations_w[nr_indice_evaluation_w].ie_situacao := evaluation.ie_situacao;
		evaluations_w[nr_indice_evaluation_w].nm_usuario := nm_usuario_p;
		evaluations_w[nr_indice_evaluation_w].nm_usuario_nrec := nm_usuario_p;
		evaluations_w[nr_indice_evaluation_w].nr_ordem_apresentacao := evaluation.nr_ordem_apresentacao;
		evaluations_w[nr_indice_evaluation_w].nr_seq_resultado := nr_seq_prot_int_pac_resul_w;
			
	end if;		
	
end;
		


-----------------------------------Inicio-----------------------------------
begin
    if (nr_seq_protocolo_integrado_p IS NOT NULL AND nr_seq_protocolo_integrado_p::text <> '') then
        for etapa in etapas loop
        begin
            insert_etapa(etapa);
            for evento in eventos loop
            begin
                insert_evento_array(evento);
            end;
            end loop;
			for outcome in outcomes loop
            begin
                insert_outcome_array(outcome);
				for evaluation in evaluations loop
				begin
					insert_evaluation_array(evaluation);
				end;
				end loop;
            end;
            end loop;
        end;
        end loop;

        forall i in indices of eventos_w
        insert into protocolo_int_pac_evento
        values eventos_w(i);
		
		forall i in indices of outcomes_w
        insert into protocolo_int_pac_resul
        values outcomes_w(i);
		
		forall i in indices of evaluations_w
        insert into protocolo_int_pac_resul_av
        values evaluations_w(i);

        commit;
		-- Continue for copy of tipo evento and category
		CALL load_data_protocol_short_cate(nr_sequencia_p, nm_usuario_p, 281, nr_seq_protocolo_integrado_p);

    end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE prot_int_inserir ( nr_seq_protocolo_integrado_p protocolo_integrado.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type, dt_inicial_previsto_p protocolo_int_paciente.dt_inicial_previsto%type, nr_sequencia_p protocolo_int_paciente.nr_sequencia%type ) FROM PUBLIC;

