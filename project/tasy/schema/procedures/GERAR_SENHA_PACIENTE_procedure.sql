-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_senha_paciente ( nr_seq_fila_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text, ie_senha_prioritaria_p text default 'N', nr_senha_p INOUT text DEFAULT NULL, nr_seq_senha_p INOUT bigint DEFAULT NULL, cd_pessoa_fisica_p text default null, nr_atendimento_p bigint default null, ie_sistema_externo_p text default null) AS $body$
DECLARE


			
			
nr_senha_w			bigint;	
qt_faixa_atual_w			bigint;		
qt_faixa_inicio_w			bigint;
qt_faixa_fim_w			bigint;
hr_reinicio_prioridade_w		varchar(15);
hora_atual_w			varchar(15);
nr_seq_pac_senha_fila_w		bigint;
nr_seq_pac_senha_fila_ww	varchar(30);
ie_permite_outros_estab_w	varchar(1);
nr_prioridade_w			integer;
qt_senhas_disp_w		bigint;
cd_perfil_w			bigint;
nr_seq_turno_w			bigint;
dt_horario_inicial_w		timestamp;
dt_horario_final_w		timestamp;
qt_senhas_turno_w		integer;
nr_seq_fila_espera_turno_w	bigint;
ie_dia_semana_w			varchar(1);
ie_dia_semana_atual_w		varchar(1);
ds_param_integ_hl7_w    varchar(2000) := null;
ds_fila_senha_w         varchar(255) := null;
ds_desc_fila_senha_w    varchar(255) := null;
dt_senha_w              timestamp;
dt_vinculacao_senha_w	timestamp;	
qt_cd_senha_paciente_fila_w 	paciente_senha_fila.cd_senha_gerada%type;

C01 CURSOR FOR
	SELECT	nr_sequencia,
		a.dt_horario_inicial,
		a.dt_horario_final,
		a.ie_dia_semana
	from	turno_senha a
	where 	a.cd_estabelecimento = cd_estabelecimento_p
	and	to_char(clock_timestamp(), 'hh24:mi:ss') >= to_char(a.dt_horario_inicial, 'hh24:mi:ss')
	AND	TO_CHAR(clock_timestamp(), 'hh24:mi:ss') <= TO_CHAR(a.dt_horario_final, 'hh24:mi:ss')
	AND (coalesce(a.ie_dia_semana,'*') = '*'
	OR (a.ie_dia_semana = 9 AND  Obter_Se_Dia_Util(clock_timestamp(),cd_estabelecimento_p) = 'S')
	OR 	 ie_dia_semana_atual_w = a.ie_dia_semana
	OR (a.ie_dia_semana = 0 AND Obter_Se_Feriado(cd_estabelecimento_p, clock_timestamp()) > 0))
	ORDER BY 4 DESC;


BEGIN
cd_perfil_w := obter_perfil_ativo;

/* obter dia semana */

select	obter_cod_dia_semana(clock_timestamp())
into STRICT	ie_dia_semana_atual_w
;

open C01;
loop
fetch C01 into
	nr_seq_turno_w,
	dt_horario_inicial_w,
	dt_horario_final_w,
	ie_dia_semana_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	null;
	end;
end loop;
close C01;
	
	if (nr_seq_turno_w IS NOT NULL AND nr_seq_turno_w::text <> '') then
	select	Max(b.qt_senhas_disponiveis),
		Max(b.nr_seq_fila_espera_senha)
	into STRICT	qt_senhas_disp_w,
		nr_seq_fila_espera_turno_w
	from	turno_senha_config b
	where 	coalesce(b.nr_seq_fila_espera_senha, nr_seq_fila_p) = nr_seq_fila_p
	and	coalesce(b.cd_perfil, cd_perfil_w) = cd_perfil_w
	and 	b.nr_seq_turno_senha = nr_seq_turno_w;
	
	if (qt_senhas_disp_w IS NOT NULL AND qt_senhas_disp_w::text <> '') then
	
		if (dt_horario_inicial_w > dt_horario_final_w) then
			select	count(*)
			into STRICT	qt_senhas_turno_w
			from	paciente_senha_fila
			where	((dt_geracao_senha >= to_date(to_char(clock_timestamp() - interval '1 days', 'dd/mm/yyyy') || ' ' || to_char(dt_horario_inicial_w, 'hh24:mi:ss'), 'dd/mm/yyyy hh24:mi:ss'))
			and (dt_geracao_senha <= to_date(to_char(clock_timestamp(), 'dd/mm/yyyy')     || ' ' || to_char(dt_horario_final_w,   'hh24:mi:ss'), 'dd/mm/yyyy hh24:mi:ss'))
			or (dt_geracao_senha >= to_date(to_char(clock_timestamp(), 'dd/mm/yyyy') || ' ' || to_char(dt_horario_inicial_w, 'hh24:mi:ss'), 'dd/mm/yyyy hh24:mi:ss')))
			and	coalesce(nr_seq_fila_senha, nr_seq_fila_senha_origem) = coalesce(nr_seq_fila_espera_turno_w, coalesce(nr_seq_fila_senha, nr_seq_fila_senha_origem));
				
		else	
			select	count(*)
			into STRICT	qt_senhas_turno_w
			from	paciente_senha_fila
			where	dt_geracao_senha >= to_date(to_char(clock_timestamp(), 'dd/mm/yyyy') || ' ' || to_char(dt_horario_inicial_w, 'hh24:mi:ss'), 'dd/mm/yyyy hh24:mi:ss')
			and	dt_geracao_senha <= to_date(to_char(clock_timestamp(), 'dd/mm/yyyy') || ' ' || to_char(dt_horario_final_w, 'hh24:mi:ss'), 'dd/mm/yyyy hh24:mi:ss')
			and	coalesce(nr_seq_fila_senha, nr_seq_fila_senha_origem) = coalesce(nr_seq_fila_espera_turno_w, coalesce(nr_seq_fila_senha, nr_seq_fila_senha_origem));

		end if;
		
		if (qt_senhas_turno_w >= qt_senhas_disp_w) then

			CALL wheb_mensagem_pck.exibir_mensagem_abort(277631);
		end if;
	end if;
	end if;

ie_permite_outros_estab_w := Obter_param_Usuario(10021, 78, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_permite_outros_estab_w);

select	max(qt_faixa_inicio),
	max(qt_faixa_fim),
	coalesce(max(qt_faixa_atual),0) + 1,
	max(to_char(hr_reinicio_prioridade,'hh24:mi')),
	max(coalesce(nr_prioridade_padrao, nr_prioridade)),
	max(remover_acentuacao(substr(coalesce(ds_curto, ds_fila), 1, 255))),
	clock_timestamp()
into STRICT	qt_faixa_inicio_w,
	qt_faixa_fim_w,
	nr_senha_w,
	hr_reinicio_prioridade_w,
	nr_prioridade_w,
	ds_fila_senha_w,
	dt_senha_w
from	fila_espera_senha
where	nr_sequencia = nr_seq_fila_p
and	coalesce(ie_situacao,'A') = 'A'
and	cd_estabelecimento = CASE WHEN ie_permite_outros_estab_w='S' THEN  cd_estabelecimento  ELSE cd_estabelecimento_p END;

hora_atual_w	:=	to_char(clock_timestamp(),'hh24:mi');

/*
select	nvl(max(cd_senha_gerada),0) +1 
into	nr_senha_w
from	paciente_senha_fila
where	nvl(nr_seq_fila_senha,nr_seq_fila_senha_origem) = nr_seq_fila_p
and	dt_vinculacao_senha is null;
*/
if (nr_senha_w > qt_faixa_fim_w) then
	update	fila_espera_senha
	set	qt_faixa_atual	= qt_faixa_inicio_w
	where	nr_sequencia	= nr_seq_fila_p;
	
	nr_senha_w := qt_faixa_inicio_w;
	commit;

elsif (hr_reinicio_prioridade_w = hora_atual_w) then	
	update	fila_espera_senha
	set	qt_faixa_atual	= qt_faixa_inicio_w
	where	nr_sequencia	= nr_seq_fila_p;
	
	nr_senha_w := qt_faixa_inicio_w;
	commit;

elsif (nr_senha_w = 1) then
	nr_senha_w := qt_faixa_inicio_w;
	
end if;
dt_senha_w		:= clock_timestamp();

if (coalesce(nr_atendimento_p,0) > 0) then
	dt_vinculacao_senha_w	:= dt_senha_w;
else
	dt_vinculacao_senha_w	:= null;
end if;

--Tratamento de senhas geradas em duplicidade
select	coalesce(max(cd_senha_gerada),0)
into STRICT	qt_cd_senha_paciente_fila_w
from 	paciente_senha_fila a
where 	a.NR_SEQ_FILA_SENHA = nr_seq_fila_p
AND		coalesce(a.dt_inutilizacao::text, '') = '' 
AND		coalesce(a.dt_utilizacao::text, '') = '' 
AND		coalesce(a.dt_fim_atendimento::text, '') = '' 
AND	 	((coalesce(a.dt_vinculacao_senha::text, '') = '') OR (a.dt_inicio_atendimento IS NOT NULL AND a.dt_inicio_atendimento::text <> ''));


if (nr_senha_w = qt_cd_senha_paciente_fila_w)
  	and (nr_senha_w > 0) 	      then
	
	nr_senha_w := nr_senha_w + 1;

end if;	

if (nr_senha_w > 0) then
	nr_senha_p := nr_senha_w;
	
	update	fila_espera_senha
	set	qt_faixa_atual	= nr_senha_w
	where	nr_sequencia	= nr_seq_fila_p;
	commit;

	select	nextval('paciente_senha_fila_seq')
	into STRICT	nr_seq_pac_senha_fila_w
	;
	
	select	substr(obter_letra_verifacao_senha(nr_seq_fila_p) || nr_senha_w,1,30)
	into STRICT	nr_seq_pac_senha_fila_ww
	;
	
	nr_seq_senha_p := nr_seq_pac_senha_fila_w;

	insert into paciente_senha_fila(
		nr_sequencia,
		nr_seq_fila_senha_origem,
		nr_seq_fila_senha,
		nm_usuario_nrec,
		nm_usuario,
		dt_geracao_senha,
		dt_atualizacao_nrec,
		dt_atualizacao,
		cd_senha_gerada,
		cd_estabelecimento,
		nr_prioridade,
		cd_pessoa_fisica,
		dt_vinculacao_senha,
		ie_sistema_externo)
	values (nr_seq_pac_senha_fila_w,
		nr_seq_fila_p,
		nr_seq_fila_p,
		nm_usuario_p,
		nm_usuario_p,
		dt_senha_w,
		dt_senha_w,
		dt_senha_w,
		nr_senha_w,
		cd_estabelecimento_p,
		CASE WHEN coalesce(ie_senha_prioritaria_p, 'N')='N' THEN  nr_prioridade_w  ELSE nr_prioridade_w - 1 END ,
		cd_pessoa_fisica_p,
		dt_vinculacao_senha_w,
		ie_sistema_externo_p);

	if (coalesce(nr_atendimento_p,0) > 0) then
		update	atendimento_paciente
		set		nr_seq_pac_senha_fila = nr_seq_pac_senha_fila_w
		where	nr_atendimento = nr_atendimento_p;
	end if;
else
	nr_senha_p := 0;
end if;

commit;

  begin
    if nr_senha_p > 0 then


      if coalesce(ie_senha_prioritaria_p, 'N') = 'S' then 
        nr_prioridade_w := nr_prioridade_w - 1;
      end if;


        ds_desc_fila_senha_w := substr(coalesce(obter_letra_verifacao_senha(nr_seq_fila_p), ''), 1, 255);

        ds_param_integ_hl7_w := 'nr_seq_fila='            || nr_seq_fila_p                    || ';'  ||
                                'cd_senha_gerada='        || nr_senha_w                       || ';'  ||
                                'ds_fila_senha='          || ds_fila_senha_w                  || ';'  ||
                                'ds_desc_fila_senha='     || ds_desc_fila_senha_w             || ';'  ||
                                'nr_seq_pac_senha_fila='  || nr_seq_pac_senha_fila_w          || ';'  ||
                                'dt_senha_w='             || to_char(dt_senha_w, 'YYYY-MM-DD HH:MM:SS') || ';'  ||
                                'nr_prioridade_w='        || nr_prioridade_w                  || ';'  ||
                                'ie_senha_prioritaria='   || coalesce(ie_senha_prioritaria_p, 'N') || ';';
        CALL gravar_agend_integracao(596, ds_param_integ_hl7_w, '');
    end if;
  exception
  when others then
    null;
  end;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_senha_paciente ( nr_seq_fila_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text, ie_senha_prioritaria_p text default 'N', nr_senha_p INOUT text DEFAULT NULL, nr_seq_senha_p INOUT bigint DEFAULT NULL, cd_pessoa_fisica_p text default null, nr_atendimento_p bigint default null, ie_sistema_externo_p text default null) FROM PUBLIC;

