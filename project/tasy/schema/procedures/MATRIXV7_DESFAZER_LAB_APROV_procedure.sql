-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE matrixv7_desfazer_lab_aprov ( nr_prescricao_p prescr_procedimento.nr_prescricao%TYPE, cd_exame_p lab_exame_equip.cd_exame_equip%TYPE, nota_retificacao_p text, nm_usuario_p text DEFAULT nvl(wheb_usuario_pck.get_nm_usuario, 'Matrix'), nr_seq_prescr_p bigint DEFAULT 0) AS $body$
DECLARE


    nr_seq_prescr_w     prescr_procedimento.nr_sequencia%TYPE;
    ie_status_atend_w   prescr_procedimento.ie_status_atend%TYPE;
    nr_seq_mot_w        lab_motivo_desaprov.nr_sequencia%TYPE;
    ds_erro_w           varchar(255) := NULL;

BEGIN
	if (coalesce(nr_seq_prescr_p,0) = 0) then
		nr_seq_prescr_w := matrixv7_get_nr_seq_prescr(nr_prescricao_p, cd_exame_p);
    else
		nr_seq_prescr_w := nr_seq_prescr_p;
	end if;

    BEGIN
        SELECT ie_status_atend
        INTO STRICT ie_status_atend_w
        FROM prescr_procedimento
        WHERE nr_prescricao = nr_prescricao_p AND nr_sequencia = nr_seq_prescr_w;

    EXCEPTION
        WHEN no_data_found THEN
            --Nao foi localizado um exame com codigo #@CD_EXAME#@ na prescricao #@NR_PRESCRICAO#@. E necessario verificar o cadastro do exame. O resultado nao sera importado para esse exame.
            CALL wheb_mensagem_pck.exibir_mensagem_abort(
                nr_seq_mensagem_p => 1118417,
                vl_macros_p => 'CD_EXAME=' || cd_exame_p || ';NR_PRESCRICAO=' || nr_prescricao_p
            );
    END;

    IF ie_status_atend_w >= 35 THEN
        SELECT
            coalesce(MAX(nr_sequencia), 0)
        INTO STRICT
            nr_seq_mot_w
        FROM
            lab_motivo_desaprov
        WHERE
            ie_retificacao = 'S'
            AND ie_situacao = 'A';

        ds_erro_p => ds_erro_w
         := ws_desfazer_lab_aprovacao(
            nr_prescricao_p => nr_prescricao_p, nr_seq_prescr_p => nr_seq_prescr_w, nm_usuario_p => nm_usuario_p, ds_erro_p => ds_erro_w
        );

        IF (ds_erro_w IS NOT NULL AND ds_erro_w::text <> '') THEN
            CALL wheb_mensagem_pck.exibir_mensagem_abort(
                nr_seq_mensagem_p => 279336,
                vl_macros_p => 'DS_ERRO_P=' || ds_erro_w
            );
        END IF;

        IF ( nr_seq_mot_w > 0 ) THEN
            CALL lab_informa_motivo_desaprov(
                nr_seq_motivo_desaprov_p => nr_seq_mot_w,
                nr_prescricao_p => nr_prescricao_p,
                nr_seq_prescr_p => nr_seq_prescr_w,
                nm_usuario_p => nm_usuario_p,
                ie_lib_p => 'N',
                ds_observ_desaprov_p => substr(nota_retificacao_p, 0, 255)
            );
        END IF;

    END IF;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE matrixv7_desfazer_lab_aprov ( nr_prescricao_p prescr_procedimento.nr_prescricao%TYPE, cd_exame_p lab_exame_equip.cd_exame_equip%TYPE, nota_retificacao_p text, nm_usuario_p text DEFAULT nvl(wheb_usuario_pck.get_nm_usuario, 'Matrix'), nr_seq_prescr_p bigint DEFAULT 0) FROM PUBLIC;

