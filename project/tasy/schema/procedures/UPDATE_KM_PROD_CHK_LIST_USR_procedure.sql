-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE update_km_prod_chk_list_usr ( cd_funcao_p COM_CONS_GEST_USER_FUN.CD_FUNCAO%type, nm_usuario_nrec_p COM_CONS_GEST_USER_FUN.NM_USUARIO_NREC%type, answer_p KM_PROD_CHKLIST_BY_USER.ANSWER%type, nr_seq_check_list_p km_prod_chklist_by_user.NR_SEQ_CHECK_LIST%type) AS $body$
DECLARE

	record_count_w smallint;
  score_count_w smallint;
	
BEGIN
	select count(*) into STRICT record_count_w from KM_PROD_CHKLIST_BY_USER a ,KM_PRODUCT_CHECKLIST b where a.NR_SEQ_CHECK_LIST =b.NR_SEQUENCIA   and a.NM_USUARIO =wheb_usuario_pck.get_nm_usuario() and a.CD_FUNCAO =cd_funcao_p and a.IE_SITUACAO ='A' AND NR_SEQ_CHECK_LIST = nr_seq_check_list_p;
	if (record_count_w = 0) then
				insert into km_prod_chklist_by_user(nr_sequencia,
				dt_atualizacao,
				nm_usuario,
				dt_atualizacao_nrec,
				nm_usuario_nrec,
				nr_seq_check_list,
				nm_user,
				answer,
				cd_funcao,
				IE_SITUACAO
				)
				values (
				nextval('km_prod_chklist_by_user_seq'),
				clock_timestamp(),
				wheb_usuario_pck.get_nm_usuario(),
				clock_timestamp(),
				nm_usuario_nrec_p,
				nr_seq_check_list_p,
				wheb_usuario_pck.get_nm_usuario(),
				answer_p,
				cd_funcao_p,
				'A'
				);

        
	else 
				update km_prod_chklist_by_user set answer = answer_p where CD_FUNCAO = cd_funcao_p AND NR_SEQ_CHECK_LIST = nr_seq_check_list_p;
	end if;

  select sum(nr_score) *10 into STRICT score_count_w from KM_PROD_CHKLIST_BY_USER a ,KM_PRODUCT_CHECKLIST b 
  where a.NR_SEQ_CHECK_LIST =b.NR_SEQUENCIA   and a.NM_USUARIO =nm_usuario_nrec_p and a.CD_FUNCAO =cd_funcao_p
  and a.ANSWER ='S' and a.IE_SITUACAO ='A';

  update COM_CONS_GEST_USER_FUN set PR_CONHECIMENTO = score_count_w where CD_FUNCAO =cd_funcao_p and NM_USUARIO =nm_usuario_nrec_p;
	commit;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE update_km_prod_chk_list_usr ( cd_funcao_p COM_CONS_GEST_USER_FUN.CD_FUNCAO%type, nm_usuario_nrec_p COM_CONS_GEST_USER_FUN.NM_USUARIO_NREC%type, answer_p KM_PROD_CHKLIST_BY_USER.ANSWER%type, nr_seq_check_list_p km_prod_chklist_by_user.NR_SEQ_CHECK_LIST%type) FROM PUBLIC;

