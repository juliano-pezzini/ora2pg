-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE atualiza_dose_medic_copia ( nr_seq_item_p bigint, nr_prescricao_p bigint, qt_dose_p text) AS $body$
DECLARE

	
  cd_estabelecimento_w		prescr_medica.cd_estabelecimento%type;
	cd_material_w					  prescr_material.cd_material%type;
	cd_intervalo_w					prescr_material.cd_intervalo%type;
	ie_via_aplicacao_w			prescr_material.ie_via_aplicacao%type;
	qt_dose_especial_w			prescr_material.qt_dose_especial%type;
	nr_ocorrencia_w					prescr_material.nr_ocorrencia%type;
	ds_dose_diferenciada_w	prescr_material.ds_dose_diferenciada%type;
	ie_origem_inf_w					prescr_material.ie_origem_inf%type := 'P';
	cd_unidade_medida_w			prescr_material.cd_unidade_medida%type;
	ie_se_necessario_w			prescr_material.ie_se_necessario%type;
	ie_acm_w						    prescr_material.ie_acm%type;
	qt_material_w   				double precision;
	qt_dispensar_w					double precision;
	ie_regra_disp_w					varchar(1);
	ds_erro_w						    varchar(255);
	qt_conversao_dose_w			material_conversao_unidade.qt_conversao%type;
	cd_unidade_medida_dose_w	prescr_material.cd_unidade_medida_dose%type;
	qt_unitaria_w				double precision;

	C01 CURSOR FOR
		SELECT 	a.cd_estabelecimento,
            b.cd_material,
       			b.cd_intervalo,
		       	b.ie_via_aplicacao,
       			b.qt_dose_especial,
            b.nr_ocorrencia,
       			b.ds_dose_diferenciada,
            b.ie_origem_inf,
       			b.cd_unidade_medida_dose,
       			b.qt_material,
       			b.ie_se_necessario,
       			b.ie_acm
  		from 	prescr_medica a,
       			prescr_material b
 		where 	a.nr_prescricao = b.nr_prescricao
   		and 	b.nr_sequencia 	= nr_seq_item_p
   		and 	b.nr_prescricao = nr_prescricao_p;
	

BEGIN

	open C01;
		loop
			fetch c01 into
				cd_estabelecimento_w,
				cd_material_w,
				cd_intervalo_w,
				ie_via_aplicacao_w,
				qt_dose_especial_w,
				nr_ocorrencia_w,
				ds_dose_diferenciada_w,
				ie_origem_inf_w,
				cd_unidade_medida_dose_w,
				qt_material_w,				
				ie_se_necessario_w,
				ie_acm_w;
			EXIT WHEN NOT FOUND; /* apply on c01 */
        cd_estabelecimento_w := cd_estabelecimento_w;				
        cd_material_w := cd_material_w;
				cd_intervalo_w := cd_intervalo_w;
				ie_via_aplicacao_w := ie_via_aplicacao_w;
				qt_dose_especial_w := qt_dose_especial_w;
				nr_ocorrencia_w := nr_ocorrencia_w;
				ds_dose_diferenciada_w := ds_dose_diferenciada_w;
				ie_origem_inf_w := ie_origem_inf_w;
				cd_unidade_medida_dose_w := cd_unidade_medida_dose_w;
				qt_material_w := 	qt_material_w;
				ie_se_necessario_w := ie_se_necessario_w;
				ie_acm_w := ie_acm_w;
		end loop;
	close C01;
	
	qt_conversao_dose_w	:= coalesce(obter_conversao_unid_med(cd_material_w, cd_unidade_medida_dose_w),0);
		
	if (qt_conversao_dose_w <= 0) then
		qt_conversao_dose_w	:= 1;
	end if;
	
	qt_unitaria_w := dividir(qt_dose_p, qt_conversao_dose_w);
	
	SELECT * FROM Obter_Quant_Dispensar(cd_estabelecimento_w, cd_material_w, nr_prescricao_p, nr_seq_item_p, cd_intervalo_w, ie_via_aplicacao_w, qt_unitaria_w, coalesce(qt_dose_especial_w,0), nr_ocorrencia_w, ds_dose_diferenciada_w, ie_origem_inf_w, cd_unidade_medida_dose_w, 1, qt_material_w, qt_dispensar_w, ie_regra_disp_w, ds_erro_w, ie_se_necessario_w, ie_acm_w) INTO STRICT qt_material_w, qt_dispensar_w, ie_regra_disp_w, ds_erro_w;

	update	prescr_material
	set		  qt_dose = qt_dose_p,
          qt_total_dispensar = qt_dispensar_w,
          ie_regra_disp = ie_regra_disp_w
	where	nr_sequencia = nr_seq_item_p
	and		nr_prescricao = nr_prescricao_p;

	commit;
	
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE atualiza_dose_medic_copia ( nr_seq_item_p bigint, nr_prescricao_p bigint, qt_dose_p text) FROM PUBLIC;

