-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE populate_can_table ( dt_exportar_de_p timestamp , dt_exportar_ate_p timestamp , nm_usuario_p text , returned_value_p INOUT bigint , other_exception_p INOUT text ) AS $body$
DECLARE

dt_exportar_de_w		timestamp;
dt_exportar_ate_w		timestamp;
returned_value_w		bigint;
  /*--CAN table columns*/

nr_patient_identifier_w		varchar(8);
nr_admission_number_w		varchar(12);
nr_multiple_primary_site_w	varchar(2);
cd_primary_site_cancer_w	varchar(9);
ds_primary_site_cancer_w	varchar(40);
cd_morphology_code_w		varchar(7);
dt_first_diagnosis_w		varchar(9);
ie_date_fisrt_diagnosis_w	varchar(1);
ds_location_usual_residence_w	varchar(40);
cd_postcode_usual_residence_w	varchar(4);
ie_laterality_of_cancer_w	varchar(1);
ie_basis_of_diagnosis_w		varchar(2);
ds_comments_w			varchar(50);
cd_laboratory_facility_w	varchar(2);
ds_laboratory_specimen_w	varchar(50);
line_count_w			bigint	:= 0;
downloaded_report_count_w	bigint	:= 0;
v_errm				varchar(100 );
exc_raised_in_can_tab		exception;
								 																			
error_result			text		:= null;
c01 CURSOR FOR
	SELECT distinct adiciona_zeros_esquerda(pf.nr_prontuario,8),
		adiciona_zeros_esquerda(ap.nr_atendimento,12),
		obter_count_primary_site( ap.nr_atendimento , rc.nr_sequencia ) ,
		rc.cd_topografia ,
		chr( 34 )||trim(both substr( obter_desc_cid_doenca( rc.cd_topografia ) , 1 , 38 ) )||chr( 34 ) ,
		rc.cd_cid_morfologia ,
		to_char( coalesce( rc.dt_diagnostico , '15-JUN-1900' ) , 'ddMONyyyy' ) ,
		rc.ie_estimado ,
		chr( 34 )||obter_compl_pf( ap.cd_pessoa_fisica , 1 , 'DSM' )||chr( 34 ) ,
		substr(obter_compl_pf( ap.cd_pessoa_fisica , 1 , 'CEP' ),1,4),
		rc.ie_lado ,
		rc.ie_base_diagnostico ,
		(CASE WHEN (rcr.ds_razao IS NOT NULL AND rcr.ds_razao::text <> '') THEN chr( 34 )||trim(both substr( remove_html_from_text( rcr.ds_razao ) , 1 , 48 ) )||chr( 34 )  ELSE null  END) ,
		rc.ie_laboratorio ,
		rc.cd_amostra
	FROM pessoa_fisica pf, diagnostico_doenca dd, atendimento_paciente ap
LEFT OUTER JOIN registro_cancer rc ON (ap.nr_atendimento = rc.nr_atendimento)
LEFT OUTER JOIN registro_cancer_razao rcr ON (rc.nr_sequencia = rcr.nr_seq_registro)
WHERE ap.nr_atendimento   =dd.nr_atendimento and ap.cd_pessoa_fisica =pf.cd_pessoa_fisica  and dd.cd_doenca in (
			SELECT cd_doenca_cid
			from cid_doenca
			where (	cd_doenca_cid like 'C%'		OR
				cd_doenca_cid like 'D0%' 	OR
				cd_doenca_cid like 'D3%' 	OR
				cd_doenca_cid like 'D4%' 	OR
				cd_doenca_cid like 'Z85%')
			EXCEPT
			select cd_doenca_cid
			from cid_doenca
			where (	cd_doenca_cid like 'C44%' 	OR
				cd_doenca_cid like 'C77%' 	OR
				cd_doenca_cid like 'C78%' 	OR
				cd_doenca_cid like 'C79%' 	OR
				cd_doenca_cid like 'D1%'  	OR
				cd_doenca_cid like 'D2%'  	OR
				cd_doenca_cid like 'D31%' 	OR
				cd_doenca_cid like 'D32%' 	OR
				cd_doenca_cid like 'D34%' 	OR
				cd_doenca_cid like 'D35%' 	OR
				cd_doenca_cid like 'D36%' 	OR
				cd_doenca_cid like 'D04%' 	OR
				cd_doenca_cid like 'D48.5%' 	OR
				cd_doenca_cid like 'Z85.9')
			
UNION ALL

			select cd_doenca_cid
			from cid_doenca
			where (	cd_doenca_cid like 'D18.02' 	OR
				cd_doenca_cid like 'Q85.0' 	OR
				cd_doenca_cid like 'D76.0')
		) and (rc.dt_liberacao IS NOT NULL AND rc.dt_liberacao::text <> '') and rc.dt_diagnostico between dt_exportar_de_w and dt_exportar_ate_w;

BEGIN
	dt_exportar_de_w	:= dt_exportar_de_p;
	dt_exportar_ate_w	:= dt_exportar_ate_p;
	if (dt_exportar_de_w IS NOT NULL AND dt_exportar_de_w::text <> '' AND dt_exportar_ate_w IS NOT NULL AND dt_exportar_ate_w::text <> '') then
		open c01;
		loop
			line_count_w	:= line_count_w+1;
		begin
		fetch c01 into
			nr_patient_identifier_w ,
			nr_admission_number_w ,
			nr_multiple_primary_site_w ,
			cd_primary_site_cancer_w ,
			ds_primary_site_cancer_w ,
			cd_morphology_code_w ,
			dt_first_diagnosis_w ,
			ie_date_fisrt_diagnosis_w ,
			ds_location_usual_residence_w ,
			cd_postcode_usual_residence_w ,
			ie_laterality_of_cancer_w ,
			ie_basis_of_diagnosis_w ,
			ds_comments_w ,
			cd_laboratory_facility_w ,
			ds_laboratory_specimen_w;
		EXIT WHEN NOT FOUND; /* apply on c01 */
		
			begin
				insert into cancer_details(
					nr_sequencia ,
					dt_atualizacao ,
					nm_usuario ,
					dt_atualizacao_nrec ,
					nm_usuario_nrec ,
					nr_patient_identifier ,
					nr_admission_number ,
					nr_multiple_primary_site ,
					cd_primary_site_cancer ,
					ds_primary_site_cancer ,
					cd_morphology_code ,
					dt_first_diagnosis ,
					ie_date_fisrt_diagnosis ,
					ds_location_usual_residence ,
					cd_postcode_usual_residence ,
					ie_laterality_of_cancer ,
					ie_basis_of_diagnosis ,
					ds_comments ,
					cd_laboratory_facility ,
					ds_laboratory_specimen ,
					dt_export_from ,	
					dt_export_to ,
					nr_report_sequence)
				values (	nextval('cancer_details_seq') ,
					clock_timestamp() ,
					nm_usuario_p ,
					clock_timestamp() ,
					nm_usuario_p ,
					nr_patient_identifier_w ,
					nr_admission_number_w ,
					nr_multiple_primary_site_w ,
					cd_primary_site_cancer_w ,
					ds_primary_site_cancer_w ,
					cd_morphology_code_w ,
					dt_first_diagnosis_w ,
					ie_date_fisrt_diagnosis_w ,
					ds_location_usual_residence_w ,
					cd_postcode_usual_residence_w ,
					ie_laterality_of_cancer_w ,
					ie_basis_of_diagnosis_w ,
					ds_comments_w ,
					cd_laboratory_facility_w ,
					ds_laboratory_specimen_w ,
					dt_exportar_de_w ,
					dt_exportar_ate_w ,
					null);
			exception when others then
				v_errm      := substr( sqlerrm , 1 , 100 );
				error_result:= error_result || ' '|| v_errm||' . error happened at line '||line_count_w||' for encounter '|| nr_admission_number_w ||chr( 13 )||chr( 10 );
			end;				
		exception
		when data_exception or unique_violation or invalid_cursor_state then
			v_errm      := substr( sqlerrm , 1 , 100 );
			error_result:= error_result || ' '|| v_errm||' . error happened at line '||line_count_w||chr( 13 )||chr( 10 );
		end;
		end loop;
			returned_value_w	:= 1;
			other_exception_p	:= null;
			if (error_result IS NOT NULL AND error_result::text <> '')then
				returned_value_w	:= 0;
				other_exception_p	:= error_result;
				raise exc_raised_in_can_tab;							
			end if;
		close c01;
	end if;
		returned_value_p	:= returned_value_w;
exception
when others then
	returned_value_p	:= 2;
	other_exception_p	:= other_exception_p||wheb_mensagem_pck.get_texto( 1073278 , 'DS_ERROR='||'populate_can_table. Error:'|| sqlerrm );
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE populate_can_table ( dt_exportar_de_p timestamp , dt_exportar_ate_p timestamp , nm_usuario_p text , returned_value_p INOUT bigint , other_exception_p INOUT text ) FROM PUBLIC;

