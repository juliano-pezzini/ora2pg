-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_desc_itens_result_lic ( nr_seq_licitacao_p bigint, nm_usuario_p text) AS $body$
DECLARE

					 
nr_seq_lic_item_w			reg_lic_item.nr_seq_lic_item%type;
nr_posicao_w			integer;
ds_fornec_w			varchar(255);
vl_item_w				reg_lic_fornec_lance.vl_item%type;
qt_item_w			reg_lic_item.qt_item%type;
ds_itens_w			w_resultado_licitacao.ds_itens%type;
ds_itens_desqualificados_w		w_resultado_licitacao.ds_itens_desqualificados%type;
ds_itens_desertos_w		w_resultado_licitacao.ds_itens_desertos%type;
ds_itens_frustrados_w		w_resultado_licitacao.ds_itens_frustrados%type;
ds_empresas_habilitadas_w		w_resultado_licitacao.ds_empresas_habilitadas%type;
nr_seq_fornec_w			reg_lic_fornec_lance.nr_seq_fornec%type;
vl_total_w			w_resultado_licitacao.vl_total%type := 0;
ds_modalidade_w			w_resultado_licitacao.ds_modalidade%type;
ds_objeto_w			w_resultado_licitacao.ds_objeto%type;
ds_controle_edital_w		w_resultado_licitacao.ds_controle_edital%type;
nm_pessoa_w			w_resultado_licitacao.nm_pessoa%type;
ds_tipo_envolvido_w		w_resultado_licitacao.ds_tipo_envolvido%type;
lb_itens_desqualificados_w		w_resultado_licitacao.lb_itens_desqualificados%type;
lb_itens_desertos_w		w_resultado_licitacao.lb_itens_desertos%type;
lb_itens_frustrados_w		w_resultado_licitacao.lb_itens_frustrados%type;
lb_empresas_habilitadas_w		w_resultado_licitacao.lb_empresas_habilitadas%type;
lb_valor_total_w			w_resultado_licitacao.lb_valor_total%type;

C01 CURSOR FOR 
SELECT	a.nr_seq_lic_item 
from	reg_lic_item a 
where	a.nr_seq_licitacao = nr_seq_licitacao_p 
and	coalesce(a.nr_seq_lote::text, '') = '' 
and 	coalesce(lic_obter_se_deserto_frustrado(a.nr_seq_licitacao, a.nr_seq_lic_item),'S') = 'S' 
order by a.nr_seq_lic_item;

C02 CURSOR FOR 
SELECT	distinct 
	row_number() OVER () AS nr_posicao, 
	ds_fornec, 
	vl_item 
from (SELECT	distinct 
		substr(obter_fornec_reg_lic_fornec(a.nr_seq_fornec),1,255) ds_fornec, 
		min(lic_obter_menor_vl_item_lance(a.nr_seq_licitacao, a.nr_seq_lic_item, a.nr_seq_fornec, a.nr_seq_lance)) vl_item 
	from	reg_lic_fornec_lance a 
	where	a.nr_seq_licitacao = nr_seq_licitacao_p 
	and	a.nr_seq_lic_item = nr_seq_lic_item_w 
	and	lic_obter_situacao_fornec(nr_seq_fornec) <> 'I' 
	and	coalesce(lic_obter_se_deserto_frustrado(a.nr_seq_licitacao, a.nr_seq_lic_item),'S') = 'S' 
	group by nr_seq_fornec 
	order by vl_item) alias7 
order by 1;

C03 CURSOR FOR 
SELECT	a.nr_seq_lic_item 
from	reg_lic_item a 
where	a.nr_seq_licitacao = nr_seq_licitacao_p 
and	coalesce(a.nr_seq_lote::text, '') = '' 
and 	coalesce(lic_obter_se_deserto_frustrado(a.nr_seq_licitacao, a.nr_seq_lic_item),'S') = 'N' 
order by a.nr_seq_lic_item;

C04 CURSOR FOR 
SELECT	a.nr_seq_lic_item 
from	reg_lic_item a 
where	a.nr_seq_licitacao = nr_seq_licitacao_p 
and	coalesce(a.nr_seq_lote::text, '') = '' 
and 	coalesce(lic_obter_se_deserto_frustrado(a.nr_seq_licitacao, a.nr_seq_lic_item),'S') = 'D' 
order by a.nr_seq_lic_item;

C05 CURSOR FOR 
SELECT	a.nr_seq_lic_item 
from	reg_lic_item a 
where	a.nr_seq_licitacao = nr_seq_licitacao_p 
and	coalesce(a.nr_seq_lote::text, '') = '' 
and 	coalesce(lic_obter_se_deserto_frustrado(a.nr_seq_licitacao, a.nr_seq_lic_item),'S') = 'F' 
order by a.nr_seq_lic_item;

C06 CURSOR FOR 
SELECT	a.nr_seq_fornec, 
	sum(a.vl_item), 
	sum(b.qt_item) 
from	reg_lic_fornec_lance a, 
	reg_lic_item b 
where	a.nr_seq_licitacao = nr_seq_licitacao_p 
and	b.nr_seq_licitacao = a.nr_seq_licitacao 
and	a.nr_seq_lic_item = b.nr_seq_lic_item 
and	lic_obter_situacao_fornec(nr_seq_fornec) <> 'I' 
group by a.nr_seq_fornec;


BEGIN 
 
select	substr(lic_obter_desc_modalidade(a.nr_seq_mod_compra),1,255), 
	substr(a.ds_objeto,1,4000), 
	substr(substr(lic_obter_nr_controle_edital(nr_sequencia),1,position('/' in lic_obter_nr_controle_edital(nr_sequencia)) +4),1,255) 
into STRICT	ds_modalidade_w, 
	ds_objeto_w, 
	ds_controle_edital_w 
from	reg_licitacao a 
where	nr_sequencia = nr_seq_licitacao_p;
 
begin 
select	substr(obter_nome_pf_pj(cd_pessoa_fisica, null),1,255), 
	substr(obter_desc_tipo_envolvido(nr_seq_tipo_envolvido),1,255) 
into STRICT	nm_pessoa_w, 
	ds_tipo_envolvido_w 
from	reg_lic_envolvido 
where	nr_seq_licitacao = nr_seq_licitacao_p;
exception 
when others then 
	nm_pessoa_w := null;
	ds_tipo_envolvido_w := null;
end;
 
-- Concatena a descrição de todos os itens da licitação que não são Desqualificados, Desertos ou frustrados; 
open C01;
loop 
fetch C01 into	 
	nr_seq_lic_item_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin 
						/*Item*/
 
	ds_itens_w := ds_itens_w || '\b ' || wheb_mensagem_pck.get_Texto(312246) || ' ' || nr_seq_lic_item_w || ' - \b0 ';
	 
	open C02;
	loop 
	fetch C02 into 
		nr_posicao_w, 
		ds_fornec_w, 
		vl_item_w;
	EXIT WHEN NOT FOUND; /* apply on C02 */
		begin 
		-- verificar o campo valor 
		ds_itens_w := ds_itens_w || nr_posicao_w || 'º : ' || ds_fornec_w || ': R$ ' || campo_mascara_virgula_casas(vl_item_w,4) || '; ';
		end;
	end loop;
	close C02;
	end;
end loop;
close C01;
 
-- Traz somente o número dos itens Desqualificados; 
open C03;
loop 
fetch C03 into	 
	nr_seq_lic_item_w;
EXIT WHEN NOT FOUND; /* apply on C03 */
	begin 
	ds_itens_desqualificados_w := ds_itens_desqualificados_w || nr_seq_lic_item_w || ', ';
	end;
end loop;
close C03;
 
-- Traz somente o número dos itens Desertos; 
open C04;
loop 
fetch C04 into	 
	nr_seq_lic_item_w;
EXIT WHEN NOT FOUND; /* apply on C04 */
	begin 
	ds_itens_desertos_w := ds_itens_desertos_w || nr_seq_lic_item_w || ', ';
	end;
end loop;
close C04;
 
-- Traz somente o número dos itens Frustrados; 
open C05;
loop 
fetch C05 into	 
	nr_seq_lic_item_w;
EXIT WHEN NOT FOUND; /* apply on C05 */
	begin 
	ds_itens_frustrados_w := ds_itens_frustrados_w || nr_seq_lic_item_w || ', ';
	end;
end loop;
close C05;
 
-- Traz o valor total de todos os itens por fornecedor 
open C06;
loop 
fetch C06 into	 
	nr_seq_fornec_w, 
	vl_item_w, 
	qt_item_w;
EXIT WHEN NOT FOUND; /* apply on C06 */
	begin 
	ds_empresas_habilitadas_w := 
		ds_empresas_habilitadas_w || substr(obter_fornec_reg_lic_fornec(nr_seq_fornec_w),1,255) || ': R$ ' || (vl_item_w * qt_item_w) || '; ';
		 
	vl_total_w := vl_total_w + (vl_item_w * qt_item_w);
	end;
end loop;
close C06;
 
-- Tratada a formatação dos campos para que fiquem de acordo com o requisitado no relatório 
if (ds_itens_desqualificados_w IS NOT NULL AND ds_itens_desqualificados_w::text <> '') then 
	begin 
	ds_itens_desqualificados_w := substr(ds_itens_desqualificados_w,1, (length(ds_itens_desqualificados_w) -2)) || '.';
	lb_itens_desqualificados_w := ' ' || wheb_mensagem_pck.get_Texto(312247) || ': ';
						/*Itens Desqualificados*/
 
	end;
end if;
 
if (ds_itens_desertos_w IS NOT NULL AND ds_itens_desertos_w::text <> '') then 
	begin 
	ds_itens_desertos_w := substr(ds_itens_desertos_w,1, (length(ds_itens_desertos_w) -2)) || '.';
	lb_itens_desertos_w := ' ' || wheb_mensagem_pck.get_Texto(312248) || ': ';
					/*Itens Desertos*/
 
	end;
end if;
 
if (ds_itens_frustrados_w IS NOT NULL AND ds_itens_frustrados_w::text <> '') then 
	begin 
	ds_itens_frustrados_w := substr(ds_itens_frustrados_w,1, (length(ds_itens_frustrados_w) -2)) || '.';
	lb_itens_frustrados_w := ' ' || wheb_mensagem_pck.get_Texto(312249) || ': ';
					/*Itens Frustrados*/
 
	end;
end if;
 
if (ds_empresas_habilitadas_w IS NOT NULL AND ds_empresas_habilitadas_w::text <> '') then 
	begin 
	ds_empresas_habilitadas_w := substr(ds_empresas_habilitadas_w,1, (length(ds_empresas_habilitadas_w) -2)) || '.';
	lb_empresas_habilitadas_w := ' ' || wheb_mensagem_pck.get_Texto(312250) || ': ';
						/*Empresas Habilitadas*/
 
	end;
end if;
 
if (vl_total_w > 0) then 
	begin 
	lb_valor_total_w := ' ' || wheb_mensagem_pck.get_Texto(312252); /*Valor total Registrado: R$*/
	end;
end if;
 
if (ds_modalidade_w IS NOT NULL AND ds_modalidade_w::text <> '') then 
	begin 
	ds_modalidade_w := ' (' || ds_modalidade_w || ') ';
	end;
end if;
 
if (nm_pessoa_w IS NOT NULL AND nm_pessoa_w::text <> '') then 
	begin 
	nm_pessoa_w := nm_pessoa_w || '. ';
	end;
end if;
 
if (ds_tipo_envolvido_w IS NOT NULL AND ds_tipo_envolvido_w::text <> '') then 
	begin 
	ds_tipo_envolvido_w := '(' || ds_tipo_envolvido_w || ').';
	end;
end if;
 
delete from w_resultado_licitacao 
where nm_usuario = nm_usuario_p;
 
insert into w_resultado_licitacao( 
	nr_seq_licitacao, 
	ds_itens, 
	ds_itens_desqualificados, 
	ds_itens_desertos, 
	ds_itens_frustrados, 
	ds_empresas_habilitadas, 
	vl_total, 
	ds_modalidade, 
	ds_objeto, 
	ds_controle_edital, 
	nm_pessoa, 
	ds_tipo_envolvido, 
	lb_itens_desqualificados, 
	lb_itens_desertos, 
	lb_itens_frustrados, 
	lb_empresas_habilitadas, 
	lb_valor_total, 
	nm_usuario) 
values (	nr_seq_licitacao_p, 
	ds_itens_w, 
	ds_itens_desqualificados_w, 
	ds_itens_desertos_w, 
	ds_itens_frustrados_w, 
	ds_empresas_habilitadas_w, 
	vl_total_w, 
	ds_modalidade_w, 
	ds_objeto_w, 
	ds_controle_edital_w, 
	nm_pessoa_w, 
	ds_tipo_envolvido_w, 
	lb_itens_desqualificados_w, 
	lb_itens_desertos_w, 
	lb_itens_frustrados_w, 
	lb_empresas_habilitadas_w, 
	lb_valor_total_w, 
	nm_usuario_p);
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_desc_itens_result_lic ( nr_seq_licitacao_p bigint, nm_usuario_p text) FROM PUBLIC;

