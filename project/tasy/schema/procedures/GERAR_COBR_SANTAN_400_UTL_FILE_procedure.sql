-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_cobr_santan_400_utl_file (nr_seq_cobr_escrit_p bigint, cd_estabelecimento_p text, nm_usuario_p text) AS $body$
DECLARE

 
ds_conteudo_w			varchar(400);
ds_zeros_16_w			varchar(16);
ds_mensagem_275_w		varchar(275);
nr_seq_reg_arq_w		integer := 0;
nm_empresa_w			varchar(30);
nm_banco_w			varchar(15);
dt_geracao_w			varchar(6);
cd_banco_san_w			varchar(3);
cd_transmissao_w		varchar(20);
ds_zeros_374_w			varchar(374);
ds_brancos_6_w			varchar(6);
ds_brancos_4_w			varchar(4);
cd_cgc_w			varchar(14);
cd_agencia_ced_w		varchar(4);
cd_conta_movto_w		varchar(8);
cd_conta_cobr_w			varchar(8);
nr_controle_w			varchar(25);
nr_nosso_numero_w		varchar(8);
dt_seg_desconto_w		varchar(6);
ie_multa_w			varchar(1);
pr_multa_w			varchar(4);
vl_moeda_w			varchar(2);
vl_tit_unidade_w		varchar(13);
dt_cobr_multa_w			varchar(6);
cd_carteira_w			varchar(1);
cd_ocorrencia_w			varchar(2);
nr_seu_numero_w			varchar(10);
dt_vencimento_w			varchar(6);
ds_vl_titulo_w			varchar(13);
vl_titulo_w			double precision;
cd_banco_w			varchar(3);
cd_agencia_w			varchar(5);
ie_documento_w			varchar(2);
ie_aceite_w			varchar(1);
dt_emissao_w			varchar(6);
ie_primeira_instr_w		varchar(2);
ie_segunda_intr_w		varchar(2);
vl_juros_diario_w		varchar(13);
dt_desconto_w			varchar(6);
vl_desconto_dia_w		varchar(13);
vl_iof_w			varchar(13);
vl_abatimento_w			varchar(13);
ie_tipo_inscricao_w		varchar(2);
nr_inscricao_w			varchar(14);
nm_sacado_w			varchar(40);
ds_endereco_sacado_w		varchar(40);
ds_bairro_sacado_w		varchar(12);
cd_cep_sacado_w			varchar(8);
ds_municipio_sacado_w		varchar(15);
ds_estado_sacado_w		varchar(2);
nm_sacador_w			varchar(30);
ie_complemento_w		varchar(1);
ds_complemento_w		varchar(2);
nr_dias_baixa_w			varchar(2);
vl_total_w			double precision := 0;
nr_sequencia_w			bigint;
qt_registro_w			integer :=0;

 
/*UTL File*/
 
arq_texto_w			utl_file.file_type;
ds_erro_w			varchar(255);
ds_local_w			varchar(255);
nm_arquivo_w			varchar(255);
ds_mensagem_w			varchar(255);

nm_beneficiario_w		varchar(255);
cd_usuario_plano_w		varchar(255);
cd_identificacao_w		varchar(255);
tx_reajuste_w			varchar(255);
ds_oficio_w			varchar(255);
vl_mensalidade_w		varchar(255);
ds_reajuste_w			varchar(255);
vl_reajuste_w			varchar(255);
ds_plano_w			varchar(255);
dt_prox_reaj_w			varchar(255);
ds_mensagem_ww			varchar(255);
cd_ans_w			varchar(255);
ds_juros_multa_w		varchar(255);
ds_cgc_w			varchar(255);
nr_titulo_w			bigint;

 
C01 CURSOR FOR 
	SELECT	lpad(coalesce(to_char(c.cd_agencia_bancaria),'0'),4,'0') cd_agencia, 
		lpad(substr(coalesce(d.cd_conta,coalesce(pls_obter_dados_pagador_fin(d.nr_seq_pagador,'C'),'0')),1,8),8,'0') cd_conta_movto, 
		lpad(substr(coalesce(x.cd_conta,'0'),1,8),8,'0') cd_conta_cobr, 
		lpad('0',25,'0') nr_controle, 
		lpad(coalesce(substr(obter_nosso_numero_interf(x.cd_banco,b.nr_titulo),1,8),'0'),8,'0') nr_nosso_numero, 
		'000000' dt_seg_desconto, 
		'0' ie_multa, 
		'0000' pr_multa, 
		'00' vl_moeda, 
		replace(to_char('0', 'fm00000000000.00'),'.','') vl_tit_unidade,--replace(to_char(b.vl_titulo, 'fm00000000000.00'),'.','') vl_tit_unidade, 
		'000000' dt_cobr_multa, 
		'1' cd_carteira, 
		'01' cd_ocorrencia, 
		rpad(coalesce(substr(b.nr_titulo,1,10),'0'),10,'0') nr_seu_numero, 
		to_char(coalesce(b.dt_pagamento_previsto, b.dt_vencimento),'ddmmyy') dt_vencimento, 
		coalesce(b.vl_titulo,0) vl_titulo, 
		lpad(coalesce(substr(x.cd_banco,1,3),'0'),3,'0') cd_banco, 
		lpad(coalesce(to_char('0'),'0'),5,'0') cd_agencia,--lpad(nvl(to_char(c.cd_agencia_bancaria),'0'),5,'0') cd_agencia, 
		'01' ie_documento, 
		'N' ie_aceite, 
		lpad(coalesce(to_char(b.dt_emissao,'ddmmyy'),' '),6,' ') dt_emissao, 
		'00' ie_primeira_instr, 
		'00' ie_segunda_intr, 
		lpad(replace(to_char(coalesce(obter_vl_juros_diario_tit(null,b.nr_titulo),0),'fm00000000000.00'),'.',''),13,'0') vl_juros_diario, 
		to_char(clock_timestamp(),'ddmmyy') dt_desconto, 
		lpad('0',13,'0') vl_desconto_dia, 
		lpad('0',13,'0') vl_iof, 
		lpad('0',13,'0') vl_abatimento, 
		CASE WHEN coalesce(b.cd_cgc::text, '') = '' THEN '01'  ELSE '02' END  ie_tipo_inscricao, 
		lpad(coalesce(b.cd_cgc_cpf,'0'),14,'0') nr_inscricao, 
		rpad(upper(elimina_acentuacao(substr(coalesce(b.nm_pessoa,' '),1,40))),40,' ') nm_sacado, 
		rpad(coalesce(substr(CASE WHEN coalesce(d.nr_sequencia::text, '') = '' THEN  			obter_dados_pf_pj(b.cd_pessoa_fisica, b.cd_cgc, 'E')  ELSE pls_obter_compl_pagador(d.nr_seq_pagador,'E') END ,1,40), 
			substr(coalesce(obter_dados_pf_pj(b.cd_pessoa_fisica, b.cd_cgc, 'E'),' '),1,40)),40,' ') ds_endereco_sacado, 
		rpad(coalesce(substr(CASE WHEN coalesce(d.nr_sequencia::text, '') = '' THEN  			obter_dados_pf_pj(b.cd_pessoa_fisica, b.cd_cgc, 'B')  ELSE pls_obter_compl_pagador(d.nr_seq_pagador,'B') END ,1,12), 
			substr(coalesce(obter_dados_pf_pj(b.cd_pessoa_fisica, b.cd_cgc, 'B'),' '),1,12)),12,' ') ds_bairro_sacado, 
		lpad(coalesce(substr(CASE WHEN coalesce(d.nr_sequencia::text, '') = '' THEN  			obter_dados_pf_pj(b.cd_pessoa_fisica, b.cd_cgc, 'CEP')  ELSE pls_obter_compl_pagador(d.nr_seq_pagador,'CEP') END ,1,8), 
			substr(coalesce(obter_dados_pf_pj(b.cd_pessoa_fisica, b.cd_cgc, 'CEP'),'0'),1,8)),8,'0') cd_cep_sacado, 
		rpad(coalesce(substr(CASE WHEN coalesce(d.nr_sequencia::text, '') = '' THEN  			obter_dados_pf_pj(b.cd_pessoa_fisica, b.cd_cgc, 'CI')  ELSE pls_obter_compl_pagador(d.nr_seq_pagador,'CI') END ,1,15), 
			substr(obter_dados_pf_pj(b.cd_pessoa_fisica, b.cd_cgc, 'CI'),1,15)),15,' ') ds_municipio_sacado, 
		rpad(coalesce(substr(CASE WHEN coalesce(d.nr_sequencia::text, '') = '' THEN  			obter_dados_pf_pj(b.cd_pessoa_fisica, b.cd_cgc, 'UF')  ELSE pls_obter_compl_pagador(d.nr_seq_pagador,'UF') END ,1,2), 
			substr(coalesce(obter_dados_pf_pj(b.cd_pessoa_fisica, b.cd_cgc, 'UF'),' '),1,2)),2,' ') ds_estado_sacado, 
		lpad(' ',30,' ') nm_sacador, 
		'I' ie_complemento, 
		'38' ds_complemento, 
		'00' nr_dias_baixa, 
		c.nr_titulo 
	FROM banco_estabelecimento x, titulo_receber_cobr c, cobranca_escritural a, titulo_receber_v b
LEFT OUTER JOIN pls_mensalidade d ON (b.nr_seq_mensalidade = d.nr_sequencia)
LEFT OUTER JOIN banco_carteira e ON (b.nr_seq_carteira_cobr = e.nr_sequencia)
LEFT OUTER JOIN pls_contrato_pagador f ON (d.nr_seq_pagador = f.nr_sequencia)
WHERE a.nr_sequencia		= c.nr_seq_cobranca and c.nr_titulo		= b.nr_titulo and a.nr_seq_conta_banco	= x.nr_sequencia    and a.nr_sequencia		= nr_seq_cobr_escrit_p;			
 
/* Reajuste */
 
C02 CURSOR FOR 
	SELECT	rpad('CÓDIGO ANS: ' || g.nr_protocolo_ans, 255, ' ') cd_ans, 
		rpad('BENEFICIÁRIO: ' || upper(substr(pls_obter_dados_segurado(b.nr_seq_segurado,'N'),1,255)),255,' ') nm_beneficiario, 
		rpad('CÓDIGO: ' || substr(pls_obter_dados_segurado(b.nr_seq_segurado,'C'),1,255),255, ' ') cd_usuario_plano, 
		rpad('CÓDIGO DE IDENTIFICAÇÃO/ SCPA/ ANS: ' || CASE WHEN g.ie_regulamentacao='R' THEN  g.nr_protocolo_ans  ELSE g.cd_scpa END ,255,' ') cd_identificacao, 
		rpad('PERCENTUAL DE REAJUSTE: ' || campo_mascara_virgula_casas(f.tx_reajuste, 2) || '%',255,' ') tx_reajuste, 
		rpad('OFÍCIO: ' || coalesce(f.ds_oficio_ans,' '),255,' ') ds_oficio, 
		rpad('PROXIMO REAJUSTE FINANCEIRO DE ACORDO COM O MES DE AQUISIÇÃO DO CONTRATO: ' || to_char(add_months(f.dt_reajuste, 12), 'mm/yyyy'),255,' ') dt_prox_reaj, 
		rpad('MENSALIDADE...............................................................: ' || 
			campo_mascara_virgula_casas(b.vl_mensalidade, 2),255, ' ') vl_mensalidade, 
		rpad(substr('REAJUSTE' || CASE WHEN e.ie_tipo_item=4 THEN  ' RETROATIVO'  ELSE '' END  || 
			'...............................................................: ',1,255) || 
			campo_mascara_virgula_casas(CASE WHEN ie_tipo_item='25' THEN (SELECT	x.vl_item 							from	pls_mensalidade_seg_item	x 							where	b.nr_sequencia	= x.nr_seq_mensalidade_seg 							and	x.ie_tipo_item	= 1) * ((substr(pls_obter_dados_lote_reajuste(e.nr_seq_reajuste,'P'),1,20))::numeric  / 100)  ELSE e.vl_item END , 2),255,' ') vl_reajuste, 
		rpad('PLANO ' || upper(substr(pls_obter_dados_produto(b.nr_seq_plano,'N'),1,44)),255,' ') ds_plano, 
		rpad('**Após o vencimento cobrar multa ' || a.tx_multa || '%, mora dia ' || a.tx_juros || '%', 255, ' ') ds_juros_multa 
	FROM pls_plano g, pls_reajuste f, pls_mensalidade_seg_item e, titulo_receber d, pls_mensalidade_segurado b, titulo_receber a
LEFT OUTER JOIN pls_mensalidade c ON (a.nr_seq_mensalidade = c.nr_sequencia)
WHERE a.nr_titulo			= nr_titulo_w and b.nr_seq_mensalidade		= c.nr_sequencia  and d.nr_titulo			= a.nr_titulo and e.nr_seq_mensalidade_seg	= b.nr_sequencia and ((e.ie_tipo_item 		= 4) or (e.ie_tipo_item 		= 25)) and b.nr_seq_plano			= g.nr_sequencia and f.dt_reajuste			= b.dt_mesano_referencia   LIMIT 1;

/* Beneficiário - Carteira */
	 
C03 CURSOR FOR 
	SELECT	rpad('BENEFICIÁRIO: ' || upper(substr(pls_obter_dados_segurado(b.nr_seq_segurado,'N'),1,36)),255,' ') nm_beneficiario, 
		rpad('CÓDIGO: ' || substr(pls_obter_dados_segurado(b.nr_seq_segurado,'C'),1,42),255,' ') cd_usuario_plano, 
		rpad('CÓDIGO DE IDENTIFICAÇÃO/ SCPA/ ANS: ' || g.nr_protocolo_ans,255,' ') cd_identificacao, 
		rpad(substr(CASE WHEN b.nr_seq_plano=98 THEN  'VALOR DA MENSALIDADE REAJUSTADO EM 20%, POR MUDANÇA DE FAIXA ETÁRIA, CONFORME 3ª CLÁUSULA DO CONTRATO.' WHEN b.nr_seq_plano=7 THEN  'VALOR DA MENSALIDADE REAJUSTADO POR MUDANÇA DE FAIXA ETÁRIA, CONFORME CAPÍTULO XI - 16ª CLÁUSULA DO CONTRATO.' WHEN b.nr_seq_plano=5 THEN  'VALOR DA MENSALIDADE REAJUSTADO POR MUDANÇA DE FAIXA ETÁRIA, CONFORME PREVISTO EM CONTRATO.' END ,1,255),255,' ') ds_mensagem, 
		rpad('PLANO ' || upper(substr(pls_obter_dados_produto(b.nr_seq_plano,'N'),1,44)),255,' ') ds_plano 
	FROM pls_plano g, pls_mensalidade_seg_item e, titulo_receber d, pls_mensalidade_segurado b, titulo_receber a
LEFT OUTER JOIN pls_mensalidade c ON (a.nr_seq_mensalidade = c.nr_sequencia)
WHERE a.nr_titulo			= nr_titulo_w and b.nr_seq_mensalidade		= c.nr_sequencia  and d.nr_titulo			= a.nr_titulo and e.nr_seq_mensalidade_seg	= b.nr_sequencia and b.nr_seq_plano			= g.nr_sequencia and e.ie_tipo_item 			= 5;
	--and	((b.nr_seq_plano = 98) or (b.nr_seq_plano = 7) or (b.nr_seq_plano = 5)); 
	
C04 CURSOR FOR 
	SELECT	rpad('CÓDIGO ANS: ' || g.nr_protocolo_ans, 255, ' ') cd_ans, 
		rpad('BENEFICIÁRIO: ' || upper(substr(pls_obter_dados_segurado(b.nr_seq_segurado,'N'),1,36)),255,' ') nm_beneficiario, 
		rpad('CÓDIGO: ' || substr(pls_obter_dados_segurado(b.nr_seq_segurado,'C'),1,42),255,' ') cd_usuario_plano, 
		rpad('CÓDIGO DE IDENTIFICAÇÃO/ SCPA/ ANS: ' || g.nr_protocolo_ans,255,' ') cd_identificacao, 
		rpad('MÊS REFERÊNCIA: ' || to_char(c.dt_referencia, 'mm/yyyy'),255,' ') dt_referencia, 
		rpad('PLANO: ' || substr(g.ds_plano, 1, 255), 255, ' ') ds_plano, 
		rpad('**Após o vencimento cobrar multa ' || a.tx_multa || '%, mora dia ' || a.tx_juros || '%', 255, ' ') ds_juros_multa 
	FROM pls_plano g, pls_mensalidade_segurado b, titulo_receber a
LEFT OUTER JOIN pls_mensalidade c ON (a.nr_seq_mensalidade = c.nr_sequencia)
WHERE a.nr_titulo		= nr_titulo_w and b.nr_seq_mensalidade	= c.nr_sequencia  and b.nr_seq_plano		= g.nr_sequencia;


BEGIN 
nm_arquivo_w	:= to_char(clock_timestamp(),'ddmmyyyy') || to_char(clock_timestamp(),'hh24') || to_char(clock_timestamp(),'mi') || to_char(clock_timestamp(),'ss') || nm_usuario_p || '.rem';
 
SELECT * FROM obter_evento_utl_file(1, null, ds_local_w, ds_erro_w) INTO STRICT ds_local_w, ds_erro_w;
 
begin 
arq_texto_w := utl_file.fopen(ds_local_w,nm_arquivo_w,'W'); --arq_texto_w := utl_file.fopen('/srvfs03/FINANCEIRO/TASY/',nm_arquivo_w,'W'); 
exception
when others then 
	if (SQLSTATE = -29289) then 
		ds_erro_w := 'O acesso ao arquivo foi negado pelo sistema operacional (access_denied).';
	elsif (SQLSTATE = -29298) then 
		ds_erro_w := 'O arquivo foi aberto usando FOPEN_NCHAR, mas efetuaram-se operações de I/O usando funções nonchar comos PUTF ou GET_LINE (charsetmismatch).';
	elsif (SQLSTATE = -29291) then 
		ds_erro_w := 'Não foi possível apagar o arquivo (delete_failed).';
	elsif (SQLSTATE = -29286) then 
		ds_erro_w := 'Erro interno desconhecido no package UTL_FILE (internal_error).';
	elsif (SQLSTATE = -29282) then 
		ds_erro_w := 'O handle do arquivo não existe (invalid_filehandle).';
	elsif (SQLSTATE = -29288) then 
		ds_erro_w := 'O arquivo com o nome especificado não foi encontrado neste local (invalid_filename).';
	elsif (SQLSTATE = -29287) then 
		ds_erro_w := 'O valor de MAX_LINESIZE para FOPEN() é inválido; deveria estar na faixa de 1 a 32767 (invalid_maxlinesize).';
	elsif (SQLSTATE = -29281) then 
		ds_erro_w := 'O parâmetro open_mode na chamda FOPEN é inválido (invalid_mode).';
	elsif (SQLSTATE = -29290) then 
		ds_erro_w := 'O parâmetro ABSOLUTE_OFFSET para a chamada FSEEK() é inválido; deveria ser maior do que 0 e menor do que o número total de bytes do arquivo (invalid_offset).';
	elsif (SQLSTATE = -29283) then 
		ds_erro_w := 'O arquivo não pôde ser aberto ou operado da forma desejada - ou o caminho não foi encontrado (invalid_operation).';
	elsif (SQLSTATE = -29280) then 
		ds_erro_w := 'O caminho especificado não existe ou não está visível ao Oracle (invalid_path).';
	elsif (SQLSTATE = -29284) then 
		ds_erro_w := 'Não é possível efetuar a leitura do arquivo (read_error).';
	elsif (SQLSTATE = -29292) then 
		ds_erro_w := 'Não é possível renomear o arquivo.';
	elsif (SQLSTATE = -29285) then 
		ds_erro_w := 'Não foi possível gravar no arquivo (write_error).';
	else 
		ds_erro_w := 'Erro desconhecido no package UTL_FILE.';
	end if;	
	CALL wheb_mensagem_pck.exibir_mensagem_abort(186768,'DS_ERRO_W=' || ds_erro_w);
end;
--arq_texto_w := utl_file.fopen('/oraprd03/utlfile/',nm_arquivo_w,'W'); 
--\\192.168.0.230\UTLFILE 
 
update	cobranca_escritural 
set	ds_arquivo	= ds_local_w || nm_arquivo_w 
where	nr_sequencia	= nr_seq_cobr_escrit_p;
	 
 
select	rpad('0',16,'0'), 
	rpad(' ',275,' '), 
	rpad('0',374,'0'), 
	rpad(' ',6,' '), 
	rpad(' ',4,' ') 
into STRICT	ds_zeros_16_w, 
	ds_mensagem_275_w, 
	ds_zeros_374_w, 
	ds_brancos_6_w, 
	ds_brancos_4_w
;
 
 
/* Header */
 
select	rpad(substr(obter_nome_pf_pj(null,b.cd_cgc),1,30),30,' ') nm_empresa, 
	rpad(substr(upper(obter_nome_banco(c.cd_banco)),1,15),15,' ') nm_banco, 
	to_char(clock_timestamp(), 'ddmmyy') dt_geracao, 
	lpad(substr(c.cd_banco,1,3),3,'0') cd_banco, 
	lpad(coalesce(substr(c.cd_transmissao,1,20),'0'),20,'0') cd_transmissao, 
	lpad(substr(b.cd_cgc,1,14),14,'0') cd_cgc 
into STRICT	nm_empresa_w, 
	nm_banco_w, 
	dt_geracao_w, 
	cd_banco_san_w, 
	cd_transmissao_w, 
	cd_cgc_w 
FROM banco_estabelecimento c, estabelecimento b, cobranca_escritural a
LEFT OUTER JOIN banco_carteira d ON (a.nr_seq_carteira_cobr = d.nr_sequencia)
WHERE a.cd_estabelecimento	= b.cd_estabelecimento and a.nr_seq_conta_banco	= c.nr_sequencia  and a.nr_sequencia		= nr_seq_cobr_escrit_p;
 
nr_seq_reg_arq_w := nr_seq_reg_arq_w + 1;
qt_registro_w := qt_registro_w + 1;
	 
 
ds_conteudo_w	:=	'01REMESSA01COBRANÇA    '	|| 
			cd_transmissao_w		|| 
			nm_empresa_w 			|| 
			cd_banco_san_w 			|| 
			nm_banco_w			|| 
			dt_geracao_w			|| 
			ds_zeros_16_w			|| 
			ds_mensagem_275_w		|| 
			'000'				|| 
			lpad(nr_seq_reg_arq_w,6,'0');
 
utl_file.put_line(arq_texto_w,ds_conteudo_w);
utl_file.fflush(arq_texto_w);			
			 
 
/* Fim Header */
 
 
/* Registro */
 
open C01;
loop 
fetch C01 into	 
	cd_agencia_ced_w, 
	cd_conta_movto_w, 
	cd_conta_cobr_w, 
	nr_controle_w, 
	nr_nosso_numero_w, 
	dt_seg_desconto_w, 
	ie_multa_w, 
	pr_multa_w, 
	vl_moeda_w, 
	vl_tit_unidade_w, 
	dt_cobr_multa_w, 
	cd_carteira_w, 
	cd_ocorrencia_w, 
	nr_seu_numero_w, 
	dt_vencimento_w, 
	vl_titulo_w,	 
	cd_banco_w, 
	cd_agencia_w, 
	ie_documento_w, 
	ie_aceite_w, 
	dt_emissao_w, 
	ie_primeira_instr_w, 
	ie_segunda_intr_w, 
	vl_juros_diario_w, 
	dt_desconto_w, 
	vl_desconto_dia_w, 
	vl_iof_w, 
	vl_abatimento_w, 
	ie_tipo_inscricao_w, 
	nr_inscricao_w, 
	nm_sacado_w, 
	ds_endereco_sacado_w, 
	ds_bairro_sacado_w, 
	cd_cep_sacado_w, 
	ds_municipio_sacado_w, 
	ds_estado_sacado_w, 
	nm_sacador_w, 
	ie_complemento_w, 
	ds_complemento_w, 
	nr_dias_baixa_w, 
	nr_titulo_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin 
	nr_seq_reg_arq_w := nr_seq_reg_arq_w + 1;
 
	ds_vl_titulo_w	:= lpad(replace(to_char(vl_titulo_w,'fm00000000000.00'),'.',''),13,'0');
	 
	ds_conteudo_w	:=	'102' 			|| --3 
				cd_cgc_w		|| --14 
				cd_transmissao_w	|| --20 
				nr_controle_w		|| --25 
				nr_nosso_numero_w	|| --8 
				dt_seg_desconto_w	|| --6 
				' '			|| --1 
				ie_multa_w		|| --1 
				pr_multa_w		|| --4 
				vl_moeda_w		|| --2 
				vl_tit_unidade_w	|| --13 
				ds_brancos_4_w		|| --4 
				dt_cobr_multa_w		|| --6 
				cd_carteira_w		|| --1 
				cd_ocorrencia_w		|| --1 
				nr_seu_numero_w		|| --10 
				dt_vencimento_w		|| --6 
				ds_vl_titulo_w		|| --13 
				cd_banco_w		|| --3 
				cd_agencia_w		|| --5 
				ie_documento_w		|| --2 
				ie_aceite_w		|| --1 
				dt_emissao_w		|| --6 
				ie_primeira_instr_w	|| --2 
				ie_segunda_intr_w	|| --2 
				vl_juros_diario_w	|| --13 
				dt_desconto_w		|| --6 
				vl_desconto_dia_w	|| --13 
				vl_iof_w		|| --13 
				vl_abatimento_w		|| --13 
				ie_tipo_inscricao_w	|| --2 
				nr_inscricao_w		|| --14 
				nm_sacado_w		|| --40 
				ds_endereco_sacado_w	|| --40 
				ds_bairro_sacado_w	|| --12 
				cd_cep_sacado_w		|| --8 
				ds_municipio_sacado_w	|| --15 
				ds_estado_sacado_w	|| --2 
				nm_sacador_w		|| --30 
				' '			|| --1 
				ie_complemento_w	|| --1 
				ds_complemento_w	|| --2 
				ds_brancos_6_w		|| --6 
				nr_dias_baixa_w		|| --2 
				' '			|| --1 
				lpad(nr_seq_reg_arq_w,6,'0'); --6 
	
	utl_file.put_line(arq_texto_w, ds_conteudo_w);
	utl_file.fflush(arq_texto_w);	
	 
	vl_total_w := vl_total_w + vl_titulo_w;
	qt_registro_w := qt_registro_w + 1;
	 
	/*nr_seq_reg_arq_w := nr_seq_reg_arq_w + 1; 
		 
	ds_conteudo_w	:= '2' || lpad(' ', 48, ' ') || rpad(substr(nvl(replace(replace(Obter_Instrucao_Titulo_Receber(nr_titulo_w),chr(13),''),chr(10),''),' '),1,255),255,' ') || lpad(' ', 90, ' ') || 
				lpad(nr_seq_reg_arq_w,6,'0'); 
	 
	utl_file.put_line(arq_texto_w, ds_conteudo_w); 
	utl_file.fflush(arq_texto_w);*/
 
	 
	ds_cgc_w := rpad('CNPJ: ' || substr(pls_obter_dados_outorgante(cd_estabelecimento_p, 'C'),1, 255), 255, ' ');
	 
	open C04;
	loop 
	fetch C04 into 
		cd_ans_w, 
		nm_beneficiario_w, 
		cd_usuario_plano_w, 
		cd_identificacao_w, 
		ds_mensagem_ww, 
		ds_plano_w, 
		ds_juros_multa_w;
	EXIT WHEN NOT FOUND; /* apply on C04 */
		begin		 
		nr_seq_reg_arq_w := nr_seq_reg_arq_w + 1;
		 
		/* ANS: */
 
		ds_conteudo_w	:= '2' || lpad(' ', 48, ' ') || cd_ans_w || lpad(' ', 90, ' ') || lpad(nr_seq_reg_arq_w,6,'0');
		 
		utl_file.put_line(arq_texto_w, ds_conteudo_w);
		utl_file.fflush(arq_texto_w);
		 
		/* CNPJ: */
 
		ds_conteudo_w	:= '2' || lpad(' ', 48, ' ') || ds_cgc_w || lpad(' ', 90, ' ') || lpad(nr_seq_reg_arq_w,6,'0');
		 
		utl_file.put_line(arq_texto_w, ds_conteudo_w);
		utl_file.fflush(arq_texto_w);
		 
		/* BENEFICIÁRIO: */
 
		ds_conteudo_w	:= '2' || lpad(' ', 48, ' ') || nm_beneficiario_w || lpad(' ', 90, ' ') || lpad(nr_seq_reg_arq_w,6,'0');
		 
		utl_file.put_line(arq_texto_w, ds_conteudo_w);
		utl_file.fflush(arq_texto_w);
		 
		nr_seq_reg_arq_w := nr_seq_reg_arq_w + 1;
		 
		/* CÓDIGO: */
		 
		ds_conteudo_w	:= '2' || lpad(' ', 48, ' ') || cd_usuario_plano_w || lpad(' ', 90, ' ') || lpad(nr_seq_reg_arq_w,6,'0');
		 
		utl_file.put_line(arq_texto_w, ds_conteudo_w);
		utl_file.fflush(arq_texto_w);
		 
		nr_seq_reg_arq_w := nr_seq_reg_arq_w + 1;
		 
		/* CÓDIGO DE IDENTIFICAÇÃO/ SCPA/ ANS: */
 
		ds_conteudo_w	:= '2' || lpad(' ', 48, ' ') || cd_identificacao_w || lpad(' ', 90, ' ') || lpad(nr_seq_reg_arq_w,6,'0');
		 
		utl_file.put_line(arq_texto_w, ds_conteudo_w);
		utl_file.fflush(arq_texto_w);
		 
		nr_seq_reg_arq_w := nr_seq_reg_arq_w + 1;
		 
		/* MÊS REFERÊNCIA: */
 
		ds_conteudo_w	:= '2' || lpad(' ', 48, ' ') || ds_mensagem_ww || lpad(' ', 90, ' ') || lpad(nr_seq_reg_arq_w,6,'0');
		 
		utl_file.put_line(arq_texto_w, ds_conteudo_w);
		utl_file.fflush(arq_texto_w);
		 
		nr_seq_reg_arq_w := nr_seq_reg_arq_w + 1;
		 
		/* PLANO: */
 
		ds_conteudo_w	:= '2' || lpad(' ', 48, ' ') || ds_plano_w || lpad(' ', 90, ' ') || lpad(nr_seq_reg_arq_w,6,'0');
		 
		utl_file.put_line(arq_texto_w, ds_conteudo_w);
		utl_file.fflush(arq_texto_w);
		 
		nr_seq_reg_arq_w := nr_seq_reg_arq_w + 1;
		 
		/* Mensagem 1 */
 
		ds_conteudo_w	:= '2' || lpad(' ', 48, ' ') || 'Prezado (a) Cliente,' || lpad(' ', 90, ' ') || lpad(nr_seq_reg_arq_w,6,'0');
		 
		utl_file.put_line(arq_texto_w, ds_conteudo_w);
		utl_file.fflush(arq_texto_w);
		 
		nr_seq_reg_arq_w := nr_seq_reg_arq_w + 1;
		 
		/* Mensagem 2 */
 
		ds_conteudo_w	:= '2' || lpad(' ', 48, ' ') || 'Caso não receba o seu boleto ate a próxima data de vencimento,' || lpad(' ', 90, ' ') || lpad(nr_seq_reg_arq_w,6,'0');
		 
		utl_file.put_line(arq_texto_w, ds_conteudo_w);
		utl_file.fflush(arq_texto_w);
		 
		nr_seq_reg_arq_w := nr_seq_reg_arq_w + 1;
		 
		/* Mensagem 3 */
 
		ds_conteudo_w	:= '2' || lpad(' ', 48, ' ') || 'Manter contato telefone (11) 3169-7000 ou EMAIL PLANOSDESAUDE@ADVANCEPLANOS.COM.BR' || lpad(' ', 90, ' ') || lpad(nr_seq_reg_arq_w,6,'0');
		 
		utl_file.put_line(arq_texto_w, ds_conteudo_w);
		utl_file.fflush(arq_texto_w);
		 
		nr_seq_reg_arq_w := nr_seq_reg_arq_w + 1;
		 
		/* Mensagem 4 */
 
		ds_conteudo_w	:= '2' || lpad(' ', 48, ' ') || ds_juros_multa_w || lpad(' ', 90, ' ') || lpad(nr_seq_reg_arq_w,6,'0');
		 
		utl_file.put_line(arq_texto_w, ds_conteudo_w);
		utl_file.fflush(arq_texto_w);
		 
		nr_seq_reg_arq_w := nr_seq_reg_arq_w + 1;
		 
		/* Mensagem 5 */
 
		ds_conteudo_w	:= '2' || lpad(' ', 48, ' ') || '**Conheça nosso site: www.advance.com.br**' || lpad(' ', 90, ' ') || lpad(nr_seq_reg_arq_w,6,'0');
		 
		utl_file.put_line(arq_texto_w, ds_conteudo_w);
		utl_file.fflush(arq_texto_w);
		 
		qt_registro_w	:= qt_registro_w + 1;
		end;
	end loop;
	close C04;
	 
	open C02;
	loop 
	fetch C02 into	 
		cd_ans_w, 
		nm_beneficiario_w, 
		cd_usuario_plano_w, 
		cd_identificacao_w, 
		tx_reajuste_w, 
		ds_oficio_w, 
		dt_prox_reaj_w, 
		vl_mensalidade_w, 
		vl_reajuste_w, 
		ds_plano_w, 
		ds_juros_multa_w;
	EXIT WHEN NOT FOUND; /* apply on C02 */
		begin 
		nr_seq_reg_arq_w := nr_seq_reg_arq_w + 1;
		 
		/* ANS: */
 
		ds_conteudo_w	:= '2' || lpad(' ', 48, ' ') || cd_ans_w || lpad(' ', 90, ' ') || lpad(nr_seq_reg_arq_w,6,'0');
		 
		utl_file.put_line(arq_texto_w, ds_conteudo_w);
		utl_file.fflush(arq_texto_w);
		 
		/* CNPJ: */
 
		ds_conteudo_w	:= '2' || lpad(' ', 48, ' ') || ds_cgc_w || lpad(' ', 90, ' ') || lpad(nr_seq_reg_arq_w,6,'0');
		 
		utl_file.put_line(arq_texto_w, ds_conteudo_w);
		utl_file.fflush(arq_texto_w);
		 
		nr_seq_reg_arq_w := nr_seq_reg_arq_w + 1;
		 
		/* BENEFICIÁRIO: */
 
		ds_conteudo_w	:= '2' || lpad(' ', 48, ' ') || nm_beneficiario_w || lpad(' ', 90, ' ') || lpad(nr_seq_reg_arq_w,6,'0');
		 
		utl_file.put_line(arq_texto_w, ds_conteudo_w);
		utl_file.fflush(arq_texto_w);
		 
		nr_seq_reg_arq_w := nr_seq_reg_arq_w + 1;
		 
		/* CÓDIGO: */
 
		ds_conteudo_w	:= '2' || lpad(' ', 48, ' ') || cd_usuario_plano_w || lpad(' ', 90, ' ') || lpad(nr_seq_reg_arq_w,6,'0');
		 
		utl_file.put_line(arq_texto_w, ds_conteudo_w);
		utl_file.fflush(arq_texto_w);
		 
		nr_seq_reg_arq_w := nr_seq_reg_arq_w + 1;
		 
		/* CÓDIGO DE IDENTIFICAÇÃO/ SCPA/ ANS: */
 
		ds_conteudo_w	:= '2' || lpad(' ', 48, ' ') || cd_identificacao_w || lpad(' ', 90, ' ') || lpad(nr_seq_reg_arq_w,6,'0');
		 
		utl_file.put_line(arq_texto_w, ds_conteudo_w);
		utl_file.fflush(arq_texto_w);
		 
		nr_seq_reg_arq_w := nr_seq_reg_arq_w + 1;
		 
		/* PERCENTUAL DE REAJUSTE: */
 
		ds_conteudo_w	:= '2' || lpad(' ', 48, ' ') || tx_reajuste_w || lpad(' ', 90, ' ') || lpad(nr_seq_reg_arq_w,6,'0');
		 
		utl_file.put_line(arq_texto_w, ds_conteudo_w);
		utl_file.fflush(arq_texto_w);
		 
		nr_seq_reg_arq_w := nr_seq_reg_arq_w + 1;
		 
		/* REAJUSTE ANUAL FINANCEIRO */
 
		ds_conteudo_w	:= '2' || lpad(' ', 48, ' ') || 'Conforme notificação oficial da ANS (Agência Nacional da Saúde) estamos aplicando o reajuste financeiro anual.' || lpad(' ', 90, ' ') || lpad(nr_seq_reg_arq_w,6,'0');
		 
		utl_file.put_line(arq_texto_w, ds_conteudo_w);
		utl_file.fflush(arq_texto_w);
		 
		nr_seq_reg_arq_w := nr_seq_reg_arq_w + 1;
		 
		/* OFÍCIO: */
 
		ds_conteudo_w	:= '2' || lpad(' ', 48, ' ') || ds_oficio_w || lpad(' ', 90, ' ') || lpad(nr_seq_reg_arq_w,6,'0');
		 
		utl_file.put_line(arq_texto_w, ds_conteudo_w);
		utl_file.fflush(arq_texto_w);
		 
		nr_seq_reg_arq_w := nr_seq_reg_arq_w + 1;
		 
		/* PROXIMO REAJUSTE FINANCEIRO DE ACORDO COM O MES DE AQUISIÇÃO DO CONTRATO: */
 
		ds_conteudo_w	:= '2' || lpad(' ', 48, ' ') || dt_prox_reaj_w || lpad(' ', 90, ' ') || lpad(nr_seq_reg_arq_w,6,'0');
		 
		utl_file.put_line(arq_texto_w, ds_conteudo_w);
		utl_file.fflush(arq_texto_w);
		 
		nr_seq_reg_arq_w := nr_seq_reg_arq_w + 1;
		 
		/* MENSALIDADE */
 
		ds_conteudo_w	:= '2' || lpad(' ', 48, ' ') || vl_mensalidade_w || lpad(' ', 90, ' ') || lpad(nr_seq_reg_arq_w,6,'0');
		 
		utl_file.put_line(arq_texto_w, ds_conteudo_w);
		utl_file.fflush(arq_texto_w);
		 
		nr_seq_reg_arq_w := nr_seq_reg_arq_w + 1;
		 
		/* REAJUSTE */
 
		ds_conteudo_w	:= '2' || lpad(' ', 48, ' ') || vl_reajuste_w || lpad(' ', 90, ' ') || lpad(nr_seq_reg_arq_w,6,'0');
		 
		utl_file.put_line(arq_texto_w, ds_conteudo_w);
		utl_file.fflush(arq_texto_w);
		 
		nr_seq_reg_arq_w := nr_seq_reg_arq_w + 1;
		 
		/* PLANO */
 
		ds_conteudo_w	:= '2' || lpad(' ', 48, ' ') || ds_plano_w || lpad(' ', 90, ' ') || lpad(nr_seq_reg_arq_w,6,'0');
		 
		utl_file.put_line(arq_texto_w, ds_conteudo_w);
		utl_file.fflush(arq_texto_w);
		 
		/* Mensagem 1 */
 
		ds_conteudo_w	:= '2' || lpad(' ', 48, ' ') || 'Prezado (a) Cliente,' || lpad(' ', 90, ' ') || lpad(nr_seq_reg_arq_w,6,'0');
		 
		utl_file.put_line(arq_texto_w, ds_conteudo_w);
		utl_file.fflush(arq_texto_w);
		 
		nr_seq_reg_arq_w := nr_seq_reg_arq_w + 1;
		 
		/* Mensagem 2 */
 
		ds_conteudo_w	:= '2' || lpad(' ', 48, ' ') || 'Caso não receba o seu boleto ate a próxima data de vencimento,' || lpad(' ', 90, ' ') || lpad(nr_seq_reg_arq_w,6,'0');
		 
		utl_file.put_line(arq_texto_w, ds_conteudo_w);
		utl_file.fflush(arq_texto_w);
		 
		nr_seq_reg_arq_w := nr_seq_reg_arq_w + 1;
		 
		/* Mensagem 3 */
 
		ds_conteudo_w	:= '2' || lpad(' ', 48, ' ') || 'Manter contato telefone (11) 3169-7000 ou EMAIL PLANOSDESAUDE@ADVANCEPLANOS.COM.BR' || lpad(' ', 90, ' ') || lpad(nr_seq_reg_arq_w,6,'0');
		 
		utl_file.put_line(arq_texto_w, ds_conteudo_w);
		utl_file.fflush(arq_texto_w);
		 
		nr_seq_reg_arq_w := nr_seq_reg_arq_w + 1;
		 
		/* Mensagem 4 */
 
		ds_conteudo_w	:= '2' || lpad(' ', 48, ' ') || ds_juros_multa_w || lpad(' ', 90, ' ') || lpad(nr_seq_reg_arq_w,6,'0');
		 
		utl_file.put_line(arq_texto_w, ds_conteudo_w);
		utl_file.fflush(arq_texto_w);
		 
		nr_seq_reg_arq_w := nr_seq_reg_arq_w + 1;
		 
		/* Mensagem 5 */
 
		ds_conteudo_w	:= '2' || lpad(' ', 48, ' ') || '**Conheça nosso site: www.advance.com.br**' || lpad(' ', 90, ' ') || lpad(nr_seq_reg_arq_w,6,'0');
		 
		utl_file.put_line(arq_texto_w, ds_conteudo_w);
		utl_file.fflush(arq_texto_w);
		 
		qt_registro_w	:= qt_registro_w + 1;
		end;
	end loop;
	close C02;
	 
	open C03;
	loop 
	fetch C03 into	 
		nm_beneficiario_w, 
		cd_usuario_plano_w, 
		cd_identificacao_w, 
		ds_mensagem_ww, 
		ds_plano_w;
	EXIT WHEN NOT FOUND; /* apply on C03 */
		begin 
		nr_seq_reg_arq_w := nr_seq_reg_arq_w + 1;
		 
		/* BENEFICIÁRIO: */
 
		ds_conteudo_w	:= '2' || lpad(' ', 48, ' ') || nm_beneficiario_w || lpad(' ', 90, ' ') || lpad(nr_seq_reg_arq_w,6,'0');
		 
		utl_file.put_line(arq_texto_w, ds_conteudo_w);
		utl_file.fflush(arq_texto_w);
		 
		nr_seq_reg_arq_w := nr_seq_reg_arq_w + 1;
		 
		/* CÓDIGO: */
 
		ds_conteudo_w	:= '2' || lpad(' ', 48, ' ') || cd_usuario_plano_w || lpad(' ', 90, ' ') || lpad(nr_seq_reg_arq_w,6,'0');
		 
		utl_file.put_line(arq_texto_w, ds_conteudo_w);
		utl_file.fflush(arq_texto_w);
		 
		nr_seq_reg_arq_w := nr_seq_reg_arq_w + 1;
		 
		/* CÓDIGO DE IDENTIFICAÇÃO/ SCPA/ ANS: */
 
		ds_conteudo_w	:= '2' || lpad(' ', 48, ' ') || cd_identificacao_w || lpad(' ', 90, ' ') || lpad(nr_seq_reg_arq_w,6,'0');
		 
		utl_file.put_line(arq_texto_w, ds_conteudo_w);
		utl_file.fflush(arq_texto_w);
		 
		nr_seq_reg_arq_w := nr_seq_reg_arq_w + 1;
		 
		/* MENSAGEM */
 
		ds_conteudo_w	:= '2' || lpad(' ', 48, ' ') || ds_mensagem_ww || lpad(' ', 90, ' ') || lpad(nr_seq_reg_arq_w,6,'0');
		 
		utl_file.put_line(arq_texto_w, ds_conteudo_w);
		utl_file.fflush(arq_texto_w);
		 
		nr_seq_reg_arq_w := nr_seq_reg_arq_w + 1;
		 
		/* PLANO: */
 
		ds_conteudo_w	:= '2' || lpad(' ', 48, ' ') || ds_plano_w || lpad(' ', 90, ' ') || lpad(nr_seq_reg_arq_w,6,'0');
		 
		utl_file.put_line(arq_texto_w, ds_conteudo_w);
		utl_file.fflush(arq_texto_w);
		 
		qt_registro_w	:= qt_registro_w + 1;
		end;
	end loop;
	close C03;
	end;
end loop;
close C01;
/* Fim Registro */
 
 
/* Trailler */
 
 
nr_seq_reg_arq_w := nr_seq_reg_arq_w + 1;
qt_registro_w := qt_registro_w + 1;
 
ds_conteudo_w	:=	'9' 				|| 
			lpad(qt_registro_w,6,'0')	|| 
			lpad(replace(to_char(vl_total_w,'fm000000000.99'),'.',''),13,'0')		|| 
			ds_zeros_374_w			|| 
			lpad(nr_seq_reg_arq_w,6,'0');
				 
			 
 
utl_file.put_line(arq_texto_w, ds_conteudo_w);
utl_file.fflush(arq_texto_w);
 
/* Fim Trailler */
 
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_cobr_santan_400_utl_file (nr_seq_cobr_escrit_p bigint, cd_estabelecimento_p text, nm_usuario_p text) FROM PUBLIC;

