-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE man_comunic_alteracao_prior ( nr_sequencia_p bigint, nm_usuario_p text, nr_seq_justificativa_p text, ie_prioridade_p text, ie_prioridade_ant_p text, ds_observacao_p text, dt_fim_desejado_p text, dt_fim_desejado_ant_p text) AS $body$
DECLARE


ds_titulo_w			varchar(255);
ds_comunicado_w		varchar(4000);
nr_sequencia_w		bigint;
nr_seq_classif_w	bigint;
nm_usuario_w		varchar(15);
ds_dano_breve_w		varchar(255);
ds_prioridade_w		varchar(255);
ds_justificativa_w	varchar(255);
ds_fim_desejado_w	varchar(255);


BEGIN

select	substr( obter_desc_expressao(313423)/*'Descrição: '*/
	|| ds_dano_breve,1,255),
	substr( obter_desc_expressao(296328)/*'Prioridade: '*/
 ||': '|| substr(obter_valor_dominio(1046,ie_prioridade_p),1,80) || chr(13) || chr(10) ||
		'Prioridade anterior: ' || substr(obter_valor_dominio(1046,ie_prioridade_ant_p),1,80),1,255),
	substr(obter_usuario_pessoa(cd_pessoa_solicitante),1,15),
	substr( obter_desc_expressao(290113)/*'Fim desejado: '*/
 ||': '|| dt_fim_desejado_p || chr(13) || chr(10) ||
		'Fim desej. anterior: ' || dt_fim_desejado_ant_p,1,255)
into STRICT	ds_dano_breve_w,
	ds_prioridade_w,
	nm_usuario_w,
	ds_fim_desejado_w
from	man_ordem_servico
where	nr_sequencia = nr_sequencia_p;

ds_titulo_w	:= 'Alteração da prioridade da Ordem de serviço nº ' || nr_sequencia_p;

select	obter_classif_comunic('F')
into STRICT	nr_seq_classif_w
;

select	ds_justificativa
into STRICT	ds_justificativa_w
from	man_prioridade_justif
where	nr_sequencia = nr_seq_justificativa_p;

ds_comunicado_w	:= substr(ds_dano_breve_w || chr(13) || chr(10) || ds_prioridade_w || chr(13) || chr(10) ||
		  		'Justificativa da alteração da prioridade: ' || ds_justificativa_w || chr(13) || chr(10) ||
				obter_desc_expressao(329252)/*'Observação: '*/
 || ds_observacao_p || chr(13) || chr(10) || ds_fim_desejado_w,1,4000);

CALL gerar_comunic_padrao(	clock_timestamp(),
			ds_titulo_w,
			ds_comunicado_w,
			nm_usuario_p,
			'N',
			nm_usuario_w,
			'N',
			nr_seq_classif_w,
			'',
			'',
			'',
			clock_timestamp(),
			'',
			'');

Insert into man_ordem_serv_envio(	nr_sequencia,
				nr_seq_ordem,
				dt_atualizacao,
				nm_usuario,
				dt_envio,
				ie_tipo_envio,
				ds_destino,
				ds_observacao)
			values (	nextval('man_ordem_serv_envio_seq'),
				nr_sequencia_p,
				clock_timestamp(),
				nm_usuario_p,
				clock_timestamp(),
				'I',
				substr(nm_usuario_w,1,255),
				'Alteração de prioridade');

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE man_comunic_alteracao_prior ( nr_sequencia_p bigint, nm_usuario_p text, nr_seq_justificativa_p text, ie_prioridade_p text, ie_prioridade_ant_p text, ds_observacao_p text, dt_fim_desejado_p text, dt_fim_desejado_ant_p text) FROM PUBLIC;

