-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_reinserir_item_conta_compl ( nr_seq_prestador_p bigint, nr_seq_prestador_exec_p bigint, nr_seq_prestador_fornec_p bigint, nr_seq_conta_p bigint, vl_item_p bigint, qt_item_p bigint, cd_medico_exec_p bigint, ie_via_acesso_p text, nr_seq_grau_partic_p bigint, nr_seq_item_p bigint, ie_tipo_item_p text, ie_tipo_acao_p text, nm_usuario_p text, ie_origem_proced_p bigint, cd_estabelecimento_p bigint, dt_atendimento_p text, hr_inicio_proc_p text, nr_seq_setor_atend_p bigint, nr_seq_conta_proc_p bigint) AS $body$
DECLARE

		 
nr_seq_item_w			bigint;	
qt_seq_participacao   	bigint := 0;	
ie_estagio_complemento_w	smallint;
ie_alterado_prestador_w		varchar(1);
ie_situacao_prot_w		varchar(2);

nr_seq_prestador_w		bigint;
cd_medico_w			varchar(10);	
nr_seq_grau_partic_w		bigint;

C01 CURSOR FOR 
	SELECT	nr_seq_prestador, 
		cd_medico, 
		nr_seq_grau_partic		 
	from 	pls_proc_participante 
	where	nr_Seq_conta_proc = nr_seq_conta_proc_p;
		

BEGIN 
 
if (ie_tipo_item_p = 'P') then 
	if (ie_tipo_acao_p = 'I') then 
		 
		select	nextval('pls_conta_proc_seq') 
		into STRICT	nr_seq_item_w 
		;	
		 
		insert into pls_conta_proc(	 
				nr_sequencia, dt_atualizacao, nm_usuario, 
				nr_seq_conta, cd_procedimento, ie_tipo_despesa, 
				dt_procedimento, qt_procedimento_imp, ie_estagio_complemento, 
				ie_situacao, ie_status, vl_unitario_imp, 
				vl_procedimento_imp, ie_origem_proced, ie_via_acesso, 
				dt_inicio_proc, ie_alterado_prestador) 
			values (	nr_seq_item_w, clock_timestamp(), nm_usuario_p, 
				nr_seq_conta_p, nr_seq_item_p, 1, 
				to_date(dt_atendimento_p,'dd/mm/yyyy'), qt_item_p, 2, 
				'I', 'U', dividir(vl_item_p,qt_item_p), 
				vl_item_p, ie_origem_proced_p, ie_via_acesso_p, 
				to_date(hr_inicio_proc_p,'hh24:mi:ss'), 'I');				
		--commit;	 
		 
		open C01;
		loop 
		fetch C01 into	 
			nr_seq_prestador_w, 
			cd_medico_w, 
			nr_seq_grau_partic_w;
		EXIT WHEN NOT FOUND; /* apply on C01 */
		 
			insert into pls_proc_participante( 
					nr_sequencia, dt_atualizacao, nm_usuario, 
					nr_seq_conta_proc, nr_seq_grau_partic, cd_medico, 
					nr_seq_prestador,ie_status) 
				values ( nextval('pls_proc_participante_seq'), clock_timestamp(), nm_usuario_p, 
					nr_seq_conta_proc_p, nr_seq_grau_partic_w, cd_medico_w, 
					nr_seq_prestador_w,'U');				
		end loop;
		close C01;
		 
		--commit; 
		 
		--pls_consistir_conta_proc(nr_seq_item_w, cd_estabelecimento_p, nm_usuario_p);	 
		ie_situacao_prot_w := pls_consist_conta_proc_web(nr_seq_conta_p, nr_seq_prestador_p, nm_usuario_p, cd_estabelecimento_p, 'C', ie_situacao_prot_w);
	else 
		select	ie_estagio_complemento, 
			ie_alterado_prestador 
		into STRICT	ie_estagio_complemento_w, 
			ie_alterado_prestador_w 
		from 	pls_conta_proc 
		where  nr_sequencia = nr_seq_item_p;
		 
		if (coalesce(ie_estagio_complemento_w,0) = 0 or coalesce(ie_estagio_complemento_w,0) = 2) then 
			ie_estagio_complemento_w := 1;
		end if;
		 
		 
		if (coalesce(ie_alterado_prestador_w::text, '') = '' and ie_estagio_complemento_w = 3) then 
			ie_alterado_prestador_w := 'A';
		elsif (coalesce(ie_alterado_prestador_w::text, '') = '') then 
			ie_alterado_prestador_w := 'I';
		elsif (ie_alterado_prestador_w = 'G') then 
			ie_alterado_prestador_w := 'A';
		end if;
	 
		update 	pls_conta_proc 
		set	vl_procedimento_imp 	= vl_item_p, 
			qt_procedimento_imp 	= qt_item_p, 
			vl_unitario_imp		= dividir(vl_item_p,qt_item_p), 
			ie_via_acesso		= ie_via_acesso_p, 
			ie_estagio_complemento = ie_estagio_complemento_w, 
			dt_procedimento		= to_date(dt_atendimento_p,'dd/mm/yyyy hh24:mi:ss'), 
			dt_inicio_proc		= to_date(hr_inicio_proc_p,'hh24:mi:ss'), 
			ie_alterado_prestador  = ie_alterado_prestador_w 
		where	nr_sequencia 		= nr_seq_item_p;
 
		select	count(1) 
		into STRICT 	qt_seq_participacao 
		from	pls_proc_participante 
		where	nr_seq_conta_proc = nr_seq_item_p;
		 
		if (qt_seq_participacao > 0) then 
			update pls_proc_participante 
			set	cd_medico = cd_medico_exec_p, 
				nr_seq_grau_partic = nr_seq_grau_partic_p, 
				ie_status	= 'U' 
			where	nr_seq_conta_proc = nr_seq_item_p;
		else 
			insert into pls_proc_participante( 
					nr_sequencia, dt_atualizacao, nm_usuario, 
					nr_seq_conta_proc, nr_seq_grau_partic, cd_medico, 
					ie_status) 
				values ( nextval('pls_proc_participante_seq'), clock_timestamp(), nm_usuario_p, 
					nr_seq_item_p, nr_seq_grau_partic_p, cd_medico_exec_p, 
					'U');
		end if;	
		 
	end if;	
	 
elsif (ie_tipo_item_p = 'M') then 
	if (ie_tipo_acao_p = 'I') then 
		select	nextval('pls_conta_mat_seq') 
		into STRICT	nr_seq_item_w 
		;
		 
		insert into pls_conta_mat( 
					nr_sequencia, dt_atualizacao, nm_usuario, 
					nr_seq_conta, nr_seq_material, ie_tipo_despesa, 
					qt_material_imp, ie_estagio_complemento, ie_situacao, 
					ie_status, vl_unitario_imp, vl_material_imp, 
					ie_alterado_prestador, nr_seq_prest_fornec, nr_seq_setor_atend, 
					dt_atendimento) 
		values (	nr_seq_item_w, clock_timestamp(), nm_usuario_p, 
					nr_seq_conta_p, nr_seq_item_p, 2, 
					qt_item_p, 2, 'I', 
					'U', dividir(vl_item_p,qt_item_p), vl_item_p, 
					'I', nr_seq_prestador_fornec_p, nr_seq_setor_atend_p, 
					to_date(dt_atendimento_p,'dd/mm/yyyy hh24:mi:ss'));
				 
		commit;
		--pls_consistir_conta_mat(nr_seq_item_w, cd_estabelecimento_p, nm_usuario_p); 
		ie_situacao_prot_w := pls_consist_conta_mat_web(nr_seq_conta_p, nr_seq_prestador_p, nm_usuario_p, cd_estabelecimento_p, 'C', ie_situacao_prot_w);
	else 
		select	ie_estagio_complemento, 
			ie_alterado_prestador 
		into STRICT	ie_estagio_complemento_w, 
			ie_alterado_prestador_w 
		from 	pls_conta_mat 
		where  nr_sequencia = nr_seq_item_p;
		 
		if (ie_estagio_complemento_w = 0 or ie_estagio_complemento_w = 2) then 
			ie_estagio_complemento_w := 1;
		end if;
		 
		if (coalesce(ie_alterado_prestador_w::text, '') = '' and ie_estagio_complemento_w = 3) then 
			ie_alterado_prestador_w := 'A';
		elsif (coalesce(ie_alterado_prestador_w::text, '') = '') then 
			ie_alterado_prestador_w := 'I';
		elsif (ie_alterado_prestador_w = 'G') then 
			ie_alterado_prestador_w := 'A';
		end if;
		 
		update 	pls_conta_mat 
		set	vl_material_imp 	= vl_item_p, 
			qt_material_imp 	= qt_item_p, 
			ie_estagio_complemento = ie_estagio_complemento_w, 
			ie_alterado_prestador  = ie_alterado_prestador_w, 
			nr_seq_setor_atend	 = nr_seq_setor_atend_p, 
			dt_atendimento = to_date(dt_atendimento_p,'dd/mm/yyyy hh24:mi:ss') 
		where	nr_sequencia 	= nr_seq_item_p;
	end if;
end if;
 
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_reinserir_item_conta_compl ( nr_seq_prestador_p bigint, nr_seq_prestador_exec_p bigint, nr_seq_prestador_fornec_p bigint, nr_seq_conta_p bigint, vl_item_p bigint, qt_item_p bigint, cd_medico_exec_p bigint, ie_via_acesso_p text, nr_seq_grau_partic_p bigint, nr_seq_item_p bigint, ie_tipo_item_p text, ie_tipo_acao_p text, nm_usuario_p text, ie_origem_proced_p bigint, cd_estabelecimento_p bigint, dt_atendimento_p text, hr_inicio_proc_p text, nr_seq_setor_atend_p bigint, nr_seq_conta_proc_p bigint) FROM PUBLIC;

