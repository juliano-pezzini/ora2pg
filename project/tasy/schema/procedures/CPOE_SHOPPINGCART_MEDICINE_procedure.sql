-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE cpoe_shoppingcart_medicine (nr_sequencia_p bigint, ie_retrogrado_p text, ds_retorno_p INOUT text) AS $body$
DECLARE


_ora2pg_r RECORD;
ie_return_value_w	varchar(1) := 'N';
nr_return_value_w	bigint;
active_ingred_consist_w varchar(255);

ds_alergia_w	varchar(4000);
ie_severidade_w	paciente_alergia.ie_intensidade%type;
nr_seq_reacao_w	paciente_alergia.nr_seq_reacao%type;
nr_seq_ficha_tecnica_w	paciente_alergia.nr_seq_ficha_tecnica%type;
ds_erro_w	varchar(4000);
ds_mensagem_w	varchar(4000);
ie_abortar_w	varchar(30);

si_presctype_w cpoe_order_unit.si_type_of_prescription%type;
si_itemtype_w cpoe_order_unit.si_cpoe_type_of_item%type;
ie_param_cpoe_6_w   varchar(1);
ie_param_rep_224_w	varchar(30);
qt_param_rep_257_w	bigint;
qt_param_rep_258_w	bigint;
ie_param_rep_1057_w	varchar(30);
ie_param_rep_464_w	varchar(30);
qt_volume_final_w	double precision;

ie_exige_lado_w	material.ie_exige_lado%type;
ie_padronizado_w	material_estab.ie_padronizado%type;
ie_classif_custo_w	material_estab.ie_classif_custo%type;
ie_operacao_w	intervalo_prescricao.ie_operacao%type;
ie_dilution_rule_w	varchar(255);
ie_via_aplicacao_rule_dil_w	varchar(1);

ie_justificativa_antimicrob_w	char(1);
ie_objetivo_antimicrob_w	char(1);
ie_dia_utilizacao_antimicrob_w	char(1);
ie_topografia_antimicrob_w	char(1);
ie_amostra_antimicrob_w	char(1);
ie_microorganismo_antimicrob_w	char(1);
ie_origem_antimicrob_w	char(1);
ie_ctrl_medico_antimicrob_w	char(1);
ie_indicacao_clinica_w	char(1);
ie_existe_w	char(1);
ie_possui_regra_w	char(1);
hr_hora_atual_w	char(8);
qt_dias_prev_w	regra_antimicrobiano.qt_dias_prev%type;
ie_objetivo_filtro_w	regra_antimicrobiano.ie_objetivo_filtro%type;
ie_lib_auto_w					regra_antimicrobiano.ie_lib_auto%type;
ie_just_se_necessario_w	parametro_medico.ie_just_se_necessario%type;
ie_obriga_tempo_aplic_w		varchar(1);
ie_via_endovenosa_w		varchar(1);
instruct_restrict_w   varchar(150);
si_action   varchar(1);
is_split_w  varchar(3);
nr_atendimento_w			cpoe_material.nr_atendimento%type;
ie_info_rastre_prescr_w		varchar(1);
ds_log_step_w				varchar(2000);
ie_regra_intervalo_w			cpoe_material.cd_intervalo%type;
qt_diff_days_w				double precision;
qt_dias_lib_padrao_w			parametro_medico.qt_dias_lib_padrao%type;

c01 CURSOR FOR
SELECT  a.*, obter_setor_atendimento(nr_atendimento) cd_setor_atend
from 	cpoe_material a
where	nr_sequencia = nr_sequencia_p;

BEGIN

ds_retorno_p := 'S';

if (nr_sequencia_p IS NOT NULL AND nr_sequencia_p::text <> '') then
	for r_c01_w in C01
	loop
		nr_atendimento_w := r_c01_w.nr_atendimento;

		-- CAMPOS OBRIGATORIOS
		if (coalesce(r_c01_w.dt_inicio::text, '') = '' or coalesce(r_c01_w.cd_material::text, '') = '' or coalesce(r_c01_w.ie_via_aplicacao::text, '') = '' or (coalesce(r_c01_w.qt_dose::text, '') = '' and coalesce(r_c01_w.ds_dose_diferenciada::text, '') = '') or coalesce(r_c01_w.cd_unidade_medida::text, '') = ''
			or coalesce(r_c01_w.ie_administracao::text, '') = '' or coalesce(r_c01_w.ie_controle_tempo::text, '') = '') then

			ds_log_step_w := 'STEP_1'
				|| ' - dt_inicio: ' || r_c01_w.dt_inicio
				|| ' - cd_material: ' || r_c01_w.cd_material
				|| ' - ie_via_aplicacao: ' || r_c01_w.ie_via_aplicacao
				|| ' - qt_dose: ' || r_c01_w.qt_dose
				|| ' - ds_dose_diferenciada: ' || r_c01_w.ds_dose_diferenciada
				|| ' - cd_unidade_medida: ' || r_c01_w.cd_unidade_medida
				|| ' - ie_administracao: ' || r_c01_w.ie_administracao
				|| ' - ie_controle_tempo: ' || r_c01_w.ie_controle_tempo
				|| ' - LINE: ' || $$plsql_line;

			ds_retorno_p := 'N';
			goto return_value;
		end if;

		if (r_c01_w.ie_administracao = 'P' and coalesce(r_c01_w.ds_horarios::text, '') = '') then
			ds_log_step_w := 'STEP_2'
				|| ' - ie_administracao: ' || r_c01_w.ie_administracao
				|| ' - ds_horarios: ' || r_c01_w.ds_horarios
				|| ' - LINE: ' || $$plsql_line;

			ds_retorno_p := 'N';
			goto return_value;
		end if;

		if (((r_c01_w.cd_mat_comp1 IS NOT NULL AND r_c01_w.cd_mat_comp1::text <> '') and ((coalesce(r_c01_w.qt_dose_comp1::text, '') = '' and coalesce(r_c01_w.ds_dose_diferenciada_comp1::text, '') = '') or coalesce(r_c01_w.cd_unid_med_dose_comp1::text, '') = ''))
			or ((r_c01_w.cd_mat_comp2 IS NOT NULL AND r_c01_w.cd_mat_comp2::text <> '') and ((coalesce(r_c01_w.qt_dose_comp2::text, '') = '' and coalesce(r_c01_w.ds_dose_diferenciada_comp2::text, '') = '') or coalesce(r_c01_w.cd_unid_med_dose_comp2::text, '') = ''))
			or ((r_c01_w.cd_mat_comp3 IS NOT NULL AND r_c01_w.cd_mat_comp3::text <> '') and ((coalesce(r_c01_w.qt_dose_comp3::text, '') = '' and coalesce(r_c01_w.ds_dose_diferenciada_comp3::text, '') = '') or coalesce(r_c01_w.cd_unid_med_dose_comp3::text, '') = ''))
			or ((r_c01_w.cd_mat_comp4 IS NOT NULL AND r_c01_w.cd_mat_comp4::text <> '') and ((coalesce(r_c01_w.qt_dose_comp4::text, '') = '' and coalesce(r_c01_w.ds_dose_diferenciada_comp4::text, '') = '') or coalesce(r_c01_w.cd_unid_med_dose_comp4::text, '') = ''))
			or ((r_c01_w.cd_mat_comp5 IS NOT NULL AND r_c01_w.cd_mat_comp5::text <> '') and ((coalesce(r_c01_w.qt_dose_comp5::text, '') = '' and coalesce(r_c01_w.ds_dose_diferenciada_comp5::text, '') = '') or coalesce(r_c01_w.cd_unid_med_dose_comp5::text, '') = ''))
			or ((r_c01_w.cd_mat_comp6 IS NOT NULL AND r_c01_w.cd_mat_comp6::text <> '') and ((coalesce(r_c01_w.qt_dose_comp6::text, '') = '' and coalesce(r_c01_w.ds_dose_diferenciada_comp6::text, '') = '') or coalesce(r_c01_w.cd_unid_med_dose_comp6::text, '') = ''))
			or ((r_c01_w.cd_mat_comp7 IS NOT NULL AND r_c01_w.cd_mat_comp7::text <> '') and ((coalesce(r_c01_w.qt_dose_comp7::text, '') = '' and coalesce(r_c01_w.ds_dose_diferenciada_comp7::text, '') = '') or coalesce(r_c01_w.cd_unid_med_dose_comp7::text, '') = ''))
			or ((r_c01_w.cd_mat_dil IS NOT NULL AND r_c01_w.cd_mat_dil::text <> '') and ((coalesce(r_c01_w.qt_dose_dil::text, '') = '' and coalesce(r_c01_w.ds_dose_diferenciada_dil::text, '') = '') or coalesce(r_c01_w.cd_unid_med_dose_dil::text, '') = ''))
			or ((r_c01_w.cd_mat_red IS NOT NULL AND r_c01_w.cd_mat_red::text <> '') and ((coalesce(r_c01_w.qt_dose_red::text, '') = '' and coalesce(r_c01_w.ds_dose_diferenciada_red::text, '') = '') or coalesce(r_c01_w.cd_unid_med_dose_red::text, '') = ''))) then

			ds_log_step_w := 'STEP_3 - LINE: ' || $$plsql_line;
			
			ds_retorno_p := 'N';
			goto return_value;
		end if;

		if (r_c01_w.ie_dose_ataque = 'S' and (((r_c01_w.cd_material IS NOT NULL AND r_c01_w.cd_material::text <> '') and coalesce(r_c01_w.qt_dose_ataque::text, '') = '')
			or ((r_c01_w.cd_mat_comp1 IS NOT NULL AND r_c01_w.cd_mat_comp1::text <> '') and coalesce(r_c01_w.qt_dose_ataque_comp1::text, '') = '')
			or ((r_c01_w.cd_mat_comp2 IS NOT NULL AND r_c01_w.cd_mat_comp2::text <> '') and coalesce(r_c01_w.qt_dose_ataque_comp2::text, '') = '')
			or ((r_c01_w.cd_mat_comp3 IS NOT NULL AND r_c01_w.cd_mat_comp3::text <> '') and coalesce(r_c01_w.qt_dose_ataque_comp3::text, '') = '')
			or ((r_c01_w.cd_mat_comp4 IS NOT NULL AND r_c01_w.cd_mat_comp4::text <> '') and coalesce(r_c01_w.qt_dose_ataque_comp4::text, '') = '')
			or ((r_c01_w.cd_mat_comp5 IS NOT NULL AND r_c01_w.cd_mat_comp5::text <> '') and coalesce(r_c01_w.qt_dose_ataque_comp5::text, '') = '')
			or ((r_c01_w.cd_mat_comp6 IS NOT NULL AND r_c01_w.cd_mat_comp6::text <> '') and coalesce(r_c01_w.qt_dose_ataque_comp6::text, '') = '')
			or ((r_c01_w.cd_mat_comp7 IS NOT NULL AND r_c01_w.cd_mat_comp7::text <> '') and coalesce(r_c01_w.qt_dose_ataque_comp7::text, '') = '')
			or ((r_c01_w.cd_mat_dil IS NOT NULL AND r_c01_w.cd_mat_dil::text <> '') and coalesce(r_c01_w.qt_dose_ataque_dil::text, '') = '')
			or ((r_c01_w.cd_mat_recons IS NOT NULL AND r_c01_w.cd_mat_recons::text <> '') and coalesce(r_c01_w.qt_dose_recons::text, '') = ''))) then

			ds_log_step_w := 'STEP_4 - LINE: ' || $$plsql_line;
			
			ds_retorno_p := 'N';
			goto return_value;
		end if;

		if (r_c01_w.ie_dose_adicional = 'S' and ((coalesce(r_c01_w.dt_adm_adicional::text, '') = '')
			or (((r_c01_w.cd_material IS NOT NULL AND r_c01_w.cd_material::text <> '') and coalesce(r_c01_w.qt_dose_adicional::text, '') = '')
			or ((r_c01_w.cd_mat_comp1 IS NOT NULL AND r_c01_w.cd_mat_comp1::text <> '') and coalesce(r_c01_w.qt_dose_adic_comp1::text, '') = '')
			or ((r_c01_w.cd_mat_comp2 IS NOT NULL AND r_c01_w.cd_mat_comp2::text <> '') and coalesce(r_c01_w.qt_dose_adic_comp2::text, '') = '')
			or ((r_c01_w.cd_mat_comp3 IS NOT NULL AND r_c01_w.cd_mat_comp3::text <> '') and coalesce(r_c01_w.qt_dose_adic_comp3::text, '') = '')
			or ((r_c01_w.cd_mat_comp4 IS NOT NULL AND r_c01_w.cd_mat_comp4::text <> '') and coalesce(r_c01_w.qt_dose_adic_comp4::text, '') = '')
			or ((r_c01_w.cd_mat_comp5 IS NOT NULL AND r_c01_w.cd_mat_comp5::text <> '') and coalesce(r_c01_w.qt_dose_adic_comp5::text, '') = '')
			or ((r_c01_w.cd_mat_comp6 IS NOT NULL AND r_c01_w.cd_mat_comp6::text <> '') and coalesce(r_c01_w.qt_dose_adic_comp6::text, '') = '')
			or ((r_c01_w.cd_mat_comp7 IS NOT NULL AND r_c01_w.cd_mat_comp7::text <> '') and coalesce(r_c01_w.qt_dose_adic_comp7::text, '') = '')
			or ((r_c01_w.cd_mat_dil IS NOT NULL AND r_c01_w.cd_mat_dil::text <> '') and coalesce(r_c01_w.qt_dose_adic_dil::text, '') = '')
			or ((r_c01_w.cd_mat_recons IS NOT NULL AND r_c01_w.cd_mat_recons::text <> '') and coalesce(r_c01_w.qt_dose_recons::text, '') = '')))) then
			
			ds_log_step_w := 'STEP_5 - LINE: ' || $$plsql_line;
			
			ds_retorno_p := 'N';
			goto return_value;
		end if;

		if (r_c01_w.ie_controle_tempo = 'N' and (coalesce(r_c01_w.cd_intervalo::text, '') = '')) then
			
			ds_log_step_w := 'STEP_6'
				|| ' - cd_intervalo: ' || r_c01_w.cd_intervalo
				|| ' - LINE: ' || $$plsql_line;
			
			ds_retorno_p := 'N';
			goto return_value;
		end if;

		if (r_c01_w.ie_controle_tempo = 'S') then
			if (coalesce(r_c01_w.ie_tipo_solucao::text, '') = '') then

				ds_log_step_w := 'STEP_7: '
					|| ' - ie_tipo_solucao: ' || r_c01_w.ie_tipo_solucao
					|| ' - LINE: ' || $$plsql_line;
				
				ds_retorno_p := 'N';
				goto return_value;
			end if;

			if (r_c01_w.ie_tipo_solucao = 'I') then -- case medicinesConsts.INTERMITTENT
				if (coalesce(r_c01_w.ds_dose_diferenciada::text, '') = '' and coalesce(r_c01_w.qt_hora_fase::text, '') = '') then
					ds_log_step_w := 'STEP_8 '
						|| ' - ds_dose_diferenciada: ' || r_c01_w.ds_dose_diferenciada
						|| ' - qt_hora_fase: ' || r_c01_w.qt_hora_fase
						|| ' - LINE: ' || $$plsql_line;
				
					ds_retorno_p := 'N';
					goto return_value;
				end if;

				if (coalesce(r_c01_w.qt_tempo_aplicacao::text, '') = '' or coalesce(r_c01_w.ie_ref_calculo::text, '') = '') then

					ds_log_step_w := 'STEP_9 '
						|| ' - ds_dose_diferenciada: ' || r_c01_w.qt_tempo_aplicacao
						|| ' - qt_hora_fase: ' || r_c01_w.ie_ref_calculo
						|| ' - LINE: ' || $$plsql_line;
					
					ds_retorno_p := 'N';
					goto return_value;
				end if;
			elsif (r_c01_w.ie_tipo_solucao = 'V') then -- case medicinesConsts.INFUSION_RATE
				null;
			elsif (r_c01_w.ie_tipo_solucao = 'C') then -- case medicinesConsts.INFUSION_RATE
				if (coalesce(r_c01_w.qt_tempo_aplicacao::text, '') = '' or  coalesce(r_c01_w.qt_tempo_aplicacao::text, '') = '') then
					
					ds_log_step_w := 'STEP_10 '
						|| ' - ds_dose_diferenciada: ' || r_c01_w.qt_tempo_aplicacao
						|| ' - LINE: ' || $$plsql_line;

					ds_retorno_p := 'N';
					goto return_value;
				end if;
			end if;


			if (r_c01_w.ie_ref_calculo IS NOT NULL AND r_c01_w.ie_ref_calculo::text <> '') then
				if (r_c01_w.ie_ref_calculo = 'I' and coalesce(r_c01_w.cd_intervalo::text, '') = '') then

					ds_log_step_w := 'STEP_11 '
						|| ' - cd_intervalo: ' || r_c01_w.cd_intervalo
						|| ' - LINE: ' || $$plsql_line;
					
					ds_retorno_p := 'N';
					goto return_value;
				elsif (r_c01_w.ie_ref_calculo = 'NE' and coalesce(r_c01_w.nr_etapas::text, '') = '') then

					ds_log_step_w := 'STEP_12 '
						|| ' - cd_intervalo: ' || r_c01_w.nr_etapas
						|| ' - LINE: ' || $$plsql_line;					
					ds_retorno_p := 'N';

					goto return_value;
				elsif (r_c01_w.ie_ref_calculo = 'VI' and (coalesce(r_c01_w.qt_dosagem::text, '') = '')) then
					
					ds_log_step_w := 'STEP_13 '
						|| ' - cd_intervalo: ' || r_c01_w.qt_dosagem
						|| ' - LINE: ' || $$plsql_line;
					
					ds_retorno_p := 'N';
					goto return_value;
				end if;
			end if;

			if (cpoe_shoppingcart_vigencia(r_c01_w.cd_intervalo, r_c01_w.ie_administracao, r_c01_w.dt_inicio,
									r_c01_w.ie_urgencia, r_c01_w.ie_duracao, r_c01_w.dt_fim, r_c01_w.ie_evento_unico, ie_retrogrado_p) = 'S') then
				
				ds_log_step_w := 'STEP_14 '
					|| ' - cd_intervalo: ' || r_c01_w.qt_dosagem
					|| ' - LINE: ' || $$plsql_line;

				ds_retorno_p := 'N';
				goto return_value;
			end if;
		end if;
		-- FIM DOS CAMPOS OBRIGTORIOS

		-- OPEN DETAIL 
		if (r_c01_w.ie_controle_tempo = 'N') then
			select	coalesce(max(ie_exige_lado), 'N')
			into STRICT	ie_exige_lado_w
			from	material
			where	cd_material = r_c01_w.cd_material;

			if (ie_exige_lado_w in ('S', 'L') and coalesce(r_c01_w.ie_lado::text, '') = '') then

				ds_log_step_w := 'STEP_15 '
					|| ' - ie_lado: ' || r_c01_w.ie_lado
					|| ' - LINE: ' || $$plsql_line;
				
				ds_retorno_p := 'N';
				goto return_value;
			end if;

			select	coalesce(max('S'),'N')
			into STRICT	ie_return_value_w
			from	regra_medic_espec_rep
			where	cd_material = r_c01_w.cd_material;

			if (ie_return_value_w = 'S' and r_c01_w.qt_dia_util_alb > 0) then

				ds_log_step_w := 'STEP_16 '
					|| ' - qt_dia_util_alb: ' || r_c01_w.qt_dia_util_alb
					|| ' - LINE: ' || $$plsql_line;
				
				ds_retorno_p := 'N';
				goto return_value;
			end if;
		end if;

		select	CASE WHEN r_c01_w.ie_via_aplicacao='N' THEN  'S'  ELSE 'N' END
		into STRICT	ie_via_aplicacao_rule_dil_w
		;

		select	coalesce(max(ie_justificativa),'N')
		into STRICT	ie_return_value_w
		from	protocolo_medic_material
		where	cd_protocolo = r_c01_w.cd_protocolo
		and	nr_sequencia = r_c01_w.nr_seq_protocolo
		and	nr_seq_material = r_c01_w.nr_seq_mat_protocolo;

		if (ie_return_value_w = 'S' and coalesce(r_c01_w.ds_justificativa::text, '') = '') then

			ds_log_step_w := 'STEP_17 '
				|| ' - ds_justificativa: ' || r_c01_w.ds_justificativa
				|| ' - LINE: ' || $$plsql_line;
			
			ds_retorno_p := 'N';
			goto return_value;
		end if;

		if (r_c01_w.ie_antibiotico = 'S') then
			if (r_c01_w.ie_duracao <> 'P') then
				
				ds_log_step_w := 'STEP_18 '
					|| ' - ie_duracao: ' || r_c01_w.ie_duracao
					|| ' - LINE: ' || $$plsql_line;

				ds_retorno_p := 'N';
				goto return_value;
			end if;

			SELECT * FROM cpoe_obter_dados_antimicrob(r_c01_w.cd_material, obter_perfil_ativo, wheb_usuario_pck.get_cd_estabelecimento, r_c01_w.nm_usuario_nrec, r_c01_w.ie_objetivo, r_c01_w.cd_intervalo) INTO STRICT _ora2pg_r;
 ie_justificativa_antimicrob_w := _ora2pg_r.ie_justificativa_p; ie_objetivo_antimicrob_w := _ora2pg_r.ie_objetivo_p; ie_dia_utilizacao_antimicrob_w := _ora2pg_r.ie_dia_utilizacao_p; ie_topografia_antimicrob_w := _ora2pg_r.ie_topografia_p; ie_amostra_antimicrob_w := _ora2pg_r.ie_amostra_p; ie_microorganismo_antimicrob_w := _ora2pg_r.ie_microorganismo_p; ie_origem_antimicrob_w := _ora2pg_r.ie_origem_p; ie_indicacao_clinica_w := _ora2pg_r.ie_exige_indicacao_p; qt_dias_prev_w := _ora2pg_r.qt_dias_prev_p; ie_objetivo_filtro_w := _ora2pg_r.ie_obj_regra_p; ie_lib_auto_w := _ora2pg_r.ie_lib_auto_p; ie_possui_regra_w := _ora2pg_r.ie_possui_regra_p; ie_regra_intervalo_w := _ora2pg_r.ie_regra_intervalo_p; qt_dias_lib_padrao_w := _ora2pg_r.qt_dias_lib_padrao_p;

			if (ie_possui_regra_w = 'S') then
				if (((ie_dia_utilizacao_antimicrob_w IS NOT NULL AND ie_dia_utilizacao_antimicrob_w::text <> '') and coalesce(r_c01_w.qt_dias_solicitado::text, '') = '' and (ie_dia_utilizacao_antimicrob_w = r_c01_w.ie_objetivo or ie_dia_utilizacao_antimicrob_w = 'S'))
						or ((ie_topografia_antimicrob_w IS NOT NULL AND ie_topografia_antimicrob_w::text <> '') and coalesce(r_c01_w.cd_topografia_cih::text, '') = '' and (ie_topografia_antimicrob_w = r_c01_w.ie_objetivo or ie_topografia_antimicrob_w = 'S'))
						or ((ie_amostra_antimicrob_w IS NOT NULL AND ie_amostra_antimicrob_w::text <> '') and coalesce(r_c01_w.cd_amostra_cih::text, '') = '' and (ie_amostra_antimicrob_w = r_c01_w.ie_objetivo or ie_amostra_antimicrob_w = 'S'))
						or ((ie_microorganismo_antimicrob_w IS NOT NULL AND ie_microorganismo_antimicrob_w::text <> '') and coalesce(r_c01_w.cd_microorganismo_cih::text, '') = '' and (ie_microorganismo_antimicrob_w = r_c01_w.ie_objetivo or ie_microorganismo_antimicrob_w = 'S'))
						or ((ie_origem_antimicrob_w IS NOT NULL AND ie_origem_antimicrob_w::text <> '') and coalesce(r_c01_w.ie_origem_infeccao::text, '') = '' and (ie_origem_antimicrob_w = r_c01_w.ie_objetivo or ie_origem_antimicrob_w = 'S'))
						or ((ie_indicacao_clinica_w IS NOT NULL AND ie_indicacao_clinica_w::text <> '') and coalesce(r_c01_w.ie_indicacao::text, '') = '' and (ie_indicacao_clinica_w = r_c01_w.ie_objetivo or ie_indicacao_clinica_w = 'S'))
						or ((ie_objetivo_antimicrob_w IS NOT NULL AND ie_objetivo_antimicrob_w::text <> '') and coalesce(r_c01_w.ie_objetivo::text, '') = '' and (ie_objetivo_antimicrob_w = r_c01_w.ie_objetivo or ie_objetivo_antimicrob_w = 'S'))
						or ((ie_justificativa_antimicrob_w IS NOT NULL AND ie_justificativa_antimicrob_w::text <> '') and coalesce(r_c01_w.ds_justificativa::text, '') = '' and (ie_justificativa_antimicrob_w = r_c01_w.ie_objetivo or ie_justificativa_antimicrob_w = 'S'))) then
					
					ds_log_step_w := 'STEP_19 '
						|| ' - LINE: ' || $$plsql_line;

					ds_retorno_p := 'N';
					goto return_value;
				end if;
			end if;
			
			-- CUSTOM VALIDATOR DO ANTOBIOTICO
			if ((r_c01_w.ie_duracao = 'P') and (coalesce(r_c01_w.qt_dias_solicitado, 0) > 0) and (r_c01_w.dt_fim IS NOT NULL AND r_c01_w.dt_fim::text <> '')) then
				
				qt_diff_days_w := (r_c01_w.dt_fim + interval '1' minute) - r_c01_w.dt_inicio;
				if (qt_diff_days_w > 0 AND qt_diff_days_w <> r_c01_w.qt_dias_solicitado) then

					ds_log_step_w := 'STEP_19_A '
						|| ' - compare qt_dias_solicitado: ' || r_c01_w.ds_dose_diferenciada
						|| ' - LINE: ' || $$plsql_line;

					ds_retorno_p := 'N';
					goto return_value;
				end if;
			end if;

		end if;
		-- FIM DO OPEN DETAIL

		-- BEFORE PERFORM
		if (r_c01_w.ds_dose_diferenciada IS NOT NULL AND r_c01_w.ds_dose_diferenciada::text <> '') then
			if (r_c01_w.ds_dose_diferenciada like '%-') then
				
				ds_log_step_w := 'STEP_20 '
					|| ' - ds_dose_diferenciada: ' || r_c01_w.ds_dose_diferenciada
					|| ' - LINE: ' || $$plsql_line;

				ds_retorno_p := 'N';
				goto return_value;
			end if;
		end if;

		if ((r_c01_w.cd_mat_comp1 IS NOT NULL AND r_c01_w.cd_mat_comp1::text <> '') or (r_c01_w.cd_mat_comp2 IS NOT NULL AND r_c01_w.cd_mat_comp2::text <> '') or
			(r_c01_w.cd_mat_comp3 IS NOT NULL AND r_c01_w.cd_mat_comp3::text <> '') or (r_c01_w.cd_mat_comp4 IS NOT NULL AND r_c01_w.cd_mat_comp4::text <> '') or
			(r_c01_w.cd_mat_comp5 IS NOT NULL AND r_c01_w.cd_mat_comp5::text <> '') or (r_c01_w.cd_mat_comp6 IS NOT NULL AND r_c01_w.cd_mat_comp6::text <> '') or
			(r_c01_w.cd_mat_comp7 IS NOT NULL AND r_c01_w.cd_mat_comp7::text <> '')) then

			ie_param_rep_224_w := Obter_param_Usuario(924, 224, obter_perfil_ativo, wheb_usuario_pck.get_nm_usuario, wheb_usuario_pck.get_cd_estabelecimento, ie_param_rep_224_w);

			if (('N' = r_c01_w.ie_controle_tempo) and 'N' = ie_param_rep_224_w) then
				
				ds_log_step_w := 'STEP_21 '
					|| ' - ie_param_rep_224_w: ' || ie_param_rep_224_w
					|| ' - LINE: ' || $$plsql_line;

				ds_retorno_p := 'N';
				goto return_value;
			end if;
		end if;

		qt_param_rep_257_w := Obter_param_Usuario(924, 257, obter_perfil_ativo, wheb_usuario_pck.get_nm_usuario, wheb_usuario_pck.get_cd_estabelecimento, qt_param_rep_257_w);
		ie_param_cpoe_6_w := Obter_param_Usuario(2314, 6, obter_perfil_ativo, wheb_usuario_pck.get_nm_usuario, wheb_usuario_pck.get_cd_estabelecimento, ie_param_cpoe_6_w);

		select 	max(b.ie_padronizado) padrao
		into STRICT	ie_padronizado_w
		from	material_estab b
		where	b.cd_material = r_c01_w.cd_material
		and	b.cd_estabelecimento = wheb_usuario_pck.get_cd_estabelecimento;

		if (ie_padronizado_w = 'N') then
			if (coalesce(ie_param_cpoe_6_w,'P') = 'N') then

				ds_log_step_w := 'STEP_22 '
					|| ' - ie_padronizado_w: ' || ie_padronizado_w
					|| ' - ie_param_cpoe_6_w: ' || ie_param_cpoe_6_w
					|| ' - LINE: ' || $$plsql_line;
				
				ds_retorno_p := 'N';
				goto return_value;
			else
				if ((coalesce(r_c01_w.ds_justificativa::text, '') = '') or (coalesce(qt_param_rep_257_w,0) > 0 and length(r_c01_w.ds_justificativa) < qt_param_rep_257_w)) then
					
				ds_log_step_w := 'STEP_23 '
					|| ' - ie_padronizado_w: ' || ie_padronizado_w
					|| ' - ds_justificativa: ' || r_c01_w.ds_justificativa
					|| ' - qt_param_rep_257_w: ' || qt_param_rep_257_w
					|| ' - LINE: ' || $$plsql_line;
					
					ds_retorno_p := 'N';
					goto return_value;
				end if;
			end if;
		end if;

		qt_param_rep_258_w := Obter_param_Usuario(924, 258, obter_perfil_ativo, wheb_usuario_pck.get_nm_usuario, wheb_usuario_pck.get_cd_estabelecimento, qt_param_rep_258_w);

		select	coalesce(max(a.ie_classif_custo),'X') ie_classif_custo
		into STRICT	ie_classif_custo_w
		from	material_estab a,
			material b
		where	b.cd_material	= a.cd_material
		and	a.cd_material	= r_c01_w.cd_material
		and	a.cd_estabelecimento = wheb_usuario_pck.get_cd_estabelecimento;

		if (ie_classif_custo_w = '1' and qt_param_rep_258_w > 0 and length(r_c01_w.ds_justificativa) < qt_param_rep_258_w) then

				ds_log_step_w := 'STEP_24 '
					|| ' - ie_classif_custo_w: ' || ie_classif_custo_w
					|| ' - ds_justificativa: ' || r_c01_w.ds_justificativa
					|| ' - qt_param_rep_257_w: ' || qt_param_rep_257_w
					|| ' - LINE: ' || $$plsql_line;
				
				ds_retorno_p := 'N';
				goto return_value;
		end if;

		ie_param_rep_1057_w := Obter_param_Usuario(924, 1057, obter_perfil_ativo, wheb_usuario_pck.get_nm_usuario, wheb_usuario_pck.get_cd_estabelecimento, ie_param_rep_1057_w);

		select coalesce(max(a.ie_just_se_necessario), 'N')
		  into STRICT ie_just_se_necessario_w
		  from parametro_medico a
		 where a.cd_estabelecimento = wheb_usuario_pck.get_cd_estabelecimento;

		if ((r_c01_w.ie_administracao = 'N' and coalesce(r_c01_w.ds_justificativa::text, '') = '') and ((ie_param_rep_1057_w = 'S') or (ie_just_se_necessario_w = 'S'))) then
			ds_log_step_w := 'STEP_25 '
				|| ' - ie_administracao: ' || r_c01_w.ie_administracao
				|| ' - ds_justificativa: ' || r_c01_w.ds_justificativa
				|| ' - ie_param_rep_1057_w: ' || ie_param_rep_1057_w
				|| ' - ie_just_se_necessario_w: ' || ie_just_se_necessario_w
				|| ' - LINE: ' || $$plsql_line;

			ds_retorno_p := 'N';
		end if;


		SELECT * FROM cpoe_consist_regra_prescr_mat(r_c01_w.nr_atendimento, r_c01_w.cd_material, 'N', r_c01_w.ie_via_aplicacao, Obter_Tipo_Atendimento(r_c01_w.nr_atendimento), r_c01_w.cd_setor_atend, obter_perfil_ativo, Obter_Convenio_Atendimento(r_c01_w.nr_atendimento), wheb_usuario_pck.get_nm_usuario, wheb_usuario_pck.get_cd_estabelecimento, r_c01_w.cd_pessoa_fisica, r_c01_w.dt_inicio, ds_erro_w, ds_mensagem_w, ie_abortar_w, r_c01_w.cd_intervalo, r_c01_w.ie_duracao) INTO STRICT ds_erro_w, ds_mensagem_w, ie_abortar_w;

		if (ds_erro_w = 'S' and ie_abortar_w <> 'X') then
			if (ie_abortar_w = 'S') then
				
				ds_log_step_w := 'STEP_26 '
					|| ' - ds_erro_w: ' || ds_erro_w
					|| ' - ie_abortar_w: ' || ie_abortar_w
					|| ' - LINE: ' || $$plsql_line;
				
				ds_retorno_p := 'N';
				goto return_value;
			end if;
		end if;

		ie_param_rep_464_w := Obter_param_Usuario(924, 464, obter_perfil_ativo, wheb_usuario_pck.get_nm_usuario, wheb_usuario_pck.get_cd_estabelecimento, ie_param_rep_464_w);

		if ((r_c01_w.ie_administracao = 'N' or  r_c01_w.ie_administracao = 'C')
			and (coalesce(r_c01_w.ds_observacao::text, '') = '' and ie_param_rep_464_w = 'S')) then

			ds_log_step_w := 'STEP_27 '
				|| ' - ie_administracao: ' || r_c01_w.ie_administracao
				|| ' - ds_observacao: ' || r_c01_w.ds_observacao
				|| ' - ie_param_rep_464_w: ' || ie_param_rep_464_w
				|| ' - LINE: ' || $$plsql_line;
			
			ds_retorno_p := 'N';
			goto return_value;
		elsif (r_c01_w.ie_administracao = 'N' and coalesce(r_c01_w.ds_observacao::text, '') = '' and ie_param_rep_464_w = 'E') then

			ds_log_step_w := 'STEP_28 '
				|| ' - ie_administracao: ' || r_c01_w.ie_administracao
				|| ' - ds_observacao: ' || r_c01_w.ds_observacao
				|| ' - ie_param_rep_464_w: ' || ie_param_rep_464_w
				|| ' - LINE: ' || $$plsql_line;
			
			ds_retorno_p := 'N';
			goto return_value;
		elsif (r_c01_w.ie_administracao = 'C' and coalesce(r_c01_w.ds_observacao::text, '') = '' and ie_param_rep_464_w = 'A') then

			ds_log_step_w := 'STEP_29 '
				|| ' - ie_administracao: ' || r_c01_w.ie_administracao
				|| ' - ds_observacao: ' || r_c01_w.ds_observacao
				|| ' - ie_param_rep_464_w: ' || ie_param_rep_464_w
				|| ' - LINE: ' || $$plsql_line;
				
			ds_retorno_p := 'N';
			goto return_value;
		end if;
		-- FIM BEFORE PERFORM 

		-- CUSTOM VALIDATOR 
		if (coalesce(r_c01_w.ds_dose_diferenciada::text, '') = '' and ((coalesce(r_c01_w.qt_dose, 0) = 0)
			or ((r_c01_w.cd_mat_comp1 IS NOT NULL AND r_c01_w.cd_mat_comp1::text <> '') and coalesce(r_c01_w.qt_dose_comp1,0) = 0)
			or ((r_c01_w.cd_mat_comp2 IS NOT NULL AND r_c01_w.cd_mat_comp2::text <> '') and coalesce(r_c01_w.qt_dose_comp2,0) = 0)
			or ((r_c01_w.cd_mat_comp3 IS NOT NULL AND r_c01_w.cd_mat_comp3::text <> '') and coalesce(r_c01_w.qt_dose_comp3,0) = 0)
			or ((r_c01_w.cd_mat_comp4 IS NOT NULL AND r_c01_w.cd_mat_comp4::text <> '') and coalesce(r_c01_w.qt_dose_comp4,0) = 0)
			or ((r_c01_w.cd_mat_comp5 IS NOT NULL AND r_c01_w.cd_mat_comp5::text <> '') and coalesce(r_c01_w.qt_dose_comp5,0) = 0)
			or ((r_c01_w.cd_mat_comp6 IS NOT NULL AND r_c01_w.cd_mat_comp6::text <> '') and coalesce(r_c01_w.qt_dose_comp6,0) = 0)
			or ((r_c01_w.cd_mat_comp7 IS NOT NULL AND r_c01_w.cd_mat_comp7::text <> '') and coalesce(r_c01_w.qt_dose_comp7,0) = 0)
			or ((r_c01_w.cd_mat_dil IS NOT NULL AND r_c01_w.cd_mat_dil::text <> '') and coalesce(r_c01_w.qt_dose_dil,0) = 0)
			or ((r_c01_w.cd_mat_red IS NOT NULL AND r_c01_w.cd_mat_red::text <> '') and coalesce(r_c01_w.qt_dose_red,0) = 0)
			or ((r_c01_w.cd_mat_recons IS NOT NULL AND r_c01_w.cd_mat_recons::text <> '') and coalesce(r_c01_w.qt_dose_recons,0) = 0))) then

			ds_log_step_w := 'STEP_30 '
				|| ' - LINE: ' || $$plsql_line;
			
			ds_retorno_p := 'N';
			goto return_value;
		end if;

		select	max(ie_operacao)
		into STRICT	ie_operacao_w
		from	intervalo_prescricao
		where	cd_intervalo = r_c01_w.cd_intervalo;

		if (ie_operacao_w <> 'D' and ie_operacao_w <> 'F' and ie_operacao_w <> 'V') then

			if ((r_c01_w.dt_inicio < clock_timestamp() and
			     coalesce(r_c01_w.ie_urgencia::text, '') = '' and 
			     coalesce(ie_retrogrado_p,'N') = 'N') or 
			    r_c01_w.dt_inicio > r_c01_w.dt_fim) then

				ds_log_step_w := 'STEP_31 ' 
					|| ' - sysdate: ' || clock_timestamp()
					|| ' - ie_urgencia: ' || r_c01_w.ie_urgencia
					|| ' - ie_retrogrado_p: ' || ie_retrogrado_p
					|| ' - dt_inicio: ' || r_c01_w.dt_inicio
					|| ' - dt_fim: ' || r_c01_w.dt_fim
					|| ' - LINE: ' || $$plsql_line;

				ds_retorno_p := 'N';
				goto return_value;
			end if;

			if (ie_operacao_w = 'D' and position(to_char((to_char(r_c01_w.dt_inicio,'D'))::numeric - 1) in cpoe_obter_dias_semana_disp(r_c01_w.cd_intervalo)) = 0) then

				ds_log_step_w := 'STEP_32 '
					|| ' - ie_operacao_w: ' || ie_operacao_w
					|| ' - LINE: ' || $$plsql_line;

				ds_retorno_p := 'N';
				goto return_value;
			end if;
		end if;

		if (cpoe_shoppingcart_dose_dif(r_c01_w.ds_dose_diferenciada, r_c01_w.nr_etapas) = 'S'
			or cpoe_shoppingcart_dose_dif(r_c01_w.ds_dose_diferenciada_dil, r_c01_w.nr_etapas) = 'S'
			or cpoe_shoppingcart_dose_dif(r_c01_w.ds_dose_diferenciada_red, r_c01_w.nr_etapas) = 'S'
			or cpoe_shoppingcart_dose_dif(r_c01_w.ds_dose_diferenciada_rec, r_c01_w.nr_etapas) = 'S'
			or cpoe_shoppingcart_dose_dif(r_c01_w.ds_dose_diferenciada_comp1, r_c01_w.nr_etapas) = 'S'
			or cpoe_shoppingcart_dose_dif(r_c01_w.ds_dose_diferenciada_comp2, r_c01_w.nr_etapas) = 'S'
			or cpoe_shoppingcart_dose_dif(r_c01_w.ds_dose_diferenciada_comp3, r_c01_w.nr_etapas) = 'S'
			or cpoe_shoppingcart_dose_dif(r_c01_w.ds_dose_diferenciada_comp4, r_c01_w.nr_etapas) = 'S'
			or cpoe_shoppingcart_dose_dif(r_c01_w.ds_dose_diferenciada_comp5, r_c01_w.nr_etapas) = 'S'
			or cpoe_shoppingcart_dose_dif(r_c01_w.ds_dose_diferenciada_comp6, r_c01_w.nr_etapas) = 'S'
			or cpoe_shoppingcart_dose_dif(r_c01_w.ds_dose_diferenciada_comp7, r_c01_w.nr_etapas) = 'S') then

			ds_log_step_w := 'STEP_33 '
				|| ' - LINE: ' || $$plsql_line;

			ds_retorno_p := 'N';
			goto return_value;
		end if;
		-- FIM CUSTOM VALIDATOR 

		-- INCONSISTENCIA DA CPOE (BARRA VERMELHA)

		--DUPLICIDADE
		if (cpoe_shoppingcart_medic_duplic(r_c01_w.nr_sequencia, r_c01_w.cd_setor_atend, r_c01_w.cd_pessoa_fisica, r_c01_w.cd_material, r_c01_w.dt_inicio, r_c01_w.dt_fim) = 'S'
			or cpoe_shoppingcart_medic_duplic(r_c01_w.nr_sequencia, r_c01_w.cd_setor_atend, r_c01_w.cd_pessoa_fisica, r_c01_w.cd_mat_comp1, r_c01_w.dt_inicio, r_c01_w.dt_fim) = 'S'
			or cpoe_shoppingcart_medic_duplic(r_c01_w.nr_sequencia, r_c01_w.cd_setor_atend, r_c01_w.cd_pessoa_fisica, r_c01_w.cd_mat_comp2, r_c01_w.dt_inicio, r_c01_w.dt_fim) = 'S'
			or cpoe_shoppingcart_medic_duplic(r_c01_w.nr_sequencia, r_c01_w.cd_setor_atend, r_c01_w.cd_pessoa_fisica, r_c01_w.cd_mat_comp3, r_c01_w.dt_inicio, r_c01_w.dt_fim) = 'S'
			or cpoe_shoppingcart_medic_duplic(r_c01_w.nr_sequencia, r_c01_w.cd_setor_atend, r_c01_w.cd_pessoa_fisica, r_c01_w.cd_mat_comp4, r_c01_w.dt_inicio, r_c01_w.dt_fim) = 'S'
			or cpoe_shoppingcart_medic_duplic(r_c01_w.nr_sequencia, r_c01_w.cd_setor_atend, r_c01_w.cd_pessoa_fisica, r_c01_w.cd_mat_comp5, r_c01_w.dt_inicio, r_c01_w.dt_fim) = 'S'
			or cpoe_shoppingcart_medic_duplic(r_c01_w.nr_sequencia, r_c01_w.cd_setor_atend, r_c01_w.cd_pessoa_fisica, r_c01_w.cd_mat_comp6, r_c01_w.dt_inicio, r_c01_w.dt_fim) = 'S'
			or cpoe_shoppingcart_medic_duplic(r_c01_w.nr_sequencia, r_c01_w.cd_setor_atend, r_c01_w.cd_pessoa_fisica, r_c01_w.cd_mat_comp7, r_c01_w.dt_inicio, r_c01_w.dt_fim) = 'S') then

			ds_log_step_w := 'STEP_34 '
				|| ' - LINE: ' || $$plsql_line;
			
			ds_retorno_p := 'N';
			goto return_value;
		end if;
		--VIA NAO RECOMENDADA
		if (cpoe_obter_via_nao_recomendada(r_c01_w.cd_material, r_c01_w.ie_via_aplicacao) = 'S'
			or cpoe_obter_via_nao_recomendada(r_c01_w.cd_mat_comp1, r_c01_w.ie_via_aplicacao) = 'S'
			or cpoe_obter_via_nao_recomendada(r_c01_w.cd_mat_comp2, r_c01_w.ie_via_aplicacao) = 'S'
			or cpoe_obter_via_nao_recomendada(r_c01_w.cd_mat_comp3, r_c01_w.ie_via_aplicacao) = 'S'
			or cpoe_obter_via_nao_recomendada(r_c01_w.cd_mat_comp4, r_c01_w.ie_via_aplicacao) = 'S'
			or cpoe_obter_via_nao_recomendada(r_c01_w.cd_mat_comp5, r_c01_w.ie_via_aplicacao) = 'S'
			or cpoe_obter_via_nao_recomendada(r_c01_w.cd_mat_comp6, r_c01_w.ie_via_aplicacao) = 'S'
			or cpoe_obter_via_nao_recomendada(r_c01_w.cd_mat_comp7, r_c01_w.ie_via_aplicacao) = 'S'
			or obter_situacao_via_aplic(r_c01_w.ie_via_aplicacao)= 'I'	) then
			
			ds_log_step_w := 'STEP_35 '
				|| ' - LINE: ' || $$plsql_line;
			
			ds_retorno_p := 'N';
			goto return_value;
		end if;
		--ALERGIA
		SELECT * FROM cpoe_verifica_se_pac_alergico(r_c01_w.cd_pessoa_fisica, r_c01_w.cd_material, ie_return_value_w, ds_alergia_w, ie_severidade_w, nr_seq_reacao_w, 'N', nr_seq_ficha_tecnica_w) INTO STRICT ie_return_value_w, ds_alergia_w, ie_severidade_w, nr_seq_reacao_w, nr_seq_ficha_tecnica_w;

		if (ie_return_value_w = 'N') then
			SELECT * FROM cpoe_verifica_se_pac_alergico(r_c01_w.cd_pessoa_fisica, r_c01_w.cd_mat_comp1, ie_return_value_w, ds_alergia_w, ie_severidade_w, nr_seq_reacao_w, 'N', nr_seq_ficha_tecnica_w) INTO STRICT ie_return_value_w, ds_alergia_w, ie_severidade_w, nr_seq_reacao_w, nr_seq_ficha_tecnica_w;
		end if;

		if (ie_return_value_w = 'N') then
			SELECT * FROM cpoe_verifica_se_pac_alergico(r_c01_w.cd_pessoa_fisica, r_c01_w.cd_mat_comp2, ie_return_value_w, ds_alergia_w, ie_severidade_w, nr_seq_reacao_w, 'N', nr_seq_ficha_tecnica_w) INTO STRICT ie_return_value_w, ds_alergia_w, ie_severidade_w, nr_seq_reacao_w, nr_seq_ficha_tecnica_w;
		end if;

		if (ie_return_value_w = 'N') then
			SELECT * FROM cpoe_verifica_se_pac_alergico(r_c01_w.cd_pessoa_fisica, r_c01_w.cd_mat_comp3, ie_return_value_w, ds_alergia_w, ie_severidade_w, nr_seq_reacao_w, 'N', nr_seq_ficha_tecnica_w) INTO STRICT ie_return_value_w, ds_alergia_w, ie_severidade_w, nr_seq_reacao_w, nr_seq_ficha_tecnica_w;
		end if;

		if (ie_return_value_w = 'N') then
			SELECT * FROM cpoe_verifica_se_pac_alergico(r_c01_w.cd_pessoa_fisica, r_c01_w.cd_mat_comp4, ie_return_value_w, ds_alergia_w, ie_severidade_w, nr_seq_reacao_w, 'N', nr_seq_ficha_tecnica_w) INTO STRICT ie_return_value_w, ds_alergia_w, ie_severidade_w, nr_seq_reacao_w, nr_seq_ficha_tecnica_w;
		end if;

		if (ie_return_value_w = 'N') then
			SELECT * FROM cpoe_verifica_se_pac_alergico(r_c01_w.cd_pessoa_fisica, r_c01_w.cd_mat_comp5, ie_return_value_w, ds_alergia_w, ie_severidade_w, nr_seq_reacao_w, 'N', nr_seq_ficha_tecnica_w) INTO STRICT ie_return_value_w, ds_alergia_w, ie_severidade_w, nr_seq_reacao_w, nr_seq_ficha_tecnica_w;
		end if;

		if (ie_return_value_w = 'N') then
			SELECT * FROM cpoe_verifica_se_pac_alergico(r_c01_w.cd_pessoa_fisica, r_c01_w.cd_mat_comp6, ie_return_value_w, ds_alergia_w, ie_severidade_w, nr_seq_reacao_w, 'N', nr_seq_ficha_tecnica_w) INTO STRICT ie_return_value_w, ds_alergia_w, ie_severidade_w, nr_seq_reacao_w, nr_seq_ficha_tecnica_w;
		end if;

		if (ie_return_value_w = 'N') then
			SELECT * FROM cpoe_verifica_se_pac_alergico(r_c01_w.cd_pessoa_fisica, r_c01_w.cd_mat_comp7, ie_return_value_w, ds_alergia_w, ie_severidade_w, nr_seq_reacao_w, 'N', nr_seq_ficha_tecnica_w) INTO STRICT ie_return_value_w, ds_alergia_w, ie_severidade_w, nr_seq_reacao_w, nr_seq_ficha_tecnica_w;
		end if;

		if (ie_return_value_w = 'S') then
			
			ds_log_step_w := 'STEP_36 '
				|| ' - LINE: ' || $$plsql_line;
			
			ds_retorno_p := 'N';
			goto return_value;
		end if;
		--INTERACAO FARMACO X FARMACO
		if (cpoe_obter_se_interacao_medic(r_c01_w.cd_material, r_c01_w.nr_atendimento, r_c01_w.cd_pessoa_fisica, r_c01_w.nr_sequencia) = 'S'
			or cpoe_obter_se_interacao_medic(r_c01_w.cd_mat_comp1, r_c01_w.nr_atendimento, r_c01_w.cd_pessoa_fisica, r_c01_w.nr_sequencia) = 'S'
			or cpoe_obter_se_interacao_medic(r_c01_w.cd_mat_comp2, r_c01_w.nr_atendimento, r_c01_w.cd_pessoa_fisica, r_c01_w.nr_sequencia) = 'S'
			or cpoe_obter_se_interacao_medic(r_c01_w.cd_mat_comp3, r_c01_w.nr_atendimento, r_c01_w.cd_pessoa_fisica, r_c01_w.nr_sequencia) = 'S'
			or cpoe_obter_se_interacao_medic(r_c01_w.cd_mat_comp4, r_c01_w.nr_atendimento, r_c01_w.cd_pessoa_fisica, r_c01_w.nr_sequencia) = 'S'
			or cpoe_obter_se_interacao_medic(r_c01_w.cd_mat_comp5, r_c01_w.nr_atendimento, r_c01_w.cd_pessoa_fisica, r_c01_w.nr_sequencia) = 'S'
			or cpoe_obter_se_interacao_medic(r_c01_w.cd_mat_comp6, r_c01_w.nr_atendimento, r_c01_w.cd_pessoa_fisica, r_c01_w.nr_sequencia) = 'S'
			or cpoe_obter_se_interacao_medic(r_c01_w.cd_mat_comp7, r_c01_w.nr_atendimento, r_c01_w.cd_pessoa_fisica, r_c01_w.nr_sequencia) = 'S') then
			
			ds_log_step_w := 'STEP_37 '
				|| ' - LINE: ' || $$plsql_line;

			ds_retorno_p := 'N';
			goto return_value;
		end if;
		--LACTANTE
		if (obter_se_permite_lactante(r_c01_w.nr_atendimento, r_c01_w.cd_material) = 'N'
			or obter_se_permite_lactante(r_c01_w.nr_atendimento, r_c01_w.cd_mat_comp1) = 'N'
			or obter_se_permite_lactante(r_c01_w.nr_atendimento, r_c01_w.cd_mat_comp2) = 'N'
			or obter_se_permite_lactante(r_c01_w.nr_atendimento, r_c01_w.cd_mat_comp3) = 'N'
			or obter_se_permite_lactante(r_c01_w.nr_atendimento, r_c01_w.cd_mat_comp4) = 'N'
			or obter_se_permite_lactante(r_c01_w.nr_atendimento, r_c01_w.cd_mat_comp5) = 'N'
			or obter_se_permite_lactante(r_c01_w.nr_atendimento, r_c01_w.cd_mat_comp6) = 'N'
			or obter_se_permite_lactante(r_c01_w.nr_atendimento, r_c01_w.cd_mat_comp7) = 'N') then
			
			ds_log_step_w := 'STEP_38 '
				|| ' - LINE: ' || $$plsql_line;
			
			ds_retorno_p := 'N';
			goto return_value;
		end if;
		--INTERACAO FARMACO X NUTRICAO
		if (cpoe_se_mat_interacao_alim(r_c01_w.cd_material, r_c01_w.nr_atendimento, r_c01_w.cd_pessoa_fisica) = 'S'
			or cpoe_se_mat_interacao_alim(r_c01_w.cd_mat_comp1, r_c01_w.nr_atendimento, r_c01_w.cd_pessoa_fisica) = 'S'
			or cpoe_se_mat_interacao_alim(r_c01_w.cd_mat_comp2, r_c01_w.nr_atendimento, r_c01_w.cd_pessoa_fisica) = 'S'
			or cpoe_se_mat_interacao_alim(r_c01_w.cd_mat_comp3, r_c01_w.nr_atendimento, r_c01_w.cd_pessoa_fisica) = 'S'
			or cpoe_se_mat_interacao_alim(r_c01_w.cd_mat_comp4, r_c01_w.nr_atendimento, r_c01_w.cd_pessoa_fisica) = 'S'
			or cpoe_se_mat_interacao_alim(r_c01_w.cd_mat_comp5, r_c01_w.nr_atendimento, r_c01_w.cd_pessoa_fisica) = 'S'
			or cpoe_se_mat_interacao_alim(r_c01_w.cd_mat_comp6, r_c01_w.nr_atendimento, r_c01_w.cd_pessoa_fisica) = 'S'
			or cpoe_se_mat_interacao_alim(r_c01_w.cd_mat_comp7, r_c01_w.nr_atendimento, r_c01_w.cd_pessoa_fisica) = 'S') then
			
			ds_log_step_w := 'STEP_39 '
				|| ' - LINE: ' || $$plsql_line;
			
			ds_retorno_p := 'N';
			goto return_value;
		end if;
		--NAO PADRONIZADO
		if (cpoe_obter_se_mat_padronizado(wheb_usuario_pck.get_cd_estabelecimento, r_c01_w.cd_material, r_c01_w.ie_medicacao_paciente) = 'N'
			or cpoe_obter_se_mat_padronizado(wheb_usuario_pck.get_cd_estabelecimento, r_c01_w.cd_mat_comp1, r_c01_w.ie_medicacao_paciente) = 'N'
			or cpoe_obter_se_mat_padronizado(wheb_usuario_pck.get_cd_estabelecimento, r_c01_w.cd_mat_comp2, r_c01_w.ie_medicacao_paciente) = 'N'
			or cpoe_obter_se_mat_padronizado(wheb_usuario_pck.get_cd_estabelecimento, r_c01_w.cd_mat_comp3, r_c01_w.ie_medicacao_paciente) = 'N'
			or cpoe_obter_se_mat_padronizado(wheb_usuario_pck.get_cd_estabelecimento, r_c01_w.cd_mat_comp4, r_c01_w.ie_medicacao_paciente) = 'N'
			or cpoe_obter_se_mat_padronizado(wheb_usuario_pck.get_cd_estabelecimento, r_c01_w.cd_mat_comp5, r_c01_w.ie_medicacao_paciente) = 'N'
			or cpoe_obter_se_mat_padronizado(wheb_usuario_pck.get_cd_estabelecimento, r_c01_w.cd_mat_comp6, r_c01_w.ie_medicacao_paciente) = 'N') then
			
			ds_log_step_w := 'STEP_40 '
				|| ' - LINE: ' || $$plsql_line;
			
			ds_retorno_p := 'N';
			goto return_value;
		end if;
		--LATEX
		if (cpoe_shoppingcart_se_latex(r_c01_w.cd_material, r_c01_w.cd_pessoa_fisica) = 'S'
			or cpoe_shoppingcart_se_latex(r_c01_w.cd_mat_comp1, r_c01_w.cd_pessoa_fisica) = 'S'
			or cpoe_shoppingcart_se_latex(r_c01_w.cd_mat_comp2, r_c01_w.cd_pessoa_fisica) = 'S'
			or cpoe_shoppingcart_se_latex(r_c01_w.cd_mat_comp3, r_c01_w.cd_pessoa_fisica) = 'S'
			or cpoe_shoppingcart_se_latex(r_c01_w.cd_mat_comp4, r_c01_w.cd_pessoa_fisica) = 'S'
			or cpoe_shoppingcart_se_latex(r_c01_w.cd_mat_comp5, r_c01_w.cd_pessoa_fisica) = 'S'
			or cpoe_shoppingcart_se_latex(r_c01_w.cd_mat_comp6, r_c01_w.cd_pessoa_fisica) = 'S'
			or cpoe_shoppingcart_se_latex(r_c01_w.cd_mat_comp7, r_c01_w.cd_pessoa_fisica) = 'S') then

			ds_log_step_w := 'STEP_41 '
				|| ' - LINE: ' || $$plsql_line;
			
			ds_retorno_p := 'N';
			goto return_value;
		end if;
		-- DOSE MIN E MAX 
		qt_volume_final_w := cpoe_obter_volume_total(r_c01_w.cd_material, r_c01_w.qt_dose, r_c01_w.cd_unidade_medida,
					r_c01_w.cd_mat_dil, r_c01_w.qt_dose_dil, r_c01_w.cd_unid_med_dose_dil, 
					r_c01_w.qt_solucao_red,
					r_c01_w.cd_mat_red, r_c01_w.qt_dose_red, r_c01_w.cd_unid_med_dose_red, 
					r_c01_w.cd_mat_comp1, r_c01_w.qt_dose_comp1, r_c01_w.cd_unid_med_dose_comp1, 
					r_c01_w.cd_mat_comp2, r_c01_w.qt_dose_comp2,r_c01_w.cd_unid_med_dose_comp2,
					r_c01_w.cd_mat_comp3, r_c01_w.qt_dose_comp3, r_c01_w.cd_unid_med_dose_comp3,
					r_c01_w.cd_mat_comp4, r_c01_w.qt_dose_comp4, r_c01_w.cd_unid_med_dose_comp4,
					r_c01_w.cd_mat_comp5, r_c01_w.qt_dose_comp5, r_c01_w.cd_unid_med_dose_comp5,
					r_c01_w.cd_mat_comp6, r_c01_w.qt_dose_comp6, r_c01_w.cd_unid_med_dose_comp6,
					r_c01_w.cd_mat_comp7, r_c01_w.qt_dose_comp7, r_c01_w.cd_unid_med_dose_comp7,					
					r_c01_w.nr_seq_mat_diluicao, r_c01_w.cd_pessoa_fisica, r_c01_w.nr_atendimento, r_c01_w.ie_via_aplicacao );

		SELECT * FROM cpoe_shoppingcart_dose_max_min(r_c01_w.nr_atendimento, r_c01_w.nr_sequencia, 'MAT', r_c01_w.cd_material, r_c01_w.qt_dose, r_c01_w.ds_dose_diferenciada, r_c01_w.cd_unidade_medida, r_c01_w.ie_via_aplicacao, r_c01_w.cd_pessoa_fisica, r_c01_w.cd_intervalo, r_c01_w.nr_etapas, r_c01_w.hr_min_aplicacao, r_c01_w.qt_tempo_aplicacao, r_c01_w.ie_controle_tempo, r_c01_w.ie_tipo_solucao, r_c01_w.qt_hora_fase, r_c01_w.qt_solucao, qt_volume_final_w, r_c01_w.dt_inicio, r_c01_w.dt_fim, r_c01_w.ie_duracao, r_c01_w.ds_horarios, r_c01_w.ie_urgencia, 'A') INTO STRICT nr_return_value_w, active_ingred_consist_w;

		if (coalesce(nr_return_value_w::text, '') = '' or nr_return_value_w = 0) then
			SELECT * FROM cpoe_shoppingcart_dose_max_min(r_c01_w.nr_atendimento, r_c01_w.nr_sequencia, 'MCOMP1', r_c01_w.cd_mat_comp1, r_c01_w.qt_dose_comp1, r_c01_w.ds_dose_diferenciada_comp1, r_c01_w.cd_unid_med_dose_comp1, r_c01_w.ie_via_aplicacao, r_c01_w.cd_pessoa_fisica, r_c01_w.cd_intervalo, r_c01_w.nr_etapas, r_c01_w.hr_min_aplicacao, r_c01_w.qt_tempo_aplicacao, r_c01_w.ie_controle_tempo, r_c01_w.ie_tipo_solucao, r_c01_w.qt_hora_fase, r_c01_w.qt_solucao, qt_volume_final_w, r_c01_w.dt_inicio, r_c01_w.dt_fim, r_c01_w.ie_duracao, r_c01_w.ds_horarios, r_c01_w.ie_urgencia, 'A') INTO STRICT nr_return_value_w, active_ingred_consist_w;
		end if;

		if (coalesce(nr_return_value_w::text, '') = '' or nr_return_value_w = 0) then
			SELECT * FROM cpoe_shoppingcart_dose_max_min(r_c01_w.nr_atendimento, r_c01_w.nr_sequencia, 'MCOMP2', r_c01_w.cd_mat_comp2, r_c01_w.qt_dose_comp2, r_c01_w.ds_dose_diferenciada_comp2, r_c01_w.cd_unid_med_dose_comp2, r_c01_w.ie_via_aplicacao, r_c01_w.cd_pessoa_fisica, r_c01_w.cd_intervalo, r_c01_w.nr_etapas, r_c01_w.hr_min_aplicacao, r_c01_w.qt_tempo_aplicacao, r_c01_w.ie_controle_tempo, r_c01_w.ie_tipo_solucao, r_c01_w.qt_hora_fase, r_c01_w.qt_solucao, qt_volume_final_w, r_c01_w.dt_inicio, r_c01_w.dt_fim, r_c01_w.ie_duracao, r_c01_w.ds_horarios, r_c01_w.ie_urgencia, 'A') INTO STRICT nr_return_value_w, active_ingred_consist_w;
		end if;

		if (coalesce(nr_return_value_w::text, '') = '' or nr_return_value_w = 0) then
			SELECT * FROM cpoe_shoppingcart_dose_max_min(r_c01_w.nr_atendimento, r_c01_w.nr_sequencia, 'MCOMP3', r_c01_w.cd_mat_comp3, r_c01_w.qt_dose_comp3, r_c01_w.ds_dose_diferenciada_comp3, r_c01_w.cd_unid_med_dose_comp3, r_c01_w.ie_via_aplicacao, r_c01_w.cd_pessoa_fisica, r_c01_w.cd_intervalo, r_c01_w.nr_etapas, r_c01_w.hr_min_aplicacao, r_c01_w.qt_tempo_aplicacao, r_c01_w.ie_controle_tempo, r_c01_w.ie_tipo_solucao, r_c01_w.qt_hora_fase, r_c01_w.qt_solucao, qt_volume_final_w, r_c01_w.dt_inicio, r_c01_w.dt_fim, r_c01_w.ie_duracao, r_c01_w.ds_horarios, r_c01_w.ie_urgencia, 'A') INTO STRICT nr_return_value_w, active_ingred_consist_w;
		end if;

		if (coalesce(nr_return_value_w::text, '') = '' or nr_return_value_w = 0) then
			SELECT * FROM cpoe_shoppingcart_dose_max_min(r_c01_w.nr_atendimento, r_c01_w.nr_sequencia, 'MCOMP4', r_c01_w.cd_mat_comp4, r_c01_w.qt_dose_comp4, r_c01_w.ds_dose_diferenciada_comp4, r_c01_w.cd_unid_med_dose_comp4, r_c01_w.ie_via_aplicacao, r_c01_w.cd_pessoa_fisica, r_c01_w.cd_intervalo, r_c01_w.nr_etapas, r_c01_w.hr_min_aplicacao, r_c01_w.qt_tempo_aplicacao, r_c01_w.ie_controle_tempo, r_c01_w.ie_tipo_solucao, r_c01_w.qt_hora_fase, r_c01_w.qt_solucao, qt_volume_final_w, r_c01_w.dt_inicio, r_c01_w.dt_fim, r_c01_w.ie_duracao, r_c01_w.ds_horarios, r_c01_w.ie_urgencia, 'A') INTO STRICT nr_return_value_w, active_ingred_consist_w;
		end if;

		if (coalesce(nr_return_value_w::text, '') = '' or nr_return_value_w = 0) then
			SELECT * FROM cpoe_shoppingcart_dose_max_min(r_c01_w.nr_atendimento, r_c01_w.nr_sequencia, 'MCOMP5', r_c01_w.cd_mat_comp5, r_c01_w.qt_dose_comp5, r_c01_w.ds_dose_diferenciada_comp5, r_c01_w.cd_unid_med_dose_comp5, r_c01_w.ie_via_aplicacao, r_c01_w.cd_pessoa_fisica, r_c01_w.cd_intervalo, r_c01_w.nr_etapas, r_c01_w.hr_min_aplicacao, r_c01_w.qt_tempo_aplicacao, r_c01_w.ie_controle_tempo, r_c01_w.ie_tipo_solucao, r_c01_w.qt_hora_fase, r_c01_w.qt_solucao, qt_volume_final_w, r_c01_w.dt_inicio, r_c01_w.dt_fim, r_c01_w.ie_duracao, r_c01_w.ds_horarios, r_c01_w.ie_urgencia, 'A') INTO STRICT nr_return_value_w, active_ingred_consist_w;
		end if;

		if (coalesce(nr_return_value_w::text, '') = '' or nr_return_value_w = 0) then
			SELECT * FROM cpoe_shoppingcart_dose_max_min(r_c01_w.nr_atendimento, r_c01_w.nr_sequencia, 'MCOMP6', r_c01_w.cd_mat_comp6, r_c01_w.qt_dose_comp6, r_c01_w.ds_dose_diferenciada_comp6, r_c01_w.cd_unid_med_dose_comp6, r_c01_w.ie_via_aplicacao, r_c01_w.cd_pessoa_fisica, r_c01_w.cd_intervalo, r_c01_w.nr_etapas, r_c01_w.hr_min_aplicacao, r_c01_w.qt_tempo_aplicacao, r_c01_w.ie_controle_tempo, r_c01_w.ie_tipo_solucao, r_c01_w.qt_hora_fase, r_c01_w.qt_solucao, qt_volume_final_w, r_c01_w.dt_inicio, r_c01_w.dt_fim, r_c01_w.ie_duracao, r_c01_w.ds_horarios, r_c01_w.ie_urgencia, 'A') INTO STRICT nr_return_value_w, active_ingred_consist_w;
		end if;

		if (coalesce(nr_return_value_w::text, '') = '' or nr_return_value_w = 0) then
			SELECT * FROM cpoe_shoppingcart_dose_max_min(r_c01_w.nr_atendimento, r_c01_w.nr_sequencia, 'MCOMP7', r_c01_w.cd_mat_comp6, r_c01_w.qt_dose_comp7, r_c01_w.ds_dose_diferenciada_comp7, r_c01_w.cd_unid_med_dose_comp7, r_c01_w.ie_via_aplicacao, r_c01_w.cd_pessoa_fisica, r_c01_w.cd_intervalo, r_c01_w.nr_etapas, r_c01_w.hr_min_aplicacao, r_c01_w.qt_tempo_aplicacao, r_c01_w.ie_controle_tempo, r_c01_w.ie_tipo_solucao, r_c01_w.qt_hora_fase, r_c01_w.qt_solucao, qt_volume_final_w, r_c01_w.dt_inicio, r_c01_w.dt_fim, r_c01_w.ie_duracao, r_c01_w.ds_horarios, r_c01_w.ie_urgencia, 'A') INTO STRICT nr_return_value_w, active_ingred_consist_w;
		end if;

		if ((nr_return_value_w IS NOT NULL AND nr_return_value_w::text <> '') and nr_return_value_w > 0) then
		
			ds_log_step_w := 'STEP_42 '
				|| ' - LINE: ' || $$plsql_line;

			ds_retorno_p := 'N';
			goto return_value;
		end if;
        -- BLOQUEIO DE MEDICAMENTO POR CID         
        if (cpoe_shoppingcart_regra_cid(r_c01_w.nr_atendimento, wheb_usuario_pck.get_cd_estabelecimento, obter_perfil_ativo, r_c01_w.cd_material) = 'S'		
			or cpoe_shoppingcart_regra_cid(r_c01_w.nr_atendimento, wheb_usuario_pck.get_cd_estabelecimento, obter_perfil_ativo, r_c01_w.cd_mat_comp1) = 'S'
			or cpoe_shoppingcart_regra_cid(r_c01_w.nr_atendimento, wheb_usuario_pck.get_cd_estabelecimento, obter_perfil_ativo, r_c01_w.cd_mat_comp2) = 'S'
			or cpoe_shoppingcart_regra_cid(r_c01_w.nr_atendimento, wheb_usuario_pck.get_cd_estabelecimento, obter_perfil_ativo, r_c01_w.cd_mat_comp3) = 'S'
			or cpoe_shoppingcart_regra_cid(r_c01_w.nr_atendimento, wheb_usuario_pck.get_cd_estabelecimento, obter_perfil_ativo, r_c01_w.cd_mat_comp4) = 'S'
			or cpoe_shoppingcart_regra_cid(r_c01_w.nr_atendimento, wheb_usuario_pck.get_cd_estabelecimento, obter_perfil_ativo, r_c01_w.cd_mat_comp5) = 'S'
			or cpoe_shoppingcart_regra_cid(r_c01_w.nr_atendimento, wheb_usuario_pck.get_cd_estabelecimento, obter_perfil_ativo, r_c01_w.cd_mat_comp6) = 'S'
			or cpoe_shoppingcart_regra_cid(r_c01_w.nr_atendimento, wheb_usuario_pck.get_cd_estabelecimento, obter_perfil_ativo, r_c01_w.cd_mat_comp7) = 'S') then
			
			ds_log_step_w := 'STEP_43 '
				|| ' - LINE: ' || $$plsql_line;
			
			ds_retorno_p := 'N';
			goto return_value;
		end if;
		
		if (coalesce(r_c01_w.hr_min_aplicacao::text, '') = '' and
		    (r_c01_w.ie_via_aplicacao IS NOT NULL AND r_c01_w.ie_via_aplicacao::text <> '')) then

			select 	coalesce(max('S'),'N')
			into STRICT 	ie_obriga_tempo_aplic_w
			from 	material
			where 	cd_material = r_c01_w.cd_material
			and 	coalesce(ie_obriga_tempo_aplic,'N') = 'S';

			select	coalesce(max('S'),'N')
			into STRICT	ie_via_endovenosa_w
			from 	via_aplicacao
			where 	ie_via_aplicacao = r_c01_w.ie_via_aplicacao
			and 	coalesce(ie_endovenosa,'N') = 'S';

			if (ie_obriga_tempo_aplic_w = 'S' and ie_via_endovenosa_w = 'S') then

				ds_log_step_w := 'STEP_44 '
					|| ' - LINE: ' || $$plsql_line;

				ds_retorno_p := 'N';
				goto return_value;
			end if;		
		end if;
		
		--	MAXIMUM DOSE
		ie_return_value_w := verify_rule_dose_time_mat(r_c01_w.cd_material, r_c01_w.qt_dose, r_c01_w.nr_etapas, r_c01_w.cd_intervalo, r_c01_w.cd_unidade_medida);

		if (ie_return_value_w <> 'N') then
			ds_retorno_p := 'N';
			goto return_value;
		end if;
		
		-- INSTRUCT RESTRICT
  	instruct_restrict_w := cpoe_get_instruct_restrict(nr_sequencia_p, r_c01_w.cd_material, r_c01_w.dt_inicio, wheb_usuario_pck.get_cd_estabelecimento);
		while (ds_retorno_p <> 'N' AND instruct_restrict_w IS NOT NULL AND instruct_restrict_w::text <> '')
		loop
			si_action := SUBSTR(instruct_restrict_w, position(':' in instruct_restrict_w)+1, 1);
			if (trim(both upper(si_action)) <> 'Y') then
				ds_log_step_w := 'STEP_45 '
					|| ' - LINE: ' || $$plsql_line;

				ds_retorno_p := 'N';
			end if;
			instruct_restrict_w := SUBSTR(instruct_restrict_w, position(',' in instruct_restrict_w)+1);
		end loop;

        -- SPLITTING
        is_split_w := OBTER_SE_PERMITE_PARTIR(r_c01_w.cd_material, r_c01_w.qt_dose, r_c01_w.cd_unidade_medida);
        if (is_split_w <> 'S') then
				ds_log_step_w := 'STEP_46 '
					|| ' - LINE: ' || $$plsql_line;
            ds_retorno_p := 'N';
        end if;
	SELECT
		max(si_type_of_prescription) ,
		max(si_cpoe_type_of_item)
	INTO STRICT
		si_presctype_w,
		si_itemtype_w
	FROM
		cpoe_order_unit
	WHERE
		nr_sequencia = r_c01_w.nr_seq_cpoe_order_unit;

	IF ( si_presctype_w = 'BRME' AND si_itemtype_w = 'M' ) THEN
		ds_log_step_w := 'STEP_47 '
						 || ' - LINE: '
						 || $$plsql_line;
		ds_retorno_p := 'N';
	END IF;

		-- FIM INCONSISTENCIA DA CPOE (BARRA VERMELHA) 
	end loop;
end if;

<<return_value>>

	if (ds_retorno_p = 'N' AND ds_log_step_w IS NOT NULL AND ds_log_step_w::text <> '') then
		ie_info_rastre_prescr_w := obter_se_info_rastre_prescr('O', wheb_usuario_pck.get_nm_usuario, obter_perfil_ativo, wheb_usuario_pck.get_cd_estabelecimento);

		if (ie_info_rastre_prescr_w = 'S') then
			CALL gravar_log_cpoe(
				substr('CPOE_SHOPPINGCART_MEDICINE:' || ds_log_step_w, 1, 2000),
				nr_atendimento_w,
				'M',
				nr_sequencia_p
			);
			commit;
		end if;
	end if;

exception when others then
	CALL gravar_log_cpoe(substr('CPOE_SHOPPINGCART_MEDICINE EXCEPTION:'|| substr(to_char(sqlerrm),1,2000) || '//nr_sequencia_p: '|| nr_sequencia_p,1,40000));
	ds_retorno_p := 'N';
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cpoe_shoppingcart_medicine (nr_sequencia_p bigint, ie_retrogrado_p text, ds_retorno_p INOUT text) FROM PUBLIC;

