-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE restore_icd () AS $body$
DECLARE


-----------table icd_code_index_jpn
CD_INDEX_TERM_W                 icd_code_index_jpn.CD_INDEX_TERM%TYPE;
CD_TERM_CODES_W                 icd_code_index_jpn.CD_TERM_CODES%TYPE;
NR_DISEASE_MODIFIER_W           icd_code_index_jpn.NR_DISEASE_MODIFIER%TYPE;
NR_KANA_KANJI_W                 icd_code_index_jpn.NR_KANA_KANJI%TYPE;
NR_SYNONYMS_W                   icd_code_index_jpn.NR_SYNONYMS%TYPE;
NR_TYPOGRAPHY_W                 icd_code_index_jpn.NR_TYPOGRAPHY%TYPE;
NR_ADOPTED_CATEGORY_INDEX_W           icd_code_index_jpn.NR_ADOPTED_CATEGORY%TYPE;
NR_LANG_CLASSIF_W               icd_code_index_jpn.NR_LANG_CLASSIF%TYPE;
NR_OMITTED_INDICATOR_W          icd_code_index_jpn.NR_OMITTED_INDICATOR%TYPE;
DT_ATUALIZACAO_INDEX_W                icd_code_index_jpn.DT_ATUALIZACAO%TYPE;
NM_USUARIO_INDEX_W                    icd_code_index_jpn.NM_USUARIO%TYPE;
DT_ATUALIZACAO_NREC_INDEX_W           icd_code_index_jpn.DT_ATUALIZACAO_NREC%TYPE;
NM_USUARIO_NREC_INDEX_W               icd_code_index_jpn.NM_USUARIO_NREC%TYPE;
IE_SITUACAO_INDEX_W                   icd_code_index_jpn.IE_SITUACAO%TYPE;

------------table icd_code_modifier_jpn
NR_CHNG_SEGM_MDFY_W                       icd_code_modifier_jpn.NR_CHNG_SEGM%TYPE;
DS_KANA_NOTATION_W                   icd_code_modifier_jpn.DS_KANA_NOTATION%TYPE;
DS_EXCHANGE_CODE_W                   icd_code_modifier_jpn.DS_EXCHANGE_CODE%TYPE;
CD_MODIFIER_W                        icd_code_modifier_jpn.CD_MODIFIER%TYPE;
DS_MODIFIER_W                        icd_code_modifier_jpn.DS_MODIFIER%TYPE;
DT_ATUALIZACAO_MDFY_W                     icd_code_modifier_jpn.DT_ATUALIZACAO%TYPE;
NM_USUARIO_MDFY_W                         icd_code_modifier_jpn.NM_USUARIO%TYPE;
DT_ATUALIZACAO_NREC_MDFY_W                icd_code_modifier_jpn.DT_ATUALIZACAO_NREC%TYPE;
NM_USUARIO_NREC_MDFY_W                    icd_code_modifier_jpn.NM_USUARIO_NREC%TYPE;
NR_MODIFIER_MGMT_NUM_W               icd_code_modifier_jpn.NR_MODIFIER_MGMT_NUM%TYPE;
DS_MODIFIER_NOTATION_W               icd_code_modifier_jpn.DS_MODIFIER_NOTATION%TYPE;
NR_LOCATION_SEGMENT_W                icd_code_modifier_jpn.NR_LOCATION_SEGMENT%TYPE;
NR_GROUP_CODES_W                     icd_code_modifier_jpn.NR_GROUP_CODES%TYPE;
NR_RECEIPT_COMPUTER_CODES_W          icd_code_modifier_jpn.NR_RECEIPT_COMPUTER_CODES%TYPE;
IE_SITUACAO_MDFY_W                        icd_code_modifier_jpn.IE_SITUACAO%TYPE;

-------------table icd_codes_main_jpn
DT_ATUALIZACAO_W                    icd_codes_main_jpn.DT_ATUALIZACAO%TYPE;
NM_USUARIO_W                        icd_codes_main_jpn.NM_USUARIO%TYPE;
DT_ATUALIZACAO_NREC_W               icd_codes_main_jpn.DT_ATUALIZACAO_NREC%TYPE;
NM_USUARIO_NREC_W                   icd_codes_main_jpn.NM_USUARIO_NREC%TYPE;
NR_CHNG_SEGM_W                      icd_codes_main_jpn.NR_CHNG_SEGM%TYPE;
NR_DISEASE_NUMBER_W                 icd_codes_main_jpn.NR_DISEASE_NUMBER%TYPE;
DS_DISEASE_NAME_W                   icd_codes_main_jpn.DS_DISEASE_NAME%TYPE;
DS_NAME_OF_CANA_DISEASE_W           icd_codes_main_jpn.DS_NAME_OF_CANA_DISEASE%TYPE;
NR_ADOPTED_CATEGORY_W               icd_codes_main_jpn.NR_ADOPTED_CATEGORY%TYPE;
NR_CODE_EXCHANGE_W                  icd_codes_main_jpn.NR_CODE_EXCHANGE%TYPE;
CD_ICD_CODE_W                       icd_codes_main_jpn.CD_ICD_CODE%TYPE;
CD_MULTICLASSIF_CODE_W              icd_codes_main_jpn.CD_MULTICLASSIF_CODE%TYPE;
DS_PRELIMINARY1_W                   icd_codes_main_jpn.DS_PRELIMINARY1%TYPE;
DS_PRELIMINARY2_W                   icd_codes_main_jpn.DS_PRELIMINARY2%TYPE;
NR_RECEIPT_COMPUTER_CODE_W          icd_codes_main_jpn.NR_RECEIPT_COMPUTER_CODE%TYPE;
NR_AREA_OF_USE_W                    icd_codes_main_jpn.NR_AREA_OF_USE%TYPE;
NR_CHANGE_HISTORY_W                 icd_codes_main_jpn.NR_CHANGE_HISTORY%TYPE;
DT_UPDATE_W                         RESTORE_ICD_CODES_MAIN_JPN.DT_UPDATE%TYPE;
NR_DSTN_DISEASE_NUMBER_W            icd_codes_main_jpn.NR_DSTN_DISEASE_NUMBER%TYPE;
IE_PROHIBITED_CATEGORY_W            icd_codes_main_jpn.IE_PROHIBITED_CATEGORY%TYPE;
IE_OUT_OF_INSURANCE_W               icd_codes_main_jpn.IE_OUT_OF_INSURANCE%TYPE;
DS_PRELIMINARY3_W                   icd_codes_main_jpn.DS_PRELIMINARY3%TYPE;
DS_PRELIMINARY4_W                   icd_codes_main_jpn.DS_PRELIMINARY4%TYPE;
DS_OMITED_DISEASE_NAME_W            icd_codes_main_jpn.DS_OMITED_DISEASE_NAME%TYPE;
IE_SITUACAO_W                       icd_codes_main_jpn.IE_SITUACAO%TYPE;

qt_modifier      bigint;
qt_index         bigint;
qt_code          bigint;

C01 CURSOR FOR
SELECT
                            dt_atualizacao,
                            nm_usuario,
                            dt_atualizacao_nrec,
                            nm_usuario_nrec,
                            nr_chng_segm,
                            nr_disease_number,
                            ds_disease_name,
                            ds_name_of_cana_disease,
                            nr_adopted_category,
                            nr_code_exchange,
                            cd_icd_code,
                            cd_multiclassif_code,
                            ds_preliminary1,
                            ds_preliminary2,
                            nr_receipt_computer_code,
                            nr_area_of_use,
                            nr_change_history,
                            dt_update,
                            nr_dstn_disease_number,
                            ie_prohibited_category,
                            ie_out_of_insurance,
                            ds_preliminary3,
                            ds_preliminary4,
                            ds_omited_disease_name
    FROM
        RESTORE_ICD_CODES_MAIN_JPN;

c02 CURSOR FOR
SELECT
        NR_CHNG_SEGM,                           
        DS_KANA_NOTATION,                    
        DS_EXCHANGE_CODE,                    
        CD_MODIFIER,                          
        DS_MODIFIER,                         
        DT_ATUALIZACAO,                      
        NM_USUARIO,                  
        DT_ATUALIZACAO_NREC,                         
        NM_USUARIO_NREC,                      
        NR_MODIFIER_MGMT_NUM,                   
        DS_MODIFIER_NOTATION,                
        NR_LOCATION_SEGMENT,                     
        NR_GROUP_CODES,                       
        NR_RECEIPT_COMPUTER_CODES
    FROM
        RESTORE_ICD_CODE_MODIF_JPN;

c03 CURSOR FOR
SELECT
        cd_index_term,
        cd_term_codes,
        nr_disease_modifier,
        nr_kana_kanji,
        nr_synonyms,
        nr_typography,
        nr_adopted_category,
        nr_lang_classif,
        nr_omitted_indicator,
        dt_atualizacao,
        nm_usuario,
        dt_atualizacao_nrec,
        nm_usuario_nrec
    FROM
        RESTORE_ICD_CODE_INDEX_JPN;


BEGIN
  update icd_codes_main_jpn set IE_SITUACAO='I';--where clause
  update icd_code_modifier_jpn set IE_SITUACAO='I';
  update icd_code_index_jpn set IE_SITUACAO='I';

  OPEN c01; -- icd_codes_main
  LOOP
    FETCH c01 INTO  dt_atualizacao_w,
                            nm_usuario_w,
                            dt_atualizacao_nrec_w,
                            nm_usuario_nrec_w,
                            nr_chng_segm_w,
                            nr_disease_number_w,
                            ds_disease_name_w,
                            ds_name_of_cana_disease_w,
                            NR_ADOPTED_CATEGORY_W,
                            nr_code_exchange_w,
                            cd_icd_code_w,
                            cd_multiclassif_code_w,
                            ds_preliminary1_w,
                            ds_preliminary2_w,
                            nr_receipt_computer_code_w,
                            nr_area_of_use_w,
                            nr_change_history_w,
                            dt_update_w,
                            nr_dstn_disease_number_w,
                            ie_prohibited_category_w,
                            ie_out_of_insurance_w,
                            ds_preliminary3_w,
                            ds_preliminary4_w,
                            ds_omited_disease_name_w;
    EXIT WHEN NOT FOUND; /* apply on c01 */
  BEGIN
                SELECT
                    COUNT(*)
                INTO STRICT qt_code
                FROM
                    icd_codes_main_jpn
                WHERE
                    nr_disease_number = nr_disease_number_w;

                IF ( qt_code = 0 OR coalesce(qt_code::text, '') = '' ) THEN
                    BEGIN
                        RAISE NOTICE ' restoring insert Main:%', nr_disease_number_w;
                        INSERT INTO icd_codes_main_jpn(
                            dt_atualizacao,
                            nm_usuario,
                            dt_atualizacao_nrec,
                            nm_usuario_nrec,
                            nr_chng_segm,
                            nr_disease_number,
                            ds_disease_name,
                            ds_name_of_cana_disease,
                            nr_adopted_category,
                            nr_code_exchange,
                            cd_icd_code,
                            cd_multiclassif_code,
                            ds_preliminary1,
                            ds_preliminary2,
                            nr_receipt_computer_code,
                            nr_area_of_use,
                            nr_change_history,
                            dt_update,
                            nr_dstn_disease_number,
                            ie_prohibited_category,
                            ie_out_of_insurance,
                            ds_preliminary3,
                            ds_preliminary4,
                            ds_omited_disease_name,
                            IE_SITUACAO
                        ) VALUES (
                            clock_timestamp(),
                            coalesce(WHEB_USUARIO_PCK.get_nm_usuario(), 'tasy'),
                            clock_timestamp(),
                            coalesce(WHEB_USUARIO_PCK.get_nm_usuario(), 'tasy'),
                            nr_chng_segm_w,
                            nr_disease_number_w,
                            ds_disease_name_w,
                            ds_name_of_cana_disease_w,
                            NR_ADOPTED_CATEGORY_W,
                            nr_code_exchange_w,
                            cd_icd_code_w,
                            cd_multiclassif_code_w,
                            ds_preliminary1_w,
                            ds_preliminary2_w,
                            nr_receipt_computer_code_w,
                            nr_area_of_use_w,
                            nr_change_history_w,
                            to_date(dt_update_w, 'YYYYMMDD'),
                            nr_dstn_disease_number_w,
                            ie_prohibited_category_w,
                            ie_out_of_insurance_w,
                            ds_preliminary3_w,
                            ds_preliminary4_w,
                            ds_omited_disease_name_w,
                            'A'
                        );

                    END;
                    ELSE
                    BEGIN
                        RAISE NOTICE ' restoring update Main:%', nr_disease_number_w;
                        UPDATE icd_codes_main_jpn
                        SET
                            dt_atualizacao = clock_timestamp(),
                            nm_usuario = coalesce(WHEB_USUARIO_PCK.get_nm_usuario(), 'tasy'),
                            nr_chng_segm = nr_chng_segm_w,
                            ds_disease_name = ds_disease_name_w,
                            ds_name_of_cana_disease = ds_name_of_cana_disease_w,
                            nr_adopted_category = nr_adopted_category_w,
                            nr_code_exchange = nr_code_exchange_w,
                            cd_icd_code = cd_icd_code_w,
                            cd_multiclassif_code = cd_multiclassif_code_w,
                            ds_preliminary1 = ds_preliminary1_w,
                            ds_preliminary2 = ds_preliminary2_w,
                            nr_receipt_computer_code = nr_receipt_computer_code_w,
                            nr_area_of_use = nr_area_of_use_w,
                            nr_change_history = nr_change_history_w,
                            dt_update = to_date(dt_update_w, 'YYYYMMDD'),
                            nr_dstn_disease_number = nr_dstn_disease_number_w,
                            ie_prohibited_category = ie_prohibited_category_w,
                            ie_out_of_insurance = ie_out_of_insurance_w,
                            ds_preliminary3 = ds_preliminary3_w,
                            ds_preliminary4 = ds_preliminary4_w,
                            ds_omited_disease_name = ds_omited_disease_name_w,
                            IE_SITUACAO = 'A'
                        WHERE
                            nr_disease_number = nr_disease_number_w;

                    END;
                END IF;
                END;
    END LOOP;
CLOSE c01;


OPEN c02; -- icd_code_modif
  LOOP
  FETCH c02 INTO NR_CHNG_SEGM_MDFY_W,
                                        ds_kana_notation_w,
                                        ds_exchange_code_w,
                                        cd_modifier_w,
                                        ds_modifier_w,
                                        DT_ATUALIZACAO_MDFY_W,
                                        NM_USUARIO_MDFY_W,
                                        dt_atualizacao_nrec_mdfy_w,
                                        nm_usuario_nrec_mdfy_w,
                                        nr_modifier_mgmt_num_w,
                                        ds_modifier_notation_w,
                                        nr_location_segment_w,
                                        nr_group_codes_w,
                                        nr_receipt_computer_codes_w;
  EXIT WHEN NOT FOUND; /* apply on c02 */
  BEGIN
                            SELECT
                                COUNT(*)
                            INTO STRICT qt_modifier
                            FROM
                                icd_code_modifier_jpn
                            WHERE
                                nr_modifier_mgmt_num = nr_modifier_mgmt_num_w;
                            IF ( qt_modifier = 0 OR coalesce(qt_modifier::text, '') = '' ) THEN
                                            BEGIN
                                                INSERT INTO icd_code_modifier_jpn(
                                                    nr_chng_segm,
                                                    ds_kana_notation,
                                                    ds_exchange_code,
                                                    cd_modifier,
                                                    ds_modifier,
                                                    dt_atualizacao,
                                                    nm_usuario,
                                                    dt_atualizacao_nrec,
                                                    nm_usuario_nrec,
                                                    nr_modifier_mgmt_num,
                                                    ds_modifier_notation,
                                                    nr_location_segment,
                                                    nr_group_codes,
                                                    nr_receipt_computer_codes,
                                                    IE_SITUACAO
                                                ) VALUES (
                                                    NR_CHNG_SEGM_MDFY_W,
                                                    ds_kana_notation_w,
                                                    ds_exchange_code_w,
                                                    cd_modifier_w,
                                                    ds_modifier_w,
                                                    clock_timestamp(),
                                                    coalesce(WHEB_USUARIO_PCK.get_nm_usuario(), 'tasy'),
                                                    clock_timestamp(),
                                                    coalesce(WHEB_USUARIO_PCK.get_nm_usuario(), 'tasy'),
                                                    nr_modifier_mgmt_num_w,
                                                    ds_modifier_notation_w,
                                                    nr_location_segment_w,
                                                    nr_group_codes_w,
                                                    nr_receipt_computer_codes_w,
                                                    'A'
                                                );

                                            END;
                                ELSE
                                            BEGIN
                                                UPDATE icd_code_modifier_jpn
                                                SET
                                                    nr_chng_segm = NR_CHNG_SEGM_MDFY_W,
                                                    ds_kana_notation = ds_kana_notation_w,
                                                    ds_exchange_code = ds_exchange_code_w,
                                                    cd_modifier = cd_modifier_w,
                                                    ds_modifier = ds_modifier_w,
                                                    dt_atualizacao = clock_timestamp(),
                                                    nm_usuario = coalesce(WHEB_USUARIO_PCK.get_nm_usuario(), 'tasy'),
                                                    ds_modifier_notation = ds_modifier_notation_w,
                                                    nr_location_segment = nr_location_segment_w,
                                                    nr_group_codes = nr_group_codes_w,
                                                    nr_receipt_computer_codes = nr_receipt_computer_codes_w,
                                                    IE_SITUACAO = 'A'
                                                WHERE
                                                    nr_modifier_mgmt_num = nr_modifier_mgmt_num_w;

                                            END;
                                        END IF;
                                        END;
    END LOOP;
CLOSE c02;


OPEN c03; -- icd_code_index
  LOOP
  Fetch c03 into CD_INDEX_TERM_W,
                  CD_TERM_CODES_W,                   
                  NR_DISEASE_MODIFIER_W,                
                  NR_KANA_KANJI_W,                      
                  NR_SYNONYMS_W,                        
                  NR_TYPOGRAPHY_W,                      
                  NR_ADOPTED_CATEGORY_INDEX_W,                
                  NR_LANG_CLASSIF_W,                    
                  NR_OMITTED_INDICATOR_W,               
                  DT_ATUALIZACAO_INDEX_W,                         
                  NM_USUARIO_INDEX_W,                      
                  DT_ATUALIZACAO_NREC_INDEX_W,                    
                  NM_USUARIO_NREC_INDEX_W;
  EXIT WHEN NOT FOUND; /* apply on c03 */
  BEGIN
        SELECT
            COUNT(*)
        INTO STRICT qt_index
        FROM
            icd_code_index_jpn
        WHERE
        cd_index_term = cd_index_term_w
        AND cd_term_codes = cd_term_codes_w;

        IF ( qt_index = 0 OR coalesce(qt_index::text, '') = '' ) THEN
                                                        BEGIN
                                                            INSERT INTO icd_code_index_jpn(
                                                                cd_index_term,
                                                                cd_term_codes,
                                                                nr_disease_modifier,
                                                                nr_kana_kanji,
                                                                nr_synonyms,
                                                                nr_typography,
                                                                nr_adopted_category,
                                                                nr_lang_classif,
                                                                nr_omitted_indicator,
                                                                dt_atualizacao,
                                                                nm_usuario,
                                                                dt_atualizacao_nrec,
                                                                nm_usuario_nrec,
                                                                IE_SITUACAO
                                                            ) VALUES (
                                                                cd_index_term_w,
                                                                cd_term_codes_w,
                                                                nr_disease_modifier_w,
                                                                nr_kana_kanji_w,
                                                                nr_synonyms_w,
                                                                nr_typography_w,
                                                                nr_adopted_category_w,
                                                                nr_lang_classif_w,
                                                                nr_omitted_indicator_w,
                                                                clock_timestamp(),
                                                                coalesce(WHEB_USUARIO_PCK.get_nm_usuario(), 'tasy'),
                                                                clock_timestamp(),
                                                                coalesce(WHEB_USUARIO_PCK.get_nm_usuario(), 'tasy'),
                                                                'A'
                                                            );

                                                        END;
                                          ELSE
                                                        BEGIN
                                                            UPDATE icd_code_index_jpn
                                                            SET
                                                                nr_disease_modifier = nr_disease_modifier_w,
                                                                nr_kana_kanji = nr_kana_kanji_w,
                                                                nr_synonyms = nr_synonyms_w,
                                                                nr_typography = nr_typography_w,
                                                                nr_adopted_category = nr_adopted_category_w,
                                                                nr_lang_classif = nr_lang_classif_w,
                                                                nr_omitted_indicator =nr_omitted_indicator_w,
                                                                dt_atualizacao = clock_timestamp(),
                                                                nm_usuario = coalesce(WHEB_USUARIO_PCK.get_nm_usuario(), 'tasy'),
                                                                IE_SITUACAO = 'A'
                                                            WHERE
                                                                cd_index_term = cd_index_term_w
                                                                AND cd_term_codes = cd_term_codes_w;

                                                        END;
                                                    END IF;

                                                END;
                                            END LOOP;
                                      CLOSE c03;

COMMIT;  --truncate restoring tables
    EXECUTE 'truncate table TASY.RESTORE_ICD_CODE_INDEX_JPN';
    EXECUTE 'truncate table TASY.RESTORE_ICD_CODES_MAIN_JPN';
    EXECUTE 'truncate table TASY.RESTORE_ICD_CODE_MODIF_JPN';
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE restore_icd () FROM PUBLIC;

