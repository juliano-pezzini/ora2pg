-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE baca_atendimento_pacote () AS $body$
DECLARE


C01 CURSOR FOR
	SELECT 	nr_atendimento,
		nr_interno_conta,
		cd_procedimento,
		dt_procedimento,
		nr_sequencia,
		(	SELECT	min(dt_procedimento)
			FROM 	procedimento_paciente b
			WHERE 	b.nr_interno_conta = a.nr_interno_conta
			AND 	b.cd_procedimento = a.cd_procedimento
			AND 	b.nr_seq_proc_pacote = a.nr_sequencia
			AND 	b.nr_seq_proc_pacote <>  b.nr_sequencia
			AND 	coalesce(b.cd_motivo_exc_conta::text, '') = ''

		) dt_original,
		dt_atualizacao
	FROM 	procedimento_paciente a
	WHERE 	a.dt_procedimento = To_Date('21/04/2009 09:00:00', 'dd/mm/yyyy hh24:mi:ss')
	and 	a.nr_sequencia = nr_seq_proc_pacote
	ORDER BY dt_atualizacao;
c01_w	c01%rowtype;


BEGIN
open C01;
loop
fetch C01 into
	c01_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	if (c01_w.dt_procedimento		<> coalesce(c01_w.dt_original,c01_w.dt_procedimento)) then
		update	atendimento_pacote
		set	dt_inicio_pacote 	=  coalesce(c01_w.dt_original,c01_w.dt_procedimento)
		where	nr_seq_procedimento	= c01_w.nr_sequencia;

		update	procedimento_paciente
		set	dt_procedimento 	=  coalesce(c01_w.dt_original,c01_w.dt_procedimento),
			dt_conta		=  coalesce(c01_w.dt_original,c01_w.dt_procedimento)
		where	nr_sequencia		= c01_w.nr_sequencia;
	end if;
	end;
end loop;
close C01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE baca_atendimento_pacote () FROM PUBLIC;

