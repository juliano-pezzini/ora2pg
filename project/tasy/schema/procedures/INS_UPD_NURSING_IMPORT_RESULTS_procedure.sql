-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE ins_upd_nursing_import_results ( CD_SISTEMA_ANT_P PESSOA_FISICA.CD_SISTEMA_ANT%TYPE, DT_ENTRADA_P ATENDIMENTO_PACIENTE.DT_ENTRADA%TYPE, NR_SYSTEM_CODE_P NURSING_CARE_CAT_CODE.NR_SYSTEM_CODE%TYPE, DT_AVALIACAO_P NURSING_CARE_ENCOUNTER.DT_AVALIACAO%TYPE, NR_SEQ_IMPORT_ITEM_P NURSING_CARE_IMPORT_ITEMS.NR_SEQUENCIA%TYPE) AS $body$
DECLARE


CD_PESSOA_FISICA_W      PESSOA_FISICA.CD_PESSOA_FISICA%TYPE;
NR_ATENDIMENTO_W        ATENDIMENTO_PACIENTE.NR_ATENDIMENTO%TYPE;
NR_SEQ_ITEM_RESULT_W    NURSING_CARE_RESULT.NR_SEQUENCIA%TYPE;
NR_SEQ_ITEM_W           NURSING_CARE_ITEM.NR_SEQUENCIA%TYPE;
NR_SEQ_AVALIACAO_W      NURSING_CARE_ENCOUNTER.NR_SEQUENCIA%TYPE;


BEGIN
    SELECT  coalesce(MAX(PF.CD_PESSOA_FISICA), '0')
    INTO STRICT    CD_PESSOA_FISICA_W
    FROM    PESSOA_FISICA PF
    WHERE   PF.CD_SISTEMA_ANT = CD_SISTEMA_ANT_P;

    SELECT  coalesce(MAX(AP.NR_ATENDIMENTO), 0)
    INTO STRICT    NR_ATENDIMENTO_W
    FROM    ATENDIMENTO_PACIENTE AP
    WHERE   TRUNC(AP.DT_ENTRADA) = TRUNC(DT_ENTRADA_P)
    AND     AP.CD_PESSOA_FISICA = CD_PESSOA_FISICA_W;

    SELECT      coalesce(MAX(NR_SEQ_ITEM_RESULT), 0),
                coalesce(MAX(NR_SEQ_ITEM), 0)
    INTO STRICT        NR_SEQ_ITEM_RESULT_W,
                NR_SEQ_ITEM_W
    FROM (      SELECT      coalesce(NCR.NR_SEQUENCIA, 0) NR_SEQ_ITEM_RESULT,
                            coalesce(NCI.NR_SEQUENCIA, 0) NR_SEQ_ITEM,
                            coalesce(NCR.QT_PONTO, 0) QT_PONTO
                FROM        NURSING_CARE_CAT_CODE NCCC
                INNER JOIN  NURSING_CARE_CATALOG NCC        ON (NCC.NR_SEQUENCIA = NCCC.NR_SEQ_CATALOG)
                INNER JOIN  NURSING_CARE_ITEM NCI           ON (NCI.NR_SEQ_CATALOGO = NCC.NR_SEQUENCIA)
                INNER JOIN  NURSING_CARE_RESULT NCR         ON (NCR.NR_SEQ_ITEM = NCI.NR_SEQUENCIA)
                WHERE       NCCC.NR_SYSTEM_CODE = NR_SYSTEM_CODE_P
                ORDER BY    NCR.QT_PONTO DESC) alias10 LIMIT 1;

    SELECT  coalesce(MAX(NCE.NR_SEQUENCIA), 0)
    INTO STRICT    NR_SEQ_AVALIACAO_W
    FROM    NURSING_CARE_ENCOUNTER NCE
    WHERE   NCE.NR_ATENDIMENTO = NR_ATENDIMENTO_W
    AND     TRUNC(NCE.DT_AVALIACAO) = TRUNC(DT_AVALIACAO_P);

	IF (NR_SEQ_ITEM_W > 0
        AND NR_SEQ_AVALIACAO_W > 0) THEN

        CALL INS_OR_UPD_NURSING_CARE_ENC(NR_SEQ_AVALIACAO_W, NR_SEQ_ITEM_RESULT_W, NR_SEQ_ITEM_W);

        UPDATE  NURSING_CARE_ENC_RESULT
        SET     NR_SEQ_IMPORT_ITEM = NR_SEQ_IMPORT_ITEM_P
        WHERE   NR_SEQ_AVALIACAO = NR_SEQ_AVALIACAO_W
        AND     NR_SEQ_ITEM = NR_SEQ_ITEM_W;
    END IF;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ins_upd_nursing_import_results ( CD_SISTEMA_ANT_P PESSOA_FISICA.CD_SISTEMA_ANT%TYPE, DT_ENTRADA_P ATENDIMENTO_PACIENTE.DT_ENTRADA%TYPE, NR_SYSTEM_CODE_P NURSING_CARE_CAT_CODE.NR_SYSTEM_CODE%TYPE, DT_AVALIACAO_P NURSING_CARE_ENCOUNTER.DT_AVALIACAO%TYPE, NR_SEQ_IMPORT_ITEM_P NURSING_CARE_IMPORT_ITEMS.NR_SEQUENCIA%TYPE) FROM PUBLIC;

