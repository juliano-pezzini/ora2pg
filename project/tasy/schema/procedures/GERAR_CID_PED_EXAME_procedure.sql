-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_cid_ped_exame (nr_sequencia_p bigint) AS $body$
DECLARE


nr_atendimento_w	bigint;
ds_cid_w		varchar(4000);
ds_doenca_w		varchar(4000);
cd_cid_doenca_w		varchar(10);
ds_cid_doenca_w		varchar(240);


c01 CURSOR FOR
	SELECT	b.cd_doenca_cid,
		b.ds_doenca_cid
	from	cid_doenca		b,
		diagnostico_doenca	a
	where	a.cd_doenca		= b.cd_doenca_cid
	and	a.nr_atendimento	= nr_atendimento_w;


BEGIN

select	nr_atendimento
into STRICT	nr_atendimento_w
from	pedido_exame_externo
where	nr_sequencia	= nr_sequencia_p;

if (nr_atendimento_w > 0) then

	OPEN	c01;
	LOOP
	FETCH	c01 INTO
		cd_cid_doenca_w,
		ds_cid_doenca_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
		BEGIN

		ds_cid_w	:= ds_cid_w || cd_cid_doenca_w || ' - ';
		ds_doenca_w	:= ds_doenca_w || ds_cid_doenca_w || ' - ';

		END;
	END LOOP;
	CLOSE c01;

end if;

if (ds_cid_w IS NOT NULL AND ds_cid_w::text <> '') or (ds_doenca_w IS NOT NULL AND ds_doenca_w::text <> '') then
	Begin
	update	pedido_exame_externo
	set	ds_cid			= SUBSTR(ds_cid_w,1,4000),
		ds_diagnostico_cid	= SUBSTR(ds_doenca_w,1,4000)
	where	nr_sequencia		= nr_sequencia_p;
	end;
end if;

commit;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_cid_ped_exame (nr_sequencia_p bigint) FROM PUBLIC;

