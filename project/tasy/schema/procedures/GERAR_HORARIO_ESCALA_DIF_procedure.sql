-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_horario_escala_dif ( nr_seq_escala_p bigint, dt_inicial_p timestamp, dt_final_p timestamp, qt_hora_trabalho_p bigint, qt_hora_folga_p bigint, ie_data_horario_p text, nm_usuario_p text) AS $body$
DECLARE


dt_escala_w		timestamp;
dt_fim_escala_w		timestamp;
dt_inicio_w		timestamp;
dt_fim_w		timestamp;
hr_final_w		timestamp;
hr_inicial_w		timestamp;
hr_final_aux_w		timestamp;
cd_pessoa_fisica_w	varchar(10);
cd_profissional_w	varchar(10);
nr_sequencia_w		bigint;
nr_sequencia_horario_w	bigint;
ds_bloq_alt_escala_inativa_w varchar(255) := obter_valor_param_usuario(3009, 40, wheb_usuario_pck.get_cd_perfil, nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento);

C01 CURSOR FOR
	SELECT 	a.hr_inicial,
		a.hr_final,
		a.cd_pessoa_fisica,
		a.nr_sequencia
	From 	Escala_Horario a
	where 	a.nr_seq_escala	= nr_seq_escala_p
	and	(a.cd_pessoa_fisica IS NOT NULL AND a.cd_pessoa_fisica::text <> '')
    and ((coalesce(ds_bloq_alt_escala_inativa_w, 'N') = 'S' and coalesce(ie_situacao, 'A') = 'A')
    or (coalesce(ds_bloq_alt_escala_inativa_w, 'N') <> 'S'));

C02 CURSOR FOR
	SELECT	cd_profissional
	from	escala_horario_adic
	where	nr_seq_escala = nr_sequencia_horario_w
	order by cd_profissional;


BEGIN

open C01;
    loop
    fetch C01 into
        dt_inicio_w,
        dt_fim_w,
        cd_pessoa_fisica_w,
        nr_sequencia_horario_w;
    EXIT WHEN NOT FOUND; /* apply on C01 */
        begin
        if (ie_data_horario_p = 'S') then
            hr_inicial_w	:=  dt_inicio_w;

            hr_final_w	:=  dt_fim_w;
        else
            hr_inicial_w	:=  to_date(to_char(dt_inicial_p,'dd/mm/yyyy') || ' ' ||
                    to_char(dt_inicio_w,'hh24:mi:ss'),
                    'dd/mm/yyyy hh24:mi:ss');

            hr_final_w	:=  to_date(to_char(dt_final_p,'dd/mm/yyyy') || ' ' ||
                    to_char(dt_fim_w,'hh24:mi:ss'),
                    'dd/mm/yyyy hh24:mi:ss');
        end if;

        while(hr_inicial_w <= hr_final_w) loop

            hr_final_aux_w := hr_inicial_w + ((qt_hora_trabalho_p * 60) / 1440);

            select	nextval('escala_diaria_seq')
            into STRICT	nr_sequencia_w
;

            insert into escala_diaria(
                nr_sequencia,
                nr_seq_escala,
                cd_pessoa_fisica,
                dt_atualizacao,
                nm_usuario,
                dt_inicio,
                dt_fim,
                ie_feriado)
            values (
                nr_sequencia_w,
                nr_seq_escala_p,
                cd_pessoa_fisica_w,
                clock_timestamp(),
                nm_usuario_p,
                hr_inicial_w,
                hr_final_aux_w,
                'N');
            open C02;
                loop
                fetch C02 into
                    cd_profissional_w;
                EXIT WHEN NOT FOUND; /* apply on C02 */
                    begin

                    insert	into escala_diaria_adic(
                        cd_pessoa_fisica,
                        dt_atualizacao,
                        dt_atualizacao_nrec,
                        nm_usuario,
                        nm_usuario_nrec,
                        nr_seq_escala_diaria,
                        nr_sequencia)
                    values (
                        cd_profissional_w,
                        clock_timestamp(),
                        clock_timestamp(),
                        nm_usuario_p,
                        nm_usuario_p,
                        nr_sequencia_w,
                        nextval('escala_diaria_adic_seq'));
                    end;
                end loop;
                close C02;
            hr_inicial_w	:= hr_final_aux_w + ((qt_hora_folga_p * 60) / 1440);
        end loop;
        end;
    end loop;
    close C01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_horario_escala_dif ( nr_seq_escala_p bigint, dt_inicial_p timestamp, dt_final_p timestamp, qt_hora_trabalho_p bigint, qt_hora_folga_p bigint, ie_data_horario_p text, nm_usuario_p text) FROM PUBLIC;

