-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE valida_itens_agend_coletivo (nr_seq_ag_integrada_p bigint) AS $body$
DECLARE


nr_sequencia_w		bigint;
nr_sequencia_null_w     bigint;
nr_seq_agenda_item_w	bigint;
cd_pessoa_fisica_w	varchar(10);

c01 CURSOR FOR
	SELECT 	nr_sequencia
	from 	agenda_integrada_item
	where 	nr_seq_agenda_int = nr_seq_ag_integrada_p;

c02 CURSOR FOR
	SELECT 	distinct cd_pessoa_fisica
	from 	agendamento_coletivo
	where 	nr_seq_ag_integrada = nr_seq_ag_integrada_p;


BEGIN

if (nr_seq_ag_integrada_p > 0) then
	open	c01;
		loop
		fetch	c01 into
			nr_seq_agenda_item_w;
		EXIT WHEN NOT FOUND; /* apply on c01 */

		open	c02;
			loop
			fetch	c02 into
				cd_pessoa_fisica_w;
			EXIT WHEN NOT FOUND; /* apply on c02 */

			select 	max(nr_sequencia)
			into STRICT 	nr_sequencia_w
			from 	agendamento_coletivo
			where 	nr_seq_ag_integrada = nr_seq_ag_integrada_p
			and   	nr_seq_agenda_int = nr_seq_agenda_item_w
			and     cd_pessoa_fisica = cd_pessoa_fisica_w;

			if (coalesce(nr_sequencia_w::text, '') = '') then
				select 	max(nr_sequencia)
				into STRICT 	nr_sequencia_null_w
				from 	agendamento_coletivo
				where 	nr_seq_ag_integrada = nr_seq_ag_integrada_p
				and     cd_pessoa_fisica = cd_pessoa_fisica_w
				and   	coalesce(nr_seq_agenda_int::text, '') = '';

				if (coalesce(nr_sequencia_null_w::text, '') = '') then
					insert into agendamento_coletivo(
						nr_sequencia,
						dt_atualizacao,
						nm_usuario,
						dt_atualizacao_nrec,
						nm_usuario_nrec,
						cd_pessoa_fisica,
						nr_seq_ag_integrada,
						nr_seq_agenda_int

					) values (
						nextval('agendamento_coletivo_seq'),
						clock_timestamp(),
						wheb_usuario_pck.get_nm_usuario,
						clock_timestamp(),
						wheb_usuario_pck.get_nm_usuario,
						cd_pessoa_fisica_w,
						nr_seq_ag_integrada_p,
						nr_seq_agenda_item_w
					);
				else
					update 	agendamento_coletivo
					set	nr_seq_agenda_int = nr_seq_agenda_item_w
					where 	nr_seq_ag_integrada = nr_seq_ag_integrada_p
					and     cd_pessoa_fisica = cd_pessoa_fisica_w
					and     nr_sequencia = nr_sequencia_null_w;
				end if;

			end if;
		end loop;
		close c02;
		commit;
	end loop;
	close c01;
end if;


end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE valida_itens_agend_coletivo (nr_seq_ag_integrada_p bigint) FROM PUBLIC;

