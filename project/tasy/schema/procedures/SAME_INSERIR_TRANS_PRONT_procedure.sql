-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE same_inserir_trans_pront ( cd_pessoa_destino_p text, cd_pessoa_origem_p text, cd_setor_origem_p bigint, cd_setor_destino_p bigint, ds_observacao_p text, lista_informacao_p text, NR_SEQ_PROTOCOLO_CONV_p bigint, ie_digitalizado_p text, nm_usuario_p text, cd_estabelecimento_p bigint) AS $body$
DECLARE

 
lista_informacao_w		varchar(32000);
ie_contador_w			bigint	:= 0;
tam_lista_w			bigint;
ie_pos_virgula_w		smallint;
cd_pessoa_pront_w			varchar(10);
nr_atendimento_w		bigint;
nr_prontuario_w			bigint;
cd_pessoa_fisica_w		varchar(10);
ie_insere_w			varchar(1);
nr_seq_transf_w			bigint;
ds_consistencia_w		varchar(32000);
ie_pos_traco_w			bigint;
lista_inf_w			varchar(100);
nr_seq_receb_w			bigint;

BEGIN
 
lista_informacao_w	:= lista_informacao_p;
 
while	(lista_informacao_w IS NOT NULL AND lista_informacao_w::text <> '') or 
	ie_contador_w > 10000 loop 
	begin 
	tam_lista_w		:= length(lista_informacao_w);
	ie_pos_virgula_w	:= position(',' in lista_informacao_w);
 
	if (ie_pos_virgula_w <> 0) then 
		nr_atendimento_w	:= substr(lista_informacao_w,1,(ie_pos_virgula_w - 1));
		lista_informacao_w	:= substr(lista_informacao_w,(ie_pos_virgula_w + 1),tam_lista_w);
	end if;
	if (nr_atendimento_w IS NOT NULL AND nr_atendimento_w::text <> '') then 
		select	max(cd_pessoa_fisica) 
		into STRICT	cd_pessoa_pront_w 
		from	atendimento_paciente 
		where	nr_atendimento = nr_atendimento_w;
 
		select	max(nr_prontuario), 
			max(cd_pessoa_fisica) 
		into STRICT	nr_prontuario_w, 
			cd_pessoa_fisica_w 
		from	pessoa_fisica 
		where	cd_pessoa_fisica = cd_pessoa_pront_w;
		 
		ie_insere_w	:= 'S';
		nr_seq_receb_w	:= null;
		if (cd_pessoa_fisica_w IS NOT NULL AND cd_pessoa_fisica_w::text <> '') then 
			 
			nr_seq_receb_w := consiste_pront_transf_pend_ret(cd_pessoa_fisica_w, nr_atendimento_w, nr_seq_receb_w);
			 
			if (nr_seq_receb_w IS NOT NULL AND nr_seq_receb_w::text <> '') then 
			 
				ds_consistencia_w	:= substr(ds_consistencia_W || ' ' || nr_prontuario_w || ' ' || wheb_mensagem_pck.get_texto(803047) || '.: ' || nr_seq_receb_w || ' ' || wheb_mensagem_pck.get_texto(803049) || '.: ' || nr_atendimento_w,1,32000);
				ie_insere_w	:= 'F';		
			 
			end if;		
			 
			if (ie_insere_w	= 'S') then 
			 
				select nextval('transf_prontuario_seq') 
				into STRICT	nr_seq_transf_w	 
				;
			 
				insert into transf_prontuario(nr_sequencia, 
							dt_atualizacao, 
							nm_usuario, 
							dt_atualizacao_nrec, 
							nm_usuario_nrec, 
							cd_pessoa_origem, 
							cd_pessoa_destino, 
							cd_setor_origem, 
							cd_setor_destino, 
							nr_prontuario, 
							nr_atendimento, 
							cd_pessoa_fisica,						 
							ds_observacao, 
							NR_SEQ_PROTOCOLO_CONV, 
							ie_digitalizado, 
							cd_estabelecimento) 
				values (nr_seq_transf_w, 
							clock_timestamp(), 
							nm_usuario_p, 
							clock_timestamp(), 
							nm_usuario_p,						 
							cd_pessoa_origem_p, 
							cd_pessoa_destino_p, 
							cd_setor_origem_p, 
							cd_setor_destino_p, 
							nr_prontuario_w, 
							nr_atendimento_w, 
							cd_pessoa_fisica_w, 
							ds_observacao_p, 
							NR_SEQ_PROTOCOLO_CONV_p, 
							ie_digitalizado_p, 
							cd_estabelecimento_p);
				 
				CALL transferir_prontuario_setores(nr_seq_transf_w, nm_usuario_p, 1, cd_estabelecimento_p);
			 
			 
			end if;		
		end if;
	end if;
	 
	ie_contador_w	:= ie_contador_w + 1;
	end;
end loop;
 
if (ds_consistencia_w IS NOT NULL AND ds_consistencia_w::text <> '') then 
	--Os seguintes prontuários: #@DS_CONSISTENCIA#@ já possuem uma tranferência sem recebimento pendente 
	CALL Wheb_mensagem_pck.exibir_mensagem_abort(264219,'DS_CONSISTENCIA=' || ds_consistencia_w);
end if;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE same_inserir_trans_pront ( cd_pessoa_destino_p text, cd_pessoa_origem_p text, cd_setor_origem_p bigint, cd_setor_destino_p bigint, ds_observacao_p text, lista_informacao_p text, NR_SEQ_PROTOCOLO_CONV_p bigint, ie_digitalizado_p text, nm_usuario_p text, cd_estabelecimento_p bigint) FROM PUBLIC;

