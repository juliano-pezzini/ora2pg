-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE obter_se_tit_pagar_bordero ( nr_titulo_p bigint, nr_seq_classe_p bigint ) AS $body$
 /*-----------------------------------------------------------------------------
 | Verifica se determinado título está em borderô ou pagamento escritural.
 | Caso esteja, lança uma exceção se a classificação do título não permitir.
 |
 */
DECLARE

ie_permite_bordero_w			varchar(1);
qt_tit_bordero_pag_escr_w		bigint;
nr_seq_classe_w					bigint;



BEGIN
	if (nr_titulo_p IS NOT NULL AND nr_titulo_p::text <> '' AND nr_seq_classe_p IS NOT NULL AND nr_seq_classe_p::text <> '') then
		select	coalesce(max(nr_seq_classe),0)
		into STRICT 	nr_seq_classe_w
		from 	titulo_pagar
		where 	nr_titulo = nr_titulo_p;
		
		-- Verifica se houve alteração na classificacao do titulo
		if (nr_seq_classe_w <> nr_seq_classe_p) then
			select 	coalesce(max(ie_permite_bordero), 'S')
			into STRICT 	ie_permite_bordero_w
			from 	classe_titulo_pagar
			where 	nr_sequencia = nr_seq_classe_p;
			
			if (ie_permite_bordero_w = 'N') then
				select count(*)
				into STRICT qt_tit_bordero_pag_escr_w
				from (
					SELECT  1 
					from     titulo_pagar_escrit a 
					where    a.nr_titulo = nr_titulo_p
					
union
 
					SELECT   1 
					from     titulo_pagar_bordero_v a 
					where    a.nr_titulo = nr_titulo_p
				) alias2;
				
				-- Se o título esta em bordero ou pagamento escritural
				if (qt_tit_bordero_pag_escr_w <> 0) then
					CALL wheb_mensagem_pck.exibir_mensagem_abort(1075028);
				end if;
			end if;
		end if;
	end if;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE obter_se_tit_pagar_bordero ( nr_titulo_p bigint, nr_seq_classe_p bigint ) FROM PUBLIC;

