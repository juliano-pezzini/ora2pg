-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';



CREATE TYPE campos AS (ds_dias_aplicacao varchar(255));


CREATE OR REPLACE PROCEDURE copiar_protocolo_onc_orcamento ( cd_protocolo_p bigint, nr_sequencia_p bigint, nr_seq_orcamento_p bigint, nm_usuario_p text, nr_seq_paciente_p bigint) AS $body$
DECLARE



indice_w			bigint := 0;
ds_valido_dias_w		varchar(255) := '0123456789D,- ';
dia_ciclo_w			varchar(255) := '';
type vetor			is table of campos index by integer;

ie_dispara_lanc_auto_w		varchar(1);

dias_filtro_w			vetor;
qt_dias_w			numeric(30);
qt_ciclos_w			numeric(30);
qt_lanc_w			numeric(30);
indice_dias_w			bigint := 0;
posicao_virg_w			bigint := 0;
indice_loop_w			bigint := 0;

ds_dias_aplic_filtro_w		orcamento_paciente.ds_dias_aplic_filtro%type;
ds_ciclos_aplic_filtro_w	orcamento_paciente.ds_ciclos_aplic_filtro%type;

BEGIN

ie_dispara_lanc_auto_w	:= coalesce(obter_valor_param_usuario(106, 153, obter_perfil_ativo, nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento),'N');

if (coalesce(nr_seq_paciente_p::text, '') = '') then

	-- Medicamento
	insert into orcamento_paciente_mat(
		nr_sequencia_orcamento,
		cd_material,
		qt_material,
		vl_material,
		dt_atualizacao,
		nm_usuario,
		vl_desconto,
		ie_valor_informado,
		nr_sequencia,
		cd_unidade_medida,
		ds_dias_aplicacao,
		ds_ciclos_aplicacao,
		qt_dose,
		cd_protocolo,
		nr_seq_medicacao,
		qt_dias_util,
		cd_intervalo,
		ie_via_aplicacao)
	SELECT	nr_seq_orcamento_p,
		cd_material,
		0,
		0,
		clock_timestamp(),
		nm_usuario_p,
		0,
		'N',
		nextval('orcamento_paciente_mat_seq'),
		cd_unidade_medida,
		ds_dias_aplicacao,
		ds_ciclos_aplicacao,
		coalesce(qt_dose,0),
		cd_protocolo,
		nr_sequencia_p,
		qt_dias_util,
		cd_intervalo,
		ie_via_aplicacao
	from 	protocolo_medic_material
	where	cd_protocolo = cd_protocolo_p
	and	nr_sequencia = nr_sequencia_p
	and	(ds_dias_aplicacao IS NOT NULL AND ds_dias_aplicacao::text <> '')
	and	(qt_dose IS NOT NULL AND qt_dose::text <> '')
	and	nr_agrupamento > 0
	and	coalesce(nr_seq_diluicao::text, '') = ''
	and	coalesce(nr_seq_solucao::text, '') = '';

	-- Solucao
	insert into orcamento_paciente_mat(
		nr_sequencia_orcamento,
		cd_material,
		qt_material,
		vl_material,
		dt_atualizacao,
		nm_usuario,
		vl_desconto,
		ie_valor_informado,
		nr_sequencia,
		cd_unidade_medida,
		ds_dias_aplicacao,
		ds_ciclos_aplicacao,
		qt_dose,
		cd_protocolo,
		nr_seq_medicacao,
		qt_dias_util,
		cd_intervalo,
		ie_via_aplicacao)
	SELECT	nr_seq_orcamento_p,
		a.cd_material,
		0,
		0,
		clock_timestamp(),
		nm_usuario_p,
		0,
		'N',
		nextval('orcamento_paciente_mat_seq'),
		a.cd_unidade_medida,
		b.ds_dias_aplicacao,
		coalesce(b.ds_ciclos_aplicacao, a.ds_ciclos_aplicacao),
		coalesce(qt_dose,0),
		b.cd_protocolo,
		nr_sequencia_p,
		a.qt_dias_util,
		b.cd_intervalo,
		b.ie_via_aplicacao
	from 	protocolo_medic_material a,
		protocolo_medic_solucao b
	where	b.cd_protocolo	= cd_protocolo_p
	and     a.cd_protocolo	= b.cd_protocolo
        and	a.nr_sequencia	= b.nr_sequencia
	and	a.nr_sequencia	= nr_sequencia_p
	and	a.nr_seq_solucao        = b.nr_seq_solucao
	and	(b.ds_dias_aplicacao IS NOT NULL AND b.ds_dias_aplicacao::text <> '')
	and	(a.qt_dose IS NOT NULL AND a.qt_dose::text <> '')
	and	a.nr_agrupamento > 0
	and	coalesce(a.nr_seq_diluicao::text, '') = '';

	-- Diluicao
	insert into orcamento_paciente_mat(
		nr_sequencia_orcamento,
		cd_material,
		qt_material,
		vl_material,
		dt_atualizacao,
		nm_usuario,
		vl_desconto,
		ie_valor_informado,
		nr_sequencia,
		cd_unidade_medida,
		ds_dias_aplicacao,
		ds_ciclos_aplicacao,
		qt_dose,
		cd_protocolo,
		nr_seq_medicacao,
		qt_dias_util,
		cd_intervalo,
		ie_via_aplicacao)
	SELECT	nr_seq_orcamento_p,
		a.cd_material,
		0,
		0,
		clock_timestamp(),
		nm_usuario_p,
		0,
		'N',
		nextval('orcamento_paciente_mat_seq'),
		a.cd_unidade_medida,
		coalesce(b.ds_dias_aplicacao,a.ds_dias_aplicacao),
		coalesce(b.ds_ciclos_aplicacao,a.ds_ciclos_aplicacao),
		coalesce(a.qt_dose,0),
		a.cd_protocolo,
		nr_sequencia_p,
		a.qt_dias_util,
		coalesce(a.cd_intervalo,b.cd_intervalo),
		a.ie_via_aplicacao
	from 	protocolo_medic_material a,
		protocolo_medic_material b
	where	a.nr_seq_diluicao = b.nr_seq_material
	and	a.cd_protocolo = b.cd_protocolo
	and	a.nr_sequencia = b.nr_sequencia
	and	a.cd_protocolo = cd_protocolo_p
	and	a.nr_sequencia = nr_sequencia_p
	and	(coalesce(b.ds_dias_aplicacao,a.ds_dias_aplicacao) IS NOT NULL AND (coalesce(b.ds_dias_aplicacao,a.ds_dias_aplicacao))::text <> '')
	and	(a.qt_dose IS NOT NULL AND a.qt_dose::text <> '')
	and	b.nr_agrupamento > 0
	and	coalesce(a.nr_seq_solucao::text, '') = '';

else

	-- Medicamento
	insert into orcamento_paciente_mat(
		nr_sequencia_orcamento,
		cd_material,
		qt_material,
		vl_material,
		dt_atualizacao,
		nm_usuario,
		vl_desconto,
		ie_valor_informado,
		nr_sequencia,
		cd_unidade_medida,
		ds_dias_aplicacao,
		ds_ciclos_aplicacao,
		qt_dose,
		cd_protocolo,
		nr_seq_medicacao,
		qt_dias_util,
		cd_intervalo,
		ie_via_aplicacao)
	SELECT	nr_seq_orcamento_p,
		cd_material,
		0,
		0,
		clock_timestamp(),
		nm_usuario_p,
		0,
		'N',
		nextval('orcamento_paciente_mat_seq'),
		cd_unidade_medida,
		ds_dias_aplicacao,
		ds_ciclos_aplicacao,
		coalesce(qt_dose,0),
		cd_protocolo,
		nr_sequencia_p,
		qt_dias_util,
		cd_intervalo,
		ie_via_aplicacao
	from 	paciente_protocolo_medic
	where	nr_seq_paciente = nr_seq_paciente_p
	and	(ds_dias_aplicacao IS NOT NULL AND ds_dias_aplicacao::text <> '')
	and	(qt_dose IS NOT NULL AND qt_dose::text <> '')
	and	nr_agrupamento > 0
	and	coalesce(nr_seq_diluicao::text, '') = ''
	and	coalesce(nr_seq_solucao::text, '') = ''
	and	coalesce(nr_seq_procedimento::text, '') = ''
	and	coalesce(nr_seq_medic_material::text, '') = '';

	-- Solucao
	insert into orcamento_paciente_mat(
		nr_sequencia_orcamento,
		cd_material,
		qt_material,
		vl_material,
		dt_atualizacao,
		nm_usuario,
		vl_desconto,
		ie_valor_informado,
		nr_sequencia,
		cd_unidade_medida,
		ds_dias_aplicacao,
		ds_ciclos_aplicacao,
		qt_dose,
		cd_protocolo,
		nr_seq_medicacao,
		qt_dias_util,
		cd_intervalo,
		ie_via_aplicacao)
	SELECT	nr_seq_orcamento_p,
		a.cd_material,
		0,
		0,
		clock_timestamp(),
		nm_usuario_p,
		0,
		'N',
		nextval('orcamento_paciente_mat_seq'),
		a.cd_unidade_medida,
		b.ds_dias_aplicacao,
		coalesce(b.ds_ciclos_aplicacao, a.ds_ciclos_aplicacao),
		coalesce(qt_dose,0),
		a.cd_protocolo,
		nr_sequencia_p,
		a.qt_dias_util,
		b.cd_intervalo,
		b.ie_via_aplicacao
	from	paciente_protocolo_medic a,
		paciente_protocolo_soluc b
	where	a.nr_seq_paciente = nr_seq_paciente_p
	and	a.nr_seq_paciente = b.nr_seq_paciente
	and	b.nr_seq_solucao = a.nr_seq_solucao
	and	(b.ds_dias_aplicacao IS NOT NULL AND b.ds_dias_aplicacao::text <> '')
	and	(qt_dose IS NOT NULL AND qt_dose::text <> '')
	and	b.nr_agrupamento > 0
	and	coalesce(a.nr_seq_diluicao::text, '') = ''
	and	coalesce(nr_seq_procedimento::text, '') = ''
	and	coalesce(nr_seq_medic_material::text, '') = '';

	-- Diluicao
	insert into orcamento_paciente_mat(
		nr_sequencia_orcamento,
		cd_material,
		qt_material,
		vl_material,
		dt_atualizacao,
		nm_usuario,
		vl_desconto,
		ie_valor_informado,
		nr_sequencia,
		cd_unidade_medida,
		ds_dias_aplicacao,
		ds_ciclos_aplicacao,
		qt_dose,
		cd_protocolo,
		nr_seq_medicacao,
		qt_dias_util,
		cd_intervalo,
		ie_via_aplicacao)
	SELECT	nr_seq_orcamento_p,
		a.cd_material,
		0,
		0,
		clock_timestamp(),
		nm_usuario_p,
		0,
		'N',
		nextval('orcamento_paciente_mat_seq'),
		a.cd_unidade_medida,
		coalesce(b.ds_dias_aplicacao,a.ds_dias_aplicacao),
		coalesce(b.ds_ciclos_aplicacao,a.ds_ciclos_aplicacao),
		coalesce(a.qt_dose,0),
		a.cd_protocolo,
		nr_sequencia_p,
		b.qt_dias_util,
		coalesce(a.cd_intervalo, b.cd_intervalo),
		b.ie_via_aplicacao
	from 	paciente_protocolo_medic a,
		paciente_protocolo_medic b
	where	a.nr_seq_diluicao = b.nr_seq_material
	and	a.nr_seq_paciente = b.nr_seq_paciente
	and	a.nr_seq_paciente = nr_seq_paciente_p
	and	(coalesce(b.ds_dias_aplicacao,a.ds_dias_aplicacao) IS NOT NULL AND (coalesce(b.ds_dias_aplicacao,a.ds_dias_aplicacao))::text <> '')
	and	(a.qt_dose IS NOT NULL AND a.qt_dose::text <> '')
	and	b.nr_agrupamento > 0
	and	coalesce(a.nr_seq_solucao::text, '') = ''
	and	coalesce(a.nr_seq_procedimento::text, '') = ''
	and	coalesce(a.nr_seq_medic_material::text, '') = '';

end if;

if (ie_dispara_lanc_auto_w = 'S') then

	select	ds_dias_aplic_filtro,
		ds_ciclos_aplic_filtro,
		nr_ciclos
	into STRICT	ds_dias_aplic_filtro_w,
		ds_ciclos_aplic_filtro_w,
		qt_ciclos_w
	from 	orcamento_paciente
	where	nr_sequencia_orcamento = nr_seq_orcamento_p;

	/* Filtro de dias e ciclos de aplicacao informado no orcamento - INICIO*/

	if (ds_dias_aplic_filtro_w IS NOT NULL AND ds_dias_aplic_filtro_w::text <> '') then

		if (ds_ciclos_aplic_filtro_w IS NOT NULL AND ds_ciclos_aplic_filtro_w::text <> '') then
			qt_ciclos_w	:= obter_qt_ciclos_aplicacao(ds_ciclos_aplic_filtro_w);
		else
			if (coalesce(qt_ciclos_w::text, '') = '') then
				select	coalesce(max(nr_ciclos),1)
				into STRICT	qt_ciclos_w
				from	protocolo_medicacao
				where	nr_sequencia = nr_sequencia_p
				and	cd_protocolo = cd_protocolo_p;
			end if;
		end if;

		for indice_w in 1..length(ds_dias_aplic_filtro_w) loop
			dia_ciclo_w	:= substr(upper(ds_dias_aplic_filtro_w), indice_w, 1);
			if (position(dia_ciclo_w in ds_valido_dias_w) = 0) then
				CALL wheb_mensagem_pck.exibir_mensagem_abort(1084612);
			end if;
		end loop;

		while (ds_dias_aplic_filtro_w IS NOT NULL AND ds_dias_aplic_filtro_w::text <> '') loop
			ds_dias_aplic_filtro_w := substr(ds_dias_aplic_filtro_w, position('D' in ds_dias_aplic_filtro_w) + 1, length(ds_dias_aplic_filtro_w));
			posicao_virg_w	:= position('D' in ds_dias_aplic_filtro_w);
			indice_dias_w := indice_dias_w + 1;

			if (posicao_virg_w = 0) then
				dias_filtro_w[indice_dias_w].ds_dias_aplicacao	:= 'D' || somente_numero_real(substr(ds_dias_aplic_filtro_w,1,length(ds_dias_aplic_filtro_w)));
				for j in 1.. qt_ciclos_w loop
					begin
					CALL gerar_lanc_orc_automatico(	null,
									nr_seq_orcamento_p,
									192,
									null,
									nm_usuario_p,
									nr_sequencia_p,
									cd_protocolo_p,
									dias_filtro_w[indice_dias_w].ds_dias_aplicacao
									);
					end;
				end loop;
				ds_dias_aplic_filtro_w := '';
			else
				dias_filtro_w[indice_dias_w].ds_dias_aplicacao	:= 'D' || somente_numero_real(substr(ds_dias_aplic_filtro_w,1,posicao_virg_w - 2));
				for k in 1.. qt_ciclos_w loop
					begin
					CALL gerar_lanc_orc_automatico(	null,
									nr_seq_orcamento_p,
									192,
									null,
									nm_usuario_p,
									nr_sequencia_p,
									cd_protocolo_p,
									dias_filtro_w[indice_dias_w].ds_dias_aplicacao
									);
					end;
				end loop;
				ds_dias_aplic_filtro_w := substr(ds_dias_aplic_filtro_w,posicao_virg_w, length(ds_dias_aplic_filtro_w));
			end if;
			if (position('D' in dias_filtro_w[indice_dias_w].ds_dias_aplicacao) = 0) then
				CALL wheb_mensagem_pck.exibir_mensagem_abort(1084612);
			end if;
			indice_loop_w := indice_loop_w + 1;
			if (indice_loop_w > 100) then
				exit;
			end if;
		end loop;

	end if;
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE copiar_protocolo_onc_orcamento ( cd_protocolo_p bigint, nr_sequencia_p bigint, nr_seq_orcamento_p bigint, nm_usuario_p text, nr_seq_paciente_p bigint) FROM PUBLIC;

