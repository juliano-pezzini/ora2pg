-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE atualiza_grau_parentesco ( CD_PESSOA_FISICA_P bigint, CD_PESSOA_PARENTE_P bigint, NR_SEQ_GRAU_PARENT_P bigint, NM_USUARIO_P text, IE_OPERACAO_P text default 'I') AS $body$
DECLARE


  existe_relacao_w bigint:=0;

BEGIN
    if (IE_OPERACAO_P = 'I') then
      select CASE WHEN coalesce(max(NR_SEQ_GRAU_PARENT)::text, '') = '' THEN '0'  ELSE max(NR_SEQ_GRAU_PARENT) END NR_SEQ_GRAU_PARENT into STRICT existe_relacao_w from PF_RELACAO_PARENTESCO where CD_PESSOA_FISICA = CD_PESSOA_FISICA_P and  CD_PESSOA_PARENTE = CD_PESSOA_PARENTE_P;
      if (existe_relacao_w > 0 ) then
        update PF_RELACAO_PARENTESCO set NR_SEQ_GRAU_PARENT = NR_SEQ_GRAU_PARENT_P
        where CD_PESSOA_FISICA = CD_PESSOA_FISICA_P and  CD_PESSOA_PARENTE = CD_PESSOA_PARENTE_P;
      else
        insert into PF_RELACAO_PARENTESCO(NR_SEQUENCIA, NR_SEQ_GRAU_PARENT, CD_PESSOA_FISICA, CD_PESSOA_PARENTE, DT_ATUALIZACAO, NM_USUARIO)
        VALUES (nextval('pf_relacao_parentesco_seq'), NR_SEQ_GRAU_PARENT_P, CD_PESSOA_FISICA_P, CD_PESSOA_PARENTE_P, clock_timestamp(), NM_USUARIO_P);

      end if;
    ELSE
      select CASE WHEN coalesce(max(NR_SEQ_GRAU_PARENT)::text, '') = '' THEN '0'  ELSE max(NR_SEQ_GRAU_PARENT) END NR_SEQ_GRAU_PARENT into STRICT existe_relacao_w from PF_RELACAO_PARENTESCO where CD_PESSOA_FISICA = CD_PESSOA_FISICA_P and  CD_PESSOA_PARENTE = CD_PESSOA_PARENTE_P;
      if (existe_relacao_w > 0 ) then
        delete from PF_RELACAO_PARENTESCO where CD_PESSOA_FISICA = CD_PESSOA_FISICA_P and CD_PESSOA_PARENTE = CD_PESSOA_PARENTE_P;
      end if;
    end if;
    commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE atualiza_grau_parentesco ( CD_PESSOA_FISICA_P bigint, CD_PESSOA_PARENTE_P bigint, NR_SEQ_GRAU_PARENT_P bigint, NM_USUARIO_P text, IE_OPERACAO_P text default 'I') FROM PUBLIC;

