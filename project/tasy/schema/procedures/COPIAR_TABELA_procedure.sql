-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE copiar_tabela ( nm_Tabela_Origem_p text, nm_Tabela_Destino_p text, ie_atributo_p text, ie_indice_p text, ie_integridade_p text) AS $body$
DECLARE


varsql				varchar(1) := chr(39);
ds_comando_w			varchar(2000);
vl_retorno_w			integer;
nm_indice_origem_w		varchar(50);
nm_integridade_Origem_w		varchar(50);
nm_indice_w				varchar(50);
nm_integridade_w			varchar(50);
ds_shortname_origem_w		varchar(10);
ds_shortname_destino_w		varchar(10);
nm_usuario_copia_w		varchar(15);
ie_temporaria_w			varchar(5);
ie_tabela_temporaria_w		varchar(1)	:= 'N';

C010 CURSOR FOR
SELECT NM_INDICE
FROM INDICE	a
WHERE NM_TABELA = nm_tabela_origem_p
  AND NOT EXISTS (SELECT 1 from Indice b
	where nm_tabela = nm_tabela_destino_p
	  and a.nm_indice = b.nm_indice);

C020 CURSOR FOR
SELECT NM_INTEGRIDADE_REFERENCIAL
FROM INTEGRIDADE_REFERENCIAL a
WHERE NM_TABELA = nm_tabela_origem_p
  AND NOT EXISTS (SELECT 1 from Integridade_Referencial b
	where nm_tabela = nm_tabela_destino_p
	  and a.nm_Integridade_Referencial  = b.nm_Integridade_Referencial);


BEGIN

select 	ds_shortname
into STRICT 	ds_shortname_origem_w
from 	tabela_sistema
where 	nm_tabela = nm_tabela_origem_p;

select 	ds_shortname,
	nm_usuario,
	ie_temporaria
into STRICT 	ds_shortname_destino_w,
	nm_usuario_copia_w,
	ie_temporaria_w
from 	tabela_sistema
where 	nm_tabela = nm_tabela_destino_p;

if (ie_temporaria_w in ('G','GD')) then
	ie_tabela_temporaria_w := 'S';
end if;

if (ie_atributo_p = 'S') then
	begin
	ds_Comando_w :=
			'Insert into Tabela_Atributo( nm_tabela, ' ||
			'	nm_atributo, nr_sequencia_criacao, ie_obrigatorio, ' ||
			'	ie_tipo_atributo, dt_atualizacao, nm_usuario, qt_tamanho, ' ||
			'	qt_decimais, ie_criar_alterar, ds_atributo, ie_situacao, '||
			'	qt_tamanho_calculo, qt_seq_inicio, qt_seq_incremento, ' ||
			'	dt_criacao, vl_default, ie_componente, ds_valores, ' ||
			'	cd_dominio, qt_tam_delphi, ds_label, nr_seq_apresent, ' ||
			'	ds_label_grid, nr_seq_ordem, qt_coluna, ds_mascara, ' ||
			'     qt_desloc_direita, qt_tam_label, qt_tam_grid, ie_readonly, ' ||
			'	ie_tabstop, nr_seq_localizador, qt_altura, ie_criar_descricao, ' ||
			'	nm_atributo_pai, ie_log_exclusao,ie_log_update,ie_atualizar_versao,ie_criar_desc_fk, ' ||
			'	cd_exp_desc, cd_exp_label, cd_exp_label_grid, cd_exp_valores) ' ||
       		'select ' || varsql || nm_tabela_destino_p || varsql ||
        		'     ,NM_ATRIBUTO, NR_SEQUENCIA_CRIACAO, ' ||
		      '     IE_OBRIGATORIO,  IE_TIPO_ATRIBUTO, sysdate, ' ||
		      '     :NM_USUARIO, QT_TAMANHO,  QT_DECIMAIS, ' ||
		      '     IE_CRIAR_ALTERAR, DS_ATRIBUTO, IE_SITUACAO, ' ||
		      '     QT_TAMANHO_CALCULO, QT_SEQ_INICIO, QT_SEQ_INCREMENTO, ' ||
		      '     sysdate, vl_default, ie_componente, ds_valores, ' ||
			'	cd_dominio, qt_tam_delphi, ds_label, nr_seq_apresent, ' ||
			'	ds_label_grid, nr_seq_ordem, qt_coluna, ds_mascara, ' ||
			'     qt_desloc_direita, qt_tam_label, qt_tam_grid, ie_readonly, ' ||
			'	ie_tabstop, nr_seq_localizador, qt_altura, ie_criar_descricao, ' ||
			'	nm_atributo_pai, ie_log_exclusao,ie_log_update,ie_atualizar_versao,ie_criar_desc_fk, ' ||
			'	cd_exp_desc, cd_exp_label, cd_exp_label_grid, cd_exp_valores ' ||
        		'from Tabela_atributo a ' ||
        		'where nm_tabela = ' || varsql || nm_tabela_origem_p || varsql ||
        		'  and not exists ( ' ||
		      '          select 1 from tabela_atributo b ' ||
		      '          where nm_tabela = ' || varsql || nm_tabela_destino_p || varsql ||
		      '            and a.nm_atributo = b.nm_atributo) ';
	CALL Exec_sql_dinamico_bv(nm_tabela_destino_p, ds_comando_w,'nm_usuario='||nm_usuario_copia_w);
	end;
end if;

if (ie_indice_p = 'S') then
	begin
	OPEN C010;
	LOOP
		FETCH C010 INTO nm_Indice_Origem_w;
		EXIT WHEN NOT FOUND; /* apply on C010 */
		nm_indice_w	 	:= nm_indice_Origem_w;
		nm_indice_w		:= replace(	nm_indice_w,
							ds_shortName_Origem_w,
							ds_shortName_Destino_w);
		ds_Comando_w :=
			'Insert into Indice( ' ||
				'NM_TABELA, '||
				'NM_INDICE, '||
				'IE_TIPO, '||
				'DT_ATUALIZACAO, '||
				'NM_USUARIO, '||
				'DS_INDICE, '||
				'IE_CRIAR_ALTERAR, '||
				'IE_SITUACAO, '||
				'DT_CRIACAO) '||
       			'select ' || varsql || nm_tabela_destino_p || varsql ||
        		'       ,'|| varsql || nm_indice_w || varsql ||  ', ' ||
			'        IE_TIPO, ' ||
		      	'        DT_ATUALIZACAO, ' ||
		      	'        NM_USUARIO, ' ||
		      	'        DS_INDICE, ' ||
		      	'        IE_CRIAR_ALTERAR, ' ||
        		'        IE_SITUACAO, ' ||
		      	'        sysdate ' ||
        		'from Indice a ' ||
        		'where nm_tabela = ' || varsql || nm_tabela_origem_p || varsql ||
		      	'  and a.nm_indice = ' || varsql || nm_indice_Origem_w || varsql;
		vl_retorno_w := Executar_sql_dinamico(ds_comando_w, vl_retorno_w);

		ds_Comando_w :=
			'Insert into Indice_Atributo( ' ||
				'NM_TABELA, '||
				'NM_INDICE, '||
				'NR_SEQUENCIA, '||
				'NM_ATRIBUTO, '||
				'DT_ATUALIZACAO, '||
				'NM_USUARIO) '||
       			'select ' || varsql || nm_tabela_destino_p || varsql ||
        		'       ,'|| varsql || nm_indice_w || varsql ||  ', ' ||
			'        NR_SEQUENCIA, ' ||
			'        NM_ATRIBUTO, ' ||
		      	'        DT_ATUALIZACAO, ' ||
		      	'        NM_USUARIO ' ||
        		'from Indice_Atributo a ' ||
        		'where nm_tabela = ' || varsql || nm_tabela_origem_p || varsql ||
		      	'  and a.nm_indice = ' || varsql || nm_indice_Origem_w || varsql;
		vl_retorno_w := Executar_sql_dinamico(ds_comando_w, vl_retorno_w);
	END LOOP;
	CLOSE C010;
	end;
end if;

if (ie_integridade_p = 'S') and (ie_tabela_temporaria_w = 'N') then
	begin
	OPEN C020;
	LOOP
		FETCH C020 INTO nm_integridade_origem_w;
		EXIT WHEN NOT FOUND; /* apply on C020 */
		nm_Integridade_w	:= nm_Integridade_origem_w;
		nm_Integridade_w 	:= replace(	nm_Integridade_w,
							ds_shortName_Origem_w,
							ds_shortName_Destino_w);
		ds_Comando_w :=
		'Insert into Integridade_referencial( ' ||
			'NM_TABELA, '||
			'NM_INTEGRIDADE_REFERENCIAL, '||
			'NM_TABELA_REFERENCIA, '||
			'DT_ATUALIZACAO, '||
			'NM_USUARIO, '||
			'IE_REGRA_DELECAO, '||
			'DS_INTEGRIDADE_REFERENCIAL, '||
			'IE_CRIAR_ALTERAR, '||
			'IE_SITUACAO, '||
			'DT_CRIACAO) '||
       		'select ' || varsql || nm_tabela_destino_p || varsql ||
        		'       ,'|| varsql || nm_Integridade_w || varsql ||  ', ' ||
			'        NM_TABELA_REFERENCIA, ' ||
			'        DT_ATUALIZACAO, ' ||
			'        NM_USUARIO, ' ||
			'        IE_REGRA_DELECAO, ' ||
			'        DS_INTEGRIDADE_REFERENCIAL, ' ||
			'        IE_CRIAR_ALTERAR, ' ||
        		'        IE_SITUACAO, ' ||
			'        sysdate ' ||
        		'from Integridade_referencial a ' ||
        		'where nm_tabela = ' || varsql || nm_tabela_origem_p || varsql ||
		      	'  and a.nm_integridade_referencial = ' ||
                  varsql || nm_integridade_Origem_w || varsql;
		vl_retorno_w := Executar_sql_dinamico(ds_comando_w, vl_retorno_w);

		ds_Comando_w :=
		'Insert into Integridade_Atributo( ' ||
			'NM_TABELA, '||
			'NM_INTEGRIDADE_REFERENCIAL, '||
			'NM_ATRIBUTO, '||
			'IE_SEQUENCIA_CRIACAO, '||
			'DT_ATUALIZACAO, '||
			'NM_USUARIO, '||
			'NM_ATRIBUTO_REF) '||
       		'select ' || varsql || nm_tabela_destino_p || varsql ||
        		'       ,'|| varsql || nm_Integridade_w || varsql ||  ', ' ||
			'        NM_ATRIBUTO, ' ||
			'        IE_SEQUENCIA_CRIACAO, ' ||
			'        DT_ATUALIZACAO, ' ||
			'        NM_USUARIO, ' ||
			'	NM_ATRIBUTO_REF '||
        		'from Integridade_Atributo a ' ||
        		'where nm_tabela = ' || varsql || nm_tabela_origem_p || varsql ||
		      	'  and a.nm_Integridade_Referencial = ' || varsql ||
				nm_integridade_Origem_w || varsql;
		vl_retorno_w := Executar_sql_dinamico(ds_comando_w, vl_retorno_w);

	END LOOP;
	CLOSE C020;
	end;
end if;

commit;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE copiar_tabela ( nm_Tabela_Origem_p text, nm_Tabela_Destino_p text, ie_atributo_p text, ie_indice_p text, ie_integridade_p text) FROM PUBLIC;

