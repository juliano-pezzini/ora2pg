-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_tarifacao_internet (nr_atendimento_p bigint, cd_procedimento_p bigint, qt_min_duracao_p bigint, dt_inicio_conexacao_p timestamp) AS $body$
DECLARE

 
nr_sequencia_w		bigint;
cd_convenio_w		integer;				
cd_categoria_w		varchar(10);
nr_seq_interno_w	bigint;
dt_entrada_unidade_w	timestamp;
cd_setor_atendimento_w	integer;
cd_cnpj_w		varchar(14);
cd_estabelecimento_w	smallint;
ds_obs_w		varchar(255);
dt_alta_w		timestamp;
ds_texto_tarifador_w	varchar(20);
		

BEGIN 
 
select 	dt_alta 
into STRICT	dt_alta_w 
from 	atendimento_paciente 
where 	nr_atendimento = nr_atendimento_p;
 
if	((coalesce(nr_atendimento_p,0) > 0) and (coalesce(dt_alta_w::text, '') = '')) then	 
 
	select	nextval('procedimento_paciente_seq') 
	into STRICT	nr_sequencia_w 
	;
 
	select	obter_convenio_atendimento(nr_atendimento_p), 
		obter_categoria_atendimento(nr_atendimento_p) 
	into STRICT	cd_convenio_w, 
		cd_categoria_w 
	;
	 
	select 	obter_setor_atendimento(nr_atendimento_p) 
	into STRICT	cd_setor_atendimento_w 
	;
	 
	select 	max(nr_seq_interno) 
	into STRICT	nr_seq_interno_w 
	from 	atend_paciente_unidade 
	where 	nr_atendimento = nr_atendimento_p 
	and	cd_setor_atendimento = cd_setor_atendimento_w;
	 
	select	dt_entrada_unidade 
	into STRICT	dt_entrada_unidade_w 
	from	atend_paciente_unidade 
	where	nr_seq_interno = nr_seq_interno_w;
	 
	select 	coalesce(cd_estabelecimento,1) 
	into STRICT	cd_estabelecimento_w 
	from 	atendimento_paciente 
	where 	nr_atendimento = nr_atendimento_p;
	 
	select	cd_cgc 
	into STRICT	cd_cnpj_w 
	from	estabelecimento 
	where	cd_estabelecimento = cd_estabelecimento_w;
	 
	ds_obs_w		:= wheb_mensagem_pck.get_texto(297879);
	ds_texto_tarifador_w	:= wheb_mensagem_pck.get_texto(297881);
	 
	insert into procedimento_paciente(nr_sequencia, 
		nr_atendimento, 
		dt_entrada_unidade, 
		cd_procedimento, 
		dt_procedimento, 
		qt_procedimento, 
		dt_atualizacao, 
		nm_usuario, 
		cd_convenio, 
		cd_categoria, 
		cd_acao, 
		cd_setor_atendimento, 
		ie_origem_proced, 
		tx_procedimento, 
		cd_cgc_prestador, 
		nm_usuario_original, 
		nr_seq_atepacu, 
		ie_auditoria, 
		nr_seq_proc_interno, 
		ie_valor_informado, 
		ds_observacao) 
	values (nr_sequencia_w, 
		nr_atendimento_p, 
		dt_entrada_unidade_w, 
		cd_procedimento_p, 
		dt_inicio_conexacao_p, 
		qt_min_duracao_p, 
		dt_inicio_conexacao_p, 
		ds_texto_tarifador_w, 
		cd_convenio_w, 
		cd_categoria_w, 
		1, 
		cd_setor_atendimento_w, 
		1, 
		100, 
		cd_cnpj_w, 
		ds_texto_tarifador_w, 
		nr_seq_interno_w, 
		'N', 
		null, 
		'N', 
		ds_obs_w);
 
	CALL atualiza_preco_procedimento(nr_sequencia_w, cd_convenio_w, ds_texto_tarifador_w);
 
end if;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_tarifacao_internet (nr_atendimento_p bigint, cd_procedimento_p bigint, qt_min_duracao_p bigint, dt_inicio_conexacao_p timestamp) FROM PUBLIC;

