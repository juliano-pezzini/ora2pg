-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE liquidar_tit_rec_perdas (nr_titulo_p bigint, nr_seq_trans_financ_p bigint, cd_tipo_recebimento_p text, dt_recebimento_p timestamp, nm_usuario_p text, cd_estabelecimento_p bigint, cd_motivo_desc_p bigint, cd_centro_custo_p bigint, cd_pessoa_fisica_desc_p text, cd_cgc_pessoa_desc_p text, ie_tipo_perda_p text, vl_baixa_p bigint, NR_SEQ_MOTIVO_PERDA_P bigint) AS $body$
DECLARE

 
nr_seq_desc_w		bigint;

cd_moeda_padrao_w		integer	:= 0;
nr_seq_baixa_w			integer	:= 0;
vl_juros_w			double precision	:= 0;
vl_desconto_w			double precision	:= 0;
vl_multa_w			double precision	:= 0;
cd_centro_custo_desc_w		bigint;
nr_seq_motivo_desc_w		bigint;
vl_rec_maior_w			double precision	:= 0;
nr_seq_solic_desc_w		bigint 	:= null;
ds_observacao_bordero_w		varchar(80);
vl_nota_credito_w		double precision;
nr_seq_regra_w			bigint;
ie_acao_w			varchar(5);
ie_acao_baixa_w			varchar(5);
ie_apropriar_w			varchar(1);
ie_controle_perdas_w		varchar(1);
nr_titulo_contab_w		bigint;


BEGIN 
select	cd_moeda_padrao, 
	ie_controle_perdas 
into STRICT	cd_moeda_padrao_w, 
	ie_controle_perdas_w 
from	parametro_contas_receber 
where	cd_estabelecimento	= cd_estabelecimento_p;
 
select	coalesce(max(nr_sequencia),0) + 1 
into STRICT	nr_seq_baixa_w 
from	titulo_receber_liq 
where	nr_titulo	= nr_titulo_p;
 
insert	into titulo_receber_liq(nr_titulo, 
	nr_sequencia, 
	dt_recebimento, 
	vl_recebido, 
	vl_descontos, 
	vl_juros, 
	vl_multa, 
	cd_moeda, 
	dt_atualizacao, 
	nm_usuario, 
	cd_tipo_recebimento, 
	ie_acao, 
	cd_serie_nf_devol, 
	nr_nota_fiscal_devol, 
	cd_banco, 
	cd_agencia_bancaria, 
	nr_documento, 
	nr_lote_banco, 
	cd_cgc_emp_cred, 
	nr_cartao_cred, 
	nr_adiantamento, 
	nr_lote_contabil, 
	nr_seq_trans_fin, 
	ie_lib_caixa, 
	cd_centro_custo_desc, 
	nr_seq_motivo_desc, 
	vl_perdas, 
	ds_observacao, 
	vl_nota_credito, 
	nr_lote_contab_antecip, 
	nr_lote_contab_pro_rata, 
	vl_rec_maior, 
	vl_glosa, 
	ie_tipo_perda) 
values (nr_titulo_p, 
	nr_seq_baixa_w, 
	coalesce(dt_recebimento_p, trunc(clock_timestamp(),'dd')), 
	0, 
	vl_desconto_w, 
	vl_juros_w, 
	vl_multa_w, 
	cd_moeda_padrao_w, 
	clock_timestamp(), 
	nm_usuario_p, 
	cd_tipo_recebimento_p, 
	'I', 
	null, 
	null, 
	null, 
	null, 
	null, 
	null, 
	null, 
	null, 
	null, 
	0, 
	nr_seq_trans_financ_p, 
	'S', 
	cd_centro_custo_p, 
	cd_motivo_desc_p, 
	vl_baixa_p, 
	ds_observacao_bordero_w, 
	vl_nota_credito_w, 
	0, 
	0, 
	0, 
	0, 
	ie_tipo_perda_p);
	/* Edgar 19/03/2008, OS 86492, alterei para chamar esta procedure sempre que lan√ßada a baixa */
 
	 
CALL gerar_titulo_rec_liq_cc(CD_ESTABELECIMENTO_P, 
		NULL, 
		NM_USUARIO_P, 
		nr_titulo_p, 
		NR_SEQ_BAIXA_W);
		 
if (ie_controle_perdas_w = 'S') then 
	CALL gerar_perda_contas_receber( 
		cd_estabelecimento_p, 
		null, 
		nr_titulo_p, 
		nr_seq_baixa_w, 
		vl_baixa_p, 
		ie_tipo_perda_p, 
		nm_usuario_p, 
		NR_SEQ_MOTIVO_PERDA_P, 
		coalesce(dt_recebimento_p, trunc(clock_timestamp(),'dd')));
end if;
		 
nr_titulo_contab_w := pls_gerar_tit_rec_liq_mens(nr_titulo_p, nr_seq_baixa_w, nm_usuario_p, nr_titulo_contab_w);	
 
	if (nr_titulo_contab_w IS NOT NULL AND nr_titulo_contab_w::text <> '') then 
		CALL wheb_mensagem_pck.exibir_mensagem_abort(236517, 'NR_TITULO=' || nr_titulo_contab_w);
	end if;
		 
		 
if (cd_cgc_pessoa_desc_p IS NOT NULL AND cd_cgc_pessoa_desc_p::text <> '') or (cd_pessoa_fisica_desc_p IS NOT NULL AND cd_pessoa_fisica_desc_p::text <> '') then 
	begin 
	select	nextval('titulo_receber_liq_desc_seq') 
	into STRICT	nr_seq_desc_w 
	;
		 
	insert  into titulo_receber_liq_desc(cd_centro_custo, 
		cd_cgc, 
		cd_pessoa_fisica, 
		dt_atualizacao, 
		nm_usuario, 
		nr_seq_motivo_desc, 
		nr_sequencia, 
		nr_titulo, 
		nr_seq_liq) 
	values (cd_centro_custo_p, 
		cd_cgc_pessoa_desc_p, 
		cd_pessoa_fisica_desc_p, 
		clock_timestamp(), 
		nm_usuario_p, 
		cd_motivo_desc_p, 
		nr_seq_desc_w, 
		nr_titulo_p, 
		nr_seq_baixa_w);
	end;
end if;
 
SELECT * FROM obter_regra_acao_pag_duplic(dt_recebimento_p, cd_estabelecimento_p, nm_usuario_p, nr_seq_regra_w, ie_acao_w) INTO STRICT nr_seq_regra_w, ie_acao_w;				
	 
CALL atualizar_saldo_tit_rec(nr_titulo_p, nm_usuario_p);
	 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE liquidar_tit_rec_perdas (nr_titulo_p bigint, nr_seq_trans_financ_p bigint, cd_tipo_recebimento_p text, dt_recebimento_p timestamp, nm_usuario_p text, cd_estabelecimento_p bigint, cd_motivo_desc_p bigint, cd_centro_custo_p bigint, cd_pessoa_fisica_desc_p text, cd_cgc_pessoa_desc_p text, ie_tipo_perda_p text, vl_baixa_p bigint, NR_SEQ_MOTIVO_PERDA_P bigint) FROM PUBLIC;

