-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_troco_movto_trans_financ ( vl_transacao_p bigint, nr_seq_saldo_caixa_p bigint, cd_estabelecimento_p bigint, nr_seq_caixa_p bigint, nr_seq_lote_p bigint, nm_usuario_p text ) AS $body$
DECLARE


nr_seq_trans_troco_w		parametro_tesouraria.nr_seq_trans_troco%type;
dt_saldo_w			caixa_saldo_diario.dt_saldo%type;
--cd_historico_w		transacao_financeira.cd_historico_caixa%type;
--cd_portador_w			transacao_financeira.cd_portador%type;
--cd_tipo_portador_w		transacao_financeira.cd_tipo_portador%type;
BEGIN

select	max(nr_seq_trans_troco)
into STRICT	nr_seq_trans_troco_w
from	parametro_tesouraria
where	cd_estabelecimento = cd_estabelecimento_p;

if (OBTER_PARAM_USUARIO_LOGADO(813,31)	= 'S') then
	select	max(dt_saldo)
	into STRICT	dt_saldo_w
	from	caixa_saldo_diario
	where	nr_sequencia	= nr_seq_saldo_caixa_p;
end if;


/* Esses 3 parâmetros dependem do NR_SEQUENCIA da transação financeira selecionada,
mas não faz sentido, porque pode ser qualquer registro selecionado no grid
e o troco não tem relação com isso.

if	(OBTER_PARAM_USUARIO_LOGADO(813,36)	= 'S') then
	select	cd_historico_caixa
	into	cd_historico_w
	from	transacao_financeira
	where	nr_sequencia	= pega da transação selecionada
end if;

select	max(cd_portador)
into	cd_portador_w
from	transacao_financeira
where	nr_sequencia	= pega da transação selecionada

select	max(cd_tipo_portador)
into	cd_tipo_portador_w
from	transacao_financeira
where	nr_sequencia	= pega da transação selecionada

*/
insert into	movto_trans_financ( 	nr_sequencia,
					dt_atualizacao,
					nm_usuario,
					ie_conciliacao,
					nr_lote_contabil,
					nr_seq_trans_financ,
					vl_transacao,
					dt_transacao,
					nr_seq_caixa,
					dt_referencia_saldo,
					nr_seq_lote,
					nr_seq_saldo_caixa,
					ie_rejeitado,
					ie_outros_rec,
					ie_conferido
					--cd_historico,
					--cd_portador,
					--cd_tipo_portador
				)
			values ( 	nextval('movto_trans_financ_seq'),
					clock_timestamp(),
					nm_usuario_p,
					'N',
					0,
					nr_seq_trans_troco_w,
					vl_transacao_p,
					coalesce(dt_saldo_w, clock_timestamp()),
					nr_seq_caixa_p,
					dt_saldo_w,
					nr_seq_lote_p,
					nr_seq_saldo_caixa_p,
					'N',
					'N',
					'S'
					--cd_historico_w,
					--cd_portador_w,
					--cd_tipo portador
				);

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_troco_movto_trans_financ ( vl_transacao_p bigint, nr_seq_saldo_caixa_p bigint, cd_estabelecimento_p bigint, nr_seq_caixa_p bigint, nr_seq_lote_p bigint, nm_usuario_p text ) FROM PUBLIC;

