-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_cobranca_caixa_240 ( nr_seq_cobr_escrit_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) AS $body$
DECLARE


ds_conteudo_w			varchar(240);
nr_inscricao_w			varchar(14);
cd_agencia_bancaria_w		varchar(5);
ie_digito_agencia_w		varchar(1);
cd_convenio_banco_w		varchar(6);
nm_empresa_w			varchar(30);
cd_banco_w			smallint;
ds_banco_w			varchar(30);
dt_geracao_w			varchar(14);
nr_remessa_w			bigint;
nr_seq_registro_w		bigint	:= 0;
nr_qt_registro_w		bigint	:= 0;
cd_agencia_titulo_w		varchar(5);
ie_dig_agencia_tit_w		varchar(1);
cd_carteira_w			varchar(2);
nr_nosso_numero_w		varchar(15);
nr_documento_w			varchar(11);
dt_vencimento_w			varchar(8);
dt_desconto_w			varchar(8);
vl_cobranca_w			double precision;
dt_emissao_w			varchar(8);
nr_titulo_w			varchar(25);
ie_tipo_inscricao_w		varchar(2);
nr_inscricao_tit_w		varchar(15);
nm_pessoa_w			varchar(40);
ds_endereco_w			varchar(40);
ds_bairro_w			varchar(15);
nr_cep_w			varchar(8);
ds_cidade_w			varchar(15);
ie_uf_w				varchar(2);
nr_ordem_registro_w		bigint	:= 0;
vl_multa_w			varchar(15);
vl_juros_w			double precision;
vl_desconto_w			varchar(15);
cd_juros_w			varchar(1);
vl_juros_dia_w			varchar(15);
vl_total_cobranca_w		double precision;

c01 CURSOR FOR
SELECT	lpad(substr(a.cd_agencia_bancaria,1,5),5,'0') cd_agencia_bancaria,
	rpad(substr(e.ie_digito,1,1),1,' ') ie_digito_agencia,
	lpad(substr(somente_numero(c.cd_carteira),1,2),2,'0') cd_carteira,
	lpad(b.nr_nosso_numero,15,'0') nr_nosso_numero,
	rpad(substr(b.nr_documento,1,11),11,' ') nr_documento,
	to_char(b.dt_pagamento_previsto,'ddmmyyyy') dt_vencimento,
	a.vl_cobranca,
	to_char(b.dt_emissao,'ddmmyyyy') dt_emissao,
	rpad(a.nr_titulo,25,' ') nr_titulo,
	CASE WHEN coalesce(b.cd_pessoa_fisica::text, '') = '' THEN '2'  ELSE '1' END  ie_tipo_inscricao,
	lpad(coalesce(b.cd_cgc,d.nr_cpf),15,'0') nr_inscricao_tit,
	rpad(substr(obter_nome_pf_pj(b.cd_pessoa_fisica,b.cd_cgc),1,40),40,' ') nm_pessoa,
	rpad(substr(obter_dados_pf_pj(b.cd_pessoa_fisica,b.cd_cgc,'R'),1,40),40,' ') ds_endereco,
	rpad(substr(obter_dados_pf_pj(b.cd_pessoa_fisica,b.cd_cgc,'B'),1,15),15,' ') ds_bairro,
	lpad(substr(obter_dados_pf_pj(b.cd_pessoa_fisica,b.cd_cgc,'CEP'),1,8),8,'0') nr_cep,
	rpad(substr(obter_dados_pf_pj(b.cd_pessoa_fisica,b.cd_cgc,'CI'),1,15),15,' ') ds_cidade,
	rpad(substr(obter_dados_pf_pj(b.cd_pessoa_fisica,b.cd_cgc,'UF'),1,2),2,' ') ie_uf,
	lpad(coalesce(somente_numero(to_char(coalesce(a.vl_multa,0),'9999999999990.00')),0),15,'0') vl_multa,
	coalesce(a.vl_juros,0) vl_juros,
	lpad(coalesce(somente_numero(to_char(coalesce(a.vl_desconto,0),'9999999999990.00')),0),15,'0') vl_desconto,
	lpad(coalesce(somente_numero(to_char((coalesce(a.vl_cobranca,0) * (coalesce(b.tx_juros,0) / 100)) / CASE WHEN coalesce(f.ie_tipo_taxa,'M')='M' THEN 30  ELSE 1 END ,'9999999999990.00')),0),15,'0') vl_juros_dia
FROM agencia_bancaria e, titulo_receber_cobr a, titulo_receber b
LEFT OUTER JOIN tipo_taxa f ON (b.cd_tipo_taxa_juro = f.cd_tipo_taxa)
LEFT OUTER JOIN pessoa_fisica d ON (b.cd_pessoa_fisica = d.cd_pessoa_fisica)
LEFT OUTER JOIN banco_carteira c ON (b.nr_seq_carteira_cobr = c.nr_sequencia)
WHERE e.cd_banco		= a.cd_banco and a.cd_agencia_bancaria	= e.cd_agencia_bancaria   and a.nr_titulo		= b.nr_titulo and a.nr_seq_cobranca	= nr_seq_cobr_escrit_p;


BEGIN

/* Limpa tabela */

Delete FROM w_envio_banco where nm_usuario = nm_usuario_p;

/* Header de arquivo */

nr_ordem_registro_w    := coalesce(nr_ordem_registro_w,0) + 1;

select	lpad(b.cd_cgc,14,'0') nr_inscricao,
	lpad(substr(c.cd_agencia_bancaria,1,5),5,'0') cd_agencia_bancaria,
	rpad(substr(coalesce(e.ie_digito,'0'),1,1),1,' ') ie_digito_agencia,
	lpad(c.cd_convenio_banco,6,'0') cd_convenio_banco,
	rpad(substr(coalesce(obter_nome_estabelecimento(b.cd_estabelecimento),' '),1,30),30,' ') nm_empresa,
	c.cd_banco,
	rpad(d.ds_banco,30,' ') ds_banco,
	to_char(clock_timestamp(),'ddmmyyyyhhmiss') dt_geracao,
	coalesce(a.nr_remessa,a.nr_sequencia) nr_remessa
into STRICT	nr_inscricao_w,
	cd_agencia_bancaria_w,
	ie_digito_agencia_w,
	cd_convenio_banco_w,
	nm_empresa_w,
	cd_banco_w,
	ds_banco_w,
	dt_geracao_w,
	nr_remessa_w
from	agencia_bancaria e,
	banco d,
	banco_estabelecimento c,
	estabelecimento b,
	cobranca_escritural a
where	e.cd_banco		= c.cd_banco
and	c.cd_agencia_bancaria	= e.cd_agencia_bancaria
and	c.cd_banco		= d.cd_banco
and	a.nr_seq_conta_banco	= c.nr_sequencia
and	a.cd_estabelecimento	= b.cd_estabelecimento
and	a.nr_sequencia		= nr_seq_cobr_escrit_p;

ds_conteudo_w	:=	lpad(cd_banco_w,3,'0') || /*Pos 01 a 03*/
			'0000' || /*Pos 04 a 07*/
			'0' || /*Pos 08*/
			rpad(' ',9,' ') || /*Pos  9 a 17*/
			'2' || /*Pos 18*/
			nr_inscricao_w || /*Pos 19 a 32*/
			rpad('0',20,'0') || /*Pos 33 a 52*/
			cd_agencia_bancaria_w || /*Pos 53 a  a 57*/
			ie_digito_agencia_w || /*Pos 58 */
			lpad(coalesce(cd_convenio_banco_w,'0'),6,'0') || /*Pos 59 a 64*/
			rpad('0',7,'0') || /*Pos 65 a 71*/
			'0' || /*Pos 72*/
			nm_empresa_w || /*Pos 73 a 102*/
			ds_banco_w || /*103*/
			rpad(' ',10,' ') ||
			'1' ||
			dt_geracao_w ||
			lpad(nr_remessa_w,6,'0') ||
			'101' || /*164 a 166*/
			'00000' || /*167 a 171*/
			rpad(' ',20,' ') || /*172 a 191*/
			rpad(' ',20,' ') || /*192 a 211*/
			rpad(' ',4,' ') || /*212 a 215*/
			rpad(' ',25,' '); /*216 a 240*/
insert into w_envio_banco(cd_estabelecimento,
	ds_conteudo,
	dt_atualizacao,
	dt_atualizacao_nrec,
	nm_usuario,
	nm_usuario_nrec,
	nr_seq_apres,
	nr_seq_apres_2,
	nr_sequencia)
values (cd_estabelecimento_p,
	ds_conteudo_w,
	clock_timestamp(),
	clock_timestamp(),
	nm_usuario_p,
	nm_usuario_p,
	nr_ordem_registro_w,
	nr_ordem_registro_w,
	nextval('w_envio_banco_seq'));

/* Header de lote */

nr_ordem_registro_w	:= coalesce(nr_ordem_registro_w,0) + 1;

ds_conteudo_w	:=	lpad(cd_banco_w,3,'0') || /*Pos 1 a 3*/
			'0001' || /*Pos 04 a 07*/
			'1' || /*Pos 08*/
			'R' || /*POs 09*/
			'01' || /*Pos 10 a 11*/
			'00' || /*Pos 12 a 13*/
			'060' || /*Pos 14 a 16*/
			' ' || /*Pos 17*/
			'2' || /*Pos 18 */
			lpad(coalesce(nr_inscricao_w,'0'),15,'0') || /*Pos 19 a 33*/
			lpad(coalesce(cd_convenio_banco_w,'0'),6,'0') || --lpad('0',6,'0') || /*Pos 34 a 39*/
			lpad('0',14,'0') || /*Pos 40 a 53*/
			lpad(coalesce(cd_agencia_bancaria_w,'0'),5,'0') || /*Pos 54 a 58*/
			coalesce(ie_digito_agencia_w,' ') || /*Pos 59*/
			lpad(coalesce(cd_convenio_banco_w,'0'),6,'0') || /*Pos 60 a 65*/
			rpad('0',7,'0') || /*Pos 66 a 72*/
			'0' || /*Pos 73*/
			rpad(nm_empresa_w,30,' ') || /*Pos 74 a 103*/
			rpad(' ',40,' ') || /*Pos 104 a 143*/
			rpad(' ',40,' ') || /*Pos 144 a 183*/
			lpad(nr_remessa_w,8,'0') || /*Pos 184 a 191*/
			to_char(clock_timestamp(),'ddmmyyyy') || /*Pos 192 a 199*/
			'00000000' ||--to_char(sysdate,'ddmmyyyy') || /*Pos 200 a 207*/
			rpad(' ',33,' '); /*Pos 208 a 240*/
insert into	w_envio_banco(cd_estabelecimento,
		ds_conteudo,
		dt_atualizacao,
		dt_atualizacao_nrec,
		nm_usuario,
		nm_usuario_nrec,
		nr_seq_apres,
		nr_seq_apres_2,
		nr_sequencia)
values (cd_estabelecimento_p,
		ds_conteudo_w,
		clock_timestamp(),
		clock_timestamp(),
		nm_usuario_p,
		nm_usuario_p,
		nr_ordem_registro_w,
		nr_ordem_registro_w,
		nextval('w_envio_banco_seq'));

open    c01;
loop
fetch	c01 into
	cd_agencia_titulo_w,
	ie_dig_agencia_tit_w,
	cd_carteira_w,
	nr_nosso_numero_w,
	nr_documento_w,
	dt_vencimento_w,
	vl_cobranca_w,
	dt_emissao_w,
	nr_titulo_w,
	ie_tipo_inscricao_w,
	nr_inscricao_tit_w,
	nm_pessoa_w,
	ds_endereco_w,
	ds_bairro_w,
	nr_cep_w,
	ds_cidade_w,
	ie_uf_w,
	vl_multa_w,
	vl_juros_w,
	vl_desconto_w,
	vl_juros_dia_w;
EXIT WHEN NOT FOUND; /* apply on c01 */

	/* Segmento P */

	nr_seq_registro_w    := coalesce(nr_seq_registro_w,0) + 1;
	nr_qt_registro_w     := coalesce(nr_qt_registro_w,0) + 1;
	nr_ordem_registro_w    := coalesce(nr_ordem_registro_w,0) + 1;
	vl_total_cobranca_w    := coalesce(vl_total_cobranca_w,0) + coalesce(vl_cobranca_w,0);
	
	if (vl_juros_w	> 0) then
		cd_juros_w	:= '1';
	else
		cd_juros_w	:= '3';
	end if;
	
	dt_desconto_w := null;
	
	if vl_juros_dia_w > 0 then
	  dt_desconto_w := dt_vencimento_w;
	end if;
	
	ds_conteudo_w	:=	lpad(cd_banco_w,3,'0') || /*Pos 01 a 03*/
				'0001' || /*Pos 04 a 07*/
				'3' || /*Pos 08*/
				lpad(nr_seq_registro_w,5,'0') || /*Pos 09 a 13*/
				'P' || /*Pos 14*/
				' ' || /*Pos 15*/
				'01' || /*Pos 16 a 17*/
				cd_agencia_titulo_w || /*Pos 18 a 22*/
				coalesce(ie_dig_agencia_tit_w,' ') || /*Pos 23*/
				lpad(coalesce(cd_convenio_banco_w,'0'),6,'0') || /*24 a 29*/
				lpad('0',8,'0') || /*Pos 30 a 37*/
				lpad('0',2,'0') || /*Pos 38 a 39*/
						'0' || /*Pos 40*/
				lpad(coalesce(cd_carteira_w,'0'),2,'0') || /*Pos 41 a 42*/
				lpad(coalesce(nr_nosso_numero_w,'0'),15,'0') || /*Pos 43 a 57*/

				--lpad(nvl(nr_documento_w,'0'),15,'0') || /*Pos 43 a 57*/
				'1' || /*Pos 58*/
				'1' || /*Pos 59*/
				'2' || /*Pos 60*/
				'2' || /*Pos 61*/
				'0' || /*Pos 62*/
				lpad(coalesce(nr_titulo_w,' '),11,' ') || /*Pos 63 a 73*/
				rpad(' ',4,' ') || /*Pos 74 a 77*/
				dt_vencimento_w || /*Pos 78 a 85*/
				lpad(somente_numero(to_char(coalesce(vl_cobranca_w,0),'9999999999990.00')),15,'0') || /*Pos 86 a 100*/
				'00000' || --lpad(nvl(cd_agencia_titulo_w,'0'),5,'0') || /*Pos 101 a 105*/
				coalesce(ie_dig_agencia_tit_w,'0') || /*Pos 106 */
				'99' || /*Pos 107 a 108*/
 -----Verificar pelo tipo de pagamento....
				'A' || /*Pos 109*/
				dt_emissao_w || /*Pos 110 a 117*/
				coalesce(cd_juros_w,'0') || /*Pos 118*/
				dt_vencimento_w || /*Pos 119 a 126*/
 --Data do Juros de mora
				vl_juros_dia_w || /*Pos 127 a 141*/
 --Juros de Mora por Dia/Taxa
				'0' || /*Pos 142*/
				'00000000' || --nvl(dt_desconto_w,'        ') || /*Pos 143 a 150*/
 -- Data do Desconto
				vl_desconto_w || /*Pos 151 a 165*/
 -- Valor/Percentual a ser Concedido
				lpad('0',15,'0') || /*Pos 166 a 180*/
				lpad('0',15,'0') || /*Pos 181 a 195*/
				lpad(coalesce(nr_titulo_w,' '),25,' ') || /*Pos 196 a 220*/
				'3' || /*Pos 221*/
				'00' || /*Pos 222 a 223*/
				'1' || /*Pos 224*/
				'030' || /*Pos 225 a 227*/
				'09' || /*Pos 228 a 229*/
				lpad('0',10,'0') || /*Pos 230 a 239*/
				' '; /*Pos 240*/
	insert into	w_envio_banco(cd_estabelecimento,
			ds_conteudo,
			dt_atualizacao,
			dt_atualizacao_nrec,
			nm_usuario,
			nm_usuario_nrec,
			nr_seq_apres,
			nr_seq_apres_2,
			nr_sequencia)
	values (cd_estabelecimento_p,
			ds_conteudo_w,
			clock_timestamp(),
			clock_timestamp(),
			nm_usuario_p,
			nm_usuario_p,
			nr_ordem_registro_w,
			nr_ordem_registro_w,
			nextval('w_envio_banco_seq'));

	/* Segmento Q */

	nr_seq_registro_w    := coalesce(nr_seq_registro_w,0) + 1;
	
	ds_conteudo_w	:=	lpad(cd_banco_w,3,'0') || /*01 a 03*/
				'0001' || /*04 a 07*/
				'3' || /*08*/
				lpad(nr_seq_registro_w,5,'0') || /*09 a 13*/
				'Q' || /*14*/
				' ' || /*15*/
				'01' || /*16 a 17*/
				ie_tipo_inscricao_w || /*18*/
				lpad(coalesce(nr_inscricao_w,'0'),15,'0') || /*19 a 33*/
				rpad(coalesce(substr(nm_pessoa_w,1,40),' '),40,' ') || /*34 a 73*/
				rpad(coalesce(substr(ds_endereco_w,1,40),' '),40, ' ') || /*Pos 74 a 113*/
				rpad(coalesce(substr(ds_bairro_w,1,15), ' '),15, ' ') || /*Pos 114 a 128*/
				lpad(coalesce(nr_cep_w,'0'),8,'0') || /*Pos 129 a 136*/
				rpad(coalesce(substr(ds_cidade_w,1,15),' '),15,' ') || /*137 a 151*/
				rpad(coalesce(substr(ie_uf_w,1,2),' '),2,' ') || /*Pos 152 a 153*/
				'0' || --'2' || /*154*/
				lpad('0',15,'0') || --lpad(nr_inscricao_w,15,'0') || /*155 a 169*/
				lpad(' ',40,' ') || --rpad(substr(nm_empresa_w,1,40),40,' ') || /*170 a 209*/
				'000' ||/*210 a 212*/
				rpad(' ',20,' ') || /*213 a 232*/
				rpad(' ',8,' '); /*233 a 240*/
	insert into	w_envio_banco(cd_estabelecimento,
			ds_conteudo,
			dt_atualizacao,
			dt_atualizacao_nrec,
			nm_usuario,
			nm_usuario_nrec,
			nr_seq_apres,
			nr_seq_apres_2,
			nr_sequencia)
	values (cd_estabelecimento_p,
			ds_conteudo_w,
			clock_timestamp(),
			clock_timestamp(),
			nm_usuario_p,
			nm_usuario_p,
			nr_ordem_registro_w,
			nr_ordem_registro_w,
			nextval('w_envio_banco_seq'));

end	loop;
close	c01;

/* Trailer de lote */

nr_ordem_registro_w    := coalesce(nr_ordem_registro_w,0) + 1;

ds_conteudo_w	:=	lpad(cd_banco_w,3,'0') ||
			'0001' ||
			'5' ||
			rpad(' ',9,' ') ||
			lpad(coalesce(nr_seq_registro_w,0) + 2,6,'0') ||
			lpad(nr_qt_registro_w,6,'0') ||
			lpad(somente_numero(to_char(coalesce(vl_total_cobranca_w,0),'999999999999990.00')),17,'0') ||
			lpad('0',6,'0') ||
			lpad('0',17,'0') ||
			lpad('0',6,'0') ||
			lpad('0',17,'0') ||
			rpad(' ',31,' ') ||
			rpad(' ',117,' ');

insert into	w_envio_banco(cd_estabelecimento,
		ds_conteudo,
		dt_atualizacao,
		dt_atualizacao_nrec,
		nm_usuario,
		nm_usuario_nrec,
		nr_seq_apres,
		nr_seq_apres_2,
		nr_sequencia)
values (cd_estabelecimento_p,
		ds_conteudo_w,
		clock_timestamp(),
		clock_timestamp(),
		nm_usuario_p,
		nm_usuario_p,
		nr_ordem_registro_w,
		nr_ordem_registro_w,
		nextval('w_envio_banco_seq'));

/* Trailer de arquivo */

nr_ordem_registro_w	:= coalesce(nr_ordem_registro_w,0) + 1;

ds_conteudo_w	:=	lpad(cd_banco_w,3,'0') ||
			'9999' ||
			'9' ||
			rpad(' ',9,' ') ||
			'000001' ||
			lpad(coalesce(nr_seq_registro_w,0) + 4,6,'0') ||
			rpad(' ',6,' ') ||
			rpad(' ',205,' ');

insert into	w_envio_banco(cd_estabelecimento,
		ds_conteudo,
		dt_atualizacao,
		dt_atualizacao_nrec,
		nm_usuario,
		nm_usuario_nrec,
		nr_seq_apres,
		nr_seq_apres_2,
		nr_sequencia)
values (cd_estabelecimento_p,
		ds_conteudo_w,
		clock_timestamp(),
		clock_timestamp(),
		nm_usuario_p,
		nm_usuario_p,
		nr_ordem_registro_w,
		nr_ordem_registro_w,
		nextval('w_envio_banco_seq'));

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_cobranca_caixa_240 ( nr_seq_cobr_escrit_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) FROM PUBLIC;

