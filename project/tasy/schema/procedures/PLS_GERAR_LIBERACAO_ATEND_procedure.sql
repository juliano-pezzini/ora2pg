-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_gerar_liberacao_atend ( nr_seq_segurado_p bigint, nr_seq_motivo_via_p bigint, cd_funcao_p bigint, cd_pessoa_fisica_p text, ie_opcao_p text, ds_observacao_p text, cd_estabelecimento_p bigint, nm_usuario_p text) AS $body$
DECLARE

				 
				 
/* OPCOES A SEREM ESCOLHIDAS*/
				 
/* 
	SC	- 	Solicitação da segunda via do cartão 
	OS	-	Gerar uma Ordem de Serviço 
*/
 
nr_seq_carteira_w		bigint;
ie_tipo_liberacao_w		varchar(5);
ie_tipo_w			varchar(10);
nr_seq_motivo_w			bigint;
ds_observacao_w			varchar(4000);
ds_motivo_w			varchar(250);


BEGIN 
 
if (ie_opcao_p = 'SC') then 
	select	coalesce(max(nr_sequencia),0) nr_sequencia 
	into STRICT	nr_seq_carteira_w 
	from	pls_segurado_carteira 
	where	nr_seq_segurado	= nr_seq_segurado_p;
	CALL pls_gerar_via_carteira(nr_seq_carteira_w,nr_seq_motivo_via_p,nm_usuario_p,cd_funcao_p,'M','S');
end if;
 
if (ie_opcao_p = 'OS') then 
 
	select	tipo, 
		nr_motivo, 
		ds_observacao 
	into STRICT	ie_tipo_w, 
		nr_seq_motivo_w, 
		ds_observacao_w 
	from (	SELECT 	'B' tipo, 
			nr_seq_motivo nr_motivo, 
			ds_observacao ds_observacao 
		from 	pls_regra_lib_req_web 
		where 	ie_situacao 					= 'A' 
		and	ie_tipo_liberacao				= 'B' 
		and 	nr_seq_segurado 				= nr_seq_segurado_p 	 
		and	clock_timestamp() between dt_inicio_vigencia and coalesce(dt_fim_vigencia,clock_timestamp()) 
		
union all
 
		SELECT 	'C' tipo, 
			nr_seq_motivo_cartao nr_motivo, 
			ds_observacao ds_observacao 
		from 	pls_regra_lib_req_web 
		where 	ie_situacao 					= 'A' 
		and	ie_tipo_liberacao				= 'C' 
		and 	nr_seq_segurado 				= nr_seq_segurado_p 	 
		and	clock_timestamp() between dt_inicio_vigencia and coalesce(dt_fim_vigencia,clock_timestamp())) alias7;
		 
	 
	if (ie_tipo_w = 'B') then 
		select ds_motivo 
		into STRICT	ds_motivo_w 
		from  pls_motivo_lib_digital 
		where 	ie_situacao = 'A' 
		and	nr_sequencia		= nr_seq_motivo_w	 
		and   cd_estabelecimento 	= cd_estabelecimento_p;
	end if;
 
	if (ie_tipo_w = 'C') then 
		select ds_motivo 
		into STRICT	ds_motivo_w 
		from  pls_motivo_lib_cartao 
		where 	ie_situacao = 'A' 
		and	nr_sequencia		= nr_seq_motivo_w	 
		and   cd_estabelecimento 	= cd_estabelecimento_p;
	end if;
	 
	insert into	man_ordem_servico(nr_sequencia, cd_pessoa_solicitante, ds_dano, 
			ds_dano_breve, dt_atualizacao, dt_ordem_servico, 
			ie_parado, ie_prioridade, ie_tipo_ordem, 
			nm_usuario, ie_prioridade_cliente, ie_classificacao, 
			ie_classificacao_cliente, ie_forma_receb, ie_origem_os, 
			ie_exclusiva, ie_tipo_os_qualidade, dt_inicio_previsto, 
			dt_fim_previsto, dt_inicio_desejado, dt_conclusao_desejada, 
			ie_status_ordem) values (nextval('man_ordem_servico_seq'), cd_pessoa_fisica_p, ds_observacao_p, 
			ds_motivo_w, clock_timestamp(), clock_timestamp(), 
			'N', 'M', 0, 
			nm_usuario_p, 'M', 'S', 
			'S', 'W', 3, 
			'G', 2, clock_timestamp(), 
			clock_timestamp() + interval '30 days', clock_timestamp(), clock_timestamp() + interval '23 days', 
			'1');
end if;
commit;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_gerar_liberacao_atend ( nr_seq_segurado_p bigint, nr_seq_motivo_via_p bigint, cd_funcao_p bigint, cd_pessoa_fisica_p text, ie_opcao_p text, ds_observacao_p text, cd_estabelecimento_p bigint, nm_usuario_p text) FROM PUBLIC;

