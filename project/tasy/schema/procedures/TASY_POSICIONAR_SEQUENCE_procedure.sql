-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE tasy_posicionar_sequence ( nm_tabela_p text, nm_atributo_p text, ie_limite_p text) AS $body$
DECLARE


/*
ie_limete_p - > 
R 	-	 recriar
S,N 	- posicionar


*/
		
qt_atual_w		bigint;
qt_seq_w		bigint;
ds_comando_w		varchar(2000);
nm_sequence_w		varchar(50);/* Rafael em 24/11/2006 */
qt_seq_incr_atr_w	bigint;
qt_seq_max_w		bigint;
nr_controle_unico_w		varchar(2);


BEGIN
nm_sequence_w	:= nm_tabela_p;
if (nm_atributo_p = 'NR_PRONTUARIO') then
	nm_sequence_w	:= 'PRONTUARIO';
elsif (nm_atributo_p = 'NR_SAME') then
	nm_sequence_w	:= 'SAME';
elsif (nm_tabela_p = 'TITULO_RECEBER') then
	nm_sequence_w	:= 'TITULO';
elsif (nm_tabela_p = 'REQUISICAO_MATERIAL') then
	nm_sequence_w	:= 'REQUISICAO';
elsif (nm_atributo_p = 'NR_CONTRATO') then /* Paulo 12/03/2010 - Utilizado para os contratos de Plano de saúde */
	nm_sequence_w	:= 'NR_CONTRATO';
elsif (nm_tabela_p = 'MPREV_AGENDAMENTO') then
	nm_sequence_w	:= 'MPREV_SEQ_AGENDAMENTO';
elsif (nm_tabela_p = 'CONVERSAO_MATERIAL_CONVENIO') then
	nm_sequence_w	:= 'CONVERSAO_MAT_CONVENIO';
elsif (nm_tabela_p = 'ATENDIMENTO_VISITA') then
	nr_controle_unico_w := Obter_Param_Usuario(8014, 119, obter_perfil_ativo, obter_usuario_ativo, obter_estabelecimento_ativo, nr_controle_unico_w);
	if (nr_controle_unico_w = 'S') then
		nm_sequence_w	:= 'CONTROLE_VISITA_UNICO_SEQ';
	else
		nm_sequence_w	:= 'ATENDIMENTO_VISITA_SEQ2';
	end if;
elsif (nm_tabela_p = 'ATENDIMENTO_ACOMPANHANTE') then
	nr_controle_unico_w := Obter_Param_Usuario(8014, 119, obter_perfil_ativo, obter_usuario_ativo, obter_estabelecimento_ativo, nr_controle_unico_w);
	if (nr_controle_unico_w = 'S') then
		nm_sequence_w	:= 'CONTROLE_VISITA_UNICO_SEQ';
	else
		nm_sequence_w	:= 'CONTROLE_ACOMPANHANTE_SEQ';
	end if;	
end if;

if (upper(nm_tabela_p) = 'PESSOA_FISICA') then
	ds_comando_w	:= 'Select max(somente_numero(' || nm_atributo_p || ')) from ' || nm_tabela_p;
else
	ds_comando_w	:= 'Select max(' || nm_atributo_p || ') from ' || nm_tabela_p;
end if;

qt_atual_w := Obter_valor_Dinamico(ds_comando_w, qt_atual_w);
ds_comando_w	:= 'Select '  || nm_sequence_w || '_seq.nextval from dual';
qt_seq_w := Obter_valor_Dinamico(ds_comando_w, qt_seq_w);

if (ie_limite_p = 'S') and
	((qt_atual_w - qt_seq_w) > 20000) then
	/* A diferença é muito grande para tabela #@NM_TABELA#@ 
	Registro Atual: #@QT_ATUAL#@ seq: #@QT_SEQ#@ */
	CALL wheb_mensagem_pck.exibir_mensagem_abort(267143, 'NM_TABELA=' || nm_tabela_p ||
							';QT_ATUAL=' || qt_atual_w ||
							';QT_SEQ=' || qt_seq_w);
end if;

/*Para que a procedure não fique em loop quando a tabela não possui sequence */

if (qt_seq_w = 0) then
	qt_seq_w	:= 9999999999;
end if;

if (ie_limite_p in ('R','N')) then
	select 	coalesce(max(qt_seq_incremento),1)
	into STRICT	qt_seq_incr_atr_w
	from 	tabela_atributo
	where	nm_tabela = nm_tabela_p
	and		nm_atributo = nm_atributo_p;

	nm_sequence_w := nm_sequence_w || '_seq';
	
	ds_comando_w := 'drop sequence ' || nm_sequence_w;

	if ((nm_sequence_w IS NOT NULL AND nm_sequence_w::text <> '') and (qt_seq_incr_atr_w IS NOT NULL AND qt_seq_incr_atr_w::text <> '') and (qt_atual_w IS NOT NULL AND qt_atual_w::text <> '')) then
		
		begin
			CALL Exec_Sql_Dinamico_bv(nm_sequence_w, ds_comando_w,'');			
		exception
		when others then
			ds_comando_w:=ds_comando_w;
		end;

		qt_seq_max_w	:= 9999999999;
		ds_comando_w	:= 'Create Sequence ' || nm_sequence_w;
		ds_comando_w	:= ds_comando_w || ' Increment by ' || qt_seq_incr_atr_w;
		ds_comando_w	:= ds_comando_w || ' Start with ' || (qt_atual_w+1);
		ds_comando_w	:= ds_comando_w || ' MaxValue ' || qt_seq_max_w;
		ds_comando_w	:= ds_comando_w || ' Cycle';
		ds_comando_w	:= ds_comando_w || ' NoCache';
		CALL gravar_processo_longo(ds_comando_w,'TASY_POSICIONAR_SEQUENCE',null);
		CALL Exec_Sql_Dinamico_bv(nm_sequence_w, ds_comando_w,'');	

	end if;	
	
end if;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE tasy_posicionar_sequence ( nm_tabela_p text, nm_atributo_p text, ie_limite_p text) FROM PUBLIC;

