-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_gerar_bloqueto_mens ( nr_seq_lote_p pls_lote_mensalidade.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type) AS $body$
DECLARE


/* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Finalidade: Rotina para atualizar o NR_BLOQUETO dos titulos do lote de mensalidade
-------------------------------------------------------------------------------------------------------------------

Locais de chamada direta: 
[  ]  Objetos do dicionario [X] Tasy (Delphi/Java) [  ] Portal [  ]  Relatorios [ ] Outros:
 ------------------------------------------------------------------------------------------------------------------

Pontos de atencao:
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */
C01 CURSOR FOR
	SELECT	a.nr_titulo,
		coalesce(c.ie_linha_digitavel,'S') ie_linha_digitavel,
		a.ie_tipo_titulo
	from	titulo_receber	a,
		pls_mensalidade	b,
		pls_contrato_pagador_fin c
	where	b.nr_sequencia	= a.nr_seq_mensalidade
	and	c.nr_sequencia	= b.nr_seq_pagador_fin
	and	b.nr_seq_lote	= nr_seq_lote_p;

BEGIN

for r_c01_w in C01 loop
	begin
	if (r_c01_w.ie_linha_digitavel = 'S') then
		CALL pls_alterar_carteira_cob_bol(r_c01_w.nr_titulo, 'ME', nm_usuario_p);
		CALL gerar_bloqueto_tit_rec(r_c01_w.nr_titulo, 'OPSMS');
		CALL atualizar_emissao_tit_rec(r_c01_w.nr_titulo, null, 'EM', nm_usuario_p);
		
		if (r_c01_w.ie_tipo_titulo <> '1') then
			update	titulo_receber
			set	ie_tipo_titulo = '1',
				dt_atualizacao = clock_timestamp(),
				nm_usuario = nm_usuario_p,
				dt_emissao_bloqueto = clock_timestamp()
			where	nr_titulo = r_c01_w.nr_titulo;
		end if;
	end if;
	end;
end loop; --C01
commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_gerar_bloqueto_mens ( nr_seq_lote_p pls_lote_mensalidade.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type) FROM PUBLIC;

