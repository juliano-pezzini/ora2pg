-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_autor_quantidade ( nm_usuario_p text, nr_atendimento_p bigint, nr_seq_autorizacao_p bigint default null, nr_seq_procedimento_p bigint DEFAULT NULL, cd_convenio_p bigint DEFAULT NULL, cd_estabelecimento_p bigint DEFAULT NULL, nr_seq_setor_proc_prescr_p bigint default null, nr_prescricao_p bigint default null, qt_autor_total_p bigint default null, qt_proc_autor_total_p bigint default null) AS $body$
DECLARE


nm_usuario_w               usuario.nm_usuario%type := nm_usuario_p;
nr_atendimento_w           atendimento_paciente.nr_atendimento%type := nr_atendimento_p;
nr_seq_procedimento_w      procedimento_autorizado.nr_sequencia%type := nr_seq_procedimento_p;
cd_convenio_w              convenio.cd_convenio%type := cd_convenio_p;
cd_estabelecimento_w       estabelecimento.cd_estabelecimento%type := cd_estabelecimento_p;
nr_seq_setor_proc_prescr_w prescr_procedimento.cd_setor_atendimento%type := nr_seq_setor_proc_prescr_p;

nr_seq_autor_qtd_regra_w     regra_autor_quantidade.nr_sequencia%type;
ie_tipo_atendimento_regra_w  regra_autor_quantidade.ie_tipo_atendimento%type;
ie_clinica_regra_w           regra_autor_quantidade.ie_clinica%type;
cd_setor_atendimento_regra_w regra_autor_quantidade.cd_setor_atendimento%type;
qt_item_regra_w              regra_autor_quantidade.qt_item%type;

nr_seq_aut_desb_disp_w   autorizacao_convenio.nr_sequencia%type;
nr_seq_aut_conv_insert_w autorizacao_convenio.nr_sequencia%type;

ie_tipo_atendimento_w atendimento_paciente.ie_tipo_atendimento%type;
ie_clinica_w atendimento_paciente.ie_clinica%type;

ie_existe_regra_qtd_w regra_autor_quantidade.nr_sequencia%type;


BEGIN

--Verificar se existe alguma regra de quantidade
select	max(nr_sequencia)
into STRICT ie_existe_regra_qtd_w
from regra_autor_quantidade;

if (ie_existe_regra_qtd_w > 0) then

    --buscar regra de quantidade do estabelecimento, convenio e setor
    select	max(nr_sequencia),
        max(ie_tipo_atendimento),
        max(ie_clinica),
        max(cd_setor_atendimento),
        max(qt_item)
    into STRICT   nr_seq_autor_qtd_regra_w,
        ie_tipo_atendimento_regra_w,
        ie_clinica_regra_w,
        cd_setor_atendimento_regra_w,
        qt_item_regra_w
    from regra_autor_quantidade
    where cd_convenio	   = cd_convenio_w
    and cd_estabelecimento = cd_estabelecimento_w
    and cd_setor_atendimento = nr_seq_setor_proc_prescr_w
    order by dt_atualizacao desc LIMIT 1;

    --buscar dados do atendimento    
    select max(ie_tipo_atendimento),
        max(ie_clinica)
    into STRICT ie_tipo_atendimento_w,
        ie_clinica_w 
    from atendimento_paciente
    where nr_atendimento = nr_atendimento_w;

    --verifica se os dados estao de acordo com a regra de quantidade 
    if ((nr_seq_autor_qtd_regra_w IS NOT NULL AND nr_seq_autor_qtd_regra_w::text <> '') 
    and qt_item_regra_w > 0
    and coalesce(ie_tipo_atendimento_regra_w, ie_tipo_atendimento_w, 0) = coalesce(ie_tipo_atendimento_w,0)
    and coalesce(ie_clinica_regra_w, ie_clinica_w, 0) = coalesce(ie_clinica_w,0)
    and cd_setor_atendimento_regra_w = coalesce(nr_seq_setor_proc_prescr_w,0)) then
    
        -- se for o primeiro item da prescricao apenas seta o cd da regra de quantidade caso exista
        if (qt_autor_total_p = 1 and qt_proc_autor_total_p = 1) then
            update autorizacao_convenio
            set nr_seq_regra_autor_qtd = nr_seq_autor_qtd_regra_w
            where nr_sequencia = nr_seq_autorizacao_p;
            commit;
        else

            --buscar se ja existe alguma autorizacao desdobrada com quantia vaga de procedimentos e com o setor do item 
            select max(a.nr_sequencia)
            into STRICT nr_seq_aut_desb_disp_w
            from  autorizacao_convenio a
            where (a.nr_atendimento         = nr_atendimento_w
                and   a.cd_convenio            = cd_convenio_w
                and   a.nr_seq_regra_autor_qtd = nr_seq_autor_qtd_regra_w
                and   a.nr_prescricao          = nr_prescricao_p
                and obter_estagio_autor(a.nr_seq_estagio,'C') = 1
                and (SELECT count(b.nr_sequencia)
                    from  procedimento_autorizado b
                    where b.nr_sequencia_autor = a.nr_sequencia) < qt_item_regra_w)
            or a.nr_sequencia = nr_seq_autorizacao_p
                and (select count(b.nr_sequencia)
                    from  procedimento_autorizado b
                    where b.nr_sequencia_autor = a.nr_sequencia) = qt_item_regra_w
            order by a.dt_atualizacao desc;

            --cria nova autorizacao se nao existir
            if (coalesce(nr_seq_aut_desb_disp_w::text, '') = '') then
                select	nextval('autorizacao_convenio_seq')
                    into STRICT	nr_seq_aut_conv_insert_w
;

                insert into autorizacao_convenio(cd_ausencia_cod_valid
                ,cd_autorizacao
                ,cd_autorizacao_prest
                ,cd_cgc_prestador
                ,cd_convenio
                ,cd_empresa_pac
                ,cd_estabelecimento
                ,cd_interno_contrat_exec
                ,cd_interno_contrat_solic
                ,cd_interno_origem_tiss
                ,cd_medico_exec_agenda
                ,cd_medico_solicitante
                ,cd_medico_solic_tiss
                ,cd_pessoa_fisica
                ,cd_prestador_tiss
                ,cd_procedimento_convenio
                ,cd_procedimento_principal
                ,cd_proc_principal_loc
                ,cd_senha
                ,cd_senha_provisoria
                ,cd_setor_origem
                ,cd_setor_resp
                ,cd_tipo_acomodacao
                ,cd_tipo_acomod_desej
                ,cd_tipo_procedimento
                ,cd_validacao_tiss
                ,ds_cbo_tiss
                ,ds_contratado_exec_tiss
                ,ds_dia_ciclo
                ,ds_indicacao
                ,ds_motivo_cancelamento
                ,ds_observacao
                ,ds_prestador_tiss
                ,ds_tarja_cartao
                ,dt_agenda
                ,dt_agenda_cons
                ,dt_agenda_integ
                ,dt_atualizacao
                ,dt_atualizacao_nrec
                ,dt_autorizacao
                ,dt_desdobramento_conta
                ,dt_entrada_prevista
                ,dt_envio
                ,dt_fim_vigencia
                ,dt_geracao_cih
                ,dt_geracao_pacote
                ,dt_inicio_vigencia
                ,dt_pedido_medico
                ,dt_referencia
                ,dt_retorno
                ,dt_validade_guia
                ,ie_carater_int_tiss
                ,ie_eclipse_status
                ,ie_origem_proced
                ,ie_previsao_uso_opme
                ,ie_previsao_uso_quimio
                ,ie_regime_internacao
                ,ie_resp_autor
                ,ie_tipo_autorizacao
                ,ie_tipo_dia
                ,ie_tipo_guia
                ,ie_tipo_internacao_tiss
                ,ie_tipo_tramite
                ,ie_tiss_tipo_acidente
                ,ie_tiss_tipo_anexo_autor
                ,ie_tiss_tipo_etapa_autor
                ,nm_responsavel
                ,nm_usuario
                ,nm_usuario_nrec
                ,nm_usuario_resp
                ,nr_atendimento
                ,nr_ciclo
                ,nr_contract_partner
                ,nr_interno_conta_ref
                ,nr_ordem_compra
                ,nr_prescricao
                ,nr_seq_age_integ
                ,nr_seq_agenda
                ,nr_seq_agenda_consulta
                ,nr_seq_agenda_proc
                ,nr_seq_apres
                ,nr_seq_auditoria
                ,nr_seq_autor_cirurgia
                ,nr_seq_autor_desdob
                ,nr_seq_autorizacao
                ,nr_seq_autor_origem
                ,nr_seq_classif
                ,nr_seq_episodio
                ,nr_seq_estagio
                ,nr_seq_gestao
                ,nr_seq_guia_plano
                ,nr_seq_paciente
                ,nr_seq_paciente_setor
                ,nr_seq_proc_interno
                ,nr_seq_regra_autor
                ,nr_seq_regra_autor_qtd
                ,nr_seq_rxt_tratamento
                ,nr_sequencia
                ,qt_dia_autorizado
                ,qt_dia_solicitado
                ,qt_dias_prazo) (SELECT cd_ausencia_cod_valid
                ,cd_autorizacao
                ,cd_autorizacao_prest
                ,cd_cgc_prestador
                ,cd_convenio
                ,cd_empresa_pac
                ,cd_estabelecimento
                ,cd_interno_contrat_exec
                ,cd_interno_contrat_solic
                ,cd_interno_origem_tiss
                ,cd_medico_exec_agenda
                ,cd_medico_solicitante
                ,cd_medico_solic_tiss
                ,cd_pessoa_fisica
                ,cd_prestador_tiss
                ,cd_procedimento_convenio
                ,cd_procedimento_principal
                ,cd_proc_principal_loc
                ,cd_senha
                ,cd_senha_provisoria
                ,cd_setor_origem
                ,cd_setor_resp
                ,cd_tipo_acomodacao
                ,cd_tipo_acomod_desej
                ,cd_tipo_procedimento
                ,cd_validacao_tiss
                ,ds_cbo_tiss
                ,ds_contratado_exec_tiss
                ,ds_dia_ciclo
                ,ds_indicacao
                ,ds_motivo_cancelamento
                ,ds_observacao
                ,ds_prestador_tiss
                ,ds_tarja_cartao
                ,dt_agenda
                ,dt_agenda_cons
                ,dt_agenda_integ
                ,clock_timestamp()
                ,dt_atualizacao_nrec
                ,dt_autorizacao
                ,dt_desdobramento_conta
                ,dt_entrada_prevista
                ,dt_envio
                ,dt_fim_vigencia
                ,dt_geracao_cih
                ,dt_geracao_pacote
                ,dt_inicio_vigencia
                ,dt_pedido_medico
                ,dt_referencia
                ,dt_retorno
                ,dt_validade_guia
                ,ie_carater_int_tiss
                ,ie_eclipse_status
                ,ie_origem_proced
                ,ie_previsao_uso_opme
                ,ie_previsao_uso_quimio
                ,ie_regime_internacao
                ,ie_resp_autor
                ,ie_tipo_autorizacao
                ,ie_tipo_dia
                ,ie_tipo_guia
                ,ie_tipo_internacao_tiss
                ,ie_tipo_tramite
                ,ie_tiss_tipo_acidente
                ,ie_tiss_tipo_anexo_autor
                ,ie_tiss_tipo_etapa_autor
                ,nm_responsavel
                ,nm_usuario_w
                ,nm_usuario_nrec
                ,nm_usuario_resp
                ,nr_atendimento
                ,nr_ciclo
                ,nr_contract_partner
                ,nr_interno_conta_ref
                ,nr_ordem_compra
                ,nr_prescricao
                ,nr_seq_age_integ
                ,nr_seq_agenda
                ,nr_seq_agenda_consulta
                ,nr_seq_agenda_proc
                ,nr_seq_apres
                ,nr_seq_auditoria
                ,nr_seq_autor_cirurgia
                ,nr_seq_autor_desdob
                ,nr_seq_autorizacao + 1
                ,nr_seq_autor_origem
                ,nr_seq_classif
                ,nr_seq_episodio
                ,nr_seq_estagio
                ,nr_seq_gestao
                ,nr_seq_guia_plano
                ,nr_seq_paciente
                ,nr_seq_paciente_setor
                ,nr_seq_proc_interno
                ,nr_seq_regra_autor
                ,nr_seq_autor_qtd_regra_w
                ,nr_seq_rxt_tratamento
                ,nr_seq_aut_conv_insert_w
                ,qt_dia_autorizado
                ,qt_dia_solicitado
                ,qt_dias_prazo
                from autorizacao_convenio 
                where nr_sequencia = nr_seq_autorizacao_p  LIMIT 1);
                commit;
            end if;

            --transfere o procedimento para a autorizacao desdobrada
            if ((nr_seq_aut_conv_insert_w IS NOT NULL AND nr_seq_aut_conv_insert_w::text <> '') or
            (nr_seq_aut_desb_disp_w IS NOT NULL AND nr_seq_aut_desb_disp_w::text <> '')) then
                
                update procedimento_autorizado
                set nr_sequencia_autor = coalesce(nr_seq_aut_desb_disp_w, nr_seq_aut_conv_insert_w)
                where nr_sequencia = nr_seq_procedimento_w;
                commit;
            end if;
        end if;
    else --se o procedimento nao tiver setor ou o setor nao tiver cadastro na regra
    
        --buscar regra de quantidade do estabelecimento e convenio
        select	max(nr_sequencia)
        into STRICT   nr_seq_autor_qtd_regra_w
        from regra_autor_quantidade
        where cd_convenio	   = cd_convenio_w
        and cd_estabelecimento = cd_estabelecimento_w
        order by dt_atualizacao desc LIMIT 1;

        if (nr_seq_autor_qtd_regra_w IS NOT NULL AND nr_seq_autor_qtd_regra_w::text <> '') then
        
            --buscar se existe alguma autorizacao sem regra cadastrada para esta prescricao
            select max(a.nr_sequencia)
            into STRICT nr_seq_aut_desb_disp_w
            from  autorizacao_convenio a
            where a.nr_atendimento  = nr_atendimento_w
            and   a.cd_convenio     = cd_convenio_w
            and   coalesce(a.nr_seq_regra_autor_qtd::text, '') = '' 
            and   a.nr_prescricao    = nr_prescricao_p
            and   obter_estagio_autor(a.nr_seq_estagio,'C') = 1;
                    
            if (coalesce(nr_seq_aut_desb_disp_w::text, '') = '') then
                select	nextval('autorizacao_convenio_seq')
                    into STRICT	nr_seq_aut_conv_insert_w
;

                insert into autorizacao_convenio(cd_ausencia_cod_valid
                ,cd_autorizacao
                ,cd_autorizacao_prest
                ,cd_cgc_prestador
                ,cd_convenio
                ,cd_empresa_pac
                ,cd_estabelecimento
                ,cd_interno_contrat_exec
                ,cd_interno_contrat_solic
                ,cd_interno_origem_tiss
                ,cd_medico_exec_agenda
                ,cd_medico_solicitante
                ,cd_medico_solic_tiss
                ,cd_pessoa_fisica
                ,cd_prestador_tiss
                ,cd_procedimento_convenio
                ,cd_procedimento_principal
                ,cd_proc_principal_loc
                ,cd_senha
                ,cd_senha_provisoria
                ,cd_setor_origem
                ,cd_setor_resp
                ,cd_tipo_acomodacao
                ,cd_tipo_acomod_desej
                ,cd_tipo_procedimento
                ,cd_validacao_tiss
                ,ds_cbo_tiss
                ,ds_contratado_exec_tiss
                ,ds_dia_ciclo
                ,ds_indicacao
                ,ds_motivo_cancelamento
                ,ds_observacao
                ,ds_prestador_tiss
                ,ds_tarja_cartao
                ,dt_agenda
                ,dt_agenda_cons
                ,dt_agenda_integ
                ,dt_atualizacao
                ,dt_atualizacao_nrec
                ,dt_autorizacao
                ,dt_desdobramento_conta
                ,dt_entrada_prevista
                ,dt_envio
                ,dt_fim_vigencia
                ,dt_geracao_cih
                ,dt_geracao_pacote
                ,dt_inicio_vigencia
                ,dt_pedido_medico
                ,dt_referencia
                ,dt_retorno
                ,dt_validade_guia
                ,ie_carater_int_tiss
                ,ie_eclipse_status
                ,ie_origem_proced
                ,ie_previsao_uso_opme
                ,ie_previsao_uso_quimio
                ,ie_regime_internacao
                ,ie_resp_autor
                ,ie_tipo_autorizacao
                ,ie_tipo_dia
                ,ie_tipo_guia
                ,ie_tipo_internacao_tiss
                ,ie_tipo_tramite
                ,ie_tiss_tipo_acidente
                ,ie_tiss_tipo_anexo_autor
                ,ie_tiss_tipo_etapa_autor
                ,nm_responsavel
                ,nm_usuario
                ,nm_usuario_nrec
                ,nm_usuario_resp
                ,nr_atendimento
                ,nr_ciclo
                ,nr_contract_partner
                ,nr_interno_conta_ref
                ,nr_ordem_compra
                ,nr_prescricao
                ,nr_seq_age_integ
                ,nr_seq_agenda
                ,nr_seq_agenda_consulta
                ,nr_seq_agenda_proc
                ,nr_seq_apres
                ,nr_seq_auditoria
                ,nr_seq_autor_cirurgia
                ,nr_seq_autor_desdob
                ,nr_seq_autorizacao
                ,nr_seq_autor_origem
                ,nr_seq_classif
                ,nr_seq_episodio
                ,nr_seq_estagio
                ,nr_seq_gestao
                ,nr_seq_guia_plano
                ,nr_seq_paciente
                ,nr_seq_paciente_setor
                ,nr_seq_proc_interno
                ,nr_seq_regra_autor
                ,nr_seq_regra_autor_qtd
                ,nr_seq_rxt_tratamento
                ,nr_sequencia
                ,qt_dia_autorizado
                ,qt_dia_solicitado
                ,qt_dias_prazo) (SELECT cd_ausencia_cod_valid
                ,cd_autorizacao
                ,cd_autorizacao_prest
                ,cd_cgc_prestador
                ,cd_convenio
                ,cd_empresa_pac
                ,cd_estabelecimento
                ,cd_interno_contrat_exec
                ,cd_interno_contrat_solic
                ,cd_interno_origem_tiss
                ,cd_medico_exec_agenda
                ,cd_medico_solicitante
                ,cd_medico_solic_tiss
                ,cd_pessoa_fisica
                ,cd_prestador_tiss
                ,cd_procedimento_convenio
                ,cd_procedimento_principal
                ,cd_proc_principal_loc
                ,cd_senha
                ,cd_senha_provisoria
                ,cd_setor_origem
                ,cd_setor_resp
                ,cd_tipo_acomodacao
                ,cd_tipo_acomod_desej
                ,cd_tipo_procedimento
                ,cd_validacao_tiss
                ,ds_cbo_tiss
                ,ds_contratado_exec_tiss
                ,ds_dia_ciclo
                ,ds_indicacao
                ,ds_motivo_cancelamento
                ,ds_observacao
                ,ds_prestador_tiss
                ,ds_tarja_cartao
                ,dt_agenda
                ,dt_agenda_cons
                ,dt_agenda_integ
                ,clock_timestamp()
                ,dt_atualizacao_nrec
                ,dt_autorizacao
                ,dt_desdobramento_conta
                ,dt_entrada_prevista
                ,dt_envio
                ,dt_fim_vigencia
                ,dt_geracao_cih
                ,dt_geracao_pacote
                ,dt_inicio_vigencia
                ,dt_pedido_medico
                ,dt_referencia
                ,dt_retorno
                ,dt_validade_guia
                ,ie_carater_int_tiss
                ,ie_eclipse_status
                ,ie_origem_proced
                ,ie_previsao_uso_opme
                ,ie_previsao_uso_quimio
                ,ie_regime_internacao
                ,ie_resp_autor
                ,ie_tipo_autorizacao
                ,ie_tipo_dia
                ,ie_tipo_guia
                ,ie_tipo_internacao_tiss
                ,ie_tipo_tramite
                ,ie_tiss_tipo_acidente
                ,ie_tiss_tipo_anexo_autor
                ,ie_tiss_tipo_etapa_autor
                ,nm_responsavel
                ,nm_usuario_w
                ,nm_usuario_nrec
                ,nm_usuario_resp
                ,nr_atendimento
                ,nr_ciclo
                ,nr_contract_partner
                ,nr_interno_conta_ref
                ,nr_ordem_compra
                ,nr_prescricao
                ,nr_seq_age_integ
                ,nr_seq_agenda
                ,nr_seq_agenda_consulta
                ,nr_seq_agenda_proc
                ,nr_seq_apres
                ,nr_seq_auditoria
                ,nr_seq_autor_cirurgia
                ,nr_seq_autor_desdob
                ,nr_seq_autorizacao + 1
                ,nr_seq_autor_origem
                ,nr_seq_classif
                ,nr_seq_episodio
                ,nr_seq_estagio
                ,nr_seq_gestao
                ,nr_seq_guia_plano
                ,nr_seq_paciente
                ,nr_seq_paciente_setor
                ,nr_seq_proc_interno
                ,nr_seq_regra_autor
                ,nr_seq_autor_qtd_regra_w
                ,nr_seq_rxt_tratamento
                ,nr_seq_aut_conv_insert_w
                ,qt_dia_autorizado
                ,qt_dia_solicitado
                ,qt_dias_prazo
                from autorizacao_convenio 
                where nr_sequencia = nr_seq_autorizacao_p  LIMIT 1);
                commit;
            end if;

            --transfere o procedimento para a autorizacao desdobrada
            if ((nr_seq_aut_conv_insert_w IS NOT NULL AND nr_seq_aut_conv_insert_w::text <> '') or
            (nr_seq_aut_desb_disp_w IS NOT NULL AND nr_seq_aut_desb_disp_w::text <> '')) then
        
                update procedimento_autorizado
                set nr_sequencia_autor = coalesce(nr_seq_aut_conv_insert_w, nr_seq_aut_desb_disp_w)
                where nr_sequencia = nr_seq_procedimento_w;
                commit;

            end if;
        end if;
    end if;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_autor_quantidade ( nm_usuario_p text, nr_atendimento_p bigint, nr_seq_autorizacao_p bigint default null, nr_seq_procedimento_p bigint DEFAULT NULL, cd_convenio_p bigint DEFAULT NULL, cd_estabelecimento_p bigint DEFAULT NULL, nr_seq_setor_proc_prescr_p bigint default null, nr_prescricao_p bigint default null, qt_autor_total_p bigint default null, qt_proc_autor_total_p bigint default null) FROM PUBLIC;

