-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE diops_importar_conta_contabil ( nr_seq_transacao_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint) AS $body$
DECLARE


ds_conta_contabil_w		varchar(255);
cd_classificacao_w		varchar(40);
cd_classif_sem_ponto_w		varchar(40);
cd_classificacao_sub_w		varchar(40);
ie_tipo_w			varchar(10);
cd_conta_contabil_w		varchar(20);
nr_seq_diops_trans_conta_w	bigint;
cd_grupo_w			bigint;
qt_registro_w			bigint;
nr_seq_apresentacao_w		bigint := 0;
dt_vigencia_w			timestamp;

C01 CURSOR FOR
	SELECT	ctb_obter_classif_conta(a.cd_conta_contabil,a.cd_classificacao,dt_vigencia_w),
		a.cd_grupo,
		a.ds_conta_contabil
	from	estabelecimento b,
		conta_contabil a
	where	a.cd_empresa = b.cd_empresa
	and	b.cd_estabelecimento = cd_estabelecimento_p
	and	a.ie_diops	= 'S'
	and	a.ie_situacao	= 'A'
	and	dt_vigencia_w between coalesce(a.dt_inicio_vigencia,dt_vigencia_w) and coalesce(a.dt_fim_vigencia,dt_vigencia_w);

C02 CURSOR FOR
	SELECT	a.cd_conta_contabil,
		a.cd_classificacao
	from	estabelecimento b,
		conta_contabil a
	where	a.cd_empresa = b.cd_empresa
	and	b.cd_estabelecimento = cd_estabelecimento_p
	and	a.ie_situacao	= 'A'
	and	a.cd_classificacao	= cd_classificacao_w
	and	dt_vigencia_w between coalesce(a.dt_inicio_vigencia,dt_vigencia_w) and coalesce(a.dt_fim_vigencia,dt_vigencia_w)
	
union

	SELECT	b.cd_conta_contabil,
		b.cd_classificacao
	from	estabelecimento c,
		conta_contabil_classif b,
		conta_contabil a
	where	a.cd_empresa = c.cd_empresa
	and	c.cd_estabelecimento = cd_estabelecimento_p
	and	a.cd_conta_contabil = b.cd_conta_contabil
	and	a.ie_situacao = 'A'
	and	dt_vigencia_w between coalesce(b.dt_inicio_vigencia, dt_vigencia_w) and coalesce(b.dt_fim_vigencia,dt_vigencia_w)
	and	b.cd_classificacao	= cd_classificacao_w;


BEGIN
select	max(dt_vigencia)
into STRICT	dt_vigencia_w
from	diops_transacao
where	nr_sequencia	= nr_seq_transacao_p;

/* delete	log_XXtasy
where	cd_log = 11011;  */


/*Tratamento para excluir as contas anteriormente vinculadas. Necessario criar opcao para tratar essa possibilidade, visto que podem ser cadastradas contas manuais antes da importacao e esse processo ira sobrepor*/

delete 	FROM diops_trans_conta
where 	nr_seq_transacao = nr_seq_transacao_p
and	ie_tipo_conta	= 'C';

open C01;
loop
fetch C01 into
	cd_classificacao_w,
	cd_grupo_w,
	ds_conta_contabil_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	cd_classif_sem_ponto_w	:= replace(cd_classificacao_w,'.','');
	
	/* Verificar se jah existe a conta contabil cadastrada no DIOPS */

	select	count(*)
	into STRICT	qt_registro_w
	from	diops_trans_conta
	where	ds_conta		= cd_classif_sem_ponto_w
	and	nr_seq_transacao	= nr_seq_transacao_p
	and	ie_tipo_conta		= 'C';

/*	insert into logXXXX_tasy
		(cd_log,
		ds_log,
		nm_usuario,
		dt_atualizacao)
	values	(11011,
		'cd_classificacao_w='||cd_classif_sem_ponto_w||' nr_seq_transacao_p= '||nr_seq_transacao_p||' qt_registro_w='||qt_registro_w,
		'Tasy',
		sysdate); */
	if (qt_registro_w	= 0) then
		/* Dom 1143 */


		/* Buscar o grupo da conta contabil */

		begin
		select	ie_tipo
		into STRICT	ie_tipo_w
		from	ctb_grupo_conta
		where	cd_grupo	= cd_grupo_w;
		exception
		when others then
			ie_tipo_w	:= 'X';
		end;

		/* Somente se a conta for Ativo, Passivo, Receita, Despesa ou Resultado que sera inserida no DIOPS */

		if (ie_tipo_w in ('A','P','C','D','R')) then
			/*Diego OPS - OS 260571
			   Paro o DIOPS o resultado eh 'R'
			   Para o plano de contas eh 'C'*/
			
			if (ie_tipo_w = 'R') then
				ie_tipo_w := 'D';
			end if;
			
			if (ie_tipo_w = 'C') then
				ie_tipo_w := 'R';
			end if;
			
			nr_seq_apresentacao_w := nr_seq_apresentacao_w + 1;

			select	nextval('diops_trans_conta_seq')
			into STRICT	nr_seq_diops_trans_conta_w
			;

			insert into diops_trans_conta(nr_sequencia,
				dt_atualizacao,
				nm_usuario,
				dt_atualizacao_nrec,
				nm_usuario_nrec,
				nr_seq_transacao,
				ds_conta,
				ie_tipo_conta,
				ie_tipo_atividade,
				ie_plano_conta,
				ds_desc_conta,
				nr_seq_apresentacao,
				cd_estabelecimento,
				nr_seq_anterior)
			values (nr_seq_diops_trans_conta_w,
				clock_timestamp(),
				nm_usuario_p,
				clock_timestamp(),
				nm_usuario_p,
				nr_seq_transacao_p,
				cd_classif_sem_ponto_w,
				'C',
				'',
				ie_tipo_w,
				ds_conta_contabil_w,
				nr_seq_apresentacao_w,
				cd_estabelecimento_p,
				null);

			open C02;
			loop
			fetch C02 into
				cd_conta_contabil_w,
				cd_classificacao_sub_w;
			EXIT WHEN NOT FOUND; /* apply on C02 */
				begin

				/*Por padrao a acao da conta eh somar.
				    Visto como Sr. Claudinei do HMCC em conexao
				    Os 260571*/
				insert into diops_trans_conta_contab(nr_sequencia,
					cd_conta_contabil,
					cd_estabelecimento,
					nr_seq_trans_conta,
					ie_acao_conta,
					dt_atualizacao,
					dt_atualizacao_nrec,
					nm_usuario,
					nm_usuario_nrec)
				values (nextval('diops_trans_conta_contab_seq'),
					cd_conta_contabil_w,
					cd_estabelecimento_p,
					nr_seq_diops_trans_conta_w,
					'SO',
					clock_timestamp(),
					clock_timestamp(),
					nm_usuario_p,
					nm_usuario_p);
				end;
			end loop;
			close C02;

		end if;
	end if;
	end;
end loop;
close C01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE diops_importar_conta_contabil ( nr_seq_transacao_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint) FROM PUBLIC;

