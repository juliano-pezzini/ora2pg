-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_alter_prescr_adep (nr_atendimento_p bigint, nr_prescricao_p bigint, ds_justificativa_p text, nr_seq_motivo_susp_p bigint, nm_usuario_p text) AS $body$
DECLARE


ie_tipo_w		varchar(15);
nr_prescricao_w		bigint;
nr_seq_dialise_w	bigint;
nr_seq_item_w	bigint;
nr_seq_evento_w	bigint;
cd_item_w	prescr_mat_alteracao.cd_item%type;

c01 CURSOR FOR
SELECT	'S' ie_tipo_item,
	a.nr_prescricao nr_prescricao,
	b.nr_sequencia nr_seq_item,
	to_char(b.cd_material) cd_item,
	null nr_seq_dialise
from	prescr_material b,
	prescr_medica a
where	b.nr_prescricao = a.nr_prescricao
and	b.ie_agrupador in (12)
and	a.nr_prescricao = nr_prescricao_p

union

SELECT	'M' ie_tipo_item,
	a.nr_prescricao nr_prescricao,
	b.nr_sequencia nr_seq_item,
	to_char(b.cd_material) cd_item,
	null nr_seq_dialise
from	prescr_material b,
	prescr_medica a
where	b.nr_prescricao = a.nr_prescricao
and	b.ie_agrupador in (1)
and	a.nr_prescricao = nr_prescricao_p

union

select	'MAT' ie_tipo_item,
	a.nr_prescricao nr_prescricao,
	b.nr_sequencia nr_seq_item,
	to_char(b.cd_material) cd_item,
	null nr_seq_dialise
from	prescr_material b,
	prescr_medica a
where	b.nr_prescricao = a.nr_prescricao
and	b.ie_agrupador in (2)
and	a.nr_prescricao = nr_prescricao_p

union

select	'P' ie_tipo_item,
	a.nr_prescricao nr_prescricao,
	b.nr_sequencia nr_seq_item,
	to_char(b.cd_procedimento) cd_item,
	null nr_seq_dialise
from	prescr_procedimento b,
	prescr_medica a
where	b.nr_prescricao = a.nr_prescricao
and	coalesce(b.nr_seq_solic_sangue::text, '') = ''
and	coalesce(b.nr_seq_derivado::text, '') = ''
and	coalesce(b.nr_seq_exame::text, '') = ''
and	coalesce(obter_ctrl_glic_proc(b.nr_seq_proc_interno),'NC') = 'NC'
and	a.nr_prescricao = nr_prescricao_p

union

select	'C' ie_tipo_item,
	a.nr_prescricao nr_prescricao,
	b.nr_sequencia nr_seq_item,
	to_char(b.cd_procedimento) cd_item,
	null nr_seq_dialise
from	prescr_procedimento b,
	prescr_medica a
where	b.nr_prescricao = a.nr_prescricao
--and	b.nr_seq_solic_sangue is null

--and	b.nr_seq_derivado is null

--and	b.nr_seq_exame is null
and	coalesce(obter_ctrl_glic_proc(b.nr_seq_proc_interno),'NC') = 'CIG'
and	a.nr_prescricao = nr_prescricao_p

union

select	'G' ie_tipo_item,
	a.nr_prescricao nr_prescricao,
	b.nr_sequencia nr_seq_item,
	to_char(b.cd_procedimento) cd_item,
	null nr_seq_dialise
from	prescr_procedimento b,
	prescr_medica a
where	b.nr_prescricao = a.nr_prescricao
--and	b.nr_seq_solic_sangue is null

--and	b.nr_seq_derivado is null

--and	b.nr_seq_exame is null
and	coalesce(obter_ctrl_glic_proc(b.nr_seq_proc_interno),'NC') = 'CCG'
and	a.nr_prescricao = nr_prescricao_p

union

select	'R' ie_tipo_item,
	a.nr_prescricao nr_prescricao,
	b.nr_sequencia nr_seq_item,
	to_char(b.cd_recomendacao) cd_item,
	null nr_seq_dialise
from	prescr_recomendacao b,
	prescr_medica a
where	b.nr_prescricao = a.nr_prescricao
and	a.nr_prescricao = nr_prescricao_p

union

select	'P' ie_tipo_item,
	a.nr_prescricao nr_prescricao,
	b.nr_sequencia nr_seq_item,
	to_char(b.cd_procedimento) cd_item,
	null nr_seq_dialise
from	prescr_procedimento b,
	prescr_medica a
where	b.nr_prescricao = a.nr_prescricao
--and	b.nr_seq_solic_sangue is null

--and	b.nr_seq_derivado is null
and	(b.nr_seq_exame IS NOT NULL AND b.nr_seq_exame::text <> '')
--and	nvl(obter_ctrl_glic_proc(b.nr_seq_proc_interno),'NC') = 'NC'
and	a.nr_prescricao = nr_prescricao_p

union

select	'LD' ie_tipo_item,
	a.nr_prescricao,
	b.nr_sequencia nr_seq_item,
	to_char(b.cd_material) cd_item,
	null nr_seq_dialise
from	prescr_leite_deriv	a,
	prescr_material		b
where	a.nr_sequencia	= b.nr_seq_leite_deriv
and	a.nr_prescricao	= nr_prescricao_p

union

select	'J' ie_tipo_item,
	b.nr_prescricao nr_prescricao,
	b.nr_sequencia nr_seq_item,
	TO_CHAR(coalesce(b.dt_inicio,a.dt_inicio_prescr),'dd/mm/yyyy hh24:mi:ss') || '-' || TO_CHAR(CASE WHEN TO_CHAR(coalesce(b.dt_fim,a.dt_validade_prescr), 'mi')='00' THEN  coalesce(b.dt_fim,a.dt_validade_prescr) - 1/86400  ELSE coalesce(b.dt_fim,a.dt_validade_prescr) END ,'dd/mm/yyyy hh24:mi:ss') cd_item,
	null nr_seq_dialise
from	prescr_medica a,
	rep_jejum b
where	a.nr_prescricao = nr_prescricao_p
and     b.nr_prescricao = a.nr_prescricao

union

select	'1' ie_tipo_item,
	a.nr_prescricao nr_prescricao,
	b.nr_seq_solucao nr_seq_item,
	null cd_item,
	b.nr_seq_dialise
from	prescr_solucao b,
	prescr_medica a
where	b.nr_prescricao = a.nr_prescricao
and	a.nr_prescricao = nr_prescricao_p

union

select	'2' ie_tipo_item,
	a.nr_prescricao nr_prescricao,
	b.nr_sequencia nr_seq_item,
	null cd_item,
	null nr_seq_dialise
from	prescr_material b,
	prescr_medica a
where	b.nr_prescricao = a.nr_prescricao
and	b.ie_agrupador in (8)
and	a.nr_prescricao = nr_prescricao_p

union

select	'3' ie_tipo_item,
	a.nr_prescricao nr_prescricao,
	b.nr_sequencia nr_seq_item,
	null cd_item,
	null nr_seq_dialise
from	prescr_procedimento b,
	prescr_medica a
where	b.nr_prescricao = a.nr_prescricao
and	(b.nr_seq_solic_sangue IS NOT NULL AND b.nr_seq_solic_sangue::text <> '')
and	(b.nr_seq_derivado IS NOT NULL AND b.nr_seq_derivado::text <> '')
--and	b.nr_seq_exame is null

--and	nvl(obter_ctrl_glic_proc(b.nr_seq_proc_interno),'NC') = 'NC'
and	a.nr_prescricao = nr_prescricao_p

union

select	'4' ie_tipo_item,
	a.nr_prescricao nr_prescricao,
	b.nr_sequencia nr_seq_item,
	null  cd_item,
	null nr_seq_dialise
from	nut_paciente b,
	prescr_medica a
where	b.nr_prescricao = a.nr_prescricao
and	a.nr_prescricao = nr_prescricao_p

union

select	'5' ie_tipo_item,
	a.nr_prescricao nr_prescricao,
	b.nr_sequencia nr_seq_item,
	null  cd_item,
	null nr_seq_dialise
from	nut_pac b,
	prescr_medica a
where	b.nr_prescricao = a.nr_prescricao
and	a.nr_prescricao = nr_prescricao_p;


BEGIN

if (nr_atendimento_p IS NOT NULL AND nr_atendimento_p::text <> '') and (nr_prescricao_p IS NOT NULL AND nr_prescricao_p::text <> '') and (nm_usuario_p IS NOT NULL AND nm_usuario_p::text <> '') then
	open c01;
	loop
	fetch c01 into	ie_tipo_w,
			nr_prescricao_w,
			nr_seq_item_w,
			cd_item_w,
			nr_seq_dialise_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
		begin
		
		if (ie_tipo_w in ('1','2','3','4','5')) then
			if (ie_tipo_w = '1') and (nr_seq_dialise_w IS NOT NULL AND nr_seq_dialise_w::text <> '')then
				SELECT	nextval('hd_prescricao_evento_seq')
				INTO STRICT	nr_seq_evento_w
				;

				INSERT INTO hd_prescricao_evento(
					nr_sequencia,
					dt_atualizacao_nrec,
					nm_usuario_nrec,
					dt_atualizacao,
					nm_usuario,
					nr_prescricao,
					nr_seq_solucao,
					ie_evento,
					dt_evento,
					cd_pessoa_evento)
				VALUES (
					nr_seq_evento_w,
					clock_timestamp(),
					nm_usuario_p,
					clock_timestamp(),
					nm_usuario_p,
					nr_prescricao_w,
					nr_seq_item_w,
					'SI',
					clock_timestamp(),
					SUBSTR(obter_dados_usuario_opcao(nm_usuario_p,'C'),1,10));
			else
				CALL gerar_alter_sol_prescr_adep((ie_tipo_w)::numeric , nr_prescricao_w, nr_seq_item_w, 11, null, nm_usuario_p,ds_justificativa_p);
			end if;
		else			
			CALL gerar_alter_item_prescr_adep(nr_atendimento_p, ie_tipo_w, cd_item_w, nr_prescricao_w, nr_seq_item_w, 14, ds_justificativa_p, nm_usuario_p, nr_seq_motivo_susp_p,null);
		end if;
		end;
	end loop;
	close c01;
end if;

if (coalesce(wheb_usuario_pck.get_ie_commit, 'S') = 'S') then commit; end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_alter_prescr_adep (nr_atendimento_p bigint, nr_prescricao_p bigint, ds_justificativa_p text, nr_seq_motivo_susp_p bigint, nm_usuario_p text) FROM PUBLIC;

