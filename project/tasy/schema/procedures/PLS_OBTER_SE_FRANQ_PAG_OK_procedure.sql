-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_obter_se_franq_pag_ok ( nr_seq_lote_p pls_lote_pagamento.nr_sequencia%type, ds_erro_p INOUT text, nm_usuario_p usuario.nm_usuario%type) AS $body$
DECLARE


nr_seq_periodo_w		pls_lote_pagamento.nr_seq_periodo%type;
dt_mes_competencia_w		pls_lote_pagamento.dt_mes_competencia%type;
cd_estabelecimento_w		pls_lote_pagamento.cd_estabelecimento%type;
cont_w				bigint;
ds_erro_w			varchar(4000)	:= '';


BEGIN

select	max(nr_seq_periodo),
	max(dt_mes_competencia),
	max(cd_estabelecimento)
into STRICT	nr_seq_periodo_w,
	dt_mes_competencia_w,
	cd_estabelecimento_w
from	pls_lote_pagamento
where	nr_sequencia		= nr_seq_lote_p;

-- verificar se existe regra cadastrada para o mês vigente no período selecionado
select	count(*)
into STRICT	cont_w
from	pls_regra_franq_pag a
where	a.cd_estabelecimento	= cd_estabelecimento_w
and	dt_mes_competencia_w	between trunc(a.dt_inicio_franquia,'month') and last_day(a.dt_fim_franquia)
and	exists (SELECT	1
		from	pls_regra_franq_pag_per x
		where	x.nr_seq_regra		= a.nr_sequencia
		and	x.nr_seq_periodo	= nr_seq_periodo_w);

if (cont_w > 0) then

	select	count(*)
	into STRICT	cont_w
	from	pls_franq_pag
	where	trunc(dt_referencia, 'month')	= trunc(dt_mes_competencia_w, 'month')
	and	cd_estabelecimento		= cd_estabelecimento_w;

	if (cont_w = 0) then
		ds_erro_w		:= 	'Não é possível fechar este lote de pagamento!' || chr(13) || chr(10) ||
						'Não existem lotes de franquia gerados para este mês.';
	else
		select	count(*)
		into STRICT	cont_w
		from	pls_franq_pag
		where	trunc(dt_referencia, 'month')	= trunc(dt_mes_competencia_w, 'month')
		and	cd_estabelecimento		= cd_estabelecimento_w
		and	coalesce(dt_fechamento_lote::text, '') = '';

		if (cont_w > 0) then
			ds_erro_w		:= 	'Não é possível fechar este lote de pagamento!' || chr(13)  || chr(10) ||
							'Existem lotes de franquia em aberto para este mês!';
		else
			select	count(*)
			into STRICT	cont_w
			from	pls_franq_pag a
			where	trunc(a.dt_referencia, 'month')	= trunc(dt_mes_competencia_w, 'month')
			and	a.cd_estabelecimento		= cd_estabelecimento_w
			and	exists (SELECT	1
					from	pls_franq_pag_prest x
					where	x.nr_seq_franq_pag	= a.nr_sequencia
					and	coalesce(x.nr_seq_pag_item::text, '') = '');

			if (cont_w > 0) then
				ds_erro_w		:= 	'Não é possível fechar este lote de pagamento!' || chr(13) ||  chr(10) ||
								'Não foram gerados os eventos de franquia para este lote de pagamento!';
			end if;
		end if;
	end if;
end if;

ds_erro_p	:= ds_erro_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_obter_se_franq_pag_ok ( nr_seq_lote_p pls_lote_pagamento.nr_sequencia%type, ds_erro_p INOUT text, nm_usuario_p usuario.nm_usuario%type) FROM PUBLIC;

