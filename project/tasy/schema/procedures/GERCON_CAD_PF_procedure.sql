-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gercon_cad_pf (nm_pessoa_fisica_p text, nr_cartao_nac_sus_p text, nr_telefone_paciente_p text, nr_cpf_p text, dt_nascimento_p timestamp, ie_sexo_p text, ie_estado_civil_p text, nr_seq_cor_pele_p bigint, cd_nacionalidade_p text, ds_bairro_p text, cd_cep_p text, ds_endereco_p text, nr_endereco_p bigint, ds_complemento_p text, ds_municipio_p text, nm_contato_p text, cd_pessoa_fisica_out_p INOUT text, nm_pessoa_fisica_out_p INOUT text, ie_novo_paciente_out_p INOUT text, ie_erro_out_p INOUT text, ds_erro_out_p INOUT text) AS $body$
BEGIN

    ie_erro_out_p          := 'N';
    ds_erro_out_p          := '';
    ie_novo_paciente_out_p := 'N';

    SELECT MAX(cd_pessoa_fisica),
           MAX(nm_pessoa_fisica)
      INTO STRICT cd_pessoa_fisica_out_p,
           nm_pessoa_fisica_out_p
      FROM pessoa_fisica
     WHERE nr_cpf = nr_cpf_p
        OR nr_cartao_nac_sus = nr_cartao_nac_sus_p;

    IF coalesce(cd_pessoa_fisica_out_p::text, '') = '' THEN

        nm_pessoa_fisica_out_p := nm_pessoa_fisica_p;
        ie_novo_paciente_out_p := 'S';
        SELECT nextval('pessoa_fisica_seq') INTO STRICT cd_pessoa_fisica_out_p;

        BEGIN
            INSERT INTO pessoa_fisica(cd_pessoa_fisica,
                 nm_pessoa_fisica,
                 dt_nascimento,
                 ie_sexo,
                 nr_ddd_celular,
                 nr_telefone_celular,
                 ie_revisar,
                 nr_cpf,
                 nr_cartao_nac_sus,
                 cd_nacionalidade,
                 nr_seq_cor_pele,
                 ie_estado_civil,
                 ie_tipo_pessoa,
                 dt_atualizacao,
                 dt_atualizacao_nrec,
                 nm_usuario,
                 nm_usuario_nrec)
            VALUES (cd_pessoa_fisica_out_p,
                 substr(nm_pessoa_fisica_p, 1, 60),
                 dt_nascimento_p,
                 ie_sexo_p,
                 obter_somente_numero(substr(nr_telefone_paciente_p, 1, 4)),
                 substr(nr_telefone_paciente_p, 5, 40),
                 'N',
                 nr_cpf_p,
                 nr_cartao_nac_sus_p,
                 obter_conversao_interna_int(NULL, 'NACIONALIDADE', 'CD_NACIONALIDADE', cd_nacionalidade_p, 'GERCON'),
                 obter_conversao_interna_int(NULL, 'COR_PELE', 'NR_SEQ_COR_PELE', nr_seq_cor_pele_p, 'GERCON'),
                 obter_conversao_interna_int(NULL, 'PESSOA_FISICA', 'IE_ESTADO_CIVIL', ie_estado_civil_p, 'GERCON'),
                 '2',
                 clock_timestamp(),
                 clock_timestamp(),
                 'GERCON',
                 'GERCON');
            COMMIT;
        EXCEPTION
            WHEN OTHERS THEN
                cd_pessoa_fisica_out_p := NULL;
                nm_pessoa_fisica_out_p := NULL;
                ie_erro_out_p          := 'S';
                ds_erro_out_p          := obter_expressao_dic_objeto(1112607 ) || SQLERRM;
        END;

    END IF;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gercon_cad_pf (nm_pessoa_fisica_p text, nr_cartao_nac_sus_p text, nr_telefone_paciente_p text, nr_cpf_p text, dt_nascimento_p timestamp, ie_sexo_p text, ie_estado_civil_p text, nr_seq_cor_pele_p bigint, cd_nacionalidade_p text, ds_bairro_p text, cd_cep_p text, ds_endereco_p text, nr_endereco_p bigint, ds_complemento_p text, ds_municipio_p text, nm_contato_p text, cd_pessoa_fisica_out_p INOUT text, nm_pessoa_fisica_out_p INOUT text, ie_novo_paciente_out_p INOUT text, ie_erro_out_p INOUT text, ds_erro_out_p INOUT text) FROM PUBLIC;

