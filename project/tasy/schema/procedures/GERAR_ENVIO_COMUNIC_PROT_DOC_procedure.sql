-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_envio_comunic_prot_doc ( nr_sequencia_p bigint, ie_evento_p text, cd_estabelecimento_p bigint, nm_usuario_p text, nr_seq_item_p bigint default 0) AS $body$
DECLARE

				 
				 
/* Atributos da regra */
 
nr_seq_regra_w			bigint;
ds_titulo_w			varchar(255);
ds_comunicacao_w			varchar(32000);
ie_comunic_interna_w		varchar(01);
ie_email_w			varchar(01);
ds_email_origem_w			varchar(255);
ds_lista_email_destino_w		varchar(2000);
ie_usuario_w			varchar(15);

/* Atributos do protocolo documento */
 
nr_seq_prot_doc_w			bigint;
ds_tipo_protocolo_w		varchar(255);
dt_envio_w			timestamp;
dt_rec_destino_w			timestamp;
ds_usuario_envio_w		varchar(100);
ds_usuario_receb_w		varchar(100);
nm_usuario_pf_origem_w		varchar(15);
nm_usuario_pf_destino_w		varchar(15);
nm_pessoa_origem_w		varchar(60);
nm_pessoa_destino_w		varchar(60);
ds_setor_origem_w			varchar(100);
ds_setor_destino_w			varchar(100);
ds_estabelecimento_w		varchar(255);
ds_status_protocolo_w		varchar(255);
ds_obs_w			varchar(4000);
cd_setor_origem_w			integer;
cd_setor_destino_w			integer;

/* Atributos dos itens do protocolo*/
 
nr_documento_w			bigint := 0;
nr_seq_item_w			integer := 0;

/* Atributos em geral */
 
nm_usuario_w			varchar(2000);
qt_existe_w			bigint;
lista_usuario_w			varchar(2000);
tam_lista_w			bigint;
ie_pos_virgula_w			smallint;
ds_email_usuario_w			varchar(255);
ds_lista_email_usuario_w		varchar(2000);
ds_setor_adic_w			varchar(2000);
ds_motivo_dev_w			varchar(255);
nr_seq_classif_ci_w				comunic_interna_classif.nr_sequencia%type;
				
C01 CURSOR FOR 
	SELECT	nr_sequencia, 
		ds_titulo, 
		ds_comunicacao, 
		ie_comunicacao_interna, 
		ie_email, 
		ds_email_origem, 
		ds_lista_email_destino, 
		nr_seq_classif_ci 
	from	regra_envio_comun_protdoc 
	where	ie_evento = ie_evento_p 
	and	cd_estabelecimento = cd_estabelecimento_p 
	and	coalesce(ie_situacao,'A') = 'A';
	
C02 CURSOR FOR 
	SELECT	ie_usuario 
	from	regra_envio_comun_prot_usu 
	where	nr_seq_regra = nr_seq_regra_w;


BEGIN 
 
if (coalesce(nr_sequencia_p,0) > 0) then 
	begin 
	open C01;
	loop 
	fetch C01 into	 
		nr_seq_regra_w, 
		ds_titulo_w, 
		ds_comunicacao_w, 
		ie_comunic_interna_w, 
		ie_email_w, 
		ds_email_origem_w, 
		ds_lista_email_destino_w, 
		nr_seq_classif_ci_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin 
		nm_usuario_w := null;
		ds_setor_adic_w := null;
		 
		select	count(*) 
		into STRICT	qt_existe_w 
		from	regra_envio_comun_prot_usu 
		where	nr_seq_regra = nr_seq_regra_w;
 
		if (coalesce(nr_seq_classif_ci_w,0) = 0) then 
			nr_seq_classif_ci_w := obter_classif_comunic('F');
		end if;
		 
		if (qt_existe_w > 0) and 
			((ie_comunic_interna_w = 'S') or (ie_email_w = 'S')) then 
			begin 
			 
			begin 
			select	nr_sequencia, 
				substr(obter_valor_dominio(1047,ie_tipo_protocolo),1,255), 
				dt_envio, 
				dt_rec_destino, 
				substr(obter_desc_usuario(nm_usuario_envio),1,100), 
				substr(obter_desc_usuario(nm_usuario_receb),1,100), 
				substr(obter_usuario_ativo_pf(cd_pessoa_origem),1,15), 
				substr(obter_usuario_ativo_pf(cd_pessoa_destino),1,15), 
				substr(obter_nome_pf(cd_pessoa_origem),1,60), 
				substr(obter_nome_pf(cd_pessoa_destino),1,60), 
				substr(obter_desc_setor_atend(cd_setor_origem),1,100), 
				substr(obter_desc_setor_atend(cd_setor_destino),1,100), 
				substr(obter_nome_estabelecimento(cd_estabelecimento),1,255), 
				substr(obter_valor_dominio(5077,ie_status_protocolo),1,255), 
				ds_obs, 
				cd_setor_origem, 
				cd_setor_destino 
			into STRICT	nr_seq_prot_doc_w, 
				ds_tipo_protocolo_w, 
				dt_envio_w, 
				dt_rec_destino_w, 
				ds_usuario_envio_w, 
				ds_usuario_receb_w, 
				nm_usuario_pf_origem_w, 
				nm_usuario_pf_destino_w, 
				nm_pessoa_origem_w, 
				nm_pessoa_destino_w, 
				ds_setor_origem_w, 
				ds_setor_destino_w, 
				ds_estabelecimento_w, 
				ds_status_protocolo_w, 
				ds_obs_w, 
				cd_setor_origem_w, 
				cd_setor_destino_w 
			from	protocolo_documento 
			where	nr_sequencia = nr_sequencia_p;
			exception 
			when others then 
				nr_seq_prot_doc_w := 0;
			end;
			 
			if (coalesce(nr_seq_item_p,0) > 0) then 
				begin 
				begin 
				select	nr_documento, 
					nr_seq_item, 
					substr(obter_desc_mot_dev_item(nr_seq_motivo_dev),1,255) 
				into STRICT	nr_documento_w, 
					nr_seq_item_w, 
					ds_motivo_dev_w 
				from	protocolo_doc_item 
				where	nr_sequencia = nr_sequencia_p 
				and	nr_seq_item = nr_seq_item_p;
				exception 
				when others then 
					nr_seq_item_w := 0;
				end;
				end;
			end if;
			 
			open C02;
			loop 
			fetch C02 into	 
				ie_usuario_w;
			EXIT WHEN NOT FOUND; /* apply on C02 */
				begin 
				if (ie_usuario_w = 'D') then 
					begin 
					if (coalesce(nm_usuario_pf_destino_w,'0') <> '0') then 
						nm_usuario_w := substr(nm_usuario_pf_destino_w || ', ' || nm_usuario_w,1,2000);
					end if;
					end;
				elsif (ie_usuario_w = 'E') then 
					begin 
					if (coalesce(nm_usuario_pf_origem_w,'0') <> '0') then 
						nm_usuario_w := substr(nm_usuario_pf_origem_w || ', ' || nm_usuario_w,1,2000);
					end if;
					end;
				elsif (ie_usuario_w = 'SE') then 
					begin 
					if (coalesce(cd_setor_origem_w,0) > 0) then 
						ds_setor_adic_w := substr(cd_setor_origem_w || ', ' || ds_setor_adic_w,1,2000);
					end if;
					end;
				elsif (ie_usuario_w = 'SD') then 
					begin 
					if (coalesce(cd_setor_destino_w,0) > 0) then 
						ds_setor_adic_w := substr(cd_setor_destino_w || ', ' || ds_setor_adic_w,1,2000);
					end if;
					end;
				end if;
				end;
			end loop;
			close C02;
			 
			if (nr_seq_prot_doc_w > 0) and 
				((coalesce(nm_usuario_w,'0') <> '0') or (coalesce(ds_setor_adic_w,'0') <> '0')) then 
				begin 
				ds_titulo_w	:= substr(replace_macro(ds_titulo_w, '@nr_protocolo', nr_seq_prot_doc_w),1,255);
				ds_titulo_w	:= substr(replace_macro(ds_titulo_w, '@ds_tipo', ds_tipo_protocolo_w),1,255);
				ds_titulo_w	:= substr(replace_macro(ds_titulo_w, '@dt_envio', to_char(dt_envio_w,'dd/mm/yyyy hh24:mi:ss')),1,255);
				ds_titulo_w	:= substr(replace_macro(ds_titulo_w, '@dt_recebimento', to_char(dt_rec_destino_w,'dd/mm/yyyy hh24:mi:ss')),1,255);
				ds_titulo_w	:= substr(replace_macro(ds_titulo_w, '@ds_usuario_envio', ds_usuario_envio_w),1,255);
				ds_titulo_w	:= substr(replace_macro(ds_titulo_w, '@ds_usuario_receb', ds_usuario_receb_w),1,255);
				ds_titulo_w	:= substr(replace_macro(ds_titulo_w, '@nm_pessoa_envio', nm_pessoa_origem_w),1,255);
				ds_titulo_w	:= substr(replace_macro(ds_titulo_w, '@nm_pessoa_destino', nm_pessoa_destino_w),1,255);
				ds_titulo_w	:= substr(replace_macro(ds_titulo_w, '@ds_setor_origem', ds_setor_origem_w),1,255);
				ds_titulo_w	:= substr(replace_macro(ds_titulo_w, '@ds_setor_destino', ds_setor_destino_w),1,255);
				ds_titulo_w	:= substr(replace_macro(ds_titulo_w, '@ds_estabelecimento', ds_estabelecimento_w),1,255);
				ds_titulo_w	:= substr(replace_macro(ds_titulo_w, '@ds_status', ds_status_protocolo_w),1,255);
				ds_titulo_w	:= substr(replace_macro(ds_titulo_w, '@nr_documento', nr_documento_w),1,255);
				ds_titulo_w	:= substr(replace_macro(ds_titulo_w, '@nr_seq_item', nr_seq_item_w),1,255);
				ds_titulo_w	:= substr(replace_macro(ds_titulo_w, '@ds_motivo_dev', ds_motivo_dev_w),1,255);
				 
				ds_comunicacao_w	:= substr(replace_macro(ds_comunicacao_w, '@nr_protocolo', nr_seq_prot_doc_w),1,32000);
				ds_comunicacao_w	:= substr(replace_macro(ds_comunicacao_w, '@ds_tipo', ds_tipo_protocolo_w),1,32000);
				ds_comunicacao_w	:= substr(replace_macro(ds_comunicacao_w, '@dt_envio', to_char(dt_envio_w,'dd/mm/yyyy hh24:mi:ss')),1,32000);
				ds_comunicacao_w	:= substr(replace_macro(ds_comunicacao_w, '@dt_recebimento', to_char(dt_rec_destino_w,'dd/mm/yyyy hh24:mi:ss')),1,32000);
				ds_comunicacao_w	:= substr(replace_macro(ds_comunicacao_w, '@ds_usuario_envio', ds_usuario_envio_w),1,32000);
				ds_comunicacao_w	:= substr(replace_macro(ds_comunicacao_w, '@ds_usuario_receb', ds_usuario_receb_w),1,32000);
				ds_comunicacao_w	:= substr(replace_macro(ds_comunicacao_w, '@nm_pessoa_envio', nm_pessoa_origem_w),1,32000);
				ds_comunicacao_w	:= substr(replace_macro(ds_comunicacao_w, '@nm_pessoa_destino', nm_pessoa_destino_w),1,32000);
				ds_comunicacao_w	:= substr(replace_macro(ds_comunicacao_w, '@ds_setor_origem', ds_setor_origem_w),1,32000);
				ds_comunicacao_w	:= substr(replace_macro(ds_comunicacao_w, '@ds_setor_destino', ds_setor_destino_w),1,32000);
				ds_comunicacao_w	:= substr(replace_macro(ds_comunicacao_w, '@ds_estabelecimento', ds_estabelecimento_w),1,32000);
				ds_comunicacao_w	:= substr(replace_macro(ds_comunicacao_w, '@ds_status', ds_status_protocolo_w),1,32000);
				ds_comunicacao_w	:= substr(replace_macro(ds_comunicacao_w, '@ds_observacao', ds_obs_w),1,32000);
				ds_comunicacao_w	:= substr(replace_macro(ds_comunicacao_w, '@nr_documento', nr_documento_w),1,32000);
				ds_comunicacao_w	:= substr(replace_macro(ds_comunicacao_w, '@nr_seq_item', nr_seq_item_w),1,32000);
				ds_comunicacao_w	:= substr(replace_macro(ds_comunicacao_w, '@ds_motivo_dev', ds_motivo_dev_w),1,32000);
				 
				if (ie_comunic_interna_w = 'S') then 
					begin 
					 
					insert into comunic_interna( 
							dt_comunicado, 
							ds_titulo, 
							ds_comunicado, 
							nm_usuario, 
							dt_atualizacao, 
							ie_geral, 
							nm_usuario_destino, 
							cd_perfil, 
							nr_sequencia, 
							ie_gerencial, 
							nr_seq_classif, 
							ds_perfil_adicional, 
							cd_setor_destino, 
							cd_estab_destino, 
							ds_setor_adicional, 
							dt_liberacao, 
							ds_grupo, 
							nm_usuario_oculto) 
						values (	clock_timestamp(), 
							ds_titulo_w, 
							ds_comunicacao_w, 
							nm_usuario_p, 
							clock_timestamp(), 
							'N', 
							nm_usuario_w, 
							null, 
							nextval('comunic_interna_seq'), 
							'N', 
							nr_seq_classif_ci_w, 
							'', 
							null, 
							'', 
							ds_setor_adic_w, 
							clock_timestamp(), 
							'', 
							'');
					end;
				end if;
				 
				if (ie_email_w = 'S') then 
					begin 
					if (coalesce(ds_lista_email_destino_w,'0') <> '0') then 
						ds_lista_email_usuario_w := ds_lista_email_destino_w;
					else 
						begin 
						lista_usuario_w := substr(nm_usuario_w,1,2000);
 
						while(coalesce(lista_usuario_w,'0') <> '0') and (trim(both lista_usuario_w) <> ',') loop 
							tam_lista_w		:= length(lista_usuario_w);
							ie_pos_virgula_w	:= position(',' in lista_usuario_w);
 
							if (ie_pos_virgula_w > 0) then 
								begin 
								nm_usuario_w	:= substr(lista_usuario_w,1,(ie_pos_virgula_w - 1));
								lista_usuario_w	:= trim(both substr(lista_usuario_w,(ie_pos_virgula_w + 1), tam_lista_w));
 
								select	max(ds_email) 
								into STRICT	ds_email_usuario_w 
								from	usuario 
								where	nm_usuario = nm_usuario_w;
 
								if (coalesce(ds_email_usuario_w,'0') <> '0') then 
									ds_lista_email_usuario_w := substr(ds_lista_email_usuario_w || ds_email_usuario_w || ',',1,2000);
								end if;
								end;
							else 
								lista_usuario_w	:= '0';
							end if;
						end loop;
						end;
					end if;					
					 
					if (coalesce(ds_lista_email_usuario_w,'0') <> '0') then 
						begin								 
						ds_lista_email_usuario_w := replace(ds_lista_email_usuario_w,',',';');						
						CALL enviar_email(	ds_titulo_w, 
								ds_comunicacao_w, 
								ds_email_origem_w, 
								ds_lista_email_usuario_w, 
								nm_usuario_p, 
								'M');
						end;
					end if;
					end;
				end if;
				end;
			end if;
			end;
		end if;		
		end;
	end loop;
	close C01;
	 
	commit;
	end;
end if;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_envio_comunic_prot_doc ( nr_sequencia_p bigint, ie_evento_p text, cd_estabelecimento_p bigint, nm_usuario_p text, nr_seq_item_p bigint default 0) FROM PUBLIC;

