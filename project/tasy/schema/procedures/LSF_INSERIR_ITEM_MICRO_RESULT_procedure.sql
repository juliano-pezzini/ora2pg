-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE lsf_inserir_item_micro_result ( nr_prescricao_p text, cd_analito_p text, nr_seq_exame_p text, nm_microorganismo_p text, nm_medicamento_p text, ds_resultado_p text, nm_usuario_p text, ds_erro_p INOUT text) AS $body$
DECLARE



nr_seq_exame_w		bigint;
nr_seq_prescr_w		bigint;
cd_microorganismo_w	varchar(60);
cd_medicamento_w	varchar(35);
ie_result_w		varchar(8);
cd_analito_w		varchar(20);


BEGIN
--obter a sequência da prescrição e nr. sequência do exame
select 	MAX(a.nr_sequencia),
	MAX(a.nr_seq_exame)
into STRICT	nr_seq_prescr_w,
	nr_seq_exame_w
from 	prescr_procedimento a,
	exame_laboratorio b
where	a.nr_prescricao = nr_prescricao_p
and	a.nr_seq_exame = b.nr_seq_exame
and	a.nr_seq_exame = nr_seq_exame_p;

--resultado
select 	upper(substr(ds_resultado_p,1,1))
into STRICT 	ie_result_w
;

-- Busca pelo código do analito
select	max(coalesce(e.cd_exame_integracao, e.cd_exame))
into STRICT	cd_analito_w
from	exame_laboratorio e
where	e.nr_seq_exame = (SELECT nr_seq_exame
			  from equipamento_lab b,
				lab_exame_equip a
			  WHERE	a.cd_equipamento = b.cd_equipamento
			  AND	a.cd_exame_equip = cd_analito_p
			  AND	upper(b.ds_sigla) = 'LSFRANCO'
			  AND	a.nr_seq_exame = nr_seq_exame_w);WITH RECURSIVE cte AS (



if (coalesce(cd_analito_w::text, '') = '') then

	select	max(coalesce(e.cd_exame_integracao, e.cd_exame))
	into STRICT	cd_analito_w
	from	exame_laboratorio e WHERE nr_seq_superior = nr_seq_exame_w
  UNION ALL



if (coalesce(cd_analito_w::text, '') = '') then

	select	max(coalesce(e.cd_exame_integracao, e.cd_exame))
	into STRICT	cd_analito_w
	from	exame_laboratorio e JOIN cte c ON (c.prior nr_seq_exame = e.nr_seq_superior)

) SELECT * FROM cte WHERE nr_seq_exame = (SELECT nr_seq_exame
				from equipamento_lab b,
				     lab_exame_equip a
				WHERE	a.cd_equipamento = b.cd_equipamento
				AND	a.cd_exame_equip = cd_analito_p
				AND	upper(b.ds_sigla) = 'LSFRANCO'
				AND	a.nr_seq_exame = e.nr_seq_exame);
;


end if;

--Se não encontrou pelo código de integração, verifica pelo nome
select	max(ds_microorganismo_integr)
into STRICT	cd_microorganismo_w
from	CIH_MICROORGANISMO
where	upper(trim(both ds_microorganismo_integr)) = upper(trim(both nm_microorganismo_p));

--Se não encontrou pelo código de integração, verifica pelo nome
select	max(ds_codigo_integr)
into STRICT	cd_medicamento_w
from	CIH_MEDICAMENTO
where	upper(trim(both ds_codigo_integr)) = upper(trim(both nm_medicamento_p));

if (nr_seq_prescr_w IS NOT NULL AND nr_seq_prescr_w::text <> '') then
		ds_erro_p := Lab_inserir_item_micro_result(	nr_prescricao_p, nr_seq_prescr_w, cd_analito_w, cd_microorganismo_w, cd_medicamento_w, null, --qt_microorganismo_p,
							null, --qt_mic_p,
							ie_result_w, nm_usuario_p, ds_erro_p);
else
	ds_erro_p := WHEB_MENSAGEM_PCK.get_texto(277362,'CD_DOENCA='||cd_analito_p||';NR_PRESCRICAO='||nr_prescricao_p);
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE lsf_inserir_item_micro_result ( nr_prescricao_p text, cd_analito_p text, nr_seq_exame_p text, nm_microorganismo_p text, nm_medicamento_p text, ds_resultado_p text, nm_usuario_p text, ds_erro_p INOUT text) FROM PUBLIC;

