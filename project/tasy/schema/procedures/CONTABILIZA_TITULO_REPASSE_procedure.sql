-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE contabiliza_titulo_repasse ( nr_lote_contabil_p bigint, nm_usuario_p text, ie_exclusao_p text, ds_retorno_p INOUT text) AS $body$
DECLARE


cd_conta_contabil_w                     varchar(20);
cd_estabelecimento_w                    smallint;
nr_documento_w                          varchar(255);
nr_documento_ww                         varchar(255);
vl_transacao_w                          double precision;
vl_transacao_orig_w                     double precision;
cd_pessoa_fisica_w                      varchar(10);
cd_cgc_w                                varchar(14);
nr_seq_trans_fin_w                      bigint;
nr_seq_trans_rep_w                      bigint;
nr_seq_trans_glosa_w                    bigint;
nr_seq_trans_maior_w                    bigint;
nr_seq_agrupamento_w                    bigint;
nm_atributo_w                           varchar(50);
dt_contabil_w                           timestamp;
dt_emissao_w                            timestamp;
vl_retorno_w                            double precision;
nr_titulo_w                             bigint;
cd_regra_w                              bigint;
ds_observacao_w                         varchar(2000);
ie_cc_rep_maior_glosa_w                 varchar(15);
cd_centro_custo_w                       bigint;
ie_compl_hist_w                         varchar(5);
ds_conteudo_w                           varchar(4000);
ds_pessoa_repasse_w                     varchar(255);
ie_cc_repasse_w                         varchar(2);
ie_dt_contab_tit_repasse_w              varchar(5);
cd_setor_atendimento_w                  bigint;
vl_repasse_liberado_w                   double precision;
vl_soma_transacao_w                     double precision;
vl_repasse_liberado_item_w              double precision;
nr_repasse_terceiro_w                   bigint;
ie_dt_movto_contab_tit_rep_w            varchar(1);
dt_contabil_tit_w                       timestamp;
ie_dt_tit_trib_orig_w                   varchar(1);
nr_nota_fiscal_w                        varchar(255);
nr_titulo_original_w                    bigint;
ds_notas_fiscais_w                      varchar(255);
nr_rep_terc_item_w                      bigint;
ds_lancamento_w                         varchar(10);
nr_titulo_repasse_w                     varchar(80);
pr_desdobramento_w                      double precision := 0;
vl_total_titulo_rep_w                   double precision := 0;
vl_titulo_w                             double precision;
vl_glosa_repasse_w                      double precision;
ie_contab_item_tit_rep_w                varchar(1);
ds_pessoa_titulo_w                      varchar(80);
nr_seq_proc_repasse_w                   bigint;
ie_contab_item_rep_liq_w                varchar(1);
ie_valor_w                              varchar(15);
nr_seq_rpa_w                            bigint;
nr_documento_mov_w                      movimento_contabil.nr_documento%type;
ie_origem_doc_w                         integer;
/* Calculo do valor liquido do repasse */

vl_total_itens_repasse_w                double precision;
vl_total_itens_repasse_liq_w            double precision;
vl_total_repasse_w                      double precision;
vl_total_repasse_liq_w                  double precision;
pr_item_repasse_w                       double precision;
ie_contab_tit_rep_desdob_w              varchar(1)     := 'N';
ie_periodo_contab_tit_rep_w             varchar(1);
nr_atendimento_w                        bigint;
nm_paciente_w                           varchar(60);
nr_seq_movto_w                          bigint;
cd_convenio_w                           bigint;
ds_convenio_w                           varchar(255);
cd_tributo_w                            bigint;
dt_inicial_w                            timestamp;
dt_final_w                              timestamp;
ie_contab_trib_repasse_cc_w             varchar(1);
ie_contab_repasse_venc_w                varchar(1);
ie_rep_contab_vl_liberado_w             varchar(1);
nm_agrupador_w                          varchar(255);
ie_contab_classif_tit_rep_w             varchar(1)     := 'N';
nm_tabela_w                             w_movimento_contabil.nm_tabela%type;
nr_seq_tab_orig_w                       w_movimento_contabil.nr_seq_tab_orig%type;
nr_seq_tab_compl_w                      w_movimento_contabil.nr_seq_tab_compl%type;
nr_seq_info_ctb_w                       w_movimento_contabil.nr_seq_info%type;
qt_insert_w                             integer := 0;
nr_registro_desc_w                      bigint;
cd_tipo_lote_contabil_w                 bigint;
nr_seq_mat_repasse_w                    bigint;
/* Cursor para ler Movimento a Ser contabilizado */

c010 CURSOR FOR
        SELECT  nr_titulo,
                CASE WHEN ie_situacao='D' THEN obter_valor_tit_pagar_desdob(nr_titulo)  ELSE vl_titulo END ,
                cd_pessoa_fisica,
                cd_cgc,
                'VL_TITULO_REPASSE',
                coalesce(nr_seq_trans_fin_contab, nr_seq_trans_rep_w),
                nr_titulo || ' ' || substr(obter_nome_pf_pj(cd_pessoa_fisica,cd_cgc),1,60) ds_observacao,
                CASE WHEN ie_dt_contab_tit_repasse_w='V' THEN dt_vencimento_atual WHEN ie_dt_contab_tit_repasse_w='C' THEN dt_contabil WHEN ie_dt_contab_tit_repasse_w='O' THEN dt_vencimento_original  ELSE dt_emissao END ,
                nr_repasse_terceiro,
                0 nr_sequencia,
                0 nr_seq_proc_repasse,
                0 nr_seq_mat_repasse,
                0 nr_atendimento,
                null cd_tributo,
                null cd_conta_contabil,
                'TITULO_PAGAR' nm_tabela,
                a.nr_titulo nr_seq_tab_orig,
                null    nr_seq_tab_compl,
                2       nr_seq_info_ctb
        from    titulo_pagar a
        where   nr_lote_contabil        = nr_lote_contabil_p
        and     coalesce(nr_seq_tributo::text, '') = ''

union   all

        PERFORM  a.nr_titulo,
                CASE WHEN a.ie_situacao='D' THEN obter_valor_tit_pagar_desdob(a.nr_titulo)  ELSE vl_titulo END ,
                c.cd_pessoa_fisica,
                c.cd_cgc,
                'VL_TRIBUTO_REPASSE',
                coalesce(a.nr_seq_trans_fin_contab, nr_seq_trans_rep_w),
                a.nr_titulo || ' ' || substr(obter_nome_pf_pj(a.cd_pessoa_fisica, a.cd_cgc),1,60) ds_observacao,
                CASE WHEN ie_dt_tit_trib_orig_w='N' THEN CASE WHEN ie_dt_contab_tit_repasse_w='V' THEN a.dt_vencimento_atual WHEN ie_dt_contab_tit_repasse_w='C' THEN a.dt_contabil WHEN ie_dt_contab_tit_repasse_w='O' THEN a.dt_vencimento_original  ELSE a.dt_emissao END   ELSE /*Francisco - OS 58301 - 18/07/07 */
                        to_date(CASE WHEN ie_dt_contab_tit_repasse_w='V' THEN obter_dados_tit_pagar(d.nr_titulo,'VE') WHEN ie_dt_contab_tit_repasse_w='C' THEN to_char(a.dt_contabil, 'dd/mm/yyyy') WHEN ie_dt_contab_tit_repasse_w='O' THEN obter_dados_tit_pagar(d.nr_titulo,'VO')  ELSE obter_dados_tit_pagar(d.nr_titulo,'EM') END ,'dd/mm/yyyy') END ,
                a.nr_repasse_terceiro,
                0 nr_sequencia,
                0 nr_seq_proc_repasse,
                0 nr_seq_mat_repasse,
                0 nr_atendimento,
                d.cd_tributo,
                null cd_conta_contabil,
                'TITULO_PAGAR' nm_tabela,
                a.nr_titulo             nr_seq_tab_orig,
                a.nr_seq_tributo        nr_seq_tab_compl,
                2       nr_seq_info_ctb
        from    titulo_pagar_imposto d,
                terceiro c,
                repasse_terceiro b,
                titulo_pagar a
        where   a.nr_lote_contabil      = nr_lote_contabil_p
        and     (a.nr_seq_tributo IS NOT NULL AND a.nr_seq_tributo::text <> '')
        and     a.nr_seq_tributo        = d.nr_sequencia
        and     a.nr_repasse_terceiro   = b.nr_repasse_terceiro
        and     b.nr_seq_terceiro       = c.nr_sequencia
        
union   all

        select  a.nr_titulo,
                coalesce(obter_valor_repasse_titulo(nr_titulo,'G'),0),
                cd_pessoa_fisica,
                cd_cgc,
                'VL_GLOSA_REPASSE',
                nr_seq_trans_glosa_w,
                nr_titulo || ' ' || substr(obter_nome_pf_pj(cd_pessoa_fisica,cd_cgc),1,60) ds_observacao,
                CASE WHEN ie_dt_contab_tit_repasse_w='V' THEN a.dt_vencimento_atual WHEN ie_dt_contab_tit_repasse_w='C' THEN dt_contabil WHEN ie_dt_contab_tit_repasse_w='O' THEN  a.dt_vencimento_original  ELSE a.dt_emissao END ,
                a.nr_repasse_terceiro,
                0 nr_sequencia,
                0 nr_seq_proc_repasse,
                0 nr_seq_mat_repasse,
                0 nr_atendimento,
                null cd_tributo,
                null cd_conta_contabil,
                'TITULO_PAGAR' nm_tabela,
                a.nr_titulo nr_seq_tab_orig,
                null    nr_seq_tab_compl,
                2       nr_seq_info_ctb
        from    titulo_pagar a
        where   nr_lote_contabil        = nr_lote_contabil_p
        and     coalesce(nr_seq_tributo::text, '') = ''
        and     obter_valor_repasse(nr_repasse_terceiro,'G') <> 0
        --and   a.ie_situacao <> 'D'
        
union   all

        select  a.nr_titulo,
                coalesce(obter_valor_repasse_titulo(nr_titulo,'M'),0),
                cd_pessoa_fisica,
                cd_cgc,
                'VL_MAIOR_REPASSE',
                nr_seq_trans_maior_w,
                nr_titulo || ' ' || substr(obter_nome_pf_pj(cd_pessoa_fisica,cd_cgc),1,60) ds_observacao,
                CASE WHEN ie_dt_contab_tit_repasse_w='V' THEN a.dt_vencimento_atual WHEN ie_dt_contab_tit_repasse_w='C' THEN dt_contabil WHEN ie_dt_contab_tit_repasse_w='O' THEN a.dt_vencimento_original  ELSE a.dt_emissao END ,
                a.nr_repasse_terceiro,
                0 nr_sequencia,
                0 nr_seq_proc_repasse,
                0 nr_seq_mat_repasse,
                0 nr_atendimento,
                null cd_tributo,
                null cd_conta_contabil,
                'TITULO_PAGAR' nm_tabela,
                a.nr_titulo nr_seq_tab_orig,
                null    nr_seq_tab_compl,
                2       nr_seq_info_ctb
        from    titulo_pagar a
        where   nr_lote_contabil                = nr_lote_contabil_p
        and     coalesce(nr_seq_tributo::text, '') = ''
        and     obter_valor_repasse(nr_repasse_terceiro,'M') <> 0
        --and   a.ie_situacao <> 'D'
        
union   all

        select  0,
                vl_repasse,
                c.cd_pessoa_fisica,
                c.cd_cgc,
                'VL_ITEM_REPASSE',
                nr_seq_trans_fin,
                substr(a.ds_observacao,1,255) ds_observacao,
                CASE WHEN ie_dt_contab_tit_repasse_w='C' THEN coalesce(a.dt_contabil,a.dt_lancamento)  ELSE coalesce(a.dt_lancamento,dt_contabil_w) END  dt_movimento,
                a.nr_repasse_terceiro,
                a.nr_sequencia,
                0 nr_seq_proc_repasse,
                0 nr_seq_mat_repasse,
                a.nr_atendimento,
                null cd_tributo,
                a.cd_conta_contabil,
                'REPASSE_TERCEIRO_ITEM' nm_tabela,
                a.nr_repasse_terceiro nr_seq_tab_orig,
                a.nr_sequencia  nr_seq_tab_compl,
                2       nr_seq_info_ctb
        from    terceiro c,
                repasse_terceiro b,
                repasse_terceiro_item a
        where   a.nr_lote_contabil      = nr_lote_contabil_p
        and     a.nr_repasse_terceiro   = b.nr_repasse_terceiro
        and     b.nr_seq_terceiro       = c.nr_sequencia
        
union all

        select  a.nr_titulo,
                coalesce(b.vl_repasse,0) vl_repasse,
                a.cd_pessoa_fisica,
                a.cd_cgc,
                'VL_REPASSE_PROC' nm_atributo,
                coalesce(nr_seq_trans_fin_contab, nr_seq_trans_rep_w),
                a.nr_titulo || ' ' || substr(obter_nome_pf_pj(a.cd_pessoa_fisica,a.cd_cgc),1,60) ds_observacao,
                CASE WHEN ie_dt_contab_tit_repasse_w='V' THEN a.dt_vencimento_atual WHEN ie_dt_contab_tit_repasse_w='C' THEN a.dt_contabil WHEN ie_dt_contab_tit_repasse_w='O' THEN a.dt_vencimento_original  ELSE a.dt_emissao END ,
                a.nr_repasse_terceiro,
                0 nr_sequencia,
                b.nr_sequencia nr_seq_proc_repasse,
                0 nr_seq_mat_repasse,
                c.nr_atendimento,
                null cd_tributo,
                null cd_conta_contabil,
                'PROCEDIMENTO_REPASSE' nm_tabela,
                a.nr_titulo nr_seq_tab_orig,
                b.nr_seq_procedimento   nr_seq_tab_compl,
                2       nr_seq_info_ctb
        from    procedimento_paciente c,
                procedimento_repasse b,
                titulo_pagar a
        where   a.nr_lote_contabil      = nr_lote_contabil_p
        and     a.nr_repasse_terceiro   = b.nr_repasse_terceiro
        and     b.nr_seq_procedimento   = c.nr_sequencia
        and     coalesce(a.nr_seq_tributo::text, '') = ''
        and     ie_contab_item_tit_rep_w = 'S'
        
union all

        select  a.nr_titulo,
                coalesce(b.vl_repasse,0) vl_repasse,
                a.cd_pessoa_fisica,
                a.cd_cgc,
                'VL_REPASSE_MAT' nm_atributo,
                coalesce(nr_seq_trans_fin_contab, nr_seq_trans_rep_w),
                a.nr_titulo || ' ' || substr(obter_nome_pf_pj(a.cd_pessoa_fisica,a.cd_cgc),1,60) ds_observacao,
                CASE WHEN ie_dt_contab_tit_repasse_w='V' THEN a.dt_vencimento_atual WHEN ie_dt_contab_tit_repasse_w='C' THEN a.dt_contabil WHEN ie_dt_contab_tit_repasse_w='O' THEN a.dt_vencimento_original  ELSE a.dt_emissao END ,
                a.nr_repasse_terceiro,
                0 nr_sequencia,
                0 nr_seq_proc_repasse,
                b.nr_sequencia nr_seq_mat_repasse,
                c.nr_atendimento,
                null cd_tributo,
                null cd_conta_contabil,
                'MATERIAL_REPASSE' nm_tabela,
                a.nr_titulo nr_seq_tab_orig,
                b.nr_seq_material       nr_seq_tab_compl,
                2       nr_seq_info_ctb
        from    material_atend_paciente c,
                material_repasse b,
                titulo_pagar a
        where   a.nr_lote_contabil      = nr_lote_contabil_p
        and     a.nr_repasse_terceiro   = b.nr_repasse_terceiro
        and     b.nr_seq_material       = c.nr_sequencia
        and     coalesce(a.nr_seq_tributo::text, '') = ''
        and     ie_contab_item_tit_rep_w = 'S'
        
union all

        select  a.nr_titulo,
                b.vl_liquido,
                a.cd_pessoa_fisica,
                a.cd_cgc,
                'VL_REPASSE_VENC',
                coalesce(a.nr_seq_trans_fin_contab, nr_seq_trans_rep_w),
                substr(a.nr_titulo || ' ' || substr(obter_nome_pf_pj(a.cd_pessoa_fisica,a.cd_cgc),1,60),1,255) ds_observacao,
                CASE WHEN ie_dt_contab_tit_repasse_w='V' THEN a.dt_vencimento_atual WHEN ie_dt_contab_tit_repasse_w='C' THEN  a.dt_contabil WHEN ie_dt_contab_tit_repasse_w='O' THEN  a.dt_vencimento_original  ELSE a.dt_emissao END ,
                a.nr_repasse_terceiro,
                0 nr_sequencia,
                0 nr_seq_proc_repasse,
                0 nr_seq_mat_repasse,
                0 nr_atendimento,
                null cd_tributo,
                null cd_conta_contabil,
                'REPASSE_TERCEIRO_VENC' nm_tabela,
                a.nr_titulo nr_seq_tab_orig,
                b.nr_sequencia  nr_seq_tab_compl,
                2       nr_seq_info_ctb
        from    repasse_terceiro_venc b,
                titulo_pagar a
        where   a.nr_titulo             = b.nr_titulo
        and     a.nr_lote_contabil      = b.nr_lote_contabil
        and     a.nr_lote_contabil      = nr_lote_contabil_p
        and     coalesce(a.nr_seq_tributo::text, '') = ''
        and     ie_contab_repasse_venc_w        = 'S'
        
union   all

        select  a.nr_titulo,
                coalesce(obter_valor_repasse_titulo(nr_titulo,'L'),0),
                cd_pessoa_fisica,
                cd_cgc,
                'VL_LIBERADO',
                coalesce(nr_seq_trans_fin_contab, nr_seq_trans_rep_w),
                nr_titulo || ' ' || substr(obter_nome_pf_pj(cd_pessoa_fisica,cd_cgc),1,60) ds_observacao,
                CASE WHEN ie_dt_contab_tit_repasse_w='V' THEN a.dt_vencimento_atual WHEN ie_dt_contab_tit_repasse_w='C' THEN dt_contabil WHEN ie_dt_contab_tit_repasse_w='O' THEN a.dt_vencimento_original  ELSE a.dt_emissao END ,
                a.nr_repasse_terceiro,
                0 nr_sequencia,
                0 nr_seq_proc_repasse,
                0 nr_seq_mat_repasse,
                0 nr_atendimento,
                null cd_tributo,
                null cd_conta_contabil,
                'TITULO_PAGAR' nm_tabela,
                a.nr_titulo nr_seq_tab_orig,
                null    nr_seq_tab_compl,
                2       nr_seq_info_ctb
        from    titulo_pagar a
        where   nr_lote_contabil                = nr_lote_contabil_p
        and     coalesce(nr_seq_tributo::text, '') = ''
        and     obter_valor_repasse(nr_repasse_terceiro,'L') <> 0
        order   by 1;


c020 CURSOR FOR
        SELECT
                ie_valor,
                cd_centro_custo,
                vl_transacao,
                cd_setor_atendimento,
                row_number() over (order by vl_transacao desc) nr_registro_desc
        from (
            SELECT  'P' ie_valor,
                    d.cd_centro_custo,
                    CASE WHEN nm_atributo_w='VL_GLOSA_REPASSE' THEN                            coalesce(sum(somente_positivo(coalesce(vl_repasse,0) - coalesce(vl_liberado,0))  + obter_glosa_rep_negativo(b.nr_sequencia, null)),0) WHEN nm_atributo_w='VL_MAIOR_REPASSE' THEN                             coalesce(sum(somente_positivo(coalesce(vl_liberado,0) - coalesce(vl_repasse,0))),0) END  vl_transacao,
                    d.cd_setor_atendimento
            from    setor_atendimento d,
                    procedimento_paciente c,
                    procedimento_repasse b,
                    titulo_pagar a
            where   a.nr_titulo                     = nr_titulo_w
            and     a.nr_repasse_terceiro   = b.nr_repasse_terceiro
            and     b.nr_seq_procedimento   = c.nr_sequencia
            and     c.cd_setor_atendimento  = d.cd_setor_atendimento
            and     nm_atributo_w           in ('VL_MAIOR_REPASSE','VL_GLOSA_REPASSE')
            and     coalesce(b.ie_estorno,'N') <> 'S'
            group   by d.cd_centro_custo,
                    d.cd_setor_atendimento
            
union   all

            select  'M' ie_valor,
                    d.cd_centro_custo,
                    CASE WHEN nm_atributo_w='VL_GLOSA_REPASSE' THEN                             coalesce(sum(somente_positivo(coalesce(vl_repasse,0) - coalesce(vl_liberado,0)) + obter_glosa_rep_negativo(null, b.nr_sequencia)),0) WHEN nm_atributo_w='VL_MAIOR_REPASSE' THEN                             coalesce(sum(somente_positivo(coalesce(vl_liberado,0) - coalesce(vl_repasse,0))),0) END ,
                    d.cd_setor_atendimento
            from    setor_atendimento d,
                    material_atend_paciente c,
                    material_repasse b,
                    titulo_pagar a
            where   a.nr_titulo                     = nr_titulo_w
            and     a.nr_repasse_terceiro   = b.nr_repasse_terceiro
            and     b.nr_seq_material               = c.nr_sequencia
            and     c.cd_setor_atendimento  = d.cd_setor_atendimento
            and     coalesce(b.ie_estorno,'N') <> 'S'
            and     nm_atributo_w           in ('VL_MAIOR_REPASSE','VL_GLOSA_REPASSE')
            group   by d.cd_centro_custo,
                    d.cd_setor_atendimento
            
union   all
                      -- Edgar 18/12/2006, 18/12/2006 OS 43465, inclui os 2 union abaixo para ratear por centro de custo
            select  'P' ie_valor,
                    d.cd_centro_custo,
            --      sum(dividir_sem_round(b.vl_liberado, obter_valor_repasse(a.nr_repasse_terceiro, 'LI')) * a.vl_titulo), -- Edgar 06/01/2007 OS 45650
                    sum(dividir_sem_round(b.vl_liberado, vl_repasse_liberado_w) * a.vl_titulo),
                    d.cd_setor_atendimento
            from    setor_atendimento d,
                    procedimento_paciente c,
                    procedimento_repasse b,
                    titulo_pagar a
            where   a.nr_titulo                     = nr_titulo_w
            and     a.nr_repasse_terceiro   = b.nr_repasse_terceiro
            and     b.nr_seq_procedimento   = c.nr_sequencia
            and     c.cd_setor_atendimento  = d.cd_setor_atendimento
            and     nm_atributo_w           in ('VL_TITULO_REPASSE')
            and     ie_cc_repasse_w         = 'S'
            and (b.nr_sequencia = nr_seq_proc_repasse_w or nr_seq_proc_repasse_w = 0)
            and ie_contab_classif_tit_rep_w = 'N'
            group   by d.cd_centro_custo,
                    d.cd_setor_atendimento
            
union   all

            select  'P' ie_valor,
                    d.cd_centro_custo,
                    sum(b.vl_repasse) vl_repasse,
                    d.cd_setor_atendimento
            from    setor_atendimento d,
                    procedimento_paciente c,
                    procedimento_repasse b,
                    titulo_pagar a
            where   a.nr_titulo                     = nr_titulo_w
            and     a.nr_repasse_terceiro   = b.nr_repasse_terceiro
            and     b.nr_seq_procedimento   = c.nr_sequencia
            and     c.cd_setor_atendimento  = d.cd_setor_atendimento
            and     nm_atributo_w           in ('VL_REPASSE_PROC')
            and     ie_cc_repasse_w         = 'S'
            and     ie_rep_contab_vl_liberado_w = 'S'
            and (b.nr_sequencia = nr_seq_proc_repasse_w or nr_seq_proc_repasse_w = 0)
            group   by d.cd_centro_custo,
                    d.cd_setor_atendimento
            
union   all

            select  'P' ie_valor,
                    d.cd_centro_custo,
                    sum(dividir_sem_round(b.vl_liberado, vl_repasse_liberado_w) * a.vl_titulo),
                    d.cd_setor_atendimento
            from    setor_atendimento d,
                    procedimento_paciente c,
                    procedimento_repasse b,
                    titulo_pagar a
            where   a.nr_titulo                     = nr_titulo_w
            and     a.nr_repasse_terceiro   = b.nr_repasse_terceiro
            and     b.nr_seq_procedimento   = c.nr_sequencia
            and     c.cd_setor_atendimento  = d.cd_setor_atendimento
            and     nm_atributo_w           in ('VL_REPASSE_PROC')
            and     ie_cc_repasse_w         = 'S'
            and     ie_rep_contab_vl_liberado_w = 'N'
            and (b.nr_sequencia = nr_seq_proc_repasse_w or nr_seq_proc_repasse_w = 0)
            group   by d.cd_centro_custo,
                    d.cd_setor_atendimento
            
union   all

            select  'P' ie_valor,
                    d.cd_centro_custo,
                    sum(dividir_sem_round(b.vl_liberado, vl_repasse_liberado_w) * (a.vl_titulo + obter_valor_tot_trib_inf(nr_titulo_w))),
                    d.cd_setor_atendimento
            from    setor_atendimento d,
                    procedimento_paciente c,
                    procedimento_repasse b,
                    titulo_pagar a
            where   a.nr_titulo                     = nr_titulo_w
            and     a.nr_repasse_terceiro   = b.nr_repasse_terceiro
            and     b.nr_seq_procedimento   = c.nr_sequencia
            and     c.cd_setor_atendimento  = d.cd_setor_atendimento
            and     nm_atributo_w           in ('VL_REPASSE_VENC')
            and     ie_cc_repasse_w         = 'S'
            and (b.nr_sequencia = nr_seq_proc_repasse_w or nr_seq_proc_repasse_w = 0)
            group   by d.cd_centro_custo,
                    d.cd_setor_atendimento
            
union   all

            select  'I' ie_valor,
                    b.cd_centro_custo,
                    sum(dividir_sem_round(b.vl_repasse, vl_repasse_liberado_item_w) * (a.vl_titulo + obter_valor_tot_trib_inf(nr_titulo_w))),
                    b.cd_setor_atendimento
            from    repasse_terceiro_item b,
                    titulo_pagar a
            where   a.nr_titulo                     = nr_titulo_w
            and     a.nr_repasse_terceiro   = b.nr_repasse_terceiro
            and     nm_atributo_w           in ('VL_REPASSE_VENC')
            and     ie_cc_repasse_w         = 'S'
            and (b.nr_sequencia = nr_seq_proc_repasse_w or nr_seq_proc_repasse_w = 0)
            and     not exists (select       1
                                            from    procedimento_repasse c
                                            where   c.nr_repasse_terceiro   = b.nr_repasse_terceiro
                                            
union all

                                            select  1
                                            from    material_repasse d
                                            where   d.nr_repasse_terceiro   = b.nr_repasse_terceiro)
            group   by b.cd_centro_custo,
                    b.cd_setor_atendimento
            
union   all

            select  'M' ie_valor,
                    d.cd_centro_custo,
                    sum(dividir_sem_round(b.vl_liberado, vl_repasse_liberado_w) * (a.vl_titulo + obter_valor_tot_trib_inf(nr_titulo_w))),
                    d.cd_setor_atendimento
            from    setor_atendimento d,
                    material_atend_paciente c,
                    material_repasse b,
                    titulo_pagar a
            where   a.nr_titulo                     = nr_titulo_w
            and     a.nr_repasse_terceiro   = b.nr_repasse_terceiro
            and     b.nr_seq_material       = c.nr_sequencia
            and     c.cd_setor_atendimento  = d.cd_setor_atendimento
            and     nm_atributo_w           in ('VL_REPASSE_VENC')
            and     ie_cc_repasse_w         = 'S'
            and (b.nr_sequencia = nr_seq_proc_repasse_w or nr_seq_proc_repasse_w = 0)
            group   by d.cd_centro_custo,
                    d.cd_setor_atendimento
            
union all

            select  'M' ie_valor,
                    d.cd_centro_custo,
                    sum(b.vl_repasse) vl_repasse,
                    d.cd_setor_atendimento
            from    setor_atendimento d,
                    material_atend_paciente c,
                    material_repasse b,
                    titulo_pagar a
            where   a.nr_titulo                     = nr_titulo_w
            and     a.nr_repasse_terceiro   = b.nr_repasse_terceiro
            and     b.nr_seq_material               = c.nr_sequencia
            and     c.cd_setor_atendimento  = d.cd_setor_atendimento
            and     ((nm_atributo_w                         = 'VL_TITULO_REPASSE' and ie_contab_classif_tit_rep_w = 'N')
                    or (nm_atributo_w              = 'VL_REPASSE_MAT'))
            and     ie_cc_repasse_w         = 'S'
            and     ie_rep_contab_vl_liberado_w = 'S'
            and (b.nr_sequencia = nr_seq_mat_repasse_w or nr_seq_mat_repasse_w = 0)
            group   by d.cd_centro_custo,
                    d.cd_setor_atendimento
            
union   all

            select  'M' ie_valor,
                    d.cd_centro_custo,
                    sum(dividir_sem_round(b.vl_liberado, vl_repasse_liberado_w) * a.vl_titulo),
                    d.cd_setor_atendimento
            from    setor_atendimento d,
                    material_atend_paciente c,
                    material_repasse b,
                    titulo_pagar a
            where   a.nr_titulo                     = nr_titulo_w
            and     a.nr_repasse_terceiro   = b.nr_repasse_terceiro
            and     b.nr_seq_material               = c.nr_sequencia
            and     c.cd_setor_atendimento  = d.cd_setor_atendimento
            and     ((nm_atributo_w                         = 'VL_TITULO_REPASSE' and ie_contab_classif_tit_rep_w = 'N')
                    or (nm_atributo_w              = 'VL_REPASSE_MAT'))
            and     ie_cc_repasse_w         = 'S'
            and     ie_rep_contab_vl_liberado_w = 'N'
            and (b.nr_sequencia = nr_seq_mat_repasse_w or nr_seq_mat_repasse_w = 0)
            group   by d.cd_centro_custo,
                    d.cd_setor_atendimento
            
union   all

            select  'I' ie_valor,
                    a.cd_centro_custo,
                    sum(vl_repasse),
                    0
            from    repasse_terceiro_item a
            where   nr_repasse_terceiro     = nr_repasse_terceiro_w
            and     nr_seq_trans_fin        = nr_seq_trans_fin_w
            and     nm_atributo_w           in ('VL_ITEM_REPASSE')
            and     nr_sequencia            = nr_rep_terc_item_w
            and     ie_cc_repasse_w         = 'S'
            and     ie_contab_item_rep_liq_w = 'N'
            group by a.cd_centro_custo
            
union   all

            select  'I' ie_valor,
                    a.cd_centro_custo,
                    sum(vl_repasse),
                    0
            from    repasse_terceiro_item a,
                    titulo_pagar b
            where   a.nr_repasse_terceiro   = b.nr_repasse_terceiro
            and     b.nr_repasse_terceiro   = nr_repasse_terceiro_w
            and     b.nr_titulo             = nr_titulo_w
            and     a.nr_seq_trans_fin      = nr_seq_trans_fin_w
            and     nm_atributo_w           in ('VL_TITULO_REPASSE')
            and (a.nr_sequencia         = nr_rep_terc_item_w or nr_rep_terc_item_w =0)
            and     ie_cc_repasse_w         = 'S'
            and     ie_contab_item_rep_liq_w = 'S'
            and     not exists (
                                select       1
                                from    procedimento_repasse y
                                where   y.nr_repasse_terceiro   = a.nr_repasse_terceiro
                                and     y.nr_repasse_terceiro   = nr_repasse_terceiro_w
                                
union all

                                select       1
                                from    material_repasse x
                                where   x.nr_repasse_terceiro   = a.nr_repasse_terceiro
                                and     x.nr_repasse_terceiro   = nr_repasse_terceiro_w)
            group by a.cd_centro_custo
            
union all

            select  'I' ie_valor,
                    d.cd_centro_custo,
                    sum(dividir_sem_round(d.vl_repasse, vl_repasse_liberado_item_w) * a.vl_titulo),
                    0
            from    repasse_terceiro b,
                    titulo_pagar a,
                    repasse_terceiro_item d
            where   a.nr_repasse_terceiro = b.nr_repasse_terceiro
            and     d.nr_repasse_terceiro  = b.nr_repasse_terceiro
            and     a.nr_repasse_terceiro = nr_repasse_terceiro_w
            and     a.nr_titulo = nr_titulo_w
            and     d.nr_seq_trans_fin      = nr_seq_trans_fin_w
            and (d.nr_sequencia         = nr_rep_terc_item_w or nr_rep_terc_item_w =0)
            and     ie_cc_repasse_w = 'S'
            and     nm_atributo_w           in ('VL_TITULO_REPASSE')
            and     ie_contab_item_rep_liq_w = 'N'
            and     not exists ( 
                                select       1
                                from    procedimento_repasse y
                                where   y.nr_repasse_terceiro   = b.nr_repasse_terceiro
                                and     y.nr_repasse_terceiro   = nr_repasse_terceiro_w
                                
union all

                                select       1
                                from    material_repasse x
                                where   x.nr_repasse_terceiro   = a.nr_repasse_terceiro
                                and     x.nr_repasse_terceiro   = nr_repasse_terceiro_w)
            group by d.cd_centro_custo,a.ie_situacao,a.nr_titulo,a.vl_titulo
            
union all

            select  'P' ie_valor,
                    d.cd_centro_custo,
            --      sum(dividir_sem_round(b.vl_liberado, obter_valor_repasse(a.nr_repasse_terceiro, 'LI')) * a.vl_titulo), -- Edgar 06/01/2007 OS 45650
                    sum(dividir_sem_round(b.vl_liberado, vl_repasse_liberado_w) * a.vl_titulo),
                    d.cd_setor_atendimento
            from    setor_atendimento d,
                    procedimento_paciente c,
                    procedimento_repasse b,
                    titulo_pagar a
            where   a.nr_titulo                     = nr_titulo_w
            and     a.nr_repasse_terceiro   = b.nr_repasse_terceiro
            and     b.nr_seq_procedimento   = c.nr_sequencia
            and     c.cd_setor_atendimento  = d.cd_setor_atendimento
            and     nm_atributo_w           = 'VL_TRIBUTO_REPASSE'
            and     ie_contab_trib_repasse_cc_w             = 'S'
            and (b.nr_sequencia = nr_seq_proc_repasse_w or nr_seq_proc_repasse_w = 0)
            and ie_contab_classif_tit_rep_w = 'N'
            group   by d.cd_centro_custo,
                    d.cd_setor_atendimento
            
union   all

            select  'M' ie_valor,
                    d.cd_centro_custo,
            --      sum(dividir_sem_round(b.vl_liberado, obter_valor_repasse(a.nr_repasse_terceiro, 'LI')) * a.vl_titulo), -- Edgar 06/01/2007 OS 45650
                    sum(dividir_sem_round(b.vl_liberado, vl_repasse_liberado_w) * a.vl_titulo),
                    d.cd_setor_atendimento
            from    setor_atendimento d,
                    material_atend_paciente c,
                    material_repasse b,
                    titulo_pagar a
            where   a.nr_titulo                     = nr_titulo_w
            and     a.nr_repasse_terceiro   = b.nr_repasse_terceiro
            and     b.nr_seq_material               = c.nr_sequencia
            and     c.cd_setor_atendimento  = d.cd_setor_atendimento
            and     nm_atributo_w           = 'VL_TRIBUTO_REPASSE'
            and     ie_contab_trib_repasse_cc_w             = 'S'
            and ie_contab_classif_tit_rep_w = 'N'
            group   by d.cd_centro_custo,
                    d.cd_setor_atendimento
            
union all

            select  'T',
                    b.cd_centro_custo,
                    b.vl_titulo,
                    null cd_setor_atendimento
            from  titulo_pagar_classif b,
                  titulo_pagar a
            where   a.nr_titulo     = b.nr_titulo
            and             a.nr_titulo     = nr_titulo_w
            and ie_contab_classif_tit_rep_w = 'S'
            and                     ((nm_atributo_w = 'VL_TRIBUTO_REPASSE'
                                    and     ie_contab_trib_repasse_cc_w             = 'S')
                    or (nm_atributo_w  = 'VL_TITULO_REPASSE'
                                    and     ie_cc_repasse_w                                 = 'S'))
            and     exists (        select  1
                                            from    procedimento_repasse c
                                            where   c.nr_repasse_terceiro   = a.nr_repasse_terceiro
                                            
union all

                                            select  1
                                            from    material_repasse d
                                            where   d.nr_repasse_terceiro   = a.nr_repasse_terceiro
                                            
union all

                                            select 1
                                            from    repasse_terceiro_item e
                                            where   e.nr_repasse_terceiro   = a.nr_repasse_terceiro
                                            and             nm_atributo_w = 'VL_TRIBUTO_REPASSE'
                                            and             ie_contab_trib_repasse_cc_w             = 'S')
        ) alias89
        order by vl_transacao;


cTituloPagar CURSOR FOR
        SELECT  t.nr_titulo,
                t.vl_titulo,
                t.cd_pessoa_fisica,
                t.cd_cgc,
                coalesce(t.nr_seq_trans_fin_contab, nr_seq_trans_rep_w),
                t.nr_titulo || ' ' || substr(obter_nome_pf_pj(t.cd_pessoa_fisica,t.cd_cgc),1,60) as ds_observacao,
                CASE WHEN ie_dt_contab_tit_repasse_w='V' THEN t.dt_vencimento_atual WHEN ie_dt_contab_tit_repasse_w='C' THEN t.dt_contabil WHEN ie_dt_contab_tit_repasse_w='O' THEN t.dt_vencimento_original  ELSE t.dt_emissao END  as dt_lancamento,
                t.nr_repasse_terceiro,
                null as nr_rep_terc_item,
                t.nr_titulo as nr_seq_tab_orig,
                null as nr_seq_tab_compl,
                2 as nr_seq_info_ctb,
                obter_valor_repasse(t.nr_repasse_terceiro, 'RI') as vl_repasse_liberado,
                obter_valor_repasse(t.nr_repasse_terceiro, 'LI') as vl_repasse_liberado_item
        from    titulo_pagar t
        where   nr_lote_contabil = nr_lote_contabil_p

union all

        SELECT  null as nr_titulo,
                a.vl_repasse as vl_titulo,
                c.cd_pessoa_fisica,
                c.cd_cgc,
                a.nr_seq_trans_fin,
                substr(a.ds_observacao,1,255) ds_observacao,
                CASE WHEN ie_dt_contab_tit_repasse_w='C' THEN coalesce(a.dt_contabil,a.dt_lancamento)  ELSE coalesce(a.dt_lancamento,dt_contabil_w) END  as dt_lancamento,
                a.nr_repasse_terceiro,
                a.nr_sequencia as nr_rep_terc_item,
                a.nr_repasse_terceiro as nr_seq_tab_orig,
                a.nr_sequencia as nr_seq_tab_compl,
                2 as nr_seq_info_ctb,
                0 as vl_repasse_liberado,
                0 as vl_repasse_liberado_item
        from    repasse_terceiro_item a,
                repasse_terceiro b,
                terceiro c
        where   a.nr_repasse_terceiro   = b.nr_repasse_terceiro
        and     b.nr_seq_terceiro       = c.nr_sequencia
        and     a.nr_lote_contabil      = nr_lote_contabil_p;


cLancamento CURSOR FOR
        SELECT
            nm_tabela,
            nm_atributo,
            cd_centro_custo,
            vl_lancamento,
            cd_setor_atendimento,
            cd_conta_contabil,
            cd_tributo,
            nr_atendimento,
            row_number() over (order by vl_lancamento desc) nr_registro_desc
        from (
            SELECT  'P' as ie_valor,
                    'TITULO_PAGAR' as nm_tabela,
                    'VL_TITULO_REPASSE' as nm_atributo,
                    d.cd_centro_custo as cd_centro_custo,
                    sum(dividir_sem_round(b.vl_liberado, vl_repasse_liberado_w) * a.vl_titulo) as vl_lancamento,
                    d.cd_setor_atendimento as cd_setor_atendimento,
                    null as cd_conta_contabil,
                    null as cd_tributo,
                    0 as nr_atendimento
            from    titulo_pagar a,
                    procedimento_repasse b,
                    procedimento_paciente c,
                    setor_atendimento d
            where   a.nr_repasse_terceiro       = b.nr_repasse_terceiro
            and     b.nr_seq_procedimento       = c.nr_sequencia
            and     c.cd_setor_atendimento      = d.cd_setor_atendimento
            and     a.nr_titulo                 = nr_titulo_w
            and     ie_contab_classif_tit_rep_w = 'N'
            group   by d.cd_centro_custo,
                    d.cd_setor_atendimento

union   all

            select  'M' as ie_valor,
                    'TITULO_PAGAR' as nm_tabela,
                    'VL_TITULO_REPASSE' as nm_atributo,
                    d.cd_centro_custo as cd_centro_custo,
                    sum(dividir_sem_round(b.vl_liberado, vl_repasse_liberado_w) * a.vl_titulo) as vl_lancamento,
                    d.cd_setor_atendimento as cd_setor_atendimento,
                    null as cd_conta_contabil,
                    null as cd_tributo,
                    0 as nr_atendimento
            from    titulo_pagar a,
                    material_repasse b,
                    material_atend_paciente c,
                    setor_atendimento d
            where   a.nr_repasse_terceiro       = b.nr_repasse_terceiro
            and     b.nr_seq_material           = c.nr_sequencia
            and     c.cd_setor_atendimento      = d.cd_setor_atendimento 
            and     a.nr_titulo                 = nr_titulo_w
            and     ie_contab_classif_tit_rep_w = 'N'
            group   by d.cd_centro_custo,
                    d.cd_setor_atendimento
            
union   all

            select  'I' as ie_valor,
                    'TITULO_PAGAR' as nm_tabela,
                    'VL_TITULO_REPASSE' as nm_atributo,
                    a.cd_centro_custo as cd_centro_custo,
                    sum(a.vl_repasse) as vl_lancamento,
                    null as cd_setor_atendimento,
                    null as cd_conta_contabil,
                    null as cd_tributo,
                    0 as nr_atendimento
            from    titulo_pagar b,
                    repasse_terceiro_item a
            where   a.nr_repasse_terceiro       = b.nr_repasse_terceiro
            and     b.nr_titulo                 = nr_titulo_w
            and     a.nr_seq_trans_fin          = nr_seq_trans_fin_w
            and     ie_contab_item_rep_liq_w    = 'S'
            and not exists ( select       1
                            from    procedimento_repasse y
                            where   y.nr_repasse_terceiro   = a.nr_repasse_terceiro
                            
union all

                            select       1
                            from    material_repasse x
                            where   x.nr_repasse_terceiro   = a.nr_repasse_terceiro)
            group   by a.cd_centro_custo
            
union   all

            select  'T' as ie_valor,
                    'TITULO_PAGAR' as nm_tabela,
                    'VL_TITULO_REPASSE' as nm_atributo,
                    b.cd_centro_custo as cd_centro_custo,
                    b.vl_titulo as vl_lancamento,
                    null cd_setor_atendimento,
                    null as cd_conta_contabil,
                    null as cd_tributo,
                    0 as nr_atendimento
            from    titulo_pagar a,
                    titulo_pagar_classif b
            where   a.nr_titulo                 = b.nr_titulo
            and     a.nr_titulo                 = nr_titulo_w
            and     ie_contab_classif_tit_rep_w = 'S'
            and     coalesce(a.nr_seq_tributo::text, '') = ''
            
union   all

            select  'P' as  ie_valor,
                    'TITULO_PAGAR' as nm_tabela,
                    'VL_TRIBUTO_REPASSE' as nm_atributo,
                    d.cd_centro_custo as cd_centro_custo,
                    sum(dividir_sem_round(b.vl_liberado, vl_repasse_liberado_w) * a.vl_titulo) as vl_lancamento,
                    d.cd_setor_atendimento as cd_setor_atendimento,
                    null as cd_conta_contabil,
                    null as cd_tributo,
                    0 as nr_atendimento
            from    titulo_pagar a,
                    procedimento_repasse b,
                    procedimento_paciente c,
                    setor_atendimento d
            where   a.nr_repasse_terceiro       = b.nr_repasse_terceiro
            and     b.nr_seq_procedimento       = c.nr_sequencia
            and     c.cd_setor_atendimento      = d.cd_setor_atendimento
            and     a.nr_titulo                 = nr_titulo_w
            and     ie_contab_trib_repasse_cc_w = 'S'
            and     ie_contab_classif_tit_rep_w = 'N'
            group   by d.cd_centro_custo,
                    d.cd_setor_atendimento
            
union   all

            select  'M' as ie_valor,
                    'TITULO_PAGAR' as nm_tabela,
                    'VL_TRIBUTO_REPASSE' as nm_atributo,
                    d.cd_centro_custo as cd_centro_custo,
                    sum(dividir_sem_round(b.vl_liberado, vl_repasse_liberado_w) * a.vl_titulo) as vl_lancamento,
                    d.cd_setor_atendimento,
                    null as cd_conta_contabil,
                    null as cd_tributo,
                    0 as nr_atendimento
            from    titulo_pagar a,
                    material_repasse b,
                    material_atend_paciente c,
                    setor_atendimento d
            where   a.nr_repasse_terceiro       = b.nr_repasse_terceiro
            and     b.nr_seq_material           = c.nr_sequencia
            and     c.cd_setor_atendimento      = d.cd_setor_atendimento
            and     a.nr_titulo                 = nr_titulo_w
            and     ie_contab_trib_repasse_cc_w = 'S'
            and     ie_contab_classif_tit_rep_w = 'N'
            group   by d.cd_centro_custo,
                    d.cd_setor_atendimento
            
union   all

            select  'T' as ie_valor,
                    'TITULO_PAGAR' as nm_tabela,
                    'VL_TRIBUTO_REPASSE' as nm_atributo,
                    b.cd_centro_custo as cd_centro_custo,
                    b.vl_titulo as vl_lancamento,
                    null cd_setor_atendimento,
                    null as cd_conta_contabil,
                    e.cd_tributo as cd_tributo,
                    0 as nr_atendimento
            from    titulo_pagar a,
                    titulo_pagar_classif b,
                    repasse_terceiro c,
                    terceiro d,
                    titulo_pagar_imposto e
            where   a.nr_titulo                 = b.nr_titulo
            and     a.nr_repasse_terceiro       = c.nr_repasse_terceiro
            and     c.nr_seq_terceiro           = d.nr_sequencia
            and     a.nr_seq_tributo            = e.nr_sequencia
            and     a.nr_titulo                 = nr_titulo_w
            and     ie_contab_trib_repasse_cc_w = 'S'
            and     (a.nr_seq_tributo IS NOT NULL AND a.nr_seq_tributo::text <> '')
            
union   all

            select  'P' as ie_valor,
                    'TITULO_PAGAR' as nm_tabela,
                    'VL_GLOSA_REPASSE' as nm_atributo,
                    d.cd_centro_custo as cd_centro_custo,
                    coalesce(sum(somente_positivo(coalesce(b.vl_repasse,0) - coalesce(b.vl_liberado,0))  + obter_glosa_rep_negativo(b.nr_sequencia, null)),0) as vl_lancamento,
                    d.cd_setor_atendimento as cd_setor_atendimento,
                    null as cd_conta_contabil,
                    null as cd_tributo,
                    0 as nr_atendimento
            from    titulo_pagar a,
                    procedimento_repasse b,
                    procedimento_paciente c,
                    setor_atendimento d
            where   a.nr_repasse_terceiro   = b.nr_repasse_terceiro
            and     b.nr_seq_procedimento   = c.nr_sequencia
            and     c.cd_setor_atendimento  = d.cd_setor_atendimento
            and     a.nr_titulo             = nr_titulo_w
            and     coalesce(a.nr_seq_tributo::text, '') = ''
            and     coalesce(b.ie_estorno,'N') <> 'S'
            group   by d.cd_centro_custo,
                    d.cd_setor_atendimento
            
union   all

            select  'M' as ie_valor,
                    'TITULO_PAGAR' as nm_tabela,
                    'VL_GLOSA_REPASSE' as nm_atributo,
                    d.cd_centro_custo as cd_centro_custo,
                    coalesce(sum(somente_positivo(coalesce(b.vl_repasse,0) - coalesce(b.vl_liberado,0)) + obter_glosa_rep_negativo(null, b.nr_sequencia)),0) as vl_lancamento,
                    d.cd_setor_atendimento as cd_setor_atendimento,
                    null as cd_conta_contabil,
                    null as cd_tributo,
                    0 as nr_atendimento
            from    titulo_pagar a,
                    material_repasse b,
                    material_atend_paciente c,
                    setor_atendimento d
            where   a.nr_repasse_terceiro   = b.nr_repasse_terceiro
            and     b.nr_seq_material       = c.nr_sequencia
            and     c.cd_setor_atendimento  = d.cd_setor_atendimento
            and     a.nr_titulo             = nr_titulo_w
            and     coalesce(a.nr_seq_tributo::text, '') = ''
            and     coalesce(b.ie_estorno,'N') <> 'S'
            group   by d.cd_centro_custo,
                    d.cd_setor_atendimento
            
union   all

            select  'P' as ie_valor,
                    'TITULO_PAGAR' as nm_tabela,
                    'VL_MAIOR_REPASSE' as nm_atributo,
                    d.cd_centro_custo as cd_centro_custo,
                    coalesce(sum(somente_positivo(coalesce(b.vl_liberado,0) - coalesce(b.vl_repasse,0))),0) as vl_lancamento,
                    d.cd_setor_atendimento as cd_setor_atendimento,
                    null as cd_conta_contabil,
                    null as cd_tributo,
                    0 as nr_atendimento
            from    titulo_pagar a,
                    procedimento_repasse b,
                    procedimento_paciente c,
                    setor_atendimento d
            where   a.nr_repasse_terceiro   = b.nr_repasse_terceiro
            and     b.nr_seq_procedimento   = c.nr_sequencia
            and     c.cd_setor_atendimento  = d.cd_setor_atendimento
            and     a.nr_titulo             = nr_titulo_w
            and     coalesce(a.nr_seq_tributo::text, '') = ''
            and     coalesce(b.ie_estorno,'N') <> 'S'
            group   by d.cd_centro_custo,
                    d.cd_setor_atendimento
            
union   all

            select  'M' as ie_valor,
                    'TITULO_PAGAR' as nm_tabela,
                    'VL_MAIOR_REPASSE' as nm_atributo,
                    d.cd_centro_custo as cd_centro_custo,
                    coalesce(sum(somente_positivo(coalesce(b.vl_liberado,0) - coalesce(b.vl_repasse,0))),0) as vl_lancamento,
                    d.cd_setor_atendimento as cd_setor_atendimento,
                    null as cd_conta_contabil,
                    null as cd_tributo,
                    0 as nr_atendimento
            from    titulo_pagar a,
                    material_repasse b,
                    material_atend_paciente c,
                    setor_atendimento d
            where   a.nr_repasse_terceiro   = b.nr_repasse_terceiro
            and     b.nr_seq_material       = c.nr_sequencia
            and     c.cd_setor_atendimento  = d.cd_setor_atendimento
            and     a.nr_titulo             = nr_titulo_w
            and     coalesce(a.nr_seq_tributo::text, '') = ''
            and     coalesce(b.ie_estorno,'N') <> 'S'
            group   by d.cd_centro_custo,
                    d.cd_setor_atendimento
            
union   all

            select 'I' as ie_valor,
                    'REPASSE_TERCEIRO_ITEM' as nm_tabela,
                    'VL_ITEM_REPASSE' as nm_atributo,
                    a.cd_centro_custo as cd_centro_custo,
                    sum(a.vl_repasse) as vl_lancamento,
                    null as cd_setor_atendimento,
                    null as cd_conta_contabil,
                    null as cd_tributo,
                    max(a.nr_atendimento) as nr_atendimento
            from    repasse_terceiro_item a
            where   a.nr_sequencia              = nr_rep_terc_item_w 
            and     ie_contab_item_rep_liq_w    = 'N'
            group by a.cd_centro_custo
            
union   all

            select 'P' as ie_valor,
                    'PROCEDIMENTO_REPASSE' as nm_tabela,
                    'VL_REPASSE_PROC' as nm_atributo,
                    d.cd_centro_custo as cd_centro_custo,
                    CASE WHEN ie_rep_contab_vl_liberado_w='N' THEN  sum(dividir_sem_round(b.vl_liberado, vl_repasse_liberado_item_w) * a.vl_titulo)  ELSE sum(b.vl_repasse) END  as vl_lancamento,
                    d.cd_setor_atendimento as cd_setor_atendimento,
                    null as cd_conta_contabil,
                    null as cd_tributo,
                    max(c.nr_atendimento) as nr_atendimento
            from    titulo_pagar a,
                    procedimento_repasse b,
                    procedimento_paciente c,
                    setor_atendimento d
            where   a.nr_repasse_terceiro       = b.nr_repasse_terceiro
            and     b.nr_seq_procedimento       = c.nr_sequencia
            and     c.cd_setor_atendimento      = d.cd_setor_atendimento
            and     a.nr_titulo                 = nr_titulo_w
            and     ie_contab_item_tit_rep_w    = 'S'
            and     coalesce(a.nr_seq_tributo::text, '') = ''
            group   by d.cd_centro_custo,
                    d.cd_setor_atendimento
            
union   all

            select 'M' as ie_valor,
                    'MATERIAL_REPASSE' as nm_tabela,
                    'VL_REPASSE_MAT' as nm_atributo,
                    d.cd_centro_custo as cd_centro_custo,
                    sum(b.vl_repasse) as vl_lancamento,
                    d.cd_setor_atendimento as cd_setor_atendimento,
                    null as cd_conta_contabil,
                    null as cd_tributo,
                    max(c.nr_atendimento) as nr_atendimento
            from    titulo_pagar a,
                    material_repasse b,
                    material_atend_paciente c,
                    setor_atendimento d
            where   a.nr_repasse_terceiro = b.nr_repasse_terceiro
            and     b.nr_seq_material = c.nr_sequencia
            and     c.cd_setor_atendimento = d.cd_setor_atendimento
            and     a.nr_titulo = nr_titulo_w
            and     ie_contab_item_tit_rep_w = 'S'
            and     coalesce(a.nr_seq_tributo::text, '') = ''
            group   by d.cd_centro_custo,
                    d.cd_setor_atendimento
            
union   all

            select  'P' as ie_valor,
                    'REPASSE_TERCEIRO_VENC' as nm_tabela,
                    'VL_REPASSE_VENC' as nm_atributo,
                    d.cd_centro_custo as cd_centro_custo,
                    sum(dividir_sem_round(b.vl_liberado, vl_repasse_liberado_w) * (a.vl_titulo + obter_valor_tot_trib_inf(a.nr_titulo))) as vl_lancamento,
                    d.cd_setor_atendimento as cd_setor_atendimento,
                    null as cd_conta_contabil,
                    null as cd_tributo,
                    0 as nr_atendimento
            from    titulo_pagar a,
                    procedimento_repasse b,
                    procedimento_paciente c,
                    setor_atendimento d
            where   a.nr_repasse_terceiro   = b.nr_repasse_terceiro
            and     b.nr_seq_procedimento   = c.nr_sequencia
            and     c.cd_setor_atendimento  = d.cd_setor_atendimento
            and     a.nr_titulo             = nr_titulo_w
            group   by d.cd_centro_custo,
                    d.cd_setor_atendimento
            
union   all

            select 'I' as ie_valor,
                    'REPASSE_TERCEIRO_VENC' as nm_tabela,
                    'VL_REPASSE_VENC' as nm_atributo,
                    b.cd_centro_custo as cd_centro_custo,
                    sum(dividir_sem_round(b.vl_repasse, vl_repasse_liberado_item_w) * (a.vl_titulo + obter_valor_tot_trib_inf(a.nr_titulo))) as vl_lancamento,
                    b.cd_setor_atendimento as cd_setor_atendimento,
                    null as cd_conta_contabil,
                    null as cd_tributo,
                    0 as nr_atendimento
            from    titulo_pagar a,
                    repasse_terceiro_item b
            where   a.nr_repasse_terceiro   = b.nr_repasse_terceiro
            and     a.nr_titulo             = nr_titulo_w
            group   by b.cd_centro_custo,
                    b.cd_setor_atendimento
            
union   all

            select  'M' as ie_valor,
                    'REPASSE_TERCEIRO_VENC' as nm_tabela,
                    'VL_REPASSE_VENC' as nm_atributo,
                    d.cd_centro_custo as cd_centro_custo,
                    sum(dividir_sem_round(b.vl_liberado, vl_repasse_liberado_w) * (a.vl_titulo + obter_valor_tot_trib_inf(a.nr_titulo))) as vl_lancamento,
                    d.cd_setor_atendimento as cd_setor_atendimento,
                    null as cd_conta_contabil,
                    null as cd_tributo,
                    0 as nr_atendimento
            from    titulo_pagar a,
                    material_repasse b,
                    material_atend_paciente c,
                    setor_atendimento d
            where   a.nr_repasse_terceiro   = b.nr_repasse_terceiro
            and     b.nr_seq_material       = c.nr_sequencia
            and     c.cd_setor_atendimento  = d.cd_setor_atendimento
            and     a.nr_titulo             = nr_titulo_w
            group   by d.cd_centro_custo,
                    d.cd_setor_atendimento
            
union   all

            select  'T' as ie_valor,
                    'TITULO_PAGAR' as nm_tabela,
                    'VL_LIBERADO' as nm_atributo,
                    null as cd_centro_custo,
                    obter_valor_repasse_titulo(a.nr_titulo,'L') as vl_lancamento,
                    null as cd_setor_atendimento,
                    null as cd_conta_contabil,
                    null as cd_tributo,
                    0 as nr_atendimento
            from    titulo_pagar a
            where   a.nr_titulo = nr_titulo_w
            and     coalesce(nr_seq_tributo::text, '') = ''
            and     obter_valor_repasse(a.nr_repasse_terceiro,'L') <> 0
        ) alias69
        order by vl_lancamento;


c03 CURSOR FOR
        SELECT  b.nr_nota_fiscal
        from    nota_fiscal b,
                repasse_nota_fiscal a
        where   a.nr_seq_nota_fiscal    = b.nr_sequencia
        and     a.nr_repasse_terceiro   = nr_repasse_terceiro_w;


BEGIN
/*Validacao para impedir a geracao em lotes incorretos */

if (ie_exclusao_p <> 'S') then
        select b.cd_tipo_lote_contabil
        into STRICT cd_tipo_lote_contabil_w
        from lote_contabil b
        where b.nr_lote_contabil = nr_lote_contabil_p;
        if (cd_tipo_lote_contabil_w <> 16) then
                CALL wheb_mensagem_pck.exibir_mensagem_abort(261346);
        end if;
end if;
delete
from    lote_contabil_log
where   nr_lote_contabil = nr_lote_contabil_p
and     cd_log_lote in (9,10);
commit;

select  dt_referencia,
        cd_estabelecimento,
        obter_se_compl_tipo_lote(cd_estabelecimento, cd_tipo_lote_contabil)
into STRICT    dt_contabil_w,
        cd_estabelecimento_w,
        ie_compl_hist_w
from    lote_contabil
where   nr_lote_contabil                = nr_lote_contabil_p;

if (ie_exclusao_p          = 'S') then
        delete from movimento_contabil
        where  nr_lote_contabil         = nr_lote_contabil_p;
        commit;

        update lote_contabil
        set      vl_credito             = 0,
                 vl_debito              = 0
        where    nr_lote_contabil       = nr_lote_contabil_p;
        commit;

        update material_repasse
        set     dt_contabil_titulo              = to_date('01/01/2999','dd/mm/yyyy')
        where   nr_repasse_terceiro in (SELECT nr_repasse_terceiro
                from    titulo_pagar
                where   nr_lote_contabil        = nr_lote_contabil_p);
        commit;

        update procedimento_repasse
        set     dt_contabil_titulo              = to_date('01/01/2999','dd/mm/yyyy')
        where   nr_repasse_terceiro in (SELECT nr_repasse_terceiro
                from    titulo_pagar
                where   nr_lote_contabil        = nr_lote_contabil_p);
        commit;

        update repasse_terceiro_item
        set     nr_lote_contabil                = 0
        where   nr_repasse_terceiro in (SELECT nr_repasse_terceiro
                from    titulo_pagar
                where   nr_lote_contabil        = nr_lote_contabil_p)
        and     nr_lote_contabil                = nr_lote_contabil_p;
        commit;

        update titulo_pagar
        set     nr_lote_contabil        = 0
        where   nr_lote_contabil        = nr_lote_contabil_p;
        commit;

        update  repasse_terceiro_venc a
        set     a.nr_lote_contabil      = 0
        where   a.nr_lote_contabil      = nr_lote_contabil_p;
        commit;
else
        select  nr_seq_trans_repasse,
                nr_seq_trans_glosa_rep,
                nr_seq_trans_maior_rep,
                ie_cc_rep_maior_glosa,
                ie_cc_repasse,
                ie_dt_contab_tit_repasse,
                ie_dt_movto_contab_tit_rep,
                ie_dt_tit_trib_orig,
                coalesce(ie_contab_item_tit_rep,'N'),
                coalesce(ie_contab_item_rep_liq,'N'),
                coalesce(ie_contab_tit_rep_desdob,'S'),
                coalesce(ie_periodo_contab_tit_rep,'M'),
                coalesce(ie_contab_trib_repasse_cc,'N'),
                coalesce(ie_contab_repasse_venc,'N'),
                coalesce(ie_rep_contab_vl_liberado,'N'),
                coalesce(ie_contab_classif_tit_rep, 'N')
        into STRICT    nr_seq_trans_rep_w,
                nr_seq_trans_glosa_w,
                nr_seq_trans_maior_w,
                ie_cc_rep_maior_glosa_w,
                ie_cc_repasse_w,
                ie_dt_contab_tit_repasse_w,
                ie_dt_movto_contab_tit_rep_w,
                ie_dt_tit_trib_orig_w,
                ie_contab_item_tit_rep_w,
                ie_contab_item_rep_liq_w,
                ie_contab_tit_rep_desdob_w,
                ie_periodo_contab_tit_rep_w,
                ie_contab_trib_repasse_cc_w,
                ie_contab_repasse_venc_w,
                ie_rep_contab_vl_liberado_w,
                ie_contab_classif_tit_rep_w
        from    parametros_contas_pagar
        where   cd_estabelecimento      = cd_estabelecimento_w;

        --Obter_Valor_Dinamico('Truncate Table W_Movimento_Contabil', vl_retorno_w);
        delete  FROM w_movimento_contabil
        where   nr_lote_contabil = nr_lote_contabil_p;
        commit;

        if (ie_periodo_contab_tit_rep_w = 'M') then
                dt_inicial_w    := trunc(dt_contabil_w,'mm');
                dt_final_w      := fim_mes(dt_contabil_w);

                update  titulo_pagar
                set     nr_lote_contabil                = nr_lote_contabil_p
                where   coalesce(nr_lote_contabil,0)         = 0
                and     cd_estabelecimento              = cd_estabelecimento_w
                and     (nr_repasse_terceiro IS NOT NULL AND nr_repasse_terceiro::text <> '')
                and     CASE WHEN  ie_dt_contab_tit_repasse_w='V' THEN     dt_vencimento_atual WHEN  ie_dt_contab_tit_repasse_w='E' THEN     dt_emissao WHEN  ie_dt_contab_tit_repasse_w='O' THEN     dt_vencimento_original  ELSE dt_contabil END     between dt_inicial_w and dt_final_w
                and     ((ie_contab_tit_rep_desdob_w = 'S') or (substr(obter_se_tit_pagar_desdob(nr_titulo),1,1) = 'N'));
                commit;
        elsif (ie_periodo_contab_tit_rep_w = 'D') then
                dt_inicial_w    := trunc(dt_contabil_w,'mm');
                dt_final_w      := fim_dia(dt_contabil_w);

                update  titulo_pagar
                set     nr_lote_contabil                = nr_lote_contabil_p
                where   coalesce(nr_lote_contabil,0)         = 0
                and     cd_estabelecimento              = cd_estabelecimento_w
                and     (nr_repasse_terceiro IS NOT NULL AND nr_repasse_terceiro::text <> '')
                and     CASE WHEN ie_dt_contab_tit_repasse_w='V' THEN     dt_vencimento_atual WHEN ie_dt_contab_tit_repasse_w='E' THEN     dt_emissao WHEN ie_dt_contab_tit_repasse_w='O' THEN     dt_vencimento_original  ELSE dt_contabil END  between dt_inicial_w and dt_final_w
                and     ((ie_contab_tit_rep_desdob_w = 'S') or (substr(obter_se_tit_pagar_desdob(nr_titulo),1,1) = 'N'));
                commit;
        end if;

        if (ie_dt_tit_trib_orig_w = 'S') then
                update  titulo_pagar a
                set     a.nr_lote_contabil              = nr_lote_contabil_p
                where   a.nr_lote_contabil              = 0
                and     a.cd_estabelecimento    = cd_estabelecimento_w
                and     (a.nr_repasse_terceiro IS NOT NULL AND a.nr_repasse_terceiro::text <> '')
                and     (a.nr_seq_tributo IS NOT NULL AND a.nr_seq_tributo::text <> '')
                and     exists (SELECT 1
                                from    titulo_pagar y,
                                        titulo_pagar_imposto x
                                where   x.nr_sequencia  = a.nr_seq_tributo
                                and     x.nr_titulo     = y.nr_titulo
                                and     CASE WHEN ie_dt_contab_tit_repasse_w='V' THEN                                                trunc(y.dt_vencimento_atual,'month') WHEN ie_dt_contab_tit_repasse_w='E' THEN                                                 trunc(y.dt_emissao,'month') WHEN ie_dt_contab_tit_repasse_w='O' THEN                                                 trunc(dt_vencimento_original,'month')  ELSE trunc(y.dt_contabil,'month') END  = trunc(dt_contabil_w, 'month'));
                commit;
        end if;

        update  material_repasse a
        set     a.dt_contabil_titulo            = dt_contabil_w
        where   exists ( SELECT  1
                        from    titulo_pagar t
                        where   t.nr_repasse_terceiro   = a.nr_repasse_terceiro
                        and     t.nr_lote_contabil      = nr_lote_contabil_p);
        commit;

        update  procedimento_repasse a
        set     a.dt_contabil_titulo            = dt_contabil_w
        where   exists ( SELECT  1
                        from    titulo_pagar t
                        where   t.nr_repasse_terceiro   = a.nr_repasse_terceiro
                        and     t.nr_lote_contabil      = nr_lote_contabil_p);
        commit;

        if (ie_contab_repasse_venc_w = 'S') then

                update  repasse_terceiro_venc a
                set     a.nr_lote_contabil              = nr_lote_contabil_p
                where   coalesce(a.nr_lote_contabil,0)       = 0
                and     exists ( SELECT  1
                                from    titulo_pagar y
                                where   y.nr_titulo             = a.nr_titulo
                                and     y.nr_lote_contabil      = nr_lote_contabil_p);
                commit;

        end if;

        update repasse_terceiro_item a
        set     nr_lote_contabil                = nr_lote_contabil_p
        where   nr_repasse_terceiro in (SELECT nr_repasse_terceiro
                from    titulo_pagar
                where   nr_lote_contabil        = nr_lote_contabil_p)
        and     coalesce(nr_lote_contabil,0)         = 0;
        commit;

        nm_agrupador_w  := coalesce(trim(both obter_agrupador_contabil(16)),'NR_TITULO');

        /* Agrupar por centro de custo. */

        if (ie_cc_repasse_w = 'S') then

            open cTituloPagar;
            loop
            fetch cTituloPagar into
                    nr_titulo_w,
                    vl_transacao_w,
                    cd_pessoa_fisica_w,
                    cd_cgc_w,
                    nr_seq_trans_fin_w,
                    ds_observacao_w,
                    dt_contabil_tit_w,
                    nr_repasse_terceiro_w,
                    nr_rep_terc_item_w,
                    nr_seq_tab_orig_w,
                    nr_seq_tab_compl_w,
                    nr_seq_info_ctb_w,
                    vl_repasse_liberado_w,
                    vl_repasse_liberado_item_w;
            EXIT WHEN NOT FOUND; /* apply on cTituloPagar */
                begin
                    ds_notas_fiscais_w      := null;
                    dt_emissao_w            := null;
                    ds_lancamento_w         := null;
                    nr_seq_rpa_w            := null;
                    nr_documento_mov_w      := null;
                    ie_origem_doc_w         := 1;

                    open c03;
                    loop
                    fetch c03 into
                            nr_nota_fiscal_w;
                    EXIT WHEN NOT FOUND; /* apply on c03 */
                            ds_notas_fiscais_w      := substr(nr_nota_fiscal_w || ', ' || ds_notas_fiscais_w,1,255);
                    end loop;
                    close c03;

                    if (ds_notas_fiscais_w IS NOT NULL AND ds_notas_fiscais_w::text <> '') then
                            ds_notas_fiscais_w := substr(ds_notas_fiscais_w ,1,instr(ds_notas_fiscais_w,',',-1)-1);
                    end if;

                    if (coalesce(nr_titulo_w,0) <> 0) then
                            select  max(nr_documento)
                            into STRICT    nr_documento_ww
                            from    titulo_pagar
                            where   nr_titulo = nr_titulo_w;

                            nr_documento_mov_w      := substr(obter_dados_tit_pagar(nr_titulo_w, 'NFSEQ'),1,10);
                    end if;

                    nr_documento_w          := nr_titulo_w;

                    if (ds_observacao_w IS NOT NULL AND ds_observacao_w::text <> '') then
                            nr_documento_w  := ds_observacao_w;
                    end if;

                    if (nm_agrupador_w = 'NR_TITULO')then
                               nr_seq_agrupamento_w := nr_titulo_w;
                    elsif (nm_agrupador_w = 'NR_REPASSE_TERCEIRO')then
                               nr_seq_agrupamento_w := nr_repasse_terceiro_w;
                    end if;

                    if (coalesce(nr_seq_agrupamento_w,0) = 0)and (nm_atributo_w  <> 'VL_ITEM_REPASSE')then
                            nr_seq_agrupamento_w    := nr_titulo_w;
                    else
                            nr_seq_agrupamento_w    := nr_repasse_terceiro_w;
                    end if;

                    ds_conteudo_w           := '';

                    if (ie_compl_hist_w = 'S') then

                        nr_titulo_original_w            := '';
                        if (coalesce(nr_titulo_w,0) > 0) then
                                select  max(nm_pessoa),
                                        max(a.nr_titulo_original),
                                        max(trunc(a.dt_emissao)),
                                        max(a.nr_seq_rpa)
                                into STRICT    ds_pessoa_repasse_w,
                                        nr_titulo_original_w,
                                        dt_emissao_w,
                                        nr_seq_rpa_w
                                from    terceiro_v c,
                                        repasse_terceiro b,
                                        titulo_pagar a
                                where   a.nr_repasse_terceiro   = b.nr_repasse_terceiro
                                and     b.nr_seq_terceiro       = c.nr_sequencia
                                and     a.nr_titulo             = nr_titulo_w;
                        end if;
                        if (nm_atributo_w = 'VL_ITEM_REPASSE') and (nr_titulo_w = 0) then
                                select  max(nr_titulo)
                                into STRICT    nr_titulo_w
                                from    titulo_pagar
                                where   nr_repasse_terceiro = nr_repasse_terceiro_w;
                        end if;

                        if (nm_atributo_w = 'VL_ITEM_REPASSE') then
                                select  to_char(max(a.dt_lancamento),'MM/YYYY')
                                into STRICT    ds_lancamento_w
                                from    repasse_terceiro_item a
                                where   nr_repasse_terceiro     = nr_repasse_terceiro_w
                                and     nr_sequencia            = nr_rep_terc_item_w;
                        end if;
                        /* Somente titulo do repasse*/

                        nr_titulo_repasse_w     := substr(obter_titulo_repasse_orig(nr_repasse_terceiro_w),1,80);

                        ds_pessoa_titulo_w      := substr(obter_nome_pf_pj(cd_pessoa_fisica_w, cd_cgc_w),1,80);

                        ds_observacao_w := rtrim(ds_observacao_w);
                        ds_observacao_w := substr(ds_observacao_w,1,255);

                        cd_convenio_w   := null;
                        ds_convenio_w   := '';
                        nm_paciente_w   := '';

                    end if;

                    /* Francisco - OS 49512 - 22/02/07 - Gerar movimento com a data do titulo */

                    if (coalesce(ie_dt_movto_contab_tit_rep_w,'L') = 'T') then
                            dt_contabil_w   := dt_contabil_tit_w;
                    end if;

                    if (coalesce(nr_documento_mov_w, '0') = '0') then
                            nr_documento_mov_w      := nr_titulo_w;
                            ie_origem_doc_w         := 2;
                    end if;

                    open cLancamento;
                    loop
                    fetch cLancamento into
                        nm_tabela_w,
                        nm_atributo_w,
                        cd_centro_custo_w,
                        vl_transacao_w,
                        cd_setor_atendimento_w,
                        cd_conta_contabil_w,
                        cd_tributo_w,
                        nr_registro_desc_w,
                        nr_atendimento_w;
                    EXIT WHEN NOT FOUND; /* apply on cLancamento */
                        begin

                        if (ie_compl_hist_w = 'S') then
                            if (nr_atendimento_w <> 0) then
                                    cd_convenio_w   := obter_convenio_atendimento(nr_atendimento_w);

                                    if (coalesce(cd_convenio_w, 0) <> 0) then
                                            ds_convenio_w   := substr(obter_nome_convenio(cd_convenio_w),1,255);
                                    end if;
                                    nm_paciente_w   := substr(obter_pessoa_atendimento(nr_atendimento_w, 'N'),1,60);
                            end if;

                            ds_conteudo_w   := substr(nr_titulo_w                   || '#@' ||
                                                    ds_observacao_w                 || '#@' ||
                                                    ds_pessoa_titulo_w              || '#@' ||
                                                    ds_pessoa_repasse_w             || '#@' ||
                                                    nr_repasse_terceiro_w           || '#@' ||
                                                    ds_notas_fiscais_w              || '#@' ||
                                                    nr_titulo_original_w            || '#@' ||
                                                    dt_emissao_w                    || '#@' ||
                                                    ds_lancamento_w                 || '#@' ||
                                                    nr_titulo_repasse_w             || '#@' ||
                                                    nr_atendimento_w                || '#@' ||
                                                    nm_paciente_w                   || '#@' ||
                                                    cd_convenio_w                   || '#@' ||
                                                    ds_convenio_w                   || '#@' ||
                                                    nr_seq_rpa_w                    || '#@' ||
                                                    nr_documento_ww, 1, 4000);
                        end if;

                        nr_seq_movto_w := gerar_contab_trans_financ(
                            cd_estabelecimento_w, null, nr_lote_contabil_p, nm_usuario_p, cd_conta_contabil_w, cd_centro_custo_w, nr_documento_w, nr_seq_agrupamento_w, dt_contabil_w, vl_transacao_w, nr_seq_trans_fin_w, '', nm_atributo_w, cd_pessoa_fisica_w, cd_cgc_w, cd_setor_atendimento_w, '', nr_documento_mov_w, null, ds_conteudo_w, null, null, null, cd_tributo_w, nr_titulo_w, null, cd_tributo_w, null, null, null, nr_repasse_terceiro_w, null, null, null, nr_seq_movto_w, nm_tabela_w, null, ie_origem_doc_w, 2, nr_seq_tab_orig_w, nr_seq_tab_compl_w, nr_seq_info_ctb_w);

                        qt_insert_w := qt_insert_w+1;
                        if (qt_insert_w >= 1000) then
                                commit;
                                qt_insert_w := 0;
                        end if;

                        end;
                    end loop;
                    close cLancamento;
                end;
            end loop;
            close cTituloPagar;

        else

            open c010;
            loop
            fetch c010 into
                    nr_titulo_w,
                    vl_transacao_w,
                    cd_pessoa_fisica_w,
                    cd_cgc_w,
                    nm_atributo_w,
                    nr_seq_trans_fin_w,
                    ds_observacao_w,
                    dt_contabil_tit_w,
                    nr_repasse_terceiro_w,
                    nr_rep_terc_item_w,
                    nr_seq_proc_repasse_w,
                    nr_seq_mat_repasse_w,
                    nr_atendimento_w,
                    cd_tributo_w,
                    cd_conta_contabil_w,
                    nm_tabela_w,
                    nr_seq_tab_orig_w,
                    nr_seq_tab_compl_w,
                    nr_seq_info_ctb_w;
            EXIT WHEN NOT FOUND; /* apply on c010 */
                    begin
                    ds_notas_fiscais_w      := null;
                    dt_emissao_w            := null;
                    ds_lancamento_w         := '';
                    nr_seq_rpa_w            := null;
                    nr_documento_mov_w      := null;
                    ie_origem_doc_w         := 1;

                    open c03;
                    loop
                    fetch c03 into
                            nr_nota_fiscal_w;
                    EXIT WHEN NOT FOUND; /* apply on c03 */
                            ds_notas_fiscais_w      := substr(nr_nota_fiscal_w || ', ' || ds_notas_fiscais_w,1,255);
                    end loop;
                    close c03;

                    if (ds_notas_fiscais_w IS NOT NULL AND ds_notas_fiscais_w::text <> '') then
                            ds_notas_fiscais_w := substr(ds_notas_fiscais_w ,1,instr(ds_notas_fiscais_w,',',-1)-1);
                    end if;

                    if (coalesce(nr_titulo_w,0) <> 0) then
                            select  max(nr_documento)
                            into STRICT    nr_documento_ww
                            from    titulo_pagar
                            where   nr_titulo = nr_titulo_w;

                            nr_documento_mov_w      := substr(obter_dados_tit_pagar(nr_titulo_w, 'NFSEQ'),1,10);

                    end if;

                    nr_documento_w          := nr_titulo_w;

                    if (ds_observacao_w IS NOT NULL AND ds_observacao_w::text <> '') then
                            nr_documento_w  := ds_observacao_w;
                    end if;

                    if (nm_agrupador_w = 'NR_TITULO')then
                               nr_seq_agrupamento_w := nr_titulo_w;
                    elsif (nm_agrupador_w = 'NR_REPASSE_TERCEIRO')then
                               nr_seq_agrupamento_w := nr_repasse_terceiro_w;
                    end if;

                    if (coalesce(nr_seq_agrupamento_w,0) = 0)and (nm_atributo_w  <> 'VL_ITEM_REPASSE')then
                            nr_seq_agrupamento_w    := nr_titulo_w;
                    else
                            nr_seq_agrupamento_w    := nr_repasse_terceiro_w;
                    end if;

                    ds_conteudo_w           := '';

                    if (ie_compl_hist_w = 'S') then

                            nr_titulo_original_w            := '';
                            if (coalesce(nr_titulo_w,0) > 0) then
                                    select  max(nm_pessoa),
                                            max(a.nr_titulo_original),
                                            max(trunc(a.dt_emissao)),
                                            max(a.nr_seq_rpa)
                                    into STRICT    ds_pessoa_repasse_w,
                                            nr_titulo_original_w,
                                            dt_emissao_w,
                                            nr_seq_rpa_w
                                    from    terceiro_v c,
                                            repasse_terceiro b,
                                            titulo_pagar a
                                    where   a.nr_repasse_terceiro   = b.nr_repasse_terceiro
                                    and     b.nr_seq_terceiro       = c.nr_sequencia
                                    and     a.nr_titulo             = nr_titulo_w;
                            end if;
                            if (nm_atributo_w = 'VL_ITEM_REPASSE') and (nr_titulo_w = 0) then
                                    select  max(nr_titulo)
                                    into STRICT    nr_titulo_w
                                    from    titulo_pagar
                                    where   nr_repasse_terceiro = nr_repasse_terceiro_w;
                            end if;

                            if (nm_atributo_w = 'VL_ITEM_REPASSE') then
                                    select  to_char(max(a.dt_lancamento),'MM/YYYY')
                                    into STRICT    ds_lancamento_w
                                    from    repasse_terceiro_item a
                                    where   nr_repasse_terceiro     = nr_repasse_terceiro_w
                                    and     nr_sequencia            = nr_rep_terc_item_w;
                            end if;
                            /* Somente titulo do repasse*/

                            nr_titulo_repasse_w     := substr(obter_titulo_repasse_orig(nr_repasse_terceiro_w),1,80);

                            ds_pessoa_titulo_w      := substr(obter_nome_pf_pj(cd_pessoa_fisica_w, cd_cgc_w),1,80);

                            ds_observacao_w := rtrim(ds_observacao_w);
                            ds_observacao_w := substr(ds_observacao_w,1,255);

                            cd_convenio_w   := null;
                            ds_convenio_w   := '';
                            nm_paciente_w   := '';

                            if (nr_atendimento_w <> 0) then
                                    cd_convenio_w   := obter_convenio_atendimento(nr_atendimento_w);

                                    if (coalesce(cd_convenio_w, 0) <> 0) then
                                            ds_convenio_w   := substr(obter_nome_convenio(cd_convenio_w),1,255);
                                    end if;
                                    nm_paciente_w   := substr(obter_pessoa_atendimento(nr_atendimento_w, 'N'),1,60);
                            end if;

                            ds_conteudo_w   := substr(nr_titulo_w                   || '#@' ||
                                                    ds_observacao_w                 || '#@' ||
                                                    ds_pessoa_titulo_w              || '#@' ||
                                                    ds_pessoa_repasse_w             || '#@' ||
                                                    nr_repasse_terceiro_w           || '#@' ||
                                                    ds_notas_fiscais_w              || '#@' ||
                                                    nr_titulo_original_w            || '#@' ||
                                                    dt_emissao_w                    || '#@' ||
                                                    ds_lancamento_w                 || '#@' ||
                                                    nr_titulo_repasse_w             || '#@' ||
                                                    nr_atendimento_w                || '#@' ||
                                                    nm_paciente_w                   || '#@' ||
                                                    cd_convenio_w                   || '#@' ||
                                                    ds_convenio_w                   || '#@' ||
                                                    nr_seq_rpa_w                    || '#@' ||
                                                    nr_documento_ww, 1, 4000);
                    end if;

                    /* Francisco - OS 49512 - 22/02/07 - Gerar movimento com a data do titulo */

                    if (coalesce(ie_dt_movto_contab_tit_rep_w,'L') = 'T') then
                            dt_contabil_w   := dt_contabil_tit_w;
                    end if;

                    if (coalesce(nr_documento_mov_w, '0') = '0') then
                            nr_documento_mov_w      := nr_titulo_w;
                            ie_origem_doc_w         := 2;
                    end if;

                    if      ((ie_contab_trib_repasse_cc_w = 'S' AND nm_atributo_w = 'VL_TRIBUTO_REPASSE') or (nm_atributo_w <> 'VL_TRIBUTO_REPASSE')) and
                            (((ie_cc_rep_maior_glosa_w = 'S') and (nm_atributo_w in ('VL_GLOSA_REPASSE','VL_MAIOR_REPASSE'))) or (ie_cc_repasse_w = 'S')) and (vl_transacao_w <> 0) then

                            if (nm_atributo_w <> 'VL_ITEM_REPASSE') then

                                    select  coalesce(max(nr_repasse_terceiro),0)
                                    into STRICT    nr_repasse_terceiro_w
                                    from    titulo_pagar
                                    where   nr_titulo       = nr_titulo_w;
                            end if;

                                vl_repasse_liberado_w           := coalesce(obter_valor_repasse(nr_repasse_terceiro_w, 'LI'),0);
                                vl_repasse_liberado_item_w      := coalesce(obter_valor_repasse(nr_repasse_terceiro_w, 'RI'),0);
                                pr_desdobramento_w := 0;

                            if (nm_atributo_w in ('VL_TITULO_REPASSE','VL_ITEM_REPASSE')) and (ie_contab_item_rep_liq_w = 'S') then

                                    select  coalesce(sum(a.vl_repasse),0)
                                    into STRICT    vl_total_itens_repasse_w
                                    from    repasse_terceiro_item a,
                                            titulo_pagar b
                                    where   a.nr_repasse_terceiro   = b.nr_repasse_terceiro
                                    and     b.nr_repasse_terceiro   = nr_repasse_terceiro_w
                                    and     b.nr_titulo             = nr_titulo_w;

                                    vl_total_repasse_w              := coalesce(obter_valor_repasse(nr_repasse_terceiro_w,'R'),0);
                                    vl_total_repasse_liq_w          := coalesce(obter_valor_repasse(nr_repasse_terceiro_w,'I'),0);
                                    pr_item_repasse_w               := dividir(vl_total_itens_repasse_w, vl_total_repasse_w) * 100;
                                    vl_total_itens_repasse_liq_w    := coalesce(dividir((vl_total_repasse_liq_w * pr_item_repasse_w),100),0);

                            end if;

                            if (coalesce(nr_titulo_original_w,0) <> 0) and (nm_atributo_w = 'VL_GLOSA_REPASSE') then

                                    select  coalesce(sum(vl_titulo),0)
                                    into STRICT    vl_total_titulo_rep_w
                                    from    titulo_pagar a
                                    where   nr_lote_contabil        = nr_lote_contabil_p
                                    and     coalesce(nr_seq_tributo::text, '') = ''
                                    and     obter_valor_repasse(nr_repasse_terceiro,'G') <> 0
                                    and     a.ie_situacao <> 'D'
                                    and     a.nr_repasse_terceiro   = nr_repasse_terceiro_w;

                                    select  coalesce(max(vl_titulo),0)
                                    into STRICT    vl_titulo_w
                                    from    titulo_pagar
                                    where   nr_titulo       = nr_titulo_w;

                                    vl_glosa_repasse_w      := coalesce(obter_glosa_procmat_rep(nr_titulo_w),0);
                                    pr_desdobramento_w      := coalesce(dividir(vl_titulo_w * 100,vl_total_titulo_rep_w),0);
                            end if;

                            vl_soma_transacao_w := 0;
                            if (nm_atributo_w = 'VL_REPASSE_VENC') then
                                vl_transacao_orig_w := vl_transacao_w + obter_valor_tot_trib_inf(nr_titulo_w);
                            elsif ((nm_atributo_w ='VL_REPASSE_PROC') or (nm_atributo_w = 'VL_REPASSE_MAT')) then
                                vl_transacao_orig_w := vl_transacao_w;
                            end if;

                            open c020;
                            loop
                            fetch c020 into
                                    ie_valor_w,
                                    cd_centro_custo_w,
                                    vl_transacao_w,
                                    cd_setor_atendimento_w,
                                    nr_registro_desc_w;
                            EXIT WHEN NOT FOUND; /* apply on c020 */
                                    if (vl_transacao_w <> 0) then

                                            if (pr_desdobramento_w <> 0) then
                                                    vl_transacao_w  := dividir((vl_transacao_w * pr_desdobramento_w),100);
                                            end if;

                                            if (ie_valor_w = 'I') and (ie_contab_item_rep_liq_w = 'S') and (nm_atributo_w <> 'VL_REPASSE_VENC') then

                                                    pr_desdobramento_w      := coalesce((dividir(vl_transacao_w, vl_total_itens_repasse_w) * 100),0);
                                                    vl_transacao_w          := coalesce(dividir((vl_total_itens_repasse_liq_w * pr_desdobramento_w),100),0);
                                            end if;

                                            if (nm_atributo_w = 'VL_REPASSE_VENC') and (nr_registro_desc_w = 1) and
                                                ((vl_soma_transacao_w + vl_transacao_w) <> vl_transacao_orig_w) then
                                                vl_transacao_w := vl_transacao_orig_w - vl_soma_transacao_w;
                                            end if;
                                            vl_soma_transacao_w := vl_soma_transacao_w + vl_transacao_w;

                                            nr_seq_movto_w := gerar_contab_trans_financ(
                                            cd_estabelecimento_w, null, nr_lote_contabil_p, nm_usuario_p, cd_conta_contabil_w, cd_centro_custo_w, nr_documento_w, nr_seq_agrupamento_w, dt_contabil_w, vl_transacao_w, nr_seq_trans_fin_w, '', nm_atributo_w, cd_pessoa_fisica_w, cd_cgc_w, cd_setor_atendimento_w, '', nr_documento_mov_w, null, ds_conteudo_w, null, null, null, null, nr_titulo_w, null, cd_tributo_w, null, null, null, nr_repasse_terceiro_w, null, null, null, nr_seq_movto_w, nm_tabela_w, null, ie_origem_doc_w, 2, nr_seq_tab_orig_w, nr_seq_tab_compl_w, nr_seq_info_ctb_w);

                                            qt_insert_w := qt_insert_w+1;
                                            if (qt_insert_w >= 1000) then
                                                    commit;
                                                    qt_insert_w := 0;
                                            end if;
                                    end if;
                            end loop;
                            close c020;
                    else
                            nr_seq_movto_w := gerar_contab_trans_financ(
                                    cd_estabelecimento_w, null, nr_lote_contabil_p, nm_usuario_p, cd_conta_contabil_w, 0, nr_documento_w, nr_seq_agrupamento_w, dt_contabil_w, vl_transacao_w, nr_seq_trans_fin_w, '', nm_atributo_w, cd_pessoa_fisica_w, cd_cgc_w, '', '', nr_documento_mov_w, null, ds_conteudo_w, null, null, null, cd_tributo_w, nr_titulo_w, null, cd_tributo_w, null, null, null, nr_repasse_terceiro_w, null, null, null, nr_seq_movto_w, nm_tabela_w, null, ie_origem_doc_w, 2, nr_seq_tab_orig_w, nr_seq_tab_compl_w, nr_seq_info_ctb_w);

                            qt_insert_w := qt_insert_w+1;
                            if (qt_insert_w >= 1000) then
                                    commit;
                                    qt_insert_w := 0;
                            end if;
                    end if;
                    exception
                    when others then
                            CALL wheb_mensagem_pck.exibir_mensagem_abort(182518,'DS_ERRO_W=' || sqlerrm);
                            --raise_application_error(-20011, sqlerrm);
                    end;
            end loop;
            close c010;
        end if;
        CALL agrupa_movimento_contabil(nr_lote_contabil_p, nm_usuario_p);
        commit;
end if;

if (coalesce(ds_retorno_p::text, '') = '') then

        update  lote_contabil
        set             ie_situacao     = 'A',
                        dt_geracao_lote = clock_timestamp()
        where   nr_lote_contabil = nr_lote_contabil_p;
        commit;

        if (ie_exclusao_p = 'S') then
                        ds_retorno_p            := substr(wheb_mensagem_pck.get_texto(299468),1,255); --Exclusao do Lote Ok
                        CALL ctb_gravar_log_lote( nr_lote_contabil_p, 2, '', nm_usuario_p);
        else
                        ds_retorno_p            := substr(wheb_mensagem_pck.get_texto(299469),1,255); --Geracao do Lote Ok
                        CALL ctb_gravar_log_lote( nr_lote_contabil_p, 1, '', nm_usuario_p);
        end if;
        commit;
else
        rollback;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE contabiliza_titulo_repasse ( nr_lote_contabil_p bigint, nm_usuario_p text, ie_exclusao_p text, ds_retorno_p INOUT text) FROM PUBLIC;

