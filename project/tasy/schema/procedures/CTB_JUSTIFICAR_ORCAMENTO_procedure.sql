-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE ctb_justificar_orcamento ( cd_empresa_p bigint, cd_estab_p bigint, nr_sequencia_p bigint, nr_seq_mes_ref_p bigint, cd_centro_custo_p bigint, cd_conta_contabil_p text, ds_justificativa_p text, ie_liberar_p text, nm_usuario_p text, ie_justif_centro_usuario_p text) AS $body$
DECLARE


cd_estabelecimento_w		bigint;
nr_sequencia_w			bigint	:= nr_sequencia_p;
nr_seq_mes_ref_w		bigint;
cd_conta_contabil_w		varchar(20);
sep_w				varchar(1) := '#';

/* Orçamentos da conta no mes no estabelecimento e no centro de custo */

c01 CURSOR FOR
SELECT	a.nr_sequencia,
	a.cd_estabelecimento
from	estabelecimento b,
	ctb_orcamento a
where	a.cd_estabelecimento	= b.cd_estabelecimento
and	a.nr_seq_mes_ref		= nr_seq_mes_ref_p
and	a.cd_centro_custo		= cd_centro_custo_p
and	a.cd_conta_contabil	= cd_conta_contabil_p
and	b.cd_empresa		= cd_empresa_p
and	b.cd_estabelecimento	= coalesce(cd_estab_p,b.cd_estabelecimento)
and	coalesce(a.dt_liberacao::text, '') = '';

c02 CURSOR FOR
SELECT	a.nr_sequencia,
	a.cd_estabelecimento
from	estabelecimento b,
	ctb_orcamento a
where	a.cd_estabelecimento	= b.cd_estabelecimento
and	a.nr_seq_mes_ref	= nr_seq_mes_ref_w
and	substr(ctb_Obter_se_centro_usuario(a.cd_centro_custo, cd_empresa_p, nm_usuario_p),1,1) = 'S'
and	a.cd_conta_contabil	= cd_conta_contabil_w
and	b.cd_empresa		= cd_empresa_p
and	b.cd_estabelecimento	= coalesce(cd_estab_p,b.cd_estabelecimento)
and	coalesce(a.dt_liberacao::text, '') = '';


BEGIN

nr_sequencia_w	:= coalesce(nr_sequencia_p,0);

if (nr_sequencia_w <> 0) then
	/* Justificativa pela pasta Orçamento - Digitação manual*/

	update	ctb_orcamento
	set	ds_justificativa	= ds_justificativa_p,
		nm_usuario		= nm_usuario_p,
		dt_atualizacao		= clock_timestamp(),
		nm_usuario_jus		= nm_usuario_p,
		dt_atualizacao_jus	= clock_timestamp()
	where	nr_sequencia	= nr_sequencia_w;

else
	open C01;
	loop
	fetch C01 into
		nr_sequencia_w,
		cd_estabelecimento_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin

		update	ctb_orcamento
		set	ds_justificativa	= ds_justificativa_p,
			nm_usuario		= nm_usuario_p,
			dt_atualizacao		= clock_timestamp(),
			nm_usuario_jus		= nm_usuario_p,
			dt_atualizacao_jus	= clock_timestamp()
		where	nr_sequencia	= nr_sequencia_w;

		if (ie_liberar_p = 'S') then
			CALL ctb_liberar_orcamento(cd_empresa_p, cd_estabelecimento_w, nr_sequencia_w, 'L', nm_usuario_p);
		end if;
		end;
	end loop;
	close C01;
end if;

if (ie_justif_centro_usuario_p = 'S') then
	nr_seq_mes_ref_w	:= nr_seq_mes_ref_p;
	cd_conta_contabil_w	:= cd_conta_contabil_p;

	if (nr_sequencia_w <> 0) then

		select	nr_seq_mes_ref,
			cd_conta_contabil
		into STRICT	nr_seq_mes_ref_w,
			cd_conta_contabil_w
		from	ctb_orcamento
		where	nr_sequencia	 = nr_sequencia_w;
	end if;

	open c02;
	loop
	fetch c02 into
		nr_sequencia_w,
		cd_estabelecimento_w;
	EXIT WHEN NOT FOUND; /* apply on c02 */
		begin
		update ctb_orcamento
		set	ds_justificativa	= ds_justificativa_p,
			nm_usuario		= nm_usuario_p,
			dt_atualizacao		= clock_timestamp(),
			nm_usuario_jus		= nm_usuario_p,
			dt_atualizacao_jus	= clock_timestamp()
		where 	nr_sequencia		= nr_sequencia_w;

		if (ie_liberar_p = 'S') then
			CALL ctb_liberar_orcamento(cd_empresa_p, cd_estabelecimento_w, nr_sequencia_w, 'L', nm_usuario_p);
		end if;
		end;
	end loop;
	close c02;
end if;
commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ctb_justificar_orcamento ( cd_empresa_p bigint, cd_estab_p bigint, nr_sequencia_p bigint, nr_seq_mes_ref_p bigint, cd_centro_custo_p bigint, cd_conta_contabil_p text, ds_justificativa_p text, ie_liberar_p text, nm_usuario_p text, ie_justif_centro_usuario_p text) FROM PUBLIC;

