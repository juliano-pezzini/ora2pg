-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE atualizar_controle_qualidade ( nr_seq_lista_prod_p text, nr_seq_qualidade_p bigint, nm_usuario_p text) AS $body$
DECLARE



nr_seq_lista_w		varchar(255);
nr_pos_virgula_w	bigint;
nr_sequencia_w		bigint;
nr_seq_qual_prod_w	bigint;
nr_seq_derivado_w	bigint;
nr_seq_exame_w		bigint;


C01 CURSOR FOR
	SELECT 	nr_seq_exame
	FROM   	san_regra_exame_cont_item b,
		san_regra_exame_controle a
	WHERE  	a.nr_sequencia			= b.nr_seq_regra_exame
	AND	a.nr_seq_derivado		= nr_seq_derivado_w;



BEGIN
if (nr_seq_lista_prod_p IS NOT NULL AND nr_seq_lista_prod_p::text <> '')	then
	begin
	nr_seq_lista_w	:= nr_seq_lista_prod_p;
	while(nr_seq_lista_w IS NOT NULL AND nr_seq_lista_w::text <> '') loop
		begin
		nr_pos_virgula_w	:= position(',' in nr_seq_lista_w);
		if (nr_pos_virgula_w > 0)	then
			begin
			nr_sequencia_w	:= (substr(nr_seq_lista_w,1,nr_pos_virgula_w-1))::numeric;
			nr_seq_lista_w	:= substr(nr_seq_lista_w,nr_pos_virgula_w+1,length(nr_seq_lista_w));
			if (nr_sequencia_w > 0) then
				begin

				select	nextval('san_controle_qual_prod_seq')
				into STRICT	nr_seq_qual_prod_w
				;

				insert into	san_controle_qual_prod(
						nr_sequencia,
						dt_atualizacao,
						nm_usuario,
						dt_atualizacao_nrec,
						nm_usuario_nrec,
						nr_seq_producao,
						nr_seq_qualidade)
					values (nr_seq_qual_prod_w,
						clock_timestamp(),
						nm_usuario_p,
						clock_timestamp(),
						nm_usuario_p,
						nr_sequencia_w,
						nr_seq_qualidade_p);

				select	nr_seq_derivado
				into STRICT	nr_seq_derivado_w
				from	san_producao
				where	nr_sequencia = nr_sequencia_w;

				open C01;
				loop
				fetch C01 into
					nr_seq_exame_w;
				EXIT WHEN NOT FOUND; /* apply on C01 */
					begin

					insert	into	san_controle_qual_exame(
							nr_sequencia,
							dt_atualizacao,
							nm_usuario,
							dt_atualizacao_nrec,
							nm_usuario_nrec,
							nr_seq_exame,
							nr_seq_qual_prod )
						values (
							nextval('san_controle_qual_exame_seq'),
							clock_timestamp(),
							nm_usuario_p,
							clock_timestamp(),
							nm_usuario_p,
							nr_seq_exame_w,
							nr_seq_qual_prod_w);
					end;
				end loop;
				close C01;
				end;
			end if;
			end;
		else
			nr_seq_lista_w := null;
		end if;
		end;
	end loop;
	end;
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE atualizar_controle_qualidade ( nr_seq_lista_prod_p text, nr_seq_qualidade_p bigint, nm_usuario_p text) FROM PUBLIC;

