-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE definir_prescricao_nutricao_js ( ie_tipo_p text, ie_opcao_p text, nr_seq_serv_dia_p bigint, nr_prescricao_p bigint, nm_usuario_p text, ds_pergunta_p INOUT text) AS $body$
DECLARE


/*	ie_tipo_p
	T - Prescrições
	DO - Dieta Oral
	JE - Jejum
	SO - Suplemen/Modul/Pediat
	NE - Suporte Nutricional Enteral
	NA - NPT Adulta
	NN - NPT Neonatal
	NP - NPT Pediátrica
	LD - Leite e Derivados*/
/*	ie_opcao_p
	C - consistir dados
	E - executar
	D - Desfazer
	*/
nr_seq_serv_rep_w	bigint;
nr_prescricao_w	bigint;


BEGIN

select	coalesce(max(nr_sequencia), 0)
into STRICT	nr_seq_serv_rep_w
from	nut_atend_serv_dia_rep
where	nr_seq_serv_dia = nr_seq_serv_dia_p
and	coalesce(dt_liberacao::text, '') = '';

if (ie_opcao_p = 'C') then
	begin
	if (ie_tipo_p = 'DO') then
		begin
		select	coalesce(max(nr_prescr_oral), 0)
		into STRICT	nr_prescricao_w
		from	nut_atend_serv_dia_rep
		where	nr_sequencia = nr_seq_serv_rep_w;

		if (nr_prescricao_w > 0) then
			ds_pergunta_p	:= substr(obter_texto_tasy(69010, wheb_usuario_pck.get_nr_seq_idioma),1,255);
		end if;
		end;

	elsif (ie_tipo_p = 'JE') then
		begin
		select	coalesce(max(nr_prescr_jejum), 0)
		into STRICT	nr_prescricao_w
		from	nut_atend_serv_dia_rep
		where	nr_sequencia = nr_seq_serv_rep_w;

		if (nr_prescricao_w > 0) then
			ds_pergunta_p	:= substr(obter_texto_tasy(69012, wheb_usuario_pck.get_nr_seq_idioma),1,255);
		end if;
		end;

	elsif (ie_tipo_p = 'SO') then
		begin
		select	coalesce(max(nr_prescr_compl), 0)
		into STRICT	nr_prescricao_w
		from	nut_atend_serv_dia_rep
		where	nr_sequencia = nr_seq_serv_rep_w;

		if (nr_prescricao_w > 0) then
			ds_pergunta_p	:= substr(obter_texto_tasy(69016, wheb_usuario_pck.get_nr_seq_idioma),1,255);
		end if;
		end;

	elsif (ie_tipo_p = 'NE') then
		begin
		select	coalesce(max(nr_prescr_enteral), 0)
		into STRICT	nr_prescricao_w
		from	nut_atend_serv_dia_rep
		where	nr_sequencia = nr_seq_serv_rep_w;

		if (nr_prescricao_w > 0) then
			ds_pergunta_p	:= substr(obter_texto_tasy(69020, wheb_usuario_pck.get_nr_seq_idioma),1,255);
		end if;
		end;

	elsif (ie_tipo_p = 'NA') then
		begin
		select	coalesce(max(nr_prescr_npt_adulta), 0)
		into STRICT	nr_prescricao_w
		from	nut_atend_serv_dia_rep
		where	nr_sequencia = nr_seq_serv_rep_w;

		if (nr_prescricao_w > 0) then
			ds_pergunta_p	:= substr(obter_texto_tasy(69021, wheb_usuario_pck.get_nr_seq_idioma),1,255);
		end if;
		end;

	elsif (ie_tipo_p = 'NN') then
		begin
		select	coalesce(max(nr_prescr_npt_neo), 0)
		into STRICT	nr_prescricao_w
		from	nut_atend_serv_dia_rep
		where	nr_sequencia = nr_seq_serv_rep_w;

		if (nr_prescricao_w > 0) then
			ds_pergunta_p	:= substr(obter_texto_tasy(69021, wheb_usuario_pck.get_nr_seq_idioma),1,255);
		end if;
		end;

	elsif (ie_tipo_p = 'NP') then
		begin
		select	coalesce(max(nr_prescr_npt_ped), 0)
		into STRICT	nr_prescricao_w
		from	nut_atend_serv_dia_rep
		where	nr_sequencia = nr_seq_serv_rep_w;

		if (nr_prescricao_w > 0) then
			ds_pergunta_p	:= substr(obter_texto_tasy(69021, wheb_usuario_pck.get_nr_seq_idioma),1,255);
		end if;
		end;
	else if (ie_tipo_p = 'LD') then
		begin

		select	max(coalesce(nr_prescr_leite_deriv, 0))
		into STRICT	nr_prescricao_w
		from	nut_atend_serv_dia_rep
		where	nr_sequencia	= nr_seq_serv_rep_w;

		if (nr_prescricao_w > 0) then
			ds_pergunta_p	:= substr(obter_texto_tasy(91730, wheb_usuario_pck.get_nr_seq_idioma),1,255);
		end if;

		end;
	end if;
	end if;
	end;
end if;

if (ie_opcao_p = 'C') or (ie_opcao_p = 'E') then
	begin
	if (coalesce(ds_pergunta_p::text, '') = '') then
		begin
		CALL definir_prescricao_nutricao(
			nr_prescricao_p,
			nr_seq_serv_rep_w,
			nr_seq_serv_dia_p,
			ie_tipo_p,
			nm_usuario_p);
		end;
	end if;
	end;

elsif (ie_opcao_p = 'D') then
	begin
	CALL desfazer_prescricao_nutricao(
		nr_prescricao_p,
		nr_seq_serv_rep_w,
		nr_seq_serv_dia_p,
		ie_tipo_p,
		nm_usuario_p);
	end;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE definir_prescricao_nutricao_js ( ie_tipo_p text, ie_opcao_p text, nr_seq_serv_dia_p bigint, nr_prescricao_p bigint, nm_usuario_p text, ds_pergunta_p INOUT text) FROM PUBLIC;

