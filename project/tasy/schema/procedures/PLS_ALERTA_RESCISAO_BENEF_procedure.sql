-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_alerta_rescisao_benef ( ie_tipo_evento_p bigint, nr_seq_segurado_p bigint, nm_usuario_p text, ie_commit_p text) AS $body$
DECLARE


nr_seq_evento_mens_w		pls_regra_geracao_evento.nr_seq_evento_mens%type;
nr_sequencia_w			pls_regra_geracao_evento.nr_sequencia%type;
ie_tipo_envio_w			pls_alerta_evento_mensagem.ie_tipo_envio%type;
ds_titulo_w			pls_alerta_evento_mensagem.ds_titulo%type;
nr_seq_tipo_evento_w		pls_alerta_evento_mensagem.nr_seq_tipo_evento%type;
ie_forma_envio_w		pls_alerta_evento_destino.ie_forma_envio%type;
nr_seq_evento_dest_w		pls_alerta_evento_destino.nr_sequencia%type;
ie_tipo_pessoa_dest_w		pls_alerta_evento_destino.ie_tipo_pessoa_dest%type;
cd_estabelecimento_w		estabelecimento.cd_estabelecimento%type;
nr_seq_evento_controle_w	bigint	:= null;
nm_beneficiario_w		varchar(70);
cd_usuario_plano_w		varchar(30);
dt_rescisao_w			varchar(30)	:= null;
nm_usuario_destino_definit_w	varchar(4000);	
nm_usuarios_lista_w		varchar(4000);
ds_mensagem_regra_w		varchar(4000);
ds_remetente_w			varchar(255);
nr_pos_virgula_w		integer;
qt_macro_regra_w		integer;
nm_usuario_destino_w		varchar(15);
cd_pessoa_fisica_w		varchar(10);
nr_contrato_w			pls_contrato.nr_contrato%type;

ie_enviar_alerta_resc_benef_w	pls_contrato.ie_enviar_alerta_resc_benef%type;
nr_destinatario_w		varchar(20);
id_sms_enviado_w		bigint;
ds_remetente_sms_w		pls_alerta_evento_mensagem.ds_remetente_sms%type;
ds_remetente_email_w		pls_alerta_evento_mensagem.ds_remetente_email%type;
ds_email_destino_w		varchar(200);
ie_tipo_pessoa_w		varchar(2);

C01 CURSOR FOR
	SELECT 	nr_seq_evento_mens,
		nr_sequencia
	from	pls_regra_geracao_evento
	where	ie_situacao		= 'A'
	and	ie_evento_disparo	= ie_tipo_evento_p;

C02 CURSOR FOR
	SELECT	nr_sequencia,
		ie_forma_envio,
		ie_tipo_pessoa_dest
	from	pls_alerta_evento_destino
	where	nr_seq_evento_mens	= nr_seq_evento_mens_w
	and	ie_situacao		= 'A';

C07 CURSOR FOR
	SELECT	nm_usuario_destino
	from	pls_alerta_event_dest_fixo
	where	nr_seq_alerta_event_dest	= nr_seq_evento_dest_w;

procedure pls_enviar_sms_aux(	ds_remetente_pp			text,
				nr_destinatario_pp		text, 
				ds_mensagem_regra_pp		text,
				id_sms_p		out	bigint) is 
	 
id_sms_w			bigint;

BEGIN
id_sms_w := wheb_sms.enviar_sms(ds_remetente_pp, nr_destinatario_pp, ds_mensagem_regra_pp, nm_usuario_p, id_sms_w);

insert into	log_envio_sms(	nr_sequencia,dt_atualizacao,nm_usuario,
		dt_envio,nr_telefone,ds_mensagem,id_sms)
values (		nextval('log_envio_sms_seq'),clock_timestamp(),nm_usuario_p,
		clock_timestamp(),nr_destinatario_pp,ds_mensagem_regra_pp,id_sms_w);
id_sms_p	:= id_sms_w;
end;

procedure gerar_destino_evento(	nr_seq_evento_controle_p	Number,
			ie_status_envio_p		Varchar2,
			ie_forma_envio_p		Varchar2,
			nm_usuario_p			Varchar2,
			cd_pessoa_fisica_p		Varchar2,
			nm_usuario_destino_p		Varchar2,
			ds_mensagem_p			Varchar2,
			id_sms_p			Number,
			nr_telef_celular_p		Varchar2,
			ie_tipo_pessoa_dest_p		varchar2) is

dt_envio_msg_w		Date 		:= null;
nr_telef_celular_w	pls_alerta_evento_cont_des.nr_telef_celular%type;

begin
if (ie_status_envio_p = 'E') then
	dt_envio_msg_w 	:= clock_timestamp();
end if;

if (ie_forma_envio_p = 'SMS') then
	nr_telef_celular_w	:= nr_telef_celular_p;
else
	nr_telef_celular_w	:= null;
end if;

if (cd_pessoa_fisica_p IS NOT NULL AND cd_pessoa_fisica_p::text <> '') then
	insert into pls_alerta_evento_cont_des(
			nr_sequencia, nr_seq_evento_controle, ie_status_envio,
			ie_forma_envio, dt_atualizacao, nm_usuario,
			dt_atualizacao_nrec, nm_usuario_nrec, ie_tipo_pessoa_dest,
			dt_envio_mensagem, id_sms, nm_usuario_destino,
			cd_pessoa_fisica, ds_mensagem, nr_telef_celular)
		values (	nextval('pls_alerta_evento_cont_des_seq'), nr_seq_evento_controle_p, ie_status_envio_p,
			ie_forma_envio_p, clock_timestamp(), nm_usuario_p,
			clock_timestamp(), nm_usuario_p, ie_tipo_pessoa_dest_p,
			dt_envio_msg_w, id_sms_p, nm_usuario_destino_p,
			cd_pessoa_fisica_p, ds_mensagem_p, nr_telef_celular_w);
end if;

end;

begin

select	max(ds_remetente_sms)
into STRICT	ds_remetente_w
from	pls_parametros 	a,
	pls_segurado	b
where	a.cd_estabelecimento	= b.cd_estabelecimento
and	b.nr_sequencia 		= nr_seq_segurado_p;

select 	substr(pls_obter_dados_segurado(nr_seq_segurado_p, 'N'),1,70),
	substr(pls_obter_dados_segurado(nr_seq_segurado_p,'CR'),1,20),
	to_char(a.dt_rescisao,'dd/mm/yyyy') dt_rescisao,
	a.cd_estabelecimento,
	a.cd_pessoa_fisica,
	pls_obter_dados_contrato(a.nr_seq_contrato,'N'),
	coalesce(b.ie_enviar_alerta_resc_benef, 'S')
into STRICT	nm_beneficiario_w,
	cd_usuario_plano_w,
	dt_rescisao_w,
	cd_estabelecimento_w,
	cd_pessoa_fisica_w,
	nr_contrato_w,
	ie_enviar_alerta_resc_benef_w
from	pls_segurado a,
	pls_contrato b
where	a.nr_sequencia	= nr_seq_segurado_p
and	b.nr_sequencia	= a.nr_seq_contrato;

open C01;
loop
fetch C01 into
	nr_seq_evento_mens_w,
	nr_sequencia_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	begin
	select	ds_mensagem,
		ie_tipo_envio,
		ds_titulo,
		nr_seq_tipo_evento,
		ds_remetente_sms,
		ds_remetente_email
	into STRICT	ds_mensagem_regra_w,
		ie_tipo_envio_w,
		ds_titulo_w,
		nr_seq_tipo_evento_w,
		ds_remetente_sms_w,
		ds_remetente_email_w
	from	pls_alerta_evento_mensagem
	where	nr_sequencia	= nr_seq_evento_mens_w;
	exception
	when others then
		ds_mensagem_regra_w	:= null;
		ie_tipo_envio_w		:= null;
		ds_titulo_w		:= null;
		nr_seq_tipo_evento_w	:= null;
	end;

	select	count(1)
	into STRICT	qt_macro_regra_w
	
	where	ds_mensagem_regra_w like '%@%';
	
	if (qt_macro_regra_w > 0) then
		ds_mensagem_regra_w	:= replace_macro(ds_mensagem_regra_w, '@NM_BENEF', nm_beneficiario_w);
		ds_mensagem_regra_w	:= replace_macro(ds_mensagem_regra_w, '@CD_CART_BENEF', cd_usuario_plano_w);
		ds_mensagem_regra_w	:= replace_macro(ds_mensagem_regra_w, '@DT_RESCISAO', dt_rescisao_w);
		ds_mensagem_regra_w	:= replace_macro(ds_mensagem_regra_w, '@NR_CONTRATO', nr_contrato_w);
	end if;
	
	if (ie_tipo_envio_w = 'AE') then
		open C02;
		loop
		fetch C02 into
			nr_seq_evento_dest_w,
			ie_forma_envio_w,
			ie_tipo_pessoa_dest_w;
		EXIT WHEN NOT FOUND; /* apply on C02 */
			begin
			id_sms_enviado_w	:= null;
			
			if (coalesce(nr_seq_evento_controle_w::text, '') = '') then
				select	nextval('pls_alerta_evento_controle_seq')
				into STRICT	nr_seq_evento_controle_w
				;
				
				insert into pls_alerta_evento_controle(nr_sequencia,
					dt_geracao_evento,
					ie_evento_disparo,
					nr_seq_tipo_evento,
					dt_atualizacao,
					nm_usuario,
					dt_atualizacao_nrec,
					nm_usuario_nrec,
					ds_mensagem,
					ds_titulo,
					ie_tipo_envio)
				values (nr_seq_evento_controle_w,
					clock_timestamp(),
					ie_tipo_evento_p,
					nr_seq_tipo_evento_w,
					clock_timestamp(),
					nm_usuario_p,
					clock_timestamp(),
					nm_usuario_p,
					ds_mensagem_regra_w,
					ds_titulo_w,
					ie_tipo_envio_w);
			end if;
			
			if	(ie_forma_envio_w = 'CI' AND ie_tipo_pessoa_dest_w = 'US')  then
				open C07;
				loop
				fetch C07 into
					nm_usuario_destino_definit_w;
				EXIT WHEN NOT FOUND; /* apply on C07 */
					begin
					if (ds_mensagem_regra_w IS NOT NULL AND ds_mensagem_regra_w::text <> '') then
						CALL gerar_comunic_padrao(	clock_timestamp(),
									ds_titulo_w,
									ds_mensagem_regra_w,
									nm_usuario_p,
									'N',
									nm_usuario_destino_definit_w,
									'N',
									null,
									null,
									cd_estabelecimento_w,
									null,
									clock_timestamp(),
									null,
									null);
					end if;
					
					nm_usuarios_lista_w	:= nm_usuario_destino_definit_w || ',';
					
					while(nm_usuarios_lista_w IS NOT NULL AND nm_usuarios_lista_w::text <> '') loop
						begin
						nr_pos_virgula_w	:= position(',' in nm_usuarios_lista_w);
						if (nr_pos_virgula_w > 0) then
							nm_usuario_destino_w	:= substr(nm_usuarios_lista_w,1,nr_pos_virgula_w-1);
							nm_usuarios_lista_w	:= substr(nm_usuarios_lista_w,nr_pos_virgula_w+1,length(nm_usuarios_lista_w));
							
							if (nm_usuario_destino_w IS NOT NULL AND nm_usuario_destino_w::text <> '') and (ds_mensagem_regra_w IS NOT NULL AND ds_mensagem_regra_w::text <> '') and (coalesce(nr_seq_evento_controle_w, 0) > 0) then
								CALL pls_gerar_destino_evento(nr_seq_evento_controle_w,
											'E',
											ie_forma_envio_w,
											nm_usuario_p,
											cd_pessoa_fisica_w,
											nm_usuario_destino_w,
											ds_mensagem_regra_w,
											null,
											null);
							end if;
						end if;
						end;
					end loop;
					end;
				end loop;
				close C07;
			elsif 	((ie_forma_envio_w in ('EM', 'SMS')) and (ie_tipo_pessoa_dest_w = 'ES') and (ie_enviar_alerta_resc_benef_w = 'S'))  then
				select 	CASE WHEN coalesce(b.cd_cgc_estipulante::text, '') = '' THEN  'PF'  ELSE 'PJ' END
				into STRICT	ie_tipo_pessoa_w
				from	pls_segurado a,
					pls_contrato b
				where   b.nr_sequencia = a.nr_seq_contrato
				and	a.nr_sequencia = nr_seq_segurado_p;
			
				if (ie_tipo_pessoa_w = 'PF') then
					begin
					select 	obter_email_pf(c.cd_pessoa_fisica),
						(c.nr_ddd_celular || c.nr_telefone_celular) nr_destinatario
					into STRICT 	ds_email_destino_w,
						nr_destinatario_w
					from	pls_segurado  a,
						pls_contrato  b,
						pessoa_fisica c
					where   b.nr_sequencia 		= a.nr_seq_contrato
					and	b.cd_pf_estipulante 	= c.cd_pessoa_fisica
					and	a.nr_sequencia 		= nr_seq_segurado_p;
					exception
					when others then
						ds_email_destino_w 	:= null;
						nr_destinatario_w	:= null;
					end;
				elsif (ie_tipo_pessoa_w = 'PJ') then
					begin
					select 	d.ds_email,
						(c.nr_ddd_telefone || c.nr_telefone) nr_destinatario
					into STRICT 	ds_email_destino_w,
						nr_destinatario_w
					from	pls_segurado    a,
						pls_contrato    b,
						pessoa_juridica c,
						pessoa_juridica_estab d
					where   b.nr_sequencia 		= a.nr_seq_contrato
					and	b.cd_cgc_estipulante 	= c.cd_cgc
					and 	c.cd_cgc 		= d.cd_cgc
					and 	d.cd_estabelecimento 	= a.cd_estabelecimento
					and	a.nr_sequencia 		= nr_seq_segurado_p;
					exception
					when others then
						ds_email_destino_w 	:= null;
						nr_destinatario_w	:= null;
					end;
				end if;
			
				if (ie_forma_envio_w = 'SMS' and (nr_destinatario_w IS NOT NULL AND nr_destinatario_w::text <> '')) then
					pls_enviar_sms_aux(coalesce(ds_remetente_sms_w, ds_remetente_w), nr_destinatario_w, ds_mensagem_regra_w, id_sms_enviado_w);
				elsif (ie_forma_envio_w = 'EM' and (ds_email_destino_w IS NOT NULL AND ds_email_destino_w::text <> '')) then
					CALL enviar_email(ds_titulo_w, ds_mensagem_regra_w, ds_remetente_email_w, ds_email_destino_w, nm_usuario_p, 'B', null);
				end if;
				
				gerar_destino_evento(nr_seq_evento_controle_w, 'E', ie_forma_envio_w, nm_usuario_p, cd_pessoa_fisica_w, nm_usuario_destino_w,
								ds_mensagem_regra_w, id_sms_enviado_w, nr_destinatario_w, ie_tipo_pessoa_dest_w);
			elsif 	((ie_forma_envio_w in ('EM', 'SMS')) and (ie_tipo_pessoa_dest_w = 'PG'))  then
				select 	CASE WHEN coalesce(pls_obter_dados_pagador(nr_seq_pagador, 'CPF')::text, '') = '' THEN  'PJ'  ELSE 'PF' END
				into STRICT	ie_tipo_pessoa_w
				from	pls_segurado
				where   nr_sequencia = nr_seq_segurado_p;
			
				if (ie_tipo_pessoa_w = 'PF') then
					begin
					select pls_obter_dados_pagador(a.nr_seq_pagador, 'M'),
					       (c.nr_ddd_celular || c.nr_telefone_celular) nr_destinatario
					into STRICT 	ds_email_destino_w,
						nr_destinatario_w
					from   pls_segurado a,
					       pls_contrato_pagador b,
					       pessoa_fisica c
					where  a.nr_sequencia = nr_seq_segurado_p
					and    b.nr_sequencia = a.nr_seq_pagador
					and    c.cd_pessoa_fisica = b.cd_pessoa_fisica;
					exception
					when others then
						ds_email_destino_w 	:= null;
						nr_destinatario_w	:= null;
					end;
				elsif (ie_tipo_pessoa_w = 'PJ') then
					begin
					select 	pls_obter_dados_pagador(a.nr_seq_pagador, 'M'),
						(c.nr_ddd_telefone || c.nr_telefone) nr_destinatario
					into STRICT 	ds_email_destino_w,
						nr_destinatario_w
					from	pls_segurado  		a,
						pls_contrato_pagador	b,
						pessoa_juridica		c
					where   a.nr_sequencia 		= nr_seq_segurado_p
					and	b.nr_sequencia		= a.nr_seq_pagador
					and	b.cd_cgc		= c.cd_cgc;
					exception
					when others then
						ds_email_destino_w 	:= null;
						nr_destinatario_w	:= null;
					end;
				end if;
			
				if (ie_forma_envio_w = 'SMS' and (nr_destinatario_w IS NOT NULL AND nr_destinatario_w::text <> '')) then
					pls_enviar_sms_aux(coalesce(ds_remetente_sms_w, ds_remetente_w), nr_destinatario_w, ds_mensagem_regra_w, id_sms_enviado_w);
				elsif (ie_forma_envio_w = 'EM' and (ds_email_destino_w IS NOT NULL AND ds_email_destino_w::text <> '')) then
					CALL enviar_email(	ds_titulo_w, ds_mensagem_regra_w, ds_remetente_email_w, ds_email_destino_w, nm_usuario_p, 'B', null);
				end if;
				
				gerar_destino_evento(nr_seq_evento_controle_w, 'E', ie_forma_envio_w, nm_usuario_p, cd_pessoa_fisica_w, nm_usuario_destino_w,
								ds_mensagem_regra_w, id_sms_enviado_w, nr_destinatario_w, ie_tipo_pessoa_dest_w);
			elsif (ie_forma_envio_w in ('EM', 'SMS') and ie_tipo_pessoa_dest_w = 'BE') then
				begin
				select 	obter_email_pf(b.cd_pessoa_fisica),
					(b.nr_ddd_celular || b.nr_telefone_celular) nr_destinatario
				into STRICT 	ds_email_destino_w,
					nr_destinatario_w
				from	pls_segurado  a,
					pessoa_fisica b
				where   a.cd_pessoa_fisica	= b.cd_pessoa_fisica
				and	a.nr_sequencia		= nr_seq_segurado_p;
				exception
				when others then
					ds_email_destino_w 	:= null;
					nr_destinatario_w	:= null;
				end;
			
				if (ie_forma_envio_w = 'SMS' and (nr_destinatario_w IS NOT NULL AND nr_destinatario_w::text <> '')) then
					pls_enviar_sms_aux(coalesce(ds_remetente_sms_w, ds_remetente_w), nr_destinatario_w, ds_mensagem_regra_w, id_sms_enviado_w);
				elsif (ie_forma_envio_w = 'EM' and (ds_email_destino_w IS NOT NULL AND ds_email_destino_w::text <> '')) then
					CALL enviar_email(	ds_titulo_w, ds_mensagem_regra_w, ds_remetente_email_w, ds_email_destino_w, nm_usuario_p, 'B', null);
				end if;
				
				gerar_destino_evento(nr_seq_evento_controle_w, 'E', ie_forma_envio_w, nm_usuario_p, cd_pessoa_fisica_w, nm_usuario_destino_w,
								ds_mensagem_regra_w, id_sms_enviado_w, nr_destinatario_w, ie_tipo_pessoa_dest_w);
			end if;
			end;
		end loop;
		close C02;
	end if;
	end;
end loop;
close C01;

if (ie_commit_p = 'S') then
	commit;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_alerta_rescisao_benef ( ie_tipo_evento_p bigint, nr_seq_segurado_p bigint, nm_usuario_p text, ie_commit_p text) FROM PUBLIC;

