-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE consistir_barras_material ( cd_material_p bigint, cd_barras_p text, cd_estabelecimento_p bigint, nm_usuario_p text) AS $body$
DECLARE



ie_Permite_inativo_w	varchar(15);
cd_material_w		integer;
ie_situacao_w		varchar(1);


BEGIN

ie_Permite_inativo_w := obter_param_usuario(132, 61, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_Permite_inativo_w);


/*Embora o campo seja PK, mas esta consistência ajuda a identificar qual o material que está utilizando este barras*/

select	coalesce(max(cd_material), 0)
into STRICT	cd_material_w
from	material_cod_barra
where	cd_barra_material	= cd_barras_p
and	cd_material		<> cd_material_p;

if (cd_material_w > 0) then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(265955,'CD_MATERIAL=' || cd_material_w);
	--'Já existe o material ' || cd_material_w || ' que utiliza este código de barras.'
end if;


if (ie_Permite_inativo_w = 'N') then
	begin
	select	coalesce(max(ie_situacao), 'A')
	into STRICT	ie_situacao_w
	from	material
	where	cd_material = cd_material_p;

	if (ie_situacao_w = 'I') then
		CALL wheb_mensagem_pck.exibir_mensagem_abort(265956);
		--'Não é permitido informar um novo barras para o material inativo! Verifique o parâmetro[61]'
	end if;
	end;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE consistir_barras_material ( cd_material_p bigint, cd_barras_p text, cd_estabelecimento_p bigint, nm_usuario_p text) FROM PUBLIC;

