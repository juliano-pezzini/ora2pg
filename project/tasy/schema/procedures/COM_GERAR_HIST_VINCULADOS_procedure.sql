-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE com_gerar_hist_vinculados ( nr_seq_cliente_p bigint, nr_seq_hist_p bigint, nm_usuario_p text, nr_seq_gerado_p INOUT text) AS $body$
DECLARE


nr_seq_cliente_w		bigint;
ds_historico_w		varchar(4000);
contador_w		bigint := 0;
nr_seq_aux_w		varchar(2000);
nr_sequencia_w		bigint;

c01 CURSOR FOR
	SELECT	nr_sequencia
	from	com_cliente
	where (nr_sequencia( 	SELECT	nr_seq_cliente_vinculo
					from	com_cliente_vinculo
					where	nr_seq_cliente = nr_seq_cliente_p)
	or	nr_sequencia in (	select	nr_seq_cliente
					from	com_cliente_vinculo
					where	nr_seq_cliente_vinculo = nr_seq_cliente_p)
	or	nr_sequencia in (	select	a.nr_seq_cliente_vinculo
					from	com_cliente_vinculo a
					where	a.nr_seq_cliente in (	select	nr_seq_cliente
								from	com_cliente_vinculo
								where    nr_seq_cliente_vinculo = nr_seq_cliente_p)))
	and	nr_sequencia <> nr_seq_cliente_p;


BEGIN
open c01;
loop
fetch c01 into
	nr_seq_cliente_w;
EXIT WHEN NOT FOUND; /* apply on c01 */

/*select	ds_historico
into	ds_historico_w
from	com_cliente_hist
where	nr_sequencia	= nr_seq_hist_p;	*/
-- Retirado pois ds_historico é um campo long e ds_historico_w varchar2(4000). Da forma como estava esta variável
--poderia não ter capacidade suficiente para armazenar o campo long. Se fosse transformada em long não seria possível inserir diretamente
--um campo long na tabela com_cliente_hist.
select	nextval('com_cliente_hist_seq')
into STRICT	nr_sequencia_w
;

insert into com_cliente_hist(	ds_historico,
				ds_titulo,
				dt_atualizacao,
				dt_atualizacao_nrec,
				dt_historico,
				dt_liberacao,
				nm_usuario,
				nm_usuario_nrec,
				nr_seq_ativ,
				nr_seq_canal,
				nr_seq_classif,
				nr_seq_cliente,
				nr_seq_tipo,
				nr_sequencia)
			SELECT	'Tasy',
				ds_titulo,
				dt_atualizacao,
				dt_atualizacao_nrec,
				dt_historico,
				dt_liberacao,
				nm_usuario,
				nm_usuario_nrec,
				nr_seq_ativ,
				nr_seq_canal,
				nr_seq_classif,
				nr_seq_cliente_w,
				nr_seq_tipo,
				nr_sequencia_w
			from	com_cliente_hist
			where	nr_sequencia	= nr_seq_hist_p;

			--Adicionei o comando copia_campo_long_de_para, para que o processo que ocorre no delphi, também ocorra no java swing.
			CALL copia_campo_long_de_para(	'COM_CLIENTE_HIST',
							'DS_HISTORICO',
							' where nr_sequencia = :nr_sequencia ',
							'nr_sequencia='||nr_seq_hist_p,
							'COM_CLIENTE_HIST',
							'DS_HISTORICO',
							' where nr_sequencia = (select max(x.nr_sequencia) from com_cliente_hist x where nr_sequencia <> :nr_seq_cliente)',
							'nr_seq_cliente='||nr_seq_cliente_p);

	contador_w := contador_w + 1;

	if (contador_w = 1) then
		nr_seq_aux_w := to_char(nr_sequencia_w);
	else
		nr_seq_aux_w := nr_seq_aux_w || ',' || to_char(nr_sequencia_w);
	end if;

end loop;

nr_seq_gerado_p := nr_seq_aux_w;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE com_gerar_hist_vinculados ( nr_seq_cliente_p bigint, nr_seq_hist_p bigint, nm_usuario_p text, nr_seq_gerado_p INOUT text) FROM PUBLIC;

