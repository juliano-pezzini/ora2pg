-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_campos_ehr_consulta (nr_seq_consulta_p bigint, nm_usuario_p text) AS $body$
DECLARE


ds_atributos_w 		varchar(4000);
ds_comando_w 		  varchar(4000);
nr_seq_apres_w		bigint := 10;	
nr_seq_ehr_consulta_grid bigint;
qt_largura_default_w smallint := 100;
qt_largura_default_dt_w smallint := 160;	
qt_largura_w smallint := 0;
qt_flag smallint;

  atributo RECORD;

BEGIN

	select	ds_sql
	into STRICT	ds_comando_w
	from	ehr_consulta
	where	nr_sequencia = nr_seq_consulta_p;

  delete from ehr_consulta_grid where nr_seq_consulta = nr_seq_consulta_p;

  select obter_alias_consulta_generico(ds_comando_w, ';')
  into STRICT ds_atributos_w
;

  for atributo in (
    SELECT ds from (WITH RECURSIVE cte AS (

      WITH temp AS (SELECT ds_atributos_w str )
      SELECT 
          trim(both regexp_substr(str, '[^;]+', 1, 1)) ds
      FROM temp 
      instr(str, ';', 1, LEVEL - 1) > 0
      UNION ALL

      WITH temp AS (SELECT ds_atributos_w str )  
      SELECT 
          trim(both regexp_substr(str, '[^;]+', 1, (c.level+1))) ds
      FROM temp 
      instr(str, ';', 1, LEVEL - 1) > 0
     JOIN cte c ON ()

) SELECT * FROM cte;
)
  ) loop

      if (coalesce(atributo.ds::text, '') = '') then
        GOTO final_do_loop;
      end if;

      select nextval('ehr_consulta_grid_seq')
      into STRICT nr_seq_ehr_consulta_grid
;

      select count(1)
      into STRICT qt_flag
       
      where trim(both upper(atributo.ds)) like 'DT_%';

      if (qt_flag = 1) then
        qt_largura_w := qt_largura_default_dt_w;
      else
        qt_largura_w := qt_largura_default_w;
      end if;

      insert into EHR_CONSULTA_GRID(
        DS_INFORMACAO,
        DS_MASCARA,
        DT_ATUALIZACAO,
        DT_ATUALIZACAO_NREC,
        IE_TIPO_EDICAO,
        NM_CAMPO_BASE,
        NM_USUARIO,
        NM_USUARIO_NREC,
        NR_SEQ_APRES,
        NR_SEQ_CONSULTA,
        NR_SEQUENCIA,
        QT_LARGURA
      ) values (
        atributo.ds || ' DS_INFORMACAO',
        null,
        clock_timestamp(),
        clock_timestamp(),
        'PSQL',
        atributo.ds,
        nm_usuario_p,
        nm_usuario_p,
        nr_seq_apres_w,
        nr_seq_consulta_p,
        nr_seq_ehr_consulta_grid,
        qt_largura_w
      );

      nr_seq_apres_w := nr_seq_apres_w + 10;

      <<final_do_loop>>
      null;
  end loop;

	commit;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_campos_ehr_consulta (nr_seq_consulta_p bigint, nm_usuario_p text) FROM PUBLIC;

