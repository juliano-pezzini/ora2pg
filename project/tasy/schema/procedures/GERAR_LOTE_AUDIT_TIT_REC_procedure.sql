-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_lote_audit_tit_rec (nr_sequencia_p bigint, nm_usuario_p text) AS $body$
DECLARE

 
dt_inicial_w		timestamp;
dt_final_w		timestamp;
cd_convenio_w		integer;
ie_acao_w		smallint;
cd_estabelecimento_w	integer;
qt_item_w		integer	:= 0;
nr_seq_retorno_w	bigint;
nr_seq_lote_reurso_w	bigint;
ie_ignorar_periodo_w	varchar(1);
nr_seq_hist_audit_w	bigint;


BEGIN 
 
select	a.dt_inicial, 
	a.dt_final, 
	a.cd_convenio, 
	a.ie_acao_historico, 
	a.cd_estabelecimento, 
	a.nr_seq_retorno, 
	a.nr_seq_lote_recurso, 
	a.nr_seq_hist_audit 
into STRICT	dt_inicial_w, 
	dt_final_w, 
	cd_convenio_w, 
	ie_acao_w, 
	cd_estabelecimento_w, 
	nr_seq_retorno_w, 
	nr_seq_lote_reurso_w, 
	nr_seq_hist_audit_w 
from 	Lote_Audit_Tit_Rec a 
where 	nr_sequencia = nr_sequencia_p;
 
ie_ignorar_periodo_w := obter_param_usuario(66, 15, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_ignorar_periodo_w);
 
update	conta_paciente_ret_hist 
set	nr_seq_lote_audit = nr_sequencia_p 
where	nr_sequencia in ( 
	SELECT	b.nr_sequencia 
	FROM conta_paciente d, hist_audit_conta_paciente c, conta_paciente_retorno a, conta_paciente_ret_hist b
LEFT OUTER JOIN convenio_retorno_item e ON (b.nr_seq_ret_item = e.nr_sequencia)
WHERE a.nr_sequencia		= b.nr_seq_conpaci_ret  and d.nr_interno_conta	= a.nr_interno_conta and c.nr_sequencia		= coalesce(nr_seq_hist_audit_w,c.nr_sequencia) and b.nr_seq_hist_audit	= c.nr_sequencia and coalesce(e.nr_seq_retorno,0)	= coalesce(nr_seq_retorno_w,coalesce(e.nr_seq_retorno,0)) and a.cd_convenio		= cd_convenio_w and d.cd_estabelecimento	= cd_estabelecimento_w and coalesce(b.nr_seq_lote_audit::text, '') = '' and (('S' = ie_ignorar_periodo_w) or (b.dt_historico between dt_inicial_w AND dt_final_w)) and coalesce(b.nr_seq_lote_recurso,0)	= coalesce(nr_seq_lote_reurso_w,coalesce(b.nr_seq_lote_recurso,0)) and c.ie_acao = coalesce(ie_acao_w, c.ie_acao) /* Francisco/Bruna - OS 51046 - 21/02/07 - Não vincular ao lote itens do retorno que já foram baixados */
  and not exists (SELECT	1 
			 	from	titulo_receber_liq x 
			 	where	x.nr_seq_ret_item = e.nr_sequencia 
				and	coalesce(x.vl_glosa,0) > 0 
				and	coalesce(e.vl_amenor,0) = 0) );
 
select	count(*) 
into STRICT	qt_item_w 
from	conta_paciente_ret_hist 
where	nr_seq_lote_audit = nr_sequencia_p;
 
if (qt_item_w > 0) then 
 
	update lote_audit_tit_rec 
	set	dt_geracao = clock_timestamp(), 
		nm_usuario = nm_usuario_p 
	where nr_sequencia = nr_sequencia_p;
end if;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_lote_audit_tit_rec (nr_sequencia_p bigint, nm_usuario_p text) FROM PUBLIC;

