-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE tiss_gerar_w_guia_outras_desp (nr_seq_protocolo_p bigint, nr_interno_conta_p bigint, ds_dir_padrao_p text, nm_usuario_p text, ds_tipo_despesa_p text, nr_seq_reap_conta_p bigint) AS $body$
DECLARE


cd_ans_w		varchar(30);
nr_atendimento_w		bigint;
nr_seq_conta_guia_w	bigint;
nr_interno_conta_w		bigint;
nr_seq_guia_w		bigint;
cd_categoria_conv_w	varchar(20);
cont_w			smallint;
ie_tipo_atendimento_w	smallint;
ie_ordenacao_od_w	smallint;
cd_autorizacao_w		varchar(30);
ie_tipo_despesa_w		varchar(2);
ie_tipo_ordem_3_w		varchar(2);
vl_item_w			double precision	:= 0;
dt_item_w		timestamp;
qt_item_w		double precision	:= 0;
vl_unitario_w		double precision	:= 0;
cd_edicao_amb_w		varchar(20);
ds_procedimento_w		varchar(255);
cd_procedimento_w	varchar(20);
vl_reducao_acrescimo_w	double precision	:= 0;
cd_senha_w		varchar(30);
dt_inicio_vigencia_w	timestamp;
dt_final_vigencia_w		timestamp;
dt_hora_item_w		timestamp;
dt_hora_final_w		timestamp;
qt_proc_guia_w		integer	:= 0;
vl_total_w		double precision	:= 0;
vl_taxas_w		double precision	:= 0;
vl_materiais_w		double precision	:= 0;
vl_medicamentos_w	double precision	:= 0;
vl_diarias_w		double precision	:= 0;
vl_alugueis_w		double precision	:= 0;
vl_gases_w		double precision	:= 0;
nr_seq_apresentacao_w	bigint	:= 0;
nr_seq_apresent_guia_w	bigint	:= 0;
cd_estabelecimento_w	smallint;
ie_total_guia_desp_w	varchar(3);
ds_arquivo_logo_w		varchar(140);
cd_convenio_w		integer;
cd_prestador_convenio_w	varchar(255);
ds_tipo_despesa_w		varchar(4000);
ie_clinica_w		bigint;
ds_arquivo_logo_comp_w	varchar(255);
ie_gerar_tiss_w		varchar(10);
nr_seq_classif_atend_w	bigint;
cd_setor_entrada_w	bigint;
cd_setor_execucao_w	bigint;
nr_registro_anvisa_w		varchar(30);
cd_unidade_medida_tiss_w	varchar(20);
ds_versao_w		varchar(20);
vl_opms_w		double precision 	:= 0;
vl_taxas_alugueis_w	double precision	:= 0;
cd_material_fabricante_w material.cd_fabricante%type;
nr_autor_func_opme_w	pessoa_juridica.nr_autor_func%type;
dt_mesano_referencia_w	timestamp;
nr_guia_prestador_w	tiss_conta_guia.nr_guia_prestador%type;
ds_posicao_w		integer;
ds_dir_padrao_w		varchar(255);
im_logo_convenio_w	tiss_logo_convenio.im_logo_convenio%type;

c01 CURSOR FOR
SELECT	c.nr_sequencia,
	b.nr_atendimento,
	c.nr_interno_conta,
	c.cd_autorizacao,
	coalesce(c.vl_taxas, 0),
	coalesce(c.vl_diarias, 0),
	coalesce(c.vl_medicamentos, 0),
	coalesce(c.vl_materiais, 0),
	coalesce(c.vl_gases, 0),
	coalesce(c.vl_alugueis, 0),
	coalesce(c.vl_opms, 0),
	c.cd_senha,
	c.dt_autorizacao,
	c.dt_fim_vigencia,
	coalesce(c.vl_taxas_alugueis, 0),
	c.nr_guia_prestador,
	a.cd_setor_execucao
from	tiss_conta_guia c,
	tiss_conta_atend b,
	tiss_conta_desp a
where	c.nr_interno_conta	= b.nr_interno_conta
and	c.nr_sequencia		= a.nr_seq_guia
and	a.nr_interno_conta	= c.nr_interno_conta
and	c.nr_interno_conta	= nr_interno_conta_p
and	coalesce(ds_tipo_despesa_p::text, '') = ''
and	a.ie_tiss_tipo_guia	= '7'

union

SELECT	c.nr_sequencia,
	b.nr_atendimento,
	c.nr_interno_conta,
	c.cd_autorizacao,
	coalesce(c.vl_taxas, 0),
	coalesce(c.vl_diarias, 0),
	coalesce(c.vl_medicamentos, 0),
	coalesce(c.vl_materiais, 0),
	coalesce(c.vl_gases, 0),
	coalesce(c.vl_alugueis, 0),
	coalesce(c.vl_opms, 0),
	c.cd_senha,
	c.dt_autorizacao,
	c.dt_fim_vigencia,
	coalesce(c.vl_taxas_alugueis, 0),
	c.nr_guia_prestador,
	a.cd_setor_execucao
from	tiss_protocolo_guia e,
	tiss_conta_guia c,
	tiss_conta_atend b,
	tiss_conta_desp a
where	c.nr_interno_conta	= b.nr_interno_conta
and	c.nr_sequencia		= a.nr_seq_guia
and	a.nr_interno_conta	= c.nr_interno_conta
and	e.nr_sequencia		= c.nr_seq_prot_guia
and	nr_seq_protocolo_p	<> -1
and	e.nr_seq_protocolo	= nr_seq_protocolo_p
and	coalesce(ds_tipo_despesa_p::text, '') = ''
and	a.ie_tiss_tipo_guia	= '7'

union

select	c.nr_sequencia,
	b.nr_atendimento,
	c.nr_interno_conta,
	c.cd_autorizacao,
	sum(CASE WHEN ie_tipo_despesa='4' THEN  coalesce(a.vl_item,0)  ELSE 0 END ),
	sum(CASE WHEN ie_tipo_despesa='5' THEN  coalesce(a.vl_item,0)  ELSE 0 END ),
	sum(CASE WHEN ie_tipo_despesa='2' THEN  coalesce(a.vl_item,0)  ELSE 0 END ),
	sum(CASE WHEN ie_tipo_despesa='3' THEN  coalesce(a.vl_item,0)  ELSE 0 END ),
	sum(CASE WHEN ie_tipo_despesa='1' THEN  coalesce(a.vl_item,0)  ELSE 0 END ),
	sum(CASE WHEN ie_tipo_despesa='6' THEN  coalesce(a.vl_item,0)  ELSE 0 END ),
	sum(CASE WHEN ie_tipo_despesa='8' THEN  coalesce(a.vl_item,0)  ELSE 0 END ),
	c.cd_senha,
	c.dt_autorizacao,
	c.dt_fim_vigencia,
	sum(CASE WHEN ie_tipo_despesa='7' THEN  coalesce(a.vl_item,0)  ELSE 0 END ),
	c.nr_guia_prestador,
	a.cd_setor_execucao
from	tiss_conta_guia c,
	tiss_conta_atend b,
	tiss_conta_desp a
where	c.nr_interno_conta	= b.nr_interno_conta
and	c.nr_sequencia		= a.nr_seq_guia
and	a.nr_interno_conta	= c.nr_interno_conta
and	c.nr_interno_conta	= nr_interno_conta_p
and	(ds_tipo_despesa_p IS NOT NULL AND ds_tipo_despesa_p::text <> '')
and	ds_tipo_despesa_w	like '% ' || coalesce(to_char(a.ie_tipo_despesa),'X') || ' %'
and	a.ie_tiss_tipo_guia	= '7'
group by	c.nr_sequencia,
	b.nr_atendimento,
	c.nr_interno_conta,
	c.cd_autorizacao,
	c.cd_senha,
	c.dt_autorizacao,
	c.dt_fim_vigencia,
	c.nr_guia_prestador,
	a.cd_setor_execucao

union

select	c.nr_sequencia,
	b.nr_atendimento,
	c.nr_interno_conta,
	c.cd_autorizacao,
	sum(CASE WHEN ie_tipo_despesa='4' THEN  coalesce(a.vl_item,0)  ELSE 0 END ),
	sum(CASE WHEN ie_tipo_despesa='5' THEN  coalesce(a.vl_item,0)  ELSE 0 END ),
	sum(CASE WHEN ie_tipo_despesa='2' THEN  coalesce(a.vl_item,0)  ELSE 0 END ),
	sum(CASE WHEN ie_tipo_despesa='3' THEN  coalesce(a.vl_item,0)  ELSE 0 END ),
	sum(CASE WHEN ie_tipo_despesa='1' THEN  coalesce(a.vl_item,0)  ELSE 0 END ),
	sum(CASE WHEN ie_tipo_despesa='6' THEN  coalesce(a.vl_item,0)  ELSE 0 END ),
	sum(CASE WHEN ie_tipo_despesa='8' THEN  coalesce(a.vl_item,0)  ELSE 0 END ),
	c.cd_senha,
	c.dt_autorizacao,
	c.dt_fim_vigencia,
	sum(CASE WHEN ie_tipo_despesa='7' THEN  coalesce(a.vl_item,0)  ELSE 0 END ),
	c.nr_guia_prestador,
	a.cd_setor_execucao
from	tiss_protocolo_guia e,
	tiss_conta_guia c,
	tiss_conta_atend b,
	tiss_conta_desp a
where	c.nr_interno_conta	= b.nr_interno_conta
and	c.nr_sequencia		= a.nr_seq_guia
and	e.nr_sequencia		= c.nr_seq_prot_guia
and	a.nr_interno_conta	= c.nr_interno_conta
and	nr_seq_protocolo_p	<> -1
and	e.nr_seq_protocolo	= nr_seq_protocolo_p
and	(ds_tipo_despesa_p IS NOT NULL AND ds_tipo_despesa_p::text <> '')
and	ds_tipo_despesa_w	like '% ' || coalesce(to_char(a.ie_tipo_despesa),'X') || ' %'
and	a.ie_tiss_tipo_guia	= '7'
group by	c.nr_sequencia,
	b.nr_atendimento,
	c.nr_interno_conta,
	c.cd_autorizacao,
	c.cd_senha,
	c.dt_autorizacao,
	c.dt_fim_vigencia,
	c.nr_guia_prestador,
	a.cd_setor_execucao

union all

select	c.nr_sequencia,
	b.nr_atendimento,
	c.nr_interno_conta,
	c.cd_autorizacao,
	coalesce(c.vl_taxas, 0),
	coalesce(c.vl_diarias, 0),
	coalesce(c.vl_medicamentos, 0),
	coalesce(c.vl_materiais, 0),
	coalesce(c.vl_gases, 0),
	coalesce(c.vl_alugueis, 0),
	coalesce(c.vl_opms, 0),
	c.cd_senha,
	c.dt_autorizacao,
	c.dt_fim_vigencia,
	coalesce(c.vl_taxas_alugueis, 0),
	c.nr_guia_prestador,
	a.cd_setor_execucao
from	tiss_conta_guia c,
	tiss_conta_atend b,
	tiss_conta_desp a
where	c.nr_seq_reap_conta	= b.nr_seq_reap_conta
and	a.nr_seq_reap_conta	= c.nr_seq_reap_conta
and	c.nr_seq_reap_conta	= nr_seq_reap_conta_p
and	coalesce(ds_tipo_despesa_p::text, '') = ''

union all

select	c.nr_sequencia,
	b.nr_atendimento,
	c.nr_interno_conta,
	c.cd_autorizacao,
	sum(CASE WHEN ie_tipo_despesa='4' THEN  coalesce(a.vl_item,0)  ELSE 0 END ),
	sum(CASE WHEN ie_tipo_despesa='5' THEN  coalesce(a.vl_item,0)  ELSE 0 END ),
	sum(CASE WHEN ie_tipo_despesa='2' THEN  coalesce(a.vl_item,0)  ELSE 0 END ),
	sum(CASE WHEN ie_tipo_despesa='3' THEN  coalesce(a.vl_item,0)  ELSE 0 END ),
	sum(CASE WHEN ie_tipo_despesa='1' THEN  coalesce(a.vl_item,0)  ELSE 0 END ),
	sum(CASE WHEN ie_tipo_despesa='6' THEN  coalesce(a.vl_item,0)  ELSE 0 END ),
	sum(CASE WHEN ie_tipo_despesa='8' THEN  coalesce(a.vl_item,0)  ELSE 0 END ),
	c.cd_senha,
	c.dt_autorizacao,
	c.dt_fim_vigencia,
	sum(CASE WHEN ie_tipo_despesa='7' THEN  coalesce(a.vl_item,0)  ELSE 0 END ),
	c.nr_guia_prestador,
	a.cd_setor_execucao
from	tiss_conta_guia c,
	tiss_conta_atend b,
	tiss_conta_desp a
where	c.nr_seq_reap_conta	= b.nr_seq_reap_conta
and	a.nr_seq_reap_conta	= c.nr_seq_reap_conta
and	c.nr_seq_reap_conta	= nr_seq_reap_conta_p
and	(ds_tipo_despesa_p IS NOT NULL AND ds_tipo_despesa_p::text <> '')
and	ds_tipo_despesa_w	like '% ' || coalesce(to_char(a.ie_tipo_despesa),'X') || ' %'
group by	c.nr_sequencia,
	b.nr_atendimento,
	c.nr_interno_conta,
	c.cd_autorizacao,
	c.cd_senha,
	c.dt_autorizacao,
	c.dt_fim_vigencia,
	c.nr_guia_prestador,
	a.cd_setor_execucao;

/*Tive que fazer select externo senão da pau no oracle 8 ao ordenar pelo ie_tipo_ordem.*/

c02 CURSOR FOR
SELECT	a.ie_tipo_despesa,
	a.vl_item,
	trunc(a.dt_item,'dd'),
	dt_hora_item,
	a.qt_item,
	a.vl_unitario,
	a.cd_edicao_amb,
	a.ds_procedimento,
	a.cd_procedimento,
	a.vl_reducao_acrescimo,
	a.ie_tipo_ordem,
	a.dt_final,
	a.nr_registro_anvisa,
	a.cd_unidade_medida_tiss,
	a.cd_material_fabricante,
	a.nr_autor_func_opme,
	a.cd_setor_execucao
from	(
	SELECT	ie_tipo_despesa,
		(tiss_obter_regra_campo(7, 'VL_ITEM', cd_convenio_w, vl_item, ie_tipo_atendimento_w, cd_categoria_conv_w, ie_tipo_despesa,0, cd_estabelecimento_w, ie_clinica_w, nr_seq_classif_atend_w, cd_setor_entrada_w, null,a.cd_setor_execucao))::numeric  vl_item,
		trunc(dt_item,'dd') dt_item,
		dt_hora_item,
		dt_final,
		qt_item,
		(tiss_obter_regra_campo(7, 'VL_UNITARIO', cd_convenio_w, vl_unitario, ie_tipo_atendimento_w, cd_categoria_conv_w, ie_tipo_despesa ,0, cd_estabelecimento_w, ie_clinica_w, nr_seq_classif_atend_w, cd_setor_entrada_w, null, a.cd_setor_execucao))::numeric  vl_unitario,
		cd_edicao_amb,
		ds_procedimento,
		cd_procedimento,
		(tiss_obter_regra_campo(7, 'VL_REDUCAO_ACRESCIMO', cd_convenio_w, vl_reducao_acrescimo, ie_tipo_atendimento_w, cd_categoria_conv_w, ie_tipo_despesa ,0, cd_estabelecimento_w, ie_clinica_w, nr_seq_classif_atend_w, cd_setor_entrada_w, null, a.cd_setor_execucao))::numeric  vl_reducao_acrescimo,
		(CASE WHEN ie_tipo_despesa='1' THEN  '3' WHEN ie_tipo_despesa='2' THEN  '5' WHEN ie_tipo_despesa='3' THEN  '4' WHEN ie_tipo_despesa='4' THEN  '2' WHEN ie_tipo_despesa='5' THEN  '1' WHEN ie_tipo_despesa='6' THEN  '6' WHEN ie_tipo_despesa='7' THEN  '2' END ) ie_tipo_ordem,--7 para o TISS 3 que é Taxas e aluguéis
		a.nr_registro_anvisa,
		a.cd_unidade_medida_tiss,
		a.cd_material_fabricante,
		a.nr_autor_func_opme,
		a.cd_setor_execucao
	from	tiss_conta_desp a
	where	nr_seq_guia			= nr_seq_conta_guia_w
	and	coalesce(nr_seq_reap_conta_p,-1) 	<= 0
	and	((coalesce(ds_tipo_despesa_p::text, '') = '') or (ds_tipo_despesa_w like '% ' || coalesce(to_char(a.ie_tipo_despesa),'X') || ' %'))
	
union all

		select	ie_tipo_despesa,
		(tiss_obter_regra_campo(7, 'VL_ITEM', cd_convenio_w, vl_item, ie_tipo_atendimento_w, cd_categoria_conv_w, ie_tipo_despesa,0, cd_estabelecimento_w, ie_clinica_w, nr_seq_classif_atend_w, cd_setor_entrada_w, null, a.cd_setor_execucao))::numeric  vl_item,
		trunc(dt_item,'dd') dt_item,
		dt_hora_item,
		dt_final,
		qt_item,
		(tiss_obter_regra_campo(7, 'VL_UNITARIO', cd_convenio_w, vl_unitario, ie_tipo_atendimento_w, cd_categoria_conv_w, ie_tipo_despesa ,0, cd_estabelecimento_w, ie_clinica_w, nr_seq_classif_atend_w, cd_setor_entrada_w, null, a.cd_setor_execucao))::numeric  vl_unitario,
		cd_edicao_amb,
		ds_procedimento,
		cd_procedimento,
		(tiss_obter_regra_campo(7, 'VL_REDUCAO_ACRESCIMO', cd_convenio_w, vl_reducao_acrescimo, ie_tipo_atendimento_w, cd_categoria_conv_w, ie_tipo_despesa ,0, cd_estabelecimento_w, ie_clinica_w, nr_seq_classif_atend_w, cd_setor_entrada_w, null, a.cd_setor_execucao))::numeric  vl_reducao_acrescimo,
		(CASE WHEN ie_tipo_despesa='1' THEN  '3' WHEN ie_tipo_despesa='2' THEN  '5' WHEN ie_tipo_despesa='3' THEN  '4' WHEN ie_tipo_despesa='4' THEN  '2' WHEN ie_tipo_despesa='5' THEN  '1' WHEN ie_tipo_despesa='6' THEN  '6' WHEN ie_tipo_despesa='7' THEN  '2' END ) ie_tipo_ordem, --7 para o TISS 3 que é Taxas e aluguéis
		a.nr_registro_anvisa,
		a.cd_unidade_medida_tiss,
		a.cd_material_fabricante,
		a.nr_autor_func_opme,
		a.cd_setor_execucao
	from	tiss_conta_desp a
	where	nr_seq_reap_conta		= nr_seq_reap_conta_p
	and	coalesce(nr_seq_reap_conta_p,-1) 	> 0
	and	((coalesce(ds_tipo_despesa_p::text, '') = '') or (ds_tipo_despesa_w like '% ' || coalesce(to_char(a.ie_tipo_despesa),'X') || ' %'))) a
order by	CASE WHEN ie_ordenacao_od_w=1 THEN  a.ie_tipo_despesa  ELSE '' END ,
	CASE WHEN ie_ordenacao_od_w=2 THEN  a.ie_tipo_despesa  ELSE '' END  desc,
	CASE WHEN ie_ordenacao_od_w=3 THEN  a.ie_tipo_ordem  ELSE '' END ,
	CASE WHEN ie_ordenacao_od_w=4 THEN  a.dt_item  ELSE '' END ,
	CASE WHEN ie_ordenacao_od_w=6 THEN  a.dt_item  ELSE '' END ,
	CASE WHEN ie_ordenacao_od_w=6 THEN  a.ie_tipo_despesa  ELSE '' END ,
	CASE WHEN ie_ordenacao_od_w=7 THEN  a.ie_tipo_despesa  ELSE '' END ,
	CASE WHEN ie_ordenacao_od_w=7 THEN  a.dt_item  ELSE '' END ,
	CASE WHEN ie_ordenacao_od_w=8 THEN  a.ie_tipo_ordem  ELSE '' END ,
	CASE WHEN ie_ordenacao_od_w=8 THEN  a.dt_item  ELSE '' END ,
	a.ds_procedimento,
	trunc(a.dt_item,'dd');


BEGIN

ds_tipo_despesa_w	:= ' ' || replace(replace(replace(ds_tipo_despesa_p,'(',''),')',''),',',' ') || ' ';

delete	from w_tiss_guia
where	nm_usuario		= nm_usuario_p;

delete	from w_tiss_contratado_exec
where	nm_usuario		= nm_usuario_p;

delete	from w_tiss_outras_despesas
where	nm_usuario		= nm_usuario_p;

delete	from w_tiss_totais
where	nm_usuario		= nm_usuario_p;

delete	from w_tiss_relatorio
where	nm_usuario		= nm_usuario_p;

commit;

CALL tiss_convenio_pck.set_dt_referencia_tiss(null);

if (coalesce(nr_seq_protocolo_p,0) > 0) then

	select	max(coalesce(d.cd_ans,c.cd_ans)),
		max(b.ds_arquivo_logo_tiss),
		max(b.cd_convenio),
		max(a.cd_prestador_convenio),
		max(a.cd_estabelecimento),
		max(coalesce(a.dt_referencia_tiss,a.dt_mesano_referencia))
	into STRICT	cd_ans_w,
		ds_arquivo_logo_w,
		cd_convenio_w,
		cd_prestador_convenio_w,
		cd_estabelecimento_w,
		dt_mesano_referencia_w
	from	convenio_estabelecimento d,
		pessoa_juridica c,
		convenio b,
		protocolo_convenio a
	where	a.cd_convenio		= b.cd_convenio
	and	b.cd_cgc		= c.cd_cgc
	and	a.cd_convenio		= d.cd_convenio
	and	a.cd_estabelecimento	= d.cd_estabelecimento
	and	a.nr_seq_protocolo	= nr_seq_protocolo_p;
	
	CALL tiss_convenio_pck.set_dt_referencia_tiss(dt_mesano_referencia_w);

elsif (coalesce(nr_interno_conta_p,0) > 0) then

	select	max(coalesce(d.cd_ans,c.cd_ans)),
		max(b.ds_arquivo_logo_tiss),
		max(b.cd_convenio),
		max(a.cd_estabelecimento),
		max(a.dt_mesano_referencia)
	into STRICT	cd_ans_w,
		ds_arquivo_logo_w,
		cd_convenio_w,
		cd_estabelecimento_w,
		dt_mesano_referencia_w
	from	convenio_estabelecimento d,
		pessoa_juridica c,
		convenio b,
		conta_paciente a
	where	a.cd_convenio_parametro	= b.cd_convenio
	and	b.cd_cgc		= c.cd_cgc
	and	a.cd_convenio_parametro	= d.cd_convenio
	and	a.cd_estabelecimento	= d.cd_estabelecimento
	and	a.nr_interno_conta	= nr_interno_conta_p;
	
elsif (coalesce(nr_seq_reap_conta_p,0) > 0) then

	select	max(coalesce(d.cd_ans,c.cd_ans)),
		max(b.ds_arquivo_logo_tiss),
		max(b.cd_convenio),
		max(a.cd_estabelecimento),
		max(a.dt_mesano_referencia)
	into STRICT	cd_ans_w,
		ds_arquivo_logo_w,
		cd_convenio_w,
		cd_estabelecimento_w,
		dt_mesano_referencia_w
	from	convenio_estabelecimento d,
		pessoa_juridica c,
		convenio b,
		conta_paciente a,
		tiss_reap_conta e
	where	a.cd_convenio_parametro	= b.cd_convenio
	and	b.cd_cgc		= c.cd_cgc
	and	a.cd_convenio_parametro	= d.cd_convenio
	and	a.cd_estabelecimento	= d.cd_estabelecimento
	and	a.nr_interno_conta	= e.nr_interno_conta
	and	e.nr_sequencia		= nr_seq_reap_conta_p;

end if;

select	coalesce(max(ie_total_guia_desp), 'G'),
	coalesce(max(ie_ordenacao_od), 1),
	max(ds_arquivo_logo_comp),
	coalesce(max(ie_gerar_tiss), 'S')
into STRICT	ie_total_guia_desp_w,
	ie_ordenacao_od_w,
	ds_arquivo_logo_comp_w,
	ie_gerar_tiss_w
from	tiss_parametros_convenio
where	cd_estabelecimento	= cd_estabelecimento_w
and	cd_convenio		= cd_convenio_w;

select	tiss_obter_versao(cd_convenio_w,cd_estabelecimento_w, dt_mesano_referencia_w)
into STRICT	ds_versao_w
;

begin
	select	im_logo_convenio
	into STRICT	im_logo_convenio_w
	from	tiss_logo_convenio
	where	cd_convenio	   = cd_convenio_w
	and 	coalesce(ie_situacao,'N') = 'A';
exception
when others then
	im_logo_convenio_w := null;
end;
		
if (coalesce(im_logo_convenio_w::text, '') = '') and (ds_arquivo_logo_w IS NOT NULL AND ds_arquivo_logo_w::text <> '') then
	ds_arquivo_logo_w := tiss_diretorio_logo(ds_arquivo_logo_comp_w, ds_dir_padrao_p) || ds_arquivo_logo_w;
end if;


if (ds_arquivo_logo_w IS NOT NULL AND ds_arquivo_logo_w::text <> '') and (coalesce(im_logo_convenio_w::text, '') = '') then

	insert	into w_tiss_relatorio(nr_sequencia,
		dt_atualizacao,
		nm_usuario,
		dt_atualizacao_nrec,
		nm_usuario_nrec,
		ds_arquivo_logo,
		im_logo_convenio)
	values (nextval('w_tiss_relatorio_seq'),
		clock_timestamp(),
		nm_usuario_p,
		clock_timestamp(),
		nm_usuario_p,
		ds_arquivo_logo_w,
		null);
else
	insert	into w_tiss_relatorio(nr_sequencia,
		dt_atualizacao,
		nm_usuario,
		dt_atualizacao_nrec,
		nm_usuario_nrec,
		ds_arquivo_logo,
		im_logo_convenio)
	values (nextval('w_tiss_relatorio_seq'),
		clock_timestamp(),
		nm_usuario_p,
		clock_timestamp(),
		nm_usuario_p,
		null,
		im_logo_convenio_w);
end if;

if (coalesce(ie_gerar_tiss_w,'S') = 'S') then
	open c01;
	loop
	fetch c01 into
		nr_seq_conta_guia_w,
		nr_atendimento_w,
		nr_interno_conta_w,
		cd_autorizacao_w,
		VL_TAXAS_w,
		VL_DIARIAS_w,
		VL_MEDICAMENTOS_w,
		VL_MATERIAIS_w,
		VL_GASES_w,
		vl_alugueis_w,
		vl_opms_w,
		cd_senha_w,
		dt_inicio_vigencia_w,
		dt_final_vigencia_w,
		vl_taxas_alugueis_w,
		nr_guia_prestador_w,
		cd_setor_execucao_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
		
		if (obter_se_projeto_versao(0,12,ds_versao_w,0) = 'S') then
			vl_total_w	:= vl_diarias_w + vl_medicamentos_w + vl_materiais_w + vl_gases_w + vl_opms_w + vl_taxas_alugueis_w;
			
			cd_autorizacao_w	:= coalesce(cd_autorizacao_w,nr_guia_prestador_w); --Na versao 3, se a guia não tem numero, então é o numero da guia prestador(no caso o campo 2)
		else
			vl_total_w	:= vl_taxas_w + vl_diarias_w + vl_medicamentos_w + vl_materiais_w + vl_gases_w + vl_alugueis_w;
		end if;

		select	max(ie_tipo_atendimento)
		into STRICT	ie_tipo_atendimento_w
		from	atendimento_paciente
		where	nr_atendimento		= nr_atendimento_w;

		select	max(cd_categoria_parametro)
		into STRICT	cd_categoria_conv_w
		from	conta_paciente
		where	nr_interno_conta	= nr_interno_conta_w;

		select	max((obter_clinica_atend(nr_atendimento_w, 'C'))::numeric ),
			max((Obter_Classificacao_Atend(nr_atendimento_w,'C'))::numeric ),
			max(obter_setor_atendimento(nr_atendimento_w))
		into STRICT	ie_clinica_w,
			nr_seq_classif_atend_w,
			cd_setor_entrada_w
		;

		nr_seq_apresentacao_w	:= 1;
		qt_proc_guia_w 		:= 0;
		cont_w			:= 1;
		nr_seq_apresent_guia_w	:= 0;

		open c02;
		loop
		fetch c02 into
			ie_tipo_despesa_w,
			vl_item_w,
			dt_item_w,
			dt_hora_item_w,
			qt_item_w,
			vl_unitario_w,
			cd_edicao_amb_w,
			ds_procedimento_w,
			cd_procedimento_w,
			vl_reducao_acrescimo_w,
			ie_tipo_ordem_3_w,
			dt_hora_final_w,
			nr_registro_anvisa_w,
			cd_unidade_medida_tiss_w,
			cd_material_fabricante_w,
			nr_autor_func_opme_w,
			cd_setor_execucao_w;
		EXIT WHEN NOT FOUND; /* apply on c02 */

			if (ie_total_guia_desp_w	= 'P') then

				if (cont_w		= 1) then
					cont_w		:= cont_w + 1;
					vl_total_w		:= 0;
					vl_taxas_w		:= 0;
					vl_gases_w		:= 0;
					vl_materiais_w		:= 0;
					vl_medicamentos_w	:= 0;
					vl_diarias_w		:= 0;	
					vl_alugueis_w		:= 0;
					vl_opms_w		:= 0;
					vl_taxas_alugueis_w	:= 0;
				end if;

				if (ie_tipo_despesa_w = 1) then
					vl_gases_w		:= vl_gases_w + vl_item_w;
				elsif (ie_tipo_despesa_w = 2) then
					vl_medicamentos_w	:= vl_medicamentos_w + vl_item_w;
				elsif (ie_tipo_despesa_w = 3) then
					vl_materiais_w		:= vl_materiais_w + vl_item_w;
				elsif (ie_tipo_despesa_w = 4) then
					vl_taxas_w		:= vl_taxas_w + vl_item_w;
				elsif (ie_tipo_despesa_w = 5) then
					vl_diarias_w		:= vl_diarias_w + vl_item_w;
				elsif (ie_tipo_despesa_w = 6) then
					vl_alugueis_w		:= vl_alugueis_w + vl_item_w;				
				end if;
				
				if (obter_se_projeto_versao(0,12,ds_versao_w,0) = 'S') then
				
					if (ie_tipo_despesa_w = 7) then
						vl_taxas_alugueis_w	:= vl_taxas_alugueis_w + vl_item_w;
					elsif (ie_tipo_despesa_w = 8) then
						vl_opms_w		:= vl_opms_w + vl_item_w;
					end if;
				end if;

				vl_total_w	:= vl_total_w + vl_item_w;
			end if;

			qt_proc_guia_w		:= qt_proc_guia_w + 1;

			if (qt_proc_guia_w = 1) then

				select	max(nr_seq_apresent)
				into STRICT	nr_seq_apresent_guia_w
				from	conta_paciente
				where	nr_interno_conta	= nr_interno_conta_w;

	--			nr_seq_apresent_guia_w	:= nr_seq_apresent_guia_w + 1;
				select	nextval('w_tiss_guia_seq')
				into STRICT	nr_seq_guia_w
				;

				insert	into w_tiss_guia(nr_sequencia,
					dt_atualizacao,
					nm_usuario,
					cd_ans,
					cd_autorizacao,
					dt_autorizacao,
					cd_senha,
					dt_validade_senha,
					dt_emissao_guia,
					nr_interno_conta,
					nr_seq_protocolo,
					nr_sequencia_autor,
					nr_atendimento,
					ie_tiss_tipo_guia,
					nr_seq_apresentacao,
					ds_versao)
				values (nr_seq_guia_w,
					clock_timestamp(),
					nm_usuario_p,
					cd_ans_w,
					cd_autorizacao_w,
					dt_inicio_vigencia_w,
					cd_senha_w,
					dt_final_vigencia_w,
					dt_inicio_vigencia_w,
					nr_interno_conta_w,
					nr_seq_protocolo_p,
					null,
					nr_atendimento_w,
					'7',
					nr_seq_apresent_guia_w,
					ds_versao_w);

				insert	into w_tiss_contratado_exec(nr_sequencia,
					dt_atualizacao,
					nm_usuario,
					nr_seq_guia,
					cd_cgc,
					cd_interno,
					nr_cpf,
					nm_contratado,
					ds_tipo_logradouro,
					ds_logradouro,
					nm_municipio,
					sg_estado,
					cd_municipio_ibge,
					cd_cep,
					cd_cnes,
					nm_medico_executor,
					sg_conselho,
					nr_crm,
					uf_crm)
				SELECT	nextval('w_tiss_contratado_exec_seq'),
					clock_timestamp(),
					nm_usuario_p,
					nr_seq_guia_w,
					cd_cgc,
					coalesce(coalesce(nr_cpf, cd_prestador_convenio_w), cd_interno),
					null,
					nm_contratado,
					null,
					null,
					null,
					null,
					null,
					null,
					cd_cnes,
					null,
					null,
					null,
					null
				from	tiss_conta_contrat_exec
				where	nr_seq_guia	= nr_seq_conta_guia_w;

				nr_seq_apresentacao_w	:= 1;
			end if;
			
			

			insert	into w_tiss_outras_despesas(nr_sequencia,
				dt_atualizacao,
				nm_usuario,
				nr_seq_guia,
				ie_tipo_despesa,
				dt_item,
				cd_edicao_amb,
				cd_procedimento,
				ds_procedimento,
				qt_item,
				vl_reducao_acrescimo,
				vl_unitario,
				vl_item,
				nr_seq_apresentacao,
				dt_periodo_inicial,
				dt_periodo_final,
				nr_registro_anvisa,
				cd_unidade_medida_tiss,
				cd_material_fabricante,
				nr_autor_func_opme)
			values (nextval('w_tiss_outras_despesas_seq'),
				clock_timestamp(),
				nm_usuario_p,
				nr_seq_guia_w,
				ie_tipo_despesa_w,
				dt_item_w,
				cd_edicao_amb_w,
				cd_procedimento_w,
				ds_procedimento_w,
				qt_item_w,
				vl_reducao_acrescimo_w,
				vl_unitario_w,
				vl_item_w,
				nr_seq_apresentacao_w,
				dt_hora_item_w,
				dt_hora_final_w,
				nr_registro_anvisa_w,
				cd_unidade_medida_tiss_w,
				cd_material_fabricante_w,
				nr_autor_func_opme_w);

			nr_seq_apresentacao_w	:= nr_seq_apresentacao_w + 1;

			if (qt_proc_guia_w = 13 and (obter_se_projeto_versao(0,12,ds_versao_w,0) = 'N')) or (qt_proc_guia_w = 10 and (obter_se_projeto_versao(0,12,ds_versao_w,0) = 'S'))then

				insert	into w_tiss_totais(nr_sequencia,
					dt_atualizacao,
					nm_usuario,
					nr_seq_guia,
					vl_procedimentos,
					vl_taxas,
					vl_materiais,
					vl_medicamentos,
					vl_diarias,
					vl_gases,
					vl_total_geral,
					vl_total_geral_opm,
					vl_taxas_alugueis)
				values (nextval('w_tiss_totais_seq'),
					clock_timestamp(),
					nm_usuario_p,
					nr_seq_guia_w,
					(tiss_obter_regra_campo(7, 'VL_PROCEDIMENTOS', CD_CONVENIO_W, vl_alugueis_w, ie_tipo_atendimento_w, cd_categoria_conv_w,'N',0, cd_estabelecimento_w, ie_clinica_w, nr_seq_classif_atend_w, cd_setor_entrada_w, null))::numeric ,
					(tiss_obter_regra_campo(7, 'VL_TAXAS', CD_CONVENIO_W, vl_taxas_w, ie_tipo_atendimento_w, cd_categoria_conv_w,'N',0, cd_estabelecimento_w, ie_clinica_w, nr_seq_classif_atend_w, cd_setor_entrada_w, null))::numeric ,
					(tiss_obter_regra_campo(7, 'VL_MATERIAIS', CD_CONVENIO_W, vl_materiais_w, ie_tipo_atendimento_w, cd_categoria_conv_w,'N',0, cd_estabelecimento_w, ie_clinica_w, nr_seq_classif_atend_w, cd_setor_entrada_w, null))::numeric ,
					(tiss_obter_regra_campo(7, 'VL_MEDICAMENTOS', CD_CONVENIO_W, vl_medicamentos_w, ie_tipo_atendimento_w, cd_categoria_conv_w,'N',0, cd_estabelecimento_w, ie_clinica_w, nr_seq_classif_atend_w, cd_setor_entrada_w, null))::numeric ,
					(tiss_obter_regra_campo(7, 'VL_DIARIAS', CD_CONVENIO_W, vl_diarias_w, ie_tipo_atendimento_w, cd_categoria_conv_w,'N',0, cd_estabelecimento_w, ie_clinica_w, nr_seq_classif_atend_w, cd_setor_entrada_w, null))::numeric ,
					(tiss_obter_regra_campo(7, 'VL_GASES', CD_CONVENIO_W, vl_gases_w, ie_tipo_atendimento_w, cd_categoria_conv_w,'N',0, cd_estabelecimento_w, ie_clinica_w, nr_seq_classif_atend_w, cd_setor_entrada_w, null))::numeric ,
					(tiss_obter_regra_campo(7, 'VL_TOTAL', CD_CONVENIO_W, vl_total_w, ie_tipo_atendimento_w, cd_categoria_conv_w,'N',0, cd_estabelecimento_w, ie_clinica_w, nr_seq_classif_atend_w, cd_setor_entrada_w, null))::numeric ,
					vl_opms_w,
					vl_taxas_alugueis_w);

				qt_proc_guia_w		:= 0;
				cont_w			:= 1;

			end if;

		end loop;
		close c02;

		if (qt_proc_guia_w > 0) and
			((qt_proc_guia_w < 13 and (obter_se_projeto_versao(0,12,ds_versao_w,0) = 'N')) or (qt_proc_guia_w < 10 and (obter_se_projeto_versao(0,12,ds_versao_w,0) = 'S'))) then

			insert	into w_tiss_totais(nr_sequencia,
				dt_atualizacao,
				nm_usuario,
				nr_seq_guia,
				vl_procedimentos,
				vl_taxas,
				vl_materiais,
				vl_medicamentos,
				vl_diarias,
				vl_gases,
				vl_total_geral,
				vl_total_geral_opm,
				vl_taxas_alugueis)
			values (nextval('w_tiss_totais_seq'),
				clock_timestamp(),
				nm_usuario_p,
				nr_seq_guia_w,
				(tiss_obter_regra_campo(7, 'VL_PROCEDIMENTOS', CD_CONVENIO_W, vl_alugueis_w, ie_tipo_atendimento_w, cd_categoria_conv_w,'N',0, cd_estabelecimento_w, ie_clinica_w, nr_seq_classif_atend_w, cd_setor_entrada_w, null))::numeric ,
				(tiss_obter_regra_campo(7, 'VL_TAXAS', CD_CONVENIO_W, vl_taxas_w, ie_tipo_atendimento_w, cd_categoria_conv_w,'N',0, cd_estabelecimento_w, ie_clinica_w, nr_seq_classif_atend_w, cd_setor_entrada_w, null))::numeric ,
				(tiss_obter_regra_campo(7, 'VL_MATERIAIS', CD_CONVENIO_W, vl_materiais_w, ie_tipo_atendimento_w, cd_categoria_conv_w,'N',0, cd_estabelecimento_w, ie_clinica_w, nr_seq_classif_atend_w, cd_setor_entrada_w, null))::numeric ,
				(tiss_obter_regra_campo(7, 'VL_MEDICAMENTOS', CD_CONVENIO_W, vl_medicamentos_w, ie_tipo_atendimento_w, cd_categoria_conv_w,'N',0, cd_estabelecimento_w, ie_clinica_w, nr_seq_classif_atend_w, cd_setor_entrada_w, null))::numeric ,
				(tiss_obter_regra_campo(7, 'VL_DIARIAS', CD_CONVENIO_W, vl_diarias_w, ie_tipo_atendimento_w, cd_categoria_conv_w,'N',0, cd_estabelecimento_w, ie_clinica_w, nr_seq_classif_atend_w, cd_setor_entrada_w, null))::numeric ,
				(tiss_obter_regra_campo(7, 'VL_GASES', CD_CONVENIO_W, vl_gases_w, ie_tipo_atendimento_w, cd_categoria_conv_w,'N',0, cd_estabelecimento_w, ie_clinica_w, nr_seq_classif_atend_w, cd_setor_entrada_w, null))::numeric ,
				(tiss_obter_regra_campo(7, 'VL_TOTAL', CD_CONVENIO_W, vl_total_w, ie_tipo_atendimento_w, cd_categoria_conv_w,'N',0, cd_estabelecimento_w, ie_clinica_w, nr_seq_classif_atend_w, cd_setor_entrada_w, null))::numeric ,
				vl_opms_w,
				vl_taxas_alugueis_w);

		end if;

		CALL TISS_COMPLETAR_GUIA(nr_seq_guia_w, nm_usuario_p);

		commit;

	end loop;
	close c01;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE tiss_gerar_w_guia_outras_desp (nr_seq_protocolo_p bigint, nr_interno_conta_p bigint, ds_dir_padrao_p text, nm_usuario_p text, ds_tipo_despesa_p text, nr_seq_reap_conta_p bigint) FROM PUBLIC;

