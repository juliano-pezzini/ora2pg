-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE alterar_status_agenda_tasy ( cd_estabelecimento_p bigint, nr_seq_agenda_p bigint, ie_status_p text, nm_usuario_p text) AS $body$
DECLARE


ie_status_w	varchar(1);
qt_recurso_w	bigint;
dt_agenda_w	timestamp;


BEGIN
if (nr_seq_agenda_p IS NOT NULL AND nr_seq_agenda_p::text <> '') and (ie_status_p IS NOT NULL AND ie_status_p::text <> '') then
	begin
	select	coalesce(max(ie_status),ie_status_p),
		max(dt_agenda)
	into STRICT	ie_status_w,
		dt_agenda_w
	from	agenda_tasy
	where	nr_sequencia = nr_seq_agenda_p;

	if (ie_status_p = 'B') then
		begin
		if (ie_status_w = 'B') then
			begin
			update	agenda_tasy
			set	ie_status		= 'L',
				nm_usuario	= nm_usuario_p
			where	nr_sequencia	= nr_seq_agenda_p;
			end;
		else
			begin
			update	agenda_tasy
			set	ie_status		= 'B',
				nm_usuario	= nm_usuario_p
			where	nr_sequencia	= nr_seq_agenda_p;
			end;
		end if;
		end;

	elsif (ie_status_p = 'C') then
		begin
		update	agenda_tasy
		set	ie_status		= 'C',
			nm_usuario	= nm_usuario_p
		where	nr_sequencia	= nr_seq_agenda_p;

		select	count(*)
		into STRICT	qt_recurso_w
		from	agenda_tasy_recurso
		where	nr_seq_agenda = nr_seq_agenda_p;

		if (qt_recurso_w > 0) then
			begin
			CALL enviar_comunic_recurso_agenda(cd_estabelecimento_p, nr_seq_agenda_p, nm_usuario_p);
			end;
		end if;

		if (dt_agenda_w IS NOT NULL AND dt_agenda_w::text <> '') then
			begin
			CALL desconfirmar_agenda_tasy(dt_agenda_w, nm_usuario_p);
			end;
		end if;
		end;

	elsif (ie_status_p = 'E') then
		begin
		if (ie_status_w = 'E') then
			begin
			update 	agenda_tasy
			set	ie_status 		= 'M',
				nm_usuario 	= nm_usuario_p
			where	nr_sequencia	= nr_seq_agenda_p;
			end;
		else
			begin
			update	agenda_tasy
			set	ie_status		= 'E',
				nm_usuario	= nm_usuario_p
			where	nr_sequencia	= nr_seq_agenda_p;
			end;
		end if;
		end;
	end if;
	end;
end if;
commit;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE alterar_status_agenda_tasy ( cd_estabelecimento_p bigint, nr_seq_agenda_p bigint, ie_status_p text, nm_usuario_p text) FROM PUBLIC;

