-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_gerar_mensagem_carteira ( nr_seq_segurado_p bigint, nr_seq_contrato_p bigint, nr_seq_plano_p bigint, ds_retorno_p INOUT text) AS $body$
DECLARE


ds_mensagem_w		varchar(255);
ds_mensagem_contr_w	varchar(255);
ds_mensagem_plano_w	varchar(255);
nr_seq_regra_contr_w	bigint;
nr_seq_regra_plano_w	bigint;
qt_corte_w		bigint;

pos_fim_macro_w         	bigint;
ds_macro_w              	varchar(30);
nm_atributo_w           	varchar(50);
pos_macro_w             	bigint;
ds_resultado_macro_w		varchar(4000);
ds_texto_alterado_w		varchar(4000);
ds_mensagem_ww			varchar(255);
ie_desconsiderar_msg_plano_w	pls_contrato_mensagem_cart.ie_desconsiderar_msg_plano%type	:= 'N';


BEGIN

select	max(nr_sequencia)
into STRICT	nr_seq_regra_contr_w
from	pls_contrato_mensagem_cart
where	nr_seq_contrato	= nr_seq_contrato_p
and	ie_situacao	= 'A'
and	clock_timestamp() between	dt_inicio_vigencia and coalesce(dt_fim_vigencia,clock_timestamp());

select	max(nr_sequencia)
into STRICT	nr_seq_regra_plano_w
from	pls_plano_mensagem_cart
where	nr_seq_plano	= nr_seq_plano_p
and	ie_situacao	= 'A'
and	clock_timestamp() between	dt_inicio_vigencia and coalesce(dt_fim_vigencia,clock_timestamp());

if (nr_seq_regra_contr_w IS NOT NULL AND nr_seq_regra_contr_w::text <> '') then
	select	ds_mensagem,
		coalesce(ie_desconsiderar_msg_plano,'N')
	into STRICT	ds_mensagem_contr_w,
		ie_desconsiderar_msg_plano_w
	from	pls_contrato_mensagem_cart
	where	nr_sequencia	= nr_seq_regra_contr_w;

	ds_mensagem_ww		:= ds_mensagem_contr_w || '  ';
	ds_texto_alterado_w	:= ds_mensagem_ww;
	if (ds_mensagem_ww IS NOT NULL AND ds_mensagem_ww::text <> '') then
		while(ds_mensagem_ww IS NOT NULL AND ds_mensagem_ww::text <> '') loop
			select  replace(replace(ds_mensagem_ww,'',' '),chr(13) || chr(10),' ')
			into STRICT    ds_mensagem_ww
			;

			select  position('@' in ds_mensagem_ww)
			into STRICT    pos_macro_w
			;

			if (pos_macro_w > 0) then
				select  substr(ds_mensagem_ww,pos_macro_w,length(ds_mensagem_ww))
				into STRICT    ds_mensagem_ww
				;

				select  position(' ' in ds_mensagem_ww)
				into STRICT    pos_fim_macro_w
				;

				select  Elimina_Caracteres_Especiais(substr(ds_mensagem_ww,1,pos_fim_macro_w -1))
				into STRICT    ds_macro_w
				;

				if ((coalesce(ds_macro_w,null) IS NOT NULL AND (coalesce(ds_macro_w,null))::text <> '')) then
					begin
					select  nm_atributo
					into STRICT    nm_atributo_w
					from    pls_macro_carteira
					where   upper(ds_macro) = upper(ds_macro_w);
					exception
					when others then
						nm_atributo_w := null;
					end;

					if ((coalesce(nm_atributo_w,null) IS NOT NULL AND (coalesce(nm_atributo_w,null))::text <> '')) then
						select	pls_substituir_macro_carteira(nr_seq_segurado_p,nm_atributo_w,ds_macro_w)
						into STRICT	ds_resultado_macro_w
						;

						select  replace(ds_texto_alterado_w, ds_macro_w, ds_resultado_macro_w)
						into STRICT    ds_texto_alterado_w
						;
					end if;
				end if;

				select  substr(ds_mensagem_ww,pos_fim_macro_w, length(ds_mensagem_ww))
				into STRICT    ds_mensagem_ww
				;
			else
				ds_mensagem_ww := '';
			end if;
		end loop;
	end if;
	ds_mensagem_contr_w	:= ds_texto_alterado_w;
end if;

if (nr_seq_regra_plano_w IS NOT NULL AND nr_seq_regra_plano_w::text <> '') and (coalesce(ie_desconsiderar_msg_plano_w,'N') = 'N') then
	select	max(ds_mensagem)
	into STRICT	ds_mensagem_plano_w
	from	pls_plano_mensagem_cart
	where	nr_sequencia	= nr_seq_regra_plano_w;

	ds_mensagem_ww		:= ds_mensagem_plano_w || '  ';
	ds_texto_alterado_w	:= ds_mensagem_ww;

	if (ds_mensagem_ww IS NOT NULL AND ds_mensagem_ww::text <> '') then
		while(ds_mensagem_ww IS NOT NULL AND ds_mensagem_ww::text <> '') loop
			select  replace(replace(ds_mensagem_ww,'',' '),chr(13) || chr(10),' ')
			into STRICT    ds_mensagem_ww
			;

			select  position('@' in ds_mensagem_ww)
			into STRICT    pos_macro_w
			;

			if (pos_macro_w > 0) then
				select  substr(ds_mensagem_ww,pos_macro_w,length(ds_mensagem_ww))
				into STRICT    ds_mensagem_ww
				;

				select  position(' ' in ds_mensagem_ww)
				into STRICT    pos_fim_macro_w
				;

				select  Elimina_Caracteres_Especiais(substr(ds_mensagem_ww,1,pos_fim_macro_w -1))
				into STRICT    ds_macro_w
				;

				if ((coalesce(ds_macro_w,null) IS NOT NULL AND (coalesce(ds_macro_w,null))::text <> '')) then
					begin
					select  nm_atributo
					into STRICT    nm_atributo_w
					from    pls_macro_carteira
					where   upper(ds_macro) = upper(ds_macro_w);
					exception
					when others then
						nm_atributo_w := null;
					end;

					if ((coalesce(nm_atributo_w,null) IS NOT NULL AND (coalesce(nm_atributo_w,null))::text <> '')) then
						select	pls_substituir_macro_carteira(nr_seq_segurado_p,nm_atributo_w,ds_macro_w)
						into STRICT	ds_resultado_macro_w
						;

						select  replace(ds_texto_alterado_w, ds_macro_w, ds_resultado_macro_w)
						into STRICT    ds_texto_alterado_w
						;
					end if;
				end if;

				select  substr(ds_mensagem_ww,pos_fim_macro_w, length(ds_mensagem_ww))
				into STRICT    ds_mensagem_ww
				;
			else
				ds_mensagem_ww := '';
			end if;
		end loop;
	end if;

	ds_mensagem_plano_w	:= ds_texto_alterado_w;
end if;

qt_corte_w	:= (255 - length(ds_mensagem_contr_w));

ds_mensagem_w	:= ds_mensagem_contr_w||chr(13)||substr(ds_mensagem_plano_w,1,coalesce(qt_corte_w,255));

ds_retorno_p	:= substr(ds_mensagem_w,1,255);

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_gerar_mensagem_carteira ( nr_seq_segurado_p bigint, nr_seq_contrato_p bigint, nr_seq_plano_p bigint, ds_retorno_p INOUT text) FROM PUBLIC;

