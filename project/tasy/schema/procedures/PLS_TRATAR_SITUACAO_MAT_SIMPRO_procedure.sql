-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_tratar_situacao_mat_simpro (nr_seq_simpro_preco_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint) AS $body$
DECLARE


ie_tipo_alteracao_w	varchar(3);
dt_vigencia_w		timestamp;
cd_simpro_w		bigint;
ie_atualizar_simpro_w	varchar(1);


BEGIN

if (nr_seq_simpro_preco_p IS NOT NULL AND nr_seq_simpro_preco_p::text <> '') then
	select	a.cd_simpro,
		a.ie_tipo_alteracao,
		a.dt_vigencia
	into STRICT	cd_simpro_w,
		ie_tipo_alteracao_w,
		dt_vigencia_w
	from	simpro_preco a
	where	a.nr_sequencia	= nr_seq_simpro_preco_p;

	/* Se o tipo de alteração foi "Fora de linha" ou "Suspensão" */

	if (ie_tipo_alteracao_w in ('L','S')) then
		update	pls_material
		set	dt_exclusao	= dt_vigencia_w,
			nm_usuario	= 'SIMPRO',
			dt_atualizacao	= clock_timestamp()
		where	cd_simpro	= cd_simpro_w;
	/* Se for inclusão, reativar */

	elsif (ie_tipo_alteracao_w in ('I')) then
		update	pls_material
		set	dt_inclusao	= dt_vigencia_w,
			dt_exclusao	 = NULL,
			nm_usuario	= 'SIMPRO',
			dt_atualizacao	= clock_timestamp()
		where	cd_simpro	= cd_simpro_w
		and	(dt_exclusao IS NOT NULL AND dt_exclusao::text <> '');
	end if;
end if;

/* não pode ter commit */

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_tratar_situacao_mat_simpro (nr_seq_simpro_preco_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint) FROM PUBLIC;

