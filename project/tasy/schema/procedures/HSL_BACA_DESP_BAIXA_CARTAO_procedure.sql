-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE hsl_baca_desp_baixa_cartao () AS $body$
DECLARE


nr_sequencia_w		bigint;
nr_seq_movto_w		bigint;
vl_despesa_w		double precision;
vl_despesa_novo_w	double precision;
vl_baixa_w		double precision;
nr_autorizacao_w	varchar(40);
dt_baixa_w		timestamp;

c01 CURSOR FOR
SELECT	a.nr_sequencia,
	a.nr_seq_movto,
	c.nr_autorizacao,
	a.vl_baixa,
	a.dt_baixa,
	b.vl_despesa
from	movto_cartao_cr c,
	movto_cartao_cr_parcela b,
	movto_cartao_cr_baixa a
where	a.nr_seq_parcela	= b.nr_sequencia
and	a.nr_seq_movto		= c.nr_sequencia
and	a.vl_baixa		= b.vl_liquido * -1
and	a.vl_baixa		<> 0
and	coalesce(a.vl_despesa,0)	= 0;



BEGIN

open c01;
loop
fetch c01 into
	nr_sequencia_w,
	nr_seq_movto_w,
	nr_autorizacao_w,
	vl_baixa_w,
	dt_baixa_w,
	vl_despesa_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
		if (vl_baixa_w < 0) then
			vl_despesa_novo_w	:= coalesce(vl_despesa_w,0) * -1;
		end if;

		update	movto_cartao_cr_baixa
		set	vl_despesa	= vl_despesa_novo_w,
			dt_atualizacao	= clock_timestamp(),
			nm_usuario	= 'Tasy'
		where	nr_sequencia	= nr_sequencia_w;


		insert into log_tasy(	nm_usuario,
					dt_atualizacao,
					cd_log,
					ds_log)
		values ('Tasy',
			clock_timestamp(),
			55610,
			'Atualizada a baixa: Seq= ' || nr_sequencia_w || chr(13) ||
					' Autor = ' || nr_autorizacao_w || chr(13) ||
					' Data baixa = ' || dt_baixa_w || chr(13) ||
					' Valor baixa = ' || vl_baixa_w || chr(13) ||
					' Valor despesa ant= ' || vl_despesa_w || chr(13) ||
					' Valor despesa novo= ' || vl_despesa_novo_w);
end loop;
close c01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE hsl_baca_desp_baixa_cartao () FROM PUBLIC;

