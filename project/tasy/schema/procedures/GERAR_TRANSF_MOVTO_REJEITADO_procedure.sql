-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_transf_movto_rejeitado ( nr_seq_movto_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) AS $body$
DECLARE

 
vl_transacao_w				double precision;
nr_seq_movto_transf_w			bigint;
nr_seq_caixa_destino_w			bigint;
nr_seq_caixa_w				bigint;
nr_seq_saldo_caixa_w			bigint;
nr_seq_lote_w				bigint;
nr_seq_trans_financ_w			bigint;
dt_transacao_w				timestamp;
dt_referencia_saldo_w			timestamp;


BEGIN 
if (nr_seq_movto_p IS NOT NULL AND nr_seq_movto_p::text <> '') then 
	select	dt_transacao, 
		vl_transacao, 
		nr_seq_caixa_od_rej, 
		nr_seq_caixa, 
		nr_seq_saldo_caixa, 
		dt_referencia_saldo, 
		nr_seq_lote, 
		nr_seq_trans_financ 
	into STRICT	dt_transacao_w, 
		vl_transacao_w, 
		nr_seq_caixa_destino_w, 
		nr_seq_caixa_w, 
		nr_seq_saldo_caixa_w, 
		dt_referencia_saldo_w, 
		nr_seq_lote_w, 
		nr_seq_trans_financ_w 
	from	movto_trans_financ 
	where	nr_sequencia	= nr_seq_movto_p;
	 
	select	nextval('movto_trans_financ_seq') 
	into STRICT	nr_seq_movto_transf_w 
	;
	 
	insert into movto_trans_financ(nr_sequencia, 
		dt_transacao, 
		nr_seq_trans_financ, 
		vl_transacao, 
		dt_atualizacao, 
		nm_usuario, 
		nr_seq_caixa, 
		nr_seq_caixa_od, 
		nr_seq_caixa_od_rej, 
		nr_seq_saldo_caixa, 
		dt_referencia_saldo, 
		nr_lote_contabil, 
		ie_conciliacao, 
		nr_seq_lote, 
		ie_rejeitado) 
	values (nr_seq_movto_transf_w, 
		coalesce(dt_transacao_w,clock_timestamp()), 
		nr_seq_trans_financ_w, 
		vl_transacao_w, 
		clock_timestamp(), 
		nm_usuario_p, 
		nr_seq_caixa_destino_w, 
		nr_seq_caixa_destino_w, 
		nr_seq_caixa_w, 
		nr_seq_saldo_caixa_w, 
		dt_referencia_saldo_w, 
		0, 
		'N', 
		nr_seq_lote_w, 
		'N');
	 
	update	movto_trans_financ 
	set	nr_seq_movto_rejeitado	= nr_seq_movto_transf_w 
	where	nr_sequencia		= nr_seq_movto_p;
		 
	CALL atualizar_saldo_caixa(	cd_estabelecimento_p, 
				nr_seq_lote_w, 
				nr_seq_caixa_destino_w, 
				nm_usuario_p, 
				'N');
end if;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_transf_movto_rejeitado ( nr_seq_movto_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) FROM PUBLIC;

