-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_prorrogar_efetivacao ( nr_seq_item_p bigint, dt_efetivacao_p timestamp, ie_tipo_item_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint) AS $body$
DECLARE

/*	ie_tipo_item_p
	1 = Cliente
	2 = Solicitação
*/
dt_efetivacao_w			timestamp;
nr_seq_tipo_atividade_w		bigint;


BEGIN

select	coalesce(max(nr_sequencia),0)
into STRICT	nr_seq_tipo_atividade_w
from	pls_tipo_atividade
where	ie_prorrogacao_efetivacao 	= 'S'
and	cd_estabelecimento		= cd_estabelecimento_p;

if (nr_seq_tipo_atividade_w = 0) then
	CALL wheb_mensagem_pck.exibir_mensagem_abort( 267017, null); /* Não existe cadastro do tipo de histórico para o item prorrogação da efetivação. Verifique nos cadastros gerais do Tasy. */
end if;

if (ie_tipo_item_p	= 1) then
	select	dt_efetivacao
	into STRICT	dt_efetivacao_w
	from	pls_comercial_cliente
	where	nr_sequencia	= nr_seq_item_p;

	update	pls_comercial_cliente
	set	dt_efetivacao	= dt_efetivacao_p,
		nm_usuario	= nm_usuario_p,
		dt_atualizacao	= clock_timestamp()
	where	nr_sequencia	= nr_seq_item_p;

	insert into	pls_comercial_historico(	nr_sequencia,
							nr_seq_cliente,
							cd_estabelecimento,
							dt_atualizacao,
							nm_usuario,
							dt_atualizacao_nrec,
							nm_usuario_nrec,
							ds_titulo,
							ds_historico,
							dt_liberacao,
							nm_usuario_historico,
							ie_tipo_atividade,
							dt_historico)
						values (	nextval('pls_comercial_historico_seq'),
							nr_seq_item_p,
							cd_estabelecimento_p,
							clock_timestamp(),
							nm_usuario_p,
							clock_timestamp(),
							nm_usuario_p,
							'Prorrogação do prazo para efetivação do cliente',
							'Prorrogado o prazo para efetivação da data de ' || dt_efetivacao_w || ' para ' || dt_efetivacao_p || '.',
							clock_timestamp(),
							nm_usuario_p,
							nr_seq_tipo_atividade_w,
							clock_timestamp());
elsif (ie_tipo_item_p	= 2) then
	select	dt_efetivacao
	into STRICT	dt_efetivacao_w
	from	pls_solicitacao_comercial
	where	nr_sequencia	= nr_seq_item_p;

	update	pls_solicitacao_comercial
	set	dt_efetivacao	= dt_efetivacao_p,
		nm_usuario	= nm_usuario_p,
		dt_atualizacao	= clock_timestamp()
	where	nr_sequencia	= nr_seq_item_p;

	insert into	pls_solicitacao_historico(	nr_sequencia,
							nr_seq_solicitacao,
							ie_tipo_atividade,
							dt_historico,
							nm_usuario_historico,
							dt_atualizacao,
							nm_usuario,
							dt_atualizacao_nrec,
							nm_usuario_nrec,
							ds_historico,
							dt_liberacao,
							nm_usuario_liberacao)
						values (	nextval('pls_solicitacao_historico_seq'),
							nr_seq_item_p,
							nr_seq_tipo_atividade_w,
							clock_timestamp(),
							nm_usuario_p,
							clock_timestamp(),
							nm_usuario_p,
							clock_timestamp(),
							nm_usuario_p,
							'Prorrogado o prazo para efetivação da data de ' || dt_efetivacao_w || ' para ' || dt_efetivacao_p || '.',
							clock_timestamp(),
							nm_usuario_p);
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_prorrogar_efetivacao ( nr_seq_item_p bigint, dt_efetivacao_p timestamp, ie_tipo_item_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint) FROM PUBLIC;

