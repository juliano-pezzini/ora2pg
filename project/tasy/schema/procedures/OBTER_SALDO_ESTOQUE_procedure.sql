-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE obter_saldo_estoque ( cd_estabelecimento_p bigint, cd_material_p bigint, cd_local_estoque_p bigint, dt_mesano_referencia_p timestamp, qt_estoque_p INOUT bigint) AS $body$
DECLARE


cd_estabelecimento_w		smallint;
cd_material_w			integer;
dt_mesano_referencia_w		timestamp;
dt_mesano_vigente_w		timestamp;


BEGIN

cd_estabelecimento_w	:= cd_estabelecimento_p;

select 	coalesce(m.cd_material_estoque, m.cd_material)
into STRICT	cd_material_w
from 	material m
where 	m.cd_material	= cd_material_p;

if (dt_mesano_referencia_p IS NOT NULL AND dt_mesano_referencia_p::text <> '') and (dt_mesano_referencia_p > PKG_DATE_UTILS.ADD_MONTH(clock_timestamp(), - 120, 0)) then
	dt_mesano_referencia_w	:= dt_mesano_referencia_p;
else
	begin
	select	max(dt_mesano_vigente)
	into STRICT	dt_mesano_vigente_w
	from 	parametro_estoque
	where	cd_estabelecimento	= cd_estabelecimento_w;

	if (cd_local_estoque_p = 0) then
		select	/*+ index (s salesto_i2) */			coalesce(max(s.dt_mesano_referencia), pkg_date_utils.start_of(clock_timestamp(), 'MONTH', 0))
		into STRICT	dt_mesano_referencia_w
		from 	saldo_estoque s
		where	s.cd_estabelecimento	= cd_estabelecimento_p
		and 	s.cd_material		= cd_material_p
		and 	s.dt_mesano_referencia	>= dt_mesano_vigente_w;
	else
		select	/*+ index (s salesto_i2) */			coalesce(max(s.dt_mesano_referencia), pkg_date_utils.start_of(clock_timestamp(), 'MONTH', 0))
		into STRICT	dt_mesano_referencia_w
		from 	saldo_estoque s
		where	s.cd_estabelecimento	= cd_estabelecimento_p
		and 	s.cd_material		= cd_material_p
		and 	s.dt_mesano_referencia	>= dt_mesano_vigente_w
		and	s.cd_local_estoque	= cd_local_estoque_p;
	end if;

	end;
end if;

if (cd_local_estoque_p IS NOT NULL AND cd_local_estoque_p::text <> '') and (cd_local_estoque_p > 0) then
	begin
	Select 	s.qt_estoque
	into STRICT	qt_estoque_p
	from 	saldo_estoque s
	where 	s.cd_estabelecimento	= cd_estabelecimento_w
	and 	s.cd_material		= cd_material_w
	and 	s.dt_mesano_referencia	= dt_mesano_referencia_w
	and	s.cd_local_estoque	= cd_local_estoque_p;
	exception
	    when others then
		 	qt_estoque_p		:= 0;
	end;
else
	begin
	Select 	sum(s.qt_estoque)
	into STRICT	qt_estoque_p
	from 	saldo_estoque s
	where 	s.cd_estabelecimento	= cd_estabelecimento_w
	and 	s.cd_material		= cd_material_w
	and 	s.dt_mesano_referencia	= dt_mesano_referencia_w;
	exception
	    when others then
		 	qt_estoque_p		:= 0;
	end;
end if;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE obter_saldo_estoque ( cd_estabelecimento_p bigint, cd_material_p bigint, cd_local_estoque_p bigint, dt_mesano_referencia_p timestamp, qt_estoque_p INOUT bigint) FROM PUBLIC;

