-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_inserir_obs_regra_intercam ( nr_seq_req_item_p bigint, nr_seq_guia_item_p bigint, ie_tipo_item_p text, nm_usuario_p text) AS $body$
DECLARE


nr_seq_segurado_w		bigint;
ie_tipo_guia_w			varchar(4);
nr_seq_congenere_w		bigint;
cd_procedimento_w		bigint;
ie_origem_proced_w		bigint;
nr_seq_material_w		bigint;
ds_observacao_w			varchar(4000);
ds_observ_regra_w		varchar(4000);
nr_seq_regra_w			bigint;
nr_seq_requisicao_w		bigint;
cd_material_ops_w		varchar(20);
ds_observacao_itens_w		pls_requisicao_proc.ds_observacao%type;
ie_envia_obs_item_w		pls_regra_observ_interc.ie_envia_obs_item%type;
sg_estado_w			pessoa_juridica.sg_estado%type;
sg_estado_int_w			pessoa_juridica.sg_estado%type;
ie_nacional_w			pls_congenere.ie_nacional%type;
nr_seq_uni_exec_w		pls_requisicao.nr_seq_uni_exec%type;
cd_usuario_plano_w		pls_segurado_carteira.cd_usuario_plano%type;
cd_unimed_benef_w		varchar(4);
nr_seq_uni_benef_w		pls_requisicao.nr_seq_uni_exec%type;
ie_tipo_intercambio_w		varchar(1);
cd_estabelecimento_w		pls_requisicao.cd_estabelecimento%type;

C01 CURSOR FOR
	SELECT	cd_procedimento,
		ie_origem_proced,
		ds_observacao
	from	pls_requisicao_proc
	where	nr_sequencia	= nr_seq_req_item_p;

C02 CURSOR FOR
	SELECT	nr_seq_material,
		ds_observacao
	from	pls_requisicao_mat
	where	nr_sequencia	= nr_seq_req_item_p;


BEGIN

if (nr_seq_req_item_p IS NOT NULL AND nr_seq_req_item_p::text <> '') then
	if (ie_tipo_item_p	= 'P') then
		begin
			select	a.nr_sequencia,
				a.nr_seq_segurado,
				a.ie_tipo_guia,
				substr(a.ds_observacao,1,4000),
				pls_obter_dados_segurado(a.nr_seq_segurado, 'CR'),
				nr_seq_uni_exec,
				cd_estabelecimento
			into STRICT	nr_seq_requisicao_w,
				nr_seq_segurado_w,
				ie_tipo_guia_w,
				ds_observacao_w,
				cd_usuario_plano_w,
				nr_seq_uni_exec_w,
				cd_estabelecimento_w
			from	pls_requisicao_proc	b,
				pls_requisicao		a
			where	a.nr_sequencia	= b.nr_seq_requisicao
			and	b.nr_sequencia	= nr_seq_req_item_p;
		exception
		when others then
			nr_seq_requisicao_w	:= null;
			nr_seq_segurado_w	:= null;
			ie_tipo_guia_w		:= null;
			ds_observacao_w		:= null;
			cd_usuario_plano_w	:= null;
			nr_seq_uni_exec_w	:= null;
		end;
	elsif (ie_tipo_item_p	= 'M') then
		begin
			select	a.nr_sequencia,
				a.nr_seq_segurado,
				a.ie_tipo_guia,
				substr(a.ds_observacao,1,4000),
				pls_obter_dados_segurado(a.nr_seq_segurado, 'CR'),
				nr_seq_uni_exec,
				cd_estabelecimento
			into STRICT	nr_seq_requisicao_w,
				nr_seq_segurado_w,
				ie_tipo_guia_w,
				ds_observacao_w,
				cd_usuario_plano_w,
				nr_seq_uni_exec_w,
				cd_estabelecimento_w
			from	pls_requisicao_mat	b,
				pls_requisicao		a
			where	a.nr_sequencia	= b.nr_seq_requisicao
			and	b.nr_sequencia	= nr_seq_req_item_p;
		exception
		when others then
			nr_seq_requisicao_w	:= null;
			nr_seq_segurado_w	:= null;
			ie_tipo_guia_w		:= null;
			ds_observacao_w		:= null;
			cd_usuario_plano_w	:= null;
			nr_seq_uni_exec_w	:= null;
		end;
	end if;

	begin
		select	coalesce(nr_seq_congenere,0)
		into STRICT	nr_seq_congenere_w
		from	pls_segurado
		where	nr_sequencia	= nr_seq_segurado_w;
	exception
	when others then
		nr_seq_congenere_w	:= null;
	end;
	
	
	/* Obter a UF da operadora  - Tasy*/

	select	coalesce(max(sg_estado),'X')
	into STRICT	sg_estado_w
	from	pessoa_juridica
	where	cd_cgc	= (	SELECT	max(cd_cgc_outorgante)
				from	pls_outorgante
				where	cd_estabelecimento	= coalesce(cd_estabelecimento_w, wheb_usuario_pck.get_cd_estabelecimento));

	/* Obter a UF da operadora do beneficiario*/

	select	coalesce(max(a.sg_estado),'X'),
		coalesce(max(ie_nacional), 'N')
	into STRICT	sg_estado_int_w,
		ie_nacional_w
	from	pessoa_juridica	a,
		pls_congenere	b
	where	a.cd_cgc	= b.cd_cgc
	and	b.nr_sequencia	= nr_seq_congenere_w;
		

	if (ie_nacional_w	= 'S') then
		ie_tipo_intercambio_w := 'N';	-- Nacional
	elsif (sg_estado_w <> 'X') then
		if (sg_estado_int_w <> 'X') then
			if (sg_estado_w	= sg_estado_int_w) then
				ie_tipo_intercambio_w	:= 'E';
			else
				ie_tipo_intercambio_w	:= 'N';
			end if;
		elsif (cd_usuario_plano_w IS NOT NULL AND cd_usuario_plano_w::text <> '') then
					
			cd_unimed_benef_w	:= lpad(substr(cd_usuario_plano_w,1,4),4,'0');
			
			begin
				select	pls_obter_seq_cooperativa(max(b.cd_cooperativa))
				into STRICT	nr_seq_uni_benef_w
				from	pessoa_juridica a,
					pls_congenere	b
				where	b.cd_cgc = a.cd_cgc
				and	length(b.cd_cooperativa) >= 4
				and	b.cd_cooperativa = cd_unimed_benef_w;
			exception
			when others then
				nr_seq_uni_benef_w := nr_seq_uni_exec_w;
			end;
			
			
			if (nr_seq_uni_exec_w IS NOT NULL AND nr_seq_uni_exec_w::text <> '' AND nr_seq_uni_exec_w <> nr_seq_uni_benef_w) then
				ie_tipo_intercambio_w := pls_obter_tipo_intercambio(nr_seq_uni_benef_w, coalesce(cd_estabelecimento_w, wheb_usuario_pck.get_cd_estabelecimento));
			else
				ie_tipo_intercambio_w	:= 'A';
			end if;
		else
			ie_tipo_intercambio_w	:= 'A';
		end if;
	else
		ie_tipo_intercambio_w	:= 'A';
	end if;
end if;

if (ie_tipo_item_p	= 'P') then
	open C01;
	loop
	fetch C01 into	
		cd_procedimento_w,
		ie_origem_proced_w,
		ds_observacao_itens_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin
		if (pls_obter_se_controle_estab('RE') = 'S') then
			select	max(nr_sequencia)
			into STRICT	nr_seq_regra_w
			from	pls_regra_observ_interc
			where (coalesce(nr_seq_congenere::text, '') = '' or	nr_seq_congenere	= nr_seq_congenere_w)
			and (coalesce(ie_tipo_guia::text, '') = '' or	ie_tipo_guia		= ie_tipo_guia_w)
			and (coalesce(cd_procedimento::text, '') = ''	or	cd_procedimento		= cd_procedimento_w)
			and (coalesce(ie_origem_proced::text, '') = ''	or	ie_origem_proced	= ie_origem_proced_w)
			and	coalesce(nr_seq_material::text, '') = ''
			and	ie_situacao		= 'A'
			and 	cd_estabelecimento 	= wheb_usuario_pck.get_cd_estabelecimento
			and	((coalesce(ie_tipo_intercambio::text, '') = '' or	ie_tipo_intercambio	= 'A')
			or (ie_tipo_intercambio	= ie_tipo_intercambio_w));
		else
			select	max(nr_sequencia)
			into STRICT	nr_seq_regra_w
			from	pls_regra_observ_interc
			where (coalesce(nr_seq_congenere::text, '') = '' or	nr_seq_congenere	= nr_seq_congenere_w)
			and (coalesce(ie_tipo_guia::text, '') = '' or	ie_tipo_guia		= ie_tipo_guia_w)
			and (coalesce(cd_procedimento::text, '') = ''	or	cd_procedimento		= cd_procedimento_w)
			and (coalesce(ie_origem_proced::text, '') = ''	or	ie_origem_proced	= ie_origem_proced_w)
			and	coalesce(nr_seq_material::text, '') = ''
			and	ie_situacao		= 'A'
			and	((coalesce(ie_tipo_intercambio::text, '') = '' or	ie_tipo_intercambio	= 'A')
			or (ie_tipo_intercambio	= ie_tipo_intercambio_w));
		end if;

		if (coalesce(nr_seq_regra_w,0)	<> 0) then
			if (pls_obter_se_controle_estab('RE') = 'S') then
				select	substr(ds_observacao,1,4000),
					coalesce(ie_envia_obs_item, 'N')
				into STRICT	ds_observ_regra_w,
					ie_envia_obs_item_w
				from	pls_regra_observ_interc
				where	nr_sequencia	= nr_seq_regra_w
				and 	cd_estabelecimento 	= wheb_usuario_pck.get_cd_estabelecimento;
			else
				select	substr(ds_observacao,1,4000),
					coalesce(ie_envia_obs_item, 'N')
				into STRICT	ds_observ_regra_w,
					ie_envia_obs_item_w
				from	pls_regra_observ_interc
				where	nr_sequencia	= nr_seq_regra_w;
			end if;
			
			if (ie_envia_obs_item_w = 'S') then
				ds_observ_regra_w := ds_observ_regra_w || ds_observacao_itens_w;
			end if;

			if (ds_observ_regra_w IS NOT NULL AND ds_observ_regra_w::text <> '') then
				if (coalesce(ds_observacao_w::text, '') = '') then
					ds_observacao_w	:= substr(cd_procedimento_w||' - '||ds_observ_regra_w,1,4000);
				else
					ds_observacao_w	:= substr(ds_observacao_w||' '||cd_procedimento_w||' - '||ds_observ_regra_w,1,4000);
				end if;
				
				update	pls_requisicao
				set	ds_observacao	= substr(ds_observacao_w,1,4000)
				where	nr_sequencia	= nr_seq_requisicao_w;
			end if;
		end if;
		end;
	end loop;
	close C01;
elsif (ie_tipo_item_p	= 'M') then
	open C02;
	loop
	fetch C02 into	
		nr_seq_material_w,
		ds_observacao_itens_w;
	EXIT WHEN NOT FOUND; /* apply on C02 */
		begin
		if (pls_obter_se_controle_estab('RE') = 'S') then
			select	max(nr_sequencia)
			into STRICT	nr_seq_regra_w
			from	pls_regra_observ_interc
			where (coalesce(nr_seq_congenere::text, '') = '' or	nr_seq_congenere	= nr_seq_congenere_w)
			and (coalesce(ie_tipo_guia::text, '') = '' or	ie_tipo_guia		= ie_tipo_guia_w)
			and (coalesce(nr_seq_material::text, '') = ''	or	nr_seq_material		= nr_seq_material_w)
			and	coalesce(cd_procedimento::text, '') = ''
			and	ie_situacao		= 'A'
			and 	cd_estabelecimento 	= wheb_usuario_pck.get_cd_estabelecimento
			and	((coalesce(ie_tipo_intercambio::text, '') = '' or	ie_tipo_intercambio	= 'A')
			or (ie_tipo_intercambio	= ie_tipo_intercambio_w));
		else
			select	max(nr_sequencia)
			into STRICT	nr_seq_regra_w
			from	pls_regra_observ_interc
			where (coalesce(nr_seq_congenere::text, '') = '' or	nr_seq_congenere	= nr_seq_congenere_w)
			and (coalesce(ie_tipo_guia::text, '') = '' or	ie_tipo_guia		= ie_tipo_guia_w)
			and (coalesce(nr_seq_material::text, '') = ''	or	nr_seq_material		= nr_seq_material_w)
			and	coalesce(cd_procedimento::text, '') = ''
			and	ie_situacao		= 'A'
			and	((coalesce(ie_tipo_intercambio::text, '') = '' or	ie_tipo_intercambio	= 'A')
			or (ie_tipo_intercambio	= ie_tipo_intercambio_w));
		end if;
		
		if (coalesce(nr_seq_regra_w,0)	<> 0) then
			if (pls_obter_se_controle_estab('RE') = 'S') then
				select	substr(ds_observacao,1,4000),
					coalesce(ie_envia_obs_item, 'N')
				into STRICT	ds_observ_regra_w,
					ie_envia_obs_item_w
				from	pls_regra_observ_interc
				where	nr_sequencia	= nr_seq_regra_w
				and 	cd_estabelecimento 	= wheb_usuario_pck.get_cd_estabelecimento;
			else
				select	substr(ds_observacao,1,4000),
					coalesce(ie_envia_obs_item, 'N')
				into STRICT	ds_observ_regra_w,
					ie_envia_obs_item_w
				from	pls_regra_observ_interc
				where	nr_sequencia	= nr_seq_regra_w;
			end if;

			if (ie_envia_obs_item_w = 'S') then
				ds_observ_regra_w := ds_observ_regra_w || ds_observacao_itens_w;
			end if;

			if (ds_observ_regra_w IS NOT NULL AND ds_observ_regra_w::text <> '') then
				begin
					select	cd_material_ops
					into STRICT	cd_material_ops_w
					from	pls_material
					where	nr_sequencia	= nr_seq_material_w;
				exception
				when others then
					cd_material_ops_w	:= null;
				end;
			
				if (coalesce(ds_observacao_w::text, '') = '') then
					ds_observacao_w	:= substr(coalesce(cd_material_ops_w,nr_seq_material_w)||' - '||ds_observ_regra_w,1,4000);
				else
					ds_observacao_w	:= substr(ds_observacao_w||' '||coalesce(cd_material_ops_w,nr_seq_material_w)||' - '||ds_observ_regra_w,1,4000);
				end if;
				
				update	pls_requisicao
				set	ds_observacao	= substr(ds_observacao_w,1,4000)
				where	nr_sequencia	= nr_seq_requisicao_w;
			end if;
		end if;
		end;
	end loop;
	close C02;
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_inserir_obs_regra_intercam ( nr_seq_req_item_p bigint, nr_seq_guia_item_p bigint, ie_tipo_item_p text, nm_usuario_p text) FROM PUBLIC;

