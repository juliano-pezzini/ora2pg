-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_inserir_reaj_quota_parc (nr_seq_quota_parc_p bigint, nm_usuario_p text, nr_seq_lote_p bigint) AS $body$
DECLARE

nr_sequencia_w 		 double precision;
vl_parcela_orig_w   double precision;
nr_seq_escrituracao_w double precision;
dt_venc_anterior_w 	 timestamp;
vl_parcela_anterior_w varchar(255);
ie_retorno_w 		 varchar(256);


BEGIN 
 
if (nr_seq_quota_parc_p IS NOT NULL AND nr_seq_quota_parc_p::text <> '') and (nm_usuario_p IS NOT NULL AND nm_usuario_p::text <> '') and (nr_seq_lote_p IS NOT NULL AND nr_seq_lote_p::text <> '') then 
 begin 
 
	select max(vl_parcela), 
		  max(nr_seq_escrituracao), 
		  max(dt_vencimento) 
	into STRICT  vl_parcela_orig_w, 
		  nr_seq_escrituracao_w, 
		  dt_venc_anterior_w 
	from  pls_escrit_quota_parcela 
	where nr_sequencia = nr_seq_quota_parc_p;
 
	select coalesce(max(obter_dados_titulo_receber(nr_titulo,'V')), vl_parcela_orig_w) 
	into STRICT  vl_parcela_anterior_w 
	from  pls_escrit_quota_parcela 
	where nr_sequencia	  = nr_seq_quota_parc_p 
	and  dt_vencimento  = dt_venc_anterior_w;	
 
	select	nextval('pls_reaj_quota_parc_seq') 
	into STRICT	nr_sequencia_w 
	;
 
	if (nr_sequencia_w IS NOT NULL AND nr_sequencia_w::text <> '') and (vl_parcela_anterior_w IS NOT NULL AND vl_parcela_anterior_w::text <> '') and (vl_parcela_orig_w IS NOT NULL AND vl_parcela_orig_w::text <> '') then 
		begin 
		insert into pls_reaj_quota_parc(nr_sequencia,  
										dt_atualizacao, 
										nm_usuario,   
										nr_seq_lote,   
										vl_parcela_anterior, 
										vl_parcela_atual, 
										vl_parcela_orig, 
										vl_parcela_reajuste, 
										nr_seq_quota_parc) 
								 values (nr_sequencia_w, 
										clock_timestamp(), 
										nm_usuario_p, 
										nr_seq_lote_p, 
										vl_parcela_anterior_w, 
										0, 
										vl_parcela_orig_w, 
										0, 
										nr_seq_quota_parc_p);
		commit;									
		end;
	else if (coalesce(vl_parcela_anterior_w::text, '') = '') or (coalesce(vl_parcela_orig_w::text, '') = '') then 
			ie_retorno_w := 'Valor da Parcela';
	  end if;
	end if;
	 
	if (ie_retorno_w IS NOT NULL AND ie_retorno_w::text <> '') then 
	CALL wheb_mensagem_pck.exibir_mensagem_abort(279791, 'RETORNO='||ie_retorno_w);
	end if;
	end;
end if;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_inserir_reaj_quota_parc (nr_seq_quota_parc_p bigint, nm_usuario_p text, nr_seq_lote_p bigint) FROM PUBLIC;

