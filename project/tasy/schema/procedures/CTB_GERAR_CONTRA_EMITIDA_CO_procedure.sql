-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE ctb_gerar_contra_emitida_co ( nm_usuario_p usuario.nm_usuario%type, cd_empresa_p empresa.cd_empresa%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, dt_inicial_p ctb_livro_auxiliar.dt_inicial%type, dt_final_p ctb_livro_auxiliar.dt_final%type, ie_status_p ctb_livro_auxiliar.ie_tipo_livro_ecd%type, dt_liberacao_p ctb_livro_auxiliar.dt_liberacao%type, ie_gerar_arquivo_p ctb_livro_auxiliar.ie_tipo_livro_ecd%type, nr_seq_regra_p ctb_livro_auxiliar.nr_sequencia%type) AS $body$
DECLARE

					
dt_final_w					timestamp;
dt_recebimento_w				timestamp;
dt_inicial_w					timestamp;
ie_tipo_data_w					varchar(2);
ds_observacao_w					varchar(255);
nr_contador_w 					bigint := 0;
vl_multa_juros_w				double precision;
vl_recebido_w					double precision;
nr_seq_ctb_aux_emit_w				bigint;
vl_parcela_int_w				double precision := 0;
vl_parcela_w					double precision := 0;
vl_sobra_w					double precision := 0;
vl_sobra_recebido_w				double precision := 0;
nr_titulo_ant_w					bigint := 0;
ie_gerar_fat_contab_w				pls_parametro_faturamento.ie_gerar_fat_contab%type;
ie_data_rec_faturamento_w			pls_parametro_contabil.ie_data_rec_faturamento%type;
ie_gerar_ind_classif_w				ctb_livro_auxiliar.ie_gerar_ind_classif%type;
ie_tipo_segurado_w				pls_segurado.ie_tipo_segurado%type;
ie_tipo_compartilhamento_w			pls_segurado_repasse.ie_tipo_compartilhamento%type;
ie_tipo_repasse_w				pls_segurado_repasse.ie_tipo_repasse%type;
dt_repasse_w					pls_segurado_repasse.dt_repasse%type;
dt_fim_repasse_w				pls_segurado_repasse.dt_fim_repasse%type;
vl_tributos_mens_w				pls_mensalidade_trib.vl_tributo%type;
vl_tributo_w					titulo_receber_trib.vl_tributo%type;
vl_tributos_tit_w				titulo_receber_trib.vl_tributo%type;
ie_data_tipo_segurado_w				pls_parametros.ie_data_tipo_segurado%type;
ie_tipo_movimentacao_w				ctb_livro_auxiliar.ie_tipo_movimentacao%type;

ds_erro_w					varchar(255);
ds_local_w					varchar(255);
arq_texto_w					utl_file.file_type;
nm_arquivo_w					varchar(255);
ds_nome_livro_w					varchar(255);
ds_periodo_w					varchar(255);

c_linha CURSOR FOR
	SELECT	w.nr_titulo													|| ';' ||
		w.dt_emissao													|| ';' ||
		w.dt_vencimento													|| ';' ||
		substr(pls_obter_se_corresp_assumida(w.ie_tipo_segurado,w.nr_contrato),1,255)					|| ';' ||
		w.cd_beneficiario												|| ';' ||
		substr(obter_valor_dominio(6,pls_obter_se_benef_remido(w.nr_seq_segurado,w.dt_referencia)),1,255)		|| ';' ||
		w.nm_usuario_principal												|| ';' ||
		substr(obter_valor_dominio(2406,w.ie_tipo_segurado),1,255)							|| ';' ||
		substr(pls_obter_se_corresp_assumida(w.ie_tipo_segurado,w.cd_cpf_cnpj),1,255)					|| ';' ||
		w.ds_modalidade_contrat												|| ';' ||
		w.ds_regulamentacao												|| ';' ||
		w.ds_tipo_contratacao												|| ';' ||
		substr(pls_obter_se_corresp_assumida(w.ie_tipo_segurado,w.dt_contrato),1,255)					|| ';' ||
		w.dt_cancelamento												|| ';' ||
		w.ds_segmentacao												|| ';' ||
		w.ds_definicao_atos												|| ';' ||
		substr(pls_obter_se_corresp_assumida(w.ie_tipo_segurado,replace(w.nr_protocolo_ans,chr(039),'')),1,255)		|| ';' ||
		substr(coalesce(pls_obter_dados_pagador(nr_seq_pagador,'CPF'),pls_obter_dados_pagador(nr_seq_pagador,'CGC')),1, 40)	|| ';' ||
		substr(pls_obter_dados_pagador(nr_seq_pagador,'N'),1,255)							|| ';' ||
		w.dt_inicio_cobertura												|| ';' ||
		w.dt_fim_cobertura												|| ';' ||
		w.vl_parcela													|| ';' ||
		w.vl_contrato													|| ';' ||
		w.vl_apropriado 												|| ';' ||
		w.vl_rec_cobertura 												|| ';' ||
		w.vl_multa_juros 												|| ';' ||
		w.dt_baixa 													|| ';' ||
		d.cd_conta_contabil												|| ';' ||
		ctb_obter_classif_conta(d.cd_conta_contabil, d.cd_classificacao, d.dt_inicio_vigencia)				|| ';' ||
		c.cd_conta_contabil												|| ';' ||
		ctb_obter_classif_conta(c.cd_conta_contabil, c.cd_classificacao, c.dt_inicio_vigencia)				|| ';' ||
		e.cd_conta_contabil 												|| ';' ||
		ctb_obter_classif_conta(e.cd_conta_contabil, e.cd_classificacao, e.dt_inicio_vigencia)				|| ';' ||
		w.dt_referencia													|| ';' ||
		w.dt_contratacao												|| ';' ||
		w.dt_rescisao													|| ';' ||
		w.ds_tipo_documento												|| ';' ||
		w.nr_documento													|| ';' ||
		w.nr_parcela													|| ';' ||
		substr(obter_valor_dominio(3384, w.ie_tipo_repasse), 1,255)							|| ';' ||
		substr(obter_valor_dominio(8980, w.ie_tipo_compartilhamento), 1,255)						|| ';' ||
		w.dt_inicio_compartilhamento											|| ';' ||
		w.dt_fim_compartilhamento											|| ';' ||
		w.ds_observacao													ds_linha
	FROM w_ctb_aux_contra_emit w
LEFT OUTER JOIN conta_contabil c ON (w.cd_conta_contabil = c.cd_conta_contabil)
LEFT OUTER JOIN conta_contabil d ON (w.cd_conta_debito = d.cd_conta_contabil)
LEFT OUTER JOIN conta_contabil e ON (w.cd_conta_cred_encargos = e.cd_conta_contabil)
WHERE nr_seq_reg_auxiliar = nr_seq_regra_p order by (nr_documento)::numeric;
	
type vetor_ctb_aux_contra_emit is table of w_ctb_aux_contra_emit%rowtype index by integer;
ctb_aux_contra_emit_w	vetor_ctb_aux_contra_emit;	
	
c_titulo CURSOR FOR
	SELECT 	c.nr_contrato nr_contrato,
		c.dt_contrato dt_contrato,
		c.dt_rescisao_contrato dt_rescisao,
		p.ie_tipo_contratacao ie_tipo_contratacao,
		p.ie_segmentacao ie_segmentacao,
		p.ie_preco ie_modalidade_contrat,
		p.ie_regulamentacao ie_regulamentacao,
		substr(CASE WHEN p.ie_tipo_operacao='A' THEN  'SCA'  ELSE coalesce(p.nr_protocolo_ans, p.cd_scpa) END ,1,20) nr_protocolo_ans,
		'1' ie_definicao_atos,
		a.dt_inicio_cobertura dt_inicio_cobertura,
		a.dt_fim_cobertura dt_fim_cobertura,
		substr(pls_obter_dados_segurado(a.nr_seq_segurado,'C'),1,30) cd_beneficiario,
		substr(pls_obter_dados_segurado(a.nr_seq_segurado,'N'),1,255) nm_usuario_principal,
		substr(pls_obter_dados_segurado(a.nr_seq_segurado,'CPF'),1,255) cd_cpf_cnpj,
		t.nr_titulo nr_documento,
		t.nr_titulo nr_titulo,
		t.dt_emissao dt_emissao,
		substr(pls_obter_parcela_contrato(s.nr_seq_contrato,a.dt_mesano_referencia),1,10) nr_parcela,
		t.dt_vencimento dt_vencimento,
		i.cd_conta_ato_cooperado cd_conta_contabil,
		i.cd_conta_deb cd_conta_debito,
		i.cd_conta_contabil_ppcng cd_conta_cred_encargos,
		m.vl_mensalidade vl_mensalidade,
		sum(i.vl_ato_cooperado) vl_apropriado,
		l.dt_mesano_referencia dt_contabilizacao,
		s.nr_sequencia nr_seq_segurado,
		'TR' ie_tipo_documento,
		s.ie_tipo_segurado,
		t.vl_titulo,
		s.dt_contratacao,
		m.dt_cancelamento,
		null dt_ref_repasse,
		null nr_seq_congenere,
		s.dt_rescisao dt_rescisao_seg,
		m.nr_sequencia nr_seq_mensalidade,
		m.nr_seq_pagador nr_seq_pagador
	from	pls_lote_mensalidade 		l,
		pls_mensalidade 		m,
		pls_mensalidade_segurado 	a,
		pls_mensalidade_seg_item 	i,
		titulo_receber 			t,
		pls_segurado 			s,
		pls_contrato 			c,
		pls_plano 			p
	where	l.nr_sequencia 	= m.nr_seq_lote
	and	m.nr_sequencia 	= a.nr_seq_mensalidade
	and	a.nr_sequencia 	= i.nr_seq_mensalidade_seg
	and	m.nr_sequencia 	= t.nr_seq_mensalidade
	and	p.nr_sequencia 	= s.nr_seq_plano
	and	s.nr_sequencia 	= a.nr_seq_segurado
	and	c.nr_sequencia 	= s.nr_seq_contrato
	and	i.ie_tipo_item not in ('3', '6', '43')
	and	ie_tipo_movimentacao_w in ('M','A')
	and	not exists (	SELECT	1
				from 	titulo_receber_desdob z
				where	z.nr_titulo_dest = t.nr_titulo) -- Nao apresentar os titulos a receber originados do desdobramento. Ira trazer apenas o original.
	and	(((ie_status_p = 'N')
	and	((ie_tipo_data_w = 'E')
	and (l.dt_geracao between dt_inicial_w and dt_final_w)
	or (ie_tipo_data_w = 'C')
	and (l.dt_mesano_referencia between dt_inicial_w and dt_final_w))
	and (coalesce(m.dt_cancelamento::text, '') = ''))
	or	(ie_status_p = 'C' AND (
	or	)))
	and	coalesce(i.vl_ato_cooperado,0) <> 0
	and 	(i.cd_conta_ato_cooperado IS NOT NULL AND i.cd_conta_ato_cooperado::text <> '')
	and	((ie_gerar_ind_classif_w <> 'N')
	or	i.cd_conta_ato_cooperado in (	select 	cd_conta_contabil
						from	conta_contabil
						where	substr(ctb_obter_classif_conta(cd_conta_contabil, cd_classificacao, dt_inicio_vigencia),1,5) = '3.1.1'
						and	ie_tipo = 'A'))
	and	coalesce(cd_estabelecimento_p,t.cd_estabelecimento) = t.cd_estabelecimento
	and	coalesce(m.ie_cancelamento,'C') <> 'E'
	and	((coalesce(ie_tipo_segurado_w,'X') = coalesce(s.ie_tipo_segurado,'X'))
	or (coalesce(ie_tipo_segurado_w,'X') = 'X'))
	and	t.ie_pls = 'S'
	group by c.nr_contrato,
		c.dt_contrato,
		c.dt_rescisao_contrato,
		p.ie_tipo_contratacao,
		p.ie_segmentacao,
		p.ie_preco,
		p.ie_regulamentacao,
		substr(CASE WHEN p.ie_tipo_operacao='A' THEN  'SCA'  ELSE coalesce(p.nr_protocolo_ans, p.cd_scpa) END ,1,20),
		a.dt_inicio_cobertura,
		a.dt_fim_cobertura,
		substr(pls_obter_dados_segurado(a.nr_seq_segurado,'C'),1,30),
		substr(pls_obter_dados_segurado(a.nr_seq_segurado,'N'),1,255),
		substr(pls_obter_dados_segurado(a.nr_seq_segurado,'CPF'),1,255),
		t.nr_titulo,
		t.nr_titulo,
		t.dt_emissao,
		substr(pls_obter_parcela_contrato(s.nr_seq_contrato,a.dt_mesano_referencia),1,10),
		t.dt_vencimento,
		i.cd_conta_ato_cooperado,
		i.cd_conta_deb,
		i.cd_conta_contabil_ppcng,
		m.vl_mensalidade,
		a.dt_fim_cobertura,
		s.nr_sequencia,
		s.ie_tipo_segurado,
		t.vl_titulo,
		s.dt_contratacao,
		m.dt_cancelamento,
		l.dt_mesano_referencia,
		s.dt_rescisao,
		m.nr_sequencia,
		m.nr_seq_pagador
	
union all

	select 	c.nr_contrato nr_contrato,
		c.dt_contrato dt_contrato,
		c.dt_rescisao_contrato dt_rescisao,
		p.ie_tipo_contratacao ie_tipo_contratacao,
		p.ie_segmentacao ie_segmentacao,
		p.ie_preco ie_modalidade_contrat,
		p.ie_regulamentacao ie_regulamentacao,
		substr(CASE WHEN p.ie_tipo_operacao='A' THEN  'SCA'  ELSE coalesce(p.nr_protocolo_ans, p.cd_scpa) END ,1,20) nr_protocolo_ans,
		'2' ie_definicao_atos,
		a.dt_inicio_cobertura dt_inicio_cobertura,
		a.dt_fim_cobertura dt_fim_cobertura,
		substr(pls_obter_dados_segurado(a.nr_seq_segurado,'C'),1,30) cd_beneficiario,
		substr(pls_obter_dados_segurado(a.nr_seq_segurado,'N'),1,255) nm_usuario_principal,
		substr(pls_obter_dados_segurado(a.nr_seq_segurado,'CPF'),1,255) cd_cpf_cnpj,
		t.nr_titulo nr_documento,
		t.nr_titulo nr_titulo,
		t.dt_emissao dt_emissao,
		substr(pls_obter_parcela_contrato(s.nr_seq_contrato,a.dt_mesano_referencia),1,10) nr_parcela,
		t.dt_vencimento dt_vencimento,
		i.cd_conta_ato_auxiliar cd_conta_contabil,
		i.cd_conta_deb cd_conta_debito,
		i.cd_conta_contabil_ppcng cd_conta_cred_encargos,
		m.vl_mensalidade vl_mensalidade,
		sum(i.vl_ato_auxiliar) vl_apropriado,
		l.dt_mesano_referencia dt_contabilizacao,
		s.nr_sequencia nr_seq_segurado,
		'TR' ie_tipo_documento,
		s.ie_tipo_segurado,
		t.vl_titulo,
		s.dt_contratacao,
		m.dt_cancelamento,
		null dt_ref_repasse,
		null nr_seq_congenere,
		s.dt_rescisao,
		m.nr_sequencia,
		m.nr_seq_pagador nr_seq_pagador
	from	pls_lote_mensalidade 		l,
		pls_mensalidade 		m,
		pls_mensalidade_segurado 	a,
		pls_mensalidade_seg_item 	i,
		titulo_receber 			t,
		pls_segurado 			s,
		pls_contrato 			c,
		pls_plano 			p
	where	l.nr_sequencia 	= m.nr_seq_lote
	and	m.nr_sequencia 	= a.nr_seq_mensalidade
	and	a.nr_sequencia 	= i.nr_seq_mensalidade_seg
	and	m.nr_sequencia 	= t.nr_seq_mensalidade
	and	p.nr_sequencia 	= s.nr_seq_plano
	and	s.nr_sequencia 	= a.nr_seq_segurado
	and	c.nr_sequencia 	= s.nr_seq_contrato
	and	i.ie_tipo_item not in ('3', '6', '43')
	and	ie_tipo_movimentacao_w in ('M','A')
	and	not exists (	select	1
				from 	titulo_receber_desdob z
				where	z.nr_titulo_dest = t.nr_titulo) -- Nao apresentar os titulos a receber originados do desdobramento. Ira trazer apenas o original.
	and	(((ie_status_p = 'N')
	and	((ie_tipo_data_w = 'E')
	and (l.dt_geracao between dt_inicial_w and dt_final_w)
	or (ie_tipo_data_w = 'C')
	and (l.dt_mesano_referencia between dt_inicial_w and dt_final_w))
	and (coalesce(m.dt_cancelamento::text, '') = ''))
	or	(ie_status_p = 'C' AND (
	or	)))
	and	coalesce(i.vl_ato_auxiliar,0) <> 0
	and 	(i.cd_conta_ato_auxiliar IS NOT NULL AND i.cd_conta_ato_auxiliar::text <> '')
	and	((ie_gerar_ind_classif_w <> 'N')
	or	i.cd_conta_ato_auxiliar	in (	select 	cd_conta_contabil
						from	conta_contabil
						where	substr(ctb_obter_classif_conta(cd_conta_contabil, cd_classificacao, dt_inicio_vigencia),1,5) = '3.1.1'
						and	ie_tipo = 'A'))
	and	coalesce(cd_estabelecimento_p,t.cd_estabelecimento) = t.cd_estabelecimento
	and	coalesce(m.ie_cancelamento,'C') <> 'E'
	and	((coalesce(ie_tipo_segurado_w, 'X')	= coalesce(s.ie_tipo_segurado, 'X'))
	or (coalesce(ie_tipo_segurado_w, 'X')	= 'X'))
	and	t.ie_pls = 'S'
	group by c.nr_contrato,
		c.dt_contrato,
		c.dt_rescisao_contrato,
		p.ie_tipo_contratacao,
		p.ie_segmentacao,
		p.ie_preco,
		p.ie_regulamentacao,
		substr(CASE WHEN p.ie_tipo_operacao='A' THEN  'SCA'  ELSE coalesce(p.nr_protocolo_ans, p.cd_scpa) END ,1,20),
		a.dt_inicio_cobertura,
		a.dt_fim_cobertura,
		substr(pls_obter_dados_segurado(a.nr_seq_segurado,'C'),1,30) ,
		substr(pls_obter_dados_segurado(a.nr_seq_segurado,'N'),1,255),
		substr(pls_obter_dados_segurado(a.nr_seq_segurado,'CPF'),1,255),
		t.nr_titulo,
		t.dt_emissao,
		substr(pls_obter_parcela_contrato(s.nr_seq_contrato,a.dt_mesano_referencia),1,10),
		t.dt_vencimento,
		i.cd_conta_ato_auxiliar,
		i.cd_conta_deb,
		i.cd_conta_contabil_ppcng,
		m.vl_mensalidade,
		s.nr_sequencia,
		s.ie_tipo_segurado,
		t.vl_titulo,
		s.dt_contratacao,
		m.dt_cancelamento,
		l.dt_mesano_referencia,
		s.dt_rescisao,
		m.nr_sequencia,
		m.nr_seq_pagador
	
union all

	select 	c.nr_contrato nr_contrato,
		c.dt_contrato dt_contrato,
		c.dt_rescisao_contrato dt_rescisao,
		p.ie_tipo_contratacao ie_tipo_contratacao,
		p.ie_segmentacao ie_segmentacao,
		p.ie_preco ie_modalidade_contrat,
		p.ie_regulamentacao ie_regulamentacao,
		substr(CASE WHEN p.ie_tipo_operacao='A' THEN  'SCA'  ELSE coalesce(p.nr_protocolo_ans, p.cd_scpa) END ,1,20) nr_protocolo_ans,
		'3' ie_definicao_atos,
		a.dt_inicio_cobertura dt_inicio_cobertura,
		a.dt_fim_cobertura dt_fim_cobertura,
		substr(pls_obter_dados_segurado(a.nr_seq_segurado,'C'),1,30) cd_beneficiario,
		substr(pls_obter_dados_segurado(a.nr_seq_segurado,'N'),1,255) nm_usuario_principal,
		substr(pls_obter_dados_segurado(a.nr_seq_segurado,'CPF'),1,255) cd_cpf_cnpj,
		t.nr_titulo nr_documento,
		t.nr_titulo nr_titulo,
		t.dt_emissao dt_emissao,
		substr(pls_obter_parcela_contrato(s.nr_seq_contrato,a.dt_mesano_referencia),1,10) nr_parcela,
		t.dt_vencimento dt_vencimento,
		i.cd_conta_ato_nao_coop cd_conta_contabil,
		i.cd_conta_deb cd_conta_debito,
		i.cd_conta_contabil_ppcng cd_conta_cred_encargos,
		m.vl_mensalidade vl_mensalidade,
		sum(i.vl_ato_nao_cooperado) vl_apropriado,
		l.dt_mesano_referencia dt_contabilizacao,
		s.nr_sequencia nr_seq_segurado,
		'TR' ie_tipo_documento,
		s.ie_tipo_segurado,
		t.vl_titulo,
		s.dt_contratacao,
		m.dt_cancelamento,
		null dt_ref_repasse,
		null nr_seq_congenere,
		s.dt_rescisao,
		m.nr_sequencia,
		m.nr_seq_pagador
	from	pls_lote_mensalidade 		l,
		pls_mensalidade 		m,
		pls_mensalidade_segurado 	a,
		pls_mensalidade_seg_item 	i,
		titulo_receber 			t,
		pls_segurado 			s,
		pls_contrato 			c,
		pls_plano 			p
	where	l.nr_sequencia 	= m.nr_seq_lote
	and	m.nr_sequencia 	= a.nr_seq_mensalidade
	and	a.nr_sequencia 	= i.nr_seq_mensalidade_seg
	and	m.nr_sequencia 	= t.nr_seq_mensalidade
	and	p.nr_sequencia 	= s.nr_seq_plano
	and	s.nr_sequencia 	= a.nr_seq_segurado
	and	c.nr_sequencia 	= s.nr_seq_contrato
	and	i.ie_tipo_item not in ('3', '6', '43')
	and	ie_tipo_movimentacao_w in ('M','A')
	and	not exists (	select	1
				from 	titulo_receber_desdob z
				where	z.nr_titulo_dest = t.nr_titulo) -- Nao apresentar os titulos a receber originados do desdobramento. Ira trazer apenas o original.
	and	(((ie_status_p = 'N')
	and	((ie_tipo_data_w = 'E')
	and (l.dt_geracao between dt_inicial_w and dt_final_w)
	or (ie_tipo_data_w = 'C')
	and (l.dt_mesano_referencia between dt_inicial_w and dt_final_w))
	and (coalesce(m.dt_cancelamento::text, '') = ''))
	or	(ie_status_p = 'C' AND (
	or	)))
	and	coalesce(i.vl_ato_nao_cooperado,0) <> 0
	and 	(i.cd_conta_ato_nao_coop IS NOT NULL AND i.cd_conta_ato_nao_coop::text <> '')
	and	((ie_gerar_ind_classif_w <> 'N')
	or	i.cd_conta_ato_nao_coop	in (	select 	cd_conta_contabil
						from	conta_contabil
						where	substr(ctb_obter_classif_conta(cd_conta_contabil, cd_classificacao, dt_inicio_vigencia),1,5) = '3.1.1'
						and	ie_tipo = 'A'))
	and	coalesce(cd_estabelecimento_p,t.cd_estabelecimento) = t.cd_estabelecimento
	and	coalesce(m.ie_cancelamento,'C') <> 'E'
	and	((coalesce(ie_tipo_segurado_w, 'X')	= coalesce(s.ie_tipo_segurado, 'X'))
	or (coalesce(ie_tipo_segurado_w, 'X')	= 'X'))
	and	t.ie_pls = 'S'
	group by c.nr_contrato,
		c.dt_contrato,
		c.dt_rescisao_contrato,
		p.ie_tipo_contratacao,
		p.ie_segmentacao,
		p.ie_preco,
		p.ie_regulamentacao,
		substr(CASE WHEN p.ie_tipo_operacao='A' THEN  'SCA'  ELSE coalesce(p.nr_protocolo_ans, p.cd_scpa) END ,1,20),
		a.dt_inicio_cobertura,
		a.dt_fim_cobertura,
		substr(pls_obter_dados_segurado(a.nr_seq_segurado,'C'),1,30),
		substr(pls_obter_dados_segurado(a.nr_seq_segurado,'N'),1,255),
		substr(pls_obter_dados_segurado(a.nr_seq_segurado,'CPF'),1,255),
		t.nr_titulo,
		t.dt_emissao,
		substr(pls_obter_parcela_contrato(s.nr_seq_contrato,a.dt_mesano_referencia),1,10),
		t.dt_vencimento,
		i.cd_conta_ato_nao_coop,
		i.cd_conta_deb,
		i.cd_conta_contabil_ppcng,
		m.vl_mensalidade,
		s.nr_sequencia,
		s.ie_tipo_segurado,
		t.vl_titulo,
		s.dt_contratacao,
		m.dt_cancelamento,
		l.dt_mesano_referencia,
		s.dt_rescisao,
		m.nr_sequencia,
		m.nr_seq_pagador
	
union all

	select 	c.nr_contrato nr_contrato,
		c.dt_contrato dt_contrato,
		c.dt_rescisao_contrato dt_rescisao,
		p.ie_tipo_contratacao ie_tipo_contratacao,
		p.ie_segmentacao ie_segmentacao,
		p.ie_preco ie_modalidade_contrat,
		p.ie_regulamentacao ie_regulamentacao,
		substr(CASE WHEN p.ie_tipo_operacao='A' THEN  'SCA'  ELSE coalesce(p.nr_protocolo_ans, p.cd_scpa) END ,1,20) nr_protocolo_ans,
		null ie_definicao_atos,
		a.dt_inicio_cobertura dt_inicio_cobertura,
		a.dt_fim_cobertura dt_fim_cobertura,
		substr(pls_obter_dados_segurado(a.nr_seq_segurado,'C'),1,30) cd_beneficiario,
		substr(pls_obter_dados_segurado(a.nr_seq_segurado,'N'),1,255) nm_usuario_principal,
		substr(pls_obter_dados_segurado(a.nr_seq_segurado,'CPF'),1,255) cd_cpf_cnpj,
		t.nr_titulo nr_documento,
		t.nr_titulo nr_titulo,
		t.dt_emissao dt_emissao,
		substr(pls_obter_parcela_contrato(s.nr_seq_contrato,a.dt_mesano_referencia),1,10) nr_parcela,
		t.dt_vencimento dt_vencimento,
		i.cd_conta_rec cd_conta_contabil,
		i.cd_conta_deb cd_conta_debito,
		i.cd_conta_contabil_ppcng cd_conta_cred_encargos,
		m.vl_mensalidade vl_mensalidade,
		sum(i.vl_item) vl_apropriado,
		l.dt_mesano_referencia dt_contabilizacao,
		s.nr_sequencia nr_seq_segurado,
		'TR' ie_tipo_documento,
		s.ie_tipo_segurado,
		t.vl_titulo,
		s.dt_contratacao,
		m.dt_cancelamento,
		null dt_ref_repasse,
		null nr_seq_congenere,
		s.dt_rescisao,
		m.nr_sequencia,
		m.nr_seq_pagador nr_seq_pagador
	from	pls_lote_mensalidade 		l,
		pls_mensalidade 		m,
		pls_mensalidade_segurado 	a,
		pls_mensalidade_seg_item 	i,
		titulo_receber 			t,
		pls_segurado 			s,
		pls_contrato 			c,
		pls_plano 			p
	where	l.nr_sequencia 	= m.nr_seq_lote
	and	m.nr_sequencia 	= a.nr_seq_mensalidade
	and	a.nr_sequencia 	= i.nr_seq_mensalidade_seg
	and	m.nr_sequencia 	= t.nr_seq_mensalidade
	and	p.nr_sequencia 	= s.nr_seq_plano
	and	s.nr_sequencia 	= a.nr_seq_segurado
	and	c.nr_sequencia 	= s.nr_seq_contrato
	and	i.ie_tipo_item not in ('3', '6', '43')
	and	ie_tipo_movimentacao_w in ('M','A')
	and	not exists (	select	1
				from 	titulo_receber_desdob z
				where	z.nr_titulo_dest = t.nr_titulo) -- Nao apresentar os titulos a receber originados do desdobramento. Ira trazer apenas o original.
	and	(((ie_status_p = 'N')
	and	((ie_tipo_data_w = 'E')
	and (l.dt_geracao between dt_inicial_w and dt_final_w)
	or (ie_tipo_data_w = 'C')
	and (l.dt_mesano_referencia between dt_inicial_w and dt_final_w))
	and (coalesce(m.dt_cancelamento::text, '') = ''))
	or	(ie_status_p = 'C' AND (
	or	)))
	and	coalesce(i.vl_item,0) <> 0
	and	coalesce(cd_conta_ato_auxiliar::text, '') = ''
	and	coalesce(cd_conta_ato_cooperado::text, '') = ''
	and	coalesce(cd_conta_ato_nao_coop::text, '') = ''
	and	((ie_gerar_ind_classif_w <> 'N')
	or	i.cd_conta_rec	in (	select 	cd_conta_contabil
					from	conta_contabil
					where	substr(ctb_obter_classif_conta(cd_conta_contabil, cd_classificacao, dt_inicio_vigencia),1,5) = '3.1.1'
					and	ie_tipo = 'A'))
	and	coalesce(cd_estabelecimento_p,t.cd_estabelecimento) = t.cd_estabelecimento
	and	coalesce(m.ie_cancelamento,'C') <> 'E'
	and	((coalesce(ie_tipo_segurado_w, 'X')	= coalesce(s.ie_tipo_segurado, 'X'))
	or (coalesce(ie_tipo_segurado_w, 'X')	= 'X'))
	and	t.ie_pls = 'S'
	group by c.nr_contrato,
		c.dt_contrato,
		c.dt_rescisao_contrato,
		p.ie_tipo_contratacao,
		p.ie_segmentacao,
		p.ie_preco,
		p.ie_regulamentacao,
		substr(CASE WHEN p.ie_tipo_operacao='A' THEN  'SCA'  ELSE coalesce(p.nr_protocolo_ans, p.cd_scpa) END ,1,20),
		a.dt_inicio_cobertura,
		a.dt_fim_cobertura,
		substr(pls_obter_dados_segurado(a.nr_seq_segurado,'C'),1,30),
		substr(pls_obter_dados_segurado(a.nr_seq_segurado,'N'),1,255),
		substr(pls_obter_dados_segurado(a.nr_seq_segurado,'CPF'),1,255),
		t.nr_titulo,
		t.dt_emissao,
		substr(pls_obter_parcela_contrato(s.nr_seq_contrato,a.dt_mesano_referencia),1,10),
		t.dt_vencimento,
		i.cd_conta_rec,
		i.cd_conta_deb,
		i.cd_conta_contabil_ppcng,
		m.vl_mensalidade,
		a.dt_fim_cobertura,
		s.nr_sequencia,
		s.ie_tipo_segurado,
		t.vl_titulo,
		s.dt_contratacao,
		m.dt_cancelamento,
		l.dt_mesano_referencia,
		s.dt_rescisao,
		m.nr_sequencia,
		m.nr_seq_pagador
	
union all
	
	select  c.nr_contrato nr_contrato,
		c.dt_contrato dt_contrato,
		c.dt_rescisao_contrato dt_rescisao,
		p.ie_tipo_contratacao ie_tipo_contratacao,
		p.ie_segmentacao ie_segmentacao,
		p.ie_preco ie_modalidade_contrat,
		p.ie_regulamentacao ie_regulamentacao,
		substr(CASE WHEN p.ie_tipo_operacao='A' THEN  'SCA'  ELSE coalesce(p.nr_protocolo_ans, p.cd_scpa) END ,1,20) nr_protocolo_ans,
		null ie_definicao_atos,
		a.dt_inicio_cobertura dt_inicio_cobertura,
		a.dt_fim_cobertura dt_fim_cobertura,
		substr(pls_obter_dados_segurado(a.nr_seq_segurado,'C'),1,30) cd_beneficiario,
		substr(pls_obter_dados_segurado(a.nr_seq_segurado,'N'),1,255) nm_usuario_principal,
		substr(pls_obter_dados_segurado(a.nr_seq_segurado,'CPF'),1,255) cd_cpf_cnpj,
		t.nr_titulo nr_documento,
		t.nr_titulo nr_titulo,
		t.dt_emissao dt_emissao,
		substr(pls_obter_parcela_contrato(s.nr_seq_contrato,a.dt_mesano_referencia),1,10) nr_parcela,
		t.dt_vencimento dt_vencimento,
		d.cd_conta_cred cd_conta_contabil,
		d.cd_conta_deb cd_conta_debito,
		i.cd_conta_contabil_ppcng cd_conta_cred_encargos,
		m.vl_mensalidade vl_mensalidade,
		sum(o.vl_item) vl_apropriado,
		l.dt_mesano_referencia dt_contabilizacao,
		s.nr_sequencia nr_seq_segurado,
		'TR' ie_tipo_documento,
		b.ie_tipo_segurado,
		t.vl_titulo,
		s.dt_contratacao,
		m.dt_cancelamento,
		CASE WHEN ie_data_tipo_segurado_w='P' THEN  f.dt_mes_competencia  ELSE (	select	y.dt_procedimento										from	pls_conta_proc y										where	y.nr_sequencia = d.nr_seq_conta_proc										
union
										select	y.dt_atendimento										from	pls_conta_mat y										where	y.nr_sequencia = d.nr_seq_conta_mat) END  dt_ref_repasse,
		f.nr_seq_congenere,
		s.dt_rescisao,
		m.nr_sequencia,
		m.nr_seq_pagador nr_seq_pagador
	from	pls_lote_mensalidade 		l,
		pls_mensalidade 		m,
		pls_mensalidade_segurado 	a,
		pls_mensalidade_seg_item 	i,
		titulo_receber 			t,
		pls_segurado 			s,
		pls_contrato 			c,
		pls_plano 			p,
		pls_protocolo_conta 		f,
		pls_conta 			b,
		pls_conta_coparticipacao 	d,
		pls_mensalidade_item_conta	o
	where	l.nr_sequencia = m.nr_seq_lote
	and	m.nr_sequencia = a.nr_seq_mensalidade
	and	a.nr_sequencia = i.nr_seq_mensalidade_seg
	and	m.nr_sequencia = t.nr_seq_mensalidade
	and	p.nr_sequencia = b.nr_seq_plano
	and	s.nr_sequencia = a.nr_seq_segurado
	and	c.nr_sequencia = s.nr_seq_contrato
	and	f.nr_sequencia = b.nr_seq_protocolo
	and	b.nr_sequencia = d.nr_seq_conta
	and	b.nr_sequencia = i.nr_seq_conta	
	and	i.nr_sequencia	= o.nr_seq_item
	and	d.nr_sequencia	= o.nr_seq_conta_copartic
	and	i.ie_tipo_item = '3'
	and	ie_tipo_movimentacao_w in ('M','A')
	and	not exists (	select	1
				from 	titulo_receber_desdob z
				where	z.nr_titulo_dest = t.nr_titulo) -- Nao apresentar os titulos a receber originados do desdobramento. Ira trazer apenas o original.
	and	(((ie_status_p = 'N')
	and	((ie_tipo_data_w = 'E')
	and (l.dt_geracao between dt_inicial_w and dt_final_w)
	or (ie_tipo_data_w = 'C')
	and (l.dt_mesano_referencia between dt_inicial_w and dt_final_w))
	and (coalesce(m.dt_cancelamento::text, '') = ''))
	or	(ie_status_p = 'C' AND (
	or	)))
	and	((ie_gerar_ind_classif_w <> 'N')
	or	d.cd_conta_deb in (	select 	cd_conta_contabil
					from	conta_contabil
					where	substr(ctb_obter_classif_conta(cd_conta_contabil, cd_classificacao, dt_inicio_vigencia),1,5) = '1.2.3'
					and	ie_tipo = 'A'))
	and	coalesce(o.vl_item,0) <> 0
	and	coalesce(cd_estabelecimento_p,t.cd_estabelecimento) = t.cd_estabelecimento
	and	coalesce(m.ie_cancelamento,'C') <> 'E'
	and	((coalesce(ie_tipo_segurado_w, 'X')	= coalesce(b.ie_tipo_segurado, 'X'))
	or (coalesce(ie_tipo_segurado_w, 'X')	= 'X'))
	and	t.ie_pls = 'S'
	group by  c.nr_contrato,
		c.dt_contrato,
		c.dt_rescisao_contrato,
		p.ie_tipo_contratacao,
		p.ie_segmentacao,
		p.ie_preco,
		p.ie_regulamentacao,
		substr(CASE WHEN p.ie_tipo_operacao='A' THEN  'SCA'  ELSE coalesce(p.nr_protocolo_ans, p.cd_scpa) END ,1,20),
		a.dt_inicio_cobertura,
		a.dt_fim_cobertura,
		substr(pls_obter_dados_segurado(a.nr_seq_segurado,'C'),1,30),
		substr(pls_obter_dados_segurado(a.nr_seq_segurado,'N'),1,255),
		substr(pls_obter_dados_segurado(a.nr_seq_segurado,'CPF'),1,255),
		t.nr_titulo,
		t.nr_titulo,
		t.dt_emissao,
		substr(pls_obter_parcela_contrato(s.nr_seq_contrato,a.dt_mesano_referencia),1,10),
		t.dt_vencimento,
		d.cd_conta_cred,
		d.cd_conta_deb,
		i.cd_conta_contabil_ppcng,
		m.vl_mensalidade,
		t.vl_titulo,
		s.nr_sequencia,
		b.ie_tipo_segurado,
		t.vl_titulo,
		s.dt_contratacao,
		m.dt_cancelamento,
		f.dt_mes_competencia,
		l.dt_mesano_referencia,
		d.nr_seq_conta_proc,
		d.nr_seq_conta_mat,
		f.nr_seq_congenere,
		s.dt_rescisao,
		m.nr_sequencia,
		m.nr_seq_pagador
	
union all
	
	select  c.nr_contrato nr_contrato,
		c.dt_contrato dt_contrato,
		c.dt_rescisao_contrato dt_rescisao,
		p.ie_tipo_contratacao ie_tipo_contratacao,
		p.ie_segmentacao ie_segmentacao,
		p.ie_preco ie_modalidade_contrat,
		p.ie_regulamentacao ie_regulamentacao,
		substr(CASE WHEN p.ie_tipo_operacao='A' THEN  'SCA'  ELSE coalesce(p.nr_protocolo_ans, p.cd_scpa) END ,1,20) nr_protocolo_ans,
		null ie_definicao_atos,
		a.dt_inicio_cobertura dt_inicio_cobertura,
		a.dt_fim_cobertura dt_fim_cobertura,
		substr(pls_obter_dados_segurado(a.nr_seq_segurado,'C'),1,30) cd_beneficiario,
		substr(pls_obter_dados_segurado(a.nr_seq_segurado,'N'),1,255) nm_usuario_principal,
		substr(pls_obter_dados_segurado(a.nr_seq_segurado,'CPF'),1,255) cd_cpf_cnpj,
		t.nr_titulo nr_documento,
		t.nr_titulo nr_titulo,
		t.dt_emissao dt_emissao,
		substr(pls_obter_parcela_contrato(s.nr_seq_contrato,a.dt_mesano_referencia),1,10) nr_parcela,
		t.dt_vencimento dt_vencimento,
		d.cd_conta_cred cd_conta_contabil,
		d.cd_conta_deb cd_conta_debito,
		i.cd_conta_contabil_ppcng cd_conta_cred_encargos,
		m.vl_mensalidade vl_mensalidade,
		sum(d.vl_coparticipacao) vl_apropriado,
		l.dt_mesano_referencia dt_contabilizacao,
		s.nr_sequencia nr_seq_segurado,
		'TR' ie_tipo_documento,
		b.ie_tipo_segurado,
		t.vl_titulo,
		s.dt_contratacao,
		m.dt_cancelamento,
		CASE WHEN ie_data_tipo_segurado_w='P' THEN  f.dt_mes_competencia  ELSE (	select	y.dt_procedimento										from	pls_conta_proc y										where	y.nr_sequencia = d.nr_seq_conta_proc										
union
										select	y.dt_atendimento										from	pls_conta_mat y										where	y.nr_sequencia = d.nr_seq_conta_mat) END  dt_ref_repasse,
		f.nr_seq_congenere,
		s.dt_rescisao,
		m.nr_sequencia,
		m.nr_seq_pagador nr_seq_pagador
	from	pls_lote_mensalidade 		l,
		pls_mensalidade 		m,
		pls_mensalidade_segurado 	a,
		pls_mensalidade_seg_item 	i,
		titulo_receber 			t,
		pls_segurado 			s,
		pls_contrato 			c,
		pls_plano 			p,
		pls_protocolo_conta 		f,
		pls_conta 			b,
		pls_conta_coparticipacao 	d
	where	l.nr_sequencia = m.nr_seq_lote
	and	m.nr_sequencia = a.nr_seq_mensalidade
	and	a.nr_sequencia = i.nr_seq_mensalidade_seg
	and	m.nr_sequencia = t.nr_seq_mensalidade
	and	p.nr_sequencia = b.nr_seq_plano
	and	s.nr_sequencia = a.nr_seq_segurado
	and	c.nr_sequencia = s.nr_seq_contrato
	and	f.nr_sequencia = b.nr_seq_protocolo
	and	b.nr_sequencia = d.nr_seq_conta
	and	b.nr_sequencia = i.nr_seq_conta
	and (m.ie_cancelamento in ('C', 'E')
	or	a.nr_sequencia = d.nr_seq_mensalidade_seg)
	and	i.ie_tipo_item = '3'
	and	ie_tipo_movimentacao_w in ('M','A')
	and	not exists (	select	1
				from 	titulo_receber_desdob z
				where	z.nr_titulo_dest = t.nr_titulo) -- Nao apresentar os titulos a receber originados do desdobramento. Ira trazer apenas o original.
	and	(((ie_status_p = 'N')
	and	((ie_tipo_data_w = 'E')
	and (l.dt_geracao between dt_inicial_w and dt_final_w)
	or (ie_tipo_data_w = 'C')
	and (l.dt_mesano_referencia between dt_inicial_w and dt_final_w))
	and (coalesce(m.dt_cancelamento::text, '') = ''))
	or	(ie_status_p = 'C' AND (
	or	)))
	and	((ie_gerar_ind_classif_w <> 'N')
	or	d.cd_conta_deb in (	select 	cd_conta_contabil
					from	conta_contabil
					where	substr(ctb_obter_classif_conta(cd_conta_contabil, cd_classificacao, dt_inicio_vigencia),1,5) = '1.2.3'
					and	ie_tipo = 'A'))
	and	coalesce(d.vl_coparticipacao,0) <> 0
	and	coalesce(cd_estabelecimento_p,t.cd_estabelecimento) = t.cd_estabelecimento
	and	coalesce(m.ie_cancelamento,'C') <> 'E'
	and 	not exists (	select	1 
				from 	pls_mensalidade_item_conta o
				where	o.nr_seq_conta_copartic	= d.nr_sequencia)
	and	((coalesce(ie_tipo_segurado_w, 'X')	= coalesce(b.ie_tipo_segurado, 'X'))
	or (coalesce(ie_tipo_segurado_w, 'X')	= 'X'))
	and	t.ie_pls = 'S'
	group by  c.nr_contrato,
		c.dt_contrato,
		c.dt_rescisao_contrato,
		p.ie_tipo_contratacao,
		p.ie_segmentacao,
		p.ie_preco,
		p.ie_regulamentacao,
		substr(CASE WHEN p.ie_tipo_operacao='A' THEN  'SCA'  ELSE coalesce(p.nr_protocolo_ans, p.cd_scpa) END ,1,20),
		a.dt_inicio_cobertura,
		a.dt_fim_cobertura,
		substr(pls_obter_dados_segurado(a.nr_seq_segurado,'C'),1,30),
		substr(pls_obter_dados_segurado(a.nr_seq_segurado,'N'),1,255),
		substr(pls_obter_dados_segurado(a.nr_seq_segurado,'CPF'),1,255),
		t.nr_titulo,
		t.nr_titulo,
		t.dt_emissao,
		substr(pls_obter_parcela_contrato(s.nr_seq_contrato,a.dt_mesano_referencia),1,10),
		t.dt_vencimento,
		d.cd_conta_cred,
		d.cd_conta_deb,
		i.cd_conta_contabil_ppcng,
		m.vl_mensalidade,
		t.vl_titulo,
		s.nr_sequencia,
		b.ie_tipo_segurado,
		t.vl_titulo,
		s.dt_contratacao,
		m.dt_cancelamento,
		f.dt_mes_competencia,
		l.dt_mesano_referencia,
		d.nr_seq_conta_proc,
		d.nr_seq_conta_mat,
		f.nr_seq_congenere,
		s.dt_rescisao,
		m.nr_sequencia,
		m.nr_seq_pagador
	
union all

	select 	c.nr_contrato nr_contrato,
		c.dt_contrato dt_contrato,
		c.dt_rescisao_contrato dt_rescisao,
		p.ie_tipo_contratacao ie_tipo_contratacao,
		p.ie_segmentacao ie_segmentacao,
		p.ie_preco ie_modalidade_contrat, 
		p.ie_regulamentacao ie_regulamentacao,
		substr(CASE WHEN p.ie_tipo_operacao='A' THEN  'SCA'  ELSE coalesce(p.nr_protocolo_ans, p.cd_scpa) END ,1,20) nr_protocolo_ans, 
		null ie_definicao_atos, 
		a.dt_inicio_cobertura dt_inicio_cobertura,
		a.dt_fim_cobertura dt_fim_cobertura,
		substr(pls_obter_dados_segurado(a.nr_seq_segurado,'CR'),1,30) cd_beneficiario,
		substr(pls_obter_dados_segurado(a.nr_seq_segurado,'N'),1,255) nm_usuario_principal,
		substr(pls_obter_dados_pagador(m.nr_seq_pagador,'CPF'),1,255) cd_cpf_cnpj,
		t.nr_titulo nr_documento,
		t.nr_titulo nr_titulo,
		t.dt_emissao dt_emissao,
		substr(pls_obter_parcela_contrato(s.nr_seq_contrato,a.dt_mesano_referencia),1,10) nr_parcela,
		t.dt_vencimento dt_vencimento,
		d.cd_conta_cred cd_conta_contabil,
		d.cd_conta_deb cd_conta_debito,
		null cd_conta_cred_encargos,
		m.vl_mensalidade vl_mensalidade,
		sum(d.vl_beneficiario) vl_apropriado,
		l.dt_contabilizacao dt_contabilizacao,
		a.nr_seq_segurado nr_seq_segurado,
		'CM' ie_tipo_documento,
		b.ie_tipo_segurado,
		t.vl_titulo vl_titulo,
		s.dt_contratacao,
		m.dt_cancelamento,
		CASE WHEN ie_data_tipo_segurado_w='P' THEN  f.dt_mes_competencia  ELSE (	select	y.dt_procedimento										from	pls_conta_proc y										where	y.nr_sequencia = d.nr_seq_conta_proc										
union
										select	y.dt_atendimento										from	pls_conta_mat y										where	y.nr_sequencia = d.nr_seq_conta_mat) END  dt_ref_repasse,
		f.nr_seq_congenere,
		s.dt_rescisao,
		m.nr_sequencia,
		m.nr_seq_pagador nr_seq_pagador
	FROM titulo_receber t, pls_segurado s, pls_plano p, pls_lote_mensalidade l, pls_mensalidade_seg_item i, pls_protocolo_conta f, pls_conta_pos_estabelecido d, pls_contrato c, pls_conta b, pls_mensalidade_segurado a, pls_mensalidade m
LEFT OUTER JOIN nota_fiscal n ON (m.nr_sequencia = n.nr_seq_mensalidade)
WHERE l.nr_sequencia = m.nr_seq_lote and m.nr_sequencia = a.nr_seq_mensalidade and a.nr_sequencia = i.nr_seq_mensalidade_seg and m.nr_sequencia = t.nr_seq_mensalidade and p.nr_sequencia = b.nr_seq_plano and s.nr_sequencia = a.nr_seq_segurado and c.nr_sequencia = s.nr_seq_contrato and b.nr_sequencia = d.nr_seq_conta and f.nr_sequencia = b.nr_seq_protocolo and b.nr_sequencia = i.nr_seq_conta  and i.ie_tipo_item	= '6' and ie_tipo_movimentacao_w in ('M','A') and not exists (	select	1
				from 	titulo_receber_desdob z
				where	z.nr_titulo_dest = t.nr_titulo)  -- Nao apresentar os titulos a receber originados do desdobramento. Ira trazer apenas o original.
  and coalesce(cd_estabelecimento_p,t.cd_estabelecimento) = t.cd_estabelecimento and l.dt_mesano_referencia between dt_inicial_w and dt_final_w and d.cd_conta_cred in (	select 	cd_conta_contabil
					from	conta_contabil
					where	substr(ctb_obter_classif_conta(cd_conta_contabil, cd_classificacao, dt_inicio_vigencia),1,5) = '3.1.1'
					and	ie_tipo = 'A') and m.vl_mensalidade <> 0 and coalesce(d.vl_beneficiario,0) <> 0 and (((coalesce(m.dt_cancelamento::text, '') = '') and (ie_status_p = 'N'))
	or	(m.dt_cancelamento IS NOT NULL AND m.dt_cancelamento::text <> '' AND ie_status_p = 'C')) and not exists (	select	1
				from	pls_mensalidade_item_conta	x
				where	i.nr_sequencia	= x.nr_seq_item) and ((coalesce(ie_tipo_segurado_w, 'X')	= coalesce(b.ie_tipo_segurado, 'X'))
	or (coalesce(ie_tipo_segurado_w, 'X')	= 'X')) and t.ie_pls = 'S' group by c.nr_contrato,
		c.dt_contrato,
		c.dt_rescisao_contrato,
		p.ie_tipo_contratacao,
		p.ie_segmentacao,
		p.ie_preco,
		p.ie_regulamentacao,
		substr(CASE WHEN p.ie_tipo_operacao='A' THEN  'SCA'  ELSE coalesce(p.nr_protocolo_ans, p.cd_scpa) END ,1,20),
		a.dt_inicio_cobertura,
		a.dt_fim_cobertura,
		substr(pls_obter_dados_segurado(a.nr_seq_segurado,'CR'),1,30),
		substr(pls_obter_dados_segurado(a.nr_seq_segurado,'N'),1,255),
		substr(pls_obter_dados_pagador(m.nr_seq_pagador,'CPF'),1,255),
		t.nr_titulo,
		t.nr_titulo,
		t.dt_emissao,
		substr(pls_obter_parcela_contrato(s.nr_seq_contrato,a.dt_mesano_referencia),1,10),
		t.dt_vencimento,
		d.cd_conta_cred,
		d.cd_conta_deb,
		m.vl_mensalidade,
		l.dt_contabilizacao,
		a.nr_seq_segurado,
		'CM',
		b.ie_tipo_segurado,
		t.vl_titulo,
		s.dt_contratacao,
		m.dt_cancelamento,
		f.dt_mes_competencia,
		d.nr_seq_conta_proc,
		d.nr_seq_conta_mat,
		f.nr_seq_congenere,
		s.dt_rescisao,
		m.nr_sequencia,
		m.nr_seq_pagador
	
union all

	select 	c.nr_contrato nr_contrato,
		c.dt_contrato dt_contrato,
		c.dt_rescisao_contrato dt_rescisao,
		p.ie_tipo_contratacao ie_tipo_contratacao,
		p.ie_segmentacao ie_segmentacao,
		p.ie_preco ie_modalidade_contrat,
		p.ie_regulamentacao ie_regulamentacao,
		substr(CASE WHEN p.ie_tipo_operacao='A' THEN  'SCA'  ELSE coalesce(p.nr_protocolo_ans, p.cd_scpa) END ,1,20) nr_protocolo_ans, 
		null ie_definicao_atos, 
		a.dt_inicio_cobertura dt_inicio_cobertura,
		a.dt_fim_cobertura dt_fim_cobertura,
		substr(pls_obter_dados_segurado(a.nr_seq_segurado,'CR'),1,30) cd_beneficiario,
		substr(pls_obter_dados_segurado(a.nr_seq_segurado,'N'),1,255) nm_usuario_principal,
		substr(pls_obter_dados_pagador(m.nr_seq_pagador,'CPF'),1,255) cd_cpf_cnpj,
		t.nr_titulo nr_documento,
		t.nr_titulo nr_titulo,
		t.dt_emissao dt_emissao,
		substr(pls_obter_parcela_contrato(s.nr_seq_contrato,a.dt_mesano_referencia),1,10) nr_parcela,
		t.dt_vencimento dt_vencimento,
		d.cd_conta_cred cd_conta_contabil,
		d.cd_conta_deb cd_conta_debito,
		null cd_conta_cred_encargos,
		m.vl_mensalidade vl_mensalidade,
		sum(j.vl_item) vl_apropriado,
		l.dt_contabilizacao dt_contabilizacao,
		a.nr_seq_segurado nr_seq_segurado,
		'CM' ie_tipo_documento,
		b.ie_tipo_segurado,
		t.vl_titulo vl_titulo,
		s.dt_contratacao,
		m.dt_cancelamento,
		CASE WHEN ie_data_tipo_segurado_w='P' THEN  f.dt_mes_competencia  ELSE (	select	y.dt_procedimento										from	pls_conta_proc y										where	y.nr_sequencia = d.nr_seq_conta_proc										
union
										select	y.dt_atendimento										from	pls_conta_mat y										where	y.nr_sequencia = d.nr_seq_conta_mat) END  dt_ref_repasse,
		f.nr_seq_congenere,
		s.dt_rescisao,
		m.nr_sequencia,
		m.nr_seq_pagador
	from	pls_mensalidade_item_conta	j,
		pls_lote_mensalidade 		l,
		pls_mensalidade 		m,
		pls_mensalidade_segurado 	a,
		pls_mensalidade_seg_item 	i,
		titulo_receber 			t,
		pls_segurado 			s,
		pls_contrato 			c,
		pls_plano 			p,
		pls_protocolo_conta		f,
		pls_conta 			b,
		pls_conta_pos_estabelecido 	d
	where	l.nr_sequencia 	= m.nr_seq_lote
	and	m.nr_sequencia 	= a.nr_seq_mensalidade
	and	a.nr_sequencia 	= i.nr_seq_mensalidade_seg
	and	m.nr_sequencia 	= t.nr_seq_mensalidade
	and	p.nr_sequencia 	= b.nr_seq_plano
	and	s.nr_sequencia 	= a.nr_seq_segurado
	and	c.nr_sequencia 	= s.nr_seq_contrato
	and	i.nr_sequencia 	= j.nr_seq_item
	and	d.nr_sequencia	= j.nr_seq_conta_pos_estab
	and	b.nr_sequencia	= d.nr_seq_conta
	and	f.nr_sequencia	= b.nr_seq_protocolo
	and	i.ie_tipo_item	= '6'
	and	ie_tipo_movimentacao_w in ('M','A')
	and	not exists (	select	1
				from 	titulo_receber_desdob z
				where	z.nr_titulo_dest = t.nr_titulo) -- Nao apresentar os titulos a receber originados do desdobramento. Ira trazer apenas o original.
	and	coalesce(cd_estabelecimento_p,t.cd_estabelecimento) = t.cd_estabelecimento
	and	l.dt_mesano_referencia between dt_inicial_w and dt_final_w
	and	((ie_gerar_ind_classif_w <> 'N')
	or (d.cd_conta_cred in (	select 	cd_conta_contabil
					from	conta_contabil
					where	substr(ctb_obter_classif_conta(cd_conta_contabil, cd_classificacao, dt_inicio_vigencia),1,5) = '3.1.1'
					and	ie_tipo = 'A')))
	and	m.vl_mensalidade <> 0
	and	(((coalesce(m.dt_cancelamento::text, '') = '') and (ie_status_p = 'N'))
	or	(m.dt_cancelamento IS NOT NULL AND m.dt_cancelamento::text <> '' AND ie_status_p = 'C'))
	and	((coalesce(ie_tipo_segurado_w,'X') = coalesce(b.ie_tipo_segurado,'X'))
	or (coalesce(ie_tipo_segurado_w,'X') = 'X'))
	and	t.ie_pls = 'S'
	group by c.nr_contrato,
		c.dt_contrato,
		c.dt_rescisao_contrato,
		p.ie_tipo_contratacao,
		p.ie_segmentacao,
		p.ie_preco,
		p.ie_regulamentacao,
		substr(CASE WHEN p.ie_tipo_operacao='A' THEN  'SCA'  ELSE coalesce(p.nr_protocolo_ans, p.cd_scpa) END ,1,20),
		a.dt_inicio_cobertura,
		a.dt_fim_cobertura,
		substr(pls_obter_dados_segurado(a.nr_seq_segurado,'CR'),1,30),
		substr(pls_obter_dados_segurado(a.nr_seq_segurado,'N'),1,255),
		substr(pls_obter_dados_pagador(m.nr_seq_pagador,'CPF'),1,255),
		t.nr_titulo,
		t.dt_emissao,
		substr(pls_obter_parcela_contrato(s.nr_seq_contrato,a.dt_mesano_referencia),1,10),
		t.dt_vencimento,
		d.cd_conta_cred,
		d.cd_conta_deb,
		m.vl_mensalidade,
		l.dt_contabilizacao,
		a.nr_seq_segurado,
		'CM',
		b.ie_tipo_segurado,
		t.vl_titulo,
		s.dt_contratacao,
		m.dt_cancelamento,
		f.dt_mes_competencia,
		d.nr_seq_conta_proc,
		d.nr_seq_conta_mat,
		f.nr_seq_congenere,
		s.dt_rescisao,
		m.nr_sequencia,
		m.nr_seq_pagador
	
union all

	select 	c.nr_contrato nr_contrato,
		c.dt_contrato dt_contrato,
		c.dt_rescisao_contrato dt_rescisao,
		p.ie_tipo_contratacao ie_tipo_contratacao,
		p.ie_segmentacao ie_segmentacao,
		p.ie_preco ie_modalidade_contrat,
		p.ie_regulamentacao ie_regulamentacao,
		substr(CASE WHEN p.ie_tipo_operacao='A' THEN  'SCA'  ELSE coalesce(p.nr_protocolo_ans, p.cd_scpa) END ,1,20) nr_protocolo_ans,
		null ie_definicao_atos,
		a.dt_inicio_cobertura dt_inicio_cobertura,
		a.dt_fim_cobertura dt_fim_cobertura,
		substr(pls_obter_dados_segurado(a.nr_seq_segurado,'C'),1,30) cd_beneficiario,
		substr(pls_obter_dados_segurado(a.nr_seq_segurado,'N'),1,255) nm_usuario_principal,
		substr(pls_obter_dados_segurado(a.nr_seq_segurado,'CPF'),1,255) cd_cpf_cnpj,
		t.nr_titulo nr_documento,
		t.nr_titulo nr_titulo,
		t.dt_emissao dt_emissao,
		substr(pls_obter_parcela_contrato(s.nr_seq_contrato,a.dt_mesano_referencia),1,10) nr_parcela,
		t.dt_vencimento dt_vencimento,
		i.cd_conta_deb cd_conta_contabil,
		i.cd_conta_contabil_ppcng cd_conta_debito,
		null cd_conta_cred_encargos,
		m.vl_mensalidade vl_mensalidade,
		sum(k.vl_cancelar) vl_apropriado,
		l.dt_mesano_referencia dt_contabilizacao,
		s.nr_sequencia nr_seq_segurado,
		'TR' ie_tipo_documento,
		s.ie_tipo_segurado,
		t.vl_titulo,
		s.dt_contratacao,
		m.dt_cancelamento,
		null dt_ref_repasse,
		null nr_seq_congenere,
		s.dt_rescisao,
		m.nr_sequencia,
		m.nr_seq_pagador nr_seq_pagador
	from	pls_lote_mensalidade 		l,
		pls_mensalidade 		m,
		pls_mensalidade_segurado 	a,
		pls_mensalidade_seg_item 	i,
		titulo_receber 			t,
		pls_segurado 			s,
		pls_contrato 			c,
		pls_plano 			p,
		pls_solic_resc_fin_item		k
	where	l.nr_sequencia 	= m.nr_seq_lote
	and	m.nr_sequencia 	= a.nr_seq_mensalidade
	and	a.nr_sequencia 	= i.nr_seq_mensalidade_seg
	and	m.nr_sequencia 	= t.nr_seq_mensalidade
	and	p.nr_sequencia 	= s.nr_seq_plano
	and	s.nr_sequencia 	= a.nr_seq_segurado
	and	c.nr_sequencia 	= s.nr_seq_contrato
	and	i.nr_sequencia	= k.nr_seq_item_mensalidade
	and	i.ie_tipo_item not in ('3', '6', '43')
	and	ie_tipo_movimentacao_w in ('M','A')
	and	(((ie_status_p = 'N')
	and	((ie_tipo_data_w = 'E')
	and (l.dt_geracao between dt_inicial_w and dt_final_w)
	or (ie_tipo_data_w = 'C')
	and (l.dt_mesano_referencia between dt_inicial_w and dt_final_w))
	and (coalesce(m.dt_cancelamento::text, '') = ''))
	or	(ie_status_p = 'C' AND (
	or	)))
	and	coalesce(k.vl_cancelar,0) <> 0
	and	coalesce(cd_conta_ato_auxiliar::text, '') = ''
	and	coalesce(cd_conta_ato_cooperado::text, '') = ''
	and	coalesce(cd_conta_ato_nao_coop::text, '') = ''
	and	((ie_gerar_ind_classif_w <> 'N')
	or	i.cd_conta_deb	in (	select 	cd_conta_contabil
					from	conta_contabil
					where	substr(ctb_obter_classif_conta(cd_conta_contabil, cd_classificacao, dt_inicio_vigencia),1,5) = '3.1.1'
					and	ie_tipo = 'A'))
	and	coalesce(cd_estabelecimento_p,t.cd_estabelecimento) = t.cd_estabelecimento
	and	coalesce(m.ie_cancelamento,'C') <> 'E'
	and	((coalesce(ie_tipo_segurado_w,'X') = coalesce(s.ie_tipo_segurado,'X'))
	or (coalesce(ie_tipo_segurado_w,'X') = 'X'))
	and	t.ie_pls = 'S'
	group by c.nr_contrato,
		c.dt_contrato,
		c.dt_rescisao_contrato,
		p.ie_tipo_contratacao,
		p.ie_segmentacao,
		p.ie_preco,
		p.ie_regulamentacao,
		substr(CASE WHEN p.ie_tipo_operacao='A' THEN  'SCA'  ELSE coalesce(p.nr_protocolo_ans, p.cd_scpa) END ,1,20),
		a.dt_inicio_cobertura,
		a.dt_fim_cobertura,
		substr(pls_obter_dados_segurado(a.nr_seq_segurado,'C'),1,30),
		substr(pls_obter_dados_segurado(a.nr_seq_segurado,'N'),1,255),
		substr(pls_obter_dados_segurado(a.nr_seq_segurado,'CPF'),1,255),
		t.nr_titulo,
		t.dt_emissao,
		substr(pls_obter_parcela_contrato(s.nr_seq_contrato,a.dt_mesano_referencia),1,10),
		t.dt_vencimento,
		i.cd_conta_deb,
		i.cd_conta_contabil_ppcng,
		m.vl_mensalidade,
		a.dt_fim_cobertura,
		s.nr_sequencia,
		s.ie_tipo_segurado,
		t.vl_titulo,
		s.dt_contratacao,
		m.dt_cancelamento,
		l.dt_mesano_referencia,
		s.dt_rescisao,
		m.nr_sequencia,
		m.nr_seq_pagador
	
union all

	select 	c.nr_contrato nr_contrato,
		c.dt_contrato dt_contrato,
		c.dt_rescisao_contrato dt_rescisao,
		p.ie_tipo_contratacao ie_tipo_contratacao,
		p.ie_segmentacao ie_segmentacao,
		p.ie_preco ie_modalidade_contrat,
		p.ie_regulamentacao ie_regulamentacao,
		substr(CASE WHEN p.ie_tipo_operacao='A' THEN  'SCA'  ELSE coalesce(p.nr_protocolo_ans, p.cd_scpa) END ,1,20) nr_protocolo_ans,
		null ie_definicao_atos,
		a.dt_inicio_cobertura dt_inicio_cobertura,
		a.dt_fim_cobertura dt_fim_cobertura,
		substr(pls_obter_dados_segurado(a.nr_seq_segurado,'C'),1,30) cd_beneficiario,
		substr(pls_obter_dados_segurado(a.nr_seq_segurado,'N'),1,255) nm_usuario_principal,
		substr(pls_obter_dados_segurado(a.nr_seq_segurado,'CPF'),1,255) cd_cpf_cnpj,
		t.nr_titulo nr_documento,
		t.nr_titulo nr_titulo,
		t.dt_emissao dt_emissao,
		substr(pls_obter_parcela_contrato(s.nr_seq_contrato,a.dt_mesano_referencia),1,10) nr_parcela,
		t.dt_vencimento dt_vencimento,
		i.cd_conta_devolucao cd_conta_contabil,
		i.cd_conta_contabil_ppcng cd_conta_debito,
		null cd_conta_cred_encargos,
		m.vl_mensalidade vl_mensalidade,
		sum(k.vl_devolver) vl_apropriado,
		l.dt_mesano_referencia dt_contabilizacao,
		s.nr_sequencia nr_seq_segurado,
		'TR' ie_tipo_documento,
		s.ie_tipo_segurado,
		t.vl_titulo,
		s.dt_contratacao,
		m.dt_cancelamento,
		null dt_ref_repasse,
		null nr_seq_congenere,
		s.dt_rescisao,
		m.nr_sequencia,
		m.nr_seq_pagador
	from	pls_lote_mensalidade 		l,
		pls_mensalidade 		m,
		pls_mensalidade_segurado 	a,
		pls_mensalidade_seg_item 	i,
		titulo_receber 			t,
		pls_segurado 			s,
		pls_contrato 			c,
		pls_plano 			p,
		pls_solic_resc_fin_item		k
	where	l.nr_sequencia 	= m.nr_seq_lote
	and	m.nr_sequencia 	= a.nr_seq_mensalidade
	and	a.nr_sequencia 	= i.nr_seq_mensalidade_seg
	and	m.nr_sequencia 	= t.nr_seq_mensalidade
	and	p.nr_sequencia 	= s.nr_seq_plano
	and	s.nr_sequencia 	= a.nr_seq_segurado
	and	c.nr_sequencia 	= s.nr_seq_contrato
	and	i.nr_sequencia	= k.nr_seq_item_mensalidade
	and	i.ie_tipo_item not in ('3', '6', '43')
	and	ie_tipo_movimentacao_w in ('M','A')
	and	(((ie_status_p = 'N')
	and	((ie_tipo_data_w = 'E')
	and (l.dt_geracao between dt_inicial_w and dt_final_w)
	or (ie_tipo_data_w = 'C')
	and (l.dt_mesano_referencia between dt_inicial_w and dt_final_w))
	and (coalesce(m.dt_cancelamento::text, '') = ''))
	or	(ie_status_p = 'C' AND (
	or	)))
	and	coalesce(k.vl_devolver,0) <> 0
	and	coalesce(cd_conta_ato_auxiliar::text, '') = ''
	and	coalesce(cd_conta_ato_cooperado::text, '') = ''
	and	coalesce(cd_conta_ato_nao_coop::text, '') = ''
	and	((ie_gerar_ind_classif_w <> 'N')
	or	i.cd_conta_devolucao	in (	select 	cd_conta_contabil
						from	conta_contabil
						where	substr(ctb_obter_classif_conta(cd_conta_contabil, cd_classificacao, dt_inicio_vigencia),1,5) = '3.1.1'
						and	ie_tipo = 'A'))
	and	coalesce(cd_estabelecimento_p,t.cd_estabelecimento) = t.cd_estabelecimento
	and	coalesce(m.ie_cancelamento,'C') <> 'E'
	and	((coalesce(ie_tipo_segurado_w,'X') = coalesce(s.ie_tipo_segurado,'X'))
	or (coalesce(ie_tipo_segurado_w,'X') = 'X'))
	and	t.ie_pls = 'S'
	group by c.nr_contrato,
		c.dt_contrato,
		c.dt_rescisao_contrato,
		p.ie_tipo_contratacao,
		p.ie_segmentacao,
		p.ie_preco,
		p.ie_regulamentacao,
		substr(CASE WHEN p.ie_tipo_operacao='A' THEN  'SCA'  ELSE coalesce(p.nr_protocolo_ans, p.cd_scpa) END ,1,20),
		a.dt_inicio_cobertura,
		a.dt_fim_cobertura,
		substr(pls_obter_dados_segurado(a.nr_seq_segurado,'C'),1,30),
		substr(pls_obter_dados_segurado(a.nr_seq_segurado,'N'),1,255),
		substr(pls_obter_dados_segurado(a.nr_seq_segurado,'CPF'),1,255),
		t.nr_titulo,
		t.dt_emissao,
		substr(pls_obter_parcela_contrato(s.nr_seq_contrato,a.dt_mesano_referencia),1,10),
		t.dt_vencimento,
		i.cd_conta_devolucao,
		i.cd_conta_deb,
		i.cd_conta_contabil_ppcng,
		m.vl_mensalidade,
		a.dt_fim_cobertura,
		s.nr_sequencia,
		s.ie_tipo_segurado,
		t.vl_titulo,
		s.dt_contratacao,
		m.dt_cancelamento,
		l.dt_mesano_referencia,
		s.dt_rescisao,
		m.nr_sequencia,
		m.nr_seq_pagador
	
union all

	select  t.nr_contrato nr_contrato,
		t.dt_contrato dt_contrato,
		t.dt_rescisao_contrato dt_rescisao,
		n.ie_tipo_contratacao ie_tipo_contratacao,
		n.ie_segmentacao ie_segmentacao,
		n.ie_preco ie_modalidade_contrat,
		n.ie_regulamentacao ie_regulamentacao,
		substr(CASE WHEN n.ie_tipo_operacao='A' THEN  'SCA'  ELSE coalesce(n.nr_protocolo_ans, n.cd_scpa) END ,1,20) nr_protocolo_ans,
		null ie_definicao_atos,
		s.dt_rescisao dt_inicio_cobertura,
		(s.dt_rescisao + 30) dt_fim_cobertura,
		substr(pls_obter_dados_segurado(s.nr_sequencia,'C'),1,30) cd_beneficiario,
		substr(pls_obter_dados_segurado(s.nr_sequencia,'N'),1,255) nm_usuario_principal,
		substr(pls_obter_dados_segurado(s.nr_sequencia,'CPF'),1,255) cd_cpf_cnpj,
		c.nr_sequencia nr_documento,
		i.nr_titulo nr_titulo,
		i.dt_emissao dt_emissao,
		substr(pls_obter_parcela_contrato(t.nr_sequencia,f.dt_mes_competencia),1,10) nr_parcela,
		i.dt_vencimento dt_vencimento,
		d.cd_conta_cred_ndc cd_conta_contabil,
		d.cd_conta_deb_ndc cd_conta_debito,
		null cd_conta_cred_encargos,
		0 vl_mensalidade,
		coalesce(sum(d.vl_custo_operacional),0) - coalesce(sum(d.vl_administracao),0) vl_apropriado,
		f.dt_mes_competencia dt_contabilizacao,
		s.nr_sequencia nr_seq_segurado,
		'CM' ie_tipo_documento,
		c.ie_tipo_segurado,
		i.vl_titulo,
		s.dt_contratacao,
		f.dt_cancelamento_fat dt_cancelamento,
		CASE WHEN ie_data_tipo_segurado_w='P' THEN  x.dt_mes_competencia  ELSE (	select	max(y.dt_procedimento)										from	pls_conta_proc y										where	a.nr_seq_conta_proc = y.nr_sequencia) END  dt_ref_repasse,
		x.nr_seq_congenere,
		s.dt_rescisao,
		null nr_seq_mensalidade,
		s.nr_seq_pagador nr_seq_pagador
	FROM pls_protocolo_conta x, pls_fatura_conta u, pls_fatura_proc p, pls_plano n, pls_lote_faturamento l, pls_fatura f, pls_fatura_evento e, pls_conta_pos_estab_contab d, pls_conta c, pls_conta_pos_estabelecido a, pls_segurado s
LEFT OUTER JOIN pls_contrato t ON (s.nr_seq_contrato = t.nr_sequencia)
, coalesce(f
LEFT OUTER JOIN titulo_receber i ON (coalesce(f.nr_titulo, f.nr_titulo_ndc) = i.nr_titulo)
WHERE x.nr_sequencia		= c.nr_seq_protocolo and c.nr_sequencia		= a.nr_seq_conta and a.nr_sequencia 		= d.nr_seq_conta_pos and a.nr_sequencia 		= p.nr_seq_conta_pos_estab and u.nr_sequencia		= p.nr_seq_fatura_conta and e.nr_sequencia		= u.nr_seq_fatura_evento and f.nr_sequencia		= e.nr_seq_fatura and l.nr_sequencia		= f.nr_seq_lote and s.nr_sequencia		= c.nr_seq_segurado  and n.nr_sequencia		= c.nr_seq_plano  and ((ie_gerar_ind_classif_w <> 'N')
	and	ie_tipo_movimentacao_w in ('F','A')
	or (substr(d.cd_classif_deb_ndc,1,5) = '1.2.3')) and (((ie_status_p = 'N')
	and	((ie_tipo_data_w = 'E')
	and (l.dt_geracao between dt_inicial_w and dt_final_w)
	or (ie_tipo_data_w = 'C')
	and (f.dt_mes_competencia between dt_inicial_w and dt_final_w)))
	or	(ie_status_p = 'C' AND f.dt_cancelamento_fat between dt_inicial_w and dt_final_w)) and coalesce(f.ie_cancelamento,'X') = 'X' and ((coalesce(ie_tipo_segurado_w, 'X')	= coalesce(c.ie_tipo_segurado, 'X'))
	or (coalesce(ie_tipo_segurado_w, 'X')	= 'X')) and i.ie_pls = 'S' and coalesce(a.ie_status_faturamento, 'A') <> 'A' group by t.nr_contrato,
		t.dt_contrato,
		t.dt_rescisao_contrato,
		n.ie_tipo_contratacao,
		n.ie_segmentacao,
		n.ie_preco,
		n.ie_regulamentacao,
		substr(CASE WHEN n.ie_tipo_operacao='A' THEN  'SCA'  ELSE coalesce(n.nr_protocolo_ans, n.cd_scpa) END ,1,20),
		s.dt_rescisao,
		(s.dt_rescisao + 30),
		substr(pls_obter_dados_segurado(s.nr_sequencia,'C'),1,30),
		substr(pls_obter_dados_segurado(s.nr_sequencia,'N'),1,255),
		substr(pls_obter_dados_segurado(s.nr_sequencia,'CPF'),1,255),
		c.nr_sequencia,
		i.nr_titulo,
		i.dt_emissao,
		substr(pls_obter_parcela_contrato(t.nr_sequencia,f.dt_mes_competencia),1,10),
		i.dt_vencimento,
		d.cd_conta_deb_ndc,
		d.cd_conta_cred_ndc,
		f.dt_mes_competencia,
		s.nr_sequencia,
		c.ie_tipo_segurado,
		i.vl_titulo,
		s.dt_contratacao,
		f.dt_cancelamento_fat,
		x.dt_mes_competencia,
		a.nr_seq_conta_proc,
		x.nr_seq_congenere,
		s.dt_rescisao,
		s.nr_seq_pagador
	
union all

	select	t.nr_contrato nr_contrato,
		t.dt_contrato dt_contrato,
		t.dt_rescisao_contrato dt_rescisao,
		n.ie_tipo_contratacao ie_tipo_contratacao,
		n.ie_segmentacao ie_segmentacao,
		n.ie_preco ie_modalidade_contrat,
		n.ie_regulamentacao ie_regulamentacao,
		substr(CASE WHEN n.ie_tipo_operacao='A' THEN  'SCA'  ELSE coalesce(n.nr_protocolo_ans, n.cd_scpa) END ,1,20) nr_protocolo_ans,
		null ie_definicao_atos,
		s.dt_rescisao dt_inicio_cobertura,
		(s.dt_rescisao + 30) dt_fim_cobertura,
		substr(pls_obter_dados_segurado(s.nr_sequencia,'C'),1,30) cd_beneficiario,
		substr(pls_obter_dados_segurado(s.nr_sequencia,'N'),1,255) nm_usuario_principal,
		substr(pls_obter_dados_segurado(s.nr_sequencia,'CPF'),1,255) cd_cpf_cnpj,
		c.nr_sequencia nr_documento,
		i.nr_titulo nr_titulo,
		i.dt_emissao dt_emissao,
		substr(pls_obter_parcela_contrato(t.nr_sequencia,f.dt_mes_competencia),1,10) nr_parcela,
		i.dt_vencimento dt_vencimento,
		d.cd_conta_cred_ndc cd_conta_contabil,
		d.cd_conta_deb_ndc cd_conta_debito,
		null cd_conta_cred_encargos,
		0 vl_mensalidade,
		coalesce(sum(d.vl_custo_operacional),0) - coalesce(sum(d.vl_administracao),0) vl_apropriado,
		f.dt_mes_competencia dt_contabilizacao,
		s.nr_sequencia nr_seq_segurado,
		'CM' ie_tipo_documento,
		c.ie_tipo_segurado,
		i.vl_titulo,
		s.dt_contratacao,
		f.dt_cancelamento_fat dt_cancelamento,
		CASE WHEN ie_data_tipo_segurado_w='P' THEN  x.dt_mes_competencia  ELSE (	select	max(y.dt_atendimento)										from	pls_conta_mat y										where	a.nr_seq_conta_mat = y.nr_sequencia) END  dt_ref_repasse,
		x.nr_seq_congenere,
		s.dt_rescisao,
		null nr_seq_mensalidade,
		s.nr_seq_pagador nr_seq_pagador
	FROM pls_protocolo_conta x, pls_fatura_conta u, pls_fatura_mat p, pls_plano n, pls_lote_faturamento l, pls_fatura f, pls_fatura_evento e, pls_conta_pos_estab_contab d, pls_conta c, pls_conta_pos_estabelecido a, pls_segurado s
LEFT OUTER JOIN pls_contrato t ON (s.nr_seq_contrato = t.nr_sequencia)
, coalesce(f
LEFT OUTER JOIN titulo_receber i ON (coalesce(f.nr_titulo, f.nr_titulo_ndc) = i.nr_titulo)
WHERE x.nr_sequencia		= c.nr_seq_protocolo and c.nr_sequencia		= a.nr_seq_conta and a.nr_sequencia 		= d.nr_seq_conta_pos and a.nr_sequencia 		= p.nr_seq_conta_pos_estab and u.nr_sequencia		= p.nr_seq_fatura_conta and e.nr_sequencia		= u.nr_seq_fatura_evento and f.nr_sequencia		= e.nr_seq_fatura and l.nr_sequencia		= f.nr_seq_lote and s.nr_sequencia		= c.nr_seq_segurado  and n.nr_sequencia		= c.nr_seq_plano  and ((ie_gerar_ind_classif_w <> 'N')
	and	ie_tipo_movimentacao_w in ('F','A')
	or (substr(d.cd_classif_deb_ndc,1,5) = '1.2.3')) and (((ie_status_p = 'N')
	and	((ie_tipo_data_w = 'E')
	and (l.dt_geracao between dt_inicial_w and dt_final_w)
	or (ie_tipo_data_w = 'C')
	and (f.dt_mes_competencia between dt_inicial_w and dt_final_w)))
	or	(ie_status_p = 'C' AND f.dt_cancelamento_fat between dt_inicial_w and dt_final_w)) and coalesce(f.ie_cancelamento,'X') = 'X' and ((coalesce(ie_tipo_segurado_w, 'X')	= coalesce(c.ie_tipo_segurado, 'X'))
	or (coalesce(ie_tipo_segurado_w, 'X')	= 'X')) and i.ie_pls = 'S' and coalesce(a.ie_status_faturamento, 'A') <> 'A' group by t.nr_contrato,
		t.dt_contrato,
		t.dt_rescisao_contrato,
		n.ie_tipo_contratacao,
		n.ie_segmentacao,
		n.ie_preco,
		n.ie_regulamentacao,
		substr(CASE WHEN n.ie_tipo_operacao='A' THEN  'SCA'  ELSE coalesce(n.nr_protocolo_ans, n.cd_scpa) END ,1,20),
		s.dt_rescisao,
		(s.dt_rescisao + 30),
		substr(pls_obter_dados_segurado(s.nr_sequencia,'C'),1,30),
		substr(pls_obter_dados_segurado(s.nr_sequencia,'N'),1,255),
		substr(pls_obter_dados_segurado(s.nr_sequencia,'CPF'),1,255),
		i.nr_titulo,
		c.nr_sequencia,
		i.dt_emissao,
		substr(pls_obter_parcela_contrato(t.nr_sequencia,f.dt_mes_competencia),1,10),
		i.dt_vencimento,
		d.cd_conta_deb_ndc,
		d.cd_conta_cred_ndc,
		f.dt_mes_competencia,
		s.nr_sequencia,
		c.ie_tipo_segurado,
		i.vl_titulo,
		s.dt_contratacao,
		f.dt_cancelamento_fat,
		x.dt_mes_competencia,
		a.nr_seq_conta_mat,
		x.nr_seq_congenere,
		s.dt_rescisao,
		s.nr_seq_pagador
	
union all

	select  t.nr_contrato nr_contrato,
		t.dt_contrato dt_contrato,
		t.dt_rescisao_contrato dt_rescisao,
		n.ie_tipo_contratacao ie_tipo_contratacao,
		n.ie_segmentacao ie_segmentacao,
		n.ie_preco ie_modalidade_contrat,
		n.ie_regulamentacao ie_regulamentacao,
		substr(CASE WHEN n.ie_tipo_operacao='A' THEN  'SCA'  ELSE coalesce(n.nr_protocolo_ans, n.cd_scpa) END ,1,20) nr_protocolo_ans,
		null ie_definicao_atos,
		s.dt_rescisao dt_inicio_cobertura,
		(s.dt_rescisao + 30) dt_fim_cobertura,
		substr(pls_obter_dados_segurado(s.nr_sequencia,'C'),1,30) cd_beneficiario,
		substr(pls_obter_dados_segurado(s.nr_sequencia,'N'),1,255) nm_usuario_principal,
		substr(pls_obter_dados_segurado(s.nr_sequencia,'CPF'),1,255) cd_cpf_cnpj,
		c.nr_sequencia nr_documento,
		i.nr_titulo nr_titulo,
		i.dt_emissao dt_emissao,
		substr(pls_obter_parcela_contrato(t.nr_sequencia,f.dt_mes_competencia),1,10) nr_parcela,
		i.dt_vencimento dt_vencimento,
		d.cd_conta_cred_taxa cd_conta_contabil,
		d.cd_conta_deb_taxa cd_conta_debito,
		null cd_conta_cred_encargos,
		0 vl_mensalidade,
		coalesce(sum(d.vl_administracao),0) vl_apropriado,
		f.dt_mes_competencia dt_contabilizacao,
		s.nr_sequencia nr_seq_segurado,
		'CM' ie_tipo_documento,
		c.ie_tipo_segurado,
		i.vl_titulo,
		s.dt_contratacao,
		f.dt_cancelamento_fat dt_cancelamento,
		CASE WHEN ie_data_tipo_segurado_w='P' THEN  x.dt_mes_competencia  ELSE (	select	max(y.dt_procedimento)										from	pls_conta_proc y										where	a.nr_seq_conta_proc = y.nr_sequencia) END  dt_ref_repasse,
		x.nr_seq_congenere,
		s.dt_rescisao,
		null nr_seq_mensalidade,
		s.nr_seq_pagador
	FROM pls_protocolo_conta x, pls_fatura_conta u, pls_fatura_proc p, pls_plano n, pls_lote_faturamento l, pls_fatura f, pls_fatura_evento e, pls_conta_pos_estab_contab d, pls_conta c, pls_conta_pos_estabelecido a, pls_segurado s
LEFT OUTER JOIN pls_contrato t ON (s.nr_seq_contrato = t.nr_sequencia)
, coalesce(f
LEFT OUTER JOIN titulo_receber i ON (coalesce(f.nr_titulo, f.nr_titulo_ndc) = i.nr_titulo)
WHERE x.nr_sequencia		= c.nr_seq_protocolo and c.nr_sequencia		= a.nr_seq_conta and a.nr_sequencia 		= d.nr_seq_conta_pos and a.nr_sequencia 		= p.nr_seq_conta_pos_estab and u.nr_sequencia		= p.nr_seq_fatura_conta and e.nr_sequencia		= u.nr_seq_fatura_evento and f.nr_sequencia		= e.nr_seq_fatura and l.nr_sequencia		= f.nr_seq_lote and s.nr_sequencia		= c.nr_seq_segurado  and n.nr_sequencia		= c.nr_seq_plano  and ((ie_gerar_ind_classif_w <> 'N')
	and	ie_tipo_movimentacao_w in ('F','A')
	or (substr(d.cd_classif_deb_taxa,1,5) = '1.2.3')) and coalesce(d.vl_administracao,0) <> 0 and (((ie_status_p = 'N')
	and	((ie_tipo_data_w = 'E')
	and (l.dt_geracao between dt_inicial_w and dt_final_w)
	or (ie_tipo_data_w = 'C')
	and (f.dt_mes_competencia between dt_inicial_w and dt_final_w)))
	or	(ie_status_p = 'C' AND f.dt_cancelamento_fat between dt_inicial_w and dt_final_w)) and coalesce(f.ie_cancelamento,'X') = 'X' and ((coalesce(ie_tipo_segurado_w, 'X')	= coalesce(c.ie_tipo_segurado, 'X'))
	or (coalesce(ie_tipo_segurado_w, 'X')	= 'X')) and i.ie_pls = 'S' and coalesce(a.ie_status_faturamento, 'A') <> 'A' group by t.nr_contrato,
		t.dt_contrato,
		t.dt_rescisao_contrato,
		n.ie_tipo_contratacao,
		n.ie_segmentacao,
		n.ie_preco,
		n.ie_regulamentacao,
		substr(CASE WHEN n.ie_tipo_operacao='A' THEN  'SCA'  ELSE coalesce(n.nr_protocolo_ans, n.cd_scpa) END ,1,20),
		s.dt_rescisao,
		(s.dt_rescisao + 30),
		substr(pls_obter_dados_segurado(s.nr_sequencia,'C'),1,30),
		substr(pls_obter_dados_segurado(s.nr_sequencia,'N'),1,255),
		substr(pls_obter_dados_segurado(s.nr_sequencia,'CPF'),1,255),
		c.nr_sequencia,
		i.nr_titulo,
		i.dt_emissao,
		substr(pls_obter_parcela_contrato(t.nr_sequencia,f.dt_mes_competencia),1,10),
		i.dt_vencimento,
		d.cd_conta_deb_taxa,
		d.cd_conta_cred_taxa,
		f.dt_mes_competencia,
		s.nr_sequencia,
		c.ie_tipo_segurado,
		i.vl_titulo,
		s.dt_contratacao,
		f.dt_cancelamento_fat,
		x.dt_mes_competencia,
		a.nr_seq_conta_proc,
		x.nr_seq_congenere,
		s.dt_rescisao,
		s.nr_seq_pagador
	
union all

	select	t.nr_contrato nr_contrato,
		t.dt_contrato dt_contrato,
		t.dt_rescisao_contrato dt_rescisao,
		n.ie_tipo_contratacao ie_tipo_contratacao,
		n.ie_segmentacao ie_segmentacao,
		n.ie_preco ie_modalidade_contrat,
		n.ie_regulamentacao ie_regulamentacao,
		substr(CASE WHEN n.ie_tipo_operacao='A' THEN  'SCA'  ELSE coalesce(n.nr_protocolo_ans, n.cd_scpa) END ,1,20) nr_protocolo_ans,
		null ie_definicao_atos,
		s.dt_rescisao dt_inicio_cobertura,
		(s.dt_rescisao + 30) dt_fim_cobertura,
		substr(pls_obter_dados_segurado(s.nr_sequencia,'C'),1,30) cd_beneficiario,
		substr(pls_obter_dados_segurado(s.nr_sequencia,'N'),1,255) nm_usuario_principal,
		substr(pls_obter_dados_segurado(s.nr_sequencia,'CPF'),1,255) cd_cpf_cnpj,
		c.nr_sequencia nr_documento,
		i.nr_titulo nr_titulo,
		i.dt_emissao dt_emissao,
		substr(pls_obter_parcela_contrato(t.nr_sequencia,f.dt_mes_competencia),1,10) nr_parcela,
		i.dt_vencimento dt_vencimento,
		d.cd_conta_cred_taxa cd_conta_contabil,
		d.cd_conta_deb_taxa cd_conta_debito,
		null cd_conta_cred_encargos,
		0 vl_mensalidade,
		coalesce(sum(d.vl_administracao),0) vl_apropriado,
		f.dt_mes_competencia dt_contabilizacao,
		s.nr_sequencia nr_seq_segurado,
		'CM' ie_tipo_documento,
		c.ie_tipo_segurado,
		i.vl_titulo,
		s.dt_contratacao,
		f.dt_cancelamento_fat dt_cancelamento,
		CASE WHEN ie_data_tipo_segurado_w='P' THEN  x.dt_mes_competencia  ELSE (	select	max(y.dt_atendimento)										from	pls_conta_mat y										where	a.nr_seq_conta_mat = y.nr_sequencia) END  dt_ref_repasse,
		x.nr_seq_congenere,
		s.dt_rescisao,
		null nr_seq_mensalidade,
		s.nr_seq_pagador
	FROM pls_protocolo_conta x, pls_fatura_conta u, pls_fatura_mat p, pls_plano n, pls_lote_faturamento l, pls_fatura f, pls_fatura_evento e, pls_conta_pos_estab_contab d, pls_conta c, pls_conta_pos_estabelecido a, pls_segurado s
LEFT OUTER JOIN pls_contrato t ON (s.nr_seq_contrato = t.nr_sequencia)
, coalesce(f
LEFT OUTER JOIN titulo_receber i ON (coalesce(f.nr_titulo, f.nr_titulo_ndc) = i.nr_titulo)
WHERE x.nr_sequencia		= c.nr_seq_protocolo and c.nr_sequencia		= a.nr_seq_conta and a.nr_sequencia 		= d.nr_seq_conta_pos and a.nr_sequencia 		= p.nr_seq_conta_pos_estab and u.nr_sequencia		= p.nr_seq_fatura_conta and e.nr_sequencia		= u.nr_seq_fatura_evento and f.nr_sequencia		= e.nr_seq_fatura and l.nr_sequencia		= f.nr_seq_lote and s.nr_sequencia		= c.nr_seq_segurado  and n.nr_sequencia		= c.nr_seq_plano  and ((ie_gerar_ind_classif_w <> 'N')
	and	ie_tipo_movimentacao_w in ('F','A')
	or (substr(d.cd_classif_deb_taxa,1,5) = '1.2.3')) and coalesce(d.vl_administracao,0) <> 0 and (((ie_status_p = 'N')
	and	((ie_tipo_data_w = 'E')
	and (l.dt_geracao between dt_inicial_w and dt_final_w)
	or (ie_tipo_data_w = 'C')
	and (f.dt_mes_competencia between dt_inicial_w and dt_final_w)))
	or	(ie_status_p = 'C' AND f.dt_cancelamento_fat between dt_inicial_w and dt_final_w)) and coalesce(f.ie_cancelamento,'X') = 'X' and ((coalesce(ie_tipo_segurado_w, 'X')	= coalesce(c.ie_tipo_segurado, 'X'))
	or (coalesce(ie_tipo_segurado_w, 'X')	= 'X')) and i.ie_pls = 'S' and coalesce(a.ie_status_faturamento, 'A') <> 'A' group by t.nr_contrato,
		t.dt_contrato,
		t.dt_rescisao_contrato,
		n.ie_tipo_contratacao,
		n.ie_segmentacao,
		n.ie_preco,
		n.ie_regulamentacao,
		substr(CASE WHEN n.ie_tipo_operacao='A' THEN  'SCA'  ELSE coalesce(n.nr_protocolo_ans, n.cd_scpa) END ,1,20),
		s.dt_rescisao,
		(s.dt_rescisao + 30),
		substr(pls_obter_dados_segurado(s.nr_sequencia,'C'),1,30),
		substr(pls_obter_dados_segurado(s.nr_sequencia,'N'),1,255),
		substr(pls_obter_dados_segurado(s.nr_sequencia,'CPF'),1,255),
		i.nr_titulo,
		c.nr_sequencia,
		i.dt_emissao,
		substr(pls_obter_parcela_contrato(t.nr_sequencia,f.dt_mes_competencia),1,10),
		i.dt_vencimento,
		d.cd_conta_deb_taxa,
		d.cd_conta_cred_taxa,
		f.dt_mes_competencia,
		s.nr_sequencia,
		c.ie_tipo_segurado,
		i.vl_titulo,
		s.dt_contratacao,
		f.dt_cancelamento_fat,
		x.dt_mes_competencia,
		a.nr_seq_conta_mat,
		x.nr_seq_congenere,
		s.dt_rescisao,
		s.nr_seq_pagador
	order by nr_documento;
	/*Atentar-se para ordenacao, pois influencia na logica dos rateios, caso precisar adicionar o nr da conta como documento, verificar logica de rateio para o nr da conta*/

vet_titulo c_titulo%rowtype;

BEGIN

CALL wheb_usuario_pck.set_ie_executar_trigger('N');

select	coalesce(max(a.ie_gerar_ind_classif),'N'),
	max(ie_tipo_segurado),
	coalesce(max(ie_tipo_movimentacao),'A')
into STRICT	ie_gerar_ind_classif_w,
	ie_tipo_segurado_w,
	ie_tipo_movimentacao_w
from	ctb_livro_auxiliar	a
where	a.nr_sequencia	= nr_seq_regra_p;

select	coalesce(max(a.ie_gerar_fat_contab),'N')
into STRICT	ie_gerar_fat_contab_w
from	pls_parametro_faturamento	a
where	a.cd_estabelecimento	= cd_estabelecimento_p;

select	coalesce(max(a.ie_data_rec_faturamento),'MC')
into STRICT	ie_data_rec_faturamento_w
from	pls_parametro_contabil	a
where	a.cd_estabelecimento	= cd_estabelecimento_p;

select	coalesce(max(a.ie_data_tipo_segurado),'A')
into STRICT	ie_data_tipo_segurado_w
from	pls_parametros a
where	a.cd_estabelecimento = cd_estabelecimento_p;

select	substr(obter_desc_expressao(922923),1,255)
into STRICT	ds_observacao_w
;

dt_inicial_w	:= trunc(dt_inicial_p,'month');
dt_final_w	:= fim_dia(dt_final_p);


if (ie_gerar_arquivo_p = 'N') then

	select	coalesce(max(a.ie_tipo_data),'E')
	into STRICT	ie_tipo_data_w
	from	ctb_livro_auxiliar	a
	where	a.nr_sequencia	= nr_seq_regra_p;

	delete
	from	w_ctb_aux_contra_emit a
	where	nr_seq_reg_auxiliar = nr_seq_regra_p;

	commit;

	open c_titulo;
	loop
	fetch c_titulo into
		vet_titulo;
	EXIT WHEN NOT FOUND; /* apply on c_titulo */
		begin		
		nr_contador_w := nr_contador_w + 1;
	
		SELECT * FROM pls_obter_dados_repasse(	vet_titulo.dt_ref_repasse, vet_titulo.nr_seq_segurado, vet_titulo.nr_seq_congenere, ie_tipo_repasse_w, ie_tipo_compartilhamento_w, dt_repasse_w, dt_fim_repasse_w) INTO STRICT ie_tipo_repasse_w, ie_tipo_compartilhamento_w, dt_repasse_w, dt_fim_repasse_w;

		select	coalesce(sum(x.vl_recebido),0) + coalesce(sum(x.vl_descontos),0) vl_recebido,
			coalesce(sum(x.vl_multa + x.vl_juros),0),
			max(x.dt_recebimento)
		into STRICT	vl_recebido_w,
			vl_multa_juros_w,
			dt_recebimento_w
		from	titulo_receber_liq x
		where	x.nr_titulo = vet_titulo.nr_titulo;
		
		if	(nr_titulo_ant_w <> vet_titulo.nr_titulo AND nr_contador_w <> 1) then
			if (trunc(vl_sobra_w,2) > 0) then
				ctb_aux_contra_emit_w[nr_contador_w - 1].vl_parcela          	:= ctb_aux_contra_emit_w[nr_contador_w - 1].vl_parcela + vl_sobra_w;
			end if;
			
			if (trunc(vl_sobra_recebido_w,2) > 0) then
				ctb_aux_contra_emit_w[nr_contador_w - 1].vl_rec_cobertura       := ctb_aux_contra_emit_w[nr_contador_w - 1].vl_rec_cobertura + vl_sobra_recebido_w;
			end if;	
				
			vl_sobra_w		:= 0;
			vl_sobra_recebido_w	:= 0;
		end if;

		vl_tributo_w := 0;
		if (vet_titulo.nr_seq_mensalidade IS NOT NULL AND vet_titulo.nr_seq_mensalidade::text <> '') then
			select	coalesce(sum(a.vl_tributo), 0)
			into STRICT	vl_tributos_mens_w
			from	pls_mensalidade_trib a
			where	a.nr_seq_mensalidade	= vet_titulo.nr_seq_mensalidade;

			select	coalesce(sum(a.vl_tributo), 0)
			into STRICT	vl_tributos_tit_w
			from	titulo_receber_trib a
			where	a.nr_titulo = vet_titulo.nr_titulo
			and	not exists (	SELECT	1
						from	pls_mensalidade_trib b
						where	b.cd_tributo = a.cd_tributo
						and	b.nr_seq_mensalidade = vet_titulo.nr_seq_mensalidade);

			vl_tributo_w := vl_tributos_mens_w + vl_tributos_tit_w;
		end if;
		
		vl_parcela_int_w	:= dividir_sem_round(vet_titulo.vl_apropriado * (vet_titulo.vl_mensalidade - vl_tributo_w),vet_titulo.vl_mensalidade);
		vl_parcela_w		:= trunc(vl_parcela_int_w,2);
		vl_sobra_w		:= vl_sobra_w + (vl_parcela_int_w - vl_parcela_w);
		
		vl_parcela_int_w	:= dividir_sem_round(vl_recebido_w * vet_titulo.vl_apropriado, vet_titulo.vl_mensalidade);
		vl_recebido_w		:= trunc(vl_parcela_int_w,2);
		vl_sobra_recebido_w	:= vl_sobra_recebido_w + (vl_parcela_int_w - vl_recebido_w);
						
		if (vl_multa_juros_w > 0) then
			vl_multa_juros_w := round((dividir_sem_round(vl_multa_juros_w,vet_titulo.vl_mensalidade) * vet_titulo.vl_apropriado)::numeric,2);
		end if;
		
		select	CASE WHEN vl_parcela_w=0 THEN vet_titulo.vl_apropriado  ELSE vl_parcela_w END
		into STRICT	vl_parcela_w
		;
		
		select	nextval('w_ctb_aux_contra_emit_seq')
		into STRICT	nr_seq_ctb_aux_emit_w
		;

		ctb_aux_contra_emit_w[nr_contador_w].nr_sequencia 		:= nr_seq_ctb_aux_emit_w;
		ctb_aux_contra_emit_w[nr_contador_w].dt_atualizacao        	:= clock_timestamp();
		ctb_aux_contra_emit_w[nr_contador_w].nm_usuario            	:= nm_usuario_p;
		ctb_aux_contra_emit_w[nr_contador_w].dt_atualizacao_nrec   	:= clock_timestamp();
		ctb_aux_contra_emit_w[nr_contador_w].nm_usuario_nrec       	:= nm_usuario_p;
		ctb_aux_contra_emit_w[nr_contador_w].nr_titulo             	:= vet_titulo.nr_titulo;
		ctb_aux_contra_emit_w[nr_contador_w].dt_emissao            	:= vet_titulo.dt_emissao;
		ctb_aux_contra_emit_w[nr_contador_w].dt_vencimento         	:= vet_titulo.dt_vencimento;
		ctb_aux_contra_emit_w[nr_contador_w].nr_contrato           	:= vet_titulo.nr_contrato;
		ctb_aux_contra_emit_w[nr_contador_w].cd_beneficiario       	:= vet_titulo.cd_beneficiario;
		ctb_aux_contra_emit_w[nr_contador_w].nm_usuario_principal  	:= vet_titulo.nm_usuario_principal;
		ctb_aux_contra_emit_w[nr_contador_w].cd_cpf_cnpj           	:= vet_titulo.cd_cpf_cnpj;
		ctb_aux_contra_emit_w[nr_contador_w].ie_preco              	:= vet_titulo.ie_modalidade_contrat;
		ctb_aux_contra_emit_w[nr_contador_w].ds_modalidade_contrat 	:= obter_valor_dominio(1669,vet_titulo.ie_modalidade_contrat);
		ctb_aux_contra_emit_w[nr_contador_w].ie_regulamentacao     	:= vet_titulo.ie_regulamentacao;
		ctb_aux_contra_emit_w[nr_contador_w].ds_regulamentacao     	:= obter_valor_dominio(2157,vet_titulo.ie_regulamentacao);
		ctb_aux_contra_emit_w[nr_contador_w].ie_tipo_contratacao   	:= vet_titulo.ie_tipo_contratacao;
		ctb_aux_contra_emit_w[nr_contador_w].ds_tipo_contratacao   	:= obter_valor_dominio(1666,vet_titulo.ie_tipo_contratacao);
		ctb_aux_contra_emit_w[nr_contador_w].ie_segmentacao        	:= vet_titulo.ie_segmentacao;
		ctb_aux_contra_emit_w[nr_contador_w].ds_segmentacao        	:= obter_valor_dominio(1665,vet_titulo.ie_segmentacao);
		ctb_aux_contra_emit_w[nr_contador_w].ds_definicao_atos     	:= obter_valor_dominio(3418,vet_titulo.ie_definicao_atos);
		ctb_aux_contra_emit_w[nr_contador_w].nr_protocolo_ans      	:= vet_titulo.nr_protocolo_ans;
		ctb_aux_contra_emit_w[nr_contador_w].dt_inicio_cobertura   	:= vet_titulo.dt_inicio_cobertura;
		ctb_aux_contra_emit_w[nr_contador_w].dt_fim_cobertura      	:= vet_titulo.dt_fim_cobertura;
		ctb_aux_contra_emit_w[nr_contador_w].vl_parcela            	:= vl_parcela_w;
		ctb_aux_contra_emit_w[nr_contador_w].vl_contrato           	:= vet_titulo.vl_apropriado;
		ctb_aux_contra_emit_w[nr_contador_w].vl_apropriado         	:= vet_titulo.vl_apropriado;
		ctb_aux_contra_emit_w[nr_contador_w].vl_rec_cobertura      	:= vl_recebido_w;
		ctb_aux_contra_emit_w[nr_contador_w].vl_multa_juros        	:= vl_multa_juros_w;
		ctb_aux_contra_emit_w[nr_contador_w].dt_baixa              	:= dt_recebimento_w;
		ctb_aux_contra_emit_w[nr_contador_w].cd_conta_debito       	:= vet_titulo.cd_conta_debito;
		ctb_aux_contra_emit_w[nr_contador_w].cd_conta_contabil     	:= vet_titulo.cd_conta_contabil;
		ctb_aux_contra_emit_w[nr_contador_w].cd_conta_cred_encargos	:= vet_titulo.cd_conta_cred_encargos;
		ctb_aux_contra_emit_w[nr_contador_w].dt_contrato           	:= vet_titulo.dt_contrato;
		ctb_aux_contra_emit_w[nr_contador_w].dt_rescisao           	:= vet_titulo.dt_rescisao_seg;
		ctb_aux_contra_emit_w[nr_contador_w].nr_documento          	:= vet_titulo.nr_documento;
		ctb_aux_contra_emit_w[nr_contador_w].nr_parcela            	:= vet_titulo.nr_parcela;
		ctb_aux_contra_emit_w[nr_contador_w].dt_referencia         	:= vet_titulo.dt_contabilizacao;
		ctb_aux_contra_emit_w[nr_contador_w].ie_tipo_livro         	:= 1;
		ctb_aux_contra_emit_w[nr_contador_w].nr_seq_reg_auxiliar   	:= nr_seq_regra_p;
		ctb_aux_contra_emit_w[nr_contador_w].nr_linha              	:= nr_contador_w;
		ctb_aux_contra_emit_w[nr_contador_w].nr_seq_segurado       	:= vet_titulo.nr_seq_segurado;
		ctb_aux_contra_emit_w[nr_contador_w].ie_tipo_documento     	:= vet_titulo.ie_tipo_documento;
		ctb_aux_contra_emit_w[nr_contador_w].ds_tipo_documento     	:= obter_valor_dominio(8372,vet_titulo.ie_tipo_documento);
		ctb_aux_contra_emit_w[nr_contador_w].ie_tipo_segurado     	:= vet_titulo.ie_tipo_segurado;
		ctb_aux_contra_emit_w[nr_contador_w].dt_contratacao     	:= vet_titulo.dt_contratacao;
		ctb_aux_contra_emit_w[nr_contador_w].dt_cancelamento     	:= vet_titulo.dt_cancelamento;
		ctb_aux_contra_emit_w[nr_contador_w].ie_tipo_compartilhamento	:= ie_tipo_compartilhamento_w;
		ctb_aux_contra_emit_w[nr_contador_w].ie_tipo_repasse		:= ie_tipo_repasse_w;
		ctb_aux_contra_emit_w[nr_contador_w].dt_inicio_compartilhamento	:= dt_repasse_w;
		ctb_aux_contra_emit_w[nr_contador_w].dt_fim_compartilhamento	:= dt_fim_repasse_w;
		ctb_aux_contra_emit_w[nr_contador_w].nr_seq_pagador     	:= vet_titulo.nr_seq_pagador;
		
		if (vet_titulo.ie_tipo_segurado in ('C','I','T')) then
			ctb_aux_contra_emit_w[nr_contador_w].ds_observacao	:= ds_observacao_w;
		else
			ctb_aux_contra_emit_w[nr_contador_w].ds_observacao	:= null;
		end if;

		nr_titulo_ant_w	:= vet_titulo.nr_titulo;

		end;
	end loop;
	close c_titulo;
	
	if (ctb_aux_contra_emit_w.count > 0) then
		ctb_aux_contra_emit_w[nr_contador_w].vl_parcela		:= ctb_aux_contra_emit_w[nr_contador_w].vl_parcela + vl_sobra_w;
		ctb_aux_contra_emit_w[nr_contador_w].vl_rec_cobertura	:= ctb_aux_contra_emit_w[nr_contador_w].vl_rec_cobertura + vl_sobra_recebido_w;

		forall i in ctb_aux_contra_emit_w.first .. ctb_aux_contra_emit_w.last
			insert into w_ctb_aux_contra_emit values ctb_aux_contra_emit_w(i);

		commit;
	end if;
	
	update	ctb_livro_auxiliar
	set	qt_registros	= nr_contador_w
	where	nr_sequencia	= nr_seq_regra_p;

	commit;
	
end if;

if (ie_gerar_arquivo_p = 'S') then
	begin
	nm_arquivo_w	:= 'RegAuxContratosContrapEmitidas' || to_char(clock_timestamp(),'ddmmyyyyhh24miss') || nm_usuario_p || '.csv';
	ds_nome_livro_w	:= substr(obter_desc_expressao(776813), 1, 255);
 	ds_periodo_w	:= wheb_mensagem_pck.get_texto(1098702,'DT_INICIAL=' || dt_inicial_w || ';' ||'DT_FINAL=' || dt_final_w || ';' || 'DT_LIBERACAO=' || dt_liberacao_p);

	SELECT * FROM obter_evento_utl_file(1, null, ds_local_w, ds_erro_w) INTO STRICT ds_local_w, ds_erro_w;

	arq_texto_w := utl_file.fopen(ds_local_w,nm_arquivo_w,'W', 32000);

	utl_file.put_line(arq_texto_w, ds_nome_livro_w);
	utl_file.put_line(arq_texto_w, ds_periodo_w);
	utl_file.put_line(arq_texto_w, substr(obter_desc_expressao(1037483), 1, 4000));
	utl_file.fflush(arq_texto_w);
	for vetl in c_linha loop
		begin
		utl_file.put_line(arq_texto_w,vetl.ds_linha);
		utl_file.fflush(arq_texto_w);
		end;
	end loop;
	end;
end if;

commit;

CALL wheb_usuario_pck.set_ie_executar_trigger('S');

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ctb_gerar_contra_emitida_co ( nm_usuario_p usuario.nm_usuario%type, cd_empresa_p empresa.cd_empresa%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, dt_inicial_p ctb_livro_auxiliar.dt_inicial%type, dt_final_p ctb_livro_auxiliar.dt_final%type, ie_status_p ctb_livro_auxiliar.ie_tipo_livro_ecd%type, dt_liberacao_p ctb_livro_auxiliar.dt_liberacao%type, ie_gerar_arquivo_p ctb_livro_auxiliar.ie_tipo_livro_ecd%type, nr_seq_regra_p ctb_livro_auxiliar.nr_sequencia%type) FROM PUBLIC;

