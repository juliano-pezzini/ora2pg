-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE reactivate_all_alerts ( nr_atendimento_p bigint, nr_tempo_reativacao_p bigint) AS $body$
DECLARE


cd_pessoa_fisica_w  smart_alert.cd_pessoa_fisica%type;
ie_tipo_alerta_w    smart_alert.ie_tipo_alerta%type;
ie_reativacao_existe_w  integer;
dt_reativacao_w     smart_alert_reativacao.dt_reativacao%type;

alertas_ativos CURSOR FOR
SELECT DISTINCT ie_tipo_alerta, cd_pessoa_fisica 
FROM SMART_ALERT 
WHERE ie_status = 'A' 
AND nr_atendimento = nr_atendimento_p;


BEGIN

dt_reativacao_w := clock_timestamp() + (1 / 1440 * nr_tempo_reativacao_p);

/*  UPDATE REACTIVATE SMART_ALERT */

UPDATE SMART_ALERT_REATIVACAO
SET DT_REATIVACAO = dt_reativacao_w
WHERE nr_atendimento = nr_atendimento_p
AND clock_timestamp() < dt_reativacao;

open alertas_ativos;
loop
fetch alertas_ativos into
    ie_tipo_alerta_w,
    cd_pessoa_fisica_w;
EXIT WHEN NOT FOUND; /* apply on alertas_ativos */
    begin

    SELECT COUNT(*)
    INTO STRICT ie_reativacao_existe_w
    FROM SMART_ALERT_REATIVACAO
    WHERE nr_atendimento = nr_atendimento_p
    AND ie_tipo_alerta = ie_tipo_alerta_w;

    if (ie_reativacao_existe_w > 0) then
        UPDATE SMART_ALERT_REATIVACAO
        SET DT_REATIVACAO = dt_reativacao_w,
            NM_USUARIO_NREC = wheb_usuario_pck.get_nm_usuario(),
            DT_ATUALIZACAO_NREC = clock_timestamp()
        WHERE nr_atendimento = nr_atendimento_p
        AND ie_tipo_alerta = ie_tipo_alerta_w;
    else
        INSERT INTO SMART_ALERT_REATIVACAO(nr_sequencia,
            nr_atendimento,
            cd_pessoa_fisica,
            ie_tipo_alerta,
            dt_reativacao,
            nm_usuario,
            dt_atualizacao)
        VALUES (nextval('smart_alert_reativacao_seq'),
            nr_atendimento_p,
            cd_pessoa_fisica_w,
            ie_tipo_alerta_w,
            dt_reativacao_w,
            wheb_usuario_pck.get_nm_usuario(),
            clock_timestamp());
    end if;

    end;
end loop;
close alertas_ativos;

UPDATE SMART_ALERT
SET ie_status  = 'I'
WHERE ie_status  = 'A'
AND nr_atendimento = nr_atendimento_p;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE reactivate_all_alerts ( nr_atendimento_p bigint, nr_tempo_reativacao_p bigint) FROM PUBLIC;

