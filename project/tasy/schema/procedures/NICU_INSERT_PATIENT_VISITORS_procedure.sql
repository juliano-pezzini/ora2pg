-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE nicu_insert_patient_visitors (nr_sequencia_p nicu_patient_visitors.nr_sequencia%type, nm_usuario_p nicu_patient_visitors.nm_usuario%type, nr_seq_patient_p nicu_patient_visitors.nr_seq_patient%type, ds_name_p nicu_patient_visitors.ds_name%type, ie_relationship_p nicu_patient_visitors.ie_relationship%type, mensagem_erro_o INOUT text) AS $body$
DECLARE

  
  nr_sequencia_pat_visitors_w  nicu_patient_visitors.nr_sequencia%type;
  exeption_w                   exception;

BEGIN

  if (coalesce(nr_sequencia_p::text, '') = '') then
    --BUSCA NOVO SEQUENCIAL PARA NICU_PARENT
    select nextval('nicu_patient_visitors_seq')
      into STRICT nr_sequencia_pat_visitors_w
;
  else
    nr_sequencia_pat_visitors_w := nr_sequencia_p;
  end if;

  begin
    insert into nicu_patient_visitors(nr_sequencia,
         dt_atualizacao,
         nm_usuario,
         dt_atualizacao_nrec,
         nm_usuario_nrec,
         nr_seq_patient,
         ds_name,
         ie_relationship)
    values (nr_sequencia_pat_visitors_w,
         clock_timestamp(),
         nm_usuario_p,
         clock_timestamp(),
         nm_usuario_p,
         nr_seq_patient_p,
         ds_name_p,
         ie_relationship_p);
  exception
    when unique_violation then
      begin
        update nicu_patient_visitors
           set dt_atualizacao      = clock_timestamp(),
               nm_usuario          = nm_usuario_p,
               dt_atualizacao_nrec = clock_timestamp(),
               nm_usuario_nrec     = nm_usuario_p,
               nr_seq_patient      = nr_seq_patient_p,
               ds_name             = ds_name_p,
               ie_relationship     = ie_relationship_p
         where nr_sequencia = nr_sequencia_pat_visitors_w;
      exception 
        when others then
          mensagem_erro_o := expressao_pck.obter_desc_expressao(776218)||' Error: '||sqlerrm;
          raise exeption_w;
      end;
    when others then
      mensagem_erro_o := expressao_pck.obter_desc_expressao(776218)||' Error: '||sqlerrm;
      raise exeption_w;
  end;

  commit;
exception
  when exeption_w then
    rollback;
  when others then
    mensagem_erro_o := expressao_pck.obter_desc_expressao(776218)||' Error: '||sqlerrm;
    rollback;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE nicu_insert_patient_visitors (nr_sequencia_p nicu_patient_visitors.nr_sequencia%type, nm_usuario_p nicu_patient_visitors.nm_usuario%type, nr_seq_patient_p nicu_patient_visitors.nr_seq_patient%type, ds_name_p nicu_patient_visitors.ds_name%type, ie_relationship_p nicu_patient_visitors.ie_relationship%type, mensagem_erro_o INOUT text) FROM PUBLIC;

