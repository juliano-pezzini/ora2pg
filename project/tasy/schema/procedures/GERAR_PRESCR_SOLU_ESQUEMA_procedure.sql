-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_prescr_solu_esquema (nr_seq_cirur_agente_p cirurgia_agente_anestesico.nr_sequencia%type, nr_prescricao_p prescr_medica.nr_prescricao%type, nr_seq_solucao_p prescr_solucao.nr_seq_solucao%type) AS $body$
DECLARE

																
qt_total_solucao_w			prescr_material.qt_solucao%type;															
nr_etapas_w					prescr_solucao.nr_etapas%type;
qt_hora_fase_w				prescr_solucao.qt_hora_fase%type;
qt_volume_fase_w			prescr_solucao_esquema.qt_volume%type;
nr_cirurgia_w				cirurgia.nr_cirurgia%type;
nr_seq_pepo_w				cirurgia_agente_anestesico.nr_seq_pepo%type;
ie_modo_registro_w			cirurgia_agente_anest_ocor.ie_modo_registro%type;
nr_seq_mat_cpoe_w			cpoe_material.nr_sequencia%type;
qt_tempo_total_w			double precision;
ie_prescr_esquema_w			varchar(1);

C02 CURSOR FOR
SELECT	a.*, row_number() OVER () AS nr_etapa
from 	cirurgia_agente_anest_ocor a
where	nr_seq_cirur_agente = nr_seq_cirur_agente_p
and (dt_final_adm IS NOT NULL AND dt_final_adm::text <> '')
order by nr_sequencia;
	
BEGIN	

select max(nr_cirurgia),
	max(nr_seq_pepo),
	max(nr_seq_mat_cpoe)
into STRICT nr_cirurgia_w,
	nr_seq_pepo_w,
	nr_seq_mat_cpoe_w
from cirurgia_agente_anestesico
where	nr_sequencia = nr_seq_cirur_agente_p;

CALL gerar_resumo_agente(nr_cirurgia_w, wheb_usuario_pck.get_nm_usuario, wheb_usuario_pck.get_cd_estabelecimento, coalesce(nr_seq_pepo_w,0));

for c02_w in C02 loop
	ie_modo_registro_w := c02_w.ie_modo_registro;
	if (c02_w.ie_modo_registro = 'V' and (c02_w.dt_final_adm IS NOT NULL AND c02_w.dt_final_adm::text <> '')) then				
			qt_tempo_total_w :=  round(coalesce(qt_tempo_total_w,0) + ((c02_w.dt_final_adm - c02_w.dt_inicio_adm) * 1440) / 60, 3);
	end if;

	nr_etapas_w := coalesce(nr_etapas_w, 0) + 1;
	
end loop;

if (coalesce(ie_modo_registro_w, 'XPTO') = 'V') then

	select	sum(Obter_conversao_ml(cd_material, qt_dose, cd_unidade_medida))
	into STRICT	qt_total_solucao_w
	from	w_agente_adm
	where 	nr_seq_cir_agente_anest = nr_seq_cirur_agente_p;
	
	if (coalesce(qt_total_solucao_w,0) > 0) then
	
		update 	prescr_solucao
		set		qt_solucao_total = coalesce(qt_total_solucao_w, 0),
				qt_volume = coalesce(qt_total_solucao_w, 0),
				nr_etapas = nr_etapas_w
		where 	nr_seq_solucao = nr_seq_solucao_p
		and		nr_prescricao = nr_prescricao_p;
		
		update    prescr_material
		set    qt_dose = Obter_dose_convertida(cd_material, qt_total_solucao_w, 'ml', cd_unidade_medida_dose),
			   qt_solucao = qt_total_solucao_w
		where nr_prescricao = nr_prescricao_p
		and    nr_sequencia_solucao = nr_seq_solucao_p;
		
		commit;
		
	end if;
else

	select	sum(qt_solucao)
	into STRICT	qt_total_solucao_w
	from 	prescr_material
	where	nr_sequencia_solucao = nr_seq_solucao_p
	and		nr_prescricao = nr_prescricao_p;

	qt_total_solucao_w := coalesce(qt_total_solucao_w, 0) * coalesce(nr_etapas_w, 0);

	update	prescr_solucao
	set	qt_solucao_total = coalesce(qt_total_solucao_w, 0),
		qt_volume = coalesce(qt_total_solucao_w, 0),
		nr_etapas = nr_etapas_w
	where	nr_seq_solucao = nr_seq_solucao_p
	and	nr_prescricao = nr_prescricao_p;
end if;

for c02_w in C02 loop
	
	select coalesce(max('S'),'N')
	into STRICT ie_prescr_esquema_w
	from prescr_solucao_esquema
	where nr_prescricao = nr_prescricao_p
	and nr_seq_solucao = nr_seq_solucao_p
	and ds_horario = to_char(c02_w.dt_inicio_adm, 'hh24:mi');
	
	if (ie_prescr_esquema_w = 'N') then
		if (c02_w.ie_modo_registro = 'V') then
			if (c02_w.dt_final_adm IS NOT NULL AND c02_w.dt_final_adm::text <> '') then
				qt_hora_fase_w := round(((c02_w.dt_final_adm - c02_w.dt_inicio_adm) * 1440) / 60,3);
				qt_volume_fase_w := round((qt_total_solucao_w * ((qt_hora_fase_w * 100) / qt_tempo_total_w)) / 100, 3);
			else
				qt_hora_fase_w := 0;
				qt_volume_fase_w := 0;
			end if;
		else
			qt_volume_fase_w := coalesce(c02_w.qt_dose, c02_w.qt_dose_ataque);
		end if;
		
		if (coalesce(qt_volume_fase_w, 0 ) > 0) then
			insert into prescr_solucao_esquema(
					nr_sequencia,
					nr_prescricao,
					nr_seq_solucao,
					dt_atualizacao,
					dt_atualizacao_nrec,
					nm_usuario,
					nm_usuario_nrec,
					ds_horario,
					nr_etapa,
					qt_volume,
					qt_dosagem,
					qt_hora_fase
				) values (
					nextval('prescr_solucao_esquema_seq'),
					nr_prescricao_p,
					nr_seq_solucao_p,
					clock_timestamp(),
					clock_timestamp(),
					wheb_usuario_pck.get_nm_usuario,
					wheb_usuario_pck.get_nm_usuario,
					to_char(c02_w.dt_inicio_adm, 'hh24:mi'),
					c02_w.nr_etapa,
					coalesce(qt_volume_fase_w, 0),
					c02_w.qt_velocidade_inf,
					qt_hora_fase_w);
		end if;

	
		if (coalesce(nr_seq_mat_cpoe_w, 0) > 0) then
			update cpoe_material
			set ds_dose_diferenciada = 	replace(ds_dose_diferenciada || CASE WHEN ds_dose_diferenciada = NULL THEN  ''   ELSE '-' END  || campo_mascara_virgula(Obter_dose_convertida(cd_material, qt_volume_fase_w, 'ml', cd_unidade_medida)), '--', '-'),
				nr_etapas = nr_etapas_w,
				qt_solucao_total = coalesce(qt_total_solucao_w, 0),
				qt_dosagem_diferenciada = replace(qt_dosagem_diferenciada || CASE WHEN qt_dosagem_diferenciada = NULL THEN  ''   ELSE '-' END  || campo_mascara_virgula(c02_w.qt_velocidade_inf), '--', '-'),
				ds_horarios = replace(ds_horarios || CASE WHEN ds_horarios = NULL THEN  ''   ELSE ' ' END  || to_char(c02_w.dt_inicio_adm, 'hh24:mi'), '  ', ' '),
				qt_hora_fase_diferenciada = replace(qt_hora_fase_diferenciada || CASE WHEN qt_hora_fase_diferenciada = NULL THEN  ''   ELSE '-' END  || obter_horas_minutos(qt_hora_fase_w*60), '--', '-'),
				ds_volume_diferenciado = replace(ds_volume_diferenciado || CASE WHEN ds_volume_diferenciado = NULL THEN  ''   ELSE '-' END  ||campo_mascara_virgula(qt_volume_fase_w), '--', '-')
			where nr_sequencia = nr_seq_mat_cpoe_w;
			
		end if;
	end if;
end loop;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_prescr_solu_esquema (nr_seq_cirur_agente_p cirurgia_agente_anestesico.nr_sequencia%type, nr_prescricao_p prescr_medica.nr_prescricao%type, nr_seq_solucao_p prescr_solucao.nr_seq_solucao%type) FROM PUBLIC;

