-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE cpoe_calc_dose_terap_vel ( cd_material_p bigint, qt_peso_p bigint, qt_dose_terap_p INOUT bigint, nr_unid_med_terap_p bigint, qt_vel_infusao_p INOUT bigint, ie_unidade_vel_p text, qt_concent_final_p bigint, cd_unidade_med_concent_p cpoe_material.cd_unidade_medida%type) AS $body$
DECLARE



qt_velocidade_w				double precision;
qt_dose_direta_w			double precision;
qt_dose_ml_w				double precision;
ie_unidade_w				regra_dose_terap.ie_unidade%type;
ie_tempo_w					varchar(15);
ie_peso_w					varchar(15);
qt_peso_w					double precision;
qt_casas_retorno_w			integer;
qt_dose_terap_w				double precision;
cd_unidade_medida_concent_w	unidade_medida.cd_unidade_medida%type;
cd_unidade_med_dose_terap_w unidade_medida.cd_unidade_medida%type;


BEGIN

if (cd_material_p > 0) then

	select	coalesce(max(qt_casas),0)
	into STRICT	qt_casas_retorno_w
	from	rep_regra_arredond_dose
	where	qt_peso_p between qt_peso_inicial and qt_peso_final;

	if (qt_casas_retorno_w = 0) then
		qt_casas_retorno_w := obter_param_usuario(1903, 2, wheb_usuario_pck.get_cd_perfil, wheb_usuario_pck.get_nm_usuario, 0, qt_casas_retorno_w);
	end if;

	if (qt_casas_retorno_w = 0) then
		qt_casas_retorno_w	:= 4;
	end if;

	select	max(ie_tempo),
			max(ie_peso),
			max(ie_unidade)
	into STRICT	ie_tempo_w,
			ie_peso_w,
			ie_unidade_w
	from	regra_dose_terap
	where	nr_sequencia	= nr_unid_med_terap_p;

	select 	max(a.cd_unidade_medida)
	into STRICT	cd_unidade_medida_concent_w
	from 	material_conversao_unidade a,
		unidade_medida b
	where	a.cd_material = cd_material_p
	and a.cd_unidade_medida = b.cd_unidade_medida
	and upper(b.ie_unidade_med_inter) = upper(cd_unidade_med_concent_p);
	
	select 	max(a.cd_unidade_medida)
	into STRICT	cd_unidade_med_dose_terap_w
	from 	material_conversao_unidade a,
		unidade_medida b
	where	a.cd_material = cd_material_p
	and a.cd_unidade_medida = b.cd_unidade_medida
	and upper(b.ie_unidade_med_inter) = upper(ie_unidade_w);
	
	qt_dose_terap_w := obter_dose_convertida(cd_material_p, qt_dose_terap_p, cd_unidade_med_dose_terap_w, cd_unidade_medida_concent_w);

	qt_peso_w	:= qt_peso_p;
	if (ie_peso_w = 'G') then
		qt_peso_w	:= qt_peso_p * 1000;
	end if;
		
	if (qt_dose_terap_w > 0) then

		qt_dose_direta_w	:= qt_dose_terap_w;

		-- Conversao p/ unidade direta do elemento se for por peso
		if (ie_peso_w IS NOT NULL AND ie_peso_w::text <> '') then
			qt_dose_direta_w	:= qt_peso_w * qt_dose_terap_w;
		end if;
		

		qt_dose_ml_w	:= dividir_sem_round(qt_dose_direta_w, qt_concent_final_p);

		if (ie_tempo_w ='M') or (ie_tempo_w ='H') then
			-- Transformar em ml/hora
			if (upper(ie_unidade_vel_p) = 'MLH') then
				if (ie_tempo_w ='M') then
					qt_dose_ml_w	:= qt_dose_ml_w * 60;
				end if;
			end if;

			-- Transformar em gotas/minuto
			if (upper(ie_unidade_vel_p) = 'GTM') then
				qt_dose_ml_w	:= qt_dose_ml_w * 20;
				if (ie_tempo_w ='H') then
					qt_dose_ml_w	:= dividir(qt_dose_ml_w,60);
				end if;
			end if;

			-- Transformar em microgotas/minuto
			if (upper(ie_unidade_vel_p) = 'MGM') then
				qt_dose_ml_w	:= qt_dose_ml_w * 60;
				if (ie_tempo_w ='H') then
					qt_dose_ml_w	:= dividir(qt_dose_ml_w,60);
				end if;
			end if;
			
			qt_vel_infusao_p	:= qt_dose_ml_w;
		else
			qt_vel_infusao_p	:= qt_dose_ml_w;
		end if;

	else
	
		qt_velocidade_w		:= qt_vel_infusao_p;

		if (upper(ie_unidade_vel_p) = 'GTM') then
			qt_velocidade_w	:= dividir(qt_vel_infusao_p,20) * 60;
		end if;

		qt_dose_terap_w	:= qt_concent_final_p * qt_velocidade_w;
		
		if (ie_peso_w = 'KG') then
			qt_dose_terap_w	:= dividir(qt_dose_terap_w,qt_peso_p);
		end if;
		
		if (ie_tempo_w = 'M') then
			qt_dose_terap_w	:= dividir(qt_dose_terap_w,60);
		end if;
		
		
		qt_dose_terap_p := obter_dose_convertida(cd_material_p, qt_dose_terap_w, cd_unidade_medida_concent_w, cd_unidade_med_dose_terap_w);

	end if;

	qt_vel_infusao_p := round(qt_vel_infusao_p, qt_casas_retorno_w);
else
	qt_vel_infusao_p	:= null;
end if;


end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cpoe_calc_dose_terap_vel ( cd_material_p bigint, qt_peso_p bigint, qt_dose_terap_p INOUT bigint, nr_unid_med_terap_p bigint, qt_vel_infusao_p INOUT bigint, ie_unidade_vel_p text, qt_concent_final_p bigint, cd_unidade_med_concent_p cpoe_material.cd_unidade_medida%type) FROM PUBLIC;

