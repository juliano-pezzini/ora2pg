-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE sib_importar_devolucao_resumo ( nr_seq_lote_sib_p bigint, nm_usuario_p text) AS $body$
DECLARE


nr_seq_cabecalho_w		bigint;
ds_texto_w			varchar(2000);
nr_registro_w			bigint;
ie_mensagem_w			varchar(2);
cd_cnpj_w			varchar(14);
ie_tipo_item_w			varchar(1);
nr_operadora_w			bigint;

ds_razao_social_w		varchar(255);
nm_arquivo_w			varchar(255);
qt_inclusao_total_w		bigint;
qt_inclusao_processado_w	bigint;
qt_inclusao_recusado_w		bigint;
pr_inclusao_acerto_w		double precision;
qt_alteracao_total_w		bigint;
qt_alteracao_processado_w	bigint;
qt_alteracao_recusado_w		bigint;
pr_alteracao_acerto_w		double precision;
qt_exclusao_total_w		bigint;
qt_exclusao_processado_w	bigint;
qt_exclusao_recusado_w		bigint;
pr_exclusao_acerto_w		double precision;
qt_reinclusao_total_w		bigint;
qt_reinclusao_processado_w	bigint;
qt_reinclusao_recusado_w	bigint;
pr_reinclusao_acerto_w		double precision;
qt_total_w			bigint;
qt_processados_w		bigint;
qt_recusados_w			bigint;
pr_total_w			double precision;
qt_total_reg_07_w		bigint;
qt_total_reg_07_inclusao_w	bigint;
qt_total_reg_07_recusado_w	bigint;
pr_total_reg_07_w		double precision;
qt_total_reg_09_w		bigint;
qt_total_reg_09_inclusao_w	bigint;
qt_total_reg_09_recusado_w	bigint;
pr_total_reg_09_w		bigint;
cd_mensagem_w			varchar(10);
ds_mensagem_erro_w		varchar(255);
qt_ocorrencia_mensagem_w	bigint;

C01 CURSOR FOR
	SELECT	ds_texto,
		nr_registro
	from	w_sib_devolucao;


BEGIN

delete	from sib_devolucao_resumo
where	nr_seq_lote	= nr_seq_lote_sib_p;

open C01;
loop
fetch C01 into
	ds_texto_w,
	nr_registro_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	/* Tratamento do cabe√ßalho */

	if (nr_registro_w < 10) then
		select	max(nr_sequencia)
		into STRICT	nr_seq_cabecalho_w
		from	sib_devolucao_resumo
		where	ie_tipo_item	= 'C'
		and	nr_seq_lote	= nr_seq_lote_sib_p;

		if (coalesce(nr_seq_cabecalho_w,0) = 0) then
			insert into sib_devolucao_resumo(	nr_sequencia,	nr_seq_lote,		ie_tipo_item,	dt_atualizacao,
								nm_usuario,	dt_atualizacao_nrec,	nm_usuario_nrec)
						values (		nextval('sib_devolucao_resumo_seq'),nr_seq_lote_sib_p,'C',	clock_timestamp(),
								nm_usuario_p,	clock_timestamp(),		nm_usuario_p);
		else
			if (nr_registro_w = 4) then
				select	(substr(ds_texto_w,12,7))::numeric ,
					substr(ds_texto_w,29,14)
				into STRICT	nr_operadora_w,
					cd_cnpj_w
				;

				update	sib_devolucao_resumo
				set	nr_operadora		= nr_operadora_w,
					cd_cgc_operadora	= cd_cnpj_w
				where	nr_sequencia		= nr_seq_cabecalho_w;
			elsif (nr_registro_w = 5) then
				select	substr(ds_texto_w,15,length(ds_texto_w))
				into STRICT	ds_razao_social_w
				;

				update	sib_devolucao_resumo
				set	ds_razao_social		= ds_razao_social_w
				where	nr_sequencia		= nr_seq_cabecalho_w;
			elsif (nr_registro_w = 7) then
				select	trim(both substr(ds_texto_w,40,length(ds_texto_w)))
				into STRICT	nm_arquivo_w
				;

				update	sib_devolucao_resumo
				set	nm_arquivo		= nm_arquivo_w
				where	nr_sequencia		= nr_seq_cabecalho_w;
			end if;
		end if;
	/* Tratamento do processamento */

	elsif (nr_registro_w < 25) then
		if (nr_registro_w = 11) then
			insert into sib_devolucao_resumo(	nr_sequencia,
								nr_seq_lote,
								ie_tipo_item,
								dt_atualizacao,
								nm_usuario,
								dt_atualizacao_nrec,
								nm_usuario_nrec,
								qt_inclusao_total,
								qt_inclusao_processado,
								qt_inclusao_recusado,
								pr_inclusao_acerto)
							(SELECT	nextval('sib_devolucao_resumo_seq'),
								nr_seq_lote_sib_p,
								'PI',
								clock_timestamp(),
								nm_usuario_p,
								clock_timestamp(),
								nm_usuario_p,
								(substr(ds_texto_w,31,7))::numeric ,
								(substr(ds_texto_w,48,7))::numeric ,
								(substr(ds_texto_w,65,7))::numeric ,
								(substr(replace(ds_texto_w,'.',','),80,7))::numeric
							);
		elsif (nr_registro_w = 12) then
			insert into sib_devolucao_resumo(	nr_sequencia,
								nr_seq_lote,
								ie_tipo_item,
								dt_atualizacao,
								nm_usuario,
								dt_atualizacao_nrec,
								nm_usuario_nrec,
								qt_alteracao_total,
								qt_alteracao_processado,
								qt_alteracao_recusado,
								pr_alteracao_acerto)
							(SELECT	nextval('sib_devolucao_resumo_seq'),
								nr_seq_lote_sib_p,
								'PA',
								clock_timestamp(),
								nm_usuario_p,
								clock_timestamp(),
								nm_usuario_p,
								(substr(ds_texto_w,31,7))::numeric ,
								(substr(ds_texto_w,48,7))::numeric ,
								(substr(ds_texto_w,65,7))::numeric ,
								(substr(replace(ds_texto_w,'.',','),80,7))::numeric
							);
		elsif (nr_registro_w = 13) then
			insert into sib_devolucao_resumo(	nr_sequencia,
								nr_seq_lote,
								ie_tipo_item,
								dt_atualizacao,
								nm_usuario,
								dt_atualizacao_nrec,
								nm_usuario_nrec,
								qt_exclusao_total,
								qt_exclusao_processado,
								qt_exclusao_recusado,
								pr_exclusao_acerto)
							(SELECT	nextval('sib_devolucao_resumo_seq'),
								nr_seq_lote_sib_p,
								'PE',
								clock_timestamp(),
								nm_usuario_p,
								clock_timestamp(),
								nm_usuario_p,
								(substr(ds_texto_w,31,7))::numeric ,
								(substr(ds_texto_w,48,7))::numeric ,
								(substr(ds_texto_w,65,7))::numeric ,
								(substr(replace(ds_texto_w,'.',','),80,7))::numeric
							);
		elsif (nr_registro_w = 14) then
			insert into sib_devolucao_resumo(	nr_sequencia,
								nr_seq_lote,
								ie_tipo_item,
								dt_atualizacao,
								nm_usuario,
								dt_atualizacao_nrec,
								nm_usuario_nrec,
								qt_reinclusao_total,
								qt_reinclusao_processado,
								qt_reinclusao_recusado,
								pr_reinclusao_acerto)
							(SELECT	nextval('sib_devolucao_resumo_seq'),
								nr_seq_lote_sib_p,
								'PR',
								clock_timestamp(),
								nm_usuario_p,
								clock_timestamp(),
								nm_usuario_p,
								(substr(ds_texto_w,31,7))::numeric ,
								(substr(ds_texto_w,48,7))::numeric ,
								(substr(ds_texto_w,65,7))::numeric ,
								(substr(replace(ds_texto_w,'.',','),80,7))::numeric
							);
		elsif (nr_registro_w = 16) then
			insert into sib_devolucao_resumo(	nr_sequencia,
								nr_seq_lote,
								ie_tipo_item,
								dt_atualizacao,
								nm_usuario,
								dt_atualizacao_nrec,
								nm_usuario_nrec,
								qt_total,
								qt_processados,
								qt_recusados)
							(SELECT	nextval('sib_devolucao_resumo_seq'),
								nr_seq_lote_sib_p,
								'PT',
								clock_timestamp(),
								nm_usuario_p,
								clock_timestamp(),
								nm_usuario_p,
								(substr(ds_texto_w,31,7))::numeric ,
								(substr(ds_texto_w,48,7))::numeric ,
								(substr(ds_texto_w,65,7))::numeric
							);
		elsif (nr_registro_w = 18) then
			insert into sib_devolucao_resumo(	nr_sequencia,
								nr_seq_lote,
								ie_tipo_item,
								dt_atualizacao,
								nm_usuario,
								dt_atualizacao_nrec,
								nm_usuario_nrec,
								qt_total_reg_07,
								qt_total_reg_07_inclusao,
								qt_total_reg_07_recusado,
								pr_total_reg_07)
							(SELECT	nextval('sib_devolucao_resumo_seq'),
								nr_seq_lote_sib_p,
								'P7',
								clock_timestamp(),
								nm_usuario_p,
								clock_timestamp(),
								nm_usuario_p,
								(substr(ds_texto_w,31,7))::numeric ,
								(substr(ds_texto_w,48,7))::numeric ,
								(substr(ds_texto_w,65,7))::numeric ,
								(substr(replace(ds_texto_w,'.',','),80,7))::numeric
							);
		elsif (nr_registro_w = 19) then
			insert into sib_devolucao_resumo(	nr_sequencia,
								nr_seq_lote,
								ie_tipo_item,
								dt_atualizacao,
								nm_usuario,
								dt_atualizacao_nrec,
								nm_usuario_nrec,
								qt_total_reg_09,
								qt_total_reg_09_inclusao,
								qt_total_reg_09_recusado,
								pr_total_reg_09)
							(SELECT	nextval('sib_devolucao_resumo_seq'),
								nr_seq_lote_sib_p,
								'P9',
								clock_timestamp(),
								nm_usuario_p,
								clock_timestamp(),
								nm_usuario_p,
								(substr(ds_texto_w,31,7))::numeric ,
								(substr(ds_texto_w,48,7))::numeric ,
								(substr(ds_texto_w,65,7))::numeric ,
								(substr(replace(ds_texto_w,'.',','),80,7))::numeric
							);
		elsif (nr_registro_w = 21) then
			insert into sib_devolucao_resumo(	nr_sequencia,
								nr_seq_lote,
								ie_tipo_item,
								dt_atualizacao,
								nm_usuario,
								dt_atualizacao_nrec,
								nm_usuario_nrec,
								qt_total_reg,
								qt_total_reg_inclusao,
								qt_total_reg_recusado)
							(SELECT	nextval('sib_devolucao_resumo_seq'),
								nr_seq_lote_sib_p,
								'PG',
								clock_timestamp(),
								nm_usuario_p,
								clock_timestamp(),
								nm_usuario_p,
								(substr(ds_texto_w,31,7))::numeric ,
								(substr(ds_texto_w,48,7))::numeric ,
								(substr(ds_texto_w,65,7))::numeric
							);
		end if;
	elsif (nr_registro_w > 25) then
		select	trim(both substr(ds_texto_w,2,2))
		into STRICT	ie_mensagem_w
		;

		if (ie_mensagem_w	= 'M') then
			insert into sib_devolucao_resumo(	nr_sequencia,
								nr_seq_lote,
								ie_tipo_item,
								dt_atualizacao,
								nm_usuario,
								dt_atualizacao_nrec,
								nm_usuario_nrec,
								cd_mensagem,
								ds_mensagem_erro,
								qt_ocorrencia_mensagem)
							(SELECT	nextval('sib_devolucao_resumo_seq'),
								nr_seq_lote_sib_p,
								'M',
								clock_timestamp(),
								nm_usuario_p,
								clock_timestamp(),
								nm_usuario_p,
								substr(ds_texto_w,3,4),
								lower(substr(ds_texto_w,10,80)),
								(substr(ds_texto_w,94,6))::numeric
							);
		end if;
	end if;

	end;
end loop;
close C01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE sib_importar_devolucao_resumo ( nr_seq_lote_sib_p bigint, nm_usuario_p text) FROM PUBLIC;

