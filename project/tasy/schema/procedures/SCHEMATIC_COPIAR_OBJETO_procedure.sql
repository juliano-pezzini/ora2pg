-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE schematic_copiar_objeto (nr_seq_objeto_atual_p bigint, nr_seq_objeto_destino_p bigint, nm_usuario_p text, ie_commit_p text, ie_opcao_p text default null, cd_funcao_p bigint default null, nr_seq_funcao_schematic_p bigint default null) AS $body$
DECLARE


nr_seq_obj_filho_w	bigint;
nr_sequencia_w		bigint;
ie_tipo_objeto_atual_w	varchar(15);
nr_seq_tipo_sch_atual_w	bigint;
ie_tipo_objeto_novo_w	varchar(15);
nr_seq_tipo_sch_novo_w	bigint;
cd_funcao_w				bigint;
IE_TIPO_COMPONENTE_w	varchar(50);
nr_seq_objeto_destino_w	bigint	:= nr_seq_objeto_destino_p;
nr_seq_funcao_schematic_w	bigint;
nr_seq_func_schem_ant_w		bigint;

nr_seq_dic_objeto_orig_w bigint;

nr_seq_dic_objeto_w bigint;

ie_dinamic_form_w varchar(1);



c01 CURSOR FOR
SELECT	nr_sequencia
from	objeto_schematic
where	nr_seq_obj_sup	= nr_seq_objeto_atual_p;WITH RECURSIVE cte AS (


C02 CURSOR FOR
SELECT  a.nr_sequencia,ARRAY[ row_number() OVER (ORDER BY  nr_seq_apres desc) ] as hierarchy
FROM  	objeto_schematic a WHERE a.nr_sequencia = nr_seq_objeto_atual_p
	AND a.nr_seq_funcao_schematic = nr_seq_func_schem_ant_w
  UNION ALL


C02 CURSOR FOR
SELECT  a.nr_sequencia, array_append(c.hierarchy, row_number() OVER (ORDER BY  nr_seq_apres desc))  as hierarchy
FROM  	objeto_schematic a JOIN cte c ON (c.nr_sequencia = a.nr_seq_obj_sup)

) SELECT * FROM cte WHERE nr_seq_funcao_schematic = nr_seq_func_schem_ant_w
and  	nr_sequencia 	<> nr_seq_objeto_atual_p ORDER BY hierarchy;
;


BEGIN

ie_dinamic_form_w := 'N';

if (nr_seq_objeto_atual_p > 0) then

	select	a.ie_tipo_objeto,
		a.nr_seq_tipo_schematic,
		a.IE_TIPO_COMPONENTE,
		a.nr_seq_funcao_schematic
	into STRICT	ie_tipo_objeto_atual_w,
		nr_seq_tipo_sch_atual_w,
		IE_TIPO_COMPONENTE_w,
		nr_seq_func_schem_ant_w
	from	objeto_schematic a
	where	a.nr_sequencia	= nr_seq_objeto_atual_p;

	select	max(ie_tipo_objeto),
		max(nr_seq_tipo_schematic),
		coalesce(max(cd_funcao),cd_funcao_p),
		coalesce(max(nr_seq_funcao_schematic),nr_seq_funcao_schematic_p)
	into STRICT	ie_tipo_objeto_novo_w,
		nr_seq_tipo_sch_novo_w,
		cd_funcao_w,
		nr_seq_funcao_schematic_w
	from	objeto_schematic
	where	nr_sequencia	= nr_seq_objeto_destino_w;

	if (coalesce(ie_tipo_componente_w,'XPTO') <> 'WDLG') and (coalesce(ie_tipo_componente_w,'XPTO') <> 'WSCB') then

		if (OBTER_SE_PERMITE_OBJ_SCHEMATIC(ie_tipo_objeto_novo_w, ie_tipo_objeto_atual_w, nr_seq_tipo_sch_novo_w, nr_seq_tipo_sch_atual_w) = 'N') then

			/*Processo de copia abortado!
			Devido as regras de Design não é permitido incluir o objeto #@ds_objeto_novo#@ dentro de um #@ds_objeto_atual#@ .*/
			CALL wheb_mensagem_pck.exibir_mensagem_abort(356791,'ds_objeto_novo='||obter_valor_dominio(7624,ie_tipo_objeto_atual_w)||';ds_objeto_atual='||obter_valor_dominio(7624,ie_tipo_objeto_novo_w));

		end if;

	end if;

	if (ie_opcao_p	= 'T') then
		if (IE_TIPO_COMPONENTE_w	= 'WDLG') or (IE_TIPO_COMPONENTE_w  = 'WSCB') then
			nr_seq_objeto_destino_w	:= null;
		end if;
		
		open C02;
		loop
		fetch C02 into
			nr_sequencia_w;
		EXIT WHEN NOT FOUND; /* apply on C02 */
			begin
			update	objeto_schematic
			set	nr_seq_funcao_schematic = nr_seq_funcao_schematic_w,
				cd_funcao	= cd_funcao_w
			where	nr_sequencia = nr_sequencia_w;
			end;
		end loop;
		close C02;
	
		update	objeto_schematic
		set	nr_seq_obj_sup = nr_seq_objeto_destino_w,
			nr_seq_funcao_schematic = nr_seq_funcao_schematic_w,
			dt_atualizacao	= clock_timestamp(),
			cd_funcao = cd_funcao_w
		where	nr_sequencia = nr_seq_objeto_atual_p;

		
	else

		if (IE_TIPO_COMPONENTE_w	= 'WDLG') or (IE_TIPO_COMPONENTE_w  = 'WSCB') then
			nr_seq_objeto_destino_w	:= null;
		end if;

		select	nextval('objeto_schematic_seq')
		into STRICT	nr_sequencia_w
		;

    
        select nr_seq_dic_objeto 
          into STRICT nr_seq_dic_objeto_orig_w 
        from objeto_schematic
           where	nr_sequencia	= nr_seq_objeto_atual_p;
  
  
        if (IE_TIPO_COMPONENTE_w	= 'WDF') then
           ie_dinamic_form_w := 'S';
        end if;
 
  
       nr_seq_dic_objeto_w := COPIAR_DIC_OBJETO( cd_funcao_p, nr_seq_dic_objeto_orig_w, nm_usuario_p, ie_dinamic_form_w, nr_seq_dic_objeto_w, 'S' );

    
   	   insert into objeto_schematic(nr_sequencia,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			dt_atualizacao,
			nm_usuario,
			cd_funcao,
			ds_objeto,
			ie_tipo_objeto,
			nr_seq_obj_sup,
			ie_tipo_obj_painel,
			ie_tipo_obj_navegador,
			ie_tipo_obj_master_regiao,
			nr_seq_funcao_schematic,
			nr_seq_apres,
			ie_tipo_componente,
			nr_seq_dic_objeto,
			nm_tabela,
			nr_seq_visao,
			nr_seq_tipo_schematic,
			cd_exp_desc_obj,
			ie_tipo_obj_button,
			nr_seq_obj_sup_ativ,
			NR_SEQ_ATIVACAO)
		SELECT	nr_sequencia_w,
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			coalesce(cd_funcao_w,cd_funcao),
			ds_objeto,
			ie_tipo_objeto,
			nr_seq_objeto_destino_w,
			ie_tipo_obj_painel,
			ie_tipo_obj_navegador,
			ie_tipo_obj_master_regiao,
			nr_seq_funcao_schematic_w,
			nr_seq_apres,
			ie_tipo_componente,			
                                                nr_seq_dic_objeto_w,
			nm_tabela,
			nr_seq_visao,
			nr_seq_tipo_schematic,
			cd_exp_desc_obj,
			ie_tipo_obj_button,
			nr_seq_obj_sup_ativ,
			NR_SEQ_ATIVACAO
		from	objeto_schematic
		where	nr_sequencia	= nr_seq_objeto_atual_p;
		
		

		insert into OBJ_SCHEMATIC_ATIV_PARAM(nr_sequencia,
			dt_atualizacao,
			nm_usuario,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			nm_parametro,
			nr_seq_apres,
			nr_seq_obj_ref,
			nm_atributo_ref,
			nr_seq_ativacao,
			nr_seq_objeto,
			nr_seq_schematic_relatorio,
			ie_origem_param,
			cd_funcao,
			nr_seq_param,
			nr_seq_obj_ativacao,
			nr_seq_obj_evt_acao,
			vl_parametro,
			nm_atributo,
			nr_seq_obj_sch_leg,
			nr_seq_funcao_schematic)
		SELECT	nextval('obj_schematic_ativ_param_seq'),
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			a.nm_parametro,
			a.nr_seq_apres,
			null, --nr_seq_obj_ref
			CASE WHEN a.ie_origem_param='O' THEN null  ELSE a.nm_atributo_ref END , --nm_atributo_ref
			a.nr_seq_ativacao,
			nr_sequencia_w,
			null, --nr_seq_schematic_relatorio
			a.ie_origem_param,
			a.cd_funcao,
			a.nr_seq_param,
			null, --nr_seq_obj_ativacao
			null, --nr_seq_obj_evt_acao
			a.vl_parametro,
			null, --nm_atributo
			null, --nr_seq_obj_sch_leg
			a.nr_seq_funcao_schematic
		from	obj_schematic_ativ_param a
		where	a.nr_seq_objeto = nr_seq_objeto_atual_p;

		open C01;
		loop
		fetch C01 into
			nr_seq_obj_filho_w;
		EXIT WHEN NOT FOUND; /* apply on C01 */
			begin

			CALL SCHEMATIC_COPIAR_OBJETO(nr_seq_obj_filho_w,nr_sequencia_w,nm_usuario_p,'N',null,cd_funcao_p,nr_seq_funcao_schematic_p);

			end;
		end loop;
		close C01;
	end if;

	if (ie_commit_p = 'S') then
		commit;
	end if;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE schematic_copiar_objeto (nr_seq_objeto_atual_p bigint, nr_seq_objeto_destino_p bigint, nm_usuario_p text, ie_commit_p text, ie_opcao_p text default null, cd_funcao_p bigint default null, nr_seq_funcao_schematic_p bigint default null) FROM PUBLIC;

