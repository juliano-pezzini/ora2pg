-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE proj_mark_activity_audited (nr_seq_etapa_p bigint) AS $body$
DECLARE


ds_atividade_w		proj_cron_etapa.ds_atividade%type;
cd_coordenador_w	proj_projeto.cd_coordenador%type;
qt_audit_w 		integer;


BEGIN
	select 	count(1)
	into STRICT	qt_audit_w
	from 	proj_cron_etapa_audit
	where 	nr_seq_etapa = nr_seq_etapa_p;
		
	if (qt_audit_w = 0) then
		select 	a.ds_atividade,
			c.cd_coordenador
		into STRICT	ds_atividade_w,
			cd_coordenador_w
		from 	proj_cron_etapa a,
			proj_cronograma b,
			proj_projeto c
		where 	a.nr_seq_cronograma = b.nr_sequencia
		and 	b.nr_seq_proj = c.nr_sequencia
		and 	a.nr_sequencia = nr_seq_etapa_p;
		
		insert into proj_cron_etapa_audit(
			nr_sequencia,
			dt_atualizacao,
			nm_usuario,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			ie_status,
			ie_pendencia,
			nr_seq_tipo_documento,
			ds_atividade,
			ds_problema,
			cd_coordenador,
			nr_seq_etapa)
		 values (
			nextval('proj_cron_etapa_audit_seq'),
			clock_timestamp(),
			wheb_usuario_pck.get_nm_usuario, 
			clock_timestamp(),
			wheb_usuario_pck.get_nm_usuario,
			'OK', 
			'OK',
			null,
			ds_atividade_w, 
			null,
			cd_coordenador_w,
			nr_seq_etapa_p);

	else 
		update 	proj_cron_etapa_audit set
			ie_status = 'OK',
			ie_pendencia = 'OK',
			ds_problema  = NULL,
			dt_atualizacao = clock_timestamp(),
			nm_usuario = wheb_usuario_pck.get_nm_usuario
		where 	nr_seq_etapa = nr_seq_etapa_p;
	end if;
	
	commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE proj_mark_activity_audited (nr_seq_etapa_p bigint) FROM PUBLIC;

