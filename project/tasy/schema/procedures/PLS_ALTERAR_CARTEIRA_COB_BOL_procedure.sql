-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_alterar_carteira_cob_bol ( nr_titulo_p bigint, ie_origem_p text, nm_usuario_p text) AS $body$
DECLARE


/* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Finalidade: Atualiza a carteira do beneficiario / cobranca de 2 via boleto
-------------------------------------------------------------------------------------------------------------------

Locais de chamada direta:
[ X ]  Objetos do dicionario [ X ] Tasy (Delphi/Java) [  ] Portal [  ]  Relatorios [ ] Outros:
 ------------------------------------------------------------------------------------------------------------------

Pontos de atencao:
-------------------------------------------------------------------------------------------------------------------

Referencias:
	PLS_ATUALIZAR_MENSALIDADE_WEB
	OPS - Atendimento
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */
nr_seq_regra_w			bigint;
nr_seq_carteira_cobr_w		bigint;
nr_seq_conta_banco_alt_w	bigint;
cd_estabelecimento_w		titulo_receber.cd_estabelecimento%type;
cd_pessoa_fisica_w		titulo_receber.cd_pessoa_fisica%type;
cd_cgc_w			titulo_receber.cd_cgc%type;
cd_portador_w			titulo_receber.cd_portador%type;
cd_tipo_portador_w		titulo_receber.cd_tipo_portador%type;
cd_banco_w			titulo_receber.cd_banco%type;
ie_origem_titulo_w		titulo_receber.ie_origem_titulo%type;
nr_seq_pagador_w		pls_contrato_pagador.nr_sequencia%type;
ie_tipo_titulo_w		titulo_receber.ie_tipo_titulo%type;
ie_origem_w			varchar(2);


BEGIN
if (ie_origem_p = 'PW') then
	ie_origem_w	:= 'PO';
else
	ie_origem_w	:= coalesce(ie_origem_p,'PO');
end if;

select	ie_origem_titulo,
	cd_estabelecimento,
	cd_pessoa_fisica,
	cd_cgc,
	nr_seq_pagador,
	ie_tipo_titulo
into STRICT	ie_origem_titulo_w,
	cd_estabelecimento_w,
	cd_pessoa_fisica_w,
	cd_cgc_w,
	nr_seq_pagador_w,
	ie_tipo_titulo_w
from	titulo_receber
where	nr_titulo = nr_titulo_p;

if (ie_origem_titulo_w = 3) then
	if (nr_titulo_p IS NOT NULL AND nr_titulo_p::text <> '') then
		select	pls_obter_regra_seg_via_boleto(cd_pessoa_fisica_w, cd_cgc_w, nr_seq_pagador_w, nr_titulo_p, clock_timestamp(), ie_origem_w, cd_estabelecimento_w)
		into STRICT	nr_seq_regra_w
		;
	end if;

	if (nr_seq_regra_w IS NOT NULL AND nr_seq_regra_w::text <> '') then
		select	max(a.nr_seq_carteira_cobr),
			max(a.nr_seq_conta_banco_alt)
		into STRICT	nr_seq_carteira_cobr_w,
			nr_seq_conta_banco_alt_w
		from	pls_regra_emis_seg_via_bol	a
		where	a.nr_sequencia	= nr_seq_regra_w;

		if (nr_seq_carteira_cobr_w IS NOT NULL AND nr_seq_carteira_cobr_w::text <> '') then
			update	titulo_receber
			set	nr_seq_carteira_cobr	= nr_seq_carteira_cobr_w
			where	nr_titulo		= nr_titulo_p;
		end if;

		if (nr_seq_conta_banco_alt_w IS NOT NULL AND nr_seq_conta_banco_alt_w::text <> '') then
			update	titulo_receber
			set	nr_seq_conta_banco	= nr_seq_conta_banco_alt_w
			where	nr_titulo		= nr_titulo_p;
		end if;

		if (ie_origem_p not in ('CC','PW')) then
			CALL gerar_bloqueto_tit_rec(nr_titulo_p, 'CE');
		end if;
		
		if	(nr_seq_conta_banco_alt_w IS NOT NULL AND nr_seq_conta_banco_alt_w::text <> '' AND (ie_origem_p = 'PO' or ie_tipo_titulo_w = '10' and ie_origem_p = 'PW')) then
			select	max(cd_portador),
				max(cd_tipo_portador),
				max(cd_banco)
			into STRICT	cd_portador_w,
				cd_tipo_portador_w,
				cd_banco_w
			from	portador
			where	(((cd_pessoa_fisica IS NOT NULL AND cd_pessoa_fisica::text <> '') and cd_pessoa_fisica = cd_pessoa_fisica_w) or coalesce(cd_pessoa_fisica::text, '') = '')
			and	(((cd_cgc IS NOT NULL AND cd_cgc::text <> '') and cd_cgc = cd_cgc_w) or coalesce(cd_cgc::text, '') = '')
			and	nr_seq_conta_banco = nr_seq_conta_banco_alt_w;
			
			update	titulo_receber
			set	cd_portador 		= cd_portador_w,
				cd_tipo_portador 	= cd_tipo_portador_w,
				cd_banco		= cd_banco_w,
				ie_tipo_titulo 		= '1',
				dt_emissao_bloqueto 	= clock_timestamp()
			where	nr_titulo = nr_titulo_p;

			commit;
		end if;
	end if;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_alterar_carteira_cob_bol ( nr_titulo_p bigint, ie_origem_p text, nm_usuario_p text) FROM PUBLIC;

