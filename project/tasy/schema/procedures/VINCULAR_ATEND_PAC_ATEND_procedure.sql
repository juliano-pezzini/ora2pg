-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE vincular_atend_pac_atend ( nr_seq_atendimento_p bigint, nr_atendimento_p bigint, nm_usuario_p text, ds_erro_p INOUT text) AS $body$
DECLARE


ie_permite_vinc_atend_w varchar(1);
ie_atualizar_Dt_Prevista_w varchar(1);
ie_vinc_atend_autor_quimio_w varchar(1);
ie_vinc_presc_novo_atende_w varchar(1);
nr_ciclo_w smallint;
nr_seq_paciente_w bigint;
nr_prescricao_w bigint;
dt_prevista_w timestamp;
dt_entrada_w timestamp;
ds_erro_w varchar(255) := '';


BEGIN
if (nr_seq_atendimento_p IS NOT NULL AND nr_seq_atendimento_p::text <> '') then

	ie_permite_vinc_atend_w := obter_param_usuario(3130, 72, obter_perfil_ativo, wheb_usuario_pck.get_nm_usuario, wheb_usuario_pck.get_cd_estabelecimento, ie_permite_vinc_atend_w);
	ie_atualizar_Dt_Prevista_w := obter_param_usuario(3130, 108, obter_perfil_ativo, wheb_usuario_pck.get_nm_usuario, wheb_usuario_pck.get_cd_estabelecimento, ie_atualizar_Dt_Prevista_w);
	ie_vinc_atend_autor_quimio_w := obter_param_usuario(3130, 294, obter_perfil_ativo, wheb_usuario_pck.get_nm_usuario, wheb_usuario_pck.get_cd_estabelecimento, ie_vinc_atend_autor_quimio_w);
	ie_vinc_presc_novo_atende_w := obter_param_usuario(3130, 155, obter_perfil_ativo, wheb_usuario_pck.get_nm_usuario, wheb_usuario_pck.get_cd_estabelecimento, ie_vinc_presc_novo_atende_w);

	select 	coalesce(max(nr_seq_paciente), 0),
		max(dt_prevista),
		coalesce(max(nr_ciclo), 0),
		coalesce(max(nr_prescricao), 0)
	into STRICT 	nr_seq_paciente_w,
		dt_prevista_w,
		nr_ciclo_w,
		nr_prescricao_w
	from paciente_atendimento
	where  nr_seq_atendimento = nr_seq_atendimento_p;
	
	

	if (nr_atendimento_p IS NOT NULL AND nr_atendimento_p::text <> '' AND nr_atendimento_p > 0) then
		begin

		if (ie_permite_vinc_atend_w = 'S') then
			update paciente_atendimento
			set dt_chegada = clock_timestamp(),
			dt_atualizacao = clock_timestamp(),
			nm_usuario = nm_usuario_p,
			nr_atendimento = nr_atendimento_P
			where obter_dados_paciente_setor(nr_seq_paciente,'C') = obter_dados_paciente_setor(nr_seq_paciente_w ,'C')
			and   ((coalesce(nr_atendimento::text, '') = '') or (nr_atendimento  = 0))
			and   trunc(dt_prevista) = trunc(dt_prevista_w);
		else
			update paciente_atendimento
			set dt_chegada = clock_timestamp(),
			dt_atualizacao = clock_timestamp(),
			nm_usuario = nm_usuario_p,
			nr_atendimento = nr_atendimento_p
			where nr_seq_atendimento = nr_seq_atendimento_p;
		end if;

		commit;

		if (ie_atualizar_Dt_Prevista_w = 'S') then
			begin

			Select coalesce(dt_entrada, clock_timestamp())
			into STRICT dt_entrada_w
			from atendimento_paciente
			where nr_atendimento = nr_atendimento_p;

			ds_erro_w := atualizar_ciclo_oncologia(nr_seq_paciente_w, nr_seq_atendimento_p, dt_entrada_w, 'S', nm_usuario_p, 'N', ds_erro_w, 'S');

			end;
		end if;

		if (((coalesce(ds_erro_w::text, '') = '') or (ds_erro_w = '')) and (ie_vinc_atend_autor_quimio_w <> 'N')) then
			begin
			update  autorizacao_convenio
			set     dt_atualizacao    = clock_timestamp(),
					nm_usuario        = nm_usuario_p,
					nr_atendimento    = nr_atendimento_p
			where   coalesce(nr_atendimento::text, '') = ''
					and     ((nr_ciclo = nr_ciclo_w) or (ie_vinc_atend_autor_quimio_w = 'T'))
					and     nr_seq_paciente_setor   = nr_seq_paciente_w;
			commit;
			end;
		end if;

		if ((coalesce(ds_erro_w::text, '') = '') or (ds_erro_w = '')) then
			begin
			if (ie_vinc_presc_novo_atende_w = 'S') then
			Update 	prescr_medica
			set 	nr_atendimento 	= nr_atendimento_p
			where 	nr_prescricao 	= nr_prescricao_w;
			end if;

			commit;

			end;
		end if;

		end;
	end if;
end if;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE vincular_atend_pac_atend ( nr_seq_atendimento_p bigint, nr_atendimento_p bigint, nm_usuario_p text, ds_erro_p INOUT text) FROM PUBLIC;

