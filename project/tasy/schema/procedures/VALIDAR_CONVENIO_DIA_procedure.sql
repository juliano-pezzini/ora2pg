-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE validar_convenio_dia (cd_estabelecimento_p bigint) AS $body$
DECLARE


data_w text;
json_w philips_json;
	

BEGIN

  delete from att_validacions_qrcode att
  where (trunc(att.dt_atualizacao) = trunc(clock_timestamp()) and att.ie_elegibilidade <> 'A'
  or trunc(att.dt_atualizacao) < trunc(clock_timestamp()))
  and ((coalesce(cd_estabelecimento_p, 0) = 0) or ((att.nr_seq_agcons IS NOT NULL AND att.nr_seq_agcons::text <> '') and cd_estabelecimento_p = (SELECT max(a.cd_estabelecimento)
                                                                                                        from agenda a,
                                                                                                             agenda_consulta b
                                                                                                        where a.cd_agenda = b.cd_agenda
                                                                                                        and b.nr_sequencia = att.nr_seq_agcons))
  or ((att.nr_seq_agenda IS NOT NULL AND att.nr_seq_agenda::text <> '') and cd_estabelecimento_p = (select max(a.cd_estabelecimento)
                                                                from agenda a,
                                                                     agenda_paciente b
                                                                where a.cd_agenda = b.cd_agenda
                                                                and b.nr_sequencia = att.nr_seq_agenda)));

  commit;

  dbms_lob.createtemporary(data_w, true);
  json_w := philips_json();
  json_w.put('establishment', cd_estabelecimento_p);
  json_w.(data_w);

  data_w := bifrost.send_integration_content('job.auto.atendimento', data_w, obter_usuario_ativo);

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE validar_convenio_dia (cd_estabelecimento_p bigint) FROM PUBLIC;

