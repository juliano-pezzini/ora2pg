-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_desfazer_lote_guia_fat_xml ( nr_seq_fatura_p bigint, nm_usuario_p text) AS $body$
DECLARE

				
/* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Finalidade:
Desfaz os dados do XML no formato TISS das faturas
-------------------------------------------------------------------------------------------------------------------

Locais de chamada direta: 
[ ]  Objetos do dicionario [  X] Tasy (Delphi/Java) [  ] Portal [  ]  Relatorios [ ] Outros:
 ------------------------------------------------------------------------------------------------------------------

Pontos de atencao:
-------------------------------------------------------------------------------------------------------------------

Referencias:
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */
 

nr_seq_lote_fat_guia_envio_w	bigint;
nr_seq_fat_guia_arq_w		bigint;
nr_seq_fat_guia_envio_w		bigint;

c01 CURSOR FOR
	SELECT	nr_sequencia
	from	pls_fat_guia_arquivo
	where	nr_seq_lote	= nr_seq_lote_fat_guia_envio_w;
	
c02 CURSOR FOR
	SELECT	nr_sequencia
	from	pls_fatura_guia_envio
	where	nr_seq_guia_arquivo	= nr_seq_fat_guia_arq_w;


BEGIN

select	max(nr_sequencia)
into STRICT	nr_seq_lote_fat_guia_envio_w
from	pls_lote_fat_guia_envio
where	nr_seq_fatura	= nr_seq_fatura_p;

open c01;
loop
fetch c01 into	
	nr_seq_fat_guia_arq_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	begin
	
	open c02;
	loop
	fetch c02 into	
		nr_seq_fat_guia_envio_w;
	EXIT WHEN NOT FOUND; /* apply on c02 */
		begin
		
		delete	FROM pls_fat_guia_envio_partic
		where	nr_seq_guia_proc in (SELECT	nr_sequencia
						from	pls_fat_guia_envio_proc
						where	nr_seq_guia_envio	= nr_seq_fat_guia_envio_w);
		
		delete	FROM pls_fat_guia_envio_proc
		where	nr_seq_guia_envio	= nr_seq_fat_guia_envio_w;
		
		delete	FROM pls_fat_guia_envio_mat
		where	nr_seq_guia_envio	= nr_seq_fat_guia_envio_w;
		
		delete	FROM pls_fatura_guia_envio
		where	nr_sequencia	= nr_seq_fat_guia_envio_w;
		
		end;
	end loop;
	close c02;
	
	delete	FROM pls_fat_guia_arquivo
	where	nr_sequencia	= nr_seq_fat_guia_arq_w;
	
	end;
end loop;
close c01;

delete	FROM pls_lote_fat_guia_envio
where	nr_sequencia	= nr_seq_lote_fat_guia_envio_w;

delete	FROM ptu_lote_conta_erro	a
where	a.nr_seq_pls_fatura	= nr_seq_fatura_p
and	a.ie_tipo_critica	= 'TISS';

update	pls_fatura
set	dt_geracao_xml	 = NULL
where	nr_sequencia	= nr_seq_fatura_p;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_desfazer_lote_guia_fat_xml ( nr_seq_fatura_p bigint, nm_usuario_p text) FROM PUBLIC;

