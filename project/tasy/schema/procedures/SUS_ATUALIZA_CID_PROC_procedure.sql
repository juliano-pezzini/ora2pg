-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE sus_atualiza_cid_proc ( nr_atendimento_p bigint, cd_profissional_p text, cd_cid_p INOUT text) AS $body$
DECLARE

			 
cd_cid_w			varchar(10);
cd_estabelecimento_w	atendimento_paciente.cd_estabelecimento%type;
ie_restr_medico_w		varchar(15) := 'N';

c01 CURSOR FOR 
	SELECT	coalesce(b.cd_doenca,'') 
	from	diagnostico_doenca b, 
		diagnostico_medico	a 
	where	a.nr_atendimento	= b.nr_atendimento 
	and	a.dt_diagnostico	= b.dt_diagnostico 
	and	((ie_restr_medico_w = 'N') or (a.cd_medico = coalesce(cd_profissional_p,a.cd_medico))) 
	and	a.nr_atendimento	= nr_atendimento_p 
	order by	a.dt_diagnostico, 
		b.dt_atualizacao;		
 
c02 CURSOR FOR 
	SELECT	cd_doenca_cid 
	from	can_loco_regional 
	where	cd_pessoa_fisica	= obter_pessoa_atendimento(nr_atendimento_p,'C') 
	order by dt_avaliacao;	
	 

BEGIN 
 
begin 
select	coalesce(max(cd_estabelecimento),0) 
into STRICT	cd_estabelecimento_w 
from	atendimento_paciente 
where	nr_atendimento = nr_atendimento_p;
exception 
when others then 
	cd_estabelecimento_w := 0;
end;
 
ie_restr_medico_w := coalesce(obter_valor_param_usuario(1125, 156, obter_perfil_ativo, wheb_usuario_pck.get_nm_usuario, cd_estabelecimento_w),'N');
 
open c02;
loop 
fetch c02 into	 
	cd_cid_w;
EXIT WHEN NOT FOUND; /* apply on c02 */
end loop;
close c02;
 
open c01;
loop 
fetch c01 into	 
	cd_cid_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
end loop;
close c01;
 
cd_cid_p	:= cd_cid_w;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE sus_atualiza_cid_proc ( nr_atendimento_p bigint, cd_profissional_p text, cd_cid_p INOUT text) FROM PUBLIC;

