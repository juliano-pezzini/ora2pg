-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE insere_atributo (nm_tabela_p text, nm_atributo_p text, nm_usuario_p text, ie_tipo_p text, nr_sequencia_p text, qt_tamanho_p text, qt_decimais_p text) AS $body$
DECLARE




qt_seq_inicio_w				varchar(10);
qt_seq_inc_w				varchar(10);
nm_indice_w					varchar(50);
nm_integridade_w			varchar(50);
ds_atributo_w				varchar(255);
ds_integridade_w			varchar(50);
ds_shortname_w				varchar(10);
ds_shortname_ww				varchar(10);
nm_tabela_ref_w				varchar(50);
ie_obrigatorio_w			varchar(1)	:= 'S';
vl_default_w				varchar(50);
ie_tabstop_w				varchar(1)	:= 'S';
ie_readonly_w				varchar(1)	:= 'N';
ds_label_w					varchar(60);
ds_label_grid_w				varchar(50);
ie_componente_w				varchar(5);
cd_exp_desc_w				bigint;
cd_exp_label_w				bigint;
cd_exp_label_grid_w			bigint;
ie_temporaria_w				varchar(5);
ie_tabela_temporaria_w		varchar(1)	:= 'N';
ie_informacao_sensivel_w    		varchar(1) 	:= 'N';  --trata-se de apenas atributos de sistema (nr_sequencia, dt_atualizacao, nm_usuario......
BEGIN

select max(ds_shortname),
	max(ie_temporaria)
into STRICT	ds_shortname_w,
	ie_temporaria_w
from	tabela_sistema
where	nm_tabela 	= nm_tabela_p;

if (ie_temporaria_w in ('G','GD')) then
	ie_tabela_temporaria_w := 'S';
end if;

nm_tabela_ref_w		:= '';
nm_indice_w			:= '';
ds_integridade_w		:= '';
ds_atributo_w			:= obter_desc_expressao(563904);--'Gerado pelo sistema';
cd_exp_desc_w			:= 557610;
if (nm_atributo_p = 'CD_ESTABELECIMENTO') then
	ds_atributo_w	:= 'Selecionar o estabelecimento que atende a regra desejada';
	cd_exp_desc_w	:= 561348;
	nm_tabela_ref_w	:= 'ESTABELECIMENTO';
	vl_default_w	:= '@ESTAB';
elsif (nm_atributo_p = 'CD_PROCEDIMENTO') then
	ds_atributo_w	:= 'Selecionar o procedimento que atende a regra desejada';
	cd_exp_desc_w	:= 561340;
	nm_tabela_ref_w	:= 'PROCEDIMENTO';
elsif (nm_atributo_p = 'CD_PESSOA_FISICA') then
	ds_atributo_w	:= 'Selecionar a pessoa_fisica que atende a regra desejada';
	cd_exp_desc_w	:= 561911;
	nm_tabela_ref_w	:= 'PESSOA_FISICA';
elsif (nm_atributo_p = 'CD_MATERIAL') then
	ds_atributo_w	:= 'Selecionar o material que atende a regra desejada';
	cd_exp_desc_w	:= 300054;
	nm_tabela_ref_w	:= 'MATERIAL';
elsif (nm_atributo_p = 'NR_ATENDIMENTO') then
	ds_atributo_w	:= 'Selecionar o atendimento que atende a regra desejada';
	cd_exp_desc_w	:= 561571;
	nm_tabela_ref_w	:= 'ATENDIMENTO_PACIENTE';
elsif (nm_atributo_p = 'CD_SETOR_ATENDIMENTO') then
	ds_atributo_w	:= 'Selecionar o setor que atende a regra desejada';
	cd_exp_desc_w	:= 561490;
	nm_tabela_ref_w	:= 'SETOR_ATENDIMENTO';
elsif (nm_atributo_p = 'CD_EMPRESA') then
	ds_atributo_w	:= 'Selecionar a empresa que atende a regra desejada';
	cd_exp_desc_w	:= 562074;
	nm_tabela_ref_w		:= 'EMPRESA';
	vl_default_w		:= '@EMPRESA';
elsif (nm_atributo_p = 'NR_SEQ_PROC_INTERNO') then
	ds_atributo_w	:= 'Selecionar o procedimento interno que atende a regra desejada';
	cd_exp_desc_w	:= 561343;
	nm_tabela_ref_w	:= 'PROC_INTERNO';
elsif (nm_atributo_p = 'CD_AREA_PROCEDIMENTO') then
	ds_atributo_w	:= 'Selecionar a área de procedimentos que atende a regra desejada';
	cd_exp_desc_w	:= 561345;
	nm_tabela_ref_w	:= 'AREA_PROCEDIMENTO';
elsif (nm_atributo_p = 'CD_ESPECIALIDADE') then
	ds_atributo_w	:= 'Selecionar a especialidade de procedimentos que atende a regra desejada';
	cd_exp_desc_w	:= 561342;
	nm_tabela_ref_w	:= 'ESPECIALIDADE_PROC';
elsif (nm_atributo_p = 'CD_GRUPO_PROC') then
	ds_atributo_w	:= 'Selecionar o grupo de procedimentos que atende a regra desejada';
	cd_exp_desc_w	:= 561346;
	nm_tabela_ref_w	:= 'GRUPO_PROC';
elsif (nm_atributo_p = 'CD_GRUPO_MATERIAL') then
	ds_atributo_w	:= obter_desc_expressao(634552);--'Selecionar o grupo de materiais que atende a regra desejada';
	cd_exp_desc_w	:= 562218;
	nm_tabela_ref_w	:= 'GRUPO_MATERIAL';
elsif (nm_atributo_p = 'CD_CLASSE_MATERIAL') then
	ds_atributo_w	:= obter_desc_expressao(634550);--'Selecionar a classe de materiais que atende a regra desejada';
	cd_exp_desc_w	:= 566940;
	nm_tabela_ref_w	:= 'CLASSE_MATERIAL';
elsif (nm_atributo_p = 'CD_SUBGRUPO_MATERIAL') then
	ds_atributo_w	:= obter_desc_expressao(634551);--'Selecionar o subgrupo de materiais que atende a regra desejada';
	cd_exp_desc_w	:= 562342;
	nm_tabela_ref_w	:= 'SUBGRUPO_MATERIAL';
elsif (nm_atributo_p = 'CD_PERFIL') then
	ds_atributo_w	:= obter_desc_expressao(638206);--'Selecionar o perfil que atende a regra desejada';
	cd_exp_desc_w	:= 561865;
	nm_tabela_ref_w	:= 'PERFIL';
elsif (nm_atributo_p = 'CD_PERFIL_ATIVO') then
	ds_atributo_w	:= obter_desc_expressao(635813);--'Gerado pelo sistema com base no perfil ativo.';
	cd_exp_desc_w	:= 635813;
	nm_tabela_ref_w	:= 'PERFIL';
	vl_default_w	:= '@PERFIL_ATIVO';
	ie_obrigatorio_w	:= 'N';
elsif (nm_atributo_p = 'DT_LIBERACAO') then
	ds_atributo_w		:= 'Informar a data de liberação do registro. Após esta data o mesmo não poderá ser modificado nem excluído.';
	cd_exp_desc_w		:= 561337;
	ie_obrigatorio_w	:= 'N';
	ie_tabstop_w		:= 'N';
	ie_readonly_w		:= 'S';
	ds_label_w			:= obter_desc_expressao(646473);--'Data liberação';
	cd_exp_label_w		:= 287026;
	ds_label_grid_w		:= obter_desc_expressao(646473);--'Data liberação';
	cd_exp_label_grid_w	:= 287026;
	ie_componente_w		:= 'de';
elsif (nm_atributo_p = 'DS_JUSTIFICATIVA') then
	ds_atributo_w		:= obter_desc_expressao(567330);--'Informar a justificativa de inativação do registro';
	cd_exp_desc_w		:= 561512;
	ie_obrigatorio_w	:= 'N';
	ds_label_grid_w		:= obter_desc_expressao(292337);--'Justificativa';
	cd_exp_label_grid_w	:= 292337;
	ie_componente_w		:= 'de';
elsif (nm_atributo_p = 'DT_INATIVACAO') then
	ds_atributo_w		:= 'Informar a data de inativação do registro';
	cd_exp_desc_w		:= 561573;
	ie_obrigatorio_w	:= 'N';
	ie_tabstop_w		:= 'N';
	ie_readonly_w		:= 'S';
	ds_label_w			:= obter_desc_expressao(286945);--'Data inativação';
	cd_exp_label_w		:= 286945;
	ds_label_grid_w		:= obter_desc_expressao(286945);--'Data inativação';
	cd_exp_label_grid_w	:= 286945;
	ie_componente_w		:= 'de';
elsif (nm_atributo_p = 'NM_USUARIO_INATIVACAO') then
	ds_atributo_w		:= obter_desc_expressao(561392);--'Gerado pelo sistema com o usuário que inativou o registro';
	cd_exp_desc_w		:= 561392;
	ie_obrigatorio_w	:= 'N';
	ds_label_grid_w		:= obter_desc_expressao(301002);--'Usuário inativação';
	cd_exp_label_grid_w	:= 301002;
	ie_componente_w		:= 'de';
end if;

if (nm_atributo_p = 'NR_SEQUENCIA') then
	qt_seq_inicio_w	:=	'1';
	qt_seq_inc_w   	:=	'1';
else
	qt_seq_inicio_w	:=	'';
	qt_seq_inc_w   	:=	'';
end if;

if (nm_atributo_p = 'NM_USUARIO_NREC') or (nm_atributo_p = 'DT_ATUALIZACAO_NREC') then
	ie_obrigatorio_w	:= 'N';
end	if;

insert into Tabela_Atributo(
	nm_tabela,
	nm_atributo,
	nr_sequencia_criacao,
	ie_obrigatorio,
	ie_tipo_atributo,
	dt_atualizacao,
	nm_usuario,
	qt_tamanho,
	qt_decimais,
	ie_criar_alterar,
	ds_atributo,
	ie_situacao,
	ie_tabstop,
	ie_readonly,
	qt_tamanho_calculo,
	ie_criar_descricao,
	qt_seq_inicio,
	qt_seq_incremento,
	ie_log_exclusao,
	ie_log_update,
	dt_criacao,
	vl_default,
	ie_atualizar_versao,
	ds_label,
	ds_label_grid,
	ie_componente,
	ie_criar_desc_fk,
	cd_exp_desc,
	cd_exp_label, 
	cd_exp_label_grid,
	nm_usuario_nrec,
	dt_atualizacao_nrec,
	ie_informacao_sensivel)
values (
	nm_tabela_p,
	nm_atributo_p,
	nr_sequencia_p,
	ie_obrigatorio_w,
	ie_tipo_p,
	clock_timestamp(),
	nm_usuario_p,
	qt_tamanho_p,
	qt_decimais_p,
	'N',
	ds_atributo_w,
	'A',
	CASE WHEN nm_atributo_p='IE_SITUACAO' THEN 'N'  ELSE ie_tabstop_w END ,
	CASE WHEN nm_atributo_p='IE_SITUACAO' THEN 'N'  ELSE ie_readonly_w END ,
	0,
	'N',
	qt_seq_inicio_w,
	qt_seq_inc_w,
	'N',
	'N',
	clock_timestamp(),
	vl_default_w,
	'S',
	ds_label_w,
	ds_label_grid_w,
	ie_componente_w,
	'S',
	cd_exp_desc_w, 
	cd_exp_label_w, 
	cd_exp_label_grid_w,
	nm_usuario_p,
	clock_timestamp(),
	ie_informacao_sensivel_w);

if (nm_atributo_p = 'IE_SITUACAO') then
	update	tabela_atributo
	set	ds_atributo	= 'Identificar se a situação está ativa',
		cd_exp_desc	= 561319,
		ds_valores	= 'A,I',
		vl_default	= 'A',
		qt_tam_delphi	= 150,
		ds_label	= 'Situação ativa',
		cd_exp_label	= 298568,
		ds_label_grid	= 'Ativo',
		cd_exp_label_grid = 283906,
		ie_componente	= 'cb',
		qt_decimais	 = NULL,
		nr_seq_apresent	= 91
	where	nm_tabela	= nm_tabela_p
	and	nm_atributo	= nm_atributo_p;
end if;

if (nm_atributo_p = 'NR_SEQUENCIA') then
	select max(ds_shortname) || '_PK'
	into STRICT	nm_indice_w
	from	tabela_sistema
	where	nm_tabela 	= nm_tabela_p;
	insert into indice(
		nm_tabela,
		nm_indice,
		ie_tipo,
		dt_atualizacao,
		nm_usuario,
		ds_indice,
		ie_criar_alterar,
		ie_situacao,
		dt_criacao)
	values (
		nm_tabela_p,
		nm_indice_w,
		'PK',
		clock_timestamp(),
		nm_usuario_p,
		'Chave primária',
		'M',
		'A',
		clock_timestamp());
	insert into indice_atributo(
		nm_tabela,
		nm_indice,
		nr_sequencia,
		nm_atributo,
		dt_atualizacao,
		nm_usuario)
	values (
		nm_tabela_p,
		nm_indice_w,
		1,
		'NR_SEQUENCIA',
		clock_timestamp(),
		nm_usuario_p);
end if;

if (nm_atributo_p = 'CD_PROCEDIMENTO') then
	insert into Tabela_Atributo(
		nm_tabela,
		nm_atributo,
		nr_sequencia_criacao,
		ie_obrigatorio,
		ie_tipo_atributo,
		dt_atualizacao,
		nm_usuario,
		qt_tamanho,
		qt_decimais,
		ie_criar_alterar,
		ds_atributo,
		ie_situacao,
		ie_tabstop,
		ie_readonly,
		qt_tamanho_calculo,
		ie_criar_descricao,
		qt_seq_inicio,
		qt_seq_incremento,
		ie_log_exclusao,
		ie_log_update,
		dt_criacao,
		ie_atualizar_versao,
		ie_criar_desc_fk,
		cd_exp_desc,
		ie_informacao_sensivel)
	values (
		nm_tabela_p,
		'IE_ORIGEM_PROCED',
		nr_sequencia_p + 2,
		'S',
		ie_tipo_p,
		clock_timestamp(),
		nm_usuario_p,
		10,
		0,
		'N',
		'Gerado pelo sistema',
		'A',
		'S',
		'N',
		0,
		'N',
		qt_seq_inicio_w,
		qt_seq_inc_w,
		'N',
		'N',
		clock_timestamp(),
		'S',
		'S',
		557610,
		ie_informacao_sensivel_w);
end if;

if (nm_tabela_ref_w IS NOT NULL AND nm_tabela_ref_w::text <> '') and (ie_tabela_temporaria_w = 'N') then
	select max(ds_shortname)
	into STRICT	ds_shortname_ww
	from	tabela_sistema
	where	nm_tabela 	= nm_tabela_ref_w;
	nm_integridade_w	:= ds_shortname_w || '_' || ds_shortname_ww ||'_' || 'FK';
	insert into Integridade_referencial(
		nm_tabela,
		nm_integridade_referencial,
		nm_tabela_referencia,
		dt_atualizacao,
		nm_usuario,
		ie_regra_delecao,
		ie_criar_alterar,
		ie_situacao,
		dt_criacao)
	values (
		nm_tabela_p,
		nm_integridade_w,
		nm_tabela_ref_w,
		clock_timestamp(),
		nm_usuario_p,
		'NO ACTION',
		'I',
		'A',
		clock_timestamp());

	insert into Integridade_Atributo(
		nm_tabela,
		nm_integridade_referencial,
		nm_atributo,
		ie_sequencia_criacao,
		dt_atualizacao,
		nm_usuario)
	values (
		nm_tabela_p,
		nm_integridade_w,
		nm_atributo_p,
		1,
		clock_timestamp(),
		nm_usuario_p);
	if (nm_atributo_p = 'CD_PROCEDIMENTO') then
		insert into Integridade_Atributo(
			nm_tabela,
			nm_integridade_referencial,
			nm_atributo,
			ie_sequencia_criacao,
			dt_atualizacao,
			nm_usuario)
		values (
			nm_tabela_p,
			nm_integridade_w,
			'IE_ORIGEM_PROCED',
			2,
			clock_timestamp(),
			nm_usuario_p);
	end if;
	CALL Gerar_indice_fk(nm_tabela_p, nm_integridade_w, nm_usuario_p);
end if;

/* Rafael em 07/09/06 */

if (nm_tabela_p IS NOT NULL AND nm_tabela_p::text <> '') and (nm_atributo_p IS NOT NULL AND nm_atributo_p::text <> '') then
	CALL copiar_atributo_visao(nm_tabela_p, nm_atributo_p);
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE insere_atributo (nm_tabela_p text, nm_atributo_p text, nm_usuario_p text, ie_tipo_p text, nr_sequencia_p text, qt_tamanho_p text, qt_decimais_p text) FROM PUBLIC;

