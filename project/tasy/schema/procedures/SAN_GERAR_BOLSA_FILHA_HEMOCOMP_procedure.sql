-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE san_gerar_bolsa_filha_hemocomp (nr_seq_derivado_p bigint, qt_volume_bolsa_p text, nr_seq_doacao_p bigint, cd_pf_realizou_p text, nm_usuario_p text) AS $body$
DECLARE


qt_dias_validade_w	smallint;
nr_sangue_w			varchar(20);
ie_tipo_coleta_w 	varchar(1);
qt_volume_atual_w	varchar(20);
dt_vencimento_w		timestamp;
cd_estabelecimento_w	san_producao.cd_estabelecimento%type := wheb_usuario_pck.get_cd_estabelecimento;
ds_parametro_w	varchar(10) := obter_valor_param_usuario(450,262,obter_perfil_ativo,wheb_usuario_pck.get_nm_usuario, cd_estabelecimento_w);



BEGIN
if (nr_seq_doacao_p IS NOT NULL AND nr_seq_doacao_p::text <> '') and (nr_seq_derivado_p IS NOT NULL AND nr_seq_derivado_p::text <> '') then
	select	coalesce(max(qt_dias_validade),0)
	into STRICT	qt_dias_validade_w
	from	san_derivado
	where	ie_situacao	= 'A'
	and	nr_sequencia	= nr_seq_derivado_p;

	select (a.qt_volume_atual - qt_volume_bolsa_p),
			CASE WHEN ie_tipo_coleta=1 THEN  'S'  ELSE CASE WHEN ie_tipo_coleta=3 THEN  'S'  ELSE CASE WHEN ie_tipo_coleta=4 THEN  'S'  ELSE 'N' END  END  END
	into STRICT	qt_volume_atual_w,
			ie_tipo_coleta_w
	from	san_doacao a
	where	a.nr_sequencia	= nr_seq_doacao_p;

	select	max(nr_sangue)
	into STRICT	nr_sangue_w
	from	san_doacao
	where	nr_sequencia = nr_seq_doacao_p;

	if (coalesce(nr_sangue_w::text, '') = '') then
    	    CALL wheb_mensagem_pck.exibir_mensagem_abort(1086887);
  	end if;

	select	to_date(to_char(clock_timestamp() + qt_dias_validade_w,'dd/mm/yyyy')||+(ds_parametro_w),'dd/mm/yyyy hh24:mi:ss')
	into STRICT	dt_vencimento_w
	;

	insert into san_producao(
		nr_Sequencia,
		nr_Seq_doacao,
		nr_Seq_derivado,
		qt_volume,
		cd_pf_realizou,
		dt_vencimento,
		nm_usuario,
		ie_aliquotado,
		ie_filtrado,
		ie_irradiado,
		ie_lavado,
		ie_aferese,
		dt_producao,
		dt_atualizacao,
		nr_sangue,
		ie_bolsa_filha,
		cd_estabelecimento
	) values (
		nextval('san_producao_seq'),
		nr_seq_doacao_p,
		nr_seq_derivado_p,
		qt_volume_bolsa_p,
		cd_pf_realizou_p,
		dt_vencimento_w,
		nm_usuario_p,
		'N',
		'N',
		'N',
		'N',
		ie_tipo_coleta_w,
		clock_timestamp(),
		clock_timestamp(),
		nr_sangue_w,
		'S',
		cd_estabelecimento_w);

	update	san_doacao
	set	qt_volume_atual	= qt_volume_atual_w
	where	nr_sequencia	= nr_seq_doacao_p;
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE san_gerar_bolsa_filha_hemocomp (nr_seq_derivado_p bigint, qt_volume_bolsa_p text, nr_seq_doacao_p bigint, cd_pf_realizou_p text, nm_usuario_p text) FROM PUBLIC;

