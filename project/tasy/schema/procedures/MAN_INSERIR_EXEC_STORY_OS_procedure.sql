-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE man_inserir_exec_story_os (nr_story_p bigint, nr_membro_p bigint, nm_usuario_p text) AS $body$
DECLARE


qt_exec_w                     bigint;
nr_story_sprint_w             desenv_story_sprint.nr_sequencia%type;
nr_ordem_servico_w            desenv_story_sprint.nr_ordem_servico%type;
nm_usuario_exec_w             usuario.nm_usuario%type;


BEGIN

select  max(nr_sequencia)
into STRICT    nr_story_sprint_w
from    desenv_story_sprint
where   nr_story = nr_story_p;

select  nr_ordem_servico
into STRICT    nr_ordem_servico_w
from    desenv_story_sprint
where   nr_sequencia = nr_story_sprint_w;

if (nr_ordem_servico_w IS NOT NULL AND nr_ordem_servico_w::text <> '') then

        select  obter_usuario_pessoa(cd_pessoa_fisica)
        into STRICT    nm_usuario_exec_w
        from    desenv_member
        where   nr_sequencia = nr_membro_p;

        select  count(*)
        into STRICT    qt_exec_w
        from    man_ordem_servico_exec
        where   nm_usuario_exec = nm_usuario_exec_w
        and     nr_seq_ordem = nr_ordem_servico_w;

        if (qt_exec_w = 0) then
                insert into man_ordem_servico_exec(
                    dt_atualizacao,
                    dt_atualizacao_nrec,
                    nm_usuario,
                    nm_usuario_exec,
                    nm_usuario_nrec,
                    nr_seq_ordem,
                    nr_sequencia,
                    qt_min_prev)
                values (
                    clock_timestamp(),
                    clock_timestamp(),
                    nm_usuario_p,
                    nm_usuario_exec_w,
                    nm_usuario_p,
                    nr_ordem_servico_w,
                    nextval('man_ordem_servico_exec_seq'),
                    10);
        end if;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE man_inserir_exec_story_os (nr_story_p bigint, nr_membro_p bigint, nm_usuario_p text) FROM PUBLIC;

