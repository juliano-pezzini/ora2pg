-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE obter_percentil ( nr_atendimento_p bigint, ie_tipo_p text, peso_p bigint, altura_p bigint, dt_registro_p timestamp, anos_p bigint default null, meses_p bigint default null, qt_imc_p bigint default null, qt_1_p INOUT bigint DEFAULT NULL, qt_3_p INOUT bigint DEFAULT NULL, qt_5_p INOUT bigint DEFAULT NULL, qt_15_p INOUT bigint DEFAULT NULL, qt_25_p INOUT bigint DEFAULT NULL, qt_50_p INOUT bigint DEFAULT NULL, qt_75_p INOUT bigint DEFAULT NULL, qt_85_p INOUT bigint DEFAULT NULL, qt_95_p INOUT bigint DEFAULT NULL, qt_97_p INOUT bigint DEFAULT NULL, qt_99_p INOUT bigint DEFAULT NULL) AS $body$
DECLARE


anos_w		bigint;
meses_w		bigint;
nr_sequencia_w	bigint;

qt_1_w			real;
qt_3_w			real;
qt_5_w			real;
qt_15_w			real;
qt_25_w			real;
qt_50_w			real;
qt_75_w			real;
qt_85_w			real;
qt_95_w			real;
qt_97_w			real;
qt_99_w			real;

cd_pf_w 		bigint;
ds_sexo_w 		varchar(1);

--AI --Altura por Idade
--PI --Peso por Idade
--PA --Peso por Altura
--IMC -- IMCI --IMC por Idade
BEGIN

select 	max(cd_pessoa_fisica)
into STRICT 	cd_pf_w
from 	atendimento_paciente
where 	nr_atendimento = nr_atendimento_p;

ds_sexo_w := obter_sexo_pf(cd_pf_w, 'C');
anos_w := coalesce(anos_p,Obter_Idade_PF(cd_pf_w, coalesce(dt_registro_p,clock_timestamp()), 'A'));
meses_w := coalesce(meses_p,Obter_Idade_PF(cd_pf_w, coalesce(dt_registro_p,clock_timestamp()), 'M'));

if ( ie_tipo_p = 'PA' ) and
	((anos_w < 5) or (anos_w = 5 and meses_w = 0)) and ( peso_p > 0) and (altura_p > 0) then	

	if ( anos_w > 2) then
	
		Select  min(nr_Sequencia)
		into STRICT	nr_sequencia_w
		from	W_AVAL_WHO
		where	ie_tipo = ie_tipo_p
		and		ie_sexo = ds_sexo_w
		and		QT_ANOS > 2
		and		altura_p <= QT_ALTURA_CM;
	
	else
	
		Select  min(nr_Sequencia)
		into STRICT	nr_sequencia_w
		from	W_AVAL_WHO
		where	ie_tipo = ie_tipo_p
		and		ie_sexo = ds_sexo_w
		and		QT_ANOS <= 2
		and		altura_p <= QT_ALTURA_CM;
	
	end if;

elsif (ie_tipo_p = 'AI' ) and (anos_w <= 19) and (altura_p > 0) then	
	
	Select  min(nr_Sequencia)
	into STRICT	nr_sequencia_w
	from	W_AVAL_WHO
	where	ie_tipo = ie_tipo_p
	and		ie_sexo = ds_sexo_w
	and		QT_ANOS = anos_w
	and		QT_MESES = meses_w;
	
elsif ((ie_tipo_p = 'IMC') or (ie_tipo_p = 'IMCI')) and (anos_w <= 17) and (qt_imc_p > 0) then	
	
	Select  min(nr_Sequencia)
	into STRICT	nr_sequencia_w
	from	W_AVAL_WHO
	where	ie_tipo = 'IMC'
	and		ie_sexo = ds_sexo_w
	and		QT_ANOS = anos_w
	and		QT_MESES = meses_w;

elsif ( ie_tipo_p = 'PI' ) and ( anos_w <= 10) and ( peso_p > 0) then

	Select  min(nr_Sequencia)
	into STRICT	nr_sequencia_w
	from	W_AVAL_WHO
	where	ie_tipo = ie_tipo_p
	and		ie_sexo = ds_sexo_w
	and		QT_ANOS = anos_w
	and		QT_MESES = meses_w;

end if;

if (nr_sequencia_w > 0) then

	Select  (qt_1)::numeric ,
			(qt_3)::numeric ,
			(qt_5)::numeric ,
			(qt_15)::numeric ,
			(qt_25)::numeric ,
			(qt_50)::numeric ,
			(qt_75)::numeric ,
			(qt_85)::numeric ,
			(qt_95)::numeric ,
			(qt_97)::numeric ,
			(qt_99)::numeric
	into STRICT	qt_1_w,
			qt_3_w,
			qt_5_w,
			qt_15_w,
			qt_25_w,
			qt_50_w,
			qt_75_w,
			qt_85_w,
			qt_95_w,
			qt_97_w,
			qt_99_w
	from	W_AVAL_WHO
	where	nr_sequencia = nr_sequencia_w;

qt_1_p := qt_1_w;
qt_3_p := qt_3_w;
qt_5_p := qt_5_w;
qt_15_p := qt_15_w;
qt_25_p := qt_25_w;
qt_50_p := qt_50_w;
qt_75_p := qt_75_w;
qt_85_p := qt_85_w;
qt_95_p := qt_95_w;
qt_97_p := qt_97_w;
qt_99_p := qt_99_w;

end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE obter_percentil ( nr_atendimento_p bigint, ie_tipo_p text, peso_p bigint, altura_p bigint, dt_registro_p timestamp, anos_p bigint default null, meses_p bigint default null, qt_imc_p bigint default null, qt_1_p INOUT bigint DEFAULT NULL, qt_3_p INOUT bigint DEFAULT NULL, qt_5_p INOUT bigint DEFAULT NULL, qt_15_p INOUT bigint DEFAULT NULL, qt_25_p INOUT bigint DEFAULT NULL, qt_50_p INOUT bigint DEFAULT NULL, qt_75_p INOUT bigint DEFAULT NULL, qt_85_p INOUT bigint DEFAULT NULL, qt_95_p INOUT bigint DEFAULT NULL, qt_97_p INOUT bigint DEFAULT NULL, qt_99_p INOUT bigint DEFAULT NULL) FROM PUBLIC;

