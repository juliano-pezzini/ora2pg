-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE ctb_gerar_interf_j930_ecd ( nr_seq_controle_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint, dt_inicio_p timestamp, dt_fim_p timestamp, cd_empresa_p bigint, qt_linha_p INOUT bigint, nr_sequencia_p INOUT bigint) AS $body$
DECLARE


/* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Finalidade:
-------------------------------------------------------------------------------------------------------------------

Locais de chamada direta:
[ X ]  Objetos do dicionario [  ] Tasy (Delphi/Java) [  ] Portal [  ]  Relatorios [ ] Outros:
 ------------------------------------------------------------------------------------------------------------------

Pontos de atencao:
-------------------------------------------------------------------------------------------------------------------

Referencias:
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */
nr_crc_w			empresa.nr_crc%type;
nm_signatario_w			pessoa_fisica.nm_pessoa_fisica%type;
cd_cpf_w			pessoa_fisica.nr_cpf%type;
ds_identificacao_w		varchar(20);
cd_assinante_dnrc_w		varchar(3);
ds_arquivo_w			varchar(4000);
ds_compl_arquivo_w		varchar(4000);
ds_linha_w			varchar(8000);
nr_linha_w			bigint	:= qt_linha_p;
nr_seq_registro_w		bigint	:= nr_sequencia_p;
sep_w				varchar(1)	:= '|';
tp_registro_w			varchar(15)	:= 'J930';
ds_email_w			compl_pessoa_fisica.ds_email%type;
nr_telefone_w			compl_pessoa_fisica.nr_telefone%type;
uf_crc_w			pessoa_fisica.uf_conselho%type;
ds_codigo_prof_w		pessoa_fisica.ds_codigo_prof%type;
dt_validade_conselho_w		pessoa_fisica.dt_validade_conselho%type;
cd_versao_w					ctb_regra_sped.cd_versao%type;
ie_finalidade_escrit_w		ctb_regra_sped.ie_finalidade_escrit%type;
cd_contabilista_w		estabelecimento.cd_contabilista%type;
cd_titular_w			estabelecimento.cd_titular%type;
cd_ind_crc_w			pessoa_fisica.nr_seq_conselho%type;

c_pessoa CURSOR FOR
SELECT	nm_pessoa_fisica nm_signatario,
	nr_cpf cd_cpf,
	'DIRETOR' ds_identificacao,
	'203' cd_assinante_dnrc,
	substr(obter_compl_pf(cd_pessoa_fisica, 2, 'M'), 1, 60) ds_email,
	substr(obter_compl_pf(cd_pessoa_fisica, 2, 'T'), 1, 14) nr_telefone,
	null uf_conselho,
	null dt_validade_conselho,
	'' ds_codigo_prof,
	null nr_crc
from	pessoa_fisica
where	cd_pessoa_fisica	= cd_titular_w

union

SELECT	nm_pessoa_fisica nm_signatario,
	nr_cpf cd_cpf,
	'CONTADOR' ds_identificacao,
	'900' cd_assinante_dnrc,
	substr(obter_compl_pf(cd_pessoa_fisica, 2, 'M'), 1, 60) ds_email,
	substr(obter_compl_pf(cd_pessoa_fisica, 2, 'T'), 1, 14) nr_telefone,
	uf_conselho,
	dt_validade_conselho,
	ds_codigo_prof,
	nr_crc_w
from	pessoa_fisica
where	cd_pessoa_fisica	= cd_contabilista_w
order by 4;

c_empresa_resp CURSOR FOR
SELECT	b.nr_seq_conselho,
	b.uf_conselho,
	coalesce(a.ie_resp_legal_gov, 'N') ie_resp_legal_gov,
	to_char(c.cd_qualificacao) cd_qualificacao,
	c.ds_qualificacao,
	substr(obter_compl_pf(b.cd_pessoa_fisica, 2, 'M'), 1, 60) ds_email,
	substr(obter_compl_pf(b.cd_pessoa_fisica, 2, 'T'), 1, 14) nr_telefone,
	b.dt_validade_conselho,
	b.ds_codigo_prof,
	b.nm_pessoa_fisica nm_signatario,
	b.nr_cpf
from	empresa_estab_resp a,
	pessoa_fisica b,
	dnrc_qualif_assinante  c
where	c.nr_sequencia = a.nr_seq_qualif_dnrc
and 	a.cd_pessoa_fisica = b.cd_pessoa_fisica
and	a.ie_signatario = 'S'
and	a.cd_empresa = cd_empresa_p
and	tp_registro_w = 'J930'
-- and ie_finalidade_escrit_w = 0
and c.cd_qualificacao not in (910, 920)

union all

SELECT	b.nr_seq_conselho,
	b.uf_conselho,
	coalesce(a.ie_resp_legal_gov, 'N') ie_resp_legal_gov,
	to_char(c.cd_qualificacao) cd_qualificacao,
	c.ds_qualificacao,
	substr(obter_compl_pf(b.cd_pessoa_fisica, 2, 'M'), 1, 60) ds_email,
	substr(obter_compl_pf(b.cd_pessoa_fisica, 2, 'T'), 1, 14) nr_telefone,
	b.dt_validade_conselho,
	b.ds_codigo_prof,
	b.nm_pessoa_fisica nm_signatario,
	b.nr_cpf
from	empresa_estab_resp a,
	pessoa_fisica b,
	dnrc_qualif_assinante  c
where	c.nr_sequencia = a.nr_seq_qualif_dnrc
and 	a.cd_pessoa_fisica = b.cd_pessoa_fisica
and	a.ie_signatario = 'S'
and	a.cd_empresa = cd_empresa_p
and	tp_registro_w = 'J932'
-- and ie_finalidade_escrit_w = 1
and c.cd_qualificacao in (910,920)

union all

select	null,
	null,
	'N',
	'001',
	'Signatario da ECD com e-CNPJ ou e-PJ',
	'' ds_email,
	'' nr_telefone,
	null,
	'',
	substr(OBTER_RAZAO_SOCIAL(a.cd_cgc),1,80) nm_signatario,
	a.cd_cgc
from	estabelecimento a
where   cd_estabelecimento = cd_estabelecimento_p
order by 1;

empresa_resp_w	c_empresa_resp%rowtype;


BEGIN
select	coalesce(max(a.cd_versao), '9.0'),
	coalesce(max(a.ie_finalidade_escrit), 0)
into STRICT	cd_versao_w,
	ie_finalidade_escrit_w
from	ctb_sped_controle	b,
	ctb_regra_sped		a
where	a.nr_sequencia	= b.nr_seq_regra_sped
and	b.nr_sequencia	= nr_seq_controle_p;

select	max(cd_contabilista),
	max(cd_titular),
	max(nr_crc)
into STRICT	cd_contabilista_w,
	cd_titular_w,
	nr_crc_w
from	estabelecimento
where	cd_estabelecimento = cd_estabelecimento_p;

select	coalesce(cd_contabilista_w, cd_contabilista),
	coalesce(cd_titular_w, cd_titular),
	coalesce(nr_crc_w, nr_crc)
into STRICT	cd_contabilista_w,
	cd_titular_w,
	nr_crc_w
from	empresa
where	cd_empresa = cd_empresa_p;

-- if (cd_versao_w = '7.0' and ie_finalidade_escrit_w = 1) then

	-- tp_registro_w := 'J932';

-- else

	-- tp_registro_w := 'J930';

-- end if;
tp_registro_w := 'J930';
if (cd_versao_w in ('1.0','2.0','3.0','4.0')) then
	begin
	open c_pessoa;
	loop
	fetch c_pessoa into
		nm_signatario_w,
		cd_cpf_w,
		ds_identificacao_w,
		cd_assinante_dnrc_w,
		ds_email_w,
		nr_telefone_w,
		uf_crc_w,
		dt_validade_conselho_w,
		ds_codigo_prof_w,
		nr_crc_w;
	EXIT WHEN NOT FOUND; /* apply on c_pessoa */
		begin
		if (cd_versao_w = '1.0') then
			ds_linha_w	:= substr(	sep_w || tp_registro_w 					||
							sep_w || nm_signatario_w 				||
							sep_w || cd_cpf_w 					||
							sep_w || ds_identificacao_w 				||
							sep_w || cd_assinante_dnrc_w 				||
							sep_w || nr_crc_w					||
							sep_w ,1,8000);
		elsif (cd_versao_w in ('2.0','3.0','4.0')) then
		ds_linha_w	:= substr(		sep_w || tp_registro_w 					||
							sep_w || nm_signatario_w 				||
							sep_w || cd_cpf_w 					||
							sep_w || ds_identificacao_w 				||
							sep_w || cd_assinante_dnrc_w 				||
							sep_w || nr_crc_w					||
							sep_w || ds_email_w					||
							sep_w || nr_telefone_w					||
							sep_w || uf_crc_w					||
							sep_w || ds_codigo_prof_w				||
							sep_w || to_char(dt_validade_conselho_w,'ddmmyyyy')	||
							sep_w ,1,8000);

		end if;

		ds_arquivo_w		:= substr(ds_linha_w,1,4000);
		ds_compl_arquivo_w	:= substr(ds_linha_w,4001,4000);
		nr_seq_registro_w	:= nr_seq_registro_w + 1;
		nr_linha_w		:= nr_linha_w + 1;

		insert into ctb_sped_registro(nr_sequencia,
			ds_arquivo,
			dt_atualizacao,
			nm_usuario,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			nr_seq_controle_sped,
			ds_arquivo_compl,
			cd_registro,
			nr_linha)
		values (nr_seq_registro_w,
			ds_arquivo_w,
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			nr_seq_controle_p,
			ds_compl_arquivo_w,
			tp_registro_w,
			nr_linha_w);
		end;
	end loop;
	close c_pessoa;
	end;
else
	begin
	open c_empresa_resp;
	loop
	fetch c_empresa_resp into
		empresa_resp_w;
	EXIT WHEN NOT FOUND; /* apply on c_empresa_resp */
		begin
		if (empresa_resp_w.cd_qualificacao not in (900,910,920))  then
			begin
			empresa_resp_w.ds_codigo_prof	:= '';
			end;
		end if;

		-- if (tp_registro_w = 'J932') then

			-- ds_linha_w	:= substr(	sep_w || tp_registro_w 						 ||

						-- sep_w || empresa_resp_w.nm_signatario 				 ||

						-- sep_w || empresa_resp_w.nr_cpf					 ||

						-- sep_w || empresa_resp_w.ds_qualificacao 			 ||

						-- sep_w || empresa_resp_w.cd_qualificacao		 		 ||

						-- sep_w || empresa_resp_w.ds_codigo_prof			 	 ||

						-- sep_w || empresa_resp_w.ds_email				 ||

						-- sep_w || empresa_resp_w.nr_telefone				 ||

						-- sep_w || empresa_resp_w.uf_conselho				 ||

						-- sep_w || ''			 				 ||

						-- sep_w || to_char(empresa_resp_w.dt_validade_conselho,'ddmmyyyy') ||

						-- sep_w ,1,8000);

		-- else
		ds_linha_w	:= substr(	sep_w || tp_registro_w 						 ||
					sep_w || empresa_resp_w.nm_signatario 				 ||
					sep_w || empresa_resp_w.nr_cpf					 ||
					sep_w || empresa_resp_w.ds_qualificacao 			 ||
					sep_w || empresa_resp_w.cd_qualificacao		 		 ||
					sep_w || empresa_resp_w.ds_codigo_prof			 	 ||
					sep_w || empresa_resp_w.ds_email				 ||
					sep_w || empresa_resp_w.nr_telefone				 ||
					sep_w || empresa_resp_w.uf_conselho				 ||
					sep_w || ''			 				 ||
					sep_w || to_char(empresa_resp_w.dt_validade_conselho,'ddmmyyyy') ||
					sep_w || empresa_resp_w.ie_resp_legal_gov			 ||
						sep_w ,1,8000);

		-- end if;
		ds_arquivo_w		:= substr(ds_linha_w,1,4000);
		ds_compl_arquivo_w	:= substr(ds_linha_w,4001,4000);
		nr_seq_registro_w	:= nr_seq_registro_w + 1;
		nr_linha_w		:= nr_linha_w + 1;

		insert into ctb_sped_registro(nr_sequencia,
			ds_arquivo,
			dt_atualizacao,
			nm_usuario,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			nr_seq_controle_sped,
			ds_arquivo_compl,
			cd_registro,
			nr_linha)
		values (nr_seq_registro_w,
			ds_arquivo_w,
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			nr_seq_controle_p,
			ds_compl_arquivo_w,
			tp_registro_w,
			nr_linha_w);

		end;
	end loop;
	close c_empresa_resp;

	-- J932
	if	((cd_versao_w in ('7.0','8.0','9.0')) and (ie_finalidade_escrit_w = 1)) then
		begin
		tp_registro_w := 'J932';
		open c_empresa_resp;
		loop
		fetch c_empresa_resp into
			empresa_resp_w;
		EXIT WHEN NOT FOUND; /* apply on c_empresa_resp */
			begin
			if (empresa_resp_w.cd_qualificacao not in (900,910,920))  then
				begin
				empresa_resp_w.ds_codigo_prof	:= '';
				end;
			end if;

			ds_linha_w	:= substr(	sep_w || tp_registro_w 						 ||
						sep_w || empresa_resp_w.nm_signatario 				 ||
						sep_w || empresa_resp_w.nr_cpf					 ||
						sep_w || empresa_resp_w.ds_qualificacao 			 ||
						sep_w || empresa_resp_w.cd_qualificacao		 		 ||
						sep_w || empresa_resp_w.ds_codigo_prof			 	 ||
						sep_w || empresa_resp_w.ds_email				 ||
						sep_w || empresa_resp_w.nr_telefone				 ||
						sep_w || empresa_resp_w.uf_conselho				 ||
						sep_w || ''			 				 ||
						sep_w || to_char(empresa_resp_w.dt_validade_conselho,'ddmmyyyy') ||
						sep_w ,1,8000);


			ds_arquivo_w		:= substr(ds_linha_w,1,4000);
			ds_compl_arquivo_w	:= substr(ds_linha_w,4001,4000);
			nr_seq_registro_w	:= nr_seq_registro_w + 1;
			nr_linha_w		:= nr_linha_w + 1;

			insert into ctb_sped_registro(nr_sequencia,
				ds_arquivo,
				dt_atualizacao,
				nm_usuario,
				dt_atualizacao_nrec,
				nm_usuario_nrec,
				nr_seq_controle_sped,
				ds_arquivo_compl,
				cd_registro,
				nr_linha)
			values (nr_seq_registro_w,
				ds_arquivo_w,
				clock_timestamp(),
				nm_usuario_p,
				clock_timestamp(),
				nm_usuario_p,
				nr_seq_controle_p,
				ds_compl_arquivo_w,
				tp_registro_w,
				nr_linha_w);

			end;
		end loop;
		close c_empresa_resp;
		end;
	end if; -- end if J932
	end;
end if;

commit;

qt_linha_p	:= nr_linha_w;
nr_sequencia_p	:= nr_seq_registro_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ctb_gerar_interf_j930_ecd ( nr_seq_controle_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint, dt_inicio_p timestamp, dt_fim_p timestamp, cd_empresa_p bigint, qt_linha_p INOUT bigint, nr_sequencia_p INOUT bigint) FROM PUBLIC;

