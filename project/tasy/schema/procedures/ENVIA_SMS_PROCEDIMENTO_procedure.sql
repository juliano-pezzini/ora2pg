-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE envia_sms_procedimento ( nr_prescricao_p bigint, nm_usuario_p text) AS $body$
DECLARE


ds_remetente_w	rep_regra_envio_sms_dest.ds_remetente%type;
nr_ddi_w	rep_regra_envio_sms_dest.nr_ddi%type;
nr_celular_w	rep_regra_envio_sms_dest.nr_celular%type;
ds_mensagem_w	rep_regra_envio_sms_dest.ds_mensagem%type;
id_sms_w		bigint;
ds_procedimento_w	varchar(240);
nm_paciente_w		varchar(240);
ds_setor_atend_w	varchar(240);
cd_procedimento_w	procedimento.ds_procedimento%TYPE;
ds_param_consist_tel_w	varchar(1);

c01 CURSOR FOR
SELECT	y.ds_remetente,
		y.nr_ddi,
		y.nr_celular,
		y.ds_mensagem,
		c.ds_procedimento,
		substr(obter_nome_pf(a.cd_pessoa_fisica),1,240),
		substr(Obter_Unidade_Atendimento(a.nr_atendimento,'IAA','SU'),1,240),
		b.cd_procedimento
from 	rep_regra_envio_sms_dest y,
		rep_regra_envio_sms x,
		estrutura_procedimento_v c,
		prescr_procedimento b,
		prescr_medica a
where	a.nr_prescricao 	= b.nr_prescricao
and		b.cd_procedimento 	= c.cd_procedimento
and 	b.ie_origem_proced 	= c.ie_origem_proced
and 	y.nr_seq_regra		= x.nr_sequencia
and 	a.nr_prescricao		= nr_prescricao_p
and 	a.cd_setor_atendimento	= coalesce(x.cd_setor_atendimento,a.cd_setor_atendimento)
and 	c.cd_procedimento	= coalesce(x.cd_procedimento,c.cd_procedimento)
and 	c.ie_origem_proced	= coalesce(x.ie_origem_proced,c.ie_origem_proced)
and		c.cd_area_procedimento	= coalesce(x.cd_area_procedimento,c.cd_area_procedimento)
and		c.cd_especialidade	= coalesce(x.cd_especialidade, c.cd_especialidade)
and		c.cd_grupo_proc		= coalesce(x.cd_grupo_proc, c.cd_grupo_proc)
and		coalesce(a.ie_funcao_prescritor,'X')	= coalesce(x.ie_tipo_evolucao, coalesce(a.ie_funcao_prescritor,'X'));



BEGIN
ds_param_consist_tel_w	:= obter_valor_param_usuario(0,214,0,nm_usuario_p,wheb_usuario_pck.get_cd_estabelecimento);
open C01;
loop
fetch C01 into
	ds_remetente_w,
	nr_ddi_w,
	nr_celular_w,
	ds_mensagem_w,
	ds_procedimento_w,
	nm_paciente_w,
	ds_setor_atend_w,
	cd_procedimento_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	ds_mensagem_w	:= substr(replace_macro(ds_mensagem_w, '@PROCEDIMENTO', ds_procedimento_w),1,2000);
	ds_mensagem_w	:= substr(replace_macro(ds_mensagem_w, '@PACIENTE', nm_paciente_w),1,2000);
	ds_mensagem_w	:= substr(replace_macro(ds_mensagem_w, '@SETOR', ds_setor_atend_w),1,2000);
	ds_mensagem_w	:= substr(replace_macro(ds_mensagem_w, '@CD_PROCEDIMENTO', cd_procedimento_w),1,2000);
	if (ds_param_consist_tel_w = 'N') then
		nr_celular_w	:= substr(obter_nr_cel_int(nr_ddi_w, nr_celular_w), 1, 255);
	end if;

	id_sms_w := wheb_sms.enviar_sms( ds_remetente_w, nr_celular_w, ds_mensagem_w, nm_usuario_p, id_sms_w);
	end;
end loop;
close C01;

if (coalesce(wheb_usuario_pck.get_ie_commit, 'S') = 'S') then commit; end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE envia_sms_procedimento ( nr_prescricao_p bigint, nm_usuario_p text) FROM PUBLIC;

