-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_reconst_diluicao ( nr_prescricao_p bigint, nr_sequencia_p bigint, ie_opcao_p text, ie_alterou_dose_p text DEFAULT 'N') AS $body$
DECLARE


    cd_material_w                   integer;
    cd_material_sem_apresent_w      integer;
    cd_material_generico_w          integer;
    cd_mat_generico_sem_apresent_w  integer;
    cd_intervalo_w                  varchar(7);
    cd_intervalo_cad_w              varchar(7);
    nr_agrupamento_w                double precision;
    cd_unidade_medida_w             varchar(30);
    cd_unidade_medida_med_w         varchar(30);
    nr_ocorrencia_w                 double precision;
    nr_seq_acum_w                   bigint;
    nr_agrup_acum_w                 double precision;
    nr_sequencia_w                  bigint;
    qt_conversao_w                  double precision;
    cd_dil_w                        bigint;
    nm_usuario_w                    varchar(15);
    ie_bomba_infusao_w              varchar(15);
    ie_gerar_kit_w                  varchar(15);
    ie_gerar_reconstituicao_w       varchar(15);
    ie_tipo_material_w              varchar(15);
    ie_dilui_vol_medic_w            varchar(1);
    nr_seq_ficha_tecnica_w          bigint;
    nr_seq_agrupamento_w            bigint;
    cd_diluente_w                   integer;
    qt_diluicao_w                   double precision;
    cd_unid_med_diluente_w          varchar(30);
    ie_reconstituicao_w             varchar(1);
    ie_gera_dil_dose_w              varchar(5);
    ie_via_aplicacao_w              varchar(5);
    ie_priorizar_min_w              varchar(5);
    ie_via_aplic_order_w            varchar(5);
    qt_minuto_aplicacao_w           smallint;
    qt_hora_aplicacao_w             smallint;
    qt_material_w                   double precision;
    qt_total_disp_w                 double precision;
    qt_unitaria_w                   double precision;
    ie_gera_diluicao_w              varchar(1) := 'S';
    controle_w                      smallint := 0;
    controle_ww                     smallint := 0;
    ie_regra_w                      varchar(1) := 'N';
    ie_diluente_w                   varchar(1) := 'N';
    ie_atualizar_horario_w          varchar(5);
    nr_seq_prioridade_w             smallint;
    cd_setor_atendimento_w          integer;
    cd_setor_w                      integer;
    cd_estabelecimento_w            smallint;
    qt_idade_w                      double precision;
    qt_idade_min_w                  double precision;
    qt_idade_max_w                  double precision;
    cd_motivo_baixa_w               smallint;/* Rafael em 17/11/2007 OS74014 */
    ie_cobra_paciente_w             varchar(1);/* Rafael em 17/11/2007 OS74014 */
    ds_dose_diferenciada_w          varchar(50);
    qt_dispensar_w                  double precision;
    ie_regra_disp_w                 varchar(1);
    ds_erro_w                       varchar(255);
    cd_perfil_w                     integer;
    nm_usuario_original_w           varchar(15);
    ie_atualiza_reconst_w           varchar(1);
    qt_peso_w                       real;
    ie_gerar_diluicao_w             varchar(1);
    qt_vol_adic_reconst_w           double precision;
    ie_proporcao_w                  varchar(15);
    qt_referencia_w                 double precision;
    qt_referencia_aux_w             double precision;
    qt_unitaria_medic_w             double precision;
    qt_dose_medic_w                 double precision;
    qt_dose_aux_w                   double precision;
    cd_unidade_medida_dose_w        varchar(30);
    qt_dose_diluicao_w              double precision;
    nr_seq_via_acesso_w             bigint;
    nr_seq_restricao_w              bigint;
    cd_pessoa_fisica_w              varchar(30);
    ds_lista_restricao_w            varchar(255);
    qt_solucao_w                    double precision;
    nr_seq_interno_w                bigint;
    cd_unid_med_reconst_w           varchar(30);
    qt_dose_especial_w              double precision;
    qt_dias_util_w                  smallint;
    ie_gerar_diluicao_ww            varchar(1);
    ie_prescr_mat_sem_lib_w         varchar(30);
    ie_calcula_volume_afterpost_w   varchar(1);
    ie_substitui_tempo_atual_w      varchar(1);
    ie_consistedoseconsumomedic_w   varchar(1) := 'S';
    ie_gerar_lote_w                 varchar(1);
    ie_se_necessario_w              varchar(1);
    ie_acm_w                        varchar(1);
    ds_horarios_w                   varchar(2000);
    qt_volume_medic_w               double precision;
    ie_subtrair_volume_medic_w      varchar(1);
    qt_medic_diluido_w              double precision;
    qt_conc_medic_w                 double precision;
    qt_dose_mat_w                   double precision;
    qt_conv_ml_w                    double precision;
    ie_param_813_w                  varchar(1);
    ie_param_327_w                  varchar(1);
    ie_aplic_bolus_w                varchar(1);
    nr_priori_diluente_w            varchar(255);
    nr_priori_reconst_w             varchar(255);
    nr_priori_redil_w               varchar(255);
    nr_prioridade_w                 varchar(255);
    ie_alterou_dose_dil_w           prescr_material.ie_alterou_dose_dil%TYPE;
    qt_reconst_w                    double precision;
    cd_funcao_w                     prescr_medica.cd_funcao_origem%TYPE;
    cd_unidade_medida_conv_w        varchar(30);
    nr_seq_atend_w                  prescr_medica.nr_seq_atend%TYPE;
    ie_param_491_w                  varchar(1);
    qt_sobra_w                      double precision;
    ie_urgencia_w                   prescr_material.ie_urgencia%TYPE;
    cd_mat_diluente_w               prescr_material.cd_material%TYPE;
    ds_alteracao_rastre_w           varchar(4000);
    ie_info_rastre_prescr_w         varchar(1);
    sql_w                           varchar(4000);
    qt_diluicao_out_w               double precision;
    qt_conc_medic_aux_w             double precision;
    qt_conc_medic_aux2_w            double precision;
    qt_diluicao_aux_w               double precision;
    qt_dose_aux2_w                  double precision;
    qt_referencia_aux_www           double precision;
    qt_referencia_aux_ww            double precision;
    qt_unid_med_convert_x           double precision;
	nr_seq_mat_cpoe_w				prescr_material.nr_seq_mat_cpoe%type;

/*
ie_opcao_p
	D Diluicao
	R Reconstituicao
	A Ambos
*/
    c01 CURSOR FOR
    SELECT
        coalesce(cd_diluente, 0),
        coalesce(qt_diluicao, 0),
		--nvl(cd_unid_med_diluente, 'ml',
        coalesce(cd_unid_med_diluente, obter_unid_med_usua('ML')),
        coalesce(ie_reconstituicao, 'A'),
        ie_via_aplicacao,
        coalesce(qt_minuto_aplicacao, 0),
        cd_intervalo,
        nr_seq_prioridade,
        cd_setor_atendimento,
        qt_idade_min,
        qt_idade_max,
        coalesce(cd_motivo_baixa, 0),
        coalesce(ie_cobra_paciente, 'S'),
        coalesce(ie_proporcao, 'F'),
        qt_referencia,
        nr_seq_restricao,
        nr_seq_interno,
        ie_atualizar_tempo,
        ie_diluir_inteiro,
        coalesce(ie_gerar_lote, 'S'),
        qt_volume,
        qt_volume_medic,
        ie_subtrair_volume_medic,
        nr_priori_diluente_w
    FROM
        material_diluicao
    WHERE
            1 = 1
        AND obter_se_regra_diluicao_setor(nr_seq_interno, cd_setor_atendimento_w) = 'S'
        AND coalesce(obter_conversao_unid_med_cons(cd_material_w, cd_unidade_medida_dose_w, qt_dose_medic_w), 0) BETWEEN coalesce(obter_conversao_unid_med_cons(
        cd_material_w, cd_unidade_medida, qt_dose_min), 0) AND coalesce(obter_conversao_unid_med_cons(cd_material_w, cd_unidade_medida,
        qt_dose_max), 9999999)
        AND qt_idade_w BETWEEN obter_idade_diluicao(cd_material, nr_sequencia, 'MIN') AND obter_idade_diluicao(cd_material, nr_sequencia,
        'MAX')
        AND qt_peso_w BETWEEN coalesce(qt_peso_min, 0) AND coalesce(qt_peso_max, 999999)
        AND ( ( cd_setor_excluir <> coalesce(cd_setor_atendimento_w, 0) )
              OR ( coalesce(cd_setor_excluir::text, '') = '' ) )
        AND ( ( ie_via_excluir <> ie_via_aplicacao_w )
              OR ( coalesce(ie_via_excluir::text, '') = '' ) )
        AND ( ( obter_se_contido(nr_seq_restricao, ds_lista_restricao_w) = 'S' )
              OR ( coalesce(nr_seq_restricao::text, '') = '' ) )
        AND ( ( nr_seq_via_acesso = nr_seq_via_acesso_w )
              OR ( coalesce(nr_seq_via_acesso::text, '') = '' ) )
        AND ( ( nr_seq_agrupamento = nr_seq_agrupamento_w )
              OR ( coalesce(nr_seq_agrupamento::text, '') = '' ) )
        AND ( ( cd_setor_atendimento = cd_setor_atendimento_w )
              OR ( coalesce(cd_setor_atendimento::text, '') = '' ) )
        AND ( ( ie_via_aplicacao = ie_via_aplicacao_w )
              OR ( coalesce(ie_via_aplicacao::text, '') = '' ) )
        AND ( ( cd_unidade_medida = cd_unidade_medida_dose_w )
              OR ( coalesce(cd_unidade_medida::text, '') = '' ) )
        AND coalesce(cd_perfil, coalesce(obter_perfil_ativo, 0)) = coalesce(obter_perfil_ativo, 0)
        AND cd_material = coalesce(cd_material_sem_apresent_w, cd_material_w)
        AND coalesce(cd_estabelecimento, cd_estabelecimento_w) = cd_estabelecimento_w
        AND obter_se_material_ativo(cd_diluente) = 'A'
        AND ie_reconstituicao = 'N'
        AND ie_opcao_p IN ( 'A', 'D' )
        AND ie_gera_diluicao_w = 'S'
        AND ( ( ie_param_813_w <> 'P' )
              OR ( ( nr_priori_diluente_w = '0' )
                   OR ( ( coalesce(cd_mat_diluente_w, 0) > 0 )
                        AND ( cd_mat_diluente_w <> cd_diluente ) ) )
              OR ( obter_se_contido(nr_seq_prioridade, nr_priori_diluente_w) = 'S' )
              OR ( ie_param_813_w = 'P'  AND  ie_alterou_dose_p = 'S' ) )
        AND ( ( ie_param_327_w <> 'S' )
              OR ( ie_aplic_bolus_w = 'N' ) )

UNION

    SELECT
        coalesce(cd_diluente, 0),
        coalesce(qt_diluicao, 0),
		--nvl(cd_unid_med_diluente,'ml'),
        coalesce(cd_unid_med_diluente, obter_unid_med_usua('ML')),
        coalesce(ie_reconstituicao, 'A'),
        ie_via_aplicacao,
        coalesce(qt_minuto_aplicacao, 0),
        cd_intervalo,
        nr_seq_prioridade,
        cd_setor_atendimento,
        qt_idade_min,
        qt_idade_max,
        coalesce(cd_motivo_baixa, 0),
        coalesce(ie_cobra_paciente, 'S'),
        coalesce(ie_proporcao, 'F'),
        qt_referencia,
        nr_seq_restricao,
        nr_seq_interno,
        ie_atualizar_tempo,
        ie_diluir_inteiro,
        coalesce(ie_gerar_lote, 'S'),
        qt_volume,
        qt_volume_medic,
        ie_subtrair_volume_medic,
        nr_priori_diluente_w
    FROM
        material_diluicao
    WHERE
            1 = 1
        AND coalesce(obter_conversao_unid_med_cons(cd_material_w, cd_unidade_medida_dose_w, qt_dose_medic_w), 0) BETWEEN coalesce(obter_conversao_unid_med_cons(
        cd_material_w, cd_unidade_medida, qt_dose_min), 0) AND coalesce(obter_conversao_unid_med_cons(cd_material_w, cd_unidade_medida,
        qt_dose_max), 9999999)
        AND obter_se_regra_diluicao_setor(nr_seq_interno, cd_setor_atendimento_w) = 'S'
        AND ( ( obter_se_contido(nr_seq_restricao, ds_lista_restricao_w) = 'S' )
              OR ( coalesce(nr_seq_restricao::text, '') = '' ) )
        AND qt_idade_w BETWEEN obter_idade_diluicao(cd_material, nr_sequencia, 'MIN') AND obter_idade_diluicao(cd_material, nr_sequencia,
        'MAX')
        AND qt_peso_w BETWEEN coalesce(qt_peso_min, 0) AND coalesce(qt_peso_max, 999999)
        AND ( ( ie_via_excluir <> ie_via_aplicacao_w )
              OR ( coalesce(ie_via_excluir::text, '') = '' ) )
        AND ( ( cd_setor_excluir <> coalesce(cd_setor_atendimento_w, 0) )
              OR ( coalesce(cd_setor_excluir::text, '') = '' ) )
        AND ( ( nr_seq_via_acesso = nr_seq_via_acesso_w )
              OR ( coalesce(nr_seq_via_acesso::text, '') = '' ) )
        AND ( ( cd_setor_atendimento = cd_setor_atendimento_w )
              OR ( coalesce(cd_setor_atendimento::text, '') = '' ) )
        AND ( ( nr_seq_agrupamento = nr_seq_agrupamento_w )
              OR ( coalesce(nr_seq_agrupamento::text, '') = '' ) )
        AND ( ( ie_via_aplicacao = ie_via_aplicacao_w )
              OR ( coalesce(ie_via_aplicacao::text, '') = '' ) )
        AND ( ( cd_unidade_medida = cd_unidade_medida_dose_w )
              OR ( coalesce(cd_unidade_medida::text, '') = '' ) )
        AND coalesce(cd_perfil, coalesce(obter_perfil_ativo, 0)) = coalesce(obter_perfil_ativo, 0)
        AND cd_material = coalesce(cd_mat_generico_sem_apresent_w, cd_material_generico_w)
        AND coalesce(cd_estabelecimento, cd_estabelecimento_w) = cd_estabelecimento_w
        AND ie_opcao_p IN ( 'A', 'D' )
        AND obter_se_material_ativo(cd_diluente) = 'A'
        AND ie_reconstituicao = 'N'
        AND ie_regra_w = 'G'
        AND ie_gera_diluicao_w = 'S'
        AND ( ( ie_param_813_w <> 'P' )
              OR ( ( nr_priori_diluente_w = '0' )
                   OR ( ( coalesce(cd_mat_diluente_w, 0) > 0 )
                        AND ( cd_mat_diluente_w <> cd_diluente ) ) )
              OR ( obter_se_contido(nr_seq_prioridade, nr_priori_diluente_w) = 'S' )
              OR ( ie_param_813_w = 'P'  AND  ie_alterou_dose_p = 'S' ) )
        AND ( ( ie_param_327_w <> 'S' )
              OR ( ie_aplic_bolus_w = 'N' ) )
    ORDER BY
        ie_via_aplicacao DESC,
        cd_setor_atendimento DESC,
        qt_idade_min DESC,
        qt_idade_max DESC,
        nr_seq_prioridade DESC,
        nr_seq_restricao DESC;

    c02 CURSOR FOR
    SELECT
        coalesce(cd_diluente, 0),
        coalesce(qt_diluicao, 0),
		--nvl(cd_unid_med_diluente,'ml'),
        coalesce(cd_unid_med_diluente, obter_unid_med_usua('ML')),
        coalesce(ie_reconstituicao, 'A'),
        ie_via_aplicacao,
        cd_intervalo,
        nr_seq_prioridade,
        cd_setor_atendimento,
        qt_idade_min,
        qt_idade_max,
        coalesce(cd_motivo_baixa, 0),
        coalesce(ie_cobra_paciente, 'S'),
        coalesce(qt_minuto_aplicacao, 0),
        qt_volume_adic,
        coalesce(ie_proporcao, 'F'),
        qt_referencia,
        nr_seq_restricao,
        cd_unid_med_reconst,
        ie_atualizar_tempo,
        coalesce(ie_priorizar_min, 'N'),
        coalesce(ie_gerar_lote, 'S'),
        qt_volume,
        nr_seq_interno,
        nr_priori_reconst_w
    FROM
        material_diluicao
    WHERE
            1 = 1
        AND coalesce(obter_conversao_unid_med_cons(cd_material_w, cd_unidade_medida_dose_w, qt_dose_medic_w), 0) BETWEEN coalesce(obter_conversao_unid_med_cons(
        cd_material_w, cd_unidade_medida, qt_dose_min), 0) AND coalesce(obter_conversao_unid_med_cons(cd_material_w, cd_unidade_medida,
        qt_dose_max), 9999999)
        AND obter_se_regra_diluicao_setor(nr_seq_interno, cd_setor_atendimento_w) = 'S'
        AND ( ( obter_se_contido(nr_seq_restricao, ds_lista_restricao_w) = 'S' )
              OR ( coalesce(nr_seq_restricao::text, '') = '' ) )
        AND qt_idade_w BETWEEN obter_idade_diluicao(cd_material, nr_sequencia, 'MIN') AND obter_idade_diluicao(cd_material, nr_sequencia,
        'MAX')
        AND qt_peso_w BETWEEN coalesce(qt_peso_min, 0) AND coalesce(qt_peso_max, 999999)
        AND ( ( cd_setor_excluir <> coalesce(cd_setor_atendimento_w, 0) )
              OR ( coalesce(cd_setor_excluir::text, '') = '' ) )
        AND ( ( ie_via_excluir <> ie_via_aplicacao_w )
              OR ( coalesce(ie_via_excluir::text, '') = '' ) )
        AND ( ( cd_setor_atendimento = cd_setor_atendimento_w )
              OR ( coalesce(cd_setor_atendimento::text, '') = '' ) )
        AND ( ( nr_seq_agrupamento = nr_seq_agrupamento_w )
              OR ( coalesce(nr_seq_agrupamento::text, '') = '' ) )
        AND ( ( ie_via_aplicacao = ie_via_aplicacao_w )
              OR ( coalesce(ie_via_aplicacao::text, '') = '' ) )
        AND ( ( cd_unidade_medida = cd_unidade_medida_dose_w )
              OR ( coalesce(cd_unidade_medida::text, '') = '' ) )
        AND coalesce(cd_perfil, coalesce(obter_perfil_ativo, 0)) = coalesce(obter_perfil_ativo, 0)
        AND coalesce(cd_estabelecimento, cd_estabelecimento_w) = cd_estabelecimento_w
        AND ( ( nr_seq_via_acesso = nr_seq_via_acesso_w )
              OR ( coalesce(nr_seq_via_acesso::text, '') = '' ) )
        AND obter_se_material_ativo(cd_diluente) = 'A'
        AND ie_reconstituicao = 'S'
        AND cd_material = cd_material_w
        AND ie_opcao_p IN ( 'A', 'R' )
        AND ie_gerar_reconstituicao_w = 'S'
        AND ( ( ie_param_813_w <> 'P' )
              OR ( nr_priori_reconst_w = '0' )
              OR ( obter_se_contido(nr_seq_prioridade, nr_priori_reconst_w) = 'S' )
              OR ( ie_param_813_w = 'P'  AND  ie_alterou_dose_p = 'S' ) )

UNION

    SELECT
        coalesce(cd_diluente, 0),
        coalesce(qt_diluicao, 0),
		--nvl(cd_unid_med_diluente,'ml'),
        coalesce(cd_unid_med_diluente, obter_unid_med_usua('ML')),
        coalesce(ie_reconstituicao, 'A'),
        ie_via_aplicacao,
        cd_intervalo,
        nr_seq_prioridade,
        cd_setor_atendimento,
        qt_idade_min,
        qt_idade_max,
        coalesce(cd_motivo_baixa, 0),
        coalesce(ie_cobra_paciente, 'S'),
        coalesce(qt_minuto_aplicacao, 0),
        qt_volume_adic,
        coalesce(ie_proporcao, 'F'),
        qt_referencia,
        nr_seq_restricao,
        cd_unid_med_reconst,
        ie_atualizar_tempo,
        coalesce(ie_priorizar_min, 'N'),
        coalesce(ie_gerar_lote, 'S'),
        qt_volume,
        nr_seq_interno,
        nr_priori_reconst_w
    FROM
        material_diluicao
    WHERE
            1 = 1
        AND coalesce(obter_conversao_unid_med_cons(cd_material_w, cd_unidade_medida_dose_w, qt_dose_medic_w), 0) BETWEEN coalesce(obter_conversao_unid_med_cons(
        cd_material_w, cd_unidade_medida, qt_dose_min), 0) AND coalesce(obter_conversao_unid_med_cons(cd_material_w, cd_unidade_medida,
        qt_dose_max), 9999999)
        AND obter_se_regra_diluicao_setor(nr_seq_interno, cd_setor_atendimento_w) = 'S'
        AND qt_idade_w BETWEEN obter_idade_diluicao(cd_material, nr_sequencia, 'MIN') AND obter_idade_diluicao(cd_material, nr_sequencia,
        'MAX')
        AND qt_peso_w BETWEEN coalesce(qt_peso_min, 0) AND coalesce(qt_peso_max, 999999)
        AND ( ( obter_se_contido(nr_seq_restricao, ds_lista_restricao_w) = 'S' )
              OR ( coalesce(nr_seq_restricao::text, '') = '' ) )
        AND ( ( ie_via_excluir <> ie_via_aplicacao_w )
              OR ( coalesce(ie_via_excluir::text, '') = '' ) )
        AND ( ( cd_setor_excluir <> coalesce(cd_setor_atendimento_w, 0) )
              OR ( coalesce(cd_setor_excluir::text, '') = '' ) )
        AND ( ( cd_setor_atendimento = cd_setor_atendimento_w )
              OR ( coalesce(cd_setor_atendimento::text, '') = '' ) )
        AND ( ( nr_seq_agrupamento = nr_seq_agrupamento_w )
              OR ( coalesce(nr_seq_agrupamento::text, '') = '' ) )
        AND ( ( ie_via_aplicacao = ie_via_aplicacao_w )
              OR ( coalesce(ie_via_aplicacao::text, '') = '' ) )
        AND ( ( cd_unidade_medida = cd_unidade_medida_dose_w )
              OR ( coalesce(cd_unidade_medida::text, '') = '' ) )
        AND coalesce(cd_perfil, coalesce(obter_perfil_ativo, 0)) = coalesce(obter_perfil_ativo, 0)
        AND coalesce(cd_estabelecimento, cd_estabelecimento_w) = cd_estabelecimento_w
        AND ( ( nr_seq_via_acesso = nr_seq_via_acesso_w )
              OR ( coalesce(nr_seq_via_acesso::text, '') = '' ) )
        AND obter_se_material_ativo(cd_diluente) = 'A'
        AND ie_reconstituicao = 'S'
        AND cd_material = cd_material_generico_w
        AND ie_opcao_p IN ( 'A', 'R' )
        AND ie_regra_w = 'G'
        AND ie_gerar_reconstituicao_w = 'S'
        AND ( ( ie_param_813_w <> 'P' )
              OR ( nr_priori_reconst_w = '0' )
              OR ( obter_se_contido(nr_seq_prioridade, nr_priori_reconst_w) = 'S' )
              OR ( ie_param_813_w = 'P'  AND  ie_alterou_dose_p = 'S' ) )
    ORDER BY
        ie_via_aplicacao DESC,
        cd_setor_atendimento DESC,
        qt_idade_min DESC,
        qt_idade_max DESC,
        nr_seq_prioridade DESC,
        nr_seq_restricao DESC;

    c04 CURSOR FOR
    SELECT
        coalesce(cd_diluente, 0),
        coalesce(qt_diluicao, 0),
		--nvl(cd_unid_med_diluente,'ml'),
        coalesce(cd_unid_med_diluente, obter_unid_med_usua('ML')),
        coalesce(ie_reconstituicao, 'A'),
        ie_via_aplicacao,
        coalesce(qt_minuto_aplicacao, 0),
        cd_intervalo,
        nr_seq_prioridade,
        cd_setor_atendimento,
        qt_idade_min,
        qt_idade_max,
        coalesce(cd_motivo_baixa, 0),
        coalesce(ie_cobra_paciente, 'S'),
        coalesce(ie_proporcao, 'F'),
        qt_referencia,
        nr_seq_restricao,
        qt_volume,
        coalesce(ie_gerar_lote, 'S'),
        nr_priori_redil_w
    FROM
        material_diluicao
    WHERE
            1 = 1
        AND qt_idade_w BETWEEN obter_idade_diluicao(cd_material, nr_sequencia, 'MIN') AND obter_idade_diluicao(cd_material, nr_sequencia,
        'MAX')
        AND qt_peso_w BETWEEN coalesce(qt_peso_min, 0) AND coalesce(qt_peso_max, 999)
        AND ( ( ie_via_excluir <> ie_via_aplicacao_w )
              OR ( coalesce(ie_via_excluir::text, '') = '' ) )
        AND ( ( nr_seq_agrupamento = nr_seq_agrupamento_w )
              OR ( coalesce(nr_seq_agrupamento::text, '') = '' ) )
        AND ( ( ie_via_aplicacao = ie_via_aplicacao_w )
              OR ( coalesce(ie_via_aplicacao::text, '') = '' ) )
        AND coalesce(cd_perfil, coalesce(obter_perfil_ativo, 0)) = coalesce(obter_perfil_ativo, 0)
        AND coalesce(cd_estabelecimento, cd_estabelecimento_w) = cd_estabelecimento_w
        AND ( ( cd_unidade_medida = cd_unidade_medida_dose_w )
              OR ( coalesce(cd_unidade_medida::text, '') = '' ) )
        AND ( ( cd_setor_excluir <> coalesce(cd_setor_atendimento_w, 0) )
              OR ( coalesce(cd_setor_excluir::text, '') = '' ) )
        AND ( ( cd_setor_atendimento = cd_setor_atendimento_w )
              OR ( coalesce(cd_setor_atendimento::text, '') = '' ) )
        AND obter_se_material_ativo(cd_diluente) = 'A'
        AND ie_reconstituicao = 'R'
        AND ie_gerar_rediluente = 'S'
        AND cd_material = cd_material_w
        AND ( ( ie_param_813_w <> 'P' )
              OR ( nr_priori_redil_w = '0' )
              OR ( obter_se_contido(nr_seq_prioridade, nr_priori_redil_w) = 'S' )
              OR ( ie_param_813_w = 'P'  AND  ie_alterou_dose_p = 'S' ) );

    c03 CURSOR FOR
    SELECT
        nr_seq_restricao
    FROM
        paciente_rep_prescricao a
    WHERE
            1 = 1
        AND (dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
        AND coalesce(dt_inativacao::text, '') = ''
        AND ( ( coalesce(a.dt_fim::text, '') = '' )
              OR ( clock_timestamp() BETWEEN coalesce(a.dt_inicio, clock_timestamp() - interval '1 days') AND a.dt_fim + 86399 / 86400 ) )
        AND cd_pessoa_fisica = cd_pessoa_fisica_w;

    c05 CURSOR FOR
    SELECT
        b.cd_material
    FROM
        material_estab       c,
        medic_ficha_tecnica  a,
        material             b
    WHERE
            1 = 1
        AND coalesce(c.cd_estabelecimento, cd_estabelecimento_w) = cd_estabelecimento_w
        AND c.ie_prescricao = 'S'
        AND c.cd_material = b.cd_material
        AND obter_se_via_adm(b.cd_material, ie_via_aplicacao_w) = 'S'
        AND coalesce(obter_conversao_unid_med_onc(b.cd_material, cd_unid_med_diluente_w), 0) >= qt_dose_diluicao_w
        AND b.cd_material <> cd_diluente_w
        AND b.ie_situacao = 'A'
        AND b.nr_seq_ficha_tecnica = a.nr_sequencia
        AND a.nr_sequencia = nr_seq_ficha_tecnica_w
    ORDER BY
        coalesce(obter_conversao_unid_med_onc(b.cd_material, cd_unid_med_diluente_w), 0) DESC;


BEGIN

/* Fernando */

/* Matheus OS 50978 20/03/07 coloquei cd_estabelecimento*/

    SELECT
        MAX(a.cd_setor_atendimento),
        MAX(a.cd_estabelecimento),
        MAX(obter_idade(b.dt_nascimento, coalesce(b.dt_obito, clock_timestamp()), 'DIA')),
        MAX(a.nm_usuario_original),
        coalesce(MAX(a.qt_peso), 0),
        MAX(b.cd_pessoa_fisica),
        MAX(a.cd_funcao_origem),
        MAX(nr_seq_atend)
    INTO STRICT
        cd_setor_atendimento_w,
        cd_estabelecimento_w,
        qt_idade_w,
        nm_usuario_original_w,
        qt_peso_w,
        cd_pessoa_fisica_w,
        cd_funcao_w,
        nr_seq_atend_w
    FROM
        pessoa_fisica  b,
        prescr_medica  a
    WHERE
            a.cd_pessoa_fisica = b.cd_pessoa_fisica
        AND a.nr_prescricao = nr_prescricao_p;

    cd_perfil_w := obter_perfil_ativo;
    ie_regra_w := obter_param_usuario(924, 78, cd_perfil_w, nm_usuario_original_w, cd_estabelecimento_w, ie_regra_w);
    ie_atualiza_reconst_w := obter_param_usuario(924, 214, cd_perfil_w, nm_usuario_original_w, cd_estabelecimento_w, ie_atualiza_reconst_w);
    ie_param_327_w := obter_param_usuario(924, 327, cd_perfil_w, nm_usuario_original_w, cd_estabelecimento_w, ie_param_327_w);
    ie_gera_dil_dose_w := obter_param_usuario(924, 347, cd_perfil_w, nm_usuario_original_w, cd_estabelecimento_w, ie_gera_dil_dose_w);
    ie_prescr_mat_sem_lib_w := obter_param_usuario(924, 530, cd_perfil_w, nm_usuario_original_w, cd_estabelecimento_w, ie_prescr_mat_sem_lib_w);
    ie_calcula_volume_afterpost_w := obter_param_usuario(924, 600, cd_perfil_w, nm_usuario_original_w, cd_estabelecimento_w, ie_calcula_volume_afterpost_w);
    ie_gerar_kit_w := obter_param_usuario(924, 702, cd_perfil_w, nm_usuario_original_w, cd_estabelecimento_w, ie_gerar_kit_w);
    ie_param_813_w := obter_param_usuario(924, 813, cd_perfil_w, nm_usuario_original_w, cd_estabelecimento_w, ie_param_813_w);
    ie_param_491_w := obter_param_usuario(3130, 491, cd_perfil_w, nm_usuario_original_w, cd_estabelecimento_w, ie_param_491_w);
    SELECT
        coalesce(MAX(ie_gerar_diluicao), 'S'),
        coalesce(MAX(ie_gerar_reconstituicao), 'S'),
        MAX(nr_seq_agrupamento)
    INTO STRICT
        ie_gerar_diluicao_ww,
        ie_gerar_reconstituicao_w,
        nr_seq_agrupamento_w
    FROM
        setor_atendimento
    WHERE
        cd_setor_atendimento = cd_setor_atendimento_w;

    BEGIN

/* Verificar objeto MD */

        ie_info_rastre_prescr_w := obter_se_info_rastre_prescr('RDR', nm_usuario_original_w, cd_perfil_w, cd_estabelecimento_w);
        IF ( ie_info_rastre_prescr_w = 'S' ) THEN

            ds_alteracao_rastre_w := substr(obter_desc_expressao(942996)
                                            || ' / gerar_reconst_diluicao = '
                                            || chr(13)
                                            || ' 01 - linha'
                                            || ' nr_prescricao_p: '
                                            || nr_prescricao_p
                                            || ' nr_sequencia_p: '
                                            || nr_sequencia_p
                                            || ' cd_setor_atendimento_w: '
                                            || cd_setor_atendimento_w
                                            || ' cd_estabelecimento_w: '
                                            || cd_estabelecimento_w
                                            || ' qt_idade_w: '
                                            || qt_idade_w
                                            || ' nm_usuario_original_w: '
                                            || nm_usuario_original_w
                                            || ' qt_peso_w: '
                                            || qt_peso_w
                                            || ' cd_pessoa_fisica_w: '
                                            || cd_pessoa_fisica_w
                                            || ' cd_funcao_w: '
                                            || cd_funcao_w
                                            || ' nr_seq_atend_w: '
                                            || nr_seq_atend_w
                                            || ' ie_gerar_diluicao_ww: '
                                            || ie_gerar_diluicao_ww
                                            || ' ie_gerar_reconstituicao_w: '
                                            || ie_gerar_reconstituicao_w
                                            || ' nr_seq_agrupamento_w: '
                                            || nr_seq_agrupamento_w
                                            || ' ie_regra_w: '
                                            || ie_regra_w
                                            || ' ie_atualiza_reconst_w: '
                                            || ie_atualiza_reconst_w
                                            || ' ie_param_327_w: '
                                            || ie_param_327_w
                                            || ' ie_gera_dil_dose_w: '
                                            || ie_gera_dil_dose_w
                                            || ' ie_prescr_mat_sem_lib_w: '
                                            || ie_prescr_mat_sem_lib_w
                                            || ' ie_calcula_volume_afterpost_w: '
                                            || ie_calcula_volume_afterpost_w
                                            || ' ie_gerar_kit_w: '
                                            || ie_gerar_kit_w
                                            || ' ie_param_813_w: '
                                            || ie_param_813_w
                                            || ' ie_param_491_w: '
                                            || ie_param_491_w
                                            || ' ie_opcao_p: '
                                            || ie_opcao_p
                                            || ' ie_alterou_dose_p: '
                                            || ie_alterou_dose_p
                                            || ' cd_perfil_w: '
                                            || cd_perfil_w,
                                           1,
                                           4000);

        END IF;

        IF ( nr_prescricao_p > 0 )
            AND ( nr_sequencia_p > 0 )
            AND ( ( ie_gerar_diluicao_ww = 'S' ) OR ( ie_gerar_reconstituicao_w = 'S' ) )
        THEN

     
            SELECT
                coalesce(MAX(nr_sequencia), 0),
                coalesce(MAX(nr_agrupamento), 0)
            INTO STRICT
                nr_seq_acum_w,
                nr_agrup_acum_w
            FROM
                prescr_material
            WHERE
                nr_prescricao = nr_prescricao_p;

			select	coalesce(cd_material, 0),
					cd_intervalo,
					coalesce(nr_agrupamento, 0),
					--nvl(cd_unidade_medida,'ml'),
					coalesce(cd_unidade_medida, obter_unid_med_usua('ML')),
					coalesce(nr_ocorrencia, 1),
					coalesce(nm_usuario, 'Tasy'),
					ie_via_aplicacao,
					coalesce(qt_material, 0),
					coalesce(qt_total_dispensar, 0),
					coalesce(qt_unitaria, 0),
					cd_mat_sem_apresent,
					coalesce(ie_gerar_diluicao, 'S'),
					ds_dose_diferenciada,
					nr_seq_via_acesso,
					coalesce(qt_dose, 0),
					cd_unidade_medida_dose,
					coalesce(qt_dose_especial, 0),
					coalesce(qt_dias_util, 0),
					ie_bomba_infusao,
					substr(ds_horarios, 1, 2000),
					coalesce(ie_aplic_bolus, 'N'),
					obter_prioridade_diluente(nr_prescricao_p, nr_sequencia_p, cd_material, 'N'),
					obter_prioridade_diluente(nr_prescricao_p, nr_sequencia_p, cd_material, 'S'),
					obter_prioridade_diluente(nr_prescricao_p, nr_sequencia_p, cd_material, 'R'),
					coalesce(ie_urgencia, 'N'),
					obter_prioridade_diluente(nr_prescricao_p, nr_sequencia_p, cd_material, 'N', 'D'),
					coalesce(ie_se_necessario, 'N'),
					nr_seq_mat_cpoe
			into STRICT	cd_material_w,
					cd_intervalo_w,
					nr_agrupamento_w,
					cd_unidade_medida_w,
					nr_ocorrencia_w,
					nm_usuario_w,
					ie_via_aplicacao_w,
					qt_material_w,
					qt_total_disp_w,
					qt_unitaria_medic_w,
					cd_material_sem_apresent_w,
					ie_gerar_diluicao_w,
					ds_dose_diferenciada_w,
					nr_seq_via_acesso_w,
					qt_dose_medic_w,
					cd_unidade_medida_dose_w,
					qt_dose_especial_w,
					qt_dias_util_w,
					ie_bomba_infusao_w,
					ds_horarios_w,
					ie_aplic_bolus_w,
					nr_priori_diluente_w,
					nr_priori_reconst_w,
					nr_priori_redil_w,
					ie_urgencia_w,
					cd_mat_diluente_w,
					ie_se_necessario_w,
					nr_seq_mat_cpoe_w
			from	prescr_material
			where	nr_sequencia = nr_sequencia_p
			and		nr_prescricao = nr_prescricao_p;

            cd_unidade_medida_med_w := cd_unidade_medida_dose_w;
            OPEN c03;
            LOOP
                FETCH c03 INTO nr_seq_restricao_w;
                EXIT WHEN NOT FOUND; /* apply on c03 */
                ds_lista_restricao_w := nr_seq_restricao_w
                                        || ','
                                        || ds_lista_restricao_w;
            END LOOP;

            CLOSE c03;
	
	    if (cd_material_sem_apresent_w IS NOT NULL AND cd_material_sem_apresent_w::text <> '') then
		select	sum(qt_dose)
		into STRICT	qt_dose_medic_w
		from	prescr_material
		where	cd_mat_sem_apresent	= cd_material_sem_apresent_w
		and	nr_prescricao		= nr_prescricao_p;
	    end if;
	
            SELECT
                coalesce(MAX(cd_material_generico), cd_material_w)
            INTO STRICT cd_material_generico_w
            FROM
                material
            WHERE
                cd_material = cd_material_w;

            SELECT
                coalesce(MAX(cd_material_generico), cd_material_sem_apresent_w)
            INTO STRICT cd_mat_generico_sem_apresent_w
            FROM
                material
            WHERE
                cd_material = cd_material_sem_apresent_w;

            IF ( ie_info_rastre_prescr_w = 'S' ) THEN
                ds_alteracao_rastre_w := substr(ds_alteracao_rastre_w
                                                || chr(13)
                                                || ' 02 - linha'
                                                || ' nr_sequencia_p: '
                                                || nr_sequencia_p
                                                || ' cd_material_w: '
                                                || cd_material_w
                                                || ' cd_intervalo_w: '
                                                || cd_intervalo_w
                                                || ' nr_agrupamento_w: '
                                                || nr_agrupamento_w
                                                || ' cd_unidade_medida_w: '
                                                || cd_unidade_medida_w
                                                || ' nm_usuario_w: '
                                                || nm_usuario_w
                                                || ' ie_via_aplicacao_w: '
                                                || ie_via_aplicacao_w
                                                || ' qt_material_w: '
                                                || qt_material_w
                                                || ' qt_total_disp_w: '
                                                || qt_total_disp_w
                                                || ' qt_unitaria_medic_w: '
                                                || qt_unitaria_medic_w
                                                || ' cd_material_sem_apresent_w: '
                                                || cd_material_sem_apresent_w
                                                || ' ie_gerar_diluicao_w: '
                                                || ie_gerar_diluicao_w
                                                || ' ds_dose_diferenciada_w: '
                                                || ds_dose_diferenciada_w
                                                || ' nr_seq_via_acesso_w: '
                                                || nr_seq_via_acesso_w
                                                || ' qt_dose_medic_w: '
                                                || qt_dose_medic_w
                                                || ' cd_unidade_medida_dose_w: '
                                                || cd_unidade_medida_dose_w
                                                || ' ie_aplic_bolus_w: '
                                                || ie_aplic_bolus_w
                                                || ' nr_priori_diluente_w: '
                                                || nr_priori_diluente_w
                                                || ' nr_priori_reconst_w: '
                                                || nr_priori_reconst_w
                                                || ' nr_priori_redil_w: '
                                                || nr_priori_redil_w
                                                || ' cd_mat_diluente_w: '
                                                || cd_mat_diluente_w
                                                || ' ie_se_necessario_w: '
                                                || ie_se_necessario_w
                                                || ' ds_lista_restricao_w: '
                                                || ds_lista_restricao_w
                                                || ' cd_mat_generico_sem_apresent_w: '
                                                || cd_mat_generico_sem_apresent_w
                                                || ' cd_material_generico_w: '
                                                || cd_material_generico_w,
                                               1,
                                               4000);
            END IF;

	/* Inserir o reconstituinte */

            OPEN c02;
            LOOP
                FETCH c02 INTO
                    cd_diluente_w,
                    qt_diluicao_w,
                    cd_unid_med_diluente_w,
                    ie_reconstituicao_w,
                    ie_via_aplic_order_w,
                    cd_intervalo_cad_w,
                    nr_seq_prioridade_w,
                    cd_setor_w,
                    qt_idade_min_w,
                    qt_idade_max_w,
                    cd_motivo_baixa_w,
                    ie_cobra_paciente_w,
                    qt_minuto_aplicacao_w,
                    qt_vol_adic_reconst_w,
                    ie_proporcao_w,
                    qt_referencia_w,
                    nr_seq_restricao_w,
                    cd_unid_med_reconst_w,
                    ie_substitui_tempo_atual_w,
                    ie_priorizar_min_w,
                    ie_gerar_lote_w,
                    qt_solucao_w,
                    nr_seq_interno_w,
                    nr_prioridade_w;

                EXIT WHEN NOT FOUND; /* apply on c02 */
                ie_diluente_w := 'S';
            END LOOP;

            CLOSE c02;

            IF ( ie_param_491_w = 'S'  AND nr_seq_atend_w IS NOT NULL AND nr_seq_atend_w::text <> '') THEN
		/* Inicio MD1 */

                BEGIN
                    qt_unid_med_convert_x := obter_conversao_unid_med_onc(cd_material_w, cd_unidade_medida_dose_w);
                    sql_w := 'CALL obter_diluicao_md(:1, :2)INTO :qt_diluicao_out_w';
                    EXECUTE sql_w
                        USING IN qt_unid_med_convert_x, IN qt_dose_medic_w, OUT qt_diluicao_out_w;

                EXCEPTION
                    WHEN OTHERS THEN
                        qt_diluicao_out_w := NULL;
                END;

                qt_diluicao_w := qt_diluicao_out_w;
		/* Fim MD1 */

            ELSE
                IF ( coalesce(qt_referencia_w, 0) > 0 ) THEN
            /* Verificar se objeto obter_conversao_unid_med_cons foi migrado para MD (Avisar)*/

                    qt_referencia_w := obter_conversao_unid_med_cons(cd_diluente_w, cd_unid_med_diluente_w, qt_referencia_w);
                END IF;
            END IF;

            IF ( ie_diluente_w = 'S' )
                AND ( coalesce(cd_diluente_w, 0) > 0 )
            THEN
                nr_sequencia_w := nr_seq_acum_w + 1;
                SELECT
                    MAX(substr(obter_dados_material_estab(cd_material, cd_estabelecimento_w, 'UMS'), 1, 30))
                INTO STRICT cd_unidade_medida_w
                FROM
                    material
                WHERE
                    cd_material = cd_diluente_w;

                SELECT
                    coalesce(MAX(qt_conversao), 1)
                INTO STRICT qt_conversao_w
                FROM
                    material_conversao_unidade
                WHERE
                        cd_unidade_medida = cd_unid_med_diluente_w
                    AND cd_material = cd_diluente_w;

                IF ( coalesce(wheb_usuario_pck.get_ie_commit, 'S') = 'S' ) THEN
                    COMMIT;
                END IF;

                IF ( ie_atualiza_reconst_w = 'N' ) THEN
                    BEGIN
                        DELETE FROM prescr_material
                        WHERE
                                1 = 1
                            AND ie_agrupador = 9
                            AND nr_sequencia_diluicao = nr_sequencia_p
                            AND nr_prescricao = nr_prescricao_p;

                        IF ( coalesce(wheb_usuario_pck.get_ie_commit, 'S') = 'S' ) THEN
                            COMMIT;
                        END IF;

                        CALL excluir_itens_kit_prescr(nr_prescricao_p, NULL);
                    END;
                END IF;

                SELECT
                    COUNT(*)
                INTO STRICT controle_w
                FROM
                    prescr_material
                WHERE
                        1 = 1
                    AND ie_agrupador = 9
                    AND nr_sequencia_diluicao = nr_sequencia_p
                    AND nr_prescricao = nr_prescricao_p;

                qt_unitaria_w := dividir(qt_diluicao_w, qt_conversao_w);
                qt_reconst_w := qt_unitaria_w;
                IF ( controle_w = 0 ) THEN
                    BEGIN
                        SELECT
                            COUNT(*)
                        INTO STRICT controle_ww
                        FROM
                            prescr_material
                        WHERE
                                1 = 1
                            AND ie_agrupador = 3
                            AND nr_sequencia_diluicao = nr_sequencia_p
                            AND nr_prescricao = nr_prescricao_p;

                        IF ( controle_ww = 0 ) THEN
                            BEGIN
                /* Inicio MD2 */

                BEGIN

                    sql_w := 'begin obter_hora_minuto_aplic_md (:1, :2); end;';
                    EXECUTE sql_w
                        USING OUT qt_hora_aplicacao_w, IN OUT qt_minuto_aplicacao_w;
               EXCEPTION
                    WHEN OTHERS THEN
                        qt_minuto_aplicacao_w := NULL;
                        qt_hora_aplicacao_w := NULL;
                END;

 				/* Fim MD 2*/

                                UPDATE prescr_material
                                SET
                                    qt_min_aplicacao = qt_minuto_aplicacao_w,
                                    qt_hora_aplicacao = qt_hora_aplicacao_w
                                WHERE
                                        1 = 1
                                    AND ( ( coalesce(ie_substitui_tempo_atual_w, 'N') = 'S' )
                                          OR ( coalesce(qt_min_aplicacao::text, '') = ''
                                               AND coalesce(qt_hora_aplicacao::text, '') = '' ) )
                                    AND ie_aplic_bolus = 'N'
                                    AND ie_aplic_lenta = 'N'
                                    AND nr_sequencia = nr_sequencia_p
                                    AND nr_prescricao = nr_prescricao_p;

                            END;

                        END IF;

                        IF (
                            ie_param_813_w = 'P'
                            AND nr_prioridade_w <> '0'
                            AND nr_prioridade_w <> '000'
                        ) THEN
                            ie_alterou_dose_dil_w := 'C';
                        ELSE
                            ie_alterou_dose_dil_w := 'N';
                        END IF;

                        IF ( ie_info_rastre_prescr_w = 'S' ) THEN
                            ds_alteracao_rastre_w := substr(ds_alteracao_rastre_w
                                                            || chr(13)
                                                            || ' 03 - linha (insert do reconstituinte)'
                                                            || ' cd_diluente_w: '
                                                            || cd_diluente_w
                                                            || ' nr_sequencia_w: '
                                                            || nr_sequencia_w,
                                                           1,
                                                           4000);
                        END IF;

                        INSERT INTO prescr_material(
                            nr_prescricao,
                            nr_sequencia,
                            ie_origem_inf,
                            cd_material,
                            cd_unidade_medida,
                            cd_unidade_medida_dose,
                            qt_dose,
                            qt_unitaria,
                            qt_material,
                            dt_atualizacao,
                            nm_usuario,
                            cd_intervalo,
                            nr_agrupamento,
                            cd_motivo_baixa,
                            nr_sequencia_diluicao,
                            ie_agrupador,
                            qt_conversao_dose,
                            ie_utiliza_kit,
                            ie_urgencia,
                            ie_medicacao_paciente,
                            ie_suspenso,
                            ie_recons_diluente_fixo,
                            nr_ocorrencia,
                            qt_total_dispensar,
                            ie_sem_aprazamento,
                            ie_cobra_paciente,
                            ie_regra_disp,
                            qt_vol_adic_reconst,
                            qt_ref_diluente,
                            ie_via_aplicacao,
                            ie_bomba_infusao,
                            ie_gerar_lote,
                            qt_solucao,
                            nr_seq_mat_diluicao,
                            ds_horarios,
                            ie_alterou_dose_dil,
							nr_seq_mat_cpoe
                        ) VALUES (
                            nr_prescricao_p,
                            nr_sequencia_w,
                            '1',
                            cd_diluente_w,
                            cd_unidade_medida_w,
                            cd_unid_med_diluente_w,
                            qt_diluicao_w,
                            qt_unitaria_w,
                            qt_unitaria_w * qt_total_disp_w,
                            clock_timestamp(),
                            nm_usuario_w,
                            NULL,
                            0,
				/*0,*/

                            cd_motivo_baixa_w,
                            nr_sequencia_p,
                            9,
                            qt_conversao_w,
                            'N',
                            ie_urgencia_w,
                            'N',
                            'N',
                            'N',
                            nr_ocorrencia_w,
                            qt_total_disp_w,
                            'N',
                            ie_cobra_paciente_w,
                            CASE WHEN cd_motivo_baixa_w=0 THEN  NULL  ELSE 'D' END ,
                            qt_vol_adic_reconst_w,
                            CASE WHEN ie_proporcao_w='SC' THEN  qt_referencia_w WHEN ie_proporcao_w='ST' THEN  qt_referencia_w  ELSE NULL END ,
                            ie_via_aplicacao_w,
                            ie_bomba_infusao_w,
                            ie_gerar_lote_w,
                            qt_solucao_w,
                            nr_seq_interno_w,
                            ds_horarios_w,
                            ie_alterou_dose_dil_w,
							nr_seq_mat_cpoe_w
                        );		 /*  Conversado com o Caldas sobre esta modificacao */
						if (ie_gerar_kit_w = 'S') then
							CALL gerar_kit_medic_prescricao(cd_estabelecimento_w, nr_prescricao_p, nr_sequencia_w, nm_usuario_w, 'S');
						end if;

						if (ie_prescr_mat_sem_lib_w = 'S') then
							CALL gerar_prescr_mat_sem_dt_lib(nr_prescricao_p, nr_sequencia_w, cd_perfil_w, 'N', nm_usuario_original_w, null);
						end if;

                    END;
                END IF;

            END IF;

	/* Inserir o Diluente */

            IF ( ie_gerar_diluicao_ww = 'S' ) THEN
                SELECT
                    coalesce(MAX(nr_sequencia), 0),
                    coalesce(MAX(nr_agrupamento), 0)
                INTO STRICT
                    nr_seq_acum_w,
                    nr_agrup_acum_w
                FROM
                    prescr_material
                WHERE
                    nr_prescricao = nr_prescricao_p;

                IF (ie_via_aplicacao_w IS NOT NULL AND ie_via_aplicacao_w::text <> '') THEN
                    SELECT
                        MAX(ie_gera_diluicao)
                    INTO STRICT ie_gera_diluicao_w
                    FROM
                        via_aplicacao
                    WHERE
                        ie_via_aplicacao = ie_via_aplicacao_w;

                END IF;

                ie_diluente_w := 'N';
                OPEN c01;
                LOOP
                    FETCH c01 INTO
                        cd_diluente_w,
                        qt_diluicao_w,
                        cd_unid_med_diluente_w,
                        ie_reconstituicao_w,
                        ie_via_aplic_order_w,
                        qt_minuto_aplicacao_w,
                        cd_intervalo_cad_w,
                        nr_seq_prioridade_w,
                        cd_setor_w,
                        qt_idade_min_w,
                        qt_idade_max_w,
                        cd_motivo_baixa_w,
                        ie_cobra_paciente_w,
                        ie_proporcao_w,
                        qt_referencia_w,
                        nr_seq_restricao_w,
                        nr_seq_interno_w,
                        ie_substitui_tempo_atual_w,
                        ie_consistedoseconsumomedic_w,
                        ie_gerar_lote_w,
                        qt_solucao_w,
                        qt_volume_medic_w,
                        ie_subtrair_volume_medic_w,
                        nr_prioridade_w;

                    EXIT WHEN NOT FOUND; /* apply on c01 */
                    ie_diluente_w := 'S';
                END LOOP;

                CLOSE c01;
                IF ( ie_diluente_w = 'S' )
                    AND ( coalesce(cd_diluente_w, 0) > 0 )
                THEN
                    SELECT
                        MAX(ie_tipo_material),
                        MAX(nr_seq_ficha_tecnica)
                    INTO STRICT
                        ie_tipo_material_w,
                        nr_seq_ficha_tecnica_w
                    FROM
                        material
                    WHERE
                        cd_material = cd_diluente_w;

                    qt_dose_diluicao_w := qt_diluicao_w;
                    qt_referencia_aux_w := qt_referencia_w;
                    IF ( coalesce(qt_referencia_w, 0) > 0 ) THEN
                        qt_referencia_w := obter_conversao_unid_med_cons(cd_diluente_w, cd_unid_med_diluente_w, qt_referencia_w);
                    END IF;

                    IF ( ie_tipo_material_w = '6' ) THEN
                        OPEN c05;
                        LOOP
                            FETCH c05 INTO cd_dil_w;
                            EXIT WHEN NOT FOUND; /* apply on c05 */
                            cd_dil_w := cd_dil_w;
                        END LOOP;

                        CLOSE c05;
                        IF ( cd_dil_w > 0 ) THEN
                            cd_diluente_w := cd_dil_w;
                        END IF;
                    END IF;

                    nr_sequencia_w := nr_seq_acum_w + 1;
                    ie_dilui_vol_medic_w := 'N';
			/* Inicio MD 3*/

            
        BEGIN
        qt_dose_mat_w := obter_dose_convertida(cd_material_w, ceil(qt_unitaria_medic_w), cd_unidade_medida_w, cd_unidade_medida_dose_w);

        SELECT
            obter_conversao_ml(cd_material_w, qt_dose_mat_w, cd_unidade_medida_dose_w)
        INTO STRICT qt_conv_ml_w
;
         qt_conc_medic_aux_w := obter_dose_convertida(cd_material_w, qt_conv_ml_w, obter_unid_med_usua('ML'), cd_unidade_medida_med_w);
         qt_conc_medic_aux2_w := obter_dose_convertida(cd_material_w, qt_volume_medic_w, obter_unid_med_usua('ML'), cd_unidade_medida_med_w);
         qt_diluicao_aux_w	:= obter_conversao_unid_med_cons(cd_material_w,obter_unid_med_usua('ML'),qt_volume_medic_w);
         qt_dose_aux_w   := obter_conversao_unid_med_cons(cd_material_w, cd_unidade_medida_dose_w, qt_dose_medic_w);
                    sql_w := 'begin obter_qt_medic_diluido_md (:1, :2, :3, :4, :5, :6, :7, :8, :9,:10, :11, :12, :13, :14, :15, :16); end;';
                    EXECUTE sql_w
                        USING IN qt_conc_medic_aux_w, IN ie_proporcao_w, IN ie_consistedoseconsumomedic_w, IN qt_dose_diluicao_w,
                              IN qt_conv_ml_w, IN qt_conc_medic_aux2_w, IN qt_diluicao_aux_w, IN qt_referencia_w,
                              IN qt_unitaria_medic_w, IN qt_dose_aux_w, IN OUT qt_diluicao_w, OUT qt_conc_medic_w,
                              OUT qt_medic_diluido_w, IN OUT ie_dilui_vol_medic_w, IN OUT qt_volume_medic_w, IN OUT qt_minuto_aplicacao_w;
                EXCEPTION
                    WHEN OTHERS THEN
                        qt_diluicao_w := NULL;
                        qt_conc_medic_w := NULL;
                        qt_medic_diluido_w := NULL;
                        ie_dilui_vol_medic_w := NULL;
                        qt_volume_medic_w := NULL;
                        qt_minuto_aplicacao_w := NULL;
                END;

			/* Fim MD 3*/

                    SELECT
                        MAX(substr(obter_dados_material_estab(cd_material, cd_estabelecimento_w, 'UMS'), 1, 30))
                    INTO STRICT cd_unidade_medida_w
                    FROM
                        material
                    WHERE
                        cd_material = cd_diluente_w;

                    SELECT
                        coalesce(MAX(qt_conversao), 1)
                    INTO STRICT qt_conversao_w
                    FROM
                        material_conversao_unidade
                    WHERE
                            1 = 1
                        AND cd_unidade_medida = cd_unid_med_diluente_w
                        AND cd_material = cd_diluente_w;

                    SELECT
                        COUNT(*)
                    INTO STRICT controle_w
                    FROM
                        prescr_material
                    WHERE
                            1 = 1
                        AND ie_agrupador = 3
                        AND nr_sequencia_diluicao = nr_sequencia_p
                        AND nr_prescricao = nr_prescricao_p;

                    IF ( controle_w = 0 ) THEN
				/* Inicio MD 2*/

                BEGIN
                    sql_w := 'begin obter_hora_minuto_aplic_md (:1, :2); end;';
                    EXECUTE sql_w
                        USING OUT qt_hora_aplicacao_w, IN OUT qt_minuto_aplicacao_w;
               EXCEPTION
                    WHEN OTHERS THEN
                        qt_minuto_aplicacao_w := NULL;
                        qt_hora_aplicacao_w := NULL;
                END;
				/* Fim MD 2*/

				/* Ivan em 10/07/2007 OS62199 -
				Inclusao das restricoes por bolus e lentamente para nao desativar os dois campos ao mesmo tempo */
                        UPDATE prescr_material
                        SET
                            qt_min_aplicacao = qt_minuto_aplicacao_w,
                            qt_hora_aplicacao = qt_hora_aplicacao_w
                        WHERE
                                1 = 1
                            AND ( ( coalesce(ie_priorizar_min_w, 'N') = 'N' )
                                  OR ( ( coalesce(qt_min_aplicacao::text, '') = '' )
                                       AND ( coalesce(qt_hora_aplicacao::text, '') = '' ) ) )
                            AND ( ( ( coalesce(ie_substitui_tempo_atual_w, 'N') = 'S' )
                                    AND ( ie_proporcao_w <> 'ST' ) )
                                  OR ( ( coalesce(qt_min_aplicacao::text, '') = '' )
                                       AND ( coalesce(qt_hora_aplicacao::text, '') = '' ) ) )
                            AND ie_aplic_bolus = 'N'
                            AND ie_aplic_lenta = 'N'
                            AND nr_sequencia = nr_sequencia_p
                            AND nr_prescricao = nr_prescricao_p;

                        IF ( coalesce(qt_referencia_w, 0) > 0 )
                            AND ( ie_proporcao_w = 'ST' )
                        THEN
                            UPDATE prescr_material
                            SET
                                qt_min_aplicacao = qt_minuto_aplicacao_w,
                                qt_hora_aplicacao = qt_hora_aplicacao_w
                            WHERE
                                    1 = 1
                                AND ie_aplic_bolus = 'N'
                                AND ie_aplic_lenta = 'N'
                                AND nr_sequencia = nr_sequencia_p
                                AND nr_prescricao = nr_prescricao_p;

                        END IF;

                        IF (cd_unid_med_reconst_w IS NOT NULL AND cd_unid_med_reconst_w::text <> '') THEN
                            BEGIN
                                ie_regra_disp_w := '';
                                qt_dispensar_w := 0;
                                SELECT
                                    coalesce(MAX(ie_se_necessario), 'N'),
                                    coalesce(MAX(ie_acm), 'N'),
                                    coalesce(MAX(qt_unitaria), 1)
                                INTO STRICT
                                    ie_se_necessario_w,
                                    ie_acm_w,
                                    qt_unitaria_w
                                FROM
                                    prescr_material
                                WHERE
                                        1 = 1
                                    AND nr_sequencia = nr_sequencia_p
                                    AND nr_prescricao = nr_prescricao_p;

                                SELECT * FROM obter_quant_dispensar(cd_estabelecimento_w, cd_material_w, nr_prescricao_p, nr_sequencia_p, cd_intervalo_w, ie_via_aplicacao_w, qt_unitaria_w, qt_dose_especial_w, nr_ocorrencia_w, ds_dose_diferenciada_w, '1', cd_unidade_medida_dose_w, qt_dias_util_w, qt_material_w, qt_dispensar_w, ie_regra_disp_w, ds_erro_w, ie_se_necessario_w, ie_acm_w) INTO STRICT qt_material_w, qt_dispensar_w, ie_regra_disp_w, ds_erro_w;

                                UPDATE prescr_material
                                SET
                                    cd_unidade_medida = cd_unid_med_reconst_w,
                                    qt_material = qt_material_w,
                                    qt_total_dispensar = qt_dispensar_w
                                WHERE
                                        1 = 1
                                    AND nr_sequencia = nr_sequencia_p
                                    AND nr_prescricao = nr_prescricao_p;

                            END;
                        END IF;

                        IF (
                            ie_param_813_w = 'P'
                            AND nr_prioridade_w <> '0'
                            AND nr_prioridade_w <> '000'
                        ) THEN
                            ie_alterou_dose_dil_w := 'C';
                        ELSE
                            ie_alterou_dose_dil_w := 'N';
                        END IF;

                        IF ( ie_info_rastre_prescr_w = 'S' ) THEN
                            ds_alteracao_rastre_w := substr(ds_alteracao_rastre_w
                                                            || chr(13)
                                                            || ' 04 - linha (insert do diluente)'
                                                            || ' cd_diluente_w: '
                                                            || cd_diluente_w
                                                            || ' nr_sequencia_w: '
                                                            || nr_sequencia_w
                                                            || ' ie_gera_diluicao_w: '
                                                            || ie_gera_diluicao_w,
                                                           1,
                                                           4000);
                        END IF;

                        INSERT INTO prescr_material(
                            nr_prescricao,
                            nr_sequencia,
                            ie_origem_inf,
                            cd_material,
                            cd_unidade_medida,
                            cd_unidade_medida_dose,
                            qt_dose,
                            qt_unitaria,
                            qt_material,
                            dt_atualizacao,
                            nm_usuario,
                            cd_intervalo,
                            nr_agrupamento,
                            cd_motivo_baixa,
                            nr_sequencia_diluicao,
                            ie_agrupador,
                            qt_conversao_dose,
                            ie_utiliza_kit,
                            ie_urgencia,
                            ie_medicacao_paciente,
                            ie_suspenso,
                            ie_via_aplicacao,
                            ie_recons_diluente_fixo,
                            ie_sem_aprazamento,
                            nr_ocorrencia,
                            ie_cobra_paciente,
                            ie_regra_disp,
                            qt_ref_diluente,
                            nr_seq_mat_diluicao,
                            ie_bomba_infusao,
                            ie_gerar_lote,
                            qt_solucao,
                            ds_horarios,
                            ie_alterou_dose_dil,
                            ie_se_necessario
                        ) VALUES (
                            nr_prescricao_p,
                            nr_sequencia_w,
                            '1',
                            cd_diluente_w,
                            cd_unidade_medida_w,
                            cd_unid_med_diluente_w,
                            qt_dose_diluicao_w,
                            dividir(qt_diluicao_w, qt_conversao_w),
                            qt_diluicao_w,
                            clock_timestamp(),
                            nm_usuario_w,
                            coalesce(cd_intervalo_cad_w, cd_intervalo_w),
                            0,
                            cd_motivo_baixa_w,
                            nr_sequencia_p,
                            3,
                            qt_conversao_w,
                            'N',
                            ie_urgencia_w,
                            'N',
                            'N',
                            ie_via_aplicacao_w,
                            'N',
                            'N',
                            nr_ocorrencia_w,
                            ie_cobra_paciente_w,
                            CASE WHEN cd_motivo_baixa_w=0 THEN  NULL  ELSE 'D' END ,
                            CASE WHEN ie_proporcao_w='SC' THEN  qt_referencia_w WHEN ie_proporcao_w='ST' THEN  qt_referencia_w  ELSE NULL END ,
                            nr_seq_interno_w,
                            ie_bomba_infusao_w,
                            ie_gerar_lote_w,
                            qt_solucao_w,
                            ds_horarios_w,
                            ie_alterou_dose_dil_w,
                            ie_se_necessario_w
                        );

                        IF ( ie_gerar_kit_w = 'S' ) THEN
                            CALL gerar_kit_medic_prescricao(cd_estabelecimento_w, nr_prescricao_p, nr_sequencia_w, nm_usuario_w, 'S');
                        END IF;

                        IF ( ie_prescr_mat_sem_lib_w = 'S' ) THEN
                            CALL gerar_prescr_mat_sem_dt_lib(nr_prescricao_p, nr_sequencia_w, cd_perfil_w, 'N', nm_usuario_original_w,
                                                       NULL);
                        END IF;

                        SELECT
                            coalesce(MAX(ie_se_necessario), 'N'),
                            coalesce(MAX(ie_acm), 'N')
                        INTO STRICT
                            ie_se_necessario_w,
                            ie_acm_w
                        FROM
                            prescr_material
                        WHERE
                                1 = 1
                            AND nr_sequencia = nr_sequencia_w
                            AND nr_prescricao = nr_prescricao_p;

                        SELECT * FROM obter_quant_dispensar(1, cd_diluente_w, nr_prescricao_p, nr_sequencia_w, coalesce(cd_intervalo_cad_w, cd_intervalo_w), ie_via_aplicacao_w, dividir(qt_diluicao_w, qt_conversao_w), 0, nr_ocorrencia_w, ds_dose_diferenciada_w, '1', cd_unid_med_diluente_w, 1, qt_diluicao_w, qt_dispensar_w, ie_regra_disp_w, ds_erro_w, ie_se_necessario_w, ie_acm_w) INTO STRICT qt_diluicao_w, qt_dispensar_w, ie_regra_disp_w, ds_erro_w;

                        UPDATE prescr_material
                        SET
                            qt_total_dispensar = qt_dispensar_w
                        WHERE
                                1 = 1
                            AND nr_sequencia = nr_sequencia_w
                            AND nr_prescricao = nr_prescricao_p;

                    ELSIF ( ie_gera_dil_dose_w IN ( 'S', 'P' ) ) THEN
                        UPDATE prescr_material
                        SET
                            qt_dose = qt_dose_diluicao_w,
                            qt_unitaria = dividir(qt_diluicao_w, qt_conversao_w),
                            cd_material = cd_diluente_w,
                            cd_unidade_medida_dose = cd_unid_med_diluente_w,
                            qt_material = qt_diluicao_w,
                            qt_ref_diluente = CASE WHEN ie_proporcao_w='SC' THEN  qt_referencia_w WHEN ie_proporcao_w='ST' THEN  qt_referencia_w  ELSE NULL END
                        WHERE
                                1 = 1
                            AND ie_agrupador = 3
                            AND nr_sequencia_diluicao = nr_sequencia_p
                            AND nr_prescricao = nr_prescricao_p;

                    END IF;

                END IF;

            END IF;
	/* inserir o rediluente*/

            IF ( ie_gerar_diluicao_ww = 'S' ) THEN
                SELECT
                    coalesce(MAX(nr_sequencia), 0),
                    coalesce(MAX(nr_agrupamento), 0)
                INTO STRICT
                    nr_seq_acum_w,
                    nr_agrup_acum_w
                FROM
                    prescr_material
                WHERE
                    nr_prescricao = nr_prescricao_p;

                IF (ie_via_aplicacao_w IS NOT NULL AND ie_via_aplicacao_w::text <> '') THEN
                    SELECT
                        MAX(ie_gera_diluicao)
                    INTO STRICT ie_gera_diluicao_w
                    FROM
                        via_aplicacao
                    WHERE
                        ie_via_aplicacao = ie_via_aplicacao_w;

                END IF;

                ie_diluente_w := 'N';
                OPEN c04;
                LOOP
                    FETCH c04 INTO
                        cd_diluente_w,
                        qt_diluicao_w,
                        cd_unid_med_diluente_w,
                        ie_reconstituicao_w,
                        ie_via_aplic_order_w,
                        qt_minuto_aplicacao_w,
                        cd_intervalo_cad_w,
                        nr_seq_prioridade_w,
                        cd_setor_w,
                        qt_idade_min_w,
                        qt_idade_max_w,
                        cd_motivo_baixa_w,
                        ie_cobra_paciente_w,
                        ie_proporcao_w,
                        qt_referencia_w,
                        nr_seq_restricao_w,
                        qt_solucao_w,
                        ie_gerar_lote_w,
                        nr_prioridade_w;

                    EXIT WHEN NOT FOUND; /* apply on c04 */
                    ie_diluente_w := 'S';
                END LOOP;

                CLOSE c04;
                IF ( ie_diluente_w = 'S' )
                    AND ( coalesce(cd_diluente_w, 0) > 0 )
                THEN
			/* Inicio MD 4*/

               BEGIN
                    qt_referencia_aux_www := obter_conversao_unid_med_cons(cd_diluente_w, cd_unid_med_diluente_w, qt_referencia_w);
                    qt_referencia_aux_ww := obter_conversao_unid_med_cons(cd_diluente_w, cd_unid_med_diluente_w, qt_referencia_aux_www);
                    sql_w := 'begin obter_reconst_diluicao_md (:1, :2, :3, :4, :5, :6, :7, :8, :9,:10, :11, :12, :13, :14, :15, :16, :17, :18); end;';
                    EXECUTE sql_w
                        USING IN ie_subtrair_volume_medic_w, IN qt_volume_medic_w, IN qt_conc_medic_w, IN qt_dose_medic_w,
                              IN ie_dilui_vol_medic_w, IN qt_referencia_aux_www, IN nr_seq_acum_w, IN ie_proporcao_w,
                              IN qt_unitaria_medic_w, IN qt_referencia_aux_ww, OUT qt_conv_ml_w, IN OUT qt_solucao_w,
                              OUT qt_dose_diluicao_w, OUT nr_sequencia_w, IN OUT qt_medic_diluido_w, IN OUT qt_diluicao_w,
                              IN OUT qt_referencia_w,IN OUT qt_minuto_aplicacao_w;
                EXCEPTION
                    WHEN OTHERS THEN
                        qt_conv_ml_w := NULL;
                        qt_solucao_w := NULL;
                        qt_dose_diluicao_w := NULL;
                        nr_sequencia_w := NULL;
                        qt_medic_diluido_w := NULL;
                        qt_diluicao_w := NULL;
                        qt_referencia_w := NULL;
                        qt_minuto_aplicacao_w := NULL;

                END;
            
  			/* Fim MD 4*/

                    SELECT
                        MAX(substr(obter_dados_material_estab(cd_material, cd_estabelecimento_w, 'UMS'), 1, 30))
                    INTO STRICT cd_unidade_medida_w
                    FROM
                        material
                    WHERE
                        cd_material = cd_diluente_w;

                    SELECT
                        coalesce(MAX(qt_conversao), 1)
                    INTO STRICT qt_conversao_w
                    FROM
                        material_conversao_unidade
                    WHERE
                            1 = 1
                        AND cd_unidade_medida = cd_unid_med_diluente_w
                        AND cd_material = cd_diluente_w;

                    SELECT
                        COUNT(*)
                    INTO STRICT controle_w
                    FROM
                        prescr_material
                    WHERE
                            1 = 1
                        AND ie_agrupador = 7
                        AND nr_sequencia_diluicao = nr_sequencia_p
                        AND nr_prescricao = nr_prescricao_p;

                    IF ( controle_w = 0 ) THEN
				/* Inicio MD 2*/

                BEGIN
                    sql_w := 'begin obter_hora_minuto_aplic_md (:1, :2); end;';
                    EXECUTE sql_w
                        USING OUT qt_hora_aplicacao_w, IN OUT qt_minuto_aplicacao_w;
               EXCEPTION
                    WHEN OTHERS THEN
                        qt_minuto_aplicacao_w := NULL;
                        qt_hora_aplicacao_w := NULL;
                END;
				/* Inicio MD 2*/

				/* Ivan em 10/07/2007 OS62199 -
	                           Inclusao das restricoes por bolus e lentamente para nao desativar os dois campos ao mesmo tempo */
                        UPDATE prescr_material
                        SET
                            qt_min_aplicacao = qt_minuto_aplicacao_w,
                            qt_hora_aplicacao = qt_hora_aplicacao_w
                        WHERE
                                1 = 1
                            AND coalesce(qt_min_aplicacao::text, '') = ''
                            AND coalesce(qt_hora_aplicacao::text, '') = ''
                            AND ie_aplic_bolus = 'N'
                            AND ie_aplic_lenta = 'N'
                            AND nr_sequencia = nr_sequencia_p
                            AND nr_prescricao = nr_prescricao_p;

                        IF ( coalesce(qt_referencia_w, 0) > 0 )
                            AND ( ie_proporcao_w = 'ST' )
                        THEN
                            UPDATE prescr_material
                            SET
                                qt_min_aplicacao = qt_minuto_aplicacao_w,
                                qt_hora_aplicacao = qt_hora_aplicacao_w
                            WHERE
                                    1 = 1
                                AND ie_aplic_bolus = 'N'
                                AND ie_aplic_lenta = 'N'
                                AND nr_sequencia = nr_sequencia_p
                                AND nr_prescricao = nr_prescricao_p;

                        END IF;

                        IF (
                            ie_param_813_w = 'P'
                            AND nr_prioridade_w <> '0'
                            AND nr_prioridade_w <> '000'
                        ) THEN
                            ie_alterou_dose_dil_w := 'C';
                        ELSE
                            ie_alterou_dose_dil_w := 'N';
                        END IF;

                        IF ( ie_info_rastre_prescr_w = 'S' ) THEN
                            ds_alteracao_rastre_w := substr(ds_alteracao_rastre_w
                                                            || chr(13)
                                                            || ' 05 - linha (insert do rediluente)'
                                                            || ' cd_diluente_w: '
                                                            || cd_diluente_w
                                                            || ' nr_sequencia_w: '
                                                            || nr_sequencia_w,
                                                           1,
                                                           4000);
                        END IF;

                        INSERT INTO prescr_material(
                            nr_prescricao,
                            nr_sequencia,
                            ie_origem_inf,
                            cd_material,
                            cd_unidade_medida,
                            cd_unidade_medida_dose,
                            qt_dose,
                            qt_unitaria,
                            qt_material,
                            dt_atualizacao,
                            nm_usuario,
                            cd_intervalo,
                            nr_agrupamento,
                            cd_motivo_baixa,
                            nr_sequencia_diluicao,
                            ie_agrupador,
                            qt_conversao_dose,
                            ie_utiliza_kit,
                            ie_urgencia,
                            ie_medicacao_paciente,
                            ie_suspenso,
                            ie_via_aplicacao,
                            ie_recons_diluente_fixo,
                            ie_sem_aprazamento,
                            nr_ocorrencia,
                            ie_cobra_paciente,
                            ie_regra_disp,
                            qt_ref_diluente,
                            qt_solucao,
                            ie_bomba_infusao,
                            ie_gerar_lote,
                            ds_horarios,
                            ie_alterou_dose_dil
                        ) VALUES (
                            nr_prescricao_p,
                            nr_sequencia_w,
                            '1',
                            cd_diluente_w,
                            cd_unidade_medida_w,
                            cd_unid_med_diluente_w,
                            qt_dose_diluicao_w,
                            dividir(qt_diluicao_w, qt_conversao_w),
                            qt_diluicao_w,
                            clock_timestamp(),
                            nm_usuario_w,
                            coalesce(cd_intervalo_cad_w, cd_intervalo_w),
                            0,
                            cd_motivo_baixa_w,
                            nr_sequencia_p,
                            7,
                            qt_conversao_w,
                            'N',
                            'N',
                            'N',
                            'N',
                            ie_via_aplicacao_w,
                            'N',
                            'N',
                            nr_ocorrencia_w,
                            ie_cobra_paciente_w,
                            CASE WHEN cd_motivo_baixa_w=0 THEN  NULL  ELSE 'D' END ,
                            CASE WHEN ie_proporcao_w='SC' THEN  qt_referencia_w WHEN ie_proporcao_w='ST' THEN  qt_referencia_w  ELSE NULL END ,
                            qt_solucao_w,
                            ie_bomba_infusao_w,
                            coalesce(ie_gerar_lote_w, 'S'),
                            ds_horarios_w,
                            ie_alterou_dose_dil_w
                        );

                        IF ( ie_prescr_mat_sem_lib_w = 'S' ) THEN
                            CALL gerar_prescr_mat_sem_dt_lib(nr_prescricao_p, nr_sequencia_w, cd_perfil_w, 'N', nm_usuario_original_w,
                                                       NULL);
                        END IF;

                        SELECT
                            coalesce(MAX(ie_se_necessario), 'N'),
                            coalesce(MAX(ie_acm), 'N')
                        INTO STRICT
                            ie_se_necessario_w,
                            ie_acm_w
                        FROM
                            prescr_material
                        WHERE
                                nr_prescricao = nr_prescricao_p
                            AND nr_sequencia = nr_sequencia_w;

                        SELECT * FROM obter_quant_dispensar(1, cd_diluente_w, nr_prescricao_p, nr_sequencia_w, coalesce(cd_intervalo_cad_w, cd_intervalo_w), ie_via_aplicacao_w, dividir(qt_diluicao_w, qt_conversao_w), 0, nr_ocorrencia_w, ds_dose_diferenciada_w, '1', cd_unid_med_diluente_w, 1, qt_diluicao_w, qt_dispensar_w, ie_regra_disp_w, ds_erro_w, ie_se_necessario_w, ie_acm_w) INTO STRICT qt_diluicao_w, qt_dispensar_w, ie_regra_disp_w, ds_erro_w;

                        UPDATE prescr_material
                        SET
                            qt_total_dispensar = qt_dispensar_w
                        WHERE
                                1 = 1
                            AND nr_sequencia = nr_sequencia_w
                            AND nr_prescricao = nr_prescricao_p;

                    ELSIF ( coalesce(ie_dilui_vol_medic_w, 'N') = 'S' ) THEN
                        UPDATE prescr_material
                        SET
                            qt_dose = qt_dose_diluicao_w,
                            qt_unitaria = qt_diluicao_w,
                            qt_solucao = qt_solucao_w
                        WHERE
                                1 = 1
                            AND ie_agrupador = 7
                            AND nr_sequencia_diluicao = nr_sequencia_p
                            AND nr_prescricao = nr_prescricao_p;

                    END IF;

                END IF;

            END IF;

        END IF;

        IF ( ie_info_rastre_prescr_w = 'S' ) THEN
            CALL gerar_log_prescr_mat(nr_prescricao_p, nr_sequencia_p, NULL, NULL, 'M',
                                ds_alteracao_rastre_w, wheb_usuario_pck.get_nm_usuario,
                                'N');
        END IF;

        CALL ajustar_dose_diluente(nr_prescricao_p, nr_sequencia_p);
        IF (
            ie_calcula_volume_afterpost_w = 'S'
            AND cd_funcao_w <> 2314
        ) THEN
            CALL calcular_vol_dil_prescr_mat(nr_prescricao_p, nr_agrupamento_w, nm_usuario_original_w);
        END IF;

    EXCEPTION
        WHEN OTHERS THEN
            CALL gerar_log_prescricao(nr_prescricao_p, NULL, NULL, NULL, NULL,
                                to_char(sqlerrm), wheb_usuario_pck.get_nm_usuario,
                                8092,
                                'S');
    END;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_reconst_diluicao ( nr_prescricao_p bigint, nr_sequencia_p bigint, ie_opcao_p text, ie_alterou_dose_p text DEFAULT 'N') FROM PUBLIC;

