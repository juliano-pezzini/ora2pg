-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE consistir_parecer_medico ( cd_profissional_p bigint, cd_especialidade_prof_p bigint, cd_especialidade_dest_prof_p bigint, cd_pessoa_parecer_p text, nr_parecer_p bigint, nr_atendimento_p bigint default 0, nm_usuario_p text DEFAULT NULL) AS $body$
DECLARE

 
nr_parecer_w		bigint;
qt_parecer_w		integer;
nm_pessoa_parecer_w	varchar(255);
nm_medico		varchar(255);
ie_parecer_w		varchar(1);
ie_consiste_w		varchar(1);
nr_atendimento_w	bigint;


BEGIN 
ie_parecer_w := Obter_Param_Usuario(281, 745, obter_perfil_ativo, nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento, ie_parecer_w);
ie_consiste_w := Obter_Param_Usuario(281, 1217, obter_perfil_ativo, nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento, ie_consiste_w);
 
select	max(nr_atendimento) 
into STRICT	nr_atendimento_w 
from	parecer_medico_req 
where	nr_parecer = nr_parecer_p;
 
if (coalesce(nr_atendimento_p,0) > 0) and (coalesce(nr_atendimento_w,0) = 0) then 
	nr_atendimento_w := nr_atendimento_p;
end if;
 
if (ie_parecer_w = 'S') and (ie_consiste_w = 'S') then 
	begin 
	select	coalesce(max(nr_parecer),0) 
	into STRICT	nr_parecer_w 
	from	parecer_medico_req 
	where	cd_medico = cd_profissional_p 
	--and	cd_especialidade_prof = cd_especialidade_prof_p 
	and	nr_parecer <> nr_parecer_p 
	and (cd_especialidade_dest_prof = cd_especialidade_dest_prof_p or cd_pessoa_parecer = cd_pessoa_parecer_p) 
	and	ie_situacao = 'A';
 
	if (nr_parecer_w > 0) then 
		select	count(*) 
		into STRICT	qt_parecer_w 
		from	parecer_medico 
		where	nr_parecer = nr_parecer_w 
		and	coalesce(ie_status,'F') = 'F';
 
		if (qt_parecer_w = 0) then 
			select	max(substr(obter_nome_pf(cd_pessoa_parecer),1,255)), 
				max(substr(obter_nome_pf(cd_medico),1,255)) 
			into STRICT	nm_pessoa_parecer_w, 
				nm_medico 
			from	parecer_medico_req 
			where	nr_parecer = nr_parecer_w;
			 
			CALL wheb_mensagem_pck.exibir_mensagem_abort(192954,'NR_PARECER=' || nr_parecer_w);
		end if;
	end if;
	end;
elsif (ie_parecer_w = 'N') and (ie_consiste_w = 'S') then 
	begin 
	select	coalesce(max(nr_parecer),0) 
	into STRICT	nr_parecer_w 
	from	parecer_medico_req 
	where	cd_medico = cd_profissional_p 
	--and	cd_especialidade = cd_especialidade_prof_p 
	and	nr_parecer <> nr_parecer_p 
	and (cd_especialidade_dest = cd_especialidade_dest_prof_p or cd_pessoa_parecer = cd_pessoa_parecer_p) 
	and	nr_atendimento = nr_atendimento_w 
	and	ie_situacao = 'A';
 
	if (nr_parecer_w > 0) then 
		select	count(*) 
		into STRICT	qt_parecer_w 
		from	parecer_medico 
		where	nr_parecer = nr_parecer_w 
		and	coalesce(ie_status,'F') = 'F';
		 
		if (qt_parecer_w = 0) then 
			select	max(substr(obter_nome_pf(cd_pessoa_parecer),1,255)), 
				max(substr(obter_nome_pf(cd_medico),1,255)) 
			into STRICT	nm_pessoa_parecer_w, 
				nm_medico 
			from	parecer_medico_req 
			where	nr_parecer = nr_parecer_w;
			 
			CALL wheb_mensagem_pck.exibir_mensagem_abort(192954,'NR_PARECER=' || nr_parecer_w);
		end if;		
 
	end if;
 
 
	end;
end if;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE consistir_parecer_medico ( cd_profissional_p bigint, cd_especialidade_prof_p bigint, cd_especialidade_dest_prof_p bigint, cd_pessoa_parecer_p text, nr_parecer_p bigint, nr_atendimento_p bigint default 0, nm_usuario_p text DEFAULT NULL) FROM PUBLIC;

