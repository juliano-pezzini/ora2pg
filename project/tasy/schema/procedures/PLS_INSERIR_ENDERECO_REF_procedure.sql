-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_inserir_endereco_ref ( cd_pessoa_fisica_ref_p text, cd_pessoa_fisica_p text, ie_tipo_endereco_p text, nm_usuario_p text) AS $body$
DECLARE


/*
	Tipo endereco
	'R' - Residencial PF
	'C' - Comercial PF
*/
ds_complemento_w		varchar(80);
ds_endereco_w			varchar(100);
nr_endereco_w			varchar(40);
ds_email_w			varchar(255);
nr_telefone_w			varchar(60);
cd_municipio_ibge_w		varchar(6)	:= '';
ds_bairro_w			varchar(80);
sg_estado_w			compl_pessoa_fisica.sg_estado%type;
cd_cep_w			varchar(15);
ds_municipio_w			varchar(200);
tag_pais_w			varchar(15);


BEGIN

if (ie_tipo_endereco_p = 'R') then
	begin
	select	ds_endereco,
		coalesce(nr_endereco,ds_compl_end),
		cd_cep,
		ds_complemento,
		ds_bairro,
		cd_municipio_ibge,
		sg_estado,
		nr_telefone,
		ds_email,
		ds_municipio
	into STRICT	ds_endereco_w,
		nr_endereco_w,
		cd_cep_w,
		ds_complemento_w,
		ds_bairro_w,
		cd_municipio_ibge_w,
		sg_estado_w,
		nr_telefone_w,
		ds_email_w,
		ds_municipio_w
	from	compl_pessoa_fisica
	where	cd_pessoa_fisica	= cd_pessoa_fisica_ref_p
	and	ie_tipo_complemento	= 1;
	exception
		when others then
		CALL wheb_mensagem_pck.exibir_mensagem_abort( 267329, null ); /* Nao foi cadastrado um endereco residencial para a pessoa fisica. Verifique! */
	end;
elsif (ie_tipo_endereco_p = 'C') then
	begin
	select	ds_endereco,
		coalesce(nr_endereco,ds_compl_end),
		cd_cep,
		ds_complemento,
		ds_bairro,
		cd_municipio_ibge,
		sg_estado,
		nr_telefone,
		ds_email,
		ds_municipio
	into STRICT	ds_endereco_w,
		nr_endereco_w,
		cd_cep_w,
		ds_complemento_w,
		ds_bairro_w,
		cd_municipio_ibge_w,
		sg_estado_w,
		nr_telefone_w,
		ds_email_w,
		ds_municipio_w
	from	compl_pessoa_fisica
	where	cd_pessoa_fisica	= cd_pessoa_fisica_ref_p
	and	ie_tipo_complemento	= 2;
	exception
		when others then
		CALL wheb_mensagem_pck.exibir_mensagem_abort( 267330, null ); /* Nao foi cadastrado um endereco comercial para a pessoa fisica. Verifique! */
	end;
end if;

select	max(ds_locale)
into STRICT	tag_pais_w
from	user_locale 
where	nm_user = nm_usuario_p;

if (tag_pais_w in ('de_DE', 'de_AT'))then
	update	compl_pessoa_fisica
	set	ds_endereco		= ds_endereco_w,
		ds_compl_end		= nr_endereco_w,
		cd_cep			= cd_cep_w,
		ds_bairro		= ds_bairro_w,
		nr_telefone		= nr_telefone_w,
		sg_estado		= sg_estado_w,
		ds_email		= ds_email_w,
		ds_complemento		= ds_complemento_w,
		cd_municipio_ibge	= cd_municipio_ibge_w,
		ds_municipio		= ds_municipio_w,
		dt_atualizacao		= clock_timestamp(),
		nm_usuario		= nm_usuario_p
	where	cd_pessoa_fisica	= cd_pessoa_fisica_p;
else
	update	compl_pessoa_fisica
	set	ds_endereco		= ds_endereco_w,
		nr_endereco		= nr_endereco_w,
		cd_cep			= cd_cep_w,
		ds_bairro		= ds_bairro_w,
		nr_telefone		= nr_telefone_w,
		sg_estado		= sg_estado_w,
		ds_email		= ds_email_w,
		ds_complemento		= ds_complemento_w,
		cd_municipio_ibge	= cd_municipio_ibge_w,
		ds_municipio		= ds_municipio_w,
		dt_atualizacao		= clock_timestamp(),
		nm_usuario		= nm_usuario_p
	where	cd_pessoa_fisica	= cd_pessoa_fisica_p;
end if;	
commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_inserir_endereco_ref ( cd_pessoa_fisica_ref_p text, cd_pessoa_fisica_p text, ie_tipo_endereco_p text, nm_usuario_p text) FROM PUBLIC;

