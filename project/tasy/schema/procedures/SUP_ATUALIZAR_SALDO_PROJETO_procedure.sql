-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE sup_atualizar_saldo_projeto ( nr_sequencia_p bigint, nr_seq_projeto_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) AS $body$
DECLARE

 
nr_ultima_sequencia_w	bigint;
dt_mesano_referencia_w	timestamp;
vl_entrada_w        	double precision;
vl_saida_w         	double precision;
vl_saldo_w         	double precision;
vl_anterior_w        	double precision;
vl_saldo_anterior_w		double precision;
vl_lancamentos_fin_w	double precision;
vl_transf_entrada_w	double precision;
vl_transf_saida_w		double precision;

dt_transacao_w		timestamp;
vl_saida_diario_w		double precision;
vl_entrada_diario_w		double precision;
vl_anterior_diario_w		double precision;
vl_saldo_diario_w		double precision;
nr_seq_diario_w		bigint;
nr_titulo_pagar_w		bigint;
nr_ordem_compra_w	bigint;
nr_solic_compra_w	bigint;

vl_descontos_w		double precision;
vl_devolucao_w		double precision;
vl_glosa_w		double precision;
vl_ir_w			double precision;
vl_juros_w		double precision;
vl_multa_w		double precision;
vl_outras_deducoes_w	double precision;
vl_outros_acrescimos_w	double precision;
vl_pago_transacao_w	double precision;

nr_seq_razao_w		bigint;
vl_transacao_w		double precision;
nr_seq_titulo_w		bigint;

cd_conta_financ_w		bigint;
vl_lancamentos_fin_deb_w	double precision;
vl_lancamentos_fin_cred_w	double precision;
vl_comprometido_w		double precision;

nr_seq_proj_ref_w		bigint;
ie_entrada_saida_w		varchar(1);
ie_vl_compr_saldo_w	varchar(1);
ie_param_25_w		varchar(1) := 'N';
nr_seq_proj_rec_ref_w	bigint;
ie_considerar_trib_saldo_w	projeto_recurso.ie_considerar_trib_saldo%type;
vl_tributo_subtrai_w		nota_fiscal_item_trib.vl_tributo%type;
vl_trib_comprometido_w	nota_fiscal_item_trib.vl_tributo%type;
cd_tributo_w		tributo.cd_tributo%type;
vl_tributo_w		nota_fiscal_item_trib.vl_tributo%type;
nr_titulo_w		titulo_pagar.nr_titulo%type;
ie_soma_diminui_w		tributo.ie_soma_diminui%type;
ie_considera_solic_w	varchar(1);

c01 CURSOR FOR 
SELECT	distinct trunc(dt_transacao) 
from	(SELECT	trunc(a.dt_baixa) dt_transacao 
	from	titulo_pagar_baixa a, 
		titulo_pagar b 
	where	((ie_param_25_w = 'N' AND b.nr_seq_proj_rec = nr_seq_projeto_p) or	 
		((ie_param_25_w = 'S') and ((b.nr_seq_proj_rec = nr_seq_projeto_p) or (b.nr_seq_proj_rec in (select nr_sequencia from projeto_recurso where nr_seq_superior = nr_seq_projeto_p))))) 
	and	a.nr_titulo = b.nr_titulo 
	and	b.ie_situacao <> 'T' 
	and	trunc(dt_baixa) between PKG_DATE_UTILS.start_of(dt_mesano_referencia_w,'MONTH',0) and trunc(PKG_DATE_UTILS.end_of(dt_mesano_referencia_w, 'MONTH', 0)) 
	GROUP BY	trunc(dt_baixa HAVING	coalesce(sum(a.vl_pago),0) <> 0 
	) 
	
union all
 
	select	trunc(a.dt_recebimento) 
	from	titulo_receber_liq a, 
		titulo_receber b 
	where	((ie_param_25_w = 'N' AND b.nr_seq_proj_rec = nr_seq_projeto_p) or	 
		((ie_param_25_w = 'S') and ((b.nr_seq_proj_rec = nr_seq_projeto_p) or (b.nr_seq_proj_rec in (select nr_sequencia from projeto_recurso where nr_seq_superior = nr_seq_projeto_p))))) 
	and	a.nr_titulo = b.nr_titulo 
	and	b.ie_situacao <> '5' 
	and	trunc(dt_recebimento) between PKG_DATE_UTILS.start_of(dt_mesano_referencia_w,'MONTH',0) and trunc(PKG_DATE_UTILS.end_of(dt_mesano_referencia_w, 'MONTH', 0)) 
	GROUP BY	trunc(a.dt_recebimento HAVING	coalesce(sum(a.vl_recebido),0) <> 0 
	) 
	
union all
 
	select	trunc(a.dt_referencia) 
	from	projeto_recurso_fin a 
	where	((ie_param_25_w = 'N' AND nr_seq_proj_rec = nr_seq_projeto_p) or	 
		((ie_param_25_w = 'S') and ((nr_seq_proj_rec = nr_seq_projeto_p) or (nr_seq_proj_rec in (select nr_sequencia from projeto_recurso where nr_seq_superior = nr_seq_projeto_p))))) 
	and	trunc(dt_referencia) between PKG_DATE_UTILS.start_of(dt_mesano_referencia_w,'MONTH',0) and trunc(PKG_DATE_UTILS.end_of(dt_mesano_referencia_w, 'MONTH', 0)) 
	
union all
 
	select	trunc(a.dt_aprovacao) 
	from	ordem_compra a, 
		ordem_compra_item b, 
		ordem_compra_item_entrega c 
	where	a.nr_ordem_compra = b.nr_ordem_compra 
	and	b.nr_ordem_compra = c.nr_ordem_compra 
	and	b.nr_item_oci = c.nr_item_oci 
	and	(a.dt_aprovacao IS NOT NULL AND a.dt_aprovacao::text <> '') 
	and	coalesce(a.dt_baixa::text, '') = '' 
	and	coalesce(a.nr_seq_motivo_cancel::text, '') = '' 
	and	coalesce(c.dt_cancelamento::text, '') = '' 
	and	((ie_param_25_w = 'N' AND nr_seq_proj_rec = nr_seq_projeto_p) or	 
		((ie_param_25_w = 'S') and ((nr_seq_proj_rec = nr_seq_projeto_p) or (nr_seq_proj_rec in (select nr_sequencia from projeto_recurso where nr_seq_superior = nr_seq_projeto_p))))) 
	and	trunc(a.dt_aprovacao) between PKG_DATE_UTILS.start_of(dt_mesano_referencia_w,'MONTH',0) and trunc(PKG_DATE_UTILS.end_of(dt_mesano_referencia_w, 'MONTH', 0)) 
	
union all
 
	select	trunc(a.dt_liberacao) 
	from	solic_compra a, 
		solic_compra_item b 
	where	a.nr_solic_compra = b.nr_solic_compra 
	and	(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '') 
	and	coalesce(a.nr_seq_motivo_cancel::text, '') = '' 
	and	((ie_param_25_w = 'N' AND nr_seq_proj_rec = nr_seq_projeto_p) or	 
		((ie_param_25_w = 'S') and ((nr_seq_proj_rec = nr_seq_projeto_p) or (nr_seq_proj_rec in (select nr_sequencia from projeto_recurso where nr_seq_superior = nr_seq_projeto_p))))) 
	and	trunc(a.dt_liberacao) between PKG_DATE_UTILS.start_of(dt_mesano_referencia_w,'MONTH',0) and trunc(PKG_DATE_UTILS.end_of(dt_mesano_referencia_w, 'MONTH', 0)) 
	and	ie_considera_solic_w = 'S' 
	
union all
 
	select	trunc(dt_emissao) 
	from	titulo_pagar 
	where	((ie_param_25_w = 'N' AND nr_seq_proj_rec = nr_seq_projeto_p) or	 
		((ie_param_25_w = 'S') and ((nr_seq_proj_rec = nr_seq_projeto_p) or (nr_seq_proj_rec in (select nr_sequencia from projeto_recurso where nr_seq_superior = nr_seq_projeto_p))))) 
	and	coalesce(dt_liquidacao::text, '') = '' 
	and	ie_situacao = 'A' 
	and	trunc(dt_emissao) between PKG_DATE_UTILS.start_of(dt_mesano_referencia_w,'MONTH',0) and trunc(PKG_DATE_UTILS.end_of(dt_mesano_referencia_w, 'MONTH', 0)) 
	
union all
 
	select	trunc(dt_transferencia) 
	from	proj_recurso_trans_saldo 
	where	((ie_param_25_w = 'N' AND nr_seq_proj_rec = nr_seq_projeto_p) or	 
		((ie_param_25_w = 'S') and ((nr_seq_proj_rec = nr_seq_projeto_p) or (nr_seq_proj_rec in (select nr_sequencia from projeto_recurso where nr_seq_superior = nr_seq_projeto_p))))) 
	and	trunc(dt_transferencia) between PKG_DATE_UTILS.start_of(dt_mesano_referencia_w,'MONTH',0) and trunc(PKG_DATE_UTILS.end_of(dt_mesano_referencia_w, 'MONTH', 0))) alias105 
group by	trunc(dt_transacao) 
order by	trunc(dt_transacao);

c02 CURSOR FOR 
SELECT	a.nr_titulo, 
	trunc(a.dt_baixa), 
	coalesce(sum(a.vl_pago),0), 
	coalesce(sum(a.vl_descontos),0), 
	coalesce(sum(a.vl_ir),0), 
	coalesce(sum(a.vl_outras_deducoes),0), 
	coalesce(sum(a.vl_juros),0), 
	coalesce(sum(a.vl_multa),0), 
	coalesce(sum(a.vl_outros_acrescimos),0), 
	coalesce(sum(a.vl_devolucao),0), 
	coalesce(sum(a.vl_glosa),0), 
	max(b.nr_seq_proj_rec) 
from	titulo_pagar_baixa a, 
	titulo_pagar b 
where	((ie_param_25_w = 'N' AND b.nr_seq_proj_rec = nr_seq_projeto_p) or	 
	((ie_param_25_w = 'S') and ((b.nr_seq_proj_rec = nr_seq_projeto_p) or (b.nr_seq_proj_rec in (SELECT nr_sequencia from projeto_recurso where nr_seq_superior = nr_seq_projeto_p))))) 
and	a.nr_titulo = b.nr_titulo 
and	b.ie_situacao <> 'T' 
and	trunc(dt_baixa) between PKG_DATE_UTILS.start_of(dt_mesano_referencia_w,'MONTH',0) and trunc(PKG_DATE_UTILS.end_of(dt_mesano_referencia_w, 'MONTH', 0)) 
having	coalesce(sum(a.vl_pago),0) <> 0 
group by	a.nr_titulo, 
	trunc(a.dt_baixa);

c03 CURSOR FOR 
SELECT	a.nr_titulo, 
	trunc(a.dt_recebimento), 
	coalesce(sum(a.vl_recebido),0), 
	max(b.nr_seq_proj_rec) 
from	titulo_receber_liq a, 
	titulo_receber b 
where	((ie_param_25_w = 'N' AND b.nr_seq_proj_rec = nr_seq_projeto_p) or	 
	((ie_param_25_w = 'S') and ((b.nr_seq_proj_rec = nr_seq_projeto_p) or (b.nr_seq_proj_rec in (SELECT nr_sequencia from projeto_recurso where nr_seq_superior = nr_seq_projeto_p))))) 
and	a.nr_titulo = b.nr_titulo 
and	b.ie_situacao <> '5' 
and	trunc(dt_recebimento) between PKG_DATE_UTILS.start_of(dt_mesano_referencia_w,'MONTH',0) and trunc(PKG_DATE_UTILS.end_of(dt_mesano_referencia_w, 'MONTH', 0)) 
having	coalesce(sum(a.vl_recebido),0) <> 0 
group by	a.nr_titulo, 
	trunc(a.dt_recebimento);

c04 CURSOR FOR 
SELECT	cd_conta_financ, 
	trunc(dt_referencia), 
	coalesce(sum(vl_movimento),0), 
	max(nr_seq_proj_rec) 
from	projeto_recurso_fin 
where	((ie_param_25_w = 'N' AND nr_seq_proj_rec = nr_seq_projeto_p) or	 
	((ie_param_25_w = 'S') and ((nr_seq_proj_rec = nr_seq_projeto_p) or (nr_seq_proj_rec in (SELECT nr_sequencia from projeto_recurso where nr_seq_superior = nr_seq_projeto_p))))) 
and	trunc(dt_referencia) between PKG_DATE_UTILS.start_of(dt_mesano_referencia_w,'MONTH',0) and trunc(PKG_DATE_UTILS.end_of(dt_mesano_referencia_w, 'MONTH', 0)) 
and	ie_deb_cred = 'C' 
group by	cd_conta_financ, 
	trunc(dt_referencia);

c05 CURSOR FOR 
SELECT	cd_conta_financ, 
	trunc(dt_referencia), 
	coalesce(sum(vl_movimento),0), 
	max(nr_seq_proj_rec) 
from	projeto_recurso_fin 
where	((ie_param_25_w = 'N' AND nr_seq_proj_rec = nr_seq_projeto_p) or	 
	((ie_param_25_w = 'S') and ((nr_seq_proj_rec = nr_seq_projeto_p) or (nr_seq_proj_rec in (SELECT nr_sequencia from projeto_recurso where nr_seq_superior = nr_seq_projeto_p))))) 
and	trunc(dt_referencia) between PKG_DATE_UTILS.start_of(dt_mesano_referencia_w,'MONTH',0) and trunc(PKG_DATE_UTILS.end_of(dt_mesano_referencia_w, 'MONTH', 0)) 
and	ie_deb_cred = 'D' 
group by	cd_conta_financ, 
	trunc(dt_referencia);
	
c06 CURSOR FOR	 
SELECT	distinct a.nr_ordem_compra, 
	trunc(a.dt_aprovacao), 
	sum(((c.qt_prevista_entrega - coalesce(qt_real_entrega,0)) * b.vl_unitario_material)), 
	max(b.nr_seq_proj_rec) 
from	ordem_compra a, 
	ordem_compra_item b, 
	ordem_compra_item_entrega c 
where	a.nr_ordem_compra = b.nr_ordem_compra 
and	b.nr_ordem_compra = c.nr_ordem_compra 
and	b.nr_item_oci = c.nr_item_oci 
and	(a.dt_aprovacao IS NOT NULL AND a.dt_aprovacao::text <> '') 
and	coalesce(a.dt_baixa::text, '') = '' 
and	coalesce(a.nr_seq_motivo_cancel::text, '') = '' 
and	coalesce(c.dt_cancelamento::text, '') = '' 
and	((ie_param_25_w = 'N' AND b.nr_seq_proj_rec = nr_seq_projeto_p) or	 
	((ie_param_25_w = 'S') and ((b.nr_seq_proj_rec = nr_seq_projeto_p) or (b.nr_seq_proj_rec in (SELECT nr_sequencia from projeto_recurso where nr_seq_superior = nr_seq_projeto_p))))) 
and	trunc(a.dt_aprovacao) between PKG_DATE_UTILS.start_of(dt_mesano_referencia_w,'MONTH',0) and trunc(PKG_DATE_UTILS.end_of(dt_mesano_referencia_w, 'MONTH', 0)) 
group by a.nr_ordem_compra, 
	trunc(a.dt_aprovacao);

c07 CURSOR FOR 
SELECT	distinct nr_titulo, 
	trunc(dt_emissao), 
	vl_titulo, 
	nr_seq_proj_rec 
from	titulo_pagar 
where	((ie_param_25_w = 'N' AND nr_seq_proj_rec = nr_seq_projeto_p) or	 
	((ie_param_25_w = 'S') and ((nr_seq_proj_rec = nr_seq_projeto_p) or (nr_seq_proj_rec in (SELECT nr_sequencia from projeto_recurso where nr_seq_superior = nr_seq_projeto_p))))) 
and	coalesce(dt_liquidacao::text, '') = '' 
and	ie_situacao = 'A' 
and	trunc(dt_emissao) between PKG_DATE_UTILS.start_of(dt_mesano_referencia_w,'MONTH',0) and trunc(PKG_DATE_UTILS.end_of(dt_mesano_referencia_w, 'MONTH', 0));

c08 CURSOR FOR 
SELECT	distinct nr_seq_proj_ref, 
	trunc(dt_transferencia), 
	vl_transferido, 
	ie_entrada_saida, 
	nr_seq_proj_rec 
from	proj_recurso_trans_saldo 
where	((ie_param_25_w = 'N' AND nr_seq_proj_rec = nr_seq_projeto_p) or	 
	((ie_param_25_w = 'S') and ((nr_seq_proj_rec = nr_seq_projeto_p) or (nr_seq_proj_rec in (SELECT nr_sequencia from projeto_recurso where nr_seq_superior = nr_seq_projeto_p))))) 
and	trunc(dt_transferencia) between PKG_DATE_UTILS.start_of(dt_mesano_referencia_w,'MONTH',0) and trunc(PKG_DATE_UTILS.end_of(dt_mesano_referencia_w, 'MONTH', 0));

C09 CURSOR FOR 
SELECT	a.cd_conta_financ, 
	trunc(a.dt_transacao), 
	coalesce(sum(a.vl_transacao),0), 
	max(a.nr_seq_proj_rec) 
from 	movto_trans_financ a, 
	transacao_financeira b 
where	((ie_param_25_w = 'N' AND a.nr_seq_proj_rec = nr_seq_projeto_p) or	 
	((ie_param_25_w = 'S') and ((a.nr_seq_proj_rec = nr_seq_projeto_p) or (a.nr_seq_proj_rec in (SELECT nr_sequencia from projeto_recurso where nr_seq_superior = nr_seq_projeto_p))))) 
and 	b.nr_sequencia = a.nr_seq_trans_financ 
and 	trunc(a.dt_transacao) between PKG_DATE_UTILS.start_of(dt_mesano_referencia_w,'MONTH',0) 
and 	trunc(PKG_DATE_UTILS.end_of(dt_mesano_referencia_w, 'MONTH', 0)) 
and 	ie_saldo_caixa = 'E' 
group by a.cd_conta_financ, 
	trunc(a.dt_transacao);
	
C10 CURSOR FOR 
SELECT	a.cd_conta_financ, 
	trunc(a.dt_transacao), 
	coalesce(sum(a.vl_transacao),0), 
	max(a.nr_seq_proj_rec) 
from	movto_trans_financ a, 
	transacao_financeira b 
where	((ie_param_25_w = 'N' AND a.nr_seq_proj_rec = nr_seq_projeto_p) or	 
	((ie_param_25_w = 'S') and ((a.nr_seq_proj_rec = nr_seq_projeto_p) or (a.nr_seq_proj_rec in (SELECT nr_sequencia from projeto_recurso where nr_seq_superior = nr_seq_projeto_p))))) 
and	b.nr_sequencia = a.nr_seq_trans_financ 
and	trunc(a.dt_transacao) between PKG_DATE_UTILS.start_of(dt_mesano_referencia_w,'MONTH',0) 
and	trunc(PKG_DATE_UTILS.end_of(dt_mesano_referencia_w, 'MONTH', 0)) 
and	ie_saldo_caixa = 'S' 
group by a.cd_conta_financ, 
	trunc(a.dt_transacao);
	
c12 CURSOR FOR 
SELECT	b.cd_tributo, 
	b.ie_soma_diminui, 
	coalesce(sum(a.vl_tributo),0) 
from	nota_fiscal_item_trib a, 
	tributo b 
where	a.cd_tributo = b.cd_tributo 
and	b.ie_rateio = 'S' 
and	b.ie_soma_diminui in ('S','D') 
and	a.nr_sequencia in (	SELECT 	x.nr_sequencia 
				from	nota_fiscal x, 
					nota_fiscal_item y 
				where	x.nr_sequencia = y.nr_sequencia 
				and	x.ie_situacao = '1' 
				and	x.cd_estabelecimento = cd_estabelecimento_p 
				and	((ie_param_25_w = 'N' AND y.nr_seq_proj_rec = nr_seq_projeto_p) or	 
					((ie_param_25_w = 'S') and ((y.nr_seq_proj_rec = nr_seq_projeto_p) or (y.nr_seq_proj_rec in (select nr_sequencia from projeto_recurso where nr_seq_superior = nr_seq_projeto_p))))) 
				and	x.nr_sequencia in (	select	t.nr_seq_nota_fiscal 
							from	titulo_pagar t 
							where	t.nr_titulo = nr_titulo_w)) 
group by b.cd_tributo, 
	b.ie_soma_diminui;

c13 CURSOR FOR 
SELECT	distinct a.nr_solic_compra, 
	trunc(a.dt_liberacao), 
	coalesce(sum(b.qt_material * b.vl_unit_previsto),0), 
	max(b.nr_seq_proj_rec) 
from	solic_compra a, 
	solic_compra_item b 
where	a.nr_solic_compra = b.nr_solic_compra 
and	((ie_param_25_w = 'N' AND b.nr_seq_proj_rec = nr_seq_projeto_p) or	 
	((ie_param_25_w = 'S') and ((b.nr_seq_proj_rec = nr_seq_projeto_p) or (b.nr_seq_proj_rec in (SELECT nr_sequencia from projeto_recurso where nr_seq_superior = nr_seq_projeto_p))))) 
and	(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '') 
and	coalesce(a.nr_seq_motivo_cancel::text, '') = '' 
and	b.vl_unit_previsto > 0 
and	trunc(a.dt_liberacao) between PKG_DATE_UTILS.start_of(dt_mesano_referencia_w,'MONTH',0) and trunc(PKG_DATE_UTILS.end_of(dt_mesano_referencia_w, 'MONTH', 0)) 
and	ie_considera_solic_w = 'S' 
and	not exists (	select	 1 
			from	ordem_compra x, 
				ordem_compra_item y 
			where	x.nr_ordem_compra = y.nr_ordem_compra 
			and	y.nr_solic_compra = a.nr_solic_compra 
			and	y.nr_item_solic_compra	= b.nr_item_solic_compra 
			and	substr(obter_se_item_oc_cancelado(x.nr_ordem_compra,y.nr_item_solic_compra),1,1) = 'N' 
			and	(x.dt_liberacao IS NOT NULL AND x.dt_liberacao::text <> '')) 
group by 
	a.nr_solic_compra, 
	trunc(a.dt_liberacao);


BEGIN 
 
select	coalesce(ie_considerar_trib_saldo,'N') 
into STRICT	ie_considerar_trib_saldo_w 
from	projeto_recurso 
where	nr_sequencia = nr_seq_projeto_p;
 
select	max(a.nr_sequencia) 
into STRICT	nr_ultima_sequencia_w 
from	projeto_recurso_saldo a 
where	a.nr_seq_projeto = nr_seq_projeto_p;
 
select	coalesce(obter_valor_param_usuario(928, 25, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p),'N') 
into STRICT	ie_param_25_w
;
 
if (nr_ultima_sequencia_w <> nr_sequencia_p) then 
	/*(-20011,'Existe saldo com mês referência superior, é necessário excluir o mesmo para gerar atualização. '|| '#@#@');*/
 
	CALL wheb_mensagem_pck.exibir_mensagem_abort(200563);
end if;
 
select	ie_considera_vl_compr_saldo, 
	coalesce(ie_cons_solic_acum_proj_rec,'N') 
into STRICT	ie_vl_compr_saldo_w, 
	ie_considera_solic_w 
from	parametro_compras 
where	cd_estabelecimento = cd_estabelecimento_p;
 
select	coalesce(sum(a.vl_anterior),0) 
into STRICT	vl_saldo_anterior_w 
from	projeto_recurso_saldo a 
where	((ie_param_25_w = 'N' AND a.nr_seq_projeto = nr_seq_projeto_p) or	 
	((ie_param_25_w = 'S') and ((a.nr_seq_projeto = nr_seq_projeto_p) or (a.nr_seq_projeto in (SELECT nr_sequencia from projeto_recurso where nr_seq_superior = nr_seq_projeto_p))))) 
and	a.nr_sequencia = (	select	max(x.nr_sequencia) 
				from	projeto_recurso_saldo x 
				where	x.nr_seq_projeto = nr_seq_projeto_p);
 
select	a.dt_mesano_referencia 
into STRICT	dt_mesano_referencia_w 
from	projeto_recurso_saldo a 
where	a.nr_seq_projeto	= nr_seq_projeto_p 
and	a.nr_sequencia 		= nr_sequencia_p;
 
select	coalesce(sum(vl_pago),0), 
	coalesce(sum(a.vl_descontos),0), 
	coalesce(sum(a.vl_ir),0), 
	coalesce(sum(a.vl_outras_deducoes),0), 
	coalesce(sum(a.vl_juros),0), 
	coalesce(sum(a.vl_multa),0), 
	coalesce(sum(a.vl_outros_acrescimos),0), 
	coalesce(sum(a.vl_devolucao),0), 
	coalesce(sum(a.vl_glosa),0) 
into STRICT	vl_saida_w, 
	vl_descontos_w, 
	vl_ir_w, 
	vl_outras_deducoes_w, 
	vl_juros_w, 
	vl_multa_w, 
	vl_outros_acrescimos_w, 
	vl_devolucao_w, 
	vl_glosa_w 
from	titulo_pagar_baixa a, 
	titulo_pagar b 
where	((ie_param_25_w = 'N' AND b.nr_seq_proj_rec = nr_seq_projeto_p) or	 
	((ie_param_25_w = 'S') and ((b.nr_seq_proj_rec = nr_seq_projeto_p) or (b.nr_seq_proj_rec in (SELECT nr_sequencia from projeto_recurso where nr_seq_superior = nr_seq_projeto_p))))) 
and	a.nr_titulo = b.nr_titulo 
and	b.ie_situacao <> 'T' 
and	trunc(dt_baixa) between PKG_DATE_UTILS.start_of(dt_mesano_referencia_w,'MONTH',0) and trunc(PKG_DATE_UTILS.end_of(dt_mesano_referencia_w, 'MONTH', 0));
 
vl_pago_transacao_w	:= vl_saida_w;
	 
vl_saida_w := obter_saldo_titulo_proj_rec(vl_pago_transacao_w, vl_descontos_w, vl_devolucao_w, vl_glosa_w, vl_ir_w, vl_juros_w, vl_multa_w, vl_outras_deducoes_w, vl_outros_acrescimos_w, vl_saida_w);
 
select	coalesce(sum(vl_recebido),0) 
into STRICT	vl_entrada_w 
from	titulo_receber_liq a, 
	titulo_receber b 
where	((ie_param_25_w = 'N' AND b.nr_seq_proj_rec = nr_seq_projeto_p) or	 
	((ie_param_25_w = 'S') and ((b.nr_seq_proj_rec = nr_seq_projeto_p) or (b.nr_seq_proj_rec in (SELECT nr_sequencia from projeto_recurso where nr_seq_superior = nr_seq_projeto_p))))) 
and	a.nr_titulo = b.nr_titulo 
and	b.ie_situacao <> '5' 
and	trunc(dt_recebimento) between PKG_DATE_UTILS.start_of(dt_mesano_referencia_w,'MONTH',0) and trunc(PKG_DATE_UTILS.end_of(dt_mesano_referencia_w, 'MONTH', 0));
 
select	coalesce(sum(CASE WHEN ie_deb_cred='C' THEN  vl_movimento  ELSE vl_movimento*-1 END ),0) 
into STRICT	vl_lancamentos_fin_w 
from	projeto_recurso_fin 
where	((ie_param_25_w = 'N' AND nr_seq_proj_rec = nr_seq_projeto_p) or	 
	((ie_param_25_w = 'S') and ((nr_seq_proj_rec = nr_seq_projeto_p) or (nr_seq_proj_rec in (SELECT nr_sequencia from projeto_recurso where nr_seq_superior = nr_seq_projeto_p))))) 
and	trunc(dt_referencia) between PKG_DATE_UTILS.start_of(dt_mesano_referencia_w,'MONTH',0) and trunc(PKG_DATE_UTILS.end_of(dt_mesano_referencia_w, 'MONTH', 0));
 
select	coalesce(sum(vl_transferido),0) 
into STRICT	vl_transf_entrada_w 
from	proj_recurso_trans_saldo 
where	((ie_param_25_w = 'N' AND nr_seq_proj_rec = nr_seq_projeto_p) or	 
	((ie_param_25_w = 'S') and ((nr_seq_proj_rec = nr_seq_projeto_p) or (nr_seq_proj_rec in (SELECT nr_sequencia from projeto_recurso where nr_seq_superior = nr_seq_projeto_p))))) 
and	ie_entrada_saida = 'E' 
and	trunc(dt_transferencia) between PKG_DATE_UTILS.start_of(dt_mesano_referencia_w,'MONTH',0) and trunc(PKG_DATE_UTILS.end_of(dt_mesano_referencia_w, 'MONTH', 0));
 
select	coalesce(sum(vl_transferido),0) 
into STRICT	vl_transf_saida_w 
from	proj_recurso_trans_saldo 
where	((ie_param_25_w = 'N' AND nr_seq_proj_rec = nr_seq_projeto_p) or	 
	((ie_param_25_w = 'S') and ((nr_seq_proj_rec = nr_seq_projeto_p) or (nr_seq_proj_rec in (SELECT nr_sequencia from projeto_recurso where nr_seq_superior = nr_seq_projeto_p))))) 
and	ie_entrada_saida = 'S' 
and	trunc(dt_transferencia) between PKG_DATE_UTILS.start_of(dt_mesano_referencia_w,'MONTH',0) and trunc(PKG_DATE_UTILS.end_of(dt_mesano_referencia_w, 'MONTH', 0));
 
vl_trib_comprometido_w	:= 0;
vl_tributo_subtrai_w	:= 0;
 
if (ie_considerar_trib_saldo_w = 'S') then		 
	select	coalesce(sum(a.vl_tributo),0) 
	into STRICT	vl_tributo_subtrai_w 
	from	nota_fiscal_item_trib a, 
		tributo b 
	where	a.cd_tributo = b.cd_tributo 
	and	b.ie_rateio = 'S' 
	and	b.ie_soma_diminui in ('D','S') 
	and	a.nr_sequencia in (	SELECT 	x.nr_sequencia 
					from	nota_fiscal x, 
						nota_fiscal_item y 
					where	x.nr_sequencia = y.nr_sequencia 
					and	x.ie_situacao = '1' 
					and	x.cd_estabelecimento = cd_estabelecimento_p 
					and	x.nr_sequencia in (	select	t.nr_seq_nota_fiscal	 
									from	titulo_pagar_baixa tb, 
										titulo_pagar t 
									where	((ie_param_25_w = 'N' AND t.nr_seq_proj_rec = nr_seq_projeto_p) or	 
										((ie_param_25_w = 'S') and ((t.nr_seq_proj_rec = nr_seq_projeto_p) or (t.nr_seq_proj_rec in (select nr_sequencia from projeto_recurso where nr_seq_superior = nr_seq_projeto_p))))) 
									and	tb.nr_titulo = t.nr_titulo 
									and	t.ie_situacao <> 'T' 
									and	trunc(tb.dt_baixa) between PKG_DATE_UTILS.start_of(dt_mesano_referencia_w,'MONTH',0) and trunc(PKG_DATE_UTILS.end_of(dt_mesano_referencia_w, 'MONTH', 0)) 
									having	coalesce(sum(tb.vl_pago),0) <> 0 
									group by t.nr_seq_nota_fiscal));
 
end if;
 
 
vl_saldo_w 	:= ((vl_saldo_anterior_w + vl_entrada_w + vl_lancamentos_fin_w + vl_transf_entrada_w) - vl_saida_w - vl_transf_saida_w - vl_tributo_subtrai_w);
vl_entrada_w	:= vl_entrada_w + vl_transf_entrada_w;
vl_saida_w	:= vl_saida_w + vl_transf_saida_w + vl_tributo_subtrai_w;
 
select	obter_vl_comprometido_proj_rec(nr_seq_projeto_p, PKG_DATE_UTILS.start_of(dt_mesano_referencia_w,'MONTH',0),'M') 
into STRICT	vl_comprometido_w
;
 
if (ie_vl_compr_saldo_w = 'S') then 
	vl_saldo_w := vl_saldo_w - vl_comprometido_w;
	 
	if (ie_considerar_trib_saldo_w = 'S') then 
		select	coalesce(sum(a.vl_tributo),0) 
		into STRICT	vl_trib_comprometido_w 
		from	nota_fiscal_item_trib a, 
			tributo b 
		where	a.cd_tributo = b.cd_tributo 
		and	b.ie_rateio = 'S' 
		and	b.ie_soma_diminui in ('D','S') 
		and	a.nr_sequencia in (	SELECT 	x.nr_sequencia 
						from	nota_fiscal x, 
							nota_fiscal_item y 
						where	x.nr_sequencia = y.nr_sequencia 
						and	x.ie_situacao = '1' 
						and	x.cd_estabelecimento = cd_estabelecimento_p 
						and	x.nr_sequencia in (	select	t.nr_seq_nota_fiscal 
										from	titulo_pagar t 
										where	((ie_param_25_w = 'N' AND t.nr_seq_proj_rec = nr_seq_projeto_p) or	 
											((ie_param_25_w = 'S') and ((t.nr_seq_proj_rec = nr_seq_projeto_p) or (t.nr_seq_proj_rec in (select nr_sequencia from projeto_recurso where nr_seq_superior = nr_seq_projeto_p)))))										 
										and	coalesce(t.dt_liquidacao::text, '') = '' 
										and	pkg_date_utils.start_of(t.dt_emissao, 'MONTH', 0) = PKG_DATE_UTILS.start_of(dt_mesano_referencia_w,'MONTH',0) 
										and	t.ie_situacao = 'A'));
		 
		vl_saldo_w 		:= vl_saldo_w - vl_trib_comprometido_w;
		vl_comprometido_w	:= vl_comprometido_w + vl_trib_comprometido_w;
	end if;
end if;
 
update	projeto_recurso_saldo 
set	nm_usuario 	= nm_usuario_p, 
	dt_atualizacao	= clock_timestamp(), 
	vl_entrada	= coalesce(vl_entrada_w,0), 
	vl_saida	= coalesce(vl_saida_w,0), 
	vl_saldo	= coalesce(vl_saldo_w,0), 
	vl_anterior	= coalesce(vl_saldo_anterior_w,0), 
	vl_comprometido	= coalesce(vl_comprometido_w,0) 
where	nr_sequencia	= nr_sequencia_p;
 
/* Atualizar saldo diário e razão */
 
delete 
from	projeto_rec_saldo_diario 
where	pkg_date_utils.start_of(dt_saldo, 'MONTH', 0) = PKG_DATE_UTILS.start_of(dt_mesano_referencia_w,'MONTH',0) 
and	nr_seq_projeto = nr_seq_projeto_p;
 
delete 
from	projeto_rec_saldo_razao 
where	pkg_date_utils.start_of(dt_referencia, 'MONTH', 0) = PKG_DATE_UTILS.start_of(dt_mesano_referencia_w,'MONTH',0) 
and	nr_seq_projeto = nr_seq_projeto_p;
 
vl_anterior_diario_w	:= vl_saldo_anterior_w;
 
open c01;
loop 
fetch c01 into 
	dt_transacao_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	begin 
 
	select	coalesce(sum(vl_pago),0), 
		coalesce(sum(a.vl_descontos),0), 
		coalesce(sum(a.vl_ir),0), 
		coalesce(sum(a.vl_outras_deducoes),0), 
		coalesce(sum(a.vl_juros),0), 
		coalesce(sum(a.vl_multa),0), 
		coalesce(sum(a.vl_outros_acrescimos),0), 
		coalesce(sum(a.vl_devolucao),0), 
		coalesce(sum(a.vl_glosa),0) 
	into STRICT	vl_saida_diario_w, 
		vl_descontos_w, 
		vl_ir_w, 
		vl_outras_deducoes_w, 
		vl_juros_w, 
		vl_multa_w, 
		vl_outros_acrescimos_w, 
		vl_devolucao_w, 
		vl_glosa_w 
	from	titulo_pagar_baixa a, 
		titulo_pagar b 
	where	((ie_param_25_w = 'N' AND b.nr_seq_proj_rec = nr_seq_projeto_p) or	 
		((ie_param_25_w = 'S') and ((b.nr_seq_proj_rec = nr_seq_projeto_p) or (b.nr_seq_proj_rec in (SELECT nr_sequencia from projeto_recurso where nr_seq_superior = nr_seq_projeto_p))))) 
	and	a.nr_titulo = b.nr_titulo 
	and	b.ie_situacao <> 'T' 
	and	trunc(dt_baixa) = trunc(dt_transacao_w);
 
	vl_pago_transacao_w	:= vl_saida_diario_w;
	 
	vl_saida_diario_w := obter_saldo_titulo_proj_rec(vl_pago_transacao_w, vl_descontos_w, vl_devolucao_w, vl_glosa_w, vl_ir_w, vl_juros_w, vl_multa_w, vl_outras_deducoes_w, vl_outros_acrescimos_w, vl_saida_diario_w);
 
	select	coalesce(sum(vl_recebido),0) 
	into STRICT	vl_entrada_diario_w 
	from	titulo_receber_liq a, 
		titulo_receber b 
	where	((ie_param_25_w = 'N' AND b.nr_seq_proj_rec = nr_seq_projeto_p) or	 
		((ie_param_25_w = 'S') and ((b.nr_seq_proj_rec = nr_seq_projeto_p) or (b.nr_seq_proj_rec in (SELECT nr_sequencia from projeto_recurso where nr_seq_superior = nr_seq_projeto_p))))) 
	and	a.nr_titulo = b.nr_titulo 
	and	b.ie_situacao <> '5' 
	and	trunc(dt_recebimento) = trunc(dt_transacao_w);
 
	select	coalesce(sum(vl_movimento),0) 
	into STRICT	vl_lancamentos_fin_cred_w 
	from	projeto_recurso_fin 
	where	((ie_param_25_w = 'N' AND nr_seq_proj_rec = nr_seq_projeto_p) or	 
		((ie_param_25_w = 'S') and ((nr_seq_proj_rec = nr_seq_projeto_p) or (nr_seq_proj_rec in (SELECT nr_sequencia from projeto_recurso where nr_seq_superior = nr_seq_projeto_p))))) 
	and	trunc(dt_referencia) = trunc(dt_transacao_w) 
	and	ie_deb_cred = 'C';
 
	select	coalesce(sum(vl_movimento),0) 
	into STRICT	vl_lancamentos_fin_deb_w 
	from	projeto_recurso_fin 
	where	((ie_param_25_w = 'N' AND nr_seq_proj_rec = nr_seq_projeto_p) or	 
		((ie_param_25_w = 'S') and ((nr_seq_proj_rec = nr_seq_projeto_p) or (nr_seq_proj_rec in (SELECT nr_sequencia from projeto_recurso where nr_seq_superior = nr_seq_projeto_p))))) 
	and	trunc(dt_referencia) = trunc(dt_transacao_w) 
	and	ie_deb_cred = 'D';
	 
	select	coalesce(sum(vl_transferido),0) 
	into STRICT	vl_transf_entrada_w 
	from	proj_recurso_trans_saldo 
	where	((ie_param_25_w = 'N' AND nr_seq_proj_rec = nr_seq_projeto_p) or	 
		((ie_param_25_w = 'S') and ((nr_seq_proj_rec = nr_seq_projeto_p) or (nr_seq_proj_rec in (SELECT nr_sequencia from projeto_recurso where nr_seq_superior = nr_seq_projeto_p))))) 
	and	ie_entrada_saida = 'E' 
	and	trunc(dt_transferencia) = trunc(dt_transacao_w);
 
	select	coalesce(sum(vl_transferido),0) 
	into STRICT	vl_transf_saida_w 
	from	proj_recurso_trans_saldo 
	where	((ie_param_25_w = 'N' AND nr_seq_proj_rec = nr_seq_projeto_p) or	 
		((ie_param_25_w = 'S') and ((nr_seq_proj_rec = nr_seq_projeto_p) or (nr_seq_proj_rec in (SELECT nr_sequencia from projeto_recurso where nr_seq_superior = nr_seq_projeto_p))))) 
	and	ie_entrada_saida = 'S' 
	and	trunc(dt_transferencia) = trunc(dt_transacao_w);
	 
	vl_trib_comprometido_w	:= 0;
	vl_tributo_subtrai_w	:= 0;
	 
	if (ie_considerar_trib_saldo_w = 'S') then 
		select	coalesce(sum(a.vl_tributo),0) 
		into STRICT	vl_tributo_subtrai_w 
		from	nota_fiscal_item_trib a, 
			tributo b 
		where	a.cd_tributo = b.cd_tributo 
		and	b.ie_rateio = 'S' 
		and	b.ie_soma_diminui in ('D','S') 
		and	a.nr_sequencia in (	SELECT 	x.nr_sequencia 
						from	nota_fiscal x, 
							nota_fiscal_item y 
						where	x.nr_sequencia = y.nr_sequencia 
						and	x.ie_situacao = '1' 
						and	x.cd_estabelecimento = cd_estabelecimento_p 
						and	x.nr_sequencia in (	select	t.nr_seq_nota_fiscal	 
										from	titulo_pagar_baixa tb, 
											titulo_pagar t 
										where	((ie_param_25_w = 'N' AND t.nr_seq_proj_rec = nr_seq_projeto_p) or	 
											((ie_param_25_w = 'S') and ((t.nr_seq_proj_rec = nr_seq_projeto_p) or (t.nr_seq_proj_rec in (select nr_sequencia from projeto_recurso where nr_seq_superior = nr_seq_projeto_p))))) 
										and	tb.nr_titulo = t.nr_titulo 
										and	t.ie_situacao <> 'T' 
										and	trunc(tb.dt_baixa) between PKG_DATE_UTILS.start_of(dt_mesano_referencia_w,'MONTH',0) and trunc(PKG_DATE_UTILS.end_of(dt_mesano_referencia_w, 'MONTH', 0)) 
										having	coalesce(sum(tb.vl_pago),0) <> 0 
										group by t.nr_seq_nota_fiscal));
	 
	end if;	
 
	vl_entrada_diario_w	:= (vl_entrada_diario_w + vl_lancamentos_fin_cred_w + vl_transf_entrada_w);
	vl_saida_diario_w	:= (vl_saida_diario_w + vl_lancamentos_fin_deb_w + vl_transf_saida_w + vl_tributo_subtrai_w);
 
	vl_saldo_diario_w	:= ((vl_anterior_diario_w + vl_entrada_diario_w) - vl_saida_diario_w);
	 
	select	obter_vl_comprometido_proj_rec(nr_seq_projeto_p, trunc(dt_transacao_w),'D') 
	into STRICT	vl_comprometido_w 
	;
 
	if (ie_vl_compr_saldo_w = 'S') then 
		vl_saldo_diario_w := vl_saldo_diario_w - vl_comprometido_w;
		 
		if (ie_considerar_trib_saldo_w = 'S') then 
			select	coalesce(sum(a.vl_tributo),0) 
			into STRICT	vl_trib_comprometido_w 
			from	nota_fiscal_item_trib a, 
				tributo b 
			where	a.cd_tributo = b.cd_tributo 
			and	b.ie_rateio = 'S' 
			and	b.ie_soma_diminui in ('D','S') 
			and	a.nr_sequencia in (	SELECT 	x.nr_sequencia 
							from	nota_fiscal x, 
								nota_fiscal_item y 
							where	x.nr_sequencia = y.nr_sequencia 
							and	x.ie_situacao = '1' 
							and	x.cd_estabelecimento = cd_estabelecimento_p 
							and	x.nr_sequencia in (	select	t.nr_seq_nota_fiscal 
											from	titulo_pagar t 
											where	((ie_param_25_w = 'N' AND t.nr_seq_proj_rec = nr_seq_projeto_p) or	 
												((ie_param_25_w = 'S') and ((t.nr_seq_proj_rec = nr_seq_projeto_p) or (t.nr_seq_proj_rec in (select nr_sequencia from projeto_recurso where nr_seq_superior = nr_seq_projeto_p))))) 
											and	coalesce(t.dt_liquidacao::text, '') = '' 
											and	pkg_date_utils.start_of(t.dt_emissao, 'MONTH', 0) = PKG_DATE_UTILS.start_of(dt_mesano_referencia_w,'MONTH',0) 
											and	t.ie_situacao = 'A'));
			 
			vl_saldo_diario_w 	:= vl_saldo_diario_w - vl_trib_comprometido_w;
			vl_comprometido_w	:= vl_comprometido_w + vl_trib_comprometido_w;
		end if;		
	end if;		
 
	select	nextval('projeto_rec_saldo_diario_seq') 
	into STRICT	nr_seq_diario_w 
	;
 
	insert into projeto_rec_saldo_diario( 
		nr_sequencia, 
		nr_seq_projeto, 
		dt_atualizacao, 
		nm_usuario, 
		dt_atualizacao_nrec, 
		nm_usuario_nrec, 
		dt_saldo, 
		vl_anterior, 
		vl_saldo, 
		vl_saida, 
		vl_entrada, 
		vl_comprometido) 
	values (	nr_seq_diario_w, 
		nr_seq_projeto_p, 
		clock_timestamp(), 
		nm_usuario_p, 
		clock_timestamp(), 
		nm_usuario_p, 
		trunc(dt_transacao_w), 
		coalesce(vl_anterior_diario_w,0), 
		coalesce(vl_saldo_diario_w,0), 
		coalesce(vl_saida_diario_w,0), 
		coalesce(vl_entrada_diario_w,0), 
		coalesce(vl_comprometido_w,0));
 
	vl_anterior_diario_w	:= vl_saldo_diario_w;
 
	end;
end loop;
close c01;
 
open c02;
loop 
fetch c02 into 
	nr_seq_titulo_w, 
	dt_transacao_w, 
	vl_transacao_w, 
	vl_descontos_w, 
	vl_ir_w, 
	vl_outras_deducoes_w, 
	vl_juros_w, 
	vl_multa_w, 
	vl_outros_acrescimos_w, 
	vl_devolucao_w, 
	vl_glosa_w, 
	nr_seq_proj_rec_ref_w;
EXIT WHEN NOT FOUND; /* apply on c02 */
	begin 
 
	vl_pago_transacao_w	:= vl_transacao_w;
 
	vl_transacao_w := obter_saldo_titulo_proj_rec(vl_pago_transacao_w, vl_descontos_w, vl_devolucao_w, vl_glosa_w, vl_ir_w, vl_juros_w, vl_multa_w, vl_outras_deducoes_w, vl_outros_acrescimos_w, vl_transacao_w);
 
	select	nextval('projeto_rec_saldo_razao_seq') 
	into STRICT	nr_seq_razao_w 
	;
 
	insert into projeto_rec_saldo_razao( 
		nr_sequencia, 
		dt_atualizacao, 
		nm_usuario, 
		dt_atualizacao_nrec, 
		nm_usuario_nrec, 
		nr_seq_projeto, 
		dt_referencia, 
		nr_documento, 
		vl_movimento, 
		ie_entrada_saida, 
		nr_seq_proj_rec_ref) 
	values (	nr_seq_razao_w, 
		clock_timestamp(), 
		nm_usuario_p, 
		clock_timestamp(), 
		nm_usuario_p, 
		nr_seq_projeto_p, 
		trunc(dt_transacao_w), 
		nr_seq_titulo_w, 
		coalesce(vl_transacao_w,0), 
		'S', 
		nr_seq_proj_rec_ref_w);
		 
	if (ie_considerar_trib_saldo_w = 'S') then 
		 
		nr_titulo_w := nr_seq_titulo_w;
		 
		open C12;
		loop 
		fetch C12 into	 
			cd_tributo_w, 
			ie_soma_diminui_w, 
			vl_tributo_w;
		EXIT WHEN NOT FOUND; /* apply on C12 */
			begin 
			 
			select	nextval('projeto_rec_saldo_razao_seq') 
			into STRICT	nr_seq_razao_w 
			;
			 
			insert into projeto_rec_saldo_razao( 
				nr_sequencia, 
				dt_atualizacao, 
				nm_usuario, 
				dt_atualizacao_nrec, 
				nm_usuario_nrec, 
				nr_seq_projeto, 
				dt_referencia, 
				nr_documento, 
				vl_movimento, 
				ie_entrada_saida, 
				nr_seq_proj_rec_ref) 
			values (	nr_seq_razao_w, 
				clock_timestamp(), 
				nm_usuario_p, 
				clock_timestamp(), 
				nm_usuario_p, 
				nr_seq_projeto_p, 
				trunc(dt_transacao_w), 
				cd_tributo_w, 
				coalesce(vl_tributo_w,0), 
				CASE WHEN ie_soma_diminui_w='S' THEN 'A' WHEN ie_soma_diminui_w='D' THEN 'I' END , 
				nr_seq_proj_rec_ref_w);
			 
			end;
		end loop;
		close C12;
	end if;
 
	end;
end loop;
close c02;
 
open c03;
loop 
fetch c03 into 
	nr_seq_titulo_w, 
	dt_transacao_w, 
	vl_transacao_w, 
	nr_seq_proj_rec_ref_w;
EXIT WHEN NOT FOUND; /* apply on c03 */
	begin 
 
	select	nextval('projeto_rec_saldo_razao_seq') 
	into STRICT	nr_seq_razao_w 
	;
 
	insert into projeto_rec_saldo_razao( 
		nr_sequencia, 
		dt_atualizacao, 
		nm_usuario, 
		dt_atualizacao_nrec, 
		nm_usuario_nrec, 
		nr_seq_projeto, 
		dt_referencia, 
		nr_documento, 
		vl_movimento, 
		ie_entrada_saida, 
		nr_seq_proj_rec_ref) 
	values (	nr_seq_razao_w, 
		clock_timestamp(), 
		nm_usuario_p, 
		clock_timestamp(), 
		nm_usuario_p, 
		nr_seq_projeto_p, 
		trunc(dt_transacao_w), 
		nr_seq_titulo_w, 
		coalesce(vl_transacao_w,0), 
		'E', 
		nr_seq_proj_rec_ref_w);
 
	end;
end loop;
close c03;
 
open c04;
loop 
fetch c04 into 
	cd_conta_financ_w, 
	dt_transacao_w, 
	vl_transacao_w, 
	nr_seq_proj_rec_ref_w;
EXIT WHEN NOT FOUND; /* apply on c04 */
	begin 
 
	select	nextval('projeto_rec_saldo_razao_seq') 
	into STRICT	nr_seq_razao_w 
	;
 
	insert into projeto_rec_saldo_razao( 
		nr_sequencia, 
		dt_atualizacao, 
		nm_usuario, 
		dt_atualizacao_nrec, 
		nm_usuario_nrec, 
		nr_seq_projeto, 
		dt_referencia, 
		nr_documento, 
		vl_movimento, 
		ie_entrada_saida, 
		nr_seq_proj_rec_ref) 
	values (	nr_seq_razao_w, 
		clock_timestamp(), 
		nm_usuario_p, 
		clock_timestamp(), 
		nm_usuario_p, 
		nr_seq_projeto_p, 
		trunc(dt_transacao_w), 
		cd_conta_financ_w, 
		coalesce(vl_transacao_w,0), 
		'C', 
		nr_seq_proj_rec_ref_w);
 
	end;
end loop;
close c04;
 
open c05;
loop 
fetch c05 into 
	cd_conta_financ_w, 
	dt_transacao_w, 
	vl_transacao_w, 
	nr_seq_proj_rec_ref_w;
EXIT WHEN NOT FOUND; /* apply on c05 */
	begin 
 
	select	nextval('projeto_rec_saldo_razao_seq') 
	into STRICT	nr_seq_razao_w 
	;
 
	insert into projeto_rec_saldo_razao( 
		nr_sequencia, 
		dt_atualizacao, 
		nm_usuario, 
		dt_atualizacao_nrec, 
		nm_usuario_nrec, 
		nr_seq_projeto, 
		dt_referencia, 
		nr_documento, 
		vl_movimento, 
		ie_entrada_saida, 
		nr_seq_proj_rec_ref) 
	values (	nr_seq_razao_w, 
		clock_timestamp(), 
		nm_usuario_p, 
		clock_timestamp(), 
		nm_usuario_p, 
		nr_seq_projeto_p, 
		trunc(dt_transacao_w), 
		cd_conta_financ_w, 
		coalesce(vl_transacao_w,0), 
		'D', 
		nr_seq_proj_rec_ref_w);
 
	end;
end loop;
close c05;
 
open C06;
loop 
fetch C06 into	 
	nr_ordem_compra_w, 
	dt_transacao_w, 
	vl_transacao_w, 
	nr_seq_proj_rec_ref_w;
EXIT WHEN NOT FOUND; /* apply on C06 */
	begin 
	 
	select	nextval('projeto_rec_saldo_razao_seq') 
	into STRICT	nr_seq_razao_w 
	;
 
	insert into projeto_rec_saldo_razao( 
		nr_sequencia, 
		dt_atualizacao, 
		nm_usuario, 
		dt_atualizacao_nrec, 
		nm_usuario_nrec, 
		nr_seq_projeto, 
		dt_referencia, 
		nr_documento, 
		vl_movimento, 
		ie_entrada_saida, 
		nr_seq_proj_rec_ref) 
	values (	nr_seq_razao_w, 
		clock_timestamp(), 
		nm_usuario_p, 
		clock_timestamp(), 
		nm_usuario_p, 
		nr_seq_projeto_p, 
		trunc(dt_transacao_w), 
		nr_ordem_compra_w, 
		coalesce(vl_transacao_w,0), 
		'O', 
		nr_seq_proj_rec_ref_w);
	 
	end;
end loop;
close C06;
 
open C07;
loop 
fetch C07 into	 
	nr_titulo_pagar_w, 
	dt_transacao_w, 
	vl_transacao_w, 
	nr_seq_proj_rec_ref_w;
EXIT WHEN NOT FOUND; /* apply on C07 */
	begin 
	 
	select	nextval('projeto_rec_saldo_razao_seq') 
	into STRICT	nr_seq_razao_w 
	;
 
	insert into projeto_rec_saldo_razao( 
		nr_sequencia, 
		dt_atualizacao, 
		nm_usuario, 
		dt_atualizacao_nrec, 
		nm_usuario_nrec, 
		nr_seq_projeto, 
		dt_referencia, 
		nr_documento, 
		vl_movimento, 
		ie_entrada_saida, 
		nr_seq_proj_rec_ref) 
	values (	nr_seq_razao_w, 
		clock_timestamp(), 
		nm_usuario_p, 
		clock_timestamp(), 
		nm_usuario_p, 
		nr_seq_projeto_p, 
		trunc(dt_transacao_w), 
		nr_titulo_pagar_w, 
		coalesce(vl_transacao_w,0), 
		'T', 
		nr_seq_proj_rec_ref_w);
		 
	if (ie_considerar_trib_saldo_w = 'S') then 
		 
		nr_titulo_w := nr_titulo_pagar_w;
	 
		open C12;
		loop 
		fetch C12 into	 
			cd_tributo_w, 
			ie_soma_diminui_w, 
			vl_tributo_w;
		EXIT WHEN NOT FOUND; /* apply on C12 */
			begin 
			 
			select	nextval('projeto_rec_saldo_razao_seq') 
			into STRICT	nr_seq_razao_w 
			;
			 
			insert into projeto_rec_saldo_razao( 
				nr_sequencia, 
				dt_atualizacao, 
				nm_usuario, 
				dt_atualizacao_nrec, 
				nm_usuario_nrec, 
				nr_seq_projeto, 
				dt_referencia, 
				nr_documento, 
				vl_movimento, 
				ie_entrada_saida, 
				nr_seq_proj_rec_ref) 
			values (	nr_seq_razao_w, 
				clock_timestamp(), 
				nm_usuario_p, 
				clock_timestamp(), 
				nm_usuario_p, 
				nr_seq_projeto_p, 
				trunc(dt_transacao_w), 
				cd_tributo_w, 
				coalesce(vl_tributo_w,0), 
				CASE WHEN ie_soma_diminui_w='S' THEN 'F' WHEN ie_soma_diminui_w='D' THEN 'G' END , 
				nr_seq_proj_rec_ref_w);
			 
			end;
		end loop;
		close C12;
	end if;
	 
	end;
end loop;
close C07;
 
open C08;
loop 
fetch C08 into	 
	nr_seq_proj_ref_w, 
	dt_transacao_w, 
	vl_transacao_w, 
	ie_entrada_saida_w, 
	nr_seq_proj_rec_ref_w;
EXIT WHEN NOT FOUND; /* apply on C08 */
	begin 
	 
	select	nextval('projeto_rec_saldo_razao_seq') 
	into STRICT	nr_seq_razao_w 
	;
	 
	/*X - Entrada por transferencia 
	  Y - Saída por transferência*/
 
	   
	if (ie_entrada_saida_w = 'E') then 
		ie_entrada_saida_w := 'X';
	else 
		ie_entrada_saida_w := 'Y';
	end if;
	 
	insert into projeto_rec_saldo_razao( 
		nr_sequencia, 
		dt_atualizacao, 
		nm_usuario, 
		dt_atualizacao_nrec, 
		nm_usuario_nrec, 
		nr_seq_projeto, 
		dt_referencia, 
		nr_documento, 
		vl_movimento, 
		ie_entrada_saida, 
		nr_seq_proj_rec_ref) 
	values (	nr_seq_razao_w, 
		clock_timestamp(), 
		nm_usuario_p, 
		clock_timestamp(), 
		nm_usuario_p, 
		nr_seq_projeto_p, 
		trunc(dt_transacao_w), 
		nr_seq_proj_ref_w, 
		coalesce(vl_transacao_w,0), 
		ie_entrada_saida_w, 
		nr_seq_proj_rec_ref_w);
	 
	end;
end loop;
close C08;
 
open C09;
loop 
fetch C09 into	 
	cd_conta_financ_w, 
	dt_transacao_w, 
	vl_transacao_w, 
	nr_seq_proj_rec_ref_w;
EXIT WHEN NOT FOUND; /* apply on C09 */
	begin 
	 
	select nextval('projeto_rec_saldo_razao_seq') 
	into STRICT nr_seq_razao_w 
	;
	 
	insert into projeto_rec_saldo_razao( 
			nr_sequencia, 
			dt_atualizacao, 
			nm_usuario, 
			dt_atualizacao_nrec, 
			nm_usuario_nrec, 
			nr_seq_projeto, 
			dt_referencia, 
			nr_documento, 
			vl_movimento, 
			ie_entrada_saida, 
			nr_seq_proj_rec_ref) 
		values ( 
			nr_seq_razao_w, 
			clock_timestamp(), 
			nm_usuario_p, 
			clock_timestamp(), 
			nm_usuario_p, 
			nr_seq_projeto_p, 
			trunc(dt_transacao_w), 
			cd_conta_financ_w, 
			coalesce(vl_transacao_w,0), 
			'C', 
			nr_seq_proj_rec_ref_w);
	end;
end loop;
close C09;
 
open C10;
loop 
fetch C10 into	 
	cd_conta_financ_w, 
	dt_transacao_w, 
	vl_transacao_w, 
	nr_seq_proj_rec_ref_w;
EXIT WHEN NOT FOUND; /* apply on C10 */
	begin 
	 
	select nextval('projeto_rec_saldo_razao_seq') 
	into STRICT nr_seq_razao_w 
	;
	 
	insert into projeto_rec_saldo_razao( 
			nr_sequencia, 
			dt_atualizacao, 
			nm_usuario, 
			dt_atualizacao_nrec, 
			nm_usuario_nrec, 
			nr_seq_projeto, 
			dt_referencia, 
			nr_documento, 
			vl_movimento, 
			ie_entrada_saida, 
			nr_seq_proj_rec_ref) 
		values ( 
			nr_seq_razao_w, 
			clock_timestamp(), 
			nm_usuario_p, 
			clock_timestamp(), 
			nm_usuario_p, 
			nr_seq_projeto_p, 
			trunc(dt_transacao_w), 
			cd_conta_financ_w, 
			coalesce(vl_transacao_w,0), 
			'D', 
			nr_seq_proj_rec_ref_w);	
	end;
end loop;
close C10;
 
open c13;
loop 
fetch c13 into	 
	nr_solic_compra_w, 
	dt_transacao_w, 
	vl_transacao_w, 
	nr_seq_proj_rec_ref_w;
EXIT WHEN NOT FOUND; /* apply on c13 */
	begin 
	 
	select	nextval('projeto_rec_saldo_razao_seq') 
	into STRICT	nr_seq_razao_w 
	;
 
	insert into projeto_rec_saldo_razao( 
		nr_sequencia, 
		dt_atualizacao, 
		nm_usuario, 
		dt_atualizacao_nrec, 
		nm_usuario_nrec, 
		nr_seq_projeto, 
		dt_referencia, 
		nr_documento, 
		vl_movimento, 
		ie_entrada_saida, 
		nr_seq_proj_rec_ref) 
	values (	nr_seq_razao_w, 
		clock_timestamp(), 
		nm_usuario_p, 
		clock_timestamp(), 
		nm_usuario_p, 
		nr_seq_projeto_p, 
		trunc(dt_transacao_w), 
		nr_solic_compra_w, 
		coalesce(vl_transacao_w,0), 
		'L', 
		nr_seq_proj_rec_ref_w);
	 
	end;
end loop;
close c13;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE sup_atualizar_saldo_projeto ( nr_sequencia_p bigint, nr_seq_projeto_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) FROM PUBLIC;

