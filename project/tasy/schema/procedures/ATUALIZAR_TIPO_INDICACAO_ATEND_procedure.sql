-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE atualizar_tipo_indicacao_atend (cd_estabelecimento_p text, nr_atendimento_p text, nm_usuario_p text) AS $body$
DECLARE

 
nr_seq_indicacao_w 			bigint;
cd_pessoa_indic_w			varchar(10);
cd_pessoa_juridic_indic_w	varchar(14);
nr_seq_tipo_midia_w			bigint;
ie_tipo_indicacao_w 		varchar(2);


BEGIN 
 
Select max(nr_seq_indicacao), 
		max(cd_pessoa_indic), 
		max(cd_pessoa_juridica_indic), 
		max(nr_seq_tipo_midia), 
		max(obter_tipo_indic_nrseq(nr_seq_indicacao)) 
into STRICT 	nr_seq_indicacao_w, 
		cd_pessoa_indic_w, 
		cd_pessoa_juridic_indic_w, 
		nr_seq_tipo_midia_w, 
		ie_tipo_indicacao_w 
from 	atendimento_paciente 
where 	nr_atendimento = nr_atendimento_p;
 
delete from atendimento_indicacao 
where 	nr_sequencia <> nr_seq_indicacao_w 
and 	nr_atendimento = nr_atendimento_p;
 
if (ie_tipo_indicacao_w = 'P') then 
	update 	atendimento_paciente 
	set 	cd_pessoa_juridica_indic  = NULL, 
			nr_seq_tipo_midia		  = NULL, 
			nm_usuario 				 = nm_usuario_p, 
			dt_atualizacao 			 = clock_timestamp() 
	where 	nr_atendimento = nr_atendimento_p;
	 
elsif (ie_tipo_indicacao_w = 'J') then 
	update 	atendimento_paciente 
	set 	cd_pessoa_indic			  = NULL, 
			nr_seq_tipo_midia		  = NULL, 
			nm_usuario 				 = nm_usuario_p, 
			dt_atualizacao 			 = clock_timestamp() 
	where 	nr_atendimento = nr_atendimento_p;
	 
elsif (ie_tipo_indicacao_w = 'M') then 
	update 	atendimento_paciente 
	set 	cd_pessoa_indic			  = NULL, 
			cd_pessoa_juridica_indic  = NULL, 
			nm_usuario 				 = nm_usuario_p, 
			dt_atualizacao 			 = clock_timestamp() 
	where 	nr_atendimento = nr_atendimento_p;
	 
end if;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE atualizar_tipo_indicacao_atend (cd_estabelecimento_p text, nr_atendimento_p text, nm_usuario_p text) FROM PUBLIC;

