-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE sus_gravar_inconsistencia ( nr_interno_conta_p bigint, cd_inconsistencia_p bigint, ds_detalhe_p text, cd_estabelecimento_p bigint, nm_usuario_p text) AS $body$
DECLARE



nr_seq_inco_w		bigint;
nr_sequencia_w		bigint;
ds_erro_w		varchar(255);
qt_inco_w		bigint := 0;


BEGIN

if (nr_interno_conta_p IS NOT NULL AND nr_interno_conta_p::text <> '') then
	begin

	begin
	select	nr_sequencia
	into STRICT	nr_seq_inco_w
	from	sus_inconsistencia
	where	cd_inconsistencia	= cd_inconsistencia_p;
	exception
	when others then
		nr_seq_inco_w := 0;
	end;

	if (nr_seq_inco_w > 0) then
		begin

		select	count(1)
		into STRICT	qt_inco_w
		from	sus_consistencia_conta
		where	nr_interno_conta	= nr_interno_conta_p
		and	nr_seq_inconsistencia	= nr_seq_inco_w  LIMIT 1;

		if (qt_inco_w = 0) then
			begin

			select	coalesce(max(nr_sequencia),0) + 1
			into STRICT	nr_sequencia_w
			from	sus_consistencia_conta
			where	nr_interno_conta = nr_interno_conta_p;

			begin
			insert into sus_consistencia_conta(nr_interno_conta,
					nr_sequencia,
					cd_estabelecimento,
					nr_seq_inconsistencia,
					ds_detalhe,
					dt_atualizacao,
					nm_usuario,
					dt_atualizacao_nrec,
					nm_usuario_nrec)
				values (	nr_interno_conta_p,
					nr_sequencia_w,
					cd_estabelecimento_p,
					nr_seq_inco_w,
					ds_detalhe_p,
					clock_timestamp(),
					nm_usuario_p,
					clock_timestamp(),
					nm_usuario_p);
			exception
			when others then
				ds_erro_w := substr(sqlerrm(SQLSTATE),1,255);
				CALL wheb_mensagem_pck.exibir_mensagem_abort(228176,'CD_INCONSISTENCIA_P='||cd_inconsistencia_p||';NR_INTERNO_CONTA_P='||nr_interno_conta_p||';DS_ERRO_P='||ds_erro_w);
				/*Não foi possível gravar a inconsistência #@CD_INCONSISTENCIA_P#@ da conta  #@NR_INTERNO_CONTA_P#@. Defeito encontrado: #@DS_ERRO_P#@*/

			end;

			end;
		end if;

		if (coalesce(wheb_usuario_pck.get_ie_commit, 'S') = 'S') then commit; end if;

		end;
	else
		CALL wheb_mensagem_pck.exibir_mensagem_abort(234847,'CD_INCONSISTENCIA_P='||cd_inconsistencia_p||';NR_INTERNO_CONTA_P='||nr_interno_conta_p);
		/*Não foi possível gravar a inconsistência #@CD_INCONSISTENCIA_P#@ da conta  #@NR_INTERNO_CONTA_P#@. Inconsistência não encontrada no cadastro de inconsistências.*/

	end if;

	end;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE sus_gravar_inconsistencia ( nr_interno_conta_p bigint, cd_inconsistencia_p bigint, ds_detalhe_p text, cd_estabelecimento_p bigint, nm_usuario_p text) FROM PUBLIC;

