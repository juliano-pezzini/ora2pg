-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE sup_atualizar_cont_inv_ciclico ( nr_seq_item_inventario_p bigint, qt_contagem_p bigint, ie_contagem_p text, nm_usuario_p text, ds_cons_inv_p INOUT text, ds_cons_item_inv_p INOUT text) AS $body$
DECLARE


ie_contagem_atual_w varchar(15);
ds_contagem_atual_w varchar(50);
ds_contagem_parametro_w varchar(50);
ie_existe_w	varchar(1);
ie_bloqueado_w varchar(1);
ie_aprovado_w varchar(1);
ds_cons_inv_w	varchar(4000) := '';
ds_cons_item_inv_w varchar(4000) := '';
ds_material_w	varchar(255);
cd_material_w	integer;

BEGIN
select 	a.ie_contagem_atual,
	CASE WHEN CASE WHEN ie_contagem_p=1 THEN b.qt_contagem WHEN ie_contagem_p=2 THEN b.qt_recontagem WHEN ie_contagem_p=3 THEN b.qt_seg_recontagem WHEN ie_contagem_p=4 THEN b.qt_terc_recontagem coalesce(END::text, '') = '' THEN 'N'  ELSE 'S' END ,
	CASE WHEN coalesce(a.dt_bloqueio::text, '') = '' THEN 'N'  ELSE 'S' END ,
	CASE WHEN coalesce(a.dt_aprovacao::text, '') = '' THEN 'N'  ELSE 'S' END ,
	substr(obter_valor_dominio(1701,a.ie_contagem_atual),1,50),
	substr(obter_valor_dominio(1701,ie_contagem_p),1,50),
	substr(obter_desc_material(b.cd_material),1,255),
	b.cd_material
into STRICT	ie_contagem_atual_w,
	ie_existe_w,
	ie_bloqueado_w,
	ie_aprovado_w,
	ds_contagem_atual_w,
	ds_contagem_parametro_w,
	ds_material_w,
	cd_material_w
from	inventario a,
	inventario_material b
where	a.nr_sequencia = b.nr_seq_inventario
and	b.nr_sequencia = nr_seq_item_inventario_p;

if ((ie_existe_w = 'N') and (ie_bloqueado_w = 'S') and (ie_aprovado_w = 'N') and (ie_contagem_atual_w = ie_contagem_p)) then
	begin
	if (ie_contagem_atual_w = 1) then
		update 	inventario_material
		set	qt_contagem 	= qt_contagem_p,
			nm_usuario_contagem = nm_usuario_p,
			dt_contagem	= clock_timestamp(),
			nm_usuario  	= nm_usuario_p,
			dt_atualizacao 	= clock_timestamp()
		where	nr_sequencia = nr_seq_item_inventario_p;
	elsif (ie_contagem_atual_w = 2) then
		update 	inventario_material
		set	qt_recontagem 	= qt_contagem_p,
			nm_usuario_recontagem = nm_usuario_recontagem,
			dt_recontagem	= clock_timestamp(),
			nm_usuario  	= nm_usuario_p,
			dt_atualizacao 	= clock_timestamp()
		where	nr_sequencia = nr_seq_item_inventario_p;
	elsif (ie_contagem_atual_w = 3) then
		update 	inventario_material
		set	qt_seg_recontagem = qt_contagem_p,
			nm_usuario_seg_recontagem = nm_usuario_seg_recontagem,
			dt_seg_recontagem	= clock_timestamp(),
			nm_usuario  	= nm_usuario_p,
			dt_atualizacao 	= clock_timestamp()
		where	nr_sequencia = nr_seq_item_inventario_p;
	elsif (ie_contagem_atual_w = 4) then
		update 	inventario_material
		set	qt_terc_recontagem = qt_contagem_p,
			nm_usuario_terc_recontagem = nm_usuario_p,
			dt_terc_recontagem	= clock_timestamp(),
			nm_usuario  	= nm_usuario_p,
			dt_atualizacao 	= clock_timestamp()
		where	nr_sequencia = nr_seq_item_inventario_p;
	end if;
	end;
else
	begin
	if (ie_bloqueado_w = 'N') then
		--ds_cons_inv_w := 'Os itens deste inventário não estão bloqueados para contagem!';
		ds_cons_inv_w := wheb_mensagem_pck.get_texto(314202);
	end if;
	if (ie_aprovado_w = 'S') then
		--ds_cons_inv_w := 'A contagem deste inventário já está encerrada!';
		ds_cons_inv_w := wheb_mensagem_pck.get_texto(314203);
	end if;
	if (ie_contagem_atual_w <> ie_contagem_p) then
		--ds_cons_inv_w := 'No momento o inventário está na ' || ds_contagem_atual_w || ', verifique!';
		ds_cons_inv_w := wheb_mensagem_pck.get_texto(314204, 'DS_CONTAGEM_ATUAL=' || ds_contagem_atual_w);
	end if;
	if (ie_existe_w = 'S') then
		--ds_cons_item_inv_w := 'A contagem do material ['|| cd_material_w || ']('||ds_material_w ||') já está definida!' || chr(13);
		ds_cons_item_inv_w := wheb_mensagem_pck.get_texto(314205, 'CD_MATERIAL=' || cd_material_w || ';'|| 'DS_MATERIAL=' || ds_material_w) || chr(13);
	end if;
	end;
end if;
ds_cons_inv_p := ds_cons_inv_w;
ds_cons_item_inv_p := ds_cons_item_inv_w;
commit;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE sup_atualizar_cont_inv_ciclico ( nr_seq_item_inventario_p bigint, qt_contagem_p bigint, ie_contagem_p text, nm_usuario_p text, ds_cons_inv_p INOUT text, ds_cons_item_inv_p INOUT text) FROM PUBLIC;

