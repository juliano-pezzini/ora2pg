-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE cpoe_insert_dieta_oral ( nr_atendimento_p bigint, nr_prescricao_p bigint, nr_sequencia_p bigint, cd_dieta_p bigint, hr_prim_horario_p text, cd_intervalo_p text, qt_parametro_p bigint, ds_horarios_p text, cd_perfil_p bigint, nm_usuario_p text, dt_atualizacao_p timestamp, ds_observacao_p text, ds_justificativa_p text, ie_urgencia_p text) AS $body$
DECLARE


      
nr_seq_oral_w      prescr_dieta.nr_sequencia%type;
nr_dia_util_w      prescr_dieta.nr_dia_util%type;

ie_via_aplicacao_w    via_aplicacao.ie_via_aplicacao%type;

ds_erro_w          varchar(2000);

BEGIN

select  coalesce(max(nr_sequencia),0) + 1
into STRICT  nr_seq_oral_w
from   prescr_dieta
where  nr_prescricao  = nr_prescricao_p;

select  coalesce(max(a.nr_dia_util),0) + 1
into STRICT  nr_dia_util_w
from    prescr_dieta a,
    prescr_medica b
where   a.nr_prescricao  = b.nr_prescricao
and     trunc(b.dt_prescricao)  = trunc(clock_timestamp() - interval '1 days')
and     b.nr_atendimento  = nr_atendimento_p
and     a.cd_dieta    = cd_dieta_p
and     b.nr_prescricao  <> nr_prescricao_p
and     coalesce(b.dt_suspensao::text, '') = ''
and     coalesce(a.dt_suspensao::text, '') = '';

select  coalesce(max(ie_via_aplicacao),'VO')
into STRICT  ie_via_aplicacao_w
from  dieta
where  cd_dieta  = cd_dieta_p;

insert into prescr_dieta(
    nr_prescricao,
    nr_sequencia, 
    cd_dieta, 
    dt_atualizacao, 
    nm_usuario,
    qt_parametro, 
    ds_horarios, 
    cd_intervalo, 
    hr_prim_horario,
    nr_dia_util,
    ie_via_aplicacao,
    ie_suspenso,
    ie_urgencia,
    ie_dose_espec_agora,
    ie_horario_susp,
    ie_destino_dieta,
    ie_refeicao,
    ie_erro,
    cd_perfil_ativo,
    ds_observacao,
    ds_justificativa,
    nr_seq_dieta_cpoe
  ) values (
    nr_prescricao_p,
    nr_seq_oral_w,
    cd_dieta_p,
    dt_atualizacao_p,
    nm_usuario_p,
    qt_parametro_p,
    ds_horarios_p,
    cd_intervalo_p,
    hr_prim_horario_p,
    nr_dia_util_w,
    ie_via_aplicacao_w,
    'N',
    CASE WHEN coalesce(ie_urgencia_p::text, '') = '' THEN 'N'  ELSE 'S' END ,

    'N',
    'N',
    'P',
    'T',
    0,
    cd_perfil_p,
     substr(ds_observacao_p, 1, 2000),
     substr(ds_justificativa_p, 1, 2000),
    nr_sequencia_p
  );

commit;

CALL Gerar_suplementos_dieta( nr_prescricao_p, nr_seq_oral_w, nm_usuario_p, cd_perfil_p );

exception when others then
	CALL gravar_log_cpoe(substr('CPOE_INSERT_DIETA_ORAL EXCEPTION:'|| substr(to_char(sqlerrm),1,2000)
		||'nr_sequencia_p: '||nr_sequencia_p||' nr_prescricao_p :'||nr_prescricao_p||'nr_atendimento_p: '||nr_atendimento_p
		||'cd_dieta_p'||cd_dieta_p||'hr_prim_horario_p:'|| hr_prim_horario_p||'cd_intervalo_p:'||cd_intervalo_p
		||'qt_parametro_p:'||qt_parametro_p||'ds_horarios_p:'||ds_horarios_p||'cd_perfil_p :'|| cd_perfil_p
		||'nm_usuario_p:'|| nm_usuario_p||'dt_atualizacao_p:'|| dt_atualizacao_p||'ds_observacao_p:'||ds_observacao_p
		||'ds_justificativa_p:'||ds_justificativa_p,1,2000),
		nr_atendimento_p, 'N', nr_sequencia_p);
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cpoe_insert_dieta_oral ( nr_atendimento_p bigint, nr_prescricao_p bigint, nr_sequencia_p bigint, cd_dieta_p bigint, hr_prim_horario_p text, cd_intervalo_p text, qt_parametro_p bigint, ds_horarios_p text, cd_perfil_p bigint, nm_usuario_p text, dt_atualizacao_p timestamp, ds_observacao_p text, ds_justificativa_p text, ie_urgencia_p text) FROM PUBLIC;

