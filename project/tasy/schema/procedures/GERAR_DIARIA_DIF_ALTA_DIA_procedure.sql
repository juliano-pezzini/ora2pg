-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_diaria_dif_alta_dia ( dt_entrada_p timestamp, dt_alta_p timestamp, nr_atendimento_p bigint, nm_usuario_p text) AS $body$
DECLARE


qt_horas_int_w			bigint;
cd_convenio_w			integer;
cd_tipo_acomod_conv_w		smallint;
cd_estabelecimento_w		integer;
nr_seq_atepacu_w		bigint;
cd_setor_atendimento_w		bigint;
cd_tipo_acomod_unid_w		smallint;
cd_classif_setor_w		bigint;
cd_nivel_convenio_w		bigint;
cd_tipo_acomodacao_w		smallint;
cd_nivel_setor_w		bigint;
cd_procedimento_w		bigint:= 0;
ie_origem_proced_w		bigint;
cd_categoria_w			varchar(10);
ie_paciente_isolado_w		varchar(1);
ie_clinica_w			integer;
ie_carater_internacao_w		varchar(02);
nr_seq_classificacao_w		bigint;
ie_gerar_primeiro_dia_w		varchar(1):= 'S';
qt_dia_int_w			bigint;
nr_doc_convenio_w       	varchar(20) := '';
dt_entrada_unidade_w		timestamp;
ie_diaria_dif_primeiro_dia_w	varchar(1):= 'N';
cd_plano_w			varchar(10);
cd_pessoa_fisica_w		varchar(10);
qt_idade_w			double precision;
nr_acompanhante_w		smallint;
nr_seq_proc_interno_w		bigint;
ie_sexo_w			varchar(1);
cd_motivo_exclusao_w		parametro_faturamento.cd_motivo_exc_conta%type;
nr_sequencia_w			procedimento_paciente.nr_seq_proc_princ%type;
ds_expressao_diaria_w		varchar(255);
ie_excluir_diaria_job_w		tipo_acomod_alta_dia.ie_excluir_diaria_job%type;

C01 CURSOR FOR
	SELECT	cd_procedimento,
		ie_origem_proced,
		nr_seq_proc_interno,
		coalesce(ie_excluir_diaria_job,'N')
	from	tipo_acomod_alta_dia
	where	coalesce(cd_convenio, coalesce(cd_convenio_w,0)) = coalesce(cd_convenio_w,0)
	and 	qt_horas_int_w between qt_hora_inicial and qt_hora_final
	and 	coalesce(ie_situacao,'A') = 'A'
	and 	cd_tipo_acomodacao = cd_tipo_acomodacao_w
	and 	((ie_gerar_primeiro_dia_w = 'N') or (ie_diaria_dif_primeiro_dia_w = 'P' AND ie_gerar_primeiro_dia_w = 'S'))
	order by coalesce(cd_convenio,0);
	
c02 CURSOR FOR
	SELECT	coalesce(ie_gerar_primeiro_dia,'S')
	from	tipo_acomod_convenio
	where	cd_tipo_acomodacao	= cd_tipo_acomodacao_w
	and	((coalesce(cd_convenio::text, '') = '') or (cd_convenio	= cd_convenio_w))
	and	((coalesce(cd_categoria::text, '') = '') or (cd_categoria	= cd_categoria_w))
	and	coalesce(cd_plano, coalesce(cd_plano_w,'0')) = coalesce(cd_plano_w,'0')
	and	coalesce(ie_clinica, coalesce(ie_clinica_w, 0)) = coalesce(ie_clinica_w, 0)
	and	qt_dia_int_w between qt_dia_inicio and qt_dia_fim
	and	((coalesce(cd_setor_atendimento::text, '') = '') or (cd_setor_atendimento = cd_setor_atendimento_w))
	and	((coalesce(ie_carater_internacao::text, '') = '') or (ie_carater_internacao = ie_carater_internacao_w))
	and	((coalesce(nr_seq_classificacao::text, '') = '') or (nr_seq_classificacao = nr_seq_classificacao_w))
	and	((coalesce(ie_paciente_isolado,'A') = 'A') or (coalesce(ie_paciente_isolado,'A') = ie_paciente_isolado_w))
	and	coalesce(qt_idade_w,0) between coalesce(obter_idade_lancto_auto(nr_sequencia,'MIN'),0) and coalesce(obter_idade_lancto_auto(nr_sequencia,'MAX'),9999999)
	and	coalesce(nr_acompanhante_w, 0) between coalesce(nr_acomp_inicial,0) and coalesce(nr_acomp_final, coalesce(nr_acompanhante_w, 0))
	and	coalesce(ie_sexo, coalesce(ie_sexo_w, 'I')) = coalesce(ie_sexo_w, 'I');
	
c03 CURSOR FOR
	SELECT	nr_sequencia
	from    procedimento_paciente a,
		conta_paciente b
	where	a.nr_interno_conta = b.nr_interno_conta
	and	a.nr_atendimento = nr_atendimento_p
	and	b.ie_status_acerto = 1
	and	a.ds_observacao like '%'||ds_expressao_diaria_w||'%';
	

BEGIN

qt_horas_int_w:= trunc((dt_alta_p - dt_entrada_p) * 1440 / 60);

qt_dia_int_w := ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_alta_p) - ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_entrada_p);

ds_expressao_diaria_w 	:= substr(wheb_mensagem_pck.get_texto(300033),1,255);

if (qt_dia_int_w < 1) then
	qt_dia_int_w := 1;
end if;

select 	coalesce(max(cd_estabelecimento),1),
	max(cd_pessoa_fisica)
into STRICT	cd_estabelecimento_w,
	cd_pessoa_fisica_w
from 	atendimento_paciente
where 	nr_atendimento = nr_atendimento_p;

select	max(ie_sexo)
into STRICT	ie_sexo_w
from	pessoa_fisica
where	cd_pessoa_fisica = cd_pessoa_fisica_w;

select	max(cd_motivo_exc_conta)
into STRICT	cd_motivo_exclusao_w
from	parametro_faturamento
where	cd_estabelecimento	= cd_estabelecimento_w;

ie_diaria_dif_primeiro_dia_w := obter_valor_param_usuario(3111,80,obter_perfil_ativo,nm_usuario_p,cd_estabelecimento_w);

--Acomodacao Convenio
select 	Obter_Dados_Categ_Conv(nr_atendimento_p, 'A'),
	Obter_Dados_Categ_Conv(nr_atendimento_p, 'CA'),
	Obter_Dados_Categ_Conv(nr_atendimento_p, 'G'),
	Obter_Dados_Categ_Conv(nr_atendimento_p, 'P'),
	Obter_Dados_Categ_Conv(nr_atendimento_p, 'NAC')
into STRICT	cd_tipo_acomod_conv_w,
	cd_categoria_w,
	nr_doc_convenio_w,
	cd_plano_w,
	nr_acompanhante_w
;

--Acomodacao Atual
select 	Obter_Atepacu_paciente(nr_atendimento_p, 'IA')
into STRICT	nr_seq_atepacu_w
;

select 	obter_convenio_atendimento(nr_atendimento_p)
into STRICT	cd_convenio_w
;

select	coalesce(max(ie_clinica),0),
	coalesce(max(IE_CARATER_INTER_SUS),'0'),
	coalesce(max(nr_seq_classificacao),0),
	coalesce(max(ie_paciente_isolado),'A'),
	max(cd_pessoa_fisica)
into STRICT	ie_clinica_w,
	ie_carater_internacao_w,
	nr_seq_classificacao_w,
	ie_paciente_isolado_w,
	cd_pessoa_fisica_w
from	atendimento_paciente
where	nr_atendimento	= nr_atendimento_p;

if (cd_pessoa_fisica_w IS NOT NULL AND cd_pessoa_fisica_w::text <> '') then
	select	coalesce(max(obter_idade(b.dt_nascimento,coalesce(b.dt_obito,clock_timestamp()),'DIA')),0)
	into STRICT	qt_idade_w
	from	pessoa_fisica b
	where	b.cd_pessoa_fisica = cd_pessoa_fisica_w;
end if;

select 	max(cd_tipo_acomodacao),
	max(cd_setor_atendimento),
	max(dt_entrada_unidade)
into STRICT	cd_tipo_acomod_unid_w,
	cd_setor_atendimento_w,
	dt_entrada_unidade_w
from 	atend_paciente_unidade
where 	nr_atendimento = nr_atendimento_p
and 	nr_seq_interno = nr_seq_atepacu_w;

if	coalesce(cd_tipo_acomod_unid_w,0) > 0 then

	select	max(cd_classif_setor)
	into STRICT	cd_classif_setor_w
	from 	setor_atendimento
	where 	cd_setor_atendimento = cd_setor_atendimento_w;
	
end if;

------- Caso o Setor do Paciente e UTI utiliza este senao do Convenio

------- Caso seja igual Utilizar o do convenio senao o de nivel mais baixo
if (cd_classif_setor_w = '4') then
	cd_tipo_acomodacao_w		:= cd_tipo_acomod_unid_w;
elsif (cd_tipo_acomod_unid_w = cd_tipo_acomod_conv_w) then
	cd_tipo_acomodacao_w		:= cd_tipo_acomod_conv_w;
else
	begin
	begin
	select 	coalesce(cd_nivel_acomodacao, 0)
	into STRICT 	cd_nivel_convenio_w
	from 	tipo_acomodacao
	where 	cd_tipo_acomodacao = cd_tipo_acomod_conv_w;
	exception
		when others then
			cd_nivel_convenio_w := 0;
	end;
	begin
	select 	coalesce(cd_nivel_acomodacao, 0)
	into STRICT 	cd_nivel_setor_w
	from 	tipo_acomodacao
	where 	cd_tipo_acomodacao = cd_tipo_acomod_unid_w;
	exception
		when others then
			cd_nivel_setor_w	:= 0;
	end;
	if (cd_nivel_setor_w < cd_nivel_convenio_w) then
		cd_tipo_acomodacao_w		:= cd_tipo_acomod_unid_w;
	else
		cd_tipo_acomodacao_w		:= cd_tipo_acomod_conv_w;
	end if;
	end;
end if;

ie_gerar_primeiro_dia_w:= 'S';

open C02;
loop
fetch C02 into	
	ie_gerar_primeiro_dia_w;
EXIT WHEN NOT FOUND; /* apply on C02 */
	begin
	ie_gerar_primeiro_dia_w:= ie_gerar_primeiro_dia_w;
	end;
end loop;
close C02;


--Gerar a diaria diferenciada
open C01;
loop
fetch C01 into	
	cd_procedimento_w,
	ie_origem_proced_w,
	nr_seq_proc_interno_w,
	ie_excluir_diaria_job_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	cd_procedimento_w	:= cd_procedimento_w;
	ie_origem_proced_w	:= ie_origem_proced_w;
	nr_seq_proc_interno_w 	:= nr_seq_proc_interno_w;
	end;
end loop;
close C01;

if (coalesce(cd_procedimento_w,0) > 0) then
	nr_seq_proc_interno_w	:= null;
elsif (coalesce(cd_procedimento_w,0) = 0) and (coalesce(nr_seq_proc_interno_w,0) > 0) then
	SELECT * FROM Obter_Proc_Tab_Interno_Conv(nr_seq_proc_interno_w, cd_estabelecimento_w, cd_convenio_w, cd_categoria_w, cd_plano_w, cd_setor_atendimento_w, cd_procedimento_w, ie_origem_proced_w, null, dt_alta_p, cd_tipo_acomodacao_w, null, null, null, null, null, null, null) INTO STRICT cd_procedimento_w, ie_origem_proced_w;
end if;
	
if (coalesce(cd_procedimento_w,0) <> 0) then
	if (ie_excluir_diaria_job_w = 'S') then
		open	c03;
		loop
		fetch	c03 into
			nr_sequencia_w;
		EXIT WHEN NOT FOUND; /* apply on c03 */
			begin
				if (coalesce(nr_sequencia_w,0) > 0) then
					update	procedimento_paciente	a
					set	a.cd_motivo_exc_conta	= cd_motivo_exclusao_w,
						a.nr_interno_conta	 = NULL
					where	a.nr_sequencia		= nr_sequencia_w;
				end if;
			end;
		end loop;
		close c03;
	end if;
	
	CALL Gravar_Diaria(nr_atendimento_p,
		dt_entrada_unidade_w,
		cd_procedimento_w,
		ie_origem_proced_w,
		dt_alta_p,
		cd_convenio_w,
		cd_categoria_w,
		nr_doc_convenio_w,
		null,
		null,
		NM_USUARIO_P,
		cd_setor_atendimento_w,
		0,
		1,
		wheb_mensagem_pck.get_Texto(312253), /*'Regra Especial - Alta ate 1 dia de Internacao',*/
		nr_seq_proc_interno_w);

end if;

if (coalesce(wheb_usuario_pck.get_ie_commit, 'S') = 'S') then commit; end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_diaria_dif_alta_dia ( dt_entrada_p timestamp, dt_alta_p timestamp, nr_atendimento_p bigint, nm_usuario_p text) FROM PUBLIC;

