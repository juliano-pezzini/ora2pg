-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE ajustar_data_item ( nr_interno_conta_p bigint, nm_usuario_p text, ds_msg_p INOUT text) AS $body$
DECLARE

 
dt_periodo_final_w	timestamp;
nr_sequencia_w		bigint;
ie_proc_mat_w		smallint;/* 1 = Procedimento  2 = Material */
ds_msg_w		varchar(255):= ' ';
dt_conta_w		timestamp;
ds_erro_w		varchar(4000);

C01 CURSOR FOR 
	SELECT 	nr_sequencia, 
		ie_proc_mat 
	from 	conta_paciente_v 
    where 	dt_conta > dt_periodo_final_w 
    and	nr_interno_conta = nr_interno_conta_p 
    and	coalesce(cd_motivo_exc_conta::text, '') = '' 
    and 	coalesce(nr_seq_proc_pacote::text, '') = '';
			

BEGIN 
 
select 	max(dt_periodo_final) 
into STRICT	dt_periodo_final_w 
from 	conta_paciente 
where 	nr_interno_conta = nr_interno_conta_p;
 
open C01;
loop 
fetch C01 into	 
	nr_sequencia_w, 
	ie_proc_mat_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin 
	ds_erro_w := Ajustar_Data_Atend_ProcMat(nr_sequencia_w, ie_proc_mat_w + 1, dt_periodo_final_w, 0, nm_usuario_p, null, ds_erro_w);
	 
	select	max(dt_conta) 
	into STRICT	dt_conta_w 
	from 	conta_paciente_v 
	where 	nr_sequencia = nr_sequencia_w;
 
	if (dt_conta_w > dt_periodo_final_w) then 
		ds_msg_w := wheb_mensagem_pck.get_texto(300696);
		/*ds_msg_w:= 'Alguns Mat/Proc não foram alterados pois foram lançados em um setor ' || chr(10) || 
			  'cuja data de entrada na Unidade é maior do que a nova data (Período Final da conta) !';*/
 
	end if;
 
	end;
end loop;
close C01;
 
commit;
 
if (ds_msg_w = ' ') then 
	--ds_msg_w:= 'Alteração realizada com sucesso !'; 
	ds_msg_w := wheb_mensagem_pck.get_texto(300698);	
end if;
 
ds_msg_p:= ds_msg_w;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ajustar_data_item ( nr_interno_conta_p bigint, nm_usuario_p text, ds_msg_p INOUT text) FROM PUBLIC;

