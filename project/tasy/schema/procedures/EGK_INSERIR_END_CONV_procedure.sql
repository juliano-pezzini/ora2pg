-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE egk_inserir_end_conv ( nm_municipio_p text, cd_cep_p bigint, nm_rua_p text, nr_casa_p bigint, cd_pessoa_fisica_p bigint, cd_convenio_p bigint, nm_usuario_p text) AS $body$
DECLARE



nr_cep_w  	bigint;
cd_convenio_w	bigint;
ds_convenio_w	varchar(15);
nr_seq_compl_w	compl_pessoa_fisica.nr_sequencia%type;
nr_seq_pessoa_conv_w  bigint;
nr_seq_compl_endereco_w 	bigint;


BEGIN

/*  Rotina para inserir o endereço  */

select 	max(nr_sequencia)
into STRICT 	nr_cep_w
from  	cep_loc
where 	cd_cep = cd_cep_p;

--if(nr_cep_w > 0) then /*Se não tiver endereço cadastrado no sistema, então NÃO cadastra o endereço do paciente,*/
	/*	select	max(nr_sequencia)
		into	nr_seq_compl_endereco_w
		from	compl_pessoa_fisica
		where	cd_pessoa_fisica = cd_pessoa_fisica_p;*/
		--if(nvl(nr_seq_compl_endereco_w,0) = 0) then  /*Se o paciente já ter  endereço cadastrado, então NÃO vai inserir,*/
					select	coalesce(max(nr_sequencia),0) + 1
					into STRICT	nr_seq_compl_w
					from	compl_pessoa_fisica
					where	cd_pessoa_fisica	= cd_pessoa_fisica_p;

		insert into compl_pessoa_fisica(nr_sequencia,
						cd_pessoa_fisica,
						ie_tipo_complemento,
						cd_cep,
						dt_atualizacao,
						ds_endereco,
						ds_municipio,
						nr_endereco,
						nm_usuario,
						nm_usuario_nrec,
						dt_atualizacao_nrec)
				values (	nr_seq_compl_w,
						cd_pessoa_fisica_p,
						'1',
						cd_cep_p,
						clock_timestamp(),
						nm_rua_p,
						nm_municipio_p,
						nr_casa_p,
						nm_usuario_p,
						nm_usuario_p,
						clock_timestamp()
					);
		--end if;
--end if;
commit;

/*  Rotina para inserir o convenio */

select	max(cd_convenio)
into STRICT 	cd_convenio_w
from 	convenio
where 	ie_situacao = 'A'
and	  	cd_convenio = cd_convenio_p;

--if(cd_convenio_w != null) then /*Se o convenio existir, então insere o convenio para o paciente*/
	/*select	max(nr_sequencia)
	into	nr_seq_pessoa_conv_w
	from	pessoa_titular_convenio
	where	cd_convenio = cd_convenio_p
	and		cd_pessoa_fisica = cd_pessoa_fisica_p;*/
	--if(nr_seq_pessoa_conv_w = null) then /*Se ainda nao existe um convenio para este paciente, então vamos inserir*/
		insert into pessoa_titular_convenio( 	nr_sequencia,
					cd_convenio,
					cd_pessoa_fisica,
					dt_atualizacao,
					nm_usuario)
			values (	nextval('pessoa_titular_convenio_seq'),
					cd_convenio_w,
					cd_pessoa_fisica_p,
					clock_timestamp(),
					nm_usuario_p);
	--end if;
--end if;
commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE egk_inserir_end_conv ( nm_municipio_p text, cd_cep_p bigint, nm_rua_p text, nr_casa_p bigint, cd_pessoa_fisica_p bigint, cd_convenio_p bigint, nm_usuario_p text) FROM PUBLIC;

