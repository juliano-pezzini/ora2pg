-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE ctb_gerar_interf_i050_ecd ( nr_seq_controle_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint, dt_inicio_p timestamp, dt_fim_p timestamp, cd_empresa_p bigint, qt_linha_p INOUT bigint, nr_sequencia_p INOUT bigint) AS $body$
DECLARE


ds_arquivo_w					varchar(4000);
ds_compl_arquivo_w				varchar(4000);
ds_linha_w					varchar(8000);
ds_identificador_w				varchar(5);
cd_aglutinacao_w				varchar(40);
cd_centro_custo_w				bigint;
cd_conta_contabil_w				varchar(40);
cd_conta_contabil_ww				varchar(20);
cd_conta_sup_w					varchar(40);
nr_linha_w					bigint	:= qt_linha_p;
nr_seq_registro_w				bigint	:= nr_sequencia_p;
cd_empresa_resp_w				integer;
sep_w						varchar(1)	:= '|';
tp_registro_w					varchar(15);
ie_apres_conta_ctb_w				varchar(02);
ie_gerar_I051_w					varchar(01);
ie_gerar_I052_w					varchar(01);
ie_gerar_I053_w					varchar(01);
nr_seq_demo_bp_w				bigint;
nr_seq_demo_dre_w				bigint;
cd_versao_w					ctb_regra_sped.cd_versao%type;
dt_geracao_w					timestamp;
nr_nivel_w					numeric(20);
nr_vetor_w					bigint	:= 0;
type registro is table of ctb_sped_registro%rowtype index by integer;
ctb_sped_registro_w				registro;
nr_seq_dmpl_w					ctb_dmpl.nr_sequencia%type;
ie_consolida_empresa_w				ctb_regra_sped.ie_consolida_empresa%type;
ie_centro_custo_w				conta_contabil.ie_centro_custo%type;

c_plano_contas CURSOR FOR
	SELECT	a.cd_grupo_ecd,
		a.ie_tipo_ecd,
		a.cd_conta_contabil,
		a.ds_conta_contabil,
		substr(ctb_obter_classif_conta(a.cd_conta_contabil, a.cd_classificacao, dt_fim_p),1,40) cd_classificacao,
		a.cd_classificacao cd_classif,
		a.cd_empresa
	from	ecd_plano_conta_v	a
	where	a.tp_registro	= 1
	and	a.cd_empresa	= cd_empresa_p
	/* and	(substr(obter_se_conta_vigente2(a.cd_conta_contabil, a.dt_inicio_vigencia, a.dt_fim_vigencia,dt_fim_p),1,1) = 'S')  */

	and	substr(obter_se_vigencia_periodo(a.dt_inicio_vigencia, a.dt_fim_vigencia,dt_inicio_p,dt_fim_p,'S'),1,1) = 'S'
	and	exists (
			SELECT	1
			from	ctb_saldo x
			where	x.cd_conta_contabil = a.cd_conta_contabil
			and	((a.ie_tipo_ecd = 'S') or (x.vl_credito <> 0 or x.vl_debito <> 0 or x.vl_saldo <> 0))
			and	x.nr_seq_mes_ref in (
						select	z.nr_sequencia
						from	ctb_mes_ref z
						where	z.cd_empresa = cd_empresa_p
						and	z.dt_referencia between pkg_date_utils.start_of(dt_inicio_p,'yyyy') and pkg_date_utils.end_of(dt_inicio_p, 'YEAR',0))
			and (ie_consolida_empresa_w = 'S' or x.cd_estabelecimento = cd_estabelecimento_p)
			 LIMIT 1)
	order by
		a.cd_classificacao;

vet01	c_plano_contas%RowType;

c_plano_contas_ref CURSOR FOR
	SELECT	CASE WHEN a.ie_centro_custo='S' THEN  b.cd_centro_custo  ELSE null END  cd_centro_custo,
		a.cd_classif_ecd cd_classif_ecd,
		a.cd_classificacao
	from	ctb_saldo b,
		ecd_plano_conta_v a
	where	a.cd_conta_contabil = b.cd_conta_contabil
	and	a.tp_registro		= 2
	and	a.cd_empresa		= cd_empresa_p
	and	a.cd_conta_contabil	= cd_conta_contabil_w
	and	coalesce(a.cd_versao,'0.0')	= CASE WHEN cd_versao_w='3.0' THEN '3.1' WHEN cd_versao_w='4.0' THEN '3.1' WHEN cd_versao_w='5.0' THEN '3.1' WHEN cd_versao_w='6.0' THEN '3.1' WHEN cd_versao_w='7.0' THEN '3.1' WHEN cd_versao_w='8.0' THEN '3.1' WHEN cd_versao_w='9.0' THEN '3.1'  ELSE '0.0' END
	and	(a.cd_classif_ecd IS NOT NULL AND a.cd_classif_ecd::text <> '')
	and	ie_gerar_I051_w		= 'S'
	and	substr(obter_se_periodo_vigente(a.dt_inicio_validade, a.dt_fim_validade, dt_inicio_p),1,1) = 'S'
	and (b.vl_credito <> 0 or b.vl_debito <> 0 or b.vl_saldo <> 0)
	and	b.nr_seq_mes_ref in (
				SELECT	z.nr_sequencia
				from	ctb_mes_ref z
				where	z.cd_empresa = cd_empresa_p
				and	z.dt_referencia between pkg_date_utils.start_of(dt_inicio_p,'yyyy') and pkg_date_utils.end_of(dt_inicio_p, 'YEAR',0))
	and (ie_consolida_empresa_w = 'S' or b.cd_estabelecimento = cd_estabelecimento_p)
	group by
		CASE WHEN a.ie_centro_custo='S' THEN  b.cd_centro_custo  ELSE null END ,
		a.cd_classif_ecd,
		a.cd_classificacao
	order by a.cd_classificacao;

vet02	c_plano_contas_ref%RowType;

c_ind_cod_aglut_cta CURSOR FOR
	SELECT	a.cd_centro_custo,
		a.cd_conta_contabil,
		a.cd_classificacao
	from	conta_contabil a
	where	coalesce(a.ie_ecd_reg_bp,'N') = 'S'
	and	a.cd_conta_contabil 	= cd_conta_contabil_w
	and	a.ie_tipo		= 'A'
	and	nr_seq_demo_bp_w 	= 0
	and	ie_gerar_I052_w		= 'S'
	
union

	SELECT	a.cd_centro_custo,
		a.cd_conta_contabil,
		a.cd_classificacao
	from	conta_contabil a
	where	coalesce(a.ie_ecd_reg_dre,'N') = 'S'
	and	a.cd_conta_contabil	= cd_conta_contabil_w
	and	a.ie_tipo		= 'A'
	and	nr_seq_demo_dre_w	= 0
	and	ie_gerar_I052_w		= 'S'
	order by cd_classificacao;

vet03	c_ind_cod_aglut_cta%RowType;

c_ind_cod_aglut_demo CURSOR FOR
	SELECT	a.nr_seq_rubrica cd_aglutinacao
	from	ctb_demonstrativo e,
		conta_contabil d,
		ctb_modelo_relat		c,
		ctb_modelo_rubrica		b,
		ctb_modelo_rubrica_conta	a
	where	a.nr_seq_rubrica	= b.nr_sequencia
	and	b.nr_seq_modelo		= c.nr_sequencia
	and	a.cd_conta_contabil	= d.cd_conta_contabil
	and	c.nr_sequencia		= e.nr_seq_tipo
	and	e.nr_sequencia in (nr_seq_demo_bp_w, nr_seq_demo_dre_w)
	and	((coalesce(d.ie_ecd_reg_bp,'N') = 'S') or (coalesce(d.ie_ecd_reg_dre,'N') = 'S'))
	and	d.ie_tipo		= 'A'
	and	ie_gerar_I052_w		= 'S'
	and coalesce(b.ie_total,'N')	= 'N'
	and	a.cd_conta_contabil	= cd_conta_contabil_ww;

vet04	c_ind_cod_aglut_demo%RowType;

c_demonstrativo CURSOR FOR
	SELECT	b.nr_sequencia,
		b.ds_origem,
		b.ie_origem_valor,
		c.cd_registro_sped,
		c.nr_sequencia nr_seq_modelo_relat
	from	ctb_demonstrativo	e,
		ctb_modelo_relat	c,
		ctb_modelo_rubrica	b
	where	c.nr_sequencia	= b.nr_seq_modelo
	and	c.nr_sequencia	= e.nr_seq_tipo
	and	e.nr_sequencia in (nr_seq_demo_bp_w, nr_seq_demo_dre_w)
	and	ie_gerar_I052_w 	= 'S'
	order by coalesce(b.nr_seq_somat,0), nr_seq_apres desc;

vet05	c_demonstrativo%Rowtype;

c_ind_cod_aglut_dmpl CURSOR FOR
	SELECT cd_aglutinacao_sped
	from 	ctb_dmpl_coluna_conta a,
				ctb_dmpl_coluna b
	where a.nr_seq_col_dmpl 	 = b.nr_sequencia
	and		ie_gerar_I052_w		 = 'S'
	and		b.nr_seq_dmpl = nr_seq_dmpl_w
	and 	a.cd_conta_contabil = cd_conta_contabil_ww;

vet06	c_ind_cod_aglut_dmpl%Rowtype;

c_centro_custo_saldo CURSOR FOR
	SELECT	b.cd_centro_custo
	from	ctb_modelo_rubrica_centro_v c,
		ctb_saldo b,
		ecd_plano_conta_v a
	where	a.cd_conta_contabil = b.cd_conta_contabil
	and	a.tp_registro		= 2
	and	a.cd_empresa		= cd_empresa_p
	and	a.cd_conta_contabil	= cd_conta_contabil_ww
	and	c.cd_centro_custo	= b.cd_centro_custo
	and	c.cd_conta_contabil	= a.cd_conta_contabil
	and	c.nr_seq_rubrica	= cd_aglutinacao_w
	and	ie_centro_custo_w	= 'S'
	and	(b.cd_centro_custo IS NOT NULL AND b.cd_centro_custo::text <> '')
	and	ie_gerar_I052_w		= 'S'
	and	substr(obter_se_periodo_vigente(a.dt_inicio_validade, a.dt_fim_validade, dt_inicio_p),1,1) = 'S'
	and (b.vl_credito <> 0 or b.vl_debito <> 0 or b.vl_saldo <> 0)
	and	b.nr_seq_mes_ref in (
				SELECT	z.nr_sequencia
				from	ctb_mes_ref z
				where	z.cd_empresa = cd_empresa_p
				and	z.dt_referencia between pkg_date_utils.start_of(dt_inicio_p,'yyyy') and pkg_date_utils.end_of(dt_inicio_p, 'YEAR',0))
	and (ie_consolida_empresa_w = 'S' or b.cd_estabelecimento = cd_estabelecimento_p)
	group by b.cd_centro_custo;
	
vet07	c_centro_custo_saldo%Rowtype;


BEGIN

select	coalesce(max(a.cd_empresa_resp),0),
	coalesce(max(a.ie_apres_conta_ctb),'CD'),
	coalesce(max(b.nr_seq_demo_bp),0),
	coalesce(max(b.nr_seq_demo_dre),0),
	coalesce(max(b.nr_seq_dmpl),0),
	max(a.cd_versao),
	max(b.dt_geracao),
	max(a.ie_consolida_empresa)
into STRICT	cd_empresa_resp_w,
	ie_apres_conta_ctb_w,
	nr_seq_demo_bp_w,
	nr_seq_demo_dre_w,
	nr_seq_dmpl_w,
	cd_versao_w,
	dt_geracao_w,
	ie_consolida_empresa_w
from	ctb_regra_sped a,
	ctb_sped_controle b
where	b.nr_seq_regra_sped 	= a.nr_sequencia
and	b.nr_sequencia		= nr_seq_controle_p;

/*
Essas duas functions devem ser chamadas no loop. Os parametros CD_CLASSIFICACAO devem receber o conteudo de c01.cd_classificacao


substr(ctb_obter_classif_conta_sup(a.cd_classificacao, dt_inicio_p, a.cd_empresa),1,40)*/
/*ctb_obter_nivel_classif_conta(substr(ctb_obter_classif_conta(a.cd_conta_contabil, a.cd_classificacao, dt_inicio_p),1,40))*/

select	coalesce(max(ie_gerar),'N')
into STRICT	ie_gerar_I051_w
from	ctb_regra_sped_registro a,
	ctb_sped_controle	b
where	a.nr_seq_regra_sped	= b.nr_seq_regra_sped
and	b.nr_sequencia		= nr_seq_controle_p
and	a.cd_registro		= 'I051';

select	coalesce(max(ie_gerar),'N')
into STRICT	ie_gerar_I052_w
from	ctb_regra_sped_registro a,
	ctb_sped_controle	b
where	a.nr_seq_regra_sped	= b.nr_seq_regra_sped
and	b.nr_sequencia		= nr_seq_controle_p
and	a.cd_registro		= 'I052';

select	coalesce(max(ie_gerar),'N')
into STRICT	ie_gerar_I053_w
from	ctb_regra_sped_registro a,
	ctb_sped_controle	b
where	a.nr_seq_regra_sped	= b.nr_seq_regra_sped
and	b.nr_sequencia		= nr_seq_controle_p
and	a.cd_registro		= 'I053';

if (ie_gerar_I052_w = 'S') and
	((nr_seq_demo_bp_w <> 0) or (nr_seq_demo_dre_w <> 0)) then
	begin
	open c_demonstrativo;
	loop
	fetch c_demonstrativo into
		vet05;
	EXIT WHEN NOT FOUND; /* apply on c_demonstrativo */
		begin
		CALL wheb_usuario_pck.set_cd_estabelecimento(cd_estabelecimento_p);
		CALL ctb_gerar_conta_rubrica(vet05.nr_sequencia,
					vet05.ds_origem,
					vet05.ie_origem_valor,
					vet05.cd_registro_sped,
					'ECD',
					dt_fim_p,
					nm_usuario_p,
					vet05.nr_seq_modelo_relat);
		commit;
		end;
	end loop;
	close c_demonstrativo;
	end;
end if;

open c_plano_contas;
loop
fetch c_plano_contas into
	vet01;
EXIT WHEN NOT FOUND; /* apply on c_plano_contas */
	begin
	tp_registro_w		:= 'I050';
	cd_conta_contabil_w	:= vet01.cd_conta_contabil;
	cd_conta_contabil_ww	:= vet01.cd_conta_contabil;
	cd_conta_sup_w		:= '';
	
	select ie_centro_custo
	into STRICT ie_centro_custo_w
	from conta_contabil
	where cd_conta_contabil = cd_conta_contabil_ww;

	nr_nivel_w	:= ctb_obter_nivel_classif_conta(vet01.cd_classificacao);

	if (ie_apres_conta_ctb_w = 'CD') then
		begin
		if (nr_nivel_w > 1) then
			cd_conta_sup_w := ctb_obter_codigo_classif_vig(cd_empresa_p,
									substr(ctb_obter_classif_conta_sup(vet01.cd_classificacao, dt_inicio_p, vet01.cd_empresa),1,40),
									dt_inicio_p);
		end if;
		end;
	elsif (ie_apres_conta_ctb_w = 'CL') then
		begin
		cd_conta_contabil_w	:= vet01.cd_classificacao;
		cd_conta_sup_w		:= substr(ctb_obter_classif_conta_sup(vet01.cd_classificacao, dt_inicio_p, vet01.cd_empresa),1,40);
		end;
	elsif (ie_apres_conta_ctb_w = 'CP') then
		begin
		cd_conta_contabil_w	:= substr(replace(vet01.cd_classificacao,'.',''),1,40);
		cd_conta_sup_w		:= substr(replace(substr(ctb_obter_classif_conta_sup(vet01.cd_classificacao, dt_inicio_p, vet01.cd_empresa),1,40),'.',''),1,40);
		end;
	end if;

	ds_linha_w	:= substr(	sep_w || 	tp_registro_w					||
					sep_w || 	substr(to_char(dt_inicio_p,'ddmmyyyy'),1,8)	||
					sep_w || 	vet01.cd_grupo_ecd				||
					sep_w || 	vet01.ie_tipo_ecd				||
					sep_w || 	nr_nivel_w					||
					sep_w || 	cd_conta_contabil_w				||
					sep_w || 	cd_conta_sup_w					||
					sep_w || 	vet01.ds_conta_contabil				||
					sep_w, 1, 8000);

	ds_arquivo_w		:= substr(ds_linha_w,1,4000);
	ds_compl_arquivo_w	:= substr(ds_linha_w,4001,4000);
	nr_seq_registro_w	:= nr_seq_registro_w + 1;
	nr_linha_w		:= nr_linha_w + 1;

	nr_vetor_w	:= nr_vetor_w + 1;

	ctb_sped_registro_w[nr_vetor_w].nr_sequencia		:= nr_seq_registro_w;
	ctb_sped_registro_w[nr_vetor_w].ds_arquivo		:= ds_arquivo_w;
	ctb_sped_registro_w[nr_vetor_w].dt_atualizacao		:= clock_timestamp();
	ctb_sped_registro_w[nr_vetor_w].nm_usuario		:= nm_usuario_p;
	ctb_sped_registro_w[nr_vetor_w].dt_atualizacao_nrec	:= clock_timestamp();
	ctb_sped_registro_w[nr_vetor_w].nm_usuario_nrec		:= nm_usuario_p;
	ctb_sped_registro_w[nr_vetor_w].nr_seq_controle_sped	:= nr_seq_controle_p;
	ctb_sped_registro_w[nr_vetor_w].ds_arquivo_compl	:= ds_compl_arquivo_w;
	ctb_sped_registro_w[nr_vetor_w].cd_registro		:= tp_registro_w;
	ctb_sped_registro_w[nr_vetor_w].nr_linha		:= nr_linha_w;

	tp_registro_w :=	'I051';
	cd_conta_contabil_w	:= vet01.cd_conta_contabil;

	open c_plano_contas_ref;
	loop
	fetch c_plano_contas_ref into
		vet02;
	EXIT WHEN NOT FOUND; /* apply on c_plano_contas_ref */
		begin
		
		if (cd_versao_w in ('8.0', '9.0')) then
			ds_linha_w	:= substr(	sep_w || tp_registro_w 		||
						sep_w || vet02.cd_centro_custo	||
						sep_w || vet02.cd_classif_ecd 	||
						sep_w,1,8000);
		else
			ds_linha_w	:= substr(	sep_w || tp_registro_w 		||
						sep_w || cd_empresa_resp_w	||
						sep_w || vet02.cd_centro_custo	||
						sep_w || vet02.cd_classif_ecd 	||
						sep_w,1,8000);
		end if;

		ds_arquivo_w		:= substr(ds_linha_w,1,4000);
		ds_compl_arquivo_w	:= substr(ds_linha_w,4001,4000);
		nr_seq_registro_w	:= nr_seq_registro_w + 1;
		nr_linha_w		:= nr_linha_w + 1;

		nr_vetor_w		:= nr_vetor_w + 1;

		ctb_sped_registro_w[nr_vetor_w].nr_sequencia		:= nr_seq_registro_w;
		ctb_sped_registro_w[nr_vetor_w].ds_arquivo		:= ds_arquivo_w;
		ctb_sped_registro_w[nr_vetor_w].dt_atualizacao		:= clock_timestamp();
		ctb_sped_registro_w[nr_vetor_w].nm_usuario		:= nm_usuario_p;
		ctb_sped_registro_w[nr_vetor_w].dt_atualizacao_nrec	:= clock_timestamp();
		ctb_sped_registro_w[nr_vetor_w].nm_usuario_nrec		:= nm_usuario_p;
		ctb_sped_registro_w[nr_vetor_w].nr_seq_controle_sped	:= nr_seq_controle_p;
		ctb_sped_registro_w[nr_vetor_w].ds_arquivo_compl	:= ds_compl_arquivo_w;
		ctb_sped_registro_w[nr_vetor_w].cd_registro		:= tp_registro_w;
		ctb_sped_registro_w[nr_vetor_w].nr_linha		:= nr_linha_w;

		if (nr_vetor_w >= 1000) then
			forall m in ctb_sped_registro_w.first..ctb_sped_registro_w.last
				insert into ctb_sped_registro values ctb_sped_registro_w(m);

			nr_vetor_w	:= 0;
			ctb_sped_registro_w.delete;

			commit;
		end if;
		end;
	end loop;
	close c_plano_contas_ref;

	tp_registro_w		:= 'I052';
	cd_conta_contabil_w	:= vet01.cd_conta_contabil;

	if	((nr_seq_demo_bp_w = 0) or (nr_seq_demo_dre_w = 0)) then
		begin
		open c_ind_cod_aglut_cta;
		loop
		fetch c_ind_cod_aglut_cta into
			vet03;
		EXIT WHEN NOT FOUND; /* apply on c_ind_cod_aglut_cta */
			begin
			cd_aglutinacao_w	:= vet03.cd_conta_contabil;

			if (ie_apres_conta_ctb_w = 'CL') then
				cd_aglutinacao_w	:= vet03.cd_classificacao;
			end if;

			ds_linha_w	:= substr(	sep_w || tp_registro_w 		||
							sep_w || vet03.cd_centro_custo 	||
							sep_w || cd_aglutinacao_w	||
							sep_w,1,8000);

			ds_arquivo_w		:= substr(ds_linha_w,1,4000);
			ds_compl_arquivo_w	:= substr(ds_linha_w,4001,4000);
			nr_seq_registro_w	:= nr_seq_registro_w + 1;
			nr_linha_w		:= nr_linha_w + 1;

			nr_vetor_w		:= nr_vetor_w + 1;

			ctb_sped_registro_w[nr_vetor_w].nr_sequencia		:= nr_seq_registro_w;
			ctb_sped_registro_w[nr_vetor_w].ds_arquivo		:= ds_arquivo_w;
			ctb_sped_registro_w[nr_vetor_w].dt_atualizacao		:= clock_timestamp();
			ctb_sped_registro_w[nr_vetor_w].nm_usuario		:= nm_usuario_p;
			ctb_sped_registro_w[nr_vetor_w].dt_atualizacao_nrec	:= clock_timestamp();
			ctb_sped_registro_w[nr_vetor_w].nm_usuario_nrec		:= nm_usuario_p;
			ctb_sped_registro_w[nr_vetor_w].nr_seq_controle_sped	:= nr_seq_controle_p;
			ctb_sped_registro_w[nr_vetor_w].ds_arquivo_compl	:= ds_compl_arquivo_w;
			ctb_sped_registro_w[nr_vetor_w].cd_registro		:= tp_registro_w;
			ctb_sped_registro_w[nr_vetor_w].nr_linha		:= nr_linha_w;
			end;
		end loop;
		close c_ind_cod_aglut_cta;
		end;
	end if;

	if	((nr_seq_demo_bp_w <> 0) or (nr_seq_demo_dre_w <> 0)) then
		begin

		open c_ind_cod_aglut_demo;
		loop
		fetch c_ind_cod_aglut_demo into
			vet04;
		EXIT WHEN NOT FOUND; /* apply on c_ind_cod_aglut_demo */
			begin
			cd_aglutinacao_w	:= vet04.cd_aglutinacao;
			
			if (ie_centro_custo_w = 'N') then
				begin
				ds_linha_w	:=  substr(	sep_w || tp_registro_w 		||
								sep_w || '' 	||
								sep_w || cd_aglutinacao_w	||
								sep_w,1,8000);

				ds_arquivo_w		:= substr(ds_linha_w,1,4000);
				ds_compl_arquivo_w	:= substr(ds_linha_w,4001,4000);
				nr_seq_registro_w	:= nr_seq_registro_w + 1;
				nr_linha_w		:= nr_linha_w + 1;

				nr_vetor_w		:= nr_vetor_w + 1;

				ctb_sped_registro_w[nr_vetor_w].nr_sequencia		:= nr_seq_registro_w;
				ctb_sped_registro_w[nr_vetor_w].ds_arquivo		:= ds_arquivo_w;
				ctb_sped_registro_w[nr_vetor_w].dt_atualizacao		:= clock_timestamp();
				ctb_sped_registro_w[nr_vetor_w].nm_usuario		:= nm_usuario_p;
				ctb_sped_registro_w[nr_vetor_w].dt_atualizacao_nrec	:= clock_timestamp();
				ctb_sped_registro_w[nr_vetor_w].nm_usuario_nrec		:= nm_usuario_p;
				ctb_sped_registro_w[nr_vetor_w].nr_seq_controle_sped	:= nr_seq_controle_p;
				ctb_sped_registro_w[nr_vetor_w].ds_arquivo_compl	:= ds_compl_arquivo_w;
				ctb_sped_registro_w[nr_vetor_w].cd_registro		:= tp_registro_w;
				ctb_sped_registro_w[nr_vetor_w].nr_linha		:= nr_linha_w;

				if (nr_vetor_w >= 1000) then
					forall m in ctb_sped_registro_w.first..ctb_sped_registro_w.last
						insert into ctb_sped_registro values ctb_sped_registro_w(m);

					nr_vetor_w	:= 0;
					ctb_sped_registro_w.delete;

					commit;
				end if;
				end;
			else
				begin
				open c_centro_custo_saldo;
				loop
				fetch c_centro_custo_saldo into
					vet07;
				EXIT WHEN NOT FOUND; /* apply on c_centro_custo_saldo */
					begin
					
					
					ds_linha_w	:=  substr(	sep_w || tp_registro_w 		||
									sep_w || vet07.cd_centro_custo 	||
									sep_w || cd_aglutinacao_w	||
									sep_w,1,8000);

					ds_arquivo_w		:= substr(ds_linha_w,1,4000);
					ds_compl_arquivo_w	:= substr(ds_linha_w,4001,4000);
					nr_seq_registro_w	:= nr_seq_registro_w + 1;
					nr_linha_w		:= nr_linha_w + 1;

					nr_vetor_w		:= nr_vetor_w + 1;

					ctb_sped_registro_w[nr_vetor_w].nr_sequencia		:= nr_seq_registro_w;
					ctb_sped_registro_w[nr_vetor_w].ds_arquivo		:= ds_arquivo_w;
					ctb_sped_registro_w[nr_vetor_w].dt_atualizacao		:= clock_timestamp();
					ctb_sped_registro_w[nr_vetor_w].nm_usuario		:= nm_usuario_p;
					ctb_sped_registro_w[nr_vetor_w].dt_atualizacao_nrec	:= clock_timestamp();
					ctb_sped_registro_w[nr_vetor_w].nm_usuario_nrec		:= nm_usuario_p;
					ctb_sped_registro_w[nr_vetor_w].nr_seq_controle_sped	:= nr_seq_controle_p;
					ctb_sped_registro_w[nr_vetor_w].ds_arquivo_compl	:= ds_compl_arquivo_w;
					ctb_sped_registro_w[nr_vetor_w].cd_registro		:= tp_registro_w;
					ctb_sped_registro_w[nr_vetor_w].nr_linha		:= nr_linha_w;

					if (nr_vetor_w >= 1000) then
						forall m in ctb_sped_registro_w.first..ctb_sped_registro_w.last
							insert into ctb_sped_registro values ctb_sped_registro_w(m);

						nr_vetor_w	:= 0;
						ctb_sped_registro_w.delete;

						commit;
					end if;
					end;
				end loop;
				close c_centro_custo_saldo;
				end;
			end if;
			
			
		end;
		end loop;
		close c_ind_cod_aglut_demo;
		end;
	end if;



	if (coalesce(nr_seq_dmpl_w,0) <> 0) then
		begin
		open c_ind_cod_aglut_dmpl;
		loop
		fetch c_ind_cod_aglut_dmpl into
			vet06;
		EXIT WHEN NOT FOUND; /* apply on c_ind_cod_aglut_dmpl */
			begin

			cd_aglutinacao_w	:= vet06.cd_aglutinacao_sped;

			ds_linha_w	:=  substr(	sep_w || tp_registro_w 		||
							sep_w || null 	||
							sep_w || cd_aglutinacao_w	||
							sep_w,1,8000);

			ds_arquivo_w		:= substr(ds_linha_w,1,4000);
			ds_compl_arquivo_w	:= substr(ds_linha_w,4001,4000);
			nr_seq_registro_w	:= nr_seq_registro_w + 1;
			nr_linha_w		:= nr_linha_w + 1;

			nr_vetor_w		:= nr_vetor_w + 1;

			ctb_sped_registro_w[nr_vetor_w].nr_sequencia		:= nr_seq_registro_w;
			ctb_sped_registro_w[nr_vetor_w].ds_arquivo		:= ds_arquivo_w;
			ctb_sped_registro_w[nr_vetor_w].dt_atualizacao		:= clock_timestamp();
			ctb_sped_registro_w[nr_vetor_w].nm_usuario		:= nm_usuario_p;
			ctb_sped_registro_w[nr_vetor_w].dt_atualizacao_nrec	:= clock_timestamp();
			ctb_sped_registro_w[nr_vetor_w].nm_usuario_nrec		:= nm_usuario_p;
			ctb_sped_registro_w[nr_vetor_w].nr_seq_controle_sped	:= nr_seq_controle_p;
			ctb_sped_registro_w[nr_vetor_w].ds_arquivo_compl	:= ds_compl_arquivo_w;
			ctb_sped_registro_w[nr_vetor_w].cd_registro		:= tp_registro_w;
			ctb_sped_registro_w[nr_vetor_w].nr_linha		:= nr_linha_w;

			if (nr_vetor_w >= 1000) then
				forall m in ctb_sped_registro_w.first..ctb_sped_registro_w.last
					insert into ctb_sped_registro values ctb_sped_registro_w(m);

				nr_vetor_w	:= 0;
				ctb_sped_registro_w.delete;

				commit;
			end if;
			end;
		end loop;
		close c_ind_cod_aglut_dmpl;

		end;
	end if;

	if (ie_gerar_I053_w = 'S') then
		begin
		null;
		end;
	end if;

	if (nr_vetor_w >= 1000) then
		forall m in ctb_sped_registro_w.first..ctb_sped_registro_w.last
			insert into ctb_sped_registro values ctb_sped_registro_w(m);

		nr_vetor_w	:= 0;
		ctb_sped_registro_w.delete;

		commit;
	end if;
	end;
end loop;
close c_plano_contas;

forall m in ctb_sped_registro_w.first..ctb_sped_registro_w.last
	insert into ctb_sped_registro values ctb_sped_registro_w(m);

nr_vetor_w	:= 0;
ctb_sped_registro_w.delete;

commit;

qt_linha_p	:= nr_linha_w;
nr_sequencia_p	:= nr_seq_registro_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ctb_gerar_interf_i050_ecd ( nr_seq_controle_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint, dt_inicio_p timestamp, dt_fim_p timestamp, cd_empresa_p bigint, qt_linha_p INOUT bigint, nr_sequencia_p INOUT bigint) FROM PUBLIC;

