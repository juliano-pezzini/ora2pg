-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE cpoe_hemo_gerar_proc_assoc ( nr_sequencia_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint) AS $body$
DECLARE

									
nr_sequencia_w				cpoe_procedimento.nr_sequencia%type;
cd_estabelecimento_w		smallint;
qt_idade_pac_w				double precision;
ie_sexo_prescr_w			varchar(1);
ds_mat_adic_proc_w			varchar(20) := 'X';			
qt_idade_mes_w				double precision;
qt_idade_dia_w				double precision;
ie_origen_proced_w			bigint;
qt_proc_adic_w				double precision;
nm_usuario_w				varchar(15);
ie_agenda_integrada_w		varchar(7);
cd_intervalo_w				varchar(7);
cd_intervalo_padr_w			varchar(7);
cd_material_exame_w			varchar(20);
cd_plano_w					varchar(20);
ie_urgencia_w				cpoe_hemoterapia.ie_urgencia%type;
cd_edicao_amb_w				bigint;
ds_horarios_w				cpoe_hemoterapia.ds_horarios%type;
nr_ocorrencia_w				cpoe_hemoterapia.nr_ocorrencia%type;
nr_atendimento_w			cpoe_hemoterapia.nr_atendimento%type;
cd_convenio_w				integer;
ie_origem_proc_filtro_w		bigint;
ie_tipo_atendimento_w		smallint;
ie_tipo_convenio_w			smallint;
cd_categoria_w				varchar(10);
cd_medico_w					cpoe_hemoterapia.cd_medico%type;
cd_setor_prescr_proc_w		integer;
ds_observacao_w				cpoe_hemoterapia.ds_observacao%type;
ie_cobra_paciente_w			varchar(1);
ds_justificativa_w			cpoe_hemoterapia.ds_justificativa%type;
cd_pessoa_fisica_w 			cpoe_hemoterapia.cd_pessoa_fisica%type;
dt_inicio_w					cpoe_hemoterapia.dt_inicio%type;
cd_perfil_ativo_w			cpoe_hemoterapia.cd_perfil_ativo%type;
dt_atualizacao_nrec_w		cpoe_hemoterapia.dt_atualizacao_nrec%type;
nm_usuario_nrec_w			cpoe_hemoterapia.nm_usuario_nrec%type;
ie_futuro_w					cpoe_hemoterapia.ie_futuro%type;
ie_nivel_atencao_w			cpoe_hemoterapia.ie_nivel_atencao%type;
ie_item_alta_w				cpoe_hemoterapia.ie_item_alta%type;
cd_funcao_origem_w			cpoe_hemoterapia.cd_funcao_origem%type;
ie_retrogrado_w				cpoe_hemoterapia.ie_retrogrado%type;
dt_fim_w					cpoe_hemoterapia.dt_fim%type;
nr_seq_derivado_w 			cpoe_hemoterapia.nr_seq_derivado%type;
nr_seq_proc_w				cpoe_hemoterapia.nr_seq_proc_interno%type;
nr_seq_proc_interno_w		cpoe_hemoterapia.nr_seq_proc_interno%type;
cd_setor_atendimento_w		setor_atendimento.cd_setor_atendimento%type;
cd_procedimento_w			proc_int_proc_prescr.cd_procedimento%type;
ie_origem_proced_w			proc_int_proc_prescr.ie_origem_proced%type;
param493_w					varchar(1);
nr_seq_cpoe_order_unit_w	cpoe_order_unit.nr_sequencia%type;
nr_seq_hemoterapia_w        cpoe_hemoterapia.nr_sequencia%type;

C01 CURSOR FOR
	SELECT	a.nr_seq_proc_int_adic,
			coalesce(a.qt_proc_adic, h.qt_procedimento),
			h.nm_usuario,
			h.cd_intervalo,
			m.cd_material_exame,
			h.ds_horarios,
			h.nr_ocorrencia,
			coalesce(a.ie_cobra_paciente,'S'),
			a.ie_origem_proced,
			h.cd_medico,
			h.cd_setor_atendimento,
			substr(a.ds_observacao || '  ' || h.ds_observacao,1,255),
			a.cd_intervalo,
			h.ie_urgencia,
			a.ie_agenda_integrada,
			h.ds_justificativa,
			h.nr_seq_cpoe_order_unit,
			h.nr_sequencia
	FROM cpoe_hemoterapia h, proc_int_proc_prescr a
LEFT OUTER JOIN material_exame_lab m ON (a.nr_seq_material = m.nr_sequencia)
WHERE 1 = 1 and a.nr_seq_proc_interno	= nr_seq_proc_w  and h.nr_sequencia			= nr_sequencia_p and ((coalesce(a.cd_estabelecimento::text, '') = '') or (a.cd_estabelecimento = cd_estabelecimento_w)) and ((coalesce(a.ie_permite_duplicado,'N')	= 'S') or
			 (not exists(	SELECT	1
							from	cpoe_PROCEDIMENTO ch 
							where	1 = 1
							and		((coalesce(a.nr_seq_proc_int_adic,0) = 0) or (ch.nr_seq_proc_interno = a.nr_seq_proc_int_adic))	
							and		h.nm_usuario =  nm_usuario_p					   
							and		coalesce(ch.dt_liberacao::text, '') = ''
							and		ch.nr_atendimento =  h.nr_atendimento))) and not exists (        select  1
                            from    cpoe_procedimento ch
                            where   1 = 1
                            and     ((coalesce(a.nr_seq_proc_int_adic,0) = 0) or (ch.nr_seq_proc_interno = a.nr_seq_proc_int_adic))   
                            and     h.nm_usuario =  nm_usuario_p
                            and     coalesce(a.QT_DIAS_ANTES_DA_TRANSFUSAO,0) + ch.DT_ATUALIZACAO > clock_timestamp()
                            and     ch.nr_atendimento =  h.nr_atendimento) and (((coalesce(qt_idade_pac_w::text, '') = '') or (coalesce(a.qt_idade_min::text, '') = '' and coalesce(a.qt_idade_max::text, '') = '')) or
			 ((qt_idade_pac_w IS NOT NULL AND qt_idade_pac_w::text <> '') and (qt_idade_pac_w between coalesce(a.qt_idade_min,qt_idade_pac_w) and coalesce(a.qt_idade_max,qt_idade_pac_w)))) and ( ((coalesce(qt_idade_mes_w::text, '') = '') or (coalesce(a.qt_idade_mes_min::text, '') = '' and coalesce(a.qt_idade_mes_max::text, '') = '')) or (qt_idade_mes_w between coalesce(a.qt_idade_min,qt_idade_pac_w) * 12 + coalesce(a.qt_idade_mes_min,qt_idade_mes_w) and coalesce(a.qt_idade_max,qt_idade_pac_w) * 12 + coalesce(a.qt_idade_mes_max,qt_idade_mes_w))) and ((ie_sexo = ie_sexo_prescr_w) or (coalesce(ie_sexo::text, '') = '')) and coalesce(a.cd_convenio,cd_convenio_w) = cd_convenio_w and ((coalesce(a.cd_edicao_amb::text, '') = '') or (a.cd_edicao_amb = cd_edicao_amb_w)) and ((coalesce(a.cd_convenio_excluir::text, '') = '') or (a.cd_convenio_excluir <> cd_convenio_w)) and ((coalesce(a.cd_categoria_convenio::text, '') = '') or (a.cd_categoria_convenio = cd_categoria_w)) and ((a.cd_plano_convenio	= cd_plano_w) or (coalesce(a.cd_plano_convenio::text, '') = '')) and ((coalesce(a.cd_medico_prescritor::text, '') = '') or (a.cd_medico_prescritor = h.cd_medico)) and ((coalesce(a.cd_medico_excluir::text, '') = '') or (a.cd_medico_excluir <> h.cd_medico)) and ((a.ie_origem_proc_filtro = ie_origem_proc_filtro_w) or (coalesce(a.ie_origem_proc_filtro::text, '') = '')) and obter_conv_excluir_proc_assoc(a.nr_sequencia, cd_convenio_w, cd_edicao_amb_w, ie_origem_proc_filtro_w) = 'S' and ((coalesce(cd_perfil::text, '') = '') or (cd_perfil = obter_perfil_ativo)) and coalesce(a.ie_situacao,'A')	= 'A' and coalesce(a.ie_somente_agenda_int,'N') = 'N' and coalesce(a.ie_somente_agenda_cir,'N') = 'N' and coalesce(a.ie_tipo_convenio,ie_tipo_convenio_w)      = ie_tipo_convenio_w and allow_generate_assoc_amount(h.nr_atendimento,a.NR_SEQ_PROC_INT_ADIC,a.QT_PRESCRICAO_MAX)='S';
	
	
	
BEGIN
		param493_w := Obter_param_Usuario(924, 493, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, param493_w);
	
		cd_estabelecimento_w := cd_estabelecimento_p;
		
		
		select	max(nr_atendimento),
				max(dt_inicio),
				max(cd_perfil_ativo),
				max(cd_pessoa_fisica),
				max(dt_atualizacao_nrec),
				max(nm_usuario_nrec),
				max(ie_futuro),
				max(ie_nivel_atencao),
				max(ie_item_alta),
				max(cd_funcao_origem),
				max(ie_retrogrado),
				max(dt_fim),
				max(nr_seq_derivado),
				max(nr_seq_proc_interno)
		into STRICT	nr_atendimento_w,
				dt_inicio_w,
				cd_perfil_ativo_w,
				cd_pessoa_fisica_w,
				dt_atualizacao_nrec_w,
				nm_usuario_nrec_w,
				ie_futuro_w,
				ie_nivel_atencao_w,
				ie_item_alta_w,
				cd_funcao_origem_w,
				ie_retrogrado_w,
				dt_fim_w,
				nr_seq_derivado_w,
				nr_seq_proc_w
		from	cpoe_hemoterapia
		where	nr_sequencia = nr_sequencia_p;
		
		if (nr_seq_derivado_w IS NOT NULL AND nr_seq_derivado_w::text <> '') then
			select max(nr_seq_proc_interno),
				max(cd_procedimento),
				max(ie_origem_proced)
			into STRICT nr_seq_proc_w,
				cd_procedimento_w,
				ie_origem_proced_w
			from san_derivado
			where nr_sequencia = nr_seq_derivado_w;
		end if;

		
		select	coalesce((obter_idade(dt_nascimento, clock_timestamp(), 'A'))::numeric ,0) qt_idade_ano,
				coalesce((obter_idade(dt_nascimento, clock_timestamp(), 'M'))::numeric ,0) qt_idade_mes,
				coalesce((obter_idade(dt_nascimento, clock_timestamp(), 'DIA'))::numeric ,0) qt_idade_dia
		into STRICT	qt_idade_pac_w,
				qt_idade_mes_w,
				qt_idade_dia_w
		from	pessoa_fisica
		where	cd_pessoa_fisica = cd_pessoa_fisica_w;
		
		select 	coalesce(max(obter_convenio_atendimento(nr_atendimento_w)),0),
				coalesce(max(obter_categoria_atendimento(nr_atendimento_w)),0)
		into STRICT	cd_convenio_w,
				cd_categoria_w
		;

		select	max(Obter_Plano_Atendimento(nr_atendimento_w,'C'))
		into STRICT	cd_plano_w
		;

		select 	max(ie_tipo_convenio)
		into STRICT	ie_tipo_convenio_w
		from 	convenio
		where 	cd_convenio = cd_convenio_w;
		
		select 	max(ie_tipo_atendimento)
		into STRICT	ie_tipo_atendimento_w
		from 	atendimento_paciente
		where 	nr_atendimento = nr_atendimento_w;

		ie_origem_proc_filtro_w:= Obter_Origem_Proced_Cat(cd_estabelecimento_w, ie_tipo_atendimento_w, ie_tipo_convenio_w, cd_convenio_w, cd_categoria_w);
		
		select	coalesce(max(cd_edicao_amb),0)
		into STRICT	cd_edicao_amb_w
		from 	convenio_amb
		where (cd_estabelecimento     = cd_estabelecimento_w)
		and (cd_convenio            = cd_convenio_w)
		and (coalesce(ie_situacao,'A')   = 'A')
		and		((coalesce(cd_categoria_w,'0') = '0') or (cd_categoria = cd_categoria_w))
		and 	(dt_inicio_vigencia     =
				(SELECT	max(dt_inicio_vigencia)
				from 	convenio_amb a	
				where (a.cd_estabelecimento  	= cd_estabelecimento_w)
				and (a.cd_convenio         	= cd_convenio_w)
				and (coalesce(a.ie_situacao,'A')	= 'A')
				and	((coalesce(cd_categoria_w,'0') = '0') or (a.cd_categoria = cd_categoria_w))
				and (a.dt_inicio_vigencia 	<=  clock_timestamp())));
		
		
		open C01;
		loop
		fetch C01 into
			nr_seq_proc_interno_w,
			qt_proc_adic_w,
			nm_usuario_w,
			cd_intervalo_w,
			cd_material_exame_w,
			ds_horarios_w,
			nr_ocorrencia_w,
			ie_cobra_paciente_w,
			ie_origen_proced_w,
			cd_medico_w,
			cd_setor_prescr_proc_w,
			ds_observacao_w,
			cd_intervalo_padr_w,
			ie_urgencia_w,
			ie_agenda_integrada_w,
			ds_justificativa_w,
			nr_seq_cpoe_order_unit_w,
			nr_seq_hemoterapia_w;
		EXIT WHEN NOT FOUND; /* apply on C01 */
		
		begin
		
			select	nextval('cpoe_procedimento_seq')
			into STRICT	nr_sequencia_w
			;

			cd_setor_atendimento_w := obter_cd_setor_atend_padrao(nr_seq_proc_interno_w, null, cd_estabelecimento_w, null, nr_atendimento_w);
	
			if ((coalesce(cd_setor_atendimento_w,0) = 0)
			  	or (param493_w = 'S')) 
				and (cd_setor_prescr_proc_w IS NOT NULL AND cd_setor_prescr_proc_w::text <> '') then
				cd_setor_atendimento_w := cd_setor_prescr_proc_w;
			end if;

			insert	into cpoe_procedimento(
					nr_sequencia,                
					nr_seq_proc_interno,         
					qt_procedimento,             
					dt_atualizacao,              
					nm_usuario,                  
					nr_ocorrencia,               
					cd_medico,
					ds_justificativa,            
					ds_horarios,                 
					nr_atendimento,              
					dt_inicio,
					hr_prim_horario,
					cd_perfil_ativo,             
					cd_pessoa_fisica,            
					cd_intervalo,                
					ie_urgencia,                 
					nm_usuario_nrec,             
					dt_atualizacao_nrec,         
					cd_material_exame,           
					cd_setor_atendimento,           
					ie_exame_assoc,              
					ie_cobra_paciente,           
					ie_futuro,                   
					ie_nivel_atencao,            
					ie_item_alta,                
					cd_funcao_origem,            
					ie_retrogrado,               
					dt_fim,
					ie_duracao,
					ie_administracao,
					nr_seq_cpoe_order_unit,
					nr_seq_hemoterapia)
				values (
					nr_sequencia_w,
					nr_seq_proc_interno_w,
					qt_proc_adic_w,
					clock_timestamp(),
					nm_usuario_w,
					nr_ocorrencia_w,
					cd_medico_w,
					ds_justificativa_w,
					ds_horarios_w,
					nr_atendimento_w,
					dt_inicio_w,
					to_char(dt_inicio_w, 'hh24:mi'),
					cd_perfil_ativo_w,
					cd_pessoa_fisica_w,
					coalesce(cd_intervalo_padr_w, cd_intervalo_w),
					ie_urgencia_w,
					nm_usuario_nrec_w,
					dt_atualizacao_nrec_w,
					cd_material_exame_w,
					cd_setor_atendimento_w,
					CASE WHEN ie_agenda_integrada_w='S' THEN  'A'  ELSE 'S' END ,
					ie_cobra_paciente_w,
					ie_futuro_w,
					ie_nivel_atencao_w,
					ie_item_alta_w,
					cd_funcao_origem_w,
					ie_retrogrado_w,
                    dt_fim_w,
					'P',
					'P',
					nr_seq_cpoe_order_unit_w,
					nr_seq_hemoterapia_w);
									
				ds_mat_adic_proc_w := cpoe_gerar_med_mat_assoc(	nr_atendimento_w, nr_sequencia_w, nr_seq_proc_interno_w, ie_origen_proced_w, nr_seq_proc_interno_w, cd_estabelecimento_w, cd_perfil_ativo_w, nm_usuario_p, cd_pessoa_fisica_w, qt_idade_dia_w, qt_idade_mes_w, qt_idade_pac_w, cd_setor_prescr_proc_w, ie_tipo_atendimento_w, cd_convenio_w, cd_medico_w, null, coalesce(cd_intervalo_padr_w, cd_intervalo_w), ie_urgencia_w, 0, 0, ds_horarios_w, nr_ocorrencia_w, ds_mat_adic_proc_w, 0);
			
			

		end;
		end loop;
		close C01;	
	commit;
exception
when others then
		CALL gravar_log_cpoe(substr('EXCEPTION CPOE_HEMO_GERAR_PROC_ASSOC:'|| substr(to_char(sqlerrm),1,2000),1,2000),
		nr_atendimento_w, 'H', nr_sequencia_p);
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cpoe_hemo_gerar_proc_assoc ( nr_sequencia_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint) FROM PUBLIC;

