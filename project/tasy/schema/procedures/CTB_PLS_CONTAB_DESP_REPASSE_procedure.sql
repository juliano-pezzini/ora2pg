-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE ctb_pls_contab_desp_repasse ( nr_lote_contabil_p bigint, nm_usuario_p text, ie_exclusao_p text, ds_retorno_p INOUT text) AS $body$
DECLARE


ie_debito_credito_w		w_movimento_contabil.ie_debito_credito%type;
cd_conta_contabil_w		w_movimento_contabil.cd_conta_contabil%type;
vl_contabil_w			w_movimento_contabil.vl_movimento%type;
cd_historico_w			w_movimento_contabil.cd_historico%type;
cd_estabelecimento_w		w_movimento_contabil.cd_estabelecimento%type;
nr_seq_w_movto_cont_w		w_movimento_contabil.nr_sequencia%type;
cd_centro_custo_w		w_movimento_contabil.cd_centro_custo%type;
ie_centro_custo_w		conta_contabil.ie_centro_custo%type;
nr_seq_lote_mens_w		pls_repasse_mens.nr_sequencia%type;
nr_seq_mens_seg_w		pls_repasse_mens.nr_seq_mens_seg%type;
nr_seq_vendedor_benef_w		pls_repasse_mens.nr_seq_vendedor_benef%type;
nr_lote_contabil_w		lote_contabil.nr_lote_contabil%type;
nr_seq_regra_cc_w		pls_regra_centro_custo.nr_sequencia%type;
nr_seq_info_ctb_w		informacao_contabil.nr_sequencia%type;
nm_tabela_w			w_movimento_contabil.nm_tabela%type;
nm_atributo_w			w_movimento_contabil.nm_atributo%type;
cd_tipo_lote_contabil_w		lote_contabil.cd_tipo_lote_contabil%type;
vl_retorno_w			varchar(2000);
ds_compl_historico_w		varchar(2000);
ds_conteudo_w			varchar(255);
qt_lote_contabil_w		bigint;
nr_titulo_w			bigint;
dt_referencia_repasse_w		timestamp;
dt_referencia_w			timestamp;
dt_ref_inicial_w		timestamp;
dt_ref_final_w			timestamp;
nm_agrupador_w			varchar(255);
nr_seq_agrupamento_w		movimento_contabil.nr_seq_agrupamento%type;
nr_seq_rep_vend_w		pls_repasse_vend.nr_sequencia%type;
nm_vendedor_w			varchar(255);
qt_lote_repasse_aberto_w	bigint;
nr_seq_lote_w			pls_repasse_vend.nr_sequencia%type;
ds_lote_w			varchar(2000);
nr_seq_vend_w			pls_repasse_vend.nr_seq_vendedor%type;
nr_nota_fiscal_w		varchar(255);
nr_seq_segurado_w		pls_repasse_mens.nr_seq_segurado%type;

C01 CURSOR FOR
	SELECT	b.nr_sequencia,
		'D',
		b.cd_conta_deb,
		b.vl_repasse,
		trunc(a.dt_referencia,'dd') dt_referencia,
		b.cd_historico,
		b.nr_seq_mens_seg,
		'PLS_REPASSE_MENS' nm_tabela,
		'VL_REPASSE' nm_atributo,
		26 nr_seq_info_ctb,
		b.nr_seq_vendedor_benef,
		substr(pls_obter_titulo_mensalidade(null,b.nr_seq_mens_seg),1,10),
		a.nr_sequencia,
		a.nr_seq_vendedor,
		b.nr_seq_segurado
	from	pls_repasse_mens	b,
		pls_repasse_vend	a
	where	b.nr_seq_repasse	= a.nr_sequencia
	and	a.nr_lote_contabil 	= nr_lote_contabil_p
	and	a.ie_status 	= 'F'
	
union

	SELECT	b.nr_sequencia,
		'C',
		b.cd_conta_cred,
		b.vl_repasse,
		trunc(a.dt_referencia,'dd') dt_referencia,
		b.cd_historico,
		b.nr_seq_mens_seg,
		'PLS_REPASSE_MENS' nm_tabela,
		'VL_REPASSE' nm_atributo,
		26 nr_seq_info_ctb,
		b.nr_seq_vendedor_benef,
		substr(pls_obter_titulo_mensalidade(null,b.nr_seq_mens_seg),1,10),
		a.nr_sequencia,
		a.nr_seq_vendedor,
		b.nr_seq_segurado
	from	pls_repasse_mens	b,
		pls_repasse_vend	a
	where	b.nr_seq_repasse	= a.nr_sequencia
	and	a.nr_lote_contabil	= nr_lote_contabil_p
	and	a.ie_status 	= 'F'
	
union

	select	null,
		'D',
		c.cd_conta_deb,
		c.vl_lancamento,
		trunc(a.dt_referencia,'dd') dt_referencia,
		c.cd_historico,
		null nr_seq_mens_seg,
		'PLS_REPASSE_LANC' nm_tabela,
		'VL_LANCAMENTO' nm_atributo,
		26 nr_seq_info_ctb,
		null nr_seq_vendedor_benef,
		(select	to_char(max(t.nr_titulo))
		from 	pls_repasse_vend_venc t
		where	t.nr_seq_repasse = a.nr_sequencia) nr_titulo,
		a.nr_sequencia,
		a.nr_seq_vendedor,
		null nr_seq_segurado
	from	pls_repasse_vend		a,
		pls_vendedor			f,
		pls_repasse_lanc		c
	where	f.nr_sequencia		= a.nr_seq_vendedor
	and	a.nr_sequencia		= c.nr_seq_repasse
	and	c.nr_lote_contabil	= nr_lote_contabil_p
	and	a.ie_status = 'F'
	
union

	select	null,
		'C',
		c.cd_conta_cred,
		c.vl_lancamento,
		trunc(a.dt_referencia,'dd') dt_referencia,
		c.cd_historico,
		null nr_seq_mens_seg,
		'PLS_REPASSE_LANC' nm_tabela,
		'VL_LANCAMENTO' nm_atributo,
		26 nr_seq_info_ctb,
		null nr_seq_vendedor_benef,
		(select	to_char(max(t.nr_titulo))
		from 	pls_repasse_vend_venc t
		where	t.nr_seq_repasse = a.nr_sequencia) nr_titulo,
		a.nr_sequencia,
		a.nr_seq_vendedor,
		null nr_seq_segurado
	from	pls_repasse_vend		a,
		pls_vendedor			f,
		pls_repasse_lanc		c
	where	f.nr_sequencia		= a.nr_seq_vendedor
	and	a.nr_sequencia		= c.nr_seq_repasse
	and	c.nr_lote_contabil	= nr_lote_contabil_p
	and	a.ie_status = 'F';
	
c_lote CURSOR FOR
	SELECT	nr_sequencia
	from	pls_repasse_vend
	where	dt_referencia	between dt_ref_inicial_w and dt_ref_final_w
	and	cd_estabelecimento	= cd_estabelecimento_w
	and	ie_status = 'A';	
	

BEGIN
select	dt_referencia,
	cd_estabelecimento,
	nr_lote_contabil,
	cd_tipo_lote_contabil
into STRICT 	dt_referencia_w,
	cd_estabelecimento_w,
	nr_lote_contabil_w,
	cd_tipo_lote_contabil_w
from 	lote_contabil
where 	nr_lote_contabil 	= nr_lote_contabil_p;

dt_ref_inicial_w	:= trunc(dt_referencia_w, 'month');
dt_ref_final_w		:= fim_dia(fim_mes(dt_ref_inicial_w));

select	count(1)
into STRICT 	qt_lote_contabil_w
from 	lote_contabil
where 	nr_lote_contabil 	<> nr_lote_contabil_p
and	dt_referencia		= dt_referencia_w
and	cd_tipo_lote_contabil	= cd_tipo_lote_contabil_w
and	coalesce(cd_estabelecimento, cd_estabelecimento_w) = cd_estabelecimento_w  LIMIT 1;



delete	from w_pls_movimento_sem_conta
where	cd_tipo_lote_contabil	= cd_tipo_lote_contabil_w;

if (ie_exclusao_p = 'S') then
	CALL wheb_usuario_pck.set_ie_lote_contabil('S');
	
	delete	from movimento_contabil
	where	nr_lote_contabil	= nr_lote_contabil_p;

	update	lote_contabil
	set	vl_credito 		= 0,
		vl_debito  		= 0
	where	nr_lote_contabil	= nr_lote_contabil_p;
	
	update	pls_repasse_vend
	set	nr_lote_contabil	= 0
	where	nr_lote_contabil 	= nr_lote_contabil_p;
	
	update	pls_repasse_lanc
	set	nr_lote_contabil	= 0
	where	nr_lote_contabil 	= nr_lote_contabil_p;
	
	CALL wheb_usuario_pck.set_ie_lote_contabil('N');
else
	CALL ctb_gravar_log_lote(	nr_lote_contabil_p,
				1,
				wheb_mensagem_pck.get_texto(1097173),
				nm_usuario_p);

	if (ie_exclusao_p = 'N') then

		if (qt_lote_contabil_w > 0) then
			CALL wheb_mensagem_pck.exibir_mensagem_abort( 190536, 'DT_REFERENCIA=' || to_char(dt_referencia_w,'mm/yyyy'));
			/* Shows the following message: There already is a accounting batch of sales comission for the referenc month. Pleasy verify */

		end if;
		CALL wheb_usuario_pck.set_ie_lote_contabil('S');
		
		delete	FROM w_movimento_contabil
		where	nr_lote_contabil	= nr_lote_contabil_p;

		select	count(1)
		into STRICT	qt_lote_repasse_aberto_w
		from	pls_repasse_vend
		where	dt_referencia	between dt_ref_inicial_w and dt_ref_final_w
		and	cd_estabelecimento	= cd_estabelecimento_w
		and	ie_status = 'A';

		if (qt_lote_repasse_aberto_w > 0) then

			open c_lote;
			loop
			fetch c_lote into
				nr_seq_lote_w;
			EXIT WHEN NOT FOUND; /* apply on c_lote */
				begin
				
				if (coalesce(ds_lote_w,'X') = 'X') then
					ds_lote_w := nr_seq_lote_w;
				else
					ds_lote_w := ds_lote_w || ', ' || nr_seq_lote_w;
				end if;
			
				end;
			end loop;
			close c_lote;
			
			CALL wheb_mensagem_pck.exibir_mensagem_abort( 357399, substr('DS_LOTE_W=' || ds_lote_w,1,2000));
			/* The following payment transfer accounting batches are still open: #@DS_LOTE_#@. Please verify. */

			
		end if;
		
		update	pls_repasse_vend	a
		set	a.nr_lote_contabil 	= nr_lote_contabil_p
		where	a.dt_referencia	between dt_ref_inicial_w and dt_ref_final_w
		and	a.cd_estabelecimento	= cd_estabelecimento_w
		and	a.ie_status <> 'C' /* OS 492146 - Do not account for cancelled payment transfers */
		and	exists (SELECT	1
				from	pls_repasse_vend_venc	x
				where	x.nr_seq_repasse	= a.nr_sequencia);
				
		update	pls_repasse_lanc	a
		set	a.nr_lote_contabil	= nr_lote_contabil_p
		where	1 = 1
		and	exists (SELECT	1
				from	pls_repasse_vend	r,
					pls_vendedor		v
				where	v.nr_sequencia		= r.nr_seq_vendedor
				and	r.nr_sequencia		= a.nr_seq_repasse
				and	r.cd_estabelecimento	= cd_estabelecimento_w
				and	r.dt_referencia	between dt_ref_inicial_w and dt_ref_final_w
				and	r.ie_status = 'F');
				
		CALL wheb_usuario_pck.set_ie_lote_contabil('N');
		
		nr_seq_w_movto_cont_w	:= 0;
		
		nm_agrupador_w	:= coalesce(trim(both obter_agrupador_contabil(cd_tipo_lote_contabil_w)),'NR_SEQ_REP_VEND');
		
		open c01;
		loop
		fetch c01 into
			nr_seq_lote_mens_w,
			ie_debito_credito_w,
			cd_conta_contabil_w,
			vl_contabil_w,
			dt_referencia_repasse_w,
			cd_historico_w,
			nr_seq_mens_seg_w,
			nm_tabela_w,
			nm_atributo_w,
			nr_seq_info_ctb_w,
			nr_seq_vendedor_benef_w,
			nr_titulo_w,
			nr_seq_rep_vend_w,
			nr_seq_vend_w,
			nr_seq_segurado_w;
		EXIT WHEN NOT FOUND; /* apply on c01 */
			cd_centro_custo_w	:= null;
			
			if (nm_agrupador_w = 'NR_SEQ_REP_MENS') then
				nr_seq_agrupamento_w	:=	nr_seq_lote_mens_w;
			end if;
			
			if (nm_agrupador_w = 'NR_SEQ_REP_VEND') then
				nr_seq_agrupamento_w	:=	nr_seq_rep_vend_w;
			end if;
			if (coalesce(nr_seq_agrupamento_w,0) = 0)then
				nr_seq_agrupamento_w	:=	nr_seq_rep_vend_w;
			end if;
			
			if (coalesce(cd_conta_contabil_w::text, '') = '') then
				insert into w_pls_movimento_sem_conta(nr_sequencia,
					cd_item, ds_item,
					ie_tipo_item,
					dt_atualizacao,
					nm_usuario,
					vl_item,
					dt_referencia,
					nr_lote_contabil,
					ie_proc_mat_item,
					ie_deb_cred,
					cd_tipo_lote_contabil)
				values (nextval('w_pls_movimento_sem_conta_seq'),
					nr_seq_lote_mens_w,
					obter_desc_expressao(656591) || ' nr. ' || to_char(nr_seq_mens_seg_w),
					'R',
					clock_timestamp(),
					nm_usuario_p,
					vl_contabil_w,
					dt_referencia_repasse_w,
					nr_lote_contabil_w,
					null,
					ie_debito_credito_w,
					cd_tipo_lote_contabil_w);
			else
				select	ie_centro_custo
				into STRICT	ie_centro_custo_w
				from	conta_contabil
				where	cd_conta_contabil	= cd_conta_contabil_w;
				
				if (ie_centro_custo_w = 'S') then
					SELECT * FROM pls_obter_centro_custo(	'D', null, cd_estabelecimento_w, '', '', '', nr_seq_segurado_w, '', cd_centro_custo_w, nr_seq_regra_cc_w) INTO STRICT cd_centro_custo_w, nr_seq_regra_cc_w;
				end if;
				
				nm_vendedor_w := '';
				
				if (coalesce(nr_seq_vend_w,0) <> 0) then
				
					select substr(obter_nome_pf_pj(cd_pessoa_fisica,cd_cgc),1,200)
					into STRICT nm_vendedor_w
					from pls_vendedor
					where nr_sequencia = nr_seq_vend_w;
				
				end if;
				
				nr_nota_fiscal_w := '';
				
				if (coalesce(nr_seq_rep_vend_w,0) <> 0) then
					
					select	max(nr_nota_fiscal)
					into STRICT	nr_nota_fiscal_w
					from	pls_repasse_vend_venc
					where	nr_seq_repasse = nr_seq_rep_vend_w;
					
				end if;
				
				if (coalesce(cd_historico_w,0) > 0) then
				
					/* If needed to add/remove fields from the history complement, also change it on the procedure CTB_PLS_CONTABILIzAR_COMISSAO */

					ds_conteudo_w := substr(	to_char(nr_seq_vendedor_benef_w) || '#@' ||
									to_char(nr_titulo_w) || '#@' ||
									to_char(nm_vendedor_w) || '#@' ||
									to_char(nr_nota_fiscal_w),1,4000);
								
				
								
					begin
					ds_compl_historico_w := substr(obter_compl_historico(24,cd_historico_w,ds_conteudo_w),1,255);
					exception
					when others then
						ds_compl_historico_w := null;
					end;
				end if;
				
				nr_seq_w_movto_cont_w	:= nr_seq_w_movto_cont_w + 1;
				
				insert into w_movimento_contabil(nr_lote_contabil,
					nr_sequencia,
					cd_conta_contabil,
					ie_debito_credito,
					cd_historico,
					dt_movimento,
					vl_movimento,
					cd_estabelecimento,
					cd_centro_custo,
					nr_seq_tab_orig,
					nr_seq_info,
					nm_tabela,
					nm_atributo,
					nr_seq_agrupamento,
					ds_compl_historico)
				values (nr_lote_contabil_p,
					nr_seq_w_movto_cont_w,
					cd_conta_contabil_w,
					ie_debito_credito_w,
					cd_historico_w,
					dt_referencia_repasse_w,
					vl_contabil_w,
					cd_estabelecimento_w,
					cd_centro_custo_w,
					nr_seq_lote_mens_w,
					nr_seq_info_ctb_w,
					nm_tabela_w,
					nm_atributo_w,
					nr_seq_agrupamento_w,
					ds_compl_historico_w);
			end if;
		end loop;
		close c01;
		
		commit;
		/*agrupa_movimento_contabil(	nr_lote_contabil_p,
						nm_usuario_p); */
	end if;
end if;

/*if   	(ds_retorno_p is null) then
	begin
	update	lote_contabil
	set	ie_situacao 		= 'A',
		dt_geracao_lote		= decode(ie_exclusao_p,'N',sysdate,'S',null)
	where	nr_lote_contabil 	= nr_lote_contabil_p;
	
	if	(ie_exclusao_p = 'S') then
		ds_retorno_p	:= wheb_mensagem_pck.get_texto(298774);
	else
		ds_retorno_p	:= wheb_mensagem_pck.get_texto(298775);
	end if;
	
	commit;
	end;
else
	rollback;
end if;*/
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ctb_pls_contab_desp_repasse ( nr_lote_contabil_p bigint, nm_usuario_p text, ie_exclusao_p text, ds_retorno_p INOUT text) FROM PUBLIC;

