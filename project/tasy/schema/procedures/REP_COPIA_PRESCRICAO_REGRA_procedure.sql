-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE rep_copia_prescricao_regra ( nr_prescricao_p bigint, nr_atendimento_p bigint, nr_seq_regra_p bigint, nm_usuario_p text, cd_medico_p text, dt_prescricao_p timestamp, ie_procedimento_p text, nr_prescricoes_p text, dt_primeiro_horario_p text, ie_ajustar_qt_p text, cd_perfil_P bigint, ie_agrupamento_p bigint, ds_ind_clinica_p text, hr_prescr_inicial_p text, hr_prescr_final_p text, dt_procedimento_p timestamp, nr_horas_validade_p bigint, nr_seq_transcricao_p bigint default 0, nr_nova_prescricao_p INOUT bigint DEFAULT NULL, cd_funcao_ativa_p bigint DEFAULT NULL, cd_medic_posicionar_p INOUT bigint DEFAULT NULL) AS $body$
DECLARE


nr_seq_bco_w				prescr_solic_bco_sangue.nr_sequencia%type;

cd_pessoa_fisica_w			pessoa_fisica.cd_pessoa_fisica%type;
cd_pessoa_fisica_ww			pessoa_fisica.cd_pessoa_fisica%type;
cd_prescritor_w				pessoa_fisica.cd_pessoa_fisica%type;

cd_setor_entrega_w			prescr_medica.cd_setor_entrega%type;
nr_prescricao_orig_w		prescr_medica.nr_prescricao%type;
nr_prescricao_w    			prescr_medica.nr_prescricao%type;
ie_adep_orig_w				prescr_medica.ie_adep%type;
nr_horas_validade_w			prescr_medica.nr_horas_validade%type;
ie_adep_w					prescr_medica.ie_adep%type := 'N';

nr_seq_item_ww				rep_item_eliminado.nr_seq_item%type;
ds_item_ww					rep_item_eliminado.ds_item%type;
ie_tipo_item_ww				rep_item_eliminado.ie_tipo_item%type;

cd_material_w				material.cd_material%type;

ie_esquema_alternado_w		prescr_solucao.ie_esquema_alternado%type;
nr_seq_solucao_w			prescr_solucao.nr_seq_solucao%type;
qt_tempo_aplicacao_w		prescr_solucao.qt_tempo_aplicacao%type;
nr_etapas_w					prescr_solucao.nr_etapas%type;
ds_horarios_sol_w			prescr_solucao.ds_horarios%type := '';
ds_horarios_sol_2w			varchar(2000);

cd_perfil_w					perfil.cd_perfil%type;
cd_estabelecimento_w		estabelecimento.cd_estabelecimento%type;
cd_estab_usuario_w			integer;

cd_setor_usuario_w			setor_atendimento.cd_setor_atendimento%type;
cd_setor_prescr_w			setor_atendimento.cd_setor_atendimento%type := null;

ie_copia_dieta_w			rep_regra_copia_crit.ie_copiar%type;
ie_copia_jejum_w			rep_regra_copia_crit.ie_copiar%type;
ie_copiar_sup_nutricional_w	rep_regra_copia_crit.ie_copiar%type;
ie_copiar_npt_neonatal_w	rep_regra_copia_crit.ie_copiar%type;
ie_copiar_recomendacao_w	rep_regra_copia_crit.ie_copiar%type;
ie_copiar_bco_sangue_w		rep_regra_copia_crit.ie_copiar%type;
ie_copiar_gasoterapia_w		rep_regra_copia_crit.ie_copiar%type;
ie_copiar_hemodialise_w		rep_regra_copia_crit.ie_copiar%type;
ie_copiar_leites_deriv_w	rep_regra_copia_crit.ie_copiar%type;
ie_copia_dialise_w		rep_regra_copia_crit.ie_copia_dialise%type;
ie_copiar_npt_pediatrica_w	rep_regra_copia_crit.ie_copiar%type;

nr_seq_dieta_w				prescr_dieta.nr_sequencia%type;

qt_material_w				prescr_material.qt_material%type;
qt_unitaria_w				prescr_material.qt_unitaria%type;
nr_ocorrencia_w				prescr_material.nr_ocorrencia%type;
qt_total_dispensar_w		prescr_material.qt_total_dispensar%type;
cd_unidade_medida_dose_w	prescr_material.cd_unidade_medida_dose%type;
ie_se_necessario_w			prescr_material.ie_se_necessario%type;
ie_acm_w					prescr_material.ie_acm%type;
qt_dia_prim_hor_w			prescr_material.qt_dia_prim_hor%type;
nr_seq_material_w			prescr_material.nr_sequencia%type;
ie_regra_disp_w				prescr_material.ie_regra_disp%type;
nr_seq_mat_orig_w			prescr_material.nr_sequencia_anterior%type;
ie_via_aplicacao_w			prescr_material.ie_via_aplicacao%type;

cd_intervalo_w				intervalo_prescricao.cd_intervalo%type;

ie_considera_adep_w			regra_copia_rep.ie_considera_adep%type;

-- Parametros de base
ds_param_funcao_w			funcao_param_usuario.vl_parametro%type;
nm_maquina_w				computador.nm_computador%type;
qt_param_funcao_w			double precision;

--Parametros da REP
vl_param_42_w				varchar(2);
vl_param_44_w				varchar(5);
vl_param_60_w				varchar(5);
vl_param_85_w				varchar(5);
vl_param_98_w				varchar(5);
vl_param_111_w				varchar(5);
vl_param_135_w				varchar(5);
vl_param_167_w				varchar(5);
vl_param_254_w				varchar(5)	:= 'S';
vl_param_348_w				bigint	:= 0;
vl_param_370_w				varchar(10);
vl_param_380_w				varchar(5)	:= 'S';
vl_param_434_w				varchar(5);
vl_param_496_w				varchar(5);
vl_param_497_w				varchar(255);
vl_param_694_w				varchar(5);
vl_param_699_w				varchar(255);
vl_param_1059_w				varchar(5);
vl_param_1062_w				varchar(5);
vl_param_52_w				varchar(5) := 'S';
vl_param_813_w				varchar(5);
vl_param_996_w				varchar(15);
vl_param_1091_w				bigint;

dt_prescricao_w    			timestamp := dt_prescricao_p;
dt_prescricao_ww			timestamp;
dt_entrada_w				timestamp;
dt_primeiro_horario_w		timestamp;
dt_inicio_prescr_w			timestamp;
dt_validade_prescr_w		timestamp;
dt_proxima_dose_w			timestamp;
dt_horario_w				timestamp;
dt_proxima_dose_orig_w		timestamp;
dt_prim_hor_sol_w			timestamp;

vl_param_copia_14_w			varchar(1);
ie_origem_inf_w				varchar(1);
qt_hora_intervalo_w			double precision;
qt_registro_w				bigint;
ds_erro_w					varchar(2000);
hr_prim_horario_w			varchar(5);
nr_prescricoes_w			varchar(4000);
nr_prescrioes_ww			varchar(2000) := '';
ie_motivo_prescr_w			varchar(5);
ie_copia_motivo_w			varchar(10);
ie_excluir_iguais_w			varchar(5);
ie_copia_obs_prescr_w		varchar(2);
ie_permite_prescr_w			varchar(10);

cd_setor_rn_w				integer;
cd_setor_mae_w				integer;
ie_setor_mae_w				char(1) := 'N';
ie_limpa_prim_hor_w			varchar(1);
ie_hemodialise_w			prescr_solucao.ie_hemodialise%type;

c001 CURSOR FOR
SELECT	nr_prescricao
from	prescr_medica a
where	((ie_considera_adep_w = 'S') or (coalesce(a.ie_adep,'N') <> 'N'))
and		coalesce(ie_emergencia,'N')	<> 'S'
and		not exists (	SELECT 1 from cirurgia b where a.nr_prescricao = b.nr_prescricao LIMIT 1)
and		((coalesce(hr_prescr_inicial_p::text, '') = '') or (dt_prescricao >= to_date(to_char(dt_prescricao, 'dd/mm/yyyy') || hr_prescr_inicial_p, 'dd/mm/yyyy hh24:mi')))
and		((coalesce(hr_prescr_final_p::text, '') = '') or (dt_prescricao <= to_date(to_char(dt_prescricao, 'dd/mm/yyyy') || hr_prescr_final_p, 'dd/mm/yyyy hh24:mi')))
and		((coalesce(vl_param_497_w::text, '') = '') or (obter_se_contido_char(a.ie_funcao_prescritor,vl_param_497_w) = 'S'))
and		((coalesce(vl_param_348_w,0) <= 0) or
		 ((dt_prescricao >= clock_timestamp() - vl_param_348_w/24) and (vl_param_1059_w = 'P')) or
		 ((dt_inicio_prescr >= clock_timestamp() - vl_param_348_w/24) and (vl_param_1059_w = 'V')) or
		 ((dt_validade_prescr >= clock_timestamp() - vl_param_348_w/24) and (vl_param_1059_w = 'F')) or
		 (dt_validade_prescr = dt_validade_prescr_w AND vl_param_1059_w = 'I'))
and		((vl_param_1062_w = 'S') or (coalesce(a.nr_seq_atend::text, '') = ''))		
and		((coalesce(vl_param_434_w,'S')	= 'S') or (coalesce(ie_prescr_farm,'N')	= 'N'))
and		((coalesce(vl_param_996_w,'N') = 'S') or ( a.cd_estabelecimento = coalesce(wheb_usuario_pck.get_cd_estabelecimento, cd_estabelecimento_w)))
and		nr_prescricao 		= nr_prescricao_p
and		coalesce(nr_prescricoes_p::text, '') = ''
and		((coalesce(ie_hemodialise,'X') not in ('E','S')) or (ie_copiar_hemodialise_w <> 'N') or (ie_copia_dialise_w <> 'P'))

union

select	nr_prescricao
from	prescr_medica a
where	((ie_considera_adep_w = 'S') or (coalesce(a.ie_adep,'N') <> 'N'))
and		((coalesce(vl_param_699_w::text, '') = '') or (obter_se_contido(obter_classif_setor(a.cd_setor_atendimento), vl_param_699_w) = 'S'))
and		coalesce(ie_emergencia,'N')	<> 'S'
and		(((vl_param_370_w	= 'N') or (a.dt_liberacao_medico IS NOT NULL AND a.dt_liberacao_medico::text <> '') and (a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')) or
		((vl_param_370_w	= 'E') and (a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '') and (coalesce(a.dt_liberacao_medico::text, '') = '' )) or	
		(vl_param_370_w	= 'M' AND a.dt_liberacao_medico IS NOT NULL AND a.dt_liberacao_medico::text <> ''))
and		((vl_param_1062_w = 'S') or (coalesce(a.nr_seq_atend::text, '') = ''))
and		((coalesce(vl_param_996_w,'N') = 'S') or ( a.cd_estabelecimento = coalesce(wheb_usuario_pck.get_cd_estabelecimento, cd_estabelecimento_w)))
and		not exists ( select 1 from cirurgia b where a.nr_prescricao = b.nr_prescricao LIMIT 1)
and		((coalesce(vl_param_434_w,'S')	= 'S') or (coalesce(ie_prescr_farm,'N')	= 'N'))
and		((coalesce(vl_param_497_w::text, '') = '') or (obter_se_contido_char(a.ie_funcao_prescritor,vl_param_497_w) = 'S'))
and		nr_prescricao			<> nr_prescricao_w
and		nr_prescricao			<> nr_prescricao_p
and		nr_prescricao_mae 		= nr_prescricao_p
and		ie_agrupamento_p = 1
and		((coalesce(ie_hemodialise,'X') not in ('E','S')) or (ie_copiar_hemodialise_w <> 'N') or (ie_copia_dialise_w <> 'P'))

union

select	nr_prescricao
from	prescr_medica a
where	((ie_considera_adep_w = 'S') or (coalesce(a.ie_adep,'N') <> 'N'))
and		(((dt_prescricao >= clock_timestamp() - vl_param_348_w/24) and (vl_param_1059_w = 'P')) or
		 ((dt_inicio_prescr >= clock_timestamp() - vl_param_348_w/24) and (vl_param_1059_w = 'V')) or
		 ((dt_validade_prescr >= clock_timestamp() - vl_param_348_w/24) and (vl_param_1059_w = 'F')) or
		 (dt_validade_prescr = dt_validade_prescr_w AND vl_param_1059_w = 'I') or
		 ((coalesce(vl_param_348_w,0) <= 0) and (trunc(dt_prescricao,'dd') = dt_prescricao_ww)))
and		((coalesce(hr_prescr_inicial_p::text, '') = '') or (dt_prescricao >= to_date(to_char(dt_prescricao, 'dd/mm/yyyy') || hr_prescr_inicial_p, 'dd/mm/yyyy hh24:mi')))
and		((coalesce(hr_prescr_final_p::text, '') = '') or (dt_prescricao <= to_date(to_char(dt_prescricao, 'dd/mm/yyyy') || hr_prescr_final_p, 'dd/mm/yyyy hh24:mi')))
and		coalesce(ie_emergencia,'N')	<> 'S'
and		nr_prescricao			<> nr_prescricao_w
and		((coalesce(vl_param_699_w::text, '') = '') or (obter_se_contido(obter_classif_setor(a.cd_setor_atendimento), vl_param_699_w) = 'S'))
and		((vl_param_1062_w = 'S') or (coalesce(a.nr_seq_atend::text, '') = ''))
and		((coalesce(vl_param_497_w::text, '') = '') or (obter_se_contido_char(a.ie_funcao_prescritor,vl_param_497_w) = 'S'))
and		((coalesce(vl_param_996_w,'N') = 'S') or ( a.cd_estabelecimento = coalesce(wheb_usuario_pck.get_cd_estabelecimento, cd_estabelecimento_w)))
and		(((vl_param_52_w = 'F') and (Obter_Dados_Usuario_Opcao(a.nm_usuario_original,'F') = ie_origem_inf_w)) or
		 (vl_param_52_w = 'S' AND ie_origem_inf = '1') or
		 ((vl_param_52_w = 'A') and ((Obter_Dados_Usuario_Opcao(a.nm_usuario_original,'F') = ie_origem_inf_w) or (a.ie_prescr_farm = 'S'))) or (vl_param_52_w = 'N'))
and		((vl_param_496_w		= 'S') or (coalesce(a.IE_MOTIVO_PRESCRICAO::text, '') = ''))
and		(((vl_param_370_w	= 'N') or (a.dt_liberacao_medico IS NOT NULL AND a.dt_liberacao_medico::text <> '' AND a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')) or
		 (vl_param_370_w	= 'M' AND a.dt_liberacao_medico IS NOT NULL AND a.dt_liberacao_medico::text <> '') or
		 ((vl_param_370_w 	= 'E') and (a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '') and (coalesce(a.dt_liberacao_medico::text, '') = ''))) 	
and		((vl_param_254_w = 'N') or (vl_param_254_w = 'S' AND nr_atendimento = nr_atendimento_p))
and		not exists (select 1 from cirurgia b where a.nr_prescricao = b.nr_prescricao LIMIT 1)
and		((coalesce(vl_param_434_w,'S')	= 'S') or (coalesce(ie_prescr_farm,'N')	= 'N'))
and		nr_prescricao			<> nr_prescricao_p
and		cd_pessoa_fisica		= cd_pessoa_fisica_ww
and		ie_agrupamento_p		= 2
and		((coalesce(ie_hemodialise,'X') not in ('E','S')) or (ie_copiar_hemodialise_w <> 'N') or (ie_copia_dialise_w <> 'P'))

union

select	nr_prescricao
from	prescr_medica a
where	((ie_considera_adep_w = 'S') or (coalesce(a.ie_adep,'N') <> 'N'))
and		((coalesce(vl_param_699_w::text, '') = '') or (obter_se_contido(obter_classif_setor(a.cd_setor_atendimento), vl_param_699_w) = 'S'))
and		((vl_param_1062_w = 'S') or (coalesce(a.nr_seq_atend::text, '') = ''))
and		nr_prescricoes_w  like	'% ' || nr_prescricao || ' %'
and		not exists ( select 1 from cirurgia b where a.nr_prescricao = b.nr_prescricao LIMIT 1)
and		coalesce(ie_emergencia,'N')	<> 'S'
and		((coalesce(vl_param_497_w::text, '') = '') or (obter_se_contido_char(a.ie_funcao_prescritor,vl_param_497_w) = 'S'))
and		((coalesce(vl_param_996_w,'N') = 'S') or ( a.cd_estabelecimento = coalesce(wheb_usuario_pck.get_cd_estabelecimento, cd_estabelecimento_w)))
and		((coalesce(vl_param_434_w,'S')	= 'S') or (coalesce(ie_prescr_farm,'N')	= 'N'))
and		((coalesce(ie_hemodialise,'X') not in ('E','S')) or (ie_copiar_hemodialise_w <> 'N') or (ie_copia_dialise_w <> 'P'))
and		(nr_prescricoes_w IS NOT NULL AND nr_prescricoes_w::text <> '')
and		cd_pessoa_fisica		= cd_pessoa_fisica_ww;

c05 CURSOR FOR
SELECT	nr_sequencia
from	prescr_material a
where	a.ie_agrupador	in (1,2,5)
and		a.nr_prescricao 	= nr_prescricao_w;

C08 CURSOR FOR
SELECT	b.nr_seq_solucao,
		a.dt_primeiro_horario,
		b.nr_etapas,
		b.qt_tempo_aplicacao,
		coalesce(b.ie_esquema_alternado,'N'),
		b.hr_prim_horario,
		coalesce(b.ie_hemodialise,'N')
from	prescr_solucao b,
		prescr_medica a
where	coalesce(b.ie_calc_aut,'S')	= 'S'
and		a.nr_prescricao	= b.nr_prescricao
and		a.nr_prescricao	= nr_prescricao_w;

C09 CURSOR FOR
SELECT	b.nr_sequencia,
		obter_ocorrencia_intervalo(b.cd_intervalo,coalesce(a.nr_horas_validade,24),'H'),
		b.dt_proxima_dose,
		b.nr_sequencia_anterior,
		coalesce(b.nr_prescricao_anterior,b.nr_prescricao_original),
		b.cd_material,
		b.cd_intervalo,
		b.hr_prim_horario
from	prescr_material b,
		prescr_medica a
where	obter_se_interv_superior_24h(b.cd_intervalo,null) = 'S'
and		b.ie_origem_inf	<> 'K'
and		b.ie_agrupador	in (1, 2)
and		a.nr_prescricao	= b.nr_prescricao
and		a.nr_prescricao	= nr_prescricao_w;

C013 CURSOR FOR
SELECT	nr_sequencia
from	prescr_dieta
where	nr_prescricao 	= nr_prescricao_w;

c26 CURSOR FOR
SELECT	a.nr_sequencia,
		b.ds_material,
		'M' ie_tipo_item
from	material b,
		prescr_material a
where	a.cd_material 	= b.cd_material
and		(a.dt_suspensao IS NOT NULL AND a.dt_suspensao::text <> '')
and		coalesce(a.nr_seq_kit::text, '') = ''
and		coalesce(a.nr_sequencia_diluicao::text, '') = ''
and		coalesce(a.nr_sequencia_proc::text, '') = ''
and		a.nr_prescricao	= nr_prescricao_orig_w

union all

SELECT	a.nr_sequencia,
		b.ds_procedimento,
		'P' ie_tipo_item
from	procedimento b,
		prescr_procedimento a
where	a.cd_procedimento	= b.cd_procedimento
and		a.ie_origem_proced	= b.ie_origem_proced
and		(a.dt_suspensao IS NOT NULL AND a.dt_suspensao::text <> '')
and		a.nr_prescricao		= nr_prescricao_orig_w

union all

select	a.nr_sequencia,
		b.ds_tipo_recomendacao,
		'R' ie_tipo_item
from	tipo_recomendacao b,
		prescr_recomendacao a
where	a.cd_recomendacao	= b.cd_tipo_recomendacao
and		(a.dt_suspensao IS NOT NULL AND a.dt_suspensao::text <> '')
and		a.nr_prescricao		= nr_prescricao_orig_w

union all

select	a.nr_sequencia,
		b.ds_dieta,
		'D' ie_tipo_item
from	dieta b,
		prescr_dieta a
where	a.cd_dieta	= b.cd_dieta
and		(a.dt_suspensao IS NOT NULL AND a.dt_suspensao::text <> '')
and		a.nr_prescricao		= nr_prescricao_orig_w;


BEGIN

ie_copia_motivo_w := wheb_assist_pck.obterValorParametroREP(656, ie_copia_motivo_w);
ie_motivo_prescr_w := wheb_assist_pck.obterValorParametroREP(724, ie_motivo_prescr_w);
vl_param_996_w := wheb_assist_pck.obterValorParametroREP(996, vl_param_996_w);
ie_copia_obs_prescr_w := wheb_assist_pck.obterValorParametroREP(1002, ie_copia_obs_prescr_w);

select	coalesce(max(cd_estabelecimento),1),
		max(dt_validade_prescr)
into STRICT	cd_estabelecimento_w,
		dt_validade_prescr_w
from	prescr_medica
where	nr_prescricao = nr_prescricao_p;

nr_prescricoes_w	:= ' ' || nr_prescricoes_p || ' ';
nr_prescricoes_w	:= replace(nr_prescricoes_w, ',',' ');
nr_prescricoes_w	:= replace(nr_prescricoes_w, '  ',' ');

cd_perfil_w	:= cd_perfil_p;
cd_estab_usuario_w := coalesce(wheb_usuario_pck.get_cd_estabelecimento, cd_estabelecimento_w);

if	((coalesce(cd_estabelecimento_w,0) > 0) and (coalesce(vl_param_996_w,'N') = 'S')) then
	cd_estab_usuario_w	:= cd_estabelecimento_w;
end if;

vl_param_copia_14_w := Obter_param_usuario(-16, 14, cd_perfil_w, nm_usuario_p, cd_estabelecimento_w, vl_param_copia_14_w);

CALL Wheb_assist_pck.set_informacoes_usuario(coalesce(wheb_usuario_pck.get_cd_estabelecimento, cd_estabelecimento_w), cd_perfil_w, nm_usuario_p);

if	((coalesce(nr_atendimento_p,0) > 0) or (Wheb_assist_pck.obterParametroFuncao(924,44) = 'S')) then
	
	if (coalesce(nr_atendimento_p,0) = 0) then
		-- Quantidade de horas para prescricoes sem atendimento
		vl_param_1091_w	:= Campo_Numerico(Wheb_assist_pck.obterParametroFuncao(924,1091));

		if (coalesce(vl_param_1091_w,0) > 0) then
			qt_param_funcao_w	:= vl_param_1091_w;
		end if;	
	else
		-- Quantidade de horas para prescricoes com atendimento
		qt_param_funcao_w	:= Campo_Numerico(Wheb_assist_pck.obterParametroFuncao(924,22));
	end if;
	
	if	((clock_timestamp() + qt_param_funcao_w / 24) < dt_prescricao_p) then
		-- A data da prescricao nao pode ser superior a #@QT_HORAS#@ horas a partir deste momento!
		CALL Wheb_mensagem_pck.exibir_mensagem_abort(173469, 'QT_HORAS=' || qt_param_funcao_w);
	end if;
end if;

vl_param_42_w	:= Wheb_assist_pck.obterParametroFuncao(924,42);
if (vl_param_42_w = 'U') then
	begin
	cd_setor_usuario_w	:= obter_setor_usuario(nm_usuario_p);

	select	count(*)
	into STRICT	qt_registro_w
	from	setor_atendimento a
	where	a.cd_setor_atendimento in (	SELECT	b.cd_setor_atendimento
						from	atend_paciente_unidade b
						where	b.nr_atendimento	= nr_atendimento_p
						and	b.cd_setor_atendimento	= cd_setor_usuario_w );
	exception
	when others then
		qt_registro_w	:= 0;
	end;
end if;

if (vl_param_42_w = 'C') then
    nm_maquina_w := substr(wheb_usuario_pck.get_machine,position('\' in wheb_usuario_pck.get_machine) /*'*/+ 1, 40);   --Colocado o /*'*/
 devido ao tratamento realizado no instr()
	Select 	max(cd_setor_atendimento)
	into	cd_setor_prescr_w
	from	computador
	where	upper(nm_computador) = upper(nm_maquina_w); 
elsif	(vl_param_42_w = 'R') then
	cd_setor_prescr_w	:= Obter_setor_prescr_regra(cd_perfil_p);
elsif	(vl_param_42_w = 'A') then
	cd_setor_prescr_w		:= Obter_unidade_atendimento(nr_atendimento_p,'A','CS');
elsif	(vl_param_42_w = 'B') then
	cd_setor_prescr_w		:= null;
elsif	(vl_param_42_w = 'U') and 
		(((nr_atendimento_p > 0) and (qt_registro_w > 0)) or
		 ((obter_valor_param_usuario(924,136,cd_perfil_w,nm_usuario_p,cd_estabelecimento_w) = 'S'))) then
	cd_setor_prescr_w	:=	cd_setor_usuario_w;
elsif (vl_param_42_w = 'D') then
	begin
		select 	nvl(max(ie_rn_mae),'N'), 
				Nvl(max(cd_setor_atendimento),0)
		into 	ie_setor_mae_w, 
				cd_setor_mae_w
		from 	setor_atendimento
		where 	cd_setor_atendimento = obter_unidade_atendimento((select 	nvl(max(nr_atendimento_mae),0)
																  from		atendimento_paciente
																  where 	nr_atendimento = nr_atendimento_p),'A','CS');

		select 	nvl(max(a.cd_setor_atendimento),0)
		into 	cd_setor_rn_w
		from 	unidade_atendimento a
		where 	a.nr_seq_interno = (select 	nvl(b.nr_seq_unidade_rn,0) 
									from 	setor_atendimento b
								    where 	b.cd_setor_atendimento = obter_unidade_atendimento(nr_atendimento_p,'A','CS'));

		if (ie_setor_mae_w = 'S') and (cd_setor_mae_w = cd_setor_rn_w) then
			cd_setor_prescr_w := cd_setor_mae_w;
		else
			cd_setor_prescr_w := nvl(obter_unidade_atendimento(nr_atendimento_p,'A','CS'), 0);
		end if;
	end;
elsif	(nr_atendimento_p > 0) then
	cd_setor_prescr_w	:= nvl(obter_unidade_atendimento(nr_atendimento_p,'IA','CS'), obter_unidade_atendimento(nr_atendimento_p,'A','CS'));
end if;

select	nvl(max(ie_permite_prescricao),'S')
into	ie_permite_prescr_w
from	setor_atendimento
where	cd_setor_atendimento = cd_setor_prescr_w;

if	(ie_permite_prescr_w = 'N') then
      --'Nao e permitido fazer prescricoes para este setor!');
      Wheb_mensagem_pck.exibir_mensagem_abort(178458);
end if;


vl_param_98_w	:= Wheb_assist_pck.obterParametroFuncao(924,98);
if	(vl_param_98_w	= 'R') then
	vl_param_98_w	:= obter_se_calcula_validade(cd_setor_prescr_w);
end if;

qt_param_funcao_w	:= Campo_Numerico(Wheb_assist_pck.obterParametroFuncao(924,23));

if	(to_char(dt_prescricao_p,'hh24') >= to_char(qt_param_funcao_w)) and
	(trunc(dt_prescricao_p) = trunc(sysdate)) then
	--Prescricoes para o mesmo dia so podem ser feitas ate as #@QT_HORA#@ horas!
	Wheb_mensagem_pck.exibir_mensagem_abort(173474, 'QT_HORA=' || qt_param_funcao_w);
end if;

if	(nr_atendimento_p > 0) then
	select	dt_entrada
	into	dt_entrada_w
	from	atendimento_paciente
	where	nr_atendimento = nr_atendimento_p;

	if	(dt_entrada_w > dt_prescricao_p) then
		--A data da prescricao nao pode ser menor que a data de entrada do atendimento. #@DT_ENTRADA#@
		Wheb_mensagem_pck.exibir_mensagem_abort(173486, 'DT_ENTRADA=' || dt_entrada_w);
	end if;
end if;

Select Prescr_medica_seq.nextval
into  nr_prescricao_w
from dual;

nr_nova_prescricao_p	:=	nr_prescricao_w;

select 	nvl(max('1'),'3')
into	ie_origem_inf_w
from	Medico b,
	Usuario a
where 	a.nm_usuario		= nm_usuario_p
  and	a.cd_pessoa_fisica	= b.cd_pessoa_fisica
  and	b.ie_situacao		= 'A';

begin
select	cd_pessoa_fisica
into	cd_prescritor_w
from	usuario
where	nm_usuario = nm_usuario_p;
exception
when others then
	cd_prescritor_w	:= null;
end;


begin
Select	cd_pessoa_fisica,
		trunc(dt_prescricao,'dd'),
		ie_adep
into	cd_pessoa_fisica_ww,
		dt_prescricao_ww,
		ie_adep_orig_w
from	prescr_medica
where	nr_prescricao = nr_prescricao_p;
exception
when others then
	--Nao existe a prescricao informada!
	Wheb_mensagem_pck.exibir_mensagem_abort(173465);
end;

if	(nr_atendimento_p > 0) then
	select	max(cd_pessoa_fisica)
	into	cd_pessoa_fisica_w
	from	atendimento_paciente
	where	nr_atendimento	= nr_atendimento_p;
else
	cd_pessoa_fisica_w	:= cd_pessoa_fisica_ww;
end if;

dt_primeiro_horario_w	:= to_date('30/12/1899' || substr(dt_primeiro_horario_p,1,5),'dd/mm/yyyy hh24:mi');

if	(cd_setor_prescr_w > 0) then
	select	nvl(max(ie_adep),'N')
	into	ie_adep_w
	from	setor_atendimento
	where	cd_setor_atendimento = cd_setor_prescr_w;
end if;

ds_param_funcao_w	:= obter_valor_param_usuario(924,246,cd_perfil_w,nm_usuario_p,cd_estabelecimento_w);
if	(ds_param_funcao_w = 'DS') then
	ie_adep_w := ie_adep_w; 
elsif	(ds_param_funcao_w = 'NV') then
	ie_adep_w := 'N';
elsif	(ds_param_funcao_w = 'SV') then
	ie_adep_w := 'S';
elsif	(ds_param_funcao_w in ('PV','PNV')) then
	ie_adep_w := ie_adep_orig_w;
end if;

if	(vl_param_98_w <> 'N') then
	nr_horas_validade_w	:= obter_horas_validade_prescr(	dt_primeiro_horario_w, 
														nr_atendimento_p,
														obter_valor_param_usuario(924,249,cd_perfil_w,nm_usuario_p,cd_estabelecimento_w),
														null,
														sysdate,
														null);
elsif	(obter_valor_param_usuario(924,523,cd_perfil_p,nm_usuario_p,cd_estabelecimento_w) = 'S') and
		(nr_horas_validade_p is not null) then
	nr_horas_validade_w := nr_horas_validade_p;
end if;

vl_param_167_w := Wheb_assist_pck.obterParametroFuncao(924,167);
if	(vl_param_167_w = 'S') then
	cd_setor_entrega_w := obter_setor_usuario(nm_usuario_p);
elsif (vl_param_167_w = 'P') and
	  (cd_setor_prescr_w is not null) then
	  cd_setor_entrega_w := cd_setor_prescr_w;
end if;

insert into prescr_medica (
		nr_prescricao,
		cd_pessoa_fisica,
		nr_atendimento,
		cd_medico,
		dt_prescricao,
		dt_atualizacao,
		nm_usuario,
		nm_usuario_original,
		ds_observacao,
		nr_horas_validade,
		cd_motivo_baixa,
		dt_baixa,
		dt_primeiro_horario,
		dt_liberacao,
		dt_emissao_setor,
		dt_emissao_farmacia,
		cd_setor_atendimento,
		dt_entrada_unidade,
		ie_recem_nato,
		ie_origem_inf,
		nr_prescricao_anterior,
		nr_prescricao_mae,
		cd_protocolo,
		nr_seq_protocolo,
		nr_cirurgia,
		nr_seq_agenda,
		cd_estabelecimento,
		ds_medicacao_uso,
		cd_prescritor,
		qt_altura_cm,
		qt_peso,
		ie_adep,
		ie_prescr_emergencia,
		ie_prescricao_alta,
		ie_hemodialise,
		nr_prescricoes,
		nr_seq_transcricao,
		ie_motivo_prescricao,
		nr_seq_regra_copia,
		cd_setor_entrega,
		ie_tipo_prescr_cirur)
select	nr_prescricao_w,
		cd_pessoa_fisica_w,
		decode(nr_atendimento_p,0,null,nr_atendimento_p),
		cd_medico_p,
		dt_prescricao_p,
		dt_prescricao_w,
		nm_usuario_p,
		nm_usuario_p,
		decode(ie_copia_obs_prescr_w,'S',ds_observacao,null) ds_observacao,
		nvl(nr_horas_validade_w,nr_horas_validade),
		null,
		null,
		dt_primeiro_horario_w,
		null,
		null,
		null,
		cd_setor_prescr_w,
		null,
		'N',
		ie_origem_inf_w,
		nr_prescricao_p,
		nr_prescricao_mae,
		cd_protocolo,
		nr_seq_protocolo,
		nr_cirurgia,
		null,
		cd_estab_usuario_w,
		ds_medicacao_uso,
		cd_prescritor_w,
		decode(obter_valor_param_usuario(924,381,cd_perfil_p,nm_usuario_p,cd_estabelecimento_w), 'S', obter_sinal_vital(nr_atendimento_P,obter_desc_expressao(283402)/*'Altura'*/), 0),	
		decode(obter_valor_param_usuario(924,380,cd_perfil_p,nm_usuario_p,cd_estabelecimento_w), 'S', 
			decode(obter_valor_param_usuario(924,319,cd_perfil_w,nm_usuario_p,cd_estabelecimento_w), 'S', 
				qt_peso, 
				obter_sinal_vital(nr_atendimento_P,'Peso')), 
			0),	
		ie_adep_w,
		'N',
		'N',
		ie_hemodialise,
		nr_prescricoes_p,
		decode(nr_seq_transcricao_p,0,null,nr_seq_transcricao_p),
		decode(ie_motivo_prescr_w,'',decode(ie_copia_motivo_w, 'S' ,decode(Obter_Se_exibe_motivo_REP(ie_motivo_prescricao, cd_perfil_p), 'S' ,ie_motivo_prescricao)),Obter_Se_exibe_motivo_REP(ie_motivo_prescr_w, cd_perfil_p), 'S' , ie_motivo_prescr_w), -- Copia motivo da Prescr
		nr_seq_regra_p,
		nvl(cd_setor_entrega_w, cd_setor_entrega),
		ie_tipo_prescr_cirur
from	prescr_medica
where	nr_prescricao = nr_prescricao_p;

insert into prescr_nutricao(
		nr_sequencia,
		dt_atualizacao,
		nm_usuario,
		dt_atualizacao_nrec,
		nm_usuario_nrec,
		nr_prescricao,
		ie_delegacao_total,
		ie_dieta_oral,
		ie_npt,
		ie_enteral,
		ie_suplemento,
		ds_observacao)
select	prescr_nutricao_seq.nextval,
		sysdate,
		nm_usuario_p,
		sysdate,
		nm_usuario_p,
		nr_prescricao_w,
		ie_delegacao_total,
		ie_dieta_oral,
		ie_npt,
		ie_enteral,
		ie_suplemento,
		ds_observacao
from	prescr_nutricao
where	nr_prescricao	= nr_prescricao_p;

commit;

nr_seq_material_w	:= 0;

select	nvl(max(ie_considera_ADEP),'S')
into	ie_considera_adep_w
from	Regra_copia_rep
where	nr_sequencia	= nr_seq_regra_p;

select	nvl(max(ie_copiar),'S')
into	ie_copia_dieta_w
from	rep_regra_copia_crit
where	ie_tipo_item	= 'DO'
and		nr_seq_regra	= nr_seq_regra_p;

select	nvl(max(ie_copiar),'N')
into	ie_copia_jejum_w
from	rep_regra_copia_crit
where	ie_tipo_item	= 'JE'
and		nr_seq_regra	= nr_seq_regra_p;

select	nvl(max(ie_copiar),'N')
into	ie_copiar_sup_nutricional_w
from	rep_regra_copia_crit
where	ie_tipo_item	= 'NPA'
and		nr_seq_regra	= nr_seq_regra_p;

select	nvl(max(ie_copiar),'N')
into	ie_copiar_npt_neonatal_w
from	rep_regra_copia_crit
where	ie_tipo_item	= 'NPN'
and		nr_seq_regra	= nr_seq_regra_p;

select	nvl(max(ie_copiar),'S')
into	ie_copiar_recomendacao_w
from	rep_regra_copia_crit
where	ie_tipo_item	= 'REC'
and		nr_seq_regra	= nr_seq_regra_p;

select	nvl(max(ie_copiar),'N')
into	ie_copiar_bco_sangue_w
from	rep_regra_copia_crit
where	ie_tipo_item	= 'BS'
and		nr_seq_regra	= nr_seq_regra_p;

select	nvl(max(ie_copiar),'N')
into	ie_copiar_gasoterapia_w
from	rep_regra_copia_crit
where	ie_tipo_item	= 'GAS'
and		nr_seq_regra	= nr_seq_regra_p;

select	nvl(max(ie_copiar),'N'),
	nvl(max(ie_copia_dialise),'P')
into	ie_copiar_hemodialise_w,
	ie_copia_dialise_w
from	rep_regra_copia_crit
where	ie_tipo_item	= 'DIA'
and	nr_seq_regra	= nr_seq_regra_p;

select	nvl(max(ie_copiar),'S')
into	ie_copiar_leites_deriv_w
from	rep_regra_copia_crit
where	ie_tipo_item	= 'LD'
and	nr_seq_regra	= nr_seq_regra_p;

select	nvl(max(ie_copiar),'S')
into	ie_copiar_npt_pediatrica_w
from	rep_regra_copia_crit
where	ie_tipo_item	= 'NPP'
and	nr_seq_regra	= nr_seq_regra_p;

select nvl(max(ie_limpa_prim_hor),'N')
into   ie_limpa_prim_hor_w
from   rep_regra_copia_crit
where  ie_tipo_item	= 'SOL'
and	   nr_seq_regra	= nr_seq_regra_p;

if	(ie_agrupamento_p <> 2) then
	vl_param_348_w	:= 0;
else
	vl_param_348_w	:= Campo_Numerico(Wheb_assist_pck.obterParametroFuncao(924,348));
end if;

vl_param_52_w		:= Wheb_assist_pck.obterParametroFuncao(924,52);
vl_param_60_w		:= Wheb_assist_pck.obterParametroFuncao(924,60);
vl_param_85_w		:= Wheb_assist_pck.obterParametroFuncao(924,85);
vl_param_111_w		:= Wheb_assist_pck.obterParametroFuncao(924,111);
vl_param_135_w		:= Wheb_assist_pck.obterParametroFuncao(924,135);
vl_param_254_w		:= Wheb_assist_pck.obterParametroFuncao(924,254);
vl_param_370_w		:= Wheb_assist_pck.obterParametroFuncao(924,370);
vl_param_434_w		:= Wheb_assist_pck.obterParametroFuncao(924,434);
vl_param_496_w		:= Wheb_assist_pck.obterParametroFuncao(924,496);
vl_param_497_w		:= Wheb_assist_pck.obterParametroFuncao(924,497);
vl_param_699_w		:= Wheb_assist_pck.obterParametroFuncao(924,699);
vl_param_813_w		:= Wheb_assist_pck.obterParametroFuncao(924,813);
vl_param_1059_w		:= Wheb_assist_pck.obterParametroFuncao(924,1059);
vl_param_1062_w		:= Wheb_assist_pck.obterParametroFuncao(924,1062);

open c001;
loop
fetch c001 into
	nr_prescricao_orig_w;
exit when c001%notfound;

	if	(ie_copia_dieta_w = 'S') then
		REP_copia_dieta(nr_prescricao_orig_w, nr_prescricao_w, dt_prescricao_w, nr_seq_regra_p, nm_usuario_p);
	end if;
	if	(ie_copia_jejum_w = 'S') then
		REP_copia_jejum(nr_prescricao_orig_w, nr_prescricao_w, nr_seq_regra_p, nm_usuario_p);
	end if;
	if	(ie_copiar_sup_nutricional_w = 'S') then
		REP_copia_sup_nutricional(nr_prescricao_orig_w, nr_prescricao_w, nr_seq_regra_p, nm_usuario_p);
	end if;
	if	(ie_copiar_npt_neonatal_w = 'S') then
		REP_copia_npt_neonatal(nr_prescricao_orig_w, nr_prescricao_w, nr_seq_regra_p, nm_usuario_p);
	end if;
	if	(ie_copiar_leites_deriv_w = 'S') then
		copia_leite_deriv(nr_prescricao_w, nr_prescricao_orig_w, nm_usuario_p,nr_seq_regra_p,null);
	end if;
	if	(ie_copiar_npt_pediatrica_w = 'S') then --Novo
		REP_copia_npt_pediatrica(nr_prescricao_orig_w, nr_prescricao_w, nr_seq_regra_p, nm_usuario_p);
	end if;
	REP_copia_suporte_nut(nr_prescricao_orig_w, nr_prescricao_w, dt_prescricao_p, nr_seq_regra_p, nr_seq_material_w, nm_usuario_p);
	REP_copia_suplemento(nr_prescricao_orig_w, nr_prescricao_w, dt_prescricao_p, nr_seq_regra_p, nr_seq_material_w, nm_usuario_p);
	rep_copia_npt_adulta_prot(nr_prescricao_orig_w, nr_prescricao_w, nr_seq_regra_p, nm_usuario_p);
	REP_copia_solucao(nr_prescricao_orig_w, nr_prescricao_w, nr_seq_regra_p, vl_param_85_w, dt_prescricao_w, vl_param_111_w, vl_param_135_w, nr_seq_material_w, nm_usuario_p);
	if	(ie_copiar_recomendacao_w = 'S') then
		REP_copia_recomendacao(nr_prescricao_orig_w, nr_prescricao_w, nr_seq_regra_p, dt_prescricao_w,nm_usuario_p);
	end if;
	if	(ie_copiar_bco_sangue_w = 'S') then
		REP_copia_banco_sangue(nr_prescricao_orig_w, nr_prescricao_w, vl_param_60_w, nr_seq_bco_w, nr_seq_regra_p, nm_usuario_p);
	end if;
	if	(ie_copiar_gasoterapia_w = 'S') then
		REP_copia_gasoterapia(nr_prescricao_orig_w, nr_prescricao_w, dt_prescricao_w, nr_seq_regra_p, nr_seq_material_w, nm_usuario_p);
	end if;
	REP_copia_avaliacao_cito(nr_prescricao_orig_w, nr_prescricao_w, nm_usuario_p);
	REP_copia_histopatologia(nr_prescricao_orig_w, nr_prescricao_w, nm_usuario_p);
	REP_copia_procedimento( nr_prescricao_orig_w, nr_prescricao_w, nr_seq_regra_p, dt_prescricao_w, dt_procedimento_p, ds_ind_clinica_p, cd_perfil_p, cd_prescritor_w,
				cd_setor_prescr_w, vl_param_60_w, ie_procedimento_p, ie_procedimento_p, nr_seq_bco_w, nr_seq_material_w, nm_usuario_p);
	REP_copia_medicamento(nr_prescricao_w, nr_seq_regra_p, nr_prescricoes_p, nr_prescricao_orig_w, ie_procedimento_p, dt_prescricao_p, substr(dt_primeiro_horario_p,1,5), ie_ajustar_qt_p, cd_perfil_p, nr_seq_material_w, nm_usuario_p, cd_funcao_ativa_p, cd_medic_posicionar_p);
	REP_copia_prescr_proc_glic(nr_prescricao_orig_w, nr_prescricao_w, nm_usuario_p);
	if	(ie_copiar_hemodialise_w = 'S') then
		REP_copia_hemodialise(nr_prescricao_orig_w, nr_prescricao_w, dt_prescricao_p, nr_seq_regra_p, nr_seq_material_w, nm_usuario_p);
	end if;
	if	(vl_param_813_w <> 'S') then
		REP_copia_diluente(nr_prescricao_orig_w, nr_prescricao_w, nr_seq_material_w, nm_usuario_p);
	end if;
	
	if	(vl_param_copia_14_w = 'S') then
		open c26;
		loop
		fetch c26 into	
			nr_seq_item_ww,
			ds_item_ww,
			ie_tipo_item_ww;
		exit when c26%notfound;
		
			insert into rep_item_eliminado(
				nr_sequencia,
				nr_prescricao,
				nr_seq_item,
				ds_item,
				ie_tipo_item,
				dt_atualizacao,
				dt_atualizacao_nrec,
				nm_usuario,
				nm_usuario_nrec,
				ie_forma_apresentacao
			) values (
				rep_item_eliminado_seq.nextval,
				nr_prescricao_w,
				nr_seq_item_ww,
				ds_item_ww,
				ie_tipo_item_ww,
				sysdate,
				sysdate,
				nm_usuario_p,
				nm_usuario_p,
				'S');
			
		end loop;
		close c26;
	end if;
	
	select	nvl(max(nr_sequencia),0)
	into	nr_seq_material_w
	from	prescr_material
	where	nr_prescricao	= nr_prescricao_w;
	
	nr_prescrioes_ww := nr_prescrioes_ww || ','|| nr_prescricao_orig_w;
end loop;
close c001;

reordenar_medicamento(nr_prescricao_w);
Reordenar_Materiais_Pos_Copia(nr_prescricao_w);

select	max(dt_inicio_prescr),
		max(dt_validade_prescr)
into	dt_inicio_prescr_w,
		dt_validade_prescr_w
from	prescr_medica
where	nr_prescricao = nr_prescricao_w;

open c05;
loop
fetch c05 into
	nr_seq_material_w;
exit when c05%notfound;
	consistir_prescr_material(nr_prescricao_w, nr_seq_material_w, nm_usuario_p, cd_perfil_w, ds_erro_w);
end loop;
close c05;

Open c013;	
loop
fetch c013 into
	nr_seq_dieta_w;
exit when c013%notfound;
	Consistir_prescr_dieta(nr_prescricao_w,nr_seq_dieta_w,cd_estabelecimento_w,cd_perfil_w,nm_usuario_p,ds_erro_w); 
end loop;
close c013;


if	(obter_valor_param_usuario(924,146,cd_perfil_w,nm_usuario_p,cd_estabelecimento_w) = 'S') then
	update	prescr_material
	set		hr_prim_horario	= null,
			ds_horarios	= null
	where	ie_agrupador	= 8
	and		nr_prescricao	= nr_prescricao_w;
end if;

if	(obter_valor_param_usuario(924,207,cd_perfil_w,nm_usuario_p,cd_estabelecimento_w) = 'S') then
	update	prescr_material
	set		hr_prim_horario	= null,
			ds_horarios	= null
	where	nvl(ie_sem_aprazamento,'N')	= 'S'
	and		ie_agrupador	= 1
	and		nr_prescricao	= nr_prescricao_w;
end if;

open C08;
loop
fetch C08 into
	nr_seq_Solucao_w,
	dt_primeiro_horario_w,
	nr_etapas_w,
	qt_tempo_aplicacao_w,
	ie_esquema_alternado_w,
	hr_prim_horario_w,
	ie_hemodialise_w;
exit when C08%notfound;
	begin
	
	dt_prim_hor_sol_w := To_date(to_char(dt_primeiro_horario_w,'dd/mm/yyyy ')||hr_prim_horario_w, 'dd/mm/yyyy hh24:mi');
	if not	(obter_se_lib_prescr_vig_disp(dt_inicio_prescr_w, dt_validade_prescr_w, to_date(to_char(sysdate, 'dd/mm/yyyy ')||hr_prim_horario_w, 'dd/mm/yyyy hh24:mi')) = 'S') then	 
		dt_prim_hor_sol_w := dt_primeiro_horario_w;
	elsif	(dt_prim_hor_sol_w < dt_primeiro_horario_w )then
		dt_prim_hor_sol_w := dt_prim_hor_sol_w +1;
	end if;	
	Calcula_Horarios_Etapas(dt_prim_hor_sol_w,nr_etapas_w,dividir(qt_tempo_aplicacao_w,nr_etapas_w),nm_usuario_p,'N',qt_tempo_aplicacao_w,ds_horarios_sol_w,ds_horarios_sol_2w,'N',ie_hemodialise_w);

	ds_horarios_sol_w := ds_horarios_sol_w || ds_horarios_sol_2w;
	
	if	(ie_limpa_prim_hor_w = 'N') then		
		update	prescr_solucao
		set		ds_horarios	= substr(ds_horarios_sol_w,1,2000),
			hr_prim_horario	= to_char(dt_prim_hor_sol_w,'hh24:mi')
		where	nr_seq_solucao	= nr_seq_Solucao_w
		and		nr_prescricao	= nr_prescricao_w;
	end if;
	end;
end loop;
close C08;
--end if;
if	(nvl(Wheb_assist_pck.obterParametroFuncao(924,992),'S') <> 'N') then
	begin
	vl_param_694_w		:= Wheb_assist_pck.obterParametroFuncao(924,694);
	
	open C09;
	loop
	fetch C09 into
		nr_seq_material_w,
		qt_hora_intervalo_w,
		dt_proxima_dose_w,
		nr_seq_mat_orig_w,
		nr_prescricao_orig_w,
		cd_material_w,
		cd_intervalo_w,
		hr_prim_horario_w;
	exit when C09%notfound;
		begin

		hr_prim_horario_w	:= nvl(hr_prim_horario_w, to_char(dt_inicio_prescr_w, 'hh24:mi'));
		
		if (qt_hora_intervalo_w > 24) then
			if	(dt_proxima_dose_w is not null) and
				(dt_proxima_dose_w not between dt_inicio_prescr_w and dt_validade_prescr_w) then
				begin
				
				qt_dia_prim_hor_w := abs(dt_proxima_dose_w - dt_inicio_prescr_w);
				
				if	(qt_dia_prim_hor_w	< 0) then
					qt_dia_prim_hor_w	:= 0;
				end if;
			
				update	prescr_material
				set		ie_administrar	= 'N',
						hr_prim_horario	= to_char(dt_proxima_dose_w,'hh24:mi'),
						ds_horarios	= to_char(dt_proxima_dose_w,'hh24:mi'),
						qt_dia_prim_hor = qt_dia_prim_hor_w
				where	nr_sequencia	= nr_seq_material_w
				and		nr_prescricao	= nr_prescricao_w;
				end;
			end if;

			dt_proxima_dose_orig_w	:= dt_proxima_dose_w;
			dt_horario_w			:= null;
				
			if	(nr_seq_mat_orig_w is not null) then
				
				select	max(dt_proxima_dose),
						nvl(max(hr_prim_horario), hr_prim_horario_w)
				into	dt_proxima_dose_w,
						hr_prim_horario_w
				from	prescr_material
				where	((nvl(hr_prim_horario, hr_prim_horario_w) = hr_prim_horario_w) or (mod(qt_hora_intervalo_w,24) > 0))
				and		cd_intervalo = cd_intervalo_w
				and		cd_material = cd_material_w
				and		nr_sequencia = nr_seq_mat_orig_w
				and		nr_prescricao = nr_prescricao_orig_w;
				

				
				if	(dt_proxima_dose_w is null) then
					dt_proxima_dose_w	:= dt_proxima_dose_orig_w;
					
					select	max(dt_horario)
					into	dt_horario_w
					from	prescr_mat_hor
					where	nr_seq_material	= nr_seq_material_w
					and		nvl(ie_horario_especial,'N') <> 'S'
					and		nr_prescricao	= nr_prescricao_w;
				else
					
					update	prescr_material
					set		dt_proxima_dose	= dt_proxima_dose_w,
							dt_administrar 	= dt_proxima_dose_w
					where	nr_sequencia	= nr_seq_material_w
					and		nr_prescricao	= nr_prescricao_w;
				end if;
			else
			
				select	max(dt_horario)
				into	dt_horario_w
				from	prescr_mat_hor
				where	nr_seq_material	= nr_seq_material_w
				and		nvl(ie_horario_especial,'N') <> 'S'
				and		nr_prescricao	= nr_prescricao_w;
				
			
				dt_proxima_dose_w	:= dt_horario_w;
			end if;

			if	((dt_proxima_dose_w is null) or
				 (dt_proxima_dose_w between dt_inicio_prescr_w and dt_validade_prescr_w)) then
				begin
				
					if	(dt_proxima_dose_w is not null) then
						if	(dt_inicio_prescr_w > dt_proxima_dose_w) then
							qt_dia_prim_hor_w := trunc(dt_inicio_prescr_w) - trunc(dt_proxima_dose_w);
						else
							qt_dia_prim_hor_w := trunc(dt_proxima_dose_w) - trunc(dt_inicio_prescr_w);
						end if;
					else

						if	(hr_prim_horario_w < to_char(dt_inicio_prescr_w,'hh24:mi')) then

							qt_dia_prim_hor_w	:= 1;
						else
							qt_dia_prim_hor_w	:= 0;
						end if;
					end if;



					if	(qt_dia_prim_hor_w not between 0 and 1) then
						qt_dia_prim_hor_w	:= 0;
					end if;

					
					if	(mod(qt_hora_intervalo_w,24) > 0) and
						(dt_proxima_dose_w is not null) then
						update	prescr_material
						set		hr_prim_horario	= to_char(dt_proxima_dose_w,'hh24:mi'),
								ds_horarios		= to_char(dt_proxima_dose_w,'hh24:mi '),
								dt_administrar 	= dt_proxima_dose_w
						where	nr_sequencia	= nr_seq_material_w
						and		nr_prescricao	= nr_prescricao_w;
					end if;	
					
					dt_proxima_dose_w	:= nvl(dt_horario_w, dt_proxima_dose_w) + qt_hora_intervalo_w/24;
			
					if	((mod(qt_hora_intervalo_w,24) > 0)) then
						update	prescr_material
						set		dt_proxima_dose	= dt_proxima_dose_w,
								ie_administrar	= null,
								qt_dia_prim_hor	= qt_dia_prim_hor_w
						where	nr_sequencia	= nr_seq_material_w
						and		nr_prescricao	= nr_prescricao_w;
					else
				
						update	prescr_material
						set		hr_prim_horario	= to_char(dt_proxima_dose_w,'hh24:mi'),
								ds_horarios		= to_char(dt_proxima_dose_w,'hh24:mi '),
								dt_proxima_dose	= dt_proxima_dose_w,
								ie_administrar	= null,
								qt_dia_prim_hor	= qt_dia_prim_hor_w
						where	nr_sequencia	= nr_seq_material_w
						and		nr_prescricao	= nr_prescricao_w;
					end if;

				
				end;
			elsif	(vl_param_694_w = 'S') and
					(dt_proxima_dose_w is not null) and
					(dt_proxima_dose_w < dt_inicio_prescr_w) then
				begin
				
				if	((dt_horario_w is not null) and
					 (dt_horario_w	>= dt_inicio_prescr_w) and
					 (dt_horario_w	< dt_validade_prescr_w)) then
					dt_proxima_dose_w	:= dt_horario_w + qt_hora_intervalo_w/24;
				else
					dt_proxima_dose_w	:= dt_inicio_prescr_w + qt_hora_intervalo_w/24;
				end if;	
				
				qt_dia_prim_hor_w := to_char(dt_inicio_prescr_w,'dd') - to_char(dt_proxima_dose_w,'dd');
				if	(qt_dia_prim_hor_w	< 0) then
					qt_dia_prim_hor_w	:= 0;
				end if;
			
				update	prescr_material
				set		hr_prim_horario = to_char(dt_proxima_dose_w, 'hh24:mi'),
						dt_proxima_dose	= dt_proxima_dose_w,
						dt_administrar 	= dt_proxima_dose_w,
						ds_horarios		= to_char(dt_proxima_dose_w, 'hh24:mi'),
						qt_dia_prim_hor = qt_dia_prim_hor_w,
						ie_administrar	= null
				where	nr_sequencia	= nr_seq_material_w
				and		nr_prescricao	= nr_prescricao_w;
				
				end;		
			elsif	(dt_proxima_dose_w is not null) then
				begin
				
				qt_dia_prim_hor_w := to_char(dt_inicio_prescr_w,'dd') - to_char(dt_proxima_dose_w,'dd');
				if	(qt_dia_prim_hor_w	< 0) then
					qt_dia_prim_hor_w	:= 0;
				end if;
				
				update	prescr_material
				set		ie_administrar	= 'N',
						ie_regra_disp	= 'N',
						qt_dia_prim_hor	= qt_dia_prim_hor_w
				where	nr_sequencia	= nr_seq_material_w
				and		nr_prescricao	= nr_prescricao_w;

				update	prescr_material
				set		ie_administrar		= 'N',
						ie_regra_disp		= 'N'
				where	nr_sequencia_diluicao	= nr_seq_material_w
				and		nr_prescricao		= nr_prescricao_w;

				update	prescr_mat_hor
				set		ie_situacao	= 'I'
				where	nr_seq_material	= nr_seq_material_w
				and		nr_prescricao	= nr_prescricao_w;
				
				update	prescr_mat_hor
				set		ie_situacao	= 'I'
				where	nr_seq_superior	= nr_seq_material_w
				and		nr_prescricao	= nr_prescricao_w;
				
				end;
			end if;
		elsif	(vl_param_694_w = 'S') then
				dt_proxima_dose_orig_w	:= dt_proxima_dose_w;
				dt_horario_w			:= null;
					
				if	(nr_seq_mat_orig_w is not null) then
					
					hr_prim_horario_w	:= nvl(hr_prim_horario_w, to_char(dt_inicio_prescr_w, 'hh24:mi'));
					
					select	max(dt_proxima_dose)
					into	dt_proxima_dose_w
					from	prescr_material
					where	nvl(hr_prim_horario, hr_prim_horario_w) = hr_prim_horario_w
					and		cd_intervalo = cd_intervalo_w
					and		cd_material = cd_material_w
					and		nr_sequencia = nr_seq_mat_orig_w
					and		nr_prescricao = nr_prescricao_orig_w;
					
					if	(dt_proxima_dose_w is null) then
						dt_proxima_dose_w	:= dt_proxima_dose_orig_w;
						
						select	max(dt_horario)
						into	dt_horario_w
						from	prescr_mat_hor
						where	nr_seq_material	= nr_seq_material_w
						and		nr_prescricao	= nr_prescricao_w;
					else
						
						update	prescr_material
						set		dt_proxima_dose	= dt_proxima_dose_w,
								dt_administrar 	= dt_proxima_dose_w
						where	nr_sequencia	= nr_seq_material_w
						and		nr_prescricao	= nr_prescricao_w;
					end if;
				else
				
					select	max(dt_horario)
					into	dt_horario_w
					from	prescr_mat_hor
					where	nr_seq_material	= nr_seq_material_w
					and		nr_prescricao	= nr_prescricao_w;
				
					dt_proxima_dose_w	:= dt_horario_w;
				end if;
		
				if	(dt_proxima_dose_w is not null) and
					(dt_proxima_dose_w < dt_inicio_prescr_w) then
					begin
					
					if	((dt_horario_w is not null) and
						 (dt_horario_w	>= dt_inicio_prescr_w) and
						 (dt_horario_w	< dt_validade_prescr_w)) then
						dt_proxima_dose_w	:= dt_horario_w + qt_hora_intervalo_w/24;
					else
						dt_proxima_dose_w	:= dt_inicio_prescr_w + qt_hora_intervalo_w/24;
					end if;	
						
					hr_prim_horario_w	:= to_char(dt_proxima_dose_w, 'hh24:mi');
					
					select	max(ie_via_aplicacao),
							max(qt_unitaria),
							max(nr_ocorrencia),
							max(ie_origem_inf),
							max(cd_unidade_medida_dose),
							max(qt_material),
							max(qt_total_dispensar),
							nvl(max(ie_se_necessario), 'N'),
							nvl(max(ie_acm), 'N')
					into	ie_via_aplicacao_w,
							qt_unitaria_w,
							nr_ocorrencia_w,
							ie_origem_inf_w,
							cd_unidade_medida_dose_w,
							qt_material_w,
							qt_total_dispensar_w,
							ie_se_necessario_w,
							ie_acm_w
					from	prescr_material
					where	nr_sequencia = nr_seq_material_w
					and		nr_prescricao = nr_prescricao_w;
						
					Obter_Quant_Dispensar(cd_estabelecimento_w, cd_material_w, nr_prescricao_w, nr_seq_material_w, cd_intervalo_w,ie_via_aplicacao_w, qt_unitaria_w, 0,nr_ocorrencia_w, '',ie_origem_inf_w, cd_unidade_medida_dose_w, 1, qt_material_w, qt_total_dispensar_w, ie_regra_disp_w, ds_erro_w, ie_se_necessario_w, ie_acm_w);
					
					qt_dia_prim_hor_w	:= 0;
					if	(hr_prim_horario_w <> '') and
						(hr_prim_horario_w <> '  :  ') and
						(hr_prim_horario_w < to_char(dt_inicio_prescr_w,'hh24:mi')) then
						qt_dia_prim_hor_w	:= 1;
					end if;
					
					update	prescr_material
					set 	hr_prim_horario		= hr_prim_horario_w,
							dt_proxima_dose		= dt_proxima_dose_w,
							dt_administrar		= dt_proxima_dose_w,
							ds_horarios			= to_char(dt_proxima_dose_w, 'hh24:mi'),
							nr_ocorrencia		= nr_ocorrencia_w,
							qt_total_dispensar	= qt_total_dispensar_w,
							qt_material			= nvl(qt_material_w,1),
							ie_regra_disp		= decode(nvl(ie_regra_disp,'X'), 'D', ie_regra_disp, ie_regra_disp_w),
							qt_dia_prim_hor		= qt_dia_prim_hor_w
					where	nr_sequencia		= nr_seq_material_w
					and		nr_prescricao 		= nr_prescricao_w;
					
					end;
				end if;
		end if;
		end;
	end loop;
	close C09;
	
	end;
end if;

if	(instr(substr(nr_prescrioes_ww,1,length(nr_prescrioes_ww)-1),',') > 0) then
	wheb_assist_pck.obterValorParametroREP(429,ie_excluir_iguais_w);
	if	(ie_excluir_iguais_w	= 'S') then
		Excluir_item_prescr_duplic(nr_prescricao_w, nm_usuario_p);
	end if;	
end if;

/*Update para chamar a trigger da prescr_solucao para ajustar caso o volume da etapa estiver zerada.*/

update	prescr_solucao
set		dt_atualizacao	= dt_atualizacao
where	nr_prescricao	= nr_prescricao_w;

update	prescr_medica
set		ds_observacao_copia = 
			' Procedure origem: REP_Copia_Prescricao_regra ;  '
 || chr(13) ||
			obter_desc_expressao(781482, 'DT_COPIA'||to_char(sysdate,'dd/mm/yyyy hh24:mi:ss') || obter_desc_expressao(339327) || obter_funcao_ativa ||';NR_PRESCRICAO=' || nr_prescrioes_ww ||
			';DS_STACK='|| substr(dbms_utility.format_call_stack,1,2000))						
where	nr_prescricao = nr_prescricao_w;

commit;

nr_nova_prescricao_p	:= nr_prescricao_w;

select 	count(*)
into	qt_registro_w
from	adep_tipo_observacao
where  	nvl(ie_copia_prescr,'N') = 'S';

if (qt_registro_w > 0) then
	CALL copia_observacao_enf(nr_nova_prescricao_p,nm_usuario_p);
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE rep_copia_prescricao_regra ( nr_prescricao_p bigint, nr_atendimento_p bigint, nr_seq_regra_p bigint, nm_usuario_p text, cd_medico_p text, dt_prescricao_p timestamp, ie_procedimento_p text, nr_prescricoes_p text, dt_primeiro_horario_p text, ie_ajustar_qt_p text, cd_perfil_P bigint, ie_agrupamento_p bigint, ds_ind_clinica_p text, hr_prescr_inicial_p text, hr_prescr_final_p text, dt_procedimento_p timestamp, nr_horas_validade_p bigint, nr_seq_transcricao_p bigint default 0, nr_nova_prescricao_p INOUT bigint DEFAULT NULL, cd_funcao_ativa_p bigint DEFAULT NULL, cd_medic_posicionar_p INOUT bigint DEFAULT NULL) FROM PUBLIC;

