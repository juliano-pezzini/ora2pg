-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE schematic4test_execscriptmain (NR_SEQUENCIA_P bigint, IE_START_P bigint, NR_SEQ_PRESET_P bigint, NM_USUARIO_P text) AS $body$
DECLARE

NR_SEQUENCIA_W bigint;
NM_SCRIPT_W varchar(255);
NR_SEQ_PRESET_W bigint;
IE_START_W varchar(255);
NM_SUITE_W varchar(255);
NM_SUITE_W2 varchar(255);
NR_SEQ_SUITE_W bigint;
NR_SEQ_EXECUTION_W bigint;
NEWSEQUENCETEST bigint;
NEWSEQUENCESCHEDULE bigint;
NEWSEQUENCESUITE bigint;
NR_SEQ_URL_W bigint;
NR_SEQ_BROWSER_W bigint;
NR_SEQ_SERVICE_W bigint;
NR_SEQ_ROBOT_W bigint;
NR_SEQ_GRID_W bigint;
IE_RUNTYPE_W smallint;
IE_JOBS_W varchar(255);
NR_SEQ_EXECUTION_W2 bigint;
NR_SEQ_TEST_W bigint;
NR_SEQ_PRESET_W2 bigint;
QTD_W bigint;
NR_SEQ_SCHEDULE_W bigint;


BEGIN
  --procedure that execute script in Maintenance  
  INSERT INTO SCHEM_TEST_BEHOLDER(nr_sequencia, nm_usuario, dt_atualizacao, nm_usuario_nrec, dt_atualizacao_nrec, ds_interaction, ds_param_a, ds_param_b, ds_param_c)
	VALUES (nextval('schem_test_beholder_seq'), NM_USUARIO_P, clock_timestamp(), 'Robot', clock_timestamp(), 'SCHEMATIC4TEST_EXECSCRIPTMAIN', 
	'NR_SEQUENCIA_P as '||NR_SEQUENCIA_P, 
	'IE_START_P as '||IE_START_P, 
	'NR_SEQ_PRESET_P as '||NR_SEQ_PRESET_P);

  SELECT COUNT(schedule.NR_SEQUENCIA) QTD
    INTO STRICT QTD_W
	FROM SCHEM_TEST_SCRIPT script
  INNER JOIN SCHEM_TEST_TEST teste ON (teste.NR_SEQ_SCRIPT = script.NR_SEQUENCIA) 
  INNER JOIN SCHEM_TEST_SUITE suite ON (teste.NR_SEQ_SUITE = suite.NR_SEQUENCIA) 
  INNER JOIN SCHEM_TEST_SCHEDULE schedule ON (schedule.NR_SEQ_SUITE = suite.NR_SEQUENCIA) 
  WHERE script.NR_SEQUENCIA = NR_SEQUENCIA_P
  AND schedule.NM_USUARIO_NREC LIKE NM_USUARIO_P
  AND schedule.IE_JOBS <> '1'
  AND schedule.IE_STATUS = '2'
  AND suite.IE_TEST_LOCAL = '1';

  IF (QTD_W <> 0) THEN
    SELECT MAX(schedule.NR_SEQUENCIA)
        INTO STRICT NR_SEQ_SCHEDULE_W
      FROM SCHEM_TEST_SCRIPT script
      INNER JOIN SCHEM_TEST_TEST teste ON (teste.NR_SEQ_SCRIPT = script.NR_SEQUENCIA) 
      INNER JOIN SCHEM_TEST_SUITE suite ON (teste.NR_SEQ_SUITE = suite.NR_SEQUENCIA) 
      INNER JOIN SCHEM_TEST_SCHEDULE schedule ON (schedule.NR_SEQ_SUITE = suite.NR_SEQUENCIA) 
      WHERE script.NR_SEQUENCIA = NR_SEQUENCIA_P
      AND schedule.NM_USUARIO_NREC LIKE NM_USUARIO_P
      AND schedule.IE_JOBS <> '1'
      AND schedule.IE_STATUS = '2'
      AND suite.IE_TEST_LOCAL = '1';
      
      UPDATE SCHEM_TEST_SCHEDULE SET IE_STATUS = '5' WHERE NR_SEQUENCIA = NR_SEQ_SCHEDULE_W AND NM_USUARIO_NREC LIKE NM_USUARIO_P;
      COMMIT;
  END IF;

  SELECT DISTINCT script.NR_SEQUENCIA NR_SEQUENCIA, script.NM_SCRIPT NM_SCRIPT, script.NR_SEQ_PRESET NR_SEQ_PRESET, script.IE_START IE_START
      INTO STRICT NR_SEQUENCIA_W, NM_SCRIPT_W, NR_SEQ_PRESET_W, IE_START_W
	FROM SCHEM_TEST_SCRIPT script
  INNER JOIN SCHEM_TEST_PRESET preset ON (script.NR_SEQ_PRESET = preset.NR_SEQUENCIA)
  INNER JOIN SCHEM_TEST_GRID grid ON (preset.NR_SEQ_GRID = grid.NR_SEQUENCIA) 
  WHERE (script.NR_SEQ_PRESET IS NOT NULL AND script.NR_SEQ_PRESET::text <> '')
  AND script.NR_SEQUENCIA = NR_SEQUENCIA_P;

  SELECT preset.NR_SEQ_URL NR_SEQ_URL, preset.NR_SEQ_BROWSER NR_SEQ_BROWSER, preset.NR_SEQ_SERVICE NR_SEQ_SERVICE, preset.NR_SEQ_ROBOT NR_SEQ_ROBOT, preset.NR_SEQ_GRID NR_SEQ_GRID, preset.IE_RUNTYPE IE_RUNTYPE
     INTO STRICT NR_SEQ_URL_W, NR_SEQ_BROWSER_W, NR_SEQ_SERVICE_W, NR_SEQ_ROBOT_W, NR_SEQ_GRID_W, IE_RUNTYPE_W
  FROM SCHEM_TEST_PRESET preset WHERE preset.NR_SEQUENCIA = NR_SEQ_PRESET_P;

  UPDATE SCHEM_TEST_PRESET SET DT_LAST = clock_timestamp() WHERE NR_SEQUENCIA = NR_SEQ_PRESET_W;
  COMMIT;

  IF (IE_START_P = 1) THEN
    NM_SUITE_W := 'Creating - Maintenance - '||NM_SCRIPT_W;
    IE_JOBS_W := '4';
    IE_START_W := '1';
  ELSE
    IF (IE_START_P = 2) THEN  
      NM_SUITE_W := 'Test - Maintenance - '||NM_SCRIPT_W;
      IE_JOBS_W := '0';
      IE_START_W := '2';
    END IF;
  END IF;
      
  SELECT nextval('schem_test_suite_seq')     
      INTO STRICT NEWSEQUENCESUITE
;
  
  SELECT MAX(suite.NR_SEQUENCIA) NR_SEQUENCIA
      INTO STRICT NR_SEQ_SUITE_W
  FROM SCHEM_TEST_SUITE suite 
  WHERE suite.NM_SUITE like NM_SUITE_W
  AND suite.IE_JOBS <> '666';
  
  NM_SUITE_W2 := replace(replace(replace(replace(replace(NM_SUITE_W,chr(38)||'amp;','&'),chr(38)||'lt;','<'),chr(38)||'gt;','>'),chr(38)||'apos;', chr(39)),chr(38)||'quot;',chr(34));

  INSERT INTO SCHEM_TEST_SUITE(nr_sequencia, nm_suite, ds_version, ie_runtype, nm_owner, dt_last, dt_atualizacao, nm_usuario, dt_atualizacao_nrec, nr_seq_preset, ds_repo, ie_jobs, ie_test_local, nm_usuario_nrec, ie_situacao) 
      VALUES (NEWSEQUENCESUITE, NM_SUITE_W2, '0', 2, NM_USUARIO_P, clock_timestamp(), clock_timestamp(), NM_USUARIO_P, clock_timestamp(), NR_SEQ_PRESET_P, '0', IE_JOBS_W, '1', NM_USUARIO_P, 'I');
  COMMIT;
      
  IF (coalesce(NR_SEQ_EXECUTION_W::text, '') = '') THEN 
      NR_SEQ_EXECUTION_W := 0;
  END IF;
  
  SELECT nextval('schem_test_test_seq')     
      INTO STRICT NEWSEQUENCETEST
;
       
  INSERT INTO SCHEM_TEST_TEST(nr_sequencia, nr_seq_execution, nr_seq_script, nr_seq_suite, nr_seq_robot, nr_seq_grid, dt_atualizacao, nm_usuario, dt_atualizacao_nrec, nm_usuario_nrec, ie_jobs, ie_switch) 
      VALUES (NEWSEQUENCETEST, NR_SEQ_EXECUTION_W+5, NR_SEQUENCIA_W, NEWSEQUENCESUITE, NR_SEQ_ROBOT_W, NR_SEQ_GRID_W, clock_timestamp(), NM_USUARIO_P, clock_timestamp(), NM_USUARIO_P, IE_JOBS_W, '1');
  COMMIT;
  
  SELECT NR_SEQ_PRESET 
      INTO STRICT NR_SEQ_PRESET_W2
  FROM  SCHEM_TEST_SCRIPT 
  WHERE NR_SEQUENCIA = NR_SEQUENCIA_W;

  UPDATE SCHEM_TEST_PRESET SET DT_LAST = clock_timestamp() WHERE NR_SEQUENCIA = NR_SEQ_PRESET_W2;
  COMMIT;
      
  SELECT nextval('schem_test_schedule_seq')
     INTO STRICT NEWSEQUENCESCHEDULE
;
 
  INSERT INTO SCHEM_TEST_SCHEDULE(nr_sequencia, dt_schedule, ie_status, nm_owner, nr_seq_suite, dt_atualizacao, nm_usuario, dt_atualizacao_nrec, nm_usuario_nrec, nr_seq_url, nr_seq_service, nr_seq_browser, ie_jobs)
      VALUES (NEWSEQUENCESCHEDULE, clock_timestamp(), '1', NM_USUARIO_P, NEWSEQUENCESUITE, clock_timestamp(), NM_USUARIO_P, clock_timestamp(), NM_USUARIO_P, NR_SEQ_URL_W, NR_SEQ_SERVICE_W, NR_SEQ_BROWSER_W, IE_JOBS_W);
    COMMIT;
    
  EXCEPTION
  WHEN no_data_found THEN
    RAISE NOTICE 'Erro: Data not found';
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE schematic4test_execscriptmain (NR_SEQUENCIA_P bigint, IE_START_P bigint, NR_SEQ_PRESET_P bigint, NM_USUARIO_P text) FROM PUBLIC;

