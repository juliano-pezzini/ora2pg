-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE atualizar_propaci_medico_dit ( nr_prescricao_p bigint, ie_opcao_p text, nm_usuario_p text) AS $body$
DECLARE

/* 
EX 	= MÃ©dico executor 
*/
 
nr_seq_propaci_w	bigint;
cd_medico_exec_w	varchar(10);
ie_medico_w			varchar(1);
nr_seq_interno_w	bigint;

C01 CURSOR FOR 
	SELECT	nr_seq_interno 
	from	prescr_proc_ditado b, 
		prescr_procedimento a 
	where	a.nr_seq_interno	= b.nr_Seq_prescr_proc 
	and	a.nr_prescricao		= nr_prescricao_p 
	and	b.nm_usuario		= nm_usuario_p 
	--and	to_char(b.dt_atualizacao,'dd/mm/yyyy hh24:mi') = to_char(sysdate,'dd/mm/yyyy hh24:mi') 
	order by 1;


BEGIN 
 
open C01;
loop 
fetch C01 into	 
	nr_seq_interno_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin 
	if (nr_seq_interno_w IS NOT NULL AND nr_seq_interno_w::text <> '') then 
		begin 
		select 	a.nr_sequencia, 
			Obter_Pessoa_Fisica_Usuario(b.nm_usuario,'C') 
		into STRICT	nr_seq_propaci_w, 
			cd_medico_exec_w 
		from	prescr_proc_ditado b, 
			procedimento_paciente a, 
			prescr_procedimento c 
		where	a.nr_prescricao			= c.nr_prescricao 
		and	a.nr_sequencia_prescricao	= c.nr_sequencia 
		and	c.nr_seq_interno		= b.nr_Seq_prescr_proc 
		and	c.nr_seq_interno		= nr_seq_interno_w;
		 
		ie_medico_w	:= Obter_se_medico(cd_medico_exec_w,'M');
		 
		exception 
		when others then 
			nr_seq_propaci_w	:=0;
		end;
		 
		if (coalesce(nr_seq_propaci_w,0)	<> 0) and (ie_medico_w = 'S')	then 
							 
			if (coalesce(ie_opcao_p,'EX') = 'EX') then 
			 
				update	procedimento_paciente 
				set	cd_medico_exec_conta	= 	cd_medico_exec_w, 
					dt_atualizacao = clock_timestamp(), 
					nm_usuario = nm_usuario_p 
				where	nr_sequencia	= 	nr_seq_propaci_w;
		 
			end if;
		end if;
		 
	end if;
 
	 
	end;
end loop;
close C01;
 
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE atualizar_propaci_medico_dit ( nr_prescricao_p bigint, ie_opcao_p text, nm_usuario_p text) FROM PUBLIC;

