-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_evento_reaprazamento (nr_atendimento_p bigint, nr_prescricao_p bigint, nr_seq_item_p bigint, nr_seq_horario_p bigint, cd_item_p text, ie_tipo_item_p text, ie_alteracao_p bigint, nr_seq_motivo_p bigint, ds_justificativa_p text, nm_usuario_p text, nr_seq_proc_interno_p bigint, ie_acm_sn_p text, nr_seq_assinatura_p bigint default null, qt_item_p bigint default null, cd_funcao_p bigint default null, nr_seq_gas_cpoe_p bigint default null) AS $body$
DECLARE


ora2pg_rowcount int;
nr_sequencia_w		bigint;
dt_atualizacao_w	timestamp := clock_timestamp();
dt_horario_original_w	timestamp;
dt_horario_w		timestamp;
nr_seq_lote_w		bigint;
nr_sequencia_ev_w	bigint;
nr_etapa_w			smallint;
ie_unidade_medida_w	varchar(15);
qt_gasoterapia_w	double precision;
dt_aprazamento_w	timestamp;
nr_seq_prot_glic_w	bigint;
cd_um_dose_adm_w	varchar(50);
qt_dose_adm_w		double precision;
cd_pessoa_fisica_w	atendimento_paciente.cd_pessoa_fisica%type;
nr_seq_alteracao_comp_w	prescr_mat_alteracao_comp.nr_sequencia_prescr%type;
cd_intervalo_w		prescr_mat_alteracao_comp.cd_intervalo%type;
ie_gera_sem_certificado_w	varchar(1);
nr_seq_recomendacao_w	prescr_recomendacao.nr_sequencia%type;


BEGIN

if (nr_atendimento_p IS NOT NULL AND nr_atendimento_p::text <> '') and (nr_prescricao_p IS NOT NULL AND nr_prescricao_p::text <> '') and
	--(nr_seq_item_p is not null) and
	(cd_item_p IS NOT NULL AND cd_item_p::text <> '') and (ie_tipo_item_p IS NOT NULL AND ie_tipo_item_p::text <> '') and (ie_alteracao_p IS NOT NULL AND ie_alteracao_p::text <> '') and (nm_usuario_p IS NOT NULL AND nm_usuario_p::text <> '')
	and (coalesce(cd_funcao_p,1113) not in (-9, -2025) or ie_alteracao_p = 3) then

	if (ie_alteracao_p = 10) then
		dt_horario_original_w	:= obter_horario_orig_reapraz(ie_tipo_item_p,nr_seq_horario_p);
	else
		dt_horario_original_w	:= null;
	end if;

	if (ie_tipo_item_p <> 'SNE') then
		/* obter sequencia */

		select	nextval('prescr_mat_alteracao_seq')
		into STRICT	nr_sequencia_w
		;
		/* obter sequencia complementar */

		select	nextval('prescr_mat_alteracao_comp_seq')
		into STRICT	nr_seq_alteracao_comp_w
		;
	end if;

	/* gerar evento */

	if (ie_tipo_item_p = 'D') then

		select	coalesce(max(dt_horario),dt_horario_original_w)
		into STRICT	dt_horario_w
		from	prescr_dieta_hor
		where	nr_sequencia = nr_seq_horario_p;

		insert into prescr_mat_alteracao(
							nr_sequencia,
							dt_atualizacao,
							nm_usuario,
							dt_atualizacao_nrec,
							nm_usuario_nrec,
							nr_prescricao,
							nr_seq_horario_dieta,
							dt_alteracao,
							cd_pessoa_fisica,
							ie_alteracao,
							nr_seq_motivo,
							ds_justificativa,
							ie_tipo_item,
							nr_atendimento,
							cd_item,
							dt_horario_original,
							nr_seq_assinatura,
							cd_funcao,
							dt_horario_acao
							)
						values (
							nr_sequencia_w,
							dt_atualizacao_w,
							nm_usuario_p,
							dt_atualizacao_w,
							nm_usuario_p,
							nr_prescricao_p,
							nr_seq_horario_p,
							dt_atualizacao_w,
							obter_dados_usuario_opcao(nm_usuario_p,'C'),
							ie_alteracao_p,
							nr_seq_motivo_p,
							ds_justificativa_p,
							ie_tipo_item_p,
							nr_atendimento_p,
							cd_item_p,
							dt_horario_original_w,
							nr_seq_assinatura_p,
							cd_funcao_p,
							dt_horario_w
							);

	elsif (ie_tipo_item_p in ('S','M','LD','MAT','IA','IAG', 'IAH')) then

		if (ie_tipo_item_p in ('S','M','LD','MAT','IA','IAG', 'IAH')) then

			select	max(nr_seq_lote),
					max(cd_unidade_medida_dose),
					max(dt_horario),
					max(qt_dose)
			into STRICT	nr_seq_lote_w,
					cd_um_dose_adm_w,
					dt_horario_w,
					qt_dose_adm_w
			from	prescr_mat_hor
			where	nr_prescricao = nr_prescricao_p
			and	nr_sequencia = nr_seq_horario_p;

		end if;

		insert into prescr_mat_alteracao(
							nr_sequencia,
							dt_atualizacao,
							nm_usuario,
							dt_atualizacao_nrec,
							nm_usuario_nrec,
							nr_prescricao,
							nr_seq_prescricao,
							nr_seq_horario,
							dt_alteracao,
							cd_pessoa_fisica,
							ie_alteracao,
							nr_seq_motivo,
							ds_justificativa,
							ie_agrupador,
							ie_tipo_item,
							nr_atendimento,
							cd_item,
							dt_horario_original,
							ie_acm_sn,
							nr_seq_assinatura,
							nr_seq_lote,
							cd_um_dose_adm,
							dt_horario_acao,
							qt_dose_original,
							qt_dose_adm,
							cd_funcao)
						values (
							nr_sequencia_w,
							dt_atualizacao_w,
							nm_usuario_p,
							dt_atualizacao_w,
							nm_usuario_p,
							nr_prescricao_p,
							nr_seq_item_p,
							--null,
							nr_seq_horario_p,
							dt_atualizacao_w,
							obter_dados_usuario_opcao(nm_usuario_p,'C'),
							ie_alteracao_p,
							nr_seq_motivo_p,
							ds_justificativa_p,
							null,
							ie_tipo_item_p,
							nr_atendimento_p,
							cd_item_p,
							dt_horario_original_w,
							ie_acm_sn_p,
							nr_seq_assinatura_p,
							nr_seq_lote_w,
							cd_um_dose_adm_w,
							dt_horario_w,
							qt_item_p,
							qt_dose_adm_w,
							cd_funcao_p);


	elsif (ie_tipo_item_p in ('P','G','C','I')) then


		select	max(dt_horario)
		into STRICT	dt_horario_w
		from	prescr_proc_hor
		where	nr_sequencia = nr_seq_horario_p;

		select	max(a.nr_seq_lote)
		into STRICT	nr_seq_lote_w
		from	prescr_mat_hor a,
			prescr_material b
		where	a.nr_prescricao = nr_prescricao_p
		and	a.nr_prescricao	= b.nr_prescricao
		and	a.nr_seq_material = b.nr_sequencia
		and	a.dt_horario	= dt_horario_w
		and	b.nr_sequencia_proc = nr_seq_item_p;

		select	max(nr_seq_prot_glic)
		into STRICT	nr_seq_prot_glic_w
		from	prescr_procedimento
		where	nr_sequencia = nr_seq_item_p
		and		nr_prescricao = nr_prescricao_p;

		insert into prescr_mat_alteracao(
							nr_sequencia,
							dt_atualizacao,
							nm_usuario,
							dt_atualizacao_nrec,
							nm_usuario_nrec,
							nr_prescricao,
							nr_seq_procedimento,
							nr_seq_horario_proc,
							dt_alteracao,
							cd_pessoa_fisica,
							ie_alteracao,
							nr_seq_motivo,
							ds_justificativa,
							ie_agrupador,
							ie_tipo_item,
							nr_atendimento,
							cd_item,
							dt_horario_original,
							nr_seq_proc_interno,
							nr_seq_assinatura,
							nr_seq_lote,
							nr_seq_prot_glic,
							dt_horario_acao,
							cd_funcao
							)
						values (
							nr_sequencia_w,
							dt_atualizacao_w,
							nm_usuario_p,
							dt_atualizacao_w,
							nm_usuario_p,
							nr_prescricao_p,
							nr_seq_item_p,
							nr_seq_horario_p,
							dt_atualizacao_w,
							obter_dados_usuario_opcao(nm_usuario_p,'C'),
							ie_alteracao_p,
							nr_seq_motivo_p,
							ds_justificativa_p,
							null,
							ie_tipo_item_p,
							nr_atendimento_p,
							cd_item_p,
							dt_horario_original_w,
							nr_seq_proc_interno_p,
							nr_seq_assinatura_p,
							nr_seq_lote_w,
							nr_seq_prot_glic_w,
							dt_horario_w,
							cd_funcao_p);

		select	max(a.cd_intervalo)
		into STRICT	cd_intervalo_w
		from	prescr_procedimento a,
				prescr_proc_hor b
		where	a.nr_prescricao = b.nr_prescricao
		and		a.nr_sequencia = b.nr_seq_procedimento
		and		b.nr_sequencia = nr_seq_horario_p;

		insert into prescr_mat_alteracao_comp(
							nr_sequencia,
							dt_atualizacao,
							cd_intervalo,
							nm_usuario,
							dt_atualizacao_nrec,
							nm_usuario_nrec,
							nr_sequencia_prescr
							)
						values (
							nr_seq_alteracao_comp_w,
							dt_atualizacao_w,
							cd_intervalo_w,
							nm_usuario_p,
							dt_atualizacao_w,
							nm_usuario_p,
							nr_sequencia_w
							);

	elsif (ie_tipo_item_p = 'R') then
	    select 	max(a.dt_horario),
				max(a.nr_seq_recomendacao)
		into STRICT	dt_horario_w,
				nr_seq_recomendacao_w
		from	prescr_rec_hor	a
		where 	a.nr_sequencia = nr_seq_horario_p;

		select	max(a.nr_seq_lote) --Verifica o lote dos itens associados para gravar no evento
		into STRICT	nr_seq_lote_w
		from	prescr_mat_hor	a,
				prescr_material	b
		where	b.nr_sequencia	= a.nr_seq_material
		and		b.nr_prescricao	= a.nr_prescricao
		and		b.nr_prescricao	= nr_prescricao_p
		and		b.nr_seq_recomendacao = nr_seq_recomendacao_w
		and		a.dt_horario	= dt_horario_w;

		insert into prescr_mat_alteracao(
							nr_sequencia,
							dt_atualizacao,
							nm_usuario,
							dt_atualizacao_nrec,
							nm_usuario_nrec,
							nr_prescricao,
							nr_seq_recomendacao,
							nr_seq_horario_rec,
							dt_alteracao,
							cd_pessoa_fisica,
							ie_alteracao,
							nr_seq_motivo,
							ds_justificativa,
							ie_tipo_item,
							nr_atendimento,
							cd_item,
							dt_horario_original,
							nr_seq_assinatura,
							cd_funcao,
							dt_horario_acao,
							nr_seq_lote
							)
						values (
							nr_sequencia_w,
							dt_atualizacao_w,
							nm_usuario_p,
							dt_atualizacao_w,
							nm_usuario_p,
							nr_prescricao_p,
							nr_seq_item_p,
							nr_seq_horario_p,
							dt_atualizacao_w,
							obter_dados_usuario_opcao(nm_usuario_p,'C'),
							ie_alteracao_p,
							nr_seq_motivo_p,
							ds_justificativa_p,
							ie_tipo_item_p,
							nr_atendimento_p,
							cd_item_p,
							dt_horario_original_w,
							nr_seq_assinatura_p,
							cd_funcao_p,
							dt_horario_w,
							nr_seq_lote_w
							);

	elsif (ie_tipo_item_p = 'E') then
		select	max(dt_horario)
		into STRICT	dt_horario_w
		from	pe_prescr_proc_hor
		where	nr_sequencia = nr_seq_horario_p;

		select	max(a.nr_seq_lote)
		into STRICT	nr_seq_lote_w
		from	prescr_mat_hor a,
				prescr_material b,
				pe_prescr_proc c,
				pe_prescr_proc_hor d,
				pe_prescricao e
		where	a.nr_prescricao = b.nr_prescricao
		and		b.nr_prescricao = e.nr_prescricao
		and		e.nr_sequencia = c.nr_seq_prescr
		and		e.nr_sequencia = d.nr_seq_pe_prescr
		and		e.nr_sequencia = nr_prescricao_p
		and		a.nr_seq_material = b.nr_sequencia
		and		b.nr_seq_pe_proc = c.nr_sequencia
		and		b.nr_seq_pe_proc = d.nr_seq_pe_proc
		and		b.nr_seq_pe_proc = nr_seq_item_p
		and		a.dt_horario = d.dt_horario
		and		a.dt_horario = dt_horario_w;

		insert into prescr_mat_alteracao(
			nr_sequencia,
			dt_atualizacao,
			nm_usuario,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			nr_prescricao,
			nr_seq_item_sae,
			nr_seq_horario_sae,
			dt_alteracao,
			cd_pessoa_fisica,
			ie_alteracao,
			nr_seq_motivo,
			ds_justificativa,
			ie_agrupador,
			ie_tipo_item,
			nr_atendimento,
			cd_item,
			dt_horario_original,
			nr_seq_assinatura,
			dt_horario_acao,
			cd_funcao,
			nr_seq_lote
			)
		values (
			nr_sequencia_w,
			dt_atualizacao_w,
			nm_usuario_p,
			dt_atualizacao_w,
			nm_usuario_p,
			nr_prescricao_p,
			nr_seq_item_p,
			--null,
			nr_seq_horario_p,
			dt_atualizacao_w,
			obter_dados_usuario_opcao(nm_usuario_p,'C'),
			ie_alteracao_p,
			nr_seq_motivo_p,
			ds_justificativa_p,
			null,
			ie_tipo_item_p,
			nr_atendimento_p,
			cd_item_p,
			dt_horario_original_w,
			nr_seq_assinatura_p,
			dt_horario_w,
			cd_funcao_p,
			nr_seq_lote_w
			);

	elsif (ie_tipo_item_p = 'SNE') then
		dt_aprazamento_w := null;
		if (nr_seq_horario_p IS NOT NULL AND nr_seq_horario_p::text <> '') then
			select	max(dt_horario),
				max(nr_seq_lote)
			into STRICT	dt_aprazamento_w,
				nr_seq_lote_w
			from	prescr_mat_hor
			where	nr_sequencia = nr_seq_horario_p;
		end if;
		select	nextval('prescr_solucao_evento_seq')
		into STRICT	nr_sequencia_w
		;

		insert into prescr_solucao_evento(nr_sequencia,
			dt_atualizacao,
			nm_usuario,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			nr_prescricao,
			nr_seq_material,
			cd_pessoa_fisica,
			ie_alteracao,
			dt_alteracao,
			ie_evento_valido,
			nr_seq_motivo,
			ds_observacao,
			ie_tipo_solucao,
			nr_seq_assinatura,
			dt_aprazamento,
			nr_seq_lote,
			cd_funcao)
		values (nr_sequencia_w,
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			nr_prescricao_p,
			nr_seq_item_p,
			obter_dados_usuario_opcao(nm_usuario_p, 'C'),
			16,
			clock_timestamp(),
			'S',
			null,
			null,
			2,
			nr_seq_assinatura_p,
			dt_aprazamento_w,
			nr_seq_lote_w,
			cd_funcao_p);


	elsif (ie_tipo_item_p = 'HM') then
		begin
		dt_aprazamento_w := null;
		if (nr_seq_horario_p IS NOT NULL AND nr_seq_horario_p::text <> '') then
			select	max(dt_horario)
			into STRICT	dt_aprazamento_w
			from	prescr_proc_hor
			where	nr_sequencia = nr_seq_horario_p;
		end if;
		select	nextval('prescr_solucao_evento_seq')
		into STRICT	nr_sequencia_w
		;

		insert
		into prescr_solucao_evento(
			nr_sequencia,
			dt_atualizacao,
			nm_usuario,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			nr_prescricao,
			cd_pessoa_fisica,
			ie_alteracao,
			ie_evento_valido,
			dt_alteracao,
			nr_seq_procedimento,
			ie_tipo_solucao,
			dt_horario,
			nr_seq_motivo,
			ds_justificativa,
			cd_funcao)
        values (
			nr_sequencia_w,
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			nr_prescricao_p,
			obter_dados_usuario_opcao(nm_usuario_p, 'C'),
			16,
			'S',
			clock_timestamp(),
			nr_seq_item_p,
			3,
			dt_horario_w,
			nr_seq_motivo_p,
			ds_justificativa_p,
			cd_funcao_p);


		end;
	elsif (ie_tipo_item_p = 'SOL') then

				select	max(dt_horario)
				into STRICT	dt_horario_w
				from	prescr_mat_hor
				where	nr_sequencia = nr_seq_horario_p;

				select	nextval('prescr_solucao_evento_seq')
				into STRICT	nr_sequencia_w
				;

				insert into prescr_solucao_evento(
							nr_sequencia,
							dt_atualizacao,
							nm_usuario,
							dt_atualizacao_nrec,
							nm_usuario_nrec,
							nr_prescricao,
							cd_pessoa_fisica,
							ie_alteracao,
							ie_evento_valido,
							dt_alteracao,
							nr_seq_solucao,
							ie_tipo_solucao,
							dt_horario,
							nr_seq_motivo,
							ds_justificativa,
							cd_funcao)
							values (
							nr_sequencia_w,
							clock_timestamp(),
							nm_usuario_p,
							clock_timestamp(),
							nm_usuario_p,
							nr_prescricao_p,
							obter_dados_usuario_opcao(nm_usuario_p, 'C'),
							44,
							'S',
							clock_timestamp(),
							nr_seq_item_p,
							1,
							dt_horario_w,
							nr_seq_motivo_p,
							ds_justificativa_p,
							cd_funcao_p);

	elsif (ie_tipo_item_p = 'O') then

		select	max(dt_horario)
		into STRICT	dt_horario_w
		from	prescr_gasoterapia_hor
		where	nr_sequencia = nr_seq_horario_p;

		select	max(a.ie_unidade_medida),
				max(a.qt_gasoterapia)
		into STRICT	ie_unidade_medida_w,
				qt_gasoterapia_w
		from	prescr_gasoterapia a,
				prescr_gasoterapia_hor b
		where	a.nr_sequencia = nr_seq_item_p
		and		a.nr_seq_gas   = cd_item_p
		and 	b.nr_seq_gasoterapia = a.nr_sequencia
		and 	a.nr_prescricao = nr_prescricao_p
		and 	b.nr_sequencia = nr_seq_horario_p;

		select	nextval('prescr_gasoterapia_evento_seq')
		into STRICT	nr_sequencia_ev_w
		;

		insert into prescr_gasoterapia_evento(
						ds_justificativa,
						ds_observacao,
						dt_atualizacao,
						dt_atualizacao_nrec,
						dt_evento,
						ie_disp_resp_esp,
						ie_evento,
						ie_evento_valido,
						ie_unidade_medida,
						nm_usuario,
						nm_usuario_nrec,
						nr_etapa_evento,
						nr_seq_assinatura,
						nr_seq_gasoterapia,
						nr_seq_motivo,
						nr_sequencia,
						nr_seq_horario,
						qt_gasoterapia,
						dt_horario_original,
						dt_hor_acm_sn,
                        nr_seq_gas_cpoe
						)
					       values (
						ds_justificativa_p,
						null,
						clock_timestamp(),
						clock_timestamp(),
						clock_timestamp(),
						null,
						CASE WHEN ie_alteracao_p=15 THEN 'A'  ELSE CASE WHEN ie_alteracao_p=10 THEN  'RP'  ELSE ie_alteracao_p END  END ,
						'S',
						ie_unidade_medida_w,
						nm_usuario_p,
						nm_usuario_p,
						null,
						nr_seq_assinatura_p,
						nr_seq_item_p,
						--nr_seq_motivo_p,
						null,
						nr_sequencia_ev_w,
						nr_seq_horario_p,
						qt_gasoterapia_w,
						dt_horario_original_w,
						dt_horario_w,
						nr_seq_gas_cpoe_p
						);

	end if;
end if;

ie_gera_sem_certificado_w	:= 'N';

if (wheb_assist_pck.get_gerar_sem_certificado = 'S') then
	ie_gera_sem_certificado_w := adep_obter_se_assin_perfil(35004, obter_perfil_ativo); --ADEP - Reaprazamento
end if;

GET DIAGNOSTICS ora2pg_rowcount = ROW_COUNT;


if	((wheb_assist_pck.get_cd_certificado IS NOT NULL AND wheb_assist_pck.get_cd_certificado::text <> '') OR (ie_gera_sem_certificado_w = 'S')) AND ( ora2pg_rowcount > 0) and (coalesce(obter_data_assinatura_digital(nr_seq_assinatura_p)::text, '') = '') then

	select	max(cd_pessoa_fisica)
	into STRICT	cd_pessoa_fisica_w
	from	atendimento_paciente
	where	nr_atendimento = nr_atendimento_p;

	CALL Gerar_registro_pendente_PEP('ADEP',nr_prescricao_p, cd_pessoa_fisica_w, nr_atendimento_p,nm_usuario_p, 'A', nr_seq_horario_p, ie_tipo_item_p,null,null,null,null,null,null,null,null,null,null,null,null,null,null,nr_sequencia_w);

end if;

if (coalesce(wheb_usuario_pck.get_ie_commit, 'S') = 'S') then commit; end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_evento_reaprazamento (nr_atendimento_p bigint, nr_prescricao_p bigint, nr_seq_item_p bigint, nr_seq_horario_p bigint, cd_item_p text, ie_tipo_item_p text, ie_alteracao_p bigint, nr_seq_motivo_p bigint, ds_justificativa_p text, nm_usuario_p text, nr_seq_proc_interno_p bigint, ie_acm_sn_p text, nr_seq_assinatura_p bigint default null, qt_item_p bigint default null, cd_funcao_p bigint default null, nr_seq_gas_cpoe_p bigint default null) FROM PUBLIC;

