-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_relatorio_wavaliar ( nr_seq_relatorio_p bigint, nr_seq_avaliacao_p bigint, nm_usuario_p text) AS $body$
DECLARE


nr_seq_avaliacao_w		bigint;
nr_seq_banda_sup_w		bigint;
nr_seq_banda_limite_w		bigint;
nr_seq_campo_w			bigint	:= 0;
nr_seq_apresent_campo_w		bigint	:= 3;
ds_base_w			varchar(255);
nm_campo_w			varchar(80);
nm_atributo_w			varchar(50)	:= '';
ds_sql_select_w			varchar(8000)	:= '';
ds_sql_from_w			varchar(255);
qt_resultado_w			double precision	:= 0;
ds_resultado_w			varchar(4000)	:= '';
qt_topo_campo_lb_w		real	:= 25;
qt_esq_campo_lb_w		real	:= 5;
qt_tam_campo_lb_w		real	:= 80;
qt_topo_campo_w			real	:= 25;
qt_esq_campo_w			real	:= 90;
qt_tam_campo_w			real	:= 30;
ie_cria_subdetalhe_w	varchar(1) := 'S';

/*  Tabela Med_item_Avaliar */

nr_seq_item_w			bigint;
ds_item_w			varchar(255);
nr_seq_apresent_w		integer;
ie_resultado_w			varchar(2);
qt_decimais_w			smallint;
ds_unid_med_w			varchar(15);
qt_minimo_w			double precision;
qt_maximo_w			double precision;
nr_seq_superior_w		bigint;
ie_obrigatorio_w		varchar(1);
qt_tamanho_w			smallint;
qt_desloc_direita_w		smallint;
qt_pos_esquerda_w		smallint;
cd_dominio_w			integer;

/* Tabela Relatório */

qt_margem_inf_w			real	:= 20;
ie_imprime_vazio_rel_w		varchar(1)	:= 'S';
ie_filtro_html_w		varchar(1)	:= 'S';
ie_filtro_word_w		varchar(1)	:= 'S';
ie_tipo_papel_w			varchar(15)	:= 'A4';
ie_filtro_excel_w		varchar(1)	:= 'S';
ie_filtro_texto_w		varchar(1)	:= 'S';

/* Tabela Banda_Relatorio */

nr_seq_banda_w			bigint	:= 0;
ie_tipo_banda_w			varchar(1)	:= 'S';
ds_banda_w			varchar(30)	:= '';
qt_altura_w			real	:= 100;
ds_cor_fundo_w			varchar(10)	:= 'clWhite';
ie_quebra_pagina_w		varchar(1)	:= 'N';
ie_reimprime_nova_pagina_w	varchar(1)	:= 'N';
ie_alterna_cor_fundo_w		varchar(1)	:= 'N';
ie_imprime_vazio_w		varchar(1)	:= 'N';
ie_imprime_primeiro_w		varchar(1)	:= 'N';
ie_borda_sup_w			varchar(1)	:= 'N';
ie_borda_inf_w			varchar(1)	:= 'N';
ie_borda_esq_w			varchar(1)	:= 'N';
ie_borda_dir_w			varchar(1)	:= 'N';
nm_tabela_w			varchar(50)	:= '';
ds_sql_w			varchar(4000)	:= '';
ds_expressao_w			varchar(255)	:= '';
nr_seq_apresentacao_w		bigint	:= 25;
ds_cor_header_w			varchar(10)	:= 'clSilver';
ds_cor_footer_w			varchar(10)	:= 'clWhite';
ds_cor_quebra_w			varchar(10)	:= '$00E5E5E5';
ds_regra_w			varchar(4000)	:= '';
ie_banda_padrao_w		varchar(1)	:= 'N';
qt_max_registro_w		smallint;
/* Tabela Relatorio Parametro */

nr_seq_rel_param_w		bigint;
cd_parametro_w			varchar(50)	:= '';
ds_parametro_w			varchar(50)	:= '';
ie_tipo_atributo_w		varchar(10)	:= '';
ie_origem_informacao_w		varchar(1)	:= '';
cd_dominio_par_w		integer	:= 0;
ds_sql_param_w			varchar(4000)	:= '';
vl_padrao_w			varchar(255)	:= '';
ie_forma_apresent_w		varchar(5)	:= '';
qt_tamanho_campo_w		smallint	:= 0;
ds_valor_parametro_w		varchar(255)	:= '';
ie_forma_passagem_w		varchar(1)	:= '';
ds_alias_w			varchar(20)	:= '';
ds_mascara_w		med_item_avaliar.ds_mascara%type;
qt_tam_byte_w			smallint;
ie_multi_linha_w		varchar(1)	:= 'N';
nr_seq_localizar_w		bigint	:= 0;
nr_seq_apr_par_w		integer	:= 0;
cd_funcao_w				integer;
nm_tabela_avaliacao_w	varchar(255);
ie_criou_nova_banda_w	varchar(1) := 'N';

C01 CURSOR FOR
SELECT	b.nr_sequencia,
		substr(b.ds_item,1,80),
		b.nr_seq_tipo,
		b.nr_seq_apresent,
		b.ie_resultado,
		b.qt_decimais,
		b.ds_unid_med,
		b.qt_minimo,
		b.qt_maximo,
		b.nr_seq_superior,
		b.ie_obrigatorio,
		b.qt_tamanho,
		b.qt_desloc_direita,
		b.qt_pos_esquerda,
		b.cd_dominio
from 		med_item_avaliar b
where		b.nr_seq_tipo		= nr_seq_avaliacao_p
order by    b.nr_seq_apresent;


BEGIN
ds_mascara_w	:= '';

/* Francisco - OS 104162 - 08/09/2008 - Tratar qual a tabela de avaliação */

select	max(cd_funcao)
into STRICT	cd_funcao_w
from	med_tipo_avaliacao
where	nr_sequencia	= nr_seq_avaliacao_p;

nm_tabela_avaliacao_w	:= 'med_avaliacao_paciente';

/* Boletim de ocorrência */

if (cd_funcao_w = 2000) then
	nm_tabela_avaliacao_w	:= 'sac_pesquisa';
end if;

/* Autorização Convênio */

if (cd_funcao_w = 3004) then
	nm_tabela_avaliacao_w	:= 'AUTORIZACAO_CONVENIO_AVAL';
end if;

update	relatorio
set 	ie_filtro_html		= ie_filtro_html_w,
	ie_filtro_word		= ie_filtro_word_w,
	ie_filtro_excel		= ie_filtro_excel_w,
	ie_filtro_texto		= ie_filtro_texto_w,
	ie_imprime_vazio	= ie_imprime_vazio_rel_w,
	qt_margem_inf		= qt_margem_inf_w
where 	nr_sequencia 		= nr_seq_relatorio_p;

delete from banda_relat_campo
where nr_seq_banda in (
	SELECT 	nr_sequencia
	from	banda_relatorio
	where	nr_seq_relatorio	= nr_seq_relatorio_p);

delete	from relatorio_parametro
where	nr_seq_relatorio	= nr_seq_relatorio_p;

delete	from banda_relatorio
where	nr_seq_relatorio	= nr_seq_relatorio_p;

select	nextval('relatorio_parametro_seq')
into STRICT 	nr_seq_rel_param_w
;

insert into relatorio_parametro(
	nr_sequencia, cd_parametro, ds_parametro,
	ie_tipo_atributo, nr_seq_relatorio, ie_origem_informacao,
	dt_atualizacao, nm_usuario, cd_dominio,
	ds_sql, vl_padrao, ie_forma_apresent,
	qt_tamanho_campo, ds_valor_parametro, ie_forma_passagem,
	ds_alias, ds_mascara, qt_tam_byte,
	ie_multi_linha, nr_seq_localizar, nr_seq_apresent)
values (nr_seq_rel_param_w, 'NR_SEQ_AVALIACAO', wheb_mensagem_pck.get_texto(307806), -- Nº Avaliação
	'NUMBER', nr_seq_relatorio_p, 'P',
	clock_timestamp(), nm_usuario_p, cd_dominio_par_w,
	ds_sql_param_w, vl_padrao_w, 'ed',
	80, ds_valor_parametro_w, 'P',
	ds_alias_w, ds_mascara_w, qt_tam_byte_w,
	ie_multi_linha_w, nr_seq_localizar_w, nr_seq_apr_par_w);

select	nextval('banda_relatorio_seq')
into STRICT	nr_seq_banda_w
;

ds_sql_w	:=
		'select a.nm_pessoa_fisica nm_paciente, a.nr_prontuario, 		' || chr(10) ||
		'a.dt_nascimento, substr(obter_valor_dominio(4,a.ie_sexo),1,20) ds_sexo,' || chr(10) ||
		'  b.ds_end ds_endereco,						' || chr(10) ||
          	'trunc((sysdate - a.dt_nascimento)/365) ds_idade,  			' || chr(10) ||
		'obter_valor_dominio(5,a.ie_estado_civil) ds_estado_civil,		' || chr(10) ||
		'h.ds_profissao, f.nm_localidade ds_naturalidade 			' || chr(10) ||
		'from profissao h, cep_localidade f, compl_pessoa_fisica_v b, 		' || chr(10) ||
		'pessoa_fisica a, ' || nm_tabela_avaliacao_w || ' m				' || chr(10) ||
		'where m.nr_sequencia		= :nr_seq_avaliacao 			' || chr(10) ||
		'and  m.cd_pessoa_fisica 	= a.cd_pessoa_fisica			' || chr(10) ||
		'and 	a.cd_pessoa_fisica	= b.cd_pessoa_fisica(+)			' || chr(10) ||
		'and 	1				= b.ie_tipo_complemento (+)  	' || chr(10) ||
		'and 	b.cd_profissao		= h.cd_profissao(+) 			' || chr(10) ||
		'and 	a.nr_cep_cidade_nasc	= f.cd_localidade(+)			' || chr(10) ||
		'and 	(f.tp_localidade(+)	= #M#)';

/* Autorização Convênio */

if (cd_funcao_w = 3004) then

ds_sql_w	:=
	'select 	a.nm_pessoa_fisica nm_paciente,
		a.nr_prontuario,
		a.dt_nascimento,
		substr(obter_valor_dominio(4,a.ie_sexo),1,20) ds_sexo,
		b.ds_end ds_endereco,
		trunc((sysdate - a.dt_nascimento)/365) ds_idade,
		obter_valor_dominio(5,a.ie_estado_civil) ds_estado_civil,
		h.ds_profissao,
		f.nm_localidade ds_naturalidade
	from     profissao h,
		cep_localidade f,
		compl_pessoa_fisica_v b,
		pessoa_fisica a,
		autorizacao_convenio_aval m,
		autorizacao_convenio c
	where    c.nr_sequencia  		= m.nr_seq_autorizacao_conv
	and      m.nr_sequencia		= :nr_seq_avaliacao
	and      c.cd_pessoa_fisica 	= a.cd_pessoa_fisica
	and 	a.cd_pessoa_fisica	= b.cd_pessoa_fisica(+)
	and 	1			= b.ie_tipo_complemento (+)
	and 	b.cd_profissao		= h.cd_profissao(+)
	and 	a.nr_cep_cidade_nasc	= f.cd_localidade(+)
	and 	(f.tp_localidade(+)	= #M#)';

end if;

ds_sql_w	:= replace(ds_sql_w, '#', chr(39));


insert into	banda_relatorio(
	nr_sequencia, ie_tipo_banda, ds_banda, dt_atualizacao, nm_usuario, qt_altura,
	ds_cor_fundo, ie_quebra_pagina, ie_reimprime_nova_pagina, ie_alterna_cor_fundo,
	ie_imprime_vazio,	ie_imprime_primeiro, ie_borda_sup, ie_borda_inf,
	ie_borda_esq, ie_borda_dir, nr_seq_banda_superior, nr_seq_relatorio,
	nm_tabela, ds_sql, ds_expressao, nr_seq_apresentacao, ds_cor_header,
	ds_cor_footer, ds_cor_quebra,ds_regra, ie_banda_padrao, qt_max_registro)
values (nr_seq_banda_w, 'C', wheb_mensagem_pck.get_texto(307800),clock_timestamp(), nm_usuario_p, 157, -- Cabeçalho
	ds_cor_fundo_w, ie_quebra_pagina_w,ie_reimprime_nova_pagina_w,ie_alterna_cor_fundo_w,
	'S','S',ie_borda_sup_w,'S',
	ie_borda_esq_w,ie_borda_dir_w, nr_seq_banda_sup_w, nr_seq_relatorio_p,
	nm_tabela_w, ds_sql_w,ds_expressao_w, 5, ds_cor_header_w,
	ds_cor_footer_w,ds_cor_quebra_w,ds_regra_w, ie_banda_padrao_w, qt_max_registro_w);

/* Dados do Cabeçalho */

nr_seq_campo_w := Criar_Campo_Relatorio(nr_seq_banda_w, ' ' || wheb_mensagem_pck.get_texto(307807), 1, 3, 5, 5, 80, '', NM_USUARIO_P, nr_seq_campo_w); -- Logo
nr_seq_campo_w := Criar_Campo_Relatorio(nr_seq_banda_w, ' ' || wheb_mensagem_pck.get_texto(307810), 2, 14, 30, 10, 710, '', NM_USUARIO_P, nr_seq_campo_w); -- Nome Relatório
nr_seq_campo_w := Criar_Campo_Relatorio(nr_seq_banda_w, ' ' || wheb_mensagem_pck.get_texto(307813), 3, 5, 60, 0, 717, '', NM_USUARIO_P, nr_seq_campo_w); -- Linha
nr_seq_campo_w := Criar_Campo_Relatorio(nr_seq_banda_w, ' ' || wheb_mensagem_pck.get_texto(307814), 5, 1, 75, 5, 80, '', NM_USUARIO_P, nr_seq_campo_w); -- Nome
nr_seq_campo_w := Criar_Campo_Relatorio(nr_seq_banda_w, ' ' || wheb_mensagem_pck.get_texto(307816), 10, 0, 75, 90, 350, 'NM_PACIENTE', NM_USUARIO_P, nr_seq_campo_w); -- Lb Nome
nr_seq_campo_w := Criar_Campo_Relatorio(nr_seq_banda_w, ' ' || wheb_mensagem_pck.get_texto(307818), 65, 1, 75, 450, 75, '', NM_USUARIO_P, nr_seq_campo_w); -- Prontuário
nr_seq_campo_w := Criar_Campo_Relatorio(nr_seq_banda_w, ' ' || wheb_mensagem_pck.get_texto(307825), 70, 0, 75, 530, 150, 'NR_PRONTUARIO', NM_USUARIO_P, nr_seq_campo_w); -- Lb Prontuário
nr_seq_campo_w := Criar_Campo_Relatorio(nr_seq_banda_w, ' ' || wheb_mensagem_pck.get_texto(307821), 30, 1, 95, 5, 80, '', NM_USUARIO_P, nr_seq_campo_w); -- Data Nascto.
nr_seq_campo_w := Criar_Campo_Relatorio(nr_seq_banda_w, ' ' || wheb_mensagem_pck.get_texto(307827), 35, 0, 95, 90, 100, 'DT_NASCIMENTO', NM_USUARIO_P, nr_seq_campo_w); -- Lb Data Nascto.
nr_seq_campo_w := Criar_Campo_Relatorio(nr_seq_banda_w, ' ' || wheb_mensagem_pck.get_texto(307826), 40, 0, 95, 190, 100, 'DS_IDADE', NM_USUARIO_P, nr_seq_campo_w); -- Lb Idade
nr_seq_campo_w := Criar_Campo_Relatorio(nr_seq_banda_w, ' ' || wheb_mensagem_pck.get_texto(307828), 85, 1, 95, 450, 75, '', NM_USUARIO_P, nr_seq_campo_w); -- Estado Civil
nr_seq_campo_w := Criar_Campo_Relatorio(nr_seq_banda_w, ' ' || wheb_mensagem_pck.get_texto(307829), 90, 0, 95, 530, 150, 'DS_ESTADO_CIVIL', nm_usuario_p, nr_seq_campo_w); -- Lb Estado Civil
nr_seq_campo_w := Criar_Campo_Relatorio(nr_seq_banda_w, ' ' || wheb_mensagem_pck.get_texto(307830), 55, 1, 115, 5, 80, '', NM_USUARIO_P, nr_seq_campo_w); -- Sexo
nr_seq_campo_w := Criar_Campo_Relatorio(nr_seq_banda_w, ' ' || wheb_mensagem_pck.get_texto(307831), 60, 0, 115, 90, 300, 'DS_SEXO', NM_USUARIO_P, nr_seq_campo_w); -- Lb Sexo
nr_seq_campo_w := Criar_Campo_Relatorio(nr_seq_banda_w, ' ' || wheb_mensagem_pck.get_texto(307832), 75, 1, 115, 450, 75, '', NM_USUARIO_P, nr_seq_campo_w); -- Naturalidade
nr_seq_campo_w := Criar_Campo_Relatorio(nr_seq_banda_w, ' ' || wheb_mensagem_pck.get_texto(307833), 80, 0, 115, 530, 150, 'DS_NATURALIDADE', NM_USUARIO_P, nr_seq_campo_w); -- Lb Naturalidade
nr_seq_campo_w := Criar_Campo_Relatorio(nr_seq_banda_w, ' ' || wheb_mensagem_pck.get_texto(307834), 95, 1, 135, 5, 80, '', NM_USUARIO_P, nr_seq_campo_w); -- Endereço
nr_seq_campo_w := Criar_Campo_Relatorio(nr_seq_banda_w, ' ' || wheb_mensagem_pck.get_texto(307835), 100, 0, 135, 90, 355, 'DS_ENDERECO', nm_usuario_p, nr_seq_campo_w); -- Lb Endereço
nr_seq_campo_w := Criar_Campo_Relatorio(nr_seq_banda_w, ' ' || wheb_mensagem_pck.get_texto(307836), 105, 1, 135, 450, 75, '', NM_USUARIO_P, nr_seq_campo_w); -- Profissão
nr_seq_campo_w := Criar_Campo_Relatorio(nr_seq_banda_w, ' ' || wheb_mensagem_pck.get_texto(307837), 110, 0, 135, 530, 170, 'DS_PROFISSAO', nm_usuario_p, nr_seq_campo_w); -- Lb Profissão
OPEN C01;
LOOP
FETCH C01 into	nr_seq_item_w,
		ds_item_w,
		nr_seq_avaliacao_w,
		nr_seq_apresent_w,
		ie_resultado_w,
		qt_decimais_w,
		ds_unid_med_w,
		qt_minimo_w,
		qt_maximo_w,
		nr_seq_superior_w,
		ie_obrigatorio_w,
		qt_tamanho_w,
		qt_desloc_direita_w,
		qt_pos_esquerda_w,
		cd_dominio_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin

	if (ie_cria_subdetalhe_w = 'S') then
		ie_cria_subdetalhe_w	:= 'N';

		if (ie_resultado_w not in ('T', 'H')) then
			-- Subdetalhe
			nr_seq_apresentacao_w	:= nr_seq_apresentacao_w + 5;

			select	nextval('banda_relatorio_seq')
			into STRICT	nr_seq_banda_w
			;

			ds_banda_w	:= substr(ds_item_w,1,30);

			insert into banda_relatorio(
				nr_sequencia, ie_tipo_banda, ds_banda, dt_atualizacao, nm_usuario, qt_altura,
				ds_cor_fundo, ie_quebra_pagina, ie_reimprime_nova_pagina, ie_alterna_cor_fundo,
				ie_imprime_vazio,	ie_imprime_primeiro, ie_borda_sup, ie_borda_inf,
				ie_borda_esq, ie_borda_dir, nr_seq_banda_superior, nr_seq_relatorio,
				nm_tabela, ds_sql, ds_expressao, nr_seq_apresentacao, ds_cor_header,
				ds_cor_footer, ds_cor_quebra,ds_regra, ie_banda_padrao, qt_max_registro)
			values (nr_seq_banda_w,ie_tipo_banda_w, ds_banda_w,clock_timestamp(), nm_usuario_p, qt_altura_w,
				ds_cor_fundo_w, ie_quebra_pagina_w,ie_reimprime_nova_pagina_w,ie_alterna_cor_fundo_w,
				ie_imprime_vazio_w,ie_imprime_primeiro_w,ie_borda_sup_w,ie_borda_inf_w,
				ie_borda_esq_w,ie_borda_dir_w, nr_seq_banda_sup_w, nr_seq_relatorio_p,
				nm_tabela_w, ds_sql_w,ds_expressao_w, nr_seq_apresentacao_w, ds_cor_header_w,
				ds_cor_footer_w,ds_cor_quebra_w,ds_regra_w,ie_banda_padrao_w, qt_max_registro_w);

			ds_sql_w := '';
		end if;
	end if;

	/* Almir - Alterei a condição abaixo para gerar uma nova banda
			  mesmo quando o item da árvore tiver um item superior */
	/* Francisco - OS 109464 - 01/10/2008 - Incluí o "H" (Título (Obedecer tamanho)) */

	if (ie_resultado_w	in ('T','H')) /* and
		(nr_seq_superior_w is null)*/
 then
		begin

		if (ie_criou_nova_banda_w = 'N') and (position('from' in ds_sql_w) = 0) then
			ds_sql_from_w	:= 'from ' || nm_tabela_avaliacao_w || ' ' ||
							   'where nr_sequencia = :nr_seq_avaliacao';

			ds_sql_w		:= ds_sql_w || '   '  || ds_sql_from_w;

			update	banda_relatorio
			set 	ds_sql		= ds_sql_w
			where	nr_sequencia	= nr_seq_banda_w;
		end if;

		ie_criou_nova_banda_w	:= 'S';
		nr_seq_apresentacao_w	:= nr_seq_apresentacao_w + 5;

		select	nextval('banda_relatorio_seq')
		into STRICT	nr_seq_banda_w
		;
		ds_banda_w	:= substr(ds_item_w,1,30);


		insert into banda_relatorio(
			nr_sequencia, ie_tipo_banda, ds_banda, dt_atualizacao, nm_usuario, qt_altura,
			ds_cor_fundo, ie_quebra_pagina, ie_reimprime_nova_pagina, ie_alterna_cor_fundo,
			ie_imprime_vazio,	ie_imprime_primeiro, ie_borda_sup, ie_borda_inf,
			ie_borda_esq, ie_borda_dir, nr_seq_banda_superior, nr_seq_relatorio,
			nm_tabela, ds_sql, ds_expressao, nr_seq_apresentacao, ds_cor_header,
			ds_cor_footer, ds_cor_quebra,ds_regra, ie_banda_padrao, qt_max_registro)
		values (nr_seq_banda_w,ie_tipo_banda_w, ds_banda_w,clock_timestamp(), nm_usuario_p, qt_altura_w,
			ds_cor_fundo_w, ie_quebra_pagina_w,ie_reimprime_nova_pagina_w,ie_alterna_cor_fundo_w,
			ie_imprime_vazio_w,ie_imprime_primeiro_w,ie_borda_sup_w,ie_borda_inf_w,
			ie_borda_esq_w,ie_borda_dir_w, nr_seq_banda_sup_w, nr_seq_relatorio_p,
			nm_tabela_w, ds_sql_w,ds_expressao_w, nr_seq_apresentacao_w, ds_cor_header_w,
			ds_cor_footer_w,ds_cor_quebra_w,ds_regra_w,ie_banda_padrao_w, qt_max_registro_w);

		nr_seq_apresent_campo_w	:= 3;
		qt_topo_campo_lb_w	:= 25;
		qt_esq_campo_lb_w 	:= 5;
		qt_tam_campo_lb_w	:= 80;
		qt_topo_campo_w		:= 25;
		qt_esq_campo_w		:= 90;
		qt_tam_campo_w		:= 30;
		ds_sql_select_w		:= '';
		ds_sql_from_w		:= 'from ' || nm_tabela_avaliacao_w || ' ' ||
					   'where nr_sequencia = :nr_seq_avaliacao';

		nr_seq_campo_w := Criar_Campo_Relatorio(nr_seq_banda_w, DS_BANDA_W, 1, 1, 5, 5, 400, '', NM_USUARIO_P, nr_seq_campo_w);

		end;
	else
		begin

		/* Almir  -  alterei o limite de 2000 para 1800.
		   quando o select estava proximo de 2000 ele adicionava uma nova linha que ultrapassava o
		   tamnho 2000.  Por isso reduzi o limite para eliminar esse problema. */
		if (length(ds_sql_select_w) > 1800) then
			begin
			if (ie_criou_nova_banda_w = 'N') and (position('from' in ds_sql_w) = 0) then
				ds_sql_from_w	:= 'from ' || nm_tabela_avaliacao_w || ' ' ||
								   'where nr_sequencia = :nr_seq_avaliacao';

				ds_sql_w		:= ds_sql_w || '   '  || ds_sql_from_w;

				update	banda_relatorio
				set 	ds_sql		= ds_sql_w
				where	nr_sequencia	= nr_seq_banda_w;
			end if;

			ie_criou_nova_banda_w	:= 'S';
			nr_seq_banda_limite_w	:= nr_seq_banda_w;
			nr_seq_apresentacao_w	:= nr_seq_apresentacao_w + 5;

			select	nextval('banda_relatorio_seq')
			into STRICT	nr_seq_banda_w
			;
			ds_banda_w	:= substr(ds_item_w,1,30);


			insert into banda_relatorio(
				nr_sequencia, ie_tipo_banda, ds_banda, dt_atualizacao, nm_usuario, qt_altura,
				ds_cor_fundo, ie_quebra_pagina, ie_reimprime_nova_pagina, ie_alterna_cor_fundo,
				ie_imprime_vazio,	ie_imprime_primeiro, ie_borda_sup, ie_borda_inf,
				ie_borda_esq, ie_borda_dir, nr_seq_banda_superior, nr_seq_relatorio,
				nm_tabela, ds_sql, ds_expressao, nr_seq_apresentacao, ds_cor_header,
				ds_cor_footer, ds_cor_quebra,ds_regra, ie_banda_padrao, qt_max_registro)
			values (nr_seq_banda_w,ie_tipo_banda_w, ds_banda_w,clock_timestamp(), nm_usuario_p, qt_altura_w,
				ds_cor_fundo_w, ie_quebra_pagina_w,ie_reimprime_nova_pagina_w,ie_alterna_cor_fundo_w,
				ie_imprime_vazio_w,ie_imprime_primeiro_w,ie_borda_sup_w,ie_borda_inf_w,
				ie_borda_esq_w,ie_borda_dir_w, nr_seq_banda_limite_w, nr_seq_relatorio_p,
				nm_tabela_w, ds_sql_w,ds_expressao_w, nr_seq_apresentacao_w, ds_cor_header_w,
				ds_cor_footer_w,ds_cor_quebra_w,ds_regra_w,ie_banda_padrao_w, qt_max_registro_w);

			nr_seq_apresent_campo_w	:= 3;
			qt_topo_campo_lb_w	:= 25;
			qt_esq_campo_lb_w 	:= 5;
			qt_tam_campo_lb_w	:= 80;
			qt_topo_campo_w		:= 25;
			qt_esq_campo_w		:= 90;
			qt_tam_campo_w		:= 30;
			ds_sql_select_w		:= '';
			ds_sql_from_w		:= 'from ' || nm_tabela_avaliacao_w || ' ' ||
						   'where nr_sequencia = :nr_seq_avaliacao';



			end;
		end if;

		nm_atributo_w		:= 'Cp_' || nr_seq_item_w;
		nm_campo_w		:= 'Lb ' || substr(ds_item_w,1,60);

		if (ie_resultado_w	= 'V' ) then
			ds_base_w	:= 'campo_numerico(Aval' ||'('||'nr_sequencia'||
					','||nr_seq_item_w||'))'||' '|| nm_atributo_w;
		elsif (ie_resultado_w	= 'S' ) then
			ds_base_w	:= 'substr(obter_desc_result_avaliacao(nr_sequencia'||
					','||nr_seq_item_w||'),1,255)'||' '|| nm_atributo_w || chr(10);
		else
			ds_base_w	:= 'substr(Aval' ||'('||'nr_sequencia'||
					','||nr_seq_item_w||'),1,255)'||' '|| nm_atributo_w || chr(10);
		end if;

		if (coalesce(ds_sql_select_w::text, '') = '') then
			ds_sql_select_w	:= ds_base_w;
		else
			ds_sql_select_w	:= ds_sql_select_w || ',' || ds_base_w;
		end if;


		if (ie_resultado_w	= 'B') then  /* Booleano - CheckBox */
			begin
			nr_seq_campo_w := Criar_Campo_Relatorio(nr_seq_banda_w, DS_ITEM_W, nr_seq_apresent_campo_w, 1, qt_topo_campo_lb_w, qt_esq_campo_lb_w, qt_tam_campo_lb_w, '', NM_USUARIO_P, nr_seq_campo_w);
			nr_seq_campo_w := Criar_Campo_Relatorio(nr_seq_banda_w, NM_CAMPO_W, nr_seq_apresent_campo_w + 3, 0, qt_topo_campo_w, qt_esq_campo_w, qt_tam_campo_w, NM_ATRIBUTO_W, NM_USUARIO_P, nr_seq_campo_w);
			qt_esq_campo_lb_w		:= qt_esq_campo_lb_w + 150;
			qt_esq_campo_w		:= qt_esq_campo_w	 + 150;
			if (qt_esq_campo_lb_w	> 550) then
				begin
				qt_esq_campo_lb_w		:= 5;
				qt_esq_campo_w		:= 90;
				qt_topo_campo_lb_w	:= qt_topo_campo_lb_w + 20;
				qt_topo_campo_w		:= qt_topo_campo_w + 20;
				end;
			end if;
			end;

		elsif (ie_resultado_w	= 'V') then  /* Valor - Edit */
			begin
			qt_tam_campo_w		:= 70;
			nr_seq_campo_w := Criar_Campo_Relatorio(nr_seq_banda_w, DS_ITEM_W, nr_seq_apresent_campo_w, 1, qt_topo_campo_lb_w, qt_esq_campo_lb_w, qt_tam_campo_lb_w, '', NM_USUARIO_P, nr_seq_campo_w);
			nr_seq_campo_w := Criar_Campo_Relatorio(nr_seq_banda_w, NM_CAMPO_W, nr_seq_apresent_campo_w + 3, 0, qt_topo_campo_w, qt_esq_campo_w, qt_tam_campo_w, NM_ATRIBUTO_W, NM_USUARIO_P, nr_seq_campo_w);
			end;
		elsif (ie_resultado_w	= 'C') then  /* Edit */
			begin
			qt_tam_campo_w		:= 100;
			nr_seq_campo_w := Criar_Campo_Relatorio(nr_seq_banda_w, DS_ITEM_W, nr_seq_apresent_campo_w, 1, qt_topo_campo_lb_w, qt_esq_campo_lb_w, qt_tam_campo_lb_w, '', NM_USUARIO_P, nr_seq_campo_w);
			nr_seq_campo_w := Criar_Campo_Relatorio(nr_seq_banda_w, NM_CAMPO_W, nr_seq_apresent_campo_w + 3, 0, qt_topo_campo_w, qt_esq_campo_w, qt_tam_campo_w, NM_ATRIBUTO_W, NM_USUARIO_P, nr_seq_campo_w);
			qt_esq_campo_lb_w		:= qt_esq_campo_lb_w + 150;
			qt_esq_campo_w		:= qt_esq_campo_w	 + 150;
			end;
		elsif (ie_resultado_w = 'S') or (ie_resultado_w = 'O') then /* Sel. Simples - LookupComboBox */
			begin
			qt_tam_campo_w		:= 200;
			if (qt_resultado_w = 0) then
				begin
				nr_seq_campo_w := Criar_Campo_Relatorio(nr_seq_banda_w, DS_ITEM_W, nr_seq_apresent_campo_w, 1, qt_topo_campo_lb_w, qt_esq_campo_lb_w, qt_tam_campo_lb_w, '', NM_USUARIO_P, nr_seq_campo_w);
				nr_seq_campo_w := Criar_Campo_Relatorio(nr_seq_banda_w, NM_CAMPO_W, nr_seq_apresent_campo_w + 3, 0, qt_topo_campo_w, qt_esq_campo_w, qt_tam_campo_w, NM_ATRIBUTO_W, NM_USUARIO_P, nr_seq_campo_w);
				end;
			else
				begin
				nr_seq_campo_w := Criar_Campo_Relatorio(nr_seq_banda_w, DS_ITEM_W, nr_seq_apresent_campo_w, 1, qt_topo_campo_lb_w, qt_esq_campo_lb_w, qt_tam_campo_lb_w, '', NM_USUARIO_P, nr_seq_campo_w);
				nr_seq_campo_w := Criar_Campo_Relatorio(nr_seq_banda_w, NM_CAMPO_W, nr_seq_apresent_campo_w + 3, 0, qt_topo_campo_w, qt_esq_campo_w, qt_tam_campo_w, NM_ATRIBUTO_W, NM_USUARIO_P, nr_seq_campo_w);
				end;
			end if;
			qt_esq_campo_lb_w		:= qt_esq_campo_lb_w + 255;
			qt_esq_campo_w		:= qt_esq_campo_w	 + 255;
			end;
		else  /* (ie_resultado_w	= 'D') then   Dominio - Memo  */
			begin
			qt_tam_campo_w		:= 265;
			nr_seq_campo_w := Criar_Campo_Relatorio(nr_seq_banda_w, DS_ITEM_W, nr_seq_apresent_campo_w, 1, qt_topo_campo_lb_w, qt_esq_campo_lb_w, qt_tam_campo_lb_w, '', NM_USUARIO_P, nr_seq_campo_w);
			nr_seq_campo_w := Criar_Campo_Relatorio(nr_seq_banda_w, NM_CAMPO_W, nr_seq_apresent_campo_w + 3, 0, qt_topo_campo_w, qt_esq_campo_w, qt_tam_campo_w, NM_ATRIBUTO_W, NM_USUARIO_P, nr_seq_campo_w);
			qt_esq_campo_lb_w		:= qt_esq_campo_lb_w + 340;
			qt_esq_campo_w		:= qt_esq_campo_w	 + 340;
			if (qt_esq_campo_lb_w	> 350) then
				begin
				qt_esq_campo_lb_w		:= 5;
				qt_esq_campo_w		:= 90;
				qt_topo_campo_lb_w	:= qt_topo_campo_lb_w + 20;
				qt_topo_campo_w		:= qt_topo_campo_w + 20;
				end;
			end if;
			end;
		end if;
		nr_seq_apresent_campo_w	:= nr_seq_apresent_campo_w + 5;
		ds_sql_w		:= 'Select '|| substr(ds_sql_select_w,1,2000) ||'   '  || ds_sql_from_w;

		update	banda_relatorio
		set 	ds_sql		= ds_sql_w
		where	nr_sequencia	= nr_seq_banda_w;
		end;

 	end if;
	end;
	END LOOP;
	CLOSE C01;

if (ie_criou_nova_banda_w = 'N') and (position('from' in ds_sql_w) = 0) then
	ds_sql_from_w	:= 'from ' || nm_tabela_avaliacao_w || ' ' ||
					   'where nr_sequencia = :nr_seq_avaliacao';

	ds_sql_w		:= ds_sql_w || '   '  || ds_sql_from_w;

	update	banda_relatorio
	set 	ds_sql		= ds_sql_w
	where	nr_sequencia	= nr_seq_banda_w;
end if;

nr_seq_apresentacao_w	:= nr_seq_apresentacao_w + 5;

-- Rodapé
insert into banda_relatorio(
	nr_sequencia, 			ie_tipo_banda,
	ds_banda, 			dt_atualizacao,
	nm_usuario,			qt_altura,
	ds_cor_fundo,			ie_quebra_pagina,
	ie_reimprime_nova_pagina,	ie_alterna_cor_fundo,
	ie_imprime_vazio,		ie_imprime_primeiro,
	ie_borda_sup,			ie_borda_inf,
	ie_borda_esq, 			ie_borda_dir,
	nr_seq_relatorio,		nr_seq_apresentacao,
	ds_cor_header,			ds_cor_footer,
	ds_cor_quebra,			ie_banda_padrao)
values (nextval('banda_relatorio_seq'), 	'R',
	obter_desc_expressao(486586)/*'Rodapé'*/
, 			clock_timestamp(),
	'Tasy',				17,
	'clWhite', 			'N',
	'N',				'N',
	'N',				'N',
	'S',				'N',
	'N',				'N',
	nr_seq_relatorio_p, 		nr_seq_apresentacao_w,
	'clSilver',			'clWhite',
	'$00E5E5E5',			'S');

nr_seq_banda_sup_w		:= nr_seq_banda_w;

commit;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_relatorio_wavaliar ( nr_seq_relatorio_p bigint, nr_seq_avaliacao_p bigint, nm_usuario_p text) FROM PUBLIC;

