-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';



CREATE TYPE atendimento AS (nr_atendimento bigint);


CREATE OR REPLACE PROCEDURE gerar_alerta_autor_job (ie_tipo_autorizacao_p text, nm_usuario_p text, cd_estabelecimento_p bigint) AS $body$
DECLARE

type vetor_atendimento is table of atendimento index by integer;

nr_atendimento_w	bigint;
cd_convenio_w		integer;
ie_tipo_regra_w		varchar(1);
i			integer;
k			integer;
vetor_atend_w		vetor_atendimento;

c01 CURSOR FOR 
SELECT	a.nr_atendimento, 
	obter_convenio_atendimento(a.nr_atendimento) cd_convenio, 
	'A' ie_tipo_regra 
from	atendimento_paciente a 
where	a.dt_alta_interno > clock_timestamp() 
and	coalesce(a.dt_alta::text, '') = '' 
and	coalesce(a.dt_fim_conta::text, '') = '' 
and	a.ie_fim_conta = 'A' 
and	to_char(a.cd_estabelecimento) 	= to_char(cd_estabelecimento_p) 
and	a.ie_tipo_atendimento	= 1;


BEGIN 
 
i	:= 1;
open c01;
loop 
fetch c01 into 
	nr_atendimento_w, 
	cd_convenio_w, 
	ie_tipo_regra_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
 
	vetor_atend_w[i].nr_atendimento := nr_atendimento_w;
	i	:= i + 1;
end loop;
close c01;
 
i := vetor_atend_w.count;
for k in 1.. i loop 
	begin 
	nr_atendimento_w	:= Vetor_atend_w[k].nr_atendimento;
	begin 
	CALL Gerar_alerta_autorizacao(nr_atendimento_w,nm_usuario_p);
	exception 
	when others then 
		null;
	end;
	commit;
	end;
end loop;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_alerta_autor_job (ie_tipo_autorizacao_p text, nm_usuario_p text, cd_estabelecimento_p bigint) FROM PUBLIC;

