-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_analise_ort_objeto ( nr_seq_lote_p bigint, ds_form_p text, ds_nome_objeto_p text, ds_classe_objeto_p text, ds_campo_p text, ds_conteudo_campo_p text, ds_campo_pai_p text, ds_metodo_p text, nr_ocorrencia_p bigint, nm_usuario_p text, ie_nova_analise_p INOUT text) AS $body$
DECLARE


/*	ie_nova_analise_p

S	Gerou nova análise
N	Atualizou análise já existente

*/
nr_sequencia_w		bigint;
cd_funcao_w		integer;
ds_form_w		varchar(10);
nr_seq_analise_w	bigint;
ie_nova_analise_w	varchar(1);


BEGIN

/* se já foi gerada análise ortográfica para o objeto, não precisa gerar novamente, a não ser que tenham ocorrido alterações */

select	max(a.nr_sequencia)
into STRICT	nr_seq_analise_w
from	analise_ortografica a
where	coalesce(a.nr_ocorrencia,0)		= coalesce(nr_ocorrencia_p,0)
and	coalesce(a.ds_metodo,'-1')		= coalesce(ds_metodo_p,'-1')
and	coalesce(a.ds_conteudo_campo,'-1')	= coalesce(ds_conteudo_campo_p,'-1')
and	coalesce(a.ds_classe_objeto,'-1')	= coalesce(ds_classe_objeto_p,'-1')
and	coalesce(a.ds_campo_pai,'-1')	= coalesce(ds_campo_pai_p,'-1')
and	a.ds_campo			= ds_campo_p
and	coalesce(a.ds_nome_objeto,'-1')	= coalesce(ds_nome_objeto_p,'-1')
and	a.ds_form			= ds_form_p;

if (coalesce(nr_seq_analise_w::text, '') = '') then

	ie_nova_analise_w	:= 'S';

else

	select	coalesce(max('N'),'S')
	into STRICT	ie_nova_analise_w
	from	analise_ortografica_lote b,
		analise_ortografica a
	where (coalesce(a.ie_permanecer,'N') = 'S' or
		(b.dt_confirmacao IS NOT NULL AND b.dt_confirmacao::text <> '') or
		a.nr_seq_lote = nr_seq_lote_p or
		exists (SELECT	1
		from	analise_ortografica_lote z,
			analise_ortografica y
		where	(z.dt_confirmacao IS NOT NULL AND z.dt_confirmacao::text <> '')
		and	y.nr_seq_lote		= z.nr_sequencia
		and	coalesce(y.ie_diferenca,'N')	= 'S'
		and	y.nr_seq_origem		= a.nr_sequencia))
	and	a.nr_seq_lote	= b.nr_sequencia
	and	a.nr_sequencia	= nr_seq_analise_w;

end if;

if (ie_nova_analise_w	<> 'N') then

	/* excluir para não gerar registros duplicados */

	delete	from analise_ortografica a
	where	coalesce(a.nr_ocorrencia,0)		= coalesce(nr_ocorrencia_p,0)
	and	coalesce(a.ds_metodo,'-1')		= coalesce(ds_metodo_p,'-1')
	and	coalesce(a.ds_classe_objeto,'-1')	= coalesce(ds_classe_objeto_p,'-1')
	and	coalesce(a.ds_campo_pai,'-1')	= coalesce(ds_campo_pai_p,'-1')
	and	coalesce(a.ds_nome_objeto,'-1')	= coalesce(ds_nome_objeto_p,'-1')
	and	a.ds_form			= ds_form_p
	and	a.ds_campo			= ds_campo_p
	and	exists (SELECT	1
		from	analise_ortografica_lote x
		where	(x.dt_analise IS NOT NULL AND x.dt_analise::text <> '')
		and	coalesce(x.dt_confirmacao::text, '') = ''
		and	x.nr_sequencia		= a.nr_seq_lote)
	and	not exists (select	1
		from	analise_ortografica_lote y,
			analise_ortografica x
		where	(y.dt_confirmacao IS NOT NULL AND y.dt_confirmacao::text <> '')
		and	x.nr_seq_lote		= y.nr_sequencia
		and	x.nr_seq_origem		= a.nr_sequencia);

	ds_form_w	:= substr(upper(replace(ds_form_p,'_',null)),1,10);

	select	max(a.cd_funcao)
	into STRICT	cd_funcao_w
	from	funcao a
	where	upper(replace(a.ds_form,'_',null))	= ds_form_w;

	select	coalesce(max(a.nr_sequencia),0) + 1
	into STRICT	nr_sequencia_w
	from	analise_ortografica a;

	insert	into analise_ortografica(ds_campo,
		ds_campo_pai,
		ds_classe_objeto,
		ds_conteudo_campo,
		ds_form,
		ds_metodo,
		ds_nome_objeto,
		dt_atualizacao,
		dt_atualizacao_nrec,
		dt_origem,
		ie_origem,
		nm_usuario,
		nm_usuario_nrec,
		nm_usuario_origem,
		nr_ocorrencia,
		nr_seq_lote,
		nr_sequencia)
	values (ds_campo_p,
		ds_campo_pai_p,
		ds_classe_objeto_p,
		ds_conteudo_campo_p,
		ds_form_p,
		ds_metodo_p,
		ds_nome_objeto_p,
		clock_timestamp(),
		clock_timestamp(),
		clock_timestamp(),
		'U',
		nm_usuario_p,
		nm_usuario_p,
		nm_usuario_p,
		nr_ocorrencia_p,
		nr_seq_lote_p,
		nr_sequencia_w);

end	if;

ie_nova_analise_p	:= ie_nova_analise_w;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_analise_ort_objeto ( nr_seq_lote_p bigint, ds_form_p text, ds_nome_objeto_p text, ds_classe_objeto_p text, ds_campo_p text, ds_conteudo_campo_p text, ds_campo_pai_p text, ds_metodo_p text, nr_ocorrencia_p bigint, nm_usuario_p text, ie_nova_analise_p INOUT text) FROM PUBLIC;

