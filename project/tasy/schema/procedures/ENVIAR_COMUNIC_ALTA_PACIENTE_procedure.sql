-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE enviar_comunic_alta_paciente () AS $body$
DECLARE

 
nm_paciente_w		varchar(40);
cd_setor_destino_w	integer;
cd_medico_resp_w	varchar(10);
nm_usuario_w		varchar(15);
dt_previsto_alta_w	timestamp;

c01 CURSOR FOR 
	SELECT	cd_medico_resp, 
		substr(obter_nome_pf(cd_pessoa_fisica),1,40), 
		obter_usuario_pessoa(cd_medico_resp), 
		obter_setor_atendimento(nr_atendimento), 
		dt_previsto_alta 
	from	atendimento_paciente 
	where	dt_alta > dt_previsto_alta 
	and	(dt_alta IS NOT NULL AND dt_alta::text <> '');


BEGIN 
 
OPEN C01;
LOOP 
FETCH C01 into 
	cd_medico_resp_w, 
	nm_paciente_w, 
	nm_usuario_w, 
	cd_setor_destino_w, 
	dt_previsto_alta_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	begin 
 
	insert	into comunic_interna(nr_sequencia, 
		dt_comunicado, 
		ds_titulo, 
		ds_comunicado, 
		nm_usuario, 
		nm_usuario_destino, 
		dt_atualizacao, 
		ie_geral, 
		ie_gerencial, 
		cd_setor_destino, 
		dt_liberacao) 
	values (nextval('comunic_interna_seq'), 
		clock_timestamp(), 
		wheb_mensagem_pck.get_texto(803140), 
		wheb_mensagem_pck.get_texto(803141, 'NM_PACIENTE='||nm_paciente_w) || Chr(13) || Chr(10) || 
		wheb_mensagem_pck.get_texto(803142) || ': ' || dt_previsto_alta_w, 
		'Tasy', 
		nm_usuario_w, 
		clock_timestamp(), 
		'N', 
		'N', 
		cd_setor_destino_w, 
		clock_timestamp());
	 
	end;
END LOOP;
CLOSE C01;
 
commit;
 
end	;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE enviar_comunic_alta_paciente () FROM PUBLIC;

