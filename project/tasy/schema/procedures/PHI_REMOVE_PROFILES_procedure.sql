-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE phi_remove_profiles ( nr_seq_usuario_grupo_p bigint default null, ie_tipo_grupo_p text default null) AS $body$
DECLARE

/*
	++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
	Objective: Executed daily on the job that removes all the profiles from
	the users that are not on vigency anymore, thus remove the profiles of
	a single user
	------------------------------------------------------------------------
	Direct call: 
	[   ] Dictionary objects
	[   ] Tasy (Delphi/Java/HTML5)
	[   ] Portal
	[   ] Reports
	[   ] Others:
	 -----------------------------------------------------------------------
	Attention points: N/A
	------------------------------------------------------------------------
	Parameters:
		IE_TIPO_GRUPO_P: ('D'-Devlopment, 'S'-Support, 'G'-Management)
	------------------------------------------------------------------------
	Called in:
		Java: N/A
		HTML5: N/A
		Object: JOB PHI_REMOVE_PROFILES_J
	++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
*/
BEGIN

if (phi_is_base_philips = 'S') then
	begin

	delete
	from	usuario_perfil up
	where	up.nm_usuario like(SELECT	ugd.nm_usuario_grupo
			from	usuario_grupo_des ugd
			where	ugd.nr_sequencia = coalesce(nr_seq_usuario_grupo_p, ugd.nr_sequencia)
			and	trunc(ugd.dt_fim_vigencia) = trunc(clock_timestamp())
			and	ugd.ie_motivo_inativacao in ('D', 'S')
			and (ie_tipo_grupo_p = 'D' or coalesce(ie_tipo_grupo_p::text, '') = ''));

	delete
	from	usuario_perfil up
	where	up.nm_usuario like(SELECT	ugs.nm_usuario_grupo
			from	usuario_grupo_sup ugs
			where	ugs.nr_sequencia = coalesce(nr_seq_usuario_grupo_p, ugs.nr_sequencia)
			and	trunc(ugs.dt_fim_vigencia) = trunc(clock_timestamp())
			and	ugs.ie_motivo_inativacao in ('D', 'S')
			and (ie_tipo_grupo_p = 'S' or coalesce(ie_tipo_grupo_p::text, '') = ''));

	delete
	from	usuario_perfil up
	where	up.nm_usuario like(SELECT	gwgu.nm_usuario_grupo
			from	gerencia_wheb_grupo_usu gwgu
			where	gwgu.nr_sequencia = coalesce(nr_seq_usuario_grupo_p, gwgu.nr_sequencia)
			and	trunc(gwgu.dt_fim) = trunc(clock_timestamp())
			and	gwgu.ie_motivo_inativacao in ('D', 'S')
			and (ie_tipo_grupo_p = 'G' or coalesce(ie_tipo_grupo_p::text, '') = ''));
	end;
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE phi_remove_profiles ( nr_seq_usuario_grupo_p bigint default null, ie_tipo_grupo_p text default null) FROM PUBLIC;

