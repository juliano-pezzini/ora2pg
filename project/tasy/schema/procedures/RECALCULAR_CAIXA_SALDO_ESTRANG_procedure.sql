-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE recalcular_caixa_saldo_estrang (nr_seq_caixa_saldo_p bigint) AS $body$
DECLARE


/* Projeto Multimoeda - Procedure utilizada para recalcular o saldo do caixa em moeda estrangeira, para caixas que permitam
	transações em outras moedas que não seja a moeda padrão da empresa. */
-- NÃO REALIZAR COMMIT NESTA PROCEDURE
/* Projeto Multimoeda - Variáveis */

nr_sequencia_w			bigint;
cd_moeda_w			integer;
nr_seq_caixa_w			bigint;
vl_transacoes_w			double precision 	:= 0;
vl_cheque_pre_w			double precision	:= 0;
vl_cheque_vista_w		double precision	:= 0;
vl_especie_w			double precision	:= 0;
vl_transf_saida_cheque_pre_w	double precision	:= 0;
vl_transf_saida_cheque_vista_w	double precision	:= 0;
vl_transf_saida_especie_w	double precision	:= 0;
vl_transf_entr_cheque_pre_w	double precision	:= 0;
vl_transf_entr_cheque_vista_w	double precision	:= 0;
vl_transf_entr_especie_w	double precision	:= 0;
vl_total_cheque_pre_w		double precision	:= 0;
vl_total_cheque_vista_w		double precision	:= 0;
vl_total_especie_w		double precision	:= 0;
vl_especie_dep_w		double precision	:= 0;
vl_cheque_pre_dep_w		double precision	:= 0;
vl_cheque_vista_dep_w		double precision	:= 0;
vl_transacao_estrang_w		double precision	:= 0;
vl_cheque_vista_transf_w	double precision	:= 0;
vl_especie_transf_w		double precision	:= 0;
vl_cheque_pre_transf_w		double precision	:= 0;
cd_estabelecimento_w		bigint;
ie_saldo_caixa_w		varchar(255);
ie_saldo_dep_cheque_w		varchar(255);
nr_seq_deposito_w		bigint;
ie_caixa_w			varchar(01)	:= null;
cd_moeda_empresa_w		integer;

C01 CURSOR FOR
SELECT	cd_moeda,
	nr_sequencia
from	caixa_saldo_estrang
where	nr_seq_caixa_saldo = nr_seq_caixa_saldo_p;

c02 CURSOR FOR
SELECT	a.vl_transacao_estrang,
	coalesce(b.ie_saldo_caixa,'N'),
	a.nr_seq_deposito,
	coalesce(b.ie_caixa,'N')
from	transacao_financeira b,
	movto_trans_financ a
where	a.nr_seq_trans_financ	= b.nr_sequencia
and	a.nr_seq_saldo_caixa	= nr_seq_caixa_saldo_p
and	coalesce(a.cd_moeda,cd_moeda_empresa_w) = cd_moeda_w; -- Projeto Multimoeda - Busca apenas o que é referente a moeda do saldo
BEGIN

select	nr_seq_caixa
into STRICT	nr_seq_caixa_w
from	caixa_saldo_diario
where	nr_sequencia = nr_seq_caixa_saldo_p;

select	cd_estabelecimento
into STRICT	cd_estabelecimento_w
from	caixa
where	nr_sequencia	= nr_seq_caixa_w;

/* Projeto Multimoeda - Busca a moeda padrão da empresa */

select	obter_moeda_padrao_empresa(cd_estabelecimento_w,'E')
into STRICT	cd_moeda_empresa_w
;

open c01;
loop
fetch c01 into
	cd_moeda_w,
	nr_sequencia_w;
EXIT WHEN NOT FOUND; /* apply on c01 */

	select	coalesce(sum(CASE WHEN b.ie_saldo_caixa='S' THEN  a.vl_transacao_estrang * -1  ELSE a.vl_transacao_estrang END ),0)
	into STRICT	vl_transacoes_w
	from	transacao_financeira b,
		movto_trans_financ a
	where	a.nr_seq_saldo_caixa	= nr_seq_caixa_saldo_p
	and	a.nr_seq_trans_financ	= b.nr_sequencia
	and	coalesce(a.cd_moeda,cd_moeda_empresa_w) = cd_moeda_w -- Projeto Multimoeda - Busca apenas o que é referente a moeda do saldo
	and	b.ie_saldo_caixa	in ('S', 'E')
	and	b.ie_caixa		in ('D', 'T', 'A');

	update	caixa_saldo_estrang
	set	vl_saldo	= coalesce(vl_saldo_inicial,0) + vl_transacoes_w
	where	nr_sequencia	= nr_sequencia_w;

	/* Francisco - 09/06/07 - Saldos de cheque pré e cartão */

	select	coalesce(sum(CASE WHEN b.ie_cheque_cr='P' THEN CASE WHEN b.ie_saldo_caixa='S' THEN a.vl_transacao_estrang * -1  ELSE a.vl_transacao_estrang END   ELSE 0 END ),0),
		coalesce(sum(CASE WHEN b.ie_cheque_cr='V' THEN CASE WHEN b.ie_saldo_caixa='S' THEN a.vl_transacao_estrang * -1  ELSE a.vl_transacao_estrang END   ELSE 0 END ),0),
		coalesce(sum(CASE WHEN b.ie_especie='S' THEN CASE WHEN b.ie_saldo_caixa='S' THEN a.vl_transacao_estrang * -1  ELSE a.vl_transacao_estrang END   ELSE 0 END ),0)
	into STRICT	vl_cheque_pre_w,
		vl_cheque_vista_w,
		vl_especie_w
	from	transacao_financeira b,
		movto_trans_financ a
	where	a.nr_seq_saldo_caixa	= nr_seq_caixa_saldo_p
	and	a.nr_seq_trans_financ	= b.nr_sequencia
	and	coalesce(a.cd_moeda,cd_moeda_empresa_w) = cd_moeda_w -- Projeto Multimoeda - Busca apenas o que é referente a moeda do saldo
	and	((ie_saldo_dep_cheque_w	= 'N')
		 or (coalesce(a.nr_seq_deposito::text, '') = ''))  -- OS 232580 em 14/07/2010. dsantos - edgar.
	and	b.ie_caixa		in ('M','A','T');

	/* Tratar as transferencias originadas de monetarias e que não tem os campos definidos,
	ex: "Transferência espécie saída" mas sem o campo IE_ESPECIE_MARCADO */
	select	coalesce(sum(CASE WHEN b.ie_cheque_cr='P' THEN CASE WHEN b.ie_saldo_caixa='S' THEN a.vl_transacao_estrang * -1  ELSE a.vl_transacao_estrang END   ELSE 0 END ),0),
		coalesce(sum(CASE WHEN b.ie_cheque_cr='V' THEN CASE WHEN b.ie_saldo_caixa='S' THEN a.vl_transacao_estrang * -1  ELSE a.vl_transacao_estrang END   ELSE 0 END ),0),
		coalesce(sum(CASE WHEN b.ie_especie='S' THEN CASE WHEN b.ie_saldo_caixa='S' THEN a.vl_transacao_estrang * -1  ELSE a.vl_transacao_estrang END   ELSE 0 END ),0)
	into STRICT	vl_transf_saida_cheque_pre_w,
		vl_transf_saida_cheque_vista_w,
		vl_transf_saida_especie_w
	from	transacao_financeira b,
		movto_trans_financ a
	where	a.nr_seq_trans_financ	= b.nr_sequencia
	and	coalesce(a.cd_moeda,cd_moeda_empresa_w) = cd_moeda_w -- Projeto Multimoeda - Busca apenas o que é referente a moeda do saldo
	and	b.ie_caixa		in ('M','A')
	and	exists (SELECT	1
			from	transacao_financeira y,
				movto_trans_financ x
			where	x.nr_seq_trans_financ	= y.nr_sequencia
			and	x.nr_seq_saldo_caixa	= nr_seq_caixa_saldo_p
			and	y.ie_caixa		= 'T'
			and	y.ie_saldo_caixa	= 'S'
			and	coalesce(x.cd_moeda,cd_moeda_empresa_w) = cd_moeda_w -- Projeto Multimoeda - Busca apenas o que é referente a moeda do saldo
			and	x.nr_sequencia		= a.nr_seq_movto_transf
			and	y.ie_cheque_cr		not in ('P','V')
			and	y.ie_cartao_cr		<> 'S'
			and	y.ie_cartao_debito	<> 'S'
			and	y.ie_especie		<> 'S');

	/* Tratar as transferencias originadas de monetarias e que não tem os campos definidos,
	ex: "Transferência espécie entrada" mas sem o campo IE_ESPECIE_MARCADO */
	select	coalesce(sum(CASE WHEN b.ie_cheque_cr='P' THEN CASE WHEN b.ie_saldo_caixa='S' THEN a.vl_transacao_estrang * -1  ELSE a.vl_transacao_estrang END   ELSE 0 END ),0),
		coalesce(sum(CASE WHEN b.ie_cheque_cr='V' THEN CASE WHEN b.ie_saldo_caixa='S' THEN a.vl_transacao_estrang * -1  ELSE a.vl_transacao_estrang END   ELSE 0 END ),0),
		coalesce(sum(CASE WHEN b.ie_especie='S' THEN CASE WHEN b.ie_saldo_caixa='S' THEN a.vl_transacao_estrang * -1  ELSE a.vl_transacao_estrang END   ELSE 0 END ),0)
	into STRICT	vl_transf_entr_cheque_pre_w,
		vl_transf_entr_cheque_vista_w,
		vl_transf_entr_especie_w
	from	transacao_financeira b,
		movto_trans_financ a
	where	a.nr_seq_trans_financ	= b.nr_sequencia
	and	coalesce(a.cd_moeda,cd_moeda_empresa_w) = cd_moeda_w -- Projeto Multimoeda - Busca apenas o que é referente a moeda do saldo
	and	b.ie_caixa		in ('M','A')
	and	exists (SELECT	1
			from	transacao_financeira y,
				movto_trans_financ x
			where	x.nr_seq_trans_financ	= y.nr_sequencia
			and	y.ie_caixa		= 'T'
			and	y.ie_saldo_caixa	= 'S'
			and	x.nr_sequencia		= a.nr_seq_movto_transf
			and	coalesce(x.cd_moeda,cd_moeda_empresa_w) = cd_moeda_w -- Projeto Multimoeda - Busca apenas o que é referente a moeda do saldo
			and	exists (select	1
					from	transacao_financeira z,
						movto_trans_financ w
					where	w.nr_seq_trans_financ	= z.nr_sequencia
					and	w.nr_seq_saldo_caixa	= nr_seq_caixa_saldo_p
					and	z.ie_caixa		= 'T'
					and	z.ie_saldo_caixa	= 'E'
					and	w.nr_sequencia		= x.nr_seq_movto_transf
					and	coalesce(w.cd_moeda,cd_moeda_empresa_w) = cd_moeda_w -- Projeto Multimoeda - Busca apenas o que é referente a moeda do saldo
					and	z.ie_cheque_cr		not in ('P','V')
					and	z.ie_cartao_cr		<> 'S'
					and	z.ie_cartao_debito	<> 'S'
					and	z.ie_especie		<> 'S'));

	vl_total_cheque_pre_w	:= vl_cheque_pre_w - vl_transf_saida_cheque_pre_w + vl_transf_entr_cheque_pre_w;
	vl_total_cheque_vista_w	:= vl_cheque_vista_w - vl_transf_saida_cheque_vista_w + vl_transf_entr_cheque_vista_w;
	vl_total_especie_w	:= vl_especie_w - vl_transf_saida_especie_w + vl_transf_entr_especie_w;

	begin
	select	coalesce(ie_saldo_dep_cheque,'N')
	into STRICT	ie_saldo_dep_cheque_w
	from	parametro_tesouraria
	where	cd_estabelecimento	= cd_estabelecimento_w;
	exception
	when no_data_found then
		--r.aise_application_error(-20011, 'Parâmetros da tesouraria não cadastrado para o estabelecimento ' || cd_estabelecimento_w || '.');
		CALL wheb_mensagem_pck.exibir_mensagem_abort(264858,'CD_ESTABELECIMENTO_W='||cd_estabelecimento_w);
	end;

	if (ie_saldo_dep_cheque_w = 'S') then

		open c02;
		loop
		fetch c02 into
			vl_transacao_estrang_w,
			ie_saldo_caixa_w,
			nr_seq_deposito_w,
			ie_caixa_w;
		EXIT WHEN NOT FOUND; /* apply on c02 */

			if (nr_seq_deposito_w IS NOT NULL AND nr_seq_deposito_w::text <> '') then

				select	coalesce(sum(CASE WHEN obter_se_cheque_cr_avista(a.nr_seq_cheque)='S' THEN a.vl_cheque_estrang  ELSE 0 END ),0),
					coalesce(sum(CASE WHEN obter_se_cheque_cr_avista(a.nr_seq_cheque)='N' THEN a.vl_cheque_estrang  ELSE 0 END ),0)
				into STRICT	vl_cheque_vista_dep_w,
					vl_cheque_pre_dep_w
				from	deposito_cheque b,
					cheque_cr a
				where	a.nr_seq_cheque		= b.nr_seq_cheque
				and	b.nr_seq_deposito	= nr_seq_deposito_w;

				if (sign(vl_transacao_estrang_w) < 0) then
					vl_cheque_pre_dep_w	:= vl_cheque_pre_dep_w * -1;
					vl_cheque_vista_dep_w	:= vl_cheque_vista_dep_w * -1;
				end if;

				if (ie_saldo_caixa_w = 'S') then
					vl_cheque_pre_transf_w	:= vl_cheque_pre_transf_w + vl_cheque_pre_dep_w * -1;
					vl_cheque_vista_transf_w	:= vl_cheque_vista_transf_w + vl_cheque_vista_dep_w * -1;
				elsif (ie_saldo_caixa_w = 'E') then
					vl_cheque_pre_transf_w	:= vl_cheque_pre_transf_w + vl_cheque_pre_dep_w;
					vl_cheque_vista_transf_w	:= vl_cheque_vista_transf_w + vl_cheque_vista_dep_w;
				end if;

				select	coalesce(max(vl_especie_estrang),0)
				into STRICT	vl_especie_dep_w
				from	deposito
				where	nr_sequencia		= nr_seq_deposito_w;

				if (sign(vl_transacao_estrang_w) < 0) then
					vl_especie_dep_w		:= vl_especie_dep_w * -1;
				end if;

				if (ie_saldo_caixa_w = 'S') then
					vl_especie_transf_w		:= vl_especie_transf_w + vl_especie_dep_w * -1;
				elsif (ie_saldo_caixa_w = 'E') then
					vl_especie_transf_w		:= vl_especie_transf_w + vl_especie_dep_w;
				end if;
			end if;

		end loop;
		close c02;
	end if;

	update	caixa_saldo_estrang
	set	vl_cheque_pre_atual	= coalesce(vl_cheque_pre_inicial,0) + coalesce(vl_total_cheque_pre_w,0) + coalesce(vl_cheque_pre_transf_w,0),
		vl_cheque_vista_atual	= coalesce(vl_cheque_vista_inicial,0) + coalesce(vl_total_cheque_vista_w,0) + coalesce(vl_cheque_vista_transf_w,0),
		vl_especie_atual	= coalesce(vl_especie_inicial,0) + coalesce(vl_total_especie_w,0)+ coalesce(vl_especie_transf_w,0)
	where	nr_sequencia		= nr_sequencia_w;

	update	caixa_saldo_estrang
	set	vl_saldo_avista		= coalesce(vl_saldo,0) - coalesce(vl_cheque_pre_atual,0)
	where	nr_sequencia		= nr_sequencia_w;

end loop;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE recalcular_caixa_saldo_estrang (nr_seq_caixa_saldo_p bigint) FROM PUBLIC;

