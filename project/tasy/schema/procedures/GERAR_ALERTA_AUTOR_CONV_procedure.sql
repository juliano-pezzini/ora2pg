-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_alerta_autor_conv (nm_usuario_p text) AS $body$
DECLARE


cd_pessoa_fisica_w		varchar(10);
cd_pessoa_fisica_ww		varchar(10);
nm_pessoa_w			varchar(60);
nr_sequencia_autor_w		bigint;
ds_alerta_w			varchar(2000);
dt_fim_vigencia_w		timestamp;
nm_usuario_w			varchar(15);

C01 CURSOR FOR
	SELECT	a.nr_sequencia,
		substr(obter_nome_pf(a.cd_pessoa_fisica),1,60),
		coalesce(c.cd_medico_resp,a.cd_medico_solicitante),
		c.cd_pessoa_fisica,
		a.dt_fim_vigencia,
		a.nm_usuario
	from	autorizacao_convenio a,
		estagio_autorizacao b,
		atendimento_paciente c
	where	a.nr_atendimento = c.nr_atendimento
	and	a.nr_seq_estagio = b.nr_sequencia
	and	a.ie_tipo_autorizacao = '2'
	and	coalesce(a.dt_fim_vigencia::text, '') = ''
	and	b.ie_interno not in ('70','90','10')
	and	a.dt_autorizacao >= (clock_timestamp() - interval '30 days')
	--and	 a.dt_fim_vigencia between (sysdate - (24 * 1/24)) and (sysdate + (24 * 1/24))
	--and	a.dt_fim_vigencia > sysdate
	and	not exists (	SELECT	1
				from	autor_convenio_alerta x
				where	x.nr_sequencia_autor = a.nr_sequencia
				and	clock_timestamp() between x.dt_alerta and x.dt_fim_alerta);


BEGIN

open C01;
loop
fetch C01 into
	nr_sequencia_autor_w,
	nm_pessoa_w,
	cd_pessoa_fisica_ww,
	cd_pessoa_fisica_w,
	dt_fim_vigencia_w,
	nm_usuario_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin

	ds_alerta_w := wheb_mensagem_pck.get_texto(307598, 'DT_FIM_VIGENCIA_W=' || to_char(dt_fim_vigencia_w,'dd/mm/yyyy hh24:mi:ss'));
				/*
					Existe necessidade de prorrogação pendente de autorização
					Vigência final: #@DT_FIM_VIGENCIA_W#@
				*/
	insert	into	autor_convenio_alerta(
			cd_pessoa_alerta,
			ds_alerta,
			dt_alerta,
			dt_atualizacao,
			dt_atualizacao_nrec,
			dt_fim_alerta,
			dt_liberacao,
			ie_situacao,
			nm_usuario,
			nm_usuario_nrec,
			nr_sequencia,
			nr_sequencia_autor)
	values (	cd_pessoa_fisica_w,
			ds_alerta_w,
			clock_timestamp(),
			clock_timestamp(),
			clock_timestamp(),
			trunc(clock_timestamp()) + 86399/86400,
			null,
			'A',
			nm_usuario_w,
			nm_usuario_p,
			nextval('autor_convenio_alerta_seq'),
			nr_sequencia_autor_w);
	end;
end loop;
close C01;


commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_alerta_autor_conv (nm_usuario_p text) FROM PUBLIC;

