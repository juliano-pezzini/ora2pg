-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_autorizar_guia_web (nr_seq_guia_p bigint, ds_parecer_p text, nm_usuario_p text, nm_estipulante_p text, ie_param_guia_parcial_p text) AS $body$
DECLARE


qt_proc_liberado_w	bigint;
qt_mat_liberado_w	bigint;
qt_proc_negado_w	bigint;
qt_mat_negado_w		bigint;
qt_itens_lib_w		bigint;
qt_itens_neg_w		bigint;
ds_parecer_w		varchar(4000);
nr_seq_segurado_w	bigint;
qt_dias_validade_w	bigint;
dt_solicitacao_w	timestamp;
ie_tipo_guia_w		varchar(2);
cd_senha_w		varchar(255)	:= null;
dt_validade_senha_w	varchar(255)	:= null;
dt_validade_senha_ww	timestamp;
ie_status_w		varchar(2);
ie_estagio_w		smallint;


BEGIN

select	count(*)
into STRICT	qt_proc_liberado_w
from	pls_guia_plano_proc
where	nr_seq_guia	= nr_seq_guia_p
and	ie_status	in ('S','P');

select	count(*)
into STRICT	qt_mat_liberado_w
from	pls_guia_plano_mat
where	nr_seq_guia	= nr_seq_guia_p
and	ie_status	in ('S','P');

select	count(*)
into STRICT	qt_proc_negado_w
from	pls_guia_plano_proc
where	nr_seq_guia	= nr_seq_guia_p
and	ie_status	in ('N','M');

select	count(*)
into STRICT	qt_mat_negado_w
from	pls_guia_plano_mat
where	nr_seq_guia	= nr_seq_guia_p
and	ie_status	in ('N','M');

qt_itens_lib_w	:= qt_mat_liberado_w + qt_proc_liberado_w;
qt_itens_neg_w	:= qt_proc_negado_w + qt_mat_negado_w;

if (qt_itens_neg_w > 0 and qt_itens_lib_w > 0) then
	if (ie_param_guia_parcial_p = 'S') then
		ie_status_w	:= 1;
		ie_estagio_w	:= 10;
	else
		ie_status_w	:= 3;
		ie_estagio_w	:= 4;
	end if;
elsif (qt_itens_neg_w > 0) then
	ie_status_w	:= 3;
	ie_estagio_w	:= 4;
else
	ie_status_w	:= 1;
	ie_estagio_w	:= 6;
end if;

if (ie_estagio_w = 6 or ie_estagio_w = 10) then
	qt_dias_validade_w := (pls_obter_param_padrao_funcao(11, 1247))::numeric;

	select	nr_seq_segurado,
		dt_solicitacao,
		ie_tipo_guia
	into STRICT	nr_seq_segurado_w,
		dt_solicitacao_w,
		ie_tipo_guia_w
	from	pls_guia_plano
	where	nr_sequencia	= nr_seq_guia_p;

	SELECT * FROM pls_gerar_validade_senha(nr_seq_guia_p, nr_seq_segurado_w, qt_dias_validade_w, dt_solicitacao_w, ie_tipo_guia_w, nm_usuario_p, dt_validade_senha_w, cd_senha_w) INTO STRICT dt_validade_senha_w, cd_senha_w;
	dt_validade_senha_ww	:= trunc(to_date(dt_validade_senha_w));
end if;

update	pls_guia_plano
set	ie_status		= ie_status_w,
	ie_estagio		= ie_estagio_w,
	nm_usuario		= nm_usuario_p,
	dt_atualizacao		= clock_timestamp(),
	dt_autorizacao		= clock_timestamp(),
	cd_senha		= cd_senha_w,
	dt_validade_senha	= dt_validade_senha_ww
where	nr_sequencia		= nr_seq_guia_p;

ds_parecer_w := 'O estipulante '||nm_estipulante_p||' finalizou a an√°lise na guia '||to_char(nr_seq_guia_p)||'. '||substr(ds_parecer_p,1,3500);
insert into pls_guia_plano_historico(nr_sequencia, nr_seq_guia, dt_historico,
	    dt_atualizacao, nm_usuario, ds_observacao,
	    ie_origem_historico, ie_tipo_historico)
     values (nextval('pls_guia_plano_historico_seq'), nr_seq_guia_p, clock_timestamp(),
	    clock_timestamp(), nm_usuario_p, ds_parecer_w,
	    'M', 'M');
commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_autorizar_guia_web (nr_seq_guia_p bigint, ds_parecer_p text, nm_usuario_p text, nm_estipulante_p text, ie_param_guia_parcial_p text) FROM PUBLIC;

