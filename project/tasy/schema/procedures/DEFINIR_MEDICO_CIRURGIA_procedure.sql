-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE definir_medico_cirurgia ( nr_atendimento_p bigint, nr_cirurgia_p bigint, nm_usuario_p text, cd_medico_atual_p text, ie_cirurgiao_anest_p text, cd_estabelecimento_p bigint) AS $body$
DECLARE

 
cd_medico_cirurgiao_w		varchar(10);
cd_medico_anestesista_w		varchar(10);
cd_medico_anterior_w		varchar(10);
cd_setor_atendimento_w		integer;
ie_tipo_atendimento_w		smallint;
ie_atualizar_medico_cirurgia_w	varchar(1);
nr_sequencia_w			bigint;


BEGIN 
 
if (coalesce(nr_atendimento_p,0) = 0) then 
	CALL wheb_mensagem_pck.Exibir_Mensagem_Abort(107311);
end if;	
 
ie_atualizar_medico_cirurgia_w := Obter_Param_Usuario(872, 172, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_atualizar_medico_cirurgia_w);
 
select	max(ie_tipo_atendimento) 
into STRICT	ie_tipo_atendimento_w 
from	atendimento_paciente 
where	nr_atendimento	= nr_atendimento_p;
 
select	max(obter_setor_atendimento(nr_atendimento_p)) 
into STRICT	cd_setor_atendimento_w
;
 
select	coalesce(max(nr_sequencia),0) 
into STRICT	nr_sequencia_w	 
from	atendimento_troca_medico 
where	nr_cirurgia 	= nr_cirurgia_p 
and	ie_funcao 	= ie_cirurgiao_anest_p;
 
if (nr_sequencia_w = 0) then 
	begin 
	select	cd_medico_cirurgiao, 
		cd_medico_anestesista 
	into STRICT	cd_medico_cirurgiao_w, 
		cd_medico_anestesista_w 
	from	cirurgia 
	where	nr_cirurgia		=	nr_cirurgia_p;	
 
	if (ie_cirurgiao_anest_p 	= 'A') 	then 
		cd_medico_anterior_w := cd_medico_anestesista_w;
	else 
		cd_medico_anterior_w := cd_medico_cirurgiao_w;
	end if;	
 
	end;
else 
	begin 
	select	cd_medico_atual 
	into STRICT	cd_medico_anterior_w 
	from	atendimento_troca_medico 
	where	nr_sequencia = nr_sequencia_w;
	end;
end if;	
 
insert into atendimento_troca_medico( 
	nr_sequencia, 
	nr_atendimento, 
	dt_atualizacao, 
	nm_usuario, 
	dt_troca, 
	cd_medico_anterior, 
	cd_medico_atual, 
	ie_forma_aviso, 
	dt_ciente, 
	nm_usuario_ciente, 
	dt_atualizacao_nrec, 
	nm_usuario_nrec, 
	nr_cirurgia, 
	cd_setor_atendimento, 
	ie_tipo_atendimento, 
	ie_funcao) 
values ( 
	nextval('atendimento_troca_medico_seq'), 
	nr_atendimento_p, 
	clock_timestamp(), 
	nm_usuario_p, 
	clock_timestamp(), 
	coalesce(cd_medico_anterior_w,cd_medico_atual_p), 
	cd_medico_atual_p, 
	'M', 
	clock_timestamp(), 
	nm_usuario_p, 
	clock_timestamp(), 
	nm_usuario_p, 
	nr_cirurgia_p, 
	cd_setor_atendimento_w, 
	ie_tipo_atendimento_w, 
	ie_cirurgiao_anest_p);
commit;
 
if (ie_atualizar_medico_cirurgia_w = 'S') then 
	begin 
	if (ie_cirurgiao_anest_p = 'C') then 
		update	cirurgia 
		set 	cd_medico_cirurgiao	= cd_medico_atual_p 
		where	nr_cirurgia 		= nr_cirurgia_p;
	elsif (ie_cirurgiao_anest_p = 'A') then 
		update	cirurgia 
		set		cd_medico_anestesista	= cd_medico_atual_p 
		where	nr_cirurgia		= nr_cirurgia_p;
	end if;
	end;
end if;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE definir_medico_cirurgia ( nr_atendimento_p bigint, nr_cirurgia_p bigint, nm_usuario_p text, cd_medico_atual_p text, ie_cirurgiao_anest_p text, cd_estabelecimento_p bigint) FROM PUBLIC;

