-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_obter_icms_mat_a900 ( nr_seq_material_p pls_material.nr_sequencia%type, vl_perc_icms_p pls_mat_unimed_trib.vl_perc_icms%type, dt_vigencia_p timestamp, ie_alc_p pls_mat_unimed_trib.id_alc%type, vl_material_p INOUT pls_mat_unimed_trib.vl_pmc%type) AS $body$
DECLARE


vl_pmc_w		pls_mat_unimed_trib.vl_pmc%type		:= null;
nr_seq_mat_unimed_w	pls_material_unimed.nr_sequencia%type	:= null;
dt_vig_ini_w		timestamp;
dt_vig_fim_w		timestamp;
ie_priorizar_cnv_mat_w	pls_parametros.ie_priorizar_conv_mat%type;

c01 CURSOR(	nr_seq_mat_unimed_w	pls_material_unimed.nr_sequencia%type,
		vl_perc_icms_w		pls_mat_unimed_trib.vl_perc_icms%type,
		ie_alc_pc		pls_mat_unimed_trib.id_alc%type) FOR
SELECT	c.vl_pmc vl_pmc
from	pls_mat_unimed_trib	c
where	c.nr_seq_mat_unimed	= nr_seq_mat_unimed_w
and	c.vl_perc_icms		= vl_perc_icms_w
and	((coalesce(c.dt_inicio_vigencia::text, '') = '') or (dt_vigencia_p > c.dt_inicio_vigencia))
and	c.id_alc		= ie_alc_pc
order 	by coalesce(c.dt_inicio_vigencia,to_date('01/01/1900')),
	   c.dt_atualizacao_nrec;

BEGIN

dt_vig_ini_w := fim_dia(dt_vigencia_p);
dt_vig_fim_w := fim_dia(dt_vigencia_p - 1);

select	coalesce(max(ie_priorizar_conv_mat),'N')
into STRICT	ie_priorizar_cnv_mat_w
from	pls_parametros
where	cd_estabelecimento = wheb_usuario_pck.get_cd_estabelecimento;

--Se estiver parametrizado para nao priorizar conversao a900, entao busca diretamente do material primeiramente e so se nao achar, busca 

--via conversao
if ( ie_priorizar_cnv_mat_w = 'N') then
	select	max(nr_seq_material_unimed)
	into STRICT	nr_seq_mat_unimed_w
	from	pls_material
	where	nr_sequencia	= nr_seq_material_p;
end if;

if (coalesce(nr_seq_mat_unimed_w::text, '') = '') then
	select max(nr_sequencia)
	into STRICT	nr_seq_mat_unimed_w
	from 	(
		SELECT	b.nr_sequencia
		from	pls_material_a900	a,
			pls_material_unimed	b
		where	a.nr_seq_material	= nr_seq_material_p
		and	b.cd_material		= a.cd_material_a900
		and 	coalesce(a.dt_fim_vigencia::text, '') = ''
		and	a.dt_inicio_vigencia < dt_vig_ini_w
		and	exists	(SELECT	1
				from	pls_mat_unimed_trib	c
				where	c.nr_seq_mat_unimed	= b.nr_sequencia
				and	((coalesce(c.dt_inicio_vigencia::text, '') = '') or (dt_vigencia_p > c.dt_inicio_vigencia))
				and	c.id_alc = ie_alc_p)
		
union all

		select	b.nr_sequencia
		from	pls_material_a900	a,
			pls_material_unimed	b
		where	a.nr_seq_material	= nr_seq_material_p
		and	b.cd_material		= a.cd_material_a900
		and 	a.dt_fim_vigencia > dt_vig_fim_w
		and 	a.dt_inicio_vigencia < dt_vig_ini_w
		and	exists	(select	1
				from	pls_mat_unimed_trib	c
				where	c.nr_seq_mat_unimed	= b.nr_sequencia
				and	((coalesce(c.dt_inicio_vigencia::text, '') = '') or (dt_vigencia_p > c.dt_inicio_vigencia))
				and	c.id_alc = ie_alc_p)) alias14;
end if;

--Se prioriza pela conversao, porem nao achou nenhuma valida, entao ainda tneta obter diretamente do material
if ( ie_priorizar_cnv_mat_w = 'S' and coalesce(nr_seq_mat_unimed_w::text, '') = '') then
	select	max(nr_seq_material_unimed)
	into STRICT	nr_seq_mat_unimed_w
	from	pls_material
	where	nr_sequencia	= nr_seq_material_p;
end if;


for r_c01_w in c01(nr_seq_mat_unimed_w, vl_perc_icms_p, ie_alc_p) loop
	vl_pmc_w := r_c01_w.vl_pmc;
end loop;

vl_material_p		:= coalesce(vl_pmc_w,0);

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_obter_icms_mat_a900 ( nr_seq_material_p pls_material.nr_sequencia%type, vl_perc_icms_p pls_mat_unimed_trib.vl_perc_icms%type, dt_vigencia_p timestamp, ie_alc_p pls_mat_unimed_trib.id_alc%type, vl_material_p INOUT pls_mat_unimed_trib.vl_pmc%type) FROM PUBLIC;

