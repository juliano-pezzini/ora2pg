-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE atualizar_obs_cheque_cr ( nr_seq_movto_trans_financ_p bigint) AS $body$
DECLARE


ds_obs_saldo_w	varchar(255);
ds_observacao_w	varchar(4000);
ie_acao_w	smallint;
nr_seq_cheque_w	bigint;
vl_saldo_w	double precision;


BEGIN

select	max(b.ie_acao)
into STRICT	ie_acao_w
from	movto_trans_financ a,
	transacao_financeira b
where	a.nr_sequencia	= nr_seq_movto_trans_financ_p
and	b.nr_sequencia	= a.nr_seq_trans_financ;

select	max(nr_seq_cheque)
into STRICT	nr_seq_cheque_w
from	movto_trans_financ
where	nr_sequencia	= nr_seq_movto_trans_financ_p;

if (ie_acao_w		= 30) and (nr_seq_cheque_w IS NOT NULL AND nr_seq_cheque_w::text <> '') then

	select	max(vl_saldo_negociado),
		max(ds_observacao)
	into STRICT	vl_saldo_w,
		ds_observacao_w
	from	cheque_cr
	where	nr_seq_cheque	= nr_seq_cheque_w;

	if (coalesce(vl_saldo_w,0)	= 0) then
		ds_obs_saldo_w		:= substr(wheb_mensagem_pck.get_texto(304505),1,255);
	elsif (vl_saldo_w		> 0) then
		ds_obs_saldo_w		:= substr(wheb_mensagem_pck.get_texto(304506),1,255);
	end if;

	if (length(ds_observacao_w) > 0) and
		((length(ds_observacao_w) + length(ds_obs_saldo_w)) <= 4000) then
		ds_observacao_w	:= ds_observacao_w || ' - ' || ds_obs_saldo_w;
	else
		ds_observacao_w	:= ds_obs_saldo_w;
	end if;

	update	cheque_cr
	set	ds_observacao	= ds_observacao_w
	where	nr_seq_cheque	= nr_seq_cheque_w;

	commit;

end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE atualizar_obs_cheque_cr ( nr_seq_movto_trans_financ_p bigint) FROM PUBLIC;

