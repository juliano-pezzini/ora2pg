-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_atualiza_conta_resumo_item ( nr_seq_item_p bigint, ie_tipo_item_p text, nm_usuario_p usuario.nm_usuario%type, ie_conta_inteira_p text) AS $body$
DECLARE


nr_seq_conta_w		pls_conta.nr_sequencia%type;
vl_liberado_w		pls_conta_proc.vl_liberado%type;
vl_lib_resumo_w		pls_conta_medica_resumo.vl_liberado%type;
ie_status_w		pls_conta_proc.ie_status%type;
ie_tipo_conta_w		pls_conta.ie_tipo_conta%type;
vl_apresentado_w	pls_conta_proc.vl_procedimento_imp%type;
tot_registros_w		integer;
vl_apresentado_dif_w	pls_conta_medica_resumo.vl_apresentado%type;
vl_apresentado_resum_w	pls_conta_medica_resumo.vl_apresentado%type;


BEGIN

--Verificar se é para um procedimento ou material
-- Procedimento
if (ie_tipo_item_p	= 'P') then

	-- Obter dados do procedimento
	select	nr_seq_conta,
		vl_liberado,
		ie_status,
		ie_tipo_conta,
		vl_procedimento_imp
	into STRICT	nr_seq_conta_w,
		vl_liberado_w,
		ie_status_w,
		ie_tipo_conta_w,
		vl_apresentado_w
	from	pls_conta_proc_v
	where	nr_sequencia	= nr_seq_item_p;

	-- Verificar se o procedimento tem valores liberados.
	CALL pls_atualizar_item_resumo(nr_seq_item_p, 'P', nm_usuario_p,ie_conta_inteira_p);

	--  Verificar se há divergência entre o valor do resumo e o valor do item.
	select	coalesce(sum(vl_lib_original),0)
	into STRICT	vl_lib_resumo_w
	from	pls_conta_medica_resumo
	where	nr_seq_conta_proc	= nr_seq_item_p
	and	nr_seq_conta		= nr_seq_conta_w
	and	ie_tipo_item		!= 'I'
	and	ie_situacao		= 'A';

	-- Se o valor que foi gravado no resumo for diferente do valor liberado para o item então exibe uma mensagem de erro para que o usuário esteja ciente.
	if (vl_lib_resumo_w 	!= vl_liberado_w) and (ie_status_w		in ('S','L')) and (ie_tipo_conta_w	!= 'I') then

		CALL wheb_mensagem_pck.exibir_mensagem_abort(271055, 'CONTA=' || nr_seq_conta_w || ';PROC=' || nr_seq_item_p ||
								';MAT= ;VL_LIBERADO=' || vl_liberado_w || ';VL_RESUMO=' || vl_lib_resumo_w);
	end if;

-- Material.
elsif (ie_tipo_item_p	= 'M') then

	-- Obter dados do procedimento
	select	nr_seq_conta,
		vl_liberado,
		ie_status,
		ie_tipo_conta
	into STRICT	nr_seq_conta_w,
		vl_liberado_w,
		ie_status_w,
		ie_tipo_conta_w
	from	pls_conta_mat_v
	where	nr_sequencia	= nr_seq_item_p;

	CALL pls_atualizar_item_resumo(nr_seq_item_p, 'M', nm_usuario_p,ie_conta_inteira_p);

	-- Verificar se há divergência entre o valor do resumo e o valor do item.
	select	coalesce(sum(vl_lib_original),0)
	into STRICT	vl_lib_resumo_w
	from	pls_conta_medica_resumo
	where	nr_seq_conta_mat	= nr_seq_item_p
	and	nr_seq_conta		= nr_seq_conta_w
	and	ie_tipo_item		!= 'I'
	and	ie_situacao		= 'A';

	-- Se o valor que foi gravado no resumo for diferente do valor liberado para o item então exibe uma mensagem de erro para que o usuário esteja ciente.
	if (vl_lib_resumo_w	!= vl_liberado_w)  and (ie_status_w		in ('S','L')) and (ie_tipo_conta_w	!= 'I')then

		CALL wheb_mensagem_pck.exibir_mensagem_abort(271055, 'CONTA=' || nr_seq_conta_w || ';PROC= ;MAT= ' || nr_seq_item_p ||
								';VL_LIBERADO=' || vl_liberado_w || ';VL_RESUMO=' || vl_lib_resumo_w);
	end if;

end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_atualiza_conta_resumo_item ( nr_seq_item_p bigint, ie_tipo_item_p text, nm_usuario_p usuario.nm_usuario%type, ie_conta_inteira_p text) FROM PUBLIC;

