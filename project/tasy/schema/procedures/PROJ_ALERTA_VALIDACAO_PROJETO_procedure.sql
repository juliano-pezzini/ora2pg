-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE proj_alerta_validacao_projeto ( nm_usuario_p text ) AS $body$
DECLARE

 
cd_gerente_w			varchar(10);
ds_email_destino_w		varchar(255);
ds_estagio_w			varchar(255);

c_oss_validacao_paradas CURSOR FOR 
SELECT	a.nr_sequencia nr_seq_proj, 
	a.ds_titulo ds_projeto, 
	a.cd_coordenador cd_analista, 
	b.nr_sequencia nr_seq_ordem_serv, 
	(trunc(clock_timestamp()) - trunc(c.dt_atualizacao)) qt_dias 
from	proj_projeto a, 
	man_ordem_servico b, 
	man_ordem_serv_estagio c 
where	a.nr_seq_ordem_serv = b.nr_sequencia 
and	b.nr_sequencia = c.nr_seq_ordem 
and	a.ie_origem = 'D' 
and	a.nr_seq_estagio not in (16, 21) 
and	b.ie_status_ordem != 3 
and	b.nr_seq_estagio = 2 
and	c.nr_sequencia = (	SELECT	max(nr_sequencia) 
				from	man_ordem_serv_estagio 
				where	nr_seq_ordem = b.nr_sequencia 
				and	nr_seq_estagio = 2 
			) 
and	trunc(clock_timestamp()) - trunc(c.dt_atualizacao) in (15,30,45,60,75,90);

BEGIN 
 
select	max(substr(obter_desc_expressao(cd_exp_estagio, ds_estagio), 1, 255)) 
into STRICT	ds_estagio_w 
from	man_estagio_processo 
where	nr_sequencia = 2;
 
for r_c_oss_validacao_paradas in c_oss_validacao_paradas loop 
 
	select	max(a.cd_responsavel) 
	into STRICT	cd_gerente_w 
	from	gerencia_wheb a, 
		gerencia_wheb_grupo b, 
		gerencia_wheb_grupo_usu c 
	where	a.nr_sequencia = b.nr_seq_gerencia 
	and	b.nr_sequencia = c.nr_seq_grupo 
	and	c.nm_usuario_grupo = obter_usuario_pessoa(r_c_oss_validacao_paradas.cd_analista);
 
	CALL gerar_comunic_padrao( 
		clock_timestamp(), 
		wheb_mensagem_pck.get_texto(380169, 	'NR_SEQ_ORDEM_SERV=' || r_c_oss_validacao_paradas.nr_seq_ordem_serv || ';' || 
							'NR_SEQ_PROJ=' || r_c_oss_validacao_paradas.nr_seq_proj || ';' || 
							'DS_PROJETO=' || r_c_oss_validacao_paradas.ds_projeto), 
		wheb_mensagem_pck.get_texto(380146, 	'NR_SEQ_ORDEM_SERV=' || r_c_oss_validacao_paradas.nr_seq_ordem_serv || ';' || 
							'NR_SEQ_PROJ=' || r_c_oss_validacao_paradas.nr_seq_proj || ';' || 
							'DS_PROJETO=' || r_c_oss_validacao_paradas.ds_projeto || ';' || 
							'DS_ESTAGIO=' || ds_estagio_w || ';' || 
							'QT_DIAS=' || r_c_oss_validacao_paradas.qt_dias), 
		nm_usuario_p, 
		'N', 
		substr(obter_usuario_pessoa(r_c_oss_validacao_paradas.cd_analista), 1, 15) || 
			', ' || substr(obter_usuario_pessoa(cd_gerente_w), 1, 15) || 
			', ' || 'fvschen', 
		'N', 
		null, 
		null, 
		null, 
		null, 
		clock_timestamp(), 
		null, 
		null);
 
	begin 
		if (r_c_oss_validacao_paradas.cd_analista != cd_gerente_w) then 
			select (obter_dados_usuario_opcao(obter_usuario_pf(r_c_oss_validacao_paradas.cd_analista), 'E') || ';' || 
				obter_dados_usuario_opcao(obter_usuario_pf(cd_gerente_w), 'E') || ';') 
			into STRICT	ds_email_destino_w 
			;
		else 
			select (obter_dados_usuario_opcao(obter_usuario_pf(r_c_oss_validacao_paradas.cd_analista), 'E') || ';') 
			into STRICT	ds_email_destino_w 
			;
		end if;
 
		CALL enviar_email( 
			wheb_mensagem_pck.get_texto(380169, 	'NR_SEQ_ORDEM_SERV=' || r_c_oss_validacao_paradas.nr_seq_ordem_serv || ';' || 
								'NR_SEQ_PROJ=' || r_c_oss_validacao_paradas.nr_seq_proj || ';' || 
								'DS_PROJETO=' || r_c_oss_validacao_paradas.ds_projeto),	--DS_ASSUNTO_P 
			wheb_mensagem_pck.get_texto(380146, 	'NR_SEQ_ORDEM_SERV=' || r_c_oss_validacao_paradas.nr_seq_ordem_serv || ';' || 
								'NR_SEQ_PROJ=' || r_c_oss_validacao_paradas.nr_seq_proj || ';' || 
								'DS_PROJETO=' || r_c_oss_validacao_paradas.ds_projeto || ';' || 
								'DS_ESTAGIO=' || ds_estagio_w || ';' || 
								'QT_DIAS=' || r_c_oss_validacao_paradas.qt_dias), --DS_MENSAGEM_P 
			'support.informatics@philips.com', --DS_EMAIL_ORIGEM_P 
			ds_email_destino_w, --DS_EMAIL_DESTINO_P 
			nm_usuario_p, --NM_USUARIO_P 
			'M'); --IE_PRIORIDADE_P 
	exception when others then
		null;
	end;
end loop;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE proj_alerta_validacao_projeto ( nm_usuario_p text ) FROM PUBLIC;

