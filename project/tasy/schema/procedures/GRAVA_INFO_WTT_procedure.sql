-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE grava_info_wtt (accnum_p text, paperprint_p bigint, filmprint_p bigint, opticmedia_p bigint, nm_usuario_p text, reportprint_p bigint default null) AS $body$
DECLARE



nr_prescricao_w		bigint;
nr_seq_prescr_w		bigint;
accnum_w		varchar(15);
qt_registro_wtt		bigint;
max_registro_wtt	bigint;


BEGIN


if (accnum_p IS NOT NULL AND accnum_p::text <> '') then

	accnum_w := lpad(accnum_p,8,'0');

	select	max(nr_prescricao),
		max(nr_sequencia)
	into STRICT	nr_prescricao_w,
		nr_seq_prescr_w
	from	prescr_procedimento
	where	nr_acesso_dicom = accnum_w;

	if (nr_prescricao_w IS NOT NULL AND nr_prescricao_w::text <> '') and (nr_seq_prescr_w IS NOT NULL AND nr_seq_prescr_w::text <> '') then

		select 	count(nr_sequencia), coalesce(max(nr_sequencia),0)
		into STRICT	qt_registro_wtt,
			max_registro_wtt
		from	prescr_proc_info_laudo
		where	nr_prescricao = nr_prescricao_w
		and	nr_seq_prescr = nr_seq_prescr_w;

		if (qt_registro_wtt = 0) then

			insert into prescr_proc_info_laudo(
			nr_sequencia,
			dt_atualizacao,
			nm_usuario,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			nr_prescricao,
			nr_seq_prescr,
			nr_paperprint,
			nr_filmprint,
			nr_opticmedia,
			nr_reportprint
			)
			values (
			nextval('prescr_proc_info_laudo_seq'),
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			nr_prescricao_w,
			nr_seq_prescr_w,
			paperprint_p,
			filmprint_p,
			opticmedia_p,
			reportprint_p
			);
		else
			update	prescr_proc_info_laudo
			set	dt_atualizacao = clock_timestamp(),
				nm_usuario = nm_usuario_p,
				nr_paperprint = paperprint_p,
				nr_filmprint = filmprint_p,
				nr_opticmedia = opticmedia_p,
				nr_reportprint = reportprint_p
			where	nr_sequencia = max_registro_wtt;
		end if;

		commit;

	end if;

end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE grava_info_wtt (accnum_p text, paperprint_p bigint, filmprint_p bigint, opticmedia_p bigint, nm_usuario_p text, reportprint_p bigint default null) FROM PUBLIC;

