-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';



CREATE TYPE cpoe_comp_solucao AS (	nr_seq_material_w		prescr_material.nr_sequencia%type,
									cd_material_w			prescr_material.cd_material%type,	
									qt_dose_w				prescr_material.qt_dose%type,
									cd_unidade_medida_w		prescr_material.cd_unidade_medida%type,
									ds_dose_diferenciada_w	prescr_material.ds_dose_diferenciada%type,
									qt_volume_corrigido_w	prescr_material.qt_volume_corrigido%type);


CREATE OR REPLACE PROCEDURE cpoe_rep_gerar_solucao ( nr_prescricao_p prescr_medica.nr_prescricao%type, nr_atendimento_p atendimento_paciente.nr_atendimento%type, dt_inicio_prescr_p timestamp, dt_validade_prescr_p timestamp, dt_liberacao_p timestamp, nm_usuario_p usuario.nm_usuario%type, cd_pessoa_fisica_p cpoe_material.cd_pessoa_fisica%type, cd_funcao_origem_p funcao.cd_funcao%type , ie_tipo_pessoa_p text default 'N', cd_setor_atendimento_p prescr_medica.cd_setor_atendimento%type default null, nr_seq_agenda_p prescr_medica.nr_seq_agenda%type default null) AS $body$
DECLARE

									
type vetor is table of cpoe_comp_solucao index by integer;

cpoe_componente_sol_w		vetor;

cd_intervalo_w				prescr_solucao.cd_intervalo%type;
ds_horarios_w				prescr_solucao.ds_horarios%type;
ds_orientacao_w				prescr_solucao.ds_orientacao%type;
ds_solucao_w				prescr_solucao.ds_solucao%type;
hr_prim_horario_w			prescr_solucao.hr_prim_horario%type;
ie_acm_w					prescr_solucao.ie_acm%type;
ie_bomba_infusao_w			prescr_solucao.ie_bomba_infusao%type;
ie_fator_correcao_w			prescr_solucao.ie_fator_correcao%type;
ie_pca_modo_prog_w			prescr_solucao.ie_pca_modo_prog%type;
ie_se_necessario_w			prescr_solucao.ie_se_necessario%type;
ie_solucao_especial_w		prescr_solucao.ie_solucao_especial%type;
ie_solucao_pca_w			prescr_solucao.ie_solucao_pca%type;
ie_tipo_analgesia_w			prescr_solucao.ie_tipo_analgesia%type;
ie_tipo_dosagem_w			prescr_solucao.ie_tipo_dosagem%type;
ie_tipo_solucao_w			prescr_solucao.ie_tipo_solucao%type;
ie_um_bolus_pca_w			prescr_solucao.ie_um_bolus_pca%type;
ie_um_dose_inicio_pca_w		prescr_solucao.ie_um_dose_inicio_pca%type;
ie_um_fluxo_pca_w			prescr_solucao.ie_um_fluxo_pca%type;
ie_um_limite_hora_pca_w		prescr_solucao.ie_um_limite_hora_pca%type;
ie_um_limite_pca_w			prescr_solucao.ie_um_limite_pca%type;
ie_urgencia_w				prescr_solucao.ie_urgencia%type;
ie_via_aplicacao_w			prescr_solucao.ie_via_aplicacao%type;
nr_etapas_w					prescr_solucao.nr_etapas%type;
nr_seq_solucao_w			prescr_solucao.nr_seq_solucao%type;
qt_bolus_pca_w				prescr_solucao.qt_bolus_pca%type;
qt_dosagem_w				prescr_solucao.qt_dosagem%type;
qt_dose_ataque_w			prescr_solucao.qt_dose_ataque%type;
qt_dose_inicial_pca_w		prescr_solucao.qt_dose_inicial_pca%type;
qt_hora_fase_w				prescr_solucao.qt_hora_fase%type;
qt_intervalo_bloqueio_w		prescr_solucao.qt_intervalo_bloqueio%type;
qt_limite_quatro_hora_w		prescr_solucao.qt_limite_quatro_hora%type;
qt_limite_uma_hora_w		prescr_solucao.qt_limite_uma_hora%type;
qt_solucao_total_w			prescr_solucao.qt_solucao_total%type;
qt_tempo_aplicacao_w		prescr_solucao.qt_tempo_aplicacao%type;
qt_vol_infusao_pca_w		prescr_solucao.qt_vol_infusao_pca%type;
qt_volume_w					prescr_solucao.qt_volume%type;
cd_perfil_ativo_w			prescr_solucao.cd_perfil_ativo%type;
ie_esquema_alternado_w		prescr_solucao.ie_esquema_alternado%type;

nr_sequencia_w				cpoe_material.nr_sequencia%type;
ie_administracao_w			cpoe_material.ie_administracao%type;
ie_ref_calculo_w			cpoe_material.ie_ref_calculo%type;
dt_prim_horario_w			cpoe_material.dt_inicio%type;
qt_hora_fase_cpoe_w			cpoe_material.qt_hora_fase%type;
qt_dosagem_diferenciada_w	cpoe_material.qt_dosagem_diferenciada%type;

cd_funcao_origem_w			prescr_medica.cd_funcao_origem%type;
nr_seq_atend_w			prescr_medica.nr_seq_atend%type;
ds_horario_esquema_w		prescr_solucao_esquema.ds_horario%type;
qt_dosagem_esquema_w		prescr_solucao_esquema.qt_dosagem%type;
qt_hora_fase_esquema_w		prescr_solucao_esquema.qt_hora_fase%type;

ie_retrogrado_w				prescr_medica.ie_prescr_emergencia%type;

i							bigint;
x							bigint;
ie_sol_continua_w			char(1);
qt_hora_fase_total_w		varchar(200);
ie_libera_cpoe_w			varchar(1);
dt_liberacao_enf_w			timestamp;
nm_usuario_lib_enf_w		prescr_medica.nm_usuario_lib_enf%type;
nr_seq_ordem_adep_w		prescr_solucao.nr_seq_ordem_adep%type;
nr_agrupamento_w			prescr_solucao.nr_agrupamento%type;
ie_param1562_cpoe_w			varchar(1);
dt_fim_w					cpoe_material.dt_fim%type;
ds_volume_diferenciado_w 	cpoe_material.ds_volume_diferenciado%type;
cd_medico_w					prescr_medica.cd_medico%type;
qt_volume_esquema_w			prescr_solucao_esquema.qt_volume%type;
								
c01 CURSOR FOR
SELECT	cd_intervalo,
		ds_horarios,
		ds_orientacao,
		ds_solucao,
		hr_prim_horario,
		coalesce(ie_acm,'N'),
		ie_bomba_infusao,
		ie_fator_correcao,
		ie_pca_modo_prog,
		coalesce(ie_se_necessario,'N'),
		coalesce(ie_solucao_especial,'N'),
		coalesce(ie_solucao_pca,'N'),
		ie_tipo_analgesia,
		ie_tipo_dosagem,
		ie_tipo_solucao,
		ie_um_bolus_pca,
		ie_um_dose_inicio_pca,
		ie_um_fluxo_pca,
		ie_um_limite_hora_pca,
		ie_um_limite_pca,
		coalesce(ie_urgencia,'N'),
		ie_via_aplicacao,
		nr_etapas,
		nr_seq_solucao,
		qt_bolus_pca,
		qt_dosagem,
		qt_dose_ataque,
		qt_dose_inicial_pca,
		qt_hora_fase,
		qt_intervalo_bloqueio,
		qt_limite_quatro_hora,
		qt_limite_uma_hora,
		qt_solucao_total,
		qt_tempo_aplicacao,
		qt_vol_infusao_pca,
		qt_volume,
		cd_perfil_ativo,
		ie_esquema_alternado,
        nr_agrupamento,
        nr_seq_ordem_adep
from	prescr_solucao
where	nr_prescricao = nr_prescricao_p
and 	coalesce(ie_hemodialise,'N') = 'N'
order by
		nr_seq_solucao;

c02 CURSOR FOR
SELECT	nr_sequencia,
		cd_material,
		qt_dose,
		cd_unidade_medida_dose,
		ds_dose_diferenciada,
		qt_volume_corrigido
from	prescr_material
where	nr_prescricao = nr_prescricao_p
and		nr_sequencia_solucao = nr_seq_solucao_w
order by
		coalesce(nr_agrupamento,0),
		nr_sequencia,
		coalesce(nr_sequencia_diluicao,0);
		
		
c03 CURSOR FOR
SELECT	ds_horario,
		qt_dosagem,
		qt_hora_fase,
		qt_volume
from	prescr_solucao_esquema
where	nr_prescricao = nr_prescricao_p
and     nr_seq_solucao = nr_seq_solucao_w;


BEGIN

select	max(cd_funcao_origem),
		max(coalesce(ie_prescr_emergencia,'N')),
		max(nr_seq_atend),
		max(dt_liberacao),
		max(nm_usuario_lib_enf),
		max(cd_medico)
into STRICT	cd_funcao_origem_w,
		ie_retrogrado_w,
		nr_seq_atend_w,
		dt_liberacao_enf_w,
		nm_usuario_lib_enf_w,
		cd_medico_w
from	prescr_medica
where	nr_prescricao = nr_prescricao_p;

ie_libera_cpoe_w := 'N';
if (cd_funcao_origem_w = 924) or (cd_funcao_origem_w = 950) or (cd_funcao_origem_w = 281) or (cd_funcao_origem_w = 900) or (cd_funcao_origem_w = 3130) or (cd_funcao_origem_w = -9) or (cd_funcao_origem_w = -2025) or (cd_funcao_origem_w = 99072) or (ie_tipo_pessoa_p = 'S') then
	ie_libera_cpoe_w := 'S';
end if;

open c01;
loop
fetch c01 into	cd_intervalo_w,
				ds_horarios_w,
				ds_orientacao_w,
				ds_solucao_w,
				hr_prim_horario_w,
				ie_acm_w,
				ie_bomba_infusao_w,
				ie_fator_correcao_w,
				ie_pca_modo_prog_w,
				ie_se_necessario_w,
				ie_solucao_especial_w,
				ie_solucao_pca_w,
				ie_tipo_analgesia_w,
				ie_tipo_dosagem_w,
				ie_tipo_solucao_w,
				ie_um_bolus_pca_w,
				ie_um_dose_inicio_pca_w,
				ie_um_fluxo_pca_w,
				ie_um_limite_hora_pca_w,
				ie_um_limite_pca_w,
				ie_urgencia_w,
				ie_via_aplicacao_w,
				nr_etapas_w,
				nr_seq_solucao_w,
				qt_bolus_pca_w,
				qt_dosagem_w,
				qt_dose_ataque_w,
				qt_dose_inicial_pca_w,
				qt_hora_fase_w,
				qt_intervalo_bloqueio_w,
				qt_limite_quatro_hora_w,
				qt_limite_uma_hora_w,
				qt_solucao_total_w,
				qt_tempo_aplicacao_w,
				qt_vol_infusao_pca_w,
				qt_volume_w,
				cd_perfil_ativo_w,
				ie_esquema_alternado_w,
				nr_agrupamento_w,
				nr_seq_ordem_adep_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	begin
	ie_sol_continua_w	:= 'N';
	dt_fim_w	:= null;
	if (ie_solucao_pca_w = 'S') then
		ie_tipo_solucao_w := 'P';
	elsif (ie_solucao_especial_w = 'S') then
		ie_tipo_solucao_w := 'V';
	elsif (coalesce(ie_tipo_solucao_w::text, '') = '') then
		ie_tipo_solucao_w := 'C';
		ie_sol_continua_w	:= 'S';
	end if;
	
	qt_hora_fase_cpoe_w	:= obter_horas_minutos(qt_hora_fase_w*60);

	dt_prim_horario_w := dt_inicio_prescr_p;
	if (hr_prim_horario_w IS NOT NULL AND hr_prim_horario_w::text <> '') then
		dt_prim_horario_w := ESTABLISHMENT_TIMEZONE_UTILS.dateAtTime(dt_inicio_prescr_p, coalesce(hr_prim_horario_w, '00:00'));
		if (dt_prim_horario_w < dt_inicio_prescr_p) and (ie_urgencia_w = 'N') then
			dt_prim_horario_w := dt_prim_horario_w + 1;
		end if;
	end if;	
	
	SELECT * FROM CPOE_Calcula_horarios_etapas(	nm_usuario_p, dt_prim_horario_w, ie_sol_continua_w, nr_etapas_w, cd_intervalo_w, qt_tempo_aplicacao_w, qt_hora_fase_w, 0, 'N') INTO STRICT nr_etapas_w, ds_horarios_w;
	
	ie_administracao_w	:= 'P';
	if (ie_acm_w = 'S') then
		ie_administracao_w := 'C';
		ds_horarios_w := '';
		hr_prim_horario_w := '';
	elsif (ie_se_necessario_w = 'S') then
		ie_administracao_w := 'N';
		ds_horarios_w := '';
		hr_prim_horario_w := '';
	end if;
	
	ie_ref_calculo_w := 'NE';
	if (cd_intervalo_w IS NOT NULL AND cd_intervalo_w::text <> '') then
		ie_ref_calculo_w := 'I';
	end if;
	
	i := 0;
	For i in 0.. 10 LOOP
		begin
		cpoe_componente_sol_w[i].nr_seq_material_w := null;
		cpoe_componente_sol_w[i].cd_material_w := null;
		cpoe_componente_sol_w[i].qt_dose_w := null;
		cpoe_componente_sol_w[i].cd_unidade_medida_w := null;
		cpoe_componente_sol_w[i].ds_dose_diferenciada_w := null;
		cpoe_componente_sol_w[i].qt_volume_corrigido_w := null;
		end;
	end loop;	
	
	i := 0;
	open c02;
	loop
	fetch c02 into	cpoe_componente_sol_w[i].nr_seq_material_w,
					cpoe_componente_sol_w[i].cd_material_w,
					cpoe_componente_sol_w[i].qt_dose_w,
					cpoe_componente_sol_w[i].cd_unidade_medida_w,
					cpoe_componente_sol_w[i].ds_dose_diferenciada_w,
					cpoe_componente_sol_w[i].qt_volume_corrigido_w;
	EXIT WHEN NOT FOUND; /* apply on c02 */
		begin
		i := i +1;
		end;
	end loop;
	close c02;
	
	if (ie_esquema_alternado_w = 'S') then
		ds_horarios_w := '';
		qt_dosagem_diferenciada_w := '';
		qt_hora_fase_esquema_w := '';
		qt_hora_fase_total_w := '';
		qt_dosagem_esquema_w := '';
						
		open c03;
		loop
		fetch c03 into 	ds_horario_esquema_w,
						qt_dosagem_esquema_w,
						qt_hora_fase_esquema_w,
						qt_volume_esquema_w;
		EXIT WHEN NOT FOUND; /* apply on c03 */
			begin
				ds_horarios_w := substr(ds_horarios_w || ds_horario_esquema_w || ';',1,2000);
				
				qt_dosagem_diferenciada_w := qt_dosagem_diferenciada_w || Campo_Mascara_virgula_rel(qt_dosagem_esquema_w) || '-';					
				ds_volume_diferenciado_w := ds_volume_diferenciado_w || Campo_Mascara_virgula_rel(qt_volume_esquema_w) || '-';
				
				if (qt_hora_fase_esquema_w IS NOT NULL AND qt_hora_fase_esquema_w::text <> '') then
					qt_hora_fase_total_w := qt_hora_fase_total_w || obter_horas_minutos(qt_hora_fase_esquema_w*60) || '-';
				else
					qt_hora_fase_total_w := qt_hora_fase_total_w || obter_horas_minutos(qt_hora_fase_w*60) || '-';
				end if;
			end;
		end loop;
		close c03;	
	end if;
	
	-- Clear out the text inside the line
	ds_horarios_w := REPLACE(padroniza_horario_prescr(ds_horarios_w,null),'A','');

	select	nextval('cpoe_material_seq')
	into STRICT	nr_sequencia_w
	;
	
	if (position('A' in CPOE_Padroniza_horario_prescr(ds_horarios_w, dt_prim_horario_w)) = 0 ) then
		ie_param1562_cpoe_w := obter_param_usuario(281, 1562, wheb_usuario_pck.get_cd_perfil, nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento, ie_param1562_cpoe_w);
		if (ie_param1562_cpoe_w = 'F') then
			dt_fim_w := fim_dia(dt_prim_horario_w);
		end if;
	end if;
	
	insert into cpoe_material(
				nr_sequencia,
				nr_atendimento,
				ie_administracao,
				ie_ref_calculo,
				ie_controle_tempo,
				ie_duracao,
				dt_inicio,
				dt_fim,
				dt_prox_geracao,
				dt_liberacao,
				cd_intervalo,
				ds_horarios,
				ds_orientacao_preparo,
				ds_solucao,
				hr_prim_horario,
				ie_acm,
				ie_bomba_infusao,
				ie_fator_correcao,
				ie_pca_modo_prog,
				ie_se_necessario,
				ie_tipo_analgesia,
				ie_tipo_dosagem,
				ie_tipo_solucao,
				ie_um_bolus_pca,
				ie_um_dose_inicio_pca,
				ie_um_fluxo_pca,
				ie_um_limite_hora_pca,
				ie_um_limite_pca,
				ie_urgencia,
				ie_via_aplicacao,
				ie_material,
				nr_etapas,
				qt_bolus_pca,
				qt_dosagem,
				qt_dose_ataque,
				qt_dose_inicial_pca,
				qt_hora_fase,
				qt_intervalo_bloqueio,
				qt_limite_quatro_hora,
				qt_limite_uma_hora,
				qt_solucao_total,
				qt_tempo_aplicacao,
				qt_vol_infusao_pca,
				qt_volume,
				cd_material,
				qt_dose,
				cd_unidade_medida,
				ds_dose_diferenciada,
				dt_atualizacao,
				dt_atualizacao_nrec,
				nm_usuario,
				nm_usuario_nrec,
				cd_perfil_ativo,
				qt_dosagem_diferenciada,
				qt_hora_fase_diferenciada,
				cd_pessoa_fisica,
				cd_funcao_origem,
				cd_setor_atendimento,
				ie_retrogrado,
				ie_oncologia,
				ds_ref_calculo,
				dt_liberacao_enf,
				nm_usuario_lib_enf,
				nr_seq_agenda,
				nr_agrupamento,
				ds_volume_diferenciado,
				cd_medico)
			values (
				nr_sequencia_w,
				nr_atendimento_p,
				ie_administracao_w,
				ie_ref_calculo_w,
				'S',
				'P',
				dt_prim_horario_w,
				coalesce(dt_fim_w, dt_validade_prescr_p),
				dt_prim_horario_w + 12/24,
				CASE WHEN ie_libera_cpoe_w='S' THEN  dt_liberacao_p  ELSE null END ,
				cd_intervalo_w,
				ds_horarios_w,
				get_dados_dil_cpoe_js(nr_prescricao_p, nr_seq_solucao_w),
				ds_solucao_w,
				hr_prim_horario_w,
				ie_acm_w,
				ie_bomba_infusao_w,
				ie_fator_correcao_w,
				ie_pca_modo_prog_w,
				ie_se_necessario_w,
				ie_tipo_analgesia_w,
				ie_tipo_dosagem_w,
				ie_tipo_solucao_w,
				ie_um_bolus_pca_w,
				ie_um_dose_inicio_pca_w,
				ie_um_fluxo_pca_w,
				ie_um_limite_hora_pca_w,
				ie_um_limite_pca_w,
				CASE WHEN ie_urgencia_w='S' THEN '0'  ELSE null END ,
				ie_via_aplicacao_w,
				'N',
				nr_etapas_w,
				qt_bolus_pca_w,
				qt_dosagem_w,
				qt_dose_ataque_w,
				qt_dose_inicial_pca_w,
				qt_hora_fase_cpoe_w,
				qt_intervalo_bloqueio_w,
				qt_limite_quatro_hora_w,
				qt_limite_uma_hora_w,
				qt_solucao_total_w,
				qt_tempo_aplicacao_w,
				qt_vol_infusao_pca_w,
				qt_volume_w,
				cpoe_componente_sol_w[0].cd_material_w,
				cpoe_componente_sol_w[0].qt_dose_w,
				cpoe_componente_sol_w[0].cd_unidade_medida_w,
				cpoe_componente_sol_w[0].ds_dose_diferenciada_w,
				clock_timestamp(),
				clock_timestamp(),
				nm_usuario_p,
				nm_usuario_p,
				cd_perfil_ativo_w,
				qt_dosagem_diferenciada_w,
				qt_hora_fase_total_w,
				cd_pessoa_fisica_p,
				cd_funcao_origem_p,
				cd_setor_atendimento_p,
				ie_retrogrado_w,
				CASE WHEN coalesce(nr_seq_atend_w::text, '') = '' THEN 'N'  ELSE 'S' END ,
				CPOE_obter_diluicao(ie_tipo_solucao_w, qt_volume_w, qt_tempo_aplicacao_w, cd_intervalo_w,
									nr_etapas_w, qt_dosagem_w, qt_solucao_total_w, null,
									qt_hora_fase_w, ie_tipo_dosagem_w, ie_ref_calculo_w ),
				dt_liberacao_enf_w,
				nm_usuario_lib_enf_w,
				nr_seq_agenda_p,
				coalesce(nr_seq_ordem_adep_w,nr_agrupamento_w),
				ds_volume_diferenciado_w,
				cd_medico_w);
	
	update	prescr_material
	set		nr_seq_mat_cpoe = nr_sequencia_w
	where	nr_sequencia 	= cpoe_componente_sol_w[0].nr_seq_material_w
	and		nr_prescricao 	= nr_prescricao_p;

	x := 0;
	while(x <= i) loop
		begin
		
		x := x + 1;
		if ( x <= 6) and (cpoe_componente_sol_w[x](.nr_seq_material_w IS NOT NULL AND .nr_seq_material_w::text <> '')) then
			CALL exec_sql_dinamico_bv(	'CPOE',
									' update	cpoe_material ' ||
									' set		cd_mat_comp'||x||' = :cd_material_w, ' ||
									' 			qt_dose_comp'||x||' = :qt_dose_w, ' ||
									' 			cd_unid_med_dose_comp'||x||' = :cd_unidade_medida_w, ' ||
									' 			qt_dose_correcao'||x||' = :qt_dose_correcao, ' ||
									'			ds_dose_diferenciada_comp'||x||' = :ds_dose_diferenciada_w ' ||
									' where		nr_sequencia = :nr_sequencia_w ',
									'cd_material_w='||cpoe_componente_sol_w[x].cd_material_w||
									'#@#@qt_dose_w='||cpoe_componente_sol_w[x].qt_dose_w||
									'#@#@cd_unidade_medida_w='||cpoe_componente_sol_w[x].cd_unidade_medida_w||
									'#@#@qt_dose_correcao='||cpoe_componente_sol_w[x].qt_volume_corrigido_w||
									'#@#@ds_dose_diferenciada_w='||cpoe_componente_sol_w[x].ds_dose_diferenciada_w||
									'#@#@nr_sequencia_w='||nr_sequencia_w||
									'#@#@');
																		
		end if;
		end;	
	end loop;
	
	if (coalesce(wheb_usuario_pck.get_ie_commit, 'S') = 'S') then commit; end if;
	
	end;
end loop;
close c01;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cpoe_rep_gerar_solucao ( nr_prescricao_p prescr_medica.nr_prescricao%type, nr_atendimento_p atendimento_paciente.nr_atendimento%type, dt_inicio_prescr_p timestamp, dt_validade_prescr_p timestamp, dt_liberacao_p timestamp, nm_usuario_p usuario.nm_usuario%type, cd_pessoa_fisica_p cpoe_material.cd_pessoa_fisica%type, cd_funcao_origem_p funcao.cd_funcao%type , ie_tipo_pessoa_p text default 'N', cd_setor_atendimento_p prescr_medica.cd_setor_atendimento%type default null, nr_seq_agenda_p prescr_medica.nr_seq_agenda%type default null) FROM PUBLIC;

