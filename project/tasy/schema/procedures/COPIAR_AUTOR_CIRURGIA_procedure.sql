-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE copiar_autor_cirurgia (nr_sequencia_p bigint, nr_seq_agenda_nova_p bigint, nm_usuario_p text) AS $body$
DECLARE


nr_sequencia_w		bigint;
nr_seq_mat_autor_w	bigint;
nr_seq_mat_novo_w	bigint;
ie_estagio_autor_transf_w 	varchar(2);

c01 CURSOR FOR
SELECT	nr_sequencia
from	material_autor_cirurgia
where	nr_seq_autorizacao	= nr_sequencia_p;


BEGIN

select	coalesce(max(ie_estagio_autor_transf),'1')
into STRICT	ie_estagio_autor_transf_w
from	parametro_faturamento
where	cd_estabelecimento	= wheb_usuario_pck.get_cd_estabelecimento;

select	nextval('autorizacao_cirurgia_seq')
into STRICT	nr_sequencia_w
;


insert	into	autorizacao_cirurgia(nr_sequencia,
	dt_atualizacao,
	nm_usuario,
	dt_pedido,
	nm_usuario_pedido,
	ds_justificativa,
	dt_autorizacao,
	nm_autorizante,
	nm_usuario_autorizacao,
	nr_seq_agenda,
	cd_requisitante,
	ds_observacao,
	nr_atendimento,
	cd_procedimento,
	ie_estagio_autor,
	ie_origem_proced,
	dt_previsao,
	ds_motivo_negativa,
	dt_liberacao,
	dt_fim_cotacao,
	nr_prescricao,
	nr_doc_convenio,
	cd_estabelecimento,
	cd_comprador,
	cd_senha,
	dt_liberacao_autor,
	cd_pessoa_fisica)
SELECT	nr_sequencia_w,
	clock_timestamp(),
	nm_usuario_p,
	dt_pedido,
	nm_usuario_pedido,
	ds_justificativa,
	CASE WHEN ie_estagio_autor_transf_w='3' THEN dt_autorizacao WHEN ie_estagio_autor_transf_w='7' THEN dt_autorizacao  ELSE null END ,
	CASE WHEN ie_estagio_autor_transf_w='3' THEN nm_autorizante WHEN ie_estagio_autor_transf_w='7' THEN nm_autorizante  ELSE null END ,
	CASE WHEN ie_estagio_autor_transf_w='3' THEN nm_usuario_autorizacao WHEN ie_estagio_autor_transf_w='7' THEN nm_usuario_autorizacao  ELSE null END ,
	nr_seq_agenda_nova_p,
	cd_requisitante,
	ds_observacao,
	nr_atendimento,
	cd_procedimento,
	ie_estagio_autor_transf_w,
	ie_origem_proced,
	dt_previsao,
	CASE WHEN ie_estagio_autor_transf_w='5' THEN ds_motivo_negativa  ELSE null END ,
	CASE WHEN ie_estagio_autor_transf_w='3' THEN dt_liberacao WHEN ie_estagio_autor_transf_w='7' THEN dt_liberacao  ELSE null END ,
	dt_fim_cotacao,
	nr_prescricao,
	nr_doc_convenio,
	cd_estabelecimento,
	cd_comprador,
	cd_senha,
	CASE WHEN ie_estagio_autor_transf_w='3' THEN dt_liberacao_autor WHEN ie_estagio_autor_transf_w='7' THEN dt_liberacao_autor  ELSE null END ,
	cd_pessoa_fisica
from	autorizacao_cirurgia
where	nr_sequencia	= nr_sequencia_p;

insert	into	proced_autor_cirurgia(nr_sequencia,
	nr_seq_autorizacao,
	cd_procedimento,
	ie_origem_proced,
	dt_atualizacao,
	nm_usuario,
	dt_atualizacao_nrec,
	nm_usuario_nrec,
	qt_procedimento)
SELECT	nextval('proced_autor_cirurgia_seq'),
	nr_sequencia_w,
	cd_procedimento,
	ie_origem_proced,
	clock_timestamp(),
	nm_usuario_p,
	clock_timestamp(),
	nm_usuario_p,
	qt_procedimento
from	proced_autor_cirurgia
where	nr_seq_autorizacao	= nr_sequencia_p;


open c01;
loop
fetch c01 into
	nr_seq_mat_autor_w;
EXIT WHEN NOT FOUND; /* apply on c01 */

	select	nextval('material_autor_cirurgia_seq')
	into STRICT	nr_seq_mat_novo_w
	;

	insert	into	material_autor_cirurgia(nr_sequencia,
		nr_seq_autorizacao,
		dt_atualizacao,
		nm_usuario,
		cd_material,
		qt_material,
		ds_observacao,
		vl_material,
		ie_aprovacao,
		vl_unitario_material,
		dt_atualizacao_nrec,
		nm_usuario_nrec,
		cd_cgc_fornec,
		qt_solicitada,
		nr_seq_fabricante,
		ie_origem_preco,
		nr_seq_opme)
	SELECT	nr_seq_mat_novo_w,
		nr_sequencia_w,
		clock_timestamp(),
		nm_usuario_p,
		a.cd_material,
		a.qt_material,
		a.ds_observacao,
		a.vl_material,
		a.ie_aprovacao,
		a.vl_unitario_material,
		clock_timestamp(),
		nm_usuario_p,
		a.cd_cgc_fornec,
		a.qt_solicitada,
		a.nr_seq_fabricante,
		a.ie_origem_preco,
		coalesce((	SELECT	max(x.nr_sequencia)
			from	agenda_pac_opme x
			where	x.nr_seq_agenda = nr_seq_agenda_nova_p
			and	x.cd_material = a.cd_material
			and	not exists (	select	1
						from	material_autor_cirurgia w
						where	w.nr_seq_opme = x.nr_sequencia)),a.nr_seq_opme)
	from	material_autor_cirurgia a
	where	a.nr_sequencia	= nr_seq_mat_autor_w;

	insert	into	material_autor_cir_cot(nr_sequencia,
		cd_cgc,
		dt_atualizacao,
		nm_usuario,
		vl_cotado,
		cd_condicao_pagamento,
		vl_unitario_cotado,
		dt_atualizacao_nrec,
		nm_usuario_nrec,
		ie_aprovacao)
	SELECT	nr_seq_mat_novo_w,
		cd_cgc,
		clock_timestamp(),
		nm_usuario_p,
		vl_cotado,
		cd_condicao_pagamento,
		vl_unitario_cotado,
		clock_timestamp(),
		nm_usuario_p,
		ie_aprovacao
	from	material_autor_cir_cot
	where	nr_sequencia	= nr_seq_mat_autor_w;
end loop;
close c01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE copiar_autor_cirurgia (nr_sequencia_p bigint, nr_seq_agenda_nova_p bigint, nm_usuario_p text) FROM PUBLIC;

