-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE mprev_gerar_captacao_emp ( nr_seq_busca_emp_p bigint, nm_usuario_p text) AS $body$
DECLARE


/* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Finalidade:	Verificar se já existe captação para a indicação empresarial, caso não existir irá inserir uma captação.
		Gravar o campo NR_SEQ_CONTRATO na tabela MPREV_BUSCA_EMPRESARIAL
				pasta (Busca Empresarial)
-------------------------------------------------------------------------------------------------------------------
Locais de chamada direta:
[  ]  Objetos do dicionário [X] Tasy (Delphi/Java) [  ] Portal [  ]  Relatórios [ ] Outros:
 ------------------------------------------------------------------------------------------------------------------
Pontos de atenção:
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */
nr_contrato_w			pls_contrato.nr_contrato%type;
nr_seq_contrato_w			pls_contrato.nr_sequencia%type;
nr_seq_captacao_w		mprev_captacao.nr_sequencia%type;
cd_pessoa_fisica_w		pessoa_fisica.cd_pessoa_fisica%type;

BEGIN

select	nr_contrato,
	cd_pessoa_fisica
into STRICT	nr_contrato_w,
	cd_pessoa_fisica_w
from	mprev_busca_empresarial
where	nr_sequencia = nr_seq_busca_emp_p;

select	max(nr_sequencia)
into STRICT	nr_seq_contrato_w
from	pls_contrato
where	nr_contrato	= nr_contrato_w;

if (coalesce(nr_seq_contrato_w,0) <> 0) then
	update	mprev_busca_empresarial
	set	nr_seq_contrato	= nr_seq_contrato_w
	where	nr_sequencia	= nr_seq_busca_emp_p;
else
	update	mprev_busca_empresarial
	set	nr_seq_contrato	 = NULL
	where	nr_sequencia	= nr_seq_busca_emp_p;
end if;

begin
	select	x.nr_sequencia
	into STRICT	nr_seq_captacao_w
	from	mprev_captacao x
	where	x.nr_seq_busca_emp = nr_seq_busca_emp_p;
exception
	when	no_data_found then
		nr_seq_captacao_w := null;
end;

if (coalesce(nr_seq_captacao_w::text, '') = '') then

	insert	into mprev_captacao(
		nr_sequencia,
		dt_atualizacao,
		nm_usuario,
		dt_atualizacao_nrec,
		nm_usuario_nrec,
		cd_pessoa_fisica,
		nr_seq_busca_emp,
		ie_status,
		ie_origem)
	values (nextval('mprev_captacao_seq'),
		clock_timestamp(),
		nm_usuario_p,
		clock_timestamp(),
		nm_usuario_p,
		cd_pessoa_fisica_w,
		nr_seq_busca_emp_p,
		'N',
		'SE');
else

	update	mprev_captacao
	set	cd_pessoa_fisica = cd_pessoa_fisica_w
	where 	nr_seq_busca_emp = nr_seq_busca_emp_p;

end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE mprev_gerar_captacao_emp ( nr_seq_busca_emp_p bigint, nm_usuario_p text) FROM PUBLIC;

