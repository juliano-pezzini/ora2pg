-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE baca_resultado_lab () AS $body$
DECLARE


nr_seq_resultado_w	bigint;
nr_sequencia_w		bigint;
nr_seq_exame_w		bigint;
nr_seq_material_w		bigint;
nr_seq_material_ant_w	bigint;
qt_resultado_w		double precision;
pr_resultado_w		double precision;
ds_resultado_w		varchar(2000);
pr_minimo_w			double precision;
pr_maximo_w			double precision;
qt_minima_w			double precision;
qt_maxima_w			double precision;
ds_referencia_w		varchar(255);
ie_sexo_w			varchar(1);
nr_anos_w			smallint;
ds_unidade_medida_w	varchar(15);
c000 CURSOR FOR
SELECT b.nr_seq_resultado,
   b.nr_sequencia,
   b.nr_seq_exame,
   b.nr_seq_material,
   b.qt_resultado,
   b.pr_resultado,
   b.ds_resultado,
   b.pr_minimo,
   b.pr_maximo,
   b.qt_minima,
   b.qt_maxima,
   replace(b.ds_referencia, ' ', ''),
   ((clock_timestamp() - d.dt_nascimento)/360) nr_anos,
   d.ie_sexo
from pessoa_fisica d,
   prescr_medica c,
   exame_lab_resultado a,
   exame_lab_result_item b
where a.nr_seq_resultado = b.nr_seq_resultado
  and a.nr_prescricao = c.nr_prescricao
  and c.cd_pessoa_fisica = d.cd_pessoa_fisica
  and (b.nr_seq_exame IS NOT NULL AND b.nr_seq_exame::text <> '')
order by 1,b.nr_seq_prescr;


BEGIN
OPEN C000;
LOOP
	FETCH C000 into	nr_seq_resultado_w,
				nr_sequencia_w,
				nr_seq_exame_w,
				nr_seq_material_w,
				qt_resultado_w,
				pr_resultado_w,
				ds_resultado_w,
				pr_minimo_w,
				pr_maximo_w,
				qt_minima_w,
				qt_maxima_w,
				ds_referencia_w,
				nr_anos_w,
				ie_sexo_w;
	EXIT WHEN NOT FOUND; /* apply on c000 */
	begin
	if ((qt_resultado_w IS NOT NULL AND qt_resultado_w::text <> '') or (pr_resultado_w IS NOT NULL AND pr_resultado_w::text <> '') or (ds_resultado_w IS NOT NULL AND ds_resultado_w::text <> '')) and
	   (((pr_minimo_w = 0) or (coalesce(pr_minimo_w::text, '') = '')) and
	    ((pr_maximo_w = 0) or (coalesce(pr_maximo_w::text, '') = '')) and
	    ((qt_minima_w = 0) or (coalesce(qt_minima_w::text, '') = '')) and
	    ((qt_minima_w = 0) or (coalesce(qt_maxima_w::text, '') = '')) and
	    ((ds_referencia_w = '') or (coalesce(ds_referencia_w::text, '') = '')))then
		begin
		if (nr_seq_material_w IS NOT NULL AND nr_seq_material_w::text <> '')  then
			nr_seq_material_ant_w := nr_seq_material_w;
		end if;
		begin
		SELECT coalesce(B.DS_UNIDADE_MEDIDA,C.DS_UNIDADE_MEDIDA) DS_UNIDADE_MEDIDA
		into STRICT ds_unidade_medida_w
		FROM exame_laboratorio c
LEFT OUTER JOIN exame_lab_material b ON (C.NR_SEQ_EXAME = B.NR_SEQ_EXAME AND nr_seq_material_ant_w = B.NR_SEQ_MATERIAL)
WHERE c.nr_seq_exame = nr_seq_exame_w   LIMIT 1;
		exception when others then
			ds_unidade_medida_w := '';
		end;
		begin
		select qt_minima,
			 qt_maxima,
			 qt_percent_min,
			 qt_percent_max,
			 ds_observacao
		into STRICT	qt_minima_w,
			qt_maxima_w,
			pr_minimo_w,
			pr_maximo_w,
			ds_referencia_w
		from exame_lab_padrao
		where ((ie_sexo = ie_sexo_w) or (ie_sexo = '0'))
		  and nr_seq_exame = nr_seq_exame_w
		  and coalesce(nr_seq_material,nr_seq_material_ant_w) = nr_seq_material_ant_w
		  and coalesce(nr_anos_w,0) between qt_idade_min and qt_idade_max
		  and ie_tipo_valor = 0
		order by nr_seq_material, ie_sexo LIMIT 1;
		exception
			when others then
				begin
				qt_minima_w := 0;
				qt_maxima_w := 0;
				pr_minimo_w := 0;
				pr_maximo_w := 0;
				end;
		end;
		update exame_lab_result_item
		set pr_minimo = pr_minimo_w,
		    pr_maximo = pr_maximo_w,
		    qt_minima = qt_minima_w,
		    qt_maxima = qt_maxima_w,
		    ds_referencia = coalesce(ds_referencia_w,ds_referencia),
		    ds_unidade_medida = coalesce(ds_unidade_medida_w,ds_unidade_medida)
		where nr_seq_resultado = nr_seq_resultado_w
		  and nr_seq_exame = nr_seq_exame_w;
		end;
	end if;
	end;
end loop;
close c000;
commit;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE baca_resultado_lab () FROM PUBLIC;

