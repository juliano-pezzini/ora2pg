-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE ptu_atual_seq_arq_a1200 ( nr_sequencia_p ptu_pacote.nr_sequencia%type, nr_seq_congenere_p pls_congenere.nr_sequencia%type, cd_cooperativa_p pls_congenere.cd_cooperativa%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nm_usuario_p usuario.nm_usuario%type, nm_exportacao_p INOUT ptu_pacote.ds_arquivo%type) AS $body$
DECLARE


nr_seq_arquivo_w		ptu_pacote.nr_seq_arquivo%type;
cd_unimed_origem_w		ptu_pacote.cd_unimed_origem%type;
versao_transacao_w		ptu_pacote.nr_versao_transacao%type;
nome_exportacao_w		varchar(14);


BEGIN

	select  coalesce(ptu_batch_xml_pck.obter_versao_transacao(cd_estabelecimento_p, nr_seq_congenere_p, cd_cooperativa_p, clock_timestamp(), 'A1200'), '05'),
		ptu_batch_xml_pck.obter_nome_exportacao(nr_sequencia_p, cd_estabelecimento_p, nr_seq_congenere_p, cd_cooperativa_p, clock_timestamp(), 'A1200', null)
	into STRICT 	versao_transacao_w,
		nome_exportacao_w
	;

	update	ptu_pacote
	set	nr_versao_transacao	= versao_transacao_w,
		nr_seq_arquivo		= coalesce((SUBSTR(nome_exportacao_w, 9, 2))::numeric , 1),
		dt_geracao_arquivo	= clock_timestamp(),
		nm_usuario_arq		= nm_usuario_p,
		ds_arquivo		= nome_exportacao_w
	where	nr_sequencia		= nr_sequencia_p;
	
	nm_exportacao_p := nome_exportacao_w;
	
	commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ptu_atual_seq_arq_a1200 ( nr_sequencia_p ptu_pacote.nr_sequencia%type, nr_seq_congenere_p pls_congenere.nr_sequencia%type, cd_cooperativa_p pls_congenere.cd_cooperativa%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nm_usuario_p usuario.nm_usuario%type, nm_exportacao_p INOUT ptu_pacote.ds_arquivo%type) FROM PUBLIC;

