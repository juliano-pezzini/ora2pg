-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE ptu_enviar_baixa_fatura_ws ( nr_seq_fat_baixa_p ptu_fat_baixa_interc.nr_sequencia%type) AS $body$
DECLARE


req_w			utl_http.req;
res_w			utl_http.resp;
url_w			varchar(100);
ds_resposta_w		varchar(32647);
ds_resposta_original_w	varchar(32647);
ie_status_w		ptu_fat_baixa_interc.ie_status%type;
ds_parametros_w		varchar(100);
ds_webservice_envio_w	pls_end_webservice_a510.ds_webservice_envio%type;
ds_servlet_w		constant varchar(255) := '/PtuBaixaFaturaServer/WBaixaFaturaServlet?';
ds_servlet_conf_w	pls_end_webservice_a510.ds_servlet%type;
ds_erro_w		ptu_fat_baixa_interc.ds_falha%type;
--Criptografia
encryption_type_w	integer :=     DBMS_CRYPTO.encrypt_aes256 + DBMS_CRYPTO.CHAIN_CBC + DBMS_CRYPTO.PAD_PKCS5;
ds_chave_w		bytea;
encrypted_raw_w		bytea;
key_bytes_raw_w		constant bytea     := '18DD15096C0C39C8B70E22A949B4D1E1DE7831FA4BD9E21E2E2FEDF9E5FC52C2';
C01 CURSOR(nr_seq_fat_baixa_pc	ptu_fat_baixa_interc.nr_sequencia%type) FOR
	SELECT	nr_sequencia,
		nr_versao_transacao
	from	ptu_fat_baixa_interc
	where	ie_status	in ('1','3','4') -- Pendente, concluido, falha
	and	coalesce(nr_seq_fat_baixa_pc::text, '') = ''
	
union all

	SELECT	nr_sequencia,
		nr_versao_transacao
	from	ptu_fat_baixa_interc
	where	ie_status	in ('1','3','4') -- Pendente, concluido, falha
	and	nr_sequencia	= nr_seq_fat_baixa_pc;

BEGIN

ds_webservice_envio_w	:= pls_obter_dados_ws_a510('CP');
ds_servlet_conf_w	:= pls_obter_dados_ws_a510('SV?');
url_w           	:= ds_webservice_envio_w||coalesce(ds_servlet_conf_w, ds_servlet_w);


for r_c01_w in c01( nr_seq_fat_baixa_p ) loop

	select	max(ie_status)
	into STRICT	ie_status_w
	from	ptu_fat_baixa_interc
	where	nr_sequencia	= r_c01_w.nr_sequencia;

	if (ie_status_w in ('1','3','4')) then -- Pendente, concluido, falha
		update	ptu_fat_baixa_interc
		set	ie_status	= '2',
			dt_envio	= clock_timestamp()
		where	nr_sequencia	= r_c01_w.nr_sequencia;
		commit;

		begin
		utl_http.set_transfer_timeout(180);

		ds_chave_w	:= utl_i18n.string_to_raw( r_c01_w.nr_sequencia||';'||r_c01_w.nr_versao_transacao, 'AL32UTF8');
		encrypted_raw_w	:= dbms_crypto.encrypt( ds_chave_w, encryption_type_w, key_bytes_raw_w);

		--ds_parametros_w	:= 'CHAVE='||encrypted_raw_w;
		ds_parametros_w	:= 'CHAVE='|| r_c01_w.nr_sequencia||';'||r_c01_w.nr_versao_transacao;
		req_w           := utl_http.begin_request(url => url_w||ds_parametros_w, method => 'POST');
		utl_http.set_header(req_w, 'user-agent', 'mozilla/4.0');
		utl_http.set_header(r => req_w, name => 'Content-Type', value => 'text/plain;charset=UTF-8');
		utl_http.set_header(r => req_w, name => 'Content-Length', value => length(ds_parametros_w));

		res_w := utl_http.get_response(req_w);

		loop
			utl_http.read_line(res_w, ds_resposta_w);

			ds_resposta_original_w	:= ds_resposta_w;
		end loop;

		utl_http.end_response(res_w);

		exception
			when utl_http.end_of_body then
				utl_http.end_response(res_w);

				update	ptu_fat_baixa_interc
				set	ie_status	= CASE WHEN ds_resposta_original_w='OK' THEN '3'  ELSE '4' END ,
					dt_resposta	= clock_timestamp(),
					ds_falha	= substr(CASE WHEN ds_resposta_original_w='OK' THEN ''  ELSE substr(ds_resposta_original_w,position('#@' in ds_resposta_original_w)+2,length(ds_resposta_original_w)) END ,1,4000)
				where	nr_sequencia	= r_c01_w.nr_sequencia;
				commit;

			when others then
				utl_http.end_response(res_w);

				ds_erro_w	:= substr(sqlerrm(SQLSTATE),1,4000);

				update	ptu_fat_baixa_interc
				set	ie_status	= '4',
					dt_resposta	= clock_timestamp(),
					ds_falha	= ds_erro_w
				where	nr_sequencia	= r_c01_w.nr_sequencia;
				commit;
		end;
	end if;

end loop;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ptu_enviar_baixa_fatura_ws ( nr_seq_fat_baixa_p ptu_fat_baixa_interc.nr_sequencia%type) FROM PUBLIC;

