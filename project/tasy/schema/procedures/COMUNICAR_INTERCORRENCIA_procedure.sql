-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE comunicar_intercorrencia ( nr_seq_atendimento_p bigint, nm_usuario_p text) AS $body$
DECLARE

 
dt_intercorrencia_w		timestamp;
dt_fim_intercorrencia_w	timestamp;
ds_motivo_w		varchar(4000);
nm_paciente_w		varchar(80);
cd_medico_resp_w	varchar(10);
ds_protocolo_medic_w	varchar(255);
ds_titulo_w		varchar(255);
ds_comunicado_w		text;
nm_usuario_destino_w	varchar(15);
nr_sequencia_w		bigint;
nr_seq_classif_w	bigint;	
ds_perfil_adicional_w	varchar(4000);
cd_estabelecimento_w	smallint;
nm_usuario_w		varchar(50);


BEGIN 
 
select	a.dt_intercorrencia, 
	a.dt_fim_intercorrencia, 
	a.ds_motivo, 
	SUBSTR(obter_nome_paciente_setor(b.nr_seq_paciente),1,80) nm_paciente, 
	c.cd_medico_resp, 
	SUBSTR(obter_desc_prot_medic(b.nr_seq_paciente),1,255) ds_protocolo_medic, 
	c.cd_estabelecimento, 
	c.nm_usuario 
into STRICT	dt_intercorrencia_w, 
	dt_fim_intercorrencia_w, 
	ds_motivo_w, 
	nm_paciente_w, 
	cd_medico_resp_w, 
	ds_protocolo_medic_w, 
	cd_estabelecimento_w, 
	nm_usuario_w 
from  	paciente_atend_interc a, 
	paciente_atendimento b, 
	paciente_setor c 
where 	b.nr_seq_atendimento	= nr_seq_atendimento_p 
and	a.nr_seq_atendimento	= b.nr_seq_atendimento 
and	b.nr_seq_paciente		= c.nr_seq_paciente 
and	nr_sequencia		 	= (	SELECT MAX(nr_sequencia) 
	  				 	from  paciente_atend_interc x 
					 	where x.nr_seq_atendimento = a.nr_seq_atendimento);
 
if (obter_se_usuario_medico(nm_usuario_w) = 'S') then 
 
 
 
 
 
 
	ds_titulo_w	:=	OBTER_DESC_EXPRESSAO(346164);
	ds_comunicado_w	:= WHEB_MENSAGEM_PCK.get_texto(457530,'nm_paciente='||upper(nm_paciente_w)||';ds_protocolo='||ds_protocolo_medic_w||';dt_intercorrencia=' 
		|| PKG_DATE_FORMATERS.TO_VARCHAR(dt_intercorrencia_w, 'timestamp', WHEB_USUARIO_PCK.GET_CD_ESTABELECIMENTO, nm_usuario_p)||';dt_fim_intercorrencia='||PKG_DATE_FORMATERS.TO_VARCHAR(dt_fim_intercorrencia_w, 'timestamp', WHEB_USUARIO_PCK.GET_CD_ESTABELECIMENTO, nm_usuario_p)||';ds_motivo='||ds_motivo_w);
 
 
 
else 
	CALL WHEB_MENSAGEM_PCK.Exibir_Mensagem_Abort(266293);
end if;
	 
 
	/* Oraci em 01/03/2008 OS84863 */
 
 
	select	obter_valor_param_usuario(3130, 33, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w) 
	into STRICT	ds_perfil_adicional_w 
	;
 
	select	max(nm_usuario) 
	into STRICT	nm_usuario_destino_w 
	from	usuario 
	where	cd_pessoa_fisica 	= cd_medico_resp_w 
	and	ie_situacao	= 'A' 
	and	dt_atualizacao	= (	SELECT 	MAX(dt_atualizacao) 
					from	usuario 
					where	cd_pessoa_fisica = cd_medico_resp_w);
					 
					 
	if (coalesce(nm_usuario_destino_w::text, '') = '') then 
		CALL WHEB_MENSAGEM_PCK.Exibir_Mensagem_Abort(266296);
	end if;
 
	select	nextval('comunic_interna_seq') 
	into STRICT 	nr_sequencia_w 
	;
 
	select 	obter_classif_comunic('F') 
	into STRICT    	nr_seq_classif_w 
	;
 
	insert into comunic_interna( 
			dt_comunicado, ds_titulo, ds_comunicado, nm_usuario, 
			dt_atualizacao, ie_geral, nm_usuario_destino, ds_perfil_adicional, nr_sequencia, 
			ie_gerencial, nr_seq_classif, dt_liberacao) 
	values ( 
			clock_timestamp(), ds_titulo_w, ds_comunicado_w, nm_usuario_p, 
			clock_timestamp(), 'N', nm_usuario_destino_w, ds_perfil_adicional_w || ',', nr_sequencia_w, 'N', 
			nr_seq_classif_w, clock_timestamp());
	commit;
 
 
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE comunicar_intercorrencia ( nr_seq_atendimento_p bigint, nm_usuario_p text) FROM PUBLIC;

