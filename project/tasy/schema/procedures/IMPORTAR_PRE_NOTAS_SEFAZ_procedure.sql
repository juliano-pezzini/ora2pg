-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE importar_pre_notas_sefaz (cd_cgc_p text, nm_usuario_p text, cd_chave_nfe_p text default null, ds_retorno_p INOUT text DEFAULT NULL) AS $body$
DECLARE


ds_retorno_integracao_w text;
json_w                  philips_json;
json_data_w             text;
ult_nsu_w               varchar(10);


BEGIN

if (cd_cgc_p IS NOT NULL AND cd_cgc_p::text <> '' AND nm_usuario_p IS NOT NULL AND nm_usuario_p::text <> '') then
   select to_char(coalesce(max(a.nr_seq_nfe), 0))
   into STRICT   ult_nsu_w
   from   pre_nota_fiscal a
   where  a.cd_cgc = cd_cgc_p;

   json_w := philips_json();
   json_w.put('CNPJ', cd_cgc_p);
   json_w.put('NM_USUARIO', nm_usuario_p);

   if (cd_chave_nfe_p IS NOT NULL AND cd_chave_nfe_p::text <> '') then
      json_w.put('CHNFE', cd_chave_nfe_p);
   else
      json_w.put('NSU', ult_nsu_w);
   end if;

   dbms_lob.createtemporary(json_data_w, true);
   json_w.(json_data_w);

   ds_retorno_integracao_w := bifrost.send_integration_content('pre.invoice.request', json_data_w, nm_usuario_p);
end if;

ds_retorno_p := ds_retorno_integracao_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE importar_pre_notas_sefaz (cd_cgc_p text, nm_usuario_p text, cd_chave_nfe_p text default null, ds_retorno_p INOUT text DEFAULT NULL) FROM PUBLIC;

