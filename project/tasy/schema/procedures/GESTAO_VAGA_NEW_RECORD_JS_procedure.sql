-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gestao_vaga_new_record_js ( nr_atendimento_p bigint, cd_perfil_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint, nr_seq_agenda_p bigint, ie_nova_transf_externa_p text, nr_atendimento_ext_p bigint, cd_pessoa_fisica_p INOUT text, cd_convenio_p INOUT bigint, cd_plano_p INOUT text, cd_categoria_p INOUT text, cd_estab_p INOUT bigint, cd_pessoa_fis_p INOUT text, nm_paciente_p INOUT text, nr_telefone_p INOUT text, cd_usuario_convenio_p INOUT text, cd_conven_p INOUT bigint, cd_categ_p INOUT text, cd_medico_p INOUT text, cd_doenca_cid_p INOUT text, cd_procedimento_p INOUT bigint, ie_origem_proced_p INOUT bigint, nr_atend_p INOUT bigint, cd_plan_p INOUT text, qt_horas_internacao_p INOUT bigint, ds_texto_p INOUT text, cd_pessoa_fisica_ext_p INOUT text, nm_paciente_ext_p INOUT text, ie_clinica_ext_p INOUT bigint, cd_convenio_ext_p INOUT bigint, cd_setor_atendimento_p INOUT bigint, cd_medico_responsavel_p INOUT bigint, ie_clinica_p INOUT bigint, nr_doc_convenio_p INOUT text, cd_tipo_acomodacao_p INOUT bigint, cd_plano_convenio_p INOUT text, dt_validade_carteira_p INOUT timestamp, cd_unid_basica_atual_p INOUT text, cd_unid_compl_atual_p INOUT text) AS $body$
DECLARE


cd_pessoa_fisica_w	varchar(10) := '';	
vl_parametro_w		varchar(10) := '';
		
cd_convenio_w		double precision;
cd_plano_w		varchar(50) := '';
cd_categoria_w		varchar(50) := '';

cd_estabelecimento_w	smallint;
cd_pessoa_fis_w		varchar(10) := '';
nm_paciente_w		varchar(60) := '';
nr_telefone_w		varchar(255) := '';	
cd_usuario_convenio_w	varchar(30) := '';	
cd_conven_w		integer;
cd_categ_w		varchar(10) := '';	
cd_medico_w		varchar(10) := '';
cd_doenca_cid_w		varchar(10) := '';	
cd_procedimento_w	bigint;
ie_origem_proced_w	bigint;
nr_atendimento_w		bigint;
cd_plan_w		varchar(10) := '';
qt_horas_internacao_w	bigint := 0;

ds_texto_w		varchar(255) := '';
cd_setor_atendimento_w 		bigint;
cd_medico_responsavel_w		bigint;
ie_clinica_w				bigint := 0;				
nr_doc_convenio_w 			varchar(10) := '';	
cd_tipo_acomodacao_w		bigint;
cd_unid_basica_atual_w varchar(10);				
cd_unid_compl_atual_w varchar(10);


BEGIN

if (nr_atendimento_p > 0)then
	begin
	
	select   coalesce(max(cd_pessoa_fisica), '')
	into STRICT	 cd_pessoa_fisica_w
	from  	 atendimento_paciente 
	where 	 nr_atendimento = nr_atendimento_p;

	vl_parametro_w := obter_param_usuario(1002, 20, cd_perfil_p, nm_usuario_p, cd_estabelecimento_p, vl_parametro_w);

	cd_unid_basica_atual_w := substr(obter_unidade_atendimento(nr_atendimento_p,'IAA','UB'),1,40);				
	cd_unid_compl_atual_w  := substr(obter_unidade_atendimento(nr_atendimento_p,'IAA','UC'),1,40);
	
	if (vl_parametro_w = 'S')then
		begin
		
		select	cd_medico_resp,
				ie_clinica
		into STRICT 	cd_medico_responsavel_w,
				ie_clinica_w
		from	atendimento_paciente
		where 	nr_atendimento = nr_atendimento_p;
		
		cd_convenio_w 	:= obter_convenio_atendimento(nr_atendimento_p);
		cd_plano_w	:= coalesce(obter_plano_atendimento(nr_atendimento_p, 'C'), '');
		cd_categoria_w	:= coalesce(obter_categoria_atendimento(nr_atendimento_p), '');
		cd_setor_atendimento_w := substr(obter_unidade_atendimento(nr_atendimento_p,'IAA','CS'),1,40);
		nr_doc_convenio_w := coalesce(obter_guia_convenio(nr_atendimento_p), '');
		cd_tipo_acomodacao_w := obter_acomod_conv_atend(nr_atendimento_p);
		
		end;
	end if;
	
	end;
end if;
	
if (nr_seq_agenda_p IS NOT NULL AND nr_seq_agenda_p::text <> '') and (nr_seq_agenda_p <> 0)then
	begin
	
	select  max(cd_estabelecimento),
		coalesce(max(cd_pessoa_fisica), ''),
		coalesce(max(nm_paciente), ''),
		coalesce(max(nr_telefone), ''),
		coalesce(max(cd_usuario_convenio), ''), 
		max(cd_convenio), 
		coalesce(max(cd_categoria), ''),
		coalesce(max(cd_medico), ''),
		coalesce(max(cd_doenca_cid), ''),
		max(cd_procedimento),
		max(ie_origem_proced),
		max(nr_atendimento),
		coalesce(max(cd_plano), ''),
		max(obter_tempo_internacao(cd_medico,nr_seq_proc_interno)) qt_horas_internacao
	into STRICT	cd_estabelecimento_w,
		cd_pessoa_fis_w,
		nm_paciente_w,
		nr_telefone_w,
		cd_usuario_convenio_w,
		cd_conven_w,
		cd_categ_w,
		cd_medico_w,
		cd_doenca_cid_w,
		cd_procedimento_w,
		ie_origem_proced_w,
		nr_atendimento_w,
		cd_plan_w,
		qt_horas_internacao_w
	from    agenda_paciente_v
	where   nr_sequencia = nr_seq_agenda_p;

	end;
end if;

select 	coalesce(max(ds_texto), '')
into STRICT	ds_texto_w
from 	gestao_vaga_texto_padrao 
where  	cd_estabelecimento = cd_estabelecimento_p;

cd_pessoa_fisica_p := cd_pessoa_fisica_w;

cd_convenio_p	:= cd_convenio_w;
cd_plano_p	:= cd_plano_w;
cd_categoria_p	:= cd_categoria_w;

cd_estab_p		:= cd_estabelecimento_w;
cd_pessoa_fis_p		:= cd_pessoa_fis_w;
nm_paciente_p		:= nm_paciente_w;
nr_telefone_p		:= nr_telefone_w;
cd_usuario_convenio_p	:= cd_usuario_convenio_w;
cd_conven_p		:= cd_conven_w;
cd_categ_p		:= cd_categ_w;
cd_medico_p		:= cd_medico_w;
cd_doenca_cid_p		:= cd_doenca_cid_w;
cd_procedimento_p		:= cd_procedimento_w;
ie_origem_proced_p	:= ie_origem_proced_w;
nr_atend_p		:= nr_atendimento_w;
cd_plan_p		:= cd_plan_w;
qt_horas_internacao_p	:= qt_horas_internacao_w;
ds_texto_p	:= ds_texto_w;

cd_setor_atendimento_p := cd_setor_atendimento_w;
cd_medico_responsavel_p := cd_medico_responsavel_w;
ie_clinica_p := ie_clinica_w;
nr_doc_convenio_p := nr_doc_convenio_w;
cd_tipo_acomodacao_p := cd_tipo_acomodacao_w;
cd_unid_basica_atual_p := cd_unid_basica_atual_w;
cd_unid_compl_atual_p := cd_unid_compl_atual_w;


if (ie_nova_transf_externa_p = 'S') then
	begin
	select	max(a.cd_pessoa_fisica),
		max(substr(obter_nome_pf(a.cd_pessoa_fisica),1,60)),
		max(a.ie_clinica),
		max(c.cd_convenio),
		max(c.cd_plano_convenio),
		max(c.dt_validade_carteira)
	into STRICT	cd_pessoa_fisica_ext_p,
		nm_paciente_ext_p,
		ie_clinica_ext_p,
		cd_convenio_ext_p,
		cd_plano_convenio_p,
		dt_validade_carteira_p
	from	atendimento_paciente a,
		atend_categoria_convenio c
	where	a.nr_atendimento	= c.nr_atendimento
	and	a.nr_atendimento	= nr_atendimento_ext_p;
	end;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gestao_vaga_new_record_js ( nr_atendimento_p bigint, cd_perfil_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint, nr_seq_agenda_p bigint, ie_nova_transf_externa_p text, nr_atendimento_ext_p bigint, cd_pessoa_fisica_p INOUT text, cd_convenio_p INOUT bigint, cd_plano_p INOUT text, cd_categoria_p INOUT text, cd_estab_p INOUT bigint, cd_pessoa_fis_p INOUT text, nm_paciente_p INOUT text, nr_telefone_p INOUT text, cd_usuario_convenio_p INOUT text, cd_conven_p INOUT bigint, cd_categ_p INOUT text, cd_medico_p INOUT text, cd_doenca_cid_p INOUT text, cd_procedimento_p INOUT bigint, ie_origem_proced_p INOUT bigint, nr_atend_p INOUT bigint, cd_plan_p INOUT text, qt_horas_internacao_p INOUT bigint, ds_texto_p INOUT text, cd_pessoa_fisica_ext_p INOUT text, nm_paciente_ext_p INOUT text, ie_clinica_ext_p INOUT bigint, cd_convenio_ext_p INOUT bigint, cd_setor_atendimento_p INOUT bigint, cd_medico_responsavel_p INOUT bigint, ie_clinica_p INOUT bigint, nr_doc_convenio_p INOUT text, cd_tipo_acomodacao_p INOUT bigint, cd_plano_convenio_p INOUT text, dt_validade_carteira_p INOUT timestamp, cd_unid_basica_atual_p INOUT text, cd_unid_compl_atual_p INOUT text) FROM PUBLIC;

