-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_analise_prod_migr_grupo () AS $body$
DECLARE

 
nr_seq_grupo_des_w	bigint;

nr_seq_analise_dia_w	bigint;

qt_os_colab_inic_w	bigint;
qt_os_colab_proj_inic_w	bigint;
qt_os_colab_rev_inic_w	bigint;
qt_os_colab_val_inic_w	bigint;

qt_os_colab_w		bigint;
qt_os_colab_proj_w	bigint;
qt_os_colab_rev_w	bigint;
qt_os_colab_val_w	bigint;

qt_os_colab_60_inic_w	bigint;
qt_os_colab_45_inic_w	bigint;
qt_os_colab_30_inic_w	bigint;
qt_os_colab_15_inic_w	bigint;
qt_os_colab_07_inic_w	bigint;
qt_os_colab_sem_inic_w	bigint;

qt_os_colab_60_w	bigint;
qt_os_colab_45_w	bigint;
qt_os_colab_30_w	bigint;
qt_os_colab_15_w	bigint;
qt_os_colab_07_w	bigint;
qt_os_colab_sem_w	bigint;

qt_hora_colab_w		double precision;

qt_hora_os_w		double precision;
qt_hora_os_proj_w	double precision;
qt_hora_os_proj_terc_w	double precision;
qt_hora_os_rev_w	double precision;
qt_hora_os_rev_terc_w	double precision;
qt_hora_os_nec_w	double precision;
qt_hora_os_nec_terc_w	double precision;
qt_hora_os_dep_w	double precision;
qt_hora_os_dep_terc_w	double precision;

c01 CURSOR FOR 
SELECT	distinct g.nr_sequencia 
from	grupo_desenvolvimento g 
where	g.nr_seq_gerencia = 9 
and	g.ie_situacao = 'A';


BEGIN 
open c01;
loop 
fetch c01 into nr_seq_grupo_des_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	begin 
	/* obter análise dia / grupo - caso existir */
 
	select	coalesce(max(nr_sequencia),0) 
	into STRICT	nr_seq_analise_dia_w 
	from	w_analise_prod_migr_colab 
	where	dt_analise = trunc(clock_timestamp()) 
	and	ie_analise = 'G' 
	and	nr_seq_grupo_des = nr_seq_grupo_des_w;
	 
	/* obter quantidade os's (geral) grupo */
 
	select	count(*) 
	into STRICT	qt_os_colab_w 
	from	man_ordem_servico o 
	where	o.nr_seq_grupo_des = nr_seq_grupo_des_w 
	and	o.ie_status_ordem in ('1','2') 
	and	o.nr_seq_estagio in ( 
			SELECT	x.nr_seq_estagio 
			from	man_estagio_usuario x 
			where	x.nm_usuario_acao in (			 
					SELECT	distinct u.nm_usuario_grupo 
					from	usuario x, 
						usuario_grupo_des u, 
						grupo_desenvolvimento g 
					where	x.nm_usuario = u.nm_usuario_grupo 
					and	x.ie_situacao = 'A' 
					and	u.nr_seq_grupo = g.nr_sequencia 
					and	g.nr_seq_gerencia = 9));
			 
	/* obter quantidade os's (projetos - migração) grupo */
 
	select	count(*) 
	into STRICT	qt_os_colab_proj_w 
	from	man_ordem_servico o 
	where	o.nr_seq_grupo_des = nr_seq_grupo_des_w 
	and	o.ie_status_ordem in ('1','2') 
	and	o.nr_seq_estagio in ( 
			SELECT	x.nr_seq_estagio 
			from	man_estagio_usuario x 
			where	x.nm_usuario_acao in (			 
					SELECT	distinct u.nm_usuario_grupo 
					from	usuario x, 
						usuario_grupo_des u, 
						grupo_desenvolvimento g 
					where	x.nm_usuario = u.nm_usuario_grupo 
					and	x.ie_situacao = 'A' 
					and	u.nr_seq_grupo = g.nr_sequencia 
					and	g.nr_seq_gerencia = 9)) 
	and	exists ( 
			select	1 
			from	proj_projeto x 
			where	x.nr_seq_ordem_serv = o.nr_sequencia 
			and	x.nr_seq_gerencia = 9 
			and	x.nr_seq_classif = 14);
	 
	/* obter quantidade os's (revisão - projetos - migração) grupo */
 
	select	count(*) 
	into STRICT	qt_os_colab_rev_w 
	from	man_ordem_servico o 
	where	o.nr_seq_grupo_des = nr_seq_grupo_des_w 
	and	o.ie_status_ordem in ('1','2') 
	and	o.nr_seq_estagio in ( 
			SELECT	x.nr_seq_estagio 
			from	man_estagio_usuario x 
			where	x.nm_usuario_acao in (			 
					SELECT	distinct u.nm_usuario_grupo 
					from	usuario x, 
						usuario_grupo_des u, 
						grupo_desenvolvimento g 
					where	x.nm_usuario = u.nm_usuario_grupo 
					and	x.ie_situacao = 'A' 
					and	u.nr_seq_grupo = g.nr_sequencia 
					and	g.nr_seq_gerencia = 9)) 
	and	exists ( 
			select	1 
			from	proj_projeto x, 
				proj_ordem_servico y 
			where	x.nr_sequencia = y.nr_seq_proj 
			and	y.nr_seq_ordem = o.nr_sequencia 
			and	x.nr_seq_gerencia = 9 
			and	x.nr_seq_classif = 14 
			and	y.ie_tipo_ordem = 'R');
			 
	/* obter quantidade os's (validação - projetos - migração) grupo */
			 
	select	count(*) 
	into STRICT	qt_os_colab_val_w 
	from	man_ordem_servico_validacao_v v, 
		man_ordem_servico_exec e 
	where	v.nr_sequencia = e.nr_seq_ordem 
	and	e.nr_seq_tipo_exec = 5 
	and	e.nm_usuario_exec in ( 
			SELECT	distinct u.nm_usuario_grupo 
			from	usuario x, 
				usuario_grupo_des u, 
				grupo_desenvolvimento g 
			where	x.nm_usuario = u.nm_usuario_grupo 
			and	x.ie_situacao = 'A' 
			and	u.nr_seq_grupo = g.nr_sequencia 
			and	g.nr_seq_gerencia = 9) 
	and	v.nr_seq_grupo_des = nr_seq_grupo_des_w;
	 
	/* obter quantidade os's (geral - conforme meta período) grupo */
 
	select	sum(CASE WHEN obter_tipo_os(o.dt_ordem_servico)='0' THEN 1  ELSE 0 END ) qt_os_colab_60, 
		sum(CASE WHEN obter_tipo_os(o.dt_ordem_servico)='1' THEN 1  ELSE 0 END ) qt_os_colab_45, 
		sum(CASE WHEN obter_tipo_os(o.dt_ordem_servico)='2' THEN 1  ELSE 0 END ) qt_os_colab_30, 
		sum(CASE WHEN obter_tipo_os(o.dt_ordem_servico)='3' THEN 1  ELSE 0 END ) qt_os_colab_15, 
		sum(CASE WHEN obter_tipo_os(o.dt_ordem_servico)='4' THEN 1  ELSE 0 END ) qt_os_colab_07, 
		sum(CASE WHEN obter_tipo_os(o.dt_ordem_servico)='5' THEN 1  ELSE 0 END ) qt_os_colab_sem 
	into STRICT	qt_os_colab_60_w, 
		qt_os_colab_45_w, 
		qt_os_colab_30_w, 
		qt_os_colab_15_w, 
		qt_os_colab_07_w, 
		qt_os_colab_sem_w		 
	from	man_ordem_servico o	 
	where	o.nr_seq_grupo_des = nr_seq_grupo_des_w 
	and	o.ie_status_ordem in ('1','2') 
	and	o.nr_seq_estagio in ( 
			SELECT	x.nr_seq_estagio 
			from	man_estagio_usuario x 
			where	x.nm_usuario_acao in (			 
					SELECT	distinct u.nm_usuario_grupo 
					from	usuario x, 
						usuario_grupo_des u, 
						grupo_desenvolvimento g 
					where	x.nm_usuario = u.nm_usuario_grupo 
					and	x.ie_situacao = 'A' 
					and	u.nr_seq_grupo = g.nr_sequencia 
					and	g.nr_seq_gerencia = 9));
	 
	/* obter horas trabalhadas (conforme controle) colaborador */
 
	/*select	sum(nvl(man_obter_tempo_ativ_usuario(u.nm_usuario, sysdate, 'H'),0)) 
	into	qt_hora_colab_w 
	from	usuario u 
	where	u.nm_usuario in ( 
			select	distinct u.nm_usuario_grupo 
			from	usuario x, 
				usuario_grupo_des u, 
				grupo_desenvolvimento g 
			where	x.nm_usuario = u.nm_usuario_grupo 
			and	x.ie_situacao = 'A' 
			and	u.nr_seq_grupo = g.nr_sequencia 
			and	g.nr_seq_gerencia = 9);*/
 
	qt_hora_colab_w := 0;
	 
	/* obter horas trabalhadas (em os's - geral) grupo */
 
	select	dividir(coalesce(sum(a.qt_minuto),0),60) 
	into STRICT	qt_hora_os_w 
	from	man_ordem_serv_ativ a, 
		man_ordem_servico o 
	where	a.nr_seq_ordem_serv = o.nr_sequencia 
	and	o.nr_seq_grupo_des = nr_seq_grupo_des_w 
	and	trunc(a.dt_atividade) = trunc(clock_timestamp());
	 
	/* obter horas trabalhadas (em os's - projetos migração - usuário) grupo */
 
	select	dividir(coalesce(sum(a.qt_minuto),0),60) 
	into STRICT	qt_hora_os_proj_w 
	from	man_ordem_serv_ativ a, 
		man_ordem_servico o 
	where	a.nr_seq_ordem_serv = o.nr_sequencia 
	and	o.nr_seq_grupo_des = nr_seq_grupo_des_w 
	and	trunc(a.dt_atividade) = trunc(clock_timestamp()) 
	and	obter_tipo_os_proj_migr_usu(a.nr_seq_ordem_serv, a.nm_usuario_exec) = 'PU';
	 
	/* obter horas trabalhadas (em os's - projetos migração - terceiros) grupo */
 
	select	dividir(coalesce(sum(a.qt_minuto),0),60) 
	into STRICT	qt_hora_os_proj_terc_w 
	from	man_ordem_serv_ativ a, 
		man_ordem_servico o 
	where	a.nr_seq_ordem_serv = o.nr_sequencia 
	and	o.nr_seq_grupo_des = nr_seq_grupo_des_w 
	and	trunc(a.dt_atividade) = trunc(clock_timestamp()) 
	and	obter_tipo_os_proj_migr_usu(a.nr_seq_ordem_serv, a.nm_usuario_exec) = 'PT';
	 
	/* obter horas trabalhadas (em os's - projetos migração - revisões - usuário) grupo */
 
	select	dividir(coalesce(sum(a.qt_minuto),0),60) 
	into STRICT	qt_hora_os_rev_w 
	from	man_ordem_serv_ativ a, 
		man_ordem_servico o 
	where	a.nr_seq_ordem_serv = o.nr_sequencia 
	and	o.nr_seq_grupo_des = nr_seq_grupo_des_w 
	and	trunc(a.dt_atividade) = trunc(clock_timestamp()) 
	and	obter_tipo_os_proj_migr_usu(a.nr_seq_ordem_serv, a.nm_usuario_exec) = 'RU';
	 
	/* obter horas trabalhadas (em os's - projetos migração - revisões - terceiros) grupo */
 
	select	dividir(coalesce(sum(a.qt_minuto),0),60) 
	into STRICT	qt_hora_os_rev_terc_w 
	from	man_ordem_serv_ativ a, 
		man_ordem_servico o 
	where	a.nr_seq_ordem_serv = o.nr_sequencia 
	and	o.nr_seq_grupo_des = nr_seq_grupo_des_w 
	and	trunc(a.dt_atividade) = trunc(clock_timestamp()) 
	and	obter_tipo_os_proj_migr_usu(a.nr_seq_ordem_serv, a.nm_usuario_exec) = 'RT';
	 
	/* obter horas trabalhadas (em os's - projetos migração - necessidades vinculadas - usuário) grupo */
 
	select	dividir(coalesce(sum(a.qt_minuto),0),60) 
	into STRICT	qt_hora_os_nec_w 
	from	man_ordem_serv_ativ a, 
		man_ordem_servico o 
	where	a.nr_seq_ordem_serv = o.nr_sequencia 
	and	o.nr_seq_grupo_des = nr_seq_grupo_des_w 
	and	trunc(a.dt_atividade) = trunc(clock_timestamp()) 
	and	obter_tipo_os_proj_migr_usu(a.nr_seq_ordem_serv, a.nm_usuario_exec) = 'NU';
	 
	/* obter horas trabalhadas (em os's - projetos migração - necessidades vinculadas - terceiros) grupo */
 
	select	dividir(coalesce(sum(a.qt_minuto),0),60) 
	into STRICT	qt_hora_os_nec_terc_w 
	from	man_ordem_serv_ativ a, 
		man_ordem_servico o 
	where	a.nr_seq_ordem_serv = o.nr_sequencia 
	and	o.nr_seq_grupo_des = nr_seq_grupo_des_w 
	and	trunc(a.dt_atividade) = trunc(clock_timestamp()) 
	and	obter_tipo_os_proj_migr_usu(a.nr_seq_ordem_serv, a.nm_usuario_exec) = 'NT';
	 
	/* obter horas trabalhadas (em os's - projetos migração - dependências - usuário) grupo */
 
	select	dividir(coalesce(sum(a.qt_minuto),0),60) 
	into STRICT	qt_hora_os_dep_w 
	from	man_ordem_serv_ativ a, 
		man_ordem_servico o 
	where	a.nr_seq_ordem_serv = o.nr_sequencia 
	and	o.nr_seq_grupo_des = nr_seq_grupo_des_w 
	and	trunc(a.dt_atividade) = trunc(clock_timestamp()) 
	and	obter_tipo_os_proj_migr_usu(a.nr_seq_ordem_serv, a.nm_usuario_exec) = 'DU';
	 
	/* obter horas trabalhadas (em os's - projetos migração - dependências - terceiro) grupo */
	 
	select	dividir(coalesce(sum(a.qt_minuto),0),60) 
	into STRICT	qt_hora_os_dep_terc_w 
	from	man_ordem_serv_ativ a, 
		man_ordem_servico o 
	where	a.nr_seq_ordem_serv = o.nr_sequencia 
	and	o.nr_seq_grupo_des = nr_seq_grupo_des_w 
	and	trunc(a.dt_atividade) = trunc(clock_timestamp()) 
	and	obter_tipo_os_proj_migr_usu(a.nr_seq_ordem_serv, a.nm_usuario_exec) = 'DT';
		 
	/* gerar análise dia / grupo - caso não existir */
 
	if (nr_seq_analise_dia_w = 0) then 
		begin 
		/* obter valores produtividade referente ao términdo do dia anterior - caso existir - para geração dos valores iniciais em relação ao dia atual */
 
		qt_os_colab_inic_w	:= qt_os_colab_w;
		qt_os_colab_proj_inic_w	:= qt_os_colab_proj_w;
		qt_os_colab_rev_inic_w	:= qt_os_colab_rev_w;
		qt_os_colab_val_inic_w	:= qt_os_colab_val_w;
		qt_os_colab_60_inic_w	:= qt_os_colab_60_w;
		qt_os_colab_45_inic_w	:= qt_os_colab_45_w;
		qt_os_colab_30_inic_w	:= qt_os_colab_30_w;
		qt_os_colab_15_inic_w	:= qt_os_colab_15_w;
		qt_os_colab_07_inic_w	:= qt_os_colab_07_w;
		qt_os_colab_sem_inic_w	:= qt_os_colab_sem_w;
		 
		insert into w_analise_prod_migr_colab( 
			nr_sequencia, 
			dt_analise, 
			ie_analise, 
			nm_usuario_analise, 
			nr_seq_grupo_des, 
			qt_os_colab_inic, 
			qt_os_colab_proj_inic, 
			qt_os_colab_rev_inic, 
			qt_os_colab_val_inic,			 
			qt_os_colab, 
			qt_os_colab_proj, 
			qt_os_colab_rev, 
			qt_os_colab_val,			 
			qt_os_colab_60_inic, 
			qt_os_colab_45_inic, 
			qt_os_colab_30_inic, 
			qt_os_colab_15_inic, 
			qt_os_colab_07_inic, 
			qt_os_colab_sem_inic, 
			qt_os_colab_60, 
			qt_os_colab_45, 
			qt_os_colab_30, 
			qt_os_colab_15, 
			qt_os_colab_07, 
			qt_os_colab_sem, 
			qt_hora_colab, 
			qt_hora_os, 
			qt_hora_os_proj, 
			qt_hora_os_proj_terc, 
			qt_hora_os_rev, 
			qt_hora_os_rev_terc, 
			qt_hora_os_nec, 
			qt_hora_os_nec_terc, 
			qt_hora_os_dep, 
			qt_hora_os_dep_terc) 
		values ( 
			nextval('w_analise_prod_migr_colab_seq'), 
			trunc(clock_timestamp()), 
			'G', 
			'Rafael', 
			nr_seq_grupo_des_w, 
			qt_os_colab_inic_w, 
			qt_os_colab_proj_inic_w, 
			qt_os_colab_rev_inic_w, 
			qt_os_colab_val_inic_w, 
			qt_os_colab_w, 
			qt_os_colab_proj_w, 
			qt_os_colab_rev_w, 
			qt_os_colab_val_w, 
			qt_os_colab_60_inic_w, 
			qt_os_colab_45_inic_w, 
			qt_os_colab_30_inic_w, 
			qt_os_colab_15_inic_w, 
			qt_os_colab_07_inic_w, 
			qt_os_colab_sem_inic_w, 
			qt_os_colab_60_w, 
			qt_os_colab_45_w, 
			qt_os_colab_30_w, 
			qt_os_colab_15_w, 
			qt_os_colab_07_w, 
			qt_os_colab_sem_w,			 
			qt_hora_colab_w, 
			qt_hora_os_w, 
			qt_hora_os_proj_w, 
			qt_hora_os_proj_terc_w, 
			qt_hora_os_rev_w, 
			qt_hora_os_rev_terc_w, 
			qt_hora_os_nec_w, 
			qt_hora_os_nec_terc_w, 
			qt_hora_os_dep_w, 
			qt_hora_os_dep_terc_w);
		end;
	else 
		begin 
		update	w_analise_prod_migr_colab 
		set	qt_os_colab = qt_os_colab_w, 
			qt_os_colab_proj = qt_os_colab_proj_w, 
			qt_os_colab_rev = qt_os_colab_rev_w, 
			qt_os_colab_val = qt_os_colab_val, 
			qt_os_colab_60 = qt_os_colab_60_w, 
			qt_os_colab_45 = qt_os_colab_45_w, 
			qt_os_colab_30 = qt_os_colab_30_w, 
			qt_os_colab_15 = qt_os_colab_15_w, 
			qt_os_colab_07 = qt_os_colab_07_w, 
			qt_os_colab_sem = qt_os_colab_sem_w, 
			qt_hora_colab = qt_hora_colab_w, 
			qt_hora_os = qt_hora_os_w, 
			qt_hora_os_proj = qt_hora_os_proj_w, 
			qt_hora_os_proj_terc = qt_hora_os_proj_terc_w, 
			qt_hora_os_rev = qt_hora_os_rev_w, 
			qt_hora_os_rev_terc = qt_hora_os_rev_terc_w, 
			qt_hora_os_nec = qt_hora_os_nec_w, 
			qt_hora_os_nec_terc = qt_hora_os_nec_terc_w, 
			qt_hora_os_dep = qt_hora_os_dep_w, 
			qt_hora_os_dep_terc = qt_hora_os_dep_terc_w 
		where	nr_sequencia = nr_seq_analise_dia_w;
		end;
	end if;
	end;
end loop;
close c01;
commit;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_analise_prod_migr_grupo () FROM PUBLIC;

