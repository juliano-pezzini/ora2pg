-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_dif_copia_prescr (nr_prescricao_p prescr_material.nr_prescricao%type) AS $body$
DECLARE

	
	nr_sequencia_w				bigint;
	nr_prescr_anterior_w		prescr_material.nr_prescricao_anterior%type;
	nr_prescricao_anterior_w	prescr_medica.nr_prescricao_anterior%type;
	cd_material_nov_w			prescr_material.cd_material%type;
	ds_material_nov_w			varchar(255);
	qt_dose_nov_w				prescr_material.qt_dose%type;
	cd_un_medida_dose_nov_w		prescr_material.cd_unidade_medida_dose%type;
	ie_via_aplicacao_nov_w		prescr_material.ie_via_aplicacao%type;
	cd_intervalo_nov_w			prescr_material.cd_intervalo%type;
	ie_se_necessario_nov_w		prescr_material.ie_se_necessario%type;
	ie_acm_nov_w				prescr_material.ie_acm%type;
	ie_urgencia_nov_w			prescr_material.ie_urgencia%type;
	ds_dose_dif_nov_w			prescr_material.ds_dose_diferenciada%type;
	nr_prescricao_orig_w		prescr_material.nr_prescricao%type;
	cd_material_orig_w			prescr_material.cd_material%type;	
	ds_material_orig_w			varchar(255);
	qt_dose_orig_w				prescr_material.qt_dose%type;
	cd_un_medida_dose_orig_w	prescr_material.cd_unidade_medida_dose%type;
	ie_via_aplicacao_orig_w		prescr_material.ie_via_aplicacao%type;
	cd_intervalo_orig_w			prescr_material.cd_intervalo%type;
	ie_se_necessario_orig_w		prescr_material.ie_se_necessario%type;
	ie_acm_orig_w				prescr_material.ie_acm%type;
	ie_urgencia_orig_w			prescr_material.ie_urgencia%type;
	ds_dose_dif_orig_w			prescr_material.ds_dose_diferenciada%type;
	ie_tipo_item_w				smallint;

/*
	ie_tipo_item_w 
	 - 0: presente somente na nova
	 - 1: presente no origem e nova
	 - 2: presente somente na origem
*/
	
	
c01 CURSOR FOR
	SELECT a.cd_material,
		   substr(obter_desc_material(a.cd_material), 1, 255),
           a.qt_dose,
           a.cd_unidade_medida_dose, 
           a.ie_via_aplicacao, 
           a.cd_intervalo, 
           a.ie_se_necessario, 
           a.ie_acm, 
           a.ie_urgencia, 
           a.ds_dose_diferenciada,
		   coalesce(a.nr_prescricao_anterior, 0)
	  from prescr_material a 
	 where a.nr_prescricao = nr_prescricao_p
	   and coalesce(a.dt_suspensao::text, '') = '';
	
c02 CURSOR FOR
	SELECT distinct a.nr_prescricao_anterior
	  from prescr_material a
	 where a.nr_prescricao = nr_prescricao_p
	   and coalesce(a.dt_suspensao::text, '') = ''
	   and (a.nr_prescricao_anterior IS NOT NULL AND a.nr_prescricao_anterior::text <> '');
	
c03 CURSOR FOR
	SELECT b.cd_material,
		   substr(obter_desc_material(b.cd_material), 1, 255),
		   b.qt_dose, 
		   b.cd_unidade_medida_dose, 
		   b.ie_via_aplicacao, 
		   b.cd_intervalo, 
		   b.ie_se_necessario, 
		   b.ie_acm, 
		   b.ie_urgencia, 
		   b.ds_dose_diferenciada
	  from prescr_material b  		   
	 where b.nr_prescricao = nr_prescr_anterior_w
	   and not exists (SELECT 1 from prescr_material x where x.nr_prescricao = nr_prescricao_p and x.nr_prescricao_anterior = nr_prescr_anterior_w and x.cd_material = b.cd_material)
	   and not exists (select 1 from w_dif_prescr_temp y where y.nr_prescricao = nr_prescricao_p /*and y.nr_prescricao_orig = nr_prescr_anterior_w*/
 and y.cd_material_orig = b.cd_material);

BEGIN
	delete
	  from w_dif_prescr_temp 
	 where nr_prescricao = nr_prescricao_p;
	
	select	coalesce(max(nr_prescricao_anterior), 0)
	into STRICT	nr_prescricao_anterior_w
	from	prescr_medica
	where	nr_prescricao = nr_prescricao_p;
	
	if (nr_prescricao_anterior_w > 0) then
		open c01;  -- cursor da nova prescricao
			loop
				fetch c01 into
					cd_material_nov_w,
					ds_material_nov_w,
					qt_dose_nov_w,
					cd_un_medida_dose_nov_w,
					ie_via_aplicacao_nov_w,
					cd_intervalo_nov_w,
					ie_se_necessario_nov_w,
					ie_acm_nov_w,
					ie_urgencia_nov_w,
					ds_dose_dif_nov_w,
					nr_prescr_anterior_w;
				EXIT WHEN NOT FOUND; /* apply on c01 */
					
					ie_tipo_item_w := 0;
					
					select max(b.nr_prescricao),
						   max(b.cd_material),
						   substr(max(obter_desc_material(b.cd_material)), 1, 255),
						   max(b.qt_dose), 
						   max(b.cd_unidade_medida_dose), 
						   max(b.ie_via_aplicacao),
						   max(b.cd_intervalo), 
						   max(b.ie_se_necessario), 
						   max(b.ie_acm), 
						   max(b.ie_urgencia), 
						   max(b.ds_dose_diferenciada)
					  into STRICT nr_prescricao_orig_w,
					  	   cd_material_orig_w,
						   ds_material_orig_w,
						   qt_dose_orig_w,
						   cd_un_medida_dose_orig_w,
						   ie_via_aplicacao_orig_w,
						   cd_intervalo_orig_w,
						   ie_se_necessario_orig_w,
						   ie_acm_orig_w,
						   ie_urgencia_orig_w,
						   ds_dose_dif_orig_w
					from	prescr_medica a,
							prescr_material b
					where	b.nr_prescricao = CASE WHEN 	nr_prescr_anterior_w=0 THEN  nr_prescricao_anterior_w  ELSE nr_prescr_anterior_w END 
					and		a.nr_prescricao = b.nr_prescricao
					and		b.cd_material = cd_material_nov_w;
					
					if (nr_prescricao_orig_w > 0) then
						ie_tipo_item_w := 1;
					end if;

					select nextval('w_dif_prescr_temp_seq')
					  into STRICT nr_sequencia_w
					;	
					
					insert
					  into w_dif_prescr_temp(nr_sequencia,
					  						  nr_prescricao,	
											  nr_prescricao_nov,
											  cd_material_nov,
											  ds_material_nov,
											  qt_dose_nov,
											  cd_un_medida_dose_nov,
											  ie_via_aplicacao_nov,
											  cd_intervalo_nov,
											  ie_se_necessario_nov,
											  ie_acm_nov,
											  ie_urgencia_nov,
											  ds_dose_dif_nov,
											  nr_prescricao_orig,
											  cd_material_orig,
											  ds_material_orig,
											  qt_dose_orig,
											  cd_un_medida_dose_orig,
											  ie_via_aplicacao_orig,
											  cd_intervalo_orig,
											  ie_se_necessario_orig,
											  ie_acm_orig,
											  ie_urgencia_orig,
											  ds_dose_dif_orig,
											  ie_tipo_item)
					values (nr_sequencia_w,
							nr_prescricao_p,
							nr_prescricao_p,
							cd_material_nov_w,
							ds_material_nov_w,
							qt_dose_nov_w,
							cd_un_medida_dose_nov_w,
							ie_via_aplicacao_nov_w,
							cd_intervalo_nov_w,
							ie_se_necessario_nov_w,
							ie_acm_nov_w,
							ie_urgencia_nov_w,
							ds_dose_dif_nov_w,
							nr_prescricao_orig_w,
							cd_material_orig_w,
							ds_material_orig_w,
							qt_dose_orig_w,
							cd_un_medida_dose_orig_w,
							ie_via_aplicacao_orig_w,
							cd_intervalo_orig_w,
							ie_se_necessario_orig_w,
							ie_acm_orig_w,
							ie_urgencia_orig_w,
							ds_dose_dif_orig_w,
							ie_tipo_item_w);					
			end loop;
		close c01;
		
		open c02;
			loop
				fetch c02 into								
					nr_prescr_anterior_w;
				EXIT WHEN NOT FOUND; /* apply on c02 */		
				
					open c03;
						loop
							fetch c03 into	
								cd_material_orig_w,							
								ds_material_orig_w,
								qt_dose_orig_w,
								cd_un_medida_dose_orig_w,
								ie_via_aplicacao_orig_w,
								cd_intervalo_orig_w,
								ie_se_necessario_orig_w,
								ie_acm_orig_w,
								ie_urgencia_orig_w,
								ds_dose_dif_orig_w;
							EXIT WHEN NOT FOUND; /* apply on c03 */	
							
								ie_tipo_item_w := 2;						

								select nextval('w_dif_prescr_temp_seq')
  				  				  into STRICT nr_sequencia_w
					  			;	
		
								insert
								  into w_dif_prescr_temp(nr_sequencia,
								  						  nr_prescricao,	
														  nr_prescricao_nov,
														  cd_material_nov,
														  ds_material_nov,
														  qt_dose_nov,
														  cd_un_medida_dose_nov,
														  ie_via_aplicacao_nov,
														  cd_intervalo_nov,
														  ie_se_necessario_nov,
														  ie_acm_nov,
														  ie_urgencia_nov,
														  ds_dose_dif_nov,
														  nr_prescricao_orig,
														  cd_material_orig,
														  ds_material_orig,
														  qt_dose_orig,
														  cd_un_medida_dose_orig,
														  ie_via_aplicacao_orig,
														  cd_intervalo_orig,
														  ie_se_necessario_orig,
														  ie_acm_orig,
														  ie_urgencia_orig,
														  ds_dose_dif_orig,
														  ie_tipo_item)
								values (nr_sequencia_w,
										nr_prescricao_p,
										null,
										null,
										null,
										null,
										null,
										null,
										null,
										null,
										null,
										null,
										null,
										nr_prescr_anterior_w,
										cd_material_orig_w,
										ds_material_orig_w,
										qt_dose_orig_w,
										cd_un_medida_dose_orig_w,
										ie_via_aplicacao_orig_w,
										cd_intervalo_orig_w,
										ie_se_necessario_orig_w,
										ie_acm_orig_w,
										ie_urgencia_orig_w,
										ds_dose_dif_orig_w,
										ie_tipo_item_w);														
						end loop;	
					close c03;
			end loop;
		close c02;		
	end if;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_dif_copia_prescr (nr_prescricao_p prescr_material.nr_prescricao%type) FROM PUBLIC;

