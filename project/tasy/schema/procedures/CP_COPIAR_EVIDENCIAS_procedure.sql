-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE cp_copiar_evidencias ( cd_perfil_p bigint, nr_atendimento_p bigint, cd_pessoa_fisica_p bigint, nr_seq_prescr_p bigint, nm_usuario_p text) AS $body$
DECLARE


  ora2pg_rowcount int;
nr_avaliacao_anterior_w bigint;
  nr_seq_modelo_w      bigint;


BEGIN

  SELECT * FROM obter_info_avaliacao_anterior(cd_perfil_p, nr_atendimento_p, cd_pessoa_fisica_p, nm_usuario_p, nr_seq_prescr_p, nr_avaliacao_anterior_w, nr_seq_modelo_w) INTO STRICT nr_avaliacao_anterior_w, nr_seq_modelo_w;

  IF nr_avaliacao_anterior_w > 0 THEN
    BEGIN
      INSERT
      INTO pe_prescr_item_result(
          NR_SEQUENCIA,
          DT_ATUALIZACAO,
          NM_USUARIO,
          NR_SEQ_ITEM,
          NR_SEQ_RESULT,
          NR_SEQ_PRESCR,
          DT_ATUALIZACAO_NREC,
          NM_USUARIO_NREC,
          NR_SEQ_TOPOGRAFIA,
          IE_LADO,
          qt_ponto
        )
      SELECT nextval('pe_prescr_item_result_seq'),
        clock_timestamp(),
        nm_usuario_p,
        nr_seq_item,
        nr_seq_result,
        nr_seq_prescr_p,
        dt_atualizacao,
        nm_usuario,
        nr_seq_topografia,
        ie_lado,
        qt_ponto
      FROM pe_prescr_item_result
      WHERE nr_seq_prescr = nr_avaliacao_anterior_w
      AND nr_seq_item
      NOT IN (SELECT nr_seq_item
       FROM pe_prescr_item_result
       WHERE nr_seq_prescr = nr_seq_prescr_p);

      GET DIAGNOSTICS ora2pg_rowcount = ROW_COUNT;


      -- traceability
      IF ( ora2pg_rowcount > 0) THEN
        UPDATE pe_prescricao
        SET nr_seq_prev_prescr = nr_avaliacao_anterior_w
        WHERE nr_sequencia = nr_seq_prescr_p;
      END IF;

      COMMIT;
    END;
  END IF;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cp_copiar_evidencias ( cd_perfil_p bigint, nr_atendimento_p bigint, cd_pessoa_fisica_p bigint, nr_seq_prescr_p bigint, nm_usuario_p text) FROM PUBLIC;

