-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pcs_gerar_view_pcs_lista ( cd_estabelecimento_p bigint, nr_seq_registro_p bigint, ie_possui_solic_p text, ie_possui_emprestimo_p text, ie_possui_transf_p text, cd_atributo_filtro_p text default null, vl_de_p bigint default 0, vl_ate_p bigint default 0) AS $body$
DECLARE



ds_comando_w			varchar(32000) := '';
ds_sql_where_w			varchar(4000);
nm_informacao_w			varchar(255);
vl_informacao_w			varchar(255);
cd_material_w			integer;
ds_comando1_w			varchar(4000);
ds_comando2_w			varchar(4000);
ds_comando3_w			varchar(4000);
qt_tamanho_w			bigint;
ds_material_w			varchar(255);
nr_ordenacao_w			integer;
nr_seq_reg_analise_w		bigint;
nr_reg_analise_item_w		bigint;
ie_status_analise_w		varchar(50);
nr_solic_compra_w		bigint;
nr_ordem_compra_w		bigint;
nr_emprestimo_w			bigint;

i integer := 0;

C01 CURSOR FOR
	SELECT	distinct b.cd_material,
		ie_status_analise,
		b.nr_solic_compra,
		b.nr_ordem_compra,
		b.nr_emprestimo
	from	pcs_reg_analise a,
			pcs_reg_analise_itens b
	where	a.nr_sequencia = b.nr_seq_registro
	and		a.nr_sequencia = nr_seq_registro_p
	and	((((b.nr_solic_compra IS NOT NULL AND b.nr_solic_compra::text <> '') and ie_possui_solic_p = 'S')
	or ((b.nr_emprestimo IS NOT NULL AND b.nr_emprestimo::text <> '') and ie_possui_emprestimo_p = 'S')
	or ((b.nr_ordem_compra IS NOT NULL AND b.nr_ordem_compra::text <> '') and ie_possui_transf_p = 'S'))
	or (ie_possui_solic_p = 'N') and (ie_possui_transf_p = 'N') and (ie_possui_emprestimo_p = 'N'))
	and	((coalesce(cd_atributo_filtro_p::text, '') = '') or ((cd_atributo_filtro_p = nm_informacao) and (CASE WHEN vl_informacao='null' THEN '0'  ELSE vl_informacao END  >= vl_de_p) and (CASE WHEN vl_informacao='null' THEN '0'  ELSE vl_informacao END  <= vl_ate_p)));

C02 CURSOR FOR
	SELECT	nm_informacao,
			vl_informacao,
			nr_ordenacao
	from	pcs_reg_analise a,
		pcs_reg_analise_itens b
	where	a.nr_sequencia = b.nr_seq_registro
	and	b.cd_material = cd_material_w
	and	a.nr_sequencia = nr_seq_registro_p
	order by nr_ordenacao;


BEGIN
ds_comando_w := null;
CALL Exec_sql_Dinamico('Tasy', 'drop view pcs_analise_colunas_v');
ds_comando_w	:= 'create or replace view pcs_analise_colunas_v as ';

open C01;
loop
fetch C01 into
	cd_material_w,
	ie_status_analise_w,
	nr_solic_compra_w,
	nr_ordem_compra_w,
	nr_emprestimo_w;
	--nr_reg_analise_item_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin

	ds_comando_w	:= ds_comando_w || ' select ';

	open C02;
	loop
	fetch C02 into
		nm_informacao_w,
		vl_informacao_w,
		nr_ordenacao_w;
	EXIT WHEN NOT FOUND; /* apply on C02 */
		begin
		i := i + 1;
		--ds_comando_w := ds_comando_w || ' ' || chr(39) || vl_informacao_w || chr(39) || ' ' || nm_informacao_w || i || ',';
		ds_comando_w := ds_comando_w || ' ' || chr(39) || vl_informacao_w || chr(39) || ' ' || nm_informacao_w || ',';

		end;
	end loop;
	close C02;

	ds_comando_w := ds_comando_w || ' ' || chr(39) || nr_seq_registro_p || chr(39) || ' ' || 'NR_SEQ_REGISTRO,';
	ds_comando_w := ds_comando_w || ' ' || chr(39) || ie_status_analise_w || chr(39) || ' ' || 'IE_STATUS_ANALISE,';
	ds_comando_w := ds_comando_w || ' ' || chr(39) || nr_solic_compra_w || chr(39) || ' ' || 'NR_SOLIC_COMPRA,';
	ds_comando_w := ds_comando_w || ' ' || chr(39) || nr_ordem_compra_w || chr(39) || ' ' || 'NR_ORDEM_COMPRA,';
	ds_comando_w := ds_comando_w || ' ' || chr(39) || nr_emprestimo_w || chr(39) || ' ' || 'NR_EMPRESTIMO,';

--	ds_comando_w := ds_comando_w || ' ' || chr(39) || nr_reg_analise_item_w || chr(39) || ' ' || 'NR_SEQUENCIA,';
	qt_tamanho_w	:= length(ds_comando_w);
	ds_comando_w	:= substr(ds_comando_w,1,qt_tamanho_w -1);
	ds_comando_w	:= ds_comando_w || ' from dual union';
	end;
end loop;
close C01;

qt_tamanho_w 	:= length(ds_comando_w);
ds_comando_w	:= trim(both substr(ds_comando_w,1,qt_tamanho_w -5));

/*ds_comando_w := 'create or replace view pcs_analise_colunas_v as
 select  ''1'' CD_ESTAB1, ''44'' CD_MATERIAL2, ''Agulha Sutura B 204 Nº12'' DS_MATERIAL3, ''31'' DCB_MEDIC_CONTROLADO4, ''5'' UNITARIZACAO_LOCAL5 from dual
union
 select  ''1'' CD_ESTAB6, ''132'' CD_MATERIAL7, ''Paraplatin 150 Mg Inj.'' DS_MATERIAL8, ''31'' DCB_MEDIC_CONTROLADO9, ''5'' UNITARIZACAO_LOCAL10 from dual
union
 select  ''1'' CD_ESTAB11, ''39753'' CD_MATERIAL12, ''Luva Bronse 28mm'' DS_MATERIAL13, ''31'' DCB_MEDIC_CONTROLADO14, ''5'' UNITARIZACAO_LOCAL15 from dual
union
 select  ''1'' CD_ESTAB16, ''88'' CD_MATERIAL17, ''Genuxal 1 G Inj.'' DS_MATERIAL18, ''31'' DCB_MEDIC_CONTROLADO19, ''5'' UNITARIZACAO_LOCAL20 from dual
union
 select  ''1'' CD_ESTAB21, ''66'' CD_MATERIAL22, ''Aas 500mg Cp'' DS_MATERIAL23, ''31'' DCB_MEDIC_CONTROLADO24, ''5'' UNITARIZACAO_LOCAL25 from dual
union
 select  ''545'' CD_ESTAB26, ''35'' CD_MATERIAL27, ''Agulha Descartável 30 X 07'' DS_MATERIAL28, ''31'' DCB_MEDIC_CONTROLADO29, ''5'' UNITARIZACAO_LOCAL30 from dual
union
 select  ''1'' CD_ESTAB31, ''104'' CD_MATERIAL32, ''Ciclofosfamida 200 Mg Inj.'' DS_MATERIAL33, ''31'' DCB_MEDIC_CONTROLADO34, ''5'' UNITARIZACAO_LOCAL35 from dual
union
 select  ''1'' CD_ESTAB36, ''89'' CD_MATERIAL37, ''Ciclofosfamida 1 G Inj.'' DS_MATERIAL38, ''31'' DCB_MEDIC_CONTROLADO39, ''5'' UNITARIZACAO_LOCAL40 from dual
union
 select  ''1'' CD_ESTAB41, ''122'' CD_MATERIAL42, ''Luva Cirúrgica Nº 6,5 '' DS_MATERIAL43, ''31'' DCB_MEDIC_CONTROLADO44, ''5'' UNITARIZACAO_LOCAL45 from dual';

 /*ds_comando_w  := 'create or replace view pcs_analise_colunas_v as
 select  ''1'' CD_ESTAB1, ''44'' CD_MATERIAL2, ''Agulha Sutura B 204 Nº12'' DS_MATERIAL3, ''31'' DCB_MEDIC_CONTROLADO4, ''5'' UNITARIZACAO_LOCAL5 from dual union
 select  ''1'' CD_ESTAB6, ''132'' CD_MATERIAL7, ''Paraplatin 150 Mg Inj.'' DS_MATERIAL8, ''31'' DCB_MEDIC_CONTROLADO9, ''5'' UNITARIZACAO_LOCAL10 from dual union
 select  ''1'' CD_ESTAB11, ''39753'' CD_MATERIAL12, ''Luva Bronse 28mm'' DS_MATERIAL13, ''31'' DCB_MEDIC_CONTROLADO14, ''5'' UNITARIZACAO_LOCAL15 from dual union
 select  ''1'' CD_ESTAB16, ''88'' CD_MATERIAL17, ''Genuxal 1 G Inj.'' DS_MATERIAL18, ''31'' DCB_MEDIC_CONTROLADO19, ''5'' UNITARIZACAO_LOCAL20 from dual union
 select  ''1'' CD_ESTAB21, ''66'' CD_MATERIAL22, ''Aas 500mg Cp'' DS_MATERIAL23, ''31'' DCB_MEDIC_CONTROLADO24, ''5'' UNITARIZACAO_LOCAL25 from dual union
 select  ''545'' CD_ESTAB26, ''35'' CD_MATERIAL27, ''Agulha Descartável 30 X 07'' DS_MATERIAL28, ''31'' DCB_MEDIC_CONTROLADO29, ''5'' UNITARIZACAO_LOCAL30 from dual union
 select  ''1'' CD_ESTAB31, ''104'' CD_MATERIAL32, ''Ciclofosfamida 200 Mg Inj.'' DS_MATERIAL33, ''31'' DCB_MEDIC_CONTROLADO34, ''5'' UNITARIZACAO_LOCAL35 from dual union
 select  ''1'' CD_ESTAB36, ''89'' CD_MATERIAL37, ''Ciclofosfamida 1 G Inj.'' DS_MATERIAL38, ''31'' DCB_MEDIC_CONTROLADO39, ''5'' UNITARIZACAO_LOCAL40 from dual union
 select  ''1'' CD_ESTAB41, ''122'' CD_MATERIAL42, ''Luva Cirúrgica Nº 6,5 '' DS_MATERIAL43, ''31'' DCB_MEDIC_CONTROLADO44, ''5'' UNITARIZACAO_LOCAL45 from dual';*/
ds_comando1_w :=  substr(ds_comando_w,1,4000);
ds_comando2_w :=  substr(ds_comando_w,4001,4000);
ds_comando3_w :=  substr(ds_comando_w,8000,4000);

commit;

CALL exec_sql_dinamico('TASY',ds_comando_w);

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pcs_gerar_view_pcs_lista ( cd_estabelecimento_p bigint, nr_seq_registro_p bigint, ie_possui_solic_p text, ie_possui_emprestimo_p text, ie_possui_transf_p text, cd_atributo_filtro_p text default null, vl_de_p bigint default 0, vl_ate_p bigint default 0) FROM PUBLIC;

