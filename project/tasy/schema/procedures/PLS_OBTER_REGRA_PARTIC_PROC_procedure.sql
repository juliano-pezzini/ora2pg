-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_obter_regra_partic_proc ( nr_seq_conta_proc_p bigint, cd_procedimento_p bigint, ie_origem_proced_p bigint, cd_estabelecimento_p bigint, nr_seq_grau_part_p bigint, ie_tipo_part_regra_p INOUT text, ie_comp_pacote_p text, ie_diaria_p text ) AS $body$
DECLARE


/* ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Finalidade: Obter regras de participação cadastradas na função OPS - Faturamento > Cadastros > Conversão tipo participação PTU > Procedimento
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

Locais de chamada direta: 
[ X]  Objetos do dicionário [ ] Tasy (Delphi/Java) [  ] Portal [  ]  Relatórios [ ] Outros:
 -----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

Pontos de atenção: 		UTILIZADA NA ROTINA 'PLS_GERAR_PTU_NOTA_SERVICO'
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */
cd_area_procedimento_w		bigint;
cd_especialidade_w		bigint;
cd_grupo_proc_w			bigint;
ie_origem_proced_w		bigint;
nr_seq_grupo_rec_w		procedimento.nr_seq_grupo_rec%type;
ie_tipo_guia_w			pls_conta.ie_tipo_guia%type;
nr_seq_prestador_w		pls_conta.nr_seq_prestador%type;
nr_seq_prestador_exec_w		pls_conta.nr_seq_prestador_exec%type;
ie_via_acesso_w			pls_conta_proc.ie_via_acesso%type;
ie_tipo_despesa_w		pls_conta_proc.ie_tipo_despesa%type;
nr_seq_congenere_w		pls_protocolo_conta.nr_seq_congenere%type;
nr_seq_grupo_servico_w		pls_regra_tp_part_ptu_proc.nr_seq_grupo_servico%type;
ie_tipo_part_regra_w		pls_regra_tp_part_ptu_proc.ie_tipo_participacao%type;
ie_estrutura_w			pls_preco_servico.ie_estrutura%type;

C01 CURSOR FOR
	SELECT	ie_tipo_participacao,
		nr_seq_grupo_servico,
		nr_seq_congenere,
		cd_area_procedimento,
		cd_especialidade,
		cd_grupo_proc,
		cd_procedimento,
		nr_seq_prestador,
		nr_seq_grupo_rec,
		ie_via_acesso,
		ie_tipo_guia,
		ie_tipo_despesa,
		nr_seq_grau_partic,
		dt_inicio_vigencia,
		dt_fim_vigencia
	from(
	SELECT	ie_tipo_participacao,
		nr_seq_grupo_servico,
		nr_seq_congenere,
		cd_area_procedimento,
		cd_especialidade,
		cd_grupo_proc,
		cd_procedimento,
		nr_seq_prestador,
		nr_seq_grupo_rec,
		ie_via_acesso,
		ie_tipo_guia,
		ie_tipo_despesa,
		nr_seq_grau_partic,
		dt_inicio_vigencia,
		dt_fim_vigencia,
		ie_comp_pacote,
		ie_diaria
	from	pls_regra_tp_part_ptu_proc
	where	((coalesce(nr_seq_congenere::text, '') = '') or (nr_seq_congenere		= nr_seq_congenere_w))
	and	((coalesce(cd_area_procedimento::text, '') = '') or (cd_area_procedimento 	= cd_area_procedimento_w))
	and	((coalesce(cd_especialidade::text, '') = '') or (cd_especialidade		= cd_especialidade_w))
	and	((coalesce(cd_grupo_proc::text, '') = '') or (cd_grupo_proc		= cd_grupo_proc_w))
	and	cd_procedimento		= cd_procedimento_p
	and 	ie_origem_proced 	= ie_origem_proced_w
	and	((coalesce(nr_seq_prestador::text, '') = '') or (nr_seq_prestador		= nr_seq_prestador_w))
	and	((coalesce(nr_seq_prestador_exec::text, '') = '') or (nr_seq_prestador_exec	= nr_seq_prestador_exec_w))
	and	((coalesce(nr_seq_grupo_rec::text, '') = '') or (nr_seq_grupo_rec		= nr_seq_grupo_rec_w))
	and	((coalesce(ie_via_acesso::text, '') = '') or (ie_via_acesso		= ie_via_acesso_w))
	and	((coalesce(ie_tipo_guia::text, '') = '') or (ie_tipo_guia		= ie_tipo_guia_w))
	and	((coalesce(ie_tipo_despesa::text, '') = '') or (ie_tipo_despesa		= ie_tipo_despesa_w))
	and	((coalesce(nr_seq_grau_partic::text, '') = '') or (nr_seq_grau_partic		= nr_seq_grau_part_p))
	and (ie_comp_pacote		= ie_comp_pacote_p)
	and	((ie_diaria		= 'A')	 or (ie_diaria			= ie_diaria_p))
	and	dt_inicio_vigencia <= clock_timestamp()
	and	((dt_fim_vigencia >= clock_timestamp()) or (coalesce(dt_fim_vigencia::text, '') = ''))
	
union all

	select	ie_tipo_participacao,
		nr_seq_grupo_servico,
		nr_seq_congenere,
		cd_area_procedimento,
		cd_especialidade,
		cd_grupo_proc,
		cd_procedimento,
		nr_seq_prestador,
		nr_seq_grupo_rec,
		ie_via_acesso,
		ie_tipo_guia,
		ie_tipo_despesa,
		nr_seq_grau_partic,
		dt_inicio_vigencia,
		dt_fim_vigencia,
		ie_comp_pacote,
		ie_diaria
	from	pls_regra_tp_part_ptu_proc
	where	((coalesce(nr_seq_congenere::text, '') = '') or (nr_seq_congenere		= nr_seq_congenere_w))
	and	((coalesce(cd_area_procedimento::text, '') = '') or (cd_area_procedimento 	= cd_area_procedimento_w))
	and	((coalesce(cd_especialidade::text, '') = '') or (cd_especialidade		= cd_especialidade_w))
	and	((coalesce(cd_grupo_proc::text, '') = '') or (cd_grupo_proc		= cd_grupo_proc_w))
	and	coalesce(cd_procedimento::text, '') = ''
	and	((coalesce(nr_seq_prestador::text, '') = '') or (nr_seq_prestador		= nr_seq_prestador_w))
	and	((coalesce(nr_seq_prestador_exec::text, '') = '') or (nr_seq_prestador_exec	= nr_seq_prestador_exec_w))
	and	((coalesce(nr_seq_grupo_rec::text, '') = '') or (nr_seq_grupo_rec		= nr_seq_grupo_rec_w))
	and	((coalesce(ie_via_acesso::text, '') = '') or (ie_via_acesso		= ie_via_acesso_w))
	and	((coalesce(ie_tipo_guia::text, '') = '') or (ie_tipo_guia		= ie_tipo_guia_w))
	and	((coalesce(ie_tipo_despesa::text, '') = '') or (ie_tipo_despesa		= ie_tipo_despesa_w))
	and	((coalesce(nr_seq_grau_partic::text, '') = '') or (nr_seq_grau_partic		= nr_seq_grau_part_p))
	and (ie_comp_pacote		= ie_comp_pacote_p)
	and	((ie_diaria		= 'A')	 or (ie_diaria			= ie_diaria_p))
	and	dt_inicio_vigencia <= clock_timestamp()
	and	((dt_fim_vigencia >= clock_timestamp()) or (coalesce(dt_fim_vigencia::text, '') = '')))
	order by 	coalesce(nr_seq_congenere,0),
			coalesce(cd_area_procedimento,0),
			coalesce(cd_especialidade,0),
			coalesce(cd_grupo_proc,0),
			coalesce(cd_procedimento,0),
			coalesce(nr_seq_prestador,0),
			coalesce(nr_seq_grupo_rec,0),
			coalesce(ie_via_acesso,0),
			coalesce(ie_tipo_guia,0),
			coalesce(ie_tipo_despesa,0),
			coalesce(nr_seq_grupo_servico,0),
			coalesce(nr_seq_grau_partic,0),
			coalesce(ie_diaria,'A');
	
BEGIN
SELECT * FROM pls_obter_estrut_proc(	cd_procedimento_p, ie_origem_proced_p, cd_area_procedimento_w, cd_especialidade_w, cd_grupo_proc_w, ie_origem_proced_w) INTO STRICT cd_area_procedimento_w, cd_especialidade_w, cd_grupo_proc_w, ie_origem_proced_w;

select	max(c.ie_via_acesso),
	max(b.ie_tipo_guia),
	max(c.ie_tipo_despesa),
	max(d.nr_seq_grupo_rec),
	max(b.nr_seq_prestador),
	max(b.nr_seq_prestador_exec),
	max(a.nr_seq_congenere)
into STRICT	ie_via_acesso_w,
	ie_tipo_guia_w,
	ie_tipo_despesa_w,
	nr_seq_grupo_rec_w,
	nr_seq_prestador_w,
	nr_seq_prestador_exec_w,
	nr_seq_congenere_w
from	procedimento		d,
	pls_conta_proc		c,
	pls_conta		b,
	pls_protocolo_conta	a
where	a.nr_sequencia		= b.nr_seq_protocolo
and	b.nr_sequencia		= c.nr_seq_conta
and	c.cd_procedimento	= d.cd_procedimento
and	c.ie_origem_proced	= d.ie_origem_proced
and	c.nr_sequencia		= nr_seq_conta_proc_p;

for r_c01_w in C01() loop
	begin
	ie_tipo_part_regra_w	:= r_c01_w.ie_tipo_participacao;
	nr_seq_grupo_servico_w	:= r_c01_w.nr_seq_grupo_servico;
		
	ie_estrutura_w := 'S';
	
	if (nr_seq_grupo_servico_w IS NOT NULL AND nr_seq_grupo_servico_w::text <> '') then
		ie_estrutura_w := pls_se_grupo_preco_servico( nr_seq_grupo_servico_w, cd_procedimento_p, coalesce(ie_origem_proced_w,ie_origem_proced_p));
	end if;
	
	if (coalesce(trim(both ie_estrutura_w),'N') = 'S') then
		ie_tipo_part_regra_p := ie_tipo_part_regra_w;
	end if;		
	end;
end loop;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_obter_regra_partic_proc ( nr_seq_conta_proc_p bigint, cd_procedimento_p bigint, ie_origem_proced_p bigint, cd_estabelecimento_p bigint, nr_seq_grau_part_p bigint, ie_tipo_part_regra_p INOUT text, ie_comp_pacote_p text, ie_diaria_p text ) FROM PUBLIC;

