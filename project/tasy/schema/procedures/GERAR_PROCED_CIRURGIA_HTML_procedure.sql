-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_proced_cirurgia_html (nr_cirurgia_p bigint, nr_prescricao_p bigint, ie_import_proced_p text, cd_local_estoque_p bigint default null, cd_motivo_alta_p INOUT bigint DEFAULT NULL, ie_gerar_alta_p INOUT text DEFAULT NULL, ds_mensagem_p INOUT text DEFAULT NULL) AS $body$
DECLARE

												
cd_estabelecimento_w		integer;
cd_perfil_w					integer;
nm_usuario_w				varchar(15);

ie_set_via_princ_w			varchar(15);
ie_gera_particip_proc_w		varchar(15);
ie_alta_exec_proc_w			varchar(15);
ie_msg_relizar_proced_w		varchar(250);

nr_atendimento_w			bigint;
cd_setor_atendimento_w		integer;
cd_motivo_alta_w			integer;
ie_gerar_alta_w				varchar(15);
ds_erro_alta_w				varchar(250);


BEGIN

cd_estabelecimento_w	:= wheb_usuario_pck.get_cd_estabelecimento;
cd_perfil_w				:= wheb_usuario_pck.get_cd_perfil;
nm_usuario_w			:= wheb_usuario_pck.get_nm_usuario;

ie_set_via_princ_w := Obter_Param_Usuario(900, 168, cd_perfil_w, nm_usuario_w, cd_estabelecimento_w, ie_set_via_princ_w);
ie_gera_particip_proc_w := Obter_Param_Usuario(900, 215, cd_perfil_w, nm_usuario_w, cd_estabelecimento_w, ie_gera_particip_proc_w);
ie_alta_exec_proc_w := Obter_Param_Usuario(900, 114, cd_perfil_w, nm_usuario_w, cd_estabelecimento_w, ie_alta_exec_proc_w);
ie_msg_relizar_proced_w := obter_param_usuario(900, 212, cd_perfil_w, nm_usuario_w, cd_estabelecimento_w, ie_msg_relizar_proced_w);

select	max(nr_atendimento),
		max(obter_unid_setor_cirurgia(nr_cirurgia_p,'C'))	
into STRICT	nr_atendimento_w,
		cd_setor_atendimento_w	
from	cirurgia
where	nr_cirurgia = nr_cirurgia_p;

if (ie_import_proced_p = 'S') then
	CALL inserir_proc_autorizado(nr_cirurgia_p, nr_prescricao_p, nm_usuario_w);
end if;

CALL realizar_proc_previstos(nr_cirurgia_p, nr_prescricao_p, nm_usuario_w, 'S');

CALL executar_taxa_equipamento(nr_cirurgia_p, nm_usuario_w);

CALL executar_material_equipamento(nr_cirurgia_p, cd_local_estoque_p, nm_usuario_w);

if (ie_set_via_princ_w = 'S') then
	CALL seta_via_princ_proc_maior_vl(nr_cirurgia_p);	
end if;

if (ie_gera_particip_proc_w = 'S') then
	CALL gerar_particip_proc(nr_cirurgia_p, nm_usuario_w);
end if;

if (ie_alta_exec_proc_w = 'S') then
	SELECT * FROM gerar_regra_alta_exec_proc(nr_atendimento_w, nr_prescricao_p, cd_setor_atendimento_w, nm_usuario_w, cd_motivo_alta_w, ie_gerar_alta_w) INTO STRICT cd_motivo_alta_w, ie_gerar_alta_w;				
end if;

if (ie_msg_relizar_proced_w IS NOT NULL AND ie_msg_relizar_proced_w::text <> '') then
	ds_mensagem_p := substr(obter_texto_tasy(54367, wheb_usuario_pck.get_nr_seq_idioma),1,255) || ' ' || ie_msg_relizar_proced_w;
else	
	ds_mensagem_p := substr(obter_texto_tasy(54367, wheb_usuario_pck.get_nr_seq_idioma),1,255);	
end if;

cd_motivo_alta_p	:= cd_motivo_alta_w;
ie_gerar_alta_p		:= ie_gerar_alta_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_proced_cirurgia_html (nr_cirurgia_p bigint, nr_prescricao_p bigint, ie_import_proced_p text, cd_local_estoque_p bigint default null, cd_motivo_alta_p INOUT bigint DEFAULT NULL, ie_gerar_alta_p INOUT text DEFAULT NULL, ds_mensagem_p INOUT text DEFAULT NULL) FROM PUBLIC;

