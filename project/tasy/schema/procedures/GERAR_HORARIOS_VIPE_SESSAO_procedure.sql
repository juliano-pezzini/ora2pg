-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';



CREATE TYPE horarios AS (horario_w varchar(255));


CREATE OR REPLACE PROCEDURE gerar_horarios_vipe_sessao ( cd_estabelecimento_p bigint, cd_setor_usuario_p bigint, cd_perfil_p bigint, ie_aba_p text, nm_usuario_p text, nr_atendimento_p bigint, nr_seq_dialise_p bigint, qt_horas_anteriores_p bigint, qt_horas_adicionais_p bigint, qt_horas_vigencia_p bigint, dt_referencia_p timestamp, ie_exibir_hor_realizados_p text, ie_exibir_hor_suspensos_p text, ie_so_proc_setor_usuario_p text, ie_so_interv_setor_usuario_p text, ie_solucoes_continuas_p text, cd_setor_paciente_p bigint) AS $body$
DECLARE


ie_data_lib_prescr_w		varchar(15);
ie_agrupar_acm_sn_w		varchar(15);
ie_exibir_suspensos_w		varchar(15);
ie_agrupar_dose_esp_w		varchar(15);
ie_obs_diferenciar_w		varchar(15);
ie_data_lib_proced_w		varchar(15);
ie_horarios_dietas_orais_w	varchar(15);
ie_mat_med_proc_gestao_w	varchar(15);
ie_diluicao_acm_sn_gestao_w	varchar(15);
ie_agrupar_associados_w		varchar(15);
ie_lib_pend_rep_w		varchar(15);
ie_mostrar_subs_w		varchar(15);
ie_gerar_horarios_glic_w	varchar(1);
ie_exibir_dil_ccg_w		varchar(1);
ie_exibe_sem_lib_farm_w		varchar(1);
cd_setor_usuario_w		integer;
cd_perfil_w			bigint;
dt_validade_limite_w		timestamp;
dt_inicial_horarios_w		timestamp;
dt_final_horarios_w		timestamp;
ie_exibe_dietas_w		varchar(1);
ie_prescr_setor_atual_w		varchar(1);
ie_formato_solucoes_w		varchar(15);
nr_regra_ordem_w		bigint;

ie_regra_incl_dieta_oral_w	varchar(15)	:= 'S';
ie_regra_incl_supl_oral_w	varchar(15)	:= 'S';
ie_regra_incl_solucao_w		varchar(15)	:= 'S';
ie_regra_incl_medicamento_w	varchar(15)	:= 'S';
ie_regra_incl_material_w	varchar(15)	:= 'R';
ie_regra_incl_procedimento_w	varchar(15)	:= 'S';
ie_regra_incl_coleta_w		varchar(15)	:= 'S';
ie_regra_incl_ccg_w		varchar(15)	:= 'S';
ie_regra_incl_cig_w		varchar(15)	:= 'S';
ie_regra_incl_recomendacao_w	varchar(15)	:= 'S';
ie_regra_incl_intervencao_w	varchar(15)	:= 'S';
ie_regra_incl_ivc_w		varchar(15)	:= 'N';
ie_regra_incl_gas_w		varchar(15)	:= 'N';
ie_regra_incl_hemoterapia_w	varchar(15)	:= 'N';
ie_regra_incl_jejum_w		varchar(15)	:= 'S';
ie_regra_incl_sne_w		varchar(15)	:= 'N';
ie_regra_incl_npt_adulta_w	varchar(15)	:= 'N';
ie_regra_incl_npt_neonatal_w	varchar(15)	:= 'N';
ie_regra_incl_ordem_medica_w	varchar(15)	:= 'N';

dt_horario_w			timestamp;
type vetor is table of horarios index by integer;
vetor_w				vetor;
i				integer		:= 0;
j				integer		:= 0;
k				integer		:= 0;

nr_seq_wadep_w			bigint;

c01 CURSOR FOR
SELECT	coalesce(ie_dieta_oral,'S'),
	coalesce(ie_suplemento_oral,'S'),
	coalesce(ie_solucao,'S'),
	coalesce(ie_medicamento,'S'),
	coalesce(ie_material,'R'),
	coalesce(ie_procedimento,'S'),
	coalesce(ie_coleta,'S'),
	coalesce(ie_ccg,'S'),
	coalesce(ie_cig,'S'),
	coalesce(ie_recomendacao,'S'),
	coalesce(ie_sae,'S'),
	coalesce(ie_ivc,'N'),
	coalesce(ie_oxigenio,'N'),
	coalesce(ie_hemoterapia,'N'),
	coalesce(ie_sup_nutricional,'N'),
	coalesce(ie_npt_adulta,'N'),
	coalesce(ie_npt_neonatal,'N')
from	adep_regra_inclusao
where	cd_estabelecimento				= cd_estabelecimento_p
and	coalesce(cd_setor_atendimento,cd_setor_usuario_w)	= cd_setor_usuario_w
and	coalesce(cd_perfil,cd_perfil_w)			= cd_perfil_w
order by
	coalesce(cd_setor_atendimento,99999) desc,
	coalesce(cd_perfil,99999) desc,
	nr_sequencia;

c02 CURSOR FOR
SELECT	dt_horario
from	w_vipe_horarios_t
where	nm_usuario = nm_usuario_p
group by
	dt_horario
order by
	dt_horario;


BEGIN
CALL vipe_liberar_sessao(nm_usuario_p);

CALL vipe_gerar_horarios_pck.gerar_horarios_vipe(
		cd_estabelecimento_p,
		cd_setor_usuario_p,
		cd_perfil_p,
		ie_aba_p,
		nm_usuario_p,
		nr_atendimento_p,
		nr_seq_dialise_p,
		qt_horas_anteriores_p,
		qt_horas_adicionais_p,
		qt_horas_vigencia_p,
		dt_referencia_p,
		ie_exibir_hor_realizados_p,
		ie_exibir_hor_suspensos_p,
		ie_so_proc_setor_usuario_p,
		ie_so_interv_setor_usuario_p,
		ie_solucoes_continuas_p,
		cd_setor_paciente_p);

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_horarios_vipe_sessao ( cd_estabelecimento_p bigint, cd_setor_usuario_p bigint, cd_perfil_p bigint, ie_aba_p text, nm_usuario_p text, nr_atendimento_p bigint, nr_seq_dialise_p bigint, qt_horas_anteriores_p bigint, qt_horas_adicionais_p bigint, qt_horas_vigencia_p bigint, dt_referencia_p timestamp, ie_exibir_hor_realizados_p text, ie_exibir_hor_suspensos_p text, ie_so_proc_setor_usuario_p text, ie_so_interv_setor_usuario_p text, ie_solucoes_continuas_p text, cd_setor_paciente_p bigint) FROM PUBLIC;

