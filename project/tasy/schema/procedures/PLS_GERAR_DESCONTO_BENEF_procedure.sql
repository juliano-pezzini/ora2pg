-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_gerar_desconto_benef ( nr_seq_segurado_p bigint, nr_seq_contrato_p bigint, nm_usuario_p text, vl_preco_atual_p bigint, vl_desconto_p INOUT bigint, nr_seq_regra_p INOUT bigint) AS $body$
DECLARE


/* UTILIZAR A ROTINA PLS_GERAR_DESC_BENEFICIARIO - Felipe - 27/01/2009 */

qt_registro_contrato_w		bigint;
nr_seq_segurado_w		bigint;
nr_seq_titular_w		bigint;
nr_seq_parentesco_w		bigint;
ie_tipo_parentesco_w		varchar(5);
tx_desconto_w			double precision;
vl_desconto_w			double precision;
nr_seq_regra_desc_w		bigint;
qt_dependentes_w		bigint;
ie_tipo_regra_w			varchar(1);
qt_min_vidas_w			bigint;
qt_max_vidas_w			bigint;
qt_vidas_contrato_w		bigint;
nr_seq_regra_desc_ww		bigint;
vl_desconto_regra_w		double precision;

/* ie_tipo_parentesco_w
1 - dependente legal
2 - Agregado */
C01 CURSOR FOR
	SELECT 	a.tx_desconto,
		b.nr_sequencia,
		ie_tipo_regra,
		qt_min_vidas,
		qt_max_vidas,
		a.vl_desconto
	from	pls_preco_regra a,
		pls_regra_desconto b
	where	a.nr_seq_regra = b.nr_sequencia
	and	ie_situacao = 'A'
	and	clock_timestamp() <= coalesce(dt_fim_vigencia,clock_timestamp())
	and	b.nr_seq_contrato = nr_seq_contrato_p;


BEGIN

qt_dependentes_w	:= 0;
tx_desconto_w		:= 0;

select	max(nr_sequencia),
	max(nr_seq_titular),
	max(nr_seq_parentesco)
into STRICT	nr_seq_segurado_w,
	nr_seq_titular_w,
	nr_seq_parentesco_w
from	pls_segurado
where	nr_sequencia	= nr_seq_segurado_p;

open C01;
loop
fetch C01 into
	tx_desconto_w,
	nr_seq_regra_desc_w,
	ie_tipo_regra_w,
	qt_min_vidas_w,
	qt_max_vidas_w,
	vl_desconto_regra_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	if (ie_tipo_regra_w = 'T') then
		select	count(*)
		into STRICT	qt_vidas_contrato_w
		from	pls_segurado
		where	nr_seq_contrato	= nr_seq_contrato_p
		and	(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
		and	coalesce(dt_rescisao::text, '') = '';

		if (qt_vidas_contrato_w >= qt_min_vidas_w) and (qt_vidas_contrato_w <= qt_max_vidas_w) then
			vl_desconto_w := (vl_preco_atual_p * (coalesce(tx_desconto_w,0) / 100)) + coalesce(vl_desconto_regra_w,0);
			nr_seq_regra_desc_ww := nr_seq_regra_desc_w;
		end if;
	else
		if (coalesce(nr_seq_titular_w::text, '') = '') then
			select 	count(*)
			into STRICT	qt_dependentes_w
			from	pls_segurado
			where	nr_seq_contrato = nr_seq_contrato_p
			and	nr_seq_titular = nr_seq_segurado_p
			and	(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
			and	coalesce(dt_rescisao::text, '') = '';
		end if;

		if (nr_seq_titular_w IS NOT NULL AND nr_seq_titular_w::text <> '') and (nr_seq_parentesco_w IS NOT NULL AND nr_seq_parentesco_w::text <> '') then
			select 	coalesce(max(ie_tipo_parentesco),'2')
			into STRICT	ie_tipo_parentesco_w
			from	grau_parentesco
			where	nr_sequencia = nr_seq_parentesco_w;

			select	count(*)
			into STRICT	qt_dependentes_w
			from	pls_segurado
			where	nr_seq_contrato = nr_seq_contrato_p
			and	nr_seq_titular = nr_seq_titular_w
			and	(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
			and	coalesce(dt_rescisao::text, '') = '';
		end if;

		qt_registro_contrato_w	:= (qt_dependentes_w + 1); /* Paulo - 25/06/2008 - +1 para contar o titular conforme mapeado com Adriano */
		if (qt_registro_contrato_w >= qt_min_vidas_w) and (qt_registro_contrato_w <= qt_max_vidas_w) then
			if 	(((ie_tipo_regra_w = 'I') and (coalesce(nr_seq_titular_w::text, '') = '')) or
				(ie_tipo_regra_w = 'L' AND ie_tipo_parentesco_w = '1') or
				((ie_tipo_regra_w = 'E') and ((ie_tipo_parentesco_w = '1') or ((coalesce(nr_seq_titular_w::text, '') = '') and (qt_dependentes_w > 0))))) then
				vl_desconto_w := (vl_preco_atual_p * (coalesce(tx_desconto_w,0) / 100)) + coalesce(vl_desconto_regra_w,0);
				nr_seq_regra_desc_ww := nr_seq_regra_desc_w;
			end if;
		end if;
	end if;
	end;
end loop;
close C01;

vl_desconto_p	:= vl_desconto_w;
nr_seq_regra_p	:= nr_seq_regra_desc_ww;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_gerar_desconto_benef ( nr_seq_segurado_p bigint, nr_seq_contrato_p bigint, nm_usuario_p text, vl_preco_atual_p bigint, vl_desconto_p INOUT bigint, nr_seq_regra_p INOUT bigint) FROM PUBLIC;

