-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_obter_arquivo_regra_ted (nr_seq_regra_p bigint, nr_seq_lote_p bigint, dt_referencia_p timestamp, ds_caminho_p INOUT text, nm_arquivo_p INOUT text, nm_objeto_p INOUT text) AS $body$
DECLARE


ie_utilizacao_w		varchar(3);
ds_caminho_w		varchar(255);
nm_arquivo_w		varchar(255);
nm_objeto_w		pls_regra_ted.nm_objeto%type;
dt_lote_w		timestamp;

/* IE_UTILIZACAO_w
M - Mensalidade
CT - Cobran√ßa terceirizada
*/
BEGIN

if (nr_seq_regra_p IS NOT NULL AND nr_seq_regra_p::text <> '') then
	select	a.ds_caminho_arquivo,
		a.nm_arquivo,
		a.ie_utilizacao,
		nm_objeto
	into STRICT	ds_caminho_w,
		nm_arquivo_w,
		ie_utilizacao_w,
		nm_objeto_w
	from	pls_regra_ted a
	where	a.nr_sequencia	= nr_seq_regra_p;

	if (ie_utilizacao_w = 'M') then
		select	max(a.dt_lote)
		into STRICT	dt_lote_w
		from	pls_lote_mensalidade_ted a
		where	a.nr_sequencia	= nr_seq_lote_p;
	elsif (ie_utilizacao_w = 'CT') then
		select	max(a.dt_remessa_retorno)
		into STRICT	dt_lote_w
		from	pls_lote_cob_terceiro a
		where	a.nr_sequencia = nr_seq_lote_p;
	elsif (ie_utilizacao_w = 'MB') then
		select	max(a.DT_REFERENCIA)
		into STRICT	dt_lote_w
		from	PLS_LOTE_MOV_BENEF a
		where	a.nr_sequencia = nr_seq_lote_p;
	end if;

	/* Trocar macros */

	/* Do caminho */

	ds_caminho_w	:= substr(replace_macro(ds_caminho_w,'@DIA',to_char(coalesce(dt_referencia_p,clock_timestamp()),'dd')),1,255);
	ds_caminho_w	:= substr(replace_macro(ds_caminho_w,'@MES',to_char(coalesce(dt_referencia_p,clock_timestamp()),'mm')),1,255);
	ds_caminho_w	:= substr(replace_macro(ds_caminho_w,'@ANO',to_char(coalesce(dt_referencia_p,clock_timestamp()),'yyyy')),1,255);
	/* Do nome */

	nm_arquivo_w	:= substr(replace_macro(nm_arquivo_w,'@DIA',to_char(dt_lote_w,'dd')),1,255);
	nm_arquivo_w	:= substr(replace_macro(nm_arquivo_w,'@MES',to_char(dt_lote_w,'mm')),1,255);
	nm_arquivo_w	:= substr(replace_macro(nm_arquivo_w,'@ANO',to_char(dt_lote_w,'yyyy')),1,255);
	nm_arquivo_w	:= substr(replace_macro(nm_arquivo_w,'@NR_LOTE',nr_seq_lote_p),1,255);
end if;

ds_caminho_p	:= ds_caminho_w;
nm_arquivo_p	:= nm_arquivo_w;
nm_objeto_p	:= nm_objeto_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_obter_arquivo_regra_ted (nr_seq_regra_p bigint, nr_seq_lote_p bigint, dt_referencia_p timestamp, ds_caminho_p INOUT text, nm_arquivo_p INOUT text, nm_objeto_p INOUT text) FROM PUBLIC;

