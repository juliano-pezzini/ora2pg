-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE tiss_gerar_conta_mat ( nr_interno_conta_p bigint, nr_seq_med_fatur_p bigint, nm_usuario_p text, nr_atend_med_p bigint, nr_seq_prot_med_p bigint) AS $body$
DECLARE


ie_reducao_acres_w		varchar(3);
pr_desconto_w			double precision;
nr_sequencia_w			bigint;
ie_tipo_despesa_w			varchar(2);
vl_item_w			double precision := 0;
vl_item_aux_w			double precision := 0;
vl_unit_original_w			double precision := 0;
dt_item_w			timestamp;
qt_item_w			tiss_conta_desp.qt_item%type := 0;
qt_item_aux_w			tiss_conta_desp.qt_item%type := 0;
qt_aux_w			tiss_conta_desp.qt_item%type := 0;
vl_unitario_w			double precision := 0;
ie_tipo_atendimento_w		double precision;
qt_item_regra_w			tiss_conta_desp.qt_item%type := 0;
ie_digitos_desp_w			varchar(2);
ie_procedimento_w			varchar(2);
cd_categoria_conv_w		varchar(20);
cd_edicao_amb_w			varchar(20);
ds_procedimento_w		varchar(255);
vl_reducao_acrescimo_w		double precision := 0;
vl_reducao_acresc_aux_w		double precision := 0;
cd_autorizacao_w			varchar(30);
ie_formato_red_acres_w		varchar(30);
cd_proc_convenio_w		varchar(80);
ie_tiss_tipo_guia_w			varchar(20);
cd_cgc_prestador_tiss_w		varchar(20);
cd_cgc_prest_solic_tiss_w		varchar(20);
cd_cgc_estab_w			varchar(20);
ie_tiss_tipo_guia_desp_w		varchar(20);
cd_convenio_w			bigint;
qt_max_despesa_w		bigint;
ie_despesa_zerada_w		varchar(20);
ie_tiss_desp_honor_w		varchar(10);
ie_periodo_desp_w			varchar(255);
ie_valor_desconto_w		varchar(10);
ds_versao_w			varchar(50);
ie_beneficiario_med_w		varchar(10);
IE_AGRUPAR_DESP_PAC_w		varchar(10);
cd_prestador_tiss_w		varchar(100);
ds_prestador_tiss_w		varchar(255);
ie_regra_valor_w			varchar(50);
ie_conversao_qtde_mat_w		varchar(255);
ie_responsavel_credito_w		varchar(255);
cd_medico_exec_tiss_w		varchar(255);
cd_estabelecimento_w		bigint;
qt_maxima_w			bigint;
cd_procedimento_w		bigint;
ie_origem_proced_w		bigint;
dt_hora_item_w			timestamp;
dt_hora_final_w			timestamp;
dt_periodo_desp_w			timestamp;
dt_periodo_final_w			timestamp;
ie_arredondamento_desp_w		varchar(20);
ie_agrupar_desp_pacote_w		bigint;
ie_valor_unitario_w		varchar(3);
ie_pacote_w			varchar(255);
ie_proc_tuss_w			varchar(255);
nr_atendimento_w			bigint;
ie_senha_guia_w			varchar(10);
cd_senha_w			varchar(255);
cd_senha_desp_w			varchar(255);
cont_w				bigint;
tx_ajuste_mat_w			double precision;
nr_seq_regra_ajuste_mat_w		bigint;
ie_clinica_w			bigint;
nr_seq_classif_atend_w		bigint;
dt_periodo_desp_max_w		timestamp;
dt_periodo_final_max_w		timestamp;
cd_prestador_solic_w		varchar(255);
ds_prestador_solic_w		varchar(255);
cd_medico_honor_tiss_w		varchar(255);
ie_guia_desp_med_w		varchar(255);
cd_medico_executor_w		varchar(255);
cd_setor_entrada_w		bigint;
cd_plano_convenio_w		varchar(10);
ie_tipo_atend_tiss_w		varchar(10);
ie_material_exec_w		varchar(10);
ie_qtd_material_w		varchar(10);
cd_unidade_medida_tiss_w	varchar(20);
ie_regra_pacote_w		varchar(10);
cd_grupo_w			varchar(255);
nr_seq_regra_w			bigint;
cd_proc_conversao_w		varchar(80);
cd_mat_conversao_w		varchar(80);
nr_registro_anvisa_w		material_atend_paciente.nr_registro_anvisa_tiss%type;
ie_xml_w			varchar(1);
cd_fabricante_w			varchar(255);
cd_cgc_fornec_opme_w		pessoa_juridica.cd_cgc%type;
nr_autor_func_w			pessoa_juridica.nr_autor_func%type;
dt_mesano_referencia_w		timestamp;
ie_versao_3_w			varchar(1);
nr_seq_tiss_tabela_w		bigint;
ie_codigo_tuss_w		varchar(1);
cd_ref_fabricante_w		material_marca.cd_referencia%type;		
nr_seq_proc_crit_hor_w 		bigint;
ie_desp_agrup_valor_w		tiss_parametros_convenio.ie_desp_agrup_valor%type;
ie_setor_exec_mat_w		tiss_parametros_convenio.ie_setor_exec_mat%type;
cd_setor_exec_mat_w		bigint;
ds_nao_informada_w		varchar(20);
ie_carater_internacao_w		tiss_conta_atend.ie_carater_internacao%type;

c01 CURSOR FOR
SELECT	ie_tipo_despesa,
	sum(vl_item) vl_item,
	dt_item,
	sum(qt_item) qt_item,
	cd_edicao_amb,
	ds_procedimento,
	cd_autorizacao,
	cd_proc_convenio,
	cd_cgc_prestador_tiss,
	ie_tiss_tipo_guia_desp,
	ie_tipo_atendimento,
	max(vl_unitario) vl_unitario,
	cd_prestador_tiss,
	cd_cgc_prest_solic_tiss,
	vl_reducao_acrescimo,
	ie_tiss_desp_honor,
	CASE WHEN ie_periodo_desp_w='S' THEN  dt_periodo_desp  ELSE CASE WHEN ie_periodo_desp_w='GTDA' THEN  dt_periodo_desp  ELSE CASE WHEN ie_periodo_desp_w='MED' THEN  CASE WHEN ie_tipo_despesa='5' THEN dt_periodo_desp  ELSE null END  WHEN ie_periodo_desp_w='MET' THEN  CASE WHEN ie_tipo_despesa='4' THEN dt_periodo_desp WHEN ie_tipo_despesa='5' THEN dt_periodo_desp  ELSE null END   ELSE null END  END  END  dt_periodo_desp,
	CASE WHEN ie_periodo_desp_w='S' THEN  dt_periodo_final  ELSE CASE WHEN ie_periodo_desp_w='GTDA' THEN  dt_periodo_final  ELSE CASE WHEN ie_periodo_desp_w='MED' THEN CASE WHEN ie_tipo_despesa='5' THEN dt_periodo_desp  ELSE null END  WHEN ie_periodo_desp_w='MET' THEN  CASE WHEN ie_tipo_despesa='4' THEN dt_periodo_desp WHEN ie_tipo_despesa='5' THEN dt_periodo_desp  ELSE null END   ELSE null END  END  END  dt_periodo_final,
	ie_procedimento,
	cd_procedimento,
	ie_origem_proced,
	ds_prestador_tiss,
	ie_beneficiario_med,
	ie_agrupar_desp_pacote,
	pr_desconto,
	nr_seq_regra_ajuste_mat,
	ie_responsavel_credito,
	cd_medico_exec_tiss,
	tx_ajuste_mat,
	vl_unit_original,
	max(dt_periodo_desp) dt_periodo_desp_max,
	max(dt_periodo_final) dt_periodo_final_max,
	cd_prestador_solic_tiss,
	ds_prestador_solic_tiss,
	cd_medico_honor_tiss,
	cd_medico_executor,
	cd_senha,
	cd_unidade_medida_tiss,
	ie_regra_pacote,
	nr_registro_anvisa_tiss,
	cd_fabricante,
	ie_codigo_tuss,
	nr_seq_tiss_tabela,
	cd_cgc_fornec_opme,
	nr_seq_proc_crit_hor,
	CASE WHEN ie_setor_exec_mat_w='S' THEN cd_setor_atendimento  ELSE null END  cd_setor_atendimento
from	(
	SELECT	ie_tiss_tipo_despesa ie_tipo_despesa,
		CASE WHEN ie_valor_desconto_w='N' THEN  coalesce(a.vl_material_tiss, a.vl_material)  ELSE TISS_OBTER_MAT_ATEND_PAC_VALOR(a.nr_sequencia) END  vl_item,
		ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(tiss_obter_dt_despesa(e.cd_estabelecimento, c.cd_convenio, a.dt_conta, e.dt_periodo_inicial, e.dt_periodo_final, 'S',e.ie_tipo_atend_conta,e.nr_interno_conta,'D',ie_tiss_tipo_despesa,a.cd_material,d.dt_entrada,d.dt_alta,e.dt_mesano_referencia)) dt_item,
		(TISS_OBTER_REGRA_CAMPO_PROC(CASE WHEN coalesce(TISS_OBTER_REGRA_QTDE_MAT(a.nr_sequencia),ie_conversao_qtde_mat_w)='M' THEN (TISS_OBTER_QTD_MAT(a.nr_sequencia,ie_qtd_material_w) * CASE WHEN coalesce(f.tx_conversao_qtde,0)=0 THEN 1  ELSE f.tx_conversao_qtde END ) WHEN coalesce(TISS_OBTER_REGRA_QTDE_MAT(a.nr_sequencia),ie_conversao_qtde_mat_w)='R' THEN (round(TISS_OBTER_QTD_MAT(a.nr_sequencia,ie_qtd_material_w) * CASE WHEN coalesce(f.tx_conversao_qtde,0)=0 THEN 1  ELSE f.tx_conversao_qtde END )) WHEN coalesce(TISS_OBTER_REGRA_QTDE_MAT(a.nr_sequencia),ie_conversao_qtde_mat_w)='D' THEN (dividir_sem_round(TISS_OBTER_QTD_MAT(a.nr_sequencia,ie_qtd_material_w), CASE WHEN coalesce(f.tx_conversao_qtde,0)=0 THEN 1  ELSE f.tx_conversao_qtde END )) WHEN coalesce(TISS_OBTER_REGRA_QTDE_MAT(a.nr_sequencia),ie_conversao_qtde_mat_w)='S' THEN (ceil(TISS_OBTER_QTD_MAT(a.nr_sequencia,ie_qtd_material_w) * CASE WHEN coalesce(f.tx_conversao_qtde,0)=0 THEN 1  ELSE f.tx_conversao_qtde END )) END ,
							 '2', c.cd_convenio, e.cd_estabelecimento, null, null, a.cd_material, e.cd_categoria_parametro, cd_plano_convenio_w,d.ie_tipo_atendimento,ie_carater_internacao_w, ie_tiss_tipo_guia_w))::numeric  qt_item,
		coalesce(tiss_obter_codigo_tabela(a.nr_seq_tiss_tabela),'00') CD_EDICAO_AMB,
		substr(TISS_ELIMINAR_CARACTERE(coalesce(a.ds_material_tiss, coalesce(f.ds_material,b.ds_material))),1,150) ds_procedimento,
		coalesce(a.nr_doc_convenio, ds_nao_informada_w) cd_autorizacao,
		coalesce(a.cd_material_tiss,
				TISS_OBTER_COD_MAT(a.cd_material_convenio, e.cd_estabelecimento,  a.cd_material, a.dt_conta,
								tiss_obter_origem_preco_mat(a.ie_origem_preco,
												a.cd_material,
												e.cd_estabelecimento,
												e.cd_convenio_parametro,
												e.cd_categoria_parametro, a.cd_tab_preco_material, a.dt_conta,a.cd_setor_atendimento, 'X',a.nr_seq_proc_pacote,a.nr_sequencia, a.cd_material_tuss),
														e.cd_convenio_parametro)) cd_proc_convenio,
		coalesce(a.cd_cgc_prestador_tiss, a.cd_cgc_prestador) cd_cgc_prestador_tiss,
		ie_tiss_tipo_guia_desp,
		d.ie_tipo_atendimento,
		a.vl_unitario,
		a.cd_prestador_tiss,
		a.cd_cgc_prest_solic_tiss,
		(TISS_OBTER_REGRA_CAMPO_PROC(a.tx_material, '1', c.cd_convenio, e.cd_estabelecimento, null, null, a.cd_material, e.cd_categoria_parametro, cd_plano_convenio_w,d.ie_tipo_atendimento,ie_carater_internacao_w, ie_tiss_tipo_guia_w))::numeric  vl_reducao_acrescimo,
		a.ie_tiss_desp_honor,
		TISS_OBTER_DT_PER_DESP(ie_periodo_desp_w, ie_tiss_tipo_despesa, tiss_obter_dt_despesa(e.cd_estabelecimento, c.cd_convenio, a.dt_conta, e.dt_periodo_inicial, e.dt_periodo_final, 'S',e.ie_tipo_atend_conta,e.nr_interno_conta,'DI',ie_tiss_tipo_despesa,a.cd_material,d.dt_entrada,d.dt_alta,e.dt_mesano_referencia),ds_versao_w) dt_periodo_desp,
		TISS_OBTER_DT_PER_DESP(ie_periodo_desp_w, ie_tiss_tipo_despesa, tiss_obter_dt_despesa(e.cd_estabelecimento, c.cd_convenio, a.dt_conta, e.dt_periodo_inicial, e.dt_periodo_final, 'S',e.ie_tipo_atend_conta,e.nr_interno_conta,'DF',ie_tiss_tipo_despesa,a.cd_material,d.dt_entrada,d.dt_alta,e.dt_mesano_referencia),ds_versao_w) dt_periodo_final,
		'N' ie_procedimento,
		(null)::numeric  cd_procedimento,
		(null)::numeric  ie_origem_proced,
		a.ds_prestador_tiss,
		null ie_beneficiario_med,
		CASE WHEN coalesce(a.nr_seq_proc_pacote, 0)=0 THEN  0  ELSE CASE WHEN IE_AGRUPAR_DESP_PAC_w='N' THEN  a.nr_sequencia  ELSE 0 END  END  ie_agrupar_desp_pacote,
		CASE WHEN ie_reducao_acres_w='TD' THEN tiss_obter_pr_desc_mat(a.nr_sequencia)  ELSE 0 END  pr_desconto,
		CASE WHEN ie_reducao_acres_w='AM' THEN  nr_seq_regra_ajuste_mat  ELSE null END  nr_seq_regra_ajuste_mat,
		a.nr_sequencia,
		null ie_responsavel_credito,	-- Edgar 24/06/2009, OS 150179, tieri o responsavel credito pois nao e tratado qdo e material
		a.cd_medico_exec_tiss,
		CASE WHEN ie_reducao_acres_w='EM' THEN  coalesce(obter_indice_preco_material(a.nr_sequencia),0) WHEN ie_reducao_acres_w='AM' THEN  coalesce(obter_indice_preco_material(a.nr_sequencia),0)  ELSE null END  tx_ajuste_mat,
		CASE WHEN ie_valor_unitario_w='D' THEN dividir(dividir(a.vl_material, coalesce(obter_indice_preco_material_2(a.nr_sequencia),1)),						dividir(TISS_OBTER_QTD_MAT(a.nr_sequencia,ie_qtd_material_w),CASE WHEN coalesce(f.tx_conversao_qtde,0)=0 THEN 1  ELSE f.tx_conversao_qtde END ))  ELSE null END   vl_unit_original,
		a.cd_prestador_solic_tiss,
		a.ds_prestador_solic_tiss,
		null cd_medico_honor_tiss,
		null cd_medico_executor,
		CASE WHEN ie_senha_guia_w='PM' THEN a.cd_senha  ELSE null END  cd_senha,
		CASE WHEN ie_versao_3_w='S' THEN tiss_obter_unidade_medida(coalesce(coalesce(f.cd_unidade_medida,a.cd_unid_medida_conv),a.cd_unidade_medida))  ELSE null END  cd_unidade_medida_tiss,
		'N' ie_regra_pacote,
		CASE WHEN ie_versao_3_w='S' THEN a.nr_registro_anvisa_tiss  ELSE null END  nr_registro_anvisa_tiss,
		CD_MATERIAL_FABRICANTE cd_fabricante,
		null ie_codigo_tuss,
		a.nr_seq_tiss_tabela,
		CASE WHEN ie_versao_3_w='S' THEN CASE WHEN ie_tiss_tipo_despesa='8' THEN substr((select obter_fornecedor_ultima_compra(a.cd_material,e.cd_estabelecimento) ),1,20)  ELSE null END   ELSE null END  cd_cgc_fornec_opme,
		null nr_seq_proc_crit_hor,
		CASE WHEN ie_setor_exec_mat_w='S' THEN a.cd_setor_atendimento  ELSE null END  cd_setor_atendimento
	FROM subgrupo_material j, classe_material i, conta_paciente e, atendimento_paciente d, convenio c, material b, material_atend_paciente a
LEFT OUTER JOIN mat_atend_pac_tiss t ON (a.nr_sequencia = t.nr_seq_material)
LEFT OUTER JOIN mat_atend_pac_convenio f ON (a.nr_sequencia = f.nr_seq_material)
WHERE a.cd_material			= b.cd_material  and a.nr_interno_conta		= nr_interno_conta_p and c.cd_convenio			= a.cd_convenio and a.nr_atendimento		= d.nr_atendimento and i.cd_subgrupo_material		= j.cd_subgrupo_material and coalesce(a.cd_motivo_exc_conta::text, '') = '' and a.nr_interno_conta		= e.nr_interno_conta  and ((coalesce(a.nr_seq_proc_pacote::text, '') = '') or
 		 (ie_pacote_w = 'I' AND a.nr_seq_proc_pacote IS NOT NULL AND a.nr_seq_proc_pacote::text <> '') or (ie_pacote_w = 'A')) and b.cd_classe_material		= i.cd_classe_material and ie_material_exec_w		= 'N' --	and	((nvl(i.IE_TIPO_CLASSE,'X') not in ('O','P','M')) and	--Edgar 16/01/2009, OS 123077, troquei o tratamento da classe pelo tratamento de ie_tiss_tipo_despesa
  and ((a.ie_tiss_tipo_despesa in ('1','2','3','4','5','6') or (obter_se_projeto_versao(0,12,ds_versao_w,0) = 'S')) and
		 ((TISS_OBTER_REGRA_MAT_OPM(e.cd_convenio_parametro, e.cd_estabelecimento, b.cd_material, b.cd_classe_material,
					  i.cd_subgrupo_material, j.cd_grupo_material, d.ie_tipo_atendimento,a.vl_unitario) not in ('S') or (obter_se_projeto_versao(0,12,ds_versao_w,0) = 'S')) and (TISS_OBTER_REGRA_MAT_OPM(e.cd_convenio_parametro, e.cd_estabelecimento, b.cd_material, b.cd_classe_material,
					  i.cd_subgrupo_material, j.cd_grupo_material, d.ie_tipo_atendimento,a.vl_unitario) not in ('RI','SADT'))			  
		)) and ((TISS_OBTER_SE_PACOTE_ACOMOD(a.nr_interno_conta) = 'N') or (coalesce(a.nr_seq_proc_pacote::text, '') = ''))
	 
union all
 /*Gerar itens pelo Material Informado da conta (CD_MATERIAL_EXEC)*/
	select	ie_tiss_tipo_despesa ie_tipo_despesa,
		CASE WHEN ie_valor_desconto_w='N' THEN  coalesce(a.vl_material_tiss, a.vl_material)  ELSE TISS_OBTER_MAT_ATEND_PAC_VALOR(a.nr_sequencia) END  vl_item,
		ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(tiss_obter_dt_despesa(e.cd_estabelecimento, c.cd_convenio, a.dt_conta, e.dt_periodo_inicial, e.dt_periodo_final, 'S',e.ie_tipo_atend_conta,e.nr_interno_conta,'D',ie_tiss_tipo_despesa,a.cd_material,d.dt_entrada,d.dt_alta,e.dt_mesano_referencia)) dt_item,
		(TISS_OBTER_REGRA_CAMPO_PROC(CASE WHEN coalesce(TISS_OBTER_REGRA_QTDE_MAT(a.nr_sequencia),ie_conversao_qtde_mat_w)='M' THEN (TISS_OBTER_QTD_MAT(a.nr_sequencia,ie_qtd_material_w) * CASE WHEN coalesce(f.tx_conversao_qtde,0)=0 THEN 1  ELSE f.tx_conversao_qtde END ) WHEN coalesce(TISS_OBTER_REGRA_QTDE_MAT(a.nr_sequencia),ie_conversao_qtde_mat_w)='R' THEN (round(TISS_OBTER_QTD_MAT(a.nr_sequencia,ie_qtd_material_w) * CASE WHEN coalesce(f.tx_conversao_qtde,0)=0 THEN 1  ELSE f.tx_conversao_qtde END )) WHEN coalesce(TISS_OBTER_REGRA_QTDE_MAT(a.nr_sequencia),ie_conversao_qtde_mat_w)='D' THEN (dividir_sem_round(TISS_OBTER_QTD_MAT(a.nr_sequencia,ie_qtd_material_w), CASE WHEN coalesce(f.tx_conversao_qtde,0)=0 THEN 1  ELSE f.tx_conversao_qtde END )) WHEN coalesce(TISS_OBTER_REGRA_QTDE_MAT(a.nr_sequencia),ie_conversao_qtde_mat_w)='S' THEN (round(TISS_OBTER_QTD_MAT(a.nr_sequencia,ie_qtd_material_w) * CASE WHEN coalesce(f.tx_conversao_qtde,0)=0 THEN 1  ELSE f.tx_conversao_qtde END )) END ,
							 '2', c.cd_convenio, e.cd_estabelecimento, null, null, coalesce(a.cd_material_exec,a.cd_material), e.cd_categoria_parametro, cd_plano_convenio_w,d.ie_tipo_atendimento,ie_carater_internacao_w, ie_tiss_tipo_guia_w))::numeric  qt_item,
		coalesce(tiss_obter_codigo_tabela(a.nr_seq_tiss_tabela),'00') CD_EDICAO_AMB,
		substr(TISS_ELIMINAR_CARACTERE(coalesce(a.ds_material_tiss, coalesce(f.ds_material,b.ds_material))),1,150) ds_procedimento,
		coalesce(a.nr_doc_convenio, ds_nao_informada_w) cd_autorizacao,
		coalesce(a.cd_material_tiss,
				TISS_OBTER_COD_MAT(a.cd_material_convenio, e.cd_estabelecimento,  coalesce(a.cd_material_exec,a.cd_material), a.dt_conta,
								tiss_obter_origem_preco_mat(a.ie_origem_preco,
												coalesce(a.cd_material_exec,a.cd_material),
												e.cd_estabelecimento,
												e.cd_convenio_parametro,
												e.cd_categoria_parametro, a.cd_tab_preco_material, a.dt_conta,a.cd_setor_atendimento, 'X',a.nr_seq_proc_pacote,a.nr_sequencia, a.cd_material_tuss),
														e.cd_convenio_parametro)) cd_proc_convenio,
		coalesce(a.cd_cgc_prestador_tiss, a.cd_cgc_prestador) cd_cgc_prestador_tiss,
		ie_tiss_tipo_guia_desp,
		d.ie_tipo_atendimento,
		a.vl_unitario,
		a.cd_prestador_tiss,
		a.cd_cgc_prest_solic_tiss,
		(TISS_OBTER_REGRA_CAMPO_PROC(a.tx_material, '1', c.cd_convenio, e.cd_estabelecimento, null, null, coalesce(a.cd_material_exec,a.cd_material), e.cd_categoria_parametro, cd_plano_convenio_w,d.ie_tipo_atendimento,ie_carater_internacao_w, ie_tiss_tipo_guia_w))::numeric  vl_reducao_acrescimo,
		a.ie_tiss_desp_honor,
		TISS_OBTER_DT_PER_DESP(ie_periodo_desp_w, ie_tiss_tipo_despesa, tiss_obter_dt_despesa(e.cd_estabelecimento, c.cd_convenio, a.dt_conta, e.dt_periodo_inicial, e.dt_periodo_final, 'S',e.ie_tipo_atend_conta,e.nr_interno_conta,'DI',ie_tiss_tipo_despesa,a.cd_material,d.dt_entrada,d.dt_alta,e.dt_mesano_referencia),ds_versao_w) dt_periodo_desp,
		TISS_OBTER_DT_PER_DESP(ie_periodo_desp_w, ie_tiss_tipo_despesa, tiss_obter_dt_despesa(e.cd_estabelecimento, c.cd_convenio, a.dt_conta, e.dt_periodo_inicial, e.dt_periodo_final, 'S',e.ie_tipo_atend_conta,e.nr_interno_conta,'DF',ie_tiss_tipo_despesa,a.cd_material,d.dt_entrada,d.dt_alta,e.dt_mesano_referencia),ds_versao_w) dt_periodo_final,
		'N' ie_procedimento,
		(null)::numeric  cd_procedimento,
		(null)::numeric  ie_origem_proced,
		a.ds_prestador_tiss,
		null ie_beneficiario_med,
		CASE WHEN coalesce(a.nr_seq_proc_pacote, 0)=0 THEN  0  ELSE CASE WHEN IE_AGRUPAR_DESP_PAC_w='N' THEN  a.nr_sequencia  ELSE 0 END  END  ie_agrupar_desp_pacote,
		CASE WHEN ie_reducao_acres_w='TD' THEN tiss_obter_pr_desc_mat(a.nr_sequencia)  ELSE 0 END  pr_desconto,
		CASE WHEN ie_reducao_acres_w='AM' THEN  nr_seq_regra_ajuste_mat  ELSE null END  nr_seq_regra_ajuste_mat,
		a.nr_sequencia,
		null ie_responsavel_credito,	-- Edgar 24/06/2009, OS 150179, tieri o responsavel credito pois nao e tratado qdo e material
		a.cd_medico_exec_tiss,
		CASE WHEN ie_reducao_acres_w='EM' THEN  coalesce(obter_indice_preco_material(a.nr_sequencia),0) WHEN ie_reducao_acres_w='AM' THEN  coalesce(obter_indice_preco_material(a.nr_sequencia),0)  ELSE null END  tx_ajuste_mat,
		CASE WHEN ie_valor_unitario_w='D' THEN dividir(dividir(a.vl_material, coalesce(obter_indice_preco_material_2(a.nr_sequencia),1)), 						dividir(TISS_OBTER_QTD_MAT(a.nr_sequencia,ie_qtd_material_w),CASE WHEN coalesce(f.tx_conversao_qtde,0)=0 THEN 1  ELSE f.tx_conversao_qtde END ))  ELSE null END   vl_unit_original,
		a.cd_prestador_solic_tiss,
		a.ds_prestador_solic_tiss,
		null cd_medico_honor_tiss,
		null cd_medico_executor,
		CASE WHEN ie_senha_guia_w='PM' THEN a.cd_senha  ELSE null END  cd_senha,
		CASE WHEN ie_versao_3_w='S' THEN tiss_obter_unidade_medida(coalesce(coalesce(f.cd_unidade_medida,a.cd_unid_medida_conv),a.cd_unidade_medida))  ELSE null END  cd_unidade_medida_tiss,
		'N' ie_regra_pacote,
		CASE WHEN ie_versao_3_w='S' THEN a.nr_registro_anvisa_tiss  ELSE null END  nr_registro_anvisa_tiss,
		t.CD_MATERIAL_FABRICANTE cd_fabricante,
		null ie_codigo_tuss,
		a.nr_seq_tiss_tabela,
		CASE WHEN ie_versao_3_w='S' THEN substr((select obter_fornecedor_ultima_compra(a.cd_material,e.cd_estabelecimento) ),1,20)  ELSE null END  cd_cgc_fornec_opme,
		null nr_seq_proc_crit_hor,
		CASE WHEN ie_setor_exec_mat_w='S' THEN a.cd_setor_atendimento  ELSE null END  cd_setor_atendimento
	FROM subgrupo_material j, classe_material i, conta_paciente e, atendimento_paciente d, convenio c, material b, material_atend_paciente a
LEFT OUTER JOIN mat_atend_pac_tiss t ON (a.nr_sequencia = t.nr_seq_material)
LEFT OUTER JOIN mat_atend_pac_convenio f ON (a.nr_sequencia = f.nr_seq_material)
WHERE coalesce(a.cd_material_exec,a.cd_material)	= b.cd_material  and a.nr_interno_conta			= nr_interno_conta_p and c.cd_convenio				= a.cd_convenio and a.nr_atendimento			= d.nr_atendimento and i.cd_subgrupo_material			= j.cd_subgrupo_material and coalesce(a.cd_motivo_exc_conta::text, '') = '' and a.nr_interno_conta			= e.nr_interno_conta  and ((coalesce(a.nr_seq_proc_pacote::text, '') = '') or
 		 (ie_pacote_w = 'I' AND a.nr_seq_proc_pacote IS NOT NULL AND a.nr_seq_proc_pacote::text <> '') or (ie_pacote_w = 'A')) and b.cd_classe_material			= i.cd_classe_material and ie_material_exec_w			= 'S' and ((a.ie_tiss_tipo_despesa in ('1','2','3','4','5','6') or (obter_se_projeto_versao(0,12,ds_versao_w,0) = 'S')) and
		 ((TISS_OBTER_REGRA_MAT_OPM(e.cd_convenio_parametro, e.cd_estabelecimento, b.cd_material, b.cd_classe_material,
					  i.cd_subgrupo_material, j.cd_grupo_material, d.ie_tipo_atendimento,a.vl_unitario) not in ('S') or (obter_se_projeto_versao(0,12,ds_versao_w,0) = 'S')) and (TISS_OBTER_REGRA_MAT_OPM(e.cd_convenio_parametro, e.cd_estabelecimento, b.cd_material, b.cd_classe_material,
					  i.cd_subgrupo_material, j.cd_grupo_material, d.ie_tipo_atendimento,a.vl_unitario) not in ('RI','SADT'))			  
		)) and ((TISS_OBTER_SE_PACOTE_ACOMOD(a.nr_interno_conta) = 'N') or (coalesce(a.nr_seq_proc_pacote::text, '') = ''))
	 
union all

	select	a.ie_tiss_tipo_despesa ie_tipo_despesa,
		CASE WHEN ie_valor_desconto_w='N' THEN  coalesce(a.vl_desp_tiss, a.vl_procedimento)  ELSE coalesce(a.vl_desp_tiss, a.vl_procedimento) + coalesce(obter_desconto_matproc(a.nr_sequencia,'P'),0) END  vl_item,
		ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(tiss_obter_dt_despesa(e.cd_estabelecimento, c.cd_convenio, a.dt_conta, e.dt_periodo_inicial, e.dt_periodo_final, 'T',e.ie_tipo_atend_conta,e.nr_interno_conta,'D',a.ie_tiss_tipo_despesa,null,d.dt_entrada,d.dt_alta,e.dt_mesano_referencia)) dt_item,
		(TISS_OBTER_REGRA_CAMPO_PROC(CASE WHEN tiss_obter_regra_qtde_proc(a.nr_sequencia)='M' THEN (a.qt_procedimento * CASE WHEN coalesce(h.tx_conversao_qtde,0)=0 THEN 1  ELSE h.tx_conversao_qtde END ) WHEN tiss_obter_regra_qtde_proc(a.nr_sequencia)='R' THEN (round(a.qt_procedimento * CASE WHEN coalesce(h.tx_conversao_qtde,0)=0 THEN 1  ELSE h.tx_conversao_qtde END )) WHEN tiss_obter_regra_qtde_proc(a.nr_sequencia)='D' THEN (dividir_sem_round(a.qt_procedimento, CASE WHEN coalesce(h.tx_conversao_qtde,0)=0 THEN 1  ELSE h.tx_conversao_qtde END )) WHEN tiss_obter_regra_qtde_proc(a.nr_sequencia)='S' THEN (round(a.qt_procedimento * CASE WHEN coalesce(h.tx_conversao_qtde,0)=0 THEN 1  ELSE h.tx_conversao_qtde END )) END ,     
		'2', c.cd_convenio, e.cd_estabelecimento, a.cd_procedimento, a.ie_origem_proced, null, e.cd_categoria_parametro, cd_plano_convenio_w,d.ie_tipo_atendimento,ie_carater_internacao_w, ie_tiss_tipo_guia_w))::numeric  qt_item,
		coalesce(tiss_obter_codigo_tabela(a.nr_seq_tiss_tabela),'00') CD_EDICAO_AMB,		
		substr(TISS_ELIMINAR_CARACTERE(coalesce(tiss_obter_campo_esp(e.cd_convenio_parametro,
									h.cd_estabelecimento,
									'DS_DESPESA',
									null,
									coalesce(h.ds_procedimento, b.ds_procedimento),
									null,
									OBTER_CLASSIF_SETOR(a.cd_setor_atendimento),
									null,
									null,
									null,
									OBTER_TIPO_PROTOCOLO(e.nr_seq_protocolo),
									OBTER_TIPO_GUIA_CONVENIO(e.nr_interno_conta),
									Obter_Valor_Conv_Estab(c.cd_convenio, h.cd_estabelecimento, 'CD_REGIONAL'),
									null,
									a.cd_procedimento,
									a.ie_origem_proced,
									a.cd_setor_atendimento,
									d.ie_tipo_atendimento,
									a.cd_cgc_prestador,
									a.ie_responsavel_credito,
									null,
									e.nr_interno_conta, 
									a.nr_prescricao, 
									null, 
									null, 
									a.cd_procedimento_convenio,
									null,
									null),
						coalesce(a.ds_proc_tiss, TISS_OBTER_DESC_TUSS_DESP(a.nr_sequencia)))),1,60) ds_procedimento,
		coalesce(a.nr_doc_convenio, ds_nao_informada_w) cd_autorizacao,
		TISS_OBTER_REGRA_CODIGO_DESP(	e.cd_estabelecimento,
						e.cd_convenio_parametro,
						a.ie_tiss_tipo_despesa,
						coalesce(substr(tiss_obter_tabela(a.cd_edicao_amb,
										e.cd_estabelecimento,
										e.cd_convenio_parametro,
										e.cd_categoria_parametro,
										a.dt_conta,
										'C',
										b.ie_classificacao,
										a.cd_procedimento,
										a.ie_origem_proced,
										a.nr_sequencia,
										a.nr_seq_proc_pacote,
										d.nr_atendimento,
										a.nr_seq_proc_interno,
										a.nr_seq_exame,
										a.cd_procedimento_tuss),1,20),						
										coalesce(	coalesce(	TISS_OBTER_COD_TUSS_DESP(a.nr_sequencia), 
												a.cd_procedimento_convenio), 
											to_char(a.cd_procedimento))),
						null,
						CASE WHEN coalesce(a.cd_procedimento_tuss,0)=0 THEN 'N'  ELSE 'S' END , --ie_codigo_tuss_p
						a.nr_seq_tiss_tabela,
						null,
						a.cd_procedimento,
						a.ie_origem_proced) cd_proc_convenio,
		coalesce(a.cd_cgc_prestador_tiss, a.cd_cgc_prestador)  cd_cgc_prestador_tiss,
		ie_tiss_tipo_guia_desp,
		d.ie_tipo_atendimento,
		dividir_sem_round(coalesce(a.vl_desp_tiss, a.vl_procedimento), a.qt_procedimento) vl_unitario,
		a.cd_prestador_tiss,
		a.cd_cgc_prest_solic_tiss,
		(TISS_OBTER_REGRA_CAMPO_PROC(a.tx_procedimento,  '1', c.cd_convenio, e.cd_estabelecimento, a.cd_procedimento, a.ie_origem_proced, null, e.cd_categoria_parametro, cd_plano_convenio_w,d.ie_tipo_atendimento,ie_carater_internacao_w, ie_tiss_tipo_guia_w))::numeric  vl_reducao_acrescimo,
		a.ie_tiss_desp_honor,
		TISS_OBTER_DT_PER_DESP(ie_periodo_desp_w, a.ie_tiss_tipo_despesa, coalesce(TISS_OBTER_DATA_PROC(a.nr_sequencia, e.cd_convenio_parametro, d.ie_tipo_atendimento, 'S', 'I'),
							     tiss_obter_dt_despesa(e.cd_estabelecimento, c.cd_convenio, a.dt_conta, e.dt_periodo_inicial, e.dt_periodo_final, 'N',e.ie_tipo_atend_conta,e.nr_interno_conta,'DI',a.ie_tiss_tipo_despesa,null)),ds_versao_w) dt_periodo_desp,
		TISS_OBTER_DT_PER_DESP(ie_periodo_desp_w, a.ie_tiss_tipo_despesa, coalesce(TISS_OBTER_DATA_PROC(a.nr_sequencia, e.cd_convenio_parametro, d.ie_tipo_atendimento, 'S', 'F'),
							     tiss_obter_dt_despesa(e.cd_estabelecimento, c.cd_convenio, a.dt_conta, e.dt_periodo_inicial, e.dt_periodo_final, 'N',e.ie_tipo_atend_conta,e.nr_interno_conta,'DF',a.ie_tiss_tipo_despesa,null)),ds_versao_w) dt_periodo_final,
		'S' ie_procedimento,
		null cd_procedimento, --a.cd_procedimento, Retirado pois nao era utilizado e gerava erro de agrupamento
		a.ie_origem_proced,
		a.ds_prestador_tiss,
		null ie_beneficiario_med,
		CASE WHEN coalesce(a.nr_seq_proc_pacote, 0)=0 THEN  0  ELSE CASE WHEN IE_AGRUPAR_DESP_PAC_w='N' THEN  a.nr_sequencia  ELSE 0 END  END  ie_agrupar_desp_pacote,
		CASE WHEN ie_reducao_acres_w='TD' THEN tiss_obter_pr_desc(a.nr_sequencia)  ELSE 0 END  pr_desconto,
		null,
		a.nr_sequencia,
		a.ie_responsavel_credito,
		a.cd_medico_exec_tiss,
		CASE WHEN ie_reducao_acres_w='EM' THEN obter_indice_preco_proc(nr_sequencia)  ELSE null END  tx_ajuste_mat, --lhalves OS265289 em 18/11/2010 - Gerar o indice de ajuste da tabela para as taxas
		(null)::numeric ,
		a.cd_prestador_solic_tiss,
		a.ds_prestador_solic_tiss,
		a.cd_medico_honor_tiss cd_medico_honor_tiss,
		a.cd_medico_executor cd_medico_executor,
		CASE WHEN ie_senha_guia_w='PM' THEN a.cd_senha  ELSE null END  cd_senha,
		CASE WHEN ie_versao_3_w='S' THEN tiss_obter_unidade_medida(coalesce(h.cd_unidade_medida,obter_unid_med_Servico(e.cd_convenio_parametro, e.cd_categoria_parametro, a.cd_procedimento, a.ie_origem_proced, d.cd_estabelecimento)))  ELSE null END  cd_unidade_medida_tiss,
		'N' ie_regra_pacote,
		null nr_registro_anvisa_tiss,
		null cd_fabricante,
		CASE WHEN ie_versao_3_w='S' THEN CASE WHEN coalesce(a.cd_procedimento_tuss,0)=0 THEN 'N'  ELSE 'S' END   ELSE 'N' END  ie_codigo_tuss,
		a.nr_seq_tiss_tabela,
		null cd_cgc_fornec_opme,
		a.nr_seq_proc_crit_hor,
		CASE WHEN ie_setor_exec_mat_w='S' THEN a.cd_setor_atendimento  ELSE null END  cd_setor_atendimento
	FROM conta_paciente e, atendimento_paciente d, convenio c, procedimento b, procedimento_paciente a
LEFT OUTER JOIN regra_honorario f ON (a.ie_responsavel_credito = f.cd_regra)
LEFT OUTER JOIN proc_paciente_convenio h ON (a.nr_sequencia = h.nr_seq_procedimento)
WHERE a.cd_procedimento		= b.cd_procedimento and a.ie_origem_proced	= b.ie_origem_proced and c.cd_convenio		= a.cd_convenio and a.nr_atendimento		= d.nr_atendimento   and a.ie_tiss_tipo_guia		= '7' and (a.ie_tiss_tipo_despesa		not in ('7','8','9') or (obter_se_projeto_versao(0,12,ds_versao_w,0) = 'S')) and a.nr_interno_conta		= e.nr_interno_conta and (((ie_pacote_w = 'P') and (coalesce(a.nr_seq_proc_pacote, a.nr_sequencia) = a.nr_sequencia)) or
		 ((ie_pacote_w = 'I') and (coalesce(a.nr_seq_proc_pacote, 0) <> a.nr_sequencia)) or (ie_pacote_w = 'A')) and coalesce(a.cd_motivo_exc_conta::text, '') = '' and e.cd_estabelecimento		= h.cd_estabelecimento and e.nr_interno_conta		= nr_interno_conta_p and ((TISS_OBTER_SE_PACOTE_ACOMOD(a.nr_interno_conta) = 'N') or (coalesce(a.nr_seq_proc_pacote::text, '') = ''))
	 
union all

	select	CASE WHEN to_char(b.ie_tipo_item)='1' THEN '3'  ELSE to_char(b.ie_tipo_item) END , /*lhalves OS 359972 em 13/09/2011*/
		a.vl_item,
		ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(x.dt_referencia) dt_item,
		a.qt_item,
		substr(coalesce(c.nr_seq_tiss_tabela,0),1,255) CD_EDICAO_AMB,
		substr(b.ds_item, 1, 60) ds_procedimento,
		coalesce(a.cd_guia, ds_nao_informada_w) cd_autorizacao,
		c.cd_item_convenio cd_proc_convenio,
		x.cd_cgc cd_cgc_prestador,
		'2' ie_tiss_tipo_guia_desp,
		(null)::numeric  ie_tipo_atendimento,
		dividir_sem_round(a.vl_item, a.qt_item) vl_unitario,
		null cd_prestador_tiss,
		null cd_cgc_prest_solic_tiss,
		(CASE WHEN IE_FORMATO_RED_ACRES_w='V' THEN  null  ELSE 1 END )::numeric  vl_reducao_acrescimo,
		null ie_tiss_desp_honor,
		e.dt_entrada dt_periodo_desp,
		e.dt_entrada dt_periodo_final,
		'N' ie_procedimento,
		(null)::numeric  cd_procedimento,
		(null)::numeric  ie_origem_proced,
		null ds_prestador_tiss,
		x.ie_beneficiario,
		0 ie_agrupar_desp_pacote,
		tiss_obter_pr_desc_mat(a.nr_sequencia) pr_desconto,
		null,
		a.nr_sequencia,
		null ie_responsavel_credito,
		null,
		1 tx_ajuste_mat,
		(null)::numeric ,
		null,
		null,
		null,
		null,
		null,
		'036' cd_unidade_medida_tiss,
		'N' ie_regra_pacote,
		null nr_registro_anvisa_tiss,
		null cd_fabricante,
		'N' ie_codigo_tuss,
		c.nr_seq_tiss_tabela,
		null cd_cgc_fornec_opme,
		null nr_seq_proc_crit_hor,
		null cd_setor_atendimento
	from	med_prot_convenio x,
		med_item_convenio c,
		med_atendimento e,
		med_item b,
		med_faturamento a
	where	a.nr_seq_item		= b.nr_sequencia
	and	b.nr_sequencia		= c.nr_seq_item
	and	c.nr_seq_plano		= e.nr_seq_plano
	and	e.nr_atendimento		= a.nr_atendimento
	and	a.nr_seq_protocolo		= x.nr_sequencia
	and	b.ie_tipo_item		<> 3
	and	x.ie_tipo_guia		<> 'C'
	and	a.nr_atendimento		= nr_atend_med_p
	and	a.nr_seq_protocolo		= nr_seq_prot_med_p
	
union all

	/*OS 542682 Itens da regra de pacote*/

	select	CASE WHEN d.ie_tipo_despesa_tiss='4' THEN '7'  ELSE d.ie_tipo_despesa_tiss END  ie_tipo_despesa_tiss,
		coalesce(c.vl_total_item,0) * coalesce(tiss_obter_qt_proc_pacote(e.nr_interno_conta,g.cd_procedimento),1),
		a.dt_procedimento dt_item,
		coalesce(tiss_obter_qt_proc_pacote(e.nr_interno_conta,g.cd_procedimento),1) qt_item,
		substr(TISS_OBTER_CODIGO_TABELA(coalesce(c.nr_seq_tiss_tabela,a.nr_seq_tiss_tabela)),1,255) CD_EDICAO_AMB,
		substr(d.ds_procedimento, 1, 60) ds_procedimento,
		coalesce(a.nr_doc_convenio, ds_nao_informada_w) cd_autorizacao,
		to_char(c.cd_procedimento) cd_proc_convenio,
		a.cd_cgc_prestador cd_cgc_prestador,
		coalesce((select max(ie_tiss_tipo_guia_desp)
		from	material_atend_paciente x
		where	x.nr_interno_conta	= a.nr_interno_conta
		and	coalesce(x.cd_motivo_exc_conta::text, '') = ''),CASE WHEN e.ie_tipo_atend_conta=1 THEN '5'  ELSE '4' END ) ie_tiss_tipo_guia_desp,
		f.ie_tipo_atendimento ie_tipo_atendimento,
		coalesce(c.vl_total_item,0) vl_unitario,
		a.cd_prestador_tiss,
		a.cd_cgc_prest_solic_tiss,
		1 vl_reducao_acrescimo,
		null ie_tiss_desp_honor,
		TISS_OBTER_DT_PER_DESP(ie_periodo_desp_w, d.ie_tipo_despesa_tiss, coalesce(TISS_OBTER_DATA_PROC(a.nr_sequencia, e.cd_convenio_parametro, f.ie_tipo_atendimento, 'S', 'I'),
								     tiss_obter_dt_despesa(e.cd_estabelecimento, e.cd_convenio_parametro, a.dt_conta, e.dt_periodo_inicial, e.dt_periodo_final, 'N',e.ie_tipo_atend_conta,e.nr_interno_conta,'DI',d.ie_tipo_despesa_tiss,null)),ds_versao_w) dt_periodo_desp,
		TISS_OBTER_DT_PER_DESP(ie_periodo_desp_w, d.ie_tipo_despesa_tiss, coalesce(TISS_OBTER_DATA_PROC(a.nr_sequencia, e.cd_convenio_parametro, f.ie_tipo_atendimento, 'S', 'F'),
								     tiss_obter_dt_despesa(e.cd_estabelecimento, e.cd_convenio_parametro, a.dt_conta, e.dt_periodo_inicial, e.dt_periodo_final, 'N',e.ie_tipo_atend_conta,e.nr_interno_conta,'DF',d.ie_tipo_despesa_tiss,null)),ds_versao_w) dt_periodo_final,
		'S' ie_procedimento,
		null cd_procedimento,
		c.ie_origem_proced ie_origem_proced,
		a.ds_prestador_tiss,
		null ie_beneficiario,
		0 ie_agrupar_desp_pacote,
		CASE WHEN ie_reducao_acres_w='TD' THEN tiss_obter_pr_desc(a.nr_sequencia)  ELSE 0 END  pr_desconto,
		null,
		a.nr_sequencia,
		a.ie_responsavel_credito,
		a.cd_medico_exec_tiss,
		CASE WHEN ie_reducao_acres_w='EM' THEN obter_indice_preco_proc(a.nr_sequencia)  ELSE null END  tx_ajuste_mat, --lhalves OS265289 em 18/11/2010 - Gerar o indice de ajuste da tabela para as taxas
		(null)::numeric ,
		a.cd_prestador_solic_tiss,
		a.ds_prestador_solic_tiss,
		a.cd_medico_honor_tiss cd_medico_honor_tiss,
		a.cd_medico_executor cd_medico_executor,
		CASE WHEN ie_senha_guia_w='PM' THEN a.cd_senha  ELSE null END  cd_senha,
		'036' cd_unidade_medida_tiss, --OS 806839 em 29/10/2014
		'S' ie_regra_pacote,
		null nr_registro_anvisa_tiss,
		null cd_fabricante,
		CASE WHEN ie_versao_3_w='S' THEN CASE WHEN coalesce(a.cd_procedimento_tuss,0)=0 THEN 'N'  ELSE 'S' END   ELSE 'N' END  ie_codigo_tuss,
		a.nr_seq_tiss_tabela,
		null  cd_cgc_fornec_opme,
		null nr_seq_proc_crit_hor,
		CASE WHEN ie_setor_exec_mat_w='S' THEN a.cd_setor_atendimento  ELSE null END  cd_setor_atendimento
	from	procedimento_paciente a,
		atendimento_pacote b,
		pacote_tipo_acomodacao g,
		pacote_tipo_acomod_tiss c,
		procedimento d,
		conta_paciente e,
		atendimento_paciente f
	where	a.nr_seq_proc_pacote	= a.nr_sequencia
	and	a.nr_sequencia		= b.nr_seq_procedimento
	and	a.nr_atendimento	= b.nr_atendimento
	and	b.nr_seq_tipo_acomod	= c.nr_seq_tipo_acomod	
	and	c.cd_procedimento	= d.cd_procedimento
	and	c.nr_seq_tipo_acomod	= g.nr_sequencia
	and	c.ie_origem_proced	= d.ie_origem_proced
	and	a.nr_interno_conta	= e.nr_interno_conta
	and	d.ie_classificacao	<> '1'
	and	e.nr_atendimento	= f.nr_atendimento
	and	a.nr_interno_conta	= nr_interno_conta_p
	and	coalesce(a.cd_motivo_exc_conta::text, '') = ''
	
union all

	/*OS 542682 Itens da regra de pacote*/

	select	CASE WHEN d.ie_tipo_material='1' THEN '3' WHEN d.ie_tipo_material=ie_tipo_material THEN '2' WHEN d.ie_tipo_material='2' THEN ie_tipo_material WHEN d.ie_tipo_material='3' THEN '2'  ELSE '3' END   ie_tipo_despesa_tiss,
		coalesce(c.vl_total_item,0) * coalesce(tiss_obter_qt_proc_pacote(e.nr_interno_conta,g.cd_procedimento),1),
		a.dt_procedimento dt_item,
		coalesce(tiss_obter_qt_proc_pacote(e.nr_interno_conta,g.cd_procedimento),1) qt_item,
		substr(TISS_OBTER_CODIGO_TABELA(coalesce(c.nr_seq_tiss_tabela,a.nr_seq_tiss_tabela)),1,255) CD_EDICAO_AMB,
		substr(d.ds_material, 1, 150) ds_procedimento,
		coalesce(a.nr_doc_convenio, ds_nao_informada_w) cd_autorizacao,
		to_char(c.cd_material) cd_proc_convenio,
		a.cd_cgc_prestador cd_cgc_prestador,
		coalesce((select max(ie_tiss_tipo_guia_desp)
		from	material_atend_paciente x
		where	x.nr_interno_conta	= a.nr_interno_conta
		and	coalesce(x.cd_motivo_exc_conta::text, '') = ''),CASE WHEN e.ie_tipo_atend_conta=1 THEN '5'  ELSE '4' END ) ie_tiss_tipo_guia_desp,
		f.ie_tipo_atendimento ie_tipo_atendimento,
		dividir(coalesce(c.vl_total_item,0),coalesce(tiss_obter_qt_proc_pacote(e.nr_interno_conta,g.cd_procedimento),1)) vl_unitario,
		a.cd_prestador_tiss,
		a.cd_cgc_prest_solic_tiss,
		1 vl_reducao_acrescimo,
		null ie_tiss_desp_honor,
		TISS_OBTER_DT_PER_DESP(ie_periodo_desp_w, CASE WHEN d.ie_tipo_material='1' THEN '3' WHEN d.ie_tipo_material=ie_tipo_material THEN '2' WHEN d.ie_tipo_material='2' THEN ie_tipo_material WHEN d.ie_tipo_material='3' THEN '2'  ELSE '3' END , coalesce(TISS_OBTER_DATA_PROC(a.nr_sequencia, e.cd_convenio_parametro, f.ie_tipo_atendimento, 'S', 'I'),
								     tiss_obter_dt_despesa(e.cd_estabelecimento, e.cd_convenio_parametro, a.dt_conta, e.dt_periodo_inicial, e.dt_periodo_final, 'N',e.ie_tipo_atend_conta,e.nr_interno_conta,'DI',CASE WHEN d.ie_tipo_material='1' THEN '3' WHEN d.ie_tipo_material=ie_tipo_material THEN '2' WHEN d.ie_tipo_material='2' THEN ie_tipo_material WHEN d.ie_tipo_material='3' THEN '2'  ELSE '3' END ,null)),ds_versao_w) dt_periodo_desp,
		TISS_OBTER_DT_PER_DESP(ie_periodo_desp_w, CASE WHEN d.ie_tipo_material='1' THEN '3' WHEN d.ie_tipo_material=ie_tipo_material THEN '2' WHEN d.ie_tipo_material='2' THEN ie_tipo_material WHEN d.ie_tipo_material='3' THEN '2'  ELSE '3' END , coalesce(TISS_OBTER_DATA_PROC(a.nr_sequencia, e.cd_convenio_parametro, f.ie_tipo_atendimento, 'S', 'F'),
								     tiss_obter_dt_despesa(e.cd_estabelecimento, e.cd_convenio_parametro, a.dt_conta, e.dt_periodo_inicial, e.dt_periodo_final, 'N',e.ie_tipo_atend_conta,e.nr_interno_conta,'DF',CASE WHEN d.ie_tipo_material='1' THEN '3' WHEN d.ie_tipo_material=ie_tipo_material THEN '2' WHEN d.ie_tipo_material='2' THEN ie_tipo_material WHEN d.ie_tipo_material='3' THEN '2'  ELSE '3' END ,null)),ds_versao_w) dt_periodo_final,
		'N' ie_procedimento,
		null cd_procedimento,
		null ie_origem_proced,
		a.ds_prestador_tiss,
		null ie_beneficiario,
		0 ie_agrupar_desp_pacote,
		CASE WHEN ie_reducao_acres_w='TD' THEN tiss_obter_pr_desc(a.nr_sequencia)  ELSE 0 END  pr_desconto,
		null,
		a.nr_sequencia,
		a.ie_responsavel_credito,
		a.cd_medico_exec_tiss,
		CASE WHEN ie_reducao_acres_w='EM' THEN obter_indice_preco_proc(a.nr_sequencia)  ELSE null END  tx_ajuste_mat, --lhalves OS265289 em 18/11/2010 - Gerar o indice de ajuste da tabela para as taxas
		(null)::numeric ,
		a.cd_prestador_solic_tiss,
		a.ds_prestador_solic_tiss,
		a.cd_medico_honor_tiss cd_medico_honor_tiss,
		a.cd_medico_executor cd_medico_executor,
		CASE WHEN ie_senha_guia_w='PM' THEN a.cd_senha  ELSE null END  cd_senha,
		'036' cd_unidade_medida_tiss, --OS 806839 em 29/10/2014
		'S' ie_regra_pacote,
		null nr_registro_anvisa_tiss,
		null cd_fabricante,
		'N' ie_codigo_tuss,
		a.nr_seq_tiss_tabela,
		null cd_cgc_fornec_opme,
		null nr_seq_proc_crit_hor,
		CASE WHEN ie_setor_exec_mat_w='S' THEN a.cd_setor_atendimento  ELSE null END  cd_setor_atendimento
	from	procedimento_paciente a,
		atendimento_pacote b,
		pacote_tipo_acomodacao g,
		pacote_tipo_acomod_tiss c,
		material d,
		conta_paciente e,
		atendimento_paciente f	
	where	a.nr_seq_proc_pacote	= a.nr_sequencia
	and	a.nr_sequencia		= b.nr_seq_procedimento
	and	a.nr_atendimento	= b.nr_atendimento
	and	b.nr_seq_tipo_acomod	= c.nr_seq_tipo_acomod	
	and	c.nr_seq_tipo_acomod	= g.nr_sequencia
	and	c.cd_material		= d.cd_material
	and	a.nr_interno_conta	= e.nr_interno_conta
	and	e.nr_atendimento	= f.nr_atendimento
	and	a.nr_interno_conta	= nr_interno_conta_p
	and	coalesce(a.cd_motivo_exc_conta::text, '') = '') P
where	ie_desp_agrup_valor_w = 'N'	
group 	by ie_tipo_despesa,
	dt_item,
	CASE WHEN ie_periodo_desp_w='S' THEN  dt_periodo_desp  ELSE CASE WHEN ie_periodo_desp_w='GTDA' THEN  dt_periodo_desp  ELSE CASE WHEN ie_periodo_desp_w='MED' THEN  CASE WHEN ie_tipo_despesa='5' THEN dt_periodo_desp  ELSE null END  WHEN ie_periodo_desp_w='MET' THEN  CASE WHEN ie_tipo_despesa='4' THEN dt_periodo_desp WHEN ie_tipo_despesa='5' THEN dt_periodo_desp  ELSE null END   ELSE null END  END  END ,
	CASE WHEN ie_periodo_desp_w='S' THEN  dt_periodo_final  ELSE CASE WHEN ie_periodo_desp_w='GTDA' THEN  dt_periodo_final  ELSE CASE WHEN ie_periodo_desp_w='MED' THEN CASE WHEN ie_tipo_despesa='5' THEN dt_periodo_desp  ELSE null END  WHEN ie_periodo_desp_w='MET' THEN  CASE WHEN ie_tipo_despesa='4' THEN dt_periodo_desp WHEN ie_tipo_despesa='5' THEN dt_periodo_desp  ELSE null END   ELSE null END  END  END ,
	cd_edicao_amb,
	ds_procedimento,
	cd_procedimento,
	ie_origem_proced,
	cd_autorizacao,
	cd_proc_convenio,
	cd_cgc_prestador_tiss,
	ie_tiss_tipo_guia_desp,
	ie_tipo_atendimento,
	cd_prestador_tiss,
	vl_reducao_acrescimo,
	cd_cgc_prest_solic_tiss,
	ie_tiss_desp_honor,
	ds_prestador_tiss,
	ie_procedimento,
	ie_beneficiario_med,
	ie_agrupar_desp_pacote,
	pr_desconto,
	nr_seq_regra_ajuste_mat,
	ie_responsavel_credito,
	cd_medico_exec_tiss,
	tx_ajuste_mat,
	vl_unit_original,
	cd_prestador_solic_tiss,
	ds_prestador_solic_tiss,
	cd_medico_honor_tiss,
	cd_medico_executor,
	cd_senha,
	cd_unidade_medida_tiss,
	ie_regra_pacote,
	nr_registro_anvisa_tiss,
	cd_fabricante,
	ie_codigo_tuss,
	nr_seq_tiss_tabela,
	cd_cgc_fornec_opme,
	nr_seq_proc_crit_hor,
	CASE WHEN ie_setor_exec_mat_w='S' THEN p.cd_setor_atendimento  ELSE null END 

union	all

select	ie_tipo_despesa,
	sum(vl_item),
	dt_item,
	sum(qt_item),
	cd_edicao_amb,
	ds_procedimento,
	cd_autorizacao,
	cd_proc_convenio,
	cd_cgc_prestador_tiss,
	ie_tiss_tipo_guia_desp,
	ie_tipo_atendimento,
	vl_unitario,
	cd_prestador_tiss,
	cd_cgc_prest_solic_tiss,
	vl_reducao_acrescimo,
	ie_tiss_desp_honor,
	CASE WHEN ie_periodo_desp_w='S' THEN  dt_periodo_desp  ELSE CASE WHEN ie_periodo_desp_w='GTDA' THEN  dt_periodo_desp  ELSE CASE WHEN ie_periodo_desp_w='MED' THEN  CASE WHEN ie_tipo_despesa='5' THEN dt_periodo_desp  ELSE null END  WHEN ie_periodo_desp_w='MET' THEN  CASE WHEN ie_tipo_despesa='4' THEN dt_periodo_desp WHEN ie_tipo_despesa='5' THEN dt_periodo_desp  ELSE null END   ELSE null END  END  END ,
	CASE WHEN ie_periodo_desp_w='S' THEN  dt_periodo_final  ELSE CASE WHEN ie_periodo_desp_w='GTDA' THEN  dt_periodo_final  ELSE CASE WHEN ie_periodo_desp_w='MED' THEN CASE WHEN ie_tipo_despesa='5' THEN dt_periodo_desp  ELSE null END  WHEN ie_periodo_desp_w='MET' THEN  CASE WHEN ie_tipo_despesa='4' THEN dt_periodo_desp WHEN ie_tipo_despesa='5' THEN dt_periodo_desp  ELSE null END   ELSE null END  END  END ,
	ie_procedimento,
	cd_procedimento,
	ie_origem_proced,
	ds_prestador_tiss,
	ie_beneficiario_med,
	ie_agrupar_desp_pacote,
	pr_desconto,
	nr_seq_regra_ajuste_mat,
	ie_responsavel_credito,
	cd_medico_exec_tiss,
	tx_ajuste_mat,
	vl_unit_original,
	max(dt_periodo_desp),
	max(dt_periodo_final),
	cd_prestador_solic_tiss,
	ds_prestador_solic_tiss,
	cd_medico_honor_tiss,
	cd_medico_executor,
	cd_senha,
	cd_unidade_medida_tiss,
	ie_regra_pacote,
	nr_registro_anvisa_tiss,
	cd_fabricante,
	ie_codigo_tuss,
	nr_seq_tiss_tabela,
	cd_cgc_fornec_opme,
	nr_seq_proc_crit_hor,
	CASE WHEN ie_setor_exec_mat_w='S' THEN cd_setor_atendimento  ELSE null END  cd_setor_atendimento
from	(
	select	ie_tiss_tipo_despesa ie_tipo_despesa,
		CASE WHEN ie_valor_desconto_w='N' THEN  coalesce(a.vl_material_tiss, a.vl_material)  ELSE TISS_OBTER_MAT_ATEND_PAC_VALOR(a.nr_sequencia) END  vl_item,
		ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(tiss_obter_dt_despesa(e.cd_estabelecimento, c.cd_convenio, a.dt_conta, e.dt_periodo_inicial, e.dt_periodo_final, 'S',e.ie_tipo_atend_conta,e.nr_interno_conta,'D',ie_tiss_tipo_despesa,a.cd_material)) dt_item,
		(TISS_OBTER_REGRA_CAMPO_PROC(CASE WHEN coalesce(TISS_OBTER_REGRA_QTDE_MAT(a.nr_sequencia),ie_conversao_qtde_mat_w)='M' THEN (TISS_OBTER_QTD_MAT(a.nr_sequencia,ie_qtd_material_w) * CASE WHEN coalesce(f.tx_conversao_qtde,0)=0 THEN 1  ELSE f.tx_conversao_qtde END ) WHEN coalesce(TISS_OBTER_REGRA_QTDE_MAT(a.nr_sequencia),ie_conversao_qtde_mat_w)='R' THEN (round(TISS_OBTER_QTD_MAT(a.nr_sequencia,ie_qtd_material_w) * CASE WHEN coalesce(f.tx_conversao_qtde,0)=0 THEN 1  ELSE f.tx_conversao_qtde END )) WHEN coalesce(TISS_OBTER_REGRA_QTDE_MAT(a.nr_sequencia),ie_conversao_qtde_mat_w)='D' THEN (dividir_sem_round(TISS_OBTER_QTD_MAT(a.nr_sequencia,ie_qtd_material_w), CASE WHEN coalesce(f.tx_conversao_qtde,0)=0 THEN 1  ELSE f.tx_conversao_qtde END )) WHEN coalesce(TISS_OBTER_REGRA_QTDE_MAT(a.nr_sequencia),ie_conversao_qtde_mat_w)='S' THEN (ceil(TISS_OBTER_QTD_MAT(a.nr_sequencia,ie_qtd_material_w) * CASE WHEN coalesce(f.tx_conversao_qtde,0)=0 THEN 1  ELSE f.tx_conversao_qtde END )) END ,
							 '2', c.cd_convenio, e.cd_estabelecimento, null, null, a.cd_material, e.cd_categoria_parametro, cd_plano_convenio_w,d.ie_tipo_atendimento,ie_carater_internacao_w, ie_tiss_tipo_guia_w))::numeric  qt_item,
		coalesce(tiss_obter_codigo_tabela(a.nr_seq_tiss_tabela),'00') CD_EDICAO_AMB,
		substr(TISS_ELIMINAR_CARACTERE(coalesce(a.ds_material_tiss, coalesce(f.ds_material,b.ds_material))),1,150) ds_procedimento,
		coalesce(a.nr_doc_convenio, ds_nao_informada_w) cd_autorizacao,
		coalesce(a.cd_material_tiss,
				TISS_OBTER_COD_MAT(a.cd_material_convenio, e.cd_estabelecimento,  a.cd_material, a.dt_conta,
								tiss_obter_origem_preco_mat(a.ie_origem_preco,
												a.cd_material,
												e.cd_estabelecimento,
												e.cd_convenio_parametro,
												e.cd_categoria_parametro, a.cd_tab_preco_material, a.dt_conta,a.cd_setor_atendimento, 'X',a.nr_seq_proc_pacote,a.nr_sequencia, a.cd_material_tuss),
														e.cd_convenio_parametro)) cd_proc_convenio,
		coalesce(a.cd_cgc_prestador_tiss, a.cd_cgc_prestador) cd_cgc_prestador_tiss,
		ie_tiss_tipo_guia_desp,
		d.ie_tipo_atendimento,
		a.vl_unitario,
		a.cd_prestador_tiss,
		a.cd_cgc_prest_solic_tiss,
		(TISS_OBTER_REGRA_CAMPO_PROC(a.tx_material, '1', c.cd_convenio, e.cd_estabelecimento, null, null, a.cd_material, e.cd_categoria_parametro, cd_plano_convenio_w,d.ie_tipo_atendimento,ie_carater_internacao_w, ie_tiss_tipo_guia_w))::numeric  vl_reducao_acrescimo,
		a.ie_tiss_desp_honor,
		TISS_OBTER_DT_PER_DESP(ie_periodo_desp_w, ie_tiss_tipo_despesa, tiss_obter_dt_despesa(e.cd_estabelecimento, c.cd_convenio, a.dt_conta, e.dt_periodo_inicial, e.dt_periodo_final, 'S',e.ie_tipo_atend_conta,e.nr_interno_conta,'DI',ie_tiss_tipo_despesa,a.cd_material),ds_versao_w) dt_periodo_desp,
		TISS_OBTER_DT_PER_DESP(ie_periodo_desp_w, ie_tiss_tipo_despesa, tiss_obter_dt_despesa(e.cd_estabelecimento, c.cd_convenio, a.dt_conta, e.dt_periodo_inicial, e.dt_periodo_final, 'S',e.ie_tipo_atend_conta,e.nr_interno_conta,'DF',ie_tiss_tipo_despesa,a.cd_material),ds_versao_w) dt_periodo_final,
		'N' ie_procedimento,
		(null)::numeric  cd_procedimento,
		(null)::numeric  ie_origem_proced,
		a.ds_prestador_tiss,
		null ie_beneficiario_med,
		CASE WHEN coalesce(a.nr_seq_proc_pacote, 0)=0 THEN  0  ELSE CASE WHEN IE_AGRUPAR_DESP_PAC_w='N' THEN  a.nr_sequencia  ELSE 0 END  END  ie_agrupar_desp_pacote,
		CASE WHEN ie_reducao_acres_w='TD' THEN tiss_obter_pr_desc_mat(a.nr_sequencia)  ELSE 0 END  pr_desconto,
		CASE WHEN ie_reducao_acres_w='AM' THEN  nr_seq_regra_ajuste_mat  ELSE null END  nr_seq_regra_ajuste_mat,
		a.nr_sequencia,
		null ie_responsavel_credito,	-- Edgar 24/06/2009, OS 150179, tieri o responsavel credito pois nao e tratado qdo e material
		a.cd_medico_exec_tiss,
		CASE WHEN ie_reducao_acres_w='EM' THEN  coalesce(obter_indice_preco_material(a.nr_sequencia),0) WHEN ie_reducao_acres_w='AM' THEN  coalesce(obter_indice_preco_material(a.nr_sequencia),0)  ELSE null END  tx_ajuste_mat,
		CASE WHEN ie_valor_unitario_w='D' THEN dividir(dividir(a.vl_material, coalesce(obter_indice_preco_material_2(a.nr_sequencia),1)), 						dividir(TISS_OBTER_QTD_MAT(a.nr_sequencia,ie_qtd_material_w),CASE WHEN coalesce(f.tx_conversao_qtde,0)=0 THEN 1  ELSE f.tx_conversao_qtde END ))  ELSE null END   vl_unit_original,
		a.cd_prestador_solic_tiss,
		a.ds_prestador_solic_tiss,
		null cd_medico_honor_tiss,
		null cd_medico_executor,
		CASE WHEN ie_senha_guia_w='PM' THEN a.cd_senha  ELSE null END  cd_senha,
		CASE WHEN ie_versao_3_w='S' THEN tiss_obter_unidade_medida(coalesce(coalesce(f.cd_unidade_medida,a.cd_unid_medida_conv),a.cd_unidade_medida))  ELSE null END  cd_unidade_medida_tiss,
		'N' ie_regra_pacote,
		CASE WHEN ie_versao_3_w='S' THEN a.nr_registro_anvisa_tiss  ELSE null END  nr_registro_anvisa_tiss,
		CD_MATERIAL_FABRICANTE cd_fabricante,
		null ie_codigo_tuss,
		a.nr_seq_tiss_tabela,
		CASE WHEN ie_versao_3_w='S' THEN CASE WHEN ie_tiss_tipo_despesa='8' THEN substr(( select obter_fornecedor_ultima_compra(a.cd_material,e.cd_estabelecimento) ),1,20)  ELSE null END   ELSE null END  cd_cgc_fornec_opme,
		null nr_seq_proc_crit_hor,
		CASE WHEN ie_setor_exec_mat_w='S' THEN a.cd_setor_atendimento  ELSE null END  cd_setor_atendimento
	FROM subgrupo_material j, classe_material i, conta_paciente e, atendimento_paciente d, convenio c, material b, material_atend_paciente a
LEFT OUTER JOIN mat_atend_pac_tiss t ON (a.nr_sequencia = t.nr_seq_material)
LEFT OUTER JOIN mat_atend_pac_convenio f ON (a.nr_sequencia = f.nr_seq_material)
WHERE a.cd_material			= b.cd_material  and a.nr_interno_conta		= nr_interno_conta_p and c.cd_convenio			= a.cd_convenio and a.nr_atendimento		= d.nr_atendimento and i.cd_subgrupo_material		= j.cd_subgrupo_material and coalesce(a.cd_motivo_exc_conta::text, '') = '' and a.nr_interno_conta		= e.nr_interno_conta  and ((coalesce(a.nr_seq_proc_pacote::text, '') = '') or
 		 (ie_pacote_w = 'I' AND a.nr_seq_proc_pacote IS NOT NULL AND a.nr_seq_proc_pacote::text <> '') or (ie_pacote_w = 'A')) and b.cd_classe_material		= i.cd_classe_material and ie_material_exec_w		= 'N' --	and	((nvl(i.IE_TIPO_CLASSE,'X') not in ('O','P','M')) and	--Edgar 16/01/2009, OS 123077, troquei o tratamento da classe pelo tratamento de ie_tiss_tipo_despesa
  and ((a.ie_tiss_tipo_despesa in ('1','2','3','4','5','6') or (obter_se_projeto_versao(0,12,ds_versao_w,0) = 'S')) and
		 ((TISS_OBTER_REGRA_MAT_OPM(e.cd_convenio_parametro, e.cd_estabelecimento, b.cd_material, b.cd_classe_material,
					  i.cd_subgrupo_material, j.cd_grupo_material, d.ie_tipo_atendimento,a.vl_unitario) not in ('S') or (obter_se_projeto_versao(0,12,ds_versao_w,0) = 'S')) and (TISS_OBTER_REGRA_MAT_OPM(e.cd_convenio_parametro, e.cd_estabelecimento, b.cd_material, b.cd_classe_material,
					  i.cd_subgrupo_material, j.cd_grupo_material, d.ie_tipo_atendimento,a.vl_unitario) not in ('RI','SADT'))			  
		)) and ((TISS_OBTER_SE_PACOTE_ACOMOD(a.nr_interno_conta) = 'N') or (coalesce(a.nr_seq_proc_pacote::text, '') = ''))
	 
union all
 /*Gerar itens pelo Material Informado da conta (CD_MATERIAL_EXEC)*/
	select	ie_tiss_tipo_despesa ie_tipo_despesa,
		CASE WHEN ie_valor_desconto_w='N' THEN  coalesce(a.vl_material_tiss, a.vl_material)  ELSE TISS_OBTER_MAT_ATEND_PAC_VALOR(a.nr_sequencia) END  vl_item,
		ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(tiss_obter_dt_despesa(e.cd_estabelecimento, c.cd_convenio, a.dt_conta, e.dt_periodo_inicial, e.dt_periodo_final, 'S',e.ie_tipo_atend_conta,e.nr_interno_conta,'D',ie_tiss_tipo_despesa,a.cd_material)) dt_item,
		(TISS_OBTER_REGRA_CAMPO_PROC(CASE WHEN coalesce(TISS_OBTER_REGRA_QTDE_MAT(a.nr_sequencia),ie_conversao_qtde_mat_w)='M' THEN (TISS_OBTER_QTD_MAT(a.nr_sequencia,ie_qtd_material_w) * CASE WHEN coalesce(f.tx_conversao_qtde,0)=0 THEN 1  ELSE f.tx_conversao_qtde END ) WHEN coalesce(TISS_OBTER_REGRA_QTDE_MAT(a.nr_sequencia),ie_conversao_qtde_mat_w)='R' THEN (round(TISS_OBTER_QTD_MAT(a.nr_sequencia,ie_qtd_material_w) * CASE WHEN coalesce(f.tx_conversao_qtde,0)=0 THEN 1  ELSE f.tx_conversao_qtde END )) WHEN coalesce(TISS_OBTER_REGRA_QTDE_MAT(a.nr_sequencia),ie_conversao_qtde_mat_w)='D' THEN (dividir_sem_round(TISS_OBTER_QTD_MAT(a.nr_sequencia,ie_qtd_material_w), CASE WHEN coalesce(f.tx_conversao_qtde,0)=0 THEN 1  ELSE f.tx_conversao_qtde END )) WHEN coalesce(TISS_OBTER_REGRA_QTDE_MAT(a.nr_sequencia),ie_conversao_qtde_mat_w)='S' THEN (round(TISS_OBTER_QTD_MAT(a.nr_sequencia,ie_qtd_material_w) * CASE WHEN coalesce(f.tx_conversao_qtde,0)=0 THEN 1  ELSE f.tx_conversao_qtde END )) END ,
							 '2', c.cd_convenio, e.cd_estabelecimento, null, null, coalesce(a.cd_material_exec,a.cd_material), e.cd_categoria_parametro, cd_plano_convenio_w,d.ie_tipo_atendimento,ie_carater_internacao_w, ie_tiss_tipo_guia_w))::numeric  qt_item,
		coalesce(tiss_obter_codigo_tabela(a.nr_seq_tiss_tabela),'00') CD_EDICAO_AMB,
		substr(TISS_ELIMINAR_CARACTERE(coalesce(a.ds_material_tiss, coalesce(f.ds_material,b.ds_material))),1,150) ds_procedimento,
		coalesce(a.nr_doc_convenio, ds_nao_informada_w) cd_autorizacao,
		coalesce(a.cd_material_tiss,
				TISS_OBTER_COD_MAT(a.cd_material_convenio, e.cd_estabelecimento,  coalesce(a.cd_material_exec,a.cd_material), a.dt_conta,
								tiss_obter_origem_preco_mat(a.ie_origem_preco,
												coalesce(a.cd_material_exec,a.cd_material),
												e.cd_estabelecimento,
												e.cd_convenio_parametro,
												e.cd_categoria_parametro, a.cd_tab_preco_material, a.dt_conta,a.cd_setor_atendimento, 'X',a.nr_seq_proc_pacote,a.nr_sequencia, a.cd_material_tuss),
														e.cd_convenio_parametro)) cd_proc_convenio,
		coalesce(a.cd_cgc_prestador_tiss, a.cd_cgc_prestador) cd_cgc_prestador_tiss,
		ie_tiss_tipo_guia_desp,
		d.ie_tipo_atendimento,
		a.vl_unitario,
		a.cd_prestador_tiss,
		a.cd_cgc_prest_solic_tiss,
		(TISS_OBTER_REGRA_CAMPO_PROC(a.tx_material, '1', c.cd_convenio, e.cd_estabelecimento, null, null, coalesce(a.cd_material_exec,a.cd_material), e.cd_categoria_parametro, cd_plano_convenio_w,d.ie_tipo_atendimento,ie_carater_internacao_w, ie_tiss_tipo_guia_w))::numeric  vl_reducao_acrescimo,
		a.ie_tiss_desp_honor,
		TISS_OBTER_DT_PER_DESP(ie_periodo_desp_w, ie_tiss_tipo_despesa, tiss_obter_dt_despesa(e.cd_estabelecimento, c.cd_convenio, a.dt_conta, e.dt_periodo_inicial, e.dt_periodo_final, 'S',e.ie_tipo_atend_conta,e.nr_interno_conta,'DI',ie_tiss_tipo_despesa,a.cd_material),ds_versao_w) dt_periodo_desp,
		TISS_OBTER_DT_PER_DESP(ie_periodo_desp_w, ie_tiss_tipo_despesa, tiss_obter_dt_despesa(e.cd_estabelecimento, c.cd_convenio, a.dt_conta, e.dt_periodo_inicial, e.dt_periodo_final, 'S',e.ie_tipo_atend_conta,e.nr_interno_conta,'DF',ie_tiss_tipo_despesa,a.cd_material),ds_versao_w) dt_periodo_final,
		'N' ie_procedimento,
		(null)::numeric  cd_procedimento,
		(null)::numeric  ie_origem_proced,
		a.ds_prestador_tiss,
		null ie_beneficiario_med,
		CASE WHEN coalesce(a.nr_seq_proc_pacote, 0)=0 THEN  0  ELSE CASE WHEN IE_AGRUPAR_DESP_PAC_w='N' THEN  a.nr_sequencia  ELSE 0 END  END  ie_agrupar_desp_pacote,
		CASE WHEN ie_reducao_acres_w='TD' THEN tiss_obter_pr_desc_mat(a.nr_sequencia)  ELSE 0 END  pr_desconto,
		CASE WHEN ie_reducao_acres_w='AM' THEN  nr_seq_regra_ajuste_mat  ELSE null END  nr_seq_regra_ajuste_mat,
		a.nr_sequencia,
		null ie_responsavel_credito,	-- Edgar 24/06/2009, OS 150179, tieri o responsavel credito pois nao e tratado qdo e material
		a.cd_medico_exec_tiss,
		CASE WHEN ie_reducao_acres_w='EM' THEN  coalesce(obter_indice_preco_material(a.nr_sequencia),0) WHEN ie_reducao_acres_w='AM' THEN  coalesce(obter_indice_preco_material(a.nr_sequencia),0)  ELSE null END  tx_ajuste_mat,
		CASE WHEN ie_valor_unitario_w='D' THEN dividir(dividir(a.vl_material, coalesce(obter_indice_preco_material_2(a.nr_sequencia),1)), 						dividir(TISS_OBTER_QTD_MAT(a.nr_sequencia,ie_qtd_material_w),CASE WHEN coalesce(f.tx_conversao_qtde,0)=0 THEN 1  ELSE f.tx_conversao_qtde END ))  ELSE null END   vl_unit_original,
		a.cd_prestador_solic_tiss,
		a.ds_prestador_solic_tiss,
		null cd_medico_honor_tiss,
		null cd_medico_executor,
		CASE WHEN ie_senha_guia_w='PM' THEN a.cd_senha  ELSE null END  cd_senha,
		CASE WHEN ie_versao_3_w='S' THEN tiss_obter_unidade_medida(coalesce(coalesce(f.cd_unidade_medida,a.cd_unid_medida_conv),a.cd_unidade_medida))  ELSE null END  cd_unidade_medida_tiss,
		'N' ie_regra_pacote,
		CASE WHEN ie_versao_3_w='S' THEN a.nr_registro_anvisa_tiss  ELSE null END  nr_registro_anvisa_tiss,
		CD_MATERIAL_FABRICANTE cd_fabricante,
		null ie_codigo_tuss,
		a.nr_seq_tiss_tabela,
		CASE WHEN ie_versao_3_w='S' THEN substr(( select obter_fornecedor_ultima_compra(a.cd_material,e.cd_estabelecimento) ),1,20)  ELSE null END  cd_cgc_fornec_opme,
		null nr_seq_proc_crit_hor,
		CASE WHEN ie_setor_exec_mat_w='S' THEN a.cd_setor_atendimento  ELSE null END  cd_setor_atendimento
	FROM subgrupo_material j, classe_material i, conta_paciente e, atendimento_paciente d, convenio c, material b, material_atend_paciente a
LEFT OUTER JOIN mat_atend_pac_tiss t ON (a.nr_sequencia = t.nr_seq_material)
LEFT OUTER JOIN mat_atend_pac_convenio f ON (a.nr_sequencia = f.nr_seq_material)
WHERE coalesce(a.cd_material_exec,a.cd_material)	= b.cd_material and a.nr_interno_conta			= nr_interno_conta_p  and c.cd_convenio				= a.cd_convenio and a.nr_atendimento			= d.nr_atendimento and i.cd_subgrupo_material			= j.cd_subgrupo_material and coalesce(a.cd_motivo_exc_conta::text, '') = '' and a.nr_interno_conta			= e.nr_interno_conta  and ((coalesce(a.nr_seq_proc_pacote::text, '') = '') or
 		 (ie_pacote_w = 'I' AND a.nr_seq_proc_pacote IS NOT NULL AND a.nr_seq_proc_pacote::text <> '') or (ie_pacote_w = 'A')) and b.cd_classe_material			= i.cd_classe_material and ie_material_exec_w			= 'S' and ((a.ie_tiss_tipo_despesa in ('1','2','3','4','5','6') or (obter_se_projeto_versao(0,12,ds_versao_w,0) = 'S')) and
		 ((TISS_OBTER_REGRA_MAT_OPM(e.cd_convenio_parametro, e.cd_estabelecimento, b.cd_material, b.cd_classe_material,
					  i.cd_subgrupo_material, j.cd_grupo_material, d.ie_tipo_atendimento,a.vl_unitario) not in ('S') or (obter_se_projeto_versao(0,12,ds_versao_w,0) = 'S')) and (TISS_OBTER_REGRA_MAT_OPM(e.cd_convenio_parametro, e.cd_estabelecimento, b.cd_material, b.cd_classe_material,
					  i.cd_subgrupo_material, j.cd_grupo_material, d.ie_tipo_atendimento,a.vl_unitario) not in ('RI','SADT'))			  
		)) and ((TISS_OBTER_SE_PACOTE_ACOMOD(a.nr_interno_conta) = 'N') or (coalesce(a.nr_seq_proc_pacote::text, '') = ''))
	 
union all

	select	a.ie_tiss_tipo_despesa ie_tipo_despesa,
		CASE WHEN ie_valor_desconto_w='N' THEN  coalesce(a.vl_desp_tiss, a.vl_procedimento)  ELSE coalesce(a.vl_desp_tiss, a.vl_procedimento) + coalesce(obter_desconto_matproc(a.nr_sequencia,'P'),0) END  vl_item,
		ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(tiss_obter_dt_despesa(e.cd_estabelecimento, c.cd_convenio, a.dt_conta, e.dt_periodo_inicial, e.dt_periodo_final, 'T',e.ie_tipo_atend_conta,e.nr_interno_conta,'D',a.ie_tiss_tipo_despesa,null)) dt_item,
		(TISS_OBTER_REGRA_CAMPO_PROC(CASE WHEN tiss_obter_regra_qtde_proc(a.nr_sequencia)='M' THEN (a.qt_procedimento * CASE WHEN coalesce(h.tx_conversao_qtde,0)=0 THEN 1  ELSE h.tx_conversao_qtde END ) WHEN tiss_obter_regra_qtde_proc(a.nr_sequencia)='R' THEN (round(a.qt_procedimento * CASE WHEN coalesce(h.tx_conversao_qtde,0)=0 THEN 1  ELSE h.tx_conversao_qtde END )) WHEN tiss_obter_regra_qtde_proc(a.nr_sequencia)='D' THEN (dividir_sem_round(a.qt_procedimento, CASE WHEN coalesce(h.tx_conversao_qtde,0)=0 THEN 1  ELSE h.tx_conversao_qtde END )) WHEN tiss_obter_regra_qtde_proc(a.nr_sequencia)='S' THEN (round(a.qt_procedimento * CASE WHEN coalesce(h.tx_conversao_qtde,0)=0 THEN 1  ELSE h.tx_conversao_qtde END )) END ,     
		'2', c.cd_convenio, e.cd_estabelecimento, a.cd_procedimento, a.ie_origem_proced, null, e.cd_categoria_parametro, cd_plano_convenio_w,d.ie_tipo_atendimento,ie_carater_internacao_w, ie_tiss_tipo_guia_w))::numeric  qt_item,
		coalesce(tiss_obter_codigo_tabela(a.nr_seq_tiss_tabela),'00') CD_EDICAO_AMB,		
		substr(TISS_ELIMINAR_CARACTERE(coalesce(tiss_obter_campo_esp(e.cd_convenio_parametro,
									h.cd_estabelecimento,
									'DS_DESPESA',
									null,
									coalesce(h.ds_procedimento, b.ds_procedimento),
									null,
									OBTER_CLASSIF_SETOR(a.cd_setor_atendimento),
									null,
									null,
									null,
									OBTER_TIPO_PROTOCOLO(e.nr_seq_protocolo),
									OBTER_TIPO_GUIA_CONVENIO(e.nr_interno_conta),
									Obter_Valor_Conv_Estab(c.cd_convenio, h.cd_estabelecimento, 'CD_REGIONAL'),
									null,
									a.cd_procedimento,
									a.ie_origem_proced,
									a.cd_setor_atendimento,
									d.ie_tipo_atendimento,
									a.cd_cgc_prestador,
									a.ie_responsavel_credito,
									null,
									e.nr_interno_conta, 
									a.nr_prescricao, 
									null, 
									null, 
									a.cd_procedimento_convenio,
									null,
									null),
						coalesce(a.ds_proc_tiss, TISS_OBTER_DESC_TUSS_DESP(a.nr_sequencia)))),1,60) ds_procedimento,
		coalesce(a.nr_doc_convenio, ds_nao_informada_w) cd_autorizacao,
		TISS_OBTER_REGRA_CODIGO_DESP(	e.cd_estabelecimento,
						e.cd_convenio_parametro,
						a.ie_tiss_tipo_despesa,
						coalesce(substr(tiss_obter_tabela(a.cd_edicao_amb,
										e.cd_estabelecimento,
										e.cd_convenio_parametro,
										e.cd_categoria_parametro,
										a.dt_conta,
										'C',
										b.ie_classificacao,
										a.cd_procedimento,
										a.ie_origem_proced,
										a.nr_sequencia,
										a.nr_seq_proc_pacote,
										d.nr_atendimento,
										a.nr_seq_proc_interno,
										a.nr_seq_exame,
										a.cd_procedimento_tuss),1,20),						
										coalesce(	coalesce(	TISS_OBTER_COD_TUSS_DESP(a.nr_sequencia), 
												a.cd_procedimento_convenio), 
											to_char(a.cd_procedimento))),
						null,
						CASE WHEN coalesce(a.cd_procedimento_tuss,0)=0 THEN 'N'  ELSE 'S' END , --ie_codigo_tuss_p
						a.nr_seq_tiss_tabela,
						null,
						a.cd_procedimento,
						a.ie_origem_proced) cd_proc_convenio,
		coalesce(a.cd_cgc_prestador_tiss, a.cd_cgc_prestador)  cd_cgc_prestador_tiss,
		ie_tiss_tipo_guia_desp,
		d.ie_tipo_atendimento,
		dividir_sem_round(coalesce(a.vl_desp_tiss, a.vl_procedimento), a.qt_procedimento) vl_unitario,
		a.cd_prestador_tiss,
		a.cd_cgc_prest_solic_tiss,
		(TISS_OBTER_REGRA_CAMPO_PROC(a.tx_procedimento,  '1', c.cd_convenio, e.cd_estabelecimento, a.cd_procedimento, a.ie_origem_proced, null, e.cd_categoria_parametro, cd_plano_convenio_w,d.ie_tipo_atendimento,ie_carater_internacao_w, ie_tiss_tipo_guia_w))::numeric  vl_reducao_acrescimo,
		a.ie_tiss_desp_honor,
		TISS_OBTER_DT_PER_DESP(ie_periodo_desp_w, a.ie_tiss_tipo_despesa, coalesce(TISS_OBTER_DATA_PROC(a.nr_sequencia, e.cd_convenio_parametro, d.ie_tipo_atendimento, 'S', 'I'),
							     tiss_obter_dt_despesa(e.cd_estabelecimento, c.cd_convenio, a.dt_conta, e.dt_periodo_inicial, e.dt_periodo_final, 'N',e.ie_tipo_atend_conta,e.nr_interno_conta,'DI',a.ie_tiss_tipo_despesa,null)),ds_versao_w) dt_periodo_desp,
		TISS_OBTER_DT_PER_DESP(ie_periodo_desp_w, a.ie_tiss_tipo_despesa, coalesce(TISS_OBTER_DATA_PROC(a.nr_sequencia, e.cd_convenio_parametro, d.ie_tipo_atendimento, 'S', 'F'),
							     tiss_obter_dt_despesa(e.cd_estabelecimento, c.cd_convenio, a.dt_conta, e.dt_periodo_inicial, e.dt_periodo_final, 'N',e.ie_tipo_atend_conta,e.nr_interno_conta,'DF',a.ie_tiss_tipo_despesa,null)),ds_versao_w) dt_periodo_final,
		'S' ie_procedimento,
		null cd_procedimento, --a.cd_procedimento, Retirado pois nao era utilizado e gerava erro de agrupamento
		a.ie_origem_proced,
		a.ds_prestador_tiss,
		null ie_beneficiario_med,
		CASE WHEN coalesce(a.nr_seq_proc_pacote, 0)=0 THEN  0  ELSE CASE WHEN IE_AGRUPAR_DESP_PAC_w='N' THEN  a.nr_sequencia  ELSE 0 END  END  ie_agrupar_desp_pacote,
		CASE WHEN ie_reducao_acres_w='TD' THEN tiss_obter_pr_desc(a.nr_sequencia)  ELSE 0 END  pr_desconto,
		null,
		a.nr_sequencia,
		a.ie_responsavel_credito,
		a.cd_medico_exec_tiss,
		CASE WHEN ie_reducao_acres_w='EM' THEN obter_indice_preco_proc(nr_sequencia)  ELSE null END  tx_ajuste_mat, --lhalves OS265289 em 18/11/2010 - Gerar o indice de ajuste da tabela para as taxas
		(null)::numeric ,
		a.cd_prestador_solic_tiss,
		a.ds_prestador_solic_tiss,
		a.cd_medico_honor_tiss cd_medico_honor_tiss,
		a.cd_medico_executor cd_medico_executor,
		CASE WHEN ie_senha_guia_w='PM' THEN a.cd_senha  ELSE null END  cd_senha,
		CASE WHEN ie_versao_3_w='S' THEN tiss_obter_unidade_medida(coalesce(h.cd_unidade_medida,obter_unid_med_Servico(e.cd_convenio_parametro, e.cd_categoria_parametro, a.cd_procedimento, a.ie_origem_proced, d.cd_estabelecimento)))  ELSE null END  cd_unidade_medida_tiss,
		'N' ie_regra_pacote,
		null nr_registro_anvisa_tiss,
		null cd_fabricante,
		CASE WHEN ie_versao_3_w='S' THEN CASE WHEN coalesce(a.cd_procedimento_tuss,0)=0 THEN 'N'  ELSE 'S' END   ELSE 'N' END  ie_codigo_tuss,
		a.nr_seq_tiss_tabela,
		null cd_cgc_fornec_opme,
		a.nr_seq_proc_crit_hor,
		CASE WHEN ie_setor_exec_mat_w='S' THEN a.cd_setor_atendimento  ELSE null END  cd_setor_atendimento
	FROM conta_paciente e, atendimento_paciente d, convenio c, procedimento b, procedimento_paciente a
LEFT OUTER JOIN regra_honorario f ON (a.ie_responsavel_credito = f.cd_regra)
LEFT OUTER JOIN proc_paciente_convenio h ON (a.nr_sequencia = h.nr_seq_procedimento)
WHERE a.cd_procedimento		= b.cd_procedimento and a.ie_origem_proced	= b.ie_origem_proced and c.cd_convenio		= a.cd_convenio and a.nr_atendimento		= d.nr_atendimento   and a.ie_tiss_tipo_guia		= '7' and (a.ie_tiss_tipo_despesa		not in ('7','8','9') or (obter_se_projeto_versao(0,12,ds_versao_w,0) = 'S')) and a.nr_interno_conta		= e.nr_interno_conta and (((ie_pacote_w = 'P') and (coalesce(a.nr_seq_proc_pacote, a.nr_sequencia) = a.nr_sequencia)) or
		 ((ie_pacote_w = 'I') and (coalesce(a.nr_seq_proc_pacote, 0) <> a.nr_sequencia)) or (ie_pacote_w = 'A')) and coalesce(a.cd_motivo_exc_conta::text, '') = '' and e.cd_estabelecimento		= h.cd_estabelecimento and e.nr_interno_conta		= nr_interno_conta_p and ((TISS_OBTER_SE_PACOTE_ACOMOD(a.nr_interno_conta) = 'N') or (coalesce(a.nr_seq_proc_pacote::text, '') = ''))
	 
union all

	select	CASE WHEN to_char(b.ie_tipo_item)='1' THEN '3'  ELSE to_char(b.ie_tipo_item) END , /*lhalves OS 359972 em 13/09/2011*/
		a.vl_item,
		ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(x.dt_referencia) dt_item,
		a.qt_item,
		substr(coalesce(c.nr_seq_tiss_tabela,0),1,255) CD_EDICAO_AMB,
		substr(b.ds_item, 1, 60) ds_procedimento,
		coalesce(a.cd_guia, ds_nao_informada_w) cd_autorizacao,
		c.cd_item_convenio cd_proc_convenio,
		x.cd_cgc cd_cgc_prestador,
		'2' ie_tiss_tipo_guia_desp,
		(null)::numeric  ie_tipo_atendimento,
		dividir_sem_round(a.vl_item, a.qt_item) vl_unitario,
		null cd_prestador_tiss,
		null cd_cgc_prest_solic_tiss,
		(CASE WHEN IE_FORMATO_RED_ACRES_w='V' THEN  null  ELSE 1 END )::numeric  vl_reducao_acrescimo,
		null ie_tiss_desp_honor,
		e.dt_entrada dt_periodo_desp,
		e.dt_entrada dt_periodo_final,
		'N' ie_procedimento,
		(null)::numeric  cd_procedimento,
		(null)::numeric  ie_origem_proced,
		null ds_prestador_tiss,
		x.ie_beneficiario,
		0 ie_agrupar_desp_pacote,
		tiss_obter_pr_desc_mat(a.nr_sequencia) pr_desconto,
		null,
		a.nr_sequencia,
		null ie_responsavel_credito,
		null,
		1 tx_ajuste_mat,
		(null)::numeric ,
		null,
		null,
		null,
		null,
		null,
		'036' cd_unidade_medida_tiss,
		'N' ie_regra_pacote,
		null nr_registro_anvisa_tiss,
		null cd_fabricante,
		'N' ie_codigo_tuss,
		c.nr_seq_tiss_tabela,
		null cd_cgc_fornec_opme,
		null nr_seq_proc_crit_hor,
		null cd_setor_atendimento
	from	med_prot_convenio x,
		med_item_convenio c,
		med_atendimento e,
		med_item b,
		med_faturamento a
	where	a.nr_seq_item		= b.nr_sequencia
	and	b.nr_sequencia		= c.nr_seq_item
	and	c.nr_seq_plano		= e.nr_seq_plano
	and	e.nr_atendimento		= a.nr_atendimento
	and	a.nr_seq_protocolo		= x.nr_sequencia
	and	b.ie_tipo_item		<> 3
	and	x.ie_tipo_guia		<> 'C'
	and	a.nr_atendimento		= nr_atend_med_p
	and	a.nr_seq_protocolo		= nr_seq_prot_med_p
	
union all

	/*OS 542682 Itens da regra de pacote*/

	select	CASE WHEN d.ie_tipo_despesa_tiss='4' THEN '7'  ELSE d.ie_tipo_despesa_tiss END  ie_tipo_despesa_tiss,
		coalesce(c.vl_total_item,0) * coalesce(tiss_obter_qt_proc_pacote(e.nr_interno_conta,g.cd_procedimento),1),
		a.dt_procedimento dt_item,
		coalesce(tiss_obter_qt_proc_pacote(e.nr_interno_conta,g.cd_procedimento),1) qt_item,
		substr(TISS_OBTER_CODIGO_TABELA(coalesce(c.nr_seq_tiss_tabela,a.nr_seq_tiss_tabela)),1,255) CD_EDICAO_AMB,
		substr(d.ds_procedimento, 1, 60) ds_procedimento,
		coalesce(a.nr_doc_convenio, ds_nao_informada_w) cd_autorizacao,
		to_char(c.cd_procedimento) cd_proc_convenio,
		a.cd_cgc_prestador cd_cgc_prestador,
		coalesce((select max(ie_tiss_tipo_guia_desp)
		from	material_atend_paciente x
		where	x.nr_interno_conta	= a.nr_interno_conta
		and	coalesce(x.cd_motivo_exc_conta::text, '') = ''),CASE WHEN e.ie_tipo_atend_conta=1 THEN '5'  ELSE '4' END ) ie_tiss_tipo_guia_desp,
		f.ie_tipo_atendimento ie_tipo_atendimento,
		coalesce(c.vl_total_item,0) vl_unitario,
		a.cd_prestador_tiss,
		a.cd_cgc_prest_solic_tiss,
		1 vl_reducao_acrescimo,
		null ie_tiss_desp_honor,
		TISS_OBTER_DT_PER_DESP(ie_periodo_desp_w, d.ie_tipo_despesa_tiss, coalesce(TISS_OBTER_DATA_PROC(a.nr_sequencia, e.cd_convenio_parametro, f.ie_tipo_atendimento, 'S', 'I'),
								     tiss_obter_dt_despesa(e.cd_estabelecimento, e.cd_convenio_parametro, a.dt_conta, e.dt_periodo_inicial, e.dt_periodo_final, 'N',e.ie_tipo_atend_conta,e.nr_interno_conta,'DI',d.ie_tipo_despesa_tiss,null)),ds_versao_w) dt_periodo_desp,
		TISS_OBTER_DT_PER_DESP(ie_periodo_desp_w, d.ie_tipo_despesa_tiss, coalesce(TISS_OBTER_DATA_PROC(a.nr_sequencia, e.cd_convenio_parametro, f.ie_tipo_atendimento, 'S', 'F'),
								     tiss_obter_dt_despesa(e.cd_estabelecimento, e.cd_convenio_parametro, a.dt_conta, e.dt_periodo_inicial, e.dt_periodo_final, 'N',e.ie_tipo_atend_conta,e.nr_interno_conta,'DF',d.ie_tipo_despesa_tiss,null)),ds_versao_w) dt_periodo_final,
		'S' ie_procedimento,
		null cd_procedimento,
		c.ie_origem_proced ie_origem_proced,
		a.ds_prestador_tiss,
		null ie_beneficiario,
		0 ie_agrupar_desp_pacote,
		CASE WHEN ie_reducao_acres_w='TD' THEN tiss_obter_pr_desc(a.nr_sequencia)  ELSE 0 END  pr_desconto,
		null,
		a.nr_sequencia,
		a.ie_responsavel_credito,
		a.cd_medico_exec_tiss,
		CASE WHEN ie_reducao_acres_w='EM' THEN obter_indice_preco_proc(a.nr_sequencia)  ELSE null END  tx_ajuste_mat, --lhalves OS265289 em 18/11/2010 - Gerar o indice de ajuste da tabela para as taxas
		(null)::numeric ,
		a.cd_prestador_solic_tiss,
		a.ds_prestador_solic_tiss,
		a.cd_medico_honor_tiss cd_medico_honor_tiss,
		a.cd_medico_executor cd_medico_executor,
		CASE WHEN ie_senha_guia_w='PM' THEN a.cd_senha  ELSE null END  cd_senha,
		'036' cd_unidade_medida_tiss, --OS 806839 em 29/10/2014
		'S' ie_regra_pacote,
		null nr_registro_anvisa_tiss,
		null cd_fabricante,
		CASE WHEN ie_versao_3_w='S' THEN CASE WHEN coalesce(a.cd_procedimento_tuss,0)=0 THEN 'N'  ELSE 'S' END   ELSE 'N' END  ie_codigo_tuss,
		a.nr_seq_tiss_tabela,
		null  cd_cgc_fornec_opme,
		null nr_seq_proc_crit_hor,
		CASE WHEN ie_setor_exec_mat_w='S' THEN a.cd_setor_atendimento  ELSE null END  cd_setor_atendimento
	from	procedimento_paciente a,
		atendimento_pacote b,
		pacote_tipo_acomodacao g,
		pacote_tipo_acomod_tiss c,
		procedimento d,
		conta_paciente e,
		atendimento_paciente f
	where	a.nr_seq_proc_pacote	= a.nr_sequencia
	and	a.nr_sequencia		= b.nr_seq_procedimento
	and	a.nr_atendimento	= b.nr_atendimento
	and	b.nr_seq_tipo_acomod	= c.nr_seq_tipo_acomod	
	and	c.cd_procedimento	= d.cd_procedimento
	and	c.nr_seq_tipo_acomod	= g.nr_sequencia
	and	c.ie_origem_proced	= d.ie_origem_proced
	and	a.nr_interno_conta	= e.nr_interno_conta
	and	d.ie_classificacao	<> '1'
	and	e.nr_atendimento	= f.nr_atendimento
	and	a.nr_interno_conta	= nr_interno_conta_p
	and	coalesce(a.cd_motivo_exc_conta::text, '') = ''
	
union all

	/*OS 542682 Itens da regra de pacote*/

	select	CASE WHEN d.ie_tipo_material='1' THEN '3' WHEN d.ie_tipo_material=ie_tipo_material THEN '2' WHEN d.ie_tipo_material='2' THEN ie_tipo_material WHEN d.ie_tipo_material='3' THEN '2'  ELSE '3' END   ie_tipo_despesa_tiss,
		coalesce(c.vl_total_item,0) * coalesce(tiss_obter_qt_proc_pacote(e.nr_interno_conta,g.cd_procedimento),1),
		a.dt_procedimento dt_item,
		coalesce(tiss_obter_qt_proc_pacote(e.nr_interno_conta,g.cd_procedimento),1) qt_item,
		substr(TISS_OBTER_CODIGO_TABELA(coalesce(c.nr_seq_tiss_tabela,a.nr_seq_tiss_tabela)),1,255) CD_EDICAO_AMB,
		substr(d.ds_material, 1, 150) ds_procedimento,
		coalesce(a.nr_doc_convenio, ds_nao_informada_w) cd_autorizacao,
		to_char(c.cd_material) cd_proc_convenio,
		a.cd_cgc_prestador cd_cgc_prestador,
		coalesce((select max(ie_tiss_tipo_guia_desp)
		from	material_atend_paciente x
		where	x.nr_interno_conta	= a.nr_interno_conta
		and	coalesce(x.cd_motivo_exc_conta::text, '') = ''),CASE WHEN e.ie_tipo_atend_conta=1 THEN '5'  ELSE '4' END ) ie_tiss_tipo_guia_desp,
		f.ie_tipo_atendimento ie_tipo_atendimento,
		dividir(coalesce(c.vl_total_item,0),coalesce(tiss_obter_qt_proc_pacote(e.nr_interno_conta,g.cd_procedimento),1)) vl_unitario,
		a.cd_prestador_tiss,
		a.cd_cgc_prest_solic_tiss,
		1 vl_reducao_acrescimo,
		null ie_tiss_desp_honor,
		TISS_OBTER_DT_PER_DESP(ie_periodo_desp_w, CASE WHEN d.ie_tipo_material='1' THEN '3' WHEN d.ie_tipo_material=ie_tipo_material THEN '2' WHEN d.ie_tipo_material='2' THEN ie_tipo_material WHEN d.ie_tipo_material='3' THEN '2'  ELSE '3' END , coalesce(TISS_OBTER_DATA_PROC(a.nr_sequencia, e.cd_convenio_parametro, f.ie_tipo_atendimento, 'S', 'I'),
								     tiss_obter_dt_despesa(e.cd_estabelecimento, e.cd_convenio_parametro, a.dt_conta, e.dt_periodo_inicial, e.dt_periodo_final, 'N',e.ie_tipo_atend_conta,e.nr_interno_conta,'DI',CASE WHEN d.ie_tipo_material='1' THEN '3' WHEN d.ie_tipo_material=ie_tipo_material THEN '2' WHEN d.ie_tipo_material='2' THEN ie_tipo_material WHEN d.ie_tipo_material='3' THEN '2'  ELSE '3' END ,null)),ds_versao_w) dt_periodo_desp,
		TISS_OBTER_DT_PER_DESP(ie_periodo_desp_w, CASE WHEN d.ie_tipo_material='1' THEN '3' WHEN d.ie_tipo_material=ie_tipo_material THEN '2' WHEN d.ie_tipo_material='2' THEN ie_tipo_material WHEN d.ie_tipo_material='3' THEN '2'  ELSE '3' END , coalesce(TISS_OBTER_DATA_PROC(a.nr_sequencia, e.cd_convenio_parametro, f.ie_tipo_atendimento, 'S', 'F'),
								     tiss_obter_dt_despesa(e.cd_estabelecimento, e.cd_convenio_parametro, a.dt_conta, e.dt_periodo_inicial, e.dt_periodo_final, 'N',e.ie_tipo_atend_conta,e.nr_interno_conta,'DF',CASE WHEN d.ie_tipo_material='1' THEN '3' WHEN d.ie_tipo_material=ie_tipo_material THEN '2' WHEN d.ie_tipo_material='2' THEN ie_tipo_material WHEN d.ie_tipo_material='3' THEN '2'  ELSE '3' END ,null)),ds_versao_w) dt_periodo_final,
		'N' ie_procedimento,
		null cd_procedimento,
		null ie_origem_proced,
		a.ds_prestador_tiss,
		null ie_beneficiario,
		0 ie_agrupar_desp_pacote,
		CASE WHEN ie_reducao_acres_w='TD' THEN tiss_obter_pr_desc(a.nr_sequencia)  ELSE 0 END  pr_desconto,
		null,
		a.nr_sequencia,
		a.ie_responsavel_credito,
		a.cd_medico_exec_tiss,
		CASE WHEN ie_reducao_acres_w='EM' THEN obter_indice_preco_proc(a.nr_sequencia)  ELSE null END  tx_ajuste_mat, --lhalves OS265289 em 18/11/2010 - Gerar o indice de ajuste da tabela para as taxas
		(null)::numeric ,
		a.cd_prestador_solic_tiss,
		a.ds_prestador_solic_tiss,
		a.cd_medico_honor_tiss cd_medico_honor_tiss,
		a.cd_medico_executor cd_medico_executor,
		CASE WHEN ie_senha_guia_w='PM' THEN a.cd_senha  ELSE null END  cd_senha,
		'036' cd_unidade_medida_tiss, --OS 806839 em 29/10/2014
		'S' ie_regra_pacote,
		null nr_registro_anvisa_tiss,
		null cd_fabricante,
		'N' ie_codigo_tuss,
		a.nr_seq_tiss_tabela,
		null cd_cgc_fornec_opme,
		null nr_seq_proc_crit_hor,
		CASE WHEN ie_setor_exec_mat_w='S' THEN a.cd_setor_atendimento  ELSE null END  cd_setor_atendimento
	from	procedimento_paciente a,
		atendimento_pacote b,
		pacote_tipo_acomodacao g,
		pacote_tipo_acomod_tiss c,
		material d,
		conta_paciente e,
		atendimento_paciente f	
	where	a.nr_seq_proc_pacote	= a.nr_sequencia
	and	a.nr_sequencia		= b.nr_seq_procedimento
	and	a.nr_atendimento	= b.nr_atendimento
	and	b.nr_seq_tipo_acomod	= c.nr_seq_tipo_acomod	
	and	c.nr_seq_tipo_acomod	= g.nr_sequencia
	and	c.cd_material		= d.cd_material
	and	a.nr_interno_conta	= e.nr_interno_conta
	and	e.nr_atendimento	= f.nr_atendimento
	and	a.nr_interno_conta	= nr_interno_conta_p
	and	coalesce(a.cd_motivo_exc_conta::text, '') = '') P	
where	ie_desp_agrup_valor_w = 'S'	
group 	by ie_tipo_despesa,
	dt_item,
	CASE WHEN ie_periodo_desp_w='S' THEN  dt_periodo_desp  ELSE CASE WHEN ie_periodo_desp_w='GTDA' THEN  dt_periodo_desp  ELSE CASE WHEN ie_periodo_desp_w='MED' THEN  CASE WHEN ie_tipo_despesa='5' THEN dt_periodo_desp  ELSE null END  WHEN ie_periodo_desp_w='MET' THEN  CASE WHEN ie_tipo_despesa='4' THEN dt_periodo_desp WHEN ie_tipo_despesa='5' THEN dt_periodo_desp  ELSE null END   ELSE null END  END  END ,
	CASE WHEN ie_periodo_desp_w='S' THEN  dt_periodo_final  ELSE CASE WHEN ie_periodo_desp_w='GTDA' THEN  dt_periodo_final  ELSE CASE WHEN ie_periodo_desp_w='MED' THEN CASE WHEN ie_tipo_despesa='5' THEN dt_periodo_desp  ELSE null END  WHEN ie_periodo_desp_w='MET' THEN  CASE WHEN ie_tipo_despesa='4' THEN dt_periodo_desp WHEN ie_tipo_despesa='5' THEN dt_periodo_desp  ELSE null END   ELSE null END  END  END ,
	cd_edicao_amb,
	ds_procedimento,
	cd_procedimento,
	ie_origem_proced,
	cd_autorizacao,
	cd_proc_convenio,
	cd_cgc_prestador_tiss,
	ie_tiss_tipo_guia_desp,
	ie_tipo_atendimento,
	vl_unitario,
	cd_prestador_tiss,
	vl_reducao_acrescimo,
	cd_cgc_prest_solic_tiss,
	ie_tiss_desp_honor,
	ds_prestador_tiss,
	ie_procedimento,
	ie_beneficiario_med,
	ie_agrupar_desp_pacote,
	pr_desconto,
	nr_seq_regra_ajuste_mat,
	ie_responsavel_credito,
	cd_medico_exec_tiss,
	tx_ajuste_mat,
	vl_unit_original,
	cd_prestador_solic_tiss,
	ds_prestador_solic_tiss,
	cd_medico_honor_tiss,
	cd_medico_executor,
	cd_senha,
	cd_unidade_medida_tiss,
	ie_regra_pacote,
	nr_registro_anvisa_tiss,
	cd_fabricante,
	ie_codigo_tuss,
	nr_seq_tiss_tabela,
	cd_cgc_fornec_opme,
	nr_seq_proc_crit_hor,
	CASE WHEN ie_setor_exec_mat_w='S' THEN p.cd_setor_atendimento  ELSE null END;

BEGIN

ds_nao_informada_w := substr(obter_desc_expressao(778770),1,20);

begin
select	b.cd_cgc,
	a.cd_convenio_parametro,
	a.cd_estabelecimento,
	a.cd_categoria_parametro,
	a.nr_atendimento,
	a.ie_tipo_atend_tiss,
	a.dt_mesano_referencia
into STRICT	cd_cgc_estab_w,
	cd_convenio_w,
	cd_estabelecimento_w,
	cd_categoria_conv_w,
	nr_atendimento_w,
	ie_tipo_atend_tiss_w,
	dt_mesano_referencia_w
from	estabelecimento b,
	conta_paciente a
where	a.nr_interno_conta 	= nr_interno_conta_p
and	a.cd_estabelecimento	= b.cd_estabelecimento;
exception
when others then
	cd_cgc_estab_w		:= null;
	cd_convenio_w		:= null;
	cd_estabelecimento_w	:= null;
	cd_categoria_conv_w	:= null;
	nr_atendimento_w	:= null;
	ie_tipo_atend_tiss_w	:= null;
end;

select	coalesce(max(ie_despesa_zerada),'S'),
	coalesce(max(ie_arredondamento_desp), 'N'),
	coalesce(max(ie_digitos_desp), 'N'),
	max(qt_max_despesa),
	coalesce(max(ie_periodo_desp), 'N'),
	coalesce(max(ie_valor_desconto), 'N'),
	coalesce(max(IE_FORMATO_RED_ACRES), 'V'),
	coalesce(max(IE_AGRUPAR_DESP_PAC),'S'),
	coalesce(max(ie_valor_unitario),'C'),
	coalesce(max(ie_reducao_acresc),'TH'),
	coalesce(max(ie_conversao_qtde_mat), 'M'),
	coalesce(max(ie_pacote),'P'),
	coalesce(max(ie_proc_tuss), 'N'),
	coalesce(max(ie_senha_guia),'ACA'),
	coalesce(max(ie_guia_desp_med),'N'),
	coalesce(max(ie_material_exec),'N'),
	coalesce(max(ie_qtd_material),'M'),
	coalesce(max(ie_desp_agrup_valor),'N'),
	coalesce(max(ie_setor_exec_mat),'N')	
into STRICT	ie_despesa_zerada_w,
	ie_arredondamento_desp_w,
	ie_digitos_desp_w,
	qt_max_despesa_w,
	ie_periodo_desp_w,
	ie_valor_desconto_w,
	IE_FORMATO_RED_ACRES_w,
	IE_AGRUPAR_DESP_PAC_w,
	ie_valor_unitario_w,
	ie_reducao_acres_w,
	ie_conversao_qtde_mat_w,
	ie_pacote_w,
	ie_proc_tuss_w,
	ie_senha_guia_w,
	ie_guia_desp_med_w,
	ie_material_exec_w,
	ie_qtd_material_w,
	ie_desp_agrup_valor_w,
	ie_setor_exec_mat_w
from	tiss_parametros_convenio
where	cd_estabelecimento	= cd_estabelecimento_w
and	cd_convenio		= cd_convenio_w;

begin
ds_versao_w	:= tiss_obter_versao(cd_convenio_w, cd_estabelecimento_w,dt_mesano_referencia_w);
exception
when others then
	ds_versao_w	:= null;
end;

ie_versao_3_w	:= 'N';
if (obter_se_projeto_versao(0,12,ds_versao_w,0) = 'S') then
	ie_versao_3_w	:= 'S';
end if;

if (coalesce(ds_versao_w, '2.01.02') = '2.01.02') then
	qt_maxima_w	:= 999;
else
	qt_maxima_w	:= 99999999;
end if;

/*OS88490 - 04/04/2008 - Parametro para poder definir a quantidade maxima por despesa na guia. */

if ((qt_max_despesa_w IS NOT NULL AND qt_max_despesa_w::text <> '') and qt_max_despesa_w > 0) then
	qt_maxima_w	:= qt_max_despesa_w;
end if;

if (coalesce(nr_interno_conta_p,0)	> 0) then

	begin
		ie_clinica_w := (obter_clinica_atend(nr_atendimento_w, 'C'))::numeric;	
	exception
	when others then
		ie_clinica_w := null;
	end;

	begin
		nr_seq_classif_atend_w 	:= (Obter_Classificacao_Atend(nr_atendimento_w,'C'))::numeric;
	exception
	when others then
		nr_seq_classif_atend_w	:= null;
	end;

	begin
		cd_setor_entrada_w	:= obter_setor_atendimento(nr_atendimento_w);
	exception
	when others then
		cd_setor_entrada_w	:= null;
	end;

	begin	
	select	b.cd_plano_convenio
	into STRICT	cd_plano_convenio_w
	from	atend_categoria_convenio b,
		atendimento_paciente a
	where	a.nr_atendimento	= b.nr_atendimento
	and	b.nr_seq_interno	= obter_atecaco_atendimento(a.nr_atendimento)	
	and	a.nr_atendimento	= nr_atendimento_w  LIMIT 1;
	exception
	when others then
		cd_plano_convenio_w	:= null;
	end;

	select	max(ie_carater_internacao)
	into STRICT	ie_carater_internacao_w
	from	tiss_conta_atend
	where	nr_interno_conta	= nr_interno_conta_p;	

end if;

ie_tiss_tipo_guia_w		:= '7';

for c01_row in c01 loop
	ie_tipo_despesa_w := c01_row.ie_tipo_despesa;
	vl_item_w := c01_row.vl_item;
	dt_item_w := c01_row.dt_item;
	qt_item_w := c01_row.qt_item;
	cd_edicao_amb_w := c01_row.cd_edicao_amb;
	ds_procedimento_w := c01_row.ds_procedimento;
	cd_autorizacao_w := c01_row.cd_autorizacao;
	cd_proc_convenio_w := c01_row.cd_proc_convenio;
	cd_cgc_prestador_tiss_w := c01_row.cd_cgc_prestador_tiss;
	ie_tiss_tipo_guia_desp_w := c01_row.ie_tiss_tipo_guia_desp;
	ie_tipo_atendimento_w := c01_row.ie_tipo_atendimento;
	vl_unitario_w := c01_row.vl_unitario;
	cd_prestador_tiss_w := c01_row.cd_prestador_tiss;
	cd_cgc_prest_solic_tiss_w := c01_row.cd_cgc_prest_solic_tiss;
	vl_reducao_acrescimo_w := c01_row.vl_reducao_acrescimo;
	ie_tiss_desp_honor_w := c01_row.ie_tiss_desp_honor;
	dt_periodo_desp_w := c01_row.dt_periodo_desp;
	dt_periodo_final_w := c01_row.dt_periodo_final;
	ie_procedimento_w := c01_row.ie_procedimento;
	cd_procedimento_w := c01_row.cd_procedimento;
	ie_origem_proced_w := c01_row.ie_origem_proced;
	ds_prestador_tiss_w := c01_row.ds_prestador_tiss;
	ie_beneficiario_med_w := c01_row.ie_beneficiario_med;
	ie_agrupar_desp_pacote_w := c01_row.ie_agrupar_desp_pacote;
	pr_desconto_w := c01_row.pr_desconto;
	nr_seq_regra_ajuste_mat_w := c01_row.nr_seq_regra_ajuste_mat;
	ie_responsavel_credito_w := c01_row.ie_responsavel_credito;
	cd_medico_exec_tiss_w := c01_row.cd_medico_exec_tiss;
	tx_ajuste_mat_w := c01_row.tx_ajuste_mat;
	vl_unit_original_w := c01_row.vl_unit_original;
	dt_periodo_desp_max_w := c01_row.dt_periodo_desp_max;
	dt_periodo_final_max_w := c01_row.dt_periodo_final_max;
	cd_prestador_solic_w := c01_row.cd_prestador_solic_tiss;
	ds_prestador_solic_w := c01_row.ds_prestador_solic_tiss;
	cd_medico_honor_tiss_w := c01_row.cd_medico_honor_tiss;
	cd_medico_executor_w := c01_row.cd_medico_executor;
	cd_senha_desp_w := c01_row.cd_senha;
	cd_unidade_medida_tiss_w := c01_row.cd_unidade_medida_tiss;
	ie_regra_pacote_w := c01_row.ie_regra_pacote;
	nr_registro_anvisa_w := c01_row.nr_registro_anvisa_tiss;
	cd_fabricante_w := c01_row.cd_fabricante;	
	ie_codigo_tuss_w := c01_row.ie_codigo_tuss;
	nr_seq_tiss_tabela_w := c01_row.nr_seq_tiss_tabela;
	cd_cgc_fornec_opme_w := c01_row.cd_cgc_fornec_opme;
	nr_seq_proc_crit_hor_w := c01_row.nr_seq_proc_crit_hor;
	cd_setor_exec_mat_w := c01_row.cd_setor_atendimento;

	ie_xml_w	:= 'S';

	--dsantos em 18/09/2009, OS 163448 - era gerada guia sadt apenas com valor material, e nao havia tratamento do material para pegar a senha da autorizacao,

	--por isso a guia era emitida sem senha.		
	if (ie_senha_guia_w		<> 'P') and (coalesce(nr_interno_conta_p,0)	> 0) then

		begin
		select	count(1)
		into STRICT	cont_w
		from	autorizacao_convenio a
		where	a.nr_atendimento	= nr_atendimento_w
		and	a.cd_autorizacao	= cd_autorizacao_w  LIMIT 1;
		exception
		when others then
			cont_w	:= 0;
		end;		

		if (cont_w > 0) then
			select	max(a.cd_senha)
			into STRICT	cd_senha_w
			from	autorizacao_convenio a
			where	a.nr_atendimento	= nr_atendimento_w
			and	a.cd_autorizacao	= cd_autorizacao_w
			and	a.nr_sequencia		=
				(SELECT		max(x.nr_sequencia)
				from		autorizacao_convenio x
				where		x.nr_atendimento		= a.nr_atendimento
				and		x.cd_autorizacao		= a.cd_autorizacao
				and		dt_item_w between coalesce(x.dt_inicio_vigencia,dt_item_w) and coalesce(x.dt_fim_vigencia,dt_item_w));
		end if;

	end if;

	if (ie_senha_guia_w = 'PM') and (cd_senha_desp_w IS NOT NULL AND cd_senha_desp_w::text <> '') then
		cd_senha_w	:= cd_senha_desp_w;
	end if;

	if	(cd_medico_honor_tiss_w IS NOT NULL AND cd_medico_honor_tiss_w::text <> '' AND ie_guia_desp_med_w = 'S') then
		cd_medico_exec_tiss_w	:= cd_medico_honor_tiss_w;
	end if;

	if (cd_medico_exec_tiss_w IS NOT NULL AND cd_medico_exec_tiss_w::text <> '') then
		cd_cgc_prestador_tiss_w	:= null;
		cd_cgc_estab_w		:= null;
	end if;

	if (coalesce(ie_origem_proced_w::text, '') = '') then
		SELECT * FROM TISS_OBTER_REGRA_VALOR_PROC(cd_estabelecimento_w, cd_convenio_w, '7', cd_cgc_prestador_tiss_w, ie_responsavel_credito_w, null, null, null, null, vl_unitario_w, vl_item_w, ie_regra_valor_w, qt_item_w, null, null, 'N', null, cd_plano_convenio_w, dt_item_w, null) INTO STRICT vl_item_w, ie_regra_valor_w;
	end if;

	-- Edgar 23/08/2007, os 62514, tratar arredontamento
	if (ie_arredondamento_desp_w = 'S') then
		vl_unitario_w	:= round((vl_unitario_w)::numeric, 2);
		vl_item_w	:= vl_unitario_w * qt_item_w;
	else
		if	((ie_valor_unitario_w in ('C','E')) or			
	 		 ((ie_valor_unitario_w = 'D') and (coalesce(vl_unit_original_w::text, '') = ''))) then
			vl_unitario_w	:= dividir_sem_round(vl_item_w, qt_item_w);
		elsif (ie_valor_unitario_w = 'D') then
			vl_unitario_w 	:= vl_unit_original_w;
		end if;
	end if;

	/*lhalves OS229572 em 07/07/2010 - gerar sempre o maior horario para as despesas do mesmo dia, para agrupar mesmo com horario diferente*/

	if (ie_periodo_desp_w = 'M') then
		dt_periodo_desp_w	:= dt_periodo_desp_max_w;
		dt_periodo_final_w	:= dt_periodo_final_max_w;	
	elsif (ie_periodo_desp_w = 'MED') and --Sempre maior horario (exceto Diarias)
		(ie_tipo_despesa_w <> '5') then	 --Diarias		
		dt_periodo_desp_w	:= dt_periodo_desp_max_w;
		dt_periodo_final_w	:= dt_periodo_final_max_w;
	elsif (ie_periodo_desp_w = 'MET') and --Sem maior horario (exceto Diarias e Taxas)
		(ie_tipo_despesa_w not in ('4','5')) then --Taxas e Diarias
		dt_periodo_desp_w	:= dt_periodo_desp_max_w;
		dt_periodo_final_w	:= dt_periodo_final_max_w;	
	end if;

	if (ie_despesa_zerada_w in ('S','XOU','XE')) or
		(((vl_item_w <> 0) or (qt_item_w <> 0)) and (ie_despesa_zerada_w = 'N')) or
		(vl_item_w <> 0 AND qt_item_w <> 0 AND ie_despesa_zerada_w = 'VQ') then

		/*lhalves OS 683624 em 27/12/2013 - Tratamento para nao enviar despesa zerada somente no XML*/

		if (ie_despesa_zerada_w in ('XOU','XE')) then
			ie_xml_w	:= 'N';
		end if;

		if (ie_despesa_zerada_w = 'XOU') and (vl_item_w <> 0 or qt_item_w <> 0) then
			ie_xml_w	:= 'S';
		elsif (ie_despesa_zerada_w = 'XE') and (vl_item_w <> 0 and qt_item_w <> 0) then
			ie_xml_w	:= 'S';
		end if;
		/*FIM - lhalves OS 683624 em 27/12/2013*/

		if (cd_proc_convenio_w = '0') then
			cd_proc_convenio_w	:= null;
		end if;

		/* Retirei a consistencia de hora = 00:00:00 pois este horario pode ser gerado no relatorio e tambem no XML*/

		dt_hora_item_w	:= dt_periodo_desp_w;
		dt_hora_final_w	:= dt_periodo_final_w;


		vl_reducao_acrescimo_w	:= (tiss_obter_regra_campo(ie_tiss_tipo_guia_w, 'VL_REDUCAO_ACRESCIMO', CD_CONVENIO_W, vl_reducao_acrescimo_w, ie_tipo_atendimento_w, cd_categoria_conv_w, ie_tipo_despesa_w,0, cd_estabelecimento_w, ie_clinica_w, nr_seq_classif_atend_w, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@',cd_setor_exec_mat_w))::numeric;
		if (coalesce(vl_reducao_acrescimo_w,0) <> 0) then
			vl_reducao_acrescimo_w	:= tiss_obter_formato_red_acresc(cd_convenio_w, cd_estabelecimento_w, vl_reducao_acrescimo_w);
		end if;

		if (ie_regra_pacote_w = 'S') and (cd_proc_convenio_w IS NOT NULL AND cd_proc_convenio_w::text <> '') then

			if (ie_procedimento_w = 'S') then
				SELECT * FROM Converte_Proc_Convenio(	cd_estabelecimento_w, cd_convenio_w, cd_categoria_conv_w, cd_proc_convenio_w, ie_origem_proced_w, null,  --CD_ESPECIALIDADE_MED_P
							cd_medico_executor_w,  --CD_MEDICO_P
							ie_tipo_atendimento_w, dt_item_w, cd_proc_conversao_w, cd_grupo_w, nr_seq_regra_w, cd_setor_entrada_w, null,  --CD_TIPO_ACOMODACAO_P
							null,  --NR_SEQ_PROC_INTERNO_P
							'N', --IE_PACOTE_P
							cd_plano_convenio_w, ie_clinica_w, vl_item_w, null,  --IE_FUNCAO_MEDICO_P
							null,  --CD_TIPO_ACOMOD_CONV_P
							null,  --QT_IDADE_P
							null,  --IE_SEXO_P
							null,  --CD_EMPRESA_REF_P
							null,  --IE_CARATER_INTER_SUS_P
							null,  --NR_SEQ_PACOTE_P
							null,  --NR_SEQ_EXAME_P
							null, null) INTO STRICT cd_proc_conversao_w, cd_grupo_w, nr_seq_regra_w;

				if (coalesce(nr_seq_regra_w,0) > 0) then
					select	coalesce(max(ds_proc_convenio),ds_procedimento_w)
					into STRICT	ds_procedimento_w
					from	conversao_proc_convenio
					where	nr_sequencia	= nr_seq_regra_w;

					cd_proc_convenio_w	:= coalesce(cd_proc_conversao_w,cd_proc_convenio_w);
				end if;

			else

				SELECT * FROM converte_material_convenio(	cd_convenio_w, cd_proc_convenio_w, cd_setor_entrada_w, null,  --CD_TIPO_ACOMODACAO_P
								cd_cgc_prestador_tiss_w, cd_estabelecimento_w, dt_item_w, cd_categoria_conv_w, cd_mat_conversao_w, cd_grupo_w, nr_seq_regra_w, ie_tipo_atendimento_w, null,  --IE_ORIGEM_PRECO_P
								null,  -- CD_EMPRESA_REF_P
								null,  --NR_SEQ_PROC_PACOTE_P
								null,  --IE_CARATER_INTER_SUS_P
								null, ie_tipo_atend_tiss_w, ie_clinica_w,  -- NR_SEQ_MARCA_P
								null) INTO STRICT cd_mat_conversao_w, cd_grupo_w, nr_seq_regra_w;

				if (coalesce(nr_seq_regra_w,0) > 0) then
					select	coalesce(max(ds_material_convenio),ds_procedimento_w)
					into STRICT	ds_procedimento_w
					from	conversao_material_convenio
					where	nr_sequencia	= nr_seq_regra_w;

					cd_proc_convenio_w	:= coalesce(cd_mat_conversao_w,cd_proc_convenio_w);
				end if;
			end if;
		end if;

		cd_proc_convenio_w		:= replace(replace(cd_proc_convenio_w,'-',''),'.','');

		if (ie_digitos_desp_w	= 'N') then
			if (length(trim(both cd_proc_convenio_w)) < 8) then
				cd_proc_convenio_w	:= lpad(trim(both cd_proc_convenio_w), 8, '0');
			end if;
		elsif (ie_digitos_desp_w	= 'S') then
			if (length(trim(both cd_proc_convenio_w)) < 10) then
				cd_proc_convenio_w	:= lpad(trim(both cd_proc_convenio_w), 10, '0');
			end if;
		elsif (ie_digitos_desp_w	= 'M') then
			if (length(trim(both cd_proc_convenio_w)) < 10) then
				if (ie_procedimento_w	= 'N') then
					cd_proc_convenio_w	:= lpad(trim(both cd_proc_convenio_w), 10, '0');
				else
					cd_proc_convenio_w	:= lpad(trim(both cd_proc_convenio_w), 8, '0');
				end if;
			end if;
		elsif (ie_digitos_desp_w	= 'R') then
			if (length(trim(both cd_proc_convenio_w)) < 8) then
				cd_proc_convenio_w	:= substr(lpad(trim(both cd_proc_convenio_w), 8, '0'),1,8);
			elsif (length(trim(both cd_proc_convenio_w)) = 9) then
				cd_proc_convenio_w	:= substr(trim(both cd_proc_convenio_w),2,8);
			elsif (length(trim(both cd_proc_convenio_w)) > 9) then
				cd_proc_convenio_w	:= substr(trim(both cd_proc_convenio_w),3,8);
			end if;
		elsif (ie_digitos_desp_w	= 'D') then /*lhalves OS258181*/
			if (length(trim(both cd_proc_convenio_w)) < 10) then
				if (ie_procedimento_w	= 'S') then
					cd_proc_convenio_w	:= lpad(trim(both cd_proc_convenio_w), 8, ' ');
				else
					cd_proc_convenio_w	:= lpad(trim(both cd_proc_convenio_w), 8, '0');
				end if;
			end if;	
		/* lhalves OS 890560 em 27/07/2015 - agora passa a ser tratado diretamente no c01
		elsif	(ie_digitos_desp_w	= 'I') and --Conforme Regra
			(ie_procedimento_w = 'S') then --Somente para procedimento, pois para material e atualizado o cd_material_tiss na TISS_ATUALIZAR_MATERIAL
			cd_proc_convenio_w	:= TISS_OBTER_REGRA_CODIGO_DESP(cd_estabelecimento_w,cd_convenio_w,ie_tipo_despesa_w,cd_proc_convenio_w, null, ie_codigo_tuss_w, nr_seq_tiss_tabela_w );*/
		end if;

		begin		
			cd_proc_convenio_w	:= tiss_obter_regra_campo(ie_tiss_tipo_guia_w, 'CD_PROCEDIMENTO', CD_CONVENIO_W, cd_proc_convenio_w, ie_tipo_atendimento_w, cd_categoria_conv_w,ie_tipo_despesa_w,0, cd_estabelecimento_w, ie_clinica_w, nr_seq_classif_atend_w, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@',cd_setor_exec_mat_w);
		exception
		when others then
			cd_proc_convenio_w	:= null;
		end;

		if 	((coalesce(nr_atend_med_p,0) > 0) and (coalesce(nr_seq_prot_med_p,0) > 0)) then			
			select	coalesce(max(cd_tabela_xml), '00')
			into STRICT	cd_edicao_amb_w
			from	tiss_tipo_tabela
			where	nr_sequencia		= cd_edicao_amb_w;
		else	

			begin
				cd_edicao_amb_w	:= tiss_obter_regra_campo(ie_tiss_tipo_guia_w, 'CD_EDICAO_AMB', CD_CONVENIO_W, cd_edicao_amb_w, ie_tipo_atendimento_w, cd_categoria_conv_w,ie_tipo_despesa_w,0, cd_estabelecimento_w, ie_clinica_w, nr_seq_classif_atend_w, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@',cd_setor_exec_mat_w);
			exception
			when others then
				cd_edicao_amb_w	:= null;
			end;			
		end if;		

		if (coalesce(cd_cgc_prestador_tiss_w::text, '') = '') then
			cd_cgc_prestador_tiss_w		:= cd_cgc_estab_w;
		end if;

		ie_tiss_desp_honor_w := TISS_OBTER_REGRA_GUIA_DESP(cd_estabelecimento_w, cd_convenio_w, ie_tipo_atendimento_w, ie_tiss_desp_honor_w);

		qt_item_regra_w	:= (tiss_obter_regra_campo('7', 'QT_ITEM', CD_CONVENIO_W, qt_item_w, ie_tipo_atendimento_w, cd_categoria_conv_w, ie_tipo_despesa_w, qt_item_w, cd_estabelecimento_w, ie_clinica_w, nr_seq_classif_atend_w, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@',cd_setor_exec_mat_w))::numeric;
		nr_autor_func_w 	:= '';	
		cd_ref_fabricante_w 	:= '';



		if (ie_tipo_despesa_w = '8') and (ie_versao_3_w = 'S') then

			if (cd_cgc_fornec_opme_w IS NOT NULL AND cd_cgc_fornec_opme_w::text <> '') then

				select	max(a.nr_autor_func)
				into STRICT	nr_autor_func_w
				from	pessoa_juridica a
				where	a.cd_cgc = cd_cgc_fornec_opme_w;

			end if;

			cd_ref_fabricante_w := cd_fabricante_w;

		end if;

		if (qt_item_w < 0) then	-- Edgar 12/10/2007, OS 71325, Gerar valores negativos
			select	nextval('tiss_conta_desp_seq')
			into STRICT	nr_sequencia_w
			;

			-- Edgar 07/08/2007, ja carrega esta variavel no cursor

			-- ie_tiss_tipo_guia_desp_w	:= TISS_OBTER_GUIA_DESP(nr_interno_conta_p, cd_autorizacao_w, cd_cgc_prestador_tiss_w);


			-- Edgar 23/08/2007, os 62514, tratar arredontamento
			if (ie_arredondamento_desp_w = 'S') then
				vl_unitario_w	:= round((vl_unitario_w)::numeric, 2);
				vl_item_w	:= vl_unitario_w * qt_item_w;
			else
				if	((ie_valor_unitario_w = 'C') or
			 		 ((ie_valor_unitario_w = 'D') and (coalesce(vl_unit_original_w::text, '') = ''))) then
					vl_unitario_w	:= dividir_sem_round(vl_item_w, qt_item_w);
				elsif (ie_valor_unitario_w = 'D') then
					vl_unitario_w 	:= vl_unit_original_w;
				end if;
			end if;

			if (ie_reducao_acres_w = 'TD') then
				vl_reducao_acrescimo_w := pr_desconto_w;
			elsif (ie_reducao_acres_w = 'EM') then
				vl_reducao_acrescimo_w := tx_ajuste_mat_w;
			elsif (ie_reducao_acres_w = 'AM') then
				select	max(a.tx_afaturar)
				into STRICT	vl_reducao_acrescimo_w
				from	regra_ajuste_material a
				where	a.nr_sequencia	= nr_seq_regra_ajuste_mat_w;

				if (coalesce(vl_reducao_acrescimo_w::text, '') = '') then
					vl_reducao_acrescimo_w	:= tx_ajuste_mat_w;
				end if;
			end if;

			if (coalesce(nr_seq_prot_med_p,0) > 0) then
				vl_reducao_acrescimo_w	:= 1;
			end if;

			vl_reducao_acrescimo_w	:= (tiss_obter_regra_campo(ie_tiss_tipo_guia_w, 'VL_REDUCAO_ACRESCIMO', CD_CONVENIO_W, vl_reducao_acrescimo_w, ie_tipo_atendimento_w, cd_categoria_conv_w, ie_tipo_despesa_w,0, cd_estabelecimento_w, ie_clinica_w, nr_seq_classif_atend_w, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@',cd_setor_exec_mat_w))::numeric;
			if (coalesce(vl_reducao_acrescimo_w,0) <> 0) and (ie_reducao_acres_w in ('TD','EM','AM')) then
				vl_reducao_acrescimo_w	:= tiss_obter_formato_red_acresc(cd_convenio_w, cd_estabelecimento_w, vl_reducao_acrescimo_w);
			end if;

			/* coloquei o tratamento no insert pois senao ele nao faz o calculo do valor total. 17/12/2007. */


			--vl_unitario_w	:= TO_NUMBER(tiss_obter_regra_campo(ie_tiss_tipo_guia_w, 'VL_UNITARIO', CD_CONVENIO_W, vl_unitario_w, ie_tipo_atendimento_w, cd_categoria_conv_w,ie_tipo_despesa_w,0, ie_clinica_w, nr_seq_classif_atend_w));

			--vl_item_w	:= TO_NUMBER(tiss_obter_regra_campo(ie_tiss_tipo_guia_w, 'VL_ITEM', CD_CONVENIO_W, vl_item_w, ie_tipo_atendimento_w, cd_categoria_conv_w,ie_tipo_despesa_w,0, ie_clinica_w, nr_seq_classif_atend_w));
			dt_hora_item_w := to_date(tiss_obter_regra_campo(ie_tiss_tipo_guia_w, 'DT_HORA_INICIO', CD_CONVENIO_W, to_char(dt_hora_item_w, 'dd/mm/yyyy hh24:mi:ss'), ie_tipo_atendimento_w, cd_categoria_conv_w,ie_tipo_despesa_w,0, cd_estabelecimento_w, ie_clinica_w, nr_seq_classif_atend_w, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@',cd_setor_exec_mat_w), 'dd/mm/yyyy hh24:mi:ss');

			dt_hora_final_w := to_date(tiss_obter_regra_campo(ie_tiss_tipo_guia_w, 'DT_HORA_FIM', CD_CONVENIO_W, to_char(dt_hora_final_w, 'dd/mm/yyyy hh24:mi:ss'), ie_tipo_atendimento_w, cd_categoria_conv_w,ie_tipo_despesa_w,0, cd_estabelecimento_w, ie_clinica_w, nr_seq_classif_atend_w, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@',cd_setor_exec_mat_w), 'dd/mm/yyyy hh24:mi:ss');

			if (coalesce(ie_origem_proced_w::text, '') = '') and (dt_hora_item_w IS NOT NULL AND dt_hora_item_w::text <> '') and (dt_hora_item_w = coalesce(dt_hora_final_w,dt_hora_item_w)) then

				dt_hora_final_w := to_date(tiss_obter_regra_campo_proc(to_char(coalesce(dt_hora_final_w,dt_hora_item_w),'dd/mm/yyyy hh24:mi:ss'), '9', cd_convenio_w, cd_estabelecimento_w, cd_procedimento_w, ie_origem_proced_w, null,cd_categoria_conv_w, cd_plano_convenio_w,ie_tipo_atendimento_w,ie_carater_internacao_w, ie_tiss_tipo_guia_w),'dd/mm/yyyy hh24:mi:ss');

			end if;

			insert	into tiss_Conta_Desp(
				nr_sequencia,
				nr_interno_conta,
				ie_tiss_tipo_guia,
				cd_autorizacao,
				dt_atualizacao,
				nm_usuario,
				ie_tipo_despesa,
				dt_item,
				cd_edicao_amb,
				cd_procedimento,
				ds_procedimento,
				qt_item,
				vl_reducao_acrescimo,
				vl_unitario,
				vl_item,
				cd_cgc_prestador,
				ie_tiss_tipo_guia_desp,
				dt_hora_item,
				cd_prestador_tiss,
				cd_cgc_prest_solic_tiss,
				ie_tiss_desp_honor,
				dt_final,
				ds_prestador_tiss,
				nr_seq_med_fatur,
				ie_contrat_med,
				nr_atend_med,
				nr_seq_prot_med,
				cd_medico_exec_tiss,
				cd_senha,
				cd_prestador_solic_tiss,
				ds_prestador_solic_tiss,
				cd_medico_executor,
				cd_unidade_medida_tiss,
				nr_registro_anvisa,
				ie_xml,
				cd_material_fabricante,
				nr_autor_func_opme,
				cd_setor_execucao)
			values (nr_sequencia_w,
				nr_interno_conta_p,
				ie_tiss_tipo_guia_w,
				cd_autorizacao_w,
				clock_timestamp(),
				nm_usuario_p,
				ie_tipo_despesa_w,
				dt_item_w,
				cd_edicao_amb_w,
				cd_proc_convenio_w,
				ds_procedimento_w,
				qt_item_w,
				vl_reducao_acrescimo_w,
				(tiss_obter_regra_campo(ie_tiss_tipo_guia_w, 'VL_UNITARIO', CD_CONVENIO_W, trunc(vl_unitario_w, 2), ie_tipo_atendimento_w, cd_categoria_conv_w,ie_tipo_despesa_w,0, cd_estabelecimento_w, ie_clinica_w, nr_seq_classif_atend_w, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@',cd_setor_exec_mat_w))::numeric ,
				(tiss_obter_regra_campo(ie_tiss_tipo_guia_w, 'VL_ITEM', CD_CONVENIO_W, vl_item_w, ie_tipo_atendimento_w, cd_categoria_conv_w,ie_tipo_despesa_w,0, cd_estabelecimento_w, ie_clinica_w, nr_seq_classif_atend_w, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@',cd_setor_exec_mat_w))::numeric ,
				cd_cgc_prestador_tiss_w,
				ie_tiss_tipo_guia_desp_w,
				dt_hora_item_w,
				cd_prestador_tiss_w,
				cd_cgc_prest_solic_tiss_w,
				ie_tiss_desp_honor_w,
				dt_hora_final_w,
				ds_prestador_tiss_w,
				nr_seq_med_fatur_p,
				ie_beneficiario_med_w,
				nr_atend_med_p,
				nr_seq_prot_med_p,
				cd_medico_exec_tiss_w,
				cd_senha_w,
				cd_prestador_solic_w,
				ds_prestador_solic_w,
				cd_medico_executor_w,
				cd_unidade_medida_tiss_w,
				nr_registro_anvisa_w,
				ie_xml_w,
				cd_ref_fabricante_w,
				nr_autor_func_w,
				cd_setor_exec_mat_w);

		elsif (qt_item_regra_w	<> qt_item_w) then

			select	nextval('tiss_conta_desp_seq')
			into STRICT	nr_sequencia_w
			;

			-- Edgar 07/08/2007, ja carrega esta variavel no cursor

			-- ie_tiss_tipo_guia_desp_w	:= TISS_OBTER_GUIA_DESP(nr_interno_conta_p, cd_autorizacao_w, cd_cgc_prestador_tiss_w);


			-- Edgar 23/08/2007, os 62514, tratar arredontamento
			if (ie_arredondamento_desp_w = 'S') then
				vl_unitario_w	:= round((vl_unitario_w)::numeric, 2);
				vl_item_w	:= vl_unitario_w * qt_item_w;
			else
				if	((ie_valor_unitario_w = 'C') or
			 		 ((ie_valor_unitario_w = 'D') and (coalesce(vl_unit_original_w::text, '') = ''))) then
					vl_unitario_w	:= dividir_sem_round(vl_item_w, qt_item_regra_w);
				elsif (ie_valor_unitario_w = 'D') then
					vl_unitario_w 	:= vl_unit_original_w;
				end if;
			end if;

			if (ie_reducao_acres_w = 'TD') then
				vl_reducao_acrescimo_w := pr_desconto_w;
			elsif (ie_reducao_acres_w = 'EM') then
				vl_reducao_acrescimo_w := tx_ajuste_mat_w;
			elsif (ie_reducao_acres_w = 'AM') then
				select	max(a.tx_afaturar)
				into STRICT	vl_reducao_acrescimo_w
				from	regra_ajuste_material a
				where	a.nr_sequencia	= nr_seq_regra_ajuste_mat_w;

				if (coalesce(vl_reducao_acrescimo_w::text, '') = '') then
					vl_reducao_acrescimo_w	:= tx_ajuste_mat_w;
				end if;
			end if;

			if (coalesce(nr_seq_prot_med_p,0) > 0) then
				vl_reducao_acrescimo_w	:= 1;
			end if;

			vl_reducao_acrescimo_w	:= (tiss_obter_regra_campo(ie_tiss_tipo_guia_w, 'VL_REDUCAO_ACRESCIMO', CD_CONVENIO_W, vl_reducao_acrescimo_w, ie_tipo_atendimento_w, cd_categoria_conv_w, ie_tipo_despesa_w,0, cd_estabelecimento_w, ie_clinica_w, nr_seq_classif_atend_w, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@',cd_setor_exec_mat_w))::numeric;
			if (coalesce(vl_reducao_acrescimo_w,0) <> 0) and (ie_reducao_acres_w in ('TD','EM','AM')) then
				vl_reducao_acrescimo_w	:= tiss_obter_formato_red_acresc(cd_convenio_w, cd_estabelecimento_w, vl_reducao_acrescimo_w);
			end if;


			--vl_unitario_w	:= TO_NUMBER(tiss_obter_regra_campo(ie_tiss_tipo_guia_w, 'VL_UNITARIO', CD_CONVENIO_W, vl_unitario_w, ie_tipo_atendimento_w, cd_categoria_conv_w,ie_tipo_despesa_w,0, ie_clinica_w, nr_seq_classif_atend_w));

			--vl_item_w	:= TO_NUMBER(tiss_obter_regra_campo(ie_tiss_tipo_guia_w, 'VL_ITEM', CD_CONVENIO_W, vl_item_w, ie_tipo_atendimento_w, cd_categoria_conv_w,ie_tipo_despesa_w,0, ie_clinica_w, nr_seq_classif_atend_w));
			insert	into tiss_Conta_Desp(
				nr_sequencia,
				nr_interno_conta,
				ie_tiss_tipo_guia,
				cd_autorizacao,
				dt_atualizacao,
				nm_usuario,
				ie_tipo_despesa,
				dt_item,
				cd_edicao_amb,
				cd_procedimento,
				ds_procedimento,
				qt_item,
				vl_reducao_acrescimo,
				vl_unitario,
				vl_item,
				cd_cgc_prestador,
				ie_tiss_tipo_guia_desp,
				dt_hora_item,
				cd_prestador_tiss,
				cd_cgc_prest_solic_tiss,
				ie_tiss_desp_honor,
				dt_final,
				ds_prestador_tiss,
				nr_seq_med_fatur,
				ie_contrat_med,
				nr_atend_med,
				nr_seq_prot_med,
				cd_medico_exec_tiss,
				cd_senha,
				cd_prestador_solic_tiss,
				ds_prestador_solic_tiss,
				cd_medico_executor,
				cd_unidade_medida_tiss,
				nr_registro_anvisa,
				ie_xml,
				cd_material_fabricante,
				nr_autor_func_opme,
				cd_setor_execucao)
			values (nr_sequencia_w,
				nr_interno_conta_p,
				ie_tiss_tipo_guia_w,
				cd_autorizacao_w,
				clock_timestamp(),
				nm_usuario_p,
				ie_tipo_despesa_w,
				dt_item_w,
				cd_edicao_amb_w,
				cd_proc_convenio_w,
				ds_procedimento_w,
				qt_item_regra_w,
				vl_reducao_acrescimo_w,
				(tiss_obter_regra_campo(ie_tiss_tipo_guia_w, 'VL_UNITARIO', CD_CONVENIO_W, trunc(vl_unitario_w, 2), ie_tipo_atendimento_w, cd_categoria_conv_w,ie_tipo_despesa_w,0, cd_estabelecimento_w, ie_clinica_w, nr_seq_classif_atend_w, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@',cd_setor_exec_mat_w))::numeric ,
				(tiss_obter_regra_campo(ie_tiss_tipo_guia_w, 'VL_ITEM', CD_CONVENIO_W, vl_item_w, ie_tipo_atendimento_w, cd_categoria_conv_w,ie_tipo_despesa_w,0, cd_estabelecimento_w, ie_clinica_w, nr_seq_classif_atend_w,cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@',cd_setor_exec_mat_w))::numeric ,
				cd_cgc_prestador_tiss_w,
				ie_tiss_tipo_guia_desp_w,
				to_date(tiss_obter_regra_campo(ie_tiss_tipo_guia_w, 'DT_HORA_INICIO', CD_CONVENIO_W, to_char(dt_hora_item_w, 'dd/mm/yyyy hh24:mi:ss'), ie_tipo_atendimento_w, cd_categoria_conv_w,ie_tipo_despesa_w,0, cd_estabelecimento_w, ie_clinica_w, nr_seq_classif_atend_w, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@',cd_setor_exec_mat_w), 'dd/mm/yyyy hh24:mi:ss'),
				cd_prestador_tiss_w,
				cd_cgc_prest_solic_tiss_w,
				ie_tiss_desp_honor_w,
				to_date(tiss_obter_regra_campo(ie_tiss_tipo_guia_w, 'DT_HORA_FIM', CD_CONVENIO_W, to_char(dt_hora_final_w, 'dd/mm/yyyy hh24:mi:ss'), ie_tipo_atendimento_w, cd_categoria_conv_w,ie_tipo_despesa_w,0, cd_estabelecimento_w, ie_clinica_w, nr_seq_classif_atend_w, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@',cd_setor_exec_mat_w), 'dd/mm/yyyy hh24:mi:ss'),
				ds_prestador_tiss_w,
				nr_seq_med_fatur_p,
				ie_beneficiario_med_w,
				nr_atend_med_p,
				nr_seq_prot_med_p,
				cd_medico_exec_tiss_w,
				cd_senha_w,
				cd_prestador_solic_w,
				ds_prestador_solic_w,
				cd_medico_executor_w,
				cd_unidade_medida_tiss_w,
				nr_registro_anvisa_w,
				ie_xml_w,
				cd_ref_fabricante_w,
				nr_autor_func_w,
				cd_setor_exec_mat_w);
		else
			while(qt_item_w	>= 0) loop

				-- Edgar 23/08/2007, os 62514, tratar arredontamento
				if (qt_item_w	< qt_maxima_w) then

					select	nextval('tiss_conta_desp_seq')
					into STRICT	nr_sequencia_w
					;

				if (ie_reducao_acres_w = 'TD') then
					vl_reducao_acrescimo_w := pr_desconto_w;
				elsif (ie_reducao_acres_w = 'TH') then					
					select	max(tx_procedimento)
					into STRICT	vl_reducao_acresc_aux_w
					from	proc_criterio_horario
					where	nr_sequencia	= nr_seq_proc_crit_hor_w;								

					if (vl_reducao_acresc_aux_w IS NOT NULL AND vl_reducao_acresc_aux_w::text <> '') then
						vl_reducao_acrescimo_w := vl_reducao_acresc_aux_w;
					end if;
				elsif (ie_reducao_acres_w = 'EM') then
					vl_reducao_acrescimo_w := tx_ajuste_mat_w;
				elsif (ie_reducao_acres_w = 'AM') then
					select	max(a.tx_afaturar)
					into STRICT	vl_reducao_acrescimo_w
					from	regra_ajuste_material a
					where	a.nr_sequencia	= nr_seq_regra_ajuste_mat_w;

					if (coalesce(vl_reducao_acrescimo_w::text, '') = '') then
						vl_reducao_acrescimo_w	:= tx_ajuste_mat_w;
					end if;

				end if;

				if (coalesce(nr_seq_prot_med_p,0) > 0) then
					vl_reducao_acrescimo_w	:= 1;
				end if;

				vl_reducao_acrescimo_w	:= (tiss_obter_regra_campo(ie_tiss_tipo_guia_w, 'VL_REDUCAO_ACRESCIMO', CD_CONVENIO_W, vl_reducao_acrescimo_w, ie_tipo_atendimento_w, cd_categoria_conv_w, ie_tipo_despesa_w,0, cd_estabelecimento_w, ie_clinica_w, nr_seq_classif_atend_w, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@',cd_setor_exec_mat_w))::numeric;
				if (coalesce(vl_reducao_acrescimo_w,0) <> 0) and (ie_reducao_acres_w in ('TD','EM','AM')) then
					vl_reducao_acrescimo_w	:= tiss_obter_formato_red_acresc(cd_convenio_w, cd_estabelecimento_w, vl_reducao_acrescimo_w);
				end if;

				if (ie_arredondamento_desp_w = 'S') then
					vl_unitario_w	:= round((vl_unitario_w)::numeric, 2);
					vl_item_w	:= vl_unitario_w * qt_item_w;
				else
					if	((ie_valor_unitario_w = 'C') or
				 		 ((ie_valor_unitario_w = 'D') and (coalesce(vl_unit_original_w::text, '') = ''))) then
						vl_unitario_w	:= dividir_sem_round(vl_item_w, qt_item_w);
					elsif (ie_valor_unitario_w = 'D') then
						vl_unitario_w 	:= vl_unit_original_w;
					elsif (ie_valor_unitario_w = 'E') then
						vl_unitario_w		:= dividir_sem_round(vl_item_w, qt_item_w);
						if (coalesce(ie_formato_red_acres_w,'V') = 'V') then			
							vl_unitario_w := 	dividir_sem_round((100 * vl_unitario_w), trunc((vl_reducao_acrescimo_w * 100),2));				
						elsif (coalesce(ie_formato_red_acres_w,'V') = 'P') then
							vl_unitario_w := 	dividir_sem_round((100 * vl_unitario_w), vl_reducao_acrescimo_w);
						end if;			
					end if;
				end if;

				-- Edgar 07/08/2007, ja carrega esta variavel no cursor

				-- ie_tiss_tipo_guia_desp_w	:= TISS_OBTER_GUIA_DESP(nr_interno_conta_p, cd_autorizacao_w, cd_cgc_prestador_tiss_w);


				--vl_unitario_w	:= TO_NUMBER(tiss_obter_regra_campo(ie_tiss_tipo_guia_w, 'VL_UNITARIO', CD_CONVENIO_W, vl_unitario_w, ie_tipo_atendimento_w, cd_categoria_conv_w,ie_tipo_despesa_w,0, ie_clinica_w, nr_seq_classif_atend_w));

				--vl_item_w	:= TO_NUMBER(tiss_obter_regra_campo(ie_tiss_tipo_guia_w, 'VL_ITEM', CD_CONVENIO_W, vl_item_w, ie_tipo_atendimento_w, cd_categoria_conv_w,ie_tipo_despesa_w,0, ie_clinica_w, nr_seq_classif_atend_w));
				insert	into tiss_Conta_Desp(
					nr_sequencia,
					nr_interno_conta,
					ie_tiss_tipo_guia,
					cd_autorizacao,
					dt_atualizacao,
					nm_usuario,
					ie_tipo_despesa,
					dt_item,
					cd_edicao_amb,
					cd_procedimento,
					ds_procedimento,
					qt_item,
					vl_reducao_acrescimo,
					vl_unitario,
					vl_item,
					cd_cgc_prestador,
					ie_tiss_tipo_guia_desp,
					dt_hora_item,
					cd_prestador_tiss,
					cd_cgc_prest_solic_tiss,
					ie_tiss_desp_honor,
					dt_final,
					ds_prestador_tiss,
					nr_seq_med_fatur,
					ie_contrat_med,
					nr_atend_med,
					nr_seq_prot_med,
					cd_medico_exec_tiss,
					cd_senha,
					cd_prestador_solic_tiss,
					ds_prestador_solic_tiss,
					cd_medico_executor,
					cd_unidade_medida_tiss,
					nr_registro_anvisa,
					ie_xml,
					cd_material_fabricante,
					nr_autor_func_opme,
					cd_setor_execucao)
				values (
					nr_sequencia_w,
					nr_interno_conta_p,
					ie_tiss_tipo_guia_w,
					cd_autorizacao_w,
					clock_timestamp(),
					nm_usuario_p,
					ie_tipo_despesa_w,
					dt_item_w,
					cd_edicao_amb_w,
					cd_proc_convenio_w,
					ds_procedimento_w,
					qt_item_w,
					vl_reducao_acrescimo_w,
					(tiss_obter_regra_campo(ie_tiss_tipo_guia_w, 'VL_UNITARIO', CD_CONVENIO_W, trunc(vl_unitario_w, 2), ie_tipo_atendimento_w, cd_categoria_conv_w,ie_tipo_despesa_w,0, cd_estabelecimento_w, ie_clinica_w, nr_seq_classif_atend_w, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@',cd_setor_exec_mat_w))::numeric ,
					(tiss_obter_regra_campo(ie_tiss_tipo_guia_w, 'VL_ITEM', CD_CONVENIO_W, vl_item_w, ie_tipo_atendimento_w, cd_categoria_conv_w,ie_tipo_despesa_w,0, cd_estabelecimento_w, ie_clinica_w, nr_seq_classif_atend_w, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@',cd_setor_exec_mat_w))::numeric ,
					cd_cgc_prestador_tiss_w,
					ie_tiss_tipo_guia_desp_w,
					to_date(tiss_obter_regra_campo(ie_tiss_tipo_guia_w, 'DT_HORA_INICIO', CD_CONVENIO_W, to_char(dt_hora_item_w, 'dd/mm/yyyy hh24:mi:ss'), ie_tipo_atendimento_w, cd_categoria_conv_w,ie_tipo_despesa_w,0, cd_estabelecimento_w, ie_clinica_w, nr_seq_classif_atend_w, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@',cd_setor_exec_mat_w), 'dd/mm/yyyy hh24:mi:ss'),
					cd_prestador_tiss_w,
					cd_cgc_prest_solic_tiss_w,
					ie_tiss_desp_honor_w,
					to_date(tiss_obter_regra_campo(ie_tiss_tipo_guia_w, 'DT_HORA_FIM', CD_CONVENIO_W, to_char(dt_hora_final_w, 'dd/mm/yyyy hh24:mi:ss'), ie_tipo_atendimento_w, cd_categoria_conv_w,ie_tipo_despesa_w,0, cd_estabelecimento_w, ie_clinica_w, nr_seq_classif_atend_w, cd_setor_entrada_w,ie_tipo_atend_tiss_w||'#@',cd_setor_exec_mat_w), 'dd/mm/yyyy hh24:mi:ss'),
					ds_prestador_tiss_w,
					nr_seq_med_fatur_p,
					ie_beneficiario_med_w,
					nr_atend_med_p,
					nr_seq_prot_med_p,
					cd_medico_exec_tiss_w,
					cd_senha_w,
					cd_prestador_solic_w,
					ds_prestador_solic_w,
					cd_medico_executor_w,
					cd_unidade_medida_tiss_w,
					nr_registro_anvisa_w,
					ie_xml_w,
					cd_ref_fabricante_w,
					nr_autor_func_w,
					cd_setor_exec_mat_w);

					qt_item_w	:= qt_item_w - qt_maxima_w;

				elsif (qt_item_w	= qt_maxima_w) then

					select	nextval('tiss_conta_desp_seq')
					into STRICT	nr_sequencia_w
					;

					if (ie_reducao_acres_w = 'TD') then
						vl_reducao_acrescimo_w := pr_desconto_w;
					elsif (ie_reducao_acres_w = 'EM') then
						vl_reducao_acrescimo_w := tx_ajuste_mat_w;
					elsif (ie_reducao_acres_w = 'AM') then
						select	max(a.tx_afaturar)
						into STRICT	vl_reducao_acrescimo_w
						from	regra_ajuste_material a
						where	a.nr_sequencia	= nr_seq_regra_ajuste_mat_w;

						if (coalesce(vl_reducao_acrescimo_w::text, '') = '') then
							vl_reducao_acrescimo_w	:= tx_ajuste_mat_w;
						end if;

					end if;

					if (coalesce(nr_seq_prot_med_p,0) > 0) then
						vl_reducao_acrescimo_w	:= 1;
					end if;

					vl_reducao_acrescimo_w	:= (tiss_obter_regra_campo(ie_tiss_tipo_guia_w, 'VL_REDUCAO_ACRESCIMO', CD_CONVENIO_W, vl_reducao_acrescimo_w, ie_tipo_atendimento_w, cd_categoria_conv_w, ie_tipo_despesa_w,0, cd_estabelecimento_w, ie_clinica_w, nr_seq_classif_atend_w, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@',cd_setor_exec_mat_w))::numeric;
					if (coalesce(vl_reducao_acrescimo_w,0) <> 0) and (ie_reducao_acres_w in ('TD','EM','AM')) then
						vl_reducao_acrescimo_w	:= tiss_obter_formato_red_acresc(cd_convenio_w, cd_estabelecimento_w, vl_reducao_acrescimo_w);						
					end if;

					-- Edgar 07/08/2007, ja carrega esta variavel no cursor

					-- ie_tiss_tipo_guia_desp_w	:= TISS_OBTER_GUIA_DESP(nr_interno_conta_p, cd_autorizacao_w, cd_cgc_prestador_tiss_w);


					--vl_unitario_w	:= TO_NUMBER(tiss_obter_regra_campo(ie_tiss_tipo_guia_w, 'VL_UNITARIO', CD_CONVENIO_W, vl_unitario_w, ie_tipo_atendimento_w, cd_categoria_conv_w,ie_tipo_despesa_w,0, ie_clinica_w, nr_seq_classif_atend_w));

					--vl_item_w	:= TO_NUMBER(tiss_obter_regra_campo(ie_tiss_tipo_guia_w, 'VL_ITEM', CD_CONVENIO_W, vl_item_w, ie_tipo_atendimento_w, cd_categoria_conv_w,ie_tipo_despesa_w,0, ie_clinica_w, nr_seq_classif_atend_w));
					insert	into tiss_Conta_Desp(
						nr_sequencia,
						nr_interno_conta,
						ie_tiss_tipo_guia,
						cd_autorizacao,
						dt_atualizacao,
						nm_usuario,
						ie_tipo_despesa,
						dt_item,
						cd_edicao_amb,
						cd_procedimento,
						ds_procedimento,
						qt_item,
						vl_reducao_acrescimo,
						vl_unitario,
						vl_item,
						cd_cgc_prestador,
						ie_tiss_tipo_guia_desp,
						dt_hora_item,
						cd_prestador_tiss,
						cd_cgc_prest_solic_tiss,
						ie_tiss_desp_honor,
						dt_final,
						ds_prestador_tiss,
						nr_seq_med_fatur,
						ie_contrat_med,
						nr_atend_med,
						nr_seq_prot_med,
						cd_medico_exec_tiss,
						cd_senha,
						cd_prestador_solic_tiss,
						ds_prestador_solic_tiss,
						cd_medico_executor,
						cd_unidade_medida_tiss,
						nr_registro_anvisa,
						ie_xml,
						cd_material_fabricante,
						nr_autor_func_opme,
						cd_setor_execucao)
					values (
						nr_sequencia_w,
						nr_interno_conta_p,
						ie_tiss_tipo_guia_w,
						cd_autorizacao_w,
						clock_timestamp(),
						nm_usuario_p,
						ie_tipo_despesa_w,
						dt_item_w,
						cd_edicao_amb_w,
						cd_proc_convenio_w,
						ds_procedimento_w,
						qt_item_w,
						vl_reducao_acrescimo_w,
						(tiss_obter_regra_campo(ie_tiss_tipo_guia_w, 'VL_UNITARIO', CD_CONVENIO_W, trunc(vl_unitario_w, 2), ie_tipo_atendimento_w, cd_categoria_conv_w,ie_tipo_despesa_w,0, cd_estabelecimento_w, ie_clinica_w, nr_seq_classif_atend_w, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@',cd_setor_exec_mat_w))::numeric ,
						(tiss_obter_regra_campo(ie_tiss_tipo_guia_w, 'VL_ITEM', CD_CONVENIO_W, vl_item_w, ie_tipo_atendimento_w, cd_categoria_conv_w,ie_tipo_despesa_w,0, cd_estabelecimento_w, ie_clinica_w, nr_seq_classif_atend_w, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@',cd_setor_exec_mat_w))::numeric ,
						cd_cgc_prestador_tiss_w,
						ie_tiss_tipo_guia_desp_w,
						to_date(tiss_obter_regra_campo(ie_tiss_tipo_guia_w, 'DT_HORA_INICIO', CD_CONVENIO_W, to_char(dt_hora_item_w, 'dd/mm/yyyy hh24:mi:ss'), ie_tipo_atendimento_w, cd_categoria_conv_w,ie_tipo_despesa_w,0, cd_estabelecimento_w, ie_clinica_w, nr_seq_classif_atend_w, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@',cd_setor_exec_mat_w), 'dd/mm/yyyy hh24:mi:ss'),
						cd_prestador_tiss_w,
						cd_cgc_prest_solic_tiss_w,
						ie_tiss_desp_honor_w,
						to_date(tiss_obter_regra_campo(ie_tiss_tipo_guia_w, 'DT_HORA_FIM', CD_CONVENIO_W, to_char(dt_hora_final_w, 'dd/mm/yyyy hh24:mi:ss'), ie_tipo_atendimento_w, cd_categoria_conv_w,ie_tipo_despesa_w,0, cd_estabelecimento_w, ie_clinica_w, nr_seq_classif_atend_w, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@',cd_setor_exec_mat_w), 'dd/mm/yyyy hh24:mi:ss'),
						ds_prestador_tiss_w,
						nr_seq_med_fatur_p,
						ie_beneficiario_med_w,
						nr_atend_med_p,
						nr_seq_prot_med_p,
						cd_medico_exec_tiss_w,
						cd_senha_w,
						cd_prestador_solic_w,
						ds_prestador_solic_w,
						cd_medico_executor_w,
						cd_unidade_medida_tiss_w,
						nr_registro_anvisa_w,
						ie_xml_w,
						cd_ref_fabricante_w,
						nr_autor_func_w,
						cd_setor_exec_mat_w);

					qt_item_w	:= qt_item_w - (qt_maxima_w + 1);

				elsif (qt_item_w	> qt_maxima_w) then

					qt_item_aux_w	:= qt_item_w;

					qt_aux_w	:= qt_item_aux_w;
					while(qt_aux_w > qt_maxima_w) loop
						qt_item_w	:= qt_aux_w - qt_maxima_w;
						qt_aux_w	:= qt_aux_w - qt_maxima_w;
					end loop;

					vl_item_aux_w	:= vl_item_w;

					vl_item_w	:= vl_unitario_w * qt_item_w;

					select	nextval('tiss_conta_desp_seq')
					into STRICT	nr_sequencia_w
					;

					if (ie_reducao_acres_w = 'TD') then
						vl_reducao_acrescimo_w := pr_desconto_w;
					elsif (ie_reducao_acres_w = 'EM') then
						vl_reducao_acrescimo_w := tx_ajuste_mat_w;
					elsif (ie_reducao_acres_w = 'AM') then
						select	max(a.tx_afaturar)
						into STRICT	vl_reducao_acrescimo_w
						from	regra_ajuste_material a
						where	a.nr_sequencia	= nr_seq_regra_ajuste_mat_w;

						if (coalesce(vl_reducao_acrescimo_w::text, '') = '') then
							vl_reducao_acrescimo_w	:= tx_ajuste_mat_w;
						end if;

					end if;

					if (coalesce(nr_seq_prot_med_p,0) > 0) then
						vl_reducao_acrescimo_w	:= 1;
					end if;

					vl_reducao_acrescimo_w	:= (tiss_obter_regra_campo(ie_tiss_tipo_guia_w, 'VL_REDUCAO_ACRESCIMO', CD_CONVENIO_W, vl_reducao_acrescimo_w, ie_tipo_atendimento_w, cd_categoria_conv_w, ie_tipo_despesa_w,0, cd_estabelecimento_w, ie_clinica_w, nr_seq_classif_atend_w, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@',cd_setor_exec_mat_w))::numeric;
					if (coalesce(vl_reducao_acrescimo_w,0) <> 0) and (ie_reducao_acres_w in ('TD','EM','AM')) then
						vl_reducao_acrescimo_w	:= tiss_obter_formato_red_acresc(cd_convenio_w, cd_estabelecimento_w, vl_reducao_acrescimo_w);						
					end if;


					-- Edgar 07/08/2007, ja carrega esta variavel no cursor

					-- ie_tiss_tipo_guia_desp_w	:= TISS_OBTER_GUIA_DESP(nr_interno_conta_p, cd_autorizacao_w, cd_cgc_prestador_tiss_w);


					--vl_unitario_w	:= TO_NUMBER(tiss_obter_regra_campo(ie_tiss_tipo_guia_w, 'VL_UNITARIO', CD_CONVENIO_W, vl_unitario_w, ie_tipo_atendimento_w, cd_categoria_conv_w,ie_tipo_despesa_w,0, ie_clinica_w, nr_seq_classif_atend_w));

					--vl_item_w	:= TO_NUMBER(tiss_obter_regra_campo(ie_tiss_tipo_guia_w, 'VL_ITEM', CD_CONVENIO_W, vl_item_w, ie_tipo_atendimento_w, cd_categoria_conv_w,ie_tipo_despesa_w,0, ie_clinica_w, nr_seq_classif_atend_w));
					insert	into tiss_Conta_Desp(
						nr_sequencia,
						nr_interno_conta,
						ie_tiss_tipo_guia,
						cd_autorizacao,
						dt_atualizacao,
						nm_usuario,
						ie_tipo_despesa,
						dt_item,
						cd_edicao_amb,
						cd_procedimento,
						ds_procedimento,
						qt_item,
						vl_reducao_acrescimo,
						vl_unitario,
						vl_item,
						cd_cgc_prestador,
						ie_tiss_tipo_guia_desp,
						dt_hora_item,
						cd_prestador_tiss,
						cd_cgc_prest_solic_tiss,
						ie_tiss_desp_honor,
						dt_final,
						ds_prestador_tiss,
						nr_seq_med_fatur,
						ie_contrat_med,
						nr_atend_med,
						nr_seq_prot_med,
						cd_medico_exec_tiss,
						cd_senha,
						cd_prestador_solic_tiss,
						ds_prestador_solic_tiss,
						cd_medico_executor,
						cd_unidade_medida_tiss,
						nr_registro_anvisa,
						ie_xml,
						cd_material_fabricante,
						nr_autor_func_opme,
						cd_setor_execucao)
					values (
						nr_sequencia_w,
						nr_interno_conta_p,
						ie_tiss_tipo_guia_w,
						cd_autorizacao_w,
						clock_timestamp(),
						nm_usuario_p,
						ie_tipo_despesa_w,
						dt_item_w,
						cd_edicao_amb_w,
						cd_proc_convenio_w,
						ds_procedimento_w,
						qt_item_w,
						vl_reducao_acrescimo_w,
						(tiss_obter_regra_campo(ie_tiss_tipo_guia_w, 'VL_UNITARIO', CD_CONVENIO_W, trunc(vl_unitario_w, 2), ie_tipo_atendimento_w, cd_categoria_conv_w,ie_tipo_despesa_w,0, cd_estabelecimento_w, ie_clinica_w, nr_seq_classif_atend_w, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@',cd_setor_exec_mat_w))::numeric ,
						(tiss_obter_regra_campo(ie_tiss_tipo_guia_w, 'VL_ITEM', CD_CONVENIO_W, vl_item_w, ie_tipo_atendimento_w, cd_categoria_conv_w,ie_tipo_despesa_w,0, cd_estabelecimento_w, ie_clinica_w, nr_seq_classif_atend_w, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@',cd_setor_exec_mat_w))::numeric ,
						cd_cgc_prestador_tiss_w,
						ie_tiss_tipo_guia_desp_w,
						to_date(tiss_obter_regra_campo(ie_tiss_tipo_guia_w, 'DT_HORA_INICIO', CD_CONVENIO_W, to_char(dt_hora_item_w, 'dd/mm/yyyy hh24:mi:ss'), ie_tipo_atendimento_w, cd_categoria_conv_w,ie_tipo_despesa_w,0, cd_estabelecimento_w, ie_clinica_w, nr_seq_classif_atend_w, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@',cd_setor_exec_mat_w), 'dd/mm/yyyy hh24:mi:ss'),
						cd_prestador_tiss_w,
						cd_cgc_prest_solic_tiss_w,
						ie_tiss_desp_honor_w,
						to_date(tiss_obter_regra_campo(ie_tiss_tipo_guia_w, 'DT_HORA_FIM', CD_CONVENIO_W, to_char(dt_hora_final_w, 'dd/mm/yyyy hh24:mi:ss'), ie_tipo_atendimento_w, cd_categoria_conv_w,ie_tipo_despesa_w,0, cd_estabelecimento_w, ie_clinica_w, nr_seq_classif_atend_w, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@',cd_setor_exec_mat_w), 'dd/mm/yyyy hh24:mi:ss'),
						ds_prestador_tiss_w,
						nr_seq_med_fatur_p,
						ie_beneficiario_med_w,
						nr_atend_med_p,
						nr_seq_prot_med_p,
						cd_medico_exec_tiss_w,
						cd_senha_w,
						cd_prestador_solic_w,
						ds_prestador_solic_w,
						cd_medico_executor_w,
						cd_unidade_medida_tiss_w,
						nr_registro_anvisa_w,
						ie_xml_w,
						cd_ref_fabricante_w,
						nr_autor_func_w,
						cd_setor_exec_mat_w);

					vl_item_w	:= vl_item_aux_w - vl_item_w;
					qt_item_w	:= (qt_item_aux_w - qt_item_w);
				end if;

			end loop;
		end if;
	end if;

end loop;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE tiss_gerar_conta_mat ( nr_interno_conta_p bigint, nr_seq_med_fatur_p bigint, nm_usuario_p text, nr_atend_med_p bigint, nr_seq_prot_med_p bigint) FROM PUBLIC;

