-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_gerar_mensagem_mensalidade ( nr_seq_mensalidade_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) AS $body$
DECLARE

 
ds_mensagem_w			text;
ie_aniversariante_w		varchar(1)	:= 'N';
ds_observacao_w			varchar(4000)	:= '';
ds_mensagem_quitacao_w		varchar(4000)	:= '';
ie_regulamentacao_w		varchar(1);
pos_fim_macro_w			bigint;
ds_macro_w			varchar(30);
nm_atributo_w			varchar(50);
pos_macro_w			bigint;
ds_resultado_macro_w		varchar(4000);
ds_texto_alterado_w		varchar(4000);
i				bigint := 0;
ds_segurados_w			varchar(2000);
ds_valores_pre_w		varchar(2000);
qt_registro_w			bigint := 0;
nr_ano_w			pls_pagador_quitacao_anual.nr_ano%type;
nr_parcela_w			pls_mensalidade.nr_parcela%type;
qt_benef_w			bigint;

C01 CURSOR FOR 
	SELECT	a.ds_mensagem, 
		a.qt_meses_portabilidade, 
		a.nr_seq_tipo_portabilidade, 
		a.ie_mensalidade_em_dia 
	from	pls_mensagem_mensalidade a 
	where (pls_store_data_mens_pck.get_dt_referencia_lote between trunc(coalesce(a.dt_inicial,pls_store_data_mens_pck.get_dt_referencia_lote),'dd') and fim_dia(coalesce(a.dt_final,pls_store_data_mens_pck.get_dt_referencia_lote))) 
	and	((a.ie_aniversario		= 'S' and ie_aniversariante_w = 'S') or (a.ie_aniversario = 'N')) 
	and	a.cd_estabelecimento		= cd_estabelecimento_p 
	and	((pls_store_data_mens_pck.get_nr_seq_conta_banco_pag = a.nr_seq_conta_banco and (pls_store_data_mens_pck.get_nr_seq_conta_banco_pag IS NOT NULL AND pls_store_data_mens_pck.get_nr_seq_conta_banco_pag::text <> '') and (a.nr_seq_conta_banco IS NOT NULL AND a.nr_seq_conta_banco::text <> '')) or (coalesce(a.nr_seq_conta_banco::text, '') = '')) 
	and	((pls_store_data_mens_pck.get_nr_seq_classif_itens_pag = a.nr_seq_classif_itens and (pls_store_data_mens_pck.get_nr_seq_classif_itens_pag IS NOT NULL AND pls_store_data_mens_pck.get_nr_seq_classif_itens_pag::text <> '') and (a.nr_seq_classif_itens IS NOT NULL AND a.nr_seq_classif_itens::text <> '')) or (coalesce(nr_seq_classif_itens::text, '') = '')) 
	and	coalesce(a.ie_regulamentacao,ie_regulamentacao_w)	= ie_regulamentacao_w 
	and	((coalesce(a.ie_tipo_estipulante,'A')	= coalesce(pls_store_data_mens_pck.get_ie_tipo_estipulante,coalesce(a.ie_tipo_estipulante,'A'))) or 
		coalesce(a.ie_tipo_estipulante,'A')	= 'A') 
	and (exists (SELECT x.nr_ano 
			from 	pls_pagador_quitacao_anual x 
			where 	x.nr_ano		= (to_char(a.ie_mensalidade_em_dia, 'yyyy'))::numeric  
			and 	x.nr_seq_pagador	= pls_store_data_mens_pck.get_nr_seq_pagador 
			and	coalesce(x.nr_seq_mensalidade::text, '') = '') or (coalesce(a.ie_mensalidade_em_dia::text, '') = '')) 
	and	nr_parcela_w between coalesce(a.nr_parcela_inicial,1) and coalesce(a.nr_parcela_final,nr_parcela_w);

C02 CURSOR FOR 
	SELECT	c.dt_nascimento, 
		a.nr_seq_plano 
	from	pessoa_fisica	c, 
		pls_segurado	b, 
		pls_mensalidade_segurado a 
	where	b.cd_pessoa_fisica	= c.cd_pessoa_fisica 
	and	a.nr_seq_segurado	= b.nr_sequencia 
	and	a.nr_seq_mensalidade	= nr_seq_mensalidade_p 
	and	ie_aniversariante_w	= 'N';

C03 CURSOR FOR 
	SELECT	c.dt_nascimento, 
		a.nr_seq_plano 
	from	pessoa_fisica	c, 
		pls_segurado	b, 
		pls_mensalidade_segurado a 
	where	b.cd_pessoa_fisica	= c.cd_pessoa_fisica 
	and	a.nr_seq_segurado	= b.nr_sequencia 
	and	a.nr_seq_mensalidade	= nr_seq_mensalidade_p 
	and	((coalesce(b.dt_rescisao::text, '') = '') or (b.dt_rescisao > a.dt_mesano_referencia)) 
	and	ie_aniversariante_w	= 'N';
	
BEGIN 
 
ie_aniversariante_w	:= 'N';
 
select	nr_parcela 
into STRICT	nr_parcela_w 
from 	pls_mensalidade 
where	nr_sequencia = nr_seq_mensalidade_p;
 
select	count(1) 
into STRICT	qt_benef_w 
from	pessoa_fisica	c, 
	pls_segurado	b, 
	pls_mensalidade_segurado a 
where	b.cd_pessoa_fisica	= c.cd_pessoa_fisica 
and	a.nr_seq_segurado	= b.nr_sequencia 
and	a.nr_seq_mensalidade	= nr_seq_mensalidade_p 
and	((coalesce(b.dt_rescisao::text, '') = '') or (b.dt_rescisao > a.dt_mesano_referencia)) 
and	ie_aniversariante_w	= 'N';
 
if (qt_benef_w = 0) then 
	for r_c02_w in C02 loop 
		if (coalesce(r_c02_w.dt_nascimento,clock_timestamp()) <> clock_timestamp()) then 
			if	to_char(r_c02_w.dt_nascimento,'mm') = to_char(pls_store_data_mens_pck.get_dt_referencia,'mm') then 
				ie_aniversariante_w	:= 'S';
			elsif (ie_aniversariante_w	<> 'S') then 
				ie_aniversariante_w	:= 'N';
			end if;
		end if;
		 
		select	max(ie_regulamentacao) 
		into STRICT	ie_regulamentacao_w 
		from	pls_plano 
		where	nr_sequencia	= r_c02_w.nr_seq_plano;
	end loop;
else 
	for r_c03_w in C03 loop 
		if (coalesce(r_c03_w.dt_nascimento,clock_timestamp()) <> clock_timestamp()) then 
			if	to_char(r_c03_w.dt_nascimento,'mm') = to_char(pls_store_data_mens_pck.get_dt_referencia,'mm') then 
				ie_aniversariante_w	:= 'S';
			elsif (ie_aniversariante_w	<> 'S') then 
				ie_aniversariante_w	:= 'N';
			end if;
		end if;
		 
		select	max(ie_regulamentacao) 
		into STRICT	ie_regulamentacao_w 
		from	pls_plano 
		where	nr_sequencia	= r_c03_w.nr_seq_plano;
	end loop;
end if;
 
/* Verifica se ha regra de portabilidade */
 
select	count(1) 
into STRICT	qt_registro_w 
from	pls_portab_regra_direito 
where	cd_estabelecimento = cd_estabelecimento_p;
 
for r_c01_w in C01 loop 
	ds_mensagem_w		:= r_c01_w.ds_mensagem || ' ';
	ds_texto_alterado_w	:= ds_mensagem_w;
	 
	if (r_c01_w.qt_meses_portabilidade IS NOT NULL AND r_c01_w.qt_meses_portabilidade::text <> '') then 
		if (qt_registro_w > 0) then 
			/* Verifica se na mensagem quais segurados estarao com portabilidade */
 
			SELECT * FROM pls_obter_se_seg_portabilidade(nr_seq_mensalidade_p, pls_store_data_mens_pck.get_dt_referencia, cd_estabelecimento_p, r_c01_w.qt_meses_portabilidade, r_c01_w.nr_seq_tipo_portabilidade, ds_segurados_w, ds_valores_pre_w) INTO STRICT ds_segurados_w, ds_valores_pre_w;
			 
			/* Se não retornar beneficiários, não emite mensagem nenhuma */
 
			if (coalesce(ds_segurados_w::text, '') = '') then 
				ds_mensagem_w	:= null;
			end if;
		else 
			ds_mensagem_w	:= null;
		end if;
	end if;
	 
	--aaschlote 08/02/2011 OS - 284461 
	if (ds_mensagem_w IS NOT NULL AND ds_mensagem_w::text <> '') then 
		i := 0;
		WHILE(ds_mensagem_w IS NOT NULL AND ds_mensagem_w::text <> '') and (i < 5) LOOP 
			begin 
			i := i + 1;
			 
			select	replace(replace(ds_mensagem_w,'',' '),chr(13) || chr(10),' ') 
			into STRICT	ds_mensagem_w 
			;
			 
			select	position('@' in ds_mensagem_w) 
			into STRICT	pos_macro_w 
			;
			 
			if (pos_macro_w > 0) then 
				select	substr(ds_mensagem_w,pos_macro_w,length(ds_mensagem_w)) 
				into STRICT	ds_mensagem_w 
				;
				 
				select	position(' ' in ds_mensagem_w) 
				into STRICT	pos_fim_macro_w 
				;
				 
				select	elimina_caracteres_especiais(substr(ds_mensagem_w,1,pos_fim_macro_w -1)) 
				into STRICT	ds_macro_w 
				;
				 
				if ((coalesce(ds_macro_w,null) IS NOT NULL AND (coalesce(ds_macro_w,null))::text <> '')) then 
					begin 
					select nm_atributo 
					into STRICT  nm_atributo_w 
					from  pls_macro_mensalidade 
					where  upper(ds_macro) = upper(ds_macro_w);
					exception 
					when others then 
						nm_atributo_w := null;
					end;
					 
					if ((coalesce(nm_atributo_w,null) IS NOT NULL AND (coalesce(nm_atributo_w,null))::text <> '')) and (upper(ds_macro_w) <> upper('@BENEF_PORTAB')) and (upper(ds_macro_w) <> upper('@BENEF_VAL_PORTAB')) then 
						select	pls_obter_macro_mensalidade(nr_seq_mensalidade_p,nm_atributo_w,ds_macro_w) 
						into STRICT	ds_resultado_macro_w 
						;
						 
						select	replace(ds_texto_alterado_w, ds_macro_w, ds_resultado_macro_w) 
						into STRICT	ds_texto_alterado_w 
						;
						 
					--Tratamento para a portabilidade 
					elsif (upper(nm_atributo_w) = upper('NR_SEQ_MENSALIDADE')) and (upper(ds_macro_w) = upper('@BENEF_PORTAB')) then 
						ds_resultado_macro_w := ds_segurados_w;
						 
						select	replace(ds_texto_alterado_w, ds_macro_w, ds_resultado_macro_w) 
						into STRICT	ds_texto_alterado_w 
						;
						 
						if (coalesce(ds_resultado_macro_w::text, '') = '') then 
							ds_texto_alterado_w := null;
						end if;
					elsif (upper(nm_atributo_w) = upper('NR_SEQ_MENSALIDADE')) and (upper(ds_macro_w) = upper('@BENEF_VAL_PORTAB')) then 
						ds_resultado_macro_w := ds_valores_pre_w;
						 
						select	replace(ds_texto_alterado_w, ds_macro_w, ds_resultado_macro_w) 
						into STRICT	ds_texto_alterado_w 
						;
						 
						if (coalesce(ds_resultado_macro_w::text, '') = '') then 
							ds_texto_alterado_w := null;
						end if;
					end if;
				end if;
				 
				select	substr(ds_mensagem_w,pos_fim_macro_w, length(ds_mensagem_w)) 
				into STRICT	ds_mensagem_w 
				;
			else 
				ds_mensagem_w := '';
			end if;
			 
			end;
		end loop;
		 
		if (r_c01_w.ie_mensalidade_em_dia IS NOT NULL AND r_c01_w.ie_mensalidade_em_dia::text <> '') then 
			update	pls_pagador_quitacao_anual 
			set	nr_seq_mensalidade	= nr_seq_mensalidade_p 
			where	nr_seq_pagador		= pls_store_data_mens_pck.get_nr_seq_pagador 
			and	nr_ano			= (to_char(r_c01_w.ie_mensalidade_em_dia,'yyyy'))::numeric;
			 
			ds_mensagem_quitacao_w	:= substr(ds_mensagem_quitacao_w || ds_texto_alterado_w || chr(13),1,4000);
		else 
			ds_observacao_w	:= substr(ds_observacao_w || ds_texto_alterado_w || chr(13),1,4000);
		end if;
	end if;
	 
end loop;
 
ds_observacao_w		:= substr(ds_observacao_w,1,length(ds_observacao_w)-1);
ds_mensagem_quitacao_w	:= substr(ds_mensagem_quitacao_w,1,length(ds_mensagem_quitacao_w)-1);
 
update	pls_mensalidade 
set	ds_observacao		= ds_observacao_w, 
	ds_mensagem_quitacao	= ds_mensagem_quitacao_w 
where	nr_sequencia		= nr_seq_mensalidade_p;
 
--commit; 
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_gerar_mensagem_mensalidade ( nr_seq_mensalidade_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) FROM PUBLIC;

