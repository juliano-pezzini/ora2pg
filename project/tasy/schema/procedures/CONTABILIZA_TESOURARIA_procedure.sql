-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE contabiliza_tesouraria ( nr_lote_contabil_p bigint, nm_usuario_p text, ie_exclusao_p text, ds_retorno_p INOUT text) AS $body$
DECLARE


cd_empresa_w                    empresa.cd_empresa%type;
cd_cgc_w                        varchar(14);
cd_centro_custo_w               integer;
cd_conta_contabil_w             varchar(20);
cd_conta_contab_movto_w         varchar(20);
cd_conta_caixa_w                varchar(20);
cd_convenio_w                   integer;
cd_estab_caixa_od_w             estabelecimento.cd_estabelecimento%type;
cd_estabelecimento_w            smallint;
nr_seq_protocolo_w              bigint;
cd_historico_w                  bigint;
ds_movto_cartao_w               varchar(255);
vl_especie_w                    double precision;
vl_cheque_w                     double precision;
vl_cartao_w                     double precision;
cd_hist_parametro_w             bigint;
cd_historico_movto_w            bigint;
cd_historico_cred_w             bigint;
nr_seq_cob_escritural_w         bigint;
cd_pessoa_fisica_w              pessoa_fisica.cd_pessoa_fisica%type;
cd_tipo_lote_contabil_w         bigint;
ds_erro_w                       varchar(255);
ds_historico_w                  varchar(255);
ds_hist_pf_pj_w                 varchar(255);
ds_obs_caixa_receb_w            varchar(255);
dt_contabil_w                   timestamp;
dt_movimento_w                  timestamp;
dt_transacao_w                  timestamp;
ie_caixa_w                      varchar(1);
ie_agrupa_w                     varchar(1);
ie_agrupa_lanc_caixa_dia_w      varchar(1);
ie_contab_caixa_w               varchar(1);
ie_contab_cp_w                  varchar(3);
ie_contab_cr_w                  varchar(3);
ie_contab_cartao_cancel_w       varchar(1);
ie_contab_monet_docto_w         varchar(3);
ie_contab_tesouraria_w          varchar(3);
ie_contab_transf_caixa_w        varchar(3);
ie_debito_credito_w             varchar(1);
ie_saldo_caixa_w                varchar(1);
ie_union_w                      integer;
nm_atributo_w                   varchar(50);
nr_documento_w                  varchar(255);
nr_documento_caixa_w            varchar(255);
nr_seq_agrupamento_w            bigint;
nr_seq_agrup_caixa_w            bigint;
nr_seq_conta_banco_w            bigint;
nr_seq_movto_w                  bigint;
nr_seq_trans_w                  bigint;
nr_seq_trans_fin_w              bigint;
nr_sequencia_w                  bigint    := 0;
vl_retorno_w                    double precision;
vl_transacao_w                  double precision;
nr_doc_movto_w                  varchar(255);
nr_adiant_movto_w               adiantamento.nr_adiantamento%type;
nr_seq_lote_orig_w              movto_trans_financ.nr_seq_lote%type;
nr_interno_conta_movto_w        bigint;
nr_cheque_movto_w               varchar(255);
ds_hist_movto_w                 varchar(255);
ds_compl_pf_pj_movto_w          varchar(255);
cd_hist_caixa_movto_w           bigint;
nr_bordero_w                    bigint;
ie_compl_hist_w                 varchar(3);
ds_conteudo_w                   varchar(4000);
ds_compl_historico_w            varchar(255);
nr_seq_titulo_pagar_w           bigint;
nr_seq_produto_w                bigint;
nr_seq_titulo_receber_w         bigint;
nr_seq_nota_fiscal_w            bigint;
nr_seq_conv_receb_w             bigint;
nr_seq_deposito_w               bigint;
nr_adiant_pago_w                bigint;
nr_seq_cheque_w                 bigint;
cd_banco_cheque_w               bigint;
ds_banco_cheque_w               varchar(255);
cd_agencia_cheque_w             varchar(40);
nr_conta_cheque_w               varchar(40);
nr_adiant_cheque_w              bigint;
nm_pf_cheque_w                  varchar(255);
ds_razao_social_cheque_w        varchar(255);
ds_pessoa_titulo_w              varchar(255);
nr_seq_agrup_titulo_w           bigint := 0;
ie_contab_monet_regra_w         varchar(1);
nr_cheque_w                     varchar(20);
nr_seq_caixa_w                  bigint;
nr_seq_caixa_rec_w              bigint;
ie_cc_glosa_w                   varchar(4);
ie_compl_historico_w            varchar(20);
nr_nota_fiscal_w                varchar(255);
ds_cheque_deposito_w            varchar(255);
nr_cheque_deposito_w            varchar(255);
nm_paciente_cheque_w            varchar(255);
nr_nfe_imp_w                    nota_fiscal.nr_nfe_imp%type;
nm_paciente_adiantamento_w      varchar(255);
ds_conta_od_w                   varchar(255);
nr_recibo_w                     varchar(255);
cd_banco_ext_cheque_w           varchar(255);
ds_cheques_caixa_rec_w          varchar(255);
dt_venc_cheque_atual_w          timestamp;
ds_bandeira_w                   bandeira_cartao_cr.ds_bandeira%type;
ds_obs_cartao_w                 varchar(255);
ds_banco_od_w                   banco.ds_banco%type;
ds_caixa_w                      varchar(40);
nr_seq_caixa_od_w               bigint;
ie_dt_contab_tesouraria_w       varchar(1);
nr_recibo_rec_w                 caixa_receb.nr_recibo%type;
cd_conta_deb_pls_w              varchar(20);
cd_conta_rec_pls_w              varchar(20);
cd_historico_pls_w              bigint;
ds_compl_historico_pls_w        varchar(255);
ds_pessoa_nota_w                varchar(80);
nr_seq_classif_w                bigint;
nr_autorizacao_w                varchar(40);
ds_estorno_w                    varchar(40);
dt_transacao_ww                 varchar(20);
nr_seq_movto_cartao_w           bigint;
nr_seq_bandeira_w               bigint;
vl_antecipacao_mens_w           double precision;
ie_contab_baixas_pro_rata_w     varchar(1);
ie_tipo_lote_pls_w              varchar(1);
dt_contab_lote_w                timestamp;
dt_referencia_pls_mens_w        timestamp;
nr_seq_baixa_w                  integer;
nr_seq_lote_w                   bigint;
cd_pessoa_caixa_receb_w         varchar(20);
nm_pessoa_caixa_receb_w         varchar(240);
nm_pessoa_resp_atend_w          varchar(240);
ie_contab_neg_cheque_w          varchar(1);
ie_permite_estab_dif_w          varchar(15);
cd_conta_transitoria_w          varchar(20);
cd_historico_ct_w               bigint;
cd_estab_movto_w                bigint;
nr_titulo_w                     bigint;
nm_pessoa_movto_w               varchar(255);
nr_seq_liq_cc_w                 bigint;
ds_caixa_od_w                   caixa.ds_caixa%type;
nr_seq_forma_pagto_w            movto_cartao_cr.nr_seq_forma_pagto%type;
ds_forma_pagto_w                forma_pagto_cartao_cr.ds_forma_pagto%type;
qt_seq_classif_w                bigint;
nr_doc_tit_receb_w              varchar(22);
nr_documento_caixa_rec_w        varchar(255);
nm_estabelecimento_w            varchar(255);
ie_lote_pro_rata_w              varchar(3);
nr_seq_cheque_cp_w              bigint;
ds_cheque_cp_w                  varchar(180);
nr_seq_movto_bco_pend_w         movto_banco_pend_baixa.nr_seq_movto_pend%type;
nr_cpf_w                        pessoa_fisica.nr_cpf%type;
ie_pls_w                        varchar(1);
nr_atendimento_w                bigint;
nr_negociacao_w                 varchar(20);
ds_macro_w                      varchar(2000);
nr_seq_movto_trans_fin_w        bigint;
nr_seq_movto_pend_w             bigint;
nr_cheque_pago_w                varchar(15);
ds_observacao_cp_w              varchar(255);
ds_observacao_cr_w              varchar(255);
nr_cpf_cheque_w                 varchar(11);
cd_cnpj_cheque_w                varchar(14);
qt_reg_w                        smallint;
ds_obs_adiantamento_w           adiantamento.ds_observacao%type;
nr_adiantamento_w               bigint;
ie_contab_classif_mens_w        varchar(1);
nr_seq_caixa_receb_w            bigint;
nr_recibo_caixa_receb_w         bigint;
qt_registro_w                   bigint;
ie_centro_custo_tit_pagar_w     varchar(1);
ie_conta_contab_tit_pagar_w     varchar(1);
nm_mae_pf_w                     varchar(255);
cd_tipo_baixa_w                 integer;
nr_seq_cheque_ww                bigint;
nm_pf_pj_cartao_w               varchar(255);
nr_interno_conta_w              bigint;
ie_contab_vl_titulo_rec_w       varchar(1);
cd_tipo_recebimento_w           integer;
nm_agrupador_w                  varchar(255);
ie_origem_titulo_w              varchar(10);
qt_contador_w                   bigint;
nm_tabela_w                     lote_contabil_log.nm_tabela%type;
ie_contab_desp_cartao_w         parametro_contas_receber.ie_contab_desp_cartao%type;
ie_contab_rec_classif_w         varchar(5);
ie_nf_nfe_w                     varchar(15);
nr_documento_ww                 movimento_contabil.nr_documento%type;
ie_origem_documento_w           movimento_contabil.ie_origem_documento%type;
nr_seq_tab_orig_w               w_movimento_contabil.nr_seq_tab_orig%type;
nr_seq_tab_compl_w              w_movimento_contabil.nr_seq_tab_compl%type;
nr_seq_info_ctb_w               w_movimento_contabil.nr_seq_info%type;
cd_moeda_w                      movto_trans_financ.cd_moeda%type;
ds_observacao_movto_w           varchar(255);/* Foi colocado 255 porque quando eh maior do que isto nao gera compl historico (Matheus)*/
ie_contab_trans_fin_baixa_w     parametro_tesouraria.ie_contab_trans_fin_baixa%type;
nr_seq_trans_fin_baixa_w        titulo_pagar.nr_seq_trans_fin_baixa%type;
ie_contab_mens_tesouraria_w     pls_parametro_contabil.ie_contab_mens_tesouraria%type;
ie_regra_w                      varchar(255);
ds_atributos_w                  varchar(4000);
nr_seq_movto_orig_w             movto_trans_financ.nr_seq_movto_orig%type;
ie_estorno_w                    movto_trans_financ.ie_estorno%type;
nr_seq_movto_transf_w           movto_trans_financ.nr_seq_movto_transf%type;
nr_seq_liq_origem_w             titulo_receber_liq.nr_seq_liq_origem%type;
nr_seq_movto_transf_estorno_w   movto_trans_financ.nr_seq_movto_transf%type;
nr_seq_lote_transf_w            movto_trans_financ.nr_seq_lote%type;
nr_seq_caixa_transf_w           movto_trans_financ.nr_seq_caixa%type;
qt_tit_caixa_rec_w              bigint;
nr_seq_tit_rec_doc_w            movto_trans_financ.nr_seq_titulo_receber%type;
ds_conta_banco_pend_w           varchar(255);
nm_paciente_atendimento_w       varchar(255);
cd_estab_inf_movto_w            estabelecimento.cd_estabelecimento%type;
nr_seq_rpa_w                    titulo_pagar.nr_seq_rpa%type;
ds_transacao_w                  transacao_financeira.ds_transacao%type;
nr_prontuario_w                 pessoa_fisica.nr_prontuario%type;
nm_usuario_receb_w              usuario.ds_usuario%type;
ds_tipo_recebimento_w           tipo_recebimento.ds_tipo_recebimento%type;
nr_seq_proj_rec_w               movto_trans_financ.nr_seq_proj_rec%type;
cd_serie_nf_w			nota_fiscal.cd_serie_nf%type;

/* Cursor para ler Movimento a Ser contabilizado */

c010 CURSOR FOR
        SELECT  1 ie_union,
                b.nr_sequencia,
                coalesce(e.vl_transacao,b.vl_transacao) vl_transacao,
                b.nr_seq_trans_financ,
                b.dt_transacao,
                'VL_TRANSACAO',
                b.nr_seq_banco_od,
                substr(obter_compl_trans_fin(b.nr_sequencia, 'PJ'),1,255) cd_cgc,
                CASE WHEN d.ie_caixa='M' THEN  obter_conta_caixa(c.nr_sequencia, dt_contabil_w)  ELSE b.cd_conta_contabil END ,
                coalesce(e.cd_centro_custo,b.cd_centro_custo) cd_centro_custo,
                coalesce(b.nr_documento,coalesce(b.nr_adiantamento,coalesce(b.nr_bordero, b.nr_interno_conta))),
                d.ie_caixa,
                d.ie_saldo_caixa,
                CASE WHEN ie_saldo_caixa='E' THEN 'D'  ELSE 'C' END  ie_debito_credito,
                CASE WHEN ie_agrupa_w='N' THEN  b.nr_sequencia WHEN ie_agrupa_w='S' THEN  0  ELSE b.nr_sequencia END ,
                ds_historico,
                substr(obter_compl_trans_fin(b.nr_sequencia, 'PF'),1,255) cd_pessoa_fisica,
                substr(obter_compl_trans_fin(b.nr_sequencia, 'N'),1,255) ds_compl_pf_pj,
                coalesce(d.cd_historico_caixa, CASE WHEN ie_saldo_caixa='E' THEN  cd_hist_parametro_w  ELSE coalesce(cd_historico_cred_w,cd_hist_parametro_w) END ),
                b.cd_historico,
                b.nr_documento nr_doc_movto,
                b.nr_adiantamento nr_adiant_movto,
                b.nr_interno_conta nr_interno_conta_movto,
                substr(obter_dados_cheque_cr(b.nr_seq_cheque, 'N'),1,255) nr_cheque_movto,
                b.ds_historico ds_hist_movto,
                substr(obter_compl_trans_fin(b.nr_sequencia, 'N'),1,255) ds_compl_pf_pj_movto,
                d.cd_historico_caixa cd_hist_caixa_movto,
                b.nr_bordero,
                b.nr_seq_titulo_pagar,
                b.nr_seq_titulo_receber,
                b.nr_seq_nota_fiscal,
                b.nr_seq_conv_receb,
                b.nr_seq_deposito,
                b.nr_adiant_pago,
                b.nr_seq_cheque,
                obter_conta_caixa(c.nr_sequencia, dt_contabil_w),
                coalesce(obter_pessoa_titulo_pagar(b.nr_seq_titulo_pagar), obter_pessoa_titulo_receber(b.nr_seq_titulo_receber)),
                c.nr_sequencia nr_seq_caixa,
                b.dt_transacao,
                somente_numero(substr(coalesce(obter_dados_nota_fiscal(b.nr_seq_nota_fiscal,'0'),coalesce(obter_dados_titulo_receber(b.nr_seq_titulo_receber,'NFT'),
				obter_dados_tit_pagar(b.nr_seq_titulo_pagar,'NF'))),1,20)) nr_nota_fiscal,
                b.nr_seq_caixa_rec,
                substr(obter_dados_cartao_cr(b.nr_seq_movto_cartao,'B'),1,140) ds_bandeira,
                substr(obter_dados_cartao_cr(b.nr_seq_movto_cartao,'OBS'),1,255) ds_obs_cartao,
                (null)::numeric  nr_seq_produto,
                b.nr_seq_caixa_od,
                null cd_conta_deb_pls,
                null cd_conta_rec_pls,
                null cd_historico_pls,
                substr(obter_dados_cartao_cr(b.nr_seq_movto_cartao,'AUT'),1,40) nr_autorizacao,
                b.nr_seq_movto_cartao,
                (null)::numeric  vl_antecipacao_mens,
                to_char(null) ie_lote_antecip_pls,
                to_date(null) dt_referencia_pls_mens,
                (null)::numeric  nr_seq_baixa,
                0 cd_estab_movto,
                null nr_seq_liq_cc,
                null nr_doc_tit_receb,
                null ie_lote_pro_rata,
                b.nr_seq_cheque_cp,
                b.nr_sequencia,
                r.nr_sequencia nr_seq_caixa_receb,
                null cd_tipo_baixa,
                null nr_seq_protocolo,
                r.cd_tipo_receb_caixa cd_tipo_recebimento,
                'CAIXA_SALDO_DIARIO',
                b.nr_sequencia nr_seq_tab_orig,
                e.nr_sequencia nr_seq_tab_compl,
                4 nr_seq_info_ctb,
                substr(b.ds_observacao,1,255) ds_observacao_movto,
                b.nr_seq_movto_transf,
                null nr_seq_liq_origem,
                b.nr_seq_proj_rec,
                b.cd_moeda
        FROM transacao_financeira d, caixa c, movto_trans_financ b
LEFT OUTER JOIN movto_trans_financ_cc e ON (b.nr_sequencia = e.nr_seq_movto_trans)
, caixa_saldo_diario a
LEFT OUTER JOIN caixa_receb r ON (a.nr_sequencia = r.nr_sequencia)
WHERE a.nr_lote_contabil      = nr_lote_contabil_p and a.nr_seq_caixa          = c.nr_sequencia  and a.nr_sequencia          = b.nr_seq_saldo_caixa and (b.nr_seq_trans_financ IS NOT NULL AND b.nr_seq_trans_financ::text <> '')  and b.nr_seq_trans_financ   = d.nr_sequencia

union all

        SELECT  2 ie_union,
                a.nr_seq_movto_trans_fin nr_sequencia,
                a.vl_transacao,
                a.nr_seq_trans_fin,
                coalesce(a.dt_recebimento,clock_timestamp()) dt_transacao,
                a.ds_atributo,
                a.nr_seq_conta_banco,
                b.cd_cgc,
                '' cd_conta_contab_caixa,
                0 cd_centro_custo,
                '' nr_documento,
                'D' ie_caixa,
                null ie_saldo_caixa,
                'D' ie_debito_credito,
                CASE WHEN ie_agrupa_w='N' THEN  a.nr_seq_movto_trans_fin WHEN ie_agrupa_w='S' THEN  0  ELSE a.nr_seq_movto_trans_fin END ,
                '' ds_historico,
                b.cd_pessoa_fisica,
                obter_pessoa_titulo_receber(b.nr_titulo) ds_compl_pf_pj,
                0,
                (null)::numeric  cd_historico,
                '' nr_doc_movto,
                0 nr_adiant_movto,
                b.nr_interno_conta nr_interno_conta_movto,
                '' nr_cheque_movto,
                '' ds_hist_movto,
                '' ds_compl_pf_pj_movto,
                0 cd_hist_caixa_movto,
                0 nr_bordero,
                0 nr_seq_titulo_pagar,
                b.nr_titulo nr_seq_titulo_receber,
                0 nr_seq_nota_fiscal,
                0 nr_seq_conv_receb,
                0 nr_seq_deposito,
                0 nr_adiant_pago,
                0 nr_seq_cheque,
                '' cd_conta_contabil,
                obter_pessoa_titulo_receber(b.nr_titulo),
                (null)::numeric  nr_seq_caixa,
                coalesce(a.dt_recebimento,clock_timestamp()),
                somente_numero(obter_dados_titulo_receber(b.nr_titulo,'NFT')),
                a.nr_seq_caixa_rec,
                null ds_bandeira,
                null ds_obs_cartao,
                (null)::numeric  nr_seq_produto,
                (null)::numeric  nr_seq_caixa_od,
                null cd_conta_deb_pls,
                null cd_conta_rec_pls,
                null cd_historico_pls,
                '' nr_autorizacao,
                null nr_seq_movto_cartao,
                (null)::numeric  vl_antecipacao_mens,
                to_char(null) ie_lote_antecip_pls,
                to_date(null) dt_referencia_pls_mens,
                (null)::numeric  nr_seq_baixa,
                b.cd_estabelecimento cd_estab_movto,
                null nr_seq_liq_cc,
                a.nr_documento nr_doc_tit_receb,
                null ie_lote_pro_rata,
                null nr_seq_cheque_cp,
                a.nr_seq_movto_trans_fin,
                null nr_seq_caixa_receb,
                null cd_tipo_baixa,
                b.nr_seq_protocolo,
                a.cd_tipo_recebimento,
                'TITULO_RECEBER_LIQ_CONTAB_V2',
                b.nr_titulo nr_seq_tab_orig,
                a.nr_seq_baixa nr_seq_tab_compl,
                14 nr_seq_info_ctb,
                null ds_observacao_movto,
                null nr_seq_movto_transf,
                a.nr_seq_liq_origem,
                b.nr_seq_proj_rec,
                a.cd_moeda
        from    titulo_receber b,
                titulo_receber_liq_contab_v2 a
        where   a.nr_lote_contabil      = nr_lote_contabil_p
        and     (a.nr_seq_trans_fin IS NOT NULL AND a.nr_seq_trans_fin::text <> '')
        and     ((ie_contab_rec_classif_w = 'N') or (a.ds_atributo <> 'VL_RECEBIDO_TESOURARIA'))
        and     a.ds_atributo not in ('VL_RECEBIDO','VL_RECEBIDO_CB', 'VL_GLOSA', 'VL_REC_MAIOR')
        and     ie_contab_cr_w          = 'S'
        and     a.nr_titulo             = b.nr_titulo
        and     coalesce(a.ie_lote_pro_rata::text, '') = ''
        and     ((a.nr_seq_caixa_rec IS NOT NULL AND a.nr_seq_caixa_rec::text <> '') or
                 exists (select 1
                        from    movto_trans_financ x
                        where   x.nr_sequencia          = a.nr_seq_movto_trans_fin
                        and     (x.nr_seq_saldo_caixa IS NOT NULL AND x.nr_seq_saldo_caixa::text <> '')) or (nr_seq_trans_caixa IS NOT NULL AND nr_seq_trans_caixa::text <> ''))
        
union all

        select  3 ie_union,/* Francisco - OS 53121 - 20/04/07 - Contabilizar contas pagar */
                a.nr_seq_movto_trans_fin nr_sequencia,
                a.vl_transacao,
                a.nr_seq_trans_fin,
                coalesce(a.dt_baixa,clock_timestamp()) dt_transacao,
                a.ds_atributo,
                a.nr_seq_conta_banco,
                b.cd_cgc,
                a.cd_conta_contabil cd_conta_contab_caixa,
                CASE WHEN ie_centro_custo_tit_pagar_w='N' THEN 0  ELSE CASE WHEN coalesce(t.ie_acao,0)=0 THEN 0 WHEN coalesce(t.ie_acao,0)=2 THEN coalesce(a.cd_centro_custo,0)  ELSE 0 END  END  cd_centro_custo,
                '' nr_documento,
                'D' ie_caixa,
                null ie_saldo_caixa,
                'C' ie_debito_credito,
                CASE WHEN ie_agrupa_w='N' THEN  b.nr_titulo WHEN ie_agrupa_w='S' THEN  0  ELSE b.nr_titulo END ,
                '' ds_historico,
                b.cd_pessoa_fisica,
                obter_pessoa_titulo_pagar(b.nr_titulo) ds_compl_pf_pj,
                0,
                (null)::numeric  cd_historico,
                coalesce(to_char(b.nr_documento),'0') nr_doc_movto,
                0 nr_adiant_movto,
                0 nr_interno_conta_movto,
                '' nr_cheque_movto,
                '' ds_hist_movto,
                '' ds_compl_pf_pj_movto,
                0 cd_hist_caixa_movto,
                a.nr_bordero,
                b.nr_titulo nr_seq_titulo_pagar,
                0 nr_seq_titulo_receber,
                0 nr_seq_nota_fiscal,
                0 nr_seq_conv_receb,
                0 nr_seq_deposito,
                0 nr_adiant_pago,
                0 nr_seq_cheque,
                CASE WHEN ie_conta_contab_tit_pagar_w='N' THEN ''  ELSE CASE WHEN coalesce(t.ie_acao,0)=0 THEN '' WHEN coalesce(t.ie_acao,0)=2 THEN coalesce(a.cd_conta_contabil,'')  ELSE '' END  END  cd_conta_contabil,
                obter_pessoa_titulo_pagar(b.nr_titulo),
                (null)::numeric  nr_seq_caixa,
                coalesce(a.dt_baixa,clock_timestamp()),
                somente_numero(obter_dados_tit_pagar(b.nr_titulo,'NF')) nr_nota_fiscal,
                (null)::numeric  nr_seq_caixa_rec,
                null ds_bandeira,
                null ds_obs_cartao,
                (null)::numeric  nr_seq_produto,
                (null)::numeric  nr_seq_caixa_od,
                null cd_conta_deb_pls,
                null cd_conta_rec_pls,
                null cd_historico_pls,
                '' nr_autorizacao,
                null nr_seq_movto_cartao,
                (null)::numeric  vl_antecipacao_mens,
                to_char(null) ie_lote_antecip_pls,
                to_date(null) dt_referencia_pls_mens,
                (null)::numeric  nr_seq_baixa,
                b.cd_estabelecimento cd_estab_movto,
                null nr_seq_liq_cc,
                null nr_doc_tit_receb,
                null ie_lote_pro_rata,
                null nr_seq_cheque_cp,
                a.nr_seq_movto_trans_fin,
                null nr_seq_caixa_receb,
                a.cd_tipo_baixa,
                null nr_seq_protocolo,
                null cd_tipo_recebimento,
                'TITULO_PAGAR_BAIXA_CC_CONTAB_V',
                b.nr_titulo nr_seq_tab_orig,
                a.nr_seq_baixa nr_seq_tab_compl,
                13 nr_seq_info_ctb,
                null ds_observacao_movto,
                null nr_seq_movto_transf,
                null nr_seq_liq_origem,
                b.nr_seq_proj_rec,
                a.cd_moeda
        FROM titulo_pagar b, titulo_pagar_baixa_cc_contab_v a
LEFT OUTER JOIN transacao_financeira t ON (a.nr_seq_trans_fin = t.nr_sequencia)
WHERE a.nr_lote_contabil      = nr_lote_contabil_p and (a.nr_seq_trans_fin IS NOT NULL AND a.nr_seq_trans_fin::text <> '') and a.ds_atributo   <> 'VL_PAGO' and ie_contab_cp_w  = 'S' and a.nr_titulo             = b.nr_titulo  and exists (select 1
                        from    movto_trans_financ x
                        where   x.nr_sequencia          = a.nr_seq_movto_trans_fin
                        and     (x.nr_seq_saldo_caixa IS NOT NULL AND x.nr_seq_saldo_caixa::text <> ''))
         
union all

        select  4 ie_union,
                e.nr_sequencia,
                coalesce(d.vl_baixa, c.vl_glosa),
                c.nr_seq_trans_fin,
                coalesce(e.dt_transacao,clock_timestamp()) dt_transacao,
                'VL_GLOSA',
                c.nr_seq_conta_banco,
                b.cd_cgc,
                '' cd_conta_contab_caixa,
                d.cd_centro_custo,
                e.nr_documento nr_documento,
                'D' ie_caixa,
                null ie_saldo_caixa,
                'D' ie_debito_credito,
                CASE WHEN ie_agrupa_w='N' THEN  c.nr_seq_movto_trans_fin WHEN ie_agrupa_w='S' THEN  0  ELSE c.nr_seq_movto_trans_fin END ,
                '' ds_historico,
                b.cd_pessoa_fisica,
                obter_pessoa_titulo_receber(b.nr_titulo) ds_compl_pf_pj,
                0,
                (null)::numeric  cd_historico,
                e.nr_documento nr_doc_movto,
                0 nr_adiant_movto,
                b.nr_interno_conta nr_interno_conta_movto,
                '' nr_cheque_movto,
                '' ds_hist_movto,
                '' ds_compl_pf_pj_movto,
                0 cd_hist_caixa_movto,
                0 nr_bordero,
                0 nr_seq_titulo_pagar,
                b.nr_titulo nr_seq_titulo_receber,
                0 nr_seq_nota_fiscal,
                0 nr_seq_conv_receb,
                0 nr_seq_deposito,
                0 nr_adiant_pago,
                0 nr_seq_cheque,
                '' cd_conta_contabil,
                obter_pessoa_titulo_receber(b.nr_titulo),
                (null)::numeric  nr_seq_caixa,
                coalesce(e.dt_transacao,clock_timestamp()),
                somente_numero(obter_dados_titulo_receber(b.nr_titulo,'NFT')) nr_nota_fiscal,
                e.nr_seq_caixa_rec,
                null ds_bandeira,
                null ds_obs_cartao,
                d.nr_seq_produto,
                e.nr_seq_caixa_od,
                null cd_conta_deb_pls,
                null cd_conta_rec_pls,
                null cd_historico_pls,
                substr(obter_dados_cartao_cr(e.nr_seq_movto_cartao,'AUT'),1,40) nr_autorizacao,
                e.nr_seq_movto_cartao,
                (null)::numeric  vl_antecipacao_mens,
                to_char(null) ie_lote_antecip_pls,
                to_date(null) dt_referencia_pls_mens,
                (null)::numeric  nr_seq_baixa,
                b.cd_estabelecimento cd_estab_movto,
                null nr_seq_liq_cc,
                c.nr_documento nr_doc_tit_receb,
                null ie_lote_pro_rata,
                e.nr_seq_cheque_cp,
                e.nr_sequencia,
                null nr_seq_caixa_receb,
                null cd_tipo_baixa,
                b.nr_seq_protocolo,
                c.cd_tipo_recebimento,
                CASE WHEN coalesce(d.nr_sequencia::text, '') = '' THEN  'TITULO_RECEBER_LIQ'  ELSE 'TITULO_RECEBER_LIQ_CC' END ,
                b.nr_titulo nr_seq_tab_orig,
                coalesce(d.nr_sequencia, c.nr_sequencia) nr_seq_tab_compl,
                60 nr_seq_info_ctb,
                substr(e.ds_observacao,1,255) ds_observacao_movto,
                null nr_seq_movto_transf,
                c.nr_seq_liq_origem,
                b.nr_seq_proj_rec,
                c.cd_moeda
        FROM movto_trans_financ e, titulo_receber b, titulo_receber_liq c
LEFT OUTER JOIN titulo_rec_liq_cc d ON (c.nr_titulo = d.nr_titulo AND c.nr_sequencia = d.nr_seq_baixa)
WHERE c.nr_lote_contabil      = nr_lote_contabil_p and (c.nr_seq_trans_fin IS NOT NULL AND c.nr_seq_trans_fin::text <> '') and ie_contab_cr_w          = 'S' and ie_cc_glosa_w           <> 'N' and c.nr_titulo             = b.nr_titulo   and c.nr_seq_movto_trans_fin        = e.nr_sequencia and coalesce(d.vl_baixa, c.vl_glosa) <> 0
         
union all

        select  5 ie_union,
                c.nr_seq_movto_trans_fin nr_sequencia,
                coalesce(d.vl_amaior, c.vl_rec_maior),
                c.nr_seq_trans_fin,
                coalesce(c.dt_recebimento,clock_timestamp()) dt_transacao,
                'VL_REC_MAIOR',
                c.nr_seq_conta_banco,
                b.cd_cgc,
                '' cd_conta_contab_caixa,
                d.cd_centro_custo,
                '' nr_documento,
                'D' ie_caixa,
                null ie_saldo_caixa,
                'D' ie_debito_credito,
                CASE WHEN ie_agrupa_w='N' THEN  c.nr_seq_movto_trans_fin WHEN ie_agrupa_w='S' THEN  0  ELSE c.nr_seq_movto_trans_fin END ,
                '' ds_historico,
                b.cd_pessoa_fisica,
                obter_pessoa_titulo_receber(b.nr_titulo) ds_compl_pf_pj,
                0,
                (null)::numeric  cd_historico,
                '' nr_doc_movto,
                0 nr_adiant_movto,
                b.nr_interno_conta nr_interno_conta_movto,
                '' nr_cheque_movto,
                '' ds_hist_movto,
                '' ds_compl_pf_pj_movto,
                0 cd_hist_caixa_movto,
                0 nr_bordero,
                0 nr_seq_titulo_pagar,
                b.nr_titulo nr_seq_titulo_receber,
                0 nr_seq_nota_fiscal,
                0 nr_seq_conv_receb,
                0 nr_seq_deposito,
                0 nr_adiant_pago,
                0 nr_seq_cheque,
                '' cd_conta_contabil,
                obter_pessoa_titulo_receber(b.nr_titulo),
                (null)::numeric  nr_seq_caixa,
                coalesce(c.dt_recebimento,clock_timestamp()),
                somente_numero(obter_dados_titulo_receber(b.nr_titulo,'NFT')) nr_nota_fiscal,
                (null)::numeric  nr_seq_caixa_rec,
                null ds_bandeira,
                null ds_obs_cartao,
                d.nr_seq_produto,
                (null)::numeric  nr_seq_caixa_od,
                null cd_conta_deb_pls,
                null cd_conta_rec_pls,
                null cd_historico_pls,
                '' nr_autorizacao,
                null nr_seq_movto_cartao,
                (null)::numeric  vl_antecipacao_mens,
                to_char(null) ie_lote_antecip_pls,
                to_date(null) dt_referencia_pls_mens,
                (null)::numeric  nr_seq_baixa,
                b.cd_estabelecimento cd_estab_movto,
                null nr_seq_liq_cc,
                c.nr_documento nr_doc_tit_receb,
                null ie_lote_pro_rata,
                null nr_seq_cheque_cp,
                null nr_seq_movto_trans_fin,
                null nr_seq_caixa_receb,
                null cd_tipo_baixa,
                b.nr_seq_protocolo,
                c.cd_tipo_recebimento,
                CASE WHEN coalesce(d.nr_sequencia::text, '') = '' THEN  'TITULO_RECEBER_LIQ'  ELSE 'TITULO_RECEBER_LIQ_CC' END ,
                b.nr_titulo nr_seq_tab_orig,
                coalesce(d.nr_sequencia, c.nr_sequencia) nr_seq_tab_compl,
                14 nr_seq_info_ctb,
                null ds_observacao_movto,
                null nr_seq_movto_transf,
                c.nr_seq_liq_origem,
                b.nr_seq_proj_rec,
                c.cd_moeda
        FROM titulo_receber b, titulo_receber_liq c
LEFT OUTER JOIN titulo_rec_liq_cc d ON (c.nr_titulo = d.nr_titulo AND c.nr_sequencia = d.nr_seq_baixa)
WHERE c.nr_lote_contabil      = nr_lote_contabil_p and (c.nr_seq_trans_fin IS NOT NULL AND c.nr_seq_trans_fin::text <> '') and ie_contab_cr_w  = 'S' and ie_cc_glosa_w   <> 'N' and c.nr_titulo             = b.nr_titulo   and coalesce(d.vl_amaior, c.vl_rec_maior) <> 0 and ((c.nr_seq_caixa_rec IS NOT NULL AND c.nr_seq_caixa_rec::text <> '') or
                 exists (select 1
                        from    movto_trans_financ x
                        where   x.nr_sequencia          = c.nr_seq_movto_trans_fin
                        and     (x.nr_seq_saldo_caixa IS NOT NULL AND x.nr_seq_saldo_caixa::text <> '')) or (nr_seq_trans_caixa IS NOT NULL AND nr_seq_trans_caixa::text <> ''))
         
union all
                                        -- Edgar 19/04/2008, OS 77456, contabilizar deposito_cheque de forma analitica
        select  6 ie_union,
                b.nr_sequencia,
                g.vl_cheque * CASE WHEN b.ie_estorno='E' THEN  -1  ELSE 1 END  vl_transacao,
                b.nr_seq_trans_financ,
                b.dt_transacao,
                'VL_CHEQUE_DEPOSITO',
                b.nr_seq_banco_od,
                substr(obter_compl_trans_fin(b.nr_sequencia, 'PJ'),1,255) cd_cgc,
                CASE WHEN d.ie_caixa='M' THEN  obter_conta_caixa(c.nr_sequencia, dt_contabil_w)  ELSE b.cd_conta_contabil END ,
                coalesce(e.cd_centro_custo,b.cd_centro_custo) cd_centro_custo,
                coalesce(b.nr_documento,coalesce(b.nr_adiantamento,coalesce(b.nr_bordero, b.nr_interno_conta))),
                d.ie_caixa,
                d.ie_saldo_caixa,
                CASE WHEN ie_saldo_caixa='E' THEN 'D'  ELSE 'C' END  ie_debito_credito,
                CASE WHEN ie_agrupa_w='N' THEN  f.nr_seq_cheque WHEN ie_agrupa_w='S' THEN  0  ELSE f.nr_seq_cheque END ,
                ds_historico,
                substr(obter_compl_trans_fin(b.nr_sequencia, 'PF'),1,255) cd_pessoa_fisica,
                substr(obter_compl_trans_fin(b.nr_sequencia, 'N'),1,255) ds_compl_pf_pj,
                coalesce(d.cd_historico_caixa, CASE WHEN ie_saldo_caixa='E' THEN  cd_hist_parametro_w  ELSE coalesce(cd_historico_cred_w,cd_hist_parametro_w) END ),
                b.cd_historico,
                b.nr_documento nr_doc_movto,                    -- os campos abaixo sao para montagems do compl hitorico por atributo
                b.nr_adiantamento nr_adiant_movto,
                b.nr_interno_conta nr_interno_conta_movto,
                substr(obter_dados_cheque_cr(f.nr_seq_cheque, 'N'),1,255) nr_cheque_movto,
                b.ds_historico ds_hist_movto,
                substr(obter_compl_trans_fin(b.nr_sequencia, 'N'),1,255) ds_compl_pf_pj_movto,
                d.cd_historico_caixa cd_hist_caixa_movto,
                b.nr_bordero,
                b.nr_seq_titulo_pagar,
                b.nr_seq_titulo_receber,
                b.nr_seq_nota_fiscal,
                b.nr_seq_conv_receb,
                b.nr_seq_deposito,
                b.nr_adiant_pago,
                f.nr_seq_cheque,
                obter_conta_caixa(c.nr_sequencia, dt_contabil_w),
                coalesce(obter_pessoa_titulo_pagar(b.nr_seq_titulo_pagar), obter_pessoa_titulo_receber(b.nr_seq_titulo_receber)),
                c.nr_sequencia nr_seq_caixa,
                b.dt_transacao,
                somente_numero(substr(coalesce(obter_dados_nota_fiscal(b.nr_seq_nota_fiscal,'0'),
                        coalesce(obter_dados_titulo_receber(coalesce(g.nr_titulo, b.nr_seq_titulo_receber),'NFT'),
                        obter_dados_tit_pagar(b.nr_seq_titulo_pagar,'NF'))),1,20)) nr_nota_fiscal,
                b.nr_seq_caixa_rec,
                null ds_bandeira,
                null ds_obs_cartao,
                (null)::numeric  nr_seq_produto,
                b.nr_seq_caixa_od,
                null cd_conta_deb_pls,
                null cd_conta_rec_pls,
                null cd_historico_pls,
                substr(obter_dados_cartao_cr(b.nr_seq_movto_cartao,'AUT'),1,40) nr_autorizacao,
                b.nr_seq_movto_cartao,
                (null)::numeric  vl_antecipacao_mens,
                to_char(null) ie_lote_antecip_pls,
                to_date(null) dt_referencia_pls_mens,
                (null)::numeric  nr_seq_baixa,
                0 cd_estab_movto,
                null nr_seq_liq_cc,
                null nr_doc_tit_receb,
                null ie_lote_pro_rata,
                b.nr_seq_cheque_cp,
                b.nr_sequencia,
                null nr_seq_caixa_receb,
                null cd_tipo_baixa,
                null nr_seq_protocolo,
                b.cd_tipo_recebimento,
                'MOVTO_TRANS_FINANC',
                b.nr_sequencia nr_seq_tab_orig,
                g.nr_seq_cheque nr_seq_tab_compl,
                61 nr_seq_info_ctb,
                substr(b.ds_observacao,1,255) ds_observacao_movto,
                null nr_seq_movto_transf,
                null nr_seq_liq_origem,
                b.nr_seq_proj_rec,
                b.cd_moeda
        FROM cheque_cr g, deposito_cheque f, transacao_financeira d, caixa c, caixa_saldo_diario a, movto_trans_financ b
LEFT OUTER JOIN movto_trans_financ_cc e ON (b.nr_sequencia = e.nr_seq_movto_trans)
WHERE a.nr_lote_contabil      = nr_lote_contabil_p and a.nr_seq_caixa          = c.nr_sequencia and a.nr_sequencia          = b.nr_seq_saldo_caixa and (b.nr_seq_trans_financ IS NOT NULL AND b.nr_seq_trans_financ::text <> '')  and b.nr_seq_trans_financ   = d.nr_sequencia and b.nr_seq_deposito       = f.nr_seq_deposito and f.nr_seq_cheque         = g.nr_seq_cheque
         
union all

        select  7 ie_union,             -- Edgar 19/04/2008, OS 77456, contabilizar valor em esecie do deposito de forma analitica
                b.nr_sequencia,
                f.vl_especie * CASE WHEN b.ie_estorno='E' THEN  -1  ELSE 1 END  vl_transacao,
                b.nr_seq_trans_financ,
                b.dt_transacao,
                'VL_ESPECIE_DEPOSITO',
                b.nr_seq_banco_od,
                substr(obter_compl_trans_fin(b.nr_sequencia, 'PJ'),1,255) cd_cgc,
                CASE WHEN d.ie_caixa='M' THEN  obter_conta_caixa(c.nr_sequencia, dt_contabil_w)  ELSE b.cd_conta_contabil END ,
                coalesce(e.cd_centro_custo,b.cd_centro_custo) cd_centro_custo,
                coalesce(b.nr_documento,coalesce(b.nr_adiantamento,coalesce(b.nr_bordero, b.nr_interno_conta))),
                d.ie_caixa,
                d.ie_saldo_caixa,
                CASE WHEN ie_saldo_caixa='E' THEN 'D'  ELSE 'C' END  ie_debito_credito,
                CASE WHEN ie_agrupa_w='N' THEN  f.nr_sequencia WHEN ie_agrupa_w='S' THEN  0  ELSE f.nr_sequencia END ,
                ds_historico,
                substr(obter_compl_trans_fin(b.nr_sequencia, 'PF'),1,255) cd_pessoa_fisica,
                substr(obter_compl_trans_fin(b.nr_sequencia, 'N'),1,255) ds_compl_pf_pj,
                coalesce(d.cd_historico_caixa, CASE WHEN ie_saldo_caixa='E' THEN  cd_hist_parametro_w  ELSE coalesce(cd_historico_cred_w,cd_hist_parametro_w) END ),
                b.cd_historico,
                b.nr_documento nr_doc_movto,                    -- os campos abaixo sao para montagems do compl hitorico por atributo
                b.nr_adiantamento nr_adiant_movto,
                b.nr_interno_conta nr_interno_conta_movto,
                substr(obter_dados_cheque_cr(b.nr_seq_cheque, 'N'),1,255) nr_cheque_movto,
                b.ds_historico ds_hist_movto,
                substr(obter_compl_trans_fin(b.nr_sequencia, 'N'),1,255) ds_compl_pf_pj_movto,
                d.cd_historico_caixa cd_hist_caixa_movto,
                b.nr_bordero,
                b.nr_seq_titulo_pagar,
                b.nr_seq_titulo_receber,
                b.nr_seq_nota_fiscal,
                b.nr_seq_conv_receb,
                b.nr_seq_deposito,
                b.nr_adiant_pago,
                b.nr_seq_cheque,
                obter_conta_caixa(c.nr_sequencia, dt_contabil_w),
                coalesce(obter_pessoa_titulo_pagar(b.nr_seq_titulo_pagar), obter_pessoa_titulo_receber(b.nr_seq_titulo_receber)),
                c.nr_sequencia nr_seq_caixa,
                b.dt_transacao,
                somente_numero(substr(coalesce(obter_dados_nota_fiscal(b.nr_seq_nota_fiscal,'0'),
                        coalesce(obter_dados_titulo_receber(b.nr_seq_titulo_receber,'NFT'),
                        obter_dados_tit_pagar(b.nr_seq_titulo_pagar,'NF'))),1,20)) nr_nota_fiscal,
                b.nr_seq_caixa_rec,
                null ds_bandeira,
                null ds_obs_cartao,
                (null)::numeric  nr_seq_produto,
                b.nr_seq_caixa_od,
                null cd_conta_deb_pls,
                null cd_conta_rec_pls,
                null cd_historico_pls,
                substr(obter_dados_cartao_cr(b.nr_seq_movto_cartao,'AUT'),1,40) nr_autorizacao,
                b.nr_seq_movto_cartao,
                (null)::numeric  vl_antecipacao_mens,
                to_char(null) ie_lote_antecip_pls,
                to_date(null) dt_referencia_pls_mens,
                (null)::numeric  nr_seq_baixa,
                0 cd_estab_movto,
                null nr_seq_liq_cc,
                null nr_doc_tit_receb,
                null ie_lote_pro_rata,
                b.nr_seq_cheque_cp,
                b.nr_sequencia,
                null nr_seq_caixa_receb,
                null cd_tipo_baixa,
                null nr_seq_protocolo,
                b.cd_tipo_recebimento,
                'MOVTO_TRANS_FINANC' nm_tabela,
                b.nr_sequencia nr_seq_tab_orig,
                f.nr_sequencia nr_seq_tab_compl,
                62 nr_seq_info_ctb,
                substr(b.ds_observacao,1,255) ds_observacao_movto,
                null nr_seq_movto_transf,
                null nr_seq_liq_origem,
                b.nr_seq_proj_rec,
                b.cd_moeda
        FROM deposito f, transacao_financeira d, caixa c, caixa_saldo_diario a, movto_trans_financ b
LEFT OUTER JOIN movto_trans_financ_cc e ON (b.nr_sequencia = e.nr_seq_movto_trans)
WHERE a.nr_lote_contabil      = nr_lote_contabil_p and a.nr_seq_caixa          = c.nr_sequencia and a.nr_sequencia          = b.nr_seq_saldo_caixa and (b.nr_seq_trans_financ IS NOT NULL AND b.nr_seq_trans_financ::text <> '')  and b.nr_seq_trans_financ   = d.nr_sequencia and b.nr_seq_deposito       = f.nr_sequencia and coalesce(f.vl_especie,0)     > 0
         
union all

        select  8 ie_union,
                e.nr_sequencia,
                CASE WHEN c.ie_acao='I' THEN  d.vl_recebido  ELSE d.vl_recebido * -1 END ,
                c.nr_seq_trans_fin,
                c.dt_recebimento,
                'VL_REC_PLS',
                c.nr_seq_conta_banco,
                b.cd_cgc,
                '' cd_conta_contab_caixa,
                d.cd_centro_custo,
                to_char(b.nr_documento) nr_documento,
                'D' ie_caixa,
                null ie_saldo_caixa,
                'D' ie_debito_credito,
                CASE WHEN ie_agrupa_w='N' THEN  c.nr_seq_movto_trans_fin WHEN ie_agrupa_w='S' THEN  0  ELSE c.nr_seq_movto_trans_fin END ,
                '' ds_historico,
                b.cd_pessoa_fisica,
                obter_pessoa_titulo_receber(b.nr_titulo) ds_compl_pf_pj,
                0,
                (null)::numeric  cd_historico,
                to_char(b.nr_documento) nr_doc_movto,
                0 nr_adiant_movto,
                b.nr_interno_conta nr_interno_conta_movto,
                '' nr_cheque_movto,
                '' ds_hist_movto,
                '' ds_compl_pf_pj_movto,
                0 cd_hist_caixa_movto,
                0 nr_bordero,
                0 nr_seq_titulo_pagar,
                b.nr_titulo nr_seq_titulo_receber,
                0 nr_seq_nota_fiscal,
                0 nr_seq_conv_receb,
                0 nr_seq_deposito,
                0 nr_adiant_pago,
                0 nr_seq_cheque,
                '' cd_conta_contabil,
                obter_pessoa_titulo_receber(b.nr_titulo),
                (null)::numeric  nr_seq_caixa,
                coalesce(e.dt_transacao,clock_timestamp()),
                somente_numero(obter_dados_titulo_receber(b.nr_titulo,'NFT')) nr_nota_fiscal,
                e.nr_seq_caixa_rec,
                null ds_bandeira,
                null ds_obs_cartao,
                d.nr_seq_produto,
                e.nr_seq_caixa_od,
                d.cd_conta_deb_pls,
                d.cd_conta_rec_pls,
                d.cd_historico_pls,
                substr(obter_dados_cartao_cr(e.nr_seq_movto_cartao,'AUT'),1,40) nr_autorizacao,
                e.nr_seq_movto_cartao,
                d.vl_antecipacao_mens,
                'B' ie_lote_antecip_pls,
                c.dt_referencia_pls_mens,
                c.nr_sequencia,
                b.cd_estabelecimento cd_estab_movto,
                d.nr_sequencia nr_seq_liq_cc,
                c.nr_documento nr_doc_tit_receb,
                CASE WHEN d.ie_lote_pro_rata='BA' THEN d.ie_lote_pro_rata  ELSE null END ,
                e.nr_seq_cheque_cp,
                e.nr_sequencia,
                null nr_seq_caixa_receb,
                null cd_tipo_baixa,
                b.nr_seq_protocolo,
                c.cd_tipo_recebimento,
                'TITULO_RECEBER_LIQ_CC',
                b.nr_titulo nr_seq_tab_orig,
                d.nr_sequencia nr_seq_tab_compl,
                14 nr_seq_info_ctb,
                substr(e.ds_observacao,1,255) ds_observacao_movto,
                null nr_seq_movto_transf,
                c.nr_seq_liq_origem,
                b.nr_seq_proj_rec,
                c.cd_moeda
        from    movto_trans_financ e,
                titulo_rec_liq_cc d,
                titulo_receber_liq c,
                titulo_receber b
        where   c.nr_lote_contabil      = nr_lote_contabil_p
        and     (c.nr_seq_trans_fin IS NOT NULL AND c.nr_seq_trans_fin::text <> '')
        and     ie_contab_cr_w          = 'S'
        and     c.nr_titulo             = b.nr_titulo
        and     d.nr_titulo             = c.nr_titulo
        and     d.nr_seq_baixa          = c.nr_sequencia
        and     c.nr_seq_movto_trans_fin        = e.nr_sequencia
        and (ie_contab_classif_mens_w = 'N' or
                not exists (select 1
                                from    pls_titulo_rec_liq_mens x
                                where   x.nr_titulo     = b.nr_titulo
                                and     x.nr_seq_baixa  = c.nr_sequencia))
        
union all

        /* Francisco - 25/05/2010 - OS  203923 */

        select  9 ie_union,
                e.nr_sequencia,
                CASE WHEN c.ie_acao='I' THEN  d.vl_recebido  ELSE d.vl_recebido * -1 END ,
                c.nr_seq_trans_fin,
                c.dt_recebimento,
                'VL_REC_PLS',
                c.nr_seq_conta_banco,
                b.cd_cgc,
                '' cd_conta_contab_caixa,
                d.cd_centro_custo,
                to_char(b.nr_documento) nr_documento,
                'D' ie_caixa,
                null ie_saldo_caixa,
                'D' ie_debito_credito,
                CASE WHEN ie_agrupa_w='N' THEN  c.nr_seq_movto_trans_fin WHEN ie_agrupa_w='S' THEN  0  ELSE c.nr_seq_movto_trans_fin END ,
                '' ds_historico,
                b.cd_pessoa_fisica,
                obter_pessoa_titulo_receber(b.nr_titulo) ds_compl_pf_pj,
                0,
                (null)::numeric  cd_historico,
                to_char(b.nr_documento) nr_doc_movto,
                0 nr_adiant_movto,
                b.nr_interno_conta nr_interno_conta_movto,
                '' nr_cheque_movto,
                '' ds_hist_movto,
                '' ds_compl_pf_pj_movto,
                0 cd_hist_caixa_movto,
                0 nr_bordero,
                0 nr_seq_titulo_pagar,
                b.nr_titulo nr_seq_titulo_receber,
                0 nr_seq_nota_fiscal,
                0 nr_seq_conv_receb,
                0 nr_seq_deposito,
                0 nr_adiant_pago,
                0 nr_seq_cheque,
                '' cd_conta_contabil,
                obter_pessoa_titulo_receber(b.nr_titulo),
                (null)::numeric  nr_seq_caixa,
                coalesce(e.dt_transacao,clock_timestamp()),
                somente_numero(obter_dados_titulo_receber(b.nr_titulo,'NFT')) nr_nota_fiscal,
                e.nr_seq_caixa_rec,
                null ds_bandeira,
                null ds_obs_cartao,
                d.nr_seq_produto,
                e.nr_seq_caixa_od,
                d.cd_conta_deb_pls,
                d.cd_conta_rec_pls,
                d.cd_historico_pls,
                substr(obter_dados_cartao_cr(e.nr_seq_movto_cartao,'AUT'),1,40) nr_autorizacao,
                e.nr_seq_movto_cartao,
                d.vl_antecipacao_mens,
                'A' ie_lote_antecip_pls,
                c.dt_referencia_pls_mens,
                c.nr_sequencia,
                b.cd_estabelecimento cd_estab_movto,
                d.nr_sequencia nr_seq_liq_cc,
                c.nr_documento nr_doc_tit_receb,
                CASE WHEN d.ie_lote_pro_rata='AN' THEN d.ie_lote_pro_rata  ELSE null END ,
                e.nr_seq_cheque_cp,
                e.nr_sequencia,
                null nr_seq_caixa_receb,
                null cd_tipo_baixa,
                b.nr_seq_protocolo,
                c.cd_tipo_recebimento,
                'TITULO_RECEBER_LIQ_CC',
                b.nr_titulo nr_seq_tab_orig,
                d.nr_sequencia nr_seq_tab_compl,
                14 nr_seq_info_ctb,
                substr(e.ds_observacao,1,255) ds_observacao_movto,
                null nr_seq_movto_transf,
                c.nr_seq_liq_origem,
                b.nr_seq_proj_rec,
                c.cd_moeda
        from    movto_trans_financ e,
                titulo_rec_liq_cc d,
                titulo_receber_liq c,
                titulo_receber b
        where   c.nr_lote_contab_antecip        = nr_lote_contabil_p
        and     (c.nr_seq_trans_fin IS NOT NULL AND c.nr_seq_trans_fin::text <> '')
        and     ie_contab_cr_w                  = 'S'
        and     c.nr_titulo                     = b.nr_titulo
        and     d.nr_titulo                     = c.nr_titulo
        and     d.nr_seq_baixa                  = c.nr_sequencia
        and     c.nr_seq_movto_trans_fin        = e.nr_sequencia
        and (ie_contab_classif_mens_w = 'N' or
                not exists (select 1
                                from    pls_titulo_rec_liq_mens x
                                where   x.nr_titulo     = b.nr_titulo
                                and     x.nr_seq_baixa  = c.nr_sequencia))
        
union all

        /* Francisco - 26/05/2010 -  220155 */

        select  10 ie_union,
                e.nr_sequencia,
                CASE WHEN c.ie_acao='I' THEN  d.vl_recebido  ELSE d.vl_recebido * -1 END ,
                c.nr_seq_trans_fin,
                c.dt_recebimento,
                'VL_REC_PLS',
                c.nr_seq_conta_banco,
                b.cd_cgc,
                '' cd_conta_contab_caixa,
                d.cd_centro_custo,
                to_char(b.nr_documento) nr_documento,
                'D' ie_caixa,
                null ie_saldo_caixa,
                'D' ie_debito_credito,
                CASE WHEN ie_agrupa_w='N' THEN  c.nr_seq_movto_trans_fin WHEN ie_agrupa_w='S' THEN  0  ELSE c.nr_seq_movto_trans_fin END ,
                '' ds_historico,
                b.cd_pessoa_fisica,
                obter_pessoa_titulo_receber(b.nr_titulo) ds_compl_pf_pj,
                0,
                (null)::numeric  cd_historico,
                to_char(b.nr_documento) nr_doc_movto,
                0 nr_adiant_movto,
                b.nr_interno_conta nr_interno_conta_movto,
                '' nr_cheque_movto,
                '' ds_hist_movto,
                '' ds_compl_pf_pj_movto,
                0 cd_hist_caixa_movto,
                0 nr_bordero,
                0 nr_seq_titulo_pagar,
                b.nr_titulo nr_seq_titulo_receber,
                0 nr_seq_nota_fiscal,
                0 nr_seq_conv_receb,
                0 nr_seq_deposito,
                0 nr_adiant_pago,
                0 nr_seq_cheque,
                '' cd_conta_contabil,
                obter_pessoa_titulo_receber(b.nr_titulo),
                (null)::numeric  nr_seq_caixa,
                coalesce(e.dt_transacao,clock_timestamp()),
                somente_numero(obter_dados_titulo_receber(b.nr_titulo,'NFT')) nr_nota_fiscal,
                e.nr_seq_caixa_rec,
                null ds_bandeira,
                null ds_obs_cartao,
                d.nr_seq_produto,
                e.nr_seq_caixa_od,
                d.cd_conta_deb_pls,
                d.cd_conta_rec_pls,
                d.cd_historico_pls,
                substr(obter_dados_cartao_cr(e.nr_seq_movto_cartao,'AUT'),1,40) nr_autorizacao,
                e.nr_seq_movto_cartao,
                d.vl_antecipacao_mens,
                'P' ie_lote_antecip_pls,
                c.dt_referencia_pls_mens,
                c.nr_sequencia,
                b.cd_estabelecimento cd_estab_movto,
                d.nr_sequencia nr_seq_liq_cc,
                c.nr_documento nr_doc_tit_receb,
                CASE WHEN d.ie_lote_pro_rata='PR' THEN d.ie_lote_pro_rata  ELSE null END ,
                e.nr_seq_cheque_cp,
                e.nr_sequencia,
                null nr_seq_caixa_receb,
                null cd_tipo_baixa,
                b.nr_seq_protocolo,
                c.cd_tipo_recebimento,
                'TITULO_RECEBER_LIQ_CC',
                b.nr_titulo nr_seq_tab_orig,
                d.nr_sequencia nr_seq_tab_compl,
                14 nr_seq_info_ctb,
                substr(e.ds_observacao,1,255) ds_observacao_movto,
                null nr_seq_movto_transf,
                c.nr_seq_liq_origem,
                b.nr_seq_proj_rec,
                c.cd_moeda
        from    movto_trans_financ e,
                titulo_rec_liq_cc d,
                titulo_receber_liq c,
                titulo_receber b
        where   c.nr_lote_contab_pro_rata       = nr_lote_contabil_p
        and     (c.nr_seq_trans_fin IS NOT NULL AND c.nr_seq_trans_fin::text <> '')
        and     ie_contab_cr_w                  = 'S'
        and     c.nr_titulo                     = b.nr_titulo
        and     d.nr_titulo                     = c.nr_titulo
        and     d.nr_seq_baixa                  = c.nr_sequencia
        and     c.nr_seq_movto_trans_fin        = e.nr_sequencia
        and (ie_contab_classif_mens_w = 'N' or
                not exists (select 1
                                from    pls_titulo_rec_liq_mens x
                                where   x.nr_titulo     = b.nr_titulo
                                and     x.nr_seq_baixa  = c.nr_sequencia))
        
union all

        select  11 ie_union,
                0 nr_seq_movto,
                coalesce(b.vl_terceiro,0) vl_transacao,
                b.nr_seq_trans_financ,
                b.dt_negociacao,
                'VL_TERCEIRO',
                null nr_seq_banco_od,
                null cd_cgc,
                CASE WHEN d.ie_caixa='M' THEN  obter_conta_caixa(c.nr_sequencia, dt_contabil_w)  ELSE '' END  cd_conta_contabil,
                null cd_centro_custo,
                to_char(b.nr_seq_cheque) nr_documento,
                d.ie_caixa,
                d.ie_saldo_caixa,
                CASE WHEN d.ie_saldo_caixa='E' THEN 'D'  ELSE 'C' END  ie_debito_credito,
                0,
                null ds_historico,
                null cd_pessoa_fisica,
                null ds_compl_pf_pj,
                coalesce(d.cd_historico_caixa, CASE WHEN ie_saldo_caixa='E' THEN  cd_hist_parametro_w  ELSE coalesce(cd_historico_cred_w,cd_hist_parametro_w) END ),
                null cd_historico,
                null nr_doc_movto,
                null nr_adiant_movto,
                null nr_interno_conta_movto,
                substr(obter_dados_cheque_cr(b.nr_seq_cheque, 'N'),1,255) nr_cheque_movto,
                null ds_hist_movto,
                null ds_compl_pf_pj_movto,
                d.cd_historico_caixa cd_hist_caixa_movto,
                null nr_bordero,
                null nr_seq_titulo_pagar,
                null nr_seq_titulo_receber,
                null nr_seq_nota_fiscal,
                null nr_seq_conv_receb,
                null nr_seq_deposito,
                null nr_adiant_pago,
                b.nr_seq_cheque,
                obter_conta_caixa(c.nr_sequencia, dt_contabil_w),
                null,
                c.nr_sequencia nr_seq_caixa,
                b.dt_negociacao,
                null nr_nota_fiscal,
                b.nr_seq_caixa_rec,
                '' ds_bandeira,
                '' ds_obs_cartao,
                (null)::numeric  nr_seq_produto,
                null nr_seq_caixa_od,
                null cd_conta_deb_pls,
                null cd_conta_rec_pls,
                null cd_historico_pls,
                null nr_autorizacao,
                null nr_seq_movto_cartao,
                (null)::numeric  vl_antecipacao_mens,
                to_char(null) ie_lote_antecip_pls,
                to_date(null) dt_referencia_pls_mens,
                (null)::numeric  nr_seq_baixa,
                0 cd_estab_movto,
                null nr_seq_liq_cc,
                null nr_doc_tit_receb,
                null ie_lote_pro_rata,
                null nr_seq_cheque_cp,
                null nr_seq_movto_trans_fin,
                e.nr_sequencia nr_seq_caixa_receb,
                null cd_tipo_baixa,
                null nr_seq_protocolo,
                e.cd_tipo_receb_caixa cd_tipo_recebimento,
                'CHEQUE_CR_NEGOCIADO',
                b.nr_sequencia nr_seq_tab_orig,
                e.nr_sequencia nr_seq_tab_compl,
                63 nr_seq_info_ctb,
                null ds_observacao_movto,
                null nr_seq_movto_transf,
                null nr_seq_liq_origem,
                null nr_seq_proj_rec,
                null cd_moeda
        from    transacao_financeira d,
                caixa c,
                caixa_receb e,
                cheque_cr_negociado b,
                caixa_saldo_diario a
        where   a.nr_seq_caixa          = c.nr_sequencia
        and     e.nr_seq_saldo_caixa    = a.nr_sequencia
        and     b.nr_seq_caixa_rec      = e.nr_sequencia
        and     a.nr_lote_contabil      = nr_lote_contabil_p
        and     (b.nr_seq_trans_financ IS NOT NULL AND b.nr_seq_trans_financ::text <> '')
        and     b.nr_seq_trans_financ   = d.nr_sequencia
        and     ie_contab_neg_cheque_w  = 'S'
        
union all

        select  12 ie_union,
                0 nr_seq_movto,
                coalesce(b.vl_juros,0) vl_transacao,
                b.nr_seq_trans_financ,
                b.dt_negociacao,
                'VL_JUROS_NEG_CHEQUE',
                null nr_seq_banco_od,
                null cd_cgc,
                CASE WHEN d.ie_caixa='M' THEN  obter_conta_caixa(c.nr_sequencia, dt_contabil_w)  ELSE '' END  cd_conta_contabil,
                null cd_centro_custo,
                to_char(b.nr_seq_cheque) nr_documento,
                d.ie_caixa,
                d.ie_saldo_caixa,
                CASE WHEN d.ie_saldo_caixa='E' THEN 'D'  ELSE 'C' END  ie_debito_credito,
                0,
                null ds_historico,
                null cd_pessoa_fisica,
                null ds_compl_pf_pj,
                coalesce(d.cd_historico_caixa, CASE WHEN ie_saldo_caixa='E' THEN  cd_hist_parametro_w  ELSE coalesce(cd_historico_cred_w,cd_hist_parametro_w) END ),
                null cd_historico,
                null nr_doc_movto,
                null nr_adiant_movto,
                null nr_interno_conta_movto,
                substr(obter_dados_cheque_cr(b.nr_seq_cheque, 'N'),1,255) nr_cheque_movto,
                null ds_hist_movto,
                null ds_compl_pf_pj_movto,
                d.cd_historico_caixa cd_hist_caixa_movto,
                null nr_bordero,
                null nr_seq_titulo_pagar,
                null nr_seq_titulo_receber,
                null nr_seq_nota_fiscal,
                null nr_seq_conv_receb,
                null nr_seq_deposito,
                null nr_adiant_pago,
                b.nr_seq_cheque,
                obter_conta_caixa(c.nr_sequencia, dt_contabil_w),
                null,
                c.nr_sequencia nr_seq_caixa,
                b.dt_negociacao,
                null nr_nota_fiscal,
                b.nr_seq_caixa_rec,
                '' ds_bandeira,
                '' ds_obs_cartao,
                (null)::numeric  nr_seq_produto,
                null nr_seq_caixa_od,
                null cd_conta_deb_pls,
                null cd_conta_rec_pls,
                null cd_historico_pls,
                null nr_autorizacao,
                null nr_seq_movto_cartao,
                (null)::numeric  vl_antecipacao_mens,
                to_char(null) ie_lote_antecip_pls,
                to_date(null) dt_referencia_pls_mens,
                (null)::numeric  nr_seq_baixa,
                0 cd_estab_movto,
                null nr_seq_liq_cc,
                null nr_doc_tit_receb,
                null ie_lote_pro_rata,
                null nr_seq_cheque_cp,
                null nr_seq_movto_trans_fin,
                e.nr_sequencia nr_seq_caixa_receb,
                null cd_tipo_baixa,
                null nr_seq_protocolo,
                e.cd_tipo_receb_caixa cd_tipo_recebimento,
                'CHEQUE_CR_NEGOCIADO',
                b.nr_sequencia nr_seq_tab_orig,
                e.nr_sequencia nr_seq_tab_compl,
                63 nr_seq_info_ctb,
                null ds_observacao_movto,
                null nr_seq_movto_transf,
                null nr_seq_liq_origem,
                null nr_seq_proj_rec,
                null cd_moeda
        from    transacao_financeira d,
                caixa c,
                caixa_receb e,
                cheque_cr_negociado b,
                caixa_saldo_diario a
        where   a.nr_seq_caixa          = c.nr_sequencia
        and     e.nr_seq_saldo_caixa    = a.nr_sequencia
        and     b.nr_seq_caixa_rec      = e.nr_sequencia
        and     a.nr_lote_contabil      = nr_lote_contabil_p
        and     (b.nr_seq_trans_financ IS NOT NULL AND b.nr_seq_trans_financ::text <> '')
        and     b.nr_seq_trans_financ   = d.nr_sequencia
        and     ie_contab_neg_cheque_w  = 'S'
        
union all

        select  13 ie_union,
                0 nr_seq_movto,
                coalesce(b.vl_multa,0) vl_transacao,
                b.nr_seq_trans_financ,
                b.dt_negociacao,
                'VL_MULTA_NEG_CHEQUE',
                null nr_seq_banco_od,
                null cd_cgc,
                CASE WHEN d.ie_caixa='M' THEN  obter_conta_caixa(c.nr_sequencia, dt_contabil_w)  ELSE '' END  cd_conta_contabil,
                null cd_centro_custo,
                to_char(b.nr_seq_cheque) nr_documento,
                d.ie_caixa,
                d.ie_saldo_caixa,
                CASE WHEN d.ie_saldo_caixa='E' THEN 'D'  ELSE 'C' END  ie_debito_credito,
                0,
                null ds_historico,
                null cd_pessoa_fisica,
                null ds_compl_pf_pj,
                coalesce(d.cd_historico_caixa, CASE WHEN ie_saldo_caixa='E' THEN  cd_hist_parametro_w  ELSE coalesce(cd_historico_cred_w,cd_hist_parametro_w) END ),
                null cd_historico,
                null nr_doc_movto,
                null nr_adiant_movto,
                null nr_interno_conta_movto,
                substr(obter_dados_cheque_cr(b.nr_seq_cheque, 'N'),1,255) nr_cheque_movto,
                null ds_hist_movto,
                null ds_compl_pf_pj_movto,
                d.cd_historico_caixa cd_hist_caixa_movto,
                null nr_bordero,
                null nr_seq_titulo_pagar,
                null nr_seq_titulo_receber,
                null nr_seq_nota_fiscal,
                null nr_seq_conv_receb,
                null nr_seq_deposito,
                null nr_adiant_pago,
                b.nr_seq_cheque,
                obter_conta_caixa(c.nr_sequencia, dt_contabil_w),
                null,
                c.nr_sequencia nr_seq_caixa,
                b.dt_negociacao,
                null nr_nota_fiscal,
                b.nr_seq_caixa_rec,
                '' ds_bandeira,
                '' ds_obs_cartao,
                (null)::numeric  nr_seq_produto,
                null nr_seq_caixa_od,
                null cd_conta_deb_pls,
                null cd_conta_rec_pls,
                null cd_historico_pls,
                null nr_autorizacao,
                null nr_seq_movto_cartao,
                (null)::numeric  vl_antecipacao_mens,
                to_char(null) ie_lote_antecip_pls,
                to_date(null) dt_referencia_pls_mens,
                (null)::numeric  nr_seq_baixa,
                0 cd_estab_movto,
                null nr_seq_liq_cc,
                null nr_doc_tit_receb,
                null ie_lote_pro_rata,
                null nr_seq_cheque_cp,
                null nr_seq_movto_trans_fin,
                e.nr_sequencia nr_seq_caixa_receb,
                null cd_tipo_baixa,
                null nr_seq_protocolo,
                e.cd_tipo_receb_caixa cd_tipo_recebimento,
                'CHEQUE_CR_NEGOCIADO',
                b.nr_sequencia nr_seq_tab_orig,
                e.nr_sequencia nr_seq_tab_compl,
                63 nr_seq_info_ctb,
                null ds_observacao_movto,
                null nr_seq_movto_transf,
                null nr_seq_liq_origem,
                null nr_seq_proj_rec,
                null cd_moeda
        from    transacao_financeira d,
                caixa c,
                caixa_receb e,
                cheque_cr_negociado b,
                caixa_saldo_diario a
        where   a.nr_seq_caixa          = c.nr_sequencia
        and     e.nr_seq_saldo_caixa    = a.nr_sequencia
        and     b.nr_seq_caixa_rec      = e.nr_sequencia
        and     a.nr_lote_contabil      = nr_lote_contabil_p
        and     (b.nr_seq_trans_financ IS NOT NULL AND b.nr_seq_trans_financ::text <> '')
        and     b.nr_seq_trans_financ   = d.nr_sequencia
        and     ie_contab_neg_cheque_w  = 'S'
        
union all

        select  14 ie_union,
                0 nr_seq_movto,
                coalesce(b.vl_negociado,0) vl_transacao,
                b.nr_seq_trans_financ,
                b.dt_negociacao,
                'VL_NEGOCIADO_CHEQUE',
                null nr_seq_banco_od,
                null cd_cgc,
                CASE WHEN d.ie_caixa='M' THEN  obter_conta_caixa(c.nr_sequencia, dt_contabil_w)  ELSE '' END  cd_conta_contabil,
                null cd_centro_custo,
                to_char(b.nr_seq_cheque) nr_documento,
                d.ie_caixa,
                d.ie_saldo_caixa,
                CASE WHEN d.ie_saldo_caixa='E' THEN 'D'  ELSE 'C' END  ie_debito_credito,
                0,
                null ds_historico,
                null cd_pessoa_fisica,
                null ds_compl_pf_pj,
                coalesce(d.cd_historico_caixa, CASE WHEN ie_saldo_caixa='E' THEN  cd_hist_parametro_w  ELSE coalesce(cd_historico_cred_w,cd_hist_parametro_w) END ),
                null cd_historico,
                null nr_doc_movto,
                null nr_adiant_movto,
                null nr_interno_conta_movto,
                substr(obter_dados_cheque_cr(b.nr_seq_cheque, 'N'),1,255) nr_cheque_movto,
                null ds_hist_movto,
                null ds_compl_pf_pj_movto,
                d.cd_historico_caixa cd_hist_caixa_movto,
                null nr_bordero,
                null nr_seq_titulo_pagar,
                null nr_seq_titulo_receber,
                null nr_seq_nota_fiscal,
                null nr_seq_conv_receb,
                null nr_seq_deposito,
                null nr_adiant_pago,
                b.nr_seq_cheque,
                obter_conta_caixa(c.nr_sequencia, dt_contabil_w),
                null,
                c.nr_sequencia nr_seq_caixa,
                b.dt_negociacao,
                null nr_nota_fiscal,
                b.nr_seq_caixa_rec,
                '' ds_bandeira,
                '' ds_obs_cartao,
                (null)::numeric  nr_seq_produto,
                null nr_seq_caixa_od,
                null cd_conta_deb_pls,
                null cd_conta_rec_pls,
                null cd_historico_pls,
                null nr_autorizacao,
                null nr_seq_movto_cartao,
                (null)::numeric  vl_antecipacao_mens,
                to_char(null) ie_lote_antecip_pls,
                to_date(null) dt_referencia_pls_mens,
                (null)::numeric  nr_seq_baixa,
                0 cd_estab_movto,
                null nr_seq_liq_cc,
                null nr_doc_tit_receb,
                null ie_lote_pro_rata,
                null nr_seq_cheque_cp,
                null nr_seq_movto_trans_fin,
                e.nr_sequencia nr_seq_caixa_receb,
                null cd_tipo_baixa,
                null nr_seq_protocolo,
                e.cd_tipo_receb_caixa cd_tipo_recebimento,
                'CHEQUE_CR_NEGOCIADO',
                b.nr_sequencia nr_seq_tab_orig,
                e.nr_sequencia nr_seq_tab_compl,
                63 nr_seq_info_ctb,
                null ds_observacao_movto,
                null nr_seq_movto_transf,
                null nr_seq_liq_origem,
                null nr_seq_proj_rec,
                null cd_moeda
        from    transacao_financeira d,
                caixa c,
                caixa_receb e,
                cheque_cr_negociado b,
                caixa_saldo_diario a
        where   a.nr_seq_caixa          = c.nr_sequencia
        and     e.nr_seq_saldo_caixa    = a.nr_sequencia
        and     b.nr_seq_caixa_rec      = e.nr_sequencia
        and     a.nr_lote_contabil      = nr_lote_contabil_p
        and     (b.nr_seq_trans_financ IS NOT NULL AND b.nr_seq_trans_financ::text <> '')
        and     b.nr_seq_trans_financ   = d.nr_sequencia
        and     ie_contab_neg_cheque_w  = 'S'
        
union all

        select  15 ie_union,
                a.nr_seq_movto_trans_fin,
                c.vl_baixa,
                c.nr_seq_trans_financ,
                a.dt_recebimento,
                'VL_TRIB_TIT_REC',
                a.nr_seq_conta_banco,
                b.cd_cgc,
                '' cd_conta_contab_caixa,
                0 cd_centro_custo,
                to_char(b.nr_documento) nr_documento,
                'D' ie_caixa,
                null ie_saldo_caixa,
                'D' ie_debito_credito,
                CASE WHEN ie_agrupa_w='N' THEN  a.nr_seq_movto_trans_fin WHEN ie_agrupa_w='S' THEN  0  ELSE a.nr_seq_movto_trans_fin END ,
                '' ds_historico,
                b.cd_pessoa_fisica,
                obter_pessoa_titulo_receber(b.nr_titulo) ds_compl_pf_pj,
                0 nr_seq_caixa,
                (null)::numeric  cd_historico,
                to_char(b.nr_documento) nr_doc_movto,
                0 nr_adiant_movto,
                b.nr_interno_conta nr_interno_conta_movto,
                '' nr_cheque_movto,
                '' ds_hist_movto,
                '' ds_compl_pf_pj_movto,
                0 cd_hist_caixa_movto,
                0 nr_bordero,
                0 nr_seq_titulo_pagar,
                b.nr_titulo nr_seq_titulo_receber,
                0 nr_seq_nota_fiscal,
                0 nr_seq_conv_receb,
                0 nr_seq_deposito,
                0 nr_adiant_pago,
                0 nr_seq_cheque,
                '' cd_conta_contabil,
                obter_pessoa_titulo_receber(b.nr_titulo),
                (null)::numeric  nr_seq_caixa,
                to_date(null),
                somente_numero(obter_dados_titulo_receber(b.nr_titulo,'NFT')) nr_nota_fiscal,
                0 nr_seq_caixa_rec,
                null ds_bandeira,
                null ds_obs_cartao,
                (null)::numeric  nr_seq_produto,
                (null)::numeric  nr_seq_caixa_od,
                '' cd_conta_deb_pls,
                '' cd_conta_rec_pls,
                (null)::numeric  cd_historico_pls,
                '' nr_autorizacao,
                null nr_seq_movto_cartao,
                (null)::numeric  vl_antecipacao_mens,
                to_char(null) ie_lote_antecip_pls,
                to_date(null) dt_referencia_pls_mens,
                a.nr_sequencia,
                b.cd_estabelecimento cd_estab_movto,
                null nr_seq_liq_cc,
                a.nr_documento nr_doc_tit_receb,
                null ie_lote_pro_rata,
                null nr_seq_cheque_cp,
                null nr_seq_movto_trans_fin,
                null nr_seq_caixa_receb,
                null cd_tipo_baixa,
                b.nr_seq_protocolo,
                a.cd_tipo_recebimento,
                'TITULO_RECEBER_TRIB_BAIXA',
                b.nr_titulo nr_seq_tab_orig,
                c.nr_sequencia nr_seq_tab_compl,
                55 nr_seq_info_ctb,
                null ds_observacao_movto,
                null nr_seq_movto_transf,
                a.nr_seq_liq_origem,
                b.nr_seq_proj_rec,
                a.cd_moeda
        from    titulo_receber_trib_baixa c,
                titulo_receber b,
                titulo_receber_liq a
        where   a.nr_lote_contabil      = nr_lote_contabil_p
        and     (c.nr_seq_trans_financ IS NOT NULL AND c.nr_seq_trans_financ::text <> '')
        and     a.nr_titulo             = b.nr_titulo
        and     a.nr_titulo             = c.nr_titulo
        and     a.nr_sequencia          = c.nr_seq_tit_liq
        and     ((ie_permite_estab_dif_w <> 'N') or (b.cd_estabelecimento       = cd_estabelecimento_w))
        and     coalesce(a.ie_lib_caixa, 'S') = 'S'
        
union all

        select  16 ie_union,
                c.nr_seq_movto_trans_fin,
                CASE WHEN c.ie_acao='I' THEN  d.vl_lancamento  ELSE d.vl_lancamento * -1 END ,
                c.nr_seq_trans_fin,
                --c.dt_recebimento,
                d.dt_contabil,
                'VL_REC_PLS_MENS',
                c.nr_seq_conta_banco,
                b.cd_cgc,
                '' cd_conta_contab_caixa,
                d.cd_centro_custo,
                to_char(b.nr_documento) nr_documento,
                'D' ie_caixa,
                null ie_saldo_caixa,
                CASE WHEN coalesce(d.cd_conta_credito::text, '') = '' THEN  'D'  ELSE 'C' END  ie_debito_credito,
                CASE WHEN ie_agrupa_w='N' THEN  c.nr_seq_movto_trans_fin WHEN ie_agrupa_w='S' THEN  0  ELSE c.nr_seq_movto_trans_fin END ,
                '' ds_historico,
                b.cd_pessoa_fisica,
                obter_pessoa_titulo_receber(b.nr_titulo) ds_compl_pf_pj,
                0,
                (null)::numeric  cd_historico,
                to_char(b.nr_documento) nr_doc_movto,
                0 nr_adiant_movto,
                b.nr_interno_conta nr_interno_conta_movto,
                '' nr_cheque_movto,
                '' ds_hist_movto,
                '' ds_compl_pf_pj_movto,
                0 cd_hist_caixa_movto,
                0 nr_bordero,
                0 nr_seq_titulo_pagar,
                b.nr_titulo nr_seq_titulo_receber,
                0 nr_seq_nota_fiscal,
                0 nr_seq_conv_receb,
                0 nr_seq_deposito,
                0 nr_adiant_pago,
                0 nr_seq_cheque,
                '' cd_conta_contabil,
                obter_pessoa_titulo_receber(b.nr_titulo),
                (null)::numeric  nr_seq_caixa,
                to_date(null),
                somente_numero(obter_dados_titulo_receber(b.nr_titulo,'NFT')) nr_nota_fiscal,
                null nr_seq_caixa_rec,
                null ds_bandeira,
                null ds_obs_cartao,
                null nr_seq_produto,
                null nr_seq_caixa_od,
                d.cd_conta_debito,
                d.cd_conta_credito,
                d.cd_historico,
                null nr_autorizacao,
                null nr_seq_movto_cartao,
                (null)::numeric ,
                'B' ie_lote_antecip_pls,
                CASE WHEN d.ie_tipo_lancamento='EA' THEN  d.dt_contabil  ELSE to_date(null) END  dt_referencia_pls_mens,
                c.nr_sequencia,
                b.cd_estabelecimento cd_estab_movto,
                d.nr_sequencia nr_seq_liq_cc,
                c.nr_documento nr_doc_tit_receb,
                CASE WHEN d.ie_tipo_lancamento='PR' THEN 'AN'  ELSE null END ,
                (null)::numeric  nr_seq_cheque_cp,
                (null)::numeric  nr_sequencia,
                null nr_seq_caixa_receb,
                null cd_tipo_baixa,
                b.nr_seq_protocolo,
                c.cd_tipo_recebimento,
                'PLS_TITULO_REC_LIQ_MENS',
                d.nr_sequencia nr_seq_tab_orig,
                b.nr_titulo nr_seq_tab_compl,
                51 nr_seq_info_ctb,
                null ds_observacao_movto,
                null nr_seq_movto_transf,
                c.nr_seq_liq_origem,
                b.nr_seq_proj_rec,
                c.cd_moeda
        from    pls_titulo_rec_liq_mens d,
                titulo_receber_liq      c,
                titulo_receber          b
        where   d.nr_lote_contabil      = nr_lote_contabil_p
        and     c.nr_titulo             = b.nr_titulo
        and     d.nr_titulo             = c.nr_titulo
        and     d.nr_seq_baixa          = c.nr_sequencia
        and     ie_contab_classif_mens_w = 'S'
        
union all

        select  17 ie_union,
                null,
                c.vl_classificacao,
                b.nr_seq_trans_fin_contab,
                a.dt_recebimento,
                'VL_TITULO_RECEBER',
                a.nr_seq_conta_banco,
                b.cd_cgc,
                '' cd_conta_contab_caixa,
                coalesce(c.cd_centro_custo,0) cd_centro_custo,
                to_char(b.nr_documento) nr_documento,
                'D' ie_caixa,
                null ie_saldo_caixa,
                'D' ie_debito_credito,
                CASE WHEN ie_agrupa_w='N' THEN  b.nr_seq_trans_fin_contab WHEN ie_agrupa_w='S' THEN  0  ELSE b.nr_seq_trans_fin_contab END ,
                '' ds_historico,
                b.cd_pessoa_fisica,
                obter_pessoa_titulo_receber(b.nr_titulo) ds_compl_pf_pj,
                0 nr_seq_caixa,
                (null)::numeric  cd_historico,
                to_char(b.nr_documento) nr_doc_movto,
                0 nr_adiant_movto,
                b.nr_interno_conta nr_interno_conta_movto,
                '' nr_cheque_movto,
                '' ds_hist_movto,
                '' ds_compl_pf_pj_movto,
                0 cd_hist_caixa_movto,
                0 nr_bordero,
                0 nr_seq_titulo_pagar,
                b.nr_titulo nr_seq_titulo_receber,
                0 nr_seq_nota_fiscal,
                0 nr_seq_conv_receb,
                0 nr_seq_deposito,
                0 nr_adiant_pago,
                0 nr_seq_cheque,
                '' cd_conta_contabil,
                obter_pessoa_titulo_receber(b.nr_titulo),
                (null)::numeric  nr_seq_caixa,
                to_date(null),
                somente_numero(obter_dados_titulo_receber(b.nr_titulo,'NFT')) nr_nota_fiscal,
                0 nr_seq_caixa_rec,
                null ds_bandeira,
                null ds_obs_cartao,
                (null)::numeric  nr_seq_produto,
                (null)::numeric  nr_seq_caixa_od,
                '' cd_conta_deb_pls,
                '' cd_conta_rec_pls,
                (null)::numeric  cd_historico_pls,
                '' nr_autorizacao,
                null nr_seq_movto_cartao,
                (null)::numeric  vl_antecipacao_mens,
                to_char(null) ie_lote_antecip_pls,
                to_date(null) dt_referencia_pls_mens,
                a.nr_sequencia,
                b.cd_estabelecimento cd_estab_movto,
                null nr_seq_liq_cc,
                a.nr_documento nr_doc_tit_receb,
                null ie_lote_pro_rata,
                null nr_seq_cheque_cp,
                null nr_seq_movto_trans_fin,
                null nr_seq_caixa_receb,
                null cd_tipo_baixa,
                b.nr_seq_protocolo,
                a.cd_tipo_recebimento,
                'TITULO_RECEBER_LIQ',
                b.nr_titulo nr_seq_tab_orig,
                c.nr_sequencia,
                3 nr_seq_info_ctb,
                null ds_observacao_movto,
                null nr_seq_movto_transf,
                a.nr_seq_liq_origem,
                b.nr_seq_proj_rec,
                a.cd_moeda
        from    titulo_receber b,
                titulo_receber_liq a,
                titulo_receber_classif c
        where   a.nr_lote_contabil      = nr_lote_contabil_p
        and     b.nr_titulo             = c.nr_titulo
        and     c.nr_titulo             = a.nr_titulo
        and     a.nr_titulo             = b.nr_titulo
        and     ie_contab_vl_titulo_rec_w = 'S'
        
union all

        select  18 ie_union,
                a.nr_seq_movto,
                coalesce(a.vl_parcela,0) vl_transacao,
                b.nr_seq_trans_caixa,
                b.dt_transacao,
                'VL_PARCELA_CARTAO',
                null nr_seq_banco_od,
                null cd_cgc,
                '' cd_conta_contabil,
                null cd_centro_custo,
                null nr_documento,
                'D' ie_caixa,
                null ie_saldo_caixa,
                'D' ie_debito_credito,
                0,
                null ds_historico,
                null cd_pessoa_fisica,
                null ds_compl_pf_pj,
                null,
                null cd_historico,
                null nr_doc_movto,
                null nr_adiant_movto,
                null nr_interno_conta_movto,
                null nr_cheque_movto,
                null ds_hist_movto,
                null ds_compl_pf_pj_movto,
                null cd_hist_caixa_movto,
                null nr_bordero,
                null nr_seq_titulo_pagar,
                null nr_seq_titulo_receber,
                null nr_seq_nota_fiscal,
                null nr_seq_conv_receb,
                null nr_seq_deposito,
                null nr_adiant_pago,
                null nr_seq_cheque,
                null ,
                null,
                null  nr_seq_caixa,
                a.dt_parcela,
                null nr_nota_fiscal,
                b.nr_seq_caixa_rec,
                '' ds_bandeira,
                '' ds_obs_cartao,
                (null)::numeric  nr_seq_produto,
                null nr_seq_caixa_od,
                null cd_conta_deb_pls,
                null cd_conta_rec_pls,
                null cd_historico_pls,
                null nr_autorizacao,
                b.nr_sequencia nr_seq_movto_cartao,
                (null)::numeric  vl_antecipacao_mens,
                to_char(null) ie_lote_antecip_pls,
                to_date(null) dt_referencia_pls_mens,
                (null)::numeric  nr_seq_baixa,
                0 cd_estab_movto,
                null nr_seq_liq_cc,
                null nr_doc_tit_receb,
                null ie_lote_pro_rata,
                null nr_seq_cheque_cp,
                null nr_seq_movto_trans_fin,
                null nr_seq_caixa_receb,
                null cd_tipo_baixa,
                null nr_seq_protocolo,
                null cd_tipo_recebimento,
                'MOVTO_CARTAO_CR_PARCELA',
                a.nr_sequencia nr_seq_tab_orig,
                b.nr_sequencia nr_seq_tab_compl,
                64 nr_seq_info_ctb,
                null ds_observacao_movto,
                null nr_seq_movto_transf,
                null nr_seq_liq_origem,
                null nr_seq_proj_rec,
                null cd_moeda
        from    movto_cartao_cr_parcela a,
                movto_cartao_cr b
        where   a.nr_seq_movto = b.nr_sequencia
        and     (nr_seq_caixa_rec IS NOT NULL AND nr_seq_caixa_rec::text <> '')
        and     ie_contab_desp_cartao_w = 'S'
        and     a.nr_lote_contabil      = nr_lote_contabil_p
        
union all

        select  19 ie_union,
                a.nr_seq_movto,
                coalesce(a.vl_despesa,0) vl_transacao,
                b.nr_seq_trans_caixa,
                b.dt_transacao,
                'VL_DESPESA_CARTAO',
                null nr_seq_banco_od,
                null cd_cgc,
                '' cd_conta_contabil,
                null cd_centro_custo,
                null nr_documento,
                'D' ie_caixa,
                null ie_saldo_caixa,
                'D' ie_debito_credito,
                0,
                null ds_historico,
                null cd_pessoa_fisica,
                substr(obter_pf_pj_caixa(b.nr_seq_caixa_rec),1,255) ds_compl_pf_pj,
                null,
                null cd_historico,
                null nr_doc_movto,
                null nr_adiant_movto,
                null nr_interno_conta_movto,
                null nr_cheque_movto,
                null ds_hist_movto,
                substr(obter_pf_pj_caixa(b.nr_seq_caixa_rec),1,255) ds_compl_pf_pj_movto,
                null cd_hist_caixa_movto,
                null nr_bordero,
                null nr_seq_titulo_pagar,
                null nr_seq_titulo_receber,
                null nr_seq_nota_fiscal,
                null nr_seq_conv_receb,
                null nr_seq_deposito,
                null nr_adiant_pago,
                null nr_seq_cheque,
                null ,
                null,
                null  nr_seq_caixa,
                a.dt_parcela,
                null nr_nota_fiscal,
                b.nr_seq_caixa_rec,
                '' ds_bandeira,
                '' ds_obs_cartao,
                (null)::numeric  nr_seq_produto,
                null nr_seq_caixa_od,
                null cd_conta_deb_pls,
                null cd_conta_rec_pls,
                null cd_historico_pls,
                b.nr_autorizacao nr_autorizacao,
                b.nr_sequencia nr_seq_movto_cartao,
                (null)::numeric  vl_antecipacao_mens,
                to_char(null) ie_lote_antecip_pls,
                to_date(null) dt_referencia_pls_mens,
                (null)::numeric  nr_seq_baixa,
                0 cd_estab_movto,
                null nr_seq_liq_cc,
                null nr_doc_tit_receb,
                null ie_lote_pro_rata,
                null nr_seq_cheque_cp,
                null nr_seq_movto_trans_fin,
                null nr_seq_caixa_receb,
                null cd_tipo_baixa,
                null nr_seq_protocolo,
                null cd_tipo_recebimento,
                'MOVTO_CARTAO_CR_PARCELA',
                a.nr_sequencia nr_seq_tab_orig,
                b.nr_sequencia nr_seq_tab_compl,
                64 nr_seq_info_ctb,
                null ds_observacao_movto,
                null nr_seq_movto_transf,
                null nr_seq_liq_origem,
                null nr_seq_proj_rec,
                null cd_moeda
        from    movto_cartao_cr_parcela a,
                movto_cartao_cr b
        where   a.nr_seq_movto          = b.nr_sequencia
        and     (nr_seq_caixa_rec IS NOT NULL AND nr_seq_caixa_rec::text <> '')
        and     coalesce(b.dt_cancelamento::text, '') = ''
        and     ie_contab_desp_cartao_w = 'S'
        and     a.nr_lote_contabil      = nr_lote_contabil_p
        
union all

        select  20 ie_union,
                c.nr_seq_movto_trans_fin nr_sequencia,
                CASE WHEN c.ie_acao='I' THEN  d.vl_recebido  ELSE d.vl_recebido * -1 END ,
                c.nr_seq_trans_fin,
                coalesce(c.dt_recebimento,clock_timestamp()) dt_transacao,
                'VL_RECEBIDO_TESOURARIA',
                c.nr_seq_conta_banco,
                b.cd_cgc,
                d.cd_conta_contabil cd_conta_contab_caixa,
                d.cd_centro_custo,
                '' nr_documento,
                'D' ie_caixa,
                null ie_saldo_caixa,
                'D' ie_debito_credito,
                CASE WHEN ie_agrupa_w='N' THEN  c.nr_seq_movto_trans_fin WHEN ie_agrupa_w='S' THEN  0  ELSE c.nr_seq_movto_trans_fin END ,
                '' ds_historico,
                b.cd_pessoa_fisica,
                obter_pessoa_titulo_receber(b.nr_titulo) ds_compl_pf_pj,
                0,
                (null)::numeric  cd_historico,
                '' nr_doc_movto,
                0 nr_adiant_movto,
                b.nr_interno_conta nr_interno_conta_movto,
                '' nr_cheque_movto,
                '' ds_hist_movto,
                '' ds_compl_pf_pj_movto,
                0 cd_hist_caixa_movto,
                0 nr_bordero,
                0 nr_seq_titulo_pagar,
                b.nr_titulo nr_seq_titulo_receber,
                0 nr_seq_nota_fiscal,
                0 nr_seq_conv_receb,
                0 nr_seq_deposito,
                0 nr_adiant_pago,
                0 nr_seq_cheque,
                d.cd_conta_contabil,
                obter_pessoa_titulo_receber(b.nr_titulo),
                (null)::numeric  nr_seq_caixa,
                coalesce(c.dt_recebimento,clock_timestamp()),
                somente_numero(obter_dados_titulo_receber(b.nr_titulo,'NFT')) nr_nota_fiscal,
                (null)::numeric  nr_seq_caixa_rec,
                null ds_bandeira,
                null ds_obs_cartao,
                d.nr_seq_produto,
                (null)::numeric  nr_seq_caixa_od,
                null cd_conta_deb_pls,
                null cd_conta_rec_pls,
                null cd_historico_pls,
                '' nr_autorizacao,
                null nr_seq_movto_cartao,
                (null)::numeric  vl_antecipacao_mens,
                to_char(null) ie_lote_antecip_pls,
                to_date(null) dt_referencia_pls_mens,
                (null)::numeric  nr_seq_baixa,
                b.cd_estabelecimento cd_estab_movto,
                null nr_seq_liq_cc,
                c.nr_documento nr_doc_tit_receb,
                null ie_lote_pro_rata,
                null nr_seq_cheque_cp,
                null nr_seq_movto_trans_fin,
                null nr_seq_caixa_receb,
                null cd_tipo_baixa,
                b.nr_seq_protocolo,
                c.cd_tipo_recebimento,
                'TITULO_REC_LIQ_CC',
                b.nr_titulo nr_seq_tab_orig,
                d.nr_sequencia nr_seq_tab_compl,
                14 nr_seq_info_ctb,
                null ds_observacao_movto,
                null nr_seq_movto_transf,
                c.nr_seq_liq_origem,
                b.nr_seq_proj_rec,
                c.cd_moeda
        from    titulo_rec_liq_cc d,
                titulo_receber_liq c,
                titulo_receber b
        where   c.nr_lote_contabil              = nr_lote_contabil_p
        and     c.nr_titulo                             = d.nr_titulo
        and     c.nr_sequencia                  = d.nr_seq_baixa
        and     c.nr_titulo                             = b.nr_titulo
        and     c.vl_recebido                   <> 0
        and     (c.nr_seq_trans_fin IS NOT NULL AND c.nr_seq_trans_fin::text <> '')
        and     ((ie_permite_estab_dif_w <> 'N') or (b.cd_estabelecimento       = cd_estabelecimento_w))
        and     coalesce(ie_lib_caixa, 'S')          = 'S'
        and     ie_contab_rec_classif_w = 'S'
        
union all

        select  21 ie_union,
                c.nr_seq_movto_trans_fin nr_sequencia,
                d.vl_amaior,
                c.nr_seq_trans_fin,
                coalesce(c.dt_recebimento,clock_timestamp()) dt_transacao,
                'VL_FATURAMENTO_OPS',
                c.nr_seq_conta_banco,
                b.cd_cgc,
                '' cd_conta_contab_caixa,
                d.cd_centro_custo,
                '' nr_documento,
                'D' ie_caixa,
                null ie_saldo_caixa,
                'C' ie_debito_credito,
                CASE WHEN ie_agrupa_w='N' THEN  c.nr_seq_movto_trans_fin WHEN ie_agrupa_w='S' THEN  0  ELSE c.nr_seq_movto_trans_fin END ,
                '' ds_historico,
                b.cd_pessoa_fisica,
                obter_pessoa_titulo_receber(b.nr_titulo) ds_compl_pf_pj,
                0,
                (null)::numeric  cd_historico,
                '' nr_doc_movto,
                0 nr_adiant_movto,
                b.nr_interno_conta nr_interno_conta_movto,
                '' nr_cheque_movto,
                '' ds_hist_movto,
                '' ds_compl_pf_pj_movto,
                0 cd_hist_caixa_movto,
                0 nr_bordero,
                0 nr_seq_titulo_pagar,
                b.nr_titulo nr_seq_titulo_receber,
                0 nr_seq_nota_fiscal,
                0 nr_seq_conv_receb,
                0 nr_seq_deposito,
                0 nr_adiant_pago,
                0 nr_seq_cheque,
                '' cd_conta_contabil,
                obter_pessoa_titulo_receber(b.nr_titulo),
                (null)::numeric  nr_seq_caixa,
                coalesce(c.dt_recebimento,clock_timestamp()),
                somente_numero(obter_dados_titulo_receber(b.nr_titulo,'NFT')) nr_nota_fiscal,
                (null)::numeric  nr_seq_caixa_rec,
                null ds_bandeira,
                null ds_obs_cartao,
                d.nr_seq_produto,
                (null)::numeric  nr_seq_caixa_od,
                null cd_conta_deb_pls,
                null cd_conta_rec_pls,
                null cd_historico_pls,
                '' nr_autorizacao,
                null nr_seq_movto_cartao,
                (null)::numeric  vl_antecipacao_mens,
                to_char(null) ie_lote_antecip_pls,
                to_date(null) dt_referencia_pls_mens,
                (null)::numeric  nr_seq_baixa,
                b.cd_estabelecimento cd_estab_movto,
                null nr_seq_liq_cc,
                c.nr_documento nr_doc_tit_receb,
                null ie_lote_pro_rata,
                null nr_seq_cheque_cp,
                null nr_seq_movto_trans_fin,
                null nr_seq_caixa_receb,
                null cd_tipo_baixa,
                b.nr_seq_protocolo,
                c.cd_tipo_recebimento,
                'TITULO_RECEBER_LIQ_CC',
                b.nr_titulo nr_seq_tab_orig,
                d.nr_sequencia nr_seq_tab_compl,
                14 nr_seq_info_ctb,
                null ds_observacao_movto,
                null nr_seq_movto_transf,
                c.nr_seq_liq_origem,
                b.nr_seq_proj_rec,
                c.cd_moeda
        from    titulo_rec_liq_cc d,
                titulo_receber_liq c,
                titulo_receber b
        where   c.nr_lote_contabil      = nr_lote_contabil_p
        and     (c.nr_seq_trans_fin IS NOT NULL AND c.nr_seq_trans_fin::text <> '')
        and     ie_contab_cr_w          = 'S'
        and     ie_cc_glosa_w   <> 'N'
        and     ((ie_origem_classif = 'FO') or (b.ie_origem_titulo = 13 and (not exists (select 1 from pls_fatura w where (w.nr_titulo = b.nr_titulo or w.nr_titulo_ndc = b.nr_titulo)
        ))))
        and     c.nr_titulo             = b.nr_titulo
        and     d.nr_titulo             = c.nr_titulo
        and     d.nr_seq_baixa          = c.nr_sequencia
        and     ((c.nr_seq_caixa_rec IS NOT NULL AND c.nr_seq_caixa_rec::text <> '') or
                 exists (select 1
                        from    movto_trans_financ x
                        where   x.nr_sequencia          = c.nr_seq_movto_trans_fin
                        and     (x.nr_seq_saldo_caixa IS NOT NULL AND x.nr_seq_saldo_caixa::text <> '')) or (nr_seq_trans_caixa IS NOT NULL AND nr_seq_trans_caixa::text <> ''))
        
union all

        select  22 ie_union,
                a.nr_seq_movto_trans_fin nr_sequencia,
                x.vl_movimento,
                a.nr_seq_trans_fin,
                coalesce(a.dt_baixa,clock_timestamp()) dt_transacao,
                CASE WHEN x.ie_origem='E' THEN  'VL_EVENTO_OPS' WHEN x.ie_origem='P' THEN  'VL_PAGAMENTO_OPS' WHEN x.ie_origem='I' THEN  'VL_INTERCAMBIO' WHEN x.ie_origem='R' THEN  'VL_REEMBOLSO' WHEN x.ie_origem='C' THEN  'VL_COPARTICIPACAO' END  nm_atributo,
                a.nr_seq_conta_banco,
                b.cd_cgc,
                x.cd_conta_contabil cd_conta_contab_caixa,
                CASE WHEN ie_centro_custo_tit_pagar_w='N' THEN 0  ELSE CASE WHEN coalesce(t.ie_acao,0)=0 THEN 0 WHEN coalesce(t.ie_acao,0)=2 THEN coalesce(a.cd_centro_custo,0)  ELSE 0 END  END  cd_centro_custo,
                '' nr_documento,
                'D' ie_caixa,
                null ie_saldo_caixa,
                x.ie_debito_credito,
                CASE WHEN ie_agrupa_w='N' THEN  b.nr_titulo WHEN ie_agrupa_w='S' THEN  0  ELSE b.nr_titulo END ,
                '' ds_historico,
                b.cd_pessoa_fisica,
                obter_pessoa_titulo_pagar(b.nr_titulo) ds_compl_pf_pj,
                0,
                (null)::numeric  cd_historico,
                coalesce(to_char(b.nr_documento),'0') nr_doc_movto,
                0 nr_adiant_movto,
                0 nr_interno_conta_movto,
                '' nr_cheque_movto,
                '' ds_hist_movto,
                '' ds_compl_pf_pj_movto,
                0 cd_hist_caixa_movto,
                a.nr_bordero,
                b.nr_titulo nr_seq_titulo_pagar,
                0 nr_seq_titulo_receber,
                0 nr_seq_nota_fiscal,
                0 nr_seq_conv_receb,
                0 nr_seq_deposito,
                0 nr_adiant_pago,
                0 nr_seq_cheque,
                CASE WHEN ie_conta_contab_tit_pagar_w='N' THEN ''  ELSE CASE WHEN coalesce(t.ie_acao,0)=0 THEN '' WHEN coalesce(t.ie_acao,0)=2 THEN coalesce(x.cd_conta_contabil,'')  ELSE '' END  END  cd_conta_contabil,
                obter_pessoa_titulo_pagar(b.nr_titulo),
                (null)::numeric  nr_seq_caixa,
                coalesce(a.dt_baixa,clock_timestamp()),
                somente_numero(obter_dados_tit_pagar(b.nr_titulo,'NF')) nr_nota_fiscal,
                (null)::numeric  nr_seq_caixa_rec,
                null ds_bandeira,
                null ds_obs_cartao,
                (null)::numeric  nr_seq_produto,
                (null)::numeric  nr_seq_caixa_od,
                null cd_conta_deb_pls,
                null cd_conta_rec_pls,
                null cd_historico_pls,
                '' nr_autorizacao,
                null nr_seq_movto_cartao,
                (null)::numeric  vl_antecipacao_mens,
                to_char(null) ie_lote_antecip_pls,
                to_date(null) dt_referencia_pls_mens,
                (null)::numeric  nr_seq_baixa,
                b.cd_estabelecimento cd_estab_movto,
                null nr_seq_liq_cc,
                null nr_doc_tit_receb,
                null ie_lote_pro_rata,
                null nr_seq_cheque_cp,
                null nr_seq_movto_trans_fin,
                null nr_seq_caixa_receb,
                a.cd_tipo_baixa,
                null nr_seq_protocolo,
                null cd_tipo_recebimento,
                'TITULO_PAGAR_BAIXA_OPS',
                x.nr_sequencia nr_seq_tab_orig,
                a.nr_sequencia nr_seq_tab_compl,
                13 nr_seq_info_ctb,
                null ds_observacao_movto,
                null nr_seq_movto_transf,
                null nr_seq_liq_origem,
                b.nr_seq_proj_rec,
                null cd_moeda
        FROM titulo_pagar_baixa_ops x, titulo_pagar b, titulo_pagar_baixa a
LEFT OUTER JOIN transacao_financeira t ON (a.nr_seq_trans_fin = t.nr_sequencia)
WHERE x.nr_lote_contabil      = nr_lote_contabil_p and (a.nr_seq_trans_fin IS NOT NULL AND a.nr_seq_trans_fin::text <> '') and ie_contab_cp_w          = 'S' and a.nr_titulo             = b.nr_titulo and b.nr_titulo             = x.nr_titulo and a.nr_sequencia          = x.nr_seq_baixa  and exists (select 1
                        from    movto_trans_financ x
                        where   x.nr_sequencia          = a.nr_seq_movto_trans_fin
                        and     (x.nr_seq_saldo_caixa IS NOT NULL AND x.nr_seq_saldo_caixa::text <> ''))
         
union all

        select  23 ie_union,
                a.nr_seq_movto,
                coalesce(a.vl_liquido,0) vl_transacao,
                b.nr_seq_trans_caixa,
                b.dt_transacao,
                'VL_LIQUIDO_CARTAO',
                null nr_seq_banco_od,
                null cd_cgc,
                '' cd_conta_contabil,
                null cd_centro_custo,
                null nr_documento,
                'D' ie_caixa,
                null ie_saldo_caixa,
                'D' ie_debito_credito,
                0,
                null ds_historico,
                null cd_pessoa_fisica,
                substr(obter_pf_pj_caixa(b.nr_seq_caixa_rec),1,255) ds_compl_pf_pj,
                null,
                null cd_historico,
                null nr_doc_movto,
                null nr_adiant_movto,
                null nr_interno_conta_movto,
                null nr_cheque_movto,
                null ds_hist_movto,
                substr(obter_pf_pj_caixa(b.nr_seq_caixa_rec),1,255) ds_compl_pf_pj_movto,
                null cd_hist_caixa_movto,
                null nr_bordero,
                null nr_seq_titulo_pagar,
                null nr_seq_titulo_receber,
                null nr_seq_nota_fiscal,
                null nr_seq_conv_receb,
                null nr_seq_deposito,
                null nr_adiant_pago,
                null nr_seq_cheque,
                null ,
                null,
                null  nr_seq_caixa,
                a.dt_parcela,
                null nr_nota_fiscal,
                b.nr_seq_caixa_rec,
                substr(obter_desc_bandeira_cartao(b.nr_seq_bandeira),1,255) ds_bandeira,
                substr(b.ds_observacao,1,255) ds_obs_cartao,
                (null)::numeric  nr_seq_produto,
                null nr_seq_caixa_od,
                null cd_conta_deb_pls,
                null cd_conta_rec_pls,
                null cd_historico_pls,
                b.nr_autorizacao,
                b.nr_sequencia nr_seq_movto_cartao,
                (null)::numeric  vl_antecipacao_mens,
                to_char(null) ie_lote_antecip_pls,
                to_date(null) dt_referencia_pls_mens,
                (null)::numeric  nr_seq_baixa,
                0 cd_estab_movto,
                null nr_seq_liq_cc,
                null nr_doc_tit_receb,
                null ie_lote_pro_rata,
                null nr_seq_cheque_cp,
                null nr_seq_movto_trans_fin,
                null nr_seq_caixa_receb,
                null cd_tipo_baixa,
                null nr_seq_protocolo,
                null cd_tipo_recebimento,
                'MOVTO_CARTAO_CR_PARCELA',
                a.nr_sequencia nr_seq_tab_orig,
                b.nr_sequencia nr_seq_tab_compl,
                64 nr_seq_info_ctb,
                null ds_observacao_movto,
                null nr_seq_movto_transf,
                null nr_seq_liq_origem,
                null nr_seq_proj_rec,
                null cd_moeda
        from    movto_cartao_cr_parcela a,
                movto_cartao_cr b
        where   a.nr_seq_movto = b.nr_sequencia
        and     (nr_seq_caixa_rec IS NOT NULL AND nr_seq_caixa_rec::text <> '')
        and     coalesce(b.dt_cancelamento::text, '') = ''
        and     ie_contab_desp_cartao_w = 'S'
        and     a.nr_lote_contabil      = nr_lote_contabil_p
        
union all

        select  24 ie_union,
                a.nr_seq_movto,
                coalesce((a.vl_parcela * -1),0) vl_transacao,
                b.nr_seq_trans_caixa,
                b.dt_transacao,
                'VL_PARCELA_CARTAO',
                null nr_seq_banco_od,
                null cd_cgc,
                '' cd_conta_contabil,
                null cd_centro_custo,
                null nr_documento,
                'D' ie_caixa,
                null ie_saldo_caixa,
                'D' ie_debito_credito,
                0,
                null ds_historico,
                null cd_pessoa_fisica,
                null ds_compl_pf_pj,
                null,
                null cd_historico,
                null nr_doc_movto,
                null nr_adiant_movto,
                null nr_interno_conta_movto,
                null nr_cheque_movto,
                null ds_hist_movto,
                null ds_compl_pf_pj_movto,
                null cd_hist_caixa_movto,
                null nr_bordero,
                null nr_seq_titulo_pagar,
                null nr_seq_titulo_receber,
                null nr_seq_nota_fiscal,
                null nr_seq_conv_receb,
                null nr_seq_deposito,
                null nr_adiant_pago,
                null nr_seq_cheque,
                null ,
                null,
                null  nr_seq_caixa,
                a.dt_parcela,
                null nr_nota_fiscal,
                b.nr_seq_caixa_rec,
                '' ds_bandeira,
                '' ds_obs_cartao,
                (null)::numeric  nr_seq_produto,
                null nr_seq_caixa_od,
                null cd_conta_deb_pls,
                null cd_conta_rec_pls,
                null cd_historico_pls,
                null nr_autorizacao,
                b.nr_sequencia nr_seq_movto_cartao,
                (null)::numeric  vl_antecipacao_mens,
                to_char(null) ie_lote_antecip_pls,
                to_date(null) dt_referencia_pls_mens,
                (null)::numeric  nr_seq_baixa,
                0 cd_estab_movto,
                null nr_seq_liq_cc,
                null nr_doc_tit_receb,
                null ie_lote_pro_rata,
                null nr_seq_cheque_cp,
                null nr_seq_movto_trans_fin,
                null nr_seq_caixa_receb,
                null cd_tipo_baixa,
                null nr_seq_protocolo,
                null cd_tipo_recebimento,
                'MOVTO_CARTAO_CR_PARCELA',
                a.nr_sequencia nr_seq_tab_orig,
                b.nr_sequencia nr_seq_tab_compl,
                64 nr_seq_info_ctb,
                null ds_observacao_movto,
                null nr_seq_movto_transf,
                null nr_seq_liq_origem,
                null nr_seq_proj_rec,
                null cd_moeda
        from    movto_cartao_cr_parcela a,
                movto_cartao_cr b
        where   a.nr_seq_movto = b.nr_sequencia
        and     (nr_seq_caixa_rec IS NOT NULL AND nr_seq_caixa_rec::text <> '')
        and     ie_contab_desp_cartao_w = 'S'
        and     (a.nr_lote_contabil IS NOT NULL AND a.nr_lote_contabil::text <> '')
        and     (b.dt_cancelamento IS NOT NULL AND b.dt_cancelamento::text <> '')
        and     a.nr_lote_contabil_cancel = nr_lote_contabil_p
        and ie_contab_cartao_cancel_w = 'S'
        
union all

        select  25 ie_union,
                a.nr_seq_movto,
                coalesce((a.vl_despesa * -1),0) vl_transacao,
                b.nr_seq_trans_caixa,
                b.dt_transacao,
                'VL_DESPESA_CARTAO',
                null nr_seq_banco_od,
                null cd_cgc,
                '' cd_conta_contabil,
                null cd_centro_custo,
                null nr_documento,
                'D' ie_caixa,
                null ie_saldo_caixa,
                'D' ie_debito_credito,
                0,
                null ds_historico,
                null cd_pessoa_fisica,
                substr(obter_pf_pj_caixa(b.nr_seq_caixa_rec),1,255) ds_compl_pf_pj,
                null,
                null cd_historico,
                null nr_doc_movto,
                null nr_adiant_movto,
                null nr_interno_conta_movto,
                null nr_cheque_movto,
                null ds_hist_movto,
                substr(obter_pf_pj_caixa(b.nr_seq_caixa_rec),1,255) ds_compl_pf_pj_movto,
                null cd_hist_caixa_movto,
                null nr_bordero,
                null nr_seq_titulo_pagar,
                null nr_seq_titulo_receber,
                null nr_seq_nota_fiscal,
                null nr_seq_conv_receb,
                null nr_seq_deposito,
                null nr_adiant_pago,
                null nr_seq_cheque,
                null ,
                null,
                null  nr_seq_caixa,
                a.dt_parcela,
                null nr_nota_fiscal,
                b.nr_seq_caixa_rec,
                '' ds_bandeira,
                '' ds_obs_cartao,
                (null)::numeric  nr_seq_produto,
                null nr_seq_caixa_od,
                null cd_conta_deb_pls,
                null cd_conta_rec_pls,
                null cd_historico_pls,
                b.nr_autorizacao nr_autorizacao,
                b.nr_sequencia nr_seq_movto_cartao,
                (null)::numeric  vl_antecipacao_mens,
                to_char(null) ie_lote_antecip_pls,
                to_date(null) dt_referencia_pls_mens,
                (null)::numeric  nr_seq_baixa,
                0 cd_estab_movto,
                null nr_seq_liq_cc,
                null nr_doc_tit_receb,
                null ie_lote_pro_rata,
                null nr_seq_cheque_cp,
                null nr_seq_movto_trans_fin,
                null nr_seq_caixa_receb,
                null cd_tipo_baixa,
                null nr_seq_protocolo,
                null cd_tipo_recebimento,
                'MOVTO_CARTAO_CR_PARCELA',
                a.nr_sequencia nr_seq_tab_orig,
                b.nr_sequencia nr_seq_tab_compl,
                64 nr_seq_info_ctb,
                null ds_observacao_movto,
                null nr_seq_movto_transf,
                null nr_seq_liq_origem,
                null nr_seq_proj_rec,
                null cd_moeda
        from    movto_cartao_cr_parcela a,
                movto_cartao_cr b
        where   a.nr_seq_movto          = b.nr_sequencia
        and     (nr_seq_caixa_rec IS NOT NULL AND nr_seq_caixa_rec::text <> '')
        and     ie_contab_desp_cartao_w = 'S'
        and     (a.nr_lote_contabil IS NOT NULL AND a.nr_lote_contabil::text <> '')
        and     (b.dt_cancelamento IS NOT NULL AND b.dt_cancelamento::text <> '')
        and     a.nr_lote_contabil_cancel = nr_lote_contabil_p
        and ie_contab_cartao_cancel_w = 'S'
        
union all

        select  26 ie_union,
                a.nr_seq_movto,
                coalesce((a.vl_liquido * -1),0) vl_transacao,
                b.nr_seq_trans_caixa,
                b.dt_transacao,
                'VL_LIQUIDO_CARTAO',
                null nr_seq_banco_od,
                null cd_cgc,
                '' cd_conta_contabil,
                null cd_centro_custo,
                null nr_documento,
                'D' ie_caixa,
                null ie_saldo_caixa,
                'D' ie_debito_credito,
                0,
                null ds_historico,
                null cd_pessoa_fisica,
                substr(obter_pf_pj_caixa(b.nr_seq_caixa_rec),1,255) ds_compl_pf_pj,
                null,
                null cd_historico,
                null nr_doc_movto,
                null nr_adiant_movto,
                null nr_interno_conta_movto,
                null nr_cheque_movto,
                null ds_hist_movto,
                substr(obter_pf_pj_caixa(b.nr_seq_caixa_rec),1,255) ds_compl_pf_pj_movto,
                null cd_hist_caixa_movto,
                null nr_bordero,
                null nr_seq_titulo_pagar,
                null nr_seq_titulo_receber,
                null nr_seq_nota_fiscal,
                null nr_seq_conv_receb,
                null nr_seq_deposito,
                null nr_adiant_pago,
                null nr_seq_cheque,
                null ,
                null,
                null  nr_seq_caixa,
                a.dt_parcela,
                null nr_nota_fiscal,
                b.nr_seq_caixa_rec,
                substr(obter_desc_bandeira_cartao(b.nr_seq_bandeira),1,255) ds_bandeira,
                substr(b.ds_observacao,1,255) ds_obs_cartao,
                (null)::numeric  nr_seq_produto,
                null nr_seq_caixa_od,
                null cd_conta_deb_pls,
                null cd_conta_rec_pls,
                null cd_historico_pls,
                b.nr_autorizacao,
                b.nr_sequencia nr_seq_movto_cartao,
                (null)::numeric  vl_antecipacao_mens,
                to_char(null) ie_lote_antecip_pls,
                to_date(null) dt_referencia_pls_mens,
                (null)::numeric  nr_seq_baixa,
                0 cd_estab_movto,
                null nr_seq_liq_cc,
                null nr_doc_tit_receb,
                null ie_lote_pro_rata,
                null nr_seq_cheque_cp,
                null nr_seq_movto_trans_fin,
                null nr_seq_caixa_receb,
                null cd_tipo_baixa,
                null nr_seq_protocolo,
                null cd_tipo_recebimento,
                'MOVTO_CARTAO_CR_PARCELA',
                a.nr_sequencia nr_seq_tab_orig,
                b.nr_sequencia nr_seq_tab_compl,
                64 nr_seq_info_ctb,
                null ds_observacao_movto,
                null nr_seq_movto_transf,
                null nr_seq_liq_origem,
                null nr_seq_proj_rec,
                null cd_moeda
        from    movto_cartao_cr_parcela a,
                movto_cartao_cr b
        where   a.nr_seq_movto = b.nr_sequencia
        and     (nr_seq_caixa_rec IS NOT NULL AND nr_seq_caixa_rec::text <> '')
        and     ie_contab_desp_cartao_w = 'S'
        and     (a.nr_lote_contabil IS NOT NULL AND a.nr_lote_contabil::text <> '')
        and     (b.dt_cancelamento IS NOT NULL AND b.dt_cancelamento::text <> '')
        and     a.nr_lote_contabil_cancel = nr_lote_contabil_p
        and ie_contab_cartao_cancel_w = 'S'
        
union all

        select  27 ie_union,
                0 nr_seq_movto,
                coalesce(b.vl_desconto,0) vl_transacao,
                b.nr_seq_trans_financ,
                b.dt_negociacao,
                'VL_DESC_NEG_CHEQUE',
                null nr_seq_banco_od,
                null cd_cgc,
                CASE WHEN d.ie_caixa='M' THEN  obter_conta_caixa(c.nr_sequencia, dt_contabil_w)  ELSE '' END  cd_conta_contabil,
                null cd_centro_custo,
                to_char(b.nr_seq_cheque) nr_documento,
                d.ie_caixa,
                d.ie_saldo_caixa,
                CASE WHEN d.ie_saldo_caixa='E' THEN 'D'  ELSE 'C' END  ie_debito_credito,
                0,
                null ds_historico,
                null cd_pessoa_fisica,
                null ds_compl_pf_pj,
                coalesce(d.cd_historico_caixa, CASE WHEN ie_saldo_caixa='E' THEN  cd_hist_parametro_w  ELSE coalesce(cd_historico_cred_w,cd_hist_parametro_w) END ),
                null cd_historico,
                null nr_doc_movto,
                null nr_adiant_movto,
                null nr_interno_conta_movto,
                substr(obter_dados_cheque_cr(b.nr_seq_cheque, 'N'),1,255) nr_cheque_movto,
                null ds_hist_movto,
                null ds_compl_pf_pj_movto,
                d.cd_historico_caixa cd_hist_caixa_movto,
                null nr_bordero,
                null nr_seq_titulo_pagar,
                null nr_seq_titulo_receber,
                null nr_seq_nota_fiscal,
                null nr_seq_conv_receb,
                null nr_seq_deposito,
                null nr_adiant_pago,
                b.nr_seq_cheque,
                obter_conta_caixa(c.nr_sequencia, dt_contabil_w),
                null,
                c.nr_sequencia nr_seq_caixa,
                b.dt_negociacao,
                null nr_nota_fiscal,
                b.nr_seq_caixa_rec,
                '' ds_bandeira,
                '' ds_obs_cartao,
                (null)::numeric  nr_seq_produto,
                null nr_seq_caixa_od,
                null cd_conta_deb_pls,
                null cd_conta_rec_pls,
                null cd_historico_pls,
                null nr_autorizacao,
                null nr_seq_movto_cartao,
                (null)::numeric  vl_antecipacao_mens,
                to_char(null) ie_lote_antecip_pls,
                to_date(null) dt_referencia_pls_mens,
                (null)::numeric  nr_seq_baixa,
                0 cd_estab_movto,
                null nr_seq_liq_cc,
                null nr_doc_tit_receb,
                null ie_lote_pro_rata,
                null nr_seq_cheque_cp,
                null nr_seq_movto_trans_fin,
                e.nr_sequencia nr_seq_caixa_receb,
                null cd_tipo_baixa,
                null nr_seq_protocolo,
                e.cd_tipo_receb_caixa cd_tipo_recebimento,
                'CHEQUE_CR_NEGOCIADO',
                b.nr_sequencia nr_seq_tab_orig,
                e.nr_sequencia nr_seq_tab_compl,
                63 nr_seq_info_ctb,
                null ds_observacao_movto,
                null nr_seq_movto_transf,
                null nr_seq_liq_origem,
                null nr_seq_proj_rec,
                null cd_moeda
        from    transacao_financeira d,
                caixa c,
                caixa_receb e,
                cheque_cr_negociado b,
                caixa_saldo_diario a
        where   a.nr_seq_caixa          = c.nr_sequencia
        and     e.nr_seq_saldo_caixa    = a.nr_sequencia
        and     b.nr_seq_caixa_rec      = e.nr_sequencia
        and     a.nr_lote_contabil      = nr_lote_contabil_p
        and     (b.nr_seq_trans_financ IS NOT NULL AND b.nr_seq_trans_financ::text <> '')
        and     b.nr_seq_trans_financ   = d.nr_sequencia
        and     ie_contab_neg_cheque_w  = 'S'
        and     coalesce(b.vl_desconto,0)    != 0;


c02 CURSOR FOR
        SELECT  b.nr_cheque
        from    cheque_cr b,
                deposito_cheque a
        where   a.nr_seq_cheque         = b.nr_seq_cheque
        and     a.nr_seq_deposito       = nr_seq_deposito_w;

c03 CURSOR FOR
        SELECT  a.nr_cheque
        from    cheque_cr a
        where   a.nr_seq_caixa_rec      = nr_seq_caixa_rec_w;
c04 CURSOR FOR
        SELECT  ie_estorno,
                        coalesce(nr_seq_lote, 0),
                        substr(obter_nome_pf_pj(cd_pessoa_fisica, cd_cgc), 1, 255),
                        coalesce(nr_seq_movto_orig, 0)
        from    movto_trans_financ
        where   nr_seq_caixa_rec        = nr_seq_caixa_rec_w
        order by coalesce(nr_seq_lote, 0),
                        coalesce(nr_seq_movto_orig, 0);

BEGIN
/*Validacao para impedir a geracao em lotes incorretos */

if (ie_exclusao_p <> 'S') then
        select b.cd_tipo_lote_contabil
        into STRICT cd_tipo_lote_contabil_w
        from lote_contabil b
        where b.nr_lote_contabil = nr_lote_contabil_p;
        if (cd_tipo_lote_contabil_w <> 10) then
                CALL wheb_mensagem_pck.exibir_mensagem_abort(261346);
        end if;
end if;
nr_seq_agrup_titulo_w   := 0;

delete  from lote_contabil_log
where   nr_lote_contabil = nr_lote_contabil_p
and     cd_log_lote in (9,10);

commit;

select  dt_referencia,
        cd_estabelecimento,
        cd_tipo_lote_contabil
into STRICT    dt_contabil_w,
        cd_estabelecimento_w,
        cd_tipo_lote_contabil_w
from    lote_contabil
where   nr_lote_contabil                = nr_lote_contabil_p;

cd_empresa_w            := obter_empresa_estab(cd_estabelecimento_w);

select  max(nm_fantasia_estab)
into STRICT    nm_estabelecimento_w
from    estabelecimento
where   cd_estabelecimento      = cd_estabelecimento_w;

dt_contab_lote_w        := dt_contabil_w;

select  cd_historico,
        ie_agrupa_trans_contab,
        ie_agrupa_lanc_caixa_dia,
        cd_historico_cred,
        ie_contab_monet_docto,
        ie_contab_transf_caixa,
        ie_contab_cr,
        ie_contab_cp,
        coalesce(ie_contab_cartao_cancel, 'N'),
        coalesce(ie_contab_monet_regra,'N'),
        coalesce(ie_compl_historico, 'N'),
        coalesce(ie_dt_contab_tesouraria,'L'),
        coalesce(ie_contab_neg_cheque,'N'),
        coalesce(ie_centro_custo_tit_pagar,'N'),
        coalesce(ie_conta_contab_tit_pagar,'N'),
        coalesce(ie_contab_vl_titulo_rec,'N'),
        coalesce(ie_contab_trans_fin_baixa,'N')
into STRICT    cd_hist_parametro_w,
        ie_agrupa_w,
        ie_agrupa_lanc_caixa_dia_w,
        cd_historico_cred_w,
        ie_contab_monet_docto_w,
        ie_contab_transf_caixa_w,
        ie_contab_cr_w,
        ie_contab_cp_w,
        ie_contab_cartao_cancel_w,
        ie_contab_monet_regra_w,
        ie_compl_historico_w,
        ie_dt_contab_tesouraria_w,
        ie_contab_neg_cheque_w,
        ie_centro_custo_tit_pagar_w,
        ie_conta_contab_tit_pagar_w,
        ie_contab_vl_titulo_rec_w,
        ie_contab_trans_fin_baixa_w
from    parametro_tesouraria
where   cd_estabelecimento      = cd_estabelecimento_w;

select  count(1)
into STRICT    qt_seq_classif_w
from    lote_contabil_param_item
where   nr_lote_contabil        = nr_lote_contabil_p
and     nr_seq_parametro        = 1;

select  coalesce(ie_cc_glosa,'N'),
        coalesce(ie_contab_desp_cartao,'N'),
        coalesce(ie_contab_rec_classif,'N')
into STRICT    ie_cc_glosa_w,
        ie_contab_desp_cartao_w,
        ie_contab_rec_classif_w
from    parametro_contas_receber
where   cd_estabelecimento      = cd_estabelecimento_w;

select  coalesce(max(ie_contab_classif_mens),'N'),
        coalesce(max(ie_contab_mens_tesouraria),'N')
into STRICT    ie_contab_classif_mens_w,
        ie_contab_mens_tesouraria_w
from    pls_parametro_contabil
where   cd_estabelecimento      = cd_estabelecimento_w;

/* Francisco - 28/05/2010 - OS  220155 */

select  coalesce(max(a.ie_contab_baixas_pro_rata),'N')
into STRICT    ie_contab_baixas_pro_rata_w
from    pls_parametros_cr a
where   a.cd_estabelecimento    = cd_estabelecimento_w;

SELECT * FROM ctb_obter_regra_estab_dif(cd_estabelecimento_w, cd_tipo_lote_contabil_w, null, ie_permite_estab_dif_w, cd_conta_transitoria_w, cd_historico_ct_w) INTO STRICT ie_permite_estab_dif_w, cd_conta_transitoria_w, cd_historico_ct_w;

if (ie_exclusao_p = 'S') then
        CALL wheb_usuario_pck.set_ie_lote_contabil('S');

        CALL ctb_regras_contabil.comprovante_cache_storage(nr_lote_contabil_p, nm_usuario_p);
        delete  from movimento_contabil
        where   nr_lote_contabil        = nr_lote_contabil_p;
        commit;

        update  lote_contabil
        set     vl_credito              = 0,
                vl_debito               = 0
        where   nr_lote_contabil        = nr_lote_contabil_p;

        update  caixa_saldo_diario
        set     nr_lote_contabil        = 0
        where   nr_lote_contabil        = nr_lote_contabil_p;

        update  titulo_receber_liq
        set     nr_lote_contabil        = 0
        where   nr_lote_contabil        = nr_lote_contabil_p;

        update  titulo_pagar_baixa
        set     nr_lote_contabil        = 0
        where   nr_lote_contabil        = nr_lote_contabil_p;

        /* Francisco - 03/05/2010 - OS 203923 */

        update  titulo_receber_liq
        set     nr_lote_contab_antecip  = 0
        where   nr_lote_contab_antecip  = nr_lote_contabil_p;

        /* Francisco - 26/05/2010 -  220155 */

        update  titulo_receber_liq a
        set     nr_lote_contab_pro_rata = 0
        where   nr_lote_contab_pro_rata = nr_lote_contabil_p;

        update  pls_titulo_rec_liq_mens
        set     nr_lote_contabil        = 0
        where   nr_lote_contabil        = nr_lote_contabil_p;

        update  movto_cartao_cr_parcela
        set     nr_lote_contabil        = 0
        where   nr_lote_contabil        = nr_lote_contabil_p;

        update  movto_cartao_cr_parcela
        set     nr_lote_contabil_cancel         = 0
        where   nr_lote_contabil_cancel         = nr_lote_contabil_p;

        update  titulo_pagar_baixa_ops
        set     nr_lote_contabil        = 0
        where   nr_lote_contabil        = nr_lote_contabil_p;

        CALL wheb_usuario_pck.set_ie_lote_contabil('N');
else
        CALL wheb_usuario_pck.set_ie_lote_contabil('S');

        --Obter_Valor_Dinamico('Truncate Table W_Movimento_Contabil', vl_retorno_w);
        delete  FROM w_movimento_contabil
        where   nr_lote_contabil = nr_lote_contabil_p;
        commit;

        select  count(*)
        into STRICT    qt_reg_w
        from    caixa_saldo_diario b,
                caixa a
        where   a.nr_sequencia = b.nr_seq_caixa
        and     coalesce(b.nr_lote_contabil,0) = 0
        and     trunc(b.dt_saldo,'month') = trunc(dt_contabil_w,'month')
        and     trunc(b.dt_saldo,'dd') <= trunc(dt_contabil_w,'dd')
        and     coalesce(b.dt_fechamento::text, '') = ''
        and     a.cd_estabelecimento = cd_estabelecimento_w
        and (exists (SELECT     1
                                from    lote_contabil_param_item c
                                where   c.nr_lote_contabil      = nr_lote_contabil_p
                                and     c.nr_documento  = a.nr_seq_classif
                                and             c.nr_seq_parametro      = 1)
                or qt_seq_classif_w = 0);

        if (qt_reg_w > 0) then
                CALL wheb_mensagem_pck.exibir_mensagem_abort(258407);
        end if;

        update  caixa_saldo_diario a
        set     nr_lote_contabil                = nr_lote_contabil_p
        where   coalesce(nr_lote_contabil,0)         = 0
        and     (dt_fechamento IS NOT NULL AND dt_fechamento::text <> '')
        and     trunc(dt_saldo,'month')         = trunc(dt_contabil_w, 'month')
        and     trunc(dt_saldo,'dd')            <= trunc(dt_contabil_w, 'dd')

        and     exists (SELECT  1
                        from    estabelecimento e,
                                caixa b
                        where   a.nr_seq_caixa          = b.nr_sequencia
                        and     e.cd_estabelecimento    = b.cd_estabelecimento
                        and     b.cd_estabelecimento    = cd_estabelecimento_w
                        and     e.cd_empresa            = cd_empresa_w
                        and (exists (select     1
                                from    lote_contabil_param_item c
                                where   c.nr_lote_contabil      = nr_lote_contabil_p
                                and     c.nr_documento  = b.nr_seq_classif
                                and             c.nr_seq_parametro      = 1)
                        or qt_seq_classif_w = 0));
        commit;

        if (ie_contab_cr_w = 'S') then
                update  titulo_receber_liq a
                set     nr_lote_contabil                = nr_lote_contabil_p
                where   coalesce(nr_lote_contabil,0)         = 0
                and     trunc(dt_recebimento,'month')   = trunc(dt_contabil_w, 'month')
                and     trunc(dt_recebimento,'dd')      <= trunc(dt_contabil_w, 'dd')

                and     exists
                        (SELECT 1
                        from    titulo_receber t,
                                estabelecimento e
                        where   a.nr_titulo     = t.nr_titulo
                        and     t.cd_estabelecimento = e.cd_estabelecimento
                        and     e.cd_empresa = cd_empresa_w
                        and     ((ie_contab_mens_tesouraria_w = 'S') or (t.ie_origem_titulo != '3'))
                        and     ((ie_permite_estab_dif_w <> 'N') or (t.cd_estabelecimento       = cd_estabelecimento_w)))
                and     exists ( select  1
                                from    caixa c,
                                        caixa_saldo_diario y,
                                        movto_trans_financ x
                                where   x.nr_sequencia          = a.nr_seq_movto_trans_fin
                                and     x.nr_seq_caixa          = y.nr_seq_caixa
                                and     x.nr_seq_saldo_caixa    = y.nr_sequencia
                                and     y.nr_seq_caixa          = c.nr_sequencia
                                and (exists (select     1
                                        from    lote_contabil_param_item d
                                        where   d.nr_lote_contabil      = nr_lote_contabil_p
                                        and     d.nr_documento  = c.nr_seq_classif
                                        and             d.nr_seq_parametro      = 1)
                                or qt_seq_classif_w = 0))
                and     nr_titulo in (select x.nr_seq_titulo_receber
                        from    movto_trans_financ x,
                                caixa_saldo_diario y
                        where   y.nr_lote_contabil      = nr_lote_contabil_p
                        and     y.nr_seq_caixa          = x.nr_seq_caixa
                        and     y.nr_sequencia          = x.nr_seq_saldo_caixa)
                and     coalesce(nr_seq_conta_banco::text, '') = ''
                and     coalesce(nr_seq_lote_enc_contas::text, '') = '' /* Francisco - 30/10/2010 - Vai entrar em outro lote */
                and     coalesce(nr_seq_pls_lote_camara::text, '') = '' /* Francisco - 30/10/2010 - Vai entrar em outro lote */
                and     (nr_seq_movto_trans_fin IS NOT NULL AND nr_seq_movto_trans_fin::text <> ''); -- Edgar 27/05/2008, OS 93779
                commit;

                if (ie_contab_classif_mens_w = 'S') and (ie_contab_mens_tesouraria_w = 'S') then
                        update  pls_titulo_rec_liq_mens a
                        set     nr_lote_contabil        = nr_lote_contabil_p
                        where   a.nr_lote_contabil      = 0
                        and     trunc(a.dt_contabil, 'month')   = trunc(dt_contabil_w, 'month')
                        and     trunc(a.dt_contabil,'dd')       <= trunc(dt_contabil_w, 'dd')

                        and     (exists (        SELECT  1
                                                from    titulo_receber_liq x
                                                where   x.nr_titulo             = a.nr_titulo
                                                and     x.nr_sequencia          = a.nr_seq_baixa
                                                and     x.nr_lote_contabil      = nr_lote_contabil_p) or
                                exists  (       SELECT  1
                                                from    pls_titulo_rec_liq_mens x,
                                                        titulo_receber_liq      y
                                                where   ((x.ie_tipo_lancamento  = 'EA' and
                                                        x.nr_lote_contabil      = 0) or (x.nr_lote_contabil     <> a.nr_lote_contabil and
                                                        x.nr_lote_contabil      <> 0))
                                                and     x.nr_seq_baixa          = y.nr_sequencia
                                                and     x.nr_seq_baixa          = a.nr_seq_baixa
                                                and     x.nr_titulo             = y.nr_titulo
                                                and     x.nr_titulo             = a.nr_titulo) or
                                exists (       select  1
                                                from    titulo_receber_liq x
                                                where   x.nr_titulo             = a.nr_titulo
                                                and     x.nr_sequencia          = a.nr_seq_baixa
                                                and     x.nr_lote_contabil      = 0
                                                and     trunc(dt_recebimento,'month')   <= trunc(dt_contabil_w, 'month')))
                        and     exists  (select 1
                                        from    titulo_receber_liq      z
                                        where   z.nr_titulo     = a.nr_titulo
                                        and     z.nr_sequencia  = a.nr_seq_baixa
                                        and     coalesce(z.nr_seq_conta_banco::text, '') = ''
                                        and     coalesce(z.nr_seq_lote_enc_contas::text, '') = '' /* Vai entrar em outro lote */
                                        and     coalesce(z.nr_seq_pls_lote_camara::text, '') = '' /* Vai entrar em outro lote */
                                        and     (z.nr_seq_movto_trans_fin IS NOT NULL AND z.nr_seq_movto_trans_fin::text <> '')
                                        and     z.dt_recebimento <= fim_dia(dt_contabil_w)
                                        and     exists (select  1
                                                        from    titulo_receber t,
                                                                estabelecimento e
                                                        where   z.nr_titulo     = t.nr_titulo
                                                        and     t.cd_estabelecimento = e.cd_estabelecimento
                                                        and     e.cd_empresa = cd_empresa_w
                                                        and     ((ie_permite_estab_dif_w <> 'N') or (t.cd_estabelecimento = cd_estabelecimento_w)))
                                        and     exists ( select  1
                                                        from    caixa c,
                                                                caixa_saldo_diario y,
                                                                movto_trans_financ x
                                                        where   x.nr_sequencia          = z.nr_seq_movto_trans_fin
                                                        and     x.nr_seq_caixa          = y.nr_seq_caixa
                                                        and     x.nr_seq_saldo_caixa    = y.nr_sequencia
                                                        and     y.nr_seq_caixa          = c.nr_sequencia
                                                        and (   exists (select  1
                                                                        from    lote_contabil_param_item d
                                                                        where   d.nr_lote_contabil      = nr_lote_contabil_p
                                                                        and     d.nr_documento  = c.nr_seq_classif
                                                                        and             d.nr_seq_parametro      = 1)
                                                        or qt_seq_classif_w = 0)));
                        commit;

                        update  titulo_receber_liq a
                        set     nr_lote_contabil = 0
                        where   not exists (SELECT 1
                                                from    pls_titulo_rec_liq_mens x
                                                where   x.nr_titulo             = a.nr_titulo
                                                and     x.nr_seq_baixa          = a.nr_sequencia
                                                and     x.nr_lote_contabil      = nr_lote_contabil_p)
                        and     exists (select  1
                                        from    pls_mensalidade x,
                                                titulo_receber  y
                                        where   y.nr_seq_mensalidade    = x.nr_sequencia
                                        and     y.nr_titulo             = a.nr_titulo)
                        and     a.nr_lote_contabil = nr_lote_contabil_p
                        and     ie_contab_mens_tesouraria_w = 'N';
                        commit;
                end if;

                if      ((ie_contab_baixas_pro_rata_w = 'S') or (ie_contab_baixas_pro_rata_w = 'A')) and (ie_contab_mens_tesouraria_w = 'S') then
                        /* Francisco - 03/05/2010 - OS 203923 */

                        update  titulo_receber_liq a
                        set     nr_lote_contab_antecip          = nr_lote_contabil_p
                        where   coalesce(nr_lote_contab_antecip,0)   = 0
                        and     trunc(dt_antecipacao_pls_mens,'month')  = trunc(dt_contabil_w, 'month')
                        and     trunc(dt_antecipacao_pls_mens,'dd')     <= trunc(dt_contabil_w, 'dd')

                        and     exists
                                (SELECT 1
                                from    titulo_receber t,
                                        estabelecimento e
                                where   a.nr_titulo             = t.nr_titulo
                                and     t.cd_estabelecimento = e.cd_estabelecimento
                                and     e.cd_empresa = cd_empresa_w
                                and     ((ie_permite_estab_dif_w <> 'N') or (t.cd_estabelecimento = cd_estabelecimento_w)))
                        and     nr_titulo in (select x.nr_seq_titulo_receber
                                from    movto_trans_financ x,
                                        caixa_saldo_diario y
                                where   y.nr_lote_contabil      = a.nr_lote_contabil
                                and     y.nr_seq_caixa          = x.nr_seq_caixa
                                and     y.nr_sequencia          = x.nr_seq_saldo_caixa)
                        and     coalesce(nr_seq_conta_banco::text, '') = ''
                        and     coalesce(nr_seq_lote_enc_contas::text, '') = '' /* Francisco - 30/10/2010 - Vai entrar em outro lote */
                        and     coalesce(nr_seq_pls_lote_camara::text, '') = '' /* Francisco - 30/10/2010 - Vai entrar em outro lote */
                        and     (nr_seq_movto_trans_fin IS NOT NULL AND nr_seq_movto_trans_fin::text <> '');
                        commit;

                        /* Francisco - 26/05/2010 -  220155 */

                        update  titulo_receber_liq a
                        set     nr_lote_contab_pro_rata         = nr_lote_contabil_p
                        where   coalesce(nr_lote_contab_pro_rata,0)  = 0
                        and     (a.dt_referencia_pls_mens IS NOT NULL AND a.dt_referencia_pls_mens::text <> '')
                        and     trunc(a.dt_referencia_pls_mens,'month') = trunc(dt_contabil_w, 'month')
                        and     trunc(a.dt_referencia_pls_mens,'dd')    <= trunc(dt_contabil_w, 'dd')

                        and     exists
                                (SELECT 1
                                from    titulo_receber t,
                                        estabelecimento e
                                where   a.nr_titulo             = t.nr_titulo
                                and     t.cd_estabelecimento = e.cd_estabelecimento
                                and     e.cd_empresa = cd_empresa_w
                                and     ((ie_permite_estab_dif_w <> 'N') or (t.cd_estabelecimento = cd_estabelecimento_w)))
                        and     nr_titulo in (select x.nr_seq_titulo_receber
                                from    movto_trans_financ x,
                                        caixa_saldo_diario y
                                where   y.nr_lote_contabil      = a.nr_lote_contabil
                                and     y.nr_seq_caixa          = x.nr_seq_caixa
                                and     y.nr_sequencia          = x.nr_seq_saldo_caixa)
                        and     coalesce(nr_seq_conta_banco::text, '') = ''
                        and     coalesce(nr_seq_lote_enc_contas::text, '') = '' /* Francisco - 30/10/2010 - Vai entrar em outro lote */
                        and     coalesce(nr_seq_pls_lote_camara::text, '') = '' /* Francisco - 30/10/2010 - Vai entrar em outro lote */
                        and     (nr_seq_movto_trans_fin IS NOT NULL AND nr_seq_movto_trans_fin::text <> '');
                        commit;
                end if;
        end if;

        /* Francisco - OS 53121 - 20/04/07 - Contabilizar contas pagar */

        if (ie_contab_cp_w = 'S') then
                /* Baixas de bordero */

                update  titulo_pagar_baixa a
                set     nr_lote_contabil        = nr_lote_contabil_p
                where   coalesce(nr_lote_contabil,0) = 0
                and     trunc(dt_baixa,'month') = trunc(dt_contabil_w, 'month')
                and     trunc(dt_baixa,'dd')    <= trunc(dt_contabil_w, 'dd')

                and     exists  (SELECT 1
                                from    titulo_pagar t,
                                        estabelecimento e
                                where   a.nr_titulo             = t.nr_titulo
                                and     t.cd_estabelecimento = e.cd_estabelecimento
                                and     e.cd_empresa = cd_empresa_w
                                and     ((ie_permite_estab_dif_w <> 'N') or (t.cd_estabelecimento = cd_estabelecimento_w)))
                and     coalesce(nr_seq_lote_enc_contas::text, '') = '' /* Francisco - 30/10/2010 - Vai entrar em outro lote */
                and     coalesce(nr_seq_pls_lote_camara::text, '') = '' /* Francisco - 30/10/2010 - Vai entrar em outro lote */
                and     nr_bordero in ( select distinct x.nr_bordero
                                        from    movto_trans_financ x,
                                                caixa_saldo_diario y
                                        where   y.nr_lote_contabil      = nr_lote_contabil_p
                                        and     y.nr_seq_caixa          = x.nr_seq_caixa
                                        and     y.nr_sequencia          = x.nr_seq_saldo_caixa
                                        and     x.nr_sequencia          = a.nr_seq_movto_trans_fin);
                commit;

                /* Baixas de avulsas */

                update  titulo_pagar_baixa a
                set     nr_lote_contabil        = nr_lote_contabil_p
                where   coalesce(nr_lote_contabil,0) = 0
                and     trunc(dt_baixa,'month') = trunc(dt_contabil_w, 'month')
                and     trunc(dt_baixa,'dd')    <= trunc(dt_contabil_w, 'dd')

                and     coalesce(nr_seq_lote_enc_contas::text, '') = '' /* Francisco - 30/10/2010 - Vai entrar em outro lote */
                and     coalesce(nr_seq_pls_lote_camara::text, '') = '' /* Francisco - 30/10/2010 - Vai entrar em outro lote */
                and     exists
                        (SELECT 1
                        from    titulo_pagar t,
                                estabelecimento e
                        where   a.nr_titulo             = t.nr_titulo
                        and     t.cd_estabelecimento = e.cd_estabelecimento
                        and     e.cd_empresa = cd_empresa_w
                        and     ((ie_permite_estab_dif_w <> 'N') or (t.cd_estabelecimento = cd_estabelecimento_w)))
                and     nr_titulo in (select distinct x.nr_seq_titulo_pagar
                        from    movto_trans_financ x,
                                caixa_saldo_diario y
                        where   y.nr_lote_contabil      = nr_lote_contabil_p
                        and     y.nr_seq_caixa          = x.nr_seq_caixa
                        and     y.nr_sequencia          = x.nr_seq_saldo_caixa
                        and     x.nr_sequencia          = a.nr_seq_movto_trans_fin);


                update  titulo_pagar_baixa_ops  a
                set     a.nr_lote_contabil              = nr_lote_contabil_p
                where   coalesce(a.nr_lote_contabil,0)       = 0
                and     exists (SELECT 1
                                from    titulo_pagar_baixa      x
                                where   x.nr_titulo     = a.nr_titulo
                                and     x.nr_sequencia  = a.nr_seq_baixa
                                and     x.nr_lote_contabil      = nr_lote_contabil_p);

                commit;
        end if;

        if (ie_contab_desp_cartao_w = 'S') then
                update  movto_cartao_cr_parcela a
                set     nr_lote_contabil = nr_lote_contabil_p
                where   coalesce(nr_lote_contabil,0) = 0
                and     exists ( SELECT  1
                                        from    movto_cartao_cr y
                                        where   y.nr_sequencia  = a.nr_seq_movto
                                        and     (y.nr_seq_caixa_rec IS NOT NULL AND y.nr_seq_caixa_rec::text <> '')
                                        and     trunc(y.dt_transacao,'month')   = trunc(dt_contabil_w, 'month')
                                        and     trunc(y.dt_transacao,'dd')      <= trunc(dt_contabil_w, 'dd')
                                        and     y.ie_lib_caixa = 'S'
                                        and     y.cd_estabelecimento    = cd_estabelecimento_w
                                        and     exists (select  1
                                                        from    caixa_receb x,
                                                                caixa_saldo_diario f,
                                                                caixa           z
                                                        where   x.nr_seq_saldo_caixa = f.nr_sequencia
                                                        and     f.nr_seq_caixa = z.nr_sequencia
                                                        and     y.nr_seq_caixa_rec = x.nr_sequencia
                                                        and (exists (select     1
                                                                        from    lote_contabil_param_item c
                                                                        where   c.nr_lote_contabil      = nr_lote_contabil_p
                                                                        and     c.nr_documento  = z.nr_seq_classif
                                                                        and             c.nr_seq_parametro      = 1)
                                                        or qt_seq_classif_w = 0)));

                if (ie_contab_cartao_cancel_w = 'S') then
                        update  movto_cartao_cr_parcela a
                        set     nr_lote_contabil_cancel = nr_lote_contabil_p
                        where   coalesce(nr_lote_contabil,0) != 0
                        and     coalesce(nr_lote_contabil_cancel,0)  = 0
                        and     exists ( SELECT  1
                                                from    movto_cartao_cr y
                                                where   y.nr_sequencia  = a.nr_seq_movto
                                                and     (y.nr_seq_caixa_rec IS NOT NULL AND y.nr_seq_caixa_rec::text <> '')
                                                and     trunc(y.dt_cancelamento,'month')        = trunc(dt_contabil_w, 'month')
                                                and     trunc(y.dt_cancelamento,'dd')   <= trunc(dt_contabil_w, 'dd')
                                                and     (y.dt_cancelamento IS NOT NULL AND y.dt_cancelamento::text <> '')
                                                and     y.ie_lib_caixa = 'S'
                                                and     y.cd_estabelecimento    = cd_estabelecimento_w
                                                and     exists (select  1
                                                                from    caixa_receb x,
                                                                                caixa_saldo_diario f,
                                                                                caixa           z
                                                                where   x.nr_seq_saldo_caixa = f.nr_sequencia
                                                                and             f.nr_seq_caixa = z.nr_sequencia
                                                                and             y.nr_seq_caixa_rec = x.nr_sequencia
                                                                and (exists (select     1
                                                                                from    lote_contabil_param_item c
                                                                                where   c.nr_lote_contabil      = nr_lote_contabil_p
                                                                                and     c.nr_documento  = z.nr_seq_classif
                                                                                and             c.nr_seq_parametro      = 1)
                                                                or qt_seq_classif_w = 0)));
                end if;
                commit;
        end if;

        CALL wheb_usuario_pck.set_ie_lote_contabil('S');

        nm_agrupador_w  := coalesce(trim(both obter_agrupador_contabil(10)),'NR_SEQ_MOVTO_TRANS_FIN');

        select  substr(obter_se_compl_tipo_lote(cd_estabelecimento_w, cd_tipo_lote_contabil),1,1)
        into STRICT    ie_compl_hist_w
        from    lote_contabil
        where   nr_lote_contabil        = nr_lote_contabil_p;

        qt_contador_w   := 0;

        open c010;
        loop
        fetch c010 into
                ie_union_w,
                nr_seq_movto_w,
                vl_transacao_w,
                nr_seq_trans_fin_w,
                dt_movimento_w,
                nm_atributo_w,
                nr_seq_conta_banco_w,
                cd_cgc_w,
                cd_conta_contabil_w,
                cd_centro_custo_w,
                nr_documento_w,
                ie_caixa_w,
                ie_saldo_caixa_w,
                ie_debito_credito_w,
                nr_seq_trans_w ,
                ds_historico_w,
                cd_pessoa_fisica_w,
                ds_hist_pf_pj_w ,
                cd_historico_w,
                cd_historico_movto_w,
                nr_doc_movto_w,
                nr_adiant_movto_w,
                nr_interno_conta_movto_w,
                nr_cheque_movto_w,
                ds_hist_movto_w,
                ds_compl_pf_pj_movto_w,
                cd_hist_caixa_movto_w,
                nr_bordero_w,
                nr_seq_titulo_pagar_w,
                nr_seq_titulo_receber_w,
                nr_seq_nota_fiscal_w,
                nr_seq_conv_receb_w,
                nr_seq_deposito_w,
                nr_adiant_pago_w,
                nr_seq_cheque_w,
                cd_conta_caixa_w,
                ds_pessoa_titulo_w,
                nr_seq_caixa_w,
                dt_transacao_w,
                nr_nota_fiscal_w,
                nr_seq_caixa_rec_w,
                ds_bandeira_w,
                ds_obs_cartao_w,
                nr_seq_produto_w,
                nr_seq_caixa_od_w,
                cd_conta_deb_pls_w,
                cd_conta_rec_pls_w,
                cd_historico_pls_w,
                nr_autorizacao_w,
                nr_seq_movto_cartao_w,
                vl_antecipacao_mens_w,
                ie_tipo_lote_pls_w,
                dt_referencia_pls_mens_w,
                nr_seq_baixa_w,--54,
                cd_estab_movto_w,--55,
                nr_seq_liq_cc_w,--56,
                nr_doc_tit_receb_w,--57,
                ie_lote_pro_rata_w,--58,
                nr_seq_cheque_cp_w,--59,
                nr_seq_movto_trans_fin_w,--60,
                nr_seq_caixa_receb_w,--61,
                cd_tipo_baixa_w,--62,
                nr_seq_protocolo_w,--63,
                cd_tipo_recebimento_w,--64,
                nm_tabela_w,--65,
                nr_seq_tab_orig_w,--66,
                nr_seq_tab_compl_w,--67,
                nr_seq_info_ctb_w,--68,
                ds_observacao_movto_w,--69;
                nr_seq_movto_transf_w,
                nr_seq_liq_origem_w,--70;
                nr_seq_proj_rec_w,
                cd_moeda_w;
        EXIT WHEN NOT FOUND; /* apply on c010 */

                if (cd_estab_movto_w = 0) then
                        cd_estab_movto_w        := null;
                end if;

                ds_estorno_w                    := '';
                nr_seq_bandeira_w               := null;
                cd_pessoa_caixa_receb_w         := '';
                nm_pessoa_caixa_receb_w         := '';
                nr_recibo_rec_w                 := '';
                ds_caixa_od_w                   := '';
                ds_obs_caixa_receb_w            := '';
                nr_seq_movto_bco_pend_w         := null;
                ds_observacao_cp_w              := '';
                ds_observacao_cr_w              := '';
                nr_cpf_w                        := '';
                ds_obs_adiantamento_w           := '';
                qt_contador_w                   := qt_contador_w + 1;
                nr_seq_trans_fin_baixa_w        := null;
                ie_estorno_w                    := '';
                nr_seq_lote_orig_w              := null;
                ds_movto_cartao_w               := '';
                nr_atendimento_w                := null;
                cd_convenio_w                   := null;
                ds_conta_banco_pend_w           := null;
                nm_paciente_atendimento_w       := null;
                nm_usuario_receb_w              := null;
                nm_pessoa_resp_atend_w          := null;


                if (coalesce(nr_seq_movto_trans_fin_w,0) > 0) then

                        if (coalesce(nr_adiant_movto_w,0) = 0) then
                                begin
                                select  coalesce(nr_adiantamento,0)
                                into STRICT    nr_adiant_movto_w
                                from    movto_trans_financ
                                where   nr_sequencia = nr_seq_movto_trans_fin_w;
                                exception when others then
                                        nr_adiant_movto_w       := null;
                                end;
                        end if;

                        if (coalesce(nr_adiant_movto_w,0) <> 0) then
                                begin
                                select  ds_observacao
                                into STRICT    ds_obs_adiantamento_w
                                from    adiantamento
                                where   nr_adiantamento = nr_adiant_movto_w;
                                exception when others then
                                        ds_obs_adiantamento_w   := '';
                                end;
                        end if;
                end if;

                if (coalesce(cd_pessoa_fisica_w, '0') <> '0') then
                        begin
                        select  nr_cpf
                        into STRICT    nr_cpf_w
                        from    pessoa_fisica
                        where   cd_pessoa_fisica        = cd_pessoa_fisica_w;
                        exception when others then
                                nr_cpf_w        := '';
                        end;
                end if;

                if (coalesce(nr_seq_caixa_od_w,0) <> 0) then
                        select  max(ds_caixa),
                                max(cd_estabelecimento)
                        into STRICT    ds_caixa_od_w,
                                cd_estab_caixa_od_w
                        from    caixa
                        where   nr_sequencia    = nr_seq_caixa_od_w;
                end if;
                qt_tit_caixa_rec_w      := 0;
                if (coalesce(nr_seq_nota_fiscal_w, 0) = 0) and (coalesce(nr_seq_titulo_pagar_w, 0) = 0) and (coalesce(nr_seq_titulo_receber_w, 0) = 0) and (coalesce(nr_seq_caixa_rec_w, 0) <> 0) and (nm_atributo_w  = 'VL_TRANSACAO') and (nm_tabela_w    = 'CAIXA_SALDO_DIARIO') then

                        select  count(nr_sequencia),
                                        max(nr_titulo)
                        into STRICT    qt_tit_caixa_rec_w,
                                        nr_seq_titulo_receber_w
                        from    titulo_receber_liq
                        where   nr_seq_caixa_rec = nr_seq_caixa_rec_w;

                        if (qt_tit_caixa_rec_w > 1) then
                                nr_seq_titulo_receber_w := null;
                        end if;
                end if;
                if (coalesce(nr_seq_titulo_receber_w,0) != 0) then
                        if (coalesce(ds_pessoa_titulo_w,'X') = 'X') then
                                ds_pessoa_titulo_w      := obter_pessoa_titulo_receber(nr_seq_titulo_receber_w);
                        end if;
                end if;

                if (coalesce(nr_seq_produto_w,0) = 0) then
                        if (coalesce(nr_seq_titulo_receber_w,0) <> 0) then
                                select  max(nr_seq_produto)
                                into STRICT    nr_seq_produto_w
                                from    titulo_receber_classif
                                where   nr_titulo       = nr_seq_titulo_receber_w;
                        end if;

                        if (coalesce(nr_adiant_movto_w,0) <> 0) then
                                select  max(nr_seq_produto)
                                into STRICT    nr_seq_produto_w
                                from    adiantamento_classif
                                where   nr_adiantamento = nr_adiant_movto_w;
                        end if;

                        begin
                        if (coalesce(nr_seq_produto_w,0) = 0) and (coalesce(nr_seq_movto_cartao_w,0) <> 0) then
                                nr_seq_produto_w        := (substr(obter_prod_financ(nr_seq_movto_cartao_w, 'AC','P'),1,10))::numeric;
                        elsif (coalesce(nr_seq_produto_w,0) = 0) and (nm_atributo_w = 'VL_TRANSACAO') then
                                nr_seq_produto_w        := (substr(obter_prod_financ(nr_seq_movto_trans_fin_w, 'MV','P'),1,10))::numeric;
                        elsif (coalesce(nr_seq_produto_w,0) = 0) and (coalesce(nr_seq_titulo_pagar_w,0) <> 0) then
                                nr_seq_produto_w        := (substr(obter_prod_financ(nr_seq_titulo_pagar_w, 'TP','P'),1,10))::numeric;
                        elsif (coalesce(nr_seq_produto_w,0) = 0) and (coalesce(nr_seq_nota_fiscal_w,0) <> 0) then
                                nr_seq_produto_w        := (substr(obter_prod_financ(nr_seq_nota_fiscal_w, 'NF','P'),1,10))::numeric;
                        end if;
                        exception when others then
                                nr_seq_produto_w        := null;
                        end;
                end if;

                if (coalesce(nr_seq_cheque_cp_w,0) <> 0) then
                        ds_cheque_cp_w  := substr(obter_dados_cheque_cp(nr_seq_cheque_cp_w, 'DS'), 1,180);
                end if;

                if (nr_seq_caixa_rec_w IS NOT NULL AND nr_seq_caixa_rec_w::text <> '') then
                        nr_documento_caixa_rec_w        := substr(obter_dados_caixa_receb(nr_seq_caixa_rec_w, 'DOC'),1,255);
                        ds_obs_caixa_receb_w            := substr(obter_dados_caixa_receb(nr_seq_caixa_rec_w, 'OBS'),1,254);

                        if (coalesce(nr_nota_fiscal_w, '0') = '0') then
                                nr_nota_fiscal_w        := substr(obter_dados_caixa_receb(nr_seq_caixa_rec_w, 'NFT'),1,255);
                        end if;

                        nr_negociacao_w := substr(obter_numero_negociacao_hist(null, null, nr_seq_caixa_rec_w),1,20);
                end if;

                if (coalesce(nr_seq_movto_w,0) <> 0 and ie_union_w not in (26, 25, 24, 23, 19, 18)) then
                        begin
                        select  ie_estorno,
                                nr_seq_lote,
                                substr(obter_nome_pf_pj(cd_pessoa_fisica, cd_cgc), 1, 255),
                                nr_seq_movto_orig,
                                CASE WHEN coalesce(nr_seq_caixa_rec_w,0)=0 THEN nr_seq_caixa_rec  ELSE nr_seq_caixa_rec_w END
                        into STRICT    ie_estorno_w,
                                nr_seq_lote_w,
                                nm_pessoa_movto_w,
                                nr_seq_movto_orig_w,
                                nr_seq_caixa_rec_w
                        from    movto_trans_financ
                        where   nr_sequencia    = nr_seq_movto_w;
                        exception when others then
                                ds_estorno_w            := '';
                                nr_seq_lote_w           := null;
                                nm_pessoa_movto_w       := '';
                        end;

                        select  max(nr_seq_movto_pend)
                        into STRICT    nr_seq_movto_bco_pend_w
                        from    movto_banco_pend_baixa
                        where   nr_seq_movto_trans_fin  = nr_seq_movto_w;

                        select  max(b.ds_conta)
                        into STRICT    ds_conta_banco_pend_w
                        from    banco_estabelecimento_v b,
                                movto_banco_pend a
                        where   a.nr_seq_conta_banco    = b.nr_sequencia
                        and     a.nr_sequencia          = nr_seq_movto_bco_pend_w;


                        if (ie_estorno_w = 'E') then
                                ds_estorno_w    := substr(wheb_mensagem_pck.get_texto(304692),1,255); --Estorno
                        end if;
                elsif (coalesce(nr_seq_caixa_rec_w,0) <> 0) and (coalesce(nr_seq_movto_w,0) = 0) then
                        open c04;
                        loop
                        fetch c04 into
                                ie_estorno_w,
                                nr_seq_lote_w,
                                nm_pessoa_movto_w,
                                nr_seq_movto_orig_w;
                        EXIT WHEN NOT FOUND; /* apply on c04 */
                                /* Cursor Para pegar o maior numero de informacoes nescessarias*/

                                ie_estorno_w:= ie_estorno_w;
                        end loop;
                        close c04;

                        select  max(nr_seq_movto_pend)
                        into STRICT    nr_seq_movto_bco_pend_w
                        from    movto_banco_pend_baixa b,
                                movto_trans_financ a
                        where   b.nr_seq_movto_trans_fin        = a.nr_sequencia
                        and     a.nr_seq_caixa_rec              = nr_seq_caixa_rec_w;

                        select  max(b.ds_conta)
                        into STRICT    ds_conta_banco_pend_w
                        from    banco_estabelecimento_v b,
                                movto_banco_pend a
                        where   a.nr_seq_conta_banco    = b.nr_sequencia
                        and     a.nr_sequencia          = nr_seq_movto_bco_pend_w;

                        if (ie_estorno_w = 'E') then
                                ds_estorno_w    := substr(wheb_mensagem_pck.get_texto(304692),1,255); --Estorno
                        end if;
                end if;

                /*Busca adiantamento pelo movimento de origem */

                if (coalesce(nr_adiant_movto_w,0) = 0) and (coalesce(nr_seq_movto_orig_w,0) <> 0) then
                        select  max(b.nr_adiantamento)
                        into STRICT    nr_adiant_movto_w
                        from    adiantamento b,
                                movto_trans_financ a
                        where   a.nr_seq_caixa_rec      = b.nr_seq_caixa_rec
                        and     a.nr_sequencia          = nr_seq_movto_orig_w;
                end if;

                if (coalesce(nr_adiant_movto_w,0) <> 0) then
                        begin
                        select  ds_observacao
                        into STRICT    ds_obs_adiantamento_w
                        from    adiantamento
                        where   nr_adiantamento = nr_adiant_movto_w;
                        exception when others then
                                ds_obs_adiantamento_w   := '';
                        end;
                end if;

                if (ie_dt_contab_tesouraria_w = 'T') then
                        dt_contabil_w   := dt_movimento_w;
                end if;

                if (coalesce(nr_seq_caixa_rec_w,0) <> 0) then
                        begin
                        select  nr_recibo,
                                coalesce(cd_pessoa_fisica, cd_cgc),
                                substr(obter_nome_pf_pj(cd_pessoa_fisica, cd_cgc),1,240) nm_pessoa_caixa,
                                substr(obter_nome_usuario(coalesce(nm_usuario_nrec,nm_usuario)),1,255)
                        into STRICT    nr_recibo_rec_w,
                                cd_pessoa_caixa_receb_w,
                                nm_pessoa_caixa_receb_w,
                                nm_usuario_receb_w
                        from    caixa_receb
                        where   nr_sequencia    = nr_seq_caixa_rec_w;
                        exception when others then
                                nr_recibo_rec_w         := '';
                                cd_pessoa_caixa_receb_w := '';
                                nm_pessoa_caixa_receb_w := '';
                        end;

                        begin
                        select  vl_especie,
                                obter_valores_caixa_rec(nr_sequencia,'VCH') vl_cheque,
                                obter_valores_caixa_rec(nr_sequencia,'VCA') vl_cartao
                        into STRICT    vl_especie_w,
                                vl_cheque_w,
                                vl_cartao_w
                        from    caixa_receb
                        where   nr_sequencia    = nr_seq_caixa_rec_w;
                        exception when others then
                                vl_especie_w    := 0;
                                vl_cheque_w     := 0;
                                vl_cartao_w     := 0;
                        end;

                        if (nm_atributo_w = 'VL_TRANSACAO') and (coalesce(nr_doc_tit_receb_w::text, '') = '') then
                                select  substr(max(nr_documento),1,22)
                                into STRICT    nr_doc_tit_receb_w
                                from    titulo_receber_liq
                                where   nr_seq_caixa_rec        = nr_seq_caixa_rec_w;
                        end if;
                end if;

                if (coalesce(nr_seq_caixa_rec_w,0) = 0) and (coalesce(nr_seq_movto_orig_w,0) <> 0) and (coalesce(nr_recibo_rec_w,'0') = '0') then
                        begin
                        select  b.nr_recibo
                        into STRICT    nr_recibo_rec_w
                        from    caixa_receb b,
                                movto_trans_financ a
                        where   a.nr_seq_caixa_rec      = b.nr_sequencia
                        and     a.nr_sequencia          = nr_seq_movto_orig_w;
                        exception when others then
                                nr_recibo_rec_w := '';
                        end;
                end if;
                if (coalesce(nr_seq_caixa_w,0) = 0) and (coalesce(nr_seq_movto_w, 0) > 0) then
                        select  max(nr_seq_caixa)
                        into STRICT    nr_seq_caixa_w
                        from    movto_trans_financ
                        where   nr_sequencia    = nr_seq_movto_w;
                end if;

                if (coalesce(nr_seq_movto_cartao_w,0) = 0) and (coalesce(nr_seq_caixa_rec_w,0) <> 0) then
                        select  max(nr_sequencia)
                        into STRICT    nr_seq_movto_cartao_w
                        from    movto_cartao_cr
                        where   nr_seq_caixa_rec        = nr_seq_caixa_rec_w;
                end if;

                nm_pf_pj_cartao_w       := '';

                if (coalesce(nr_seq_movto_cartao_w,0) <> 0) then
                        select  max(nr_seq_bandeira),
                                max(nr_seq_forma_pagto),
                                substr(max(obter_nome_pf_pj(cd_pessoa_fisica,cd_cgc)),1,255),
                                max(cd_estabelecimento)
                        into STRICT    nr_seq_bandeira_w,
                                nr_seq_forma_pagto_w,
                                nm_pf_pj_cartao_w,
                                cd_estab_inf_movto_w
                        from    movto_cartao_cr
                        where   nr_sequencia    = nr_seq_movto_cartao_w;

                        if (coalesce(nr_autorizacao_w,'0') = '0')then
                                        select  coalesce(max(nr_autorizacao),nr_autorizacao_w)
                                        into STRICT    nr_autorizacao_w
                                        from    movto_cartao_cr
                                        where   nr_sequencia    = nr_seq_movto_cartao_w;
                        end if;

                        if (coalesce(ds_bandeira_w,'X') = 'X') then
                                ds_bandeira_w   := substr(obter_desc_bandeira_cartao(nr_seq_bandeira_w),1,140);
                        end if;

                        if (coalesce(nr_seq_forma_pagto_w, 0) <> 0) then
                                select  max(ds_forma_pagto)
                                into STRICT    ds_forma_pagto_w
                                from    forma_pagto_cartao_cr
                                where   nr_sequencia    = nr_seq_forma_pagto_w;
                        end if;
                end if;

                if (nm_agrupador_w = 'NR_SEQ_LOTE') then

                        if (nm_atributo_w like '%CARTAO%') then
                                begin
                                select  a.nr_seq_lote
                                into STRICT    nr_seq_agrupamento_w
                                from    movto_trans_financ a
                                where   a.nr_seq_movto_cartao = nr_seq_movto_w
                                and     a.nr_seq_trans_financ = nr_seq_trans_fin_w
                                and     (a.nr_seq_lote IS NOT NULL AND a.nr_seq_lote::text <> '')  LIMIT 1;
                                exception
                                when others then
                                        begin
                                        select  a.nr_seq_lote
                                        into STRICT    nr_seq_agrupamento_w
                                        from    movto_trans_financ a
                                        where   a.nr_seq_movto_cartao = nr_seq_movto_w
                                        and     (a.nr_seq_lote IS NOT NULL AND a.nr_seq_lote::text <> '')  LIMIT 1;
                                        exception
                                        when others then
                                                nr_seq_agrupamento_w    := nr_seq_lote_w;
                                        end;
                                end;
                        else
                                nr_seq_agrupamento_w    := nr_seq_lote_w;
                                if (ie_estorno_w in ('E', 'S')) then
                                        begin
                                        select  nr_seq_lote
                                        into STRICT    nr_seq_lote_orig_w
                                        from    movto_trans_financ
                                        where   nr_sequencia    = nr_seq_movto_orig_w;

                                        nr_seq_agrupamento_w    := coalesce(nr_seq_lote_orig_w, nr_seq_lote_w);
                                        exception when others then
                                                nr_seq_agrupamento_w :=  nr_seq_lote_w;
                                        end;
                                end if;

                                if (coalesce(nr_seq_movto_transf_w,0) <> 0) and (ie_caixa_w = 'T') then
                                        select  coalesce(max(nr_seq_lote),nr_seq_agrupamento_w)
                                        into STRICT    nr_seq_agrupamento_w
                                        from    movto_trans_financ
                                        where   nr_sequencia = nr_seq_movto_transf_w;
                                end if;
                        end if;
                elsif (nm_agrupador_w = 'NR_TITULO') then
                        select  coalesce(max(CASE WHEN coalesce(nr_seq_titulo_receber_w,0)=0 THEN nr_seq_titulo_pagar_w  ELSE nr_seq_titulo_receber_w END ),0)
                        into STRICT    nr_seq_agrupamento_w
;
                elsif (nm_agrupador_w = 'NR_SEQ_MOVTO_TRANS_FIN') then

                        if (coalesce(nr_seq_movto_transf_w, 0) != 0) then
                                nr_seq_agrupamento_w    := nr_seq_movto_transf_w;
                        else
                                nr_seq_agrupamento_w    := nr_seq_movto_w;
                        end if;

                        if (ie_estorno_w in ('E', 'S')) then

                                nr_seq_agrupamento_w := nr_seq_movto_orig_w;
                                if (coalesce(nr_seq_movto_orig_w,0 ) <> 0) then
                                        select  max(nr_seq_movto_transf)
                                        into STRICT    nr_seq_movto_transf_estorno_w
                                        from    movto_trans_financ
                                        where   nr_sequencia = nr_seq_movto_orig_w;
                                        if (coalesce(nr_seq_movto_transf_estorno_w, 0) != 0) then
                                                nr_seq_agrupamento_w:= nr_seq_movto_transf_estorno_w;
                                        end if;
                                end if;
                        end if;
                        if (coalesce(nr_seq_liq_origem_w,0) <> 0) then
                                begin
                                select  a.nr_seq_movto_trans_fin
                                into STRICT    nr_seq_movto_orig_w
                                from    titulo_receber_liq a
                                where   a.nr_titulo             = nr_seq_titulo_receber_w
                                and             a.nr_sequencia  = nr_seq_liq_origem_w;
                                nr_seq_agrupamento_w := nr_seq_movto_orig_w;
                                exception when others then
                                                nr_seq_movto_orig_w     := null;
                                end;
                        end if;
                        if (nm_atributo_w like '%CARTAO%') and (coalesce(nr_seq_agrupamento_w,0) = 0) then
                                nr_seq_agrupamento_w    := nr_seq_movto_w;
                        end if;
                elsif (nm_agrupador_w = 'NR_SEQ_LOTE_CAIXA')then
                        begin
                        nr_seq_agrupamento_w    := somente_numero(substr(nr_seq_lote_w || nr_seq_caixa_w,1,10));
                        if (ie_estorno_w in ('E', 'S')) then
                                begin
                                select  nr_seq_lote
                                into STRICT    nr_seq_lote_orig_w
                                from    movto_trans_financ
                                where   nr_sequencia    = nr_seq_movto_orig_w;

                                nr_seq_agrupamento_w    := somente_numero(substr(coalesce(nr_seq_lote_orig_w, nr_seq_lote_w) || nr_seq_caixa_w,1,10));
                                exception when others then
                                        nr_seq_agrupamento_w    := somente_numero(substr(nr_seq_lote_w || nr_seq_caixa_w,1,10));
                                end;
                        end if;

                        if (coalesce(nr_seq_movto_transf_w, 0) <> 0) and (ie_caixa_w = 'T') then
                                begin

                                select  nr_seq_lote,
                                        nr_seq_caixa
                                into STRICT    nr_seq_lote_transf_w,
                                        nr_seq_caixa_transf_w
                                from    movto_trans_financ
                                where   nr_sequencia    = nr_seq_movto_transf_w;

                                if (coalesce(nr_seq_lote_transf_w, 0) <> 0) and (coalesce(nr_seq_caixa_transf_w, 0) <> 0) then
                                        nr_seq_agrupamento_w := somente_numero(substr(nr_seq_lote_transf_w || nr_seq_caixa_transf_w,1,10));
                                end if;
                                exception when others then
                                        nr_seq_lote_transf_w    := null;
                                        nr_seq_caixa_transf_w   := null;
                                end;
                        end if;

                        exception when others then
                                nr_seq_agrupamento_w    := 0;
                        end;
                elsif (nm_agrupador_w = 'NR_SEQ_CAIXA')then
                                nr_seq_agrupamento_w    := substr(nr_seq_caixa_w,1,10);

                else
                        nr_seq_agrupamento_w    := nr_seq_movto_w;
                end if;

                if (coalesce(nr_seq_agrupamento_w,0) = 0)       then

                        nr_seq_agrupamento_w    :=      nr_seq_movto_w;
                        if (ie_estorno_w in ('E', 'S')) then
                                nr_seq_agrupamento_w := nr_seq_movto_orig_w;
                        end if;

                end if;

                if (coalesce(nr_documento_w::text, '') = '') then
                        nr_documento_w  := substr(ds_hist_pf_pj_w,1,255);
                else
                        nr_documento_w  := substr(nr_documento_w  || ' ' || ds_hist_pf_pj_w,1,255);
                end if;

                if (coalesce(nr_documento_w::text, '') = '') then
                        nr_documento_w  := substr(ds_historico_w,1,255);
                else
                        nr_documento_w  := substr(nr_documento_w  || ' ' || ds_historico_w,1,255);
                end if;

                if (nr_seq_conta_banco_w IS NOT NULL AND nr_seq_conta_banco_w::text <> '') then
                        begin
                        select  ds_conta
                        into STRICT    ds_conta_od_w
                        from    banco_estabelecimento_v
                        where   nr_sequencia    = nr_seq_conta_banco_w;
                        exception when others then
                                ds_conta_od_w   := '';
                        end;
                end if;

                ds_conteudo_w           := '';
                ds_compl_historico_w    := '';

                if (ie_compl_hist_w = 'S') then
                        cd_banco_cheque_w               := null;
                        cd_banco_ext_cheque_w           := null;
                        ds_banco_cheque_w               := null;
                        cd_agencia_cheque_w             := null;
                        nr_conta_cheque_w               := null;
                        nr_adiant_cheque_w              := null;
                        nm_pf_cheque_w                  := null;
                        ds_razao_social_cheque_w        := null;
                        dt_venc_cheque_atual_w          := null;
                        nm_paciente_cheque_w            := null;
                        ds_banco_od_w                   := '';
                        nr_cpf_cheque_w                 := '';
                        cd_cnpj_cheque_w                := '';
                        nm_mae_pf_w                     := '';


                        if (ie_union_w in (1,6,7)) then
                                select  substr(max(ds_banco),1,40)
                                into STRICT    ds_banco_od_w
                                from    banco_estabelecimento_v
                                where   nr_sequencia    = nr_seq_conta_banco_w;
                        end if;

                        if (coalesce(nr_adiant_movto_w, 0) = 0) and (coalesce(nr_seq_caixa_rec_w,0) <> 0) then
                                select  max(nr_adiantamento)
                                into STRICT    nr_adiant_movto_w
                                from    adiantamento
                                where   nr_seq_caixa_rec        = nr_seq_caixa_rec_w;
                        end if;

                        select  max(substr(obter_pessoa_atendimento(nr_atendimento,'N'),1,60)),
                                max(nr_recibo),
                                max(nr_atendimento)
                        into STRICT    nm_paciente_adiantamento_w,
                                nr_recibo_w,
                                nr_atendimento_w
                        from    adiantamento
                        where   nr_adiantamento = nr_adiant_movto_w;

                        if (coalesce(nr_adiant_movto_w, 0) <> 0) and (coalesce(nm_paciente_adiantamento_w, 'X') = 'X') then
                                nm_paciente_adiantamento_w := substr(obter_paciente_adiantamento(nr_adiant_movto_w, 'N'), 1, 255);
                        end if;

                        if (coalesce(nr_seq_cheque_w,0) > 0) then
                                select  a.cd_banco,
                                        a.ds_banco,
                                        a.cd_agencia_bancaria,
                                        a.nr_conta,
                                        a.nr_adiantamento,
                                        a.nm_pessoa_fisica,
                                        a.ds_razao_social,
                                        substr(obter_dados_cheque_cr(a.nr_seq_cheque,'NP'),1,255),
                                        coalesce(a.dt_vencimento_atual, a.dt_vencimento),
                                        b.cd_banco_externo,
                                        nr_cpf_cheque_w,
                                        cd_cnpj_cheque_w
                                into STRICT    cd_banco_cheque_w,
                                        ds_banco_cheque_w,
                                        cd_agencia_cheque_w,
                                        nr_conta_cheque_w,
                                        nr_adiant_cheque_w,
                                        nm_pf_cheque_w,
                                        ds_razao_social_cheque_w,
                                        nm_paciente_cheque_w,
                                        dt_venc_cheque_atual_w,
                                        cd_banco_ext_cheque_w,
                                        nr_cpf_cheque_w,
                                        cd_cnpj_cheque_w
                                from    banco b,
                                        cheque_cr_v a
                                where   a.nr_seq_cheque = nr_seq_cheque_w
                                and     a.cd_banco      = b.cd_banco;
                        end if;

                        if (coalesce(nr_seq_caixa_w,0) <> 0) then
                                select  max(ds_caixa)
                                into STRICT    ds_caixa_w
                                from    caixa
                                where   nr_sequencia    = nr_seq_caixa_w;
                        end if;

                        ds_cheque_deposito_w    := '';
                        open c02;
                        loop
                        fetch c02 into
                                nr_cheque_deposito_w;
                        EXIT WHEN NOT FOUND; /* apply on c02 */
                                ds_cheque_deposito_w    := substr(nr_cheque_deposito_w || ', ' || ds_cheque_deposito_w, 1, 255);
                        end loop;
                        close c02;

                        open c03;
                        loop
                        fetch c03 into
                                nr_cheque_w;
                        EXIT WHEN NOT FOUND; /* apply on c03 */
                                ds_cheques_caixa_rec_w  := substr(nr_cheque_w || ', ' || ds_cheques_caixa_rec_w, 1, 255);
                        end loop;
                        close c03;

                        ds_pessoa_nota_w        := '';

                        if (coalesce(nr_seq_nota_fiscal_w, 0) = 0) then
                                if (coalesce(nr_seq_titulo_pagar_w, 0) <> 0) then
                                        nr_seq_nota_fiscal_w    := substr(obter_dados_tit_pagar(nr_seq_titulo_pagar_w, 'NFSEQ'),1,10);
										
                                elsif (coalesce(nr_seq_titulo_receber_w, 0) <> 0) then
                                        nr_seq_nota_fiscal_w    := substr(obter_dados_titulo_receber(nr_seq_titulo_receber_w, 'SN'),1,10);
                                end if;
                        end if;

                        if (coalesce(nr_seq_nota_fiscal_w,0) > 0) then
                                ds_pessoa_nota_w        := substr(obter_dados_nota_fiscal(nr_seq_nota_fiscal_w,5),1,80);
				select  substr('NF' || CASE WHEN coalesce(b.ie_servico,'N')='S' THEN 'S' END  || CASE WHEN coalesce(a.ie_nf_eletronica,'N')='S' THEN 'E' END ,1,15),
					a.cd_serie_nf,
					a.nr_nfe_imp,
					a.nr_nota_fiscal
                                into STRICT
			  		ie_nf_nfe_w,
					cd_serie_nf_w,
					nr_nfe_imp_w,
					nr_nota_fiscal_w
                          	from    nota_fiscal a,
                                  	operacao_nota b
                          	where   a.cd_operacao_nf        = b.cd_operacao_nf
                          	and     a.nr_sequencia          = nr_seq_nota_fiscal_w;
                        end if;

                        ds_cheques_caixa_rec_w  := substr(ds_cheques_caixa_rec_w,1,length(ds_cheques_caixa_rec_w)-2);
                        dt_transacao_ww         := to_char(dt_transacao_w, 'dd/mm/yyyy');

                        nr_seq_tit_rec_doc_w:= nr_seq_titulo_receber_w;

                        if (coalesce(nr_seq_tit_rec_doc_w,0) = 0) and (ie_caixa_w = 'M') and (coalesce(nr_seq_lote_w, 0) <> 0)then
                                begin
                                select  max(a.nr_seq_titulo_receber)
                                into STRICT    nr_seq_tit_rec_doc_w
                                from    movto_trans_financ a,
                                        transacao_financeira b
                                where   a.nr_seq_lote           = nr_seq_lote_w
                                and     a.nr_sequencia          = nr_seq_movto_w
                                and     a.nr_seq_trans_financ   = b.nr_sequencia
                                and     ie_caixa                = 'D';
                                exception
                                when others then
                                        nr_seq_tit_rec_doc_w:= null;
                                end;
                        end if;


                        if (coalesce(nr_interno_conta_movto_w,0) = 0) and (coalesce(nr_seq_tit_rec_doc_w,0) <> 0) then
                                select  max(nr_interno_conta)
                                into STRICT    nr_interno_conta_movto_w
                                from    titulo_receber
                                where   nr_titulo       = nr_seq_tit_rec_doc_w;
                        end if;

                        if (nr_interno_conta_movto_w <> 0) then
                                select  max(cd_convenio_parametro),
                                        max(nr_atendimento)
                                into STRICT    cd_convenio_w,
                                        nr_atendimento_w
                                from    conta_paciente
                                where   nr_interno_conta        = nr_interno_conta_movto_w;

                                nm_paciente_atendimento_w:= obter_pessoa_atendimento(nr_atendimento_w,'N');
                        end if;

                        if (coalesce(nr_seq_movto_w, 0) > 0) then
                                select  max(nr_sequencia)
                                into STRICT    nr_seq_movto_pend_w
                                from    movto_banco_pend
                                where   nr_seq_movto_trans_fin  = nr_seq_movto_w;
                        end if;

                        if (coalesce(nr_seq_cheque_cp_w,0) > 0) then
                                select  max(nr_cheque)
                                into STRICT    nr_cheque_pago_w
                                from    cheque
                                where   nr_sequencia    = nr_seq_cheque_cp_w;
                        end if;

                        if (coalesce(nr_seq_conta_banco_w,0) > 0) then
                                select  max(nr_sequencia)
                                into STRICT    nr_seq_cob_escritural_w
                                from    cobranca_escritural
                                where   nr_seq_conta_banco      = nr_seq_conta_banco_w;
                        end if;

                        if      coalesce(nr_seq_titulo_pagar_w,0) > 0 then
                                select  substr(ds_observacao_titulo,1,255),
                                        nr_seq_trans_fin_baixa,
                                        nr_seq_rpa
                                into STRICT    ds_observacao_cp_w,
                                        nr_seq_trans_fin_baixa_w,
                                        nr_seq_rpa_w
                                from    titulo_pagar
                                where   nr_titulo       = nr_seq_titulo_pagar_w;

                                if (ie_contab_trans_fin_baixa_w = 'S') then
                                        nr_seq_trans_fin_w := coalesce(nr_seq_trans_fin_baixa_w,nr_seq_trans_fin_w);
                                end if;

                                if (coalesce(nr_seq_protocolo_w::text, '') = '') then
                                        select  max(nr_seq_prot_conta)
                                        into STRICT    nr_seq_protocolo_w
                                        from    titulo_pagar
                                        where   nr_titulo       = nr_seq_titulo_pagar_w;
                                end if;
                        end if;

                        if (coalesce(nr_seq_titulo_receber_w,0) > 0) then
                                select  substr(ds_observacao_titulo,1,255)
                                into STRICT    ds_observacao_cr_w
                                from    titulo_receber
                                where   nr_titulo       = nr_seq_titulo_receber_w;

                                if (coalesce(nr_seq_protocolo_w::text, '') = '') then
                                        select  max(nr_seq_protocolo)
                                        into STRICT    nr_seq_protocolo_w
                                        from    titulo_receber
                                        where   nr_titulo       = nr_seq_titulo_receber_w;

                                        if (coalesce(nr_seq_protocolo_w,0) = 0) then
                                                select  max(nr_interno_conta)
                                                into STRICT    nr_interno_conta_w
                                                from    titulo_receber
                                                where   nr_titulo       = nr_seq_titulo_receber_w;

                                                if (coalesce(nr_interno_conta_w,0) > 0) then
                                                        select  max(nr_seq_protocolo)
                                                        into STRICT    nr_seq_protocolo_w
                                                        from    conta_paciente
                                                        where   nr_interno_conta        = nr_interno_conta_w;
                                                end if;
                                        end if;
                                end if;
                        end if;

                        if (coalesce(nr_seq_caixa_rec_w,0) <> 0) then
                                select  count(*)
                                into STRICT    qt_registro_w
                                from    cheque_cr_perda a
                                where   a.nr_seq_caixa_rec      = nr_seq_caixa_rec_w;

                                if (qt_registro_w > 0) then
                                        select  max(nr_seq_cheque)
                                        into STRICT    nr_seq_cheque_ww
                                        from    cheque_cr_perda a
                                        where   a.nr_seq_caixa_rec      = nr_seq_caixa_rec_w;

                                        select  max(nr_recibo)
                                        into STRICT    nr_recibo_caixa_receb_w

                                        from (SELECT (obter_descricao_padrao('CAIXA_RECEB','NR_RECIBO',a.nr_seq_caixa_rec))::numeric  nr_recibo
                                                from    caixa b,
                                                        movto_trans_financ_v a
                                                where   a.nr_seq_caixa  = b.nr_sequencia
                                                and     exists (select 1
                                                                from    movto_trans_financ      x
                                                                where   x.nr_seq_lote   = a.nr_seq_lote
                                                                and     x.nr_seq_caixa  = a.nr_seq_caixa
                                                                and     x.nr_seq_cheque = nr_seq_cheque_ww)
                                                and     not exists (select 1
                                                                        from    titulo_receber_liq z,
                                                                                movto_trans_financ y
                                                                        where   y.nr_sequencia          = a.nr_sequencia
                                                                        and     y.nr_seq_titulo_receber = z.nr_titulo
                                                                        and     y.nr_seq_caixa_rec      = z.nr_seq_caixa_rec)

union all

                                                SELECT  (obter_descricao_padrao('CAIXA_RECEB','NR_RECIBO',a.nr_seq_caixa_rec))::numeric  nr_recibo
                                                from    titulo_receber_liq      c,
                                                        caixa                   b,
                                                        movto_trans_financ_v    a
                                                where   b.nr_sequencia          = a.nr_seq_caixa

                                                and     c.nr_titulo             = a.nr_seq_titulo_receber
                                                and     a.nr_seq_caixa_rec      = c.nr_seq_caixa_rec
                                                and     exists (select  1
                                                                from    movto_trans_financ x
                                                                where   x.nr_seq_lote   = a.nr_seq_lote
                                                                and     x.nr_seq_caixa  = a.nr_seq_caixa
                                                                and     x.nr_seq_cheque = nr_seq_cheque_ww)) alias8;
                                end if;
                        end if;

                        select  count(cd_pessoa_fisica)  --OS 517971
                        into STRICT    qt_registro_w
                        from    pessoa_fisica
                        where   cd_pessoa_fisica        = cd_pessoa_fisica_w;

                        nr_prontuario_w := null;
                        if (nr_atendimento_w IS NOT NULL AND nr_atendimento_w::text <> '') then
                                begin
                                        select  obter_prontuario_paciente(a.cd_pessoa_fisica),
                                                substr(obter_nome_pessoa_fisica(cd_pessoa_responsavel, null),1,255)
                                        into STRICT    nr_prontuario_w,
                                                nm_pessoa_resp_atend_w
                                        from    atendimento_paciente a
                                        where   a.nr_atendimento = nr_atendimento_w;
                                exception
                                when others then
                                        null;
                                end;
                        end if;


                        if (qt_registro_w > 0) then
                                select  substr(obter_nome_mae_pf(cd_pessoa_fisica_w),1,255)
                                into STRICT    nm_mae_pf_w
;
                        end if;

                        if (nr_seq_movto_cartao_w IS NOT NULL AND nr_seq_movto_cartao_w::text <> '') then
                                begin
                                ds_movto_cartao_w       := substr(obter_dados_cartao_cr( nr_seq_movto_cartao_w, 'DMT'),1,255);
                                exception
                                when others then
                                        ds_movto_cartao_w := '';
                                end;
                        end if;


                        ds_transacao_w  := null;
                        if (nr_seq_trans_fin_w IS NOT NULL AND nr_seq_trans_fin_w::text <> '') then
                                select  max(ds_transacao)
                                into STRICT    ds_transacao_w
                                from    transacao_financeira
                                where   nr_sequencia    = nr_seq_trans_fin_w;
                        end if;
                        ds_tipo_recebimento_w   := null;
                        if (cd_tipo_recebimento_w IS NOT NULL AND cd_tipo_recebimento_w::text <> '') then
                                select  max(ds_tipo_recebimento)
                                into STRICT    ds_tipo_recebimento_w
                                from    tipo_recebimento
                                where   cd_tipo_recebimento     = cd_tipo_recebimento_w;
                        end if;

                        ds_conteudo_w   := substr(      nr_doc_movto_w                          || '#@' ||
                                                        nr_adiant_movto_w                       || '#@' ||
                                                        nr_bordero_w                            || '#@' ||
                                                        nr_interno_conta_movto_w                || '#@' ||
                                                        nr_cheque_movto_w                       || '#@' ||
                                                        ds_hist_movto_w                         || '#@' ||
                                                        substr(ds_compl_pf_pj_movto_w,1,240)    || '#@' ||
                                                        cd_hist_caixa_movto_w                   || '#@' ||
                                                        cd_historico_movto_w                    || '#@' ||
                                                        nr_seq_movto_w                          || '#@' ||
                                                        ds_hist_pf_pj_w                         || '#@' ||
                                                        nr_seq_titulo_pagar_w                   || '#@' ||
                                                        nr_seq_titulo_receber_w                 || '#@' ||
                                                        nr_seq_nota_fiscal_w                    || '#@' ||
                                                        nr_seq_conv_receb_w                     || '#@' ||
                                                        nr_seq_deposito_w                       || '#@' ||
                                                        nr_adiant_pago_w                        || '#@' ||
                                                        cd_banco_cheque_w                       || '#@' ||
                                                        ds_banco_cheque_w                       || '#@' ||
                                                        cd_agencia_cheque_w                     || '#@' ||
                                                        nr_conta_cheque_w                       || '#@' ||
                                                        nr_adiant_cheque_w                      || '#@' ||
                                                        nm_pf_cheque_w                          || '#@' ||
                                                        ds_razao_social_cheque_w                || '#@' ||
                                                        ds_pessoa_titulo_w                      || '#@' ||
                                                        dt_transacao_ww                         || '#@' ||
                                                        nr_nota_fiscal_w                        || '#@' ||
                                                        ds_cheque_deposito_w                    || '#@' ||
                                                        nm_paciente_cheque_w                    || '#@' ||
                                                        nr_nfe_imp_w                            || '#@' ||
                                                        nm_paciente_adiantamento_w              || '#@' ||
                                                        ds_conta_od_w                           || '#@' ||
                                                        nr_recibo_w                             || '#@' ||
                                                        dt_venc_cheque_atual_w                  || '#@' ||
                                                        cd_banco_ext_cheque_w                   || '#@' ||
                                                        ds_cheques_caixa_rec_w                  || '#@' ||
                                                        ds_bandeira_w                           || '#@' ||
                                                        ds_obs_cartao_w                         || '#@' ||
                                                        ds_banco_od_w                           || '#@' ||
                                                        ds_caixa_w                              || '#@' ||
                                                        nr_recibo_rec_w                         || '#@' ||
                                                        ds_pessoa_nota_w                        || '#@' ||
                                                        nr_autorizacao_w                        || '#@' ||
                                                        ds_estorno_w                            || '#@' ||
                                                        nr_seq_lote_w                           || '#@' ||
                                                        cd_pessoa_caixa_receb_w                 || '#@' ||
                                                        nm_pessoa_caixa_receb_w                 || '#@' ||
                                                        nm_pessoa_movto_w                       || '#@' ||
                                                        ds_caixa_od_w                           || '#@' ||
                                                        ds_forma_pagto_w                        || '#@' ||
                                                        cd_pessoa_fisica_w                      || '#@' ||
                                                        nr_doc_tit_receb_w                      || '#@' ||
                                                        nr_documento_caixa_rec_w                || '#@' ||
                                                        nm_estabelecimento_w                    || '#@' ||
                                                        ds_obs_caixa_receb_w                    || '#@' ||
                                                        ds_cheque_cp_w                          || '#@' ||
                                                        nr_seq_movto_bco_pend_w                 || '#@' ||
                                                        nr_cpf_w                                || '#@' ||
                                                        nr_atendimento_w                        || '#@' ||
                                                        nr_negociacao_w                         || '#@' ||
                                                        nr_seq_movto_pend_w                     || '#@' ||
                                                        nr_cheque_pago_w                        || '#@' ||
                                                        nr_seq_cob_escritural_w                 || '#@' ||
                                                        ds_observacao_cp_w                      || '#@' ||
                                                        ds_observacao_cr_w                      || '#@' ||
                                                        nr_cpf_cheque_w                         || '#@' ||
                                                        cd_cnpj_cheque_w                        || '#@' ||
                                                        ds_obs_adiantamento_w                   || '#@' ||
                                                        nr_recibo_caixa_receb_w                 || '#@' ||
                                                        nm_mae_pf_w                             || '#@' ||
                                                        ds_movto_cartao_w                       || '#@' ||
                                                        nr_seq_protocolo_w                      || '#@' ||
                                                        vl_especie_w                            || '#@' ||
                                                        vl_cheque_w                             || '#@' ||
                                                        vl_cartao_w                             || '#@' ||
                                                        nm_pf_pj_cartao_w                       || '#@' ||
                                                        ie_nf_nfe_w                             || '#@' ||
                                                        ds_observacao_movto_w                   || '#@' ||
                                                        nm_paciente_atendimento_w               || '#@' ||
                                                        ds_conta_banco_pend_w                   || '#@' ||
                                                        nr_seq_rpa_w                            || '#@' ||
                                                        ''                                      || '#@' ||--DS_CLASSIF_CAIXA estava sem valor, tive que adicionar vazio para funcionar os demais
                                                        ds_transacao_w                          || '#@' ||
                                                        nr_prontuario_w                         || '#@' ||
                                                        nm_pessoa_resp_atend_w                  || '#@' ||
                                                        nm_usuario_receb_w                      || '#@' ||
                                                        ds_tipo_recebimento_w                   || '#@' ||
							cd_serie_nf_w,1, 4000);

                        select  substr(obter_compl_historico(cd_tipo_lote_contabil_w, cd_historico_w, ds_conteudo_w),1,255)
                        into STRICT    ds_compl_historico_w
;
                end if;

                select  coalesce(max(ie_contab_tesouraria),'S')
                into STRICT    ie_contab_tesouraria_w
                from    transacao_financeira
                where   nr_sequencia    = nr_seq_trans_fin_w;

                ie_origem_documento_w   := null;
                nr_documento_ww         := null;

                ds_atributos_w  := null;

                select  CASE WHEN nr_seq_titulo_receber_w=0 THEN null  ELSE nr_seq_titulo_receber_w END ,
                        CASE WHEN nr_seq_titulo_pagar_w=0 THEN null  ELSE nr_seq_titulo_pagar_w END ,
                        CASE WHEN nr_nota_fiscal_w='0' THEN null  ELSE nr_nota_fiscal_w END ,
                        CASE WHEN nr_seq_movto_trans_fin_w=0 THEN null  ELSE nr_seq_movto_trans_fin_w END ,
                        CASE WHEN nr_seq_nota_fiscal_w=0 THEN null  ELSE nr_seq_nota_fiscal_w END ,
                        CASE WHEN nr_doc_movto_w='0' THEN null  ELSE nr_doc_movto_w END
                into STRICT    nr_seq_titulo_receber_w,
                        nr_seq_titulo_pagar_w,
                        nr_nota_fiscal_w,
                        nr_seq_movto_trans_fin_w,
                        nr_seq_nota_fiscal_w,
                        nr_doc_movto_w
;

                if (coalesce(nr_seq_nota_fiscal_w, 0) = 0) then

                        if (coalesce(nr_seq_titulo_pagar_w, 0) <> 0) then
                                nr_seq_nota_fiscal_w    := substr(obter_dados_tit_pagar(nr_seq_titulo_pagar_w, 'NFSEQ'),1,10);

                        elsif (coalesce(nr_seq_titulo_receber_w, 0) <> 0) then
                                nr_seq_nota_fiscal_w    := substr(obter_dados_titulo_receber(nr_seq_titulo_receber_w, 'SN'),1,10);
                        end if;
                end if;

                ds_atributos_w  :=      'NR_TITULO_RECEBER=' || nr_seq_titulo_receber_w || ';' ||
                                        'NR_TITULO_PAGAR=' || nr_seq_titulo_pagar_w || ';' ||
                                        'NR_NOTA_FISCAL=' || nr_nota_fiscal_w || ';' ||
                                        'NR_SEQ_MOVTO_TESOURARIA=' || nr_seq_movto_trans_fin_w || ';' ||
                                        'NR_SEQ_NOTA_FISCAL=' || nr_seq_nota_fiscal_w || ';' ||
                                        'NR_DOCUMENTO=' || nr_doc_movto_w;

                ctb_obter_doc_movto(    cd_tipo_lote_contabil_w,
                                        nm_atributo_w,
                                        'VR',
                                        dt_contabil_w,
                                        null,
                                        null,
                                        ds_atributos_w,
                                        nm_usuario_p,
                                        ie_regra_w,
                                        nr_documento_ww,
                                        ie_origem_documento_w);

                if (ie_contab_tesouraria_w = 'S') and (nm_atributo_w not in ('VL_ESPECIE_DEPOSITO','VL_CHEQUE_DEPOSITO')) and
                        (
                                (ie_caixa_w = 'M' AND ie_contab_monet_regra_w = 'N') or
                                (
                                        (ie_caixa_w = 'A') and
                                        (
                                                (ie_contab_monet_docto_w = 'S') or
                                                (
                                                        (ie_contab_monet_docto_w = 'D') and (coalesce(nr_seq_deposito_w::text, '') = '')
                                                )
                                        )
                                ) or
                                (ie_caixa_w = 'T' AND ie_contab_transf_caixa_w = 'S')
                        ) then
                        begin

                        if (ie_compl_historico_w = 'S') then       -- Edgar 29/09/2007, OS 69745, somente gerar compl_historico cadastrado
                                nr_documento_w  := substr(ds_compl_historico_w,1,255);
                        else
                                nr_documento_w  := substr(coalesce(ds_compl_historico_w, nr_documento_w),1,255);
                        end if;

                        if (ie_agrupa_w = 'S') then
                                nr_documento_w  := '';
                        end if;

                        if (coalesce(cd_historico_w::text, '') = '') then

                                CALL wheb_mensagem_pck.exibir_mensagem_abort(188207, substr( 'NR_SEQ_TRANS_FIN=' || nr_seq_trans_fin_w || ';' ||
                                                                                        'VL_TRANSACAO=' || vl_transacao_w ,1,2000));
                                /*'Erro Gerar_Contab Conta Caixa ' ||
                                        'Esta faltando o historico. Cadastre nos parametros Tesouraria ' ||
                                        nr_documento_w ||  vl_transacao_w);*/
                        end if;

                        cd_conta_contab_movto_w := cd_conta_contabil_w;


                        if (ie_caixa_w in ('A', 'T')) then                                 -- Edgar 31/10/2006 os 43549 e 43684
                                cd_conta_contab_movto_w := cd_conta_caixa_w;
                        end if;

--                      if      (cd_conta_contabil_w is null) then
                        if (coalesce(cd_conta_contab_movto_w::text, '') = '') then
                                ds_macro_w      := nr_seq_caixa_w;
                                CALL wheb_mensagem_pck.exibir_mensagem_abort(188208,'nr_seq_caixa='||ds_macro_w);
                                /*'Erro Gerar_Contab Conta Caixa ' ||
                                        'Esta faltando a conta contabil no cadastro do Caixa ' ||
                                        nr_documento_w ||  vl_transacao_w);*/
                        end if;

                        nr_seq_agrup_caixa_w    := nr_seq_agrupamento_w;
                        nr_documento_caixa_w    := substr(nr_documento_w,1,255);

                        if (ie_agrupa_lanc_caixa_dia_w = 'S') then
                                nr_seq_agrup_caixa_w            := '';
                                nr_documento_caixa_w            := '';
                        end if;

                        select  coalesce(max(nr_sequencia),0) + 1
                        into STRICT    nr_sequencia_w
                        from    w_movimento_contabil
                        where   nr_lote_contabil        = nr_lote_contabil_p;

                        insert  into w_movimento_contabil(
                                nr_lote_contabil,
                                nr_sequencia,
                                cd_conta_contabil,
                                ie_debito_credito,
                                cd_historico,
                                dt_movimento,
                                vl_movimento,
                                ds_doc_agrupamento,
                                nr_seq_agrupamento,
                                cd_centro_custo,
                                ds_compl_historico,
                                nr_seq_trans_fin,
                                nr_documento,
                                cd_pessoa_fisica,
                                cd_cgc,
                                ie_transitorio,
                                ie_origem_documento,
                                nm_tabela,
                                nr_seq_tab_orig,
                                nr_seq_tab_compl,
                                nr_seq_info,
                                nm_atributo,
                                nr_seq_proj_rec)
                        values (nr_lote_contabil_p,
                                nr_sequencia_w,
                                cd_conta_contab_movto_w,
                                ie_debito_credito_w,
                                cd_historico_w,
                                dt_contabil_w,
                                vl_transacao_w,
                                nr_seq_agrup_caixa_w,
                                nr_seq_agrup_caixa_w,
                                null,
                                nr_documento_caixa_w,
                                nr_seq_trans_fin_w,
                                nr_documento_ww,
                                cd_pessoa_fisica_w,
                                cd_cgc_w,
                                'N',
                                ie_origem_documento_w,
                                nm_tabela_w,
                                nr_seq_tab_orig_w,
                                nr_seq_tab_compl_w,
                                nr_seq_info_ctb_w,
                                nm_atributo_w,
                                nr_seq_proj_rec_w);
                        exception
                        when others then
                                ds_erro_w       := substr(sqlerrm(SQLSTATE),1,255);
                                ds_macro_w      := substr('DS_ERRO_W='||wheb_mensagem_pck.get_texto(304679,'CD_CONTA_CONTABIL_P='|| cd_conta_contabil_w ||
                                                                                                        ';NR_DOCUMENTO_P='|| nr_documento_w ||
                                                                                                        ';NR_SEQUENCIA_P='|| nr_sequencia_w ||
                                                                                                        ';NR_SEQ_TRANS_FIN_P='|| nr_seq_trans_fin_w ||
                                                                                                        ';VL_TRANSACAO_P='|| vl_transacao_w ||
                                                                                                        ';DS_ERRO_P='|| ds_erro_w ),1,1000);
                                                                /*Erro ao gerar o movimento do banco.
                                                                cd_conta_contabil:#@CD_CONTA_CONTABIL_P#@
                                                                nr_documento_w:#@NR_DOCUMENTO_P#@
                                                                nr_sequencia_w:#@NR_SEQUENCIA_P#@
                                                                Transacao Financeira:#@NR_SEQ_TRANS_FIN_P#@
                                                                Vl transacao:#@VL_TRANSACAO_P#@
                                                                Excecao:#@DS_ERRO_P#@*/
                                CALL wheb_mensagem_pck.exibir_mensagem_abort(188209,ds_macro_w);
                                /*'Erro Gerar_Contab_Trans_Financ ' ||
                                        ' cta=' || cd_conta_contabil_w || ' doc =' || nr_documento_w ||
                                        ' seq=' || nr_sequencia_w || ' trans=' || nr_seq_trans_fin_w ||
                                        ' val=' || vl_transacao_w || ds_erro_w);*/
                        end;
                end if;

                if (nm_atributo_w = 'VL_REC_PLS') then
                        if (ie_compl_hist_w = 'S') then
                                select  substr(obter_compl_historico(cd_tipo_lote_contabil_w, cd_historico_pls_w, ds_conteudo_w),1,255)
                                into STRICT    ds_compl_historico_pls_w
;
                        end if;

                        begin
                        select  max(ie_pls)
                        into STRICT    ie_pls_w
                        from    titulo_receber
                        where   nr_titulo       = nr_seq_titulo_receber_w;
                        exception
                        when others then
                                ie_pls_w        := 'N';
                        end;

                        if (ie_contab_baixas_pro_rata_w = 'A') and
                                ((dt_referencia_pls_mens_w IS NOT NULL AND dt_referencia_pls_mens_w::text <> '') or (coalesce(ie_pls_w,'N') = 'S')) then
                                nr_sequencia_w := pls_contabiliza_pro_rata(       nr_lote_contabil_p, cd_tipo_lote_contabil_w, ie_lote_pro_rata_w, dt_contab_lote_w, cd_pessoa_fisica_w, cd_cgc_w, ds_conteudo_w, nr_seq_trans_fin_w, ie_compl_hist_w, nr_seq_titulo_receber_w, nr_seq_baixa_w, nr_seq_liq_cc_w, nm_usuario_p, nr_seq_agrupamento_w, nr_sequencia_w);
                        elsif (ie_contab_baixas_pro_rata_w = 'S') and
                                ((dt_referencia_pls_mens_w IS NOT NULL AND dt_referencia_pls_mens_w::text <> '') or (coalesce(ie_pls_w,'N') = 'S')) then
                                nr_sequencia_w := pls_contabiliza_baixa_pro_rata( nr_lote_contabil_p, ie_tipo_lote_pls_w, vl_antecipacao_mens_w, dt_movimento_w, vl_transacao_w, nr_seq_titulo_receber_w, dt_contab_lote_w, cd_conta_rec_pls_w, cd_conta_deb_pls_w, cd_historico_pls_w, nr_seq_trans_fin_w, cd_pessoa_fisica_w, cd_cgc_w, nm_usuario_p, dt_referencia_pls_mens_w, ie_compl_hist_w, ds_conteudo_w, cd_tipo_lote_contabil_w, nr_seq_baixa_w, nr_seq_liq_cc_w, nr_sequencia_w);
                        else
                                if (cd_conta_deb_pls_w IS NOT NULL AND cd_conta_deb_pls_w::text <> '') and (cd_historico_pls_w IS NOT NULL AND cd_historico_pls_w::text <> '') then
                                        nr_sequencia_w  := nr_sequencia_w + 1;

                                        begin
                                        insert into w_movimento_contabil(nr_lote_contabil,
                                                nr_sequencia,
                                                cd_conta_contabil,
                                                ie_debito_credito,
                                                cd_historico,
                                                dt_movimento,
                                                vl_movimento,
                                                ds_doc_agrupamento,
                                                nr_seq_agrupamento,
                                                cd_centro_custo,
                                                ds_compl_historico,
                                                nr_seq_trans_fin,
                                                nr_documento,
                                                cd_pessoa_fisica,
                                                cd_cgc,
                                                ie_transitorio,
                                                ie_origem_documento,
                                                nm_tabela,
                                                nr_seq_tab_orig,
                                                nr_seq_tab_compl,
                                                nr_seq_info,
                                                nm_atributo,
                                                nr_seq_proj_rec)
                                        values (nr_lote_contabil_p,
                                                nr_sequencia_w,
                                                cd_conta_deb_pls_w,
                                                'C',
                                                cd_historico_pls_w,
                                                dt_contabil_w,
                                                vl_transacao_w,
                                                null,
                                                nr_seq_agrupamento_w,
                                                null,
                                                ds_compl_historico_pls_w,
                                                nr_seq_trans_fin_w,
                                                null,
                                                cd_pessoa_fisica_w,
                                                cd_cgc_w,
                                                'N',
                                                ie_origem_documento_w,
                                                nm_tabela_w,
                                                nr_seq_tab_orig_w,
                                                nr_seq_tab_compl_w,
                                                nr_seq_info_ctb_w,
                                                nm_atributo_w,
                                                nr_seq_proj_rec_w);
                                        exception when others then
                                                ds_erro_w       := substr(sqlerrm(SQLSTATE),1,255);
                                                ds_macro_w      := substr(' cta=' || cd_conta_deb_pls_w || ';' ||
                                                                        ' seq=' || nr_sequencia_w || ';' ||
                                                                        ' trans=' || nr_seq_trans_fin_w || ';' ||
                                                                        ' val=' || vl_transacao_w || ds_erro_w,1,2000);
                                                CALL wheb_mensagem_pck.exibir_mensagem_abort(188210,'ds_erro='||ds_macro_w);
                                                /*'Erro ao inserir movimento contabil ' ||
                                                                ' cta=' || cd_conta_deb_pls_w ||
                                                                ' seq=' || nr_sequencia_w || ' trans=' || nr_seq_trans_fin_w ||
                                                                ' val=' || vl_transacao_w || ds_erro_w);*/
                                        end;
                                end if;
                        end if;
                elsif (nm_atributo_w = 'VL_REC_PLS_MENS') then
                        if      ((cd_conta_deb_pls_w IS NOT NULL AND cd_conta_deb_pls_w::text <> '') or (cd_conta_rec_pls_w IS NOT NULL AND cd_conta_rec_pls_w::text <> '')) and (cd_historico_pls_w IS NOT NULL AND cd_historico_pls_w::text <> '') then
                                if (ie_compl_hist_w = 'S') then
                                        select  substr(obter_compl_historico(cd_tipo_lote_contabil_w, cd_historico_pls_w, ds_conteudo_w),1,255)
                                        into STRICT    ds_compl_historico_pls_w
;
                                end if;

                                if      ((coalesce(dt_referencia_pls_mens_w::text, '') = '') or
                                        ((dt_referencia_pls_mens_w IS NOT NULL AND dt_referencia_pls_mens_w::text <> '') and (trunc(dt_contab_lote_w, 'month') = trunc(dt_referencia_pls_mens_w, 'month')))) then
                                        nr_sequencia_w  := nr_sequencia_w + 1;

                                        begin
                                        insert  into w_movimento_contabil(nr_lote_contabil,
                                                nr_sequencia,
                                                cd_conta_contabil,
                                                ie_debito_credito,
                                                cd_historico,
                                                dt_movimento,
                                                vl_movimento,
                                                ds_doc_agrupamento,
                                                nr_seq_agrupamento,
                                                cd_centro_custo,
                                                ds_compl_historico,
                                                nr_seq_trans_fin,
                                                nr_documento,
                                                cd_pessoa_fisica,
                                                cd_cgc,
                                                ie_transitorio,
                                                ie_origem_documento,
                                                nm_tabela,
                                                nr_seq_tab_orig,
                                                nr_seq_tab_compl,
                                                nr_seq_info,
                                                nm_atributo,
                                                nr_seq_proj_rec)
                                        values (nr_lote_contabil_p,
                                                nr_sequencia_w,
                                                coalesce(cd_conta_deb_pls_w,cd_conta_rec_pls_w),
                                                CASE WHEN coalesce(cd_conta_deb_pls_w::text, '') = '' THEN 'C'  ELSE 'D' END ,
                                                cd_historico_pls_w,
                                                dt_contabil_w,
                                                vl_transacao_w,
                                                null,
                                                nr_seq_agrupamento_w,
                                                null,
                                                ds_compl_historico_pls_w,
                                                nr_seq_trans_fin_w,
                                                nr_documento_ww,
                                                cd_pessoa_fisica_w,
                                                cd_cgc_w,
                                                'N',
                                                ie_origem_documento_w,
                                                nm_tabela_w,
                                                nr_seq_tab_orig_w,
                                                nr_seq_tab_compl_w,
                                                nr_seq_info_ctb_w,
                                                nm_atributo_w,
                                                nr_seq_proj_rec_w);
                                        exception when others then
                                                ds_erro_w       := substr(sqlerrm(SQLSTATE),1,255);
                                                ds_macro_w      := substr(' cta=' || coalesce(cd_conta_deb_pls_w,cd_conta_rec_pls_w) || ';' ||
                                                                        ' seq=' || nr_sequencia_w || ';' ||
                                                                        ' trans=' || nr_seq_trans_fin_w || ';' ||
                                                                        ' val=' || vl_transacao_w || ds_erro_w,1,2000);
                                                CALL wheb_mensagem_pck.exibir_mensagem_abort(188210,'ds_erro='||ds_macro_w);
                                                /*'Erro ao inserir movimento contabil ' ||
                                                                ' cta=' || cd_conta_deb_pls_w ||
                                                                ' seq=' || nr_sequencia_w || ' trans=' || nr_seq_trans_fin_w ||
                                                                ' val=' || vl_transacao_w || ds_erro_w);*/
                                        end;
                                else
                                        update  pls_titulo_rec_liq_mens
                                        set     nr_lote_contabil        = 0
                                        where   nr_sequencia            = nr_seq_liq_cc_w
                                        and     nr_titulo               = nr_titulo_w
                                        and     nr_seq_baixa            = nr_seq_baixa_w;
                                end if;
                        end if;
                end if;

                if (ie_caixa_w = 'D') or (ie_caixa_w = 'A') or (ie_caixa_w = 'T') or           -- Edgar 31/10/2006 os 43549 e 43684
                        (ie_caixa_w = 'M' AND ie_contab_monet_regra_w = 'S') and (nm_atributo_w <> 'VL_REC_PLS') then

                        if (coalesce(nm_agrupador_w::text, '') = '') then
                                if (ie_agrupa_w = 'S') then
                                        nr_documento_w          := '';
                                elsif (ie_agrupa_w = 'L') then
                                        nr_seq_agrupamento_w    := nr_seq_lote_w;
                                elsif (ie_agrupa_w = 'C') then
                                        nr_seq_agrupamento_w    := nr_seq_lote_w||nr_seq_caixa_w;
                                end if;
                        end if;

                        if (ie_permite_estab_dif_w <> 'PCCT') then
                                cd_estab_movto_w        := null;
                        end if;

                        if (coalesce(nr_seq_conta_banco_w,0) = 0) then
                                if (nr_seq_deposito_w IS NOT NULL AND nr_seq_deposito_w::text <> '') then
                                        select  max(nr_conta)
                                        into STRICT    nr_seq_conta_banco_w
                                        from    deposito
                                        where   nr_sequencia    = nr_seq_deposito_w;
                                end if;
                        end if;

                        if (coalesce(nr_seq_titulo_receber_w,0) <> 0) then

                                select  max(ie_origem_titulo)
                                into STRICT    ie_origem_titulo_w
                                from    titulo_receber
                                where   nr_titulo       = nr_seq_titulo_receber_w;
                        end if;

                        ie_origem_documento_w   := null;
                        nr_documento_ww         := null;

                        ds_atributos_w  := null;

                        select  CASE WHEN nr_seq_titulo_receber_w=0 THEN null  ELSE nr_seq_titulo_receber_w END ,
                                CASE WHEN nr_seq_titulo_pagar_w=0 THEN null  ELSE nr_seq_titulo_pagar_w END ,
                                CASE WHEN nr_nota_fiscal_w='0' THEN null  ELSE nr_nota_fiscal_w END ,
                                CASE WHEN nr_seq_movto_trans_fin_w=0 THEN null  ELSE nr_seq_movto_trans_fin_w END ,
                                CASE WHEN nr_seq_nota_fiscal_w=0 THEN null  ELSE nr_seq_nota_fiscal_w END ,
                                CASE WHEN nr_doc_movto_w='0' THEN null  ELSE nr_doc_movto_w END
                        into STRICT    nr_seq_titulo_receber_w,
                                nr_seq_titulo_pagar_w,
                                nr_nota_fiscal_w,
                                nr_seq_movto_trans_fin_w,
                                nr_seq_nota_fiscal_w,
                                nr_doc_movto_w
;

                        if (coalesce(nr_seq_nota_fiscal_w, 0) = 0) then
                                if (coalesce(nr_seq_titulo_pagar_w, 0) <> 0) then
                                        nr_seq_nota_fiscal_w    := substr(obter_dados_tit_pagar(nr_seq_titulo_pagar_w, 'NFSEQ'),1,10);

                                elsif (coalesce(nr_seq_titulo_receber_w, 0) <> 0) then
                                        nr_seq_nota_fiscal_w    := substr(obter_dados_titulo_receber(nr_seq_titulo_receber_w, 'SN'),1,10);
                                end if;
                        end if;

                        ds_atributos_w  :=      'NR_TITULO_RECEBER=' || nr_seq_titulo_receber_w || ';' ||
                                                'NR_TITULO_PAGAR=' || nr_seq_titulo_pagar_w || ';' ||
                                                'NR_NOTA_FISCAL=' || nr_nota_fiscal_w || ';' ||
                                                'NR_SEQ_MOVTO_TESOURARIA=' || nr_seq_movto_trans_fin_w || ';' ||
                                                'NR_SEQ_NOTA_FISCAL=' || nr_seq_nota_fiscal_w || ';' ||
                                                'NR_DOCUMENTO=' || nr_doc_movto_w;
                        ctb_obter_doc_movto(    cd_tipo_lote_contabil_w,
                                                nm_atributo_w,
                                                'VR',
                                                dt_contabil_w,
                                                null,
                                                null,
                                                ds_atributos_w,
                                                nm_usuario_p,
                                                ie_regra_w,
                                                nr_documento_ww,
                                                ie_origem_documento_w);
                        nr_sequencia_w := gerar_contab_trans_financ(      cd_estabelecimento_w, cd_estab_movto_w, nr_lote_contabil_p, nm_usuario_p, cd_conta_contabil_w, cd_centro_custo_w, nr_documento_w, nr_seq_agrupamento_w, dt_contabil_w, vl_transacao_w, nr_seq_trans_fin_w, nr_seq_conta_banco_w, nm_atributo_w, cd_pessoa_fisica_w, cd_cgc_w, 0, cd_convenio_w, nr_documento_ww, cd_historico_movto_w, ds_conteudo_w, nr_seq_caixa_w, nr_seq_produto_w, nr_seq_caixa_od_w, null, nr_seq_titulo_pagar_w, nr_seq_bandeira_w, null, ie_origem_titulo_w, nr_seq_conta_banco_w, null, null, cd_estab_inf_movto_w, cd_tipo_baixa_w, cd_tipo_recebimento_w, nr_sequencia_w, nm_tabela_w, nr_seq_titulo_receber_w, nr_seq_proj_rec_w, ie_origem_documento_w, nr_seq_tab_orig_w, nr_seq_tab_compl_w, nr_seq_info_ctb_w, cd_moeda_w, null);

                        select  coalesce(CASE WHEN coalesce(nr_seq_titulo_pagar_w,0)=0 THEN null  ELSE nr_seq_titulo_pagar_w END ,
                                        CASE WHEN coalesce(nr_seq_titulo_receber_w,0)=0 THEN null  ELSE nr_seq_titulo_receber_w END )
                        into STRICT    nr_titulo_w
;

                        if      ((ie_contab_cr_w = 'S') or (ie_contab_cp_w = 'S')) and (ie_permite_estab_dif_w = 'PCCT') and (coalesce(cd_estab_movto_w,0) <> 0) and (nr_titulo_w IS NOT NULL AND nr_titulo_w::text <> '') and (cd_conta_transitoria_w IS NOT NULL AND cd_conta_transitoria_w::text <> '') and (cd_estab_movto_w <> cd_estabelecimento_w) then

                                  nr_lote_contabil_p := ctb_gerar_movto_conta_transit(  nr_lote_contabil_p, cd_estabelecimento_w, cd_conta_transitoria_w, cd_historico_ct_w);


                                  nr_lote_contabil_p := ctb_gerar_movto_conta_transit(  nr_lote_contabil_p, cd_estab_movto_w, cd_conta_transitoria_w, cd_historico_ct_w);
                        end if;

                        if (nm_atributo_w = 'VL_TRANSACAO') and (ie_permite_estab_dif_w = 'PCCT') and (cd_conta_transitoria_w IS NOT NULL AND cd_conta_transitoria_w::text <> '') and (nr_seq_caixa_od_w IS NOT NULL AND nr_seq_caixa_od_w::text <> '') and (cd_estab_caixa_od_w <> cd_estabelecimento_w) then

                                if (ie_saldo_caixa_w = 'E') then /* Entrada do caixa credita transitoria e debita caixa*/
                                        ie_debito_credito_w     := 'C';
                                elsif (ie_saldo_caixa_w = 'S') then /* Saida do caixa debita transitoria e credita caixa*/
                                        ie_debito_credito_w     := 'D';
                                end if;

                                select  substr(obter_compl_historico(cd_tipo_lote_contabil_w, cd_historico_ct_w, ds_conteudo_w),1,255)
                                into STRICT    ds_compl_historico_w
;

                                  nr_lote_contabil_p := ctb_gerar_movto_conta_transit(  nr_lote_contabil_p, cd_estab_caixa_od_w, cd_conta_transitoria_w, cd_historico_ct_w);

                                /*IF ( ie_debito_credito_w = 'C') THEN
                                        ie_debito_credito_w:= 'D';
                                ELSE
                                        ie_debito_credito_w:= 'C';
                                END IF;
                                ctb_gerar_movto_conta_transit(  nr_lote_contabil_p,
                                                                cd_estabelecimento_w,
                                                                cd_conta_transitoria_w,
                                                                cd_historico_ct_w,
                                                                ds_conteudo_w,
                                                                null,
                                                                dt_contabil_w,
                                                                vl_transacao_w,
                                                                ie_debito_credito_w,
                                                                ie_origem_documento_w,
                                                                nr_seq_agrupamento_w,
                                                                nr_sequencia_w);*/
                        end if;
                end if;

                if (qt_contador_w >= 100) then
                        qt_contador_w := 0;
                        commit;
                end if;
        end loop;
        close c010;
        /* Francisco - 03/05/2010 - OS 203923 */


        /*pls_contabiliza_baixa_antec(nr_lote_contabil_p,nm_usuario_p);*/

        if (pkg_i18n.get_user_locale = 'es_BO' AND ie_exclusao_p = 'N') then
                BEGIN
                        CALL ctb_regras_contabil.ctb_gerar_cd_controle_tesour(nr_lote_contabil_p, nm_usuario_p);
                EXCEPTION WHEN OTHERS THEN
                        CALL ctb_gravar_log_lote(nr_lote_contabil_p, 1, SQLERRM, nm_usuario_p);
                END;
        end if;

        CALL agrupa_movimento_contabil(nr_lote_contabil_p, nm_usuario_p);
end if;

if (coalesce(ds_retorno_p::text, '') = '') then
        update  lote_contabil
        set     ie_situacao             = 'A',
                dt_geracao_lote         = clock_timestamp()
        where   nr_lote_contabil        = nr_lote_contabil_p;

        if (ie_exclusao_p = 'S') then
                ds_retorno_p            := wheb_mensagem_pck.get_texto(165188);

                CALL ctb_gravar_log_lote(    nr_lote_contabil_p,
                                        2,
                                        '',
                                        nm_usuario_p);
        else
                ds_retorno_p            := wheb_mensagem_pck.get_texto(165187);

                CALL ctb_gravar_log_lote(    nr_lote_contabil_p,
                                        1,
                                        '',
                                        nm_usuario_p);
        end if;

        commit;
else
        rollback;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE contabiliza_tesouraria ( nr_lote_contabil_p bigint, nm_usuario_p text, ie_exclusao_p text, ds_retorno_p INOUT text) FROM PUBLIC;

