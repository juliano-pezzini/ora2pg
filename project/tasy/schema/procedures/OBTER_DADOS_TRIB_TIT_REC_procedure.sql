-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE obter_dados_trib_tit_rec ( cd_tributo_p bigint, cd_estabelecimento_p bigint, cd_convenio_p bigint, dt_referencia_p timestamp, ie_ato_cooperado_p text, pr_aliquota_p INOUT bigint, vl_minimo_base_p INOUT bigint, vl_minimo_tributo_p INOUT bigint, ie_acumulativo_p INOUT text, vl_teto_base_p INOUT bigint, vl_desc_dependente_p INOUT bigint, cd_pessoa_fisica_p text, cd_cgc_p text, ie_tipo_contrato_ops_p text, ie_origem_titulo_p text, nr_seq_item_serv_p bigint, nr_seq_regra_p INOUT bigint, cd_darf_p INOUT text, nr_seq_nota_p bigint default null, nr_item_nf_p bigint default null, cd_operacao_nf_p bigint default null, cd_natureza_operacao_p bigint default null) AS $body$
DECLARE


ie_acumulativo_w		varchar(255);
cd_municipio_ibge_w	varchar(255);
sg_estado_w		varchar(255);
ie_tipo_tributacao_w	pessoa_juridica.ie_tipo_tributacao%type;
ie_tipo_pessoa_w		varchar(2)	:= 'A';
vl_minimo_base_w		double precision:= 0;
vl_minimo_tributo_w		double precision:= 0;
vl_teto_base_calculo_w	double precision:= 0;
vl_desc_dependente_w	double precision:= 0;
cd_perfil_ativo_w		bigint;
cd_tipo_pj_w		bigint;
pr_aliquota_w		double precision:= null;
nr_seq_regra_w		bigint;
nr_seq_nat_juridica_w	bigint;
cd_procedimento_w	procedimento.cd_procedimento%type;
cd_area_procedimento_w	especialidade_proc.cd_area_procedimento%type;
cd_especialidade_w	grupo_proc.cd_especialidade%type;
cd_grupo_proc_w		grupo_proc.cd_grupo_proc%type;
cd_material_w		bigint;
cd_grupo_material_w	bigint;
cd_subgrupo_material_w	bigint;
cd_classe_material_w	bigint;
ie_regime_iva_w	  	pessoa_juridica.ie_regime_iva%type;
ie_fiscales_w     	pj_tipo_tributacao_hist.ie_tipo_tributacao%type;

cd_retencao_w		tributo.cd_retencao%type;
cd_darf_w		regra_calculo_imposto.cd_darf%type;

C01 CURSOR FOR
	SELECT		pr_imposto,
			vl_minimo_base_calculo,
			vl_minimo_tributo,
			ie_acumulativo,
			vl_teto_base_calculo,
			vl_desc_dependente,
			nr_sequencia,
			cd_darf
	from		regra_calculo_imposto
	where		cd_tributo = cd_tributo_p
	and (coalesce(cd_estabelecimento, cd_estabelecimento_p) = cd_estabelecimento_p)
	and		dt_referencia_p >= dt_vigencia
	and		fim_dia(coalesce(dt_fim_vigencia, dt_referencia_p)) >= dt_referencia_p
	and		coalesce(ie_nota_fiscal, 'N') = 'S'
	and		coalesce(cd_perfil, cd_perfil_ativo_w) 			= cd_perfil_ativo_w
	and		coalesce(ie_ato_cooperado, 'N') 				= ie_ato_cooperado_p
	and		coalesce(cd_municipio_ibge, coalesce(cd_municipio_ibge_w, '0')) 	= coalesce(cd_municipio_ibge_w, '0')
	and		coalesce(sg_estado, coalesce(sg_estado_w, '0')) 			= coalesce(sg_estado_w, '0')
	and		coalesce(nr_seq_nat_juridica, coalesce(nr_seq_nat_juridica_w, 0))	= coalesce(nr_seq_nat_juridica_w, 0)
	and		coalesce(ie_tipo_tributacao, coalesce(ie_tipo_tributacao_w, '0'))	= coalesce(ie_tipo_tributacao_w, '0')
	and		coalesce(ie_tipo_contrato, coalesce(ie_tipo_contrato_ops_p, '0'))	= coalesce(ie_tipo_contrato_ops_p, '0')
	and		coalesce(ie_origem_titulo, coalesce(ie_origem_titulo_p, '0'))		= coalesce(ie_origem_titulo_p, '0')
	and		((coalesce(ie_tipo_pessoa, 'A') = 'A') or (coalesce(ie_tipo_pessoa, 'A') 	= coalesce(ie_tipo_pessoa_w, 'A')))
	and		coalesce(nr_seq_item_serv, coalesce(nr_seq_item_serv_p, 0)) 		= coalesce(nr_seq_item_serv_p, 0)		
	and (coalesce(cd_tipo_pj, coalesce(cd_tipo_pj_w, 0)) 			= coalesce(cd_tipo_pj_w, 0) or (coalesce(cd_tipo_pj, coalesce(cd_tipo_pj_w, 0)) 			in (SELECT	cd_tipo_pessoa
														from	pessoa_jur_tipo_adic
														where	cd_cgc	= cd_cgc_p)))
	and		(((coalesce(cd_cgc::text, '') = '') and (coalesce(cd_pessoa_fisica::text, '') = '')) or
			((cd_cgc = cd_cgc_p) and (coalesce(cd_pessoa_fisica::text, '') = '')) or
			((cd_pessoa_fisica = cd_pessoa_fisica_p) and (coalesce(cd_cgc::text, '') = '')))
	and		((coalesce(cd_convenio, coalesce(cd_convenio_p, 0)) = coalesce(cd_convenio_p, 0)) 	or (cd_cgc = cd_cgc_p))
	and		coalesce(cd_area_procedimento, coalesce(cd_area_procedimento_w, 0))	= coalesce(cd_area_procedimento_w, 0)
	and		coalesce(cd_especialidade, coalesce(cd_especialidade_w, 0))			= coalesce(cd_especialidade_w, 0)	
	and		coalesce(cd_grupo_proc, coalesce(cd_grupo_proc_w, 0)) 			= coalesce(cd_grupo_proc_w, 0)		
	and		coalesce(cd_procedimento, coalesce(cd_procedimento_w, 0)) 			= coalesce(cd_procedimento_w, 0)
	and		coalesce(cd_grupo_material, coalesce(cd_grupo_material_w, 0))		= coalesce(cd_grupo_material_w, 0)	
	and		coalesce(cd_subgrupo_material, coalesce(cd_subgrupo_material_w, 0))		= coalesce(cd_subgrupo_material_w, 0)
	and		coalesce(cd_classe_material, coalesce(cd_classe_material_w, 0))  		= coalesce(cd_classe_material_w, 0)	
	and		coalesce(cd_material, coalesce(cd_material_w, 0)) 			   	= coalesce(cd_material_w, 0)
	and		COALESCE(ie_regime_iva, ie_regime_iva_w, '0') = COALESCE(ie_regime_iva_w, '0')
	and		((coalesce(ie_fiscales::text, '') = '') or (OBTER_PJ_TRIBUTACAO_VIGENTE(cd_cgc,ie_fiscales) = 'S'))
	and		((coalesce(cd_operacao_nf::text, '') = '') or (cd_operacao_nf = cd_operacao_nf_p))
	and		((coalesce(cd_natureza_operacao::text, '') = '') or (cd_natureza_operacao = cd_natureza_operacao_p))
	order by		cd_convenio,
			cd_pessoa_fisica,
			cd_cgc,
			cd_area_procedimento,
			cd_especialidade,
			cd_grupo_proc,
			cd_procedimento,
			cd_grupo_material,
			cd_subgrupo_material,
			cd_classe_material,
			cd_material,
			cd_estabelecimento,
			cd_municipio_ibge;				

/* Francisco - OS 83651 - 04/03/2008 - Inclu? tratamento para a pessoa f?sica e jur?dica */

BEGIN

cd_perfil_ativo_w := obter_perfil_ativo;

if (cd_cgc_p IS NOT NULL AND cd_cgc_p::text <> '') then
	ie_tipo_pessoa_w := 'PJ';
	
	select	max(cd_tipo_pessoa),
		max(cd_municipio_ibge),
		max(sg_estado),
		max(nr_seq_nat_juridica),
		max(ie_tipo_tributacao),
		max(ie_regime_iva)
	into STRICT	cd_tipo_pj_w,
		cd_municipio_ibge_w,
		sg_estado_w,
		nr_seq_nat_juridica_w,
		ie_tipo_tributacao_w,
		ie_regime_iva_w
	from	pessoa_juridica
	where	cd_cgc	= cd_cgc_p;
	
elsif (cd_pessoa_fisica_p IS NOT NULL AND cd_pessoa_fisica_p::text <> '') then
	ie_tipo_pessoa_w := 'PF';
	
	begin
		select  coalesce(sg_estado, '0')
		into STRICT    sg_estado_w
		from    compl_pessoa_fisica
		where   cd_pessoa_fisica = cd_pessoa_fisica_p
		and 	ie_tipo_complemento = 1  LIMIT 1;
	exception when others then
		sg_estado_w := '0';
	end;
end if;

if (nr_seq_nota_p IS NOT NULL AND nr_seq_nota_p::text <> '' AND nr_item_nf_p IS NOT NULL AND nr_item_nf_p::text <> '') then
	select	max(v.cd_procedimento),
		max(v.cd_area_procedimento),
		max(v.cd_especialidade),
		max(v.cd_grupo_proc)
	into STRICT	cd_procedimento_w,
		cd_area_procedimento_w,
		cd_especialidade_w,
		cd_grupo_proc_w
	from	estrutura_procedimento_v v,
		nota_fiscal_item i
	where	v.cd_procedimento	= i.cd_procedimento
	and	(i.cd_procedimento IS NOT NULL AND i.cd_procedimento::text <> '')
	and 	i.nr_item_nf = nr_item_nf_p
	and 	i.nr_sequencia = nr_seq_nota_p;
end if;

if (nr_seq_nota_p IS NOT NULL AND nr_seq_nota_p::text <> '' AND nr_item_nf_p IS NOT NULL AND nr_item_nf_p::text <> '') then
	select	max(v.cd_grupo_material),
		max(v.cd_subgrupo_material),
		max(v.cd_classe_material),
		max(v.cd_material)
	into STRICT	cd_grupo_material_w,
		cd_subgrupo_material_w,
		cd_classe_material_w,
		cd_material_w
	from	estrutura_material_v v,
		nota_fiscal_item i
	where	v.cd_material	= i.cd_material
	and	(i.cd_material IS NOT NULL AND i.cd_material::text <> '')
	and 	i.nr_item_nf = nr_item_nf_p
	and 	i.nr_sequencia = nr_seq_nota_p;
end if;

select	coalesce(max(cd_retencao),'')
into STRICT	cd_retencao_w
from	tributo
where	cd_tributo = cd_tributo_p;
				
open C01;
loop
fetch C01 into
	pr_aliquota_w,
	vl_minimo_base_w,
	vl_minimo_tributo_w,
	ie_acumulativo_w,
	vl_teto_base_calculo_w,
	vl_desc_dependente_w,
	nr_seq_regra_w,
	cd_darf_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	pr_aliquota_p		:= pr_aliquota_w;
	vl_minimo_base_p		:= vl_minimo_base_w;
	vl_minimo_tributo_p		:= vl_minimo_tributo_w;
	ie_acumulativo_p		:= ie_acumulativo_w;
	vl_teto_base_p		:= vl_teto_base_calculo_w;
	vl_desc_dependente_p	:= vl_desc_dependente_w;
	nr_seq_regra_p		:= nr_seq_regra_w;
	
	select  cd_darf
	into STRICT  cd_darf_w
	from  regra_calculo_imposto
	where  nr_sequencia  = nr_seq_regra_w;
	
	cd_darf_p := coalesce(cd_retencao_w, cd_darf_w);

	exit;
end loop;
close C01;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE obter_dados_trib_tit_rec ( cd_tributo_p bigint, cd_estabelecimento_p bigint, cd_convenio_p bigint, dt_referencia_p timestamp, ie_ato_cooperado_p text, pr_aliquota_p INOUT bigint, vl_minimo_base_p INOUT bigint, vl_minimo_tributo_p INOUT bigint, ie_acumulativo_p INOUT text, vl_teto_base_p INOUT bigint, vl_desc_dependente_p INOUT bigint, cd_pessoa_fisica_p text, cd_cgc_p text, ie_tipo_contrato_ops_p text, ie_origem_titulo_p text, nr_seq_item_serv_p bigint, nr_seq_regra_p INOUT bigint, cd_darf_p INOUT text, nr_seq_nota_p bigint default null, nr_item_nf_p bigint default null, cd_operacao_nf_p bigint default null, cd_natureza_operacao_p bigint default null) FROM PUBLIC;

