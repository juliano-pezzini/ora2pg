-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE obter_evento_usuario_proc (nm_usuario_p text, ie_filtra_exames_p text, ds_retorno_p INOUT text) AS $body$
DECLARE

 
/*Coloquei o parametro ie_filtra_exames_p para o parametro 8 do Tasymon, mas 
 pode ser utilizado futuramente caso tenha outra filtragem por usuário.*/
 
 
ds_resultado_w		varchar(4000);
ie_tipo_evento_w		integer;
cd_setor_usuario_w		integer;
ds_tipo_evento_w		varchar(40);
cd_pessoa_usuario_w		varchar(10);
cd_evento_w			varchar(30);
nm_medico_w			varchar(80);
ds_evento_w			varchar(2000);
dt_evento_w			timestamp;
nr_min_comunic_w		bigint;
nr_seq_aprovacao_w		bigint;
cd_cargo_w			bigint;

ie_tipo_aprov_w		varchar(01);
nr_seq_ord_sol_w		bigint;
nr_seq_item_w			bigint;
vl_material_w			double precision;
qt_material_w			double precision;
dt_aprovacao_w		timestamp;
ds_material_w			varchar(255);
nm_solic_w			varchar(255);
dt_liberacao_w		timestamp;
nr_seq_proc_aprov_W		bigint;
ie_etapa_w			varchar(2);
cd_estabelecimento_w		smallint;

ie_evento_agenda_w		varchar(001);
ie_evento_sac_w		varchar(001);
ie_evento_processo_w		varchar(001);
ie_evento_prescr_w		varchar(001);
ie_evento_procage_w		varchar(001);
ie_evento_comunic_w		varchar(001);
ie_evento_alerta_w		varchar(001);
ie_evento_aprovacao_w	varchar(001);
ie_evento_exame_urg_w	varchar(001);
ie_evento_hemo_w	varchar(001);
ie_evento_lib_telefone_w	varchar(001);
ie_evento_ordem_serv_w		varchar(001);
ie_evento_obj_inv_w		varchar(001);
ie_evento_recoleta_w		varchar(001);
ie_evento_susp_exame_w		varchar(001);
ie_grupo_ordem_serv_w		varchar(1)	:= 'N';

/* Eventos do TasyMon 
	0 - Convite da agenda 
	1 - Alarme da agenda 
	2 - Eventos do SAC, 
	3 - Processos pendentes 
	4 - Prescrições incorretas 
	5 - Processo Agenda 
	6 - Comunicação Interna 
	7 - Alertas do tasy - qualidade 
	10 - Exames urgentes 
	11 - Bloqueio/Liberação de telefones 
	12 - Ordem Serviço 
	13 - Objetos inválidos no sistema 
	14 - Exames para recoleta 
	15 - Prescrições suspensas 
*/
 
 
C01 CURSOR FOR 
	SELECT	0 ie_tipo_evento, 
		wheb_mensagem_pck.get_texto(802758) ds_tipo_evento, 
		to_char(a.nr_sequencia) cd_evento, 
		wheb_mensagem_pck.get_texto(802759) || ' ' || a.nm_usuario || ': ' || a.ds_agenda ds_evento, 
		'' nm_medico, 
		a.dt_agenda dt_evento 
	from	agenda_tasy_convite b, 
		agenda_tasy a 
	where	a.nr_sequencia		= b.nr_seq_agenda 
	and	b.nm_usuario_convidado	= nm_usuario_p 
	and	a.dt_agenda		>= trunc(clock_timestamp()) 
	and	coalesce(b.dt_confirmacao::text, '') = '' 
	and	ie_evento_agenda_w	= 'S' 
	
union
 
	SELECT	1 ie_tipo_evento, 
		c.ds_tipo_agenda ds_tipo_evento, 
		to_char(a.nr_sequencia) cd_evento, 
		a.ds_agenda ds_evento, 
		'' nm_medico, 
		a.dt_agenda dt_evento 
	from	tipo_agenda_tasy c, 
		agenda_tasy_alarme b, 
		agenda_tasy a 
	where	a.nr_seq_tipo		= b.nr_seq_tipo 
	and	a.ie_status		= 'M' 
	and	a.dt_agenda		between trunc(clock_timestamp()) and trunc(clock_timestamp()) + b.qt_tempo 
	and	a.nm_usuario_agenda	= b.nm_usuario_agenda 
	and	a.nm_usuario_agenda	= nm_usuario_p 
	and	b.nr_seq_tipo		= c.nr_sequencia 
	and	b.ie_unid_tempo		= 'D' 
	and	ie_evento_agenda_w	= 'S' 
	
union all
 
	select	1 ie_tipo_evento, 
		c.ds_tipo_agenda ds_tipo_evento, 
		to_char(a.nr_sequencia) cd_evento, 
		a.ds_agenda ds_evento, 
		'' nm_medico, 
		a.dt_agenda dt_evento 
	from	tipo_agenda_tasy c, 
		agenda_tasy_alarme b, 
		agenda_tasy a 
	where	a.nr_seq_tipo		= b.nr_seq_tipo 
	and	a.ie_status		= 'M' 
	and	a.dt_agenda		between trunc(clock_timestamp()) and clock_timestamp() + (b.qt_tempo / 1440) 
	and	a.nm_usuario_agenda	= b.nm_usuario_agenda 
	and	a.nm_usuario_agenda	= nm_usuario_p 
	and	b.nr_seq_tipo		= c.nr_sequencia 
	and	b.ie_unid_tempo		= 'M' 
	and	ie_evento_agenda_w	= 'S' 
	
union all
 
	select	2 ie_tipo_evento, 
    		wheb_mensagem_pck.get_texto(802762) ds_tipo_evento, 
		to_char(b.nr_sequencia) cd_evento, 
		' ' ds_evento, 
		'' nm_medico, 
		clock_timestamp() dt_evento 
	from	sac_resp_bol_ocor b 
	where (Obter_dados_sac_resp(b.nr_seq_responsavel,nm_usuario_p,'E') = 'S') 
	and	coalesce(b.dt_usuario_ciente::text, '') = '' 
	and	b.ie_status = 'A' 
	and	ie_evento_sac_w		= 'S' 
	
union all
 
	select	3 ie_tipo_evento, 
		wheb_mensagem_pck.get_texto(802763) ds_tipo_evento, 
		to_char(a.nr_atendimento) || ',' || 
		to_char(a.cd_processo) || ',' || 
		to_char(a.nr_sequencia) cd_evento, 
	   to_char(a.nr_atendimento) || ' - ' || 
		obter_nome_pessoa_fisica(t.cd_pessoa_fisica, null) || ' - ' || 
		obter_unidade_atendimento(t.nr_atendimento, 'A', 'SU') ds_evento, 
		'' nm_medico, 
		coalesce(a.dt_fim_prev,clock_timestamp()) dt_evento 
	FROM	PROCESSO_ETAPA B, 
		PROCESSO_ATENDIMENTO A, 
		ATENDIMENTO_PACIENTE T 
	WHERE a.NR_ATENDIMENTO  = T.NR_ATENDIMENTO 
	 AND A.CD_PROCESSO   = B.CD_PROCESSO 
	 AND A.NR_SEQUENCIA   = B.NR_SEQUENCIA 
	 AND T.IE_FIM_CONTA   <> 'F' 
	 AND A.IE_STATUS		= 'P' 
	 AND coalesce(A.DT_FIM_REAL::text, '') = '' 
	 AND A.NM_USUARIO_RESP = nm_usuario_p 
	and	ie_evento_processo_w	= 'S' 
	
union all
 
	select	3 ie_tipo_evento, 
		wheb_mensagem_pck.get_texto(802763) ds_tipo_evento, 
		to_char(a.nr_atendimento) || ',' || 
		to_char(a.cd_processo) || ',' || 
		to_char(a.nr_sequencia) cd_evento, 
	   to_char(a.nr_atendimento) || ' - ' || 
		obter_nome_pessoa_fisica(t.cd_pessoa_fisica, null) || ' - ' || 
		obter_unidade_atendimento(t.nr_atendimento, 'A', 'SU') ds_evento, 
		'' nm_medico, 
		coalesce(a.dt_fim_prev,clock_timestamp()) dt_evento 
	FROM	PROCESSO_ETAPA B, 
		PROCESSO_ATENDIMENTO A, 
		ATENDIMENTO_PACIENTE T 
	WHERE a.NR_ATENDIMENTO  = T.NR_ATENDIMENTO 
	AND A.CD_PROCESSO   = B.CD_PROCESSO 
	 AND A.NR_SEQUENCIA   = B.NR_SEQUENCIA 
	 AND T.IE_FIM_CONTA   <> 'F' 
	 AND A.IE_STATUS		= 'P' 
	 AND coalesce(A.DT_FIM_REAL::text, '') = '' 
	 AND A.CD_SETOR_RESP  = cd_setor_usuario_w 
	and	ie_evento_processo_w	= 'S' 
	
union all
 
	select	3 ie_tipo_evento, 
		wheb_mensagem_pck.get_texto(802763) ds_tipo_evento, 
		to_char(a.nr_atendimento) || ',' || 
		to_char(a.cd_processo) || ',' || 
		to_char(a.nr_sequencia) cd_evento, 
	   to_char(a.nr_atendimento) || ' - ' || 
		obter_nome_pessoa_fisica(t.cd_pessoa_fisica, null) || ' - ' || 
		obter_unidade_atendimento(t.nr_atendimento, 'A', 'SU') ds_evento, 
		'' nm_medico, 
		coalesce(a.dt_fim_prev,clock_timestamp()) dt_evento 
	FROM	PROCESSO_ETAPA B, 
		PROCESSO_ATENDIMENTO A, 
		ATENDIMENTO_PACIENTE T 
	WHERE a.NR_ATENDIMENTO  = T.NR_ATENDIMENTO 
	 AND A.CD_PROCESSO   = B.CD_PROCESSO 
	 AND A.NR_SEQUENCIA   = B.NR_SEQUENCIA 
	 AND T.IE_FIM_CONTA   <> 'F' 
	 AND A.IE_STATUS		= 'P' 
	 AND coalesce(A.DT_FIM_REAL::text, '') = '' 
	 AND A.CD_PESSOA_FISICA_RESP = cd_pessoa_usuario_w 
	and	ie_evento_processo_w	= 'S' 
	
union all
 
	select 	4 ie_tipo_evento, 
		wheb_mensagem_pck.get_texto(802765) ds_tipo_evento, 
		b.nr_prescricao || ',' || b.nr_sequencia cd_evento, 
		b.nr_prescricao || ' - ' || 
		obter_nome_pessoa_fisica(a.cd_pessoa_fisica, null) || ' - ' || 
		Obter_Descricao_Procedimento( 
			b.cd_procedimento, b.ie_origem_proced) || ' - ' || 
		b.ds_integracao ds_evento, 
		obter_nome_pessoa_fisica(a.cd_medico, null) nm_medico, 
		a.dt_prescricao dt_evento 
	from	prescr_procedimento b, prescr_medica a 
	where 	a.nr_prescricao	= b.nr_prescricao 
	 and 	a.cd_medico		<> cd_pessoa_usuario_w 
	 and	a.nm_usuario_original	= nm_usuario_p 
	 and	b.cd_motivo_baixa = 0 
	 and 	(b.dt_integracao IS NOT NULL AND b.dt_integracao::text <> '') 
	and	ie_evento_prescr_w	= 'S' 
	
union all
 
	select 	4 ie_tipo_evento, 
		wheb_mensagem_pck.get_texto(802765) ds_tipo_evento, 
		b.nr_prescricao || ',' || b.nr_sequencia cd_evento, 
		b.nr_prescricao || ' - ' || 
		obter_nome_pessoa_fisica(a.cd_pessoa_fisica, null) || ' - ' || 
		Obter_Descricao_Procedimento( 
			b.cd_procedimento, b.ie_origem_proced) || ' - ' || 
		b.ds_integracao ds_evento, 
		obter_nome_pessoa_fisica(a.cd_medico, null) nm_medico, 
		a.dt_prescricao dt_evento 
	from	prescr_procedimento b, prescr_medica a 
	where 	a.nr_prescricao	= b.nr_prescricao 
	 and 	b.cd_setor_atendimento	= cd_setor_usuario_w 
	 and 	a.cd_medico		<> cd_pessoa_usuario_w 
	 and	b.cd_motivo_baixa = 0 
	 and 	(b.dt_integracao IS NOT NULL AND b.dt_integracao::text <> '') 
	and	ie_evento_prescr_w	= 'S' 
	
union all
 
	select 	 /*+ index (PRESPRO_I2 b) */ 
		4 ie_tipo_evento, 
		wheb_mensagem_pck.get_texto(802765) ds_tipo_evento, 
		b.nr_prescricao || ',' || b.nr_sequencia cd_evento, 
		b.nr_prescricao || ' - ' || 
		obter_nome_pessoa_fisica(a.cd_pessoa_fisica, null) || ' - ' || 
		Obter_Descricao_Procedimento( 
			b.cd_procedimento, b.ie_origem_proced) || ' - ' || 
		b.ds_integracao ds_evento, 
		obter_nome_pessoa_fisica(a.cd_medico, null) nm_medico, 
		a.dt_prescricao dt_evento 
	from	prescr_procedimento b, prescr_medica a 
	where 	a.nr_prescricao		= b.nr_prescricao 
	 and 	a.cd_medico		= cd_pessoa_usuario_w 
	 and	b.cd_motivo_baixa = 0 
	 and 	(b.dt_integracao IS NOT NULL AND b.dt_integracao::text <> '') 
	and	ie_evento_prescr_w	= 'S' 
	
union all
 
	select	5 ie_tipo_evento, 
		wheb_mensagem_pck.get_texto(802766) ds_tipo_evento, 
		to_char(a.nr_seq_agenda) || ',' || 
		to_char(a.cd_processo) || ',' || 
		to_char(a.nr_seq_etapa) cd_evento, 
	   	to_char(a.nr_seq_agenda) || ' - ' || 
		obter_nome_pessoa_fisica(t.cd_pessoa_fisica, null) || ' - ' ||  
		obter_unidade_atendimento(t.nr_atendimento, 'A', 'SU') ds_evento, 
		'' nm_medico, 
		a.dt_fim_prev dt_evento 
	FROM	PROCESSO_ETAPA B, 
		agenda_pac_processo A, 
		agenda_paciente T 
	WHERE a.NR_seq_agenda  = T.NR_sequencia 
	 AND A.CD_PROCESSO   = B.CD_PROCESSO 
	 AND A.NR_SEQ_etapa   = B.NR_SEQUENCIA 
	 AND A.IE_STATUS	 = 'P' 
	 AND A.NM_USUARIO_RESP = nm_usuario_p 
	 AND coalesce(A.DT_FIM_REAL::text, '') = '' 
	and	ie_evento_procage_w	= 'S' 
	
union all
 
	select	5 ie_tipo_evento, 
		wheb_mensagem_pck.get_texto(802766) ds_tipo_evento, 
		to_char(a.nr_seq_agenda) || ',' || 
		to_char(a.cd_processo) || ',' || 
		to_char(a.nr_seq_etapa) cd_evento, 
	   	to_char(a.nr_seq_agenda) || ' - ' || 
		obter_nome_pessoa_fisica(t.cd_pessoa_fisica, null) || ' - ' || 
		obter_unidade_atendimento(t.nr_atendimento, 'A', 'SU') ds_evento, 
		'' nm_medico, 
		a.dt_fim_prev dt_evento 
	FROM	PROCESSO_ETAPA B, 
		agenda_pac_processo A, 
		agenda_paciente T 
	WHERE a.NR_seq_agenda  = T.NR_sequencia 
	 AND A.CD_PROCESSO   = B.CD_PROCESSO 
	 AND A.NR_SEQ_etapa   = B.NR_SEQUENCIA 
	 AND A.IE_STATUS	= 'P' 
	 AND A.CD_SETOR_RESP  = cd_setor_usuario_w 
	 AND coalesce(A.DT_FIM_REAL::text, '') = '' 
	and	ie_evento_procage_w	= 'S' 
	
union all
 
	select	5 ie_tipo_evento, 
		wheb_mensagem_pck.get_texto(802766) ds_tipo_evento, 
		to_char(a.nr_seq_agenda) || ',' || 
		to_char(a.cd_processo) || ',' || 
		to_char(a.nr_seq_etapa) cd_evento, 
	   	to_char(a.nr_seq_agenda) || ' - ' || 
		obter_nome_pessoa_fisica(t.cd_pessoa_fisica, null) || ' - ' || 
		obter_unidade_atendimento(t.nr_atendimento, 'A', 'SU') ds_evento, 
		'' nm_medico, 
		a.dt_fim_prev dt_evento 
	FROM	PROCESSO_ETAPA B, 
		agenda_pac_processo A, 
		agenda_paciente T 
	WHERE a.NR_seq_agenda  = T.NR_sequencia 
	 AND A.CD_PROCESSO   = B.CD_PROCESSO 
	 AND A.NR_SEQ_etapa   = B.NR_SEQUENCIA 
	 AND A.IE_STATUS	 = 'P' 
	 AND coalesce(A.DT_FIM_REAL::text, '') = '' 
	 AND A.CD_PESSOA_FISICA_RESP = cd_pessoa_usuario_w 
	and	ie_evento_procage_w	= 'S' 
	
union all
 
	select	6 ie_tipo_evento, 
		wheb_mensagem_pck.get_texto(802768) ds_tipo_evento, 
		to_char(a.nr_sequencia) cd_evento, 
	   	a.ds_titulo || ' (' || wheb_mensagem_pck.get_texto(802769) || ' ' || obter_pessoa_fisica_usuario(a.nm_usuario,'D') || ')' ds_evento, 
		'' nm_medico, 
		a.dt_comunicado dt_evento 
	FROM	comunic_interna a 
	WHERE 	a.dt_comunicado >= (clock_timestamp() - (nr_min_comunic_w / 1440)) 
	and	nr_min_comunic_w > 0 
	and	obter_se_comunic_interna_lida(a.nr_sequencia, nm_usuario_p) = 'N' 
	and	obter_se_mostra_comunic(a.nr_sequencia, nm_usuario_p, 'N', 'N', 0) = 'S' 
	and	ie_evento_comunic_w	= 'S' 
	and	(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '') 
	
union all
 
	select	7 ie_tipo_evento, 
		wheb_mensagem_pck.get_texto(802770) ds_tipo_evento, 
		to_char(a.nr_sequencia) cd_evento, 
	   	b.nm_alerta ds_evento, 
		'' nm_medico, 
		a.dt_alerta dt_evento 
	FROM	alerta_tasy b, 
		alerta_tasy_ocor a 
	WHERE 	a.nr_seq_alerta		= b.nr_sequencia 
	and	a.nm_usuario_alertado	= nm_usuario_p 
	and	a.ie_usuario_ciente	= 'N' 
	and	ie_evento_alerta_w	= 'S' 
	
union all
 
	select	10 ie_tipo_evento, 
		wheb_mensagem_pck.get_texto(802771) ds_tipo_evento, 
		to_char(b.nr_prescricao) || ',' || to_char(b.nr_sequencia) cd_evento, 
		wheb_mensagem_pck.get_texto(798800) || ': ' || c.nm_exame || ' ' || wheb_mensagem_pck.get_texto(791350) || ': ' || 
		substr(obter_pessoa_atendimento(a.nr_atendimento, 'N'),1,100) || 
		' ' || wheb_mensagem_pck.get_texto(802772) || ' ' || to_char(a.nr_controle) || 
		' ' || wheb_mensagem_pck.get_texto(802773) || ': ' || b.ds_observacao ds_evento, 
		'' nm_medico, 
		a.dt_prescricao dt_evento 
	from	exame_laboratorio c, 
		prescr_procedimento b, 
		prescr_medica a 
	where 	a.nr_prescricao	= b.nr_prescricao 
	and 	b.nr_seq_exame	= c.nr_seq_exame 
	and 	a.dt_prescricao > clock_timestamp() - interval '43200 seconds' 
	and	b.ie_urgencia	 = 'S' 
	and	ie_evento_exame_urg_w = 'S' 
	and 	not exists 
		(select 1 
		from 	prescr_proc_ciente x 
		where 	x.nr_prescricao = b.nr_prescricao 
		and 	x.nr_seq_prescr = b.nr_sequencia 
		and	((ie_filtra_exames_p = 'S' and x.nm_usuario = nm_usuario_p) or (ie_filtra_exames_p = 'N'))) 
	
union all
 
	select	10 ie_tipo_evento, 
		wheb_mensagem_pck.get_texto(802775) ds_tipo_evento, 
		to_char(b.nr_prescricao) || ',' || to_char(b.nr_sequencia) cd_evento, 
		replace(wheb_mensagem_pck.get_texto(802776) || substr(Obter_desc_san_derivado(b.nr_seq_derivado),1,50) || ' ' || wheb_mensagem_pck.get_texto(791350) || ': ' || 
		substr(obter_pessoa_atendimento(a.nr_atendimento, 'N'),1,100) || 
		' ' || wheb_mensagem_pck.get_texto(802772) || ' ' || to_char(a.nr_controle) || 
		' ' || wheb_mensagem_pck.get_texto(802773) || ': ' || b.ds_observacao, chr(10), '') ds_evento, 
		'' nm_medico, 
		a.dt_prescricao dt_evento 
	from	prescr_procedimento b, 
		prescr_medica a 
	where 	a.nr_prescricao	= b.nr_prescricao 
	and		(b.nr_seq_derivado IS NOT NULL AND b.nr_seq_derivado::text <> '') 
	and 	a.dt_prescricao > clock_timestamp() - interval '43200 seconds' 
	and	ie_evento_hemo_w = 'S' 
	and 	not exists 
		(select 1 
		from 	prescr_proc_ciente x 
		where 	x.nr_prescricao = b.nr_prescricao 
		and 	x.nr_seq_prescr = b.nr_sequencia 
		and	((ie_filtra_exames_p = 'S' and x.nm_usuario = nm_usuario_p) or (ie_filtra_exames_p = 'N'))) 
	
union all
 
	select	11 ie_tipo_evento, 
		wheb_mensagem_pck.get_texto(802777) ds_tipo_evento, 
		substr(nr_sequencia,1,10) cd_evento, 
		wheb_mensagem_pck.get_texto(802781) || '(' || substr(nr_ramal,1,20) || ') ' || 
		wheb_mensagem_pck.get_texto(796345) || ' ' || substr(obter_nome_setor(cd_setor_atendimento),1,100) || ' - ' || 
		wheb_mensagem_pck.get_texto(795798) || ': ' || cd_unidade_basica || ' ' || cd_unidade_compl ds_evento, 
		'' nm_medico, 
		dt_evento dt_evento 
	from	tel_reg_evento 
	where	coalesce(dt_realizacao::text, '') = '' 
	and	nr_seq_acao	= 16 
	and	nr_seq_evento	= 10 
	and	ie_evento_lib_telefone_w = 'S' 
	
union all
 
	select	11 ie_tipo_evento, 
		wheb_mensagem_pck.get_texto(802782) ds_tipo_evento, 
		substr(nr_sequencia,1,10) cd_evento, 
		wheb_mensagem_pck.get_texto(802783) || '(' || substr(nr_ramal,1,20) || ') ' || 
		wheb_mensagem_pck.get_texto(796345) || ' ' || substr(obter_nome_setor(cd_setor_atendimento),1,100) || ' - ' || 
		wheb_mensagem_pck.get_texto(795798) || ': ' || cd_unidade_basica || ' ' || cd_unidade_compl ds_evento, 
		'' nm_medico, 
		dt_evento dt_evento 
	from	tel_reg_evento 
	where	coalesce(dt_realizacao::text, '') = '' 
	and	nr_seq_acao	= 16 
	and	nr_seq_evento	= 12 
	and	ie_evento_lib_telefone_w = 'S' 
	
union all
 
	select	12 ie_tipo_evento, 
		wheb_mensagem_pck.get_texto(802784) ds_tipo_evento, 
		to_char(a.nr_sequencia) cd_evento, 
		'OS Nº: ' || a.nr_sequencia || 
		' - ' || wheb_mensagem_pck.get_texto(802785) || ' '|| substr(obter_descricao_padrao('MAN_LOCALIZACAO','DS_LOCALIZACAO',a.nr_seq_localizacao),1,80) || 
		' - ' || wheb_mensagem_pck.get_texto(802787) || ' '|| substr(obter_nome_pessoa_fisica(a.cd_pessoa_solicitante, null),1,60) || 
		' - ' || wheb_mensagem_pck.get_texto(802788) || ' '|| a.ds_dano_breve ds_evento, 
		'' nm_medico, 
		a.dt_ordem_servico dt_evento 
	FROM man_ordem_servico a
LEFT OUTER JOIN man_ordem_servico_exec b ON (a.nr_sequencia = b.nr_seq_ordem)
WHERE ((b.nm_usuario_exec = nm_usuario_p) or (obter_se_usuario_grupo_trab(a.nr_grupo_trabalho,nm_usuario_p) = 'S' and ie_grupo_ordem_serv_w = 'S')) and a.dt_ordem_servico > clock_timestamp() - interval '43200 seconds' and coalesce(b.dt_ult_visao::text, '') = '' and (((coalesce(b.nr_sequencia::text, '') = '' and ie_grupo_ordem_serv_w = 'S') or (b.nm_usuario_exec = nm_usuario_p)) or ie_grupo_ordem_serv_w = 'N') and ie_evento_ordem_serv_w = 'S' 
	 
union all
 
	select	12 ie_tipo_evento, 
		wheb_mensagem_pck.get_texto(802784) ds_tipo_evento, 
		to_char(a.nr_sequencia) cd_evento, 
		'OS Nº: ' || a.nr_sequencia || 
		' - ' || wheb_mensagem_pck.get_texto(802785) || ' '|| substr(obter_descricao_padrao('MAN_LOCALIZACAO','DS_LOCALIZACAO',a.nr_seq_localizacao),1,80) || 
		' - ' || wheb_mensagem_pck.get_texto(802787) || ' '|| substr(obter_nome_pessoa_fisica(a.cd_pessoa_solicitante, null),1,60) || 
		' - ' || wheb_mensagem_pck.get_texto(802788) || ' '|| a.ds_dano_breve ds_evento, 
		'' nm_medico, 
		a.dt_reabertura dt_evento 
	FROM man_ordem_servico a
LEFT OUTER JOIN man_ordem_servico_exec b ON (a.nr_sequencia = b.nr_seq_ordem)
WHERE ((b.nm_usuario_exec = nm_usuario_p) or (obter_se_usuario_grupo_trab(a.nr_grupo_trabalho,nm_usuario_p) = 'S' and ie_grupo_ordem_serv_w = 'S')) and a.dt_reabertura > clock_timestamp() - interval '43200 seconds' and coalesce(b.dt_ult_visao::text, '') = '' and (((coalesce(b.nr_sequencia::text, '') = '' and ie_grupo_ordem_serv_w = 'S') or (b.nm_usuario_exec = nm_usuario_p)) or ie_grupo_ordem_serv_w = 'N') and ie_evento_ordem_serv_w = 'S' 
	 
union all
 
	select	12 ie_tipo_evento, 
		wheb_mensagem_pck.get_texto(802791) ds_tipo_evento, 
		to_char(a.nr_sequencia) cd_evento, 
		'OS Nº: ' || a.nr_sequencia || 
		' - ' || wheb_mensagem_pck.get_texto(802785) || ' '|| substr(obter_descricao_padrao('MAN_LOCALIZACAO','DS_LOCALIZACAO',a.nr_seq_localizacao),1,80) || 
		' - ' || wheb_mensagem_pck.get_texto(802787) || ' '|| substr(obter_nome_pessoa_fisica(a.cd_pessoa_solicitante, null),1,60) || 
		' - ' || wheb_mensagem_pck.get_texto(802788) || ' '|| a.ds_dano_breve ds_evento, 
		'' nm_medico, 
		c.dt_historico dt_evento 
	FROM man_ordem_serv_tecnico c, man_ordem_servico a
LEFT OUTER JOIN man_ordem_servico_exec b ON (a.nr_sequencia = b.nr_seq_ordem)
WHERE a.nr_sequencia = c.nr_seq_ordem_serv and ((b.nm_usuario_exec = nm_usuario_p) or (obter_se_usuario_grupo_trab(a.nr_grupo_trabalho,nm_usuario_p) = 'S' and ie_grupo_ordem_serv_w = 'S')) and c.dt_historico > clock_timestamp() - interval '43200 seconds' and coalesce(b.dt_ult_visao,to_date('01/01/1910','dd/mm/yyyy')) < c.dt_historico and (((coalesce(b.nr_sequencia::text, '') = '' and ie_grupo_ordem_serv_w = 'S') or (b.nm_usuario_exec = nm_usuario_p)) or ie_grupo_ordem_serv_w = 'N') and ie_evento_ordem_serv_w = 'S' 
	 
union all
 
	select	12 ie_tipo_evento, 
		wheb_mensagem_pck.get_texto(802793) ds_tipo_evento, 
		to_char(a.nr_sequencia) cd_evento, 
		'OS Nº: ' || a.nr_sequencia || 
		' - ' || wheb_mensagem_pck.get_texto(802785) || ' '|| substr(obter_descricao_padrao('MAN_LOCALIZACAO','DS_LOCALIZACAO',a.nr_seq_localizacao),1,80) || 
		' - ' || wheb_mensagem_pck.get_texto(802787) || ' '|| substr(obter_nome_pessoa_fisica(a.cd_pessoa_solicitante, null),1,60) || 
		' - ' || wheb_mensagem_pck.get_texto(802788) || ' '|| a.ds_dano_breve ds_evento, 
		'' nm_medico, 
		a.dt_ordem_servico dt_evento 
	FROM man_ordem_servico a
LEFT OUTER JOIN man_ordem_servico_exec b ON (a.nr_sequencia = b.nr_seq_ordem)
WHERE ((b.nm_usuario_exec = nm_usuario_p) or (obter_se_usuario_grupo_planej(a.nr_grupo_planej,nm_usuario_p) = 'S')) and a.dt_ordem_servico > clock_timestamp() - interval '43200 seconds' and coalesce(b.dt_ult_visao::text, '') = '' and ie_evento_ordem_serv_w = 'P' 
	 
union all
 
	select	12 ie_tipo_evento, 
		wheb_mensagem_pck.get_texto(802793) ds_tipo_evento, 
		to_char(a.nr_sequencia) cd_evento, 
		'OS Nº: ' || a.nr_sequencia || 
		' - ' || wheb_mensagem_pck.get_texto(802785) || ' '|| substr(obter_descricao_padrao('MAN_LOCALIZACAO','DS_LOCALIZACAO',a.nr_seq_localizacao),1,80) || 
		' - ' || wheb_mensagem_pck.get_texto(802787) || ' '|| substr(obter_nome_pessoa_fisica(a.cd_pessoa_solicitante, null),1,60) || 
		' - ' || wheb_mensagem_pck.get_texto(802788) || ' '|| a.ds_dano_breve ds_evento, 
		'' nm_medico, 
		a.dt_reabertura dt_evento 
	FROM man_ordem_servico a
LEFT OUTER JOIN man_ordem_servico_exec b ON (a.nr_sequencia = b.nr_seq_ordem)
WHERE ((b.nm_usuario_exec = nm_usuario_p) or (obter_se_usuario_grupo_planej(a.nr_grupo_planej,nm_usuario_p) = 'S')) and a.dt_reabertura > clock_timestamp() - interval '43200 seconds' and coalesce(b.dt_ult_visao::text, '') = '' and ie_evento_ordem_serv_w = 'P' 
	 
union all
 
	select	12 ie_tipo_evento, 
		wheb_mensagem_pck.get_texto(802791) ds_tipo_evento, 
		to_char(a.nr_sequencia) cd_evento, 
		'OS Nº: ' || a.nr_sequencia || 
		' - ' || wheb_mensagem_pck.get_texto(802785) || ' '|| substr(obter_descricao_padrao('MAN_LOCALIZACAO','DS_LOCALIZACAO',a.nr_seq_localizacao),1,80) || 
		' - ' || wheb_mensagem_pck.get_texto(802787) || ' '|| substr(obter_nome_pessoa_fisica(a.cd_pessoa_solicitante, null),1,60) || 
		' - ' || wheb_mensagem_pck.get_texto(802788) || ' '|| a.ds_dano_breve ds_evento, 
		'' nm_medico, 
		c.dt_historico dt_evento 
	FROM man_ordem_serv_tecnico c, man_ordem_servico a
LEFT OUTER JOIN man_ordem_servico_exec b ON (a.nr_sequencia = b.nr_seq_ordem)
WHERE a.nr_sequencia = c.nr_seq_ordem_serv and ((b.nm_usuario_exec = nm_usuario_p) or (obter_se_usuario_grupo_planej(a.nr_grupo_planej,nm_usuario_p) = 'S')) and c.dt_historico > clock_timestamp() - interval '43200 seconds' and coalesce(b.dt_ult_visao,to_date('01/01/1910','dd/mm/yyyy')) < c.dt_historico and ie_evento_ordem_serv_w = 'P' 
	 
union all
 
	select	13 ie_tipo_evento, 
		wheb_mensagem_pck.get_texto(802822) ds_tipo_evento, 
		to_char(0) cd_evento, 
		wheb_mensagem_pck.get_texto(802824, 'QT_OBJETOS_W='||count(*)) ds_evento, 
		'' nm_medico, 
		clock_timestamp() dt_evento 
	from	objetos_invalidos_v 
	where	ie_evento_obj_inv_w = 'S' 
	having	count(*) > 0 
	
union all
 
	select	14 ie_tipo_evento, 
		wheb_mensagem_pck.get_texto(802840) ds_tipo_evento, 
		to_char(0) cd_evento, 
		wheb_mensagem_pck.get_texto(802844) || a.nr_prescricao || 
		' - ' || wheb_mensagem_pck.get_texto(791350) || ': ' || substr(obter_nome_pf(b.cd_pessoa_fisica),1,60) || 
		CASE WHEN coalesce(obter_telefone_pf(b.cd_pessoa_fisica,1)::text, '') = '' THEN ''  ELSE ' - ' || wheb_mensagem_pck.get_texto(802839) || ' ' || obter_telefone_pf(b.cd_pessoa_fisica,1) END  || 
		' - ' || wheb_mensagem_pck.get_texto(795984) || ': ' || c.ds_motivo_recoleta ds_evento, 
		substr(obter_nome_medico(b.cd_medico,'N'),1,60) nm_medico, 
		a.dt_atualizacao dt_evento 
	from	lab_motivo_recoleta c, 
		prescr_medica b, 
		prescr_procedimento a 
	where	a.nr_prescricao		= b.nr_prescricao 
	and	a.nr_seq_recoleta	= c.nr_sequencia 
	and	(ie_etapa_w < (select	max(x.ie_etapa) 
				from	prescr_proc_etapa x 
				where	x.nr_seq_prescricao	= a.nr_sequencia 
				and	x.nr_prescricao		= a.nr_prescricao)) 
	and	a.dt_atualizacao > clock_timestamp() - interval '43200 seconds' 
	and	a.ie_status_atend	= ie_etapa_w	 
	and	ie_evento_recoleta_w	= 'S' 
	
union all
 
	select	15 ie_tipo_evento, 
		wheb_mensagem_pck.get_texto(802841) ds_tipo_evento, 
		to_char(a.nr_prescricao) || ',' || to_char(a.nr_sequencia) cd_evento, 
		wheb_mensagem_pck.get_texto(802844) || a.nr_prescricao || 
		' - ' || wheb_mensagem_pck.get_texto(791350) || ': ' || substr(obter_nome_pf(b.cd_pessoa_fisica),1,60) || 
		' - ' || wheb_mensagem_pck.get_texto(798800) || ': ' || substr(obter_desc_exame(a.nr_seq_exame),1,250) ds_evento, 
		substr(obter_nome_medico(b.cd_medico,'N'),1,60) nm_medico, 
		a.dt_atualizacao dt_evento 
	from	prescr_medica b, 
		prescr_procedimento a 
	where	a.nr_prescricao		= b.nr_prescricao 
	and	(a.nr_seq_exame IS NOT NULL AND a.nr_seq_exame::text <> '') 
	and	a.dt_atualizacao > clock_timestamp() - interval '43200 seconds' 
	and	a.ie_suspenso		= 'S' 
	and	ie_evento_susp_exame_w	= 'S' 
	and 	not exists 
		(select 1 
		from 	prescr_proc_ciente x 
		where 	x.nr_prescricao = a.nr_prescricao 
		and 	x.nr_seq_prescr = a.nr_sequencia 
		and	((ie_filtra_exames_p = 'S' and x.nm_usuario = nm_usuario_p) or (ie_filtra_exames_p = 'N')));
		
c02 CURSOR FOR 
	SELECT	distinct nr_sequencia, 
			 nr_seq_proc_aprov 
	from processo_aprov_compra 
	where cd_pessoa_fisica = cd_pessoa_usuario_w 
	  or cd_cargo = cd_cargo_w 
	 and ie_aprov_reprov = 'P' 
	 and (dt_liberacao IS NOT NULL AND dt_liberacao::text <> '') 
	and	ie_evento_aprovacao_w = 'S' 
	
union all
 
	SELECT distinct nr_sequencia, 
			nr_seq_proc_aprov 
	from processo_aprov_compra 
	where cd_cargo    in 
	   (select x.cd_cargo 
	   from pessoa_fisica x, 
    	  pessoa_fisica_Delegacao y 
	   where x.cd_pessoa_fisica = y.cd_pessoa_fisica 
    	and (x.cd_cargo IS NOT NULL AND x.cd_cargo::text <> '') 
	    and ((coalesce(trunc(y.dt_inicio_limite),trunc(clock_timestamp())) <= trunc(clock_timestamp())) and (trunc(y.dt_limite) >= trunc(clock_timestamp()))) 
    	and y.cd_pessoa_substituta = cd_pessoa_usuario_w 
		and coalesce(y.ie_objetivo,'AC') in ('AC','AA')) 
	and ie_aprov_reprov = 'P' 
	and (dt_liberacao IS NOT NULL AND dt_liberacao::text <> '') 
	and	ie_evento_aprovacao_w = 'S' 
	order by 1;

c03 CURSOR FOR 
	SELECT 'O' ie_tipo_aprov, 
		o.nr_ordem_compra nr_sequencia, 
	    o.nr_item_oci nr_seq_item, 
	    o.vl_unitario_material vl_material, 
	    o.qt_material, 
	    o.dt_aprovacao, 
	    m.ds_material, 
	    substr(obter_nome_pessoa_fisica(coalesce(o.cd_pessoa_solicitante,p.cd_pessoa_solicitante), null),1,200) nm_solicitante, 
	    s.dt_liberacao dt_liberacao_solic 
	FROM ordem_compra p, material m, ordem_compra_item o
LEFT OUTER JOIN solic_compra s ON (o.nr_solic_compra = s.nr_solic_compra)
WHERE m.cd_material   = o.cd_material and o.nr_ordem_compra = p.nr_ordem_compra and o.nr_seq_aprovacao = nr_seq_aprovacao_w  
union
 
	SELECT 'S' ie_tipo_aprov, 
		o.nr_solic_compra nr_sequencia, 
	    o.nr_item_solic_compra nr_seq_item, 
	    coalesce(o.vl_unit_previsto,0) vl_material, 
	    o.qt_material, 
	    o.dt_autorizacao dt_aprovacao, 
	    m.ds_material, 
	    substr(obter_nome_pessoa_fisica(p.cd_pessoa_solicitante, null),1,200) nm_solicitante, 
	    p.dt_liberacao dt_liberacao_solic 
	from  solic_compra_item o, 
	    solic_compra p, 
	    material m 
	where m.cd_material = o.cd_material 
	 and o.nr_solic_compra = p.nr_solic_compra 
	 and o.nr_seq_aprovacao = nr_seq_aprovacao_w 
	order by 2;

	 

BEGIN 
 
select	coalesce(max(coalesce(vl_parametro, vl_parametro_padrao)),0) 
into STRICT	nr_min_comunic_w 
from	funcao_parametro 
where	cd_funcao	= 5001 
and	nr_sequencia	= 1;
 
select	coalesce(max(vl_parametro), nr_min_comunic_w) 
into STRICT	nr_min_comunic_w 
from	funcao_param_usuario 
where	cd_funcao	= 5001 
and	nr_sequencia	= 1 
and	nm_usuario	= nm_usuario_p;
 
select	ie_evento_agenda, 
	ie_evento_sac, 
	ie_evento_processo, 
	ie_evento_prescr, 
	ie_evento_proc_agenda, 
	ie_evento_comunic, 
	ie_evento_alerta, 
	ie_evento_aprov_compra, 
	ie_evento_exame_urg, 
	ie_evento_lib_telefone, 
	ie_evento_ordem_serv, 
	ie_evento_obj_inv, 
	ie_evento_recoleta, 
	ie_evento_susp_exame, 
	coalesce(ie_evento_hemo,'N') 
into STRICT	ie_evento_agenda_w, 
	ie_evento_sac_w, 
	ie_evento_processo_w, 
	ie_evento_prescr_w, 
	ie_evento_procage_w, 
	ie_evento_comunic_w, 
	ie_evento_alerta_w, 
	ie_evento_aprovacao_w, 
	ie_evento_exame_urg_w, 
	ie_evento_lib_telefone_w, 
	ie_evento_ordem_serv_w, 
	ie_evento_obj_inv_w, 
	ie_evento_recoleta_w, 
	ie_evento_susp_exame_w, 
	ie_evento_hemo_w 
from	usuario 
where	nm_usuario	= nm_usuario_p;
 
select	a.cd_setor_atendimento, 
	a.cd_pessoa_fisica,	 
	b.cd_cargo 
into STRICT	cd_setor_usuario_w, 
	cd_pessoa_usuario_w, 
	cd_cargo_w 
FROM usuario a
LEFT OUTER JOIN pessoa_fisica b ON (a.cd_pessoa_fisica = b.cd_pessoa_fisica)
WHERE a.nm_usuario		= nm_usuario_p;
 
select	cd_estabelecimento 
into STRICT	cd_estabelecimento_w 
from	usuario 
where	nm_usuario	= nm_usuario_p;
 
ie_etapa_w := obter_param_usuario(722, 12, null, nm_usuario_p, cd_estabelecimento_w, ie_etapa_w);
 
/*select	nvl(obter_valor_param_usuario(5001,15,obter_perfil_ativo,nm_usuario_p,cd_estabelecimento_w),'N') 
into	ie_grupo_ordem_serv_w 
from	dual;*/
 
ie_grupo_ordem_serv_w := coalesce(obter_valor_param_usuario(5001,15,obter_perfil_ativo,nm_usuario_p,cd_estabelecimento_w),'N');
 
Open	c01;
Loop 
Fetch	c01 into 
	ie_tipo_evento_w, 
	ds_tipo_evento_w, 
	cd_evento_w, 
	ds_evento_w, 
	nm_medico_w, 
	dt_evento_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	begin 
	if (coalesce(ds_resultado_w::text, '') = '') or (length(ds_resultado_w) < 3500) then 
		ds_resultado_w			:= ds_resultado_w ||	ie_tipo_evento_w || ';' || 
								ds_tipo_evento_w || ';' || 
								cd_evento_w || ';' || 
							 	ds_evento_w || ';' || 
								nm_medico_w || ';' || 
 								to_char(dt_evento_w, 'dd/mm/yyyy hh24:mi:ss') || chr(10);
	end if;
								 
	end;
end loop;
close c01;
 
open	c02;
loop 
fetch	c02 into nr_seq_aprovacao_w, 
		 nr_seq_proc_aprov_w;
EXIT WHEN NOT FOUND; /* apply on c02 */
	begin 
 
	open	c03;
	loop 
	fetch	c03 into 
		ie_tipo_aprov_w, 
		nr_seq_ord_sol_w, 
		nr_seq_item_w, 
		vl_material_w, 
		qt_material_w, 
		dt_aprovacao_w, 
		ds_material_w, 
		nm_solic_w, 
		dt_liberacao_w;		
	EXIT WHEN NOT FOUND; /* apply on c03 */
		begin 
	 
		if (coalesce(ds_resultado_w::text, '') = '') or (length(ds_resultado_w) < 3500) then 
			begin 
			if (ie_tipo_aprov_w = 'O') then 
				ds_resultado_w	:= ds_resultado_w ||	 
							wheb_mensagem_pck.get_texto(802848) || nr_seq_ord_sol_w ||';' || 
							nr_seq_aprovacao_w || ',' || nr_seq_proc_aprov_w || ';' || 
							' ' || wheb_mensagem_pck.get_texto(798501) || ': ' || ds_material_W || ' ' || wheb_mensagem_pck.get_texto(802847) || ' '|| campo_mascara(vl_material_w, 2) || 
							' ' || wheb_mensagem_pck.get_texto(799261) || ': ' || campo_mascara(qt_material_w,2) || 
							' ' || wheb_mensagem_pck.get_texto(802787) || ' ' || nm_solic_w ||';;' || 
							to_char(dt_aprovacao_w, pkg_date_formaters.localize_mask('timestamp', pkg_date_formaters.getUserLanguageTag(wheb_usuario_pck.get_cd_estabelecimento, wheb_usuario_pck.get_nm_usuario))) || ';' || chr(10);
			else 
				ds_resultado_w	:= ds_resultado_w ||	 
							wheb_mensagem_pck.get_texto(802849) || nr_seq_ord_sol_w ||';' || 
							nr_seq_aprovacao_w || ',' || nr_seq_proc_aprov_w || ';' || 
							' ' || wheb_mensagem_pck.get_texto(798501) || ': ' || ds_material_W || ' '|| wheb_mensagem_pck.get_texto(802847) || ' '|| campo_mascara(vl_material_w, 2) || 
							' ' || wheb_mensagem_pck.get_texto(799261) || ': ' || campo_mascara(qt_material_w,2) || 
							' ' || wheb_mensagem_pck.get_texto(802787) || ' ' || nm_solic_w ||';;' || 
							to_char(dt_aprovacao_w, pkg_date_formaters.localize_mask('timestamp', pkg_date_formaters.getUserLanguageTag(wheb_usuario_pck.get_cd_estabelecimento, wheb_usuario_pck.get_nm_usuario))) || ';' || chr(10);
			end if;
 
			end;
		end if;
		end;
	end loop;
	close c03;
	end;
end loop;
close c02;
 
ds_retorno_p	:= substr(ds_resultado_w,1,2000);
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE obter_evento_usuario_proc (nm_usuario_p text, ie_filtra_exames_p text, ds_retorno_p INOUT text) FROM PUBLIC;

