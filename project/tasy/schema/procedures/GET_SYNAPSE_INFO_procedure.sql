-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE get_synapse_info ( nr_prescricao_p bigint, nr_seq_prescricao_p bigint, ds_pasta_exp_xml_p INOUT text, ds_nome_arquivo_p INOUT text, ie_integrar_p INOUT bigint) AS $body$
DECLARE


nr_seq_sistema_integr_w	smallint;
ie_integrar_w		varchar(1) := 'N';
ds_pasta_exp_xml_w	varchar(255);
ds_nome_arquivo_w	varchar(255);
ie_duplic_proced_lado_w varchar(1) := 'N';
cd_estabelecimento_w empresa_integr_dados.cd_estabelecimento%TYPE := 0;


BEGIN
if (nr_prescricao_p IS NOT NULL AND nr_prescricao_p::text <> '')
then begin

	ie_integrar_w := verifica_se_integra_sinapse(nr_prescricao_p);
	
	if (ie_integrar_w = 'S') then
		begin
		
	   select max(cd_estabelecimento)
		 into STRICT cd_estabelecimento_w
		 FROM PRESCR_MEDICA
		where nr_prescricao = nr_prescricao_p;
		
		select	MAX(nr_seq_empresa_integr)
		into STRICT	nr_seq_sistema_integr_w
		from	empresa_integr_dados
		where (nr_seq_empresa_integr = 31 or nr_seq_empresa_integr = 41 or nr_seq_empresa_integr = 106 or  nr_seq_empresa_integr = 232)
		and 	coalesce(cd_estabelecimento, cd_estabelecimento_w) = cd_estabelecimento_w;

		if (nr_seq_sistema_integr_w IS NOT NULL AND nr_seq_sistema_integr_w::text <> '') then
			begin
			select	max(a.ds_caminho_saida)
			into STRICT	ds_pasta_exp_xml_w
			from	empresa_integr_dados a,
				empresa_integracao b,
				sistema_integracao c
			where	a.nr_seq_empresa_integr	= b.nr_sequencia
			and	b.nr_sequencia		= c.nr_seq_empresa
			and	b.nr_sequencia		= nr_seq_sistema_integr_w;
			
			select max(a.nr_prescricao||'_'||TO_CHAR(b.dt_prescricao,'yyyymmdd')||'_'||TO_CHAR(b.dt_prescricao,'hhmiss')|| nr_seq_prescricao_p ||'.xml') ds
			into STRICT	ds_nome_arquivo_w
			from 	prescr_procedimento a,
				prescr_medica b
			where	a.nr_prescricao = nr_prescricao_p
			and	a.nr_prescricao = b.nr_prescricao;
			end;
		end if;
		end;
	end if;
	end;
end if;
commit;
ds_pasta_exp_xml_p	:= ds_pasta_exp_xml_w;
ds_nome_arquivo_p	:= ds_nome_arquivo_w;
ie_integrar_p		:= nr_seq_sistema_integr_w;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE get_synapse_info ( nr_prescricao_p bigint, nr_seq_prescricao_p bigint, ds_pasta_exp_xml_p INOUT text, ds_nome_arquivo_p INOUT text, ie_integrar_p INOUT bigint) FROM PUBLIC;

