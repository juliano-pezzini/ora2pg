-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE register_version_track ( cd_customer_id_p text, nm_customer_p text, ie_production_p text, ds_environment_p text, cd_version_p text, nr_service_pack_p bigint, ie_process_p text, ds_locale_p text, ds_application_p text, nm_usuario_p text, ds_country_p text default null, ds_state_p text default null, ds_city_p text default null, ds_address_p text default null, nr_phone_p text default null) AS $body$
DECLARE


nr_version_udi_w		tasy_version_udi.nr_sequencia%type;
ie_regulated_market_w	tasy_version_track.ie_regulated_market%type;
ds_country_w			tasy_version_track.ds_country%type;
ds_state_w				tasy_version_track.ds_state%type;
ds_city_w				tasy_version_track.ds_city%type;
ds_address_w			tasy_version_track.ds_address%type;
nr_phone_w				tasy_version_track.nr_phone%type;
nr_service_pack_w		tasy_version_udi.nr_service_pack%type;
ie_migration_w			tasy_version_track.ie_migration%type;
													

BEGIN			
	ds_country_w := substr(ds_country_p, 1, 255);			
	ds_state_w := substr(ds_state_p, 1, 255);	
	ds_city_w := substr(ds_city_p, 1, 255);
	ds_address_w := substr(ds_address_p, 1, 4000);	
	nr_phone_w := substr(nr_phone_p, 1, 100);
	
	ie_regulated_market_w := 'N';	

	nr_service_pack_w := nr_service_pack_p;	
	if (nr_service_pack_w < 0) then
		select  max(nr_service_pack)
		into STRICT    nr_service_pack_w
		from    man_service_pack_versao
		where   cd_versao = cd_version_p
		and     nr_old_build = nr_service_pack_w;
		if (coalesce(nr_service_pack_w::text, '') = '') then
			nr_service_pack_w := nr_service_pack_p;
		end if;
	end if;

	select	max(nr_sequencia) -- Used max to avoid no_data_found and multiple_rows
	into STRICT	nr_version_udi_w
	from	tasy_version_udi
	where	cd_version = cd_version_p
	and		nr_service_pack = nr_service_pack_w;
	
	select	max(ie_migracao)
	into STRICT	ie_migration_w
	from	com_cliente
	where	cd_cnpj = cd_customer_id_p
	and		ie_situacao = 'A';
			
	if (ds_locale_p = 'de_DE' or ds_locale_p = 'en_AU') then
		ie_regulated_market_w := 'S';
	end if;
	insert into tasy_version_track(
		nr_sequencia,
		cd_customer_id,
		nm_customer,
		ie_production,
		ds_environment,		
		nr_version_udi,
		ie_process,
		ie_regulated_market,
		ds_application,
		dt_atualizacao_nrec,
		nm_usuario_nrec,
		dt_atualizacao,
		nm_usuario,
		ds_country,
		ds_state,
		ds_city,
		ds_address,
		nr_phone,
		cd_version,
		nr_service_pack,
		ie_migration)
	values (
		nextval('tasy_version_track_seq'),
		substr(cd_customer_id_p, 1, 50),
		substr(nm_customer_p, 1, 255),
		substr(ie_production_p, 1, 1),
		substr(ds_environment_p, 1, 50),
		nr_version_udi_w,
		substr(ie_process_p, 1, 1),
		substr(ie_regulated_market_w, 1, 1),
		substr(ds_application_p, 1, 100),
		clock_timestamp(),
		coalesce(substr(nm_usuario_p, 1, 15), 'Tasy'),
		clock_timestamp(),
		coalesce(substr(nm_usuario_p, 1, 15), 'Tasy'),
		ds_country_w,
		ds_state_w,
		ds_city_w,
		ds_address_w,
		nr_phone_w,
		cd_version_p,
		nr_service_pack_w,
		ie_migration_w
	);
	commit;	
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE register_version_track ( cd_customer_id_p text, nm_customer_p text, ie_production_p text, ds_environment_p text, cd_version_p text, nr_service_pack_p bigint, ie_process_p text, ds_locale_p text, ds_application_p text, nm_usuario_p text, ds_country_p text default null, ds_state_p text default null, ds_city_p text default null, ds_address_p text default null, nr_phone_p text default null) FROM PUBLIC;

