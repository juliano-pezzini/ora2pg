-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE tasylab_registrar_prescricao ( nr_sequencia_tasylab_p bigint, nr_atendimento_p bigint, nr_seq_lote_p bigint, nr_prescricao_origem_p bigint, dt_entrega_p timestamp, cd_pessoa_fisica_p text, --cd_medico_resp_p	varchar2,
 nr_seq_externo_p bigint, qt_peso_p bigint, qt_altura_cm_p bigint, dt_prescricao_p timestamp, dt_mestruacao_p timestamp, ds_observacao_p text, cd_erro_p INOUT bigint, ds_erro_p INOUT text, nr_prescricao_p INOUT bigint) AS $body$
DECLARE


ie_base_wheb_w				varchar(1);

nr_prescricao_w				prescr_medica.nr_prescricao%type;

cd_medico_resp_w			lab_tasylab_cliente.cd_medico%type;
cd_estabelecimento_w		lab_tasylab_cliente.cd_estabelecimento%type;
cd_setor_entrega_prescr_w	lab_tasylab_cliente.cd_setor_entrega_prescr%type;


BEGIN

cd_erro_p	:= 0;

/*Verifica se esta na base Wheb para alterar os valores padrões da procedure*/

SELECT	CASE WHEN count(*)=0 THEN 'N'  ELSE 'S' END
into STRICT	ie_base_wheb_w
FROM 	estabelecimento a
where	a.cd_estabelecimento = 1
and		a.cd_cgc = '01950338000177';

select	max(a.cd_medico),
		max(a.cd_estabelecimento),
		max(cd_setor_entrega_prescr)
into STRICT	cd_medico_resp_w,
		cd_estabelecimento_w,
		cd_setor_entrega_prescr_w
from	lab_tasylab_cliente a
where	a.nr_sequencia = nr_sequencia_tasylab_p;

select	nextval('prescr_medica_seq')
into STRICT	nr_prescricao_w
;

begin
insert into prescr_medica(	nr_atendimento,
							nr_prescricao,
							cd_pessoa_fisica,
							cd_medico,
							dt_prescricao,
							dt_entrega,
							cd_setor_entrega,
							qt_peso,
							qt_altura_cm,
							dt_mestruacao,
							cd_estabelecimento,
							nr_controle,
							dt_atualizacao,
							nm_usuario,
							ds_observacao)
				values (	nr_atendimento_p,
							nr_prescricao_w,
							cd_pessoa_fisica_p,
							cd_medico_resp_w,
							dt_prescricao_p,
							dt_entrega_p,
							CASE WHEN ie_base_wheb_w='S' THEN  46  ELSE coalesce(cd_setor_entrega_prescr_w, 322) END ,
							qt_peso_p,
							qt_altura_cm_p,
							dt_mestruacao_p,
							cd_estabelecimento_w,
							nr_prescricao_origem_p,
							clock_timestamp(),
							'TasyLab-Prescr',
							ds_observacao_p);

insert into lab_tasylab_cli_prescr(
							nr_sequencia,
							nr_prescricao,
							nr_prescricao_origem,
							nr_seq_tasylab_cli,
							dt_atualizacao,
							dt_atualizacao_nrec,
							nm_usuario,
							nm_usuario_nrec
							--,nr_seq_lote
							)
				values (
							nextval('lab_tasylab_cli_prescr_seq'),
							nr_prescricao_w,
							nr_prescricao_origem_p,
							nr_sequencia_tasylab_p,
							clock_timestamp(),
							clock_timestamp(),
							'TasyLab-CliPre',
							'TasyLab-CliPre'
							--,nr_seq_lote_p
							);

nr_prescricao_p	:= nr_prescricao_w;

exception
when others then
	cd_erro_p	:= 1;
	ds_erro_p	:= substr('Erro ao inserir a prescrição '||sqlerrm,1,2000);
end;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE tasylab_registrar_prescricao ( nr_sequencia_tasylab_p bigint, nr_atendimento_p bigint, nr_seq_lote_p bigint, nr_prescricao_origem_p bigint, dt_entrega_p timestamp, cd_pessoa_fisica_p text,  nr_seq_externo_p bigint, qt_peso_p bigint, qt_altura_cm_p bigint, dt_prescricao_p timestamp, dt_mestruacao_p timestamp, ds_observacao_p text, cd_erro_p INOUT bigint, ds_erro_p INOUT text, nr_prescricao_p INOUT bigint) FROM PUBLIC;

