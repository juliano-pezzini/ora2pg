-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE atualizar_data_dashboard_card () AS $body$
DECLARE


nr_sequencia_w				dashboard_cards.nr_sequencia%TYPE;
dt_fim_ano_w				varchar(30);
dt_ano_w					varchar(4);

C01 CURSOR FOR
	SELECT a.nr_sequencia from dashboard_cards a
	where a.ie_date_type = 'D'
	and a.ie_atualiza_data = 'S'
	and a.dt_fim < clock_timestamp();

C02 CURSOR FOR
	SELECT a.nr_sequencia from dashboard_cards a
	where a.ie_date_type = 'M'
	and a.ie_atualiza_data = 'S'
	and a.dt_fim < clock_timestamp();

C03 CURSOR FOR
		SELECT a.nr_sequencia from dashboard_cards a
	where a.ie_date_type = 'A'
	and a.ie_atualiza_data = 'S'
	and a.dt_fim < clock_timestamp();		


BEGIN

open c01;
loop
fetch C01 into	
	nr_sequencia_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	update	dashboard_cards
		set	dt_fim	= clock_timestamp(),
		dt_inicio = clock_timestamp(),
		dt_atualizacao = clock_timestamp()
		where	nr_sequencia 		= nr_sequencia_w;
	end;
end loop;
close c01;

open c02;
loop
fetch C02 into	
	nr_sequencia_w;
	EXIT WHEN NOT FOUND; /* apply on C02 */
	begin
	
	update	dashboard_cards
		set	dt_fim	= last_day(clock_timestamp()),
		dt_inicio = TRUNC(clock_timestamp(), 'MONTH'),
		dt_atualizacao = clock_timestamp()
		where	nr_sequencia 		= nr_sequencia_w;
	end;
end loop;
close c02;

open c03;
loop
fetch C03 into	
	nr_sequencia_w;
	EXIT WHEN NOT FOUND; /* apply on C03 */
	begin
	select TO_CHAR(clock_timestamp(), 'YYYY')
	into STRICT dt_ano_w
	;
	dt_fim_ano_w := '31/12/' || dt_ano_w;
	update	dashboard_cards
		set	dt_fim	= TO_DATE(dt_fim_ano_w,'dd/MM/yyyy'),
		dt_inicio = TRUNC(clock_timestamp(), 'y'),
		dt_atualizacao = clock_timestamp()
		where	nr_sequencia 		= nr_sequencia_w;
	end;
end loop;
close c03;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE atualizar_data_dashboard_card () FROM PUBLIC;

