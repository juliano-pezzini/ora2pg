-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE vinc_etapa_gd_prescr_mat_hor ( nr_seq_prescr_mat_hor_p bigint, nr_seq_etapa_gedipa_p bigint, nm_usuario_p text) AS $body$
DECLARE

nr_seq_etapa_hor_w 	bigint;
nr_seq_horario_w 	bigint;
dt_horario_w 		timestamp;
cd_material_w 		integer;
qt_dose_w 		double precision;
cd_unidade_medida_dose_w varchar(30);
cd_intervalo_w 		varchar(7);

BEGIN

if (nr_seq_prescr_mat_hor_p IS NOT NULL AND nr_seq_prescr_mat_hor_p::text <> '') and (nr_seq_prescr_mat_hor_p > 0) then

	update 	prescr_mat_hor
	set 	nr_seq_etapa_gedipa 	= nr_seq_etapa_gedipa_p
	where 	nr_sequencia 		= nr_seq_prescr_mat_hor_p;

	select nextval('gedipa_etapa_hor_seq')
	into STRICT nr_seq_etapa_hor_w
	;

	select 	a.nr_sequencia,
		a.dt_horario,
		a.cd_material,
		a.qt_dose,
		a.cd_unidade_medida_dose,
		b.cd_intervalo
	into STRICT 	nr_seq_horario_w,
		dt_horario_w,
		cd_material_w,
		qt_dose_w,
		cd_unidade_medida_dose_w,
		cd_intervalo_w
	from 	prescr_mat_hor a, prescr_material b
	where 	a.nr_sequencia = nr_seq_prescr_mat_hor_p
	and 	a.nr_prescricao = b.nr_prescricao
	and 	a.nr_seq_material = b.nr_sequencia;

	insert into gedipa_etapa_hor(
		nr_sequencia,
		dt_atualizacao,
		nm_usuario,
		dt_atualizacao_nrec,
		nm_usuario_nrec,
		nr_seq_etapa_gedipa,
		nr_seq_horario,
		dt_horario,
		cd_material,
		qt_dose,
		cd_unidade_medida_dose,
		cd_intervalo,
		ie_status_preparo
		)
	values (
		nr_seq_etapa_hor_w,
		clock_timestamp(),
		nm_usuario_p,
		clock_timestamp(),
		nm_usuario_p,
		nr_seq_etapa_gedipa_p,
		nr_seq_horario_w,
		dt_horario_w,
		cd_material_w,
		qt_dose_w,
		cd_unidade_medida_dose_w,
		cd_intervalo_w,
		'P'
		);
commit;
end if;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE vinc_etapa_gd_prescr_mat_hor ( nr_seq_prescr_mat_hor_p bigint, nr_seq_etapa_gedipa_p bigint, nm_usuario_p text) FROM PUBLIC;

