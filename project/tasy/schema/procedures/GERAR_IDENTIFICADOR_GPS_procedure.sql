-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_identificador_gps ( nr_sequencia_p integer) AS $body$
DECLARE


cd_estabelecimento_w	smallint;
cd_identificador_w		varchar(100);
cd_pessoa_fisica_w	varchar(10);
cd_cgc_w		varchar(14);
dt_vencimento_w		timestamp;
nm_usuario_w	varchar(15);
nr_titulo_w		bigint;
nr_titulo_original_w		bigint;
cd_pessoa_w		varchar(14);
ie_identificador_w	varchar(1);


BEGIN

select	cd_identificador,
		dt_vencimento
into STRICT	cd_identificador_w,
		dt_vencimento_w
from	gps
where	nr_sequencia = nr_sequencia_p;

if (coalesce(cd_identificador_w::text, '') = '') then

	select	max(nr_titulo)
	into STRICT	nr_titulo_w
	from	gps_titulo
	where	nr_seq_gps = nr_sequencia_p;

	select	max(nr_titulo_original)
	into STRICT	nr_titulo_original_w
	from	titulo_pagar
	where	nr_titulo = nr_titulo_w;

	if (nr_titulo_original_w IS NOT NULL AND nr_titulo_original_w::text <> '') then

		select	cd_pessoa_fisica,
				cd_cgc
		into STRICT	cd_pessoa_fisica_w,
				cd_cgc_w
		from	titulo_pagar
		where	nr_titulo = nr_titulo_original_w;

		if (coalesce(cd_pessoa_fisica_w::text, '') = '') then
			cd_identificador_w := cd_cgc_w;
		else
			select	max(nr_pis_pasep)
			into STRICT	cd_identificador_w
			from	pessoa_fisica
			where	cd_pessoa_fisica = cd_pessoa_fisica_w;
		end if;

		select	obter_usuario_ativo,
				wheb_usuario_pck.get_cd_estabelecimento
		into STRICT	nm_usuario_w,
				cd_estabelecimento_w
		;

		ie_identificador_w := obter_param_usuario(5500, 32, obter_perfil_ativo, nm_usuario_w, cd_estabelecimento_w, ie_identificador_w);

		if (ie_identificador_w = 'S') then
			update gps set cd_identificador = cd_identificador_w || ' - ' || to_char(dt_vencimento_w,'dd/mm/yyyy') where nr_sequencia = nr_sequencia_p;
			commit;
		elsif (ie_identificador_w = 'C') then
			update gps set cd_identificador = cd_identificador_w where nr_sequencia = nr_sequencia_p;
			commit;
		end if;

	else
		CALL wheb_mensagem_pck.exibir_mensagem_abort(236678,'NR_TITULO=' || nr_titulo_w);
	end if;
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_identificador_gps ( nr_sequencia_p integer) FROM PUBLIC;

