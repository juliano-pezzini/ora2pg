-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE recebe_item_atend_integracao ( nr_atendimento_p bigint, cd_material_p bigint, qt_material_p bigint, nr_seq_lote_fornec_p bigint, cd_local_estoque_p bigint) AS $body$
DECLARE


nr_seq_atepacu_w		bigint;
dt_entrada_unidade_w	timestamp;
cd_categoria_w		varchar(10);
nr_sequencia_w		bigint;
cd_convenio_w		bigint;
qt_existe_mat_w		bigint;
cd_estabelecimento_w	smallint;
ie_tipo_atendimento_w	smallint;
cd_unidade_medida_w	varchar(30);
cd_setor_atendimento_w	prescr_medica.cd_setor_atendimento%type;


BEGIN

nr_seq_atepacu_w := obter_atepacu_paciente(nr_atendimento_p, 'IA');

begin
select	cd_setor_atendimento,
	dt_entrada_unidade
into STRICT	cd_setor_atendimento_w,
	dt_entrada_unidade_w
from 	atend_paciente_unidade
where 	nr_seq_interno = nr_seq_atepacu_w;
exception
when others then
	nr_seq_atepacu_w:= 0;
end;

select 	nextval('material_atend_paciente_seq')
into STRICT	nr_sequencia_w
;

select 	obter_convenio_atendimento(nr_atendimento_p)
into STRICT	cd_convenio_w
;

select 	obter_categoria_atendimento(nr_atendimento_p)
into STRICT	cd_categoria_w
;

if (nr_seq_atepacu_w = 0) then
	begin
	CALL GERAR_PASSAGEM_SETOR_ATEND(nr_atendimento_p,cd_setor_atendimento_w,to_date(clock_timestamp(),'dd/mm/yyyy hh24:mi:ss'),'S','Tasy');

	select	coalesce(max(nr_seq_interno),0)
	into STRICT	nr_seq_atepacu_w
	from	atend_paciente_unidade
	where	nr_atendimento		= nr_atendimento_p
	and	cd_setor_atendimento	= cd_setor_atendimento_w;

	select	dt_entrada_unidade
	into STRICT	dt_entrada_unidade_w
	from	atend_paciente_unidade
	where	nr_seq_interno = nr_seq_atepacu_w;
	end;
end if;

select	count(*)
into STRICT	qt_existe_mat_w
from	material
where	cd_material = cd_material_p;

select	max(cd_estabelecimento),
	max(ie_tipo_atendimento)
into STRICT	cd_estabelecimento_w,
	ie_tipo_atendimento_w
from	atendimento_paciente
where	nr_atendimento	= nr_atendimento_p;

if (qt_existe_mat_w  > 0) then

	select	max(cd_unidade_medida_consumo)
	into STRICT	cd_unidade_medida_w
	from	material
	where	cd_material		= cd_material_p;

	insert  into material_atend_paciente(nr_sequencia,
			nr_atendimento,
		 	dt_entrada_unidade,
			cd_material,
			cd_material_exec,
			dt_atendimento,
			qt_material,
			dt_atualizacao,
			nm_usuario,
			cd_setor_atendimento,
			nr_seq_atepacu,
			--nr_doc_convenio,
			cd_convenio,
			cd_categoria,
			ie_auditoria,
			cd_unidade_medida,
			nr_seq_lote_fornec,
			cd_local_estoque,
			cd_acao)
		values (nr_sequencia_w,
			nr_atendimento_p,
			dt_entrada_unidade_w,
			cd_material_p,
			cd_material_p,
			to_date(clock_timestamp(),'dd/mm/yyyy hh24:mi:ss'),
			qt_material_p,
			clock_timestamp(),
			'Tasy',
			cd_setor_atendimento_w,
			nr_seq_atepacu_w,
			--nr_doc_convenio_p,
			cd_convenio_w,
			cd_categoria_w,
			'N',
			cd_unidade_medida_w,
			nr_seq_lote_fornec_p,
			cd_local_estoque_p,
			1);
	commit;

	CALL Atualiza_preco_material(nr_sequencia_w, 'Tasy');

end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE recebe_item_atend_integracao ( nr_atendimento_p bigint, cd_material_p bigint, qt_material_p bigint, nr_seq_lote_fornec_p bigint, cd_local_estoque_p bigint) FROM PUBLIC;

