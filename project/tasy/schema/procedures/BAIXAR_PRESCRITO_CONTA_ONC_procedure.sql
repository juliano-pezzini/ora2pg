-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE baixar_prescrito_conta_onc (nr_sequencia_p can_ordem_item_prescr.nr_sequencia%type) AS $body$
DECLARE


dt_entrada_unidade_w timestamp;
cd_convenio_w bigint;
cd_categoria_w varchar(10);
nr_doc_convenio_w varchar(20);
ie_tipo_guia_w varchar(2);
cd_senha_w varchar(20);
ie_data_conta_paciente_w varchar(2);
nr_seq_atepacu_w bigint;
material_atend_paciente_seq_w material_atend_paciente.nr_sequencia%type;
dt_conta_w timestamp;

item_prescrito CURSOR FOR
SELECT      item.nr_sequencia,
            item.nr_seq_prescricao,
            coalesce(ordem.nr_atendimento, prescricao.nr_atendimento) nr_atendimento,
            item.cd_material,
            item.qt_dose,
            item.cd_unidade_medida,
            prescricao.dt_prescricao,
            prescricao.nr_prescricao,
            prescricao.cd_setor_atendimento,
            item.nr_seq_ordem,
            ordem.ie_via_aplicacao,
            prescricao.dt_validade_prescr
from        can_ordem_item_prescr item
inner join  can_ordem_prod ordem on item.nr_seq_ordem = ordem.nr_sequencia
inner join  prescr_medica prescricao on ordem.nr_prescricao = prescricao.nr_prescricao
where       item.nr_sequencia = nr_sequencia_p;


BEGIN
    ie_data_conta_paciente_w := obter_param_usuario(3130, 481, obter_perfil_ativo, wheb_usuario_pck.get_nm_usuario, wheb_usuario_pck.get_cd_estabelecimento, ie_data_conta_paciente_w);

    for item in item_prescrito loop
        -- conta paciente
        SELECT * FROM obter_convenio_execucao(item.nr_atendimento, clock_timestamp(), cd_convenio_w, cd_categoria_w, nr_doc_convenio_w, ie_tipo_guia_w, cd_senha_w) INTO STRICT cd_convenio_w, cd_categoria_w, nr_doc_convenio_w, ie_tipo_guia_w, cd_senha_w;

        select	coalesce(max(nr_seq_interno),0)
        into STRICT	nr_seq_atepacu_w
        from	atend_paciente_unidade
        where	nr_atendimento		= item.nr_atendimento
        and	cd_setor_atendimento	= item.cd_setor_atendimento;

        select  CASE WHEN ie_data_conta_paciente_w='DA' THEN  clock_timestamp() WHEN ie_data_conta_paciente_w=                  -- DA: data atual
                'DP' THEN  item.dt_prescricao WHEN ie_data_conta_paciente_w=       -- DP: data da prescricao
                'DV' THEN  item.dt_validade_prescr  ELSE   -- DV: data de validade da prescricao
                clock_timestamp()                         -- padrao
 END
        into STRICT    dt_conta_w
;

        select  nextval('material_atend_paciente_seq')
        into STRICT    material_atend_paciente_seq_w
;

        select	coalesce(max(dt_entrada_unidade), clock_timestamp())
        into STRICT	dt_entrada_unidade_w
        from 	atend_paciente_unidade
        where 	nr_seq_interno = nr_seq_atepacu_w;

        insert into material_atend_paciente(
            nr_sequencia, nr_atendimento,
            dt_entrada_unidade, cd_material,
            dt_atendimento, cd_unidade_medida,
            qt_material, qt_estoque, dt_atualizacao,
            nm_usuario,	cd_convenio,
            cd_categoria, nr_doc_convenio,
            ie_tipo_guia, dt_prescricao,
            cd_material_prescricao,	cd_material_exec,
            nr_prescricao, cd_acao,
            cd_setor_atendimento, qt_executada,
            vl_unitario, qt_ajuste_conta,
            ie_valor_informado, ie_guia_informada,
            ie_auditoria, nm_usuario_original,
            cd_situacao_glosa, nr_seq_atepacu,
            cd_local_estoque, nr_seq_ordem_prod, cd_senha,
            nr_seq_lote_fornec, ie_via_aplicacao,
            nr_seq_tipo_baixa, cd_cgc_fornecedor,
            nr_sequencia_prescricao, dt_conta)
        values (
            material_atend_paciente_seq_w, item.nr_atendimento,
            dt_entrada_unidade_w, item.cd_material,
            clock_timestamp(), item.cd_unidade_medida,
            item.qt_dose, 0, clock_timestamp(),
            wheb_usuario_pck.get_nm_usuario, cd_convenio_w,
            cd_categoria_w, nr_doc_convenio_w,
            ie_tipo_guia_w, item.dt_prescricao,
            item.cd_material, item.cd_material,
            item.nr_prescricao, '1',
            item.cd_setor_atendimento, item.qt_dose,
            0, 0,
            'N', 'N',
            'N', wheb_usuario_pck.get_nm_usuario,
            0, nr_seq_atepacu_w,
            null, item.nr_seq_ordem, cd_senha_w,
            null, item.ie_via_aplicacao,
            null, null,
            item.nr_seq_prescricao, dt_conta_w);

        CALL atualiza_preco_material(material_atend_paciente_seq_w, wheb_usuario_pck.get_nm_usuario);
    end loop;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE baixar_prescrito_conta_onc (nr_sequencia_p can_ordem_item_prescr.nr_sequencia%type) FROM PUBLIC;

