-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE qt_gerar_hor_itens_ageint ( cd_pessoa_fisica_p text, dt_agenda_p timestamp, nr_seq_ageint_p bigint, nr_min_duracao_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint, nr_seQ_prof_p bigint, ds_itens_p text DEFAULT NULL, ds_locais_p text DEFAULT NULL, nr_seq_local_p bigint DEFAULT NULL) AS $body$
DECLARE


nr_minuto_duracao_w	bigint;
nr_seq_ageint_item_w	bigint;
nr_seq_pend_quimio_w	bigint;
ie_tipo_pend_Agenda_w	varchar(10);
ie_manter_hor_quimio_w	varchar(1);

C01 CURSOR FOR
	SELECT	nr_sequencia,
		nr_seq_pend_quimio,
		ie_tipo_pend_agenda,
		nr_minuto_duracao
	FROM    agenda_integrada_item
	WHERE   nr_seq_Agenda_int    = nr_seq_ageint_p
	AND     ie_tipo_agendamento  = 'Q'
	AND (obter_se_contido(nr_sequencia, ds_itens_p)	= 'S' OR coalesce(ds_itens_p::text, '') = '')
	--and	obter_se_contido()
	AND	((TRUNC(coalesce(dt_prev_transf_quimio,dt_prevista_quimio)) = TRUNC(dt_agenda_p)) OR (coalesce(dt_prevista_quimio::text, '') = ''))
	ORDER BY 1;


BEGIN

SELECT	coalesce(MAX(ie_manter_hor_quimio),'N')
INTO STRICT	ie_manter_hor_quimio_w
FROM	parametro_agenda_integrada
WHERE	coalesce(cd_estabelecimento, cd_estabelecimento_p)	= cd_estabelecimento_p;


IF (ie_manter_hor_quimio_w	= 'N') THEN
	DELETE 	FROM w_Agenda_quimio
	WHERE	nm_usuario	= nm_usuario_p
	AND	TRUNC(dt_horario) = trunc(dt_agenda_p)
	and (nr_seq_local	= nr_seq_local_p or coalesce(nr_seq_local_p,0) = 0);
END IF;

OPEN C01;
LOOP
FETCH C01 INTO
	nr_seq_ageint_item_w,
	nr_seq_pend_quimio_w,
	ie_tipo_pend_Agenda_w,
	nr_minuto_duracao_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	BEGIN
	IF (ie_manter_hor_quimio_w	= 'S') THEN
		CALL Qt_Gerar_Horario_Ageint(
				nr_seq_pend_quimio_w,
				NULL,
				dt_agenda_p,
				nm_usuario_p,
				nr_min_duracao_p,
				cd_pessoa_fisica_p,
				NULL,
				cd_estabelecimento_p,
				NULL,
				nr_seq_ageint_item_w,
				nr_seQ_prof_p,
				ds_locais_p);
	ELSE
		CALL Qt_Gerar_Horario(
				nr_seq_pend_quimio_w,
				NULL,
				dt_agenda_p,
				nm_usuario_p,
				nr_min_duracao_p,
				cd_pessoa_fisica_p,
				NULL,
				cd_estabelecimento_p,
				nr_seq_local_p,
				nr_seq_ageint_item_w,
				nr_seQ_prof_p,
				ds_locais_p);
	END IF;
	END;
END LOOP;
CLOSE C01;

COMMIT;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE qt_gerar_hor_itens_ageint ( cd_pessoa_fisica_p text, dt_agenda_p timestamp, nr_seq_ageint_p bigint, nr_min_duracao_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint, nr_seQ_prof_p bigint, ds_itens_p text DEFAULT NULL, ds_locais_p text DEFAULT NULL, nr_seq_local_p bigint DEFAULT NULL) FROM PUBLIC;

