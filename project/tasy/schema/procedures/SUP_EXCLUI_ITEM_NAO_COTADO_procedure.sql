-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE sup_exclui_item_nao_cotado ( nr_cot_compra_p bigint, ie_excluir_zerados_p text, nm_usuario_p text) AS $body$
DECLARE


nr_item_cot_compra_w		integer;
nr_nova_cot_compra_w		bigint;
nr_novo_item_cot_compra_w	bigint;
cd_estabelecimento_w		bigint;
cd_perfil_ativo_w		bigint;
ie_gera_nova_cotacao_w		varchar(1);
ds_observacao_w			varchar(4000);

c01 CURSOR FOR
SELECT	a.nr_item_cot_compra
from	cot_compra_item a
where	a.nr_cot_compra = nr_cot_compra_p
and not exists (
	SELECT	1
	from	cot_compra_forn_item b
	where	b.nr_cot_compra = nr_cot_compra_p
	and	a.nr_item_cot_compra = b.nr_item_cot_compra);

c02 CURSOR FOR
SELECT	a.nr_item_cot_compra
from	cot_compra_item a
where	a.nr_cot_compra = nr_cot_compra_p
and not exists (
	SELECT	1
	from	cot_compra_forn_item b
	where	b.nr_cot_compra = nr_cot_compra_p
	and	a.nr_item_cot_compra = b.nr_item_cot_compra
	and	b.vl_unitario_material > 0);


BEGIN

cd_perfil_ativo_w	:= obter_perfil_ativo;

select	a.cd_estabelecimento,
	a.ds_observacao
into STRICT	cd_estabelecimento_w,
	ds_observacao_w
from	cot_compra a
where	a.nr_cot_compra = nr_cot_compra_p;

select	obter_valor_param_usuario(915, 46, cd_perfil_ativo_w, nm_usuario_p, cd_estabelecimento_w)
into STRICT	ie_gera_nova_cotacao_w
;

nr_nova_cot_compra_w	:= 0;

if (ie_excluir_zerados_p = 'S') then

	open C02;
	loop
	fetch C02 into
		nr_item_cot_compra_w;
	EXIT WHEN NOT FOUND; /* apply on C02 */
		begin

		if (ie_gera_nova_cotacao_w = 'C') then

			if (nr_nova_cot_compra_w = 0) then

				ds_observacao_w := substr(WHEB_MENSAGEM_PCK.get_texto(306927,'NR_COT_COMPRA_P='||nr_cot_compra_p||';DS_OBSERVACAO_W='||ds_observacao_w),1,4000);

				select	nextval('cot_compra_seq')
				into STRICT	nr_nova_cot_compra_w
				;

				insert into cot_compra(
					nr_cot_compra,
					dt_cot_compra,
					dt_atualizacao,
					cd_comprador,
					nm_usuario,
					ds_observacao,
					cd_pessoa_solicitante,
					cd_estabelecimento,
					dt_retorno_prev,
					dt_entrega,
					nr_seq_tipo_compra,
					nr_seq_mod_compra,
					nr_seq_reg_compra,
					nr_classif_interno,
					nr_seq_subgrupo_compra,
					ie_finalidade_cotacao,
					ie_forma_venc_cotacao)
				SELECT	nr_nova_cot_compra_w,
					clock_timestamp(),
					clock_timestamp(),
					cd_comprador,
					nm_usuario_p,
					ds_observacao_w,
					cd_pessoa_solicitante,
					cd_estabelecimento,
					dt_retorno_prev,
					dt_entrega,
					nr_seq_tipo_compra,
					nr_seq_mod_compra,
					nr_seq_reg_compra,
					nr_classif_interno,
					nr_seq_subgrupo_compra,
					ie_finalidade_cotacao,
					ie_forma_venc_cotacao
				from	cot_compra
				where	nr_cot_compra = nr_cot_compra_p;

				CALL gerar_hist_cotacao_sem_commit(
					nr_nova_cot_compra_w,
					WHEB_MENSAGEM_PCK.get_texto(306928,'NR_COT_COMPRA_P='||nr_cot_compra_p),
					WHEB_MENSAGEM_PCK.get_texto(306929,'NR_COT_COMPRA_P='||nr_cot_compra_p),
					'S',
					nm_usuario_p);
			end if;

			if (nr_nova_cot_compra_w > 0) then

				select	coalesce(max(nr_item_cot_compra),0) + 1
				into STRICT	nr_novo_item_cot_compra_w
				from	cot_compra_item
				where	nr_cot_compra = nr_nova_cot_compra_w;

				insert into cot_compra_item(
					nr_cot_compra,
					nr_item_cot_compra,
					cd_material,
					qt_material,
					cd_unidade_medida_compra,
					dt_atualizacao,
					dt_limite_entrega,
					nm_usuario,
					ie_situacao,
					ds_material_direto_w,
					ie_regra_preco,
					nr_solic_compra,
					nr_item_solic_compra,
					cd_estab_item,
					nr_seq_licitacao,
					nr_seq_lic_item,
					nr_seq_tipo_compra,
					nr_seq_mod_compra,
					nr_seq_reg_compra,
					nr_seq_reg_compra_item,
					nr_seq_proj_rec,
					nr_item_solic_compra_entr,
					nr_seq_central_compra_item,
					nr_contrato,
					nr_seq_motivo)
				SELECT	nr_nova_cot_compra_w,
					nr_novo_item_cot_compra_w,
					cd_material,
					qt_material,
					cd_unidade_medida_compra,
					clock_timestamp(),
					dt_limite_entrega,
					nm_usuario_p,
					ie_situacao,
					ds_material_direto_w,
					ie_regra_preco,
					nr_solic_compra,
					nr_item_solic_compra,
					cd_estab_item,
					nr_seq_licitacao,
					nr_seq_lic_item,
					nr_seq_tipo_compra,
					nr_seq_mod_compra,
					nr_seq_reg_compra,
					nr_seq_reg_compra_item,
					nr_seq_proj_rec,
					nr_item_solic_compra_entr,
					nr_seq_central_compra_item,
					nr_contrato,
					nr_seq_motivo
				from	cot_compra_item
				where	nr_cot_compra = nr_cot_compra_p
				and	nr_item_cot_compra = nr_item_cot_compra_w;

				update	solic_compra_item
				set	nr_cot_compra = nr_nova_cot_compra_w,
					nr_item_cot_compra = nr_novo_item_cot_compra_w
				where	nr_cot_compra = nr_cot_compra_p
				and	nr_item_cot_compra = nr_item_cot_compra_w;

				insert into cot_compra_item_entrega(
					nr_sequencia,
					dt_atualizacao,
					nm_usuario,
					dt_atualizacao_nrec,
					nm_usuario_nrec,
					nr_cot_compra,
					nr_item_cot_compra,
					dt_entrega,
					qt_entrega,
					ds_observacao)
				SELECT	nextval('cot_compra_item_entrega_seq'),
					clock_timestamp(),
					nm_usuario_p,
					clock_timestamp(),
					nm_usuario_p,
					nr_nova_cot_compra_w,
					nr_novo_item_cot_compra_w,
					dt_entrega,
					qt_entrega,
					ds_observacao
				from	cot_compra_item_entrega
				where	nr_cot_compra = nr_cot_compra_p
				and	nr_item_cot_compra = nr_item_cot_compra_w;

				commit;

			end if;
		end if;

		delete	from cot_compra_item
		where	nr_item_cot_compra = nr_item_cot_compra_w
		and	nr_cot_compra = nr_cot_compra_p;

		end;
	end loop;
	close C02;

else

	open C01;
	loop
	fetch C01 into
		nr_item_cot_compra_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin

		delete	from cot_compra_item
		where	nr_item_cot_compra = nr_item_cot_compra_w
		and	nr_cot_compra = nr_cot_compra_p;

		end;
	end loop;
	close C01;

end if;

if (nr_nova_cot_compra_w > 0) then
	CALL gerar_hist_cotacao_sem_commit(
		nr_cot_compra_p,
		WHEB_MENSAGEM_PCK.get_texto(306931),
		WHEB_MENSAGEM_PCK.get_texto(306932,'NR_NOVA_COT_COMPRA_W='||nr_nova_cot_compra_w),
		'S',
		nm_usuario_p);
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE sup_exclui_item_nao_cotado ( nr_cot_compra_p bigint, ie_excluir_zerados_p text, nm_usuario_p text) FROM PUBLIC;

