-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_eis_perda_material ( dt_parametro_p timestamp, cd_estabelecimento_p bigint, nm_usuario_p text) AS $body$
DECLARE


cd_centro_custo_w			integer;
cd_classe_material_w		integer;
cd_grupo_material_w		smallint;
cd_local_estoque_w		smallint;
cd_fornecedor_w			varchar(14);
cd_material_w			integer;
cd_operacao_estoque_w		smallint;
cd_setor_atendimento_w		integer;
cd_subgrupo_material_w		smallint;
dt_mes_ref_w			timestamp;
ie_curva_abc_w			varchar(1);
ie_consignado_w			varchar(1);
ie_padronizado_w			varchar(1);
ie_tipo_perda_w			varchar(03);
qt_consumo_w			double precision;
qt_movimento_w			double precision;
qt_perda_w			double precision;
qt_reg_w				bigint;
vl_consumo_w			double precision;
vl_custo_w			double precision;
vl_perda_w			double precision;
pr_perda_w			double precision;

c01 CURSOR FOR
SELECT	cd_local_estoque,
	cd_centro_custo,
	cd_material,
	a.ie_tipo_perda,
	a.ie_consignado,
	CASE WHEN a.ie_consignado='N' THEN 'null'  ELSE a.cd_fornecedor END  cd_fornecedor,
	sum(CASE WHEN ie_entrada_saida='S' THEN  vl_estoque  ELSE vl_estoque * -1 END  / 1) vl_perda,
	sum(CASE WHEN ie_entrada_saida='S' THEN  qt_estoque  ELSE qt_estoque * -1 END  / 1) qt_perda
from	movto_estoque_operacao_v a
where	a.ie_tipo_perda <> 'F'
and	(a.ie_tipo_perda IS NOT NULL AND a.ie_tipo_perda::text <> '')
and	a.ie_tipo_requisicao not in (8,90,91)
and	dt_mesano_referencia	= dt_mes_ref_w
and	cd_estabelecimento	= cd_estabelecimento_p
group by	cd_local_estoque,
	cd_centro_custo,
	cd_material,
	a.ie_consignado,
	a.ie_tipo_perda,
	CASE WHEN a.ie_consignado='N' THEN 'null'  ELSE a.cd_fornecedor END;

/* cursor para gravar anual*/

c02 CURSOR FOR
SELECT	cd_local_estoque,
	cd_centro_custo,
	qt_perda,
	vl_perda,
	vl_consumo,
	cd_subgrupo_material,
	cd_grupo_material,
	cd_classe_material,
	cd_material,
	ie_tipo_perda,
	ie_padronizado,
	ie_curva_abc,
	ie_consignado
from	eis_perda_material
where	ie_periodo = 'M'
and	trunc(dt_referencia,'year')	= trunc(dt_mes_ref_w,'year')
and	coalesce(ie_tipo_perda,'X') <> 'F'
and	cd_estabelecimento		= cd_estabelecimento_p;

/*para buscar valor de consumo  no mÃªs*/

c03 CURSOR FOR
SELECT	a.cd_local_estoque,
	a.cd_centro_custo,
	a.cd_material,
	a.ie_consignado,
	sum(a.qt_consumo) qt_perda,
	sum(a.vl_consumo) vl_perda
from	movto_estoque_operacao_v a,
	operacao_estoque b
where	a.cd_operacao_estoque = b.cd_operacao_estoque
and	a.ie_tipo_requisicao not in (8,90,91)
and	a.dt_mesano_referencia = dt_mes_ref_w
and	a.cd_estabelecimento = cd_estabelecimento_p
group by	a.cd_local_estoque,
	a.cd_centro_custo,
	a.cd_material,
	a.ie_consignado;


BEGIN
--insert into log_xxtasy values (sysdate, nm_usuario_p, 602, 'PerdaMaterial');
dt_mes_ref_w	:= trunc(dt_parametro_p,'month');

delete	FROM eis_perda_material
where	ie_periodo = 'M'
and	dt_referencia = dt_mes_ref_w
and	cd_estabelecimento	= cd_estabelecimento_p;

open c01;
loop
fetch c01 into
	cd_local_estoque_w,
	cd_centro_custo_w,
	cd_material_w,
	ie_tipo_perda_w,
	ie_consignado_w,
	cd_fornecedor_w,
	vl_perda_w,
	qt_perda_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	begin
	vl_consumo_w	:= 0;
	qt_consumo_w	:= 0;

	select	cd_grupo_material,
		cd_subgrupo_material,
		cd_classe_material
	into STRICT	cd_grupo_material_w,
		cd_subgrupo_material_w,
		cd_classe_material_w
	from	estrutura_material_v
	where	cd_material = cd_material_w;

	ie_padronizado_w	:= substr(obter_se_material_padronizado(cd_estabelecimento_p, cd_material_w),1,1);
	ie_curva_abc_w 	:= substr(obter_curva_abc_estab(cd_estabelecimento_p, cd_material_w, null, dt_mes_ref_w),1,1);

	if (ie_consignado_w = 'S') then
		begin
		select	coalesce(avg(vl_custo_medio),0)
		into STRICT	vl_custo_w
		from	fornecedor_mat_consignado
		where	cd_estabelecimento = cd_estabelecimento_p
		and	cd_material = cd_material_w
		and	dt_mesano_referencia = dt_mes_ref_w;

		if (coalesce(vl_custo_w,0) = 0) then
			vl_custo_w := obter_dados_ultima_compra(cd_estabelecimento_p, cd_material_w, 'VE');
		end if;

		vl_perda_w := coalesce(vl_custo_w,0) * qt_perda_w;
		end;
	end if;

	insert into eis_perda_material(
		nr_sequencia,
		dt_atualizacao,
		nm_usuario,
		cd_estabelecimento,
		dt_referencia,
		cd_setor_atendimento,
		cd_local_estoque,
		cd_centro_custo,
		ie_periodo,
		qt_perda,
		vl_perda,
		vl_consumo,
		cd_subgrupo_material,
		cd_grupo_material,
		cd_classe_material,
		cd_material,
		ie_tipo_perda,
		ie_padronizado,
		ie_curva_abc,
		ie_consignado,
		pr_perda)
	values (	nextval('eis_perda_material_seq'),
		clock_timestamp(),
		nm_usuario_p,
		cd_estabelecimento_p,
		dt_mes_ref_w,
		null,
		cd_local_estoque_w,
		cd_centro_custo_w,
		'M',
		qt_perda_w,
		vl_perda_w,
		vl_consumo_w,
		cd_subgrupo_material_w,
		cd_grupo_material_w,
		cd_classe_material_w,
		cd_material_w,
		ie_tipo_perda_w,
		ie_padronizado_w,
		ie_curva_abc_w,
		ie_consignado_w,
		pr_perda_w);
	end;
end loop;
close c01;

open c03;
loop
fetch c03 into
	cd_local_estoque_w,
	cd_centro_custo_w,
	cd_material_w,
	ie_consignado_w,
	qt_consumo_w,
	vl_consumo_w;
EXIT WHEN NOT FOUND; /* apply on c03 */
	begin
	vl_perda_w := 0;
	qt_perda_w := 0;

	select	cd_grupo_material,
		cd_subgrupo_material,
		cd_classe_material
	into STRICT	cd_grupo_material_w,
		cd_subgrupo_material_w,
		cd_classe_material_w
	from	estrutura_material_v
	where	cd_material = cd_material_w;

	ie_padronizado_w	:= substr(obter_se_material_padronizado(cd_estabelecimento_p, cd_material_w),1,1);
	ie_curva_abc_w 	:= substr(obter_curva_abc_estab(cd_estabelecimento_p, cd_material_w, null, dt_mes_ref_w),1,1);

	if (ie_consignado_w = 'S') then
		begin
		select	coalesce(avg(vl_custo_medio),0)
		into STRICT	vl_custo_w
		from	fornecedor_mat_consignado
		where	cd_estabelecimento = cd_estabelecimento_p
		and	cd_material = cd_material_w
		and	dt_mesano_referencia = dt_mes_ref_w;

		if (coalesce(vl_custo_w,0) = 0) then
			vl_custo_w := obter_dados_ultima_compra(cd_estabelecimento_p, cd_material_w, 'VE');
		end if;

		vl_consumo_w := coalesce(vl_custo_w,0) * qt_consumo_w;
		end;
	end if;

	insert into eis_perda_material(
		nr_sequencia,
		dt_atualizacao,
		nm_usuario,
		cd_estabelecimento,
		dt_referencia,
		cd_setor_atendimento,
		cd_local_estoque,
		cd_centro_custo,
		ie_periodo,
		qt_perda,
		vl_perda,
		vl_consumo,
		cd_subgrupo_material,
		cd_grupo_material,
		cd_classe_material,
		cd_material,
		ie_tipo_perda,
		ie_padronizado,
		ie_curva_abc,
		ie_consignado)
	values (	nextval('eis_perda_material_seq'),
		clock_timestamp(),
		nm_usuario_p,
		cd_estabelecimento_p,
		dt_mes_ref_w,
		null,
		cd_local_estoque_w,
		cd_centro_custo_w,
		'M',
		qt_perda_w,
		vl_perda_w,
		vl_consumo_w,
		cd_subgrupo_material_w,
		cd_grupo_material_w,
		cd_classe_material_w,
		cd_material_w,
		null,
		ie_padronizado_w,
		ie_curva_abc_w,
		ie_consignado_w);
	end;
end loop;
close c03;

delete	FROM eis_perda_material
where	vl_perda = 0
and	vl_consumo = 0
and	dt_referencia = dt_mes_ref_w
and	cd_estabelecimento	= cd_estabelecimento_p;

delete	FROM eis_perda_material
where	ie_periodo = 'A'
and	trunc(dt_referencia,'year') = trunc(dt_mes_ref_w,'year')
and	cd_estabelecimento	= cd_estabelecimento_p;

open c02;
loop
fetch c02 into
	cd_local_estoque_w,
	cd_centro_custo_w,
	qt_perda_w,
	vl_perda_w,
	vl_consumo_w,
	cd_subgrupo_material_w,
	cd_grupo_material_w,
	cd_classe_material_w,
	cd_material_w,
	ie_tipo_perda_w,
	ie_padronizado_w,
	ie_curva_abc_w,
	ie_consignado_w;
EXIT WHEN NOT FOUND; /* apply on c02 */
	begin
	insert into eis_perda_material(
		nr_sequencia,
		dt_atualizacao,
		nm_usuario,
		cd_estabelecimento,
		dt_referencia,
		cd_setor_atendimento,
		cd_local_estoque,
		cd_centro_custo,
		ie_periodo,
		qt_perda,
		vl_perda,
		vl_consumo,
		cd_subgrupo_material,
		cd_grupo_material,
		cd_classe_material,
		cd_material,
		ie_tipo_perda,
		ie_padronizado,
		ie_curva_abc,
		ie_consignado)
	values ( nextval('eis_perda_material_seq'),
		clock_timestamp(),
		nm_usuario_p,
		cd_estabelecimento_p,
		trunc(dt_mes_ref_w,'year'),
		null,
		cd_local_estoque_w,
		cd_centro_custo_w,
		'A',
		qt_perda_w,
		vl_perda_w,
		vl_consumo_w,
		cd_subgrupo_material_w,
		cd_grupo_material_w,
		cd_classe_material_w,
		cd_material_w,
		ie_tipo_perda_w,
		ie_padronizado_w,
		ie_curva_abc_w,
		ie_consignado_w);
	end;
end loop;
close c02;

commit;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_eis_perda_material ( dt_parametro_p timestamp, cd_estabelecimento_p bigint, nm_usuario_p text) FROM PUBLIC;

