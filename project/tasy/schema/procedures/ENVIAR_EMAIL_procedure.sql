-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE enviar_email ( ds_assunto_p text, ds_mensagem_p text, ds_email_origem_p text, ds_email_destino_p text, nm_usuario_p text, ie_prioridade_p text, ds_email_cco_p text default null) is /*
ie_prioriadade_p
A - Alta
M - Media
B - Baixa
*/
 ds_email_origem_w varchar(50) RETURNS varchar AS $body$
DECLARE


ie_chr13               varchar(15) := '@#$%(13)@#$%';
ie_chr10               varchar(15) := '@#$%(10)@#$%';
	
ds_retorno_w	varchar(32766);
	
BEGIN
ds_retorno_w	:= ds_valor_p;

ds_retorno_w    := replace(ds_retorno_w, chr(13), ie_chr13);
ds_retorno_w    := replace(ds_retorno_w, chr(10), ie_chr10);
ds_retorno_w    := replace(ds_retorno_w, ie_chr10||ie_chr13, utl_tcp.CRLF);
ds_retorno_w    := replace(ds_retorno_w, ie_chr13||ie_chr10, utl_tcp.CRLF);
ds_retorno_w    := replace(ds_retorno_w, ie_chr10, utl_tcp.CRLF);
ds_retorno_w    := replace(ds_retorno_w, ie_chr13, chr(13));

return ds_retorno_w;

end;

function MascaraTexto(ds_valor_p in varchar2)
 return varchar2 is
 nm_texto_log_w  varchar2(100);
begin
 nm_texto_log_w := '*** ***';

if (ds_valor_p IS NOT NULL AND ds_valor_p::text <> '') then
 nm_texto_log_w := null;
 for i in 1..length(ds_valor_p) loop
    begin
     if (( i <= 2 ) or (i > length(ds_valor_p)-1)) then
        nm_texto_log_w := nm_texto_log_w || substr(ds_valor_p,i,1);			
     else
        nm_texto_log_w := nm_texto_log_w || '*';
			end if;
    end;
	end loop;
 end if;
  return nm_texto_log_w;
end;

BEGIN

ds_assunto_ww      := substr(ds_assunto_p, 1, 32766);
ds_mensagem_ww      := substr(ds_mensagem_p, 1, 32766);

ds_servidor_envio2_w    := substr(obter_parametro_funcao(0,20,nm_usuario_p),1,60);
ds_user_id2_w        := substr(obter_parametro_funcao(0,38,nm_usuario_p),1,60);
ds_senha_smtp2_w      := substr(obter_parametro_funcao(0,40,nm_usuario_p),1,60);
ds_porta_serial_envio2_w  := substr(obter_parametro_funcao(0,109,nm_usuario_p),1,60);
ie_utilizar_ssl2_w      := substr(obter_parametro_funcao(0,110,nm_usuario_p),1,60);
ie_metodo_autenticacao_w   := substr(obter_parametro_funcao(0,125,nm_usuario_p),1,60);

if (coalesce(ie_metodo_autenticacao_w::text, '') = '') then
  ie_metodo_autenticacao_w := OBTER_VALOR_PARAM_USUARIO(0,125,Obter_perfil_Ativo,nm_usuario_p,wheb_usuario_pck.get_cd_estabelecimento);
end if;

ds_host_open_relay_w := OBTER_VALOR_PARAM_USUARIO(0,208,Obter_perfil_Ativo,nm_usuario_p,wheb_usuario_pck.get_cd_estabelecimento);
if (coalesce(ds_host_open_relay_w::text, '') = '') then
  ds_host_open_relay_w    := substr(obter_parametro_funcao(0,208,nm_usuario_p),1,60);
end if;


nr_porta_open_relay_w := OBTER_VALOR_PARAM_USUARIO(0,209,Obter_perfil_Ativo,nm_usuario_p,wheb_usuario_pck.get_cd_estabelecimento);
if (coalesce(nr_porta_open_relay_w::text, '') = '') then
  nr_porta_open_relay_w    := substr(obter_parametro_funcao(0,209,nm_usuario_p),1,60);
end if;


ie_autenticar_w := ('S' = OBTER_VALOR_PARAM_USUARIO(0,96,Obter_perfil_Ativo,nm_usuario_p,wheb_usuario_pck.get_cd_estabelecimento));
ie_tratar_crlf_w := substr(OBTER_VALOR_PARAM_USUARIO(0, 207, Obter_perfil_Ativo, nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento),1,1);

if (ie_tratar_crlf_w = 'R') then
  ds_assunto_ww		:= tratarQuebraTexto(ds_assunto_ww);
  ds_mensagem_ww  	:= tratarQuebraTexto(ds_mensagem_ww);
end if;



if (coalesce(ds_email_destino_p::text, '') = '') then
  CALL wheb_mensagem_pck.exibir_mensagem_abort(189136);
elsif (coalesce(ds_email_origem_p::text, '') = '') then
  begin
    select  max(ds_email)
    into STRICT  ds_email_origem_w
    from  usuario
    where  nm_usuario  = nm_usuario_p;
    if (coalesce(ds_email_origem_w::text, '') = '') then
      CALL wheb_mensagem_pck.exibir_mensagem_abort(189137,'NM_USUARIO='||nm_usuario_p);
    end if;
  end;
else
  ds_email_origem_w  := ds_email_origem_p;
end if;

/* Busca a senha do e-mail do cadastro de usuario*/

select  max(ds_senha_email),
  max(ds_conta_email)
into STRICT  ds_senha_email_usuario_w,
  ds_conta_email_w
from  usuario
where  nm_usuario  = nm_usuario_p;

if (ds_senha_email_usuario_w IS NOT NULL AND ds_senha_email_usuario_w::text <> '') then
  ds_senha_email_usuario_w := wheb_seguranca.decrypt(ds_senha_email_usuario_w);
end if;

if (ds_servidor_envio2_w IS NOT NULL AND ds_servidor_envio2_w::text <> '') then -- Piccini - 04/02/2011
  ds_smtp_w  := ds_servidor_envio2_w;
else
  ds_smtp_w := OBTER_VALOR_PARAM_USUARIO(0,20,0,nm_usuario_p,wheb_usuario_pck.get_cd_estabelecimento);
  if (coalesce(ds_smtp_w::text, '') = '') then
    select  ds_parametro
    into STRICT  ds_parametro_w
    from  funcao_parametro
    where  cd_funcao  = 0
    and  nr_sequencia  = 20;
    CALL wheb_mensagem_pck.exibir_mensagem_abort(189138,'DS_PARAMETRO='||ds_parametro_w);
  end if;
end  if;

/*Busca o ID de autenticacao do parametro*/

if (ds_conta_email_w IS NOT NULL AND ds_conta_email_w::text <> '') then
  ds_user_id_w := ds_conta_email_w;
elsif (ds_user_id2_w IS NOT NULL AND ds_user_id2_w::text <> '') then
  ds_user_id_w := ds_user_id2_w;
else
  ds_user_id_w := OBTER_VALOR_PARAM_USUARIO(0,38,Obter_perfil_Ativo,nm_usuario_p,wheb_usuario_pck.get_cd_estabelecimento);
  if (coalesce(ds_user_id_w::text, '') = '') and ( ie_autenticar_w ) then
    select  ds_parametro
    into STRICT  ds_parametro_w
    from  funcao_parametro
    where  cd_funcao  = 0
    and  nr_sequencia  = 38;
    CALL wheb_mensagem_pck.exibir_mensagem_abort(189138,'DS_PARAMETRO='||ds_parametro_w);
  end if;
end  if;

/*Busca senha do parametro somente se nao tiver senha cadastrada para o usuario*/
if (ds_senha_email_usuario_w IS NOT NULL AND ds_senha_email_usuario_w::text <> '') then
  ds_senha_smtp_w := ds_senha_email_usuario_w;
elsif (ds_senha_smtp2_w IS NOT NULL AND ds_senha_smtp2_w::text <> '') then
  ds_senha_smtp_w := ds_senha_smtp2_w;
else
  ds_senha_smtp_w := OBTER_VALOR_PARAM_USUARIO(0,40,Obter_perfil_Ativo,nm_usuario_p,wheb_usuario_pck.get_cd_estabelecimento);
  if (coalesce(ds_senha_smtp_w::text, '') = '') and ( ie_autenticar_w ) then
    select  ds_parametro
    into STRICT  ds_parametro_w
    from  funcao_parametro
    where  cd_funcao  = 0
    and  nr_sequencia  = 40;
    CALL wheb_mensagem_pck.exibir_mensagem_abort(189138,'DS_PARAMETRO='||ds_parametro_w);
  end if;
end if;

if (ie_prioridade_p = 'A') then
  qt_prioridade_w := 1;
elsif (ie_prioridade_p = 'M') then
  qt_prioridade_w := 3;
else
  qt_prioridade_w := 5;
end if;

ie_solic_receb_email_w   := OBTER_VALOR_PARAM_USUARIO(0,44,0,nm_usuario_p,wheb_usuario_pck.get_cd_estabelecimento);
if (ds_porta_serial_envio2_w IS NOT NULL AND ds_porta_serial_envio2_w::text <> '') then
  nr_porta_w  := ds_porta_serial_envio2_w;
else
  nr_porta_w  := OBTER_VALOR_PARAM_USUARIO(0,109,0,nm_usuario_p,wheb_usuario_pck.get_cd_estabelecimento);
end  if;

if (ie_utilizar_ssl2_w IS NOT NULL AND ie_utilizar_ssl2_w::text <> '') then
  ie_ssl_w  := ie_utilizar_ssl2_w;
else
  ie_ssl_w  := OBTER_VALOR_PARAM_USUARIO(0,110,0,nm_usuario_p,wheb_usuario_pck.get_cd_estabelecimento);
end  if;

if (ie_metodo_autenticacao_w in ( '4', '5')) and (ds_host_open_relay_w IS NOT NULL AND ds_host_open_relay_w::text <> '') and (nr_porta_open_relay_w IS NOT NULL AND nr_porta_open_relay_w::text <> '') then
  ds_smtp_w  := ds_host_open_relay_w;
  nr_porta_w  := nr_porta_open_relay_w;
  ie_ssl_w  := 'N';
  ie_autenticar_w  := false;
end if;

if ( ie_ssl_w = 'S') then

  ie_ssl_param_w := 'S';

  if (ie_metodo_autenticacao_w in ( '4', '5' )) then
    ie_ssl_param_w := 'T';
  end if;

  ds_parametro_log_w := 'enviar_email_ssl('||''''|| ds_assunto_ww||''''||','||''''||'ds_mensagem_ww'||''''||', '||''''||ds_email_origem_w||''''||', '||''''||replace(ds_email_destino_p,',',';')||''''||', '||''''||ds_user_id_w||''''||', '||''''||MascaraTexto(ds_senha_smtp_w)||''''||', '||''''||ds_smtp_w||''''||', '||''''||nr_porta_w||''''||', '||''''||ie_ssl_param_w||''''||', '||''''||ie_solic_receb_email_w||''''||', '||''''|| qt_prioridade_w||''''||');';

  CALL enviar_email_ssl(ds_assunto_ww,ds_mensagem_ww,ds_email_origem_w,replace(ds_email_destino_p,',',';'),ds_user_id_w,ds_senha_smtp_w,ds_smtp_w,nr_porta_w,ie_ssl_param_w,ie_solic_receb_email_w,qt_prioridade_w);
else
  if ie_autenticar_w then
   ie_ssl_param_w := 'True';
  else
   ie_ssl_param_w := 'False';
  end if;

  ds_parametro_log_w := 'enviar_email_utl_smtp('||''''||nm_usuario_p||''''||', '||''''||'ds_assunto_ww'||''''||', '||''''||'ds_mensagem_ww'||''''||', '||''''||ds_email_origem_w||''''||', '||''''||ds_email_destino_p||''''||', '||''''||ds_email_cco_p||''''||', '||''''||ds_user_id_w||''''||', '||''''||MascaraTexto(ds_senha_smtp_w)||''''||', '||''''||ds_smtp_w||''''||', '|| nr_porta_w||', '||ie_ssl_param_w||', '||''''||ie_solic_receb_email_w||''''||', '||''''||qt_prioridade_w||''''||');';

  CALL enviar_email_utl_smtp(nm_usuario_p, ds_assunto_ww, ds_mensagem_ww, ds_email_origem_w, ds_email_destino_p, ds_email_cco_p, ds_user_id_w, ds_senha_smtp_w, ds_smtp_w, nr_porta_w, ie_autenticar_w, ie_solic_receb_email_w, qt_prioridade_w);
end if;
Exception
  WHEN OTHERS THEN  
   begin 
      CALL gravar_log_tasy_prag( 4444, ds_parametro_log_w || ' SQLERRM='||sqlerrm, nm_usuario_p );
     CALL wheb_mensagem_pck.exibir_mensagem_abort(189139,'SQLERRM='||sqlerrm || chr(13) || chr(10) || chr(13) || chr(10) || 'StackTrace: ' || dbms_utility.format_error_backtrace);
   end;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE enviar_email ( ds_assunto_p text, ds_mensagem_p text, ds_email_origem_p text, ds_email_destino_p text, nm_usuario_p text, ie_prioridade_p text, ds_email_cco_p text default null) is  ds_email_origem_w varchar(50) FROM PUBLIC;

