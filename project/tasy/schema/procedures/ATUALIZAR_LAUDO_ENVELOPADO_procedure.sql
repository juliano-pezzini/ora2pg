-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE atualizar_laudo_envelopado ( nr_seq_laudo_p text, nm_usuario_p text, ds_erro_p INOUT text) AS $body$
DECLARE

qt_laudos_w  bigint;
qt_laudos_compl_w  bigint;
nr_seq_laudo_compl_w  bigint;


BEGIN

Select count(*)
into STRICT  qt_laudos_w
from  laudo_paciente
where  nr_sequencia = nr_seq_laudo_p;

Select  count(*)
into STRICT qt_laudos_compl_w
from  laudo_paciente_compl
where  nr_seq_laudo = nr_seq_laudo_p;


If (qt_laudos_w > 0) then
  Update Laudo_paciente
  set  dt_envelopado  = clock_timestamp(),
    nm_usuario   = nm_usuario_p
  where  nr_sequencia  = nr_seq_laudo_p;
else
  ds_erro_p := WHEB_MENSAGEM_PCK.get_texto(279586,'NR_SEQ_LAUDO='||to_char(nr_seq_laudo_p));
end if;

If (qt_laudos_compl_w > 0) then
  Update laudo_paciente_compl set NM_USUARIO_ENVELOPAMENTO = nm_usuario_p where nr_seq_laudo = nr_seq_laudo_p;
else
	select	nextval('laudo_paciente_compl_seq')
	 into STRICT	nr_seq_laudo_compl_w
	;

  insert into laudo_paciente_compl(NR_SEQUENCIA, NR_SEQ_LAUDO, DT_ATUALIZACAO, NM_USUARIO_ENVELOPAMENTO, NM_USUARIO) values (nr_seq_laudo_compl_w, nr_seq_laudo_p, clock_timestamp(), nm_usuario_p, nm_usuario_p);

end if;


commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE atualizar_laudo_envelopado ( nr_seq_laudo_p text, nm_usuario_p text, ds_erro_p INOUT text) FROM PUBLIC;

