-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE man_atualiza_serie_equipamento ( nr_seq_equipamento_p bigint, nr_serie_p text, nm_usuario_p text) AS $body$
DECLARE



nr_seq_nf_integ_w		bigint;
nr_seq_item_nf_integ_w	bigint;
ds_historico_w		varchar(4000);
nr_seq_tipo_w		bigint;
nr_serie_ant_w		varchar(30);


BEGIN

if (nr_seq_equipamento_p > 0) then
	begin
	select	nr_serie
	into STRICT	nr_serie_ant_w
	from	man_equipamento
	where	nr_sequencia = nr_seq_equipamento_p;

	update	man_equipamento
	set	nr_serie	 	= nr_serie_p,
		nm_usuario	= nm_usuario_p,
		dt_atualizacao	= clock_timestamp()
	where	nr_sequencia 	= nr_seq_equipamento_p;

	select	nr_seq_nf_integ,
		nr_seq_item_nf_integ
	into STRICT	nr_seq_nf_integ_w,
		nr_seq_item_nf_integ_w
	from	man_equipamento
	where	nr_sequencia = nr_seq_equipamento_p;

	select	man_obter_tipo_hist_equip_evt('S')
	into STRICT	nr_seq_tipo_w
	;
	/*'Alteração da série do equipamento de: ' || nr_serie_ant_w || ' para: ' || nr_serie_p || chr(13) || chr(10) ||
					'Data: ' || to_char(sysdate,'dd/mm/yyyy hh24:mi:ss')*/
	ds_historico_w := substr(wheb_mensagem_pck.get_texto(305941,'NR_SERIE_ANT_W='||nr_serie_ant_w||';NR_SERIE_P='||nr_serie_p||';DT_DATA_W='||PKG_DATE_FORMATERS.to_varchar(clock_timestamp(), 'timestamp', WHEB_USUARIO_PCK.GET_CD_ESTABELECIMENTO, nm_usuario_p)),1,4000);

	insert into man_equipamento_hist(
			nr_sequencia,
			nr_seq_equipamento,
			dt_historico,
			dt_atualizacao,
			nm_usuario,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			ds_historico,
			ie_origem,
			nr_seq_tipo)
		values (	nextval('man_equipamento_hist_seq'),
			nr_seq_equipamento_p,
			clock_timestamp(),
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			ds_historico_w,
			'S',
			nr_seq_tipo_w);

	if (nr_seq_nf_integ_w > 0) and (nr_seq_item_nf_integ_w > 0) then
		update	nota_fiscal_item
		set	ds_observacao 	= substr(ds_observacao || wheb_mensagem_pck.get_texto(305947,'NR_SERIE_P='||nr_serie_p),1,255)   --' Série alterada para: ' || nr_serie_p
		where	nr_sequencia 	= nr_seq_nf_integ_w
		and	nr_item_nf 	= nr_seq_item_nf_integ_w;
	end if;

	commit;
	end;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE man_atualiza_serie_equipamento ( nr_seq_equipamento_p bigint, nr_serie_p text, nm_usuario_p text) FROM PUBLIC;

