-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE sus_laudo_amb_befpost_eup ( nm_usuario_p text, cd_pessoa_fisica_p text, CD_PROCED_SOLIC_P bigint, ie_origem_proced_p bigint, ie_tipo_laudo_apac_p bigint, ds_msg_alerta_p INOUT text, ie_laudo_apac_p INOUT bigint) AS $body$
DECLARE

 
cd_estabelecimento_w		bigint;
ie_dias_alerta_laudo_w		bigint;			
nr_atend_laudo_w		bigint;
ds_msg_alerta_w			varchar(2000);	
ie_laudo_apac_w			bigint;	
ie_atualiza_laudo_apac_w	varchar(1);	
			 

BEGIN 
 
ie_dias_alerta_laudo_w := Obter_param_Usuario(916, 943, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_dias_alerta_laudo_w);
ie_atualiza_laudo_apac_w := Obter_param_Usuario(1124, 93, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_atualiza_laudo_apac_w);
 
if (coalesce(cd_proced_solic_p,0) > 0) then 
	if (cd_pessoa_fisica_p IS NOT NULL AND cd_pessoa_fisica_p::text <> '') and (coalesce(ie_dias_alerta_laudo_w,0) > 0) then 
		 
		select	coalesce(max(a.nr_atendimento),0) 
		into STRICT	nr_atend_laudo_w 
		from	sus_laudo_paciente a, 
			atendimento_paciente b 
		where	obter_dias_entre_datas(clock_timestamp(),a.dt_emissao) <= ie_dias_alerta_laudo_w 
		and	a.nr_atendimento = b.nr_atendimento 
		and	b.cd_pessoa_fisica = cd_pessoa_fisica_p 
		and	a.cd_procedimento_solic = cd_proced_solic_p;
		 
		if (nr_atend_laudo_w > 0) then 
		 
			ds_msg_alerta_w:= obter_texto_dic_objeto(289351, 1, 'CD_PROCED_SOLIC_P=' || cd_proced_solic_p) || chr(10) || 
					 obter_texto_dic_objeto(289352, 1, 'IE_DIAS_ALERTA_LAUDO_W=' || ie_dias_alerta_laudo_w || ';NR_ATEND_LAUDO_W=' ||nr_atend_laudo_w ) || chr(10) || 
					 obter_texto_tasy(289353, 1) || chr(10) || 
					 obter_texto_tasy(289354, 1);
		end if;	
 
	end if;
 
	if (coalesce(ie_tipo_laudo_apac_p,0) = 0) and (ie_atualiza_laudo_apac_w = 'S') then 
 
		ie_laudo_apac_w:= sus_obter_tipo_laudo_apac(cd_proced_solic_p,ie_origem_proced_p);
	end if;
 
end if;
ds_msg_alerta_p := ds_msg_alerta_w;
ie_laudo_apac_p := ie_laudo_apac_w;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE sus_laudo_amb_befpost_eup ( nm_usuario_p text, cd_pessoa_fisica_p text, CD_PROCED_SOLIC_P bigint, ie_origem_proced_p bigint, ie_tipo_laudo_apac_p bigint, ds_msg_alerta_p INOUT text, ie_laudo_apac_p INOUT bigint) FROM PUBLIC;

