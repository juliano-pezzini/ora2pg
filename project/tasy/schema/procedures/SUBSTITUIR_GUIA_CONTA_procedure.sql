-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE substituir_guia_conta ( nr_interno_conta_p bigint, nr_guia_ant_p text, nr_guia_nova_p text, ie_tipo_guia_p text, ie_toda_guia_p text, nm_usuario_p text, ie_altera_atendimento_p text, cd_setor_atendimento_p bigint, cd_cgc_prestador_p text, ds_observacao_p text) AS $body$
DECLARE

				 
nr_atendimento_w		bigint;
ie_alterar_guia_w		varchar(15);
cd_convenio_w		integer;
cd_estabelecimento_w	integer;
cd_cgc_prestador_w	varchar(14);
ie_altera_guia_partic_w	varchar(10);
ie_atualizar_doc_honor_w	varchar(255);
ie_atualizar_periodo_vig_w	varchar(1);
dt_periodo_inicial_w	timestamp;
dt_periodo_final_w		timestamp;
ie_altera_guia_princ_w	varchar(1);


BEGIN 
 
select	nr_atendimento, 
	cd_convenio_parametro, 
	cd_estabelecimento, 
	dt_periodo_inicial, 
	dt_periodo_final 
into STRICT	nr_atendimento_w, 
	cd_convenio_w, 
	cd_estabelecimento_w, 
	dt_periodo_inicial_w, 
	dt_periodo_final_w 
from	conta_paciente 
where	nr_interno_conta = nr_interno_conta_p;
 
ie_alterar_guia_w		:= coalesce(obter_valor_param_usuario(67, 279, obter_perfil_ativo, nm_usuario_p,0),'S');
ie_altera_guia_partic_w	:= coalesce(obter_valor_param_usuario(67, 310, obter_perfil_ativo, nm_usuario_p,0),'S');
ie_atualizar_doc_honor_w	:= coalesce(obter_valor_param_usuario(67, 352, obter_perfil_ativo, nm_usuario_p,0),'S');
ie_atualizar_periodo_vig_w	:= coalesce(obter_valor_param_usuario(67, 414, obter_perfil_ativo, nm_usuario_p,0),'S');
ie_altera_guia_princ_w	:= coalesce(obter_valor_param_usuario(67, 423, obter_perfil_ativo, nm_usuario_p,0),'S');
 
cd_cgc_prestador_w	:= coalesce(cd_cgc_prestador_p,'0');
 
if (ie_alterar_guia_w	= 'D') then 
	select	coalesce(max(ie_substituir_guia),'S') 
	into STRICT	ie_alterar_guia_w 
	from	convenio_estabelecimento 
	where	cd_convenio		= cd_convenio_w 
	and	cd_estabelecimento	= cd_estabelecimento_w;
end if;
 
 
 
update	conta_paciente 
set 	cd_autorizacao = nr_guia_nova_p, 
	ie_tipo_guia = ie_tipo_guia_p, 
	ds_observacao = CASE WHEN ds_observacao_p = NULL THEN  ds_observacao  ELSE substr(ds_observacao || ' ' || ds_observacao_p,1,255) END  
where 	nr_interno_conta = nr_interno_conta_p;
 
 
if (ie_alterar_guia_w	= 'S') then 
 
	if (ie_toda_guia_p = 'S')	then 
		update 	material_atend_paciente 
		set 	nr_doc_convenio	= nr_guia_nova_p, 
			ie_tipo_guia	= ie_tipo_guia_p 
		where 	nr_interno_conta	= nr_interno_conta_p 
		and	((coalesce(cd_cgc_prestador,cd_cgc_prestador_w) = cd_cgc_prestador_w) or (cd_cgc_prestador_w = '0'));
		 
		update 	procedimento_paciente 
		set 	nr_doc_convenio	= nr_guia_nova_p, 
			ie_tipo_guia	= ie_tipo_guia_p 
		where 	nr_interno_conta	= nr_interno_conta_p 
		and	((coalesce(cd_cgc_prestador,cd_cgc_prestador_w) = cd_cgc_prestador_w) or (cd_cgc_prestador_w = '0'));
 
		if (ie_atualizar_doc_honor_w = 'S') then 
 
			update 	procedimento_paciente 
			set 	nr_doc_honor_conv	= nr_guia_nova_p 
			where 	nr_interno_conta		= nr_interno_conta_p 
			and	((coalesce(cd_cgc_prestador,cd_cgc_prestador_w) = cd_cgc_prestador_w) or (cd_cgc_prestador_w = '0'));
		end if;
		 
		delete	from proc_paciente_tiss a 
		where	a.nr_seq_procedimento in (SELECT	b.nr_sequencia 
			from	procedimento_paciente b 
			where	b.nr_interno_conta 	= nr_interno_conta_p) 
		and	a.ds_campo in ('NR_GUIA_PRESTADOR','NR_GUIA_PRESTADOR_HONOR');
		 
		if (ie_altera_guia_partic_w	= 'S') then 
			update	procedimento_participante a 
			set	nr_doc_honor_conv	= nr_guia_nova_p 
			where	nr_sequencia in (	SELECT 	x.nr_sequencia 
							from 	procedimento_paciente x 
							where	x.nr_interno_conta	= nr_interno_conta_p 
							and	((coalesce(x.cd_cgc_prestador,cd_cgc_prestador_w) = cd_cgc_prestador_w) or (cd_cgc_prestador_w = '0')));
		end if;
		 
	else	 
		update 	material_atend_paciente 
		set 	nr_doc_convenio		= nr_guia_nova_p, 
			ie_tipo_guia		= ie_tipo_guia_p 
		where 	nr_interno_conta		= nr_interno_conta_p 
		and	nr_doc_convenio		= nr_guia_ant_p 
		and	cd_setor_atendimento	= coalesce(cd_setor_atendimento_p,cd_setor_atendimento) 
		and	((coalesce(cd_cgc_prestador,cd_cgc_prestador_w) = cd_cgc_prestador_w) or (cd_cgc_prestador_w = '0'));
		 
		update 	procedimento_paciente 
		set 	nr_doc_convenio 	= nr_guia_nova_p, 
			ie_tipo_guia 	= ie_tipo_guia_p 
		where 	nr_interno_conta 	= nr_interno_conta_p 
		and	nr_doc_convenio 	= nr_guia_ant_p 
		and	cd_setor_atendimento	= coalesce(cd_setor_atendimento_p,cd_setor_atendimento) 
		and	((coalesce(cd_cgc_prestador,cd_cgc_prestador_w) = cd_cgc_prestador_w) or (cd_cgc_prestador_w = '0'));
 
		if (ie_atualizar_doc_honor_w = 'S') then 
 
			update 	procedimento_paciente 
			set 	nr_doc_honor_conv	= nr_guia_nova_p 
			where 	nr_interno_conta = nr_interno_conta_p 
			and	nr_doc_convenio = nr_guia_ant_p 
			and	cd_setor_atendimento	= coalesce(cd_setor_atendimento_p,cd_setor_atendimento) 
			and	((coalesce(cd_cgc_prestador,cd_cgc_prestador_w) = cd_cgc_prestador_w) or (cd_cgc_prestador_w = '0'));
 
		end if;
		 
		delete	from proc_paciente_tiss a 
		where	a.nr_seq_procedimento in (SELECT	b.nr_sequencia 
			from	procedimento_paciente b 
			where	b.nr_interno_conta 	= nr_interno_conta_p 
			and	b.nr_doc_convenio	= nr_guia_ant_p 
			and	b.cd_setor_atendimento	= coalesce(cd_setor_atendimento_p,cd_setor_atendimento)) 
		and	a.ds_campo in ('NR_GUIA_PRESTADOR','NR_GUIA_PRESTADOR_HONOR');
		 
		if (ie_altera_guia_partic_w	= 'S') then 
		 
			update	procedimento_participante a 
			set	nr_doc_honor_conv	= nr_guia_nova_p 
			where	nr_sequencia in (	SELECT 	x.nr_sequencia 
							from 	procedimento_paciente x 
							where	x.nr_interno_conta	= nr_interno_conta_p 
							and	cd_setor_atendimento	= coalesce(cd_setor_atendimento_p,cd_setor_atendimento)) 
			and	nr_doc_honor_conv = nr_guia_ant_p;
		end if;
	end if;
 
	if (ie_altera_atendimento_p = 'S') then 
		 
		if (coalesce(ie_atualizar_periodo_vig_w,'N') = 'S') then 
		 
			update	atend_categoria_convenio a 
			set	a.nr_doc_convenio	 = nr_guia_nova_p, 
				a.nm_usuario		 = nm_usuario_p, 
				a.dt_atualizacao	 = clock_timestamp(), 
				ie_tipo_guia		= ie_tipo_guia_p 
			where	a.nr_seq_interno	 = 
				(SELECT	max(x.nr_seq_interno) 
				from	atend_categoria_convenio x 
				where	x.nr_atendimento = nr_atendimento_w 
				and	x.dt_inicio_vigencia between dt_periodo_inicial_w and fim_dia(dt_periodo_final_w) 
				and	coalesce(x.dt_final_vigencia, x.dt_inicio_vigencia) between dt_periodo_inicial_w and fim_dia(dt_periodo_final_w));
		 
		else 
		 
			update	atend_categoria_convenio a 
			set	a.nr_doc_convenio	 = nr_guia_nova_p, 
				a.nm_usuario		 = nm_usuario_p, 
				a.dt_atualizacao	 = clock_timestamp(), 
				ie_tipo_guia		= ie_tipo_guia_p 
			where	a.nr_seq_interno	 = 
				(SELECT	max(x.nr_seq_interno) 
				from	atend_categoria_convenio x 
				where	x.nr_atendimento = nr_atendimento_w);
		end if;
		 
		if (coalesce(ie_altera_guia_princ_w, 'N') = 'S') then 
		 
			update	atend_categoria_convenio a 
			set	a.nr_doc_conv_principal	 = nr_guia_nova_p, 
				a.nm_usuario		 = nm_usuario_p, 
				a.dt_atualizacao	 = clock_timestamp(), 
				ie_tipo_guia		= ie_tipo_guia_p 
			where	a.nr_seq_interno	 = 
				(SELECT	max(x.nr_seq_interno) 
				from	atend_categoria_convenio x 
				where	x.nr_atendimento = nr_atendimento_w);
		 
		end if;
			 
	end if;
end if;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE substituir_guia_conta ( nr_interno_conta_p bigint, nr_guia_ant_p text, nr_guia_nova_p text, ie_tipo_guia_p text, ie_toda_guia_p text, nm_usuario_p text, ie_altera_atendimento_p text, cd_setor_atendimento_p bigint, cd_cgc_prestador_p text, ds_observacao_p text) FROM PUBLIC;

