-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE tasy_ajustar_base_clinico ( nm_usuario_p text) AS $body$
DECLARE


dt_versao_atual_cliente_w 	timestamp;
qt_registro_w					bigint;
nm_usuario_w					varchar(15);
cd_barras_w						varchar(40);
cd_medico_w						varchar(10);
nr_crm_w							varchar(40);
contador_w						bigint;
nr_sequencia_w					bigint;
qt_oe_paqui_nasal_w			real;
qt_oe_paqui_temp_w			real;


c01 CURSOR FOR
	SELECT	nm_usuario,
				cd_barras
	from		usuario
	where		(cd_barras IS NOT NULL AND cd_barras::text <> '');
	
c02 CURSOR FOR
	SELECT	cd_pessoa_fisica,
				nr_crm
	from		medico
	where		(nr_crm IS NOT NULL AND nr_crm::text <> '');
	
c03 CURSOR FOR
	SELECT 	nr_sequencia,
				qt_oe_paqui_nasal,
				qt_oe_paqui_temp
	from 		oft_paquimetria
	where		((QT_OE_PAQUI_NASAL IS NOT NULL AND QT_OE_PAQUI_NASAL::text <> '') or (QT_OE_PAQUI_TEMP IS NOT NULL AND QT_OE_PAQUI_TEMP::text <> ''))
	and		coalesce(IE_TIPO_PAQUIMETRIA,'S') = 'S'
	order by dt_atualizacao desc;
	



BEGIN
/*FAVOR COLOCAR OS NOVOS AJUSTES SEMPRE NO FINAL DA PROCEDURE.*/


/*AJUSTES DE BASE DO GRUPO CLINICO */

CALL abortar_se_base_wheb();

dt_versao_atual_cliente_w := coalesce(TO_DATE(TO_CHAR(obter_data_geracao_versao-1,'dd/mm/yyyy') ||' 23:59:59','dd/mm/yyyy hh24:mi:ss'),clock_timestamp() - interval '90 days');

if (dt_versao_atual_cliente_w < to_date('21/07/2009','dd/mm/yyyy')) then
	begin
	CALL exec_sql_dinamico('Dalcastagne', 'alter table  prescr_recomendacao modify (DS_RECOMENDACAO varchar2(2000))');
	end;
end if;

if (dt_versao_atual_cliente_w < to_date('18/03/2011','dd/mm/yyyy')) then
	begin

	select	count(*)
	into STRICT	qt_registro_w
	from	user_tab_columns
	where	table_name		= 'MEDIC_CLEARANCE_CREAT'
	and	column_name		= 'DS_DOSAGEM'
	and	upper(data_type)	= 'LONG';
	
	if (qt_registro_w = 0) then
		CALL Exec_Sql_Dinamico('Dalcastagne','alter table MEDIC_CLEARANCE_CREAT add DS_DOSAGEM_long long');
		CALL Exec_Sql_Dinamico('Dalcastagne','update MEDIC_CLEARANCE_CREAT set DS_DOSAGEM_long = DS_DOSAGEM');
		CALL Exec_Sql_Dinamico('Dalcastagne','alter table MEDIC_CLEARANCE_CREAT drop column DS_DOSAGEM');
		CALL Exec_Sql_Dinamico('Dalcastagne','alter table MEDIC_CLEARANCE_CREAT rename column DS_DOSAGEM_long to DS_DOSAGEM');
		
	end if;
	exception
		when others then
		null;
	end;
end if;

if (dt_versao_atual_cliente_w < to_date('30/06/2016','dd/mm/yyyy')) then
	begin

	select	count(*)
	into STRICT	qt_registro_w
	from	user_tab_columns
	where	table_name		= 'REGRA_PRAZO_AGENDAMENTO'
	and		column_name		= 'DS_MENSAGEM';
	
	if (qt_registro_w = 0) then
		CALL Exec_Sql_Dinamico('Tasy','alter table REGRA_PRAZO_AGENDAMENTO drop column DS_MENSAGEM');	
	end if;
	exception
		when others then
		null;
	end;
end if;




if (dt_versao_atual_cliente_w < to_date('29/03/2011','dd/mm/yyyy')) then
	begin

	select	count(*)
	into STRICT	qt_registro_w
	from	user_tab_columns
	where	table_name			= 'APA_EVOLUCAO'
	and		column_name			= 'DS_EVOLUCAO'
	and		upper(data_type)	= 'LONG';
	
	if (qt_registro_w = 0) then
		CALL Exec_Sql_Dinamico('Wilbert','alter table APA_EVOLUCAO add DS_EVOLUCAO_long long');
		CALL Exec_Sql_Dinamico('Wilbert','update APA_EVOLUCAO set DS_EVOLUCAO_long = DS_EVOLUCAO');
		CALL Exec_Sql_Dinamico('Wilbert','alter table APA_EVOLUCAO drop column DS_EVOLUCAO');
		CALL Exec_Sql_Dinamico('Wilbert','alter table APA_EVOLUCAO rename column DS_EVOLUCAO_long to DS_EVOLUCAO');
	end if;
	exception
		when others then
		null;
	end;
end if;

if (dt_versao_atual_cliente_w < to_date('08/11/2011','dd/mm/yyyy')) then
	begin

	select	count(*)
	into STRICT	qt_registro_w
	from	user_tab_columns
	where	table_name		= 'EIS_CIRURGIA'
	and	column_name		= 'CD_MOTIVO_CANCELAMENTO'
	and	upper(data_type)	= 'VARCHAR2';
	
	if (qt_registro_w = 0) then
		CALL Exec_Sql_Dinamico('Wilbert','alter table EIS_CIRURGIA add CD_MOTIVO_CANCELAMENTO_VA VARCHAR2(15)');
		CALL Exec_Sql_Dinamico('Wilbert','update EIS_CIRURGIA set CD_MOTIVO_CANCELAMENTO_VA = to_char(CD_MOTIVO_CANCELAMENTO) where CD_MOTIVO_CANCELAMENTO is not null');
		CALL Exec_Sql_Dinamico('Wilbert','alter table EIS_CIRURGIA drop column CD_MOTIVO_CANCELAMENTO');
		CALL Exec_Sql_Dinamico('Wilbert','alter table EIS_CIRURGIA rename column CD_MOTIVO_CANCELAMENTO_VA to CD_MOTIVO_CANCELAMENTO');
	end if;
	exception
		when others then
		null;
	end;
end if;

if (dt_versao_atual_cliente_w < to_date('27/02/2012','dd/mm/yyyy')) then
	begin
	select	count(*)
	into STRICT	qt_registro_w
	from	oftalmologia_item
	where	ds_item = 'Cruva tensional';
	
	if (qt_registro_w = 1) then
		CALL Exec_Sql_Dinamico('tfferretti',' update oftalmologia_item set ds_item = ''Curva tensional'' where ds_item = ''Cruva tensional'' ');
	end if;
	exception
		when others then
		null;
	end;
end if;

if (dt_versao_atual_cliente_w < to_date('11/04/2012','dd/mm/yyyy')) then
	begin
	SELECT  COUNT(*)
	into STRICT	qt_registro_w
	FROM 	tab
	WHERE 	tname = 'LOG_IMPRESSAO_AGENDA';
	
	if (qt_registro_w > 0) then
		CALL Exec_sql_Dinamico('crdossi','DROP TABLE LOG_IMPRESSAO_AGENDA');
	end if;
	exception
		when others then
		null;
	end;
end if;

if (dt_versao_atual_cliente_w < to_date('20/04/2012','dd/mm/yyyy')) then
	begin
	select	count(*)
	into STRICT	qt_registro_w
	from	oftalmologia_item
	where	ds_item = 'Óculos';
	
	if (qt_registro_w = 1) then
		CALL Exec_Sql_Dinamico('crdossi',' update oftalmologia_item set ds_item = ''Receita de óculos'' where ds_item = ''Óculos'' ');
	end if;
	exception
		when others then
		null;
	end;
end if;

if (dt_versao_atual_cliente_w < to_date('20/04/2012','dd/mm/yyyy')) then
	begin
	select	count(*)
	into STRICT	qt_registro_w
	from	oftalmologia_item
	where	ds_item = 'Ceratoscopia';
	
	if (qt_registro_w = 1) then
		CALL Exec_Sql_Dinamico('crdossi',' update oftalmologia_item set ds_item = ''Ceratometria'' where ds_item = ''Ceratoscopia'' ');
	end if;
	exception
		when others then
		null;
	end;
end if;

if (dt_versao_atual_cliente_w < to_date('20/04/2012','dd/mm/yyyy')) then
	begin
	select	count(*)
	into STRICT	qt_registro_w
	from	oftalmologia_item
	where	ds_item = 'Topografia corneana';
	
	if (qt_registro_w = 1) then
		CALL Exec_Sql_Dinamico('crdossi',' update oftalmologia_item set ds_item = ''Ceratoscopia computadorizada'' where ds_item = ''Topografia corneana'' ');
	end if;
	exception
		when others then
		null;
	end;
end if;

if (dt_versao_atual_cliente_w < to_date('20/04/2012','dd/mm/yyyy')) then
	begin
	select	count(*)
	into STRICT	qt_registro_w
	from	oftalmologia_item
	where	ds_item = 'Lentes';
	
	if (qt_registro_w = 1) then
		CALL Exec_Sql_Dinamico('crdossi',' update oftalmologia_item set ds_item = ''Seleção de lentes'' where ds_item = ''Lentes'' ');
	end if;
	exception
		when others then
		null;
	end;
end if;

if (dt_versao_atual_cliente_w < to_date('25/04/2012','dd/mm/yyyy')) then
	begin
	select	count(*)
	into STRICT	qt_registro_w
	from	oftalmologia_item
	where	ds_item = 'Exame externo';
	
	if (qt_registro_w = 1) then
		CALL Exec_Sql_Dinamico('crdossi',' update oftalmologia_item set ds_item = ''Exame ocular externo'' where ds_item = ''Exame externo'' ');
	end if;
	exception
		when others then
		null;
	end;
end if;

if (dt_versao_atual_cliente_w < to_date('22/05/2012','dd/mm/yyyy')) then
	begin

	select	count(*)
	into STRICT	qt_registro_w
	from	user_tab_columns
	where	table_name		= 'PRESCR_ORTESE_MS'
	and	column_name		= 'IE_ABDUTOR_POLEGAR';
	
	if (qt_registro_w > 0) then
		CALL Exec_Sql_Dinamico('Wilbert','alter table PRESCR_ORTESE_MS drop column IE_ABDUTOR_POLEGAR');
		CALL Exec_Sql_Dinamico('Wilbert','alter table PRESCR_ORTESE_MS drop column IE_ADAPTACAO_ESCRITA');
		CALL Exec_Sql_Dinamico('Wilbert','alter table PRESCR_ORTESE_MS drop column IE_ADAPTACAO_COMPUTADOR');
		CALL Exec_Sql_Dinamico('Wilbert','alter table PRESCR_ORTESE_MS drop column IE_COCK_UP');
		CALL Exec_Sql_Dinamico('Wilbert','alter table PRESCR_ORTESE_MS drop column IE_EXTENSOR_COTOVELO');
		CALL Exec_Sql_Dinamico('Wilbert','alter table PRESCR_ORTESE_MS drop column IE_OUTROS');
		CALL Exec_Sql_Dinamico('Wilbert','alter table PRESCR_ORTESE_MS drop column IE_POSICAO_PUNHO_DEDOS');
	end if;
	exception
		when others then
		null;
	end;
end if;

if (dt_versao_atual_cliente_w < to_date('01/06/2012','dd/mm/yyyy')) then
	begin

	select	count(*)
	into STRICT	qt_registro_w
	from	user_tab_columns
	where	table_name			= 'TASY_GLOSSARIO'
	and		column_name			= 'DS_SIGNIFICADO'
	and		upper(data_type)	= 'LONG';
	
	if (qt_registro_w = 0) then
		CALL Exec_Sql_Dinamico('crdossi','alter table tasy_glossario add ds_significado_long long');
		CALL Exec_Sql_Dinamico('crdossi','update tasy_glossario set ds_significado_long = ds_significado');
		CALL Exec_Sql_Dinamico('crdossi','alter table tasy_glossario drop column ds_significado');
		CALL Exec_Sql_Dinamico('crdossi','alter table tasy_glossario rename column ds_significado_long to ds_significado');
	end if;
	exception
		when others then
		null;
	end;
end if;

if (dt_versao_atual_cliente_w < to_date('29/08/2012','dd/mm/yyyy')) then
	begin
	CALL Exec_Sql_Dinamico('rzimmermann','update agenda_paciente_envio set dt_envio = dt_envio');	
	exception
		when others then
		null;
	end;
end if;

if (dt_versao_atual_cliente_w < to_date('05/11/2012','dd/mm/yyyy')) then
	begin

	select	count(*)
	into STRICT	qt_registro_w
	from	user_constraints
	where	constraint_name = 'WAGPRAD_MEDICO_FK';
	if (qt_registro_w > 0) then
		begin
		CALL Exec_sql_Dinamico('lwilbert', 'alter table W_AGENDA_PROC_ADIC drop constraint WAGPRAD_MEDICO_FK');
		end;
	end if;
	
	select	count(*)
	into STRICT	qt_registro_w
	from	user_indexes
	where	index_name = 'WAGPRAD_MEDICO_FK_I'
	and	table_name = 'W_AGENDA_PROC_ADIC';
	if (qt_registro_w > 0) then
		begin
		CALL Exec_sql_Dinamico('lwilbert', 'drop index WAGPRAD_MEDICO_FK_I');
		end;
	end if;

	select	count(*)
	into STRICT	qt_registro_w
	from	user_indexes
	where	index_name = 'WAGPRAD_PESFISI_FK2_I'
	and	table_name = 'W_AGENDA_PROC_ADIC';
	
	if (qt_registro_w = 0) then
		begin
		CALL Exec_sql_Dinamico('lwilbert', 'Create Index WAGPRAD_PESFISI_FK2_I on W_AGENDA_PROC_ADIC(CD_MEDICO)');
		end;
	end if;	

	exception
		when others then
		null;
	end;
end if;

if (dt_versao_atual_cliente_w < to_date('03/12/2012','dd/mm/yyyy')) then
	begin
	select	COUNT(*)
	into STRICT	qt_registro_w
	FROM 	FUNCAO_PARAMETRO 
	WHERE 	cd_funcao 	= 871 
	AND 	nr_sequencia 	= 729;
	
	if (qt_registro_w = 0) then
		INSERT INTO FUNCAO_PARAMETRO( 	CD_FUNCAO, NR_SEQUENCIA, DS_PARAMETRO, DT_ATUALIZACAO
						, NM_USUARIO, NR_SEQ_APRESENTACAO, IE_NIVEL_LIBERACAO, NR_SEQ_AGRUP, IE_SITUACAO_DELPHI
						, IE_SITUACAO_SWING, IE_AUDITORIA, NR_SEQ_CLASSIFICACAO, DT_ATUALIZACAO_NREC, NM_USUARIO_NREC
						, NR_SEQ_ORDEM, DT_LIBERACAO, NM_USUARIO_LIB )
		VALUES ( 
						871, 729, 'E-mail padrão do destinatário na tela de "Enviar e-mail" na pasta "Planejamento consignados"'
						,  TO_Date( '03/12/2012 17:44:51', 'DD/MM/YYYY HH24:MI:SS'), 'lwilbert', 500
						, 'Q', 428, 'A', 'A', 'N', 7,  TO_Date( '03/12/2012 17:24:44', 'DD/MM/YYYY HH24:MI:SS')
						, 'lwilbert', 515973,  TO_Date( '03/12/2012 17:44:51', 'DD/MM/YYYY HH24:MI:SS')
						, 'Edilson');
		COMMIT;
	end if;	

	exception
		when others then
		null;
	end;
end if;

if (dt_versao_atual_cliente_w < to_date('19/12/2012','dd/mm/yyyy')) then
	begin
	SELECT	COUNT(*)
	into STRICT	qt_registro_w
	FROM 	PEPO_SV
	WHERE 	NM_TABELA 	= 'ATENDIMENTO_SINAL_VITAL'
	AND 	NM_ATRIBUTO = 'DT_SINAL_VITAL'
	AND		QT_TAMANHO 	= 110;
	
	if (qt_registro_w > 0) then
		CALL Exec_Sql_Dinamico('Dalcastagne','UPDATE PEPO_SV SET QT_TAMANHO = 95 WHERE NM_TABELA = ''ATENDIMENTO_SINAL_VITAL''	AND NM_ATRIBUTO = ''DT_SINAL_VITAL''');		
	end if;
	
	
	end;
end if;

if (dt_versao_atual_cliente_w < to_date('18/03/2013','dd/mm/yyyy')) then
	begin
	select	count(*)
	into STRICT	qt_registro_w
	from	INTEGRIDADE_REFERENCIAL
	WHERE 	NM_INTEGRIDADE_REFERENCIAL = 'PREMATDE_PRESMAT_FK';
		
	if (qt_registro_w > 0) then
		CALL Exec_Sql_Dinamico('lwilbert','DELETE INTEGRIDADE_REFERENCIAL WHERE NM_INTEGRIDADE_REFERENCIAL = ''PREMATDE_PRESMAT_FK''');
		CALL exec_sql_dinamico('lwilbert','ALTER TABLE PRESCR_MATERIAL_DEVOLUCAO DROP CONSTRAINT PREMATDE_PRESMAT_FK');		
	end if;
	
	end;
end if;

if (dt_versao_atual_cliente_w < to_date('26/09/2013','dd/mm/yyyy')) then
	begin
	select	count(*)
	into STRICT 	qt_registro_w
	from 	user_cons_columns
	where 	CONSTRAINT_NAME = 'CHEPROL_CHEPROC_FK'
	and 	column_name = 'CD_PERFIL';
		
	if (qt_registro_w > 0) then
		CALL exec_sql_dinamico('Dalcastagne','ALTER TABLE CHECKLIST_PROCESSO_LIB DROP CONSTRAINT CHEPROL_CHEPROC_FK');		
	end if;
	
	end;
end if;

if (dt_versao_atual_cliente_w < to_date('13/11/2013','dd/mm/yyyy')) then
	begin
	select	count(*)
	into STRICT	qt_registro_w
	from	user_constraints
	where	constraint_name = 'WPRMEDI_MATERIA_FK';
	if (qt_registro_w > 0) then
		begin
		CALL Exec_sql_Dinamico('Dalcastagne','alter table W_PRESCR_MEDICA_INTERACAO drop constraint	WPRMEDI_MATERIA_FK');
		CALL Exec_sql_Dinamico('Dalcastagne','alter table W_PRESCR_MEDICA_INTERACAO drop constraint	WPRMEDI_MATERIA_FK2');
		CALL Exec_sql_Dinamico('Dalcastagne','alter table W_PRESCR_MEDICA_INTERACAO drop constraint	WPRMEDI_MEDFITE_FK');
		CALL Exec_sql_Dinamico('Dalcastagne','alter table W_PRESCR_MEDICA_INTERACAO drop constraint	WPRMEDI_PESFISI_FK');
		CALL Exec_sql_Dinamico('Dalcastagne','alter table W_PRESCR_MEDICA_INTERACAO drop constraint	WPRMEDI_PRESMED_FK');
		end;
	end if;
	end;
end if;

if (dt_versao_atual_cliente_w < to_date('18/03/2013','dd/mm/yyyy')) then
	begin
	select	count(*)
	into STRICT	qt_registro_w
	from	INTEGRIDADE_REFERENCIAL a,
			INTEGRIDADE_ATRIBUTO b
	WHERE 	b.nm_tabela = a.nm_tabela
	and		b.NM_INTEGRIDADE_REFERENCIAL = a.NM_INTEGRIDADE_REFERENCIAL
	and		b.NM_INTEGRIDADE_REFERENCIAL = 'TRPRAT_PESFISI_FK2'
	and		b.NM_ATRIBUTO = 'CD_PESSOA_FISICA';
		
	if (qt_registro_w > 0) then
		CALL Exec_Sql_Dinamico('Dalcastagne','DELETE INTEGRIDADE_REFERENCIAL WHERE NM_INTEGRIDADE_REFERENCIAL = ''TRPRAT_PESFISI_FK2''');
		CALL exec_sql_dinamico('Dalcastagne','DELETE INDICE WHERE NM_INDICE = ''TRPRAT_PESFISI_FK2_I''');		
	end if;
	
	end;
end if;

if (dt_versao_atual_cliente_w < to_date('11/02/2014','dd/mm/yyyy')) then
	SELECT	COUNT(*)
	INTO STRICT	qt_registro_w
	FROM	user_objects
	WHERE	object_name = 'MANCHESTER_GERAR_DADOS';
		
	if (qt_registro_w > 0) then
		CALL Exec_sql_Dinamico('lwilbert', 'DROP PROCEDURE MANCHESTER_GERAR_DADOS'
);
	end if;
end if;	

if (dt_versao_atual_cliente_w < to_date('16/09/2014','dd/mm/yyyy')) then
	SELECT COUNT(*)
	INTO STRICT	qt_registro_w
	FROM   funcao_parametro
	WHERE  cd_funcao = 3010 
	AND    nr_sequencia = 121;
		
	if (qt_registro_w > 0) then
		CALL Exec_sql_Dinamico('lwilbert', 'delete from funcao_parametro where cd_funcao = 3010 and nr_sequencia = 121');
	end if;
end if;	

if (dt_versao_atual_cliente_w < to_date('09/10/2014','dd/mm/yyyy')) then
	begin

	select	count(*)
	into STRICT	qt_registro_w
	from	user_constraints
	where	constraint_name = 'MEDAVPA_ATEPACU_FK';
	if (qt_registro_w > 0) then
		begin
		CALL Exec_sql_Dinamico('lwilbert', 'alter table MED_AVALIACAO_PACIENTE drop constraint MEDAVPA_ATEPACU_FK');
		end;
	end if;
	end;
end if;	

begin
if (dt_versao_atual_cliente_w < to_date('11/02/2015','dd/mm/yyyy')) then
	begin

	select	count(*)
	into STRICT	qt_registro_w
	from   	perfil_item_oftalmologia
	where   ((nr_seq_superior = 238) or (nr_seq_item = 238));
	
	if (qt_registro_w = 0) then
		begin
		CALL Exec_sql_Dinamico('lwilbert', 'DELETE FROM CONFIGURACAO_OFT_RESUMO WHERE NR_SEQ_ITEM = 238');
		CALL Exec_sql_Dinamico('lwilbert', 'DELETE FROM OFTALMOLOGIA_ITEM WHERE nr_sequencia = 238');
		end;
	end if;
	end;
end if;	
exception
	when others then
	null;
end;

begin
if (dt_versao_atual_cliente_w < to_date('24/09/2015','dd/mm/yyyy')) then
	contador_w := 0;
	select	count(*)
	into STRICT		qt_registro_w
	from   	oft_paquimetria;
	if (qt_registro_w > 0) then
		open C03;
		loop
		fetch C03 into	
			nr_sequencia_w,
			qt_oe_paqui_nasal_w,
			qt_oe_paqui_temp_w;
		EXIT WHEN NOT FOUND; /* apply on c03 */
			begin
			contador_w := contador_w + 1;
			update	oft_paquimetria
			set		qt_oe_paqui_nasal = qt_oe_paqui_temp_w,
						qt_oe_paqui_temp	= qt_oe_paqui_nasal_w
			where		nr_sequencia		= nr_sequencia_w;
			if (contador_w > 100) then
				commit;
				contador_w := 0;
			end if;	
			end;
		end loop;
		close c03;	
		commit;
	end if;
end if;	
exception
	when others then
	null;
end;

if (dt_versao_atual_cliente_w < to_date('05/01/2016','dd/mm/yyyy')) then
	select	count(*)
	into STRICT		qt_registro_w
	from		oftalmologia_item
	where		coalesce(ie_situacao_swing::text, '') = '';
	
	if (qt_registro_w > 0) then
		update	oftalmologia_item
		set		ie_situacao_swing = 'I'
		where		nr_sequencia in (4,233);
		
		update	oftalmologia_item
		set		ie_situacao_swing = 'A'
		where		coalesce(ie_situacao_swing::text, '') = '';
		commit;
	end if;
end if;

if (dt_versao_atual_cliente_w < to_date('05/01/2016','dd/mm/yyyy')) then
	select	count(*)
	into STRICT		qt_registro_w
	from		oftalmologia_item
	where		coalesce(ie_situacao_delphi::text, '') = '';
	
	if (qt_registro_w > 0) then
		update	oftalmologia_item
		set		ie_situacao_delphi 	= 'I'
		where		nr_sequencia 			= 273;
		
		update	oftalmologia_item
		set		ie_situacao_delphi = 'A'
		where		coalesce(ie_situacao_delphi::text, '') = '';
		commit;
	end if;
end if;

if (dt_versao_atual_cliente_w < to_date('05/01/2016','dd/mm/yyyy')) then
	select	count(*)
	into STRICT		qt_registro_w
	from		pepo_item
	where		coalesce(ie_situacao_swing::text, '') = '';
	
	if (qt_registro_w > 0) then		
		update	pepo_item
		set		ie_situacao_swing = 'A'
		where		coalesce(ie_situacao_swing::text, '') = '';
		commit;
	end if;
end if;

if (dt_versao_atual_cliente_w < to_date('05/01/2016','dd/mm/yyyy')) then
	select	count(*)
	into STRICT		qt_registro_w
	from		pepo_item
	where		coalesce(ie_situacao_delphi::text, '') = '';
	
	if (qt_registro_w > 0) then
		update	pepo_item
		set		ie_situacao_delphi 	= 'I'
		where		nr_sequencia 			= 104;
		
		update	pepo_item
		set		ie_situacao_delphi = 'A'
		where		coalesce(ie_situacao_delphi::text, '') = '';
		commit;
	end if;
end if;

if (dt_versao_atual_cliente_w < to_date('05/01/2016','dd/mm/yyyy')) then
	select	count(*)
	into STRICT		qt_registro_w
	from		fanep_item
	where		coalesce(ie_situacao_swing::text, '') = '';
	
	if (qt_registro_w > 0) then		
		update	fanep_item
		set		ie_situacao_swing = 'A'
		where		coalesce(ie_situacao_swing::text, '') = '';
		commit;
	end if;
end if;

if (dt_versao_atual_cliente_w < to_date('05/01/2016','dd/mm/yyyy')) then
	select	count(*)
	into STRICT		qt_registro_w
	from		fanep_item
	where		coalesce(ie_situacao_delphi::text, '') = '';
	
	if (qt_registro_w > 0) then	
		update	fanep_item
		set		ie_situacao_delphi = 'A'
		where		coalesce(ie_situacao_delphi::text, '') = '';
		commit;
	end if;
end if;

if (dt_versao_atual_cliente_w < to_date('05/01/2016','dd/mm/yyyy')) then
	select	count(*)
	into STRICT		qt_registro_w
	from		fanep_item
	where		coalesce(ie_situacao_delphi::text, '') = '';
	
	if (qt_registro_w > 0) then	
		update	fanep_item
		set		ie_situacao_delphi = 'A'
		where		coalesce(ie_situacao_delphi::text, '') = '';
		commit;
	end if;
end if;

if (dt_versao_atual_cliente_w < to_date('29/01/2016', 'dd/mm/yyyy')) then
	begin
	select	count(*)
	into STRICT	qt_registro_w
	from	user_tab_columns
	where	table_name	= 'CAN_ORDEM_ITEM_PRESCR'
	and	column_name	= 'QT_DOSE'
	and	data_scale	= 4;

	if (qt_registro_w = 0) then
		begin

		qt_registro_w := obter_valor_dinamico('select count(*) from CAN_ORDEM_ITEM_PRESCR', qt_registro_w);
		
		if (qt_registro_w = 0) then
			CALL exec_sql_dinamico('LWILBERT','alter table CAN_ORDEM_ITEM_PRESCR modify QT_DOSE number(15,4)');
		else
			begin
				
			/*Criar atributo backup*/

			CALL exec_sql_dinamico('LWILBERT','alter table CAN_ORDEM_ITEM_PRESCR add QT_DOSE_B number(15,4)');
			/*Atualiza o backup */

			CALL exec_sql_dinamico('LWILBERT','update CAN_ORDEM_ITEM_PRESCR set QT_DOSE_B = QT_DOSE');
			commit;
			/*Limpa o campo atual */

			CALL exec_sql_dinamico('LWILBERT','alter table CAN_ORDEM_ITEM_PRESCR modify QT_DOSE null');
			
			CALL exec_sql_dinamico('LWILBERT','update CAN_ORDEM_ITEM_PRESCR set QT_DOSE = null');
			commit;
			
			CALL exec_sql_dinamico('LWILBERT','alter table CAN_ORDEM_ITEM_PRESCR modify QT_DOSE number(15,4)');
			
			CALL exec_sql_dinamico('LWILBERT','update CAN_ORDEM_ITEM_PRESCR set QT_DOSE = QT_DOSE_B');
			commit;
			
			CALL exec_sql_dinamico('LWILBERT','alter table CAN_ORDEM_ITEM_PRESCR modify QT_DOSE NOT null');
			
			CALL exec_sql_dinamico('LWILBERT','alter table CAN_ORDEM_ITEM_PRESCR drop column QT_DOSE_B');
			end;
		end if;
		end;
	end if;
	end;
end if;
	
if (dt_versao_atual_cliente_w < to_date('21/03/2016','dd/mm/yyyy')) then
	begin
	
		select	count(*)
		into STRICT	qt_registro_w
		from	med_tipo_avaliacao
		where	ie_evolucao_clinica not in (SELECT distinct cd_tipo_evolucao from tipo_evolucao)
		and		(nm_usuario_resp IS NOT NULL AND nm_usuario_resp::text <> '');
		
		if (qt_registro_w > 0) then	
			update	med_tipo_avaliacao
			set		ie_evolucao_clinica  = NULL
			where	ie_evolucao_clinica not in (SELECT distinct cd_tipo_evolucao from tipo_evolucao)
			and		(ie_evolucao_clinica IS NOT NULL AND ie_evolucao_clinica::text <> '');
			commit;
			
			CALL exec_sql_dinamico('ejrsilva', ' alter table MED_TIPO_AVALIACAO enable constraint MEDTIAV_TIPEVOL_FK ');
			
		end if;	
		
exception
		when others then
		null;
	end;
	
end if;	

if (dt_versao_atual_cliente_w < to_date('21/03/2016', 'dd/mm/yyyy')) then

	begin
	
		select	count(*)
		into STRICT	qt_registro_w
		from	integridade_referencial
		where	nm_tabela					= 'PRESCR_OPM_COMPONENTE'
		and		nm_integridade_referencial	= 'PROPCOM_MATLOFO_FK';
		
		if (qt_registro_w > 0) then
		
			delete	FROM integridade_atributo
			where	nm_tabela 					= 'PRESCR_OPM_COMPONENTE'
			and		nm_integridade_referencial 	= 'PROPCOM_MATLOFO_FK';
			commit;	

			delete	FROM integridade_referencial
			where	nm_tabela 					= 'PRESCR_OPM_COMPONENTE'
			and		nm_integridade_referencial 	= 'PROPCOM_MATLOFO_FK';
			commit;		
		
			delete	FROM indice_atributo
			where	nm_tabela = 'PRESCR_OPM_COMPONENTE'
			and		nm_indice = 'PROPCOM_MATLOFO_FK';
			commit;	
		
			delete	FROM indice
			where	nm_tabela = 'PRESCR_OPM_COMPONENTE'
			and		nm_indice = 'PROPCOM_MATLOFO_FK';
			commit;
			
			delete	FROM indice 
			where	nm_tabela = 'PRESCR_OPM_COMPONENTE'
			and		nm_indice = 'PROPCOM_MATLOFO_FK_I';
			commit;
			
			SELECT	COUNT(*)
			into STRICT	qt_registro_w
			FROM	user_ind_columns 
			WHERE	table_name = 'PRESCR_OPM_COMPONENTE' 
			AND		index_name = 'PROPCOM_MATLOFO_FK_I';
			
			if (qt_registro_w > 0) then
				CALL Exec_sql_Dinamico('ejrsilva',' alter table PRESCR_OPM_COMPONENTE drop constraint PROPCOM_MATLOFO_FK_I ');
			end if;	
			
			SELECT	COUNT(*)
			into STRICT	qt_registro_w
			FROM	user_ind_columns
			WHERE	table_name = 'PRESCR_OPM_COMPONENTE' 
			AND		index_name = 'PROPCOM_MATLOFO_FK';
			
			if (qt_registro_w > 0) then
				CALL Exec_sql_Dinamico('ejrsilva',' alter table PRESCR_OPM_COMPONENTE drop constraint PROPCOM_MATLOFO_FK ');
			end if;	
			
		end if;	
					
		exception
		when others then
		null;
	end;
	
end if;

if (dt_versao_atual_cliente_w < to_date('21/03/2016', 'dd/mm/yyyy')) then
	begin
	select	count(*)
	into STRICT	qt_registro_w
	from	user_constraints
	where	constraint_name		= 'OFTMARE_PK'
	and	table_name		= 'OFT_MAPEAMENTO_RETINA';
	
	if (qt_registro_w > 0) then
		CALL Exec_sql_Dinamico('lwilbert', 'ALTER TABLE OFT_CONSULTA_IMAGEM DROP CONSTRAINT OFTCOIM_OFMARET_FK');
		CALL Exec_sql_Dinamico('lwilbert', 'ALTER TABLE OFT_IMAGEM_EXAME DROP CONSTRAINT OFTIMEX_OFMARET_FK');
		CALL Exec_sql_Dinamico('lwilbert', 'ALTER TABLE OFT_MAPEAMENTO_RETINA DROP CONSTRAINT OFTMARE_PK');
		CALL Exec_sql_Dinamico('lwilbert', 'Alter Table OFT_MAPEAMENTO_RETINA add ( Constraint OFMARET_PK Primary Key (NR_SEQUENCIA) Using Index Tablespace TASY_INDEX)');
		CALL Exec_sql_Dinamico('lwilbert', 'Create  Index OFMARET_PK on OFT_MAPEAMENTO_RETINA(NR_SEQUENCIA)');
		CALL Exec_sql_Dinamico('lwilbert', 'Alter Table OFT_IMAGEM_EXAME add (Constraint OFTIMEX_OFMARET_FK Foreign Key ( NR_SEQ_MAPEAMENTO) References OFT_MAPEAMENTO_RETINA (NR_SEQUENCIA) on delete cascade)');
		CALL Exec_sql_Dinamico('lwilbert', 'Alter Table OFT_CONSULTA_IMAGEM add ( Constraint OFTCOIM_OFMARET_FK Foreign Key ( NR_SEQ_MAPEAMENTO) References OFT_MAPEAMENTO_RETINA (NR_SEQUENCIA) on delete cascade)');
	end if;	
	exception
		when others then
		null;
	end;
end if;

if (dt_versao_atual_cliente_w < to_date('30/03/2016', 'dd/mm/yyyy')) then
	begin
	SELECT	COUNT(*)
	into STRICT	qt_registro_w
	FROM	user_constraints
	WHERE	constraint_name		= 'OFTMARE_PESFISI_FK'
	AND	table_name		= 'OFT_MAPEAMENTO_RETINA';

	if (qt_registro_w > 0) then
		CALL Exec_sql_Dinamico('lwilbert', 'ALTER TABLE OFT_MAPEAMENTO_RETINA DROP CONSTRAINT OFTMARE_PESFISI_FK');
		CALL Exec_sql_Dinamico('lwilbert', 'Alter Table OFT_MAPEAMENTO_RETINA add (Constraint OFMARET_PESFISI_FK Foreign Key (CD_PROFISSIONAL) References PESSOA_FISICA (CD_PESSOA_FISICA))');
	end if;	
	
	SELECT	COUNT(*)
	into STRICT	qt_registro_w
	FROM	user_constraints
	WHERE	constraint_name		= 'OFTMARE_OFTCONS_FK'
	AND	table_name		= 'OFT_MAPEAMENTO_RETINA';

	if (qt_registro_w > 0) then
		CALL Exec_sql_Dinamico('lwilbert', 'ALTER TABLE OFT_MAPEAMENTO_RETINA DROP CONSTRAINT OFTMARE_OFTCONS_FK');
		CALL Exec_sql_Dinamico('lwilbert', 'Alter Table OFT_MAPEAMENTO_RETINA add (Constraint OFMARET_OFTCONS_FK Foreign Key (NR_SEQ_CONSULTA) References OFT_CONSULTA (NR_SEQUENCIA) on delete cascade)');
	end if;	
	exception
		when others then
		null;
	end;
end if;	

if (dt_versao_atual_cliente_w < to_date('30/03/2016', 'dd/mm/yyyy')) then
	begin
	select	count(*)
	into STRICT	qt_registro_w
	from	MED_TIPO_AVALIACAO
	where (coalesce(IE_GERAR_EVOLUCAO,'N') <> 'N') and (coalesce(IE_GERAR_EVOLUCAO,'N') <> 'S');
	
	if (qt_registro_w > 0) then
		CALL Exec_Sql_Dinamico('lwilbert',' update MED_TIPO_AVALIACAO set IE_GERAR_EVOLUCAO = ''S'' where nvl(IE_GERAR_EVOLUCAO,''N'') <> ''N''');
	end if;
	exception
		when others then
		null;
	end;
end if;	

if (dt_versao_atual_cliente_w < to_date('01/10/2016', 'dd/mm/yyyy')) then
	begin
	SELECT COUNT(*)
	into STRICT	qt_registro_w
	FROM  PEPO_SINAL_VITAL
	WHERE coalesce(ie_situacao::text, '') = '';
	
	if (qt_registro_w > 0) then
		CALL Exec_Sql_Dinamico('lwilbert',' update PEPO_SINAL_VITAL set ie_situacao = ''A'' where ie_situacao is null');
	end if;
	exception
		when others then
		null;
	end;
end if;

if (dt_versao_atual_cliente_w < to_date('28/09/2018','dd/mm/yyyy')) then
	CALL Exec_sql_Dinamico('ahkienolt', ' update     tabela_atributo set    IE_OBRIGATORIO = ''N'' where    nm_tabela = ''PROCEDIMENTO_PFLEGEGRAD'' and    nm_atributo = ''IE_ERFOLGTER''');
	CALL Exec_Sql_Dinamico('ahkienolt', ' alter table PROCEDIMENTO_PFLEGEGRAD modify IE_ERFOLGTER null');		
end if;

if (dt_versao_atual_cliente_w < to_date('05/10/2018','dd/mm/yyyy')) then
	CALL Exec_sql_Dinamico('jlweigmann', ' update     tabela_atributo set    IE_OBRIGATORIO = ''N'' where    nm_tabela = ''ADEP_SV'' and    nm_atributo = ''NR_SEQ_INTERVENCAO''');
	CALL Exec_Sql_Dinamico('jlweigmann', ' alter table ADEP_SV modify NR_SEQ_INTERVENCAO null');		
end if;

begin

CALL Exec_Sql_Dinamico('ejrsilva',' ALTER TABLE  CONCLUSAO_RECOM_APAE MODIFY (DS_DADOS_CLINICOS_COMPL VARCHAR2(4000)) ');

exception
	when others then
	null;
end;

if (dt_versao_atual_cliente_w < to_date('16/07/2019','dd/mm/yyyy')) then
	begin

	select	count(*)
	into STRICT	qt_registro_w
	from	user_tab_columns
	where	table_name		= 'OFT_CONSULTA'
	and	column_name		= 'DT_INICIO_CONSULTA';
		
	if (qt_registro_w = 1) then
		CALL Exec_Sql_Dinamico('lwilbert','update oft_consulta set DT_INICIO_CONSULTA = DT_CONSULTA where DT_INICIO_CONSULTA is null');
	end if;
	exception
		when others then
		null;
	end;
end if;




end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE tasy_ajustar_base_clinico ( nm_usuario_p text) FROM PUBLIC;

