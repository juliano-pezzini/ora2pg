-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE obter_valor_mat_ordem_consig ( cd_estabelecimento_p bigint, cd_fornecedor_consignado_p text, cd_material_p bigint, nr_ordem_compra_p bigint, nr_prescricao_p bigint, nr_atendimento_p bigint, ie_tipo_atendimento_p text, nr_seq_agenda_p bigint, dt_atualizacao_p timestamp, nr_seq_lote_fornec_p bigint, cd_convenio_p bigint, cd_categoria_p bigint, dt_vigencia_p timestamp, vl_unitario_material_p INOUT bigint) AS $body$
DECLARE



nr_sequencia_w				regra_valor_ordem_consig.nr_sequencia%type;
cd_grupo_material_w			grupo_material.cd_grupo_material%type;
cd_subgrupo_material_w			subgrupo_material.cd_subgrupo_material%type;
cd_classe_material_w			classe_material.cd_classe_material%type;
ie_valor_consignado_w			regra_preco_ordem_consig.ie_valor_consignado%type := 'N';
vl_unitario_material_w			ordem_compra_item.vl_unitario_material%type	:= 0;
vl_preco_tabela_w			preco_material.vl_preco_venda%type;
qt_conv_compra_estoque_w		material.qt_conv_compra_estoque%type;
qt_conv_estoque_consumo_w		material.qt_conv_estoque_consumo%type;
cd_tab_preco_mat_consig_w		parametro_compras.cd_tab_preco_mat_consig%type;
dt_utl_vigencia_w			timestamp;
cd_tab_preco_mat_w			bigint;
ie_origem_preco_w			bigint;
nr_seq_bras_preco_w			bigint;
nr_seq_mat_bras_w			bigint;
nr_seq_conv_bras_w			bigint;
nr_seq_conv_simpro_w			bigint;
nr_seq_mat_simpro_w			bigint;
nr_seq_simpro_preco_w			bigint;
nr_seq_ajuste_mat_w			bigint;
nr_seq_marca_w				marca.nr_sequencia%type;
nr_cirurgia_w				cirurgia.nr_cirurgia%type;
nr_seq_agenda_w				agenda_paciente.nr_sequencia%type;
cd_convenio_w				convenio.cd_convenio%type;
ie_preco_sus_oc_w			varchar(1);

c01 CURSOR FOR
SELECT	nr_sequencia
from	regra_valor_ordem_consig
where	cd_estabelecimento = cd_estabelecimento_p
and	coalesce(cd_grupo_material, cd_grupo_material_w)		= cd_grupo_material_w
and	coalesce(cd_subgrupo_material, cd_subgrupo_material_w)	= cd_subgrupo_material_w
and	coalesce(cd_classe_material, cd_classe_material_w)		= cd_classe_material_w
and (coalesce(cd_material, cd_material_p) 			= cd_material_p or cd_material_p = 0)
and	((coalesce(cd_cnpj, cd_fornecedor_consignado_p)		= cd_fornecedor_consignado_p) or (coalesce(cd_cnpj::text, '') = ''))
order by
	coalesce(cd_material, 0),
	coalesce(cd_classe_material, 0),
	coalesce(cd_subgrupo_material, 0),
	coalesce(cd_grupo_material, 0),
	coalesce(cd_cnpj, 'xxx');

c02 CURSOR FOR
SELECT	ie_valor_consignado
from	regra_preco_ordem_consig
where	nr_seq_regra = nr_sequencia_w
order by nr_seq_prioridade;


BEGIN

nr_seq_agenda_w := coalesce(nr_seq_agenda_p,0);
cd_convenio_w	:= cd_convenio_p;

select	a.cd_grupo_material,
	a.cd_subgrupo_material,
	a.cd_classe_material
into STRICT	cd_grupo_material_w,
	cd_subgrupo_material_w,
	cd_classe_material_w
from	estrutura_material_v a
where	a.cd_material = cd_material_p;

select	qt_conv_compra_estoque,
	qt_conv_estoque_consumo
into STRICT 	qt_conv_compra_estoque_w,
	qt_conv_estoque_consumo_w
from 	material
where 	cd_material = coalesce(cd_material_p,0);

select	cd_tab_preco_mat_consig
into STRICT	cd_tab_preco_mat_consig_w
from	parametro_compras
where	cd_estabelecimento = cd_estabelecimento_p;

open C01;
loop
fetch C01 into
	nr_sequencia_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	/*Busca a sequencia da regra de preco de acordo com as informacoes do material*/

	nr_sequencia_w := nr_sequencia_w;
	end;
end loop;
close C01;

if (nr_sequencia_w > 0) then

	/*Esse cursor serve para bucar o preco conforme a regra, seguindo a prioridade.
	Quando ele encontra o valor, ele sai fora do cursor. Enquanto o valor e zero, ele vai tentando buscar o preco*/
	open C02;
	loop
	fetch C02 into
		ie_valor_consignado_w;
	EXIT WHEN NOT FOUND or vl_unitario_material_w > 0;  /* apply on C02 */
		begin


		/*Tabela de precos*/

		if (coalesce(vl_unitario_material_w,0) = 0) and (ie_valor_consignado_w	= 'T') then

			select	coalesce(max(a.vl_preco_venda),0)
			into STRICT	vl_preco_tabela_w
			from	preco_material a
			where	a.cd_material		= cd_material_p
			and	a.cd_estabelecimento	= cd_estabelecimento_p
			and	a.cd_cgc_fornecedor	= cd_fornecedor_consignado_p
			and	a.cd_tab_preco_mat	= coalesce(cd_tab_preco_mat_consig_w,a.cd_tab_preco_mat)
			and	a.ie_situacao		= 'A'
			and	a.dt_inicio_vigencia	= (
				SELECT	max(b.dt_inicio_vigencia)
				from	preco_material b
				where	b.cd_material		= a.cd_material
				and	b.cd_cgc_fornecedor	= a.cd_cgc_fornecedor
				and	b.cd_estabelecimento	= a.cd_estabelecimento
				and	b.ie_situacao		= 'A'
				and	b.cd_tab_preco_mat	= coalesce(cd_tab_preco_mat_consig_w,a.cd_tab_preco_mat));

			if (vl_preco_tabela_w <> 0) then
				vl_unitario_material_w 	:= vl_preco_tabela_w;
			end if;

			vl_unitario_material_w	:= (vl_unitario_material_w * qt_conv_compra_estoque_w * qt_conv_estoque_consumo_w);
		end if;

		/*Preco convenio*/

		if (coalesce(vl_unitario_material_w,0) = 0) and (ie_valor_consignado_w	= 'P') then

			if (coalesce(nr_seq_lote_fornec_p,0) <> 0) then
				select	max(nr_seq_marca)
				into STRICT	nr_seq_marca_w
				from	material_lote_fornec
				where	nr_sequencia = nr_seq_lote_fornec_p;
			end if;

			SELECT * FROM define_preco_material(	cd_estabelecimento_p, 	-- cd_estabelecimento_p		number,
						cd_convenio_w,           -- cd_convenio_p          	number,
						cd_categoria_p,          -- cd_categoria_p         	varchar2,
						dt_vigencia_p,           -- dt_vigencia_p          	date,
						cd_material_p,           -- cd_material_p          	number,
						0,                       -- cd_tipo_acomodacao_p   	number,
						0,                       -- ie_tipo_atendimento_p  	number,
						0,                       -- cd_setor_atendimento_p 	number,
						null,                    -- cd_cgc_fornecedor_p		varchar2,
						0,                       -- qt_idade_p			number,
						0,                       -- nr_sequencia_p		number,
						null,                    -- cd_plano_p			varchar2,
						null,                    -- cd_proc_referencia_p		number,
						null,                    -- ie_origem_proc_p		number,
						nr_seq_marca_w,          -- nr_seq_marca_p		number,
						null,                    -- ie_clinica_p			number,
						null,                    -- nr_seq_classif_atend_p	number,
						nr_atendimento_p,        -- nr_atendimento_p		number,
						null,                    -- ie_vago_4_p			varchar2,
						vl_unitario_material_w,  -- vl_material_p      	 out 	number,
						dt_utl_vigencia_w,       -- dt_ult_vigencia_p  	 out 	date,
						cd_tab_preco_mat_w,      -- cd_tab_preco_mat_p 	 out 	number,
						ie_origem_preco_w,       -- ie_origem_preco_p  	 out 	number,
						nr_seq_bras_preco_w,     -- nr_seq_bras_preco_p	 out	number,
						nr_seq_mat_bras_w,       -- nr_seq_mat_bras_p	 out	number,
						nr_seq_conv_bras_w,      -- nr_seq_conv_bras_p	 out	number,
						nr_seq_conv_simpro_w,    -- nr_seq_conv_simpro_p	 out	number,
						nr_seq_mat_simpro_w,     -- nr_seq_mat_simpro_p	 out	number,
						nr_seq_simpro_preco_w,   -- nr_seq_simpro_preco_p out	number,
						nr_seq_ajuste_mat_w) INTO STRICT 
						vl_unitario_material_w, 
						dt_utl_vigencia_w, 
						cd_tab_preco_mat_w, 
						ie_origem_preco_w, 
						nr_seq_bras_preco_w, 
						nr_seq_mat_bras_w, 
						nr_seq_conv_bras_w, 
						nr_seq_conv_simpro_w, 
						nr_seq_mat_simpro_w, 
						nr_seq_simpro_preco_w, 
						nr_seq_ajuste_mat_w;   -- nr_seq_ajuste_mat_p	 out	number
			vl_unitario_material_w	:= (vl_unitario_material_w * qt_conv_compra_estoque_w * qt_conv_estoque_consumo_w);
		end if;


		/*Autorizacao (Valor do fornecedor)*/

		if (coalesce(vl_unitario_material_w,0) = 0) and (ie_valor_consignado_w	= 'F') then

			if (coalesce(nr_seq_agenda_w,0) = 0) then

				select	coalesce(max(nr_cirurgia),0)
				into STRICT	nr_cirurgia_w
				from	ordem_compra
				where	nr_ordem_compra = nr_ordem_compra_p;

				if (nr_cirurgia_w > 0) then
					select	coalesce(max(a.nr_sequencia),0)
					into STRICT	nr_seq_agenda_w
					from	agenda_paciente a,
						cirurgia b
					where	a.nr_cirurgia	= b.nr_cirurgia
					and	b.nr_cirurgia	= nr_cirurgia_w;
				end if;
			end if;

			select	coalesce(max(c.vl_unitario_cotado),0)
			into STRICT	vl_unitario_material_w
			from	material_autor_cirurgia b,
				autorizacao_cirurgia a,
				material_autor_cir_cot c
			where	a.nr_sequencia	= b.nr_seq_autorizacao
			and	b.cd_material	= cd_material_p
			and	a.nr_seq_agenda	= nr_seq_agenda_w
			and 	b.nr_sequencia 	= c.nr_sequencia
			and 	c.cd_cgc	= cd_fornecedor_consignado_p
			and	((coalesce(a.nr_prescricao,0) = coalesce(nr_prescricao_p,0)) or (coalesce(nr_prescricao_p,0) = 0));
		end if;


		/*Autorizacao (Valor autorizado)*/

		if (coalesce(vl_unitario_material_w,0) = 0) and (ie_valor_consignado_w	= 'A') then

			if (coalesce(nr_seq_agenda_w,0) = 0) then

				select	coalesce(max(nr_cirurgia),0)
				into STRICT	nr_cirurgia_w
				from	ordem_compra
				where	nr_ordem_compra = nr_ordem_compra_p;

				if (nr_cirurgia_w > 0) then
					select	coalesce(max(a.nr_sequencia),0)
					into STRICT	nr_seq_agenda_w
					from	agenda_paciente a,
						cirurgia b
					where	a.nr_cirurgia	= b.nr_cirurgia
					and	b.nr_cirurgia	= nr_cirurgia_w;
				end if;
			end if;


			select	coalesce(max(b.vl_unitario_material),0)
			into STRICT	vl_unitario_material_w
			from	material_autor_cirurgia b,
				autorizacao_cirurgia a
			where	a.nr_sequencia	= b.nr_seq_autorizacao
			and	b.cd_material	= cd_material_p
			and	a.nr_seq_agenda	= nr_seq_agenda_w
			and	b.ie_valor_informado = 'S';
		end if;


		/*Ultima compra*/

		if (coalesce(vl_unitario_material_w,0) = 0) and (ie_valor_consignado_w	= 'U') then

			select	coalesce(max(dividir((a.vl_total_item_nf - a.vl_desconto - vl_desconto_rateio + vl_frete + a.vl_despesa_acessoria + a.vl_seguro),a.qt_item_estoque)),0)
			into STRICT	vl_unitario_material_w
			from 	nota_fiscal_item a
			where 	a.cd_material  = cd_material_p
			and 	a.nr_sequencia =
				(SELECT max(i.nr_sequencia)
				from	nota_fiscal_item i,
					nota_fiscal n,
					operacao_nota p
				where	i.nr_sequencia = n.nr_sequencia
				and	i.cd_material  = cd_material_p
				and 	coalesce(p.ie_ultima_compra,'S') 	= 'S'
				and	p.cd_operacao_nf = n.cd_operacao_nf
				and	n.ie_situacao = '1'
				and	n.cd_cgc = cd_fornecedor_consignado_p);

			vl_unitario_material_w	:= (vl_unitario_material_w * qt_conv_compra_estoque_w);
		end if;


		/*OPM com o procedimento SUS*/

		if (coalesce(vl_unitario_material_w,0) = 0) and (ie_valor_consignado_w	= 'O') then

			select	coalesce(sus_obter_preco_proced(cd_estabelecimento_p, clock_timestamp(), 1, obter_proced_mat_esp_sus(cd_material_p), 7, 1),0)
			into STRICT	vl_unitario_material_w
			;
		end if;

		/*Autorizacao de materiais especiais*/

		if (coalesce(vl_unitario_material_w,0) = 0) and (ie_valor_consignado_w = 'E') then

			if (coalesce(cd_convenio_w::text, '') = '') then
				cd_convenio_w := obter_convenio_atendimento(nr_atendimento_p);
			end if;
			vl_unitario_material_w := obter_preco_conv_mat_fornec(cd_convenio_w, cd_fornecedor_consignado_p, cd_material_p, dt_atualizacao_p, vl_unitario_material_w);
		end if;

		/*Autorizacao sem prescricao (Valor do fornecedor)*/

		if (coalesce(vl_unitario_material_w,0) = 0) and (ie_valor_consignado_w	= 'D') then
			if (coalesce(nr_seq_agenda_w,0) = 0) then

				select	coalesce(max(nr_cirurgia),0)
				into STRICT	nr_cirurgia_w
				from	ordem_compra
				where	nr_ordem_compra = nr_ordem_compra_p;

				if (nr_cirurgia_w > 0) then
					select	coalesce(max(a.nr_sequencia),0)
					into STRICT	nr_seq_agenda_w
					from	agenda_paciente a,
						cirurgia b
					where	a.nr_cirurgia	= b.nr_cirurgia
					and	b.nr_cirurgia	= nr_cirurgia_w;
				end if;
			end if;

			select	coalesce(max(c.vl_unitario_cotado),0)
			into STRICT	vl_unitario_material_w
			from	material_autor_cirurgia b,
				autorizacao_cirurgia a,
				material_autor_cir_cot c
			where	a.nr_sequencia	= b.nr_seq_autorizacao
			and	b.cd_material	= cd_material_p
			and	a.nr_seq_agenda	= nr_seq_agenda_w
			and 	b.nr_sequencia 	= c.nr_sequencia
			and 	c.cd_cgc	= cd_fornecedor_consignado_p;
		end if;

        /* Contrato */

        if (coalesce(vl_unitario_material_w, 0) = 0) and (ie_valor_consignado_w = 'C') then
        begin
           select    coalesce(c.vl_saldo_total, c.vl_pagto)
           into STRICT      vl_unitario_material_w
           from      contrato            a,
                     contrato_regra_nf   c
           where     a.nr_sequencia = c.nr_seq_contrato
           and       a.cd_cgc_contratado = cd_fornecedor_consignado_p 
           and       c.cd_material = cd_material_p
           and       coalesce(c.dt_inicio_vigencia, clock_timestamp()) <= clock_timestamp()
           and       coalesce(c.dt_fim_vigencia, clock_timestamp()) >= clock_timestamp()
           and       coalesce(c.ie_situacao, 'A') = 'A'
           and (c.cd_estab_regra = cd_estabelecimento_p or coalesce(c.cd_estab_regra::text, '') = '')
           and       a.dt_inicio <= clock_timestamp()
           and       coalesce(dt_fim, clock_timestamp()) >= clock_timestamp()
           and       a.ie_situacao = 'A'
           and (a.cd_estabelecimento = cd_estabelecimento_p
                        or exists (SELECT 1 from contrato_estab_adic b
                                   where  a.nr_sequencia = b.nr_seq_contrato
                                   and    b.cd_estab_adic = cd_estabelecimento_p)) 
           order by a.nr_sequencia desc LIMIT 1;
        exception
           when no_data_found or too_many_rows then
              vl_unitario_material_w := 0;
        end;
        end if;

		end;
	end loop;
	close C02;

else

	select	coalesce(ie_valor_consignado,'N')
	into STRICT	ie_valor_consignado_w
	from	parametro_compras
	where	cd_estabelecimento = cd_estabelecimento_p;

	/*Tabela Precos*/

	if (ie_valor_consignado_w = 'T') then
		select	coalesce(max(a.vl_preco_venda),0)
		into STRICT	vl_preco_tabela_w
		from	preco_material a
		where	a.cd_material		= cd_material_p
		and	a.cd_estabelecimento	= cd_estabelecimento_p
		and	a.cd_cgc_fornecedor	= cd_fornecedor_consignado_p
		and	a.cd_tab_preco_mat	= coalesce(cd_tab_preco_mat_consig_w,a.cd_tab_preco_mat)
		and	a.ie_situacao		= 'A'
		and	a.dt_inicio_vigencia	= (
			SELECT	max(b.dt_inicio_vigencia)
			from	preco_material b
			where	b.cd_material		= a.cd_material
			and	b.cd_cgc_fornecedor	= a.cd_cgc_fornecedor
			and	b.cd_estabelecimento	= a.cd_estabelecimento
			and	b.ie_situacao		= 'A'
			and	b.cd_tab_preco_mat	= coalesce(cd_tab_preco_mat_consig_w,a.cd_tab_preco_mat));

		if (vl_preco_tabela_w <> 0) then
			vl_unitario_material_w 	:= vl_preco_tabela_w;
		end if;

		vl_unitario_material_w	:= (vl_unitario_material_w * qt_conv_compra_estoque_w * qt_conv_estoque_consumo_w);

	/*Preco Convenio*/

	elsif (ie_valor_consignado_w = 'P') then

		if (coalesce(nr_seq_lote_fornec_p,0) <> 0) then
			select	max(nr_seq_marca)
			into STRICT	nr_seq_marca_w
			from	material_lote_fornec
			where	nr_sequencia = nr_seq_lote_fornec_p;
		end if;

		SELECT * FROM define_preco_material(	cd_estabelecimento_p, 	-- cd_estabelecimento_p		number,
					cd_convenio_w,           -- cd_convenio_p          	number,
					cd_categoria_p,          -- cd_categoria_p         	varchar2,
					dt_vigencia_p,           -- dt_vigencia_p          	date,
					cd_material_p,           -- cd_material_p          	number,
					0,                       -- cd_tipo_acomodacao_p   	number,
					0,                       -- ie_tipo_atendimento_p  	number,
					0,                       -- cd_setor_atendimento_p 	number,
					null,                    -- cd_cgc_fornecedor_p		varchar2,
					0,                       -- qt_idade_p			number,
					0,                       -- nr_sequencia_p		number,
					null,                    -- cd_plano_p			varchar2,
					null,                    -- cd_proc_referencia_p		number,
					null,                    -- ie_origem_proc_p		number,
					nr_seq_marca_w,          -- nr_seq_marca_p		number,
					null,                    -- ie_clinica_p			number,
					null,                    -- nr_seq_classif_atend_p	number,
					nr_atendimento_p,        -- nr_atendimento_p		number,
					null,                    -- ie_vago_4_p			varchar2,
					vl_unitario_material_w,  -- vl_material_p      	 out 	number,
					dt_utl_vigencia_w,       -- dt_ult_vigencia_p  	 out 	date,
					cd_tab_preco_mat_w,      -- cd_tab_preco_mat_p 	 out 	number,
					ie_origem_preco_w,       -- ie_origem_preco_p  	 out 	number,
					nr_seq_bras_preco_w,     -- nr_seq_bras_preco_p	 out	number,
					nr_seq_mat_bras_w,       -- nr_seq_mat_bras_p	 out	number,
					nr_seq_conv_bras_w,      -- nr_seq_conv_bras_p	 out	number,
					nr_seq_conv_simpro_w,    -- nr_seq_conv_simpro_p	 out	number,
					nr_seq_mat_simpro_w,     -- nr_seq_mat_simpro_p	 out	number,
					nr_seq_simpro_preco_w,   -- nr_seq_simpro_preco_p out	number,
					nr_seq_ajuste_mat_w) INTO STRICT 
					vl_unitario_material_w, 
					dt_utl_vigencia_w, 
					cd_tab_preco_mat_w, 
					ie_origem_preco_w, 
					nr_seq_bras_preco_w, 
					nr_seq_mat_bras_w, 
					nr_seq_conv_bras_w, 
					nr_seq_conv_simpro_w, 
					nr_seq_mat_simpro_w, 
					nr_seq_simpro_preco_w, 
					nr_seq_ajuste_mat_w;   -- nr_seq_ajuste_mat_p	 out	number
		vl_unitario_material_w	:= (vl_unitario_material_w * qt_conv_compra_estoque_w * qt_conv_estoque_consumo_w);

	/*Autorizacao(Vl Autorizado)*/

	elsif (ie_valor_consignado_w = 'A') then

		if (coalesce(nr_seq_agenda_w,0) = 0) then

			select	coalesce(max(nr_cirurgia),0)
			into STRICT	nr_cirurgia_w
			from	ordem_compra
			where	nr_ordem_compra = nr_ordem_compra_p;

			if (nr_cirurgia_w > 0) then
				select	coalesce(max(a.nr_sequencia),0)
				into STRICT	nr_seq_agenda_w
				from	agenda_paciente a,
					cirurgia b
				where	a.nr_cirurgia	= b.nr_cirurgia
				and	b.nr_cirurgia	= nr_cirurgia_w;
			end if;
		end if;

		select	coalesce(max(b.vl_unitario_material),0)
		into STRICT	vl_unitario_material_w
		from	material_autor_cirurgia b,
			autorizacao_cirurgia a
		where	a.nr_sequencia	= b.nr_seq_autorizacao
		and	b.cd_material	= cd_material_p
		and	a.nr_seq_agenda	= nr_seq_agenda_w
		and	b.ie_valor_informado = 'S';


	/*Autorizacao(Vl do fornecedor)*/

	elsif (ie_valor_consignado_w = 'F') then

		if (coalesce(nr_seq_agenda_w,0) = 0) then

			select	coalesce(max(nr_cirurgia),0)
			into STRICT	nr_cirurgia_w
			from	ordem_compra
			where	nr_ordem_compra = nr_ordem_compra_p;

			if (nr_cirurgia_w > 0) then
				select	coalesce(max(a.nr_sequencia),0)
				into STRICT	nr_seq_agenda_w
				from	agenda_paciente a,
					cirurgia b
				where	a.nr_cirurgia	= b.nr_cirurgia
				and	b.nr_cirurgia	= nr_cirurgia_w;
			end if;
		end if;

		select	coalesce(max(c.vl_unitario_cotado),0)
		into STRICT	vl_unitario_material_w
		from	material_autor_cirurgia b,
			autorizacao_cirurgia a,
			material_autor_cir_cot c
		where	a.nr_sequencia	= b.nr_seq_autorizacao
		and	b.cd_material	= cd_material_p
		and	a.nr_seq_agenda	= nr_seq_agenda_w
		and 	b.nr_sequencia 	= c.nr_sequencia
		and 	c.cd_cgc	= cd_fornecedor_consignado_p
		and	((coalesce(a.nr_prescricao,0) = coalesce(nr_prescricao_p,0)) or (coalesce(nr_prescricao_p,0) = 0));

	/*Ultima Compra*/

	elsif (ie_valor_consignado_w = 'U') then

		select	coalesce(max(dividir((a.vl_total_item_nf - a.vl_desconto - vl_desconto_rateio + vl_frete + a.vl_despesa_acessoria + a.vl_seguro),a.qt_item_estoque)),0)
		into STRICT	vl_unitario_material_w
		from 	nota_fiscal_item a
		where 	a.cd_material  = cd_material_p
		and 	a.nr_sequencia =
			(SELECT max(i.nr_sequencia)
			from	nota_fiscal_item i,
				nota_fiscal n,
				operacao_nota p
			where	i.nr_sequencia = n.nr_sequencia
			and	i.cd_material  = cd_material_p
			and 	coalesce(p.ie_ultima_compra,'S') 	= 'S'
			and	p.cd_operacao_nf = n.cd_operacao_nf
			and	n.ie_situacao = '1'
			and	n.cd_cgc = cd_fornecedor_consignado_p);

		vl_unitario_material_w	:= (vl_unitario_material_w * qt_conv_compra_estoque_w);

	/*OPM com o procedimento SUS*/

	elsif (ie_valor_consignado_w = 'O') then

		select	coalesce(sus_obter_preco_proced(cd_estabelecimento_p, clock_timestamp(), 1, obter_proced_mat_esp_sus(cd_material_p), 7, 1),0)
		into STRICT	vl_unitario_material_w
		;

	/*Autorizacao sem prescricao (Valor do fornecedor)*/

	elsif (ie_valor_consignado_w = 'D') then
		if (coalesce(nr_seq_agenda_w,0) = 0) then

			select	coalesce(max(nr_cirurgia),0)
			into STRICT	nr_cirurgia_w
			from	ordem_compra
			where	nr_ordem_compra = nr_ordem_compra_p;

			if (nr_cirurgia_w > 0) then
				select	coalesce(max(a.nr_sequencia),0)
				into STRICT	nr_seq_agenda_w
				from	agenda_paciente a,
					cirurgia b
				where	a.nr_cirurgia	= b.nr_cirurgia
				and	b.nr_cirurgia	= nr_cirurgia_w;
			end if;
		end if;

		select	coalesce(max(c.vl_unitario_cotado),0)
		into STRICT	vl_unitario_material_w
		from	material_autor_cirurgia b,
			autorizacao_cirurgia a,
			material_autor_cir_cot c
		where	a.nr_sequencia	= b.nr_seq_autorizacao
		and	b.cd_material	= cd_material_p
		and	a.nr_seq_agenda	= nr_seq_agenda_w
		and 	b.nr_sequencia 	= c.nr_sequencia
		and 	c.cd_cgc	= cd_fornecedor_consignado_p;

    /* Contrato */

	elsif (ie_valor_consignado_w = 'C') then
    begin
        select    coalesce(c.vl_saldo_total, c.vl_pagto)
        into STRICT      vl_unitario_material_w
        from      contrato            a,
                 contrato_regra_nf   c
        where     a.nr_sequencia = c.nr_seq_contrato
        and       a.cd_cgc_contratado = cd_fornecedor_consignado_p
        and       c.cd_material = cd_material_p
        and       coalesce(c.dt_inicio_vigencia, clock_timestamp()) <= clock_timestamp()
        and       coalesce(c.dt_fim_vigencia, clock_timestamp()) >= clock_timestamp()
        and       coalesce(c.ie_situacao, 'A') = 'A'
        and (c.cd_estab_regra = cd_estabelecimento_p or coalesce(c.cd_estab_regra::text, '') = '')
        and       a.dt_inicio <= clock_timestamp()
        and       coalesce(dt_fim, clock_timestamp()) >= clock_timestamp()
        and       a.ie_situacao = 'A'
        and (a.cd_estabelecimento = cd_estabelecimento_p
                    or exists (SELECT 1 from contrato_estab_adic b
                               where  a.nr_sequencia = b.nr_seq_contrato
                               and    b.cd_estab_adic = cd_estabelecimento_p)) 
        order by a.nr_sequencia desc LIMIT 1;
    exception
        when no_data_found or too_many_rows then
            vl_unitario_material_w := 0;
    end;
    end if;

end if;

select	coalesce(ie_preco_sus_oc,'N')
into STRICT	ie_preco_sus_oc_w
from	parametro_compras
where	cd_estabelecimento = cd_estabelecimento_p;

if (ie_preco_sus_oc_w = 'S') and (ie_tipo_atendimento_p = 3) then

	select	coalesce(sus_obter_preco_proced(cd_estabelecimento_p, clock_timestamp(), 1, obter_proced_mat_esp_sus(cd_material_p), 7, 1),0)
	into STRICT	vl_unitario_material_w
	;

end if;

vl_unitario_material_p := vl_unitario_material_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE obter_valor_mat_ordem_consig ( cd_estabelecimento_p bigint, cd_fornecedor_consignado_p text, cd_material_p bigint, nr_ordem_compra_p bigint, nr_prescricao_p bigint, nr_atendimento_p bigint, ie_tipo_atendimento_p text, nr_seq_agenda_p bigint, dt_atualizacao_p timestamp, nr_seq_lote_fornec_p bigint, cd_convenio_p bigint, cd_categoria_p bigint, dt_vigencia_p timestamp, vl_unitario_material_p INOUT bigint) FROM PUBLIC;

