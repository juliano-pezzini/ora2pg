-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE aprazar_etapa_solucao ( ie_tipo_solucao_p bigint, nr_prescricao_p bigint, nr_seq_solucao_p bigint, dt_inicio_p timestamp, nr_seq_motivo_p bigint, ds_observacao_p text, nm_usuario_p text, ie_somente_gedipa_p text, cd_funcao_origem_p bigint, ie_gedipa_p text, nr_seq_etapa_p bigint, ie_gera_kit_sol_acm_p text, nr_seq_assinatura_p bigint default 0) AS $body$
DECLARE


nr_sequencia_w				bigint;
nr_seq_horario_w			bigint;
nr_seq_material_w			integer;
cd_material_w				integer;
qt_dispensar_w				double precision;
qt_dispensar_hor_w			double precision;
cd_unidade_medida_w			varchar(30);
qt_dose_w					double precision;
cd_unidade_medida_dose_w	varchar(30);
ie_gerar_necessidade_disp_w	varchar(15);
nr_atendimento_w			bigint;
nr_seq_lote_w				bigint;
cd_estab_prescr_w			smallint;
cd_setor_prescr_w			integer;
nr_prescr_atual_w			bigint := 0;
cd_local_estoque_baixa_w	smallint;
cd_local_estoque_w			smallint;
nr_seq_classif_w			bigint;
dt_liberacao_w				timestamp;
dt_fim_cpoe_w				timestamp;
dt_suspensao_cpoe_w			timestamp;
dt_limite_especial_w		timestamp;
dt_horario_w				timestamp;
dt_limite_agora_w			timestamp;
ie_classif_nao_padrao_w		varchar(15);
qt_min_agora_w				bigint;
qt_min_especial_w			bigint;
ie_classif_urgente_w		varchar(3);
ie_padronizado_w			varchar(1);
ie_controlado_w				varchar(1);
varie_cursor_w				varchar(1) := 'N';
nr_seq_processo_w			bigint;
qt_horas_etapa_w			double precision;
dt_etapa_w					timestamp;
dt_inicio_prescr_w			timestamp;
dt_validade_prescr_w		timestamp;
ie_registro_w				bigint;
cd_estabelecimento_w		bigint;
ie_horario_acm_w			varchar(2);
ie_horario_sn_w				varchar(2);
ajustar_disp_hor_farm_w		varchar(1) := 'N';
ie_acm_w					varchar(1) := 'N';
ie_sn_w						varchar(1) := 'N';
dt_prescricao_w				timestamp;
nr_seq_classif_param_w		bigint;
dt_hora_atual_w				timestamp;
ie_gerar_classif_agora_w 	varchar(1);
ie_dose_especial_w			varchar(1);
ie_local_estoque_mat_hor_w	varchar(1);
nr_seq_item_w				bigint;
ds_horario_w				varchar(4000);
ie_agora_impressao_w		varchar(15);
nr_seq_turno_hor_ag_w		bigint;
hr_turno_agora_w			varchar(15);
hr_final_turno_agora_w		varchar(15);
qt_min_antes_atend_w		integer;
ie_gerar_processo_w 		varchar(1);
ie_gerar_todos_sol_w		varchar(1);
ds_msg_w					varchar(255);
nr_ocorrencia_w				prescr_material.nr_ocorrencia%type;
cd_pessoa_fisica_w			atendimento_paciente.cd_pessoa_fisica%type;
ie_setor_gedipa_w			varchar(1);
nr_etapa_sol_w				prescr_mat_hor.nr_etapa_sol%type;
ie_regra_disp_w				prescr_material.ie_regra_disp%type;
ie_gera_sem_certificado_w	varchar(1);
ie_gerar_nec_disp_kit_w		varchar(1);
qt_horario_w                prescr_mat_hor.qt_horario%type;
ie_tipo_sol_reg_w			varchar(3);
ie_apraz_regra_w			varchar(1);
nr_atendimento_reg_w		prescr_medica.nr_atendimento%type;
dt_inicio_cpoe_w			cpoe_material.dt_liberacao%type;
ie_grava_log_rastr_w varchar(1);
ie_prescr_emergencia_w	prescr_medica.ie_prescr_emergencia%type;
ie_solucao_pca_comum_w			prescr_solucao.ie_solucao_pca%type;
nr_etapas_pca_comum_w			prescr_solucao.nr_etapas%type;

c01 CURSOR FOR
SELECT	1 ie_registro,
	c.nr_sequencia,
	d.cd_material,
	d.qt_dispensar,
	d.qt_dispensar_hor,
	d.cd_unidade_medida,
	d.qt_dose,
	d.cd_unidade_medida_dose,
	a.nr_atendimento,
	a.cd_estabelecimento,
	a.cd_setor_atendimento,
	c.cd_local_estoque,
	c.nr_ocorrencia,
	c.ie_regra_disp
from	prescr_mat_hor d,
	prescr_material c,
	prescr_solucao b,
	prescr_medica a
where	d.nr_prescricao		= c.nr_prescricao
and	d.nr_seq_material	= c.nr_sequencia
and	d.nr_prescricao		= a.nr_prescricao
and	c.nr_prescricao		= b.nr_prescricao
and	c.nr_sequencia_solucao	= b.nr_seq_solucao
and	c.nr_prescricao		= a.nr_prescricao
and	b.nr_prescricao		= a.nr_prescricao
and	b.nr_seq_solucao	= nr_seq_solucao_p
and	a.nr_prescricao		= nr_prescricao_p
and	c.ie_agrupador		= 4
and	coalesce(c.ie_suspenso,'N')	<> 'S'
and	coalesce(b.dt_suspensao::text, '') = ''
and	coalesce(a.dt_suspensao::text, '') = ''
and	Obter_se_horario_liberado(d.dt_lib_horario, d.dt_horario) = 'S'
group by
	c.nr_sequencia,
	d.cd_material,
	d.qt_dispensar,
	d.qt_dispensar_hor,
	d.cd_unidade_medida,
	d.qt_dose,
	d.cd_unidade_medida_dose,
	a.nr_atendimento,
	a.cd_estabelecimento,
	a.cd_setor_atendimento,
	c.cd_local_estoque,
	c.nr_ocorrencia,
	c.ie_regra_disp

union

SELECT	2 ie_registro,
	c.nr_sequencia,
	c.cd_material,
	c.qt_total_dispensar,
	null,--c.qt_dispensar_hor,
	c.cd_unidade_medida,
	c.qt_dose,
	c.cd_unidade_medida_dose,
	a.nr_atendimento,
	a.cd_estabelecimento,
	a.cd_setor_atendimento,
	c.cd_local_estoque,
	c.nr_ocorrencia,
	c.ie_regra_disp
from	prescr_material c,
	prescr_solucao b,
	prescr_medica a
where	a.nr_prescricao		= b.nr_prescricao
and	c.nr_prescricao		= b.nr_prescricao
and	c.nr_sequencia_solucao	= b.nr_seq_solucao
and	c.nr_prescricao		= a.nr_prescricao
and	b.nr_prescricao		= a.nr_prescricao
and	b.nr_seq_solucao	= nr_seq_solucao_p
and	a.nr_prescricao		= nr_prescricao_p
and	not exists (	
		select	1
		from	prescr_mat_hor x
		where	x.nr_prescricao		= c.nr_prescricao
		and	x.nr_seq_material	= c.nr_sequencia)
and	(((b.ie_acm = 'S') and (coalesce(ie_horario_acm_w,'S') = 'N')) or
	 ((b.ie_se_necessario = 'S') and (coalesce(ie_horario_sn_w,'S') = 'N')))
and	c.ie_agrupador		= 4
and	coalesce(c.ie_suspenso,'N')	<> 'S'
and	coalesce(b.dt_suspensao::text, '') = ''
and	coalesce(a.dt_suspensao::text, '') = ''
group by
	c.nr_sequencia,
	c.cd_material,
	c.qt_total_dispensar,
	c.cd_unidade_medida,
	c.qt_dose,
	c.cd_unidade_medida_dose,
	a.nr_atendimento,
	a.cd_estabelecimento,
	a.cd_setor_atendimento,
	c.cd_local_estoque,
	c.nr_ocorrencia,
	c.ie_regra_disp;
	
C02 CURSOR FOR
	SELECT	nr_sequencia,
		ie_classif_urgente,
		ie_controlado,
		ie_padronizado
	from	classif_lote_disp_far
	where	cd_estabelecimento = cd_estabelecimento_w
	and	ie_situacao = 'A'
	order by ie_classif_urgente,
		ie_controlado desc,
		ie_padronizado desc;

C21 CURSOR FOR
	SELECT	a.nr_sequencia,
		b.cd_local_estoque,
		a.ds_horario,
		a.nr_seq_material,
		c.cd_estabelecimento,
		c.cd_setor_atendimento
	from	prescr_mat_hor a,
		prescr_material b,
		prescr_medica c
	where	a.nr_prescricao	= nr_prescricao_p
	and	a.nr_prescricao = b.nr_prescricao
	and	a.nr_seq_material = b.nr_sequencia
	and	a.nr_prescricao = c.nr_prescricao
	and	(a.dt_lib_horario IS NOT NULL AND a.dt_lib_horario::text <> '');


BEGIN

ie_grava_log_rastr_w := obter_rastreabilidade_adep(nr_prescricao_p, 'APR');

if (ie_grava_log_rastr_w = 'S') then
    CALL adep_gerar_log_rastr('{'||chr(10)||
        '"'||$$plsql_unit||'" : "'||$$plsql_line||'",'||chr(10)||
        '"cd_funcao_origem_p" : "'||cd_funcao_origem_p||'",'||chr(10)||
        '"ds_observacao_p" : "'||ds_observacao_p||'",'||chr(10)||
        '"dt_inicio_p" : "'||to_char(dt_inicio_p, 'dd/mm/yyyy hh24:mi:ss')||'",'||chr(10)||
        '"ie_gedipa_p" : "'||ie_gedipa_p||'",'||chr(10)||
        '"ie_gera_kit_sol_acm_p" : "'||ie_gera_kit_sol_acm_p||'",'||chr(10)||
        '"ie_somente_gedipa_p" : "'||ie_somente_gedipa_p||'",'||chr(10)||
        '"ie_tipo_solucao_p" : "'||ie_tipo_solucao_p||'",'||chr(10)||
        '"nm_usuario_p" : "'||nm_usuario_p||'",'||chr(10)||
        '"nr_prescricao_p" : "'||nr_prescricao_p||'",'||chr(10)||
        '"nr_seq_assinatura_p" : "'||nr_seq_assinatura_p||'",'||chr(10)||
        '"nr_seq_etapa_p" : "'||nr_seq_etapa_p||'",'||chr(10)||
        '"nr_seq_motivo_p" : "'||nr_seq_motivo_p||'",'||chr(10)||
        '"nr_seq_solucao_p" : "'||nr_seq_solucao_p||'"}', wheb_usuario_pck.get_ie_commit);
end if;

if (ie_tipo_solucao_p IS NOT NULL AND ie_tipo_solucao_p::text <> '') and (nr_prescricao_p IS NOT NULL AND nr_prescricao_p::text <> '') and (nr_seq_solucao_p IS NOT NULL AND nr_seq_solucao_p::text <> '') and (dt_inicio_p IS NOT NULL AND dt_inicio_p::text <> '') and (nr_seq_etapa_p IS NOT NULL AND nr_seq_etapa_p::text <> '') and (nm_usuario_p IS NOT NULL AND nm_usuario_p::text <> '') then
	begin
	
	if (ie_tipo_solucao_p in (1, 4, 5)) then
		if (ie_tipo_solucao_p = 1) then
			ie_tipo_sol_reg_w := 'SOL';
		elsif (ie_tipo_solucao_p = 4) then
			ie_tipo_sol_reg_w := 'NAN';
		else
			ie_tipo_sol_reg_w := 'NPP';
		end if;
		
		select 	max(a.nr_atendimento)
		into STRICT	nr_atendimento_reg_w
		from	prescr_medica a
		where	a.nr_prescricao = nr_prescricao_p;

		ie_apraz_regra_w := obter_apraz_reapraz_regra(	ie_tipo_item_p => ie_tipo_sol_reg_w,
														nr_atendimento_p => nr_atendimento_reg_w,
														ie_acao_p => 'A',
														nm_usuario_p => nm_usuario_p);
		if (ie_apraz_regra_w <> 'S') then
			-- Voce nao tem permissao para efetuar essa acao. Cadastros gerais / ADEP - Regra permissao de aprazamento/reaprazamento
			CALL wheb_mensagem_pck.exibir_mensagem_abort(1134375);
		end if;
	end if;

	select	dt_inicio_prescr,
			dt_validade_prescr,
			cd_estabelecimento,
			dt_liberacao,
			dt_prescricao,
			nr_atendimento,
			coalesce(ie_prescr_emergencia,'N')
	into STRICT	dt_inicio_prescr_w,
			dt_validade_prescr_w,
			cd_estabelecimento_w,
			dt_liberacao_w,
			dt_prescricao_w,
			nr_atendimento_w,
			ie_prescr_emergencia_w
	from	prescr_medica
	where	nr_prescricao = nr_prescricao_p;
	
	ie_setor_gedipa_w	:= obter_se_setor_processo_gedipa(obter_unidade_atendimento(nr_atendimento_w,'IAA','CS'));
	
	select	max(a.dt_suspensao),
			max(a.dt_fim),
			CASE WHEN ie_prescr_emergencia_w='S' THEN  max(a.dt_inicio)  ELSE max(a.dt_liberacao) END
	into STRICT	dt_suspensao_cpoe_w,
			dt_fim_cpoe_w,
			dt_inicio_cpoe_w
	from	cpoe_material a,
			prescr_material b
	where	a.nr_sequencia = b.nr_seq_mat_cpoe
	and		b.nr_prescricao = nr_prescricao_p
	and		nr_sequencia_solucao = nr_seq_solucao_p
	and 	coalesce(nr_seq_substituto::text, '') = ''
	and		ie_agrupador = 4
	and     cd_funcao_origem = 2314;
	
	select	coalesce(max(ie_horario_acm),'S'),
			coalesce(max(ie_horario_sn),'S'),
			coalesce(max(qt_min_agora),0),
			coalesce(max(qt_min_especial),0),
			max(ie_classif_urgencia),
			coalesce(max(ie_forma_agora), 'N'),
			coalesce(max(ie_gerar_todos_sol),'S')
	into STRICT	ie_horario_acm_w,
			ie_horario_sn_w,
			qt_min_agora_w,
			qt_min_especial_w,
			ie_classif_nao_padrao_w,
			ie_agora_impressao_w,
			ie_gerar_todos_sol_w
	from	parametros_farmacia
	where	cd_estabelecimento = cd_estabelecimento_w;
	
	ie_gerar_necessidade_disp_w := obter_param_usuario(1113, 70, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_gerar_necessidade_disp_w);
	nr_seq_classif_param_w := obter_param_usuario(1113, 498, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, nr_seq_classif_param_w);	
	ie_gerar_classif_agora_w := Obter_Param_Usuario(1113, 529, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_gerar_classif_agora_w);
	ie_local_estoque_mat_hor_w := obter_param_usuario(924, 851, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_local_estoque_mat_hor_w);
	ie_gerar_processo_w := obter_param_usuario(1113, 279, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_gerar_processo_w);
	ie_gerar_nec_disp_kit_w := obter_param_usuario(1113, 393, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_gerar_nec_disp_kit_w);

    if (ie_grava_log_rastr_w = 'S') then
        CALL adep_gerar_log_rastr('{'||chr(10)||
            '"'||$$plsql_unit||'" : "'||$$plsql_line||'",'||chr(10)||
            '"ie_gerar_classif_agora_w" : "'||ie_gerar_classif_agora_w||'",'||chr(10)||
            '"ie_gerar_nec_disp_kit_w" : "'||ie_gerar_nec_disp_kit_w||'",'||chr(10)||
            '"ie_gerar_necessidade_disp_w" : "'||ie_gerar_necessidade_disp_w||'",'||chr(10)||
            '"ie_gerar_processo_w" : "'||ie_gerar_processo_w||'",'||chr(10)||
            '"nr_seq_classif_param_w" : "'||nr_seq_classif_param_w||'",'||chr(10)||
            '"ie_local_estoque_mat_hor_w" : "'||ie_local_estoque_mat_hor_w||'"}', wheb_usuario_pck.get_ie_commit);
    end if;
	
	if (ie_tipo_solucao_p = 1) and (nr_prescricao_p IS NOT NULL AND nr_prescricao_p::text <> '') and (nr_seq_solucao_p IS NOT NULL AND nr_seq_solucao_p::text <> '') then
		begin
		select 	max(ie_acm),
				max(ie_se_necessario)
		into STRICT	ie_acm_w,
				ie_sn_w
		from	prescr_solucao
		where	nr_prescricao = nr_prescricao_p
		and		nr_seq_solucao = nr_seq_solucao_p;
		
		end;
	end if;
	
    if (ie_grava_log_rastr_w = 'S') then
        CALL adep_gerar_log_rastr('{'||chr(10)||
            '"'||$$plsql_unit||'" : "'||$$plsql_line||'",'||chr(10)||
            '"cd_estabelecimento_w" : "'||cd_estabelecimento_w||'",'||chr(10)||
            '"ds_msg_w" : "'||ds_msg_w||'",'||chr(10)||
            '"dt_fim_cpoe_w" : "'||to_char(dt_fim_cpoe_w, 'dd/mm/yyyy hh24:mi:ss')||'",'||chr(10)||
            '"dt_inicio_cpoe_w" : "'||to_char(dt_inicio_cpoe_w, 'dd/mm/yyyy hh24:mi:ss')||'",'||chr(10)||
            '"dt_inicio_p" : "'||to_char(dt_inicio_p, 'dd/mm/yyyy hh24:mi:ss')||'",'||chr(10)||
            '"dt_inicio_prescr_w" : "'||to_char(dt_inicio_prescr_w, 'dd/mm/yyyy hh24:mi:ss')||'",'||chr(10)||
            '"dt_prescricao_w" : "'||to_char(dt_prescricao_w, 'dd/mm/yyyy hh24:mi:ss')||'",'||chr(10)||
            '"dt_suspensao_cpoe_w" : "'||to_char(dt_suspensao_cpoe_w, 'dd/mm/yyyy hh24:mi:ss')||'",'||chr(10)||
            '"dt_validade_prescr_w" : "'||to_char(dt_validade_prescr_w, 'dd/mm/yyyy hh24:mi:ss')||'",'||chr(10)||
            '"ie_acm_w" : "'||ie_acm_w||'",'||chr(10)||
            '"ie_sn_w" : "'||ie_sn_w||'",'||chr(10)||
            '"nm_usuario_p" : "'||nm_usuario_p||'"}', wheb_usuario_pck.get_ie_commit);
    end if;

	if	((ie_acm_w = 'S') or (ie_sn_w = 'S')) then
		begin
		if (dt_inicio_p < dt_prescricao_w) and (coalesce(dt_inicio_cpoe_w::text, '') = '' or (dt_inicio_p < dt_inicio_cpoe_w)) then
			--Nao e permitido aprazar o inicio de uma solucao para um horario anterior a data da prescricao
			CALL wheb_mensagem_pck.exibir_mensagem_abort(174199);
		elsif (dt_inicio_p > dt_validade_prescr_w) then
			--Nao e permitido aprazar o inicio de uma solucao para um horario posterior ao termino da validade da prescricao
			CALL wheb_mensagem_pck.exibir_mensagem_abort(174200);
		elsif (dt_suspensao_cpoe_w IS NOT NULL AND dt_suspensao_cpoe_w::text <> '') and (dt_inicio_p > dt_suspensao_cpoe_w) then			
			  -- A data do aprazamento nao pode ser superior a data de suspensao do item: Suspenso em 
			  ds_msg_w	:= wheb_mensagem_pck.get_Texto(820331, null) || ' ' || to_char(dt_suspensao_cpoe_w, pkg_date_formaters.localize_mask('timestamp', pkg_date_formaters.getUserLanguageTag(cd_estabelecimento_w, nm_usuario_p)));
			  CALL wheb_mensagem_pck.exibir_mensagem_abort(ds_msg_w);
		elsif (dt_fim_cpoe_w IS NOT NULL AND dt_fim_cpoe_w::text <> '') and (dt_inicio_p > dt_fim_cpoe_w) then			
			  --O horario informado esta fora do periodo de validade do item na CPOE. Data de fim:
			  ds_msg_w	:= wheb_mensagem_pck.get_Texto(820333, null) || ' ' || to_char(dt_fim_cpoe_w, pkg_date_formaters.localize_mask('timestamp', pkg_date_formaters.getUserLanguageTag(cd_estabelecimento_w, nm_usuario_p)));
			  CALL wheb_mensagem_pck.exibir_mensagem_abort(ds_msg_w);
		end if;
		end;	
	else
		begin	
		if (dt_inicio_p < dt_inicio_prescr_w) then
			--'Nao e permitido aprazar o inicio de uma solucao para um horario anterior ao inicio da validade da prescricao'
			CALL wheb_mensagem_pck.exibir_mensagem_abort(174201);
		elsif (dt_inicio_p > dt_validade_prescr_w) then
			CALL wheb_mensagem_pck.exibir_mensagem_abort(174202);
		elsif (dt_suspensao_cpoe_w IS NOT NULL AND dt_suspensao_cpoe_w::text <> '') and (dt_inicio_p > dt_suspensao_cpoe_w) then
			  -- A data do aprazamento nao pode ser superior a data de suspensao do item: Suspenso em 
			  ds_msg_w	:= wheb_mensagem_pck.get_Texto(820331, null) || ' ' || to_char(dt_suspensao_cpoe_w, pkg_date_formaters.localize_mask('timestamp', pkg_date_formaters.getUserLanguageTag(cd_estabelecimento_w, nm_usuario_p)));
		elsif (dt_fim_cpoe_w IS NOT NULL AND dt_fim_cpoe_w::text <> '') and (dt_inicio_p > dt_fim_cpoe_w) then
			--O horario informado esta fora do periodo de validade do item na CPOE. Data de fim:
			  ds_msg_w	:= wheb_mensagem_pck.get_Texto(820333, null) || ' ' || to_char(dt_fim_cpoe_w, pkg_date_formaters.localize_mask('timestamp', pkg_date_formaters.getUserLanguageTag(cd_estabelecimento_w, nm_usuario_p)));
    		  CALL wheb_mensagem_pck.exibir_mensagem_abort(ds_msg_w);
		end if;
		end;
	end if;
	
	dt_horario_w 		:= to_date(to_char(dt_inicio_p,'dd/mm/yyyy hh24:mi') || ':00','dd/mm/yyyy hh24:mi:ss');
	dt_limite_agora_w	:= dt_liberacao_w + qt_min_agora_w/1440;
	dt_limite_especial_w	:= dt_liberacao_w + qt_min_especial_w/1440;
	
	if (coalesce(ie_gerar_classif_agora_w,'N') = 'S') then
		dt_hora_atual_w := clock_timestamp();
		dt_limite_agora_w	:=  dt_hora_atual_w + qt_min_agora_w/1440; 			
	end if;

	if (ie_tipo_solucao_p = 1) then		
		begin
		dt_etapa_w := dt_inicio_p;
		dt_horario_w := dt_etapa_w;

        if (ie_grava_log_rastr_w = 'S') then
            CALL adep_gerar_log_rastr('{'||chr(10)||
                '"'||$$plsql_unit||'" : "'||$$plsql_line||'",'||chr(10)||
                '"ie_horario_acm_w" : "'||ie_horario_acm_w||'",'||chr(10)||
                '"ie_horario_sn_w" : "'||ie_horario_sn_w||'",'||chr(10)||
                '"nr_prescricao_p" : "'||nr_prescricao_p||'",'||chr(10)||
                '"nr_seq_solucao_p" : "'||nr_seq_solucao_p||'"}', wheb_usuario_pck.get_ie_commit);
        end if;
		
		open c01;
		loop
		fetch c01 into
			ie_registro_w,
			nr_seq_material_w,
			cd_material_w,
			qt_dispensar_w,
			qt_dispensar_hor_w,
			cd_unidade_medida_w,
			qt_dose_w,
			cd_unidade_medida_dose_w,
			nr_atendimento_w,
			cd_estab_prescr_w,
			cd_setor_prescr_w,
			cd_local_estoque_w,
			nr_ocorrencia_w,
			ie_regra_disp_w;
		EXIT WHEN NOT FOUND; /* apply on c01 */
			begin
			varie_cursor_w	:= 'S';

            select  coalesce(max(a.qt_horario), 0)
            into STRICT    qt_horario_w
            from    prescr_mat_hor a,
                    prescr_material b
            where   a.nr_prescricao = b.nr_prescricao
            and     a.nr_seq_material = b.nr_sequencia
            and     b.nr_prescricao = nr_prescricao_p
            and     b.nr_sequencia_solucao = nr_seq_solucao_p
			and		b.cd_material = cd_material_w;
			
			select	coalesce(max(substr(Obter_se_medic_controlado(cd_material_w),1,1)),'N'),
					coalesce(max(substr(obter_se_material_padronizado(cd_estab_prescr_w,cd_material_w),1,1)),'N')
			  into STRICT	ie_controlado_w,
					ie_padronizado_w
			;
			
			ie_classif_urgente_w := definir_ie_classif_urgente(dt_horario_w,
                                                      cd_local_estoque_w,
                                                      cd_estabelecimento_w,
                                                      cd_setor_prescr_w,
                                                      dt_inicio_prescr_w,
                                                      ie_classif_nao_padrao_w,
                                                      ie_padronizado_w,
                                                      dt_limite_especial_w,
                                                      dt_limite_agora_w,
                                                      ie_agora_impressao_w);
			
			cd_local_estoque_baixa_w := null;
			
			if (coalesce(cd_setor_prescr_w,0) > 0) then
				select	coalesce(max(cd_local_estoque),0)
				into STRICT	cd_local_estoque_baixa_w
				from	setor_local
				where	cd_setor_atendimento = cd_setor_prescr_w
				and	ie_loca_estoque_pac = 'S';
				
				if (cd_local_estoque_baixa_w = 0) then
					cd_local_estoque_baixa_w := null;
				end if;
			end if;
			
			select	coalesce(max(nr_etapa_sol),0)
			into STRICT	nr_etapa_sol_w
			from	prescr_mat_hor a
			where	a.nr_prescricao = nr_prescricao_p
			and		a.nr_seq_solucao = nr_seq_solucao_p
			and		coalesce(a.ie_horario_especial, 'N') <> 'S'
			and		nr_seq_material = nr_seq_material_w;
			
			
			select	nextval('prescr_mat_hor_seq')
			into STRICT	nr_seq_horario_w
			;
			
            if (ie_grava_log_rastr_w = 'S') then
                CALL adep_gerar_log_rastr('{'||chr(10)||
                    '"'||$$plsql_unit||'" : "'||$$plsql_line||'",'||chr(10)||
                    '"cd_estab_prescr_w" : "'||cd_estab_prescr_w||'",'||chr(10)||
                    '"cd_local_estoque_baixa_w" : "'||cd_local_estoque_baixa_w||'",'||chr(10)||
                    '"cd_local_estoque_w" : "'||cd_local_estoque_w||'",'||chr(10)||
                    '"cd_material_w" : "'||cd_material_w||'",'||chr(10)||
                    '"cd_setor_prescr_w" : "'||cd_setor_prescr_w||'",'||chr(10)||
                    '"cd_unidade_medida_dose_w" : "'||cd_unidade_medida_dose_w||'",'||chr(10)||
                    '"cd_unidade_medida_w" : "'||cd_unidade_medida_w||'",'||chr(10)||
                    '"dt_etapa_w" : "'||to_char(dt_etapa_w, 'dd/mm/yyyy hh24:mi:ss')||'",'||chr(10)||
                    '"ie_classif_urgente_w" : "'||ie_classif_urgente_w||'",'||chr(10)||
                    '"ie_controlado_w" : "'||ie_controlado_w||'",'||chr(10)||
                    '"ie_padronizado_w" : "'||ie_padronizado_w||'",'||chr(10)||
                    '"nm_usuario_p" : "'||nm_usuario_p||'",'||chr(10)||
                    '"nr_atendimento_w" : "'||nr_atendimento_w||'",'||chr(10)||
                    '"nr_ocorrencia_w" : "'||nr_ocorrencia_w||'",'||chr(10)||
                    '"nr_prescricao_p" : "'||nr_prescricao_p||'",'||chr(10)||
                    '"nr_seq_etapa_p" : "'||nr_seq_etapa_p||'",'||chr(10)||
                    '"nr_seq_horario_w" : "'||nr_seq_horario_w||'",'||chr(10)||
                    '"nr_seq_material_w" : "'||nr_seq_material_w||'",'||chr(10)||
                    '"nr_seq_solucao_p" : "'||nr_seq_solucao_p||'",'||chr(10)||
                    '"qt_dispensar_hor_w" : "'||qt_dispensar_hor_w||'",'||chr(10)||
                    '"qt_dispensar_w" : "'||qt_dispensar_w||'",'||chr(10)||
                    '"qt_dose_w" : "'||qt_dose_w||'",'||chr(10)||
                    '"qt_horario_w" : "'||qt_horario_w||'",'||chr(10)||
                    '"sysdate" : "'||to_char(clock_timestamp(), 'dd/mm/yyyy hh24:mi:ss')||'"}', wheb_usuario_pck.get_ie_commit);
            end if;

			select	coalesce(max('S'), 'N'), coalesce(max(a.nr_etapas), 1)
			into STRICT	ie_solucao_pca_comum_w,
				nr_etapas_pca_comum_w
			from	prescr_solucao a
			where	a.nr_prescricao = nr_prescricao_p
			and	    a.nr_seq_solucao = nr_seq_solucao_p
			and		coalesce(a.ie_solucao_pca,'N') = 'S'
			and     coalesce(a.ie_acm,'N') = 'N'
			and		coalesce(a.ie_se_necessario,'N') = 'N';
			
			insert into prescr_mat_hor(
				nr_sequencia,
				nr_seq_digito,
				nr_prescricao,
				nr_seq_material,
				ie_agrupador,
				dt_atualizacao,
				nm_usuario,
				dt_atualizacao_nrec,
				nm_usuario_nrec,
				cd_material,
				qt_dose,
				qt_dispensar,
				qt_dispensar_hor,
				ds_horario,
				dt_horario,
				cd_unidade_medida,
				cd_unidade_medida_dose,
				ie_urgente,
				dt_emissao_farmacia,
				dt_fim_horario,
				dt_suspensao,
				ie_horario_especial,
				qt_hor_reaprazamento,
				nm_usuario_reaprazamento,
				nr_seq_turno,
				dt_disp_farmacia,
				ie_aprazado,
				nr_seq_solucao,
				nr_etapa_sol,
				ie_classif_urgente,
				ie_padronizado,
				ie_controlado,
				dt_lib_horario,
				nr_atendimento,
				cd_local_estoque_baixa,
				qt_horario)
			values (
				nr_seq_horario_w,
				calcula_digito('MODULO11',nr_seq_horario_w),
				nr_prescricao_p,
				nr_seq_material_w, --nr_seq_solucao_p,
				4,
				clock_timestamp(),
				nm_usuario_p,
				clock_timestamp(),
				nm_usuario_p,
				cd_material_w,
				qt_dose_w,
				qt_dispensar_w,
				coalesce(qt_dispensar_hor_w,dividir(qt_dispensar_w,nr_ocorrencia_w)),
				to_char(dt_etapa_w,'hh24:mi'),
				trunc(dt_etapa_w,'mi'),
				cd_unidade_medida_w,
				cd_unidade_medida_dose_w,
				'N',
				null,
				null,
				null,
				'N',
				null,
				null,
				obter_turno_horario_prescr(cd_estab_prescr_w, cd_setor_prescr_w, to_char(dt_etapa_w,'hh24:mi'), cd_local_estoque_w),
				clock_timestamp(),
				'S',
				nr_seq_solucao_p,
				CASE WHEN ie_solucao_pca_comum_w='S' THEN  nr_etapas_pca_comum_w + 1  ELSE nr_seq_etapa_p END ,
				ie_classif_urgente_w,
				ie_padronizado_w,
				ie_controlado_w,
				clock_timestamp(),
				nr_atendimento_w,
				cd_local_estoque_baixa_w,
				qt_horario_w);
					
			if (ie_solucao_pca_comum_w = 'S') then
				update 	prescr_solucao
				set	    nr_etapas = nr_etapas + 1
				where	nr_prescricao = nr_prescricao_p
				and	    nr_seq_solucao = nr_seq_solucao_p
				and     coalesce(ie_acm,'N') = 'N'
				and		coalesce(ie_se_necessario,'N') = 'N'
				and	    coalesce(ie_solucao_especial,'N') = 'N'			
				and		coalesce(nr_etapas,0) = nr_etapa_sol_w;
			else
				update 	prescr_solucao
				set	    nr_etapas = coalesce(nr_etapas,0) + 1
				where	nr_prescricao = nr_prescricao_p
				and	    nr_seq_solucao = nr_seq_solucao_p
				and     coalesce(ie_acm,'N') = 'S'
				and	    coalesce(ie_solucao_especial,'N') = 'N'
				and		coalesce(nr_etapas,0) = nr_etapa_sol_w
				and	    coalesce(nr_etapas,0) > 0;
			end if;
				
            if (ie_grava_log_rastr_w = 'S') then
                CALL adep_gerar_log_rastr('{'||chr(10)||
                    '"'||$$plsql_unit||'" : "'||$$plsql_line||'",'||chr(10)||
                    '"cd_estabelecimento_w" : "'||cd_estabelecimento_w||'",'||chr(10)||
                    '"cd_setor_prescr_w" : "'||cd_setor_prescr_w||'",'||chr(10)||
                    '"dt_etapa_w" : "'||to_char(dt_etapa_w, 'dd/mm/yyyy hh24:mi:ss')||'",'||chr(10)||
                    '"ie_gera_kit_sol_acm_p" : "'||ie_gera_kit_sol_acm_p||'",'||chr(10)||
                    '"nm_usuario_p" : "'||nm_usuario_p||'",'||chr(10)||
                    '"nr_atendimento_w" : "'||nr_atendimento_w||'",'||chr(10)||
                    '"nr_prescricao_p" : "'||nr_prescricao_p||'",'||chr(10)||
                    '"nr_seq_classif_param_w" : "'||nr_seq_classif_param_w||'",'||chr(10)||
                    '"nr_seq_horario_w" : "'||nr_seq_horario_w||'",'||chr(10)||
                    '"nr_seq_material_w" : "'||nr_seq_material_w||'"}', wheb_usuario_pck.get_ie_commit);
            end if;
            
			if (coalesce(ie_gera_kit_sol_acm_p, 'N') = 'S') then
				CALL aprazar_itens_dependentes(cd_estabelecimento_w, cd_setor_prescr_w, nr_atendimento_w, nr_prescricao_p, nr_seq_material_w, 0, trunc(dt_etapa_w,'mi'), 'S', nm_usuario_p, null, null, null, null, 'AES');
			end if;
			
			if (coalesce(nr_seq_classif_param_w ,0) > 0)	then
					begin
					update	prescr_mat_hor
					set	nr_seq_classif		= nr_seq_classif_param_w
					where	nr_prescricao		= nr_prescricao_p	
					and	nr_sequencia		= nr_seq_horario_w;
					end;
			else	
				open C02;
				loop
				fetch C02 into	
					nr_seq_classif_w,
					ie_classif_urgente_w,
					ie_controlado_w,
					ie_padronizado_w;
				EXIT WHEN NOT FOUND; /* apply on C02 */
					begin
				
					if (ie_controlado_w = 'A') and (ie_padronizado_w = 'A') then
						update	prescr_mat_hor
						set	nr_seq_classif		= nr_seq_classif_w
						where	nr_prescricao		= nr_prescricao_p	
						and	nr_sequencia		= nr_seq_horario_w
						--and	nr_seq_lote		is not null
						and	ie_classif_urgente	= ie_classif_urgente_w;
					elsif (ie_controlado_w = 'A') and (ie_padronizado_w = 'S') then
						update	prescr_mat_hor
						set	nr_seq_classif		= nr_seq_classif_w
						where	nr_prescricao		= nr_prescricao_p
						and	ie_padronizado		= 'S'
						and	nr_sequencia		= nr_seq_horario_w
						--and	nr_seq_lote		is not null
						and	ie_classif_urgente	= ie_classif_urgente_w;
					elsif (ie_controlado_w = 'A') and (ie_padronizado_w = 'N') then
						update	prescr_mat_hor
						set	nr_seq_classif		= nr_seq_classif_w
						where	nr_prescricao		= nr_prescricao_p
						and	ie_padronizado		= 'N'
						and	nr_sequencia		= nr_seq_horario_w
						--and	nr_seq_lote		is not null
						and	ie_classif_urgente	= ie_classif_urgente_w;
					elsif (ie_controlado_w = 'N') and (ie_padronizado_w = 'A') then
						update	prescr_mat_hor
						set	nr_seq_classif		= nr_seq_classif_w
						where	nr_prescricao		= nr_prescricao_p
						and	ie_controlado		= 'N'
						and	nr_sequencia		= nr_seq_horario_w;
						--and	nr_seq_lote		is not null

						--and	ie_classif_urgente	= ie_classif_urgente_w;
					elsif (ie_controlado_w = 'N') and (ie_padronizado_w = 'N') then
						update	prescr_mat_hor
						set	nr_seq_classif		= nr_seq_classif_w
						where	nr_prescricao		= nr_prescricao_p
						and	ie_controlado		= 'N'
						and	ie_padronizado		= 'N'
						and	nr_sequencia		= nr_seq_horario_w
						--and	nr_seq_lote		is not null
						and	ie_classif_urgente	= ie_classif_urgente_w;
					elsif (ie_controlado_w = 'N') and (ie_padronizado_w = 'S') then
						update	prescr_mat_hor
						set	nr_seq_classif		= nr_seq_classif_w
						where	nr_prescricao		= nr_prescricao_p
						and	ie_controlado		= 'N'
						and	ie_padronizado		= 'S'
						--and	nr_seq_lote		is not null
						and	nr_sequencia		= nr_seq_horario_w
						and	ie_classif_urgente	= ie_classif_urgente_w;
					elsif (ie_controlado_w = 'S') and (ie_padronizado_w = 'A') then
						update	prescr_mat_hor
						set	nr_seq_classif		= nr_seq_classif_w
						where	nr_prescricao		= nr_prescricao_p
						and	ie_controlado		= 'S'
						--and	nr_seq_lote		is not null
						and	nr_sequencia		= nr_seq_horario_w
						and	ie_classif_urgente	= ie_classif_urgente_w;
					elsif (ie_controlado_w = 'S') and (ie_padronizado_w = 'N') then
						update	prescr_mat_hor
						set	nr_seq_classif		= nr_seq_classif_w
						where	nr_prescricao		= nr_prescricao_p
						and	ie_controlado		= 'S'
						and	ie_padronizado		= 'N'
						--and	nr_seq_lote		is not null
						and	nr_sequencia		= nr_seq_horario_w
						and	ie_classif_urgente	= ie_classif_urgente_w;
					elsif (ie_controlado_w = 'S') and (ie_padronizado_w = 'S') then
						update	prescr_mat_hor
						set	nr_seq_classif		= nr_seq_classif_w
						where	nr_prescricao		= nr_prescricao_p
						and	ie_controlado		= 'S'
						and	ie_padronizado		= 'S'
						--and	nr_seq_lote		is not null
						and	nr_sequencia		= nr_seq_horario_w
						and	ie_classif_urgente	= ie_classif_urgente_w;
					end if;
					end;
				end loop;
				close C02;
			end if;	
				
			/*if	(nr_prescr_atual_w <> nr_prescricao_p) and  OS159707 
				(nvl(nr_seq_horario_w,0) > 0) then
				begin
				Gerar_Lote_Atend_Prescricao(nr_prescricao_p, nr_seq_material_w, nr_seq_horario_w, 'N', nm_usuario_p, 'AIP');
				end;
			end if;*/
			if (ie_registro_w = 2) and
				((coalesce(ie_horario_acm_w,'S') = 'N') or (coalesce(ie_horario_sn_w,'S') = 'N')) then
				begin
				select	coalesce(max(obter_valor_param_usuario(924, 179, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w)),'N')
				into STRICT	ajustar_disp_hor_farm_w
				;
				exception
					when others then
					ajustar_disp_hor_farm_w := 'N';
				end;

				begin
				if (ajustar_disp_hor_farm_w <> 'N') then
					begin
					CALL calcular_dispensar_horario(nr_prescricao_p, nr_seq_horario_w);
					end;
				end if;
				exception
					when others then
					ajustar_disp_hor_farm_w := 'N';
				end;
			end if;			
			/* atualizar prescricao */

			nr_prescr_atual_w := nr_prescricao_p;

			if	((ie_gerar_necessidade_disp_w = 'S') or (ie_regra_disp_w <> 'N')) then
				update	prescr_medica
				set		dt_emissao_farmacia	 = NULL,
						nm_usuario_imp_far	 = NULL
				where	nr_prescricao		= nr_prescricao_p;

				update	prescr_material
				set		cd_motivo_baixa	= 0,
						dt_baixa	 = NULL
				where	nr_prescricao	= nr_prescricao_p
				and		nr_sequencia	= nr_seq_material_w;
				
				if (ie_gerar_nec_disp_kit_w = 'S') then
					update	prescr_material
					set		cd_motivo_baixa	= 0,
							dt_baixa		 = NULL
					where	nr_prescricao			= nr_prescricao_p
					and		nr_sequencia_diluicao	= nr_seq_material_w;

					update	prescr_material
					set		cd_motivo_baixa	= 0,
							dt_baixa		 = NULL
					where	nr_prescricao	= nr_prescricao_p
					and		nr_seq_kit		= nr_seq_material_w;
				end if;
			end if;

			end;
		end loop;
		close c01;
		
		open C21;
		loop
		fetch C21 into	
			nr_seq_horario_w,
			cd_local_estoque_w,
			ds_horario_w,
			nr_seq_item_w,
			cd_estab_prescr_w,
			cd_setor_prescr_w;
		EXIT WHEN NOT FOUND; /* apply on C21 */
			if (ie_local_estoque_mat_hor_w	= 'S') then
				
				CALL define_disp_prescr_mat_hor(nr_seq_horario_w, nr_prescricao_p, nr_seq_item_w, obter_perfil_ativo, nm_usuario_p);
			
				select	coalesce(max(cd_local_estoque),cd_local_estoque_w)
				into STRICT	cd_local_estoque_w
				from	prescr_mat_hor
				where	nr_sequencia	= nr_seq_horario_w;
				
				update	prescr_mat_hor
				set	nr_seq_turno	= coalesce(Obter_turno_horario_prescr(cd_estab_prescr_w, cd_setor_prescr_w, ds_horario_w, cd_local_estoque_w),nr_seq_turno)
				where	nr_sequencia	= nr_seq_horario_w;
			end if;
		end loop;
		close C21;

		CALL Gerar_Lote_Atend_Prescricao(nr_prescricao_p, null, 0, 'S', nm_usuario_p, 'AIP');
		
		if (varie_cursor_w = 'S') and (ie_gerar_processo_w = 'S') then
			begin
			CALL adep_gerar_area_prep(nr_prescricao_p, null, nm_usuario_p);
			nr_seq_processo_w := gerar_processo_adep_sol(nr_atendimento_w, nr_prescricao_p, nr_seq_solucao_p, nr_seq_etapa_p, trunc(dt_etapa_w,'mi'), nm_usuario_p, nr_seq_processo_w, ie_somente_gedipa_p, cd_funcao_origem_p, 'AIS', ie_setor_gedipa_w, null, null);

			update	prescr_mat_hor a
			set	a.nr_seq_processo	= nr_seq_processo_w
			where	a.nr_prescricao		= nr_prescricao_p
			and	a.dt_horario		= trunc(dt_etapa_w,'mi')
			and	coalesce(a.ie_horario_especial,'N') <> 'S'
			and	a.ie_agrupador		= 4
			and 	exists (
					SELECT	1
					from	prescr_material b
					where	b.nr_prescricao		= a.nr_prescricao
					and	b.nr_sequencia		= a.nr_seq_material
					and	b.ie_agrupador		= 4
					and	b.nr_sequencia_solucao	= nr_seq_solucao_p);

			CALL atual_proc_area_kit_comp_sol(nr_seq_processo_w, nr_prescricao_p, nr_seq_solucao_p, trunc(dt_etapa_w,'mi'),null,'N');
			if (ie_setor_gedipa_w = 'S') then
				begin
				CALL gerar_frac_proc_sol(nr_seq_processo_w, nr_prescricao_p, nr_seq_solucao_p,'S', nm_usuario_p,null,'N');
				end;
			end if;
			end;
		end if;
		dt_etapa_w := dt_etapa_w + qt_horas_etapa_w / 24;
		end;
	end if;
	
	select	max(nr_seq_lote)
	into STRICT	nr_seq_lote_w
	from	prescr_mat_hor a
	where	a.nr_prescricao		= nr_prescricao_p
	and	(nr_seq_lote IS NOT NULL AND nr_seq_lote::text <> '')
	and	nr_etapa_sol		= nr_seq_etapa_p
	and 	exists (SELECT	1
			from	prescr_material b
			where	b.nr_prescricao		= a.nr_prescricao
			and	b.nr_sequencia		= a.nr_seq_material
			and	b.ie_agrupador		= 4
			and	b.nr_sequencia_solucao	= nr_seq_solucao_p);
	
	select	nextval('prescr_solucao_evento_seq')
	into STRICT	nr_sequencia_w
	;

	insert into prescr_solucao_evento(
		nr_sequencia,
		dt_atualizacao,
		nm_usuario,
		dt_atualizacao_nrec,
		nm_usuario_nrec,
		nr_prescricao,
		nr_seq_solucao,
		nr_seq_material,
		nr_seq_procedimento,
		nr_seq_nut,
		nr_seq_nut_neo,
		ie_forma_infusao,
		ie_tipo_dosagem,
		qt_dosagem,
		qt_vol_infundido,
		qt_vol_desprezado,
		cd_pessoa_fisica,
		ie_alteracao,
		dt_alteracao,
		ie_evento_valido,
		nr_seq_motivo,
		ds_observacao,
		ie_tipo_solucao,
		DT_APRAZAMENTO,
		nr_etapa_evento,
		nr_seq_lote,
		nr_seq_assinatura)
	values (
		nr_sequencia_w,
		clock_timestamp(),
		nm_usuario_p,
		clock_timestamp(),
		nm_usuario_p,
		nr_prescricao_p,
		CASE WHEN ie_tipo_solucao_p=1 THEN nr_seq_solucao_p  ELSE null END ,
		CASE WHEN ie_tipo_solucao_p=2 THEN nr_seq_solucao_p  ELSE null END ,
		CASE WHEN ie_tipo_solucao_p=3 THEN nr_seq_solucao_p  ELSE null END ,
		CASE WHEN ie_tipo_solucao_p=4 THEN nr_seq_solucao_p  ELSE null END ,
		CASE WHEN ie_tipo_solucao_p=5 THEN nr_seq_solucao_p  ELSE null END ,
		null,
		null,
		null,
		null,
		null,
		obter_dados_usuario_opcao(nm_usuario_p, 'C'),
		16,
		clock_timestamp(),
		'S',
		nr_seq_motivo_p,
		ds_observacao_p,
		ie_tipo_solucao_p,
		dt_inicio_p,
		nr_seq_etapa_p,
		nr_seq_lote_w,
		nr_seq_assinatura_p);

        if (ie_grava_log_rastr_w = 'S') then
            CALL adep_gerar_log_rastr('{'||chr(10)||
                '"'||$$plsql_unit||'" : "'||$$plsql_line||'",'||chr(10)||
                '"ds_observacao_p" : "'||ds_observacao_p||'",'||chr(10)||
                '"dt_inicio_p" : "'||to_char(dt_inicio_p, 'dd/mm/yyyy hh24:mi:ss')||'",'||chr(10)||
                '"ie_tipo_solucao_p" : "'||ie_tipo_solucao_p||'",'||chr(10)||
                '"nm_usuario_p" : "'||nm_usuario_p||'",'||chr(10)||
                '"nr_prescricao_p" : "'||nr_prescricao_p||'",'||chr(10)||
                '"nr_seq_assinatura_p" : "'||nr_seq_assinatura_p||'",'||chr(10)||
                '"nr_seq_etapa_p" : "'||nr_seq_etapa_p||'",'||chr(10)||
                '"nr_seq_lote_w" : "'||nr_seq_lote_w||'",'||chr(10)||
                '"nr_seq_motivo_p" : "'||nr_seq_motivo_p||'",'||chr(10)||
                '"nr_seq_solucao_p" : "'||nr_seq_solucao_p||'",'||chr(10)||
                '"nr_sequencia_w" : "'||nr_sequencia_w||'",'||chr(10)||
                '"sysdate" : "'||to_char(clock_timestamp(), 'dd/mm/yyyy hh24:mi:ss')||'"}', wheb_usuario_pck.get_ie_commit);
        end if;
		
		ie_gera_sem_certificado_w	:= 'N';
		
		if (wheb_assist_pck.get_gerar_sem_certificado = 'S') then
			ie_gera_sem_certificado_w := adep_obter_se_assin_perfil(50592, obter_perfil_ativo); --ADEP - Aprazamento de itens
		end if;
		
		if	((wheb_assist_pck.get_cd_certificado IS NOT NULL AND wheb_assist_pck.get_cd_certificado::text <> '') OR (ie_gera_sem_certificado_w = 'S')) AND (coalesce(obter_data_assinatura_digital(nr_seq_assinatura_p)::text, '') = '') then
			
	        select	max(cd_pessoa_fisica)
			into STRICT	cd_pessoa_fisica_w
			from	atendimento_paciente
			where	nr_atendimento = nr_atendimento_w;
	
            if (ie_grava_log_rastr_w = 'S') then
                CALL adep_gerar_log_rastr('{'||chr(10)||
                    '"'||$$plsql_unit||'" : "'||$$plsql_line||'",'||chr(10)||
                    '"cd_pessoa_fisica_w" : "'||cd_pessoa_fisica_w||'",'||chr(10)||
                    '"nm_usuario_p" : "'||nm_usuario_p||'",'||chr(10)||
                    '"nr_atendimento_w" : "'||nr_atendimento_w||'",'||chr(10)||
                    '"nr_prescricao_p" : "'||nr_prescricao_p||'",'||chr(10)||
                    '"nr_seq_horario_w" : "'||nr_seq_horario_w||'",'||chr(10)||
                    '"nr_sequencia_w" : "'||nr_sequencia_w||'"}', wheb_usuario_pck.get_ie_commit);
            end if;

			CALL Gerar_registro_pendente_PEP('ADEP',nr_prescricao_p, cd_pessoa_fisica_w, nr_atendimento_w, nm_usuario_p, 'A', nr_seq_horario_w, 'SOL',null,null,null,null,null,null,null,null,null,null,null,null,null,null,nr_sequencia_w);

		end if;	
		
	end;
end if;
commit;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE aprazar_etapa_solucao ( ie_tipo_solucao_p bigint, nr_prescricao_p bigint, nr_seq_solucao_p bigint, dt_inicio_p timestamp, nr_seq_motivo_p bigint, ds_observacao_p text, nm_usuario_p text, ie_somente_gedipa_p text, cd_funcao_origem_p bigint, ie_gedipa_p text, nr_seq_etapa_p bigint, ie_gera_kit_sol_acm_p text, nr_seq_assinatura_p bigint default 0) FROM PUBLIC;

