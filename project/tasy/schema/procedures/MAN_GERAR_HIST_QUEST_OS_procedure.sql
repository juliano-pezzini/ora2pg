-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE man_gerar_hist_quest_os ( nr_seq_os_p bigint, nm_usuario_p text) AS $body$
DECLARE



nr_seq_modelo_quest_philips_w	bigint;
ds_historico_w			varchar(32000);

c01 CURSOR FOR
SELECT	nr_seq_pergunta,
	substr(obter_desc_pergunta_os(nr_seq_pergunta),1,255) ds_pergunta,
	ds_resultado,
	dt_resultado,
	vl_resultado,
	substr(man_obter_resp_quest_philips(nr_seq_ordem, nr_seq_pergunta, 'D'),1,255) ds_resposta
from	man_os_resp_quest_philips
where	nr_seq_ordem = nr_seq_os_p
order by	nr_sequencia;

c01_w	c01%rowtype;


BEGIN

if (nr_seq_os_p > 0) then
	begin
	select	nr_seq_modelo_quest_philips
	into STRICT	nr_seq_modelo_quest_philips_w
	from	man_ordem_servico
	where	nr_sequencia = nr_seq_os_p;

	if (nr_seq_modelo_quest_philips_w > 0) then
		open C01;
		loop
		fetch C01 into
			c01_w;
		EXIT WHEN NOT FOUND; /* apply on C01 */
			begin
			ds_historico_w := substr(ds_historico_w || c01_w.ds_pergunta || ': ' ||
							c01_w.ds_resposta || chr(13) || chr(10),1,32000);
			end;
		end loop;
		close C01;

	end if;

	if (coalesce(ds_historico_w,'X') <> 'X') then
		insert into man_ordem_serv_tecnico(
				nr_sequencia,
				nr_seq_ordem_serv,
				dt_atualizacao,
				nm_usuario,
				ds_relat_tecnico,
				dt_historico,
				ie_origem,
				dt_liberacao,
				nm_usuario_lib)
			values (	nextval('man_ordem_serv_tecnico_seq'),
				nr_seq_os_p,
				clock_timestamp(),
				nm_usuario_p,
				ds_historico_w,
				clock_timestamp(),
				'I',
				clock_timestamp(),
				nm_usuario_p);
	end if;

	commit;
	end;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE man_gerar_hist_quest_os ( nr_seq_os_p bigint, nm_usuario_p text) FROM PUBLIC;

