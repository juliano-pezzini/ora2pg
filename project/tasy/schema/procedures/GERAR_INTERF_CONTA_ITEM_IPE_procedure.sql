-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_interf_conta_item_ipe ( nr_seq_protocolo_p bigint, nr_interno_conta_p bigint) AS $body$
DECLARE


nr_sequencia_w                  bigint := 0;
tp_nota_w                       smallint;
cd_prestador_w                  varchar(14);
ie_prestador_w                  varchar(14);
nr_interno_conta_w                      bigint;
nr_atendimento_w                        bigint;
dt_item_w                       timestamp;
cd_item_convenio_w              bigint;
cd_item_w                       bigint;
qt_item_w                       double precision;
cd_funcao_executor_w            smallint;
cd_funcao_exec_item_w           smallint;
ie_via_acesso_w                 varchar(1);
ie_urgencia_w                   smallint;
vl_honorario_w                  double precision;
vl_total_item_w                 double precision;
cd_brasindice_w                 varchar(13);
cd_medico_executor_w            varchar(10);
cd_medico_exec_conv_w           varchar(15);
nm_medico_executor_w            varchar(60);
nr_crm_executor_w                       varchar(20);
uf_crm_executor_w                       varchar(2);
nr_cpf_executor_w                       varchar(11);
nr_seq_protocolo_w              bigint;
cd_convenio_w                   integer;
cd_cgc_hospital_w                       varchar(14);
cd_cgc_convenio_w               varchar(14);
cd_interno_w                    varchar(15);
ie_responsavel_credito_w                varchar(5);
nr_folha_w                      bigint;
nr_linha_w                      bigint:= 0;
ds_item_w                       varchar(240);
tp_nota_ant_w                   smallint := 0;
ie_tipo_item_w                  smallint;
nr_seq_espitem_w                        bigint;
cd_tipo_item_interf_w           smallint;
cd_area_procedimento_w          bigint;
pr_via_acesso_w                 double precision;
ie_via_acesso_ipe_w             smallint;

ie_tipo_atendimento_w           smallint;
nr_seq_proc_princ_w             bigint;
vl_matmed_proc_princ_w          double precision;
vl_unit_matmed_princ_w          double precision;
cd_procedimento_ref_w           bigint;
cd_area_proc_ref_w              bigint;
nr_seq_proc_ref_w                       bigint;

ie_medico_w                     varchar(1);
ie_auxiliar_w                   varchar(1);
nr_indaux_w                     smallint;
nr_interno_conta_ant_w          bigint;
cd_item_convenio_ant_w          bigint;
qt_auxiliares_w                 integer       :=0;
nr_seq_conta_convenio_w         bigint;
nr_seq_item_w                   bigint;
nr_seq_item_ant_w                       bigint;
nr_seq_partic_w                 bigint;
ie_origem_proced_w              bigint;
ie_origem_proc_ref_w		bigint;
ie_forma_apresent_w             bigint;
qt_aux_item_w                   bigint;
qt_aux_exec_w                   bigint;

cd_medico_exec_proc_w           varchar(10);
cd_medico_exec_ant_w            varchar(10);
vl_original_w                   double precision:=0;
vl_unitario_item_w                      double precision;

cd_cgc_prestador_w              varchar(14);
cd_estabelecimento_w            smallint;

ie_regra_auxiliar_ipe_w         varchar(01):= 'I';
ie_agrupa_data_ipe_w            varchar(01):= 'N';
ie_agrup_data_serv_ipe_w            varchar(01):= 'S';
ie_medic_aux_princ_ipe_w                varchar(01):= 'N';
ie_video_w                      varchar(01);
ie_utiliza_video_w                      varchar(01):= 'N';
ie_campo_ordem_w                        smallint;
qt_item_conv_div_w              double precision;
nr_seq_partic_ww                        bigint;

nr_nota_inicial_w                       bigint;
nr_conta_ant_w                  bigint:= 0;

ie_gera_matmed_fora_conta_w     varchar(01):= 'N';
ie_consid_item_neg_ipe_int_w    varchar(01):= 'N';
vl_custo_oper_w                 double precision := 0;
ie_exc_matmed_vlzero_ipe_int_w  parametro_faturamento.ie_exc_matmed_vlzero_ipe_int%type;
ie_ordem_taxa_w                 bigint;
cd_unidade_medida_w             varchar(30);
cd_regra_hon_som_filme_ipe_w	convenio_estabelecimento.cd_regra_hon_som_filme_ipe%type;
cd_conv_protocolo_w		protocolo_convenio.cd_convenio%type;
ie_ordem_val_item_ipe_w         parametro_faturamento.ie_ordem_val_item_ipe%type;

c01 CURSOR FOR
         SELECT a.nr_seq_protocolo,--1
                c.ie_tipo_item,--2
                CASE WHEN c.cd_cgc_hospital='87768735000148' THEN  1  ELSE CASE WHEN c.cd_item_convenio='40812022' THEN  c.nr_seq_item WHEN c.cd_item_convenio='40812030' THEN  c.nr_seq_item WHEN c.cd_item_convenio='40812049' THEN  c.nr_seq_item WHEN c.cd_item_convenio='40812057' THEN  c.nr_seq_item WHEN c.cd_item_convenio='40812073' THEN  c.nr_seq_item WHEN c.cd_item_convenio='40812065' THEN  c.nr_seq_item  ELSE ipe_obter_min_seq_item(c.nr_interno_conta, c.cd_item_convenio) END  END  nr_seq_espitem,--3
                CASE WHEN c.cd_cgc_hospital='92741016000254' THEN 					CASE WHEN a.ie_tipo_atendimento=1 THEN 						CASE WHEN x.cd_area_procedimento=3 THEN 							CASE WHEN x.cd_especialidade=25000004 THEN r.nr_tipo_nota  ELSE CASE WHEN coalesce(c.cd_medico_executor,'X')='X' THEN r.nr_tipo_nota  ELSE 75 END  END   ELSE r.nr_tipo_nota END  WHEN a.ie_tipo_atendimento=8 THEN 					CASE WHEN x.cd_area_procedimento=3 THEN 						CASE WHEN coalesce(c.cd_medico_executor,'X')='X' THEN r.nr_tipo_nota  ELSE 85 END   ELSE r.nr_tipo_nota END   ELSE r.nr_tipo_nota END   ELSE r.nr_tipo_nota END  tp_nota,--4
                somente_numero(coalesce(c.nr_cpf_executor,coalesce(c.cd_cgc_prestador,c.cd_cgc_hospital))) cd_prestador,--5
                c.nr_interno_conta,--6
                CASE WHEN a.ie_tipo_atendimento=1 THEN                         CASE WHEN  CASE WHEN c.cd_cgc_hospital='92741016000254' THEN                                         CASE WHEN a.ie_tipo_atendimento=1 THEN                                                 CASE WHEN x.cd_area_procedimento=3 THEN                                                         CASE WHEN x.cd_especialidade=25000004 THEN r.nr_tipo_nota  ELSE CASE WHEN coalesce(c.cd_medico_executor,'X')='X' THEN r.nr_tipo_nota  ELSE 75 END  END   ELSE r.nr_tipo_nota END   ELSE r.nr_tipo_nota END   ELSE r.nr_tipo_nota END =75 THEN c.dt_item WHEN  CASE WHEN c.cd_cgc_hospital='92741016000254' THEN                                         CASE WHEN a.ie_tipo_atendimento=1 THEN                                                 CASE WHEN x.cd_area_procedimento=3 THEN                                                         CASE WHEN x.cd_especialidade=25000004 THEN r.nr_tipo_nota  ELSE CASE WHEN coalesce(c.cd_medico_executor,'X')='X' THEN r.nr_tipo_nota  ELSE 75 END  END   ELSE r.nr_tipo_nota END   ELSE r.nr_tipo_nota END   ELSE r.nr_tipo_nota END =76 THEN CASE WHEN c.cd_cgc_hospital='92815000000168' THEN  CASE WHEN c.cd_item_convenio='2054' THEN  trunc(a.dt_periodo_inicial) WHEN c.cd_item_convenio='2062' THEN  trunc(a.dt_periodo_inicial) WHEN c.cd_item_convenio='2070' THEN  trunc(a.dt_periodo_inicial) WHEN c.cd_item_convenio='2089' THEN  trunc(a.dt_periodo_inicial)  ELSE trunc(c.dt_item) END  WHEN c.cd_cgc_hospital='92741016000254' THEN  CASE WHEN c.cd_item_convenio='2054' THEN  trunc(a.dt_periodo_inicial) WHEN c.cd_item_convenio='2062' THEN  trunc(a.dt_periodo_inicial) WHEN c.cd_item_convenio='2070' THEN  trunc(a.dt_periodo_inicial) WHEN c.cd_item_convenio='2089' THEN  trunc(a.dt_periodo_inicial)  ELSE trunc(c.dt_item) END   ELSE CASE WHEN c.cd_item_convenio='93481837' THEN  c.dt_item WHEN c.cd_item_convenio='248' THEN  c.dt_item  ELSE trunc(c.dt_item) END  END  WHEN  CASE WHEN c.cd_cgc_hospital='92741016000254' THEN                                         CASE WHEN a.ie_tipo_atendimento=1 THEN                                                 CASE WHEN x.cd_area_procedimento=3 THEN                                                         CASE WHEN x.cd_especialidade=25000004 THEN r.nr_tipo_nota  ELSE CASE WHEN coalesce(c.cd_medico_executor,'X')='X' THEN r.nr_tipo_nota  ELSE 75 END  END   ELSE r.nr_tipo_nota END   ELSE r.nr_tipo_nota END   ELSE r.nr_tipo_nota END =86 THEN CASE WHEN c.cd_cgc_hospital='92815000000168' THEN 									CASE WHEN c.cd_item_convenio='2054' THEN  trunc(a.dt_periodo_inicial) WHEN c.cd_item_convenio='2062' THEN  trunc(a.dt_periodo_inicial) WHEN c.cd_item_convenio='2070' THEN  trunc(a.dt_periodo_inicial) WHEN c.cd_item_convenio='2089' THEN  trunc(a.dt_periodo_inicial)  ELSE trunc(c.dt_item) END   ELSE trunc(c.dt_item) END  WHEN  CASE WHEN c.cd_cgc_hospital='92741016000254' THEN                                         CASE WHEN a.ie_tipo_atendimento=1 THEN                                                 CASE WHEN x.cd_area_procedimento=3 THEN                                                         CASE WHEN x.cd_especialidade=25000004 THEN r.nr_tipo_nota  ELSE CASE WHEN coalesce(c.cd_medico_executor,'X')='X' THEN r.nr_tipo_nota  ELSE 75 END  END   ELSE r.nr_tipo_nota END   ELSE r.nr_tipo_nota END   ELSE r.nr_tipo_nota END =85 THEN c.dt_item WHEN  CASE WHEN c.cd_cgc_hospital='92741016000254' THEN                                         CASE WHEN a.ie_tipo_atendimento=1 THEN                                                 CASE WHEN x.cd_area_procedimento=3 THEN                                                         CASE WHEN x.cd_especialidade=25000004 THEN r.nr_tipo_nota  ELSE CASE WHEN coalesce(c.cd_medico_executor,'X')='X' THEN r.nr_tipo_nota  ELSE 75 END  END   ELSE r.nr_tipo_nota END   ELSE r.nr_tipo_nota END   ELSE r.nr_tipo_nota END =77 THEN 	CASE WHEN c.cd_item_convenio='40812022' THEN  c.dt_item WHEN c.cd_item_convenio='40812030' THEN  c.dt_item WHEN c.cd_item_convenio='40812049' THEN  c.dt_item WHEN c.cd_item_convenio='40812057' THEN  c.dt_item WHEN c.cd_item_convenio='40812073' THEN  c.dt_item WHEN c.cd_item_convenio='40812065' THEN  c.dt_item  ELSE CASE WHEN ie_agrup_data_serv_ipe_w='N' THEN  c.dt_item  ELSE trunc(c.dt_item) END  END  WHEN  CASE WHEN c.cd_cgc_hospital='92741016000254' THEN                                         CASE WHEN a.ie_tipo_atendimento=1 THEN                                                 CASE WHEN x.cd_area_procedimento=3 THEN                                                         CASE WHEN x.cd_especialidade=25000004 THEN r.nr_tipo_nota  ELSE CASE WHEN coalesce(c.cd_medico_executor,'X')='X' THEN r.nr_tipo_nota  ELSE 75 END  END   ELSE r.nr_tipo_nota END   ELSE r.nr_tipo_nota END   ELSE r.nr_tipo_nota END =87 THEN 	CASE WHEN c.cd_item_convenio='40812022' THEN  c.dt_item WHEN c.cd_item_convenio='40812030' THEN  c.dt_item WHEN c.cd_item_convenio='40812049' THEN  c.dt_item WHEN c.cd_item_convenio='40812057' THEN  c.dt_item WHEN c.cd_item_convenio='40812073' THEN  c.dt_item WHEN c.cd_item_convenio='40812065' THEN  c.dt_item  ELSE trunc(c.dt_item) END   ELSE CASE WHEN c.cd_item_convenio='8001' THEN a.dt_alta  ELSE CASE WHEN c.ie_tipo_item=1 THEN 													CASE WHEN c.cd_tipo_item_interf=2 THEN CASE WHEN c.cd_cgc_hospital='87317764001084' THEN c.dt_item  ELSE trunc(c.dt_item) END  WHEN c.cd_tipo_item_interf=6 THEN trunc(c.dt_item) WHEN c.cd_tipo_item_interf=3 THEN CASE WHEN c.cd_cgc_hospital='87317764001084' THEN c.dt_item  ELSE trunc(c.dt_item) END   ELSE trunc(a.dt_entrada) END   ELSE trunc(c.dt_item) END  END  END  WHEN a.ie_tipo_atendimento=8 THEN CASE WHEN ie_agrupa_data_ipe_w='S' THEN  c.dt_item  ELSE trunc(c.dt_item) END   ELSE trunc(a.dt_entrada) END  dt_item,--7
                somente_numero(CASE WHEN a.ie_tipo_atendimento=3 THEN CASE WHEN c.ie_tipo_item=1 THEN c.cd_item_convenio WHEN c.ie_tipo_item=2 THEN CASE WHEN c.cd_tipo_item_interf=5 THEN '98007530' WHEN c.cd_tipo_item_interf=4 THEN '98007963'  ELSE '98007963' END   ELSE c.cd_item_convenio END   ELSE c.cd_item_convenio END ) cd_item_convenio,--8
                sum(c.qt_item) qt_item,--9
                sum(c.qt_item_conv_div) qt_item_conv_div,--10
                CASE WHEN c.cd_cgc_hospital='92812049000914' THEN obter_seq_partic_proc_func(c.nr_seq_item, c.cd_funcao_executor) WHEN c.cd_cgc_hospital='87096616004779' THEN obter_seq_partic_proc_func(c.nr_seq_item, c.cd_funcao_executor)  ELSE null END  nr_seq_partic,--11
                coalesce(c.cd_funcao_executor,0) cd_funcao_executor,--12
                c.ie_via_acesso_inf,
                CASE WHEN coalesce(c.pr_hora_extra,0)=0 THEN 0 WHEN coalesce(c.pr_hora_extra,0)=1 THEN 0  ELSE 11 END  ie_urgencia,
                sum(CASE WHEN c.ie_responsavel_credito=coalesce(cd_regra_hon_som_filme_ipe_w,'0') THEN (coalesce(c.vl_filme,0)+coalesce(c.vl_honorario,0))  ELSE c.vl_honorario END ) vl_honorario,
                sum(CASE WHEN c.cd_cgc_hospital='92741016000254' THEN  CASE WHEN ie_responsavel_credito='P' THEN (c.vl_filme + coalesce(c.vl_honorario,c.vl_total_item))  ELSE  --OS 254026
						CASE WHEN c.cd_item_convenio ='40812022' THEN  CASE WHEN r.nr_tipo_nota=75 THEN  c.vl_honorario WHEN r.nr_tipo_nota=77 THEN  c.vl_custo_oper WHEN r.nr_tipo_nota=85 THEN  c.vl_honorario WHEN r.nr_tipo_nota=87 THEN  c.vl_custo_oper END  WHEN c.cd_item_convenio ='40812030' THEN  CASE WHEN r.nr_tipo_nota=75 THEN  c.vl_honorario WHEN r.nr_tipo_nota=77 THEN  c.vl_custo_oper WHEN r.nr_tipo_nota=85 THEN  c.vl_honorario WHEN r.nr_tipo_nota=87 THEN  c.vl_custo_oper END  WHEN c.cd_item_convenio ='40812049' THEN  CASE WHEN r.nr_tipo_nota=75 THEN  c.vl_honorario WHEN r.nr_tipo_nota=77 THEN  c.vl_custo_oper WHEN r.nr_tipo_nota=85 THEN  c.vl_honorario WHEN r.nr_tipo_nota=87 THEN  c.vl_custo_oper END  WHEN c.cd_item_convenio ='40812057' THEN  CASE WHEN r.nr_tipo_nota=75 THEN  c.vl_honorario WHEN r.nr_tipo_nota=77 THEN  c.vl_custo_oper WHEN r.nr_tipo_nota=85 THEN  c.vl_honorario WHEN r.nr_tipo_nota=87 THEN  c.vl_custo_oper END  WHEN c.cd_item_convenio ='40812073' THEN  CASE WHEN r.nr_tipo_nota=75 THEN  c.vl_honorario WHEN r.nr_tipo_nota=77 THEN  c.vl_custo_oper WHEN r.nr_tipo_nota=85 THEN  c.vl_honorario WHEN r.nr_tipo_nota=87 THEN  c.vl_custo_oper END  WHEN c.cd_item_convenio ='40812065' THEN  CASE WHEN r.nr_tipo_nota=75 THEN  c.vl_honorario WHEN r.nr_tipo_nota=77 THEN  c.vl_custo_oper WHEN r.nr_tipo_nota=85 THEN  c.vl_honorario WHEN r.nr_tipo_nota=87 THEN  c.vl_custo_oper END   ELSE c.vl_total_item END  END  WHEN c.cd_cgc_hospital='92741016000173' THEN  CASE WHEN ie_responsavel_credito='P' THEN (c.vl_filme + c.vl_total_item)  ELSE CASE WHEN c.cd_item_convenio ='40812022' THEN  CASE WHEN r.nr_tipo_nota=75 THEN  c.vl_honorario WHEN r.nr_tipo_nota=77 THEN  c.vl_custo_oper WHEN r.nr_tipo_nota=85 THEN  c.vl_honorario WHEN r.nr_tipo_nota=87 THEN  c.vl_custo_oper END  WHEN c.cd_item_convenio ='40812030' THEN  CASE WHEN r.nr_tipo_nota=75 THEN  c.vl_honorario WHEN r.nr_tipo_nota=77 THEN  c.vl_custo_oper WHEN r.nr_tipo_nota=85 THEN  c.vl_honorario WHEN r.nr_tipo_nota=87 THEN  c.vl_custo_oper END  WHEN c.cd_item_convenio ='40812049' THEN  CASE WHEN r.nr_tipo_nota=75 THEN  c.vl_honorario WHEN r.nr_tipo_nota=77 THEN  c.vl_custo_oper WHEN r.nr_tipo_nota=85 THEN  c.vl_honorario WHEN r.nr_tipo_nota=87 THEN  c.vl_custo_oper END  WHEN c.cd_item_convenio ='40812057' THEN  CASE WHEN r.nr_tipo_nota=75 THEN  c.vl_honorario WHEN r.nr_tipo_nota=77 THEN  c.vl_custo_oper WHEN r.nr_tipo_nota=85 THEN  c.vl_honorario WHEN r.nr_tipo_nota=87 THEN  c.vl_custo_oper END  WHEN c.cd_item_convenio ='40812073' THEN  CASE WHEN r.nr_tipo_nota=75 THEN  c.vl_honorario WHEN r.nr_tipo_nota=77 THEN  c.vl_custo_oper WHEN r.nr_tipo_nota=85 THEN  c.vl_honorario WHEN r.nr_tipo_nota=87 THEN  c.vl_custo_oper END  WHEN c.cd_item_convenio ='40812065' THEN  CASE WHEN r.nr_tipo_nota=75 THEN  c.vl_honorario WHEN r.nr_tipo_nota=77 THEN  c.vl_custo_oper WHEN r.nr_tipo_nota=85 THEN  c.vl_honorario WHEN r.nr_tipo_nota=87 THEN  c.vl_custo_oper END   ELSE c.vl_total_item END  END   ELSE CASE WHEN c.ie_responsavel_credito=coalesce(cd_regra_hon_som_filme_ipe_w,'0') THEN (coalesce(c.vl_filme,0)+coalesce(c.vl_honorario,0))  ELSE CASE WHEN c.cd_item_convenio ='40812022' THEN  CASE WHEN r.nr_tipo_nota=75 THEN  c.vl_honorario WHEN r.nr_tipo_nota=77 THEN  c.vl_custo_oper WHEN r.nr_tipo_nota=85 THEN  c.vl_honorario WHEN r.nr_tipo_nota=87 THEN  c.vl_custo_oper END  WHEN c.cd_item_convenio ='40812030' THEN  CASE WHEN r.nr_tipo_nota=75 THEN  c.vl_honorario WHEN r.nr_tipo_nota=77 THEN  c.vl_custo_oper WHEN r.nr_tipo_nota=85 THEN  c.vl_honorario WHEN r.nr_tipo_nota=87 THEN  c.vl_custo_oper END  WHEN c.cd_item_convenio ='40812049' THEN  CASE WHEN r.nr_tipo_nota=75 THEN  c.vl_honorario WHEN r.nr_tipo_nota=77 THEN  c.vl_custo_oper WHEN r.nr_tipo_nota=85 THEN  c.vl_honorario WHEN r.nr_tipo_nota=87 THEN  c.vl_custo_oper END  WHEN c.cd_item_convenio ='40812057' THEN  CASE WHEN r.nr_tipo_nota=75 THEN  c.vl_honorario WHEN r.nr_tipo_nota=77 THEN  c.vl_custo_oper WHEN r.nr_tipo_nota=85 THEN  c.vl_honorario WHEN r.nr_tipo_nota=87 THEN  c.vl_custo_oper END  WHEN c.cd_item_convenio ='40812073' THEN  CASE WHEN r.nr_tipo_nota=75 THEN  c.vl_honorario WHEN r.nr_tipo_nota=77 THEN  c.vl_custo_oper WHEN r.nr_tipo_nota=85 THEN  c.vl_honorario WHEN r.nr_tipo_nota=87 THEN  c.vl_custo_oper END  WHEN c.cd_item_convenio ='40812065' THEN  CASE WHEN r.nr_tipo_nota=75 THEN  c.vl_honorario WHEN r.nr_tipo_nota=77 THEN  c.vl_custo_oper WHEN r.nr_tipo_nota=85 THEN  c.vl_honorario WHEN r.nr_tipo_nota=87 THEN  c.vl_custo_oper END   ELSE c.vl_total_item END  END  END ) vl_total_item,
                CASE WHEN a.ie_tipo_atendimento=3 THEN ' '  ELSE CASE WHEN c.cd_item_convenio='8001' THEN ' '  ELSE lpad(trim(both c.cd_brasindice),'13','0') END  END  cd_brasindice,
                c.nr_atendimento,
                CASE WHEN a.ie_tipo_atendimento=3 THEN ' '  ELSE CASE WHEN cd_item_convenio='8001' THEN substr(wheb_mensagem_pck.get_texto(307094),1,255)  ELSE c.ds_item END  END  ds_item,
                c.cd_medico_executor,
                c.cd_medico_exec_conv,
                c.nm_medico_executor,
                c.nr_crm_executor,
                substr(c.uf_crm_executor,1,2) uf_crm_executor,
                c.nr_cpf_executor,
                c.cd_convenio,
                c.cd_cgc_hospital,
                c.cd_cgc_convenio,
                c.cd_interno,
                CASE WHEN c.cd_tipo_item_interf=5 THEN 'MEDIC'  ELSE c.ie_responsavel_credito END  ie_responsavel_credito,
                c.cd_tipo_item_interf,
                coalesce(x.cd_area_procedimento,0) cd_area_procedimento,
                coalesce(c.pr_via_acesso,0) pr_via_acesso,
                coalesce(c.vl_matmed_proc_princ,0) vl_matmed_proc_princ,
                a.nr_seq_conta_convenio,
                max(c.cd_item) cd_item,
                CASE WHEN c.cd_cgc_hospital='92741016000254' THEN                         CASE WHEN x.cd_area_procedimento=9 THEN coalesce(c.cd_cgc_prestador,coalesce(c.nr_cpf_executor,c.cd_cgc_hospital))  ELSE coalesce(c.nr_cpf_executor,coalesce(c.cd_cgc_prestador,c.cd_cgc_hospital)) END   ELSE coalesce(c.nr_cpf_executor,coalesce(c.cd_cgc_prestador,c.cd_cgc_hospital)) END  ie_prestador,
                coalesce(c.cd_cgc_prestador,c.cd_cgc_hospital) cd_cgc_prestador,
                sum(coalesce(c.vl_original,0)) vl_original,
                max(c.vl_unitario_item) vl_unitario_item,
                CASE WHEN ie_utiliza_video_w='S' THEN c.ie_video  ELSE '' END  ie_video,
                sum(coalesce(c.vl_custo_oper,0)) vl_custo_oper,
                CASE WHEN c.cd_item_convenio='2054' THEN 1 WHEN c.cd_item_convenio='2062' THEN 1 WHEN c.cd_item_convenio='2070' THEN 1 WHEN c.cd_item_convenio='2089' THEN 1  ELSE 0 END  ie_ordem_taxa,
		CASE WHEN a.ie_tipo_atendimento=3 THEN ' '  ELSE CASE WHEN c.cd_item_convenio='8001' THEN ' '  ELSE CASE WHEN c.ie_tipo_item=2 THEN 				obter_unidade_medida_ipe(c.nr_seq_item, a.ie_tipo_atendimento, c.ie_tipo_item, c.cd_item, a.cd_cgc_hospital, c.cd_unidade_medida)  ELSE null END  END  END  cd_unidade_medida,
		CASE WHEN ie_ordem_val_item_ipe_w='S' THEN  SUM(c.vl_honorario)  ELSE 0 END  ie_ordena_vl_honorario,
                CASE WHEN ie_ordem_val_item_ipe_w='S' THEN  SUM(c.vl_total_item)  ELSE 0 END  ie_ordena_vl_total_item,
                CASE WHEN c.cd_item_convenio='93481837' THEN  0 WHEN c.cd_item_convenio='248' THEN  1  ELSE 2 END  ie_ordem_stent_ipe
        FROM w_interf_conta_item_nota r, w_interf_conta_cab a, w_interf_conta_item c
LEFT OUTER JOIN estrutura_procedimento_v x ON (c.cd_item = x.cd_procedimento AND c.ie_origem_proced = x.ie_origem_proced)
LEFT OUTER JOIN material y ON (c.cd_item = y.cd_material)
WHERE a.nr_interno_conta              = c.nr_interno_conta and a.nr_interno_conta              = nr_interno_conta_p    and (((c.cd_cgc_hospital            = '87317764001084') and (coalesce(c.ie_responsavel_credito,'X') <> 'Z')) or (c.cd_cgc_hospital              <> '87317764001084')) and (((c.cd_cgc_hospital            = '92815000000168') and
                (((r.nr_tipo_nota in (75,85)) and (c.cd_funcao_executor not in (41,42,43))) or (r.nr_tipo_nota not in (75,85)))) or (c.cd_cgc_hospital              <> '92815000000168')) and c.nr_seq_item					= r.nr_seq_item and a.nr_interno_conta				= r.nr_interno_conta and c.ie_tipo_item 					= r.ie_tipo_item and ((c.cd_cgc_hospital            = '87317764001084' AND c.ie_responsavel_credito <> 'MMOPM') or (c.cd_cgc_hospital  <> '87317764001084')) group by
                a.nr_seq_protocolo,
                CASE WHEN c.cd_cgc_hospital='92741016000254' THEN 					CASE WHEN a.ie_tipo_atendimento=1 THEN 						CASE WHEN x.cd_area_procedimento=3 THEN 							CASE WHEN x.cd_especialidade=25000004 THEN r.nr_tipo_nota  ELSE CASE WHEN coalesce(c.cd_medico_executor,'X')='X' THEN r.nr_tipo_nota  ELSE 75 END  END   ELSE r.nr_tipo_nota END  WHEN a.ie_tipo_atendimento=8 THEN 					CASE WHEN x.cd_area_procedimento=3 THEN 						CASE WHEN coalesce(c.cd_medico_executor,'X')='X' THEN r.nr_tipo_nota  ELSE 85 END   ELSE r.nr_tipo_nota END   ELSE r.nr_tipo_nota END   ELSE r.nr_tipo_nota END ,--4
                somente_numero(coalesce(c.nr_cpf_executor,coalesce(c.cd_cgc_prestador,c.cd_cgc_hospital))),
                c.nr_interno_conta,
                coalesce(c.nr_cpf_executor,coalesce(c.cd_cgc_prestador,c.cd_cgc_hospital)),
                CASE WHEN c.cd_cgc_hospital='87768735000148' THEN  coalesce(c.nr_seq_proc_princ, ipe_obter_min_seq_item(c.nr_interno_conta, c.cd_item_convenio)) WHEN c.cd_cgc_hospital='95422358000119' THEN  coalesce(c.nr_seq_proc_princ, ipe_obter_min_seq_item(c.nr_interno_conta, c.cd_item_convenio))  ELSE CASE WHEN c.cd_item_convenio='16000005' THEN  99  ELSE CASE WHEN c.cd_item_convenio='8001' THEN 5  ELSE obter_classif_matproc_ipe(y.cd_material, x.cd_procedimento, x.ie_origem_proced, a.ie_tipo_atendimento, c.cd_medico_executor) END  END  END ,
                CASE WHEN a.ie_tipo_atendimento=1 THEN                         CASE WHEN  CASE WHEN c.cd_cgc_hospital='92741016000254' THEN                                         CASE WHEN a.ie_tipo_atendimento=1 THEN                                                 CASE WHEN x.cd_area_procedimento=3 THEN                                                         CASE WHEN x.cd_especialidade=25000004 THEN r.nr_tipo_nota  ELSE CASE WHEN coalesce(c.cd_medico_executor,'X')='X' THEN r.nr_tipo_nota  ELSE 75 END  END   ELSE r.nr_tipo_nota END   ELSE r.nr_tipo_nota END   ELSE r.nr_tipo_nota END =75 THEN c.dt_item WHEN  CASE WHEN c.cd_cgc_hospital='92741016000254' THEN                                         CASE WHEN a.ie_tipo_atendimento=1 THEN                                                 CASE WHEN x.cd_area_procedimento=3 THEN                                                         CASE WHEN x.cd_especialidade=25000004 THEN r.nr_tipo_nota  ELSE CASE WHEN coalesce(c.cd_medico_executor,'X')='X' THEN r.nr_tipo_nota  ELSE 75 END  END   ELSE r.nr_tipo_nota END   ELSE r.nr_tipo_nota END   ELSE r.nr_tipo_nota END =76 THEN CASE WHEN c.cd_cgc_hospital='92815000000168' THEN  CASE WHEN c.cd_item_convenio='2054' THEN  trunc(a.dt_periodo_inicial) WHEN c.cd_item_convenio='2062' THEN  trunc(a.dt_periodo_inicial) WHEN c.cd_item_convenio='2070' THEN  trunc(a.dt_periodo_inicial) WHEN c.cd_item_convenio='2089' THEN  trunc(a.dt_periodo_inicial)  ELSE trunc(c.dt_item) END  WHEN c.cd_cgc_hospital='92741016000254' THEN  CASE WHEN c.cd_item_convenio='2054' THEN  trunc(a.dt_periodo_inicial) WHEN c.cd_item_convenio='2062' THEN  trunc(a.dt_periodo_inicial) WHEN c.cd_item_convenio='2070' THEN  trunc(a.dt_periodo_inicial) WHEN c.cd_item_convenio='2089' THEN  trunc(a.dt_periodo_inicial)  ELSE trunc(c.dt_item) END   ELSE CASE WHEN c.cd_item_convenio='93481837' THEN  c.dt_item WHEN c.cd_item_convenio='248' THEN  c.dt_item  ELSE trunc(c.dt_item) END  END  WHEN  CASE WHEN c.cd_cgc_hospital='92741016000254' THEN                                         CASE WHEN a.ie_tipo_atendimento=1 THEN                                                 CASE WHEN x.cd_area_procedimento=3 THEN                                                         CASE WHEN x.cd_especialidade=25000004 THEN r.nr_tipo_nota  ELSE CASE WHEN coalesce(c.cd_medico_executor,'X')='X' THEN r.nr_tipo_nota  ELSE 75 END  END   ELSE r.nr_tipo_nota END   ELSE r.nr_tipo_nota END   ELSE r.nr_tipo_nota END =86 THEN CASE WHEN c.cd_cgc_hospital='92815000000168' THEN 									CASE WHEN c.cd_item_convenio='2054' THEN  trunc(a.dt_periodo_inicial) WHEN c.cd_item_convenio='2062' THEN  trunc(a.dt_periodo_inicial) WHEN c.cd_item_convenio='2070' THEN  trunc(a.dt_periodo_inicial) WHEN c.cd_item_convenio='2089' THEN  trunc(a.dt_periodo_inicial)  ELSE trunc(c.dt_item) END   ELSE trunc(c.dt_item) END  WHEN  CASE WHEN c.cd_cgc_hospital='92741016000254' THEN                                         CASE WHEN a.ie_tipo_atendimento=1 THEN                                                 CASE WHEN x.cd_area_procedimento=3 THEN                                                         CASE WHEN x.cd_especialidade=25000004 THEN r.nr_tipo_nota  ELSE CASE WHEN coalesce(c.cd_medico_executor,'X')='X' THEN r.nr_tipo_nota  ELSE 75 END  END   ELSE r.nr_tipo_nota END   ELSE r.nr_tipo_nota END   ELSE r.nr_tipo_nota END =85 THEN c.dt_item WHEN  CASE WHEN c.cd_cgc_hospital='92741016000254' THEN                                         CASE WHEN a.ie_tipo_atendimento=1 THEN                                                 CASE WHEN x.cd_area_procedimento=3 THEN                                                         CASE WHEN x.cd_especialidade=25000004 THEN r.nr_tipo_nota  ELSE CASE WHEN coalesce(c.cd_medico_executor,'X')='X' THEN r.nr_tipo_nota  ELSE 75 END  END   ELSE r.nr_tipo_nota END   ELSE r.nr_tipo_nota END   ELSE r.nr_tipo_nota END =77 THEN 	CASE WHEN c.cd_item_convenio='40812022' THEN  c.dt_item WHEN c.cd_item_convenio='40812030' THEN  c.dt_item WHEN c.cd_item_convenio='40812049' THEN  c.dt_item WHEN c.cd_item_convenio='40812057' THEN  c.dt_item WHEN c.cd_item_convenio='40812073' THEN  c.dt_item WHEN c.cd_item_convenio='40812065' THEN  c.dt_item  ELSE CASE WHEN ie_agrup_data_serv_ipe_w='N' THEN  c.dt_item  ELSE trunc(c.dt_item) END  END  WHEN  CASE WHEN c.cd_cgc_hospital='92741016000254' THEN                                         CASE WHEN a.ie_tipo_atendimento=1 THEN                                                 CASE WHEN x.cd_area_procedimento=3 THEN                                                         CASE WHEN x.cd_especialidade=25000004 THEN r.nr_tipo_nota  ELSE CASE WHEN coalesce(c.cd_medico_executor,'X')='X' THEN r.nr_tipo_nota  ELSE 75 END  END   ELSE r.nr_tipo_nota END   ELSE r.nr_tipo_nota END   ELSE r.nr_tipo_nota END =87 THEN 	CASE WHEN c.cd_item_convenio='40812022' THEN  c.dt_item WHEN c.cd_item_convenio='40812030' THEN  c.dt_item WHEN c.cd_item_convenio='40812049' THEN  c.dt_item WHEN c.cd_item_convenio='40812057' THEN  c.dt_item WHEN c.cd_item_convenio='40812073' THEN  c.dt_item WHEN c.cd_item_convenio='40812065' THEN  c.dt_item  ELSE trunc(c.dt_item) END   ELSE CASE WHEN c.cd_item_convenio='8001' THEN a.dt_alta  ELSE CASE WHEN c.ie_tipo_item=1 THEN 													CASE WHEN c.cd_tipo_item_interf=2 THEN CASE WHEN c.cd_cgc_hospital='87317764001084' THEN c.dt_item  ELSE trunc(c.dt_item) END  WHEN c.cd_tipo_item_interf=6 THEN trunc(c.dt_item) WHEN c.cd_tipo_item_interf=3 THEN CASE WHEN c.cd_cgc_hospital='87317764001084' THEN c.dt_item  ELSE trunc(c.dt_item) END   ELSE trunc(a.dt_entrada) END   ELSE trunc(c.dt_item) END  END  END  WHEN a.ie_tipo_atendimento=8 THEN CASE WHEN ie_agrupa_data_ipe_w='S' THEN  c.dt_item  ELSE trunc(c.dt_item) END   ELSE trunc(a.dt_entrada) END ,
                somente_numero(CASE WHEN a.ie_tipo_atendimento=3 THEN                         CASE WHEN c.ie_tipo_item=1 THEN c.cd_item_convenio WHEN c.ie_tipo_item=2 THEN CASE WHEN c.cd_tipo_item_interf=5 THEN '98007530' WHEN c.cd_tipo_item_interf=4 THEN '98007963'  ELSE '98007963' END   ELSE c.cd_item_convenio END   ELSE c.cd_item_convenio END ),
                obter_seq_partic_proc_func(c.nr_seq_item, c.cd_funcao_executor),
                coalesce(c.cd_funcao_executor,0),
                c.ie_via_acesso_inf,
                CASE WHEN coalesce(c.pr_hora_extra,0)=0 THEN 0 WHEN coalesce(c.pr_hora_extra,0)=1 THEN 0  ELSE 11 END ,
                CASE WHEN a.ie_tipo_atendimento=3 THEN ' '  ELSE CASE WHEN c.cd_item_convenio='8001' THEN ' '  ELSE lpad(trim(both c.cd_brasindice),'13','0') END  END ,
                c.nr_atendimento,
                CASE WHEN a.ie_tipo_atendimento=3 THEN ' '  ELSE CASE WHEN cd_item_convenio='8001' THEN substr(wheb_mensagem_pck.get_texto(307094),1,255)  ELSE c.ds_item END  END ,
                c.cd_medico_executor,
                c.cd_medico_exec_conv,
                c.nm_medico_executor,
                c.nr_crm_executor,
                c.uf_crm_executor,
                c.nr_cpf_executor,
                c.cd_convenio,
                c.cd_cgc_hospital,
                c.cd_cgc_convenio,
                c.cd_interno,
                CASE WHEN c.cd_tipo_item_interf=5 THEN 'MEDIC'  ELSE c.ie_responsavel_credito END ,
                c.ie_tipo_item,
                c.cd_tipo_item_interf,
                coalesce(x.cd_area_procedimento,0),
                coalesce(c.pr_via_acesso,0),
                coalesce(c.vl_matmed_proc_princ,0),
                CASE WHEN c.cd_cgc_hospital='92741016000254' THEN                 CASE WHEN x.cd_area_procedimento=9 THEN coalesce(c.cd_cgc_prestador,coalesce(c.nr_cpf_executor,c.cd_cgc_hospital))  ELSE coalesce(c.nr_cpf_executor,coalesce(c.cd_cgc_prestador,c.cd_cgc_hospital)) END   ELSE coalesce(c.nr_cpf_executor,coalesce(c.cd_cgc_prestador,c.cd_cgc_hospital)) END ,
                coalesce(c.cd_cgc_prestador,c.cd_cgc_hospital),
                a.nr_seq_conta_convenio,
                CASE WHEN ie_utiliza_video_w='S' THEN c.ie_video  ELSE '' END ,
                CASE WHEN c.cd_cgc_hospital='87317764001084' THEN CASE WHEN c.ie_tipo_item=1 THEN CASE WHEN r.nr_tipo_nota=76 THEN c.nr_seq_item WHEN r.nr_tipo_nota=77 THEN c.nr_seq_item WHEN r.nr_tipo_nota=87 THEN  c.nr_seq_item  ELSE '' END   ELSE '' END  WHEN c.cd_cgc_hospital='92815000000168' THEN CASE WHEN c.ie_tipo_item=1 THEN CASE WHEN r.nr_tipo_nota=75 THEN c.cd_funcao_espec_med  ELSE '' END   ELSE '' END   ELSE '' END ,
                CASE WHEN c.cd_item_convenio='2054' THEN 1 WHEN c.cd_item_convenio='2062' THEN 1 WHEN c.cd_item_convenio='2070' THEN 1 WHEN c.cd_item_convenio='2089' THEN 1  ELSE 0 END ,
                CASE WHEN a.ie_tipo_atendimento=3 THEN ' '  ELSE CASE WHEN c.cd_item_convenio='8001' THEN ' '  ELSE CASE WHEN c.ie_tipo_item=2 THEN 				obter_unidade_medida_ipe(c.nr_seq_item, a.ie_tipo_atendimento, c.ie_tipo_item, c.cd_item, a.cd_cgc_hospital, c.cd_unidade_medida)  ELSE null END  END  END ,
				CASE WHEN c.cd_cgc_hospital='87768735000148' THEN  1  ELSE CASE WHEN c.cd_item_convenio='40812022' THEN  c.nr_seq_item WHEN c.cd_item_convenio='40812030' THEN  c.nr_seq_item WHEN c.cd_item_convenio='40812049' THEN  c.nr_seq_item WHEN c.cd_item_convenio='40812057' THEN  c.nr_seq_item WHEN c.cd_item_convenio='40812073' THEN  c.nr_seq_item WHEN c.cd_item_convenio='40812065' THEN  c.nr_seq_item  ELSE ipe_obter_min_seq_item(c.nr_interno_conta, c.cd_item_convenio) END  END ,
                CASE WHEN c.cd_item_convenio='93481837' THEN  0 WHEN c.cd_item_convenio='248' THEN  1  ELSE 2 END 
        having  (((sum(c.qt_item) > 0) and (ie_consid_item_neg_ipe_int_w = 'N')) or ((sum(c.qt_item) <> 0)and (ie_consid_item_neg_ipe_int_w = 'S')) and
                ((c.ie_tipo_item = 1) or (((coalesce(ie_exc_matmed_vlzero_ipe_int_w,'N') = 'S') and (sum(c.vl_total_item) > 0 )) or (coalesce(ie_exc_matmed_vlzero_ipe_int_w,'N') = 'N'))))
        order by nr_interno_conta, tp_nota, ie_ordem_taxa, dt_item, ie_ordem_stent_ipe, ie_tipo_item, 
                        ie_ordena_vl_honorario desc, 
                        ie_ordena_vl_total_item desc,
                        CASE WHEN c.cd_cgc_hospital='87768735000148' THEN  coalesce(c.nr_seq_proc_princ, ipe_obter_min_seq_item(c.nr_interno_conta, c.cd_item_convenio)) WHEN c.cd_cgc_hospital='95422358000119' THEN  coalesce(c.nr_seq_proc_princ, ipe_obter_min_seq_item(c.nr_interno_conta, c.cd_item_convenio))  ELSE CASE WHEN c.cd_item_convenio='16000005' THEN  99  ELSE CASE WHEN c.cd_item_convenio='8001' THEN 5  ELSE obter_classif_matproc_ipe(y.cd_material, x.cd_procedimento, x.ie_origem_proced, a.ie_tipo_atendimento, c.cd_medico_executor) END  END  END 
                ,3,11,12,10;

type            fetch_array is table of c01%rowtype;
s_array         fetch_array;
i               integer := 1;
type vetor is table of fetch_array index by integer;
vetor_c01_w                     vetor;

c02 CURSOR FOR
        SELECT  a.nr_seq_proc_princ,
                sum(a.vl_total_item) vl_matmed_proc_princ,
                sum(vl_unitario_item * a.qt_item) vl_unit_matmed_princ
        from    w_interf_conta_item a
        where   a.nr_interno_conta      = nr_interno_conta_p
        and     a.nr_seq_protocolo      = nr_seq_protocolo_p
        and     (a.nr_seq_proc_princ IS NOT NULL AND a.nr_seq_proc_princ::text <> '')
        and     a.nr_seq_proc_princ > 0
        and     a.ie_tipo_item <> 1
        and     ipe_obter_se_agrup_mat(cd_estabelecimento_w,a.nr_seq_item) = 'S'
        group by        a.nr_seq_proc_princ;

type            fetch_array2 is table of c02%rowtype;
s_array2        fetch_array2;
k               integer := 1;
type vetor2 is table of fetch_array2 index by integer;
vetor_c02_w                     vetor2;

c03 CURSOR FOR
        SELECT  a.nr_interno_conta,--1
                a.nr_sequencia,--2
                a.cd_item_convenio,--3
                a.cd_item,--4
                a.cd_funcao_executor,--5
                b.ie_medico,--6
                b.ie_auxiliar,--7
                CASE WHEN b.ie_auxiliar='S' THEN 0  ELSE 1 END  nr_indaux,--8
                a.nr_seq_item,--9
                a.cd_medico_executor,--10
                obter_seq_partic_proc_func(a.nr_seq_item, a.cd_funcao_executor) nr_seq_partic,--11
                a.ie_origem_proced,--12
                CASE WHEN a.cd_cgc_hospital='87317764001084' THEN a.cd_funcao_executor WHEN a.cd_cgc_hospital='92962869002006' THEN a.cd_funcao_executor WHEN a.cd_cgc_hospital='92812049000914' THEN a.cd_funcao_executor  ELSE null END  ie_campo_ordem,--13
                a.cd_cgc_hospital --14
        from    w_interf_conta_cab c,
                funcao_medico b,
                w_interf_conta_item a
        where   a.nr_interno_conta      = nr_interno_conta_p
        and     a.nr_seq_protocolo      = nr_seq_protocolo_p
        and     c.nr_interno_conta      = a.nr_interno_conta
        and     ((obter_tipo_nota_ipe(c.ie_tipo_atendimento,a.ie_tipo_item,a.cd_item,a.cd_cgc_hospital, a.ie_origem_proced, c.nr_interno_conta) in (75,85)) or
                ((a.cd_cgc_hospital = '92741016000254') and (obter_dados_estrut_proc(a.cd_item, a.ie_origem_proced,'C','A'))::numeric  = 3))
        and     (a.cd_funcao_executor IS NOT NULL AND a.cd_funcao_executor::text <> '')
        and     a.cd_funcao_executor = b.cd_funcao
        and     b.ie_medico             = 'S'
        and     b.ie_anestesista        = 'N'
        order by 1,3,9,8,13,11,2;

type            fetch_array3 is table of c03%rowtype;
s_array3        fetch_array3;
j               integer := 1;
type vetor3 is table of fetch_array3 index by integer;
vetor_c03_w                     vetor3;
BEGIN

select  max(cd_estabelecimento),
	max(cd_convenio)
into STRICT    cd_estabelecimento_w,
	cd_conv_protocolo_w
from    protocolo_convenio
where   nr_seq_protocolo = nr_seq_protocolo_p;

begin
select	cd_regra_hon_som_filme_ipe
into STRICT	cd_regra_hon_som_filme_ipe_w
from	convenio_estabelecimento
where	cd_convenio = cd_conv_protocolo_w
and	cd_estabelecimento = cd_estabelecimento_w;
exception
when others then
	cd_regra_hon_som_filme_ipe_w	:= null;
end;


select  coalesce(max(ie_regra_auxiliar_ipe), 'I'),
        coalesce(max(ie_agrupa_data_ipe), 'N'),
        coalesce(max(ie_medic_aux_princ_ipe),'N'),
        coalesce(max(ie_utiliza_video_ipe_internado),'N'),
        coalesce(max(ie_gera_vl_mat_zero_ipe_int),'N'),
        coalesce(max(ie_consid_item_neg_ipe_int),'N'),
        coalesce(max(ie_exc_matmed_vlzero_ipe_int),'N'),
        coalesce(max(ie_agrup_data_serv_ipe),'S'),
        coalesce(max(ie_ordem_val_item_ipe),'N')
into STRICT    ie_regra_auxiliar_ipe_w,
        ie_agrupa_data_ipe_w,  /*                   'S'  -> Nao Agrupa a data             |        'N'  ->  Agrupa a data       OS 107870  29/09/2008 Fabricio  */
        ie_medic_aux_princ_ipe_w,
        ie_utiliza_video_w,
        ie_gera_matmed_fora_conta_w,
        ie_consid_item_neg_ipe_int_w,
        ie_exc_matmed_vlzero_ipe_int_w,
	ie_agrup_data_serv_ipe_w,
        ie_ordem_val_item_ipe_w
from    parametro_faturamento
where   cd_estabelecimento      = cd_estabelecimento_w;

/* Acertar funcao dos participantes */

qt_auxiliares_w         := 0;
nr_interno_conta_ant_w  := 0;
nr_seq_item_ant_w       := 0;
cd_item_convenio_ant_w  := 0;
cd_medico_exec_ant_w    := '';

open c03;
loop
fetch c03 bulk collect into s_array3 limit 100000;
        vetor_c03_w(j) := s_array3;
        j := j + 1;
EXIT WHEN NOT FOUND; /* apply on c03 */
end loop;
close c03;

for i in 1..vetor_c03_w.count loop
        begin
        s_array3 := vetor_c03_w(i);
        for z in 1..s_array3.count loop
                begin

                nr_interno_conta_w      := s_array3[z].nr_interno_conta;
                nr_sequencia_w          := s_array3[z].nr_sequencia;
                cd_item_convenio_w      := s_array3[z].cd_item_convenio;
                cd_item_w               := s_array3[z].cd_item;
                cd_funcao_executor_w    := s_array3[z].cd_funcao_executor;
                ie_medico_w             := s_array3[z].ie_medico;
                ie_auxiliar_w           := s_array3[z].ie_auxiliar;
                nr_indaux_w             := s_array3[z].nr_indaux;
                nr_seq_item_w           := s_array3[z].nr_seq_item;
                cd_medico_executor_w    := s_array3[z].cd_medico_executor;
                nr_seq_partic_w         := s_array3[z].nr_seq_partic;
                ie_origem_proced_w      := s_array3[z].ie_origem_proced;
                ie_campo_ordem_w        := s_array3[z].ie_campo_ordem;
                cd_cgc_hospital_w       := s_array3[z].cd_cgc_hospital;


                if (ie_regra_auxiliar_ipe_w = 'I') then

                        select  max(cd_medico_executor)
                        into STRICT    cd_medico_exec_proc_w
                        from    procedimento_paciente
                        where   nr_sequencia    = nr_seq_item_w;


                        if (nr_interno_conta_w <> nr_interno_conta_ant_w or
                                cd_item_convenio_w <> cd_item_convenio_ant_w) or
                                (cd_medico_executor_w <> cd_medico_exec_ant_w AND cd_medico_executor_w = cd_medico_exec_proc_w) or (nr_seq_item_w <> nr_seq_item_ant_w) then
                                begin
                                nr_interno_conta_ant_w  := nr_interno_conta_w;
                                cd_item_convenio_ant_w  := cd_item_convenio_w;
                                cd_medico_exec_ant_w    := cd_medico_executor_w;
                                if (cd_medico_executor_w = cd_medico_exec_proc_w) and (nr_seq_item_w <> nr_seq_item_ant_w) then
                                        qt_auxiliares_w         := 0;
                                elsif (cd_medico_executor_w <> cd_medico_exec_proc_w) then
                                        qt_auxiliares_w         := 0;
                                end if;
                                nr_seq_item_ant_w       := nr_seq_item_w;

                                end;
                        end if;

                else

                        if (nr_interno_conta_w <> nr_interno_conta_ant_w or
                                cd_item_convenio_w <> cd_item_convenio_ant_w) then
                                begin
                                nr_interno_conta_ant_w  := nr_interno_conta_w;
                                cd_item_convenio_ant_w  := cd_item_convenio_w;
                                cd_medico_exec_ant_w    := cd_medico_executor_w;
                                nr_seq_item_ant_w       := nr_seq_item_w;
                                qt_auxiliares_w         := 0;

                                end;
                        end if;

                        select  max(cd_medico_executor)
                        into STRICT    cd_medico_exec_proc_w
                        from    procedimento_paciente
                        where   nr_sequencia    = nr_seq_item_w;

                end if;


                if ((ie_auxiliar_w = 'S')and (coalesce(nr_seq_partic_w,0) <> 0)) then -- OS 243287
                        qt_auxiliares_w := qt_auxiliares_w + 1;
                end if;

                if (qt_auxiliares_w        = 1)    and (ie_auxiliar_w  = 'S') then
                        begin
                        update w_interf_conta_item
                        set      cd_funcao_executor     = 41
                        where    nr_sequencia           = nr_sequencia_w
                        and      ((ie_medic_aux_princ_ipe_w = 'S') or
                                 ((ie_medic_aux_princ_ipe_w = 'N') and ((cd_medico_executor <> cd_medico_exec_proc_w) or (pr_funcao_participante = 1))));
                        exception
                                when others then
                                qt_auxiliares_w := qt_auxiliares_w;
                        end;
                end if;

                if (qt_auxiliares_w        = 2) and (ie_auxiliar_w  = 'S') then
                        begin
                        update w_interf_conta_item
                        set      cd_funcao_executor = 42
                        where    nr_sequencia   = nr_sequencia_w
                        and      ((ie_medic_aux_princ_ipe_w = 'S') or
                                 ((ie_medic_aux_princ_ipe_w = 'N') and ((cd_medico_executor <> cd_medico_exec_proc_w) or (pr_funcao_participante = 1))));
                        exception
                                when others then
                                qt_auxiliares_w := qt_auxiliares_w;
                        end;
                end if;

                if (qt_auxiliares_w        = 3) and (ie_auxiliar_w  = 'S') then
                        begin
                        update w_interf_conta_item
                        set      cd_funcao_executor = 43
                        where    nr_sequencia   = nr_sequencia_w
                        and      ((ie_medic_aux_princ_ipe_w = 'S') or
                                 ((ie_medic_aux_princ_ipe_w = 'N') and ((cd_medico_executor <> cd_medico_exec_proc_w) or (pr_funcao_participante = 1))));
                        exception
                                when others then
                                qt_auxiliares_w := qt_auxiliares_w;
                        end;
                end if;

                if (ie_medico_w    = 'S') and (ie_auxiliar_w  = 'N') then
                        begin
                        /* comando antigo Adelson 14-03-2006 */

                        /* liberado novamente o comando a seguir para consultas proc=20010 OS35081 */

                        /* incluido no comando teste somente para proc=20010 OS35081 (30-05-2006) */

                        select  coalesce(max(ie_forma_apresentacao), 0)
                        into STRICT    ie_forma_apresent_w
                        from    procedimento
                        where   cd_procedimento         = cd_item_convenio_w
                        and     ie_origem_proced        = ie_origem_proced_w;

                        begin
                        update  w_interf_conta_item
                        set     cd_funcao_executor      = qt_auxiliares_w
                        where   nr_sequencia            = nr_sequencia_w
                        and     ((cd_item_convenio_w    in (20010,10102019)) or (ie_forma_apresent_w in (5,6,7)));
                        exception
                                when others then
                                qt_auxiliares_w := qt_auxiliares_w;
                        end;

                        select  count(*)
                        into STRICT    qt_aux_item_w
                        from    procedimento_participante
                        where   nr_sequencia            = nr_seq_item_w;

                        /* OS29829 Banco de Olhos qdo medicos auxiliares e o mesmo do cirurgiao, gerar um registro com qtd  auxiliares e valor total */

                        /* Adelson 14-03-2006 */

                        /* incluido no comando teste somente para proc <> 20010 OS35081 (30-05-2006) */

                        if (cd_cgc_hospital_w <> '89428718000197') and (cd_cgc_hospital_w <> '92741016000254') and (cd_cgc_hospital_w <> '88633227000115')then
                                begin
                                begin

                                if (cd_cgc_hospital_w = '92815000000168') or (cd_cgc_hospital_w = '87701249000374') then
                                        begin
                                        update  w_interf_conta_item
                                        set     cd_funcao_executor      = qt_aux_item_w,
                                                qt_item                 = 0
                                        where   nr_interno_conta        = nr_interno_conta_w
                                        and     ((ie_medic_aux_princ_ipe_w = 'S' AND nr_sequencia = nr_sequencia_w) or
                                                (ie_medic_aux_princ_ipe_w = 'N' AND nr_seq_item = nr_seq_item_w))
                                        and     coalesce(cd_medico_executor,0) = coalesce(cd_medico_executor_w,0)
                                        and     cd_item_convenio_w      not in (20010,10102019)
                                        and     not ie_forma_apresent_w in (5,6,7);

                                        end;
                                else
                                        begin
                                        update  w_interf_conta_item
                                        set     cd_funcao_executor      = qt_auxiliares_w,
                                                qt_item                 = 0
                                        where   nr_interno_conta        = nr_interno_conta_w
                                        and     ((ie_medic_aux_princ_ipe_w = 'S' AND nr_sequencia = nr_sequencia_w) or
                                                (ie_medic_aux_princ_ipe_w = 'N' AND nr_seq_item = nr_seq_item_w))
                                        and     coalesce(cd_medico_executor,0) = coalesce(cd_medico_executor_w,0)
                                        and     cd_item_convenio_w      not in (20010,10102019)
                                        and     not ie_forma_apresent_w in (5,6,7);
                                        end;
                                end if;

                                select  max(cd_funcao_executor)
                                into STRICT    cd_funcao_exec_item_w
                                from    w_interf_conta_item
                                where   nr_sequencia            = nr_sequencia_w;

                                exception
                                        when others then
                                        qt_auxiliares_w := qt_auxiliares_w;
                                end;

                                end;
                        else
                                begin

                                begin
                                update  w_interf_conta_item
                                set     cd_funcao_executor      = qt_auxiliares_w
                                        --qt_item                       = 0
                                where   nr_interno_conta        = nr_interno_conta_w
                                and     ((ie_medic_aux_princ_ipe_w = 'S' AND nr_sequencia = nr_sequencia_w) or
                                        (ie_medic_aux_princ_ipe_w = 'N' AND nr_seq_item = nr_seq_item_w))
                                and     coalesce(cd_medico_executor,0) = coalesce(cd_medico_executor_w,0)
                                and     cd_item_convenio_w      not in (20010,10102019)
                                and     not ie_forma_apresent_w in (5,6,7);

                                select  max(cd_funcao_executor)
                                into STRICT    cd_funcao_exec_item_w
                                from    w_interf_conta_item
                                where   nr_sequencia            = nr_sequencia_w;

                                exception
                                        when others then
                                        RAISE NOTICE 'exception';
                                        qt_auxiliares_w := qt_auxiliares_w;
                                end;

                                end;
                        end if;

                        qt_auxiliares_w         := 0;
                        nr_interno_conta_ant_w  := 0;
                        nr_seq_item_ant_w       := 0;
                        cd_item_convenio_ant_w  := 0;
                        cd_medico_exec_ant_w    := '';

                        end;
                end if;
                commit;
                /* incluido no comando teste somente para proc <> 20010 OS35081 (30-05-2006) */

                if (ie_medico_w    = 'S') and (ie_auxiliar_w  = 'N') and (cd_cgc_hospital_w <> '89428718000197') and (cd_cgc_hospital_w <> '92741016000254') and (cd_cgc_hospital_w <> '92815000000168') and (cd_cgc_hospital_w <> '88633227000115') then
                        begin
                        update  w_interf_conta_item
                        set      qt_item = 1
                        where    nr_sequencia           = nr_sequencia_w
                        and     cd_item_convenio_w      not in (20010,10102019)
                        and     not ie_forma_apresent_w in (5,6,7);
                        exception
                                when others then
                                qt_auxiliares_w := qt_auxiliares_w;
                        commit;
                        end;
                end if;

                if (ie_medico_w    = 'S') and (ie_auxiliar_w  = 'N') and (cd_funcao_executor_w not in ('3','4','9','10')) and (cd_cgc_hospital_w = '92815000000168') then
                        begin
                        update  w_interf_conta_item
                        set      qt_item = 1
                        where    nr_sequencia           = nr_sequencia_w
                        and     cd_item_convenio_w      not in (20010,10102019)
                        and     not ie_forma_apresent_w in (5,6,7)
                        and     cd_funcao_executor_w not in ('3','4','9','10');
                        exception
                                when others then
                                qt_auxiliares_w := qt_auxiliares_w;
                        commit;
                        end;
                end if;

                end;
        end loop;
        end;
end loop;

/* tratar vlr matmed de exames que devem gerar acumulado no codigo 32200005 logo apos o exame */

/* esta regra vale somente para internados Exames e PA esta sendo tratado no gerar_interf_conta_item */

/* Obter tipo de atendimento da conta */

select  a.ie_tipo_atendimento
into STRICT    ie_tipo_atendimento_w
from    atendimento_paciente a,
        conta_paciente b
where   b.nr_interno_conta      = nr_interno_conta_p
and     b.nr_atendimento        = a.nr_atendimento;

/* incluido o tipo de atendimento 8 no if abaixo  os 78786 hosp. bruno born */

if (ie_tipo_atendimento_w  in (1,8)) then
        begin

        open c02;
        loop
        fetch c02 bulk collect into s_array2 limit 100000;
                vetor_c02_w(k) := s_array2;
                k := k + 1;
        EXIT WHEN NOT FOUND; /* apply on c02 */
        end loop;
        close c02;

        for i in 1..vetor_c02_w.count loop
                begin
                s_array2 := vetor_c02_w(i);
                for z in 1..s_array2.count loop
                        begin

                        nr_seq_proc_princ_w     := s_array2[z].nr_seq_proc_princ;
                        vl_matmed_proc_princ_w  := round((s_array2[z].vl_matmed_proc_princ)::numeric,2);
                        vl_unit_matmed_princ_w  := round((s_array2[z].vl_unit_matmed_princ)::numeric,2);

                        /* obter o procedimento de referencia */

                        select  coalesce(max(cd_item),0),
                                coalesce(max(nr_sequencia),0),
				coalesce(max(ie_origem_proced),1)
                        into STRICT    cd_procedimento_ref_w,
                                nr_seq_proc_ref_w,
				ie_origem_proc_ref_w
                        from    w_interf_conta_item
                        where   nr_interno_conta        = nr_interno_conta_p
                        and     nr_seq_protocolo        = nr_seq_protocolo_p
                        and     nr_seq_item             = nr_seq_proc_princ_w;

                        /* obter area do procedimento de referencia, deve ser 3-diagnose e terapia para AMB e 14 - Capitulo 4 - diagnose para CBHPM */

                        select  coalesce(max(cd_area_procedimento),0)
                        into STRICT    cd_area_proc_ref_w
                        from    estrutura_procedimento_v
                        where   cd_procedimento         = cd_procedimento_ref_w
                        and     ie_origem_proced        = ie_origem_proc_ref_w;

                        if      ((cd_area_proc_ref_w = 3) or (obter_se_proc_agrupa_mat_ipe(cd_procedimento_ref_w,ie_origem_proc_ref_w,cd_estabelecimento_w) = 'S')) then
                                begin

                                if (ie_gera_matmed_fora_conta_w = 'S') and /*Criado para o H. Ernesto Dornelis OS 247300 - Geliard*/
                                        (vl_matmed_proc_princ_w = 0) and (vl_unit_matmed_princ_w > 0) then
                                        begin
                                        update  w_interf_conta_item
                                        set     vl_matmed_proc_princ    = trunc(vl_unit_matmed_princ_w,2)
                                        where   nr_sequencia            = nr_seq_proc_ref_w;
                                        end;
                                else
                                        begin
                                        update  w_interf_conta_item
                                        set     vl_matmed_proc_princ    = vl_matmed_proc_princ_w
                                        where   nr_sequencia            = nr_seq_proc_ref_w;
                                        end;
                                end if;

                                delete  from w_interf_conta_item
                                where   nr_interno_conta        = nr_interno_conta_p
                                and     nr_seq_protocolo        = nr_seq_protocolo_p
                                and     nr_seq_proc_princ       = nr_seq_proc_princ_w
                                and     ie_tipo_item            <> 1
								and     ipe_obter_se_agrup_mat(cd_estabelecimento_w,nr_seq_item) = 'S';

                                end;
                        end if;

                        end;
                end loop;
                end;
        end loop;

        end;
end if;
commit;
/*Geliard - Criado para o Hospital Ernesto Dornelles na OS 240430 gerar uma sequencia de notas por paciente */

begin
select  coalesce(somente_numero(nr_seq_doc_convenio),0) - 1
into STRICT    nr_nota_inicial_w
from    protocolo_convenio
where   nr_seq_protocolo        = nr_seq_protocolo_p;
exception
	when others then
	nr_nota_inicial_w := 0;
	end;

delete FROM w_interf_conta_item_nota where nr_interno_conta = nr_interno_conta_p;

CALL gerar_tipo_nota_ipe(nr_interno_conta_p);

open c01;
loop
fetch c01 bulk collect into s_array limit 100000;
        vetor_c01_w(i) := s_array;
        i := i + 1;
EXIT WHEN NOT FOUND; /* apply on c01 */
end loop;
close c01;

for i in 1..vetor_c01_w.count loop
        begin
        s_array := vetor_c01_w(i);
        for z in 1..s_array.count loop
                begin

                nr_seq_protocolo_w              := s_array[z].nr_seq_protocolo;
                ie_tipo_item_w                  := s_array[z].ie_tipo_item;
                nr_seq_espitem_w                := s_array[z].nr_seq_espitem;
                tp_nota_w                       := s_array[z].tp_nota;
                cd_prestador_w                  := s_array[z].cd_prestador;
                nr_interno_conta_w              := s_array[z].nr_interno_conta;
                dt_item_w                       := s_array[z].dt_item;
                cd_item_convenio_w              := s_array[z].cd_item_convenio;
                qt_item_w                       := s_array[z].qt_item;
                qt_item_conv_div_w              := s_array[z].qt_item_conv_div;
                nr_seq_partic_ww                := s_array[z].nr_seq_partic;
                cd_funcao_executor_w            := s_array[z].cd_funcao_executor;
                ie_via_acesso_w                 := s_array[z].ie_via_acesso_inf;
                ie_urgencia_w                   := s_array[z].ie_urgencia;
                vl_honorario_w                  := s_array[z].vl_honorario;
                vl_total_item_w                 := s_array[z].vl_total_item;
                cd_brasindice_w                 := s_array[z].cd_brasindice;
                nr_atendimento_w                := s_array[z].nr_atendimento;
                ds_item_w                       := s_array[z].ds_item;
                cd_medico_executor_w            := s_array[z].cd_medico_executor;
                cd_medico_exec_conv_w           := s_array[z].cd_medico_exec_conv;
                nm_medico_executor_w            := s_array[z].nm_medico_executor;
                nr_crm_executor_w               := s_array[z].nr_crm_executor;
                uf_crm_executor_w               := s_array[z].uf_crm_executor;
                nr_cpf_executor_w               := s_array[z].nr_cpf_executor;
                cd_convenio_w                   := s_array[z].cd_convenio;
                cd_cgc_hospital_w               := s_array[z].cd_cgc_hospital;
                cd_cgc_convenio_w               := s_array[z].cd_cgc_convenio;
                cd_interno_w                    := s_array[z].cd_interno;
                ie_responsavel_credito_w        := s_array[z].ie_responsavel_credito;
                cd_tipo_item_interf_w           := s_array[z].cd_tipo_item_interf;
                cd_area_procedimento_w          := s_array[z].cd_area_procedimento;
                pr_via_acesso_w                 := s_array[z].pr_via_acesso;
                vl_matmed_proc_princ_w          := s_array[z].vl_matmed_proc_princ;
                nr_seq_conta_convenio_w         := s_array[z].nr_seq_conta_convenio;
                cd_item_w                       := s_array[z].cd_item;
                ie_prestador_w                  := s_array[z].ie_prestador;
                cd_cgc_prestador_w              := s_array[z].cd_cgc_prestador;
                vl_original_w                   := s_array[z].vl_original;
                vl_unitario_item_w              := s_array[z].vl_unitario_item;
                ie_video_w                      := s_array[z].ie_video;
                vl_custo_oper_w                 := s_array[z].vl_custo_oper;
                ie_ordem_taxa_w                 := s_array[z].ie_ordem_taxa;
                cd_unidade_medida_w             := s_array[z].cd_unidade_medida;


              RAISE NOTICE 'nr_interno_conta_w:%,cd_item_convenio_w:%', nr_interno_conta_w, cd_item_convenio_w;
              RAISE NOTICE 'cd_medico_executor_w:% cd_medico_exec_conv_w:% nm_medico_executor_w:% nr_crm_executor_w:% uf_crm_executor_w:% nr_cpf_executor_w:%', cd_medico_executor_w, cd_medico_exec_conv_w, nm_medico_executor_w, nr_crm_executor_w, uf_crm_executor_w, nr_cpf_executor_w;

                if (tp_nota_ant_w <> tp_nota_w) then
                        begin
                        tp_nota_ant_w   := tp_nota_w;
                        nr_folha_w      := 0;
                        if (tp_nota_w = 77) then
                                nr_linha_w      := 23;
                        elsif (tp_nota_w <> 75 and tp_nota_w <> 85) then  /* Inclui esse tratamento para o tipo de nota <> 75, antes era apenas "else"  OS 110119 Fabricio em  29/09/2008 */
                                nr_linha_w      := 25;
                        end if;
                        end;
                end if;

                if (length(cd_item_w) > 8) then
                        CALL wheb_mensagem_pck.exibir_mensagem_abort(186935,'cd_item='|| cd_item_w ||
                                                                        ';ds_item='|| ds_item_w ||
                                                                        ';nr_atendimento='|| nr_atendimento_w ||
                                                                        ';nr_interno_conta='|| nr_interno_conta_w);
                        /* O procedimento #@cd_item#@ - #@ds_item#@ Possui o codigo maior que o previsto pelo Layout IPE (8 caracteres).
                        Atend:  #@nr_atendimento#@ Conta: #@nr_interno_conta#@ */
                end if;

                nr_linha_w      := nr_linha_w + 1;

                if (tp_nota_w      in (77,87)) then
                        begin
                        if (nr_linha_w     > 23) then
                                begin
                                nr_folha_w      := nr_folha_w + 1;
                                nr_linha_w      := 1;
                                end;
                        end if;
                        end;
                elsif (tp_nota_w  <> 75 and tp_nota_w <> 85) then    /* Inclui esse tratamento para o tipo de nota <> 75, antes era apenas "else"  OS 110119 Fabricio em  29/09/2008 */
                        begin
                        if (nr_linha_w     > 25) then
                                begin
                                nr_folha_w      := nr_folha_w + 1;
                                nr_linha_w      := 1;
                                end;
                        end if;
                        end;
                end if;
                /*Geliard - Criado para o Hospital Ernesto Dornelles na OS 240430 gerar uma sequencia de notas por paciente */

                if (nr_nota_inicial_w > 0) and (cd_cgc_hospital_w = '92741016000254') then
                        begin
                        if (nr_interno_conta_w <> nr_conta_ant_w) then
                                begin
                                nr_conta_ant_w          := nr_interno_conta_w;

                                nr_nota_inicial_w       := nr_nota_inicial_w + 1;

                                nr_seq_conta_convenio_w := nr_nota_inicial_w;

                                update  conta_paciente
                                set     nr_conta_convenio       = nr_nota_inicial_w,
                                        dt_atual_conta_conv     = clock_timestamp(),
                                        dt_atualizacao          = clock_timestamp(),
                                        nm_usuario              = wheb_usuario_pck.get_nm_usuario
                                where   nr_interno_conta        = nr_interno_conta_w;
                                end;
                        end if;
                        end;
                end if;
                /* Criar sequence */

                select  nextval('w_interf_conta_item_ipe_seq')
                into STRICT    nr_sequencia_w
;

                /* Define via de acesso */

                if (ie_via_acesso_w        = 'U') then
                        ie_via_acesso_ipe_w     := 00;
                elsif (ie_via_acesso_w          = 'M') then
                        ie_via_acesso_ipe_w     := 31;
                elsif (ie_via_acesso_w          = 'D') then
                        ie_via_acesso_ipe_w     := 32;
                elsif (ie_via_acesso_w          = 'B') then
                        ie_via_acesso_ipe_w     := 33;
                elsif (ie_via_acesso_w          = 'V') then /*OS124140, criado a via de acesso V - Bilateral mesma via Apenas para o Hospital Caridade de Erechim */
                        ie_via_acesso_ipe_w     := 34;
                elsif (ie_via_acesso_w        = 'C') then /*OS 114302, criado a via de Acesso C - Mesma via de acesso, equipes diferentes. Apenas para o Hospital Divida Providencia POA*/
                /*adicionado tambem para o Hospital Ernesto Dornelles OS 240709*/

				/*adicionado tambem para o Hospital Ana Nery Santa Cruz do Sul OS 1021246*/

                        ie_via_acesso_ipe_w     := 35;
		elsif (ie_via_acesso_w        = 'R') then
                        ie_via_acesso_ipe_w     := 35;
                else
                        ie_via_acesso_ipe_w     := 99;
                end if;

                if (ie_via_acesso_ipe_w = 99) then
                        ie_via_acesso_ipe_w     := 00;
                end if;

                begin

                insert into w_interf_conta_item_ipe(
                        nr_sequencia,
                        nr_atendimento,
                        nr_interno_conta,
                        cd_item_convenio,
                        cd_item,
                        ds_item,
                        qt_item,
                        qt_item_conv_div,
                        dt_item,
                        vl_total_item,
                        cd_medico_executor,
                        cd_medico_exec_conv,
                        nm_medico_executor,
                        nr_crm_executor,
                        uf_crm_executor,
                        nr_cpf_executor,
                        cd_funcao_executor,
                        ie_via_acesso,
                        cd_brasindice,
                        nr_seq_protocolo,
                        cd_convenio,
                        cd_cgc_hospital,
                        cd_cgc_convenio,
                        cd_interno,
                        ie_responsavel_credito,
                        vl_honorario,
                        cd_prestador,
                        nr_folha,
                        nr_linha,
                        tp_nota,
                        ie_urgencia,
                        ie_tipo_item,
                        nr_seq_conta_convenio,
                        ie_prestador,
                        cd_cgc_prestador,
                        vl_original,
                        vl_unitario_item,
                        ie_video,
                        vl_custo_oper,
                        cd_unidade_medida)
                values ( nr_sequencia_w,
                        nr_atendimento_w,
                        nr_interno_conta_w,
                        cd_item_convenio_w,
                        cd_item_w,
                        ds_item_w,
                        qt_item_w,
                        qt_item_conv_div_w,
                        dt_item_w,
                        vl_total_item_w,
                        cd_medico_executor_w,
                        cd_medico_exec_conv_w,
                        nm_medico_executor_w,
                        nr_crm_executor_w,
                        uf_crm_executor_w,
                        nr_cpf_executor_w,
                        cd_funcao_executor_w,
                        ie_via_acesso_ipe_w,
                        cd_brasindice_w,
                        nr_seq_protocolo_w,
                        cd_convenio_w,
                        cd_cgc_hospital_w,
                        cd_cgc_convenio_w,
                        cd_interno_w,
                        ie_responsavel_credito_w,
                        vl_honorario_w,
                        cd_prestador_w,
                        nr_folha_w,
                        nr_linha_w,
                        tp_nota_w,
                        ie_urgencia_w,
                        cd_tipo_item_interf_w,
                        nr_seq_conta_convenio_w,
                        ie_prestador_w,
                        cd_cgc_prestador_w,
                        vl_original_w,
                        vl_unitario_item_w,
                        ie_video_w,
                        vl_custo_oper_w,
                        cd_unidade_medida_w);
                exception
                when others then
                        CALL wheb_mensagem_pck.exibir_mensagem_abort(200442,'NR_INTERNO_CONTA='||nr_interno_conta_w);
                        /*'Problema ao gerar as informacoes para a conta:'||nr_interno_conta_w*/

                end;

                /* tratar vlr matmed de exames que devem gerar acumulado no codigo 32200005 logo apos o exame */

                if (vl_matmed_proc_princ_w > 0) then
                        begin
                        select  nextval('w_interf_conta_item_ipe_seq')
                        into STRICT    nr_sequencia_w
;

                        nr_linha_w      := nr_linha_w + 1;

                        if (nr_linha_w     > 23) then
                                begin
                                nr_folha_w      := nr_folha_w + 1;
                                nr_linha_w      := 1;
                                end;
                        end if;

                        begin
                        insert into w_interf_conta_item_ipe(
                                nr_sequencia,
                                nr_atendimento,
                                nr_interno_conta,
                                cd_item_convenio,
                                ds_item,
                                qt_item,
                                qt_item_conv_div,
                                dt_item,
                                vl_total_item,
                                cd_medico_executor,
                                cd_medico_exec_conv,
                                nm_medico_executor,
                                nr_crm_executor,
                                uf_crm_executor,
                                nr_cpf_executor,
                                cd_funcao_executor,
                                ie_via_acesso,
                                cd_brasindice,
                                nr_seq_protocolo,
                                cd_convenio,
                                cd_cgc_hospital,
                                cd_cgc_convenio,
                                cd_interno,
                                ie_responsavel_credito,
                                vl_honorario,
                                cd_prestador,
                                nr_folha,
                                nr_linha,
                                tp_nota,
                                ie_urgencia,
                                ie_tipo_item,
                                nr_seq_conta_convenio,
                                ie_prestador,
                                cd_cgc_prestador,
                                vl_original,
                                vl_unitario_item,
                                ie_video,
                                cd_unidade_medida)
                        values ( nr_sequencia_w,
                                nr_atendimento_w,
                                nr_interno_conta_w,
                                32200005,
                                substr(wheb_mensagem_pck.get_texto(307097),1,255),
                                1,
                                1,
                                dt_item_w,
                                vl_matmed_proc_princ_w,
                                cd_medico_executor_w,
                                cd_medico_exec_conv_w,
                                nm_medico_executor_w,
                                nr_crm_executor_w,
                                uf_crm_executor_w,
                                nr_cpf_executor_w,
                                cd_funcao_executor_w,
                                ie_via_acesso_ipe_w,
                                cd_brasindice_w,
                                nr_seq_protocolo_w,
                                cd_convenio_w,
                                cd_cgc_hospital_w,
                                cd_cgc_convenio_w,
                                cd_interno_w,
                                ie_responsavel_credito_w,
                                vl_honorario_w,
                                cd_prestador_w,
                                nr_folha_w,
                                nr_linha_w,
                                tp_nota_w,
                                ie_urgencia_w,
                                cd_tipo_item_interf_w,
                                nr_seq_conta_convenio_w,
                                ie_prestador_w,
                                cd_cgc_prestador_w,
                                vl_matmed_proc_princ_w,
                                vl_unitario_item_w,
                                ie_video_w,
                                cd_unidade_medida_w);
                        exception
                        when others then
                                CALL wheb_mensagem_pck.exibir_mensagem_abort(200442,'NR_INTERNO_CONTA='||nr_interno_conta_w);
                                /*'Problema ao gerar as informacoes para a conta:'||nr_interno_conta_w*/

                        end;

                        end;
                end if;

                commit;

                end;
        end loop;
        end;
end loop;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_interf_conta_item_ipe ( nr_seq_protocolo_p bigint, nr_interno_conta_p bigint) FROM PUBLIC;

