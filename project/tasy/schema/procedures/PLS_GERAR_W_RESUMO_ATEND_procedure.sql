-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_gerar_w_resumo_atend ( ie_opcao_p text, ie_tipo_data_p text, dt_inicial_p timestamp, dt_final_p timestamp, nm_usuario_p text) AS $body$
DECLARE


nr_seq_item_w			bigint;
ds_item_w			varchar(255);
qt_total_atend_w		bigint;
qt_minutos_atend_w		double precision;
qt_media_atend_w		double precision;
ie_tipo_data_w			bigint;

C01 CURSOR FOR
	SELECT   to_char(b.dt_fim_atendimento,'yyyy'),
		 to_char(b.dt_fim_atendimento,'yyyy'),
		 count(b.nr_sequencia),
		 round((sum(b.dt_fim_atendimento - b.dt_inicio) * 1440)::numeric,2),
		 round((sum(b.dt_fim_atendimento - b.dt_inicio) * 1440) / count(b.nr_sequencia),2)
	from     pls_atendimento b, pls_atendimento_evento a
	where    a.nr_seq_atendimento = b.nr_sequencia
	and 	 trunc(dt_fim_atendimento,'dd') = trunc(dt_inicial_p,'dd')
	and	 ie_opcao_p = 'A'
	and	 ie_tipo_data_w = 0
	group by to_char(b.dt_fim_atendimento,'yyyy')
	
union

	SELECT   to_char(b.dt_fim_atendimento,'yyyy'),
		 to_char(b.dt_fim_atendimento,'yyyy'),
		 count(b.nr_sequencia),
		 round((sum(b.dt_fim_atendimento - b.dt_inicio) * 1440)::numeric,2),
		 round((sum(b.dt_fim_atendimento - b.dt_inicio) * 1440) / count(b.nr_sequencia),2)
	from     pls_atendimento b, pls_atendimento_evento a
	where    a.nr_seq_atendimento = b.nr_sequencia
	and 	 trunc(dt_fim_atendimento,'month') = trunc(dt_inicial_p,'month')
	and	 ie_opcao_p = 'A'
	and	 ie_tipo_data_w = 1
	group by to_char(b.dt_fim_atendimento,'yyyy')
	
union

	select   to_char(b.dt_fim_atendimento,'yyyy'),
		 to_char(b.dt_fim_atendimento,'yyyy'),
		 count(b.nr_sequencia),
		 round((sum(b.dt_fim_atendimento - b.dt_inicio) * 1440)::numeric,2),
		 round((sum(b.dt_fim_atendimento - b.dt_inicio) * 1440) / count(b.nr_sequencia),2)
	from     pls_atendimento b, pls_atendimento_evento a
	where    a.nr_seq_atendimento = b.nr_sequencia
	and 	 trunc(dt_fim_atendimento,'yyyy') = trunc(dt_inicial_p,'yyyy')
	and	 ie_opcao_p = 'A'
	and	 ie_tipo_data_w = 2
	group by to_char(b.dt_fim_atendimento,'yyyy')
	
union

	select   to_char(b.dt_fim_atendimento,'yyyy')  ,
		 to_char(b.dt_fim_atendimento,'yyyy')  ,
		 count(b.nr_sequencia)  ,
		 round((sum(b.dt_fim_atendimento - b.dt_inicio) * 1440)::numeric,2)  ,
		 round((sum(b.dt_fim_atendimento - b.dt_inicio) * 1440) / count(b.nr_sequencia),2)
	from     pls_atendimento b, pls_atendimento_evento a
	where    a.nr_seq_atendimento = b.nr_sequencia
	and	 ie_opcao_p = 'A'
	and	 ie_tipo_data_w = 3
	and 	 trunc(dt_fim_atendimento,'dd') between trunc(dt_inicial_p,'dd') and trunc(dt_final_p,'dd')
	group by to_char(b.dt_fim_atendimento,'yyyy')
	
union

	select   to_char(b.dt_fim_atendimento,'yyyy')  ,
		 to_char(b.dt_fim_atendimento,'yyyy')  ,

		 count(b.nr_sequencia)  ,
		 round((sum(b.dt_fim_atendimento - b.dt_inicio) * 1440)::numeric,2)  ,
		 round((sum(b.dt_fim_atendimento - b.dt_inicio) * 1440) / count(b.nr_sequencia),2)
	from     pls_atendimento b, pls_atendimento_evento a
	where    a.nr_seq_atendimento = b.nr_sequencia
	and	 ie_opcao_p = 'A'
	and	 ie_tipo_data_w = 4
	and 	 trunc(dt_fim_atendimento,'month') between trunc(dt_inicial_p,'month') and trunc(dt_final_p,'month')
	group by to_char(b.dt_fim_atendimento,'yyyy')
	
union

	select   to_char(b.dt_fim_atendimento,'yyyy')  ,
		 to_char(b.dt_fim_atendimento,'yyyy')  ,
		 count(b.nr_sequencia)  ,
		 round((sum(b.dt_fim_atendimento - b.dt_inicio) * 1440)::numeric,2)  ,
		 round((sum(b.dt_fim_atendimento - b.dt_inicio) * 1440) / count(b.nr_sequencia),2)
	from     pls_atendimento b, pls_atendimento_evento a
	where    a.nr_seq_atendimento = b.nr_sequencia
	and	 ie_opcao_p = 'A'
	and	 ie_tipo_data_w = 5
	and 	 trunc(dt_fim_atendimento,'yyyy') between trunc(dt_inicial_p,'yyyy') and trunc(dt_final_p,'yyyy')
	group by to_char(b.dt_fim_atendimento,'yyyy')
	order by 3 desc;

C02 CURSOR FOR
	SELECT	a.nr_seq_evento  , substr(pls_obter_nome_evento(a.nr_seq_evento),1,255)  ,
		count(b.nr_sequencia)  ,
		round((sum(a.dt_fim_evento - a.dt_inicio) * 1440)::numeric,2)  ,
		round((sum(a.dt_fim_evento - a.dt_inicio) * 1440) / count(a.nr_sequencia),2)
	from    pls_atendimento b, pls_atendimento_evento a
	where   a.nr_seq_atendimento = b.nr_sequencia
	and	ie_opcao_p = 'E'
	and	ie_tipo_data_w = 0
	and 	trunc(dt_fim_atendimento,'dd') = trunc(dt_inicial_p,'dd')
	group by pls_obter_nome_evento(a.nr_seq_evento), a.nr_seq_evento
	
union

	SELECT	a.nr_seq_evento  , substr(pls_obter_nome_evento(a.nr_seq_evento),1,255)  ,
		count(b.nr_sequencia)  ,
		round((sum(a.dt_fim_evento - a.dt_inicio) * 1440)::numeric,2)  ,
		round((sum(a.dt_fim_evento - a.dt_inicio) * 1440) / count(a.nr_sequencia),2)
	from    pls_atendimento b, pls_atendimento_evento a
	where   a.nr_seq_atendimento = b.nr_sequencia
	and	ie_opcao_p = 'E'
	and	ie_tipo_data_w = 1
	and 	trunc(dt_fim_atendimento,'month') = trunc(dt_inicial_p,'month')
	group by pls_obter_nome_evento(a.nr_seq_evento), a.nr_seq_evento
	
union

	select	a.nr_seq_evento  , substr(pls_obter_nome_evento(a.nr_seq_evento),1,255)  ,
		count(b.nr_sequencia)  ,
		round((sum(a.dt_fim_evento - a.dt_inicio) * 1440)::numeric,2)  ,
		round((sum(a.dt_fim_evento - a.dt_inicio) * 1440) / count(a.nr_sequencia),2)
	from    pls_atendimento b, pls_atendimento_evento a
	where   a.nr_seq_atendimento = b.nr_sequencia
	and	ie_opcao_p = 'E'
	and	ie_tipo_data_w = 2
	and   	trunc(dt_fim_atendimento,'yyyy') = trunc(dt_inicial_p,'yyyy')
	group by pls_obter_nome_evento(a.nr_seq_evento), a.nr_seq_evento
	
union

	select	a.nr_seq_evento  , substr(pls_obter_nome_evento(a.nr_seq_evento),1,255)  ,
		count(b.nr_sequencia)  ,
		round((sum(a.dt_fim_evento - a.dt_inicio) * 1440)::numeric,2)  ,
		round((sum(a.dt_fim_evento - a.dt_inicio) * 1440) / count(a.nr_sequencia),2)
	from    pls_atendimento b, pls_atendimento_evento a
	where   a.nr_seq_atendimento = b.nr_sequencia
	and	ie_opcao_p = 'E'
	and	ie_tipo_data_w = 3
	and   	trunc(dt_fim_atendimento,'dd') between trunc(dt_inicial_p,'dd') and trunc(dt_final_p,'dd')
	group by pls_obter_nome_evento(a.nr_seq_evento), a.nr_seq_evento
	
union

	select	a.nr_seq_evento  , substr(pls_obter_nome_evento(a.nr_seq_evento),1,255)  ,
		count(b.nr_sequencia)  ,
		round((sum(a.dt_fim_evento - a.dt_inicio) * 1440)::numeric,2)  ,
		round((sum(a.dt_fim_evento - a.dt_inicio) * 1440) / count(a.nr_sequencia),2)
	from    pls_atendimento b, pls_atendimento_evento a
	where   a.nr_seq_atendimento = b.nr_sequencia
	and	ie_opcao_p = 'E'
	and	ie_tipo_data_w = 4
	and   	trunc(dt_fim_atendimento,'month') between trunc(dt_inicial_p,'month') and trunc(dt_final_p,'month')
	group by pls_obter_nome_evento(a.nr_seq_evento), a.nr_seq_evento
	
union

	select	a.nr_seq_evento  , substr(pls_obter_nome_evento(a.nr_seq_evento),1,255)  ,
		count(b.nr_sequencia)  ,
		round((sum(a.dt_fim_evento - a.dt_inicio) * 1440)::numeric,2)  ,
		round((sum(a.dt_fim_evento - a.dt_inicio) * 1440) / count(a.nr_sequencia),2)
	from    pls_atendimento b, pls_atendimento_evento a
	where   a.nr_seq_atendimento = b.nr_sequencia
	and	ie_opcao_p = 'E'
	and	ie_tipo_data_w = 5
	and   	trunc(dt_fim_atendimento,'yyyy') between trunc(dt_inicial_p,'yyyy') and trunc(dt_final_p,'yyyy')
	group by pls_obter_nome_evento(a.nr_seq_evento), a.nr_seq_evento
	order by 3 desc;

C03 CURSOR FOR
	SELECT  to_char(b.dt_fim_atendimento,'mm/yyyy')  ,
		to_char(b.dt_fim_atendimento,'mm/yyyy')  ,
		count(b.nr_sequencia)  ,
		round((sum(b.dt_fim_atendimento - b.dt_inicio) * 1440)::numeric,2)  ,
		round((sum(b.dt_fim_atendimento - b.dt_inicio) * 1440) / count(b.nr_sequencia),2)
	from    pls_atendimento b, pls_atendimento_evento a
	where   a.nr_seq_atendimento = b.nr_sequencia
	and	ie_opcao_p = 'M'
	and	ie_tipo_data_w = 0
	and 	trunc(dt_fim_atendimento,'dd') = trunc(dt_inicial_p,'dd')
	group by to_char(b.dt_fim_atendimento,'mm/yyyy')
	
union

	SELECT  to_char(b.dt_fim_atendimento,'mm/yyyy')  ,
		to_char(b.dt_fim_atendimento,'mm/yyyy')  ,
		count(b.nr_sequencia)  ,
		round((sum(b.dt_fim_atendimento - b.dt_inicio) * 1440)::numeric,2)  ,
		round((sum(b.dt_fim_atendimento - b.dt_inicio) * 1440) / count(b.nr_sequencia),2)
	from    pls_atendimento b, pls_atendimento_evento a
	where   a.nr_seq_atendimento = b.nr_sequencia
	and	ie_opcao_p = 'M'
	and	ie_tipo_data_w = 1
	and 	trunc(dt_fim_atendimento,'month') = trunc(dt_inicial_p,'month')
	group by to_char(b.dt_fim_atendimento,'mm/yyyy')
	
union

	select  to_char(b.dt_fim_atendimento,'mm/yyyy')  ,
		to_char(b.dt_fim_atendimento,'mm/yyyy')  ,
		count(b.nr_sequencia)  ,
		round((sum(b.dt_fim_atendimento - b.dt_inicio) * 1440)::numeric,2)  ,
		round((sum(b.dt_fim_atendimento - b.dt_inicio) * 1440) / count(b.nr_sequencia),2)
	from    pls_atendimento b, pls_atendimento_evento a
	where   a.nr_seq_atendimento = b.nr_sequencia
	and	ie_opcao_p = 'M'
	and	ie_tipo_data_w = 2
	and 	trunc(dt_fim_atendimento,'yyyy') = trunc(dt_inicial_p,'yyyy')
	group by to_char(b.dt_fim_atendimento,'mm/yyyy')
	
union

	select  to_char(b.dt_fim_atendimento,'mm/yyyy')  ,
		to_char(b.dt_fim_atendimento,'mm/yyyy')  ,
		count(b.nr_sequencia)  ,
		round((sum(b.dt_fim_atendimento - b.dt_inicio) * 1440)::numeric,2)  ,
		round((sum(b.dt_fim_atendimento - b.dt_inicio) * 1440) / count(b.nr_sequencia),2)
	from    pls_atendimento b, pls_atendimento_evento a
	where   a.nr_seq_atendimento = b.nr_sequencia
	and	ie_opcao_p = 'M'
	and	ie_tipo_data_w = 3
	and 	trunc(dt_fim_atendimento,'dd') between trunc(dt_inicial_p,'dd') and trunc(dt_final_p,'dd')
	group by to_char(b.dt_fim_atendimento,'mm/yyyy')
	
union

	select  to_char(b.dt_fim_atendimento,'mm/yyyy')  ,
		to_char(b.dt_fim_atendimento,'mm/yyyy')  ,
		count(b.nr_sequencia)  ,
		round((sum(b.dt_fim_atendimento - b.dt_inicio) * 1440)::numeric,2)  ,
		round((sum(b.dt_fim_atendimento - b.dt_inicio) * 1440) / count(b.nr_sequencia),2)
	from    pls_atendimento b, pls_atendimento_evento a
	where   a.nr_seq_atendimento = b.nr_sequencia
	and	ie_opcao_p = 'M'
	and	ie_tipo_data_w = 4
	and 	trunc(dt_fim_atendimento,'month') between trunc(dt_inicial_p,'month') and trunc(dt_final_p,'month')
	group by to_char(b.dt_fim_atendimento,'mm/yyyy')
	
union

	select  to_char(b.dt_fim_atendimento,'mm/yyyy')  ,
		to_char(b.dt_fim_atendimento,'mm/yyyy')  ,
		count(b.nr_sequencia)  ,
		round((sum(b.dt_fim_atendimento - b.dt_inicio) * 1440)::numeric,2)  ,
		round((sum(b.dt_fim_atendimento - b.dt_inicio) * 1440) / count(b.nr_sequencia),2)
	from    pls_atendimento b, pls_atendimento_evento a
	where   a.nr_seq_atendimento = b.nr_sequencia
	and	ie_opcao_p = 'M'
	and	ie_tipo_data_w = 5
	and 	trunc(dt_fim_atendimento,'yyyy') between trunc(dt_inicial_p,'yyyy') and trunc(dt_final_p,'yyyy')
	group by to_char(b.dt_fim_atendimento,'mm/yyyy')
	order by 3 desc;

C04 CURSOR FOR
	SELECT	substr(pls_obter_dados_operador(b.nr_seq_operador,'C'),1,10)  , substr(pls_obter_dados_operador(b.nr_seq_operador,'M'),1,255)  ,
		count(b.nr_sequencia)  ,
		round((sum(b.dt_fim_atendimento - b.dt_inicio) * 1440)::numeric,2)  ,
		round((sum(b.dt_fim_atendimento - b.dt_inicio) * 1440) / count(b.nr_sequencia),2)
	from    pls_atendimento b, pls_atendimento_evento a
	where   a.nr_seq_atendimento = b.nr_sequencia
	and	ie_opcao_p = 'O'
	and	ie_tipo_data_w = 0
	and 	trunc(dt_fim_atendimento,'dd') = trunc(dt_inicial_p,'dd')
	group by pls_obter_dados_operador(b.nr_seq_operador,'M'), pls_obter_dados_operador(b.nr_seq_operador,'C')
	
union

	SELECT	substr(pls_obter_dados_operador(b.nr_seq_operador,'C'),1,10)  , substr(pls_obter_dados_operador(b.nr_seq_operador,'M'),1,255)  ,
		count(b.nr_sequencia)  ,
		round((sum(b.dt_fim_atendimento - b.dt_inicio) * 1440)::numeric,2)  ,
		round((sum(b.dt_fim_atendimento - b.dt_inicio) * 1440) / count(b.nr_sequencia),2)
	from    pls_atendimento b, pls_atendimento_evento a
	where   a.nr_seq_atendimento = b.nr_sequencia
	and	ie_opcao_p = 'O'
	and	ie_tipo_data_w = 1
	and 	trunc(dt_fim_atendimento,'month') = trunc(dt_inicial_p,'month')
	group by pls_obter_dados_operador(b.nr_seq_operador,'M'), pls_obter_dados_operador(b.nr_seq_operador,'C')
	
union

	select  substr(pls_obter_dados_operador(b.nr_seq_operador,'C'),1,10)  , substr(pls_obter_dados_operador(b.nr_seq_operador,'M'),1,255)  ,
		count(b.nr_sequencia)  ,
		round((sum(b.dt_fim_atendimento - b.dt_inicio) * 1440)::numeric,2)  ,
		round((sum(b.dt_fim_atendimento - b.dt_inicio) * 1440) / count(b.nr_sequencia),2)
	from    pls_atendimento b, pls_atendimento_evento a
	where   a.nr_seq_atendimento = b.nr_sequencia
	and	ie_opcao_p = 'O'
	and	ie_tipo_data_w = 2
	and 	trunc(dt_fim_atendimento,'yyyy') = trunc(dt_inicial_p,'yyyy')
	group by pls_obter_dados_operador(b.nr_seq_operador,'M'), pls_obter_dados_operador(b.nr_seq_operador,'C')
	
union

	select  substr(pls_obter_dados_operador(b.nr_seq_operador,'C'),1,10)  , substr(pls_obter_dados_operador(b.nr_seq_operador,'M'),1,255)  ,
		count(b.nr_sequencia)  ,
		round((sum(b.dt_fim_atendimento - b.dt_inicio) * 1440)::numeric,2)  ,
		round((sum(b.dt_fim_atendimento - b.dt_inicio) * 1440) / count(b.nr_sequencia),2)
	from    pls_atendimento b, pls_atendimento_evento a
	where   a.nr_seq_atendimento = b.nr_sequencia
	and	ie_opcao_p = 'O'
	and	ie_tipo_data_w = 3
	and 	trunc(dt_fim_atendimento,'dd') between trunc(dt_inicial_p,'dd') and trunc(dt_final_p,'dd')
	group by pls_obter_dados_operador(b.nr_seq_operador,'M'), pls_obter_dados_operador(b.nr_seq_operador,'C')
	
union

	select  substr(pls_obter_dados_operador(b.nr_seq_operador,'C'),1,10)  , substr(pls_obter_dados_operador(b.nr_seq_operador,'M'),1,255)  ,
		count(b.nr_sequencia)  ,
		round((sum(b.dt_fim_atendimento - b.dt_inicio) * 1440)::numeric,2)  ,
		round((sum(b.dt_fim_atendimento - b.dt_inicio) * 1440) / count(b.nr_sequencia),2)
	from    pls_atendimento b, pls_atendimento_evento a
	where   a.nr_seq_atendimento = b.nr_sequencia
	and	ie_opcao_p = 'O'
	and	ie_tipo_data_w = 4
	and 	trunc(dt_fim_atendimento,'month') between trunc(dt_inicial_p,'month') and trunc(dt_final_p,'month')
	group by pls_obter_dados_operador(b.nr_seq_operador,'M'), pls_obter_dados_operador(b.nr_seq_operador,'C')
	
union

	select	substr(pls_obter_dados_operador(b.nr_seq_operador,'C'),1,10)  , substr(pls_obter_dados_operador(b.nr_seq_operador,'M'),1,255)  ,
		count(b.nr_sequencia)  ,
		round((sum(b.dt_fim_atendimento - b.dt_inicio) * 1440)::numeric,2)  ,
		round((sum(b.dt_fim_atendimento - b.dt_inicio) * 1440) / count(b.nr_sequencia),2)
	from     pls_atendimento b, pls_atendimento_evento a
	where    a.nr_seq_atendimento = b.nr_sequencia
	and	ie_opcao_p = 'O'
	and	ie_tipo_data_w = 5
	and 	trunc(dt_fim_atendimento,'yyyy') between trunc(dt_inicial_p,'yyyy') and trunc(dt_final_p,'yyyy')
	group by pls_obter_dados_operador(b.nr_seq_operador,'M'), pls_obter_dados_operador(b.nr_seq_operador,'C')
	order by 3 desc;

C05 CURSOR FOR
	SELECT	b.ie_origem_atendimento  , substr(obter_valor_dominio(3180,b.ie_origem_atendimento),1,255)  ,
		count(b.nr_sequencia)  ,
		round((sum(b.dt_fim_atendimento - b.dt_inicio) * 1440)::numeric,2)  ,
		round((sum(b.dt_fim_atendimento - b.dt_inicio) * 1440) / count(b.nr_sequencia),2)
	from    pls_atendimento b, pls_atendimento_evento a
	where   a.nr_seq_atendimento = b.nr_sequencia
	and	ie_opcao_p = 'OA'
	and	ie_tipo_data_w = 0
	and 	trunc(dt_fim_atendimento,'dd') = trunc(dt_inicial_p,'dd')
	group by obter_valor_dominio(3180,b.ie_origem_atendimento), b.ie_origem_atendimento
	
union

	SELECT	b.ie_origem_atendimento  , substr(obter_valor_dominio(3180,b.ie_origem_atendimento),1,255)  ,
		count(b.nr_sequencia)  ,
		round((sum(b.dt_fim_atendimento - b.dt_inicio) * 1440)::numeric,2)  ,
		round((sum(b.dt_fim_atendimento - b.dt_inicio) * 1440) / count(b.nr_sequencia),2)
	from    pls_atendimento b, pls_atendimento_evento a
	where   a.nr_seq_atendimento = b.nr_sequencia
	and	ie_opcao_p = 'OA'
	and	ie_tipo_data_w = 1
	and 	trunc(dt_fim_atendimento,'month') = trunc(dt_inicial_p,'month')
	group by obter_valor_dominio(3180,b.ie_origem_atendimento), b.ie_origem_atendimento
	
union

	select	b.ie_origem_atendimento  , substr(obter_valor_dominio(3180,b.ie_origem_atendimento),1,255)  ,
		count(b.nr_sequencia)  ,
		round((sum(b.dt_fim_atendimento - b.dt_inicio) * 1440)::numeric,2)  ,
		round((sum(b.dt_fim_atendimento - b.dt_inicio) * 1440) / count(b.nr_sequencia),2)
	from    pls_atendimento b, pls_atendimento_evento a
	where   a.nr_seq_atendimento = b.nr_sequencia
	and	ie_opcao_p = 'OA'
	and	ie_tipo_data_w = 2
	and 	trunc(dt_fim_atendimento,'yyyy') = trunc(dt_inicial_p,'yyyy')
	group by obter_valor_dominio(3180,b.ie_origem_atendimento), b.ie_origem_atendimento
	
union

	select	b.ie_origem_atendimento  , substr(obter_valor_dominio(3180,b.ie_origem_atendimento),1,255)  ,
		count(b.nr_sequencia)  ,
		round((sum(b.dt_fim_atendimento - b.dt_inicio) * 1440)::numeric,2)  ,
		round((sum(b.dt_fim_atendimento - b.dt_inicio) * 1440) / count(b.nr_sequencia),2)
	from    pls_atendimento b, pls_atendimento_evento a
	where   a.nr_seq_atendimento = b.nr_sequencia
	and	ie_opcao_p = 'OA'
	and	ie_tipo_data_w = 3
	and 	trunc(dt_fim_atendimento,'dd') between trunc(dt_inicial_p,'dd') and trunc(dt_final_p,'dd')
	group by obter_valor_dominio(3180,b.ie_origem_atendimento), b.ie_origem_atendimento
	
union

	select	b.ie_origem_atendimento  , substr(obter_valor_dominio(3180,b.ie_origem_atendimento),1,255)  ,
		count(b.nr_sequencia)  ,
		round((sum(b.dt_fim_atendimento - b.dt_inicio) * 1440)::numeric,2)  ,
		round((sum(b.dt_fim_atendimento - b.dt_inicio) * 1440) / count(b.nr_sequencia),2)
	from    pls_atendimento b, pls_atendimento_evento a
	where   a.nr_seq_atendimento = b.nr_sequencia
	and	ie_opcao_p = 'OA'
	and	ie_tipo_data_w = 4
	and 	trunc(dt_fim_atendimento,'month') between trunc(dt_inicial_p,'month') and trunc(dt_final_p,'month')
	group by obter_valor_dominio(3180,b.ie_origem_atendimento), b.ie_origem_atendimento
	
union

	select	b.ie_origem_atendimento  , substr(obter_valor_dominio(3180,b.ie_origem_atendimento),1,255)  ,
		count(b.nr_sequencia)  ,
		round((sum(b.dt_fim_atendimento - b.dt_inicio) * 1440)::numeric,2)  ,
		round((sum(b.dt_fim_atendimento - b.dt_inicio) * 1440) / count(b.nr_sequencia),2)
	from    pls_atendimento b, pls_atendimento_evento a
	where   a.nr_seq_atendimento = b.nr_sequencia
	and	ie_opcao_p = 'OA'
	and	ie_tipo_data_w = 5
	and 	trunc(dt_fim_atendimento,'yyyy') between trunc(dt_inicial_p,'month') and trunc(dt_final_p,'yyyy')
	group by obter_valor_dominio(3180,b.ie_origem_atendimento), b.ie_origem_atendimento
	order by 3 desc;

C06 CURSOR FOR
	SELECT 	b.ie_tipo_atendimento  ,
		CASE WHEN b.ie_tipo_atendimento='A' THEN 'Ativo' WHEN b.ie_tipo_atendimento='R' THEN 'Receptivo' END   ,
		count(b.nr_sequencia)  ,
		round((sum(b.dt_fim_atendimento - b.dt_inicio) * 1440)::numeric,2)  ,
		round((sum(b.dt_fim_atendimento - b.dt_inicio) * 1440) / count(b.nr_sequencia),2)
	from    pls_atendimento b, pls_atendimento_evento a
	where   a.nr_seq_atendimento = b.nr_sequencia
	and	ie_opcao_p = 'TA'
	and	ie_tipo_data_w = 0
	and 	trunc(dt_fim_atendimento,'dd') = trunc(dt_inicial_p,'dd')
	group by b.ie_tipo_atendimento
	
union

	SELECT 	b.ie_tipo_atendimento  ,
		CASE WHEN b.ie_tipo_atendimento='A' THEN 'Ativo' WHEN b.ie_tipo_atendimento='R' THEN 'Receptivo' END   ,
		count(b.nr_sequencia)  ,
		round((sum(b.dt_fim_atendimento - b.dt_inicio) * 1440)::numeric,2)  ,
		round((sum(b.dt_fim_atendimento - b.dt_inicio) * 1440) / count(b.nr_sequencia),2)
	from    pls_atendimento b, pls_atendimento_evento a
	where   a.nr_seq_atendimento = b.nr_sequencia
	and	ie_opcao_p = 'TA'
	and	ie_tipo_data_w = 1
	and 	trunc(dt_fim_atendimento,'month') = trunc(dt_inicial_p,'month')
	group by b.ie_tipo_atendimento
	
union

	select 	b.ie_tipo_atendimento  ,
		CASE WHEN b.ie_tipo_atendimento='A' THEN 'Ativo' WHEN b.ie_tipo_atendimento='R' THEN 'Receptivo' END   ,
		count(b.nr_sequencia)  ,
		round((sum(b.dt_fim_atendimento - b.dt_inicio) * 1440)::numeric,2)  ,
		round((sum(b.dt_fim_atendimento - b.dt_inicio) * 1440) / count(b.nr_sequencia),2)
	from    pls_atendimento b, pls_atendimento_evento a
	where   a.nr_seq_atendimento = b.nr_sequencia
	and	ie_opcao_p = 'TA'
	and	ie_tipo_data_w = 2
	and 	trunc(dt_fim_atendimento,'yyyy') = trunc(dt_inicial_p,'yyyy')
	group by b.ie_tipo_atendimento
	
union

	select	b.ie_tipo_atendimento  ,
		CASE WHEN b.ie_tipo_atendimento='A' THEN 'Ativo' WHEN b.ie_tipo_atendimento='R' THEN 'Receptivo' END   ,
		count(b.nr_sequencia)  ,
		round((sum(b.dt_fim_atendimento - b.dt_inicio) * 1440)::numeric,2)  ,
		round((sum(b.dt_fim_atendimento - b.dt_inicio) * 1440) / count(b.nr_sequencia),2)
	from    pls_atendimento b, pls_atendimento_evento a
	where   a.nr_seq_atendimento = b.nr_sequencia
	and	ie_opcao_p = 'TA'
	and	ie_tipo_data_w = 3
	and 	trunc(dt_fim_atendimento,'dd') between trunc(dt_inicial_p,'dd') and trunc(dt_final_p,'dd')
	group by b.ie_tipo_atendimento
	
union

	select	b.ie_tipo_atendimento  ,
		CASE WHEN b.ie_tipo_atendimento='A' THEN 'Ativo' WHEN b.ie_tipo_atendimento='R' THEN 'Receptivo' END   ,
		count(b.nr_sequencia)  ,
		round((sum(b.dt_fim_atendimento - b.dt_inicio) * 1440)::numeric,2)  ,
		round((sum(b.dt_fim_atendimento - b.dt_inicio) * 1440) / count(b.nr_sequencia),2)
	from    pls_atendimento b, pls_atendimento_evento a
	where   a.nr_seq_atendimento = b.nr_sequencia
	and	ie_opcao_p = 'TA'
	and	ie_tipo_data_w = 4
	and 	trunc(dt_fim_atendimento,'month') between trunc(dt_inicial_p,'month') and trunc(dt_final_p,'month')
	group by b.ie_tipo_atendimento
	
union

	select	b.ie_tipo_atendimento  ,
		CASE WHEN b.ie_tipo_atendimento='A' THEN 'Ativo' WHEN b.ie_tipo_atendimento='R' THEN 'Receptivo' END   ,
		count(b.nr_sequencia)  ,
		round((sum(b.dt_fim_atendimento - b.dt_inicio) * 1440)::numeric,2)  ,
		round((sum(b.dt_fim_atendimento - b.dt_inicio) * 1440) / count(b.nr_sequencia),2)
	from    pls_atendimento b, pls_atendimento_evento a
	where   a.nr_seq_atendimento = b.nr_sequencia
	and	ie_opcao_p = 'TA'
	and	ie_tipo_data_w = 5
	and 	trunc(dt_fim_atendimento,'yyyy') between trunc(dt_inicial_p,'yyyy') and trunc(dt_final_p,'yyyy')
	group by b.ie_tipo_atendimento
	order by 1;

C07 CURSOR FOR
	SELECT	a.nr_seq_tipo_ocorrencia  , substr(pls_obter_descricao_ocorrencia(nr_seq_tipo_ocorrencia),1,255)  ,
		count(b.nr_sequencia)  ,
		round((sum(a.dt_fim_evento - a.dt_inicio) * 1440)::numeric,2)  ,
		round((sum(a.dt_fim_evento - a.dt_inicio) * 1440) / count(a.nr_sequencia),2)
	from    pls_atendimento b, pls_atendimento_evento a
	where   a.nr_seq_atendimento = b.nr_sequencia
	and	ie_opcao_p = 'TO'
	and	ie_tipo_data_w = 0
	and 	trunc(dt_fim_atendimento,'dd') = trunc(dt_inicial_p,'dd')
	group by substr(pls_obter_descricao_ocorrencia(nr_seq_tipo_ocorrencia),1,255), a.nr_seq_tipo_ocorrencia
	
union

	SELECT	a.nr_seq_tipo_ocorrencia  , substr(pls_obter_descricao_ocorrencia(nr_seq_tipo_ocorrencia),1,255)  ,
		count(b.nr_sequencia)  ,
		round((sum(a.dt_fim_evento - a.dt_inicio) * 1440)::numeric,2)  ,
		round((sum(a.dt_fim_evento - a.dt_inicio) * 1440) / count(a.nr_sequencia),2)
	from    pls_atendimento b, pls_atendimento_evento a
	where   a.nr_seq_atendimento = b.nr_sequencia
	and	ie_opcao_p = 'TO'
	and	ie_tipo_data_w = 1
	and 	trunc(dt_fim_atendimento,'month') = trunc(dt_inicial_p,'month')
	group by substr(pls_obter_descricao_ocorrencia(nr_seq_tipo_ocorrencia),1,255), a.nr_seq_tipo_ocorrencia
	
union

	select	a.nr_seq_tipo_ocorrencia  , substr(pls_obter_descricao_ocorrencia(nr_seq_tipo_ocorrencia),1,255)  ,
		count(b.nr_sequencia)  ,
		round((sum(a.dt_fim_evento - a.dt_inicio) * 1440)::numeric,2)  ,
		round((sum(a.dt_fim_evento - a.dt_inicio) * 1440) / count(a.nr_sequencia),2)
	from    pls_atendimento b, pls_atendimento_evento a
	where   a.nr_seq_atendimento = b.nr_sequencia
	and	ie_opcao_p = 'TO'
	and	ie_tipo_data_w = 2
	and 	trunc(dt_fim_atendimento,'yyyy') = trunc(dt_inicial_p,'yyyy')
	group by substr(pls_obter_descricao_ocorrencia(nr_seq_tipo_ocorrencia),1,255), a.nr_seq_tipo_ocorrencia
	
union

	select	a.nr_seq_tipo_ocorrencia  , substr(pls_obter_descricao_ocorrencia(nr_seq_tipo_ocorrencia),1,255)  ,
		count(b.nr_sequencia)  ,
		round((sum(a.dt_fim_evento - a.dt_inicio) * 1440)::numeric,2)  ,
		round((sum(a.dt_fim_evento - a.dt_inicio) * 1440) / count(a.nr_sequencia),2)
	from    pls_atendimento b, pls_atendimento_evento a
	where   a.nr_seq_atendimento = b.nr_sequencia
	and	ie_opcao_p = 'TO'
	and	ie_tipo_data_w = 3
	and 	trunc(dt_fim_atendimento,'dd') between trunc(dt_inicial_p,'dd') and trunc(dt_final_p,'dd')
	group by substr(pls_obter_descricao_ocorrencia(nr_seq_tipo_ocorrencia),1,255), a.nr_seq_tipo_ocorrencia
	
union

	select	a.nr_seq_tipo_ocorrencia  , substr(pls_obter_descricao_ocorrencia(nr_seq_tipo_ocorrencia),1,255)  ,
		count(b.nr_sequencia)  ,
		round((sum(a.dt_fim_evento - a.dt_inicio) * 1440)::numeric,2)  ,
		round((sum(a.dt_fim_evento - a.dt_inicio) * 1440) / count(a.nr_sequencia),2)
	from    pls_atendimento b, pls_atendimento_evento a
	where   a.nr_seq_atendimento = b.nr_sequencia
	and	ie_opcao_p = 'TO'
	and	ie_tipo_data_w = 4
	and 	trunc(dt_fim_atendimento,'month') between trunc(dt_inicial_p,'month') and trunc(dt_final_p,'month')
	group by substr(pls_obter_descricao_ocorrencia(nr_seq_tipo_ocorrencia),1,255), a.nr_seq_tipo_ocorrencia
	
union

	select	a.nr_seq_tipo_ocorrencia  , substr(pls_obter_descricao_ocorrencia(nr_seq_tipo_ocorrencia),1,255)  ,
		count(b.nr_sequencia)  ,
		round((sum(a.dt_fim_evento - a.dt_inicio) * 1440)::numeric,2)  ,
		round((sum(a.dt_fim_evento - a.dt_inicio) * 1440) / count(a.nr_sequencia),2)
	from    pls_atendimento b, pls_atendimento_evento a
	where   a.nr_seq_atendimento = b.nr_sequencia
	and	ie_opcao_p = 'TO'
	and	ie_tipo_data_w = 5
	and 	trunc(dt_fim_atendimento,'yyyy') between trunc(dt_inicial_p,'month') and trunc(dt_final_p,'yyyy')
	group by substr(pls_obter_descricao_ocorrencia(nr_seq_tipo_ocorrencia),1,255), a.nr_seq_tipo_ocorrencia
	order by 3 desc;

C08 CURSOR FOR
	SELECT	b.ie_tipo_pessoa  , substr(obter_valor_dominio(3181,b.ie_tipo_pessoa),1,255)  ,
		count(b.nr_sequencia)  ,
		round((sum(b.dt_fim_atendimento - b.dt_inicio) * 1440)::numeric,2)  ,
		round((sum(b.dt_fim_atendimento - b.dt_inicio) * 1440) / count(b.nr_sequencia),2)
	from    pls_atendimento b, pls_atendimento_evento a
	where   a.nr_seq_atendimento = b.nr_sequencia
	and	ie_opcao_p = 'TP'
	and	ie_tipo_data_w = 0
	and 	trunc(dt_fim_atendimento,'dd') = trunc(dt_inicial_p,'dd')
	group by obter_valor_dominio(3181,b.ie_tipo_pessoa), b.ie_tipo_pessoa
	
union

	SELECT	b.ie_tipo_pessoa  , substr(obter_valor_dominio(3181,b.ie_tipo_pessoa),1,255)  ,
		count(b.nr_sequencia)  ,
		round((sum(b.dt_fim_atendimento - b.dt_inicio) * 1440)::numeric,2)  ,
		round((sum(b.dt_fim_atendimento - b.dt_inicio) * 1440) / count(b.nr_sequencia),2)
	from    pls_atendimento b, pls_atendimento_evento a
	where   a.nr_seq_atendimento = b.nr_sequencia
	and	ie_opcao_p = 'TP'
	and	ie_tipo_data_w = 1
	and 	trunc(dt_fim_atendimento,'month') = trunc(dt_inicial_p,'month')
	group by obter_valor_dominio(3181,b.ie_tipo_pessoa), b.ie_tipo_pessoa
	
union

	select	b.ie_tipo_pessoa  , substr(obter_valor_dominio(3181,b.ie_tipo_pessoa),1,255)  ,
		count(b.nr_sequencia)  ,
		round((sum(b.dt_fim_atendimento - b.dt_inicio) * 1440)::numeric,2)  ,
		round((sum(b.dt_fim_atendimento - b.dt_inicio) * 1440) / count(b.nr_sequencia),2)
	from    pls_atendimento b, pls_atendimento_evento a
	where   a.nr_seq_atendimento = b.nr_sequencia
	and	ie_opcao_p = 'TP'
	and	ie_tipo_data_w = 2
	and 	trunc(dt_fim_atendimento,'yyyy') = trunc(dt_inicial_p,'yyyy')
	group by obter_valor_dominio(3181,b.ie_tipo_pessoa), b.ie_tipo_pessoa
	
union

	select	b.ie_tipo_pessoa  , substr(obter_valor_dominio(3181,b.ie_tipo_pessoa),1,255)  ,
		count(b.nr_sequencia)  ,
		round((sum(b.dt_fim_atendimento - b.dt_inicio) * 1440)::numeric,2)  ,
		round((sum(b.dt_fim_atendimento - b.dt_inicio) * 1440) / count(b.nr_sequencia),2)
	from    pls_atendimento b, pls_atendimento_evento a
	where   a.nr_seq_atendimento = b.nr_sequencia
	and	ie_opcao_p = 'TP'
	and	ie_tipo_data_w = 3
	and 	trunc(dt_fim_atendimento,'dd') between trunc(dt_inicial_p,'dd') and trunc(dt_final_p,'dd')
	group by obter_valor_dominio(3181,b.ie_tipo_pessoa), b.ie_tipo_pessoa
	
union

	select	b.ie_tipo_pessoa  , substr(obter_valor_dominio(3181,b.ie_tipo_pessoa),1,255)  ,
		count(b.nr_sequencia)  ,
		round((sum(b.dt_fim_atendimento - b.dt_inicio) * 1440)::numeric,2)  ,
		round((sum(b.dt_fim_atendimento - b.dt_inicio) * 1440) / count(b.nr_sequencia),2)
	from    pls_atendimento b, pls_atendimento_evento a
	where   a.nr_seq_atendimento = b.nr_sequencia
	and	ie_opcao_p = 'TP'
	and	ie_tipo_data_w = 4
	and 	trunc(dt_fim_atendimento,'month') between trunc(dt_inicial_p,'month') and trunc(dt_final_p,'month')
	group by obter_valor_dominio(3181,b.ie_tipo_pessoa), b.ie_tipo_pessoa
	
union

	select	b.ie_tipo_pessoa  , substr(obter_valor_dominio(3181,b.ie_tipo_pessoa),1,255)  ,
		count(b.nr_sequencia)  ,
		round((sum(b.dt_fim_atendimento - b.dt_inicio) * 1440)::numeric,2)  ,
		round((sum(b.dt_fim_atendimento - b.dt_inicio) * 1440) / count(b.nr_sequencia),2)
	from    pls_atendimento b, pls_atendimento_evento a
	where   a.nr_seq_atendimento = b.nr_sequencia
	and	ie_opcao_p = 'TP'
	and	ie_tipo_data_w = 5
	and 	trunc(dt_fim_atendimento,'yyyy') between trunc(dt_inicial_p,'yyyy') and trunc(dt_final_p,'yyyy')
	group by obter_valor_dominio(3181,b.ie_tipo_pessoa), b.ie_tipo_pessoa
	 order by 3 desc;


BEGIN

delete	from w_pls_resumo_atendimento
where	nm_usuario	= nm_usuario_p;

ie_tipo_data_w	:= (ie_tipo_data_p)::numeric;

if (ie_opcao_p	= 'A') then
	open C01;
	loop
	fetch C01 into
		nr_seq_item_w,
		ds_item_w,
		qt_total_atend_w,
		qt_minutos_atend_w,
		qt_media_atend_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin

		insert	into w_pls_resumo_atendimento(nr_sequencia, nr_seq_item, ds_item,
			 qt_total_atendimento, qt_minutos_atendimento, qt_media_atendimento,
			 dt_atualizacao, nm_usuario)
		values (nextval('w_pls_resumo_atendimento_seq'), nr_seq_item_w, ds_item_w,
			 qt_total_atend_w, qt_minutos_atend_w, qt_media_atend_w,
			 clock_timestamp(), nm_usuario_p);

		end;
	end loop;
	close C01;
elsif (ie_opcao_p	= 'E') then
	open C02;
	loop
	fetch C02 into
		nr_seq_item_w,
		ds_item_w,
		qt_total_atend_w,
		qt_minutos_atend_w,
		qt_media_atend_w;
	EXIT WHEN NOT FOUND; /* apply on C02 */
		begin

		insert	into w_pls_resumo_atendimento(nr_sequencia, nr_seq_item, ds_item,
			 qt_total_atendimento, qt_minutos_atendimento, qt_media_atendimento,
			 dt_atualizacao, nm_usuario)
		values (nextval('w_pls_resumo_atendimento_seq'), nr_seq_item_w, ds_item_w,
			 qt_total_atend_w, qt_minutos_atend_w, qt_media_atend_w,
			 clock_timestamp(), nm_usuario_p);

		end;
	end loop;
	close C02;
elsif (ie_opcao_p	= 'M') then
	open C03;
	loop
	fetch C03 into
		nr_seq_item_w,
		ds_item_w,
		qt_total_atend_w,
		qt_minutos_atend_w,
		qt_media_atend_w;
	EXIT WHEN NOT FOUND; /* apply on C03 */
		begin

		insert	into w_pls_resumo_atendimento(nr_sequencia, nr_seq_item, ds_item,
			 qt_total_atendimento, qt_minutos_atendimento, qt_media_atendimento,
			 dt_atualizacao, nm_usuario)
		values (nextval('w_pls_resumo_atendimento_seq'), nr_seq_item_w, ds_item_w,
			 qt_total_atend_w, qt_minutos_atend_w, qt_media_atend_w,
			 clock_timestamp(), nm_usuario_p);

		end;
	end loop;
	close C03;
elsif (ie_opcao_p	= 'O') then
	open C04;
	loop
	fetch C04 into
		nr_seq_item_w,
		ds_item_w,
		qt_total_atend_w,
		qt_minutos_atend_w,
		qt_media_atend_w;
	EXIT WHEN NOT FOUND; /* apply on C04 */
		begin

		insert	into w_pls_resumo_atendimento(nr_sequencia, nr_seq_item, ds_item,
			 qt_total_atendimento, qt_minutos_atendimento, qt_media_atendimento,
			 dt_atualizacao, nm_usuario)
		values (nextval('w_pls_resumo_atendimento_seq'), nr_seq_item_w, ds_item_w,
			 qt_total_atend_w, qt_minutos_atend_w, qt_media_atend_w,
			 clock_timestamp(), nm_usuario_p);

		end;
	end loop;
	close C04;
elsif (ie_opcao_p	= 'OA') then
	open C05;
	loop
	fetch C05 into
		nr_seq_item_w,
		ds_item_w,
		qt_total_atend_w,
		qt_minutos_atend_w,
		qt_media_atend_w;
	EXIT WHEN NOT FOUND; /* apply on C05 */
		begin

		insert	into w_pls_resumo_atendimento(nr_sequencia, nr_seq_item, ds_item,
			 qt_total_atendimento, qt_minutos_atendimento, qt_media_atendimento,
			 dt_atualizacao, nm_usuario)
		values (nextval('w_pls_resumo_atendimento_seq'), nr_seq_item_w, ds_item_w,
			 qt_total_atend_w, qt_minutos_atend_w, qt_media_atend_w,
			 clock_timestamp(), nm_usuario_p);

		end;
	end loop;
	close C05;
elsif (ie_opcao_p	= 'TA') then
	open C06;
	loop
	fetch C06 into
		nr_seq_item_w,
		ds_item_w,
		qt_total_atend_w,
		qt_minutos_atend_w,
		qt_media_atend_w;
	EXIT WHEN NOT FOUND; /* apply on C06 */
		begin

		insert	into w_pls_resumo_atendimento(nr_sequencia, nr_seq_item, ds_item,
			 qt_total_atendimento, qt_minutos_atendimento, qt_media_atendimento,
			 dt_atualizacao, nm_usuario)
		values (nextval('w_pls_resumo_atendimento_seq'), nr_seq_item_w, ds_item_w,
			 qt_total_atend_w, qt_minutos_atend_w, qt_media_atend_w,
			 clock_timestamp(), nm_usuario_p);

		end;
	end loop;
	close C06;
elsif (ie_opcao_p	= 'TO') then
	open C07;
	loop
	fetch C07 into
		nr_seq_item_w,
		ds_item_w,
		qt_total_atend_w,
		qt_minutos_atend_w,
		qt_media_atend_w;
	EXIT WHEN NOT FOUND; /* apply on C07 */
		begin

		insert	into w_pls_resumo_atendimento(nr_sequencia, nr_seq_item, ds_item,
			 qt_total_atendimento, qt_minutos_atendimento, qt_media_atendimento,
			 dt_atualizacao, nm_usuario)
		values (nextval('w_pls_resumo_atendimento_seq'), nr_seq_item_w, ds_item_w,
			 qt_total_atend_w, qt_minutos_atend_w, qt_media_atend_w,
			 clock_timestamp(), nm_usuario_p);

		end;
	end loop;
	close C07;
elsif (ie_opcao_p	= 'TP') then
	open C08;
	loop
	fetch C08 into
		nr_seq_item_w,
		ds_item_w,
		qt_total_atend_w,
		qt_minutos_atend_w,
		qt_media_atend_w;
	EXIT WHEN NOT FOUND; /* apply on C08 */
		begin

		insert	into w_pls_resumo_atendimento(nr_sequencia, nr_seq_item, ds_item,
			 qt_total_atendimento, qt_minutos_atendimento, qt_media_atendimento,
			 dt_atualizacao, nm_usuario)
		values (nextval('w_pls_resumo_atendimento_seq'), nr_seq_item_w, ds_item_w,
			 qt_total_atend_w, qt_minutos_atend_w, qt_media_atend_w,
			 clock_timestamp(), nm_usuario_p);

		end;
	end loop;
	close C08;
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_gerar_w_resumo_atend ( ie_opcao_p text, ie_tipo_data_p text, dt_inicial_p timestamp, dt_final_p timestamp, nm_usuario_p text) FROM PUBLIC;

