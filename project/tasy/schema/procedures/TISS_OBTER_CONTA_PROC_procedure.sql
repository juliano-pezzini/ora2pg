-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE tiss_obter_conta_proc (nr_interno_conta_p bigint, ie_tiss_tipo_guia_p text, cd_cgc_prestador_p text, cd_autorizacao_p text, cd_procedimento_p text, cd_procedimento_convenio_p text, cd_procedimento_tuss_p text, nr_seq_guia_p INOUT bigint, nr_seq_proc_p INOUT bigint) AS $body$
DECLARE

 
cd_procedimento_w	bigint;
nr_seq_guia_w		bigint;
nr_seq_proc_w		bigint;
cd_cgc_estab_w		varchar(14);

c01 CURSOR FOR 
SELECT	max(nr_seq_guia), 
	max(nr_sequencia) 
from ( 
	SELECT	nr_seq_guia, 
		nr_sequencia 
	from	tiss_conta_proc 
	where	nr_interno_conta						= nr_interno_conta_p 
	and	cd_procedimento						= somente_numero(cd_procedimento_p) 
	and	ie_tiss_tipo_guia						= ie_tiss_tipo_guia_p 
	and	coalesce(cd_cgc_prestador, coalesce(cd_cgc_prestador_p, 'X'))		= coalesce(cd_cgc_prestador_p, 'X') 
	and	coalesce(cd_autorizacao, coalesce(cd_autorizacao_p, 'Não Informada'))	= coalesce(cd_autorizacao_p, 'Não Informada') 
	
union
 
	select	nr_seq_guia, 
		nr_sequencia 
	from	tiss_conta_proc 
	where	nr_interno_conta						= nr_interno_conta_p 
	and	somente_numero(cd_procedimento)				= somente_numero(cd_procedimento_convenio_p) 
	and	ie_tiss_tipo_guia						= ie_tiss_tipo_guia_p 
	and	coalesce(cd_cgc_prestador, coalesce(cd_cgc_prestador_p, 'X'))		= coalesce(cd_cgc_prestador_p, 'X') 
	and	coalesce(cd_autorizacao, coalesce(cd_autorizacao_p, 'Não Informada'))	= coalesce(cd_autorizacao_p, 'Não Informada') 
	
union
 
	select	nr_seq_guia, 
		nr_sequencia 
	from	tiss_conta_proc 
	where	nr_interno_conta						= nr_interno_conta_p 
	and	somente_numero(cd_procedimento)				= somente_numero(cd_procedimento_tuss_p) 
	and	ie_tiss_tipo_guia						= ie_tiss_tipo_guia_p 
	and	coalesce(cd_cgc_prestador, coalesce(cd_cgc_prestador_p, 'X'))		= coalesce(cd_cgc_prestador_p, 'X') 
	and	coalesce(cd_autorizacao, coalesce(cd_autorizacao_p, 'Não Informada'))	= coalesce(cd_autorizacao_p, 'Não Informada') 
	
union
 
	select	nr_seq_guia, 
		nr_sequencia 
	from	tiss_conta_proc 
	where	nr_interno_conta						= nr_interno_conta_p 
	and	somente_numero(cd_procedimento)				= lpad(somente_numero(cd_procedimento_convenio_p),8,'0') 
	and	ie_tiss_tipo_guia						= ie_tiss_tipo_guia_p 
	and	coalesce(cd_cgc_prestador, coalesce(cd_cgc_prestador_p, 'X'))		= coalesce(cd_cgc_prestador_p, 'X') 
	and	coalesce(cd_autorizacao, coalesce(cd_autorizacao_p, 'Não Informada'))	= coalesce(cd_autorizacao_p, 'Não Informada') 
	
union
 
	select	nr_seq_guia, 
		nr_sequencia 
	from	tiss_conta_proc 
	where	nr_interno_conta						= nr_interno_conta_p 
	and	somente_numero(cd_procedimento)				= lpad(somente_numero(cd_procedimento_tuss_p),8,'0') 
	and	ie_tiss_tipo_guia						= ie_tiss_tipo_guia_p 
	and	coalesce(cd_cgc_prestador, coalesce(cd_cgc_prestador_p, 'X'))		= coalesce(cd_cgc_prestador_p, 'X') 
	and	coalesce(cd_autorizacao, coalesce(cd_autorizacao_p, 'Não Informada'))	= coalesce(cd_autorizacao_p, 'Não Informada') 
	
union
 
	select	nr_seq_guia, 
		nr_sequencia 
	from	tiss_conta_proc 
	where	nr_interno_conta						= nr_interno_conta_p 
	and	somente_numero(cd_procedimento)				= lpad(somente_numero(cd_procedimento_p),8,'0') 
	and	ie_tiss_tipo_guia						= ie_tiss_tipo_guia_p 
	and	coalesce(cd_cgc_prestador, coalesce(cd_cgc_prestador_p, 'X'))		= coalesce(cd_cgc_prestador_p, 'X') 
	and	coalesce(cd_autorizacao, coalesce(cd_autorizacao_p, 'Não Informada'))	= coalesce(cd_autorizacao_p, 'Não Informada') 
	
union
 
	select	nr_seq_guia, 
		nr_sequencia 
	from	tiss_conta_desp 
	where	nr_interno_conta						= nr_interno_conta_p 
	and	somente_numero(cd_procedimento)					= somente_numero(cd_procedimento_p) 
	and	ie_tiss_tipo_guia_desp						= ie_tiss_tipo_guia_p 
	and	coalesce(cd_cgc_prestador, coalesce(cd_cgc_prestador_p, 'X'))		= coalesce(coalesce(cd_cgc_prestador_p,cd_cgc_estab_w), 'X') 
	and	coalesce(cd_autorizacao, coalesce(cd_autorizacao_p, 'Não Informada'))	= coalesce(cd_autorizacao_p, 'Não Informada') 
	
union
 
	select	nr_seq_guia, 
		nr_sequencia 
	from	tiss_conta_desp 
	where	nr_interno_conta							= nr_interno_conta_p 
	and	somente_numero(cd_procedimento)						= lpad(somente_numero(cd_procedimento_convenio_p),8,'0') 
	and	ie_tiss_tipo_guia_desp							= ie_tiss_tipo_guia_p 
	and	coalesce(cd_cgc_prestador, coalesce(coalesce(cd_cgc_prestador_p,cd_cgc_estab_w), 'X'))	= coalesce(coalesce(cd_cgc_prestador_p,cd_cgc_estab_w), 'X') 
	and	coalesce(cd_autorizacao, coalesce(cd_autorizacao_p, 'Não Informada'))		= coalesce(cd_autorizacao_p, 'Não Informada') 
	
union
 
	select	nr_seq_guia, 
		nr_sequencia 
	from	tiss_conta_desp 
	where	nr_interno_conta							= nr_interno_conta_p 
	and	somente_numero(cd_procedimento)						= lpad(somente_numero(cd_procedimento_tuss_p),8,'0') 
	and	ie_tiss_tipo_guia_desp							= ie_tiss_tipo_guia_p 
	and	coalesce(cd_cgc_prestador, coalesce(coalesce(cd_cgc_prestador_p,cd_cgc_estab_w), 'X'))	= coalesce(coalesce(cd_cgc_prestador_p,cd_cgc_estab_w), 'X') 
	and	coalesce(cd_autorizacao, coalesce(cd_autorizacao_p, 'Não Informada'))		= coalesce(cd_autorizacao_p, 'Não Informada') 
	
union
 
	select	nr_seq_guia, 
		nr_sequencia 
	from	tiss_conta_desp 
	where	nr_interno_conta							= nr_interno_conta_p 
	and	somente_numero(cd_procedimento)						= somente_numero(cd_procedimento_convenio_p) 
	and	ie_tiss_tipo_guia_desp							= ie_tiss_tipo_guia_p 
	and	coalesce(cd_cgc_prestador, coalesce(coalesce(cd_cgc_prestador_p,cd_cgc_estab_w), 'X'))	= coalesce(coalesce(cd_cgc_prestador_p,cd_cgc_estab_w), 'X') 
	and	coalesce(cd_autorizacao, coalesce(cd_autorizacao_p, 'Não Informada'))		= coalesce(cd_autorizacao_p, 'Não Informada') 
	
union
 
	select	nr_seq_guia, 
		nr_sequencia 
	from	tiss_conta_desp 
	where	nr_interno_conta							= nr_interno_conta_p 
	and	somente_numero(cd_procedimento)						= somente_numero(cd_procedimento_tuss_p) 
	and	ie_tiss_tipo_guia_desp							= ie_tiss_tipo_guia_p 
	and	coalesce(cd_cgc_prestador, coalesce(coalesce(cd_cgc_prestador_p,cd_cgc_estab_w), 'X'))	= coalesce(coalesce(cd_cgc_prestador_p,cd_cgc_estab_w), 'X') 
	and	coalesce(cd_autorizacao, coalesce(cd_autorizacao_p, 'Não Informada'))		= coalesce(cd_autorizacao_p, 'Não Informada')) alias103;


BEGIN 
 
select	max(a.cd_cgc) 
into STRICT	cd_cgc_estab_w 
from	estabelecimento a, 
	conta_paciente b 
where	a.cd_estabelecimento	= b.cd_estabelecimento 
and	b.nr_interno_conta	= nr_interno_conta_p;
 
open c01;
loop 
fetch c01 into 
	nr_seq_guia_w, 
	nr_seq_proc_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
 
	nr_seq_guia_w	:= nr_seq_guia_w;
	nr_seq_proc_w	:= nr_seq_proc_w;
 
end loop;
close c01;
 
nr_seq_guia_p	:= nr_seq_guia_w;
nr_seq_proc_p	:= nr_seq_proc_w;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE tiss_obter_conta_proc (nr_interno_conta_p bigint, ie_tiss_tipo_guia_p text, cd_cgc_prestador_p text, cd_autorizacao_p text, cd_procedimento_p text, cd_procedimento_convenio_p text, cd_procedimento_tuss_p text, nr_seq_guia_p INOUT bigint, nr_seq_proc_p INOUT bigint) FROM PUBLIC;

