-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE carregar_vl_totais_js ( cd_estabelecimento_p bigint, cd_empresa_p bigint, dt_inicio_p timestamp, dt_final_p timestamp, cd_conta_contabil_p bigint, cd_tipo_lote_p bigint, vl_total_debito_p INOUT text, vl_total_creditp_p INOUT text, vl_total_saldo_atual_p INOUT text, vl_saldo_ant_p INOUT text) AS $body$
DECLARE


vl_total_debito_w		varchar(30);
vl_total_credito_w		varchar(30);
vl_total_saldo_atual_w	varchar(30);
vl_saldo_ant_w		varchar(30);


BEGIN

	if (cd_conta_contabil_p IS NOT NULL AND cd_conta_contabil_p::text <> '') then
		begin

			select	coalesce(sum(a.vl_saldo),0) vl_saldo
			into STRICT 	vl_saldo_ant_w
			from	ctb_mes_ref b,
				ctb_saldo a
			where	a.nr_seq_mes_ref = b.nr_sequencia
			and	b.cd_empresa		= 	cd_empresa_p
			and	a.cd_estabelecimento	= 	cd_estabelecimento_p
			and	a.cd_conta_contabil	= 	cd_conta_contabil_p
			and	PKG_DATE_UTILS.start_of(b.dt_referencia, 'month', 0)	= PKG_DATE_UTILS.start_of(PKG_DATE_UTILS.ADD_MONTH(dt_inicio_p, -1, 0), 'month', 0);


			select  campo_mascara_virgula(coalesce(sum(a.vl_debito),0))
			into STRICT	vl_total_debito_w
			from 	lote_contabil b,
				ctb_movimento_v a
                     		where	a.nr_lote_contabil = b.nr_lote_contabil
                      		and	a.cd_estabelecimento =  cd_estabelecimento_p
                      		 and	dt_movimento
			between dt_inicio_p  and  dt_final_p
                       		and	cd_conta_contabil =  cd_conta_contabil_p
                        		and 	a.cd_tipo_lote_contabil = cd_tipo_lote_p;


			select 	campo_mascara_virgula(coalesce(sum(a.vl_credito),0))
			into STRICT	vl_total_credito_w
			from 	lote_contabil b,
				ctb_movimento_v a
                        		where	a.nr_lote_contabil = b.nr_lote_contabil
                        		and	a.cd_estabelecimento =  cd_estabelecimento_p
                        		and	dt_movimento
			between dt_inicio_p  and  dt_final_p
                        		and	cd_conta_contabil = cd_conta_contabil_p
                        		and 	a.cd_tipo_lote_contabil =  cd_tipo_lote_p;


			select  campo_mascara_virgula(coalesce(sum(vl_saldo),0))
			into STRICT	vl_total_saldo_atual_w
			from 	ctb_saldo
			where 	cd_conta_contabil =  cd_conta_contabil_p
                        		and 	cd_estabelecimento = cd_estabelecimento_p
			and	nr_seq_mes_ref = (	SELECT  nr_sequencia
							from	ctb_mes_ref
							where	cd_empresa = cd_empresa_p
							and 	dt_referencia = dt_inicio_p);

			vl_total_debito_p 	:=	vl_total_debito_w	;
			vl_total_creditp_p 	:=	vl_total_credito_w	;
			vl_total_saldo_atual_p	:=	vl_total_saldo_atual_w	;
			vl_saldo_ant_p		:=	vl_saldo_ant_w		;

		end;
	end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE carregar_vl_totais_js ( cd_estabelecimento_p bigint, cd_empresa_p bigint, dt_inicio_p timestamp, dt_final_p timestamp, cd_conta_contabil_p bigint, cd_tipo_lote_p bigint, vl_total_debito_p INOUT text, vl_total_creditp_p INOUT text, vl_total_saldo_atual_p INOUT text, vl_saldo_ant_p INOUT text) FROM PUBLIC;

