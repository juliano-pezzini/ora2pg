-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_proc_cih_autorizacao ( nr_sequencia_p bigint, nm_usuario_p text) AS $body$
DECLARE


cd_procedimento_princ_w		bigint;
ie_origem_proced_W		bigint;
cd_procedimento_sus_w		bigint;
ie_origem_proced_sus_W		bigint;
cd_cid_primario_w			varchar(10);
cd_cid_secundario_w		varchar(10);
nr_atendimento_w			bigint;


BEGIN

select 	coalesce(max(a.cd_procedimento_principal),0),
	coalesce(max(a.ie_origem_proced),0),
	max(nr_atendimento)
into STRICT	cd_procedimento_princ_w,
	ie_origem_proced_w,
	nr_atendimento_w
from 	autorizacao_convenio a
where	a.nr_sequencia		= nr_sequencia_p;

if (cd_procedimento_princ_w = 0) then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(174204);
end if;

/*if	(nvl(nr_seq_autorizacao_p,0) = 0) then
	wheb_mensagem_pck.exibir_mensagem_abort(174205);
end if;*/
select	coalesce(max(a.cd_procedimento_sus),0),
	coalesce(max(a.ie_origem_proced_sus),0)
into STRICT	cd_procedimento_sus_w,
	ie_origem_proced_sus_W
from	procedimento_conv_sus a
where	a.cd_procedimento	 	= cd_procedimento_princ_w
and	a.ie_origem_proced 	= ie_origem_proced_W;

if (cd_procedimento_sus_w = 0) then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(174206);
end if;

update 	autorizacao_convenio
set 	dt_geracao_cih		= clock_timestamp()
where	nr_sequencia		= nr_sequencia_p;

select 	max(cd_doenca)
into STRICT 	cd_cid_primario_w
from	diagnostico_doenca
where 	ie_classificacao_doenca = 'P'
and	nr_atendimento		 = nr_atendimento_w;

select 	max(cd_doenca)
into STRICT	cd_cid_secundario_w
from	diagnostico_doenca
where 	ie_classificacao_doenca = 'S'
and	nr_atendimento 		= nr_atendimento_w;

begin
insert into procedimento_paciente_cih(nr_atendimento, nr_sequencia, cd_procedimento, ie_origem_proced,
					dt_atualizacao, nm_usuario, cd_cid_primario, cd_cid_secundario)
	values (nr_atendimento_w, 1, cd_procedimento_sus_w,ie_origem_proced_sus_W,
					clock_timestamp(), nm_usuario_p, cd_cid_primario_w, cd_cid_secundario_w);
exception
when others then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(174207);
end;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_proc_cih_autorizacao ( nr_sequencia_p bigint, nm_usuario_p text) FROM PUBLIC;

