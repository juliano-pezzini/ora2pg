-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_ame_gerar_copartic_hrf ( nr_sequencia_p bigint, ds_local_p text, nm_arquivo_p text) AS $body$
DECLARE

 
ds_erro_w			varchar(255);
ds_conteudo_w			varchar(4000);
nm_estipulante_w		varchar(255);
cd_estipulante_w		varchar(255);
arq_texto_w			utl_file.file_type;
dt_ref_mensalidade_w		timestamp;
nr_contrato_segurado_w		integer;
nr_seq_contrato_segurado_w	integer;
vl_coparticipacao_w		double precision;
vl_base_copartic_w		double precision;
vl_cont_coparticipacao_w	double precision;

C01 CURSOR FOR 
	SELECT	pls_obter_contrato_benef_pag(null,d.nr_seq_segurado) nr_contrato, 
		pls_obter_nome_contrato(pls_obter_dados_contrato(e.nr_seq_contrato,'N'), 'S') nm_contrato, 
		pls_obter_dados_contrato(e.nr_seq_contrato,'E') nm_estipulante, 
		pls_obter_dados_contrato(e.nr_seq_contrato,'C') cd_estipulante, 
		d.nr_seq_segurado, 
		trim(both to_char(pls_obter_dados_segurado(e.nr_sequencia,'C'),'99999G000000G000000G00')) carteirinha, 
		pls_obter_dados_segurado(e.nr_sequencia,'N') nm_segurado, 
		substr(coalesce(e.cd_matricula_estipulante,'00000000'),1,8) cd_matricula, 
		regexp_replace(lpad(pls_obter_dados_segurado(e.nr_sequencia,'CPF'), 11, '0'), '([0-9]{3})([0-9]{3})([0-9]{3})([0-9]{2})','\1.\2.\3-\4') cd_cpf, 
		coalesce(e.nr_seq_titular, e.nr_sequencia) nr_seq_titular, 
		trim(both to_char(pls_obter_dados_segurado(coalesce(e.nr_seq_titular , e.nr_sequencia),'C'),'99999G000000G000000G00')) nr_carteira_titular, 
		pls_obter_dados_segurado(coalesce(e.nr_seq_titular, e.nr_sequencia),'N') nm_titular, 
		case when coalesce(d.nr_seq_titular::text, '') = '' then 'T' else 'D' end ie_tipo_segurado, 
		f.nr_seq_prestador_exec nr_seq_prestador, 
		pls_obter_dados_prestador(f.nr_seq_prestador_exec,'N') nm_prestador, 
		h.cd_proced_mat, 
		h.ds_proced_mat, 
		to_date(h.dt_atendimento, 'dd/mm/yyyy') dt_evento, 
		h.vl_coparticipacao, 
		h.qt_cobrada, 
		i.cd_sistema_ant, 
		f.tx_coparticipacao, 
		f.vl_base_copartic 
	FROM pls_ame_lote_rem_valor_cop h, pls_ame_lote_rem_valor_det g, pls_conta_coparticipacao f, pls_ame_lote_rem_valor d, pls_ame_lote_rem_arquivo c, pls_ame_lote_rem_destino b, pls_ame_lote_remessa a, pls_segurado e
LEFT OUTER JOIN pls_localizacao_benef i ON (e.nr_seq_localizacao_benef = i.nr_sequencia)
WHERE a.nr_sequencia			= b.nr_seq_lote_rem and b.nr_sequencia    		= c.nr_seq_lote_rem_dest and c.nr_sequencia    		= d.nr_seq_lote_rem_arq and e.nr_sequencia    		= d.nr_seq_segurado and d.nr_sequencia			= g.nr_seq_lote_rem_valor and g.nr_sequencia 			= h.nr_seq_rem_valor_detalhe and h.nr_seq_conta_coparticipacao 	= f.nr_sequencia  and c.nr_sequencia   		= nr_sequencia_p;
BEGIN
 
vl_coparticipacao_w		:= 0;
vl_base_copartic_w		:= 0;
vl_cont_coparticipacao_w	:= 0;
 
begin 
select	c.dt_ref_mensalidade 
into STRICT 	dt_ref_mensalidade_w 
from 	pls_ame_lote_rem_arquivo 	a, 
	pls_ame_lote_rem_destino 	b, 
	pls_ame_lote_remessa  	c 
where 	a.nr_seq_lote_rem_dest	= b.nr_sequencia 
and 	b.nr_seq_lote_rem  	= c.nr_sequencia 
and 	a.nr_sequencia   	= nr_sequencia_p;
exception 
when others then 
	CALL wheb_mensagem_pck.exibir_mensagem_abort(359678);
end;
 
begin 
arq_texto_w := utl_file.fopen(ds_local_p,nm_arquivo_p,'W');
exception 
when others then 
	if (SQLSTATE = -29289) then 
		ds_erro_w := 'O acesso ao arquivo foi negado pelo sistema operacional (access_denied).';
	elsif (SQLSTATE = -29298) then 
		ds_erro_w := 'O arquivo foi aberto usando FOPEN_NCHAR, mas efetuaram-se operações de I/O usando funções nonchar comos PUTF ou GET_LINE (charsetmismatch).';
	elsif (SQLSTATE = -29291) then 
		ds_erro_w := 'Não foi possível apagar o arquivo (delete_failed).';
	elsif (SQLSTATE = -29286) then 
		ds_erro_w := 'Erro interno desconhecido no package UTL_FILE (internal_error).';
	elsif (SQLSTATE = -29282) then 
		ds_erro_w := 'O handle do arquivo não existe (invalid_filehandle).';
	elsif (SQLSTATE = -29288) then 
		ds_erro_w := 'O arquivo com o nome especificado não foi encontrado neste local (invalid_filename).';
	elsif (SQLSTATE = -29287) then 
		ds_erro_w := 'O valor de MAX_LINESIZE para FOPEN() é inválido; deveria estar na faixa de 1 a 32767 (invalid_maxlinesize).';
	elsif (SQLSTATE = -29281) then 
		ds_erro_w := 'O parâmetro open_mode na chamda FOPEN é inválido (invalid_mode).';
	elsif (SQLSTATE = -29290) then 
		ds_erro_w := 'O parâmetro ABSOLUTE_OFFSET para a chamada FSEEK() é inválido; deveria ser maior do que 0 e menor do que o número total de bytes do arquivo (invalid_offset).';
	elsif (SQLSTATE = -29283) then 
		ds_erro_w := 'O arquivo não pôde ser aberto ou operado da forma desejada - ou o caminho não foi encontrado (invalid_operation).';
	elsif (SQLSTATE = -29280) then 
		ds_erro_w := 'O caminho especificado não existe ou não está visível ao Oracle (invalid_path).';
	elsif (SQLSTATE = -29284) then 
		ds_erro_w := 'Não é possível efetuar a leitura do arquivo (read_error).';
	elsif (SQLSTATE = -29292) then 
		ds_erro_w := 'Não é possível renomear o arquivo.';
	elsif (SQLSTATE = -29285) then 
		ds_erro_w := 'Não foi possível gravar no arquivo (write_error).';
	else 
		ds_erro_w := 'Erro desconhecido no package UTL_FILE.';
	end if;
end;
if (ds_erro_w IS NOT NULL AND ds_erro_w::text <> '') then 
	CALL wheb_mensagem_pck.exibir_mensagem_abort(ds_erro_w);
end if;
 
ds_conteudo_w	:= 'Analítico de Participação';
utl_file.put_line(arq_texto_w,ds_conteudo_w || chr(13));
 
ds_conteudo_w	:= 'Periodo de Referência: '||formatar_data_mascara(dt_ref_mensalidade_w,'dd/mm/yyyy')||' a '||formatar_data_mascara(last_day(dt_ref_mensalidade_w),'dd/mm/yyyy');
utl_file.put_line(arq_texto_w,ds_conteudo_w || chr(13));
utl_file.put_line(arq_texto_w,'' || chr(13));
utl_file.put_line(arq_texto_w,'' || chr(13));
 
utl_file.fflush(arq_texto_w);
 
ds_conteudo_w	:= 'Contrato#Nome Contrato#Numero Empresa#Empresa#Numero Titular#Nome Titular#Matricula#Numero Beneficiário'|| 
		'#Nome Beneficiário#Tipo Associado#Codigo Prestador#Nome Prestador#Código Procedimento#Nome do Procedimento'|| 
		'#Data Evento#Valor Participação#Qtd Aprovada#Participação (%)#Valor Aprovado#Lotação';
utl_file.put_line(arq_texto_w,ds_conteudo_w || chr(13));
 
for r_c01_w in C01 loop 
	begin 
 
	ds_conteudo_w 	:= r_c01_w.nr_contrato||'#'||r_c01_w.nm_contrato||'#'||r_c01_w.cd_estipulante||'#'||r_c01_w.nm_estipulante||'#'|| 
			r_c01_w.nr_carteira_titular||'#'||r_c01_w.nm_titular||'#'||r_c01_w.cd_matricula||'#'||r_c01_w.carteirinha||'#'|| 
			r_c01_w.nm_segurado||'#'||r_c01_w.ie_tipo_segurado||'#'||r_c01_w.nr_seq_prestador||'#'||r_c01_w.nm_prestador||'#'|| 
			r_c01_w.cd_proced_mat||'#'||r_c01_w.ds_proced_mat||'#'||r_c01_w.dt_evento||'#'||r_c01_w.vl_coparticipacao||'#'|| 
			r_c01_w.qt_cobrada||'#'||r_c01_w.tx_coparticipacao||'#'||r_c01_w.vl_base_copartic||'#'||r_c01_w.cd_sistema_ant;			
			utl_file.put_line(arq_texto_w,ds_conteudo_w || chr(13));
			utl_file.fflush(arq_texto_w);
			 
	vl_coparticipacao_w		:= vl_coparticipacao_w + r_c01_w.vl_coparticipacao;
	vl_base_copartic_w		:= vl_base_copartic_w + r_c01_w.vl_base_copartic;
	vl_cont_coparticipacao_w	:= vl_cont_coparticipacao_w + 1;	
	end;
end loop;
 
ds_conteudo_w	:= 'Total referente a co-participação de : '||formatar_data_mascara(dt_ref_mensalidade_w,'dd/mm/yyyy')||' até '||formatar_data_mascara(last_day(dt_ref_mensalidade_w),'dd/mm/yyyy')|| 
		'###############'||vl_coparticipacao_w||'#'||vl_cont_coparticipacao_w||'##'||vl_base_copartic_w;
utl_file.put_line(arq_texto_w,ds_conteudo_w || chr(13));
utl_file.fflush(arq_texto_w);
 
utl_file.fclose(arq_texto_w);
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_ame_gerar_copartic_hrf ( nr_sequencia_p bigint, ds_local_p text, nm_arquivo_p text) FROM PUBLIC;

