-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_vent_bundle_report ( nm_usuario_p text, dt_inicial_p timestamp, dt_final_p timestamp, pr_min_margin_p bigint, pr_max_margin_p bigint ) AS $body$
DECLARE


nr_sequencia_w		bigint;
ie_care_plan_w		varchar(5);
dt_care_plan_w		timestamp;
ie_vte_rx_w		varchar(5);
ie_sup_rx_w		varchar(5);
ie_hob_w		varchar(5);
dt_hob_w		timestamp;
ie_oral_care_w		varchar(5);
ie_extub_eval_w		varchar(5);
ie_sed_holiday_w	varchar(5);

c01 CURSOR FOR

	SELECT	a.nr_atendimento,
		'IVC' ie_ivc,
		a.cd_pessoa_fisica,
		a.dt_entrada
	from	atendimento_paciente a,
		atend_pac_dispositivo b,
		dispositivo c
	where	a.nr_atendimento = b.nr_atendimento
	and	b.nr_seq_dispositivo = c.nr_sequencia
	and	c.ie_classif_disp_niss = 'VMI'
	and	trunc(a.dt_entrada) between trunc(dt_inicial_p) and trunc(dt_final_p)
	
union

	SELECT	a.nr_atendimento,
		'' ie_ivc,
		a.cd_pessoa_fisica,
		a.dt_entrada
	from	atendimento_paciente a,
		atend_pac_dispositivo b,
		dispositivo c
	where	a.nr_atendimento = b.nr_atendimento
	and	b.nr_seq_dispositivo = c.nr_sequencia
	and  ((c.ie_classif_disp_niss <> 'VMI') or (not exists (select * from atend_pac_dispositivo d
								where d.nr_atendimento = a.nr_atendimento)))
	and	trunc(a.dt_entrada) between trunc(dt_inicial_p) and trunc(dt_final_p)
	order by nr_atendimento;

c01_w		c01%rowtype;


BEGIN

delete	FROM w_vent_bundle_report
where	nm_usuario = nm_usuario_p;
commit;

open c01;
loop
fetch c01 into
	c01_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	begin

	select	CASE WHEN count(1)=0 THEN 'X'  ELSE 'Y' END
	into STRICT	ie_care_plan_w
	from	pe_prescricao a,
		pe_prescr_item_result b
	where	b.nr_seq_prescr = a.nr_sequencia
	and	((a.dt_inicio_prescr between(dt_inicial_p - 1) and (dt_final_p + 1))
	or (a.dt_validade_prescr between(dt_inicial_p - 1) and (dt_final_p + 1)))
	and	a.nr_atendimento = c01_w.nr_atendimento
	and	a.ie_situacao = 'A'
	and	(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '');

	if (ie_care_plan_w = 'X') then

		select	max(a.dt_validade_prescr) dt
		into STRICT	dt_care_plan_w
		from	pe_prescricao a,
			pe_prescr_item_result b
		where	b.nr_seq_prescr = a.nr_sequencia
		and	a.nr_atendimento = c01_w.nr_atendimento
		and	a.ie_situacao = 'A'
		and	(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '');

	end if;

	select	coalesce(ie_coagulation_alter,ie_patient_ambulating,ie_full_anticoagulation,
			ie_compression_devices,ie_ivc_filter,'N')
	into STRICT	ie_vte_rx_w
	from
		(SELECT  CASE WHEN count(1)=0 THEN null  ELSE 'NI' END  ie_coagulation_alter
		from    prescr_medica b,
			prescr_procedimento c,
			exame_laboratorio e,
			exame_lab_result_item d
		where   b.nr_prescricao = c.nr_prescricao
		and     c.nr_seq_exame = e.nr_seq_exame
		and     d.nr_seq_exame = e.nr_seq_exame
		and	e.ie_tipo_exame_rel = 5
		and     ((d.pr_resultado < pr_min_margin_p) or (d.pr_resultado > pr_max_margin_p))
		and     b.nr_atendimento = c01_w.nr_atendimento) coagulation_alter,
		(select	CASE WHEN count(1)=0 THEN null  ELSE 'NI' END  ie_patient_ambulating
		from	prescr_medica b,
			pe_prescricao e,
			pe_prescr_item_result d,
			pe_item_result_proc p,
			cp_intervention c
		where	e.nr_prescricao = b.nr_prescricao
		and	d.nr_seq_prescr = e.nr_sequencia
		and	p.nr_seq_result = d.nr_seq_result
		and	c.nr_seq_pe_procedimento = p.nr_seq_proc
		and	c.ie_situacao = 'A'
		and	c.ie_interv_sae_rel in (18,19)
		and	b.nr_atendimento = c01_w.nr_atendimento) patient_ambulating,
		(select  CASE WHEN count(1)=0 THEN null  ELSE 'NR' END  ie_full_anticoagulation
		from	prescr_mat_alteracao pma,
			prescr_material pm,
			material m,
			classe_material cm
		where	pm.nr_prescricao = pma.nr_prescricao
		and	m.cd_material = pm.cd_material
		and	(m.cd_medicamento IS NOT NULL AND m.cd_medicamento::text <> '')
		and	m.cd_classe_material = cm.cd_classe_material
		and	cm.ie_classe_material_rel = 22
		and	pma.nr_atendimento = c01_w.nr_atendimento) full_anticoagulation,
		(select	CASE WHEN count(1)=0 THEN null  ELSE 'Y' END  ie_compression_devices
		from    atendimento_paciente a,
			prescr_medica b,
			prescr_procedimento c,
			procedimento d
		where   a.nr_atendimento = b.nr_atendimento
		and     b.nr_prescricao = c.nr_prescricao
		and	c.cd_procedimento = d.cd_procedimento
		and	c.ie_origem_proced = d.ie_origem_proced
		and	d.ie_tipo_rel in (1,3)
		and     a.nr_atendimento = c01_w.nr_atendimento) compression_devices,
		(select	CASE WHEN count(1)=0 THEN null  ELSE 'Y' END  ie_ivc_filter
		from	prescr_mat_alteracao pma,
			prescr_material pm,
			material m,
			classe_material cm
		where	pm.nr_prescricao = pma.nr_prescricao
		and	m.cd_material = pm.cd_material
		and	(m.cd_medicamento IS NOT NULL AND m.cd_medicamento::text <> '')
		and	m.cd_classe_material = cm.cd_classe_material
		and	cm.ie_classe_material_rel in (27,28,29,30,31)
		and	pma.nr_atendimento = c01_w.nr_atendimento) ivc_filter;

	select	CASE WHEN count(1)=0 THEN 'N'  ELSE 'Y' END
	into STRICT	ie_sup_rx_w
	from	prescr_mat_alteracao pma,
		prescr_material pm,
		material m,
		classe_material cm
	where	pm.nr_prescricao = pma.nr_prescricao
	and	m.cd_material = pm.cd_material
	and	(m.cd_medicamento IS NOT NULL AND m.cd_medicamento::text <> '')
	and	m.cd_classe_material = cm.cd_classe_material
	and	cm.ie_classe_material_rel in (23,24,25,26)
	and	pma.nr_atendimento = c01_w.nr_atendimento;

	select	CASE WHEN count(1)=0 THEN 'NA'  ELSE 'Y' END
	into STRICT	ie_hob_w
	from	atendimento_sinal_vital
	where	nr_atendimento = c01_w.nr_atendimento
	and	qt_angulo_cabeceira > 30
	and	(trunc(dt_sinal_vital + (1 / 24) * 12) between trunc(dt_inicial_p) and trunc(dt_final_p)
		or    trunc(dt_sinal_vital - (1 / 24) * 12) between trunc(dt_inicial_p) and trunc(dt_final_p));

	if (ie_hob_w = 'Y') then

		select	max(dt_sinal_vital) dt_hob
		into STRICT	dt_hob_w
		from	atendimento_sinal_vital
		where	nr_atendimento = c01_w.nr_atendimento
		and	qt_angulo_cabeceira > 30
		and	(trunc(dt_sinal_vital + (1 / 24) * 12) between trunc(dt_inicial_p) and trunc(dt_final_p)
			or    trunc(dt_sinal_vital - (1 / 24) * 12) between trunc(dt_inicial_p) and trunc(dt_final_p));

	end if;

	select	CASE WHEN count(1)=0 THEN 'NA'  ELSE 'Y' END
	into STRICT	ie_oral_care_w
	from	tof_meta a,
		tof_meta_atend b
	where	b.nr_seq_meta = a.nr_sequencia
	and	b.nr_atendimento = c01_w.nr_atendimento
	and	b.ie_status = 'A'
	and	a.ie_tipo_rel = 6;

	select	CASE WHEN count(1)=0 THEN ''  ELSE 'NA' END
	into STRICT	ie_extub_eval_w
	from	atendimento_monit_resp
	where	ie_respiracao <> 'VMI'
	and	nr_atendimento = c01_w.nr_atendimento;

	select	CASE WHEN count(1)=0 THEN 'N'  ELSE 'S' END
	into STRICT	ie_sed_holiday_w
	from	vent_management
	where	nr_atendimento = c01_w.nr_atendimento
	and	ie_sedation_holiday = 'S';

	select	coalesce(max(nr_sequencia),0) + 1
	into STRICT	nr_sequencia_w
	from	w_vent_bundle_report;

	insert into w_vent_bundle_report(nr_sequencia,
					nm_usuario,
					dt_atualizacao,
					nr_atendimento,
					cd_pessoa_fisica,
					ie_ivc,
					ie_care_plan,
					dt_care_plan,
					ie_vte_rx,
					ie_sup_rx,
					ie_hob,
					dt_hob,
					ie_extub_eval,
					ie_sed_holiday,
					ie_oral_care)
				values (nr_sequencia_w,
					nm_usuario_p,
					clock_timestamp(),
					c01_w.nr_atendimento,
					c01_w.cd_pessoa_fisica,
					c01_w.ie_ivc,
					ie_care_plan_w,
					dt_care_plan_w,
					ie_vte_rx_w,
					ie_sup_rx_w,
					ie_hob_w,
					dt_hob_w,
					ie_extub_eval_w,
					ie_sed_holiday_w,
					ie_oral_care_w);

	end;
end loop;
close c01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_vent_bundle_report ( nm_usuario_p text, dt_inicial_p timestamp, dt_final_p timestamp, pr_min_margin_p bigint, pr_max_margin_p bigint ) FROM PUBLIC;

