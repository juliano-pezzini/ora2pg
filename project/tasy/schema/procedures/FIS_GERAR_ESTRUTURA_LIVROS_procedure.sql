-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE fis_gerar_estrutura_livros (nm_usuario_p text, nr_seq_estr_calculo_p bigint, ie_lalur_lacs_p text, ie_forma_apuracao_p text) AS $body$
DECLARE


nr_seq_apres_w		smallint;
qt_insert_w		smallint;
nr_seq_pai_w		bigint;

c01 CURSOR FOR
SELECT	b.nr_seq_estrutura,
	b.ds_estrutura,
	b.cd_conta_contabil,
	b.ie_tipo_estrutura,
	b.nr_sequencia
from	fis_estrutura_livros b,
	fis_livros_estr_padrao a
where	b.nr_seq_estrutura = a.nr_sequencia
and	a.ie_tipo_estrutura = 'EP'
and	a.ie_lalur_lacs = ie_lalur_lacs_p
and	coalesce(a.nr_seq_superior::text, '') = ''
and 	a.ie_forma_apuracao = ie_forma_apuracao_p
and	a.ie_situacao = 'A'
and	b.cd_empresa = obter_empresa_estab(wheb_usuario_pck.get_cd_estabelecimento)
order by b.nr_seq_ordem;
c01_w		c01%rowtype;

c02 CURSOR FOR
SELECT	substr(CASE WHEN a.ie_permite_editar='N' THEN ''  ELSE '        ' END  || b.ds_estrutura,1,255) ds_estrutura,
	b.cd_conta_contabil,
	b.ie_tipo_estrutura,
	b.nr_sequencia
from	fis_estrutura_livros b,
	fis_livros_estr_padrao a
where 	b.nr_seq_estrutura = a.nr_sequencia
and	a.nr_seq_superior = c01_w.nr_seq_estrutura
and	b.ie_lalur_lacs = ie_lalur_lacs_p
and 	a.ie_forma_apuracao = ie_forma_apuracao_p
and	b.ie_gerar_estrutura = 'S'
and	b.cd_empresa = obter_empresa_estab(wheb_usuario_pck.get_cd_estabelecimento)
order by b.nr_seq_ordem;
c02_w		c02%rowtype;

c03 CURSOR FOR
SELECT	CASE WHEN rownum=8 THEN  9  ELSE row_number() OVER () AS END  nr_ordem,
	b.nr_seq_estrutura,
	b.ds_estrutura,
	b.cd_conta_contabil,
	b.ie_tipo_estrutura
from	fis_estrutura_livros b,
	fis_livros_estr_padrao a
where	b.nr_seq_estrutura = a.nr_sequencia
and	a.ie_tipo_estrutura = 'EP'
and	a.ie_lalur_lacs = ie_lalur_lacs_p
and	coalesce(a.nr_seq_superior::text, '') = ''
and 	a.ie_forma_apuracao = 'B'
and	a.ie_situacao = 'A'
and	b.ds_estrutura <> 'Deduções'
and	b.cd_empresa = obter_empresa_estab(wheb_usuario_pck.get_cd_estabelecimento)

union

select	8 nr_ordem,
	b.nr_seq_estrutura,
	b.ds_estrutura,
	b.cd_conta_contabil,
	b.ie_tipo_estrutura
from	fis_estrutura_livros b,
	fis_livros_estr_padrao a
where	b.nr_seq_estrutura = a.nr_sequencia
and	a.ie_tipo_estrutura = 'EP'
and	a.ie_lalur_lacs = ie_lalur_lacs_p
and	coalesce(a.nr_seq_superior::text, '') = ''
and 	a.ie_forma_apuracao = 'R'
and	a.ie_situacao = 'A'
and	b.ds_estrutura = 'Deduções'
and	b.cd_empresa = obter_empresa_estab(wheb_usuario_pck.get_cd_estabelecimento)
order by 1;
c03_w	c03%rowtype;

c04 CURSOR FOR
SELECT	c03_w.nr_ordem,
	b.nr_seq_ordem,
	substr(CASE WHEN a.ie_permite_editar='N' THEN ''  ELSE '        ' END  || b.ds_estrutura,1,255) ds_estrutura,
	b.cd_conta_contabil,
	b.ie_tipo_estrutura
from	fis_estrutura_livros b,
	fis_livros_estr_padrao a
where 	b.nr_seq_estrutura = a.nr_sequencia
and	a.nr_seq_superior = c03_w.nr_seq_estrutura
and	b.ie_lalur_lacs = ie_lalur_lacs_p
and 	a.ie_forma_apuracao = 'B'
and	b.ie_gerar_estrutura = 'S'
and	b.cd_empresa = obter_empresa_estab(wheb_usuario_pck.get_cd_estabelecimento)

union

select	c03_w.nr_ordem,
	b.nr_seq_ordem,
	CASE WHEN a.ie_permite_editar='N' THEN ''  ELSE '        ' END  || b.ds_estrutura,
	b.cd_conta_contabil,
	b.ie_tipo_estrutura
from	fis_estrutura_livros b,
	fis_livros_estr_padrao a
where 	b.nr_seq_estrutura = a.nr_sequencia
and	a.nr_seq_superior = c03_w.nr_seq_estrutura
and	b.ie_lalur_lacs = ie_lalur_lacs_p
and 	a.ie_forma_apuracao = 'R'
and	b.ie_gerar_anual = 'S'
and	b.cd_empresa = obter_empresa_estab(wheb_usuario_pck.get_cd_estabelecimento)
order by 1, 2;
c04_w	c04%rowtype;


BEGIN

delete from fis_calculo_estrut where nr_seq_estrut = nr_seq_estr_calculo_p;
delete from fis_estrutura_item where nr_seq_estrutura = nr_seq_estr_calculo_p;

nr_seq_apres_w := 1;
qt_insert_w	:= 0;

open c01;
loop
fetch c01 into
	c01_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	begin

	select	nextval('fis_estrutura_item_seq')
	into STRICT	nr_seq_pai_w
	;

	insert into fis_estrutura_item(
		ds_item,
		ds_observacao,
		ds_origem,
		dt_atualizacao,
		dt_atualizacao_nrec,
		ie_base_adicional,
		ie_base_calculo,
		ie_deducao_base,
		ie_gerar_conta,
		ie_origem_valor,
		ie_resultado,
		nm_usuario,
		nm_usuario_nrec,
		nr_seq_apres,
		nr_seq_estrutura,
		nr_seq_somat,
		nr_sequencia,
		nr_seq_superior,
		ie_tipo_estrutura,
		ie_receita_anual,
		nr_seq_livros)
	values (
		c01_w.ds_estrutura,
		null,
		CASE WHEN c01_w.cd_conta_contabil='' THEN  ''  ELSE '#' || c01_w.cd_conta_contabil || '@' END ,
		clock_timestamp(),
		clock_timestamp(),
		null,
		null,
		null,
		null,
		'MCSE',
		'N',
		nm_usuario_p,
		nm_usuario_p,
		nr_seq_apres_w,
		nr_seq_estr_calculo_p,
		'0',
		nr_seq_pai_w,
		null,
		c01_w.ie_tipo_estrutura,
		'N',
		c01_w.nr_sequencia);

	nr_seq_apres_w := nr_seq_apres_w + 1;

	open c02;
	loop
	fetch c02 into
		c02_w;
	EXIT WHEN NOT FOUND; /* apply on c02 */
		begin

		insert into fis_estrutura_item(
			ds_item,
			ds_observacao,
			ds_origem,
			dt_atualizacao,
			dt_atualizacao_nrec,
			ie_base_adicional,
			ie_base_calculo,
			ie_deducao_base,
			ie_gerar_conta,
			ie_origem_valor,
			ie_resultado,
			nm_usuario,
			nm_usuario_nrec,
			nr_seq_apres,
			nr_seq_estrutura,
			nr_seq_somat,
			nr_sequencia,
			nr_seq_superior,
			ie_tipo_estrutura,
			ie_receita_anual,
			nr_seq_livros)
		values (
			c02_w.ds_estrutura,
			null,
			CASE WHEN c02_w.cd_conta_contabil='' THEN  ''  ELSE '#' || c02_w.cd_conta_contabil || '@' END ,
			clock_timestamp(),
			clock_timestamp(),
			null,
			null,
			null,
			null,
			'MCSE',
			'N',
			nm_usuario_p,
			nm_usuario_p,
			nr_seq_apres_w,
			nr_seq_estr_calculo_p,
			'0',
			nextval('fis_estrutura_item_seq'),
			nr_seq_pai_w,
			c02_w.ie_tipo_estrutura,
			'N',
			c02_w.nr_sequencia);

			nr_seq_apres_w := nr_seq_apres_w + 1;

			qt_insert_w := qt_insert_w + 1;
			if (qt_insert_w > 100) then
				begin
				qt_insert_w := 0;
				commit;
				end;
			end if;
		end;
	end loop;
	close c02;
	commit;
	end;
end loop;
close c01;

commit;

if (ie_forma_apuracao_p = 'R') then
	begin

	nr_seq_apres_w := 1;
	qt_insert_w	:= 0;

	open c03;
	loop
	fetch c03 into
		c03_w;
	EXIT WHEN NOT FOUND; /* apply on c03 */
		begin

		select	nextval('fis_estrutura_item_seq')
		into STRICT	nr_seq_pai_w
		;

		insert into fis_estrutura_item(
			ds_item,
			ds_observacao,
			ds_origem,
			dt_atualizacao,
			dt_atualizacao_nrec,
			ie_base_adicional,
			ie_base_calculo,
			ie_deducao_base,
			ie_gerar_conta,
			ie_origem_valor,
			ie_resultado,
			nm_usuario,
			nm_usuario_nrec,
			nr_seq_apres,
			nr_seq_estrutura,
			nr_seq_somat,
			nr_sequencia,
			nr_seq_superior,
			ie_tipo_estrutura,
			ie_receita_anual)
		values (
			c03_w.ds_estrutura,
			null,
			CASE WHEN c03_w.cd_conta_contabil='' THEN  ''  ELSE '#' || c03_w.cd_conta_contabil || '@' END ,
			clock_timestamp(),
			clock_timestamp(),
			null,
			null,
			null,
			null,
			'S',
			'N',
			nm_usuario_p,
			nm_usuario_p,
			nr_seq_apres_w,
			nr_seq_estr_calculo_p,
			'0',
			nr_seq_pai_w,
			null,
			'R',
			'S');

		nr_seq_apres_w := nr_seq_apres_w + 1;

		open c04;
		loop
		fetch c04 into
			c04_w;
		EXIT WHEN NOT FOUND; /* apply on c04 */
			begin

			insert into fis_estrutura_item(
				ds_item,
				ds_observacao,
				ds_origem,
				dt_atualizacao,
				dt_atualizacao_nrec,
				ie_base_adicional,
				ie_base_calculo,
				ie_deducao_base,
				ie_gerar_conta,
				ie_origem_valor,
				ie_resultado,
				nm_usuario,
				nm_usuario_nrec,
				nr_seq_apres,
				nr_seq_estrutura,
				nr_seq_somat,
				nr_sequencia,
				nr_seq_superior,
				ie_tipo_estrutura,
				ie_receita_anual)
			values (
				c04_w.ds_estrutura,
				null,
				CASE WHEN c04_w.cd_conta_contabil='' THEN  ''  ELSE '#' || c04_w.cd_conta_contabil || '@' END ,
				clock_timestamp(),
				clock_timestamp(),
				null,
				null,
				null,
				null,
				'S',
				'N',
				nm_usuario_p,
				nm_usuario_p,
				nr_seq_apres_w,
				nr_seq_estr_calculo_p,
				'0',
				nextval('fis_estrutura_item_seq'),
				nr_seq_pai_w,
				'R',
				'S');

				nr_seq_apres_w := nr_seq_apres_w + 1;

				qt_insert_w := qt_insert_w + 1;
				if (qt_insert_w > 100) then
					begin
					qt_insert_w := 0;
					commit;
					end;
				end if;
			end;
		end loop;
		close c04;
		commit;
		end;
	end loop;
	close c03;

	commit;
	end;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE fis_gerar_estrutura_livros (nm_usuario_p text, nr_seq_estr_calculo_p bigint, ie_lalur_lacs_p text, ie_forma_apuracao_p text) FROM PUBLIC;

