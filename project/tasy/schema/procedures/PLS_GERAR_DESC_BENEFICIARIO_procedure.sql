-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_gerar_desc_beneficiario ( nr_seq_segurado_preco_p bigint, vl_preco_atual_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint, ie_commit_p text) AS $body$
DECLARE


nr_seq_contrato_w		bigint;
tx_desconto_w			double precision;
nr_seq_regra_desc_w		bigint;
vl_desconto_w			double precision;
vl_preco_nao_subsid_w		double precision	:= 0;
vl_desc_nao_subsid_w		double precision	:= 0;
qt_idade_w			bigint;
cd_pessoa_fisica_w		varchar(10);
nr_seq_tabela_w			bigint;
nr_seq_segurado_w		bigint;
vl_minimo_w			double precision;


BEGIN

tx_desconto_w		:= 0;

begin
select	a.nr_sequencia,
	a.cd_pessoa_fisica,
	a.nr_seq_tabela,
	a.nr_seq_contrato
into STRICT	nr_seq_segurado_w,
	cd_pessoa_fisica_w,
	nr_seq_tabela_w,
	nr_seq_contrato_w
from	pls_segurado a,
	pls_segurado_preco b
where	a.nr_sequencia	= b.nr_seq_segurado
and	b.nr_sequencia	= nr_seq_segurado_preco_p;
exception
	when others then
	nr_seq_segurado_w	:= null;
end;

select	trunc(months_between(clock_timestamp(),dt_nascimento) / 12)
into STRICT	qt_idade_w
from	pessoa_fisica
where	cd_pessoa_fisica	= cd_pessoa_fisica_w;

begin
select	coalesce(vl_preco_nao_subsidiado,0),
	coalesce(vl_minimo,0)
into STRICT	vl_preco_nao_subsid_w,
	vl_minimo_w
from	pls_plano_preco
where	qt_idade_w	>= qt_idade_inicial
and	qt_idade_w	<= qt_idade_final
and	nr_seq_tabela	= nr_seq_tabela_w;
exception
	when others then
	vl_preco_nao_subsid_w	:= 0;
end;

SELECT * FROM pls_obter_regra_desconto(nr_seq_segurado_w, 1, cd_estabelecimento_p, tx_desconto_w, nr_seq_regra_desc_w) INTO STRICT tx_desconto_w, nr_seq_regra_desc_w;

if (coalesce(nr_seq_regra_desc_w,0) <> 0) then
	vl_desconto_w		:= (vl_preco_atual_p * (tx_desconto_w / 100));
	vl_desc_nao_subsid_w	:= (vl_preco_nao_subsid_w * (tx_desconto_w / 100));

	if	((vl_preco_atual_p - vl_desconto_w) < vl_minimo_w) then
		vl_desconto_w	:= vl_preco_atual_p - vl_minimo_w;
	end if;

	update	pls_segurado_preco
	set	vl_desconto			= coalesce(vl_desconto_w,0),
		nr_seq_regra			= nr_seq_regra_desc_w
	where	nr_sequencia			= nr_seq_segurado_preco_p;
end if;

if (coalesce(vl_desc_nao_subsid_w,0) > 0) then
	vl_preco_nao_subsid_w	:= coalesce(vl_preco_nao_subsid_w,0) - coalesce(vl_desc_nao_subsid_w,0);
end if;

if (ie_commit_p = 'S') then
	commit;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_gerar_desc_beneficiario ( nr_seq_segurado_preco_p bigint, vl_preco_atual_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint, ie_commit_p text) FROM PUBLIC;

