-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE cpoe_consist_regra_presc_proce ( nr_atendimento_p bigint, cd_procedimento_p bigint, ie_origem_proced_p bigint, nr_seq_exame_p bigint, nr_seq_proc_interno_p bigint, cd_perfil_p bigint, cd_setor_prescricao_p bigint, cd_material_exame_p text, nm_usuario_p text, dt_prev_execucao_p timestamp, ds_erro_p INOUT text, ds_mensagem_p INOUT text, ie_abortar_p INOUT text ) AS $body$
DECLARE


ds_retorno_w		varchar(1) := 'S';
cd_procedimento_w	procedimento.cd_procedimento%type := cd_procedimento_p;
ie_origem_proced_w	procedimento.ie_origem_proced%type := ie_origem_proced_p;
nr_seq_exame_w		proc_interno.nr_seq_exame_lab%type := nr_seq_exame_p;


BEGIN

select	coalesce(max(ie_forma_consistencia),'X')
into STRICT	ie_abortar_p
from	regra_consiste_prescr_par
where	nr_seq_regra = 177
and		coalesce(cd_perfil,cd_perfil_p)	= cd_perfil_p;

if (coalesce(cd_procedimento_w::text, '') = '') then
	SELECT * FROM Obter_Proc_Tab_Interno(nr_seq_proc_interno_p, null, nr_atendimento_p, 0, cd_procedimento_w, ie_origem_proced_w) INTO STRICT cd_procedimento_w, ie_origem_proced_w;
end if;

if (coalesce(nr_seq_exame_w::text, '') = '') then
	select 	max(nr_seq_exame_lab)
	into STRICT	nr_seq_exame_w
	from  	proc_interno
	where	nr_sequencia = nr_seq_proc_interno_p;
end if;

if (ie_abortar_p <> 'X') then
	SELECT * FROM cpoe_obter_se_proced_lib_presc(cd_procedimento_w, ie_origem_proced_w, nr_seq_exame_w, nr_seq_proc_interno_p, cd_perfil_p, cd_setor_prescricao_p, nm_usuario_p, cd_material_exame_p, nr_atendimento_p, dt_prev_execucao_p, ds_retorno_w, ds_mensagem_p) INTO STRICT ds_retorno_w, ds_mensagem_p;
end if;

if (ds_retorno_w = 'S') then
	ds_erro_p := 'N';
elsif (ds_retorno_w = 'P') then
	ds_erro_p := 'A';
elsif (ds_retorno_w in ('M', 'D', 'J', 'C', 'T')) then
	ds_erro_p := ds_retorno_w;
	
	if (coalesce(ds_mensagem_p::text, '') = '') then
		if (ds_retorno_w = 'T') then
			ds_mensagem_p := obter_desc_expressao(554788, null); -- Quando cair aqui, somente ira avisar, nunca bloquear o exame.
		elsif (ds_retorno_w = 'J') then
			ds_mensagem_p := obter_desc_expressao(620470, null); -- Quando cair aqui, vai informar usuario que falta justificativa, entao para nao permitir salvar, inconsistencia deve estar com valor 'nao libera prescricao'.
		end if;
	
	end if;
else
  	ds_erro_p := 'S';
	if ( coalesce(ds_mensagem_p::text, '') = '') then
		ds_mensagem_p := obter_desc_expressao(554788, null);
	end if;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cpoe_consist_regra_presc_proce ( nr_atendimento_p bigint, cd_procedimento_p bigint, ie_origem_proced_p bigint, nr_seq_exame_p bigint, nr_seq_proc_interno_p bigint, cd_perfil_p bigint, cd_setor_prescricao_p bigint, cd_material_exame_p text, nm_usuario_p text, dt_prev_execucao_p timestamp, ds_erro_p INOUT text, ds_mensagem_p INOUT text, ie_abortar_p INOUT text ) FROM PUBLIC;

