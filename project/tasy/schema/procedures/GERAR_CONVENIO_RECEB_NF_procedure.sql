-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_convenio_receb_nf ( nr_seq_nota_fiscal_p bigint, nr_seq_receb_p bigint, nm_usuario_p text) AS $body$
DECLARE


vl_recebimento_w	double precision;
vl_total_vinculadas_w	double precision;
vl_total_nota_w		double precision;
qt_existe_w		bigint := 0;
ie_vincular_maior_w	varchar(10) := 'N';


BEGIN

ie_vincular_maior_w := obter_param_usuario(27, 260, obter_perfil_ativo, nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento, ie_vincular_maior_w);

begin
select	vl_recebimento
into STRICT	vl_recebimento_w
from	convenio_receb
where	nr_sequencia = nr_seq_receb_p;
exception
when others then
	vl_recebimento_w := 0;
end;

begin
select	sum(a.vl_total_nota)
into STRICT	vl_total_vinculadas_w
from	nota_fiscal a,
	convenio_receb_nf b
where	a.nr_sequencia = b.nr_seq_nota_fiscal
and	b.nr_seq_receb  = nr_seq_receb_p;
exception
when others then
	vl_total_vinculadas_w := 0;
end;

select	sum(vl_total_nota)
into STRICT	vl_total_nota_w
from	nota_fiscal
where	nr_sequencia = nr_seq_nota_fiscal_p;

select	count(*)
into STRICT	qt_existe_w
from	convenio_receb_nf
where	nr_seq_nota_fiscal = nr_seq_nota_fiscal_p;


if	(((coalesce(vl_total_vinculadas_w,0) + vl_total_nota_w) <= vl_recebimento_w) or (ie_vincular_maior_w = 'S')) and (coalesce(qt_existe_w,0) = 0) then
	begin
	insert	into	convenio_receb_nf(
		dt_atualizacao,
		dt_atualizacao_nrec,
		nm_usuario,
		nm_usuario_nrec,
		nr_seq_nota_fiscal,
		nr_seq_receb,
		nr_sequencia)
	values (
		clock_timestamp(),
		clock_timestamp(),
		nm_usuario_p,
		nm_usuario_p,
		nr_seq_nota_fiscal_p,
		nr_seq_receb_p,
		nextval('convenio_receb_nf_seq'));
	end;
elsif	((coalesce(vl_total_vinculadas_w,0) + vl_total_nota_w) > vl_recebimento_w) and (ie_vincular_maior_w = 'N') then
	CALL Wheb_mensagem_pck.exibir_mensagem_abort(190511,'NR_SEQ_NOTA='||nr_seq_nota_fiscal_p);
end if;


commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_convenio_receb_nf ( nr_seq_nota_fiscal_p bigint, nr_seq_receb_p bigint, nm_usuario_p text) FROM PUBLIC;

