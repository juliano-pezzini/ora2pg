-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE valida_nr_acesso_dicom ( nr_acesso_dicom_p text, cd_pessoa_fisica_p text) AS $body$
DECLARE



qt_existente_w		bigint;
cd_pessoa_fisica_w varchar(100);


BEGIN

select	count(*)
into STRICT	qt_existente_w
from	prescr_procedimento p,
	prescr_medica	m
where	p.nr_acesso_dicom 	= nr_acesso_dicom_p
and	p.nr_prescricao		= m.nr_prescricao
and	(m.cd_pessoa_fisica	= cd_pessoa_fisica_p or
	 m.cd_pessoa_fisica	= (SELECT x.cd_pessoa_fisica
		from	pf_codigo_externo x
		where	x.cd_pessoa_fisica_externo = cd_pessoa_fisica_p));


if (qt_existente_w = 0) then
/*IF criado para a integracao com a COLPOX para caso o numero da pessoa fisica
	seja inferior a 90000000 e exista no codigo do sistema antigo.*/
select max(p.cd_pessoa_fisica)
into STRICT cd_pessoa_fisica_w
from pessoa_fisica p
where p.cd_sistema_ant = cd_pessoa_fisica_p;

select count(*)
into STRICT qt_existente_w
from prescr_procedimento p, prescr_medica m, pessoa_fisica a
where p.nr_acesso_dicom = nr_acesso_dicom_p
and p.nr_prescricao = m.nr_prescricao
and a.cd_pessoa_fisica = m.cd_pessoa_fisica
and ((m.cd_pessoa_fisica = cd_pessoa_fisica_w) or (a.cd_sistema_ant = cd_pessoa_fisica_w));

end if;

if (qt_existente_w = 0) then
/*IF criado para a integracao com a GE Caso esteja marcado a opcao de envio de prontuario.*/

select max(p.cd_pessoa_fisica)
into STRICT cd_pessoa_fisica_w
from pessoa_fisica p
where p.NR_PRONTUARIO = cd_pessoa_fisica_p;

select count(*)
into STRICT qt_existente_w
from prescr_procedimento p,
 prescr_medica m,
 pessoa_fisica a
where p.nr_acesso_dicom  = nr_acesso_dicom_p
and p.nr_prescricao  = m.nr_prescricao
and a.cd_pessoa_fisica = m.cd_pessoa_fisica
and ((m.cd_pessoa_fisica = cd_pessoa_fisica_w) or (a.cd_sistema_ant = cd_pessoa_fisica_w));

end if;

if (qt_existente_w = 0) then

	--'Codigo de pessoa fisica '||cd_pessoa_fisica_p||' incompativel com o numero de acesso '||nr_acesso_dicom_p
	CALL wheb_mensagem_pck.exibir_mensagem_abort(264056,'CD_PESSOA_FISICA='||cd_pessoa_fisica_p||';NR_ACESSO_DICOM='||nr_acesso_dicom_p);

end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE valida_nr_acesso_dicom ( nr_acesso_dicom_p text, cd_pessoa_fisica_p text) FROM PUBLIC;

