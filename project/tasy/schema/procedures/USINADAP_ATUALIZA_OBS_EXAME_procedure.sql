-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE usinadap_atualiza_obs_exame ( nr_prescricao_p text, cd_exame_integracao_p text, ds_observacao_p text) AS $body$
DECLARE


nr_seq_prescr_w  integer;
nr_seq_exame_w  bigint;
nr_seq_resultado_w  bigint;
ds_observacao_w  varchar(4000);


BEGIN
ds_observacao_w := substr(ds_observacao_p,1,4000);

select       coalesce(max(a.nr_sequencia),0),
	coalesce(max(a.nr_seq_exame),0)
into STRICT  	nr_seq_prescr_w,
	nr_seq_exame_w
from  	prescr_procedimento a,
	exame_laboratorio b
where      a.nr_seq_exame = b.nr_seq_exame
and 	b.ie_situacao <> 'i'
and 	a.nr_prescricao = nr_prescricao_p
and 	upper(coalesce(b.cd_exame_integracao,b.cd_exame)) = upper(cd_exame_integracao_p);

if  not(nr_seq_prescr_w > 0) then
	CALL gravar_log_tasy(8989,obter_desc_expressao(622766, cd_exame_integracao_p)||to_char(nr_prescricao_p)|| ' #@#@','TASY');
	commit;
end if;

select  MAX(nr_seq_resultado)
into STRICT  	nr_seq_resultado_w
from  	exame_lab_resultado
where  	nr_prescricao = nr_prescricao_p;

update  exame_lab_result_item
set 	ds_observacao = ds_observacao_w
where  	nr_seq_resultado = nr_seq_resultado_w
and 	nr_seq_exame  = nr_seq_exame_w
and 	nr_seq_prescr  = nr_seq_prescr_w;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE usinadap_atualiza_obs_exame ( nr_prescricao_p text, cd_exame_integracao_p text, ds_observacao_p text) FROM PUBLIC;

