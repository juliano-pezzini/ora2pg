-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE sus_consiste_laudo_sismama_cit (nr_seq_laudo_p bigint, nm_usuario_p text) AS $body$
DECLARE

 
ds_detalhe_w			varchar(255)	:= '';
nr_sequencia_w			bigint;
cd_estabelecimento_w 		smallint;
nr_atendimento_w   		bigint;
ie_gravida_amamentando_w	varchar(1);
ie_nodulo_anam_w		varchar(1);
ie_nodulo_w			varchar(1);
ie_risco_cancer_w		varchar(1);
qt_laminas_enviadas_w		double precision;
dt_coleta_w			timestamp;
ie_descarga_papilar_w		varchar(1);
ie_localizacao_w		varchar(10);
ie_localizacao_resul_w		varchar(10);
ie_material_enviado_w		varchar(2);
ie_tipo_material_enviado_w	varchar(2);
ie_tumor_residual_w		varchar(1);
ie_tumor_solido_w		varchar(1);
cd_cgc_laboratorio_w		varchar(14);
ds_insatisfatorio_w		varchar(255);
ds_observacao_w			varchar(255);
ds_outros_cito_malig_w		varchar(120);
ds_outros_positivo_w		varchar(120);
ds_outros_processos_w		varchar(120);
ds_outros_suspeito_w		varchar(120);
dt_liberacao_w			timestamp;
dt_recebimento_w		timestamp;
ie_adequabilidade_w		varchar(1);
ie_padrao_amostra_w		smallint;
ie_padrao_cito_malignidade_w	smallint;
ie_padrao_positivo_w		smallint;
ie_padrao_suspeito_w		smallint;
ie_processos_w			smallint;
nr_exame_w			bigint;
nr_material_recebido_w		bigint;


BEGIN 
 
begin 
select	a.nr_sequencia, 
	a.cd_estabelecimento, 
	a.nr_atendimento 
into STRICT	nr_sequencia_w, 
	cd_estabelecimento_w, 
	nr_atendimento_w 
from	pessoa_fisica 		c, 
	atendimento_paciente 	b, 
	sismama_atendimento	a 
where	a.nr_sequencia 	 	= nr_seq_laudo_p 
and	a.nr_atendimento 	= b.nr_atendimento 
and	b.cd_pessoa_fisica	= c.cd_pessoa_fisica;
exception 
	when others then 
	CALL wheb_mensagem_pck.exibir_mensagem_abort(174941);
	/*'Problemas para obter as informações do atendimento ao consistir o laudo.'*/
 
	end;
 
begin 
select	ie_gravida_amamentando, 
	ie_nodulo, 
	ie_risco_cancer 
into STRICT	ie_gravida_amamentando_w, 
	ie_nodulo_anam_w, 
	ie_risco_cancer_w 
from	sismama_cit_anamnese 
where	nr_seq_sismama = nr_sequencia_w;
exception 
when others then 
	ie_gravida_amamentando_w	:= '0';
	ie_nodulo_anam_w		:= 'X';
	ie_risco_cancer_w		:= '0';
end;	
 
begin 
select	dt_coleta, 
	ie_descarga_papilar, 
	ie_localizacao, 
	ie_material_enviado, 
	ie_nodulo, 
	ie_tipo_material_enviado, 
	ie_tumor_residual, 
	ie_tumor_solido, 
	qt_laminas_enviadas 
into STRICT	dt_coleta_w, 
	ie_descarga_papilar_w, 
	ie_localizacao_w, 
	ie_material_enviado_w, 
	ie_nodulo_w, 
	ie_tipo_material_enviado_w, 
	ie_tumor_residual_w, 
	ie_tumor_solido_w, 
	qt_laminas_enviadas_w 
from	sismama_cit_exame_clinico 
where	nr_seq_sismama = nr_sequencia_w;
exception 
when others then 
	dt_coleta_w			:= null;
	ie_descarga_papilar_w		:= '';
	ie_localizacao_w		:= '';
	ie_material_enviado_w		:= 'X';
	ie_nodulo_w			:= '';
	ie_tipo_material_enviado_w	:= 'X';
	ie_tumor_residual_w		:= '';
	ie_tumor_solido_w		:= '';
	qt_laminas_enviadas_w		:= 0;
end;
 
begin 
select	cd_cgc_laboratorio, 
	ds_insatisfatorio, 
	ds_observacao, 
	ds_outros_cito_malig, 
	ds_outros_positivo, 
	ds_outros_processos, 
	ds_outros_suspeito, 
	dt_liberacao, 
	dt_recebimento, 
	ie_adequabilidade, 
	ie_localizacao, 
	ie_padrao_amostra, 
	ie_padrao_cito_malignidade, 
	ie_padrao_positivo, 
	ie_padrao_suspeito, 
	ie_processos, 
	nr_exame, 
	nr_material_recebido 
into STRICT	cd_cgc_laboratorio_w, 
	ds_insatisfatorio_w, 
	ds_observacao_w, 
	ds_outros_cito_malig_w, 
	ds_outros_positivo_w, 
	ds_outros_processos_w, 
	ds_outros_suspeito_w, 
	dt_liberacao_w, 
	dt_recebimento_w, 
	ie_adequabilidade_w, 
	ie_localizacao_resul_w, 
	ie_padrao_amostra_w, 
	ie_padrao_cito_malignidade_w, 
	ie_padrao_positivo_w, 
	ie_padrao_suspeito_w, 
	ie_processos_w, 
	nr_exame_w, 
	nr_material_recebido_w 
from	sismama_cit_resultados 
where	nr_seq_sismama = nr_sequencia_w;
exception 
when others then 
	cd_cgc_laboratorio_w		:= '';
	ds_insatisfatorio_w		:= '';
	ds_observacao_w			:= '';
	ds_outros_cito_malig_w		:= '';
	ds_outros_positivo_w		:= '';
	ds_outros_processos_w		:= '';
	ds_outros_suspeito_w		:= '';
	dt_liberacao_w			:= null;
	dt_recebimento_w		:= null;
	ie_adequabilidade_w		:= '';
	ie_localizacao_resul_w		:= 'X';
	ie_padrao_amostra_w		:= '';
	ie_padrao_cito_malignidade_w	:= '';
	ie_padrao_positivo_w		:= '';
	ie_padrao_suspeito_w		:= '';
	ie_processos_w			:= '';
	nr_exame_w			:= 0;
	nr_material_recebido_w		:= 0;
end;
 
if (sus_obter_incolaudo_ativa(84)) and (coalesce(ie_material_enviado_w,'X') = 'X') then 
	begin		 
	ds_detalhe_w	:= wheb_mensagem_pck.get_texto(311158,'nr_atendimento_w='||nr_atendimento_w||';'||'nr_seq_sisco_w='||nr_sequencia_w);
	CALL Sus_Laudo_Gravar_Inco(nr_sequencia_w, 84, ds_detalhe_w, cd_estabelecimento_w, nm_usuario_p);
	end;
end if;
 
if (sus_obter_incolaudo_ativa(85)) and (coalesce(ie_tipo_material_enviado_w,'X') = 'X') then 
	begin 
	ds_detalhe_w	:= wheb_mensagem_pck.get_texto(311158,'nr_atendimento_w='||nr_atendimento_w||';'||'nr_seq_sisco_w='||nr_sequencia_w);
	CALL Sus_Laudo_Gravar_Inco(nr_sequencia_w, 85, ds_detalhe_w, cd_estabelecimento_w, nm_usuario_p);
	end;
end if;
 
if (sus_obter_incolaudo_ativa(86)) and (coalesce(ie_localizacao_resul_w,'X') = 'X') then 
	begin 
	ds_detalhe_w	:= wheb_mensagem_pck.get_texto(311158,'nr_atendimento_w='||nr_atendimento_w||';'||'nr_seq_sisco_w='||nr_sequencia_w);
	CALL Sus_Laudo_Gravar_Inco(nr_sequencia_w, 86, ds_detalhe_w, cd_estabelecimento_w, nm_usuario_p);
	end;
end if;
 
if (sus_obter_incolaudo_ativa(87)) and (coalesce(ie_nodulo_anam_w,'X') = 'X') then 
	begin 
	ds_detalhe_w	:= wheb_mensagem_pck.get_texto(311158,'nr_atendimento_w='||nr_atendimento_w||';'||'nr_seq_sisco_w='||nr_sequencia_w);
	CALL Sus_Laudo_Gravar_Inco(nr_sequencia_w, 87, ds_detalhe_w, cd_estabelecimento_w, nm_usuario_p);
	end;
end if;
 
if (sus_obter_incolaudo_ativa(88)) and (coalesce(ie_gravida_amamentando_w,'0') = '0') then 
	begin 
	ds_detalhe_w	:= wheb_mensagem_pck.get_texto(311158,'nr_atendimento_w='||nr_atendimento_w||';'||'nr_seq_sisco_w='||nr_sequencia_w);
	CALL Sus_Laudo_Gravar_Inco(nr_sequencia_w, 88, ds_detalhe_w, cd_estabelecimento_w, nm_usuario_p);
	end;
end if;
 
if (sus_obter_incolaudo_ativa(89)) and (coalesce(ie_risco_cancer_w,'0') = '0') then 
	begin 
	ds_detalhe_w	:= wheb_mensagem_pck.get_texto(311158,'nr_atendimento_w='||nr_atendimento_w||';'||'nr_seq_sisco_w='||nr_sequencia_w);
	CALL Sus_Laudo_Gravar_Inco(nr_sequencia_w, 89, ds_detalhe_w, cd_estabelecimento_w, nm_usuario_p);
	end;
end if;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE sus_consiste_laudo_sismama_cit (nr_seq_laudo_p bigint, nm_usuario_p text) FROM PUBLIC;

