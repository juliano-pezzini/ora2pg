-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_obter_regra_honorario ( ie_tipo_guia_p text, ie_conta_repasse_p text, cd_medico_executor_p text, nr_seq_tipo_atend_p bigint, cd_procedimento_p bigint, ie_origem_proced_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint, nr_seq_prestador_p bigint, nr_seq_prestador_atend_p bigint, ie_regra_p text, ie_tipo_conta_p text, nr_seq_grau_partic_p bigint, dt_referencia_p timestamp, vl_medico_ptu_p bigint, vl_co_ptu_p bigint, vl_material_ptu_p bigint, nr_seq_regra_p INOUT bigint, ie_calcula_valor_p INOUT text, ie_repassa_medico_p INOUT text, ie_medico_ptu_p INOUT text, ie_co_ptu_p INOUT text, ie_material_ptu_p INOUT text, nr_seq_conta_proc_p pls_conta_proc.nr_sequencia%type default null) AS $body$
DECLARE


nr_seq_regra_w			bigint;
ie_calcula_valor_w		varchar(1)	:= 'S';
ie_repassa_medico_w		varchar(1)	:= 'N';
ie_credenciado_w		varchar(1);
cd_grupo_w			bigint;
cd_especialidade_w		integer;
cd_area_w			integer;
ie_estrutura_w			varchar(1);
cd_medico_w			varchar(10)	:= '0';
nr_seq_prestador_w		bigint;
nr_seq_prest_cred_w		bigint;
ie_prest_credenciado_w		varchar(2)	:= 'N';
ie_tipo_relacao_w		varchar(2);
cd_pessoa_fisica_w		varchar(20);
dt_referencia_w			timestamp;
ie_medico_exec_cooperado_W	varchar(255);
nr_seq_tipo_prestador_w		bigint;
ie_tipo_vinculo_w		varchar(1);
ie_cred_regra_w			varchar(1);
nr_seq_regra_aux_w		bigint;
ie_ptu_vl_honorario_w		varchar(1);
ie_ptu_vl_co_w			varchar(1);
ie_ptu_vl_filme_w		varchar(1);
qt_partic_w			integer;

C01 CURSOR FOR
	SELECT	a.nr_sequencia nr_seq_regra,
		a.ie_calcula_valor,
		a.ie_repassa_medico,
		coalesce(b.ie_estrutura,'S') ie_estrutura,
		b.ie_credenciado,
		b.nr_sequencia,
		b.ie_ptu_vl_honorario,
		b.ie_ptu_vl_co,
		b.ie_ptu_vl_filme,
		b.nr_seq_grau_partic
	from	pls_regra_honorario_crit	b,
		pls_regra_honorario		a
	where	a.nr_sequencia			= b.nr_seq_regra
	and	b.cd_estabelecimento 		= cd_estabelecimento_p
	and	a.ie_situacao			= 'A'
	and	((coalesce(b.ie_tipo_guia::text, '') = '') or ( b.ie_tipo_guia =  ie_tipo_guia_p))
	and	((b.ie_credenciado 		= 'T')   or (upper(b.ie_credenciado) 	= upper(ie_credenciado_w)) or (ie_conta_repasse_p = 'S'))
	and	((coalesce(b.nr_seq_tipo_atendimento::text, '') = '') or ( b.nr_seq_tipo_atendimento = nr_seq_tipo_atend_p))
	and	((coalesce(cd_procedimento::text, '') = '') or (cd_procedimento 	= cd_procedimento_p AND ie_origem_proced = ie_origem_proced_p))
	and	((coalesce(cd_grupo_proc::text, '') = '') or (cd_grupo_proc 	=  cd_grupo_w))
	and	((coalesce(cd_especialidade::text, '') = '') or (cd_especialidade	= cd_especialidade_w))
	and	((coalesce(cd_area_procedimento::text, '') = '') or (cd_area_procedimento =  cd_area_w))
	and	((coalesce(b.cd_medico::text, '') = '') or ( b.cd_medico 	= cd_medico_w))
	and	((coalesce(b.nr_seq_prestador::text, '') = '') or ( b.nr_seq_prestador = nr_seq_prestador_w))
	and	((b.ie_tipo_prest_cred		= 'A')   or (b.ie_tipo_prest_cred = coalesce(ie_prest_credenciado_w,b.ie_tipo_prest_cred)))
	and	((coalesce(b.ie_regra::text, '') = '') or (b.ie_regra		= 'A') or (b.ie_regra = ie_regra_p))
	and	((coalesce(b.ie_tipo_relacao::text, '') = '') or (b.ie_tipo_relacao 	= ie_tipo_relacao_w))
	and	((coalesce(b.ie_tipo_conta::text, '') = '') or (b.ie_tipo_conta 	= ie_tipo_conta_p) or (b.ie_tipo_conta = 'T'))
	and	((b.ie_medico_exec_cooperado 	= 'N')   or (ie_medico_exec_cooperado_w = b.ie_medico_exec_cooperado))
	and	((coalesce(b.nr_seq_tipo_prestador::text, '') = '') or (b.nr_seq_tipo_prestador = nr_seq_tipo_prestador_w))
	and	((coalesce(ie_ptu_vl_honorario::text, '') = '') or (ie_ptu_vl_honorario = 'N') or (ie_ptu_vl_honorario = 'S' AND vl_medico_ptu_p > 0))
	and	((coalesce(ie_ptu_vl_co::text, '') = '') or (ie_ptu_vl_co 	= 'N') or (ie_ptu_vl_co = 'S' AND vl_co_ptu_p > 0))
	and	((coalesce(ie_ptu_vl_filme::text, '') = '') or (ie_ptu_vl_filme 	= 'N') or (ie_ptu_vl_filme = 'S' AND vl_material_ptu_p > 0))
	order by
		coalesce(b.cd_procedimento,0),
		coalesce(b.cd_grupo_proc,0),
		coalesce(b.cd_especialidade,0),
		coalesce(b.cd_area_procedimento,0),
		coalesce(b.nr_seq_tipo_atendimento,0),
		b.ie_medico_exec_cooperado,
		b.ie_tipo_relacao desc,
		b.ie_tipo_prest_cred,
		b.ie_credenciado desc,
		coalesce(b.ie_tipo_guia,'0'),
		coalesce(b.ie_tipo_conta,'I'),
		coalesce(b.nr_seq_tipo_prestador,0),
		coalesce(b.nr_seq_prestador,0),
		coalesce(b.cd_medico,'0'),
		b.ie_regra,
		b.ie_estrutura,
		b.ie_ptu_vl_honorario,
		b.ie_ptu_vl_co,
		b.ie_ptu_vl_filme,
		coalesce(nr_seq_grau_partic,0);

BEGIN
if (coalesce(dt_referencia_p::text, '') = '') then
	dt_referencia_w	:= clock_timestamp();
else
	dt_referencia_w	:= dt_referencia_p;
end if;

cd_medico_w		:= coalesce(cd_medico_executor_p,'0');
nr_seq_prestador_w	:= coalesce(nr_seq_prestador_p, 0);

/* Obter se o médico é credenciado na operadora */

ie_credenciado_w	:= pls_obter_se_cred_prestador(nr_seq_prestador_p, nr_seq_prestador_atend_p, dt_referencia_w, cd_medico_w);

ie_medico_exec_cooperado_w := pls_obter_se_cooperado_ativo(cd_medico_w,dt_referencia_w,null);

begin
select 	cd_pessoa_fisica,
	CASE WHEN ie_tipo_vinculo='C' THEN 'S' WHEN ie_tipo_vinculo='V' THEN 'N' END ,
	ie_tipo_relacao,
	nr_seq_tipo_prestador
into STRICT	cd_pessoa_fisica_w,
	ie_prest_credenciado_w,
	ie_tipo_relacao_w,
	nr_seq_tipo_prestador_w
from	pls_prestador
where	nr_sequencia	= nr_seq_prestador_p;
exception
when others then
	ie_prest_credenciado_w	:= '';
	ie_tipo_relacao_w	:= '';
	nr_seq_tipo_prestador_w	:= '';
end;

if (coalesce(cd_pessoa_fisica_w,'0') = '0') then
	ie_prest_credenciado_w	:= null;
else

	if (coalesce(nr_seq_prestador_p,0) > 0) then
		select	max(a.ie_tipo_historico)
		into STRICT 	ie_tipo_vinculo_w
		from	pls_credenciamento_hist a
		where	a.nr_seq_prestador = nr_seq_prestador_p
		and	a.cd_pessoa_fisica 	= cd_pessoa_fisica_w
		and	trunc(a.dt_historico,'dd') > trunc(dt_referencia_w,'dd')
		and	a.dt_historico = (	SELECT max(x.dt_historico)
						from	pls_credenciamento_hist x
						where	x.nr_seq_prestador = nr_seq_prestador_p
						and	x.cd_pessoa_fisica 	= cd_pessoa_fisica_w
						and	trunc(x.dt_historico,'dd') > trunc(dt_referencia_w,'dd'));
		if (ie_tipo_vinculo_w = 'D') then
			ie_prest_credenciado_w	:= 'S';
		elsif (ie_tipo_vinculo_w = 'C') then
			ie_prest_credenciado_w := 'N';
		end if;

	end if;
end if;

/* Obter Estrutura do procedimento */

begin
select	cd_grupo_proc,
	cd_especialidade,
	cd_area_procedimento
into STRICT	cd_grupo_w,
	cd_especialidade_w,
	cd_area_w
from	estrutura_procedimento_v
where	cd_procedimento		= cd_procedimento_p
and	ie_origem_proced	= ie_origem_proced_p;
exception
     	when others then
	begin
	cd_grupo_w		:= 0;
	cd_especialidade_w	:= 0;
	cd_area_w		:= 0;
	end;
end;

for r_c01_w in C01() loop
	begin

	qt_partic_w := 1;
	if (r_C01_w.nr_seq_grau_partic IS NOT NULL AND r_C01_w.nr_seq_grau_partic::text <> '') then
		select	count(1)
		into STRICT	qt_partic_w
		from	pls_proc_participante
		where	nr_seq_conta_proc	= nr_seq_conta_proc_p
		and	nr_seq_grau_partic	= r_C01_w.nr_seq_grau_partic;
	end if;

	if (qt_partic_w > 0) then
		ie_ptu_vl_honorario_w	:= r_c01_w.ie_ptu_vl_honorario;
		ie_ptu_vl_co_w		:= r_c01_w.ie_ptu_vl_co;
		ie_ptu_vl_filme_w	:= r_c01_w.ie_ptu_vl_filme;
		nr_seq_regra_w		:= r_c01_w.nr_seq_regra;
		ie_calcula_valor_w	:= r_c01_w.ie_calcula_valor;
		ie_repassa_medico_w	:= r_c01_w.ie_repassa_medico;

		if (r_c01_w.ie_estrutura	= 'N') then
			ie_ptu_vl_honorario_w	:= null;
			ie_ptu_vl_co_w		:= null;
			ie_ptu_vl_filme_w	:= null;
			nr_seq_regra_w		:= null;
			ie_calcula_valor_w	:= null;
			ie_repassa_medico_w	:= null;
		end if;
	end if;

	end;
end loop;

ie_medico_ptu_p		:= ie_ptu_vl_honorario_w;
ie_co_ptu_p		:= ie_ptu_vl_co_w;
ie_material_ptu_p	:= ie_ptu_vl_filme_w;
nr_seq_regra_p		:= nr_seq_regra_w;
ie_calcula_valor_p	:= ie_calcula_valor_w;
ie_repassa_medico_p	:= ie_repassa_medico_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_obter_regra_honorario ( ie_tipo_guia_p text, ie_conta_repasse_p text, cd_medico_executor_p text, nr_seq_tipo_atend_p bigint, cd_procedimento_p bigint, ie_origem_proced_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint, nr_seq_prestador_p bigint, nr_seq_prestador_atend_p bigint, ie_regra_p text, ie_tipo_conta_p text, nr_seq_grau_partic_p bigint, dt_referencia_p timestamp, vl_medico_ptu_p bigint, vl_co_ptu_p bigint, vl_material_ptu_p bigint, nr_seq_regra_p INOUT bigint, ie_calcula_valor_p INOUT text, ie_repassa_medico_p INOUT text, ie_medico_ptu_p INOUT text, ie_co_ptu_p INOUT text, ie_material_ptu_p INOUT text, nr_seq_conta_proc_p pls_conta_proc.nr_sequencia%type default null) FROM PUBLIC;

