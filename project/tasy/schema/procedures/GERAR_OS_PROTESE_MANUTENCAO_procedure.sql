-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_os_protese_manutencao ( nr_seq_manutencao_p bigint, nm_usuario_p text, nr_nova_os_p INOUT bigint) AS $body$
DECLARE

 
nr_seq_os_w			bigint;				
cd_pessoa_solic_w		varchar(10);
cd_equipamento_w		bigint;
ds_equipamento_w		varchar(255);
ds_localizacao_w		varchar(255);
cd_imobilizado_w		varchar(20);
cd_imobilizado_ext_w		varchar(20);
nr_seq_local_w			bigint;
nr_grupo_planej_w		bigint;
nr_grupo_trab_w			bigint;
ie_prioridade_w			varchar(1);
ie_parado_w			varchar(1);
ie_tipo_ordem_w			bigint;
nr_seq_tipo_os_w		bigint;
ie_classif_os_w			varchar(1);
ds_motivo_w			varchar(100);
ds_justificativa_w		varchar(4000);

nr_seq_planej_w			bigint;
ds_contato_solic_w		varchar(255);
nr_seq_estagio_w		bigint;
nr_seq_origem_dano_w		bigint;
nr_seq_causa_dano_w		bigint;
nr_seq_tipo_solucao_w		bigint;
nr_seq_complex_w		bigint;
nr_seq_cs_w			bigint;

nm_usuario_exec_w		varchar(15);
qt_existe_w			bigint;

dt_inicio_desejado_w		timestamp;
dt_conclusao_desejada_w		timestamp;

c01 CURSOR FOR 
SELECT	nm_usuario_exec 
from	man_equip_usuario_exec 
where	nr_seq_equipamento 					= cd_equipamento_w 
and	coalesce(nr_seq_grupo_trabalho, coalesce(nr_grupo_trab_w,0)) 	= coalesce(nr_grupo_trab_w,0) 
and	coalesce(nr_seq_grupo_planej, coalesce(nr_grupo_planej_w,0)) 	= coalesce(nr_grupo_planej_w,0);


BEGIN 
 
select	nextval('man_ordem_servico_seq') 
into STRICT	nr_seq_os_w
;
 
cd_pessoa_solic_w := substr(obter_pessoa_fisica_usuario(nm_usuario_p,'C'),1,10);
 
select	c.nr_sequencia, 
	c.ds_equipamento, 
	substr(obter_desc_man_localizacao(c.nr_seq_local),1,255) ds_localizacao, 
	c.cd_imobilizado, 
	c.cd_imobilizado_ext, 
	c.nr_seq_local, 
	c.nr_seq_planej, 
	c.nr_seq_trab, 
	coalesce(c.ie_prioridade,'M'), 
	coalesce(c.ie_parado,'N'), 
	coalesce(c.ie_tipo_ordem,1), 
	c.nr_seq_tipo_ordem, 
	c.ie_classificacao_os, 
	a.dt_envio, 
	a.dt_prev_retorno, 
	substr(pb_obter_desc_motivo_manut(a.nr_seq_motivo),1,100) ds_motivo, 
	a.ds_justificativa 
into STRICT	cd_equipamento_w, 
	ds_equipamento_w, 
	ds_localizacao_w, 
	cd_imobilizado_w, 
	cd_imobilizado_ext_w, 
	nr_seq_local_w, 
	nr_grupo_planej_w, 
	nr_grupo_trab_w, 
	ie_prioridade_w, 
	ie_parado_w, 
	ie_tipo_ordem_w, 
	nr_seq_tipo_os_w, 
	ie_classif_os_w, 
	dt_inicio_desejado_w, 
	dt_conclusao_desejada_w, 
	ds_motivo_w, 
	ds_justificativa_w 
from	rp_equip_manutencao a, 
	rp_equipamento b, 
	man_equipamento c 
where	b.nr_sequencia = a.nr_seq_equip 
and	c.nr_sequencia = b.nr_seq_equipamento 
and	a.nr_sequencia = nr_seq_manutencao_p;
 
-- inicializa vari√°veis 
nr_seq_planej_w		:= null;
ds_contato_solic_w	:= null;
nr_seq_estagio_w	:= null;
nr_seq_origem_dano_w	:= null;
nr_seq_causa_dano_w	:= null;
nr_seq_tipo_solucao_w	:= null;
nr_seq_complex_w 	:= null;
nr_seq_cs_w 		:= null;
 
insert	into man_ordem_servico( 
		nr_sequencia, 
		cd_pessoa_solicitante, 
		dt_ordem_servico, 
		ie_prioridade, 
		ie_parado, 
		ds_dano_breve, 
		dt_inicio_desejado, 
		dt_conclusao_desejada, 
		dt_inicio_previsto, 
		dt_fim_previsto, 
		dt_atualizacao, 
		nm_usuario, 
		ds_dano, 
		ie_tipo_ordem, 
		nr_seq_equipamento, 
		nr_seq_localizacao, 
		ie_status_ordem, 
		nr_grupo_planej, 
		nr_grupo_trabalho, 
		ie_origem_os, 
		nr_seq_planej, 
		ds_contato_solicitante, 
		nr_seq_estagio, 
		nr_seq_tipo_ordem, 
		nr_seq_origem_dano, 
		nr_seq_causa_dano, 
		nr_seq_tipo_solucao, 
		nr_seq_complex, 
		nr_seq_cs, 
		ie_classificacao) 
	values (	nr_seq_os_w, 
		cd_pessoa_solic_w, 
		dt_inicio_desejado_w, 
		ie_prioridade_w, 
		ie_parado_w, 
		ds_motivo_w, 
		dt_inicio_desejado_w, 
		dt_conclusao_desejada_w, 
		dt_inicio_desejado_w, 
		dt_conclusao_desejada_w, 
		clock_timestamp(), 
		nm_usuario_p, 
		ds_justificativa_w, 
		ie_tipo_ordem_w, 
		cd_equipamento_w, 
		nr_seq_local_w, 
		'1',		 
		nr_grupo_planej_w, 
		nr_grupo_trab_w,		 
		'4', 
		nr_seq_planej_w, 
		ds_contato_solic_w, 
		nr_seq_estagio_w, 
		nr_seq_tipo_os_w, 
		nr_seq_origem_dano_w, 
		nr_seq_causa_dano_w, 
		nr_seq_tipo_solucao_w, 
		nr_seq_complex_w, 
		nr_seq_cs_w, 
		ie_classif_os_w);
 
open C01;
loop 
fetch C01 into 
	nm_usuario_exec_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin 
 
	select 	count(*) 
	into STRICT	qt_existe_w 
	from 	man_ordem_servico_exec 
	where	nr_seq_ordem	= nr_seq_os_w 
	and	nm_usuario_exec	= nm_usuario_exec_w;
 
	if (qt_existe_w = 0) then 
		insert into man_ordem_servico_exec( 
			nr_sequencia, 
			nr_seq_ordem, 
			dt_atualizacao, 
			nm_usuario, 
			nm_usuario_exec) 
		values (	nextval('man_ordem_servico_exec_seq'), 
			nr_seq_os_w, 
			clock_timestamp(), 
			nm_usuario_p, 
			nm_usuario_exec_w );
	end if;
	end;
end loop;
close C01;
 
commit;
 
nr_nova_os_p := nr_seq_os_w;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_os_protese_manutencao ( nr_seq_manutencao_p bigint, nm_usuario_p text, nr_nova_os_p INOUT bigint) FROM PUBLIC;

