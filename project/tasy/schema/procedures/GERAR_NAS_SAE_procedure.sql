-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_nas_sae ((nr_sequencia_p bigint, nm_usuario_p text) is nr_atendimento_w bigint) RETURNS varchar AS $body$
DECLARE


	ie_retorno_w	varchar(15);
	nr_seq_result_escala_w	varchar(15);
	
BEGIN

	select	max(f.nr_seq_result_escala)
	into STRICT	nr_seq_result_escala_w
	from	pe_prescricao a,
		pe_prescr_item_result b,
		pe_regra_item_escala c,
		pe_regra_result_escala f
	where	a.nr_sequencia = nr_sequencia_p
	and	a.nr_sequencia = b.nr_seq_prescr
	and	b.nr_seq_item = c.nr_seq_item_sae
	and	c.nr_seq_item_escala = nr_seq_item_escala_p
	and	f.nr_seq_result_sae = b.nr_seq_result
	and	f.nr_seq_regra = c.nr_sequencia;

	select 	max(x.vl_result)
	into STRICT	ie_retorno_w
	from	pe_result_item x,
		pe_regra_result_escala f
	where	x.nr_sequencia = nr_seq_result_escala_w;



	return ie_retorno_w;
	end;

begin

select	max(a.cd_prescritor),
	max(a.nr_atendimento)
into STRICT	cd_profissional_w,
	nr_atendimento_w
from	pe_prescricao a,
	pe_prescr_item_result b
where	a.nr_sequencia = b.nr_seq_prescr
and	a.nr_sequencia = nr_sequencia_p;

select	count(*)
into STRICT	qt_reg_w
from 	pe_prescricao a,
	pe_prescr_item_result b,
	pe_regra_item_escala c,
	pe_regra_result_escala d
where	a.nr_sequencia	= b.nr_seq_prescr
and	b.nr_seq_result = d.nr_seq_result_sae
and	b.nr_seq_item	= c.nr_seq_item_sae
and	a.nr_sequencia	= nr_sequencia_p
and	(c.nr_seq_item_escala IS NOT NULL AND c.nr_seq_item_escala::text <> '')
and 	c.ie_escala = 24;

if (qt_reg_w > 0) then
	begin
	if (obter_valor_escala(66) = '1a') then
		ds_item_1a_w := 'S';
	elsif (obter_valor_escala(66) = '1b') then
		ds_item_1b_w := 'S';
	elsif (obter_valor_escala(66) = '1c') then
		ds_item_1c_w := 'S';
	end if;

	if (obter_valor_escala(70) = '4a') then
		ds_item_4a_w := 'S';
	elsif (obter_valor_escala(70) = '4b') then
		ds_item_4b_w := 'S';
	elsif (obter_valor_escala(70) = '4c') then
		ds_item_4c_w := 'S';
	end if;

	if (obter_valor_escala(72) = '6a') then
		ds_item_6a_w := 'S';
	elsif (obter_valor_escala(72) = '6b') then
		ds_item_6b_w := 'S';
	elsif (obter_valor_escala(72) = '6c') then
		ds_item_6c_w := 'S';
	end if;

	if (obter_valor_escala(73) = '7a') then
		ds_item_7a_w := 'S';
	elsif (obter_valor_escala(73) = '7b') then
		ds_item_7b_w := 'S';
	end if;
	end;

	if (obter_valor_escala(74) = '8a') then
		ds_item_8a_w := 'S';
	elsif (obter_valor_escala(74) = '8b') then
		ds_item_8b_w := 'S';
	elsif (obter_valor_escala(74) = '8c') then
		ds_item_8c_w := 'S';
	end if;

	ds_item_2_w 		:=obter_valor_escala(68);
	ds_item_3_w			:=obter_valor_escala(69);
	ds_item_5_w			:=obter_valor_escala(71);
	ds_item_9_w			:=obter_valor_escala(75);
	ds_item_10_w		:=obter_valor_escala(76);
	ds_item_11_w		:=obter_valor_escala(77);
	ds_item_12_w		:=obter_valor_escala(78);
	ds_item_13_w		:=obter_valor_escala(79);
	ds_item_14_w		:=obter_valor_escala(80);
	ds_item_15_w		:=obter_valor_escala(81);
	ds_item_16_w		:=obter_valor_escala(82);
	ds_item_17_w		:=obter_valor_escala(83);
	ds_item_18_w		:=obter_valor_escala(84);
	ds_item_19_w		:=obter_valor_escala(85);
	ds_item_20_w		:=obter_valor_escala(86);
	ds_item_21_w		:=obter_valor_escala(87);
	ds_item_22_w		:=obter_valor_escala(88);
	ds_item_23_w		:=obter_valor_escala(89);

	insert into 	escala_nas(nr_sequencia,
					cd_profissional,
					dt_atualizacao,
					dt_avaliacao,
					ds_item_1a,
					ds_item_1b,
					ds_item_1c,
					ds_item_2,
					ds_item_3,
					ds_item_4a,
					ds_item_4b,
					ds_item_4c,
					ds_item_5,
					ds_item_6a,
					ds_item_6b,
					ds_item_6c,
					ds_item_7a,
					ds_item_7b,
					ds_item_8a,
					ds_item_8b,
					ds_item_8c,
					ds_item_9,
					ds_item_10,
					ds_item_11,
					ds_item_12,
					ds_item_13,
					ds_item_14,
					ds_item_15,
					ds_item_16,
					ds_item_17,
					ds_item_18,
					ds_item_19,
					ds_item_20,
					ds_item_21,
					ds_item_22,
					ds_item_23,
					nm_usuario,
					nr_atendimento,
					ie_situacao,
					dt_liberacao)
		values (	nextval('escala_nas_seq'),
					cd_profissional_w,
					clock_timestamp(),
					clock_timestamp(),
					coalesce(ds_item_1a_w,'N'),
					coalesce(ds_item_1b_w,'N'),
					coalesce(ds_item_1c_w,'N'),
					coalesce(ds_item_2_w,'N'),
					coalesce(ds_item_3_w,'N'),
					coalesce(ds_item_4a_w,'N'),
					coalesce(ds_item_4b_w,'N'),
					coalesce(ds_item_4c_w,'N'),
					coalesce(ds_item_5_w,'N'),
					coalesce(ds_item_6a_w,'N'),
					coalesce(ds_item_6b_w,'N'),
					coalesce(ds_item_6c_w,'N'),
					coalesce(ds_item_7a_w,'N'),
					coalesce(ds_item_7b_w,'N'),
					coalesce(ds_item_8a_w,'N'),
					coalesce(ds_item_8b_w,'N'),
					coalesce(ds_item_8c_w,'N'),
					coalesce(ds_item_9_w,'N'),
					coalesce(ds_item_10_w,'N'),
					coalesce(ds_item_11_w,'N'),
					coalesce(ds_item_12_w,'N'),
					coalesce(ds_item_13_w,'N'),
					coalesce(ds_item_14_w,'N'),
					coalesce(ds_item_15_w,'N'),
					coalesce(ds_item_16_w,'N'),
					coalesce(ds_item_17_w,'N'),
					coalesce(ds_item_18_w,'N'),
					coalesce(ds_item_19_w,'N'),
					coalesce(ds_item_20_w,'N'),
					coalesce(ds_item_21_w,'N'),
					coalesce(ds_item_22_w,'N'),
					coalesce(ds_item_23_w,'N'),
					nm_usuario_p,
					nr_atendimento_w,
					'A',
					clock_timestamp());

end if;

if (coalesce(wheb_usuario_pck.get_ie_commit, 'S') = 'S') then commit; end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_nas_sae ((nr_sequencia_p bigint, nm_usuario_p text) is nr_atendimento_w bigint) FROM PUBLIC;

