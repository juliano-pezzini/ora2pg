-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE hd_descarte_dialisador ( nr_seq_dialisador_p bigint, ie_motivo_descarte_p text, ie_opcao_p text, nm_usuario_p text) AS $body$
DECLARE

 
/*	ie_opcao_p 
		D -> Descartar dialisador 
		E -> Estornar descarte do dialisador 
		U -> Descartar dialisador incrementando reuso 
*/
 
 
ie_motivo_descarte_w	varchar(15);


BEGIN 
 
 
if (ie_opcao_p = 'D') then /* Descarte normal */
 
	update hd_dializador 
	set	ie_status		= 'D', 
		dt_descarte		= clock_timestamp(), 
		ie_motivo_descarte  	= ie_motivo_descarte_p, 
		dt_atualizacao		= clock_timestamp(), 
		nm_usuario		= nm_usuario_p, 
		cd_pf_descarte		= substr(obter_pessoa_fisica_usuario(nm_usuario_p,'C'),1,10) 
	where  nr_sequencia		= nr_seq_dialisador_p;
elsif (ie_opcao_p = 'E') then /* Estorno de descarte */
 
	 
	select	ie_motivo_descarte 
	into STRICT	ie_motivo_descarte_w 
	from	hd_dializador 
	where	nr_sequencia		= nr_seq_dialisador_p;
 
	if (ie_motivo_descarte_w = 'UU') then 
		--Não é possível estornar o descarte de dialisador cadastrado para única utilização. 
		CALL wheb_mensagem_pck.exibir_mensagem_abort(264224);
	else 
		update	hd_dializador 
		set	ie_status		= 'A', 
			dt_descarte		 = NULL, 
			ie_motivo_descarte	 = NULL, 
			dt_atualizacao		= clock_timestamp(), 
			nm_usuario		= nm_usuario_p, 
			cd_pf_descarte		 = NULL 
		where	nr_sequencia		= nr_seq_dialisador_p;
	end if;
elsif (ie_opcao_p = 'U') then /* Descarte de uso único */
 
	update	hd_dializador 
	set	ie_status		= 'D', 
		dt_descarte		= clock_timestamp(), 
		ie_motivo_descarte	= ie_motivo_descarte_p, 
		dt_atualizacao		= clock_timestamp(), 
		nm_usuario		= nm_usuario_p, 
		qt_reuso		= qt_reuso, 
		cd_pf_descarte		= substr(obter_pessoa_fisica_usuario(nm_usuario_p,'C'),1,10) 
	where	nr_sequencia		= nr_seq_dialisador_p;
end if;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE hd_descarte_dialisador ( nr_seq_dialisador_p bigint, ie_motivo_descarte_p text, ie_opcao_p text, nm_usuario_p text) FROM PUBLIC;

