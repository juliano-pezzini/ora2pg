-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gravar_mat_atend_pac_ajuste ( nr_atendimento_p bigint, nr_interno_conta_p bigint, cd_material_p bigint, dt_atendimento_p timestamp, cd_convenio_p bigint, cd_categoria_p text, nr_seq_atepacu_p bigint, nm_usuario_p text, qt_material_p bigint, cd_local_estoque_p bigint, cd_acao_p text, nr_doc_convenio_p text, ie_valor_informado_p text, nr_seq_motivo_p bigint, nr_seq_auditoria_p bigint default null, ie_agrupado_p text DEFAULT NULL, cd_unidade_medida_p text DEFAULT NULL, nr_sequencia_p INOUT bigint DEFAULT NULL, cd_material_tiss_p text default null) AS $body$
DECLARE

 
nr_sequencia_w			bigint;
cd_setor_atendimento_w		integer;
dt_entrada_unidade_w		timestamp;
cd_unidade_medida_w		varchar(30);
cd_acao_w			varchar(1):= '1';
cd_estabelecimento_w		estabelecimento.cd_estabelecimento%type;
cd_estab_logado_w		estabelecimento.cd_estabelecimento%type;
ie_estabelecimento_conta_w	parametro_faturamento.ie_estabelecimento_conta%type;
ie_calcular_mat_auditado_w	parametro_faturamento.ie_calcular_mat_auditado%type;
ie_auditoria_w			material_atend_paciente.ie_auditoria%type;


BEGIN 
 
cd_acao_w:= coalesce(cd_acao_p,'1');
if (qt_material_p < 0) then 
    cd_acao_w:= '2';
end if;
 
select	max(cd_estabelecimento) 
into STRICT	cd_estabelecimento_w 
from	atendimento_paciente 
where	nr_atendimento = nr_atendimento_p;
 
select cd_setor_Atendimento, 
    dt_entrada_unidade 
into STRICT  cd_setor_atendimento_w, 
    dt_entrada_unidade_w 
from  atend_paciente_unidade 
where  nr_seq_interno = nr_seq_atepacu_p;
 
select nextval('material_atend_paciente_seq') 
into STRICT  nr_sequencia_w
;
 
cd_unidade_medida_w	:= cd_unidade_medida_p;
 
if (coalesce(cd_unidade_medida_w::text, '') = '') then 
	select cd_unidade_medida_consumo 
	into STRICT  cd_unidade_medida_w 
	from  material 
	where  cd_material   = cd_material_p;
end if;
 
select	max(wheb_usuario_pck.get_cd_estabelecimento) 
into STRICT	cd_estab_logado_w
;
 
select	coalesce(max(ie_estabelecimento_conta), 'A') 
into STRICT	ie_estabelecimento_conta_w 
from	parametro_faturamento 
where	cd_estabelecimento = cd_estab_logado_w;
 
if (ie_estabelecimento_conta_w = 'L') then 
	cd_estabelecimento_w := cd_estab_logado_w;
end if;
 
select	coalesce(max(ie_calcular_mat_auditado),'S') 
into STRICT	ie_calcular_mat_auditado_w 
from	parametro_faturamento 
where	cd_estabelecimento = cd_estabelecimento_w;
 
ie_auditoria_w	:= 'S';
 
if (coalesce(ie_calcular_mat_auditado_w,'S') = 'N') then 
	ie_auditoria_w	:= 'N';
end if;
 
insert into material_atend_paciente( 
            nr_sequencia, 
            cd_material, 
            dt_atendimento, 
            cd_convenio, 
            cd_categoria, 
            nr_seq_atepacu, 
            cd_setor_atendimento, 
            dt_entrada_unidade, 
            qt_material, 
            cd_local_estoque, 
            dt_Atualizacao, 
            nm_usuario, 
            nr_atendimento, 
            cd_unidade_medida, 
            cd_acao, 
            ie_valor_informado, 
            nr_interno_conta, 
            ie_auditoria, 
            nr_doc_convenio, 
			cd_material_tiss, 
			nr_seq_cor_exec) 
    values (    nr_sequencia_w, 
            cd_material_p, 
            coalesce(dt_atendimento_p,clock_timestamp()), 
            cd_convenio_p, 
            cd_categoria_p, 
            nr_seq_atepacu_p, 
            cd_setor_atendimento_w, 
            dt_entrada_unidade_w, 
            qt_material_p, 
            cd_local_estoque_p, 
            clock_timestamp(), 
            nm_usuario_p, 
            nr_atendimento_p, 
            cd_unidade_medida_w, 
            coalesce(cd_acao_w,'1'), 
            coalesce(ie_valor_informado_p,'N'), 
            nr_interno_conta_p, 
            ie_auditoria_w, -- Se o parâmetro ie_calcular_mat_auditado_w estiver para 'N', insere primeiramente como Não auditado, para atualizar os valores. 
            nr_doc_convenio_p, 
			cd_material_tiss_p, 
			6697);
 
nr_sequencia_p     := nr_sequencia_w;
 
CALL atualiza_preco_material(nr_sequencia_w, nm_usuario_p);
 
if (ie_auditoria_w	= 'N') then 
	update	material_atend_paciente 
	set	ie_auditoria = 'S' 
	where	nr_sequencia = nr_sequencia_w;
end if;
 
CALL Atualizar_Lista_Itens_Audit(nr_interno_conta_p, nr_sequencia_w, 1, qt_material_p, nm_usuario_p,nr_seq_motivo_p, nr_seq_auditoria_p, ie_agrupado_p);
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gravar_mat_atend_pac_ajuste ( nr_atendimento_p bigint, nr_interno_conta_p bigint, cd_material_p bigint, dt_atendimento_p timestamp, cd_convenio_p bigint, cd_categoria_p text, nr_seq_atepacu_p bigint, nm_usuario_p text, qt_material_p bigint, cd_local_estoque_p bigint, cd_acao_p text, nr_doc_convenio_p text, ie_valor_informado_p text, nr_seq_motivo_p bigint, nr_seq_auditoria_p bigint default null, ie_agrupado_p text DEFAULT NULL, cd_unidade_medida_p text DEFAULT NULL, nr_sequencia_p INOUT bigint DEFAULT NULL, cd_material_tiss_p text default null) FROM PUBLIC;

