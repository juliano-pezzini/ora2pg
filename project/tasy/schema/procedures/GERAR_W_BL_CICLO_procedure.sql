-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_w_bl_ciclo ( nr_seq_pasteuriza_p bigint, nm_usuario_p text) AS $body$
DECLARE



ds_comando_w			varchar(4000);
ds_sql_ciclo_cria_w		varchar(2000);
ds_sql_ciclo_w			varchar(2000);
ds_sql_seq_ciclo_cria_w		varchar(2000);
ds_sql_seq_ciclo_w		varchar(2000);
vl_horario_w			varchar(2000);
nr_seq_ciclo_w			bigint;
nr_atributo_w			smallint;
nr_seq_apresent_w		integer;
ie_fase_w			varchar(1);
nr_seq_variavel_w		bigint;
ds_variavel_w			varchar(80);
nr_seq_w_bl_ciclo_w		bigint;
qt_valor_w			real;


C01 CURSOR FOR
	SELECT	distinct
		a.ie_fase,
		a.vl_horario,
		b.nr_seq_apresent
	from	bl_ciclo a,
		bl_regra_ciclo b
	where	a.ie_fase = b.ie_fase
	and	a.nr_seq_pasteurizacao = nr_seq_pasteuriza_p
	and	coalesce(b.ie_situacao,'A') = 'A'
	order by b.nr_seq_apresent, a.vl_horario;

C02 CURSOR FOR
	SELECT 	distinct
		nr_seq_variavel,
		BL_obter_desc_variavel(nr_seq_variavel)
	from	bl_ciclo
	where	nr_seq_pasteurizacao = nr_seq_pasteuriza_p
	order by 1;

C03 CURSOR FOR
	SELECT	a.ie_fase,
		a.nr_sequencia,
		a.qt_valor
	from	bl_ciclo a,
		bl_regra_ciclo b
	where	a.ie_fase = b.ie_fase
	and	a.nr_seq_pasteurizacao 	= nr_seq_pasteuriza_p
	and	coalesce(b.ie_situacao,'A') 	= 'A'
	and	a.nr_seq_variavel	= nr_seq_variavel_w
	order by b.nr_seq_apresent, a.vl_horario;


BEGIN

delete from w_bl_ciclo where nm_usuario = nm_usuario_p;

if (nr_seq_pasteuriza_p IS NOT NULL AND nr_seq_pasteuriza_p::text <> '') then
	vl_horario_w	:= '';
	nr_atributo_w	:= 1;

	--Montar o cabeçalho
	open C01;
	loop
	fetch 	C01 into
		ie_fase_w,
		vl_horario_w,
		nr_seq_apresent_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin
		ds_sql_ciclo_w			:= ds_sql_ciclo_w || chr(39) || vl_horario_w || chr(39) || ',';
		ds_sql_ciclo_cria_w		:= ds_sql_ciclo_cria_w || ' DS_RESULTADO' || nr_atributo_w || ',';

		ds_sql_seq_ciclo_w		:= ds_sql_seq_ciclo_w || chr(39) || '0' || chr(39) || ',';
		ds_sql_seq_ciclo_cria_w		:= ds_sql_seq_ciclo_cria_w || ' NR_SEQ_RESULTADO' || nr_atributo_w || ',';

		nr_atributo_w			:= nr_atributo_w + 1;

		end;
	end loop;
	close C01;

	select	nextval('w_bl_ciclo_seq')
	into STRICT	nr_seq_w_bl_ciclo_w
	;

	ds_comando_w	:= ' insert into w_bl_ciclo (	nr_sequencia,
							ie_fase,
							ie_controle, '||
							ds_sql_ciclo_cria_w||
							ds_sql_seq_ciclo_cria_w||
							'ds_ciclo,
							nm_usuario)
						values('|| nr_seq_w_bl_ciclo_w ||',' ||
							chr(39)||ie_fase_w||chr(39)||',' ||
							chr(39)||'0'||chr(39)||',' ||
							ds_sql_ciclo_w ||
							ds_sql_seq_ciclo_w ||
							chr(39)||wheb_mensagem_pck.get_texto(802296)||chr(39)||',' ||
							chr(39)||nm_usuario_p||chr(39)||') ';

	CALL exec_sql_dinamico('TASY', ds_comando_w);

	--Montar as informações
	open C02;
	loop
	fetch C02 into
		nr_seq_variavel_w,
		ds_variavel_w;
	EXIT WHEN NOT FOUND; /* apply on C02 */
		begin

		ds_sql_ciclo_w		:= '';
		ds_sql_ciclo_cria_w	:= '';
		qt_valor_w		:= '';
		ds_sql_seq_ciclo_w	:= '';
		ds_sql_seq_ciclo_cria_w	:= '';
		nr_atributo_w		:= 1;

		open C03;
		loop
		fetch 	C03 into
			ie_fase_w,
			nr_seq_ciclo_w,
			qt_valor_w;
		EXIT WHEN NOT FOUND; /* apply on C03 */
			begin
			ds_sql_ciclo_w			:= ds_sql_ciclo_w || chr(39) || qt_valor_w || chr(39) || ',';
			ds_sql_ciclo_cria_w		:= ds_sql_ciclo_cria_w || ' DS_RESULTADO' || nr_atributo_w || ',';

			ds_sql_seq_ciclo_w		:= ds_sql_seq_ciclo_w || chr(39) || nr_seq_ciclo_w || chr(39) || ',';
			ds_sql_seq_ciclo_cria_w		:= ds_sql_seq_ciclo_cria_w || ' NR_SEQ_RESULTADO' || nr_atributo_w || ',';

			nr_atributo_w			:= nr_atributo_w + 1;

			end;
		end loop;
		close C03;

		select	nextval('w_bl_ciclo_seq')
		into STRICT	nr_seq_w_bl_ciclo_w
		;

		ds_comando_w	:= ' insert into w_bl_ciclo (	nr_sequencia,
								ie_fase,
								ie_controle, '||
								ds_sql_ciclo_cria_w||
								ds_sql_seq_ciclo_cria_w||
								'ds_ciclo,
								nm_usuario)
							values('||nr_seq_w_bl_ciclo_w||','||
								chr(39)||ie_fase_w||chr(39)||','||
								chr(39)||'1'||chr(39)||','||
								ds_sql_ciclo_w ||
								ds_sql_seq_ciclo_w ||
								chr(39)||ds_variavel_w||chr(39)||','||
								chr(39)||nm_usuario_p||chr(39)||') ';

		CALL exec_sql_dinamico('TASY', ds_comando_w);

		end;
	end loop;
	close C02;
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_w_bl_ciclo ( nr_seq_pasteuriza_p bigint, nm_usuario_p text) FROM PUBLIC;

