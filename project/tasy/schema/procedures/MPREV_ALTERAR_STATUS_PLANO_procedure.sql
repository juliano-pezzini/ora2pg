-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE mprev_alterar_status_plano ( nr_sequencia_p bigint, ie_status_p text, nr_seq_motivo_desvio_p bigint, ds_observacao_p text, nr_seq_canc_ativ_p mprev_partic_canc_ativ.nr_sequencia%type, ie_commit_p text, cd_pessoa_fisica_p text, nm_usuario_p text) AS $body$
DECLARE

			
	ie_motivo_cancelamento_w	    mprev_motivo_desvio_plano.ie_motivo_cancelamento%type;
	ie_situacao_w				          mprev_participante.ie_situacao%type;
	ie_status_cronica_w			      mprev_participante.ie_status_cronica%type;
  ie_gerar_consulta_w	          mprev_motivo_desvio_plano.ie_gerar_consulta%type;
  qt_periodo_consulta_w	        mprev_motivo_desvio_plano.qt_periodo_consulta%type;
  ie_tipo_periodo_w	            mprev_motivo_desvio_plano.ie_tipo_periodo%type;
  new_sequence_w                mprev_motivo_desvio_plano.nr_sequencia%type;
  nr_seq_prog_partic_w          mprev_partic_ciclo_item_v.nr_seq_prog_partic%type;
  dt_prevista_w                 mprev_partic_ciclo_item_v.dt_prevista%type;
  qt_atend_futuro_w             integer;

BEGIN


if (nr_sequencia_p IS NOT NULL AND nr_sequencia_p::text <> '') then

	update	mprev_partic_ciclo_item
	set	ie_status = 'C',
		nr_seq_motivo_desvio = nr_seq_motivo_desvio_p,
		dt_cancelamento = clock_timestamp(),
		dt_atualizacao = clock_timestamp(),
		ds_observacao = ds_observacao_p,
		nr_seq_part_canc_ativ = nr_seq_canc_ativ_p,
		nm_usuario = nm_usuario_p
	where	nr_sequencia = 	nr_sequencia_p;

  if (nr_seq_motivo_desvio_p IS NOT NULL AND nr_seq_motivo_desvio_p::text <> '') then
    select  ie_motivo_cancelamento,
            ie_gerar_consulta,
            qt_periodo_consulta,
            coalesce(ie_tipo_periodo, 'M')
    into STRICT  ie_motivo_cancelamento_w,
          ie_gerar_consulta_w,
          qt_periodo_consulta_w,
          ie_tipo_periodo_w
    from  mprev_motivo_desvio_plano
    where nr_sequencia = nr_seq_motivo_desvio_p;

    if (ie_gerar_consulta_w = 'S') then

      select  nr_seq_prog_partic,
              dt_prevista
      into STRICT  nr_seq_prog_partic_w,
            dt_prevista_w
      from  mprev_partic_ciclo_item_v
      where nr_sequencia = nr_sequencia_p;
	
	  if (obter_cod_dia_semana(dt_prevista_w) = 6) and (ie_tipo_periodo_w = 'D') then
		dt_prevista_w	:= dt_prevista_w + 2;
	  end if;

      select count(1) 
      into STRICT  qt_atend_futuro_w
      from  mprev_partic_ciclo_item_v 
      where ie_status <> 'C'
      and (
          (ie_tipo_periodo_w = 'D' and dt_prevista between(dt_prevista_w + 1) and (dt_prevista_w + qt_periodo_consulta_w)) 
          or (ie_tipo_periodo_w = 'M' and dt_prevista between(dt_prevista_w + 1) and add_months(dt_prevista_w, qt_periodo_consulta_w))
      )
      and nr_seq_prog_partic = nr_seq_prog_partic_w;

      if (qt_atend_futuro_w = 0) then
      
        select nextval('mprev_partic_ciclo_item_seq')
          into STRICT new_sequence_w
;

        insert into mprev_partic_ciclo_item(nr_seq_programa_partic,
                    nr_seq_plano_atend_item,
                    nr_seq_partic_ciclo_atend,
                    nr_seq_part_canc_ativ,
                    nr_seq_motivo_desvio,
                    nr_seq_motivo_agendamento,
                    nr_atend_origem,
                    nr_atendimento_ciclo,
                    nm_usuario_nrec,
                    nm_usuario,
                    ie_status,
                    ie_resultado_visita,
                    ie_origem_atend_prev,
                    ie_forma_atend_prev,
                    ie_cancel_troca_mod,
                    dt_ultimo_contato_sucesso,
                    dt_ultima_tent_contato,
                    dt_prevista,
                    dt_execucao,
                    dt_cancelamento,
                    dt_atualizacao_nrec,
                    dt_atualizacao,
                    ds_observacao,
                    nr_sequencia)
        SELECT  nr_seq_programa_partic,
                nr_seq_plano_atend_item,
                nr_seq_partic_ciclo_atend,
                nr_seq_part_canc_ativ,
                nr_seq_motivo_desvio,
                nr_seq_motivo_agendamento,
                nr_atend_origem,
                nr_atendimento_ciclo,
                nm_usuario_p,
                nm_usuario_p,
                'P',
                ie_resultado_visita,
                ie_origem_atend_prev,
                ie_forma_atend_prev,
                ie_cancel_troca_mod,
                dt_ultimo_contato_sucesso,
                dt_ultima_tent_contato,
                CASE WHEN ie_tipo_periodo_w='D' THEN (dt_prevista_w + qt_periodo_consulta_w)  ELSE add_months(dt_prevista, qt_periodo_consulta_w) END ,
                dt_execucao,
                dt_cancelamento,
                clock_timestamp(),
                clock_timestamp(),
                ds_observacao,
                new_sequence_w
        from  mprev_partic_ciclo_item
        where nr_sequencia = 	nr_sequencia_p;

        insert into mprev_part_cic_item_resp(nr_sequencia,
                    nr_seq_partic_ciclo_item,
                    nr_seq_funcao_colab,
                    nr_seq_equipe,
                    nm_usuario_nrec,
                    nm_usuario,
                    dt_finalizacao,
                    dt_atualizacao_nrec,
                    dt_atualizacao,
                    ds_motivo_repasse,
                    cd_profissional)
        SELECT  nextval('mprev_part_cic_item_resp_seq'),
                new_sequence_w,
                nr_seq_funcao_colab,
                nr_seq_equipe,
                nm_usuario_p,
                nm_usuario_p,
                dt_finalizacao,
                clock_timestamp(),
                clock_timestamp(),
                ds_motivo_repasse,
                cd_profissional
        from  mprev_part_cic_item_resp
        where nr_seq_partic_ciclo_item = nr_sequencia_p;

        insert into mprev_part_cic_item_ativ(nr_sequencia,
                    nr_seq_proc_interno,
                    nr_seq_partic_ciclo_item,
                    nr_seq_ativ_plano_exame,
                    nr_seq_ativ_plano_aval,
                    nr_seq_atividade,
                    nm_usuario_nrec,
                    nm_usuario,
                    ie_gerado_sistema,
                    ie_executado,
                    dt_executado_sistema,
                    dt_atualizacao_nrec,
                    dt_atualizacao)
        SELECT  nextval('mprev_part_cic_item_ativ_seq'),
                nr_seq_proc_interno,
                new_sequence_w,
                nr_seq_ativ_plano_exame,
                nr_seq_ativ_plano_aval,
                nr_seq_atividade,
                nm_usuario_p,
                nm_usuario_p,
                ie_gerado_sistema,
                ie_executado,
                dt_executado_sistema,
                clock_timestamp(),
                clock_timestamp()
        from  mprev_part_cic_item_ativ
        where nr_seq_partic_ciclo_item = nr_sequencia_p;

      end if;

    end if;

    if (ie_motivo_cancelamento_w = '1') then
      ie_situacao_w := 'A';
      ie_status_cronica_w := 'I';
    elsif (ie_motivo_cancelamento_w in ('2','3','5') ) then
      ie_situacao_w := 'S';
      ie_status_cronica_w := 'R';
    elsif (ie_motivo_cancelamento_w = '4') then
      ie_situacao_w := 'I';
      ie_status_cronica_w := 'R';
    end if;

    
    if (ie_situacao_w IS NOT NULL AND ie_situacao_w::text <> '' AND cd_pessoa_fisica_p IS NOT NULL AND cd_pessoa_fisica_p::text <> '') then
      update mprev_participante
      set ie_situacao = ie_situacao_w,
          ie_status_cronica  = ie_status_cronica_w
      where cd_pessoa_fisica = cd_pessoa_fisica_p;
    end if;
  end if;
end if;

if (coalesce(ie_commit_p,'S') = 'S') then
	commit;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE mprev_alterar_status_plano ( nr_sequencia_p bigint, ie_status_p text, nr_seq_motivo_desvio_p bigint, ds_observacao_p text, nr_seq_canc_ativ_p mprev_partic_canc_ativ.nr_sequencia%type, ie_commit_p text, cd_pessoa_fisica_p text, nm_usuario_p text) FROM PUBLIC;

