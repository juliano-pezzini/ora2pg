-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE consistir_item_repasse_tit (nr_seq_procedimento_p bigint, nr_seq_material_p bigint) AS $body$
DECLARE

 
ds_lista_titulo_w		varchar(4000);
nr_interno_conta_w		bigint;
nr_seq_protocolo_w		bigint;
ie_lib_repasse_sem_tit_w	varchar(1)	:= 'S';
nr_seq_lote_protocolo_w		bigint;


BEGIN 
 
ds_lista_titulo_w	:= null;
 
if (nr_seq_procedimento_p IS NOT NULL AND nr_seq_procedimento_p::text <> '') then 
 
	select	max(a.nr_seq_protocolo), 
		max(a.nr_interno_conta), 
		max(c.ie_lib_repasse_sem_tit) 
	into STRICT	nr_seq_protocolo_w, 
		nr_interno_conta_w, 
		ie_lib_repasse_sem_tit_w 
	from	convenio_estabelecimento c, 
		conta_paciente a, 
		procedimento_paciente b 
	where	a.cd_estabelecimento		= c.cd_estabelecimento 
	and	a.cd_convenio_parametro		= c.cd_convenio 
	and	b.nr_interno_conta		= a.nr_interno_conta 
	and	b.nr_sequencia			= nr_seq_procedimento_p;
 
elsif (nr_seq_material_p IS NOT NULL AND nr_seq_material_p::text <> '') then 
 
	select	max(a.nr_seq_protocolo), 
		max(a.nr_interno_conta), 
		max(c.ie_lib_repasse_sem_tit) 
	into STRICT	nr_seq_protocolo_w, 
		nr_interno_conta_w, 
		ie_lib_repasse_sem_tit_w 
	from	convenio_estabelecimento c, 
		conta_paciente a, 
		material_atend_paciente b 
	where	a.cd_estabelecimento		= c.cd_estabelecimento 
	and	a.cd_convenio_parametro		= c.cd_convenio 
	and	b.nr_interno_conta		= a.nr_interno_conta 
	and	b.nr_sequencia			= nr_seq_material_p;
 
end if;
 
if (ie_lib_repasse_sem_tit_w = 'N') then 
 
	select	max(OBTER_TITULO_CONTA_PROTOCOLO(nr_seq_protocolo_w,nr_interno_conta_w)) 
	into STRICT	ds_lista_titulo_w 
	;
	 
	if (coalesce(ds_lista_titulo_w::text, '') = '') then 
		select	max(coalesce(nr_seq_lote_protocolo,0)) 
		into STRICT	nr_seq_lote_protocolo_w 
		from 	protocolo_convenio 
		where	nr_seq_protocolo = nr_seq_protocolo_w;
		 
		select	max(obter_titulo_lote_protocolo(nr_seq_lote_protocolo_w)) 
		into STRICT	ds_lista_titulo_w 
		;
	end if;
	 
 
	if (coalesce(ds_lista_titulo_w::text, '') = '') then 
		/* Existem Contas/Protocolos neste repasse que não possuem título a receber! 
		Protocolo: nr_seq_protocolo_w 
		Conta: nr_interno_conta_w */
 
		CALL wheb_mensagem_pck.exibir_mensagem_abort(262444,	'NR_SEQ_PROTOCOLO_W='||nr_seq_protocolo_w || ';' || 
								'NR_INTERNO_CONTA_W=' || nr_interno_conta_w);
	end if;
 
end if;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE consistir_item_repasse_tit (nr_seq_procedimento_p bigint, nr_seq_material_p bigint) FROM PUBLIC;

