-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE san_gerar_exames_laboratorio (nr_seq_reserva_p bigint, nm_usuario_p text) AS $body$
DECLARE


nr_seq_exame_w		bigint;
nr_atendimento_w	bigint;
nr_prescricao_w		bigint;
nr_seq_prescr_w		integer;
nm_exame_w		varchar(80);
ds_unidade_medida_w	varchar(40);
ds_referencia_w		varchar(4000);
ds_material_w		varchar(50);
ds_resultado_w		varchar(4000);
dt_digitacao_w		timestamp;

C01 CURSOR FOR
	SELECT	distinct
		a.nr_seq_exame
	from	san_derivado_exame_lab a
	where	exists (SELECT	1
			from	san_reserva_item b
			where	b.nr_seq_derivado = a.nr_seq_derivado
			and	b.nr_seq_reserva = nr_seq_reserva_p)
	and	a.ie_situacao = 'A';

C02 CURSOR FOR
	SELECT	b.nm_exame,
		substr(c.ds_unidade_medida,1,15) ds_unidade_medida,
		c.ds_referencia,
		Obter_Material_Exame_Lab(c.nr_seq_material,null,3) ds_material,
		coalesce(coalesce(CASE WHEN c.ds_resultado='0' THEN ''  ELSE CASE WHEN b.ie_formato_resultado='V' THEN ''  ELSE c.ds_resultado END  END ,coalesce(to_char(c.qt_resultado),to_char(CASE WHEN c.pr_resultado=0 THEN ''  ELSE c.pr_resultado END ))),c.ds_resultado) ds_resultado,
		c.dt_digitacao,
		a.nr_sequencia
	from	prescr_procedimento a,
		exame_laboratorio b,
		exame_lab_result_item c,
		exame_lab_resultado d
	where	a.nr_seq_exame = b.nr_seq_exame
	and	a.nr_sequencia = c.nr_seq_prescr
	and 	d.nr_seq_resultado = c.nr_seq_resultado
	and 	a.nr_prescricao = d.nr_prescricao
	and	a.nr_seq_exame = nr_seq_exame_w
	and 	a.nr_prescricao = nr_prescricao_w;
	

BEGIN

delete 	from san_exame_laboratorial
where	nm_usuario = nm_usuario_p;

select	coalesce(max(nr_atendimento),0)
into STRICT	nr_atendimento_w
from	san_reserva
where	nr_sequencia = nr_seq_reserva_p;

open C01;
loop
fetch C01 into	
	nr_seq_exame_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	
	select	max(a.nr_prescricao)
	into STRICT	nr_prescricao_w
	from	prescr_medica a,
		prescr_procedimento b
	where	a.nr_prescricao = b.nr_prescricao
	and	a.nr_atendimento = nr_atendimento_w
	and	b.nr_seq_exame = nr_seq_exame_w
	and exists (	SELECT	1
			from	exame_lab_result_item c,
				exame_lab_resultado d
			where	d.nr_seq_resultado = c.nr_seq_resultado
			and	b.nr_prescricao = d.nr_prescricao
			and	b.nr_sequencia = c.nr_seq_prescr
			and	c.nr_seq_exame = b.nr_seq_exame);
		
	open C02;
	loop
	fetch C02 into	
		nm_exame_w,
		ds_unidade_medida_w,
		ds_referencia_w,
		ds_material_w,
		ds_resultado_w,
		dt_digitacao_w,
		nr_seq_prescr_w;
	EXIT WHEN NOT FOUND; /* apply on C02 */
		begin
		
		insert into san_exame_laboratorial(
			nr_sequencia,
			dt_atualizacao,
			nm_usuario,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			nr_seq_exame,
			nr_prescricao,
			nr_seq_prescricao,
			ds_unidade_medida,
			ds_referencia,
			ds_material,
			ds_resultado,
			dt_referencia,
			nm_exame)
		Values (	nextval('san_exame_laboratorial_seq'),
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			nr_seq_exame_w,
			nr_prescricao_w,
			nr_seq_prescr_w,
			ds_unidade_medida_w,
			ds_referencia_w,
			ds_material_w,
			ds_resultado_w,
			dt_digitacao_w,
			nm_exame_w);
		
		end;
	end loop;
	close C02;
	
	end;
end loop;
close C01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE san_gerar_exames_laboratorio (nr_seq_reserva_p bigint, nm_usuario_p text) FROM PUBLIC;

