-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE ctb_gerar_acomp_padrao ( cd_empresa_p bigint, cd_estab_p bigint, cd_centro_custo_p bigint, ie_tipo_visual_p bigint, ie_tipo_valor_p bigint, nr_seq_mes_inicial_p bigint, nr_seq_mes_final_p bigint, nm_usuario_p text, cd_conta_contabil_p text, ie_consolidar_p text, ie_consolida_holding_p text default 'N') AS $body$
DECLARE


cd_classif_conta_w			varchar(40);
cd_classif_conta_maior_w		varchar(40);
cd_classif_centro_w			varchar(40);
cd_classif_sup_w			varchar(80);
cd_classificacao_w			varchar(80);
cd_conta_contabil_w			varchar(40);
cd_centro_custo_w			bigint;
cd_estabelecimento_w			bigint;
ds_conta_contabil_w			varchar(255);
ds_centro_custo_w			varchar(255);
ie_tipo_centro_w			varchar(1);
ie_tipo_centro_ww			varchar(1);
ds_gerencial_w				varchar(255);
dt_inicial_w				timestamp;
dt_final_w				timestamp;
qt_meses_w				integer;
vl_media_real_w				double precision;
vl_media_w				double precision;
vl_orc_01_w				double precision;
vl_orc_02_w				double precision;
vl_orc_03_w				double precision;
vl_orc_04_w				double precision;
vl_orc_05_w				double precision;
vl_orc_06_w				double precision;
vl_orc_07_w				double precision;
vl_orc_08_w				double precision;
vl_orc_09_w				double precision;
vl_orc_10_w				double precision;
vl_orc_11_w				double precision;
vl_orc_12_w				double precision;
vl_total_w				double precision;
vl_real_01_w				double precision;
vl_real_02_w				double precision;
vl_real_03_w				double precision;
vl_real_04_w				double precision;
vl_real_05_w				double precision;
vl_real_06_w				double precision;
vl_real_07_w				double precision;
vl_real_08_w				double precision;
vl_real_09_w				double precision;
vl_real_10_w				double precision;
vl_real_11_w				double precision;
vl_real_12_w				double precision;
pr_var_01_w				double precision;
pr_var_02_w				double precision;
pr_var_03_w				double precision;
pr_var_04_w				double precision;
pr_var_05_w				double precision;
pr_var_06_w				double precision;
pr_var_07_w				double precision;
pr_var_08_w				double precision;
pr_var_09_w				double precision;
pr_var_10_w				double precision;
pr_var_11_w				double precision;
pr_var_12_w				double precision;
nr_nivel_atual_w			bigint;
nr_nivel_atual_conta_w			bigint;
nr_nivel_classif_w			bigint;
nr_sequencia_w				bigint;
vl_total_real_w				double precision;
vl_variacao_w				double precision;
pr_variacao_w				double precision;
cd_empresa_w				smallint;
vl_variacao_01_w			double precision;
vl_variacao_02_w			double precision;
vl_variacao_03_w			double precision;
vl_variacao_04_w			double precision;
vl_variacao_05_w			double precision;
vl_variacao_06_w			double precision;
vl_variacao_07_w			double precision;
vl_variacao_08_w			double precision;
vl_variacao_09_w			double precision;
vl_variacao_10_w			double precision;
vl_variacao_11_w			double precision;
vl_variacao_12_w			double precision;
nr_nivel_conta_w			bigint;
nr_nivel_centro_w			bigint;
ie_consolidar_w				varchar(2);
ie_separador_conta_w			empresa.ie_sep_classif_conta_ctb%type;
ds_justificativa_w			varchar(2000);

c00 CURSOR FOR
	SELECT	a.cd_classificacao,
		a.cd_centro_custo,
		a.ds_centro_custo,
		a.ie_tipo,
		b.cd_estabelecimento,
		b.cd_empresa
	from	estabelecimento b,
		centro_custo a
	where	a.cd_estabelecimento	= b.cd_estabelecimento
	and	b.cd_empresa		= cd_empresa_p
	and	b.cd_estabelecimento	= coalesce(cd_estab_p,cd_estabelecimento_w)
	and	a.ie_situacao		= 'A'
	and	a.cd_centro_custo	= CASE WHEN ie_tipo_centro_ww='A' THEN cd_centro_custo_p  ELSE CASE WHEN ie_consolidar_w='S' THEN cd_centro_custo_p WHEN ie_consolidar_w='N' THEN a.cd_centro_custo END  END
	and	substr(ctb_obter_se_centro_sup(a.cd_centro_custo, coalesce(cd_classif_centro_w, a.cd_classificacao)),1,1) = 'S'
	and	coalesce(ie_consolida_holding_p,'N') = 'N'
	
union

	SELECT	a.cd_classificacao,
		a.cd_centro_custo,
		a.ds_centro_custo,
		a.ie_tipo,
		b.cd_estabelecimento,
		b.cd_empresa
	from	empresa e,
		estabelecimento b,
		centro_custo a
	where	a.cd_estabelecimento	= b.cd_estabelecimento
	and	b.cd_empresa		= e.cd_empresa
	and	a.ie_situacao		= 'A'
	and	coalesce(ie_consolida_holding_p,'N') = 'S'
	and	exists (	select	1
			from	grupo_empresa y,
				grupo_emp_estrutura x
			where	y.nr_sequencia	= x.nr_seq_grupo
			and	x.cd_empresa	= e.cd_empresa
			and	y.nr_sequencia	= HOLDING_PCK.GET_GRUPO_EMP_USUARIO(cd_empresa_p))
			
	order by
		1 desc;

c01 CURSOR FOR
	SELECT	y.cd_conta_contabil,
		y.cd_classif_sup,
		coalesce(sum(y.vl_orc_01),0) vl_orc_01,
		coalesce(sum(y.vl_orc_02),0) vl_orc_02,
		coalesce(sum(y.vl_orc_03),0) vl_orc_03,
		coalesce(sum(y.vl_orc_04),0) vl_orc_04,
		coalesce(sum(y.vl_orc_05),0) vl_orc_05,
		coalesce(sum(y.vl_orc_06),0) vl_orc_06,
		coalesce(sum(y.vl_orc_07),0) vl_orc_07,
		coalesce(sum(y.vl_orc_08),0) vl_orc_08,
		coalesce(sum(y.vl_orc_09),0) vl_orc_09,
		coalesce(sum(y.vl_orc_10),0) vl_orc_10,
		coalesce(sum(y.vl_orc_11),0) vl_orc_11,
		coalesce(sum(y.vl_orc_12),0) vl_orc_12,
		coalesce(sum(y.vl_real_01),0) vl_real_01,
		coalesce(sum(y.vl_real_02),0) vl_real_02,
		coalesce(sum(y.vl_real_03),0) vl_real_03,
		coalesce(sum(y.vl_real_04),0) vl_real_04,
		coalesce(sum(y.vl_real_05),0) vl_real_05,
		coalesce(sum(y.vl_real_06),0) vl_real_06,
		coalesce(sum(y.vl_real_07),0) vl_real_07,
		coalesce(sum(y.vl_real_08),0) vl_real_08,
		coalesce(sum(y.vl_real_09),0) vl_real_09,
		coalesce(sum(y.vl_real_10),0) vl_real_10,
		coalesce(sum(y.vl_real_11),0) vl_real_11,
		coalesce(sum(y.vl_real_12),0) vl_real_12
	from	w_ctb_orcamento_vis y
	where	y.nm_usuario		= nm_usuario_p
	and	ctb_obter_nivel_classif_conta(y.cd_classif_conta) = nr_nivel_atual_conta_w
	and	((coalesce(cd_conta_contabil_p, '0') = '0') or (substr(ctb_obter_se_conta_filtro(y.cd_conta_contabil,cd_conta_contabil_p,y.cd_classificacao),1,2) = 'S'))
	and	y.cd_centro_custo	= cd_centro_custo_w
	and	y.cd_estabelecimento	= coalesce(cd_estab_p, y.cd_estabelecimento)
	group by
		y.cd_conta_contabil,
		y.cd_classif_sup;


BEGIN


ie_separador_conta_w		:= philips_contabil_pck.get_separador_conta;

ie_consolidar_w		:= coalesce(ie_consolidar_p,'N');

dt_inicial_w	:= ctb_obter_mes_ref(nr_seq_mes_inicial_p);
dt_final_w	:= ctb_obter_mes_ref(nr_seq_mes_final_p);
qt_meses_w	:= trunc(coalesce(months_between(dt_final_w, dt_inicial_w),1)) + 1;

select	max(cd_estabelecimento),
    	max(cd_classificacao),
	    max(ie_tipo)
into STRICT	cd_estabelecimento_w,
	    cd_classif_centro_w,
	    ie_tipo_centro_ww
from	centro_custo
where	cd_centro_custo	= cd_centro_custo_p;


open c00;
loop
fetch c00 into
	cd_classif_centro_w,
	cd_centro_custo_w,
	ds_centro_custo_w,
	ie_tipo_centro_w,
	cd_estabelecimento_w,
	cd_empresa_w;
EXIT WHEN NOT FOUND; /* apply on c00 */
	begin

	if (ie_tipo_centro_w = 'A') then
     
		CALL ctb_gerar_acomp_analitico(	cd_empresa_w,
						cd_estabelecimento_w,
						cd_centro_custo_w,
						ie_tipo_visual_p,
						ie_tipo_valor_p,
						nr_seq_mes_inicial_p,
						nr_seq_mes_final_p,
						nm_usuario_p,
						cd_conta_contabil_p,
						0,
						ie_consolida_holding_p);
		
		cd_classificacao_w	:= substr(cd_classif_centro_w, 1, 255);
		nr_nivel_classif_w	:= ctb_obter_nivel_classif_conta(cd_classificacao_w);
		if (ie_tipo_centro_ww = 'A') then
			nr_nivel_classif_w	:= 0;
		end if;

		ds_gerencial_w		:= substr(lpad(' ',  (nr_nivel_classif_w *3) -4) || ds_centro_custo_w, 1, 255);
		nr_nivel_conta_w := CTB_Obter_Nivel_Classif_Conta(cd_classif_conta_w);
		nr_nivel_centro_w := CTB_Obter_Nivel_Classif_Conta(cd_classificacao_w);

		ds_justificativa_w	:= substr(ctb_obter_justi_orc_periodo(cd_empresa_w, cd_centro_custo_w, cd_conta_contabil_p, dt_inicial_w, dt_final_w),1,255);

		insert into w_ctb_orcamento_vis(
			nr_sequencia,
			dt_atualizacao,
			nm_usuario,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			cd_centro_custo,
			cd_classificacao,
			ds_gerencial,
			cd_estabelecimento,
			nr_nivel_conta,
			nr_nivel_centro,
			ds_justificativa)
		values (	nextval('w_ctb_orcamento_vis_seq'),
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			cd_centro_custo_w,
			cd_classificacao_w,
			ds_gerencial_w,
			cd_estabelecimento_w,
			nr_nivel_conta_w,
			nr_nivel_centro_w,
			ds_justificativa_w);

		select	max(ctb_obter_nivel_classif_conta(cd_classif_conta))
		into STRICT	nr_nivel_atual_conta_w
		from	w_ctb_orcamento_vis
		where	cd_centro_custo	= cd_centro_custo_w
		and	nm_usuario	= nm_usuario_p;


		while(nr_nivel_atual_conta_w > 1) loop
			begin

			open c01;
			loop
			fetch c01 into
				cd_conta_contabil_w,
				cd_classificacao_w,
				vl_orc_01_w,
				vl_orc_02_w,
				vl_orc_03_w,
				vl_orc_04_w,
				vl_orc_05_w,
				vl_orc_06_w,
				vl_orc_07_w,
				vl_orc_08_w,
				vl_orc_09_w,
				vl_orc_10_w,
				vl_orc_11_w,
				vl_orc_12_w,
				vl_real_01_w,
				vl_real_02_w,
				vl_real_03_w,
				vl_real_04_w,
				vl_real_05_w,
				vl_real_06_w,
				vl_real_07_w,
				vl_real_08_w,
				vl_real_09_w,
				vl_real_10_w,
				vl_real_11_w,
				vl_real_12_w;
			EXIT WHEN NOT FOUND; /* apply on c01 */
				begin
				vl_total_real_w := 0;
				vl_variacao_w	:= 0;
				pr_variacao_w	:= 0;

				select	max(cd_conta_contabil)
				into STRICT	cd_conta_contabil_w
				from	conta_contabil
				where	cd_classificacao		= cd_classificacao_w
				and		ie_situacao 			= 'A'
				and		cd_empresa				= cd_empresa_w;

				if (coalesce(cd_conta_contabil_w::text, '') = '') then
					select	max(a.cd_conta_contabil)
					into STRICT	cd_conta_contabil_w
					from	conta_contabil_classif a,
							conta_contabil b
					where	a.cd_classificacao		= cd_classificacao_w
					and		b.ie_situacao 			= 'A'
					and		a.cd_conta_contabil		= b.cd_conta_contabil
					and		b.cd_empresa				= cd_empresa_w;
				end if;


				select	max(ds_conta_contabil)
				into STRICT	ds_conta_contabil_w
				from	conta_contabil
				where	cd_conta_contabil	= cd_conta_contabil_w
				and	ie_situacao 		= 'A'
				and	cd_empresa		= cd_empresa_w;

				cd_classif_conta_w	:= substr(ctb_obter_classif_conta(cd_conta_contabil_w, null, dt_inicial_w),1,40);
				cd_classif_sup_w		:= substr(ctb_obter_classif_conta_sup(cd_classif_conta_w, dt_inicial_w, cd_empresa_p),1,40);



				cd_classificacao_w	:= substr(cd_classif_centro_w || ie_separador_conta_w || cd_classif_conta_w, 1, 255);
				nr_nivel_classif_w	:= ctb_obter_nivel_classif_conta(cd_classificacao_w);
				ds_gerencial_w		:= substr(lpad(' ',  (nr_nivel_classif_w *3) -3) || ds_conta_contabil_w, 1, 255);



				/*Tratar Quando não houve Orçado ou Realizado*/

				select	CASE WHEN vl_orc_01_w=0 THEN  dividir(((vl_real_01_w - vl_orc_01_w) *100), vl_real_01_w)  ELSE dividir(((vl_real_01_w - vl_orc_01_w) *100), vl_orc_01_w) END
				into STRICT	pr_var_01_w
				;


				select	CASE WHEN vl_orc_02_w=0 THEN  dividir(((vl_real_02_w - vl_orc_02_w) *100), vl_real_02_w)  ELSE dividir(((vl_real_02_w - vl_orc_02_w) *100), vl_orc_02_w) END
				into STRICT	pr_var_02_w
				;

				select	CASE WHEN vl_orc_03_w=0 THEN  dividir(((vl_real_03_w - vl_orc_03_w) *100), vl_real_03_w)  ELSE dividir(((vl_real_03_w - vl_orc_03_w) *100), vl_orc_03_w) END
				into STRICT	pr_var_03_w
				;

				select	CASE WHEN vl_orc_04_w=0 THEN  dividir(((vl_real_04_w - vl_orc_04_w) *100), vl_real_04_w)  ELSE dividir(((vl_real_04_w - vl_orc_04_w) *100), vl_orc_04_w) END
				into STRICT	pr_var_04_w
				;

				select	CASE WHEN vl_orc_05_w=0 THEN  dividir(((vl_real_05_w - vl_orc_05_w) *100), vl_real_05_w)  ELSE dividir(((vl_real_05_w - vl_orc_05_w) *100), vl_orc_05_w) END
				into STRICT	pr_var_05_w
				;

				select	CASE WHEN vl_orc_06_w=0 THEN  dividir(((vl_real_06_w - vl_orc_06_w) *100), vl_real_06_w)  ELSE dividir(((vl_real_06_w - vl_orc_06_w) *100), vl_orc_06_w) END
				into STRICT	pr_var_06_w
				;

				select	CASE WHEN vl_orc_07_w=0 THEN  dividir(((vl_real_07_w - vl_orc_07_w) *100), vl_real_07_w)  ELSE dividir(((vl_real_07_w - vl_orc_07_w) *100), vl_orc_07_w) END
				into STRICT	pr_var_07_w
				;

				select	CASE WHEN vl_orc_08_w=0 THEN  dividir(((vl_real_08_w - vl_orc_08_w) *100), vl_real_08_w)  ELSE dividir(((vl_real_08_w - vl_orc_08_w) *100), vl_orc_08_w) END
				into STRICT	pr_var_08_w
				;

				select	CASE WHEN vl_orc_09_w=0 THEN  dividir(((vl_real_09_w - vl_orc_09_w) *100), vl_real_09_w)  ELSE dividir(((vl_real_09_w - vl_orc_09_w) *100), vl_orc_09_w) END
				into STRICT	pr_var_09_w
				;

				select	CASE WHEN vl_orc_10_w=0 THEN  dividir(((vl_real_10_w - vl_orc_10_w) *100), vl_real_10_w)  ELSE dividir(((vl_real_10_w - vl_orc_10_w) *100), vl_orc_10_w) END
				into STRICT	pr_var_10_w
				;

				select	CASE WHEN vl_orc_11_w=0 THEN  dividir(((vl_real_11_w - vl_orc_11_w) *100), vl_real_11_w)  ELSE dividir(((vl_real_11_w - vl_orc_11_w) *100), vl_orc_11_w) END
				into STRICT	pr_var_11_w
				;

				select	CASE WHEN vl_orc_12_w=0 THEN  dividir(((vl_real_12_w - vl_orc_12_w) *100), vl_real_12_w)  ELSE dividir(((vl_orc_12_w - vl_real_12_w) *100), vl_orc_12_w) END
				into STRICT	pr_var_12_w
				;
				qt_meses_w		:= trunc(coalesce(months_between(dt_final_w, dt_inicial_w),1)) + 1;


				select	coalesce(max(nr_sequencia),0)
				into STRICT	nr_sequencia_w
				from	w_ctb_orcamento_vis
				where	cd_classificacao		= cd_classificacao_w
				and	cd_centro_custo		= cd_centro_custo_w
				and	nm_usuario		= nm_usuario_p;

				vl_total_w	:= 0;
				vl_media_w	:= 0;
				vl_media_real_w	:= 0;

				if (ie_tipo_valor_p = 0) then
					vl_total_w	:= 	vl_orc_01_w + vl_orc_02_w + vl_orc_03_w +
								vl_orc_04_w + vl_orc_05_w + vl_orc_06_w +
								vl_orc_07_w + vl_orc_08_w + vl_orc_09_w +
								vl_orc_10_w + vl_orc_11_w + vl_orc_12_w;
				elsif (ie_tipo_valor_p = 1) then
					vl_total_w	:= 	vl_real_01_w + vl_real_02_w + vl_real_03_w +
								vl_real_04_w + vl_real_05_w + vl_real_06_w +
								vl_real_07_w + vl_real_08_w + vl_real_09_w +
								vl_real_10_w + vl_real_11_w + vl_real_12_w;
				elsif (ie_tipo_valor_p in (3,4)) then
					begin
					vl_total_w	:=	vl_orc_01_w + vl_orc_02_w + vl_orc_03_w +
								vl_orc_04_w + vl_orc_05_w + vl_orc_06_w +
								vl_orc_07_w + vl_orc_08_w + vl_orc_09_w +
								vl_orc_10_w + vl_orc_11_w + vl_orc_12_w;
					vl_total_real_w	:= 	vl_real_01_w + vl_real_02_w + vl_real_03_w +
								vl_real_04_w + vl_real_05_w + vl_real_06_w +
								vl_real_07_w + vl_real_08_w + vl_real_09_w +
								vl_real_10_w + vl_real_11_w + vl_real_12_w;
					vl_variacao_w	:=	vl_total_w - vl_total_real_w;
					pr_variacao_w	:=	(dividir(vl_total_real_w - vl_total_w,vl_total_w)*100);
					end;

				end if;

				vl_media_w	:= dividir(vl_total_w, qt_meses_w);
				vl_media_real_w	:= dividir(vl_total_real_w, qt_meses_w);

				vl_variacao_01_w		:= (vl_real_01_w - vl_orc_01_w);
				vl_variacao_02_w		:= (vl_real_02_w - vl_orc_02_w);
				vl_variacao_03_w		:= (vl_real_03_w - vl_orc_03_w);
				vl_variacao_04_w		:= (vl_real_04_w - vl_orc_04_w);
				vl_variacao_05_w		:= (vl_real_05_w - vl_orc_05_w);
				vl_variacao_06_w		:= (vl_real_06_w - vl_orc_06_w);
				vl_variacao_07_w		:= (vl_real_07_w - vl_orc_07_w);
				vl_variacao_08_w		:= (vl_real_08_w - vl_orc_08_w);
				vl_variacao_09_w		:= (vl_real_09_w - vl_orc_09_w);
				vl_variacao_10_w		:= (vl_real_10_w - vl_orc_10_w);
				vl_variacao_11_w		:= (vl_real_11_w - vl_orc_11_w);
				vl_variacao_12_w		:= (vl_real_12_w - vl_orc_12_w);




				if (nr_sequencia_w = 0) then

					nr_nivel_conta_w := CTB_Obter_Nivel_Classif_Conta(cd_classif_conta_w);
					nr_nivel_centro_w := CTB_Obter_Nivel_Classif_Conta(cd_classif_centro_w);

					ds_justificativa_w := substr(ctb_obter_justi_orc_periodo(cd_empresa_p, cd_centro_custo_w, cd_conta_contabil_w, dt_inicial_w, dt_final_w),1,255);

					insert into w_ctb_orcamento_vis(
						nr_sequencia,
						dt_atualizacao,
						nm_usuario,
						dt_atualizacao_nrec,
						nm_usuario_nrec,
						cd_conta_contabil,
						cd_classif_conta,
						cd_classificacao,
						cd_classif_sup,
						ds_gerencial,
						cd_centro_custo,
						vl_orc_01,
						vl_orc_02,
						vl_orc_03,
						vl_orc_04,
						vl_orc_05,
						vl_orc_06,
						vl_orc_07,
						vl_orc_08,
						vl_orc_09,
						vl_orc_10,
						vl_orc_11,
						vl_orc_12,
						vl_total,
						vl_media,
						vl_real_01,
						vl_real_02,
						vl_real_03,
						vl_real_04,
						vl_real_05,
						vl_real_06,
						vl_real_07,
						vl_real_08,
						vl_real_09,
						vl_real_10,
						vl_real_11,
						vl_real_12,
						pr_var_01,
						pr_var_02,
						pr_var_03,
						pr_var_04,
						pr_var_05,
						pr_var_06,
						pr_var_07,
						pr_var_08,
						pr_var_09,
						pr_var_10,
						pr_var_11,
						pr_var_12,
						cd_estabelecimento,
						vl_total_real,
						vl_variacao,
						pr_variacao,
						vl_media_real,
						vl_var_01,
						vl_var_02,
 						vl_var_03,
					 	vl_var_04,
 						vl_var_05,
						vl_var_06,
 						vl_var_07,
 						vl_var_08,
 						vl_var_09,
 						vl_var_10,
 						vl_var_11,
 						vl_var_12,
						nr_nivel_conta,
						nr_nivel_centro,
						ds_justificativa)
					values ( nextval('w_ctb_orcamento_vis_seq'),
						clock_timestamp(),
						nm_usuario_p,
						clock_timestamp(),
						nm_usuario_p,
						cd_conta_contabil_w,
						cd_classif_conta_w,
						cd_classificacao_w,
						cd_classif_sup_w,
						ds_gerencial_w,
						cd_centro_custo_w,
						vl_orc_01_w,
						vl_orc_02_w,
						vl_orc_03_w,
						vl_orc_04_w,
						vl_orc_05_w,
						vl_orc_06_w,
						vl_orc_07_w,
						vl_orc_08_w,
						vl_orc_09_w,
						vl_orc_10_w,
						vl_orc_11_w,
						vl_orc_12_w,
						vl_total_w,
						vl_media_w,
						vl_real_01_w,
						vl_real_02_w,
						vl_real_03_w,
						vl_real_04_w,
						vl_real_05_w,
						vl_real_06_w,
						vl_real_07_w,
						vl_real_08_w,
						vl_real_09_w,
						vl_real_10_w,
						vl_real_11_w,
						vl_real_12_w,
						pr_var_01_w,
						pr_var_02_w,
						pr_var_03_w,
						pr_var_04_w,
						pr_var_05_w,
						pr_var_06_w,
						pr_var_07_w,
						pr_var_08_w,
						pr_var_09_w,
						pr_var_10_w,
						pr_var_11_w,
						pr_var_12_w,
						cd_estabelecimento_w,
						vl_total_real_w,
						vl_variacao_w,
						pr_variacao_w,
						vl_media_real_w,
						vl_variacao_01_w,
						vl_variacao_02_w,
						vl_variacao_03_w,
						vl_variacao_04_w,
						vl_variacao_05_w,
						vl_variacao_06_w,
						vl_variacao_07_w,
						vl_variacao_08_w,
						vl_variacao_09_w,
						vl_variacao_10_w,
						vl_variacao_11_w,
						vl_variacao_12_w,
						nr_nivel_conta_w,
						nr_nivel_centro_w,
						ds_justificativa_w);
				else
					select	vl_total + vl_total_w
					into STRICT	vl_total_w
					from	w_ctb_orcamento_vis
					where	nr_sequencia = nr_sequencia_w
					and	nm_usuario	= nm_usuario_p;

					update	w_ctb_orcamento_vis
					set	vl_orc_01 	= vl_orc_01 + vl_orc_01_w,
						vl_orc_02 	= vl_orc_02 + vl_orc_02_w,
						vl_orc_03 	= vl_orc_03 + vl_orc_03_w,
						vl_orc_04 	= vl_orc_04 + vl_orc_04_w,
						vl_orc_05 	= vl_orc_05 + vl_orc_05_w,
						vl_orc_06 	= vl_orc_06 + vl_orc_06_w,
						vl_orc_07 	= vl_orc_07 + vl_orc_07_w,
						vl_orc_08 	= vl_orc_08 + vl_orc_08_w,
						vl_orc_09 	= vl_orc_09 + vl_orc_09_w,
						vl_orc_10 	= vl_orc_10 + vl_orc_10_w,
						vl_orc_11 	= vl_orc_11 + vl_orc_11_w,
						vl_orc_12 	= vl_orc_12 + vl_orc_12_w,
						vl_real_01 	= vl_real_01 + vl_real_01_w,
						vl_real_02 	= vl_real_02 + vl_real_02_w,
						vl_real_03 	= vl_real_03 + vl_real_03_w,
						vl_real_04 	= vl_real_04 + vl_real_04_w,
						vl_real_05 	= vl_real_05 + vl_real_05_w,
						vl_real_06	= vl_real_06 + vl_real_06_w,
						vl_real_07	= vl_real_07 + vl_real_07_w,
						vl_real_08	= vl_real_08 + vl_real_08_w,
						vl_real_09	= vl_real_09 + vl_real_09_w,
						vl_real_10 	= vl_real_10 + vl_real_10_w,
						vl_real_11 	= vl_real_11 + vl_real_11_w,
						vl_real_12	= vl_real_12 + vl_real_12_w,
						vl_total		= vl_total_w,
						vl_total_real	= vl_total_real_w,
						vl_variacao	= vl_variacao_w,
						pr_variacao	= pr_variacao_w,
						dt_atualizacao	= clock_timestamp(),
						vl_media_real	= vl_media_real_w
					where	nr_sequencia	= nr_sequencia_w
					and	nm_usuario	= nm_usuario_p;
				end if;
				end;
			end loop;
			close c01;

			end; -- begin while.
		nr_nivel_atual_conta_w	:= nr_nivel_atual_conta_w - 1;
		end loop;

		CALL ctb_acumular_saldo_centro(	cd_centro_custo_w,
						cd_classif_centro_w,
						qt_meses_w,
						ie_tipo_valor_p,
						'A',
						nm_usuario_p);
	else
	
		begin
		
		nr_nivel_classif_w	:= ctb_obter_nivel_classif_conta(cd_classif_centro_w);

		/*Somente identar se não for nivel 1*/

		select	CASE WHEN nr_nivel_classif_w=1 THEN  0  ELSE (nr_nivel_classif_w *3) -4 END
		into STRICT	nr_nivel_classif_w
		;
		ds_gerencial_w		:= substr(lpad(' ', nr_nivel_classif_w) || ds_centro_custo_w, 1, 255);

		select	nextval('w_ctb_orcamento_vis_seq')
		into STRICT	nr_sequencia_w
		;


		nr_nivel_conta_w := CTB_Obter_Nivel_Classif_Conta(cd_classif_conta_w);
		nr_nivel_centro_w := ctb_obter_nivel_classif_conta(cd_classif_centro_w);

		ds_justificativa_w := substr(ctb_obter_justi_orc_periodo(cd_empresa_p, cd_centro_custo_w, cd_conta_contabil_w, dt_inicial_w, dt_final_w),1,255);

		insert into w_ctb_orcamento_vis(
			nr_sequencia,
			dt_atualizacao,
			nm_usuario,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			cd_centro_custo,
			cd_classificacao,
			ds_gerencial,
			cd_estabelecimento,
			nr_nivel_conta,
			nr_nivel_centro,
			ds_justificativa)
		values (	nr_sequencia_w,
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			cd_centro_custo_w,
			cd_classif_centro_w,
			ds_gerencial_w,
			cd_estabelecimento_w,
			nr_nivel_conta_w,
			nr_nivel_centro_w,
			ds_justificativa_w);

		CALL ctb_acumular_saldo_centro(	cd_centro_custo_w,
						cd_classif_centro_w,
						qt_meses_w,
						ie_tipo_valor_p,
						'T',
						nm_usuario_p);
		end;

	end if;

	end;
end loop;
close c00;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ctb_gerar_acomp_padrao ( cd_empresa_p bigint, cd_estab_p bigint, cd_centro_custo_p bigint, ie_tipo_visual_p bigint, ie_tipo_valor_p bigint, nr_seq_mes_inicial_p bigint, nr_seq_mes_final_p bigint, nm_usuario_p text, cd_conta_contabil_p text, ie_consolidar_p text, ie_consolida_holding_p text default 'N') FROM PUBLIC;

