-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gpi_consiste_saldo_orc (nr_solic_compra_p solic_compra.nr_solic_compra%type, nr_requisicao_p requisicao_material.nr_requisicao%type, nm_usuario_p text) AS $body$
DECLARE


qt_saldo_w                  bigint;

c01 CURSOR FOR
SELECT b.cd_material,
       b.nr_seq_orc_item_gpi,
       e.ds_projeto, 
       coalesce(b.qt_material,0) qt_material
from   gpi_projeto e,
       gpi_orcamento d,
       gpi_orc_item c,
       solic_compra_item b,
       solic_compra a
where  a.nr_solic_compra = b.nr_solic_compra
and    b.nr_seq_orc_item_gpi = c.nr_sequencia
and    c.nr_seq_orcamento = d.nr_sequencia
and    d.nr_seq_projeto = e.nr_sequencia
and    (b.nr_seq_orc_item_gpi IS NOT NULL AND b.nr_seq_orc_item_gpi::text <> '')
and    (nr_solic_compra_p IS NOT NULL AND nr_solic_compra_p::text <> '')
and    a.nr_solic_compra = nr_solic_compra_p

union all

select b.cd_material,
       b.nr_seq_orc_item_gpi,   
       e.ds_projeto, 
       coalesce(b.qt_material_requisitada,0) qt_material
from   gpi_projeto e,
       gpi_orcamento d,
       gpi_orc_item c,
       item_Requisicao_material b,
       requisicao_material a
where  a.nr_requisicao = b.nr_requisicao
and    b.nr_seq_orc_item_gpi = c.nr_sequencia
and    c.nr_seq_orcamento = d.nr_sequencia
and    d.nr_seq_projeto = e.nr_sequencia
and    (b.nr_seq_orc_item_gpi IS NOT NULL AND b.nr_seq_orc_item_gpi::text <> '')
and    (nr_requisicao_p IS NOT NULL AND nr_requisicao_p::text <> '')
and    a.nr_requisicao = nr_requisicao_p;


BEGIN

for c01_w in c01 loop
    begin
          qt_saldo_w := gpi_obter_saldo_disp_orc(null,null,c01_w.nr_seq_orc_item_gpi,null,null);
         if (c01_w.qt_material > qt_saldo_w) then

            if (nr_solic_compra_p IS NOT NULL AND nr_solic_compra_p::text <> '') then
                CALL gravar_solic_compra_consist(nr_solic_compra_p => nr_solic_compra_p,
                                            ie_tipo_p => '0',
                                            ds_consistencia_p => wheb_mensagem_pck.get_texto(1118307, 'CD_MATERIAL_W=' || c01_w.cd_material || ';DS_PROJETO_W=' || c01_w.ds_projeto),
                                            ie_forma_p => 'C',
                                            ds_observacao_p => wheb_mensagem_pck.get_texto(1118312, 'DS_MATERIAL_W=' || obter_desc_material(c01_w.cd_material) ||
                                                                                                    ';DS_PROJETO_W=' || c01_w.ds_projeto ||
                                                                                                    ';QT_SALDO_W='   || qt_saldo_w ||
                                                                                                    ';QT_MATERIAL_W='|| c01_w.qt_material),
                                            nm_usuario_p => nm_usuario_p);

            elsif (nr_requisicao_p IS NOT NULL AND nr_requisicao_p::text <> '') then
                CALL gravar_consistencia_requisicao( nr_requisicao_p => nr_requisicao_p,
                                                cd_material_p => c01_w.cd_material,
                                                ie_tipo_p => '1',
                                                ds_consistencia_p => wheb_mensagem_pck.get_texto(1118353, 'CD_MATERIAL_W=' || c01_w.cd_material || ';DS_PROJETO_W=' || c01_w.ds_projeto),
                                                ie_forma_p => 'C',
                                                ds_observacao_p => wheb_mensagem_pck.get_texto(1118355, 'DS_MATERIAL_W=' || obter_desc_material(c01_w.cd_material) ||
                                                                                                    ';DS_PROJETO_W=' || c01_w.ds_projeto ||
                                                                                                    ';QT_SALDO_W='   || qt_saldo_w ||
                                                                                                    ';QT_MATERIAL_W='|| c01_w.qt_material),
                                                nm_usuario_p => nm_usuario_p);
                  end if;
         end if;
    end;
end loop;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gpi_consiste_saldo_orc (nr_solic_compra_p solic_compra.nr_solic_compra%type, nr_requisicao_p requisicao_material.nr_requisicao%type, nm_usuario_p text) FROM PUBLIC;

