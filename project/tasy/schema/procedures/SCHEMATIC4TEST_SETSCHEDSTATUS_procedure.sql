-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE schematic4test_setschedstatus (NR_SEQ_SCHEDULE_P bigint) AS $body$
DECLARE

IE_STATUS_W bigint;
IE_STATUS_W2 bigint;
IE_STATUS_W3 bigint;
IE_STATUS_W4 bigint;
IE_STATUS_W5 bigint;
IE_STATUS_W7 bigint;
NR_SEQ_PACKAGEW bigint;
COUNTERPW bigint;
QTD_OSW bigint;
QTD_OSW2 bigint;
QTD_OSW3 bigint;
QTD_OSW4 bigint;
QTD_OSW5 bigint;
QTD_OSW6 bigint;
QTD_GRUPO_FAIL_W bigint;
QTD_FAIL_W1 bigint;
QTD_FAIL_W2 bigint;
QTD_FAIL_W3 bigint;


BEGIN
  --procedure that set status in schedule and if get SO set by rules
  UPDATE SCHEM_TEST_SCHEDULE SET DT_EXECUTION = clock_timestamp() WHERE NR_SEQUENCIA = NR_SEQ_SCHEDULE_P AND IE_STATUS IN ('3','4','5') AND coalesce(DT_EXECUTION::text, '') = '';

  SELECT COUNT(IE_STATUS) IE_STATUS
      INTO STRICT IE_STATUS_W
  FROM SCHEM_TEST_LOG 
  WHERE NR_SEQ_SCHEDULE = NR_SEQ_SCHEDULE_P 
  AND IE_STATUS LIKE '2';

	IF (IE_STATUS_W <> 0) THEN
	   UPDATE SCHEM_TEST_SCHEDULE SET IE_STATUS = '3' WHERE NR_SEQUENCIA = NR_SEQ_SCHEDULE_P;
  ELSE
		SELECT COUNT(IE_STATUS) IE_STATUS
        INTO STRICT IE_STATUS_W2
    FROM SCHEM_TEST_LOG 
    WHERE NR_SEQ_SCHEDULE = NR_SEQ_SCHEDULE_P 
    AND IE_STATUS LIKE '4';

    IF (IE_STATUS_W2 <> 0) THEN
        UPDATE SCHEM_TEST_SCHEDULE SET IE_STATUS = '4' WHERE NR_SEQUENCIA = NR_SEQ_SCHEDULE_P;	
    ELSE
        UPDATE SCHEM_TEST_SCHEDULE SET IE_STATUS = '5' WHERE NR_SEQUENCIA = NR_SEQ_SCHEDULE_P;	
    END IF;		
  END IF;

  SELECT DISTINCT NR_SEQ_PACKAGE
      INTO STRICT NR_SEQ_PACKAGEW 
  FROM SCHEM_TEST_SCHEDULE 
  WHERE NR_SEQUENCIA = NR_SEQ_SCHEDULE_P 
  AND (NR_SEQ_PACKAGE IS NOT NULL AND NR_SEQ_PACKAGE::text <> '');

  SELECT COUNT(NR_SEQUENCIA)
     INTO STRICT IE_STATUS_W3 
  FROM SCHEM_TEST_SCHEDULE 
  WHERE NR_SEQ_PACKAGE = NR_SEQ_PACKAGEW
  AND IE_STATUS IN ('2','1','7','10')
  AND IE_JOBS NOT IN ('1','2')
  AND (NR_SEQ_PACKAGE IS NOT NULL AND NR_SEQ_PACKAGE::text <> '');

  IF (IE_STATUS_W3 = 0) THEN
      SELECT COUNT(NR_SEQUENCIA)
        INTO STRICT IE_STATUS_W4 
      FROM SCHEM_TEST_SCHEDULE 
      WHERE NR_SEQ_PACKAGE = NR_SEQ_PACKAGEW 
      AND IE_STATUS = '3'
      AND IE_JOBS NOT IN ('1','2')
      AND (NR_SEQ_PACKAGE IS NOT NULL AND NR_SEQ_PACKAGE::text <> '');

      IF (IE_STATUS_W4 <> 0) THEN      
          UPDATE SCHEM_TEST_PACKAGE_SCHED SET IE_STATUS = '3' WHERE NR_SEQUENCIA = NR_SEQ_PACKAGEW;
      ELSE
          SELECT COUNT(NR_SEQUENCIA)
            INTO STRICT IE_STATUS_W7 
          FROM SCHEM_TEST_SCHEDULE 
          WHERE NR_SEQ_PACKAGE = NR_SEQ_PACKAGEW 
          AND IE_STATUS = '4'
          AND IE_JOBS NOT IN ('1','2')    
          AND (NR_SEQ_PACKAGE IS NOT NULL AND NR_SEQ_PACKAGE::text <> '');

          IF (IE_STATUS_W7 <> 0) THEN
            UPDATE SCHEM_TEST_PACKAGE_SCHED SET IE_STATUS = '4' WHERE NR_SEQUENCIA = NR_SEQ_PACKAGEW;
          END IF;
      END IF;
        SELECT COUNT(NR_SEQUENCIA)
          INTO STRICT IE_STATUS_W5 
        FROM SCHEM_TEST_SCHEDULE 
        WHERE NR_SEQ_PACKAGE = NR_SEQ_PACKAGEW
        AND IE_STATUS IN ('2','1','7','10')
        AND IE_JOBS NOT IN ('1','2')
        AND NM_USUARIO_NREC LIKE 'Auto Robot'
        AND (NR_SEQ_PACKAGE IS NOT NULL AND NR_SEQ_PACKAGE::text <> '');

        IF (IE_STATUS_W5 = 0) THEN
          UPDATE SCHEM_TEST_PACKAGE_SCHED SET DT_EXECUTION = clock_timestamp() WHERE NR_SEQUENCIA = NR_SEQ_PACKAGEW AND coalesce(DT_EXECUTION::text, '') = '';
        END IF;
  END IF;

  SELECT COUNT(NR_SEQUENCIA) QTD_OS
        INTO STRICT QTD_OSW2
   FROM SCHEM_TEST_OS 
   WHERE NR_SEQ_PACK_SCHED = NR_SEQ_PACKAGEW 
  AND DS_SEVERIDADE LIKE 'S1'
  AND IE_SITUACAO LIKE 'A';
  
   SELECT COUNT(NR_SEQUENCIA) QTD_OS
        INTO STRICT QTD_OSW3
   FROM SCHEM_TEST_OS 
   WHERE NR_SEQ_PACK_SCHED = NR_SEQ_PACKAGEW 
  AND DS_SEVERIDADE LIKE 'S2'
  AND IE_SITUACAO LIKE 'A';
   
  IF (QTD_OSW2 = 0) AND (QTD_OSW3 = 0) THEN         
      SELECT COUNT(NR_SEQUENCIA)
        INTO STRICT COUNTERPW
      FROM SCHEM_TEST_SCHEDULE
      WHERE NR_SEQ_PACKAGE = NR_SEQ_PACKAGEW 
      AND IE_STATUS IN ('1','2','5','6','7','10')
      AND IE_JOBS NOT IN ('1','2');

      IF (COUNTERPW = 0) THEN
        SELECT COUNT(NR_SEQUENCIA) QTD_OS
          INTO STRICT QTD_OSW4
        FROM SCHEM_TEST_OS 
        WHERE NR_SEQ_PACK_SCHED = NR_SEQ_PACKAGEW 
        AND DS_SEVERIDADE LIKE 'S3'
        AND IE_SITUACAO LIKE 'A';
  
        SELECT COUNT(NR_SEQUENCIA) QTD_OS
            INTO STRICT QTD_OSW5
        FROM SCHEM_TEST_OS 
        WHERE NR_SEQ_PACK_SCHED = NR_SEQ_PACKAGEW 
        AND DS_SEVERIDADE LIKE 'S4'
        AND IE_SITUACAO LIKE 'A';
        
        SELECT COUNT(NR_SEQUENCIA) QTD_OS
            INTO STRICT QTD_OSW6
        FROM SCHEM_TEST_OS 
        WHERE NR_SEQ_PACK_SCHED = NR_SEQ_PACKAGEW 
        AND DS_SEVERIDADE LIKE 'S5'
        AND IE_SITUACAO LIKE 'A';
  
        IF (QTD_OSW4 <> 0) OR (QTD_OSW5 <> 0) OR (QTD_OSW6 <> 0) THEN
            SELECT COUNT(NR_SEQUENCIA) QTD_GRURPO_FAIL 
                INTO STRICT QTD_GRUPO_FAIL_W
            FROM SCHEM_TEST_PACKAGE_SCHED 
            WHERE NR_SEQUENCIA = NR_SEQ_PACKAGEW
            AND IE_STATUS = '3';
           
            SELECT COUNT(NR_SEQUENCIA) NR_SEQUENCIA
              INTO STRICT QTD_FAIL_W1
            FROM SCHEM_TEST_LOG WHERE IE_STATUS = '2' 
            AND NR_SEQ_SCHEDULE IN (SELECT NR_SEQUENCIA   
            FROM SCHEM_TEST_SCHEDULE 
            WHERE NR_SEQ_PACKAGE = NR_SEQ_PACKAGEW
            AND IE_STATUS = '3'
            AND coalesce(IE_MANUAL::text, '') = ''
            AND IE_JOBS NOT IN ('1','2'))
            AND NR_SEQ_SCRIPT IN (SELECT DISTINCT NR_SEQ_SCRIPT FROM SCHEM_TEST_OS WHERE NR_SEQ_PACK_SCHED = NR_SEQ_PACKAGEW AND DS_SEVERIDADE LIKE 'S1' AND IE_SITUACAO LIKE 'A');

            SELECT COUNT(NR_SEQUENCIA) NR_SEQUENCIA
              INTO STRICT QTD_FAIL_W2
            FROM SCHEM_TEST_LOG WHERE IE_STATUS = '2' 
            AND NR_SEQ_SCHEDULE IN (SELECT NR_SEQUENCIA   
            FROM SCHEM_TEST_SCHEDULE 
            WHERE NR_SEQ_PACKAGE = NR_SEQ_PACKAGEW
            AND IE_STATUS = '3'
            AND coalesce(IE_MANUAL::text, '') = ''
            AND IE_JOBS NOT IN ('1','2'))
            AND NR_SEQ_SCRIPT IN (SELECT DISTINCT NR_SEQ_SCRIPT FROM SCHEM_TEST_OS WHERE NR_SEQ_PACK_SCHED = NR_SEQ_PACKAGEW AND DS_SEVERIDADE LIKE 'S2' AND IE_SITUACAO LIKE 'A');

            IF (QTD_GRUPO_FAIL_W <> 0) AND (QTD_FAIL_W1 = 0) AND (QTD_FAIL_W2 = 0) THEN
                SELECT COUNT(NR_SEQUENCIA) NR_SEQUENCIA
                  INTO STRICT QTD_FAIL_W3
                FROM SCHEM_TEST_LOG WHERE IE_STATUS = '2'
                AND NR_SEQ_SCHEDULE IN (SELECT NR_SEQUENCIA   
                FROM SCHEM_TEST_SCHEDULE 
                WHERE NR_SEQ_PACKAGE = NR_SEQ_PACKAGEW
                AND IE_STATUS = '3'
                AND coalesce(IE_MANUAL::text, '') = ''
                AND IE_JOBS NOT IN ('1','2'))
                AND NR_SEQ_SCRIPT NOT IN (SELECT DISTINCT NR_SEQ_SCRIPT FROM SCHEM_TEST_OS WHERE NR_SEQ_PACK_SCHED = NR_SEQ_PACKAGEW AND DS_SEVERIDADE IN ('S3','S4','S5') AND IE_SITUACAO LIKE 'A');

                IF (QTD_FAIL_W3 = 0) THEN
                  UPDATE SCHEM_TEST_PACKAGE_SCHED SET IE_STATUS = '4' WHERE NR_SEQUENCIA = NR_SEQ_PACKAGEW;
                  commit;
                END IF;
            END IF;
        END IF;
      END IF;
    END IF;
  COMMIT;
  EXCEPTION
    WHEN no_data_found THEN
      RAISE NOTICE 'Erro: Data not found';
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE schematic4test_setschedstatus (NR_SEQ_SCHEDULE_P bigint) FROM PUBLIC;

