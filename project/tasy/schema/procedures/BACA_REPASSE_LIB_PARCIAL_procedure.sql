-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE baca_repasse_lib_parcial () AS $body$
DECLARE


nr_seq_proc_w		bigint;
nr_sequencia_w	bigint;


C01 CURSOR FOR
	SELECT nr_seq_procedimento
	from procedimento_repasse
	group by nr_seq_procedimento
	having count(*) > 1;



BEGIN

OPEN C01;
LOOP
FETCH C01 into	nr_seq_proc_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	select	max(nr_sequencia)
	into STRICT	nr_sequencia_w
	from	procedimento_repasse
	where	nr_seq_procedimento	= nr_seq_proc_w
	and	ie_status	= 'L'
	and	vl_liberado	= 0;

	if (nr_sequencia_w IS NOT NULL AND nr_sequencia_w::text <> '') then
		update procedimento_repasse
		set	vl_repasse	= 0
		where	nr_sequencia	= nr_sequencia_w;
	end if;

	select	max(nr_sequencia)
	into STRICT	nr_sequencia_w
	from	procedimento_repasse a
	where	nr_seq_procedimento	= nr_seq_proc_w
	and	ie_status	= 'L'
	and	vl_liberado	> 0
	and	vl_repasse	> 0
	and	vl_repasse > vl_liberado
	and	exists (SELECT 1
		from procedimento_repasse b
		where	b.nr_seq_procedimento	= nr_seq_proc_w
		and	b.nr_seq_origem		= a.nr_sequencia);
	if (nr_sequencia_w IS NOT NULL AND nr_sequencia_w::text <> '') then
		update procedimento_repasse
		set	vl_repasse	= vl_liberado
		where	nr_sequencia	= nr_sequencia_w;
	end if;
	end;
END LOOP;
close c01;
commit;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE baca_repasse_lib_parcial () FROM PUBLIC;

