-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE cpoe_gerar_cpoe_mat_assoc_proc ( nr_seq_cpoe_proc_p cpoe_procedimento.nr_sequencia%type, nm_usuario_p cpoe_procedimento.nm_usuario%type, cd_perfil_p cpoe_procedimento.cd_perfil_ativo%type, ds_retorno_p INOUT text) AS $body$
DECLARE

						
nr_sequencia_mat_w		    cpoe_material.nr_sequencia%type;						
nr_seq_cpoe_proced_w	    cpoe_procedimento.nr_sequencia%type;
nr_atendimento_w		    cpoe_material.nr_atendimento%type;
cd_material_w			    cpoe_material.cd_material%type;
qt_dose_w				    cpoe_material.qt_dose%type;
ie_via_aplicacao_w		    cpoe_material.ie_via_aplicacao%type;
cd_unidade_medida_w		    cpoe_material.cd_unidade_medida%type;
cd_intervalo_w			    cpoe_material.cd_intervalo%type;
hr_prim_horario_w		    cpoe_material.hr_prim_horario%type;
ds_horarios_w			    cpoe_material.ds_horarios%type;
dt_inicio_w				    cpoe_material.dt_inicio%type;
ie_urgencia_w			    cpoe_material.ie_urgencia%type;
ie_duracao_w			    cpoe_material.ie_duracao%type;
ie_evento_unico_w		    cpoe_material.ie_evento_unico%type;
ie_administracao_w		    cpoe_material.ie_administracao%type;
dt_fim_w				    cpoe_material.dt_fim%type;
dt_liberacao_w			    cpoe_material.dt_liberacao%type;
cd_pessoa_fisica_w		    cpoe_material.cd_pessoa_fisica%type;
cd_setor_atendimento_w	    cpoe_material.cd_setor_atendimento%type;
ie_motivo_prescricao_w	    cpoe_material.ie_motivo_prescricao%type;
cd_mat_dil1_w               cpoe_material.cd_mat_dil%type;
qt_dose_dil1_w              cpoe_material.qt_dose_dil%type;
cd_unid_medida_dose_dil1_w  cpoe_material.cd_unid_med_dose_dil%type;
ie_segunda_w				cpoe_material.ie_segunda%type;
ie_terca_w					cpoe_material.ie_terca%type;
ie_quarta_w					cpoe_material.ie_quarta%type;
ie_quinta_w					cpoe_material.ie_quinta%type;
ie_sexta_w					cpoe_material.ie_sexta%type;
ie_sabado_w					cpoe_material.ie_sabado%type;
ie_domingo_w				cpoe_material.ie_domingo%type;
ds_justificativa_w			cpoe_material.ds_justificativa%type;
ds_retorno_w			    varchar(2);

c01 CURSOR FOR						
SELECT	nr_seq_proced,
		nr_atendimento,
		cd_material,
		qt_dose,
		ie_via_aplicacao,
		cd_unidade_medida,
		cd_intervalo,
		hr_prim_horario,
		ds_horarios,
		to_date(to_char(dt_inicio,'dd/mm/yyyy') || ' ' || hr_prim_horario,'dd/mm/yyyy hh24:mi:ss'),
		ie_urgencia,
		ie_duracao,
		ie_evento_unico,
		ie_administracao,
		dt_fim,
		dt_liberacao,
		cd_pessoa_fisica,
		cd_setor_atendimento,
		ie_motivo_prescricao,
		cd_diluente,
		qt_dose_diluente,
		cd_unidade_medida_diluente,
		ie_segunda,
		ie_terca,
		ie_quarta,
		ie_quinta,
		ie_sexta,
		ie_sabado,
		ie_domingo,
		obter_just_int_med_assoc_proc(nr_seq_proced, cd_material, null)
from	cpoe_material_proced_v
where	nr_seq_proced = nr_seq_cpoe_proc_p
and		ie_checar_adep = 'S';


BEGIN
if (nr_seq_cpoe_proc_p IS NOT NULL AND nr_seq_cpoe_proc_p::text <> '') then
	open c01;
	loop
	fetch c01 into	nr_seq_cpoe_proced_w,
					nr_atendimento_w,
					cd_material_w,
					qt_dose_w,
					ie_via_aplicacao_w,
					cd_unidade_medida_w,
					cd_intervalo_w,
					hr_prim_horario_w,
					ds_horarios_w,
					dt_inicio_w,
					ie_urgencia_w,
					ie_duracao_w,
					ie_evento_unico_w,
					ie_administracao_w,
					dt_fim_w,
					dt_liberacao_w,
					cd_pessoa_fisica_w,
					cd_setor_atendimento_w,
					ie_motivo_prescricao_w,
                    cd_mat_dil1_w,
                    qt_dose_dil1_w,
                    cd_unid_medida_dose_dil1_w,
					ie_segunda_w,
					ie_terca_w,
					ie_quarta_w,
					ie_quinta_w,
					ie_sexta_w,
					ie_sabado_w,
					ie_domingo_w,
					ds_justificativa_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
		begin
			select	nextval('cpoe_material_seq')
			into STRICT	nr_sequencia_mat_w
			;
						
			insert into cpoe_material(
							nr_sequencia,
							nr_atendimento,
							cd_material,
							qt_dose,
							cd_unidade_medida,
							ie_via_aplicacao,
							cd_intervalo,
							hr_prim_horario,
							ds_horarios,
							dt_inicio,
							ie_urgencia,
							ie_duracao,
							ie_evento_unico,
							ie_administracao,
							dt_fim,
							dt_liberacao,
							ie_controle_tempo,
							nr_seq_procedimento,
							nm_usuario,
							nm_usuario_nrec,
							dt_atualizacao,
							dt_atualizacao_nrec,
							cd_perfil_ativo,
							cd_pessoa_fisica,
							cd_setor_atendimento,
							ie_motivo_prescricao,
							cd_mat_dil,
							qt_dose_dil,
							cd_unid_med_dose_dil,
							ie_material,
							ie_segunda,
							ie_terca,
							ie_quarta,
							ie_quinta,
							ie_sexta,
							ie_sabado,
							ie_domingo,
							ds_justificativa)
						values (
							nr_sequencia_mat_w,
							nr_atendimento_w,
							cd_material_w,
							qt_dose_w,
							cd_unidade_medida_w,
							ie_via_aplicacao_w,
							cd_intervalo_w,
							hr_prim_horario_w,
							ds_horarios_w,
							dt_inicio_w,
							ie_urgencia_w,
							ie_duracao_w,
							ie_evento_unico_w,
							ie_administracao_w,
							dt_fim_w,
							dt_liberacao_w,
							'N',
							nr_seq_cpoe_proced_w,
							nm_usuario_p,
							nm_usuario_p,
							clock_timestamp(),
							clock_timestamp(),
							cd_perfil_p,
							cd_pessoa_fisica_w,
							cd_setor_atendimento_w,
							ie_motivo_prescricao_w,
							cd_mat_dil1_w,
							qt_dose_dil1_w,
							cd_unid_medida_dose_dil1_w,
							'N',
							ie_segunda_w,
							ie_terca_w,
							ie_quarta_w,
							ie_quinta_w,
							ie_sexta_w,
							ie_sabado_w,
							ie_domingo_w,
							ds_justificativa_w);
				commit;				
		
		ds_retorno_w := 'M';
		end;
	end loop;
	close c01;
end if;

ds_retorno_p := ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cpoe_gerar_cpoe_mat_assoc_proc ( nr_seq_cpoe_proc_p cpoe_procedimento.nr_sequencia%type, nm_usuario_p cpoe_procedimento.nm_usuario%type, cd_perfil_p cpoe_procedimento.cd_perfil_ativo%type, ds_retorno_p INOUT text) FROM PUBLIC;

