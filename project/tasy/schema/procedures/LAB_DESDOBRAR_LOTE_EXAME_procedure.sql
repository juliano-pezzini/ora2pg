-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE lab_desdobrar_lote_exame ( nr_seq_lote_p bigint, ie_opcao_p bigint, nm_usuario_p text) AS $body$
DECLARE


/* ie_opcao_p
	1 - Por grupo de impress√£o
	2 - Por grupo de exame
*/
nr_seq_grupo_imp_w		bigint;
nr_seq_grupo_ant_w		bigint;
nr_seq_lote_w			bigint;
nr_prescricao_w			bigint;
nr_seq_prescr_w			integer;
nr_seq_grupo_exame_w	bigint;

c01 CURSOR FOR
	SELECT	c.nr_seq_grupo_imp,
			b.nr_prescricao,
			b.nr_sequencia
	from	exame_laboratorio c,
			prescr_procedimento b,
			lab_lote_exame_item a
	where	a.nr_prescricao = b.nr_prescricao
	  and	a.nr_seq_prescr	= b.nr_sequencia
	  and	b.nr_seq_exame	= c.nr_seq_exame
	  and	a.nr_seq_lote	= nr_seq_lote_p
	order by c.nr_seq_grupo_imp, b.nr_prescricao;

c02 CURSOR FOR
	SELECT	c.nr_seq_grupo,
			b.nr_prescricao,
			b.nr_sequencia
	from	exame_laboratorio c,
			prescr_procedimento b,
			lab_lote_exame_item a
	where	a.nr_prescricao = b.nr_prescricao
	  and	a.nr_seq_prescr	= b.nr_sequencia
	  and	b.nr_seq_exame	= c.nr_seq_exame
	  and	a.nr_seq_lote	= nr_seq_lote_p
	order by c.nr_seq_grupo, b.nr_prescricao;


BEGIN

nr_seq_grupo_ant_w := 0;

if (ie_opcao_p = 1) then
	open c01;
	loop
	fetch c01 into	nr_seq_grupo_imp_w,
			nr_prescricao_w,
			nr_seq_prescr_w;
		EXIT WHEN NOT FOUND; /* apply on c01 */

		if (nr_seq_grupo_imp_w <> nr_seq_grupo_ant_w) then
			select	nextval('lab_lote_exame_seq')
			into STRICT	nr_seq_lote_w
			;

			insert into lab_lote_exame(	NR_SEQUENCIA,		DT_LOTE,
							DT_ATUALIZACAO, 	NM_USUARIO,
							NR_SEQ_GRUPO,		NR_SEQ_EXAME,
							DT_INICIAL,		DT_FINAL,
							NR_SEQ_GRUPO_IMP,	IE_TIPO_ATENDIMENTO,
							DT_GERACAO,		DS_LOTE,
							IE_LOTE,		IE_STATUS,
							DT_ATUALIZACAO_NREC,	NM_USUARIO_NREC,
							CD_SETOR_ATENDIMENTO,	NR_SEQ_MATERIAL)
			SELECT	nr_seq_lote_w,		DT_LOTE,
				clock_timestamp(),	 	nm_usuario_p,
				NR_SEQ_GRUPO,		NR_SEQ_EXAME,
				DT_INICIAL,		DT_FINAL,
				nr_seq_grupo_imp_w,	IE_TIPO_ATENDIMENTO,
				DT_GERACAO,		DS_LOTE,
				IE_LOTE,		'I',
				clock_timestamp(),		nm_usuario_p,
				CD_SETOR_ATENDIMENTO,	NR_SEQ_MATERIAL
			from lab_lote_exame
			where nr_sequencia = nr_seq_lote_p;
		end if;

		nr_seq_grupo_ant_w := nr_seq_grupo_imp_w;

		update	lab_lote_exame_item
		set	nr_seq_lote	= nr_seq_lote_w
		where	nr_seq_lote	= nr_seq_lote_p
		  and	nr_prescricao	= nr_prescricao_w
		  and	nr_seq_prescr	= nr_seq_prescr_w;

	end loop;
	close c01;

elsif (ie_opcao_p = 2) then

	open c02;
	loop
	fetch c02 into	nr_seq_grupo_exame_w,
			nr_prescricao_w,
			nr_seq_prescr_w;
		EXIT WHEN NOT FOUND; /* apply on c02 */

		if (nr_seq_grupo_exame_w <> nr_seq_grupo_ant_w) then
			select	nextval('lab_lote_exame_seq')
			into STRICT	nr_seq_lote_w
			;

			insert into lab_lote_exame(	NR_SEQUENCIA,		DT_LOTE,
							DT_ATUALIZACAO, 	NM_USUARIO,
							NR_SEQ_GRUPO,		NR_SEQ_EXAME,
							DT_INICIAL,		DT_FINAL,
							NR_SEQ_GRUPO_IMP,	IE_TIPO_ATENDIMENTO,
							DT_GERACAO,		DS_LOTE,
							IE_LOTE,		IE_STATUS,
							DT_ATUALIZACAO_NREC,	NM_USUARIO_NREC,
							CD_SETOR_ATENDIMENTO,	NR_SEQ_MATERIAL)
			SELECT	nr_seq_lote_w,		DT_LOTE,
				clock_timestamp(),	 	nm_usuario_p,
				nr_seq_grupo_exame_w,		NR_SEQ_EXAME,
				DT_INICIAL,		DT_FINAL,
				NR_SEQ_GRUPO_IMP,	IE_TIPO_ATENDIMENTO,
				DT_GERACAO,		DS_LOTE,
				IE_LOTE,		'I',
				clock_timestamp(),		nm_usuario_p,
				CD_SETOR_ATENDIMENTO,	NR_SEQ_MATERIAL
			from lab_lote_exame
			where nr_sequencia = nr_seq_lote_p;
		end if;

		nr_seq_grupo_ant_w := nr_seq_grupo_exame_w;

		update	lab_lote_exame_item
		set	nr_seq_lote	= nr_seq_lote_w
		where	nr_seq_lote	= nr_seq_lote_p
		  and	nr_prescricao	= nr_prescricao_w
		  and	nr_seq_prescr	= nr_seq_prescr_w;

	end loop;
	close c02;

end if;

delete FROM lab_lote_exame
where nr_sequencia = nr_seq_lote_p;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE lab_desdobrar_lote_exame ( nr_seq_lote_p bigint, ie_opcao_p bigint, nm_usuario_p text) FROM PUBLIC;

