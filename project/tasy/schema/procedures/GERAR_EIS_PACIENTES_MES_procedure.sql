-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_eis_pacientes_mes (dt_cadastro_orig_p timestamp, nm_usuario_p text) AS $body$
DECLARE

 
dt_inicial_w			timestamp;
dt_final_w			timestamp;
cd_convenio_w         	integer;
dt_atualizacao_w        	timestamp;
dt_atualizacao_nrec_w		timestamp;
dt_cadastro_orig_w       	timestamp;
nm_usuario_w          	varchar(5);
nm_usuario_nrec_w       	varchar(5);
nr_atendimento_w        	bigint;
nr_sequencia_w         	bigint;
qt_atendimento_w        	bigint;

c01 CURSOR FOR 
	SELECT	a.cd_convenio, 
		trunc(f.dt_cadastro_original,'dd') dt_cadastro_original, 
		b.nr_atendimento, 
		count(b.nr_atendimento) qt_atendimento 
	from	convenio a, 
		atendimento_paciente b, 
		atend_categoria_convenio c, 
		pessoa_fisica f  
	where	a.cd_convenio = c.cd_convenio 
	and	c.nr_atendimento = b.nr_atendimento 
	and	b.cd_pessoa_fisica = f.cd_pessoa_fisica 
	and	f.dt_cadastro_original between dt_inicial_w and dt_final_w 
	and	b.nr_atendimento =(	SELECT min(i.nr_atendimento) 
					from atendimento_paciente i 
					where b.cd_pessoa_fisica = i.cd_pessoa_fisica) 
	group by	a.cd_convenio, b.nr_atendimento,f.dt_cadastro_original 
	order by	b.nr_atendimento;

BEGIN
 
dt_inicial_w	:= trunc(dt_cadastro_orig_p, 'month');
dt_final_w	:= fim_dia(last_day(dt_cadastro_orig_p));
 
delete	from eis_pacientes_mes 
where	trunc(dt_cadastro_orig,'month')	between dt_inicial_w and dt_final_w;
 
 
commit;
 
 
open C01;
loop 
fetch C01 into	 
	cd_convenio_w, 
	dt_cadastro_orig_w, 
	nr_atendimento_w, 
	qt_atendimento_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin 
	 
	select	nextval('eis_pacientes_mes_seq') 
	into STRICT	nr_sequencia_w 
	;
	 
	insert into eis_pacientes_mes(cd_convenio,       
		dt_atualizacao, 
		dt_atualizacao_nrec,   
		dt_cadastro_orig,     
		nm_usuario,        
		nm_usuario_nrec,     
		nr_atendimento,      
		nr_sequencia,       
		qt_atendimento) 
	values (cd_convenio_w, 
		clock_timestamp(), 
		clock_timestamp(), 
		dt_cadastro_orig_w, 
		nm_usuario_p, 
		nm_usuario_p, 
		nr_atendimento_w, 
		nr_sequencia_w, 
		qt_atendimento_w);
 
	end;
end loop;
close C01;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_eis_pacientes_mes (dt_cadastro_orig_p timestamp, nm_usuario_p text) FROM PUBLIC;

