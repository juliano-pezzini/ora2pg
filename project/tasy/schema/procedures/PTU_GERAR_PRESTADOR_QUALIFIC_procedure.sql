-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE ptu_gerar_prestador_qualific ( nr_seq_prestador_p ptu_prestador.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type ) AS $body$
DECLARE


cd_cgc_cpf_w			ptu_prestador_qualific.cd_cnpj_cpf%type;
inst_acred_w			ptu_prestador_qualific.cd_instituicao_acred%type;
nivel_acred_w			ptu_prestador_qualific.ie_nivel_acreditacao%type;
nr_referencia_end_qualif_w	ptu_prestador_qualific.nr_referencia_end%type;

C01 CURSOR(nr_seq_prestador_pc	ptu_prestador.nr_sequencia%type) FOR
	SELECT	a.cd_cgc_cpf,
		a.ie_instituicao_acred_ptu ie_inst_acred,
		coalesce(b.ie_nivel_acreditacao_ptu,'0') ie_nivel_acred,
		coalesce(a.nr_referencia_end,'0') nr_referencia_end
	from	ptu_prestador_endereco	a,
		pls_prestador		b
	where	a.nr_seq_prestador	= nr_seq_prestador_pc
	and	b.nr_sequencia		= a.nr_seq_prestador_end
	and	a.ie_prest_acred	= 'S'
	group by a.cd_cgc_cpf,
		a.ie_instituicao_acred_ptu,
		b.ie_nivel_acreditacao_ptu,
		a.nr_referencia_end;

BEGIN

-- 408 QUALIFICAÇÃO DOS PRESTADORES DE SERVIÇO (OPCIONAL) (Continuação)
for r_c01_w in c01( nr_seq_prestador_p ) loop

	insert into ptu_prestador_qualific(nr_sequencia,				dt_atualizacao,		nm_usuario,
		dt_atualizacao_nrec,			nm_usuario_nrec,	nr_seq_prestador,
		cd_cnpj_cpf,				cd_instituicao_acred,	ie_nivel_acreditacao,
		nr_referencia_end)
	values (nextval('ptu_prestador_qualific_seq'),	clock_timestamp(),		nm_usuario_p,
		clock_timestamp(),				nm_usuario_p,		nr_seq_prestador_p,
		r_c01_w.cd_cgc_cpf,			r_c01_w.ie_inst_acred,	r_c01_w.ie_nivel_acred,
		r_c01_w.nr_referencia_end);

end loop;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ptu_gerar_prestador_qualific ( nr_seq_prestador_p ptu_prestador.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type ) FROM PUBLIC;

