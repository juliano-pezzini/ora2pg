-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE atualizar_evento_autor_conv ( ie_evento_p bigint, nr_seq_agenda_p bigint, nr_sequencia_autor_p bigint, nr_seq_gestao_vaga_p bigint, nm_usuario_p text) AS $body$
DECLARE

 
nr_sequencia_w			bigint	:= null;
ie_grava_evento_autor_conv_w	varchar(1)	:= 'N';
cd_estabelecimento_w		smallint;


BEGIN 
 
if (ie_evento_p IS NOT NULL AND ie_evento_p::text <> '') and (nr_seq_agenda_p IS NOT NULL AND nr_seq_agenda_p::text <> '') then 
 
	select	max(cd_estabelecimento) 
	into STRICT	cd_estabelecimento_w 
	from	agenda b, 
		agenda_paciente a 
	where	a.cd_agenda	= b.cd_agenda 
	and	a.nr_sequencia	= nr_seq_agenda_p;
 
	if (cd_estabelecimento_w IS NOT NULL AND cd_estabelecimento_w::text <> '') then 
		select	coalesce(max(ie_grava_evento_autor_conv),'N') 
		into STRICT	ie_grava_evento_autor_conv_w 
		from	parametro_faturamento 
		where	cd_estabelecimento	= cd_estabelecimento_w;	
	end if;
 
	if (ie_grava_evento_autor_conv_w = 'S') then 
		select	max(nr_sequencia) 
		into STRICT	nr_sequencia_w 
		from	autor_convenio_evento 
		where	nr_seq_agenda	= nr_seq_agenda_p 
		and	ie_evento	= ie_evento_p;
	 
		if (coalesce(nr_sequencia_w::text, '') = '') then 
	 
			select	nextval('autor_convenio_evento_seq') 
			into STRICT	nr_sequencia_w 
			;
	 
			insert	into	autor_convenio_evento(nr_sequencia, 
				nm_usuario, 
				dt_atualizacao, 
				nm_usuario_nrec, 
				dt_atualizacao_nrec, 
				ie_evento, 
				nr_seq_agenda, 
				nr_sequencia_autor, 
				nr_seq_gestao_vaga) 
			values (nr_sequencia_w, 
				nm_usuario_p, 
				clock_timestamp(), 
				nm_usuario_p, 
				clock_timestamp(), 
				ie_evento_p, 
				nr_seq_agenda_p, 
				nr_sequencia_autor_p, 
				nr_seq_gestao_vaga_p);
			commit;
		else 
			update	autor_convenio_evento 
			set	nm_usuario	= nm_usuario_p, 
				dt_atualizacao	= clock_timestamp() 
			where	nr_sequencia	= nr_sequencia_w;
			commit;
		end if;
	end if;
end if;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE atualizar_evento_autor_conv ( ie_evento_p bigint, nr_seq_agenda_p bigint, nr_sequencia_autor_p bigint, nr_seq_gestao_vaga_p bigint, nm_usuario_p text) FROM PUBLIC;

