-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE mx_cfdi_gerar_nf_item (nr_sequencia_p bigint) AS $body$
DECLARE


qt_item_estoque_w			nota_fiscal_item.qt_item_estoque%type;
cd_material_w				nf_imp_nota_item.cd_material_interno%type;
qt_conversao_w				bigint;
cd_estabelecimento_w		bigint;
cd_cgc_emitente_w			nota_fiscal.cd_cgc_emitente%type;
cd_serie_nf_w				nota_fiscal.cd_serie_nf%type;
nr_nota_fiscal_w			nota_fiscal.nr_nota_fiscal%type;
nr_sequencia_nf_w			bigint;
cd_natureza_operacao_w		bigint;
nr_item_nf_w				bigint;
qt_item_nf_w				bigint;
vl_unitario_item_nf_w		bigint;
vl_total_item_nf_w			bigint;
vl_desconto_w				bigint;
cd_operacao_nota_w			nota_fiscal.cd_operacao_nf%type;
cd_conta_contabil_w			varchar(20);
cd_centro_custo_w			bigint;
ds_observacao_w				nota_fiscal_item.ds_observacao%type;
cd_local_estoque_w			nf_imp_nota.cd_local_estoque%type;
cd_sequencia_parametro_w    nota_fiscal_item.cd_sequencia_parametro%type;

c01 CURSOR FOR
	SELECT	nfi.cd_material_interno,
			nfi.qt_item,
			nfi.vl_unitario,
			nfi.vl_item,
			nfi.vl_desconto,
			nf.cd_local_estoque
	from
			nf_imp_nota_item nfi,
			nf_imp_nota nf
	where	nf.nr_sequencia = nfi.nr_seq_nf_imp_nota
	and		nf.nr_seq_nf_interno = nr_sequencia_p;


BEGIN

select	max(cd_estabelecimento),
		max(cd_cgc_emitente),
		max(cd_serie_nf),
		max(nr_nota_fiscal),
		max(nr_sequencia_nf),
		max(cd_natureza_operacao),
		max(cd_operacao_nf)
into STRICT 	cd_estabelecimento_w,
		cd_cgc_emitente_w,
		cd_serie_nf_w,
		nr_nota_fiscal_w,
		nr_sequencia_nf_w,
		cd_natureza_operacao_w,
		cd_operacao_nota_w
from 	nota_fiscal
where 	nr_sequencia = nr_sequencia_p;


open c01;
loop
fetch c01 into
	cd_material_w,
	qt_item_nf_w,
	vl_unitario_item_nf_w,
	vl_total_item_nf_w,
	vl_desconto_w,
	cd_local_estoque_w;
	
EXIT WHEN NOT FOUND; /* apply on c01 */
    cd_sequencia_parametro_w := null;

	SELECT * FROM define_conta_material(
		cd_estabelecimento_w, cd_material_w, 2, 0, 0, 0, 0, 0, 0, 0, cd_local_estoque_w, cd_operacao_nota_w, trunc(clock_timestamp()), cd_conta_contabil_w, cd_centro_custo_w, null) INTO STRICT cd_conta_contabil_w, cd_centro_custo_w;
	cd_sequencia_parametro_w := philips_contabil_pck.get_parametro_conta_contabil();

	qt_conversao_w := obter_qt_conv_compra_est(cd_material_w, cd_cgc_emitente_w, substr(obter_dados_material_estab(cd_material_w,cd_estabelecimento_w,'UMC'),1,255), cd_estabelecimento_w, null, qt_conversao_w);
	qt_item_estoque_w	:= qt_item_nf_w * qt_conversao_w;
		
	select (coalesce(max(nr_item_nf),0)+1)
	into STRICT	nr_item_nf_w
	from	nota_fiscal_item
	where 	nr_sequencia	= nr_sequencia_p;
	
	ds_observacao_w := mx_obter_obs_item(nr_sequencia_p);
	
	insert into nota_fiscal_item(
		nr_sequencia,
		cd_estabelecimento,
		cd_cgc_emitente,
		cd_serie_nf,
		nr_nota_fiscal,
		nr_sequencia_nf,
		nr_item_nf,
		cd_natureza_operacao,
		qt_item_nf,
		qt_item_estoque,
		vl_unitario_item_nf,
		vl_total_item_nf,
		dt_atualizacao,
		nm_usuario,
		cd_material,
		vl_desconto_rateio,
		vl_seguro,
		vl_frete,
		pr_desconto,
		vl_desconto,
		vl_despesa_acessoria,
		vl_liquido,
		cd_material_estoque,
		cd_unidade_medida_compra,
		cd_unidade_medida_estoque,
		cd_local_estoque,
		cd_conta_contabil,
		cd_centro_custo,
		nr_ordem_compra,
		nr_item_oci,
		cd_lote_fabricacao,
		dt_validade,
		ds_observacao,
		cd_sequencia_parametro)
	values (
		nr_sequencia_p,
		cd_estabelecimento_w,
		cd_cgc_emitente_w,
		coalesce(cd_serie_nf_w,0),
		coalesce(nr_nota_fiscal_w,0),
		coalesce(nr_sequencia_nf_w,0),
		coalesce(nr_item_nf_w,0),
		cd_natureza_operacao_w,
		coalesce(qt_item_nf_w,0),
		coalesce(qt_item_estoque_w,0),
		coalesce(vl_unitario_item_nf_w,0),
		coalesce(vl_total_item_nf_w,0),			
		clock_timestamp(),
		wheb_usuario_pck.get_nm_usuario,
		cd_material_w,
		0,
		0,
		0,
		0,
		coalesce(vl_desconto_w,0),
		0,
		coalesce(vl_total_item_nf_w - coalesce(vl_desconto_w,0),0),
		null, --cd_material_estoque
		substr(obter_dados_material_estab(cd_material_w,cd_estabelecimento_w,'UMC'),1,255),-- cd_unidade_medida_compra
		substr(obter_dados_material_estab(cd_material_w,cd_estabelecimento_w,'UME'),1,30), --cd_unidade_medida_estoque
		cd_local_estoque_w, --cd_local_estoque
		cd_conta_contabil_w, --cd_conta_contabil
		cd_centro_custo_w, --cd_centro_custo
		null, --nr_ordem_compra
		null, --nr_item_oci
		null, -- cd_lote_fabricacao
		null, --dt_validade)
		ds_observacao_w,
		cd_sequencia_parametro_w);
		
	CALL mx_cfdi_gerar_nf_imp_item(nr_sequencia_p, nr_nota_fiscal_w, nr_item_nf_w, nr_sequencia_nf_w, cd_cgc_emitente_w);
	
end loop;
close c01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE mx_cfdi_gerar_nf_item (nr_sequencia_p bigint) FROM PUBLIC;

