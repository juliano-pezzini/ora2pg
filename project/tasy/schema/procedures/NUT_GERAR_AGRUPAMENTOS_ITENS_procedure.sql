-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE nut_gerar_agrupamentos_itens (nr_seq_prod_cond_p bigint, nm_usuario_p text) AS $body$
DECLARE


qt_dose_real_w		double precision;
nr_sequencia_w		bigint;
ie_agrupador_w		integer;

C01 CURSOR FOR
	SELECT	distinct a.qt_dose
	from	nut_producao_conduta_item a,
		nut_atend_serv_dia_dieta b
	where	a.nr_seq_dieta = b.nr_sequencia
	and	a.nr_seq_prod_cond = nr_seq_prod_cond_p;

C02 CURSOR FOR
	SELECT 	a.nr_sequencia
	from	nut_producao_conduta_item a,
		nut_atend_serv_dia_dieta b
	where	a.nr_seq_dieta = b.nr_sequencia
	and	a.nr_seq_prod_cond = nr_seq_prod_cond_p
	and	a.qt_dose = qt_dose_real_w
	order by a.nr_atendimento;


BEGIN

if (coalesce(nr_seq_prod_cond_p,0) > 0) then

	ie_agrupador_w := 1;
	open C01;
	loop
	fetch C01 into
		qt_dose_real_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin
		open C02;
		loop
		fetch C02 into
			nr_sequencia_w;
		EXIT WHEN NOT FOUND; /* apply on C02 */
			begin

			update	nut_producao_conduta_item
			set	ie_agrupador = ie_agrupador_w
			where	nr_sequencia = nr_sequencia_w;

			end;
		end loop;
		close C02;

		ie_agrupador_w := ie_agrupador_w +1;

		end;
	end loop;
	close C01;


end if;


commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE nut_gerar_agrupamentos_itens (nr_seq_prod_cond_p bigint, nm_usuario_p text) FROM PUBLIC;

