-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE lab_aprovar_exame_interfaceado (nr_prescricao_p bigint, nr_seq_prescr_p bigint, nm_usuario_p text) AS $body$
DECLARE

					 
nr_seq_resultado_w		bigint;
nm_usuario_aprov_w		lab_importacao_exame.nm_usuario_aprov%type;
ie_usuario_equip_novo_interf_w	lab_parametro.ie_usuario_equip_novo_interf%type;
ie_consiste_nao_aceit_w  lab_parametro.ie_consiste_nao_aceit%type;
ie_resultado_nao_aceit_w varchar(1);
ds_resultado_w exame_lab_result_item.ds_resultado%type;
qt_resultado_w exame_lab_result_item.qt_resultado%type;
pr_resultado_w exame_lab_result_item.pr_resultado%type;
nr_seq_exame_w exame_lab_result_item.nr_seq_exame%type;
nr_seq_material_w exame_lab_result_item.nr_seq_material%type;

c01 CURSOR FOR 
SELECT ds_resultado, qt_resultado, pr_resultado, nr_seq_exame, nr_seq_material 
   from exame_lab_result_item		 
	  where nr_seq_resultado 	= nr_seq_resultado_w 
	   and nr_seq_prescr		= nr_seq_prescr_p;	

BEGIN 
 
if (nr_prescricao_p IS NOT NULL AND nr_prescricao_p::text <> '') and (nr_seq_prescr_p IS NOT NULL AND nr_seq_prescr_p::text <> '') then 
  
 ie_resultado_nao_aceit_w := 'N';
	 
	nm_usuario_aprov_w := nm_usuario_p;
	 
	select	coalesce(max(a.ie_usuario_equip_novo_interf), 'N'), 
     coalesce(max(a.ie_consiste_nao_aceit), 'N') 
	into STRICT	ie_usuario_equip_novo_interf_w, 
    ie_consiste_nao_aceit_w 
	from	lab_parametro a, 
		prescr_medica b 
	where	a.cd_estabelecimento = b.cd_estabelecimento 
	 and	b.nr_prescricao = nr_prescricao_p;
		 
	if (coalesce(ie_usuario_equip_novo_interf_w, 'N') = 'S') then 
		select	/*+ index (y LABIMPE_I2)*/ 
			coalesce(max(nm_usuario_aprov), nm_usuario_p) 
		into STRICT	nm_usuario_aprov_w 
		from	lab_importacao_exame 
		where	nr_prescricao = nr_prescricao_p 
		 and	nr_seq_prescr = nr_seq_prescr_p;
	end if;
	 
 select	coalesce(max(nr_seq_resultado),0) 
  into STRICT	nr_seq_resultado_w 
  from	exame_lab_resultado 
  where	nr_prescricao = nr_prescricao_p;
  
 if (ie_consiste_nao_aceit_w = 'S') then 
  open c01;
  loop fetch c01 into ds_resultado_w, qt_resultado_w, pr_resultado_w, nr_seq_exame_w, nr_seq_material_w;
   ie_resultado_nao_aceit_w := lab_obter_se_nao_aceitavel(nr_prescricao_p,	nr_seq_prescr_p, nr_seq_exame_w, nr_seq_material_w, ds_resultado_w, qt_resultado_w, pr_resultado_w);   		
 
   if (ie_resultado_nao_aceit_w = 'S') then 
    exit;
   end if;
    
  EXIT WHEN NOT FOUND; /* apply on c01 */
  end loop;
  close c01;
 end if;
 
 if (ie_resultado_nao_aceit_w = 'N') then 
  update	prescr_procedimento 
    set	ie_status_atend 	= 35, 
      nm_usuario = nm_usuario_aprov_w, 
      dt_atualizacao = clock_timestamp() 
   where	nr_prescricao 		= nr_prescricao_p 
	   and	nr_sequencia		= nr_seq_prescr_p  
	   and	ie_status_atend < 35;
	 
	 if (nr_seq_resultado_w > 0) then	 
 		update	exame_lab_result_item 
     set	dt_aprovacao	=	clock_timestamp(), 
       nm_usuario = nm_usuario_p, 
       dt_atualizacao = clock_timestamp(), 
       nm_usuario_aprovacao = nm_usuario_aprov_w 
    where	nr_seq_resultado 	= nr_seq_resultado_w 
     and	nr_seq_prescr		= nr_seq_prescr_p 
     and	(nr_seq_material IS NOT NULL AND nr_seq_material::text <> '');		
  end if;
 end if;
end if;
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE lab_aprovar_exame_interfaceado (nr_prescricao_p bigint, nr_seq_prescr_p bigint, nm_usuario_p text) FROM PUBLIC;

