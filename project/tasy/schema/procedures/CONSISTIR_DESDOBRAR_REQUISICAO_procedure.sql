-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE consistir_desdobrar_requisicao ( nm_usuario_p text, nr_requisicao_p bigint, varconsistematerialccusto_p text, somentetransf_farmacia_p text, varobrigamaterialpadr_p text, varconsistemateriallocal_p text, varconsisteestoquedisp_p text, consiste_devol_consumo_p text, varpermiteestoquemax_p text, vardesdobrarkit_p text, ds_erro_liberacao INOUT text, ds_requisicoes_p INOUT text) AS $body$
DECLARE

			
type Vetor is table of requisicao_material%rowtype index by integer;

i			integer := 0;
j			integer := 0;
k			integer := 0;
vetor_req_w		vetor;

nr_sequencia_w		bigint;
nr_desdobrada_w		bigint;
cd_material_w		integer;

cd_local_estoque_w	smallint;
cd_local_destino_w	smallint;
cd_operacao_estoque_w	smallint;
cd_estabelecimento_w	smallint;
nr_requisicao_w		bigint;
nr_seq_item_w		bigint;

nr_seq_regra_w		bigint;
cd_local_desdobrar_w	smallint;
qt_consistencia_w	bigint;
qt_itens_req_w		bigint;

ds_erro_w		varchar(2000);
ds_requisicoes_w	varchar(2000);
ie_desdobra_consignados_w	varchar(1);
ie_desdobra_regra_w		varchar(1);

C01 CURSOR FOR
	SELECT	nr_sequencia,
		cd_material
	from	item_requisicao_material
	where	nr_requisicao = nr_requisicao_p;


BEGIN

ie_desdobra_consignados_w := obter_param_usuario(919, 110, obter_perfil_ativo, nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento, ie_desdobra_consignados_w);
ie_desdobra_regra_w := obter_param_usuario(919, 106, obter_perfil_ativo, nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento, ie_desdobra_regra_w);

select	cd_local_estoque,
	cd_local_estoque_destino,
	cd_operacao_estoque,
	cd_estabelecimento
into STRICT	cd_local_estoque_w,
	cd_local_destino_w,
	cd_operacao_estoque_w,
	cd_estabelecimento_w
from	requisicao_material
where	nr_requisicao = nr_requisicao_p;

vetor_req_w[i].nr_requisicao := nr_requisicao_p;
select	cd_local_estoque_destino,
	cd_centro_custo,
	cd_operacao_estoque
into STRICT	vetor_req_w[i].cd_local_estoque_destino,
	vetor_req_w[i].cd_centro_custo,
	vetor_req_w[i].cd_operacao_estoque
from	requisicao_material
where	nr_requisicao = nr_requisicao_p;

i := i + 1;
ds_requisicoes_w := substr(ds_requisicoes_w || nr_requisicao_p,1,2000);

if (ie_desdobra_regra_w = 'S') then
	open C01;
	loop
	fetch C01 into	
		nr_sequencia_w,
		cd_material_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin

		nr_seq_regra_w := sup_obter_regra_desdobra_req(cd_material_w,cd_local_estoque_w,cd_local_destino_w,cd_operacao_estoque_w,cd_estabelecimento_w);

        CALL grava_log_tasy(947,'nr_requisicao_p: ' || nr_requisicao_p || '. nr_seq_regra_w: ' || nr_seq_regra_w || '. cd_material_w: ' || cd_material_w, nm_usuario_p);

		if (coalesce(nr_seq_regra_w,0) > 0) then

			select	max(cd_local_estoque_desdob)
			into STRICT	cd_local_desdobrar_w
			from	regra_desdobramento_req
			where	nr_sequencia = nr_seq_regra_w;

			select	max(nr_requisicao)
			into STRICT	nr_requisicao_w
			from	requisicao_material
			where	nr_requisicao_orig = nr_requisicao_p
			and	cd_local_estoque = cd_local_desdobrar_w
			and	cd_operacao_estoque = cd_operacao_estoque_w
			and	coalesce(dt_liberacao::text, '') = '';

            CALL grava_log_tasy(947,'nr_requisicao_p: ' ||  nr_requisicao_p || '. nr_requisicao_w: ' || nr_requisicao_w, nm_usuario_p);

			if (coalesce(nr_requisicao_w::text, '') = '') then

				select	nextval('requisicao_seq')
				into STRICT	nr_requisicao_w
				;

				vetor_req_w[i].nr_requisicao := nr_requisicao_w;

				insert into requisicao_material(
					cd_centro_custo,		cd_estabelecimento,		cd_local_estoque,
					cd_local_estoque_destino,	cd_operacao_estoque,		cd_pessoa_requisitante,		
					cd_pessoa_solicitante,		cd_setor_atendimento,		cd_setor_entrega,		
					ds_observacao,			dt_aprovacao,			dt_atualizacao,			
					dt_atualizacao_nrec,		dt_compra,			dt_emissao_loc_estoque,
					dt_emissao_setor,		dt_solicitacao_requisicao,	ie_geracao,			
					ie_origem_requisicao,		ie_urgente,			nm_usuario,
					nm_usuario_lib,			nm_usuario_nrec,		nr_adiantamento,		
					nr_atendimento,			nr_documento_externo,		nr_requisicao,
					nr_seq_inv_roupa,		nr_seq_justificativa,		nr_seq_ordem_serv,		
					nr_seq_proj_gpi,		nr_seq_protocolo,		nr_requisicao_orig)
				SELECT	cd_centro_custo,		cd_estabelecimento,		cd_local_desdobrar_w,
					cd_local_estoque_destino,	cd_operacao_estoque,		cd_pessoa_requisitante,		
					cd_pessoa_solicitante,		cd_setor_atendimento,		cd_setor_entrega,		
					ds_observacao,			dt_aprovacao,			clock_timestamp(),			
					clock_timestamp(),			dt_compra,			dt_emissao_loc_estoque,
					dt_emissao_setor,		dt_solicitacao_requisicao,	ie_geracao,			
					ie_origem_requisicao,		ie_urgente,			nm_usuario,
					nm_usuario_lib,			nm_usuario_nrec,		nr_adiantamento,		
					nr_atendimento,			nr_documento_externo,		nr_requisicao_w,		
					nr_seq_inv_roupa,		nr_seq_justificativa,		nr_seq_ordem_serv,		
					nr_seq_proj_gpi,		nr_seq_protocolo,		nr_requisicao_p
				from	requisicao_material
				where	nr_requisicao = nr_requisicao_p;

				select	cd_local_estoque_destino,
					cd_centro_custo,
					cd_operacao_estoque
				into STRICT	vetor_req_w[i].cd_local_estoque_destino,
					vetor_req_w[i].cd_centro_custo,
					vetor_req_w[i].cd_operacao_estoque
				from	requisicao_material
				where	nr_requisicao = nr_requisicao_p;

				i := i + 1;
				ds_requisicoes_w := substr(ds_requisicoes_w || ',' || nr_requisicao_w,1,2000);
			end if;

			select	coalesce(max(nr_sequencia),0) + 1
			into STRICT	nr_seq_item_w
			from	item_requisicao_material
			where	nr_requisicao = nr_requisicao_w;

			insert	into item_requisicao_material(
				cd_cgc_fornecedor,		cd_conta_contabil,		cd_estabelecimento,
				cd_kit_material,		cd_material,			cd_material_lido,
				cd_material_req,		cd_processo_aprov,		cd_unidade_medida,
				cd_unidade_medida_estoque,	ds_justificativa,		ds_justificativa_reprov,
				ds_observacao,			dt_aprovacao,			dt_atendimento,
				dt_atualizacao,			dt_dispensacao,			dt_reprovacao,
				ie_acao,			ie_geracao,			ie_motivo_reprovacao,
				ie_msg_estoque_max,		nm_usuario,			nm_usuario_aprov,
				nm_usuario_disp,		nm_usuario_receb,		nr_documento_externo,
				nr_item_docto_externo,		nr_requisicao,			nr_seq_aprovacao,		
				nr_seq_cor_exec,		nr_seq_etapa_gpi,		nr_seq_kit_estoque,
				nr_seq_lote_fornec,		nr_sequencia,			qt_estoque,			
				qt_estoque_superou,		qt_material_atendida,		qt_material_requisitada,
				vl_material,			vl_preco_venda,			vl_unit_previsto,
				nr_seq_justificativa, qt_material_req_auto)
			SELECT	cd_cgc_fornecedor,		cd_conta_contabil,		cd_estabelecimento,
				cd_kit_material,		cd_material,			cd_material_lido,
				cd_material_req,		cd_processo_aprov,		cd_unidade_medida,
				cd_unidade_medida_estoque,	ds_justificativa,		ds_justificativa_reprov,
				ds_observacao,			dt_aprovacao,			dt_atendimento,
				dt_atualizacao,			dt_dispensacao,			dt_reprovacao,
				ie_acao,			ie_geracao,			ie_motivo_reprovacao,
				ie_msg_estoque_max,		nm_usuario,			nm_usuario_aprov,
				nm_usuario_disp,		nm_usuario_receb,		nr_documento_externo,
				nr_item_docto_externo,		nr_requisicao_w,		nr_seq_aprovacao,
				nr_seq_cor_exec,		nr_seq_etapa_gpi,		nr_seq_kit_estoque,
				nr_seq_lote_fornec,		nr_seq_item_w,			qt_estoque,	
				qt_estoque_superou,		qt_material_atendida,		qt_material_requisitada,
				vl_material,			vl_preco_venda,			vl_unit_previsto,
				nr_seq_justificativa, qt_material_req_auto
			from	item_requisicao_material
			where	nr_requisicao = nr_requisicao_p
			and	nr_sequencia = nr_sequencia_w;

			delete 	from item_requisicao_material
			where	nr_requisicao = nr_requisicao_p
			and	nr_sequencia = nr_sequencia_w;

		end if;

		end;
	end loop;
	close C01;
end if;

if (ie_desdobra_consignados_w = 'L') then
	k := i;
	for	j in 0..k-1 loop
		begin
		nr_desdobrada_w := desdobrar_requisicao_consig(	vetor_req_w[j].nr_requisicao, nm_usuario_p, cd_estabelecimento_w, nr_desdobrada_w);

		if (nr_desdobrada_w IS NOT NULL AND nr_desdobrada_w::text <> '') then
			vetor_req_w[i].nr_requisicao := nr_desdobrada_w;

			select	cd_local_estoque_destino,
				cd_centro_custo,
				cd_operacao_estoque
			into STRICT	vetor_req_w[i].cd_local_estoque_destino,
				vetor_req_w[i].cd_centro_custo,
				vetor_req_w[i].cd_operacao_estoque
			from	requisicao_material
			where	nr_requisicao = nr_desdobrada_w;

			i := i + 1;
			ds_requisicoes_w := substr(ds_requisicoes_w || ',' || nr_desdobrada_w,1,2000);
		end if;
		end;
	end loop;
end if;

for	j in 0..i-1 loop
	begin
	ds_erro_w := consistir_requisicao(	vetor_req_w[j].nr_requisicao, nm_usuario_p, vetor_req_w[j].cd_local_estoque_destino, vetor_req_w[j].cd_centro_custo, varconsistematerialccusto_p, somentetransf_farmacia_p, varobrigamaterialpadr_p, varconsistemateriallocal_p, varconsisteestoquedisp_p, consiste_devol_consumo_p, varpermiteestoquemax_p, vetor_req_w[j].cd_operacao_estoque, ds_erro_w);

	select 	count(*)
	into STRICT	qt_consistencia_w
	from 	requisicao_mat_consist 
	where 	nr_requisicao = vetor_req_w[j].nr_requisicao;

	if (vardesdobrarkit_p = 'S') and (qt_consistencia_w = 0) then
		CALL Gerar_itens_kit_requisicao(nr_requisicao_p,nm_usuario_p);
	end if;

	select	count(*)
	into STRICT	qt_itens_req_w
	from	item_requisicao_material
	where	nr_requisicao = vetor_req_w[j].nr_requisicao;

	if (qt_itens_req_w = 0) then
		update	requisicao_material
		set	dt_baixa = clock_timestamp()
		where	nr_requisicao = vetor_req_w[j].nr_requisicao;
	end if;

	end;
end loop;

CALL grava_log_tasy(947,'nr_requisicao_p: ' || nr_requisicao_p || '. ds_requisicoes_w: ' || ds_requisicoes_w, nm_usuario_p);

ds_requisicoes_p := ds_requisicoes_w;	

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE consistir_desdobrar_requisicao ( nm_usuario_p text, nr_requisicao_p bigint, varconsistematerialccusto_p text, somentetransf_farmacia_p text, varobrigamaterialpadr_p text, varconsistemateriallocal_p text, varconsisteestoquedisp_p text, consiste_devol_consumo_p text, varpermiteestoquemax_p text, vardesdobrarkit_p text, ds_erro_liberacao INOUT text, ds_requisicoes_p INOUT text) FROM PUBLIC;

