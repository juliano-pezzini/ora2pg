-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE cpoe_copy_protocol_glycemia ( nr_seq_proc_prev_p bigint, nr_seq_proc_next_p bigint, nm_usuario_p text) AS $body$
DECLARE



nr_seq_procedimento_w	cpoe_proc_glic.nr_seq_procedimento%type;
nr_seq_protocolo_w	cpoe_proc_glic.nr_seq_protocolo%type;
qt_glic_inic_w		cpoe_proc_glic.qt_glic_inic%type;
qt_glic_fim_w		cpoe_proc_glic.qt_glic_fim%type;
qt_ui_insulina_w		cpoe_proc_glic.qt_ui_insulina%type;
qt_glicose_w		cpoe_proc_glic.qt_glicose%type;
ds_sugestao_w		cpoe_proc_glic.ds_sugestao%type;
qt_minutos_medicao_w	cpoe_proc_glic.qt_minutos_medicao%type;
qt_ui_insulina_int_w		cpoe_proc_glic.qt_ui_insulina_int%type;
nr_seq_proc_edit_w	cpoe_proc_glic.nr_seq_proc_edit%type;
nr_atendimento_w		cpoe_proc_glic.nr_atendimento%type;
cd_pessoa_fisica_w	cpoe_proc_glic.cd_pessoa_fisica%type;
nr_sequencia_w		cpoe_proc_glic.nr_sequencia%type;

C01 CURSOR FOR
	SELECT	nr_seq_procedimento,
		nr_seq_protocolo,
		qt_glic_inic,
		qt_glic_fim,
		qt_ui_insulina,
		qt_glicose,
		ds_sugestao,
		qt_minutos_medicao,
		qt_ui_insulina_int,
		nr_seq_proc_edit,
		nr_atendimento,
		cd_pessoa_fisica
	from	cpoe_proc_glic
	where	nr_seq_procedimento = nr_seq_proc_prev_p
	and	coalesce(ie_modificado,'N') <> 'S'
	order by qt_glic_inic;


C02 CURSOR FOR
	SELECT	nr_sequencia
	from	cpoe_proc_glic
	where	nr_seq_procedimento = nr_seq_proc_prev_p
	and	coalesce(ie_modificado,'N') = 'S';


BEGIN
	open C01;
	loop
	fetch C01 into
		nr_seq_procedimento_w,
		nr_seq_protocolo_w,
		qt_glic_inic_w,
		qt_glic_fim_w,
		qt_ui_insulina_w,
		qt_glicose_w,
		ds_sugestao_w,
		qt_minutos_medicao_w,
		qt_ui_insulina_int_w,
		nr_seq_proc_edit_w,
		nr_atendimento_w,
		cd_pessoa_fisica_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin

			insert into cpoe_proc_glic(
						nr_sequencia,
						nr_seq_procedimento,
						nr_seq_protocolo,
						qt_glic_inic,
						qt_glic_fim,
						qt_ui_insulina,
						qt_glicose,
						ds_sugestao,
						qt_minutos_medicao,
						qt_ui_insulina_int,
						nr_seq_proc_edit,
						nr_atendimento,
						cd_pessoa_fisica,
						nm_usuario,
						nm_usuario_nrec,
						dt_atualizacao,
						dt_atualizacao_nrec)
			values (			nextval('cpoe_proc_glic_seq'),
						nr_seq_proc_next_p,
						nr_seq_protocolo_w,
						qt_glic_inic_w,
						qt_glic_fim_w,
						qt_ui_insulina_w,
						qt_glicose_w,
						ds_sugestao_w,
						qt_minutos_medicao_w,
						qt_ui_insulina_int_w,
						nr_seq_proc_edit_w,
						nr_atendimento_w,
						cd_pessoa_fisica_w,
						nm_usuario_p,
						nm_usuario_p,
						clock_timestamp(),
						clock_timestamp());
		end;
	end loop;
	close C01;

	open C02;
	loop
	fetch C02 into
		nr_sequencia_w;
	EXIT WHEN NOT FOUND; /* apply on C02 */
		begin

			update cpoe_proc_glic
			set ie_modificado = 'N'
			where nr_sequencia = nr_sequencia_w;

		end;
	end loop;
	close C02;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cpoe_copy_protocol_glycemia ( nr_seq_proc_prev_p bigint, nr_seq_proc_next_p bigint, nm_usuario_p text) FROM PUBLIC;

