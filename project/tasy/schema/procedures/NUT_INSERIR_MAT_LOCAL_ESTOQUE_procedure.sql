-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE nut_inserir_mat_local_estoque ( nr_sequencia_p bigint, cd_local_estoque_p bigint, cd_grupo_material_p bigint, cd_subgrupo_material_p bigint, cd_classe_material_p bigint, cd_material_estoque_p bigint, nm_usuario_p text, dt_mesano_referencia_p timestamp) AS $body$
DECLARE


cd_estabelecimento_w	bigint;

BEGIN
cd_estabelecimento_w := obter_estabelecimento_ativo;

	if (cd_local_estoque_p >= 0) and (cd_grupo_material_p >= 0) and (cd_subgrupo_material_p >= 0) and (cd_classe_material_p >= 0) and (cd_material_estoque_p >= 0) and (cd_estabelecimento_w >= 0) and (nm_usuario_p IS NOT NULL AND nm_usuario_p::text <> '') then

	insert 	into  nut_local_estoque_mat(
			nr_sequencia,
			dt_atualizacao,
			nm_usuario,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			nr_seq_local,
			cd_material)
		SELECT	nextval('nut_local_estoque_mat_seq'),
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			nr_sequencia_p,
			m.cd_material
		from 	local_estoque l,
			unidade_medida u,
			Estrutura_Material_v t,
			material m,
			saldo_estoque s
		where 	m.cd_material = s.cd_material
		and 	m.cd_material = t.cd_material
		and 	u.cd_unidade_medida =  m.cd_unidade_medida_estoque
		and 	s.cd_local_estoque = l.cd_local_estoque
		and 	s.cd_estabelecimento = cd_estabelecimento_w
		and (l.cd_local_estoque =  cd_local_estoque_p or cd_local_estoque_p = 0)
		and (t.cd_grupo_material = cd_grupo_material_p or cd_grupo_material_p = 0)
		and (t.cd_subgrupo_material = cd_subgrupo_material_p or cd_subgrupo_material_p = 0)
		and (t.cd_classe_material =  cd_classe_material_p or cd_classe_material_p = 0)
		and (m.cd_material = cd_material_estoque_p or cd_material_estoque_p = 0)
		and	s.dt_mesano_referencia = dt_mesano_referencia_p
		and not exists (SELECT 	z.cd_material
				from   	nut_local_estoque_mat z
				where 	m.cd_material = z.cd_material
				AND 	z.nr_seq_local = nr_sequencia_p);

	end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE nut_inserir_mat_local_estoque ( nr_sequencia_p bigint, cd_local_estoque_p bigint, cd_grupo_material_p bigint, cd_subgrupo_material_p bigint, cd_classe_material_p bigint, cd_material_estoque_p bigint, nm_usuario_p text, dt_mesano_referencia_p timestamp) FROM PUBLIC;

