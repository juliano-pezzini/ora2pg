-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE ptu_liberar_fat_importacao ( nr_seq_ptu_fatura_p bigint, ds_erro_p INOUT text, cd_estabelecimento_p bigint, nm_usuario_p text) AS $body$
DECLARE


ds_log_w varchar(4000);
				
--verificar se nota cobranca sem nota servico
C01 CURSOR FOR
	SELECT 	nr_sequencia
	from	ptu_nota_cobranca a
	where	a.nr_seq_fatura = nr_seq_ptu_fatura_p
	and (   SELECT count(1)
		    from   ptu_nota_servico b
		    where  b.nr_seq_nota_cobr = a.nr_sequencia) = 0;
				
BEGIN

CALL pls_grava_log_proces_imp_a500('Inicio ptu_liberar_fat_importacao', nr_seq_ptu_fatura_p, nm_usuario_p);

ds_erro_p := null;
-- Colocar qualquer tratamento SEMPRE dentro do EXCEPTION
begin
update	ptu_fatura
set	ie_lib_import	= 'S',
	dt_atualizacao	= clock_timestamp(),
	nm_usuario	= nm_usuario_p,
	ie_status	= 'V'
where	nr_sequencia	= nr_seq_ptu_fatura_p;

--Caso tiver alguma nota de cobranca sem nenhuma nota de servico, vai gerar log
for	r_C01_w in C01 loop
	ds_log_w := substr('nota cobranca '||r_C01_w.nr_sequencia, 1, 4000);
	
end loop;

if (ds_log_w IS NOT NULL AND ds_log_w::text <> '') then
	insert into ptu_fatura_log values (nextval('pls_fatura_log_seq'), clock_timestamp(), nm_usuario_p, clock_timestamp(), nm_usuario_p, nr_seq_ptu_fatura_p, ds_log_w, null);
end if;

/* Atualizar os valores PTU fatura */

CALL pls_atualizar_valor_ptu_fatura(nr_seq_ptu_fatura_p,'N');

exception
when others then
	ds_erro_p := 	substr('Erro: ' || sqlerrm || pls_util_pck.enter_w ||
			'Error Back Trace: ' || dbms_utility.format_error_backtrace,1,255);
end;

commit;

CALL pls_grava_log_proces_imp_a500('Fim ptu_liberar_fat_importacao', nr_seq_ptu_fatura_p, nm_usuario_p);

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ptu_liberar_fat_importacao ( nr_seq_ptu_fatura_p bigint, ds_erro_p INOUT text, cd_estabelecimento_p bigint, nm_usuario_p text) FROM PUBLIC;

