-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE hfp_gerar_carga_exercicios ( nr_seq_avaliacao_p bigint, nm_usuario_p text) AS $body$
DECLARE



--variaveis validadas
nr_seq_etapa_w		bigint;
nr_seq_serie_w		bigint;
nr_seq_musculatura_w	bigint;
nr_seq_exercicio_w	bigint;
ds_formula_w		varchar(80);
qt_valor_w		double precision;
qt_valor_novo_w		double precision;

C01 CURSOR FOR 	-- Busca etapas a serem geradas
	SELECT	nr_sequencia
	from	hfp_etapa
	order by nr_sequencia;

C02 CURSOR FOR 	-- Busca séries a serem geradas
	SELECT	nr_sequencia
	FROM	hfp_serie
	order by nr_sequencia;

C03 CURSOR FOR 	-- Busca das musculaturas envolvidas
	SELECT	nr_seq_musc,
		qt_valor
	FROM   hfp_prescr_musc
	WHERE  nr_seq_aval = nr_seq_avaliacao_p
	ORDER BY nr_sequencia;

C04 CURSOR FOR 	-- Busca das regras envolvidas
	SELECT	nr_seq_etapa,
		nr_seq_exercicio,
		ds_formula
	FROM	hfp_regra_serie_exer
	WHERE	nr_seq_etapa = nr_seq_etapa_w
	AND 	substr(ds_formula,position('@'  ds_formula)+1,position('*' in ds_formula)-2) = nr_seq_musculatura_w
	AND	ie_situacao = 'A'
	ORDER BY nr_seq_etapa, nr_seq_exercicio;


BEGIN

-- Limpeza da tabela para gravar novos valores
delete from hfp_prescr_cargas
where nr_seq_aval = nr_seq_avaliacao_p;

if (nr_seq_avaliacao_p IS NOT NULL AND nr_seq_avaliacao_p::text <> '') then
	-- busca etapas
	open C01;
	loop
	fetch C01 into
		nr_seq_etapa_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin
		-- busca séries
		open C02;
		loop
		fetch C02 into
			nr_seq_serie_w;
		EXIT WHEN NOT FOUND; /* apply on C02 */
			begin

			-- busca musculatura envolvida
			open C03;
			loop
			fetch C03 into
				nr_seq_musculatura_w,
				qt_valor_w;
			EXIT WHEN NOT FOUND; /* apply on C03 */
				begin

				-- busca regras válidas
				open C04;
				loop
				fetch 	C04 into
					nr_seq_etapa_w,
					nr_seq_exercicio_w,
					ds_formula_w;
				EXIT WHEN NOT FOUND; /* apply on C04 */
					begin

					-- aplicar fórmula localizada
					select hfp_obter_formula_cargas(ds_formula_w, nr_seq_musculatura_w, qt_valor_w)
					into STRICT qt_valor_novo_w
					;

					INSERT INTO hfp_prescr_cargas(
						nr_sequencia,
						dt_atualizacao,
						nm_usuario,
						dt_atualizacao_nrec,
						nm_usuario_nrec,
						qt_valor,
						nr_seq_etapa,
						nr_seq_serie,
						nr_seq_exercicio,
						nr_seq_aval
					) VALUES (
						nextval('hfp_prescr_cargas_seq'),
						clock_timestamp(),
						nm_usuario_p,
						clock_timestamp(),
						nm_usuario_p,
						qt_valor_novo_w,
						nr_seq_etapa_w,
						nr_seq_serie_w,
						nr_seq_exercicio_w,
						nr_seq_avaliacao_p);
					end;
				end loop;
				close C04;

				end;
			end loop;
			close C03;

			end;
		end loop;
		close C02;

		end;
	end loop;
	close C01;

end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE hfp_gerar_carga_exercicios ( nr_seq_avaliacao_p bigint, nm_usuario_p text) FROM PUBLIC;

