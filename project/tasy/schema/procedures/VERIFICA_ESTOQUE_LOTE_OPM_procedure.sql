-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE verifica_estoque_lote_opm ( NR_SEQUENCIA_OPM_P text, NR_PRESCRICAO_P text, NM_USUARIO_P text) AS $body$
DECLARE




cd_estabelecimento_w	ordem_producao_opm.cd_estabelecimento%type;
cd_lote_fornecedor_w	ordem_producao_opm.cd_lote_fornecedor%type;
ie_estoque_lote_w	material_estab.ie_estoque_lote%type;
cd_material_w		material_estab.cd_material%type;

C01 CURSOR FOR

SELECT  cd_estabelecimento,
	substr(obter_lote_fornecedor_opm(obter_lote_op_opm(nr_sequencia),nr_sequencia),1,15),
	obter_dados_opm(nr_seq_opm,'CM')
from    ordem_producao_opm
where   ie_situacao = 'A'
and     coalesce(obter_nota_fiscal_opm(nr_sequencia)::text, '') = ''
and 	nr_seq_opm in (SELECT opm.nr_sequencia from prescr_opm opm where opm.nr_prescricao = nr_prescricao_p)
and     obter_se_contido(nr_sequencia,nr_sequencia_opm_p) = 'S';


BEGIN

open C01;
loop
fetch C01 into
	cd_estabelecimento_w,
	cd_lote_fornecedor_w,
	cd_material_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
begin

select	coalesce(max(ie_estoque_lote),'N')
into STRICT	ie_estoque_lote_w
from	material_estab
where	cd_material = cd_material_w
and	cd_estabelecimento = cd_estabelecimento_w;

if (ie_estoque_lote_w = 'S') and (coalesce(cd_lote_fornecedor_w::text, '') = '') then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(174103,'CD_MATERIAL_ESTOQUE='||cd_material_w);
	/*r.aise_application_error(-20011,'Este material tem estoque por lote fornecedor.' || chr(13) ||
					'Somente pode ser movimentado por barras do lote. (' || :new.cd_material_estoque || ')' || chr(13));*/
end if;

	end;
end loop;
close C01;


end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE verifica_estoque_lote_opm ( NR_SEQUENCIA_OPM_P text, NR_PRESCRICAO_P text, NM_USUARIO_P text) FROM PUBLIC;

