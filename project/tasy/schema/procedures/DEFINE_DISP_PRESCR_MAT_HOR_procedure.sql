-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE define_disp_prescr_mat_hor ( nr_seq_horario_p bigint, nr_prescricao_p bigint, nr_seq_material_p bigint, cd_perfil_p bigint, nm_usuario_p text, ie_setor_atendimento_p text default 'N', ie_setor_lote_p text default 'N') AS $body$
DECLARE


dt_horario_w			timestamp;
nr_regras_w			integer;
cd_material_w			integer;
nr_sequencia_w			integer;
cd_local_estoque_w		integer;
cd_local_estoque_prescr_w	integer;
cd_loc_estoque_w		integer;
cd_grupo_material_w		smallint;
cd_subgrupo_w			smallint;
cd_classe_material_w		integer;
cd_setor_atendimento_w		integer;
cd_setor_atendimento_regra_w    prescr_medica.cd_setor_atendimento%type;
cd_estabelecimento_w		smallint;
nr_seq_classif_w		bigint;
nr_seq_regra_disp_w		bigint;
ie_dia_semana_w			varchar(01);
ie_setor_atual_w		varchar(01);
ie_via_aplicacao_w		varchar(10);
dt_liberacao_w			timestamp;
nr_seq_familia_w		bigint;
ie_urgencia_W			varchar(1);
ie_motivo_prescricao_w		varchar(10);
qt_total_dispensar_w		double precision;
ie_padronizado_w		varchar(1);
nr_atendimento_w		bigint;
cd_convenio_w			integer	:= 0;
ie_tipo_convenio_w		smallint	:= 0;
ie_feriado_w			varchar(01);
qt_feriado_w			bigint 	:= 0;
ie_acm_sn_w			varchar(1);
ie_controlado_w			varchar(1);
ie_acm_w			varchar(1);
ie_se_necessario_w		varchar(1);
cd_unidade_medida_w		varchar(30);
ie_local_estoque_kit_w		varchar(1);
ie_local_estoque_dil_w		varchar(1);
nr_seq_forma_chegada_w		bigint;
ie_tipo_hemodialise_w		varchar(60);
ie_tipo_atendimento_w		smallint;
ie_dose_especial_w		varchar(1);
cd_material_generico_w		integer;
nr_regra_local_disp_w		bigint;
cd_material_comercial_w		material.cd_material%type;
qt_dose_w			prescr_material.qt_dose%type;
qt_volume_w			varchar(60);
nr_seq_estrut_int_w		regra_local_dispensacao.nr_seq_estrut_int%type;
ie_existe_regra_w		varchar(15);
cd_intervalo_w			intervalo_prescricao.cd_intervalo%type;
ie_intervalo_hor_w		varchar(1);
ie_gerar_lote_manipulacao_w	material_diluicao.ie_gerar_lote_manipulacao%type;
nr_seq_material_w		prescr_material.nr_sequencia%type;
ie_classif_urgente_w		classif_lote_disp_far.ie_classif_urgente%type;
ie_so_com_estoque_w 		regra_local_dispensacao.ie_so_com_estoque%type;
cd_local_estoque_ww		regra_local_dispensacao.cd_local_estoque%type;
nr_regra_local_disp_ww		regra_local_dispensacao.nr_sequencia%type;
nr_seq_regra_disp_ww		regra_local_dispensacao.nr_seq_regra_disp%type;
ie_atualiza_regra_local_kit_w	varchar(1);
nr_seq_kit_w				prescr_material.nr_seq_kit%type;
nr_sequencia_diluicao_w		prescr_material.nr_sequencia_diluicao%type;
nr_seq_recomendacao_w		prescr_material.nr_seq_recomendacao%type;
nr_agrupamento_w		prescr_material.nr_agrupamento%type;
ie_item_superior_w		prescr_material.ie_item_superior%type;
ie_emergencia_w prescr_medica.ie_emergencia%type;
ie_saldo_generico_w		varchar(1);
ie_type_of_prescription_w   regra_local_dispensacao.ie_type_of_prescription%type := '##'; --JRS712
qt_conv_estoque_consumo_w	material.qt_conv_estoque_consumo%type;
qt_dispensar_w				double precision;
qt_total_disp_item_w		double precision;
nr_seq_local_pa_w           atendimento_paciente.nr_seq_local_pa%type;
ie_termolabil_w				material.ie_termolabil%type;
ie_setor_procedimento_w		varchar(1);
cd_setor_proced_w			prescr_procedimento.cd_setor_atendimento%type;

C01 CURSOR FOR
	SELECT	c.nr_seq_superior,
		a.cd_material,
		coalesce(a.ie_urgencia,'N'),
		dividir(a.qt_total_dispensar,b.qt_conv_estoque_consumo),
		b.qt_conv_estoque_consumo,
		substr(obter_se_material_padronizado(k.cd_estabelecimento,a.cd_material),1,1),
		substr(obter_se_medic_controlado(a.cd_material),1,1),
		coalesce(a.ie_acm, 'N'),
		coalesce(a.ie_se_necessario, 'N'),
		a.cd_unidade_medida_dose,
		a.ie_via_aplicacao,
		c.nr_seq_classif,
		coalesce(C.ie_dose_especial,'N'),
		b.cd_material_generico,
		a.qt_dose,
		obter_volume_dil_regra_local(a.nr_prescricao, a.nr_sequencia),
		a.cd_intervalo,
		c.nr_seq_material,
		a.nr_seq_kit,
		a.nr_sequencia_diluicao,
		a.nr_seq_recomendacao,
		a.nr_agrupamento,
		a.ie_item_superior,
		b.ie_termolabil
	from	material b,
		prescr_material a,
		prescr_mat_hor c,
		prescr_medica k
	where	k.nr_prescricao		= nr_prescricao_p
	and	a.nr_sequencia 		= c.nr_seq_material
	and	a.nr_prescricao 	= c.nr_prescricao
	and	c.nr_sequencia 		= nr_seq_horario_p
	and	k.nr_prescricao		= a.nr_prescricao
	and	a.cd_material		= b.cd_material;

C02 CURSOR FOR
	SELECT	cd_local_estoque,
		nr_sequencia,
		nr_seq_regra_disp,
		coalesce(ie_so_com_estoque,'N'),
		coalesce(ie_saldo_generico,'N')
	from	regra_local_dispensacao
	where	cd_estabelecimento					= cd_estabelecimento_w
	and	coalesce(cd_setor_atendimento, coalesce(cd_setor_atendimento_w,0))		= coalesce(cd_setor_atendimento_w,0)
	and	coalesce(cd_grupo_material, coalesce(cd_grupo_material_w,0))				= coalesce(cd_grupo_material_w,0)
	and	coalesce(cd_subgrupo_material, coalesce(cd_subgrupo_w,0))					= coalesce(cd_subgrupo_w,0)
	and	coalesce(cd_classe_material, coalesce(cd_classe_material_w,0))			= coalesce(cd_classe_material_w,0)
	and	coalesce(cd_material, coalesce(cd_material_w,0))							= coalesce(cd_material_w,0)
	and	coalesce(cd_perfil, cd_perfil_p)				= cd_perfil_p
	and	coalesce(cd_convenio, cd_convenio_w)									= coalesce(cd_convenio_w,0)
	and	coalesce(nr_seq_classif, coalesce(nr_seq_classif_w,0))		= coalesce(nr_seq_classif_w,0)
	and	coalesce(ie_motivo_prescricao, coalesce(ie_motivo_prescricao_w,'XPT'))	= coalesce(ie_motivo_prescricao_w,'XPT')
	and	((coalesce(ie_motivo_prescr_exc::text, '') = '') or (ie_motivo_prescr_exc <> ie_motivo_prescricao_w))
	and	((coalesce(ie_dose_especial,'N') = 'N') or (coalesce(ie_dose_especial,'N') = 'S' and (coalesce(ie_dose_especial_w,'N') = 'S')))
	and	coalesce(ie_tipo_convenio, ie_tipo_convenio_w)		= ie_tipo_convenio_w
	and (coalesce(ie_type_of_prescription, ie_type_of_prescription_w) = ie_type_of_prescription_w OR coalesce(pkg_i18n.get_user_locale, 'pt_BR') <> 'ja_JP')  --JRS712
	and	coalesce(nr_seq_forma_chegada, coalesce(nr_seq_forma_chegada_w,0))		= coalesce(nr_seq_forma_chegada_w,0)
	and	coalesce(ie_tipo_atendimento, coalesce(ie_tipo_atendimento_w,0))			= coalesce(ie_tipo_atendimento_w,0)
	and	((coalesce(ie_via_aplicacao::text, '') = '') or (ie_via_aplicacao = ie_via_aplicacao_w))
	and	((coalesce(ie_agora,'N') = ie_urgencia_w) or (coalesce(ie_agora,'N') = 'N'))
	and	((coalesce(ie_nao_padronizado,'N') = 'N') or (coalesce(ie_padronizado_w,'S') = 'N'))
	and	((coalesce(ie_controlado,'A') = 'A') or (coalesce(ie_controlado, 'A') = ie_controlado_w))
	and	coalesce(cd_unidade_medida, cd_unidade_medida_w)	= cd_unidade_medida_w
  and	((coalesce(ie_considerar_emergencia,'S') = 'S') or (coalesce(ie_emergencia_w,'N') = 'N'))
	--and	((nvl(ie_so_com_estoque,'N') = 'N')  or (obter_saldo_disp_estoque(cd_estabelecimento_w,cd_material_w,cd_local_estoque,sysdate) >= qt_total_dispensar_w))
	and	((coalesce(nr_seq_familia, nr_seq_familia_w)			= nr_seq_familia_w) or (coalesce(nr_seq_familia::text, '') = ''))
	and	((coalesce(ie_dia_semana::text, '') = '') or (ie_dia_semana = ie_dia_semana_w or ie_dia_semana = 9))
	and	obter_se_lib_prescr_horario(dt_hora_inicio, dt_hora_fim, dt_horario_w) = 'S'
	and	(((coalesce(ie_feriado,'N') = ie_feriado_w) and (coalesce(ie_feriado,'N') = 'S')) or
		((coalesce(ie_feriado,'N') = 'N') and (qt_feriado_w = 0)))
	and	(((coalesce(ie_somente_acmsn,'N') = 'G') and ((ie_acm_w = 'S') or (ie_se_necessario_w = 'S') or (ie_urgencia_w = 'S'))) or
		((coalesce(ie_somente_acmsn,'N') = 'S') and ((ie_acm_w = 'S') or (ie_se_necessario_w = 'S'))) or
		((coalesce(ie_somente_acmsn,'N') = 'A') and (ie_acm_w = 'S') and (ie_se_necessario_w = 'N')) or
		((coalesce(ie_somente_acmsn,'N') = 'C') and (ie_acm_w = 'N') and (ie_se_necessario_w = 'S')) or
		((coalesce(ie_somente_acmsn,'N') = 'I') and ((ie_acm_w = 'S') or (ie_se_necessario_w = 'S')) and (coalesce(ie_intervalo_hor_w,'S') = 'S') and (ie_classif_urgente_w <> 'A')) or
		((coalesce(ie_somente_acmsn,'N') = 'H') and ((ie_acm_w = 'S') or (ie_se_necessario_w = 'S') or (ie_urgencia_w = 'S')) and (ie_classif_urgente_w = 'A')) or (coalesce(ie_somente_acmsn,'N') = 'N'))
	and	((coalesce(nr_seq_estrut_int, 0) = 0) or ((coalesce(nr_seq_estrut_int,0) > 0) and consistir_se_mat_contr_estrut(nr_seq_estrut_int,cd_material_w) = 'S'))
	and	((coalesce(ie_tipo_hemodialise::text, '') = '') or (ie_tipo_hemodialise = ie_tipo_hemodialise_w))
	and	(( coalesce(ie_considerar_padrao_est,'N') = 'N' or (obter_se_mat_existe_padrao_loc(cd_material_w,cd_local_estoque) = 'S' or (coalesce(ie_considerar_controlador,'N') = 'S' and obter_se_mat_existe_padrao_loc((SELECT x.cd_material_estoque from material x where x.cd_material = cd_material_w), cd_local_estoque) = 'S') or
		(coalesce(ie_considerar_generico,'N') = 'S'
		and ((coalesce(ie_considerar_generico_assosc,'N') = 'S' and obter_associados_generico(cd_material_generico_w, cd_local_estoque) = 'S') or (coalesce(ie_considerar_generico_assosc,'N') = 'N' and obter_se_mat_existe_padrao_loc(cd_material_generico_w, cd_local_estoque) = 'S'))))))
	and 	((coalesce(ie_medic_alto_custo,'N') = 'N') or obter_se_mat_alto_custo(cd_material_w, cd_estabelecimento_w) = 'S')
	and	((coalesce(qt_dose::text, '') = '') or (qt_dose = qt_dose_w))
	and	((coalesce(qt_volume::text, '') = '') or (to_char(qt_volume) = qt_volume_w))
	and	((coalesce(ie_gerar_lote_manipulacao, 'A') = 'A') or (coalesce(ie_gerar_lote_manipulacao,'S') = coalesce(ie_gerar_lote_manipulacao_w, 'S')))
	and  ((coalesce(nr_seq_localizacao::text, '') = '') or (nr_seq_localizacao = nr_seq_local_pa_w))
	and (coalesce(ie_medic_termolabil,'N') = 'N' or (coalesce(ie_medic_termolabil,'N') = 'S' and coalesce(ie_termolabil_w,'N') = 'S'))
	order by coalesce(NR_SEQ_PRIORIDADE,999) desc,
		coalesce(cd_material,0),
		coalesce(cd_classe_material,0),
		coalesce(cd_subgrupo_material,0),
		coalesce(cd_grupo_material,0),
		coalesce(nr_seq_familia,0),
		coalesce(ie_via_aplicacao,obter_via_usuario('A')),
		coalesce(cd_setor_atendimento,0),
		coalesce(ie_agora,'N'),
		coalesce(ie_nao_padronizado,'N'),
		coalesce(ie_feriado,'N'),
		coalesce(ie_dose_especial,'N'),
		coalesce(nr_seq_localizacao,0);

c03 CURSOR FOR
	SELECT	cd_material
	from	material
	where	ie_situacao = 'A'
	and	cd_material <> cd_material_w
	and	cd_material_generico = cd_material_w
	
union

	SELECT	cd_material
	from	material
	where	ie_situacao = 'A'
	and	cd_material <> obter_material_generico(cd_material_w)
	and	cd_material_generico = obter_material_generico(cd_material_w);

-- Busca regras somente onde possui a estrutura interna informada.
c04 CURSOR FOR
	SELECT	cd_local_estoque,
		nr_sequencia,
		nr_seq_regra_disp,
		coalesce(ie_so_com_estoque,'N'),
		coalesce(ie_saldo_generico,'N')
	from	regra_local_dispensacao
	where	cd_estabelecimento					= cd_estabelecimento_w
	and	coalesce(cd_setor_atendimento, cd_setor_atendimento_w)	= cd_setor_atendimento_w
	and	coalesce(cd_grupo_material, cd_grupo_material_w)		= cd_grupo_material_w
	and	coalesce(cd_subgrupo_material, cd_subgrupo_w)		= cd_subgrupo_w
	and	coalesce(cd_classe_material, cd_classe_material_w)		= cd_classe_material_w
	and	coalesce(cd_material, cd_material_comercial_w)		= cd_material_comercial_w
	and	coalesce(cd_perfil, cd_perfil_p)				= cd_perfil_p
	and	coalesce(cd_convenio, cd_convenio_w)				= cd_convenio_w
	and	coalesce(nr_seq_classif, coalesce(nr_seq_classif_w,0))		= coalesce(nr_seq_classif_w,0)
	and	coalesce(ie_motivo_prescricao, coalesce(ie_motivo_prescricao_w,'XPT'))	= coalesce(ie_motivo_prescricao_w,'XPT')
	and	((coalesce(ie_motivo_prescr_exc::text, '') = '') or (ie_motivo_prescr_exc <> ie_motivo_prescricao_w))
	and	((coalesce(ie_dose_especial,'N') = 'N') or (coalesce(ie_dose_especial,'N') = 'S' and (coalesce(ie_dose_especial_w,'N') = 'S')))
	and	coalesce(ie_tipo_convenio, ie_tipo_convenio_w)		= ie_tipo_convenio_w
	and (coalesce(ie_type_of_prescription, ie_type_of_prescription_w) = ie_type_of_prescription_w OR coalesce(pkg_i18n.get_user_locale, 'pt_BR') <> 'ja_JP')  --JRS712
	and	coalesce(nr_seq_forma_chegada, nr_seq_forma_chegada_w)	= nr_seq_forma_chegada_w
	and	coalesce(ie_tipo_atendimento, ie_tipo_atendimento_w)			= ie_tipo_atendimento_w
	and	((coalesce(ie_via_aplicacao::text, '') = '') or (ie_via_aplicacao = ie_via_aplicacao_w))
	and	((coalesce(ie_agora,'N') = ie_urgencia_w) or (coalesce(ie_agora,'N') = 'N'))
	and	((coalesce(ie_nao_padronizado,'N') = 'N') or (coalesce(ie_padronizado_w,'S') = 'N'))
	and	((coalesce(ie_controlado,'A') = 'A') or (coalesce(ie_controlado, 'A') = ie_controlado_w))
	and	coalesce(cd_unidade_medida, cd_unidade_medida_w)	= cd_unidade_medida_w
  and	((coalesce(ie_considerar_emergencia,'S') = 'S') or (coalesce(ie_emergencia_w,'N') = 'N'))
	--and	((nvl(ie_so_com_estoque,'N') = 'N')  or (obter_saldo_disp_estoque(cd_estabelecimento_w,cd_material_comercial_w,cd_local_estoque,sysdate) >= qt_total_dispensar_w))
	and	((coalesce(nr_seq_familia, nr_seq_familia_w) = nr_seq_familia_w) or (coalesce(nr_seq_familia::text, '') = ''))
	and	((coalesce(ie_dia_semana::text, '') = '') or (ie_dia_semana = ie_dia_semana_w or ie_dia_semana = 9))
	and	obter_se_lib_prescr_horario(dt_hora_inicio, dt_hora_fim, dt_horario_w) = 'S'
	and	(((coalesce(ie_feriado,'N') = ie_feriado_w) and (coalesce(ie_feriado,'N') = 'S')) or
		((coalesce(ie_feriado,'N') = 'N') and (qt_feriado_w = 0)))
	and	(((coalesce(ie_somente_acmsn,'N') = 'G') and ((ie_acm_w = 'S') or (ie_se_necessario_w = 'S') or (ie_urgencia_w = 'S'))) or
		((coalesce(ie_somente_acmsn,'N') = 'S') and ((ie_acm_w = 'S') or (ie_se_necessario_w = 'S'))) or
		((coalesce(ie_somente_acmsn,'N') = 'A') and (ie_acm_w = 'S') and (ie_se_necessario_w = 'N')) or
		((coalesce(ie_somente_acmsn,'N') = 'C') and (ie_acm_w = 'N') and (ie_se_necessario_w = 'S')) or
		((coalesce(ie_somente_acmsn,'N') = 'I') and ((ie_acm_w = 'S') or (ie_se_necessario_w = 'S')) and (coalesce(ie_intervalo_hor_w,'S') = 'S') and (ie_classif_urgente_w <> 'A')) or
		((coalesce(ie_somente_acmsn,'N') = 'H') and ((ie_acm_w = 'S') or (ie_se_necessario_w = 'S') or (ie_urgencia_w = 'S')) and (ie_classif_urgente_w = 'A')) or (coalesce(ie_somente_acmsn,'N') = 'N'))
	and	((coalesce(nr_seq_estrut_int,0) >0) and (consistir_se_mat_contr_estrut(nr_seq_estrut_int,cd_material_comercial_w) = 'S'))
	and	((coalesce(ie_tipo_hemodialise::text, '') = '') or (ie_tipo_hemodialise = ie_tipo_hemodialise_w))
	and	(( coalesce(ie_considerar_padrao_est,'N') = 'N' or (obter_se_mat_existe_padrao_loc(cd_material_w,cd_local_estoque) = 'S' or (coalesce(ie_considerar_controlador,'N') = 'S' and obter_se_mat_existe_padrao_loc((SELECT x.cd_material_estoque from material x where x.cd_material = cd_material_w), cd_local_estoque) = 'S') or
		(coalesce(ie_considerar_generico,'N') = 'S'
		and ((coalesce(ie_considerar_generico_assosc,'N') = 'S' and obter_associados_generico(cd_material_generico_w, cd_local_estoque) = 'S') or (coalesce(ie_considerar_generico_assosc,'N') = 'N' and obter_se_mat_existe_padrao_loc(cd_material_generico_w, cd_local_estoque) = 'S'))))))
	and 	((coalesce(ie_medic_alto_custo,'N') = 'N') or obter_se_mat_alto_custo(cd_material_w, cd_estabelecimento_w) = 'S')
	and	((coalesce(qt_dose::text, '') = '') or (qt_dose = qt_dose_w))
	and	((coalesce(qt_volume::text, '') = '') or (to_char(qt_volume) = qt_volume_w))
	and	((coalesce(ie_gerar_lote_manipulacao, 'A') = 'A') or (coalesce(ie_gerar_lote_manipulacao,'S') = coalesce(ie_gerar_lote_manipulacao_w, 'S')))
	and  ((coalesce(nr_seq_localizacao::text, '') = '') or (nr_seq_localizacao = nr_seq_local_pa_w))
	and (coalesce(ie_medic_termolabil,'N') = 'N' or (coalesce(ie_medic_termolabil,'N') = 'S' and coalesce(ie_termolabil_w,'N') = 'S'))
	order by coalesce(NR_SEQ_PRIORIDADE,999) desc,
		coalesce(cd_material,0),
		coalesce(cd_classe_material,0),
		coalesce(cd_subgrupo_material,0),
		coalesce(cd_grupo_material,0),
		coalesce(nr_seq_familia,0),
		coalesce(ie_via_aplicacao,obter_via_usuario('A')),
		coalesce(cd_setor_atendimento,0),
		coalesce(ie_agora,'N'),
		coalesce(ie_nao_padronizado,'N'),
		coalesce(ie_feriado,'N'),
		coalesce(ie_dose_especial,'N'),
		coalesce(nr_seq_localizacao,0);

c99 CURSOR FOR
	SELECT	distinct nr_seq_estrut_int
	from	regra_local_dispensacao
	where	coalesce(nr_seq_estrut_int,0) > 0
	and	cd_estabelecimento = cd_estabelecimento_w;


BEGIN

---

/*IF upper(nm_usuario_p) = upper('lraju') Then
   ie_type_of_prescription_w := 'INPAT';
end if;*/

---
ie_setor_atual_w := obter_Param_Usuario(924, 799, cd_perfil_p, nm_usuario_p, cd_estabelecimento_w, ie_setor_atual_w);
ie_setor_procedimento_w := obter_param_usuario(924, 1188, cd_perfil_p, nm_usuario_p, cd_estabelecimento_w, ie_setor_procedimento_w);

select	max(dt_horario)
into STRICT	dt_horario_w
from	prescr_mat_hor
where	nr_sequencia = nr_seq_horario_p;

select	max(cd_setor_atendimento),
	max(coalesce(cd_estabelecimento, 1)),
	max(coalesce(coalesce(dt_liberacao_medico, dt_liberacao), clock_timestamp())),
	max(coalesce(cd_local_estoque, 0)),
	max(coalesce(nr_atendimento, 0)),
	max(ie_motivo_prescricao),
  coalesce(max(ie_emergencia), 'N')
into STRICT	cd_setor_atendimento_w,
	cd_estabelecimento_w,
	dt_liberacao_w,
	cd_local_estoque_prescr_w,
	nr_atendimento_w,
	ie_motivo_prescricao_w,
  ie_emergencia_w
from	prescr_medica
where	nr_prescricao		= nr_prescricao_p;

select  max(ie_tipo_hemodialise)
into STRICT	ie_tipo_hemodialise_w
from	prescr_solucao a,
	prescr_material b,
	hd_prescricao c
where 	b.nr_sequencia_solucao		= a.nr_seq_solucao
and	a.nr_prescricao		   	= b.nr_prescricao
and	a.nr_seq_dialise	   	= c.nr_sequencia
and	b.nr_prescricao 	   	= nr_prescricao_p
and 	coalesce(ie_hemodialise,'N')		= 'S';

if (ie_setor_atual_w = 'S') then
	cd_local_estoque_prescr_w	:= null;
	cd_setor_atendimento_w		:= obter_setor_atendimento(nr_atendimento_w);
elsif (ie_setor_atual_w = 'R') then
	cd_local_estoque_prescr_w	:= null;
	cd_setor_atendimento_w		:= Obter_Setor_Atendimento_lib(nr_atendimento_w);
elsif (ie_setor_atual_w = 'I') then
	cd_local_estoque_prescr_w := null;
	cd_setor_atendimento_w := obter_setor_atepacu(obter_atepacu_paciente(nr_atendimento_w,'IA'),0);
elsif (ie_setor_atual_w = 'N') and (ie_setor_atendimento_p = 'S') and (ie_setor_lote_p = 'S') and (nr_atendimento_w > 0) then
	cd_local_estoque_prescr_w	:= null;
	cd_setor_atendimento_w		:= obter_setor_atendimento(nr_atendimento_w);
end if;

cd_setor_atendimento_regra_w := cd_setor_atendimento_w;

if (nr_atendimento_w > 0) then

	select	coalesce(max(ie_tipo_convenio), 0),
		coalesce(max(nr_seq_forma_chegada), 0),
		coalesce(max(ie_tipo_atendimento),0),
		coalesce(max(nr_seq_local_pa),0)
	into STRICT	ie_tipo_convenio_w,
		nr_seq_forma_chegada_w,
		ie_tipo_atendimento_w,
		nr_seq_local_pa_w
	from	atendimento_paciente
	where	nr_atendimento = nr_atendimento_w;

	cd_convenio_w	:= coalesce(obter_convenio_atendimento(nr_atendimento_w),0);

end if;

if (cd_local_estoque_prescr_w > 0) then
	update	prescr_material
	set	cd_local_estoque	= cd_local_estoque_prescr_w,
		nm_usuario		= nm_usuario_p
	where	nr_prescricao		= nr_prescricao_p
	and	coalesce(cd_motivo_baixa,0)	= 0
	and	((coalesce(nr_seq_material_p,0) = 0) or (nr_sequencia	   	= nr_seq_material_p) or (nr_sequencia_diluicao = nr_seq_material_p)or (nr_seq_kit  		= nr_seq_material_p));

	if (coalesce(wheb_usuario_pck.get_ie_commit, 'S') = 'S') then commit; end if;
else
	begin
	select	max(pkg_date_utils.get_WeekDay(dt_horario_w))
	into STRICT	ie_dia_semana_w
	;

	if (coalesce(wheb_usuario_pck.get_ie_commit, 'S') = 'S') then commit; end if;

	select	max(coalesce(CASE WHEN obter_se_feriado(cd_estabelecimento_w, dt_horario_w)=0 THEN 'N'  ELSE 'S' END ,'N'))
	into STRICT	ie_feriado_w
	;

	begin
	select	max(cd_local_estoque)
	into STRICT	cd_loc_estoque_w
	from	setor_atendimento
	where	cd_setor_atendimento	= cd_setor_atendimento_w;
	exception
	when others then
		cd_loc_estoque_w	:= null;
	end;

	if (coalesce(wheb_usuario_pck.get_ie_commit, 'S') = 'S') then commit; end if;

	select	count(*)
	into STRICT	nr_regras_w
	from	regra_local_dispensacao
	where	cd_estabelecimento = cd_estabelecimento_w;

	if (nr_regras_w > 0) then
		begin
		open c01;
		loop
		fetch c01 into
			nr_sequencia_w,
			cd_material_w,
			ie_urgencia_W,
			qt_total_dispensar_w,
			qt_conv_estoque_consumo_w,
			ie_padronizado_w,
			ie_controlado_w,
			ie_acm_w,
			ie_se_necessario_w,
			cd_unidade_medida_w,
			ie_via_aplicacao_w,
			nr_seq_classif_w,
			ie_dose_especial_w,
			cd_material_generico_w,
			qt_dose_w,
			qt_volume_w,
			cd_intervalo_w,
			nr_seq_material_w,
			nr_seq_kit_w,
			nr_sequencia_diluicao_w,
			nr_seq_recomendacao_w,
			nr_agrupamento_w,
			ie_item_superior_w,
			ie_termolabil_w;
		EXIT WHEN NOT FOUND; /* apply on c01 */
        --JRS712 starts
		cd_setor_atendimento_w := cd_setor_atendimento_regra_w;
        ie_type_of_prescription_w := '##';
        begin
          select coalesce(c.SI_TYPE_OF_PRESCRIPTION,'##') into STRICT ie_type_of_prescription_w
          from prescr_material a, cpoe_material b, cpoe_order_unit c 
            where b.NR_SEQ_CPOE_ORDER_UNIT = c.nr_sequencia 
              and b.nr_sequencia = a.nr_seq_mat_cpoe
              and a.nr_sequencia = nr_sequencia_w
              and a.nr_prescricao = nr_prescricao_p;
        exception
          when others then
            ie_type_of_prescription_w := '##';
        end;
        --JRS712 ends
			begin
			
			if (ie_setor_procedimento_w = 'S') then
				select	coalesce(max(b.cd_setor_atendimento),0)
				into STRICT	cd_setor_proced_w
				from	prescr_procedimento b,
						prescr_material a
				where 	a.nr_prescricao = b.nr_prescricao
				and 	a.nr_sequencia_proc = b.nr_sequencia
				and 	a.nr_prescricao = nr_prescricao_p
				and 	a.nr_sequencia = nr_seq_material_w;
			
				if (cd_setor_proced_w > 0) then
					cd_setor_atendimento_w := cd_setor_proced_w;
					
					begin
					select	max(cd_local_estoque)
					into STRICT	cd_loc_estoque_w
					from	setor_atendimento
					where	cd_setor_atendimento = cd_setor_atendimento_w;
					exception
					when others then
						cd_loc_estoque_w := null;
					end;
				end if;
			end if;
			
			select	max(ie_gerar_lote_manipulacao)
			into STRICT	ie_gerar_lote_manipulacao_w
			from	material_diluicao b
			where  	b.cd_material = cd_material_w
			and	exists (
				SELECT	1
				from	prescr_material x
				where	x.nr_prescricao = nr_prescricao_p
				and	x.nr_sequencia_diluicao = nr_seq_material_w
				and	x.nr_seq_mat_diluicao = b.nr_sequencia);

			if (coalesce(wheb_usuario_pck.get_ie_commit, 'S') = 'S') then commit; end if;

			cd_local_estoque_w := 0;

			select	max(cd_grupo_material),
				max(cd_subgrupo_material),
				max(cd_classe_material),
				max(nr_seq_familia)
			into STRICT	cd_grupo_material_w,
				cd_subgrupo_w,
				cd_classe_material_w,
				nr_seq_familia_w
			from	estrutura_material_v
			where 	cd_material	= cd_material_w;

			select	coalesce(max('S'),'N')
			into STRICT	ie_intervalo_hor_w
			from	intervalo_prescricao
			where	cd_intervalo = cd_intervalo_w
			and	ie_acm <> 'S'
			and	ie_se_necessario <> 'S';

			select	max(ie_classif_urgente)
			into STRICT	ie_classif_urgente_w
			from	classif_lote_disp_far
			where	nr_sequencia = nr_seq_classif_w;
			
			qt_dispensar_w := qt_total_dispensar_w;	
	
			begin
				select	coalesce(dividir(sum(a.qt_dispensar_hor),qt_conv_estoque_consumo_w),qt_total_dispensar_w)
				into STRICT	qt_total_disp_item_w
				from	prescr_mat_hor a
				where 	a.nr_prescricao = nr_prescricao_p
				and 	a.nr_seq_material = nr_seq_material_w;
			exception
			when others then
				qt_dispensar_w := qt_total_dispensar_w;	
			end;
			
			if (qt_total_disp_item_w <= qt_total_dispensar_w) then
				qt_dispensar_w := qt_total_disp_item_w;
			end if;

			if (coalesce(wheb_usuario_pck.get_ie_commit, 'S') = 'S') then commit; end if;

			if (ie_feriado_w = 'S') then
				select	count(*)
				into STRICT	qt_feriado_w
				from	regra_local_dispensacao
				where	cd_estabelecimento					= cd_estabelecimento_w
				and	coalesce(cd_setor_atendimento, cd_setor_atendimento_w)	= cd_setor_atendimento_w
				and	coalesce(cd_grupo_material, cd_grupo_material_w)		= cd_grupo_material_w
				and	coalesce(cd_subgrupo_material, cd_subgrupo_w)		= cd_subgrupo_w
				and	coalesce(cd_classe_material, cd_classe_material_w)		= cd_classe_material_w
				and	coalesce(cd_material, cd_material_w)				= cd_material_w
				and	coalesce(cd_perfil, cd_perfil_p)				= cd_perfil_p
				and	coalesce(cd_convenio, cd_convenio_w)				= cd_convenio_w
				and	coalesce(nr_seq_classif, coalesce(nr_seq_classif_w,0))		= coalesce(nr_seq_classif_w,0)
				and	((coalesce(ie_via_aplicacao::text, '') = '') or (ie_via_aplicacao 	= ie_via_aplicacao_w))
				and (coalesce(ie_type_of_prescription, ie_type_of_prescription_w) = ie_type_of_prescription_w OR coalesce(pkg_i18n.get_user_locale, 'pt_BR') <> 'ja_JP')  --JRS712
				and	coalesce(ie_tipo_convenio, ie_tipo_convenio_w)		= ie_tipo_convenio_w
				and	coalesce(nr_seq_forma_chegada, nr_seq_forma_chegada_w)	= nr_seq_forma_chegada_w
				and	((coalesce(ie_agora,'N') = ie_urgencia_w) or (coalesce(ie_agora,'N') = 'N'))
				and	coalesce(ie_motivo_prescricao, coalesce(ie_motivo_prescricao_w,'XPT'))	= coalesce(ie_motivo_prescricao_w,'XPT')
				and	((coalesce(ie_motivo_prescr_exc::text, '') = '') or (ie_motivo_prescr_exc <> ie_motivo_prescricao_w))
				and	((coalesce(ie_nao_padronizado,'N') = 'N') or (coalesce(ie_padronizado_w,'S') = 'N'))
				and	((coalesce(ie_controlado,'A') = 'A') or (coalesce(ie_controlado, 'A') = ie_controlado_w))
        and	((coalesce(ie_considerar_emergencia,'S') = 'S') or (coalesce(ie_emergencia_w,'N') = 'N'))
				and	((coalesce(ie_so_com_estoque,'N') = 'N')  or (obter_saldo_disp_estoque(cd_estabelecimento_w,cd_material_w,cd_local_estoque,clock_timestamp()) >= qt_dispensar_w))
				and	((coalesce(nr_seq_familia, nr_seq_familia_w)			= nr_seq_familia_w) or (coalesce(nr_seq_familia::text, '') = ''))
				and	((coalesce(ie_dia_semana::text, '') = '') or (ie_dia_semana = ie_dia_semana_w or ie_dia_semana = 9))
				and	obter_se_lib_prescr_horario(dt_hora_inicio, dt_hora_fim, dt_horario_w) = 'S'
				and	coalesce(ie_feriado,'N') = 'S'
				and	(((coalesce(ie_somente_acmsn,'N') = 'G') and ((ie_acm_w = 'S') or (ie_se_necessario_w = 'S') or (ie_urgencia_w = 'S'))) or
					((coalesce(ie_somente_acmsn,'N') = 'S') and ((ie_acm_w = 'S') or (ie_se_necessario_w = 'S'))) or
					((coalesce(ie_somente_acmsn,'N') = 'A') and (ie_acm_w = 'S') and (ie_se_necessario_w = 'N')) or
					((coalesce(ie_somente_acmsn,'N') = 'C') and (ie_acm_w = 'N') and (ie_se_necessario_w = 'S')) or
					((coalesce(ie_somente_acmsn,'N') = 'I') and ((ie_acm_w = 'S') or (ie_se_necessario_w = 'S')) and (coalesce(ie_intervalo_hor_w,'S') = 'S') and (ie_classif_urgente_w <> 'A')) or
					((coalesce(ie_somente_acmsn,'N') = 'H') and ((ie_acm_w = 'S') or (ie_se_necessario_w = 'S') or (ie_urgencia_w = 'S')) and (ie_classif_urgente_w = 'A')) or (coalesce(ie_somente_acmsn,'N') = 'N'))
				and	((coalesce(nr_seq_estrut_int::text, '') = '') or ((nr_seq_estrut_int IS NOT NULL AND nr_seq_estrut_int::text <> '') and consistir_se_mat_contr_estrut(nr_seq_estrut_int,cd_material_w) = 'S'))
				and	((coalesce(ie_tipo_hemodialise::text, '') = '') or (ie_tipo_hemodialise = ie_tipo_hemodialise_w))
				and (coalesce(ie_considerar_generico,'N') = 'N' or obter_se_mat_existe_padrao_loc(cd_material_generico_w, cd_local_estoque) = 'S')
				and	((coalesce(qt_dose::text, '') = '') or (qt_dose = qt_dose_w))
				and	((coalesce(qt_volume::text, '') = '') or (to_char(qt_volume) = qt_volume_w))
				and (coalesce(ie_medic_termolabil,'N') = 'N' or (coalesce(ie_medic_termolabil,'N') = 'S' and coalesce(ie_termolabil_w,'N') = 'S'));
			end if;

			/*  Verifica se existe regra que omaterial se encaixe para a estrutura informada. Rotina desenvolvida para o Sirio na utilizacao de regras onde possui a estrutura interna informada.
			Exemplo: na estrutura esta cadastrado o medicamento generico e na prescricao tambem. Porem o hospital somente tem saldonos medicamentos comerciais.
			Assim quando for localizar a regra, tem que visualizar os medicamentos comerciais. */
			ie_existe_regra_w := 'N';
			open c99;
			loop
			fetch c99 into nr_seq_estrut_int_w;
			EXIT WHEN NOT FOUND; /* apply on c99 */
				begin
				ie_existe_regra_w := consistir_se_mat_contr_estrut(nr_seq_estrut_int_w,cd_material_w);
				if (ie_existe_regra_w = 'S') then
					exit;
				end if;
				end;
			end loop;
			close c99;

			if (ie_existe_regra_w = 'S') then
				--  Verificar saldo dos materiais comercias
				open c03;
				loop
				fetch c03 into
					cd_material_comercial_w;
				EXIT WHEN NOT FOUND or cd_local_estoque_w > 0;  /* apply on c03 */
					begin
					select	max(cd_grupo_material),
						max(cd_subgrupo_material),
						max(cd_classe_material),
						max(nr_seq_familia)
					into STRICT	cd_grupo_material_w,
						cd_subgrupo_w,
						cd_classe_material_w,
						nr_seq_familia_w
					from	estrutura_material_v
					where 	cd_material = cd_material_comercial_w;

					open c04;
					loop
					fetch c04 into
						cd_local_estoque_ww,
						nr_regra_local_disp_ww,
						nr_seq_regra_disp_ww,
						ie_so_com_estoque_w,
						ie_saldo_generico_w;
					EXIT WHEN NOT FOUND; /* apply on c04 */
						begin
						if (ie_so_com_estoque_w = 'N') then
							cd_local_estoque_w := cd_local_estoque_ww;
							nr_seq_regra_disp_w := nr_seq_regra_disp_ww;
							nr_regra_local_disp_w := nr_regra_local_disp_ww;

						elsif (ie_so_com_estoque_w = 'S') and (obter_saldo_disp_estoque(cd_estabelecimento_w,cd_material_w,cd_local_estoque_ww,clock_timestamp()) >= qt_dispensar_w) then
							cd_local_estoque_w := cd_local_estoque_ww;
							nr_seq_regra_disp_w := nr_seq_regra_disp_ww;
							nr_regra_local_disp_w := nr_regra_local_disp_ww;

						elsif (ie_saldo_generico_w = 'S') and (obter_saldo_disp_estoque(cd_estabelecimento_w,cd_material_generico_w,cd_local_estoque_ww,clock_timestamp()) >= qt_dispensar_w) then
							cd_local_estoque_w := cd_local_estoque_ww;
							nr_seq_regra_disp_w := nr_seq_regra_disp_ww;
							nr_regra_local_disp_w := nr_regra_local_disp_ww;
						end if;

						end;
					end loop;
					close c04;
					end;
				end loop;
				close c03;
			end if;

			if (coalesce(cd_local_estoque_w,0) = 0) then

				select	max(cd_grupo_material),
					max(cd_subgrupo_material),
					max(cd_classe_material),
					max(nr_seq_familia)
				into STRICT	cd_grupo_material_w,
					cd_subgrupo_w,
					cd_classe_material_w,
					nr_seq_familia_w
				from	estrutura_material_v
				where 	cd_material = cd_material_w;

				open c02;
				loop
				fetch c02 into
					cd_local_estoque_ww,
					nr_regra_local_disp_ww,
					nr_seq_regra_disp_ww,
					ie_so_com_estoque_w,
					ie_saldo_generico_w;
				EXIT WHEN NOT FOUND; /* apply on c02 */
					begin
					if (ie_so_com_estoque_w = 'N') then
						cd_local_estoque_w := cd_local_estoque_ww;
						nr_seq_regra_disp_w := nr_seq_regra_disp_ww;
						nr_regra_local_disp_w := nr_regra_local_disp_ww;

					elsif (ie_so_com_estoque_w = 'S') and (obter_saldo_disp_estoque(cd_estabelecimento_w,cd_material_w,cd_local_estoque_ww,clock_timestamp()) >= qt_dispensar_w) then
						cd_local_estoque_w := cd_local_estoque_ww;
						nr_seq_regra_disp_w := nr_seq_regra_disp_ww;
						nr_regra_local_disp_w := nr_regra_local_disp_ww;

					elsif (ie_saldo_generico_w = 'S') and (obter_saldo_disp_estoque(cd_estabelecimento_w,cd_material_generico_w,cd_local_estoque_ww,clock_timestamp()) >= qt_dispensar_w) then
						cd_local_estoque_w := cd_local_estoque_ww;
						nr_seq_regra_disp_w := nr_seq_regra_disp_ww;
						nr_regra_local_disp_w := nr_regra_local_disp_ww;
					end if;

					end;
				end loop;
				close 	c02;
			end if;

			if (coalesce(wheb_usuario_pck.get_ie_commit, 'S') = 'S') then commit; end if;

			if (coalesce(cd_local_estoque_w, 0) = 0) then
				cd_local_estoque_w := cd_loc_estoque_w;
			end if;

			if (cd_local_estoque_w > 0) then

				ie_local_estoque_kit_w := Obter_Param_Usuario(924, 673, cd_perfil_p, nm_usuario_p, cd_estabelecimento_w, ie_local_estoque_kit_w);
				ie_local_estoque_dil_w := Obter_Param_Usuario(924, 741, cd_perfil_p, nm_usuario_p, cd_estabelecimento_w, ie_local_estoque_dil_w);

				--ajuste para pegar a regra local do material superior.
				select	coalesce(max(ie_atualiza_regra_local_kit),'N')
				into STRICT	ie_atualiza_regra_local_kit_w
				from	parametros_farmacia
				where	cd_estabelecimento	= cd_estabelecimento_w;

				if (coalesce(ie_atualiza_regra_local_kit_w,'N') = 'N') then
					select	coalesce(max(nr_regra_local_disp), nr_regra_local_disp_w),
							coalesce(max(nr_seq_regra_disp), nr_seq_regra_disp_w)
					into STRICT	nr_regra_local_disp_w,
							nr_seq_regra_disp_w
					from	prescr_mat_hor
					where	nr_prescricao	= nr_prescricao_p
					and		nr_seq_material	= nr_sequencia_w
					and		nr_sequencia	<> nr_seq_horario_p
					and		coalesce(nr_seq_superior::text, '') = '';
				end if;

				--Atualiza horarios sem kit e diluicao vinculado de acordo com a regra local.
				update	prescr_mat_hor a
				set	a.cd_local_estoque = cd_local_estoque_w,
					a.nr_regra_local_disp = nr_regra_local_disp_w,
					a.nr_seq_regra_disp = nr_seq_regra_disp_w,
					a.nm_usuario	= nm_usuario_p
				where	a.nr_sequencia	= nr_seq_horario_p
				and	a.nr_prescricao	= nr_prescricao_p
				and	coalesce(a.cd_motivo_baixa,0)	= 0
				and	((nr_seq_recomendacao_w IS NOT NULL AND nr_seq_recomendacao_w::text <> '') or (ie_local_estoque_kit_w = 'N') or (coalesce(nr_seq_kit_w::text, '') = ''))
				and	((nr_seq_recomendacao_w IS NOT NULL AND nr_seq_recomendacao_w::text <> '') or (ie_local_estoque_dil_w = 'N') or (coalesce(nr_sequencia_diluicao_w::text, '') = ''));

				--Se o item possuir kit, sistema buscara o local de estoque do item principal.
				if (coalesce(ie_local_estoque_kit_w,'N') = 'S') then
					if (coalesce(nr_seq_kit_w,0) > 0) and (coalesce(nr_seq_recomendacao_w,0) = 0) then

						select	coalesce(max(cd_local_estoque),cd_local_estoque_w)
						into STRICT	cd_local_estoque_w
						from	prescr_mat_hor
						where	nr_prescricao	= nr_prescricao_p
						and	nr_sequencia	<> nr_seq_horario_p
						and	nr_seq_material	= nr_seq_kit_w
						and	dt_horario	= dt_horario_w
						and	coalesce(nr_seq_superior::text, '') = '';

						update	prescr_mat_hor a
						set	a.cd_local_estoque = cd_local_estoque_w,
							a.nr_regra_local_disp = nr_regra_local_disp_w,
							a.nr_seq_regra_disp = nr_seq_regra_disp_w,
							a.nm_usuario	= nm_usuario_p
						where	a.nr_sequencia	= nr_seq_horario_p
						and	a.nr_prescricao	= nr_prescricao_p
						and	coalesce(a.cd_motivo_baixa,0)	= 0
						and 	(nr_seq_kit_w IS NOT NULL AND nr_seq_kit_w::text <> '')
						and 	coalesce(nr_sequencia_diluicao_w::text, '') = '';

					elsif (coalesce(nr_agrupamento_w,0) > 0) and (coalesce(ie_item_superior_w,'N') = 'N') then

						select	coalesce(max(a.cd_local_estoque),cd_local_estoque_w)
						into STRICT	cd_local_estoque_w
						from	prescr_mat_hor a,
							prescr_material b
						where	a.nr_prescricao = b.nr_prescricao
						and 	a.nr_seq_material = b.nr_sequencia
						and 	a.nr_prescricao	= nr_prescricao_p
						and	a.nr_sequencia	<> nr_seq_horario_p
						and	coalesce(b.ie_item_superior,'N') = 'S'
						and	b.nr_agrupamento = nr_agrupamento_w
						and	a.dt_horario	= dt_horario_w
						and	coalesce(a.nr_seq_superior::text, '') = '';

						update	prescr_mat_hor a
						set	a.cd_local_estoque = cd_local_estoque_w,
							a.nr_regra_local_disp = nr_regra_local_disp_w,
							a.nr_seq_regra_disp = nr_seq_regra_disp_w,
							a.nm_usuario	= nm_usuario_p
						where	a.nr_sequencia	= nr_seq_horario_p
						and	a.nr_prescricao	= nr_prescricao_p
						and	coalesce(a.cd_motivo_baixa,0)	= 0
						and 	(nr_agrupamento_w IS NOT NULL AND nr_agrupamento_w::text <> '')
						and 	coalesce(nr_seq_kit_w::text, '') = ''
						and 	coalesce(nr_sequencia_diluicao_w::text, '') = '';
					end if;

					/*SO 2091690  kit gerado antes do principal*/

					if (coalesce(cd_local_estoque_w,0) > 0) then
						update	prescr_mat_hor a
						set	a.cd_local_estoque = cd_local_estoque_w,
							a.nr_regra_local_disp = nr_regra_local_disp_w,
							a.nr_seq_regra_disp = nr_seq_regra_disp_w,
							a.nm_usuario	= nm_usuario_p
						where	a.nr_prescricao	= nr_prescricao_p
						and	nr_seq_superior	= nr_seq_material_w
						and	dt_horario	= dt_horario_w
						and 	coalesce(cd_local_estoque,0) <> cd_local_estoque_w
						and 	coalesce(nr_sequencia_diluicao_w::text, '') = ''
						and	coalesce(a.cd_motivo_baixa,0) = 0;

						if (coalesce(wheb_usuario_pck.get_ie_commit, 'S') = 'S') then commit; end if;
						update	prescr_mat_hor a
						set	nr_seq_turno	= coalesce(Obter_turno_horario_prescr(cd_estabelecimento_w, cd_setor_atendimento_w, to_char(dt_horario_w,'hh24:mi'), cd_local_estoque_w),nr_seq_turno)
						where	a.nr_prescricao	= nr_prescricao_p
						and	nr_seq_superior	= nr_seq_material_w
						and	dt_horario	= dt_horario_w
						and 	coalesce(nr_sequencia_diluicao_w::text, '') = ''
						and	coalesce(a.cd_motivo_baixa,0) = 0;

					end if;
				end if;

				--Se item for uma diluiacao, sistema buscara o local de estoque do item principal.
				if (coalesce(ie_local_estoque_dil_w,'N') = 'S') and (coalesce(nr_sequencia_diluicao_w,0) > 0) then

					select	coalesce(max(cd_local_estoque),cd_local_estoque_w)
					into STRICT	cd_local_estoque_w
					from	prescr_mat_hor
					where	nr_prescricao	= nr_prescricao_p
					and		nr_sequencia	<> nr_seq_horario_p
					and		nr_seq_material	= nr_sequencia_diluicao_w
					and		dt_horario		= dt_horario_w
					and		coalesce(nr_seq_superior::text, '') = '';

					update	prescr_mat_hor a
					set		a.cd_local_estoque = cd_local_estoque_w,
							a.nr_regra_local_disp = nr_regra_local_disp_w,
							a.nr_seq_regra_disp = nr_seq_regra_disp_w,
							a.nm_usuario	= nm_usuario_p
					where	a.nr_sequencia	= nr_seq_horario_p
					and		a.nr_prescricao	= nr_prescricao_p
					and		coalesce(a.cd_motivo_baixa,0)	= 0
					and 	(nr_sequencia_diluicao_w IS NOT NULL AND nr_sequencia_diluicao_w::text <> '');
				end if;

				if (coalesce(wheb_usuario_pck.get_ie_commit, 'S') = 'S') then commit; end if;
			end if;
			end;
		end loop;
		close 	c01;
		end;
	else
		begin
			if (cd_loc_estoque_w > 0) then
				update	prescr_mat_hor
				set	cd_local_estoque = cd_loc_estoque_w,
					nm_usuario	= nm_usuario_p
				where	nr_sequencia	= nr_seq_horario_p
				and	coalesce(cd_motivo_baixa,0)	= 0;

				if (coalesce(wheb_usuario_pck.get_ie_commit, 'S') = 'S') then commit; end if;
			end if;
		end;
	end if;
	end;
end if;

if (coalesce(wheb_usuario_pck.get_ie_commit, 'S') = 'S') then commit; end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE define_disp_prescr_mat_hor ( nr_seq_horario_p bigint, nr_prescricao_p bigint, nr_seq_material_p bigint, cd_perfil_p bigint, nm_usuario_p text, ie_setor_atendimento_p text default 'N', ie_setor_lote_p text default 'N') FROM PUBLIC;

