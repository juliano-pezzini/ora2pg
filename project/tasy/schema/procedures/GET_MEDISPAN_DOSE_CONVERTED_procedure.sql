-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE get_medispan_dose_converted (cd_material_p material.cd_material%type, cd_unidade_medida_p unidade_medida.cd_unidade_medida%type, qt_dose_p bigint, cd_unidade_medida_out_p INOUT unidade_medida.cd_unidade_medida%type, qt_dose_out_p INOUT bigint ) AS $body$
DECLARE


	cd_unid_medida_dest_w	unidade_medida.cd_unidade_medida%type;
	cd_unidade_medida_out_w	unidade_medida.cd_unidade_medida%type;
	qt_dose_out_w			double precision;
	ie_info_rastre_prescr_w	alerta_api.ie_status_requisicao%type;
	ds_log_step_w			log_tasy.ds_log%type;



BEGIN
	ie_info_rastre_prescr_w := obter_se_info_rastre_prescr('I', wheb_usuario_pck.get_nm_usuario, obter_perfil_ativo, wheb_usuario_pck.get_cd_estabelecimento);
	ds_log_step_w := 'BEGIN: '
		|| chr(13) || 'cd_material_p: ' || cd_material_p
		|| chr(13) || 'cd_unidade_medida_p: ' || cd_unidade_medida_p
		|| chr(13) || 'qt_dose_p: ' || qt_dose_p
		|| chr(13) || 'user: ' || wheb_usuario_pck.get_nm_usuario
		|| chr(13) || 'perfil: ' || obter_perfil_ativo
		|| chr(13) || 'estab: ' || wheb_usuario_pck.get_cd_estabelecimento;

	cd_unidade_medida_out_w := obter_conv_meio_ext_int('UNIDADE_MEDIDA', 'CD_UNIDADE_MEDIDA', cd_unidade_medida_p, 'LXC');
	qt_dose_out_w := qt_dose_p;

	/* SE NAO ENCONTROU CONVERSAO COM A UNIDADE DE MEDIDA PRESCRITA VAI PROCURAR NA CONVERSAO DO MEDICAMENTO */

	if (coalesce(cd_unidade_medida_out_w::text, '') = '') then
		select 	max(x.cd_unidade_medida)
		  into STRICT	cd_unid_medida_dest_w
		  from (
				SELECT	a.cd_unidade_medida,
						a.qt_conversao,
						a.ie_prioridade
				  from	material_conversao_unidade a
				 where	a.cd_material = cd_material_p
				   and  (obter_conv_meio_ext_int('UNIDADE_MEDIDA', 'CD_UNIDADE_MEDIDA', a.cd_unidade_medida, 'LXC') IS NOT NULL AND (obter_conv_meio_ext_int('UNIDADE_MEDIDA', 'CD_UNIDADE_MEDIDA', a.cd_unidade_medida, 'LXC'))::text <> '')
				   and  a.cd_unidade_medida <> cd_unidade_medida_p
				 order by a.ie_prioridade
			 ) x LIMIT 1;

		if (cd_unid_medida_dest_w IS NOT NULL AND cd_unid_medida_dest_w::text <> '') then
			cd_unidade_medida_out_w := obter_conv_meio_ext_int('UNIDADE_MEDIDA', 'CD_UNIDADE_MEDIDA', cd_unid_medida_dest_w, 'LXC');
			qt_dose_out_w := obter_dose_convertida(cd_material_p, qt_dose_p, cd_unidade_medida_p, cd_unid_medida_dest_w);
		end if;
	end if;

	cd_unidade_medida_out_p := cd_unidade_medida_out_w;
	qt_dose_out_p := qt_dose_out_w;

	ds_log_step_w := ds_log_step_w
		|| chr(13) || 'END: '
		|| chr(13) || 'cd_material_p: ' || cd_material_p
		|| chr(13) || 'cd_unidade_medida_p: ' || cd_unidade_medida_p
		|| chr(13) || 'qt_dose_p: ' || qt_dose_p
		|| chr(13) || 'cd_unidade_medida_out_p: ' || cd_unidade_medida_out_p
		|| chr(13) || 'qt_dose_out_p: ' || qt_dose_out_p
		|| chr(13) || 'cd_unid_medida_dest_w: ' || cd_unid_medida_dest_w;

	if (ie_info_rastre_prescr_w = 'S') then
		CALL gravar_log_tasy(
			10009,
			substr('GET_MEDISPAN_DOSE_CONVERTED - ' || ds_log_step_w, 1, 2000),
			'TASY'
		);
		commit;
	end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE get_medispan_dose_converted (cd_material_p material.cd_material%type, cd_unidade_medida_p unidade_medida.cd_unidade_medida%type, qt_dose_p bigint, cd_unidade_medida_out_p INOUT unidade_medida.cd_unidade_medida%type, qt_dose_out_p INOUT bigint ) FROM PUBLIC;

