-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE excluir_movimento_estoque ( CD_ESTABELECIMENTO_P bigint, DT_PARAMETRO_P timestamp, NR_REG_COMMIT_P bigint, NM_USUARIO_P text) AS $body$
DECLARE


nr_registro_excluir_w	bigint		:= 0;
nr_movimento_Min_w		bigint		:= 0;
nr_movimento_Max_w		bigint		:= 0;
nr_movimento_final_w		bigint		:= 0;
nr_Processos_ok_w		bigint		:= 0;
nr_processos_w		bigint		:= 0;
dt_exclusao_w			timestamp;
nr_meses_movimento_w		smallint		:= 0;


BEGIN
nr_meses_movimento_w 		:= trunc((clock_timestamp() - dt_parametro_p) / 30);
if nr_meses_movimento_w < 23 then
	begin
	CALL wheb_mensagem_pck.exibir_mensagem_abort(265988);
	--'Não é permitido limpar os Últimos 23 Meses'
	end;
end if;

dt_exclusao_w	:= trunc(dt_parametro_p, 'month');

select	count(*),
		min(nr_movimento_estoque),
		max(nr_movimento_estoque)
into STRICT 		nr_registro_excluir_w,
		nr_movimento_min_w,
		nr_Movimento_max_w
from		movimento_estoque
where 		dt_mesano_referencia 	= dt_exclusao_w
and		cd_estabelecimento	= cd_estabelecimento_p;

nr_movimento_final_w		:= nr_movimento_min_w;
nr_processos_w		:= Trunc(nr_registro_excluir_w / nr_reg_commit_p) + 1;

WHILE nr_processos_ok_w <= nr_processos_w LOOP
	begin
	nr_processos_ok_w 		:=  nr_processos_ok_w + 1;
	if (nr_processos_ok_w = nr_processos_w) then
		nr_movimento_final_w	:= nr_movimento_max_w;
	else
		nr_movimento_final_w	:= nr_movimento_final_w + nr_reg_commit_p;
	end if;
	delete /*+ INDEX(A MOVESTO_PK) */	from movimento_estoque a
	where nr_movimento_estoque between nr_movimento_min_w
						 and nr_movimento_final_w
	  and	dt_mesano_referencia 	= dt_exclusao_w
	  and	cd_estabelecimento	= cd_estabelecimento_p;

	commit;
	end;
END LOOP;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE excluir_movimento_estoque ( CD_ESTABELECIMENTO_P bigint, DT_PARAMETRO_P timestamp, NR_REG_COMMIT_P bigint, NM_USUARIO_P text) FROM PUBLIC;

