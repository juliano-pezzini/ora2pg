-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE submit_discharge_summary (nr_sequencia_p bigint, nm_usuario_p text) AS $body$
DECLARE

  nr_seq_item_w       wl_item.nr_sequencia%TYPE;
  nr_atendimento_w    atendimento_paciente.nr_atendimento%TYPE;
  cd_pessoa_fisica_w  pessoa_fisica.cd_pessoa_fisica%TYPE;
  ie_tipo_sumario_w   atend_sumario_alta.ie_tipo_sumario%TYPE;
  nr_seq_regra_item_w wl_regra_item.nr_sequencia%TYPE;

BEGIN
    UPDATE atend_sumario_alta 
    SET    dt_liberacao = clock_timestamp(), 
           nm_usuario = nm_usuario_p 
    WHERE  nr_sequencia = nr_sequencia_p;

    SELECT coalesce(ie_tipo_sumario, 'A') 
    INTO STRICT   ie_tipo_sumario_w 
    FROM   atend_sumario_alta 
    WHERE  nr_sequencia = nr_sequencia_p;

    /*Check the existence of a rule for approval.*/
 
    SELECT coalesce(Max(c.nr_sequencia), 0) 
    INTO STRICT   nr_seq_regra_item_w 
    FROM   wl_item a, 
           wl_regra_worklist b, 
           wl_regra_item c, 
           wl_perfil d 
    WHERE  a.nr_sequencia = b.nr_seq_item 
           AND b.nr_sequencia = c.nr_seq_regra 
           AND b.nr_sequencia = d.nr_seq_item 
           AND c.nr_sequencia = d.nr_seq_regra_item 
           AND a.cd_categoria = 'DS' 
           AND a.ie_situacao = 'A' 
           AND c.ie_situacao = 'A' 
           AND d.ie_situacao = 'A' 
           AND ( ( ie_tipo_sumario_w = 'A'  AND  ie_discharge = 'Y' ) 
                  OR ( ie_tipo_sumario_w = 'E'  AND  ie_external_transfer = 'Y' ) 
                  OR ( ie_tipo_sumario_w = 'T'  AND  ie_internal_transfer = 'Y' ) );

    /*If there is no rule, it will automatically approve.*/
 
    IF ( nr_seq_regra_item_w = 0 ) THEN 
      UPDATE atend_sumario_alta 
      SET    --dt_approval = sysdate, 
      nm_usuario = nm_usuario_p 
      WHERE  nr_sequencia = nr_sequencia_p;
    ELSE 
      /*If there is a rule, the system must generate a task.*/
 
      SELECT a.nr_atendimento, 
             a.cd_pessoa_fisica 
      INTO STRICT   nr_atendimento_w, cd_pessoa_fisica_w 
      FROM   atendimento_paciente a, 
             atend_sumario_alta b 
      WHERE  a.nr_atendimento = b.nr_atendimento 
             AND b.nr_sequencia = nr_sequencia_p;

      SELECT coalesce(Max(a.nr_sequencia), 0) 
      INTO STRICT   nr_seq_item_w 
      FROM   wl_item a, 
             wl_regra_worklist b, 
             wl_regra_item c 
      WHERE  a.nr_sequencia = b.nr_seq_item 
             AND b.nr_sequencia = c.nr_seq_regra 
             AND c.nr_sequencia = nr_seq_regra_item_w;

      INSERT INTO wl_worklist(nr_sequencia, 
                   nr_atendimento, 
                   cd_pessoa_fisica, 
                   dt_atualizacao, 
                   dt_atualizacao_nrec, 
                   nm_usuario, 
                   nm_usuario_nrec, 
                   nr_seq_item, 
                   nr_seq_regra, 
                   dt_inicial, 
                   dt_final_previsto, 
                   nr_seq_disc_summary) 
      VALUES (nextval('wl_worklist_seq'), 
                   nr_atendimento_w, 
                   cd_pessoa_fisica_w, 
                   clock_timestamp(), 
                   clock_timestamp(), 
                   nm_usuario_p, 
                   nm_usuario_p, 
                   nr_seq_item_w, 
                   nr_seq_regra_item_w, 
                   clock_timestamp(), 
                   clock_timestamp() + interval '365 days', 
                   nr_sequencia_p);
    END IF;

    COMMIT;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE submit_discharge_summary (nr_sequencia_p bigint, nm_usuario_p text) FROM PUBLIC;

