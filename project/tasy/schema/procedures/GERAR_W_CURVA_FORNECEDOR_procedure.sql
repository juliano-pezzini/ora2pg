-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_w_curva_fornecedor (dt_inicio_p timestamp, dt_final_p timestamp, cd_estabelecimento_p bigint, nm_usuario_p text) AS $body$
DECLARE

 
cd_cnpj_w			varchar(14);
vl_total_nota_w			double precision := 0;						
nr_sequencia_w			bigint;
vl_acumulado_w			double precision := 0;
vl_total_gerar_notas_w		double precision;
pr_valor_w			double precision := 0;
pr_acumulado_w			double precision := 0;
cd_tipo_pessoa_w		smallint;
dt_final_w			timestamp;
vl_mercadoria_w 		double precision := 0;
vl_tributo_w			double precision := 0;
	
c01 CURSOR FOR						 
SELECT	cd_cgc_emitente, 
	sum(vl_total_nota) vl_total, 
	substr(obter_dados_pf_pj(NULL,cd_cgc_emitente,'TP'),1,3), 
	sum(vl_mercadoria) vl_mercadoria, 
	sum(obter_vl_total_trib_nota(nr_sequencia, 'X')) vl_tributo 
from	nota_fiscal 
where	dt_emissao between dt_inicio_p and dt_final_w 
and	cd_estabelecimento = cd_estabelecimento_p 
and	ie_situacao = '1' 
and	ie_tipo_nota = 'EN' 
group by	cd_cgc_emitente 
order by	vl_total desc;	
 

BEGIN 
 
delete from w_gerar_curva_fornecedor;
 
dt_final_w := (trunc(coalesce(dt_final_p,clock_timestamp()),'dd') + 86399/86400);
 
select	sum(vl_total_nota) vl_total 
into STRICT	vl_total_gerar_notas_w 
from	nota_fiscal 
where	dt_emissao between dt_inicio_p and dt_final_w 
and	cd_estabelecimento = cd_estabelecimento_p 
and	ie_situacao = '1' 
and	ie_tipo_nota = 'EN';
 
open C01;
loop 
fetch C01 into		 
	cd_cnpj_w, 
	vl_total_nota_w, 
	cd_tipo_pessoa_w, 
	vl_mercadoria_w, 
	vl_tributo_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin 
	vl_acumulado_w		:= vl_acumulado_w + vl_total_nota_w;	
	pr_valor_w		:= dividir((vl_total_nota_w * 100),vl_total_gerar_notas_w);	
	pr_acumulado_w		:= dividir((vl_acumulado_w * 100),vl_total_gerar_notas_w);	
	 
	insert into w_gerar_curva_fornecedor( 
		nr_sequencia, 
		dt_atualizacao, 
		nm_usuario, 
		dt_atualizacao_nrec, 
		nm_usuario_nrec, 
		cd_cnpj, 
		vl_total_nota, 
		vl_acumulado, 
		pr_valor, 
		pr_acumulado, 
		cd_tipo_pessoa, 
		vl_mercadoria, 
		vl_tributo) 
	values (	nextval('w_gerar_curva_fornecedor_seq'), 
		clock_timestamp(), 
		nm_usuario_p, 
		clock_timestamp(), 
		nm_usuario_p, 
		cd_cnpj_w, 
		vl_total_nota_w, 
		vl_acumulado_w, 
		pr_valor_w, 
		pr_acumulado_w, 
		cd_tipo_pessoa_w, 
		vl_mercadoria_w, 
		vl_tributo_w);
	end;
end loop;
close C01;
 
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_w_curva_fornecedor (dt_inicio_p timestamp, dt_final_p timestamp, cd_estabelecimento_p bigint, nm_usuario_p text) FROM PUBLIC;

