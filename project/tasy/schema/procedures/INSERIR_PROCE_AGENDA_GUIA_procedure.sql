-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE inserir_proce_agenda_guia ( nr_seq_ageint_p bigint default null, nr_seq_agepac_p bigint default null, cd_medico_p text default null, cd_material_exame_p text default null, ds_observacao_p text default null, nr_atendimento_p bigint default null, nr_doc_convenio_p text default null, nr_seq_exame_p bigint default null, nr_seq_topografia_p bigint default null, nr_seq_proc_interno_p bigint default null, qt_procedimento_p bigint default null, nr_seq_contraste_p bigint default null, ds_ind_clinica_p text default null, ie_origem_informacao_p text default null, nr_prescricao_p text default null, nm_usuario_p text default null) AS $body$
DECLARE

		
ie_lado_w		agenda_integrada_item.ie_lado%type;
vl_coparticipacao_w		agenda_integrada_item.vl_coparticipacao%type;
nr_seq_proc_interno_w		agenda_integrada_item.nr_seq_proc_interno%type;		
nr_seq_topografia_w		agenda_integrada_item.nr_seq_topografia%type;		
nr_seq_exame_w		agenda_integrada_item.nr_seq_proc_interno%type;		
nr_sequencia_w		procedimento_guia_wint.nr_sequencia%type;
nr_seq_proc_guia_w        	   procedimento_guia_wint.nr_sequencia%type := null;
cd_procedimento_tuss_w procedimento_guia_wint.cd_procedimento_tuss%type;
cd_procedimento_w      proc_interno.cd_procedimento%type;
vl_item_w		agenda_integrada_item.vl_item%type;
cd_medico_w		agenda_integrada_item.cd_medico%type;
nr_crm_w	procedimento_guia_wint.nr_crm%type;
nr_sequencia_item_w	agenda_integrada_item.nr_sequencia%type;
nr_seq_prescr_proc_w	prescr_procedimento.nr_sequencia%type;
nr_seq_contraste_w		prescr_procedimento.nr_seq_contraste%type;
nr_seq_presc_proc_adic_w prescr_proced_inf_adic.nr_sequencia%type;
qt_procedimento_w	prescr_procedimento.qt_procedimento%type;

C01 CURSOR FOR
	SELECT	nr_sequencia,
			null nr_presc_procedimento,
			nr_seq_proc_interno,
			ie_lado, 
			vl_coparticipacao,
			cd_procedimento,
			nr_seq_topografia,
			null,
			null nr_seq_exame,
			vl_item,
			coalesce(cd_medico,cd_medico_req),
			coalesce(crm_medico_externo, obter_crm_medico(cd_medico), '999'),
			1
	from	agenda_integrada_item
	where	nr_seq_agenda_int = nr_seq_ageint_p
	and		ie_tipo_agendamento in ('C','E','S')
	and 	(nr_seq_proc_interno IS NOT NULL AND nr_seq_proc_interno::text <> '')
	
union

	SELECT  null nr_seq_age_int_item,
			nr_sequencia,
			nr_seq_proc_interno, 
			ie_lado, 
			obter_valor_copart_wint(nr_prescricao, nr_sequencia),
			cd_procedimento,
			nr_seq_topografia,
			nr_seq_contraste,
			nr_seq_exame,
			(eup_obter_valor_proc_part(nr_atendimento_p, nr_prescricao, nr_sequencia, coalesce(cd_medico_exec, cd_medico_solicitante))) * qt_procedimento vl_item,
			coalesce(cd_medico_exec, cd_medico_solicitante),
			coalesce(obter_crm_medico(coalesce(cd_medico_exec,cd_medico_solicitante)), 999),
			qt_procedimento
	from 	prescr_procedimento 
	where 	nr_prescricao = nr_prescricao_p 	
	and 	coalesce(dt_cancelamento::text, '') = ''
	and 	coalesce(dt_suspensao::text, '') = '';
	

BEGIN
if (coalesce(nr_seq_ageint_p,0) > 0) then
	delete	FROM procedimento_guia_wint where nr_seq_ageint = nr_seq_ageint_p;
elsif (coalesce(nr_seq_agepac_p,0) > 0) then
	delete	FROM procedimento_guia_wint where nr_seq_agepac = nr_seq_agepac_p;
elsif (coalesce(nr_prescricao_p,0) > 0) then
	delete	FROM procedimento_guia_wint where nr_prescricao = nr_prescricao_p;
end if;

commit;

open C01;
loop
fetch C01 into
	nr_sequencia_item_w,
	nr_seq_prescr_proc_w,
	nr_seq_proc_interno_w,
	ie_lado_w,
	vl_coparticipacao_w,
	cd_procedimento_w,
	nr_seq_topografia_w,
	nr_seq_contraste_w,
	nr_seq_exame_w,
	vl_item_w,
	cd_medico_w,
	nr_crm_w,
	qt_procedimento_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	
	if (nr_sequencia_item_w IS NOT NULL AND nr_sequencia_item_w::text <> '') then
	
		select  max(nr_sequencia)
		into STRICT    nr_seq_proc_guia_w
		from    procedimento_guia_wint
		where nr_seq_ageint_item = nr_sequencia_item_w
		and nr_seq_ageint = nr_seq_ageint_p;
		
	elsif (nr_seq_prescr_proc_w IS NOT NULL AND nr_seq_prescr_proc_w::text <> '') then
		
		select  max(nr_sequencia)
		into STRICT    nr_seq_proc_guia_w
		from    procedimento_guia_wint
		where nr_seq_prescr_proc = nr_seq_prescr_proc_w
		and nr_prescricao = nr_prescricao_p;
		
		select 	max(nr_sequencia)
		into STRICT 	nr_seq_presc_proc_adic_w
		from 	prescr_proced_inf_adic 
		where 	nr_seq_prescricao = nr_seq_prescr_proc_w
		and 	nr_prescricao = nr_prescricao_p;
		
		select 	max(cd_crm_medico), max(vl_coparticipacao)
		into STRICT 	nr_crm_w, vl_coparticipacao_w
		from 	prescr_proced_inf_adic
		where 	nr_sequencia = nr_seq_presc_proc_adic_w;
		
	end if;
	
	if (coalesce(nr_seq_proc_guia_w::text, '') = '') then
	
		select nextval('procedimento_guia_wint_seq')
		into STRICT   nr_sequencia_w
		;

		cd_procedimento_tuss_w := wint_proc_interno_tuss(nr_seq_proc_interno_w, cd_procedimento_tuss_w);
		
		insert into PROCEDIMENTO_GUIA_WINT(
					nr_seq_ageint_item,
					nr_seq_prescr_proc,
					cd_material,
					cd_procedimento,
					cd_procedimento_tuss,
					ds_ind_clinica,
					ds_observacao,
					ds_proc_exame,
					dt_atualizacao,
					dt_atualizacao_nrec,
					ie_gerar,
					ie_lado,
					nm_usuario,
					nm_usuario_nrec,
					nr_atendimento,
					nr_crm,
					nr_seq_ageint,
					nr_seq_agepac,
					nr_prescricao,
					nr_seq_exame,
					nr_seq_proc_interno,
					nr_seq_topografia,
					nr_sequencia,
					qt_procedimento,
					vl_coparticipacao,
					vl_procedimento,
					nr_seq_contraste,
					ie_origem_informacao)
				 values (
					nr_sequencia_item_w,
					nr_seq_prescr_proc_w,
					cd_material_exame_p,
					cd_procedimento_w,
					cd_procedimento_tuss_w,
					ds_ind_clinica_p,
					ds_observacao_p,
					Obter_Desc_Proc_Interno(nr_seq_proc_interno_w),
					clock_timestamp(),
					clock_timestamp(),
					'S',
					ie_lado_w,
					nm_usuario_p,
					nm_usuario_p,
					nr_atendimento_p,
					nr_crm_w,
					nr_seq_ageint_p,
					nr_seq_agepac_p,
					nr_prescricao_p,
					coalesce(nr_seq_exame_p, nr_seq_exame_w),
					coalesce(nr_seq_proc_interno_p, nr_seq_proc_interno_w),
					coalesce(nr_seq_topografia_p, nr_seq_topografia_w),
					nr_sequencia_w,
					coalesce(qt_procedimento_w, qt_procedimento_p, 1),
					vl_coparticipacao_w,
					vl_item_w,
					coalesce(nr_seq_contraste_w, nr_seq_contraste_p),
					ie_origem_informacao_p);
		
			commit;
			
	end if;
	
	end;
end loop;
close C01;
		
		
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE inserir_proce_agenda_guia ( nr_seq_ageint_p bigint default null, nr_seq_agepac_p bigint default null, cd_medico_p text default null, cd_material_exame_p text default null, ds_observacao_p text default null, nr_atendimento_p bigint default null, nr_doc_convenio_p text default null, nr_seq_exame_p bigint default null, nr_seq_topografia_p bigint default null, nr_seq_proc_interno_p bigint default null, qt_procedimento_p bigint default null, nr_seq_contraste_p bigint default null, ds_ind_clinica_p text default null, ie_origem_informacao_p text default null, nr_prescricao_p text default null, nm_usuario_p text default null) FROM PUBLIC;

