-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE calculate_exam_values (nr_seq_resultado_p bigint, nr_prescricao_p bigint, nr_seq_prescr_p bigint, nr_seq_material_p bigint, ie_sexo_p text, nr_seq_cor_pele_p bigint, qt_peso_p bigint, qt_altura_p bigint, dt_nascimento_p timestamp, nr_seq_exame_p bigint, qt_resultado_p bigint, pr_resultado_p bigint, ds_resultado_p INOUT text) AS $body$
DECLARE


nr_sequencia_w		bigint;
nr_seq_exame_w		bigint;
ie_campo_calculo_w	varchar(1);
ds_formula_w		varchar(255);
ds_formula_aux_w	varchar(255);
qt_decimais_w		smallint;

qt_resultado_ww		varchar(20);
pr_resultado_ww		varchar(20);
qt_resultado_w		double precision;
pr_resultado_w		double precision;

ie_formula_ok_w		smallint;
vl_resultado_w		double precision;

qt_volume_w		integer;
qt_tempo_w		real;
qt_minuto_w		smallint;
nr_anos_w		smallint;

ie_macro_w		varchar(1);
ie_tamanho_w		smallint;
i			smallint;
x			smallint;
nr_exame_w		bigint;
ie_multi_formula_w	varchar(1);
qt_formula_w		smallint;
ds_multi_formula_w	varchar(255);

C01 CURSOR FOR
	SELECT a.nr_sequencia,
		 a.nr_seq_exame,
		 b.ie_campo_calculo,
		 replace(replace(coalesce(c.ds_formula, b.ds_formula), '@'||nr_seq_exame_p, replace(qt_resultado_p,',','.')),
			   '%'||nr_seq_exame_p, replace(pr_resultado_p,',','.')),
		 coalesce(c.qt_decimais, coalesce(b.qt_decimais,0))
	FROM exame_lab_result_item a, exame_laboratorio b
LEFT OUTER JOIN exame_lab_material c ON (b.nr_seq_exame = c.nr_seq_exame AND nr_seq_material_p = c.nr_seq_material)
WHERE a.nr_seq_exame = b.nr_seq_exame  and a.nr_seq_resultado = nr_seq_resultado_p and a.nr_seq_prescr = nr_seq_prescr_p  and coalesce(c.ds_formula, b.ds_formula) like '%@' || nr_seq_exame_p || '%'
	
union

	SELECT a.nr_sequencia,
		 a.nr_seq_exame,
		 b.ie_campo_calculo,
		 replace(replace(coalesce(c.ds_formula, b.ds_formula), '@'||nr_seq_exame_p, replace(qt_resultado_p,',','.')),
			   '%'||nr_seq_exame_p, replace(pr_resultado_p,',','.')),
		 coalesce(c.qt_decimais, coalesce(b.qt_decimais,0))
	FROM exame_lab_result_item a, exame_laboratorio b
LEFT OUTER JOIN exame_lab_material c ON (b.nr_seq_exame = c.nr_seq_exame AND nr_seq_material_p = c.nr_seq_material)
WHERE a.nr_seq_exame = b.nr_seq_exame  and a.nr_seq_resultado = nr_seq_resultado_p and a.nr_seq_prescr = nr_seq_prescr_p  and coalesce(c.ds_formula, b.ds_formula) like '%%' || nr_seq_exame_p || '%';

BEGIN

	begin
		select	max(qt_volume),
				max(qt_tempo),
				max(qt_minuto)
		into STRICT	qt_volume_w,
				qt_tempo_w,
				qt_minuto_w
		from	prescr_proc_material
		where	nr_prescricao = nr_prescricao_p
		and		nr_seq_material = nr_seq_material_p;

		select	somente_numero(obter_idade(dt_nascimento_p, a.dt_prescricao, 'A'))
		into STRICT	nr_anos_w
		from	prescr_medica a
		where	nr_prescricao = nr_prescricao_p;

		open C01;
		loop
		fetch C01 into
			nr_sequencia_w,
			nr_seq_exame_w,
			ie_campo_calculo_w,
			ds_formula_w,
			qt_decimais_w;
		EXIT WHEN NOT FOUND; /* apply on C01 */

			select replace_macro(ds_formula_w, '@Sexo', ie_sexo_p)
			into STRICT ds_formula_w
			;

			select replace_macro(ds_formula_w, '@Cor_pele', nr_seq_cor_pele_p)
			into STRICT ds_formula_w
			;


			if (position('@Volume' in ds_formula_w) > 0) or (position('@Tempo' in ds_formula_w) > 0) then
				select replace_macro(ds_formula_w, '@Volume', qt_volume_w)
				into STRICT ds_formula_w
				;

				select replace_macro(ds_formula_w, '@Tempo', qt_tempo_w + (qt_minuto_w/60))
				into STRICT ds_formula_w
				;
			end if;

			if (position('@Idade' in ds_formula_w) > 0) or (position('@Peso' in ds_formula_w) > 0) or (position('@Altura' in ds_formula_w) > 0) then

				select replace_macro(ds_formula_w, '@Peso_Dose', round(qt_peso_p))
				into STRICT ds_formula_w
				;

				select replace_macro(ds_formula_w, '@Peso', qt_peso_p)
				into STRICT ds_formula_w
				;

				select replace_macro(ds_formula_w, '@Altura', replace(qt_altura_p, ',', '.'))
				into STRICT ds_formula_w
				;

				select replace_macro(ds_formula_w, '@Idade', nr_anos_w)
				into STRICT ds_formula_w
				;
			end if;

			select (length(ds_formula_w) - length(replace(ds_formula_w, chr(13)||chr(10), '')))/2
			into STRICT	qt_formula_w
			;

			ds_multi_formula_w := ds_formula_w;

			ie_multi_formula_w	:= 'S';
			if (qt_formula_w = 0) then
				qt_formula_w := 1;
				ie_multi_formula_w := 'N';
			end if;

			for x in 0..qt_formula_w loop
				ds_formula_w	:= substr(ds_multi_formula_w, 1, position(chr(13)||chr(10) in ds_multi_formula_w) - 1);
				if (coalesce(ds_formula_w::text, '') = '') then
					ds_formula_w	:= ds_multi_formula_w;
				end if;

				ie_formula_ok_w := position('@' in ds_formula_w);
				if (ie_formula_ok_w = 0) then
					ie_formula_ok_w := position('%' in ds_formula_w);
				end if;


				if (ie_formula_ok_w > 0) and
					((ie_multi_formula_w = 'N') or (nr_seq_exame_w <> nr_seq_exame_p)) then
					ds_formula_aux_w := ds_formula_w;

					while(position('@' in ds_formula_aux_w) > 0) or (position('%' in ds_formula_aux_w) > 0) loop
						ie_formula_ok_w := position('@' in ds_formula_aux_w);
						ie_macro_w := '@';
						ie_tamanho_w := 0;
						if (ie_formula_ok_w = 0) then
							ie_formula_ok_w := position('%' in ds_formula_aux_w);
							ie_macro_w := '%';
						end if;

						for i in ie_formula_ok_w..length(ds_formula_aux_w) + 1 loop
							if (substr(ds_formula_aux_w, i, 1) in (' ','/','*','+','-','(',')',',')) or (i = length(ds_formula_aux_w) + 1) then
								ie_tamanho_w := i;
								exit;
							end if;
						end loop;

						nr_exame_w	:= to_number(substr(ds_formula_aux_w, ie_formula_ok_w + 1, ie_tamanho_w - (ie_formula_ok_w + 1)));

						begin
							select	/*+ index (a exalari_exalare_fk_i) */									coalesce(a.qt_resultado,0),
									coalesce(a.pr_resultado,0)
							into STRICT	qt_resultado_w,
									pr_resultado_w
							from	exame_lab_result_item a
							where	a.nr_seq_resultado = nr_seq_resultado_p
							  and	a.nr_seq_exame = nr_exame_w;
						exception
							when others then
								select	/*+ index (a exalari_exalare_fk_i) */										coalesce(a.qt_resultado,0),
										coalesce(a.pr_resultado,0)
								into STRICT	qt_resultado_w,
										pr_resultado_w
								from	exame_lab_result_item a
								where	a.nr_seq_resultado = nr_seq_resultado_p
								  and	a.nr_seq_prescr = nr_seq_prescr_p
								  and	a.nr_seq_exame = nr_exame_w;
						end;

						qt_resultado_ww		:= replace(qt_resultado_w,',','.');
						pr_resultado_ww		:= replace(pr_resultado_w,',','.');
						if (ie_macro_w = '%') then
							ds_formula_aux_w := replace((replace(ds_formula_aux_w, ie_macro_w || nr_exame_w, pr_resultado_ww)),' ', '');
							ds_formula_w := ds_formula_aux_w;
						elsif (ie_macro_w = '@') then
							ds_formula_aux_w := replace((replace(ds_formula_aux_w, ie_macro_w || nr_exame_w, qt_resultado_ww)),' ', '');
							ds_formula_w := ds_formula_aux_w;
						end if;
					end loop;
				end if;

				ie_formula_ok_w := position('@' in ds_formula_w);
				if (ie_formula_ok_w = 0) then
					ie_formula_ok_w := position('%' in ds_formula_w);
				end if;

				vl_resultado_w := obter_valor_dinamico('select ' || ds_formula_w || ' from dual', vl_resultado_w);

				if (coalesce(vl_resultado_w::text, '') = '') or (vl_resultado_w = 0) then
					vl_resultado_w := obter_valor_dinamico('select ' || replace(ds_formula_w, ',', '.') || ' from dual', vl_resultado_w);
				end if;

				if (ie_formula_ok_w = 0) then
					if (ie_campo_calculo_w = 'P') or (ie_multi_formula_w = 'S' and x = 1) then
						update	exame_lab_result_item a
						set		pr_resultado = round(vl_resultado_w, qt_decimais_w)
						where	nr_seq_resultado = nr_seq_resultado_p
						  and	nr_sequencia = nr_sequencia_w;
					else
						update	exame_lab_result_item a
						set		qt_resultado = round(vl_resultado_w, qt_decimais_w)
						where	nr_seq_resultado = nr_seq_resultado_p
						  and	nr_sequencia = nr_sequencia_w;
					end if;
					ds_resultado_p := ds_resultado_p || nr_seq_exame_w || ',' || replace(to_char(round(vl_resultado_w, qt_decimais_w)),',','.') || ';';
				end if;

				if (ie_multi_formula_w = 'S') then
					ds_multi_formula_w	:= substr(ds_multi_formula_w, position(chr(13)||chr(10) in ds_multi_formula_w) + 2, 200);
				end if;

			end loop;
		end loop;
		close C01;
	exception
		when others then
			CALL wheb_mensagem_pck.exibir_mensagem_abort(264007,'VL_RESULTADO='||vl_resultado_w||';NR_SEQUENCIA='||nr_sequencia_w||';QT_DECIMAIS='||qt_decimais_w||
														   ';NR_EXAME='||nr_exame_w||';DS_FORMULA='||ds_formula_w||';NR_SEQ_EXAME='||to_char(nr_seq_exame_p));
	end;
	commit;
	ds_resultado_p := substr(ds_resultado_p,0,length(ds_resultado_p) - 1);

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE calculate_exam_values (nr_seq_resultado_p bigint, nr_prescricao_p bigint, nr_seq_prescr_p bigint, nr_seq_material_p bigint, ie_sexo_p text, nr_seq_cor_pele_p bigint, qt_peso_p bigint, qt_altura_p bigint, dt_nascimento_p timestamp, nr_seq_exame_p bigint, qt_resultado_p bigint, pr_resultado_p bigint, ds_resultado_p INOUT text) FROM PUBLIC;

