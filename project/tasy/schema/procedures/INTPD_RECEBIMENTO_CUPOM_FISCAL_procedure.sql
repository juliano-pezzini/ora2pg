-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE intpd_recebimento_cupom_fiscal ( nr_sequencia_p bigint, xml_p xml) AS $body$
DECLARE

        
_ora2pg_r RECORD;
/*A parte que os dados da NF (INVOICE, ITEMS, TRIBUTES, FREIGHTS e DUES foi copiado da proc intpd_recebimento_nota_fiscal, apenas acrescentado novos campos que foram inclusos no XML*/

ie_conversao_w    intpd_eventos_sistema.ie_conversao%type;
nr_seq_projeto_xml_w  intpd_eventos_sistema.nr_seq_projeto_xml%type;
nr_seq_sistema_w  intpd_eventos_sistema.nr_seq_sistema%type;
ie_sistema_externo_w  varchar(15);
ds_action    varchar(20);
reg_integracao_w  gerar_int_padrao.reg_integracao_conv;
nr_seq_regra_w    conversao_meio_externo.nr_seq_regra%type;
ds_erro_w    varchar(4000);
i      integer;
--cd_pk_w      nota_fiscal.cd_sistema_ant%type;
nota_fiscal_w      nota_fiscal%rowtype;
nota_fiscal_item_w    nota_fiscal_item%rowtype;
nota_fiscal_item_trib_w    nota_fiscal_item_trib%rowtype;
nota_fiscal_trib_w    nota_fiscal_trib%rowtype;
nota_fiscal_transportadora_w  nota_fiscal_transportadora%rowtype;
nota_fiscal_venc_w    nota_fiscal_venc%rowtype;


qt_ant_w    bigint;
ie_atualizou_w    varchar(1) := 'N';

caixa_receb_w        caixa_receb%rowtype;
nr_seq_caixa_w        caixa.nr_sequencia%type;
vl_transacao_w        movto_trans_financ.vl_transacao%type;
qt_saldo_aberto_w      bigint;
nr_titulo_w          titulo_receber.nr_titulo%type;
cd_tipo_pagamento_w      varchar(1);
qt_receb_abertos_w      bigint;
ds_msg_retorno_w      varchar(255);
movto_cartao_cr_w      movto_cartao_cr%rowtype;

vl_troco_w          bigint := 0;

ds_campo_w        varchar(1000);
ds_campo2_w        varchar(1000);

c01 CURSOR FOR
SELECT  *
from  xmltable('/STRUCTURE/INVOICE' passing xml_p columns
  ie_action        varchar(20)    path    'IE_ACTION',
  nr_sequencia        varchar(10)    path    'NR_SEQUENCE',
  nr_nota_fiscal        varchar(255)    path    'NR_INVOICE',
  cd_operacao_nf        varchar(4)    path    'CD_INVOICE_OPERATION',
  ie_tipo_nota        varchar(20)    path    'IE_INVOICE_TYPE',
  dt_emissao        varchar(40)    path    'DT_EMISSION',
  dt_entrada_saida      varchar(40)    path    'DT_INPUT_EXIT',
  cd_natureza_operacao      varchar(40)    path    'CD_NATURE_OPERATION',
  ie_situacao        varchar(20)    path    'IE_SITUATION',
  cd_serie_nf        varchar(20)    path    'NR_INVOICE_SERIES',
  nr_sequencia_nf        varchar(10)    path    'NR_INVOICE_SEQUENCE',
  cd_condicao_pagamento      varchar(10)    path    'CD_CONDITION_PAYMENT',
  dt_atualizacao_estoque      varchar(20)    path    'DT_STOCK_UPDATE',
  cd_cgc_emitente        varchar(40)    path    'CD_FRS_ISSUER',
  nr_ordem_compra        varchar(10)    path    'NR_PURCHASE_ORDER',
  nr_conta        varchar(40)    path    'NR_ACCOUNT',
  nr_seq_protocolo      varchar(10)    path    'NR_SEQ_PROTOCOLO',
  nr_lote_contabil      varchar(10)    path    'NR_ACCOUNTING_LOT',
  nr_seq_classif_fiscal      varchar(10)    path    'NR_SEQ_CLASSIF_FISCAL',
  cd_conv_integracao      varchar(5)    path    'CD_INTEGRATION_AGREEMENT',
  nr_nfe_imp        varchar(255)    path    'NR_ELECTRONIC_INVOICE_IMP',
  ie_status_envio        varchar(40)    path    'IE_STATUS_SENDING',
  ds_observacao        varchar(4000)    path    'DS_NOTE',
  cd_pessoa_fisica      varchar(60)    path    'CD_NATURAL_PERSON',
  cd_cgc          varchar(40)    path    'CD_FRS',
  vl_descontos        double precision     path    'VL_DISCOUNTS',
  vl_mercadoria        double precision    path    'VL_MERCHANDISE',
  vl_total_nota        double precision    path    'VL_TOTAL_NOTE',
  vl_despesa_acessoria      double precision    path    'VL_DESPESA_ADVICE',
  vl_seguro        double precision    path    'VL_INSURANCE',
  nr_seq_localizacao      varchar(20)    path    'NR_SEQ_LOCATION',
  cd_estabelecimento      varchar(4)    path    'CD_ESTABLISHMENT',
  cd_verificacao_nfse      varchar(255)    path    'CD_CHECK_INVOICE',
  cd_tipo_pagamento      varchar(255)    path    'CD_PAYMENT_TYPE',
  nr_cco          varchar(255)    path    'NR_CCO',
  nr_chave_cupom        varchar(255)    path    'NR_CUPOM_KEY',
  xml_items        xml      path    'ITEMS',
  xml_tributes        xml      path    'TRIBUTES',
  xml_freights        xml      path    'FREIGHTS',
  xml_dues        xml      path    'DUES',
  xml_checkout_receipts      xml      path    'CHECKOUT_RECEIPTS');

/* CD_TIPO_PAGAMENTO
E = Espécie
C = Cartão.
*/
  
  
c01_w  c01%rowtype;

c02 CURSOR FOR
SELECT  *
from  xmltable('/ITEMS/ITEM' passing c01_w.xml_items columns
  cd_material        varchar(15)    path    'CD_MATERIAL',
  nr_item_nf        varchar(40)    path    'NR_INVOICE_ITEM',
  nr_atendimento        varchar(40)    path    'NR_ATTENDANCE',
  nr_ordem_compra        varchar(20)    path    'NR_PURCHASE_ORDER',
  nr_item_oci        varchar(40)    path    'NR_ITEM_OCI',
  cd_procedimento        varchar(40)    path    'CD_PROCEDURE',
  nr_seq_proc_interno      varchar(20)    path    'NR_SEQ_INTERNAL_PROC',
  cd_imobilizado        varchar(255)    path    'CD_IMMOBILIZED',
  cd_imob_serie        varchar(40)    path    'CD_IMMOBILIZED_SERIES',
  cd_unidade_medida_compra    varchar(40)    path    'CD_UNIT_MEASURE_PURCHASE',
  dt_entrega_ordem      varchar(40)    path    'DT_DELIVERY_ORDER',
  qt_item_nf        double precision    path    'QT_INVOICE_ITEM',
  vl_unitario_item_nf      double precision    path    'VL_UNITARY_ITEM_INVOICE',
  pr_desconto        varchar(40)    path    'PR_DISCOUNT',
  vl_desconto        double precision    path    'VL_DISCOUNT',
  vl_desc_financ        double precision    path    'VL_DISC_FINANC',
  vl_total_item_nf      double precision    path    'VL_TOTAL_ITEM_INVOICE',
  cd_unidade_medida_estoque    varchar(40)    path    'CD_STOCK_MEASUREMENT_UNIT',
  qt_item_estoque        double precision    path    'QT_STOCK_ITEM',
  vl_liquido        double precision    path    'VL_LIQUID',
  cd_local_estoque      varchar(40)    path    'CD_LOCAL_STOCK',
  cd_conta_contabil      varchar(40)    path    'CD_ACCOUNTING_ACCOUNT',
  cd_natureza_operacao      varchar(40)    path    'CD_NATURE_OPERATION',
  cd_centro_custo        varchar(40)    path    'CD_COST_CENTER',
  nr_contrato        varchar(40)    path    'NR_CONTRACT',
  nr_seq_conta_financ      varchar(40)    path    'NR_SEQ_ACCOUNT_FINANCIAL',
  nr_seq_proj_rec        varchar(40)    path    'NR_SEQ_PROJ_REC',
  ds_observacao        varchar(4000)    path    'DS_NOTE',
  ds_complemento        varchar(4000)    path    'DS_COMPLEMENT',
  cd_lote_fabricacao      varchar(40)    path    'CD_LOT_FABRICATION',
  dt_validade        varchar(40)    path    'DT_SHELF_LIFE',
  ds_justificativa      varchar(40)    path    'DS_JUSTIFICATION',
  dt_fabricacao        varchar(40)    path    'DT_FABRICATION',
  ie_indeterminado      varchar(40)    path    'IE_UNDETERMINED',
  nr_seq_marca        varchar(40)    path    'NR_SEQ_BRAND',
  dt_inicio_garantia      varchar(40)    path    'DT_BEGINNING_WARRANTY',
  dt_fim_garantia        varchar(40)    path    'DT_END_WARRANTY',
  nr_serie_material      varchar(40)    path    'NR_MARETIAL_SERIES',
  cd_paciente        varchar(40)    path    'CD_PATIENT',
  nr_seq_modelo        varchar(40)    path    'NR_SEQ_MODEL',
  nr_seq_classif_trib      varchar(40)    path    'NR_SEQ_TRIB_RATING',  
  nr_sequencia_nf        varchar(40)    path    'NR_INVOICE_SEQUENCE',
  vl_frete        double precision    path    'VL_FREIGHT',
  vl_despesa_acessoria      double precision    path    'VL_DESPESA_ADVICE',
  vl_desconto_rateio      double precision    path    'VL_DISCOUNTS_RATEIO',
  vl_seguro        double precision    path    'VL_INSURANCE',    
  xml_tributes_item      xml      path    'TRIBUTES_ITEM');

c02_w  c02%rowtype;

c03 CURSOR FOR
SELECT  *
from  xmltable('/TRIBUTES_ITEM/TRIBUTE_ITEM' passing c02_w.xml_tributes_item columns
  cd_tributo        varchar(3)    path    'CD_TRIBUTE',
  vl_base_calculo        double precision    path    'VL_BASE_CALCULATION',
  vl_reducao_base        double precision    path    'VL_BASE_REDUCTION',
  tx_tributo        double precision    path    'TX_TRIBUTE',
  vl_tributo        double precision    path    'VL_TRIBUTE',
  nr_seq_sit_trib        varchar(40)    path    'NR_SEQ_SIT_TRIB',
  ie_tributacao_cst      varchar(255)    path    'IE_TAXATION_CST',
  ie_tributacao_csosn      varchar(100)    path    'IE_TAXATION_CSOSN')
  where (cd_tributo IS NOT NULL AND cd_tributo::text <> '');

c03_w  c03%rowtype;

c04 CURSOR FOR
SELECT  *
from  xmltable('/TRIBUTES/TRIBUTE' passing c01_w.xml_tributes columns
  cd_tributo        varchar(3)    path    'CD_TRIBUTE',
  vl_base_calculo        double precision    path    'VL_BASE_CALCULATION',
  vl_reducao        double precision    path    'VL_REDUCTION',
  vl_reducao_base        double precision    path    'VL_BASE_REDUCTION',
  tx_tributo        double precision    path    'TX_TRIBUTE',
  vl_tributo        double precision    path    'VL_TRIBUTE',
  vl_base_nao_retido      double precision    path    'VL_BASE_NOT_WITHHELD',
  vl_base_adic        double precision    path    'VL_BASE_ADDITIONAL',
  vl_trib_nao_retido      double precision    path    'VL_TRIB_NOT_WITHHELD',
  vl_trib_adic        double precision    path    'VL_TRIB_ADDITIONAL',
  vl_bc_matriz_filial      double precision    path    'VL_BC_MATRIX_BRANCH',
  ie_retencao        varchar(40)    path    'IE_RETENTION')
  where (cd_tributo IS NOT NULL AND cd_tributo::text <> '');

c04_w  c04%rowtype;

c05 CURSOR FOR
SELECT  *
from  xmltable('/FREIGHTS/FREIGHT' passing c01_w.xml_freights columns
  vl_frete      double precision      path    'VL_FREIGHT',
  cd_cnpj        varchar(40)      path    'CD_FRS',
  ie_tipo_frete      varchar(40)      path    'IE_TYPE_FREIGHT',
  nr_placa_veiculo    varchar(40)      path    'NR_VEHICLE_PLATE',
  uf_placa_veiculo    varchar(40)      path    'UF_VEHICLE_PLATE',
  ds_especie      varchar(40)      path    'DS_SPECIES',
  qt_transporte      double precision      path    'QT_TRANSPORT',
  qt_volume      double precision      path    'QT_VOLUME',
  qt_peso_bruto      double precision      path    'QT_GROSS_WEIGHT',
  qt_peso_liquido      double precision      path    'QT_NET_WEIGHT',
  nr_lacre      varchar(40)      path    'NR_SEALING_WAX')
  where (cd_cnpj IS NOT NULL AND cd_cnpj::text <> '');

c05_w  c05%rowtype;

c06 CURSOR FOR
SELECT  *
from  xmltable('/DUES/DUE' passing c01_w.xml_dues columns
  dt_vencimento      varchar(40)      path    'DT_DUE',
  vl_vencimento      double precision      path    'VL_DUE',
  vl_base_venc      double precision      path    'VL_BASE_VENC',
  vl_desconto      double precision      path    'VL_DISCOUNT',
  vl_desc_financ      double precision      path    'VL_DESC_FINANC',
  nr_titulo_pagar      varchar(20)      path    'NR_TITLE_PAY',
  ds_observacao      varchar(4000)      path    'DS_OBSERVATION');

c06_w  c06%rowtype;

C07 CURSOR FOR
  SELECT  *
  from  xmltable('/CHECKOUT_RECEIPTS/CHECKOUT_RECEIPT' passing c01_w.xml_checkout_receipts columns
      ie_action    varchar(1)    path    'IE_ACTION',
      cd_estabelecimento  varchar(5)    path    'CD_ESTABLISHMENT',
      nr_seq_caixa    varchar(10)    path    'NR_CHECKOUT',  
      dt_recebimento    varchar(40)      path    'DT_RECEIPT',  
      nr_seq_trans_financ  varchar(10)      path    'NR_FINANCIAL_TRANSACTION',
      vl_transacao    double precision    path    'VL_TRANSACTION',
      cd_pessoa_fisica  varchar(10)    path    'CD_NATURAL_PERSON',    
      cd_cgc      varchar(14)    path    'CD_LEGAL_ENTITY',
      vl_especie    double precision    path    'VL_CASH',
      ds_observacao    varchar(255)    path    'DS_COMMENT',
      xml_movto_cartao_cr  xml      path    'MOVTO_CARTAO_CRS');
c07_w  c07%rowtype;

C08 CURSOR FOR
  SELECT  *
  from  xmltable('/MOVTO_CARTAO_CRS/MOVTO_CARTAO_CR' passing c07_w.xml_movto_cartao_cr columns
      ie_tipo_cartao    varchar(1)  path      'IE_CARD_TYPE',
      nr_cartao    varchar(20)  path      'NR_CARD',
      nr_seq_bandeira    varchar(10)  path      'NR_CARD_NETWORK',
      nr_autorizacao    varchar(40)  path      'NR_AUTHORIZATION',
      nr_seq_forma_pagto  varchar(10)  path      'NR_METHOD_OF_PAYMENT',  
      vl_cartao    double precision  path      'VL_CARD',  
      qt_parcela    varchar(4)  path      'QT_CARD_INSTALLMENTS',
      ds_comprovante    varchar(100)  path      'NR_ELETRONIC_PROOF',        
      nr_seq_trans_caixa  varchar(10)  path      'NR_CARD_TRANSACTION',
      cd_pessoa_fisica  varchar(10)  path      'CD_NATURAL_PERSON',  
      cd_cgc      varchar(14)  path      'CD_LEGAL_ENTITY',
      ds_observacao    varchar(255)  path      'DS_COMMENT')
  where   (caixa_receb_w.nr_sequencia IS NOT NULL AND caixa_receb_w.nr_sequencia::text <> '')
  and    vl_cartao > 0;
c08_w  c08%rowtype;


BEGIN

update  intpd_fila_transmissao
set  ie_status = 'R'
where  nr_sequencia = nr_sequencia_p;

commit;

begin
select  coalesce(b.ie_conversao,'I'),
  nr_seq_sistema,
  nr_seq_projeto_xml,
  nr_seq_regra_conv
into STRICT  ie_conversao_w,
  nr_seq_sistema_w,
  nr_seq_projeto_xml_w,
  nr_seq_regra_w
from  intpd_fila_transmissao a,
  intpd_eventos_sistema b
where  a.nr_seq_evento_sistema = b.nr_sequencia
and  a.nr_sequencia = nr_sequencia_p;

ie_sistema_externo_w  :=  nr_seq_sistema_w;


reg_integracao_w.nr_seq_fila_transmissao  :=  nr_sequencia_p;
reg_integracao_w.ie_envio_recebe    :=  'R';
reg_integracao_w.ie_sistema_externo    :=  ie_sistema_externo_w;
reg_integracao_w.ie_conversao      :=  ie_conversao_w;
reg_integracao_w.nr_seq_projeto_xml    :=  nr_seq_projeto_xml_w;
reg_integracao_w.nr_seq_regra_conversao    :=  nr_seq_regra_w;
reg_integracao_w.intpd_log_receb.delete;
reg_integracao_w.qt_reg_log      :=  0;

open c01;
loop
fetch c01 into
  c01_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
  begin
  
  reg_integracao_w.nm_tabela    :=  'NOTA_FISCAL';
  reg_integracao_w.nm_elemento    :=  'INVOICE';
  reg_integracao_w.nr_seq_visao    :=  0;

  if (coalesce(c01_w.ie_action,'INSERT') <> 'DELETE') THEN
    ds_action := c01_w.ie_action;
    ds_campo_w := 'NR_NOTA_FISCAL';
    SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'NR_NOTA_FISCAL', c01_w.NR_NOTA_FISCAL, 'N', nota_fiscal_w.NR_NOTA_FISCAL) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_w.NR_NOTA_FISCAL := _ora2pg_r.ds_valor_retorno_p;
    ds_campo_w := 'CD_OPERACAO_NF';
    SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'CD_OPERACAO_NF', c01_w.CD_OPERACAO_NF, 'N', nota_fiscal_w.CD_OPERACAO_NF) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_w.CD_OPERACAO_NF := _ora2pg_r.ds_valor_retorno_p;
    ds_campo_w := 'IE_TIPO_NOTA';
    SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'IE_TIPO_NOTA', c01_w.IE_TIPO_NOTA, 'N', nota_fiscal_w.IE_TIPO_NOTA) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_w.IE_TIPO_NOTA := _ora2pg_r.ds_valor_retorno_p;
    ds_campo_w := 'DT_EMISSAO';
    SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'DT_EMISSAO', c01_w.DT_EMISSAO, 'N', nota_fiscal_w.DT_EMISSAO) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_w.DT_EMISSAO := _ora2pg_r.ds_valor_retorno_p;
    ds_campo_w := 'DT_ENTRADA_SAIDA';
    SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'DT_ENTRADA_SAIDA', c01_w.DT_ENTRADA_SAIDA, 'N', nota_fiscal_w.DT_ENTRADA_SAIDA) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_w.DT_ENTRADA_SAIDA := _ora2pg_r.ds_valor_retorno_p;
    ds_campo_w := 'CD_NATUREZA_OPERACAO';
    SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'CD_NATUREZA_OPERACAO', c01_w.CD_NATUREZA_OPERACAO, 'N', nota_fiscal_w.CD_NATUREZA_OPERACAO) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_w.CD_NATUREZA_OPERACAO := _ora2pg_r.ds_valor_retorno_p;
    ds_campo_w := 'IE_SITUACAO';
    SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'IE_SITUACAO', c01_w.IE_SITUACAO, 'N', nota_fiscal_w.IE_SITUACAO) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_w.IE_SITUACAO := _ora2pg_r.ds_valor_retorno_p;
    ds_campo_w := 'CD_SERIE_NF';
    SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'CD_SERIE_NF', c01_w.CD_SERIE_NF, 'N', nota_fiscal_w.CD_SERIE_NF) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_w.CD_SERIE_NF := _ora2pg_r.ds_valor_retorno_p;
    ds_campo_w := 'CD_CONDICAO_PAGAMENTO';
    --intpd_processar_atributo(reg_integracao_w, 'NR_SEQUENCIA_NF', c01_w.NR_SEQUENCIA_NF, 'N', nota_fiscal_w.NR_SEQUENCIA_NF);
    SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'CD_CONDICAO_PAGAMENTO', c01_w.CD_CONDICAO_PAGAMENTO, 'N', nota_fiscal_w.CD_CONDICAO_PAGAMENTO) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_w.CD_CONDICAO_PAGAMENTO := _ora2pg_r.ds_valor_retorno_p;
    ds_campo_w := 'DT_ATUALIZACAO_ESTOQUE';
    SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'DT_ATUALIZACAO_ESTOQUE', c01_w.DT_ATUALIZACAO_ESTOQUE, 'N', nota_fiscal_w.DT_ATUALIZACAO_ESTOQUE) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_w.DT_ATUALIZACAO_ESTOQUE := _ora2pg_r.ds_valor_retorno_p;
    ds_campo_w := 'CD_CGC_EMITENTE';
    SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'CD_CGC_EMITENTE', c01_w.CD_CGC_EMITENTE, 'N', nota_fiscal_w.CD_CGC_EMITENTE) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_w.CD_CGC_EMITENTE := _ora2pg_r.ds_valor_retorno_p;
    ds_campo_w := 'NR_ORDEM_COMPRA';
    SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'NR_ORDEM_COMPRA', c01_w.NR_ORDEM_COMPRA, 'N', nota_fiscal_w.NR_ORDEM_COMPRA) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_w.NR_ORDEM_COMPRA := _ora2pg_r.ds_valor_retorno_p;
    ds_campo_w := 'NR_CONTA';
    SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'NR_CONTA', c01_w.NR_CONTA, 'N', nota_fiscal_w.NR_CONTA) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_w.NR_CONTA := _ora2pg_r.ds_valor_retorno_p;
    ds_campo_w := 'NR_SEQ_PROTOCOLO';
    SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'NR_SEQ_PROTOCOLO', c01_w.NR_SEQ_PROTOCOLO, 'N', nota_fiscal_w.NR_SEQ_PROTOCOLO) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_w.NR_SEQ_PROTOCOLO := _ora2pg_r.ds_valor_retorno_p;
    ds_campo_w := 'NR_LOTE_CONTABIL';
    SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'NR_LOTE_CONTABIL', c01_w.NR_LOTE_CONTABIL, 'N', nota_fiscal_w.NR_LOTE_CONTABIL) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_w.NR_LOTE_CONTABIL := _ora2pg_r.ds_valor_retorno_p;
    ds_campo_w := 'NR_SEQ_CLASSIF_FISCAL';
    SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'NR_SEQ_CLASSIF_FISCAL', c01_w.NR_SEQ_CLASSIF_FISCAL, 'N', nota_fiscal_w.NR_SEQ_CLASSIF_FISCAL) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_w.NR_SEQ_CLASSIF_FISCAL := _ora2pg_r.ds_valor_retorno_p;
    ds_campo_w := 'CD_CONV_INTEGRACAO';
    SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'CD_CONV_INTEGRACAO', c01_w.CD_CONV_INTEGRACAO, 'N', nota_fiscal_w.CD_CONV_INTEGRACAO) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_w.CD_CONV_INTEGRACAO := _ora2pg_r.ds_valor_retorno_p;
    ds_campo_w := 'NR_NFE_IMP';
    SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'NR_NFE_IMP', c01_w.NR_NFE_IMP, 'N', nota_fiscal_w.NR_NFE_IMP) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_w.NR_NFE_IMP := _ora2pg_r.ds_valor_retorno_p;
    ds_campo_w := 'IE_STATUS_ENVIO';
    SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'IE_STATUS_ENVIO', c01_w.IE_STATUS_ENVIO, 'N', nota_fiscal_w.IE_STATUS_ENVIO) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_w.IE_STATUS_ENVIO := _ora2pg_r.ds_valor_retorno_p;
    ds_campo_w := 'DS_OBSERVACAO';
    SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'DS_OBSERVACAO', c01_w.DS_OBSERVACAO, 'N', nota_fiscal_w.DS_OBSERVACAO) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_w.DS_OBSERVACAO := _ora2pg_r.ds_valor_retorno_p;
    ds_campo_w := 'CD_PESSOA_FISICA';
    SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'CD_PESSOA_FISICA', c01_w.CD_PESSOA_FISICA, 'N', nota_fiscal_w.CD_PESSOA_FISICA) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_w.CD_PESSOA_FISICA := _ora2pg_r.ds_valor_retorno_p;
    ds_campo_w := 'CD_CGC';
    SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'CD_CGC', c01_w.CD_CGC, 'N', nota_fiscal_w.CD_CGC) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_w.CD_CGC := _ora2pg_r.ds_valor_retorno_p;
    ds_campo_w := 'VL_DESCONTOS';
    SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'VL_DESCONTOS', c01_w.VL_DESCONTOS, 'N', nota_fiscal_w.VL_DESCONTOS) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_w.VL_DESCONTOS := _ora2pg_r.ds_valor_retorno_p;
    ds_campo_w := 'VL_MERCADORIA';
    SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'VL_MERCADORIA', c01_w.VL_MERCADORIA, 'N', nota_fiscal_w.VL_MERCADORIA) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_w.VL_MERCADORIA := _ora2pg_r.ds_valor_retorno_p;
    ds_campo_w := 'VL_TOTAL_NOTA';
    SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'VL_TOTAL_NOTA', c01_w.VL_TOTAL_NOTA, 'N', nota_fiscal_w.VL_TOTAL_NOTA) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_w.VL_TOTAL_NOTA := _ora2pg_r.ds_valor_retorno_p;
    ds_campo_w := 'VL_DESPESA_ACESSORIA';
    SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'VL_DESPESA_ACESSORIA', c01_w.VL_DESPESA_ACESSORIA, 'N', nota_fiscal_w.VL_DESPESA_ACESSORIA) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_w.VL_DESPESA_ACESSORIA := _ora2pg_r.ds_valor_retorno_p;
    ds_campo_w := 'VL_SEGURO';
    SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'VL_SEGURO', c01_w.VL_SEGURO, 'N', nota_fiscal_w.VL_SEGURO) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_w.VL_SEGURO := _ora2pg_r.ds_valor_retorno_p;
    ds_campo_w := 'CD_ESTABELECIMENTO';
    SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'CD_ESTABELECIMENTO', c01_w.CD_ESTABELECIMENTO, 'N', nota_fiscal_w.CD_ESTABELECIMENTO) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_w.CD_ESTABELECIMENTO := _ora2pg_r.ds_valor_retorno_p;
    ds_campo_w := 'CD_VERIFICACAO_NFSE';
    SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'CD_VERIFICACAO_NFSE', c01_w.CD_VERIFICACAO_NFSE, 'N', nota_fiscal_w.CD_VERIFICACAO_NFSE) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_w.CD_VERIFICACAO_NFSE := _ora2pg_r.ds_valor_retorno_p;

    /*Novos campos */

    ds_campo_w := 'NR_CCO';
    SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'NR_CCO', c01_w.nr_cco, 'N', nota_fiscal_w.nr_cco) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_w.nr_cco := _ora2pg_r.ds_valor_retorno_p;
    ds_campo_w := 'NR_CHAVE_CUPOM';
    SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'NR_CHAVE_CUPOM', c01_w.nr_chave_cupom, 'N', nota_fiscal_w.nr_chave_cupom) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_w.nr_chave_cupom := _ora2pg_r.ds_valor_retorno_p;
    ds_campo_w := 'CD_TIPO_PAGAMENTO';
    SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'CD_TIPO_PAGAMENTO', c01_w.cd_tipo_pagamento, 'N', cd_tipo_pagamento_w) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; cd_tipo_pagamento_w := _ora2pg_r.ds_valor_retorno_p;
    
    nota_fiscal_w.nm_usuario    := 'TASY';
    nota_fiscal_w.dt_atualizacao    := clock_timestamp();
    nota_fiscal_w.ie_acao_nf    := 1;
    nota_fiscal_w.ie_emissao_nf    := 0;
    nota_fiscal_w.ie_tipo_frete    := 0;
    nota_fiscal_w.qt_peso_bruto    := 0;
    nota_fiscal_w.qt_peso_liquido  := 0;
	nota_fiscal_w.dt_atualizacao_estoque := null; --Null pois agora a rotina de atualizar_nota_fiscal preenche esse campo no calculo.
    ds_campo_w := 'final das atribuicoes';
	

    --if      (reg_integracao_w.qt_reg_log = 0) then verificar com Peterson
      select  nextval('nota_fiscal_seq')
      into STRICT    nota_fiscal_w.nr_sequencia
;
      /*Fiz aqui igual ocorre no CorNfe_f8 para o NR_SEQUENCIA_NF criada manualmente*/

      select  coalesce(max(nr_sequencia_nf),0) + 1  
      into STRICT  nota_fiscal_w.nr_sequencia_nf
      from  nota_fiscal
      where  cd_estabelecimento  = nota_fiscal_w.cd_estabelecimento
      and  cd_serie_nf      = nota_fiscal_w.cd_serie_nf
      and  nr_nota_fiscal    = nota_fiscal_w.nr_nota_fiscal;

      insert into nota_fiscal values (nota_fiscal_w.*);

      ie_atualizou_w  := 'S';

    --end if;
  
  else
    delete  FROM nota_fiscal
    where  nr_sequencia = nota_fiscal_w.nr_sequencia;
    ie_atualizou_w  := 'S';
  end if;

  if (ie_atualizou_w = 'S')  then
    update  intpd_fila_transmissao
    set  ie_status = 'S',
      nr_seq_documento = nota_fiscal_w.nr_sequencia
    where  nr_sequencia = nr_sequencia_p;
  end if;
  ds_campo_w := 'antes do cursor 2';
  open c02;
  loop
  fetch c02 into
    c02_w;
  EXIT WHEN NOT FOUND; /* apply on c02 */
    begin
    ds_campo_w := 'qualquer';
    reg_integracao_w.nm_tabela    :=  'NOTA_FISCAL_ITEM';
    reg_integracao_w.nm_elemento  :=  'ITEMS';
    reg_integracao_w.nr_seq_visao  :=  0;

    nota_fiscal_item_w.nr_sequencia    :=  nota_fiscal_w.nr_sequencia;
    nota_fiscal_item_w.cd_estabelecimento  :=   nota_fiscal_w.cd_estabelecimento;

    if (nota_fiscal_item_w.nr_sequencia IS NOT NULL AND nota_fiscal_item_w.nr_sequencia::text <> '') then
    begin
    /*'Busca o registro atual do Tasy pela PK'*/

    select  *
    into STRICT  nota_fiscal_item_w
    from  nota_fiscal_item
    where  nr_sequencia = nota_fiscal_item_w.nr_sequencia;
    exception
    when others then
      nota_fiscal_item_w.nr_sequencia  := null;
    end;
    end if;
    
    if (coalesce(ds_action,'INSERT') <> 'DELETE') THEN
      ds_campo_w := 'CD_MATERIAL';
      SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'CD_MATERIAL', c02_w.CD_MATERIAL, 'N', nota_fiscal_item_w.CD_MATERIAL) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_item_w.CD_MATERIAL := _ora2pg_r.ds_valor_retorno_p;
      ds_campo_w := 'NR_ITEM_NF';
      SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'NR_ITEM_NF', c02_w.NR_ITEM_NF, 'N', nota_fiscal_item_w.NR_ITEM_NF) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_item_w.NR_ITEM_NF := _ora2pg_r.ds_valor_retorno_p;
      ds_campo_w := 'NR_ATENDIMENTO';
      SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'NR_ATENDIMENTO', c02_w.NR_ATENDIMENTO, 'N', nota_fiscal_item_w.NR_ATENDIMENTO) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_item_w.NR_ATENDIMENTO := _ora2pg_r.ds_valor_retorno_p;
      ds_campo_w := 'NR_ORDEM_COMPRA';
      SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'NR_ORDEM_COMPRA', c02_w.NR_ORDEM_COMPRA, 'N', nota_fiscal_item_w.NR_ORDEM_COMPRA) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_item_w.NR_ORDEM_COMPRA := _ora2pg_r.ds_valor_retorno_p;
      ds_campo_w := 'NR_ITEM_OCI';
      SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'NR_ITEM_OCI', c02_w.NR_ITEM_OCI, 'N', nota_fiscal_item_w.NR_ITEM_OCI) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_item_w.NR_ITEM_OCI := _ora2pg_r.ds_valor_retorno_p;
      ds_campo_w := 'CD_PROCEDIMENTO';
      SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'CD_PROCEDIMENTO', c02_w.CD_PROCEDIMENTO, 'N', nota_fiscal_item_w.CD_PROCEDIMENTO) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_item_w.CD_PROCEDIMENTO := _ora2pg_r.ds_valor_retorno_p;
      ds_campo_w := 'NR_SEQ_PROC_INTERNO';
      SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'NR_SEQ_PROC_INTERNO', c02_w.NR_SEQ_PROC_INTERNO, 'N', nota_fiscal_item_w.NR_SEQ_PROC_INTERNO) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_item_w.NR_SEQ_PROC_INTERNO := _ora2pg_r.ds_valor_retorno_p;
      ds_campo_w := 'CD_IMOBILIZADO';
      SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'CD_IMOBILIZADO', c02_w.CD_IMOBILIZADO, 'N', nota_fiscal_item_w.CD_IMOBILIZADO) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_item_w.CD_IMOBILIZADO := _ora2pg_r.ds_valor_retorno_p;
      ds_campo_w := 'CD_IMOB_SERIE';
      SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'CD_IMOB_SERIE', c02_w.CD_IMOB_SERIE, 'N', nota_fiscal_item_w.CD_IMOB_SERIE) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_item_w.CD_IMOB_SERIE := _ora2pg_r.ds_valor_retorno_p;
      ds_campo_w := 'CD_UNIDADE_MEDIDA_COMPRA';
      SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'CD_UNIDADE_MEDIDA_COMPRA', c02_w.CD_UNIDADE_MEDIDA_COMPRA, 'N', nota_fiscal_item_w.CD_UNIDADE_MEDIDA_COMPRA) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_item_w.CD_UNIDADE_MEDIDA_COMPRA := _ora2pg_r.ds_valor_retorno_p;
      ds_campo_w := 'DT_ENTREGA_ORDEM';
      SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'DT_ENTREGA_ORDEM', c02_w.DT_ENTREGA_ORDEM, 'N', nota_fiscal_item_w.DT_ENTREGA_ORDEM) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_item_w.DT_ENTREGA_ORDEM := _ora2pg_r.ds_valor_retorno_p;
      ds_campo_w := 'QT_ITEM_NF';
      SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'QT_ITEM_NF', c02_w.QT_ITEM_NF, 'N', nota_fiscal_item_w.QT_ITEM_NF) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_item_w.QT_ITEM_NF := _ora2pg_r.ds_valor_retorno_p;
      ds_campo_w := 'VL_UNITARIO_ITEM_NF';
      SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'VL_UNITARIO_ITEM_NF', c02_w.VL_UNITARIO_ITEM_NF, 'N', nota_fiscal_item_w.VL_UNITARIO_ITEM_NF) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_item_w.VL_UNITARIO_ITEM_NF := _ora2pg_r.ds_valor_retorno_p;
      ds_campo_w := 'PR_DESCONTO';
      SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'PR_DESCONTO', c02_w.PR_DESCONTO, 'N', nota_fiscal_item_w.PR_DESCONTO) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_item_w.PR_DESCONTO := _ora2pg_r.ds_valor_retorno_p;
      ds_campo_w := 'VL_DESCONTO';
      SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'VL_DESCONTO', c02_w.VL_DESCONTO, 'N', nota_fiscal_item_w.VL_DESCONTO) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_item_w.VL_DESCONTO := _ora2pg_r.ds_valor_retorno_p;
      ds_campo_w := 'VL_DESC_FINANC';
      SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'VL_DESC_FINANC', c02_w.VL_DESC_FINANC, 'N', nota_fiscal_item_w.VL_DESC_FINANC) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_item_w.VL_DESC_FINANC := _ora2pg_r.ds_valor_retorno_p;
      ds_campo_w := 'VL_TOTAL_ITEM_NF';
      SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'VL_TOTAL_ITEM_NF', c02_w.VL_TOTAL_ITEM_NF, 'N', nota_fiscal_item_w.VL_TOTAL_ITEM_NF) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_item_w.VL_TOTAL_ITEM_NF := _ora2pg_r.ds_valor_retorno_p;
      ds_campo_w := 'CD_UNIDADE_MEDIDA_ESTOQUE';
      SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'CD_UNIDADE_MEDIDA_ESTOQUE', c02_w.CD_UNIDADE_MEDIDA_ESTOQUE, 'N', nota_fiscal_item_w.CD_UNIDADE_MEDIDA_ESTOQUE) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_item_w.CD_UNIDADE_MEDIDA_ESTOQUE := _ora2pg_r.ds_valor_retorno_p;
      ds_campo_w := 'QT_ITEM_ESTOQUE';
      SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'QT_ITEM_ESTOQUE', c02_w.QT_ITEM_ESTOQUE, 'N', nota_fiscal_item_w.QT_ITEM_ESTOQUE) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_item_w.QT_ITEM_ESTOQUE := _ora2pg_r.ds_valor_retorno_p;
      ds_campo_w := 'VL_LIQUIDO';
      SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'VL_LIQUIDO', c02_w.VL_LIQUIDO, 'N', nota_fiscal_item_w.VL_LIQUIDO) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_item_w.VL_LIQUIDO := _ora2pg_r.ds_valor_retorno_p;
      ds_campo_w := 'CD_LOCAL_ESTOQUE';
      SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'CD_LOCAL_ESTOQUE', c02_w.CD_LOCAL_ESTOQUE, 'N', nota_fiscal_item_w.CD_LOCAL_ESTOQUE) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_item_w.CD_LOCAL_ESTOQUE := _ora2pg_r.ds_valor_retorno_p;
      ds_campo_w := 'CD_CONTA_CONTABIL';
      SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'CD_CONTA_CONTABIL', c02_w.CD_CONTA_CONTABIL, 'N', nota_fiscal_item_w.CD_CONTA_CONTABIL) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_item_w.CD_CONTA_CONTABIL := _ora2pg_r.ds_valor_retorno_p;
      ds_campo_w := 'CD_NATUREZA_OPERACAO';
      SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'CD_NATUREZA_OPERACAO', c02_w.CD_NATUREZA_OPERACAO, 'N', nota_fiscal_item_w.CD_NATUREZA_OPERACAO) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_item_w.CD_NATUREZA_OPERACAO := _ora2pg_r.ds_valor_retorno_p;
      ds_campo_w := 'CD_CENTRO_CUSTO';
      SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'CD_CENTRO_CUSTO', c02_w.CD_CENTRO_CUSTO, 'N', nota_fiscal_item_w.CD_CENTRO_CUSTO) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_item_w.CD_CENTRO_CUSTO := _ora2pg_r.ds_valor_retorno_p;
      ds_campo_w := 'NR_CONTRATO';
      SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'NR_CONTRATO', c02_w.NR_CONTRATO, 'N', nota_fiscal_item_w.NR_CONTRATO) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_item_w.NR_CONTRATO := _ora2pg_r.ds_valor_retorno_p;
      ds_campo_w := 'NR_SEQ_CONTA_FINANC';

      SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'NR_SEQ_CONTA_FINANC', c02_w.NR_SEQ_CONTA_FINANC, 'N', nota_fiscal_item_w.NR_SEQ_CONTA_FINANC) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_item_w.NR_SEQ_CONTA_FINANC := _ora2pg_r.ds_valor_retorno_p;
      ds_campo_w := 'NR_SEQ_PROJ_REC';
      SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'NR_SEQ_PROJ_REC', c02_w.NR_SEQ_PROJ_REC, 'N', nota_fiscal_item_w.NR_SEQ_PROJ_REC) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_item_w.NR_SEQ_PROJ_REC := _ora2pg_r.ds_valor_retorno_p;
      ds_campo_w := 'DS_OBSERVACAO';
      SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'DS_OBSERVACAO', c02_w.DS_OBSERVACAO, 'N', nota_fiscal_item_w.DS_OBSERVACAO) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_item_w.DS_OBSERVACAO := _ora2pg_r.ds_valor_retorno_p;
      ds_campo_w := 'DS_COMPLEMENTO';
      SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'DS_COMPLEMENTO', c02_w.DS_COMPLEMENTO, 'N', nota_fiscal_item_w.DS_COMPLEMENTO) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_item_w.DS_COMPLEMENTO := _ora2pg_r.ds_valor_retorno_p;
      ds_campo_w := 'CD_LOTE_FABRICACAO';
      SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'CD_LOTE_FABRICACAO', c02_w.CD_LOTE_FABRICACAO, 'N', nota_fiscal_item_w.CD_LOTE_FABRICACAO) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_item_w.CD_LOTE_FABRICACAO := _ora2pg_r.ds_valor_retorno_p;
      ds_campo_w := 'DT_VALIDADE';
      SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'DT_VALIDADE', c02_w.DT_VALIDADE, 'N', nota_fiscal_item_w.DT_VALIDADE) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_item_w.DT_VALIDADE := _ora2pg_r.ds_valor_retorno_p;
      ds_campo_w := 'DS_JUSTIFICATIVA';
      SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'DS_JUSTIFICATIVA', c02_w.DS_JUSTIFICATIVA, 'N', nota_fiscal_item_w.DS_JUSTIFICATIVA) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_item_w.DS_JUSTIFICATIVA := _ora2pg_r.ds_valor_retorno_p;
      ds_campo_w := 'DT_FABRICACAO';
      SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'DT_FABRICACAO', c02_w.DT_FABRICACAO, 'N', nota_fiscal_item_w.DT_FABRICACAO) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_item_w.DT_FABRICACAO := _ora2pg_r.ds_valor_retorno_p;
      ds_campo_w := 'IE_INDETERMINADO';
      SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'IE_INDETERMINADO', c02_w.IE_INDETERMINADO, 'N', nota_fiscal_item_w.IE_INDETERMINADO) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_item_w.IE_INDETERMINADO := _ora2pg_r.ds_valor_retorno_p;
      ds_campo_w := 'NR_SEQ_MARCA';
      SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'NR_SEQ_MARCA', c02_w.NR_SEQ_MARCA, 'N', nota_fiscal_item_w.NR_SEQ_MARCA) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_item_w.NR_SEQ_MARCA := _ora2pg_r.ds_valor_retorno_p;
      ds_campo_w := 'DT_INICIO_GARANTIA';
      SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'DT_INICIO_GARANTIA', c02_w.DT_INICIO_GARANTIA, 'N', nota_fiscal_item_w.DT_INICIO_GARANTIA) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_item_w.DT_INICIO_GARANTIA := _ora2pg_r.ds_valor_retorno_p;
      ds_campo_w := 'DT_FIM_GARANTIA';

      SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'DT_FIM_GARANTIA', c02_w.DT_FIM_GARANTIA, 'N', nota_fiscal_item_w.DT_FIM_GARANTIA) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_item_w.DT_FIM_GARANTIA := _ora2pg_r.ds_valor_retorno_p;
      ds_campo_w := 'NR_SERIE_MATERIAL';
      SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'NR_SERIE_MATERIAL', c02_w.NR_SERIE_MATERIAL, 'N', nota_fiscal_item_w.NR_SERIE_MATERIAL) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_item_w.NR_SERIE_MATERIAL := _ora2pg_r.ds_valor_retorno_p;
      ds_campo_w := 'CD_PACIENTE';
      SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'CD_PACIENTE', c02_w.CD_PACIENTE, 'N', nota_fiscal_item_w.CD_PACIENTE) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_item_w.CD_PACIENTE := _ora2pg_r.ds_valor_retorno_p;
      ds_campo_w := 'NR_SEQ_MODELO';
      SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'NR_SEQ_MODELO', c02_w.NR_SEQ_MODELO, 'N', nota_fiscal_item_w.NR_SEQ_MODELO) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_item_w.NR_SEQ_MODELO := _ora2pg_r.ds_valor_retorno_p;
      ds_campo_w := 'NR_SEQ_CLASSIF_TRIB';
      SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'NR_SEQ_CLASSIF_TRIB', c02_w.NR_SEQ_CLASSIF_TRIB, 'N', nota_fiscal_item_w.NR_SEQ_CLASSIF_TRIB) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_item_w.NR_SEQ_CLASSIF_TRIB := _ora2pg_r.ds_valor_retorno_p;
      ds_campo_w := 'VL_DESPESA_ACESSORIA';
      SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'VL_DESPESA_ACESSORIA', coalesce(c02_w.VL_DESPESA_ACESSORIA,0), 'N', nota_fiscal_item_w.VL_DESPESA_ACESSORIA) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_item_w.VL_DESPESA_ACESSORIA := _ora2pg_r.ds_valor_retorno_p;
      ds_campo_w := 'VL_DESCONTO_RATEIO';

      SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'VL_DESCONTO_RATEIO', coalesce(c02_w.VL_DESCONTO_RATEIO,0), 'N', nota_fiscal_item_w.VL_DESCONTO_RATEIO) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_item_w.VL_DESCONTO_RATEIO := _ora2pg_r.ds_valor_retorno_p;
      ds_campo_w := 'VL_SEGURO';
      SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'VL_SEGURO', coalesce(c02_w.VL_SEGURO,0), 'N', nota_fiscal_item_w.VL_SEGURO) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_item_w.VL_SEGURO := _ora2pg_r.ds_valor_retorno_p;

      nota_fiscal_item_w.nm_usuario    := 'TASY';
      nota_fiscal_item_w.dt_atualizacao  := clock_timestamp();

    
      if (reg_integracao_w.qt_reg_log = 0) then
        begin
        ds_campo_w := 'if depois do cursor 2';
        nota_fiscal_item_w.nr_sequencia   := nota_fiscal_w.nr_sequencia;
        nota_fiscal_item_w.cd_serie_nf     := nota_fiscal_w.cd_serie_nf;
        nota_fiscal_item_w.nr_sequencia_nf   := nota_fiscal_w.nr_sequencia_nf;
        nota_fiscal_item_w.vl_frete      := 0;
        insert into nota_fiscal_item values (nota_fiscal_item_w.*);
        ie_atualizou_w  := 'S';
        end;

      end if;

      
    else
      delete  FROM nota_fiscal_item
      where  nr_item_nf = nota_fiscal_item_w.nr_item_nf
      and  cd_material = nota_fiscal_item_w.cd_material
      and  nr_sequencia = nota_fiscal_item_w.nr_sequencia;
    end if;
    ds_campo_w := 'antes do cursor 3';
    open c03;
    loop
    fetch c03 into
      c03_w;
    EXIT WHEN NOT FOUND; /* apply on c03 */
      begin
      ds_campo_w := 'dentro do cursor 3';
      reg_integracao_w.nm_tabela    :=  'NOTA_FISCAL_ITEM_TRIB';
      reg_integracao_w.nm_elemento  :=  'TRIBUTES_ITEM';
      reg_integracao_w.nr_seq_visao  :=  0;

      nota_fiscal_item_trib_w.nr_sequencia  :=  nota_fiscal_w.nr_sequencia;

      nota_fiscal_item_trib_w.nr_item_nf    :=  nota_fiscal_item_w.nr_item_nf;

      if (coalesce(ds_action,'INSERT') <> 'DELETE') THEN
        SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'CD_TRIBUTO', c03_w.CD_TRIBUTO, 'N', nota_fiscal_item_trib_w.CD_TRIBUTO) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_item_trib_w.CD_TRIBUTO := _ora2pg_r.ds_valor_retorno_p;
        SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'VL_BASE_CALCULO', c03_w.VL_BASE_CALCULO, 'N', nota_fiscal_item_trib_w.VL_BASE_CALCULO) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_item_trib_w.VL_BASE_CALCULO := _ora2pg_r.ds_valor_retorno_p;
        SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'VL_REDUCAO_BASE', c03_w.VL_REDUCAO_BASE, 'N', nota_fiscal_item_trib_w.VL_REDUCAO_BASE) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_item_trib_w.VL_REDUCAO_BASE := _ora2pg_r.ds_valor_retorno_p;
        SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'TX_TRIBUTO', c03_w.TX_TRIBUTO, 'N', nota_fiscal_item_trib_w.TX_TRIBUTO) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_item_trib_w.TX_TRIBUTO := _ora2pg_r.ds_valor_retorno_p;
        SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'VL_TRIBUTO', c03_w.VL_TRIBUTO, 'N', nota_fiscal_item_trib_w.VL_TRIBUTO) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_item_trib_w.VL_TRIBUTO := _ora2pg_r.ds_valor_retorno_p;
        SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'NR_SEQ_SIT_TRIB', c03_w.NR_SEQ_SIT_TRIB, 'N', nota_fiscal_item_trib_w.NR_SEQ_SIT_TRIB) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_item_trib_w.NR_SEQ_SIT_TRIB := _ora2pg_r.ds_valor_retorno_p;
        SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'IE_TRIBUTACAO_CST', c03_w.IE_TRIBUTACAO_CST, 'N', nota_fiscal_item_trib_w.IE_TRIBUTACAO_CST) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_item_trib_w.IE_TRIBUTACAO_CST := _ora2pg_r.ds_valor_retorno_p;
        SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'IE_TRIBUTACAO_CSOSN', c03_w.IE_TRIBUTACAO_CSOSN, 'N', nota_fiscal_item_trib_w.IE_TRIBUTACAO_CSOSN) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_item_trib_w.IE_TRIBUTACAO_CSOSN := _ora2pg_r.ds_valor_retorno_p;

        nota_fiscal_item_trib_w.nm_usuario  := 'TASY';
        nota_fiscal_item_trib_w.dt_atualizacao  := clock_timestamp();
        nota_fiscal_item_trib_w.cd_estabelecimento := nota_fiscal_w.cd_estabelecimento;
        nota_fiscal_item_trib_w.cd_serie_nf := nota_fiscal_w.cd_serie_nf;
        nota_fiscal_item_trib_w.nr_sequencia_nf := nota_fiscal_w.nr_sequencia_nf;

        if (nota_fiscal_item_trib_w.cd_tributo IS NOT NULL AND nota_fiscal_item_trib_w.cd_tributo::text <> '') then
          begin
          /*'Busca o registro atual do Tasy pela PK'*/

          ds_campo_w := nota_fiscal_item_trib_w.cd_tributo||' - '||nota_fiscal_item_trib_w.nr_sequencia;
            select  *
            into STRICT  nota_fiscal_item_trib_w
            from  nota_fiscal_item_trib
            where  cd_tributo = nota_fiscal_item_trib_w.cd_tributo
            and  nr_sequencia = nota_fiscal_item_trib_w.nr_sequencia;
          exception
          when others then
            nota_fiscal_item_trib_w.nr_sequencia  :=  null;
          end;
        end if;

        if (reg_integracao_w.qt_reg_log = 0) then
          begin
          if (nota_fiscal_item_trib_w.cd_tributo IS NOT NULL AND nota_fiscal_item_trib_w.cd_tributo::text <> '') then
            begin
              update  nota_fiscal_item_trib
              set  row = nota_fiscal_item_trib_w
              where  cd_tributo = nota_fiscal_item_trib_w.cd_tributo
              and  nr_sequencia = nota_fiscal_item_trib_w.nr_sequencia;
            end;
          else

            
            insert into nota_fiscal_item_trib values (nota_fiscal_item_trib_w.*);

          end if;
          ie_atualizou_w  := 'S';
          end;

        end if;

      else
        delete  FROM nota_fiscal_item_trib
        where  cd_tributo = nota_fiscal_item_trib_w.cd_tributo
        and  nr_sequencia = nota_fiscal_item_trib_w.nr_sequencia;
      end if;
      end;
    end loop;
    close c03;
    
    end;
  end loop;
  close c02;

  open c04;
  loop
  fetch c04 into
    c04_w;
  EXIT WHEN NOT FOUND; /* apply on c04 */
    begin

    reg_integracao_w.nm_tabela    :=  'NOTA_FISCAL_TRIB';
    reg_integracao_w.nm_elemento  :=  'TRIBUTES';
    reg_integracao_w.nr_seq_visao  :=  0;

    nota_fiscal_trib_w.nr_sequencia  :=  nota_fiscal_w.nr_sequencia;

    if (coalesce(ds_action,'INSERT') <> 'DELETE') THEN    
      SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'CD_TRIBUTO', c04_w.CD_TRIBUTO, 'N', nota_fiscal_trib_w.CD_TRIBUTO) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_trib_w.CD_TRIBUTO := _ora2pg_r.ds_valor_retorno_p;
      SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'VL_BASE_CALCULO', c04_w.VL_BASE_CALCULO, 'N', nota_fiscal_trib_w.VL_BASE_CALCULO) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_trib_w.VL_BASE_CALCULO := _ora2pg_r.ds_valor_retorno_p;
      SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'VL_REDUCAO', c04_w.VL_REDUCAO, 'N', nota_fiscal_trib_w.VL_REDUCAO) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_trib_w.VL_REDUCAO := _ora2pg_r.ds_valor_retorno_p;
      SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'VL_REDUCAO_BASE', c04_w.VL_REDUCAO_BASE, 'N', nota_fiscal_trib_w.VL_REDUCAO_BASE) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_trib_w.VL_REDUCAO_BASE := _ora2pg_r.ds_valor_retorno_p;
      SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'TX_TRIBUTO', c04_w.TX_TRIBUTO, 'N', nota_fiscal_trib_w.TX_TRIBUTO) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_trib_w.TX_TRIBUTO := _ora2pg_r.ds_valor_retorno_p;
      SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'VL_TRIBUTO', c04_w.VL_TRIBUTO, 'N', nota_fiscal_trib_w.VL_TRIBUTO) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_trib_w.VL_TRIBUTO := _ora2pg_r.ds_valor_retorno_p;
      SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'VL_BASE_NAO_RETIDO', c04_w.VL_BASE_NAO_RETIDO, 'N', nota_fiscal_trib_w.VL_BASE_NAO_RETIDO) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_trib_w.VL_BASE_NAO_RETIDO := _ora2pg_r.ds_valor_retorno_p;
      SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'VL_BASE_ADIC', c04_w.VL_BASE_ADIC, 'N', nota_fiscal_trib_w.VL_BASE_ADIC) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_trib_w.VL_BASE_ADIC := _ora2pg_r.ds_valor_retorno_p;
      SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'VL_TRIB_NAO_RETIDO', c04_w.VL_TRIB_NAO_RETIDO, 'N', nota_fiscal_trib_w.VL_TRIB_NAO_RETIDO) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_trib_w.VL_TRIB_NAO_RETIDO := _ora2pg_r.ds_valor_retorno_p;
      SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'VL_TRIB_ADIC', c04_w.VL_TRIB_ADIC, 'N', nota_fiscal_trib_w.VL_TRIB_ADIC) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_trib_w.VL_TRIB_ADIC := _ora2pg_r.ds_valor_retorno_p;
      SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'VL_BC_MATRIZ_FILIAL', c04_w.VL_BC_MATRIZ_FILIAL, 'N', nota_fiscal_trib_w.VL_BC_MATRIZ_FILIAL) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_trib_w.VL_BC_MATRIZ_FILIAL := _ora2pg_r.ds_valor_retorno_p;
      SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'IE_RETENCAO', c04_w.IE_RETENCAO, 'N', nota_fiscal_trib_w.IE_RETENCAO) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_trib_w.IE_RETENCAO := _ora2pg_r.ds_valor_retorno_p;
      nota_fiscal_trib_w.nm_usuario  := 'TASY';
      nota_fiscal_trib_w.dt_atualizacao  := clock_timestamp();

      if (nota_fiscal_trib_w.cd_tributo IS NOT NULL AND nota_fiscal_trib_w.cd_tributo::text <> '') then
        begin
        /*'Busca o registro atual do Tasy pela PK'*/

          select  *
          into STRICT  nota_fiscal_trib_w
          from  nota_fiscal_trib
          where  cd_tributo = nota_fiscal_trib_w.cd_tributo
          and  nr_sequencia = nota_fiscal_trib_w.nr_sequencia;
        exception
        when others then
          nota_fiscal_trib_w.nr_sequencia  :=  null;
        end;
      end if;

      if (reg_integracao_w.qt_reg_log = 0) then
        begin
        if (nota_fiscal_trib_w.cd_tributo IS NOT NULL AND nota_fiscal_trib_w.cd_tributo::text <> '') then
          begin
            update  nota_fiscal_trib
            set  row = nota_fiscal_trib_w
            where  cd_tributo = nota_fiscal_trib_w.cd_tributo
            and  nr_sequencia = nota_fiscal_trib_w.nr_sequencia;
          end;
        else

                    
          select   max(coalesce(nr_seq_interno,0))+1
          into STRICT    nota_fiscal_trib_w.nr_seq_interno
          from   nota_fiscal_trib
          where   nr_sequencia = nota_fiscal_trib_w.nr_sequencia;


          insert into nota_fiscal_trib values (nota_fiscal_trib_w.*);

        end if;
        ie_atualizou_w  := 'S';
        end;

      end if;

    else
      delete  FROM nota_fiscal_trib
      where  cd_tributo = nota_fiscal_trib_w.cd_tributo
      and  nr_sequencia = nota_fiscal_trib_w.nr_sequencia;
    end if;

    end;
  end loop;
  close c04;

  open c05;
  loop
  fetch c05 into
    c05_w;
  EXIT WHEN NOT FOUND; /* apply on c05 */
    begin

    reg_integracao_w.nm_tabela    :=  'NOTA_FISCAL_TRANSPORTADORA';
    reg_integracao_w.nm_elemento  :=  'FREIGHTS';
    reg_integracao_w.nr_seq_visao  :=  0;

    nota_fiscal_transportadora_w.nr_seq_nota  :=  nota_fiscal_w.nr_sequencia;

    if (coalesce(ds_action,'INSERT') <> 'DELETE') THEN  
      --intpd_processar_atributo(reg_integracao_w, 'VL_FRETE', c05_w.VL_FRETE, 'N', nota_fiscal_transportadora_w.VL_FRETE);
      SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'CD_CNPJ', c05_w.CD_CNPJ, 'N', nota_fiscal_transportadora_w.CD_CNPJ) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_transportadora_w.CD_CNPJ := _ora2pg_r.ds_valor_retorno_p;
      SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'IE_TIPO_FRETE', c05_w.IE_TIPO_FRETE, 'N', nota_fiscal_transportadora_w.IE_TIPO_FRETE) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_transportadora_w.IE_TIPO_FRETE := _ora2pg_r.ds_valor_retorno_p;
      SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'NR_PLACA_VEICULO', c05_w.NR_PLACA_VEICULO, 'N', nota_fiscal_transportadora_w.NR_PLACA_VEICULO) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_transportadora_w.NR_PLACA_VEICULO := _ora2pg_r.ds_valor_retorno_p;
      SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'UF_PLACA_VEICULO', c05_w.UF_PLACA_VEICULO, 'N', nota_fiscal_transportadora_w.UF_PLACA_VEICULO) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_transportadora_w.UF_PLACA_VEICULO := _ora2pg_r.ds_valor_retorno_p;
      SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'DS_ESPECIE', c05_w.DS_ESPECIE, 'N', nota_fiscal_transportadora_w.DS_ESPECIE) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_transportadora_w.DS_ESPECIE := _ora2pg_r.ds_valor_retorno_p;
      SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'QT_TRANSPORTE', c05_w.QT_TRANSPORTE, 'N', nota_fiscal_transportadora_w.QT_TRANSPORTE) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_transportadora_w.QT_TRANSPORTE := _ora2pg_r.ds_valor_retorno_p;
      SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'QT_VOLUME', c05_w.QT_VOLUME, 'N', nota_fiscal_transportadora_w.QT_VOLUME) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_transportadora_w.QT_VOLUME := _ora2pg_r.ds_valor_retorno_p;
      SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'QT_PESO_BRUTO', c05_w.QT_PESO_BRUTO, 'N', nota_fiscal_transportadora_w.QT_PESO_BRUTO) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_transportadora_w.QT_PESO_BRUTO := _ora2pg_r.ds_valor_retorno_p;
      SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'QT_PESO_LIQUIDO', c05_w.QT_PESO_LIQUIDO, 'N', nota_fiscal_transportadora_w.QT_PESO_LIQUIDO) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_transportadora_w.QT_PESO_LIQUIDO := _ora2pg_r.ds_valor_retorno_p;
      SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'NR_LACRE', c05_w.NR_LACRE, 'N', nota_fiscal_transportadora_w.NR_LACRE) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_transportadora_w.NR_LACRE := _ora2pg_r.ds_valor_retorno_p;
      nota_fiscal_transportadora_w.nm_usuario  := 'TASY';
      nota_fiscal_transportadora_w.dt_atualizacao  := clock_timestamp();

      if (nota_fiscal_transportadora_w.cd_cnpj IS NOT NULL AND nota_fiscal_transportadora_w.cd_cnpj::text <> '') then
        begin
        /*'Busca o registro atual do Tasy pela PK'*/

          select  *
          into STRICT  nota_fiscal_transportadora_w
          from  nota_fiscal_transportadora
          where  nr_seq_nota = nota_fiscal_transportadora_w.nr_seq_nota;
        exception
        when others then
          nota_fiscal_transportadora_w.nr_seq_nota  :=  null;
        end;
      end if;

      if (reg_integracao_w.qt_reg_log = 0) then
        begin
        if (nota_fiscal_transportadora_w.cd_cnpj IS NOT NULL AND nota_fiscal_transportadora_w.cd_cnpj::text <> '') then
          begin
            update  nota_fiscal_transportadora
            set  row = nota_fiscal_transportadora_w
            where  nr_seq_nota = nota_fiscal_transportadora_w.nr_seq_nota;

            if (c05_w.VL_FRETE IS NOT NULL AND c05_w.VL_FRETE::text <> '') then
              update nota_fiscal 
              set vl_frete = c05_w.VL_FRETE
              where nr_sequencia = nota_fiscal_w.nr_sequencia;
            end if;

          end;
        else

          select  max(coalesce(nr_sequencia,0)) +1
          into STRICT    nota_fiscal_transportadora_w.nr_sequencia
          from    nota_fiscal_transportadora
          where   nr_seq_nota =  nota_fiscal_transportadora_w.nr_seq_nota;


          insert into nota_fiscal_transportadora values (nota_fiscal_transportadora_w.*);

          if (c05_w.VL_FRETE IS NOT NULL AND c05_w.VL_FRETE::text <> '') then
            update nota_fiscal 
            set vl_frete = c05_w.VL_FRETE
            where nr_sequencia = nota_fiscal_w.nr_sequencia;
          end if;

        end if;
        ie_atualizou_w  := 'S';
        end;

      end if;

    else
      delete  FROM nota_fiscal_transportadora
      where  nr_seq_nota = nota_fiscal_transportadora_w.nr_seq_nota;
    end if;

    end;
  end loop;
  close c05;
  
  /*
  open c06;
  loop
  fetch c06 into  
    c06_w;
  exit when c06%notfound;
    begin
    reg_integracao_w.nm_tabela    :=  'NOTA_FISCAL_VENC';
    reg_integracao_w.nm_elemento    :=  'DUES';
    reg_integracao_w.nr_seq_visao    :=  0;
    
    nota_fiscal_venc_w.nr_sequencia    :=  nota_fiscal_w.nr_sequencia;
    
    if  (nvl(ds_action,'INSERT') <> 'DELETE') THEN    
      intpd_processar_atributo(reg_integracao_w, 'DT_VENCIMENTO', c06_w.DT_VENCIMENTO, 'N', nota_fiscal_venc_w.DT_VENCIMENTO);
      intpd_processar_atributo(reg_integracao_w, 'VL_VENCIMENTO', c06_w.VL_VENCIMENTO, 'N', nota_fiscal_venc_w.VL_VENCIMENTO);
      intpd_processar_atributo(reg_integracao_w, 'VL_BASE_VENC', c06_w.VL_BASE_VENC, 'N', nota_fiscal_venc_w.VL_BASE_VENC);
      intpd_processar_atributo(reg_integracao_w, 'VL_DESCONTO', c06_w.VL_DESCONTO, 'N', nota_fiscal_venc_w.VL_DESCONTO);
      intpd_processar_atributo(reg_integracao_w, 'VL_DESC_FINANC', c06_w.VL_DESC_FINANC, 'N', nota_fiscal_venc_w.VL_DESC_FINANC);
      intpd_processar_atributo(reg_integracao_w, 'NR_TITULO_PAGAR', c06_w.NR_TITULO_PAGAR, 'N', nota_fiscal_venc_w.NR_TITULO_PAGAR);
      intpd_processar_atributo(reg_integracao_w, 'DS_OBSERVACAO', c06_w.DS_OBSERVACAO, 'N', nota_fiscal_venc_w.DS_OBSERVACAO);
          
      nota_fiscal_venc_w.nm_usuario  := 'TASY';
      nota_fiscal_venc_w.dt_atualizacao  := sysdate;

      if  (nota_fiscal_venc_w.dt_vencimento is not null) then
        begin
        --'Busca o registro atual do Tasy pela PK'

          select  *
          into  nota_fiscal_venc_w
          from  nota_fiscal_venc
          where  nr_sequencia = nota_fiscal_trib_w.nr_sequencia;
        exception
        when others then
          nota_fiscal_venc_w.nr_sequencia  :=  null;
        end;
      end if;
      
      if      (reg_integracao_w.qt_reg_log = 0) then
        begin
        if  (nota_fiscal_venc_w.dt_vencimento is not null) then
          begin
            update  nota_fiscal_venc
            set  row = nota_fiscal_venc_w
            where  nr_sequencia = nota_fiscal_venc_w.nr_sequencia;
          end;
        else
          
          select  nota_fiscal_venc.nextval
          into    nota_fiscal_venc_w.nr_sequencia
          from    dual;
          
          
          insert into nota_fiscal_venc values nota_fiscal_venc_w;
          
        end if;
        ie_atualizou_w  := 'S';
        end;
        
      end if;
      
    else
      delete  nota_fiscal_venc
      where  nr_sequencia = nota_fiscal_venc_w.nr_sequencia;
    end if;

    end;
  end loop;
  close c06;
  */
  
  /*A partir daqui começa o recebimento de caixa para essa NF (Financeiro)*/


  /*Como nao atualiza a nota fiscal, chamar a rotina que gera o titulo da NF*/

  CALL gerar_nota_fiscal_venc(nota_fiscal_w.nr_sequencia, nota_fiscal_w.dt_emissao);
  --gerar_titulo_receber_nfs(nota_fiscal_w.nr_sequencia, nota_fiscal_w.nm_usuario); 

  
	-- Tirado a  gerar_titulo_receber_nfs e  Feito igual foi feito na intpd_recebimento_nota_fiscal	
	if (coalesce(c01_w.ie_action,'INSERT') = 'INSERT') then

		if (c01_w.dt_atualizacao_estoque IS NOT NULL AND c01_w.dt_atualizacao_estoque::text <> '') then
		
			 if (nota_fiscal_w.ie_tipo_nota = 'SF') then
				 CALL atualizar_nota_fiscal(nota_fiscal_w.nr_sequencia,'I','TASY',4,'N');
			 else
				 CALL atualizar_nota_fiscal(nota_fiscal_w.nr_sequencia,'I','TASY',0,'N');
			 end if;
		
		end if;

	end if;

  select  max(a.nr_titulo)
  into STRICT  nr_titulo_w
  from  titulo_receber a
  where  a.nr_seq_nf_saida = nota_fiscal_w.nr_sequencia;
  --ds_campo_w := 'antes do 7  - cd_tipo_pagamento_w: '||cd_tipo_pagamento_w||' - nr_titulo_w: '||nr_titulo_w;

  /*Somente criar recebimento se tiver título e se o tipo de pagamento for em Espécie ou Cartão*/

  if (nr_titulo_w IS NOT NULL AND nr_titulo_w::text <> '') and (cd_tipo_pagamento_w in ('E','C')) then
    ds_campo_w := 'if do cursor 7';
    open C07;
    loop
    fetch C07 into
      c07_w;
    EXIT WHEN NOT FOUND; /* apply on C07 */
      begin
      --ds_campo_w := 'entrou no 7';
      reg_integracao_w.nm_tabela    := 'CAIXA';
      reg_integracao_w.nm_elemento    := 'CHECKOUT';
      reg_integracao_w.nr_seq_visao    := '';
      SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'NR_SEQUENCIA', c07_w.nr_seq_caixa, 'N', nr_seq_caixa_w) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nr_seq_caixa_w := _ora2pg_r.ds_valor_retorno_p;

      reg_integracao_w.nm_tabela    := 'CAIXA_RECEB';
      reg_integracao_w.nm_elemento    := 'CHECKOUT_RECEIPT';
      reg_integracao_w.nr_seq_visao    := '';
      ds_campo_w := 'DT_RECEBIMENTO';
      SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'DT_RECEBIMENTO', c07_w.dt_recebimento, 'N', caixa_receb_w.dt_recebimento) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; caixa_receb_w.dt_recebimento := _ora2pg_r.ds_valor_retorno_p;
      ds_campo_w := 'NR_SEQ_TRANS_FINANC';
      SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'NR_SEQ_TRANS_FINANC', c07_w.nr_seq_trans_financ, 'N', caixa_receb_w.nr_seq_trans_financ) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; caixa_receb_w.nr_seq_trans_financ := _ora2pg_r.ds_valor_retorno_p;
      ds_campo_w := 'VL_TRANSACAO';
      SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'VL_TRANSACAO', c07_w.vl_transacao, 'N', vl_transacao_w) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; vl_transacao_w := _ora2pg_r.ds_valor_retorno_p;
      ds_campo_w := 'CD_PESSOA_FISICA';
      SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'CD_PESSOA_FISICA', c07_w.cd_pessoa_fisica, 'N', caixa_receb_w.cd_pessoa_fisica) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; caixa_receb_w.cd_pessoa_fisica := _ora2pg_r.ds_valor_retorno_p;
      ds_campo_w := 'CD_CGC';
      SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'CD_CGC', c07_w.cd_cgc, 'N', caixa_receb_w.cd_cgc) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; caixa_receb_w.cd_cgc := _ora2pg_r.ds_valor_retorno_p;
      ds_campo_w := 'VL_ESPECIE';
      SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'VL_ESPECIE', c07_w.vl_especie, 'N', caixa_receb_w.vl_especie) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; caixa_receb_w.vl_especie := _ora2pg_r.ds_valor_retorno_p;
      ds_campo_w := 'DS_OBSERVACAO';
      SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'DS_OBSERVACAO', c07_w.ds_observacao, 'N', caixa_receb_w.ds_observacao) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; caixa_receb_w.ds_observacao := _ora2pg_r.ds_valor_retorno_p;
      /*Atributos obrigatórios na tabela que não foram definidos no layout.*/

      caixa_receb_w.dt_atualizacao     := clock_timestamp();
      caixa_receb_w.nm_usuario         := 'TASY_INTEGR';
      --ds_campo_w := 'antes do if antes do insert';    
      if (reg_integracao_w.qt_reg_log = 0) then
      --ds_campo_w := 'if antes do insert';

        --Verificar se existem saldos diferente da data de recebimento em aberto, cfme faz na  intpd_receb_caixa_parksoft (solicitado na OS para se basear nessa proc)    
        select   count(1)
        into STRICT  qt_saldo_aberto_w
        from   caixa_saldo_diario
        where   nr_seq_caixa           = nr_seq_caixa_w
        and    trunc(dt_saldo)  <> trunc(caixa_receb_w.dt_recebimento)
        and    coalesce(dt_fechamento::text, '') = '';

        if (qt_saldo_aberto_w > 0) then
          ds_campo_w := '1 - fechar_caixa_saldo_diario';
          CALL fechar_caixa_saldo_diario( nr_seq_caixa_w,
                         null,
                         trunc(caixa_receb_w.dt_recebimento),
                         caixa_receb_w.nm_usuario);
        end if;

        -- Reabre o saldo caso esteja fechado
        select  coalesce(max(nr_sequencia),0)
        into STRICT  caixa_receb_w.nr_seq_saldo_caixa 
        from   caixa_saldo_diario
        where   trunc(dt_saldo)   = trunc(caixa_receb_w.dt_recebimento)
        and    nr_seq_caixa     = nr_seq_caixa_w
        and   (dt_fechamento IS NOT NULL AND dt_fechamento::text <> '');

        if (caixa_receb_w.nr_seq_saldo_caixa  > 0) then
          ds_campo_w := '1 - fechar_caixa_saldo_diario';
          CALL reabrir_caixa_saldo_diario(  nr_seq_caixa_w,
                        caixa_receb_w.nr_seq_saldo_caixa ,
                        trunc(caixa_receb_w.dt_recebimento),
                        caixa_receb_w.nm_usuario);
        end if;

        -- Abre o saldo caso ainda não exista
        select  coalesce(max(nr_sequencia),0)
        into STRICT  caixa_receb_w.nr_seq_saldo_caixa
        from   caixa_saldo_diario
        where   trunc(dt_saldo)   = trunc(caixa_receb_w.dt_recebimento)
        and    nr_seq_caixa     = nr_seq_caixa_w;

        if (caixa_receb_w.nr_seq_saldo_caixa = 0) then  
          caixa_receb_w.nr_seq_saldo_caixa := abrir_caixa_saldo_diario(  nr_seq_caixa_w, trunc(caixa_receb_w.dt_recebimento), caixa_receb_w.nm_usuario, caixa_receb_w.nr_seq_saldo_caixa);
        end if;
      
      end if;
      --ds_campo_w := 'caixa_receb_w.nr_seq_saldo_caixa :'||nvl(caixa_receb_w.nr_seq_saldo_caixa,0);
	  ds_campo2_w := 'seq_saldo_caixa ' || caixa_receb_w.nr_seq_saldo_caixa;
      if (coalesce(caixa_receb_w.nr_seq_saldo_caixa,0) <> 0) then
        --ds_campo_w := 'entrou no if';
        select  nextval('caixa_receb_seq')
        into STRICT  caixa_receb_w.nr_sequencia
;
		
		ds_campo2_w := caixa_receb_w.nr_sequencia;

        select  count(*) qt_reg
        into STRICT  qt_receb_abertos_w
        from    caixa_saldo_diario b, 
            caixa_receb a
        where   a.nr_seq_saldo_caixa = b.nr_sequencia 
        and     b.nr_seq_caixa = nr_seq_caixa_w
        and     coalesce(a.dt_fechamento::text, '') = ''
        and     coalesce(a.dt_cancelamento::text, '') = '';
        --ds_campo_w := 'qt_receb_abertos_w > 0'||qt_receb_abertos_w;
        if (qt_receb_abertos_w > 0) then
          --Há um recebimento em aberto para este caixa!
          CALL wheb_mensagem_pck.exibir_mensagem_abort(95673);
        end if;
        --ds_campo_w := 'insert into caixa_receb';
        insert into caixa_receb( nr_sequencia,
                     dt_atualizacao,
                     nm_usuario,
                     nr_seq_saldo_caixa,
                     nr_seq_trans_financ,
                     dt_recebimento,
                     vl_especie,
                     ds_observacao,
                     ie_tipo_receb,
                     cd_pessoa_fisica,
                     cd_cgc)
                values ( caixa_receb_w.nr_sequencia,
                     clock_timestamp(),
                     caixa_receb_w.nm_usuario,
                     caixa_receb_w.nr_seq_saldo_caixa,
                     caixa_receb_w.nr_seq_trans_financ,
                     trunc(caixa_receb_w.dt_recebimento),
                     coalesce(caixa_receb_w.vl_especie,0),
                     caixa_receb_w.ds_observacao,
                     'R',
                     caixa_receb_w.cd_pessoa_fisica,
                     caixa_receb_w.cd_cgc);

           
        /*Vincular o título no recebimento de caixa.*/
             
        ds_msg_retorno_w := baixar_titulos_caixa_rec( caixa_receb_w.nr_sequencia, '0', nr_titulo_w, 'TASY_INTEGR', ds_msg_retorno_w, 'N' );

        open C08;
        loop
        fetch C08 into
          c08_w;
        EXIT WHEN NOT FOUND; /* apply on C08 */
          begin

          reg_integracao_w.nm_tabela    :=  'MOVTO_CARTAO_CR';
          reg_integracao_w.nm_elemento  :=  'MOVTO_CARTAO_CR';
          reg_integracao_w.nr_seq_visao  :=  14046;

          SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'IE_TIPO_CARTAO', c08_w.ie_tipo_cartao, 'N', movto_cartao_cr_w.ie_tipo_cartao) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; movto_cartao_cr_w.ie_tipo_cartao := _ora2pg_r.ds_valor_retorno_p;
          SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'NR_CARTAO', c08_w.nr_cartao, 'N', movto_cartao_cr_w.nr_cartao) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; movto_cartao_cr_w.nr_cartao := _ora2pg_r.ds_valor_retorno_p;
          SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'NR_SEQ_BANDEIRA', c08_w.nr_seq_bandeira, 'N', movto_cartao_cr_w.nr_seq_bandeira) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; movto_cartao_cr_w.nr_seq_bandeira := _ora2pg_r.ds_valor_retorno_p;
          SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'NR_AUTORIZACAO', c08_w.nr_autorizacao, 'N', movto_cartao_cr_w.nr_autorizacao) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; movto_cartao_cr_w.nr_autorizacao := _ora2pg_r.ds_valor_retorno_p;
          SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'NR_SEQ_FORMA_PAGTO', c08_w.nr_seq_forma_pagto, 'N', movto_cartao_cr_w.nr_seq_forma_pagto) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; movto_cartao_cr_w.nr_seq_forma_pagto := _ora2pg_r.ds_valor_retorno_p;
          SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'VL_CARTAO', c08_w.vl_cartao, 'N', movto_cartao_cr_w.vl_transacao) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; movto_cartao_cr_w.vl_transacao := _ora2pg_r.ds_valor_retorno_p;
          SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'QT_PARCELA', c08_w.qt_parcela, 'N', movto_cartao_cr_w.qt_parcela) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; movto_cartao_cr_w.qt_parcela := _ora2pg_r.ds_valor_retorno_p;
          SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'DS_COMPROVANTE', c08_w.ds_comprovante, 'N', movto_cartao_cr_w.ds_comprovante) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; movto_cartao_cr_w.ds_comprovante := _ora2pg_r.ds_valor_retorno_p;
          SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'NR_SEQ_TRANS_CAIXA', c08_w.nr_seq_trans_caixa, 'N', movto_cartao_cr_w.nr_seq_trans_caixa) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; movto_cartao_cr_w.nr_seq_trans_caixa := _ora2pg_r.ds_valor_retorno_p;
          SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'CD_PESSOA_FISICA', c08_w.cd_pessoa_fisica, 'N', movto_cartao_cr_w.cd_pessoa_fisica) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; movto_cartao_cr_w.cd_pessoa_fisica := _ora2pg_r.ds_valor_retorno_p;
          SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'CD_CGC', c08_w.cd_cgc, 'N', movto_cartao_cr_w.cd_cgc) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; movto_cartao_cr_w.cd_cgc := _ora2pg_r.ds_valor_retorno_p;
          SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'DS_OBSERVACAO', c08_w.ds_observacao, 'N', movto_cartao_cr_w.ds_observacao) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; movto_cartao_cr_w.ds_observacao := _ora2pg_r.ds_valor_retorno_p;
          
          if (reg_integracao_w.qt_reg_log = 0) then
        
            movto_cartao_cr_w.cd_estabelecimento := nota_fiscal_w.cd_estabelecimento;
            movto_cartao_cr_w.dt_atualizacao   := clock_timestamp();
            movto_cartao_cr_w.dt_transacao     := caixa_receb_w.dt_recebimento;
            movto_cartao_cr_w.ie_lib_caixa     := 'N';
            movto_cartao_cr_w.ie_situacao     := 'A';
            movto_cartao_cr_w.nm_usuario     := 'TASY_INTEGR';

            select  nextval('movto_cartao_cr_seq')
            into STRICT  movto_cartao_cr_w.nr_sequencia
;

            --movto_cartao_cr_w.nr_sequencia     := movto_cartao_cr_seq.nextval;
            movto_cartao_cr_w.nr_seq_caixa_rec   := caixa_receb_w.nr_sequencia;

            insert into  movto_cartao_cr values (movto_cartao_cr_w.*);
            ds_campo_w := '1 - gerar_cartao_cr_parcela';
            CALL gerar_cartao_cr_parcela( movto_cartao_cr_w.nr_sequencia,
                          movto_cartao_cr_w.nm_usuario,
                          null,
						  'N');

          end if;

          end;
        end loop;
        close C08;

      end if;
      
      end;
    end loop;
    close C07;
    --ds_campo_w := caixa_receb_w.nr_sequencia||' - '||vl_troco_w||' - '||vl_troco_w||' - '||caixa_receb_w.dt_recebimento;

    /*Fechar recebimento*/

    vl_troco_w := 0;
    ds_campo_w := '99 - fechar_caixa_receb';
    vl_troco_w := fechar_caixa_receb( caixa_receb_w.nr_sequencia, 'N', 'TASY_INTEGR', vl_troco_w, caixa_receb_w.dt_recebimento, 'N');			

    if (vl_troco_w < 0) then
      ds_campo_w := '98 - fechar_caixa_receb';
	  CALL wheb_mensagem_pck.exibir_mensagem_abort(1013677);
	  --Não é permitido recebimentos que possuam troco!');

      /*fechar_caixa_receb( caixa_receb_w.nr_sequencia,
                'S',
                'TASY_INTEGR',
                vl_troco_w,
                caixa_receb_w.dt_recebimento);*/
    end if;

  end if;

  end;
end loop;
close c01;
exception
when others then
  begin
  ds_erro_w  :=  substr(sqlerrm,1,4000);
  rollback;
  update  intpd_fila_transmissao
  set  ie_status = 'E',
    ds_log = ds_erro_w ||' ds_campo: '|| ds_campo_w ||' - ds_campo2_w: '||ds_campo2_w ||' log : '||reg_integracao_w.qt_reg_log
  where  nr_sequencia = nr_sequencia_p;
  end;
end;

if (reg_integracao_w.qt_reg_log > 0) then
  begin
  rollback;

  update  intpd_fila_transmissao
  set  ie_status = 'E',
    ds_log = ds_erro_w ||' ds_campo: '|| ds_campo_w||' - ds_campo2_w: '||ds_campo2_w||' log : '||reg_integracao_w.qt_reg_log
  where  nr_sequencia = nr_sequencia_p;

  for i in 0..reg_integracao_w.qt_reg_log-1 loop
    intpd_gravar_log_recebimento(nr_sequencia_p,reg_integracao_w.intpd_log_receb[i].ds_log,'INTPDTASY');
  end loop;
  end;
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE intpd_recebimento_cupom_fiscal ( nr_sequencia_p bigint, xml_p xml) FROM PUBLIC;

