-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE aplicar_ajuste_versao_cliente (cd_versao_p text, nr_release_p bigint, nm_usuario_p text, ds_retorno_p INOUT text, nr_pacote_p bigint, ie_tipo_script_p text) AS $body$
DECLARE


ds_erro_w		varchar(2000):='';
nr_seq_ajuste_versao_w	numeric(38);
nr_release_w		bigint;
qt_objetos_ini_w		bigint;
qt_pendentes_w		bigint;
qt_objetos_w		bigint;
qt_erros_w		bigint:=0;
nm_objeto_w     varchar(50);
ds_processo_w	varchar(400);

qt_inicial_w	bigint:=0;
pr_concluido_w	double precision:=0;


dt_ini_compile timestamp;
dt_fin_compile timestamp;
nm_user_compile timestamp;

c01 CURSOR FOR
	SELECT	distinct nr_release,
			nm_objeto
	from	ajuste_versao_cliente
	where	cd_versao = cd_versao_p
	and		((ie_tipo_script_p = 'N' AND nr_pacote <= nr_pacote_p) or (nr_pacote = nr_pacote_p))
	and (ie_tipo_script <> 'E')
	and	ie_compila = 'N'
	order by nr_release;


BEGIN

-- inicio da contagem dos objetos invalidos
select	count(*)
into STRICT	qt_objetos_ini_w
from	inv_v;

-- busca qt_inicial_w
select	count(*)
into STRICT	qt_inicial_w
from	ajuste_versao_cliente
where	cd_versao 		= cd_versao_p
and		nr_pacote		<= nr_pacote_p
and		ie_tipo_script	<>  'E'
and		ie_compila 		= 'N';

ds_processo_w := '0%';
CALL gravar_processo_longo(ds_processo_w, 'APLICAR_AJUSTE_VERSAO_CLIENTE', 0);	


open c01;
loop
fetch c01 into
	nr_release_w,	
    nm_objeto_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
		begin

		-- busca qt faltante
		select	count(*)
		into STRICT	qt_pendentes_w
		from	ajuste_versao_cliente
		where	cd_versao 		= cd_versao_p
		and		nr_pacote		<= nr_pacote_p
		and		ie_tipo_script	<>  'E'
		and		ie_compila 		= 'N';	
		
		pr_concluido_w := (((qt_inicial_w - qt_pendentes_w) * 100) / qt_inicial_w);

		ds_processo_w := replace(formata_casas_decimais(pr_concluido_w, 2), '.', ',') || '%';
		
		
		CALL gravar_processo_longo(ds_processo_w, 'APLICAR_AJUSTE_VERSAO_CLIENTE', pr_concluido_w);		
			
		-- variavel de log caso ocorra problemas
		nr_seq_ajuste_versao_w:= somente_numero(cd_versao_p||nr_release_w);

        if (length(nm_objeto_w) > 0) then
          CALL bkp_objeto_ajuste_versao(cd_versao_p, nr_release_w, nm_objeto_w, nm_usuario_p);
        end if;
		dt_ini_compile := clock_timestamp();
		-- compila os objetos
		CALL compile_ajuste_versao(nm_usuario_p, nr_seq_ajuste_versao_w, 'C', cd_versao_p, nr_release_w);
		dt_fin_compile := clock_timestamp();

		-- a principio valida o codigo nao caiu do exception
		update	ajuste_versao_cliente
		set	ie_compila = 'S',
			dt_ini_aplicacao = dt_ini_compile,
			dt_fim_aplicacao = dt_fin_compile,
			nm_usuario_aplicacao = nm_usuario_p
		where	cd_versao = cd_versao_p
		and	nr_release = nr_release_w;
		commit;

		-- caiu no expception erro no codigo
		exception
		when others then
            CALL recompile_objeto_release(cd_versao_p, nr_release_w,nm_usuario_p);
		end;
		
		-- contagem inicial assume o novo valor
		qt_objetos_ini_w:= qt_objetos_w;
		
		
end loop;
close c01;


ds_processo_w := '100.00%';
CALL gravar_processo_longo(ds_processo_w, 'APLICAR_AJUSTE_VERSAO_CLIENTE', 100);
CALL valida_objetos_sistema();

select	count(*)
into STRICT	qt_objetos_w
from	inv_v;

if (qt_objetos_w > qt_objetos_ini_w) then
	ds_erro_w:= obter_desc_expressao(778078);
    CALL recompile_objeto_release(cd_versao_p, nr_release_w,nm_usuario_p);
end if;

ds_retorno_p:= ds_erro_w;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE aplicar_ajuste_versao_cliente (cd_versao_p text, nr_release_p bigint, nm_usuario_p text, ds_retorno_p INOUT text, nr_pacote_p bigint, ie_tipo_script_p text) FROM PUBLIC;

