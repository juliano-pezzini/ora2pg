-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE cpoe_importar_lab_exam_proc (nm_usuario_p exame_laboratorio.nm_usuario%type) AS $body$
DECLARE


nr_sequencia_w				proc_interno.nr_sequencia%type;
nr_seq_exame_w				exame_laboratorio.nr_seq_exame%type;
nm_exame_w					exame_laboratorio.nm_exame%type;
cd_procedimento_w			exame_laboratorio.cd_procedimento%type;
cd_procedimento_tuss_w		exame_laboratorio.cd_procedimento_tuss%type;
ie_solicitacao_w			exame_laboratorio.ie_solicitacao%type;
ie_origem_proced_tuss_w		exame_laboratorio.ie_origem_proc_tuss%type;

ie_origem_proced_w			exame_lab_convenio.ie_origem_proced%type;
cd_convenio_w				exame_lab_convenio.cd_convenio%type;
cd_edicao_amb_w				exame_lab_convenio.cd_edicao_amb%type;
dt_inicio_vigencia_w		exame_lab_convenio.dt_inicio_vigencia%type;
dt_fim_vigencia_w			exame_lab_convenio.dt_fim_vigencia%type;
cd_categoria_w				exame_lab_convenio.cd_categoria%type;
ie_tipo_atendimento_w		exame_lab_convenio.ie_tipo_atendimento%type;
ie_origem_proc_filtro_w		exame_lab_convenio.ie_origem_proc_filtro%type;

cd_setor_atendimento_w		procedimento.cd_setor_exclusivo%type;

C01 CURSOR FOR
	SELECT 	a.nr_seq_exame,
			a.nm_exame,
			a.cd_procedimento,
			a.cd_procedimento_tuss,
			a.ie_solicitacao,
			coalesce(ie_origem_proced, 1),
			ie_origem_proc_tuss
	from   	exame_laboratorio a
	where  	not exists (SELECT 1 from proc_interno b where a.nr_seq_exame = b.nr_seq_exame_lab)
	and		(a.cd_procedimento IS NOT NULL AND a.cd_procedimento::text <> '')
	and    	a.ie_situacao = 'A'
	and		a.ie_solicitacao = 'S'
	AND  	exists (select 1 from procedimento b where ((coalesce(a.cd_procedimento_tuss::text, '') = '')  or (a.cd_procedimento_tuss = b.cd_procedimento and a.ie_origem_proc_tuss = b.ie_origem_proced)));

C02 CURSOR FOR
	SELECT 	cd_procedimento,
			ie_origem_proced,
			cd_convenio,
			cd_edicao_amb,
			dt_inicio_vigencia,
			dt_fim_vigencia,
			cd_categoria,
			ie_tipo_atendimento,
			ie_origem_proc_filtro
	from   	exame_lab_convenio
	where  	nr_seq_exame = nr_seq_exame_w
	and		ie_situacao = 'A';


BEGIN

open C01;
loop
fetch C01 into
	nr_seq_exame_w,
	nm_exame_w,
	cd_procedimento_w,
	cd_procedimento_tuss_w,
	ie_solicitacao_w,
	ie_origem_proced_w,
	ie_origem_proced_tuss_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	select  nextval('proc_interno_seq')
	into STRICT	nr_sequencia_w
	;

	begin

		insert into proc_interno(
			nr_sequencia,
			dt_atualizacao,
			dt_atualizacao_nrec,
			nm_usuario,
			nm_usuario_nrec,
			ds_proc_exame,
			ds_laudo,
			cd_procedimento,
			ie_origem_proced,
			ie_orientacao,
			ie_tipo,
			ie_situacao,
			ie_exige_lado,
			ie_tipo_util,
			ie_localizador,
			nr_seq_exame_lab,
			cd_procedimento_tuss,
			ie_origem_proc_tuss,
			ie_copiar_rep)
		values (
			nr_sequencia_w,
			clock_timestamp(),
			clock_timestamp(),
			nm_usuario_p,
			nm_usuario_p,
			nm_exame_w,
			nm_exame_w,
			cd_procedimento_w,
			ie_origem_proced_w,
			'I',
			'O',
			'A',
			'N',
			'O',
			coalesce(ie_solicitacao_w, 'N'),
			nr_seq_exame_w,
			cd_procedimento_tuss_w,
			ie_origem_proced_tuss_w,
			'C');

		commit;

	exception when others then
		CALL gravar_log_tasy(10077, ' Migrando exame laborat√≥rial: '||nr_seq_exame_w|| ' com procedimento: '|| cd_procedimento_w ||' erro cpoe_importar_lab_exam_proc:'|| to_char(sqlerrm) ,nm_usuario_p);
	end;

	select 	max(b.cd_setor_exclusivo)
	into STRICT	cd_setor_atendimento_w
	from	procedimento b,
			setor_atendimento a
	where	b.cd_procedimento	= cd_procedimento_w
	and		b.ie_origem_proced	= ie_origem_proced_w
	and		b.cd_setor_exclusivo	= a.cd_setor_atendimento;

	if (cd_setor_atendimento_w IS NOT NULL AND cd_setor_atendimento_w::text <> '') then
		insert into proc_interno_setor(
			nr_sequencia,
			nr_seq_proc_interno,
			dt_atualizacao,
			nm_usuario,
			cd_setor_atendimento,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			nr_prioridade,
			ie_banco_sangue_rep,
			cd_setor_origem,
			cd_estabelecimento,
			ie_tipo_atendimento,
			cd_perfil,
			ie_tipo_convenio,
			nr_seq_agrupamento,
			ie_somente_principal,
			cd_especialidade
		) values (
			nextval('proc_interno_setor_seq'),
			nr_sequencia_w,
			clock_timestamp(),
			nm_usuario_p,
			cd_setor_atendimento_w,
			clock_timestamp(),
			nm_usuario_p,
			1,
			'N',
			null,
			null,
			null,
			null,
			null,
			null,
			null,
			null
		);
		commit;
	end if;

	open C02;
	loop
	fetch C02 into
		cd_procedimento_w,
		ie_origem_proced_w,
		cd_convenio_w,
		cd_edicao_amb_w,
		dt_inicio_vigencia_w,
		dt_fim_vigencia_w,
		cd_categoria_w,
		ie_tipo_atendimento_w,
		ie_origem_proc_filtro_w;
	EXIT WHEN NOT FOUND; /* apply on C02 */
		begin
		insert into proc_interno_conv(
			nr_sequencia,
			nr_seq_proc_interno,
			dt_atualizacao_nrec,
			dt_atualizacao,
			nm_usuario,
			nm_usuario_nrec,
			cd_procedimento,
			ie_origem_proced,
			ie_situacao,
			cd_edicao_amb,
			ie_tipo_atendimento,
			cd_convenio,
			cd_categoria,
			ie_origem_proc_filtro,
			dt_inicio_vigencia,
			dt_final_vigencia
			)
		values (
			nextval('proc_interno_conv_seq'),
			nr_sequencia_w,
			clock_timestamp(),
			clock_timestamp(),
			nm_usuario_p,
			nm_usuario_p,
			cd_procedimento_w,
			ie_origem_proced_w,
			'A',
			cd_edicao_amb_w,
			ie_tipo_atendimento_w,
			cd_convenio_w,
			cd_categoria_w,
			ie_origem_proc_filtro_w,
			dt_inicio_vigencia_w,
			dt_fim_vigencia_w
			);

			commit;
		end;
	end loop;
	close C02;

	end;
end loop;
close C01;

CALL cpoe_atualizar_cadastro_exame(nm_usuario_p);
CALL cpoe_atualizar_exame_protocolo(nm_usuario_p);

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cpoe_importar_lab_exam_proc (nm_usuario_p exame_laboratorio.nm_usuario%type) FROM PUBLIC;

