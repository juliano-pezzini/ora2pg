-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';



CREATE TYPE campos AS (ds_dias_aplicacao	varchar(255));


CREATE OR REPLACE PROCEDURE alterar_medic_trat_onc ( nr_seq_paciente_p bigint, nr_seq_interno_p bigint, ie_operacao_p bigint, nm_usuario_p text) AS $body$
DECLARE


ds_dias_aplicacao_w	varchar(4000);
ds_texto_w		varchar(255);
k			integer;
x			varchar(1);
y 			integer;
z 			integer;
cont_w			bigint;
nr_seq_mat_dil_w  bigint;
posicao_w		smallint;
type vetor is table of campos index by integer;
dias_w			vetor;
qt_count_w		bigint;
dia_w			varchar(255);
nr_seq_atendimento_w	bigint;
nr_seq_material_w	bigint;
nr_seq_interno_w	bigint;
ds_valido_dias_w 	varchar(13)	:= '0123456789D,-';
r			integer := 1;
nr_seq_material_ww	bigint;
ie_gerar_ciclos_w	varchar(10);
cd_material_ww			material.cd_material%type;
cd_unidade_medida_ww	paciente_protocolo_medic.cd_unidade_medida%type;
qt_dose_ww				paciente_protocolo_medic.qt_dose%type;
ie_via_aplicacao_ww		paciente_protocolo_medic.ie_via_aplicacao%type;
ds_recomendacao_ww		paciente_protocolo_medic.ds_recomendacao%type;
ds_observacao_ww		paciente_protocolo_medic.ds_observacao%type;
nr_agrupamento_ww		paciente_protocolo_medic.nr_agrupamento%type;
ds_dias_aplicacao_ww	paciente_protocolo_medic.ds_dias_aplicacao%type;
qt_min_aplicacao_ww		paciente_protocolo_medic.qt_min_aplicacao%type;
ie_bomba_infusao_ww		paciente_protocolo_medic.ie_bomba_infusao%type;
cd_intervalo_ww			paciente_protocolo_medic.cd_intervalo%type;
qt_hora_aplicacao_ww	paciente_protocolo_medic.qt_hora_aplicacao%type;
qt_dias_util_ww			paciente_protocolo_medic.qt_dias_util%type;
nr_seq_interno_ww		paciente_protocolo_medic.nr_seq_interno%type;
ie_se_necessario_ww		paciente_protocolo_medic.ie_se_necessario%type;
ie_aplic_lenta_ww		paciente_protocolo_medic.ie_aplic_lenta%type;
ie_urgencia_ww			paciente_protocolo_medic.ie_urgencia%type;
ie_aplic_bolus_ww		paciente_protocolo_medic.ie_aplic_bolus%type;
nr_seq_int_prot_medic_w	paciente_protocolo_medic.nr_seq_interno%type;
ie_agrupador_w			paciente_protocolo_medic.ie_agrupador%type;
ie_aplica_reducao_ww	paciente_protocolo_medic.ie_aplica_reducao%type;
ie_local_adm_w			paciente_protocolo_medic.ie_local_adm%type;
ie_material_diluiacao_w	varchar(3);
nr_seq_mat_diluicao_w	paciente_protocolo_medic.nr_seq_mat_diluicao%type;
ie_acm_w				paciente_protocolo_medic.ie_acm%type;
cd_unid_med_prescr_dil_w	paciente_protocolo_medic.cd_unid_med_prescr%type;
qt_dose_prescr_dil_w	paciente_protocolo_medic.qt_dose_prescr%type;
qt_dias_receita_w		paciente_protocolo_medic.qt_dias_receita%type;
nr_seq_diluicao_www		bigint;
nr_seq_medic_material_www	bigint;
cd_grupo_material_w	bigint;
cd_subgrupo_material_w	bigint;
cd_classe_material_w	bigint;
ie_exige_liberacao_w	varchar(1);
ie_generico_w		varchar(1);

c01 CURSOR FOR
SELECT	*
from	paciente_protocolo_medic
where	nr_seq_paciente		= nr_seq_paciente_p
and	nr_seq_interno		= nr_seq_interno_p;

c01_w	c01%rowtype;

C02 CURSOR FOR
SELECT	*
from	paciente_protocolo_medic
where	nr_seq_paciente = nr_seq_paciente_p
and	nr_seq_diluicao = nr_seq_material_ww;

C03 CURSOR FOR
SELECT	nr_seq_atendimento
from	paciente_atendimento
where	nr_seq_paciente = nr_seq_paciente_p
and		ds_dia_ciclo = dia_w
and		coalesce(nr_prescricao::text, '') = ''
and		coalesce(dt_cancelamento::text, '') = ''
and (coalesce(ie_gerar_ciclos_w,'N') = 'S')
and		((coalesce(c01_w.ds_ciclos_aplicacao::text, '') = '') or (instr((c01_w.ds_ciclos_aplicacao||','),('C'||nr_ciclo||',')) > 0))
and		Obter_Se_Dia_Ciclo_Autorizado(nr_seq_atendimento,nr_ciclo) = 'N'

union

SELECT	nr_seq_atendimento
from	paciente_atendimento
where	nr_seq_paciente = nr_seq_paciente_p
and		ds_dia_ciclo = dia_w
and		coalesce(nr_prescricao::text, '') = ''
and		coalesce(dt_cancelamento::text, '') = ''
and (coalesce(ie_gerar_ciclos_w,'N') = 'N')
and		Obter_Se_Dia_Ciclo_Autorizado(nr_seq_atendimento,nr_ciclo) = 'N';

c04 CURSOR FOR
SELECT	CASE WHEN ie_generico_w='S' THEN coalesce(b.cd_material_generico,a.cd_material)  ELSE a.cd_material END ,
	a.cd_unidade_medida,
	a.qt_dose,
	a.ie_via_aplicacao,
	a.ds_recomendacao,
	a.ds_observacao,
	a.nr_agrupamento,
	a.ds_dias_aplicacao,
	a.qt_min_aplicacao,
	a.ie_bomba_infusao,
	a.cd_intervalo,
	a.qt_hora_aplicacao,
	a.qt_dias_util,
	a.nr_seq_interno,
	a.ie_se_necessario,
	a.ie_aplic_lenta,
	a.ie_urgencia,
	a.ie_aplic_bolus,
	a.nr_seq_interno,
	a.ie_agrupador,
	coalesce(a.ie_aplica_reducao,'S'),
	coalesce(ie_local_adm,'H'),
	'D',
	nr_seq_mat_diluicao,
	a.ie_acm,
	a.cd_unid_med_prescr,
	a.qt_dose_prescr,
	a.qt_dias_receita
from	material b,
	paciente_protocolo_medic a
where	a.cd_material		= b.cd_material
and	a.nr_seq_paciente = nr_seq_paciente_p
and	a.nr_seq_diluicao = c01_w.nr_seq_material

union all

SELECT	CASE WHEN ie_generico_w='S' THEN coalesce(b.cd_material_generico,a.cd_material)  ELSE a.cd_material END ,
	a.cd_unidade_medida,
	a.qt_dose,
	a.ie_via_aplicacao,
	a.ds_recomendacao,
	a.ds_observacao,
	a.nr_agrupamento,
	a.ds_dias_aplicacao,
	a.qt_min_aplicacao,
	a.ie_bomba_infusao,
	a.cd_intervalo,
	a.qt_hora_aplicacao,
	a.qt_dias_util,
	a.nr_seq_interno,
	a.ie_se_necessario,
	a.ie_aplic_lenta,
	a.ie_urgencia,
	a.ie_aplic_bolus,
	a.nr_seq_interno,
	a.ie_agrupador,
	coalesce(a.ie_aplica_reducao,'S'),
	coalesce(ie_local_adm,'H'),
	'M',
	null,
	a.ie_acm,
	a.cd_unid_med_prescr,
	a.qt_dose_prescr,
	a.qt_dias_receita
from	material b,
	paciente_protocolo_medic a
where	a.cd_material		= b.cd_material
and	a.nr_seq_paciente = nr_seq_paciente_p
and	a.nr_seq_medic_material = c01_w.nr_seq_material;


BEGIN

ie_gerar_ciclos_w := obter_param_usuario(6542, 3, obter_perfil_ativo, nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento, ie_gerar_ciclos_w);
ie_generico_w := obter_param_usuario(281, 136, obter_perfil_ativo, nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento, ie_generico_w);

open C01;
loop
fetch C01 into
	c01_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	ds_dias_aplicacao_w	:= c01_w.ds_dias_aplicacao;
	ds_dias_aplicacao_w	:= replace(ds_dias_aplicacao_w,' ','');
	ds_texto_w		:= '';
	for y in 1..length(ds_dias_aplicacao_w) loop
		x	:= substr(upper(ds_dias_aplicacao_w), y, 1);
		if (position(x in ds_valido_dias_w) > 0) then
			ds_texto_w	:= ds_texto_w || x;
		else
			CALL wheb_mensagem_pck.exibir_mensagem_abort(238996);
			--(-20011,'Erro na padronizacao dos horarios do mat/med ');
		end if;
	end loop;
	ds_dias_aplicacao_w	:= ds_texto_w;
	z	:= 0;
	ds_dias_aplicacao_w	:= ds_dias_aplicacao_w ||',';
	cont_w	:= 0;
	dias_w.delete;
	while	(ds_dias_aplicacao_w IS NOT NULL AND ds_dias_aplicacao_w::text <> '') loop
		begin
		posicao_w	:= position(',' in ds_dias_aplicacao_w);
		z := z + 1;
		dias_w[z].ds_dias_aplicacao	:= substr(ds_dias_aplicacao_w,1,posicao_w - 1);
		ds_dias_aplicacao_w		:= substr(ds_dias_aplicacao_w,posicao_w + 1,length(ds_dias_aplicacao_w));
		if (position('D' in dias_w[z].ds_dias_aplicacao)	= 0) then
			CALL wheb_mensagem_pck.exibir_mensagem_abort(238996);
			--(-20011,'Erro na padronizacao dos horarios do mat/med ');
		end if;

		cont_w	:= cont_w + 1;
		if (cont_w > 100) then
			exit;
		end if;
		end;
	end loop;

	qt_count_w	:= dias_w.count;
	k := 1;
	r := 1;
	while(k <= qt_count_w) loop
	dia_w	:= dias_w[k].ds_dias_aplicacao;

		/*select	max(nr_seq_atendimento)
		into	nr_seq_atendimento_w
		from	paciente_atendimento
		where	nr_seq_paciente = nr_seq_paciente_p
		and	ds_dia_ciclo = dia_w;*/
		open C03;
		loop
		fetch C03 into
			nr_seq_atendimento_w;
		EXIT WHEN NOT FOUND; /* apply on C03 */
			begin

			--if 	(nr_seq_atendimento_w > 0) then

			--begin
			select	coalesce(max(nr_seq_material),0) + 1
			into STRICT	nr_seq_material_w
			From	Paciente_Atend_Medic
			Where	nr_seq_atendimento = nr_seq_atendimento_w;

			select	nextval('paciente_atend_medic_seq')
			into STRICT	nr_seq_interno_w
			;

			if (ie_operacao_p	= 3) then
				delete
				from	paciente_atend_medic
				where	nr_seq_atendimento = nr_seq_atendimento_w
				and	cd_material = c01_w.cd_material
				and	nr_agrupamento = c01_w.nr_agrupamento;

				commit;
			end if;

			if (ie_operacao_p	= 1) then

				insert into paciente_atend_medic( nr_seq_atendimento,
								nr_seq_material,
								cd_material,
								dt_atualizacao,
								nm_usuario,
								nr_agrupamento,
								qt_dose,
								qt_dose_prescricao,
								cd_unid_med_dose,
								cd_unid_med_prescr,
								ds_recomendacao,
								ds_observacao,
								ie_via_aplicacao,
								qt_min_aplicacao,
								ie_bomba_infusao,
								cd_intervalo,
								qt_hora_aplicacao,
								qt_dias_util,
								nr_seq_interno,
								nr_seq_prot_medic,
								ie_cancelada,
								ie_administracao,
								ie_checado,
								ie_se_necessario,
								ie_urgencia,
								ie_aplic_bolus,
								ie_aplic_lenta,
								nr_seq_int_prot_medic,
								ie_local_adm)
							values ( nr_seq_atendimento_w,
								nr_seq_material_w,
								c01_w.cd_material,
								clock_timestamp(),
								nm_usuario_p,
								c01_w.nr_agrupamento,
								c01_w.qt_dose,
								c01_w.qt_dose_prescr,
								c01_w.cd_unidade_medida,
								c01_w.cd_unid_med_prescr,
								c01_w.ds_recomendacao,
								c01_w.ds_observacao,
								c01_w.ie_via_aplicacao,
								c01_w.qt_min_aplicacao,
								c01_w.ie_bomba_infusao,
								c01_w.cd_intervalo,
								c01_w.qt_hora_aplicacao,
								c01_w.qt_dias_util,
								nr_seq_interno_w,
								c01_w.nr_seq_prot_med,
								'N',
								'P',
								'N',
								c01_w.ie_se_necessario,
								c01_w.ie_urgencia,
								c01_w.ie_aplic_bolus,
								c01_w.ie_aplic_lenta,
								nr_seq_interno_p,
								c01_w.ie_local_adm);

				-- insert dos diluentes
				open c04;
				loop
				fetch c04 into
					cd_material_ww,
					cd_unidade_medida_ww,
					qt_dose_ww,
					ie_via_aplicacao_ww,
					ds_recomendacao_ww,
					ds_observacao_ww,
					nr_agrupamento_ww,
					ds_dias_aplicacao_ww,
					qt_min_aplicacao_ww,
					ie_bomba_infusao_ww,
					cd_intervalo_ww,
					qt_hora_aplicacao_ww,
					qt_dias_util_ww,
					nr_seq_interno_ww,
					ie_se_necessario_ww,
					ie_aplic_lenta_ww,
					ie_urgencia_ww,
					ie_aplic_bolus_ww,
					nr_seq_int_prot_medic_w,
					ie_agrupador_w,
					ie_aplica_reducao_ww,
					ie_local_adm_w,
					ie_material_diluiacao_w,
					nr_seq_mat_diluicao_w,
					ie_acm_w,
					cd_unid_med_prescr_dil_w,
					qt_dose_prescr_dil_w,
					qt_dias_receita_w;
				EXIT WHEN NOT FOUND; /* apply on c04 */
					begin

					nr_seq_diluicao_www	:= null;
					nr_seq_medic_material_www	:= null;
					if (ie_material_diluiacao_w	= 'M') then
						nr_seq_medic_material_www	:= nr_seq_material_w;
					else
						nr_seq_diluicao_www			:= nr_seq_material_w;
					end if;

					select	nextval('paciente_atend_medic_seq')
					into STRICT	nr_seq_interno_w
					;

          select	coalesce(max(nr_seq_material),0) + 1 
					into STRICT	nr_seq_mat_dil_w
					from	paciente_atend_medic 
					where	nr_seq_atendimento = nr_seq_atendimento_w;	

					insert into paciente_atend_medic(
						nr_seq_atendimento,
						nr_seq_material,
						cd_material,
						dt_atualizacao,
						nm_usuario,
						nr_agrupamento,
						qt_dose,
						cd_unid_med_dose,
						ds_recomendacao,
						ds_observacao,
						ie_via_aplicacao,
						nr_seq_diluicao,
						qt_min_aplicacao,
						ie_bomba_infusao,
						cd_intervalo,
						qt_hora_aplicacao,
						qt_dias_util,
						nr_seq_interno,
						nr_seq_prot_medic,
						ie_cancelada,
						ie_administracao,
						ie_checado,
						ie_se_necessario,
						ie_urgencia,
						ie_aplic_bolus,
						ie_aplic_lenta,
						nr_seq_int_prot_medic,
						ie_agrupador,
						ie_aplica_reducao,
						ie_local_adm,
						nr_seq_medic_material,
						nr_seq_mat_diluicao,
						ie_acm,
						cd_unid_med_prescr,
						qt_dose_prescricao,
						qt_dias_receita)
					values (	nr_seq_atendimento_w,
						nr_seq_mat_dil_w,
						cd_material_ww,
						clock_timestamp(),
						nm_usuario_p,
						nr_agrupamento_ww,
						qt_dose_ww,
						cd_unidade_medida_ww,
						ds_recomendacao_ww,
						ds_observacao_ww,
						ie_via_aplicacao_ww,
						nr_seq_diluicao_www,
						qt_min_aplicacao_ww,
						ie_bomba_infusao_ww,
						cd_intervalo_ww,
						qt_hora_aplicacao_ww,
						qt_dias_util_ww,
						nr_seq_interno_w,
						nr_seq_interno_ww,
						'N',
						'P',
						'N',
						ie_se_necessario_ww,
						ie_urgencia_ww,
						ie_aplic_bolus_ww,
						ie_aplic_lenta_ww,
						nr_seq_int_prot_medic_w,
						ie_agrupador_w,
						ie_aplica_reducao_ww,
						ie_local_adm_w,
						nr_seq_medic_material_www,
						nr_seq_mat_diluicao_w,
						ie_acm_w,
						cd_unid_med_prescr_dil_w,
						qt_dose_prescr_dil_w,
						qt_dias_receita_w);

					begin
					select	cd_grupo_material,
							cd_subgrupo_material,
							cd_classe_material
					into STRICT	cd_grupo_material_w,
							cd_subgrupo_material_w,
							cd_classe_material_w
					from	estrutura_material_v
					where	cd_material	= c01_w.cd_material;
					exception
						when others then
						cd_grupo_material_w	:= 0;
						cd_subgrupo_material_w	:= 0;
						cd_classe_material_w	:= 0;
					end;

					select	coalesce(max('S'),'N')
					into STRICT	ie_exige_liberacao_w
					from	quimio_drogas_liberacao
					where	coalesce(cd_material,c01_w.cd_material)				= c01_w.cd_material
					and	coalesce(cd_grupo_material,cd_grupo_material_w)		= cd_grupo_material_w
					and	coalesce(cd_subgrupo_material,cd_subgrupo_material_w)= cd_subgrupo_material_w
					and	coalesce(cd_classe_material,cd_classe_material_w)	= cd_classe_material_w
					and cd_estabelecimento = wheb_usuario_pck.get_cd_estabelecimento;

					update	paciente_atendimento
					set		ie_exige_liberacao	= ie_exige_liberacao_w
					where	nr_seq_atendimento	= nr_seq_atendimento_w
					and		ie_exige_liberacao	= 'N';

					end;
				end loop;
				close c04;

			end if;

			end;
		end loop;
		close C03;
	k := k + 1;
	end loop;
	end;
end loop;
close C01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE alterar_medic_trat_onc ( nr_seq_paciente_p bigint, nr_seq_interno_p bigint, ie_operacao_p bigint, nm_usuario_p text) FROM PUBLIC;

