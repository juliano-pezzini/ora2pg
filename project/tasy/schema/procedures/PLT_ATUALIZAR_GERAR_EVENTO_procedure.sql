-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE plt_atualizar_gerar_evento ( ie_tipo_item_p text, nr_prescricao_p bigint, nr_sequencia_p bigint, cd_item_p text, ie_acao_p text, ds_observacao_p text, nr_seq_alter_p INOUT bigint, nm_usuario_p text) AS $body$
DECLARE

/*					
ie_acao_p	
IS - Incluir Substituicao
SS - Suspender Substituicao
IM - Incluir Modificacao
SM - Suspender Modificacao
AI - Acrescimo de item
*/
ie_tipo_item_w			varchar(15);
ie_alteracao_w			integer;
ie_ds_w					varchar(1);
nr_seq_horario_w		bigint;
cd_estabelecimento_w	integer;
nr_seq_alter_w			bigint;
nr_atendimento_w		bigint;
nr_seq_prescricao_w		bigint;
nr_seq_procedimento_w	bigint;
nr_seq_recomendacao_w	bigint;
nr_seq_item_sae_w		bigint;
nr_seq_solucao_w		bigint;
nr_seq_nut_neo_w		bigint;
dt_horario_w			timestamp;
ie_tipo_solucao_w		smallint;
nr_seq_proc_interno_w	bigint;
cd_refeicao_w			varchar(15);
ie_acm_sn_w				varchar(1);
nr_seq_prot_glic_w			bigint;

c01 CURSOR FOR
SELECT	c.nr_sequencia,
	c.dt_horario,
	coalesce(c.cd_refeicao,to_char(b.cd_dieta))
FROM	prescr_dieta_hor c,
	prescr_dieta b,
	prescr_medica a
WHERE	c.nr_prescricao = a.nr_prescricao
and	b.nr_prescricao	= a.nr_prescricao
AND	a.nr_prescricao = nr_prescricao_p
and	c.nr_seq_dieta	= b.nr_sequencia
AND (c.nr_seq_dieta	= nr_sequencia_p or coalesce(nr_sequencia_p,0) =0)
AND	ie_tipo_item_p	= 'D';

c02 CURSOR FOR
SELECT	c.nr_sequencia,
	c.dt_horario,
	c.cd_refeicao
FROM	dieta x,
	prescr_dieta d,
	prescr_dieta_hor c,
	prescr_medica a
WHERE	x.cd_dieta = d.cd_dieta
AND	d.nr_prescricao = c.nr_prescricao
AND	d.nr_prescricao	= a.nr_prescricao
AND	c.nr_prescricao = a.nr_prescricao
AND	a.nr_prescricao = nr_prescricao_p
AND	ie_tipo_item_p = 'D'
AND	d.cd_dieta = (cd_item_p)::numeric;


BEGIN

select	max(cd_estabelecimento)
into STRICT	cd_estabelecimento_w
from	usuario
where	nm_usuario = nm_usuario_p;

select	max(nr_atendimento)
into STRICT	nr_atendimento_w
from	prescr_medica
where	nr_prescricao = nr_prescricao_p;

ie_ds_w := obter_param_usuario(1113, 148, Obter_perfil_Ativo, nm_usuario_p, cd_estabelecimento_w, ie_ds_w);

if (ie_tipo_item_p = 'L') then
	ie_tipo_item_w := 'P';
else
	ie_tipo_item_w := ie_tipo_item_p;
end if;	

if (ie_tipo_item_w in ('M','S','MAT','P','R','E','D','G','C','I','LD')) then
	if (ie_acao_p = 'IS') then
		ie_alteracao_w	:= 32;
	elsif (ie_acao_p = 'SS') then
		ie_alteracao_w	:= 30;	
	elsif (ie_acao_p = 'IM') then
		ie_alteracao_w	:= 33;	
	elsif (ie_acao_p = 'SM') then
		ie_alteracao_w	:= 31;	
	elsif (ie_acao_p = 'AI') then
		ie_alteracao_w	:= 46;			
	end if;
elsif (ie_tipo_item_w in ('SNE','NAN','NPN','SOL','HM')) then
	if (ie_acao_p = 'IS') then
		ie_alteracao_w	:= 26;
	elsif (ie_acao_p = 'SS') then
		ie_alteracao_w	:= 24;	
	elsif (ie_acao_p = 'IM') then
		ie_alteracao_w	:= 27;	
	elsif (ie_acao_p = 'SM') then
		ie_alteracao_w	:= 25;	
	elsif (ie_acao_p = 'AI') then
		ie_alteracao_w	:= 32;
	end if;	
end if;

if (ie_acao_p in ('SS','SM')) and
	((coalesce(ie_alteracao_w,0) > 0) or (ie_tipo_item_w = 'O')) then

	if (ie_tipo_item_w in ('M','S','MAT','LD')) then

		select	max(nr_sequencia)
		into STRICT	nr_seq_alter_w
		from	prescr_mat_alteracao
		where	nr_prescricao = nr_prescricao_p
		and	nr_seq_prescricao = nr_sequencia_p;
	
	elsif (ie_tipo_item_w in ('P','C','I','G')) then
	
		select	max(nr_sequencia)
		into STRICT	nr_seq_alter_w
		from	prescr_mat_alteracao
		where	nr_prescricao = nr_prescricao_p
		and	nr_seq_procedimento = nr_sequencia_p;	
		
	elsif (ie_tipo_item_p = 'R') then
	
		select	max(nr_sequencia)
		into STRICT	nr_seq_alter_w
		from	prescr_mat_alteracao	
		where	nr_prescricao = nr_prescricao_p
		and	nr_seq_recomendacao = nr_sequencia_p;

	elsif (ie_tipo_item_p = 'E') then

		select	max(nr_sequencia)
		into STRICT	nr_seq_alter_w
		from	prescr_mat_alteracao
		where	nr_prescricao = nr_prescricao_p
		and	nr_seq_item_sae = nr_sequencia_p;

	elsif (ie_tipo_item_p = 'D') then
	
		if (ie_ds_w = 'S') then
		
			open C01;
			loop
			fetch C01 into	
				nr_seq_horario_w,
				dt_horario_w,
				cd_refeicao_w;
			EXIT WHEN NOT FOUND; /* apply on C01 */
				begin

				select	max(nr_sequencia)
				into STRICT	nr_seq_alter_w
				from	prescr_mat_alteracao
				where	nr_prescricao = nr_prescricao_p
				and	nr_seq_horario_dieta = nr_seq_horario_w;
				
				update	prescr_mat_alteracao
				set	ie_alteracao = ie_alteracao_w,
					ds_observacao	= substr(ds_observacao_p,1,2000)
				where	nr_sequencia = nr_seq_alter_w;				
				
				end;
			end loop;
			close C01;		
		
		else
		
			open C02;
			loop
			fetch C02 into	
				nr_seq_horario_w,
				dt_horario_w,
				cd_refeicao_w;
			EXIT WHEN NOT FOUND; /* apply on C02 */
				begin

				select	max(nr_sequencia)
				into STRICT	nr_seq_alter_w
				from	prescr_mat_alteracao
				where	nr_prescricao = nr_prescricao_p
				and	nr_seq_horario_dieta = nr_seq_horario_w;
				
				update	prescr_mat_alteracao
				set	ie_alteracao = ie_alteracao_w,
					ds_observacao	= substr(ds_observacao_p,1,2000)
				where	nr_sequencia = nr_seq_alter_w;				

				end;
			end loop;
			close C02;				
		
		end if;

	elsif (ie_tipo_item_p = 'SNE') then

		select	max(nr_sequencia)
		into STRICT	nr_seq_alter_w
		from	prescr_solucao_evento
		where	nr_prescricao = nr_prescricao_p
		and	nr_seq_material = nr_sequencia_p;
		
	elsif (ie_tipo_item_p = 'SOL') then
	
		select	max(nr_sequencia)
		into STRICT	nr_seq_alter_w
		from	prescr_solucao_evento	
		where	nr_prescricao = nr_prescricao_p
		and	nr_seq_solucao = nr_sequencia_p;		

	elsif (ie_tipo_item_p = 'HM') then
	
		select	max(nr_sequencia)
		into STRICT	nr_seq_alter_w
		from	prescr_solucao_evento	
		where	nr_prescricao = nr_prescricao_p
		and	nr_seq_procedimento = nr_sequencia_p;		
		
	elsif (ie_tipo_item_p in ('NAN','NPN')) then
	
		select	max(nr_sequencia)
		into STRICT	nr_seq_alter_w
		from	prescr_solucao_evento	
		where	nr_prescricao = nr_prescricao_p
		and	nr_seq_nut_neo = nr_sequencia_p;

	elsif (ie_tipo_item_p = 'O') then
	
		select	max(nr_sequencia)
		into STRICT	nr_seq_alter_w
		from	prescr_gasoterapia_evento	
		where	nr_seq_gasoterapia = nr_sequencia_p;
		
		update	prescr_gasoterapia_evento
		set	ie_evento = ie_acao_p,
			ds_observacao	= substr(ds_observacao_p,1,255)
		where	nr_sequencia = nr_seq_alter_w;		
		
	end if;
	
	if (ie_tipo_item_w in ('M','S','MAT','P','C','I','G','R','E','LD')) and (coalesce(nr_seq_alter_w,0) > 0) then
		
		update	prescr_mat_alteracao
		set	ie_alteracao = ie_alteracao_w,
			ds_observacao	= substr(ds_observacao_p,1,2000)
		where	nr_sequencia = nr_seq_alter_w;		
		
	elsif (ie_tipo_item_p in ('NAN','NPN','SNE','SOL','HM')) and (coalesce(nr_seq_alter_w,0) > 0) then			
		
		update	prescr_solucao_evento
		set	ie_alteracao = ie_alteracao_w,
			ds_observacao	= substr(ds_observacao_p,1,2000)
		where	nr_sequencia = nr_seq_alter_w;		
		
	end if;	
	
elsif (ie_acao_p in ('IS','IM','AI')) and
	((coalesce(ie_alteracao_w,0) > 0) or (ie_tipo_item_w = 'O')) then
	
	if (ie_tipo_item_w in ('M','S','MAT','LD')) then

		nr_seq_prescricao_w := nr_sequencia_p;
	
	elsif (ie_tipo_item_w in ('P','C','I','G')) then
	
		nr_seq_procedimento_w := nr_sequencia_p;
		
		select	max(nr_seq_proc_interno),
				max(nr_seq_prot_glic)
		into STRICT	nr_seq_proc_interno_w,
				nr_seq_prot_glic_w
		from	prescr_procedimento
		where	nr_prescricao = nr_prescricao_p
		and	nr_sequencia = nr_sequencia_p;
		
	elsif (ie_tipo_item_p = 'R') then
	
		nr_seq_recomendacao_w := nr_sequencia_p;

	elsif (ie_tipo_item_p = 'E') then
		
		nr_seq_item_sae_w := nr_sequencia_p;

	elsif (ie_tipo_item_p = 'D') then

		if (ie_ds_w = 'S') then
		
			open C01;
			loop
			fetch C01 into	
				nr_seq_horario_w,
				dt_horario_w,
				cd_refeicao_w;
			EXIT WHEN NOT FOUND; /* apply on C01 */
				begin

				SELECT	nextval('prescr_mat_alteracao_seq')
				INTO STRICT	nr_seq_alter_w
				;

				INSERT	INTO	prescr_mat_alteracao(
									nr_sequencia,
									dt_atualizacao,
									nm_usuario,
									dt_atualizacao_nrec,
									nm_usuario_nrec,
									nr_prescricao,
									nr_seq_horario_dieta,
									dt_alteracao,
									cd_pessoa_fisica,
									ie_alteracao,
									ie_tipo_item,
									dt_horario,
									nr_atendimento,
									cd_item,
									ds_observacao
									)
								VALUES (
									nr_seq_alter_w,
									clock_timestamp(),
									nm_usuario_p,
									clock_timestamp(),
									nm_usuario_p,
									nr_prescricao_p,
									nr_seq_horario_w,
									clock_timestamp(),
									obter_dados_usuario_opcao(nm_usuario_p,'C'),
									ie_alteracao_w,
									'D',
									dt_horario_w,
									nr_atendimento_w,
									cd_refeicao_w,
									substr(ds_observacao_p,1,2000)
									);

				end;
			end loop;
			close C01;		
		
		else
		
			open C02;
			loop
			fetch C02 into	
				nr_seq_horario_w,
				dt_horario_w,
				cd_refeicao_w;
			EXIT WHEN NOT FOUND; /* apply on C02 */
				begin
				
				SELECT	nextval('prescr_mat_alteracao_seq')
				INTO STRICT	nr_seq_alter_w
				;

				INSERT	INTO	prescr_mat_alteracao(
									nr_sequencia,
									dt_atualizacao,
									nm_usuario,
									dt_atualizacao_nrec,
									nm_usuario_nrec,
									nr_prescricao,
									nr_seq_horario_dieta,
									dt_alteracao,
									cd_pessoa_fisica,
									ie_alteracao,
									ie_tipo_item,
									dt_horario,
									nr_atendimento,
									cd_item,
									ds_observacao
									)
								VALUES (
									nr_seq_alter_w,
									clock_timestamp(),
									nm_usuario_p,
									clock_timestamp(),
									nm_usuario_p,
									nr_prescricao_p,
									nr_seq_horario_w,
									clock_timestamp(),
									obter_dados_usuario_opcao(nm_usuario_p,'C'),
									ie_alteracao_w,
									'D',
									dt_horario_w,
									nr_atendimento_w,
									cd_refeicao_w,
									substr(ds_observacao_p,1,2000)
									);

				end;
			end loop;
			close C02;				
		
		end if;

	elsif (ie_tipo_item_p = 'SNE') then
	
		nr_seq_prescricao_w 	:= nr_sequencia_p;
		ie_tipo_solucao_w	:= 2;
		
	elsif (ie_tipo_item_p = 'SOL') then
	
		nr_seq_solucao_w 	:= nr_sequencia_p;
		ie_tipo_solucao_w	:= 1;

	elsif (ie_tipo_item_p = 'HM') then
	
		nr_seq_procedimento_w 	:= nr_sequencia_p;
		ie_tipo_solucao_w	:= 3;
		
	elsif (ie_tipo_item_p in ('NAN','NPN')) then
	
		nr_seq_nut_neo_w 	:= nr_sequencia_p;
		ie_tipo_solucao_w	:= 5;

	elsif (ie_tipo_item_p = 'O') then
	
		select	nextval('prescr_gasoterapia_evento_seq')
		into STRICT	nr_seq_alter_w
		;

		insert into prescr_gasoterapia_evento(nr_sequencia,
			dt_atualizacao,
			nm_usuario,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			nr_seq_gasoterapia,
			ie_evento,
			dt_evento,
			ie_evento_valido,
			ds_observacao)
		values (nr_seq_alter_w,
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			nr_sequencia_p,
			ie_acao_p,
			clock_timestamp(),
			'S',
			substr(ds_observacao_p,1,255));
		
	end if;	

	if (ie_tipo_item_w in ('M','S','MAT','P','C','I','G','R','E','LD')) then
	
		select	nextval('prescr_mat_alteracao_seq')
		into STRICT	nr_seq_alter_w
		;

		select	max(CASE WHEN ie_acm='N' THEN CASE WHEN ie_se_necessario='S' THEN 'S' END   ELSE 'S' END )
		into STRICT	ie_acm_sn_w
		from	prescr_material
		where	nr_prescricao	= nr_prescricao_p
		and	nr_sequencia		= nr_sequencia_p;
		
		insert into prescr_mat_alteracao(
				nr_sequencia,
				dt_atualizacao,
				nm_usuario,
				dt_atualizacao_nrec,
				nm_usuario_nrec,
				nr_prescricao,
				nr_seq_prescricao,
				nr_seq_procedimento,
				nr_seq_recomendacao,
				nr_seq_item_sae,
				dt_alteracao,
				cd_pessoa_fisica,
				ie_alteracao,
				ie_tipo_item,
				nr_atendimento,
				cd_item,
				nr_seq_proc_interno,
				ds_observacao,
				ie_acm_sn,
				nr_seq_prot_glic
				)
		values (
			nr_seq_alter_w,
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			nr_prescricao_p,
			nr_seq_prescricao_w,
			nr_seq_procedimento_w,
			nr_seq_recomendacao_w,	
			nr_seq_item_sae_w,
			clock_timestamp(),
			obter_dados_usuario_opcao(nm_usuario_p,'C'),
			ie_alteracao_w,
			ie_tipo_item_w,
			nr_atendimento_w,
			cd_item_p,
			nr_seq_proc_interno_w,
			substr(ds_observacao_p,1,2000),
			ie_acm_sn_w,
			nr_seq_prot_glic_w
			);	

	elsif (ie_tipo_item_p in ('NAN','NPN','SNE','SOL','HM')) then		
						
		SELECT	nextval('prescr_solucao_evento_seq')
		INTO STRICT	nr_seq_alter_w
		;

		INSERT INTO prescr_solucao_evento(nr_sequencia,
				dt_atualizacao,
				nm_usuario,
				dt_atualizacao_nrec,
				nm_usuario_nrec,
				nr_prescricao,
				nr_seq_solucao,
				nr_seq_material,
				nr_seq_procedimento,
				nr_seq_nut_neo,
				cd_pessoa_fisica,
				ie_alteracao,
				dt_alteracao,
				ie_evento_valido,
				ie_tipo_solucao,
				ds_observacao)
		VALUES (nr_seq_alter_w,
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			nr_prescricao_p,
			nr_seq_solucao_w,
			nr_seq_prescricao_w,
			nr_seq_procedimento_w,
			nr_seq_nut_neo_w,
			obter_dados_usuario_opcao(nm_usuario_p, 'C'),
			ie_alteracao_w,
			clock_timestamp(),
			'S',
			ie_tipo_solucao_w,
			substr(ds_observacao_p,1,2000));

	end if;		

end if;

nr_seq_alter_p := nr_seq_alter_w;

if (coalesce(wheb_usuario_pck.get_ie_commit, 'S') = 'S') then commit; end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE plt_atualizar_gerar_evento ( ie_tipo_item_p text, nr_prescricao_p bigint, nr_sequencia_p bigint, cd_item_p text, ie_acao_p text, ds_observacao_p text, nr_seq_alter_p INOUT bigint, nm_usuario_p text) FROM PUBLIC;

