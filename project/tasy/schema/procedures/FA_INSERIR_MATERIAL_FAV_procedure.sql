-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE fa_inserir_material_fav ( nr_seq_favorito_p bigint, nr_seq_receita_p bigint, nm_usuario_p text) AS $body$
DECLARE


cd_material_w				fa_receita_farmacia_item.cd_material%type;
qt_dose_w					fa_receita_farmacia_item.qt_dose%type;
ie_via_aplicacao_w			fa_receita_farmacia_item.ie_via_aplicacao%type;
dt_validade_receita_w		fa_receita_farmacia_item.dt_validade_receita%type;
nr_dias_receita_w			fa_receita_farmacia_item.nr_dias_receita%type;
dt_inicio_receita_w			fa_receita_farmacia_item.dt_inicio_receita%type;
cd_unidade_medida_w			fa_receita_farmacia_item.cd_unidade_medida%type;
cd_intervalo_w				fa_receita_farmacia_item.cd_intervalo%type;
nm_usuario_lib_cih_w		fa_receita_farmacia_item.nm_usuario_lib_cih%type;
dt_liberacao_cih_w			fa_receita_farmacia_item.dt_liberacao_cih%type;
ie_segunda_w				fa_receita_farmacia_item.ie_segunda%type;
ie_terca_w					fa_receita_farmacia_item.ie_terca%type;
ie_quarta_w					fa_receita_farmacia_item.ie_quarta%type;
ie_quinta_w					fa_receita_farmacia_item.ie_quinta%type;
ie_sexta_w					fa_receita_farmacia_item.ie_sexta%type;
ie_sabado_w					fa_receita_farmacia_item.ie_sabado%type;
ie_domingo_w				fa_receita_farmacia_item.ie_domingo%type;
ie_uso_continuo_w			fa_receita_farmacia_item.ie_uso_continuo%type;
dt_inicio_real_receita_w	fa_receita_farmacia_item.dt_inicio_real_receita%type;
dt_validade_real_receita_w	fa_receita_farmacia_item.dt_validade_real_receita%type;
nr_ciclo_w					fa_receita_farmacia_item.nr_ciclo%type;
ds_texto_receita_w			fa_receita_farmacia_item.ds_texto_receita%type;
ie_se_necessario_w			fa_receita_farmacia_item.ie_se_necessario%type;
nr_seq_pac_atend_medic_w	fa_receita_farmacia_item.nr_seq_pac_atend_medic%type;
ds_observacao_w				fa_receita_farmacia_item.ds_observacao%type;
ds_dose_diferenciada_w		fa_receita_farmacia_item.ds_dose_diferenciada%type;
ds_justificativa_w			fa_receita_farmacia_item.ds_justificativa%type;
qt_medicacao_w				fa_receita_farmacia_item.qt_medicacao%type;

C01 CURSOR FOR
	SELECT	cd_unidade_medida,
			cd_intervalo,
			cd_material,
			qt_dose,
			ie_uso_continuo,
			ie_via_aplicacao,
			nr_dias_receita,
			ie_segunda,
			ie_terca,
			ie_quarta,
			ie_quinta,
			ie_sexta,
			ie_sabado,
			ie_domingo,
			nr_ciclo,
			ie_se_necessario,
			ds_observacao,
			ds_dose_diferenciada,
			ds_justificativa,
			nr_seq_pac_atend_medic,
			qt_medicacao
	from	fa_fav_rec_farm_item
	where	nr_sequencia = nr_seq_favorito_p
	order by nr_sequencia;


BEGIN

open C01;
loop
fetch C01 into
		cd_unidade_medida_w,
		cd_intervalo_w,
		cd_material_w,
		qt_dose_w,
		ie_uso_continuo_w,
		ie_via_aplicacao_w,
		nr_dias_receita_w,
		ie_segunda_w,
		ie_terca_w,
		ie_quarta_w,
		ie_quinta_w,
		ie_sexta_w,
		ie_sabado_w,
		ie_domingo_w,
		nr_ciclo_w,
		ie_se_necessario_w,
		ds_observacao_w,
		ds_dose_diferenciada_w,
		ds_justificativa_w,
		nr_seq_pac_atend_medic_w,
		qt_medicacao_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin

	select	max(dt_inicio_receita),
			max(dt_validade_receita)
	into STRICT	dt_inicio_receita_w,
			dt_validade_receita_w
	from	fa_receita_farmacia
	where	nr_sequencia = nr_seq_receita_p;


	insert into	fa_receita_farmacia_item(	nr_sequencia,
											dt_atualizacao,
											nm_usuario,
											dt_atualizacao_nrec,
											nm_usuario_nrec,
											nr_seq_receita,
											cd_material,
											qt_dose,
											ie_via_aplicacao,
											dt_validade_receita,
											nr_dias_receita,
											dt_inicio_receita,
											cd_unidade_medida,
											cd_intervalo,
											nm_usuario_lib_cih,
											dt_liberacao_cih,
											ie_segunda,
											ie_terca,
											ie_quarta,
											ie_quinta,
											ie_sexta,
											ie_sabado,
											ie_domingo,
											ie_uso_continuo,
											dt_inicio_real_receita,
											dt_validade_real_receita,
											nr_ciclo,
											ds_texto_receita,
											ie_se_necessario,
											nr_seq_pac_atend_medic,
											ds_observacao,
											ds_dose_diferenciada,
											ds_justificativa,
											qt_medicacao)
									values	(nextval('fa_receita_farmacia_item_seq'),
											clock_timestamp(),
											nm_usuario_p,
											clock_timestamp(),
											nm_usuario_p,
											nr_seq_receita_p,
											cd_material_w,
											qt_dose_w,
											ie_via_aplicacao_w,
											(dt_inicio_receita_w + coalesce(nr_dias_receita_w-1,null)),
											nr_dias_receita_w,
											dt_inicio_receita_w,
											cd_unidade_medida_w,
											cd_intervalo_w,
											nm_usuario_lib_cih_w,
											dt_liberacao_cih_w,
											ie_segunda_w,
											ie_terca_w,
											ie_quarta_w,
											ie_quinta_w,
											ie_sexta_w,
											ie_sabado_w,
											ie_domingo_w,
											ie_uso_continuo_w,
											dt_inicio_real_receita_w,
											dt_validade_real_receita_w,
											nr_ciclo_w,
											ds_texto_receita_w,
											ie_se_necessario_w,
											nr_seq_pac_atend_medic_w,
											ds_observacao_w,
											ds_dose_diferenciada_w,
											ds_justificativa_w,
											qt_medicacao_w);


	end;
end loop;
close C01;


commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE fa_inserir_material_fav ( nr_seq_favorito_p bigint, nr_seq_receita_p bigint, nm_usuario_p text) FROM PUBLIC;

