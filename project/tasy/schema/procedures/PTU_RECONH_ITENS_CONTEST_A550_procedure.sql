-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE ptu_reconh_itens_contest_a550 ( nr_seq_questionamento_p ptu_questionamento.nr_sequencia%type, nr_seq_conta_p INOUT pls_conta.nr_sequencia%type, nr_seq_conta_proc_p INOUT pls_conta_proc.nr_sequencia%type, nr_seq_conta_mat_p INOUT pls_conta_mat.nr_sequencia%type, nr_seq_nota_servico_p INOUT ptu_nota_servico.nr_sequencia%type, nr_seq_nota_cobranca_p INOUT ptu_nota_cobranca.nr_sequencia%type) AS $body$
DECLARE


-- Nesta rotina sera passado o item que retornou no A550 e vamos busca-lo na forma de pls_conta_proc ou pls_conta_mat
nr_seq_conta_w			pls_conta.nr_sequencia%type;
nr_seq_conta_proc_w 		pls_conta_proc.nr_sequencia%type;
nr_seq_conta_mat_w 		pls_conta_mat.nr_sequencia%type;
nr_seq_nota_servico_w		ptu_nota_servico.nr_sequencia%type;
nr_seq_nota_cobranca_w		ptu_nota_cobranca.nr_sequencia%type;
nr_fatura_w			ptu_camara_contestacao.nr_fatura%type;
nr_seq_a500_w			ptu_questionamento.nr_seq_a500%type;
nr_nota_w			ptu_questionamento.nr_nota%type;
cd_servico_w			ptu_questionamento.cd_servico%type;
nr_nota_numerico_w		ptu_questionamento.nr_nota_numerico%type;
nr_seq_pls_fatura_w		pls_fatura.nr_sequencia%type;
ie_tipo_tabela_w		ptu_questionamento.ie_tipo_tabela%type;
dt_atendimento_w		ptu_questionamento.dt_atendimento%type;
vl_total_cobrado_w		ptu_questionamento.vl_cobrado%type;
vl_cobrado_w			ptu_questionamento.vl_cobrado%type;
nr_seq_lote_fat_w		pls_fatura.nr_seq_lote%type;
nr_seq_segurado_w		pls_segurado.nr_sequencia%type;
nr_seq_segurado_ptu_w		pls_segurado.nr_sequencia%type;
cd_usuario_plano_ptu_w		ptu_questionamento.cd_usuario_plano%type;
cd_unimed_w			ptu_camara_contestacao.cd_unimed_origem%type;
cd_usuario_plano_w		varchar(50);
ds_servico_w			ptu_questionamento.ds_servico%type;
ie_tipo_exportacao_w		ptu_fatura.ie_tipo_exportacao%type;

cd_item_unico_w         ptu_questionamento.cd_item_unico%type;

nr_lote_w               ptu_questionamento.nr_lote%type;
nr_lote_prest_w         ptu_questionamento.nr_lote_prest%type;
nr_guia_tiss_prest_w    ptu_questionamento.nr_guia_tiss_prestador%type;



BEGIN
nr_seq_conta_p		:= null;
nr_seq_conta_proc_p	:= null;
nr_seq_conta_mat_p	:= null;
nr_seq_nota_servico_p	:= null;
nr_seq_nota_cobranca_p	:= null;

select	x.nr_fatura,
	c.nr_seq_a500,
	c.nr_nota,
  	c.nr_lote,
	c.cd_servico,
	c.nr_nota_numerico,
	c.ie_tipo_tabela,
	c.dt_atendimento,
	cd_usuario_plano,
	lpad(cd_unimed_origem,4,'0'),
	(coalesce(vl_cobrado,0) + coalesce(vl_cobr_co,0) + coalesce(vl_cobr_filme,0) + coalesce(vl_cobr_adic_co,0) + coalesce(vl_cobr_adic_filme,0) + coalesce(vl_cobr_adic_serv,0)) vl_total_cobrado,
	(coalesce(vl_cobrado,0) + coalesce(vl_cobr_co,0) + coalesce(vl_cobr_filme,0)) vl_cobrado,
	upper(trim(both ptu_somente_caracter_permitido(c.ds_servico,'AN'))) ds_servico,
  	c.cd_item_unico,
  	c.nr_lote_prest,
  	c.nr_guia_tiss_prestador
into STRICT	nr_fatura_w,
	nr_seq_a500_w,
	nr_nota_w,
  	nr_lote_w,
	cd_servico_w,
	nr_nota_numerico_w,
	ie_tipo_tabela_w,
	dt_atendimento_w,
	cd_usuario_plano_ptu_w,
	cd_unimed_w,
	vl_total_cobrado_w,
	vl_cobrado_w,
	ds_servico_w,
  	cd_item_unico_w,
  	nr_lote_prest_w,
  	nr_guia_tiss_prest_w
from	ptu_camara_contestacao x,
	ptu_questionamento c
where	x.nr_sequencia	= c.nr_seq_contestacao
and	c.nr_sequencia	= nr_seq_questionamento_p;

if (nr_fatura_w IS NOT NULL AND nr_fatura_w::text <> '') then
	select	max(pf.nr_sequencia),
		max(pf.nr_seq_lote),
		coalesce(max(pt.ie_tipo_exportacao), 'TXT')
	into STRICT	nr_seq_pls_fatura_w,
		nr_seq_lote_fat_w,
		ie_tipo_exportacao_w
	from	pls_fatura	pf,
		ptu_fatura	pt
	where	pf.nr_sequencia	= pt.nr_seq_pls_fatura
	and	((pt.nr_fatura = nr_fatura_w) or (pf.nr_titulo = nr_fatura_w))
	and	coalesce(pt.ie_tipo_cobranca_fatura,'C') = 'C';
end if;

-- TODAS AS INFORMACOES CORRETAS
select	max(b.nr_seq_conta),
	max(c.nr_seq_conta_proc),
	max(c.nr_seq_conta_mat),
	max(c.nr_sequencia),
	max(b.nr_sequencia)
into STRICT	nr_seq_conta_w,
	nr_seq_conta_proc_w,
	nr_seq_conta_mat_w,
	nr_seq_nota_servico_w,
	nr_seq_nota_cobranca_w
from	ptu_nota_servico c,
	ptu_nota_cobranca b,
	ptu_fatura	a
where	c.nr_seq_nota_cobr	= b.nr_sequencia
and	a.nr_sequencia		= b.nr_seq_fatura
and	c.ie_tipo_tabela	= ie_tipo_tabela_w
and	a.nr_seq_pls_fatura	= nr_seq_pls_fatura_w
and     ((b.nr_lote_prest = nr_lote_prest_w and b.nr_guia_tiss_prestador = nr_guia_tiss_prest_w and a.ie_tipo_exportacao = 'XML')
or (b.nr_lote = nr_lote_w and b.nr_nota = nr_nota_w and a.ie_tipo_exportacao = 'TXT')          )

and	((c.nr_seq_a500 	= nr_seq_a500_w AND ie_tipo_exportacao_w = 'TXT') or (c.nr_seq_item	= nr_seq_a500_w AND ie_tipo_exportacao_w = 'XML'))
and	b.cd_usuario_plano	= cd_usuario_plano_ptu_w
and 	((c.cd_item_unico = cd_item_unico_w) or ((coalesce(c.cd_item_unico::text, '') = '') and (coalesce(cd_item_unico_w::text, '') = '')))
and	c.cd_servico		= cd_servico_w
and	coalesce(a.ie_tipo_cobranca_fatura,'C') = 'C';

-- CASO O CODIGO DO SERVICO SEJA APENAS COMPATIVEL COM OS CODIGOS TASY - PLS
if (coalesce(nr_seq_conta_w::text, '') = '') then
	select	max(b.nr_seq_conta),
		max(c.nr_seq_conta_proc),
		max(c.nr_seq_conta_mat),
		max(c.nr_sequencia),
		max(b.nr_sequencia)
	into STRICT	nr_seq_conta_w,
		nr_seq_conta_proc_w,
		nr_seq_conta_mat_w,
		nr_seq_nota_servico_w,
		nr_seq_nota_cobranca_w
	from	ptu_nota_servico c,
		ptu_nota_cobranca b,
		ptu_fatura	a
	where	c.nr_seq_nota_cobr	= b.nr_sequencia
	and	a.nr_sequencia		= b.nr_seq_fatura
	and	c.ie_tipo_tabela	= ie_tipo_tabela_w
	and	a.nr_seq_pls_fatura	= nr_seq_pls_fatura_w
	and     ((b.nr_lote_prest = nr_lote_prest_w and b.nr_guia_tiss_prestador = nr_guia_tiss_prest_w and a.ie_tipo_exportacao = 'XML')
	or (b.nr_lote = nr_lote_w and b.nr_nota = nr_nota_w and a.ie_tipo_exportacao = 'TXT')          )
	and	((c.nr_seq_a500	= nr_seq_a500_w AND ie_tipo_exportacao_w = 'TXT') or (c.nr_seq_item = nr_seq_a500_w AND ie_tipo_exportacao_w = 'XML'))
	and 	((c.cd_item_unico = cd_item_unico_w) or ((coalesce(c.cd_item_unico::text, '') = '') and (coalesce(cd_item_unico_w::text, '') = '')))
	and	b.cd_usuario_plano	= cd_usuario_plano_ptu_w
	and	((c.cd_servico		= cd_servico_w) or (c.cd_procedimento	= cd_servico_w) or
		(cd_servico_w		= (	SELECT	max(z.cd_material_ops)
						from	pls_material z
						where	z.nr_sequencia 	= c.nr_seq_material)))
	and	coalesce(a.ie_tipo_cobranca_fatura,'C') = 'C';
end if;

-- CASO OS CODIGOS SEJAM INCOMPATIVEIS, FAZER PELO SEQ A500 E TIPO DE TABELA		
if (coalesce(nr_seq_conta_w::text, '') = '') then
	select	max(b.nr_seq_conta),
		max(c.nr_seq_conta_proc),
		max(c.nr_seq_conta_mat),
		max(c.nr_sequencia),
		max(b.nr_sequencia)
	into STRICT	nr_seq_conta_w,
		nr_seq_conta_proc_w,
		nr_seq_conta_mat_w,
		nr_seq_nota_servico_w,
		nr_seq_nota_cobranca_w
	from	ptu_nota_servico c,
		ptu_nota_cobranca b,
		ptu_fatura	a
	where	c.nr_seq_nota_cobr	= b.nr_sequencia
	and	a.nr_sequencia		= b.nr_seq_fatura
	and	c.ie_tipo_tabela	= ie_tipo_tabela_w
	and	a.nr_seq_pls_fatura	= nr_seq_pls_fatura_w
	and     ((b.nr_lote_prest = nr_lote_prest_w and b.nr_guia_tiss_prestador = nr_guia_tiss_prest_w and a.ie_tipo_exportacao = 'XML')
	or (b.nr_lote = nr_lote_w and b.nr_nota = nr_nota_w and a.ie_tipo_exportacao = 'TXT')          )
	and	((c.nr_seq_a500	= nr_seq_a500_w AND ie_tipo_exportacao_w = 'TXT') or (c.nr_seq_item = nr_seq_a500_w AND ie_tipo_exportacao_w = 'XML'))
	and 	((c.cd_item_unico = cd_item_unico_w) or ((coalesce(c.cd_item_unico::text, '') = '') and (coalesce(cd_item_unico_w::text, '') = '')))
	and	b.cd_usuario_plano	= cd_usuario_plano_ptu_w
	and	coalesce(a.ie_tipo_cobranca_fatura,'C') = 'C';
end if;

-- CASO O SEQ A500 SEJA O PROBLEMA
if (coalesce(nr_seq_conta_w::text, '') = '') then
	select	max(b.nr_seq_conta),
		max(c.nr_seq_conta_proc),
		max(c.nr_seq_conta_mat),
		max(c.nr_sequencia),
		max(b.nr_sequencia)
	into STRICT	nr_seq_conta_w,
		nr_seq_conta_proc_w,
		nr_seq_conta_mat_w,
		nr_seq_nota_servico_w,
		nr_seq_nota_cobranca_w
	from	ptu_nota_servico c,
		ptu_nota_cobranca b,
		ptu_fatura	a
	where	c.nr_seq_nota_cobr	= b.nr_sequencia
	and	a.nr_sequencia		= b.nr_seq_fatura
	and	c.ie_tipo_tabela	= ie_tipo_tabela_w
	and	a.nr_seq_pls_fatura	= nr_seq_pls_fatura_w
	and     ((b.nr_lote_prest = nr_lote_prest_w and b.nr_guia_tiss_prestador = nr_guia_tiss_prest_w and a.ie_tipo_exportacao = 'XML')
	or (b.nr_lote = nr_lote_w and b.nr_nota = nr_nota_w and a.ie_tipo_exportacao = 'TXT')          )

	and	((c.ds_servico_aux	= ds_servico_w AND ie_tipo_exportacao_w = 'TXT') or (ie_tipo_exportacao_w = 'XML'))
	and 	((c.cd_item_unico = cd_item_unico_w) or ((coalesce(c.cd_item_unico::text, '') = '') and (coalesce(cd_item_unico_w::text, '') = '')))
	and	b.cd_usuario_plano	= cd_usuario_plano_ptu_w
	and	c.cd_servico		= cd_servico_w
	and (c.vl_procedimento + c.vl_filme + c.vl_custo_operacional + c.vl_adic_procedimento + c.vl_adic_filme + c.vl_adic_co) >= vl_total_cobrado_w
	and	coalesce(a.ie_tipo_cobranca_fatura,'C') = 'C';

	if (coalesce(nr_seq_conta_w::text, '') = '') then
		select	max(b.nr_seq_conta),
			max(c.nr_seq_conta_proc),
			max(c.nr_seq_conta_mat),
			max(c.nr_sequencia),
			max(b.nr_sequencia)
		into STRICT	nr_seq_conta_w,
			nr_seq_conta_proc_w,
			nr_seq_conta_mat_w,
			nr_seq_nota_servico_w,
			nr_seq_nota_cobranca_w
		from	ptu_nota_servico c,
			ptu_nota_cobranca b,
			ptu_fatura	a
		where	c.nr_seq_nota_cobr	= b.nr_sequencia
		and	a.nr_sequencia		= b.nr_seq_fatura
		and	c.ie_tipo_tabela	= ie_tipo_tabela_w
		and	a.nr_seq_pls_fatura	= nr_seq_pls_fatura_w
		and     ((b.nr_lote_prest = nr_lote_prest_w and b.nr_guia_tiss_prestador = nr_guia_tiss_prest_w and a.ie_tipo_exportacao = 'XML')
		or (b.nr_lote = nr_lote_w and b.nr_nota = nr_nota_w and a.ie_tipo_exportacao = 'TXT')          )
		and	((c.ds_servico_aux	= ds_servico_w AND ie_tipo_exportacao_w = 'TXT') or (ie_tipo_exportacao_w = 'XML'))
		and 	((c.cd_item_unico = cd_item_unico_w) or ((coalesce(c.cd_item_unico::text, '') = '') and (coalesce(cd_item_unico_w::text, '') = '')))
		and	b.cd_usuario_plano	= cd_usuario_plano_ptu_w
		and	c.cd_servico		= cd_servico_w
		and	coalesce(a.ie_tipo_cobranca_fatura,'C') = 'C';
	end if;

	if (coalesce(nr_seq_conta_w::text, '') = '') then
		select	max(b.nr_seq_conta),
			max(c.nr_seq_conta_proc),
			max(c.nr_seq_conta_mat),
			max(c.nr_sequencia),
			max(b.nr_sequencia)
		into STRICT	nr_seq_conta_w,
			nr_seq_conta_proc_w,
			nr_seq_conta_mat_w,
			nr_seq_nota_servico_w,
			nr_seq_nota_cobranca_w
		from	ptu_nota_servico c,
			ptu_nota_cobranca b,
			ptu_fatura	a
		where	c.nr_seq_nota_cobr	= b.nr_sequencia
		and	a.nr_sequencia		= b.nr_seq_fatura
		and	c.ie_tipo_tabela	= ie_tipo_tabela_w
		and	a.nr_seq_pls_fatura	= nr_seq_pls_fatura_w
		and     ((b.nr_lote_prest = nr_lote_prest_w and b.nr_guia_tiss_prestador = nr_guia_tiss_prest_w and a.ie_tipo_exportacao = 'XML')
		or (b.nr_lote = nr_lote_w and b.nr_nota = nr_nota_w and a.ie_tipo_exportacao = 'TXT')          )
		and	b.cd_usuario_plano	= cd_usuario_plano_ptu_w
		and	((c.cd_servico		= cd_servico_w) or (c.cd_procedimento	= cd_servico_w) or
			(cd_servico_w		= (	SELECT	max(z.cd_material_ops)
							from	pls_material z
							where	z.nr_sequencia 	= c.nr_seq_material)))
		and	coalesce(a.ie_tipo_cobranca_fatura,'C') = 'C';
	end if;
end if;

-- CASO O TIPO DE TABELA NAO ESTEJA OK, FAZER PELO SEQ A500
if (coalesce(nr_seq_conta_w::text, '') = '') then
	select	max(b.nr_seq_conta),
		max(c.nr_seq_conta_proc),
		max(c.nr_seq_conta_mat),
		max(c.nr_sequencia),
		max(b.nr_sequencia)
	into STRICT	nr_seq_conta_w,
		nr_seq_conta_proc_w,
		nr_seq_conta_mat_w,
		nr_seq_nota_servico_w,
		nr_seq_nota_cobranca_w
	from	ptu_nota_servico c,
		ptu_nota_cobranca b,
		ptu_fatura	a
	where	c.nr_seq_nota_cobr	= b.nr_sequencia
	and	a.nr_sequencia		= b.nr_seq_fatura
	and	a.nr_seq_pls_fatura	= nr_seq_pls_fatura_w
	and     ((b.nr_lote_prest = nr_lote_prest_w and b.nr_guia_tiss_prestador = nr_guia_tiss_prest_w and a.ie_tipo_exportacao = 'XML')
	or (b.nr_lote = nr_lote_w and b.nr_nota = nr_nota_w and a.ie_tipo_exportacao = 'TXT')          )
	and	((c.nr_seq_a500	= nr_seq_a500_w AND ie_tipo_exportacao_w = 'TXT') or (c.nr_seq_item = nr_seq_a500_w AND ie_tipo_exportacao_w = 'XML'))
	and 	((c.cd_item_unico = cd_item_unico_w) or ((coalesce(c.cd_item_unico::text, '') = '') and (coalesce(cd_item_unico_w::text, '') = '')))
	and	b.cd_usuario_plano	= cd_usuario_plano_ptu_w
	and	coalesce(a.ie_tipo_cobranca_fatura,'C') = 'C';
end if;

-- CASO SEJA PTU 4.1 B, PODE OCORRER DE TER APENAS PARTE DO NR_NOTA
if (coalesce(nr_seq_conta_w::text, '') = '') then
	select	max(b.nr_seq_conta),
		max(c.nr_seq_conta_proc),
		max(c.nr_seq_conta_mat),
		max(c.nr_sequencia),
		max(b.nr_sequencia)
	into STRICT	nr_seq_conta_w,
		nr_seq_conta_proc_w,
		nr_seq_conta_mat_w,
		nr_seq_nota_servico_w,
		nr_seq_nota_cobranca_w
	from	ptu_nota_servico c,
		ptu_nota_cobranca b,
		ptu_fatura	a
	where	c.nr_seq_nota_cobr	= b.nr_sequencia
	and	a.nr_sequencia		= b.nr_seq_fatura
	and	c.ie_tipo_tabela	= ie_tipo_tabela_w
	and	a.nr_seq_pls_fatura	= nr_seq_pls_fatura_w
	and	substr(b.nr_nota,1,10)	= substr(nr_nota_w,1,10)
	and	b.cd_usuario_plano	= cd_usuario_plano_ptu_w
	and	c.cd_servico		= cd_servico_w
	and	coalesce(a.ie_tipo_cobranca_fatura,'C') = 'C';
end if;

-- CASO A NOTA SEJA O PROBLEMA
if (coalesce(nr_seq_conta_w::text, '') = '') then
	select	max(b.nr_seq_conta),
		max(c.nr_seq_conta_proc),
		max(c.nr_seq_conta_mat),
		max(c.nr_sequencia),
		max(b.nr_sequencia)
	into STRICT	nr_seq_conta_w,
		nr_seq_conta_proc_w,
		nr_seq_conta_mat_w,
		nr_seq_nota_servico_w,
		nr_seq_nota_cobranca_w
	from	ptu_nota_servico c,
		ptu_nota_cobranca b,
		ptu_fatura	a
	where	c.nr_seq_nota_cobr	= b.nr_sequencia
	and	a.nr_sequencia		= b.nr_seq_fatura
	and	c.ie_tipo_tabela	= ie_tipo_tabela_w
	and	a.nr_seq_pls_fatura	= nr_seq_pls_fatura_w
	and	b.cd_usuario_plano	= cd_usuario_plano_ptu_w
	and	((c.cd_servico		= cd_servico_w) or (c.cd_procedimento	= cd_servico_w) or
		(cd_servico_w		= (	SELECT	max(z.cd_material_ops)
						from	pls_material z
						where	z.nr_sequencia 	= c.nr_seq_material)))
	and (c.vl_procedimento + vl_filme + vl_custo_operacional +
		vl_adic_procedimento + vl_adic_filme + vl_adic_co) = vl_total_cobrado_w
	and	coalesce(a.ie_tipo_cobranca_fatura,'C') = 'C';
end if;

-- CASO AS FORMAS ACIMA NAO TENHAM SIDO EFICIENTES
if (coalesce(nr_seq_conta_w::text, '') = '') then
	select	max(b.nr_seq_conta),
		max(c.nr_seq_conta_proc),
		max(c.nr_seq_conta_mat),
		max(c.nr_sequencia),
		max(b.nr_sequencia)
	into STRICT	nr_seq_conta_w,
		nr_seq_conta_proc_w,
		nr_seq_conta_mat_w,
		nr_seq_nota_servico_w,
		nr_seq_nota_cobranca_w
	from	ptu_nota_servico c,
		ptu_nota_cobranca b,
		ptu_fatura	a
	where	c.nr_seq_nota_cobr	= b.nr_sequencia
	and	a.nr_sequencia		= b.nr_seq_fatura
	and	c.ie_tipo_tabela	= ie_tipo_tabela_w
	and	a.nr_seq_pls_fatura	= nr_seq_pls_fatura_w
	and     ((b.nr_lote_prest = nr_lote_prest_w and b.nr_guia_tiss_prestador = nr_guia_tiss_prest_w and a.ie_tipo_exportacao = 'XML')
	or (b.nr_lote = nr_lote_w and b.nr_nota = nr_nota_w and a.ie_tipo_exportacao = 'TXT')          )
	and	c.dt_procedimento	= dt_atendimento_w
	and	b.cd_usuario_plano	= cd_usuario_plano_ptu_w
	and (c.vl_procedimento + vl_filme + vl_custo_operacional +
		vl_adic_procedimento + vl_adic_filme + vl_adic_co) = vl_total_cobrado_w
	and	coalesce(a.ie_tipo_cobranca_fatura,'C') = 'C';
end if;

-- PTU
if (coalesce(nr_seq_conta_w::text, '') = '') then
	select	max(b.nr_seq_conta),
		max(c.nr_seq_conta_proc),
		max(c.nr_seq_conta_mat),
		max(c.nr_sequencia),
		max(b.nr_sequencia)
	into STRICT	nr_seq_conta_w,
		nr_seq_conta_proc_w,
		nr_seq_conta_mat_w,
		nr_seq_nota_servico_w,
		nr_seq_nota_cobranca_w
	from	ptu_nota_servico c,
		ptu_nota_cobranca b,
		ptu_fatura	a
	where	c.nr_seq_nota_cobr	= b.nr_sequencia
	and	a.nr_sequencia		= b.nr_seq_fatura
	and	c.ie_tipo_tabela	= ie_tipo_tabela_w
	and	a.nr_seq_pls_fatura	= nr_seq_pls_fatura_w
	and     ((b.nr_lote_prest = nr_lote_prest_w and b.nr_guia_tiss_prestador = nr_guia_tiss_prest_w and a.ie_tipo_exportacao = 'XML')
	or (b.nr_lote = nr_lote_w and b.nr_nota = nr_nota_w and a.ie_tipo_exportacao = 'TXT')          )
	and	b.cd_usuario_plano	= cd_usuario_plano_ptu_w
	and (c.vl_procedimento + vl_filme + vl_custo_operacional +
		vl_adic_procedimento + vl_adic_filme + vl_adic_co) = vl_total_cobrado_w
	and	coalesce(a.ie_tipo_cobranca_fatura,'C') = 'C';
end if;

select	max(nr_seq_segurado)
into STRICT	nr_seq_segurado_ptu_w
from	pls_conta c,
	ptu_nota_cobranca b,
	ptu_fatura	a
where	a.nr_sequencia		= b.nr_seq_fatura
and	c.nr_sequencia		= b.nr_seq_conta
and	a.nr_seq_pls_fatura	= nr_seq_pls_fatura_w
and     ((b.nr_lote_prest = nr_lote_prest_w and b.nr_guia_tiss_prestador = nr_guia_tiss_prest_w and a.ie_tipo_exportacao = 'XML')
or (b.nr_lote = nr_lote_w and b.nr_nota = nr_nota_w and a.ie_tipo_exportacao = 'TXT')          )
and	b.cd_usuario_plano	= cd_usuario_plano_ptu_w
and	coalesce(a.ie_tipo_cobranca_fatura,'C') = 'C';

-- CASO NAO ENCONTRE A NOTA NO A500
if (coalesce(nr_seq_conta_w::text, '') = '') then
	cd_usuario_plano_w	:= cd_unimed_w || cd_usuario_plano_ptu_w;
	nr_seq_segurado_w	:= nr_seq_segurado_ptu_w;

	if (coalesce(nr_seq_segurado_w::text, '') = '') then
		select 	max(b.nr_sequencia)
		into STRICT	nr_seq_segurado_w
		from	pls_segurado_carteira a,
			pls_segurado b,
			pls_conta x
		where 	b.nr_sequencia 		= a.nr_seq_segurado
		and	b.nr_sequencia		= x.nr_seq_segurado
		and	x.cd_guia		= nr_nota_numerico_w
		and	b.ie_tipo_repasse  	= 'C'
		and	b.ie_tipo_segurado 	= 'T'
		and	a.nr_cartao_intercambio = cd_usuario_plano_w;
		
		if (coalesce(nr_seq_segurado_w::text, '') = '') then
			select	max(b.nr_sequencia)
			into STRICT	nr_seq_segurado_w
			from	pls_segurado b,
				pls_conta x
			where	b.nr_sequencia		= x.nr_seq_segurado
			and	x.cd_guia		= nr_nota_numerico_w
			and	b.cd_cartao_intercambio	= cd_usuario_plano_w;
			
			if (coalesce(nr_seq_segurado_w::text, '') = '') then
				select	max(b.nr_sequencia)
				into STRICT	nr_seq_segurado_w
				from	pls_segurado_carteira a,
					pls_segurado b,
					pls_conta x
				where	a.nr_seq_segurado	= b.nr_sequencia
				and	b.nr_sequencia		= x.nr_seq_segurado
				and	x.cd_guia		= nr_nota_numerico_w
				and	a.cd_usuario_plano 	= cd_usuario_plano_w;
			end if;
			
			if (coalesce(nr_seq_segurado_w::text, '') = '') then
				select 	max(b.nr_sequencia)
				into STRICT	nr_seq_segurado_w
				from	pls_segurado_carteira a,
					pls_segurado b
				where 	b.nr_sequencia 		= a.nr_seq_segurado
				and	b.ie_tipo_repasse  	= 'C'
				and	b.ie_tipo_segurado 	= 'T'
				and	a.nr_cartao_intercambio = cd_usuario_plano_w;
				
				if (coalesce(nr_seq_segurado_w::text, '') = '') then
					select	max(b.nr_sequencia)
					into STRICT	nr_seq_segurado_w
					from	pls_segurado b
					where	b.cd_cartao_intercambio	= cd_usuario_plano_w;
					
					if (coalesce(nr_seq_segurado_w::text, '') = '') then
						select	max(b.nr_sequencia)
						into STRICT	nr_seq_segurado_w
						from	pls_segurado_carteira a,
							pls_segurado b
						where	a.nr_seq_segurado	= b.nr_sequencia
						and	a.cd_usuario_plano 	= cd_usuario_plano_w;
					end if;
				end if;
			
			end if;
		end if;
	end if;

	-- PROCEDIMENTO
	if (ie_tipo_tabela_w not in (2,3,5,6)) then
		select	max(c.nr_sequencia),
			max(p.nr_sequencia)
		into STRICT	nr_seq_conta_w,
			nr_seq_conta_proc_w
		from	pls_conta c,
			pls_conta_proc p,
			pls_conta_pos_estabelecido d
		where	c.nr_sequencia		= p.nr_seq_conta
		and	c.nr_sequencia		= d.nr_seq_conta
		and	p.nr_sequencia		= d.nr_seq_conta_proc
		and	d.nr_seq_lote_fat	= nr_seq_lote_fat_w
		and	d.vl_beneficiario	= vl_total_cobrado_w
		and	p.dt_procedimento	= dt_atendimento_w
		and	c.cd_guia		= nr_nota_numerico_w
		and 	d.ie_status_faturamento <> 'A' -- diferente de aviso de cobranca
		and	p.cd_procedimento	= cd_servico_w
		and	c.nr_seq_segurado	= nr_seq_segurado_w;
		
		-- CASO A DATA DO PROCEDIMENTO NAO SEJA A MESMA
		if (coalesce(nr_seq_conta_w::text, '') = '') then
			select	max(c.nr_sequencia),
				max(p.nr_sequencia)
			into STRICT	nr_seq_conta_w,
				nr_seq_conta_proc_w
			from	pls_conta c,
				pls_conta_proc p,
				pls_conta_pos_estabelecido d
			where	c.nr_sequencia		= p.nr_seq_conta
			and	c.nr_sequencia		= d.nr_seq_conta
			and	p.nr_sequencia		= d.nr_seq_conta_proc
			and	d.nr_seq_lote_fat	= nr_seq_lote_fat_w
			and	d.vl_beneficiario	= vl_total_cobrado_w
			and	d.ie_status_faturamento <> 'A' -- diferente de aviso de cobranca
			and	c.cd_guia		= nr_nota_numerico_w
			and	p.cd_procedimento	= cd_servico_w
			and	c.nr_seq_segurado	= nr_seq_segurado_w;
		end if;
		
		-- CASO O VALOR E LOTE FAT NAO ESTEJAM OK
		if (coalesce(nr_seq_conta_w::text, '') = '') then
			select	max(c.nr_sequencia),
				max(p.nr_sequencia)
			into STRICT	nr_seq_conta_w,
				nr_seq_conta_proc_w
			from	pls_conta c,
				pls_conta_proc p,
				pls_conta_pos_estabelecido d
			where	c.nr_sequencia		= p.nr_seq_conta
			and	c.nr_sequencia		= d.nr_seq_conta
			and	p.nr_sequencia		= d.nr_seq_conta_proc
			and	p.dt_procedimento	= dt_atendimento_w
			and	c.cd_guia		= nr_nota_numerico_w
			and	p.cd_procedimento	= cd_servico_w
			and 	d.ie_status_faturamento <> 'A' -- diferente de aviso de cobranca
			and	c.nr_seq_segurado	= nr_seq_segurado_w
			and	(d.nr_seq_lote_fat IS NOT NULL AND d.nr_seq_lote_fat::text <> '');
		end if;
		
		-- CASO O CODIGO NAO ESTEJA OK
		if (coalesce(nr_seq_conta_w::text, '') = '') then
			select	max(c.nr_sequencia),
				max(p.nr_sequencia)
			into STRICT	nr_seq_conta_w,
				nr_seq_conta_proc_w
			from	pls_conta c,
				pls_conta_proc p,
				pls_conta_pos_estabelecido d
			where	c.nr_sequencia		= p.nr_seq_conta
			and	c.nr_sequencia		= d.nr_seq_conta
			and	p.nr_sequencia		= d.nr_seq_conta_proc
			and	d.nr_seq_lote_fat	= nr_seq_lote_fat_w
			and	d.vl_beneficiario	= vl_total_cobrado_w
			and	p.dt_procedimento	= dt_atendimento_w
			and 	d.ie_status_faturamento <> 'A' -- diferente de aviso de cobranca
			and	c.cd_guia		= nr_nota_numerico_w
			and	c.nr_seq_segurado	= nr_seq_segurado_w;
		end if;
		
		-- CASO O VALOR E A DATA NAO ESTEJAM OK
		if (coalesce(nr_seq_conta_w::text, '') = '') then
			select	max(c.nr_sequencia),
				max(p.nr_sequencia)
			into STRICT	nr_seq_conta_w,
				nr_seq_conta_proc_w
			from	pls_conta c,
				pls_conta_proc p,
				pls_conta_pos_estabelecido d
			where	c.nr_sequencia		= p.nr_seq_conta
			and	c.nr_sequencia		= d.nr_seq_conta
			and	p.nr_sequencia		= d.nr_seq_conta_proc
			and	d.nr_seq_lote_fat	= nr_seq_lote_fat_w
			and 	d.ie_status_faturamento <> 'A' -- diferente de aviso de cobranca
			and	c.cd_guia		= nr_nota_numerico_w
			and	p.cd_procedimento	= cd_servico_w
			and	c.nr_seq_segurado	= nr_seq_segurado_w;
		end if;
		
		-- CASO TENHA QUE PEGAR DE FORMA MAIS ABRANGETE
		if (coalesce(nr_seq_conta_w::text, '') = '') then
			select	max(c.nr_sequencia),
				max(p.nr_sequencia)
			into STRICT	nr_seq_conta_w,
				nr_seq_conta_proc_w
			from	pls_conta c,
				pls_conta_proc p,
				pls_conta_pos_estabelecido d
			where	c.nr_sequencia		= p.nr_seq_conta
			and	c.nr_sequencia		= d.nr_seq_conta
			and	p.nr_sequencia		= d.nr_seq_conta_proc
			and	d.vl_beneficiario	= vl_total_cobrado_w
			and	c.cd_guia		= nr_nota_numerico_w
			and 	d.ie_status_faturamento <> 'A' -- diferente de aviso de cobranca
			and	p.cd_procedimento	= cd_servico_w
			and	c.nr_seq_segurado	= nr_seq_segurado_w;
		end if;
		
		-- NAO SEJA O MESMO LOTE DE FATURAMENTO
		if (coalesce(nr_seq_conta_w::text, '') = '') then
			select	max(c.nr_sequencia),
				max(p.nr_sequencia)
			into STRICT	nr_seq_conta_w,
				nr_seq_conta_proc_w
			from	pls_conta c,
				pls_conta_proc p,
				pls_conta_pos_estabelecido d
			where	c.nr_sequencia		= p.nr_seq_conta
			and	c.nr_sequencia		= d.nr_seq_conta
			and	p.nr_sequencia		= d.nr_seq_conta_proc
			and	c.cd_guia		= nr_nota_numerico_w
			and	p.cd_procedimento	= cd_servico_w
			and 	d.ie_status_faturamento <> 'A' -- diferente de aviso de cobranca
			and	c.nr_seq_segurado	= nr_seq_segurado_w
			and	(d.nr_seq_lote_fat IS NOT NULL AND d.nr_seq_lote_fat::text <> '');
		end if;
	
	-- MATERIAL
	else
		select	max(c.nr_sequencia),
			max(m.nr_sequencia)
		into STRICT	nr_seq_conta_w,
			nr_seq_conta_mat_w
		from	pls_material x,
			pls_conta c,
			pls_conta_mat m,
			pls_conta_pos_estabelecido d
		where	c.nr_sequencia		= m.nr_seq_conta
		and	c.nr_sequencia		= d.nr_seq_conta
		and	m.nr_sequencia		= d.nr_seq_conta_mat
		and	x.nr_sequencia		= m.nr_seq_material
		and	d.nr_seq_lote_fat	= nr_seq_lote_fat_w
		and	d.vl_beneficiario	= vl_total_cobrado_w
		and	m.dt_atendimento	= dt_atendimento_w
		and	d.ie_status_faturamento <> 'A' -- diferente de aviso de cobranca
		and	c.cd_guia		= nr_nota_numerico_w
		and	x.cd_material_ops	= cd_servico_w
		and	c.nr_seq_segurado	= nr_seq_segurado_w;
		
		-- CASO A DATA DO MATERIAL NAO SEJA A MESMA
		if (coalesce(nr_seq_conta_w::text, '') = '') then
			select	max(c.nr_sequencia),
				max(m.nr_sequencia)
			into STRICT	nr_seq_conta_w,
				nr_seq_conta_mat_w
			from	pls_material x,
				pls_conta c,
				pls_conta_mat m,
				pls_conta_pos_estabelecido d
			where	c.nr_sequencia		= m.nr_seq_conta
			and	c.nr_sequencia		= d.nr_seq_conta
			and	m.nr_sequencia		= d.nr_seq_conta_mat
			and	x.nr_sequencia		= m.nr_seq_material
			and	d.nr_seq_lote_fat	= nr_seq_lote_fat_w
			and 	d.ie_status_faturamento <> 'A' -- diferente de aviso de cobranca
			and	d.vl_beneficiario	= vl_total_cobrado_w
			and	c.cd_guia		= nr_nota_numerico_w
			and	x.cd_material_ops	= cd_servico_w
			and	c.nr_seq_segurado	= nr_seq_segurado_w;
		end if;
		
		-- CASO O VALOR E LOTE FAT NAO ESTEJAM OK
		if (coalesce(nr_seq_conta_w::text, '') = '') then
			select	max(c.nr_sequencia),
				max(m.nr_sequencia)
			into STRICT	nr_seq_conta_w,
				nr_seq_conta_mat_w
			from	pls_material x,
				pls_conta c,
				pls_conta_mat m,
				pls_conta_pos_estabelecido d
			where	c.nr_sequencia		= m.nr_seq_conta
			and	c.nr_sequencia		= d.nr_seq_conta
			and	m.nr_sequencia		= d.nr_seq_conta_mat
			and	x.nr_sequencia		= m.nr_seq_material
			and 	d.ie_status_faturamento <> 'A' -- diferente de aviso de cobranca
			and	m.dt_atendimento	= dt_atendimento_w
			and	c.cd_guia		= nr_nota_numerico_w
			and	x.cd_material_ops	= cd_servico_w
			and	c.nr_seq_segurado	= nr_seq_segurado_w
			and	(d.nr_seq_lote_fat IS NOT NULL AND d.nr_seq_lote_fat::text <> '');
		end if;
		
		-- CASO O CODIGO NAO ESTEJA OK
		if (coalesce(nr_seq_conta_w::text, '') = '') then
			select	max(c.nr_sequencia),
				max(m.nr_sequencia)
			into STRICT	nr_seq_conta_w,
				nr_seq_conta_mat_w
			from	pls_material x,
				pls_conta c,
				pls_conta_mat m,
				pls_conta_pos_estabelecido d
			where	c.nr_sequencia		= m.nr_seq_conta
			and	c.nr_sequencia		= d.nr_seq_conta
			and	m.nr_sequencia		= d.nr_seq_conta_mat
			and	x.nr_sequencia		= m.nr_seq_material
			and	d.nr_seq_lote_fat	= nr_seq_lote_fat_w
			and 	d.ie_status_faturamento <> 'A' -- diferente de aviso de cobranca
			and	d.vl_beneficiario	= vl_total_cobrado_w
			and	m.dt_atendimento	= dt_atendimento_w
			and	c.cd_guia		= nr_nota_numerico_w
			and	c.nr_seq_segurado	= nr_seq_segurado_w;
		end if;
		
		-- CASO O VALOR E A DATA NAO ESTEJAM OK
		if (coalesce(nr_seq_conta_w::text, '') = '') then
			select	max(c.nr_sequencia),
				max(m.nr_sequencia)
			into STRICT	nr_seq_conta_w,
				nr_seq_conta_mat_w
			from	pls_material x,
				pls_conta c,
				pls_conta_mat m,
				pls_conta_pos_estabelecido d
			where	c.nr_sequencia		= m.nr_seq_conta
			and	c.nr_sequencia		= d.nr_seq_conta
			and	m.nr_sequencia		= d.nr_seq_conta_mat
			and	x.nr_sequencia		= m.nr_seq_material
			and 	d.ie_status_faturamento <> 'A' -- diferente de aviso de cobranca
			and	d.nr_seq_lote_fat	= nr_seq_lote_fat_w
			and	c.cd_guia		= nr_nota_numerico_w
			and	x.cd_material_ops	= cd_servico_w
			and	c.nr_seq_segurado	= nr_seq_segurado_w;
		end if;
		
		-- CASO TENHA QUE PEGAR DE FORMA MAIS ABRANGETE
		if (coalesce(nr_seq_conta_w::text, '') = '') then
			select	max(c.nr_sequencia),
				max(m.nr_sequencia)
			into STRICT	nr_seq_conta_w,
				nr_seq_conta_mat_w
			from	pls_material x,
				pls_conta c,
				pls_conta_mat m,
				pls_conta_pos_estabelecido d
			where	c.nr_sequencia		= m.nr_seq_conta
			and	c.nr_sequencia		= d.nr_seq_conta
			and	m.nr_sequencia		= d.nr_seq_conta_mat
			and	x.nr_sequencia		= m.nr_seq_material
			and	d.vl_beneficiario	= vl_total_cobrado_w
			and 	d.ie_status_faturamento <> 'A' -- diferente de aviso de cobranca
			and	c.cd_guia		= nr_nota_numerico_w
			and	x.cd_material_ops	= cd_servico_w
			and	c.nr_seq_segurado	= nr_seq_segurado_w;
		end if;
		
		-- NAO SEJA O MESMO LOTE DE FATURAMENTO
		if (coalesce(nr_seq_conta_w::text, '') = '') then
			select	max(c.nr_sequencia),
				max(m.nr_sequencia)
			into STRICT	nr_seq_conta_w,
				nr_seq_conta_mat_w
			from	pls_material x,
				pls_conta c,
				pls_conta_mat m,
				pls_conta_pos_estabelecido d
			where	c.nr_sequencia		= m.nr_seq_conta
			and	c.nr_sequencia		= d.nr_seq_conta
			and	m.nr_sequencia		= d.nr_seq_conta_mat
			and	x.nr_sequencia		= m.nr_seq_material
			and 	d.ie_status_faturamento <> 'A' -- diferente de aviso de cobranca
			and	c.cd_guia		= nr_nota_numerico_w
			and	x.cd_material_ops	= cd_servico_w
			and	c.nr_seq_segurado	= nr_seq_segurado_w
			and	(d.nr_seq_lote_fat IS NOT NULL AND d.nr_seq_lote_fat::text <> '');
		end if;
	end if;
end if;

-- PACOTE
if (coalesce(nr_seq_conta_w::text, '') = '') then
	select	max(c.nr_sequencia),
		max(p.nr_sequencia)
	into STRICT	nr_seq_conta_w,
		nr_seq_conta_proc_w
	from	pls_conta c,
		pls_conta_proc p,
		pls_conta_pos_estabelecido d
	where	c.nr_sequencia		= p.nr_seq_conta
	and	c.nr_sequencia		= d.nr_seq_conta
	and	p.nr_sequencia		= d.nr_seq_conta_proc
	and	c.cd_guia		= nr_nota_numerico_w
	and 	d.ie_status_faturamento <> 'A' -- diferente de aviso de cobranca
	and	c.nr_seq_segurado	= nr_seq_segurado_w
	and	p.ie_tipo_despesa	= '4';
	
	if (coalesce(nr_seq_conta_w::text, '') = '') then
		select	max(c.nr_sequencia),
			max(p.nr_sequencia)
		into STRICT	nr_seq_conta_w,
			nr_seq_conta_proc_w
		from	pls_conta c,
			pls_conta_proc p,
			pls_conta_pos_estabelecido d
		where	c.nr_sequencia			= p.nr_seq_conta
		and	c.nr_sequencia			= d.nr_seq_conta
		and	p.nr_sequencia			= d.nr_seq_conta_proc
		and 	d.ie_status_faturamento <> 'A' -- diferente de aviso de cobranca
		and	c.dt_atendimento_referencia	= dt_atendimento_w
		and	c.nr_seq_segurado		= nr_seq_segurado_w
		and	p.ie_tipo_despesa		= '4';
	end if;	
end if;	

-- TAXA
if (coalesce(nr_seq_conta_w::text, '') = '') then
	select	max(c.nr_sequencia),
		max(p.nr_sequencia)
	into STRICT	nr_seq_conta_w,
		nr_seq_conta_proc_w
	from	pls_conta c,
		pls_conta_proc p,
		pls_conta_pos_estabelecido d
	where	c.nr_sequencia		= p.nr_seq_conta
	and	c.nr_sequencia		= d.nr_seq_conta
	and	p.nr_sequencia		= d.nr_seq_conta_proc
	and	vl_total_cobrado_w between d.vl_beneficiario - 100 and d.vl_beneficiario + 100
	and	c.cd_guia		= nr_nota_numerico_w
	and 	d.ie_status_faturamento <> 'A' -- diferente de aviso de cobranca
	and	c.nr_seq_segurado	= nr_seq_segurado_w
	and	p.ie_tipo_despesa	= '2'
	and	ie_tipo_tabela_w	= '1';
	
	if (coalesce(nr_seq_conta_w::text, '') = '') then
		select	max(c.nr_sequencia),
			max(p.nr_sequencia)
		into STRICT	nr_seq_conta_w,
			nr_seq_conta_proc_w
		from	pls_conta c,
			pls_conta_proc p,
			pls_conta_pos_estabelecido d
		where	c.nr_sequencia			= p.nr_seq_conta
		and	c.nr_sequencia			= d.nr_seq_conta
		and	p.nr_sequencia			= d.nr_seq_conta_proc
		and	vl_total_cobrado_w between d.vl_beneficiario - 100 and d.vl_beneficiario + 100
		and	c.dt_atendimento_referencia	= dt_atendimento_w
		and	c.nr_seq_segurado		= nr_seq_segurado_w
		and 	d.ie_status_faturamento <> 'A' -- diferente de aviso de cobranca
		and	p.ie_tipo_despesa		= '2'
		and	ie_tipo_tabela_w		= '1';
	end if;	
end if;	

-- DIARIA
if (coalesce(nr_seq_conta_w::text, '') = '') then
	select	max(c.nr_sequencia),
		max(p.nr_sequencia)
	into STRICT	nr_seq_conta_w,
		nr_seq_conta_proc_w
	from	pls_conta c,
		pls_conta_proc p,
		pls_conta_pos_estabelecido d
	where	c.nr_sequencia		= p.nr_seq_conta
	and	c.nr_sequencia		= d.nr_seq_conta
	and	p.nr_sequencia		= d.nr_seq_conta_proc
	and	vl_total_cobrado_w between d.vl_beneficiario - 100 and d.vl_beneficiario + 100
	and	c.cd_guia		= nr_nota_numerico_w
	and	c.nr_seq_segurado	= nr_seq_segurado_w
	and 	d.ie_status_faturamento <> 'A' -- diferente de aviso de cobranca
	and	p.ie_tipo_despesa	= '3'
	and	ie_tipo_tabela_w	= '1';
	
	if (coalesce(nr_seq_conta_w::text, '') = '') then
		select	max(c.nr_sequencia),
			max(p.nr_sequencia)
		into STRICT	nr_seq_conta_w,
			nr_seq_conta_proc_w
		from	pls_conta c,
			pls_conta_proc p,
			pls_conta_pos_estabelecido d
		where	c.nr_sequencia			= p.nr_seq_conta
		and	c.nr_sequencia			= d.nr_seq_conta
		and	p.nr_sequencia			= d.nr_seq_conta_proc
		and	vl_total_cobrado_w between d.vl_beneficiario - 100 and d.vl_beneficiario + 100
		and	c.dt_atendimento_referencia	= dt_atendimento_w
		and	c.nr_seq_segurado		= nr_seq_segurado_w
		and 	d.ie_status_faturamento <> 'A' -- diferente de aviso de cobranca
		and	p.ie_tipo_despesa		= '3'
		and	ie_tipo_tabela_w		= '1';
	end if;	
end if;	

-- PTU
if (coalesce(nr_seq_conta_w::text, '') = '') or
	((coalesce(nr_seq_conta_proc_w::text, '') = '') and (coalesce(nr_seq_conta_mat_w::text, '') = '')) then
	select	max(b.nr_seq_conta)
	into STRICT	nr_seq_conta_w
	from	ptu_nota_cobranca b,
		ptu_fatura	a
	where	a.nr_sequencia		= b.nr_seq_fatura
	and	a.nr_seq_pls_fatura	= nr_seq_pls_fatura_w
	and	b.nr_nota_numerico	= nr_nota_numerico_w
	and	b.cd_usuario_plano	= cd_usuario_plano_ptu_w
	and	coalesce(a.ie_tipo_cobranca_fatura,'C') = 'C';
	
	if (nr_seq_conta_w IS NOT NULL AND nr_seq_conta_w::text <> '') then
		-- PACOTE
		select	max(p.nr_sequencia)
		into STRICT	nr_seq_conta_proc_w
		from	pls_conta c,
			pls_conta_proc p,
			pls_conta_pos_estabelecido d
		where	c.nr_sequencia		= p.nr_seq_conta
		and	c.nr_sequencia		= d.nr_seq_conta
		and	p.nr_sequencia		= d.nr_seq_conta_proc
		and	c.nr_seq_segurado	= nr_seq_segurado_w
		and 	d.ie_status_faturamento <> 'A' -- diferente de aviso de cobranca
		and	c.nr_sequencia		= nr_seq_conta_w
		and	p.ie_tipo_despesa	= '4';
		
		-- TAXAS
		if (coalesce(nr_seq_conta_proc_w::text, '') = '') then
			select	max(p.nr_sequencia)
			into STRICT	nr_seq_conta_proc_w
			from	pls_conta c,
				pls_conta_proc p,
				pls_conta_pos_estabelecido d
			where	c.nr_sequencia		= p.nr_seq_conta
			and	c.nr_sequencia		= d.nr_seq_conta
			and	p.nr_sequencia		= d.nr_seq_conta_proc
			and	c.nr_seq_segurado	= nr_seq_segurado_w
			and	c.nr_sequencia		= nr_seq_conta_w
			and 	d.ie_status_faturamento <> 'A' -- diferente de aviso de cobranca
			and	p.ie_tipo_despesa	= '2'
			and	ie_tipo_tabela_w	= '1';
		end if;
		
		-- DIARIA
		if (coalesce(nr_seq_conta_proc_w::text, '') = '') then
			select	max(p.nr_sequencia)
			into STRICT	nr_seq_conta_proc_w
			from	pls_conta c,
				pls_conta_proc p,
				pls_conta_pos_estabelecido d
			where	c.nr_sequencia		= p.nr_seq_conta
			and	c.nr_sequencia		= d.nr_seq_conta
			and	p.nr_sequencia		= d.nr_seq_conta_proc
			and	c.nr_seq_segurado	= nr_seq_segurado_w
			and 	d.ie_status_faturamento <> 'A' -- diferente de aviso de cobranca
			and	c.nr_sequencia		= nr_seq_conta_w
			and	p.ie_tipo_despesa	= '3'
			and	ie_tipo_tabela_w	= '1';
		end if;
	end if;
	
	if (coalesce(nr_seq_conta_w::text, '') = '') then
		-- PACOTE
		select	max(p.nr_sequencia),
			max(c.nr_sequencia)
		into STRICT	nr_seq_conta_proc_w,
			nr_seq_conta_w
		from	pls_conta c,
			pls_conta_proc p,
			pls_conta_pos_estabelecido d
		where	c.nr_sequencia		= p.nr_seq_conta
		and	c.nr_sequencia		= d.nr_seq_conta
		and	p.nr_sequencia		= d.nr_seq_conta_proc
		and	d.nr_seq_lote_fat	= nr_seq_lote_fat_w
		and	c.nr_seq_segurado	= nr_seq_segurado_w
		and	c.cd_guia		= nr_nota_numerico_w
		and 	d.ie_status_faturamento <> 'A' -- diferente de aviso de cobranca
		and	p.ie_tipo_despesa	= '4';
		
		-- TAXAS
		if (coalesce(nr_seq_conta_proc_w::text, '') = '') then
			select	max(p.nr_sequencia),
				max(c.nr_sequencia)
			into STRICT	nr_seq_conta_proc_w,
				nr_seq_conta_w
			from	pls_conta c,
				pls_conta_proc p,
				pls_conta_pos_estabelecido d
			where	c.nr_sequencia		= p.nr_seq_conta
			and	c.nr_sequencia		= d.nr_seq_conta
			and	p.nr_sequencia		= d.nr_seq_conta_proc
			and	d.nr_seq_lote_fat	= nr_seq_lote_fat_w
			and	c.nr_seq_segurado	= nr_seq_segurado_w
			and	c.cd_guia		= nr_nota_numerico_w
			and 	d.ie_status_faturamento <> 'A' -- diferente de aviso de cobranca
			and	p.ie_tipo_despesa	= '2'
			and	ie_tipo_tabela_w	= '1';
		end if;
		
		-- DIARIA
		if (coalesce(nr_seq_conta_proc_w::text, '') = '') then
			select	max(p.nr_sequencia),
				max(c.nr_sequencia)
			into STRICT	nr_seq_conta_proc_w,
				nr_seq_conta_w
			from	pls_conta c,
				pls_conta_proc p,
				pls_conta_pos_estabelecido d
			where	c.nr_sequencia		= p.nr_seq_conta
			and	c.nr_sequencia		= d.nr_seq_conta
			and	p.nr_sequencia		= d.nr_seq_conta_proc
			and	d.nr_seq_lote_fat	= nr_seq_lote_fat_w
			and	c.nr_seq_segurado	= nr_seq_segurado_w
			and	c.cd_guia		= nr_nota_numerico_w
			and 	d.ie_status_faturamento <> 'A' -- diferente de aviso de cobranca
			and	p.ie_tipo_despesa	= '3'
			and	ie_tipo_tabela_w	= '1';
		end if;
	end if;
end if;

-- MATERIAIS / MEDICAMENTOS
if	((coalesce(nr_seq_conta_w::text, '') = '') or
	((coalesce(nr_seq_conta_proc_w::text, '') = '') and (coalesce(nr_seq_conta_mat_w::text, '') = ''))) and (ie_tipo_tabela_w in ('2','3','5','6')) then
	select	max(c.nr_sequencia),
		max(m.nr_sequencia)
	into STRICT	nr_seq_conta_w,
		nr_seq_conta_mat_w
	from	pls_material x,
		pls_conta c,
		pls_conta_mat m,
		pls_conta_pos_estabelecido d
	where	c.nr_sequencia		= m.nr_seq_conta
	and	c.nr_sequencia		= d.nr_seq_conta
	and	m.nr_sequencia		= d.nr_seq_conta_mat
	and	x.nr_sequencia		= m.nr_seq_material
	and	d.nr_seq_lote_fat	= nr_seq_lote_fat_w
	and 	d.ie_status_faturamento <> 'A' -- diferente de aviso de cobranca
	and	c.nr_seq_segurado	= nr_seq_segurado_w
	and	d.vl_beneficiario	= vl_cobrado_w;
	
	if (coalesce(nr_seq_conta_w::text, '') = '') then
		select	max(c.nr_sequencia),
			max(m.nr_sequencia)
		into STRICT	nr_seq_conta_w,
			nr_seq_conta_mat_w
		from	pls_material x,
			pls_conta c,
			pls_conta_mat m,
			pls_conta_pos_estabelecido d
		where	c.nr_sequencia		= m.nr_seq_conta
		and	c.nr_sequencia		= d.nr_seq_conta
		and	m.nr_sequencia		= d.nr_seq_conta_mat
		and	x.nr_sequencia		= m.nr_seq_material
		and	d.nr_seq_lote_fat	= nr_seq_lote_fat_w
		and 	d.ie_status_faturamento <> 'A' -- diferente de aviso de cobranca
		and	c.nr_seq_segurado	= nr_seq_segurado_w
		and	vl_cobrado_w between d.vl_beneficiario - 0.50 and d.vl_beneficiario + 0.50;
	end if;
end if;

-- CASO O CODIGO DO USUARIO SEJA O PROBLEMA
if (coalesce(nr_seq_conta_w::text, '') = '') then
	select	max(b.nr_seq_conta),
		max(c.nr_seq_conta_proc),
		max(c.nr_seq_conta_mat),
		max(c.nr_sequencia),
		max(b.nr_sequencia)
	into STRICT	nr_seq_conta_w,
		nr_seq_conta_proc_w,
		nr_seq_conta_mat_w,
		nr_seq_nota_servico_w,
		nr_seq_nota_cobranca_w
	from	ptu_nota_servico c,
		ptu_nota_cobranca b,
		ptu_fatura	a
	where	c.nr_seq_nota_cobr	= b.nr_sequencia
	and	a.nr_sequencia		= b.nr_seq_fatura
	and	c.ie_tipo_tabela	= ie_tipo_tabela_w
	and	a.nr_seq_pls_fatura	= nr_seq_pls_fatura_w
	and	b.nr_nota_numerico	= nr_nota_numerico_w
	and	c.cd_servico		= cd_servico_w
	and (c.vl_procedimento + vl_filme + vl_custo_operacional +
		vl_adic_procedimento + vl_adic_filme + vl_adic_co) = vl_total_cobrado_w
	and	coalesce(a.ie_tipo_cobranca_fatura,'C') = 'C';
end if;

if (ie_tipo_tabela_w not in (2,3,5,6)) and (coalesce(nr_seq_conta_w::text, '') = '') then
	select	max(c.nr_sequencia),
		max(p.nr_sequencia)
	into STRICT	nr_seq_conta_w,
		nr_seq_conta_proc_w
	from	pls_conta c,
		pls_conta_proc p,
		pls_conta_pos_estabelecido d
	where	c.nr_sequencia		= p.nr_seq_conta
	and	c.nr_sequencia		= d.nr_seq_conta
	and	p.nr_sequencia		= d.nr_seq_conta_proc
	and	d.nr_seq_lote_fat	= nr_seq_lote_fat_w
	and	d.vl_beneficiario	= vl_total_cobrado_w
	and	p.dt_procedimento	= dt_atendimento_w
	and	nr_nota_numerico_w	like '%'||c.cd_guia||'%'
	and	p.cd_procedimento	= cd_servico_w
	and 	d.ie_status_faturamento <> 'A' -- diferente de aviso de cobranca
	and	c.nr_seq_segurado	= nr_seq_segurado_w;
	
	if (coalesce(nr_seq_conta_w::text, '') = '') and (ie_tipo_tabela_w = '1') then
		select	max(c.nr_sequencia),
			max(p.nr_sequencia)
		into STRICT	nr_seq_conta_w,
			nr_seq_conta_proc_w
		from	pls_conta c,
			pls_conta_proc p,
			pls_conta_pos_estabelecido d
		where	c.nr_sequencia		= p.nr_seq_conta
		and	c.nr_sequencia		= d.nr_seq_conta
		and	p.nr_sequencia		= d.nr_seq_conta_proc
		and	d.nr_seq_lote_fat	= nr_seq_lote_fat_w
		and	p.dt_procedimento	= dt_atendimento_w
		and	nr_nota_numerico_w like '%'||c.cd_guia||'%'
		and 	d.ie_status_faturamento <> 'A' -- diferente de aviso de cobranca
		and	c.nr_seq_segurado	= nr_seq_segurado_w;
		
		if (coalesce(nr_seq_conta_w::text, '') = '') then
			select	max(c.nr_sequencia),
				max(p.nr_sequencia)
			into STRICT	nr_seq_conta_w,
				nr_seq_conta_proc_w
			from	pls_conta c,
				pls_conta_proc p,
				pls_conta_pos_estabelecido d
			where	c.nr_sequencia		= p.nr_seq_conta
			and	c.nr_sequencia		= d.nr_seq_conta
			and	p.nr_sequencia		= d.nr_seq_conta_proc
			and	d.nr_seq_lote_fat	= nr_seq_lote_fat_w
			and	p.dt_procedimento	= dt_atendimento_w
			and 	d.ie_status_faturamento <> 'A' -- diferente de aviso de cobranca
			and	c.cd_guia like '%'||nr_nota_numerico_w||'%'
			and	c.nr_seq_segurado	= nr_seq_segurado_w;
		end if;
	end if;
end if;

if (coalesce(nr_seq_conta_w::text, '') = '') then
	select	max(b.nr_seq_conta),
		max(c.nr_seq_conta_proc),
		max(c.nr_seq_conta_mat),
		max(c.nr_sequencia),
		max(b.nr_sequencia)
	into STRICT	nr_seq_conta_w,
		nr_seq_conta_proc_w,
		nr_seq_conta_mat_w,
		nr_seq_nota_servico_w,
		nr_seq_nota_cobranca_w
	from	ptu_nota_servico c,
		ptu_nota_cobranca b,
		ptu_fatura	a
	where	c.nr_seq_nota_cobr	= b.nr_sequencia
	and	a.nr_sequencia		= b.nr_seq_fatura
	and	c.ie_tipo_tabela	= ie_tipo_tabela_w
	and	a.nr_seq_pls_fatura	= nr_seq_pls_fatura_w
	and	b.nr_nota_numerico	= nr_nota_numerico_w
	and	((c.nr_seq_a500 	= nr_seq_a500_w AND ie_tipo_exportacao_w = 'TXT') or (c.nr_seq_item = nr_seq_a500_w AND ie_tipo_exportacao_w = 'XML'))
	and 	((c.cd_item_unico = cd_item_unico_w) or ((coalesce(c.cd_item_unico::text, '') = '') and (coalesce(cd_item_unico_w::text, '') = '')))
	and	coalesce(a.ie_tipo_cobranca_fatura,'C') = 'C';
	
	if (coalesce(nr_seq_conta_w::text, '') = '') then
		select	max(b.nr_seq_conta),
			max(c.nr_seq_conta_proc),
			max(c.nr_seq_conta_mat),
			max(c.nr_sequencia),
			max(b.nr_sequencia)
		into STRICT	nr_seq_conta_w,
			nr_seq_conta_proc_w,
			nr_seq_conta_mat_w,
			nr_seq_nota_servico_w,
			nr_seq_nota_cobranca_w
		from	ptu_nota_servico c,
			ptu_nota_cobranca b,
			ptu_fatura	a
		where	c.nr_seq_nota_cobr	= b.nr_sequencia
		and	a.nr_sequencia		= b.nr_seq_fatura
		and	a.nr_seq_pls_fatura	= nr_seq_pls_fatura_w
		and	b.nr_nota_numerico	= nr_nota_numerico_w
		and	((c.ds_servico_aux	= ds_servico_w AND ie_tipo_exportacao_w = 'TXT') or (ie_tipo_exportacao_w = 'XML'))
		and 	((c.cd_item_unico = cd_item_unico_w) or ((coalesce(c.cd_item_unico::text, '') = '') and (coalesce(cd_item_unico_w::text, '') = '')))
		and	coalesce(c.nr_seq_a500::text, '') = ''
		and	coalesce(a.ie_tipo_cobranca_fatura,'C') = 'C';
		
		if (coalesce(nr_seq_conta_w::text, '') = '') then
			select	max(b.nr_seq_conta),
				max(c.nr_seq_conta_proc),
				max(c.nr_seq_conta_mat),
				max(c.nr_sequencia),
				max(b.nr_sequencia)
			into STRICT	nr_seq_conta_w,
				nr_seq_conta_proc_w,
				nr_seq_conta_mat_w,
				nr_seq_nota_servico_w,
				nr_seq_nota_cobranca_w
			from	ptu_nota_servico c,
				ptu_nota_cobranca b,
				ptu_fatura	a
			where	c.nr_seq_nota_cobr	= b.nr_sequencia
			and	a.nr_sequencia		= b.nr_seq_fatura
			and	a.nr_seq_pls_fatura	= nr_seq_pls_fatura_w
			and	((c.ds_servico_aux	= ds_servico_w AND ie_tipo_exportacao_w = 'TXT') or (ie_tipo_exportacao_w = 'XML'))
			and	((c.nr_seq_a500 	= nr_seq_a500_w AND ie_tipo_exportacao_w = 'TXT') or (c.nr_seq_item = nr_seq_a500_w AND ie_tipo_exportacao_w = 'XML'))
			and 	((c.cd_item_unico = cd_item_unico_w) or ((coalesce(c.cd_item_unico::text, '') = '') and (coalesce(cd_item_unico_w::text, '') = '')))
			and	coalesce(a.ie_tipo_cobranca_fatura,'C') = 'C';
		end if;
	end if;
end if;

nr_seq_conta_p		:= nr_seq_conta_w;
nr_seq_conta_proc_p 	:= nr_seq_conta_proc_w;
nr_seq_conta_mat_p 	:= nr_seq_conta_mat_w;
nr_seq_nota_servico_p 	:= nr_seq_nota_servico_w;
nr_seq_nota_cobranca_p	:= nr_seq_nota_cobranca_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ptu_reconh_itens_contest_a550 ( nr_seq_questionamento_p ptu_questionamento.nr_sequencia%type, nr_seq_conta_p INOUT pls_conta.nr_sequencia%type, nr_seq_conta_proc_p INOUT pls_conta_proc.nr_sequencia%type, nr_seq_conta_mat_p INOUT pls_conta_mat.nr_sequencia%type, nr_seq_nota_servico_p INOUT ptu_nota_servico.nr_sequencia%type, nr_seq_nota_cobranca_p INOUT ptu_nota_cobranca.nr_sequencia%type) FROM PUBLIC;

