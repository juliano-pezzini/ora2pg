-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_atualizar_cod_mat_tuss ( nr_seq_mat_p pls_material.nr_sequencia%type, cd_material_ops_p pls_material.cd_material_ops%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nm_usuario_p usuario.nm_usuario%type) AS $body$
DECLARE


/* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Finalidade:  Replicar os código TUSS quando cadastrar ou editar um material
-------------------------------------------------------------------------------------------------------------------
Locais de chamada direta:
[ ]  Objetos do dicionário [X] Tasy (Delphi/Java) [  ] Portal [  ]  Relatórios [ ] Outros:
-------------------------------------------------------------------------------------------------------------------
Pontos de atenção:

Alterações:
-------------------------------------------------------------------------------------------------------------------
-------------------------------------------------------------------------------------------------------------------
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */
cd_tuss_w			bigint;
nr_seq_tuss_mat_item_w		tuss_material_item.nr_sequencia%type;
cd_material_w			pls_material.cd_material%type;
cd_material_ops_w		pls_material.cd_material_ops%type;
cd_tiss_brasindice_w		pls_material.cd_tiss_brasindice%type;
cd_simpro_w			pls_material.cd_simpro%type;
ie_param_20_w			varchar(5);


BEGIN
if (nr_seq_mat_p IS NOT NULL AND nr_seq_mat_p::text <> '') then
	--pego o cd_material e cd_material_ops que usarei abaixo
	select	max(cd_material),
		max(cd_material_ops),
		max(cd_tiss_brasindice),
		max(cd_simpro)
	into STRICT	cd_material_w,
		cd_material_ops_w,
		cd_tiss_brasindice_w,
		cd_simpro_w
	from	pls_material
	where	nr_sequencia = nr_seq_mat_p;

	--busco o codigo tus na tuss_material_item
	select 	max(nr_sequencia)
	into STRICT	nr_seq_tuss_mat_item_w
	from 	tuss_material_item
	where 	cd_material_tuss = cd_material_ops_w;

	if (coalesce(nr_seq_tuss_mat_item_w::text, '') = '') then -- se estiver nulo é pq não encontrou na tuss_material_item entao procuros nas tabelas abaixo
		--busca o codigo tuss da brasindice
		if (cd_tiss_brasindice_w IS NOT NULL AND cd_tiss_brasindice_w::text <> '') then
			select	max(cd_tuss)
			into STRICT	cd_tuss_w
			from	brasindice_preco
			where	cd_tiss	= cd_tiss_brasindice_w;
		end if;

		if (cd_simpro_w IS NOT NULL AND cd_simpro_w::text <> '') and (coalesce(cd_tuss_w::text, '') = '') then
			select	max(cd_tuss)
			into STRICT	cd_tuss_w
			from	simpro_preco
			where	cd_simpro	= cd_simpro_w;
		end if;

		if (coalesce(cd_tuss_w::text, '') = '') then
			select 	max(obter_tuss_brasindice(a.cd_apresentacao, a.cd_laboratorio, a.cd_medicamento)) cd_tuss
			into STRICT	cd_tuss_w
			from 	material_brasindice a
			where	a.ie_situacao 	= 'A'
			and	coalesce(a.cd_convenio::text, '') = ''
			and	a.cd_material 	= cd_material_w;
		end if;

		if (cd_tuss_w = 0) then -- se o cd_tuss_w for zero é pq não tem na brasindece entao procuro na simpro
			select	max(obter_tuss_simpro_preco(a.nr_sequencia, clock_timestamp())) cd_tuss
			into STRICT	cd_tuss_w
			from	material_simpro a
			where	a.ie_situacao	= 'A'
			and	coalesce(a.cd_convenio::text, '') = ''
			and	a.cd_material 	= cd_material_w;
		end if;

		if (cd_tuss_w = 0) then -- se for zero aqui é pq nao tem na simpro entao procuro na metarial_tuss
			select	coalesce(max(a.cd_material_tuss), 0) cd_tuss
			into STRICT	cd_tuss_w
			from	material_tuss a
			where	a.ie_situacao	= 'A'
			and	coalesce(a.cd_convenio::text, '') = ''
			and	a.cd_material 	= cd_material_w;
		end if;

		if (cd_tuss_w > 0) then -- verifico se encontrou um codigo_tuss válido
			--com o código tuss_valido  pego a sequencia do tuss_material_item
			select	coalesce(max(nr_sequencia),0)
			into STRICT	nr_seq_tuss_mat_item_w
			from	tuss_material_item
			where	cd_material_tuss = cd_tuss_w;
		end if;
	end if;

	--parâmetro 20 Atualizar código TUSS conforme hospital mesmo já existindo a informação
	ie_param_20_w := Obter_Param_Usuario(1211, 20, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_param_20_w);

	--com  a sequencia atualizo a ops_material com o codigo tuss
	if (nr_seq_tuss_mat_item_w > 0) and (ie_param_20_w = 'S') then

		update 	pls_material
		set	nr_seq_tuss_mat_item	= nr_seq_tuss_mat_item_w
		where 	nr_sequencia		= nr_seq_mat_p;

	elsif (nr_seq_tuss_mat_item_w > 0) then

		update 	pls_material
		set	nr_seq_tuss_mat_item	= nr_seq_tuss_mat_item_w
		where 	nr_sequencia		= nr_seq_mat_p
		and	coalesce(nr_seq_tuss_mat_item::text, '') = '';

	end if;

end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_atualizar_cod_mat_tuss ( nr_seq_mat_p pls_material.nr_sequencia%type, cd_material_ops_p pls_material.cd_material_ops%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nm_usuario_p usuario.nm_usuario%type) FROM PUBLIC;

