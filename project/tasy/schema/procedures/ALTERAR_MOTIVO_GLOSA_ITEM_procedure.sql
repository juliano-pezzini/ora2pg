-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE alterar_motivo_glosa_item (nr_seq_lote_hist_p bigint, cd_motivo_antigo_p bigint, cd_motivo_novo_p bigint, ie_alterar_dados_p text, nm_usuario_p text, nr_seq_hist_guia_p bigint default null, ds_justificativa_p text default null, ie_descons_motivo_glosa_p text default 'N') AS $body$
DECLARE


ie_acao_glosa_w		varchar(1);
cd_setor_resp_w		integer;
cd_resposta_w		bigint;
cd_estabelecimento_w	smallint;
ie_atualiza_valores_w	varchar(1);


BEGIN
select	max(b.cd_estabelecimento)
into STRICT	cd_estabelecimento_w
from	lote_auditoria b,
	lote_audit_hist a
where	a.nr_seq_lote_audit	= b.nr_sequencia
and	a.nr_sequencia		= nr_seq_lote_hist_p;

if (ie_alterar_dados_p	= 'S') then

	select	max(a.ie_acao_glosa),
		max(a.cd_setor_resp),
		max(a.cd_resposta)
	into STRICT	ie_acao_glosa_w,
		cd_setor_resp_w,
		cd_resposta_w
	from	motivo_glosa a
	where	a.cd_motivo_glosa	= cd_motivo_novo_p;

	update	lote_audit_hist_item a
	set	a.cd_motivo_glosa	= cd_motivo_novo_p,
		a.ie_acao_glosa		= ie_acao_glosa_w,
		a.cd_setor_responsavel	= cd_setor_resp_w,
		a.cd_resposta		= cd_resposta_w,
		a.ds_observacao		= ds_justificativa_p,
		a.nm_usuario 		= nm_usuario_p,
		a.dt_atualizacao	= clock_timestamp()
	where	((ie_descons_motivo_glosa_p = 'S') or ((ie_descons_motivo_glosa_p = 'N') and (coalesce(a.cd_motivo_glosa,0) = coalesce(cd_motivo_antigo_p,0))))
	and	a.nr_sequencia		in
					(SELECT	y.nr_sequencia
					from	lote_audit_hist_item y,
						lote_audit_hist_guia x
					where	x.nr_seq_lote_hist	= nr_seq_lote_hist_p
					and	x.nr_sequencia		= y.nr_seq_guia
					and	((coalesce(nr_seq_hist_guia_p,0) = 0) or (nr_seq_hist_guia_p = x.nr_sequencia)));

else

	update	lote_audit_hist_item a
	set	a.cd_motivo_glosa	= cd_motivo_novo_p,
		a.ds_observacao		= ds_justificativa_p,
		a.nm_usuario		= nm_usuario_p,
		a.dt_atualizacao	= clock_timestamp()
	where	((ie_descons_motivo_glosa_p = 'S') or ((ie_descons_motivo_glosa_p = 'N') and (coalesce(a.cd_motivo_glosa,0) = coalesce(cd_motivo_antigo_p,0))))
	and	a.nr_sequencia		in
					(SELECT	y.nr_sequencia
					from	lote_audit_hist_item y,
						lote_audit_hist_guia x
					where	x.nr_seq_lote_hist	= nr_seq_lote_hist_p
					and	x.nr_sequencia		= y.nr_seq_guia
					and	((coalesce(nr_seq_hist_guia_p,0) = 0) or (nr_seq_hist_guia_p = x.nr_sequencia)));

end if;

ie_atualiza_valores_w := obter_param_usuario(69, 25, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_atualiza_valores_w);

if (coalesce(ie_atualiza_valores_w,'N')	= 'S') then

	CALL atualizar_valor_item_analise(	cd_estabelecimento_w,
					nm_usuario_p,
					nr_seq_lote_hist_p,
					cd_motivo_novo_p,
					nr_seq_hist_guia_p);

end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE alterar_motivo_glosa_item (nr_seq_lote_hist_p bigint, cd_motivo_antigo_p bigint, cd_motivo_novo_p bigint, ie_alterar_dados_p text, nm_usuario_p text, nr_seq_hist_guia_p bigint default null, ds_justificativa_p text default null, ie_descons_motivo_glosa_p text default 'N') FROM PUBLIC;

