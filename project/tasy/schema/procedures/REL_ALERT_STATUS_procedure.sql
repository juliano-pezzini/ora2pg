-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE rel_alert_status () AS $body$
DECLARE

   -- Local variables here
   clb_string_w text;
   nm_usuario_w  varchar(30);
   ds_string_1_w varchar(32767);
   ds_table_w    dbms_sql.Varchar2_Table;
   ds_reg_w      dbms_sql.Varchar2_Table;
   w_yes         varchar(1) := 'Y';
   w_no         varchar(1) := 'N';
   r_dados_w     w_status_smart_alert_rep%rowtype;
BEGIN
   -- Busca usuario logado
   nm_usuario_w := wheb_usuario_pck.get_nm_usuario;
   r_dados_w.ie_hr_map                 := w_no;
   r_dados_w.ie_o2_sat_rr              := w_no;
   r_dados_w.ie_hart_rate_limit        := w_no;
   r_dados_w.ie_mean_pressure_limit    := w_no;
   r_dados_w.ie_ac_hart_rate_limit     := w_no;
   r_dados_w.ie_ac_mean_pressure_limit := w_no;
   r_dados_w.ie_ac_o2_sat_rate_limit   := w_no;
   r_dados_w.ie_ac_respirat_rate_limit := w_no;
   r_dados_w.ie_ac_hart_rate_trend     := w_no;
   r_dados_w.ie_ac_mean_pressure_trend := w_no;
   r_dados_w.ie_ac_o2_sat_rr           := w_no;
   r_dados_w.ie_ac_respirat_rate_trend := w_no;
   r_dados_w.ie_ac_sepsis              := w_no;

   -- Limpa tabela W
   delete FROM w_status_smart_alert_rep where nm_usuario = nm_usuario_w;

   -- Busca informacoes do Bifrost
   clb_string_w := bifrost_ICCA.send_integration_content('Blackboard_ICU_Outbound',
                                                         '{"report":true}',
                                                         nm_usuario_w,
                                                         null,
                                                         null,
                                                         'true');

   -- Manipula String de retorno
   ds_string_1_w := substr(clb_string_w, 32767, 1);
   ds_string_1_w := replace(ds_string_1_w, 'NACK{', '');
   ds_string_1_w := replace(ds_string_1_w, '}', '');
   ds_string_1_w := replace(ds_string_1_w, '"', '');
   ds_table_w    := string_to_table_varchar(ds_string_1_w, ',');
   --
   if (ds_table_w.Count > 0) then
      for i in 1 .. ds_table_w.Count loop
         --
         ds_reg_w := string_to_table_varchar(ds_table_w(i), ':');

         r_dados_w.nm_usuario := nm_usuario_w;
         if upper(ds_reg_w(1)) = 'ENABLE_ICU_LIMIT_ALERT' then
            r_dados_w.ie_hr_map              := w_yes;
            r_dados_w.ie_o2_sat_rr           := w_yes;
            r_dados_w.ie_hart_rate_limit     := w_yes;
            r_dados_w.ie_mean_pressure_limit := w_yes;
         end if;

         if upper(ds_reg_w(1)) = 'ENABLE_ACUTE_LIMIT_ALERT' then

            r_dados_w.ie_ac_hart_rate_limit     := w_yes;
            r_dados_w.ie_ac_mean_pressure_limit := w_yes;
            r_dados_w.ie_ac_o2_sat_rate_limit   := w_yes;
            r_dados_w.ie_ac_respirat_rate_limit := w_yes;
         end if;

         if upper(ds_reg_w(1)) = 'ENABLE_ACUTE_TREND_ALERT' then

            r_dados_w.ie_ac_hart_rate_trend     := w_yes;
            r_dados_w.ie_ac_mean_pressure_trend := w_yes;
            r_dados_w.ie_ac_o2_sat_rr           := w_yes;
            r_dados_w.ie_ac_respirat_rate_trend := w_yes;
         end if;

         if upper(ds_reg_w(1)) = 'ENABLE_SEPSIS_ALERT' then
            r_dados_w.ie_ac_sepsis := w_yes;
         end if;

      end loop;
   end if;

   --
   insert into w_status_smart_alert_rep(nm_usuario,
       ie_hr_map,
       ie_o2_sat_rr,
       ie_hart_rate_limit,
       ie_mean_pressure_limit,
       ie_ac_hart_rate_limit,
       ie_ac_mean_pressure_limit,
       ie_ac_o2_sat_rate_limit,
       ie_ac_respirat_rate_limit,
       ie_ac_hart_rate_trend,
       ie_ac_mean_pressure_trend,
       ie_ac_o2_sat_rr,
       ie_ac_respirat_rate_trend,
       ie_ac_sepsis)
   values (r_dados_w.nm_usuario,
       r_dados_w.ie_hr_map,
       r_dados_w.ie_o2_sat_rr,
       r_dados_w.ie_hart_rate_limit,
       r_dados_w.ie_mean_pressure_limit,
       r_dados_w.ie_ac_hart_rate_limit,
       r_dados_w.ie_ac_mean_pressure_limit,
       r_dados_w.ie_ac_o2_sat_rate_limit,
       r_dados_w.ie_ac_respirat_rate_limit,
       r_dados_w.ie_ac_hart_rate_trend,
       r_dados_w.ie_ac_mean_pressure_trend,
       r_dados_w.ie_ac_o2_sat_rr,
       r_dados_w.ie_ac_respirat_rate_trend,
       r_dados_w.ie_ac_sepsis);
   --
   commit;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE rel_alert_status () FROM PUBLIC;

