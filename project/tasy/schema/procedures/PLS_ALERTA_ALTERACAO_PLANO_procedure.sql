-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_alerta_alteracao_plano ( nr_seq_segurado_alt_plano_p bigint, nr_seq_segurado_p bigint, nm_usuario_p text, ie_commit_p text) AS $body$
DECLARE


ie_situacao_w			pls_regra_geracao_evento.ie_situacao%type;
nr_seq_evento_mens_w		pls_regra_geracao_evento.nr_seq_evento_mens%type;
nr_sequencia_w			pls_regra_geracao_evento.nr_sequencia%type;
ie_tipo_envio_w			pls_alerta_evento_mensagem.ie_tipo_envio%type;
ds_titulo_w			pls_alerta_evento_mensagem.ds_titulo%type;
nr_seq_tipo_evento_w		pls_alerta_evento_mensagem.nr_seq_tipo_evento%type;
ie_forma_envio_w		pls_alerta_evento_destino.ie_forma_envio%type;
nr_seq_evento_dest_w		pls_alerta_evento_destino.nr_sequencia%type;
ie_tipo_pessoa_dest_w		pls_alerta_evento_destino.ie_tipo_pessoa_dest%type;
cd_estabelecimento_w		estabelecimento.cd_estabelecimento%type;
cd_plano_novo_w			pls_segurado.nr_seq_plano%type;
ds_plano_novo_w			pls_plano.ds_plano%type;
nr_seq_plano_ant_w		pls_segurado.nr_seq_plano%type;
ds_plano_ant_w			pls_plano.ds_plano%type;
cd_usuario_plano_w		varchar(20);
cd_carteirinha_antiga_w		varchar(20);

nr_seq_evento_controle_w	bigint	:= null;
nm_beneficiario_w		varchar(70);

nm_usuario_destino_definit_w	varchar(4000);
nm_usuarios_lista_w		varchar(4000);
ds_mensagem_regra_w		varchar(4000);
ds_remetente_w			varchar(255);
nr_pos_virgula_w		integer;
qt_macro_regra_w		integer;
nm_usuario_destino_w		varchar(15);
cd_pessoa_fisica_w		varchar(10);


C01 CURSOR FOR
	SELECT	nr_seq_evento_mens,
		nr_sequencia
	from	pls_regra_geracao_evento
	where	ie_situacao			= 'A'
	and	ie_evento_disparo		= 9;

C02 CURSOR FOR
	SELECT	nr_sequencia,
		ie_forma_envio,
		ie_tipo_pessoa_dest
	from	pls_alerta_evento_destino
	where	nr_seq_evento_mens	= nr_seq_evento_mens_w
	and	ie_situacao		= 'A';

C07 CURSOR FOR
	SELECT	nm_usuario_destino
	from	pls_alerta_event_dest_fixo
	where	nr_seq_alerta_event_dest	= nr_seq_evento_dest_w;

BEGIN
-- OS 991542
select 	substr(pls_obter_dados_segurado(nr_seq_segurado_p, 'N'),1,70),
	substr(pls_obter_dados_segurado(nr_seq_segurado_p,'CR'),1,20),
	substr(pls_obter_dados_segurado(nr_seq_segurado_p,'P'),1,80),
	cd_estabelecimento,
	cd_pessoa_fisica,
	nr_seq_plano,
	substr(pls_obter_dados_segurado(nr_seq_segurado_p,'CA'),1,20)
into STRICT	nm_beneficiario_w,
	cd_usuario_plano_w,
	ds_plano_novo_w,
	cd_estabelecimento_w,
	cd_pessoa_fisica_w,
	cd_plano_novo_w,
	cd_carteirinha_antiga_w
from	pls_segurado
where	nr_sequencia	= nr_seq_segurado_p;

select	nr_seq_plano_ant,
	substr(pls_obter_dados_produto(nr_seq_plano_ant,'N'),1,255)
into STRICT	nr_seq_plano_ant_w,
	ds_plano_ant_w
from	pls_segurado_alt_plano
where	nr_sequencia = nr_seq_segurado_alt_plano_p;


open C01;
	loop
	fetch C01 into
		nr_seq_evento_mens_w,
		nr_sequencia_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin
		select	ds_mensagem,
			ie_tipo_envio,
			ds_titulo,
			nr_seq_tipo_evento
		into STRICT	ds_mensagem_regra_w,
			ie_tipo_envio_w,
			ds_titulo_w,
			nr_seq_tipo_evento_w
		from	pls_alerta_evento_mensagem
		where	nr_sequencia	= nr_seq_evento_mens_w;
		exception
		when others then
			ds_mensagem_regra_w	:= null;
			ie_tipo_envio_w		:= null;
			ds_titulo_w		:= null;
			nr_seq_tipo_evento_w	:= null;
		end;

		if (ie_tipo_envio_w = 'AE') then
			open C02;
			loop
			fetch C02 into
				nr_seq_evento_dest_w,
				ie_forma_envio_w,
				ie_tipo_pessoa_dest_w;
			EXIT WHEN NOT FOUND; /* apply on C02 */
				begin

				if (ie_forma_envio_w = 'CI') and (ie_tipo_pessoa_dest_w = 'US') then
					if ( coalesce(nr_seq_evento_controle_w::text, '') = '') then

						select	nextval('pls_alerta_evento_controle_seq')
						into STRICT	nr_seq_evento_controle_w
						;

						insert into pls_alerta_evento_controle(nr_sequencia,
								dt_geracao_evento,
								ie_evento_disparo,
								nr_seq_tipo_evento,
								dt_atualizacao,
								nm_usuario,
								dt_atualizacao_nrec,
								nm_usuario_nrec,
								ds_mensagem,
								ds_titulo,
								ie_tipo_envio)
							values (nr_seq_evento_controle_w,
								clock_timestamp(),
								9,
								nr_seq_tipo_evento_w,
								clock_timestamp(),
								nm_usuario_p,
								clock_timestamp(),
								nm_usuario_p,
								ds_mensagem_regra_w,
								ds_titulo_w,
								ie_tipo_envio_w);
					end if;

					select	count(1)
					into STRICT	qt_macro_regra_w
					
					where	ds_mensagem_regra_w like '%@%';

					if (qt_macro_regra_w > 0) then
						ds_mensagem_regra_w := substr(replace_macro(ds_mensagem_regra_w, '@BENEFICIARIO', nm_beneficiario_w), 1, 4000);
						ds_mensagem_regra_w := substr(replace_macro(ds_mensagem_regra_w, '@CARTEIRA_BENEFICIARIO', cd_usuario_plano_w), 1, 4000);
						ds_mensagem_regra_w := substr(replace_macro(ds_mensagem_regra_w, '@DS_PLANO_NOVO', ds_plano_novo_w), 1, 4000);
						ds_mensagem_regra_w := substr(replace_macro(ds_mensagem_regra_w, '@CD_PLANO_NOVO', cd_plano_novo_w), 1, 4000);
						ds_mensagem_regra_w := substr(replace_macro(ds_mensagem_regra_w, '@CATEIRINHA_ANTIGA', cd_carteirinha_antiga_w), 1, 4000);
						ds_mensagem_regra_w := substr(replace_macro(ds_mensagem_regra_w, '@CD_PLANO_ANTERIOR', nr_seq_plano_ant_w), 1, 4000);
						ds_mensagem_regra_w := substr(replace_macro(ds_mensagem_regra_w, '@DS_PLANO_ANTERIOR', ds_plano_ant_w), 1, 4000);
					end if;

					open C07;
					loop
					fetch C07 into
						nm_usuario_destino_definit_w;
					EXIT WHEN NOT FOUND; /* apply on C07 */
						begin
						if (ds_mensagem_regra_w IS NOT NULL AND ds_mensagem_regra_w::text <> '') then
							CALL gerar_comunic_padrao(	clock_timestamp(),
										ds_titulo_w,
										ds_mensagem_regra_w,
										nm_usuario_p,
										'N',
										nm_usuario_destino_definit_w,
										'N',
										null,
										null,
										cd_estabelecimento_w,
										null,
										clock_timestamp(),
										null,
										null);
						end if;

						nm_usuarios_lista_w	:= nm_usuario_destino_definit_w || ',';

						while(nm_usuarios_lista_w IS NOT NULL AND nm_usuarios_lista_w::text <> '') loop
							begin
							nr_pos_virgula_w	:= position(',' in nm_usuarios_lista_w);
							if (nr_pos_virgula_w > 0) then
								nm_usuario_destino_w	:= substr(nm_usuarios_lista_w,1,nr_pos_virgula_w-1);
								nm_usuarios_lista_w	:= substr(nm_usuarios_lista_w,nr_pos_virgula_w+1,length(nm_usuarios_lista_w));

								if (nm_usuario_destino_w IS NOT NULL AND nm_usuario_destino_w::text <> '') and (ds_mensagem_regra_w IS NOT NULL AND ds_mensagem_regra_w::text <> '') and (coalesce(nr_seq_evento_controle_w, 0) > 0) then
									CALL pls_gerar_destino_evento(nr_seq_evento_controle_w,
												'E',
												ie_forma_envio_w,
												nm_usuario_p,
												null,
												nm_usuario_destino_w,
												ds_mensagem_regra_w,
												null,
												null);
								end if;
							end if;
							end;
						end loop;
						end;
					end loop;
					close C07;

				end if;
				end;
			end loop;
			close C02;
		end if;
	end loop;
close C01;

if (ie_commit_p = 'S') then
	commit;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_alerta_alteracao_plano ( nr_seq_segurado_alt_plano_p bigint, nr_seq_segurado_p bigint, nm_usuario_p text, ie_commit_p text) FROM PUBLIC;

