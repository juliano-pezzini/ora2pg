-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE fa_gerar_numero_receita ( cd_estabelecimento_p bigint, nm_usuario_p text, cd_perfil_p bigint, nr_seq_receita_p INOUT text, ds_mensagem_p INOUT text ) AS $body$
DECLARE

				   
nr_seq_receita_w	varchar(30);
nr_seq_regra_w		bigint;
qt_minimo_w		bigint;
qt_maximo_w		bigint;
qt_timestamp_prefix_rule_w  bigint;
ds_nr_receita_prefix_w varchar(15);
nr_receita_seq_prefix_w varchar(10);
ie_seq_restart_daily_w varchar(1);
qt_nr_receita_dia_atual_w bigint;

c01 CURSOR FOR
SELECT to_char(clock_timestamp(), a.ds_timestamp_format)
from FA_REGRA_GERACAO_RECEITA a
where a.nr_sequencia = nr_seq_regra_w;

c02 CURSOR FOR
SELECT lpad(coalesce(max(a.nr_receita_sequence),(qt_minimo_w-1)) + 1, length(qt_maximo_w), 0)
from (
  SELECT (substr(b.nr_receita, length(ds_nr_receita_prefix_w)+1))::numeric  nr_receita_sequence
  from fa_receita_farmacia b
  where b.nr_receita like ds_nr_receita_prefix_w || '%'
  and b.cd_estabelecimento = cd_estabelecimento_p
  and ((to_char(dt_atualizacao_nrec, 'dd/mm/yyyy') = to_char(clock_timestamp(), 'dd/mm/yyyy') AND ie_seq_restart_daily_w = 'S')
    OR ie_seq_restart_daily_w = 'N')
  order by b.nr_sequencia desc
) a LIMIT 1;


BEGIN

nr_seq_regra_w := fa_obter_regra_receita_atual(cd_estabelecimento_p, cd_perfil_p);

if (nr_seq_regra_w IS NOT NULL AND nr_seq_regra_w::text <> '') then

  select coalesce(a.si_seq_restart_daily,'N')
  into STRICT ie_seq_restart_daily_w
  from FA_REGRA_GERACAO_RECEITA a
  where a.nr_sequencia = nr_seq_regra_w;

  select count(a.nr_sequencia)
  into STRICT qt_timestamp_prefix_rule_w
  from FA_REGRA_GERACAO_RECEITA a
  where a.nr_sequencia = nr_seq_regra_w
  and coalesce(a.SI_USE_TIMESTAMP_PREFIX,'N') = 'S'
  and (a.ds_timestamp_format IS NOT NULL AND a.ds_timestamp_format::text <> '');

  if (qt_timestamp_prefix_rule_w > 0) then

    open c01;
    loop
    fetch c01 into
      ds_nr_receita_prefix_w;
    EXIT WHEN NOT FOUND; /* apply on c01 */

    end loop;
    close c01;

    select	max(qt_minimo),
      max(qt_maximo)
    into STRICT	qt_minimo_w,
      qt_maximo_w
    from	FA_REGRA_GERACAO_RECEITA
    where	nr_sequencia = nr_seq_regra_w;

    open c02;
    loop
    fetch c02 into
      nr_receita_seq_prefix_w;
    EXIT WHEN NOT FOUND; /* apply on c02 */

    end loop;
    close c02;

    if (nr_receita_seq_prefix_w > qt_maximo_w) then
      nr_receita_seq_prefix_w := lpad(qt_minimo_w, length(qt_maximo_w), 0);
    end if;

    nr_seq_receita_w := ds_nr_receita_prefix_w || nr_receita_seq_prefix_w;

  else

    select	max(qt_minimo),
      max(qt_maximo),
      max(nr_seq_receita_atual) + 1
    into STRICT	qt_minimo_w,
      qt_maximo_w,
      nr_seq_receita_w
    from	FA_REGRA_GERACAO_RECEITA
    where	nr_sequencia = nr_seq_regra_w;

    if (ie_seq_restart_daily_w = 'S') then

      SELECT COUNT(nr_receita)
      INTO STRICT qt_nr_receita_dia_atual_w
      FROM fa_receita_farmacia
      WHERE to_char(dt_atualizacao_nrec, 'dd/mm/yyyy') = to_char(clock_timestamp(), 'dd/mm/yyyy')
      AND cd_estabelecimento = cd_estabelecimento_p;

      if (qt_nr_receita_dia_atual_w = 0) then

        nr_seq_receita_w := qt_minimo_w;

      end if;

    end if;

    if (nr_seq_receita_w < qt_minimo_w) then
      nr_seq_receita_w := qt_minimo_w;
    elsif (nr_seq_receita_w > qt_maximo_w) then
      ds_mensagem_p 	 := OBTER_DESC_EXPRESSAO(728994);			-- 728994: 'A numeracao de receita definida na regra chegou ao fim. Favor verificar'
    end if;

    if ( coalesce(ds_mensagem_p::text, '') = '') then
      update 	FA_REGRA_GERACAO_RECEITA
      set	nr_seq_receita_atual = nr_seq_receita_w
      where 	nr_sequencia = nr_seq_regra_w;
    end if;
  end if;
	
end if;

nr_seq_receita_p := nr_seq_receita_w;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE fa_gerar_numero_receita ( cd_estabelecimento_p bigint, nm_usuario_p text, cd_perfil_p bigint, nr_seq_receita_p INOUT text, ds_mensagem_p INOUT text ) FROM PUBLIC;

