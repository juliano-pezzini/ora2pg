-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE item_devol_paciente_before ( nr_devolucao_p bigint, nr_seq_mat_atend_p bigint, cd_tipo_baixa_p bigint, cd_material_p bigint, nr_seq_justificativa_p bigint, nr_prescricao_p bigint, nr_sequencia_prescricao_p bigint, qt_material_p bigint, nr_seq_lote_p bigint, cd_pessoa_devolucao_p text, cd_pessoa_logada_p text, ie_geracao_p text, nm_usuario_p text, nr_seq_lote_fornec_p bigint default null, ie_erro_p INOUT text DEFAULT NULL) AS $body$
DECLARE

			
cd_estabelecimento_w			estabelecimento.cd_estabelecimento%type;
ds_retorno_w					varchar(2000);
ie_obriga_barras_ww				varchar(1);
ie_retorno_consiste_item_w		varchar(1);
qt_registro_w					bigint := 0;
ds_observacao_w					varchar(255);
dt_anted_min_w					timestamp;

ie_consistir_item_auditado_w	varchar(1);
ie_obriga_barras_w				varchar(1);
ie_data_w						varchar(1);
ie_tipo_justificativa_w			varchar(1);
ie_consiste_item_adm_w			varchar(1);
ie_consiste_pessoa_devol_w		varchar(1);
qt_minutos_w					bigint;
nr_seq_lote_w					ap_lote.nr_sequencia%type;


BEGIN

cd_estabelecimento_w	:= wheb_usuario_pck.get_cd_estabelecimento;

ie_consistir_item_auditado_w	:= coalesce(obter_valor_param_usuario(42, 25, Obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w), 'N');
ie_obriga_barras_w		:= coalesce(obter_valor_param_usuario(42, 52, Obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w), 'N');
ie_data_w			:= coalesce(obter_valor_param_usuario(42, 107, Obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w), 'A');
qt_minutos_w		:= coalesce(obter_valor_param_usuario(42, 72, Obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w), 0);
ie_tipo_justificativa_w	:= coalesce(obter_valor_param_usuario(42, 95, Obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w), 'N');
ie_consiste_item_adm_w	:= coalesce(obter_valor_param_usuario(42, 128, Obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w), 'S');
ie_consiste_pessoa_devol_w	:= coalesce(obter_valor_param_usuario(42, 63, Obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w), 'S');
ie_erro_p := 'N';

if (ie_consiste_pessoa_devol_w = 'N') and (cd_pessoa_logada_p <> cd_pessoa_devolucao_p) then
	CALL gerar_w_item_devolucao_pac(nr_devolucao_p, cd_material_p, 'S', wheb_mensagem_pck.get_texto(163669), wheb_mensagem_pck.get_texto(1046161, 'NR_PARAMETRO='||'63'), null, nm_usuario_p);
	ie_erro_p := 'S';
end if;

if (ie_consistir_item_auditado_w = 'S') then
	ds_retorno_w := consistir_item_auditado(nr_devolucao_p, cd_tipo_baixa_p, nm_usuario_p, 0, ds_retorno_w);
	
	if (ds_retorno_w IS NOT NULL AND ds_retorno_w::text <> '') then
		CALL gerar_w_item_devolucao_pac(nr_devolucao_p, cd_material_p, 'S', substr(ds_retorno_w,1,250), wheb_mensagem_pck.get_texto(1046161, 'NR_PARAMETRO='||'25'), 'A', nm_usuario_p);
		ie_erro_p := 'S';
	end if;
end if;

if (ie_obriga_barras_w = 'D') then
	ie_obriga_barras_ww := obter_se_leitura_barras(cd_estabelecimento_w, cd_material_p, 42);
	
	if (ie_obriga_barras_ww in ('S', 'L')) and (ie_geracao_p <> 'B') then
		CALL gerar_w_item_devolucao_pac(nr_devolucao_p, cd_material_p, 'S', wheb_mensagem_pck.get_texto(163692), wheb_mensagem_pck.get_texto(1046163), null, nm_usuario_p);
		ie_erro_p := 'S';
	end if;
end if;

if (qt_minutos_w > 0) then

	if (ie_data_w = 'E') then
		
		select	count(*)
		into STRICT	qt_registro_w
		from	material_atend_paciente
		where	nr_sequencia = nr_seq_mat_atend_p
		and		(nr_seq_lote_ap IS NOT NULL AND nr_seq_lote_ap::text <> '');	
	end if;
	
	if (qt_registro_w = 0) then
		select (coalesce(max(dt_atendimento), clock_timestamp()) + qt_minutos_w /1440)
		into STRICT	dt_anted_min_w
		from	material_atend_paciente
		where	nr_sequencia = nr_seq_mat_atend_p;
		
		if (dt_anted_min_w < clock_timestamp()) then
			CALL gerar_w_item_devolucao_pac(nr_devolucao_p, cd_material_p, 'S', wheb_mensagem_pck.get_texto(163751), wheb_mensagem_pck.get_texto(1046161, 'NR_PARAMETRO='||'72'), null, nm_usuario_p);
			ie_erro_p := 'S';
		end if;
	else
		select (coalesce(max(b.dt_entrega_setor),clock_timestamp()) + qt_minutos_w /1440)
		into STRICT	dt_anted_min_w
		from	ap_lote b,
				material_atend_paciente a
		where	a.nr_seq_lote_ap = b.nr_sequencia
		and		a.nr_sequencia = nr_seq_mat_atend_p;
		
		if (dt_anted_min_w < clock_timestamp()) then
			CALL gerar_w_item_devolucao_pac(nr_devolucao_p, cd_material_p, 'S', wheb_mensagem_pck.get_texto(163751), wheb_mensagem_pck.get_texto(1046161, 'NR_PARAMETRO='||'72'), null, nm_usuario_p);
			ie_erro_p := 'S';
		end if;	
	end if;

end if;

if (ie_tipo_justificativa_w = 'S') and (coalesce(nr_seq_justificativa_p::text, '') = '') and (ie_geracao_p <> 'B') then
	CALL gerar_w_item_devolucao_pac(nr_devolucao_p, cd_material_p, 'S', wheb_mensagem_pck.get_texto(315409), wheb_mensagem_pck.get_texto(1046161, 'NR_PARAMETRO='||'95'), null, nm_usuario_p);
	ie_erro_p := 'S';
end if;

if (ie_consiste_item_adm_w <> 'S') then
	if (nr_seq_lote_p IS NOT NULL AND nr_seq_lote_p::text <> '') then
		nr_seq_lote_w := nr_seq_lote_p;
	else
		select	max(nr_seq_lote_ap)
		into STRICT	nr_seq_lote_w
		from	material_atend_paciente
		where	nr_sequencia = nr_seq_mat_atend_p;
	end if;

	ie_retorno_consiste_item_w := consiste_dev_item_adm(nr_prescricao_p, nr_sequencia_prescricao_p, qt_material_p, null, nr_seq_lote_w, nr_seq_lote_fornec_p);
	if (ie_retorno_consiste_item_w = 'N') then
		CALL gerar_w_item_devolucao_pac(nr_devolucao_p, cd_material_p, 'S', wheb_mensagem_pck.get_texto(315802), wheb_mensagem_pck.get_texto(1046161, 'NR_PARAMETRO='||'128'), null, nm_usuario_p);
		ie_erro_p := 'S';
	end if;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE item_devol_paciente_before ( nr_devolucao_p bigint, nr_seq_mat_atend_p bigint, cd_tipo_baixa_p bigint, cd_material_p bigint, nr_seq_justificativa_p bigint, nr_prescricao_p bigint, nr_sequencia_prescricao_p bigint, qt_material_p bigint, nr_seq_lote_p bigint, cd_pessoa_devolucao_p text, cd_pessoa_logada_p text, ie_geracao_p text, nm_usuario_p text, nr_seq_lote_fornec_p bigint default null, ie_erro_p INOUT text DEFAULT NULL) FROM PUBLIC;

