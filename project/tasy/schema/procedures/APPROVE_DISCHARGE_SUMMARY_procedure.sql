-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE approve_discharge_summary (nr_sequencia_p bigint, nm_usuario_p text) AS $body$
DECLARE

  c01 CURSOR FOR 
    SELECT nr_sequencia 
    FROM   wl_worklist 
    WHERE  nr_seq_disc_summary = nr_sequencia_p 
           AND coalesce(dt_final_real::text, '') = '';
  c01_w c01%ROWTYPE;


BEGIN 

    UPDATE atend_sumario_alta 
    SET    dt_approval = clock_timestamp(), 
           NM_APRROVAL_USER = nm_usuario_p, 
           dt_atualizacao = clock_timestamp(), 
           nm_usuario = nm_usuario_p 
    WHERE  nr_sequencia = nr_sequencia_p;

    OPEN c01;

    LOOP 
        FETCH c01 INTO c01_w;

        EXIT WHEN NOT FOUND; /* apply on c01 */

        BEGIN 
            UPDATE wl_worklist 
            SET    dt_final_real = clock_timestamp(), 
                   nm_usuario = nm_usuario_p, 
                   dt_atualizacao = clock_timestamp() 
            WHERE  nr_sequencia = c01_w.nr_sequencia 
                   AND coalesce(dt_final_real::text, '') = '';

            INSERT INTO wl_worklist_historico(nr_sequencia, 
                         nr_seq_worklist, 
                         ds_motivo, 
                         nm_usuario, 
                         dt_atualizacao) 
            VALUES ( nextval('wl_worklist_historico_seq'), 
                        c01_w.nr_sequencia, 
                        Obter_desc_expressao(964717), 
                        nm_usuario_p, 
                        clock_timestamp());
        END;
    END LOOP;

    CLOSE c01;

    COMMIT;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE approve_discharge_summary (nr_sequencia_p bigint, nm_usuario_p text) FROM PUBLIC;

