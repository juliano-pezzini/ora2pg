-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE baca_ajuste_lote_dctf (cd_estabelecimento_p bigint) AS $body$
DECLARE


ie_forma_tributacao_w	smallint;
ie_qualificacao_pj_w	smallint;
ie_balancete_w		varchar(1);
ie_debito_scp_w		varchar(1);
ie_estab_inativo_w	varchar(1);
ie_debito_regime_esp_w	varchar(1);
ie_dctf_ano_anterior_w	varchar(1);
cd_natureza_juridica_w	varchar(4);
ie_balanco_reducao_w	varchar(1);
nr_sequencia_w		bigint;

c01 CURSOR FOR
SELECT	nr_sequencia
from	dctf_lote
where	cd_estabelecimento	= cd_estabelecimento_p;


BEGIN

select	a.ie_forma_tributacao,
	a.ie_qualificacao_pj,
	a.ie_balancete,
	a.ie_debito_scp,
	a.ie_estab_inativo,
	a.ie_debito_regime_esp,
	a.ie_dctf_ano_anterior,
	a.cd_natureza_juridica,
	a.ie_balanco_reducao
into STRICT	ie_forma_tributacao_w,
	ie_qualificacao_pj_w,
	ie_balancete_w,
	ie_debito_scp_w,
	ie_estab_inativo_w,
	ie_debito_regime_esp_w,
	ie_dctf_ano_anterior_w,
	cd_natureza_juridica_w,
	ie_balanco_reducao_w
from	estab_dctf a
where	a.cd_estabelecimento	= cd_estabelecimento_p
and	a.dt_inicio_vigencia	= (	SELECT	max(x.dt_inicio_vigencia)
					from	estab_dctf x
					where	x.cd_estabelecimento	= a.cd_estabelecimento
					and	trunc(x.dt_inicio_vigencia,'dd') <= trunc(clock_timestamp(),'dd'));

open c01;
loop
fetch c01 into
	nr_sequencia_w;
EXIT WHEN NOT FOUND; /* apply on c01 */

	update	dctf_lote
	set	ie_forma_tributacao	= ie_forma_tributacao_w,
		ie_qualificacao_pj	= ie_qualificacao_pj_w,
		ie_balancete		= ie_balancete_w,
		ie_debito_scp		= ie_debito_scp_w,
		ie_estab_inativo	= ie_estab_inativo_w,
		ie_debito_regime_esp	= ie_debito_regime_esp_w,
		ie_dctf_ano_anterior	= ie_dctf_ano_anterior_w,
		cd_natureza_juridica	= cd_natureza_juridica_w,
		ie_balanco_reducao	= ie_balanco_reducao_w
	where	nr_sequencia		= nr_sequencia_w;

end loop;
close c01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE baca_ajuste_lote_dctf (cd_estabelecimento_p bigint) FROM PUBLIC;

