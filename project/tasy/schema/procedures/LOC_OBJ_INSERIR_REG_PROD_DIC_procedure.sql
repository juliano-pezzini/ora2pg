-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE loc_obj_inserir_reg_prod_dic ( nm_usuario_p text, cd_funcao_p bigint, nr_seq_product_requirement_p bigint, nr_seq_reg_funcao_pr_p bigint ) AS $body$
DECLARE


nr_seq_pd_w		reg_product_dic.nr_sequencia%type;

c_loc_obj CURSOR FOR
SELECT	coalesce(nr_seq_obj, nr_seq_dic_obj, nr_seq_evt, nr_seq_dic_dados) nr_sequencia,
		nr_seq_obj,
		nr_seq_dic_obj,
		nr_seq_evt,
		nr_seq_dic_dados
from	w_localizador_objetos
where	cd_funcao = cd_funcao_p
and		nm_usuario = nm_usuario_p
and		ie_marcado = 'S';

BEGIN

    for r_c_loc_obj in c_loc_obj loop

		select	max(nr_sequencia)
		into STRICT	nr_seq_pd_w
		from	reg_product_dic
		where	nr_seq_product_requirement = nr_seq_product_requirement_p
		and		nr_seq_objeto = r_c_loc_obj.nr_sequencia
		and		nr_seq_reg_funcao_pr = nr_seq_reg_funcao_pr_p
		and		ie_tipo_objeto = (	case
										when (r_c_loc_obj.nr_seq_obj IS NOT NULL AND r_c_loc_obj.nr_seq_obj::text <> '') then 'S' --Schematics
										when (r_c_loc_obj.nr_seq_dic_obj IS NOT NULL AND r_c_loc_obj.nr_seq_dic_obj::text <> '') then 'O' --Dic_Objetos
										when (r_c_loc_obj.nr_seq_evt IS NOT NULL AND r_c_loc_obj.nr_seq_evt::text <> '') then 'E' -- Evento
										when (r_c_loc_obj.nr_seq_dic_dados IS NOT NULL AND r_c_loc_obj.nr_seq_dic_dados::text <> '') then 'D' -- Dic_dados
									end
								);

		if (coalesce(nr_seq_pd_w::text, '') = '') then

			insert into reg_product_dic(
				nr_sequencia,
				nr_seq_product_requirement,
				nr_seq_reg_funcao_pr,
				nr_seq_objeto,
				ie_tipo_objeto,
				nm_usuario,
				dt_atualizacao )
			values (
				nextval('reg_product_dic_seq'),
				nr_seq_product_requirement_p,
				nr_seq_reg_funcao_pr_p,
				r_c_loc_obj.nr_sequencia,
				(	case
						when (r_c_loc_obj.nr_seq_obj IS NOT NULL AND r_c_loc_obj.nr_seq_obj::text <> '') then 'S' --Schematics
						when (r_c_loc_obj.nr_seq_dic_obj IS NOT NULL AND r_c_loc_obj.nr_seq_dic_obj::text <> '') then 'O' --Dic_Objetos
						when (r_c_loc_obj.nr_seq_evt IS NOT NULL AND r_c_loc_obj.nr_seq_evt::text <> '') then 'E' -- Evento
						when (r_c_loc_obj.nr_seq_dic_dados IS NOT NULL AND r_c_loc_obj.nr_seq_dic_dados::text <> '') then 'D' -- Dic_dados
					end
				),
				nm_usuario_p,
				clock_timestamp() );

		end if;
    end loop;

    /* Reseting all checks */

	update	w_localizador_objetos
    set		ie_marcado = 'N'
    where	cd_funcao = cd_funcao_p
	and		nm_usuario = nm_usuario_p;

	commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE loc_obj_inserir_reg_prod_dic ( nm_usuario_p text, cd_funcao_p bigint, nr_seq_product_requirement_p bigint, nr_seq_reg_funcao_pr_p bigint ) FROM PUBLIC;

