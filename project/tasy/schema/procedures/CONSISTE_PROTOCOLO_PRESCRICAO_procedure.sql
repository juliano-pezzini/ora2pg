-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE consiste_protocolo_prescricao ( cd_estabelecimento_p bigint, cd_protocolo_p bigint, nr_sequencia_p bigint, ie_consiste_medic_p text) AS $body$
DECLARE



ie_situacao_mat_w		varchar(1);
ie_padronizado_w		varchar(1);
cd_unidade_medida_w	varchar(30);
ie_situacao_unid_med_w	varchar(1);
ds_material_w		varchar(255);
cd_material_w		integer;
ds_inconsitencia_W	varchar(2000) := '';
VarPadronizado_w		varchar(15);

C01 CURSOR FOR
	SELECT	coalesce(b.ie_situacao,'A'),
		coalesce(substr(obter_se_material_padronizado(cd_estabelecimento_p,b.cd_material),1,1),'S'),
		a.cd_unidade_medida,
		coalesce(c.ie_situacao,'A'),
		b.ds_material,
		b.cd_material
	FROM material b, unidade_medida c
LEFT OUTER JOIN protocolo_medic_material a ON (c.cd_unidade_medida = a.cd_unidade_medida)
WHERE a.cd_material	= b.cd_material and a.cd_protocolo	= cd_protocolo_p and a.nr_sequencia	= nr_sequencia_p and a.ie_agrupador not in (20,21)  order by b.cd_material;


BEGIN
/* Virgílio 24/12/2009 Não lê valor do usuário/perfil "hohoho"
select	nvl(vl_parametro, vl_parametro_padrao)
into	VarPadronizado_w
from	funcao_parametro
where	cd_funcao = 924
and	nr_sequencia = 18;
*/
OPEN C01;
LOOP
FETCH C01 into
	ie_situacao_mat_w,
	ie_padronizado_w,
	cd_unidade_medida_w,
	ie_situacao_unid_med_w,
	ds_material_w,
	cd_material_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	if (ie_situacao_mat_w = 'I') then
		ds_inconsitencia_W	:= substr(ds_inconsitencia_W ||
										-- Mat/Med inativo: #@CD_MATERIAL#@ #@DS_MATERIAL#@
										obter_texto_dic_objeto( 261354 , Wheb_usuario_pck.get_nr_seq_idioma, 'CD_MATERIAL=' ||cd_material_w|| ';DS_MATERIAL=' ||ds_material_w )
											|| chr(13) || chr(10),1,2000);
	end if;
	if (ie_padronizado_w = 'N') and (ie_consiste_medic_p = 'O') then
		ds_inconsitencia_W	:= substr(ds_inconsitencia_W ||
										-- Mat/Med não padronizado: #@CD_MATERIAL#@ #@DS_MATERIAL#@
										obter_texto_dic_objeto( 261356 , Wheb_usuario_pck.get_nr_seq_idioma, 'CD_MATERIAL=' ||cd_material_w|| ';DS_MATERIAL=' ||ds_material_w )
											|| chr(13) || chr(10),1,2000);
	end if;
	if (ie_situacao_unid_med_w = 'I') then
		ds_inconsitencia_W	:= substr(ds_inconsitencia_W ||
										-- Mat/Med com unidade medida inativa: #@CD_MATERIAL#@ #@DS_MATERIAL#@
										obter_texto_dic_objeto( 261357 , Wheb_usuario_pck.get_nr_seq_idioma, 'CD_MATERIAL=' ||cd_material_w|| ';DS_MATERIAL=' ||ds_material_w )
											|| chr(13) || chr(10),1,2000);
	end if;
END LOOP;
Close C01;

if (ds_inconsitencia_W IS NOT NULL AND ds_inconsitencia_W::text <> '') then
	-- #@DS_INCONSISTENCIA#@ Confira o protocolo!!!
	CALL Wheb_mensagem_pck.exibir_mensagem_abort( 261359 , 'DS_INCONSISTENCIA='||ds_inconsitencia_W);
end if;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE consiste_protocolo_prescricao ( cd_estabelecimento_p bigint, cd_protocolo_p bigint, nr_sequencia_p bigint, ie_consiste_medic_p text) FROM PUBLIC;

