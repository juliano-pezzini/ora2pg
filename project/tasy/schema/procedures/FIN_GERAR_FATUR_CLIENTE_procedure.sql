-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE fin_gerar_fatur_cliente ( cd_estabelecimento_p bigint, dt_referencia_p timestamp, nr_seq_cliente_p bigint, ie_rat_p text, ie_regra_p text, ie_proc_espec_p text, cd_Setor_atendimento_p bigint, nm_usuario_p text, ie_calcular_nf_p text default 'N', ie_faturar_rat_projeto_p text default 'N') AS $body$
DECLARE


nr_seq_regra_w			bigint;
nr_seq_regra_item_w		bigint;
vl_cobrar_w			double precision;
cd_procedimento_w		bigint;
ie_origem_proced_w		bigint;
cd_cgc_estab_w			varchar(14);
cd_cnpj_w			varchar(14);
nr_seq_nota_w			bigint;
cd_operacao_w			smallint;
nr_sequencia_nf_w		bigint;
cd_serie_nf_w			nota_fiscal.cd_serie_nf%type;
nr_item_nf_w			bigint;
vl_total_nota_w			double precision;
cd_condicao_pagamento_w		bigint;
cd_natureza_operacao_w		bigint;
nr_seq_cli_nf_w			bigint;
dt_referencia_w			timestamp;
ds_complemento_w		varchar(2000);
cd_conta_contabil_w		varchar(20);
cd_centro_custo_w		bigint;
ie_rat_w			varchar(01);
nr_rat_w			varchar(255);
ds_compl_nf_w			varchar(255);
ie_atualizar_w			varchar(01);
cd_cnpj_pessoa_nf_w		varchar(14);
nr_seq_cliente_nf_w		bigint;
nr_cliente_w			bigint;
ie_gerar_ordem_titulo_w		varchar(1);
nr_seq_proj_w			proj_rat_v.nr_seq_proj%type;
nr_rat_projeto_w		varchar(4000);	
ds_rat_w			varchar(4000);	
ds_virgula_w			varchar(10) := '';
ds_rat_projeto_w		varchar(4000);


C01 CURSOR FOR
	SELECT	nr_sequencia,
		cd_operacao_nf,
		cd_condicao_pagamento,
		cd_natureza_operacao,
		ie_atualizar,
		cd_cnpj_pessoa_nf,
		coalesce(nr_seq_cliente_nf,0)
	from	Com_Cliente_Regra_Valor a
	where	cd_estabelecimento	= cd_estabelecimento_p
	and	nr_seq_cliente		= nr_seq_cliente_p
	and	dt_referencia_p		>= dt_inicio_vigencia
	and	dt_referencia_p		<= coalesce(dt_fim_vigencia, dt_referencia_p)
	and	ie_situacao		= 'A'
	and (not exists (	SELECT	1
				from	com_cliente_nf b
				where	b.nr_seq_cliente	= nr_seq_cliente_p
				and	b.nr_seq_regra		= a.nr_sequencia
				and	b.dt_referencia		= dt_referencia_w
				and	coalesce(ie_proc_espec_p,'N') = 'N') or (coalesce(ie_faturar_rat_projeto_p,'N') = 'S') );
	
C02 CURSOR FOR
	SELECT	vl_cobrar,
		cd_procedimento,
		ie_origem_proced,
		cd_conta_contabil,
		cd_centro_custo,
		ie_rat,
		ds_compl_nf,
		nr_sequencia
	from	Com_cli_regra_valor_item
	where	nr_seq_regra		= nr_seq_regra_w
	and	(cd_procedimento IS NOT NULL AND cd_procedimento::text <> '')
	and	(ie_origem_proced IS NOT NULL AND ie_origem_proced::text <> '')
	and	ie_situacao		= 'A'
	and	((ie_regra_p	= 'S' AND ie_rat = 'N') or (ie_rat = 'S' AND ie_rat_p = 'S'));

	
/*Cursor para buscar os projetos  para esse cliente que estao com status Aprovado pelo Financeiro*/
	
C03 CURSOR FOR
	SELECT	a.nr_seq_proj
	from	proj_rat_v a
	where	a.nr_seq_cliente = nr_seq_cliente_p
	and	a.ie_status_rat  = 'AF'
	and	trunc(a.dt_aprov_fin,'month') = trunc(dt_referencia_p,'month')
	group by a.nr_seq_proj
	order by a.nr_seq_proj;
	
C04 CURSOR FOR
	SELECT	sum(vl_cobrar) vl_cobrar,
		cd_procedimento,
		ie_origem_proced,
		cd_conta_contabil,
		cd_centro_custo,
		max(ie_rat) ie_rat
	from	Com_cli_regra_valor_item
	where	nr_seq_regra		= nr_seq_regra_w
	and	(cd_procedimento IS NOT NULL AND cd_procedimento::text <> '')
	and	(ie_origem_proced IS NOT NULL AND ie_origem_proced::text <> '')
	and	ie_situacao		= 'A'
	and	((ie_regra_p	= 'S' AND ie_rat = 'N') or (ie_rat = 'S' AND ie_rat_p = 'S'))	
	group by	cd_procedimento,
			cd_conta_contabil,
			cd_centro_custo,
			ie_origem_proced;

C05 CURSOR FOR
	SELECT	ds_compl_nf,
		nr_sequencia
	from	Com_cli_regra_valor_item
	where	nr_seq_regra		= nr_seq_regra_w
	and	cd_procedimento		= cd_procedimento_w
	and	ie_origem_proced	= ie_origem_proced_w
	and 	cd_conta_contabil	= cd_conta_contabil_w
	and 	cd_centro_custo		= cd_centro_custo_w
	and	ie_situacao		= 'A'
	and	((ie_regra_p	= 'S' AND ie_rat = 'N') or (ie_rat = 'S' AND ie_rat_p = 'S'));		
	
C06 CURSOR FOR
	SELECT	a.nr_sequencia,
		substr(b.ds_titulo,1,80) ds_rat_projeto			
	from	proj_rat a,
		proj_projeto b
	where	a.nr_seq_proj 		= b.nr_sequencia
	and	a.nr_seq_nf		= nr_seq_nota_w
	and 	(dt_aprov_fin IS NOT NULL AND dt_aprov_fin::text <> '');	
	

BEGIN

ie_gerar_ordem_titulo_w := obter_param_usuario(1005, 8, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_gerar_ordem_titulo_w);

dt_referencia_w		:= trunc(dt_referencia_p, 'month');

select	cd_cgc
into STRICT	cd_cgc_estab_w
from	estabelecimento
where	cd_estabelecimento = cd_estabelecimento_p;

select	max(a.cd_serie_nf)
into STRICT	cd_serie_nf_w
from	serie_nota_fiscal b,
	com_parametro a
where	a.cd_estabelecimento	= cd_estabelecimento_p
and	b.cd_estabelecimento	= cd_estabelecimento_p
and	a.cd_serie_nf		= b.cd_serie_nf
and	ie_numero_nota	= 'S';
if (coalesce(cd_serie_nf_w::text, '') = '') then
	CALL Wheb_mensagem_pck.exibir_mensagem_abort(227611);
	--A serie nao foi informada no parametro geral dos controles internos ou a numeracao nao e gerada pelo sistema
end if;

if ( coalesce(ie_faturar_rat_projeto_p,'N') = 'N' ) then /*OS 1336291 - Aqui n teve alteracoes, faz o que sempre fez. A nova geracao, NF por projeto, esta no else desse IF.*/
OPEN C01;
LOOP
FETCH C01 into
	nr_seq_regra_w,
	cd_operacao_w,
	cd_condicao_pagamento_w,
	cd_natureza_operacao_w,
	ie_atualizar_w,
	cd_cnpj_pessoa_nf_w,
	nr_seq_cliente_nf_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	begin

	if (nr_seq_cliente_nf_w > 0) then
		begin
		select	coalesce(cd_cnpj,cd_cnpj_pessoa_nf_w)
		into STRICT	cd_cnpj_w
		from	com_cliente
		where	nr_sequencia		= nr_seq_cliente_nf_w;
		nr_cliente_w := nr_seq_cliente_nf_w;
		end;
	else	
		begin
		select	coalesce(cd_cnpj,cd_cnpj_pessoa_nf_w)
		into STRICT	cd_cnpj_w
		from	com_cliente
		where	nr_sequencia		= nr_seq_cliente_p;
		nr_cliente_w := nr_seq_cliente_p;
		end;
	end if;

	nr_sequencia_nf_w		:= 1;
	
	OPEN C04;
	LOOP
	FETCH C04 into
		vl_cobrar_w,
		cd_procedimento_w,
		ie_origem_proced_w,
		cd_conta_contabil_w,
		cd_centro_custo_w,
		ie_rat_w;
	EXIT WHEN NOT FOUND; /* apply on C04 */
		begin
		
		select	nextval('nota_fiscal_seq')
		into STRICT	nr_seq_nota_w
		;
		
		insert into nota_fiscal(
			nr_nota_fiscal,
			nr_sequencia,
			cd_estabelecimento,
			cd_cgc_emitente,
			cd_cgc,
			cd_serie_nf,
			nr_sequencia_nf,
			cd_operacao_nf,
			dt_emissao,
			dt_entrada_saida,
			ie_acao_nf,
			ie_emissao_nf,
			ie_tipo_frete,
			ie_situacao,
			vl_mercadoria,
			vl_total_nota,
			vl_frete,
			vl_despesa_acessoria,
			vl_seguro,
			vl_descontos,
			vl_ipi,
			vl_desconto_rateio,
			qt_peso_bruto,
			qt_peso_liquido,
			cd_natureza_operacao,
			cd_condicao_pagamento,
			dt_atualizacao,
			nm_usuario,
			ie_tipo_nota,
			cd_setor_digitacao,
			nr_seq_cliente)
		values ( nr_seq_nota_w,
			nr_seq_nota_w,
			cd_estabelecimento_p,
			cd_cgc_estab_w,
			cd_cnpj_w,
			cd_serie_nf_w,
			nr_sequencia_nf_w,
			cd_operacao_w,
			trunc(clock_timestamp()),
			clock_timestamp(),
			1,
			0,
			'0',
			1,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			0,
			cd_natureza_operacao_w,
			cd_condicao_pagamento_w,
			clock_timestamp(),
			nm_usuario_p,
			'SE',
			cd_setor_atendimento_p,
			nr_cliente_w);

		
		
		select (coalesce(max(nr_item_nf),0)+1)
		into STRICT	nr_item_nf_w
		from	nota_fiscal_item
		where	nr_sequencia	= nr_seq_nota_w;
		
		ds_complemento_w	:= '';
		
		open C05;
		loop
		fetch C05 into	
			ds_compl_nf_w,
			nr_seq_regra_item_w;
		EXIT WHEN NOT FOUND; /* apply on C05 */
			begin
			ds_complemento_w	:= ds_complemento_w || ' / ' || ds_compl_nf_w;
			end;
		end loop;
		close C05;
		
		ds_complemento_w	:= Replace_macro(ds_complemento_w,'@MES@', to_char(dt_referencia_w,'mm/yyyy'));
		ds_complemento_w	:= Replace_macro(ds_complemento_w,'@MESANTERIOR@', to_char( add_months(dt_referencia_w,-1), 'mm/yyyy'));
		
		if (ie_rat_w = 'S') then
			SELECT * FROM proj_faturar_Rat(
			nr_seq_cliente_p, nr_seq_nota_w, nm_usuario_p, -1, nr_rat_w, vl_cobrar_w) INTO STRICT nr_rat_w, vl_cobrar_w;
			
			ds_complemento_w	:= 'Valor referente aos RAT: ' || nr_rat_w;
		end if;		

		if (coalesce(vl_cobrar_w,0) > 0) then
		
			insert into nota_fiscal_item(
				cd_cgc_emitente,
				cd_serie_nf,
				nr_nota_fiscal,
				nr_sequencia_nf,
				nr_item_nf,
				nr_sequencia,
				vl_desconto_rateio,
				cd_natureza_operacao,
				vl_despesa_acessoria,
				nm_usuario,
				dt_atualizacao,
				vl_liquido,
				cd_estabelecimento,
				qt_item_nf,
				vl_total_item_nf,
				vl_seguro,
				vl_unitario_item_nf,
				vl_frete,
				vl_desconto,
				cd_procedimento,
				ie_origem_proced,
				ds_complemento,
				cd_conta_contabil,
				cd_centro_custo)
			values (	
				cd_cgc_estab_w,
				cd_serie_nf_w,
				nr_seq_nota_w,
				nr_sequencia_nf_w,
				nr_item_nf_w,
				nr_seq_nota_w,
				0,
				cd_natureza_operacao_w,
				0,
				nm_usuario_p,
				clock_timestamp(),
				vl_cobrar_w,
				cd_estabelecimento_p,
				1,
				vl_cobrar_w,
				0,
				vl_cobrar_w,
				0,
				0,
				cd_procedimento_w,
				ie_origem_proced_w,
				substr(ds_complemento_w,1,255),
				cd_conta_contabil_w,
				cd_centro_custo_w);
				
			open C05;
			loop
			fetch C05 into	
				ds_compl_nf_w,
				nr_seq_regra_item_w;
			EXIT WHEN NOT FOUND; /* apply on C05 */
				begin
				select	nextval('com_cliente_nf_seq')
				into STRICT	nr_seq_cli_nf_w
				;
				
				insert into Com_cliente_nf(
					nr_sequencia,	nr_seq_cliente, dt_atualizacao,
					nm_usuario, nr_seq_nf, dt_referencia, nr_seq_regra,
					nr_seq_regra_item, dt_atualizacao_nrec,
					nm_usuario_nrec, nr_seq_item_nf)
				values (
					nr_seq_cli_nf_w, nr_seq_cliente_p, clock_timestamp(),
					nm_usuario_p, nr_seq_nota_w, dt_referencia_w, nr_seq_regra_w,
					nr_seq_regra_item_w, clock_timestamp(), nm_usuario_p, nr_item_nf_w);
					
				CALL fin_gerar_rep_nf_cli(nr_seq_nota_w, nr_item_nf_w, nr_seq_regra_item_w, vl_cobrar_w, nm_usuario_p);
				
				end;
			end loop;
			close C05;	
			
		end if;
		
		if (ie_gerar_ordem_titulo_w = 'N') then	
			CALL fin_gerar_oc_repasse(nr_seq_nota_w,	nm_usuario_p);
		end if;
		
		select	coalesce(sum(vl_total_item_nf),0)
		into STRICT	vl_total_nota_w
		from	nota_fiscal_item
		where	nr_sequencia = nr_seq_nota_w;

		if (vl_total_nota_w = 0) then
			delete	FROM nota_fiscal
			where	nr_sequencia	= nr_seq_nota_w;
		else
			update	nota_fiscal
			set	vl_mercadoria	= vl_total_nota_w,
				vl_total_nota	= vl_total_nota_w
			where	nr_sequencia	= nr_seq_nota_w;
			
			update	nota_fiscal
			set	vl_mercadoria	= vl_total_nota_w,
				vl_total_nota	= vl_total_nota_w
			where	nr_sequencia	= nr_seq_nota_w;
			
			CALL Gerar_Imposto_NF(nr_seq_nota_w, nm_usuario_p,0, null);
			
			CALL Atualiza_total_nota_fiscal(nr_seq_nota_w, nm_usuario_p);
			
			CALL Gerar_vencimento_nota_fiscal(nr_seq_nota_w, nm_usuario_p);
			
			commit;
			
			/*Conforme OS 928322, nao deve mais verificar o ie_atualizar para atualizar a NF.*/

			if	(/*(ie_atualizar_w = 'S') or*/
 (ie_calcular_nf_p = 'S')) and (coalesce(ie_proc_espec_p,'N') = 'N') then
				CALL atualizar_nota_fiscal(nr_seq_nota_w, 'I', nm_usuario_p, 3);
				commit;
			end if;
		end if;
		
		end;
	END LOOP;
	CLOSE C04;
	
	end;
END LOOP;
CLOSE C01;

else
    /*Buscar projetos aprovados pelo fin para esse cliente*/

	open C03;
	loop
	fetch C03 into	
		nr_seq_proj_w;
	EXIT WHEN NOT FOUND; /* apply on C03 */
		begin
		
		/*Buscar as regras  de valor do cliente para gerar a NF, para o projeto, igual faz antes. So que precisa gerar uma NF para cada projeto*/

		OPEN C01;
		LOOP
		FETCH C01 into
			nr_seq_regra_w,
			cd_operacao_w,
			cd_condicao_pagamento_w,
			cd_natureza_operacao_w,
			ie_atualizar_w,
			cd_cnpj_pessoa_nf_w,
			nr_seq_cliente_nf_w;
		EXIT WHEN NOT FOUND; /* apply on c01 */

			begin
			select	nextval('nota_fiscal_seq')
			into STRICT	nr_seq_nota_w
			;

			if (nr_seq_cliente_nf_w > 0) then
				begin
				select	coalesce(cd_cnpj,cd_cnpj_pessoa_nf_w)
				into STRICT	cd_cnpj_w
				from	com_cliente
				where	nr_sequencia		= nr_seq_cliente_nf_w;
				nr_cliente_w := nr_seq_cliente_nf_w;
				end;
			else	
				begin
				select	coalesce(cd_cnpj,cd_cnpj_pessoa_nf_w)
				into STRICT	cd_cnpj_w
				from	com_cliente
				where	nr_sequencia		= nr_seq_cliente_p;
				nr_cliente_w := nr_seq_cliente_p;
				end;
			end if;

			nr_sequencia_nf_w		:= 1;
			insert into nota_fiscal(
				nr_nota_fiscal,
				nr_sequencia,
				cd_estabelecimento,
				cd_cgc_emitente,
				cd_cgc,
				cd_serie_nf,
				nr_sequencia_nf,
				cd_operacao_nf,
				dt_emissao,
				dt_entrada_saida,
				ie_acao_nf,
				ie_emissao_nf,
				ie_tipo_frete,
				ie_situacao,
				vl_mercadoria,
				vl_total_nota,
				vl_frete,
				vl_despesa_acessoria,
				vl_seguro,
				vl_descontos,
				vl_ipi,
				vl_desconto_rateio,
				qt_peso_bruto,
				qt_peso_liquido,
				cd_natureza_operacao,
				cd_condicao_pagamento,
				dt_atualizacao,
				nm_usuario,
				ie_tipo_nota,
				cd_setor_digitacao,
				nr_seq_cliente)
			values ( nr_seq_nota_w,
				nr_seq_nota_w,
				cd_estabelecimento_p,
				cd_cgc_estab_w,
				cd_cnpj_w,
				cd_serie_nf_w,
				nr_sequencia_nf_w,
				cd_operacao_w,
				trunc(clock_timestamp()),
				clock_timestamp(),
				1,
				0,
				'0',
				1,
				0,
				0,
				0,
				0,
				0,
				0,
				0,
				0,
				0,
				0,
				cd_natureza_operacao_w,
				cd_condicao_pagamento_w,
				clock_timestamp(),
				nm_usuario_p,
				'SE',
				cd_setor_atendimento_p,
				nr_cliente_w);
				
			OPEN C02;
			LOOP
			FETCH C02 into
				vl_cobrar_w,
				cd_procedimento_w,
				ie_origem_proced_w,
				cd_conta_contabil_w,
				cd_centro_custo_w,
				ie_rat_w,
				ds_compl_nf_w,
				nr_seq_regra_item_w;
			EXIT WHEN NOT FOUND; /* apply on c02 */
				begin
				select (coalesce(max(nr_item_nf),0)+1)
				into STRICT	nr_item_nf_w
				from	nota_fiscal_item
				where	nr_sequencia	= nr_seq_nota_w;
				ds_complemento_w	:= ds_compl_nf_w;
				ds_complemento_w	:= Replace_macro(ds_complemento_w,'@MES@', to_char(dt_referencia_w,'mm/yyyy'));
				ds_complemento_w	:= Replace_macro(ds_complemento_w,'@MESANTERIOR@', to_char( add_months(dt_referencia_w,-1), 'mm/yyyy'));
				
				if (ie_rat_w = 'S') then
					SELECT * FROM proj_faturar_Rat(
					nr_seq_cliente_p, nr_seq_nota_w, nm_usuario_p, nr_seq_proj_w, nr_rat_w, vl_cobrar_w) INTO STRICT nr_rat_w, vl_cobrar_w;
					
					/*Esse cursor existe dentro da proj_faturar_rat. Como precisamos da desc do projeto,  nao alterei ele, buscamos as informacoes por aqui mesmo.*/

					ds_rat_w := '';
					open C06;
					loop
					fetch C06 into	
						nr_rat_projeto_w,
						ds_rat_projeto_w;
					EXIT WHEN NOT FOUND; /* apply on C06 */
						begin
						ds_rat_w		:= ds_rat_w || ds_virgula_w || nr_rat_projeto_w;
						ds_virgula_w		:= ', ';
						end;
					end loop;
					close C06;
					
					ds_rat_w := substr(ds_rat_w ||' - ' || ds_rat_projeto_w,1,3999);
					ds_complemento_w	:= substr('Valor referente aos RAT: ' || ds_rat_w,1,3999);
					
				end if;		
				
				if (coalesce(vl_cobrar_w,0) > 0) then
					insert into nota_fiscal_item(
						cd_cgc_emitente,
						cd_serie_nf,
						nr_nota_fiscal,
						nr_sequencia_nf,
						nr_item_nf,
						nr_sequencia,
						vl_desconto_rateio,
						cd_natureza_operacao,
						vl_despesa_acessoria,
						nm_usuario,
						dt_atualizacao,
						vl_liquido,
						cd_estabelecimento,
						qt_item_nf,
						vl_total_item_nf,
						vl_seguro,
						vl_unitario_item_nf,
						vl_frete,
						vl_desconto,
						cd_procedimento,
						ie_origem_proced,
						ds_complemento,
						cd_conta_contabil,
						cd_centro_custo)
					values (	
						cd_cgc_estab_w,
						cd_serie_nf_w,
						nr_seq_nota_w,
						nr_sequencia_nf_w,
						nr_item_nf_w,
						nr_seq_nota_w,
						0,
						cd_natureza_operacao_w,
						0,
						nm_usuario_p,
						clock_timestamp(),
						vl_cobrar_w,
						cd_estabelecimento_p,
						1,
						vl_cobrar_w,
						0,
						vl_cobrar_w,
						0,
						0,
						cd_procedimento_w,
						ie_origem_proced_w,
						substr(ds_complemento_w,1,255),
						cd_conta_contabil_w,
						cd_centro_custo_w);
					select nextval('com_cliente_nf_seq')
					into STRICT	nr_seq_cli_nf_w
					;
					insert into Com_cliente_nf(
						nr_sequencia,	nr_seq_cliente, dt_atualizacao,
						nm_usuario, nr_seq_nf, dt_referencia, nr_seq_regra,
						nr_seq_regra_item, dt_atualizacao_nrec,
						nm_usuario_nrec, nr_seq_item_nf)
					values (
						nr_seq_cli_nf_w, nr_seq_cliente_p, clock_timestamp(),
						nm_usuario_p, nr_seq_nota_w, dt_referencia_w, nr_seq_regra_w,
						nr_seq_regra_item_w, clock_timestamp(), nm_usuario_p, nr_item_nf_w);
					CALL FIN_Gerar_Rep_NF_Cli(nr_seq_nota_w, nr_item_nf_w, nr_seq_regra_item_w, vl_cobrar_w, nm_usuario_p);
				end if;
				end;
			END LOOP;
			CLOSE C02;
			
			if (ie_gerar_ordem_titulo_w = 'N') then	
				CALL FIN_Gerar_OC_Repasse(nr_seq_nota_w,	nm_usuario_p);
			end if;
			
			select	coalesce(sum(vl_total_item_nf),0)
			into STRICT	vl_total_nota_w
			from	nota_fiscal_item
			where	nr_sequencia = nr_seq_nota_w;
			
			if (vl_total_nota_w = 0) then
				delete FROM nota_fiscal
				where	nr_sequencia	= nr_seq_nota_w;
			else
				update	nota_fiscal
				set	vl_mercadoria	= vl_total_nota_w,
					vl_total_nota	= vl_total_nota_w
				where	nr_sequencia	= nr_seq_nota_w;
				update	nota_fiscal
				set	vl_mercadoria	= vl_total_nota_w,
					vl_total_nota	= vl_total_nota_w
				where	nr_sequencia	= nr_seq_nota_w;
				CALL Gerar_Imposto_NF(nr_seq_nota_w, nm_usuario_p,0, null);
				CALL Atualiza_total_nota_fiscal(nr_seq_nota_w, nm_usuario_p);
				CALL Gerar_vencimento_nota_fiscal(nr_seq_nota_w, nm_usuario_p);
				commit;
				/*Conforme OS 928322, nao deve mais verificar o ie_atualizar para atualizar a NF.*/

				if	(/*(ie_atualizar_w = 'S') or*/
 (ie_calcular_nf_p = 'S')) and (coalesce(ie_proc_espec_p,'N') = 'N') then
					CALL Atualizar_Nota_Fiscal(nr_seq_nota_w, 'I', nm_usuario_p, 3);
					commit;
				end if;
			end if;
			end;
		END LOOP;
		CLOSE C01;	
		
		end;
	end loop;
	close C03;

end if;

commit;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE fin_gerar_fatur_cliente ( cd_estabelecimento_p bigint, dt_referencia_p timestamp, nr_seq_cliente_p bigint, ie_rat_p text, ie_regra_p text, ie_proc_espec_p text, cd_Setor_atendimento_p bigint, nm_usuario_p text, ie_calcular_nf_p text default 'N', ie_faturar_rat_projeto_p text default 'N') FROM PUBLIC;

