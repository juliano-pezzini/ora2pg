-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE hd_inserir_material_dialisador ( nr_atendimento_p bigint, cd_material_p bigint, nm_usuario_p text, qt_material_p bigint, cd_setor_atendimento_p bigint, nr_seq_lote_fornec_p bigint, nr_sequencia_p INOUT bigint, nr_seq_dialisador_p bigint) AS $body$
DECLARE

			
nr_sequencia_w		bigint;
cd_setor_atendimento_w	integer;
dt_entrada_unidade_w	timestamp;
cd_unidade_medida_w	varchar(30);
cd_convenio_w		integer;
cd_categoria_w		varchar(10);
nr_seq_atepacu_w		bigint;

cd_material_estoque_w		integer;
qt_conv_estoque_consumo_w	double precision;
cd_unidade_medida_estoque_w	varchar(30);
cd_unidade_medida_consumo_w	varchar(30);
ie_consignado_w			varchar(1);
ie_possui_saldo_w			varchar(1);
cd_estab_w			integer;
qt_estoque_w			double precision;
cd_local_estoque_w		smallint;

ie_local_estoque_w	varchar(1) := coalesce(obter_valor_param_usuario(7009, 258, Obter_perfil_Ativo, wheb_usuario_pck.get_nm_usuario, 0),'U');
ie_baixa_estoque_w	varchar(1) := coalesce(obter_valor_param_usuario(7009, 85, Obter_perfil_Ativo, wheb_usuario_pck.get_nm_usuario, 0),'N');

BEGIN

nr_seq_atepacu_w	:= OBTER_ATEPACU_PACIENTE(nr_atendimento_p, 'A');
cd_convenio_w		:= OBTER_CONVENIO_ATENDIMENTO(nr_atendimento_p);
cd_categoria_w		:= Obter_Categoria_Atendimento(nr_atendimento_p);

if (ie_baixa_estoque_w = 'S') then
	if (ie_local_estoque_w = 'U') then
		
		select	max(cd_local_estoque)
		into STRICT	cd_local_estoque_w
		from	setor_atendimento
		where	cd_setor_atendimento = cd_setor_atendimento_p;
		
	elsif (ie_local_estoque_w = 'P') then
		
		select	obter_local_estoque_setor(Obter_Setor_Atendimento(nr_atendimento_p), obter_estab_atendimento(nr_atendimento_p))
		into STRICT	cd_local_estoque_w
		;
		
	end if;	
else
	cd_local_estoque_w	:= null;
end if;
	
select 	max(cd_estabelecimento)
into STRICT	cd_estab_w
from	atendimento_paciente
where	nr_atendimento = nr_atendimento_p;

select	max(cd_setor_Atendimento),
	max(dt_entrada_unidade)
into STRICT	cd_setor_atendimento_w,
	dt_entrada_unidade_w
from	atend_paciente_unidade
where	nr_seq_interno	= nr_seq_atepacu_w;

select	nextval('material_atend_paciente_seq')
into STRICT	nr_sequencia_w
;

select	substr(obter_dados_material_estab(cd_material,cd_estab_w,'UMS'),1,30) cd_unidade_medida_consumo
into STRICT	cd_unidade_medida_w
from	material
where	cd_material	= cd_material_p;

select	coalesce(ie_consignado,'0'),
	cd_material_estoque,
	qt_conv_estoque_consumo,
	substr(obter_dados_material_estab(cd_material,cd_estab_w,'UME'),1,30) cd_unidade_medida_estoque,
	substr(obter_dados_material_estab(cd_material,cd_estab_w,'UMS'),1,30) cd_unidade_medida_consumo
into STRICT	ie_consignado_w,
	cd_material_estoque_w,
	qt_conv_estoque_consumo_w,
	cd_unidade_medida_estoque_w,
	cd_unidade_medida_consumo_w
from	material
where	cd_material = cd_material_p;	

ie_possui_saldo_w	:= 'S';	

if (coalesce(cd_local_estoque_w, 0) > 0) then

	qt_estoque_w	:= obter_saldo_disp_estoque(cd_estab_w,cd_material_estoque_w,cd_local_estoque_w, ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(clock_timestamp()));
	
	if (cd_unidade_medida_consumo_w <> cd_unidade_medida_estoque_w) then
		qt_estoque_w := (qt_estoque_w * qt_conv_estoque_consumo_w);
	end if;									
	
	if (qt_estoque_w < qt_material_p) then
		ie_possui_saldo_w	:= 'N';
		CALL Wheb_mensagem_pck.exibir_mensagem_abort(264226,  'cd_material_p=' || cd_material_p || ';qt_estoque_w=' || to_char(qt_estoque_w) ||  ';qt_material_p' || qt_material_p || ';cd_local_estoque_p=' || substr(OBTER_DESC_LOCAL_ESTOQUE(cd_local_estoque_w),1,100));
			
	end if;

end if;

insert into material_atend_paciente(	nr_sequencia,
					cd_material,
					dt_atendimento,
					cd_convenio,
					cd_categoria,
					nr_seq_atepacu,
					cd_setor_atendimento,
					dt_entrada_unidade,
					qt_material,
					cd_local_estoque,
					dt_Atualizacao,
					nm_usuario,
					nr_atendimento,
					cd_unidade_medida,
					cd_acao,
					ie_valor_informado,
					nr_seq_lote_fornec,
					nr_seq_dialisador)
			values (	nr_sequencia_w,
					cd_material_p,
					clock_timestamp(),
					cd_convenio_w,
					cd_categoria_w,
					nr_seq_atepacu_w,
					cd_setor_atendimento_w,
					dt_entrada_unidade_w,
					qt_material_p,
					cd_local_estoque_w,
					clock_timestamp(),
					nm_usuario_p,
					nr_atendimento_p,
					cd_unidade_medida_w,
					'1',
					'N',
					nr_seq_lote_fornec_p,
					nr_seq_dialisador_p);

CALL atualiza_preco_material(nr_sequencia_w,nm_usuario_p);

nr_sequencia_p		:= nr_sequencia_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE hd_inserir_material_dialisador ( nr_atendimento_p bigint, cd_material_p bigint, nm_usuario_p text, qt_material_p bigint, cd_setor_atendimento_p bigint, nr_seq_lote_fornec_p bigint, nr_sequencia_p INOUT bigint, nr_seq_dialisador_p bigint) FROM PUBLIC;

