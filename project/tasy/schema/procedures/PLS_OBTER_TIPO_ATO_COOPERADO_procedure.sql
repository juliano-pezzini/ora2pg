-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_obter_tipo_ato_cooperado ( cd_procedimento_p bigint, ie_origem_proced_p bigint, nr_seq_item_p bigint, ie_proc_mat_p text, nr_seq_prestador_exec_p bigint, nr_seq_prestador_solic_p bigint, nr_seq_prestador_atend_p bigint, nr_seq_prestador_pgto_p bigint, ie_medico_solic_p text, ie_medico_executor_p text, nr_seq_material_p bigint, ie_tipo_protocolo_p text, ie_tipo_guia_p text, ie_tipo_desp_proc_p text, -- domínio 3796
 ie_tipo_desp_mat_p text, -- domínio 1854
 nr_seq_regra_p INOUT bigint, ie_ato_cooperado_p INOUT bigint) AS $body$
DECLARE



cd_area_procedimento_w		bigint;
cd_especialidade_w		bigint;
cd_grupo_proc_w			bigint;
ie_origem_proced_w		bigint;
nr_seq_regra_w			bigint;
ie_ato_cooperado_w		bigint;
nr_seq_estrutura_mat_w		bigint;
nr_seq_grupo_rec_w		bigint;
nr_seq_estrut_regra_w		bigint;
ie_estrut_mat_w			varchar(1);
nr_seq_regra_ww			bigint;
ie_ato_cooperado_ww		varchar(3);
ie_origem_ato_w			pls_ato_cooperado.ie_origem_ato%type;
ie_origem_ato_ww		pls_ato_cooperado.ie_origem_ato%type;
ie_rede_nao_contratualizada_w	pls_ato_cooperado.ie_rede_nao_contratualizada%type;

nr_seq_tipo_prest_exec_w	pls_prestador.nr_seq_tipo_prestador%type;
nr_seq_tipo_prest_atend_w	pls_prestador.nr_seq_tipo_prestador%type;
nr_seq_tipo_prest_pgto_w	pls_prestador.nr_seq_tipo_prestador%type;

ie_cooperado_exec_w		pls_prestador.ie_tipo_relacao%type;
ie_cooperado_solic_w		pls_prestador.ie_tipo_relacao%type;
ie_cooperado_atend_w		pls_prestador.ie_tipo_relacao%type;
ie_cooperado_pgto_w		pls_prestador.ie_tipo_relacao%type;

ie_tipo_segurado_w		pls_segurado.ie_tipo_segurado%type;
nr_seq_segurado_w		pls_segurado.nr_sequencia%type;
ie_tipo_contrato_w		pls_intercambio.ie_tipo_contrato%type;
ie_status_w			pls_conta_proc.ie_status%type;

C01 CURSOR FOR
	SELECT	a.nr_sequencia,
		a.ie_origem_ato,
		a.ie_ato_cooperado,
		a.nr_seq_estrutura_mat,
		coalesce(a.ie_rede_nao_contratualizada,'N')
	from	pls_ato_cooperado	   a
	where	((coalesce(a.cd_procedimento::text, '') = '') or (a.cd_procedimento 	= cd_procedimento_p AND a.ie_origem_proced = ie_origem_proced_w))
	and	((coalesce(a.cd_grupo_proc::text, '') = '') or (a.cd_grupo_proc 		= cd_grupo_proc_w))
	and	((coalesce(a.cd_especialidade::text, '') = '') or (a.cd_especialidade 	= cd_especialidade_w))
	and	((coalesce(a.cd_area_procedimento::text, '') = '') or (a.cd_area_procedimento 	= cd_area_procedimento_w))
	and	((coalesce(a.nr_seq_tipo_prest_exec::text, '') = '') or (a.nr_seq_tipo_prest_exec 	= nr_seq_tipo_prest_exec_w))
	and	((coalesce(a.nr_seq_tipo_prest_prot::text, '') = '') or (a.nr_seq_tipo_prest_prot 	= nr_seq_tipo_prest_atend_w))
	and	((coalesce(a.nr_seq_tipo_prest_pgto::text, '') = '') or (a.nr_seq_tipo_prest_pgto 	= nr_seq_tipo_prest_pgto_w))
	and	((coalesce(a.ie_prestador_solic::text, '') = '') or (a.ie_prestador_solic 	= ie_cooperado_solic_w))
	and	((coalesce(a.ie_prestador_exec::text, '') = '') or (a.ie_prestador_exec 	= ie_cooperado_exec_w))
	and	((coalesce(a.ie_prestador_atend::text, '') = '') or (a.ie_prestador_atend 	= ie_cooperado_atend_w))
	and	((coalesce(a.ie_prestador_pgto::text, '') = '') or (a.ie_prestador_pgto 	= ie_cooperado_pgto_w))
	and	((coalesce(a.nr_seq_grupo_rec::text, '') = '') or (a.nr_seq_grupo_rec 	= nr_seq_grupo_rec_w))
	and	((coalesce(a.nr_seq_material::text, '') = '') or (a.nr_seq_material 		= nr_seq_material_p))
	and	((coalesce(a.ie_tipo_protocolo::text, '') = '') or (a.ie_tipo_protocolo 	= ie_tipo_protocolo_p))
	and	((coalesce(a.ie_tipo_guia::text, '') = '') or (a.ie_tipo_guia		= ie_tipo_guia_p))
	and	(((coalesce(a.ie_tipo_desp_proc::text, '') = '') or (a.ie_tipo_desp_proc	= ie_tipo_desp_proc_p))
	or	((coalesce(a.ie_tipo_desp_mat::text, '') = '') or (a.ie_tipo_desp_mat 	= ie_tipo_desp_mat_p)))
	and	((coalesce(a.nr_seq_prestador_pgto::text, '') = '') or (a.nr_seq_prestador_pgto	= nr_seq_prestador_pgto_p))
	and	a.ie_situacao = 'A'
	and (coalesce(a.ie_medico_solic,'A')	= coalesce(ie_medico_solic_p,'A')	or coalesce(ie_medico_solic,'A')	= 'A')
	and (coalesce(a.ie_medico_executor,'A')	= coalesce(ie_medico_executor_p,'A')	or coalesce(ie_medico_executor,'A')	= 'A')
	and	((coalesce(a.ie_tipo_segurado::text, '') = '') or (a.ie_tipo_segurado 	= ie_tipo_segurado_w))
	and	((coalesce(a.ie_tipo_contrato::text, '') = '') or (a.ie_tipo_contrato 	= ie_tipo_contrato_w))
	and	((coalesce(a.ie_faturamento_manual::text, '') = '') or (a.ie_faturamento_manual = 'N') or (a.ie_faturamento_manual = 'S' AND ie_status_w = 'M'))
	order 	by coalesce(a.nr_seq_material,0),
		coalesce(a.nr_seq_estrutura_mat,0),
		coalesce(a.ie_prestador_pgto,0),
		coalesce(a.ie_prestador_exec,0),
		coalesce(a.cd_procedimento,0),
		coalesce(a.cd_grupo_proc,0),
		coalesce(a.cd_especialidade,0),
		coalesce(a.cd_area_procedimento,0),
		coalesce(a.nr_seq_tipo_prest_pgto,0),
		coalesce(a.nr_seq_tipo_prest_exec,0),
		coalesce(nr_seq_tipo_prest_prot,0),
		coalesce(ie_prestador_solic,0),
		coalesce(ie_prestador_atend,0),
		coalesce(nr_seq_grupo_rec,0),
		coalesce(ie_tipo_protocolo,'A'),
		coalesce(ie_tipo_guia,0),
		coalesce(ie_tipo_desp_proc,'0'),
		coalesce(ie_tipo_desp_mat,'0'),
		coalesce(nr_seq_prestador_pgto,0),
		coalesce(ie_medico_solic,'A'),
		coalesce(ie_medico_executor,'A'),
		coalesce(ie_tipo_segurado,'A'),
		coalesce(ie_tipo_contrato,'A'),
		coalesce(a.ie_faturamento_manual,'N');


BEGIN

begin
select	CASE WHEN ie_tipo_relacao='C' THEN 1 WHEN ie_tipo_relacao='I' THEN 3 WHEN ie_tipo_relacao='D' THEN 3 WHEN ie_tipo_relacao='F' THEN 3 WHEN ie_tipo_relacao='P' THEN 2 END ,
	nr_seq_tipo_prestador
into STRICT	ie_cooperado_exec_w,
	nr_seq_tipo_prest_exec_w
from	pls_prestador
where	nr_sequencia = nr_seq_prestador_exec_p;
exception
when others then
	ie_cooperado_exec_w		:= '';
	nr_seq_tipo_prest_exec_w	:= '';
end;

begin
select	CASE WHEN ie_tipo_relacao='C' THEN 1 WHEN ie_tipo_relacao='I' THEN 3 WHEN ie_tipo_relacao='D' THEN 3 WHEN ie_tipo_relacao='F' THEN 3 WHEN ie_tipo_relacao='P' THEN 2 END ,
	nr_seq_tipo_prestador
into STRICT	ie_cooperado_atend_w,
	nr_seq_tipo_prest_atend_w
from	pls_prestador
where	nr_sequencia = nr_seq_prestador_atend_p;
exception
when others then
	nr_seq_tipo_prest_atend_w	:= '';
end;

begin
select	CASE WHEN ie_tipo_relacao='C' THEN 1 WHEN ie_tipo_relacao='I' THEN 3 WHEN ie_tipo_relacao='D' THEN 3 WHEN ie_tipo_relacao='F' THEN 3 WHEN ie_tipo_relacao='P' THEN 2 END
into STRICT	ie_cooperado_solic_w
from	pls_prestador
where	nr_sequencia 	= nr_seq_prestador_solic_p;
exception
when others then
	ie_cooperado_solic_w	:= '';
end;

begin
select	CASE WHEN ie_tipo_relacao='C' THEN 1 WHEN ie_tipo_relacao='I' THEN 3 WHEN ie_tipo_relacao='D' THEN 3 WHEN ie_tipo_relacao='F' THEN 3 WHEN ie_tipo_relacao='P' THEN 2 WHEN ie_tipo_relacao='N' THEN 4 END ,
	nr_seq_tipo_prestador
into STRICT	ie_cooperado_pgto_w,
	nr_seq_tipo_prest_pgto_w
from	pls_prestador
where	nr_sequencia = nr_seq_prestador_pgto_p;
exception
when others then
	ie_cooperado_pgto_w		:= '';
	nr_seq_tipo_prest_pgto_w	:= '';
end;

begin
select	nr_seq_grupo_rec
into STRICT	nr_seq_grupo_rec_w
from	procedimento
where	cd_procedimento		= cd_procedimento_p
and	ie_origem_proced	= ie_origem_proced_p;
exception
when others then
	nr_seq_grupo_rec_w	:= '';
end;

if (ie_proc_mat_p = 'P') and (nr_seq_item_p IS NOT NULL AND nr_seq_item_p::text <> '') then
	select	max(s.ie_tipo_segurado),
		max(s.nr_sequencia),
		max(i.ie_status)
	into STRICT	ie_tipo_segurado_w,
		nr_seq_segurado_w,
		ie_status_w
	from	pls_conta_proc	i,
		pls_conta	c,
		pls_segurado	s
	where	c.nr_sequencia		= i.nr_seq_conta
	and	s.nr_sequencia		= c.nr_seq_segurado
	and	i.nr_sequencia		= nr_seq_item_p;


elsif (ie_proc_mat_p = 'M') and (nr_seq_item_p IS NOT NULL AND nr_seq_item_p::text <> '') then
	select	max(s.ie_tipo_segurado),
		max(s.nr_sequencia),
		max(i.ie_status)
	into STRICT	ie_tipo_segurado_w,
		nr_seq_segurado_w,
		ie_status_w
	from	pls_conta_mat	i,
		pls_conta	c,
		pls_segurado	s
	where	c.nr_sequencia		= i.nr_seq_conta
	and	s.nr_sequencia		= c.nr_seq_segurado
	and	i.nr_sequencia		= nr_seq_item_p;

end if;

if (nr_seq_segurado_w IS NOT NULL AND nr_seq_segurado_w::text <> '') then
	select	max(i.ie_tipo_contrato)
	into STRICT	ie_tipo_contrato_w
	from	pls_intercambio		i,
		pls_contrato_pagador	p,
		pls_segurado		s
	where	i.nr_sequencia	= p.nr_seq_pagador_intercambio
	and	p.nr_sequencia	= s.nr_seq_pagador
	and	s.nr_sequencia	= nr_seq_segurado_w;
end if;

SELECT * FROM pls_obter_estrut_proc(cd_procedimento_p, ie_origem_proced_p, cd_area_procedimento_w, cd_especialidade_w, cd_grupo_proc_w, ie_origem_proced_w) INTO STRICT cd_area_procedimento_w, cd_especialidade_w, cd_grupo_proc_w, ie_origem_proced_w;
open C01;
loop
fetch C01 into
	nr_seq_regra_ww,
	ie_origem_ato_ww,
	ie_ato_cooperado_ww,
	nr_seq_estrut_regra_w,
	ie_rede_nao_contratualizada_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin

	if (ie_rede_nao_contratualizada_w = 'N') or (ie_cooperado_pgto_w = 4) then
		ie_estrut_mat_w	:= 'S';
		if (nr_seq_estrut_regra_w IS NOT NULL AND nr_seq_estrut_regra_w::text <> '') then
			ie_estrut_mat_w	:= pls_obter_se_mat_estrutura(nr_seq_material_p, nr_seq_estrut_regra_w);
		end if;

		if (ie_estrut_mat_w = 'S') then
			nr_seq_regra_w		:= nr_seq_regra_ww;
			ie_origem_ato_w		:= ie_origem_ato_ww;
			ie_ato_cooperado_w	:= ie_ato_cooperado_ww;
		end if;
	end if;
	end;
end loop;
close C01;

if (ie_origem_ato_w = 'P') then
	select	max(x.cd_ato)
	into STRICT	ie_ato_cooperado_w
	from (SELECT	cd_ato
		from	ptu_nota_servico
		where	nr_seq_conta_proc = nr_seq_item_p
		and	ie_proc_mat_p = 'P'
		
union all

		SELECT	cd_ato
		from	ptu_nota_servico
		where	nr_seq_conta_mat = nr_seq_item_p
		and	ie_proc_mat_p = 'M') x;
end if;

nr_seq_regra_p 		:= nr_seq_regra_w;
ie_ato_cooperado_p	:= ie_ato_cooperado_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_obter_tipo_ato_cooperado ( cd_procedimento_p bigint, ie_origem_proced_p bigint, nr_seq_item_p bigint, ie_proc_mat_p text, nr_seq_prestador_exec_p bigint, nr_seq_prestador_solic_p bigint, nr_seq_prestador_atend_p bigint, nr_seq_prestador_pgto_p bigint, ie_medico_solic_p text, ie_medico_executor_p text, nr_seq_material_p bigint, ie_tipo_protocolo_p text, ie_tipo_guia_p text, ie_tipo_desp_proc_p text, ie_tipo_desp_mat_p text, nr_seq_regra_p INOUT bigint, ie_ato_cooperado_p INOUT bigint) FROM PUBLIC;

