-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_codigo_auto_contrato ( nr_sequencia_p bigint, ie_opcao_p bigint, ds_retorno_p INOUT text, ds_erro_p INOUT text) AS $body$
DECLARE


nr_seq_tipo_contrato_w	bigint;
nr_seq_subtipo_contrato_w	bigint;
cd_setor_w			integer;
nr_seq_aditivo_w		bigint;
ds_nome_curto_w		varchar(3);
ds_nome_curto_sub_w		varchar(3);
nm_curto_w			varchar(3);
ds_erro_w			varchar(255)	:= '';
ds_ano_atual_w			varchar(4);
qt_codigo_w			bigint;


BEGIN

if (ie_opcao_p = 2) then
	ds_retorno_p	:= nr_sequencia_p;
elsif (ie_opcao_p = 1) then
	begin
	select	coalesce(max(nr_seq_tipo_contrato),0),
		coalesce(max(nr_seq_subtipo_contrato),0),
		coalesce(max(cd_setor),0),
		coalesce(max(nr_seq_aditivo),0)
	into STRICT	nr_seq_tipo_contrato_w,
		nr_seq_subtipo_contrato_w,
		cd_setor_w,
		nr_seq_aditivo_w
	from	contrato
	where	nr_sequencia = nr_sequencia_p;

	if (nr_seq_tipo_contrato_w <> 0) then
		/* Nome curto do tipo do contrato */

		select	ds_nome_curto
		into STRICT	ds_nome_curto_w
		from	tipo_contrato
		where	nr_sequencia = nr_seq_tipo_contrato_w;

		if (coalesce(ds_nome_curto_w::text, '') = '') then
			ds_erro_w	:= substr(WHEB_MENSAGEM_PCK.get_texto(279654) || chr(13) || chr(10),1,255);
		end if;
	end if;

	if (nr_seq_subtipo_contrato_w <> 0) then
		/* Nome curto do subtipo do contrato */

		select	ds_nome_curto
		into STRICT	ds_nome_curto_sub_w
		from	contrato_subtipo
		where	nr_sequencia = nr_seq_subtipo_contrato_w;

		if (coalesce(ds_nome_curto_sub_w::text, '') = '') then
			ds_erro_w	:= substr(ds_erro_w || WHEB_MENSAGEM_PCK.get_texto(279655) || chr(13) || chr(10),1,255);
		end if;
	end if;

	if (cd_setor_w <> 0) then
		/* Nome curto do setor resp do contrato */

		select	nm_curto
		into STRICT	nm_curto_w
		from	setor_atendimento
		where	cd_setor_atendimento = cd_setor_w;

		if (coalesce(nm_curto_w::text, '') = '') then
			ds_erro_w	:= substr(ds_erro_w || WHEB_MENSAGEM_PCK.get_texto(279656) || chr(13) || chr(10),1,255);
		end if;
	end if;

	if (ds_erro_w IS NOT NULL AND ds_erro_w::text <> '') then
		ds_erro_p	:= WHEB_MENSAGEM_PCK.get_texto(279658) || chr(13) || chr(10) || ds_erro_w;
	end if;
	ds_retorno_p	:= (ds_nome_curto_w || ds_nome_curto_sub_w || nm_curto_w || nr_sequencia_p || ' - ' || nr_seq_aditivo_w);
	end;
elsif (ie_opcao_p = 4) then
	begin
	ds_ano_atual_w := to_char(clock_timestamp(),'yyyy');

	select	count(*)
	into STRICT	qt_codigo_w
	from	contrato
	where	cd_contrato like '%/' || ds_ano_atual_w;

	ds_retorno_p := (qt_codigo_w + 1) || '/' || ds_ano_atual_w;
	end;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_codigo_auto_contrato ( nr_sequencia_p bigint, ie_opcao_p bigint, ds_retorno_p INOUT text, ds_erro_p INOUT text) FROM PUBLIC;

