-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE hmsl_gerar_cobr_santander_240 ( nr_seq_cobr_escrit_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) AS $body$
DECLARE

			
ds_conteudo_w			varchar(240);
nr_remessa_w			varchar(8);
qt_lote_arquivo_w		varchar(10) := 0;
qt_reg_lote_w			varchar(6) := 0;
qt_registro_lote_w		varchar(10) := 0;
nr_seq_arquivo_w		varchar(6) := 0;
nr_seq_registro_w		varchar(10) := 0;
nm_empresa_w			varchar(30);
cd_cgc_w			varchar(15);
nm_banco_w			varchar(30);
dt_geracao_w			varchar(8);
nr_lote_w_w			varchar(4) := 0;
nr_lote_w			varchar(4);
ie_tipo_taxa_juro_w		varchar(1);
ie_tipo_taxa_multa_w		varchar(1);
cd_multa_w			varchar(1);
cd_juro_w			varchar(1);

/* Segmentos */

nr_nosso_numero_w		varchar(20);
nr_nosso_num_tit_w		titulo_receber.nr_nosso_numero%type;
dt_vencimento_w			varchar(8);
vl_titulo_w			varchar(15);
dt_emissao_w			varchar(8);
cd_agencia_w			varchar(4);
ie_digito_agencia_w		varchar(1);
nr_conta_w			varchar(9);
ie_digito_conta_w		varchar(1);
cd_conta_cobr_w			varchar(9);
ie_conta_cobr_w			varchar(1);
nr_seu_numero_w			varchar(15);
ie_tipo_inscricao_w		varchar(1);
nr_inscricao_w			varchar(15);
nm_sacado_w			varchar(40);
ds_endereco_sacado_w		varchar(40);
ds_bairro_sacado_w		varchar(15);
cd_cep_sacado_w			varchar(8);
ds_municipio_sacado_w		varchar(15);
ds_estado_sacado_w		varchar(2);
cd_mov_remessa_w		varchar(2);
cd_transmissao_w		varchar(15);
nm_cedente_w			varchar(30);
nr_seq_pagador_w		bigint;

ds_conteudo_aux_w		varchar(200);
nr_titulo_w			bigint;
ds_mensagem_3_w			varchar(40);
ds_mensagem_4_w			varchar(40);
vl_mora_w			varchar(15);
ie_impressao_w			varchar(1);
cd_banco_w			banco.cd_banco%type;
cd_tipo_cobranca_w		varchar(1);
cd_forma_cadastro_w		varchar(1);
nr_juros_w				varchar(15);	

nr_seq_mensalidade_w		pls_mensalidade.nr_sequencia%type;
nr_linha_w			integer;

/* Segmento P */

C01 CURSOR FOR
	SELECT	lpad(coalesce(substr(c.cd_ocorrencia,1,2),'01'),2,'0') cd_mov_remessa,
		lpad(to_char(x.cd_agencia_bancaria),4,'0') cd_agencia,
		lpad(coalesce(substr(z.ie_digito,1,1),'0'),1,'0') ie_digito_agencia,
		lpad(substr(x.cd_conta,1,9),9,'0') nr_conta,
		lpad(coalesce(substr(c.ie_digito_conta,1,1),'0'),1,'0') ie_digito_conta, 
		lpad(substr(x.cd_conta,1,9),9,'0') cd_conta_cobr,
		rpad(coalesce(substr(x.ie_digito_conta,1,1),'0'),1,'0') ie_conta_cobr, --rpad(nvl(substr(x.ie_digito_conta,1,1),'0'),1,'0') ie_conta_cobr,
		coalesce(b.nr_nosso_numero,'0') nr_nosso_num_tit,
		substr(obter_nosso_numero_interf(x.cd_banco,b.nr_titulo),1,13) nr_nosso_numero,		
		rpad(substr(b.nr_titulo,1,15),15,'0') nr_seu_numero,
		to_char(coalesce(b.dt_pagamento_previsto, b.dt_vencimento),'ddmmyyyy') dt_vencimento,
		LPAD(somente_numero(TO_CHAR(coalesce(b.vl_titulo,0),'99999999990.00')),15,'0') vl_titulo,
		to_char(b.dt_emissao,'ddmmyyyy') dt_emissao,
		/* Segmento Q */

		CASE WHEN coalesce(b.cd_cgc::text, '') = '' THEN CASE WHEN coalesce(b.cd_cgc_cpf::text, '') = '' THEN '0'  ELSE '1' END   ELSE '2' END  ie_tipo_inscricao, 
		lpad(coalesce(b.cd_cgc_cpf,'0'),15,'0') nr_inscricao,
		rpad(upper(elimina_acentuacao(substr(b.nm_pessoa,1,40))),40,' ') nm_sacado,
		RPAD(coalesce(SUBSTR(CASE WHEN coalesce(d.nr_sequencia::text, '') = '' THEN SUBSTR(obter_dados_pf_pj(b.cd_pessoa_fisica, b.cd_cgc, 'E'),1,24)||' N.'||SUBSTR(obter_dados_pf_pj(b.cd_pessoa_fisica, b.cd_cgc, 'NR'),1,4)||' - '||SUBSTR(obter_dados_pf_pj(b.cd_pessoa_fisica, b.cd_cgc, 'CO'),1,9)    ELSE SUBSTR(pls_obter_compl_pagador(d.nr_seq_pagador,'E'),1,24)||' N.'||SUBSTR(pls_obter_compl_pagador(d.nr_seq_pagador,'NR'),1,4)||' - '||SUBSTR(pls_obter_compl_pagador(d.nr_seq_pagador,'CO'),1,9) END ,1,40),' '),40,' ') ds_endereco_sacado,
		rpad(coalesce(substr(CASE WHEN coalesce(d.nr_sequencia::text, '') = '' THEN obter_dados_pf_pj(b.cd_pessoa_fisica, b.cd_cgc, 'B')  ELSE pls_obter_compl_pagador(d.nr_seq_pagador,'B') END ,1,15),' '),15,' ') ds_bairro_sacado,
		lpad(coalesce(substr(CASE WHEN coalesce(d.nr_sequencia::text, '') = '' THEN elimina_caractere_especial(obter_dados_pf_pj(b.cd_pessoa_fisica, b.cd_cgc, 'CEP'))  ELSE elimina_caractere_especial(pls_obter_compl_pagador(d.nr_seq_pagador,'CEP')) END ,1,8),'0'),8,'0') cd_cep_sacado,
		rpad(coalesce(substr(CASE WHEN coalesce(d.nr_sequencia::text, '') = '' THEN obter_dados_pf_pj(b.cd_pessoa_fisica, b.cd_cgc, 'CI')  ELSE pls_obter_compl_pagador(d.nr_seq_pagador,'CI') END ,1,15),' '),15,' ') ds_municipio_sacado,
		rpad(coalesce(substr(CASE WHEN coalesce(d.nr_sequencia::text, '') = '' THEN obter_dados_pf_pj(b.cd_pessoa_fisica, b.cd_cgc, 'UF')  ELSE pls_obter_compl_pagador(d.nr_seq_pagador,'UF') END ,1,2),' '),2,' ') ds_estado_sacado,
		f.nr_sequencia,
		b.nr_titulo,
		rpad(coalesce(obter_instrucao_boleto_estab(b.nr_titulo,a.cd_banco,1,coalesce(cd_estabelecimento_p,a.cd_estabelecimento)), ' '),40, ' ') ds_mensagem_3,
		rpad(coalesce(obter_instrucao_boleto_estab(b.nr_titulo,a.cd_banco,2,coalesce(cd_estabelecimento_p,a.cd_estabelecimento)), ' '),40, ' ') ds_mensagem_4,
		lpad(somente_numero(to_char(coalesce(coalesce(c.vl_juros, obter_juros_multa_titulo(b.nr_titulo, clock_timestamp(), 'R', 'J')),0) +
		coalesce(coalesce(c.vl_multa, obter_juros_multa_titulo(b.nr_titulo, clock_timestamp(), 'R', 'M')),0),'9999999999990.00')),15,'0') vl_mora,
		x.cd_banco,
		d.nr_sequencia,
		lpad(somente_numero(to_char(b.tx_juros,'9999999990.00000')),15,'0') 
	FROM agencia_bancaria z, banco_estabelecimento x, titulo_receber_cobr c, cobranca_escritural a, titulo_receber_v b
LEFT OUTER JOIN pls_mensalidade d ON (b.nr_seq_mensalidade = d.nr_sequencia)
LEFT OUTER JOIN banco_carteira e ON (b.nr_seq_carteira_cobr = e.nr_sequencia)
LEFT OUTER JOIN pls_contrato_pagador f ON (d.nr_seq_pagador = f.nr_sequencia)
WHERE a.nr_sequencia		= c.nr_seq_cobranca and c.nr_titulo		= b.nr_titulo and x.nr_sequencia		= a.nr_seq_conta_banco and z.cd_agencia_bancaria	= x.cd_agencia_bancaria and z.cd_banco		= x.cd_banco    and a.nr_sequencia		= nr_seq_cobr_escrit_p;
	
C02 CURSOR FOR
	SELECT	ds_mensagem,
		ie_impressao,
		somente_numero(substr(nr_linha,1,2)) nr_linha
	from (SELECT	rpad(substr(obter_instrucao_boleto_estab(nr_titulo_w,cd_banco_w,a.nr_linha,cd_estabelecimento_p),1,100),100,' ') ds_mensagem,
			'1' ie_impressao,
			coalesce(a.nr_linha,0) + 1 nr_linha
		from	banco_instrucao_boleto a
		where	a.cd_banco	= cd_banco_w
		and	a.cd_estabelecimento = cd_estabelecimento_p
		order by	a.nr_linha) alias6
	where	(trim(both ds_mensagem) IS NOT NULL AND (trim(both ds_mensagem))::text <> '')
	order by	nr_linha;


BEGIN
delete	from w_envio_banco
where	nm_usuario	= nm_usuario_p;

/* Header Arquivo*/

qt_lote_arquivo_w	:= qt_lote_arquivo_w + 1;

select	rpad(elimina_acentuacao(substr(obter_nome_pf_pj(null,b.cd_cgc),1,30)),30,' ') nm_empresa,
	rpad(upper(substr(obter_nome_banco(c.cd_banco),1,30)),30,' ') nm_banco,
	lpad(b.cd_cgc,15,'0') cd_cgc,
	lpad(to_char(a.nr_sequencia),6,'0') nr_seq_arquivo,
	to_char(clock_timestamp(),'ddmmyyyy') dt_geracao,
	lpad(substr(coalesce(c.cd_transmissao,'0'),1,15),15,'0') cd_transmissao,
	substr(somente_numero(coalesce(coalesce(e.cd_tipo_cobranca_ext,c.cd_tipo_cobranca),'5')),1,1) cd_tipo_cobranca,
	substr(somente_numero(coalesce(e.cd_forma_cadastro_ext,'2')),1,1) cd_forma_cadastro
into STRICT	nm_empresa_w,
	nm_banco_w,
	cd_cgc_w,
	nr_seq_arquivo_w,
	dt_geracao_w,
	cd_transmissao_w,
	cd_tipo_cobranca_w,
	cd_forma_cadastro_w
FROM banco_estabelecimento c, estabelecimento b, cobranca_escritural a
LEFT OUTER JOIN banco_carteira d ON (a.nr_seq_carteira_cobr = d.nr_sequencia)
LEFT OUTER JOIN tipo_cobr_escrit e ON (a.nr_seq_tipo = e.nr_sequencia)
WHERE a.cd_estabelecimento	= b.cd_estabelecimento and a.nr_seq_conta_banco	= c.nr_sequencia  and a.nr_sequencia		= nr_seq_cobr_escrit_p;

ds_conteudo_w	:=	'033' ||
			'0000' ||
			'0' ||
			rpad(' ',8,' ') ||
			'2' ||
			cd_cgc_w ||
			cd_transmissao_w ||
			rpad(' ',25,' ') ||
			nm_empresa_w ||
			nm_banco_w ||
			rpad(' ',10,' ') ||
			'1' ||
			dt_geracao_w ||
			rpad(' ',6,' ') ||
			nr_seq_arquivo_w ||
			'040' ||
			rpad(' ',74,' ');

insert	into w_envio_banco(nr_sequencia,
	dt_atualizacao,
	nm_usuario,
	dt_atualizacao_nrec,
	nm_usuario_nrec,
	cd_estabelecimento,
	ds_conteudo,
	nr_seq_apres,
	nr_seq_apres_2)
values (nextval('w_envio_banco_seq'),
	clock_timestamp(),
	nm_usuario_p,
	clock_timestamp(),
	nm_usuario_p,
	cd_estabelecimento_p,
	ds_conteudo_w,
	1,
	1);

/* Fim Header Arquivo */



/* Header Lote */

nr_lote_w_w		:= nr_lote_w_w + 1;
nr_lote_w		:= lpad(nr_lote_w_w,4,'0');
qt_lote_arquivo_w	:= qt_lote_arquivo_w + 1;
qt_registro_lote_w	:= qt_registro_lote_w + 1;

select	lpad(b.cd_cgc,15,'0') cd_cgc,
	rpad(elimina_acentuacao(substr(obter_nome_pf_pj(null, b.cd_cgc),1,30)),30,' ') nm_cedente,
	lpad(substr(coalesce(a.nr_remessa,a.nr_sequencia),1,8),8,'0') nr_remessa,
	to_char(clock_timestamp(),'ddmmyyyy') dt_geracao,
	lpad(substr(coalesce(c.cd_transmissao,'0'), 1, 15), 15, '0') cd_transmissao
into STRICT	cd_cgc_w,
	nm_cedente_w,
	nr_remessa_w,
	dt_geracao_w,
	cd_transmissao_w
FROM banco_estabelecimento c, estabelecimento b, cobranca_escritural a
LEFT OUTER JOIN banco_carteira d ON (a.nr_seq_carteira_cobr = d.nr_sequencia)
WHERE a.cd_estabelecimento	= b.cd_estabelecimento and a.nr_seq_conta_banco	= c.nr_sequencia  and a.nr_sequencia		= nr_seq_cobr_escrit_p;

ds_conteudo_w	:=	'033' ||
			nr_lote_w ||
			'1' ||
			'R' ||
			'01' ||
			rpad(' ', 2, ' ') ||
			'030' ||
			rpad(' ', 1, ' ') ||
			'2' ||
			cd_cgc_w ||
			rpad(' ', 20, ' ') ||
			cd_transmissao_w ||
			rpad(' ',5,' ') ||
			nm_cedente_w ||
			rpad(' ', 40, ' ') ||
			rpad(' ', 40, ' ') ||
			nr_remessa_w ||
			dt_geracao_w ||
			rpad(' ', 41, ' ');

insert into w_envio_banco(nr_sequencia,
	dt_atualizacao,
	nm_usuario,
	dt_atualizacao_nrec,
	nm_usuario_nrec,
	cd_estabelecimento,
	ds_conteudo,
	nr_seq_apres,
	nr_seq_apres_2)
values (nextval('w_envio_banco_seq'),
	clock_timestamp(),
	nm_usuario_p,
	clock_timestamp(),
	nm_usuario_p,
	cd_estabelecimento_p,
	ds_conteudo_w,
	2,
	2);
	
qt_reg_lote_w		:= qt_reg_lote_w + 1;
/* Fim Header Lote */



/* Inicio Segmentos */

open C01;
loop
fetch C01 into	
	cd_mov_remessa_w,
	cd_agencia_w,
	ie_digito_agencia_w,
	nr_conta_w,
	ie_digito_conta_w,
	cd_conta_cobr_w,
	ie_conta_cobr_w,
	nr_nosso_num_tit_w,
	nr_nosso_numero_w,
	nr_seu_numero_w,
	dt_vencimento_w,
	vl_titulo_w,
	dt_emissao_w,
	ie_tipo_inscricao_w,
	nr_inscricao_w,
	nm_sacado_w,
	ds_endereco_sacado_w,
	ds_bairro_sacado_w,
	cd_cep_sacado_w,
	ds_municipio_sacado_w,
	ds_estado_sacado_w,
	nr_seq_pagador_w,
	nr_titulo_w,
	ds_mensagem_3_w,
	ds_mensagem_4_w,
	vl_mora_w,
	cd_banco_w,
	nr_seq_mensalidade_w,
	nr_juros_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	/* Segmento P */

	nr_seq_registro_w	:= nr_seq_registro_w + 1;
	qt_registro_lote_w	:= qt_registro_lote_w + 1;
	qt_lote_arquivo_w	:= qt_lote_arquivo_w + 1;

	select	max(b.ie_tipo_taxa)
	into STRICT	ie_tipo_taxa_juro_w
	from	tipo_taxa		b,
		titulo_receber		a
	where	a.cd_tipo_taxa_juro	= b.cd_tipo_taxa
	and	a.nr_titulo		= nr_titulo_w;
	
	if (ie_tipo_taxa_juro_w in ('V','F')) then
		cd_juro_w	:= '1';
	elsif (ie_tipo_taxa_juro_w = 'D') then
		cd_juro_w	:= '2';
	else
		cd_juro_w	:= '3';
	end if;
	
	select	max(b.ie_tipo_taxa)
	into STRICT	ie_tipo_taxa_multa_w
	from	tipo_taxa		b,
		titulo_receber		a
	where	a.cd_tipo_taxa_multa	= b.cd_tipo_taxa
	and	a.nr_titulo		= nr_titulo_w;
	
	if (ie_tipo_taxa_multa_w in ('V','F')) then
		cd_multa_w	:= '1';
	else
		cd_multa_w	:= '2';
	end if;
	
	if (nr_nosso_num_tit_w = '0') and /* Tratamento para gravar o nosso número conforme parametrização do título e para atualizar a sequencia do nosso número na regra do mesmo */
		(nr_nosso_numero_w <> '0') then
		update	titulo_receber
		set	nr_nosso_numero 	= nr_nosso_numero_w,
			ds_observacao_titulo	= substr(ds_observacao_titulo ||
						' Nosso número ' || nr_nosso_numero_w || ' atualizado através da procedure gerar_cobr_santander_240 ao gerar remessa da cobrança escritural '
 || nr_seq_cobr_escrit_p,1,4000)
		where	nr_titulo 		= nr_titulo_w;
		
		update	banco_regra_numero
		set	nr_atual		= coalesce(nr_atual,0) + 1
		where	cd_banco		= cd_banco_w
		and	cd_estabelecimento	= cd_estabelecimento_p
		and	ie_regra		= 'FSD';
		
		nr_nosso_numero_w	:= lpad(substr(nr_nosso_numero_w,1,13),13,'0');
	elsif (nr_nosso_num_tit_w <> '0') then
		nr_nosso_numero_w	:= lpad(substr(nr_nosso_num_tit_w,1,13),13,'0');
	end if;
	
	ds_conteudo_w	:=	'033' ||
				nr_lote_w ||
				'3' ||
				lpad(nr_seq_registro_w, 5, '0') ||
				'P' ||
				rpad(' ', 1, ' ') ||
				cd_mov_remessa_w ||
				cd_agencia_w ||
				ie_digito_agencia_w ||
				nr_conta_w ||
				ie_conta_cobr_w || 
				cd_conta_cobr_w ||  
				ie_conta_cobr_w || 
				rpad(' ', 2, ' ') ||
				nr_nosso_numero_w ||
				cd_tipo_cobranca_w ||
				cd_forma_cadastro_w ||
				'1' ||
				rpad(' ',2,' ') ||
				nr_seu_numero_w ||
				dt_vencimento_w ||				
				vl_titulo_w ||		
				'0000' ||
				'0' || 
				rpad(' ', 1, ' ') ||
				'04' ||
				'N' || --109
				dt_emissao_w || --110 a 117
				'1' || --118
				dt_vencimento_w || --119 a 126
				nr_juros_w|| --lpad('0', 15, '0') || --127 a 141
				'0' ||
				'00000000' ||
				lpad('0', 15, '0') ||
				lpad('0', 15, '0') ||
				lpad('0', 15, '0') ||
				lpad(' ', 25, ' ') ||
				'0' ||
				'00' ||
				'3' || --Código do juros de mora
				'0' ||
				'00' || 
				'00' ||
				rpad(' ', 11, ' ');
	
	insert into w_envio_banco(nr_sequencia,
		dt_atualizacao,
		nm_usuario,
		dt_atualizacao_nrec,
		nm_usuario_nrec,
		cd_estabelecimento,
		ds_conteudo,
		nr_seq_apres,
		nr_seq_apres_2)
	values (nextval('w_envio_banco_seq'),
		clock_timestamp(),
		nm_usuario_p,
		clock_timestamp(),
		nm_usuario_p,
		cd_estabelecimento_p,
		ds_conteudo_w,
		3,
		nr_seq_registro_w);
	/* Fim segmento P */

	
	qt_lote_arquivo_w	:= qt_lote_arquivo_w + 1;
	qt_registro_lote_w	:= qt_registro_lote_w + 1;

	/* Segmento Q */

	ds_conteudo_w		:= null;
	nr_seq_registro_w	:= nr_seq_registro_w + 1;
	
	ds_conteudo_w	:=	'033' ||
				nr_lote_w ||
				'3' ||
				lpad(nr_seq_registro_w, 5, '0') ||
				'Q' ||
				rpad(' ', 1, ' ') ||
				cd_mov_remessa_w ||
				ie_tipo_inscricao_w ||
				nr_inscricao_w ||
				nm_sacado_w ||
				ds_endereco_sacado_w ||
				ds_bairro_sacado_w ||
				lpad(cd_cep_sacado_w,8,'0') ||
				ds_municipio_sacado_w ||
				ds_estado_sacado_w ||
				lpad('0', 16, '0') ||
				rpad(' ', 40, ' ') ||
				'000' || 
				'000' ||
				'000' ||
				'000' ||
				rpad(' ', 19, ' ');
				
	insert	into w_envio_banco(nr_sequencia,
		dt_atualizacao,
		nm_usuario,
		dt_atualizacao_nrec,
		nm_usuario_nrec,
		cd_estabelecimento,
		ds_conteudo,
		nr_seq_apres,
		nr_seq_apres_2)
	values (nextval('w_envio_banco_seq'),
		clock_timestamp(),
		nm_usuario_p,
		clock_timestamp(),
		nm_usuario_p,
		cd_estabelecimento_p,
		ds_conteudo_w,
		3,
		nr_seq_registro_w);
		
	/* Fim segmento Q */


	
	/* Segmento R */

		ds_conteudo_w		:= null;
		nr_seq_registro_w	:= nr_seq_registro_w + 1;
		qt_registro_lote_w	:= qt_registro_lote_w + 1;
		qt_lote_arquivo_w	:= qt_lote_arquivo_w + 1;
	
		ds_conteudo_w	:=	'033' ||
					nr_lote_w ||
					'3' ||
					lpad(nr_seq_registro_w, 5, '0') ||
					'R' ||
					rpad(' ', 1, ' ') ||
					cd_mov_remessa_w ||
					'0' ||
					'00000000' ||
					'000000000000000' ||
					'                        ' ||
					'2' ||
					dt_vencimento_w ||
					'000000000000200' ||
					'          ' ||
					ds_mensagem_3_w ||
					ds_mensagem_4_w ||
					rpad(' ', 61, ' ');
				
		insert	into w_envio_banco(nr_sequencia,
			dt_atualizacao,
			nm_usuario,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			cd_estabelecimento,
			ds_conteudo,
			nr_seq_apres,
			nr_seq_apres_2)
		values (nextval('w_envio_banco_seq'),
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			cd_estabelecimento_p,
			ds_conteudo_w,
			3,
			nr_seq_registro_w);


	/* Fim segmento R */

	open C02;
	loop
	fetch C02 into	
		ds_conteudo_aux_w,
		ie_impressao_w,
		nr_linha_w;
	EXIT WHEN NOT FOUND; /* apply on C02 */
		begin
		/* Segmento S */

		ds_conteudo_w		:= null;
		nr_seq_registro_w	:= nr_seq_registro_w + 1;
		qt_registro_lote_w	:= qt_registro_lote_w + 1;
		qt_lote_arquivo_w	:= qt_lote_arquivo_w + 1;

		if (ie_impressao_w	= '1') then

			ds_conteudo_w	:=	'033' ||
						nr_lote_w ||
						'3' ||
						lpad(nr_seq_registro_w, 5, '0') ||
						'S' ||
						' ' ||
						cd_mov_remessa_w ||
						ie_impressao_w ||
						lpad(nr_linha_w,2,'0') ||
						'4' ||
						ds_conteudo_aux_w ||
						rpad(' ',119,' ');

		else

			ds_conteudo_w	:=	'033' ||
						nr_lote_w ||
						'3' ||
						lpad(nr_seq_registro_w, 5, '0') ||
						'S' ||
						' ' ||
						cd_mov_remessa_w ||
						ie_impressao_w ||
						ds_conteudo_aux_w ||
						rpad(' ',22,' ');

		end if;
					
		insert	into w_envio_banco(nr_sequencia,
			dt_atualizacao,
			nm_usuario,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			cd_estabelecimento,
			ds_conteudo,
			nr_seq_apres,
			nr_seq_apres_2)
		values (nextval('w_envio_banco_seq'),
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			cd_estabelecimento_p,
			ds_conteudo_w,
			3,
			nr_seq_registro_w);
			
		/* Fim segmento S */

		end;
	end loop;
	close C02;
	end;
end loop;
close C01;
/*Fim Segmentos */



/* Trailler Lote*/

begin
qt_lote_arquivo_w	:= qt_lote_arquivo_w + 1;
qt_registro_lote_w	:= qt_registro_lote_w + 1;
	
ds_conteudo_w	:=	'033' ||
			nr_lote_w ||
			'5' ||
			lpad(' ', 9, ' ') ||
			lpad(qt_registro_lote_w, 6, '0') ||
			rpad(' ', 217, ' ');

insert	into w_envio_banco(nr_sequencia,
	dt_atualizacao,
	nm_usuario,
	dt_atualizacao_nrec,
	nm_usuario_nrec,
	cd_estabelecimento,
	ds_conteudo,
	nr_seq_apres,
	nr_seq_apres_2)
values (nextval('w_envio_banco_seq'),
	clock_timestamp(),
	nm_usuario_p,
	clock_timestamp(),
	nm_usuario_p,
	cd_estabelecimento_p,
	ds_conteudo_w,
	5,
	5);
end;
/* Fim Trailler Lote*/



/* Trailler Arquivo*/

begin
qt_lote_arquivo_w	:= qt_lote_arquivo_w + 1;

ds_conteudo_w	:=	'033' ||
			'9999' ||
			'9' ||
			lpad(' ', 9, ' ') ||
			lpad(qt_reg_lote_w, 6, '0') ||
			lpad(qt_lote_arquivo_w, 6, '0') ||
			rpad(' ', 211, ' ');

insert	into w_envio_banco(nr_sequencia,
	dt_atualizacao,
	nm_usuario,
	dt_atualizacao_nrec,
	nm_usuario_nrec,
	cd_estabelecimento,
	ds_conteudo,
	nr_seq_apres,
	nr_seq_apres_2)
values (nextval('w_envio_banco_seq'),
	clock_timestamp(),
	nm_usuario_p,
	clock_timestamp(),
	nm_usuario_p,
	cd_estabelecimento_p,
	ds_conteudo_w,
	6,
	6);
end;
/* Fim Trailler Arquivo*/

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE hmsl_gerar_cobr_santander_240 ( nr_seq_cobr_escrit_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) FROM PUBLIC;

