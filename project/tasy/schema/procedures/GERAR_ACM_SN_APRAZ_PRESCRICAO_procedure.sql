-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_acm_sn_apraz_prescricao ( nr_prescricao_p bigint, nr_sequencia_p bigint, cd_local_estoque_p bigint, nm_usuario_p text) AS $body$
DECLARE



ie_acm_sn_w		integer;
ie_imprimir_acm_sn_w	varchar(1);
cd_estabelecimento_w	smallint;
cd_setor_nao_imprimi_w	integer;
cd_setor_prescricao_w	integer;


BEGIN

select	max(cd_estabelecimento),
	max(cd_setor_atendimento)
into STRICT	cd_estabelecimento_w,
	cd_setor_prescricao_w
from 	prescr_medica
where	nr_prescricao = nr_prescricao_p;

select	coalesce(max(ie_imprimir_acm_sn),'N')
into STRICT	ie_imprimir_acm_sn_w
from 	parametros_farmacia
where	cd_estabelecimento = cd_estabelecimento_w;

select	count(*)
into STRICT	ie_acm_sn_w
from	prescr_material
where	nr_prescricao	= nr_prescricao_p
and	nr_sequencia	= nr_sequencia_p
and (ie_acm = 'S' or ie_se_necessario = 'S');

cd_setor_nao_imprimi_w := obter_param_usuario(1113, 606, Obter_perfil_Ativo, nm_usuario_p, cd_estabelecimento_w, cd_setor_nao_imprimi_w);

if	(ie_acm_sn_w > 0 AND ie_imprimir_acm_sn_w = 'S') and
	(((coalesce(cd_setor_nao_imprimi_w,0) > 0) and (cd_setor_nao_imprimi_w <> cd_setor_prescricao_w)) or (coalesce(cd_setor_nao_imprimi_w,0) = 0)) then
	update	prescr_material
	set	cd_motivo_baixa	= 0
	where	nr_prescricao	= nr_prescricao_p
	and	nr_sequencia	= nr_sequencia_p;

	update	prescr_medica
	set	dt_emissao_farmacia  = NULL
	where	nr_prescricao	= nr_prescricao_p;

	delete
	from	prescr_emissao_local
	where 	nr_prescricao = nr_prescricao_p
	and 	cd_local_estoque = cd_local_estoque_p;

end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_acm_sn_apraz_prescricao ( nr_prescricao_p bigint, nr_sequencia_p bigint, cd_local_estoque_p bigint, nm_usuario_p text) FROM PUBLIC;

