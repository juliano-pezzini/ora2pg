-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE plt_copia_suplemento ( nr_prescricao_p bigint, nr_seq_regra_p bigint, ds_lista_p text, ie_modificar_p text, nm_usuario_p text, cd_perfil_p bigint, cd_estabelecimento_p bigint, ie_estende_inc_p text, ie_copia_agora_p text) AS $body$
DECLARE


nr_agrup_acum_w			bigint;
ds_lista_w			varchar(4000);
tam_lista_w			bigint;
tam_prescricao_w		bigint;
ie_pos_virgula_w		smallint;
ie_pos_espaco_w			smallint;
nr_prescr_lista_w		bigint;
nr_prescr_ant_w			bigint;
qt_w				bigint;
nr_seq_lista_w			integer;
ds_prescricao_w			varchar(255);
nr_sequencia_w			integer;
ie_origem_inf_w			varchar(1);
cd_material_w			integer;
cd_unidade_medida_w		varchar(30);
qt_dose_w			double precision;
qt_unitaria_w			double precision;
qt_material_w			double precision;
cd_intervalo_w			varchar(7);
ds_horarios_w			varchar(2000);
ds_observacao_w			varchar(4000);
ds_observacao_enf_w		varchar(2000);
ie_via_aplicacao_w		varchar(5);
nr_agrupamento_w		double precision;
ie_cobra_paciente_w		varchar(1);
cd_motivo_baixa_w		smallint;	
dt_baixa_w			timestamp;
ie_utiliza_kit_w		varchar(1);	
cd_unidade_medida_dose_w	varchar(30);	
qt_conversao_dose_w		double precision;
ie_urgencia_w			varchar(1);
nr_ocorrencia_w			double precision;
qt_total_dispensar_w		double precision;
cd_fornec_consignado_w		varchar(14);
nr_sequencia_solucao_w		integer;
nr_sequencia_proc_w		integer;
qt_solucao_w			double precision;
hr_dose_especial_w		varchar(5);	
qt_dose_especial_w		double precision;
ds_dose_diferenciada_w		varchar(50);
ie_medicacao_paciente_w		varchar(1);
nr_sequencia_diluicao_w		integer;
hr_prim_horario_w		varchar(5);
nr_sequencia_dieta_w		integer;
ie_agrupador_w			smallint;
nr_dia_util_w			bigint;
ie_suspenso_w			varchar(1);
ie_se_necessario_w		varchar(1);
qt_min_aplicacao_w		smallint;
ie_bomba_infusao_w		varchar(1);
ie_aplic_bolus_w		varchar(1);
ie_aplic_lenta_w		varchar(1);
ie_acm_w			varchar(1);
ie_objetivo_w			varchar(1);
cd_topografia_cih_w		bigint;
ie_origem_infeccao_w		varchar(1);
cd_amostra_cih_w		bigint;
cd_microorganismo_cih_w		bigint;
ie_uso_antimicrobiano_w		varchar(1);
cd_protocolo_w			bigint;
nr_seq_protocolo_w		integer;
nr_seq_mat_protocolo_w		integer;
qt_hora_aplicacao_w		smallint;
ie_recons_diluente_fixo_w	varchar(1);
qt_vel_infusao_w		double precision;
ds_justificativa_w		varchar(2000);
ie_sem_aprazamento_w		varchar(1);
ie_indicacao_w			varchar(1);
dt_proxima_dose_w		timestamp;
qt_total_dias_lib_w		integer;
nr_seq_substituto_w		integer;
ie_lado_w			varchar(1);
dt_inicio_medic_w		timestamp;
qt_dia_prim_hor_w		bigint;
ie_regra_disp_w			varchar(1);
qt_vol_adic_reconst_w		double precision;
qt_hora_intervalo_w		smallint;
qt_min_intervalo_w		integer;
dt_inicio_prescr_w		timestamp;
dt_validade_prescr_w		timestamp;
nr_prescr_estendido_w		bigint;
cd_pessoa_fisica_w		varchar(10);
dt_suspensao_progr_w		timestamp;
nr_prescricao_original_w	bigint;
nr_seq_anterior_w		integer;
qt_inconsistencia_w		bigint;
dt_prim_horario_int_w		timestamp;
nr_horas_validade_w		integer;
dt_prescricao_w			timestamp;
dt_primeiro_horario_w		timestamp;
ie_regra_geral_w		varchar(10);
ds_horarios2_w			varchar(2000);
ie_operacao_w			intervalo_prescricao.ie_operacao%type;
cd_estabelecimento_w	smallint;
ds_erro_w				varchar(255);
ds_horarios_ww			prescr_material.ds_horarios%type;
ie_manter_intervalo_w	rep_regra_copia_crit.ie_manter_intervalo%type;
dt_ultimo_horario_w		timestamp;
hr_prim_horario_aux_w	varchar(5);
nr_ocorrencia_aux_w		double precision;
dt_prim_hor_aux_w		timestamp;


c01 CURSOR FOR
	SELECT	coalesce(ie_regra_geral,'H'),
			coalesce(ie_manter_intervalo,'N')
	from	rep_regra_copia_crit
	where	nr_seq_regra	= nr_seq_regra_p
	and	ie_tipo_item	= 'SUP'
	and (coalesce(ie_se_necessario,'S') = 'S' 	or coalesce(ie_se_necessario_w,'N') <> 'S')
	and (coalesce(ie_acm,'S') = 'S' 			or coalesce(ie_acm_w,'N') <> 'S')
	and (coalesce(ie_agora,'S') = 'S' 		or coalesce(ie_urgencia_w,'N') <> 'S')
	and	ie_copiar = 'S'
	order by nr_seq_apres;


BEGIN

ds_lista_w	:= ds_lista_p;

select	coalesce(max(nr_agrupamento),0) + 1
into STRICT	nr_agrup_acum_w
from	prescr_material
where	nr_prescricao = nr_prescricao_p;

select	max(dt_inicio_prescr),
	max(dt_validade_prescr),
	max(dt_prescricao),
	max(nr_horas_validade),
	max(dt_primeiro_horario),
	coalesce(max(cd_estabelecimento),1)
into STRICT	dt_inicio_prescr_w,
	dt_validade_prescr_w,
	dt_prescricao_w,
	nr_horas_validade_w,
	dt_primeiro_horario_w,
	cd_estabelecimento_w
from	prescr_medica
where	nr_prescricao = nr_prescricao_p  LIMIT 1;


while (ds_lista_w IS NOT NULL AND ds_lista_w::text <> '') loop
	begin
	tam_lista_w		:= length(ds_lista_w);
	ie_pos_virgula_w	:= position(',' in ds_lista_w);
	ds_prescricao_w		:= substr(ds_lista_w,1,(ie_pos_virgula_w - 1));
	ie_pos_espaco_w		:= position(' ' in ds_prescricao_w);
	tam_prescricao_w	:= length(ds_prescricao_w);
	nr_prescr_lista_w	:= (substr(ds_prescricao_w,1,(ie_pos_espaco_w - 1)))::numeric;
	nr_seq_lista_w		:= (substr(ds_prescricao_w,(ie_pos_espaco_w + 1), tam_prescricao_w))::numeric;
	
	CALL PLT_consiste_extensao_item(dt_inicio_prescr_w, dt_validade_prescr_w, nr_prescr_lista_w, nr_seq_lista_w, 'S', nr_seq_regra_p, nm_usuario_p, cd_perfil_p, cd_estabelecimento_p);

	select	count(nr_sequencia)
	into STRICT	qt_inconsistencia_w
	from	w_copia_plano
	where	nr_prescricao	= nr_prescr_lista_w
	and	nr_seq_item	= nr_seq_lista_w
	and	ie_tipo_item	= 'S'
	and	nm_usuario	= nm_usuario_p
	and	((ie_permite	= 'N') or (ie_estende_inc_p = 'N'))  LIMIT 1;
	
	if	((qt_inconsistencia_w	= 0) or (ie_modificar_p 	= 'S')) then

		if (nr_prescr_lista_w <> nr_prescr_ant_w) and (nr_prescr_ant_w IS NOT NULL AND nr_prescr_ant_w::text <> '') then
			select	max(nr_agrupamento) + 1
			into STRICT	nr_agrup_acum_w
			from	prescr_material
			where	nr_prescricao	= nr_prescricao_p;
		end if;

		select	coalesce(max(nr_sequencia),0) + 1
		into STRICT	nr_sequencia_w
		from	prescr_material
		where	nr_prescricao = nr_prescricao_p;
		
		select  a.ie_origem_inf,
			a.cd_material,
			a.cd_unidade_medida,
			a.qt_dose,
			a.qt_unitaria,
			a.qt_material,
			a.cd_intervalo,
			a.ds_horarios,
			a.ds_observacao,
			a.ds_observacao_enf,
			a.ie_via_aplicacao,
			a.nr_agrupamento,
			coalesce(a.ie_cobra_paciente,'S'),
			CASE WHEN coalesce(a.ie_regra_disp,'X')='D' THEN  a.cd_motivo_baixa  ELSE CASE WHEN coalesce(a.ie_cobra_paciente,'S')='S' THEN  0  ELSE a.cd_motivo_baixa END  END  cd_motivo_baixa,
			CASE WHEN coalesce(a.ie_regra_disp,'X')='D' THEN  clock_timestamp()  ELSE CASE WHEN coalesce(a.ie_cobra_paciente,'S')='S' THEN  null  ELSE clock_timestamp() END  END  dt_baixa,
			a.ie_utiliza_kit,
			a.cd_unidade_medida_dose,
			a.qt_conversao_dose,
			'N' ie_urgencia,
			a.nr_ocorrencia,
			a.qt_total_dispensar,
			a.cd_fornec_consignado,
			a.nr_sequencia_solucao,
			a.nr_sequencia_proc,
			a.qt_solucao,
			null hr_dose_especial,
			null qt_dose_especial,
			a.ds_dose_diferenciada,
			a.ie_medicacao_paciente,
			a.nr_sequencia_diluicao,
			CASE WHEN a.ie_se_necessario='S' THEN  null  ELSE a.hr_prim_horario END  hr_prim_horario,
			CASE WHEN coalesce(a.nr_sequencia_dieta::text, '') = '' THEN null  ELSE a.nr_sequencia_dieta END  nr_sequencia_dieta,
			a.ie_agrupador,
			a.nr_dia_util,
			CASE WHEN b.ie_situacao='A' THEN  'N'  ELSE 'S' END   ie_suspenso,
			a.ie_se_necessario,
			a.qt_min_aplicacao,
			a.ie_bomba_infusao,
			coalesce(a.ie_aplic_bolus,'N') ie_aplic_bolus,
			coalesce(a.ie_aplic_lenta,'N') ie_aplic_lenta,
			coalesce(a.ie_acm,'N') ie_acm,
			a.ie_objetivo,
			a.cd_topografia_cih,
			a.ie_origem_infeccao,
			a.cd_amostra_cih,
			a.cd_microorganismo_cih,
			coalesce(a.ie_uso_antimicrobiano,'N') ie_uso_antimicrobiano,
			a.cd_protocolo,
			a.nr_seq_protocolo,
			a.nr_seq_mat_protocolo,
			a.qt_hora_aplicacao,
			'N' ie_recons_diluente_fixo,
			a.qt_vel_infusao,
			a.ds_justificativa,
			a.ie_sem_aprazamento,
			a.ie_indicacao,
			a.dt_proxima_dose,
			a.qt_total_dias_lib,
			a.nr_seq_substituto,
			a.ie_lado,
			a.dt_inicio_medic,
			a.qt_dia_prim_hor,
			CASE WHEN coalesce(a.ie_regra_disp,'X')='D' THEN  a.ie_regra_disp  ELSE null END  ie_regra_disp,
			a.qt_vol_adic_reconst,
			a.qt_hora_intervalo,
			a.qt_min_intervalo,
			a.dt_suspensao_progr,
			coalesce(a.nr_prescricao_original,a.nr_prescricao),
			coalesce(a.nr_seq_anterior,a.nr_sequencia)
		into STRICT	ie_origem_inf_w,
			cd_material_w,
			cd_unidade_medida_w,
			qt_dose_w,
			qt_unitaria_w,
			qt_material_w,
			cd_intervalo_w,
			ds_horarios_w,
			ds_observacao_w,
			ds_observacao_enf_w,
			ie_via_aplicacao_w,
			nr_agrupamento_w,
			ie_cobra_paciente_w,
			cd_motivo_baixa_w,
			dt_baixa_w,
			ie_utiliza_kit_w,
			cd_unidade_medida_dose_w,
			qt_conversao_dose_w,
			ie_urgencia_w,
			nr_ocorrencia_w,
			qt_total_dispensar_w,
			cd_fornec_consignado_w,
			nr_sequencia_solucao_w,
			nr_sequencia_proc_w,
			qt_solucao_w,
			hr_dose_especial_w,
			qt_dose_especial_w,
			ds_dose_diferenciada_w,
			ie_medicacao_paciente_w,
			nr_sequencia_diluicao_w,
			hr_prim_horario_w,
			nr_sequencia_dieta_w,
			ie_agrupador_w,
			nr_dia_util_w,
			ie_suspenso_w,
			ie_se_necessario_w,
			qt_min_aplicacao_w,
			ie_bomba_infusao_w,
			ie_aplic_bolus_w,
			ie_aplic_lenta_w,
			ie_acm_w,
			ie_objetivo_w,
			cd_topografia_cih_w,
			ie_origem_infeccao_w,
			cd_amostra_cih_w,
			cd_microorganismo_cih_w,
			ie_uso_antimicrobiano_w,
			cd_protocolo_w,
			nr_seq_protocolo_w,
			nr_seq_mat_protocolo_w,
			qt_hora_aplicacao_w,
			ie_recons_diluente_fixo_w,
			qt_vel_infusao_w,
			ds_justificativa_w,
			ie_sem_aprazamento_w,
			ie_indicacao_w,
			dt_proxima_dose_w,
			qt_total_dias_lib_w,
			nr_seq_substituto_w,
			ie_lado_w,
			dt_inicio_medic_w,
			qt_dia_prim_hor_w,
			ie_regra_disp_w,
			qt_vol_adic_reconst_w,
			qt_hora_intervalo_w,
			qt_min_intervalo_w,
			dt_suspensao_progr_w,
			nr_prescricao_original_w,
			nr_seq_anterior_w
		From	Material b,
			Prescr_Material a
		where	a.nr_prescricao = nr_prescr_lista_w
		and	a.nr_sequencia	= nr_seq_lista_w
		and	a.cd_material 	= b.cd_material;
		
		select	count(*)
		into STRICT	qt_w
		From	Material b,
			Prescr_Material a
		where	a.nr_prescricao = nr_prescr_lista_w
		and	a.nr_sequencia	= nr_seq_lista_w
		and	a.cd_material 	= b.cd_material
		and	((coalesce(ie_copia_agora_p,'S')	= 'S') or
			((ie_copia_agora_p = 'N') and (coalesce(a.ie_urgencia,'N') = 'N')))  LIMIT 1;
		
		select	max(ie_operacao)
		into STRICT	ie_operacao_w
		from 	intervalo_prescricao
		where 	cd_intervalo = cd_intervalo_w;
		
		if (qt_w > 0) then
		
			open C01;
			loop
			fetch C01 into	
				ie_regra_geral_w,
				ie_manter_intervalo_w;
			EXIT WHEN NOT FOUND; /* apply on C01 */
				begin
				ie_regra_geral_w := ie_regra_geral_w;
				ie_manter_intervalo_w := ie_manter_intervalo_w;
				end;
			end loop;
			close C01;
			
			ds_horarios_ww := ds_horarios_w;
			
			if (ie_regra_geral_w = 'I') and (obter_se_intervalo_agora(cd_intervalo_w) = 'N') then
				hr_prim_horario_w := null;
				ds_horarios_w := reordenar_horarios(dt_inicio_prescr_w, ds_horarios_w);
			
				hr_prim_horario_w	:= coalesce(Obter_prim_DsHorarios(ds_horarios_w),to_char(dt_inicio_prescr_w,'hh24:mi'));
			else
				nr_ocorrencia_w		:= 0;
				
				if (ie_operacao_w in ('F','V')) then
					hr_prim_horario_w := obter_primeiro_horario(cd_intervalo_w,nr_prescricao_p,cd_material_w,ie_via_aplicacao_w);
				elsif (ie_manter_intervalo_w = 'N') then
				
					dt_ultimo_horario_w	:= PLT_obter_ultimo_horario(nr_prescr_lista_w, nr_seq_lista_w, 'S', nm_usuario_p);

					if (dt_ultimo_horario_w IS NOT NULL AND dt_ultimo_horario_w::text <> '') and
						(dt_ultimo_horario_w > (clock_timestamp() - interval '1 days')) then
						nr_ocorrencia_aux_w	:= Obter_ocorrencia_intervalo(cd_intervalo_w, coalesce(nr_horas_validade_w,24),'H')/ 24;
						dt_prim_hor_aux_w	:= dt_ultimo_horario_w + nr_ocorrencia_aux_w;
						if (dt_prim_hor_aux_w	< dt_inicio_prescr_w) and (dt_inicio_prescr_w	< (clock_timestamp() + interval '1 days')) then
							WHILE dt_prim_hor_aux_w < dt_inicio_prescr_w
								LOOP
								   dt_prim_hor_aux_w	:= dt_prim_hor_aux_w + nr_ocorrencia_aux_w;
								END LOOP;
						end if;
						hr_prim_horario_aux_w	:= to_char(dt_prim_hor_aux_w,'hh24:mi');
						if (hr_prim_horario_aux_w <> '  :  ') and (hr_prim_horario_aux_w IS NOT NULL AND hr_prim_horario_aux_w::text <> '') then
							hr_prim_horario_w	:= hr_prim_horario_aux_w;
						end if;							
					end if;
				end if;

				dt_prim_horario_int_w	:= converte_char_data(to_char(dt_primeiro_horario_w,'dd/mm/yyyy'),hr_prim_horario_w ||':00',dt_primeiro_horario_w);
				
				SELECT * FROM calcular_horario_prescricao(nr_prescricao_p, cd_intervalo_w, dt_prim_horario_int_w, coalesce(dt_prim_horario_int_w, dt_primeiro_horario_w), nr_horas_validade_w, cd_material_w, qt_hora_intervalo_w, qt_min_intervalo_w, nr_ocorrencia_w, ds_horarios_w, ds_horarios2_w, 'N', ds_dose_diferenciada_w) INTO STRICT nr_ocorrencia_w, ds_horarios_w, ds_horarios2_w;
								
				ds_horarios_w := ds_horarios_w || ds_horarios2_w;
			end if;
			
			ds_horarios_w := Eliminar_horarios_vigencia(ds_horarios_w, cd_intervalo_w, dt_inicio_prescr_w, dt_inicio_prescr_w, qt_hora_intervalo_w, qt_min_intervalo_w, nr_prescricao_p);
			
			if (coalesce(ds_horarios_w::text, '') = '') and (ds_horarios_ww IS NOT NULL AND ds_horarios_ww::text <> '') and (coalesce(ie_regra_geral_w,'XPTO') <> 'I') and (ie_operacao_w not in ('F','V')) then
			
			    nr_ocorrencia_w		:= 0;
				
				SELECT * FROM calcular_horario_prescricao(nr_prescricao_p, cd_intervalo_w, dt_primeiro_horario_w, dt_primeiro_horario_w, nr_horas_validade_w, cd_material_w, qt_hora_intervalo_w, qt_min_intervalo_w, nr_ocorrencia_w, ds_horarios_w, ds_horarios2_w, 'N', ds_dose_diferenciada_w) INTO STRICT nr_ocorrencia_w, ds_horarios_w, ds_horarios2_w;
								
				ds_horarios_w := ds_horarios_w || ds_horarios2_w;
				
				ds_horarios_w := Eliminar_horarios_vigencia(ds_horarios_w, cd_intervalo_w, dt_inicio_prescr_w, dt_inicio_prescr_w, qt_hora_intervalo_w, qt_min_intervalo_w, nr_prescricao_p);
			
				if (ds_horarios_w IS NOT NULL AND ds_horarios_w::text <> '') then
					hr_prim_horario_w	:= coalesce(Obter_prim_DsHorarios(ds_horarios_w),to_char(dt_inicio_prescr_w,'hh24:mi'));
				end if;
			end if;
			
			if (hr_prim_horario_w <> '')	then
				dt_prim_horario_int_w 	:= converte_char_data(to_char(dt_prescricao_w,'dd/mm/yyyy'),hr_prim_horario_w ||':00',null);
			end if;
			
			insert  into prescr_material(
					nr_prescricao,
					nr_sequencia,
					ie_origem_inf,
					cd_material,
					cd_unidade_medida,
					qt_dose,
					qt_unitaria,
					qt_material,
					dt_atualizacao,
					nm_usuario,
					cd_intervalo,
					ds_horarios,
					ds_observacao,
					ds_observacao_enf,
					ie_via_aplicacao,
					nr_agrupamento,
					ie_cobra_paciente,
					cd_motivo_baixa,
					dt_baixa,
					ie_utiliza_kit,
					cd_unidade_medida_dose,
					qt_conversao_dose,
					ie_urgencia,
					nr_ocorrencia,
					qt_total_dispensar,
					cd_fornec_consignado,
					nr_sequencia_solucao,
					nr_sequencia_proc,
					qt_solucao,
					hr_dose_especial,
					qt_dose_especial,
					ds_dose_diferenciada,
					ie_medicacao_paciente,
					nr_sequencia_diluicao,
					hr_prim_horario,
					nr_sequencia_dieta,
					ie_agrupador,
					nr_dia_util,
					ie_suspenso,
					ie_se_necessario,
					qt_min_aplicacao,
					ie_bomba_infusao,
					ie_aplic_bolus,
					ie_aplic_lenta,
					ie_acm,
					ie_objetivo,
					cd_topografia_cih,
					ie_origem_infeccao,
					cd_amostra_cih,
					cd_microorganismo_cih,
					ie_uso_antimicrobiano,
					cd_protocolo,
					nr_seq_protocolo,
					nr_seq_mat_protocolo,
					qt_hora_aplicacao,
					ie_recons_diluente_fixo,
					qt_vel_infusao,
					ds_justificativa,
					ie_sem_aprazamento,
					ie_indicacao,
					dt_proxima_dose,
					qt_total_dias_lib,
					nr_seq_substituto,
					ie_lado,
					dt_inicio_medic,
					qt_dia_prim_hor,
					ie_regra_disp,
					qt_vol_adic_reconst,
					qt_hora_intervalo,
					qt_min_intervalo,
					dt_suspensao_progr,
					nr_prescricao_original,
					nr_seq_anterior)
			values (		nr_prescricao_p,
					nr_sequencia_w,
					ie_origem_inf_w,
					cd_material_w,
					cd_unidade_medida_w,
					qt_dose_w,
					qt_unitaria_w,
					qt_material_w,
					clock_timestamp(),
					nm_usuario_p,
					cd_intervalo_w,
					ds_horarios_w,
					ds_observacao_w,
					ds_observacao_enf_w,
					ie_via_aplicacao_w,
					nr_agrupamento_w + nr_agrup_acum_w,
					ie_cobra_paciente_w,
					cd_motivo_baixa_w,
					dt_baixa_w,
					ie_utiliza_kit_w,
					cd_unidade_medida_dose_w,
					qt_conversao_dose_w,
					ie_urgencia_w,
					nr_ocorrencia_w,
					qt_total_dispensar_w,
					cd_fornec_consignado_w,
					nr_sequencia_solucao_w,
					nr_sequencia_proc_w,
					qt_solucao_w,
					hr_dose_especial_w,
					qt_dose_especial_w,
					ds_dose_diferenciada_w,
					ie_medicacao_paciente_w,
					nr_sequencia_diluicao_w,
					hr_prim_horario_w,
					nr_sequencia_dieta_w,
					ie_agrupador_w,
					nr_dia_util_w,
					ie_suspenso_w,
					ie_se_necessario_w,
					qt_min_aplicacao_w,
					ie_bomba_infusao_w,
					ie_aplic_bolus_w,
					ie_aplic_lenta_w,
					ie_acm_w,
					ie_objetivo_w,
					cd_topografia_cih_w,
					ie_origem_infeccao_w,
					cd_amostra_cih_w,
					cd_microorganismo_cih_w,
					ie_uso_antimicrobiano_w,
					cd_protocolo_w,
					nr_seq_protocolo_w,
					nr_seq_mat_protocolo_w,
					qt_hora_aplicacao_w,
					ie_recons_diluente_fixo_w,
					qt_vel_infusao_w,
					ds_justificativa_w,
					ie_sem_aprazamento_w,
					ie_indicacao_w,
					dt_proxima_dose_w,
					qt_total_dias_lib_w,
					nr_seq_substituto_w,
					ie_lado_w,
					dt_inicio_medic_w,
					qt_dia_prim_hor_w,
					ie_regra_disp_w,
					qt_vol_adic_reconst_w,
					qt_hora_intervalo_w,
					qt_min_intervalo_w,
					dt_suspensao_progr_w,
					nr_prescricao_original_w,
					nr_seq_anterior_w);
					
					SELECT * FROM Obter_Quant_Dispensar(cd_estabelecimento_w, cd_material_w, nr_prescricao_p, nr_sequencia_w, cd_intervalo_w, ie_via_aplicacao_w, qt_unitaria_w, 0, nr_ocorrencia_w, ds_dose_diferenciada_w, ie_origem_inf_w, cd_unidade_medida_dose_w, 1, qt_material_w, qt_total_dispensar_w, ie_regra_disp_w, ds_erro_w, ie_se_necessario_w, ie_acm_w) INTO STRICT qt_material_w, qt_total_dispensar_w, ie_regra_disp_w, ds_erro_w;

					update	prescr_material
					set 	nr_ocorrencia	= nr_ocorrencia_w,
							qt_total_dispensar	= qt_total_dispensar_w,
							qt_material		= coalesce(qt_material_w,1),		
							ie_regra_disp	= CASE WHEN coalesce(ie_regra_disp,'X')='D' THEN  ie_regra_disp  ELSE ie_regra_disp_w END
					where	nr_prescricao 	= nr_prescricao_p
					and	nr_sequencia		= nr_sequencia_w;
					
			if (coalesce(wheb_usuario_pck.get_ie_commit, 'S') = 'S') then commit; end if;	

		end if;
	
	end if;
	
	nr_prescr_ant_w			:= nr_prescr_lista_w;
	ds_lista_w			:= substr(ds_lista_w,(ie_pos_virgula_w + 1),tam_lista_w);	
	end;
end loop;	

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE plt_copia_suplemento ( nr_prescricao_p bigint, nr_seq_regra_p bigint, ds_lista_p text, ie_modificar_p text, nm_usuario_p text, cd_perfil_p bigint, cd_estabelecimento_p bigint, ie_estende_inc_p text, ie_copia_agora_p text) FROM PUBLIC;

