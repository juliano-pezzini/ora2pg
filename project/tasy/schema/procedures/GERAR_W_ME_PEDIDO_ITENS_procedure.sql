-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_w_me_pedido_itens ( nr_seq_pedido_p bigint, codigoproduto_p text, numerorequisicao_p text, prazoentrega_p timestamp, quantidade_p text, valorunitario_p text, percentualdesconto_p text, percentualipi_p text, valornormal_p text, codigounidade_p text, observacao_p text, fabricante_p text, nm_usuario_p text, ds_lista_req_p text, ie_ajusta_diferenca_p text, nr_seq_pedido_item_p INOUT bigint) AS $body$
DECLARE


nr_seq_me_pedido_itens_w	bigint;
prazoentrega_w			timestamp;
numerorequisicao_w		varchar(15);
quantidade_w			double precision;
qt_material_w			double precision;
qt_total_solicitacoes_w		double precision;
qt_fator_w			double precision;
qt_diferenca_w			double precision;
observacao_w			varchar(2000);
cd_material_w			material.cd_material%type;
cd_estabelecimento_w		solic_compra.nr_solic_compra%type;
nr_solic_compra_w		bigint;
ds_lista_solic_ww		varchar(4000);
ds_lista_solic_w		varchar(4000);
nr_pedido_w				w_me_pedido.numeropedidowpd%type;


BEGIN


prazoentrega_w := prazoentrega_p;
quantidade_w := quantidade_p;

select	substr(numerorequisicao_p||'@',1,position('@' in numerorequisicao_p||'@')-1)
into STRICT	nr_solic_compra_w
;

/*substitui o # por , */

select	replace(numerorequisicao_p,'#',',')
into STRICT	ds_lista_solic_w
;

/*Busca os numeros separados por virgula*/

select	somente_numero_virg_char(replace(ds_lista_solic_w,'#',','))
into STRICT	ds_lista_solic_ww
;

select	max(cd_estabelecimento)
into STRICT	cd_estabelecimento_w
from	solic_compra
where	nr_solic_compra = nr_solic_compra_w;

select	coalesce(obter_cod_int_material(codigoproduto_p,'ME',cd_estabelecimento_w),0)
into STRICT	cd_material_w
;

if (cd_material_w IS NOT NULL AND cd_material_w::text <> '') and (coalesce(position(',' in ds_lista_req_p),0) > 0) then
	select	sum(qt_material)
	into STRICT	qt_material_w
	from	solic_compra_item
	where	obter_se_contido(nr_solic_compra, ds_lista_solic_ww) = 'S'
	and	cd_material = cd_material_w;

	select	sum(qt_material)
	into STRICT	qt_total_solicitacoes_w
	from	solic_compra_item
	where	obter_se_contido(nr_solic_compra, ds_lista_solic_ww) = 'S'
	and	cd_material = cd_material_w;

	qt_fator_w := quantidade_w / qt_total_solicitacoes_w;
	quantidade_w := qt_material_w * qt_fator_w;
	observacao_w := wheb_mensagem_pck.get_texto(795204,'QUANTIDADE_P='|| coalesce(quantidade_p,-1) ||';QUANTIDADE_W='|| coalesce(quantidade_w,-1));
	quantidade_w := quantidade_w;
end if;

select max(numeropedidowpd)
into STRICT nr_pedido_w
from w_me_pedido
where nr_sequencia = nr_seq_pedido_p;

CALL inserir_log_me('SC', substr(nr_pedido_w||'@',1,position('@' in nr_pedido_w||'@')-1), 'AVISO', 'ROC', (WHEB_MENSAGEM_PCK.get_texto(1057355) || ' ' || nr_pedido_w), '146', nm_usuario_p,'');
/* Itens da ordem/solicitação de compra */

select	nextval('w_me_pedido_itens_seq')
into STRICT	nr_seq_me_pedido_itens_w
;

insert into w_me_pedido_itens(
	nr_sequencia,
	dt_atualizacao,
	nm_usuario,
	dt_atualizacao_nrec,
	nm_usuario_nrec,
	nr_seq_pedido,
	codigoproduto,
	numerorequisicao,
	prazoentrega,
	quantidade,
	valorunitario,
	percentualdesconto,
	percentualipi,
	valornormal,
	codigounidade,
	observacao,
	fabricante)
values (	nr_seq_me_pedido_itens_w,
	clock_timestamp(),
	nm_usuario_p,
	clock_timestamp(),
	nm_usuario_p,
	nr_seq_pedido_p,
	codigoproduto_p,
	nr_solic_compra_w,
	prazoentrega_w,
	quantidade_w,
	valorunitario_p,
	percentualdesconto_p,
	percentualipi_p,
	valornormal_p,
	codigounidade_p,
	observacao_p,
	fabricante_p);

nr_seq_pedido_item_p := nr_seq_me_pedido_itens_w;

if (ie_ajusta_diferenca_p = 'S') and (cd_material_w IS NOT NULL AND cd_material_w::text <> '') and (coalesce(position(',' in ds_lista_req_p),0) > 0) then
	select	sum(quantidade)
	into STRICT	qt_total_solicitacoes_w
	from	w_me_pedido_itens
	where	obter_se_contido(numerorequisicao, ds_lista_solic_ww) = 'S'
	and	codigoproduto = codigoproduto_p;

	qt_diferenca_w := coalesce(quantidade_p - qt_total_solicitacoes_w,0);

	if (qt_diferenca_w <> 0) then
		update	w_me_pedido_itens
		set	quantidade = quantidade + qt_diferenca_w
		where	nr_sequencia = nr_seq_me_pedido_itens_w;
	end if;
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_w_me_pedido_itens ( nr_seq_pedido_p bigint, codigoproduto_p text, numerorequisicao_p text, prazoentrega_p timestamp, quantidade_p text, valorunitario_p text, percentualdesconto_p text, percentualipi_p text, valornormal_p text, codigounidade_p text, observacao_p text, fabricante_p text, nm_usuario_p text, ds_lista_req_p text, ie_ajusta_diferenca_p text, nr_seq_pedido_item_p INOUT bigint) FROM PUBLIC;

