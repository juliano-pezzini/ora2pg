-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_oc_cta_aplic_fil_pad ( dados_consistencia_p pls_tipos_ocor_pck.dados_consistencia, dados_regra_p pls_tipos_ocor_pck.dados_regra, dados_forma_geracao_ocor_p pls_tipos_ocor_pck.dados_forma_geracao_ocor, ie_incidencia_regra_p text, nr_id_transacao_p pls_selecao_ocor_cta.nr_id_transacao%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nm_usuario_p usuario.nm_usuario%type) AS $body$
DECLARE

			 
/* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ 
Finalidade: Responsável por aplicar os filtros padrões em regras que não utilizarem fitros. 
------------------------------------------------------------------------------------------------------------------- 
Locais de chamada direta: 
[X] Objetos do dicionário [ ] Tasy (Delphi/Java) [ ] Portal [ ] Relatórios [ ] Outros: 
 ------------------------------------------------------------------------------------------------------------------ 
Pontos de atenção: 
Cuidar com os ALIAS... Dar nome padronizado, para facilitar identificação e não repetir.. 
 
 
 
ATENÇÃO!!!!!!!!!! ESTA FUNCTION ESTÁ EM PROCESSO DE REESTRTURAÇÃO. FAVOR FALAR COM JEAN\ DÉCIO ANTES DE ALTERÁ-LA 
 
 
 
Alterações: 
------------------------------------------------------------------------------------------------------------------ 
jjung OS 602057 18/06/2013 - 
 
Alteração:	Foi incluído parâmetro na procedure pls_tipos_ocor_pck.gerencia_selecao_registros 
	para utilizar retorno da function pls_tipos_ocor_pck.obter_se_valido. 
	 
Motivo:	A lógica deste tratamento foi removida da procedure de gerenciamento de selecao dos registros 
	para que evitasse problemas e confusão nas validações. 
------------------------------------------------------------------------------------------------------------------ 
jjung OS 604666 - 29/07/2013 - 
 
Alteração:	Substituído rotinas de manipulação de restrições e selects dinâmicos para as novas: 
	PLS_OC_CTA_MONTAR_SEL_PAD e PLS_OC_CTA_OBTER_RESTR_PADRAO. 
	 
Motivo:	Surgiu a necessidade de separar as restrições devido a criação de reconsistência das ocorrências 
	durante ações no processo de análise. Como deparamos com um cenário diferente do anterior 
	decidimos que seriam criadas novas rotinas para não estragarmos o estado atual e para que pudéssemos 
	atender da melhor forma as novas necessidades das ocorrências. 
------------------------------------------------------------------------------------------------------------------ 
jjung OS 651768 - 15/10/2013 - 
 
Alteração:	Implementação da manutenção da tabela de seleção através de arrays para executar as 
	alterações em todos os registros de uma vez. 
	 
Motivo:	Foi identificado a possibilidade de um ganho de performance para execução de manutenções 
	da tabela PLS_SELECAO_OCOR_CTA, que sofre muitas alterações durante a consistência 
	das ocorrências. 
------------------------------------------------------------------------------------------------------------------ 
jjung OS 709376 - 03/03/2014 
 
Alteração:	Adicionado parâmetro dados_forma_geracao_p para passar até na pls_oc_cta_obter_restr_padrao 
 
Motivo:	Como no campo Consistência web na regra pode ser informado Ambos o mais correto é tratar 
	pelo evento sendo executado e não pelo evento informado na regra. 
 ------------------------------------------------------------------------------------------------------------------ 
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */
 
 
var_cur_w 		integer;
var_exec_w		integer;
var_retorno_w		integer;

-- Declaração das coleções. É necessário trabalhar com este tipo de dado quando utiliza-se o FORALL, para que 
-- todos os dados da coleção sejam enviados em apenas uma mudança de contexto PL\SQL - SQL e SQL - PL\SQL novamente. 
nr_seq_conta_w		dbms_sql.number_table;
nr_seq_conta_proc_w	dbms_sql.number_table;
nr_seq_conta_mat_w	dbms_sql.number_table;
nr_seq_selecao_w	dbms_sql.clob_table;
ds_observacao_w		dbms_sql.varchar2_table;

ds_select_w		varchar(4000);
dados_restricao_w	pls_tipos_ocor_pck.dados_restricao_select;

qt_cnt_w		integer;
	

BEGIN 
 
-- Deve ser passado uma regra válida para que a alteração seja feita. 
if (dados_regra_p.nr_sequencia IS NOT NULL AND dados_regra_p.nr_sequencia::text <> '') then 
	 
	-- Obter o controle padrão para quantidade de registros que será enviada a cada vez para a tabela de seleção. 
	qt_cnt_w := pls_cta_consistir_pck.qt_registro_transacao_w;
 
	-- Obter o select padrão conforme a incidencia da regra. 
	dados_restricao_w := pls_oc_cta_obter_restr_padrao( 
				'RESTRICAO', dados_consistencia_p, nr_id_transacao_p, dados_regra_p, 
				ie_incidencia_regra_p, null, null, dados_forma_geracao_ocor_p, 
				cd_estabelecimento_p, nm_usuario_p, 'S');
	-- Montar o select padrão juntamente as restrições. 
	ds_select_w := pls_tipos_ocor_pck.montar_select_padrao(	dados_regra_p, null, ie_incidencia_regra_p, 
								dados_restricao_w, nm_usuario_p);
	/* Selecionar todas as contas ou itens, conforme incidência */
 
	var_cur_w := dbms_sql.open_cursor;
	begin 
 
		dbms_sql.parse(var_cur_w, ds_select_w, 1);
 
		-- Atualizar o valor das binds dos selects padrão.																																	 
		dados_restricao_w := pls_oc_cta_obter_restr_padrao( 
						'BINDS', dados_consistencia_p, nr_id_transacao_p, dados_regra_p, 
						ie_incidencia_regra_p, var_cur_w, null, dados_forma_geracao_ocor_p, 
						cd_estabelecimento_p, nm_usuario_p, 'S');
 
		-- Definir para o DBMS_SQL que o retorno do select será preenchido em arrays, definindo a quantidade de linhas que o array terá a cada iteração do loop 
		-- e a posição inicial que estes ocuparão no array. 
		dbms_sql.define_array(var_cur_w, 1, nr_seq_conta_w, qt_cnt_w, 1);
		dbms_sql.define_array(var_cur_w, 2, nr_seq_conta_proc_w, qt_cnt_w, 1);
		dbms_sql.define_array(var_cur_w, 3, nr_seq_conta_mat_w, qt_cnt_w, 1);
		dbms_sql.define_array(var_cur_w, 4, ds_observacao_w, qt_cnt_w, 1);
		 
		-- Executar o select e gravar os dados na tabela de selecao 
		var_exec_w := dbms_sql.execute(var_cur_w);
		loop 
		var_retorno_w := dbms_sql.fetch_rows(var_cur_w);
		 
			-- zerar as listas para que o mesmo valor não seja inserido mais de uma vez na tabela. 
			nr_seq_conta_w.delete;
			nr_seq_conta_proc_w.delete;		
			nr_seq_conta_mat_w.delete;
			ds_observacao_w.delete;
			nr_seq_selecao_w.delete;
		 
			-- Obter as listas que foram populadas. 
			dbms_sql.column_value(var_cur_w, 1, nr_seq_conta_w);
			dbms_sql.column_value(var_cur_w, 2, nr_seq_conta_proc_w);
			dbms_sql.column_value(var_cur_w, 3, nr_seq_conta_mat_w);
			dbms_sql.column_value(var_cur_w, 4, ds_observacao_w);
			 
			-- Insere todos os registros das listas na tabela de seleção em um único insert. 
			pls_tipos_ocor_pck.gerencia_selecao(	nr_id_transacao_p, nr_seq_conta_w , 
								nr_seq_conta_proc_w, nr_seq_conta_mat_w, 
								nr_seq_selecao_w, ds_observacao_w, 'S', 
								nm_usuario_p, 'FP', null, dados_regra_p);
								 
			-- Quando número de linhas que foram aplicadas no array for diferente do definido significa que esta foi a última iteração do loop e que todas as linhas foram 
			-- passadas. 
			exit when var_retorno_w != qt_cnt_w;
		end loop;
		dbms_sql.close_cursor(var_cur_w); -- Itens filtrados para a regra. 
	exception 
	when others then 
		-- Fechar o cursor que foi aberto. 
		if (dbms_sql.is_open(var_cur_w)) then 
		 
			dbms_sql.close_cursor(var_cur_w);
		end if;
		-- Exibir a mensagem padrão para as ocorrências combinadas quando temos algum problema e salvar o log no banco. 
		CALL pls_tipos_ocor_pck.trata_erro_sql_dinamico(dados_regra_p, ds_select_w, nr_id_transacao_p, nm_usuario_p);
	end;
end if;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_oc_cta_aplic_fil_pad ( dados_consistencia_p pls_tipos_ocor_pck.dados_consistencia, dados_regra_p pls_tipos_ocor_pck.dados_regra, dados_forma_geracao_ocor_p pls_tipos_ocor_pck.dados_forma_geracao_ocor, ie_incidencia_regra_p text, nr_id_transacao_p pls_selecao_ocor_cta.nr_id_transacao%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nm_usuario_p usuario.nm_usuario%type) FROM PUBLIC;

