-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE finalizar_baixar_mat_barras ( nr_sequencia_p bigint, nr_prescricao_p bigint, cd_material_p bigint, nr_atendimento_p bigint, ds_observacao_p text, cd_estabelecimento_p bigint, nm_usuario_p text, nr_seq_lote_p bigint) AS $body$
DECLARE




ie_baixa_compl_w		varchar(1);
qt_total_dispensar_w	double precision;
qt_material_w		double precision;
nr_ordem_compra_w	bigint;
ds_lote_fornec_w	varchar(255);

BEGIN

ie_baixa_compl_w := obter_param_usuario(24, 54, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_baixa_compl_w);

if (coalesce(ie_baixa_compl_w, 'N') = 'S') and (coalesce(nr_sequencia_p, 0) > 0) and (coalesce(nr_prescricao_p, 0) > 0) then
	begin

	Select	coalesce(a.qt_total_dispensar, 0),
		coalesce(sum(b.qt_material), 0) qt_material
	into STRICT	qt_total_dispensar_w,
		qt_material_w
	from	material_atend_paciente b,
		prescr_material a
        	 where	a.nr_prescricao		= nr_prescricao_p
         	and	a.nr_sequencia		= nr_sequencia_p
	and	a.nr_prescricao		= b.nr_prescricao
      	and	a.nr_sequencia		= b.nr_sequencia_prescricao
	group by	a.qt_total_dispensar;

	if (qt_total_dispensar_w < qt_material_w) then

		update	prescr_material
		set	dt_baixa		= clock_timestamp(),
			cd_motivo_baixa	= 1,
			nm_usuario	= nm_usuario_p,
			dt_atualizacao	= clock_timestamp()
		where	nr_prescricao	= nr_prescricao_p
		and	nr_sequencia	= nr_sequencia_p
		and	cd_motivo_baixa	= 0;

	end if;

	select	max(a.nr_ordem_compra)
	into STRICT	nr_ordem_compra_w
	from	ordem_compra a,
		ordem_compra_item b
	where	a.nr_atendimento	= b.nr_atendimento
	and	a.nr_atendimento	= nr_atendimento_p
	and	b.cd_material	= cd_material_p;

	if (coalesce(nr_ordem_compra_w, 0) > 0) then
		if (coalesce(nr_seq_lote_p,0) <> 0)	then
			select	ds_lote_fornec
			into STRICT	ds_lote_fornec_w
			from	material_lote_fornec
			where	nr_sequencia = nr_seq_lote_p;
		end if;

		update	ordem_compra_item
		set	ds_observacao	= substr(ds_observacao || ds_observacao_p, 1, 255),
			dt_atualizacao	= clock_timestamp(),
			nm_usuario	= nm_usuario_p
	  	where	nr_ordem_compra	= nr_ordem_compra_w
		and	cd_material	= cd_material_p;

	end if;

	end;
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE finalizar_baixar_mat_barras ( nr_sequencia_p bigint, nr_prescricao_p bigint, cd_material_p bigint, nr_atendimento_p bigint, ds_observacao_p text, cd_estabelecimento_p bigint, nm_usuario_p text, nr_seq_lote_p bigint) FROM PUBLIC;

