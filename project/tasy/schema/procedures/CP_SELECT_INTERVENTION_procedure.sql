-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE cp_select_intervention ( nr_seq_cp_intervention_p bigint, nr_seq_pat_care_plan_p bigint, nr_seq_interv_plan_p bigint, nr_seq_pat_cp_problem_p bigint, nm_usuario_p text, selection_p text, nr_seq_prescr_diag_p bigint DEFAULT NULL, nr_seq_int_pla_diag_p bigint DEFAULT NULL) AS $body$
DECLARE

  nr_seq_pat_cp_interv_plan_w  bigint;
  nr_seq_pat_cp_intervention_w bigint;
  updated_w                    varchar(1);
  c_intervention CURSOR FOR
    SELECT A.nr_sequencia FROM patient_cp_intervention A
    WHERE
      A.nr_seq_pat_care_plan = nr_seq_pat_care_plan_p AND 
      A.nr_seq_cp_intervention = nr_seq_cp_intervention_p
    
UNION

    SELECT A.nr_sequencia FROM patient_cp_intervention A
    WHERE 
        coalesce(A.nr_seq_pat_care_plan,0) = coalesce(nr_seq_pat_care_plan_p,0) AND 
        coalesce(A.nr_seq_cp_intervention,0) = coalesce(nr_seq_cp_intervention_p,0) AND 
        coalesce(A.nr_seq_prescr_diag,0)  = coalesce(nr_seq_prescr_diag_p,0);
BEGIN

  updated_w := 'N';
  FOR r_c_intervention IN c_intervention LOOP

    updated_w := 'S';
    UPDATE patient_cp_intervention
    SET si_selected    = selection_p,
      nm_usuario       = nm_usuario_p,
      dt_atualizacao   = clock_timestamp()
    WHERE nr_sequencia = r_c_intervention.nr_sequencia;
    IF (selection_p    = 'N') THEN

      DELETE FROM pe_prescr_proc WHERE nr_seq_pat_cp_interv = r_c_intervention.nr_sequencia;

    END IF;
  END LOOP;

  nr_seq_pat_cp_interv_plan_w := cp_select_interv_plan(nr_seq_pat_care_plan_p, nr_seq_interv_plan_p, nr_seq_pat_cp_problem_p, nm_usuario_p, 'INSERT', nr_seq_prescr_diag_p, nr_seq_int_pla_diag_p, nr_seq_pat_cp_interv_plan_w);

  IF (updated_w = 'N') THEN

    SELECT nextval('patient_cp_intervention_seq') INTO STRICT nr_seq_pat_cp_intervention_w;

    INSERT INTO patient_cp_intervention(
        dt_atualizacao,
        dt_atualizacao_nrec,
        dt_end,
        dt_release,
        dt_start,
        nm_usuario,
        nm_usuario_nrec,
        si_selected,
        nr_seq_cp_intervention,
        nr_seq_pat_care_plan,
        nr_seq_pat_cp_interv_plan,
        nr_sequencia,
        nr_seq_prescr_diag,
        NR_SEQ_PAT_CP_PROBLEM
      ) VALUES (
        clock_timestamp(),
        clock_timestamp(),
        NULL,
        NULL,
        NULL,
        nm_usuario_p,
        nm_usuario_p,
        SELECTion_p,
        nr_seq_cp_intervention_p,
        nr_seq_pat_care_plan_p,
        nr_seq_pat_cp_interv_plan_w,
        nr_seq_pat_cp_intervention_w,
        nr_seq_prescr_diag_p,
        nr_seq_pat_cp_problem_p
      );
  END IF;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cp_select_intervention ( nr_seq_cp_intervention_p bigint, nr_seq_pat_care_plan_p bigint, nr_seq_interv_plan_p bigint, nr_seq_pat_cp_problem_p bigint, nm_usuario_p text, selection_p text, nr_seq_prescr_diag_p bigint DEFAULT NULL, nr_seq_int_pla_diag_p bigint DEFAULT NULL) FROM PUBLIC;

