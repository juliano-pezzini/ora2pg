-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE consiste_geracao_nota_recusa ( nr_sequencia_p bigint, nm_usuario_p text) AS $body$
DECLARE

 
cd_oper_nf_corresp_w		operacao_nota.cd_oper_nf_corresp%type;
ie_operacao_fiscal_w		operacao_nota.ie_operacao_fiscal%type;
ie_nota_recusa_w		operacao_nota.ie_nota_recusa%type;
ie_recusa_w			operacao_nota.ie_recusa%type;
cd_cfop_inverso_w		natureza_operacao.cd_cfop_inverso%type;
ie_numero_nota_w		serie_nota_fiscal.ie_numero_nota%type;
qt_registros_w			bigint;
cd_estabelecimento_w		nota_fiscal.cd_estabelecimento%type;


BEGIN 
 
select	coalesce(a.ie_nota_recusa,'N'), 
	coalesce(a.cd_oper_nf_corresp,0), 
	coalesce(a.ie_operacao_fiscal,'S'), 
	b.cd_estabelecimento 
into STRICT	ie_nota_recusa_w, 
	cd_oper_nf_corresp_w, 
	ie_operacao_fiscal_w, 
	cd_estabelecimento_w 
from	operacao_nota a, 
	nota_fiscal b 
where	a.cd_operacao_nf = b.cd_operacao_nf	 
and	b.nr_sequencia = nr_sequencia_p;
 
if (ie_nota_recusa_w = 'N') then 
	CALL wheb_mensagem_pck.exibir_mensagem_abort(309285);/*A operação dessa nota fiscal não permite gerar nota de recusa. Verifique o cadastro da operação se o campo "Permite gerar nota de recusa" está marcado.*/
	
end if;
 
if (cd_oper_nf_corresp_w = 0) then 
	CALL wheb_mensagem_pck.exibir_mensagem_abort(309279); /*Favor informar a "Operação correspondente" no cadastro da operação vinculada à esta nota fiscal.*/
end if;
 
if (ie_operacao_fiscal_w <> 'S') then 
	CALL wheb_mensagem_pck.exibir_mensagem_abort(309284); /*Para gerar a nota de recusa, a operação dessa nota deve ser de Saída.*/
end if;
 
if (cd_oper_nf_corresp_w > 0) then 
	select	coalesce(ie_operacao_fiscal,'E'), 
		coalesce(ie_recusa,'N') 
	into STRICT	ie_operacao_fiscal_w, 
		ie_recusa_w 
	from	operacao_nota 
	where	cd_operacao_nf = cd_oper_nf_corresp_w;
		 
	if (ie_operacao_fiscal_w <> 'E') then	 
		CALL wheb_mensagem_pck.exibir_mensagem_abort(309307); /*A operação de recusa deve ser de Entrada. Verifique o cadastro da mesma.*/
	end if;
	 
	if (ie_recusa_w = 'N') then 
		CALL wheb_mensagem_pck.exibir_mensagem_abort(309309); /*Favor identificar no cadastro da operação de recusa que a mesma deve ser uma emissão própria.*/
	end if;
end if;
 
select	coalesce(max(a.cd_cfop_inverso),'0') 
into STRICT	cd_cfop_inverso_w 
from	natureza_operacao a, 
	nota_fiscal b 
where	a.cd_natureza_operacao = b.cd_natureza_operacao 
and	b.nr_sequencia = nr_sequencia_p;
 
if (cd_cfop_inverso_w = '0') then 
	CALL wheb_mensagem_pck.exibir_mensagem_abort(309310); /*Favor cadastrar o CFOP inverso no cadastro da natureza operação dessa nota fiscal. Essa informação é relevante para a geração da nota de recusa.*/
else 
	select	count(*) 
	into STRICT	qt_registros_w 
	from	natureza_operacao 
	where	cd_cfop = cd_cfop_inverso_w 
	and	ie_situacao = 'A';
	 
	if (qt_registros_w = 0) then 
		CALL wheb_mensagem_pck.exibir_mensagem_abort(309312,'CD_CFOP_W='||cd_cfop_inverso_w); /*Não existe nenhuma natureza operação com CFOP = #@CD_CFOP_W#@.*/
	end if;
end if;
 
select	coalesce(max(a.ie_numero_nota),'M') 
into STRICT	ie_numero_nota_w 
from	serie_nota_fiscal a, 
	nota_fiscal b 
where	a.cd_serie_nf = b.cd_serie_nf 
and	b.nr_sequencia = nr_sequencia_p 
and	a.cd_estabelecimento = cd_estabelecimento_w;
 
if (ie_numero_nota_w <> 'S') then 
	CALL wheb_mensagem_pck.exibir_mensagem_abort(309313);
	/*Favor identificar no cadastro da série que a geração do número da nota fiscal seja pelo "Sistema". Dessa forma, ao gerar a nota de recusa o sistema já irá gerar automaticamente o número da nota fiscal de acordo com o último número de nota existente para essa série.*/
 
end if;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE consiste_geracao_nota_recusa ( nr_sequencia_p bigint, nm_usuario_p text) FROM PUBLIC;

