-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE inserir_proc_guia_wint ( nr_atendimento_p bigint default null, nr_seq_ageint_p bigint default null, nr_seq_agepac_p bigint default null, nr_seq_doc_convenio_p text DEFAULT NULL, ds_status_p text DEFAULT NULL, cd_procedimento_tuss_p bigint DEFAULT NULL, cd_variacao_p text DEFAULT NULL, ds_proc_exame_p text DEFAULT NULL, ds_ind_clinica_p text DEFAULT NULL, ds_observacao_p text DEFAULT NULL, qt_procedimento_p bigint DEFAULT NULL, cd_ano_p bigint DEFAULT NULL, nr_crm_p text DEFAULT NULL, nm_usuario_p text DEFAULT NULL, nr_seq_proc_interno_p bigint default null, cd_medico_solicitante_p text default null, ie_gerar_proc_wint_p text default 'N', nr_seq_orcamento_p orcamento_paciente.nr_sequencia_orcamento%type default null) AS $body$
DECLARE


cd_procedimento_w      proc_interno.cd_procedimento%type;
nr_sequencia_w         procedimento_guia_wint.nr_sequencia%type;
nr_seq_exame_w         exame_laboratorio.nr_seq_exame%type;
cd_material_exame_w    material_exame_lab.cd_material_exame%type;
ie_lado_w              regra_proc_interno_integra.ie_lado%type;
nr_seq_topografia_w    regra_proc_interno_integra.nr_seq_topografia%type;
nr_seq_w        	   procedimento_guia_wint.nr_sequencia%type;
nr_seq_contraste_w     procedimento_guia_wint.nr_seq_contraste%type;
nr_crm_w               procedimento_guia_wint.nr_crm%type := nr_crm_p;
cd_procedimento_tuss_w procedimento_guia_wint.cd_procedimento_tuss%type := cd_procedimento_tuss_p;
nr_seq_proc_interno_w  regra_proc_interno_integra.nr_seq_proc_interno%TYPE := nr_seq_proc_interno_p;

procedure INSERIR_PROC_WINT(cd_proc_nr_interno_p bigint) is
	;
BEGIN
		
		select nextval('procedimento_guia_wint_seq')
		into STRICT   nr_sequencia_w
		;
		
		if (coalesce(cd_proc_nr_interno_p::text, '') = '') then
			insert into PROCEDIMENTO_GUIA_WINT(
					nr_atendimento,
					nr_seq_ageint,
					nr_seq_agepac,
					nr_sequencia,
					cd_procedimento_tuss,
					nr_seq_proc_interno,
					ds_status,
					ds_erro,
					ie_gerar,
					dt_atualizacao,
					dt_atualizacao_nrec,
					nm_usuario, 
					nm_usuario_nrec,
					ie_origem_informacao,
                                        nr_sequencia_orcamento)
			values (
					nr_atendimento_p,
					nr_seq_ageint_p,
					nr_seq_agepac_p,
					nr_sequencia_w,
					cd_procedimento_tuss_p,
					nr_seq_proc_interno_p,
					'ERRO',
					wheb_mensagem_pck.get_texto(1184277, coalesce(cd_procedimento_tuss_p, nr_seq_proc_interno_p)),
					'N',
					clock_timestamp(), 
					clock_timestamp(),
					nm_usuario_p, 
					nm_usuario_p,
					'IN',
                                        nr_seq_orcamento_p);
		else
			
			insert into PROCEDIMENTO_GUIA_WINT(
					cd_material,
					cd_procedimento,
					cd_procedimento_tuss,
					cd_variacao,
					ds_ind_clinica,
					ds_observacao,
					ds_proc_exame,
					ds_status,
					dt_atualizacao,
					dt_atualizacao_nrec,
					ie_gerar,
					ie_lado,
					nm_usuario,
					nm_usuario_nrec,
					nr_ano_guia,
					nr_atendimento,
					nr_crm,
					nr_seq_ageint,
					nr_seq_agepac,
					nr_seq_doc_convenio,
					nr_seq_exame,
					nr_seq_proc_interno,
					nr_seq_topografia,
					nr_sequencia,
					qt_procedimento,
					vl_coparticipacao,
					vl_procedimento,
					nr_seq_contraste,
					ie_origem_informacao,
                                        nr_sequencia_orcamento)
				 values (
					cd_material_exame_w,
					cd_procedimento_w,
					cd_procedimento_tuss_w,
					cd_variacao_p,
					ds_ind_clinica_p,
					ds_observacao_p,
					Obter_Desc_Proc_Interno(nr_seq_proc_interno_w),
					ds_status_p,
					clock_timestamp(),
					clock_timestamp(),
					'N',
					ie_lado_w,
					nm_usuario_p,
					nm_usuario_p,
					cd_ano_p,
					nr_atendimento_p,
					nr_crm_w,
					nr_seq_ageint_p,
					nr_seq_agepac_p,
					nr_seq_doc_convenio_p,
					nr_seq_exame_w,
					nr_seq_proc_interno_w,
					nr_seq_topografia_w,
					nr_sequencia_w,
					qt_procedimento_p,
					null,
					null,
					nr_seq_contraste_w,
					'IN',
                                        nr_seq_orcamento_p);
			end if;
		commit;
	end;

BEGIN
	
	select  max(nr_sequencia)
	into STRICT    nr_seq_w
    from    procedimento_guia_wint
    where nr_seq_doc_convenio = nr_seq_doc_convenio_p
    and (coalesce(cd_procedimento_tuss, 0) = coalesce(cd_procedimento_tuss_p, 0) OR coalesce(nr_seq_proc_interno, 0) = coalesce(nr_seq_proc_interno_p, 0))
    and coalesce(nr_atendimento, 0) = coalesce(nr_atendimento_p,0)
    and coalesce(nr_seq_ageint, 0) = coalesce(nr_seq_ageint_p,0)
    and coalesce(nr_seq_agepac, 0) = coalesce(nr_seq_agepac_p,0)
    and coalesce(nr_sequencia_orcamento, 0) = coalesce(nr_seq_orcamento_p, 0)
    and coalesce(ds_erro::text, '') = '';
	
   if (nr_seq_w IS NOT NULL AND nr_seq_w::text <> '') then
   		return;
   end if;
	
	if (ie_gerar_proc_wint_p <> 'S') THEN
		-- converter proc tuss em proc_interno
		SELECT * FROM wint_tuss_proc_interno(
	            nr_atendimento_p, nr_seq_ageint_p, nr_seq_agepac_p, cd_procedimento_tuss_p, null,  --cd_convenio_p
	            null,  --cd_categoria_p
	            null,  --ie_tipo_atendimento_p
	            null,  --cd_estabelecimento_p
	            null,  --cd_tipo_acomodacao_p
	            cd_variacao_p, clock_timestamp(),  --dt_procedimento_p,
	            nr_seq_proc_interno_w, nr_seq_exame_w, cd_material_exame_w, ie_lado_w, nr_seq_topografia_w, nr_seq_contraste_w, nr_seq_orcamento_p) INTO STRICT 
	            nr_seq_proc_interno_w, nr_seq_exame_w, cd_material_exame_w, ie_lado_w, nr_seq_topografia_w, nr_seq_contraste_w;
			
		inserir_proc_wint(nr_seq_proc_interno_w);
			
	else
	
		cd_procedimento_tuss_w := wint_proc_interno_tuss(nr_seq_proc_interno_p, cd_procedimento_tuss_w);

		if (coalesce(nr_crm_w::text, '') = '') then
			nr_crm_w := coalesce(obter_crm_medico(cd_medico_solicitante_p), 999);
		end if;
		
		inserir_proc_wint(cd_procedimento_tuss_w);

	end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE inserir_proc_guia_wint ( nr_atendimento_p bigint default null, nr_seq_ageint_p bigint default null, nr_seq_agepac_p bigint default null, nr_seq_doc_convenio_p text DEFAULT NULL, ds_status_p text DEFAULT NULL, cd_procedimento_tuss_p bigint DEFAULT NULL, cd_variacao_p text DEFAULT NULL, ds_proc_exame_p text DEFAULT NULL, ds_ind_clinica_p text DEFAULT NULL, ds_observacao_p text DEFAULT NULL, qt_procedimento_p bigint DEFAULT NULL, cd_ano_p bigint DEFAULT NULL, nr_crm_p text DEFAULT NULL, nm_usuario_p text DEFAULT NULL, nr_seq_proc_interno_p bigint default null, cd_medico_solicitante_p text default null, ie_gerar_proc_wint_p text default 'N', nr_seq_orcamento_p orcamento_paciente.nr_sequencia_orcamento%type default null) FROM PUBLIC;

