-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE importar_atualizar_pf_cadsus ( nr_seq_interno_p bigint, cd_pessoa_fisica_p text, nm_usuario_p text, cd_pessoa_fisica_new INOUT text ) AS $body$
DECLARE

    ws_rec               cadsus_log_retorno_ws%rowtype;
    count_pessoa_w       smallint;
    cd_pessoa_fisica_w   varchar(10);

BEGIN
    SELECT
        *
    INTO STRICT
        ws_rec
    FROM
        cadsus_log_retorno_ws cs
    WHERE
        cs.nr_sequencia = nr_seq_interno_p;

    SELECT
        COUNT(*)
    INTO STRICT
        count_pessoa_w
    FROM
        pessoa_fisica
    WHERE
        cd_pessoa_fisica = cd_pessoa_fisica_p;

    IF ( count_pessoa_w > 0 )
    THEN
        cd_pessoa_fisica_w := cd_pessoa_fisica_p;
        UPDATE pessoa_fisica
            SET
                nm_pessoa_fisica = ws_rec.nm_pessoa_fisica,
                dt_nascimento = ws_rec.dt_nascimento,
                nr_cartao_nac_sus = ws_rec.nr_cartao_nac_sus,
                nr_cpf = ws_rec.nr_cpf,
                ie_sexo = ws_rec.ie_sexo_paciente,
                nm_social = ws_rec.nm_social,
                nr_seq_cor_pele = ws_rec.nr_seq_cor_pele,
                nr_seq_etnia = ws_rec.nr_seq_etnia,
                dt_naturalizacao_pf = ws_rec.dt_naturalizacao_pf,
                nr_portaria_nat = ws_rec.nr_portaria_nat,
                DT_CHEGADA_BRASIL = ws_rec.dt_entrada_pais,
                cd_nacionalidade = ws_rec.cd_pais,
                nr_ctps = ws_rec.nr_ctps,
                nr_serie_ctps = ws_rec.nr_serie_ctps,
                dt_emissao_ctps = ws_rec.dt_emissao_ctps,
                nr_pis_pasep = ws_rec.nr_pis_pasep,
                nr_ric = ws_rec.nr_ric,
                cd_declaracao_nasc_vivo = ws_rec.cd_declaracao_nasc_vivo,
                nr_ddi_celular = ws_rec.nr_ddi_celular,
                nr_ddd_celular = ws_rec.nr_ddd_celular,
                nr_celular_numeros = ws_rec.nr_celular_numero,
                ds_observacao = ws_rec.ds_observacao,
                dt_obito = ws_rec.dt_obito,
                nm_usuario = ws_rec.nm_usuario_nrec,
                dt_atualizacao = clock_timestamp()
        WHERE
                cd_pessoa_fisica = cd_pessoa_fisica_p;

    ELSE
        SELECT
            nextval('pessoa_fisica_seq')
        INTO STRICT
            cd_pessoa_fisica_w
;

        cd_pessoa_fisica_new := cd_pessoa_fisica_w;
        INSERT INTO pessoa_fisica(
            cd_pessoa_fisica,
            ie_tipo_pessoa,
            nm_pessoa_fisica,
            dt_nascimento,
            nr_cartao_nac_sus,
            nr_cpf,
            ie_sexo,
            nm_social,
            nr_seq_cor_pele,
            nr_seq_etnia,
            dt_naturalizacao_pf,
            nr_portaria_nat,
            dt_chegada_brasil,
            cd_nacionalidade,
            nr_ctps,
            nr_serie_ctps,
            dt_emissao_ctps,
            nr_pis_pasep,
            nr_ric,
            cd_declaracao_nasc_vivo,
            nr_ddi_celular,
            nr_ddd_celular,
            nr_celular_numeros,
            ds_observacao,
            dt_obito,
            dt_cadastro_original,
            dt_atualizacao,
            nm_usuario,
            dt_atualizacao_nrec,
            nm_usuario_nrec
        ) VALUES (
            cd_pessoa_fisica_w,
            2,
            ws_rec.nm_pessoa_fisica,
            ws_rec.dt_nascimento,
            ws_rec.nr_cartao_nac_sus,
            ws_rec.nr_cpf,
            ws_rec.ie_sexo_paciente,
            ws_rec.nm_social,
            ws_rec.nr_seq_cor_pele,
            ws_rec.nr_seq_etnia,
            ws_rec.dt_naturalizacao_pf,
            ws_rec.nr_portaria_nat,
            ws_rec.dt_entrada_pais,
            ws_rec.cd_pais,
            ws_rec.nr_ctps,
            ws_rec.nr_serie_ctps,
            ws_rec.dt_emissao_ctps,
            ws_rec.nr_pis_pasep,
            ws_rec.nr_ric,
            ws_rec.cd_declaracao_nasc_vivo,
            ws_rec.nr_ddi_celular,
            ws_rec.nr_ddd_celular,
            ws_rec.nr_celular_numero,
            ws_rec.ds_observacao,
            ws_rec.dt_obito,
            clock_timestamp(),
            clock_timestamp(),
            nm_usuario_p,
            clock_timestamp(),
            nm_usuario_p
        );

    END IF;

    /*Mama*/

    CALL ia_compl_pf_cadsus( cd_pessoa_fisica_w, ws_rec.nm_pessoa_mae, 5, nm_usuario_p);

    /*Papi*/

    CALL ia_compl_pf_cadsus( cd_pessoa_fisica_w, ws_rec.nm_pessoa_pai, 4, nm_usuario_p);

    /*Endereco*/

    merge into compl_pessoa_fisica a using(
        SELECT
        cd_pessoa_fisica_w cd_pessoa_fisica,
        1 ie_tipo_complemento

    ) b on (
        a.ie_tipo_complemento = b.ie_tipo_complemento
        and a.cd_pessoa_fisica = b.cd_pessoa_fisica
    )
    when matched then update set
        a.cd_cep = ws_rec.cd_cep,
        a.sg_estado = ws_rec.sg_estado,
        a.ds_bairro = ws_rec.ds_bairro,
        a.ds_complemento = ws_rec.ds_complemento,
        a.nr_endereco = ws_rec.nr_endereco,
        a.ds_endereco = ws_rec.ds_endereco,
        a.cd_municipio_ibge = ws_rec.cd_municipio_ibge_nasc
    when not matched then insert(
        a.nr_sequencia,
        a.ie_tipo_complemento,
        a.cd_pessoa_fisica,
        a.cd_cep,
        a.sg_estado,
        a.ds_bairro,
        a.ds_complemento,
        a.nr_endereco,
        a.ds_endereco,
        a.cd_municipio_ibge,
        a.ds_email,
        a.dt_atualizacao,
        a.nm_usuario,
        a.dt_atualizacao_nrec,
        a.nm_usuario_nrec
    ) values (
        (
        SELECT
            coalesce(max(nr_sequencia),0) + 1
        from
            compl_pessoa_fisica
        where
            cd_pessoa_fisica = cd_pessoa_fisica_w
        ),
        b.ie_tipo_complemento,
        b.cd_pessoa_fisica,
        ws_rec.cd_cep,
        ws_rec.sg_estado,
        ws_rec.ds_bairro,
        ws_rec.ds_complemento,
        ws_rec.nr_endereco,
        ws_rec.ds_endereco,
        ws_rec.cd_municipio_ibge_nasc,
        ws_rec.ds_email,
        clock_timestamp(),
        nm_usuario_p,
        clock_timestamp(),
        nm_usuario_p
    );

    COMMIT;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE importar_atualizar_pf_cadsus ( nr_seq_interno_p bigint, cd_pessoa_fisica_p text, nm_usuario_p text, cd_pessoa_fisica_new INOUT text ) FROM PUBLIC;

