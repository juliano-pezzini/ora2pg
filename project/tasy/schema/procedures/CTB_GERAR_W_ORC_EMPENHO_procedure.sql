-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';



CREATE TYPE reg_conta AS (	cd_centro_custo	bigint,
			cd_conta		varchar(20),
			ds_centro_custo	varchar(255),
			ds_conta_contabil	varchar(255),
			ie_informacao	bigint,
			vl_orcado		double precision,
			vl_empenho	double precision,
			vl_aprovar	double precision,
			vl_disponivel	double precision);


CREATE OR REPLACE PROCEDURE ctb_gerar_w_orc_empenho ( cd_empresa_p bigint, cd_estabelecimento_p bigint, nr_solic_compra_p bigint, nr_seq_aprovacao_p bigint, ie_informacao_p bigint, nm_usuario_p text) AS $body$
DECLARE


cd_centro_custo_w				bigint;
cd_centro_custo_ww			bigint;
ds_centro_custo_w			varchar(255);
dt_inicial_ww				timestamp;
dt_inicial_w				timestamp;
dt_final_w				timestamp;
dt_referencia_w				timestamp;
nr_solic_compra_w				bigint;
nr_seq_aprovacao_w			bigint;
nr_seq_mes_ref_w				bigint;
i					integer	:= 0;
j					integer	:= 0;
k					integer	:= 0;
ie_informacao_w				smallint;
ie_gerar_w				varchar(1);
ie_tipo_w					varchar(1);
qt_reg_w				bigint;
vl_empenho_w				double precision;
ie_informacao_ww			bigint;
ie_existe_orc_w				varchar(1);
vl_orcado_w				double precision;
dt_fim_realizado_w			timestamp;
dt_inicio_empenho_w			timestamp;
cd_conta_contabil_w			varchar(20);
ie_empenho_w				varchar(1);
ie_consolida_empresa_w		varchar(1);

type conta is table of reg_conta index by integer;
conta_w					conta;

c01 CURSOR FOR
SELECT	coalesce(c.cd_centro_custo, b.cd_centro_custo) cd_centro_custo,
	a.cd_conta_contabil,
	coalesce(sum(coalesce(c.vl_rateio,(a.qt_material * a.vl_unit_previsto))),0) vl_aprovar
FROM solic_compra b, solic_compra_item a
LEFT OUTER JOIN solic_compra_item_rateio c ON (a.nr_solic_compra = c.nr_solic_compra AND a.nr_item_solic_compra = c.nr_item_solic_compra)
WHERE a.nr_solic_compra	= b.nr_solic_compra   and b.nr_solic_compra	= nr_solic_compra_w and not exists (	select	1
			from	nota_fiscal_item y
			where	y.nr_solic_compra	= b.nr_solic_compra
			and	y.nr_item_solic_compra	= a.nr_item_solic_compra
			and	y.nr_solic_compra	= nr_solic_compra_w) group by coalesce(c.cd_centro_custo, b.cd_centro_custo),
	a.cd_conta_contabil;

vet01	C01%RowType;
type centro is table of C01%rowtype index by integer;
centro_w		centro;

c02 CURSOR FOR
SELECT	x.cd_conta_contabil,
	a.ds_conta_contabil
from	conta_contabil a,
	solic_compra y,
	solic_compra_item x
where	y.nr_solic_compra		= x.nr_solic_compra
and	a.cd_conta_contabil		= x.cd_conta_contabil
and	y.nr_solic_compra		= nr_solic_compra_w
and	x.nr_seq_aprovacao	= nr_seq_aprovacao_w
group by x.cd_conta_contabil, a.ds_conta_contabil;

vet02	C02%RowType;

type contas is table of C02%rowtype index by integer;
contas_solic_w					contas;

c03 CURSOR FOR
SELECT	c.cd_centro_custo,
	c.ds_centro_custo,
	coalesce(sum(a.vl_orcado),0) vl_orcado
from	centro_custo c,
	ctb_mes_ref b,
	ctb_orcamento a
where	c.cd_centro_custo		= a.cd_centro_custo
and	b.nr_sequencia		= a.nr_seq_mes_ref
and	b.cd_empresa		= cd_empresa_p
and	a.cd_estabelecimento	= cd_estabelecimento_p
and	b.dt_referencia between dt_inicial_w and dt_final_w
and	a.cd_conta_contabil	= cd_conta_contabil_w
and	substr(ctb_obter_se_conta_ce_usuario(cd_empresa_p,c.cd_centro_custo,a.cd_conta_contabil,nm_usuario_p),1,1) = 'S'
and	not exists (	select	1
			from	w_ctb_orc_empenho y
			where	y.nm_usuario		= nm_usuario_p
			and	y.ie_informacao		= 0
			and	y.cd_centro_custo	= c.cd_centro_custo)
group by c.cd_centro_custo,
	 c.ds_centro_custo;

vet03	c03%Rowtype;

BEGIN

select	coalesce(max(ie_empenho_orcamento),'N')
into STRICT	ie_empenho_w
from	parametro_estoque
where	cd_estabelecimento = cd_estabelecimento_p;

begin
	select 	CASE WHEN coalesce(max(cd_estab_exclusivo), 0)=0 THEN  'S'  ELSE 'N' END
	into STRICT	ie_consolida_empresa_w
	from	ctb_orc_regra_empenho a
	where 	a.cd_empresa = cd_empresa_p
	and 	clock_timestamp() between a.dt_inicio_vigencia and coalesce(a.dt_fim_vigencia, clock_timestamp());
exception
when others then
	ie_consolida_empresa_w:= 'N';
end;

if (ie_empenho_w = 'S') then

	nr_solic_compra_w	:= nr_solic_compra_p;
	nr_seq_aprovacao_w	:= nr_seq_aprovacao_p;
	dt_inicial_w		:= pkg_date_utils.start_of(clock_timestamp(),'YEAR',0);
	dt_final_w		:= fim_ano(clock_timestamp());
	dt_inicial_ww		:= pkg_date_utils.start_of(clock_timestamp(),'YEAR',0);
	dt_fim_realizado_w	:= fim_mes(pkg_date_utils.start_of(pkg_date_utils.add_month(pkg_date_utils.start_of(clock_timestamp(),'MONTH',0),-2,0),'MONTH',0));
	dt_inicio_empenho_w	:= pkg_date_utils.start_of(dt_fim_realizado_w+1,'MONTH',0);

	if (pkg_date_utils.start_of(dt_inicio_empenho_w,'YEAR',0) <> pkg_date_utils.start_of(clock_timestamp(),'YEAR',0)) then
		dt_inicio_empenho_w := pkg_date_utils.start_of(clock_timestamp(),'MONTH',0);
	end if;

	select	max(cd_centro_custo)
	into STRICT	cd_centro_custo_ww
	from	solic_compra
	where	nr_solic_compra	= nr_solic_compra_w;

	delete from w_ctb_orc_empenho
	where	nm_usuario	= nm_usuario_p
	and	ie_informacao	= ie_informacao_p;


	begin

	select	nr_sequencia
	into STRICT	nr_seq_mes_ref_w
	from	ctb_mes_ref
	where	cd_empresa	= cd_empresa_p
	and	dt_referencia	= pkg_date_utils.start_of(clock_timestamp(),'MONTH',0);

	exception when others then
		nr_seq_mes_ref_w	:= 0;
	end;

	cd_centro_custo_w	:= null;

	open C01;
	loop
	fetch C01 into
		vet01;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin
		i	:= i + 1;

		centro_w[i].cd_centro_custo	:= vet01.cd_centro_custo;
		centro_w[i].cd_conta_contabil	:= vet01.cd_conta_contabil;
		centro_w[i].vl_aprovar		:= vet01.vl_aprovar;
		end;
	end loop;
	close C01;

	/*Se não tiver orçamento para o centro de custo da Solic, então tem que trazer o valor zerado
	if	(cd_centro_custo_w is null) then
		select	max(ds_centro_custo)
		into	ds_centro_custo_w
		from	centro_custo
		where	cd_centro_custo	= cd_centro_custo_ww;

		i	:= i + 1;
		centro_w(i).cd_centro_custo	:= cd_centro_custo_ww;
		centro_w(i).ds_centro_custo	:= ds_centro_custo_w;
	end if;

	cd_centro_custo_w	:= null;
	ds_centro_custo_w	:= null;*/
	if (ie_informacao_p = 0) then
		begin
		for k in 1..centro_w.count loop
			begin
			cd_centro_custo_w	:= centro_w[k].cd_centro_custo;

			if (coalesce(centro_w[k].cd_centro_custo,0) <> 0) then
				ie_gerar_w	:= substr(ctb_obter_se_conta_ce_usuario(cd_empresa_p,centro_w[k].cd_centro_custo,centro_w[k].cd_conta_contabil,nm_usuario_p),1,1);
			else
				CALL wheb_mensagem_pck.exibir_mensagem_abort(247437);
			end if;

			if (ie_gerar_w = 'S') then

				j				:= j + 1;
				conta_w[j].ie_informacao	:= 0;
				conta_w[j].cd_centro_custo	:= centro_w[k].cd_centro_custo;
				conta_w[j].ds_centro_custo	:= substr(obter_desc_centro_custo(centro_w[k].cd_centro_custo),1,255);
				conta_w[j].cd_conta		:= centro_w[k].cd_conta_contabil;
				conta_w[j].ds_conta_contabil	:= substr(obter_desc_conta_contabil(centro_w[k].cd_conta_contabil),1,255);
				conta_w[j].vl_empenho		:= 0;
				conta_w[j].vl_aprovar		:= 0;
				conta_w[j].vl_disponivel	:= 0;
				conta_w[j].vl_orcado		:= 0;
				vl_empenho_w			:= 0;

				select	coalesce(sum(a.vl_orcado),0)
				into STRICT	conta_w[j].vl_orcado
				from	ctb_mes_ref b,
					ctb_orcamento a
				where	b.nr_sequencia	= a.nr_seq_mes_ref
				and	b.cd_empresa	= cd_empresa_p
				and	((a.cd_estabelecimento	= cd_estabelecimento_p) or (ie_consolida_empresa_w = 'S'))
				and	a.cd_centro_custo	= cd_centro_custo_w
				and	b.dt_referencia between dt_inicial_w and dt_final_w
				and	a.cd_conta_contabil	= conta_w[j].cd_conta;

				select	coalesce(sum(a.vl_realizado),0)
				into STRICT	conta_w[j].vl_empenho
				from	ctb_mes_ref b,
					ctb_orcamento a
				where	b.nr_sequencia	= a.nr_seq_mes_ref
				and	b.cd_empresa	= cd_empresa_p
				and	a.cd_centro_custo	= cd_centro_custo_w
				and	b.dt_referencia between dt_inicial_w and dt_fim_realizado_w
				and	a.cd_conta_contabil	= conta_w[j].cd_conta;

				select	coalesce(sum(a.vl_empenho),0)
				into STRICT	vl_empenho_w
				from	ctb_mes_ref b,
					ctb_orcamento a
				where	b.nr_sequencia	= a.nr_seq_mes_ref
				and	b.cd_empresa	= cd_empresa_p
				and	((a.cd_estabelecimento	= cd_estabelecimento_p) or (ie_consolida_empresa_w = 'S'))
				and	a.cd_centro_custo	= cd_centro_custo_w
				and	b.dt_referencia between dt_inicio_empenho_w and clock_timestamp()
				and	a.cd_conta_contabil	= conta_w[j].cd_conta;

				conta_w[j].vl_empenho		:= conta_w[j].vl_empenho + vl_empenho_w;
				conta_w[j].vl_aprovar		:= centro_w[k].vl_aprovar;
				conta_w[j].vl_disponivel	:= coalesce(conta_w[j].vl_orcado - (conta_w[j].vl_empenho + conta_w[j].vl_aprovar),0);
			end if;
			end;
		end loop;


		end;
	elsif (ie_informacao_p = 1) then
		begin
		i	:= 0;
		open C02;
		loop
		fetch C02 into
			vet02;
		EXIT WHEN NOT FOUND; /* apply on C02 */
			begin
			i	:= i + 1;
			contas_solic_w[i].cd_conta_contabil	:= vet02.cd_conta_contabil;
			contas_solic_w[i].ds_conta_contabil	:= vet02.ds_conta_contabil;
			end;
		end loop;
		close C02;

		for i in 1..contas_solic_w.count loop
			begin
			cd_conta_contabil_w		:= contas_solic_w[i].cd_conta_contabil;
			open C03;
			loop
			fetch C03 into
				vet03;
			EXIT WHEN NOT FOUND; /* apply on C03 */
				begin
				cd_centro_custo_w		:= vet03.cd_centro_custo;
				j				:= j + 1;
				conta_w[j].ie_informacao	:= 1;
				conta_w[j].cd_centro_custo	:= cd_centro_custo_w;
				conta_w[j].ds_centro_custo	:= substr(obter_desc_centro_custo(vet03.cd_centro_custo),1,255);
				conta_w[j].cd_conta		:= cd_conta_contabil_w;
				conta_w[j].ds_conta_contabil	:= contas_solic_w[i].ds_conta_contabil;
				conta_w[j].vl_empenho		:= 0;
				conta_w[j].vl_aprovar		:= 0;
				conta_w[j].vl_disponivel	:= 0;
				conta_w[j].vl_orcado		:= vet03.vl_orcado;
				vl_empenho_w			:= 0;


				select	coalesce(sum(a.vl_realizado),0)
				into STRICT	conta_w[j].vl_empenho
				from	ctb_mes_ref b,
					ctb_orcamento a
				where	b.nr_sequencia		= a.nr_seq_mes_ref
				and	b.cd_empresa		= cd_empresa_p
				and	((a.cd_estabelecimento	= cd_estabelecimento_p) or (ie_consolida_empresa_w = 'S'))
				and	a.cd_centro_custo	= cd_centro_custo_w
				and	b.dt_referencia between dt_inicial_w and dt_fim_realizado_w
				and	a.cd_conta_contabil	= conta_w[j].cd_conta;


				select	coalesce(sum(a.vl_empenho),0)
				into STRICT	vl_empenho_w
				from	ctb_mes_ref b,
					ctb_orcamento a
				where	b.nr_sequencia	= a.nr_seq_mes_ref
				and	b.cd_empresa	= cd_empresa_p
				and	((a.cd_estabelecimento	= cd_estabelecimento_p) or (ie_consolida_empresa_w = 'S'))
				and	a.cd_centro_custo	= cd_centro_custo_w
				and	b.dt_referencia between dt_inicio_empenho_w and clock_timestamp()
				and	a.cd_conta_contabil	= conta_w[j].cd_conta;

				conta_w[j].vl_empenho		:= conta_w[j].vl_empenho + vl_empenho_w;

				conta_w[j].vl_disponivel	:= coalesce(conta_w[j].vl_orcado - (conta_w[j].vl_empenho + conta_w[j].vl_aprovar),0);


				end;
			end loop;
			close C03;
			end;
		end loop;


		end;
	end if;

	for j in 1..conta_w.Count loop
		begin
		insert into w_ctb_Orc_empenho(
			nr_sequencia,
			nm_usuario,
			dt_atualizacao,
			cd_centro_custo,
			cd_conta_contabil,
			ds_centro_custo,
			ds_conta_contabil,
			vl_orcado,
			vl_empenho,
			vl_aprovar,
			vl_disponivel,
			ie_informacao)
		values (	nextval('w_ctb_orc_empenho_seq'),
			nm_usuario_p,
			clock_timestamp(),
			conta_w[j].cd_centro_custo,
			conta_w[j].cd_conta,
			conta_w[j].ds_centro_custo,
			conta_w[j].ds_conta_contabil,
			coalesce(conta_w[j].vl_orcado,0),
			coalesce(conta_w[j].vl_empenho,0),
			coalesce(conta_w[j].vl_aprovar,0),
			coalesce(conta_w[j].vl_disponivel,0),
			conta_w[j].ie_informacao);
		end;
	end loop;
	commit;
end if;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ctb_gerar_w_orc_empenho ( cd_empresa_p bigint, cd_estabelecimento_p bigint, nr_solic_compra_p bigint, nr_seq_aprovacao_p bigint, ie_informacao_p bigint, nm_usuario_p text) FROM PUBLIC;

