-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE cpoe_get_justification_data ( nr_atendimento_p paciente_atendimento.nr_atendimento%type default null, cd_material_p material.cd_material%type default null, cd_estabelecimento_p setor_atendimento.cd_setor_atendimento%type default null, cd_setor_atendimento_p setor_atendimento.cd_setor_atendimento%type default null, nm_usuario_p usuario.nm_usuario%type default null, ie_via_aplicacao_p material_prescr.ie_via_aplicacao%type default null, cd_pessoa_fisica_p pessoa_fisica.cd_pessoa_fisica%type default null, cd_intervalo_p intervalo_prescricao.cd_intervalo%type default null, ie_se_necessario_p text default null, ie_solucao_p text default null, ie_considerar_peso_p text default null, qt_dose material.qt_limite_pessoa%type default null, ie_bomba_infusao_p cpoe_material.ie_bomba_infusao%type default null, ie_administracao_p cpoe_material.ie_administracao%type default null, ie_urgencia_p cpoe_material.ie_urgencia%type default null, ie_amtobiotic_p cpoe_material.ie_antibiotico%type default null, ie_objetivo_filtro_p cpoe_material.ie_objetivo%type default null, cd_protocolo_p cpoe_material.cd_protocolo%type default null, nr_seq_protocolo_p cpoe_material.nr_seq_protocolo%type default null, nr_seq_mat_protocolo_p cpoe_material.nr_seq_mat_protocolo%type default null, ds_allergy_pregnant_justify_p text default null, ie_exige_justificativa_p INOUT material_prescr.ie_exige_justificativa%type DEFAULT NULL, ie_justificativa_padrao_p INOUT material_prescr.ie_justificativa_padrao%type DEFAULT NULL, ds_justificativa_p INOUT text  DEFAULT NULL) AS $body$
DECLARE


	_ora2pg_r RECORD;
ie_exige_justificativa_out_w	material_prescr.ie_exige_justificativa%type;
	ie_justificativa_padrao_out_w	material_prescr.ie_justificativa_padrao%type;
	ds_justificativa_out_w			varchar(4000);
	cd_setor_prescr_w				setor_atendimento.cd_setor_atendimento%type;
	cd_prescritor_w					usuario.cd_pessoa_fisica%type;
	ie_administracao_w				cpoe_material.ie_administracao%type;
	ie_just_se_necessario_w			parametro_medico.ie_just_se_necessario%type;
	ie_just_agora_w					parametro_medico.ie_just_agora%type;
	ie_just_acm_w					parametro_medico.ie_just_acm%type;
	ie_justificativa_w 				regra_antimicrobiano.ie_justificativa%type;
	ie_objetivo_w 					regra_antimicrobiano.ie_objetivo%type;
	ie_dia_utilizacao_w 			regra_antimicrobiano.ie_dia_utilizacao%type;
	ie_topografia_w					regra_antimicrobiano.ie_topografia%type;
	ie_amostra_w 					regra_antimicrobiano.ie_amostra%type;
	ie_microorganismo_w 			regra_antimicrobiano.ie_microorganismo%type;
	ie_origem_w 					regra_antimicrobiano.ie_origem%type;
	ie_exige_indicacao_w			regra_antimicrobiano.ie_indicacao%type;
	qt_dias_prev_w					regra_antimicrobiano.qt_dias_prev%type;
	ie_obj_regra_w					regra_antimicrobiano.ie_objetivo_filtro%type;
	ie_lib_auto_w					regra_antimicrobiano.ie_lib_auto%type;
	ie_possui_regra_w				varchar(1);
	ie_regra_intervalo_w			cpoe_material.cd_intervalo%type;
	qt_dias_lib_padrao_w			parametro_medico.qt_dias_lib_padrao%type;


BEGIN
	if (nm_usuario_p IS NOT NULL AND nm_usuario_p::text <> '') then
		cd_setor_prescr_w := obter_setor_usuario(nm_usuario_p);
		cd_prescritor_w := obter_pf_usuario(nm_usuario_p, 'C');
	end if;

	SELECT * FROM cpoe_obter_dados_justif_medic(
					nr_atendimento_p, cd_material_p, cd_setor_prescr_w, cd_estabelecimento_p, cd_setor_atendimento_p, cd_prescritor_w, ie_via_aplicacao_p, cd_pessoa_fisica_p, cd_intervalo_p, ie_se_necessario_p, ie_solucao_p, ie_considerar_peso_p, qt_dose, ie_bomba_infusao_p, ie_exige_justificativa_out_w, ie_justificativa_padrao_out_w, ds_justificativa_out_w
	) INTO STRICT ie_exige_justificativa_out_w, ie_justificativa_padrao_out_w, ds_justificativa_out_w
	;

    if ((coalesce(cd_protocolo_p, 0) > 0) and (coalesce(nr_seq_protocolo_p, 0) > 0) and (coalesce(nr_seq_mat_protocolo_p, 0) > 0)) then
		select coalesce(max(ie_justificativa), 'N') ie_justificativa
		  into STRICT ie_exige_justificativa_out_w
		  from protocolo_medic_material
		 where cd_protocolo = cd_protocolo_p
		   and nr_sequencia = nr_seq_protocolo_p
		   and nr_seq_material = nr_seq_mat_protocolo_p;
		
		if (coalesce(ds_allergy_pregnant_justify_p, 'XPTO') <> 'XPTO') then
			ie_exige_justificativa_out_w := 'S';
			ds_justificativa_out_w := ds_justificativa_out_w || chr(13) || ds_allergy_pregnant_justify_p;
		end if;
	end if;

	if (coalesce(ie_exige_justificativa_out_w, 'N') = 'N') then
		select 	coalesce(max(a.ie_just_se_necessario),'N') ie_se_necessario,
				coalesce(max(a.ie_just_agora),'N') ie_agora,
				coalesce(max(a.ie_just_acm),'N') ie_acm
		into STRICT	ie_just_se_necessario_w,
				ie_just_agora_w,
				ie_just_acm_w
		from 	parametro_medico a
		where 	a.cd_estabelecimento = cd_estabelecimento_p;
		
		ie_administracao_w := coalesce(ie_administracao_p, 'P');

		if (((ie_administracao_w = 'P') and (ie_urgencia_p IS NOT NULL AND ie_urgencia_p::text <> '') and (ie_just_agora_w = 'S')) or
			(ie_administracao_w = 'N' AND ie_just_se_necessario_w = 'S') or
			(ie_administracao_w = 'C' AND ie_just_acm_w = 'S')) then

			ie_exige_justificativa_out_w := 'S';
		end if;

		if ((coalesce(ie_exige_justificativa_out_w, 'N') = 'N') and (coalesce(ie_solucao_p, 'XPTO') <> 'XPTO') and (coalesce(ie_amtobiotic_p, 'N') = 'S')) then
			SELECT * FROM cpoe_obter_dados_antimicrob(cd_material_p, wheb_usuario_pck.get_cd_perfil, cd_estabelecimento_p, wheb_usuario_pck.get_nm_usuario, ie_objetivo_filtro_p, cd_intervalo_p) INTO STRICT _ora2pg_r;
 ie_justificativa_w := _ora2pg_r.ie_justificativa_p; ie_objetivo_w := _ora2pg_r.ie_objetivo_p; ie_dia_utilizacao_w := _ora2pg_r.ie_dia_utilizacao_p; ie_topografia_w := _ora2pg_r.ie_topografia_p; ie_amostra_w := _ora2pg_r.ie_amostra_p; ie_microorganismo_w := _ora2pg_r.ie_microorganismo_p; ie_origem_w := _ora2pg_r.ie_origem_p; ie_exige_indicacao_w := _ora2pg_r.ie_exige_indicacao_p; qt_dias_prev_w := _ora2pg_r.qt_dias_prev_p; ie_obj_regra_w := _ora2pg_r.ie_obj_regra_p; ie_lib_auto_w := _ora2pg_r.ie_lib_auto_p; ie_possui_regra_w := _ora2pg_r.ie_possui_regra_p; ie_regra_intervalo_w := _ora2pg_r.ie_regra_intervalo_p; qt_dias_lib_padrao_w := _ora2pg_r.qt_dias_lib_padrao_p;

			if ((coalesce(ie_possui_regra_w, 'N') = 'S') and
			    ((coalesce(ie_justificativa_w, 'N') = 'S') or
			     ((coalesce(ie_objetivo_filtro_p, 'X') <> 'X') and (coalesce(ie_justificativa_w, 'N') <> 'N') and (coalesce(ie_objetivo_filtro_p, 'X') = coalesce(ie_justificativa_w, 'N'))) or
				 (((coalesce(ie_justificativa_w, 'N') = 'R') and (coalesce(ie_objetivo_filtro_p, 'X') in ('C', 'P', 'F'))) or ((coalesce(ie_justificativa_w, 'N') = 'G') and (coalesce(ie_objetivo_filtro_p, 'X') in ('T', 'D', 'E'))))
			    )) then
				
				ie_exige_justificativa_out_w := 'S';
			end if;
		end if;
	end if;

	ie_exige_justificativa_p := ie_exige_justificativa_out_w;
	ie_justificativa_padrao_p := ie_justificativa_padrao_out_w;
	ds_justificativa_p := ds_justificativa_out_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cpoe_get_justification_data ( nr_atendimento_p paciente_atendimento.nr_atendimento%type default null, cd_material_p material.cd_material%type default null, cd_estabelecimento_p setor_atendimento.cd_setor_atendimento%type default null, cd_setor_atendimento_p setor_atendimento.cd_setor_atendimento%type default null, nm_usuario_p usuario.nm_usuario%type default null, ie_via_aplicacao_p material_prescr.ie_via_aplicacao%type default null, cd_pessoa_fisica_p pessoa_fisica.cd_pessoa_fisica%type default null, cd_intervalo_p intervalo_prescricao.cd_intervalo%type default null, ie_se_necessario_p text default null, ie_solucao_p text default null, ie_considerar_peso_p text default null, qt_dose material.qt_limite_pessoa%type default null, ie_bomba_infusao_p cpoe_material.ie_bomba_infusao%type default null, ie_administracao_p cpoe_material.ie_administracao%type default null, ie_urgencia_p cpoe_material.ie_urgencia%type default null, ie_amtobiotic_p cpoe_material.ie_antibiotico%type default null, ie_objetivo_filtro_p cpoe_material.ie_objetivo%type default null, cd_protocolo_p cpoe_material.cd_protocolo%type default null, nr_seq_protocolo_p cpoe_material.nr_seq_protocolo%type default null, nr_seq_mat_protocolo_p cpoe_material.nr_seq_mat_protocolo%type default null, ds_allergy_pregnant_justify_p text default null, ie_exige_justificativa_p INOUT material_prescr.ie_exige_justificativa%type DEFAULT NULL, ie_justificativa_padrao_p INOUT material_prescr.ie_justificativa_padrao%type DEFAULT NULL, ds_justificativa_p INOUT text  DEFAULT NULL) FROM PUBLIC;

