-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_w_fat_analise_gerencial (dt_inicial_p timestamp, dt_final_p timestamp, nm_usuario_p text, cd_estabelecimento_p bigint) AS $body$
DECLARE

 
nr_interno_conta_w			bigint;
nr_sequencia_proc_w			bigint;
nr_sequencia_mat_w			bigint;
qt_resumo_cprp_w 			bigint;
vl_custo_cprp_w 			double precision;
qt_resumo_cprm_w 			bigint;
vl_custo_cprm_w 			double precision;
qt_resumo_cpr_w 			bigint;
vl_custo_cpr_w 			double precision;
qt_resumo_cpr2_w 			bigint;
vl_custo_cpr2_w 			double precision;
cd_material_w				integer;
nr_seq_proc_pacote_w			bigint;
nr_seq_pacote_cursor_7_w		bigint;
ie_origem_proced_w			bigint;
cd_procedimento_w			bigint;
nr_atendimento_w			bigint;
dt_entrada_w				timestamp;
ie_tipo_atendimento_w			smallint;
ds_tipo_atendimento_w			varchar(255);
dt_alta_w				timestamp;
ie_clinica_w				integer;
ds_clinica_w				varchar(255);
cd_convenio_w				integer;
ds_convenio_w				varchar(255);
cd_categoria_w				varchar(10);
ds_categoria_w				varchar(255);
cd_plano_w				varchar(10);
ds_plano_w				varchar(255);
nm_primeiro_medico_w			varchar(60);
nr_crm_primeiro_medico_w		varchar(20);
ds_primeiro_medico_crm_w		varchar(80);
ds_espec_primeiro_medico_w		varchar(255);
nm_medico_alta_w			varchar(60);
ds_medico_crm_alta_w			varchar(80);
ds_espec_medico_alta_w			varchar(255);
cd_proc_principal_amb_w			bigint;
cd_cid_principal_w			varchar(10);
ds_cid_principal_w			varchar(100);
cd_proc_principal_atend_w		bigint;
ds_proc_principal_atend_w		varchar(255);
nm_pessoa_fisica_w			varchar(60);
nr_prontuario_w				bigint;
ie_sexo_w				varchar(1);
dt_nascimento_w				timestamp;			
nr_anos_w				varchar(50);
ds_estado_civil_w			varchar(90);
nr_identidade_w				varchar(15);
ds_endereco_w				varchar(120);
ds_bairro_w				varchar(120);
ds_municipio_w				varchar(120);
sg_estado_w				varchar(120);
cd_cep_w				varchar(120);
nr_crm_medico_alta_w			varchar(20);
ds_especialidade_conta_w		varchar(255);
dt_periodo_inicial_w			timestamp;
dt_periodo_final_w			timestamp;
dt_mesano_referencia_w			timestamp;
ie_status_acerto_w			smallint;
ds_status_acerto_w			varchar(255);	
cd_convenio_parametro_w			integer;
ds_convenio_conta_w			varchar(255);
nr_protocolo_w				varchar(40);	
nr_seq_protocolo_w			bigint;
cd_especialidade_conta_w		integer;
nr_nota_fiscal_w			varchar(255);
dt_emissao_nf_w				timestamp;

cd_tipo_item_w				smallint;
ds_tipo_item_w				varchar(30);
ds_procedimento_w			varchar(255);
dt_procedimento_w			timestamp;
qt_procedimento_w			integer;
vl_unitario_w				double precision;
vl_procedimento_w			double precision;
cd_setor_atendimento_conta_w		integer;
ds_setor_atendimento_conta_w		varchar(100);
ie_emite_conta_w			varchar(3);
ds_emite_conta_w			varchar(80);
cd_motivo_exc_conta_w			smallint;
cd_ordem_visualizacao_w			smallint;
ie_proc_mat_w				numeric(22);
cd_item_w				bigint;
ds_item_w				varchar(255);
dt_item_w				timestamp;
qt_item_w				integer;
vl_unit_item_w				double precision;
vl_item_w				double precision;
vl_original_w				double precision;
ie_emite_conta_item_w			varchar(3);
ds_emite_conta_item_w			varchar(80);
cd_setor_atendimento_item_w		integer;
ds_setor_atendimento_item_w		varchar(100);
vl_custo_unitario_w			double precision;

 
qt_resumo_w				double precision;
vl_custo_w				double precision;

ds_procedencia_w			varchar(100);
ds_motivo_alta_w			varchar(100);
ds_tipo_atend_conta_w			varchar(100);

C01 CURSOR FOR 
	SELECT	c.nr_interno_conta 
	from	conta_paciente c 
	where	c.dt_mesano_referencia between dt_inicial_p and dt_final_p 
	order by c.nr_interno_conta;
	
C02 CURSOR FOR 
	--Sem pacote 
	SELECT	p.nr_sequencia, 
		p.cd_procedimento, 
		p.ie_origem_proced, 
		p.nr_seq_proc_pacote 
	from	procedimento_paciente p 
	where	p.nr_interno_conta = nr_interno_conta_w 
	and 	coalesce(p.nr_seq_proc_pacote::text, '') = '' 
	order by p.cd_procedimento;		
	 
	 
C05 CURSOR FOR 
	SELECT	p.nr_sequencia, 
		p.cd_material, 
		p.nr_seq_proc_pacote 
	from	material_atend_paciente p 
	where	p.nr_interno_conta = nr_interno_conta_w 
	and 	coalesce(p.nr_seq_proc_pacote::text, '') = '' 
	order by p.cd_material;	
 
 
C07 CURSOR FOR 
	--Proc. Pacote 
	SELECT	p.nr_sequencia, 
		p.cd_procedimento, 
		p.ie_origem_proced, 
		p.nr_seq_proc_pacote 
	from	procedimento_paciente p 
	where	p.nr_interno_conta = nr_interno_conta_w 
	and 	(p.nr_seq_proc_pacote IS NOT NULL AND p.nr_seq_proc_pacote::text <> '') 
	and 	nr_sequencia = coalesce(nr_seq_proc_pacote,0) 
	order by p.cd_procedimento;		
	 
C08 CURSOR FOR 
	-- Procedimentos do Pacote 
	SELECT	p.nr_sequencia, 
		p.cd_procedimento, 
		p.ie_origem_proced, 
		p.nr_seq_proc_pacote 
	from	procedimento_paciente p 
	where	p.nr_interno_conta = nr_interno_conta_w 
	and 	(p.nr_seq_proc_pacote IS NOT NULL AND p.nr_seq_proc_pacote::text <> '') 
	and 	p.nr_seq_proc_pacote = nr_seq_pacote_cursor_7_w 
	and 	p.nr_sequencia <> p.nr_seq_proc_pacote 
	order by p.cd_procedimento;

C10 CURSOR FOR 
	SELECT	p.nr_sequencia, 
		p.cd_material, 
		p.nr_seq_proc_pacote 
	from	material_atend_paciente p 
	where	p.nr_interno_conta = nr_interno_conta_w 
	and 	(p.nr_seq_proc_pacote IS NOT NULL AND p.nr_seq_proc_pacote::text <> '') 
	and 	p.nr_seq_proc_pacote = nr_seq_pacote_cursor_7_w 
	and 	p.nr_sequencia <> p.nr_seq_proc_pacote 
	order by p.cd_material;

	 
		 

BEGIN 
 
delete from w_fat_analise_gerencial where nm_usuario = nm_usuario_p;
 
open C01;
loop 
fetch C01 into	 
	nr_interno_conta_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin 
	 
	select	/*atendimento_paciente */
 
		a.nr_atendimento, 
		a.dt_entrada, 
		a.ie_tipo_atendimento, 
		substr(obter_valor_dominio(12, a.ie_tipo_atendimento),1,255) ds_tipo_atendimento, 
		a.dt_alta, 
		a.ie_clinica, 
		substr(CASE WHEN coalesce(obter_valor_dominio(17, a.ie_clinica)::text, '') = '' THEN  ''  ELSE substr(obter_valor_dominio(17, a.ie_clinica), 1, 50) END ,1,255) ds_clinica, 
		obter_convenio_atendimento(a.nr_atendimento) cd_convenio, 
		substr(obter_nome_convenio(obter_convenio_atendimento(a.nr_atendimento)),1,255) ds_convenio, 
		obter_categoria_atendimento(a.nr_atendimento) cd_categoria, 
		substr(obter_categoria_convenio(obter_convenio_atendimento(a.nr_atendimento), obter_categoria_atendimento(a.nr_atendimento)),1,255) ds_categoria, 
		obter_plano_convenio_atend(a.nr_atendimento, 'C') cd_plano, 
		substr(obter_plano_convenio_atend(a.nr_atendimento, 'D'),1,255) ds_plano, 
		CASE WHEN coalesce(obter_primeiro_medico(a.nr_atendimento, 'N')::text, '') = '' THEN  ''  ELSE substr(obter_primeiro_medico(a.nr_atendimento, 'N'), 1, 60) END  nm_primeiro_medico, 
		CASE WHEN coalesce(obter_primeiro_medico(a.nr_atendimento, 'R')::text, '') = '' THEN  ''  ELSE substr(obter_primeiro_medico(a.nr_atendimento, 'R'), 1, 20) END  nr_crm_primeiro_medico, 
		CASE WHEN coalesce(obter_primeiro_medico(a.nr_atendimento, 'C')::text, '') = '' THEN  ''  ELSE substr(obter_nome_medico(obter_primeiro_medico(a.nr_atendimento, 'C'), 'P'), 1, 80) END  ds_primeiro_medico_crm, 
		substr(obter_especialidade_medico(obter_primeiro_medico(a.nr_atendimento, 'C'), 'D'),1,255) ds_espec_primeiro_medico, 
		CASE WHEN coalesce(obter_nome_pessoa_fisica(a.cd_medico_resp, null)::text, '') = '' THEN  ''  ELSE substr(obter_nome_pessoa_fisica(a.cd_medico_resp, null), 1, 60) END  nm_medico_alta, 
		CASE WHEN coalesce(obter_nome_pessoa_fisica(a.cd_medico_resp, null)::text, '') = '' THEN  ''  ELSE substr(obter_nome_medico(a.cd_medico_resp, 'P'), 1, 80) END  ds_medico_crm_alta, 
		substr(obter_especialidade_medico(a.cd_medico_resp, 'D'),1,255) ds_espec_medico_alta, 
		obter_codigo_proced_princ(a.nr_atendimento) cd_proc_principal_amb, 
		CASE WHEN coalesce(obter_cid_atendimento(a.nr_atendimento, 'P')::text, '') = '' THEN  ''  ELSE substr(obter_cid_atendimento(a.nr_atendimento, 'P'), 1, 30) END  cd_cid_principal, 
		CASE WHEN obter_desc_cid_doenca(obter_cid_atendimento(a.nr_atendimento, 'P')) IS NULL THEN  ''  ELSE substr(obter_desc_cid_doenca(obter_cid_atendimento(a.nr_atendimento, 'P')), 1, 100) END  ds_cid_principal, 
		--somente_numero(obter_codigo_proced_princ(a.nr_atendimento)) cd_proc_principal_atend, 
		--substr(obter_desc_proc_princ_interno(a.nr_atendimento),1,255) ds_proc_principal_atend, 
		substr(obter_proc_principal(a.nr_atendimento, c.cd_convenio_parametro, a.ie_tipo_atendimento,0,'C'),1,10) cd_proc_principal_atend, 
		substr(obter_proc_principal(a.nr_atendimento, c.cd_convenio_parametro, a.ie_tipo_atendimento,0,'D'),1,240) ds_proc_principal_atend, 
		/*pessoa_fisica*/
 
		p.nm_pessoa_fisica, 
		CASE WHEN coalesce(p.nr_prontuario::text, '') = '' THEN  ''  ELSE p.nr_prontuario END  nr_prontuario, 
		CASE WHEN coalesce(p.ie_sexo::text, '') = '' THEN  ''  ELSE p.ie_sexo END  ie_sexo, 
		CASE WHEN coalesce(p.dt_nascimento::text, '') = '' THEN  ''  ELSE to_char(p.dt_nascimento, 'dd/mm/yyyy') END  dt_nascimento, 
		CASE WHEN obter_idade(p.dt_nascimento, clock_timestamp(), 'A') IS NULL THEN  ''  ELSE substr(obter_idade(p.dt_nascimento, clock_timestamp(), 'A'), 1, 10) END  nr_anos, 
		CASE WHEN coalesce(obter_valor_dominio(5, p.ie_estado_civil)::text, '') = '' THEN  ''  ELSE substr(obter_valor_dominio(5, p.ie_estado_civil), 1, 90) END  ds_estado_civil, 
		coalesce(p.nr_identidade, '') nr_identidade, 
		CASE WHEN coalesce(obter_compl_pf(p.cd_pessoa_fisica, 1, 'E')::text, '') = '' THEN  ''  ELSE substr(obter_compl_pf(p.cd_pessoa_fisica, 1, 'E'), 1, 120) END  	ds_endereco, 
		CASE WHEN coalesce(obter_compl_pf(p.cd_pessoa_fisica, 1, 'B')::text, '') = '' THEN  ''  ELSE substr(obter_compl_pf(p.cd_pessoa_fisica, 1, 'B'), 1, 120) END  	ds_bairro, 
		CASE WHEN coalesce(obter_compl_pf(p.cd_pessoa_fisica, 1, 'CI')::text, '') = '' THEN  ''  ELSE substr(obter_compl_pf(p.cd_pessoa_fisica, 1, 'CI'), 1, 120) END  	ds_municipio, 
		CASE WHEN coalesce(obter_compl_pf(p.cd_pessoa_fisica, 1, 'UF')::text, '') = '' THEN  ''  ELSE substr(obter_compl_pf(p.cd_pessoa_fisica, 1, 'UF'), 1, 20) END  	sg_estado, 
		CASE WHEN coalesce(obter_compl_pf(p.cd_pessoa_fisica, 1, 'CEP')::text, '') = '' THEN  ''  ELSE substr(obter_compl_pf(p.cd_pessoa_fisica, 1, 'CEP'), 1, 120) END  	cd_cep, 
		/*medico*/
 
		obter_crm_medico(a.cd_medico_resp) nr_crm_medico_alta, 
		/*especialidade_medica*/
 
		substr(obter_nome_especialidade(c.cd_especialidade_conta),1,255) ds_especialidade_conta, 
		/*conta_paciente*/
 
		c.dt_periodo_inicial, 
		c.dt_periodo_final, 
		c.dt_mesano_referencia, 
		c.ie_status_acerto, 
		obter_valor_dominio(49, c.ie_status_acerto) ds_status_acerto, 
		c.cd_convenio_parametro cd_convenio_conta, 
		obter_nome_convenio(c.cd_convenio_parametro) ds_convenio_conta, 
		c.nr_protocolo, 
		c.nr_seq_protocolo, 
		c.cd_especialidade_conta, 
		obter_nf_conta(c.nr_interno_conta, 2) nr_nota_fiscal, 
		to_date(obter_dados_nota_fiscal(obter_nf_conta(c.nr_interno_conta, 1), 9), 'dd/mm/rrrr') dt_emissao_nf, 
		substr(Obter_Desc_Procedencia(a.cd_procedencia),1,100),	 
		substr(obter_desc_motivo_alta(a.cd_motivo_alta),1,100),	 
		substr(obter_nome_tipo_atend(a.ie_tipo_atendimento),1,100) 
	into STRICT	nr_atendimento_w,			 
		dt_entrada_w,				 
		ie_tipo_atendimento_w,			 
		ds_tipo_atendimento_w,			 
		dt_alta_w,				 
		ie_clinica_w,				 
		ds_clinica_w,				 
		cd_convenio_w,				 
		ds_convenio_w,				 
		cd_categoria_w,				 
		ds_categoria_w,			 
		cd_plano_w,				 
		ds_plano_w,				 
		nm_primeiro_medico_w,			 
		nr_crm_primeiro_medico_w,		 
		ds_primeiro_medico_crm_w,		 
		ds_espec_primeiro_medico_w,		 
		nm_medico_alta_w,			 
		ds_medico_crm_alta_w,			 
		ds_espec_medico_alta_w,			 
		cd_proc_principal_amb_w,			 
		cd_cid_principal_w,			 
		ds_cid_principal_w,			 
		cd_proc_principal_atend_w,		 
		ds_proc_principal_atend_w,		 
		nm_pessoa_fisica_w,			 
		nr_prontuario_w,				 
		ie_sexo_w,				 
		dt_nascimento_w,				 
		nr_anos_w,				 
		ds_estado_civil_w,			 
		nr_identidade_w,				 
		ds_endereco_w,				 
		ds_bairro_w,				 
		ds_municipio_w,				 
		sg_estado_w,				 
		cd_cep_w,				 
		nr_crm_medico_alta_w,			 
		ds_especialidade_conta_w,		 
		dt_periodo_inicial_w,			 
		dt_periodo_final_w,			 
		dt_mesano_referencia_w,			 
		ie_status_acerto_w,			 
		ds_status_acerto_w,			 
		cd_convenio_parametro_w,			 
		ds_convenio_conta_w,			 
		nr_protocolo_w,				 
		nr_seq_protocolo_w,			 
		cd_especialidade_conta_w, 
		nr_nota_fiscal_w, 
		dt_emissao_nf_w, 
		ds_procedencia_w,	 
		ds_motivo_alta_w,	 
		ds_tipo_atend_conta_w 
	from	conta_paciente c, 
		atendimento_paciente a, 
		pessoa_fisica p 
	where	c.nr_interno_conta 	= nr_interno_conta_w 
	and	a.nr_atendimento	= c.nr_atendimento 
	and	a.cd_pessoa_fisica 	= p.cd_pessoa_fisica;	
		 
	open C02;
	loop 
	fetch C02 into	 
		nr_sequencia_proc_w, 
		cd_procedimento_w, 
		ie_origem_proced_w, 
		nr_seq_proc_pacote_w;
	EXIT WHEN NOT FOUND; /* apply on C02 */
		begin 
					 
		Select	1 cd_tipo_item, 
			--'Procedimentos' ds_tipo_item, 
			wheb_mensagem_pck.get_texto(303209) ds_tipo_item, 
			v.cd_procedimento, 
			substr(obter_descricao_procedimento(v.cd_procedimento,v.ie_origem_proced), 1, 100) ds_procedimento, 
			v.dt_procedimento, 
			v.qt_procedimento, 
			0 vl_unitario, 
			CASE WHEN v.ie_emite_conta='77' THEN  0  ELSE v.vl_procedimento END  vl_procedimento, 
			v.nr_seq_proc_pacote, 
			v.cd_setor_atendimento cd_setor_atendimento_conta, 
			obter_nome_setor(v.cd_setor_atendimento) ds_setor_atendimento_conta, 
			v.ie_emite_conta, 
			substr(obter_desc_estrut_conta(somente_numero(v.ie_emite_conta)), 1, 60) ds_emite_conta, 
			v.cd_motivo_exc_conta, 
			1 cd_ordem_visualizacao,	 
			null ie_proc_mat, 
			null, 
			null ds_item, 
			null, 
			null, 
			null vl_unit_item, 
			null vl_item, 
			null vl_original, 
			null ie_emite_conta_item, 
			null ds_emite_conta_item, 
			null cd_setor_atendimento_item, 
			null ds_setor_atendimento_item 
		into STRICT	cd_tipo_item_w,				 
			ds_tipo_item_w,				 
			cd_procedimento_w, 
			ds_procedimento_w,			 
			dt_procedimento_w,			 
			qt_procedimento_w,			 
			vl_unitario_w,				 
			vl_procedimento_w,			 
			nr_seq_proc_pacote_w,			 
			cd_setor_atendimento_conta_w,		 
			ds_setor_atendimento_conta_w,		 
			ie_emite_conta_w,			 
			ds_emite_conta_w,			 
			cd_motivo_exc_conta_w,			 
			cd_ordem_visualizacao_w,			 
			ie_proc_mat_w,				 
			cd_item_w,				 
			ds_item_w,				 
			dt_item_w,				 
			qt_item_w,				 
			vl_unit_item_w, 
			vl_item_w,				 
			vl_original_w,				 
			ie_emite_conta_item_w,			 
			ds_emite_conta_item_w,			 
			cd_setor_atendimento_item_w,		 
			ds_setor_atendimento_item_w 
		FROM procedimento_paciente v, (v
LEFT OUTER JOIN proc_paciente_valor g ON (v.nr_sequencia = g.nr_seq_procedimento AND 1 = g.ie_tipo_valor)
WHERE v.nr_interno_conta = nr_interno_conta_w and coalesce(v.cd_motivo_exc_conta::text, '') = '' and coalesce(v.nr_seq_proc_pacote::text, '') = '' and v.nr_sequencia = nr_sequencia_proc_w;	
		 
		select	coalesce(sum(qt_resumo),0), 
			coalesce(sum(vl_custo),0) 
		into STRICT	qt_resumo_w, 
			vl_custo_w		 
		from	conta_paciente_resumo 
		where	cd_procedimento = cd_procedimento_w 
		and	ie_origem_proced = ie_origem_proced_w 
		and	nr_interno_conta = nr_interno_conta_w; 	
		 
		vl_custo_unitario_w:= dividir(vl_custo_w,qt_resumo_w);
		 
		insert into w_fat_analise_gerencial( 
				NM_USUARIO,                
				DT_ATUALIZACAO, 
				NR_INTERNO_CONTA, 
				NR_ATENDIMENTO,		 
				DT_ENTRADA,                                   
				IE_TIPO_ATENDIMENTO,                               
				DS_TIPO_ATENDIMENTO,                               
				DT_ALTA,                                    
				IE_CLINICA,                                   
				DS_CLINICA,                                   
				CD_CONVENIO,                                   
				DS_CONVENIO,                                   
				CD_CATEGORIA,                                  
				DS_CATEGORIA,                                  
				CD_PLANO,                                    
				DS_PLANO,                                    
				NM_PRIMEIRO_MEDICO,                               
				NR_CRM_PRIMEIRO_MEDICO,                             
				DS_PRIMEIRO_MEDICO_CRM,                             
				DS_ESPEC_PRIMEIRO_MEDICO,                            
				NM_MEDICO_ALTA,                                 
				DS_MEDICO_CRM_ALTA,                               
				DS_ESPEC_MEDICO_ALTA,                              
				CD_PROC_PRINCIPAL_AMB,                              
				CD_CID_PRINCIPAL,                                
				DS_CID_PRINCIPAL,                                
				CD_PROC_PRINCIPAL_ATEND,                             
				DS_PROC_PRINCIPAL_ATEND,                             
				NM_PESSOA_FISICA,                                
				NR_PRONTUARIO,                                  
				IE_SEXO,                                     
				DT_NASCIMENTO,                                  
				NR_ANOS,                                     
				DS_ESTADO_CIVIL,                                 
				NR_IDENTIDADE,                                  
				DS_ENDERECO,                                   
				DS_BAIRRO,                                    
				DS_MUNICIPIO,                                  
				SG_ESTADO,                                    
				CD_CEP,                                     
				NR_CRM_MEDICO_ALTA,                               
				DS_ESPECIALIDADE_CONTA,                             
				DT_PERIODO_INICIAL,                               
				DT_PERIODO_FINAL,                                
				DT_MESANO_REFERENCIA,                              
				IE_STATUS_ACERTO,                                
				DS_STATUS_ACERTO,                                
				CD_CONVENIO_PARAMETRO,                              
				DS_CONVENIO_CONTA,                                
				NR_PROTOCOLO,                                  
				NR_SEQ_PROTOCOLO,                                
				CD_ESPECIALIDADE_CONTA,                             
				NR_NOTA_FISCAL,                                 
				DT_EMISSAO_NF,                                  
				CD_TIPO_ITEM,                                  
				CD_PROCEDIMENTO,                                 
				DS_TIPO_ITEM,                                  
				DS_PROCEDIMENTO,                                 
				DT_PROCEDIMENTO,                                 
				QT_PROCEDIMENTO,                                 
				VL_UNITARIO,                                   
				VL_PROCEDIMENTO,                                 
				CD_SETOR_ATEND_CONTA,                              
				DS_SETOR_ATEND_CONTA,                              
				IE_EMITE_CONTA,                                 
				DS_EMITE_CONTA,                                 
				CD_MOTIVO_EXC_CONTA,                               
				CD_ORDEM_VISUALIZACAO,                              
				IE_PROC_MAT,                                   
				CD_ITEM,                                     
				DS_ITEM,                                    
				DT_ITEM,                                     
				QT_ITEM,                                     
				VL_UNIT_ITEM,                                  
				VL_ITEM,                                     
				VL_ORIGINAL,                                   
				IE_EMITE_CONTA_ITEM,                               
				DS_EMITE_CONTA_ITEM,                               
				CD_SETOR_ATEND_ITEM,                               
				DS_SETOR_ATEND_ITEM,                               
				VL_CUSTO_UNITARIO, 
				DS_PROCEDENCIA,	 
			    DS_MOTIVO_ALTA,	 
			    DS_TIPO_ATEND_CONTA, 
				nr_seq_proc_pacote) 
		values (		nm_usuario_p, 
				clock_timestamp(), 
				nr_interno_conta_w, 
				nr_atendimento_w,			 
				dt_entrada_w,				 
				ie_tipo_atendimento_w,			 
				ds_tipo_atendimento_w,			 
				dt_alta_w,				 
				ie_clinica_w,				 
				ds_clinica_w,				 
				cd_convenio_w,				 
				ds_convenio_w,				 
				cd_categoria_w,				 
				ds_categoria_w,			 
				cd_plano_w,				 
				ds_plano_w,				 
				nm_primeiro_medico_w,			 
				nr_crm_primeiro_medico_w,		 
				ds_primeiro_medico_crm_w,		 
				ds_espec_primeiro_medico_w,		 
				nm_medico_alta_w,			 
				ds_medico_crm_alta_w,			 
				ds_espec_medico_alta_w,			 
				cd_proc_principal_amb_w,			 
				cd_cid_principal_w,			 
				ds_cid_principal_w,			 
				cd_proc_principal_atend_w,		 
				ds_proc_principal_atend_w,		 
				nm_pessoa_fisica_w,			 
				nr_prontuario_w,				 
				ie_sexo_w,				 
				dt_nascimento_w,				 
				nr_anos_w,				 
				ds_estado_civil_w,			 
				nr_identidade_w,				 
				ds_endereco_w,				 
				ds_bairro_w,				 
				ds_municipio_w,				 
				sg_estado_w,				 
				cd_cep_w,				 
				nr_crm_medico_alta_w,			 
				ds_especialidade_conta_w,		 
				dt_periodo_inicial_w,			 
				dt_periodo_final_w,			 
				dt_mesano_referencia_w,			 
				ie_status_acerto_w,			 
				ds_status_acerto_w,			 
				cd_convenio_parametro_w,			 
				ds_convenio_conta_w,			 
				nr_protocolo_w,				 
				nr_seq_protocolo_w,			 
				cd_especialidade_conta_w, 
				nr_nota_fiscal_w, 
				dt_emissao_nf_w, 
				cd_tipo_item_w,				 
				cd_procedimento_w, 
				ds_tipo_item_w,				 
				ds_procedimento_w,			 
				trunc(dt_procedimento_w), 
				qt_procedimento_w,			 
				vl_unitario_w,				 
				vl_procedimento_w,			 
				cd_setor_atendimento_conta_w,		 
				ds_setor_atendimento_conta_w,		 
				ie_emite_conta_w,			 
				ds_emite_conta_w,			 
				cd_motivo_exc_conta_w,			 
				cd_ordem_visualizacao_w,			 
				ie_proc_mat_w,				 
				cd_item_w,				 
				ds_item_w,				 
				dt_item_w,				 
				qt_item_w,				 
				vl_unit_item_w, 
				vl_item_w,				 
				vl_original_w,				 
				ie_emite_conta_item_w,			 
				ds_emite_conta_item_w,			 
				cd_setor_atendimento_item_w,		 
				ds_setor_atendimento_item_w,		 
				vl_custo_unitario_w, 
				ds_procedencia_w,	 
			    ds_motivo_alta_w,	 
			    ds_tipo_atend_conta_w, 
				nr_seq_proc_pacote_w);
		end;	
	end loop;
	close C02;
	 
	open C05;
	loop 
	fetch C05 into	 
		nr_sequencia_mat_w, 
		cd_material_w, 
		nr_seq_proc_pacote_w;
	EXIT WHEN NOT FOUND; /* apply on C05 */
		begin 
		 
		select 	2 cd_tipo_item, 
			--'Materiais/Medicamentos' ds_tipo_item, 
			wheb_mensagem_pck.get_texto(303210) ds_tipo_item, 
			m.cd_material, 
			obter_dados_material(m.cd_material, 'D') ds_material, 
			m.dt_atendimento, 
			m.qt_material, 
			m.vl_unitario, 
			m.vl_material, 
			m.nr_seq_proc_pacote, 
			m.cd_setor_atendimento cd_setor_atendimento_conta, 
			obter_nome_setor(m.cd_setor_atendimento) ds_setor_atendimento_conta, 
			m.ie_emite_conta, 
			substr(obter_desc_estrut_conta(somente_numero(m.ie_emite_conta)), 1, 60) ds_emite_conta, 
			m.cd_motivo_exc_conta, 
			CASE WHEN coalesce(m.nr_seq_proc_pacote::text, '') = '' THEN 1 WHEN m.nr_seq_proc_pacote=m.nr_seq_proc_pacote THEN m.nr_sequencia WHEN m.nr_seq_proc_pacote=2 THEN 3 END  cd_ordem_visualizacao, 
			null ie_proc_mat, 
			null cd_item, 
			null ds_item, 
			null dt_item, 
			null qt_item, 
			null vl_unit_item, 
			null vl_item, 
			null vl_original, 
			null ie_emite_conta_item, 
			null ds_emite_conta_item, 
			null cd_setor_atendimento_item, 
			null ds_setor_atendimento_item 
		into STRICT	cd_tipo_item_w,				 
			ds_tipo_item_w,				 
			cd_procedimento_w, 
			ds_procedimento_w,			 
			dt_procedimento_w,			 
			qt_procedimento_w,			 
			vl_unitario_w,				 
			vl_procedimento_w,			 
			nr_seq_proc_pacote_w,			 
			cd_setor_atendimento_conta_w,		 
			ds_setor_atendimento_conta_w,		 
			ie_emite_conta_w,			 
			ds_emite_conta_w,			 
			cd_motivo_exc_conta_w,			 
			cd_ordem_visualizacao_w,			 
			ie_proc_mat_w,				 
			cd_item_w,				 
			ds_item_w,				 
			dt_item_w,				 
			qt_item_w,				 
			vl_unit_item_w, 
			vl_item_w,				 
			vl_original_w,				 
			ie_emite_conta_item_w,			 
			ds_emite_conta_item_w,			 
			cd_setor_atendimento_item_w,		 
			ds_setor_atendimento_item_w 
		from	material_atend_paciente m 
		where	m.nr_sequencia = nr_sequencia_mat_w 
		and	coalesce(m.cd_motivo_exc_conta::text, '') = '' 
		and (coalesce(m.nr_seq_proc_pacote::text, '') = '');
		 
		select	coalesce(sum(qt_resumo),0), 
			coalesce(sum(vl_custo),0) 
		into STRICT	qt_resumo_w, 
			vl_custo_w		 
		from	conta_paciente_resumo 
		where	cd_material = cd_procedimento_w 
		and	nr_interno_conta = nr_interno_conta_w; 		
		 
		vl_custo_unitario_w:= dividir(vl_custo_w,qt_resumo_w);
				 
		insert into w_fat_analise_gerencial( 
				NM_USUARIO,                
				DT_ATUALIZACAO, 
				NR_INTERNO_CONTA, 
				NR_ATENDIMENTO,		 
				DT_ENTRADA,                                   
				IE_TIPO_ATENDIMENTO,                               
				DS_TIPO_ATENDIMENTO,                               
				DT_ALTA,                                    
				IE_CLINICA,                                   
				DS_CLINICA,                                   
				CD_CONVENIO,                                   
				DS_CONVENIO,                                   
				CD_CATEGORIA,                                  
				DS_CATEGORIA,                                  
				CD_PLANO,                                    
				DS_PLANO,                                    
				NM_PRIMEIRO_MEDICO,                               
				NR_CRM_PRIMEIRO_MEDICO,                             
				DS_PRIMEIRO_MEDICO_CRM,                             
				DS_ESPEC_PRIMEIRO_MEDICO,                            
				NM_MEDICO_ALTA,                                 
				DS_MEDICO_CRM_ALTA,                               
				DS_ESPEC_MEDICO_ALTA,                              
				CD_PROC_PRINCIPAL_AMB,                              
				CD_CID_PRINCIPAL,                                
				DS_CID_PRINCIPAL,                                
				CD_PROC_PRINCIPAL_ATEND,                             
				DS_PROC_PRINCIPAL_ATEND,                             
				NM_PESSOA_FISICA,                                
				NR_PRONTUARIO,                                  
				IE_SEXO,                                     
				DT_NASCIMENTO,                                  
				NR_ANOS,                                     
				DS_ESTADO_CIVIL,                                 
				NR_IDENTIDADE,                                  
				DS_ENDERECO,                                   
				DS_BAIRRO,                                    
				DS_MUNICIPIO,                                  
				SG_ESTADO,                                    
				CD_CEP,                                     
				NR_CRM_MEDICO_ALTA,                               
				DS_ESPECIALIDADE_CONTA,                             
				DT_PERIODO_INICIAL,                               
				DT_PERIODO_FINAL,                                
				DT_MESANO_REFERENCIA,                              
				IE_STATUS_ACERTO,                                
				DS_STATUS_ACERTO,                                
				CD_CONVENIO_PARAMETRO,                              
				DS_CONVENIO_CONTA,                                
				NR_PROTOCOLO,                                  
				NR_SEQ_PROTOCOLO,                                
				CD_ESPECIALIDADE_CONTA,                             
				NR_NOTA_FISCAL,                                 
				DT_EMISSAO_NF,                                  
				CD_TIPO_ITEM,                                  
				CD_PROCEDIMENTO,                                 
				DS_TIPO_ITEM,                                  
				DS_PROCEDIMENTO,                                 
				DT_PROCEDIMENTO,                                 
				QT_PROCEDIMENTO,                                 
				VL_UNITARIO,                                   
				VL_PROCEDIMENTO,                                 
				CD_SETOR_ATEND_CONTA,                              
				DS_SETOR_ATEND_CONTA,                              
				IE_EMITE_CONTA,                                 
				DS_EMITE_CONTA,                                 
				CD_MOTIVO_EXC_CONTA,                               
				CD_ORDEM_VISUALIZACAO,                              
				IE_PROC_MAT,                                   
				CD_ITEM,                                     
				DS_ITEM,                                    
				DT_ITEM,                                     
				QT_ITEM,                                     
				VL_UNIT_ITEM,                                  
				VL_ITEM,                                     
				VL_ORIGINAL,                                   
				IE_EMITE_CONTA_ITEM,                               
				DS_EMITE_CONTA_ITEM,                               
				CD_SETOR_ATEND_ITEM,                               
				DS_SETOR_ATEND_ITEM,                               
				VL_CUSTO_UNITARIO, 
				DS_PROCEDENCIA,	 
			    DS_MOTIVO_ALTA,	 
			    DS_TIPO_ATEND_CONTA, 
				nr_seq_proc_pacote) 
		values (		nm_usuario_p, 
				clock_timestamp(), 
				nr_interno_conta_w, 
				nr_atendimento_w,			 
				dt_entrada_w,				 
				ie_tipo_atendimento_w,			 
				ds_tipo_atendimento_w,			 
				dt_alta_w,				 
				ie_clinica_w,				 
				ds_clinica_w,				 
				cd_convenio_w,				 
				ds_convenio_w,				 
				cd_categoria_w,				 
				ds_categoria_w,			 
				cd_plano_w,				 
				ds_plano_w,				 
				nm_primeiro_medico_w,			 
				nr_crm_primeiro_medico_w,		 
				ds_primeiro_medico_crm_w,		 
				ds_espec_primeiro_medico_w,		 
				nm_medico_alta_w,			 
				ds_medico_crm_alta_w,			 
				ds_espec_medico_alta_w,			 
				cd_proc_principal_amb_w,			 
				cd_cid_principal_w,			 
				ds_cid_principal_w,			 
				cd_proc_principal_atend_w,		 
				ds_proc_principal_atend_w,		 
				nm_pessoa_fisica_w,			 
				nr_prontuario_w,				 
				ie_sexo_w,				 
				dt_nascimento_w,				 
				nr_anos_w,				 
				ds_estado_civil_w,			 
				nr_identidade_w,				 
				ds_endereco_w,				 
				ds_bairro_w,				 
				ds_municipio_w,				 
				sg_estado_w,				 
				cd_cep_w,				 
				nr_crm_medico_alta_w,			 
				ds_especialidade_conta_w,		 
				dt_periodo_inicial_w,			 
				dt_periodo_final_w,			 
				dt_mesano_referencia_w,			 
				ie_status_acerto_w,			 
				ds_status_acerto_w,			 
				cd_convenio_parametro_w,			 
				ds_convenio_conta_w,			 
				nr_protocolo_w,				 
				nr_seq_protocolo_w,			 
				cd_especialidade_conta_w, 
				nr_nota_fiscal_w, 
				dt_emissao_nf_w, 
				cd_tipo_item_w,				 
				cd_procedimento_w, 
				ds_tipo_item_w,				 
				ds_procedimento_w,			 
				trunc(dt_procedimento_w), 
				qt_procedimento_w,			 
				vl_unitario_w,				 
				vl_procedimento_w,			 
				cd_setor_atendimento_conta_w,		 
				ds_setor_atendimento_conta_w,		 
				ie_emite_conta_w,			 
				ds_emite_conta_w,			 
				cd_motivo_exc_conta_w,			 
				cd_ordem_visualizacao_w,			 
				ie_proc_mat_w,				 
				cd_item_w,				 
				ds_item_w,				 
				dt_item_w,				 
				qt_item_w,				 
				vl_unit_item_w, 
				vl_item_w,				 
				vl_original_w,				 
				ie_emite_conta_item_w,			 
				ds_emite_conta_item_w,			 
				cd_setor_atendimento_item_w,		 
				ds_setor_atendimento_item_w,		 
				vl_custo_unitario_w, 
				ds_procedencia_w,	 
			    ds_motivo_alta_w,	 
			    ds_tipo_atend_conta_w, 
				nr_seq_proc_pacote_w);
-- Ate aqui graviou tudo sem pacote				 
		end;
	end loop;
	close C05;
	 
	open C07;
	loop 
	fetch C07 into	 
		nr_sequencia_proc_w, 
		cd_procedimento_w, 
		ie_origem_proced_w, 
		nr_seq_pacote_cursor_7_w;
	EXIT WHEN NOT FOUND; /* apply on C07 */
		begin 
		 
				 
		Select	1 cd_tipo_item, 
			--'Procedimentos' ds_tipo_item, 
			wheb_mensagem_pck.get_texto(303209) ds_tipo_item, 
			v.cd_procedimento, 
			substr(obter_descricao_procedimento(v.cd_procedimento,v.ie_origem_proced), 1, 100) ds_procedimento, 
			v.dt_procedimento, 
			v.qt_procedimento, 
			0 vl_unitario, 
			CASE WHEN v.ie_emite_conta='77' THEN  0  ELSE v.vl_procedimento END  vl_procedimento, 
			v.nr_seq_proc_pacote, 
			v.cd_setor_atendimento cd_setor_atendimento_conta, 
			obter_nome_setor(v.cd_setor_atendimento) ds_setor_atendimento_conta, 
			v.ie_emite_conta, 
			substr(obter_desc_estrut_conta(somente_numero(v.ie_emite_conta)), 1, 60) ds_emite_conta, 
			v.cd_motivo_exc_conta, 
			1 cd_ordem_visualizacao,	 
			null ie_proc_mat, 
			null, 
			null ds_item, 
			null, 
			null, 
			null vl_unit_item, 
			null vl_item, 
			null vl_original, 
			null ie_emite_conta_item, 
			null ds_emite_conta_item, 
			null cd_setor_atendimento_item, 
			null ds_setor_atendimento_item 
		into STRICT	cd_tipo_item_w,				 
			ds_tipo_item_w,				 
			cd_procedimento_w, 
			ds_procedimento_w,			 
			dt_procedimento_w,			 
			qt_procedimento_w,			 
			vl_unitario_w,				 
			vl_procedimento_w,			 
			nr_seq_proc_pacote_w,			 
			cd_setor_atendimento_conta_w,		 
			ds_setor_atendimento_conta_w,		 
			ie_emite_conta_w,			 
			ds_emite_conta_w,			 
			cd_motivo_exc_conta_w,			 
			cd_ordem_visualizacao_w,			 
			ie_proc_mat_w,				 
			cd_item_w,				 
			ds_item_w,				 
			dt_item_w,				 
			qt_item_w,				 
			vl_unit_item_w, 
			vl_item_w,				 
			vl_original_w,				 
			ie_emite_conta_item_w,			 
			ds_emite_conta_item_w,			 
			cd_setor_atendimento_item_w,		 
			ds_setor_atendimento_item_w 
		FROM procedimento_paciente v, (v
LEFT OUTER JOIN proc_paciente_valor g ON (v.nr_sequencia = g.nr_seq_procedimento AND 1 = g.ie_tipo_valor)
WHERE v.nr_interno_conta = nr_interno_conta_w and coalesce(v.cd_motivo_exc_conta::text, '') = '' and (v.nr_seq_proc_pacote IS NOT NULL AND v.nr_seq_proc_pacote::text <> '') and v.nr_sequencia = coalesce(v.nr_seq_proc_pacote,0) and v.nr_sequencia = nr_sequencia_proc_w;	
		 
		open C08;
		loop 
		fetch C08 into	 
			nr_sequencia_proc_w, 
			cd_procedimento_w, 
			ie_origem_proced_w, 
			nr_seq_proc_pacote_w;
		EXIT WHEN NOT FOUND; /* apply on C08 */
			begin 
					 
			Select	1 ie_proc_mat, 
				v.cd_procedimento, 
				substr(obter_descricao_procedimento(v.cd_procedimento,v.ie_origem_proced), 1, 100) ds_item, 
				dt_procedimento, 
				v.qt_procedimento, 
				dividir(v.vl_procedimento,v.qt_procedimento) vl_unit_item, 
				v.vl_procedimento vl_item, 
				coalesce(g.vl_procedimento,v.vl_procedimento) vl_original, 
				v.ie_emite_conta ie_emite_conta_item, 
				substr(obter_desc_estrut_conta(somente_numero(v.ie_emite_conta)), 1, 60) ds_emite_conta_item, 
				v.cd_setor_atendimento cd_setor_atendimento_item, 
				obter_nome_setor(v.cd_setor_atendimento) ds_setor_atendimento_item 
			into STRICT	ie_proc_mat_w,				 
				cd_item_w,				 
				ds_item_w,				 
				dt_item_w,				 
				qt_item_w,				 
				vl_unit_item_w, 
				vl_item_w,				 
				vl_original_w,				 
				ie_emite_conta_item_w,			 
				ds_emite_conta_item_w,			 
				cd_setor_atendimento_item_w,		 
				ds_setor_atendimento_item_w 
			FROM procedimento_paciente v, (v
LEFT OUTER JOIN proc_paciente_valor g ON (v.nr_sequencia = g.nr_seq_procedimento AND 1 = g.ie_tipo_valor)
WHERE v.nr_interno_conta = nr_interno_conta_w and coalesce(v.cd_motivo_exc_conta::text, '') = '' and v.nr_sequencia = nr_sequencia_proc_w;
			 
	 
					 
			select	coalesce(sum(qt_resumo),0), 
				coalesce(sum(vl_custo),0) 
			into STRICT	qt_resumo_w, 
				vl_custo_w		 
			from	conta_paciente_resumo 
			where	cd_procedimento = cd_procedimento_w 
			and	ie_origem_proced = ie_origem_proced_w 
			and	nr_interno_conta = nr_interno_conta_w; 	
			 
			vl_custo_unitario_w:= dividir(vl_custo_w,qt_resumo_w);
 
			insert into w_fat_analise_gerencial( 
				NM_USUARIO,                
				DT_ATUALIZACAO, 
				NR_INTERNO_CONTA, 
				NR_ATENDIMENTO,		 
				DT_ENTRADA,                                   
				IE_TIPO_ATENDIMENTO,                               
				DS_TIPO_ATENDIMENTO,                               
				DT_ALTA,                                    
				IE_CLINICA,                                   
				DS_CLINICA,                                   
				CD_CONVENIO,                                   
				DS_CONVENIO,                                   
				CD_CATEGORIA,                                  
				DS_CATEGORIA,                                  
				CD_PLANO,                                    
				DS_PLANO,                                    
				NM_PRIMEIRO_MEDICO,                               
				NR_CRM_PRIMEIRO_MEDICO,                             
				DS_PRIMEIRO_MEDICO_CRM,                             
				DS_ESPEC_PRIMEIRO_MEDICO,                            
				NM_MEDICO_ALTA,                                 
				DS_MEDICO_CRM_ALTA,                               
				DS_ESPEC_MEDICO_ALTA,                              
				CD_PROC_PRINCIPAL_AMB,                              
				CD_CID_PRINCIPAL,                                
				DS_CID_PRINCIPAL,                                
				CD_PROC_PRINCIPAL_ATEND,                             
				DS_PROC_PRINCIPAL_ATEND,                             
				NM_PESSOA_FISICA,                                
				NR_PRONTUARIO,                                  
				IE_SEXO,                                     
				DT_NASCIMENTO,                                  
				NR_ANOS,                                     
				DS_ESTADO_CIVIL,                                 
				NR_IDENTIDADE,                                  
				DS_ENDERECO,                                   
				DS_BAIRRO,                                    
				DS_MUNICIPIO,                                  
				SG_ESTADO,                                    
				CD_CEP,                                     
				NR_CRM_MEDICO_ALTA,                               
				DS_ESPECIALIDADE_CONTA,                             
				DT_PERIODO_INICIAL,                               
				DT_PERIODO_FINAL,                                
				DT_MESANO_REFERENCIA,                              
				IE_STATUS_ACERTO,                                
				DS_STATUS_ACERTO,                                
				CD_CONVENIO_PARAMETRO,                              
				DS_CONVENIO_CONTA,                                
				NR_PROTOCOLO,                                  
				NR_SEQ_PROTOCOLO,                                
				CD_ESPECIALIDADE_CONTA,                             
				NR_NOTA_FISCAL,                                 
				DT_EMISSAO_NF,                                  
				CD_TIPO_ITEM,                                  
				CD_PROCEDIMENTO,                                 
				DS_TIPO_ITEM,                                  
				DS_PROCEDIMENTO,                                 
				DT_PROCEDIMENTO,                                 
				QT_PROCEDIMENTO,                                 
				VL_UNITARIO,                                   
				VL_PROCEDIMENTO,                                 
				CD_SETOR_ATEND_CONTA,                              
				DS_SETOR_ATEND_CONTA,                              
				IE_EMITE_CONTA,                                 
				DS_EMITE_CONTA,                                 
				CD_MOTIVO_EXC_CONTA,                               
				CD_ORDEM_VISUALIZACAO,                              
				IE_PROC_MAT,                                   
				CD_ITEM,                                     
				DS_ITEM,                                    
				DT_ITEM,                                     
				QT_ITEM,                                     
				VL_UNIT_ITEM,                                  
				VL_ITEM,                                     
				VL_ORIGINAL,                                   
				IE_EMITE_CONTA_ITEM,                               
				DS_EMITE_CONTA_ITEM,                               
				CD_SETOR_ATEND_ITEM,                               
				DS_SETOR_ATEND_ITEM,                               
				VL_CUSTO_UNITARIO, 
				ds_procedencia,	 
			    ds_motivo_alta,	 
			    ds_tipo_atend_conta, 
				nr_seq_proc_pacote) 
		values (		nm_usuario_p, 
				clock_timestamp(), 
				nr_interno_conta_w, 
				nr_atendimento_w,			 
				dt_entrada_w,				 
				ie_tipo_atendimento_w,			 
				ds_tipo_atendimento_w,			 
				dt_alta_w,				 
				ie_clinica_w,				 
				ds_clinica_w,				 
				cd_convenio_w,				 
				ds_convenio_w,				 
				cd_categoria_w,				 
				ds_categoria_w,			 
				cd_plano_w,				 
				ds_plano_w,				 
				nm_primeiro_medico_w,			 
				nr_crm_primeiro_medico_w,		 
				ds_primeiro_medico_crm_w,		 
				ds_espec_primeiro_medico_w,		 
				nm_medico_alta_w,			 
				ds_medico_crm_alta_w,			 
				ds_espec_medico_alta_w,			 
				cd_proc_principal_amb_w,			 
				cd_cid_principal_w,			 
				ds_cid_principal_w,			 
				cd_proc_principal_atend_w,		 
				ds_proc_principal_atend_w,		 
				nm_pessoa_fisica_w,			 
				nr_prontuario_w,				 
				ie_sexo_w,				 
				dt_nascimento_w,				 
				nr_anos_w,				 
				ds_estado_civil_w,			 
				nr_identidade_w,				 
				ds_endereco_w,				 
				ds_bairro_w,				 
				ds_municipio_w,				 
				sg_estado_w,				 
				cd_cep_w,				 
				nr_crm_medico_alta_w,			 
				ds_especialidade_conta_w,		 
				dt_periodo_inicial_w,			 
				dt_periodo_final_w,			 
				dt_mesano_referencia_w,			 
				ie_status_acerto_w,			 
				ds_status_acerto_w,			 
				cd_convenio_parametro_w,			 
				ds_convenio_conta_w,			 
				nr_protocolo_w,				 
				nr_seq_protocolo_w,			 
				cd_especialidade_conta_w, 
				nr_nota_fiscal_w, 
				dt_emissao_nf_w, 
				cd_tipo_item_w,				 
				cd_procedimento_w, 
				ds_tipo_item_w,				 
				ds_procedimento_w,			 
				trunc(dt_procedimento_w), 
				qt_procedimento_w,			 
				vl_unitario_w,				 
				vl_procedimento_w,			 
				cd_setor_atendimento_conta_w,		 
				ds_setor_atendimento_conta_w,		 
				ie_emite_conta_w,			 
				ds_emite_conta_w,			 
				cd_motivo_exc_conta_w,			 
				cd_ordem_visualizacao_w,			 
				ie_proc_mat_w,				 
				cd_item_w,				 
				ds_item_w,				 
				dt_item_w,				 
				qt_item_w,				 
				vl_unit_item_w, 
				vl_item_w,				 
				vl_original_w,				 
				ie_emite_conta_item_w,			 
				ds_emite_conta_item_w,			 
				cd_setor_atendimento_item_w,		 
				ds_setor_atendimento_item_w,		 
				vl_custo_unitario_w, 
				ds_procedencia_w,	 
			    ds_motivo_alta_w,	 
			    ds_tipo_atend_conta_w, 
				nr_seq_proc_pacote_w);
			 
						 
			end;
		end loop;
		close C08;
		 
		 
			 
		end;
	end loop;
	close C07;
	 
	--materiais 
	 
	open C07;
	loop 
	fetch C07 into	 
		nr_sequencia_proc_w, 
		cd_procedimento_w, 
		ie_origem_proced_w, 
		nr_seq_pacote_cursor_7_w;
	EXIT WHEN NOT FOUND; /* apply on C07 */
		begin 
		 
				 
		Select	1 cd_tipo_item, 
			--'Procedimentos' ds_tipo_item, 
			wheb_mensagem_pck.get_texto(303209) ds_tipo_item, 
			v.cd_procedimento, 
			substr(obter_descricao_procedimento(v.cd_procedimento,v.ie_origem_proced), 1, 100) ds_procedimento, 
			v.dt_procedimento, 
			v.qt_procedimento, 
			0 vl_unitario, 
			CASE WHEN v.ie_emite_conta='77' THEN  0  ELSE v.vl_procedimento END  vl_procedimento, 
			v.nr_seq_proc_pacote, 
			v.cd_setor_atendimento cd_setor_atendimento_conta, 
			obter_nome_setor(v.cd_setor_atendimento) ds_setor_atendimento_conta, 
			v.ie_emite_conta, 
			substr(obter_desc_estrut_conta(somente_numero(v.ie_emite_conta)), 1, 60) ds_emite_conta, 
			v.cd_motivo_exc_conta, 
			1 cd_ordem_visualizacao,	 
			null ie_proc_mat, 
			null, 
			null ds_item, 
			null, 
			null, 
			null vl_unit_item, 
			null vl_item, 
			null vl_original, 
			null ie_emite_conta_item, 
			null ds_emite_conta_item, 
			null cd_setor_atendimento_item, 
			null ds_setor_atendimento_item 
		into STRICT	cd_tipo_item_w,				 
			ds_tipo_item_w,				 
			cd_procedimento_w, 
			ds_procedimento_w,			 
			dt_procedimento_w,			 
			qt_procedimento_w,			 
			vl_unitario_w,				 
			vl_procedimento_w,			 
			nr_seq_proc_pacote_w,			 
			cd_setor_atendimento_conta_w,		 
			ds_setor_atendimento_conta_w,		 
			ie_emite_conta_w,			 
			ds_emite_conta_w,			 
			cd_motivo_exc_conta_w,			 
			cd_ordem_visualizacao_w,			 
			ie_proc_mat_w,				 
			cd_item_w,				 
			ds_item_w,				 
			dt_item_w,				 
			qt_item_w,				 
			vl_unit_item_w, 
			vl_item_w,				 
			vl_original_w,				 
			ie_emite_conta_item_w,			 
			ds_emite_conta_item_w,			 
			cd_setor_atendimento_item_w,		 
			ds_setor_atendimento_item_w 
		FROM procedimento_paciente v, (v
LEFT OUTER JOIN proc_paciente_valor g ON (v.nr_sequencia = g.nr_seq_procedimento AND 1 = g.ie_tipo_valor)
WHERE v.nr_interno_conta = nr_interno_conta_w and coalesce(v.cd_motivo_exc_conta::text, '') = '' and (v.nr_seq_proc_pacote IS NOT NULL AND v.nr_seq_proc_pacote::text <> '') and v.nr_sequencia = coalesce(v.nr_seq_proc_pacote,0) and v.nr_sequencia = nr_sequencia_proc_w;	
		 
		open C10;
		loop 
		fetch C10 into	 
			nr_sequencia_proc_w, 
			cd_procedimento_w, 
			nr_seq_proc_pacote_w;
		EXIT WHEN NOT FOUND; /* apply on C10 */
			begin 
			 
			Select	2 ie_proc_mat, 
				v.cd_material, 
				substr(obter_desc_material(v.cd_material), 1, 100) ds_item, 
				DT_ATENDIMENTO     , 
				v.qt_material, 
				dividir(v.vl_material,v.qt_material) vl_unit_item, 
				v.vl_material vl_item, 
				coalesce(v.vl_tabela_original,v.vl_material)   vl_original, 
				v.ie_emite_conta ie_emite_conta_item, 
				substr(obter_desc_estrut_conta(somente_numero(v.ie_emite_conta)), 1, 60) ds_emite_conta_item, 
				v.cd_setor_atendimento cd_setor_atendimento_item, 
				obter_nome_setor(v.cd_setor_atendimento) ds_setor_atendimento_item 
			into STRICT	ie_proc_mat_w,				 
				cd_item_w,				 
				ds_item_w,				 
				dt_item_w,				 
				qt_item_w,				 
				vl_unit_item_w, 
				vl_item_w,				 
				vl_original_w,				 
				ie_emite_conta_item_w,			 
				ds_emite_conta_item_w,			 
				cd_setor_atendimento_item_w,		 
				ds_setor_atendimento_item_w 
			FROM material_atend_paciente v, (v
LEFT OUTER JOIN mat_atend_paciente_valor g ON (v.nr_sequencia = g.nr_seq_material AND 2 = g.ie_tipo_valor)
WHERE v.nr_interno_conta = nr_interno_conta_w and coalesce(v.cd_motivo_exc_conta::text, '') = '' and v.nr_sequencia = nr_sequencia_proc_w;
					 
			select	coalesce(sum(qt_resumo),0), 
				coalesce(sum(vl_custo),0) 
			into STRICT	qt_resumo_w, 
				vl_custo_w		 
			from	conta_paciente_resumo 
			where	cd_material = cd_procedimento_w 
			and	nr_interno_conta = nr_interno_conta_w; 		
			 
			vl_custo_unitario_w:= dividir(vl_custo_w,qt_resumo_w);
						 
			insert into w_fat_analise_gerencial( 
				NM_USUARIO,                
				DT_ATUALIZACAO, 
				NR_INTERNO_CONTA, 
				NR_ATENDIMENTO,		 
				DT_ENTRADA,                                   
				IE_TIPO_ATENDIMENTO,                               
				DS_TIPO_ATENDIMENTO,                               
				DT_ALTA,                                    
				IE_CLINICA,                                   
				DS_CLINICA,                                   
				CD_CONVENIO,                                   
				DS_CONVENIO,                                   
				CD_CATEGORIA,                                  
				DS_CATEGORIA,                                  
				CD_PLANO,                                    
				DS_PLANO,                                    
				NM_PRIMEIRO_MEDICO,                               
				NR_CRM_PRIMEIRO_MEDICO,                             
				DS_PRIMEIRO_MEDICO_CRM,                             
				DS_ESPEC_PRIMEIRO_MEDICO,                            
				NM_MEDICO_ALTA,                                 
				DS_MEDICO_CRM_ALTA,                               
				DS_ESPEC_MEDICO_ALTA,                              
				CD_PROC_PRINCIPAL_AMB,                              
				CD_CID_PRINCIPAL,                                
				DS_CID_PRINCIPAL,                                
				CD_PROC_PRINCIPAL_ATEND,                             
				DS_PROC_PRINCIPAL_ATEND,                             
				NM_PESSOA_FISICA,                                
				NR_PRONTUARIO,                                  
				IE_SEXO,                                     
				DT_NASCIMENTO,                                  
				NR_ANOS,                                     
				DS_ESTADO_CIVIL,                                 
				NR_IDENTIDADE,                                  
				DS_ENDERECO,                                   
				DS_BAIRRO,                                    
				DS_MUNICIPIO,                                  
				SG_ESTADO,                                    
				CD_CEP,                                     
				NR_CRM_MEDICO_ALTA,                               
				DS_ESPECIALIDADE_CONTA,                             
				DT_PERIODO_INICIAL,                               
				DT_PERIODO_FINAL,                                
				DT_MESANO_REFERENCIA,                              
				IE_STATUS_ACERTO,                                
				DS_STATUS_ACERTO,                                
				CD_CONVENIO_PARAMETRO,                              
				DS_CONVENIO_CONTA,                                
				NR_PROTOCOLO,                                  
				NR_SEQ_PROTOCOLO,                                
				CD_ESPECIALIDADE_CONTA,                             
				NR_NOTA_FISCAL,                                 
				DT_EMISSAO_NF,                                  
				CD_TIPO_ITEM,                                  
				CD_PROCEDIMENTO,                                 
				DS_TIPO_ITEM,                                  
				DS_PROCEDIMENTO,                                 
				DT_PROCEDIMENTO,                                 
				QT_PROCEDIMENTO,                                 
				VL_UNITARIO,                                   
				VL_PROCEDIMENTO,                                 
				CD_SETOR_ATEND_CONTA,                              
				DS_SETOR_ATEND_CONTA,                              
				IE_EMITE_CONTA,                                 
				DS_EMITE_CONTA,                                 
				CD_MOTIVO_EXC_CONTA,                               
				CD_ORDEM_VISUALIZACAO,                              
				IE_PROC_MAT,                                   
				CD_ITEM,                                     
				DS_ITEM,                                    
				DT_ITEM,                                     
				QT_ITEM,                                     
				VL_UNIT_ITEM,                                  
				VL_ITEM,                                     
				VL_ORIGINAL,                                   
				IE_EMITE_CONTA_ITEM,                               
				DS_EMITE_CONTA_ITEM,                               
				CD_SETOR_ATEND_ITEM,                               
				DS_SETOR_ATEND_ITEM,                               
				VL_CUSTO_UNITARIO, 
				DS_PROCEDENCIA,	 
			    DS_MOTIVO_ALTA,	 
			    DS_TIPO_ATEND_CONTA, 
				nr_seq_proc_pacote) 
		values (		nm_usuario_p, 
				clock_timestamp(), 
				nr_interno_conta_w, 
				nr_atendimento_w,			 
				dt_entrada_w,				 
				ie_tipo_atendimento_w,			 
				ds_tipo_atendimento_w,			 
				dt_alta_w,				 
				ie_clinica_w,				 
				ds_clinica_w,				 
				cd_convenio_w,				 
				ds_convenio_w,				 
				cd_categoria_w,				 
				ds_categoria_w,			 
				cd_plano_w,				 
				ds_plano_w,				 
				nm_primeiro_medico_w,			 
				nr_crm_primeiro_medico_w,		 
				ds_primeiro_medico_crm_w,		 
				ds_espec_primeiro_medico_w,		 
				nm_medico_alta_w,			 
				ds_medico_crm_alta_w,			 
				ds_espec_medico_alta_w,			 
				cd_proc_principal_amb_w,			 
				cd_cid_principal_w,			 
				ds_cid_principal_w,			 
				cd_proc_principal_atend_w,		 
				ds_proc_principal_atend_w,		 
				nm_pessoa_fisica_w,			 
				nr_prontuario_w,				 
				ie_sexo_w,				 
				dt_nascimento_w,				 
				nr_anos_w,				 
				ds_estado_civil_w,			 
				nr_identidade_w,				 
				ds_endereco_w,				 
				ds_bairro_w,				 
				ds_municipio_w,				 
				sg_estado_w,				 
				cd_cep_w,				 
				nr_crm_medico_alta_w,			 
				ds_especialidade_conta_w,		 
				dt_periodo_inicial_w,			 
				dt_periodo_final_w,			 
				dt_mesano_referencia_w,			 
				ie_status_acerto_w,			 
				ds_status_acerto_w,			 
				cd_convenio_parametro_w,			 
				ds_convenio_conta_w,			 
				nr_protocolo_w,				 
				nr_seq_protocolo_w,			 
				cd_especialidade_conta_w, 
				nr_nota_fiscal_w, 
				dt_emissao_nf_w, 
				cd_tipo_item_w,				 
				cd_procedimento_w, 
				ds_tipo_item_w,				 
				ds_procedimento_w,			 
				trunc(dt_procedimento_w), 
				qt_procedimento_w,			 
				vl_unitario_w,				 
				vl_procedimento_w,			 
				cd_setor_atendimento_conta_w,		 
				ds_setor_atendimento_conta_w,		 
				ie_emite_conta_w,			 
				ds_emite_conta_w,			 
				cd_motivo_exc_conta_w,			 
				cd_ordem_visualizacao_w,			 
				ie_proc_mat_w,				 
				cd_item_w,				 
				ds_item_w,				 
				dt_item_w,				 
				qt_item_w,				 
				vl_unit_item_w, 
				vl_item_w,				 
				vl_original_w,				 
				ie_emite_conta_item_w,			 
				ds_emite_conta_item_w,			 
				cd_setor_atendimento_item_w,		 
				ds_setor_atendimento_item_w,		 
				vl_custo_unitario_w, 
				ds_procedencia_w,	 
			    ds_motivo_alta_w,	 
			    ds_tipo_atend_conta_w, 
				nr_seq_proc_pacote_w);
			end;
		end loop;
		close C10;
	 
		 
			 
		end;
	end loop;
	close C07;
 
 
	end;
end loop;
close C01;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_w_fat_analise_gerencial (dt_inicial_p timestamp, dt_final_p timestamp, nm_usuario_p text, cd_estabelecimento_p bigint) FROM PUBLIC;

