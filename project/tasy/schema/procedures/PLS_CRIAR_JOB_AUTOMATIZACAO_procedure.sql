-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_criar_job_automatizacao ( ie_acao_p text, nr_job_p INOUT bigint, ds_execucao_p text, dt_execucao_p timestamp, dt_proxima_exec_p text, ie_situacao_p text) AS $body$
DECLARE


/* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
-------------------------------------------------------------------------------------------------------------------

Alterações:		ROTINA CHAMADA DENTRO DE TRIGGER
-------------------------------------------------------------------------------------------------------------------

	ie_acao_p	I - Insert	U - Update	D - Delete
*/
jobno 			integer	:= null;
ds_execucao_w		varchar(255);

procedure remover_job(job_p	bigint) is
qt_job_w	integer;

BEGIN
select	count(1)
into STRICT	qt_job_w
from	all_jobs
where	job = job_p;

if (qt_job_w > 0) then
	dbms_job.remove(job_p);
end if;
end;

begin
ds_execucao_w := substr(upper(ds_execucao_p), 1, 255);

if (ie_acao_p = 'I') or (ie_acao_p = 'U') then -- se for inserção ou alteração
	if (ie_acao_p = 'U') and (nr_job_p IS NOT NULL AND nr_job_p::text <> '') then
		remover_job(nr_job_p);
	end if;
	
	if (ie_situacao_p = 'A') then --Tratamento necessário, pois se estiver inativando a regra, não pode criar a trigger
		dbms_job.submit( jobno, ds_execucao_w, dt_execucao_p, dt_proxima_exec_p);
	end if;
elsif (ie_acao_p = 'D') and -- quando for para excluir
	(nr_job_p IS NOT NULL AND nr_job_p::text <> '') then
	remover_job(nr_job_p);
end if;

nr_job_p := jobno;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_criar_job_automatizacao ( ie_acao_p text, nr_job_p INOUT bigint, ds_execucao_p text, dt_execucao_p timestamp, dt_proxima_exec_p text, ie_situacao_p text) FROM PUBLIC;

