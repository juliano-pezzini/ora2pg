-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE obter_conpaci_retorno ( nr_interno_conta_p bigint, cd_autorizacao_p text, nm_usuario_p text, dt_baixa_p timestamp, vl_saldo_p INOUT bigint, nr_sequencia_p INOUT bigint, ie_novo_p INOUT text) AS $body$
DECLARE


cd_convenio_w		integer;
cd_estabelecimento_w	smallint;
vl_saldo_w		double precision;
ie_doc_retorno_w	varchar(15);
ie_tit_ret_senha_w	varchar(255);



BEGIN

ie_novo_p := 'N';

select	max(cd_estabelecimento),
	max(cd_convenio_parametro)
into STRICT	cd_estabelecimento_w,
	cd_convenio_w
from	conta_paciente
where	nr_interno_conta	= nr_interno_conta_p;

select	Obter_Valor_Conv_Estab(cd_convenio, cd_estabelecimento_w, 'IE_DOC_RETORNO')
into STRICT	ie_doc_retorno_w
from	convenio
where	cd_convenio		= cd_convenio_w;

select	coalesce(max(ie_tit_ret_senha),'N')
into STRICT	ie_tit_ret_senha_w
from	convenio_estabelecimento
where	cd_convenio		= cd_convenio_w
and	cd_estabelecimento	= cd_estabelecimento_w;

begin

select	nr_sequencia,
	vl_pendente
into STRICT	nr_sequencia_p,
	vl_saldo_w
from	conta_paciente_retorno
where	cd_autorizacao		= cd_autorizacao_p
and	nr_interno_conta	= nr_interno_conta_p;

exception
when	no_data_found then

	begin

	select	a.cd_convenio_parametro,
		b.vl_guia
	into STRICT	cd_convenio_w,
		vl_saldo_w
	from	conta_paciente a,
		conta_paciente_guia b
	where 	a.nr_interno_conta	= b.nr_interno_conta
	and 	b.nr_interno_conta	= nr_interno_conta_p
	and (b.cd_autorizacao	= cd_autorizacao_p);

	exception
	when	no_data_found then

		begin

		select	a.cd_convenio_parametro,
			b.vl_titulo
		into STRICT	cd_convenio_w,
			vl_saldo_w
		from	conta_paciente a,
			titulo_receber b
		where	a.nr_interno_conta	= b.nr_interno_conta
		and	b.nr_guia		= cd_autorizacao_p
		and	b.nr_interno_conta	= nr_interno_conta_p;

		exception
		when	no_data_found then

			if (ie_doc_retorno_w = 'CONTA') then

				begin

				select	a.cd_convenio_parametro,
					sum(b.vl_titulo)
				into STRICT	cd_convenio_w,
					vl_saldo_w
				from	conta_paciente a,
					titulo_receber b
				where	a.nr_interno_conta	= b.nr_interno_conta
				and	b.nr_interno_conta	= nr_interno_conta_p
				group by	a.cd_convenio_parametro;

				exception
				when	no_data_found then
					/* Conta: nr_interno_conta_p
					Autorização: cd_autorizacao_p */
					CALL wheb_mensagem_pck.exibir_mensagem_abort(190870,
							'NR_INTERNO_CONTA_P='||nr_interno_conta_p||';'||
							'CD_AUTORIZACAO_P='||cd_autorizacao_p);
				end;

			end if;

			if (ie_tit_ret_senha_w = 'S') then

				select	max(a.cd_convenio_parametro),
					sum(b.vl_guia)
				into STRICT	cd_convenio_w,
					vl_saldo_w
				from	conta_paciente_guia b,
					conta_paciente a
				where	a.nr_interno_conta				= b.nr_interno_conta
				and	coalesce(b.cd_autorizacao, 'Não Informada')		<> cd_autorizacao_p
				and	obter_senha_atendimento(b.nr_atendimento)	= cd_autorizacao_p
				and 	a.nr_interno_conta				= nr_interno_conta_p;

			end if;
		end;
	end;

	if (vl_saldo_w > vl_saldo_p) then

		ie_novo_p := 'S';

		vl_saldo_p := vl_saldo_w - vl_saldo_p;

		select	nextval('conta_paciente_retorno_seq')
		into STRICT	nr_sequencia_p
		;

		insert	into conta_paciente_retorno(nr_sequencia,
			nr_interno_conta,
			cd_autorizacao,
			dt_inicial,
			vl_inicial,
			vl_pendente,
			vl_glosa_devida,
			vl_glosa_indevida,
			vl_reapresentacao,
			dt_atualizacao,
			nm_usuario,
			cd_convenio,
			ie_situacao,
			ds_observacao,
			vl_nao_auditado,
			vl_recebido)
		values (nr_sequencia_p,
			nr_interno_conta_p,
			cd_autorizacao_p,
			coalesce(dt_baixa_p,clock_timestamp()),
			vl_saldo_p,
			vl_saldo_p,
			0,
			0,
			0,
			clock_timestamp(),
			nm_usuario_p,
			cd_convenio_w,
			'P',
			null,
			0,
			0);

	end if;
end;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE obter_conpaci_retorno ( nr_interno_conta_p bigint, cd_autorizacao_p text, nm_usuario_p text, dt_baixa_p timestamp, vl_saldo_p INOUT bigint, nr_sequencia_p INOUT bigint, ie_novo_p INOUT text) FROM PUBLIC;

