-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_baca_ajuste_log_pos_contab () AS $body$
DECLARE

 
tb_nr_seq_conta_pos_w		pls_util_cta_pck.t_number_table;
tb_dt_mes_competencia_w		pls_util_cta_pck.t_date_table;
tb_nm_usuario_w			pls_util_cta_pck.t_varchar2_table_20;
tb_nr_seq_conta_w		pls_util_cta_pck.t_number_table;
tb_ie_status_faturamento_w	pls_util_cta_pck.t_varchar2_table_5;
tb_ie_status_faturamento_new_w	pls_util_cta_pck.t_varchar2_table_5;

c01 CURSOR FOR 
	SELECT	pe.nr_sequencia tb_nr_seq_conta_pos_w, 
		min(pc.dt_mes_competencia) tb_dt_mes_competencia_w, 
		pe.nm_usuario_nrec tb_nm_usuario_w, 
		pe.nr_seq_conta tb_nr_seq_conta_w, 
		pe.ie_status_faturamento tb_ie_status_faturamento_w, 
		max((SELECT	a.ie_status_faturamento_ant	 
		from	pls_log_pos_estabelecido	a 
		where	a.nr_sequencia	=	(select	min(b.nr_sequencia) 
						from	pls_log_pos_estabelecido	b 
						where	b.nr_seq_conta_pos	= pe.nr_sequencia))) tb_ie_status_faturamento_new_w 
	from	pls_conta_pos_estabelecido	pe, 
		pls_conta_pos_estab_contab	pc 
	where	pe.nr_sequencia	= pc.nr_seq_conta_pos 
	and	pe.dt_atualizacao_nrec > to_date('01/01/2015') 
	and	not exists (	select	1 
				from	pls_log_pos_estabelecido	lp 
				where	lp.nr_seq_conta_pos = pe.nr_sequencia 
				and	coalesce(lp.ie_status_faturamento_ant::text, '') = '') 
	group by pe.nr_sequencia, pe.nm_usuario_nrec, pe.nr_seq_conta, pe.ie_status_faturamento;


BEGIN 
 
open c01;
loop 
	fetch c01 bulk collect into tb_nr_seq_conta_pos_w, tb_dt_mes_competencia_w, tb_nm_usuario_w, tb_nr_seq_conta_w, tb_ie_status_faturamento_w, tb_ie_status_faturamento_new_w 
	limit pls_util_pck.qt_registro_transacao_w;
	exit when tb_nr_seq_conta_pos_w.count = 0;
	 
	forall i in tb_nr_seq_conta_pos_w.first..tb_nr_seq_conta_pos_w.last 
		insert into pls_log_pos_estabelecido(nr_sequencia, dt_atualizacao,	nm_usuario, 
			dt_atualizacao_nrec, nm_usuario_nrec, ie_status_faturamento_ant, 
			ie_status_faturamento_new, nr_seq_conta, nr_seq_conta_pos, 
			ie_tipo_registro, ds_log) 
		values (nextval('pls_log_pos_estabelecido_seq'),clock_timestamp(), tb_nm_usuario_w(i), 
			tb_dt_mes_competencia_w(i), tb_nm_usuario_w(i), null, 
			coalesce(tb_ie_status_faturamento_new_w(i),tb_ie_status_faturamento_w(i)), tb_nr_seq_conta_w(i), tb_nr_seq_conta_pos_w(i), 
			'H','Gerado por ajuste de base.');
	commit;
end loop;
close c01;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_baca_ajuste_log_pos_contab () FROM PUBLIC;

