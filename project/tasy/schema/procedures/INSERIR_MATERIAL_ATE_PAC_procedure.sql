-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE inserir_material_ate_pac ( nr_seq_proc_princ_p bigint, cd_material_prescricao_p bigint, cd_material_p bigint, cd_material_exec_p bigint, ie_via_aplicacao_p text, dt_prescricao_p timestamp, qt_material_p bigint, nr_doc_interno_p bigint, dt_atendimento_p timestamp, cd_unidade_medida_p text, nr_prescricao_p bigint, nr_sequencia_prescricao_p bigint, cd_convenio_p bigint, cd_categoria_p text, cd_cgc_fornecedor_p text, cd_setor_atendimento_p bigint, nr_seq_atepacu_p bigint, dt_entrada_unidade_p timestamp, cd_local_estoque_p bigint, qt_executada_p bigint, nr_serie_material_p text, nr_seq_cor_exec_p bigint, nr_cirurgia_p bigint, dt_conta_p timestamp, nm_usuario_atend_far_p text, nm_usuario_atend_enf_p text, nr_sequencia_p bigint, nr_atendimento_p bigint, nr_doc_convenio_p text, ie_tipo_guia_p text, cd_senha_p text, cd_acao_p text, vl_unitario_p bigint, qt_ajuste_conta_p bigint, ie_valor_informado_p text, ie_guia_informada_p text, ie_auditoria_p text, nm_usuario_original_p text, cd_motivo_exc_conta_p bigint, ds_compl_motivo_excon_p text, cd_proced_referencia_p bigint, ds_observacao_p text, nr_seq_tipo_baixa_p bigint, nr_seq_kit_estoque_p bigint, ds_justificativa_p text, nm_usuario_p text, nr_seq_lote_fornec_p bigint) AS $body$
DECLARE

			
ie_tipo_lancamento_mat_w	varchar(10);
ie_via_aplicacao_w			prescr_material.ie_via_aplicacao%type;
nr_seq_lote_fornec_W		bigint;

cd_cgc_fornecedor_w			varchar(14);
ie_tipo_saldo_w				varchar(1);
ie_consignado_w				varchar(1);


BEGIN

ie_tipo_lancamento_mat_w := obter_param_usuario(36, 157, obter_perfil_ativo, nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento, ie_tipo_lancamento_mat_w);

CALL wheb_usuario_pck.set_cd_funcao(36);

if (cd_acao_p IS NOT NULL AND cd_acao_p::text <> '') and (cd_material_p IS NOT NULL AND cd_material_p::text <> '') and (cd_setor_atendimento_p IS NOT NULL AND cd_setor_atendimento_p::text <> '') and (cd_unidade_medida_p IS NOT NULL AND cd_unidade_medida_p::text <> '') and (dt_atendimento_p IS NOT NULL AND dt_atendimento_p::text <> '') and (nr_atendimento_p IS NOT NULL AND nr_atendimento_p::text <> '') and (dt_entrada_unidade_p IS NOT NULL AND dt_entrada_unidade_p::text <> '') and (cd_unidade_medida_p IS NOT NULL AND cd_unidade_medida_p::text <> '') and (qt_material_p IS NOT NULL AND qt_material_p::text <> '') and (nm_usuario_p IS NOT NULL AND nm_usuario_p::text <> '') and (nr_seq_atepacu_p IS NOT NULL AND nr_seq_atepacu_p::text <> '') then
	begin

	select	max(ie_via_aplicacao)
	into STRICT	ie_via_aplicacao_w
	from 	prescr_material
	where 	nr_prescricao = nr_prescricao_p
	and 	nr_sequencia = nr_sequencia_prescricao_p;

	nr_seq_lote_fornec_w := nr_seq_lote_fornec_p;
	
	if (nr_seq_lote_fornec_w = 0) then
		nr_seq_lote_fornec_w := null;
	end if;

	select	max(a.ie_consignado)
	into STRICT	ie_consignado_w
	from	material a,
			material_estab b
	where	a.cd_material = cd_material_p
	and		b.cd_material = a.cd_material
	and 	b.cd_estabelecimento = wheb_usuario_pck.get_cd_estabelecimento;

	cd_cgc_fornecedor_w:= cd_cgc_fornecedor_p;

	if (ie_consignado_w = '2') and (coalesce(cd_cgc_fornecedor_w::text, '') = '') then
		SELECT * FROM obter_fornec_consig_ambos(wheb_usuario_pck.get_cd_estabelecimento, cd_material_p, nr_seq_lote_fornec_w, cd_local_estoque_p, ie_tipo_saldo_w, cd_cgc_fornecedor_w) INTO STRICT ie_tipo_saldo_w, cd_cgc_fornecedor_w;
	end if;

	insert into material_atend_paciente(nr_seq_proc_princ,
		cd_material_prescricao,
		cd_material,
		cd_material_exec,
		ie_via_aplicacao,
		dt_prescricao,	
		qt_material,	
		nr_doc_interno,	
		dt_atendimento,	
		cd_unidade_medida,	
		nr_prescricao,	
		nr_sequencia_prescricao,
		cd_convenio,	
		cd_categoria,	
		cd_cgc_fornecedor,	
		cd_setor_atendimento,
		nr_seq_atepacu,
		dt_entrada_unidade,
		cd_local_estoque,
		qt_executada,	
		nr_serie_material,	
		nr_seq_cor_exec,	
		nr_cirurgia,	
		dt_conta,	
		nm_usuario_atend_far,	
		nm_usuario_atend_enf,
		nr_sequencia,	
		nr_atendimento,	
		nr_doc_convenio,
		ie_tipo_guia,	
		cd_senha,	
		cd_acao,	
		vl_unitario,	
		qt_ajuste_conta,
		ie_valor_informado,
		ie_guia_informada,
		ie_auditoria,
		nm_usuario_original,	
		cd_motivo_exc_conta,
		ds_compl_motivo_excon,
		cd_proced_referencia,
		ds_observacao,	
		nr_seq_tipo_baixa,
		nm_usuario,
		nr_seq_kit_estoque,
		ds_justificativa,
		dt_atualizacao,
		nr_seq_lote_fornec)
	values (nr_seq_proc_princ_p,	
		 cd_material_prescricao_p,
		 cd_material_p,		
		 cd_material_exec_p,	
		 coalesce(ie_via_aplicacao_p, ie_via_aplicacao_w),
		 dt_prescricao_p,		
		 qt_material_p,		
		 nr_doc_interno_p,	
		 dt_atendimento_p,	
		 cd_unidade_medida_p,	
		 nr_prescricao_p,		
		 nr_sequencia_prescricao_p,
		 cd_convenio_p,		
		 cd_categoria_p,		
		 cd_cgc_fornecedor_w,	
		 cd_setor_atendimento_p,	
		 nr_seq_atepacu_p,	
		 dt_entrada_unidade_p,	
		 cd_local_estoque_p,	
		 qt_executada_p,		
		 nr_serie_material_p,	
		 nr_seq_cor_exec_p,	
		 nr_cirurgia_p,		
		 dt_conta_p,		
		 nm_usuario_atend_far_p,	
		 nm_usuario_atend_enf_p,	
		 nr_sequencia_p,		
		 nr_atendimento_p,	
		 nr_doc_convenio_p,	
		 ie_tipo_guia_p,		
		 cd_senha_p,		
		 cd_acao_p,		
		 vl_unitario_p,		
		 qt_ajuste_conta_p,	
		 ie_valor_informado_p,	
		 ie_guia_informada_p,	
		 ie_auditoria_p,		
		 nm_usuario_original_p,	
		 cd_motivo_exc_conta_p,	
		 ds_compl_motivo_excon_p,	
		 cd_proced_referencia_p,	
		 ds_observacao_p,		
		 nr_seq_tipo_baixa_p,	
		 nm_usuario_p,
		nr_seq_kit_estoque_p,
		ds_justificativa_p,
		clock_timestamp(),
		nr_seq_lote_fornec_w);
	end;
end if;

CALL atualiza_preco_material(nr_sequencia_p, nm_usuario_p);

if (ie_tipo_lancamento_mat_w = '0') then
	CALL gerar_lanc_automatico_mat(nr_atendimento_p,	cd_local_estoque_p,	132, nm_usuario_p, nr_sequencia_p, null, null);
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE inserir_material_ate_pac ( nr_seq_proc_princ_p bigint, cd_material_prescricao_p bigint, cd_material_p bigint, cd_material_exec_p bigint, ie_via_aplicacao_p text, dt_prescricao_p timestamp, qt_material_p bigint, nr_doc_interno_p bigint, dt_atendimento_p timestamp, cd_unidade_medida_p text, nr_prescricao_p bigint, nr_sequencia_prescricao_p bigint, cd_convenio_p bigint, cd_categoria_p text, cd_cgc_fornecedor_p text, cd_setor_atendimento_p bigint, nr_seq_atepacu_p bigint, dt_entrada_unidade_p timestamp, cd_local_estoque_p bigint, qt_executada_p bigint, nr_serie_material_p text, nr_seq_cor_exec_p bigint, nr_cirurgia_p bigint, dt_conta_p timestamp, nm_usuario_atend_far_p text, nm_usuario_atend_enf_p text, nr_sequencia_p bigint, nr_atendimento_p bigint, nr_doc_convenio_p text, ie_tipo_guia_p text, cd_senha_p text, cd_acao_p text, vl_unitario_p bigint, qt_ajuste_conta_p bigint, ie_valor_informado_p text, ie_guia_informada_p text, ie_auditoria_p text, nm_usuario_original_p text, cd_motivo_exc_conta_p bigint, ds_compl_motivo_excon_p text, cd_proced_referencia_p bigint, ds_observacao_p text, nr_seq_tipo_baixa_p bigint, nr_seq_kit_estoque_p bigint, ds_justificativa_p text, nm_usuario_p text, nr_seq_lote_fornec_p bigint) FROM PUBLIC;

