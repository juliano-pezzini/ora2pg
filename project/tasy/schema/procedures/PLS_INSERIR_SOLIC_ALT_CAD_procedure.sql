-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_inserir_solic_alt_cad ( nr_seq_segurado_p bigint, ie_tipo_solicitacao_p text, ie_origem_solicitacao_p text, nr_seq_alteracao_p text, nr_seq_alteracao_aux_p text, dt_alteracao_p timestamp, ds_observacao_p text, nm_usuario_p text, ie_commit_p text, nr_seq_solicitacao_p INOUT text) AS $body$
DECLARE


/* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Finalidade:
-------------------------------------------------------------------------------------------------------------------

Locais de chamada direta: 
[X]  Objetos do dicionario [ ] Tasy (Delphi/Java) [  X] Portal [  ]  Relatorios [ ] Outros:
 ------------------------------------------------------------------------------------------------------------------

Pontos de atencao:
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */
		
nr_seq_pagador_w		pls_segurado.nr_seq_pagador%type		:= null;
nr_seq_plano_w			pls_plano.nr_sequencia%type			:= null;
nr_seq_tabela_w			pls_tabela_preco.nr_sequencia%type		:= null;
nr_seq_vinculo_est_w		pls_segurado.nr_seq_vinculo_est%type		:= null;
cd_matricula_estipulante_w 	pls_segurado.cd_matricula_estipulante%type	:= null;
nr_seq_solicitacao_w		pls_segurado_solic_alt.nr_sequencia%type	:= null;
nr_seq_localizacao_benef_w	pls_segurado_solic_alt.nr_seq_localizacao_benef%type := null;
nr_seq_subestipulante_w		pls_segurado_solic_alt.nr_seq_subestipulante%type := null;
ie_opcao_invalida_w		varchar(1)					:= 'N';
ie_tipo_solicitacao_w		pls_segurado_solic_alt.ie_tipo_solicitacao%type;


BEGIN

if (nr_seq_solicitacao_p IS NOT NULL AND nr_seq_solicitacao_p::text <> '') then
	select	ie_tipo_solicitacao
	into STRICT	ie_tipo_solicitacao_w
	from	pls_segurado_solic_alt
	where	nr_sequencia = nr_seq_solicitacao_p;
else
	ie_tipo_solicitacao_w	:= ie_tipo_solicitacao_p;
end if;

if (ie_tipo_solicitacao_w = '1') then
	begin
		nr_seq_pagador_w 	:= (nr_seq_alteracao_p)::numeric;
	exception
	when others then
		CALL wheb_mensagem_pck.exibir_mensagem_abort(453777,';NM_CAMPO_P=' || 'Pagador' || ';DS_VALOR_P=' || nr_seq_alteracao_p);
	end;	
elsif (ie_tipo_solicitacao_w = '2') then
	begin
		nr_seq_plano_w		:= (nr_seq_alteracao_p)::numeric;
		nr_seq_tabela_w		:= (nr_seq_alteracao_aux_p)::numeric;
	exception
	when others then
		CALL wheb_mensagem_pck.exibir_mensagem_abort(453777,';NM_CAMPO_P=' || 'Produto' || ';DS_VALOR_P=' || nr_seq_alteracao_p);
	end;	
elsif (ie_tipo_solicitacao_w = '3') then
	begin
		nr_seq_vinculo_est_w	:= (nr_seq_alteracao_p)::numeric;
	exception
	when others then
		CALL wheb_mensagem_pck.exibir_mensagem_abort(453777,';NM_CAMPO_P=' || wheb_mensagem_pck.get_texto(1137273) || ';DS_VALOR_P=' || nr_seq_alteracao_p);
	end;
elsif (ie_tipo_solicitacao_w = '4') then
	begin
		cd_matricula_estipulante_w := nr_seq_alteracao_p;
	exception
	when others then
		CALL wheb_mensagem_pck.exibir_mensagem_abort(453777,';NM_CAMPO_P=' || wheb_mensagem_pck.get_texto(1137275) || ';DS_VALOR_P=' || nr_seq_alteracao_p);
	end;
elsif (ie_tipo_solicitacao_w = '6') then
	begin
		nr_seq_localizacao_benef_w := (nr_seq_alteracao_p)::numeric;
	exception
	when others then
		CALL wheb_mensagem_pck.exibir_mensagem_abort(453777,';NM_CAMPO_P=' || wheb_mensagem_pck.get_texto(1137194) || ';DS_VALOR_P=' || nr_seq_alteracao_p);
	end;
elsif (ie_tipo_solicitacao_w = '7') then
	begin
		nr_seq_subestipulante_w := (nr_seq_alteracao_p)::numeric;
	exception
	when data_exception then
		CALL wheb_mensagem_pck.exibir_mensagem_abort(453777,';NM_CAMPO_P=' || wheb_mensagem_pck.get_texto(1197204) || ';DS_VALOR_P=' || nr_seq_alteracao_p);
	end;
else
	ie_opcao_invalida_w	:=  'S';
end if;

if (ie_opcao_invalida_w = 'N') then
	if (nr_seq_solicitacao_p IS NOT NULL AND nr_seq_solicitacao_p::text <> '') then
		update	pls_segurado_solic_alt
		set	nr_seq_alt_pagador = CASE WHEN ie_tipo_solicitacao='1' THEN  nr_seq_pagador_w  ELSE nr_seq_alt_pagador END ,
			nr_seq_alt_plano = CASE WHEN ie_tipo_solicitacao='2' THEN  nr_seq_plano_w  ELSE nr_seq_alt_plano END ,
			nr_seq_alt_tabela = CASE WHEN ie_tipo_solicitacao='2' THEN  nr_seq_tabela_w  ELSE nr_seq_alt_tabela END ,
			nr_seq_vinculo_est = CASE WHEN ie_tipo_solicitacao='3' THEN  nr_seq_vinculo_est_w  ELSE nr_seq_vinculo_est END ,
			cd_matricula_estipulante = CASE WHEN ie_tipo_solicitacao='4' THEN  cd_matricula_estipulante_w  ELSE nr_seq_vinculo_est END ,		
			nr_seq_localizacao_benef = CASE WHEN ie_tipo_solicitacao='6' THEN  nr_seq_localizacao_benef_w  ELSE nr_seq_localizacao_benef END ,
			nr_seq_subestipulante = CASE WHEN ie_tipo_solicitacao='7' THEN  nr_seq_subestipulante_w  ELSE nr_seq_subestipulante END ,
			nm_usuario = nm_usuario_p,
			dt_alteracao = CASE WHEN dt_alteracao_p = NULL THEN  dt_alteracao  ELSE dt_alteracao_p END ,
			ds_observacao = CASE WHEN ds_observacao_p = NULL THEN  ds_observacao  ELSE ds_observacao_p END ,
			dt_atualizacao = clock_timestamp()
		where	nr_sequencia = nr_seq_solicitacao_p;
	else
		select	nextval('pls_segurado_solic_alt_seq')
		into STRICT	nr_seq_solicitacao_w
		;

		insert 	into 	pls_segurado_solic_alt(	nr_sequencia, nr_seq_segurado, ie_tipo_solicitacao, dt_solicitacao, dt_atualizacao,
				dt_alteracao, ie_origem_solicitacao, ds_observacao, nr_seq_alt_pagador, nm_usuario,
				nr_seq_alt_plano, nr_seq_alt_tabela, nr_seq_vinculo_est,cd_matricula_estipulante,
				dt_atualizacao_nrec, nm_usuario_nrec, nr_seq_localizacao_benef, nr_seq_subestipulante)
		values (	nr_seq_solicitacao_w, nr_seq_segurado_p, ie_tipo_solicitacao_w, clock_timestamp(), clock_timestamp(),
				dt_alteracao_p, ie_origem_solicitacao_p, coalesce(ds_observacao_p, '  '), nr_seq_pagador_w, nm_usuario_p,
				nr_seq_plano_w, nr_seq_tabela_w, nr_seq_vinculo_est_w,cd_matricula_estipulante_w,
				clock_timestamp(), nm_usuario_p, nr_seq_localizacao_benef_w, nr_seq_subestipulante_w);
	end if;

	if (coalesce(ie_commit_p,'N') = 'S') then
		commit;
	end if;
end if;

nr_seq_solicitacao_p := nr_seq_solicitacao_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_inserir_solic_alt_cad ( nr_seq_segurado_p bigint, ie_tipo_solicitacao_p text, ie_origem_solicitacao_p text, nr_seq_alteracao_p text, nr_seq_alteracao_aux_p text, dt_alteracao_p timestamp, ds_observacao_p text, nm_usuario_p text, ie_commit_p text, nr_seq_solicitacao_p INOUT text) FROM PUBLIC;

