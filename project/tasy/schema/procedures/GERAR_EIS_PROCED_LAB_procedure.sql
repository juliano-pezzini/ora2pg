-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_eis_proced_lab (dt_parametro_P timestamp, NM_USUARIO_P text) AS $body$
DECLARE

 
 
dt_atualizacao_w        timestamp     		:= clock_timestamp();
dt_parametro_fim_w       timestamp;
dt_parametro_w         timestamp;
dt_parametro_mes_w       timestamp;
dt_parametro_mes_fim_w		timestamp;
ds_retorno_w			varchar(255);

CD_ESTABELECIMENTO_W		smallint;
CD_SETOR_ATENDIMENTO_W    	integer;
DT_HORA_EXECUCAO_W		smallint;
CD_PROCEDIMENTO_W       	bigint;
CD_TECNICO_W		    varchar(10);
CD_MEDICO_EXECUTOR_W     	varchar(10);
cd_medico_prescr_w		varchar(10);
CD_MEDICO_SOLICITANTE_W     varchar(10);
CD_CONTA_CONTABIL_W      	varchar(20);
IE_ORIGEM_PROCED_W      	bigint;
CD_EQUIPAMENTO_W        	bigint;
IE_TIPO_ATENDIMENTO_W		smallint;
ie_clinica_w			integer;
cd_tipo_procedimento_w		smallint;
cd_setor_prescr_w		integer;
nr_seq_grupo_w			bigint;
cd_convenio_w			integer;

QT_PROCEDIMENTO_W       	double precision;
VL_MEDICO_W          	double precision;
VL_MATERIAIS_W        	double precision;
VL_CUSTO_OPERACIONAL_W    	double precision;
VL_AUXILIARES_W		    	double precision;
VL_ANESTESISTA_W	    	double precision;
VL_CUSTO_W			double precision;
vl_custo_exame_laborat_w	double precision;
QT_DIAS_PRAZO_W			double precision := 1;
nr_seq_exame_w			bigint;
nr_seq_exame_ant_w		bigint;
vl_procedimento_w		double precision;
nr_atendimento_w		bigint;
nr_atendimentos_ant_w		bigint;
qt_atendimento_w		integer;
cd_setor_entrega_w		integer;
nr_seq_forma_laudo_w		bigint;
qt_itens_conv_w			bigint;
cd_setor_proc_w			integer;
cd_medico_resp_w		varchar(10);
cd_motivo_exc_conta_w		smallint;
ds_motivo_exc_conta_w		varchar(100);
ie_considera_excluidos_w 	varchar(1);
dt_prescricao_w			timestamp;
dt_aprovacao_w			timestamp;
cd_pessoa_coleta_w		varchar(255);
cd_pessoa_fisica_w		varchar(255);
dt_imp_internet_w		timestamp;
ie_status_atend_w		smallint;
cd_procedencia_w		integer;
qt_atend_exame_w		bigint;
nr_seq_prescr_w			integer;
nr_prescricao_w			bigint;
nr_sequencia_w			bigint;
nr_seq_indicacao_w		bigint;
cd_categoria_w			varchar(10);
cd_cgc_prestador_w		varchar(14);
nm_usuario_atend_w		varchar(15);
nr_seq_recoleta_w		bigint;

C01 CURSOR FOR 
	SELECT	/*+ INDEX(A PROPACI_I4) */ 
 		coalesce(q.cd_estabelecimento, b.cd_estabelecimento), 
		p.IE_ORIGEM_PROCED,		 
 		p.CD_PROCEDIMENTO, 
 		coalesce(a.CD_SETOR_ATENDIMENTO,0), 
		coalesce(m.cd_setor_atendimento,0), 
		TO_CHAR(a.DT_PROCEDIMENTO, 'HH24'), 
		B.IE_TIPO_ATENDIMENTO, 
		m.cd_medico cd_medico_prescr, 
		b.ie_clinica, 
 		SUM(a.QT_PROCEDIMENTO), 
		d.nr_seq_grupo, 
		d.nr_seq_exame, 
		a.cd_convenio, 
		coalesce(a.cd_categoria,q.CD_CATEGORIA_PARAMETRO), 
		SUM(vl_procedimento), 
		b.nr_atendimento, 
		m.cd_setor_entrega, 
		m.nr_seq_forma_laudo, 
		coalesce(a.CD_SETOR_ATENDIMENTO,0), 
		obter_bioq_aprov_exam_lab(m.nr_prescricao, p.nr_sequencia), 
		a.cd_motivo_exc_conta, 
		SUBSTR(obter_motivo_exc_conta(a.cd_motivo_exc_conta),1,100), 
		coalesce(obter_vl_exame_laborat(d.nr_seq_exame),0), 
		m.dt_prescricao, 
		obter_data_aprov_lab(m.nr_prescricao,p.nr_sequencia), 
		Obter_Pf_Usuario(Obter_Lab_Exec_Etapa_coleta(p.nr_prescricao, p.nr_sequencia, p.ie_status_atend, '20', 'U'),'C'), 
		b.cd_pessoa_fisica, --Obter_Pf_Usuario(obter_lab_execucao_etapa(p.nr_prescricao, p.nr_sequencia, '10', 'U'),'C'),		 
		max((SELECT TRUNC(max(r.dt_impressao),'dd') 
			from lab_prescr_proc_impressao r 
			where r.nr_prescricao = p.nr_prescricao 
			and r.nr_seq_prescr = p.nr_sequencia)) dt_impressao, 
		p.ie_status_atend, 
		b.cd_procedencia, 
		p.nr_sequencia nr_seq_prescr, 
		p.nr_prescricao, 
		b.nr_seq_indicacao, 
		a.cd_cgc_prestador, 
		b.nm_usuario_atend, 
		p.nr_seq_recoleta 
   FROM prescr_procedimento p, prescr_medica m, exame_laboratorio d, convenio c, atendimento_paciente b, procedimento_paciente a
LEFT OUTER JOIN conta_paciente q ON (a.nr_interno_conta = q.nr_interno_conta)
WHERE a.dt_procedimento between 	dt_parametro_w and dt_parametro_fim_w  AND a.nr_atendimento		= b.nr_atendimento AND p.nr_prescricao			= m.nr_prescricao AND a.nr_sequencia 			<> coalesce(nr_seq_proc_pacote,0) AND ((coalesce(a.cd_motivo_exc_conta::text, '') = '') OR (ie_considera_excluidos_w = 'S')) AND a.nr_seq_exame			= d.nr_seq_exame AND a.nr_prescricao			= p.nr_prescricao AND a.nr_sequencia_prescricao	= p.nr_sequencia AND a.cd_convenio     		= c.cd_convenio GROUP BY 
 		coalesce(q.cd_estabelecimento, b.cd_estabelecimento), 
		p.IE_ORIGEM_PROCED, 
 		p.CD_PROCEDIMENTO, 
 		p.CD_SETOR_ATENDIMENTO, 
		m.cd_setor_atendimento, 
		a.nr_sequencia, 
		TO_CHAR(a.DT_PROCEDIMENTO, 'HH24'), 
		B.IE_TIPO_ATENDIMENTO, 
		b.ie_clinica, 
		d.nr_seq_grupo, 
		m.cd_medico, 
		d.nr_seq_exame, 
		a.cd_convenio, 
		b.nr_atendimento, 
		m.cd_setor_entrega, 
		m.nr_seq_forma_laudo, 
		a.CD_SETOR_ATENDIMENTO, 
		obter_bioq_aprov_exam_lab(m.nr_prescricao, p.nr_sequencia), 
		a.cd_motivo_exc_conta, 
		SUBSTR(obter_motivo_exc_conta(a.cd_motivo_exc_conta),1,100), 
		coalesce(obter_vl_exame_laborat(d.nr_seq_exame),0), 
		coalesce(a.cd_categoria,q.CD_CATEGORIA_PARAMETRO), 
		m.dt_prescricao, 
		obter_data_aprov_lab(m.nr_prescricao,p.nr_sequencia), 
		Obter_Pf_Usuario(Obter_Lab_Exec_Etapa_coleta(p.nr_prescricao, p.nr_sequencia, p.ie_status_atend, '20', 'U'),'C'), 
		b.cd_pessoa_fisica, --Obter_Pf_Usuario(obter_lab_execucao_etapa(p.nr_prescricao, p.nr_sequencia, '10', 'U'),'C'), 
		p.ie_status_atend, 
		b.cd_procedencia, 
		p.nr_sequencia, 
		p.nr_prescricao, 
		b.nr_seq_indicacao, 
		a.cd_cgc_prestador, 
		b.nm_usuario_atend, 
		p.nr_seq_recoleta 
	ORDER BY b.nr_atendimento, d.nr_seq_exame;

 

BEGIN 
 
nr_sequencia_w := Gravar_Log_Indicador(402, wheb_mensagem_pck.get_texto(802114), clock_timestamp(), trunc(dt_parametro_p), nm_usuario_p, nr_sequencia_w);
 
dt_parametro_fim_w       :=  
    		(to_date((to_char(dt_parametro_p,'dd/mm/yyyy') || ' 23:59:59'), 
			'dd/mm/yyyy hh24:mi:ss'));
dt_parametro_w         := 
    		(to_date((to_char(dt_parametro_p,'dd/mm/yyyy') || ' 00:00:00'), 
			'dd/mm/yyyy hh24:mi:ss'));
dt_parametro_mes_w          	:= Trunc(dt_parametro_p,'month');
dt_parametro_mes_fim_w			:= fim_mes(dt_parametro_mes_w);
 
/*delete from eis_proced_laborat 
where dt_referencia 	< sysdate - 60 
 and ie_periodo 		= 'D';*/
 
 
delete from eis_proced_laborat 
where dt_referencia between dt_parametro_w and dt_parametro_fim_w;
commit;
 
nr_atendimentos_ant_w	:= 0;
nr_seq_exame_ant_w	:= 0;
 
select	coalesce(max(ie_considera_exc_eis),'N') 
into STRICT	ie_considera_excluidos_w 
from	lab_parametro;
 
 
OPEN C01;
LOOP 
	FETCH C01 into 	 
		CD_ESTABELECIMENTO_W, 
 		IE_ORIGEM_PROCED_W, 
		CD_PROCEDIMENTO_W, 
 		CD_SETOR_ATENDIMENTO_W, 
		cd_setor_prescr_w, 
		DT_HORA_EXECUCAO_W, 
		IE_TIPO_ATENDIMENTO_W, 
		cd_medico_prescr_w, 
		ie_clinica_w, 
 		QT_PROCEDIMENTO_W, 
		nr_seq_grupo_w, 
		nr_seq_exame_w, 
		cd_convenio_w, 
		cd_categoria_w, 
		vl_procedimento_w, 
		nr_atendimento_w, 
		cd_setor_entrega_w, 
		nr_seq_forma_laudo_w, 
		cd_setor_proc_w, 
		cd_medico_resp_w, 
		cd_motivo_exc_conta_w, 
		ds_motivo_exc_conta_w, 
		vl_custo_exame_laborat_w, 
		dt_prescricao_w, 
		dt_aprovacao_w, 
		cd_pessoa_coleta_w, 
		cd_pessoa_fisica_w, 
		dt_imp_internet_w, 
		ie_status_atend_w, 
		cd_procedencia_w, 
		nr_seq_prescr_w, 
		nr_prescricao_w, 
		nr_seq_indicacao_w, 
		cd_cgc_prestador_w, 
		nm_usuario_atend_w, 
		nr_seq_recoleta_w;
   EXIT WHEN NOT FOUND; /* apply on C01 */
		begin 
 
		select 	count(*) 
		into STRICT	qt_itens_conv_w 
		from 	convenio_estabelecimento w 
		where 	w.cd_convenio          = cd_convenio_w;
 
		if (qt_itens_conv_w > 0) then 
 
			select	cd_tipo_procedimento 
			into STRICT	cd_tipo_procedimento_w 
			from	procedimento 
			where	cd_procedimento		= cd_procedimento_w 
			and	ie_origem_proced	= ie_origem_proced_w;
	 
			qt_atendimento_w	:= 0;
			qt_atend_exame_w	:= 0;
			 
			if (nr_atendimento_w <> nr_atendimentos_ant_w) then 
				qt_atendimento_w := 1;		
			end if;
			 
			if (nr_atendimento_w <> nr_atendimentos_ant_w) or (nr_atendimento_w = nr_atendimentos_ant_w and nr_seq_exame_w <> nr_seq_exame_ant_w) then 
				qt_atend_exame_w := 1;	
			end if;
		 
			nr_atendimentos_ant_w := nr_atendimento_w;
			nr_seq_exame_ant_w := nr_seq_exame_w;
			 
	 		insert into EIS_Proced_laborat( 
				DT_REFERENCIA, 
 				CD_ESTABELECIMENTO,        
 				CD_SETOR_ATENDIMENTO,        
	 			IE_ORIGEM_PROCED,        
 				CD_PROCEDIMENTO,        
				IE_PERIODO, 
				NM_USUARIO, 
				DT_ATUALIZACAO, 
 				DT_HORA_EXAME,        
 				IE_TIPO_ATENDIMENTO,        
 				QT_PROCEDIMENTO, 
	 			CD_MEDICO_prescr,        
				ie_clinica, 
				cd_tipo_procedimento, 
				cd_setor_prescr, 
				nr_seq_grupo, 
				nr_seq_exame, 
				cd_convenio, 
				vl_procedimento, 
				qt_atendimento, 
				cd_setor_entrega, 
				nr_seq_forma_laudo, 
				cd_setor_proc, 
				cd_medico_resp, 
				cd_motivo_exc, 
				ds_motivo_exc, 
				vl_custo_exame, 
				dt_prescricao, 
				dt_aprovacao, 
				cd_pessoa_fisica, 
				cd_pessoa_coleta, 
				dt_impressao_internet, 
				ie_status_atend, 
				cd_procedencia, 
				qt_atend_exam, 
				nr_atendimento, 
				nr_seq_prescr, 
				nr_prescricao, 
				nr_seq_indicacao, 
				cd_categoria, 
				cd_cgc_prestador, 
				nm_usuario_atend, 
				nr_seq_recoleta) 
	    	Values ( 
				dt_Parametro_w  	,  
        	 	cd_estabelecimento_w  , 
         		cd_setor_atendimento_w , 
	         	ie_origem_proced_w	, 
				cd_procedimento_w		, 
				'D', 
				nm_usuario_p		, 
				dt_atualizacao_w, 
				DT_HORA_EXECUCAO_W	, 
				ie_tipo_atendimento_w	, 
				qt_procedimento_w		, 
				cd_medico_prescr_w, 
				ie_clinica_w, 
				cd_tipo_procedimento_w, 
				cd_setor_prescr_w, 
				nr_seq_grupo_w, 
				nr_seq_exame_w, 
				cd_convenio_w, 
				vl_procedimento_w, 
				qt_atendimento_w, 
				cd_setor_entrega_w, 
				nr_seq_forma_laudo_w, 
				cd_setor_proc_w, 
				cd_medico_resp_w, 
				cd_motivo_exc_conta_w, 
				ds_motivo_exc_conta_w, 
				vl_custo_exame_laborat_w, 
				dt_prescricao_w, 
				dt_aprovacao_w, 
				cd_pessoa_fisica_w, 
				cd_pessoa_coleta_w, 
				dt_imp_internet_w, 
				ie_status_atend_w, 
				cd_procedencia_w, 
				qt_atend_exame_w, 
				nr_atendimento_w, 
				nr_seq_prescr_w, 
				nr_prescricao_w, 
				nr_seq_indicacao_w, 
				cd_categoria_w, 
				cd_cgc_prestador_w, 
				nm_usuario_atend_w, 
				nr_seq_recoleta_w);
		end if;
    	end;
END LOOP;
CLOSE C01;
COMMIT;
 
begin 
 
/*delete from eis_proced_laborat 
where dt_referencia = dt_parametro_mes_w 
and ie_periodo = 'M'; 
 
insert into EIS_Proced_laborat ( 
		DT_REFERENCIA		, 
 		CD_ESTABELECIMENTO   ,        
 		CD_SETOR_ATENDIMENTO  ,        
 		IE_ORIGEM_PROCED    ,        
 		CD_PROCEDIMENTO     ,        
		IE_PERIODO			, 
		NM_USUARIO			, 
		DT_ATUALIZACAO, 
 		DT_HORA_EXAME      ,        
 		IE_TIPO_ATENDIMENTO   ,        
 		QT_PROCEDIMENTO		, 
 		CD_MEDICO_prescr,        
		ie_clinica, 
		cd_tipo_procedimento, 
		cd_setor_prescr, 
		nr_seq_grupo, 
		nr_seq_exame, 
		cd_convenio, 
		vl_procedimento, 
		qt_atendimento, 
		cd_setor_entrega, 
		nr_seq_forma_laudo, 
		cd_setor_proc, 
		cd_medico_resp, 
		cd_motivo_exc, 
		ds_motivo_exc, 
		vl_custo_exame, 
		dt_prescricao, 
		dt_aprovacao, 
		cd_pessoa_fisica, 
		cd_pessoa_coleta, 
		dt_impressao_internet, 
		ie_status_atend, 
		cd_procedencia, 
		qt_atend_exam, 
		nr_atendimento, 
		nr_seq_prescr, 
		nr_prescricao, 
		nr_seq_indicacao, 
		cd_categoria, 
		cd_cgc_prestador, 
		nm_usuario_atend, 
		nr_seq_recoleta) 
(SELECT 
		DT_PARAMETRO_MES_W	, 
 		CD_ESTABELECIMENTO   ,        
 		CD_SETOR_ATENDIMENTO  ,        
 		IE_ORIGEM_PROCED    ,        
 		CD_PROCEDIMENTO     ,        
		'M', 
		NM_USUARIO_P		, 
		DT_ATUALIZACAO_W, 
 		DT_HORA_EXAME      ,        
 		IE_TIPO_ATENDIMENTO   ,        
	 	SUM(QT_PROCEDIMENTO)	, 
 		CD_MEDICO_prescr,        
		ie_clinica, 
		cd_tipo_procedimento, 
		cd_setor_prescr, 
		nr_seq_grupo, 
		nr_seq_exame, 
		cd_convenio, 
		sum(vl_procedimento), 
		sum(nvl(qt_atendimento,0)), 
		cd_setor_entrega, 
		nr_seq_forma_laudo, 
		cd_setor_proc, 
		cd_medico_resp, 
		cd_motivo_exc, 
		ds_motivo_exc, 
		vl_custo_exame, 
		dt_prescricao, 
		dt_aprovacao, 
		cd_pessoa_fisica, 
		cd_pessoa_coleta, 
		dt_impressao_internet, 
		ie_status_atend, 
		cd_procedencia, 
		sum(nvl(qt_atend_exam,0)), 
		nr_atendimento, 
		nr_seq_prescr, 
		nr_prescricao, 
		nr_seq_indicacao, 
		cd_categoria, 
		cd_cgc_prestador, 
		nm_usuario_atend, 
		nr_seq_recoleta 
FROM 	EIS_PROCED_laborat 
WHERE 	DT_REFERENCIA BETWEEN DT_PARAMETRO_MES_W AND DT_PARAMETRO_MES_FIM_W 
AND 	IE_PERIODO = 'D' 
GROUP BY 
	DT_PARAMETRO_MES_W	, 
	CD_ESTABELECIMENTO   ,        
	CD_SETOR_ATENDIMENTO  ,        
	IE_ORIGEM_PROCED    ,        
	CD_PROCEDIMENTO     ,        
	'M', 
	NM_USUARIO_P		, 
	DT_ATUALIZACAO_W, 
 	DT_HORA_EXAME      ,        
 	IE_TIPO_ATENDIMENTO   ,        
	CD_MEDICO_prescr,        
	ie_clinica, 
	cd_tipo_procedimento, 
	nr_seq_grupo, 
	cd_setor_prescr, 
	nr_seq_exame, 
	cd_convenio, 
	cd_setor_entrega, 
	cd_setor_proc, 
	nr_seq_forma_laudo, 
	cd_medico_resp, 
	cd_motivo_exc, 
	ds_motivo_exc, 
	vl_custo_exame, 
	dt_prescricao, 
	dt_aprovacao, 
	cd_pessoa_fisica, 
	cd_pessoa_coleta, 
	dt_impressao_internet, 
	ie_status_atend, 
	cd_procedencia, 
	nr_atendimento, 
	nr_seq_prescr, 
	nr_prescricao, 
	nr_seq_indicacao, 
	cd_categoria, 
	cd_cgc_prestador, 
	nm_usuario_atend, 
	nr_seq_recoleta);*/
 
	 
	 
delete	FROM EIS_Proced_laborat 
where	ie_periodo = 'M' 
and		DT_REFERENCIA between dt_parametro_w and dt_parametro_fim_w;	
	 
insert into EIS_Proced_laborat( 
				DT_REFERENCIA, 
 				CD_ESTABELECIMENTO,        
 				CD_SETOR_ATENDIMENTO,        
	 			IE_ORIGEM_PROCED,        
 				CD_PROCEDIMENTO,        
				IE_PERIODO, 
				NM_USUARIO, 
				DT_ATUALIZACAO, 
 				DT_HORA_EXAME,        
 				IE_TIPO_ATENDIMENTO,        
 				QT_PROCEDIMENTO, 
	 			CD_MEDICO_prescr,        
				ie_clinica, 
				cd_tipo_procedimento, 
				cd_setor_prescr, 
				nr_seq_grupo, 
				nr_seq_exame, 
				cd_convenio, 
				vl_procedimento, 
				qt_atendimento, 
				cd_setor_entrega, 
				nr_seq_forma_laudo, 
				cd_setor_proc, 
				cd_medico_resp, 
				cd_motivo_exc, 
				ds_motivo_exc, 
				vl_custo_exame, 
				dt_prescricao, 
				dt_aprovacao, 
				cd_pessoa_fisica, 
				cd_pessoa_coleta, 
				dt_impressao_internet, 
				ie_status_atend, 
				cd_procedencia, 
				qt_atend_exam, 
				nr_atendimento, 
				nr_seq_prescr, 
				nr_prescricao, 
				nr_seq_indicacao, 
				cd_categoria, 
				cd_cgc_prestador, 
				nm_usuario_atend, 
				nr_seq_recoleta) 
		SELECT	DT_REFERENCIA, 
 				CD_ESTABELECIMENTO,        
 				CD_SETOR_ATENDIMENTO,        
	 			IE_ORIGEM_PROCED,        
 				CD_PROCEDIMENTO,        
				'M', 
				NM_USUARIO, 
				DT_ATUALIZACAO, 
 				DT_HORA_EXAME,        
 				IE_TIPO_ATENDIMENTO,        
 				QT_PROCEDIMENTO, 
	 			CD_MEDICO_prescr,        
				ie_clinica, 
				cd_tipo_procedimento, 
				cd_setor_prescr, 
				nr_seq_grupo, 
				nr_seq_exame, 
				cd_convenio, 
				vl_procedimento, 
				qt_atendimento, 
				cd_setor_entrega, 
				nr_seq_forma_laudo, 
				cd_setor_proc, 
				cd_medico_resp, 
				cd_motivo_exc, 
				ds_motivo_exc, 
				vl_custo_exame, 
				dt_prescricao, 
				dt_aprovacao, 
				cd_pessoa_fisica, 
				cd_pessoa_coleta, 
				dt_impressao_internet, 
				ie_status_atend, 
				cd_procedencia, 
				qt_atend_exam, 
				nr_atendimento, 
				nr_seq_prescr, 
				nr_prescricao, 
				nr_seq_indicacao, 
				cd_categoria, 
				cd_cgc_prestador, 
				nm_usuario_atend, 
				nr_seq_recoleta 
		from	EIS_Proced_laborat 
		where	ie_periodo = 'D' 
		and		DT_REFERENCIA between dt_parametro_w and dt_parametro_fim_w;
	 
	 
commit;
end;
 
CALL Atualizar_Log_Indicador(clock_timestamp(), nr_sequencia_w);
 
commit;
 
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_eis_proced_lab (dt_parametro_P timestamp, NM_USUARIO_P text) FROM PUBLIC;

