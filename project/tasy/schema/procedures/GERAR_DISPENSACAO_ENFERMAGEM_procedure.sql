-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_dispensacao_enfermagem ( nr_prescricao_p bigint, nr_sequencia_p bigint, nm_usuario_p text, nr_seq_motivo_p bigint, ie_gerou_p INOUT text) AS $body$
DECLARE

 
nr_prescricao_w			bigint;
nr_sequencia_w			integer;
nr_seq_horario_w		bigint;
cd_material_w			integer;
cd_intervalo_w			varchar(7);
ie_via_aplicacao_w		varchar(5);
qt_unitaria_w			double precision;
qt_dose_especial_w		double precision;
nr_ocorrencia_w			double precision;
ie_origem_inf_w			varchar(1);
qt_material_w			double precision;
ie_regra_disp_w			varchar(1);
qt_dispensar_w			double precision;
cd_unidade_medida_dose_w	varchar(30);
ds_erro_w			varchar(255);
qt_lote_w			bigint := 0;
nr_seq_alteracao_w		bigint;
dt_horario_w			timestamp;
nr_atendimento_w		bigint;
ie_se_necessario_w		varchar(1);
ie_acm_w			varchar(1);
nr_seq_prescricao_w		integer;
ie_acm_sn_w				varchar(1);
nr_seq_lote_w			ap_lote.nr_sequencia%type;
ie_agrupador_w			prescr_material.ie_agrupador%type;


BEGIN 
 
ie_gerou_p	:= 'N';
 
 
if (coalesce(nr_sequencia_p,0) > 0) and (coalesce(nr_prescricao_p,0) > 0) then 
 
	select	max(cd_material), 
		max(ie_via_aplicacao), 
		coalesce(max(qt_unitaria),0), 
		coalesce(max(qt_dose_especial),0), 
		coalesce(max(nr_ocorrencia),0), 
		max(ie_origem_inf), 
		max(cd_unidade_medida_dose), 
		coalesce(max(qt_material),0), 
		coalesce(max(ie_se_necessario),'N'), 
		coalesce(max(ie_acm),'N'), 
		max(ie_agrupador) 
	into STRICT	cd_material_w, 
		ie_via_aplicacao_w, 
		qt_unitaria_w, 
		qt_dose_especial_w, 
		nr_ocorrencia_w, 
		ie_origem_inf_w, 
		cd_unidade_medida_dose_w, 
		qt_material_w, 
		ie_se_necessario_w, 
		ie_acm_w, 
		ie_agrupador_w		 
	from	prescr_material 
	where	nr_sequencia	= nr_sequencia_p	 
	and	nr_prescricao	= nr_prescricao_p;
	 
	ie_acm_sn_w := obter_se_acm_sn(ie_acm_w, ie_se_necessario_w);
	 
	SELECT * FROM Obter_Quant_Dispensar(	1, cd_material_w, nr_prescricao_p, nr_sequencia_p, cd_intervalo_w, ie_via_aplicacao_w, qt_unitaria_w, qt_dose_especial_w, nr_ocorrencia_w, null, ie_origem_inf_w, cd_unidade_medida_dose_w, 1, qt_material_w, qt_dispensar_w, ie_regra_disp_w, ds_erro_w, ie_se_necessario_w, ie_acm_w) INTO STRICT qt_material_w, qt_dispensar_w, ie_regra_disp_w, ds_erro_w; 	
	 
	Update	prescr_material 
	set	qt_total_dispensar	= qt_dispensar_w, 
		dt_baixa		 = NULL, 
		cd_motivo_baixa		= 0, 
		ie_regra_disp		= 'S', 
		dt_atualizacao		= clock_timestamp(), 
		nm_usuario		= nm_usuario_p, 
		nr_motivo_disp		= nr_seq_motivo_p 
	where	nr_prescricao		= nr_prescricao_p 
	and	nr_sequencia		= nr_sequencia_p;	
	 
	update	prescr_mat_hor 
	set	qt_dispensar_hor	= dividir(qt_dispensar_w,nr_ocorrencia_w), 
		dt_atualizacao		= clock_timestamp(), 
		nm_usuario		= nm_usuario_p, 
		nr_motivo_disp		= nr_seq_motivo_p 
	where	nr_prescricao		= nr_prescricao_p 
	and	nr_seq_material		= nr_sequencia_p;
	 
	select	max(nr_sequencia), 
		max(dt_horario), 
		max(nr_seq_material) 
	into STRICT	nr_seq_horario_w, 
		dt_horario_w, 
		nr_seq_prescricao_w 
	from	prescr_mat_hor 
	where	nr_prescricao		= nr_prescricao_p 
	and	nr_seq_material		= nr_sequencia_p;
	 
	 
	 
	select	max(nr_atendimento) 
	into STRICT	nr_atendimento_w 
	from	prescr_medica 
	where	nr_prescricao = nr_prescricao_p;
	 
	/*inicio*/
 
	select	nextval('prescr_mat_alteracao_seq') 
	into STRICT	nr_seq_alteracao_w 
	;
	 
	insert	into	prescr_mat_alteracao(nr_sequencia, 
		dt_atualizacao, 
		nm_usuario, 
		dt_atualizacao_nrec, 
		nm_usuario_nrec, 
		nr_prescricao, 
		nr_seq_horario, 
		dt_alteracao, 
		cd_pessoa_fisica, 
		ie_alteracao, 
		ie_tipo_item, 
		dt_horario, 
		nr_atendimento, 
		cd_item, 
		nr_seq_motivo_disp, 
		nr_seq_prescricao, 
		ie_acm_sn 
		) 
	values ( 
		nr_seq_alteracao_w, 
		clock_timestamp(), 
		nm_usuario_p, 
		clock_timestamp(), 
		nm_usuario_p, 
		nr_prescricao_p, 
		nr_seq_horario_w, 
		clock_timestamp(), 
		obter_dados_usuario_opcao(nm_usuario_p,'C'), 
		45, 
		CASE WHEN ie_agrupador_w=1 THEN  'M'  ELSE 'MAT' END , --A principio sÃ³ gera pra estes dois itens 
		dt_horario_w, 
		nr_atendimento_w, 
		cd_material_w, 
		nr_seq_motivo_p, 
		nr_seq_prescricao_w, 
		ie_acm_sn_w);
	/*fim*/
 
	CALL Gerar_Lote_Atend_Prescricao(nr_prescricao_p, nr_sequencia_p, 0, 'N', nm_usuario_p, 'GPMH');
	 
	select	max(nr_seq_lote) 
	into STRICT	nr_seq_lote_w 
	from	prescr_mat_hor 
	where	nr_prescricao	= nr_prescricao_p 
	and	nr_seq_material	= nr_sequencia_p;
	 
	update	prescr_mat_alteracao 
	set	nr_seq_lote = nr_seq_lote_w 
	where	nr_sequencia = nr_seq_alteracao_w;	
	 
	select	count(a.nr_sequencia) 
	into STRICT	qt_lote_w 
	from	ap_lote_item a, 
		prescr_mat_hor b, 
		prescr_material c 
	where	c.nr_prescricao	= b.nr_prescricao 
	and	c.nr_sequencia	= b.nr_seq_material 
	and	b.nr_sequencia	= a.nr_seq_mat_hor 
	and	c.nr_prescricao	= nr_prescricao_p 
	and	c.nr_sequencia	= nr_sequencia_p;
	 
	if (qt_lote_w	> 0) then 
		ie_gerou_p	:= 'S';
	else 
		ie_gerou_p	:= 'N';
	end if;
 
	commit;
	 
end if;	
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_dispensacao_enfermagem ( nr_prescricao_p bigint, nr_sequencia_p bigint, nm_usuario_p text, nr_seq_motivo_p bigint, ie_gerou_p INOUT text) FROM PUBLIC;

