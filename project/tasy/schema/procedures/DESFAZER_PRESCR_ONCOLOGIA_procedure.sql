-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE desfazer_prescr_oncologia ( nr_prescricao_p bigint, nr_seq_paciente_p bigint, nm_usuario_p text) AS $body$
DECLARE


c01 CURSOR FOR
SELECT	'P' ie_tipo_item,			   --Procedimento
		a.nr_seq_proc_cpoe nr_seq_cpoe
from	prescr_procedimento a
where	a.nr_prescricao = nr_prescricao_p
and		(a.nr_seq_proc_cpoe IS NOT NULL AND a.nr_seq_proc_cpoe::text <> '')

union all

select	'M' ie_tipo_item,				--Medicamento
		a.nr_seq_mat_cpoe nr_seq_cpoe
from	prescr_material a
where	a.nr_prescricao = nr_prescricao_p
and		(a.nr_seq_mat_cpoe IS NOT NULL AND a.nr_seq_mat_cpoe::text <> '')

union all

select	'N' ie_tipo_item,				--Enteral/Suplemento
		a.nr_seq_dieta_cpoe nr_seq_cpoe
from	prescr_material a
where	a.nr_prescricao = nr_prescricao_p
and		(a.nr_seq_dieta_cpoe IS NOT NULL AND a.nr_seq_dieta_cpoe::text <> '')

union all

select	'N' ie_tipo_item,				--Dieta Oral
		a.nr_seq_dieta_cpoe nr_seq_cpoe
from	prescr_dieta a
where	a.nr_prescricao = nr_prescricao_p
and		(a.nr_seq_dieta_cpoe IS NOT NULL AND a.nr_seq_dieta_cpoe::text <> '')

union all

select	'R' ie_tipo_item,				--Recomendac√£o
		a.nr_seq_rec_cpoe nr_seq_cpoe
from	prescr_recomendacao a
where	a.nr_prescricao = nr_prescricao_p
and		(a.nr_seq_rec_cpoe IS NOT NULL AND a.nr_seq_rec_cpoe::text <> '')

union all

select	'G' ie_tipo_item,				--Gasoterapia
		a.nr_seq_gas_cpoe nr_seq_cpoe
from	prescr_gasoterapia a
where	a.nr_prescricao = nr_prescricao_p
and		(a.nr_seq_gas_cpoe IS NOT NULL AND a.nr_seq_gas_cpoe::text <> '')

union all

select	'N' ie_tipo_item,				--Jejum
		a.nr_seq_dieta_cpoe nr_seq_cpoe
from	rep_jejum a
where	a.nr_prescricao = nr_prescricao_p
and		(a.nr_seq_dieta_cpoe IS NOT NULL AND a.nr_seq_dieta_cpoe::text <> '')

union all

select	'D' ie_tipo_item,				--Dialise
		a.nr_seq_dialise_cpoe nr_seq_cpoe
from	hd_prescricao a
where	a.nr_prescricao = nr_prescricao_p
and		(a.nr_seq_dialise_cpoe IS NOT NULL AND a.nr_seq_dialise_cpoe::text <> '')

union all

select	'N' ie_tipo_item,				--NPT Adulta
		a.nr_seq_npt_cpoe nr_seq_cpoe
FROM nut_pac a
LEFT OUTER JOIN prescr_material b ON (a.nr_sequencia = b.nr_seq_nut_pac)
WHERE a.nr_prescricao = nr_prescricao_p  and (a.nr_seq_npt_cpoe IS NOT NULL AND a.nr_seq_npt_cpoe::text <> '') order by nr_seq_cpoe;


c01_w c01%rowtype;


BEGIN

if (nr_prescricao_p IS NOT NULL AND nr_prescricao_p::text <> '') and (nm_usuario_p IS NOT NULL AND nm_usuario_p::text <> '') then

	update	paciente_atendimento
	set		nr_prescricao  = NULL,
			dt_geracao_prescricao  = NULL
	where	nr_seq_paciente = nr_seq_paciente_p
	and		nr_prescricao = nr_prescricao_p;
	commit;

	if (coalesce(obter_se_prescr_CPOE(nr_prescricao_p),'N') = 'S') then
		begin
			open c01;
			loop
			fetch c01 into
				c01_w;
			EXIT WHEN NOT FOUND; /* apply on c01 */
				CALL cpoe_remover_item(c01_w.ie_tipo_item, c01_w.nr_seq_cpoe, nm_usuario_p);
			end loop;
			close c01;
		exception when others then
			CALL gravar_log_tasy(1616, 'erro desfazer_prescr_oncologia: ' || substr(to_char(sqlerrm),1,2000), nm_usuario_p);
		end;
	end if;

	delete 	from prescr_medica
	where	nr_prescricao = nr_prescricao_p;
	commit;

end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE desfazer_prescr_oncologia ( nr_prescricao_p bigint, nr_seq_paciente_p bigint, nm_usuario_p text) FROM PUBLIC;

