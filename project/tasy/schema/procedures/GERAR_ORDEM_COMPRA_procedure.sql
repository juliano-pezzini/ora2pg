-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_ordem_compra ( nr_cot_compra_p bigint, nr_seq_cot_forn_p bigint, nm_usuario_p text, ie_desfaz_agrupamento_p text) AS $body$
DECLARE


qt_existe_comprador_w		bigint;
cd_comprador_w			varchar(10);
qt_registro_w			bigint;			
cd_estabelecimento_w		integer;
cd_estabelecimento_w2		integer;
cd_estabelecimento_ww		integer;
cd_material_w			integer		:= 0;
nr_item_cot_compra_w		integer		:= 0;
nr_item_w			integer		:= 0;
nr_ordem_compra_w		bigint	:= 0;
nr_ordem_compra_ww		bigint := 0;
nr_seq_fornecedor_w		bigint	:= 0;
nr_seq_fornecedor_w2		bigint	:= 0;
qt_conv_unid_fornec_w		double precision;
qt_material_w			double precision	:= 0;
vl_unitario_w			double precision	:= 0;
pr_desconto_w			double precision	:= 0;
vl_desconto_w			double precision	:= 0;
cd_unidade_w			varchar(30)	:= '0';
ds_material_direto_w		varchar(255)	:= '0';
ds_observacao_w			varchar(255)	:= '0';
ds_marca_w			varchar(30)	:= '';
ds_marca2_w			varchar(30)	:= '';
ie_situacao_w			varchar(1)	:= '0';
dt_entrega_w			timestamp;
dt_validade_w			timestamp;
dt_aprovacao_ordem_w		timestamp;
ie_ajusta_unid_fornec_w		varchar(1)	:= 'S';
ie_gerado_bionexo_w		varchar(1);
ie_liberar_ordem_cotacao_w		varchar(1);
ie_liberar_ordem_calc_cot_w		varchar(1);
cd_cgc_fornecedor_w		varchar(14);
nr_contrato_w			bigint;
cd_centro_custo_w			bigint;
cd_centro_custo_w2		bigint;
dt_entrega_ww			timestamp;
ie_forma_calc_entrega_w		varchar(1);
nr_solic_compra_w			bigint;
nr_solic_compra_w2		bigint;
nr_seq_cot_forn_w		bigint;
nr_seq_cot_forn_w2		bigint := 0;
nr_seq_tipo_bonif_w		bigint;
ie_valor_estrangeiro_w		varchar(1);
nr_documento_externo_w		varchar(10);
ie_gerar_oc_itens_confirm_w	varchar(1);
nr_seq_motivo_solic_w		bigint;
ie_grava_mtv_venc_alt_w		varchar(1);
ds_motivo_venc_alt_w		varchar(255);
/* Shift  + F11 = 'Regra para consistencia do item disp. mercado' */

qt_existe_regra_disp_mer_w		bigint;
ie_acao_disp_mercado_w		varchar(1) := 'N';

/* Verifica se foi gerado itens na ordem de compra. Caso nao, vai deletar a ordem vazia */

qt_itens_gerados_w			bigint;

/*Tratamento processo central de compras*/

ie_central_compra_w		varchar(1);
ie_desfaz_agrupamento_w		varchar(15);
nr_seq_central_compra_item_w	bigint;
ds_motivo_alt_forn_cot_w	varchar(4000);/*Motivo de alteracao do fornecedor vencedor na cotacao - Historico */
ds_titulo_hist_cot_w		varchar(100) := wheb_mensagem_pck.get_texto(301942);/*Motivo de alteracao do fornecedor vencedor na cotacao - Titulo do historico */
ds_marca_fornec_w		cot_compra_forn_item.ds_marca_fornec%type;
ie_grava_item_ordem_compra	varchar(1) := 'N';
qt_reg						bigint;		
nr_solic_compra_ww			cot_compra_item.nr_solic_compra%type;	
nr_item_solic_compra_w  	cot_compra_item.nr_item_solic_compra%type;	
dt_geracao_ordem_compra_w	cot_compra.dt_geracao_ordem_compra%type;		
cd_paciente_forn_item_w  	cot_compra_forn_item.cd_paciente_forn_item%type;

c01 CURSOR FOR
	SELECT	i.nr_item_cot_compra,
		i.cd_material,
		i.cd_unidade_medida_compra,
		i.ie_situacao,
		i.dt_limite_entrega,
		coalesce(r.qt_material, f.qt_material),
		f.ds_observacao,
		coalesce(f.ds_marca_fornec, substr(f.ds_marca,1,position('(' in f.ds_marca)-1)),
		substr(CASE WHEN position('(' in f.ds_marca)=0 THEN f.ds_marca  ELSE substr(f.ds_marca,1,position('(' in f.ds_marca)-1) END ,1,30),
		coalesce(CASE WHEN ie_valor_estrangeiro_w='S' THEN  CASE WHEN obter_se_moeda_forn_estrang(a.nr_sequencia)='S' THEN coalesce(f.vl_unitario_ref_moeda, f.vl_unitario_material)  ELSE f.vl_unitario_material END   ELSE f.vl_unitario_material END ,0),
		coalesce(f.pr_desconto,0),
		coalesce(f.qt_conv_unid_fornec,0),
		f.dt_validade,
		coalesce(f.vl_desconto,0),
		f.nr_contrato,
		(obter_dados_cot_compra_item(i.nr_cot_compra, i.nr_item_cot_compra, 'E'))::numeric  cd_estabelecimento,
		f.ds_marca_fornec
	from	cot_compra_item i,
		cot_compra_forn a,
		cot_compra_forn_item f,
		cot_compra_resumo r
	where	i.nr_cot_compra		= f.nr_cot_compra
	and	i.nr_item_cot_compra 	= f.nr_item_cot_compra
	and	f.nr_seq_cot_forn		= nr_seq_cot_forn_p
	and	f.nr_seq_cot_forn		= a.nr_sequencia
	and	f.nr_sequencia = r.nr_seq_cot_item_forn
	and	f.vl_unitario_material	> 0
	and	coalesce(i.dt_reprovacao::text, '') = ''
	and	substr(obter_se_material_ativo(i.cd_material),1,1) = 'A'
	order by
		i.dt_limite_entrega,
		i.nr_item_cot_compra;

c02 CURSOR FOR
	SELECT	null cd_centro_custo,
		c.cd_estabelecimento,
		c.nr_seq_fornecedor,
		c.nr_item_cot_compra,
		null nr_solic_compra,
		c.cd_material,
		c.cd_unidade_medida_compra,
		coalesce(c.ie_situacao,'A'),
		c.qt_material,
		c.ds_observacao,
		substr(coalesce(c.ds_marca_fornec,CASE WHEN position('(' in c.ds_marca)=0 THEN c.ds_marca  ELSE substr(c.ds_marca,1,position('(' in c.ds_marca)-1) END ),1,30),
		substr(CASE WHEN position('(' in c.ds_marca)=0 THEN c.ds_marca  ELSE substr(c.ds_marca,1,position('(' in c.ds_marca)-1) END ,1,30),
		c.dt_limite_entrega,
		coalesce(CASE WHEN ie_valor_estrangeiro_w='S' THEN  CASE WHEN obter_se_moeda_forn_estrang(c.nr_seq_fornecedor)='S' THEN  coalesce(c.vl_unitario_ref_moeda, c.vl_unitario_material)  ELSE c.vl_unitario_material END   ELSE c.vl_unitario_material END ,0),
		coalesce(c.pr_desconto,0),
		coalesce(c.qt_conv_unid_fornec,0),
		dt_validade,
		coalesce(c.vl_desconto,0),
		c.cd_cgc_fornecedor,
		c.nr_contrato,
		c.ds_marca_fornec,
		c.cd_paciente_forn_item
	from	cot_compra_forn_item_tr_v c
	where	c.nr_cot_compra		= nr_cot_compra_p
	and	coalesce(c.dt_reprovacao::text, '') = ''
	and	c.nr_seq_item_fornec	= obter_venc_cot_fornec_item(c.nr_cot_compra, c.nr_item_cot_compra)
	and (substr(obter_se_material_ativo(c.cd_material),1,1) = 'A')
	and (substr(obter_se_existe_cot_resumo(c.nr_cot_compra),1,1) = 'N')
	
union

	SELECT	null cd_centro_custo,
		c.cd_estabelecimento,
		c.nr_seq_cot_forn,
		c.nr_item_cot_compra,
		null nr_solic_compra,
		c.cd_material,
		c.cd_unidade_medida_compra,
		coalesce(c.ie_situacao,'A'),
		c.qt_material,
		c.ds_observacao,
		substr(coalesce(c.ds_marca_fornec,CASE WHEN position('(' in c.ds_marca)=0 THEN c.ds_marca  ELSE substr(c.ds_marca,1,position('(' in c.ds_marca)-1) END ),1,30),
		substr(CASE WHEN position('(' in c.ds_marca)=0 THEN c.ds_marca  ELSE substr(c.ds_marca,1,position('(' in c.ds_marca)-1) END ,1,30),
		c.dt_limite_entrega,
		coalesce(CASE WHEN ie_valor_estrangeiro_w='S' THEN  CASE WHEN obter_se_moeda_forn_estrang(c.nr_seq_cot_forn)='S' THEN  coalesce(c.vl_unitario_ref_moeda, c.vl_unitario_material)  ELSE c.vl_unitario_material END   ELSE c.vl_unitario_material END ,0),
		coalesce(c.pr_desconto,0),
		coalesce(c.qt_conv_unid_fornec,0),
		c.dt_validade,
		coalesce(c.vl_desconto,0),
		c.cd_cgc_fornecedor,
		c.nr_contrato,
		c.ds_marca_fornec,
		c.cd_paciente_forn_item
	from	cot_compra_resumo_v c
	where	c.nr_cot_compra      	= nr_cot_compra_p
	and (substr(obter_se_existe_cot_resumo(c.nr_cot_compra),1,1) = 'S')
	and	coalesce(obter_dt_reprov_item_cotacao(c.nr_cot_compra, c.nr_item_cot_compra)::text, '') = ''
	and	ie_desfaz_agrupamento_w	 = 'S'
	and	(((ie_gerar_oc_itens_confirm_w = 'N') or (coalesce(nr_documento_externo_w::text, '') = '') or (coalesce(nr_id_integracao::text, '') = '')) or
		((ie_gerar_oc_itens_confirm_w = 'S') and (nr_documento_externo_w IS NOT NULL AND nr_documento_externo_w::text <> '') and (cd_cgc_fornecedor_venc_alt IS NOT NULL AND cd_cgc_fornecedor_venc_alt::text <> '')))
	
union all

	select	null cd_centro_custo,
		a.cd_estabelecimento,
		c.nr_seq_cot_forn,
		c.nr_item_cot_compra,
		null nr_solic_compra,
		c.cd_material,
		c.cd_unidade_medida_compra,
		coalesce(c.ie_situacao,'A'),
		sum(c.qt_material),
		c.ds_observacao,
		substr(coalesce(c.ds_marca_fornec,CASE WHEN position('(' in c.ds_marca)=0 THEN c.ds_marca  ELSE substr(c.ds_marca,1,position('(' in c.ds_marca)-1) END ),1,30),
		substr(CASE WHEN position('(' in c.ds_marca)=0 THEN c.ds_marca  ELSE substr(c.ds_marca,1,position('(' in c.ds_marca)-1) END ,1,30),
		c.dt_limite_entrega,
		coalesce(CASE WHEN ie_valor_estrangeiro_w='S' THEN  CASE WHEN obter_se_moeda_forn_estrang(c.nr_seq_cot_forn)='S' THEN  coalesce(c.vl_unitario_ref_moeda, c.vl_unitario_material)  ELSE c.vl_unitario_material END   ELSE c.vl_unitario_material END ,0),
		coalesce(c.pr_desconto,0),
		coalesce(c.qt_conv_unid_fornec,0),
		c.dt_validade,
		coalesce(c.vl_desconto,0),
		c.cd_cgc_fornecedor,
		c.nr_contrato,
		c.ds_marca_fornec,
		c.cd_paciente_forn_item
	from	cot_compra a,
		cot_compra_resumo_v c
	where	c.nr_cot_compra      = nr_cot_compra_p
	and	c.nr_cot_compra      = a.nr_cot_compra
	and	coalesce(obter_dt_reprov_item_cotacao(c.nr_cot_compra, c.nr_item_cot_compra)::text, '') = ''
	and (substr(obter_se_existe_cot_resumo(c.nr_cot_compra),1,1) = 'S')
	and	ie_desfaz_agrupamento_w = 'N'
	and	(((ie_gerar_oc_itens_confirm_w = 'N') or (coalesce(nr_documento_externo_w::text, '') = '') or (coalesce(nr_id_integracao::text, '') = '')) or
		((ie_gerar_oc_itens_confirm_w = 'S') and (nr_documento_externo_w IS NOT NULL AND nr_documento_externo_w::text <> '') and (cd_cgc_fornecedor_venc_alt IS NOT NULL AND cd_cgc_fornecedor_venc_alt::text <> '')))
	group by
		a.cd_estabelecimento,
		c.nr_seq_cot_forn,
		c.nr_item_cot_compra,
		c.cd_material,
		c.cd_unidade_medida_compra,
		coalesce(c.ie_situacao,'A'),
		c.ds_observacao,
		coalesce(c.ds_marca_fornec,CASE WHEN position('(' in c.ds_marca)=0 THEN c.ds_marca  ELSE substr(c.ds_marca,1,position('(' in c.ds_marca)-1) END ),
		CASE WHEN position('(' in c.ds_marca)=0 THEN c.ds_marca  ELSE substr(c.ds_marca,1,position('(' in c.ds_marca)-1) END ,
		c.dt_limite_entrega,
		coalesce(CASE WHEN ie_valor_estrangeiro_w='S' THEN  CASE WHEN obter_se_moeda_forn_estrang(c.nr_seq_cot_forn)='S' THEN  coalesce(c.vl_unitario_ref_moeda, c.vl_unitario_material)  ELSE c.vl_unitario_material END   ELSE c.vl_unitario_material END ,0),
		coalesce(c.pr_desconto,0),
		coalesce(c.qt_conv_unid_fornec,0),
		c.dt_validade,
		coalesce(c.vl_desconto,0),
		c.cd_cgc_fornecedor,
		c.nr_contrato,
		c.ds_marca_fornec,
		c.cd_paciente_forn_item
	
union all

	select	null cd_centro_custo,
		a.cd_estabelecimento,
		c.nr_seq_cot_forn,
		c.nr_item_cot_compra,
		c.nr_solic_compra,
		c.cd_material,
		c.cd_unidade_medida_compra,
		coalesce(c.ie_situacao,'A'),
		sum(c.qt_material),
		c.ds_observacao,
		substr(coalesce(c.ds_marca_fornec,CASE WHEN position('(' in c.ds_marca)=0 THEN c.ds_marca  ELSE substr(c.ds_marca,1,position('(' in c.ds_marca)-1) END ),1,30),
		substr(CASE WHEN position('(' in c.ds_marca)=0 THEN c.ds_marca  ELSE substr(c.ds_marca,1,position('(' in c.ds_marca)-1) END ,1,30),
		c.dt_limite_entrega,
		coalesce(CASE WHEN ie_valor_estrangeiro_w='S' THEN  CASE WHEN obter_se_moeda_forn_estrang(c.nr_seq_cot_forn)='S' THEN  coalesce(c.vl_unitario_ref_moeda, c.vl_unitario_material)  ELSE c.vl_unitario_material END   ELSE c.vl_unitario_material END ,0),
		coalesce(c.pr_desconto,0),
		coalesce(c.qt_conv_unid_fornec,0),
		c.dt_validade,
		coalesce(c.vl_desconto,0),
		c.cd_cgc_fornecedor,
		c.nr_contrato,
		c.ds_marca_fornec,
		c.cd_paciente_forn_item
	from	cot_compra a,
		cot_compra_resumo_v c
	where	c.nr_cot_compra      = nr_cot_compra_p
	and	c.nr_cot_compra      = a.nr_cot_compra
	and	coalesce(obter_dt_reprov_item_cotacao(c.nr_cot_compra, c.nr_item_cot_compra)::text, '') = ''
	and (substr(obter_se_existe_cot_resumo(c.nr_cot_compra),1,1) = 'S')
	and	ie_desfaz_agrupamento_w = 'SC'
	and	(((ie_gerar_oc_itens_confirm_w = 'N') or (coalesce(nr_documento_externo_w::text, '') = '') or (coalesce(c.nr_id_integracao::text, '') = '')) or
		((ie_gerar_oc_itens_confirm_w = 'S') and (nr_documento_externo_w IS NOT NULL AND nr_documento_externo_w::text <> '') and (c.cd_cgc_fornecedor_venc_alt IS NOT NULL AND c.cd_cgc_fornecedor_venc_alt::text <> '')))
	group by
		a.cd_estabelecimento,
		c.nr_seq_cot_forn,
		c.nr_item_cot_compra,
		c.nr_solic_compra,
		c.cd_material,
		c.cd_unidade_medida_compra,
		coalesce(c.ie_situacao,'A'),
		c.ds_observacao,
		coalesce(c.ds_marca_fornec,CASE WHEN position('(' in c.ds_marca)=0 THEN c.ds_marca  ELSE substr(c.ds_marca,1,position('(' in c.ds_marca)-1) END ),
		CASE WHEN position('(' in c.ds_marca)=0 THEN c.ds_marca  ELSE substr(c.ds_marca,1,position('(' in c.ds_marca)-1) END ,
		c.dt_limite_entrega,
		coalesce(CASE WHEN ie_valor_estrangeiro_w='S' THEN  CASE WHEN obter_se_moeda_forn_estrang(c.nr_seq_cot_forn)='S' THEN  coalesce(c.vl_unitario_ref_moeda, c.vl_unitario_material)  ELSE c.vl_unitario_material END   ELSE c.vl_unitario_material END ,0),
		coalesce(c.pr_desconto,0),
		coalesce(c.qt_conv_unid_fornec,0),
		c.dt_validade,
		coalesce(c.vl_desconto,0),
		c.cd_cgc_fornecedor,
		c.nr_contrato,
		c.ds_marca_fornec,
		c.cd_paciente_forn_item
	
union all

	select	obter_dados_solic_compra(coalesce(a.nr_solic_compra,b.nr_solic_compra),7) cd_centro_custo,
		obter_estab_solic_compra(coalesce(a.nr_solic_compra,b.nr_solic_compra)) cd_estabelecimento,
		c.nr_seq_cot_forn,
		c.nr_item_cot_compra,
		null nr_solic_compra,
		c.cd_material,
		c.cd_unidade_medida_compra,
		coalesce(c.ie_situacao,'A'),
		sum(c.qt_material),
		c.ds_observacao,
		substr(coalesce(c.ds_marca_fornec,CASE WHEN position('(' in c.ds_marca)=0 THEN c.ds_marca  ELSE substr(c.ds_marca,1,position('(' in c.ds_marca)-1) END ),1,30),
		substr(CASE WHEN position('(' in c.ds_marca)=0 THEN c.ds_marca  ELSE substr(c.ds_marca,1,position('(' in c.ds_marca)-1) END ,1,30),
		c.dt_limite_entrega,
		coalesce(CASE WHEN ie_valor_estrangeiro_w='S' THEN  CASE WHEN obter_se_moeda_forn_estrang(c.nr_seq_cot_forn)='S' THEN  coalesce(c.vl_unitario_ref_moeda, c.vl_unitario_material)  ELSE c.vl_unitario_material END   ELSE c.vl_unitario_material END ,0),
		coalesce(c.pr_desconto,0),
		coalesce(c.qt_conv_unid_fornec,0),
		c.dt_validade,
		coalesce(c.vl_desconto,0),
		c.cd_cgc_fornecedor,
		c.nr_contrato,		
		c.ds_marca_fornec,
		c.cd_paciente_forn_item
	FROM cot_compra_resumo_v c, cot_compra_item b
LEFT OUTER JOIN cot_compra_solic_agrup a ON (b.nr_cot_compra = a.nr_cot_compra AND b.nr_item_cot_compra = a.nr_item_cot_compra)
WHERE c.nr_cot_compra 		= b.nr_cot_compra and c.nr_item_cot_compra 	= b.nr_item_cot_compra   and c.nr_cot_compra      	= nr_cot_compra_p and coalesce(obter_dt_reprov_item_cotacao(c.nr_cot_compra, c.nr_item_cot_compra)::text, '') = '' and (substr(obter_se_existe_cot_resumo(c.nr_cot_compra),1,1) = 'S') and ie_desfaz_agrupamento_w = 'C' and (((ie_gerar_oc_itens_confirm_w = 'N') or (coalesce(nr_documento_externo_w::text, '') = '') or (coalesce(c.nr_id_integracao::text, '') = '')) or
		((ie_gerar_oc_itens_confirm_w = 'S') and (nr_documento_externo_w IS NOT NULL AND nr_documento_externo_w::text <> '') and (c.cd_cgc_fornecedor_venc_alt IS NOT NULL AND c.cd_cgc_fornecedor_venc_alt::text <> ''))) group by
		obter_dados_solic_compra(coalesce(a.nr_solic_compra,b.nr_solic_compra),7),
		obter_estab_solic_compra(coalesce(a.nr_solic_compra,b.nr_solic_compra)),
		c.nr_seq_cot_forn,
		c.nr_item_cot_compra,
		c.cd_material,
		c.cd_unidade_medida_compra,
		coalesce(c.ie_situacao,'A'),
		c.ds_observacao,
		coalesce(c.ds_marca_fornec,CASE WHEN position('(' in c.ds_marca)=0 THEN c.ds_marca  ELSE substr(c.ds_marca,1,position('(' in c.ds_marca)-1) END ),
		CASE WHEN position('(' in c.ds_marca)=0 THEN c.ds_marca  ELSE substr(c.ds_marca,1,position('(' in c.ds_marca)-1) END ,
		c.dt_limite_entrega,
		coalesce(CASE WHEN ie_valor_estrangeiro_w='S' THEN  CASE WHEN obter_se_moeda_forn_estrang(c.nr_seq_cot_forn)='S' THEN  coalesce(c.vl_unitario_ref_moeda, c.vl_unitario_material)  ELSE c.vl_unitario_material END   ELSE c.vl_unitario_material END ,0),
		coalesce(c.pr_desconto,0),
		coalesce(c.qt_conv_unid_fornec,0),
		c.dt_validade,
		coalesce(c.vl_desconto,0),
		c.cd_cgc_fornecedor,
		c.nr_contrato,
		c.ds_marca_fornec,
		c.cd_paciente_forn_item
	order by
		cd_centro_custo,
		cd_estabelecimento,
		nr_solic_compra,
		3,
		cd_cgc_fornecedor,
		dt_limite_entrega,
		nr_item_cot_compra;

c03 CURSOR FOR
SELECT	distinct nr_ordem_compra
from	ordem_compra_item
where	nr_cot_compra = nr_cot_compra_p;

c04 CURSOR FOR
SELECT	a.nr_sequencia,
	c.cd_material,
	c.qt_material,
	coalesce(c.vl_unitario,0),
	c.cd_unidade_medida_compra,
	b.nr_item_cot_compra,
	coalesce(b.qt_conv_unid_fornec,0),
	b.dt_validade
from	cot_compra_forn a,
	cot_compra_forn_item b,
	cot_compra_forn_item_bon c
where	a.nr_sequencia	= b.nr_seq_cot_forn
and	b.nr_sequencia	= c.nr_seq_cot_item_forn
and	a.nr_cot_compra	= nr_cot_compra_p;



c05 CURSOR FOR
SELECT	substr(ds_motivo_venc_alt || chr(13) || chr(10) || substr(wheb_mensagem_pck.get_Texto(795122, 'DS_MOTIVO='|| obter_valor_dominio(4444, ie_motivo_alter_venc)),1,255),1,4000)
from	cot_compra_item
where	nr_cot_compra = nr_cot_compra_p
and	nr_item_cot_compra = nr_item_cot_compra_w
and (ds_motivo_venc_alt IS NOT NULL AND ds_motivo_venc_alt::text <> '')
and (ie_motivo_alter_venc IS NOT NULL AND ie_motivo_alter_venc::text <> '');


BEGIN

select	max(dt_geracao_ordem_compra)
into STRICT	dt_geracao_ordem_compra_w
from	cot_compra
where	nr_cot_compra = nr_cot_compra_p;

if (dt_geracao_ordem_compra_w IS NOT NULL AND dt_geracao_ordem_compra_w::text <> '') then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(139136, 'NR_COTACAO=' || nr_cot_compra_p);
end if;

ie_desfaz_agrupamento_w	:= ie_desfaz_agrupamento_p;

select	count(*)
into STRICT	qt_registro_w
from	cot_compra_item
where	nr_cot_compra = nr_cot_compra_p
and	coalesce(dt_reprovacao::text, '') = '';


if (qt_registro_w = 0) then
	/*Todos os itens dessa cotacao de compras estao reprovados. Devido a isso, a ordem de compra nao sera gerada.*/

	CALL wheb_mensagem_pck.exibir_mensagem_abort(200422);
end if;

select	coalesce(max('S'),'N')
into STRICT	ie_central_compra_w
from	cot_compra_item a
where	a.nr_cot_compra	= nr_cot_compra_p
and (coalesce(a.nr_seq_central_compra_item,0) > 0 or
		exists (	SELECT	1
			from	cot_compra_solic_agrup x
			where	x.nr_cot_compra = a.nr_cot_compra
			and	x.nr_item_cot_compra = a.nr_item_cot_compra
			and	coalesce(x.nr_seq_central_compra_item,0) > 0));
			
if (ie_central_compra_w = 'S') then
	begin
	select	coalesce(max(nr_seq_central_compra_item),0)
	into STRICT	nr_seq_central_compra_item_w
	from	cot_compra_item a
	where	a.nr_cot_compra	= nr_cot_compra_p;
	
	if (nr_seq_central_compra_item_w = 0) then
		select	coalesce(max(nr_seq_central_compra_item),0)
		into STRICT	nr_seq_central_compra_item_w
		from	cot_compra_solic_agrup a
		where	a.nr_cot_compra = nr_cot_compra_p;
	end if;

	select	coalesce(max(CASE WHEN ie_tipo_processo='C' THEN 'S' WHEN ie_tipo_processo='D' THEN 'N' END ),'N')
	into STRICT	ie_desfaz_agrupamento_w
	from	sup_central_compra a,
		sup_central_compra_item b
	where	a.nr_sequencia = b.nr_seq_sup_central_compra
	and	b.nr_sequencia = nr_seq_central_compra_item_w;
	end;
end if;

/* Shift  + F11 = 'Regra para consistencia do item disp. mercado' */

delete from w_consist_disp_mercado
where nm_usuario = nm_usuario_p
and   cd_funcao = 917;
commit;

select 	max(cd_estabelecimento),
	max(nr_documento_externo)
into STRICT	cd_estabelecimento_ww,
	nr_documento_externo_w
from	cot_compra
where	nr_cot_compra = nr_cot_compra_p;
	
select	substr(coalesce(obter_valor_param_usuario(915, 67, Obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_ww),'L'),1,1),
	substr(coalesce(obter_valor_param_usuario(915, 166, Obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_ww),'L'),1,1)
into STRICT	ie_forma_calc_entrega_w,
	ie_grava_mtv_venc_alt_w
;	
	
select	coalesce(max(ie_ajusta_unid_fornec),'N'),
	coalesce(max(ie_liberar_ordem_cotacao),'N'),
	coalesce(max(ie_liberar_ordem_calc_cot),'N'),
	max(nr_seq_tipo_bonif),
	coalesce(max(ie_valor_estrangeiro),'N'),
	coalesce(max(ie_gerar_oc_itens_confirm),'N')
into STRICT	ie_ajusta_unid_fornec_w,
	ie_liberar_ordem_cotacao_w,
	ie_liberar_ordem_calc_cot_w,
	nr_seq_tipo_bonif_w,
	ie_valor_estrangeiro_w,
	ie_gerar_oc_itens_confirm_w
from	parametro_compras b,
	cot_compra a
where	a.cd_estabelecimento	= b.cd_estabelecimento
and	a.nr_cot_compra		= nr_cot_compra_p;

if (nr_seq_cot_forn_p IS NOT NULL AND nr_seq_cot_forn_p::text <> '') then
	begin
	nr_ordem_compra_w := grava_ordem_compra(
		nr_cot_compra_p, null, nr_seq_cot_forn_p, nm_usuario_p, nr_ordem_compra_w);
	qt_itens_gerados_w := 0;

	select	coalesce(max(cd_comprador),'X')
	into STRICT	cd_comprador_w
	from	ordem_compra
	where	nr_ordem_compra = nr_ordem_compra_w;

	open c01;
	loop
	fetch c01
	into	nr_item_cot_compra_w,
		cd_material_w,
		cd_unidade_w,
		ie_situacao_w,
		dt_entrega_w,
		qt_material_w,
		ds_observacao_w,
		ds_marca_w,
		ds_marca2_w,
		vl_unitario_w,
		pr_desconto_w,
		qt_conv_unid_fornec_w,
		dt_validade_w,
		vl_desconto_w,
		nr_contrato_w,
		cd_estabelecimento_w,
		ds_marca_fornec_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
		begin

		if (cd_estabelecimento_w > 0) then

			select	count(*)
			into STRICT	qt_existe_comprador_w
			from	comprador
			where	cd_estabelecimento = cd_estabelecimento_w
			and	cd_pessoa_fisica = cd_comprador_w;

			if (qt_existe_comprador_w = 0) and (cd_comprador_w <> 'X') then

				insert into comprador(
					cd_pessoa_fisica,
					nm_guerra,
					dt_atualizacao,
					nm_usuario,
					cd_estabelecimento,
					ie_situacao)
				values (cd_comprador_w,
					substr(obter_nome_pf(cd_comprador_w),1,80),
					clock_timestamp(),
					nm_usuario_p,
					cd_estabelecimento_w,
					'A');

			end if;

			update	ordem_compra
			set	cd_estabelecimento	= cd_estabelecimento_w
			where	nr_ordem_compra		= nr_ordem_compra_w;
		end if;
		
		if (ie_forma_calc_entrega_w = 'L') then
			dt_entrega_ww	:= dt_entrega_w + coalesce(obter_dados_cot_compra_forn(nr_cot_compra_p,nr_seq_cot_forn_p,'DE'), 0);
		elsif (ie_forma_calc_entrega_w = 'F') then		
			dt_entrega_ww	:= dt_entrega_w;
		else	dt_entrega_ww	:= trunc(clock_timestamp(),'dd') + coalesce(obter_dados_cot_compra_forn(nr_cot_compra_p,nr_seq_cot_forn_p,'DE'), 0);		
		end if;

		/* Verifica se possui evento na 'Regra para consistencia do item disp. mercado' */

		select	count(*)
		into STRICT	qt_existe_regra_disp_mer_w
		from	consiste_disp_mercado
		where	cd_evento = 'OC';

		if (qt_existe_regra_disp_mer_w > 0) then
			begin
			/* Verifica se possui evento na 'Regra para consistencia do item disp. mercado', e se o material esta disponivel no mercado */

			select  substr(obter_acao_regra_disp_mercado('OC', cd_material_w, null, cd_estabelecimento_ww),1,1) ie_acao_regra
			into STRICT	ie_acao_disp_mercado_w
			;

			if (ie_acao_disp_mercado_w <> 'N') then
				begin
				CALL grava_consiste_disp_mercado( 917,
							     cd_material_w,
							     nm_usuario_p,
							     ie_acao_disp_mercado_w);
				end;
			end if;

			end;
		end if;

		if (ie_grava_mtv_venc_alt_w = 'S') then
			select	substr(ds_motivo_venc_alt,1,255)
			into STRICT	ds_motivo_venc_alt_w
			from	cot_compra_item
			where	nr_cot_compra = nr_cot_compra_p
			and	nr_item_cot_compra = nr_item_cot_compra_w;

			ds_observacao_w := substr(ds_observacao_w || chr(13) || chr(10) || ds_motivo_venc_alt_w,1,255);
		end if;

		if (ie_acao_disp_mercado_w in ('M', 'N')) then
		
			ie_grava_item_ordem_compra := 'N';
		
			select	coalesce(max(nr_solic_compra),0),
					coalesce(max(nr_item_solic_compra),0)
			into STRICT	nr_solic_compra_ww,
					nr_item_solic_compra_w
			from	cot_compra_item
			where	nr_cot_compra = nr_cot_compra_p
			and		nr_item_cot_compra = nr_item_cot_compra_w;
			
			if (nr_solic_compra_ww = 0) and (nr_item_solic_compra_w = 0) then
				select	count(*)
				into STRICT	qt_reg
				from	cot_compra_solic_agrup c
				where	c.nr_cot_compra = nr_cot_compra_p
				and		c.nr_item_cot_compra = nr_item_cot_compra_w
				and		(c.nr_solic_compra IS NOT NULL AND c.nr_solic_compra::text <> '')
				and		(c.nr_item_solic_compra IS NOT NULL AND c.nr_item_solic_compra::text <> '');
			
				if (qt_reg > 0) then
					select 	count(*)
					into STRICT	qt_reg
					from	cot_compra_solic_agrup c,
							solic_compra a,
							solic_compra_item b
					where	a.nr_solic_compra = b.nr_solic_compra
					and		c.nr_solic_compra = b.nr_solic_compra
					and		c.nr_item_solic_compra = b.nr_item_solic_compra
					and		c.nr_cot_compra = nr_cot_compra_p
					and		c.nr_item_cot_compra = nr_item_cot_compra_w
					and		coalesce(a.cd_motivo_baixa::text, '') = ''
					and		coalesce(b.cd_motivo_baixa::text, '') = '';
					
					if (qt_reg > 0) then
						ie_grava_item_ordem_compra := 'S';
						
						select 	count(*)
						into STRICT	qt_reg
						from	cot_compra_solic_agrup c,
								solic_compra a,
								solic_compra_item b
						where	a.nr_solic_compra = b.nr_solic_compra
						and		c.nr_solic_compra = b.nr_solic_compra
						and		c.nr_item_solic_compra = b.nr_item_solic_compra
						and		c.nr_cot_compra = nr_cot_compra_p
						and		c.nr_item_cot_compra = nr_item_cot_compra_w
						and (coalesce(a.dt_baixa::text, '') = ''
						and		coalesce(b.dt_baixa::text, '') = '');
						
						if (qt_reg > 0) then
							select 	sum(c.qt_material)
							into STRICT	qt_material_w
							from	cot_compra_solic_agrup c,
									solic_compra a,
									solic_compra_item b
							where	a.nr_solic_compra = b.nr_solic_compra
							and		c.nr_solic_compra = b.nr_solic_compra
							and		c.nr_item_solic_compra = b.nr_item_solic_compra
							and		c.nr_cot_compra = nr_cot_compra_p
							and		c.nr_item_cot_compra = nr_item_cot_compra_w
							and		coalesce(a.cd_motivo_baixa::text, '') = ''
							and		coalesce(b.cd_motivo_baixa::text, '') = '';
						end if;	
					end if;
				else
					ie_grava_item_ordem_compra := 'S';
				end if;
			else
				select	count(*)
				into STRICT	qt_reg
				from	solic_compra a,
						solic_compra_item b
				where	a.nr_solic_compra = b.nr_solic_compra
				and		b.nr_solic_compra = nr_solic_compra_ww
				and		b.nr_item_solic_compra = nr_item_solic_compra_w
				and		coalesce(a.cd_motivo_baixa::text, '') = ''
				and		coalesce(b.cd_motivo_baixa::text, '') = '';
				
				if (qt_reg > 0) then
					ie_grava_item_ordem_compra := 'S';
				end if;
			end if;
		
			if (ie_grava_item_ordem_compra = 'S') then
				CALL grava_item_ordem_compra(
					nr_ordem_compra_w,
					cd_material_w,
					cd_unidade_w,
					vl_unitario_w,
					qt_material_w,
					ds_observacao_w,
					ds_marca_w,
					ds_marca2_w,
					nm_usuario_p,
					ie_situacao_w,
					dt_entrega_ww,
					pr_desconto_w,
					nr_cot_compra_p,
					nr_item_cot_compra_w,
					nr_seq_cot_forn_p,
					qt_conv_unid_fornec_w,
					ie_ajusta_unid_fornec_w,
					dt_validade_w,
					ie_desfaz_agrupamento_w,
					coalesce(vl_desconto_w,0),
					nr_contrato_w,
					null,
					ds_marca_fornec_w,
					null);

                qt_itens_gerados_w := coalesce(qt_itens_gerados_w,0) + 1;
			end if;

			open c05;
			loop
			fetch c05 into	
				ds_motivo_alt_forn_cot_w;
			EXIT WHEN NOT FOUND; /* apply on c05 */
				begin
				CALL gerar_ordem_compra_hist(nr_ordem_compra_w, null, ds_titulo_hist_cot_w, ds_motivo_alt_forn_cot_w, nm_usuario_p);
				end;
			end loop;
			close c05;

		end if;
		end;
	end loop;
	close c01;

	if (coalesce(qt_itens_gerados_w,0) > 0) then
		update	cot_compra_forn
		set	ie_status = 'FH'
		where	nr_sequencia = nr_seq_cot_forn_p;
	end if;

	CALL gerar_ordem_compra_venc( nr_ordem_compra_w, nm_usuario_p);
	calcular_liquido_ordem_compra( nr_ordem_compra_w, nm_usuario_p);
	end;
else
	begin
	open c02;
	loop
	fetch c02
	into	cd_centro_custo_w,
		cd_estabelecimento_w,
		nr_seq_fornecedor_w,
		nr_item_cot_compra_w,
		nr_solic_compra_w,
		cd_material_w,
		cd_unidade_w,
		ie_situacao_w,
		qt_material_w,
		ds_observacao_w,
		ds_marca_w,
		ds_marca2_w,
		dt_entrega_w,
		vl_unitario_w,
		pr_desconto_w,
		qt_conv_unid_fornec_w,
		dt_validade_w,
		vl_desconto_w,
		cd_cgc_fornecedor_w,
		nr_contrato_w,
		ds_marca_fornec_w,
		cd_paciente_forn_item_w;
	EXIT WHEN NOT FOUND; /* apply on c02 */

	/*ie_desfaz_agrupamento_w
	A opcao com SC nao existe no dominio porque e uma opcao fixa que e passada no programa.
	Na cotacao existe o parametro 105 para permitir desdobrar por solicitacao, e existe mais uma opcao (MD) no porgrama.
	Desta forma pode estar parametrizado de uma forma, mas em determinada situacao desdobrar pela solicitacao.
	*/


	/* Verifica se possui evento na 'Regra para consistencia do item disp. mercado' */

	select	count(*)
	into STRICT	qt_existe_regra_disp_mer_w
	from	consiste_disp_mercado
	where	cd_evento = 'OC';

	if (qt_existe_regra_disp_mer_w > 0) then
		begin
		/* Verifica se possui evento na 'Regra para consistencia do item disp. mercado', e se o material esta disponivel no mercado */

		select  substr(obter_acao_regra_disp_mercado('OC', cd_material_w, null, cd_estabelecimento_w),1,1) ie_acao_regra
		into STRICT	ie_acao_disp_mercado_w
		;

		if (ie_acao_disp_mercado_w <> 'N') then
			begin
			CALL grava_consiste_disp_mercado( 917,
						     cd_material_w,
						     nm_usuario_p,
						     ie_acao_disp_mercado_w);
			end;
		end if;

		end;
	end if;
	
	if (ie_grava_mtv_venc_alt_w = 'S') then
		select	substr(ds_motivo_venc_alt,1,255)
		into STRICT	ds_motivo_venc_alt_w
		from	cot_compra_item
		where	nr_cot_compra = nr_cot_compra_p
		and	nr_item_cot_compra = nr_item_cot_compra_w;

		ds_observacao_w := substr(ds_observacao_w || chr(13) || chr(10) || ds_motivo_venc_alt_w,1,255);
	end if;

	if	((nr_seq_fornecedor_w2 <> nr_seq_fornecedor_w) or
		 ((ie_desfaz_agrupamento_w in ('S','N')) and (cd_estabelecimento_w2	<> cd_estabelecimento_w)) or
		 (ie_desfaz_agrupamento_w = 'SC' AND nr_solic_compra_w2 	<> nr_solic_compra_w) or
		 (ie_desfaz_agrupamento_w = 'C' AND cd_centro_custo_w2 	<> cd_centro_custo_w)) then
		 
		nr_seq_fornecedor_w2 	:= nr_seq_fornecedor_w;
		cd_estabelecimento_w2	:= cd_estabelecimento_w;
		cd_centro_custo_w2	:= cd_centro_custo_w;
		nr_solic_compra_w2	:= nr_solic_compra_w;

		if (coalesce(qt_itens_gerados_w,0) = 0) and (nr_ordem_compra_w > 0) then
			delete from ordem_compra
			where	nr_ordem_compra = nr_ordem_compra_w;
			commit;
		end if;

		nr_ordem_compra_w := grava_ordem_compra(
			nr_cot_compra_p, cd_estabelecimento_w, nr_seq_fornecedor_w, nm_usuario_p, nr_ordem_compra_w);
		qt_itens_gerados_w := 0;

		if (ie_forma_calc_entrega_w = 'L') then
			dt_entrega_ww	:= dt_entrega_w + coalesce(obter_dados_cot_compra_forn(nr_cot_compra_p,nr_seq_fornecedor_w,'DE'), 0);
		elsif (ie_forma_calc_entrega_w = 'F') then
			dt_entrega_ww	:= dt_entrega_w;
		else
			dt_entrega_ww	:= trunc(clock_timestamp(),'dd') + coalesce(obter_dados_cot_compra_forn(nr_cot_compra_p,nr_seq_fornecedor_w,'DE'), 0);
		end if;

		if (ie_acao_disp_mercado_w in ('M', 'N')) then
		
			ie_grava_item_ordem_compra := 'N';
			
			select	coalesce(max(nr_solic_compra),0),
					coalesce(max(nr_item_solic_compra),0)
			into STRICT	nr_solic_compra_ww,
					nr_item_solic_compra_w
			from	cot_compra_item
			where	nr_cot_compra = nr_cot_compra_p
			and		nr_item_cot_compra = nr_item_cot_compra_w;
			
			if (nr_solic_compra_ww = 0) and (nr_item_solic_compra_w = 0) then
				select	count(*)
				into STRICT	qt_reg
				from	cot_compra_solic_agrup c
				where	c.nr_cot_compra = nr_cot_compra_p
				and		c.nr_item_cot_compra = nr_item_cot_compra_w
				and		(c.nr_solic_compra IS NOT NULL AND c.nr_solic_compra::text <> '')
				and		(c.nr_item_solic_compra IS NOT NULL AND c.nr_item_solic_compra::text <> '');
			
				if (qt_reg > 0) then
					select 	count(*)
					into STRICT	qt_reg
					from	cot_compra_solic_agrup c,
							solic_compra a,
							solic_compra_item b
					where	a.nr_solic_compra = b.nr_solic_compra
					and		c.nr_solic_compra = b.nr_solic_compra
					and		c.nr_item_solic_compra = b.nr_item_solic_compra
					and		c.nr_cot_compra = nr_cot_compra_p
					and		c.nr_item_cot_compra = nr_item_cot_compra_w
					and		coalesce(a.cd_motivo_baixa::text, '') = ''
					and		coalesce(b.cd_motivo_baixa::text, '') = '';
					
					if (qt_reg > 0) then
						ie_grava_item_ordem_compra := 'S';
						
						select 	count(*)
						into STRICT	qt_reg
						from	cot_compra_solic_agrup c,
								solic_compra a,
								solic_compra_item b
						where	a.nr_solic_compra = b.nr_solic_compra
						and		c.nr_solic_compra = b.nr_solic_compra
						and		c.nr_item_solic_compra = b.nr_item_solic_compra
						and		c.nr_cot_compra = nr_cot_compra_p
						and		c.nr_item_cot_compra = nr_item_cot_compra_w
						and (coalesce(a.dt_baixa::text, '') = ''
						and		coalesce(b.dt_baixa::text, '') = '');
						
						if (qt_reg > 0) then
							select 	sum(c.qt_material)
							into STRICT	qt_material_w
							from	cot_compra_solic_agrup c,
									solic_compra a,
									solic_compra_item b
							where	a.nr_solic_compra = b.nr_solic_compra
							and		c.nr_solic_compra = b.nr_solic_compra
							and		c.nr_item_solic_compra = b.nr_item_solic_compra
							and		c.nr_cot_compra = nr_cot_compra_p
							and		c.nr_item_cot_compra = nr_item_cot_compra_w
							and		coalesce(a.cd_motivo_baixa::text, '') = ''
							and		coalesce(b.cd_motivo_baixa::text, '') = '';
						end if;	
					end if;
				else
					ie_grava_item_ordem_compra := 'S';
				end if;
			else
				select	count(*)
				into STRICT	qt_reg
				from	solic_compra a,
						solic_compra_item b
				where	a.nr_solic_compra = b.nr_solic_compra
				and		b.nr_solic_compra = nr_solic_compra_ww
				and		b.nr_item_solic_compra = nr_item_solic_compra_w
				and		coalesce(a.cd_motivo_baixa::text, '') = ''
				and		coalesce(b.cd_motivo_baixa::text, '') = '';
				
				if (qt_reg > 0) then
					ie_grava_item_ordem_compra := 'S';
				end if;
			end if;
		
			if (ie_grava_item_ordem_compra = 'S') then
				CALL grava_item_ordem_compra(
					nr_ordem_compra_w,
					cd_material_w,
					cd_unidade_w,
					vl_unitario_w,
					qt_material_w,
					ds_observacao_w,
					ds_marca_w,
					ds_marca2_w,
					nm_usuario_p,
					ie_situacao_w,
					dt_entrega_ww,
					pr_desconto_w,
					nr_cot_compra_p,
					nr_item_cot_compra_w,
					nr_seq_fornecedor_w,
					qt_conv_unid_fornec_w,
					ie_ajusta_unid_fornec_w,
					dt_validade_w,
					ie_desfaz_agrupamento_w,
					coalesce(vl_desconto_w,0),
					nr_contrato_w,
					cd_centro_custo_w,
					ds_marca_fornec_w,
					cd_paciente_forn_item_w);

                qt_itens_gerados_w	:= coalesce(qt_itens_gerados_w,0) + 1;
			end if;

			open c05;
			loop
			fetch c05 into	
				ds_motivo_alt_forn_cot_w;
			EXIT WHEN NOT FOUND; /* apply on c05 */
				begin
				CALL gerar_ordem_compra_hist(nr_ordem_compra_w, null, ds_titulo_hist_cot_w, ds_motivo_alt_forn_cot_w, nm_usuario_p);
				end;
			end loop;
			close c05;

		end if;
	else
		
		if (ie_forma_calc_entrega_w = 'L') then
			dt_entrega_ww	:= dt_entrega_w + coalesce(obter_dados_cot_compra_forn(nr_cot_compra_p,nr_seq_fornecedor_w,'DE'), 0);
		elsif (ie_forma_calc_entrega_w = 'F') then
			dt_entrega_ww	:= dt_entrega_w;
		else
			dt_entrega_ww	:= trunc(clock_timestamp(),'dd') + coalesce(obter_dados_cot_compra_forn(nr_cot_compra_p,nr_seq_fornecedor_w,'DE'), 0);
		end if;

		if (ie_acao_disp_mercado_w in ('M', 'N')) then
		
			ie_grava_item_ordem_compra := 'N';
			
			select	coalesce(max(nr_solic_compra),0),
					coalesce(max(nr_item_solic_compra),0)
			into STRICT	nr_solic_compra_ww,
					nr_item_solic_compra_w
			from	cot_compra_item
			where	nr_cot_compra = nr_cot_compra_p
			and		nr_item_cot_compra = nr_item_cot_compra_w;
			
			if (nr_solic_compra_ww = 0) and (nr_item_solic_compra_w = 0) then
				select	count(*)
				into STRICT	qt_reg
				from	cot_compra_solic_agrup c
				where	c.nr_cot_compra = nr_cot_compra_p
				and		c.nr_item_cot_compra = nr_item_cot_compra_w
				and		(c.nr_solic_compra IS NOT NULL AND c.nr_solic_compra::text <> '')
				and		(c.nr_item_solic_compra IS NOT NULL AND c.nr_item_solic_compra::text <> '');
			
				if (qt_reg > 0) then
					select 	count(*)
					into STRICT	qt_reg
					from	cot_compra_solic_agrup c,
							solic_compra a,
							solic_compra_item b
					where	a.nr_solic_compra = b.nr_solic_compra
					and		c.nr_solic_compra = b.nr_solic_compra
					and		c.nr_item_solic_compra = b.nr_item_solic_compra
					and		c.nr_cot_compra = nr_cot_compra_p
					and		c.nr_item_cot_compra = nr_item_cot_compra_w
					and		coalesce(a.cd_motivo_baixa::text, '') = ''
					and		coalesce(b.cd_motivo_baixa::text, '') = '';
					
					if (qt_reg > 0) then
						ie_grava_item_ordem_compra := 'S';
						
						select 	count(*)
						into STRICT	qt_reg
						from	cot_compra_solic_agrup c,
								solic_compra a,
								solic_compra_item b
						where	a.nr_solic_compra = b.nr_solic_compra
						and		c.nr_solic_compra = b.nr_solic_compra
						and		c.nr_item_solic_compra = b.nr_item_solic_compra
						and		c.nr_cot_compra = nr_cot_compra_p
						and		c.nr_item_cot_compra = nr_item_cot_compra_w
						and (coalesce(a.dt_baixa::text, '') = ''
						and		coalesce(b.dt_baixa::text, '') = '');
						
						if (qt_reg > 0) then
							select 	sum(c.qt_material)
							into STRICT	qt_material_w
							from	cot_compra_solic_agrup c,
									solic_compra a,
									solic_compra_item b
							where	a.nr_solic_compra = b.nr_solic_compra
							and		c.nr_solic_compra = b.nr_solic_compra
							and		c.nr_item_solic_compra = b.nr_item_solic_compra
							and		c.nr_cot_compra = nr_cot_compra_p
							and		c.nr_item_cot_compra = nr_item_cot_compra_w
							and		coalesce(a.cd_motivo_baixa::text, '') = ''
							and		coalesce(b.cd_motivo_baixa::text, '') = '';
						end if;	
					end if;
				else
					ie_grava_item_ordem_compra := 'S';
				end if;
			else
				select	count(*)
				into STRICT	qt_reg
				from	solic_compra a,
						solic_compra_item b
				where	a.nr_solic_compra = b.nr_solic_compra
				and		b.nr_solic_compra = nr_solic_compra_ww
				and		b.nr_item_solic_compra = nr_item_solic_compra_w
				and		coalesce(a.cd_motivo_baixa::text, '') = ''
				and		coalesce(b.cd_motivo_baixa::text, '') = '';
				
				if (qt_reg > 0) then
					ie_grava_item_ordem_compra := 'S';
				end if;
			end if;
		
			if (ie_grava_item_ordem_compra = 'S') then
				CALL grava_item_ordem_compra(
					nr_ordem_compra_w,
					cd_material_w,
					cd_unidade_w,
					vl_unitario_w,
					qt_material_w,
					ds_observacao_w,
					ds_marca_w,
					ds_marca2_w,
					nm_usuario_p,
					ie_situacao_w,
					dt_entrega_ww,
					pr_desconto_w,
					nr_cot_compra_p,
					nr_item_cot_compra_w,
					nr_seq_fornecedor_w,
					qt_conv_unid_fornec_w,
					ie_ajusta_unid_fornec_w,
					dt_validade_w,
					ie_desfaz_agrupamento_w,
					coalesce(vl_desconto_w,0),
					nr_contrato_w,
					cd_centro_custo_w,
					ds_marca_fornec_w,
					cd_paciente_forn_item_w);

                qt_itens_gerados_w	:= coalesce(qt_itens_gerados_w,0) + 1;
			end if;

			open c05;
			loop
			fetch c05 into	
				ds_motivo_alt_forn_cot_w;
			EXIT WHEN NOT FOUND; /* apply on c05 */
				begin
				CALL gerar_ordem_compra_hist(nr_ordem_compra_w, null, ds_titulo_hist_cot_w, ds_motivo_alt_forn_cot_w, nm_usuario_p);
				end;
			end loop;
			close c05;

		end if;
	end if;

	if (coalesce(qt_itens_gerados_w,0) > 0) then
		update	cot_compra_forn
		set	ie_status = 'FH'
		where	nr_sequencia = nr_seq_cot_forn_p;
	end if;

	CALL gerar_ordem_compra_venc( nr_ordem_compra_w, nm_usuario_p);
	calcular_liquido_ordem_compra( nr_ordem_compra_w, nm_usuario_p);

	end loop;
	close c02;
	end;
end if;

open C03;
loop
fetch C03 into	
	nr_ordem_compra_w;
EXIT WHEN NOT FOUND; /* apply on C03 */
	begin

	select	coalesce(max(ie_gerado_bionexo),'N')
	into STRICT	ie_gerado_bionexo_w
	from	cot_compra_forn
	where	nr_cot_compra = nr_cot_compra_p;

	/*Se e de Bionexo, verifica o parametro especifico para Bionexo*/

	if (ie_gerado_bionexo_w in ('S','X')) and (ie_liberar_ordem_cotacao_w <> 'N') then
		CALL liberar_cotacao_oc_importada(nr_cot_compra_p, nr_ordem_compra_w, ie_liberar_ordem_cotacao_w, 'N', nm_usuario_p);
	end if;
	/*Se nao e de Bionexo, verifica o parametro especifico para geracao normal*/

	if (ie_gerado_bionexo_w = 'N') and (ie_liberar_ordem_calc_cot_w <> 'N') then
		CALL liberar_cotacao_oc_importada(nr_cot_compra_p, nr_ordem_compra_w, ie_liberar_ordem_calc_cot_w, 'N', nm_usuario_p);
	end if;

	select	coalesce(max(nr_solic_compra),0)
	into STRICT	nr_solic_compra_w
	from	ordem_compra_item
	where	nr_ordem_compra = nr_ordem_compra_w;

	if (nr_solic_compra_w > 0) then
	
		select	coalesce(max(nr_seq_motivo_solic),0)
		into STRICT	nr_seq_motivo_solic_w
		from	solic_compra
		where	nr_solic_compra = nr_solic_compra_w;
		
		if (nr_seq_motivo_solic_w > 0) then

			update	ordem_compra
			set	nr_seq_motivo_solic	= nr_seq_motivo_solic_w
			where	nr_ordem_compra		= nr_ordem_compra_w;
		end if;
	end if;

	end;
end loop;
close C03;

if (coalesce(qt_itens_gerados_w,0) = 0) and (nr_ordem_compra_w > 0) then
	delete from ordem_compra
	where	nr_ordem_compra = nr_ordem_compra_w;
end if;

open C04;
loop
fetch C04 into	
	nr_seq_cot_forn_w,
	cd_material_w,
	qt_material_w,
	vl_unitario_w,
	cd_unidade_w,
	nr_item_cot_compra_w,
	qt_conv_unid_fornec_w,
	dt_validade_w;
EXIT WHEN NOT FOUND; /* apply on C04 */
	begin
	
	select	max(dt_limite_entrega)
	into STRICT	dt_entrega_w
	from	cot_compra_item
	where	nr_cot_compra		= nr_cot_compra_p
	and	nr_item_cot_compra	= nr_item_cot_compra_w;
	
	if (nr_seq_cot_forn_w <> nr_seq_cot_forn_w2) then
		
		nr_seq_cot_forn_w2 := nr_seq_cot_forn_w;

		nr_ordem_compra_ww := grava_ordem_compra(
			nr_cot_compra_p, null, nr_seq_cot_forn_w, nm_usuario_p, nr_ordem_compra_ww);
	end if;

	if (ie_forma_calc_entrega_w = 'L') then
		dt_entrega_ww	:= dt_entrega_w + coalesce(obter_dados_cot_compra_forn(nr_cot_compra_p, nr_seq_cot_forn_w, 'DE'), 0);
	elsif (ie_forma_calc_entrega_w = 'F') then		
		dt_entrega_ww	:= dt_entrega_w;
	else	dt_entrega_ww	:= trunc(clock_timestamp(),'dd') + coalesce(obter_dados_cot_compra_forn(nr_cot_compra_p, nr_seq_cot_forn_w, 'DE'), 0);		
	end if;
	
	ie_grava_item_ordem_compra := 'N';
	
	select	coalesce(max(nr_solic_compra),0),
			coalesce(max(nr_item_solic_compra),0)
	into STRICT	nr_solic_compra_ww,
			nr_item_solic_compra_w
	from	cot_compra_item
	where	nr_cot_compra = nr_cot_compra_p
	and		nr_item_cot_compra = nr_item_cot_compra_w;
	
	if (nr_solic_compra_ww = 0) and (nr_item_solic_compra_w = 0) then
		select	count(*)
		into STRICT	qt_reg
		from	cot_compra_solic_agrup c
		where	c.nr_cot_compra = nr_cot_compra_p
		and		c.nr_item_cot_compra = nr_item_cot_compra_w
		and		(c.nr_solic_compra IS NOT NULL AND c.nr_solic_compra::text <> '')
		and		(c.nr_item_solic_compra IS NOT NULL AND c.nr_item_solic_compra::text <> '');
	
		if (qt_reg > 0) then
			select 	count(*)
			into STRICT	qt_reg
			from	cot_compra_solic_agrup c,
					solic_compra a,
					solic_compra_item b
			where	a.nr_solic_compra = b.nr_solic_compra
			and		c.nr_solic_compra = b.nr_solic_compra
			and		c.nr_item_solic_compra = b.nr_item_solic_compra
			and		c.nr_cot_compra = nr_cot_compra_p
			and		c.nr_item_cot_compra = nr_item_cot_compra_w
			and		coalesce(a.cd_motivo_baixa::text, '') = ''
			and		coalesce(b.cd_motivo_baixa::text, '') = '';
			
			if (qt_reg > 0) then
				ie_grava_item_ordem_compra := 'S';
				
				select 	count(*)
				into STRICT	qt_reg
				from	cot_compra_solic_agrup c,
						solic_compra a,
						solic_compra_item b
				where	a.nr_solic_compra = b.nr_solic_compra
				and		c.nr_solic_compra = b.nr_solic_compra
				and		c.nr_item_solic_compra = b.nr_item_solic_compra
				and		c.nr_cot_compra = nr_cot_compra_p
				and		c.nr_item_cot_compra = nr_item_cot_compra_w
				and (coalesce(a.dt_baixa::text, '') = ''
				and		coalesce(b.dt_baixa::text, '') = '');
				
				if (qt_reg > 0) then
					select 	sum(c.qt_material)
					into STRICT	qt_material_w
					from	cot_compra_solic_agrup c,
							solic_compra a,
							solic_compra_item b
					where	a.nr_solic_compra = b.nr_solic_compra
					and		c.nr_solic_compra = b.nr_solic_compra
					and		c.nr_item_solic_compra = b.nr_item_solic_compra
					and		c.nr_cot_compra = nr_cot_compra_p
					and		c.nr_item_cot_compra = nr_item_cot_compra_w
					and		coalesce(a.cd_motivo_baixa::text, '') = ''
					and		coalesce(b.cd_motivo_baixa::text, '') = '';
				end if;	
			end if;
		else
			ie_grava_item_ordem_compra := 'S';
		end if;
	else
		select	count(*)
		into STRICT	qt_reg
		from	solic_compra a,
				solic_compra_item b
		where	a.nr_solic_compra = b.nr_solic_compra
		and		b.nr_solic_compra = nr_solic_compra_ww
		and		b.nr_item_solic_compra = nr_item_solic_compra_w
		and		coalesce(a.cd_motivo_baixa::text, '') = ''
		and		coalesce(b.cd_motivo_baixa::text, '') = '';
		
		if (qt_reg > 0) then
			ie_grava_item_ordem_compra := 'S';
		end if;
	end if;
	
	if (ie_grava_item_ordem_compra = 'S') then
		
		CALL grava_item_ordem_compra(
			nr_ordem_compra_ww,
			cd_material_w,
			cd_unidade_w,
			vl_unitario_w,
			qt_material_w,
			null,
			null,
			null,
			nm_usuario_p,
			'A',
			dt_entrega_ww,
			0,
			nr_cot_compra_p,
			nr_item_cot_compra_w,
			nr_seq_cot_forn_w,
			qt_conv_unid_fornec_w,
			ie_ajusta_unid_fornec_w,
			dt_validade_w,
			ie_desfaz_agrupamento_w,
			0,
			null,
			null,
			0,
			null);
	end if;


	open c05;
	loop
	fetch c05 into	
		ds_motivo_alt_forn_cot_w;
	EXIT WHEN NOT FOUND; /* apply on c05 */
		begin
		CALL gerar_ordem_compra_hist(nr_ordem_compra_ww, null, ds_titulo_hist_cot_w, ds_motivo_alt_forn_cot_w, nm_usuario_p);
		end;
	end loop;
	close c05;

	update	ordem_compra
	set	nr_seq_tipo_compra 	= nr_seq_tipo_bonif_w
	where	nr_ordem_compra		= nr_ordem_compra_ww;
	
	end;
end loop;
close C04;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_ordem_compra ( nr_cot_compra_p bigint, nr_seq_cot_forn_p bigint, nm_usuario_p text, ie_desfaz_agrupamento_p text) FROM PUBLIC;

