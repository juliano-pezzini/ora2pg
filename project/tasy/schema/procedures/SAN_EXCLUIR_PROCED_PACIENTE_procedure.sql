-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE san_excluir_proced_paciente ( nr_seq_propaci_p bigint, nm_usuario_p text, ie_opcao_p text default 'N') AS $body$
DECLARE


/*
N - Normal - apenas um item de cada vez
T - Total
*/
					
nr_seq_propaci_real_w	bigint;
nr_seq_propaci_prod_w	bigint;
nr_seq_propaci_res_w	bigint;
qt_procedimento_w	bigint;


BEGIN

if (nr_seq_propaci_p	> 0) then

	select	max(nr_seq_propaci)
	into STRICT	nr_seq_propaci_real_w
	from	san_exame_realizado
	where	nr_seq_propaci	= nr_seq_propaci_p;

	select	max(nr_seq_propaci)
	into STRICT	nr_seq_propaci_prod_w
	from    san_producao
	where   nr_seq_propaci	= nr_seq_propaci_p;

	select	max(nr_seq_propaci)
	into STRICT	nr_seq_propaci_res_w
	from    san_reserva_prod
	where   nr_seq_propaci	= nr_seq_propaci_p;

	select	coalesce(max(qt_procedimento),0)
	into STRICT	qt_procedimento_w
	from	procedimento_paciente
	where	nr_sequencia	= nr_seq_propaci_p;

	if (qt_procedimento_w	> 1) and (ie_opcao_p = 'N') then
		update	procedimento_paciente
		set	qt_procedimento = qt_procedimento_w - 1
		where	nr_sequencia	= nr_seq_propaci_p;
		
	elsif (coalesce(nr_seq_propaci_real_w, 0) = 0) and (coalesce(nr_seq_propaci_prod_w, 0) = 0) and (coalesce(nr_seq_propaci_res_w, 0)  = 0) then
	
		update	san_exame_realizado
		set	nr_seq_propaci  = NULL
		where	nr_seq_propaci = nr_seq_propaci_p;

		update	san_producao
		set	nr_seq_propaci  = NULL
		where	nr_seq_propaci = nr_seq_propaci_p;

		update	san_reserva_prod
		set	nr_seq_propaci  = NULL
		where	nr_seq_propaci = nr_seq_propaci_p;
		
		update	san_reserva_item
		set	nr_seq_propaci  = NULL
		where	nr_seq_propaci = nr_seq_propaci_p;

		delete	from procedimento_paciente
		where	nr_sequencia = nr_seq_propaci_p;

	elsif (qt_procedimento_w	= 1) or (ie_opcao_p = 'T') then
		
		update	san_exame_realizado
		set	nr_seq_propaci  = NULL
		where	nr_seq_propaci = nr_seq_propaci_p;

		update	san_producao
		set	nr_seq_propaci  = NULL
		where	nr_seq_propaci = nr_seq_propaci_p;

		update	san_reserva_prod
		set	nr_seq_propaci  = NULL
		where	nr_seq_propaci = nr_seq_propaci_p;
		
		update	san_reserva_item
		set	nr_seq_propaci  = NULL
		where	nr_seq_propaci = nr_seq_propaci_p;

		delete	from procedimento_paciente
		where	nr_sequencia = nr_seq_propaci_p;
	end if;

	commit;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE san_excluir_proced_paciente ( nr_seq_propaci_p bigint, nm_usuario_p text, ie_opcao_p text default 'N') FROM PUBLIC;

