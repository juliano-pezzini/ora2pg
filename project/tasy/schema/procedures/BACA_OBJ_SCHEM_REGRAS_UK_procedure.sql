-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE baca_obj_schem_regras_uk () AS $body$
DECLARE


c00 CURSOR FOR
SELECT	cd_estabelecimento,
	nr_seq_obj_schem_param,
	count(*)
from	obj_schem_estab
group by cd_estabelecimento,
	nr_seq_obj_schem_param
having count(*) > 1;

c00_w	c00%rowtype;

c01 CURSOR FOR
SELECT	cd_perfil,
	nr_seq_obj_schem_param,
	count(*)
from	obj_schem_perfil
group by cd_perfil,
	nr_seq_obj_schem_param
having count(*) > 1;

c01_w	c01%rowtype;

c02 CURSOR FOR
SELECT	NM_USUARIO_PARAM,
	nr_seq_obj_schem_param,
	count(*)
from	obj_schem_usuario
group by NM_USUARIO_PARAM,
	nr_seq_obj_schem_param
having count(*) > 1;

c02_w	c02%rowtype;

qt_w	bigint;


BEGIN

--Adiciona a UK na tabela 'OBJ_SCHEM_ESTAB
select	count(*)
into STRICT	qt_w
from	user_constraints
where	table_name = 'OBJ_SCHEM_ESTAB'
and	CONSTRAINT_NAME = 'OBJSCET_UK';

if (qt_w = 0) then

	open C00;
	loop
	fetch C00 into
		c00_w;
	EXIT WHEN NOT FOUND; /* apply on C00 */
		begin

		delete	from obj_schem_estab a
		where	a.nr_sequencia =
			(SELECT	min(x.nr_sequencia)
			from	obj_schem_estab x
			where	x.nr_seq_obj_schem_param = c00_w.nr_seq_obj_schem_param);

		end;
	end loop;
	close C00;

	CALL Exec_sql_Dinamico('OBJSCET_UK',' Alter Table OBJ_SCHEM_ESTAB add ( Constraint OBJSCET_UK Unique (NR_SEQ_OBJ_SCHEM_PARAM,CD_ESTABELECIMENTO)) ');
end if;

--Adiciona a UK na tabela OBJ_SCHEM_PERFIL
select	count(*)
into STRICT	qt_w
from	user_constraints
where	table_name = 'OBJ_SCHEM_PERFIL'
and	CONSTRAINT_NAME = 'OBJSCPR_UK';

if (qt_w = 0) then

	open C01;
	loop
	fetch C01 into
		c01_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin

		delete	from obj_schem_perfil a
		where	a.nr_sequencia =
			(SELECT	min(x.nr_sequencia)
			from	obj_schem_perfil x
			where	x.nr_seq_obj_schem_param = c01_w.nr_seq_obj_schem_param);

		end;
	end loop;
	close C01;

	CALL Exec_sql_Dinamico('OBJSCPR_UK',' Alter Table OBJ_SCHEM_PERFIL add ( Constraint OBJSCPR_UK Unique (NR_SEQ_OBJ_SCHEM_PARAM,CD_PERFIL)) ');
end if;

--Adiciona a UK na tabela OBJ_SCHEM_USUARIO
select	count(*)
into STRICT	qt_w
from	user_constraints
where	table_name = 'OBJ_SCHEM_USUARIO'
and	CONSTRAINT_NAME = 'OBJSCUS_UK';

if (qt_w = 0) then

	open C02;
	loop
	fetch C02 into
		c02_w;
	EXIT WHEN NOT FOUND; /* apply on C02 */
		begin

		delete	from obj_schem_usuario a
		where	a.nr_sequencia =
			(SELECT	min(x.nr_sequencia)
			from	obj_schem_usuario x
			where	x.nr_seq_obj_schem_param = c02_w.nr_seq_obj_schem_param);

		end;
	end loop;
	close C02;

	CALL Exec_sql_Dinamico('OBJSCUS_UK',' Alter Table OBJ_SCHEM_USUARIO add ( Constraint OBJSCUS_UK Unique (NR_SEQ_OBJ_SCHEM_PARAM,NM_USUARIO_PARAM)) ');
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE baca_obj_schem_regras_uk () FROM PUBLIC;

