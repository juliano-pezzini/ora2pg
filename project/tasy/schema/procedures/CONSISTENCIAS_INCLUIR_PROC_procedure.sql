-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE consistencias_incluir_proc ( nr_seq_servico_p bigint, nr_atendimento_p bigint, NR_SEQ_ATEND_SERV_DIA_P bigint, nm_usuario_p text, nr_seq_proc_interno_w INOUT bigint, qt_acompanhantes_w INOUT bigint, ie_permite_servico_w INOUT text, ie_origem_proced_w INOUT bigint, cd_procedimento_w INOUT bigint ) AS $body$
DECLARE


QT_DIETA_ACOMP_W 	smallint;
nr_seq_servico_w 	bigint;

c_NR_SEQ_SERVICO CURSOR FOR
	SELECT 	NR_SEQ_SERVICO
	from 	NUT_REGRA_CONS_ACOMP_ITEM
	where 	NR_SEQ_REGRA_ACOMP = (	SELECT 	NR_SEQ_REGRA_ACOMP
					from (	select	  NR_SEQ_REGRA_ACOMP
						from	  ATEND_CATEGORIA_CONVENIO
						where 	  nr_atendimento = nr_atendimento_p
						order by  dt_inicio_vigencia desc) alias0 LIMIT 1);

BEGIN

ie_permite_servico_w := 'N';

select	coalesce(max(nr_seq_proc_interno),0)
into STRICT 	nr_seq_proc_interno_w
from 	nut_servico b
where 	nr_seq_servico_p = b.nr_sequencia
and 	(b.NR_SEQ_PROC_INTERNO IS NOT NULL AND b.NR_SEQ_PROC_INTERNO::text <> '');

select  count(*)
into STRICT 	qt_acompanhantes_w
from 	NUT_ATEND_ACOMPANHANTE
where 	NR_SEQ_ATEND_SERV_DIA = NR_SEQ_ATEND_SERV_DIA_P;


for	r_nr_seq_servico_w in c_NR_SEQ_SERVICO loop
	if (r_nr_seq_servico_w.nr_seq_servico = nr_seq_servico_p)then
		ie_permite_servico_w := 'S';
	end if;
end loop;

if (nr_seq_proc_interno_w <> 0) then
	select  ie_origem_proced,
		cd_procedimento
	into STRICT	ie_origem_proced_w,
		cd_procedimento_w
	from 	proc_interno
	where 	nr_sequencia = nr_seq_proc_interno_w;
end if;

if (ie_permite_servico_w = 'N' and nr_seq_proc_interno_w <> 0)then
	qt_acompanhantes_w := qt_acompanhantes_w;
else
select 	QT_DIETA_ACOMP
into STRICT 	QT_DIETA_ACOMP_W
from (	SELECT  QT_DIETA_ACOMP
	from 	ATEND_CATEGORIA_CONVENIO
	where 	nr_atendimento = nr_atendimento_p
	order by DT_INICIO_VIGENCIA desc) alias0 LIMIT 1;

	qt_acompanhantes_w := qt_acompanhantes_w - QT_DIETA_ACOMP_W;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE consistencias_incluir_proc ( nr_seq_servico_p bigint, nr_atendimento_p bigint, NR_SEQ_ATEND_SERV_DIA_P bigint, nm_usuario_p text, nr_seq_proc_interno_w INOUT bigint, qt_acompanhantes_w INOUT bigint, ie_permite_servico_w INOUT text, ie_origem_proced_w INOUT bigint, cd_procedimento_w INOUT bigint ) FROM PUBLIC;

