-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_ordenacao_contas_eis_w (ds_ordenacao_p text, nm_usuario_p text) AS $body$
DECLARE


nr_tabela_w	bigint := 0;
ds_ordenacao_w	varchar(2000);
qt_registro_w	bigint := 0;
nm_tabela_w	varchar(30);


BEGIN


select	count(1)
into STRICT	qt_registro_w
from	w_eis_conta_pendente
where	nm_usuario = nm_usuario_p;

if qt_registro_w > 0 then
	nm_tabela_w := 'w_eis_conta_pendente';
else
	nm_tabela_w := 'w_eis_conta_pend_rel_novo';
end if;



ds_ordenacao_w	:=	replace(upper(replace(upper(ds_ordenacao_p),upper('ds_setor_atendimento'),' substr(obter_nome_setor(cd_setor_atendimento),1,80)')),
				upper('ds_observacao'),' substr(obter_dados_conta_paciente(nr_interno_conta,'||chr(39)||'O'||chr(39)||'),1,255)');

CALL exec_sql_dinamico_bv('TASY','truncate table w_eis_conta_pendente_relat','');

CALL exec_sql_dinamico_bv('TASY',
'insert into w_eis_conta_pendente_relat (
	nr_seq_order,			ds_convenio,			ds_categoria,			nr_atendimento,			dt_entrada,
	dt_alta,			dt_periodo_inicial,		nm_pessoa_fisica,		nr_prontuario,			ds_procedimento,
	nr_interno_conta,		nm_usuario,			vl_conta,			vl_conta_sus,			nm_medico_exec,			
	ds_setor,			nr_doc_convenio,		ie_status_conta,		nm_usuario_conta,		cd_convenio,		
	ds_etapa,			cd_setor_atendimento,		ie_tipo_atendimento,		ds_tipo_atendimento,		cd_setor_destino,		
	ds_setor_destino,		ds_setor_etapa,			dt_ultima_etapa,		nm_ult_usuario_etapa,		nr_titulo_conta,
	nm_pessoa_etapa,		ds_setor_ult_int,		ds_motivo_devol_etapa,		cd_carteirinha,			cd_responsavel,			
	nr_seq_proc,			ds_cod_setores_conta,		dt_periodo_final, 		cd_guia,			cd_procedimento,		
	cd_senha,			cd_unidade_pac,			ds_agrup_setor_atend,		ds_agrup_ult_setor_int,		ds_classif_etapa,		
	ds_empresa_referencia,		ds_estabelecimento,		ds_estagio_conta,		ds_etapa_conta_obs,		ds_municipio,			
	ds_observacao,			ds_penultima_etapa,		ds_procedencia,			ds_recibo,			ds_setor_etapa_filtro,		
	ds_setor_inicial,		ds_setor_leito_pac,		ds_status_acerto,		ds_status_atend,		ds_tipo_atend_conta,		
	ds_tipo_atend_tiss,		ds_tipo_guia,			ds_tipo_guia_conta,		ds_ultima_etapa,		ds_ult_usuario_etapa,		
	ds_usuario_receb_etapa,		dt_conta_protocolo,		dt_fim_audit,			dt_inicio_audit,		dt_lib_audit,			
	dt_mesano_ref_prot,		dt_prev_protocolo,		dt_ultima_vig_internacao,	ie_pendencia_conta,		ie_situacao_laudo,		
	ie_ult_etapa_receb,		nm_usuario_atend,		nr_lote_contab_prot,		nr_maior_seq_etapa,		nr_seq_protocolo,		
	qt_dias_atraso,			qt_dias_sem_ajuste_audit,	qt_dias_sem_audit,		qt_dias_ult_etapa,		qt_dif_datas_alta_protocolo,
    dt_mesano_referencia)
select	rownum,				ds_convenio,			ds_categoria,			nr_atendimento,			dt_entrada,
	dt_alta,			dt_periodo_inicial,		nm_pessoa_fisica,		nr_prontuario,			ds_procedimento,
	nr_interno_conta,		nm_usuario,			vl_conta,			vl_conta_sus,			nm_medico_exec,			
	ds_setor,			nr_doc_convenio,		ie_status_conta,		nm_usuario_conta,		cd_convenio,		
	ds_etapa,			cd_setor_atendimento,		ie_tipo_atendimento,		ds_tipo_atendimento,		cd_setor_destino,
	ds_setor_destino,		ds_setor_etapa,			dt_ultima_etapa,		nm_ult_usuario_etapa,		nr_titulo_conta,
	nm_pessoa_etapa,		ds_setor_ult_int,		ds_motivo_devol_etapa,		cd_carteirinha,			cd_responsavel,		
	nr_seq_proc,			ds_cod_setores_conta, 		dt_periodo_final, 		cd_guia,			cd_procedimento, 	
	cd_senha, 			cd_unidade_pac, 		ds_agrup_setor_atend,		ds_agrup_ult_setor_int,		ds_classif_etapa,	
	ds_empresa_referencia, 		ds_estabelecimento, 		ds_estagio_conta,		ds_etapa_conta_obs,		ds_municipio, 		
	ds_observacao,			ds_penultima_etapa,		ds_procedencia,			ds_recibo, 			ds_setor_etapa_filtro, 	
	ds_setor_inicial, 		ds_setor_leito_pac, 		ds_status_acerto, 		ds_status_atend, 		ds_tipo_atend_conta, 	
	ds_tipo_atend_tiss, 		ds_tipo_guia,			ds_tipo_guia_conta, 		ds_ultima_etapa, 		ds_ult_usuario_etapa, 	
	ds_usuario_receb_etapa,		dt_conta_protocolo, 		dt_fim_audit,			dt_inicio_audit,		dt_lib_audit,		
	dt_mesano_ref_prot, 		dt_prev_protocolo,		dt_ultima_vig_internacao,	ie_pendencia_conta,		ie_situacao_laudo,	
	ie_ult_etapa_receb,		nm_usuario_atend,		nr_lote_contab_prot,		nr_maior_seq_etapa,		nr_seq_protocolo,	
	qt_dias_atraso,			qt_dias_sem_ajuste_audit,	qt_dias_sem_audit,		qt_dias_ult_etapa,		qt_dif_datas_alta_protocolo,
    dt_mesano_referencia
from	(select	substr(obter_nome_convenio(cd_convenio),1,40) ds_convenio, ' ||
		'substr(obter_categoria_convenio(cd_convenio,cd_categoria),1,80) ds_categoria, ' ||
		'nr_atendimento, ' ||
		'to_date(obter_dados_atendimento(nr_atendimento,'||chr(39)||'DE'||chr(39)||'),'|| chr(39) || 'dd/mm/yyyy hh24:mi:ss' || chr(39) ||') dt_entrada, ' ||
		'to_date(obter_dados_atendimento(nr_atendimento,'||chr(39)||'DA'||chr(39)||'),'||chr(39) || 'dd/mm/yyyy hh24:mi:ss' || chr(39) || ') dt_alta,' ||
		'to_date(obter_dados_conta_paciente(nr_interno_conta,'||chr(39)||'DPI'||chr(39)||'),'|| chr(39) || 'dd/mm/yyyy hh24:mi:ss' || chr(39) ||') dt_periodo_inicial, ' ||
		'substr(obter_nome_pf(cd_pessoa_fisica),1,60) nm_pessoa_fisica, ' ||
		'obter_prontuario_paciente(cd_pessoa_fisica) nr_prontuario, ' ||
		'substr(obter_descricao_procedimento(cd_procedimento,ie_origem_proced),1,240) ds_procedimento, ' ||
		'nr_interno_conta, ' ||
		'nm_usuario, ' ||
		'vl_conta, ' ||
		'vl_conta_sus, '||
		'substr(obter_nome_pf(cd_medico_exec),1,60) nm_medico_exec, ' ||
		'substr(obter_nome_setor(cd_setor_atendimento),1,100) ds_setor, ' ||
		'substr(obter_guia_convenio(nr_atendimento),1,30) nr_doc_convenio, ' ||
		'substr(obter_status_conta(nr_interno_conta,null),1,30) ie_status_conta, ' ||
		'nm_usuario_conta, ' ||
		'cd_convenio, ' ||
		'ds_etapa, ' ||
		'cd_setor_atendimento, ' ||
		'obter_tipo_atendimento(nr_atendimento) ie_tipo_atendimento, ' ||
		'substr(obter_valor_dominio(12,obter_tipo_atendimento(nr_atendimento)),1,80) ds_tipo_atendimento, ' ||
		'cd_setor_destino, ' ||
		'substr(obter_nome_setor(cd_setor_destino),1,100) ds_setor_destino, ' ||
		'substr(obter_nome_setor(cd_setor_etapa),1,100) ds_setor_etapa, '||
		'dt_ultima_etapa, '||
		'nm_ult_usuario_etapa, ' ||
		'substr(obter_titulo_conta(nr_interno_conta),1,255) nr_titulo_conta, '||
		'substr(obter_nome_pf(obter_eis_etapa_conta(nr_interno_conta,' || chr(39) || 'P' || chr(39) || ')),1,80) nm_pessoa_etapa, '||
		'substr(obter_nome_setor(Obter_Unidade_Atendimento(nr_atendimento,'|| chr(39) || 'IA' || chr(39) ||','|| chr(39) || 'CS' || chr(39) ||')),1,50) ds_setor_ult_int, '||
		'substr(obter_desc_motivo_devol(Obter_Eis_Etapa_Conta(nr_interno_conta,'|| chr(39) || 'M' || chr(39) ||')),1,80) ds_motivo_devol_etapa, '||
		'substr(obter_Dados_Categ_Conv(nr_atendimento,'|| chr(39) || 'U' || chr(39) ||'),1,100) cd_carteirinha, '||
		'substr(obter_dados_conta_paciente(nr_interno_conta,' || chr(39) || 'R' || chr(39) || '),1,10) cd_responsavel, ' ||
		'nr_seq_proc, ' ||
		'ds_cod_setores_conta, '||
		'to_date(obter_dados_conta_paciente(nr_interno_conta,'||chr(39)||'DPF'||chr(39)||'),'|| chr(39) || 'dd/mm/yyyy hh24:mi:ss' || chr(39) ||') dt_periodo_final, ' ||
		'cd_guia, ' ||
		'cd_procedimento, ' ||
		'substr(cd_senha_atend,1,100) cd_senha, ' ||
		'cd_unidade_pac, ' ||
		'substr(ds_agrup_setor,1,50) ds_agrup_setor_atend, ' ||
		'substr(ds_agrup_setor_atual,1,50) ds_agrup_ult_setor_int, ' ||
		'ds_classif_etapa, ' ||
		'ds_empresa_referencia, ' ||
		'substr(nm_estabelecimento,1,120) ds_estabelecimento, ' ||
		'substr(obter_estagio_conta_pac(nr_interno_conta,'|| chr(39) ||'D'|| chr(39) ||'),1,255) ds_estagio_conta, ' ||
		'ds_etapa_conta_obs, ' ||
		'ds_municipio, ' ||
		'substr(ds_obs_conta,1,255) ds_observacao, ' ||
		'ds_penultima_etapa, ' ||
		'substr(ds_proced_atend,1,40) ds_procedencia, ' ||
		'substr(obter_recibo_conta_protocolo(nr_interno_conta,nr_seq_protocolo),1,255) ds_recibo, ' ||
		'ds_setor_etapa_filtro, ' ||
		'substr(ds_setor_ini,1,255) ds_setor_inicial, ' ||
		'ds_setor_leito_pac, ' ||
		'substr(ds_status_conta,1,20) ds_status_acerto, ' ||
		'ds_status_atend, ' ||
		'substr(obter_valor_dominio(12,ie_tipo_atend_conta),1,100) ds_tipo_atend_conta, ' ||
		'ds_tipo_atend_tiss, ' ||
		'substr(ds_tipo_guia_atend,1,20) ds_tipo_guia, ' ||
		'substr(ds_tipo_guia_cta,1,20) ds_tipo_guia_conta, ' ||
		'ds_ultima_etapa, ' ||
		'ds_ult_usuario_etapa, ' ||
		'ds_usuario_receb_etapa, ' ||
		'dt_conta_protocolo, ' ||
		'dt_fim_audit, ' ||
		'dt_inicio_audit, ' ||
		'dt_lib_audit, ' ||
		'dt_mesano_ref_prot, ' ||
		'dt_prev_protocolo, ' ||
		'dt_ultima_vig_internacao, ' ||
		'substr(obter_se_pend_aberta_conta(nr_atendimento,nr_interno_conta),1,1) ie_pendencia_conta, ' ||
		'substr(eis_obter_se_conta_exige_laudo(nr_interno_conta),1,255) ie_situacao_laudo, ' ||
		'ie_ult_etapa_receb, ' ||
		'substr(nm_usuario_recep_atend,1,15) nm_usuario_atend, ' ||
		'nr_lote_contab_prot, ' ||
		'substr(obter_maior_etapa_conta(nr_interno_conta),1,255) nr_maior_seq_etapa, ' ||
		'nr_seq_protocolo, ' ||
		'substr(qt_dias_atraso_atend,1,100) qt_dias_atraso, ' ||
		'qt_dias_sem_ajuste_audit, ' ||
		'qt_dias_sem_audit, ' ||
		'obter_dias_ultima_etapa(nr_interno_conta) qt_dias_ult_etapa, ' ||
		'substr(qt_dif_datas_alta_prot,1,100) qt_dif_datas_alta_protocolo, ' ||
        'dt_mesano_referencia ' ||
	'from	' || nm_tabela_w ||
	' where	nm_usuario = ' || chr(39) || nm_usuario_p || chr(39) ||
	' order by ' || coalesce(ds_ordenacao_w,'nm_pessoa_fisica') || ')','');
	
commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_ordenacao_contas_eis_w (ds_ordenacao_p text, nm_usuario_p text) FROM PUBLIC;

