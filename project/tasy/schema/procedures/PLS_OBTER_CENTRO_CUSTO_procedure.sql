-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_obter_centro_custo ( ie_tipo_centro_custo_p text, nr_seq_plano_p bigint, cd_estabelecimento_p bigint, cd_municipio_ibge_p text, ie_tipo_contratacao_p text, ie_regulamentacao_p text, nr_seq_segurado_p bigint, ie_tipo_item_p text, cd_centro_custo_p INOUT bigint, nr_seq_regra_p INOUT bigint, nr_seq_tipo_lanc_p bigint default null, nr_seq_bonificacao_p bigint default null, nr_seq_sca_p bigint default null, nr_seq_prestador_pag_p bigint default null, nr_seq_prestador_exec_p bigint default null, nr_seq_prestador_atend_p bigint default null, nr_seq_prestador_solic_p bigint default null, nr_seq_evento_p bigint default null) AS $body$
DECLARE


cd_centro_custo_w		pls_regra_centro_custo.cd_centro_custo%type;
nr_sequencia_w			pls_regra_centro_custo.nr_sequencia%type;
ie_centro_custo_w		pls_regra_centro_custo.ie_centro_custo%type;
ie_tipo_vinculo_operadora_w	pls_segurado.ie_tipo_vinculo_operadora%type;
nr_seq_contrato_w		pls_segurado.nr_seq_contrato%type;
ie_tipo_segurado_w		pls_segurado.ie_tipo_segurado%type;
ie_status_prov_pagto_w		pls_parametro_contabil.ie_status_prov_pagto%type;

C01 CURSOR FOR
	SELECT	cd_centro_custo,
		ie_centro_custo,
		nr_sequencia
	from	pls_regra_centro_custo a
	where	a.ie_tipo_centro_custo		= ie_tipo_centro_custo_p
	and	a.cd_estabelecimento		= cd_estabelecimento_p
	and	a.ie_situacao			= 'A'	
	and	((a.nr_seq_plano 		= nr_seq_plano_p) or (coalesce(a.nr_seq_plano::text, '') = ''))
	and	((a.nr_seq_plano_sca 		= nr_seq_sca_p) or (coalesce(a.nr_seq_plano_sca::text, '') = ''))
	and	((a.cd_municipio_ibge		= cd_municipio_ibge_p) or (coalesce(a.cd_municipio_ibge::text, '') = ''))
	and	((a.ie_tipo_contratacao 	= ie_tipo_contratacao_p) or (coalesce(a.ie_tipo_contratacao::text, '') = ''))
	and	((a.ie_regulamentacao		= ie_regulamentacao_p) or (coalesce(a.ie_regulamentacao::text, '') = ''))
	and	((a.ie_tipo_vinculo_operadora 	= ie_tipo_vinculo_operadora_w) or (coalesce(a.ie_tipo_vinculo_operadora::text, '') = ''))
	and	((a.ie_tipo_item 		= ie_tipo_item_p) or (coalesce(a.ie_tipo_item::text, '') = ''))
	and	((a.nr_seq_tipo_lanc 		= nr_seq_tipo_lanc_p) or (coalesce(a.nr_seq_tipo_lanc::text, '') = ''))
	and	((a.nr_seq_bonificacao 		= nr_seq_bonificacao_p) or (coalesce(a.nr_seq_bonificacao::text, '') = ''))
	and	((a.ie_tipo_segurado		= ie_tipo_segurado_w) or (coalesce(a.ie_tipo_segurado::text, '') = ''))
	and	((a.nr_seq_contrato		= nr_seq_contrato_w) or (coalesce(a.nr_seq_contrato::text, '') = ''))
	and	((a.nr_seq_evento		= nr_seq_evento_p) or (coalesce(a.nr_seq_evento::text, '') = ''))
	and	exists	(	SELECT	1
				
				where	a.ie_prestador_codificacao 	= 'P'
				and	((a.nr_seq_prestador		= nr_seq_prestador_pag_p) 	or coalesce(a.nr_seq_prestador::text, '') = '')
				
union all

				select	1
				
				where	a.ie_prestador_codificacao	= 'E'
				and	((a.nr_seq_prestador		= nr_seq_prestador_exec_p) 	or coalesce(a.nr_seq_prestador::text, '') = '')
				
union all

				select	1
				
				where	a.ie_prestador_codificacao 	= 'A'
				and	((a.nr_seq_prestador		= nr_seq_prestador_atend_p) 	or coalesce(a.nr_seq_prestador::text, '') = '')
				
union all

				select	1
				
				where	a.ie_prestador_codificacao	= 'S'
				and	((a.nr_seq_prestador		= nr_seq_prestador_solic_p) 	or coalesce(a.nr_seq_prestador::text, '') = '')
				
union all

				select	1
				
				where	coalesce(a.ie_prestador_codificacao::text, '') = ''
				and	coalesce(a.nr_seq_prestador::text, '') = ''
				
union all

				select	1
				
				where	coalesce(a.ie_prestador_codificacao::text, '') = ''
				and	(a.nr_seq_prestador IS NOT NULL AND a.nr_seq_prestador::text <> '')
				and	((a.nr_seq_prestador		= nr_seq_prestador_pag_p AND ie_status_prov_pagto_w = 'F')
				or	(a.nr_seq_prestador		= nr_seq_prestador_exec_p AND ie_status_prov_pagto_w = 'NC')))
	order by	coalesce(a.nr_seq_plano_sca,0),
			coalesce(a.nr_seq_plano,0),
			coalesce(a.ie_tipo_vinculo_operadora,'X') desc,
			coalesce(a.cd_municipio_ibge,' '),
			coalesce(a.ie_tipo_contratacao,' '),
			coalesce(a.ie_regulamentacao,' '),
			coalesce(a.ie_tipo_item,' '),
			coalesce(a.nr_seq_tipo_lanc,0),
			coalesce(a.nr_seq_bonificacao,0),
			coalesce(a.ie_tipo_segurado, ' '),
			coalesce(a.nr_seq_contrato, 0),
			coalesce(a.nr_seq_evento, 0),
			coalesce(a.ie_prestador_codificacao, 'E'),
			coalesce(a.nr_seq_prestador,0);


BEGIN

begin
select	ie_tipo_vinculo_operadora,
	nr_seq_contrato,
	ie_tipo_segurado
into STRICT	ie_tipo_vinculo_operadora_w,
	nr_seq_contrato_w,
	ie_tipo_segurado_w
from	pls_segurado
where	nr_sequencia	= nr_seq_segurado_p;
exception
when others then
	ie_tipo_vinculo_operadora_w	:= null;
end;

begin
select	max(coalesce(ie_status_prov_pagto,'NC'))
into STRICT	ie_status_prov_pagto_w
from	pls_parametro_contabil
where	cd_estabelecimento = cd_estabelecimento_p;
exception when others then
	ie_status_prov_pagto_w := 'NC';
end;

open C01;
loop
fetch C01 into	
	cd_centro_custo_w,
	ie_centro_custo_w,
	nr_sequencia_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
end loop;
close C01;

if (coalesce(ie_centro_custo_w,'R') = 'B') then
	select	max(cd_centro_custo)
	into STRICT	cd_centro_custo_w
	from	pls_segurado_compl
	where	nr_seq_segurado	= nr_seq_segurado_p;
end if;

cd_centro_custo_p	:= cd_centro_custo_w;
nr_seq_regra_p		:= nr_sequencia_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_obter_centro_custo ( ie_tipo_centro_custo_p text, nr_seq_plano_p bigint, cd_estabelecimento_p bigint, cd_municipio_ibge_p text, ie_tipo_contratacao_p text, ie_regulamentacao_p text, nr_seq_segurado_p bigint, ie_tipo_item_p text, cd_centro_custo_p INOUT bigint, nr_seq_regra_p INOUT bigint, nr_seq_tipo_lanc_p bigint default null, nr_seq_bonificacao_p bigint default null, nr_seq_sca_p bigint default null, nr_seq_prestador_pag_p bigint default null, nr_seq_prestador_exec_p bigint default null, nr_seq_prestador_atend_p bigint default null, nr_seq_prestador_solic_p bigint default null, nr_seq_evento_p bigint default null) FROM PUBLIC;

