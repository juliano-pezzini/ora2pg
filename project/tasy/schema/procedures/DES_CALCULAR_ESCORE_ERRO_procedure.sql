-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE des_calcular_escore_erro ( dt_referencia_p timestamp, nm_usuario_p text, qt_pontos_p INOUT bigint, ds_historico_p INOUT text) AS $body$
DECLARE


qt_pontos_erro_w	double precision;
qt_erros_w		double precision;
dt_mes_inicial_w	timestamp;
dt_mes_final_w		timestamp;
qt_erro_esperado_w	double precision;


BEGIN

select	max(CASE WHEN 0=0 THEN a.qt_meta WHEN 0=1 THEN a.qt_meta_consol END )
into STRICT	qt_erro_esperado_w
from	bsc_ind_inf_v a
where	a.nr_seq_indicador	= 9
and	a.cd_ano 		= to_char(dt_referencia_p,'yyyy')
and (a.cd_estabelecimento = '0' or '0' = 0)
and (a.cd_empresa	= 1)
and	ds_periodo 		= to_char(dt_referencia_p,' mm/yyyy');

dt_mes_inicial_w                := trunc(dt_referencia_p, 'month');
dt_mes_final_w                  := Fim_Mes(trunc(dt_referencia_p, 'month'));
qt_pontos_erro_w				:= 0;

/* Pega o usuário TASY que é o da JOB */

if (trunc(dt_referencia_p,'month') = trunc(clock_timestamp(),'month')) then
	select	sum(qt_mes_corrente)
	into STRICT	qt_erros_w
	from	w_avaliacao_usuario
	where	nm_usuario 		= nm_usuario_p
	and	dt_referencia		= dt_referencia_p
	and	ie_referencia 		= 'PR'
	and	nm_usuario_cor 		= 'TASY';
else
	select	sum(coalesce(qt_mes_01,0) + coalesce(qt_mes_02,0) + coalesce(qt_mes_03,0) +
				coalesce(qt_mes_04,0) + coalesce(qt_mes_05,0) + coalesce(qt_mes_06,0) +
				coalesce(qt_mes_07,0) + coalesce(qt_mes_08,0) + coalesce(qt_mes_09,0) +
				coalesce(qt_mes_10,0) + coalesce(qt_mes_11,0) + coalesce(qt_mes_12,0))
	into STRICT	qt_erros_w
	from	w_avaliacao_usuario
	where	nm_usuario 		= nm_usuario_p
	and	dt_referencia		= dt_referencia_p
	and	ie_referencia 		= 'PR'
	and	nm_usuario_cor 		= 'TASY';
end if;

if ( qt_erros_w > qt_erro_esperado_w ) then
		qt_pontos_erro_w	:= 30;
end if;

qt_pontos_p		:= qt_pontos_erro_w;

ds_historico_p	:= 	'Escore de erros ' || chr(13) || chr(10) ||
					'		% Erros no mês: ' || coalesce(qt_erros_w,0) || '%' || chr(13) || chr(10) ||
					'		Esperado: ' || ' <= ' || qt_erro_esperado_w || ' %'|| chr(13) || chr(10) ||
					'		Perde: ' || qt_pontos_erro_w || ' pontos' || chr(13) || chr(13);

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE des_calcular_escore_erro ( dt_referencia_p timestamp, nm_usuario_p text, qt_pontos_p INOUT bigint, ds_historico_p INOUT text) FROM PUBLIC;

