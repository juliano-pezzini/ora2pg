-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE enviar_sms_aniv ( ds_remetente_p text, ds_mensagem_p text, nm_usuario_p text) AS $body$
DECLARE


id_sms_w			bigint;
dt_nascimento_w     	timestamp;
nr_telefone_celular_w	varchar(20);
nr_ddd_celular_w	               varchar(3);
nr_telefone_ddd_w varchar(255) := ''; -- Adicionado essa variavel pra salvar o log do DDD e do Telefone
c01 CURSOR FOR
SELECT 	a.nr_ddd_celular,
	a.nr_telefone_celular
from 	Pessoa_Fisica a
where	(a.dt_nascimento IS NOT NULL AND a.dt_nascimento::text <> '')
and 	(a.nr_telefone_celular IS NOT NULL AND a.nr_telefone_celular::text <> '')
and	to_char(a.dt_nascimento,'dd/mm') = to_char(clock_timestamp(),'dd/mm');



BEGIN

if (ds_remetente_p IS NOT NULL AND ds_remetente_p::text <> '') and (ds_mensagem_p IS NOT NULL AND ds_mensagem_p::text <> '')  then

	open c01;
	loop
	fetch c01 into
		nr_ddd_celular_w,
		nr_telefone_celular_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */

		begin

		nr_telefone_ddd_w	:= nr_ddd_celular_w||nr_telefone_celular_w;
		id_sms_w := wheb_sms.enviar_sms(ds_remetente_p, nr_telefone_ddd_w, ds_mensagem_p, nm_usuario_p, id_sms_w);

			insert into LOG_ENVIO_SMS(nr_sequencia,
				dt_atualizacao,
				dt_atualizacao_nrec,
				nm_usuario,
				dt_envio,
				nr_telefone,
				ds_mensagem,
				id_sms)
			values (nextval('log_envio_sms_seq'),
				clock_timestamp(),
				clock_timestamp(),
				nm_usuario_p,
				clock_timestamp(),
				nr_telefone_ddd_w,
				ds_mensagem_p,
				id_sms_w);

			exception
			when others then
			null;
		end;

	end loop;
	close c01;

end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE enviar_sms_aniv ( ds_remetente_p text, ds_mensagem_p text, nm_usuario_p text) FROM PUBLIC;

