-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE com_importar_modulo_funcoes ( nr_seq_cliente_p bigint, nr_seq_modulo_p bigint, cd_funcao_p bigint, ie_utiliza_p text, nm_usuario_p text, ie_commit_p text default 'N') AS $body$
DECLARE



nr_seq_funcao_w		com_cliente_fun_impl.nr_sequencia%type;
nr_seq_mod_impl_w	com_cliente_mod_impl.nr_sequencia%type;


BEGIN
	if (ie_commit_p = 'N') then
		if (nr_seq_cliente_p IS NOT NULL AND nr_seq_cliente_p::text <> '')	then
		
			select	max(nr_sequencia)
			into STRICT	nr_seq_mod_impl_w
			from	com_cliente_mod_impl ccmi
			where	trunc(ccmi.dt_importacao)	= trunc(clock_timestamp())
			and	ccmi.nr_seq_cliente		= nr_seq_cliente_p
			and	ccmi.nr_seq_modulo		= nr_seq_modulo_p;

			if (coalesce(nr_seq_mod_impl_w::text, '') = '') then

				select	nextval('com_cliente_mod_impl_seq')
				into STRICT	nr_seq_mod_impl_w
				;

				insert into com_cliente_mod_impl(
					nr_sequencia,
					dt_atualizacao,
					nm_usuario,
					nr_seq_cliente,
					nr_seq_modulo,
					pr_utilizacao,
					dt_importacao,
					nm_usuario_nrec,
					dt_atualizacao_nrec)
				values (
					nr_seq_mod_impl_w,
					clock_timestamp(),
					nm_usuario_p,
					nr_seq_cliente_p,
					nr_seq_modulo_p,
					0,
					clock_timestamp(),
					nm_usuario_p,
					clock_timestamp()
				);
			end if;
			
			if (nr_seq_mod_impl_w IS NOT NULL AND nr_seq_mod_impl_w::text <> '' AND cd_funcao_p IS NOT NULL AND cd_funcao_p::text <> '') then
				begin
					select	max(nr_sequencia)
					into STRICT	nr_seq_funcao_w
					from	com_cliente_fun_impl ccfi
					where	ccfi.nr_seq_mod_impl	= nr_seq_mod_impl_w
					and	ccfi.cd_funcao		= cd_funcao_p;
				
					if (coalesce(nr_seq_funcao_w::text, '') = '') then
						begin
				
							insert into com_cliente_fun_impl(
								nr_sequencia,
								nr_seq_mod_impl,
								dt_atualizacao,
								nm_usuario,
								dt_atualizacao_nrec,
								nm_usuario_nrec,
								cd_funcao,
								dt_inicio_util,
								ie_utilizacao
							) values (
								nextval('com_cliente_fun_impl_seq'),
								nr_seq_mod_impl_w,
								clock_timestamp(),
								nm_usuario_p,
								clock_timestamp(),
								nm_usuario_p,
								cd_funcao_p,
								clock_timestamp(),
								ie_utiliza_p
							);
						end;
					end if;
				end;
			end if;
		end if;
	else
		begin
			commit;
		end;
	end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE com_importar_modulo_funcoes ( nr_seq_cliente_p bigint, nr_seq_modulo_p bigint, cd_funcao_p bigint, ie_utiliza_p text, nm_usuario_p text, ie_commit_p text default 'N') FROM PUBLIC;

