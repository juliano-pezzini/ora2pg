-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE man_enviar_hist_email_os ( qt_dias_p bigint, ds_email_origem_p text, ie_origem_p text, nr_seq_tipo_p text, nm_usuario_p text) AS $body$
DECLARE



ds_dano_breve_w		varchar(255);
ds_dano_w		varchar(4000);
ds_relat_tecnico_w		varchar(32000);
nr_ordem_servico_w	bigint;
nr_sequencia_w		bigint;
nr_seq_rtf_string_w		bigint;
dt_historico_w		timestamp;
ds_email_w		varchar(255);
ds_email_destino_w		varchar(4000);
ds_mensagem_w		varchar(32000);
ds_titulo_email_w	varchar(255);

c01 CURSOR FOR
SELECT	a.ds_dano_breve,
	a.nr_sequencia,
	b.dt_historico,
	b.nr_sequencia
from	man_ordem_serv_tecnico b,
	man_ordem_servico a
where	a.nr_sequencia = b.nr_seq_ordem_serv
and	coalesce(b.dt_envio::text, '') = ''
and	obter_dias_entre_datas(b.dt_historico, clock_timestamp()) <= qt_dias_p
and	((b.ie_origem = ie_origem_p) or (ie_origem_p = 'T'))
and	((b.nr_seq_tipo = nr_seq_tipo_p) or (nr_seq_tipo_p = 0));

c02 CURSOR FOR
SELECT	distinct
	a.ds_email
from	usuario a,
	man_ordem_servico_exec b
where	a.nm_usuario 	= b.nm_usuario_exec
and	b.nr_seq_ordem	= nr_ordem_servico_w
and	substr(obter_se_email_valido(a.ds_email),1,1) = 'S'
and	(a.ds_email IS NOT NULL AND a.ds_email::text <> '');


BEGIN
open C01;
loop
fetch C01 into
	ds_dano_breve_w,
	nr_ordem_servico_w,
	dt_historico_w,
	nr_sequencia_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	ds_email_destino_w 	:= '';

	begin
	nr_seq_rtf_string_w := converte_rtf_string('	select ds_relat_tecnico from man_ordem_serv_tecnico where nr_sequencia = :nr_sequencia_p', nr_sequencia_w, nm_usuario_p, nr_seq_rtf_string_w);

	select	ds_texto
	into STRICT	ds_relat_tecnico_w
	from	tasy_conversao_rtf
	where	nr_sequencia = nr_seq_rtf_string_w;
	exception
	when others then
		ds_relat_tecnico_w	:= '';
	end;
	ds_mensagem_w		:= substr(substr(wheb_mensagem_pck.get_texto(305690),1,20) || ': ' || ds_dano_breve_w || chr(13) || chr(10) ||
					substr(wheb_mensagem_pck.get_texto(305693),1,40) || ': ' || to_char(dt_historico_w,'dd/mm/yyyy hh24:mi:ss') || chr(13) || chr(10) ||
					ds_relat_tecnico_w,1,32000);
	open C02;
	loop
	fetch C02 into
		ds_email_w;
	EXIT WHEN NOT FOUND; /* apply on C02 */
		begin
		ds_email_destino_w	:= ds_email_destino_w || ds_email_w || ';';
		end;
	end loop;
	close C02;

	ds_titulo_email_w	:= substr(wheb_mensagem_pck.get_texto(305695,'NR_ORDEM=' || nr_ordem_servico_w),1,255);

	CALL enviar_email(	ds_titulo_email_w,
			ds_mensagem_w,
			ds_email_origem_p,
			ds_email_destino_w,
			nm_usuario_p,
			'M');

	update	man_ordem_serv_tecnico
	set	dt_envio 		= clock_timestamp()
	where	nr_sequencia 	= nr_sequencia_w;
	end;
end loop;
close C01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE man_enviar_hist_email_os ( qt_dias_p bigint, ds_email_origem_p text, ie_origem_p text, nr_seq_tipo_p text, nm_usuario_p text) FROM PUBLIC;

