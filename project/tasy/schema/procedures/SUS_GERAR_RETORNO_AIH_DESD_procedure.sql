-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE sus_gerar_retorno_aih_desd ( nr_seq_protocolo_p bigint, nm_usuario_p text, ds_erro_p INOUT text, nr_seq_retorno_p INOUT text) AS $body$
DECLARE

 
ds_erro_w		varchar(255);
nr_seq_retorno_w		bigint;
cd_convenio_w		integer;
cd_estabelecimento_w	smallint;
nr_seq_retorno_item_w	bigint;
ie_retorno_w		smallint;
nr_aih_w			bigint;
nr_seq_aih_w		bigint;
nr_processo_w		bigint;
vl_aih_w			double precision;
nr_interno_conta_w		bigint;
nr_titulo_w		bigint;
nr_retorno_w		varchar(255);
nr_processo_ant_w		bigint;
vl_titulo_w		double precision;

C01 CURSOR FOR 
SELECT	1, 
	a.nr_aih, 
	a.nr_seq_aih, 
	a.nr_processo, 
	(a.vl_sh + a.vl_sp + a.vl_sadt + a.vl_sangue + a.vl_opm + 
	a.vl_rnato + a.vl_s_rateio + a.vl_analg + a.vl_pedcon), 
	c.nr_interno_conta 
from	conta_paciente c, 
	sus_aih b, 
	sus_aih_paga a 
where	a.nr_seq_protocolo	= nr_seq_protocolo_p 
and	a.nr_aih		= b.nr_aih 
and	a.nr_seq_aih	= b.nr_sequencia 
and	b.nr_interno_conta	= c.nr_interno_conta 

union
 
SELECT	2, 
	a.nr_aih, 
	a.nr_seq_aih, 
	a.nr_processo, 
	c.vl_conta, 
	c.nr_interno_conta 
from	conta_paciente c, 
	sus_aih b, 
	sus_aih_processo d, 
	sus_aih_rejeitada a 
where	a.nr_seq_protocolo	= nr_seq_protocolo_p 
and	a.nr_processo	= d.nr_processo 
and	d.ie_classificacao	<> 2 
and	a.nr_aih		= b.nr_aih 
and	a.nr_seq_aih	= b.nr_sequencia 
and	b.nr_interno_conta	= c.nr_interno_conta 
and	not exists (	select 1 from sus_aih_paga x 
		where	x.nr_seq_protocolo	= a.nr_seq_protocolo 
		and	x.nr_aih		= a.nr_aih 
		and	x.nr_seq_aih	= a.nr_seq_aih) 
order by  4,1,2,3;
	
 
 

BEGIN 
 
ds_erro_w	:= wheb_mensagem_pck.get_texto(279919);
nr_retorno_w	:= '';
 
/* Selecionar dados do protocolo */
 
select 	coalesce(max(cd_convenio),0), 
	coalesce(max(cd_estabelecimento),0) 
into STRICT	cd_convenio_w, 
	cd_estabelecimento_w 
from	protocolo_convenio 
where	nr_seq_protocolo	= nr_seq_protocolo_p;
 
nr_processo_ant_w	:= 0;
OPEN C01;
LOOP 
FETCH C01 into 
	ie_retorno_w, 
	nr_aih_w, 
	nr_seq_aih_w, 
	nr_processo_w, 
	vl_aih_w, 
	nr_interno_conta_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	BEGIN 
	/* Gravar convenio retorno */
 
	if (nr_processo_w	<> nr_processo_ant_w) then 
		begin 
		nr_processo_ant_w	:= nr_processo_w;
		 
		select	nextval('convenio_retorno_seq') 
		into STRICT	nr_seq_retorno_w 
		;
 
		nr_retorno_w := nr_retorno_w ||to_char(nr_seq_retorno_w)||' ';
 
		select	coalesce(max(nr_titulo),0), 
			coalesce(max(vl_titulo),0) 
		into STRICT	nr_titulo_w, 
			vl_titulo_w 
		from	titulo_receber 
		where	nr_seq_protocolo	= nr_seq_protocolo_p 
		and	nr_processo_aih	= nr_processo_w;
 
		insert into convenio_retorno( 
			NR_SEQUENCIA ,CD_CONVENIO,DT_RETORNO,IE_STATUS_RETORNO,DT_ATUALIZACAO, 
			NM_USUARIO,NM_USUARIO_RETORNO,DS_LOTE_CONVENIO,DT_INICIAL,DT_FINAL, 
			DT_FECHAMENTO,NM_USUARIO_FECHAMENTO,DS_OBSERVACAO,NR_SEQ_PROTOCOLO, 
			DT_REF_PRECO,DT_BAIXA_CR,CD_ESTABELECIMENTO,NR_SEQ_PROT_ADIC, 
			DT_RECEBIMENTO,DT_CONSISTENCIA,DT_VINCULACAO) 
		values (nr_seq_retorno_w,cd_convenio_w,clock_timestamp(),'C',clock_timestamp(), 
			nm_usuario_p,nm_usuario_p,wheb_mensagem_pck.get_texto(299953, 'NR_SEQ_PROTOCOLO=' || to_char(nr_seq_protocolo_p)),null,	null, 
			null,null,null,nr_seq_protocolo_p, 
			null,null,cd_estabelecimento_w,null, 
			null,clock_timestamp(),null);
		end;
	end if;
 
	/* Gravar convenio retorno item */
 
	select	nextval('convenio_retorno_item_seq') 
	into STRICT	nr_seq_retorno_item_w 
	;
 
	insert	into convenio_retorno_item( 
		NR_SEQUENCIA,NR_SEQ_RETORNO,VL_PAGO,VL_GLOSADO,DT_ATUALIZACAO, 
		NM_USUARIO,IE_GLOSA,NR_INTERNO_CONTA,CD_AUTORIZACAO,DS_OBSERVACAO, 
		VL_ADICIONAL,NR_TITULO,	VL_AMENOR,VL_ADEQUADO,CD_MOTIVO_GLOSA, 
		IE_LIBERA_REPASSE,IE_ANALISADA) 
	values (nr_seq_retorno_item_w,nr_seq_retorno_w,CASE WHEN ie_retorno_w=1 THEN vl_aih_w  ELSE 0 END ,CASE WHEN ie_retorno_w=1 THEN 0  ELSE vl_aih_w END ,clock_timestamp(), 
		nm_usuario_p,CASE WHEN ie_retorno_w=1 THEN 'N'  ELSE 'S' END ,nr_interno_conta_w,to_char(nr_aih_w),null, 
		0,nr_titulo_w,0,0,null, 
		CASE WHEN ie_retorno_w=1 THEN 'S'  ELSE 'N' END ,'N');
	END;
END LOOP;
CLOSE C01;
 
commit;
 
ds_erro_p		:= ds_erro_w;
nr_seq_retorno_p	:= nr_retorno_w;
 
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE sus_gerar_retorno_aih_desd ( nr_seq_protocolo_p bigint, nm_usuario_p text, ds_erro_p INOUT text, nr_seq_retorno_p INOUT text) FROM PUBLIC;

