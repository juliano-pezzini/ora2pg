-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE baixar_item_oc_dif_nf ( nr_ordem_compra_p bigint, nr_item_oci_p bigint, dt_prev_entrega_p timestamp, nm_usuario_p text) AS $body$
DECLARE

 
nm_pessoa_usuario_w		varchar(60);
qt_existe_w			bigint;

BEGIN
 
select	count(*) 
into STRICT	qt_existe_w 
from	ordem_compra_item_entrega 
where	nr_item_oci			= nr_item_oci_p 
and	trunc(dt_prevista_entrega,'dd')		= trunc(dt_prev_entrega_p,'dd');
 
if (qt_existe_w > 0) then 
	begin 
 
	update	ordem_compra_item_entrega 
	set	dt_baixa 			= clock_timestamp(), 
		nm_usuario		= nm_usuario_p 
	where	nr_item_oci		= nr_item_oci_p 
	and	trunc(dt_prevista_entrega,'dd')	= trunc(dt_prev_entrega_p,'dd');
 
	select	substr(obter_pessoa_fisica_usuario(nm_usuario_p,'N'),1,60) 
	into STRICT	nm_pessoa_usuario_w 
	;
 
	CALL inserir_historico_ordem_compra( 
		nr_ordem_compra_p, 
		'S', 
		wheb_mensagem_pck.get_texto(298020), 
		/*O item #@NR_ITEM_OCI#@ foi baixado pelo usuário #@NM_PESSOA#@ com diferença de quantidades entre a ordem de compra e a nota fiscal.*/
 
		wheb_mensagem_pck.get_texto(298024, 'NR_ITEM_OCI=' || nr_item_oci_p || ';NM_PESSOA=' || nm_pessoa_usuario_w), 
		nm_usuario_p);	
		 
 
	select	count(*) 
	into STRICT	qt_existe_w 
 	from	ordem_compra_item_entrega a 
	where	nr_ordem_compra	= nr_ordem_compra_p 
	and	((coalesce(qt_prevista_entrega,0) > coalesce(qt_real_entrega,0)) and coalesce(dt_baixa::text, '') = '');
 
	if (qt_existe_w = 0) then 
		begin 
		update	ordem_compra 
		set	dt_baixa 		= clock_timestamp() 
		where 	nr_ordem_compra 	= nr_ordem_compra_p;
		end;
	end if;			
 
	commit;
	end;
end if;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE baixar_item_oc_dif_nf ( nr_ordem_compra_p bigint, nr_item_oci_p bigint, dt_prev_entrega_p timestamp, nm_usuario_p text) FROM PUBLIC;

