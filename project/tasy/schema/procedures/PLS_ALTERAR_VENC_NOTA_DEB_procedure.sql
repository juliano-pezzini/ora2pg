-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_alterar_venc_nota_deb ( nr_seq_nota_deb_concl_p ptu_nota_deb_conclusao.nr_sequencia%type, dt_vencimento_p timestamp, nm_usuario_p usuario.nm_usuario%type) AS $body$
DECLARE


nr_titulo_w			titulo_receber.nr_titulo%type;
vl_saldo_titulo_w		titulo_receber.vl_saldo_titulo%type;
cd_motivo_w			alteracao_vencimento.cd_motivo%type;
dt_pagamento_previsto_w		titulo_receber.dt_pagamento_previsto%type;


BEGIN

update	ptu_nota_deb_conclusao
set	dt_ven_nota			= dt_vencimento_p
where	nr_sequencia			= nr_seq_nota_deb_concl_p;

update	ptu_nota_deb_dados
set	dt_ven_ndc			= dt_vencimento_p
where	nr_seq_nota_deb_conclusao	= nr_seq_nota_deb_concl_p;

select	max(nr_titulo),
	max(dt_pagamento_previsto),
	max(vl_saldo_titulo)
into STRICT	nr_titulo_w,
	dt_pagamento_previsto_w,
	vl_saldo_titulo_w
from	titulo_receber
where	nr_seq_nota_deb_conclusao 	= nr_seq_nota_deb_concl_p;

if (nr_titulo_w IS NOT NULL AND nr_titulo_w::text <> '') then

	if (vl_saldo_titulo_w = 0) then
		CALL wheb_mensagem_pck.exibir_mensagem_abort(313270); -- O título desta NDC está com o saldo zerado!
								-- Não é possível efetuar a alteração de vencimento.
	end if;
	/*
	1	- Prorrogação de Vencimento
	2	- Antecipação de Vencimento
	*/
	cd_motivo_w		:= 1;
	if (dt_vencimento_p	< dt_pagamento_previsto_w) then
		cd_motivo_w	:= 2;
	end if;

	CALL alterar_vencimento_tit_rec(	nr_titulo_w,
					dt_vencimento_p,
					cd_motivo_w,
					'Alteração de vencimento efetuada através da nota de débito.',
					nm_usuario_p);

end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_alterar_venc_nota_deb ( nr_seq_nota_deb_concl_p ptu_nota_deb_conclusao.nr_sequencia%type, dt_vencimento_p timestamp, nm_usuario_p usuario.nm_usuario%type) FROM PUBLIC;

