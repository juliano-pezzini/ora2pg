-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_d301_arquivo_conteudo (nr_seq_arquivo_p bigint, nm_usuario_p text) AS $body$
DECLARE


ds_conteudo_unb_w	varchar(255);
ds_conteudo_unz_w	varchar(255);
ds_dataset_conteudo_w	text	:= '';
ds_conteudo_w		text	:= EMPTY_CLOB;

--cursor do conteudo clob dos dataset do arquivo
c_conteudo_dataset CURSOR(nr_seq_arquio_pc	bigint) FOR
SELECT	a.ds_conteudo
from	d301_dataset_conteudo a,
	d301_dataset_envio b
where	a.nr_seq_dataset	= b.nr_sequencia
and	b.nr_seq_arquivo	= nr_seq_arquio_pc
order by b.nr_atendimento, b.nr_ordem;

BEGIN

select	'UNB+'||
	ie_sintaxe||':'||
	nr_versao_sintaxe||'+'||
	ds_remetente||'+'||
	ds_destinatario||'+'||
	ds_dt_criacao||':'||
	ds_hr_criacao||'+'||
	nr_ref_arquivo_env||'+'||
	nr_ref_arquivo_ret||'+'||
	nr_referencia_aplic||chr(39)
into STRICT	ds_conteudo_unb_w
from	d301_segmento_unb
where	nr_seq_arquivo	= nr_seq_arquivo_p;

select	concat(ds_conteudo_unb_w||chr(13)||chr(10),ds_conteudo_w)
into STRICT	ds_conteudo_w
;

for r_c_conteudo_dataset in c_conteudo_dataset(nr_seq_arquivo_p) loop

	select	concat(ds_conteudo_w, concat(r_c_conteudo_dataset.ds_conteudo,chr(13)||chr(10)))
	into STRICT	ds_conteudo_w
	;

end loop;

select	'UNZ+'||
	lpad(qt_dataset,5,'0')||'+'||
	nr_ref_arquivo||chr(39)
into STRICT	ds_conteudo_unz_w
from	d301_segmento_unz
where	nr_seq_arquivo	= nr_seq_arquivo_p;

select	concat(ds_conteudo_w,ds_conteudo_unz_w)
into STRICT	ds_conteudo_w
;

insert into d301_arquivo_conteudo(nr_sequencia,
	dt_atualizacao,
	nm_usuario,
	dt_atualizacao_nrec,
	nm_usuario_nrec,
	nr_seq_arquivo_envio,
	nr_seq_arquivo_retorno,
	ds_conteudo)
values (nextval('d301_arquivo_conteudo_seq'),
	clock_timestamp(),
	nm_usuario_p,
	clock_timestamp(),
	nm_usuario_p,
	nr_seq_arquivo_p,
	null,
	ds_conteudo_w);

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_d301_arquivo_conteudo (nr_seq_arquivo_p bigint, nm_usuario_p text) FROM PUBLIC;

