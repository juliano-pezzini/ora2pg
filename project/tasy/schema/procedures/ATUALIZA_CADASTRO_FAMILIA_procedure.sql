-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE atualiza_cadastro_familia ( CD_PESSOA_FISICA_P text DEFAULT NULL, CD_PESSOA_FAMILIA_P text DEFAULT NULL, NR_SEQ_GRAU_PARENTESCO_P text DEFAULT NULL, CD_DOMICILIO_P text DEFAULT NULL, ACTION_P text DEFAULT 'OUTRA') AS $body$
DECLARE

 
NM_USUARIO_ATIVO_W USUARIO.NM_USUARIO%TYPE;
QT_EXISTE   bigint;
  REG RECORD;

BEGIN
  NM_USUARIO_ATIVO_W := WHEB_USUARIO_PCK.GET_NM_USUARIO;
  
IF ACTION_P = 'OUTRA' THEN 
 
 IF ((CD_PESSOA_FISICA_P IS NOT NULL AND CD_PESSOA_FISICA_P::text <> '') AND CD_PESSOA_FISICA_P > 0 
   AND (CD_PESSOA_FAMILIA_P IS NOT NULL AND CD_PESSOA_FAMILIA_P::text <> '') AND CD_PESSOA_FAMILIA_P > 0 ) THEN 
 
    SELECT COUNT(1) INTO STRICT QT_EXISTE FROM PF_FAMILIA WHERE CD_PESSOA_FAMILIA = CD_PESSOA_FISICA AND CD_PESSOA_FISICA = CD_PESSOA_FISICA_P;
   
   IF QT_EXISTE < 1 THEN 
     INSERT INTO PF_FAMILIA(NR_SEQUENCIA, DT_ATUALIZACAO, NM_USUARIO, DT_ATUALIZACAO_NREC, 
                           NM_USUARIO_NREC, CD_PESSOA_FISICA, CD_PESSOA_FAMILIA, NR_SEQ_GRAU_PARENTESCO, IE_HABITACAO) 
                      VALUES (nextval('pf_familia_seq'), clock_timestamp(), NM_USUARIO_ATIVO_W, clock_timestamp(),NM_USUARIO_ATIVO_W, CD_PESSOA_FISICA_P, CD_PESSOA_FISICA_P, '1', 'S');
   END IF;
     INSERT INTO PF_FAMILIA(NR_SEQUENCIA, DT_ATUALIZACAO, NM_USUARIO, DT_ATUALIZACAO_NREC, 
                         NM_USUARIO_NREC, CD_PESSOA_FISICA, CD_PESSOA_FAMILIA, NR_SEQ_GRAU_PARENTESCO, IE_HABITACAO) 
                      VALUES (nextval('pf_familia_seq'), clock_timestamp(), NM_USUARIO_ATIVO_W, clock_timestamp(),NM_USUARIO_ATIVO_W, CD_PESSOA_FISICA_P, CD_PESSOA_FAMILIA_P, NR_SEQ_GRAU_PARENTESCO_P, 'S');
    
   END IF;
    
 ELSIF ACTION_P = 'DOMICILIO VINCULADO' THEN 
   BEGIN 
     FOR REG IN ( 
       SELECT CD_PESSOA_FISICA, NR_SEQ_GRAU_PARENT NR_SEQ_GRAU_PARENTESCO FROM PESSOA_DOMICILIO_MORADIA 
			 WHERE NR_SEQ_DOMICILIO = CD_DOMICILIO_P AND (NR_SEQ_GRAU_PARENT IS NOT NULL AND NR_SEQ_GRAU_PARENT::text <> '') 
       EXCEPT 
       SELECT CD_PESSOA_FAMILIA CD_PESSOA_FISICA, NR_SEQ_GRAU_PARENTESCO AS CD_PESSOA_FISICA FROM PF_FAMILIA 
			 WHERE CD_PESSOA_FISICA = CD_PESSOA_FISICA_P AND (NR_SEQ_GRAU_PARENTESCO IS NOT NULL AND NR_SEQ_GRAU_PARENTESCO::text <> '') 
       ) LOOP 
        
       INSERT INTO PF_FAMILIA(NR_SEQUENCIA, DT_ATUALIZACAO, NM_USUARIO, DT_ATUALIZACAO_NREC, 
       NM_USUARIO_NREC, CD_PESSOA_FISICA, CD_PESSOA_FAMILIA, NR_SEQ_GRAU_PARENTESCO, IE_HABITACAO) 
                            
        VALUES (nextval('pf_familia_seq'), 
        clock_timestamp(), 
        NM_USUARIO_ATIVO_W, 
        clock_timestamp(), 
        NM_USUARIO_ATIVO_W, 
       CD_PESSOA_FISICA_P, 
       REG.CD_PESSOA_FISICA, 
       coalesce(REG.NR_SEQ_GRAU_PARENTESCO,0), 
       'N');
       COMMIT;
      END LOOP;
     END;
 
 ELSIF ACTION_P = 'UPDATE' THEN 
  
  UPDATE PF_FAMILIA 
  SET 
  DT_ATUALIZACAO = clock_timestamp(), 
  NR_SEQ_GRAU_PARENTESCO = NR_SEQ_GRAU_PARENTESCO_P 
  WHERE CD_PESSOA_FISICA = CD_PESSOA_FISICA_P 
  AND CD_PESSOA_FAMILIA = CD_PESSOA_FAMILIA_P;
   
 
  ELSIF ACTION_P = 'DELETE' THEN 
 
  DELETE FROM PF_FAMILIA 
  WHERE CD_PESSOA_FISICA = CD_PESSOA_FISICA_P 
  AND CD_PESSOA_FAMILIA = CD_PESSOA_FAMILIA_P;
 
 
 END IF;
 
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE atualiza_cadastro_familia ( CD_PESSOA_FISICA_P text DEFAULT NULL, CD_PESSOA_FAMILIA_P text DEFAULT NULL, NR_SEQ_GRAU_PARENTESCO_P text DEFAULT NULL, CD_DOMICILIO_P text DEFAULT NULL, ACTION_P text DEFAULT 'OUTRA') FROM PUBLIC;

