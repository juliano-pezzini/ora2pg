-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE qt_atualizar_chegada_paciente (nm_usuario_p text, nr_seq_atendimento_p bigint) AS $body$
DECLARE

										
										
dt_tratamento_w				  timestamp;
cd_pessoa_fisica_w			varchar(10);
Vinc_todas_chegadas_w 	varchar(1);
nr_atendimento_w        bigint;
qt_atendimento_w        bigint;


BEGIN

Vinc_todas_chegadas_w := obter_param_usuario(3130, 345, obter_perfil_ativo, wheb_usuario_pck.get_nm_usuario, wheb_usuario_pck.get_cd_estabelecimento, Vinc_todas_chegadas_w);

select max(coalesce(dt_real,dt_prevista)),
     	max(OBTER_CODIGO_PACIENTE_SETOR(nr_seq_paciente))
into STRICT	dt_tratamento_w,
      cd_pessoa_fisica_w
from	paciente_atendimento
where 	nr_seq_atendimento = nr_seq_atendimento_p;

select	coalesce(max(nr_atendimento),0)
  into STRICT nr_atendimento_w
  from	atendimento_paciente
where	cd_pessoa_fisica	= cd_pessoa_fisica_w 
and coalesce(dt_alta::text, '') = '';

select	count(nr_atendimento)
  into STRICT qt_atendimento_w
  from	atendimento_paciente
where	cd_pessoa_fisica	= cd_pessoa_fisica_w
and coalesce(dt_alta::text, '') = '';

if (Vinc_todas_chegadas_w = 'S') then
  if (nr_atendimento_w <> '0') then
	update paciente_atendimento
	set 	dt_chegada = clock_timestamp(), 
    nr_atendimento = nr_atendimento_w,
		nm_usuario = nm_usuario_p,
		nm_usuario_chegada = nm_usuario_p
	where	OBTER_CODIGO_PACIENTE_SETOR(nr_seq_paciente) = cd_pessoa_fisica_w
	and		coalesce(trunc(dt_real),trunc(dt_prevista)) = trunc(dt_tratamento_w);
else
	update paciente_atendimento
	set 	dt_chegada = clock_timestamp(),
		nm_usuario = nm_usuario_p,
		nm_usuario_chegada = nm_usuario_p
	where	OBTER_CODIGO_PACIENTE_SETOR(nr_seq_paciente) = cd_pessoa_fisica_w
	and		coalesce(trunc(dt_real),trunc(dt_prevista)) = trunc(dt_tratamento_w);
  end if;
else
  if (Vinc_todas_chegadas_w = 'U') then
    if (qt_atendimento_w = 1)then
      update paciente_atendimento
         set nr_atendimento = nr_atendimento_w
       where OBTER_CODIGO_PACIENTE_SETOR(nr_seq_paciente) = cd_pessoa_fisica_w
         and coalesce(trunc(dt_real), trunc(dt_prevista)) = trunc(dt_tratamento_w);
    end if;

    update paciente_atendimento
       set dt_chegada         = clock_timestamp(),
           nm_usuario         = nm_usuario_p,
           nm_usuario_chegada = nm_usuario_p
     where OBTER_CODIGO_PACIENTE_SETOR(nr_seq_paciente) = cd_pessoa_fisica_w
       and coalesce(trunc(dt_real), trunc(dt_prevista)) = trunc(dt_tratamento_w);
  else
    update 	paciente_atendimento
    set 	dt_chegada = clock_timestamp(), 
        nm_usuario = nm_usuario_p,
        nm_usuario_chegada = nm_usuario_p
    where 	nr_seq_atendimento = nr_seq_atendimento_p;
  end if;
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE qt_atualizar_chegada_paciente (nm_usuario_p text, nr_seq_atendimento_p bigint) FROM PUBLIC;

