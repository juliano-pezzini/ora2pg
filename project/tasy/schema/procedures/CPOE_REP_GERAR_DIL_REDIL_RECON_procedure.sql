-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE cpoe_rep_gerar_dil_redil_recon ( nr_prescricao_p bigint, nr_seq_mat_cpoe_p bigint, nr_seq_material_p bigint, ie_update_rep_p char default 'S', ie_item_cpoe_p text default null) AS $body$
DECLARE

				
nr_seq_material_w		prescr_material.nr_sequencia%type;
ie_agrupador_w			prescr_material.ie_agrupador%type;
cd_material_w			prescr_material.cd_material%type;
qt_dose_w				prescr_material.qt_dose%type;
ds_dose_diferenciada_w	prescr_material.ds_dose_diferenciada%type;
cd_unidade_medida_w		prescr_material.cd_unidade_medida%type;
qt_solucao_w			prescr_material.qt_solucao%type;
nr_ocorrencia_w			prescr_material.nr_ocorrencia%type;
ie_dose_espec_agora_w	prescr_material.ie_dose_espec_agora%type;
qt_volume_corrigido_w	prescr_material.qt_volume_corrigido%type;
ie_level_diluicao_w		smallint := 1; -- 1. Reconstituicao, 2. Diluicaoo, 3.Rediluicao
i						varchar(1);
ds_sql_w				varchar(2000);
ds_erro_w				varchar(1900);
				
c01 CURSOR FOR
SELECT	nr_sequencia,
		ie_agrupador,
		cd_material,
		qt_dose,
		cd_unidade_medida_dose,
		ds_dose_diferenciada,
		qt_solucao,
		nr_ocorrencia,
		qt_volume_corrigido
from	prescr_material
where	nr_prescricao = nr_prescricao_p
and		nr_sequencia_diluicao = nr_seq_material_p
and		ie_agrupador in (4,3,7,9)
order by
		nr_sequencia;

	procedure gerar_reconstituicao(	cd_material_p			bigint,
									cd_unidade_medida_p		text,
									qt_dose_p				bigint,
									ds_dose_diferenciada_p	text,
									nr_ocorrencia_p			bigint) is
	
	;
BEGIN
		i := substr(ie_item_cpoe_p, length(ie_item_cpoe_p), 1);

		if (i in ('1', '2', '3', '4', '5', '6', '7')) then
			ds_sql_w	:=
			' update	cpoe_material ' ||
			' set		cd_mat_recons'||i||' 			= :cd_material_p, ' ||
			' 			cd_unid_med_dose_recons'||i||'	= :cd_unidade_medida_p, ' ||
			' 			qt_dose_recons'||i||'			= :qt_dose_p, ' ||
			' 			ds_dose_diferenciada_rec'||i||'	= :ds_dose_diferenciada_p ' ||
			' where		nr_sequencia					= :nr_seq_mat_cpoe_p ';
			begin
				EXECUTE ds_sql_w using cd_material_p, cd_unidade_medida_p, qt_dose_p, ds_dose_diferenciada_p, nr_seq_mat_cpoe_p;
			exception when others then
				ds_erro_w := substr(sqlerrm, 1, 1900);
				CALL gravar_log_tasy(17325, 'CPOE_REP_Gerar_dil_redil_recon > gerar_reconstituicao - Erro: '||ds_erro_w, wheb_usuario_pck.get_nm_usuario);
			end;
		else
			update	cpoe_material
			set		cd_mat_recons 				= cd_material_p,
					cd_unid_med_dose_recons		= cd_unidade_medida_p,
					qt_dose_recons				= qt_dose_p,
					ds_dose_diferenciada_rec	= ds_dose_diferenciada_p
			where	nr_sequencia 				= nr_seq_mat_cpoe_p;
		end if;
	end;

	procedure gerar_diluicao(	cd_material_p			number,
								cd_unidade_medida_p		varchar2,
								qt_dose_p				number,
								ds_dose_diferenciada_p	varchar2,
								qt_solucao_p			number,
								qt_volume_corrigido_p	number ,
								ie_agrupador_p			number ) is
	
	begin
		
		if (ie_agrupador_p = 2) then			
			update	cpoe_material
			set		cd_mat_dil 					= cd_material_p,
					cd_unid_med_dose_dil		= cd_unidade_medida_p,
					qt_dose_dil					= qt_dose_p,
					ds_dose_diferenciada_dil	= ds_dose_diferenciada_p,
					qt_solucao_dil				= qt_solucao_p,
					qt_volume_corrigido			= qt_volume_corrigido_p
			where	nr_sequencia 				= nr_seq_mat_cpoe_p;
			
		else		
			update	cpoe_material
			set		cd_mat_dil 					= cd_material_p,
					cd_unid_med_dose_dil		= cd_unidade_medida_p,
					qt_dose_dil					= qt_dose_p,
					ds_dose_diferenciada_dil	= ds_dose_diferenciada_p,
					qt_solucao_dil				= qt_solucao_p,
					qt_dil_correcao				= qt_volume_corrigido_p
			where	nr_sequencia 				= nr_seq_mat_cpoe_p;		

		end if;
	
		
		
		
		
		select	coalesce(ie_dose_espec_agora,'N')
		into STRICT	ie_dose_espec_agora_w
		from	prescr_material
		where	nr_prescricao	= nr_prescricao_p
		and		nr_sequencia	= nr_seq_material_p;
		
		if (ie_dose_espec_agora_w = 'S') then
			update	cpoe_material
			set		qt_dose_adic_dil	= qt_dose_p
			where	nr_sequencia		= nr_seq_mat_cpoe_p;					
		end if;
	end;

	procedure gerar_rediluicao(cd_material_p			number,
								cd_unidade_medida_p		varchar2,
								qt_dose_p				number,
								ds_dose_diferenciada_p	varchar2,
								qt_solucao_p			number ) is
	
	begin
		update	cpoe_material
		set		cd_mat_red	 				= cd_material_p,
				cd_unid_med_dose_red		= cd_unidade_medida_p,
				qt_dose_red					= qt_dose_p,
				ds_dose_diferenciada_red	= ds_dose_diferenciada_p,
				qt_solucao_red				= qt_solucao_p
		where	nr_sequencia 				= nr_seq_mat_cpoe_p;
	end;
		
begin

open c01;
loop
fetch c01 into	nr_seq_material_w,
				ie_agrupador_w,
				cd_material_w,
				qt_dose_w,
				cd_unidade_medida_w,
				ds_dose_diferenciada_w,
				qt_solucao_w,
				nr_ocorrencia_w,
				qt_volume_corrigido_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	begin
	if (ie_agrupador_w = 4) then
		-- If the solution component
		if (ie_level_diluicao_w = 1) and (coalesce(Obter_conversao_ml(cd_material_w,qt_dose_w,cd_unidade_medida_w),0) > 0) then
			ie_level_diluicao_w	:= ie_level_diluicao_w+1;
		end if;
		
		if (ie_level_diluicao_w = 1) then
			gerar_reconstituicao(cd_material_w, cd_unidade_medida_w, qt_dose_w, ds_dose_diferenciada_w, nr_ocorrencia_w);
		elsif (ie_level_diluicao_w = 2) then
			gerar_diluicao(cd_material_w, cd_unidade_medida_w, qt_dose_w, ds_dose_diferenciada_w, qt_solucao_w, 2);
		elsif (ie_level_diluicao_w = 3) then
			gerar_rediluicao(cd_material_w, cd_unidade_medida_w, qt_dose_w, ds_dose_diferenciada_w, qt_solucao_w);
		end if;
	elsif (ie_agrupador_w = 3) then
		gerar_diluicao(cd_material_w, cd_unidade_medida_w, qt_dose_w, ds_dose_diferenciada_w, qt_solucao_w, qt_volume_corrigido_w, 3);		
	elsif (ie_agrupador_w = 7) then
		gerar_rediluicao(cd_material_w, cd_unidade_medida_w, qt_dose_w, ds_dose_diferenciada_w, qt_solucao_w);
	elsif (ie_agrupador_w = 9) then
		gerar_reconstituicao(cd_material_w, cd_unidade_medida_w, qt_dose_w, ds_dose_diferenciada_w, nr_ocorrencia_w);
	end if;
	
	if (ie_update_rep_p = 'S') then
		update	prescr_material
		set		nr_seq_mat_cpoe = nr_seq_mat_cpoe_p
		where	nr_prescricao 	= nr_prescricao_p
		and		nr_sequencia	= nr_seq_material_w;
	end if;
	
	end;
end loop;
close c01;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cpoe_rep_gerar_dil_redil_recon ( nr_prescricao_p bigint, nr_seq_mat_cpoe_p bigint, nr_seq_material_p bigint, ie_update_rep_p char default 'S', ie_item_cpoe_p text default null) FROM PUBLIC;

