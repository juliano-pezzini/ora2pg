-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_item_med_uso_plano ( nr_seq_med_uso_p bigint, nr_seq_plano_versao_p bigint ) AS $body$
DECLARE

paciente_medic_uso_w	paciente_medic_uso%rowtype;
plano_versao_medic_w	plano_versao_medic%rowtype;
ds_nao_sabe_dose_w		varchar(200);


BEGIN
	select	*
	into STRICT	paciente_medic_uso_w
	from	paciente_medic_uso
	where	nr_sequencia = nr_seq_med_uso_p;
	
	select	nextval('plano_versao_medic_seq')
	into STRICT	plano_versao_medic_w.nr_sequencia
	;
	
	if (paciente_medic_uso_w.cd_material IS NOT NULL AND paciente_medic_uso_w.cd_material::text <> '') then
		plano_versao_medic_w.ie_tipo_medicamento := 'S';
	else
		plano_versao_medic_w.ie_tipo_medicamento := 'N';
	end if;
	
	plano_versao_medic_w.ie_exibir_plano_medic := 'N';
	plano_versao_medic_w.nr_seq_versao := nr_seq_plano_versao_p;
	
	if (paciente_medic_uso_w.cd_unid_med IS NOT NULL AND paciente_medic_uso_w.cd_unid_med::text <> '') then
		plano_versao_medic_w.cd_unidade_medida := paciente_medic_uso_w.cd_unid_med;
	end if;
	if (paciente_medic_uso_w.cd_material IS NOT NULL AND paciente_medic_uso_w.cd_material::text <> '') then
		plano_versao_medic_w.ds_princ_ativo := obter_princ_ativo_plano(paciente_medic_uso_w.cd_material,'P');
		plano_versao_medic_w.ds_potencia := obter_princ_ativo_plano(paciente_medic_uso_w.cd_material,'C');
		plano_versao_medic_w.ds_forma_medicamento := get_dosage_form_material(paciente_medic_uso_w.cd_material);
	end if;
	
	plano_versao_medic_w.cd_pessoa_fisica := paciente_medic_uso_w.cd_pessoa_fisica;
	plano_versao_medic_w.dt_atualizacao := clock_timestamp();
	plano_versao_medic_w.nm_usuario := wheb_usuario_pck.get_nm_usuario;
	plano_versao_medic_w.dt_atualizacao_nrec := clock_timestamp();
	plano_versao_medic_w.nm_usuario_nrec := wheb_usuario_pck.get_nm_usuario;
	plano_versao_medic_w.cd_material := paciente_medic_uso_w.cd_material;
	plano_versao_medic_w.ds_observacao := paciente_medic_uso_w.ds_observacao;
	plano_versao_medic_w.ds_medicamento := paciente_medic_uso_w.ds_medicamento;
	plano_versao_medic_w.ie_classificacao := paciente_medic_uso_w.ie_classificacao;
	plano_versao_medic_w.ds_descricao_complementar := paciente_medic_uso_w.ds_descricao_complementar;
	plano_versao_medic_w.ds_dose_diferenciada := paciente_medic_uso_w.ds_dose_diferenciada;
	plano_versao_medic_w.ds_forma_desc := paciente_medic_uso_w.ds_forma_desc;
	plano_versao_medic_w.ds_unid_med_desc := paciente_medic_uso_w.ds_unid_med_desc;
	plano_versao_medic_w.ds_horario_especial := paciente_medic_uso_w.ds_horario_especial;
	plano_versao_medic_w.ds_motivo := paciente_medic_uso_w.ds_motivo;
	plano_versao_medic_w.qt_dose_manha := paciente_medic_uso_w.qt_dose_manha;
	plano_versao_medic_w.qt_dose_almoco := paciente_medic_uso_w.qt_dose_almoco;
	plano_versao_medic_w.qt_dose_noite := paciente_medic_uso_w.qt_dose_noite;
	plano_versao_medic_w.qt_dose_tarde := paciente_medic_uso_w.qt_dose_tarde;
	plano_versao_medic_w.ds_orientacao := paciente_medic_uso_w.ds_orientacao;
	plano_versao_medic_w.ds_intervalo_item := paciente_medic_uso_w.ds_intervalo_item;
	plano_versao_medic_w.dt_registro := paciente_medic_uso_w.dt_registro;
	plano_versao_medic_w.cd_profissional := paciente_medic_uso_w.cd_profissional;
	plano_versao_medic_w.nr_atendimento := paciente_medic_uso_w.nr_atendimento;
	
	select 	CASE WHEN paciente_medic_uso_w.ie_nao_sabe_dose='S' THEN obter_desc_expressao(287453)||chr(13)||chr(10)  ELSE '' END ||
			paciente_medic_uso_w.ds_observacao
	into STRICT 	ds_nao_sabe_dose_w
	;
	
	plano_versao_medic_w.ds_observacao := ds_nao_sabe_dose_w;
	
	
	insert into plano_versao_medic values (plano_versao_medic_w.*);
	
	commit;
	
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_item_med_uso_plano ( nr_seq_med_uso_p bigint, nr_seq_plano_versao_p bigint ) FROM PUBLIC;

