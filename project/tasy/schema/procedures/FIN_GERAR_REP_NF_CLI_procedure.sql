-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE fin_gerar_rep_nf_cli ( nr_seq_nf_p bigint, nr_seq_item_nf_p bigint, nr_seq_regra_p bigint, vl_item_p bigint, nm_usuario_p text) AS $body$
DECLARE


vl_repasse_w				double precision;
pr_repasse_w				double precision;
cd_pessoa_fisica_w			varchar(10);
cd_cnpj_w				varchar(14);
nr_sequencia_w			bigint;
nr_seq_regra_rep_w			bigint;

C01 CURSOR FOR
	SELECT	vl_repasse,
		pr_repasse,
		cd_pessoa_fisica,
		cd_cnpj,
		nr_sequencia
	from	com_cli_regra_valor_rep
	where	nr_seq_regra_item	= nr_seq_regra_p
	and	ie_situacao		= 'A'
	and	((coalesce(dt_vigencia::text, '') = '') or
		((dt_vigencia IS NOT NULL AND dt_vigencia::text <> '') and (trunc(dt_vigencia,'dd') >= trunc(clock_timestamp(),'dd'))))
	and	((coalesce(vl_repasse,0) > 0) or (coalesce(pr_repasse,0) > 0));


BEGIN

OPEN C01;
LOOP
FETCH C01 into
	vl_repasse_w,
	pr_repasse_w,
	cd_pessoa_fisica_w,
	cd_cnpj_w,
	nr_seq_regra_rep_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	select	nextval('nota_fiscal_item_rep_seq')
	into STRICT	nr_sequencia_w
	;
	if (pr_repasse_w > 0) then
		vl_repasse_w	:= vl_repasse_w + coalesce(vl_item_p,0) * pr_repasse_w / 100;
	end if;

	insert into nota_fiscal_item_rep(
		nr_sequencia,
		nr_seq_nf,
		nr_seq_item_nf,
		nr_seq_regra_item,
		dt_atualizacao,
		nm_usuario,
		dt_atualizacao_nrec,
		nm_usuario_nrec,
		vl_repasse,
		pr_repasse,
		cd_pessoa_fisica,
		cd_cnpj,
		nr_seq_regra_rep)
	values (
		nr_sequencia_w,
		nr_seq_nf_p,
		nr_seq_item_nf_p,
		nr_seq_regra_p,
		clock_timestamp(),
		nm_usuario_p,
		clock_timestamp(),
		nm_usuario_p,
		vl_repasse_w,
		pr_repasse_w,
		cd_pessoa_fisica_w,
		cd_cnpj_w,
		nr_seq_regra_rep_w);
END LOOP;
CLOSE C01;

--FIN_Gerar_OC_Repasse(nr_seq_nf_p,	nm_usuario_p);
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE fin_gerar_rep_nf_cli ( nr_seq_nf_p bigint, nr_seq_item_nf_p bigint, nr_seq_regra_p bigint, vl_item_p bigint, nm_usuario_p text) FROM PUBLIC;

