-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE listar_texto_analise (cd_funcao_p bigint) AS $body$
DECLARE


C01 CURSOR FOR
SELECT 	a.cd_funcao,
	a.nr_sequencia nr_seq_texto,
	SUBSTR(obter_desc_expressao(a.cd_exp_informacao),1,254) ds_texto,
	CASE WHEN position('?' in SUBSTR(obter_desc_expressao(a.cd_exp_informacao),1,254))=0 THEN 'N'  ELSE 'S' END  ie_tipo_msg,
	CASE WHEN position('#@' in SUBSTR(obter_desc_expressao(a.cd_exp_informacao),1,254))=0 THEN 'N'  ELSE 'S' END  ie_macro,
	(SELECT c.NR_SEQ_OBJETO FROM OBJ_SCHEMATIC_EVENTO c WHERE c.nr_sequencia = b.nr_seq_obj_evento) nr_seq_objeto_schem,
	(SELECT c.NR_SEQ_DIC_OBJETO FROM OBJ_SCHEMATIC_EVENTO c WHERE c.nr_sequencia = b.nr_seq_obj_evento) nr_seq_dic_objeto_schem,
	(SELECT obter_schematic_path(c.NR_SEQ_OBJETO, NULL) FROM OBJ_SCHEMATIC_EVENTO c WHERE c.nr_sequencia = b.nr_seq_obj_evento) ds_caminho,
	'S' ie_utilizacao,
	0 qt_tempo_analise,
	0 qt_tempo_programacao
FROM   	OBJ_SCHEMATIC_EVENTO_ACAO b,
		DIC_OBJETO a
WHERE  	a.nr_sequencia = b.NR_SEQ_DIC_OBJ_MSG
AND		a.ie_tipo_objeto = 'T'
AND	EXISTS (	SELECT 1
		FROM funcao_schematic x
		WHERE a.cd_funcao = x.cd_funcao
		AND coalesce(x.ie_situacao_funcao,'A') <> 'I')
AND	((a.cd_funcao = cd_funcao_p) OR (cd_funcao_p = 0))
ORDER BY 1,2;

c01_w	c01%rowtype;


BEGIN

--delete obj_texto_analise;
open C01;
loop
fetch C01 into
	c01_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin

	insert into obj_texto_analise(
		nr_sequencia,
		cd_funcao,
		nr_seq_texto,
		nr_seq_objeto_schem,
		nr_seq_dic_objeto_schem,
		ds_texto,
		ie_tipo_msg,
		ie_utilizacao,
		ie_macro,
		ds_caminho,
		qt_tempo_analise,
		qt_tempo_programacao)
	values (nextval('obj_texto_analise_seq'),
		c01_w.cd_funcao,
		c01_w.nr_seq_texto,
		c01_w.nr_seq_objeto_schem,
		c01_w.nr_seq_dic_objeto_schem,
		c01_w.ds_texto,
		c01_w.ie_tipo_msg,
		c01_w.ie_utilizacao,
		c01_w.ie_macro,
		c01_w.ds_caminho,
		c01_w.qt_tempo_analise,
		c01_w.qt_tempo_programacao);

	end;
end loop;
close C01;

commit;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE listar_texto_analise (cd_funcao_p bigint) FROM PUBLIC;

