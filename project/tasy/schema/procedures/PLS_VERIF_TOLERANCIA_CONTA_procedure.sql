-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_verif_tolerancia_conta ( nr_seq_conta_proc_p bigint, nr_seq_conta_mat_p bigint, ie_tipo_tabela_p text, nm_usuario_p text) AS $body$
DECLARE

vl_apresentado_menor_w		double precision;
vl_apresentado_maior_w		double precision;
vl_tolerancia_maior_w		double precision;
vl_tolerancia_menor_w		double precision;
vl_apresentado_w		double precision;
vl_calculado_w			double precision;
vl_total_procedimento_w		double precision;
nr_motivo_glosa_maior_w		bigint;
nr_motivo_glosa_menor_w		bigint;
ie_ocorrencia_w			pls_controle_estab.ie_ocorrencia%type := 'N';
cd_estabelecimento_w		estabelecimento.cd_estabelecimento%type;
ie_tp_desp_conta_proc_w	pls_conta_proc.ie_tipo_despesa%type;
ie_tp_desp_conta_mat_w	pls_conta_mat.ie_tipo_despesa%type;
/*ie_tipo_tabela verifica em qual tabela ira fazer o update
p = procedimento
M = material*/
BEGIN
ie_ocorrencia_w := pls_obter_se_controle_estab('GO');
cd_estabelecimento_w := wheb_usuario_pck.get_cd_estabelecimento;

if (ie_tipo_tabela_p = 'P')	then
	select	coalesce(vl_procedimento_imp,0),
			coalesce(vl_total_procedimento,0),
			ie_tipo_despesa
	into STRICT	vl_apresentado_w,
			vl_calculado_w,
			ie_tp_desp_conta_proc_w
	from 	pls_conta_proc
	where 	nr_sequencia = nr_seq_conta_proc_p;

end if;

if (ie_tipo_tabela_p = 'M')	then
	select	coalesce(vl_material_imp,0),
			coalesce(vl_material,0),
			ie_tipo_despesa
	into STRICT	vl_apresentado_w,
			vl_calculado_w,
			ie_tp_desp_conta_mat_w
	from 	pls_conta_mat
	where 	nr_sequencia = nr_seq_conta_mat_p;
end if;

select	max(nr_sequencia)
into STRICT 	nr_motivo_glosa_maior_w
from 	tiss_motivo_glosa
where 	cd_motivo_tiss = '1705';

if (nr_seq_conta_proc_p IS NOT NULL AND nr_seq_conta_proc_p::text <> '') then
	if (ie_ocorrencia_w = 'N') then
		select	coalesce(max(vl_tolerancia_glosa),0)
		into STRICT 	vl_tolerancia_maior_w
		from 	pls_regra_lanc_glosa
		where 	ie_situacao = 'A'
		and		((coalesce(ie_tipo_despesa_proc::text, '') = '') or (ie_tipo_despesa_proc = ie_tp_desp_conta_proc_w))
		and	nr_seq_motivo_glosa = nr_motivo_glosa_maior_w;
	else
		select	coalesce(max(vl_tolerancia_glosa),0)
		into STRICT 	vl_tolerancia_maior_w
		from 	pls_regra_lanc_glosa
		where 	ie_situacao = 'A'
		and		((coalesce(ie_tipo_despesa_proc::text, '') = '') or (ie_tipo_despesa_proc = ie_tp_desp_conta_proc_w))
		and	nr_seq_motivo_glosa = nr_motivo_glosa_maior_w
		and	cd_estabelecimento = cd_estabelecimento_w;
	end if;
else
	if (ie_ocorrencia_w = 'N') then
		select	coalesce(max(vl_tolerancia_glosa),0)
		into STRICT 	vl_tolerancia_maior_w
		from 	pls_regra_lanc_glosa
		where 	ie_situacao = 'A'
		and		((coalesce(ie_tipo_despesa_mat::text, '') = '') or (ie_tipo_despesa_mat = ie_tp_desp_conta_mat_w))
		and		nr_seq_motivo_glosa = nr_motivo_glosa_maior_w;
	else
		select	coalesce(max(vl_tolerancia_glosa),0)
		into STRICT 	vl_tolerancia_maior_w
		from 	pls_regra_lanc_glosa
		where 	ie_situacao = 'A'
		and		((coalesce(ie_tipo_despesa_mat::text, '') = '') or (ie_tipo_despesa_mat = ie_tp_desp_conta_mat_w))
		and		nr_seq_motivo_glosa = nr_motivo_glosa_maior_w
		and		cd_estabelecimento = cd_estabelecimento_w;
	end if;
end if;

select	max(nr_sequencia)
into STRICT 	nr_motivo_glosa_menor_w
from 	tiss_motivo_glosa
where 	cd_motivo_tiss 	= '1706';

if (nr_seq_conta_proc_p IS NOT NULL AND nr_seq_conta_proc_p::text <> '') then
	if (ie_ocorrencia_w = 'N') then
		select	coalesce(max(vl_tolerancia_glosa),0)
		into STRICT 	vl_tolerancia_menor_w
		from 	pls_regra_lanc_glosa
		where 	ie_situacao = 'A'
		and		((coalesce(ie_tipo_despesa_proc::text, '') = '') or (ie_tipo_despesa_proc = ie_tp_desp_conta_proc_w))
		and	nr_seq_motivo_glosa = nr_motivo_glosa_menor_w;
	else
		select	coalesce(max(vl_tolerancia_glosa),0)
		into STRICT 	vl_tolerancia_menor_w
		from 	pls_regra_lanc_glosa
		where 	ie_situacao = 'A'
		and		((coalesce(ie_tipo_despesa_proc::text, '') = '') or (ie_tipo_despesa_proc = ie_tp_desp_conta_proc_w))
		and	nr_seq_motivo_glosa = nr_motivo_glosa_menor_w
		and	cd_estabelecimento = cd_estabelecimento_w;
	end if;
else
	if (ie_ocorrencia_w = 'N') then
		select	coalesce(max(vl_tolerancia_glosa),0)
		into STRICT 	vl_tolerancia_menor_w
		from 	pls_regra_lanc_glosa
		where 	ie_situacao = 'A'
		and		((coalesce(ie_tipo_despesa_mat::text, '') = '') or (ie_tipo_despesa_mat = ie_tp_desp_conta_mat_w))
		and	nr_seq_motivo_glosa = nr_motivo_glosa_menor_w;
	else
		select	coalesce(max(vl_tolerancia_glosa),0)
		into STRICT 	vl_tolerancia_menor_w
		from 	pls_regra_lanc_glosa
		where 	ie_situacao = 'A'
		and		((coalesce(ie_tipo_despesa_mat::text, '') = '') or (ie_tipo_despesa_mat = ie_tp_desp_conta_mat_w))
		and	nr_seq_motivo_glosa = nr_motivo_glosa_menor_w
		and	cd_estabelecimento = cd_estabelecimento_w;
	end if;
end if;

vl_apresentado_maior_w  := vl_apresentado_w - vl_tolerancia_maior_w;
vl_apresentado_menor_w	:= vl_apresentado_w + vl_tolerancia_menor_w;

if (coalesce(vl_apresentado_maior_w,0) > coalesce(vl_calculado_w,0)) then
	goto final;
elsif (coalesce(vl_apresentado_menor_w,0) < coalesce(vl_calculado_w,0)) and (coalesce(vl_calculado_w,0)>0)  and (coalesce(vl_apresentado_w,0) > 0) then
	goto final;
end if;

if (coalesce( vl_apresentado_w,0) > 0) then

	if (ie_tipo_tabela_p = 'P') then
	update	pls_conta_proc
	set 	vl_total_procedimento = vl_apresentado_w
	where 	nr_sequencia 	      = nr_seq_conta_proc_p;
	end if;

	if (ie_tipo_tabela_p = 'M') then
	update	pls_conta_mat
	set 	vl_material  = vl_apresentado_w
	where 	nr_sequencia = nr_seq_conta_mat_p;
	end if;
end if;

<<final>>
null;
/*
commit;Não pode haver commit em procedure intermediária
*/
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_verif_tolerancia_conta ( nr_seq_conta_proc_p bigint, nr_seq_conta_mat_p bigint, ie_tipo_tabela_p text, nm_usuario_p text) FROM PUBLIC;

