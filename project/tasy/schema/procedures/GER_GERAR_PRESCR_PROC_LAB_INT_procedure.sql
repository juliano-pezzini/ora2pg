-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE ger_gerar_prescr_proc_lab_int ( nr_atendimento_p bigint, cd_medico_p text, dt_referencia_p text, cd_exame_p text, qt_procedimento_p bigint, nr_seq_empresa_p bigint, nr_prescricao_ext_p text, nm_usuario_p text, nr_prescricao_p INOUT bigint, cd_pessoa_fisica_p INOUT text, cd_order_control_p text default null) AS $body$
DECLARE




nr_prescricao_w			prescr_medica.nr_prescricao%type;

nr_prescricao_ext_w		prescr_medica.nr_prescricao%type;

nr_sequencia_w			prescr_procedimento.nr_Sequencia%type;

dt_prescricao_w			timestamp;

cd_estabelecimento_w		estabelecimento.cd_estabelecimento%type;

ie_kit_automatico_w		varchar(5);



cd_procedimento_w		prescr_procedimento.cd_procedimento%type;

ie_origem_proced_w		prescr_procedimento.ie_origem_proced%type;

nr_atendimento_w		prescr_medica.nr_atendimento%type;

ie_tipo_evol_w			usuario.ie_tipo_evolucao%type;

cd_pessoa_fisica_w		pessoa_fisica.cd_pessoa_fisica%type;

cd_medico_prescri_w		pessoa_fisica.cd_pessoa_fisica%type;

cd_pf_usuario_w			pessoa_fisica.cd_pessoa_fisica%type;

qt_altura_cm_w			prescr_medica.qt_altura_cm%type;

qt_peso_w			prescr_medica.qt_peso%type;



nr_seq_proc_interno_w		prescr_procedimento.nr_seq_proc_interno%type;



cd_material_exame_w		prescr_procedimento.cd_material_exame%type;

nr_seq_exame_w			prescr_procedimento.nr_seq_exame%type;

cd_perfil_w			perfil.cd_perfil%type;

dt_referencia_w			timestamp;

ds_erro_w			varchar(4000);

qt_procedimento_w prescr_procedimento.qt_procedimento%type;

cd_intervalo_w PRESCR_PROCEDIMENTO.CD_INTERVALO%type;

ds_horarios_w PRESCR_PROCEDIMENTO.DS_HORARIOS%type;

ds_horarios2_w PRESCR_PROCEDIMENTO.DS_HORARIOS%type;

nr_ocorrencia_w bigint;




BEGIN

dt_referencia_w		:= to_date(dt_referencia_p, 'yyyymmddhh24miss');

qt_procedimento_w := qt_procedimento_p;

if (cd_order_control_p = 'XO') then
	select	max(nr_prescricao)
	into STRICT	nr_prescricao_ext_w
	from	prescr_medica
	where	nr_controle_int_lab	=	(nr_prescricao_ext_p)::numeric
	and	coalesce(dt_suspensao::text, '') = '';
	
	if (nr_prescricao_ext_w IS NOT NULL AND nr_prescricao_ext_w::text <> '') then
		CALL Suspender_Prescricao(nr_prescricao_ext_w,
					0,
					obter_desc_expressao(855591),
					nm_usuario_p,
					'N');
	end if;

end if;



if (coalesce(qt_procedimento_w::text, '') = '' or qt_procedimento_w = '') then

  qt_procedimento_w := 1;

end if;







select 	max(a.cd_pessoa_fisica),

		max(a.ie_tipo_evolucao)

into STRICT	cd_pf_usuario_w,

		ie_tipo_evol_w

from	usuario a

where	a.nm_usuario = nm_usuario_p;





if (nr_atendimento_p IS NOT NULL AND nr_atendimento_p::text <> '') then

	select	max(cd_pessoa_fisica),

			max(cd_medico_resp),

			max(cd_estabelecimento)

	into STRICT	cd_pessoa_fisica_w,

			cd_medico_prescri_w,

			cd_estabelecimento_w

	from	atendimento_paciente

	where	nr_atendimento = nr_atendimento_p;

end if;



qt_altura_cm_w	:= obter_sinal_vital(nr_atendimento_p, obter_desc_expressao(283402));

qt_peso_w		:= obter_sinal_vital(nr_atendimento_p, obter_desc_expressao(295698));



select max(cd_perfil_padrao)

into STRICT	cd_perfil_w

from	empresa_integr_dados

where	nr_seq_empresa_integr = nr_seq_empresa_p;


select	max(nr_prescricao)
into STRICT	nr_prescricao_w
from	prescr_medica
where	nr_controle_int_lab	= (nr_prescricao_ext_p)::numeric
and		coalesce(dt_suspensao::text, '') = '';


if (coalesce(nr_prescricao_w::text, '') = '') then



	select	nextval('prescr_medica_seq')

	into STRICT	nr_prescricao_w

	;

	insert into	prescr_medica(

				nr_prescricao,

				nr_atendimento,

				cd_pessoa_fisica,

				cd_medico,

				cd_prescritor,

				dt_prescricao,

				dt_atualizacao,

				nm_usuario,

				nm_usuario_original,

				ie_adep,

				ie_emergencia,

				ie_recem_nato,

				ie_ajusta_validade_atend,

				ie_prescritor_aux,

				ie_paciente_dialise,

				ie_funcao_prescritor,

				ie_origem_inf,

				qt_altura_cm,

				qt_peso,

				dt_inicio_prescr,

				dt_primeiro_horario,

				nr_horas_validade,

				cd_funcao_origem,

				cd_perfil_ativo,

				nr_controle_int_lab,

				cd_estabelecimento) 

			values (

				nr_prescricao_w,

				nr_atendimento_p,

				cd_pessoa_fisica_w,

				coalesce(cd_medico_p, cd_medico_prescri_w),

				cd_pf_usuario_w,

				dt_referencia_w,

				clock_timestamp(),

				nm_usuario_p,

				nm_usuario_p,

				'S',

				'N',

				'N',

				'N',

				'N',

				'N',

				ie_tipo_evol_w,

				1,

				qt_altura_cm_w,

				qt_peso_w,

				dt_referencia_w,

				dt_referencia_w,

				24,

				2314,

				cd_perfil_w,

				(nr_prescricao_ext_p)::numeric ,
        
				cd_estabelecimento_w);



	commit;

end if;


select	max(dt_prescricao),

		max(cd_estabelecimento),

		max(nr_atendimento)

into STRICT 	dt_prescricao_w,

		cd_estabelecimento_w,

		nr_atendimento_w

from 	prescr_medica

where 	nr_prescricao = nr_prescricao_w;



ie_kit_automatico_w := Obter_Param_Usuario(998, 12, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_kit_automatico_w);



select	coalesce(max(nr_sequencia), 0) + 1

into STRICT	nr_sequencia_w

from	prescr_procedimento

where	nr_prescricao	= nr_prescricao_w;



select	max(nr_seq_exame),

		max(cd_procedimento),

		max(ie_origem_proced),

		max(nr_seq_proc_interno)

into STRICT	nr_seq_exame_w,

		cd_procedimento_w,

		ie_origem_proced_w,

		nr_seq_proc_interno_w

from	exame_laboratorio

where	cd_exame_integracao = cd_exame_p;



if (coalesce(cd_procedimento_w::text, '') = '' or coalesce(ie_origem_proced_w::text, '') = '')then

    select

      max(cd_procedimento), 

      max(ie_origem_proced) 

    into STRICT

      cd_procedimento_w,

		  ie_origem_proced_w

    from proc_interno 

    where 

      nr_sequencia = nr_seq_proc_interno_w;

end if;


cd_intervalo_w := Obter_Param_Prescr_Proc_Int(nr_seq_proc_interno_w, null, 'I', null);

SELECT * FROM calcular_horario_prescricao(nr_prescricao_w, cd_intervalo_w, dt_prescricao_w, dt_prescricao_w, 24, cd_procedimento_w, 0, 0, nr_ocorrencia_w, ds_horarios_w, ds_horarios2_w, 'N', NULL, 'S', cd_procedimento_w, ie_origem_proced_w, nr_seq_proc_interno_w) INTO STRICT nr_ocorrencia_w, ds_horarios_w, ds_horarios2_w;


ds_horarios_w := ds_horarios_w || ds_horarios2_w;




insert into prescr_procedimento(

		nr_prescricao,

		nr_sequencia,

		cd_procedimento,

		ie_origem_proced,

		qt_procedimento,

		ie_urgencia,

		ie_suspenso,

		dt_prev_execucao,

		ie_status_atend,

		dt_atualizacao,

		nm_usuario,

		ie_origem_inf,

		nr_seq_interno,

		ie_avisar_result,

		cd_motivo_baixa,

		nr_seq_proc_interno,

		cd_perfil_ativo,

		nr_seq_exame,

		cd_material_exame,

    cd_intervalo,
    
    ds_horarios)

values (nr_prescricao_w,

		nr_sequencia_w,

		cd_procedimento_w,

		ie_origem_proced_w,

		qt_procedimento_w, 

		'N', 

		'N',

		dt_prescricao_w,

		5, 

		clock_timestamp(), 

		nm_usuario_p,

		'1', 

		nextval('prescr_procedimento_seq'),

		'N',

		0,

		nr_seq_proc_interno_w,

		cd_perfil_w,

		nr_seq_exame_w,

		cd_material_exame_w,
    
    cd_intervalo_w,
    
    ds_horarios_w);

	

commit;







CALL Gerar_med_mat_assoc(nr_prescricao_w,nr_sequencia_w);

	

if (ie_kit_automatico_w = 'S') then

	CALL Gerar_kit_procedimento(cd_estabelecimento_w, nr_prescricao_w, nr_sequencia_w, nm_usuario_p);

end if;



nr_prescricao_p		:= nr_prescricao_w;

cd_pessoa_fisica_p	:= cd_pessoa_fisica_w;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ger_gerar_prescr_proc_lab_int ( nr_atendimento_p bigint, cd_medico_p text, dt_referencia_p text, cd_exame_p text, qt_procedimento_p bigint, nr_seq_empresa_p bigint, nr_prescricao_ext_p text, nm_usuario_p text, nr_prescricao_p INOUT bigint, cd_pessoa_fisica_p INOUT text, cd_order_control_p text default null) FROM PUBLIC;

