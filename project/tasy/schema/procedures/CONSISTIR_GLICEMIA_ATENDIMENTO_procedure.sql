-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE consistir_glicemia_atendimento (nr_atendimento_p bigint, nr_seq_protocolo_p bigint, ie_opcao_p text, qt_hora_prescricao_p bigint, nr_prescricao_p bigint) AS $body$
DECLARE


qt_pendente_w	bigint;


BEGIN
qt_pendente_w := 0;

if (nr_atendimento_p IS NOT NULL AND nr_atendimento_p::text <> '') and (nr_seq_protocolo_p IS NOT NULL AND nr_seq_protocolo_p::text <> '') and (ie_opcao_p IS NOT NULL AND ie_opcao_p::text <> '') then


	/* usuário deseja iniciar glicemia x consistir cig em andamento x consistir glicemia diferente em andamento */

	if (ie_opcao_p = 'GLIC') then

	select  count(*)
	into STRICT	qt_pendente_w
	from    atend_glicemia a,
	        prescr_medica b
	where   a.nr_prescricao                                                            = b.nr_prescricao
	and     a.nr_atendimento                                                           = b.nr_atendimento
	and     (a.nr_seq_prot_glic IS NOT NULL AND a.nr_seq_prot_glic::text <> '')
	and (b.dt_validade_prescr                                                     >= clock_timestamp() - qt_hora_prescricao_p / 24)
	and     b.nr_atendimento                                                           = nr_atendimento_p
	and	a.ie_status_glic                                                       	   = 'N'
	and	a.nr_seq_prot_glic <>	(	SELECT 	max(nr_seq_prot_glic)
						from	atend_glicemia
						where	nr_prescricao = nr_prescricao_p);

	if (qt_pendente_w > 0) then
		/*'No momento, este paciente já possui um controle de glicemia em andamento.' || chr(10) ||
						'Não é possível iniciar um novo controle  já existindo um outro em aberto, favor verificar!'||'#@#@');*/
		CALL Wheb_mensagem_pck.exibir_mensagem_abort(261467);
	end if;

	end if;


end if;


end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE consistir_glicemia_atendimento (nr_atendimento_p bigint, nr_seq_protocolo_p bigint, ie_opcao_p text, qt_hora_prescricao_p bigint, nr_prescricao_p bigint) FROM PUBLIC;

