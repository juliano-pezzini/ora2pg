-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE atualiza_dia_prim_hor_assoc ( nr_prescricao_p bigint, nr_seq_material_p bigint, qt_dia_prim_hor_p bigint, dt_inicio_medic_p timestamp) AS $body$
DECLARE


ds_horarios_www			varchar(2000);
dt_inicio_prescricao_w	timestamp;
cd_intervalo_w			varchar(7);
ds_horarios_w			varchar(2000);
ds_horarios_ww			varchar(2000);
qt_hora_intervalo_w		smallint;
qt_min_intervalo_w		integer;
ds_dose_diferenciada_w	varchar(50);
nr_horas_validade_w		integer;
hr_prim_horario_w		varchar(5);
cd_material_w			bigint;
nr_intervalo_w			bigint;
dt_inicio_medic_w		timestamp;
nr_seq_mat_cpoe_w		prescr_material.nr_seq_mat_cpoe%type;
cd_funcao_origem_w		prescr_medica.cd_funcao_origem%type;
qt_dia_prim_hor_w       prescr_material.qt_dia_prim_hor%type;


BEGIN
nr_intervalo_w := 0;
if (nr_prescricao_p IS NOT NULL AND nr_prescricao_p::text <> '') and (nr_seq_material_p IS NOT NULL AND nr_seq_material_p::text <> '') then
	/* Busca os valores necessarios da tabela de prescricao */

	select	max(dt_inicio_prescr),
			max(nr_horas_validade),
			max(cd_funcao_origem)
	into STRICT	dt_inicio_prescricao_w,
			nr_horas_validade_w,
			cd_funcao_origem_w
	from	prescr_medica
	where	nr_prescricao = nr_prescricao_p;

	/* Busca os valores necessarios da tabela de material */

	select	max(cd_material),
			max(cd_intervalo),
			max(ds_horarios),
			max(qt_hora_intervalo),
			max(qt_min_intervalo),
			max(ds_dose_diferenciada),
			max(hr_prim_horario),
			max(nr_seq_mat_cpoe)
	into STRICT	cd_material_w,
			cd_intervalo_w,
			ds_horarios_w,
			qt_hora_intervalo_w,
			qt_min_intervalo_w,
			ds_dose_diferenciada_w,
			hr_prim_horario_w,
			nr_seq_mat_cpoe_w
	from	prescr_material
	where	nr_prescricao 	= nr_prescricao_p
	and		nr_sequencia 	= nr_seq_material_p;

	/* Gera novamente os horarios do medicamento principal  caso tenha algum primeiro horario */

	
	if (hr_prim_horario_w <> '  :  ') and (hr_prim_horario_w IS NOT NULL AND hr_prim_horario_w::text <> '') then
		
		dt_inicio_medic_w := to_date(to_char(coalesce(dt_inicio_medic_p,dt_inicio_prescricao_w),'dd/mm/yyyy')||' '||hr_prim_horario_w||':00','dd/mm/yyyy hh24:mi:ss');
		if (nr_seq_mat_cpoe_w IS NOT NULL AND nr_seq_mat_cpoe_w::text <> '') and (cd_funcao_origem_w = 2314) then
		
			if (dt_inicio_medic_w < dt_inicio_prescricao_w) then
				dt_inicio_medic_w := to_date(to_char(dt_inicio_prescricao_w,'dd/mm/yyyy') || ' ' || hr_prim_horario_w || ':00', 'dd/mm/yyyy hh24:mi:ss') + 1;
				qt_dia_prim_hor_w := 1;
			end if;

			if (qt_dia_prim_hor_w IS NOT NULL AND qt_dia_prim_hor_w::text <> '') then
				update	prescr_material
				set		dt_inicio_medic = dt_inicio_medic_w,
						qt_dia_prim_hor = qt_dia_prim_hor_w
				where	nr_prescricao = nr_prescricao_p
				and		nr_sequencia = nr_seq_material_p;
			else
				update	prescr_material
				set		dt_inicio_medic = dt_inicio_medic_w
				where	nr_prescricao = nr_prescricao_p
				and		nr_sequencia = nr_seq_material_p;
			end if;
		
			SELECT * FROM Calcular_horario_prescricao(	nr_prescricao_p, cd_intervalo_w, dt_inicio_prescricao_w, dt_inicio_medic_w, nr_horas_validade_w, cd_material_w, qt_hora_intervalo_w, qt_min_intervalo_w, nr_intervalo_w, ds_horarios_w, ds_horarios_ww, 'N', ds_dose_diferenciada_w, null, null, null, null, 'M', nr_seq_material_p) INTO STRICT nr_intervalo_w, ds_horarios_w, ds_horarios_ww;
		else	

            if ((trunc(dt_inicio_medic_w) > trunc(dt_inicio_prescricao_w)) and (obter_se_interv_superior_24h(cd_intervalo_w,null) = 'S')) then
                    
                update	prescr_material
                set		dt_proxima_dose  = NULL
                where	nr_prescricao = nr_prescricao_p
                and		nr_sequencia = nr_seq_material_p
                and 	(dt_proxima_dose IS NOT NULL AND dt_proxima_dose::text <> '');

            end if;
		
			SELECT * FROM Calcular_Hor_Prescr_Dia(
					nr_prescricao_p, cd_intervalo_w, dt_inicio_prescricao_w, dt_inicio_medic_w, nr_horas_validade_w, cd_material_w, qt_hora_intervalo_w, qt_min_intervalo_w, nr_intervalo_w, ds_horarios_w, ds_horarios_ww, 'N', ds_dose_diferenciada_w, qt_dia_prim_hor_p) INTO STRICT nr_intervalo_w, ds_horarios_w, ds_horarios_ww;
		end if;
		
		ds_horarios_www := ds_horarios_w||ds_horarios_ww;
	else
		ds_horarios_www := ds_horarios_w;
	end if;
	
	/* Atualiza os horarios do medicamento principal */

	update	prescr_material
	set	ds_horarios 	= ds_horarios_www
	where	nr_prescricao 	= nr_prescricao_p
	and	nr_sequencia	= nr_seq_material_p;
	
	/* Para materiais vinculados  */

	update	prescr_material
	set	ds_horarios		= ds_horarios_www,
		qt_dia_prim_hor 		= qt_dia_prim_hor_p,
		dt_inicio_medic		= dt_inicio_medic_p,
		hr_prim_horario		= hr_prim_horario_w
	where	nr_prescricao 		= nr_prescricao_p
	and	nr_sequencia_diluicao	= nr_seq_material_p
	and	ie_agrupador in (3,7,9);

	/* Para kits do medicamento */

	update	prescr_material
	set	ds_horarios	= ds_horarios_www,
		qt_dia_prim_hor 	= qt_dia_prim_hor_p,
		dt_inicio_medic 	= dt_inicio_medic_p,
		hr_prim_horario	= hr_prim_horario_w
	where	nr_prescricao 	= nr_prescricao_p
	and	nr_seq_kit 	= nr_seq_material_p
	and cd_intervalo = cd_intervalo_w;

	commit;

end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE atualiza_dia_prim_hor_assoc ( nr_prescricao_p bigint, nr_seq_material_p bigint, qt_dia_prim_hor_p bigint, dt_inicio_medic_p timestamp) FROM PUBLIC;

