-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_cot_compra_fornec_xml ( nr_cot_compra_p bigint, cd_cgc_p text, ds_razao_social_p text, ds_forma_pagamento_p text, vl_fat_minimo_p text, qt_dias_entrega_p text, dt_validade_proposta_p text, cd_material_p bigint, nr_id_integracao_p text, qt_material_p bigint, vl_unit_material_p text, vl_total_p text, dt_confirmacao_p text, nm_usuario_p text, ds_marca_p text, ie_tipo_interface_p bigint, cd_material_retorno_p bigint, nr_documento_externo_p text, ie_opcao_p bigint, ie_frete_p text, ds_observacao_p text, ds_embalagem_p text, ie_vencedor_p text, cd_cnpj_vencedor_p text, ds_motivo_venc_p text, cd_comprador_ext_p text, cd_estabelecimento_p bigint, qt_embalagem_p text) AS $body$
DECLARE


cd_cnpj_w			pessoa_juridica.cd_cgc%type;
nr_item_cotacao_w			integer;
cd_moeda_w			integer;
cd_condicao_pagto_w		bigint;
ie_frete_w			varchar(1);
cd_estabelecimento_w		smallint;
nr_seq_cot_fornecedor_w		bigint;
nr_sequencia_item_w		bigint;
cd_material_w			integer;
nr_seq_fornec_w			bigint;
qt_entrega_w			double precision;
dt_entrega_w			timestamp;
qt_existe_w			bigint;
cd_cep_w			varchar(15);
sg_estado_w			pessoa_juridica.sg_estado%type;
cd_tipo_pessoa_w			smallint;
cd_estab_w			smallint;
nr_seq_classif_w			bigint;
ds_titulo_w			varchar(255);
ds_comunicado_w			varchar(2000);
ds_forma_pagto_fornec_w		varchar(80);
ie_cadastra_pj_w			varchar(1);
nm_usuarios_adic_w		varchar(255);
nr_Sequencia_w			bigint;
nr_seq_comunic_w			bigint;
cd_perfil_w			varchar(10);
ie_ci_lida_w			varchar(1);
ie_generico_w			varchar(1) := 'N';
ie_grava_mat_retorno_w		varchar(1) := 'S';
ds_observacao_w			varchar(255);
ie_grava_embalag_obs_w		varchar(1);
ie_grava_fat_min_obs_w		varchar(1);
ie_grava_dia_entr_obs_w		varchar(1);
ie_grava_val_prop_obs_w		varchar(1);
ie_grava_comentario_obs_w	varchar(1);
ie_grava_prazo_ent_xml_w	varchar(1);
ie_grava_id_obs_w		varchar(1);
ie_grava_cond_pag_obs_w		varchar(1);
ds_obs_fornec_w			varchar(2000);
qt_job_w				bigint;
qt_integracao_ativa_w		bigint;
/* Se tiver setor na regra, envia CI para os setores */

ds_setor_adicional_w                   	 varchar(2000) := '';
/* Campos da regra Usuario da Regra */

cd_setor_regra_usuario_w		integer;
qt_material_w				double precision;
qt_conv_compra_estoque_w		double precision;
qt_dias_entrega_w			integer;
vl_material_w				double precision;
vl_total_w				double precision;
nr_solic_compra_w			bigint;
qt_existe_mat_ret_w		bigint;
ie_grava_vencedor_we_w		varchar(1);
ie_marca_cot_importacao_w	varchar(1);
nm_usuario_montagem_w		varchar(40);
ds_marca_w			varchar(30);
qt_registros_w			bigint;
ie_cadastra_marca_imp_cot_w	varchar(1);
nr_seq_marca_w			marca.nr_sequencia%type;
nr_seq_tipo_marca_w		parametro_compras.nr_seq_tipo_marca%type;
cd_curp_w			pessoa_juridica.cd_curp%type := '';
cd_rfc_w			pessoa_juridica.cd_rfc%type := '';
ie_campo_cnpj_w			varchar(15) := 'CNPJ';
qt_embalagem_w			double precision;
ds_condicao_pagamento_w		condicao_pagamento.ds_condicao_pagamento%type;
ie_forma_pagto_w		cot_compra_forn.ie_forma_pagto%type;
qt_regitros_w			bigint;
nr_seq_pais_w			varchar(15);

c01 CURSOR FOR
SELECT	distinct nr_solic_compra
from (
	SELECT	nr_solic_compra
	from	cot_compra_item
	where	nr_cot_compra = nr_cot_compra_p
	and	nr_solic_compra > 0
	
union

	select	nr_solic_compra
	from	cot_compra_solic_agrup
	where	nr_cot_compra = nr_cot_compra_p
	and	nr_solic_compra > 0) alias0;

c02 CURSOR FOR
SELECT	cd_estabelecimento
from	estabelecimento
where	ie_situacao = 'A';

c05 CURSOR FOR
SELECT	coalesce(a.cd_setor_atendimento,0) cd_setor_atendimento
from	regra_envio_comunic_usu a
where	a.nr_seq_evento = nr_sequencia_w;


BEGIN


begin
qt_embalagem_w := qt_embalagem_p;
exception when others then
qt_embalagem_w := null;
end;

select	coalesce(max(cd_estabelecimento),cd_estabelecimento_p)
into STRICT	cd_estabelecimento_w
from	cot_compra
where	nr_cot_compra	= nr_cot_compra_p;

cd_material_w	:= cd_material_p;

select	pkg_i18n.get_estab_locale
into STRICT	nr_seq_pais_w
;

if (coalesce(nr_seq_pais_w,'pt_BR') = 'es_MX') then /*Mexico*/
	
	qt_material_w	:= qt_material_p;
else
	qt_material_w	:= replace(qt_material_p,'.',',');
end if;

begin
	/* valor unit e total vem fixo com decimal , da integracao */

	vl_material_w	:= to_number(vl_unit_material_p, '999999999D9999', 'NLS_NUMERIC_CHARACTERS='',.''');
	vl_total_w	:= to_number(vl_total_p, '999999999D9999', 'NLS_NUMERIC_CHARACTERS='',.''');

	/* plataforma Delphi nao possui mesmo tratamento do Java e HTML5, portanto devera ser tratado quando ocorre erro, conforme abaixo */

	exception
	when others then
		begin
			if (coalesce(nr_seq_pais_w,'pt_BR') = 'es_MX') then /*Mexico*/
	
				vl_material_w	:= vl_unit_material_p;
				vl_total_w	:= vl_total_p;
			else
				vl_material_w	:= replace(vl_unit_material_p,'.',',');
				vl_total_w	:= replace(vl_total_p,'.',',');
			end if;
		end;
end;
	
	
if (coalesce(cd_comprador_ext_p,'0') <> '0') then
	begin

	select	coalesce(max(cd_interno),nm_usuario_p)
	into STRICT	nm_usuario_montagem_w
	from	conversao_meio_externo
	where	upper(nm_tabela)		= 'USUARIO'
	and	upper(nm_atributo)	= 'NM_USUARIO'
	and	ie_sistema_externo		= 'B'
	and	cd_externo		= cd_comprador_ext_p;

	end;
else
	nm_usuario_montagem_w	:= nm_usuario_p;
end if;

select	coalesce(max(qt_conv_compra_estoque),0)
into STRICT	qt_conv_compra_estoque_w
from	material
where	cd_material = cd_material_w;

if (obter_dados_parametro_compras(cd_estabelecimento_w, 24) = 'S') and (qt_conv_compra_estoque_w > 0) then
	qt_material_w := dividir(qt_material_w, qt_conv_compra_estoque_w);
	vl_material_w	:= vl_material_w * qt_conv_compra_estoque_w;
	vl_total_w	:= vl_total_w * qt_conv_compra_estoque_w;
end if;

select	cd_moeda_padrao,
	cd_condicao_pagamento_padrao,
	coalesce(ie_grava_embalag_obs,'N'),
	coalesce(ie_grava_fat_min_obs,'N'),
	coalesce(ie_grava_dia_entr_obs,'N'),
	coalesce(ie_grava_val_prop_obs,'N'),
	coalesce(ie_grava_comentario_obs,'S'),
	coalesce(ie_grava_prazo_ent_xml,'S'),
	coalesce(ie_grava_id_obs,'N'),
	coalesce(ie_grava_cond_pag_obs,'S'),
	coalesce(ie_grava_vencedor_cot_we,'N'),
	coalesce(ie_marca_cot_importacao,'A'),
	coalesce(ie_cadastra_marca_imp_cot,'N'),
	nr_seq_tipo_marca,
	coalesce(ie_cad_pj_importa_cot,'S'),
	coalesce(ie_imp_mat_generico,'N'),
	coalesce(ie_cod_fornec_integracao,'CNPJ')
into STRICT	cd_moeda_w,
	cd_condicao_pagto_w,
	ie_grava_embalag_obs_w,
	ie_grava_fat_min_obs_w,
	ie_grava_dia_entr_obs_w,
	ie_grava_val_prop_obs_w,
	ie_grava_comentario_obs_w,
	ie_grava_prazo_ent_xml_w,
	ie_grava_id_obs_w,
	ie_grava_cond_pag_obs_w,
	ie_grava_vencedor_we_w,
	ie_marca_cot_importacao_w,
	ie_cadastra_marca_imp_cot_w,
	nr_seq_tipo_marca_w,
	ie_cadastra_pj_w,
	ie_generico_w,
	ie_campo_cnpj_w
from	parametro_compras
where	cd_estabelecimento	= cd_estabelecimento_w;

if (ie_campo_cnpj_w = 'CNPJ') then /*Padrao do Brasil*/
	cd_cnpj_w	:= cd_cgc_p;
	
elsif (ie_campo_cnpj_w = 'RFC') then	
	select	coalesce(max(cd_cgc),'0') /*Padrao do Mexico*/
	into STRICT	cd_cnpj_w
	from	pessoa_juridica
	where	ie_situacao = 'A'
	and	cd_rfc = cd_cgc_p;

	cd_rfc_w	:= cd_cgc_p;
	
elsif (ie_campo_cnpj_w = 'CURP') then /*Pode ser usado no Mexico, pois ele usam o CURP*/
	
	select	coalesce(max(cd_cgc),'0')
	into STRICT	cd_cnpj_w
	from	pessoa_juridica
	where	ie_situacao = 'A'
	and	cd_curp = cd_cgc_p;
	
	cd_curp_w	:= cd_cgc_p;
end if;

if (ie_campo_cnpj_w = 'CNPJ') and (length(cd_cnpj_w) <> 14) then
	/*(-20111,'CNPJ =' || cd_cnpj_w || ' nao possui 14 posicoes.');*/

	CALL wheb_mensagem_pck.exibir_mensagem_abort(202562,'CD_CGC=' || cd_cnpj_w);
end if;

update	cot_compra
set	ie_tipo_integracao_receb = ie_tipo_interface_p
where	nr_cot_compra = nr_cot_compra_p;

update	cot_compra
set	nr_documento_externo = nr_documento_externo_p
where	nr_cot_compra = nr_cot_compra_p
and	coalesce(nr_documento_externo::text, '') = '';

select	count(*)
into STRICT	qt_existe_w
from	pessoa_juridica
where	cd_cgc		= cd_cnpj_w;

if (ie_cadastra_pj_w = 'S') and (qt_existe_w = '0') then

	select	coalesce(cd_cep,0),
		coalesce(sg_estado,'SP')
	into STRICT	cd_cep_w,
		sg_estado_w
	from	pessoa_juridica
	where	cd_cgc = obter_cgc_estabelecimento(cd_estabelecimento_w);

	select	coalesce(max(cd_tipo_pessoa_bionexo),0 )
	into STRICT	cd_tipo_pessoa_w
	from	parametro_compras
	where	cd_estabelecimento = cd_estabelecimento_w;
	
	if (cd_tipo_pessoa_w = 0) then
	
		select	min(cd_tipo_pessoa)
		into STRICT	cd_tipo_pessoa_w
		from	pessoa_juridica
		where	ie_situacao = 'A';
	end if;
	
	if	((ie_campo_cnpj_w = 'RFC') or (ie_campo_cnpj_w = 'CURP')) then		
		cd_cnpj_w := inserir_seq_forn_interna(cd_cnpj_w, cd_tipo_pessoa_w);
	end if;
	
	insert into pessoa_juridica(
		cd_cgc,
		ds_razao_social,
		nm_fantasia,
		cd_cep,
		ds_endereco,
		ds_municipio,
		sg_estado,
		dt_atualizacao,
		nm_usuario,
		cd_tipo_pessoa,
		ie_prod_fabric,
		ie_situacao,
		dt_atualizacao_nrec,
		nm_usuario_nrec,
		cd_rfc,
		cd_curp)
	values (	cd_cnpj_w,
		substr(ds_razao_social_p,1,255),
		substr(ds_razao_social_p,1,80),
		cd_cep_w,
		'Bionexo',
		'Bionexo',
		sg_estado_w,
		clock_timestamp(),
		nm_usuario_p,
		cd_tipo_pessoa_w,
		'N',
		'A',
		clock_timestamp(),
		nm_usuario_p,
		cd_rfc_w,
		cd_curp_w);
	
	/*Realiza a integracao com a bionexo atraves do evento 178 'Solicita Fornecedor (178)' */

	CALL gravar_agend_integracao(178,'cd_cnpj=' || cd_cnpj_w || ';');
	
	open C02;
	loop
	fetch C02 into	
		cd_estab_w;
	EXIT WHEN NOT FOUND; /* apply on C02 */
		begin
		
		insert into pessoa_juridica_estab(
			nr_sequencia,
			cd_cgc,
			cd_estabelecimento,
			dt_atualizacao,
			nm_usuario,
			ie_conta_dif_nf,
			ie_rateio_adiant,
			ie_retem_iss)
		values (	nextval('pessoa_juridica_estab_seq'),
			cd_cnpj_w,
			cd_estab_w,
			clock_timestamp(),
			nm_usuario_p,
			'N',
			'P',
			'N');	
		end;
	end loop;
	close C02;

	select	count(*)
	into STRICT	qt_integracao_ativa_w
	from	cliente_integracao
	where	nr_seq_inf_integracao = 290
	and	ie_situacao = 'A';
	
	select	count(*)
	into STRICT	qt_job_w
	from	job_v
	where	upper(comando) like '%ENVIAR_COT_COMPRA_INTEGRACAO%';
	
	
	if (qt_job_w > 0) and (qt_integracao_ativa_w > 0) then	
		CALL envia_pesssoa_jur_fila_transm(cd_cnpj_w, nm_usuario_p);	
	end if;
	
	select	obter_classif_comunic('F')
	into STRICT	nr_seq_classif_w
	;
	
	select	coalesce(max(b.nr_sequencia),0),
		max(cd_perfil)
	into STRICT	nr_sequencia_w,
		cd_perfil_w
	from	regra_envio_comunic_compra a,
		regra_envio_comunic_evento b
	where	a.nr_sequencia = b.nr_seq_regra
	and	a.cd_funcao = 6
	and	b.cd_evento = 23
	and	b.ie_situacao = 'A'
	and	a.cd_estabelecimento = cd_estabelecimento_w
	and	substr(obter_se_envia_ci_regra_compra(b.nr_sequencia,nr_cot_compra_p,'CC',obter_perfil_ativo,nm_usuario_p,null),1,1) = 'S';

	if (nr_sequencia_w = 0) then
		ds_titulo_w	:= wheb_mensagem_pck.get_texto(301329);
		ds_comunicado_w	:= wheb_mensagem_pck.get_texto(301331,'DS_RETORNO1='||nr_cot_compra_p||';DS_RETORNO2='||cd_cnpj_w || ' - ' || substr(ds_razao_social_p,1,80));
	else
		select	coalesce(ie_ci_lida,'N')
		into STRICT	ie_ci_lida_w
		from 	regra_envio_comunic_evento
		where 	nr_sequencia = nr_sequencia_w;
		
		select	ds_titulo,
			nm_usuarios_adic,
		substr(
		replace_macro(
		replace_macro(
		replace_macro(ds_comunicacao,
			'@nr_cot_compra',nr_cot_compra_p),
			'@cnpj', cd_cnpj_w),
			'@razao_social',ds_razao_social_p),1,2000)
		into STRICT	ds_titulo_w,
			nm_usuarios_adic_w,
			ds_comunicado_w
		from	regra_envio_comunic_evento
		where	nr_sequencia = nr_sequencia_w;
	end if;	
	
	open C05;
	loop
	fetch C05 into	
		cd_setor_regra_usuario_w;
	EXIT WHEN NOT FOUND; /* apply on C05 */
		begin
		if (cd_setor_regra_usuario_w <> 0) and (obter_se_contido_char(cd_setor_regra_usuario_w, ds_setor_adicional_w) = 'N') then
			ds_setor_adicional_w := substr(ds_setor_adicional_w || cd_setor_regra_usuario_w || ',',1,2000);
		end if;
		end;
	end loop;
	close C05;

	if (cd_perfil_w IS NOT NULL AND cd_perfil_w::text <> '') then
		cd_perfil_w := cd_perfil_w ||',';
	end if;

	select	nextval('comunic_interna_seq')
	into STRICT	nr_seq_comunic_w
	;

	insert	into comunic_interna(
		dt_comunicado,
		ds_titulo,
		ds_comunicado,
		nm_usuario,
		dt_atualizacao,	
		ie_geral,
		nm_usuario_destino,
		nr_sequencia,
		ie_gerencial,
		nr_seq_classif,
		dt_liberacao,
		ds_perfil_adicional,
		ds_setor_adicional)
	values (	clock_timestamp(),
		ds_titulo_w,
		ds_comunicado_w,
		nm_usuario_p,
		clock_timestamp(),
		'N',
		nm_usuario_p || ',' || nm_usuarios_adic_w,
		nr_seq_comunic_w,
		'N',
		nr_seq_classif_w,
		clock_timestamp(),
		cd_perfil_w,
		ds_setor_adicional_w);

	/*Para que a comunicacao seja gerada como lida ao proprio usuario */

	if (ie_ci_lida_w = 'S') then
		insert into comunic_interna_lida(nr_sequencia,nm_usuario,dt_atualizacao)values (nr_seq_comunic_w,nm_usuario_p,clock_timestamp());
	end if;

end if;

if (ie_opcao_p = 0) then

	ds_forma_pagto_fornec_w := '';

	select	max(cd_interno)
	into STRICT	ds_forma_pagto_fornec_w
	from	conversao_meio_externo
	where	upper(nm_tabela) = 'CONDICAO_PAGAMENTO'
	and	upper(nm_atributo) = 'CD_CONDICAO_PAGAMENTO'
	and	ie_sistema_externo = 'B'
	and	cd_externo = ds_forma_pagamento_p;

	select	coalesce(max(cd_condicao_pagamento),cd_condicao_pagto_w)
	into STRICT	cd_condicao_pagto_w
	from	condicao_pagamento
	where	upper(cd_condicao_pagamento) = upper(coalesce(ds_forma_pagto_fornec_w,ds_forma_pagamento_p));

	select	count(*)
	into STRICT	qt_existe_w
	from	condicao_pagamento
	where	cd_condicao_pagamento = cd_condicao_pagto_w
	and	ie_situacao = 'A';

	if (qt_existe_w = 0) then		
		CALL wheb_mensagem_pck.exibir_mensagem_abort(336344, 'CD_COND_PAGTO_W='|| cd_condicao_pagto_w);
	else
		select	ds_condicao_pagamento
		into STRICT	ds_condicao_pagamento_w
		from	condicao_pagamento
		where	cd_condicao_pagamento = cd_condicao_pagto_w;
	end if;

end if;

select	count(*)
into STRICT	qt_existe_w
from	pessoa_juridica
where	cd_cgc		= cd_cnpj_w;

if (cd_cnpj_w <> '0') and (ie_opcao_p = 0) and (qt_existe_w > 0) then
	begin
	
	update	cot_compra_item
	set	cd_cgc_fornecedor_venc_alt 	 = NULL,
		ds_motivo_venc_alt		 = NULL,
		nr_seq_cot_item_forn		 = NULL
	where	nr_cot_compra			= nr_cot_compra_p;

	
	if (upper(ie_frete_p) = 'FOB') then
		ie_frete_w := 'F';
	else
		ie_frete_w := 'C';
	end if;

	if (ie_grava_cond_pag_obs_w = 'S') and (ds_forma_pagamento_p IS NOT NULL AND ds_forma_pagamento_p::text <> '') then
		ds_obs_fornec_w := substr(ds_obs_fornec_w || wheb_mensagem_pck.get_Texto(315982) || ds_forma_pagamento_p || ' - ' || ds_condicao_pagamento_w || chr(13) || chr(10),1,2000);
	end if;							/*Cond. Pagto: */
	
	if (ie_grava_id_obs_w = 'S') and (nr_documento_externo_p IS NOT NULL AND nr_documento_externo_p::text <> '') then		
		ds_obs_fornec_w := substr(ds_obs_fornec_w || wheb_mensagem_pck.get_Texto(315983) || nr_documento_externo_p || chr(13) || chr(10),1,2000);
	end if;							/*ID: */
	
	if (ie_grava_fat_min_obs_w = 'S') and (vl_fat_minimo_p IS NOT NULL AND vl_fat_minimo_p::text <> '') then
		ds_obs_fornec_w := substr(ds_obs_fornec_w || wheb_mensagem_pck.get_Texto(315984) || campo_mascara_virgula_casas(vl_fat_minimo_p,4) || chr(13) || chr(10),1,2000);
	end if;							/*Fat. Min.: */
	
	if (ie_grava_dia_entr_obs_w = 'S') and (qt_dias_entrega_p IS NOT NULL AND qt_dias_entrega_p::text <> '') then
		ds_obs_fornec_w := substr(ds_obs_fornec_w || wheb_mensagem_pck.get_Texto(315985) || qt_dias_entrega_p || chr(13) || chr(10),1,2000);
	end if;							/*Prazo entr.:*/
	
	if (ie_grava_val_prop_obs_w = 'S') and (dt_validade_proposta_p IS NOT NULL AND dt_validade_proposta_p::text <> '') then
		ds_obs_fornec_w := substr(ds_obs_fornec_w || wheb_mensagem_pck.get_Texto(315986) || dt_validade_proposta_p || chr(13) || chr(10),1,2000);
	end if;							/*Validade Prop.: */
	
	if (ds_observacao_p IS NOT NULL AND ds_observacao_p::text <> '') then
		ds_obs_fornec_w := substr(ds_obs_fornec_w || ' OBS: ' || ds_observacao_p || chr(13) || chr(10),1,2000);
	end if;
	
	
	if (ie_grava_prazo_ent_xml_w = 'S') then
		begin
		qt_dias_entrega_w := (qt_dias_entrega_p)::numeric;
		exception
		when others then
			qt_dias_entrega_w := null;
		end;
	end if;
	
	select	coalesce(max(nr_sequencia),0)
	into STRICT	nr_seq_cot_fornecedor_w
	from	cot_compra_forn
	where	nr_cot_compra = nr_cot_compra_p
	and	cd_cgc_fornecedor = cd_cnpj_w;
	
	select	coalesce(max(ie_forma_pagto),'')
	into STRICT	ie_forma_pagto_w
	from	pessoa_juridica_estab
	where	cd_cgc = cd_cnpj_w
	and	cd_estabelecimento = cd_estabelecimento_w;
	
	if (nr_seq_cot_fornecedor_w = 0) then
	
		select	nextval('cot_compra_forn_seq')
		into STRICT	nr_seq_cot_fornecedor_w
		;

		insert	into cot_compra_forn(
			nr_sequencia,
			nr_cot_compra,
			cd_cgc_fornecedor,
			dt_atualizacao,
			nm_usuario,
			ds_observacao,
			cd_moeda,
			cd_condicao_pagamento,
			ie_frete,
			ie_gerado_bionexo,
			ie_status_envio_email_lib,
			qt_dias_entrega,
			ie_forma_pagto)
		values (	nr_seq_cot_fornecedor_w,
			nr_cot_compra_p,
			cd_cnpj_w,
			clock_timestamp(),
			nm_usuario_montagem_w,
			ds_obs_fornec_w,
			cd_moeda_w,
			cd_condicao_pagto_w,
			ie_frete_w,
			'X',
			'N',
			qt_dias_entrega_w,
			ie_forma_pagto_w);
	else
		update	cot_compra_forn
		set	dt_atualizacao		= clock_timestamp(),
			nm_usuario		= nm_usuario_p,
			ds_observacao		= ds_obs_fornec_w,
			cd_moeda		= cd_moeda_w,
			cd_condicao_pagamento	= cd_condicao_pagto_w,
			ie_frete		= ie_frete_w,			
			qt_dias_entrega		= qt_dias_entrega_w,
			ie_forma_pagto		= ie_forma_pagto_w
		where	nr_sequencia		= nr_seq_cot_fornecedor_w;
	
	end if;
	
	open C01;
	loop
	fetch C01 into	
		nr_solic_compra_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin
		
		select	count(*)
		into STRICT	qt_regitros_w
		from	solic_compra
		where	nr_solic_compra = nr_solic_compra_w;
		
		if (qt_regitros_w > 0) then
		
			
			CALL gerar_historico_solic_compra(	
				nr_solic_compra_w,
				wheb_mensagem_pck.get_texto(301340),
				wheb_mensagem_pck.get_texto(301342,'cd_cnpj_w='||cd_cnpj_w||';cd_cnpj_w2='|| substr(obter_nome_pf_pj(null,cd_cnpj_w),1,100)||';NR_COT_COMPRA_P='||nr_cot_compra_p),
				'GF',
				nm_usuario_p);
		end if;

		end;
	end loop;
	close C01;
end;
end if;

select	count(*)
into STRICT	qt_existe_w
from	pessoa_juridica
where	cd_cgc		= cd_cnpj_w;

if (cd_cnpj_w <> '0') and (ie_opcao_p = 1) and (qt_existe_w > 0) then	

	if (coalesce(dt_confirmacao_p::text, '') = '') then
		/*(-20111,'O item ' || cd_material_p || ' no possui data informada no arquivo.');*/

		CALL wheb_mensagem_pck.exibir_mensagem_abort(202567,'CD_MATERIAL=' || cd_material_p);
	end if;

	select	coalesce(max(ie_grava_mat_retorno),'S')
	into STRICT	ie_grava_mat_retorno_w
	from	parametro_compras
	where	cd_estabelecimento = cd_estabelecimento_w;
	
	select	coalesce(max(nr_sequencia),0)
	into STRICT	nr_seq_fornec_w
	from	cot_compra_forn
	where	nr_cot_compra = nr_cot_compra_p
	and	cd_cgc_fornecedor = cd_cnpj_w;	

	if (nr_seq_fornec_w > 0) and (ie_tipo_interface_p in (2,3)) then

		select	coalesce(min(a.nr_item_cot_compra),0)
		into STRICT	nr_item_cotacao_w
		from	cot_compra_item a
		where	a.nr_cot_compra	= nr_cot_compra_p
		and	a.cd_material = cd_material_p
		and	not exists (	SELECT	b.nr_item_cot_compra
					from	cot_compra_forn_item b
					where	b.nr_cot_compra = nr_cot_compra_p
					and	b.nr_seq_cot_forn = nr_seq_fornec_w
					and	b.nr_item_cot_compra = a.nr_item_cot_compra
					and vl_unitario_material > 0);
					
		if (nr_item_cotacao_w = 0) and (ie_generico_w = 'S') then

			select	coalesce(min(a.nr_item_cot_compra),0)
			into STRICT	nr_item_cotacao_w
			from	cot_compra_item a
			where	a.nr_cot_compra	= nr_cot_compra_p
			and	obter_material_generico(a.cd_material) = obter_material_generico(cd_material_p)
			and	not exists (	SELECT	b.nr_item_cot_compra			
						from	cot_compra_forn_item b
						where	b.nr_cot_compra = nr_cot_compra_p
						and	b.nr_seq_cot_forn = nr_seq_fornec_w
						and	b.nr_item_cot_compra = a.nr_item_cot_compra
						and vl_unitario_material > 0);
			
			cd_material_w := obter_material_generico(cd_material_p);						
		end if;					

		if (nr_item_cotacao_w = 0) then

			select	coalesce(min(a.nr_item_cot_compra),0)
			into STRICT	nr_item_cotacao_w
			from	cot_compra_item a,
				cot_compra_item_aceite b
			where	a.nr_cot_compra = b.nr_cot_compra
			and	a.nr_item_cot_compra = b.nr_item_cot_compra
			and	a.nr_cot_compra = nr_cot_compra_p
			and	b.cd_material = cd_material_p
			and	not exists (	SELECT	x.nr_item_cot_compra
						from	cot_compra_forn_item x
						where	x.nr_cot_compra = nr_cot_compra_p
						and	x.nr_seq_cot_forn = nr_seq_fornec_w
						and	x.nr_item_cot_compra = a.nr_item_cot_compra
						and vl_unitario_material > 0);
		end if;

		if (nr_item_cotacao_w = 0) and (ie_generico_w = 'S') then

			select	coalesce(min(a.nr_item_cot_compra),0)
			into STRICT	nr_item_cotacao_w
			from	cot_compra_item a,
				cot_compra_item_aceite b
			where	a.nr_cot_compra = b.nr_cot_compra
			and	a.nr_item_cot_compra = b.nr_item_cot_compra
			and	a.nr_cot_compra = nr_cot_compra_p
			and	obter_material_generico(b.cd_material) = obter_material_generico(cd_material_p)
			and	not exists (	SELECT	x.nr_item_cot_compra
						from	cot_compra_forn_item x
						where	x.nr_cot_compra = nr_cot_compra_p
						and	x.nr_seq_cot_forn = nr_seq_fornec_w
						and	x.nr_item_cot_compra = a.nr_item_cot_compra
						and vl_unitario_material > 0);
			
			cd_material_w := obter_material_generico(cd_material_p);				
		end if;		
				
		if (nr_item_cotacao_w > 0) then
			begin
			
			update	cot_compra_item
			set	ie_situacao = 'A'
			where	nr_cot_compra = nr_cot_compra_p
			and	nr_item_cot_compra = nr_item_cotacao_w
			and	coalesce(ie_situacao,'A') <> 'A';

			select	count(*)
			into STRICT	qt_existe_mat_ret_w
			from	material
			where	cd_material = cd_material_retorno_p;			
			
			if (ie_grava_mat_retorno_w = 'S') and (cd_material_retorno_p <> 0) and (cd_material_retorno_p <> cd_material_p) and (qt_existe_mat_ret_w > 0) then
				cd_material_w := cd_material_retorno_p;

			end if;
			
			if (ie_grava_comentario_obs_w = 'S') then
				ds_observacao_w := substr(ds_observacao_p,1,255);
			end if;
			
			if (ie_grava_embalag_obs_w = 'S') and (ds_embalagem_p IS NOT NULL AND ds_embalagem_p::text <> '') then
				ds_observacao_w := substr(wheb_mensagem_pck.get_texto(301344,'DS_OBSERVACAO_W='||ds_observacao_w||';DS_EMBALAGEM_P='||ds_embalagem_p),1,255);
				if (qt_embalagem_w IS NOT NULL AND qt_embalagem_w::text <> '') then
					ds_observacao_w := substr(ds_observacao_w || ' - ' || qt_embalagem_w,1,255);
				end if;
			end if;		

			ds_marca_w	:= substr(ds_marca_p,1,30);
			
			if (ie_cadastra_marca_imp_cot_w = 'S') and (ds_marca_p IS NOT NULL AND ds_marca_p::text <> '') and (nr_seq_tipo_marca_w > 0) then
				
				select	coalesce(max(nr_seq_marca_w),0)
				into STRICT	nr_seq_marca_w
				from	marca
				where	substr(upper(elimina_acentuacao(ds_marca)),1,30) = substr(upper(elimina_acentuacao(ds_marca_p)),1,30);
				
				if (nr_seq_marca_w = 0) then
					
					select	nextval('marca_seq')
					into STRICT	nr_seq_marca_w
					;
					
					insert into marca(					
						nr_sequencia,
						ds_marca,
						ie_situacao,
						dt_atualizacao,
						nm_usuario,
						nr_seq_tipo,
						dt_atualizacao_nrec,
						nm_usuario_nrec,
						qt_dia_ressup)
					values (	nr_seq_marca_w,
						substr(ds_marca_p,1,30),
						'A',
						clock_timestamp(),
						nm_usuario_p,
						nr_seq_tipo_marca_w,
						clock_timestamp(),
						nm_usuario_p,
						7);
						
					insert into material_marca(
						cd_material,
						nr_sequencia,
						dt_atualizacao,
						nm_usuario,
						dt_atualizacao_nrec,
						nm_usuario_nrec,
						ie_situacao)
					values (	cd_material_w,
						nr_seq_marca_w,
						clock_timestamp(),
						nm_usuario_p,
						clock_timestamp(),
						nm_usuario_p,
						'A');
				else
					select	count(*)
					into STRICT	qt_registros_w
					from	material_marca
					where	cd_material	= cd_material_w
					and	nr_sequencia	= nr_seq_marca_w;
					
					if (qt_registros_w = 0) then
						
						insert into material_marca(
							cd_material,
							nr_sequencia,
							dt_atualizacao,
							nm_usuario,
							dt_atualizacao_nrec,
							nm_usuario_nrec,
							ie_situacao)
						values (	cd_material_w,
							nr_seq_marca_w,
							clock_timestamp(),
							nm_usuario_p,
							clock_timestamp(),
							nm_usuario_p,
							'A');
					end if;
				
				end if;
			end if;
			
			if (ie_marca_cot_importacao_w = 'M') then
				select	substr(obter_marca_material(cd_material_w,'DR'),1,30)
				into STRICT	ds_marca_w
				;
			end if;
			
			
			select	coalesce(max(nr_sequencia),0)
			into STRICT	nr_sequencia_item_w
			from	cot_compra_forn_item
			where	nr_seq_cot_forn = nr_seq_fornec_w
			and	cd_material = cd_material_w;
		


			if (nr_sequencia_item_w = 0) then
			
				select	nextval('cot_compra_forn_item_seq')
				into STRICT	nr_sequencia_item_w
				;

				insert into cot_compra_forn_item(
					nr_sequencia,
					nr_seq_cot_forn,
					nr_cot_compra,
					nr_item_cot_compra,
					cd_cgc_fornecedor,
					qt_material,
					vl_unitario_material,
					vl_unitario_inicial,
					dt_atualizacao,
					nm_usuario,
					vl_preco_liquido,
					vl_total_liquido_item,
					ie_situacao,
					ds_marca,
					ds_marca_fornec,
					cd_material,
					nr_id_integracao,
					ds_observacao)
				values (	nr_sequencia_item_w,
					nr_seq_fornec_w,
					nr_cot_compra_p,
					nr_item_cotacao_w,
					cd_cnpj_w,
					qt_material_w,
					vl_material_w,
					vl_material_w,
					clock_timestamp(),
					nm_usuario_montagem_w,
					vl_total_w,
					vl_total_w,
					'A',
					substr(ds_marca_w,1,30),
					substr(ds_marca_p,1,30),
					cd_material_w,
					nr_id_integracao_p,
					ds_observacao_w);
			else
			
				update cot_compra_forn_item
				set	qt_material			= qt_material_w,
					vl_unitario_material		= vl_material_w,
					dt_atualizacao			= clock_timestamp(),
					nm_usuario			= nm_usuario_montagem_w,
					vl_preco_liquido		= vl_total_w,
					vl_total_liquido_item		= vl_total_w,
					ds_marca			= substr(ds_marca_w,1,30),
					ds_marca_fornec			= substr(ds_marca_p,1,30),
					ds_observacao			= ds_observacao_w,
					nr_id_integracao		= nr_id_integracao_p
				where	nr_sequencia			= nr_sequencia_item_w;		
			
			end if;

			if	((ie_vencedor_p = 'S') or
				(ie_grava_vencedor_we_w = 'S' AND ie_tipo_interface_p = 3)) then
			
				select	count(*)
				into STRICT	qt_existe_w
				from	pessoa_juridica
				where	cd_cgc		= cd_cnpj_vencedor_p;
			
				if (qt_existe_w > 0) then
	
					select	count(*)
					into STRICT	qt_existe_w
					from	cot_compra_forn_item
					where	nr_sequencia = nr_sequencia_item_w
					and	nr_cot_compra = nr_cot_compra_p;
					
					if (qt_existe_w > 0) then
						begin
						update	cot_compra_item
						set	cd_cgc_fornecedor_venc_alt 	= cd_cnpj_vencedor_p,
							ds_motivo_venc_alt		= ds_motivo_venc_p,
							nr_seq_cot_item_forn		= nr_sequencia_item_w
						where	nr_cot_compra			= nr_cot_compra_p
						and	nr_item_cot_compra		= nr_item_cotacao_w;
						end;
					end if;	


				end if;
			end if;			
			
			end;			
		end if;		
		
	elsif (nr_seq_fornec_w > 0) and (ie_tipo_interface_p in (1,4)) then
		
		select	coalesce(min(a.nr_item_cot_compra),0)
		into STRICT	nr_item_cotacao_w
		from	cot_compra_item a
		where	a.nr_cot_compra	= nr_cot_compra_p
		and	a.cd_material = cd_material_p;
		
		if (nr_item_cotacao_w = 0) and (ie_generico_w = 'S') then
			
			select	coalesce(min(a.nr_item_cot_compra),0)
			into STRICT	nr_item_cotacao_w
			from	cot_compra_item a
			where	a.nr_cot_compra	= nr_cot_compra_p
			and	obter_material_generico(a.cd_material) = obter_material_generico(cd_material_p);
			
			cd_material_w := obter_material_generico(cd_material_p);
		end if;		
		
		if (nr_item_cotacao_w = 0) then
			select	coalesce(min(a.nr_item_cot_compra),0)
			into STRICT	nr_item_cotacao_w
			from	cot_compra_item a,
				cot_compra_item_aceite b
			where	a.nr_cot_compra = b.nr_cot_compra
			and	a.nr_item_cot_compra = b.nr_item_cot_compra
			and	a.nr_cot_compra	= nr_cot_compra_p
			and	b.cd_material = cd_material_p;
		end if;
		
		if (nr_item_cotacao_w = 0) and (ie_generico_w = 'S') then
			
			select	coalesce(min(a.nr_item_cot_compra),0)
			into STRICT	nr_item_cotacao_w
			from	cot_compra_item a,
				cot_compra_item_aceite b
			where	a.nr_cot_compra = b.nr_cot_compra
			and	a.nr_item_cot_compra = b.nr_item_cot_compra
			and	a.nr_cot_compra	= nr_cot_compra_p
			and	obter_material_generico(b.cd_material) = obter_material_generico(cd_material_p);
			
			cd_material_w := obter_material_generico(cd_material_p);
		end if;		
		
		update	cot_compra_item
		set	ie_situacao = 'A'
		where	nr_cot_compra = nr_cot_compra_p
		and	nr_item_cot_compra = nr_item_cotacao_w
		and	coalesce(ie_situacao,'A') <> 'A';

		select	count(*)
		into STRICT	qt_existe_mat_ret_w
		from	material
		where	cd_material = cd_material_retorno_p;
		
		if (ie_grava_mat_retorno_w = 'S') and (cd_material_retorno_p <> 0) and (cd_material_retorno_p <> cd_material_p) and (qt_existe_mat_ret_w > 0) then
			cd_material_w := cd_material_retorno_p;
		end if;
		
		ds_observacao_w := substr(ds_observacao_p,1,255);
		if (ie_grava_embalag_obs_w = 'S') and (ds_embalagem_p IS NOT NULL AND ds_embalagem_p::text <> '') then
			ds_observacao_w := substr(wheb_mensagem_pck.get_texto(301344,'DS_OBSERVACAO_W='||ds_observacao_w||';DS_EMBALAGEM_P='||ds_embalagem_p),1,255);
			if (qt_embalagem_w IS NOT NULL AND qt_embalagem_w::text <> '') then
				ds_observacao_w := substr(ds_observacao_w || ' - ' || qt_embalagem_w,1,255);
			end if;
		end if;		
		
		
		if (nr_item_cotacao_w > 0) then
			begin
			
			if (ie_cadastra_marca_imp_cot_w = 'S') and (ds_marca_p IS NOT NULL AND ds_marca_p::text <> '') and (nr_seq_tipo_marca_w > 0) then
				
				select	coalesce(max(nr_seq_marca_w),0)
				into STRICT	nr_seq_marca_w
				from	marca
				where	substr(upper(elimina_acentuacao(ds_marca)),1,30) = substr(upper(elimina_acentuacao(ds_marca_p)),1,30);
				
				if (nr_seq_marca_w = 0) then
					
					select	nextval('marca_seq')
					into STRICT	nr_seq_marca_w
					;
					
					insert into marca(					
						nr_sequencia,
						ds_marca,
						ie_situacao,
						dt_atualizacao,
						nm_usuario,
						nr_seq_tipo,
						dt_atualizacao_nrec,
						nm_usuario_nrec,
						qt_dia_ressup)
					values (	nr_seq_marca_w,
						substr(ds_marca_p,1,30),
						'A',
						clock_timestamp(),
						nm_usuario_p,
						nr_seq_tipo_marca_w,
						clock_timestamp(),
						nm_usuario_p,
						7);
						
					insert into material_marca(
						cd_material,
						nr_sequencia,
						dt_atualizacao,
						nm_usuario,
						dt_atualizacao_nrec,
						nm_usuario_nrec,
						ie_situacao)
					values (	cd_material_w,
						nr_seq_marca_w,
						clock_timestamp(),
						nm_usuario_p,
						clock_timestamp(),
						nm_usuario_p,
						'A');
				else
					select	count(*)
					into STRICT	qt_registros_w
					from	material_marca
					where	cd_material	= cd_material_w
					and	nr_sequencia	= nr_seq_marca_w;
					
					if (qt_registros_w = 0) then
						
						insert into material_marca(
							cd_material,
							nr_sequencia,
							dt_atualizacao,
							nm_usuario,
							dt_atualizacao_nrec,
							nm_usuario_nrec,
							ie_situacao)
						values (	cd_material_w,
							nr_seq_marca_w,
							clock_timestamp(),
							nm_usuario_p,
							clock_timestamp(),
							nm_usuario_p,
							'A');
					end if;
				
				end if;
			end if;			
				
			ds_marca_w	:= substr(ds_marca_p,1,30);
			
			if (ie_marca_cot_importacao_w = 'M') then
				select	substr(obter_marca_material(cd_material_w,'DR'),1,30)
				into STRICT	ds_marca_w
				;
			end if;

			select	coalesce(max(nr_sequencia),0)
			into STRICT	nr_sequencia_item_w
			from	cot_compra_forn_item
			where	nr_seq_cot_forn = nr_seq_fornec_w
			and	cd_material = cd_material_w;			
			
			if (nr_sequencia_item_w = 0) then
		
				select	nextval('cot_compra_forn_item_seq')
				into STRICT	nr_sequencia_item_w
				;

				insert into cot_compra_forn_item(
					nr_sequencia,
					nr_seq_cot_forn,
					nr_cot_compra,
					nr_item_cot_compra,
					cd_cgc_fornecedor,
					qt_material,
					vl_unitario_material,
					vl_unitario_inicial,				
					dt_atualizacao,
					nm_usuario,
					vl_preco_liquido,
					vl_total_liquido_item,
					ie_situacao,
					ds_marca,
					ds_marca_fornec,
					cd_material,
					nr_id_integracao,
					ds_observacao)
				values (	nr_sequencia_item_w,
					nr_seq_fornec_w,
					nr_cot_compra_p,
					nr_item_cotacao_w,
					cd_cnpj_w,
					qt_material_w,
					vl_material_w,
					vl_material_w,
					clock_timestamp(),
					nm_usuario_montagem_w,
					vl_total_w,
					vl_total_w,
					'A',
					substr(ds_marca_w,1,30),
					substr(ds_marca_p,1,30),
					cd_material_w,
					nr_id_integracao_p,
					ds_observacao_w);
			else
			
				update	cot_compra_forn_item
				set	qt_material			= qt_material_w,
					vl_unitario_material		= vl_material_w,
					dt_atualizacao			= clock_timestamp(),
					nm_usuario			= nm_usuario_montagem_w,
					vl_preco_liquido		= vl_total_w,
					vl_total_liquido_item		= vl_total_w,
					ds_marca			= substr(ds_marca_w,1,30),
					ds_marca_fornec			= substr(ds_marca_p,1,30),
					ds_observacao			= ds_observacao_w,
					nr_id_integracao		= nr_id_integracao_p
				where	nr_sequencia			= nr_Sequencia_w;			
			end if;
				
			if (ie_vencedor_p = 'S') then
			
				select	count(*)
				into STRICT	qt_existe_w
				from	pessoa_juridica
				where	cd_cgc		= cd_cnpj_vencedor_p;
			
				if (qt_existe_w > 0) then
					update	cot_compra_item
					set	cd_cgc_fornecedor_venc_alt 	= cd_cnpj_vencedor_p,
						ds_motivo_venc_alt		= ds_motivo_venc_p,
						nr_seq_cot_item_forn		= nr_sequencia_item_w
					where	nr_cot_compra			= nr_cot_compra_p
					and	nr_item_cot_compra		= nr_item_cotacao_w;
				end if;
			end if;
			end;
		end if;
	end if;
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_cot_compra_fornec_xml ( nr_cot_compra_p bigint, cd_cgc_p text, ds_razao_social_p text, ds_forma_pagamento_p text, vl_fat_minimo_p text, qt_dias_entrega_p text, dt_validade_proposta_p text, cd_material_p bigint, nr_id_integracao_p text, qt_material_p bigint, vl_unit_material_p text, vl_total_p text, dt_confirmacao_p text, nm_usuario_p text, ds_marca_p text, ie_tipo_interface_p bigint, cd_material_retorno_p bigint, nr_documento_externo_p text, ie_opcao_p bigint, ie_frete_p text, ds_observacao_p text, ds_embalagem_p text, ie_vencedor_p text, cd_cnpj_vencedor_p text, ds_motivo_venc_p text, cd_comprador_ext_p text, cd_estabelecimento_p bigint, qt_embalagem_p text) FROM PUBLIC;

