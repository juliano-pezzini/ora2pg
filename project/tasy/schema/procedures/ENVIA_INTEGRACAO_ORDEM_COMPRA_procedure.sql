-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE envia_integracao_ordem_compra ( nr_ordem_compra_p bigint, nm_usuario_p text) AS $body$
DECLARE


nr_seq_integracao_w		bigint;
nr_seq_regra_w			bigint;
ie_momento_integ_w		varchar(2);

dt_liberacao_w			timestamp;
dt_aprovacao_w			timestamp;
cd_local_entrega_w		smallint;
cd_estabelecimento_w		integer;
cd_cgc_fornecedor_w		varchar(14);
cd_condicao_pagamento_w		bigint;
cd_comprador_w			varchar(10);
dt_ordem_compra_w		timestamp;
cd_moeda_w			integer;
cd_pessoa_solicitante_w		varchar(10);
cd_cgc_transportador_w		varchar(14);
ie_frete_w			varchar(1);
vl_frete_w			double precision;
pr_desconto_w			double precision;
pr_desc_pgto_antec_w		double precision;
pr_juros_negociado_w		double precision;
ds_pessoa_contato_w		varchar(255);
ds_observacao_w			varchar(4000);
dt_entrega_w			timestamp;
ie_aviso_chegada_w		varchar(1);
vl_despesa_acessoria_w		double precision;
nr_seq_subgrupo_compra_w		bigint;
pr_desc_financeiro_w		double precision;
cd_pessoa_fisica_w		varchar(255);
ie_urgente_w			varchar(1);
nr_seq_forma_pagto_w		bigint;
nr_documento_externo_w		bigint;
vl_desconto_w			double precision;
cd_centro_custo_w		integer;


BEGIN

select	dt_liberacao,
	dt_aprovacao,
	cd_local_entrega
into STRICT	dt_liberacao_w,
	dt_aprovacao_w,
	cd_local_entrega_w
from	ordem_compra
where	nr_ordem_compra = nr_ordem_compra_p;

select	max(nr_sequencia)
into STRICT	nr_seq_integracao_w
from	sup_parametro_integracao a
where	a.ie_evento = 'OC'
and	a.ie_forma = 'E'
and	a.ie_situacao = 'A';

select	coalesce(max(nr_sequencia),0)
into STRICT	nr_seq_regra_w
from	sup_int_regra_oc
where	nr_seq_integracao = nr_seq_integracao_w
and	cd_local_entrega = cd_local_entrega_w
and	ie_situacao = 'A';

if (nr_seq_regra_w <> 0) then
	begin

	select	coalesce(max(ie_lib_aprov),'L')
	into STRICT	ie_momento_integ_w
	from	sup_int_regra_oc
	where	nr_sequencia = nr_seq_regra_w;

	end;
else
	begin

	select	coalesce(max(nr_sequencia),0)
	into STRICT	nr_seq_regra_w
	from	sup_int_regra_oc
	where	nr_seq_integracao = nr_seq_integracao_w
	and	ie_situacao = 'A';

	select	coalesce(max(ie_lib_aprov),'L')
	into STRICT	ie_momento_integ_w
	from	sup_int_regra_oc
	where	nr_sequencia = nr_seq_regra_w;

	end;
end if;

if (nr_seq_regra_w <> 0) and
	((ie_momento_integ_w = 'A' AND dt_aprovacao_w IS NOT NULL AND dt_aprovacao_w::text <> '') or
	(ie_momento_integ_w = 'L' AND dt_liberacao_w IS NOT NULL AND dt_liberacao_w::text <> '')) then
	begin

	select	cd_estabelecimento,
		cd_cgc_fornecedor,
		cd_condicao_pagamento,
		cd_comprador,
		dt_ordem_compra,
		cd_moeda,
		cd_pessoa_solicitante,
		cd_cgc_transportador,
		ie_frete,
		vl_frete,
		pr_desconto,
		pr_desc_pgto_antec,
		pr_juros_negociado,
		ds_pessoa_contato,
		ds_observacao,
		dt_entrega,
		ie_aviso_chegada,
		vl_despesa_acessoria,
		nr_seq_subgrupo_compra,
		pr_desc_financeiro,
		cd_pessoa_fisica,
		ie_urgente,
		nr_seq_forma_pagto,
		nr_documento_externo,
		vl_desconto,
		cd_centro_custo
	into STRICT	cd_estabelecimento_w,
		cd_cgc_fornecedor_w,
		cd_condicao_pagamento_w,
		cd_comprador_w,
		dt_ordem_compra_w,
		cd_moeda_w,
		cd_pessoa_solicitante_w,
		cd_cgc_transportador_w,
		ie_frete_w,
		vl_frete_w,
		pr_desconto_w,
		pr_desc_pgto_antec_w,
		pr_juros_negociado_w,
		ds_pessoa_contato_w,
		ds_observacao_w,
		dt_entrega_w,
		ie_aviso_chegada_w,
		vl_despesa_acessoria_w,
		nr_seq_subgrupo_compra_w,
		pr_desc_financeiro_w,
		cd_pessoa_fisica_w,
		ie_urgente_w,
		nr_seq_forma_pagto_w,
		nr_documento_externo_w,
		vl_desconto_w,
		cd_centro_custo_w
	from	ordem_compra
	where	nr_ordem_compra = nr_ordem_compra_p;

	envia_sup_int_oc(
		nr_seq_regra_w,
		nr_ordem_compra_p,
		cd_estabelecimento_w,
		cd_cgc_fornecedor_w,
		cd_condicao_pagamento_w,
		cd_comprador_w,
		dt_ordem_compra_w,
		cd_moeda_w,
		cd_pessoa_solicitante_w,
		cd_cgc_transportador_w,
		ie_frete_w,
		vl_frete_w,
		pr_desconto_w,
		pr_desc_pgto_antec_w,
		pr_juros_negociado_w,
		ds_pessoa_contato_w,
		ds_observacao_w,
		cd_local_entrega_w,
		dt_entrega_w,
		ie_aviso_chegada_w,
		vl_despesa_acessoria_w,
		nr_seq_subgrupo_compra_w,
		pr_desc_financeiro_w,
		cd_pessoa_fisica_w,
		ie_urgente_w,
		nr_seq_forma_pagto_w,
		nr_documento_externo_w,
		vl_desconto_w,
		cd_centro_custo_w,
		nm_usuario_p,
		'','','','');

	end;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE envia_integracao_ordem_compra ( nr_ordem_compra_p bigint, nm_usuario_p text) FROM PUBLIC;

