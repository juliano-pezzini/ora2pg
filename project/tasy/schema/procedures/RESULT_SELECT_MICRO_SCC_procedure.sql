-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE result_select_micro_scc ( nr_seq_interno_p prescr_procedimento.nr_seq_interno%TYPE, ds_observacao_p exame_lab_result_item.ds_observacao%TYPE) AS $body$
DECLARE

    nr_prescricao_w        	 prescr_medica.nr_prescricao%TYPE;
    nr_seq_resultado_w     	 exame_lab_resultado.nr_seq_resultado%TYPE;
    nr_seq_result_item_w   	 exame_lab_result_item.nr_sequencia%TYPE;
    nr_seq_exame_w          	 exame_laboratorio.nr_seq_exame%TYPE;
    ds_valor_w             	 exame_lab_valor.ds_valor%TYPE;
    ie_existe_antib_w      	 varchar(1);
    nr_seq_prescr_w        	 bigint;
    nr_resul_integracao_w  	 exame_lab_valor.ie_tipo_valor_integr%TYPE;
    cd_estab_w		         integer;
    ie_desaprovar_atualizar_w	 lab_parametro.ie_atualizar_result_aprov%TYPE;
    dt_aprovacao_exame_w	 exame_lab_result_item.dt_aprovacao%TYPE;
    ie_status_atend_w	         prescr_procedimento.ie_status_atend%type;
    count_w                    	 smallint;


BEGIN

if (coalesce(nr_seq_interno_p::text, '') = '') then
  CALL WHEB_MENSAGEM_PCK.exibir_mensagem_abort(277600);
end if;

select  count(1)
into STRICT    count_w
from    prescr_procedimento c
where   nr_seq_interno = nr_seq_interno_p;

if (count_w = 0)then
 CALL WHEB_MENSAGEM_PCK.exibir_mensagem_abort(1111467,'NR_SEQ_INTERNO='||nr_seq_interno_p);
end if;

    select (nr_prescricao),
        (nr_sequencia),
        (ie_status_atend)
    into STRICT
        nr_prescricao_w,
        nr_seq_prescr_w,
        ie_status_atend_w
    from
        prescr_procedimento
    where
        nr_seq_interno = nr_seq_interno_p;

    if (nr_prescricao_w IS NOT NULL AND nr_prescricao_w::text <> '') then
        select
            max(nr_seq_resultado)
        into STRICT nr_seq_resultado_w
        from
            exame_lab_resultado
        where
            nr_prescricao = nr_prescricao_w;

        select	max(i.nr_sequencia)
        into STRICT nr_seq_result_item_w
        from
            exame_lab_result_item   i,
            exame_laboratorio       e
        where
            i.nr_seq_exame = e.nr_seq_exame
            and i.nr_seq_resultado = nr_seq_resultado_w
            and i.nr_seq_prescr = nr_seq_prescr_w
            and e.ie_formato_resultado IN (
                'SM',
                'SDM'
            );

        select
            CASE WHEN COUNT(*)=0 THEN  'N'  ELSE 'S' END
        into STRICT ie_existe_antib_w
        from
            exame_lab_result_antib a
        where
            a.nr_seq_resultado = nr_seq_resultado_w
            and a.nr_seq_result_item = nr_seq_result_item_w;

        select
                max(nr_seq_exame)
            into STRICT nr_seq_exame_w
            from
                exame_lab_result_item a
            where
                a.nr_seq_resultado = nr_seq_resultado_w
                and a.nr_sequencia = nr_seq_result_item_w;

        if ( ie_existe_antib_w = 'S' ) then
            nr_resul_integracao_w := 1;
        else
            nr_resul_integracao_w := 2;
        end if;

        select
            max(ds_valor)
            into STRICT ds_valor_w
            from
              exame_lab_valor a
            where
              a.nr_seq_exame = nr_seq_exame_w
              and a.ie_tipo_valor_integr = nr_resul_integracao_w;

        if (ds_valor_w IS NOT NULL AND ds_valor_w::text <> '') then
            select	
                cd_estabelecimento
            into STRICT	cd_estab_w
            from	
                prescr_medica
            where	
                nr_prescricao = nr_prescricao_w;

            begin
                select 
                    ie_atualizar_result_aprov
                into STRICT	ie_desaprovar_atualizar_w
                from	
                    lab_parametro
                where	cd_estabelecimento = cd_estab_w;
            exception
                when no_data_found then
                    ie_desaprovar_atualizar_w := 'N';
                when too_many_rows then
                    ie_desaprovar_atualizar_w := 'N';
            end;

            begin
                select 
                    dt_aprovacao
                into STRICT	dt_aprovacao_exame_w
                from 	
                    exame_lab_result_item
                where	
                    nr_seq_resultado = nr_seq_resultado_w
                    and nr_sequencia = nr_seq_result_item_w;
            exception
                when no_data_found then
                    dt_aprovacao_exame_w := null;
                when too_many_rows then
                    dt_aprovacao_exame_w := null;
            end;

            if (ie_desaprovar_atualizar_w = 'S') and ((dt_aprovacao_exame_w IS NOT NULL AND dt_aprovacao_exame_w::text <> '') or (ie_status_atend_w >= 35)) then
            
                update	exame_lab_result_item
                set	
                    dt_aprovacao  = NULL
                where 
                    nr_seq_resultado = nr_seq_resultado_w
                    and nr_sequencia = nr_seq_result_item_w;

                update  prescr_procedimento
                set
                    ie_status_atend = 30
                where
                    nr_seq_interno = nr_seq_interno_p;

            end if;

            update exame_lab_result_item
            set
                ds_resultado = ds_valor_w,
                ds_observacao = ds_observacao_p
            where
                nr_seq_resultado = nr_seq_resultado_w
                and nr_sequencia = nr_seq_result_item_w;

            commit;
        end if;

    end if;

    commit;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE result_select_micro_scc ( nr_seq_interno_p prescr_procedimento.nr_seq_interno%TYPE, ds_observacao_p exame_lab_result_item.ds_observacao%TYPE) FROM PUBLIC;

