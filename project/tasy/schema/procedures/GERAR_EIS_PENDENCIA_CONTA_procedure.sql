-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_eis_pendencia_conta ( dt_pendencia_p timestamp, nm_usuario_p text) AS $body$
DECLARE

 
dt_inicial_w			timestamp;
dt_final_w			timestamp;
nr_seq_tipo_w			bigint;
nr_seq_estagio_w		bigint;
cd_setor_atendimento_w		integer;
cd_convenio_w			integer;
nr_sequencia_w			bigint;
nr_atendimento_w		bigint;
nr_interno_conta_w		bigint;
dt_pendencia_w			timestamp;
cd_medico_w			varchar(10);
nr_seq_classif_pend_w		bigint;
nr_seq_regra_resp_w		bigint;
qt_dias_pend_w			bigint;
vl_conta_w			double precision;

C01 CURSOR FOR 
	SELECT	nr_seq_tipo, 
		a.nr_seq_estagio, 
		a.cd_setor_atendimento, 
		coalesce(obter_conv_conta(a.nr_interno_conta),obter_convenio_atendimento(a.nr_atendimento)) cd_convenio, 
		a.nr_atendimento, 
		coalesce(a.nr_interno_conta,0) nr_interno_conta, 
		a.dt_pendencia, 
		a.cd_medico, 
		obter_classificacao_pend(a.nr_seq_tipo) nr_seq_classif_pend, 
		nr_seq_regra_resp, 
		coalesce(trunc(coalesce(dt_fechamento,clock_timestamp()) - dt_pendencia,0),0) 
	from	cta_pendencia a 
	where	a.dt_pendencia between dt_inicial_w and dt_final_w;
	
	 

BEGIN 
 
dt_inicial_w	:= trunc(dt_pendencia_p, 'month');
dt_final_w		:= fim_dia(last_day(dt_pendencia_p));
 
delete	from eis_pendencia_conta 
where	trunc(dt_pendencia,'month') between dt_inicial_w and dt_final_w;
 
commit;
 
open C01;
loop 
fetch C01 into	 
	nr_seq_tipo_w, 
	nr_seq_estagio_w,		 
	cd_setor_atendimento_w,		 
	cd_convenio_w, 
	nr_atendimento_w, 
	nr_interno_conta_w, 
	dt_pendencia_w, 
	cd_medico_w, 
	nr_seq_classif_pend_w, 
	nr_seq_regra_resp_w, 
	qt_dias_pend_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin	 
	if (nr_interno_conta_w > 0) then 
		select 	coalesce(max(vl_conta),0) 
		into STRICT	vl_conta_w 
		from	conta_paciente 
		where	nr_interno_conta	= nr_interno_conta_w;
	end if;
	 
	select	nextval('eis_pendencia_conta_seq') 
	into STRICT	nr_sequencia_w 
	;
	 
	insert into eis_pendencia_conta(	 
				nr_seq_tipo, 
				nr_seq_estagio, 
				cd_setor_atendimento, 
				cd_convenio, 
				nr_atendimento, 
				nr_interno_conta, 
				nr_sequencia, 
				dt_atualizacao, 
				nm_usuario, 
				nm_usuario_nrec, 
				dt_pendencia, 
				cd_medico, 
				nr_seq_classif_pend, 
				nr_seq_regra_resp, 
				qt_dias_pend, 
				vl_conta) 
			values (	nr_seq_tipo_w, 
				nr_seq_estagio_w, 
				cd_setor_atendimento_w, 
				cd_convenio_w, 
				nr_atendimento_w, 
				nr_interno_conta_w, 
				nr_sequencia_w, 
				clock_timestamp(), 
				nm_usuario_p, 
				nm_usuario_p, 
				dt_pendencia_w, 
				cd_medico_w, 
				nr_seq_classif_pend_w, 
				nr_seq_regra_resp_w, 
				qt_dias_pend_w, 
				vl_conta_w);	
	end;
end loop;
close C01;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_eis_pendencia_conta ( dt_pendencia_p timestamp, nm_usuario_p text) FROM PUBLIC;

