-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_w_linhas_danfe ( nr_sequencia_p bigint, nm_usuario_p text) AS $body$
DECLARE


nr_count_w			bigint;
nm_usuario_w			varchar(15);
qt_transp_w			bigint;
qt_vencimento_w			bigint;
qt_iss_w			bigint;
nr_pagina_w			bigint:=0;
nr_linha_w			bigint:=0;
qt_retorno_w			bigint:=0;
cd_material_w	 		bigint;
ds_material_w			varchar(255);
cd_ncm_w			varchar(20);
cd_cst_w			varchar(5);
cd_cfop_w			varchar(80);
cd_unidade_medida_compra_w	varchar(30);
qt_item_nf_w			bigint;
vl_unitario_item_nf_w		double precision;
vl_total_item_nf_w		double precision;
vl_base_calc_icms_w		double precision;
vl_icms_w			double precision;
vl_ipi_w			double precision;
vl_aliq_icms_w			double precision;
vl_aliq_ipi_w			double precision;
nr_item_nf_w			integer;
ds_complemento_w		varchar(255);

C01 CURSOR FOR
SELECT	*
from (	
	SELECT	a.cd_material,
		upper(substr(b.ds_material,1,120)) ds_produto,
		n.cd_ncm ncm,
		lpad(f.ie_origem_mercadoria,1,'0')||lpad(f.ie_tributacao_icms,2,'0') cst,
		o.cd_cfop cfop,
		a.cd_unidade_medida_compra ds_unidade,
		a.qt_item_nf qt_produto,
		a.vl_unitario_item_nf vl_unitario,
		a.vl_total_item_nf vl_produto,
		nfe_obter_valor_trib_item(a.nr_sequencia,a.nr_item_nf,'ICMS','BC') vl_base_calc_icms,
		nfe_obter_valor_trib_item(a.nr_sequencia,a.nr_item_nf,'ICMS','TRIB') vl_icms,
		nfe_obter_valor_trib_item(a.nr_sequencia,a.nr_item_nf,'IPI','TRIB') vl_ipi,
		nfe_obter_valor_trib_item(a.nr_sequencia,a.nr_item_nf,'ICMS','TX') vl_aliq_icms,
		nfe_obter_valor_trib_item(a.nr_sequencia,a.nr_item_nf,'IPI','TX') vl_aliq_ipi,
		a.nr_item_nf,
		substr(coalesce(a.ds_complemento,'0'),1,255)
	from    nota_fiscal_item a,
		nota_fiscal y,
		material b,
		material_fiscal f,
		lista_ncm n,
		natureza_operacao o
	where   a.cd_material = b.cd_material
	and    	b.cd_material = f.cd_material
	and	y.nr_sequencia = a.nr_sequencia
	and    	n.nr_sequencia = f.nr_seq_ncm
	and    	o.cd_natureza_operacao = a.cd_natureza_operacao
	and    	a.nr_sequencia =nr_sequencia_p
	
union all
	
	select	a.cd_procedimento cd_material,
		upper(substr(b.ds_procedimento,1,120)) ds_produto,
		'' ncm,
		'' cst,
		o.cd_cfop cfop,
		a.cd_unidade_medida_compra ds_unidade,
		a.qt_item_nf qt_produto,
		a.vl_unitario_item_nf vl_unitario,
		a.vl_total_item_nf vl_produto,
		nfe_obter_valor_trib_item(a.nr_sequencia,a.nr_sequencia_nf,'ICMS','BC') vl_base_calc_icms,
		nfe_obter_valor_trib_item(a.nr_sequencia,a.nr_sequencia_nf,'ICMS','TRIB') vl_icms,
		nfe_obter_valor_trib_item(a.nr_sequencia,a.nr_sequencia_nf,'IPI','TRIB') vl_ipi,
		nfe_obter_valor_trib_item(a.nr_sequencia,a.nr_sequencia_nf,'ICMS','TX') vl_aliq_icms,
		nfe_obter_valor_trib_item(a.nr_sequencia,a.nr_sequencia_nf,'IPI','TX') vl_aliq_ipi,
		a.nr_item_nf,
		substr(coalesce(a.ds_complemento,'0'),1,255)
	from    nota_fiscal_item a,
		nota_fiscal y,
		procedimento b,
		natureza_operacao o
	where   a.cd_procedimento = b.cd_procedimento
	and 	a.ie_origem_proced = b.ie_origem_proced
	and	y.nr_sequencia = a.nr_sequencia
	and    	o.cd_natureza_operacao = a.cd_natureza_operacao
	and    	a.nr_sequencia =nr_sequencia_p
	) alias20
	order by cd_material desc;


BEGIN

Select	count(table_name)
into STRICT	nr_count_w
from	user_tables
where	upper(table_name) = 'W_LINHAS_DANFE';

if (nr_count_w	= 0) then
	CALL exec_sql_dinamico(nm_usuario_p,'create table W_LINHAS_DANFE(cd_material	 			number(15),
									ds_material			varchar2(255),
									cd_ncm				varchar2(20),
									cd_cst				varchar2(5),
									cd_cfop				varchar2(80),
									cd_unidade_medida_compra	varchar2(30),
									qt_item_nf			number(15),
									vl_unitario_item_nf		number(15,2), 
									vl_total_item_nf		number(15,2),
									vl_base_calc_icms		number(15,2),
									vl_icms				number(15,2),
									vl_ipi				number(15,2),
									vl_aliq_icms			number(15,2),
									vl_aliq_ipi			number(15,2),
									nr_item_nf			number(5),
									nm_usuario			varchar2(15),
									nr_pagina			number(15))');
else
	CALL exec_sql_dinamico(nm_usuario_p,'delete from w_linhas_danfe where nm_usuario = ' || chr(39) || nm_usuario_p || chr(39));
end if;

nr_pagina_w:= 1;
nr_linha_w:= 25;


------------Quadro Faturas-Duplicatas ----------------------------
select	count(*)
into STRICT	qt_vencimento_w
from	nota_fiscal_venc a
where	a.nr_sequencia = nr_sequencia_p;

if (qt_vencimento_w > 0) then
	nr_linha_w:= nr_linha_w-4;
end if;
-----------------------------------------------------------------------


----------------------Quadro ISSQN-- ----------------------------
select	coalesce(obter_valor_tipo_tributo_nota(nr_sequencia_p, 'V', 'ISS'),0)
into STRICT	qt_iss_w
;

if (qt_iss_w > 0) then
	nr_linha_w:= nr_linha_w-5;
end if;
------------------------------------------------------------------------
open C01;
loop
fetch C01 into	
	cd_material_w,
	ds_material_w,
	cd_ncm_w,
	cd_cst_w,
	cd_cfop_w,
	cd_unidade_medida_compra_w,
	qt_item_nf_w,
	vl_unitario_item_nf_w,
	vl_total_item_nf_w,
	vl_base_calc_icms_w,
	vl_icms_w,
	vl_ipi_w,
	vl_aliq_icms_w,
	vl_aliq_ipi_w,
	nr_item_nf_w,
	ds_complemento_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin

		qt_retorno_w:= qt_retorno_w+1;
		
		if (length(ds_material_w) > 38) then
			qt_retorno_w:= qt_retorno_w+1;				
		end if;	
		
		if (length(ds_material_w) > 76) then
			qt_retorno_w:= qt_retorno_w+1;
		end if;

		if (ds_complemento_w <> '0') then
			qt_retorno_w:= qt_retorno_w+1;
		end if;
		
		if (length(ds_complemento_w) > 50) then
			qt_retorno_w:= qt_retorno_w+1;
		end if;
		
		if (length(ds_complemento_w) > 100) then
			qt_retorno_w:= qt_retorno_w+1;
		end if;		
		
		if (qt_retorno_w > nr_linha_w) then
		
			qt_retorno_w:= 0;
			nr_linha_w:= 70;
			nr_pagina_w:= nr_pagina_w+1;
		end if;
		
		CALL exec_sql_dinamico( nm_usuario_p,'insert into w_linhas_danfe(cd_material,
									ds_material,
									cd_ncm,
									cd_cst,
									cd_cfop,
									cd_unidade_medida_compra,
									qt_item_nf,
									vl_unitario_item_nf,
									vl_total_item_nf,
									vl_base_calc_icms,
									vl_icms,
									vl_ipi,
									vl_aliq_icms,
									vl_aliq_ipi,
									nr_item_nf,
									nm_usuario,
									nr_pagina)
						values ('	|| cd_material_w						||','
								|| chr(39) ||ds_material_w		|| chr(39)		||','
								|| chr(39) ||cd_ncm_w			|| chr(39)		||','
								|| chr(39) ||cd_cst_w			|| chr(39)		||','
								|| chr(39) ||cd_cfop_w			|| chr(39)		||','
								|| chr(39) ||cd_unidade_medida_compra_w	|| chr(39)		||','
								|| coalesce(replace(to_char(qt_item_nf_w),',','.'),0)		||','
								|| coalesce(replace(to_char(vl_unitario_item_nf_w),',','.'),0)	||','
								|| coalesce(replace(to_char(vl_total_item_nf_w),',','.'),0)		||','
								|| coalesce(replace(to_char(vl_base_calc_icms_w),',','.'),0)		||','
								|| coalesce(replace(to_char(vl_icms_w),',','.'),0)			||','
								|| coalesce(replace(to_char(vl_ipi_w),',','.'),0)			||','
								|| coalesce(replace(to_char(vl_aliq_icms_w),',','.'),0)		||','
								|| coalesce(replace(to_char(vl_aliq_ipi_w),',','.'),0)		||','
								|| nr_item_nf_w							||','
								|| chr(39) || nm_usuario_p	 	     || chr(39) 	||','
								|| nr_pagina_w							||')');

	end;
end loop;
close C01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_w_linhas_danfe ( nr_sequencia_p bigint, nm_usuario_p text) FROM PUBLIC;

