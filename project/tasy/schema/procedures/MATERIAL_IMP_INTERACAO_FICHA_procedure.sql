-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE material_imp_interacao_ficha ( nr_seq_ficha_p bigint, nr_seq_ficha_interacao_p bigint, ie_severidade_p text, ds_observacao_p text, ds_referencia_p text, nm_usuario_p text, ds_observation_notes_p text default null, ds_precaution_notes_p text default null) AS $body$
DECLARE

	

qt_reg_w			bigint;
qt_reg_ww			bigint;
material_interacao_medic_w 	material_interacao_medic%rowtype;
isdirtycheck                  smallint := 0;
	

BEGIN

select	count(1)
into STRICT	qt_reg_w
from	material_interacao_medic
where	nr_seq_ficha = 	nr_seq_ficha_p
and	nr_seq_ficha_interacao = nr_seq_ficha_interacao_p;
/*
select	count(1)
into	qt_reg_ww
from	material_interacao_medic
where	nr_seq_ficha = 	nr_seq_ficha_interacao_p
and	nr_seq_ficha_interacao = nr_seq_ficha_p;

*/
qt_reg_ww	:= 0;

if (qt_reg_w	= 0) and (qt_reg_ww = 0) then
	
	select	nextval('material_interacao_medic_seq')
	into STRICT	material_interacao_medic_w.nr_sequencia
	;
	
	material_interacao_medic_w.nm_usuario				:= nm_usuario_p;
	material_interacao_medic_w.nm_usuario_nrec			:= nm_usuario_p;
	material_interacao_medic_w.dt_atualizacao			:= clock_timestamp();
	material_interacao_medic_w.dt_atualizacao_nrec			:= clock_timestamp();
	material_interacao_medic_w.ie_severidade			:= ie_severidade_p;
	material_interacao_medic_w.ds_orientacao			:= substr(ds_observacao_p,1,2000);
	material_interacao_medic_w.nr_seq_ficha				:= nr_seq_ficha_p;
	material_interacao_medic_w.nr_seq_ficha_interacao		:= nr_seq_ficha_interacao_p;
	material_interacao_medic_w.IE_CONSISTIR				:= 'P';
	material_interacao_medic_w.IE_MENSAGEM_CADASTRADA		:= 'B';
	material_interacao_medic_w.DS_REF_BIBLIOGRAFICA			:= substr(ds_referencia_p,1,4000);
	if (ds_observation_notes_p IS NOT NULL AND ds_observation_notes_p::text <> '') then
		material_interacao_medic_w.ds_observation_notes		:= substr(ds_observation_notes_p,1,256);
	end if;
	if (ds_precaution_notes_p IS NOT NULL AND ds_precaution_notes_p::text <> '') then
		material_interacao_medic_w.ds_precaution_notes		:= substr(ds_precaution_notes_p,1,4000);
	end if;
	
	insert into material_interacao_medic values (material_interacao_medic_w.*);

--elsif (qt_reg_w	= 1) then
else
	SELECT Count(1) INTO STRICT   isdirtycheck FROM (
	SELECT ie_severidade_p as ie_severidade, substr(ds_observacao_p,1,2000) as ds_orientacao, substr(ds_referencia_p,1,4000) as DS_REF_BIBLIOGRAFICA,
		substr(ds_observation_notes_p,1,256) as DS_OBSERVATION_NOTES, substr(ds_precaution_notes_p,1,4000) as DS_PRECAUTION_NOTES  
	EXCEPT
	SELECT ie_severidade, ds_orientacao, DS_REF_BIBLIOGRAFICA, DS_OBSERVATION_NOTES, DS_PRECAUTION_NOTES from material_interacao_medic 
		where	nr_seq_ficha = 	nr_seq_ficha_p and	nr_seq_ficha_interacao = nr_seq_ficha_interacao_p
	) alias5;
	
	if (isdirtycheck !=  0) then
		update material_interacao_medic
			set ie_severidade = ie_severidade_p, 
				ds_orientacao = substr(ds_observacao_p,1,2000),
				DS_REF_BIBLIOGRAFICA = substr(ds_referencia_p,1,4000),
				DS_OBSERVATION_NOTES = substr(ds_observation_notes_p,1,256),
				DS_PRECAUTION_NOTES = substr(ds_precaution_notes_p,1,4000),
				dt_atualizacao = clock_timestamp(), nm_usuario = 'MIMSUPDATE'
			where	nr_seq_ficha = 	nr_seq_ficha_p and	nr_seq_ficha_interacao = nr_seq_ficha_interacao_p;
	end if;
	
end if;



end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE material_imp_interacao_ficha ( nr_seq_ficha_p bigint, nr_seq_ficha_interacao_p bigint, ie_severidade_p text, ds_observacao_p text, ds_referencia_p text, nm_usuario_p text, ds_observation_notes_p text default null, ds_precaution_notes_p text default null) FROM PUBLIC;

