-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_consite_partic_producao ( nm_usuario_p text, cd_estabelecimento_p bigint, cd_medico_p text, nr_seq_prestador_p bigint, nr_seq_proc_partic_p bigint, cd_guia_p text, ds_retorno_p INOUT text) AS $body$
DECLARE

ie_credenciado_w	varchar(1):= 'N';
ie_cooperado_w		varchar(1):= 'N';
nr_seq_conta_w		bigint;
qt_credenciado_w	bigint;
dt_execucao_w		timestamp;
nr_seq_prestador_w	bigint;
qt_cooperado_w		bigint;
ie_tipo_guia_w		varchar(2);
ie_acao_regra_w		varchar(5);
ds_retorno_w		varchar(255) := '';
qt_registro_w		bigint;
ie_cooperado_regra_w	varchar(2);
ie_credenciado_regra_w	varchar(2);

C01 CURSOR FOR
	SELECT	ie_acao_regra,
		ie_cooperado,
		ie_credenciado
	from	pls_regra_digitacao_partic
	where	ie_tipo_guia	= ie_tipo_guia_w;


BEGIN

if (coalesce(nr_seq_proc_partic_p,0)> 0) then
select	max(b.dt_procedimento),
	max(b.nr_seq_conta)
into STRICT	dt_execucao_w,
	nr_seq_conta_w
from	pls_conta_proc		b
where	b.nr_sequencia 	= nr_seq_proc_partic_p;
end if;

select	nr_seq_prestador_exec,
	ie_tipo_guia
into STRICT	nr_seq_prestador_w,
	ie_tipo_guia_w
from	pls_conta
where 	nr_sequencia = nr_seq_conta_w;

if (coalesce(cd_medico_p,'X') <> 'X') then
	/*select	count(1)
	into	qt_cooperado_w
	from	pls_prestador
	where	cd_pessoa_fisica	= cd_medico_p
	and	trunc(nvl(dt_execucao_w,sysdate),'dd') between trunc(nvl(dt_cadastro,sysdate),'dd') and  fim_dia(nvl(dt_exclusao,sysdate))
	and	ie_tipo_vinculo		= 'C';

	if	(qt_cooperado_w > 0) then
		select	count(1)
		into	qt_registro_w
		from	pls_cooperado a
		where	a.cd_pessoa_fisica	= cd_medico_p
		and	trunc(nvl(dt_execucao_w,sysdate),'dd') between trunc(nvl(dt_inclusao,dt_execucao_w-1),'dd') and  fim_dia(nvl(dt_exclusao,dt_execucao_w+1));
		if	(qt_registro_w > 0) then
			ie_cooperado_w := 'S';
		end if;
	end if;*/
	ie_cooperado_w:= pls_obter_se_cooperado_ativo(cd_medico_p,(dt_execucao_w),'');

	select	count(b.nr_sequencia)
	into STRICT	qt_credenciado_w
	from	pls_prestador_medico a,
		pls_prestador b
	where	a.nr_seq_prestador	= b.nr_sequencia
	and	a.cd_medico 		= cd_medico_p
	and	b.nr_sequencia		= nr_seq_prestador_w
	and	a.ie_situacao		= 'A'
	and	trunc(coalesce(dt_execucao_w,clock_timestamp()),'dd') between trunc(coalesce(a.dt_inclusao,clock_timestamp()),'dd') and  fim_dia(coalesce((a.dt_exclusao-1),clock_timestamp()))
	order by b.nr_sequencia;
end if;

if (qt_credenciado_w	> 0) then
	ie_credenciado_w	:= 'S';
end if;

if (coalesce(qt_credenciado_w,0) = 0) then

	select	count(nr_sequencia)
	into STRICT	qt_credenciado_w
	from	pls_prestador
	where	((nr_sequencia		= nr_seq_prestador_p) or (cd_medico_p	 	= cd_pessoa_fisica))
	--and	ie_tipo_vinculo		= 'C'
	and	trunc(coalesce(dt_execucao_w,clock_timestamp()),'dd') between trunc(coalesce(dt_cadastro,clock_timestamp()),'dd') and  fim_dia(coalesce((dt_exclusao-1),clock_timestamp()))
	order by nr_sequencia;

end if;

if (qt_credenciado_w	> 0) then
	ie_credenciado_w	:= 'S';
end if;

if (coalesce(cd_guia_p,'X') = 'X') then

	open C01;
	loop
	fetch C01 into
		ie_acao_regra_w,
		ie_cooperado_regra_w,
		ie_credenciado_regra_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin
		if	((ie_cooperado_regra_w = 'S' AND ie_cooperado_w = ie_cooperado_regra_w) or
			(ie_credenciado_regra_w = 'S' AND ie_credenciado_w = ie_credenciado_regra_w) or
			((coalesce(ie_cooperado_regra_w,'N') = 'N') and (coalesce(ie_credenciado_regra_w,'N') = 'N')))then
			ds_retorno_w := 'Deve ser informado o numero da guia';
		end if;
		end;
	end loop;
	close C01;

end if;

ds_retorno_p := ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_consite_partic_producao ( nm_usuario_p text, cd_estabelecimento_p bigint, cd_medico_p text, nr_seq_prestador_p bigint, nr_seq_proc_partic_p bigint, cd_guia_p text, ds_retorno_p INOUT text) FROM PUBLIC;

