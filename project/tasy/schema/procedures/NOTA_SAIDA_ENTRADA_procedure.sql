-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE nota_saida_entrada (cd_estabelecimento_p bigint, dt_inicio_p timestamp, dt_fim_p timestamp, nm_usuario_p text) AS $body$
DECLARE


contador_w			bigint := 0;
qt_registros_W			bigint;
ds_arquivo_ww			varchar(3000);
nr_sequencia_w			varchar(10);
nr_seq_aux_w			varchar(10);
ie_indicador_movimento_w	varchar(10);
cd_modelo_documento_w		varchar(10);
cd_serie_nf_w			nota_fiscal.cd_serie_nf%type;
nr_nota_fiscal_w		varchar(255);
dt_emissao_documento_w		varchar(8);
cd_participante_w		varchar(15);
dt_entrada_saida_w		varchar(8);
vl_total_item_nf_w		varchar(18);
vl_desc_item_nf_w		varchar(18);
vl_frete_w			varchar(18);
vl_seguro_w			varchar(18);
vl_outras_despesas_w		varchar(18);
vl_ipi_w			varchar(18);
vl_icms_st_w			varchar(18);
vl_total_nota_fiscal_w		varchar(18);
insc_esta_subst_trib_w		varchar(15);
ds_via_transporte_w		varchar(255);
cd_cgc_transportador_w		varchar(14);
qt_volume_w			varchar(20);
ds_especie_w			varchar(255);
qt_peso_bruto_w			varchar(20);
qt_peso_liquido_w		varchar(20);
ie_tipo_frete_w			varchar(10);
nr_placa_veiculo_w		varchar(100);
ie_situacao_cancelamento_w	varchar(10);
ie_tipo_fatura_w		varchar(10);
ds_observacao_w			varchar(45);
cd_estabelecimento_w		integer;
nr_seq_blu_w			bigint;

c01 CURSOR FOR
SELECT	n.nr_sequencia										nr_sequencia ,
	CASE WHEN n.ie_tipo_nota='EF' THEN 'E' WHEN n.ie_tipo_nota='EN' THEN 'E' WHEN n.ie_tipo_nota='EP' THEN 'E' WHEN n.ie_tipo_nota='SD' THEN 'S' WHEN n.ie_tipo_nota='SE' THEN 'S' WHEN n.ie_tipo_nota='SF' THEN 'S' WHEN n.ie_tipo_nota='ST' THEN 'S' END 	ie_indicador_movimento,
	lpad(' ','2',' ')   										cd_modelo_documento,
	rpad(n.cd_serie_nf,'5',' ')										nr_serie_nf,
	lpad(n.nr_nota_fiscal,6,' ')									nr_nota_fiscal,
	lpad(substr(to_char(n.dt_emissao,'ddmmyyyy'),1,8),8,' ')							dt_emissao_documento,
	lpad(coalesce(substr(CASE WHEN CASE WHEN n.ie_tipo_nota='EF' THEN 'E' WHEN n.ie_tipo_nota='EN' THEN 'E' WHEN n.ie_tipo_nota='EP' THEN 'E' WHEN n.ie_tipo_nota='SD' THEN 'S' WHEN n.ie_tipo_nota='SE' THEN 'S' WHEN n.ie_tipo_nota='SF' THEN 'S' WHEN n.ie_tipo_nota='ST' THEN 'S' END ='E' THEN 	n.cd_cgc_emitente WHEN CASE WHEN n.ie_tipo_nota='EF' THEN 'E' WHEN n.ie_tipo_nota='EN' THEN 'E' WHEN n.ie_tipo_nota='EP' THEN 'E' WHEN n.ie_tipo_nota='SD' THEN 'S' WHEN n.ie_tipo_nota='SE' THEN 'S' WHEN n.ie_tipo_nota='SF' THEN 'S' WHEN n.ie_tipo_nota='ST' THEN 'S' END ='S' THEN CASE WHEN coalesce(n.cd_cgc::text, '') = '' THEN obter_cpf_pessoa_fisica(n.cd_pessoa_fisica)  ELSE n.cd_cgc END  END ,1,14),' '),'14',' ') cd_participante,
	lpad(substr(to_char(n.dt_entrada_saida,'ddmmyyyy'),1,8),'8',' ')						dt_entrada_saida,
	lpad(coalesce(to_char((select sum(vl_total_item_nf) from nota_fiscal_item i where i.nr_sequencia = n.nr_sequencia)),' '),'17',' ') vl_total_item_nf,
	lpad(coalesce(to_char((select sum(vl_desconto) from nota_fiscal_item i where i.nr_sequencia = n.nr_sequencia)),' '),'17',' ') vl_desc_item_nf,
	lpad(coalesce(replace(replace(replace(to_char(n.vl_frete,'999,999,999,990.99'),',',''),'.',''),' ',''),' '),'17',' ') vl_frete,
	lpad(coalesce(replace(replace(replace(to_char(n.vl_seguro,'999,999,999,990.99'),',',''),'.',''),' ',''),' '),'17',' ') vl_seguro,
	lpad(coalesce(replace(replace(replace(to_char(0,'999,999,999,990.99'),',',''),'.',''),' ',''),' '),'17',' ')		vl_outras_despesas,
	lpad(coalesce(replace(replace(replace(to_char(coalesce(n.vl_ipi,0),'999,999,999,990.99'),',',''),'.',''),' ',''),' '),'17',' ')	vl_ipi,
	lpad(coalesce(to_char(obter_valor_tipo_trib_item_nf(n.nr_sequencia,null,'ICMSST')),' '),'17',' ')				vl_icms_st,
	lpad(replace(replace(replace(to_char(n.vl_total_nota,'999,999,999,990.99'),',',''),'.',''),' ',''),'17',' ') vl_total_nota_fiscal,
	lpad(' ','14',' ')											insc_esta_subst_trib,
	rpad(' ','15',' ')											ds_via_transporte,
	lpad(' ','14',' ') 											cd_cgc_transportador,
	lpad(coalesce(replace(replace(replace(to_char(0,'999,999,999,990.999'),',',''),'.',''),' ',''),' '),'17',' ') qt_volume,
	lpad(' ','10',' ')											ds_especie,
	lpad(coalesce(replace(replace(replace(to_char(0,'999,999,999,990.999'),',',''),'.',''),' ',''),' '),'17',' ') qt_peso_bruto,
	lpad(coalesce(replace(replace(replace(to_char(0,'999,999,999,990.999'),',',''),'.',''),' ',''),' '),'17',' ') qt_peso_liquido,
	lpad(' ',3,' ')												ie_tipo_frete,
	lpad(' ','15',' ')											nr_placa_veiculo,
	lpad(CASE WHEN n.ie_situacao=1 THEN 'N' WHEN n.ie_situacao=2 THEN 'N' WHEN n.ie_situacao=3 THEN 'S' WHEN n.ie_situacao=9 THEN 'S' END ,1,' ')						ie_situacao_cancelamento,
	lpad(CASE WHEN(select elimina_acentuacao(elimina_caracteres_especiais(upper(c.ds_condicao_pagamento))) from condicao_pagamento c where c.cd_condicao_pagamento = n.cd_condicao_pagamento)='AVISTA' THEN 1  ELSE 2 END ,'1',' ') ie_tipo_fatura,
	lPAD(coalesce(SUBSTR(REPLACE(n.ds_observacao,chr(13),''),1,45),' '),45,' ')					ds_observacao,
	n.cd_estabelecimento									cd_estabelecimento
FROM operacao_nota o, nota_fiscal n
LEFT OUTER JOIN nota_fiscal_transportadora t ON (n.nr_sequencia = t.nr_seq_nota)
WHERE o.cd_operacao_nf = n.cd_operacao_nf and n.ie_tipo_nota in ('EP','SD','SE','SF','ST') and o.ie_servico = 'N' and n.cd_estabelecimento = cd_estabelecimento_p and n.dt_emissao between to_date(to_char(dt_inicio_p,'dd/mm/yyyy'),'dd/mm/yyyy') and fim_dia(to_date(to_char(dt_fim_p,'dd/mm/yyyy'),'dd/mm/yyyy')) order by n.nr_sequencia;


BEGIN

open c01;
loop
fetch c01 into
	nr_sequencia_w,
	ie_indicador_movimento_w,
	cd_modelo_documento_w,
	cd_serie_nf_w,
	nr_nota_fiscal_w,
	dt_emissao_documento_w,
	cd_participante_w,
	dt_entrada_saida_w,
	vl_total_item_nf_w,
	vl_desc_item_nf_w,
	vl_frete_w,
	vl_seguro_w,
	vl_outras_despesas_w,
	vl_ipi_w,
	vl_icms_st_w,
	vl_total_nota_fiscal_w,
	insc_esta_subst_trib_w,
	ds_via_transporte_w,
	cd_cgc_transportador_w,
	qt_volume_w,
	ds_especie_w,
	qt_peso_bruto_w,
	qt_peso_liquido_w,
	ie_tipo_frete_w,
	nr_placa_veiculo_w,
	ie_situacao_cancelamento_w,
	ie_tipo_fatura_w,
	ds_observacao_w,
	cd_estabelecimento_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	begin

	contador_w := contador_w + 1;

	ds_arquivo_ww	:=	ie_indicador_movimento_w  	|| cd_modelo_documento_w 	||
				cd_serie_nf_w  			|| nr_nota_fiscal_w 		||
				dt_emissao_documento_w  	|| cd_participante_w 		||
				dt_entrada_saida_w 		|| vl_total_item_nf_w 		||
				vl_desc_item_nf_w 		|| vl_frete_w 			||
				vl_seguro_w 			|| vl_outras_despesas_w 	||
				vl_ipi_w 			|| vl_icms_st_w 		||
				vl_total_nota_fiscal_w 		|| insc_esta_subst_trib_w 	||
				ds_via_transporte_w 		|| cd_cgc_transportador_w	||
				qt_volume_w 			|| ds_especie_w 		||
				qt_peso_bruto_w 		|| qt_peso_liquido_w 		||
				ie_tipo_frete_w 		|| nr_placa_veiculo_w 		||
				ie_situacao_cancelamento_w 	|| ie_tipo_fatura_w 		||
				ds_observacao_w;

insert into w_inss_direp_arquivo( nr_sequencia,
				cd_estabelecimento,
				dt_atualizacao,
				nm_usuario,
				dt_atualizacao_nrec,
				nm_usuario_nrec,
				ds_arquivo_w)
		values (nextval('w_inss_direp_arquivo_seq'),
				cd_estabelecimento_w,
				clock_timestamp(),
				nm_usuario_p,
				clock_timestamp(),
				nm_usuario_p,
				ds_arquivo_ww);


if (mod(contador_w,100) = 0) then
		commit;
	end if;

	end;
end loop;
close c01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE nota_saida_entrada (cd_estabelecimento_p bigint, dt_inicio_p timestamp, dt_fim_p timestamp, nm_usuario_p text) FROM PUBLIC;

