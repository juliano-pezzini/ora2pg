-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE sup_simular_formula_planej ( nr_seq_formula_p bigint, ie_calcular_p text, ds_parametros_p text, cd_estabelecimento_p bigint, nm_usuario_p text, vl_retorno_p INOUT bigint) AS $body$
DECLARE


ds_formula_w			varchar(4000);
nm_form_atributo_w		varchar(255);
tam_formula_w			bigint;
ie_pos_separador_w		bigint;
ds_informacao_w			varchar(255);
ds_lista_atributo_w		varchar(4000);
qt_existe_w			bigint;

ds_parametros_w			varchar(4000);
ds_parametro_w			varchar(300);
ds_macro_w			varchar(255);
ds_valor_w			varchar(22);
vl_retorno_w			double precision;


BEGIN

if (ie_calcular_p = 'N') then
	begin

	select	upper(ds_formula)
	into STRICT	ds_formula_w
	from	sup_formula_planej_compra
	where	nr_sequencia = nr_seq_formula_p;

	delete
	from	w_sup_simula_form_planej
	where	nm_usuario = nm_usuario_p;

	commit;

	while(ds_formula_w IS NOT NULL AND ds_formula_w::text <> '') loop
		begin

		nm_form_atributo_w	:= null;

		tam_formula_w		:= length(ds_formula_w);
		ie_pos_separador_w	:= position(' ' in ds_formula_w);

		if (ie_pos_separador_w <> 0) then
			ds_informacao_w		:= substr(ds_formula_w,1,(ie_pos_separador_w - 1));
			ds_formula_w		:= substr(ds_formula_w,(ie_pos_separador_w + 1),tam_formula_w);
		else
			ds_informacao_w		:= ds_formula_w;
			ds_formula_w		:= '';
		end if;

		if (substr(ds_informacao_w,1,3) = '#A_') then
			begin

			select	max(ds_atributo)
			into STRICT	nm_form_atributo_w
			from	sup_atrib_planej_compras
			where	nm_atributo = substr(ds_informacao_w,4,length(ds_informacao_w));

			if (coalesce(nm_form_atributo_w::text, '') = '') then
				begin

				select	max(ds_valor_dominio)
				into STRICT	nm_form_atributo_w
				from	valor_dominio
				where	cd_dominio = 5331
				and	vl_dominio = substr(ds_informacao_w,4,length(ds_informacao_w));

				end;
			end if;

			end;
		elsif (substr(ds_informacao_w,1,3) = '#F_') then
			begin

			select	max(nm_formula)
			into STRICT	nm_form_atributo_w
			from	sup_formula_planej_compra
			where	ds_macro = substr(ds_informacao_w,4,length(ds_informacao_w));

			end;
		end if;

		if (nm_form_atributo_w IS NOT NULL AND nm_form_atributo_w::text <> '') then
			begin

			select	count(*)
			into STRICT	qt_existe_w
			
			where	ds_lista_atributo_w like '%' || ds_informacao_w || '%';

			ds_lista_atributo_w	:= ds_lista_atributo_w || ds_informacao_w || ';';

			end;
		end if;

		if (nm_form_atributo_w IS NOT NULL AND nm_form_atributo_w::text <> '') and (qt_existe_w = 0) then
			begin

			insert into w_sup_simula_form_planej(
				nr_seq_formula,
				ds_macro,
				nm_form_atributo,
				dt_atualizacao,
				nm_usuario,
				vl_macro)
			values (
				nr_seq_formula_p,
				ds_informacao_w,
				nm_form_atributo_w,
				clock_timestamp(),
				nm_usuario_p,
				0);

			end;
		end if;

		end;
	end loop;

	commit;

	end;
else
	begin

	ds_parametros_w	:= ds_parametros_p;

	while(ds_parametros_w IS NOT NULL AND ds_parametros_w::text <> '') loop
		begin

		tam_formula_w		:= length(ds_parametros_w);
		ie_pos_separador_w	:= position(';' in ds_parametros_w);

		if (coalesce(ie_pos_separador_w,0) <> 0) then
			begin

			ds_parametro_w		:= substr(ds_parametros_w,1,(ie_pos_separador_w - 1));
			ds_parametros_w		:= substr(ds_parametros_w,(ie_pos_separador_w + 1),tam_formula_w);

			tam_formula_w		:= length(ds_parametro_w);
			ie_pos_separador_w	:= position('=' in ds_parametro_w);

			ds_macro_w		:= substr(ds_parametro_w,1,(ie_pos_separador_w - 1));
			ds_valor_w		:= (substr(ds_parametro_w,(ie_pos_separador_w + 1),tam_formula_w))::numeric;

			update	w_sup_simula_form_planej
			set	vl_macro	= ds_valor_w
			where	ds_macro = ds_macro_w
			and	nm_usuario = nm_usuario_p;

			end;
		end if;

		end;
	end loop;

	commit;

	vl_retorno_w := sup_gerar_planej_pck.gerar_valor_form_planej(nr_seq_formula_p, 0, 'S', vl_retorno_w, cd_estabelecimento_p, nm_usuario_p);

	vl_retorno_p	:= vl_retorno_w;

	end;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE sup_simular_formula_planej ( nr_seq_formula_p bigint, ie_calcular_p text, ds_parametros_p text, cd_estabelecimento_p bigint, nm_usuario_p text, vl_retorno_p INOUT bigint) FROM PUBLIC;

