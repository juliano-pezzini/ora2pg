-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE nut_gerar_refeicoes_catraca ( dt_refeicao_p timestamp, nm_usuario_p text) AS $body$
DECLARE

			
nr_seq_integracao_w	bigint;
nr_seq_servico_w	bigint;
qt_catraca_w		bigint;
ds_horarios_w		varchar(5);
ds_horarios_fim_w	varchar(5);
nr_seq_cardapio_dia_w	bigint;
ds_parametro_120_w  varchar(1);

C01 CURSOR FOR 	--obter servico
	
	SELECT 	a.nr_seq_servico,
		b.nr_sequencia,
		a.ds_horarios,
		a.ds_horarios_fim
	from	nut_servico_horario a,
		nut_cardapio_dia b
	where 	((ds_parametro_120_w = 'N' and a.nr_seq_servico = b.nr_seq_servico )
        		or (ds_parametro_120_w = 'S' and a.nr_seq_servico = b.nr_seq_servico and coalesce(b.nr_seq_cycle,0) > 0)) 
	and	(a.ds_horarios IS NOT NULL AND a.ds_horarios::text <> '')
	and	(a.ds_horarios_fim IS NOT NULL AND a.ds_horarios_fim::text <> '')
	and	b.dt_cardapio  between inicio_dia(dt_refeicao_p) and fim_dia(dt_refeicao_p)
	order	by 1;


BEGIN

if (dt_refeicao_p IS NOT NULL AND dt_refeicao_p::text <> '') then
ds_parametro_120_w := obter_valor_param_usuario(1003,120,obter_perfil_ativo,wheb_usuario_pck.get_nm_usuario,wheb_usuario_pck.get_cd_estabelecimento);
	select	max(a.nr_sequencia)
	into STRICT	nr_seq_integracao_w
	from	nut_integracao_catraca a
	where	a.dt_refeicao between inicio_dia(dt_refeicao_p) and fim_dia(dt_refeicao_p);
	
	if (nr_seq_integracao_w IS NOT NULL AND nr_seq_integracao_w::text <> '') then

		open C01;
		loop
		fetch C01 into	
			nr_seq_servico_w,
			nr_seq_cardapio_dia_w,
			ds_horarios_w,
			ds_horarios_fim_w;
		EXIT WHEN NOT FOUND; /* apply on C01 */
		begin

			select	count(*)
			into STRICT	qt_catraca_w
			from	nut_integ_catraca_item a
			where	to_char(a.dt_refeicao,'hh24:mi') between ds_horarios_w and ds_horarios_fim_w
			and	a.nr_seq_integracao	= nr_seq_integracao_w;
			
			--atualizar qtd no cardapio
			if ( qt_catraca_w > 0) then
				
				update	nut_cardapio_dia
				set	qt_pessoa_atend_real	= qt_catraca_w
				where	nr_sequencia		= nr_seq_cardapio_dia_w;
					
				CALL gravar_log_nutricao(10, wheb_mensagem_pck.get_texto(802584,
										'QT_CATRACA='||qt_catraca_w||
										';NR_SEQ_CARDAPIO_DIA='||nr_seq_cardapio_dia_w), nm_usuario_p);
			end if;
		end;
		end loop;
		close C01;
	end if;
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE nut_gerar_refeicoes_catraca ( dt_refeicao_p timestamp, nm_usuario_p text) FROM PUBLIC;

