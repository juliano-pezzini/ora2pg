-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_ficha_financ_consulta ( cd_pessoa_fisica_p text, cd_cgc_p text, cd_perfil_ativo_p bigint, ie_somente_aberto_p text, dt_referencia_p timestamp, cd_estab_p bigint /*Filtro*/
, cd_estabelecimento_p bigint /*Logado*/
, ds_lista_estab_p text, ie_resp_titulo_cre_p text, ie_registro_conv_p text, ie_informacao_pj_p text, nr_seq_capa_p bigint, dt_ini_capa_p timestamp, dt_fim_capa_p timestamp, nm_usuario_p text, ds_lista_convenio_p text, ds_lista_grupo_p text, ds_lista_sub_grupo_p text, ds_lista_produto_p text, ie_pessoa_cobranca_p text default 'D') AS $body$
DECLARE


/*
1  títulos a receber
7  adiantamento
8  cheque
9  cobrança
10  conta paciente
17  recebimento em cartão
18  protocolo convênio
19  ops - mensalidades
21  negociação de cr

12  títulos a pagar
13  adiantamento pago
14  repasse
22  nota de crédito
24  perdas
26  gestão spa

ie_resp_titulo_cre_p
0  pessoa física do título
1  paciente
2  responsável pagamento
3  todos

ie_informacao_pj_p
0  pessoa jurídica selecionada
1  pj + filiais.
*/
ie_gravar_w      varchar(1);
ie_somente_aberto_w    varchar(1)   := 'S';
cd_estabelecimento_w    smallint   := null;
ds_lista_estab_w    varchar(255);
ie_estab_contido_w    varchar(1)  := 'S';
dt_referencia_w      timestamp;

nr_sequencia_w      bigint  := 0;
nr_seq_item_w      bigint;

nr_titulo_cr_w      bigint;
nr_adiantamento_cr_w    bigint;
nr_seq_cheque_cr_w    bigint;
nr_seq_cobranca_w    bigint;
nr_interno_conta_w    bigint;
nr_seq_movto_cartao_cr_w  bigint;
nr_seq_protocolo_w    bigint;
nr_seq_pls_mensalidade_w  bigint;
nr_seq_negociacao_cr_w    bigint;

nr_titulo_cp_w      bigint;
nr_adiantamento_cp_w    bigint;
nr_repasse_terceiro_w    bigint;
nr_seq_nota_credito_w    bigint;

nr_atendimento_w    bigint;
cd_convenio_w      integer;
ie_tipo_convenio_w    varchar(15);

vl_saldo_w      double precision;

nr_seq_perda_w      bigint;
nr_seq_spa_w      bigint;

qt_reg_w      integer;
cd_cgc_raiz_w      varchar(14);

cd_pessoa_fisica_w    varchar(10);
cd_cgc_w      varchar(14);
nr_seq_grupo_prod_w    bigint;

ie_prod_perfil_w    varchar(1);

ds_lista_convenio_w    varchar(255);
ie_convenio_contido_w    varchar(1)  := 'S';
ds_lista_grupo_w    varchar(255);
ie_grupo_contido_w    varchar(1)  := 'S';
ds_lista_sub_grupo_w    varchar(255);
ie_sub_grupo_contido_w    varchar(1)  := 'S';
ds_lista_produto_w    varchar(255);
ie_produto_contido_w    varchar(1)  := 'S';
ie_buscar_cheques_w    varchar(1)     := 'N';
ie_cheques_relacionados_w  varchar(1)    := 'N';


c00 CURSOR FOR
SELECT  cd_pessoa_fisica,
  null cd_cgc
from  pessoa_fisica
where  cd_pessoa_fisica = cd_pessoa_fisica_p
and  (cd_pessoa_fisica_p IS NOT NULL AND cd_pessoa_fisica_p::text <> '')

union all

SELECT  null cd_pessoa_fisica,
  cd_cgc
from  pessoa_juridica
where  cd_cgc = cd_cgc_p
and  (cd_cgc_p IS NOT NULL AND cd_cgc_p::text <> '')
and  ie_informacao_pj_p = '0'

union all

select  null cd_pessoa_fisica,
  cd_cgc
from  pessoa_juridica
where  cd_cnpj_raiz = cd_cgc_raiz_w
and  (cd_cgc_p IS NOT NULL AND cd_cgc_p::text <> '')
and  ie_informacao_pj_p = '1';

c01 CURSOR FOR
SELECT  a.nr_sequencia
from   ficha_financ_item a
where ((cd_pessoa_fisica_p IS NOT NULL AND cd_pessoa_fisica_p::text <> '') or (cd_cgc_p IS NOT NULL AND cd_cgc_p::text <> ''))
order by a.nr_sequencia;


c02 CURSOR FOR
SELECT	a.cd_estabelecimento
from	estabelecimento a
where	((coalesce(cd_estab_p,0) = 0) or (a.cd_estabelecimento  = cd_estab_p))
and	((a.cd_estabelecimento = cd_estabelecimento_p) or (obter_estab_financeiro(a.cd_estabelecimento) = cd_estabelecimento_p))
AND coalesce(ds_lista_estab_w::text, '') = ''
and holding_pck.get_acesso_grupo_emp(5512,
                                    wheb_usuario_pck.get_cd_perfil,
                                    wheb_usuario_pck.get_nm_usuario,
                                    null, 
                                    'GEM', 
                                    obter_empresa_estab(wheb_usuario_pck.get_cd_estabelecimento)) = 0 

UNION

SELECT	a.cd_estabelecimento
from	estabelecimento a
where (obter_se_contido(cd_estabelecimento,ds_lista_estab_w) = ie_estab_contido_w)
AND 	(ds_lista_estab_w IS NOT NULL AND ds_lista_estab_w::text <> '')

union

select	a.cd_estabelecimento
from	estabelecimento a
where	((a.cd_estabelecimento  = cd_estab_p)
or	(((a.cd_estabelecimento = cd_estabelecimento_p) or (obter_estab_financeiro(a.cd_estabelecimento) = cd_estabelecimento_p)) AND (coalesce(cd_estab_p,0) = 0)))
AND 	coalesce(ds_lista_estab_w::text, '') = ''
and  a.cd_estabelecimento IN (SELECT c.cd_estabelecimento
                                FROM grupo_emp_estrutura b,
                                     estabelecimento c
                               WHERE b.cd_empresa = c.cd_empresa
                                 AND b.nr_seq_grupo = holding_pck.get_acesso_grupo_emp(5512,
                                                                                        wheb_usuario_pck.get_cd_perfil,
                                                                                        wheb_usuario_pck.get_nm_usuario,
                                                                                        null, 
                                                                                        'GEM', 
                                                                                        obter_empresa_estab(wheb_usuario_pck.get_cd_estabelecimento)));

c03 CURSOR FOR
SELECT  a.nr_titulo
from  titulo_receber a
where  a.cd_estabelecimento = cd_estabelecimento_w
and  a.cd_pessoa_fisica = cd_pessoa_fisica_w
and  ie_resp_titulo_cre_p in ('0','3')
and  (cd_pessoa_fisica_w IS NOT NULL AND cd_pessoa_fisica_w::text <> '')
and  ((coalesce(ds_lista_convenio_w::text, '') = '') or (obter_se_contido(a.cd_convenio_conta,ds_lista_convenio_w) = ie_convenio_contido_w))
and  ((coalesce(ds_lista_grupo_w::text, '') = '') or (obter_se_contido_char(obter_prod_financ(a.nr_titulo,'TR','G'), ds_lista_grupo_w) = ie_grupo_contido_w))
and  ((coalesce(ds_lista_sub_grupo_w::text, '') = '') or (obter_se_contido_char(obter_prod_financ(a.nr_titulo,'TR','S'), ds_lista_sub_grupo_w) = ie_sub_grupo_contido_w))
and  ((coalesce(ds_lista_produto_w::text, '') = '') or (obter_se_contido_char(obter_prod_financ(a.nr_titulo,'TR','P'), ds_lista_produto_w) = ie_produto_contido_w))

union all

SELECT  a.nr_titulo
from  titulo_receber a,
  atendimento_paciente b
where  a.nr_atendimento = b.nr_atendimento
and  a.cd_estabelecimento = cd_estabelecimento_w
and  b.cd_pessoa_fisica = cd_pessoa_fisica_w
and  ie_resp_titulo_cre_p in ('1','3')
and  (cd_pessoa_fisica_w IS NOT NULL AND cd_pessoa_fisica_w::text <> '')
and  ((coalesce(ds_lista_convenio_w::text, '') = '') or (obter_se_contido(a.cd_convenio_conta,ds_lista_convenio_w) = ie_convenio_contido_w))
and  ((coalesce(ds_lista_grupo_w::text, '') = '') or (obter_se_contido_char(obter_prod_financ(a.nr_titulo,'TR','G'), ds_lista_grupo_w) = ie_grupo_contido_w))
and  ((coalesce(ds_lista_sub_grupo_w::text, '') = '') or (obter_se_contido_char(obter_prod_financ(a.nr_titulo,'TR','S'), ds_lista_sub_grupo_w) = ie_sub_grupo_contido_w))
and  ((coalesce(ds_lista_produto_w::text, '') = '') or (obter_se_contido_char(obter_prod_financ(a.nr_titulo,'TR','P'), ds_lista_produto_w) = ie_produto_contido_w))

union all

select  a.nr_titulo
from  titulo_receber a,
  titulo_receber_resp_pgto b
where  a.nr_titulo = b.nr_titulo
and  a.cd_estabelecimento = cd_estabelecimento_w
and  b.cd_pessoa_fisica = cd_pessoa_fisica_w
and  clock_timestamp() between b.dt_inicio_vigencia and coalesce(b.dt_fim_vigencia,clock_timestamp())
and  coalesce(b.ie_informativo,'N') = 'N'
and  ie_resp_titulo_cre_p in ('2','3')
and  (cd_pessoa_fisica_w IS NOT NULL AND cd_pessoa_fisica_w::text <> '')
and  ((coalesce(ds_lista_convenio_w::text, '') = '') or (obter_se_contido(a.cd_convenio_conta,ds_lista_convenio_w) = ie_convenio_contido_w))
and  ((coalesce(ds_lista_grupo_w::text, '') = '') or (obter_se_contido_char(obter_prod_financ(a.nr_titulo,'TR','G'), ds_lista_grupo_w) = ie_grupo_contido_w))
and  ((coalesce(ds_lista_sub_grupo_w::text, '') = '') or (obter_se_contido_char(obter_prod_financ(a.nr_titulo,'TR','S'), ds_lista_sub_grupo_w) = ie_sub_grupo_contido_w))
and  ((coalesce(ds_lista_produto_w::text, '') = '') or (obter_se_contido_char(obter_prod_financ(a.nr_titulo,'TR','P'), ds_lista_produto_w) = ie_produto_contido_w))
group by a.nr_titulo

union all

select  a.nr_titulo
from  titulo_receber a
where  a.cd_estabelecimento = cd_estabelecimento_w
and  a.cd_cgc = cd_cgc_w
and  (cd_cgc_w IS NOT NULL AND cd_cgc_w::text <> '')
and  ((coalesce(ds_lista_convenio_w::text, '') = '') or (obter_se_contido(a.cd_convenio_conta,ds_lista_convenio_w) = ie_convenio_contido_w))
and  ((coalesce(ds_lista_grupo_w::text, '') = '') or (obter_se_contido_char(obter_prod_financ(a.nr_titulo,'TR','G'), ds_lista_grupo_w) = ie_grupo_contido_w))
and  ((coalesce(ds_lista_sub_grupo_w::text, '') = '') or (obter_se_contido_char(obter_prod_financ(a.nr_titulo,'TR','S'), ds_lista_sub_grupo_w) = ie_sub_grupo_contido_w))
and  ((coalesce(ds_lista_produto_w::text, '') = '') or (obter_se_contido_char(obter_prod_financ(a.nr_titulo,'TR','P'), ds_lista_produto_w) = ie_produto_contido_w));

c04 CURSOR FOR
SELECT  a.nr_adiantamento
from  adiantamento a
where  a.cd_estabelecimento = cd_estabelecimento_w
and  a.cd_pessoa_fisica = cd_pessoa_fisica_w
and  (cd_pessoa_fisica_w IS NOT NULL AND cd_pessoa_fisica_w::text <> '')
and  coalesce(ie_lib_caixa,'S')  = 'S'
and  ((coalesce(ds_lista_grupo_w::text, '') = '') or (obter_se_contido_char(obter_prod_financ(a.nr_adiantamento,'AD','G'), ds_lista_grupo_w) = ie_grupo_contido_w))
and  ((coalesce(ds_lista_sub_grupo_w::text, '') = '') or (obter_se_contido_char(obter_prod_financ(a.nr_adiantamento,'AD','S'), ds_lista_sub_grupo_w) = ie_sub_grupo_contido_w))
and  ((coalesce(ds_lista_produto_w::text, '') = '') or (obter_se_contido_char(obter_prod_financ(a.nr_adiantamento,'AD','P'), ds_lista_produto_w) = ie_produto_contido_w))

union all

SELECT  a.nr_adiantamento
from  adiantamento a
where  a.cd_estabelecimento = cd_estabelecimento_w
and  a.cd_cgc = cd_cgc_w
and  (cd_cgc_w IS NOT NULL AND cd_cgc_w::text <> '')
and  coalesce(ie_lib_caixa,'S')  = 'S'
and  ((coalesce(ds_lista_grupo_w::text, '') = '') or (obter_se_contido_char(obter_prod_financ(a.nr_adiantamento,'AD','G'), ds_lista_grupo_w) = ie_grupo_contido_w))
and  ((coalesce(ds_lista_sub_grupo_w::text, '') = '') or (obter_se_contido_char(obter_prod_financ(a.nr_adiantamento,'AD','S'), ds_lista_sub_grupo_w) = ie_sub_grupo_contido_w))
and  ((coalesce(ds_lista_produto_w::text, '') = '') or (obter_se_contido_char(obter_prod_financ(a.nr_adiantamento,'AD','P'), ds_lista_produto_w) = ie_produto_contido_w));


c05 CURSOR FOR
SELECT  a.nr_seq_cheque
from  cheque_cr a
where  a.cd_estabelecimento = cd_estabelecimento_w
and  a.cd_pessoa_fisica = cd_pessoa_fisica_w
and  (cd_pessoa_fisica_w IS NOT NULL AND cd_pessoa_fisica_w::text <> '')
and  ((coalesce(ds_lista_grupo_w::text, '') = '') or (obter_se_contido_char(obter_prod_financ(a.nr_seq_cheque,'CH','G'), ds_lista_grupo_w) = ie_grupo_contido_w))
and  ((coalesce(ds_lista_sub_grupo_w::text, '') = '') or (obter_se_contido_char(obter_prod_financ(a.nr_seq_cheque,'CH','S'), ds_lista_sub_grupo_w) = ie_sub_grupo_contido_w))
and  ((coalesce(ds_lista_produto_w::text, '') = '') or (obter_se_contido_char(obter_prod_financ(a.nr_seq_cheque,'CH','P'), ds_lista_produto_w) = ie_produto_contido_w))

union all

SELECT  a.nr_seq_cheque
from  cheque_cr a
where  a.cd_estabelecimento = cd_estabelecimento_w
and  a.cd_cgc = cd_cgc_w
and  (cd_cgc_w IS NOT NULL AND cd_cgc_w::text <> '')
and  ((coalesce(ds_lista_grupo_w::text, '') = '') or (obter_se_contido_char(obter_prod_financ(a.nr_seq_cheque,'CH','G'), ds_lista_grupo_w) = ie_grupo_contido_w))
and  ((coalesce(ds_lista_sub_grupo_w::text, '') = '') or (obter_se_contido_char(obter_prod_financ(a.nr_seq_cheque,'CH','S'), ds_lista_sub_grupo_w) = ie_sub_grupo_contido_w))
and  ((coalesce(ds_lista_produto_w::text, '') = '') or (obter_se_contido_char(obter_prod_financ(a.nr_seq_cheque,'CH','P'), ds_lista_produto_w) = ie_produto_contido_w))

union all

select  a.nr_seq_cheque
FROM cheque_cr a
LEFT OUTER JOIN titulo_receber b ON (a.nr_titulo = b.nr_titulo)
LEFT OUTER JOIN atendimento_paciente c ON (b.nr_atendimento = c.nr_atendimento)
WHERE a.cd_estabelecimento = cd_estabelecimento_w   and a.cd_pessoa_fisica   = cd_pessoa_fisica_w and obter_status_cheque(a.nr_seq_cheque) in (3,5,10) and ((coalesce(ds_lista_grupo_w::text, '') = '') or (obter_se_contido_char(obter_prod_financ(a.nr_seq_cheque,'CH','G'), ds_lista_grupo_w) = ie_grupo_contido_w)) and ((coalesce(ds_lista_sub_grupo_w::text, '') = '') or (obter_se_contido_char(obter_prod_financ(a.nr_seq_cheque,'CH','S'), ds_lista_sub_grupo_w) = ie_sub_grupo_contido_w)) and ((coalesce(ds_lista_produto_w::text, '') = '') or (obter_se_contido_char(obter_prod_financ(a.nr_seq_cheque,'CH','P'), ds_lista_produto_w) = ie_produto_contido_w)) and coalesce(ie_cheques_relacionados_w,'N') = 'S'

union all

select  a.nr_seq_cheque
from  atendimento_paciente d,
    titulo_receber c,
        titulo_receber_liq b,
        cheque_cr a
where  a.cd_estabelecimento = cd_estabelecimento_w
and    b.nr_titulo       = c.nr_titulo
and    c.nr_atendimento   = d.nr_atendimento
and    a.nr_seq_caixa_rec   = b.nr_seq_caixa_rec
and    coalesce(a.nr_titulo::text, '') = ''
and    d.cd_pessoa_fisica   = cd_pessoa_fisica_w
and    obter_status_cheque(a.nr_seq_cheque) in (3,5,10)
and    ((coalesce(ds_lista_grupo_w::text, '') = '') or (obter_se_contido_char(obter_prod_financ(a.nr_seq_cheque,'CH','G'), ds_lista_grupo_w) = ie_grupo_contido_w))
and    ((coalesce(ds_lista_sub_grupo_w::text, '') = '') or (obter_se_contido_char(obter_prod_financ(a.nr_seq_cheque,'CH','S'), ds_lista_sub_grupo_w) = ie_sub_grupo_contido_w))
and    ((coalesce(ds_lista_produto_w::text, '') = '') or (obter_se_contido_char(obter_prod_financ(a.nr_seq_cheque,'CH','P'), ds_lista_produto_w) = ie_produto_contido_w))
and    coalesce(ie_cheques_relacionados_w,'N') = 'S'

union all

select  a.nr_seq_cheque
FROM cheque_cr a
LEFT OUTER JOIN titulo_receber b ON (a.nr_titulo = b.nr_titulo)
LEFT OUTER JOIN atendimento_paciente c ON (b.nr_atendimento = c.nr_atendimento)
WHERE a.cd_estabelecimento = cd_estabelecimento_w   and coalesce(a.cd_pessoa_fisica,'0')     <> cd_pessoa_fisica_w and obter_status_cheque(a.nr_seq_cheque) in (3,5,10) and c.nr_atendimento       in (select x.nr_atendimento from atendimento_paciente x where x.cd_pessoa_fisica = cd_pessoa_fisica_w) and ((coalesce(ds_lista_grupo_w::text, '') = '') or (obter_se_contido_char(obter_prod_financ(a.nr_seq_cheque,'CH','G'), ds_lista_grupo_w) = ie_grupo_contido_w)) and ((coalesce(ds_lista_sub_grupo_w::text, '') = '') or (obter_se_contido_char(obter_prod_financ(a.nr_seq_cheque,'CH','S'), ds_lista_sub_grupo_w) = ie_sub_grupo_contido_w)) and ((coalesce(ds_lista_produto_w::text, '') = '') or (obter_se_contido_char(obter_prod_financ(a.nr_seq_cheque,'CH','P'), ds_lista_produto_w) = ie_produto_contido_w)) and coalesce(ie_cheques_relacionados_w,'N') = 'S'
 
union

select  a.nr_seq_cheque
FROM cheque_cr a
LEFT OUTER JOIN titulo_receber b ON (a.nr_titulo = b.nr_titulo)
LEFT OUTER JOIN atendimento_paciente c ON (b.nr_atendimento = c.nr_atendimento)
WHERE a.cd_estabelecimento = cd_estabelecimento_w   and exists (select  1
  from  pessoa_jur_resp x
  where  x.cd_cgc    = a.cd_cgc
  and    x.cd_pessoa_fisica  = cd_pessoa_fisica_w) and obter_status_cheque(a.nr_seq_cheque) in (3,5,10) and ((coalesce(ds_lista_grupo_w::text, '') = '') or (obter_se_contido_char(obter_prod_financ(a.nr_seq_cheque,'CH','G'), ds_lista_grupo_w) = ie_grupo_contido_w)) and ((coalesce(ds_lista_sub_grupo_w::text, '') = '') or (obter_se_contido_char(obter_prod_financ(a.nr_seq_cheque,'CH','S'), ds_lista_sub_grupo_w) = ie_sub_grupo_contido_w)) and ((coalesce(ds_lista_produto_w::text, '') = '') or (obter_se_contido_char(obter_prod_financ(a.nr_seq_cheque,'CH','P'), ds_lista_produto_w) = ie_produto_contido_w)) and coalesce(ie_cheques_relacionados_w,'N') = 'S';

c06 CURSOR FOR
SELECT  a.nr_sequencia
from  cobranca a,
  titulo_receber b
where (a.nr_titulo IS NOT NULL AND a.nr_titulo::text <> '')
and  a.nr_titulo = b.nr_titulo
and  a.cd_estabelecimento = cd_estabelecimento_w
and  ((ie_somente_aberto_w = 'N') or (a.ie_status <> 'E'))
and  (((coalesce(ie_pessoa_cobranca_p,'D') = 'D' or coalesce(ie_pessoa_cobranca_p,'D') = 'A') and b.cd_pessoa_fisica = cd_pessoa_fisica_w) or
  ((coalesce(ie_pessoa_cobranca_p,'D') = 'P' or coalesce(ie_pessoa_cobranca_p,'D') = 'A') and
  exists (  SELECT  1
    from  atendimento_paciente x
    where  x.nr_atendimento  = b.nr_atendimento
    and  x.cd_pessoa_fisica  = cd_pessoa_fisica_w
    and  x.cd_estabelecimento  = cd_estabelecimento_w)))
and  (cd_pessoa_fisica_w IS NOT NULL AND cd_pessoa_fisica_w::text <> '')
and  ((coalesce(ds_lista_convenio_w::text, '') = '') or (obter_se_contido(b.cd_convenio_conta,ds_lista_convenio_w) = ie_convenio_contido_w))
and  ((coalesce(ds_lista_grupo_w::text, '') = '') or (obter_se_contido_char(obter_prod_financ(a.nr_sequencia,'CR','G'), ds_lista_grupo_w) = ie_grupo_contido_w))
and  ((coalesce(ds_lista_sub_grupo_w::text, '') = '') or (obter_se_contido_char(obter_prod_financ(a.nr_sequencia,'CR','S'), ds_lista_sub_grupo_w) = ie_sub_grupo_contido_w))
and  ((coalesce(ds_lista_produto_w::text, '') = '') or (obter_se_contido_char(obter_prod_financ(a.nr_sequencia,'CR','P'), ds_lista_produto_w) = ie_produto_contido_w))

union all

select  a.nr_sequencia
from  cobranca a,
  titulo_receber b
where (a.nr_titulo IS NOT NULL AND a.nr_titulo::text <> '')
and  a.nr_titulo = b.nr_titulo
and  a.cd_estabelecimento = cd_estabelecimento_w
and  ((ie_somente_aberto_w = 'N') or (a.ie_status <> 'E'))
and  b.cd_cgc = cd_cgc_w
and  (cd_cgc_w IS NOT NULL AND cd_cgc_w::text <> '')
and  ((coalesce(ds_lista_convenio_w::text, '') = '') or (obter_se_contido(b.cd_convenio_conta,ds_lista_convenio_w) = ie_convenio_contido_w))
and  ((coalesce(ds_lista_grupo_w::text, '') = '') or (obter_se_contido_char(obter_prod_financ(a.nr_sequencia,'CR','G'), ds_lista_grupo_w) = ie_grupo_contido_w))
and  ((coalesce(ds_lista_sub_grupo_w::text, '') = '') or (obter_se_contido_char(obter_prod_financ(a.nr_sequencia,'CR','S'), ds_lista_sub_grupo_w) = ie_sub_grupo_contido_w))
and  ((coalesce(ds_lista_produto_w::text, '') = '') or (obter_se_contido_char(obter_prod_financ(a.nr_sequencia,'CR','P'), ds_lista_produto_w) = ie_produto_contido_w))

union all

select  a.nr_sequencia
from  cobranca a,
  cheque_cr b
where (a.nr_seq_cheque IS NOT NULL AND a.nr_seq_cheque::text <> '')
and a.nr_seq_cheque = b.nr_seq_cheque
and  a.cd_estabelecimento = cd_estabelecimento_w
and  ((ie_somente_aberto_w = 'N') or (a.ie_status <> 'E'))
and  (((coalesce(ie_pessoa_cobranca_p,'D') = 'D' or coalesce(ie_pessoa_cobranca_p,'D') = 'A') and b.cd_pessoa_fisica = cd_pessoa_fisica_w) or
  ((coalesce(ie_pessoa_cobranca_p,'D') = 'P' or coalesce(ie_pessoa_cobranca_p,'D') = 'A') and
  exists (  select  1
    from  atendimento_paciente x
    where  x.nr_atendimento  = obter_dados_cheque_cr(b.nr_seq_cheque,'NA')
    and  x.cd_pessoa_fisica  = cd_pessoa_fisica_w
    and  x.cd_estabelecimento  = cd_estabelecimento_w)))
and  (cd_pessoa_fisica_w IS NOT NULL AND cd_pessoa_fisica_w::text <> '')
and  ((coalesce(ds_lista_grupo_w::text, '') = '') or (obter_se_contido_char(obter_prod_financ(a.nr_sequencia,'CR','G'), ds_lista_grupo_w) = ie_grupo_contido_w))
and  ((coalesce(ds_lista_sub_grupo_w::text, '') = '') or (obter_se_contido_char(obter_prod_financ(a.nr_sequencia,'CR','S'), ds_lista_sub_grupo_w) = ie_sub_grupo_contido_w))
and  ((coalesce(ds_lista_produto_w::text, '') = '') or (obter_se_contido_char(obter_prod_financ(a.nr_sequencia,'CR','P'), ds_lista_produto_w) = ie_produto_contido_w))

union all

select  a.nr_sequencia
from  cobranca a,
  cheque_cr b
where (a.nr_seq_cheque IS NOT NULL AND a.nr_seq_cheque::text <> '')
and  a.nr_seq_cheque = b.nr_seq_cheque
and  a.cd_estabelecimento = cd_estabelecimento_w
and  ((ie_somente_aberto_w = 'N') or (a.ie_status <> 'E'))
and  b.cd_cgc = cd_cgc_w
and  (cd_cgc_w IS NOT NULL AND cd_cgc_w::text <> '')
and  ((coalesce(ds_lista_grupo_w::text, '') = '') or (obter_se_contido_char(obter_prod_financ(a.nr_sequencia,'CR','G'), ds_lista_grupo_w) = ie_grupo_contido_w))
and  ((coalesce(ds_lista_sub_grupo_w::text, '') = '') or (obter_se_contido_char(obter_prod_financ(a.nr_sequencia,'CR','S'), ds_lista_sub_grupo_w) = ie_sub_grupo_contido_w))
and  ((coalesce(ds_lista_produto_w::text, '') = '') or (obter_se_contido_char(obter_prod_financ(a.nr_sequencia,'CR','P'), ds_lista_produto_w) = ie_produto_contido_w));


c07 CURSOR FOR
SELECT  a.nr_interno_conta
from  conta_paciente a,
  atendimento_paciente b
where  a.nr_atendimento = b.nr_atendimento
and  b.cd_pessoa_fisica = cd_pessoa_fisica_w
and  coalesce(a.ie_cancelamento::text, '') = ''
and  a.cd_estabelecimento = cd_estabelecimento_w
and  ((ie_somente_aberto_w = 'N') or
  ((ie_somente_aberto_w = 'S') and
      not exists (  SELECT   1
          from   titulo_receber x
          where  x.nr_interno_conta = a.nr_interno_conta
          and  x.ie_situacao <> 3)
      and (coalesce(obter_perda_conta_paciente(nr_interno_conta),0) = 0)
      and not exists (  select  1
          from  nota_fiscal y
          where  y.nr_interno_conta = a.nr_interno_conta
          and  y.ie_situacao = 1)
      and not exists ( select  1
          from  nota_fiscal w
          where  w.nr_seq_protocolo = a.nr_seq_protocolo
          and  w.ie_situacao = 1)))
and  (cd_pessoa_fisica_w IS NOT NULL AND cd_pessoa_fisica_w::text <> '')

union all

select  a.nr_interno_conta
from  conta_paciente a,
  atendimento_paciente b,
  atendimento_pagador c
where  a.nr_atendimento = b.nr_atendimento
and  b.nr_atendimento = c.nr_atendimento
and  c.cd_pessoa_fisica = cd_pessoa_fisica_w
and  coalesce(a.ie_cancelamento::text, '') = ''
and  a.cd_estabelecimento = cd_estabelecimento_w
and  ((ie_somente_aberto_w = 'N') or
  ((ie_somente_aberto_w = 'S') and
      not exists (  select   1
          from   titulo_receber x
          where  x.nr_interno_conta = a.nr_interno_conta
          and  x.ie_situacao <> 3)
      and (coalesce(obter_perda_conta_paciente(nr_interno_conta),0) = 0)
      and not exists (  select  1
          from  nota_fiscal y
          where  y.nr_interno_conta = a.nr_interno_conta
          and  y.ie_situacao = 1)
      and not exists ( select  1
          from  nota_fiscal w
          where  w.nr_seq_protocolo = a.nr_seq_protocolo
          and  w.ie_situacao = 1)))
and  (cd_pessoa_fisica_w IS NOT NULL AND cd_pessoa_fisica_w::text <> '');

c08 CURSOR FOR
SELECT  a.nr_sequencia
from  movto_cartao_cr a,
  caixa_receb b
where  a.nr_seq_caixa_rec = b.nr_sequencia
and  a.ie_lib_caixa = 'S'
and  a.cd_estabelecimento = cd_estabelecimento_w
and  b.cd_cgc = cd_cgc_w
and  (cd_cgc_w IS NOT NULL AND cd_cgc_w::text <> '')
and  ((coalesce(ds_lista_grupo_w::text, '') = '') or (obter_se_contido_char(obter_prod_financ(a.nr_sequencia,'AC','G'), ds_lista_grupo_w) = ie_grupo_contido_w))
and  ((coalesce(ds_lista_sub_grupo_w::text, '') = '') or (obter_se_contido_char(obter_prod_financ(a.nr_sequencia,'AC','S'), ds_lista_sub_grupo_w) = ie_sub_grupo_contido_w))
and  ((coalesce(ds_lista_produto_w::text, '') = '') or (obter_se_contido_char(obter_prod_financ(a.nr_sequencia,'AC','P'), ds_lista_produto_w) = ie_produto_contido_w))

union all

SELECT  a.nr_sequencia
from  movto_cartao_cr a,
  caixa_receb b
where  a.nr_seq_caixa_rec = b.nr_sequencia
and  a.ie_lib_caixa = 'S'
and  a.cd_estabelecimento = cd_estabelecimento_w
and  b.cd_pessoa_fisica = cd_pessoa_fisica_w
and  (cd_pessoa_fisica_w IS NOT NULL AND cd_pessoa_fisica_w::text <> '')
and  ((coalesce(ds_lista_grupo_w::text, '') = '') or (obter_se_contido_char(obter_prod_financ(a.nr_sequencia,'AC','G'), ds_lista_grupo_w) = ie_grupo_contido_w))
and  ((coalesce(ds_lista_sub_grupo_w::text, '') = '') or (obter_se_contido_char(obter_prod_financ(a.nr_sequencia,'AC','S'), ds_lista_sub_grupo_w) = ie_sub_grupo_contido_w))
and  ((coalesce(ds_lista_produto_w::text, '') = '') or (obter_se_contido_char(obter_prod_financ(a.nr_sequencia,'AC','P'), ds_lista_produto_w) = ie_produto_contido_w));


c09 CURSOR FOR
SELECT  a.nr_seq_protocolo
from  protocolo_convenio a,
  convenio b
where  a.cd_convenio = b.cd_convenio
and  a.cd_estabelecimento = cd_estabelecimento_w
and  b.cd_cgc = cd_cgc_w
and  ((ie_somente_aberto_w = 'N') or
  ((ie_somente_aberto_w = 'S')
  and length(substr(obter_titulo_conta_protocolo(a.nr_seq_protocolo,0),1,254)) is null
  and length(substr(obter_nota_conta_protocolo(a.nr_seq_protocolo,0),1,254)) is null))
and  (cd_cgc_w IS NOT NULL AND cd_cgc_w::text <> '')
and  ((coalesce(ds_lista_convenio_w::text, '') = '') or (obter_se_contido(b.cd_convenio,ds_lista_convenio_w) = ie_convenio_contido_w));

c010 CURSOR FOR
SELECT  a.nr_sequencia
from  titulo_receber c,
  pls_mensalidade a,
  pls_contrato_pagador b
where  a.nr_seq_pagador = b.nr_sequencia
and  a.nr_sequencia  = c.nr_seq_mensalidade
and  b.cd_pessoa_fisica = cd_pessoa_fisica_w
and  c.cd_estabelecimento = cd_estabelecimento_w
and  ((ie_somente_aberto_p = 'N') or (c.dt_liquidacao IS NOT NULL AND c.dt_liquidacao::text <> ''))
and  (cd_pessoa_fisica_w IS NOT NULL AND cd_pessoa_fisica_w::text <> '')
and  ((coalesce(ds_lista_convenio_w::text, '') = '') or (obter_se_contido(c.cd_convenio_conta,ds_lista_convenio_w) = ie_convenio_contido_w))
group by a.nr_sequencia

union all

SELECT  a.nr_sequencia
from  titulo_receber c,
  pls_mensalidade a,
  pls_contrato_pagador b
where  a.nr_seq_pagador = b.nr_sequencia
and  a.nr_sequencia  = c.nr_seq_mensalidade
and  b.cd_cgc = cd_cgc_w
and  c.cd_estabelecimento = cd_estabelecimento_w
and  ((ie_somente_aberto_p = 'N') or (c.dt_liquidacao IS NOT NULL AND c.dt_liquidacao::text <> ''))
and  (cd_cgc_w IS NOT NULL AND cd_cgc_w::text <> '')
and  ((coalesce(ds_lista_convenio_w::text, '') = '') or (obter_se_contido(c.cd_convenio_conta,ds_lista_convenio_w) = ie_convenio_contido_w))
group by a.nr_sequencia;


c011 CURSOR FOR
SELECT  a.nr_sequencia
from  negociacao_cr a
where  a.cd_pessoa_fisica = cd_pessoa_fisica_w
and  a.cd_estabelecimento = cd_estabelecimento_w
and  ((ie_somente_aberto_p = 'N') or (coalesce(a.dt_liquidacao::text, '') = ''))
and  (cd_pessoa_fisica_w IS NOT NULL AND cd_pessoa_fisica_w::text <> '')

union all

SELECT  a.nr_sequencia
from  negociacao_cr a,
  titulo_rec_negociado b,
  titulo_receber c
where  b.nr_seq_negociacao = a.nr_sequencia
and  b.nr_titulo = c.nr_titulo
and  a.cd_pessoa_fisica <> cd_pessoa_fisica_w
and  c.cd_pessoa_fisica = cd_pessoa_fisica_w
and  a.cd_estabelecimento = cd_estabelecimento_w
and  ((ie_somente_aberto_p = 'N') or (coalesce(a.dt_liquidacao::text, '') = ''))
and  (cd_pessoa_fisica_w IS NOT NULL AND cd_pessoa_fisica_w::text <> '')
group by a.nr_sequencia

union all

select  a.nr_sequencia
from  negociacao_cr a
where  a.cd_cgc = cd_cgc_w
and  a.cd_estabelecimento = cd_estabelecimento_w
and  ((ie_somente_aberto_p = 'N') or (coalesce(a.dt_liquidacao::text, '') = ''))
and  (cd_cgc_w IS NOT NULL AND cd_cgc_w::text <> '')

union all

select  a.nr_sequencia
from  negociacao_cr a,
  titulo_rec_negociado b,
  titulo_receber c
where  b.nr_seq_negociacao = a.nr_sequencia
and  b.nr_titulo = c.nr_titulo
and  a.cd_cgc <> cd_cgc_w
and  c.cd_cgc = cd_cgc_w
and  a.cd_estabelecimento = cd_estabelecimento_w
and  ((ie_somente_aberto_p = 'N') or (coalesce(a.dt_liquidacao::text, '') = ''))
and  (cd_cgc_w IS NOT NULL AND cd_cgc_w::text <> '')
and  ((coalesce(ds_lista_convenio_w::text, '') = '') or (obter_se_contido(c.cd_convenio_conta,ds_lista_convenio_w) = ie_convenio_contido_w))
group by a.nr_sequencia;


c012 CURSOR FOR
SELECT  a.nr_titulo
from  titulo_pagar a
where  a.cd_estabelecimento = cd_estabelecimento_w
--and  (ie_somente_aberto_w = 'N' or a.ie_situacao = '1')
and  a.cd_pessoa_fisica = cd_pessoa_fisica_w
and  (cd_pessoa_fisica_w IS NOT NULL AND cd_pessoa_fisica_w::text <> '')
and  ((coalesce(ds_lista_grupo_w::text, '') = '') or (obter_se_contido_char(obter_prod_financ(a.nr_titulo,'TP','G'), ds_lista_grupo_w) = ie_grupo_contido_w))
and  ((coalesce(ds_lista_sub_grupo_w::text, '') = '') or (obter_se_contido_char(obter_prod_financ(a.nr_titulo,'TP','S'), ds_lista_sub_grupo_w) = ie_sub_grupo_contido_w))
and  ((coalesce(ds_lista_produto_w::text, '') = '') or (obter_se_contido_char(obter_prod_financ(a.nr_titulo,'TP','P'), ds_lista_produto_w) = ie_produto_contido_w))

union all

SELECT  a.nr_titulo
from  titulo_pagar a
where  a.cd_estabelecimento = cd_estabelecimento_w
--and  (ie_somente_aberto_w = 'N' or a.ie_situacao = '1')
and  a.cd_cgc = cd_cgc_w
and  (cd_cgc_w IS NOT NULL AND cd_cgc_w::text <> '')
and  ((coalesce(ds_lista_grupo_w::text, '') = '') or (obter_se_contido_char(obter_prod_financ(a.nr_titulo,'TP','G'), ds_lista_grupo_w) = ie_grupo_contido_w))
and  ((coalesce(ds_lista_sub_grupo_w::text, '') = '') or (obter_se_contido_char(obter_prod_financ(a.nr_titulo,'TP','S'), ds_lista_sub_grupo_w) = ie_sub_grupo_contido_w))
and  ((coalesce(ds_lista_produto_w::text, '') = '') or (obter_se_contido_char(obter_prod_financ(a.nr_titulo,'TP','P'), ds_lista_produto_w) = ie_produto_contido_w));


c013 CURSOR FOR
SELECT  a.nr_adiantamento
from  adiantamento_pago a
where  a.cd_estabelecimento = cd_estabelecimento_w
and  a.cd_pessoa_fisica = cd_pessoa_fisica_w
and  (cd_pessoa_fisica_w IS NOT NULL AND cd_pessoa_fisica_w::text <> '')

union all

SELECT  a.nr_adiantamento
from  adiantamento_pago a
where  a.cd_estabelecimento = cd_estabelecimento_w
and  a.cd_cgc = cd_cgc_w
and  (cd_cgc_w IS NOT NULL AND cd_cgc_w::text <> '');


c014 CURSOR FOR
SELECT  a.nr_repasse_terceiro
from  repasse_terceiro a,
  terceiro b
where  a.nr_seq_terceiro = b.nr_sequencia
and  b.ie_situacao = 'A'
and  coalesce(b.ie_utilizacao,'A') in ('A','R')
and  ((ie_somente_aberto_w = 'N') or (a.ie_status = 'A'))
and  a.cd_estabelecimento = cd_estabelecimento_w
and  b.cd_estabelecimento = cd_estabelecimento_w
and  b.cd_pessoa_fisica = cd_pessoa_fisica_w
and  (cd_pessoa_fisica_w IS NOT NULL AND cd_pessoa_fisica_w::text <> '')
and  ((coalesce(ds_lista_convenio_w::text, '') = '') or (obter_se_contido(a.cd_convenio,ds_lista_convenio_w) = ie_convenio_contido_w))

union all

SELECT  a.nr_repasse_terceiro
from  repasse_terceiro a,
  terceiro b
where  a.nr_seq_terceiro = b.nr_sequencia
and  b.ie_situacao = 'A'
and  coalesce(b.ie_utilizacao,'A') in ('A','R')
and  ((ie_somente_aberto_w = 'N') or (a.ie_status = 'A'))
and  a.cd_estabelecimento = cd_estabelecimento_w
and  b.cd_estabelecimento = cd_estabelecimento_w
and  b.cd_cgc = cd_cgc_w
and  (cd_cgc_w IS NOT NULL AND cd_cgc_w::text <> '')
and  ((coalesce(ds_lista_convenio_w::text, '') = '') or (obter_se_contido(a.cd_convenio,ds_lista_convenio_w) = ie_convenio_contido_w));


c015 CURSOR FOR
SELECT  nr_sequencia
from  nota_credito a
where  a.cd_estabelecimento = cd_estabelecimento_w
and  a.cd_pessoa_fisica = cd_pessoa_fisica_w
and  ((ie_somente_aberto_p = 'N') or (a.ie_situacao = 'A'))
and  (cd_pessoa_fisica_w IS NOT NULL AND cd_pessoa_fisica_w::text <> '')

union all

SELECT  nr_sequencia
from  nota_credito a
where  a.cd_estabelecimento = cd_estabelecimento_w
and  a.cd_cgc = cd_cgc_w
and  ((ie_somente_aberto_p = 'N') or (a.ie_situacao = 'A'))
and  (cd_cgc_w IS NOT NULL AND cd_cgc_w::text <> '');


c016 CURSOR FOR
SELECT   a.nr_sequencia
from  perda_contas_receber a
where  a.cd_estabelecimento = cd_estabelecimento_w
and  a.cd_pessoa_fisica = cd_pessoa_fisica_w
and  (cd_pessoa_fisica_w IS NOT NULL AND cd_pessoa_fisica_w::text <> '')
and  ((coalesce(ds_lista_grupo_w::text, '') = '') or (obter_se_contido_char(obter_prod_financ(a.nr_sequencia,'PR','G'), ds_lista_grupo_w) = ie_grupo_contido_w))
and  ((coalesce(ds_lista_sub_grupo_w::text, '') = '') or (obter_se_contido_char(obter_prod_financ(a.nr_sequencia,'PR','S'), ds_lista_sub_grupo_w) = ie_sub_grupo_contido_w))
and  ((coalesce(ds_lista_produto_w::text, '') = '') or (obter_se_contido_char(obter_prod_financ(a.nr_sequencia,'PR','P'), ds_lista_produto_w) = ie_produto_contido_w))

union all

SELECT   a.nr_sequencia
from  perda_contas_receber a
where  a.cd_estabelecimento = cd_estabelecimento_w
and  a.cd_cgc = cd_cgc_w
and  (cd_cgc_w IS NOT NULL AND cd_cgc_w::text <> '')
and  ((coalesce(ds_lista_grupo_w::text, '') = '') or (obter_se_contido_char(obter_prod_financ(a.nr_sequencia,'PR','G'), ds_lista_grupo_w) = ie_grupo_contido_w))
and  ((coalesce(ds_lista_sub_grupo_w::text, '') = '') or (obter_se_contido_char(obter_prod_financ(a.nr_sequencia,'PR','S'), ds_lista_sub_grupo_w) = ie_sub_grupo_contido_w))
and  ((coalesce(ds_lista_produto_w::text, '') = '') or (obter_se_contido_char(obter_prod_financ(a.nr_sequencia,'PR','P'), ds_lista_produto_w) = ie_produto_contido_w));


c017 CURSOR FOR
SELECT  a.nr_seq_spa
from  spa_movimento a,
  titulo_receber b
where  a.nr_titulo = b.nr_titulo
and  b.cd_pessoa_fisica = cd_pessoa_fisica_w
and  (cd_pessoa_fisica_w IS NOT NULL AND cd_pessoa_fisica_w::text <> '')
group by  a.nr_seq_spa

union all

SELECT  a.nr_seq_spa
from  spa_movimento a,
  atendimento_paciente b
where  a.nr_atendimento = b.nr_atendimento
and  b.cd_pessoa_fisica = cd_pessoa_fisica_w
and  (cd_pessoa_fisica_w IS NOT NULL AND cd_pessoa_fisica_w::text <> '')
group by  a.nr_seq_spa

union all

select  a.nr_seq_spa
from  spa_movimento a,
  conta_paciente b,
  atendimento_paciente c
where  a.nr_interno_conta = b.nr_interno_conta
and  b.nr_atendimento = c.nr_atendimento
and  c.cd_pessoa_fisica = cd_pessoa_fisica_w
and  (cd_pessoa_fisica_w IS NOT NULL AND cd_pessoa_fisica_w::text <> '')
group by  a.nr_seq_spa

union all

select  a.nr_seq_spa
from  spa_movimento a,
  protocolo_convenio b,
  convenio c
where  a.nr_seq_protocolo = b.nr_seq_protocolo
and  b.cd_convenio = c.cd_convenio
and  c.cd_cgc = cd_cgc_w
and  (cd_cgc_w IS NOT NULL AND cd_cgc_w::text <> '')
group by  a.nr_seq_spa

union all

select  a.nr_seq_spa
from  spa_movimento a,
  nota_fiscal b
where  a.nr_seq_nf = b.nr_sequencia
and  b.cd_pessoa_fisica = cd_pessoa_fisica_w
and  (cd_pessoa_fisica_w IS NOT NULL AND cd_pessoa_fisica_w::text <> '')
group by  a.nr_seq_spa;

--aamfirmo OS 572423 10/04/2013 chequue vinculado a varios titulos através de lotes da tesouraria
C18 CURSOR FOR
SELECT    C.NR_SEQ_CHEQUE
FROM    TITULO_RECEBER_LIQ A,
    CAIXA_RECEB B,
    CHEQUE_CR C,
    TITULO_RECEBER D
WHERE    D.NR_TITULO = A.NR_TITULO
AND    A.NR_SEQ_CAIXA_REC = B.NR_SEQUENCIA
AND    B.NR_SEQUENCIA = C.NR_SEQ_CAIXA_REC
--AND    C.CD_PESSOA_FISICA =  CD_PESSOA_FISICA_W

--AND    C.NR_TITULO IS NULL
AND    D.CD_PESSOA_FISICA = CD_PESSOA_FISICA_W
AND    C.CD_ESTABELECIMENTO = CD_ESTABELECIMENTO_W
AND    (CD_PESSOA_FISICA_W IS NOT NULL AND CD_PESSOA_FISICA_W::text <> '')
AND    ((coalesce(ds_lista_grupo_w::text, '') = '') OR (obter_se_contido_char(obter_prod_financ(c.nr_seq_cheque,'CH','G'), ds_lista_grupo_w) = ie_grupo_contido_w))
AND    ((coalesce(ds_lista_sub_grupo_w::text, '') = '') OR (obter_se_contido_char(obter_prod_financ(c.nr_seq_cheque,'CH','S'), ds_lista_sub_grupo_w) = ie_sub_grupo_contido_w))
AND    ((coalesce(ds_lista_produto_w::text, '') = '') OR (obter_se_contido_char(obter_prod_financ(c.nr_seq_cheque,'CH','P'), ds_lista_produto_w) = ie_produto_contido_w))

union all

SELECT    C.NR_SEQ_CHEQUE
FROM    TITULO_RECEBER_LIQ A,
    CAIXA_RECEB B,
    CHEQUE_CR C,
    TITULO_RECEBER D
WHERE     D.NR_TITULO = A.NR_TITULO
AND    A.NR_SEQ_CAIXA_REC = B.NR_SEQUENCIA
AND    B.NR_SEQUENCIA = C.NR_SEQ_CAIXA_REC
--AND    C.CD_CGC = CD_CGC_W

--AND    C.NR_TITULO IS NULL
AND    D.CD_CGC = CD_CGC_W
AND    C.CD_ESTABELECIMENTO = CD_ESTABELECIMENTO_W
AND    (CD_CGC_W IS NOT NULL AND CD_CGC_W::text <> '')
AND    ((coalesce(ds_lista_grupo_w::text, '') = '') OR (obter_se_contido_char(obter_prod_financ(c.nr_seq_cheque,'CH','G'), ds_lista_grupo_w) = ie_grupo_contido_w))
AND    ((coalesce(ds_lista_sub_grupo_w::text, '') = '') OR (obter_se_contido_char(obter_prod_financ(c.nr_seq_cheque,'CH','S'), ds_lista_sub_grupo_w) = ie_sub_grupo_contido_w))
AND    ((coalesce(ds_lista_produto_w::text, '') = '') OR (obter_se_contido_char(obter_prod_financ(c.nr_seq_cheque,'CH','P'), ds_lista_produto_w) = ie_produto_contido_w))

union all

select  a.nr_seq_cheque
from  cheque_cr a
where  a.cd_estabelecimento = cd_estabelecimento_w
and  a.cd_pessoa_fisica = cd_pessoa_fisica_w
and  (cd_pessoa_fisica_w IS NOT NULL AND cd_pessoa_fisica_w::text <> '')
and  ((coalesce(ds_lista_grupo_w::text, '') = '') or (obter_se_contido_char(obter_prod_financ(a.nr_seq_cheque,'CH','G'), ds_lista_grupo_w) = ie_grupo_contido_w))
and  ((coalesce(ds_lista_sub_grupo_w::text, '') = '') or (obter_se_contido_char(obter_prod_financ(a.nr_seq_cheque,'CH','S'), ds_lista_sub_grupo_w) = ie_sub_grupo_contido_w))
and  ((coalesce(ds_lista_produto_w::text, '') = '') or (obter_se_contido_char(obter_prod_financ(a.nr_seq_cheque,'CH','P'), ds_lista_produto_w) = ie_produto_contido_w))

union all

select  a.nr_seq_cheque
from  cheque_cr a
where  a.cd_estabelecimento = cd_estabelecimento_w
and  a.cd_cgc = cd_cgc_w
and  (cd_cgc_w IS NOT NULL AND cd_cgc_w::text <> '')
and  ((coalesce(ds_lista_grupo_w::text, '') = '') or (obter_se_contido_char(obter_prod_financ(a.nr_seq_cheque,'CH','G'), ds_lista_grupo_w) = ie_grupo_contido_w))
and  ((coalesce(ds_lista_sub_grupo_w::text, '') = '') or (obter_se_contido_char(obter_prod_financ(a.nr_seq_cheque,'CH','S'), ds_lista_sub_grupo_w) = ie_sub_grupo_contido_w))
and  ((coalesce(ds_lista_produto_w::text, '') = '') or (obter_se_contido_char(obter_prod_financ(a.nr_seq_cheque,'CH','P'), ds_lista_produto_w) = ie_produto_contido_w));


BEGIN
ie_somente_aberto_w  := coalesce(ie_somente_aberto_p, 'S');
dt_referencia_w    := fim_dia(dt_referencia_p);

ie_buscar_cheques_w := obter_param_usuario(5512, 14, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_buscar_cheques_w);
ie_cheques_relacionados_w := obter_param_usuario(5512, 19, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_cheques_relacionados_w);

/*  Filtros multi-seleção */


-- Estabelecimento
if (ds_lista_estab_p IS NOT NULL AND ds_lista_estab_p::text <> '') then
  begin
  ds_lista_estab_w := substr(ds_lista_estab_p,position('(' in ds_lista_estab_p) + 1,255);
  ds_lista_estab_w := substr(ds_lista_estab_w,1,length(ds_lista_estab_w) - 1);

  if (position(' NOT ' in upper(ds_lista_estab_p)) > 0) then
    ie_estab_contido_w := 'N';
  end if;
  end;
  /*
  Back end está enviando os códigos dos estabelecimentos e acrescentando no final, sempre por ','.
  Devido à isto, foi realizado tratamento no PL / SQL, para retirar o último caractere que seria a vírgula.
  Exemplo: 1, 10, 683,
  Tratamento: 1, 10, 683
  Caso seja feito o tratamento no back end, remover a linha abaixo para evitar problemas.
  */
  ds_lista_estab_w := trim(both ds_lista_estab_w);
  IF substr(ds_lista_estab_w,length(ds_lista_estab_w),length(ds_lista_estab_w)+1) = ',' THEN
    ds_lista_estab_w:=substr(ds_lista_estab_w,1,length(ds_lista_estab_w)-1);
  END IF;
end if;




--Convênio
if (ds_lista_convenio_p IS NOT NULL AND ds_lista_convenio_p::text <> '') then
  begin
  ds_lista_convenio_w := substr(ds_lista_convenio_p,position('(' in ds_lista_convenio_p) + 1,255);
  ds_lista_convenio_w := substr(ds_lista_convenio_w,1,length(ds_lista_convenio_w) - 1);

  if (position(' NOT ' in upper(ds_lista_convenio_p)) > 0) then
    ie_convenio_contido_w := 'N';
  end if;
  end;
end if;

--Grupo Produto
if (ds_lista_grupo_p IS NOT NULL AND ds_lista_grupo_p::text <> '') then
  begin
  ds_lista_grupo_w := substr(ds_lista_grupo_p,position('(' in ds_lista_grupo_p) + 1,255);
  ds_lista_grupo_w := substr(ds_lista_grupo_w,1,length(ds_lista_grupo_w) - 1);

  if (position(' NOT ' in upper(ds_lista_grupo_p)) > 0) then
    ie_grupo_contido_w := 'N';
  end if;
  end;
end if;

--Sub-Grupo
if (ds_lista_sub_grupo_p IS NOT NULL AND ds_lista_sub_grupo_p::text <> '') then
  begin
  ds_lista_sub_grupo_w := substr(ds_lista_sub_grupo_p,position('(' in ds_lista_sub_grupo_p) + 1,255);
  ds_lista_sub_grupo_w := substr(ds_lista_sub_grupo_w,1,length(ds_lista_sub_grupo_w) - 1);

  if (position(' NOT ' in upper(ds_lista_sub_grupo_p)) > 0) then
    ie_sub_grupo_contido_w := 'N';
  end if;
  end;
end if;

--Produto Financeiro
if (ds_lista_produto_p IS NOT NULL AND ds_lista_produto_p::text <> '') then
  begin
  ds_lista_produto_w := substr(ds_lista_produto_p,position('(' in ds_lista_produto_p) + 1,255);
  ds_lista_produto_w := substr(ds_lista_produto_w,1,length(ds_lista_produto_w) - 1);

  if (position(' NOT ' in upper(ds_lista_produto_w)) > 0) then
    ie_produto_contido_w := 'N';
  end if;
  end;
end if;


if (cd_pessoa_fisica_p IS NOT NULL AND cd_pessoa_fisica_p::text <> '') then
  delete  FROM w_ficha_financ_consulta
  where  nm_usuario = nm_usuario_p
  and  cd_pessoa_fisica = cd_pessoa_fisica_p;
elsif (cd_cgc_p IS NOT NULL AND cd_cgc_p::text <> '') then
  begin
  cd_cgc_raiz_w := obter_cnpj_raiz(cd_cgc_p);

  delete  FROM w_ficha_financ_consulta
  where  nm_usuario = nm_usuario_p
  and  cd_cgc = cd_cgc_p;
  end;
else
  delete  FROM w_ficha_financ_consulta
  where  nm_usuario = nm_usuario_p;
end if;

commit;

select  coalesce(max(nr_sequencia),0)
into STRICT  nr_sequencia_w
from  w_ficha_financ_consulta
where  nm_usuario = nm_usuario_p;

select  coalesce(max('S'),'N')
into STRICT  ie_prod_perfil_w
from  grupo_prod_financ_perfil LIMIT 1;

open c01;
loop
fetch c01 into
  nr_seq_item_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
  begin
  open c02;
  loop
  fetch c02 into
    cd_estabelecimento_w;
  EXIT WHEN NOT FOUND; /* apply on c02 */
    begin
    open C00;
    loop
    fetch C00 into
      cd_pessoa_fisica_w,
      cd_cgc_w;
    EXIT WHEN NOT FOUND; /* apply on C00 */
      begin
      if (nr_seq_item_w = 1) then  /*títulos a receber*/
        open c03;
        loop
        fetch c03 into
          nr_titulo_cr_w;
        EXIT WHEN NOT FOUND; /* apply on c03 */
          begin
          ie_gravar_w  := 'S';

          if (ie_somente_aberto_w = 'S') then
            begin
            ie_gravar_w  := 'N';
            vl_saldo_w   := obter_saldo_titulo_receber(nr_titulo_cr_w, dt_referencia_w);

            if (vl_saldo_w > 0) then
              ie_gravar_w := 'S';
            end if;
            end;
          end if;

          if (ie_gravar_w = 'S') and (cd_pessoa_fisica_w IS NOT NULL AND cd_pessoa_fisica_w::text <> '') and (ie_registro_conv_p = 'N') then
            begin
            cd_convenio_w  := obter_dados_titulo_receber(nr_titulo_cr_w,'CO');

            select  max(ie_tipo_convenio)
            into STRICT  ie_tipo_convenio_w
            from  convenio
            where  cd_convenio = cd_convenio_w;

            if (ie_tipo_convenio_w = '2') then
              ie_gravar_w  := 'N';
            end if;
            end;
          end if;

          if (ie_gravar_w = 'S') and (ie_prod_perfil_w = 'S') then
            begin
            nr_seq_grupo_prod_w   := OBTER_PROD_FINANC(nr_titulo_cr_w, 'TR', 'G');

            if (nr_seq_grupo_prod_w = 99999) then
              nr_seq_grupo_prod_w := null;
            end if;

            if (nr_seq_grupo_prod_w IS NOT NULL AND nr_seq_grupo_prod_w::text <> '') then
              begin
              select  count(*)
              into STRICT  qt_reg_w
              from  grupo_prod_financ_perfil x
              where  x.nr_seq_grupo = nr_seq_grupo_prod_w;

              if (qt_reg_w = 0) then
                ie_gravar_w := 'S';
              else
                select  coalesce(max(x.ie_acesso),'N')
                into STRICT  ie_gravar_w
                from  grupo_prod_financ_perfil x
                where  x.nr_seq_grupo  = nr_seq_grupo_prod_w
                and  x.cd_perfil   = cd_perfil_ativo_p
                and  coalesce(x.ie_acesso,'S') = 'S';
              end if;
              end;
            else
              begin
              select  ie_acesso
              into STRICT  ie_gravar_w
              from  grupo_prod_financ_perfil
              where  cd_perfil  = cd_perfil_ativo_p
              and  coalesce(nr_seq_grupo::text, '') = ''  LIMIT 1;
              exception
              when no_data_found then
                ie_gravar_w := 'S';
              end;
            end if;
            end;
          end if;

          if (ie_gravar_w = 'S') then
            begin
            nr_sequencia_w := nr_sequencia_w + 1;

            insert into w_ficha_financ_consulta(
              nr_sequencia,
              dt_atualizacao,
              nm_usuario,
              nr_titulo_cr,
              cd_cgc,
              cd_pessoa_fisica)
            values (  nr_sequencia_w,
              clock_timestamp(),
              nm_usuario_p,
              nr_titulo_cr_w,
              cd_cgc_p,
              cd_pessoa_fisica_p);
            end;
          end if;
          end;
        end loop;
        close c03;
      elsif (nr_seq_item_w = 7) then  /*adiantamento*/
        open c04;
        loop
        fetch c04 into
          nr_adiantamento_cr_w;
        EXIT WHEN NOT FOUND; /* apply on c04 */
          begin
          ie_gravar_w  := 'S';

          if (ie_somente_aberto_w = 'S') then
            begin
            ie_gravar_w  := 'N';
            vl_saldo_w   := obter_saldo_adiantamento(nr_adiantamento_cr_w, dt_referencia_w);

            if (vl_saldo_w > 0) then
              ie_gravar_w := 'S';
            end if;
            end;
          end if;

          if (ie_gravar_w = 'S') and (ie_prod_perfil_w = 'S') then
            begin
            nr_seq_grupo_prod_w   := OBTER_PROD_FINANC(nr_adiantamento_cr_w, 'AD', 'G');

            if (nr_seq_grupo_prod_w = 99999) then
              nr_seq_grupo_prod_w := null;
            end if;

            if (nr_seq_grupo_prod_w IS NOT NULL AND nr_seq_grupo_prod_w::text <> '') then
              begin
              select  count(*)
              into STRICT  qt_reg_w
              from  grupo_prod_financ_perfil x
              where  x.nr_seq_grupo = nr_seq_grupo_prod_w;

              if (qt_reg_w = 0) then
                ie_gravar_w := 'S';
              else
                select  coalesce(max(x.ie_acesso),'N')
                into STRICT  ie_gravar_w
                from  grupo_prod_financ_perfil x
                where  x.nr_seq_grupo  = nr_seq_grupo_prod_w
                and  x.cd_perfil   = cd_perfil_ativo_p
                and  coalesce(x.ie_acesso,'S') = 'S';
              end if;
              end;
            else
              begin
              select  ie_acesso
              into STRICT  ie_gravar_w
              from  grupo_prod_financ_perfil
              where  cd_perfil  = cd_perfil_ativo_p
              and  coalesce(nr_seq_grupo::text, '') = ''  LIMIT 1;
              exception
              when no_data_found then
                ie_gravar_w := 'S';
              end;
            end if;
            end;
          end if;

          if (ie_gravar_w = 'S') then
            begin
            nr_sequencia_w := nr_sequencia_w + 1;

            insert into w_ficha_financ_consulta(
              nr_sequencia,
              dt_atualizacao,
              nm_usuario,
              nr_adiantamento_cr,
              cd_cgc,
              cd_pessoa_fisica)
            values (  nr_sequencia_w,
              clock_timestamp(),
              nm_usuario_p,
              nr_adiantamento_cr_w,
              cd_cgc_p,
              cd_pessoa_fisica_p);
            end;
          end if;
          end;
        end loop;
        close c04;
      elsif (nr_seq_item_w = 8) then  /*cheque contas a receber*/
        if ( coalesce(ie_buscar_cheques_w,'N') = 'S' ) then --aamfirmo OS 572423 10/04/2013 chequue vinculado a varios titulos através de lotes da tesouraria
          open c18;
          loop
          fetch c18 into
            nr_seq_cheque_cr_w;
          EXIT WHEN NOT FOUND; /* apply on c18 */
            begin
            ie_gravar_w := 'S';

            if (ie_gravar_w = 'S') and (ie_prod_perfil_w = 'S') then
              begin
              nr_seq_grupo_prod_w   := OBTER_PROD_FINANC(nr_seq_cheque_cr_w, 'CH', 'G');

              if (nr_seq_grupo_prod_w = 99999) then
                nr_seq_grupo_prod_w := null;
              end if;

              if (nr_seq_grupo_prod_w IS NOT NULL AND nr_seq_grupo_prod_w::text <> '') then
                begin
                select  count(*)
                into STRICT  qt_reg_w
                from  grupo_prod_financ_perfil x
                where  x.nr_seq_grupo = nr_seq_grupo_prod_w;

                if (qt_reg_w = 0) then
                  ie_gravar_w := 'S';
                else
                  select  coalesce(max(x.ie_acesso),'N')
                  into STRICT  ie_gravar_w
                  from  grupo_prod_financ_perfil x
                  where  x.nr_seq_grupo  = nr_seq_grupo_prod_w
                  and  x.cd_perfil   = cd_perfil_ativo_p
                  and  coalesce(x.ie_acesso,'S') = 'S';
                end if;
                end;
              else
                begin
                select  ie_acesso
                into STRICT  ie_gravar_w
                from  grupo_prod_financ_perfil
                where  cd_perfil  = cd_perfil_ativo_p
                and  coalesce(nr_seq_grupo::text, '') = ''  LIMIT 1;
                exception
                when no_data_found then
                  ie_gravar_w := 'S';
                end;
              end if;
              end;
            end if;

            if (ie_gravar_w = 'S') then
              begin
              nr_sequencia_w := nr_sequencia_w + 1;

              insert into w_ficha_financ_consulta(
                nr_sequencia,
                dt_atualizacao,
                nm_usuario,
                nr_seq_cheque_cr,
                cd_cgc,
                cd_pessoa_fisica)
              values (  nr_sequencia_w,
                clock_timestamp(),
                nm_usuario_p,
                nr_seq_cheque_cr_w,
                cd_cgc_p,
                cd_pessoa_fisica_p);
              end;
            end if;
            end;
          end loop;
          close c18;

        else

          open c05;
          loop
          fetch c05 into
            nr_seq_cheque_cr_w;
          EXIT WHEN NOT FOUND; /* apply on c05 */
            begin
            ie_gravar_w := 'S';

            if (ie_gravar_w = 'S') and (ie_prod_perfil_w = 'S') then
              begin
              nr_seq_grupo_prod_w   := OBTER_PROD_FINANC(nr_seq_cheque_cr_w, 'CH', 'G');

              if (nr_seq_grupo_prod_w = 99999) then
                nr_seq_grupo_prod_w := null;
              end if;

              if (nr_seq_grupo_prod_w IS NOT NULL AND nr_seq_grupo_prod_w::text <> '') then
                begin
                select  count(*)
                into STRICT  qt_reg_w
                from  grupo_prod_financ_perfil x
                where  x.nr_seq_grupo = nr_seq_grupo_prod_w;

                if (qt_reg_w = 0) then
                  ie_gravar_w := 'S';
                else
                  select  coalesce(max(x.ie_acesso),'N')
                  into STRICT  ie_gravar_w
                  from  grupo_prod_financ_perfil x
                  where  x.nr_seq_grupo  = nr_seq_grupo_prod_w
                  and  x.cd_perfil   = cd_perfil_ativo_p
                  and  coalesce(x.ie_acesso,'S') = 'S';
                end if;
                end;
              else
                begin
                select  ie_acesso
                into STRICT  ie_gravar_w
                from  grupo_prod_financ_perfil
                where  cd_perfil  = cd_perfil_ativo_p
                and  coalesce(nr_seq_grupo::text, '') = ''  LIMIT 1;
                exception
                when no_data_found then
                  ie_gravar_w := 'S';
                end;
              end if;
              end;
            end if;

            if (ie_gravar_w = 'S') then
              begin
              nr_sequencia_w := nr_sequencia_w + 1;

              insert into w_ficha_financ_consulta(
                nr_sequencia,
                dt_atualizacao,
                nm_usuario,
                nr_seq_cheque_cr,
                cd_cgc,
                cd_pessoa_fisica)
              values (  nr_sequencia_w,
                clock_timestamp(),
                nm_usuario_p,
                nr_seq_cheque_cr_w,
                cd_cgc_p,
                cd_pessoa_fisica_p);
              end;
            end if;
            end;
          end loop;
          close c05;
        end if;

      elsif (nr_seq_item_w = 9) then  /*cobrança*/
        open c06;
        loop
        fetch c06 into
          nr_seq_cobranca_w;
        EXIT WHEN NOT FOUND; /* apply on c06 */
          begin
          ie_gravar_w := 'S';

          if (ie_gravar_w = 'S') and (ie_prod_perfil_w = 'S') then
            begin
            nr_seq_grupo_prod_w   := OBTER_PROD_FINANC(nr_seq_cobranca_w, 'CR', 'G');

            if (nr_seq_grupo_prod_w = 99999) then
              nr_seq_grupo_prod_w := null;
            end if;

            if (nr_seq_grupo_prod_w IS NOT NULL AND nr_seq_grupo_prod_w::text <> '') then
              begin
              select  count(*)
              into STRICT  qt_reg_w
              from  grupo_prod_financ_perfil x
              where  x.nr_seq_grupo = nr_seq_grupo_prod_w;

              if (qt_reg_w = 0) then
                ie_gravar_w := 'S';
              else
                select  coalesce(max(x.ie_acesso),'N')
                into STRICT  ie_gravar_w
                from  grupo_prod_financ_perfil x
                where  x.nr_seq_grupo  = nr_seq_grupo_prod_w
                and  x.cd_perfil   = cd_perfil_ativo_p
                and  coalesce(x.ie_acesso,'S') = 'S';
              end if;
              end;
            else
              begin
              select  ie_acesso
              into STRICT  ie_gravar_w
              from  grupo_prod_financ_perfil
              where  cd_perfil  = cd_perfil_ativo_p
              and  coalesce(nr_seq_grupo::text, '') = ''  LIMIT 1;
              exception
              when no_data_found then
                ie_gravar_w := 'S';
              end;
            end if;
            end;
          end if;

          if (ie_gravar_w = 'S') then
            begin
            nr_sequencia_w := nr_sequencia_w + 1;

            insert into w_ficha_financ_consulta(
              nr_sequencia,
              dt_atualizacao,
              nm_usuario,
              nr_seq_cobranca,
              cd_cgc,
              cd_pessoa_fisica)
            values (  nr_sequencia_w,
              clock_timestamp(),
              nm_usuario_p,
              nr_seq_cobranca_w,
              cd_cgc_p,
              cd_pessoa_fisica_p);
            end;
          end if;
          end;
        end loop;
        close c06;
      elsif (nr_seq_item_w = 10) then  /*conta paciente*/
        open c07;
        loop
        fetch c07 into
          nr_interno_conta_w;
        EXIT WHEN NOT FOUND; /* apply on c07 */
          begin
          ie_gravar_w  := 'S';

          if (cd_pessoa_fisica_w IS NOT NULL AND cd_pessoa_fisica_w::text <> '') and (ie_registro_conv_p = 'N') then
            begin
            select  max(cd_convenio_parametro)
            into STRICT  cd_convenio_w
            from  conta_paciente
            where  nr_interno_conta = nr_interno_conta_w;

            select  max(ie_tipo_convenio)
            into STRICT  ie_tipo_convenio_w
            from  convenio
            where  cd_convenio = cd_convenio_w;

            if (ie_tipo_convenio_w = '2') then
              ie_gravar_w  := 'N';
            end if;
            end;
          end if;

          if (ie_gravar_w = 'S') then
            begin
            nr_sequencia_w := nr_sequencia_w + 1;

            insert into w_ficha_financ_consulta(
              nr_sequencia,
              dt_atualizacao,
              nm_usuario,
              nr_interno_conta,
              cd_cgc,
              cd_pessoa_fisica)
            values (  nr_sequencia_w,
              clock_timestamp(),
              nm_usuario_p,
              nr_interno_conta_w,
              cd_cgc_p,
              cd_pessoa_fisica_p);
            end;
          end if;
          end;
        end loop;
        close c07;
      elsif (nr_seq_item_w = 17) then  /*recebimento em cartão*/
        open c08;
        loop
        fetch c08 into
          nr_seq_movto_cartao_cr_w;
        EXIT WHEN NOT FOUND; /* apply on c08 */
          begin
          ie_gravar_w  := 'S';

          if (ie_somente_aberto_w = 'S') then
            begin
            ie_gravar_w  := 'N';
            vl_saldo_w   := obter_saldo_cartao_cr(nr_seq_movto_cartao_cr_w,dt_referencia_w);

            if (vl_saldo_w > 0) then
              ie_gravar_w := 'S';
            end if;
            end;
          end if;

          if (ie_gravar_w = 'S') and (ie_prod_perfil_w = 'S') then
            begin
            nr_seq_grupo_prod_w   := OBTER_PROD_FINANC(nr_seq_movto_cartao_cr_w, 'AC', 'G');

            if (nr_seq_grupo_prod_w = 99999) then
              nr_seq_grupo_prod_w := null;
            end if;

            if (nr_seq_grupo_prod_w IS NOT NULL AND nr_seq_grupo_prod_w::text <> '') then
              begin
              select  count(*)
              into STRICT  qt_reg_w
              from  grupo_prod_financ_perfil x
              where  x.nr_seq_grupo = nr_seq_grupo_prod_w;

              if (qt_reg_w = 0) then
                ie_gravar_w := 'S';
              else
                select  coalesce(max(x.ie_acesso),'N')
                into STRICT  ie_gravar_w
                from  grupo_prod_financ_perfil x
                where  x.nr_seq_grupo  = nr_seq_grupo_prod_w
                and  x.cd_perfil   = cd_perfil_ativo_p
                and  coalesce(x.ie_acesso,'S') = 'S';
              end if;
              end;
            else
              begin
              select  ie_acesso
              into STRICT  ie_gravar_w
              from  grupo_prod_financ_perfil
              where  cd_perfil  = cd_perfil_ativo_p
              and  coalesce(nr_seq_grupo::text, '') = ''  LIMIT 1;
              exception
              when no_data_found then
                ie_gravar_w := 'S';
              end;
            end if;
            end;
          end if;

          if (ie_gravar_w = 'S') then
            begin
            nr_sequencia_w := nr_sequencia_w + 1;

            insert into w_ficha_financ_consulta(
              nr_sequencia,
              dt_atualizacao,
              nm_usuario,
              nr_seq_movto_cartao_cr,
              cd_cgc,
              cd_pessoa_fisica)
            values (  nr_sequencia_w,
              clock_timestamp(),
              nm_usuario_p,
              nr_seq_movto_cartao_cr_w,
              cd_cgc_p,
              cd_pessoa_fisica_p);
            end;
          end if;
          end;
        end loop;
        close c08;
      elsif (nr_seq_item_w = 18) then  /*protocolo convênio*/
        open c09;
        loop
        fetch c09 into
          nr_seq_protocolo_w;
        EXIT WHEN NOT FOUND; /* apply on c09 */
          begin
          nr_sequencia_w := nr_sequencia_w + 1;

          insert into w_ficha_financ_consulta(
            nr_sequencia,
            dt_atualizacao,
            nm_usuario,
            nr_seq_protocolo,
            cd_cgc,
            cd_pessoa_fisica)
          values (  nr_sequencia_w,
            clock_timestamp(),
            nm_usuario_p,
            nr_seq_protocolo_w,
            cd_cgc_p,
            cd_pessoa_fisica_p);
          end;
        end loop;
        close c09;
      elsif (nr_seq_item_w = 19) then  /*ops - mensalidades*/
        open c010;
        loop
        fetch c010 into
          nr_seq_pls_mensalidade_w;
        EXIT WHEN NOT FOUND; /* apply on c010 */
          begin
          nr_sequencia_w := nr_sequencia_w + 1;

          insert into w_ficha_financ_consulta(
            nr_sequencia,
            dt_atualizacao,
            nm_usuario,
            nr_seq_pls_mensalidade,
            cd_cgc,
            cd_pessoa_fisica)
          values (  nr_sequencia_w,
            clock_timestamp(),
            nm_usuario_p,
            nr_seq_pls_mensalidade_w,
            cd_cgc_p,
            cd_pessoa_fisica_p);
          end;
        end loop;
        close c010;
      elsif (nr_seq_item_w = 21) then  /*negociação de cr*/
        open c011;
        loop
        fetch c011 into
          nr_seq_negociacao_cr_w;
        EXIT WHEN NOT FOUND; /* apply on c011 */
          begin
          nr_sequencia_w := nr_sequencia_w + 1;

          insert into w_ficha_financ_consulta(
            nr_sequencia,
            dt_atualizacao,
            nm_usuario,
            nr_seq_negociacao_cr,
            cd_cgc,
            cd_pessoa_fisica)
          values (  nr_sequencia_w,
            clock_timestamp(),
            nm_usuario_p,
            nr_seq_negociacao_cr_w,
            cd_cgc_p,
            cd_pessoa_fisica_p);
          end;
        end loop;
        close c011;
      elsif (nr_seq_item_w = 12) then  /*títulos a pagar*/
        open c012;
        loop
        fetch c012 into
          nr_titulo_cp_w;
        EXIT WHEN NOT FOUND; /* apply on c012 */
          begin
          ie_gravar_w  := 'S';

          if (ie_somente_aberto_w = 'S') then
            begin
            ie_gravar_w  := 'N';
            vl_saldo_w   := obter_saldo_titulo_pagar(nr_titulo_cp_w, dt_referencia_w);

            if (vl_saldo_w > 0) then
              ie_gravar_w := 'S';
            end if;
            end;
          end if;

          if (ie_gravar_w = 'S') and (ie_prod_perfil_w = 'S') then
            begin
            nr_seq_grupo_prod_w   := OBTER_PROD_FINANC(nr_titulo_cp_w, 'TP', 'G');

            if (nr_seq_grupo_prod_w = 99999) then
              nr_seq_grupo_prod_w := null;
            end if;

            if (nr_seq_grupo_prod_w IS NOT NULL AND nr_seq_grupo_prod_w::text <> '') then
              begin
              select  count(*)
              into STRICT  qt_reg_w
              from  grupo_prod_financ_perfil x
              where  x.nr_seq_grupo = nr_seq_grupo_prod_w;

              if (qt_reg_w = 0) then
                ie_gravar_w := 'S';
              else
                select  coalesce(max(x.ie_acesso),'N')
                into STRICT  ie_gravar_w
                from  grupo_prod_financ_perfil x
                where  x.nr_seq_grupo  = nr_seq_grupo_prod_w
                and  x.cd_perfil   = cd_perfil_ativo_p
                and  coalesce(x.ie_acesso,'S') = 'S';
              end if;
              end;
            else
              begin
              select  ie_acesso
              into STRICT  ie_gravar_w
              from  grupo_prod_financ_perfil
              where  cd_perfil  = cd_perfil_ativo_p
              and  coalesce(nr_seq_grupo::text, '') = ''  LIMIT 1;
              exception
              when no_data_found then
                ie_gravar_w := 'S';
              end;
            end if;
            end;
          end if;

          if (ie_gravar_w = 'S') then
            begin
            nr_sequencia_w := nr_sequencia_w + 1;

            insert into w_ficha_financ_consulta(
              nr_sequencia,
              dt_atualizacao,
              nm_usuario,
              nr_titulo_cp,
              cd_cgc,
              cd_pessoa_fisica)
            values (  nr_sequencia_w,
              clock_timestamp(),
              nm_usuario_p,
              nr_titulo_cp_w,
              cd_cgc_p,
              cd_pessoa_fisica_p);
            end;
          end if;
          end;
        end loop;
        close c012;
      elsif (nr_seq_item_w = 13) then  /*adiantamento pago*/
        open c013;
        loop
        fetch c013 into
          nr_adiantamento_cp_w;
        EXIT WHEN NOT FOUND; /* apply on c013 */
          begin
          ie_gravar_w  := 'S';

          if (ie_somente_aberto_w = 'S') then
            begin
            ie_gravar_w  := 'N';
            vl_saldo_w   := obter_saldo_adiant_pago(nr_adiantamento_cp_w, dt_referencia_w);

            if (vl_saldo_w > 0) then
              ie_gravar_w := 'S';
            end if;
            end;
          end if;

          if (ie_gravar_w = 'S') then
            begin
            nr_sequencia_w := nr_sequencia_w + 1;

            insert into w_ficha_financ_consulta(
              nr_sequencia,
              dt_atualizacao,
              nm_usuario,
              nr_adiantamento_cp,
              cd_cgc,
              cd_pessoa_fisica)
            values (  nr_sequencia_w,
              clock_timestamp(),
              nm_usuario_p,
              nr_adiantamento_cp_w,
              cd_cgc_p,
              cd_pessoa_fisica_p);
            end;
          end if;
          end;
        end loop;
        close c013;
      elsif (nr_seq_item_w = 14) then  /*repasse*/
        open c014;
        loop
        fetch c014 into
          nr_repasse_terceiro_w;
        EXIT WHEN NOT FOUND; /* apply on c014 */
          begin
          nr_sequencia_w := nr_sequencia_w + 1;

          insert into w_ficha_financ_consulta(
            nr_sequencia,
            dt_atualizacao,
            nm_usuario,
            nr_repasse_terceiro,
            cd_cgc,
            cd_pessoa_fisica)
          values (  nr_sequencia_w,
            clock_timestamp(),
            nm_usuario_p,
            nr_repasse_terceiro_w,
            cd_cgc_p,
            cd_pessoa_fisica_p);
          end;
        end loop;
        close c014;
      elsif (nr_seq_item_w = 22) then  /*nota de crédito*/
        open c015;
        loop
        fetch c015 into
          nr_seq_nota_credito_w;
        EXIT WHEN NOT FOUND; /* apply on c015 */
          begin
          nr_sequencia_w := nr_sequencia_w + 1;

          insert into w_ficha_financ_consulta(
            nr_sequencia,
            dt_atualizacao,
            nm_usuario,
            nr_seq_nota_credito,
            cd_cgc,
            cd_pessoa_fisica)
          values (  nr_sequencia_w,
            clock_timestamp(),
            nm_usuario_p,
            nr_seq_nota_credito_w,
            cd_cgc_p,
            cd_pessoa_fisica_p);
          end;
        end loop;
        close c015;
      elsif (nr_seq_item_w = 24) then
        open c016;
        loop
        fetch c016 into
          nr_seq_perda_w;
        EXIT WHEN NOT FOUND; /* apply on c016 */
          begin
          nr_sequencia_w := nr_sequencia_w + 1;

          insert into w_ficha_financ_consulta(
            nr_sequencia,
            dt_atualizacao,
            nm_usuario,
            nr_seq_perda,
            cd_cgc,
            cd_pessoa_fisica)
          values (  nr_sequencia_w,
            clock_timestamp(),
            nm_usuario_p,
            nr_seq_perda_w,
            cd_cgc_p,
            cd_pessoa_fisica_p);
          end;
        end loop;
        close c016;
      elsif (nr_seq_item_w = 26) then /* SPA */
        open c017;
        loop
        fetch c017 into
          nr_seq_spa_w;
        EXIT WHEN NOT FOUND; /* apply on c017 */
          begin
          if (cd_pessoa_fisica_w IS NOT NULL AND cd_pessoa_fisica_w::text <> '') then
            select  count(*)
            into STRICT  qt_reg_w
            from  w_ficha_financ_consulta
            where  cd_pessoa_fisica = cd_pessoa_fisica_w
            and  nm_usuario = nm_usuario_p
            and  nr_seq_spa = nr_seq_spa_w;
          else
            select  count(*)
            into STRICT  qt_reg_w
            from  w_ficha_financ_consulta
            where  cd_cgc = cd_cgc_w
            and  nm_usuario = nm_usuario_p
            and  nr_seq_spa = nr_seq_spa_w;
          end if;

          if (qt_reg_w = 0) then
            begin
            nr_sequencia_w := nr_sequencia_w + 1;

            insert into w_ficha_financ_consulta(
              nr_sequencia,
              dt_atualizacao,
              nm_usuario,
              nr_seq_spa,
              cd_cgc,
              cd_pessoa_fisica)
            values (  nr_sequencia_w,
              clock_timestamp(),
              nm_usuario_p,
              nr_seq_spa_w,
              cd_cgc_p,
              cd_pessoa_fisica_p);
            end;
          end if;
          end;
        end loop;
        close c017;
      end if;
      end;
    end loop;
    close C00;
    end;
  end loop;
  close c02;
  end;
end loop;
close c01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_ficha_financ_consulta ( cd_pessoa_fisica_p text, cd_cgc_p text, cd_perfil_ativo_p bigint, ie_somente_aberto_p text, dt_referencia_p timestamp, cd_estab_p bigint  , cd_estabelecimento_p bigint  , ds_lista_estab_p text, ie_resp_titulo_cre_p text, ie_registro_conv_p text, ie_informacao_pj_p text, nr_seq_capa_p bigint, dt_ini_capa_p timestamp, dt_fim_capa_p timestamp, nm_usuario_p text, ds_lista_convenio_p text, ds_lista_grupo_p text, ds_lista_sub_grupo_p text, ds_lista_produto_p text, ie_pessoa_cobranca_p text default 'D') FROM PUBLIC;

