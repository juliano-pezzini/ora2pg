-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE obter_medico_executor_regra ( nr_atendimento_p bigint, cd_estabelecimento_p bigint, cd_convenio_p bigint, cd_setor_atendimento_p bigint, cd_procedimento_p bigint, ie_origem_proced_p bigint, nr_seq_exame_p bigint, cd_medico_exec_filtro_p text, nr_prescricao_p bigint, nr_sequencia_prescricao_p bigint, cd_medico_executor_p INOUT text) AS $body$
DECLARE

 
cd_convenio_w		integer;
ie_tipo_atendimento_w	smallint;
ie_medico_executor_w	varchar(1);
cd_medico_executor_w	varchar(10);
cd_medico_executor_ww	varchar(10);
cd_cgc_w		varchar(14);
cd_pessoa_fisica_w	varchar(10);
nr_seq_classificacao_w	bigint;
ie_origem_inf_w		varchar(1);
cd_cgc_laboratorio_w	varchar(14);
cd_setor_prescricao_w	integer;


BEGIN 
select	coalesce(cd_convenio_p,obter_convenio_atendimento(a.nr_atendimento)), 
	a.ie_tipo_atendimento, 
	a.cd_medico_resp, 
	nr_seq_classificacao 
into STRICT	cd_convenio_w, 
	ie_tipo_atendimento_w, 
	cd_medico_executor_w, 
	nr_seq_classificacao_w 
from	atendimento_paciente a 
where	a.nr_atendimento = nr_atendimento_p;
 
if (coalesce(nr_prescricao_p,0) > 0) then 
 
	select	max(cd_setor_atendimento) 
	into STRICT	cd_setor_prescricao_w 
	from	prescr_medica 
	where	nr_prescricao = nr_prescricao_p;
 
	if (coalesce(nr_sequencia_prescricao_p,0) > 0) then 
		select	max(ie_origem_inf), 
			max(cd_cgc_laboratorio) 
		into STRICT	ie_origem_inf_w, 
			cd_cgc_laboratorio_w 
		from	prescr_procedimento 
		where	nr_prescricao = nr_prescricao_p 
		and	nr_sequencia = nr_sequencia_prescricao_p;
	end if;
	 
end if;
 
SELECT * FROM consiste_medico_executor(	 
				cd_estabelecimento_p, cd_convenio_w, cd_setor_atendimento_p, cd_procedimento_p, ie_origem_proced_p, ie_tipo_atendimento_w, nr_seq_exame_p, null, ie_medico_executor_w, cd_cgc_w, cd_medico_executor_ww, cd_pessoa_fisica_w, cd_medico_exec_filtro_p, clock_timestamp(), nr_seq_classificacao_w, ie_origem_inf_w, cd_cgc_laboratorio_w, cd_setor_prescricao_w) INTO STRICT ie_medico_executor_w, cd_cgc_w, cd_medico_executor_ww, cd_pessoa_fisica_w;
 
if (ie_medico_executor_w 	= 'N') then 
	cd_medico_executor_w	:= null;
elsif (ie_medico_executor_w 	= 'F') then 
	cd_medico_executor_w	:= cd_medico_executor_ww;
elsif (ie_medico_executor_w	= 'P') and (coalesce(nr_sequencia_prescricao_p,0) > 0) then 
	 
	select	max(coalesce(a.cd_medico_exec,b.cd_medico)) 
	into STRICT	cd_medico_executor_w 
	from	prescr_procedimento a, 
		prescr_medica b 
	where	a.nr_prescricao		= b.nr_prescricao 
	and	b.nr_prescricao		= nr_prescricao_p 
	and	a.nr_sequencia		= nr_sequencia_prescricao_p;
	 
end if;
 
cd_medico_executor_p		:= cd_medico_executor_w;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE obter_medico_executor_regra ( nr_atendimento_p bigint, cd_estabelecimento_p bigint, cd_convenio_p bigint, cd_setor_atendimento_p bigint, cd_procedimento_p bigint, ie_origem_proced_p bigint, nr_seq_exame_p bigint, cd_medico_exec_filtro_p text, nr_prescricao_p bigint, nr_sequencia_prescricao_p bigint, cd_medico_executor_p INOUT text) FROM PUBLIC;

