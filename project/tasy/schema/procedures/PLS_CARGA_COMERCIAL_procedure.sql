-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_carga_comercial ( cd_registro_p text, nm_pessoa_p text, ds_endereco_p text, cd_cep_p text, ds_municipio_p text, nr_telefone_p text, nr_fax_p text, ds_email_p text, nm_contato_p text, nm_usuario_p text, ds_lista_data_hist_p text, ds_lista_data_agenda_p text, ds_lista_obs_p text, ds_lista_hora_p text, ds_lista_valor_p text, ds_lista_contato_p text) AS $body$
DECLARE


nr_seq_carga_w			bigint;

ds_lista_data_hist_w		varchar(4000);
ds_lista_obs_w			varchar(4000);
ds_lista_data_agenda_w		varchar(4000);

dt_hist_w			varchar(20);
ds_historico_w			varchar(2000);
dt_agenda_w			varchar(20);


BEGIN

ds_lista_data_hist_w	:= ds_lista_data_hist_p;
ds_lista_obs_w		:= ds_lista_obs_p;
ds_lista_data_agenda_w	:= ds_lista_data_agenda_p;

select	nextval('w_pls_carga_comercial_seq')
into STRICT	nr_seq_carga_w
;

insert into w_pls_carga_comercial(	nr_sequencia, cd_registro, nm_pessoa, ds_endereco, cd_cep,
					ds_municipio, nr_telefone, nr_fax, ds_email, dt_atualizacao,
					nm_usuario, dt_atualizacao_nrec, nm_usuario_nrec)
			values (	nr_seq_carga_w, cd_registro_p, nm_pessoa_p, ds_endereco_p, cd_cep_p,
					ds_municipio_p, nr_telefone_p, nr_fax_p, ds_email_p, clock_timestamp(),
					nm_usuario_p, clock_timestamp(), nm_usuario_p);

while(ds_lista_data_hist_w IS NOT NULL AND ds_lista_data_hist_w::text <> '') loop
	begin
	/* Buscar a data do histórico na lista */

	select	substr(ds_lista_data_hist_w,1,position('#@' in ds_lista_data_hist_w)-1)
	into STRICT	dt_hist_w
	;
	/* Buscar o histórico na lista */

	select	substr(ds_lista_obs_w,1,position('#@' in ds_lista_obs_w)-1)
	into STRICT	ds_historico_w
	;
	/* Buscar a data da agenda na lista */

	select	substr(ds_lista_data_agenda_w,1,position('#@' in ds_lista_data_agenda_w)-1)
	into STRICT	dt_agenda_w
	;

	/* Retira a data buscada da lista */

	select	substr(ds_lista_data_hist_w,position('#@' in ds_lista_data_hist_w) +2,length(ds_lista_data_hist_w))
	into STRICT	ds_lista_data_hist_w
	;
	/* Retira o histórico buscado da lista */

	select	substr(ds_lista_obs_w,position('#@' in ds_lista_obs_w) +2,length(ds_lista_obs_w))
	into STRICT	ds_lista_obs_w
	;
	/* Retira a data da agenda buscada da lista */

	select	substr(ds_lista_data_agenda_w,position('#@' in ds_lista_data_agenda_w) +2,length(ds_lista_data_agenda_w))
	into STRICT	ds_lista_data_agenda_w
	;

	if (coalesce(dt_hist_w,'0') <> '0') then
		insert into w_pls_carga_comercial_hist(	nr_sequencia, nr_seq_comercial, dt_atualizacao, nm_usuario,
								dt_atualizacao_nrec, nm_usuario_nrec, dt_historico, ds_historico,
								dt_agenda)
						values (	nextval('w_pls_carga_comercial_hist_seq'), nr_seq_carga_w, clock_timestamp(), nm_usuario_p,
								clock_timestamp(), nm_usuario_p, to_date(dt_hist_w), ds_historico_w,
								dt_agenda_w);
	end if;

	end;
end loop;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_carga_comercial ( cd_registro_p text, nm_pessoa_p text, ds_endereco_p text, cd_cep_p text, ds_municipio_p text, nr_telefone_p text, nr_fax_p text, ds_email_p text, nm_contato_p text, nm_usuario_p text, ds_lista_data_hist_p text, ds_lista_data_agenda_p text, ds_lista_obs_p text, ds_lista_hora_p text, ds_lista_valor_p text, ds_lista_contato_p text) FROM PUBLIC;

