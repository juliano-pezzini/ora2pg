-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE qt_gerar_item_recorrencia ( nr_seq_agenda_int_p bigint, nm_usuario_p text, ie_diario_p text, ie_semanal_p text, ds_dias_p text, dt_inicio_recorrencia_p timestamp, dt_fim_recorrencia_p timestamp, nr_seq_grupo_quimio_p bigint, nr_minuto_duracao_p bigint, ie_tipo_pend_agenda_p text, qt_intervalo_p bigint, ie_final_semana_p text, ie_gerar_feriado_p text) AS $body$
DECLARE


nr_seq_item_w			bigint;
ds_dias_w			varchar(255);
dt_dia_semana_w			smallint;
qt_dia_w			smallint;
ie_gerar_dia_w			varchar(1);
ie_fim_sab_chec_w		varchar(1);
ie_fim_dom_chec_w		varchar(1);
dt_atual_w			timestamp;
cd_dia_semana_w			varchar(1);
--dt_agenda_w			date;
dt_inicial_w			timestamp;
dt_final_w			timestamp;
ie_primeiro_item_quimio_w	varchar(1);
nr_seq_item_princ_w		bigint;
ie_feriado_w			smallint;


BEGIN
ds_dias_w 	:= '';
dt_inicial_w	:= dt_inicio_recorrencia_p;
dt_final_w	:= dt_fim_recorrencia_p;
dt_Atual_w	:= dt_inicial_w;

if (nr_seq_agenda_int_p IS NOT NULL AND nr_seq_agenda_int_p::text <> '') then
	ie_primeiro_item_quimio_w := 'S';

	if (ie_diario_p  = 'S') or (ie_final_semana_p	= 'S') then
		qt_dia_w	:= 1;
	elsif (ie_diario_p = 'N') and (qt_intervalo_p > 0) then
		qt_dia_w:= qt_intervalo_p;
	elsif (ie_semanal_p = 'S') then
		qt_dia_w	:= 7;
	end if;

	while(dt_atual_w <= dt_final_w) loop
		begin
		/* obter dias semana */

		select	obter_cod_dia_semana(dt_Atual_w)
		into STRICT	dt_dia_semana_w
		;

		/*obter feriados no período */

		ie_feriado_w	:= obter_se_feriado(wheb_usuario_pck.get_cd_estabelecimento, dt_Atual_w);


		ie_gerar_dia_w	:= 'S';

		if (ds_dias_p IS NOT NULL AND ds_dias_p::text <> '') then
			select	substr(ds_dias_p,1,length(ds_dias_p) -2)
			into STRICT	ds_dias_w
			;

			ie_gerar_dia_w	:=  obter_se_contido(dt_dia_semana_w,ds_dias_w);
		end if;

		select	obter_se_contido(7,ds_dias_w)
		into STRICT	ie_fim_sab_chec_w
		;

		select	obter_se_contido(1,ds_dias_w)
		into STRICT	ie_fim_dom_chec_w
		;

		if (coalesce(ds_dias_p::text, '') = '') then
			/* Tratar se a recorrência será nos finais de semana */

			if (dt_dia_semana_w = 1) and (ie_final_semana_p = 'N') then
				ie_Gerar_dia_w	:= 'N';
			elsif (dt_dia_semana_w = 7) and (ie_final_semana_p = 'N') then
				ie_Gerar_dia_w	:= 'N';
			elsif (dt_dia_Semana_W not in (1,7)) and (ie_final_semana_p	= 'S') and (ie_diario_p	= 'N') then
				ie_Gerar_dia_w	:= 'N';
			end if;

			/* Tratar se a recorrência será gerada nos feriados */

			if (ie_gerar_feriado_p	= 'N') and (ie_Gerar_dia_w		= 'S') then
				if (coalesce(ie_feriado_w, 0)	= 0) then
					ie_gerar_dia_w	:= 'S';
				else
					ie_gerar_dia_w	:= 'N';
				end if;

			end if;

		end if;

		if (ie_gerar_dia_w = 'S') then

			select	nextval('agenda_integrada_item_seq')
			into STRICT	nr_seq_item_w
			;

			insert into agenda_integrada_item(
				nr_sequencia,
				nr_seq_agenda_int,
				dt_atualizacao,
				nm_usuario,
				nr_seq_grupo_quimio,
				ie_tipo_pend_agenda,
				dt_prevista_quimio,
				nr_minuto_duracao,
				ie_tipo_agendamento,
				ie_tipo_item,
				nr_seq_item_princ
				)
			values (
				nr_seq_item_w,
				nr_seq_agenda_int_p,
				clock_timestamp(),
				nm_usuario_p,
				nr_seq_grupo_quimio_p,
				ie_tipo_pend_agenda_p,
				dt_atual_w,
				nr_minuto_duracao_p,
				'Q',
				CASE WHEN ie_primeiro_item_quimio_w='S' THEN 'P'  ELSE 'S' END ,/* SE FOR PRIMEIRO ITEM := P, SE SECUNDÁRIO := S*/
				nr_seq_item_princ_w
				);

		if (ie_primeiro_item_quimio_w	= 'S') then /* CONSISTE OS ITENS SECUNDÁRIOS QUE SERÃO VINCULADOS À SEQUÊNCIA DO PRIMEIRO ITEM LANÇADO*/
			nr_seq_item_princ_w	:= nr_seq_item_w;
		end if;
		ie_primeiro_item_quimio_w	:= 'N';
		end if;

		dt_atual_w  	:= dt_atual_w + qt_dia_w;
		dt_inicial_w := dt_inicial_w + 1;

		end;
	end loop;


end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE qt_gerar_item_recorrencia ( nr_seq_agenda_int_p bigint, nm_usuario_p text, ie_diario_p text, ie_semanal_p text, ds_dias_p text, dt_inicio_recorrencia_p timestamp, dt_fim_recorrencia_p timestamp, nr_seq_grupo_quimio_p bigint, nr_minuto_duracao_p bigint, ie_tipo_pend_agenda_p text, qt_intervalo_p bigint, ie_final_semana_p text, ie_gerar_feriado_p text) FROM PUBLIC;

