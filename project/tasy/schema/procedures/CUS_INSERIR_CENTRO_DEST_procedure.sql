-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE cus_inserir_centro_dest ( cd_estabelecimento_p bigint, cd_seq_criterio_dest_p bigint, cd_centro_controle_p bigint, cd_natureza_gasto_p bigint, nr_seq_ng_p bigint, qt_distribuicao_p bigint, pr_distribuicao_p bigint, qt_peso_p bigint, nm_usuario_p text) AS $body$
DECLARE


nr_seq_ng_dest_w			bigint;
ie_situacao_w			varchar(1);
cd_estab_logado_w		estabelecimento.cd_estabelecimento%type := wheb_usuario_pck.get_cd_estabelecimento;


BEGIN

nr_seq_ng_dest_w	:= nr_seq_ng_p;

if (coalesce(nr_seq_ng_dest_w,0) = 0) then
	select	max(nr_sequencia)
	into STRICT	nr_seq_ng_dest_w
	from	natureza_gasto
	where	cd_natureza_gasto				= cd_natureza_gasto_p
	and	coalesce(cd_estabelecimento, cd_estab_logado_w)	= cd_estab_logado_w;
end if;

select 	coalesce(max(ie_situacao),'I')
into STRICT	ie_situacao_w
from	centro_controle
where	cd_centro_controle = cd_centro_controle_p;


if (ie_situacao_w = 'A') then

	insert into criterio_distr_orc_dest(
		cd_sequencia_criterio,
		cd_estabelecimento,
		cd_centro_controle_dest,
		qt_distribuicao,
		pr_distribuicao,
		cd_natureza_gasto_dest,
		dt_atualizacao,
		nm_usuario,
		qt_peso,
		nr_seq_ng_dest,
		dt_atualizacao_nrec,
		nm_usuario_nrec)
	values (	cd_seq_criterio_dest_p,
		cd_estabelecimento_p,
		cd_centro_controle_p,
		coalesce(qt_distribuicao_p,0),
		coalesce(pr_distribuicao_p,0),
		cd_natureza_gasto_p,
		clock_timestamp(),
		nm_usuario_p,
		coalesce(qt_peso_p,1),
		nr_seq_ng_dest_w,
		clock_timestamp(),
		nm_usuario_p);
	commit;
end if;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cus_inserir_centro_dest ( cd_estabelecimento_p bigint, cd_seq_criterio_dest_p bigint, cd_centro_controle_p bigint, cd_natureza_gasto_p bigint, nr_seq_ng_p bigint, qt_distribuicao_p bigint, pr_distribuicao_p bigint, qt_peso_p bigint, nm_usuario_p text) FROM PUBLIC;

