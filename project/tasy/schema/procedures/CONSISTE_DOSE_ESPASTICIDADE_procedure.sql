-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE consiste_dose_espasticidade ( cd_pessoa_fisica_p text, qt_dose_p bigint, qt_dose_prescr_p bigint, qt_pontos_p bigint, nr_seq_art_mov_musculo_p bigint, nr_seq_toxina_p bigint default null, ie_consistir_forma_p text default 'N', nr_seq_item_p bigint DEFAULT NULL, ds_mensagem_p INOUT text DEFAULT NULL, ds_questiona_p INOUT text  DEFAULT NULL) AS $body$
DECLARE


qt_dose_min_w		double precision;
qt_dose_max_w		double precision;
qt_peso_min_w		double precision;
qt_peso_max_w		double precision;
qt_total_dose_w		smallint;
qt_total_peso_w		smallint;
ds_mensagem_w		varchar(255) := '';
qt_idade_w			integer;
qt_peso_w			double precision;
qt_multiplo_w		double precision;
ie_forma_calculo_w	varchar(3);
ie_regra_w			varchar(1)   := 'N';
qt_dose_prescr_w 	double precision;

C01 CURSOR FOR
	SELECT	b.qt_multiplo,
		b.ie_forma_calculo,
		b.qt_dose_min,
		b.qt_dose_max,
		b.qt_pontos_min,
		b.qt_pontos_max
	from	artic_mov_musculo a,
		artic_mov_musculo_regra b
	where	a.nr_sequencia = b.nr_seq_art_mov_musculo
	and	a.nr_sequencia = nr_seq_art_mov_musculo_p
	and	qt_idade_w between b.qt_idade_min and b.qt_idade_max
	and 	qt_peso_w between coalesce(b.qt_peso_min,0) and coalesce(b.qt_peso_max,999)
	and	coalesce(b.nr_seq_toxina,nr_seq_toxina_p) = nr_seq_toxina_p
	order by coalesce(b.nr_seq_toxina,0);


BEGIN

select	max(obter_idade(dt_nascimento,clock_timestamp(),'A'))
into STRICT	qt_idade_w
from	pessoa_fisica
where	cd_pessoa_fisica = cd_pessoa_fisica_p;

select	coalesce(max(qt_peso),0)
into STRICT	qt_peso_w
from	atendimento_sinal_vital
where	nr_sequencia = (SELECT	coalesce(max(nr_sequencia),-1)
			from	atendimento_sinal_vital
			where	(qt_peso IS NOT NULL AND qt_peso::text <> '')
			and	cd_paciente	= cd_pessoa_fisica_p
			and	ie_situacao = 'A'
			and	coalesce(IE_RN,'N')	= 'N');

if (qt_peso_w > 0) then
	begin

	open C01;
	loop
	fetch C01 into
		qt_multiplo_w,
		ie_forma_calculo_w,
		qt_dose_min_w,
		qt_dose_max_w,
		qt_peso_min_w,
		qt_peso_max_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin

		if (qt_multiplo_w IS NOT NULL AND qt_multiplo_w::text <> '') and (mod(qt_dose_p,qt_multiplo_w) > 0) then
			ds_mensagem_p := Wheb_mensagem_pck.get_texto(306299, 'QT_MULTIPLO_W='||qt_multiplo_w)||chr(13); --'Dose referência deve ser m·ltiplo de ' || qt_multiplo_w ||'.';
		end if;

		if (qt_multiplo_w IS NOT NULL AND qt_multiplo_w::text <> '') and (mod(qt_dose_prescr_p,qt_multiplo_w) > 0) then
			ds_mensagem_p := Wheb_mensagem_pck.get_texto(306299, 'QT_MULTIPLO_W='||qt_multiplo_w)||chr(13); --'Dose referência deve ser m·ltiplo de ' || qt_multiplo_w ||'.';
		end if;

		if (upper(ie_forma_calculo_w) = 'KG') and (ie_consistir_forma_p = 'S')then

			qt_dose_min_w	:= round(qt_peso_w)* qt_dose_min_w;
			qt_dose_max_w	:= round(qt_peso_w)* qt_dose_max_w;

		end if;

		if	((qt_dose_p < qt_dose_min_w) or (qt_dose_p > qt_dose_max_w )) and (qt_dose_min_w > 0) and (qt_dose_max_w > 0) then
			begin
			ds_mensagem_p := Wheb_mensagem_pck.get_texto(306301, 'QT_DOSE_MIN_W='||qt_dose_min_w||';QT_DOSE_MAX_W='||qt_dose_max_w) || chr(13);
			end;
		end if;

		if	((coalesce(qt_dose_prescr_w,0) > 0 and ((qt_dose_prescr_w < qt_dose_min_w) or (qt_dose_prescr_w > qt_dose_max_w ))) or
			((qt_dose_prescr_p < qt_dose_min_w) or (qt_dose_prescr_p > qt_dose_max_w ))) and (qt_dose_min_w > 0) and (qt_dose_max_w > 0) then
			begin
				ds_questiona_p := Wheb_mensagem_pck.get_texto(333845, 'QT_DOSE_MIN_W='||qt_dose_min_w||';QT_DOSE_MAX_W='||qt_dose_max_w) || chr(13);
			end;
		end if;
		if	((qt_pontos_p < qt_peso_min_w) or (qt_pontos_p > qt_peso_max_w )) and (qt_peso_min_w > 0) and (qt_peso_max_w > 0) then
			begin
			ds_mensagem_p := ds_mensagem_p || Wheb_mensagem_pck.get_texto(306358, 'QT_PESO_MIN_W='||qt_peso_min_w||';QT_PESO_MAX_W='||qt_peso_max_w);
			end;
		end if;
		end;
		ie_regra_w := 'S';
	end loop;
	close C01;

	end;
end if;

If (ie_regra_w = 'N') then
	ds_mensagem_p := ds_mensagem_p || Wheb_mensagem_pck.get_texto(306361); -- 'Nao existe regra cadastrada nessa toxina para o paciente.';
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE consiste_dose_espasticidade ( cd_pessoa_fisica_p text, qt_dose_p bigint, qt_dose_prescr_p bigint, qt_pontos_p bigint, nr_seq_art_mov_musculo_p bigint, nr_seq_toxina_p bigint default null, ie_consistir_forma_p text default 'N', nr_seq_item_p bigint DEFAULT NULL, ds_mensagem_p INOUT text DEFAULT NULL, ds_questiona_p INOUT text  DEFAULT NULL) FROM PUBLIC;

