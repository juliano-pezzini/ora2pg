-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gravar_fluxo_caixa_docto (dt_referencia_p timestamp, cd_conta_financ_p bigint, cd_empresa_p bigint, cd_estabelecimento_p bigint, cd_estab_financ_p bigint, cd_moeda_p bigint, ds_observacao_p text, ie_classif_fluxo_p text, ie_integracao_p text, nm_usuario_p text, cd_agenda_p bigint, nr_interno_conta_p bigint, nr_ordem_compra_p bigint, nr_repasse_terceiro_p bigint, nr_seq_cheque_cp_p bigint, nr_seq_cheque_cr_p bigint, nr_seq_conta_banco_p bigint, nr_seq_caixa_p bigint, nr_seq_contrato_p bigint, nr_seq_conv_receb_p bigint, nr_seq_emprest_parc_p bigint, nr_seq_movto_cartao_p bigint, nr_seq_movto_parcela_p bigint, nr_seq_movto_trans_p bigint, nr_seq_proj_recurso_p bigint, nr_seq_protocolo_p bigint, nr_seq_regra_p bigint, nr_titulo_pagar_p bigint, nr_seq_tit_pag_baixa_p bigint, nr_titulo_receber_p bigint, nr_seq_tit_rec_baixa_p bigint, vl_fluxo_p bigint, vl_fluxo_estrang_p bigint default 0, vl_saldo_estrang_baixa_p bigint default 0, vl_cotacao_baixa_p bigint default 0, nr_seq_oc_vencimento_p bigint default null, nr_seq_tit_pag_adiant_p bigint default null) AS $body$
DECLARE


nr_seq_fluxo_docto_w	fluxo_caixa_docto.nr_sequencia%type;
ie_acumular_fluxo_w	regra_fluxo_caixa.ie_acumular_fluxo%type	:= 'S';
dt_referencia_w		timestamp;

/*--------------------------------------------------------------- ATENÇÃO ----------------------------------------------------------------*/


/* Cuidado ao realizar alterações no fluxo de caixa em lote. Toda e qualquer alteração realizada em qualquer uma */


/* das procedures do fluxo de caixa em lote deve ser cuidadosamente verificada e realizada no fluxo de caixa      */


/* convencional. Devemos garantir que os dois fluxos de caixa tragam os mesmos valores no resultado, evitando     */


/* assim que existam diferenças entre os fluxos de caixa.                                                                                                */


/*--------------- AO ALTERAR O FLUXO DE CAIXA EM LOTE ALTERAR TAMBÉM O FLUXO DE CAIXA ---------------*/

BEGIN

dt_referencia_w	:= pkg_date_utils.start_of(dt_referencia_p,'DD',0);

select	coalesce(max(nr_sequencia),0)
into STRICT	nr_seq_fluxo_docto_w
from	fluxo_caixa_docto
where	cd_conta_financ			= cd_conta_financ_p
and	dt_referencia			= dt_referencia_w
and	ie_integracao			= ie_integracao_p
and	ie_classif_fluxo		= ie_classif_fluxo_p
and	cd_empresa			= cd_empresa_p
and	cd_estabelecimento		= cd_estabelecimento_p
and	coalesce(cd_estab_financeiro,0)	= coalesce(cd_estab_financ_p,0)
and	coalesce(nr_interno_conta,0)		= coalesce(nr_interno_conta_p,0)
and	coalesce(nr_ordem_compra,0)		= coalesce(nr_ordem_compra_p,0)
and	coalesce(nr_repasse_terceiro,0)	= coalesce(nr_repasse_terceiro_p,0)
and	coalesce(cd_agenda,0)		= coalesce(cd_agenda_p,0)
and	coalesce(nr_seq_cheque_cp,0)		= coalesce(nr_seq_cheque_cp_p,0)
and	coalesce(nr_seq_cheque_cr,0)		= coalesce(nr_seq_cheque_cr_p,0)
and	coalesce(nr_seq_contrato,0)		= coalesce(nr_seq_contrato_p,0)
and	coalesce(nr_seq_conv_receb,0)	= coalesce(nr_seq_conv_receb_p,0)
and	coalesce(nr_seq_emprest_parc,0)	= coalesce(nr_seq_emprest_parc_p,0)
and	coalesce(nr_seq_movto_cartao,0)	= coalesce(nr_seq_movto_cartao_p,0)
and	coalesce(nr_seq_movto_parcela,0)	= coalesce(nr_seq_movto_parcela_p,0)
and	coalesce(nr_seq_movto_trans,0)	= coalesce(nr_seq_movto_trans_p,0)
and	coalesce(nr_seq_proj_recurso,0)	= coalesce(nr_seq_proj_recurso_p,0)
and	coalesce(nr_seq_protocolo,0)		= coalesce(nr_seq_protocolo_p,0)
and	coalesce(nr_seq_regra,0)		= coalesce(nr_seq_regra_p,0)
and	coalesce(nr_titulo_pagar,0)		= coalesce(nr_titulo_pagar_p,0)
and	coalesce(nr_seq_tit_pag_baixa,0)	= coalesce(nr_seq_tit_pag_baixa_p,0)
and	coalesce(nr_titulo_receber,0)	= coalesce(nr_titulo_receber_p,0)
and	coalesce(nr_seq_tit_rec_baixa,0)	= coalesce(nr_seq_tit_rec_baixa_p,0)
and	coalesce(cd_moeda,0) 		= coalesce(cd_moeda_p,0)
and	coalesce(nr_seq_tit_pag_adiant,0) 		= coalesce(nr_seq_tit_pag_adiant_p,0);

if (nr_seq_fluxo_docto_w = 0) then

	insert into fluxo_caixa_docto(
		nr_sequencia,
		dt_atualizacao,
		nm_usuario,
		dt_atualizacao_nrec,
		nm_usuario_nrec,
		cd_empresa,
		cd_estabelecimento,
		cd_estab_financeiro,
		cd_agenda,
		cd_conta_financ,
		cd_moeda,
		dt_referencia,
		ie_classif_fluxo,
		ie_integracao,
		nr_interno_conta,
		nr_ordem_compra,
		nr_repasse_terceiro,
		nr_seq_cheque_cp,
		nr_seq_cheque_cr,
		nr_seq_contrato,
		nr_seq_conv_receb,
		nr_seq_emprest_parc,
		nr_seq_movto_cartao,
		nr_seq_movto_parcela,
		nr_seq_movto_trans,
		nr_seq_proj_recurso,
		nr_seq_protocolo,
		nr_seq_regra,
		nr_seq_conta_banco,
		nr_seq_caixa,
		nr_titulo_pagar,
		nr_seq_tit_pag_baixa,
		nr_titulo_receber,
		nr_seq_tit_rec_baixa,
		vl_fluxo,
		VL_ESTRANGEIRO,
		ds_observacao,
		VL_SALDO_ESTRANGEIRO,
		vl_cotacao_baixa,
		nr_seq_oc_vencimento,
		NR_SEQ_TIT_PAG_ADIANT)
	values (nextval('fluxo_caixa_docto_seq'),
		clock_timestamp(),
		nm_usuario_p,
		clock_timestamp(),
		nm_usuario_p,
		cd_empresa_p,
		cd_estabelecimento_p,
		cd_estab_financ_p,
		cd_agenda_p,
		cd_conta_financ_p,
		cd_moeda_p,
		dt_referencia_w,
		ie_classif_fluxo_p,
		ie_integracao_p,
		nr_interno_conta_p,
		nr_ordem_compra_p,
		nr_repasse_terceiro_p,
		nr_seq_cheque_cp_p,
		nr_seq_cheque_cr_p,
		nr_seq_contrato_p,
		nr_seq_conv_receb_p,
		nr_seq_emprest_parc_p,
		nr_seq_movto_cartao_p,
		nr_seq_movto_parcela_p,
		nr_seq_movto_trans_p,
		nr_seq_proj_recurso_p,
		nr_seq_protocolo_p,
		nr_seq_regra_p,
		nr_seq_conta_banco_p,
		nr_seq_caixa_p,
		nr_titulo_pagar_p,
		nr_seq_tit_pag_baixa_p,
		nr_titulo_receber_p,
		nr_seq_tit_rec_baixa_p,
		vl_fluxo_p,
		vl_fluxo_estrang_p,
		ds_observacao_p,
		vl_saldo_estrang_baixa_p,
		vl_cotacao_baixa_p,
		nr_seq_oc_vencimento_p,
		nr_seq_tit_pag_adiant_p);
	
else
	update	fluxo_caixa_docto
	set	vl_fluxo	= coalesce(vl_fluxo,0) + coalesce(vl_fluxo_p,0)
	where	nr_sequencia	= nr_seq_fluxo_docto_w;
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gravar_fluxo_caixa_docto (dt_referencia_p timestamp, cd_conta_financ_p bigint, cd_empresa_p bigint, cd_estabelecimento_p bigint, cd_estab_financ_p bigint, cd_moeda_p bigint, ds_observacao_p text, ie_classif_fluxo_p text, ie_integracao_p text, nm_usuario_p text, cd_agenda_p bigint, nr_interno_conta_p bigint, nr_ordem_compra_p bigint, nr_repasse_terceiro_p bigint, nr_seq_cheque_cp_p bigint, nr_seq_cheque_cr_p bigint, nr_seq_conta_banco_p bigint, nr_seq_caixa_p bigint, nr_seq_contrato_p bigint, nr_seq_conv_receb_p bigint, nr_seq_emprest_parc_p bigint, nr_seq_movto_cartao_p bigint, nr_seq_movto_parcela_p bigint, nr_seq_movto_trans_p bigint, nr_seq_proj_recurso_p bigint, nr_seq_protocolo_p bigint, nr_seq_regra_p bigint, nr_titulo_pagar_p bigint, nr_seq_tit_pag_baixa_p bigint, nr_titulo_receber_p bigint, nr_seq_tit_rec_baixa_p bigint, vl_fluxo_p bigint, vl_fluxo_estrang_p bigint default 0, vl_saldo_estrang_baixa_p bigint default 0, vl_cotacao_baixa_p bigint default 0, nr_seq_oc_vencimento_p bigint default null, nr_seq_tit_pag_adiant_p bigint default null) FROM PUBLIC;

