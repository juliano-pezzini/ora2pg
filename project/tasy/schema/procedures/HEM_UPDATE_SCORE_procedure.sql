-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE hem_update_score ( nr_sequencia_p bigint, nm_usuario_p text) AS $body$
DECLARE


nr_seq_segmento_w	bigint;
pr_obstrucao_w		bigint;
ie_extensao_w		varchar(15);
ie_doenca_difusa_w	varchar(1);
nr_seq_reestenose_w	bigint;
ie_stent_w		varchar(1);
cd_tipo_bifurcacao_w	smallint;
ie_oclusao_cronica_w	varchar(1);
ie_duracao_w		varchar(1);
ie_coto_blunt_w		varchar(1);
ie_ponte_colateral_w	varchar(1);
nr_seg_contraste_w	bigint;
ie_ramo_lateral_w	bigint;
ie_bifurcacao_w		varchar(1);
ie_lesao_ostial_aorta_w	varchar(1);
ie_trombo_w		varchar(1);
ie_placa_excentrica_w	varchar(1);
ie_calcificacao_w	varchar(1);
ie_placa_ulcerada_w	varchar(1);
ie_tortuosidade_w	varchar(1);
ie_ponte_miocardica_w	varchar(1);
qt_fator_obstrucao_w	smallint;
qt_total_score_w	double precision;
nr_seq_proc_w		bigint;
nr_seq_vaso_cat_w	bigint;
cd_dominancia_w		real;
nr_seq_syntax_w		bigint;
ie_dominancia_w		varchar(1);
nr_seq_seg_w		bigint;
ie_segmento_doente_w	varchar(1);
ie_angulo_w		varchar(1);
ie_existe_seg_contras_w	varchar(1);

C01 CURSOR FOR
	SELECT	nr_seq_segmento,
		CASE WHEN ie_start='S' THEN 5  ELSE 2 END
	from	hem_syntax_segmento
	where	nr_seq_lesao = nr_sequencia_p;


BEGIN
if (coalesce(nr_sequencia_p,0) > 0) then

	select	max(nr_seq_segmento)
	into STRICT	nr_seq_segmento_w
	from	hem_syntax_segmento
	where	nr_seq_lesao = nr_sequencia_p
	and	ie_start = 'S';

	select	pr_obstrucao,
		ie_extensao,
		ie_doenca_difusa,
		cd_tipo_bifurcacao,
		ie_oclusao_cronica,
		'N',
		ie_coto_blunt,
		ie_ponte_colateral,
		nr_seg_constraste,
		ie_ramo_lateral,
		ie_bifurcacao,
		ie_lesao_ostial_aorta,
		'N',
		ie_calcificacao,
		ie_tortuosidade,
		nr_seq_syntax,
		ie_segmento_doente,
		ie_angulo,
		ie_duracao,
		ie_trombo
	into STRICT	pr_obstrucao_w,
		ie_extensao_w,
		ie_doenca_difusa_w,
		cd_tipo_bifurcacao_w,
		ie_oclusao_cronica_w,
		ie_duracao_w,
		ie_coto_blunt_w,
		ie_ponte_colateral_w,
		nr_seg_contraste_w,
		ie_ramo_lateral_w,
		ie_bifurcacao_w,
		ie_lesao_ostial_aorta_w,
		ie_trombo_w,
		ie_calcificacao_w,
		ie_tortuosidade_w,
		nr_seq_syntax_w,
		ie_segmento_doente_w,
		ie_angulo_w,
		ie_duracao_w,
		ie_trombo_w
	from	hem_syntax_lesao
	where	nr_sequencia = nr_sequencia_p;

	select	max(ie_dominancia)
	into STRICT	ie_dominancia_w
	from	hem_syntax
	where	nr_sequencia = nr_seq_syntax_w;

	select	substr(hem_obter_se_seg_contrastado( nr_sequencia_p),1,1)
	into STRICT	ie_existe_seg_contras_w
	;

	qt_total_score_w := 0;


	-- Diameter reduction
	/*if	(pr_obstrucao_w < 50) then
		qt_fator_obstrucao_w := 1;
	else
		if (pr_obstrucao_w < 100) then -- Significant lesion
			qt_fator_obstrucao_w := 2;
		else
			if (pr_obstrucao_w = 100) then -- Total occlusion
				qt_fator_obstrucao_w := 5;
			else
				qt_fator_obstrucao_w := 0;
			end if;
		end if;
	end if;*/
	open C01;
	loop
	fetch C01 into
		nr_seq_seg_w,
		qt_fator_obstrucao_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin
		select	CASE WHEN ie_dominancia_w='E' THEN vl_dominancia_esq WHEN ie_dominancia_w='D' THEN vl_dominancia_dir  ELSE 0 END
		into STRICT	cd_dominancia_w
		from	HEM_SEGMENTO_SYNTAX
		where	nr_sequencia = nr_seq_seg_w;

		qt_total_score_w := qt_total_score_w + (cd_dominancia_w * qt_fator_obstrucao_w);

		end;
	end loop;
	close C01;

	-- Age >3 months or unknown ( + 1)
	if (ie_duracao_w <> 'N') then
	   qt_total_score_w := qt_total_score_w + 1;
	end if;
	-- Blunt stump ( + 1)
	if (ie_coto_blunt_w = 'S') then
	   qt_total_score_w := qt_total_score_w + 1;
	end if;
	-- Bridging   ( + 1)
	if (ie_ponte_colateral_w = 'S') then
	   qt_total_score_w := qt_total_score_w + 1;
	end if;
	-- First segment visible beyond TO ( + 1/ per non-visible segment
	if ((ie_existe_seg_contras_w = 'S') and (coalesce(nr_seg_contraste_w::text, '') = '') and (ie_oclusao_cronica_w = 'S'))then
	   qt_total_score_w := qt_total_score_w + 1;
	end if;
	-- Side branch < 1.5mm ( + 1)  or    < & >= 1.5 ( + 1)
	if (ie_ramo_lateral_w in (2,3,4)) then
	   qt_total_score_w := qt_total_score_w + 1;
	end if;
	-- Trifurcations
	if (ie_bifurcacao_w = 'T') then
		begin
		if (ie_segmento_doente_w = '1') then
			qt_total_score_w := qt_total_score_w + 3;
		end if;
		if (ie_segmento_doente_w = '2') then
			qt_total_score_w := qt_total_score_w + 4;
		end if;
		if (ie_segmento_doente_w = '3') then
			qt_total_score_w := qt_total_score_w + 5;
		end if;
		if (ie_segmento_doente_w = '4') then
			qt_total_score_w := qt_total_score_w + 6;
		end if;
		end;
	end if;
	-- Bifurcations
	if (ie_bifurcacao_w = 'B') then
		begin
		if (cd_tipo_bifurcacao_w in (1,2,3)) then
			qt_total_score_w := qt_total_score_w + 1;
		end if;
		if (cd_tipo_bifurcacao_w in (4,5,6,7)) then
			qt_total_score_w := qt_total_score_w + 2;
		end if;
		if (ie_angulo_w = 'S') then
			qt_total_score_w := qt_total_score_w + 1;
		end if;
		end;
	end if;
	-- Aorto ostial stenosis
	if (ie_lesao_ostial_aorta_w = 'S') then
	   qt_total_score_w := qt_total_score_w + 1;
	end if;
	-- Severe tortuosity
	if (ie_tortuosidade_w = 'S') then
	   qt_total_score_w := qt_total_score_w + 2;
	end if;
	--Lenght > 20mm
	if (ie_extensao_w = 'S') then
	   qt_total_score_w := qt_total_score_w + 1;
	end if;
	--Heavy calcification
	if (ie_calcificacao_w = 'S') then
	   qt_total_score_w := qt_total_score_w + 2;
	end if;
	-- Thrombus
	if (ie_trombo_w = 'S') then
	   qt_total_score_w := qt_total_score_w + 1;
	end if;
	/*
	-- Diffuse disease 			tratado na procedure HEM_UPDATE_SCORE_GERAL
	if (ie_doenca_difusa_w = 'S') then
	   qt_total_score_w := qt_total_score_w + 1;
	end if;
	*/
	update	hem_syntax_lesao
	set	qt_score_syntax = qt_total_score_w
	where	nr_sequencia	= nr_sequencia_p;
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE hem_update_score ( nr_sequencia_p bigint, nm_usuario_p text) FROM PUBLIC;

