-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_relat_valores_coopus ( nr_seq_protocolo_p bigint, ie_tipo_p text) AS $body$
DECLARE

 
/* ie_tipo_p 
 S - sintético 
 A - analítico 
*/
 
 
ie_clinica_w		smallint;
cd_grupo_sus_w		varchar(8);
ie_tipo_servico_sus_w	smallint;
qt_ato_w		smallint;
vl_sadt_w		double precision;
vl_matmed_w		double precision;
vl_medico_w		double precision;
vl_anest_w		double precision;
qt_aih_w		bigint;
cd_procedimento_solic_w	bigint;
nr_aih_w		bigint;
dt_alta_w		timestamp;
qt_dia_acompanhante_w	smallint;
nr_seq_protocolo_w	bigint;
nm_pessoa_w		varchar(60);
qt_dia_uti_w		smallint;
vl_ssm_w		double precision 	:= 0;
vl_sp_w			double precision	:= 0;
vl_neuro_w		double precision	:= 0;
vl_transpl_w		double precision	:= 0;
vl_componente_w		double precision	:= 0;
vl_notif_w		double precision	:= 0;
vl_uti_esp_w		double precision	:= 0;
vl_opm_w		double precision	:= 0;
vl_sangue_w		double precision	:= 0;
vl_rn_w			double precision	:= 0;
vl_uti_w		double precision	:= 0;
vl_acomp_w		double precision	:= 0;
vl_nut_enteral_w	double precision	:= 0;
vl_regcivil_w		double precision	:= 0;
vl_hiv_w		double precision	:= 0;
vl_total_w		double precision	:= 0;
vl_analgesia_w		double precision	:= 0;
vl_sadt_ww		double precision	:= 0;
nr_seq_w		bigint 	:= 0;
ie_clinica_aux 		smallint;
cd_procedimento_solic_aux bigint;
nr_aih_aux		bigint;
dt_alta_aux		timestamp;
qt_dia_acompanhante_aux smallint;
qt_dia_uti_aux		smallint;
qt_ato_aux		smallint;
vl_sadt_aux		double precision;
vl_matmed_aux		double precision;
vl_medico_aux		double precision;
vl_anest_aux		double precision;
qt_aih_aux		bigint;
qt_pto_sp_w		integer	:= 0;
qt_pto_sadt_w		integer	:= 0;
vl_pto_sp_w		double precision;
vl_pto_sadt_w		double precision;
nr_faec_w		bigint;

 
c01 CURSOR FOR 
	/* consulta_q sintético */
 
	SELECT	t.ie_clinica, 
		a.nr_seq_faec, 
		coalesce(g.cd_grupo_sus,'0') cd_grupo_sus, 
		coalesce(c.ie_tipo_servico_sus,0) ie_tipo_servico_sus, 
		sum(coalesce(h.qt_ato_medico,0)) qt_ato, 
		sum(coalesce(h.vl_sadt,0)) vl_sadt, 
		sum(coalesce(h.vl_matmed,0)) vl_matmed, 
		sum(coalesce(h.vl_medico,0)) vl_medico, 
		sum(coalesce(h.vl_ato_anestesista,0)) vl_anest, 
		sum(0) qt_aih 
	FROM atendimento_paciente t, sus_valor_proc_paciente h, procedimento g, procedimento_paciente c, conta_paciente d
LEFT OUTER JOIN sus_aih a ON (d.nr_interno_conta = a.nr_interno_conta)
WHERE c.nr_interno_conta	= d.nr_interno_conta and c.nr_sequencia    	= h.nr_sequencia  and c.nr_atendimento	= t.nr_atendimento and c.cd_procedimento   	= g.cd_procedimento and c.ie_origem_proced  	= g.ie_origem_proced and coalesce(c.cd_motivo_exc_conta::text, '') = '' and d.nr_seq_protocolo   = nr_seq_protocolo_p and coalesce(d.ie_cancelamento::text, '') = '' group by	t.ie_clinica, 
			a.nr_seq_faec, 
			coalesce(g.cd_grupo_sus,0), 
			coalesce(c.ie_tipo_servico_sus,0) 
	
union
 
	SELECT	t.ie_clinica, 
		a.nr_seq_faec, 
		'999', 
		999, 
		sum(0), 
		sum(0), 
		sum(0), 
		sum(0), 
		sum(0), 
		count(distinct a.nr_aih) 
	FROM atendimento_paciente t, sus_valor_proc_paciente h, procedimento g, procedimento_paciente c, conta_paciente d
LEFT OUTER JOIN sus_aih a ON (d.nr_interno_conta = a.nr_interno_conta)
WHERE c.nr_interno_conta	= d.nr_interno_conta and c.nr_sequencia 		= h.nr_sequencia  and c.nr_atendimento	= t.nr_atendimento and c.cd_procedimento 	= g.cd_procedimento and c.ie_origem_proced 	= g.ie_origem_proced and coalesce(c.cd_motivo_exc_conta::text, '') = '' and d.nr_seq_protocolo 	= nr_seq_protocolo_p and coalesce(d.ie_cancelamento::text, '') = '' group by	t.ie_clinica, 
			a.nr_seq_faec, 
			'999', 
			999 
	order by	1,2,3;

 
c02 CURSOR FOR 
	/* consulta_q analítico */
 
	SELECT	x.ie_clinica, 
		a.nr_seq_faec, 
		a.cd_procedimento_solic, 
		a.nr_aih, 
		x.dt_alta, 
		a.qt_dia_acompanhante, 
		d.nr_seq_protocolo, 
		substr(obter_pessoa_atendimento(x.nr_atendimento,'N'),1,100) nm_pessoa, 
		sum(coalesce(a.qt_dia_uti_mes_ini,0) + coalesce(a.qt_dia_uti_mes_ant,0) + 		 
coalesce(a.qt_dia_uti_mes_alta,0)) qt_dia_uti, 
		sum(coalesce(h.qt_ato_medico,0)) qt_ato, 
		sum(coalesce(h.vl_sadt,0)) vl_sadt, 
		sum(coalesce(h.vl_matmed,0)) vl_matmed, 
		sum(coalesce(h.vl_medico,0)) vl_medico, 
		sum(coalesce(h.vl_ato_anestesista,0)) vl_anest, 
		sum(0) qt_aih 
	FROM atendimento_paciente x, sus_valor_proc_paciente h, procedimento g, procedimento_paciente c, conta_paciente d
LEFT OUTER JOIN sus_aih a ON (d.nr_interno_conta = a.nr_interno_conta)
LEFT OUTER JOIN valor_dominio f ON (a.ie_especialidade_aih = f.vl_dominio AND 805 = f.cd_dominio)
WHERE c.nr_interno_conta	= d.nr_interno_conta and c.nr_sequencia		= h.nr_sequencia  and c.nr_atendimento	= x.nr_atendimento and c.cd_procedimento	= g.cd_procedimento and c.ie_origem_proced	= g.ie_origem_proced   and coalesce(c.cd_motivo_exc_conta::text, '') = '' and d.nr_seq_protocolo   = nr_seq_protocolo_p and coalesce(d.ie_cancelamento::text, '') = '' group by	x.ie_clinica, 
			a.nr_seq_faec, 
		 	f.ds_valor_dominio, 
			a.cd_procedimento_solic, 
			a.nr_aih, 
			x.dt_alta, 
			a.qt_dia_acompanhante, 
			d.nr_seq_protocolo, 
			substr(obter_pessoa_atendimento(x.nr_atendimento,'N'),1,100) 
	order by	1,2,4;

c03 CURSOR FOR 
	/* consulta_aux_q */
 
	SELECT	x.ie_clinica, 
		a.nr_seq_faec, 
		coalesce(g.cd_grupo_sus,0) cd_grupo_sus, 
	 	a.cd_procedimento_solic, 
		a.nr_aih, 
		x.dt_alta, 
		coalesce(c.ie_tipo_servico_sus,0) ie_tipo_servico_sus, 
		a.qt_dia_acompanhante, 
		sum(coalesce(a.qt_dia_uti_mes_ini,0) + coalesce(a.qt_dia_uti_mes_ant,0) +	coalesce(a.qt_dia_uti_mes_alta,0)) 
qt_dia_uti, 
	 	sum(coalesce(h.qt_ato_medico,0)) qt_ato, 
	 	sum(coalesce(h.vl_sadt,0)) vl_sadt, 
		sum(coalesce(h.vl_matmed,0)) vl_matmed, 
		sum(coalesce(h.vl_medico,0)) vl_medico, 
		sum(coalesce(h.vl_ato_anestesista,0)) vl_anest, 
	 	sum(0) qt_aih 
	FROM atendimento_paciente x, sus_valor_proc_paciente h, procedimento g, procedimento_paciente c, conta_paciente d
LEFT OUTER JOIN sus_aih a ON (d.nr_interno_conta = a.nr_interno_conta)
LEFT OUTER JOIN valor_dominio f ON (a.ie_especialidade_aih = f.vl_dominio AND 805 = f.cd_dominio)
WHERE c.nr_interno_conta   = d.nr_interno_conta and c.nr_sequencia     = h.nr_sequencia  and c.nr_atendimento    = x.nr_atendimento and c.cd_procedimento    = g.cd_procedimento and c.ie_origem_proced   = g.ie_origem_proced   and coalesce(d.ie_cancelamento::text, '') = '' and coalesce(c.cd_motivo_exc_conta::text, '') = '' and d.nr_seq_protocolo   = nr_seq_protocolo_w and a.nr_aih        = nr_aih_w group by	x.ie_clinica, 
			a.nr_seq_faec, 
	 	 	f.ds_valor_dominio, 
		 	coalesce(g.cd_grupo_sus,0), 
		 	a.cd_procedimento_solic, 
		 	a.nr_aih, 
			x.dt_alta, 
			a.qt_dia_acompanhante, 
			coalesce(c.ie_tipo_servico_sus,0);

 

BEGIN 
 
delete from w_gerar_valores_sus;
commit;
 
if (ie_tipo_p = 'S') then 
	begin 
	open c01;
	loop 
	fetch c01 into 
		ie_clinica_w, 
		nr_faec_W, 
		cd_grupo_sus_w, 
		ie_tipo_servico_sus_w, 
		qt_ato_w, 
		vl_sadt_w, 
		vl_matmed_w, 
		vl_medico_w, 
		vl_anest_w, 
		qt_aih_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
		begin 
		if (cd_grupo_sus_w <> 10) and (cd_grupo_sus_w <> 13) then 
			vl_sp_w	:= vl_medico_w;
		end if;
		if (cd_grupo_sus_w = 1) then 
			qt_pto_sadt_w	:= qt_ato_w;	
		end if;
		if (ie_tipo_servico_sus_w in (4,7,45)) then 
			qt_pto_sp_w	:= qt_ato_w;
		end if;
		if (cd_grupo_sus_w in (3,6)) then 
			vl_ssm_w	:= vl_matmed_w;
		elsif (cd_grupo_sus_w	= 4) then 
			vl_uti_esp_w	:= vl_matmed_w;
		elsif (cd_grupo_sus_w	= 5) then 
			vl_acomp_w	:= vl_matmed_w;
		elsif (cd_grupo_sus_w = 7) then 
			vl_sangue_w	:= vl_matmed_w;
		elsif (cd_grupo_sus_w	= 8) then 
			vl_transpl_w	:= vl_matmed_w;
		elsif (cd_grupo_sus_w = 9) then 
			vl_neuro_w	:= vl_matmed_w;
		elsif (cd_grupo_sus_w	= 10) then 
			vl_rn_w		:= vl_medico_w;
		elsif (cd_grupo_sus_w = 11) then 
			vl_opm_w	:= vl_matmed_w;
		elsif (cd_grupo_sus_w	= 12) then 
			vl_uti_w	:= vl_matmed_w;
		elsif (cd_grupo_sus_w = 13) then 
			vl_anest_w	:= vl_medico_w;
		elsif (cd_grupo_sus_w	= 14) then 
			vl_nut_enteral_w := vl_matmed_w;
		elsif (cd_grupo_sus_w = 15) then 
			vl_componente_w := vl_matmed_w;
		elsif (cd_grupo_sus_w = 16) then 
			vl_notif_w	:= vl_matmed_w;
		elsif (cd_grupo_sus_w	= 17) then 
			vl_regcivil_w	:= vl_matmed_w;
		elsif (cd_grupo_sus_w = 18) then 
			vl_hiv_w	:= vl_matmed_w;
		elsif (cd_grupo_sus_w = 999) then 
			qt_aih_w	:= qt_aih_w;
		end if;
		vl_total_w	:= (vl_uti_esp_w + vl_ssm_w + vl_sp_w + vl_sadt_w + vl_acomp_w + vl_sangue_w + vl_transpl_w 
 
+ vl_neuro_w + vl_rn_w + vl_opm_w + vl_uti_w + vl_anest_w + vl_nut_enteral_w + vl_componente_w + vl_regcivil_w + 
 
vl_notif_w + vl_hiv_w);
		 
		vl_pto_sp_W	:= vl_sp_w;
		vl_pto_sadt_w	:= vl_sadt_w;
 
		insert into w_gerar_valores_sus( 
		ie_especialidade_aih, 
		nr_faec, 
		qt_aih, 
		vl_ssm, 
		vl_sp, 
		vl_sadt, 
		vl_neuro, 
		vl_transpl, 
		vl_analgesia, 
		vl_componente, 
		vl_notif, 
		vl_uti_esp, 
		vl_opm, 
		vl_sangue, 
		vl_rn, 
		vl_uti, 
		vl_acomp, 
		vl_nut_enteral, 
		vl_regcivil, 
		vl_hiv, 
		vl_total, 
		qt_pto_sp, 
		qt_pto_sadt, 
		vl_pto_sp, 
		vl_pto_sadt) 
	values (	ie_clinica_w, 
		nr_faec_W, 
		qt_aih_w, 
		vl_ssm_w, 
		vl_sp_w, 
		vl_sadt_w, 
		vl_neuro_w, 
		vl_transpl_w, 
		vl_anest_w, 
		vl_componente_w, 
		vl_notif_w, 
		vl_uti_esp_w, 
		vl_opm_w, 
		vl_sangue_w, 
		vl_rn_w, 
		vl_uti_w, 
		vl_acomp_w, 
		vl_nut_enteral_w, 
		vl_regcivil_w, 
		vl_hiv_w, 
		vl_total_w, 
		qt_pto_sp_w, 
		qt_pto_sadt_w, 
		vl_pto_sp_w, 
		vl_pto_sadt_w);
		 
		vl_ssm_w		:= 0;
		vl_sp_w 		:= 0;
		vl_sadt_w 		:= 0;
		vl_neuro_w 		:= 0;
		vl_transpl_w 		:= 0;
		vl_anest_w 		:= 0;
		vl_componente_w		:= 0;
		vl_notif_w 		:= 0;
		vl_uti_esp_w 		:= 0;
		vl_opm_w 		:= 0;
		vl_sangue_w 		:= 0;
		vl_rn_w 		:= 0;
		vl_uti_w 		:= 0;
		vl_acomp_w 		:= 0;
		vl_nut_enteral_w	:= 0;
		vl_regcivil_w 		:= 0;
		vl_hiv_w 		:= 0;
		vl_total_w 		:= 0;
		qt_pto_sp_w		:= 0;
		qt_pto_sadt_w		:= 0;
		vl_pto_sp_w		:= 0;
		vl_pto_sadt_w		:= 0;
		end;
	end loop;
	close c01;
	end;	
 
elsif (ie_tipo_p = 'A') then 
	begin 
	open c02;
	loop 
	fetch c02 into 
		ie_clinica_w, 
		nr_faec_w,		 
		cd_procedimento_solic_w, 
		nr_aih_w, 
		dt_alta_w, 
		qt_dia_acompanhante_w, 
		nr_seq_protocolo_w, 
		nm_pessoa_w, 
		qt_dia_uti_w, 
		qt_ato_w, 
		vl_sadt_w, 
		vl_matmed_w, 
		vl_medico_w, 
		vl_anest_w, 
		qt_aih_w;
	EXIT WHEN NOT FOUND; /* apply on c02 */
		begin 
 
		open c03;
		loop 
		fetch c03 into 
			ie_clinica_aux, 
			nr_faec_w, 
			cd_grupo_sus_w, 
			cd_procedimento_solic_aux, 
			nr_aih_aux, 
			dt_alta_aux, 
			ie_tipo_servico_sus_w, 
			qt_dia_acompanhante_aux, 
			qt_dia_uti_aux, 
			qt_ato_aux, 
			vl_sadt_aux, 
			vl_matmed_aux, 
			vl_medico_aux, 
			vl_anest_aux, 
			qt_aih_aux;
		EXIT WHEN NOT FOUND; /* apply on c03 */
			begin 
			vl_sadt_ww	:= vl_sadt_ww + vl_sadt_aux;
			vl_analgesia_w	:= vl_analgesia_w + vl_anest_aux;
			if (cd_grupo_sus_w	<> 10) and (cd_grupo_sus_w <> 13) then 
				vl_sp_w		:= vl_sp_w + vl_medico_aux;
			end if;
			if (cd_grupo_sus_w = 1) then 
				qt_pto_sadt_w	:= qt_pto_sadt_w + qt_ato_aux;	
			end if;
			if (ie_tipo_servico_sus_w in (4,7,45)) then 
				qt_pto_sp_w	:= qt_pto_sp_w + qt_ato_aux;
			end if;
			if (cd_grupo_sus_w in (3,6)) then 
				vl_ssm_w	:= vl_ssm_w + vl_matmed_aux;
			elsif (cd_grupo_sus_w = 4) then 
				vl_uti_esp_w	:= vl_uti_esp_w + vl_matmed_aux;
			elsif (cd_grupo_sus_w	= 5) then 
				vl_acomp_w	:= vl_acomp_w + vl_matmed_aux;
			elsif (cd_grupo_sus_w	= 7) then 
				vl_sangue_w	:= vl_sangue_w + vl_matmed_aux;
			elsif (cd_grupo_sus_w = 8) then 
				vl_transpl_w	:= vl_transpl_w + vl_matmed_aux;
			elsif (cd_grupo_sus_w = 9) then 
				vl_neuro_w	:= vl_neuro_w + vl_matmed_aux;
			elsif (cd_grupo_sus_w	= 10) then 
				vl_rn_w		:= vl_rn_w + vl_medico_aux;
			elsif (cd_grupo_sus_w	= 11) then 
				vl_opm_w	:= vl_opm_w + vl_matmed_aux;
			elsif (cd_grupo_sus_w	= 12) then 
				vl_uti_w	:= vl_uti_w + vl_matmed_aux;
			elsif (cd_grupo_sus_w = 13) then 
				vl_analgesia_w 	:= vl_analgesia_w + vl_medico_aux;
			elsif (cd_grupo_sus_w = 14) then 
				vl_nut_enteral_w := vl_nut_enteral_w + vl_matmed_aux;
			elsif (cd_grupo_sus_w = 15) then 
				vl_componente_w := vl_componente_w + vl_matmed_aux;
			elsif (cd_grupo_sus_w = 16) then 
				vl_notif_w	:= vl_notif_w + vl_matmed_aux;
			elsif (cd_grupo_sus_w = 17) then 
				vl_regcivil_w	:= vl_regcivil_w + vl_matmed_aux;
			elsif (cd_grupo_sus_w = 18) then 
				vl_hiv_w	:= vl_hiv_w + vl_matmed_aux;
			end if;
 
			qt_aih_w	:= 1;
			vl_total_w	:= (vl_uti_esp_w + vl_ssm_w + vl_sp_w + vl_sadt_w + vl_acomp_w + vl_sangue_w + 
					  vl_transpl_w + vl_neuro_w + vl_rn_w + vl_opm_w + vl_uti_w + vl_analgesia_w + 
 
vl_nut_enteral_w + vl_componente_w + vl_regcivil_w + vl_notif_w + vl_hiv_w);		
 
			end;
			end loop;
			close c03;
		nr_seq_w	:= nr_seq_w + 1;
		vl_pto_sp_W	:= vl_sp_w;
		vl_pto_sadt_w	:= vl_sadt_w;
 
		insert into w_gerar_valores_sus( 
			ie_especialidade_aih, 
			nr_faec, 
			nr_seq, 
			nr_aih,	 
			cd_procedimento_solic, 
			dt_alta, 
			qt_dia_uti, 
			qt_dia_acompanhante, 
			nm_pessoa, 
			qt_aih, 
			vl_ssm, 
			vl_sp, 
			vl_sadt, 
			vl_neuro, 
			vl_transpl, 
			vl_analgesia, 
			vl_componente, 
			vl_notif, 
			vl_uti_esp, 
			vl_opm, 
			vl_sangue, 
			vl_rn, 
			vl_uti, 
			vl_acomp, 
			vl_nut_enteral, 
			vl_regcivil, 
			vl_hiv, 
			vl_total, 
			qt_pto_sp, 
			qt_pto_sadt, 
			vl_pto_sp, 
			vl_pto_sadt) 
		values (	ie_clinica_w, 
			nr_faec_w, 
			nr_seq_w, 
			nr_aih_w,	 
			cd_procedimento_solic_w, 
			dt_alta_w, 
			qt_dia_uti_w, 
			qt_dia_acompanhante_w, 
			nm_pessoa_w, 
			qt_aih_w, 
			vl_ssm_w, 
			vl_sp_w, 
			vl_sadt_ww, 
			vl_neuro_w, 
			vl_transpl_w, 
			vl_analgesia_w, 
			vl_componente_w, 
			vl_notif_w, 
			vl_uti_esp_w, 
			vl_opm_w, 
			vl_sangue_w, 
			vl_rn_w, 
			vl_uti_w, 
			vl_acomp_w, 
			vl_nut_enteral_w, 
			vl_regcivil_w, 
			vl_hiv_w, 
			vl_total_w, 
			qt_pto_sp_w, 
			qt_pto_sadt_w, 
			vl_pto_sp_w, 
			vl_pto_sadt_w);
		vl_ssm_w		:= 0;
		vl_sp_w 		:= 0;
		vl_sadt_ww 		:= 0;
		vl_neuro_w 		:= 0;
		vl_transpl_w 		:= 0;
		vl_analgesia_w 		:= 0;
		vl_componente_w		:= 0;
		vl_notif_w 		:= 0;
		vl_uti_esp_w 		:= 0;
		vl_opm_w 		:= 0;
		vl_sangue_w 		:= 0;
		vl_rn_w 		:= 0;
		vl_uti_w 		:= 0;
		vl_acomp_w 		:= 0;
		vl_nut_enteral_w	:= 0;
		vl_regcivil_w 		:= 0;
		vl_hiv_w 		:= 0;
		vl_total_w 		:= 0;
		qt_pto_sp_w		:= 0;
		qt_pto_sadt_w		:= 0;
		vl_pto_sp_w		:= 0;
		vl_pto_sadt_w		:= 0;
		end;
	end loop;
	close c02;
	end;
end if;
 
commit;
	 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_relat_valores_coopus ( nr_seq_protocolo_p bigint, ie_tipo_p text) FROM PUBLIC;

