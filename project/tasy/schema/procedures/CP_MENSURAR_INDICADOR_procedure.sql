-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE cp_mensurar_indicador ( nr_seq_prescr_p bigint, nr_seq_pat_cp_ind_p bigint, nr_seq_cp_indicator_p bigint, nr_seq_measure_p bigint, ds_note_p text, nr_sequencia_p INOUT bigint, nm_usuario_p text, ie_measure_p text, ie_planned_measure_p text default null) AS $body$
DECLARE

	
qt_register_w		bigint;
nr_sequencia_w		patient_cp_indic_measure.nr_sequencia%type;
nr_current_score_w	cp_measure.nr_sequencia%type;
nr_last_score_w		cp_measure.nr_sequencia%type;
ie_evolution_w		patient_cp_indic_measure.ie_evolution%type := 'NE';
nr_seq_plan_indic_w   patient_cp_indic_measure.nr_seq_plan_indic%type;


BEGIN

select 	count(*)
into STRICT	qt_register_w
from 	patient_cp_indic_measure
where 	nr_seq_pat_cp_ind = nr_seq_pat_cp_ind_p
and		nr_seq_cp_indicator = nr_seq_cp_indicator_p
and		nr_seq_prescr = nr_seq_prescr_p
and 	(nr_seq_measure IS NOT NULL AND nr_seq_measure::text <> '')
and 	coalesce(dt_liberacao::text, '') = '';

select 	max(nr_sequencia)
into STRICT	  nr_seq_plan_indic_w
from 	  patient_cp_indic_plan
where 	  nr_seq_pat_cp_ind = nr_seq_pat_cp_ind_p
and		  nr_seq_cp_indicator = nr_seq_cp_indicator_p
and		  nr_seq_prescr = nr_seq_prescr_p;

select	coalesce(nr_score,0)
into STRICT	nr_current_score_w
from	cp_measure
where	nr_sequencia = nr_seq_measure_p;

select 	coalesce(obter_dados_mensuracao_atual(nr_seq_cp_indicator_p, nr_seq_prescr_p, 'SC'),0)
into STRICT	nr_last_score_w
;

if (nr_last_score_w > 0) then
	if (nr_current_score_w > nr_last_score_w) then
		ie_evolution_w := 'PR';
	elsif (nr_current_score_w < nr_last_score_w) then
		ie_evolution_w := 'RE';
	else
		ie_evolution_w := 'NE';
	end if;
end if;

if (qt_register_w = 0) then

	select	nextval('patient_cp_indic_measure_seq')
	into STRICT	nr_sequencia_w
	;

	insert into patient_cp_indic_measure(
				nr_sequencia,
				ie_measure,
				nr_seq_plan_indic,
				dt_atualizacao,
				dt_atualizacao_nrec,
				nm_usuario,
				nm_usuario_nrec,
				nr_seq_pat_cp_ind,
				dt_evaluation,
				nr_seq_measure,
				nr_score,
				ie_evolution,
				ds_note,
				nr_seq_cp_indicator,
				nr_seq_prescr,
        ie_planned_measure)
			values (
				nr_sequencia_w,
				ie_measure_p,
				nr_seq_plan_indic_w,
				clock_timestamp(),
				clock_timestamp(),
				nm_usuario_p,
				nm_usuario_p,
				nr_seq_pat_cp_ind_p,
				clock_timestamp(),
				nr_seq_measure_p,
				nr_current_score_w,
				ie_evolution_w,
				ds_note_p,
				nr_seq_cp_indicator_p,
				nr_seq_prescr_p,
        ie_planned_measure_p);
	
else

	select 	count(*)
	into STRICT	qt_register_w
	from 	patient_cp_indic_measure
	where 	nr_seq_pat_cp_ind = nr_seq_pat_cp_ind_p
	and		nr_seq_cp_indicator = nr_seq_cp_indicator_p
	and		nr_seq_prescr = nr_seq_prescr_p
	and 	(nr_seq_measure IS NOT NULL AND nr_seq_measure::text <> '');

	if (qt_register_w = 0) then
	
		select	nextval('patient_cp_indic_measure_seq')
		into STRICT	nr_sequencia_w
		;
	
		insert into patient_cp_indic_measure(
				nr_sequencia,
				ie_measure,
				nr_seq_plan_indic,
				dt_atualizacao,
				dt_atualizacao_nrec,
				nm_usuario,
				nm_usuario_nrec,
				nr_seq_pat_cp_ind,
				dt_evaluation,
				nr_seq_measure,
				nr_score,
				ie_evolution,
				ds_note,
				nr_seq_cp_indicator,
				nr_seq_prescr,
        ie_planned_measure)
			values (
				nr_sequencia_w,
				ie_measure_p,
				nr_seq_plan_indic_w,
				clock_timestamp(),
				clock_timestamp(),
				nm_usuario_p,
				nm_usuario_p,
				nr_seq_pat_cp_ind_p,
				clock_timestamp(),
				nr_seq_measure_p,
				nr_current_score_w,
				ie_evolution_w,
				ds_note_p,
				nr_seq_cp_indicator_p,
				nr_seq_prescr_p,
        ie_planned_measure_p);
	
	else
	
		select 	coalesce(max(nr_sequencia),0)
		into STRICT 	nr_sequencia_w
		from 	patient_cp_indic_measure
		where 	nr_seq_pat_cp_ind = nr_seq_pat_cp_ind_p
		and		nr_seq_cp_indicator = nr_seq_cp_indicator_p
		and		nr_seq_prescr = nr_seq_prescr_p
		and 	(nr_seq_measure IS NOT NULL AND nr_seq_measure::text <> '')
		and 	coalesce(dt_liberacao::text, '') = '';
		
		if (nr_sequencia_w > 0) then
		
			update 	patient_cp_indic_measure
			set		nr_seq_measure  = nr_seq_measure_p,
					nr_score 		= nr_current_score_w,
					ie_evolution	= ie_evolution_w,
					dt_evaluation	= clock_timestamp(),
					ds_note			= ds_note_p,
					nr_seq_plan_indic = nr_seq_plan_indic_w
			where	nr_sequencia = nr_sequencia_w;
		
		end if;
	end if;	
end if;

commit;

nr_sequencia_p := nr_sequencia_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cp_mensurar_indicador ( nr_seq_prescr_p bigint, nr_seq_pat_cp_ind_p bigint, nr_seq_cp_indicator_p bigint, nr_seq_measure_p bigint, ds_note_p text, nr_sequencia_p INOUT bigint, nm_usuario_p text, ie_measure_p text, ie_planned_measure_p text default null) FROM PUBLIC;

