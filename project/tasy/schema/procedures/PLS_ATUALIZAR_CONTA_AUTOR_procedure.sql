-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_atualizar_conta_autor ( nr_seq_guia_p bigint, cd_procedimento_p bigint, ie_origem_proced_p bigint, nr_seq_material_p bigint, qt_proc_relacionado_p bigint, qt_mat_relacionado_p bigint, qt_dia_relacionado_p bigint, nr_seq_conta_p bigint, nr_seq_conta_proc_p bigint, nr_seq_conta_mat_p bigint, qt_saldo_mat_p bigint, qt_saldo_proc_p bigint, qt_saldo_dia_p bigint, ie_opcao_p text, nm_usuario_p text) AS $body$
DECLARE


nr_seq_guia_mat_w				bigint;
nr_seq_guia_proc_w				bigint;
qt_autorizada_w					pls_guia_plano_proc.qt_autorizada%type	:= 0;
nr_seq_protocolo_prestador_w	varchar(20);


BEGIN

select	max(b.nr_protocolo_prestador)
into STRICT	nr_seq_protocolo_prestador_w
from	pls_protocolo_conta	b,
		pls_conta		a
where	b.nr_sequencia		= a.nr_seq_protocolo
and	a.nr_sequencia		= nr_seq_conta_p;

if (ie_opcao_p = 'G') then		
	
	insert into pls_conta_autor(nr_sequencia, dt_atualizacao, nm_usuario,
		dt_atualizacao_nrec, nm_usuario_nrec, nr_seq_autor,
		nr_seq_autor_mat, nr_seq_autor_proc, nr_seq_conta,
		nr_seq_conta_mat, nr_seq_conta_proc, qt_mat_relacionada,
		qt_proc_relacionado, qt_dia_relacionada, qt_saldo_mat,
		qt_saldo_proc, qt_saldo_dia, nr_protocolo_prestador)
	values (	nextval('pls_conta_autor_seq'), clock_timestamp(), nm_usuario_p,
		clock_timestamp(), nm_usuario_p, nr_seq_guia_p,
		null, null, nr_seq_conta_p,
		null, nr_seq_conta_proc_p, 0,
		0, qt_dia_relacionado_p, 0,
		0, qt_saldo_dia_p, nr_seq_protocolo_prestador_w);	
end if;

if (ie_opcao_p = 'P') and (cd_procedimento_p IS NOT NULL AND cd_procedimento_p::text <> '') then

	select	coalesce(max(nr_sequencia),0)
	into STRICT	nr_seq_guia_proc_w
	from	pls_guia_plano_proc
	where	nr_seq_guia		= nr_seq_guia_p
	and	cd_procedimento		= cd_procedimento_p
	and	coalesce(ie_origem_proced, ie_origem_proced_p) = ie_origem_proced_p;

	if (nr_seq_guia_proc_w <> 0) then

		select	coalesce(max(qt_autorizada),0)
		into STRICT	qt_autorizada_w
		from	pls_guia_plano_proc
		where	nr_sequencia	= nr_seq_guia_proc_w
		and	not(ie_status	in ('N','M'));

		insert into pls_conta_autor(nr_sequencia, dt_atualizacao, nm_usuario,
			dt_atualizacao_nrec, nm_usuario_nrec, nr_seq_autor,
			nr_seq_autor_mat, nr_seq_autor_proc, nr_seq_conta,
			nr_seq_conta_mat, nr_seq_conta_proc, qt_mat_relacionada,
			qt_proc_relacionado, qt_saldo_mat, qt_saldo_proc,
			qt_dia_relacionada, nr_protocolo_prestador)
		values (	nextval('pls_conta_autor_seq'), clock_timestamp(), nm_usuario_p,
			clock_timestamp(), nm_usuario_p, nr_seq_guia_p,
			null, nr_seq_guia_proc_w, nr_seq_conta_p,
			null, nr_seq_conta_proc_p, null,
			qt_proc_relacionado_p, 0, qt_saldo_proc_p,			
			0, nr_seq_protocolo_prestador_w);
	end if;
end if;

if (ie_opcao_p = 'M') and (nr_seq_material_p IS NOT NULL AND nr_seq_material_p::text <> '') then

	select	coalesce(max(nr_sequencia),0)
	into STRICT	nr_seq_guia_mat_w
	from	pls_guia_plano_mat
	where	nr_seq_guia		= nr_seq_guia_p
	and	nr_seq_material		= nr_seq_material_p;

	if (nr_seq_guia_mat_w <> 0) then

		select	coalesce(max(qt_autorizada),0)
		into STRICT	qt_autorizada_w
		from	pls_guia_plano_mat
		where	nr_sequencia	= nr_seq_guia_mat_w
		and	not(ie_status	in ('N','M'));

		insert into pls_conta_autor(nr_sequencia, dt_atualizacao, nm_usuario,
			dt_atualizacao_nrec, nm_usuario_nrec, nr_seq_autor,
			nr_seq_autor_mat, nr_seq_autor_proc, nr_seq_conta,
			nr_seq_conta_mat, nr_seq_conta_proc, qt_mat_relacionada,
			qt_proc_relacionado, qt_saldo_mat, qt_saldo_proc,
			qt_dia_relacionada, nr_protocolo_prestador)
		values (	nextval('pls_conta_autor_seq'), clock_timestamp(), nm_usuario_p,
			clock_timestamp(), nm_usuario_p, nr_seq_guia_p,
			nr_seq_guia_mat_w, null, nr_seq_conta_p,
			nr_seq_conta_mat_p, null, qt_mat_relacionado_p,
			null, qt_saldo_mat_p, 0,
			0, nr_seq_protocolo_prestador_w);
	end if;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_atualizar_conta_autor ( nr_seq_guia_p bigint, cd_procedimento_p bigint, ie_origem_proced_p bigint, nr_seq_material_p bigint, qt_proc_relacionado_p bigint, qt_mat_relacionado_p bigint, qt_dia_relacionado_p bigint, nr_seq_conta_p bigint, nr_seq_conta_proc_p bigint, nr_seq_conta_mat_p bigint, qt_saldo_mat_p bigint, qt_saldo_proc_p bigint, qt_saldo_dia_p bigint, ie_opcao_p text, nm_usuario_p text) FROM PUBLIC;

