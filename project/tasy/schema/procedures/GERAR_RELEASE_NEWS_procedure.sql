-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_release_news ( ie_libera_news_p text default null, dt_alteracao_p timestamp DEFAULT NULL, cd_funcao_p bigint DEFAULT NULL, nr_ordem_servico_p bigint DEFAULT NULL, ie_alteracao_p text DEFAULT NULL, ie_tipo_cliente_p text DEFAULT NULL, ie_global_p text default null, ie_locales_p text default null, ie_delphi_p text default null, ie_java_p text default null, ie_html5_p text default null, ie_tws_p text default null, nr_seq_template_obj_p text DEFAULT NULL, nr_seq_template_alt_p text DEFAULT NULL, nm_usuario_p text DEFAULT NULL, cd_versao_p text DEFAULT NULL) AS $body$
DECLARE


nr_seq_release_news_w			release_news.nr_sequencia%type;
ds_template_obj_w				release_news_template.ds_template%type;
ds_template_alt_w				release_news_template.ds_template%type;WITH RECURSIVE cte AS (


c_split_locales CURSOR FOR
SELECT	regexp_substr(ie_locales_p, '[^, ]+', 1, level) cd_locale

(regexp_substr(ie_locales_p, '[^, ]+', 1, level) IS NOT NULL AND (regexp_substr(ie_locales_p, '[^, ]+', 1, level))::text <> '')  UNION ALL


c_split_locales CURSOR FOR
SELECT	regexp_substr(ie_locales_p, '[^, ]+', 1, level) cd_locale
 
(regexp_substr(ie_locales_p, '[^, ]+', 1, level) IS NOT NULL AND (regexp_substr(ie_locales_p, '[^, ]+', 1, level))::text <> '') JOIN cte c ON ()

) SELECT * FROM cte;
;

c_split_global CURSOR FOR
SELECT  vl_dominio ds_locale
from    valor_dominio_v
where   cd_dominio = 8031;

BEGIN

if (nr_seq_template_obj_p IS NOT NULL AND nr_seq_template_obj_p::text <> '' AND nr_seq_template_alt_p IS NOT NULL AND nr_seq_template_alt_p::text <> '')	then

select	nextval('release_news_seq')
into STRICT	nr_seq_release_news_w
;

select	max(ds_template)
into STRICT	ds_template_obj_w
from	release_news_template
where	nr_sequencia = nr_seq_template_obj_p;

select	max(ds_template)
into STRICT	ds_template_alt_w
from	release_news_template
where	nr_sequencia = nr_seq_template_alt_p;

insert into release_news(
		nr_sequencia, 
		dt_atualizacao,
		nm_usuario,
		dt_atualizacao_nrec,
		nm_usuario_nrec,
		cd_versao,
		nr_seq_ordem_serv,
		nr_seq_template_obj,
		nr_seq_template_alt,
		ds_objetivo,
		ds_alteracao,
		ie_delphi,
		ie_java,
		ie_html5,
		ie_tws,
		ie_tipo_cliente,
		ie_global,
		cd_funcao,
		dt_alteracao, 
		dt_liberacao,
		nm_usuario_liberacao,
		ie_locales,
		ds_template_obj,
		ds_template_alt,
		ie_alteracao)
values (	nr_seq_release_news_w, 
		clock_timestamp(),
		nm_usuario_p,
		clock_timestamp(),
		nm_usuario_p,
		cd_versao_p,
		nr_ordem_servico_p,
		nr_seq_template_obj_p,
		nr_seq_template_alt_p,
		null,
		null,
		ie_delphi_p,
		ie_java_p,
		ie_html5_p,
		ie_tws_p,
		coalesce(ie_tipo_cliente_p,'A'),
		ie_global_p,
		cd_funcao_p,
		clock_timestamp(),
		CASE WHEN coalesce(ie_libera_news_p,'N')='S' THEN clock_timestamp()  ELSE null END ,
		CASE WHEN coalesce(ie_libera_news_p,'N')='S' THEN nm_usuario_p  ELSE null END ,
		ie_locales_p,
		ds_template_obj_w,
		ds_template_alt_w,
		ie_alteracao_p);
	
insert into release_news_idioma(
		nr_sequencia,
		dt_atualizacao,
		nm_usuario,
		dt_atualizacao_nrec,
		nm_usuario_nrec,
		nr_seq_release,
		ds_idioma,
		ds_locale,
		nm_usuario_aprov,
		dt_aprovacao,
		ds_objetivo,
		ds_alteracao)
values (nextval('release_news_idioma_seq'),
		clock_timestamp(),
		nm_usuario_p,
		clock_timestamp(),
		nm_usuario_p,
		nr_seq_release_news_w,
		null,
		'pt_BR',
		null,
		null,
		null,
		null);

if	(ie_locales_p IS NOT NULL AND ie_locales_p::text <> '' AND ie_global_p = 'N') then

	for r_c_split_locales in c_split_locales loop
	
		if (r_c_split_locales.cd_locale <> 'pt_BR')	then
		
			insert into release_news_idioma(
				nr_sequencia,
				dt_atualizacao,
				nm_usuario,
				dt_atualizacao_nrec,
				nm_usuario_nrec,
				nr_seq_release,
				ds_idioma,
				ds_locale,
				nm_usuario_aprov,
				dt_aprovacao,
				ds_objetivo,
				ds_alteracao)
			values (
				nextval('release_news_idioma_seq'),
				clock_timestamp(),
				nm_usuario_p,
				clock_timestamp(),
				nm_usuario_p,
				nr_seq_release_news_w,
				null,
				r_c_split_locales.cd_locale,
				null,
				null,
				null,
				null);
				
			end if;
			
	end loop;
	
end if;

if (ie_global_p = 'S') then

	for r_c_split_global in c_split_global loop
	
		if (r_c_split_global.ds_locale <> 'pt_BR')	then
		
			insert into release_news_idioma(
				nr_sequencia,
				dt_atualizacao,
				nm_usuario,
				dt_atualizacao_nrec,
				nm_usuario_nrec,
				nr_seq_release,
				ds_idioma,
				ds_locale,
				nm_usuario_aprov,
				dt_aprovacao,
				ds_objetivo,
				ds_alteracao)
			values (
				nextval('release_news_idioma_seq'),
				clock_timestamp(),
				nm_usuario_p,
				clock_timestamp(),
				nm_usuario_p,
				nr_seq_release_news_w,
				null,
				r_c_split_global.ds_locale,
				null,
				null,
				null,
				null);
				
			end if;
			
	end loop;
	
end if;

commit;

end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_release_news ( ie_libera_news_p text default null, dt_alteracao_p timestamp DEFAULT NULL, cd_funcao_p bigint DEFAULT NULL, nr_ordem_servico_p bigint DEFAULT NULL, ie_alteracao_p text DEFAULT NULL, ie_tipo_cliente_p text DEFAULT NULL, ie_global_p text default null, ie_locales_p text default null, ie_delphi_p text default null, ie_java_p text default null, ie_html5_p text default null, ie_tws_p text default null, nr_seq_template_obj_p text DEFAULT NULL, nr_seq_template_alt_p text DEFAULT NULL, nm_usuario_p text DEFAULT NULL, cd_versao_p text DEFAULT NULL) FROM PUBLIC;

