-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gravar_historico_saude ( nm_tabela_p text, nr_sequencia_p bigint, cd_pessoa_fisica_p text, ie_liberar_p text, nr_atendimento_p bigint, nr_seq_reg_elemento_p bigint, nm_usuario_p text, nr_seq_registro_p INOUT bigint, ds_erro_p INOUT text, nr_seq_triagem_p bigint default 0, nr_seq_atend_cons_pepa_p bigint default null) AS $body$
DECLARE





cd_perfil_w		bigint;
dt_liberacao_w		timestamp;
nm_usuario_liberacao_w	varchar(20);
nr_sequencia_w		bigint;
nr_seq_hist_saude_w	bigint;
ds_comando_w		varchar(4000);
ds_parametro_w		varchar(4000);
vl_campo_w		varchar(4000);
ie_nega_w		varchar(1);
cd_setor_atend_w    	integer;
ie_confirmacao_w 	varchar(1);
cd_profissional_w	varchar(10);
nr_seq_triagem_w	bigint;
ie_paciente_w		varchar(10);
cd_doenca_w		varchar(10);
nr_proj_assinatura_w	tasy_projeto_assinatura.nr_sequencia%type;
nr_seq_visao_w		tabela_visao.nr_sequencia%type;
ie_should_sign_w	tasy_proj_assin_perfil.ie_assinatura%type;

c01 CURSOR FOR
	SELECT	*
	from	historico_saude
	where	nr_sequencia	= nr_sequencia_p;



c02 CURSOR FOR
	SELECT	a.nm_tabela,
		a.nm_atributo,
		a.ie_tipo_campo,
		b.nr_inf_adic,
		b.ds_inf_adic,
		b.dt_inf_adic
	from	historico_saude_inf_adic a,
		hist_saude_inf_adic_item b
	where	a.nr_sequencia		= b.nr_seq_inf_adic
	and	a.nr_seq_hist_saude	= nr_seq_hist_saude_w
	and	b.cd_pessoa_fisica	= cd_pessoa_fisica_p
	and	b.nm_usuario		= nm_usuario_p
	order by nr_seq_apresentacao desc;

c01_w	c01%rowtype;

c02_w	c02%rowtype;



BEGIN
cd_perfil_w	:= obter_perfil_ativo;


if (cd_perfil_w	= 0) then
	cd_perfil_w	:= null;
end if;

if (ie_liberar_p	= 'S') then
	dt_liberacao_w		:= clock_timestamp();
	nm_usuario_liberacao_w	:= nm_usuario_p;
end if;

begin

cd_profissional_w	:= Obter_Pessoa_Fisica_Usuario(nm_usuario_p,'C');

        open c01;
        loop
        fetch c01 into
                c01_w;
        EXIT WHEN NOT FOUND; /* apply on c01 */
                begin
                nr_seq_hist_saude_w	:= c01_w.nr_sequencia;

                if (nm_tabela_p	= 'PACIENTE_ALERGIA') then

						nr_proj_assinatura_w := 25175;
						nr_seq_visao_w := 29775;

                        select	nextval('paciente_alergia_seq')
                        into STRICT	nr_sequencia_w
;
						
						nr_seq_triagem_w := nr_seq_triagem_p;
						if (nr_seq_triagem_p = 0) then
							nr_seq_triagem_w := nr_seq_triagem_p;
						end if;

                        insert into paciente_alergia(
                                nr_sequencia,
                                cd_pessoa_fisica,
								cd_profissional,
                                dt_atualizacao,
                                nm_usuario,
                                nr_seq_tipo,
                                cd_classe_mat,
                                cd_material,
                                ds_observacao,
                                nr_seq_reacao,
                                ie_intensidade,
                                ie_abordagem,
                                dt_inicio,
                                dt_ultima,
                                ie_confirmacao,
                                nr_seq_dcb,
                                nr_atendimento,
                                dt_registro,
                                dt_fim,
                                dt_atualizacao_nrec,
                                nm_usuario_nrec,
                                dt_liberacao,
                                nm_usuario_liberacao,
                                nr_seq_nivel_seg,
                                nr_seq_ficha_tecnica,
                                nr_seq_saep,
                                dt_inativacao,
                                nm_usuario_inativacao,
                                ds_justificativa,
                                ie_nega_alergias,
                                nr_seq_reg_elemento,
                                cd_perfil_ativo,
                                ds_medic_nao_cad,
                                nr_seq_assinatura,
                                ie_alerta,
								nr_seq_familia,
								nr_seq_triagem,
								nr_seq_hist_rotina,
								nr_seq_atend_cons_pepa,
								ie_classificacao)
                                 values (
                                nr_sequencia_w,
                                cd_pessoa_fisica_p,
                                cd_profissional_w,
                                clock_timestamp(),
                                nm_usuario_p,
                                c01_w.nr_seq_tipo_alergia,
                                c01_w.cd_classe_mat,
                                c01_w.cd_material_alergia,
                                null,
                                null,
                                coalesce(C01_W.ie_intensidade,'S'),
                                null,
                                null,
                                null,
                                coalesce(c01_w.ie_confirmacao,'C'),
                                c01_w.nr_seq_dcb,
                                CASE WHEN nr_atendimento_p=0 THEN null  ELSE nr_atendimento_p END ,
                                clock_timestamp(),
                                null,
                                clock_timestamp(),
                                nm_usuario_p,
                                dt_liberacao_w,
                                nm_usuario_liberacao_w,
                                c01_w.nr_seq_nivel_seg,
                                c01_w.nr_seq_ficha_tecnica,
                                null,
                                null,
                                null,
                                null,
                                CASE WHEN coalesce(trim(both c01_w.nr_seq_tipo_alergia)::text, '') = '' THEN coalesce(C01_W.ie_nega,'N')  ELSE 'N' END ,								
                                nr_seq_reg_elemento_p,
                                cd_perfil_w,
                                c01_w.ds_medic_nao_cad,
                                null ,
                                coalesce(c01_w.ie_alerta,'S'),
								c01_w.NR_SEQ_FAMILIA,
								nr_seq_triagem_w,
								nr_seq_hist_saude_w,
								nr_seq_atend_cons_pepa_p,
								coalesce(c01_w.ie_classificacao_alergia, 'A'));

                elsif (nm_tabela_p	= 'PACIENTE_ANTEC_CLINICO') then

						if (c01_w.ie_paciente = 'S')then
							nr_proj_assinatura_w := 25177;
							nr_seq_visao_w := 29776;
						elsif (c01_w.ie_paciente = 'N')then
							nr_proj_assinatura_w := 25179;
							nr_seq_visao_w := 29784;
						end if;

                        select	nextval('paciente_antec_clinico_seq')
                        into STRICT	nr_sequencia_w
;

						if (coalesce(c01_w.ds_doenca::text, '') = '') and (coalesce(c01_w.nr_seq_doenca::text, '') = '') and (coalesce(c01_w.cd_doenca::text, '') = '') then
							ie_nega_w := coalesce(C01_W.ie_nega,'N');
						else
							ie_nega_w := 'N';
						end if;

                        insert into paciente_antec_clinico(
                                nr_sequencia,
                                cd_pessoa_fisica,
                                cd_profissional,
                                dt_atualizacao,
                                nm_usuario, ds_doenca, ie_status,
                                ie_intensidade,
                                dt_inicio,
                                dt_fim,
                                ds_abordagem,
                                ds_observacao,
                                nr_atendimento,
                                dt_registro,
                                nr_seq_doenca,
                                dt_atualizacao_nrec,
                                nm_usuario_nrec,
                                dt_liberacao,
                                nm_usuario_liberacao,
                                nr_seq_nivel_seg,
                                nr_seq_saep,
                                dt_inativacao,
                                nm_usuario_inativacao,
                                ds_justificativa,
                                ie_nega_doencas,
                                nr_seq_reg_elemento,
                                cd_perfil_ativo,
                                ie_paciente,
                                cd_doenca,
                                nr_seq_parentesco,
                                nr_seq_assinatura ,
                                IE_ALERTA,
								nr_seq_hist_rotina,
								nr_seq_atend_cons_pepa)
                        values (
                                nr_sequencia_w,
                                cd_pessoa_fisica_p,
                                cd_profissional_w,
                                clock_timestamp(),
                                nm_usuario_p,
                                c01_w.ds_doenca,
                                c01_w.ie_status,
                                coalesce(C01_W.ie_intensidade,'S') ,
                                null,
                                null,
                                null,
                                null,
                                CASE WHEN nr_atendimento_p=0 THEN null  ELSE nr_atendimento_p END ,
                                clock_timestamp(),
                                c01_w.nr_seq_doenca,
                                clock_timestamp(),
                                nm_usuario_p,
                                dt_liberacao_w,
                                nm_usuario_liberacao_w,
                                c01_w.nr_seq_nivel_seg,
                                null,
                                null,
                                null,
                                null,
                                ie_nega_w, --NVL(C01_W.ie_nega,'N'),
                                nr_seq_reg_elemento_p,
                                cd_perfil_w,
                                c01_w.ie_paciente,
                                c01_w.cd_doenca,
                                c01_w.nr_seq_parentesco,
                                null ,
                                c01_w.IE_ALERTA,
								nr_seq_hist_saude_w,
								nr_seq_atend_cons_pepa_p);
															


                elsif (nm_tabela_p	= 'PACIENTE_MEDIC_USO') then

						nr_proj_assinatura_w := 25180;
						nr_seq_visao_w := 29777;

                        select	nextval('paciente_medic_uso_seq')
                        into STRICT	nr_sequencia_w
;

                        insert into paciente_medic_uso(
                                        nr_sequencia,
                                        cd_pessoa_fisica,
                                        cd_profissional,
                                        dt_atualizacao,
                                        nm_usuario,
                                        cd_material,
                                        cd_unid_med,
                                        cd_intervalo,
                                        qt_dose,
                                        dt_inicio,
                                        dt_fim,
                                        ds_reacao,
                                        ds_observacao,
                                        ds_medicamento,
                                        nr_atendimento,
                                        dt_registro,
                                        ie_intensidade,
                                        dt_atualizacao_nrec,
                                        nm_usuario_nrec,
                                        dt_liberacao,
                                        nm_usuario_liberacao,
                                        nr_seq_nivel_seg,
                                        nr_seq_saep,
                                        dt_inativacao,
                                        nm_usuario_inativacao,
                                        ds_justificativa,
                                        nr_seq_reg_elemento,
                                        dt_ultima_dose,
                                        ie_nao_sabe_inicio,
                                        ie_nao_sabe_fim,
                                        ie_nao_sabe_ult_dose,
                                        ie_nega_medicamentos,
                                        ie_motivo_termino,
                                        ie_procedencia,
                                        ie_auto_medicacao,
                                        nr_seq_assinatura,
                                        dt_revisao ,
                                        IE_ALERTA,
										nr_seq_hist_rotina,
										nr_seq_atend_cons_pepa)
                         values (	nr_sequencia_w,
                                        cd_pessoa_fisica_p,
                                        cd_profissional_w,
                                        clock_timestamp(),
                                        nm_usuario_p,
                                        c01_w.cd_material_medic,
                                        null,
                                        null,
                                        null,
                                        null,
                                        null,
                                        null,
                                        null,
                                        c01_w.ds_medicamento,
                                        CASE WHEN nr_atendimento_p=0 THEN null  ELSE nr_atendimento_p END ,
                                        clock_timestamp(),
                                        coalesce(C01_W.ie_intensidade,'S'),
                                        clock_timestamp(),
                                        nm_usuario_p,
                                        dt_liberacao_w,
                                        nm_usuario_liberacao_w,
                                        c01_w.nr_seq_nivel_seg,
                                        null,
                                        null,
                                        null,
                                        null,
                                        nr_seq_reg_elemento_p,
                                        null,
                                        null,
                                        null,
                                        null,
                                        coalesce(C01_W.ie_nega,'N'),
                                        null,
                                        null,
                                        null,
                                        null,
                                        null,
                                        c01_w.IE_ALERTA,
										nr_seq_hist_saude_w,
										nr_seq_atend_cons_pepa_p);

                elsif (nm_tabela_p	= 'PACIENTE_HABITO_VICIO') then

						nr_proj_assinatura_w := 25178;
						nr_seq_visao_w := 29778;

                        select	nextval('paciente_habito_vicio_seq')
                        into STRICT	nr_sequencia_w
;

                        insert into paciente_habito_vicio(
                                        nr_sequencia,
                                        cd_pessoa_fisica,
                                        cd_profissional,
                                        dt_atualizacao,
                                        nm_usuario,
                                        ie_classificacao,
                                        nr_seq_tipo,
                                        ie_intensidade,
                                        ie_frequencia,
                                        dt_inicio,
                                        dt_fim,
                                        ds_quantidade,
                                        ds_consequencia,
                                        ds_observacao,
                                        nr_atendimento,
                                        dt_registro,
                                        dt_atualizacao_nrec,
                                        nm_usuario_nrec,
                                        cd_unidade_medida,
                                        qt_utilizacao,
                                        dt_liberacao,
                                        nm_usuario_liberacao,
                                        nr_seq_nivel_seg,
                                        nr_seq_saep,
                                        ie_nega_habito,
                                        dt_inativacao,
                                        nm_usuario_inativacao,
                                        ds_justificativa,
                                        nr_seq_reg_elemento,
                                        nr_seq_assinatura,
                                        ie_alerta,
										nr_seq_hist_rotina,
										nr_seq_atend_cons_pepa)
                         values ( 	nr_sequencia_w,
                                        cd_pessoa_fisica_p,
                                        cd_profissional_w,
                                        clock_timestamp(),
                                        nm_usuario_p,
                                        c01_w.ie_classificacao,
                                        c01_w.nr_seq_tipo_vicio,
                                        coalesce(C01_W.ie_intensidade,'S'),
                                        null,
                                        null,
                                        null,
                                        null,
                                        null,
                                        null,
                                        CASE WHEN nr_atendimento_p=0 THEN null  ELSE nr_atendimento_p END ,
                                        clock_timestamp(),
                                        clock_timestamp(),
                                        nm_usuario_p,
                                        null,
                                        null,
                                        dt_liberacao_w,
                                        nm_usuario_liberacao_w,
                                        c01_w.nr_seq_nivel_seg,
                                        null,
                                        coalesce(C01_W.ie_nega,'N'),
                                        null,
                                        null,
                                        null,
                                        nr_seq_reg_elemento_p,
                                        null,
										c01_w.ie_alerta,
										nr_seq_hist_saude_w,
										nr_seq_atend_cons_pepa_p);

                elsif (nm_tabela_p	= 'HISTORICO_SAUDE_CIRURGIA') then

						nr_proj_assinatura_w := 25176;
						nr_seq_visao_w := 29779;

                        select	nextval('historico_saude_cirurgia_seq')
                        into STRICT	nr_sequencia_w
;

                        insert into historico_saude_cirurgia(
                                nr_sequencia,
                                dt_atualizacao,
                                nm_usuario,
                                dt_atualizacao_nrec,
                                nm_usuario_nrec,
                                dt_cirurgia,
                                cd_procedimento,
                                ie_origem_proced,
                                ds_procedimento_inf,
                                ie_tipo_anestesia,
                                ds_local,
                                cd_pessoa_fisica,
                                cd_profissional,
                                ds_complicacao,
                                ie_intensidade,
                                ds_observacao,
                                dt_liberacao,
                                nm_usuario_liberacao,
                                nr_seq_nivel_seg,
                                dt_fim,
                                dt_inicio,
                                nr_seq_saep,
                                dt_inativacao,
                                nm_usuario_inativacao,
                                ds_justificativa,
                                nr_seq_reg_elemento,
                                ie_nega_cirurgias,
                                nr_seq_assinatura,
								nr_atendimento,
								nr_seq_hist_rotina,
								nr_seq_atend_cons_pepa)
                                 values (
                                nr_sequencia_w,
                                clock_timestamp(),
                                nm_usuario_p,
                                clock_timestamp(),
                                nm_usuario_p,
                                null,
                                c01_w.cd_procedimento,
                                c01_w.ie_origem_proced,
                                c01_w.ds_procedimento_inf,
                                null,
                                null,
                                cd_pessoa_fisica_p,
                                cd_profissional_w,
                                null,
                                coalesce(C01_W.ie_intensidade,'S'),
                                null,
                                dt_liberacao_w,
                                nm_usuario_liberacao_w,
                                c01_w.nr_seq_nivel_seg,
                                null,
                                null,
                                null,
                                null,
                                null,
                                null,
                                nr_seq_reg_elemento_p,
                                coalesce(C01_W.ie_nega,'N'),
                                null,
								CASE WHEN nr_atendimento_p=0 THEN null  ELSE nr_atendimento_p END ,
								nr_seq_hist_saude_w,
								nr_seq_atend_cons_pepa_p);

                elsif (nm_tabela_p	= 'PACIENTE_OCORRENCIA') then

						nr_proj_assinatura_w := 25181;
						nr_seq_visao_w := 29782;

                        select	nextval('paciente_ocorrencia_seq')
                        into STRICT	nr_sequencia_w
;

                        insert into paciente_ocorrencia(
                                nr_sequencia,
                                dt_atualizacao,
                                nm_usuario,
                                dt_atualizacao_nrec,
                                nm_usuario_nrec,
                                cd_pessoa_fisica,
                                cd_profissional,
                                nr_seq_tipo_ocorrencia,
                                ds_comentario,
                                ie_intensidade,
                                dt_liberacao,
                                dt_registro,
                                nm_usuario_liberacao,
                                nr_atendimento,
                                nr_seq_nivel_seg,
                                nr_seq_saep,
                                dt_inativacao,
                                nm_usuario_inativacao,
                                ds_justificativa,
                                nr_seq_reg_elemento,
                                nr_seq_assinatura,
                                ie_alerta,
								nr_seq_hist_rotina,
								nr_seq_atend_cons_pepa)
                                 values (
                                nr_sequencia_w,
                                clock_timestamp(),
                                nm_usuario_p,
                                clock_timestamp(),
                                nm_usuario_p,
                                cd_pessoa_fisica_p,
                                cd_profissional_w,
                                c01_w.nr_seq_tipo_ocorrencia,
                                c01_w.ds_comentario,
                                coalesce(C01_W.ie_intensidade,'S'),
                                dt_liberacao_w,
                                clock_timestamp(),
                                nm_usuario_liberacao_w,
                                CASE WHEN nr_atendimento_p=0 THEN null  ELSE nr_atendimento_p END ,
                                c01_w.nr_seq_nivel_seg,
                                null,
                                null,
                                null,
                                null,
                                nr_seq_reg_elemento_p,
                                null,
                                c01_w.ie_alerta,
								nr_seq_hist_saude_w,
								nr_seq_atend_cons_pepa_p);

                elsif (nm_tabela_p	= 'PACIENTE_REP_PRESCRICAO') then

						nr_proj_assinatura_w := 25182;
						nr_seq_visao_w := 29783;

                        select	nextval('paciente_rep_prescricao_seq')
                        into STRICT	nr_sequencia_w
;

                        insert into paciente_rep_prescricao(
                                nr_sequencia,
                                dt_atualizacao,
                                nm_usuario,
                                dt_atualizacao_nrec,
                                nm_usuario_nrec,
                                cd_pessoa_fisica,
                                cd_profissional,
                                nr_seq_restricao,
                                ie_alerta,
                                nr_seq_nivel_seg,
                                ie_situacao,
                                dt_liberacao,
                                nm_usuario_liberacao,
                                dt_inativacao,
                                nm_usuario_inativacao,
                                ds_justificativa,
                                nr_seq_reg_elemento,
                                dt_inicio,
                                dt_fim,
                                nr_seq_assinatura ,
                                ds_observacao,
								nr_seq_hist_rotina,
								nr_seq_atend_cons_pepa)
                         values (nr_sequencia_w,
                                clock_timestamp(),
                                nm_usuario_p,
                                clock_timestamp(),
                                nm_usuario_p,
                                cd_pessoa_fisica_p,
                                cd_profissional_w,
                                c01_w.nr_seq_restricao,
                                coalesce(C01_W.ie_alerta,'S'),
                                C01_W.NR_SEQ_NIVEL_SEG,
                                'A',
                                dt_liberacao_w,
                                nm_usuario_liberacao_w,
                                null,
                                null,
                                null,
                                nr_seq_reg_elemento_p,
                                null,
                                null,
                                null ,
                                c01_w.ds_observacao,
								nr_seq_hist_saude_w,
								nr_seq_atend_cons_pepa_p);


                elsif (nm_tabela_p	= 'PACIENTE_ACESSORIO') then

						nr_proj_assinatura_w := 25174;
						nr_seq_visao_w := 29785;

                        select	nextval('paciente_acessorio_seq')
                        into STRICT	nr_sequencia_w
;

                        insert into paciente_acessorio(
                                nr_sequencia,
                                dt_atualizacao,
                                nm_usuario,
                                dt_atualizacao_nrec,
                                nm_usuario_nrec,
                                nr_seq_acessorio,
                                cd_profissional,
                                dt_registro,
                                dt_liberacao,
                                nm_usuario_liberacao,
                                ds_observacao,
                                nr_seq_caracteristica,
                                nr_seq_localizacao,
                                dt_inativacao,
                                nm_usuario_inativacao,
                                ds_justificativa,
                                cd_pessoa_fisica,
                                ie_situacao,
                                nr_seq_reg_elemento,
                                ie_alerta,
                                nr_seq_nivel_seg,
                                nr_seq_assinatura,
                                dt_inicio,
                                dt_fim,
								nr_seq_hist_rotina,
								nr_seq_atend_cons_pepa)
                        values ( nr_sequencia_w,
                                clock_timestamp(),
                                nm_usuario_p,
                                clock_timestamp(),
                                nm_usuario_p,
                                c01_w.nr_seq_acessorio,
                                cd_profissional_w,
                                clock_timestamp(),
                                dt_liberacao_w,
                                nm_usuario_liberacao_w,
                                null,
                                c01_w.nr_seq_caracteristica,
                                c01_w.nr_seq_localizacao,
                                null,
                                null,
                                null,
                                cd_pessoa_fisica_p,
                                'A',
                                nr_seq_reg_elemento_p,
                                coalesce(C01_W.ie_alerta,'S'),
                                c01_w.nr_seq_nivel_seg,
                                null,
                                null,
                                null,
								nr_seq_hist_saude_w,
								nr_seq_atend_cons_pepa_p);

                elsif (nm_tabela_p	= 'CIH_PAC_FAT_RISCO') then

						nr_proj_assinatura_w := 53495;
						nr_seq_visao_w := 29786;

                        select	nextval('cih_pac_fat_risco_seq')
                        into STRICT	nr_sequencia_w
;

                        insert into cih_pac_fat_risco(
                                nr_sequencia,
                                cd_estabelecimento,
                                dt_atualizacao,
                                nm_usuario,
                                dt_atualizacao_nrec,
                                nm_usuario_nrec,
                                cd_pessoa_fisica,
								cd_profissional,
                                nr_atendimento,
                                nr_seq_fator_risco,
                                dt_registro,
                                dt_fim_risco,
                                nr_seq_ficha_ocorrencia ,
                                nr_seq_reg_elemento,
								dt_liberacao,
								nm_usuario_lib,
								nr_seq_hist_rotina,
								nr_seq_atend_cons_pepa)
                         values ( nr_sequencia_w,
                                wheb_usuario_pck.get_cd_estabelecimento,
                                clock_timestamp(),
                                nm_usuario_p,
                                clock_timestamp(),
                                nm_usuario_p,
                                cd_pessoa_fisica_p,
								cd_profissional_w,
                                CASE WHEN nr_atendimento_p=0 THEN null  ELSE nr_atendimento_p END ,
                                c01_w.nr_seq_fator_risco,
                                clock_timestamp(),
                                null,
                                null ,
                                nr_seq_reg_elemento_p,
								dt_liberacao_w,
								nm_usuario_liberacao_w,
								nr_seq_hist_saude_w,
								nr_seq_atend_cons_pepa_p);

                elsif (nm_tabela_p	= 'PF_TIPO_DEFICIENCIA') then		

                        select	nextval('pf_tipo_deficiencia_seq')
                        into STRICT	nr_sequencia_w
;

                        nr_proj_assinatura_w := 51496;
                        nr_seq_visao_w := 106798;

                        insert into pf_tipo_deficiencia(
                                nr_sequencia,
                                dt_atualizacao,
                                nm_usuario,
                                dt_atualizacao_nrec,
                                nm_usuario_nrec,
                                nr_seq_tipo_def,
                                cd_pessoa_fisica,
								cd_profissional,
                                dt_liberacao,
								IE_ALERTA,
								IE_NEGA_DEFICIENCIA,
								nr_seq_hist_rotina,
								nr_seq_atend_cons_pepa)
                        values ( nr_sequencia_w,
                                clock_timestamp(),
                                nm_usuario_p,
                                clock_timestamp(),
                                nm_usuario_p,
                                c01_w.nr_seq_tipo_def,
                                cd_pessoa_fisica_p,
								cd_profissional_w,
                                dt_liberacao_w,
								c01_w.IE_ALERTA,
								'N',
								nr_seq_hist_saude_w,
								nr_seq_atend_cons_pepa_p);

                elsif (nm_tabela_p   = 'PACIENTE_AMPUTACAO') then

						nr_proj_assinatura_w := 53675;
						nr_seq_visao_w := 29794;

						select nextval('paciente_amputacao_seq')
                        into STRICT   nr_sequencia_w
;

                        insert into paciente_amputacao(
                                nr_sequencia,
                                dt_atualizacao,
                                nm_usuario,
                                dt_atualizacao_nrec,
                                nm_usuario_nrec,
                                cd_pessoa_fisica,
								cd_profissional,
                                nm_usuario_liberacao,
                                ds_observacao,
                                ie_situacao,
                                dt_liberacao,
                                dt_inativacao,
                                nm_usuario_inativacao,
                                ds_justificativa,
                                nm_usuario_revisao,
                                dt_revisao,
                                nr_seq_amputacao,
                                nr_seq_reg_elemento,
								nr_seq_hist_rotina,
								nr_seq_atend_cons_pepa)
                        values (nr_sequencia_w,
                                clock_timestamp(),
                                nm_usuario_p,
                                clock_timestamp(),
                                nm_usuario_p,
                                cd_pessoa_fisica_p,
                                cd_profissional_w,
                                nm_usuario_liberacao_w,
                                null,
                                'A',
                                dt_liberacao_w,
                                null,
                                null,
                                null,
                                null,
                                null,
                                c01_w.nr_seq_amputacao,
                                nr_seq_reg_elemento_p,
								nr_seq_hist_saude_w,
								nr_seq_atend_cons_pepa_p);

                elsif (nm_tabela_p   = 'PACIENTE_VACINA') then                 
                
                        select nextval('paciente_vacina_seq') 
                        into STRICT   nr_sequencia_w
;

                        nr_proj_assinatura_w := 51494;
                        nr_seq_visao_w := 29788;

                        cd_setor_atend_w := Obter_Setor_Atendimento(nr_atendimento_p);

                        insert into paciente_vacina(
                                nr_sequencia,
                                nr_atendimento, 
                                ie_dose,
                                dt_vacina,
                                nr_seq_vacina,
                                dt_atualizacao, 
                                nm_usuario,
                                cd_pessoa_fisica,
								cd_profissional,
                                cd_setor_atendimento,
                                ie_executado,
                                nm_usuario_liberacao,
                                dt_liberacao,
                                ie_localidade_inf,
                                dt_registro,
                                ie_situacao,
                                ie_confirmado,
                                nr_seq_reg_elemento,
								nr_seq_hist_rotina,
								nr_seq_atend_cons_pepa)
                        values (nr_sequencia_w,
                                nr_atendimento_p,
                                c01_w.ie_dose,
                                clock_timestamp(),
                                c01_w.nr_seq_vacina,
                                clock_timestamp(),
                                nm_usuario_p,
                                cd_pessoa_fisica_p,
								cd_profissional_w,
                                cd_setor_atend_w,
                                'N',
                                nm_usuario_liberacao_w,
                                dt_liberacao_w,
                                'N',
                                clock_timestamp(),
                                'A',
                                'N',
                                nr_seq_reg_elemento_p,
								nr_seq_hist_saude_w,
								nr_seq_atend_cons_pepa_p);

                elsif (nm_tabela_p   = 'PACIENTE_EXAME') then

                        select nextval('paciente_exame_seq') 
                        into STRICT   nr_sequencia_w
;

						nr_proj_assinatura_w := 51508;
						nr_seq_visao_w := 29791;

                        insert into paciente_exame(
                                nr_sequencia,
                                dt_atualizacao,
                                nm_usuario,
                                dt_atualizacao_nrec,
                                nm_usuario_nrec,
                                ie_exame_pac,
                                ds_resultado,
                                cd_pessoa_fisica,
								cd_profissional,
                                ds_observacao,
                                dt_liberacao,
                                nm_usuario_liberacao,
                                nr_seq_forma_reg,
                                dt_registro,
                                ie_alerta,
                                ie_situacao,
                                dt_exame,
                                nr_seq_reg_elemento,
								nr_seq_hist_rotina,
								nr_seq_atend_cons_pepa)
                        values (nr_sequencia_w,
                                clock_timestamp(),
                                nm_usuario_p,
                                clock_timestamp(),
                                nm_usuario_p,
                                c01_w.ie_exame_pac,
                                null,
                                cd_pessoa_fisica_p,
								cd_profissional_w,
                                null,
                                dt_liberacao_w,
                                nm_usuario_liberacao_w,
                                c01_w.nr_seq_forma_reg,
                                clock_timestamp(),
                                'N',
                                'A',
                                clock_timestamp(),
                                nr_seq_reg_elemento_p,
								nr_seq_hist_saude_w,
								nr_seq_atend_cons_pepa_p);
                elsif (nm_tabela_p   = 'PACIENTE_PFLEGEGRAD') then

                        select nextval('paciente_pflegegrad_seq')
                        into STRICT   nr_sequencia_w
;

                        insert into PACIENTE_PFLEGEGRAD(
                                nr_sequencia,
                                dt_atualizacao,
                                nm_usuario,
                                dt_atualizacao_nrec,
                                nm_usuario_nrec,
                                cd_pessoa_fisica,
								cd_profissional,
                                dt_liberacao,
                                nm_usuario_liberacao,
                                dt_registro,
                                ie_situacao,
								IE_PFLEGEGRAD,
								nr_atendimento,
								nr_seq_hist_rotina,
								nr_seq_atend_cons_pepa)
                        values (nr_sequencia_w,
                                clock_timestamp(),
                                nm_usuario_p,
                                clock_timestamp(),
                                nm_usuario_p,
                                cd_pessoa_fisica_p,
								cd_profissional_w,
                                dt_liberacao_w,
                                nm_usuario_liberacao_w,
                                clock_timestamp(),
                                'A',
								c01_w.IE_PFLEGEGRAD,
								nr_atendimento_p,
								nr_seq_hist_saude_w,
								nr_seq_atend_cons_pepa_p);
						
						if (ie_liberar_p = 'S') then
							CALL lancar_proced_pflegegrad(nr_atendimento_p, null, c01_w.IE_PFLEGEGRAD, nm_usuario_p, dt_liberacao_w, c01_w.NR_SEQUENCIA, null, null);
						end if;
								
				elsif (nm_tabela_p	= 'HISTORICO_SAUDE_TRATAMENTO') then
				
					select nextval('historico_saude_tratamento_seq')
					into STRICT   nr_sequencia_w
					;

					nr_proj_assinatura_w := 51490;
                    nr_seq_visao_w := 29781;

					insert into historico_saude_tratamento(
						nr_Sequencia,
						dt_atualizacao,
						nm_usuario,
						dt_atualizacao_nrec,
						cd_pessoa_fisica,
						cd_profissional,
						dt_liberacao,
						nm_usuario_liberacao,
						dt_registro,
						ie_situacao,
						nr_seq_tipo_tratamento,
						nr_seq_hist_rotina,
						nr_seq_atend_cons_pepa)
					values (
						nr_sequencia_w,
						clock_timestamp(),
						nm_usuario_p,
						clock_timestamp(),
						cd_pessoa_fisica_p,
						cd_profissional_w,
						dt_liberacao_w,
						nm_usuario_liberacao_w,
						clock_timestamp(),
						'A',
						c01_w.nr_seq_tratamento,
						nr_seq_hist_saude_w,
						nr_seq_atend_cons_pepa_p);
						
				elsif (nm_tabela_p = 'HISTORICO_SAUDE_INTERNACAO') then
										
					select nextval('historico_saude_internacao_seq')
					into STRICT nr_sequencia_w
					;

					nr_proj_assinatura_w := 51488;
                    nr_seq_visao_w := 29780;

					insert into historico_saude_internacao(
						nr_sequencia,
						dt_atualizacao,
						nm_usuario,
						dt_atualizacao_nrec,
						nm_usuario_nrec,
						cd_pessoa_fisica,
						cd_profissional,
						dt_liberacao,
						nm_usuario_liberacao,
						dt_registro,
						ie_situacao,
						ie_nega_internacao,
						ds_intercorrencia,
						ds_motivo_internacao,
						nr_seq_atend_cons_pepa)
					values (
						nr_sequencia_w,
						clock_timestamp(),
						nm_usuario_p,
						clock_timestamp(),
						nm_usuario_p,
						cd_pessoa_fisica_p,
						cd_profissional_w,
						dt_liberacao_w,
						nm_usuario_liberacao_w,
						clock_timestamp(),
						'A',
						'N',
						c01_w.ds_intercorrencia,
						c01_w.ds_motivo_internacao,
						nr_seq_atend_cons_pepa_p);
									

				elsif (nm_tabela_p = 'HISTORICO_SAUDE_MULHER') then
				
					select nextval('historico_saude_mulher_seq')
					into STRICT nr_sequencia_w
					;

					nr_proj_assinatura_w := 51501;
					nr_seq_visao_w := 29793;

					insert into historico_saude_mulher(
						nr_sequencia,
						dt_atualizacao,
						nm_usuario,
						dt_atualizacao_nrec,
						nm_usuario_nrec,
						cd_pessoa_fisica,
						cd_profissional,
						dt_liberacao,
						nm_usuario_liberacao,
						dt_registro,
						ie_situacao,
						qt_nasc_mortos,
						nr_seq_atend_cons_pepa
						)
					values (
						nr_sequencia_w,
						clock_timestamp(),
						nm_usuario_p,
						clock_timestamp(),
						nm_usuario_p,
						cd_pessoa_fisica_p,
						cd_profissional_w,
						dt_liberacao_w,
						nm_usuario_liberacao_w,
						clock_timestamp(),
						'A',
						0,
						nr_seq_atend_cons_pepa_p);
						
				elsif (nm_tabela_p = 'PACIENTE_ANTEC_SEXUAIS') then	

					nr_proj_assinatura_w := 53673;
					nr_seq_visao_w := 100986;

					select nextval('paciente_antec_sexuais_seq')
					into STRICT nr_sequencia_w
					;
					
					insert into paciente_antec_sexuais(
						nr_sequencia,
						nr_atendimento,
						dt_atualizacao,
						nm_usuario,
						dt_atualizacao_nrec,
						nm_usuario_nrec,
						cd_pessoa_fisica,
						cd_profissional,
						dt_liberacao,
						dt_registro,
						ie_situacao,
						ie_fertilidade,
						nr_seq_atend_cons_pepa
						)
					values (
						nr_sequencia_w,
						nr_atendimento_p,
						clock_timestamp(),
						nm_usuario_p,
						clock_timestamp(),
						nm_usuario_p,
						cd_pessoa_fisica_p,
						cd_profissional_w,
						dt_liberacao_w,
						clock_timestamp(),
						'A',
						c01_w.ie_fertilidade,
						nr_seq_atend_cons_pepa_p);
				
                end if;
	
				select  coalesce(max(ie_assinatura), 'N')
				into STRICT    ie_should_sign_w
				from    tasy_proj_assin_perfil
				where   nr_seq_proj = nr_proj_assinatura_w
				and     coalesce(cd_perfil,obter_perfil_ativo) = obter_perfil_ativo;

				if ((ie_should_sign_w IS NOT NULL AND ie_should_sign_w::text <> '') and ie_should_sign_w <> 'N' and ie_liberar_p = 'S') then
					CALL perform_record_signature(nr_atendimento_p,
						cd_pessoa_fisica_p,
						nm_usuario_p,
						nr_proj_assinatura_w,
						nm_tabela_p,
						nr_sequencia_w,
						nr_seq_visao_w,
						obter_funcao_ativa,
						'L');
				end if;

                open c02;
                loop
                fetch c02 into
                        c02_w;
                EXIT WHEN NOT FOUND; /* apply on c02 */
                        begin
                        ds_comando_w	:= ' update '||c02_w.nm_tabela||' ';
                        if (c02_w.ie_tipo_campo	= 'D') then
                                ds_comando_w	:= ds_comando_w|| ' set '||c02_w.nm_atributo ||' = :dt_parametro ';
                        else
                                ds_comando_w	:= ds_comando_w|| ' set '||c02_w.nm_atributo ||' = :cd_parametro ';
                        end if;
                        ds_comando_w	:= ds_comando_w|| ' where nr_sequencia = :nr_sequencia ';

                        if (c02_w.ie_tipo_campo	= 'N') then
                                vl_campo_w	:= c02_w.nr_inf_adic;
                        elsif (c02_w.ie_tipo_campo	= 'D') then
                                vl_campo_w	:= to_char(c02_w.dt_inf_adic,'dd/mm/yyyy hh24:mi:ss');
                        elsif (c02_w.ie_tipo_campo	= 'A') then
                                vl_campo_w	:= c02_w.ds_inf_adic;
                        end if;

                        
                        if (c02_w.ie_tipo_campo	= 'D') then
                                ds_parametro_w	:= 'nr_sequencia='||nr_sequencia_w||'#@#@'||'dt_parametro='||vl_campo_w||'#@#@';
                        else
                                ds_parametro_w	:= 'nr_sequencia='||nr_sequencia_w||'#@#@'||'cd_parametro='||vl_campo_w||'#@#@';
                        end if;

                        if (vl_campo_w IS NOT NULL AND vl_campo_w::text <> '') then
                                CALL exec_sql_dinamico_bv('TASY', ds_comando_w,ds_parametro_w);
                        end if;
                        end;
                end loop;
                close c02;

                end;
        end loop;
        close c01;
		
		
	if (nm_tabela_p	= 'PACIENTE_ANTEC_CLINICO') and (dt_liberacao_w IS NOT NULL AND dt_liberacao_w::text <> '')  and (nr_sequencia_w IS NOT NULL AND nr_sequencia_w::text <> '') then
		
		select	coalesce(max(ie_paciente),'S'),
				max(cd_doenca)
		into STRICT	ie_paciente_w,
				cd_doenca_w
		from	PACIENTE_ANTEC_CLINICO
		where	nr_sequencia = nr_sequencia_w;
		
		if (cd_doenca_w IS NOT NULL AND cd_doenca_w::text <> '') and (ie_paciente_w	= 'S') then
		
			CALL GERAR_PACIENTE_GRUPO(cd_doenca_w,cd_pessoa_fisica_p,nm_usuario_p);
		
		end if;
	end if;

exception
        when others then
        ds_erro_p       := substr(sqlerrm(SQLSTATE),1,255);
end;

commit;

nr_seq_registro_p := nr_sequencia_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gravar_historico_saude ( nm_tabela_p text, nr_sequencia_p bigint, cd_pessoa_fisica_p text, ie_liberar_p text, nr_atendimento_p bigint, nr_seq_reg_elemento_p bigint, nm_usuario_p text, nr_seq_registro_p INOUT bigint, ds_erro_p INOUT text, nr_seq_triagem_p bigint default 0, nr_seq_atend_cons_pepa_p bigint default null) FROM PUBLIC;

