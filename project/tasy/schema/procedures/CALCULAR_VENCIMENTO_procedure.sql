-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE calcular_vencimento ( cd_estabelecimento_p bigint, cd_condicao_pagamento_p bigint, dt_base_p timestamp, qt_vencimentos_p INOUT bigint, ds_vencimentos_p INOUT text) AS $body$
DECLARE


ie_forma_pagamento_w		smallint	:= 0;
nr_parcela_w			smallint	:= 0;
nr_ult_parcela_w		smallint	:= 0;
qt_dias_parcela_w		integer	:= 0;
tx_fracao_parcela_w		double precision	:= 0;
tx_acrescimo_w			double precision	:= 0;
dt_base_w        		timestamp		:= clock_timestamp();
dia_semana_w			smallint	:= 0;
dia_mes_w			smallint	:= 0;
dt_parcela_w     		timestamp		:= clock_timestamp();
dt_feriado_w     		timestamp		:= clock_timestamp();
ds_vencimentos_w		varchar(2000);
qt_vencimentos_w		integer;
ie_acao_nao_util_w		varchar(1);
ie_corrido_util_w		varchar(1);

qt_dias_uteis_w			integer;
qt_dias_w			integer;
ie_dia_semana_w			varchar(2);
qt_feriado_w			bigint;
qt_parcela_aux_w		bigint;

ds_dias_fixos_w			condicao_pagamento.ds_dias_fixos%type;
ds_dias_fixos_aux_w		condicao_pagamento.ds_dias_fixos%type;
ds_dia_w			condicao_pagamento.ds_dias_fixos%type;
dt_regra_w			timestamp;
ds_parcelas_w			varchar(2000);

c01 CURSOR FOR
	SELECT	nr_parcela,
		qt_dias_parcela,
		tx_fracao_parcela,
		coalesce(tx_acrescimo,0),
		coalesce(ie_corrido_util,'C')
	from	parcela
	where	cd_condicao_pagamento = cd_condicao_pagamento_p
	order by nr_parcela;


BEGIN

dt_base_w		:= dt_base_p;
ds_vencimentos_w	:= '';
qt_vencimentos_w	:= 0;

select	ie_forma_pagamento,
	ie_acao_nao_util,
	ds_dias_fixos
into STRICT	ie_forma_pagamento_w,
	ie_acao_nao_util_w,
	ds_dias_fixos_w
from	condicao_pagamento
where	cd_condicao_pagamento = cd_condicao_pagamento_p;

select 	max(nr_parcela)
into STRICT 	nr_ult_parcela_w
from	parcela
where	cd_condicao_pagamento = cd_condicao_pagamento_p;

/* A vista */

if (ie_forma_pagamento_w = 1) then
	ds_vencimentos_w		:= To_char(dt_base_p,'dd/mm/yyyy');
	qt_vencimentos_w		:= 1;
end if;

/* (Fora Semana) */

if (ie_forma_pagamento_w = 3) then
     	dia_semana_w := pkg_date_utils.get_WeekDay(dt_base_w);
        dt_base_w := dt_base_w + (8 - dia_semana_w);
end if;

/* (Fora Dezena) */

if (ie_forma_pagamento_w = 4) then
	begin
	dia_mes_w := (to_char(dt_base_w,'dd'))::numeric;

	if (dia_mes_w <= 10) then
		dt_base_w := to_date('10/'||to_char(dt_base_w,'mm/yyyy'),'dd/mm/yyyy');
	else
		if (dia_mes_w <= 20) then
			dt_base_w := to_date('20/'||to_char(dt_base_w,'mm/yyyy'),'dd/mm/yyyy');
		else
        		dt_base_w := (to_date('01/'||to_char(PKG_DATE_UTILS.ADD_MONTH(dt_base_w, 1, 0),'mm/yyyy'),'dd/mm/yyyy') -1);
		end if;
	end if;
	end;
end if;

/*  (Fora Quinzena) */

if (ie_forma_pagamento_w = 5) then
	begin
	dia_mes_w := (to_char(dt_base_w,'dd'))::numeric;
	if (dia_mes_w <= 15) then
		dt_base_w := to_date('15/'||to_char(dt_base_w,'mm/yyyy'),'dd/mm/yyyy');
	else
		dt_base_w := (to_date('01/'||to_char(PKG_DATE_UTILS.ADD_MONTH(dt_base_w, 1, 0),'mm/yyyy'),'dd/mm/yyyy') -1);
	end if;
	end;
end if;

/* (Fora Mes) */

if (ie_forma_pagamento_w = 6) then
	dt_base_w := to_date('01/'||to_char(PKG_DATE_UTILS.ADD_MONTH(dt_base_w, 1, 0),'mm/yyyy'),'dd/mm/yyyy');
end if;

/* (Quinzenal - Fora semana) */

if (ie_forma_pagamento_w = 8) then
	dia_mes_w := (to_char(dt_base_w,'dd'))::numeric;
	if  	dia_mes_w <= 15 then	-- Edgar 03/02/2005, OS 14820, mudei para considerar o dia 15 como da 1a quinzena
		dt_base_w := to_date('15/'||to_char(dt_base_w,'mm/yyyy'),'dd/mm/yyyy');
	else
		dt_base_w := ESTABLISHMENT_TIMEZONE_UTILS.endOfMonth(dt_base_w);
	end if;
     	dia_semana_w := pkg_date_utils.get_WeekDay(dt_base_w);
        dt_base_w := dt_base_w + (8 - dia_semana_w);
end if;

/*  (a prazo) */

if (ie_forma_pagamento_w > 1) then
	begin
	open  c01;
	loop
		fetch c01 into 
			nr_parcela_w,
			qt_dias_parcela_w,
			tx_fracao_parcela_w,
			tx_acrescimo_w,
			ie_corrido_util_w;
	      	EXIT WHEN NOT FOUND; /* apply on c01 */
		begin

		select	obter_data_vencimento(	dt_base_w,
						qt_dias_parcela_w,
						cd_estabelecimento_p,
						ie_corrido_util_w,
						ie_acao_nao_util_w)
		into STRICT	dt_parcela_w
		;

		/* (Ultimo dia do mes) */

		if (ie_forma_pagamento_w = 11) then
			dt_parcela_w := ESTABLISHMENT_TIMEZONE_UTILS.endOfMonth(PKG_DATE_UTILS.ADD_MONTH(dt_base_w,nr_parcela_w-1, 0));

			if (ie_corrido_util_w = 'U') then
				dt_parcela_w := obter_dia_anterior_util(cd_estabelecimento_p,dt_parcela_w);
			end if;

		end if;
		
		if (ie_forma_pagamento_w = 14) then
			dt_parcela_w := (ESTABLISHMENT_TIMEZONE_UTILS.endOfMonth(PKG_DATE_UTILS.ADD_MONTH(dt_base_w,nr_parcela_w-1, 0))-1);
			
			if (ie_corrido_util_w = 'U') then
				dt_parcela_w := obter_dia_anterior_util(cd_estabelecimento_p,dt_parcela_w);
			end if;
			
		end if;

		ds_vencimentos_w	:= ds_vencimentos_w ||
					to_char(dt_parcela_w, 'dd/mm/yyyy') || ' ';
		qt_vencimentos_w	:= qt_vencimentos_w + 1;
		end;
	end loop;
	close c01;
	end;
end if;


/* Elemar - 16/07/2004 */

if (ie_forma_pagamento_w = 7) and (qt_vencimentos_w = 1) then

	if ((substr(to_char(dt_base_w, 'dd/mm/yyyy'),1,2))::numeric  < QT_DIAS_PARCELA_W) then
		ds_vencimentos_w := to_char(lpad(QT_DIAS_PARCELA_W, 2, '0')) ||'/'||to_char(dt_base_w,'mm/yyyy');
	else
		ds_vencimentos_w := to_char(lpad(QT_DIAS_PARCELA_W, 2, '0')) ||'/'||to_char(PKG_DATE_UTILS.ADD_MONTH(dt_base_w, 1, 0),'mm/yyyy');
	end if;

	/*Francisco - OS 139276 - 07/05/2009 - Tratar dias uteis */

	select	max(ie_corrido_util)
	into STRICT	ie_corrido_util_w
	from	parcela
	where	cd_condicao_pagamento	= cd_condicao_pagamento_p;

	if (ie_corrido_util_w = 'U') then
		qt_dias_uteis_w	:= 0;
		qt_dias_w	:= 0;
		while(qt_dias_uteis_w < qt_dias_parcela_w) loop
			if (obter_proximo_dia_util(cd_estabelecimento_p, ESTABLISHMENT_TIMEZONE_UTILS.startOfMonth(dt_base_w) + qt_dias_w) =
				ESTABLISHMENT_TIMEZONE_UTILS.startOfMonth(dt_base_w) + qt_dias_w) then
				qt_dias_uteis_w	:= qt_dias_uteis_w + 1;
			end if;
			qt_dias_w	:= qt_dias_w + 1;
		end loop;
	
		ds_vencimentos_w := to_char(qt_dias_w) ||'/'||to_char(dt_base_w,'mm/yyyy');
	else	/* ahoffelder - OS 292926 - 04/03/2011 - coloquei esse else */
		if (ie_acao_nao_util_w in ('A','P')) then

			dt_parcela_w	:= to_date(ds_vencimentos_w,'dd/mm/yyyy');
			qt_dias_w	:= 0;

			WHILE(qt_dias_w = 0) LOOP
				begin
				select	count(*)
				into STRICT 	qt_feriado_w
				from 	feriado
				where	cd_estabelecimento = cd_estabelecimento_p
				and	dt_feriado         = dt_parcela_w;
				if (qt_feriado_w = 0) and (pkg_date_utils.IS_BUSINESS_DAY(dt_parcela_w) = 1) then
					qt_dias_w	:= qt_dias_w + 1;
				else
					if (ie_acao_nao_util_w = 'P') then
						dt_parcela_w	:= dt_parcela_w + 1;
					else
						dt_parcela_w	:= dt_parcela_w - 1;
					end if;
				end if;
				end;
			END LOOP;

			ds_vencimentos_w	:= to_char(dt_parcela_w, 'dd/mm/yyyy');

		end if;

	end if;
	/* Fim Francisco 07/05/2009 */

	
	select	max(ie_dia_semana)
	into STRICT	ie_dia_semana_w
	from	parcela
	where	cd_condicao_pagamento	= cd_condicao_pagamento_p;
	
	/* Paulo - Tratar pelo dia da semana */

	if (coalesce(ie_dia_semana_w,'0') <> '0') then
		ds_vencimentos_w	:= obter_vencimento_dia_semana(ds_vencimentos_w,ie_dia_semana_w,cd_estabelecimento_p);
	end if;
end if;

/* Marcus - 16/01/2006 (ultimo dia util da quinzena seguinte)*/

if (ie_forma_pagamento_w = 9)  then
	dt_parcela_w		:= ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_base_p);
	if (campo_numerico(to_char(dt_parcela_w,'dd')) <= 15) then
		dt_parcela_w	:= ESTABLISHMENT_TIMEZONE_UTILS.endOfMonth(dt_parcela_w);
	else
		dt_parcela_w	:= PKG_DATE_UTILS.ADD_MONTH(dt_parcela_w,1, 0);
		dt_parcela_w	:= to_date('15/' || to_char(dt_parcela_w,'mm/yyyy'),'dd/mm/yyyy');
	end if;

	select obter_dia_anterior_util(cd_estabelecimento_p, dt_parcela_w)
	into STRICT	dt_parcela_w
	;
	qt_vencimentos_w	:= 1;
	ds_vencimentos_w	:= To_char(dt_parcela_w,'dd/mm/yyyy');
end if;
/* Ultimo dia util da quinzena do mes seguinte Matheus OS 97866*/

if (ie_forma_pagamento_w = 12) then
		dt_parcela_w	:= dt_base_p;
	if ((to_char(dt_parcela_w,'dd'))::numeric  <= 15) then
		dt_parcela_w	:= to_date('15/' || to_char(PKG_DATE_UTILS.ADD_MONTH(dt_parcela_w,1, 0),'mm/yyyy'),'dd/mm/yyyy');
	else
		dt_parcela_w	:= ESTABLISHMENT_TIMEZONE_UTILS.endOfMonth(PKG_DATE_UTILS.ADD_MONTH(dt_parcela_w,1, 0));
	end if;
	ds_vencimentos_w	:= To_char(dt_parcela_w,'dd/mm/yyyy');
end if;

/*Anderson 04/04/2009 - OS135610 - Dia fixo fora mes*/

if (ie_forma_pagamento_w = 13) and (qt_vencimentos_w = 1) then
	begin
		if ((substr(to_char(dt_base_w, 'dd/mm/yyyy'),1,2))::numeric  < QT_DIAS_PARCELA_W) then
			ds_vencimentos_w := to_char(lpad(QT_DIAS_PARCELA_W, 2, '0')) ||'/'||to_char(dt_base_w,'mm/yyyy');
			ds_vencimentos_w := to_char(PKG_DATE_UTILS.ADD_MONTH(to_date(ds_vencimentos_w,'dd/mm/yyyy'), 1, 0),'dd/mm/yyyy');
		else
			ds_vencimentos_w := to_char(lpad(QT_DIAS_PARCELA_W, 2, '0')) ||'/'||to_char(PKG_DATE_UTILS.ADD_MONTH(dt_base_w, 1, 0),'mm/yyyy');
		end if;
	exception when others then
        CALL wheb_mensagem_pck.exibir_mensagem_abort(1059568);
    end;

	/* ds_vencimentos_w := to_char(PKG_DATE_UTILS.ADD_MONTH(ds_vencimentos_w, 1, 0),'dd/mm/yyyy'); ahoffelder - OS 296610 - 15/03/2011 - retirei daqui e coloquei dentro do if acima */



	/*Francisco - OS 139276 - 07/05/2009 - Tratar dias uteis */

	select	max(ie_corrido_util)
	into STRICT	ie_corrido_util_w
	from	parcela
	where	cd_condicao_pagamento	= cd_condicao_pagamento_p;

	if (ie_corrido_util_w = 'U') then

		qt_dias_uteis_w	:= 0;
		qt_dias_w	:= 0;

		while(qt_dias_uteis_w < qt_dias_parcela_w) loop
			if (obter_proximo_dia_util(cd_estabelecimento_p,PKG_DATE_UTILS.ADD_MONTH(ESTABLISHMENT_TIMEZONE_UTILS.startOfMonth(dt_base_w),1, 0) + qt_dias_w) =
				PKG_DATE_UTILS.ADD_MONTH(ESTABLISHMENT_TIMEZONE_UTILS.startOfMonth(dt_base_w),1, 0) + qt_dias_w) then
				qt_dias_uteis_w	:= qt_dias_uteis_w + 1;
			end if;
			qt_dias_w	:= qt_dias_w + 1;
		end loop;
	
		ds_vencimentos_w := to_char(qt_dias_w) ||'/'||to_char(PKG_DATE_UTILS.ADD_MONTH(dt_base_w,1, 0),'mm/yyyy');

	else	/* ahoffelder - OS 296610 - 15/03/2011 - coloquei esse else para desconsiderar os finais de semana */
		if (ie_acao_nao_util_w in ('A','P')) then

			dt_parcela_w	:= to_date(ds_vencimentos_w,'dd/mm/yyyy');
			qt_dias_w	:= 0;

			WHILE(qt_dias_w = 0) LOOP
				begin
				select	count(*)
				into STRICT 	qt_feriado_w
				from 	feriado
				where	cd_estabelecimento = cd_estabelecimento_p
				and	dt_feriado         = dt_parcela_w;
				if (qt_feriado_w = 0) and (pkg_date_utils.IS_BUSINESS_DAY(dt_parcela_w) = 1) then
					qt_dias_w	:= qt_dias_w + 1;
				else
					if (ie_acao_nao_util_w = 'P') then
						dt_parcela_w	:= dt_parcela_w + 1;
					else
						dt_parcela_w	:= dt_parcela_w - 1;
					end if;
				end if;
				end;
			END LOOP;

			ds_vencimentos_w	:= to_char(dt_parcela_w, 'dd/mm/yyyy');

		end if;

	end if;
end if;

if (ie_forma_pagamento_w = 13) and (qt_vencimentos_w > 1) then
	
	begin
	
	dt_parcela_w := dt_base_p;
	qt_parcela_aux_w := 0;
	ds_vencimentos_w := '';
	
	while(qt_parcela_aux_w <> qt_vencimentos_w) loop
	
		begin
			if ((substr(to_char(dt_parcela_w, 'dd/mm/yyyy'),1,2))::numeric  < QT_DIAS_PARCELA_W) then
				dt_parcela_w := to_date(to_char(lpad(QT_DIAS_PARCELA_W, 2, '0')) ||'/'||to_char(dt_parcela_w,'mm/yyyy'),'dd/mm/yyyy');
				dt_parcela_w := PKG_DATE_UTILS.ADD_MONTH(dt_parcela_w, 1, 0);
			else
				dt_parcela_w := to_char(lpad(QT_DIAS_PARCELA_W, 2, '0')) ||'/'||to_char(PKG_DATE_UTILS.ADD_MONTH(dt_parcela_w, 1, 0),'mm/yyyy');
			end if;
		exception when others then
			CALL wheb_mensagem_pck.exibir_mensagem_abort(1059568);
		end;
		
		ds_vencimentos_w	:= ds_vencimentos_w || to_char(obter_proximo_dia_util(cd_estabelecimento_p,dt_parcela_w), 'dd/mm/yyyy') || ' ';
		
		qt_parcela_aux_w := qt_parcela_aux_w + 1;
	
	end loop;
	
	end;
	
end if;

/* ultimo dia util do mes seguinte*/


/*SO-2220426*/

if (ie_forma_pagamento_w = 15) then
	dt_parcela_w	:= ESTABLISHMENT_TIMEZONE_UTILS.endOfMonth(PKG_DATE_UTILS.ADD_MONTH(ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_base_p),1, 0));
	
	select	obter_dia_util_anterior(cd_estabelecimento_p, dt_parcela_w)
	into STRICT	dt_parcela_w
	;
	
	qt_vencimentos_w	:= 1;
	ds_vencimentos_w	:= to_char(dt_parcela_w,'dd/mm/yyyy');
end if;

/* primeiro dia util do segundo mes seguinte*/

if (ie_forma_pagamento_w = 16) then
	/*SO-2220426*/

	dt_parcela_w	:= obter_proximo_dia_util(cd_estabelecimento_p,ESTABLISHMENT_TIMEZONE_UTILS.startOfMonth(PKG_DATE_UTILS.ADD_MONTH(ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_base_p),2, 0)));
	
	qt_vencimentos_w	:= 1;
	ds_vencimentos_w	:= to_char(dt_parcela_w,'dd/mm/yyyy');
end if;

/* segundo dia util do segundo mes seguinte*/

if (ie_forma_pagamento_w = 17) then
	/*SO-2220426*/

	dt_parcela_w	:= obter_proximo_dia_util(cd_estabelecimento_p,ESTABLISHMENT_TIMEZONE_UTILS.startOfMonth(PKG_DATE_UTILS.ADD_MONTH(ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_base_p),2, 0))+ 1);
	
	qt_vencimentos_w	:= 1;
	ds_vencimentos_w	:= to_char(dt_parcela_w,'dd/mm/yyyy');
end if;

/* quinto dia util do segundo mes seguinte*/

if (ie_forma_pagamento_w = 22) then
	/*SO-2220426*/

	dt_parcela_w	:= obter_proximo_dia_util(cd_estabelecimento_p,ESTABLISHMENT_TIMEZONE_UTILS.startOfMonth(PKG_DATE_UTILS.ADD_MONTH(ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_base_p),2, 0))+ 4);
	
	qt_vencimentos_w	:= 1;
	ds_vencimentos_w	:= to_char(dt_parcela_w,'dd/mm/yyyy');
end if;

/* vigesimo dia util do segundo mes seguinte*/

if (ie_forma_pagamento_w = 18) then
	/*SO-2220426*/

	dt_parcela_w	:= obter_dia_util_anterior(cd_estabelecimento_p,ESTABLISHMENT_TIMEZONE_UTILS.startOfMonth(PKG_DATE_UTILS.ADD_MONTH(ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_base_p),2, 0))+ 19);
	
	qt_vencimentos_w	:= 1;
	ds_vencimentos_w	:= to_char(dt_parcela_w,'dd/mm/yyyy');
end if;

/* Dia Fixo Fora 90 Dias */

if (ie_forma_pagamento_w = 19) and (qt_vencimentos_w = 1) then

	ds_vencimentos_w	:= to_char(dt_base_w + 90);

	if ((substr(ds_vencimentos_w,1,2))::numeric  < QT_DIAS_PARCELA_W) then
		ds_vencimentos_w := to_char(lpad(QT_DIAS_PARCELA_W, 2, '0')) ||'/'||to_char(to_date(ds_vencimentos_w),'mm/yyyy');
	else
		ds_vencimentos_w	:= to_char(lpad(QT_DIAS_PARCELA_W, 2, '0')) ||'/'||to_char(PKG_DATE_UTILS.ADD_MONTH(to_date(ds_vencimentos_w),1, 0),'mm/yyyy');
	end if;

	select	coalesce(max(ie_corrido_util),'C')
	into STRICT	ie_corrido_util_w
	from	parcela
	where	cd_condicao_pagamento	= cd_condicao_pagamento_p;

	if (ie_corrido_util_w = 'U') then

		qt_dias_uteis_w	:= 0;
		qt_dias_w	:= 0;

		while(qt_dias_uteis_w < qt_dias_parcela_w) loop
			if (obter_proximo_dia_util(cd_estabelecimento_p,PKG_DATE_UTILS.ADD_MONTH(ESTABLISHMENT_TIMEZONE_UTILS.startOfMonth(dt_base_w),1, 0) + qt_dias_w) =
				PKG_DATE_UTILS.ADD_MONTH(ESTABLISHMENT_TIMEZONE_UTILS.startOfMonth(dt_base_w),1, 0) + qt_dias_w) then
				qt_dias_uteis_w	:= qt_dias_uteis_w + 1;
			end if;
			qt_dias_w	:= qt_dias_w + 1;
		end loop;
	
		ds_vencimentos_w := to_char(qt_dias_w) ||'/'||to_char(PKG_DATE_UTILS.ADD_MONTH(dt_base_w,1, 0),'mm/yyyy');

	else	/* ahoffelder - OS 296610 - 15/03/2011 - coloquei esse else para desconsiderar os finais de semana */
		if (ie_acao_nao_util_w in ('A','P')) then

			dt_parcela_w	:= to_date(ds_vencimentos_w,'dd/mm/yyyy');
			qt_dias_w	:= 0;

			WHILE(qt_dias_w = 0) LOOP
				begin
				select	count(*)
				into STRICT 	qt_feriado_w
				from 	feriado
				where	cd_estabelecimento = cd_estabelecimento_p
				and	dt_feriado         = dt_parcela_w;
				if (qt_feriado_w = 0) and (pkg_date_utils.IS_BUSINESS_DAY(dt_parcela_w) = 1) then
					qt_dias_w	:= qt_dias_w + 1;
				else
					if (ie_acao_nao_util_w = 'P') then
						dt_parcela_w	:= dt_parcela_w + 1;
					else
						dt_parcela_w	:= dt_parcela_w - 1;
					end if;
				end if;
				end;
			END LOOP;

			ds_vencimentos_w	:= to_char(dt_parcela_w, 'dd/mm/yyyy');

		end if;

	end if;
end if;

/* Dia Fixo 2o mes seguinte */

if (ie_forma_pagamento_w = 20) and (qt_vencimentos_w = 1) then

	ds_vencimentos_w	:= to_char(ESTABLISHMENT_TIMEZONE_UTILS.startOfMonth(PKG_DATE_UTILS.ADD_MONTH(dt_base_w,2, 0)));

	ds_vencimentos_w := to_char(lpad(QT_DIAS_PARCELA_W, 2, '0')) ||'/'||to_char(to_date(ds_vencimentos_w),'mm/yyyy');

	select	coalesce(max(ie_corrido_util),'C')
	into STRICT	ie_corrido_util_w
	from	parcela
	where	cd_condicao_pagamento	= cd_condicao_pagamento_p;

	if (ie_corrido_util_w = 'U') then

		qt_dias_uteis_w	:= 0;
		qt_dias_w	:= 0;

		while(qt_dias_uteis_w < qt_dias_parcela_w) loop
			if (obter_proximo_dia_util(cd_estabelecimento_p,PKG_DATE_UTILS.ADD_MONTH(ESTABLISHMENT_TIMEZONE_UTILS.startOfMonth(dt_base_w),2, 0) + qt_dias_w) =
				PKG_DATE_UTILS.ADD_MONTH(ESTABLISHMENT_TIMEZONE_UTILS.startOfMonth(dt_base_w),2, 0) + qt_dias_w) then
				qt_dias_uteis_w	:= qt_dias_uteis_w + 1;
			end if;
			qt_dias_w	:= qt_dias_w + 1;
		end loop;
	
		ds_vencimentos_w := to_char(qt_dias_w) ||'/'||to_char(PKG_DATE_UTILS.ADD_MONTH(dt_base_w,2, 0),'mm/yyyy');

		/* try-except para verificar quando a quantidade de dias passa do possivel no mes*/


		/* Caso passar, pega o ultimo dia util do mes */

		begin
		dt_parcela_w	:= to_date(ds_vencimentos_w,'dd/mm/yyyy');
		exception when others then
			ds_vencimentos_w := '01' ||'/'||to_char(PKG_DATE_UTILS.ADD_MONTH(dt_base_w,2, 0),'mm/yyyy');
			dt_parcela_w	:= ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(ESTABLISHMENT_TIMEZONE_UTILS.endOfMonth(to_date(ds_vencimentos_w,'dd/mm/yyyy')));
			qt_dias_w	:= 0;

			WHILE(qt_dias_w = 0) LOOP
				begin
				select	count(*)
				into STRICT 	qt_feriado_w
				from 	feriado
				where	cd_estabelecimento = cd_estabelecimento_p
				and	dt_feriado         = dt_parcela_w;
				if (qt_feriado_w = 0) and (pkg_date_utils.IS_BUSINESS_DAY(dt_parcela_w) = 1) then
					qt_dias_w	:= qt_dias_w + 1;
				else
					dt_parcela_w	:= dt_parcela_w - 1;
				end if;
				end;
			END LOOP;			
		end;

		ds_vencimentos_w	:= to_char(dt_parcela_w, 'dd/mm/yyyy');

	else	/* ahoffelder - OS 296610 - 15/03/2011 - coloquei esse else para desconsiderar os finais de semana */
		if (ie_acao_nao_util_w in ('A','P')) then

			dt_parcela_w	:= to_date(ds_vencimentos_w,'dd/mm/yyyy');
			qt_dias_w	:= 0;

			WHILE(qt_dias_w = 0) LOOP
				begin
				select	count(*)
				into STRICT 	qt_feriado_w
				from 	feriado
				where	cd_estabelecimento = cd_estabelecimento_p
				and	dt_feriado         = dt_parcela_w;
				if (qt_feriado_w = 0) and (pkg_date_utils.IS_BUSINESS_DAY(dt_parcela_w) = 1) then
					qt_dias_w	:= qt_dias_w + 1;
				else
					if (ie_acao_nao_util_w = 'P') then
						dt_parcela_w	:= dt_parcela_w + 1;
					else
						dt_parcela_w	:= dt_parcela_w - 1;
					end if;
				end if;
				end;
			END LOOP;

			ds_vencimentos_w	:= to_char(dt_parcela_w, 'dd/mm/yyyy');

		end if;

	end if;
end if;

/* Conforme proximo dia fixo */

if (ie_forma_pagamento_w = 23) and ((trim(both ds_dias_fixos_w) IS NOT NULL AND (trim(both ds_dias_fixos_w))::text <> ''))then

	ds_vencimentos_w := coalesce(ds_vencimentos_w,to_char(dt_base_w,'dd/mm/yyyy'));
	
	-- Varrer os vencimentos
	while((trim(both ds_vencimentos_w) IS NOT NULL AND (trim(both ds_vencimentos_w))::text <> '')) loop
		dt_parcela_w		:= pkg_date_utils.add_month(dt_base_w,12,0);
		dt_base_w		:= to_date(substr(ds_vencimentos_w,1,10),'dd/mm/yyyy');
		ds_vencimentos_w	:= substr(ds_vencimentos_w,12,length(ds_vencimentos_w));
		ds_dias_fixos_aux_w	:= trim(both ds_dias_fixos_w)||';';
	
		-- Varrer os dias do campo "Dias fixos"
		while((trim(both ds_dias_fixos_aux_w) IS NOT NULL AND (trim(both ds_dias_fixos_aux_w))::text <> '')) loop
			ds_dia_w := substr(ds_dias_fixos_aux_w,1,position(';' in ds_dias_fixos_aux_w)-1);
			ds_dias_fixos_aux_w := substr(ds_dias_fixos_aux_w,position(';' in ds_dias_fixos_aux_w)+1,255);

			-- Pegou o dia da regra
			if (ds_dia_w IS NOT NULL AND ds_dia_w::text <> '') then
				-- Verifica se e dia valido, senao pega o ultimo dia do mes
				begin
				dt_regra_w := lpad(ds_dia_w,2,'0')||'/'||to_char(dt_base_w,'mm/yyyy');
				exception
				when others then
					dt_regra_w := establishment_timezone_utils.endofmonth(dt_base_w);
				end;
				
				-- Verifica se a data base e maior que a data da regra
				if (dt_base_w > dt_regra_w) then
					dt_regra_w := lpad(ds_dia_w,2,'0')||'/'||to_char(pkg_date_utils.add_month(dt_base_w,1,0),'mm/yyyy');
				end if;
				
				select	coalesce(max(ie_corrido_util),'C')
				into STRICT	ie_corrido_util_w
				from	parcela
				where	cd_condicao_pagamento	= cd_condicao_pagamento_p;
				
				-- Pegar a data conforme dia util
				dt_regra_w := obter_data_vencimento( dt_regra_w, 0, cd_estabelecimento_p, ie_corrido_util_w, ie_acao_nao_util_w);
				
				-- Verifica se a data da regra e a mais proxima a data base e coloca como nova parcela
				if	((dt_regra_w - dt_base_w) <= (dt_parcela_w - dt_base_w)) then
					dt_parcela_w := dt_regra_w;
				end if;
			end if;
		end loop;
		
		ds_parcelas_w := ds_parcelas_w || to_char(dt_parcela_w, 'dd/mm/yyyy') || ' ';
	end loop;
	
	ds_vencimentos_w := ds_parcelas_w;
end if;

ds_vencimentos_p		:= ds_vencimentos_w;
qt_vencimentos_p		:= qt_vencimentos_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE calcular_vencimento ( cd_estabelecimento_p bigint, cd_condicao_pagamento_p bigint, dt_base_p timestamp, qt_vencimentos_p INOUT bigint, ds_vencimentos_p INOUT text) FROM PUBLIC;

