-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE sus_gerar_trat_psiq ( nr_atendimento_p bigint, nr_interno_conta_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint) AS $body$
DECLARE


qt_dias_proced_w	integer;
qt_proced_w		integer;
nr_seq_old_w		bigint;
cd_proc_solic_w		bigint;
ie_forma_apresentacao_w	smallint;
dt_final_w		timestamp;
dt_inicial_w		timestamp;
dt_alta_w		timestamp;
qt_ajuste_w		smallint;


BEGIN

begin
select	dt_inicial,
	dt_final
into STRICT	dt_inicial_w,
	dt_final_w
from	sus_aih
where	nr_atendimento	= nr_atendimento_p
and	nr_sequencia	= (	SELECT	max(nr_sequencia)
				from 	sus_aih
				where	nr_atendimento = nr_atendimento_p);
exception
	when others then
		dt_inicial_w	:= '';
		dt_final_w	:= '';
	end;

select	coalesce(max(dt_alta),'')
into STRICT	dt_alta_w
from	atendimento_paciente
where	nr_atendimento	= nr_atendimento_p;

if (dt_alta_w IS NOT NULL AND dt_alta_w::text <> '') then
	qt_ajuste_w	:= 0;
else
	qt_ajuste_w	:= 1;
end if;

select	coalesce(max(qt_procedimento_solic),0),
	coalesce(max(nr_seq_interno),0),
	coalesce(max(cd_procedimento_solic),0)
into STRICT	qt_proced_w,
	nr_seq_old_w,
	cd_proc_solic_w
from	sus_laudo_paciente
where	nr_atendimento		= nr_atendimento_p
and	nr_interno_conta	= nr_interno_conta_p
and	cd_procedimento_solic	in (63001209,63001594)
and	ie_origem_proced	= 2;

if (cd_proc_solic_w	> 0) and (dt_inicial_w		<> '') and (dt_final_w		<> '') then
	select	ie_forma_apresentacao
	into STRICT	ie_forma_apresentacao_w
	from	procedimento
	where	cd_procedimento		= cd_proc_solic_w
	and	ie_origem_proced	= 2;

	if (ie_forma_apresentacao_w	= 5) then
		qt_dias_proced_w	:=	(dt_final_w - dt_inicial_w) + qt_ajuste_w;
	elsif (ie_forma_apresentacao_w	= 7) then
		select	obter_dias_uteis_periodo(dt_inicial_w, dt_final_w, cd_estabelecimento_p) + qt_ajuste_w
		into STRICT	qt_dias_proced_w
		;
	end if;

	if (nr_seq_old_w > 0) and (qt_proced_w > 0) and (qt_dias_proced_w > 0) then
		update	sus_laudo_paciente
		set 	qt_procedimento_solic	= qt_dias_proced_w,
			nm_usuario		= nm_usuario_p,
			dt_atualizacao		= clock_timestamp()
		where 	nr_seq_interno		= nr_seq_old_w;

		update	procedimento_paciente
		set 	qt_procedimento		= qt_dias_proced_w,
			nm_usuario		= nm_usuario_p,
			dt_atualizacao		= clock_timestamp()
		where	cd_procedimento		= cd_proc_solic_w
		and	nr_atendimento		= nr_atendimento_p
		and	nr_interno_conta	= nr_interno_conta_p;
	end if;
end if;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE sus_gerar_trat_psiq ( nr_atendimento_p bigint, nr_interno_conta_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint) FROM PUBLIC;

