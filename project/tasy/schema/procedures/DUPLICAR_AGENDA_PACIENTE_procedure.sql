-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE duplicar_agenda_paciente (nr_seq_origem_p bigint, nr_seq_destino_p bigint, nm_usuario_p text) AS $body$
DECLARE

 
 
CD_PESSOA_FISICA_w		varchar(10);
DT_AGENDA_w			timestamp;
HR_INICIO_w			timestamp;
CD_MEDICO_w			varchar(10);
NM_PESSOA_CONTATO_w		varchar(50);
CD_CONVENIO_w			integer;
QT_IDADE_PACIENTE_w		smallint;
CD_TIPO_ANESTESIA_w		varchar(02);
IE_STATUS_AGENDA_w		varchar(03);
NM_INSTRUMENTADOR_w		varchar(20);
NM_CIRCULANTE_w			varchar(20);
IE_ORTESE_PROTESE_w		varchar(01);
IE_CDI_w			varchar(01);
IE_UTI_w			varchar(01);
IE_BANCO_SANGUE_w		varchar(01);
IE_SERV_ESPECIAL_w		varchar(01);
CD_ANESTESISTA_w    		varchar(10);
CD_PEDIATRA_w     		varchar(10);
NM_PACIENTE_w     		varchar(60);
IE_ANESTESIA_w			varchar(01);
IE_CARATER_CIRURGIA_w  	varchar(01);
CD_USUARIO_CONVENIO_w  	varchar(30);
CD_PLANO_w        	varchar(10);
IE_LEITO_w        	varchar(01);
NR_TELEFONE_w      	varchar(80);
IE_EQUIPAMENTO_w     	varchar(01);
IE_VIDEO_w        	varchar(01);
NR_SEQ_CLASSIF_AGENDA_w		bigint;
IE_UC_w         	varchar(01);
CD_PROCEDENCIA_w     	integer;	
CD_CATEGORIA_w      	varchar(10);
CD_TIPO_ACOMODACAO_w   	smallint;
NR_DOC_CONVENIO_w    	varchar(20);
DT_VALIDADE_CARTEIRA_w  	timestamp;
cd_procedimento_w		bigint;
ie_origem_proced_w		bigint;
ds_procedimento_w		varchar(255);
ie_copiar_procedimento_w	varchar(05);

cd_proc_w			bigint;
ie_origem_w			bigint;
nr_seq_proc_princ_w		bigint;
ie_lado_proc_w			varchar(01);
nr_seq_procedimento_w		bigint;

ie_gravar_procedimento_w	varchar(1);/* Rafael em 02/09/06 OS39215 */
 
ds_alteracao_w		varchar(2000);/* Rafael em 03/01/2007 OS46794 */
 
c01 CURSOR FOR 
	SELECT	nr_seq_agenda, 
		cd_procedimento, 
		ie_origem_proced, 
		nr_seq_proc_interno, 
		ie_lado 
	from	agenda_paciente_proc 
	where	nr_sequencia		 = nr_seq_origem_p 
	and	ie_copiar_procedimento_w = 'S';


BEGIN 
 
select	coalesce(Obter_Valor_Param_Usuario(39, 82, obter_perfil_ativo, NM_USUARIO_P, 0),'N') 
into STRICT	ie_copiar_procedimento_w
;
 
/* Rafael em 02/09/06 OS39215 */
 
select	coalesce(max(obter_valor_param_usuario(39, 121, obter_perfil_ativo, nm_usuario_p, 0)),'S') 
into STRICT	ie_gravar_procedimento_w
;
 
select	CD_PESSOA_FISICA    , 
	DT_AGENDA       , 
	HR_INICIO       , 
	CD_MEDICO       , 
	NM_PESSOA_CONTATO   , 
	CD_CONVENIO      , 
	QT_IDADE_PACIENTE   , 
	CD_TIPO_ANESTESIA   , 
	IE_STATUS_AGENDA    , 
	NM_INSTRUMENTADOR   , 
	NM_CIRCULANTE     , 
	IE_ORTESE_PROTESE   , 
	IE_CDI         , 
	IE_UTI         , 
	IE_BANCO_SANGUE    , 
	IE_SERV_ESPECIAL    , 
	CD_ANESTESISTA     , 
	CD_PEDIATRA      , 
	NM_PACIENTE      , 
	IE_ANESTESIA      , 
	IE_CARATER_CIRURGIA  , 
	CD_USUARIO_CONVENIO  , 
	CD_PLANO        , 
	IE_LEITO        , 
	NR_TELEFONE      , 
	IE_EQUIPAMENTO     , 
	IE_VIDEO        , 
	NR_SEQ_CLASSIF_AGENDA , 
	IE_UC         , 
	CD_PROCEDENCIA     , 
	CD_CATEGORIA      , 
	CD_TIPO_ACOMODACAO   , 
	NR_DOC_CONVENIO    , 
	DT_VALIDADE_CARTEIRA  , 
	cd_procedimento, 
	ie_origem_proced, 
	substr(obter_descricao_procedimento(cd_procedimento, ie_origem_proced),1,200) 
into STRICT	CD_PESSOA_FISICA_w       , 
	DT_AGENDA_w			, 
	HR_INICIO_w			, 
	CD_MEDICO_w           , 
	NM_PESSOA_CONTATO_w       , 
	CD_CONVENIO_w          , 
	QT_IDADE_PACIENTE_w       , 
	CD_TIPO_ANESTESIA_w       , 
	IE_STATUS_AGENDA_w       , 
	NM_INSTRUMENTADOR_w       , 
	NM_CIRCULANTE_w         , 
	IE_ORTESE_PROTESE_w       , 
	IE_CDI_w			, 
	IE_UTI_w            , 
	IE_BANCO_SANGUE_w        , 
	IE_SERV_ESPECIAL_w       , 
	CD_ANESTESISTA_w        , 
	CD_PEDIATRA_w          , 
	NM_PACIENTE_w          , 
	IE_ANESTESIA_w         , 
	IE_CARATER_CIRURGIA_w  	, 
	CD_USUARIO_CONVENIO_w  	, 
	CD_PLANO_w        	, 
	IE_LEITO_w        	, 
	NR_TELEFONE_w      	, 
	IE_EQUIPAMENTO_w     	, 
	IE_VIDEO_w        	, 
	NR_SEQ_CLASSIF_AGENDA_w		, 
	IE_UC_w         	, 
	CD_PROCEDENCIA_w     	, 
	CD_CATEGORIA_w      	, 
	CD_TIPO_ACOMODACAO_w   	, 
	NR_DOC_CONVENIO_w    	, 
	DT_VALIDADE_CARTEIRA_w, 
	cd_procedimento_w, 
	ie_origem_proced_w, 
	ds_procedimento_w 
from	agenda_paciente 
where	nr_sequencia	= nr_seq_origem_p;
 
if (coalesce(ie_gravar_procedimento_w,'S') = 'N') then 
	cd_procedimento_w	:= null;
	ie_origem_proced_w	:= null;
	ds_procedimento_w	:= null;
end if;
 
update	agenda_paciente 
set	CD_PESSOA_FISICA    = CD_PESSOA_FISICA_w  , 
	CD_MEDICO        = CD_MEDICO_w     , 
	NM_PESSOA_CONTATO    = NM_PESSOA_CONTATO_w , 
	CD_CONVENIO       = CD_CONVENIO_w    , 
	QT_IDADE_PACIENTE    = QT_IDADE_PACIENTE_w , 
	CD_TIPO_ANESTESIA    = CD_TIPO_ANESTESIA_w , 
	IE_STATUS_AGENDA    = 'N'			, 
	NM_INSTRUMENTADOR    = NM_INSTRUMENTADOR_w , 
	NM_CIRCULANTE      = NM_CIRCULANTE_w   , 
	IE_ORTESE_PROTESE    = IE_ORTESE_PROTESE_w , 
	IE_CDI         = IE_CDI_w       , 
	IE_UTI         = IE_UTI_w       , 
	IE_BANCO_SANGUE     = IE_BANCO_SANGUE_w  , 
	IE_SERV_ESPECIAL    = IE_SERV_ESPECIAL_w  , 
	CD_ANESTESISTA     = CD_ANESTESISTA_w   , 
	CD_PEDIATRA       = CD_PEDIATRA_w    , 
	NM_PACIENTE       = NM_PACIENTE_w    , 
	IE_ANESTESIA      = IE_ANESTESIA_w    , 
	ie_carater_cirurgia	= IE_CARATER_CIRURGIA_w , 
	CD_USUARIO_CONVENIO   = CD_USUARIO_CONVENIO_w , 
	CD_PLANO        = CD_PLANO_w      , 
	IE_LEITO        = IE_LEITO_w      , 
	NR_TELEFONE       = NR_TELEFONE_w     , 
	IE_EQUIPAMENTO     = IE_EQUIPAMENTO_w   , 
	IE_VIDEO        = IE_VIDEO_w      , 
	NR_SEQ_CLASSIF_AGENDA  = NR_SEQ_CLASSIF_AGENDA_w , 
	IE_UC          = IE_UC_w         , 
	CD_PROCEDENCIA     = CD_PROCEDENCIA_w    , 
	CD_CATEGORIA      = CD_CATEGORIA_w     , 
	CD_TIPO_ACOMODACAO   = CD_TIPO_ACOMODACAO_w  , 
	NR_DOC_CONVENIO     = NR_DOC_CONVENIO_w    , 
	NM_USUARIO_ORIG		= nm_usuario_p, 
	DT_VALIDADE_CARTEIRA  = DT_VALIDADE_CARTEIRA_w, 
	cd_procedimento		= CASE WHEN ie_copiar_procedimento_w='N' THEN  null  ELSE cd_procedimento_w END , 
	ie_origem_proced	= CASE WHEN ie_copiar_procedimento_w='N' THEN  null  ELSE ie_origem_proced_w END , 
	dt_agendamento		= clock_timestamp(), 
	ds_observacao		= 'Agenda Duplicada. Procedimento : ' || ds_procedimento_w || ' Dia: ' || to_char(hr_inicio_w, 'dd/mm/yyyy 
 
hh24:mi:ss'), 
	dt_atualizacao		= clock_timestamp(), 
	nm_usuario		= nm_usuario_p 
where	nr_sequencia		= nr_seq_destino_p;
 
if (coalesce(ie_gravar_procedimento_w,'S') = 'S') then 
	open	c01;
	loop 
	fetch	c01 into 
		nr_seq_procedimento_w, 
		cd_proc_w, 
		ie_origem_w, 
		nr_seq_proc_princ_w, 
		ie_lado_proc_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
		begin 
 
		insert	into agenda_paciente_proc(nr_sequencia, 
			nr_seq_agenda, 
			dt_atualizacao, 
			nm_usuario, 
			cd_procedimento, 
			ie_origem_proced, 
			nr_seq_proc_interno, 
			ie_lado) 
		values (nr_seq_destino_p, 
			nr_seq_procedimento_w, 
			clock_timestamp(), 
			nm_usuario_p, 
			cd_proc_w, 
			ie_origem_w, 
			nr_seq_proc_princ_w, 
			ie_lado_proc_w);
 
		end;
	end loop;
	close c01;
end if;
 
/* Rafael em 03/01/2007 OS46794 */
 
ds_alteracao_w	:= null;
 
/* obter dados destino */
 
select	obter_desc_expressao(325811)/*' paciente: '*/
		|| coalesce(cd_pessoa_fisica,nm_paciente)	|| 
		obter_desc_expressao(326269)/*' status: '*/
			|| ie_status_agenda						|| 
		obter_desc_expressao(622367)/*' médico: '*/
			|| cd_medico							|| 
		obter_desc_expressao(622226)/*' proced: '*/
			|| to_char(cd_procedimento)				|| 
		obter_desc_expressao(327633)/*' origem: '*/
			|| to_char(ie_origem_proced)			|| 
		obter_desc_expressao(697085)/*' interno: '*/
		|| to_char(nr_seq_proc_interno)											|| 
		obter_desc_expressao(302532)/*' agendamento: '*/
	|| to_char(dt_agendamento,'dd/mm/yyyy hh24:mi:ss')						|| 
		obter_desc_expressao(328225)/*' usuário: '*/
		|| nm_usuario_orig						|| 
		obter_desc_expressao(330345)/*' agenda: '*/
			|| to_char(cd_agenda)					|| 
		obter_desc_expressao(774034)/*' seq destino: '*/
	|| nr_seq_destino_p 
into STRICT	ds_alteracao_w 
from	agenda_paciente 
where	nr_sequencia = nr_seq_destino_p;
 
insert into agenda_historico_acao( 
					nr_sequencia, 
					ie_agenda, 
					cd_agenda, 
					nr_seq_agenda, 
					dt_agenda, 
					ie_acao, 
					dt_acao, 
					ds_acao, 
					ds_alteracao 
					) 
					SELECT	nextval('agenda_historico_acao_seq'), 
						obter_tipo_agenda(cd_agenda), 
						cd_agenda, 
						nr_seq_origem_p, 
						hr_inicio, 
						'C', 
						clock_timestamp(), 
						obter_desc_expressao(325811)/*' paciente: '*/
		|| coalesce(cd_pessoa_fisica,nm_paciente)			|| 
						obter_desc_expressao(326269)/*' status: '*/
		|| ie_status_agenda						|| 
						obter_desc_expressao(622367)/*' médico: '*/
		|| cd_medico							|| 
						obter_desc_expressao(622226)/*' proced: '*/
		|| to_char(cd_procedimento)					|| 
						obter_desc_expressao(327633)/*' origem: '*/
		|| to_char(ie_origem_proced)				|| 
						obter_desc_expressao(697085)/*' interno: '*/
		|| to_char(nr_seq_proc_interno)				|| 
						obter_desc_expressao(302532)/*' agendamento: '*/
	|| to_char(dt_agendamento,'dd/mm/yyyy hh24:mi:ss')	|| 
						obter_desc_expressao(328225)/*' usuário: '*/
		|| nm_usuario_orig, 
						'<duplicar_agenda_paciente> dados da duplicação = ' || ds_alteracao_w 
					from	agenda_paciente 
					where	nr_sequencia = nr_seq_origem_p;
/* Fim alteração Rafael em 03/01/2007 OS46794 */
 
	 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE duplicar_agenda_paciente (nr_seq_origem_p bigint, nr_seq_destino_p bigint, nm_usuario_p text) FROM PUBLIC;

