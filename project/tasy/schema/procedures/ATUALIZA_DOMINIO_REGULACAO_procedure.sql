-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE atualiza_dominio_regulacao ( cd_dominio_p bigint, vl_dominio_p text, ds_valor_dominio_p text) AS $body$
DECLARE


vl_dominio_w		varchar(15) := '';
ds_valor_dominio_w	varchar(255);
qt_registro_w		smallint;
cd_expressao_w		dic_expressao.cd_expressao%type;
cd_exp_valor_dominio_w	dic_expressao.cd_expressao%type;


BEGIN
if (coalesce(cd_dominio_p, 0) > 0) then

	select	count(*)
	into STRICT	qt_registro_w
	from	valor_dominio
	where	cd_dominio = cd_dominio_p
	and	vl_dominio = vl_dominio_p;

	if (qt_registro_w = 0) then

		select	max(cd_expressao)
		into STRICT	cd_expressao_w
		from	dic_expressao
		where	ds_expressao_br = ds_valor_dominio_p;

		if (coalesce(cd_expressao_w::text, '') = '') then
			cd_expressao_w := obter_menor_codigo_expressao;

			insert	into dic_expressao(
				cd_expressao,
				nm_usuario,
				dt_atualizacao,
				ds_expressao_br,
				ds_glossario)
			values (cd_expressao_w,
				'Regulacao',
				clock_timestamp(),
				ds_valor_dominio_p,
				ds_valor_dominio_p);

		end if;

		insert  into valor_dominio(
				cd_dominio,
				vl_dominio,
				ds_valor_dominio,
				dt_atualizacao,
				nm_usuario,
				ie_situacao,
				cd_exp_valor_dominio
		) values (
				cd_dominio_p,
				vl_dominio_p,
				ds_valor_dominio_p,
				clock_timestamp(),
				'Regulacao',
				'A',
				cd_expressao_w
		);

	else
		select	max(ds_valor_dominio),
			max(cd_exp_valor_dominio)
		into STRICT	ds_valor_dominio_w,
			cd_exp_valor_dominio_w
		from	valor_dominio
		where	cd_dominio = cd_dominio_p
		and	vl_dominio = vl_dominio_p;

		if (ds_valor_dominio_p <> ds_valor_dominio_w) then

			if (coalesce(cd_exp_valor_dominio_w::text, '') = '') then
				select	max(cd_expressao)
				into STRICT	cd_expressao_w
				from	dic_expressao
				where	ds_expressao_br = ds_valor_dominio_p;

				if (coalesce(cd_expressao_w::text, '') = '') then
					cd_expressao_w := obter_menor_codigo_expressao;
				end if;
			end if;

			update	valor_dominio
			set	ds_valor_dominio = ds_valor_dominio_p,
				cd_exp_valor_dominio = coalesce(cd_exp_valor_dominio, cd_expressao_w)
			where	cd_dominio = cd_dominio_p
			and	vl_dominio = vl_dominio_p;
		end if;
	end if;

end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE atualiza_dominio_regulacao ( cd_dominio_p bigint, vl_dominio_p text, ds_valor_dominio_p text) FROM PUBLIC;

