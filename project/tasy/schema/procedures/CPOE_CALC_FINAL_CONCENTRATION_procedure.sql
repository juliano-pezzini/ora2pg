-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE cpoe_calc_final_concentration ( cd_material_p cpoe_material.cd_material%type, qt_dose_p cpoe_material.qt_dose%type, cd_unidade_medida_p cpoe_material.cd_unidade_medida%type, cd_mat_dil_p cpoe_material.cd_mat_dil%type, qt_dose_dil_p cpoe_material.qt_dose_dil%type, cd_unidade_medida_dil_p cpoe_material.cd_unid_med_dose_dil%type, cd_mat_red_dil_p cpoe_material.cd_mat_red%type default 0, qt_dose_red_dil_p cpoe_material.qt_dose_red%type default 0, qt_solucao_red_p cpoe_material.qt_solucao_red%type default 0, cd_unid_med_red_dil_p cpoe_material.cd_unid_med_dose_red%type default null, cd_mat_recons_p cpoe_material.cd_mat_recons%type default 0, qt_dose_recons_p cpoe_material.qt_dose_recons%type default 0, cd_unid_med_recons_p cpoe_material.cd_unid_med_dose_recons%type default null, qt_final_concentration_out_p INOUT cpoe_material.qt_final_concentration%type DEFAULT NULL, cd_unidade_med_concent_out_p INOUT cpoe_material.cd_unidade_medida%type  DEFAULT NULL) AS $body$
DECLARE


qt_dose_ml_w                cpoe_material.qt_dose%type;
qt_dose_dil_ml_w            cpoe_material.qt_dose_dil%type;
qt_dose_red_dil_ml_w        cpoe_material.qt_dose_red%type := 0;
qt_dose_recons_ml_w         cpoe_material.qt_dose_recons%type := 0;

qt_conversao_ml_p           cpoe_material.qt_dose%type;
qt_dose_total_fixo_p        cpoe_material.qt_dose%type;
qt_conversao_dil_ml_p       cpoe_material.qt_dose%type;
qt_dose_convert_concent_w   cpoe_material.qt_dose%type;
cd_unidade_medida_ml_w      cpoe_material.cd_unidade_medida%type;

qt_vol_total_sem_dil_w      cpoe_material.qt_dose%type;

temp_var                    cpoe_material.qt_dose_red%type;

-- Medical device
sql_w varchar(700);
qt_dose_total_fixo_w		bigint;


BEGIN

    select	min(a.cd_unidade_medida)
    into STRICT	cd_unidade_med_concent_out_p
    from	material_conversao_unidade a,
        unidade_medida b
    where	a.cd_material = cd_material_p
    and	a.cd_unidade_medida = cd_unidade_medida_p
    and	a.cd_unidade_medida = b.cd_unidade_medida
    and	b.ie_unidade_med_inter in ('mg', 'MCG', 'UI')
    order by a.ie_prioridade;

if (coalesce(cd_unidade_med_concent_out_p::text, '') = '') then
	begin
        SELECT MIN(t.unid_med)
        into STRICT cd_unidade_med_concent_out_p
        FROM (
            SELECT a.cd_unidade_medida unid_med
            FROM unidade_medida a, material_conversao_unidade b
            WHERE UPPER(a.ie_unidade_med_inter) IN ('MG', 'MCG', 'UI')
            AND a.ie_situacao = 'A'
            AND UPPER(b.cd_unidade_medida) = UPPER(a.cd_unidade_medida)
            AND b.cd_material = cd_material_p
            ORDER BY CASE WHEN UPPER(a.cd_unidade_medida)='MG' THEN  1 WHEN UPPER(a.cd_unidade_medida)='MCG' THEN  2 WHEN UPPER(a.cd_unidade_medida)='UI' THEN  3  ELSE 4 END
        ) t LIMIT 1;
    exception
      when others then
         cd_unidade_med_concent_out_p := NULL;
    end;
end if;

    cd_unidade_medida_ml_w := obter_unid_med_usua('ml');
    qt_dose_ml_w := obter_dose_convertida(cd_material_p, qt_dose_p, cd_unidade_medida_p, cd_unidade_medida_ml_w);
	qt_dose_dil_ml_w := obter_dose_convertida(cd_mat_dil_p, qt_dose_dil_p, cd_unidade_medida_dil_p, cd_unidade_medida_ml_w);

    if (cd_mat_red_dil_p > 0) then
        temp_var := qt_dose_dil_p;
        if (qt_solucao_red_p > 0) then
            temp_var := qt_solucao_red_p;
            qt_dose_ml_w := 0;
        end if;
        qt_dose_dil_ml_w := obter_dose_convertida(cd_mat_red_dil_p, temp_var, cd_unid_med_red_dil_p, cd_unidade_medida_ml_w);
        qt_dose_red_dil_ml_w := obter_dose_convertida(cd_mat_red_dil_p, qt_dose_red_dil_p, cd_unid_med_red_dil_p, cd_unidade_medida_ml_w);
    end if;

    qt_dose_convert_concent_w := obter_dose_convertida(cd_material_p, qt_dose_p, cd_unidade_medida_p, cd_unidade_med_concent_out_p);
    qt_vol_total_sem_dil_w := qt_dose_ml_w + qt_dose_red_dil_ml_w + qt_dose_dil_ml_w;

    -- Medical device - qt_concent_final_out
    BEGIN
        sql_w := 'CALL calcular_concent_final_md(:1, :2, :3, :4, :5) INTO :qt_final_concentration_out_p';
        EXECUTE sql_w USING   IN qt_dose_convert_concent_w,
                                        IN 0,
                                        IN 0,
                                        IN qt_vol_total_sem_dil_w,
                                        IN 1,
                                        OUT qt_final_concentration_out_p;
        exception when others then qt_final_concentration_out_p := null;
    END;
    -- End of Medical device - qt_concent_final_out
    cd_unidade_med_concent_out_p := upper( cd_unidade_med_concent_out_p || 'ml' );

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cpoe_calc_final_concentration ( cd_material_p cpoe_material.cd_material%type, qt_dose_p cpoe_material.qt_dose%type, cd_unidade_medida_p cpoe_material.cd_unidade_medida%type, cd_mat_dil_p cpoe_material.cd_mat_dil%type, qt_dose_dil_p cpoe_material.qt_dose_dil%type, cd_unidade_medida_dil_p cpoe_material.cd_unid_med_dose_dil%type, cd_mat_red_dil_p cpoe_material.cd_mat_red%type default 0, qt_dose_red_dil_p cpoe_material.qt_dose_red%type default 0, qt_solucao_red_p cpoe_material.qt_solucao_red%type default 0, cd_unid_med_red_dil_p cpoe_material.cd_unid_med_dose_red%type default null, cd_mat_recons_p cpoe_material.cd_mat_recons%type default 0, qt_dose_recons_p cpoe_material.qt_dose_recons%type default 0, cd_unid_med_recons_p cpoe_material.cd_unid_med_dose_recons%type default null, qt_final_concentration_out_p INOUT cpoe_material.qt_final_concentration%type DEFAULT NULL, cd_unidade_med_concent_out_p INOUT cpoe_material.cd_unidade_medida%type  DEFAULT NULL) FROM PUBLIC;

