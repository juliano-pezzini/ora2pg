-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_w_grupo_receita (cd_estabelecimento_p bigint, dt_inicial_p timestamp, dt_final_p timestamp, ie_tipo_convenio_p text, nm_usuario_p text, ie_opcao_p bigint, ie_particular_p text) AS $body$
DECLARE

 
nr_seq_grupo_rec_w 		bigint;
nr_seq_grupo_rec_ant_w		bigint := 0;
cd_setor_atendimento_w		integer;
cd_convenio_w			integer;
qt_registro_w			bigint;
vl_item_w			double precision;
vl_glosado_w			double precision;
vl_pendente_w			double precision;
vl_repasse_w			double precision;
vl_liquido_w			double precision;
vl_recurso_w			double precision;

c03 CURSOR FOR 
	SELECT	cd_grupo_receita, 
		cd_convenio, 
		cd_setor_atendimento, 
		coalesce(sum(x.vl_item),0) vl_item, 
		coalesce(sum(x.vl_glosado),0) vl_glosado, 
		coalesce(sum(x.vl_repasse),0) vl_repasse, 
		coalesce(sum(x.vl_liquido),0) vl_liquido, 
		coalesce(sum(x.vl_pendente),0) vl_pendente, 
		coalesce(sum(x.vl_recurso),0) vl_recurso 
	from( 
	/* Convenio */
 
	SELECT	obter_grupo_receita(b.cd_estabelecimento,NULL,a.cd_procedimento, a.ie_origem_proced, b.ie_tipo_atendimento, 
									a.cd_setor_atendimento) cd_grupo_receita, 
		f.cd_convenio, 
		a.cd_setor_atendimento, 
		coalesce(obter_valor_amenor_ult_ret(f.nr_sequencia,dt_inicial_p, dt_final_p, i.nr_interno_conta, a.nr_sequencia, null, 
			0),vl_procedimento) vl_item, 
		Obter_Glosa_item_periodo(a.nr_sequencia,null,dt_inicial_p,dt_final_p,1) vl_glosado, 
		OBTER_VALOR_REPASSE_ITEM_PER(a.nr_sequencia,'PL',dt_inicial_p,dt_final_p) vl_repasse, 
		coalesce(obter_valor_amenor_ult_ret(f.nr_sequencia,dt_inicial_p, dt_final_p, i.nr_interno_conta, a.nr_sequencia, null, 
		0),vl_procedimento) - Obter_Glosa_item_periodo(a.nr_sequencia,null,dt_inicial_p,dt_final_p,3) - 
		OBTER_VALOR_REPASSE_ITEM_PER(a.nr_sequencia,'PL',dt_inicial_p,dt_final_p) vl_liquido, 
		Obter_Glosa_item_periodo(a.nr_sequencia,null,dt_inicial_p,dt_final_p,3) - 
			Obter_Glosa_item_periodo(a.nr_sequencia,null,dt_inicial_p,dt_final_p,1) vl_pendente, 
		Obter_Glosa_item_periodo(a.nr_sequencia,null,dt_inicial_p,dt_final_p,4) vl_recurso 
	from 	procedimento_paciente a, 
		atendimento_paciente b, 
		conta_paciente h, 
		convenio_retorno_item i, 
		convenio_retorno f, 
		convenio g 
	where 	f.nr_sequencia		= i.nr_seq_retorno 
	and	h.nr_interno_conta		= i.nr_interno_conta 
	and	h.nr_atendimento		= b.nr_atendimento 
	and	a.nr_atendimento		= b.nr_atendimento 
	and	a.nr_interno_conta		= h.nr_interno_conta 
	and	h.nr_atendimento		= b.nr_atendimento 
	and	g.cd_convenio			= f.cd_convenio 
	and	g.ie_tipo_convenio		<> 3 
	and	obter_tipo_convenio(f.cd_convenio) = coalesce(IE_TIPO_CONVENIO_P,obter_tipo_convenio(f.cd_convenio)) 
	and	f.dt_retorno 		between dt_inicial_p and fim_dia(dt_final_p) 
	and	f.cd_estabelecimento	= cd_estabelecimento_p 
	and	coalesce(a.cd_motivo_exc_conta::text, '') = '' 
	and (coalesce(ie_particular_p,'N') = 'N' or ie_particular_p = 'T') 
	group by 
		coalesce(obter_valor_amenor_ult_ret(f.nr_sequencia,dt_inicial_p, dt_final_p, i.nr_interno_conta, a.nr_sequencia, null, 
			0),vl_procedimento), 
		a.vl_procedimento, 
		a.nr_sequencia, 
		obter_grupo_receita(b.cd_estabelecimento,NULL,a.cd_procedimento, a.ie_origem_proced, b.ie_tipo_atendimento, 
									a.cd_setor_atendimento), 
		f.cd_convenio, 
		a.cd_setor_atendimento 
	
union all
 
	select	obter_grupo_receita(b.cd_estabelecimento,a.cd_material,NULL, NULL, b.ie_tipo_atendimento, 					 
									a.cd_setor_atendimento) CD_GRUPO_RECEITA, 
		f.cd_convenio, 
		a.cd_setor_atendimento, 
		coalesce(obter_valor_amenor_ult_ret(f.nr_sequencia,dt_inicial_p, dt_final_p, i.nr_interno_conta, null, a.nr_sequencia, 0),vl_material) vl_item, 
		Obter_Glosa_item_periodo(null,a.nr_sequencia,dt_inicial_p,dt_final_p,1) vl_glosado, 
		OBTER_VALOR_REPASSE_ITEM_PER(a.nr_sequencia,'ML',dt_inicial_p,dt_final_p) vl_repasse, 
		coalesce(obter_valor_amenor_ult_ret(f.nr_sequencia,dt_inicial_p, dt_final_p, i.nr_interno_conta, null, a.nr_sequencia, 0),vl_material) - 
		Obter_Glosa_item_periodo(null,a.nr_sequencia,dt_inicial_p,dt_final_p,3) - 
			OBTER_VALOR_REPASSE_ITEM_PER(a.nr_sequencia,'ML',dt_inicial_p,dt_final_p) vl_liquido, 
		Obter_Glosa_item_periodo(null,a.nr_sequencia,dt_inicial_p,dt_final_p,3) - 
			Obter_Glosa_item_periodo(null,a.nr_sequencia,dt_inicial_p,dt_final_p,1) vl_pendente, 
		Obter_Glosa_item_periodo(null,a.nr_sequencia,dt_inicial_p,dt_final_p,4) vl_recurso 
	from 	material_atend_paciente a, 
		atendimento_paciente b, 
		conta_paciente h, 
		convenio_retorno_item i, 
		convenio_retorno f 
	where 	f.nr_sequencia		= i.nr_seq_retorno 
	and	h.nr_interno_conta		= i.nr_interno_conta 
	and	b.nr_atendimento   	= a.nr_atendimento 
	and	h.nr_atendimento		= b.nr_atendimento 
	and	a.nr_interno_conta		= h.nr_interno_conta 
	and	h.nr_atendimento		= b.nr_atendimento 
	and	obter_tipo_convenio(f.cd_convenio) = coalesce(IE_TIPO_CONVENIO_P,obter_tipo_convenio(f.cd_convenio)) 
	and	f.dt_retorno between dt_inicial_p and fim_dia(dt_final_p) 
	and	f.cd_estabelecimento		= cd_estabelecimento_p 
	and	coalesce(a.cd_motivo_exc_conta::text, '') = '' 
	and (coalesce(ie_particular_p,'N') = 'N' or ie_particular_p = 'T') 
	group by 
		obter_grupo_receita(b.cd_estabelecimento,a.cd_material,NULL, NULL, b.ie_tipo_atendimento, 					 
									a.cd_setor_atendimento), 
		coalesce(obter_valor_amenor_ult_ret(f.nr_sequencia,dt_inicial_p, dt_final_p, i.nr_interno_conta, null, a.nr_sequencia, 0),vl_material), 
		a.vl_material, 
		a.nr_sequencia, 
		f.cd_convenio, 
		a.cd_setor_atendimento 
	
union all
 
	/* Particular Com Repasse */
 
	select	obter_grupo_receita(b.cd_estabelecimento,NULL,a.cd_procedimento, a.ie_origem_proced, b.ie_tipo_atendimento, 
									a.cd_setor_atendimento) cd_grupo_receita, 
		h.cd_convenio_parametro, 
		a.cd_setor_atendimento, 
		to_char(a.vl_procedimento) vl_item, 
		0 vl_glosado, 
		OBTER_VALOR_REPASSE_ITEM_PER(a.nr_sequencia,'PL',dt_inicial_p,dt_final_p) vl_repasse, 
		CASE WHEN OBTER_VALOR_REPASSE_ITEM_PER(a.nr_sequencia,'PL',dt_inicial_p,dt_final_p)=0 THEN 0  ELSE a.vl_procedimento - OBTER_VALOR_REPASSE_ITEM_PER(a.nr_sequencia,'P',dt_inicial_p,dt_final_p) END  vl_liquido, 
		OBTER_VALOR_REPASSE_ITEM_PER(a.nr_sequencia,'P',dt_inicial_p,dt_final_p) - 
			OBTER_VALOR_REPASSE_ITEM_PER(a.nr_sequencia,'PL',dt_inicial_p,dt_final_p) vl_pendente, 
		0 vl_recurso 
	from 	convenio c, 
		atendimento_paciente b, 
		conta_paciente h, 
		procedimento_paciente a, 
		procedimento_repasse d 
	where 	not exists (select	1 
				from	convenio_retorno_item x 
				where	x.nr_interno_conta = h.nr_interno_conta) 
	and	h.cd_estabelecimento		= cd_estabelecimento_p 
	and	c.ie_tipo_convenio		= 1 
	and	coalesce(a.cd_motivo_exc_conta::text, '') = '' 
	and	h.cd_convenio_parametro		= c.cd_convenio 
	and	h.nr_atendimento		= b.nr_atendimento 
	and	h.nr_interno_conta		= a.nr_interno_conta 
	and	d.nr_seq_procedimento	= a.nr_sequencia 
	and	coalesce(d.dt_liberacao,d.dt_atualizacao) between dt_inicial_p and fim_dia(dt_final_p) 
	and (ie_particular_p = 'S' or ie_particular_p = 'T') 
	group by a.vl_procedimento, 
		a.nr_sequencia, 
		obter_grupo_receita(b.cd_estabelecimento,NULL,a.cd_procedimento, a.ie_origem_proced, b.ie_tipo_atendimento, 
									a.cd_setor_atendimento), 
		h.cd_convenio_parametro, 
		a.cd_setor_atendimento 
	
union all
 
	select	obter_grupo_receita(b.cd_estabelecimento,a.cd_material,NULL, NULL, b.ie_tipo_atendimento, 					 
									a.cd_setor_atendimento) CD_GRUPO_RECEITA, 
		h.cd_convenio_parametro, 
		a.cd_setor_atendimento, 
		to_char(a.vl_material) vl_item, 
		0 vl_glosado, 
		OBTER_VALOR_REPASSE_ITEM_PER(a.nr_sequencia,'ML',dt_inicial_p,dt_final_p) vl_repasse, 
		CASE WHEN OBTER_VALOR_REPASSE_ITEM_PER(a.nr_sequencia,'ML',dt_inicial_p,dt_final_p)=0 THEN 0  ELSE a.vl_material - OBTER_VALOR_REPASSE_ITEM_PER(a.nr_sequencia,'M',dt_inicial_p,dt_final_p) END  vl_liquido, 
		OBTER_VALOR_REPASSE_ITEM_PER(a.nr_sequencia,'M',dt_inicial_p,dt_final_p) - 
			OBTER_VALOR_REPASSE_ITEM_PER(a.nr_sequencia,'ML',dt_inicial_p,dt_final_p) vl_pendente, 
		0 vl_recurso 
	from 	convenio c, 
		atendimento_paciente b, 
		conta_paciente h, 
		material_atend_paciente a, 
		material_repasse d 
	where 	not exists (select	1 
				from	convenio_retorno_item x 
				where	x.nr_interno_conta = h.nr_interno_conta) 
	and	h.cd_estabelecimento		= cd_estabelecimento_p 
	and	c.ie_tipo_convenio		= 1 
	and	coalesce(a.cd_motivo_exc_conta::text, '') = '' 
	and	h.cd_convenio_parametro		= c.cd_convenio 
	and	h.nr_atendimento		= b.nr_atendimento 
	and	h.nr_interno_conta		= a.nr_interno_conta 
	and	d.nr_seq_material		= a.nr_sequencia 
	and	coalesce(d.dt_liberacao,d.dt_atualizacao) between dt_inicial_p and fim_dia(dt_final_p) 
	and (ie_particular_p = 'S' or ie_particular_p = 'T') 
	group by a.vl_material, 
		a.nr_sequencia, 
		obter_grupo_receita(b.cd_estabelecimento,a.cd_material,NULL, NULL, b.ie_tipo_atendimento, 					 
									a.cd_setor_atendimento), 
		h.cd_convenio_parametro, 
		a.cd_setor_atendimento 
	
union all
 
	/* Particular Sem Repasse */
 
	select	obter_grupo_receita(b.cd_estabelecimento,NULL,a.cd_procedimento, a.ie_origem_proced, b.ie_tipo_atendimento, 
									a.cd_setor_atendimento) cd_grupo_receita, 
		h.cd_convenio_parametro, 
		a.cd_setor_atendimento, 
		to_char(a.vl_procedimento) vl_item, 
		0 vl_glosado, 
		0 vl_repasse, 
		a.vl_procedimento vl_liquido, 
		0 vl_pendente, 
		0 vl_recurso 
	from 	convenio c, 
		procedimento_paciente a, 
		atendimento_paciente b, 
		conta_paciente h 
	where 	not exists (select	1 
				from	convenio_retorno_item x 
				where	x.nr_interno_conta = h.nr_interno_conta) 
	and	h.cd_estabelecimento		= cd_estabelecimento_p 
	and	c.ie_tipo_convenio		= 1 
	and	coalesce(a.cd_motivo_exc_conta::text, '') = '' 
	and	h.cd_convenio_parametro		= c.cd_convenio 
	and	h.nr_atendimento		= b.nr_atendimento 
	and	h.nr_interno_conta		= a.nr_interno_conta 
	and	not exists (select	1 
				from	procedimento_repasse y 
				where	y.nr_seq_procedimento	= a.nr_sequencia) 
	and	h.dt_mesano_referencia between dt_inicial_p and fim_dia(dt_final_p) 
	and (ie_particular_p = 'S' or ie_particular_p = 'T') 
	group by a.vl_procedimento, 
		a.nr_sequencia, 
		obter_grupo_receita(b.cd_estabelecimento,NULL,a.cd_procedimento, a.ie_origem_proced, b.ie_tipo_atendimento, 
									a.cd_setor_atendimento), 
		h.cd_convenio_parametro, 
		a.cd_setor_atendimento 
	
union all
 
	select	obter_grupo_receita(b.cd_estabelecimento,a.cd_material,NULL, NULL, b.ie_tipo_atendimento, 					 
									a.cd_setor_atendimento) CD_GRUPO_RECEITA, 
		h.cd_convenio_parametro, 
		a.cd_setor_atendimento, 
		to_char(a.vl_material) vl_item, 
		0 vl_glosado, 
		0 vl_repasse, 
		a.vl_material vl_liquido, 
		0 vl_pendente, 
		0 vl_recurso 
	from 	convenio c, 
		material_atend_paciente a, 
		atendimento_paciente b, 
		conta_paciente h 
	where 	not exists (select	1 
				from	convenio_retorno_item x 
				where	x.nr_interno_conta = h.nr_interno_conta) 
	and	h.cd_estabelecimento		= cd_estabelecimento_p 
	and	c.ie_tipo_convenio		= 1 
	and	coalesce(a.cd_motivo_exc_conta::text, '') = '' 
	and	h.cd_convenio_parametro		= c.cd_convenio 
	and	h.nr_atendimento		= b.nr_atendimento 
	and	h.nr_interno_conta		= a.nr_interno_conta 
	and	not exists (select	1 
				from	material_repasse y 
				where	y.nr_seq_material	= a.nr_sequencia) 
	and	h.dt_mesano_referencia between dt_inicial_p and fim_dia(dt_final_p) 
	and (ie_particular_p = 'S' or ie_particular_p = 'T') 
	group by a.vl_material, 
		a.nr_sequencia, 
		obter_grupo_receita(b.cd_estabelecimento,a.cd_material,NULL, NULL, b.ie_tipo_atendimento, 					 
									a.cd_setor_atendimento), 
		h.cd_convenio_parametro, 
		a.cd_setor_atendimento 
	
union all
 
	/* SUS  */
 
	select	obter_grupo_receita(b.cd_estabelecimento,null,a.cd_procedimento, a.ie_origem_proced, b.ie_tipo_atendimento, 
									a.cd_setor_receita) cd_grupo_receita, 
		f.cd_convenio, 
		a.cd_setor_receita cd_setor_atendimento, 
		to_char(sum(coalesce(a.vl_custo_operacional,0) + (coalesce(j.vl_medico,0) + coalesce(j.vl_ato_anestesista,0)))) vl_item, 
		Obter_Glosa_item_periodo(a.nr_sequencia,null,dt_inicial_p,dt_final_p,1) vl_glosado, 
		OBTER_VALOR_REPASSE_ITEM_PER(a.nr_sequencia,'PL',dt_inicial_p,dt_final_p) vl_repasse,		 
		sum(coalesce(a.vl_custo_operacional,0) + 
		(coalesce(j.vl_medico,0) + coalesce(j.vl_ato_anestesista,0))) - 
			Obter_Glosa_item_periodo(a.nr_sequencia,null,dt_inicial_p,dt_final_p,3) - 
			OBTER_VALOR_REPASSE_ITEM_PER(a.nr_sequencia,'PL',dt_inicial_p,dt_final_p) vl_liquido, 
		Obter_Glosa_item_periodo(a.nr_sequencia,null,dt_inicial_p,dt_final_p,3) - 
			Obter_Glosa_item_periodo(a.nr_sequencia,null,dt_inicial_p,dt_final_p,1) vl_pendente, 
		Obter_Glosa_item_periodo(a.nr_sequencia,null,dt_inicial_p,dt_final_p,4) vl_recurso 
	from 	procedimento_paciente a, 
		atendimento_paciente b, 
		sus_valor_proc_paciente j, 
		convenio g, 
		conta_paciente h, 
		convenio_retorno_item i, 
		convenio_retorno f 
	where 	f.nr_sequencia		= i.nr_seq_retorno 
	and	h.nr_interno_conta		= i.nr_interno_conta 
	and	h.nr_atendimento		= b.nr_atendimento 
	and	a.nr_atendimento		= b.nr_atendimento 
	and	a.nr_interno_conta		= h.nr_interno_conta 
	and	h.nr_atendimento		= b.nr_atendimento 
	and	g.cd_convenio			= f.cd_convenio 
	and	g.ie_tipo_convenio		= 3 
	and	a.nr_sequencia			= j.nr_sequencia 
	and	obter_tipo_convenio(f.cd_convenio) = coalesce(IE_TIPO_CONVENIO_P,obter_tipo_convenio(f.cd_convenio)) 
	and	f.dt_retorno 		between dt_inicial_p and fim_dia(dt_final_p) 
	and	f.cd_estabelecimento	= cd_estabelecimento_p 
	and	coalesce(a.cd_motivo_exc_conta::text, '') = '' 
	and	a.ie_origem_proced	= 7 
	and (coalesce(ie_particular_p,'N') = 'N' or ie_particular_p = 'T') 
	group by 
		a.nr_sequencia, 
		obter_grupo_receita(b.cd_estabelecimento,null,a.cd_procedimento, a.ie_origem_proced, b.ie_tipo_atendimento, 
									a.cd_setor_receita), 
		f.cd_convenio, 
		a.cd_setor_receita 
	
union all
 
	select	obter_grupo_receita(b.cd_estabelecimento,null,a.cd_procedimento, a.ie_origem_proced, b.ie_tipo_atendimento, 
									a.cd_setor_receita) cd_grupo_receita, 
		f.cd_convenio, 
		a.cd_setor_receita cd_setor_atendimento, 
		to_char(sum(coalesce(j.vl_sadt_rateado,a.vl_materiais))) vl_item, 
		Obter_Glosa_item_periodo(a.nr_sequencia,null,dt_inicial_p,dt_final_p,1) vl_glosado, 
		OBTER_VALOR_REPASSE_ITEM_PER(a.nr_sequencia,'PL',dt_inicial_p,dt_final_p) vl_repasse,		 
		sum(coalesce(j.vl_sadt_rateado,a.vl_materiais)) - 
			Obter_Glosa_item_periodo(a.nr_sequencia,null,dt_inicial_p,dt_final_p,3) - 
			OBTER_VALOR_REPASSE_ITEM_PER(a.nr_sequencia,'PL',dt_inicial_p,dt_final_p) vl_liquido, 
		Obter_Glosa_item_periodo(a.nr_sequencia,null,dt_inicial_p,dt_final_p,3) - 
			Obter_Glosa_item_periodo(a.nr_sequencia,null,dt_inicial_p,dt_final_p,1) vl_pendente, 
		Obter_Glosa_item_periodo(a.nr_sequencia,null,dt_inicial_p,dt_final_p,4) vl_recurso 
	from 	procedimento_paciente a, 
		atendimento_paciente b, 
		sus_valor_proc_paciente j, 
		convenio g, 
		conta_paciente h, 
		convenio_retorno_item i, 
		convenio_retorno f 
	where 	f.nr_sequencia		= i.nr_seq_retorno 
	and	h.nr_interno_conta		= i.nr_interno_conta 
	and	h.nr_atendimento		= b.nr_atendimento 
	and	a.nr_atendimento		= b.nr_atendimento 
	and	a.nr_interno_conta		= h.nr_interno_conta 
	and	h.nr_atendimento		= b.nr_atendimento 
	and	g.cd_convenio			= f.cd_convenio 
	and	g.ie_tipo_convenio		= 3 
	and	a.nr_sequencia			= j.nr_sequencia 
	and	obter_tipo_convenio(f.cd_convenio) = coalesce(IE_TIPO_CONVENIO_P,obter_tipo_convenio(f.cd_convenio)) 
	and	f.dt_retorno 		between dt_inicial_p and fim_dia(dt_final_p) 
	and	f.cd_estabelecimento	= cd_estabelecimento_p 
	and	coalesce(a.cd_motivo_exc_conta::text, '') = '' 
	and	a.ie_origem_proced	= 7 
	and (coalesce(ie_particular_p,'N') = 'N' or ie_particular_p = 'T') 
	group by 
		a.nr_sequencia, 
		obter_grupo_receita(b.cd_estabelecimento,null,a.cd_procedimento, a.ie_origem_proced, b.ie_tipo_atendimento, 
									a.cd_setor_receita), 
		f.cd_convenio, 
		a.cd_setor_receita 
	) x 
	where	(x.cd_grupo_receita IS NOT NULL AND x.cd_grupo_receita::text <> '') 
	group by cd_grupo_receita, 
		 cd_convenio, 
		 cd_setor_atendimento;

C04 CURSOR FOR 
	SELECT	distinct 
		x.cd_grupo_receita, 
		x.cd_convenio_parametro 
	from ( 
	SELECT	obter_grupo_receita(b.cd_estabelecimento,NULL,a.cd_procedimento, a.ie_origem_proced, b.ie_tipo_atendimento, 
 
a.cd_setor_atendimento) cd_grupo_receita, 
		h.cd_convenio_parametro 
	from	procedimento_repasse c, 
		procedimento_paciente a, 
		atendimento_paciente b, 
		conta_paciente h 
	where 	b.nr_atendimento 	= a.nr_atendimento 
	and	h.nr_atendimento	= b.nr_atendimento 
	and	a.nr_interno_conta	= h.nr_interno_conta 
	and	h.nr_atendimento	= b.nr_atendimento 
	and	obter_tipo_convenio(h.cd_convenio_parametro) = coalesce(ie_tipo_convenio_p,obter_tipo_convenio(h.cd_convenio_parametro)) 
	and	c.nr_seq_procedimento = a.nr_sequencia 
	and	h.dt_mesano_referencia between dt_inicial_p and fim_dia(dt_final_p) 
	and	h.cd_estabelecimento	= cd_estabelecimento_p 
	group by obter_grupo_receita(b.cd_estabelecimento,NULL,a.cd_procedimento, a.ie_origem_proced, b.ie_tipo_atendimento, 
 
a.cd_setor_atendimento), 
		h.cd_convenio_parametro 
	
union
 
	select	obter_grupo_receita(b.cd_estabelecimento,a.cd_material,NULL, NULL, b.ie_tipo_atendimento, 					 
 
									a.cd_setor_atendimento) CD_GRUPO_RECEITA, 
		h.cd_convenio_parametro 
	from	material_repasse c, 
		material_atend_paciente a, 
		atendimento_paciente b, 
		conta_paciente h 
	where 	b.nr_atendimento	= a.nr_atendimento 
	and	h.nr_atendimento	= b.nr_atendimento 
	and	a.nr_interno_conta	= h.nr_interno_conta 
	and	h.nr_atendimento	= b.nr_atendimento 
	and	obter_tipo_convenio(h.cd_convenio_parametro) = coalesce(ie_tipo_convenio_p, obter_tipo_convenio(h.cd_convenio_parametro)) 
	and	c.nr_seq_material	= a.nr_sequencia 
	and	h.dt_mesano_referencia between dt_inicial_p and fim_dia(dt_final_p) 
	and	h.cd_estabelecimento	= cd_estabelecimento_p 
	group by OBTER_GRUPO_RECEITA(b.cd_estabelecimento,a.cd_material,NULL, NULL, b.ie_tipo_atendimento, a.cd_setor_atendimento), 
		 h.cd_convenio_parametro 
 
 
 
	)x 
	group by x.cd_grupo_receita, 
		 x.cd_convenio_parametro 
	order by x.cd_grupo_receita;

C05 CURSOR FOR 
	SELECT	x.cd_setor_atendimento 
	from ( 
	SELECT	a.cd_setor_atendimento 
	from 	procedimento_repasse c, 
		procedimento_paciente a, 
		atendimento_paciente b, 
		conta_paciente h 
	where 	b.nr_atendimento 	= a.nr_atendimento 
	and	h.nr_atendimento	= b.nr_atendimento 
	and	a.nr_interno_conta	= h.nr_interno_conta 
	and	obter_tipo_convenio(h.cd_convenio_parametro) = coalesce(ie_tipo_convenio_p, obter_tipo_convenio(h.cd_convenio_parametro)) 
	and	c.nr_seq_procedimento	= a.nr_sequencia 
	and	h.dt_mesano_referencia between dt_inicial_p and fim_dia(dt_final_p) 
	and	h.cd_estabelecimento	= cd_estabelecimento_p 
	group by a.cd_setor_atendimento 
	
union all
 
	select a.cd_setor_atendimento 
	from 	material_repasse c, 
		material_atend_paciente a, 
		atendimento_paciente b, 
		conta_paciente h 
	where 	b.nr_atendimento   			= a.nr_atendimento 
	and	h.nr_atendimento			= b.nr_atendimento 
	and	a.nr_interno_conta			= h.nr_interno_conta 
	and	obter_tipo_convenio(h.cd_convenio_parametro) = coalesce(ie_tipo_convenio_p, obter_tipo_convenio(h.cd_convenio_parametro)) 
	and	c.nr_seq_material	= a.nr_sequencia 
	and	h.dt_mesano_referencia between dt_inicial_p and fim_dia(dt_final_p) 
	and	h.cd_estabelecimento			= cd_estabelecimento_p 
	group by a.cd_setor_atendimento 
 
 
	)x 
	group by x.cd_setor_atendimento 
	order by x.cd_setor_atendimento;

C06 CURSOR FOR 
	SELECT 
		coalesce(sum(x.vl_item),0) vl_item, 
		coalesce(sum(x.vl_repasse),0) vl_repasse 
	from ( 
	SELECT 
		a.vl_procedimento vl_item, 
		OBTER_VALOR_REPASSE_ITEM_PER(a.nr_sequencia,'PL',dt_inicial_p,dt_final_p) vl_repasse 
	from 	procedimento_repasse c, 
		atendimento_paciente b, 
		procedimento_paciente a, 
		conta_paciente h 
	where 	b.nr_atendimento 	= a.nr_atendimento 
	and	h.nr_atendimento	= b.nr_atendimento 
	and	a.nr_interno_conta	= h.nr_interno_conta 
	and	obter_tipo_convenio(h.cd_convenio_parametro) = coalesce(ie_tipo_convenio_p, obter_tipo_convenio(h.cd_convenio_parametro)) 
	and	c.nr_seq_procedimento	= a.nr_sequencia 
	and	h.dt_mesano_referencia between dt_inicial_p and fim_dia(dt_final_p) 
	and	h.cd_estabelecimento	= cd_estabelecimento_p 
	and	a.cd_setor_atendimento	= cd_setor_atendimento_w 
	and	h.cd_convenio_parametro	= cd_convenio_w 
	and	coalesce(a.cd_motivo_exc_conta::text, '') = '' 
	and 	obter_grupo_receita(b.cd_estabelecimento,NULL,a.cd_procedimento, a.ie_origem_proced, b.ie_tipo_atendimento, 
 
a.cd_setor_atendimento) = nr_seq_grupo_rec_w 
	group by 
		a.vl_procedimento, 
		a.nr_sequencia 
	
union all
 
	select 
		a.vl_material vl_item, 
		OBTER_VALOR_REPASSE_ITEM_PER(a.nr_sequencia,'ML',dt_inicial_p,dt_final_p) vl_repasse 
	from 	material_repasse c, 
		material_atend_paciente a, 
		atendimento_paciente b, 
		conta_paciente h 
	where 	b.nr_atendimento   		= a.nr_atendimento 
	and	h.nr_atendimento		= b.nr_atendimento 
	and	a.nr_interno_conta		= h.nr_interno_conta 
	and	obter_tipo_convenio(h.cd_convenio_parametro) = coalesce(ie_tipo_convenio_p, obter_tipo_convenio(h.cd_convenio_parametro)) 
	and	c.nr_seq_material		= a.nr_sequencia 
	and	h.dt_mesano_referencia between dt_inicial_p and fim_dia(dt_final_p) 
	and	h.cd_estabelecimento		= cd_estabelecimento_p 
	and	a.cd_setor_atendimento		= cd_setor_atendimento_w 
	and	h.cd_convenio_parametro		= cd_convenio_w 
	and	coalesce(a.cd_motivo_exc_conta::text, '') = '' 
	and	obter_grupo_receita(b.cd_estabelecimento,a.cd_material,NULL, NULL, b.ie_tipo_atendimento, a.cd_setor_atendimento) = 
 
nr_seq_grupo_rec_w 
	group by 
		a.vl_material, 
		a.nr_sequencia 
	)x;


BEGIN 
 
 
delete	from w_grupo_receita 
where	nm_usuario	= nm_usuario_p 
or	DT_ATUALIZACAO_NREC	< clock_timestamp() - interval '2 days';
 
commit;
 
if	((ie_opcao_p = 0) or (ie_opcao_p = 2)) then 
 
	qt_registro_w		:= 0;
	OPEN C03;
	LOOP 
	FETCH C03 into 
		nr_seq_grupo_rec_w, 
		cd_convenio_w, 
		cd_setor_atendimento_w, 
		vl_item_w, 
		vl_glosado_w, 
		vl_repasse_w, 
		vl_liquido_w, 
		vl_pendente_w, 
		vl_recurso_w;
	EXIT WHEN NOT FOUND; /* apply on c03 */
		qt_registro_w	:= qt_registro_w + 1;
		insert into w_grupo_receita(nr_sequencia, ie_tipo_valor, nr_seq_grupo_rec, nm_usuario, dt_atualizacao_nrec, 
			nm_usuario_nrec, vl_grupo, cd_convenio, cd_setor_atendimento) 
		values (nextval('w_grupo_receita_seq'), 1, nr_seq_grupo_rec_w, nm_usuario_p, 
			clock_timestamp(), nm_usuario_p, vl_item_w, cd_convenio_w, cd_setor_atendimento_w);
 
		insert into w_grupo_receita(nr_sequencia, ie_tipo_valor, nr_seq_grupo_rec, nm_usuario, dt_atualizacao_nrec, 
			nm_usuario_nrec, vl_grupo, cd_convenio, cd_setor_atendimento) 
		values (nextval('w_grupo_receita_seq'), 2, nr_seq_grupo_rec_w, nm_usuario_p, 
			clock_timestamp(), nm_usuario_p, vl_glosado_w, cd_convenio_w, cd_setor_atendimento_w);
 
		insert into w_grupo_receita(nr_sequencia, ie_tipo_valor, nr_seq_grupo_rec, nm_usuario, dt_atualizacao_nrec, 
			nm_usuario_nrec, vl_grupo, cd_convenio, cd_setor_atendimento) 
		values (nextval('w_grupo_receita_seq'), 3, nr_seq_grupo_rec_w, nm_usuario_p, 
			clock_timestamp(), nm_usuario_p, vl_repasse_w, cd_convenio_w, cd_setor_atendimento_w);
 
		insert into w_grupo_receita(nr_sequencia, ie_tipo_valor, nr_seq_grupo_rec, nm_usuario, dt_atualizacao_nrec, 
			nm_usuario_nrec, vl_grupo, cd_convenio, cd_setor_atendimento) 
		values (nextval('w_grupo_receita_seq'), 4, nr_seq_grupo_rec_w, nm_usuario_p, 
			clock_timestamp(), nm_usuario_p, vl_liquido_w, cd_convenio_w, cd_setor_atendimento_w);
 
		insert into w_grupo_receita(nr_sequencia, ie_tipo_valor, nr_seq_grupo_rec, nm_usuario, dt_atualizacao_nrec, 
			nm_usuario_nrec, vl_grupo, cd_convenio, cd_setor_atendimento) 
		values (nextval('w_grupo_receita_seq'), 5, nr_seq_grupo_rec_w, nm_usuario_p, 
			clock_timestamp(), nm_usuario_p, vl_pendente_w, cd_convenio_w, cd_setor_atendimento_w);
 
		insert into w_grupo_receita(nr_sequencia, ie_tipo_valor, nr_seq_grupo_rec, nm_usuario, dt_atualizacao_nrec, 
			nm_usuario_nrec, vl_grupo, cd_convenio, cd_setor_atendimento) 
		values (nextval('w_grupo_receita_seq'), 6, nr_seq_grupo_rec_w, nm_usuario_p, 
			clock_timestamp(), nm_usuario_p, vl_recurso_w, cd_convenio_w, cd_setor_atendimento_w);
		if (qt_registro_w = 5000) then 
			commit;
			qt_registro_w	:= 0;
		end if;
 
	end loop;
	close c03;
	commit;
end if;
 
if	((ie_opcao_p = 1) or (ie_opcao_p = 2)) then 
 
	OPEN C04;
	LOOP 
	FETCH C04 into 
		nr_seq_grupo_rec_w, 
		cd_convenio_w;
 
	EXIT WHEN NOT FOUND; /* apply on c04 */
 
	if (nr_seq_grupo_rec_w IS NOT NULL AND nr_seq_grupo_rec_w::text <> '') then 
 
		insert into w_grupo_receita(nr_sequencia, ie_tipo_valor, nr_seq_grupo_rec, nm_usuario, dt_atualizacao_nrec, 
				nm_usuario_nrec, vl_grupo, cd_convenio, cd_setor_atendimento) 
			values (	nextval('w_grupo_receita_seq'), 0, nr_seq_grupo_rec_w, nm_usuario_p, 
				clock_timestamp(), nm_usuario_p, 0, cd_convenio_w, 0);
 
		OPEN C05;
		LOOP 
		FETCH C05 into 
			cd_setor_atendimento_w;
		EXIT WHEN NOT FOUND; /* apply on c05 */
 
			qt_registro_w		:= 0;
			OPEN C06;
			LOOP 
			FETCH C06 into 
				vl_item_w, 
				vl_repasse_w;
			EXIT WHEN NOT FOUND; /* apply on c06 */
				qt_registro_w	:= qt_registro_w + 1;
				insert into w_grupo_receita(nr_sequencia, ie_tipo_valor, nr_seq_grupo_rec,	nm_usuario, dt_atualizacao_nrec, 
					nm_usuario_nrec, vl_grupo, cd_convenio, cd_setor_atendimento) 
				values (nextval('w_grupo_receita_seq'), 1, nr_seq_grupo_rec_w, nm_usuario_p, 
					clock_timestamp(), nm_usuario_p, vl_item_w, cd_convenio_w, cd_setor_atendimento_w);
 
				insert into w_grupo_receita(nr_sequencia, ie_tipo_valor, nr_seq_grupo_rec,	nm_usuario, dt_atualizacao_nrec, 
					nm_usuario_nrec, vl_grupo, cd_convenio, cd_setor_atendimento) 
				values (nextval('w_grupo_receita_seq'), 2, nr_seq_grupo_rec_w, nm_usuario_p, 
					clock_timestamp(), nm_usuario_p, 0, cd_convenio_w, cd_setor_atendimento_w);
 
				insert into w_grupo_receita(nr_sequencia, ie_tipo_valor, nr_seq_grupo_rec,	nm_usuario, dt_atualizacao_nrec, 
					nm_usuario_nrec, vl_grupo, cd_convenio, cd_setor_atendimento) 
				values (nextval('w_grupo_receita_seq'), 3, nr_seq_grupo_rec_w, nm_usuario_p, 
					clock_timestamp(), nm_usuario_p, vl_repasse_w, cd_convenio_w, cd_setor_atendimento_w);
 
				insert into w_grupo_receita(nr_sequencia, ie_tipo_valor, nr_seq_grupo_rec,	nm_usuario, dt_atualizacao_nrec, 
					nm_usuario_nrec, vl_grupo, cd_convenio, cd_setor_atendimento) 
				values (nextval('w_grupo_receita_seq'), 4, nr_seq_grupo_rec_w, nm_usuario_p, 
					clock_timestamp(), nm_usuario_p, 0, cd_convenio_w, cd_setor_atendimento_w);
 
				insert into w_grupo_receita(nr_sequencia, ie_tipo_valor, nr_seq_grupo_rec,	nm_usuario, dt_atualizacao_nrec, 
					nm_usuario_nrec, vl_grupo, cd_convenio, cd_setor_atendimento) 
				values (nextval('w_grupo_receita_seq'), 5, nr_seq_grupo_rec_w, nm_usuario_p, 
					clock_timestamp(), nm_usuario_p, 0, cd_convenio_w, cd_setor_atendimento_w);
 
				insert into w_grupo_receita(nr_sequencia, ie_tipo_valor, nr_seq_grupo_rec,	nm_usuario, dt_atualizacao_nrec, 
					nm_usuario_nrec, vl_grupo, cd_convenio, cd_setor_atendimento) 
				values (nextval('w_grupo_receita_seq'), 6, nr_seq_grupo_rec_w, nm_usuario_p, 
					clock_timestamp(), nm_usuario_p, 0, cd_convenio_w, cd_setor_atendimento_w);
				if (qt_registro_w = 5000) then 
					commit;
					qt_registro_w	:= 0;
				end if;
			end loop;
			close c06;
			commit;
		end loop;
		close c05;
	end if;
	end loop;
	close c04;
	commit;
end if;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_w_grupo_receita (cd_estabelecimento_p bigint, dt_inicial_p timestamp, dt_final_p timestamp, ie_tipo_convenio_p text, nm_usuario_p text, ie_opcao_p bigint, ie_particular_p text) FROM PUBLIC;

