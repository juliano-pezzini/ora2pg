-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_d301_segmento_auf ( nr_seq_dataset_p bigint, nm_usuario_p text) AS $body$
DECLARE



ds_dt_admissao_w		d301_segmento_auf.ds_dt_admissao%type;
ds_hora_admissao_w		d301_segmento_auf.ds_hora_admissao%type;
nr_seq_301_mot_adm_tipo_w	d301_segmento_auf.nr_seq_301_mot_adm_tipo%type;
nr_seq_301_mot_adm_mot_w	d301_segmento_auf.nr_seq_301_mot_adm_mot%type;
nr_seq_301_department_w		d301_segmento_auf.nr_seq_301_department%type;
ds_dt_prevista_saida_w		d301_segmento_auf.ds_dt_prevista_saida%type;
nr_medico_referencia_w		d301_segmento_auf.nr_medico_referencia%type;
nr_ik_hosp_origem_w		d301_segmento_auf.nr_ik_hosp_origem%type;
ds_setor_adm_emerg_w		d301_segmento_auf.ds_setor_adm_emerg%type;
nr_dentista_referencia_w	d301_segmento_auf.nr_dentista_referencia%type;
nr_sequencia_w			d301_segmento_auf.nr_sequencia%type;
qt_peso_kg_admissao_w		d301_segmento_auf.qt_peso_kg_admissao%type;

nr_atendimento_w	atendimento_paciente.nr_atendimento%type;
nr_seq_queixa_w		atendimento_paciente.nr_seq_queixa%type;
nr_seq_classif_w	atendimento_paciente.nr_seq_classificacao%type;
cd_med_ref_w		atendimento_paciente.cd_medico_referido%type;
ie_tipo_atend_w		atendimento_paciente.ie_tipo_atendimento%type;
nr_seq_forma_w		atendimento_paciente.nr_seq_forma_chegada%type;

nr_seq_pac_uni_w	atend_paciente_unidade.nr_sequencia%type;
dt_entrada_unidade_w	atend_paciente_unidade.dt_entrada_unidade%type;

cd_departamento_w	departamento_medico.cd_departamento%type;
qt_peso_w		atendimento_sinal_vital.qt_peso%type;
dt_liberacao_w		atendimento_sinal_vital.dt_liberacao%type;

C01 CURSOR FOR
SELECT	a.nr_seq_interno,
	a.dt_entrada_unidade
from	atend_paciente_unidade a,
	atendimento_paciente b,
	setor_atendimento c
where	a.nr_atendimento	= b.nr_atendimento
and	a.cd_setor_atendimento	= c.cd_setor_atendimento
and	b.nr_atendimento	= nr_atendimento_w
and	c.cd_classif_setor	in (2,3,4)
order by 2 desc;

C02 CURSOR FOR
SELECT	qt_peso,
	dt_liberacao
from	atendimento_sinal_vital
where	nr_atendimento = nr_atendimento_w
order by 2 desc;


BEGIN

ds_setor_adm_emerg_w := null;

select	nr_atendimento
into STRICT	nr_atendimento_w
from	d301_dataset_envio
where	nr_sequencia = nr_seq_dataset_p;

open C01;
loop
fetch C01 into
	nr_seq_pac_uni_w,
	dt_entrada_unidade_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	nr_seq_pac_uni_w 	:= nr_seq_pac_uni_w;
	dt_entrada_unidade_w	:= dt_entrada_unidade_w;
	end;
end loop;
close C01;

select	max(cd_departamento)
into STRICT	cd_departamento_w
from	atend_paciente_unidade
where	nr_seq_interno	= nr_seq_pac_uni_w;

open C02;
loop
fetch C02 into
	qt_peso_w,
	dt_liberacao_w;
EXIT WHEN NOT FOUND; /* apply on C02 */
	begin
	qt_peso_w 		:= qt_peso_w;
	dt_liberacao_w		:= dt_liberacao_w;
	end;
end loop;
close C02;

/*select	obter_departamento_data(nr_atendimento_w,dt_entrada_unidade_w)
into	cd_departamento_w
from 	dual;*/
select	max(to_char(b.dt_entrada,'YYYYMMDD')),
	max(to_char(b.dt_entrada,'hhmi')),
	max(b.nr_seq_queixa),
	substr(max(b.nr_seq_classificacao),1,2),
	max(to_char((b.dt_entrada + coalesce(b.qt_dias_prev_inter,0)),'YYYYMMDD')),
	max(cd_medico_referido),
	max(c.cd_cnes),
	max(nr_seq_forma_chegada),
	max(ie_tipo_atendimento)
into STRICT	ds_dt_admissao_w,
	ds_hora_admissao_w,
	nr_seq_queixa_w,
	nr_seq_classif_w,
	ds_dt_prevista_saida_w,
	cd_med_ref_w,
	nr_ik_hosp_origem_w,
	nr_seq_forma_w,
	ie_tipo_atend_w
FROM atend_categoria_convenio a, atendimento_paciente b
LEFT OUTER JOIN pessoa_juridica c ON (b.cd_cgc_indicacao = c.cd_cgc)
WHERE a.nr_atendimento 	= b.nr_atendimento  and a.nr_seq_interno 	= obter_atecaco_atendimento(nr_atendimento_w);


select	max(a.nr_crm)
into STRICT	nr_medico_referencia_w
from	medico a
where	a.cd_pessoa_fisica 	= cd_med_ref_w;

select	max(a.nr_crm)
into STRICT	nr_dentista_referencia_w
FROM medico a, pessoa_fisica b
LEFT OUTER JOIN cargo c ON (b.cd_cargo = c.cd_cargo)
WHERE a.cd_pessoa_fisica 	= b.cd_pessoa_fisica  and a.cd_pessoa_fisica 	= cd_med_ref_w and coalesce(c.ie_tipo_prof_saude,'X') = 'O';

if (coalesce(ie_tipo_atend_w,0) = 3) then
	select	substr(max(ds_forma),1,30)
	into STRICT	ds_setor_adm_emerg_w
	from	forma_chegada
	where	nr_sequencia = nr_seq_forma_w;
end if;


SELECT	MAX(OBTER_SEQ_VALOR_301('C301_1_MOTIVO_ADM_MOTIVO','IE_MOTIVO',OBTER_CONVERSAO_301('C301_1_MOTIVO_ADM_MOTIVO','CLASSIFICACAO_ATENDIMENTO',NULL,NR_SEQ_CLASSIF_W,'I'))),
	MAX(OBTER_SEQ_VALOR_301('C301_1_MOTIVO_ADM_TIPO','IE_TIPO',OBTER_CONVERSAO_301('C301_1_MOTIVO_ADM_TIPO','QUEIXA_PACIENTE',NULL,NR_SEQ_QUEIXA_W,'I'))),
	MAX(OBTER_SEQ_VALOR_301('C301_6_DEPARTAMENTO','CD_DEPARTAMENTO',OBTER_CONVERSAO_301('C301_6_DEPARTAMENTO','DEPARTAMENTO_MEDICO',NULL,CD_DEPARTAMENTO_W,'I')))
into STRICT	nr_seq_301_mot_adm_tipo_w,
	nr_seq_301_mot_adm_mot_w,
	nr_seq_301_department_w
;

select	nextval('d301_segmento_auf_seq')
into STRICT	nr_sequencia_w
;

insert into d301_segmento_auf(	ds_dt_admissao,
				ds_hora_admissao,
				nr_seq_301_mot_adm_tipo,
				nr_seq_301_mot_adm_mot,
				nr_seq_301_department,
				ds_dt_prevista_saida,
				nr_medico_referencia,
				nr_estab_medico_ref,
				nr_ik_hosp_origem,
				ds_setor_adm_emerg,
				nr_dentista_referencia,
				dt_atualizacao,
				nm_usuario,
				nr_seq_dataset,
				nr_sequencia,
				qt_peso_kg_admissao)
			values (	ds_dt_admissao_w,
				ds_hora_admissao_w,
				nr_seq_301_mot_adm_tipo_w,
				nr_seq_301_mot_adm_mot_w,
				nr_seq_301_department_w,
				ds_dt_prevista_saida_w,
				nr_medico_referencia_w,
				nr_medico_referencia_w,
				nr_ik_hosp_origem_w,
				ds_setor_adm_emerg_w,
				nr_dentista_referencia_w,
				clock_timestamp(),
				nm_usuario_p,
				nr_seq_dataset_p,
				nr_sequencia_w,
				qt_peso_kg_admissao_w);

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_d301_segmento_auf ( nr_seq_dataset_p bigint, nm_usuario_p text) FROM PUBLIC;

