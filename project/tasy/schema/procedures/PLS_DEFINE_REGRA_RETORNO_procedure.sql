-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_define_regra_retorno ( nr_seq_guia_p bigint, nr_seq_requisicao_p bigint, nr_seq_conta_p bigint, ie_evento_p text, nm_usuario_p text) AS $body$
DECLARE


/* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Finalidade: Realizar as consistencias de retorno do beneficiario no atendimento, verifica as regras cadastrada na funcao Cadastros gerais > Plano de Saude > OPS - Atendimento > Identificacao atendimento de retorno
-------------------------------------------------------------------------------------------------------------------

Locais de chamada direta: 
[X]  Objetos do dicionario [ ] Tasy (Delphi/Java) [  ] Portal [  ]  Relatorios [ ] Outros:
 ------------------------------------------------------------------------------------------------------------------

Pontos de atencao:Performance.
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */
ie_tipo_guia_w			varchar(2);
cd_estabelecimento_w	smallint;
nr_seq_prestador_w		bigint;
qt_dia_w				bigint;
qt_retorno_w			bigint;
ie_regra_w				varchar(3);
cd_medico_w				varchar(10);
qt_reg_w				bigint;
cd_cid_w				varchar(10);
cd_procedimento_w		bigint;
ie_origem_proced_w		bigint;
cd_categoria_w			varchar(10);
nr_seq_segurado_w		bigint;
qt_solicitada_w			pls_guia_plano_proc.qt_solicitada%type;
qt_especialidade_medica_w	bigint;
dt_solicitacao_w		timestamp;

dt_atendimento_referencia_w	timestamp;
dt_procedimento_w		timestamp;
qt_atend_retorno_w		pls_guia_plano_proc.qt_solicitada%type;
nr_seq_guia_plano_proc_w	bigint;
nr_seq_conta_proc_w		bigint;
ie_conta_w				varchar(1) := 'N';
ie_autorizacao_w		varchar(1) := 'N';
nr_seq_conta_w			bigint;
nr_seq_protocolo_w		bigint;
cd_guia_referente_w		varchar(20);
ie_medico_prestador_w	varchar(10);
cd_especialidade_w		integer;
ie_conta_posterior_w	varchar(1);
qt_hora_w				integer;
ds_observacao_glosa_w	varchar(4000);
ie_status_w				varchar(1);
cd_cid_principal_w		varchar(20);
ie_tipo_guia_ww			varchar(2);
ie_tipo_segurado_w		varchar(2);
ie_reembolso_w			varchar(1);
ie_tipo_protocolo_w		varchar(1);
ie_reembolso_ww			varchar(1);
nr_seq_cbo_saude_w		bigint;
cd_especialidade_guia_w	integer;
ie_busca_medico_nota_servico_w	varchar(1);
ie_origem_conta_w			varchar(1);
sg_cons_prof_prest_nota_w	varchar(12);
nr_cons_prof_prest_nota_w	varchar(15);
sg_uf_cons_prest_nota_w		varchar(2);
nr_seq_nota_cobranca_w		bigint;
dt_referencia_w				timestamp;
nr_seq_requisicao_proc_w	pls_requisicao_proc.nr_sequencia%type;
ie_tipo_intercambio_w		pls_regra_atend_retorno.ie_tipo_intercambio%type;
sg_estado_w					varchar(10);
sg_estado_operadora_w		varchar(10);
nr_seq_uni_exec_w			bigint;
ie_tipo_processo_w			varchar(5);
nr_seq_regra_retorno_w		bigint;
ie_gerou_glosa_w			varchar(1);
nr_seq_protocolo_ww			pls_protocolo_conta.nr_sequencia%type;
ie_profissional_participante_w	pls_regra_atend_retorno.ie_profissional_participante%type;
nr_seq_cbo_saude_part_w		cbo_saude.nr_sequencia%type;
cd_medico_part_w			pessoa_fisica.cd_pessoa_fisica%type;

C01 CURSOR FOR  -- Listar todos os procedimentos liberados da guia 
	SELECT	nr_sequencia,
		cd_procedimento,
		ie_origem_proced,
		qt_solicitada
	from	pls_guia_plano_proc
	where	nr_seq_guia	= nr_seq_guia_p;

C02 CURSOR FOR  -- Verificar se o procedimento ou a guia se encaixam na regra
	SELECT	qt_dia,
		coalesce(qt_horas,0),
		coalesce(qt_retorno,0),
		ie_regra,
		coalesce(ie_medico_prestador,'N'),
		coalesce(ie_conta_posterior,'N'),
		ie_tipo_guia,
		ie_reembolso,
		cd_especialidade,
		ie_busca_medico_nota_servico,
		nr_sequencia,
		coalesce(ie_profissional_participante, 'N')
	from	pls_regra_atend_retorno
	where	((cd_estabelecimento = coalesce(cd_estabelecimento_w,'0')) or coalesce(cd_estabelecimento::text, '') = '')
	and	((nr_seq_prestador = coalesce(nr_seq_prestador_w,0)) or coalesce(nr_seq_prestador::text, '') = '')
	and	((ie_tipo_guia = coalesce(ie_tipo_guia_w,'0')) or coalesce(ie_tipo_guia::text, '') = '')
	and	((cd_procedimento = coalesce(cd_procedimento_w,'0')) or coalesce(cd_procedimento::text, '') = '')
	and	((ie_origem_proced = coalesce(ie_origem_proced_w,0)) or coalesce(ie_origem_proced::text, '') = '')
	and	((cd_especialidade = coalesce(cd_especialidade_w,0)) or coalesce(cd_especialidade::text, '') = '')
	and	((ie_autorizacao = ie_autorizacao_w and ie_autorizacao_w = 'S')	or (ie_conta_medica = ie_conta_w and ie_conta_w = 'S')or (ie_reembolso = ie_reembolso_w and ie_reembolso_w = 'S'))
	and 	--restricao por ie_tipo_Segurado 
		(((coalesce(ie_beneficiario_sca ,'S') <> 'N') and (ie_tipo_segurado_w = 'A' )) or
		((coalesce(ie_beneficiario_ops,'S') <> 'N') and (ie_tipo_segurado_w = 'B' )) or
		((coalesce(ie_intercambio_congenere,'S') <> 'N') and (ie_tipo_segurado_w = 'C')) or
		((coalesce(ie_usuario_eventual,'S') <> 'N') and (ie_tipo_segurado_w in ('I','H'))) or
		((coalesce(ie_usuario_pericia,'S') <> 'N') and (ie_tipo_segurado_w = 'P')) or
		((coalesce(ie_repasse_operadora,'S') <> 'N') and (ie_tipo_segurado_w = 'R')) or
		((coalesce(ie_intercambio_coop,'S') <> 'N') and (ie_tipo_segurado_w = 'T')))
	and	(((ie_tipo_intercambio = 'A') or (coalesce(ie_tipo_intercambio::text, '') = '')) or (ie_tipo_intercambio = ie_tipo_intercambio_w))
	and (ie_situacao = 'A')
	order by
		coalesce(nr_seq_prestador,0),
		coalesce(ie_tipo_guia,'0'),
		coalesce(cd_procedimento,0),
		coalesce(cd_estabelecimento,0),
		coalesce(cd_especialidade,0);

C03 CURSOR FOR  --  Listar todos os procedimentos liberados da conta
	SELECT	a.nr_sequencia,
		a.cd_procedimento,
		a.ie_origem_proced,
		a.qt_procedimento_imp,
		coalesce(a.dt_procedimento, b.dt_atendimento_referencia)
	from	pls_conta_proc	a,
		pls_conta b
	where	nr_seq_conta	= nr_seq_conta_p
	and	a.nr_seq_conta = b.nr_sequencia;

C04 CURSOR FOR
	SELECT	distinct(a.cd_especialidade)
	from	pls_prestador_med_espec	a
	where	a.cd_pessoa_fisica	= cd_medico_w
	and	dt_referencia_w between ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(coalesce(a.dt_inicio_vigencia, dt_referencia_w)) and ESTABLISHMENT_TIMEZONE_UTILS.EndOfDay(coalesce(a.dt_fim_vigencia, dt_referencia_w))
	
union
  -- Deve retornar a especialidade do medicou OU do prestador, nunca os dois
	SELECT	distinct(a.cd_especialidade)
	from	pls_prestador_med_espec  a
	where	a.nr_seq_prestador	= nr_seq_prestador_w
	and	dt_referencia_w between ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(coalesce(a.dt_inicio_vigencia, dt_referencia_w)) and ESTABLISHMENT_TIMEZONE_UTILS.EndOfDay(coalesce(a.dt_fim_vigencia, dt_referencia_w))
	and	coalesce(cd_medico_w::text, '') = '';

C06 CURSOR FOR	
	SELECT	coalesce(sum(qt_procedimento_imp),0),
		a.nr_sequencia
	from	pls_conta		a,
		pls_conta_proc		b,
		pls_protocolo_conta	c
	where	a.nr_sequencia	   	= b.nr_seq_conta
	and	a.nr_seq_protocolo 	= c.nr_sequencia
	and	a.cd_estabelecimento	= cd_estabelecimento_w
	and	((coalesce(ie_tipo_guia_ww::text, '') = '') or (a.ie_tipo_guia = ie_tipo_guia_ww))-- OS346385 - askono, tipo de guia igual ao informado na regra
	and	((ie_medico_prestador_w	= 'S') or ( a.nr_seq_prestador_exec = nr_seq_prestador_w or coalesce(nr_seq_prestador_w::text, '') = '' ))
	and     a.nr_sequencia          <> nr_seq_conta_p
	and	a.nr_seq_segurado	= nr_seq_segurado_w
	and	b.cd_procedimento	= cd_procedimento_w
	and	b.ie_origem_proced	= ie_origem_proced_w
	and	((qt_hora_w = 0 and ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_procedimento_w) between ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(b.dt_procedimento) and ESTABLISHMENT_TIMEZONE_UTILS.EndOfDay(b.dt_procedimento + qt_dia_w)) or (qt_hora_w = 0 and (ie_conta_posterior_w = 'S') and (ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(b.dt_procedimento) between ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_procedimento_w) and ESTABLISHMENT_TIMEZONE_UTILS.EndOfDay(dt_procedimento_w + qt_dia_w))) or
		(qt_dia_w  = 0 and qt_hora_w > 0  and dt_procedimento_w between dt_procedimento and dt_procedimento + (qt_hora_w/24)))	--Diego OS 310162 - Modificado para ser verificado a dt proc em vez da dt emissao	
	and	((a.cd_medico_executor	= cd_medico_w) or ((coalesce(a.cd_medico_executor::text, '') = '') and (coalesce(cd_medico_w::text, '') = '') and (ie_profissional_participante_w = 'N') and
		((ie_busca_medico_nota_servico_w = 'N') or (coalesce(ie_busca_medico_nota_servico_w::text, '') = '') or (a.ie_origem_conta != 'A'))) or
		((ie_busca_medico_nota_servico_w = 'S') and (a.ie_origem_conta = 'A') and  exists (	SELECT	1
													from	ptu_nota_servico	x
													where	x.nr_seq_nota_cobr	= a.nr_seq_nota_cobranca
													and	x.sg_cons_prof_prest	= sg_cons_prof_prest_nota_w
													and	x.nr_cons_prof_prest	= nr_cons_prof_prest_nota_w
													and	x.sg_uf_cons_prest	= sg_uf_cons_prest_nota_w)) or
		((ie_profissional_participante_w = 'S') and exists (	select	1
									from	pls_proc_participante x
									where	x.nr_seq_conta_proc = b.nr_sequencia
									and	x.cd_medico = cd_medico_w)))	
	and	((a.ie_status in ('F','L','P','A')) or ((a.ie_origem_conta = 'P')and (c.ie_situacao != 'T') and (a.ie_status <> 'C'))) 
	and	ie_regra_w = 'M' -- Mesmo medico
	and (c.ie_situacao	in ('D','T') or c.nr_sequencia = nr_seq_protocolo_ww) -- Gilberto OS 946720 - apenas protocolos digitados ou integrados
	and (b.ie_glosa = 'N' or coalesce(b.ie_glosa::text, '') = '')/*Diego OS 302524 - Caso o item estaja glosado nao sera considerado na contagem*/
	and	((c.ie_tipo_protocolo = 'R' AND ie_reembolso_ww = 'S') or (ie_reembolso_ww = ie_reembolso_ww))
	and	((c.ie_situacao not in ('RE','I')) or (ie_origem_conta_w in ('P','A'))) --OS 445860, nao vai listar protocolos rejeitados e nem que nao foram aceitos ainda
	group by a.nr_sequencia	
	
union
	
	select	coalesce(sum(qt_procedimento_imp),0),
		a.nr_sequencia	
	from	pls_conta a,
		pls_conta_proc b,
		pls_diagnostico_conta c,
		pls_protocolo_conta	d
	where	a.nr_sequencia	= b.nr_seq_conta
	and	a.nr_sequencia	= c.nr_seq_conta
	and	d.nr_sequencia  = a.nr_seq_protocolo
	and	((d.ie_situacao not in ('RE','I')) or (ie_origem_conta_w in ('P','A')))
	and	a.cd_estabelecimento	= cd_estabelecimento_w
	and	((coalesce(ie_tipo_guia_ww::text, '') = '') or (a.ie_tipo_guia = ie_tipo_guia_ww))---- OS346385 - askono, tipo de guia igual ao informado na regra
	and	((ie_medico_prestador_w	= 'S') or ( a.nr_seq_prestador_exec = nr_seq_prestador_w or coalesce(nr_seq_prestador_w::text, '') = '' ))
	and	a.nr_sequencia 		<> nr_seq_conta_p
	and	a.nr_seq_segurado	= nr_seq_segurado_w
	and	b.cd_procedimento	= cd_procedimento_w
	and	b.ie_origem_proced	= ie_origem_proced_w
	and	((ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_procedimento_w) between ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(b.dt_procedimento) and ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(b.dt_procedimento + qt_dia_w)) or
		((ie_conta_posterior_w = 'S') and (ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(b.dt_procedimento) between ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_procedimento_w) and ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_procedimento_w + qt_dia_w))))--Diego OS 310162 - Modificado para ser verificado a dt proc em vez da dt emissao
	and	c.cd_doenca	= cd_cid_w
	and	((a.ie_status in ('F','L','P','A')) or ((a.ie_origem_conta = 'P')and (d.ie_situacao != 'T') and (a.ie_status <> 'C')))
	and 	ie_regra_w = 'C' --Mesmo CID10
	and (d.ie_situacao	in ('D','T') or d.nr_sequencia = nr_seq_protocolo_ww) -- Gilberto OS 946720 - apenas protocolos digitados ou integrados	
	and (b.ie_glosa = 'N' or coalesce(b.ie_glosa::text, '') = '')/*Diego OS 302524 - Caso o item estaja glosado nao sera considerado na contagem*/
	group by a.nr_sequencia	
	
union
	
	select	coalesce(sum(qt_procedimento_imp),0),
		a.nr_sequencia	
	from	pls_conta a,
		pls_conta_proc b,
		pls_diagnostico_conta c,
		pls_protocolo_conta   d
	where	a.nr_sequencia	= b.nr_seq_conta
	and	a.nr_sequencia	= c.nr_seq_conta
	and	d.nr_sequencia  = a.nr_seq_protocolo
	and	((d.ie_situacao not in ('RE','I')) or (ie_origem_conta_w in ('P','A')))
	and	a.cd_estabelecimento	= cd_estabelecimento_w
	and	((coalesce(ie_tipo_guia_ww::text, '') = '') or (a.ie_tipo_guia = ie_tipo_guia_ww))---- OS346385 - askono, tipo de guia igual ao informado na regra
	and	((ie_medico_prestador_w	= 'S') or ( a.nr_seq_prestador_exec = nr_seq_prestador_w or coalesce(nr_seq_prestador_w::text, '') = '' ))
	and	a.nr_sequencia 		<> nr_seq_conta_p
	and	a.nr_seq_segurado	= nr_seq_segurado_w
	and	b.cd_procedimento	= cd_procedimento_w
	and	b.ie_origem_proced	= ie_origem_proced_w
        and	((ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_procedimento_w) between ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(b.dt_procedimento) and ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(b.dt_procedimento + qt_dia_w)) or
		((ie_conta_posterior_w = 'S') and (ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(b.dt_procedimento) between ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_procedimento_w) and ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_procedimento_w + qt_dia_w))))--Diego OS 310162 - Modificado para ser verificado a dt proc em vez da dt emissao
	and	substr(obter_categoria_cid(c.cd_doenca),1,5)	= cd_categoria_w
	and	((a.ie_status in ('F','L','P','A')) or ((a.ie_origem_conta = 'P')and (d.ie_situacao != 'T') and (a.ie_status <> 'C') ))
	and 	ie_regra_w = 'T' --Mesma categoria CID10
	and (d.ie_situacao	in ('D','T') or d.nr_sequencia = nr_seq_protocolo_ww) -- Gilberto OS 946720 - apenas protocolos digitados ou integrados
	and (b.ie_glosa = 'N' or coalesce(b.ie_glosa::text, '') = '')/*Diego OS 302524 - Caso o item estaja glosado nao sera considerado na contagem*/
	group by a.nr_sequencia	
	
union

	select	coalesce(sum(qt_procedimento_imp),0),
		a.nr_sequencia	
	from	pls_conta 		a,
		pls_conta_proc 		b,
		pls_diagnostico_conta	c,
		pls_protocolo_conta	d
	where	a.nr_sequencia	= b.nr_seq_conta
	and	a.nr_sequencia	= c.nr_seq_conta
	and	d.nr_sequencia  = a.nr_seq_protocolo
	and	((d.ie_situacao not in ('RE','I')) or (ie_origem_conta_w in ('P','A')))
	and	a.cd_estabelecimento	= cd_estabelecimento_w
	and	((coalesce(ie_tipo_guia_ww::text, '') = '') or (a.ie_tipo_guia = ie_tipo_guia_ww))--
	and	((ie_medico_prestador_w	= 'S') or ( a.nr_seq_prestador_exec = nr_seq_prestador_w or coalesce(nr_seq_prestador_w::text, '') = '' ))
	and	a.nr_sequencia 		<> nr_seq_conta_p
	and	a.nr_seq_segurado	= nr_seq_segurado_w
	and	b.cd_procedimento	= cd_procedimento_w
	and	b.ie_origem_proced	= ie_origem_proced_w
	and	((ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_procedimento_w) between ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(b.dt_procedimento) and ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(b.dt_procedimento + qt_dia_w)) or
		((ie_conta_posterior_w = 'S') and (ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(b.dt_procedimento) between ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_procedimento_w) and ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_procedimento_w + qt_dia_w)))) --Diego OS 310162 - Modificado para ser verificado a dt proc em vez da dt emissao
	and	c.cd_doenca		= cd_cid_w
	and	((a.cd_medico_executor	= cd_medico_w) or ((coalesce(a.cd_medico_executor::text, '') = '') and (coalesce(cd_medico_w::text, '') = '') and (ie_profissional_participante_w = 'N') and
		((ie_busca_medico_nota_servico_w = 'N') or (coalesce(ie_busca_medico_nota_servico_w::text, '') = '') or (a.ie_origem_conta != 'A'))) or
		((ie_busca_medico_nota_servico_w = 'S') and (a.ie_origem_conta = 'A') and ( exists (	select	1
													from	ptu_nota_servico	x
													where	x.nr_seq_nota_cobr	= a.nr_seq_nota_cobranca
													and	x.sg_cons_prof_prest	= sg_cons_prof_prest_nota_w
													and	x.nr_cons_prof_prest	= nr_cons_prof_prest_nota_w
													and	x.sg_uf_cons_prest	= sg_uf_cons_prest_nota_w))) or
		((ie_profissional_participante_w = 'S') and  exists (	select	1
									from	pls_proc_participante x
									where	x.nr_seq_conta_proc = b.nr_sequencia
									and	x.cd_medico = cd_medico_w)))	
	and	((a.ie_status in ('F','L','P','A')) or ((a.ie_origem_conta = 'P')and (d.ie_situacao != 'T') and (a.ie_status <> 'C')))
	and	ie_regra_w = 'MC' --Mesmo medico e mesmo CID10
	and (d.ie_situacao	in ('D','T') or d.nr_sequencia = nr_seq_protocolo_ww) -- Gilberto OS 946720 - apenas protocolos digitados ou integrados
	and (b.ie_glosa = 'N' or coalesce(b.ie_glosa::text, '') = '') /*Diego OS 302524 - Caso o item estaja glosado nao sera considerado na contagem*/
	group by a.nr_sequencia
	
union
 
	select	coalesce(sum(qt_procedimento_imp),0),
		a.nr_sequencia	
	from	pls_conta a,
		pls_conta_proc b,
		pls_protocolo_conta c
	where	a.nr_sequencia	= b.nr_seq_conta
	and	c.nr_sequencia  = a.nr_seq_protocolo
	and	((c.ie_situacao not in ('RE','I')) or (ie_origem_conta_w in ('P','A')))
	and	a.cd_estabelecimento	= cd_estabelecimento_w
	and	((coalesce(ie_tipo_guia_ww::text, '') = '') or (a.ie_tipo_guia = ie_tipo_guia_ww))
	and	((ie_medico_prestador_w	= 'S') or ( a.nr_seq_prestador_exec = nr_seq_prestador_w or coalesce(nr_seq_prestador_w::text, '') = '' ))
	and	a.nr_sequencia 		<> nr_seq_conta_p
	and	a.nr_seq_segurado	= nr_seq_segurado_w
	and	b.cd_procedimento	= cd_procedimento_w
	and	b.ie_origem_proced	= ie_origem_proced_w
	and	((ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_procedimento_w) between ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(b.dt_procedimento) and ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(b.dt_procedimento + qt_dia_w)) or
		((ie_conta_posterior_w = 'S') and (ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(b.dt_procedimento) between ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_procedimento_w) and ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_procedimento_w + qt_dia_w)))) --Diego OS 310162 - Modificado para ser verificado a dt proc em vez da dt emissao
        and	((a.nr_seq_cbo_saude	= nr_seq_cbo_saude_w) or (ie_profissional_participante_w = 'S' and exists (	select	1
															from	pls_proc_participante x
															where	x.nr_seq_conta_proc = b.nr_sequencia
															and	x.nr_seq_cbo_saude = nr_seq_cbo_saude_w)))
	and	((a.cd_medico_executor	= cd_medico_w) or ((coalesce(a.cd_medico_executor::text, '') = '') and (coalesce(cd_medico_w::text, '') = '') and (ie_profissional_participante_w = 'N') and
		((ie_busca_medico_nota_servico_w = 'N') or (coalesce(ie_busca_medico_nota_servico_w::text, '') = '') or (a.ie_origem_conta != 'A'))) or
		((ie_busca_medico_nota_servico_w = 'S') and (a.ie_origem_conta = 'A') and ( exists (	select	1
													from	ptu_nota_servico	x
													where	x.nr_seq_nota_cobr	= a.nr_seq_nota_cobranca
													and	x.sg_cons_prof_prest	= sg_cons_prof_prest_nota_w
													and	x.nr_cons_prof_prest	= nr_cons_prof_prest_nota_w
													and	x.sg_uf_cons_prest	= sg_uf_cons_prest_nota_w))) or
		((ie_profissional_participante_w = 'S') and  exists (	select	1
									from	pls_proc_participante x
									where	x.nr_seq_conta_proc = b.nr_sequencia
									and	x.cd_medico = cd_medico_w)))	
	and	((a.ie_status in ('F','L','P','A')) or ((a.ie_origem_conta = 'P')and (c.ie_situacao != 'T') and (a.ie_status <> 'C')))
	and	ie_regra_w = 'MO' -- Mesmo medico e mesmo CBO
	and (c.ie_situacao	in ('D','T') or c.nr_sequencia = nr_seq_protocolo_ww)-- Gilberto OS 946720 - apenas protocolos digitados ou integrados
	and (b.ie_glosa = 'N' or coalesce(b.ie_glosa::text, '') = '')/*Diego OS 302524 - Caso o item estaja glosado nao sera considerado na contagem*/
	group by a.nr_sequencia
	
union
 
	select	coalesce(sum(qt_procedimento_imp),0),
		a.nr_sequencia	
	from	pls_conta 		a,
		pls_conta_proc 		b,
		pls_diagnostico_conta 	c,
		pls_protocolo_conta	d	
	where	a.nr_sequencia	= b.nr_seq_conta
	and	a.nr_sequencia	= c.nr_seq_conta
	and	d.nr_sequencia  = a.nr_seq_protocolo
	and	((d.ie_situacao not in ('RE','I')) or (ie_origem_conta_w in ('P','A')))
	and	a.cd_estabelecimento	= cd_estabelecimento_w
	and	((coalesce(ie_tipo_guia_ww::text, '') = '') or (a.ie_tipo_guia = ie_tipo_guia_ww))
	and	((ie_medico_prestador_w	= 'S') or ( a.nr_seq_prestador_exec = nr_seq_prestador_w or coalesce(nr_seq_prestador_w::text, '') = '' ))
	and	a.nr_sequencia 		<> nr_seq_conta_p
	and	a.nr_seq_segurado	= nr_seq_segurado_w
	and	b.cd_procedimento	= cd_procedimento_w
	and	b.ie_origem_proced	= ie_origem_proced_w
	and	a.nr_seq_cbo_saude	= nr_seq_cbo_saude_w
	and	((a.cd_medico_executor	= cd_medico_w) or ((coalesce(a.cd_medico_executor::text, '') = '') and (coalesce(cd_medico_w::text, '') = '') and (ie_profissional_participante_w = 'N') and
		((ie_busca_medico_nota_servico_w = 'N') or (coalesce(ie_busca_medico_nota_servico_w::text, '') = '') or (a.ie_origem_conta != 'A'))) or
		((ie_busca_medico_nota_servico_w = 'S') and (a.ie_origem_conta = 'A') and ( exists (	select	1
													from	ptu_nota_servico	x
													where	x.nr_seq_nota_cobr	= a.nr_seq_nota_cobranca
													and	x.sg_cons_prof_prest	= sg_cons_prof_prest_nota_w
													and	x.nr_cons_prof_prest	= nr_cons_prof_prest_nota_w
													and	x.sg_uf_cons_prest	= sg_uf_cons_prest_nota_w))) or
		((ie_profissional_participante_w = 'S') and  exists (	select	1
									from	pls_proc_participante x
									where	x.nr_seq_conta_proc = b.nr_sequencia
									and	x.cd_medico = cd_medico_w)))
	and	c.cd_doenca		= cd_cid_w
	and	((ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_procedimento_w) between ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(b.dt_procedimento) and ESTABLISHMENT_TIMEZONE_UTILS.StartOfDay(b.dt_procedimento + qt_dia_w)) or
		((ie_conta_posterior_w = 'S') and (ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(b.dt_procedimento) between ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_procedimento_w) and ESTABLISHMENT_TIMEZONE_UTILS.StartOfDay(dt_procedimento_w + qt_dia_w)))) --Diego OS 310162 - Modificado para ser verificado a dt proc em vez da dt emissao
	and	((a.ie_status in ('F','L','P','A')) or ((a.ie_origem_conta = 'P')and (d.ie_situacao != 'T') and (a.ie_status <> 'C')))
	and	ie_regra_w = 'MCO' -- Mesmo medico Mesmo CID10 e mesmo CBO
	and (d.ie_situacao	in ('D','T') or d.nr_sequencia = nr_seq_protocolo_ww) -- Gilberto OS 946720 - apenas protocolos digitados ou integrados
	and (b.ie_glosa = 'N' or coalesce(b.ie_glosa::text, '') = '')/*Diego OS 302524 - Caso o item estaja glosado nao sera considerado na contagem*/
	group by a.nr_sequencia;

C07 CURSOR FOR  -- Listar todos os procedimentos liberados da requisicao 
	SELECT	nr_sequencia,
		cd_procedimento,
		ie_origem_proced,
		qt_solicitado
	from	pls_requisicao_proc
	where	nr_seq_requisicao	= nr_seq_requisicao_p;	
	

BEGIN
if (coalesce(nr_seq_guia_p,0) > 0) then
	ie_autorizacao_w	:= 'S';
	
	select	ie_tipo_guia,
		cd_estabelecimento,
		nr_seq_prestador,
		cd_medico_solicitante,
		nr_seq_segurado,
		dt_solicitacao,
		cd_especialidade,
		nr_seq_uni_exec,
		ie_tipo_processo,
		nr_seq_cbo_saude
	into STRICT	ie_tipo_guia_w,
		cd_estabelecimento_w,
		nr_seq_prestador_w,
		cd_medico_w,
		nr_seq_segurado_w,
		dt_solicitacao_w,
		cd_especialidade_guia_w,
		nr_seq_uni_exec_w,
		ie_tipo_processo_w,
		nr_seq_cbo_saude_w
	from	pls_guia_plano
	where	nr_sequencia	= nr_seq_guia_p;
	
	dt_referencia_w	:= dt_solicitacao_w;

	/* tipo segurado*/

	begin
	select	ie_tipo_Segurado
	into STRICT 	ie_tipo_Segurado_w
	from 	pls_segurado
	where	nr_sequencia = nr_seq_segurado_w;
	exception
	when others then
		ie_tipo_Segurado_w	:= null;
	end;	
	
	select	coalesce(max(cd_doenca), '0')
	into STRICT	cd_cid_w
	from	pls_diagnostico
	where	nr_seq_guia	= nr_seq_guia_p
	and	coalesce(ie_classificacao, 'P')	= 'P';

	if (cd_cid_w <> '0') then
		select	cd_categoria_cid
		into STRICT	cd_categoria_w
		from 	cid_doenca
		where 	cd_doenca_cid	= cd_cid_w;
	end if;
	
	-- Quando o medico nao e informado, deve-se consultar pelo prestador (somente PF)
	if (coalesce(cd_medico_w::text, '') = '') then
		select	count(1)
		into STRICT	qt_especialidade_medica_w
		from	pls_prestador_med_espec  a,
			pls_prestador p
		where	a.nr_seq_prestador	= nr_seq_prestador_w
		and	p.nr_sequencia		= a.nr_seq_prestador
		and	(p.cd_pessoa_fisica IS NOT NULL AND p.cd_pessoa_fisica::text <> '') -- somente PF
		and	ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_referencia_w) between ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(coalesce(a.dt_inicio_vigencia, dt_referencia_w)) and ESTABLISHMENT_TIMEZONE_UTILS.EndOfDay(coalesce(a.dt_fim_vigencia, dt_referencia_w))  LIMIT 1;
	else
		select	count(1)
		into STRICT	qt_especialidade_medica_w
		from  	pls_prestador_med_espec  a
		where  	a.cd_pessoa_fisica  = cd_medico_w
		and  	ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_referencia_w) between ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(coalesce(a.dt_inicio_vigencia, dt_referencia_w)) and ESTABLISHMENT_TIMEZONE_UTILS.EndOfDay(coalesce(a.dt_fim_vigencia, dt_referencia_w))  LIMIT 1;
	end if;

	-- Obter a UF da operadora  - Tasy
	begin
		select  sg_estado
		into STRICT  	sg_estado_w
		from  	pessoa_juridica
		where  	cd_cgc  = (  	SELECT  cd_cgc_outorgante
					from  	pls_outorgante
					where  cd_estabelecimento  = cd_estabelecimento_w);
	exception
	when others then
		sg_estado_w  := 'X';
	end;

	-- Obter estado da operadora executora
	begin
		select  sg_estado
		into STRICT  	sg_estado_operadora_w
		from  	pls_congenere  a,
			pessoa_juridica  b
		where  	b.cd_cgc  = a.cd_cgc
		and  	a.nr_sequencia  = (  	SELECT  nr_seq_congenere
						from  pls_segurado
						where  nr_sequencia = nr_seq_segurado_w);
	exception
	when others then
		sg_estado_operadora_w  := 'X';
	end;

	if (coalesce(sg_estado_w,'X')  <> 'X') and (coalesce(sg_estado_operadora_w,'X') <> 'X') and (coalesce(ie_tipo_processo_w,'X')  = 'I')  then
		if (sg_estado_w  = sg_estado_operadora_w) then
			ie_tipo_intercambio_w  := 'E';
		else
			ie_tipo_intercambio_w  := 'N';
		end if;
	else
		ie_tipo_intercambio_w  := 'A';
	end if;
  
	open C01;
	loop
	fetch C01 into
		nr_seq_guia_plano_proc_w,
		cd_procedimento_w,
		ie_origem_proced_w,
		qt_solicitada_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	if (qt_especialidade_medica_w <> 0) then
		open C04;
		loop
		fetch C04 into
			cd_especialidade_w;
		EXIT WHEN NOT FOUND; /* apply on C04 */	
			qt_dia_w	:= 0;
			qt_hora_w	:= 0;
			qt_retorno_w	:= 0;
			open C02;
			loop
			fetch C02 into
				qt_dia_w,
				qt_hora_w,
				qt_retorno_w,
				ie_regra_w,
				ie_medico_prestador_w,
				ie_conta_posterior_w,
				ie_tipo_guia_ww,
				ie_reembolso_ww,
				cd_especialidade_w,
				ie_busca_medico_nota_servico_w,
				nr_seq_regra_retorno_w,
				ie_profissional_participante_w;
			EXIT WHEN NOT FOUND; /* apply on c02 */
			end loop;
			close c02;
			
			qt_reg_w	:= 0;
			qt_atend_retorno_w   := 0;
			if (qt_dia_w > 0) or (qt_hora_w > 0) then
				if (ie_regra_w = 'M') then --Mesmo medico          
					select  count(1),
						coalesce(sum(qt_solicitada),0)
					into STRICT  	qt_atend_retorno_w,
						qt_reg_w
					from  	pls_guia_plano a,
						pls_guia_plano_proc b
					where  	a.nr_sequencia = b.nr_seq_guia
					and  	a.cd_estabelecimento  = cd_estabelecimento_w
					and  	a.ie_tipo_guia    = ie_tipo_guia_w
					and  	a.nr_seq_prestador  = nr_seq_prestador_w
					and  	a.nr_sequencia     <> nr_seq_guia_p
					and  	a.nr_seq_segurado  = nr_seq_segurado_w
					and  	b.cd_procedimento  = cd_procedimento_w
					and  	b.ie_origem_proced  = ie_origem_proced_w
					and  	((qt_hora_w = 0 and to_date(dt_solicitacao_w,'dd/mm/rrrr hh24:mi:ss') between to_date(a.dt_solicitacao,'dd/mm/rrrr hh24:mi:ss') and to_date(a.dt_solicitacao + qt_dia_w,'dd/mm/rrrr hh24:mi:ss'))
					or  	(qt_dia_w  = 0 and qt_hora_w > 0  and dt_solicitacao_w between a.dt_solicitacao and a.dt_solicitacao + (qt_hora_w/24)))
					and  	a.cd_medico_solicitante  = cd_medico_w
					and  	a.ie_status <> 3
					and  	b.ie_status not in ('K', 'M', 'N', 'U', 'D'); /*Diego OS 302524 - Caso o item estaja glosado nao sera considerado na contagem*/
 -- Djavan OS 741747 - O item em Usuario (aguardando acao) tambem nao deve ser considerado                          
		
					qt_reg_w  := (qt_reg_w + qt_solicitada_w);
				elsif (ie_regra_w = 'C') then --Mesmo CID10
					select  count(1),
						coalesce(sum(qt_solicitada),0)
					into STRICT  	qt_atend_retorno_w,
						qt_reg_w
					from  	pls_guia_plano a,
						pls_guia_plano_proc b,
						pls_diagnostico c
					where  	a.nr_sequencia  = b.nr_seq_guia
					and  	a.nr_sequencia  = c.nr_seq_guia
					and  	a.cd_estabelecimento  = cd_estabelecimento_w
					and  	a.ie_tipo_guia    = ie_tipo_guia_w
					and  	a.nr_seq_prestador  = nr_seq_prestador_w
					and  	a.nr_sequencia     <> nr_seq_guia_p
					and  	a.nr_seq_segurado  = nr_seq_segurado_w
					and  	b.cd_procedimento  = cd_procedimento_w
					and  	b.ie_origem_proced  = ie_origem_proced_w
					and  	((qt_hora_w = 0 and to_date(dt_solicitacao_w,'dd/mm/rrrr hh24:mi:ss') between to_date(a.dt_solicitacao,'dd/mm/rrrr hh24:mi:ss') and to_date(a.dt_solicitacao + qt_dia_w,'dd/mm/rrrr hh24:mi:ss'))
					or  	(qt_dia_w  = 0 and qt_hora_w > 0  and dt_solicitacao_w between a.dt_solicitacao and a.dt_solicitacao + (qt_hora_w/24)))
					--and  trunc(dt_solicitacao_w)  between trunc(dt_solicitacao,'dd') and fim_dia(dt_solicitacao + qt_dia_w)
					and  	c.cd_doenca  = cd_cid_w
					and  	a.ie_status <> 3
					and  	b.ie_status not in ('K', 'M', 'N', 'U', 'D'); /*Diego OS 302524 - Caso o item estaja glosado nao sera considerado na contagem*/
-- Djavan OS 741747 - O item em Usuario (aguardando acao) tambem nao deve ser considerado
					qt_reg_w  := (qt_reg_w + qt_solicitada_w);
				elsif (ie_regra_w = 'T') then --Mesma categoria CID10
					select  count(1),
						coalesce(sum(qt_solicitada),0)
					into STRICT  	qt_atend_retorno_w,
						qt_reg_w
					from  	pls_guia_plano a,
						pls_guia_plano_proc b,
						pls_diagnostico c
					where  	a.nr_sequencia  = b.nr_seq_guia
					and  	a.nr_sequencia  = c.nr_seq_guia
					and  	a.cd_estabelecimento  = cd_estabelecimento_w
					and  	a.ie_tipo_guia    = ie_tipo_guia_w
					and  	a.nr_seq_prestador  = nr_seq_prestador_w
					and  	a.nr_sequencia     <> nr_seq_guia_p
					and  	a.nr_seq_segurado  = nr_seq_segurado_w
					and  	b.cd_procedimento  = cd_procedimento_w
					and  	b.ie_origem_proced  = ie_origem_proced_w
					and  	((qt_hora_w = 0 and to_date(dt_solicitacao_w,'dd/mm/rrrr hh24:mi:ss') between to_date(a.dt_solicitacao,'dd/mm/rrrr hh24:mi:ss') and to_date(a.dt_solicitacao + qt_dia_w,'dd/mm/rrrr hh24:mi:ss'))
					or  	(qt_dia_w  = 0 and qt_hora_w > 0  and dt_solicitacao_w between a.dt_solicitacao and a.dt_solicitacao + (qt_hora_w/24)))
					and  	substr(obter_categoria_cid(c.cd_doenca),1,5)  = cd_categoria_w
					and  	a.ie_status <> 3
					and  	b.ie_status not in ('K', 'M', 'N', 'U', 'D'); /*Diego OS 302524 - Caso o item estaja glosado nao sera considerado na contagem*/
-- Djavan OS 741747 - O item em Usuario (aguardando acao) tambem nao deve ser considerado
		
					qt_reg_w  := (qt_reg_w + qt_solicitada_w);
				elsif (ie_regra_w = 'MC') then
					select  count(1),
						coalesce(sum(qt_solicitada),0)
					into STRICT  	qt_atend_retorno_w,
						qt_reg_w
					from  	pls_guia_plano a,
						pls_guia_plano_proc b,
						pls_diagnostico c
					where  	a.nr_sequencia  = b.nr_seq_guia
					and  	a.nr_sequencia  = c.nr_seq_guia
					and  	a.cd_estabelecimento  = cd_estabelecimento_w
					and  	a.ie_tipo_guia    = ie_tipo_guia_w
					and  	a.nr_seq_prestador  = nr_seq_prestador_w
					and  	a.nr_sequencia     <> nr_seq_guia_p
					and  	a.nr_seq_segurado  = nr_seq_segurado_w
					and  	b.cd_procedimento  = cd_procedimento_w
					and  	b.ie_origem_proced  = ie_origem_proced_w
					and  	((qt_hora_w = 0 and to_date(dt_solicitacao_w,'dd/mm/rrrr hh24:mi:ss') between to_date(a.dt_solicitacao,'dd/mm/rrrr hh24:mi:ss') and to_date(a.dt_solicitacao + qt_dia_w,'dd/mm/rrrr hh24:mi:ss'))
					or  	(qt_dia_w  = 0 and qt_hora_w > 0  and dt_solicitacao_w between a.dt_solicitacao and a.dt_solicitacao + (qt_hora_w/24)))
					and  	c.cd_doenca    = cd_cid_w
					and  	a.cd_medico_solicitante  = cd_medico_w
					and  	a.ie_status <> 3
					and  	b.ie_status not in ('K', 'M', 'N', 'U', 'D'); /*Diego OS 302524 - Caso o item estaja glosado nao sera considerado na contagem*/
-- Djavan OS 741747 - O item em Usuario (aguardando acao) tambem nao deve ser considerado
					qt_reg_w  := (qt_reg_w + qt_solicitada_w);
				elsif (ie_regra_w = 'MO') then
					select  count(1),
						coalesce(sum(qt_solicitada),0)
					into STRICT  	qt_atend_retorno_w,
						qt_reg_w
					from  	pls_guia_plano a,
						pls_guia_plano_proc b
					where  	a.nr_sequencia = b.nr_seq_guia
					and  	a.cd_estabelecimento  = cd_estabelecimento_w
					and  	a.ie_tipo_guia    = ie_tipo_guia_w
					and  	a.nr_seq_prestador  = nr_seq_prestador_w
					and  	a.nr_sequencia     <> nr_seq_guia_p
					and  	a.nr_seq_segurado  = nr_seq_segurado_w
					and  	b.cd_procedimento  = cd_procedimento_w
					and  	b.ie_origem_proced  = ie_origem_proced_w
					and  	((qt_hora_w = 0 and to_date(dt_solicitacao_w,'dd/mm/rrrr hh24:mi:ss') between to_date(a.dt_solicitacao,'dd/mm/rrrr hh24:mi:ss') and to_date(a.dt_solicitacao + qt_dia_w,'dd/mm/rrrr hh24:mi:ss'))
					or  	(qt_dia_w  = 0 and qt_hora_w > 0  and dt_solicitacao_w between a.dt_solicitacao and a.dt_solicitacao + (qt_hora_w/24)))
					and  	a.cd_medico_solicitante  = cd_medico_w
					and (a.cd_especialidade   = cd_especialidade_guia_w
					or  	a.nr_seq_cbo_saude  = nr_seq_cbo_saude_w)
					and  	a.ie_status <> 3
					and  	b.ie_status not in ('K', 'M', 'N', 'U', 'D'); /*Diego OS 302524 - Caso o item estaja glosado nao sera considerado na contagem*/
-- Djavan OS 741747 - O item em Usuario (aguardando acao) tambem nao deve ser considerado
					qt_reg_w  := (qt_reg_w + qt_solicitada_w);

				elsif (ie_regra_w = 'MCO') then
					select  count(1),            
						coalesce(sum(qt_solicitada),0)
					into STRICT  	qt_atend_retorno_w,
						qt_reg_w
					from  	pls_guia_plano a,
						pls_guia_plano_proc b,
						pls_diagnostico c
					where  	a.nr_sequencia  = b.nr_seq_guia
					and  	a.nr_sequencia  = c.nr_seq_guia
					and  	a.cd_estabelecimento  = cd_estabelecimento_w
					and  	a.ie_tipo_guia    = ie_tipo_guia_w
					and  	a.nr_seq_prestador  = nr_seq_prestador_w
					and  	a.nr_sequencia     <> nr_seq_guia_p
					and  	a.nr_seq_segurado  = nr_seq_segurado_w
					and  	b.cd_procedimento  = cd_procedimento_w
					and  	b.ie_origem_proced  = ie_origem_proced_w
					and  	((qt_hora_w = 0 and to_date(dt_solicitacao_w,'dd/mm/rrrr hh24:mi:ss') between to_date(a.dt_solicitacao,'dd/mm/rrrr hh24:mi:ss') and to_date(a.dt_solicitacao + qt_dia_w,'dd/mm/rrrr hh24:mi:ss'))
					or  	(qt_dia_w  = 0 and qt_hora_w > 0  and dt_solicitacao_w between a.dt_solicitacao and a.dt_solicitacao + (qt_hora_w/24)))
					and  	c.cd_doenca    = cd_cid_w
					and  	a.cd_medico_solicitante  = cd_medico_w
					and (a.cd_especialidade   = cd_especialidade_guia_w
					or  	a.nr_seq_cbo_saude  = nr_seq_cbo_saude_w)
					and  	a.ie_status <> 3
					and  	b.ie_status not in ('K', 'M', 'N', 'U', 'D');-- Djavan OS 741747 - O item em Usuario (aguardando acao) tambem nao deve ser considerado 
					qt_reg_w  := (qt_reg_w + qt_solicitada_w);
				end if;
	
				if  (qt_reg_w > qt_retorno_w AND qt_retorno_w > 0) then				
					CALL pls_gravar_motivo_glosa('1601', null, nr_seq_guia_plano_proc_w, null, '' ,nm_usuario_p,'','CG',nr_seq_prestador_w, null,null);
				end if;
				
				if (qt_atend_retorno_w > 0) then
					if (qt_dia_w > 0) then
						CALL pls_gravar_motivo_glosa('9907', null, nr_seq_guia_plano_proc_w, null, 'Procedimento solicitado a menos de ' || qt_dia_w || ' dias ',nm_usuario_p,'',ie_evento_p,nr_seq_prestador_w, null,null);
					elsif (qt_hora_w > 0) then
						CALL pls_gravar_motivo_glosa('9907', null, nr_seq_guia_plano_proc_w, null, 'Procedimento solicitado a menos de ' || qt_hora_w || ' horas ',nm_usuario_p,'',ie_evento_p,nr_seq_prestador_w, null,null);
					end if;
				end if;
			end if;
		end loop;
		close C04;
	else
		cd_especialidade_w  := null;
		qt_dia_w	:= 0;
		qt_hora_w	:= 0;
		qt_retorno_w	:= 0;
		open C02;
		loop
		fetch C02 into
			qt_dia_w,
			qt_hora_w,
			qt_retorno_w,
			ie_regra_w,
			ie_medico_prestador_w,
			ie_conta_posterior_w,
			ie_tipo_guia_ww,
			ie_reembolso_ww,
			cd_especialidade_w,
			ie_busca_medico_nota_servico_w,
			nr_seq_regra_retorno_w,
			ie_profissional_participante_w;
		EXIT WHEN NOT FOUND; /* apply on c02 */
		end loop;
		close c02;

		qt_reg_w     := 0;
		qt_atend_retorno_w   := 0;

		if (qt_dia_w > 0) or (qt_hora_w > 0) then
			if (ie_regra_w = 'M') then --Mesmo medico          
				select  count(1),
					coalesce(sum(qt_solicitada),0)
				into STRICT  	qt_atend_retorno_w,
					qt_reg_w
				from  	pls_guia_plano a,
					pls_guia_plano_proc b
				where  	a.nr_sequencia = b.nr_seq_guia
				and  	a.cd_estabelecimento  = cd_estabelecimento_w
				and  	a.ie_tipo_guia    = ie_tipo_guia_w
				and  	a.nr_seq_prestador  = nr_seq_prestador_w
				and  	a.nr_sequencia     <> nr_seq_guia_p
				and  	a.nr_seq_segurado  = nr_seq_segurado_w
				and  	b.cd_procedimento  = cd_procedimento_w
				and  	b.ie_origem_proced  = ie_origem_proced_w
				and  	((qt_hora_w = 0 and to_date(dt_solicitacao_w,'dd/mm/rrrr hh24:mi:ss') between to_date(a.dt_solicitacao,'dd/mm/rrrr hh24:mi:ss') and to_date(a.dt_solicitacao + qt_dia_w,'dd/mm/rrrr hh24:mi:ss'))
				or  	(qt_dia_w  = 0 and qt_hora_w > 0  and dt_solicitacao_w between a.dt_solicitacao and a.dt_solicitacao + (qt_hora_w/24)))
				and  	a.cd_medico_solicitante  = cd_medico_w
				and  	a.ie_status <> 3
				and  	b.ie_status not in ('K', 'M', 'N', 'U', 'D'); /*Diego OS 302524 - Caso o item estaja glosado nao sera considerado na contagem*/
-- Djavan OS 741747 - O item em Usuario (aguardando acao) tambem nao deve ser considerado
				qt_reg_w  := (qt_reg_w + qt_solicitada_w);
			elsif (ie_regra_w = 'C') then --Mesmo CID10
				select  count(1),
					coalesce(sum(qt_solicitada),0)
				into STRICT  	qt_atend_retorno_w,
					qt_reg_w
				from  	pls_guia_plano a,
					pls_guia_plano_proc b,
					pls_diagnostico c
				where  	a.nr_sequencia  = b.nr_seq_guia
				and  	a.nr_sequencia  = c.nr_seq_guia
				and  	a.cd_estabelecimento  = cd_estabelecimento_w
				and  	a.ie_tipo_guia    = ie_tipo_guia_w
				and  	a.nr_seq_prestador  = nr_seq_prestador_w
				and  	a.nr_sequencia     <> nr_seq_guia_p
				and  	a.nr_seq_segurado  = nr_seq_segurado_w
				and  	b.cd_procedimento  = cd_procedimento_w
				and  	b.ie_origem_proced  = ie_origem_proced_w
				and  	((qt_hora_w = 0 and to_date(dt_solicitacao_w,'dd/mm/rrrr hh24:mi:ss') between to_date(a.dt_solicitacao,'dd/mm/rrrr hh24:mi:ss') and to_date(a.dt_solicitacao + qt_dia_w,'dd/mm/rrrr hh24:mi:ss'))
				or  	(qt_dia_w  = 0 and qt_hora_w > 0  and dt_solicitacao_w between a.dt_solicitacao and a.dt_solicitacao + (qt_hora_w/24)))
				--and	trunc(dt_solicitacao_w)  between trunc(dt_solicitacao,'dd') and fim_dia(dt_solicitacao + qt_dia_w)
				and  	c.cd_doenca  = cd_cid_w
				and  	a.ie_status <> 3
				and  	b.ie_status not in ('K', 'M', 'N', 'U', 'D'); /*Diego OS 302524 - Caso o item estaja glosado nao sera considerado na contagem*/
-- Djavan OS 741747 - O item em Usuario (aguardando acao) tambem nao deve ser considerado
				qt_reg_w  := (qt_reg_w + qt_solicitada_w);
			elsif (ie_regra_w = 'T') then --Mesma categoria CID10
				select  count(1),
					coalesce(sum(qt_solicitada),0)
				into STRICT  	qt_atend_retorno_w,
					qt_reg_w
				from  	pls_guia_plano a,
					pls_guia_plano_proc b,
					pls_diagnostico c
				where  	a.nr_sequencia  = b.nr_seq_guia
				and  	a.nr_sequencia  = c.nr_seq_guia
				and  	a.cd_estabelecimento  = cd_estabelecimento_w
				and  	a.ie_tipo_guia    = ie_tipo_guia_w
				and  	a.nr_seq_prestador  = nr_seq_prestador_w
				and  	a.nr_sequencia     <> nr_seq_guia_p
				and  	a.nr_seq_segurado  = nr_seq_segurado_w
				and  	b.cd_procedimento  = cd_procedimento_w
				and  	b.ie_origem_proced  = ie_origem_proced_w
				and  	((qt_hora_w = 0 and to_date(dt_solicitacao_w,'dd/mm/rrrr hh24:mi:ss') between to_date(a.dt_solicitacao,'dd/mm/rrrr hh24:mi:ss') and to_date(a.dt_solicitacao + qt_dia_w,'dd/mm/rrrr hh24:mi:ss'))
				or  	(qt_dia_w  = 0 and qt_hora_w > 0  and dt_solicitacao_w between a.dt_solicitacao and a.dt_solicitacao + (qt_hora_w/24)))
				and  	substr(obter_categoria_cid(c.cd_doenca),1,5)  = cd_categoria_w
				and  	a.ie_status <> 3
				and  	b.ie_status not in ('K', 'M', 'N', 'U', 'D'); /*Diego OS 302524 - Caso o item estaja glosado nao sera considerado na contagem*/
-- Djavan OS 741747 - O item em Usuario (aguardando acao) tambem nao deve ser considerado
				qt_reg_w  := (qt_reg_w + qt_solicitada_w);
			elsif (ie_regra_w = 'MC') then
				select  count(1),
					coalesce(sum(qt_solicitada),0)
				into STRICT  	qt_atend_retorno_w,
					qt_reg_w
				from  	pls_guia_plano a,
					pls_guia_plano_proc b,
					pls_diagnostico c
				where  	a.nr_sequencia  = b.nr_seq_guia
				and  	a.nr_sequencia  = c.nr_seq_guia
				and  	a.cd_estabelecimento  = cd_estabelecimento_w
				and  	a.ie_tipo_guia    = ie_tipo_guia_w
				and  	a.nr_seq_prestador  = nr_seq_prestador_w
				and  	a.nr_sequencia     <> nr_seq_guia_p
				and  	a.nr_seq_segurado  = nr_seq_segurado_w
				and  	b.cd_procedimento  = cd_procedimento_w
				and  	b.ie_origem_proced  = ie_origem_proced_w
				and  	((qt_hora_w = 0 and to_date(dt_solicitacao_w,'dd/mm/rrrr hh24:mi:ss') between to_date(a.dt_solicitacao,'dd/mm/rrrr hh24:mi:ss') and to_date(a.dt_solicitacao + qt_dia_w,'dd/mm/rrrr hh24:mi:ss'))
				or  	(qt_dia_w  = 0 and qt_hora_w > 0  and dt_solicitacao_w between a.dt_solicitacao and a.dt_solicitacao + (qt_hora_w/24)))
				and  	c.cd_doenca    = cd_cid_w
				and  	a.cd_medico_solicitante  = cd_medico_w
				and  	a.ie_status <> 3
				and  	b.ie_status not in ('K', 'M', 'N', 'U', 'D'); /*Diego OS 302524 - Caso o item estaja glosado nao sera considerado na contagem*/
-- Djavan OS 741747 - O item em Usuario (aguardando acao) tambem nao deve ser considerado
				qt_reg_w  := (qt_reg_w + qt_solicitada_w);
			elsif (ie_regra_w = 'MO') then
				select  count(1),
					coalesce(sum(qt_solicitada),0)
				into STRICT  	qt_atend_retorno_w,
					qt_reg_w
				from 	pls_guia_plano a,
					pls_guia_plano_proc b
				where  	a.nr_sequencia = b.nr_seq_guia
				and  	a.cd_estabelecimento  = cd_estabelecimento_w
				and  	a.ie_tipo_guia    = ie_tipo_guia_w
				and  	a.nr_seq_prestador  = nr_seq_prestador_w
				and  	a.nr_sequencia     <> nr_seq_guia_p
				and  	a.nr_seq_segurado  = nr_seq_segurado_w
				and  	b.cd_procedimento  = cd_procedimento_w
				and  	b.ie_origem_proced  = ie_origem_proced_w
				and  	((qt_hora_w = 0 and to_date(dt_solicitacao_w,'dd/mm/rrrr hh24:mi:ss') between to_date(a.dt_solicitacao,'dd/mm/rrrr hh24:mi:ss') and to_date(a.dt_solicitacao + qt_dia_w,'dd/mm/rrrr hh24:mi:ss'))
				or  	(qt_dia_w  = 0 and qt_hora_w > 0  and dt_solicitacao_w between a.dt_solicitacao and a.dt_solicitacao + (qt_hora_w/24)))
				and  	a.cd_medico_solicitante  = cd_medico_w
				and  	a.cd_especialidade   = cd_especialidade_guia_w
				and  	a.ie_status <> 3
				and  	b.ie_status not in ('K', 'M', 'N', 'U', 'D'); /*Diego OS 302524 - Caso o item estaja glosado nao sera considerado na contagem*/
-- Djavan OS 741747 - O item em Usuario (aguardando acao) tambem nao deve ser considerado
				qt_reg_w  := (qt_reg_w + qt_solicitada_w);
			elsif (ie_regra_w = 'MCO') then
				select  count(1),            
					coalesce(sum(qt_solicitada), 0)
				into STRICT  	qt_atend_retorno_w,
					qt_reg_w
				from  	pls_guia_plano a,
					pls_guia_plano_proc b,
					pls_diagnostico c
				where  	a.nr_sequencia  = b.nr_seq_guia
				and  	a.nr_sequencia  = c.nr_seq_guia
				and  	a.cd_estabelecimento  = cd_estabelecimento_w
				and  	a.ie_tipo_guia    = ie_tipo_guia_w
				and  	a.nr_seq_prestador  = nr_seq_prestador_w
				and  	a.nr_sequencia     <> nr_seq_guia_p
				and  	a.nr_seq_segurado  = nr_seq_segurado_w
				and  	b.cd_procedimento  = cd_procedimento_w
				and  	b.ie_origem_proced  = ie_origem_proced_w
				and  	((qt_hora_w = 0 and to_date(dt_solicitacao_w,'dd/mm/rrrr hh24:mi:ss') between to_date(a.dt_solicitacao,'dd/mm/rrrr hh24:mi:ss') and to_date(a.dt_solicitacao + qt_dia_w,'dd/mm/rrrr hh24:mi:ss'))
				or  	(qt_dia_w  = 0 and qt_hora_w > 0  and dt_solicitacao_w between a.dt_solicitacao and a.dt_solicitacao + (qt_hora_w/24)))
				and  	c.cd_doenca    = cd_cid_w
				and  	a.cd_medico_solicitante  = cd_medico_w
				and  	a.cd_especialidade   = cd_especialidade_guia_w
				and  	a.ie_status <> 3
				and  	b.ie_status not in ('K', 'M', 'N', 'U', 'D');-- Djavan OS 741747 - O item em Usuario (aguardando acao) tambem nao deve ser considerado 
				qt_reg_w  := (qt_reg_w + qt_solicitada_w);
			end if;

			if  (qt_reg_w > qt_retorno_w AND qt_retorno_w > 0) then
				CALL pls_gravar_motivo_glosa('1601', null, nr_seq_guia_plano_proc_w, null, '' ,nm_usuario_p,'','CG',nr_seq_prestador_w, null,null);
			end if;
	
			if (qt_atend_retorno_w > 0) then
				if (qt_dia_w > 0) then
					CALL pls_gravar_motivo_glosa('9907', null, nr_seq_guia_plano_proc_w, null, 'Procedimento solicitado a menos de ' || qt_dia_w || ' dias ',nm_usuario_p,'',ie_evento_p,nr_seq_prestador_w, null,null);
				elsif (qt_hora_w > 0) then
					CALL pls_gravar_motivo_glosa('9907', null, nr_seq_guia_plano_proc_w, null, 'Procedimento solicitado a menos de ' || qt_hora_w || ' horas ',nm_usuario_p,'',ie_evento_p,nr_seq_prestador_w, null,null);
				end if;
			end if;
		end if;
	end if;
	end;
	end loop;
	close C01;

elsif (coalesce(nr_seq_requisicao_p,0) > 0) then
	ie_autorizacao_w  := 'S';

	select  ie_tipo_guia,
		cd_estabelecimento,
		nr_seq_prestador,
		cd_medico_solicitante,
		nr_seq_segurado,
		dt_requisicao,
		cd_especialidade,
		nr_seq_uni_exec,
		ie_tipo_processo,
		nr_seq_cbo_saude
	into STRICT  	ie_tipo_guia_w,
		cd_estabelecimento_w,
		nr_seq_prestador_w,
		cd_medico_w,
		nr_seq_segurado_w,
		dt_solicitacao_w,
		cd_especialidade_guia_w,
		nr_seq_uni_exec_w,
		ie_tipo_processo_w,
		nr_seq_cbo_saude_w
	from  	pls_requisicao
	where  	nr_sequencia  = nr_seq_requisicao_p;

	dt_referencia_w  := dt_solicitacao_w;

	/* tipo segurado*/

	begin
		select  ie_tipo_segurado
		into STRICT   	ie_tipo_segurado_w
		from   	pls_segurado
		where  	nr_sequencia = nr_seq_segurado_w;
	exception
	when others then
		ie_tipo_segurado_w  := null;
	end;
  
	select  coalesce(max(cd_doenca), '0')
	into STRICT  	cd_cid_w
	from  	pls_requisicao_diagnostico
	where  	nr_seq_requisicao  = nr_seq_requisicao_p
	and  	coalesce(ie_classificacao, 'P')  = 'P';

	if (cd_cid_w <> '0') then
		select  cd_categoria_cid
		into STRICT  	cd_categoria_w
		from   	cid_doenca
		where   cd_doenca_cid  = cd_cid_w;
	end if;

	-- quando o medico nao e informado, deve-se consultar pelo prestador (somente PF)
	if (coalesce(cd_medico_w::text, '') = '') then
		select	count(1)
		into STRICT  	qt_especialidade_medica_w
		from  	pls_prestador_med_espec    a,
			pls_prestador      p
		where  	a.nr_seq_prestador  = nr_seq_prestador_w
		and  	p.nr_sequencia    = a.nr_seq_prestador
		and  	(p.cd_pessoa_fisica IS NOT NULL AND p.cd_pessoa_fisica::text <> '') -- somente PF
		and  	dt_referencia_w between ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(coalesce(a.dt_inicio_vigencia, dt_referencia_w)) and ESTABLISHMENT_TIMEZONE_UTILS.EndOfDay(coalesce(a.dt_fim_vigencia, dt_referencia_w))  LIMIT 1;
	else
		select  count(1)
		into STRICT  	qt_especialidade_medica_w
		from  	pls_prestador_med_espec  a
		where 	a.cd_pessoa_fisica  = cd_medico_w
		and  	dt_referencia_w between ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(coalesce(a.dt_inicio_vigencia, dt_referencia_w)) and ESTABLISHMENT_TIMEZONE_UTILS.EndOfDay(coalesce(a.dt_fim_vigencia, dt_referencia_w))  LIMIT 1;
	end if;

	-- Obter a UF da operadora  - Tasy
	begin
		select  sg_estado
		into STRICT  	sg_estado_w
		from  	pessoa_juridica
		where  	cd_cgc  = (  	SELECT  cd_cgc_outorgante
					from  	pls_outorgante
					where  	cd_estabelecimento  = cd_estabelecimento_w);
	exception
	when others then
		sg_estado_w  := 'X';
	end;

	-- Obter estado da operadora executora
	begin
	select  sg_estado
	into STRICT  	sg_estado_operadora_w
	from  	pls_congenere  a,
		pessoa_juridica  b
	where  	b.cd_cgc  = a.cd_cgc
	and  	a.nr_sequencia  = (  	SELECT  nr_seq_congenere
					from  	pls_segurado
					where  	nr_sequencia = nr_seq_segurado_w);
	exception
	when others then
		sg_estado_operadora_w  := 'X';
	end;

	if (coalesce(sg_estado_w,'X')  <> 'X') and (coalesce(sg_estado_operadora_w,'X') <> 'X') and (coalesce(ie_tipo_processo_w,'X')  = 'I')  then
		if (sg_estado_w  = sg_estado_operadora_w) then
			ie_tipo_intercambio_w  := 'E';
		else
			ie_tipo_intercambio_w  := 'N';
		end if;
	else
		ie_tipo_intercambio_w  := 'A';
	end if;

	open C07;
	loop
	fetch C07 into
		nr_seq_requisicao_proc_w,
		cd_procedimento_w,
		ie_origem_proced_w,
		qt_solicitada_w;
	EXIT WHEN NOT FOUND; /* apply on C07 */
	begin	
		if (qt_especialidade_medica_w <> 0) then			
			cd_especialidade_w	:= cd_especialidade_guia_w;
			qt_dia_w		:= 0;
			qt_hora_w		:= 0;
			qt_retorno_w		:= 0;
			open C02;
			loop
			fetch C02 into
				qt_dia_w,	
				qt_hora_w,
				qt_retorno_w,
				ie_regra_w,
				ie_medico_prestador_w,
				ie_conta_posterior_w,
				ie_tipo_guia_ww,
				ie_reembolso_ww,
				cd_especialidade_w,
				ie_busca_medico_nota_servico_w,
				nr_seq_regra_retorno_w,
				ie_profissional_participante_w;
			EXIT WHEN NOT FOUND; /* apply on C02 */   			
				ie_gerou_glosa_w	:= 'N';				
				qt_reg_w     := 0;
				qt_atend_retorno_w   := 0;
		
				if (qt_dia_w > 0) or (qt_hora_w > 0) then
					if (ie_regra_w = 'M') then --Mesmo medico          
						select  count(1),
							coalesce(sum(qt_solicitado),0)							
						into STRICT  	qt_atend_retorno_w,
							qt_reg_w
						from  	pls_requisicao a,
							pls_requisicao_proc b
						where  	a.nr_sequencia    = b.nr_seq_requisicao
						and  	a.cd_estabelecimento  = cd_estabelecimento_w
						and  	a.ie_tipo_guia    = ie_tipo_guia_w
						and  	a.nr_seq_prestador  = nr_seq_prestador_w
						and  	a.nr_sequencia     <> nr_seq_requisicao_p
						and  	a.nr_seq_segurado  = nr_seq_segurado_w
						and  	b.cd_procedimento  = cd_procedimento_w
						and  	b.ie_origem_proced  = ie_origem_proced_w
						and  	((qt_hora_w = 0 and to_date(dt_solicitacao_w,'dd/mm/rrrr hh24:mi:ss') between to_date(a.dt_requisicao,'dd/mm/rrrr hh24:mi:ss') and to_date(a.dt_requisicao + qt_dia_w,'dd/mm/rrrr hh24:mi:ss'))
						or  	(qt_dia_w  = 0 and qt_hora_w > 0  and dt_solicitacao_w between a.dt_requisicao and a.dt_requisicao + (qt_hora_w/24)))
						and  	a.cd_medico_solicitante  = cd_medico_w
						and  	a.ie_estagio not in (3,7) -- Jucimara OS 881991 - Nao considerar as requisicoes canceladas e reprovadas, nem os itens cancelados
						and  	b.ie_status not in ('N', 'G', 'U', 'C'); /*Diego OS 302524 - Caso o item estaja glosado nao sera considerado na contagem*/
-- Djavan OS 741747 - O item em Usuario (aguardando acao) tambem nao deve ser considerado 
						qt_reg_w  := (qt_reg_w + qt_solicitada_w);
					elsif (ie_regra_w = 'C') then --Mesmo CID10
						select  count(1),
							coalesce(sum(qt_solicitado),0)
						into STRICT  	qt_atend_retorno_w,
							qt_reg_w
						from  	pls_requisicao a,
							pls_requisicao_proc b,
							pls_requisicao_diagnostico c
						where  	a.nr_sequencia    = b.nr_seq_requisicao
						and  	a.nr_sequencia    = c.nr_seq_requisicao
						and  	a.cd_estabelecimento  = cd_estabelecimento_w
						and  	a.ie_tipo_guia    = ie_tipo_guia_w
						and  	a.nr_seq_prestador  = nr_seq_prestador_w
						and  	a.nr_sequencia     <> nr_seq_requisicao_p
						and  	a.nr_seq_segurado  = nr_seq_segurado_w
						and  	b.cd_procedimento  = cd_procedimento_w
						and  	b.ie_origem_proced  = ie_origem_proced_w
						and  	((qt_hora_w = 0 and to_date(dt_solicitacao_w,'dd/mm/rrrr hh24:mi:ss') between to_date(a.dt_requisicao,'dd/mm/rrrr hh24:mi:ss') and to_date(a.dt_requisicao + qt_dia_w,'dd/mm/rrrr hh24:mi:ss'))
						or  	(qt_dia_w  = 0 and qt_hora_w > 0  and dt_solicitacao_w between a.dt_requisicao and a.dt_requisicao + (qt_hora_w/24)))
						--and	trunc(dt_solicitacao_w)  between trunc(dt_solicitacao,'dd') and fim_dia(dt_solicitacao + qt_dia_w)
						and  	c.cd_doenca  = cd_cid_w
						and  	a.ie_estagio not in (3,7) -- Jucimara OS 881991 - Nao considerar as requisicoes canceladas e reprovadas, nem os itens cancelados
						and  	b.ie_status not in ('N', 'G', 'U', 'C'); /*Diego OS 302524 - Caso o item estaja glosado nao sera considerado na contagem*/
-- Djavan OS 741747 - O item em Usuario (aguardando acao) tambem nao deve ser considerado
						qt_reg_w  := (qt_reg_w + qt_solicitada_w);
					elsif (ie_regra_w = 'T') then --Mesma categoria CID10
						select  count(1),
							coalesce(sum(qt_solicitado),0)
						into STRICT  	qt_atend_retorno_w,
							qt_reg_w
						from  	pls_requisicao a,
							pls_requisicao_proc b,
							pls_requisicao_diagnostico c
						where  	a.nr_sequencia    = b.nr_seq_requisicao
						and  	a.nr_sequencia    = c.nr_seq_requisicao
						and  	a.cd_estabelecimento  = cd_estabelecimento_w
						and  	a.ie_tipo_guia    = ie_tipo_guia_w
						and  	a.nr_seq_prestador  = nr_seq_prestador_w
						and  	a.nr_sequencia     <> nr_seq_requisicao_p
						and  	a.nr_seq_segurado  = nr_seq_segurado_w
						and  	b.cd_procedimento  = cd_procedimento_w
						and  	b.ie_origem_proced  = ie_origem_proced_w
						and  	((qt_hora_w = 0 and to_date(dt_solicitacao_w,'dd/mm/rrrr hh24:mi:ss') between to_date(a.dt_requisicao,'dd/mm/rrrr hh24:mi:ss') and to_date(a.dt_requisicao + qt_dia_w,'dd/mm/rrrr hh24:mi:ss'))
						or  	(qt_dia_w  = 0 and qt_hora_w > 0  and dt_solicitacao_w between a.dt_requisicao and a.dt_requisicao + (qt_hora_w/24)))
						and  	substr(obter_categoria_cid(c.cd_doenca),1,5)  = cd_categoria_w
						and  	a.ie_estagio not in (3,7) -- Jucimara OS 881991 - Nao considerar as requisicoes canceladas e reprovadas, nem os itens cancelados
						and  	b.ie_status not in ('N', 'G', 'U', 'C'); /*Diego OS 302524 - Caso o item estaja glosado nao sera considerado na contagem*/
-- Djavan OS 741747 - O item em Usuario (aguardando acao) tambem nao deve ser considerado
						qt_reg_w  := (qt_reg_w + qt_solicitada_w);
					elsif (ie_regra_w = 'MC') then
						select  count(1),
							coalesce(sum(qt_solicitado),0)
						into STRICT  	qt_atend_retorno_w,
							qt_reg_w
						from 	pls_requisicao a,
							pls_requisicao_proc b,
							pls_requisicao_diagnostico c
						where  	a.nr_sequencia    = b.nr_seq_requisicao
						and  	a.nr_sequencia    = c.nr_seq_requisicao
						and  	a.cd_estabelecimento  = cd_estabelecimento_w
						and  	a.ie_tipo_guia    = ie_tipo_guia_w
						and  	a.nr_seq_prestador  = nr_seq_prestador_w
						and  	a.nr_sequencia     <> nr_seq_requisicao_p
						and  	a.nr_seq_segurado  = nr_seq_segurado_w
						and  	b.cd_procedimento  = cd_procedimento_w
						and  	b.ie_origem_proced  = ie_origem_proced_w
						and  	((qt_hora_w = 0 and to_date(dt_solicitacao_w,'dd/mm/rrrr hh24:mi:ss') between to_date(a.dt_requisicao,'dd/mm/rrrr hh24:mi:ss') and to_date(a.dt_requisicao + qt_dia_w,'dd/mm/rrrr hh24:mi:ss'))
						or  	(qt_dia_w  = 0 and qt_hora_w > 0  and dt_solicitacao_w between a.dt_requisicao and a.dt_requisicao + (qt_hora_w/24)))
						and  	c.cd_doenca    = cd_cid_w
						and  	a.cd_medico_solicitante  = cd_medico_w
						and  	a.ie_estagio not in (3,7) -- Jucimara OS 881991 - Nao considerar as requisicoes canceladas e reprovadas, nem os itens cancelados
						and  	b.ie_status not in ('N', 'G', 'U', 'C'); /*Diego OS 302524 - Caso o item estaja glosado nao sera considerado na contagem*/
-- Djavan OS 741747 - O item em Usuario (aguardando acao) tambem nao deve ser considerado
						qt_reg_w  := (qt_reg_w + qt_solicitada_w);
					elsif (ie_regra_w = 'MO') then
						select  count(1),
							coalesce(sum(qt_solicitado),0)
						into STRICT  	qt_atend_retorno_w,
							qt_reg_w
						from  	pls_requisicao a,
							pls_requisicao_proc b
						where  	a.nr_sequencia    = b.nr_seq_requisicao
						and  	a.cd_estabelecimento  = cd_estabelecimento_w
						and  	a.ie_tipo_guia    = ie_tipo_guia_w
						and  	a.nr_seq_prestador  = nr_seq_prestador_w
						and  	a.nr_sequencia     <> nr_seq_requisicao_p
						and  	a.nr_seq_segurado  = nr_seq_segurado_w
						and  	b.cd_procedimento  = cd_procedimento_w
						and  	b.ie_origem_proced  = ie_origem_proced_w
						and  	((qt_hora_w = 0 and to_date(dt_solicitacao_w,'dd/mm/rrrr hh24:mi:ss') between to_date(a.dt_requisicao,'dd/mm/rrrr hh24:mi:ss') and to_date(a.dt_requisicao + qt_dia_w,'dd/mm/rrrr hh24:mi:ss'))
						or  	(qt_dia_w  = 0 and qt_hora_w > 0  and dt_solicitacao_w between a.dt_requisicao and a.dt_requisicao + (qt_hora_w/24)))
						and  	a.cd_medico_solicitante  = cd_medico_w
						and (a.cd_especialidade   = cd_especialidade_guia_w
						or  	a.nr_seq_cbo_saude  = nr_seq_cbo_saude_w)
						and  	a.ie_estagio not in (3,7) -- Jucimara OS 881991 - Nao considerar as requisicoes canceladas e reprovadas, nem os itens cancelados
						and  	b.ie_status not in ('N', 'G', 'U', 'C'); /*Diego OS 302524 - Caso o item estaja glosado nao sera considerado na contagem*/
-- Djavan OS 741747 - O item em Usuario (aguardando acao) tambem nao deve ser considerado
						qt_reg_w  := (qt_reg_w + qt_solicitada_w);

					elsif (ie_regra_w = 'MCO') then
						select  count(1),            
							coalesce(sum(qt_solicitado), 0)
						into STRICT  	qt_atend_retorno_w,
							qt_reg_w
						from  	pls_requisicao a,
							pls_requisicao_proc b,
							pls_requisicao_diagnostico c
						where  	a.nr_sequencia    = b.nr_seq_requisicao
						and  	a.nr_sequencia    = c.nr_seq_requisicao
						and  	a.cd_estabelecimento  = cd_estabelecimento_w
						and  	a.ie_tipo_guia    = ie_tipo_guia_w
						and  	a.nr_seq_prestador  = nr_seq_prestador_w
						and  	a.nr_sequencia     <> nr_seq_requisicao_p
						and  	a.nr_seq_segurado  = nr_seq_segurado_w
						and  	b.cd_procedimento  = cd_procedimento_w
						and  	b.ie_origem_proced  = ie_origem_proced_w
						and  	((qt_hora_w = 0 and to_date(dt_solicitacao_w,'dd/mm/rrrr hh24:mi:ss') between to_date(a.dt_requisicao,'dd/mm/rrrr hh24:mi:ss') and to_date(a.dt_requisicao + qt_dia_w,'dd/mm/rrrr hh24:mi:ss'))
						or  	(qt_dia_w  = 0 and qt_hora_w > 0  and dt_solicitacao_w between a.dt_requisicao and a.dt_requisicao + (qt_hora_w/24)))
						and  	c.cd_doenca    = cd_cid_w
						and  	a.cd_medico_solicitante  = cd_medico_w
						and (a.cd_especialidade   = cd_especialidade_guia_w
						or  	a.nr_seq_cbo_saude  = nr_seq_cbo_saude_w)
						and  	a.ie_estagio not in (3,7) -- Jucimara OS 881991 - Nao considerar as requisicoes canceladas e reprovadas, nem os itens cancelados
						and  	b.ie_status not in ('N', 'G', 'U', 'C');-- Djavan OS 741747 - O item em Usuario (aguardando acao) tambem nao deve ser considerado 
						qt_reg_w  := (qt_reg_w + qt_solicitada_w);
		
					end if;

					if  (qt_reg_w > qt_retorno_w AND qt_retorno_w > 0) then
						CALL pls_gravar_requisicao_glosa('1601', nr_seq_requisicao_p, nr_seq_requisicao_proc_w, null, '', nm_usuario_p, nr_seq_prestador_w, cd_estabelecimento_w, '', '');
						ie_gerou_glosa_w	:= 'S';
					end if;
		
					if (qt_atend_retorno_w > 0) then
						if (qt_dia_w > 0) then
							CALL pls_gravar_requisicao_glosa('9907', '', nr_seq_requisicao_proc_w, null, 'Procedimento solicitado a menos de ' || qt_dia_w || ' dias ', nm_usuario_p, nr_seq_prestador_w, cd_estabelecimento_w, '', '');
							ie_gerou_glosa_w	:= 'S';
						elsif (qt_hora_w > 0) then
							CALL pls_gravar_requisicao_glosa('9907', '', nr_seq_requisicao_proc_w, null, 'Procedimento solicitado a menos de ' || qt_hora_w || ' horas ', nm_usuario_p, nr_seq_prestador_w, cd_estabelecimento_w, '', '');
							ie_gerou_glosa_w	:= 'S';
						end if;
					end if;

					if (ie_gerou_glosa_w = 'S') then
						exit;
					end if;
			end if;  			
			end loop;
			close C02;
		else
			cd_especialidade_w  := null;
			qt_dia_w	:= 0;
			qt_hora_w	:= 0;
			qt_retorno_w	:= 0;
			open C02;
			loop
			fetch C02 into
				qt_dia_w,
				qt_hora_w,
				qt_retorno_w,
				ie_regra_w,
				ie_medico_prestador_w,
				ie_conta_posterior_w,
				ie_tipo_guia_ww,
				ie_reembolso_ww,
				cd_especialidade_w,
				ie_busca_medico_nota_servico_w,
				nr_seq_regra_retorno_w,
				ie_profissional_participante_w;
			EXIT WHEN NOT FOUND; /* apply on c02 */
			end loop;
			close c02;

			qt_reg_w     := 0;
			qt_atend_retorno_w   := 0;
	
			if (qt_dia_w > 0) or (qt_hora_w > 0) then
				if (ie_regra_w = 'M') then --Mesmo medico          
					select  count(1),
						coalesce(sum(qt_solicitado),0)
					into STRICT  	qt_atend_retorno_w,
						qt_reg_w
					from  	pls_requisicao a,
						pls_requisicao_proc b
					where  	a.nr_sequencia    = b.nr_seq_requisicao
					and  	a.cd_estabelecimento  = cd_estabelecimento_w
					and  	a.ie_tipo_guia    = ie_tipo_guia_w
					and  	a.nr_seq_prestador  = nr_seq_prestador_w
					and  	a.nr_sequencia     <> nr_seq_requisicao_p
					and  	a.nr_seq_segurado  = nr_seq_segurado_w
					and  	b.cd_procedimento  = cd_procedimento_w
					and  	b.ie_origem_proced  = ie_origem_proced_w
					and  	((qt_hora_w = 0 and to_date(dt_solicitacao_w,'dd/mm/rrrr hh24:mi:ss') between to_date(a.dt_requisicao,'dd/mm/rrrr hh24:mi:ss') and to_date(a.dt_requisicao + qt_dia_w,'dd/mm/rrrr hh24:mi:ss'))
					or  	(qt_dia_w  = 0 and qt_hora_w > 0  and dt_solicitacao_w between a.dt_requisicao and a.dt_requisicao + (qt_hora_w/24)))
					and  	a.cd_medico_solicitante  = cd_medico_w
					and  	a.ie_estagio not in (3,7) -- Jucimara OS 881991 - Nao considerar as requisicoes canceladas e reprovadas, nem os itens cancelados
					and  	b.ie_status not in ('N', 'G', 'U', 'C'); /*Diego OS 302524 - Caso o item estaja glosado nao sera considerado na contagem*/
-- Djavan OS 741747 - O item em Usuario (aguardando acao) tambem nao deve ser considerado 
					qt_reg_w  := (qt_reg_w + qt_solicitada_w);
				elsif (ie_regra_w = 'C') then --Mesmo CID10
					select  count(1),
						coalesce(sum(qt_solicitado),0)
					into STRICT  	qt_atend_retorno_w,
						qt_reg_w
					from  	pls_requisicao a,
						pls_requisicao_proc b,
						pls_requisicao_diagnostico c
					where  	a.nr_sequencia    = b.nr_seq_requisicao
					and  	a.nr_sequencia    = c.nr_seq_requisicao
					and  	a.cd_estabelecimento  = cd_estabelecimento_w
					and  	a.ie_tipo_guia    = ie_tipo_guia_w
					and  	a.nr_seq_prestador  = nr_seq_prestador_w
					and  	a.nr_sequencia     <> nr_seq_requisicao_p
					and  	a.nr_seq_segurado  = nr_seq_segurado_w
					and  	b.cd_procedimento  = cd_procedimento_w
					and  	b.ie_origem_proced  = ie_origem_proced_w
					and  	((qt_hora_w = 0 and to_date(dt_solicitacao_w,'dd/mm/rrrr hh24:mi:ss') between to_date(a.dt_requisicao,'dd/mm/rrrr hh24:mi:ss') and to_date(a.dt_requisicao + qt_dia_w,'dd/mm/rrrr hh24:mi:ss'))
					or  	(qt_dia_w  = 0 and qt_hora_w > 0  and dt_solicitacao_w between a.dt_requisicao and a.dt_requisicao + (qt_hora_w/24)))
					--and	trunc(dt_solicitacao_w)  between trunc(dt_solicitacao,'dd') and fim_dia(dt_solicitacao + qt_dia_w)
					and  	c.cd_doenca  = cd_cid_w
					and  	a.ie_estagio not in (3,7) -- Jucimara OS 881991 - Nao considerar as requisicoes canceladas e reprovadas, nem os itens cancelados
					and  	b.ie_status not in ('N', 'G', 'U', 'C'); /*Diego OS 302524 - Caso o item estaja glosado nao sera considerado na contagem*/
-- Djavan OS 741747 - O item em Usuario (aguardando acao) tambem nao deve ser considerado
					qt_reg_w  := (qt_reg_w + qt_solicitada_w);
				elsif (ie_regra_w = 'T') then --Mesma categoria CID10
					select  count(1),
						coalesce(sum(qt_solicitado),0)
					into STRICT  	qt_atend_retorno_w,
						qt_reg_w
					from  	pls_requisicao a,
						pls_requisicao_proc b,
						pls_requisicao_diagnostico c
					where  	a.nr_sequencia    = b.nr_seq_requisicao
					and  	a.nr_sequencia    = c.nr_seq_requisicao
					and  	a.cd_estabelecimento  = cd_estabelecimento_w
					and  	a.ie_tipo_guia    = ie_tipo_guia_w
					and  	a.nr_seq_prestador  = nr_seq_prestador_w
					and  	a.nr_sequencia     <> nr_seq_requisicao_p
					and  	a.nr_seq_segurado  = nr_seq_segurado_w
					and  	b.cd_procedimento  = cd_procedimento_w
					and  	b.ie_origem_proced  = ie_origem_proced_w
					and  	((qt_hora_w = 0 and to_date(dt_solicitacao_w,'dd/mm/rrrr hh24:mi:ss') between to_date(a.dt_requisicao,'dd/mm/rrrr hh24:mi:ss') and to_date(a.dt_requisicao + qt_dia_w,'dd/mm/rrrr hh24:mi:ss'))
					or  	(qt_dia_w  = 0 and qt_hora_w > 0  and dt_solicitacao_w between a.dt_requisicao and a.dt_requisicao + (qt_hora_w/24)))
					and  	substr(obter_categoria_cid(c.cd_doenca),1,5)  = cd_categoria_w
					and  	a.ie_estagio not in (3,7) -- Jucimara OS 881991 - Nao considerar as requisicoes canceladas e reprovadas, nem os itens cancelados
					and  	b.ie_status not in ('N', 'G', 'U', 'C'); /*Diego OS 302524 - Caso o item estaja glosado nao sera considerado na contagem*/
-- Djavan OS 741747 - O item em Usuario (aguardando acao) tambem nao deve ser considerado
					qt_reg_w  := (qt_reg_w + qt_solicitada_w);
				elsif (ie_regra_w = 'MC') then
					select  count(1),
						coalesce(sum(qt_solicitado),0)
					into STRICT  	qt_atend_retorno_w,
						qt_reg_w
					from  	pls_requisicao a,
						pls_requisicao_proc b,
						pls_requisicao_diagnostico c
					where  	a.nr_sequencia    = b.nr_seq_requisicao
					and  	a.nr_sequencia    = c.nr_seq_requisicao
					and  	a.cd_estabelecimento  = cd_estabelecimento_w
					and  	a.ie_tipo_guia    = ie_tipo_guia_w
					and  	a.nr_seq_prestador  = nr_seq_prestador_w
					and  	a.nr_sequencia     <> nr_seq_requisicao_p
					and  	a.nr_seq_segurado  = nr_seq_segurado_w
					and  	b.cd_procedimento  = cd_procedimento_w
					and  	b.ie_origem_proced  = ie_origem_proced_w
					and  	((qt_hora_w = 0 and to_date(dt_solicitacao_w,'dd/mm/rrrr hh24:mi:ss') between to_date(a.dt_requisicao,'dd/mm/rrrr hh24:mi:ss') and to_date(a.dt_requisicao + qt_dia_w,'dd/mm/rrrr hh24:mi:ss'))
					or  	(qt_dia_w  = 0 and qt_hora_w > 0  and dt_solicitacao_w between a.dt_requisicao and a.dt_requisicao + (qt_hora_w/24)))
					and  	c.cd_doenca    = cd_cid_w
					and  	a.cd_medico_solicitante  = cd_medico_w
					and  	a.ie_estagio not in (3,7) -- Jucimara OS 881991 - Nao considerar as requisicoes canceladas e reprovadas, nem os itens cancelados
					and  	b.ie_status not in ('N', 'G', 'U', 'C'); /*Diego OS 302524 - Caso o item estaja glosado nao sera considerado na contagem*/
-- Djavan OS 741747 - O item em Usuario (aguardando acao) tambem nao deve ser considerado
					qt_reg_w  := (qt_reg_w + qt_solicitada_w);
				elsif (ie_regra_w = 'MO') then
					select  count(1),
						coalesce(sum(qt_solicitado),0)
					into STRICT  	qt_atend_retorno_w,
						qt_reg_w
					from  	pls_requisicao a,
						pls_requisicao_proc b
					where  	a.nr_sequencia    = b.nr_seq_requisicao
					and  	a.cd_estabelecimento  = cd_estabelecimento_w
					and  	a.ie_tipo_guia    = ie_tipo_guia_w
					and  	a.nr_seq_prestador  = nr_seq_prestador_w
					and  	a.nr_sequencia     <> nr_seq_requisicao_p
					and  	a.nr_seq_segurado  = nr_seq_segurado_w
					and  	b.cd_procedimento  = cd_procedimento_w
					and  	b.ie_origem_proced  = ie_origem_proced_w
					and  	((qt_hora_w = 0 and to_date(dt_solicitacao_w,'dd/mm/rrrr hh24:mi:ss') between to_date(a.dt_requisicao,'dd/mm/rrrr hh24:mi:ss') and to_date(a.dt_requisicao + qt_dia_w,'dd/mm/rrrr hh24:mi:ss'))
					or  	(qt_dia_w  = 0 and qt_hora_w > 0  and dt_solicitacao_w between a.dt_requisicao and a.dt_requisicao + (qt_hora_w/24)))
					and  	a.cd_medico_solicitante  = cd_medico_w
					and  	a.cd_especialidade   = cd_especialidade_guia_w
					and  	a.ie_estagio not in (3,7) -- Jucimara OS 881991 - Nao considerar as requisicoes canceladas e reprovadas, nem os itens cancelados
					and  	b.ie_status not in ('N', 'G', 'U', 'C'); /*Diego OS 302524 - Caso o item estaja glosado nao sera considerado na contagem*/
-- Djavan OS 741747 - O item em Usuario (aguardando acao) tambem nao deve ser considerado
					qt_reg_w  := (qt_reg_w + qt_solicitada_w);
		
				elsif (ie_regra_w = 'MCO') then  
					select  count(1),            
						coalesce(sum(qt_solicitado), 0)
					into STRICT  	qt_atend_retorno_w,
						qt_reg_w
					from  	pls_requisicao a,
						pls_requisicao_proc b,
						pls_requisicao_diagnostico c
					where  	a.nr_sequencia    = b.nr_seq_requisicao
					and  	a.nr_sequencia    = c.nr_seq_requisicao
					and  	a.cd_estabelecimento  = cd_estabelecimento_w
					and  	a.ie_tipo_guia    = ie_tipo_guia_w
					and  	a.nr_seq_prestador  = nr_seq_prestador_w
					and  	a.nr_sequencia     <> nr_seq_requisicao_p
					and  	a.nr_seq_segurado  = nr_seq_segurado_w
					and  	b.cd_procedimento  = cd_procedimento_w
					and  	b.ie_origem_proced  = ie_origem_proced_w
					and  	((qt_hora_w = 0 and to_date(dt_solicitacao_w,'dd/mm/rrrr hh24:mi:ss') between to_date(a.dt_requisicao,'dd/mm/rrrr hh24:mi:ss') and to_date(a.dt_requisicao + qt_dia_w,'dd/mm/rrrr hh24:mi:ss'))
					or  	(qt_dia_w  = 0 and qt_hora_w > 0  and dt_solicitacao_w between a.dt_requisicao and a.dt_requisicao + (qt_hora_w/24)))
					and  	c.cd_doenca    = cd_cid_w
					and  	a.cd_medico_solicitante  = cd_medico_w
					and  	a.cd_especialidade   = cd_especialidade_guia_w
					and  	a.ie_estagio not in (3,7) -- Jucimara OS 881991 - Nao considerar as requisicoes canceladas e reprovadas, nem os itens cancelados
					and  	b.ie_status not in ('N', 'G', 'U', 'C');-- Djavan OS 741747 - O item em Usuario (aguardando acao) tambem nao deve ser considerado 
					qt_reg_w  := (qt_reg_w + qt_solicitada_w);
		
				end if;
		
				if  (qt_reg_w > qt_retorno_w AND qt_retorno_w > 0) then
					CALL pls_gravar_requisicao_glosa('1601', nr_seq_requisicao_p, nr_seq_requisicao_proc_w, null, '', nm_usuario_p, nr_seq_prestador_w, cd_estabelecimento_w, '', '');
				end if;
		
				if (qt_atend_retorno_w > 0) then
					if (qt_dia_w > 0) then
						CALL pls_gravar_requisicao_glosa('9907', '', nr_seq_requisicao_proc_w, null, 'Procedimento solicitado a menos de ' || qt_dia_w || ' dias ', nm_usuario_p, nr_seq_prestador_w, cd_estabelecimento_w, '', '');
					elsif (qt_hora_w > 0) then
						CALL pls_gravar_requisicao_glosa('9907', '', nr_seq_requisicao_proc_w, null, 'Procedimento solicitado a menos de ' || qt_hora_w || ' horas ', nm_usuario_p, nr_seq_prestador_w, cd_estabelecimento_w, '', '');
					end if;
				end if;
			end if;
		end if;
	end;
	end loop;
	close C07;
elsif (coalesce(nr_seq_conta_p, 0) > 0) then
	sg_cons_prof_prest_nota_w  := null;
	nr_cons_prof_prest_nota_w  := null;
	sg_uf_cons_prest_nota_w    := null;

	select  a.ie_tipo_guia,
		a.cd_estabelecimento,
		a.nr_seq_prestador_exec,
		a.cd_medico_executor,
		a.nr_seq_segurado,
		/*trunc(a.dt_emissao,'dd'), Alterado para dt_atendimento_referencia */

		a.dt_atendimento_referencia,
		b.ie_tipo_protocolo,
		a.nr_seq_cbo_saude,
		a.ie_origem_conta,
		a.nr_seq_nota_cobranca,
		b.nr_sequencia,
		a.ie_tipo_segurado
	into STRICT  	ie_tipo_guia_w,
		cd_estabelecimento_w,
		nr_seq_prestador_w,
		cd_medico_w,
		nr_seq_segurado_w,
		/*dt_emissao_w, alterado para dt_atendimento_referencia_w */

		dt_atendimento_referencia_w,
		ie_tipo_protocolo_w,
		nr_seq_cbo_saude_w,
		ie_origem_conta_w,
		nr_seq_nota_cobranca_w,
		nr_seq_protocolo_ww,
		ie_tipo_segurado_w
	from  	pls_conta     a,
		pls_protocolo_conta   b    
	where  	a.nr_seq_protocolo   = b.nr_sequencia
	and  	a.nr_sequencia     = nr_seq_conta_p;

	dt_referencia_w  := dt_atendimento_referencia_w; /*dt_emissao_w;  Alterado para dt_atendimento_referencia_w*/

	
	/*Se eh uma conta de um protocolo de reembolso*/

	if (ie_tipo_protocolo_w = 'R') then
		ie_reembolso_w   := 'S';
	else
		ie_conta_w   := 'S';
	end if;
  
	if (ie_origem_conta_w = 'A') and (nr_seq_nota_cobranca_w IS NOT NULL AND nr_seq_nota_cobranca_w::text <> '') then
		select  max(sg_cons_prof_prest),
			max(nr_cons_prof_prest),
			max(sg_uf_cons_prest)
		into STRICT  	sg_cons_prof_prest_nota_w,
			nr_cons_prof_prest_nota_w,
			sg_uf_cons_prest_nota_w
		from  	ptu_nota_servico  a
		where  	a.nr_seq_conta_proc in (  	SELECT  x.nr_sequencia 
							from  pls_conta_proc x
							where  x.nr_seq_conta  = nr_seq_conta_p);
	end if;

	/*CID*/

	select  coalesce(max(cd_doenca),'0')
	into STRICT  	cd_cid_w
	from  	pls_diagnostico_conta
	where  	nr_seq_conta  = nr_seq_conta_p
	and  	((ie_classificacao = 'P') or (coalesce(ie_classificacao::text, '') = ''));

	/*CATEGORIA DO CID*/

	if (cd_cid_w <> '0') then
		select  cd_categoria_cid
		into STRICT  	cd_categoria_w
		from   	cid_doenca
		where   cd_doenca_cid = cd_cid_w;
	end if;

	-- Quando o medico nao e informado, deve-se consultar pelo prestador (somente PF)
	if (coalesce(cd_medico_w::text, '') = '') then
		select  count(1)
		into STRICT  	qt_especialidade_medica_w
		from  	pls_prestador_med_espec    a,
			pls_prestador      p
		where  	a.nr_seq_prestador  = nr_seq_prestador_w
		and  	p.nr_sequencia    = a.nr_seq_prestador
		and  	(p.cd_pessoa_fisica IS NOT NULL AND p.cd_pessoa_fisica::text <> '') -- somente PF
		and  	ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_referencia_w) between ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(coalesce(a.dt_inicio_vigencia, dt_referencia_w)) and ESTABLISHMENT_TIMEZONE_UTILS.EndOfDay(coalesce(a.dt_fim_vigencia, dt_referencia_w))  LIMIT 1;
	else
		select  count(1)
		into STRICT 	qt_especialidade_medica_w
		from 	pls_prestador_med_espec  a
		where  	a.cd_pessoa_fisica  = cd_medico_w
		and  	ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_referencia_w) between ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(coalesce(a.dt_inicio_vigencia, dt_referencia_w)) and ESTABLISHMENT_TIMEZONE_UTILS.EndOfDay(coalesce(a.dt_fim_vigencia, dt_referencia_w))  LIMIT 1;
	end if;

	open C03;
	loop
	fetch C03 into
		nr_seq_conta_proc_w,
		cd_procedimento_w,
		ie_origem_proced_w,
		qt_solicitada_w,
		dt_procedimento_w;
	EXIT WHEN NOT FOUND; /* apply on C03 */
	begin
		if (ie_origem_conta_w = 'A') and (nr_seq_nota_cobranca_w IS NOT NULL AND nr_seq_nota_cobranca_w::text <> '') then
			select  max(sg_cons_prof_prest),
				max(nr_cons_prof_prest),
				max(sg_uf_cons_prest)
			into STRICT  	sg_cons_prof_prest_nota_w,
				nr_cons_prof_prest_nota_w,
				sg_uf_cons_prest_nota_w
			from  	ptu_nota_servico  a
			where  	a.nr_seq_conta_proc = nr_seq_conta_proc_w;
		end if;

		cd_medico_part_w := pls_obter_medico_executor(nr_seq_conta_proc_w, 'P');
		
		if (coalesce(nr_seq_cbo_saude_w::text, '') = '') then
			select	max(nr_seq_cbo_saude)
			into STRICT	nr_seq_cbo_saude_part_w
			from	pls_proc_participante
			where	nr_seq_conta_proc = nr_seq_conta_proc_w
			and	cd_medico = cd_medico_part_w;
		end if;
		
		if (coalesce(nr_seq_cbo_saude_w::text, '') = '') then
			nr_seq_cbo_saude_w := nr_seq_cbo_saude_part_w;
		end if;
		
		if (coalesce(cd_medico_w::text, '') = '') then
			cd_medico_w := cd_medico_part_w;
		end if;
		
		--Verifica se tem especialidade no prestador para o medico
		if (qt_especialidade_medica_w <> 0) then
			open C04;
			loop
			fetch C04 into
				cd_especialidade_w;
			EXIT WHEN NOT FOUND; /* apply on C04 */
			begin
				qt_dia_w	:= 0;
				qt_hora_w	:= 0;
				qt_retorno_w	:= 0;
				open C02;
				loop
				fetch C02 into
					qt_dia_w,
					qt_hora_w,
					qt_retorno_w,
					ie_regra_w,
					ie_medico_prestador_w,
					ie_conta_posterior_w,
					ie_tipo_guia_ww,
					ie_reembolso_ww,
					cd_especialidade_w,
					ie_busca_medico_nota_servico_w,
					nr_seq_regra_retorno_w,
					ie_profissional_participante_w;
				EXIT WHEN NOT FOUND; /* apply on c02 */
				end loop;
				close c02;

				qt_reg_w     := 0;
				qt_atend_retorno_w   := 0;
		
				if (qt_dia_w > 0) or (qt_hora_w > 0) then
					ds_observacao_glosa_w := 'Contas consideradas na recorrencia: '||chr(13)||chr(10);
					
					open C06;
					loop
					fetch C06 into
						qt_reg_w,
						nr_seq_conta_w;
					EXIT WHEN NOT FOUND; /* apply on C06 */
					begin
						
						if (ie_tipo_guia_w in (4, 5)) and (ie_regra_w  in ('M', 'MC', 'MO', 'MCO')) and (ie_profissional_participante_w = 'N') then
							if (pls_valida_partic_retorno(  nr_seq_conta_p,  nr_seq_conta_w, nr_seq_segurado_w, cd_procedimento_w, ie_origem_proced_w, nr_seq_prestador_w) = 'S') then
								qt_atend_retorno_w  := qt_atend_retorno_w + 1;
								qt_reg_w    := (qt_reg_w + qt_solicitada_w );
							end if;
						else  
							qt_atend_retorno_w  := qt_atend_retorno_w + 1;
							qt_reg_w    := (qt_reg_w + qt_solicitada_w );
						end if;

		
						select  nr_seq_protocolo,
							coalesce(coalesce(cd_guia, cd_guia_referencia),cd_guia_prestador),
							/*dt_emissao, Alterado para dt_atendimento_referencia */

							dt_atendimento_referencia,
							ie_status
						into STRICT  	nr_seq_protocolo_w,
							cd_guia_referente_w,
							/*dt_emissao_w, alterado para dt_atendimento_referencia_w */

							dt_atendimento_referencia_w,
							ie_status_w
						from  	pls_conta
						where  	nr_sequencia  = nr_seq_conta_w;
		
						begin
							ds_observacao_glosa_w := ds_observacao_glosa_w  ||chr(9)||'Protocolo: '|| nr_seq_protocolo_w ||chr(9)||'Conta: '||nr_seq_conta_w||chr(9)||'Status: '|| obter_valor_dominio(1961,ie_status_w);
						exception
						when others then
							null;
						end;
		
						begin
							if (coalesce(cd_guia_referente_w,'X') <> 'X') then
								ds_observacao_glosa_w := ds_observacao_glosa_w||chr(9)||'Guia: '||cd_guia_referente_w;
							end if;
						exception
						when others then
							null;
						end;
						cd_cid_principal_w  := pls_obter_cid_conta(nr_seq_conta_w);

						begin
							if (coalesce(cd_cid_principal_w,'X') <> 'X') then
								ds_observacao_glosa_w  := ds_observacao_glosa_w||chr(9)||'CID Princ.: '||cd_cid_principal_w;
							end if;
						exception
						when others then
							null;
						end;

						begin /*Visto com o Diego e Robson para tratar a variavel ds_observacao_glosa_w, por que ela pode estourar o tamanho*/
							ds_observacao_glosa_w := ds_observacao_glosa_w||chr(9)||'Dt. atend. referencia: '||to_char(dt_atendimento_referencia_w,'dd/mm/rrrr hh24:mi:ss')||CHR(13)||CHR(10);
						exception
						when others then
							null;
						end;
		
		    
					end;
					end loop;
					close C06;
					
					if  ( qt_reg_w > qt_retorno_w AND qt_retorno_w > 0) then
						CALL pls_gravar_conta_glosa('1601', null, nr_seq_conta_proc_w, null, 'N',ds_observacao_glosa_w ,nm_usuario_p,'',ie_evento_p,nr_seq_prestador_w, cd_estabelecimento_w,null, null);
					end if;
					
					if (qt_atend_retorno_w > 0) then
						CALL pls_gravar_conta_glosa('9907', null, nr_seq_conta_proc_w, null, 'N', ds_observacao_glosa_w ,nm_usuario_p,'',ie_evento_p,nr_seq_prestador_w, cd_estabelecimento_w,null, null);
					end if;
				end if;
			end;
			end loop;
			close C04;
		else
			cd_especialidade_w := null;
			qt_dia_w	:= 0;
			qt_hora_w	:= 0;
			qt_retorno_w	:= 0;
			open C02;
			loop
			fetch C02 into
				qt_dia_w,
				qt_hora_w,
				qt_retorno_w,
				ie_regra_w,
				ie_medico_prestador_w,
				ie_conta_posterior_w,
				ie_tipo_guia_ww,
				ie_reembolso_ww,
				cd_especialidade_w,
				ie_busca_medico_nota_servico_w,
				nr_seq_regra_retorno_w,
				ie_profissional_participante_w;
			EXIT WHEN NOT FOUND; /* apply on c02 */
			end loop;
			close c02;
			
			qt_reg_w     := 0;
			qt_atend_retorno_w   := 0;
			if (qt_dia_w > 0) or (qt_hora_w > 0) then
				ds_observacao_glosa_w := 'Contas consideradas na recorrencia: '||chr(13)||chr(10);
				
				open C06;
				loop
				fetch C06 into
					qt_reg_w,
					nr_seq_conta_w;
				EXIT WHEN NOT FOUND; /* apply on C06 */
				begin
	
					if (ie_tipo_guia_w in (4, 5)) and (ie_regra_w  in ('M', 'MC', 'MO', 'MCO')) and (ie_profissional_participante_w = 'N') then
						if (pls_valida_partic_retorno(  nr_seq_conta_p,  nr_seq_conta_w, nr_seq_segurado_w, cd_procedimento_w, ie_origem_proced_w, nr_seq_prestador_w) = 'S') then
							qt_atend_retorno_w  := qt_atend_retorno_w + 1;
							qt_reg_w    := (qt_reg_w + qt_solicitada_w );
						end if;
					else  
						qt_atend_retorno_w  := qt_atend_retorno_w + 1;
						qt_reg_w    := (qt_reg_w + qt_solicitada_w );
					end if;

					select  nr_seq_protocolo,
						coalesce(coalesce(cd_guia, cd_guia_referencia),cd_guia_prestador),
						/*dt_emissao, Alterado para dt_atendimento_referencia */

						dt_atendimento_referencia,
						ie_status
					into STRICT  	nr_seq_protocolo_w,
						cd_guia_referente_w,
						/*dt_emissao_w, Alterado para dt_atendimento_referencia_w */

						dt_atendimento_referencia_w,
						ie_status_w
					from  	pls_conta
					where  	nr_sequencia  = nr_seq_conta_w;

					begin
						ds_observacao_glosa_w := ds_observacao_glosa_w  ||chr(9)||'Protocolo: '|| nr_seq_protocolo_w ||chr(9)||'Conta: '||nr_seq_conta_w||chr(9)||'Status: '|| obter_valor_dominio(1961,ie_status_w);
					exception
					when others then
						null;
					end;

					begin
						if (coalesce(cd_guia_referente_w,'X') <> 'X') then
							ds_observacao_glosa_w := ds_observacao_glosa_w||chr(9)||'Guia: '||cd_guia_referente_w;
						end if;
					exception
					when others then
						null;
					end;
					cd_cid_principal_w  := pls_obter_cid_conta(nr_seq_conta_w);

					begin
						if (coalesce(cd_cid_principal_w,'X') <> 'X') then
							ds_observacao_glosa_w  := ds_observacao_glosa_w||chr(9)||'CID Princ.: '||cd_cid_principal_w;
						end if;
					exception
					when others then
						null;
					end;

					begin /*Visto com o Diego e Robson para tratar a variavel ds_observacao_glosa_w, por que ela pode estourar o tamanho*/
						ds_observacao_glosa_w := ds_observacao_glosa_w||chr(9)||'Dt. atend. referencia: '||to_char(dt_atendimento_referencia_w,'dd/mm/rrrr hh24:mi:ss')||CHR(13)||CHR(10);
					exception
					when others then
						null;
					end;
				end;
				end loop;
				close C06;
				
				if  ( qt_reg_w > qt_retorno_w AND qt_retorno_w > 0) then
					CALL pls_gravar_conta_glosa('1601', null, nr_seq_conta_proc_w, null, 'N',ds_observacao_glosa_w ,nm_usuario_p,'',ie_evento_p,nr_seq_prestador_w, cd_estabelecimento_w,null, null);
				end if;
				
				if (qt_atend_retorno_w > 0) then
					CALL pls_gravar_conta_glosa('9907', null, nr_seq_conta_proc_w, null, 'N', ds_observacao_glosa_w ,nm_usuario_p,'',ie_evento_p,nr_seq_prestador_w, cd_estabelecimento_w,null, null);
				end if;
			end if;
		end if;
	end;
	end loop;
	close C03;
end if;

--commit;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_define_regra_retorno ( nr_seq_guia_p bigint, nr_seq_requisicao_p bigint, nr_seq_conta_p bigint, ie_evento_p text, nm_usuario_p text) FROM PUBLIC;

