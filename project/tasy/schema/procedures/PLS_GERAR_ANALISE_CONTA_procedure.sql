-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_gerar_analise_conta ( nr_seq_conta_p bigint, nm_usuario_p text, cd_estabelecimento_p text) AS $body$
DECLARE


nm_prestador_w			varchar(255);
nm_cooperativa_w			varchar(255);
nm_segurado_w			varchar(255);
cd_guia_w			varchar(20);
ie_pre_analise_w			varchar(10);
cd_cooperativa_w			varchar(10);
ie_origem_conta_w			varchar(2);
ie_preco_w			varchar(2);
ie_gerar_analise_audit_w		varchar(1);
ie_intercambio_w			varchar(1);
ie_tipo_guia_w			varchar(1);
ie_tipo_guia_ww			varchar(1);
ie_tipo_guia_www			varchar(1);
ie_existe_analise_w			bigint;
nr_seq_analise_w			bigint;
nr_lote_w				bigint;
nr_seq_prestador_w		bigint;
nr_seq_segurado_w		bigint;
nr_seq_congenere_w		bigint;
nr_seq_protocolo_w		bigint;
nr_seq_item_criado_w		bigint;
nr_seq_fatura_w			bigint;
nr_fatura_w			ptu_fatura.nr_fatura%type;
nr_seq_plano_w			bigint;
nr_seq_prestador_ww		bigint;
ie_retorno_w			varchar(1);
nr_seq_conta_w			bigint;
dt_atendimento_referencia_w	timestamp;
ie_forma_agrupamento_w 	pls_regra_geracao_analise.ie_forma_agrupamento%type;
nr_seq_regra_agrup_w	pls_regra_geracao_analise.nr_sequencia%type;

C01 CURSOR FOR
	SELECT	nr_sequencia
	from	pls_conta
	where	nr_seq_analise = nr_seq_analise_w
	order by 1;

BEGIN
/*Obter dados da conta*/

select	coalesce(a.cd_guia_referencia,a.cd_guia),
	coalesce(b.nr_seq_prestador,a.nr_seq_prestador_exec),
	a.nr_seq_segurado,
	nr_seq_lote_conta,
	b.nr_seq_congenere,
	b.nr_sequencia,
	a.nr_seq_fatura,
	a.ie_origem_conta,
	CASE WHEN a.ie_tipo_guia='6' THEN '5'  ELSE a.ie_tipo_guia END ,
	b.nr_seq_prestador,
	a.dt_atendimento_referencia
	--substr(pls_obter_dados_segurado(a.nr_seq_segurado,'N'),1,255),
	--substr(pls_obter_dados_prestador(b.nr_seq_prestador,'N'),1,255),
	--substr(pls_obter_nome_congenere(b.nr_seq_congenere),1,255),
	--substr(pls_obter_seq_codigo_coop(b.nr_seq_congenere,''),1,10)
into STRICT	cd_guia_w,
	nr_seq_prestador_w,
	nr_seq_segurado_w,
	nr_lote_w,
	nr_seq_congenere_w,
	nr_seq_protocolo_w,
	nr_seq_fatura_w,
	ie_origem_conta_w,
	ie_tipo_guia_w,
	nr_seq_prestador_ww,
	dt_atendimento_referencia_w
	--nm_segurado_w,
	--nm_prestador_w,
	--nm_cooperativa_w,
	--cd_cooperativa_w
from	pls_conta 		a,
	pls_protocolo_conta	b
where	a.nr_seq_protocolo	= b.nr_sequencia
and	a.nr_sequencia		= nr_seq_conta_p;

/*Obter produto do beneficiario*/

begin
--select	a.nr_seq_plano
select	pls_obter_produto_benef(a.nr_sequencia,dt_atendimento_referencia_w)
into STRICT	nr_seq_plano_w
from	pls_segurado a
where	a.nr_sequencia	= nr_seq_segurado_w;
exception
when others then
	nr_seq_plano_w	:= null;
end;

/*Obter formação de preço do produto*/

begin
select	ie_preco
into STRICT	ie_preco_w
from	pls_plano
where	nr_sequencia	= nr_seq_plano_w;
exception
when others then
	ie_preco_w	:= '';
end;

/*Obtendo o número de fatura da conta */

begin
select	nr_fatura,
	'S'
into STRICT	nr_fatura_w,
	ie_intercambio_w
from 	ptu_fatura
where	nr_sequencia = nr_seq_fatura_w;
exception
when others then
	nr_fatura_w	 := null;
	ie_intercambio_w := 'N';
end;

/*Diego OS - 307956 - Se o protocolo não estiver em um lote de análise, então já vincular o protocolo a um lote de análise.*/

if (coalesce(nr_lote_w,0) = 0) then
	nr_lote_w := pls_gerar_lote_analise(nr_seq_prestador_w, nr_seq_congenere_w, nm_usuario_p, cd_estabelecimento_p, null, nr_lote_w);

	CALL pls_vinc_protocolo_lote_conta(nr_lote_w, nr_seq_protocolo_w, nm_usuario_p);
end if;

ie_gerar_analise_audit_w	:= pls_obter_conta_item_auditoria(nr_seq_conta_p);

/*É necessário o número de guia para ser mandado para análise*/

if	--(nvl(cd_guia_w,'0') <> '0') and  | Diego OS - 326770 - 20/06/2011 - Não será mas necessário uma guia informada. Para estas situações cada conta (sem guia) receberão uma análise separada.
	(coalesce(nr_lote_w,0) > 0) then

	nr_seq_regra_agrup_w := pls_obter_regra_agrup_analise(nr_seq_conta_p, ie_origem_conta_w, nm_usuario_p, cd_estabelecimento_p, nr_seq_regra_agrup_w);

	if (ie_forma_agrupamento_w = 'A') then
		/*Verifica se existe analise para a guia obtida
		Como para constar na mesma análise é necessário que todo o atendimento esteja dentro do mesmo lote, rona-se necessário verificar apenas a guia, lote e o segurado e não mais o status.
		*/
		select	min(nr_sequencia)
		into STRICT	nr_seq_analise_w
		from	pls_analise_conta
		where	cd_guia = cd_guia_w
		and	coalesce(nr_seq_lote_protocolo,0)  	= coalesce(nr_lote_w,0)
		and	coalesce(nr_seq_segurado,0)		= nr_seq_segurado_w
		and	coalesce(ie_origem_analise,'1') 	= CASE WHEN ie_intercambio_w='S' THEN 3  ELSE 1 END;

	else

		select	max(nr_seq_analise)
		into STRICT	nr_seq_analise_w
		from	pls_conta
		where 	nr_sequencia = nr_seq_conta_p;

	end if;

	if (nr_seq_analise_w > 0) then

		select	max(ie_tipo_guia)
		into STRICT	ie_tipo_guia_ww
		from	pls_analise_conta
		where	nr_sequencia = nr_seq_analise_w;

		if (ie_tipo_guia_w = '5') or (ie_tipo_guia_ww = '5') then
			ie_tipo_guia_www := '5';
		elsif (ie_tipo_guia_w = '4') and (ie_tipo_guia_ww <> '5') then
			ie_tipo_guia_www := '4';
		else
			ie_tipo_guia_www := '3';
		end if;

		update	pls_analise_conta
		set	ie_status 	= 'S',
			ie_tipo_guia 	= ie_tipo_guia_www,
			nr_seq_regra_agrup = nr_seq_regra_agrup_w
		where	nr_sequencia = nr_seq_analise_w;

	else
		if	((nr_seq_prestador_w IS NOT NULL AND nr_seq_prestador_w::text <> '') or (nr_seq_congenere_w IS NOT NULL AND nr_seq_congenere_w::text <> '')) then

			select	CASE WHEN max(a.ie_status)='EI' THEN 'S'  ELSE 'N' END ,
				CASE WHEN count(*)=0 THEN 'N'  ELSE 'S' END
			into STRICT	ie_pre_analise_w,
				ie_intercambio_w
			from	ptu_fatura	a,
				pls_conta	b
			where	a.nr_sequencia	= b.nr_seq_fatura
			and	b.nr_sequencia	= nr_seq_conta_p;

			nm_segurado_w		:= substr(pls_obter_dados_segurado(nr_seq_segurado_w,'N'),1,255);
			nm_prestador_w		:= substr(pls_obter_dados_prestador(nr_seq_prestador_ww,'N'),1,255);
			nm_cooperativa_w	:= substr(pls_obter_nome_congenere(nr_seq_congenere_w),1,255);
			cd_cooperativa_w	:= substr(pls_obter_seq_codigo_coop(nr_seq_congenere_w,''),1,10);

			/*Se não existe cria-se um novo registro de analise*/

			insert into pls_analise_conta(nr_sequencia, nr_seq_lote_protocolo, nr_seq_prestador,
				nr_seq_segurado, nm_usuario,
				nm_usuario_nrec, dt_atualizacao, dt_atualizacao_nrec,
				cd_guia, ie_status, dt_analise,
				dt_inicio_analise, ie_auditoria, nr_seq_congenere,
				ie_pre_analise, ie_origem_analise, nr_fatura,
				ie_origem_conta, ie_preco, cd_estabelecimento,
				ie_tipo_guia, nm_prestador, nm_cooperativa,
				nm_segurado, cd_cooperativa, nr_seq_regra_agrup)
			values (nextval('pls_analise_conta_seq'), nr_lote_w, nr_seq_prestador_w,
				nr_seq_segurado_w, nm_usuario_p,
				nm_usuario_p, clock_timestamp(), clock_timestamp(),
				cd_guia_w, 'S', clock_timestamp(),
				clock_timestamp(), ie_gerar_analise_audit_w, nr_seq_congenere_w,
				ie_pre_analise_w, CASE WHEN ie_intercambio_w='S' THEN 3  ELSE 1 END , somente_numero(nr_fatura_w),
				ie_origem_conta_w, ie_preco_w, cd_estabelecimento_p,
				ie_tipo_guia_w, nm_prestador_w, nm_cooperativa_w,
				nm_segurado_w, cd_cooperativa_w, nr_seq_regra_agrup_w) returning nr_sequencia into nr_seq_analise_w;
		end if;
	end if;

	if (coalesce(nr_seq_analise_w,0) > 0) then
		/*Diego OS 307952 - 08/04/2011 -  Só será gerado grupos de auditores quando for uma análise de auditoria.*/

		if (ie_gerar_analise_audit_w = 'N') then
			open C01;
			loop
			fetch C01 into
				nr_seq_conta_w;
			EXIT WHEN NOT FOUND; /* apply on C01 */
				begin
				ie_retorno_w	:= pls_obter_conta_item_auditoria(nr_seq_conta_w);
				if (ie_retorno_w = 'S') then
					ie_gerar_analise_audit_w := ie_retorno_w;
					goto final;
				end if;
				end;
			end loop;
			close C01;
		end if;

		<<final>>
		if (C01%ISOPEN) then
			close C01;
		end if;

		if (ie_gerar_analise_audit_w = 'S') then
			/*Gerar grupo da analise*/

			CALL pls_gerar_grupo_aud_conta(nr_seq_conta_p, nr_seq_analise_w, nm_usuario_p, cd_estabelecimento_p);
		end if;

		/*Gerar os dados do resumo para ser usado na função OPS - Análise de Produção Médica */

		if (ie_intercambio_w = 'S') then
			nr_seq_item_criado_w := pls_gerar_w_resumo_conta_ptu(nr_seq_conta_p, null, null, null, nr_seq_analise_w, nm_usuario_p, nr_seq_item_criado_w);
		else
			nr_seq_item_criado_w := pls_gerar_w_resumo_conta(nr_seq_conta_p, null, null, null, nr_seq_analise_w, nm_usuario_p, nr_seq_item_criado_w);
		end if;

		/*OS - 421620 - Diego - Será gerada as ocorrências junto aos itens de modo a criar vinculação.
		Copiar as glosas e ocorrencias para a tabela ser usado na análise*/
		CALL pls_gerar_analise_conta_item(nr_seq_conta_p, nr_seq_analise_w, cd_estabelecimento_p, nm_usuario_p);
		update	pls_conta
		set	nr_seq_analise	= nr_seq_analise_w
		where	nr_sequencia	= nr_seq_conta_p;

		CALL pls_analise_status_item(nr_seq_conta_p,	null, null,
					nr_seq_analise_w, cd_estabelecimento_p,	nm_usuario_p,
					null);

		CALL pls_analise_status_pgto(nr_seq_conta_p,	null, null,
					nr_seq_analise_w, cd_estabelecimento_p,	nm_usuario_p,
					null,null,null,null);

		/* Francisco - 09/08/2012 - Mudei para fazer aqui, depois que já tiver gerado na analise todos os itens */

		CALL pls_cta_consistir_pck.gerar_resumo_conta(null, null, null, nr_seq_conta_p, nm_usuario_p, cd_estabelecimento_p);

		CALL pls_fechar_conta(nr_seq_conta_p, 'N','N','N', cd_estabelecimento_p, nm_usuario_p,null,null);

		--pls_gerar_sip_conta(nr_seq_conta_w, nm_usuario_p, cd_estabelecimento_p);
		CALL pls_altera_status_protocolo(nr_seq_protocolo_w,'L','N',cd_estabelecimento_p,nm_usuario_p);
	end if;

	/*Diego OS 307952 - 08/04/2011 -  Só ficarão com estágio "Em análise" quando houver ocorrências que devem gerar análise*/

	if (ie_gerar_analise_audit_w = 'S') then
		/*A análise é setada como sendo aguardando análise*/

		update	pls_analise_conta
		set	ie_status 	= 'G',
			ie_auditoria 	= 'S'
		where	nr_sequencia 	= nr_seq_analise_w;

		/*A conta é setada para ficar em análise*/

		update	pls_conta
		set	ie_status 	= 'A'
		where	nr_sequencia 	= nr_seq_conta_p;

		/*Assim como seus respectivos materiais e procedimentos*/

		update	pls_conta_proc
		set	ie_status 	= 'A'
		where	nr_seq_conta 	= nr_seq_conta_p
		and	ie_status 	<> 'D';

		update	pls_conta_mat
		set	ie_status 	= 'A'
		where	nr_seq_conta 	= nr_seq_conta_p;
	end if;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_gerar_analise_conta ( nr_seq_conta_p bigint, nm_usuario_p text, cd_estabelecimento_p text) FROM PUBLIC;

