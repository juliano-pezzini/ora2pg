-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE atuliza_precadastro (nr_seq_processo_p bigint, ie_tipo_processo_p text, ie_tipo_pre_cadastro_p text, cd_estabelecimento_p bigint, nm_usuario_p text) AS $body$
DECLARE


dt_liberacao_w timestamp := null;
dt_aprovacao_w timestamp := null;
nm_usuario_w varchar(255) := null;														
nm_tabela_pre_cadastro_w varchar(255) := null;													
nr_seq_pre_cad_w bigint := null;
ie_tipo_processo_w varchar(255);
													

BEGIN							

	if (ie_tipo_pre_cadastro_p = 'FPF') then
		nm_tabela_pre_cadastro_w := 'PESSOA_FISICA_PRECAD';
	elsif (ie_tipo_pre_cadastro_p = 'FPJ') then
		nm_tabela_pre_cadastro_w := 'PESSOA_JURIDICA_PRECAD';
	elsif (ie_tipo_pre_cadastro_p = 'MAT') then
		nm_tabela_pre_cadastro_w := 'MATERIAL_PRECAD';
	end if;

	if (ie_tipo_processo_p = 'LIBERAR') then
		dt_liberacao_w := clock_timestamp();
		nm_usuario_w := nm_usuario_p;
		ie_tipo_processo_w := wheb_mensagem_pck.get_texto(1150958);
	elsif (ie_tipo_processo_p = 'APROVAR') then
		dt_aprovacao_w := clock_timestamp();
		nm_usuario_w := nm_usuario_p;
		ie_tipo_processo_w := wheb_mensagem_pck.get_texto(1150959);
	elsif (ie_tipo_processo_p = 'ESTORNAR') then
		dt_liberacao_w := null;
		nm_usuario_w := null;
		ie_tipo_processo_w := wheb_mensagem_pck.get_texto(1150960);
	elsif (ie_tipo_processo_p = 'ESTORNAR_APROVACAO') then
		dt_aprovacao_w := null;
		nm_usuario_w := null;
		ie_tipo_processo_w := wheb_mensagem_pck.get_texto(1150961);
	end if;
	
	if (nm_tabela_pre_cadastro_w IS NOT NULL AND nm_tabela_pre_cadastro_w::text <> '') then

		EXECUTE 'select a.nr_sequencia from ' || nm_tabela_pre_cadastro_w || ' a where nr_seq_processo = :1' into STRICT nr_seq_pre_cad_w using nr_seq_processo_p;

		if (ie_tipo_processo_p = 'LIBERAR') then
			EXECUTE 'update ' || nm_tabela_pre_cadastro_w || ' set nm_usuario_lib = :1 , dt_liberacao = :2 where nr_sequencia = :3' using nm_usuario_w, dt_liberacao_w, nr_seq_pre_cad_w;
		elsif (ie_tipo_processo_p = 'APROVAR') then
			EXECUTE 'update ' || nm_tabela_pre_cadastro_w || ' set nm_usuario_aprov = :1 , dt_aprovacao = :2 where nr_sequencia = :3' using nm_usuario_w, dt_aprovacao_w, nr_seq_pre_cad_w;
			CALL criar_avaliacao_pre_cadastro(nr_seq_pre_cad_w,ie_tipo_pre_cadastro_p, 'S', cd_estabelecimento_p, nm_usuario_p);
		elsif (ie_tipo_processo_p = 'ESTORNAR') then
			EXECUTE 'update ' || nm_tabela_pre_cadastro_w || ' set nm_usuario_lib = :1 , dt_liberacao = :2 where nr_sequencia = :3' using nm_usuario_w, dt_liberacao_w, nr_seq_pre_cad_w;
			EXECUTE 'update ' || 'PROCESSO_PRE_CADASTRO' || ' set dt_liberacao = null, nm_usuario_lib = null where nr_sequencia = :1' using nr_seq_processo_p;
		elsif (ie_tipo_processo_p = 'ESTORNAR_APROVACAO') then
			EXECUTE 'update ' || nm_tabela_pre_cadastro_w || ' set nm_usuario_aprov = :1 , dt_aprovacao = :2 where nr_sequencia = :3' using nm_usuario_w, dt_aprovacao_w, nr_seq_pre_cad_w;
			EXECUTE 'update ' || 'PROCESSO_PRE_CADASTRO' || ' set dt_aprovacao = null, nm_usuario_aprov = null where nr_sequencia = :1' using nr_seq_processo_p;
		end if;
		
		insert into processo_precad_hist(nr_sequencia,
								 dt_atualizacao,
								 nm_usuario,
								 dt_atualizacao_nrec,
								 nm_usuario_nrec,
								 dt_liberacao,
								 nm_usuario_lib,
								 nr_seq_processo,
								 ds_historico
								 ) values (
								 nextval('processo_precad_hist_seq'),
								 clock_timestamp(),
								 nm_usuario_p,
								 clock_timestamp(),
								 nm_usuario_p,
								 clock_timestamp(),
								 nm_usuario_p,
								 nr_seq_processo_p,
								 ie_tipo_processo_w);					
		
		commit;

	end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE atuliza_precadastro (nr_seq_processo_p bigint, ie_tipo_processo_p text, ie_tipo_pre_cadastro_p text, cd_estabelecimento_p bigint, nm_usuario_p text) FROM PUBLIC;

