-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_gerar_coparticipacao_mat ( nr_sequencia_p pls_conta_mat.nr_sequencia%type, nm_usuario_p Usuario.nm_usuario%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type) AS $body$
DECLARE

	
_ora2pg_r RECORD;
nr_seq_conta_w			pls_conta.nr_sequencia%type;
nr_seq_plano_w			pls_plano.nr_sequencia%type;
ie_preco_plano_w		pls_plano.ie_preco%type;
dt_preco_w			pls_conta_mat.dt_atendimento_referencia%type;
nr_seq_material_w		pls_conta_mat_v.nr_seq_material%type;
ie_tipo_despesa_w		pls_conta_mat_v.ie_tipo_despesa%type;
ie_origem_preco_w		pls_conta_mat_v.ie_origem_preco%type;
nr_seq_outorgante_w		pls_plano.nr_seq_outorgante%type;
nr_seq_segurado_w		pls_conta_v.nr_seq_segurado%type;
nr_seq_intercambio_w		pls_segurado.nr_seq_intercambio%type;
nr_seq_prest_fornec_w		pls_conta_mat_v.nr_seq_prest_fornec%type;
nr_seq_tipo_acomodacao_w	pls_conta_v.nr_seq_tipo_acomodacao%type;
nr_seq_categoria_w		pls_regra_categoria.nr_seq_categoria%type;
nr_seq_tipo_atendimento_w	pls_conta_v.nr_seq_tipo_atendimento%type;
nr_seq_clinica_w		pls_conta_v.nr_seq_clinica%type;
ie_tipo_guia_w			pls_conta_v.ie_tipo_guia%type;
nr_seq_plano_espec_w		pls_conta_v.nr_seq_guia%type;
cd_guia_referencia_w		pls_conta_v.cd_guia_referencia%type;
ie_tipo_segurado_w		pls_segurado.ie_tipo_segurado%type;
ie_tipo_vinculo_w		pls_conta_v.ie_tipo_vinculo_prest_exec%type;
nr_seq_tipo_prest_exec_w	pls_conta_v.nr_seq_tipo_prest_exec%type;
nr_seq_contrato_w		pls_segurado.nr_seq_contrato%type;
nr_seq_congenere_w		pls_segurado.nr_seq_congenere%type;
nr_seq_clas_prest_exec_w	pls_conta_v.nr_seq_clas_prest_exec%type;	
sg_estado_outorg_w		pessoa_juridica.sg_estado%type;
sg_estado_int_w			pessoa_juridica.sg_estado%type;
ie_tipo_contratacao_w		pls_plano.ie_tipo_contratacao%type;
nr_seq_regra_copartic_w		pls_conta_mat.nr_seq_regra_copartic%type;
dados_regra_preco_material_w	pls_cta_valorizacao_pck.dados_regra_preco_material;	
ie_autorizacao_espec_w		varchar(1)	:= 'N';
vl_mat_copartic_w		double precision	:= 0;
qt_autorizacao_espec_w		bigint;
ds_retorno_ww			varchar(255);
ie_internado_w			varchar(3);
ie_calculo_coparticipacao_w	varchar(1);
ie_restringe_estab_w		varchar(1);
ie_regime_atendimento_w	pls_conta.ie_regime_atendimento%type;
ie_saude_ocupacional_w	pls_conta.ie_saude_ocupacional%type;	


BEGIN

/* Obter parametros da conta medica */

ie_restringe_estab_w	:= pls_obter_se_controle_estab('CO');

select	coalesce(max(ie_calculo_coparticipacao),'P')
into STRICT	ie_calculo_coparticipacao_w
from	pls_parametros
where	(((coalesce(ie_restringe_estab_w,'S')= 'S') and (cd_estabelecimento	= cd_estabelecimento_p))
or (coalesce(ie_restringe_estab_w,'S')	= 'N'));

select  nr_seq_conta,
	coalesce(dt_atendimento,clock_timestamp()) dt_atendimento,
	nr_seq_material,
	ie_tipo_despesa,
	ie_origem_preco,
	nr_seq_prest_fornec	
into STRICT	nr_seq_conta_w,
	dt_preco_w,
	nr_seq_material_w,
	ie_tipo_despesa_w,
	ie_origem_preco_w,
	nr_seq_prest_fornec_w
from	pls_conta_mat_v
where 	nr_sequencia = nr_sequencia_p;

select	nr_seq_plano,
	nr_seq_segurado,
	coalesce(nr_seq_tipo_acomodacao,0) nr_seq_tipo_acomodacao,
	coalesce(nr_seq_tipo_atendimento,0) nr_seq_tipo_atendimento,
	nr_seq_clinica,
	ie_tipo_guia,
	nr_seq_guia,
	cd_guia_referencia,
	ie_tipo_vinculo_prest_exec,
	nr_seq_tipo_prest_exec,
	nr_seq_clas_prest_exec,
	coalesce(ie_tipo_segurado,'B'),
	ie_regime_atendimento,
	ie_saude_ocupacional
into STRICT	nr_seq_plano_w,
	nr_seq_segurado_w,
	nr_seq_tipo_acomodacao_w,
	nr_seq_tipo_atendimento_w,
	nr_seq_clinica_w,
	ie_tipo_guia_w,
	nr_seq_plano_espec_w,
	cd_guia_referencia_w,
	ie_tipo_vinculo_w,
	nr_seq_tipo_prest_exec_w,
	nr_seq_clas_prest_exec_w,
	ie_tipo_segurado_w,
	ie_regime_atendimento_w,
	ie_saude_ocupacional_w
from	pls_conta_v
where	nr_sequencia = nr_seq_conta_w;

select	nr_seq_intercambio,
	coalesce(nr_seq_contrato,0),
	nr_seq_congenere
into STRICT	nr_seq_intercambio_w,
	nr_seq_contrato_w,
	nr_seq_congenere_w
from	pls_segurado
where	nr_sequencia = nr_seq_segurado_w;

select	ie_preco,
	nr_seq_outorgante,
	ie_tipo_contratacao
into STRICT	ie_preco_plano_w,
	nr_seq_outorgante_w,
	ie_tipo_contratacao_w
from	pls_plano
where	nr_sequencia = nr_seq_plano_w;

/* Obter a categoria do tipo de acomodacao */
if (nr_seq_tipo_acomodacao_w IS NOT NULL AND nr_seq_tipo_acomodacao_w::text <> '') then
	select	max(nr_seq_categoria)
	into STRICT	nr_seq_categoria_w
	from	pls_regra_categoria
	where	nr_seq_tipo_acomodacao	= nr_seq_tipo_acomodacao_w;
end if;

if (coalesce(nr_seq_plano_espec_w::text, '') = '') then
	/*Obter sequencia da autorizacao  especial*/

	select	max(nr_sequencia)
	into STRICT	nr_seq_plano_espec_w
	from	pls_guia_plano
	where	cd_guia		= cd_guia_referencia_w
	and	nr_seq_segurado = nr_seq_segurado_w;
end if;

/* Obter a UF da operadora  - Tasy*/

select	coalesce(max(sg_estado),'X')
into STRICT	sg_estado_outorg_w
from	pessoa_juridica
where	cd_cgc	= (	SELECT	max(cd_cgc_outorgante)
			from	pls_outorgante
			where	cd_estabelecimento	= cd_estabelecimento_p);
			
/* Obter a UF da operadora do beneficiario eventual ou que enviou o protocolo*/

select	coalesce(max(a.sg_estado),'X')
into STRICT	sg_estado_int_w
from	pessoa_juridica	a,
	pls_congenere	b
where	a.cd_cgc	= b.cd_cgc
and	b.nr_sequencia	= nr_seq_congenere_w;

/*Obter se existe material especial*/

select	count(1)
into STRICT	qt_autorizacao_espec_w
from	pls_solic_lib_mat_med	a,
	pls_guia_plano		b
where	a.nr_seq_guia	= b.nr_sequencia
and	b.nr_sequencia	= nr_seq_plano_espec_w;

if (qt_autorizacao_espec_w	> 0) then
	ie_autorizacao_espec_w	:= 'S';
end if;

ie_internado_w	:= pls_obter_se_internado(nr_seq_conta_w,'C');
if (ie_internado_w	= 'N') then
	ie_internado_w	:= 'S';
end if;

--PLS_Parametros.ie_calculo_coparticipacao (P,O,R)(Prestador,Operadora,Depende de regra)
if (ie_calculo_coparticipacao_w in ('O','R')) and (ie_preco_plano_w = '1') then
			
	SELECT * FROM pls_define_preco_material(cd_estabelecimento_p, null, dt_preco_w, nr_seq_material_w, 4, ie_tipo_despesa_w, ie_origem_preco_w, 'CO', nr_seq_outorgante_w, nr_seq_segurado_w, nr_seq_intercambio_w, nr_seq_prest_fornec_w, nr_seq_categoria_w, nr_seq_tipo_acomodacao_w, nr_seq_tipo_atendimento_w, nr_seq_clinica_w, ie_tipo_guia_w, ie_autorizacao_espec_w, nr_seq_plano_espec_w, 'N', nm_usuario_p, nr_sequencia_p, '', ie_tipo_segurado_w, ie_tipo_vinculo_w, nr_seq_tipo_prest_exec_w, ie_preco_plano_w, null, null, nr_seq_conta_w, nr_seq_plano_w, nr_seq_contrato_w, nr_seq_congenere_w, ie_internado_w, nr_seq_clas_prest_exec_w, sg_estado_outorg_w, sg_estado_int_w, ie_tipo_contratacao_w, vl_mat_copartic_w, ds_retorno_ww, ds_retorno_ww, ds_retorno_ww, ds_retorno_ww, ds_retorno_ww, dados_regra_preco_material_w, null, ie_regime_atendimento_w, ie_saude_ocupacional_w) INTO STRICT _ora2pg_r;
 vl_mat_copartic_w := _ora2pg_r.vl_material_p; ds_retorno_ww := _ora2pg_r.dt_ult_vigencia_p; ds_retorno_ww := _ora2pg_r.nr_seq_material_preco_p; ds_retorno_ww := _ora2pg_r.vl_material_simpro_p; ds_retorno_ww := _ora2pg_r.vl_material_brasindice_p; ds_retorno_ww := _ora2pg_r.vl_material_tabela_p; dados_regra_preco_material_w := _ora2pg_r.dados_regra_preco_material_p;
			
	nr_seq_regra_copartic_w	:= dados_regra_preco_material_w.nr_sequencia;
	
	update	pls_conta_mat
	set	vl_mat_copartic		= vl_mat_copartic_w,
		nr_seq_regra_copartic	= nr_seq_regra_copartic_w
	where	nr_sequencia		= nr_sequencia_p;
end if;
	

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_gerar_coparticipacao_mat ( nr_sequencia_p pls_conta_mat.nr_sequencia%type, nm_usuario_p Usuario.nm_usuario%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type) FROM PUBLIC;

