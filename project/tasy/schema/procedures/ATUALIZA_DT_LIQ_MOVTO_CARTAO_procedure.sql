-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE atualiza_dt_liq_movto_cartao (nr_seq_parcela_p text, nm_usuario_p text) AS $body$
DECLARE


ie_atualiza_dt_baixa_w		varchar(1);
nr_seq_lote_w				movto_cartao_cr_parcela.nr_seq_lote%type;
nr_seq_movto_w				movto_cartao_cr_parcela.nr_seq_movto%type;
nr_seq_movto_pend_w			movto_banco_pend_baixa.nr_seq_movto_pend%type;
dt_baixa_cartao_w			movto_cartao_cr.dt_baixa%type;
vl_saldo_cartao_w		 	double precision;
dt_credito_cni_w				movto_banco_pend.dt_liquidacao%type;


BEGIN

ie_atualiza_dt_baixa_w := Obter_Param_Usuario(3020, 65, obter_perfil_ativo, nm_usuario_p, obter_estabelecimento_ativo, ie_atualiza_dt_baixa_w);

if (nr_seq_parcela_p IS NOT NULL AND nr_seq_parcela_p::text <> '') and (coalesce(ie_atualiza_dt_baixa_w,'N') = 'S') then
	begin
	select	max(a.nr_seq_lote),
			max(a.nr_seq_movto)
	into STRICT	nr_seq_lote_w,
			nr_seq_movto_w
	from	movto_cartao_cr_parcela a
	where	nr_sequencia	= nr_seq_parcela_p;

	if (nr_seq_movto_w IS NOT NULL AND nr_seq_movto_w::text <> '') then

		select	max(a.dt_baixa),
				(obter_saldo_cartao_cr(max(a.nr_sequencia),null))::numeric
		into STRICT	dt_baixa_cartao_w,
				vl_saldo_cartao_w
		from	movto_cartao_cr a
		where	a.nr_sequencia = nr_seq_movto_w;

	end if;

	/*Se a parcela estiver em lote, verificar se o lote possui CNI vinculado*/

	if (nr_seq_lote_w IS NOT NULL AND nr_seq_lote_w::text <> '') then

		select  max(nr_seq_movto_pend)
        into STRICT    nr_seq_movto_pend_w
        from    movto_banco_pend_baixa
        where   nr_seq_lote_cartao      = nr_seq_lote_w;

		/*Se tiver CNI vinculado, pegar a data de liquidacao dele para atualizar no movimento de cartão*/

		if (nr_seq_movto_pend_w IS NOT NULL AND nr_seq_movto_pend_w::text <> '') then

			select	max(a.dt_credito)
			into STRICT	dt_credito_cni_w
			from	movto_banco_pend a
			where	a.nr_sequencia = nr_seq_movto_pend_w;

			if (dt_baixa_cartao_w IS NOT NULL AND dt_baixa_cartao_w::text <> '') and (vl_saldo_cartao_w = 0) and (dt_credito_cni_w IS NOT NULL AND dt_credito_cni_w::text <> '') then

				update	movto_cartao_cr a
				set		a.dt_baixa 		= coalesce(dt_credito_cni_w,a.dt_baixa)
				where	a.nr_sequencia	= nr_seq_movto_w;

				commit;

			end if;

		end if;

	end if;
	exception when others then
		/*Não foi possível obter a data de liquidação do crédito não identificado para utilizar como data de liquidação das movimentações do lote que serão liquidadas. Verifique se o mesmo possui uma data válida.*/

		CALL wheb_mensagem_pck.exibir_mensagem_abort(359452);
	end;

end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE atualiza_dt_liq_movto_cartao (nr_seq_parcela_p text, nm_usuario_p text) FROM PUBLIC;

