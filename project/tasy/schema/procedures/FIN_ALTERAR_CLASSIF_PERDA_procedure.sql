-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE fin_alterar_classif_perda ( nr_seq_perda_p bigint, ie_tipo_perda_p text, nm_usuario_p text) AS $body$
DECLARE

 
cd_estabelecimento_w	smallint;
vl_saldo_w		double precision;
ie_tipo_perda_w		varchar(1);
nr_seq_tipo_baixa_w	bigint;
nr_sequencia_w		integer;
nr_sequencia_ww		integer;

nr_seq_cobranca_w	bigint;
nr_seq_cheque_w		bigint;
nr_titulo_w		bigint;
nr_seq_hist_cob_w		bigint;


BEGIN 
 
begin 
select	coalesce(vl_saldo,0), 
	coalesce(ie_tipo_perda,'R'), 
	nr_seq_cheque, 
	nr_titulo, 
	cd_estabelecimento 
into STRICT	vl_saldo_w, 
	ie_tipo_perda_w, 
	nr_seq_cheque_w, 
	nr_titulo_w, 
	cd_estabelecimento_w 
from	perda_contas_receber 
where	nr_sequencia = nr_seq_perda_p;
exception 
when others then 
	ie_tipo_perda_w := 'X';
end;
 
select	max(nr_sequencia) 
into STRICT	nr_seq_tipo_baixa_w 
from	fin_tipo_baixa_perda 
where	ie_tipo_consistencia = '5' 
and	ie_situacao = 'A';
 
if (coalesce(nr_seq_tipo_baixa_w::text, '') = '') then 
	CALL wheb_mensagem_pck.exibir_mensagem_abort(214619);
end if;
 
if	((ie_tipo_perda_w = 'R') and (vl_saldo_w > 0) and (ie_tipo_perda_p = 'I')) or 
	(ie_tipo_perda_w = 'I' AND ie_tipo_perda_p = 'R') then 
	begin 
	if (ie_tipo_perda_p = 'I')	 then 
		begin		 
		select	coalesce(max(nr_sequencia),0) + 1 
		into STRICT	nr_sequencia_w 
		from	perda_contas_receb_baixa 
		where	nr_seq_perda = nr_seq_perda_p;
 
 
		insert into perda_contas_receb_baixa( 
			nr_sequencia, 
			dt_atualizacao, 
			nm_usuario, 
			dt_atualizacao_nrec, 
			nm_usuario_nrec, 
			nr_seq_perda, 
			dt_baixa, 
			vl_baixa, 
			nr_seq_tipo_baixa, 
			ie_acao) 
		values (	nr_sequencia_w, 
			clock_timestamp(), 
			nm_usuario_p, 
			clock_timestamp(), 
			nm_usuario_p, 
			nr_seq_perda_p, 
			clock_timestamp(), 
			vl_saldo_w, 
			nr_seq_tipo_baixa_w, 
			1);
			 
		CALL fin_atualizar_saldo_perda(nr_seq_perda_p, nm_usuario_p);
		 
		update	perda_contas_receber 
		set	ie_tipo_perda = ie_tipo_perda_p, 
			nm_usuario = nm_usuario_p, 
			dt_atualizacao = clock_timestamp(), 
			dt_liquidacao = clock_timestamp() 
		where	nr_sequencia = nr_seq_perda_p;
		end;
	else 
		begin	 
		 
		select	coalesce(max(a.vl_baixa),0) 
		into STRICT	vl_saldo_w 
		from	perda_contas_receb_baixa a, 
				fin_tipo_baixa_perda b 
		where	a.nr_seq_tipo_baixa = b.nr_sequencia 
		and		b.ie_tipo_consistencia in (5,2) 
		and		a.vl_baixa > 0 
		and		coalesce(ie_acao,1) = 1 
		and		a.nr_seq_perda = nr_seq_perda_p 
		and		a.nr_sequencia = (SELECT max(x.nr_sequencia) 
								 from	 perda_contas_receb_baixa x 
								 where	 x.nr_seq_perda = a.nr_seq_perda);
		 
		 
		if (vl_saldo_w > 0) then 
			begin 
			select	coalesce(max(nr_sequencia),0) + 1 
			into STRICT	nr_sequencia_w 
			from	perda_contas_receb_baixa 
			where	nr_seq_perda = nr_seq_perda_p;
			 
			insert into perda_contas_receb_baixa( 
				nr_sequencia, 
				dt_atualizacao, 
				nm_usuario, 
				dt_atualizacao_nrec, 
				nm_usuario_nrec, 
				nr_seq_perda, 
				dt_baixa, 
				vl_baixa, 
				nr_seq_tipo_baixa, 
				ie_acao) 
			values (	nr_sequencia_w, 
				clock_timestamp(), 
				nm_usuario_p, 
				clock_timestamp(), 
				nm_usuario_p, 
				nr_seq_perda_p, 
				clock_timestamp(), 
				vl_saldo_w * -1, 
				nr_seq_tipo_baixa_w, 
				1);
				 
			CALL fin_atualizar_saldo_perda(nr_seq_perda_p, nm_usuario_p);
			 
			update	perda_contas_receber 
			set	ie_tipo_perda = ie_tipo_perda_p, 
				nm_usuario = nm_usuario_p, 
				dt_atualizacao = clock_timestamp(), 
				dt_liquidacao  = NULL 
			where	nr_sequencia = nr_seq_perda_p;
			end;
		end if;
		end;
	end if;
	 
	CALL fin_atualiza_cobranca_perda(nr_seq_perda_p, 'AS', 'N', nm_usuario_p);
 
	commit;
	end;
end if;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE fin_alterar_classif_perda ( nr_seq_perda_p bigint, ie_tipo_perda_p text, nm_usuario_p text) FROM PUBLIC;

