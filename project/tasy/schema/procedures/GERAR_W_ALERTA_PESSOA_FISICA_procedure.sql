-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_w_alerta_pessoa_fisica ( cd_pessoa_fisica_p bigint, nm_usuario_p text) AS $body$
DECLARE

 
ie_tipo_alerta_w		varchar(1);
ds_confirmacao_w		varchar(255);
ds_inicio_cirurgia_w		varchar(50);
ds_inicio_medic_uso_w		varchar(50);
ds_tipo_reacao_w		varchar(100);
ds_agente_w			varchar(255);
ds_ficha_tecnica_derivados_w	varchar(2000);
ds_acessorio_ort_prot_w		varchar(255);
ds_tipo_vicio_w			varchar(80);
ds_freq_vicio_w			varchar(240);
ds_doenca_w			varchar(200);
ds_status_doenca_w		varchar(240);
ds_cirurgia_w			varchar(240);
dt_cirurgia_w			timestamp;
ds_droga_w			varchar(100);
dt_inicio_w			timestamp;
ds_observacao_w			varchar(2000);
cd_nivel_w			smallint;
ds_restricao_w			varchar(255);
ie_nao_sabe_fim_w		varchar(1);
ie_confirmacao_w		varchar(1);
ds_acessorio_w			varchar(255);
ds_localizacao_w		varchar(255);
cd_pessoa_alerta_w		varchar(10);
nm_pessoa_alerta_w		varchar(255);
ds_derivados_w			varchar(255);
ds_alergias_readv_w		varchar(255);
ds_habitos_vicios_w		varchar(255);
ds_doencas_previas_atuais_w	varchar(255);
ds_cirurgia_pessoa_w		varchar(255);
ds_medic_uso_w			varchar(255);
ds_restricoes_pessoa_w		varchar(255);
nr_seq_alerta_w			bigint;
C01 CURSOR FOR	
	SELECT	cd_pessoa_alerta, 
		obter_nome_pf(cd_pessoa_alerta) nm_pessoa_alerta, 
		ie_tipo_alerta, 
		 ds_tipo_reacao, 
		 coalesce(coalesce(coalesce(coalesce(coalesce(coalesce(ds_ficha_tecnica,ds_dcb),ds_dcb_mat),ds_material),ds_classe_mat),ds_medic_nao_cad),ds_alergeno) ds_agente, 
		 ds_ficha_tecnica_derivados, 
		 ds_tipo_vicio, 
		 ds_freq_vicio, 
		 coalesce(ds_doenca,ds_doenca_sae) ds_doenca, 
		 ds_status_doenca, 
		 coalesce(ds_proced_desc,ds_procedimento) ds_cirurgia, 
		 dt_cirurgia, 
		 coalesce(ds_medicamento,ds_medic_uso) ds_droga, 
		 dt_inicio, 
		 ds_observacao, 
		 cd_nivel, 
		 ds_restricao, 
		 ie_nao_sabe_fim, 
		 ie_confirmacao, 
		 ds_acessorio, 
		 ds_localizacao, 
		 nr_seq_alerta 
	from   alerta_v 
	where  cd_pessoa_alerta = cd_pessoa_fisica_p 
	and	 (dt_liberacao IS NOT NULL AND dt_liberacao::text <> '') 
	/*and   ((ie_tipo_alerta <> 'A') or 
		 exists (select	1 
			 from	paciente_alergia x 
	  		 where	x.nr_sequencia = nr_seq_alerta 
			 and nvl(x.ie_nega_alergias,'N') = 'N'))*/
 
	order by nr_seq_apresent, 
		 cd_nivel desc;


BEGIN 
 
delete 
from	w_alerta_pessoa_fisica;
 
ds_derivados_w := 'DERIVADOS CORRESPONDENTES: ';
 
open C01;
loop 
fetch C01 into 
	 cd_pessoa_alerta_w, 
	 nm_pessoa_alerta_w, 
	 ie_tipo_alerta_w, 
	 ds_tipo_reacao_w, 
	 ds_agente_w, 
	 ds_ficha_tecnica_derivados_w, 
	 ds_tipo_vicio_w, 
	 ds_freq_vicio_w, 
	 ds_doenca_w, 
	 ds_status_doenca_w, 
	 ds_cirurgia_w, 
	 dt_cirurgia_w, 
	 ds_droga_w, 
	 dt_inicio_w, 
	 ds_observacao_w, 
	 cd_nivel_w, 
	 ds_restricao_w, 
	 ie_nao_sabe_fim_w, 
	 ie_confirmacao_w, 
	 ds_acessorio_w, 
	 ds_localizacao_w, 
	 nr_seq_alerta_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin 
	 
	if (ie_tipo_alerta_w = 'A') then 
		begin 
		ds_confirmacao_w := 'CONFIRMADA: ';
		if (ie_confirmacao_w = 'S')	then 
			ds_confirmacao_w := 'SUSPEITA: ';
		end if;
		 
		if (ds_tipo_reacao_w IS NOT NULL AND ds_tipo_reacao_w::text <> '')	then 
			begin 
			if (ds_observacao_w IS NOT NULL AND ds_observacao_w::text <> '')	then 
				ds_alergias_readv_w := ds_confirmacao_w || ds_agente_w || ' (' || ds_tipo_reacao_w || ')' || ' - ' || ds_observacao_w;
			else 
				ds_alergias_readv_w := ds_confirmacao_w || ds_agente_w || ' (' || ds_tipo_reacao_w || ')';
			end if;
			end;
		else 
			begin 
			if (ds_observacao_w IS NOT NULL AND ds_observacao_w::text <> '')	then 
				ds_alergias_readv_w := ds_confirmacao_w || ds_agente_w || ' - ' || ds_observacao_w;
			else 
				ds_alergias_readv_w := ds_confirmacao_w || ds_agente_w;
			end if;
			end;
		end if;
		 
		if (ds_ficha_tecnica_derivados_w IS NOT NULL AND ds_ficha_tecnica_derivados_w::text <> '')	then 
			ds_alergias_readv_w := ds_derivados_w || ds_ficha_tecnica_derivados_w;
		end if;
		end;
	elsif (ie_tipo_alerta_w = 'H')	then 
			ds_habitos_vicios_w := ds_tipo_vicio_w || ' (' || ds_freq_vicio_w || ')';
	elsif (ie_tipo_alerta_w = 'D')	then 
		begin 
			if (ds_status_doenca_w IS NOT NULL AND ds_status_doenca_w::text <> '')	then 
				ds_doencas_previas_atuais_w := ds_doenca_w || ' (' || ds_status_doenca_w || ')';
			else 
				ds_doencas_previas_atuais_w := ds_doenca_w;
			end if;
		end;
	elsif (ie_tipo_alerta_w = 'C')	then 
		begin 
			ds_inicio_cirurgia_w := '';
			if (dt_cirurgia_w IS NOT NULL AND dt_cirurgia_w::text <> '')	then 
				ds_inicio_cirurgia_w := ' (' || dt_cirurgia_w || ')';
				ds_cirurgia_pessoa_w := ds_cirurgia_w || ds_inicio_cirurgia_w;
			end if;
		end;
	elsif (ie_tipo_alerta_w = 'M')	then 
		begin 
		ds_medic_uso_w := ds_droga_w || ds_inicio_medic_uso_w;
		end;
	elsif (ie_tipo_alerta_w = 'R')	then 
		begin 
		ds_restricoes_pessoa_w := ds_restricao_w;
		end;
	elsif (ie_tipo_alerta_w = 'O')	then 
		begin 
		ds_acessorio_ort_prot_w := ds_acessorio_w || ' (' || ds_localizacao_w || ')';
		end;
	end if;
	 
	insert into w_alerta_pessoa_fisica(	nr_sequencia, 
						ds_alergia_reacao_adv, 
						ds_habito_vicio, 
						ds_doencas_prev_atuais, 
						ds_cirurgia_pessoa, 
						ds_medic_uso, 
						ds_restricao_pessoa, 
						ds_acessorio_ort_prot, 
						cd_pessoa_fisica, 
						nm_pessoa_fisica, 
						nm_usuario, 
						nm_usuario_nrec, 
						dt_atualizacao, 
						dt_atualizacao_nrec) 
					values (	nextval('w_alerta_pessoa_fisica_seq'), 
						ds_alergias_readv_w, 
						ds_habitos_vicios_w, 
						ds_doencas_previas_atuais_w, 
						ds_cirurgia_pessoa_w, 
						ds_medic_uso_w, 
						ds_restricoes_pessoa_w, 
						ds_acessorio_ort_prot_w, 
						cd_pessoa_alerta_w, 
						nm_pessoa_alerta_w, 
						nm_usuario_p, 
						nm_usuario_p, 
						clock_timestamp(), 
						clock_timestamp());
	end;
 
end loop;
close C01;
commit;
 
exception when others then 
	null;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_w_alerta_pessoa_fisica ( cd_pessoa_fisica_p bigint, nm_usuario_p text) FROM PUBLIC;

