-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pfcs_average_arrival_time ( nr_seq_indicator_p bigint, cd_estabelecimento_p text, nm_usuario_p text) AS $body$
DECLARE

	
c01 CURSOR FOR
	SELECT	a.cd_pessoa_fisica id_patient,
		coalesce(get_formatted_person_name(a.cd_pessoa_fisica, 'list'), obter_nome_pf(a.cd_pessoa_fisica)) nm_patient,
		pfcs_obter_lista_dados_classif(a.cd_pessoa_fisica) ds_classification,
		obter_sexo_pf(a.cd_pessoa_fisica, 'D') ds_gender,
		pf.dt_nascimento dt_birthdate,
    obter_dados_pf(a.cd_pessoa_fisica, 'I') qt_idade_paciente,
		a.nr_atendimento nr_encounter,
		a.dt_entrada dt_entrance,
		round((clock_timestamp() - a.dt_entrada) * 1440) qt_time_hospitalization
	from	atendimento_paciente a, pessoa_fisica pf
	where	coalesce(a.dt_cancelamento::text, '') = ''
	and	a.ie_tipo_atendimento = 3
	and	a.cd_estabelecimento = (cd_estabelecimento_p)::numeric
	and	a.cd_pessoa_fisica = pf.cd_pessoa_fisica
	and	get_if_encounter_still_pa(a.nr_atendimento) = 'S'
	and coalesce(a.dt_alta::text, '') = '';

nr_seq_operational_level_w		pfcs_operational_level.nr_sequencia%type;
pfcs_panel_detail_seq_w			pfcs_panel_detail.nr_sequencia%type;
nr_seq_panel_w				pfcs_panel_detail.nr_seq_panel%type;
qt_average_time_w			pfcs_panel.vl_indicator%type;
qt_total_time_patient_w			bigint := 0;
qt_total_patient_w			bigint := 0;


BEGIN

	nr_seq_operational_level_w := pfcs_get_structure_level(
									cd_establishment_p => cd_estabelecimento_p,
									ie_level_p => 'O',
									ie_info_p => 'C');

	for r_c01 in c01 loop
		begin

			qt_total_time_patient_w := qt_total_time_patient_w + r_c01.qt_time_hospitalization;
			qt_total_patient_w := qt_total_patient_w + 1;

			select 	nextval('pfcs_panel_detail_seq')
			into STRICT 	pfcs_panel_detail_seq_w
			;

			insert into pfcs_panel_detail(
				nr_sequencia,
				nm_usuario,
				dt_atualizacao,
				nm_usuario_nrec,
				dt_atualizacao_nrec,
				ie_situation,
				nr_seq_indicator,
				nr_seq_operational_level)
			values (
				pfcs_panel_detail_seq_w,
				nm_usuario_p,
				clock_timestamp(),
				nm_usuario_p,
				clock_timestamp(),
				'T',
				nr_seq_indicator_p,
				nr_seq_operational_level_w);

			insert into pfcs_detail_patient(
				nr_sequencia,
				dt_atualizacao,
				nm_usuario,
				dt_atualizacao_nrec,
				nm_usuario_nrec,
				nr_encounter,
				dt_entrance,
				id_patient,
				nm_patient,
				ds_gender,
				ds_classification,
				dt_birthdate,
        ds_age_range,
				qt_time_total_hospitalization,
				nr_seq_detail)
			values (
				nextval('pfcs_detail_patient_seq'),
				clock_timestamp(),
				nm_usuario_p,
				clock_timestamp(),
				nm_usuario_p,
				r_c01.nr_encounter,
				r_c01.dt_entrance,
				r_c01.id_patient,
				r_c01.nm_patient,
				r_c01.ds_gender,
				r_c01.ds_classification,
				r_c01.dt_birthdate,
        r_c01.qt_idade_paciente,
				r_c01.qt_time_hospitalization,
				pfcs_panel_detail_seq_w);

		end;
	end loop;


	commit;

	 := pfcs_pck.pfcs_generate_results(
			vl_indicator_p => qt_total_time_patient_w, vl_indicator_aux_p => qt_total_patient_w, ds_reference_value_p => '', nr_seq_indicator_p => nr_seq_indicator_p, nr_seq_operational_level_p => nr_seq_operational_level_w, nm_usuario_p => nm_usuario_p, nr_seq_panel_p => nr_seq_panel_w);

	CALL pfcs_pck.pfcs_update_detail(
			nr_seq_indicator_p => nr_seq_indicator_p,
			nr_seq_panel_p => nr_seq_panel_w,
			nr_seq_operational_level_p => nr_seq_operational_level_w,
			nm_usuario_p => nm_usuario_p);

	CALL pfcs_pck.pfcs_activate_records(
			nr_seq_indicator_p => nr_seq_indicator_p,
			nr_seq_operational_level_p => nr_seq_operational_level_w,
			nm_usuario_p => nm_usuario_p);

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pfcs_average_arrival_time ( nr_seq_indicator_p bigint, cd_estabelecimento_p text, nm_usuario_p text) FROM PUBLIC;

