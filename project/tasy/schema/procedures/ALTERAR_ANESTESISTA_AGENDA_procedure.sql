-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE alterar_anestesista_agenda ( nr_seq_agenda_p bigint, cd_anestesista_p text, nr_seq_escala_p bigint, nm_usuario_p text) AS $body$
DECLARE

				 
nr_atendimento_w 		bigint;
nr_cirurgia_w	 		bigint;
ie_gera_hist_w			varchar(1);
nm_paciente_w  		varchar(255);
dt_agenda_w				varchar(30);
nm_anestesista_w 		varchar(255);
ds_historico_w			varchar(4000);
nm_agenda_w				varchar(255);
nm_anestesista_old_w	varchar(255);
cd_anestesista_old_w	varchar(10);


BEGIN 
 
ie_gera_hist_w := obter_param_usuario(871, 757, wheb_usuario_pck.get_cd_perfil, nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento, ie_gera_hist_w);
 
if (nr_seq_agenda_p > 0) then 
	select	max(cd_anestesista) 
	into STRICT	cd_anestesista_old_w 
	from	agenda_paciente 
	where	nr_sequencia	= nr_seq_agenda_p;
	 
	update	agenda_paciente 
	set	cd_anestesista	= cd_anestesista_p, 
		nm_usuario	= nm_usuario_p 
	where	nr_sequencia	= nr_seq_agenda_p;
 
	insert into 
		agenda_paciente_escala(nr_sequencia, 
					nr_seq_agenda, 
					nr_seq_escala, 
					cd_anestesista, 
					dt_atualizacao, 
					nm_usuario, 
					dt_atualizacao_nrec, 
					nm_usuario_nrec) 
				values (nextval('agenda_paciente_escala_seq'), 
					nr_seq_agenda_p, 
					nr_seq_escala_p, 
					cd_anestesista_p, 
					clock_timestamp(), 
					nm_usuario_p, 
					clock_timestamp(), 
					nm_usuario_p);
 
	if (ie_gera_hist_w = 'S') then 
		select	substr(CASE WHEN coalesce(max(cd_pessoa_fisica)::text, '') = '' THEN max(nm_paciente)  ELSE obter_nome_pf(max(cd_pessoa_fisica)) END ,1,240), 
			to_char(max(dt_agenda),'dd/mm/yyyy') || ' ' || to_char(max(hr_inicio),'hh24:mi:ss'), 
			max(nr_atendimento), 
			max(nr_cirurgia), 
			max(substr(nm_agenda,1,255)) 
		into STRICT	nm_paciente_w, 
			dt_agenda_w, 
			nr_atendimento_w, 
			nr_cirurgia_w, 
			nm_agenda_w 
		from	programacao_cirurgica_v	 
		where	nr_sequencia	= nr_seq_agenda_p;
		 
		nm_anestesista_w	:= SUBSTR(obter_nome_pf(cd_anestesista_p),1,255);
	 
		if (coalesce(cd_anestesista_old_w::text, '') = '') then 
			ds_historico_w	:= wheb_mensagem_pck.get_texto(300459, 'NM_PACIENTE_W=' || nm_paciente_w || ';DT_AGENDA_W=' || dt_agenda_w || ' ' || nm_agenda_w || 
									';NR_SEQ_AGENDA_P=' || nr_seq_agenda_p || ';NM_ANESTESISTA_W=' || nm_anestesista_w || 
									';NR_SEQ_ESCALA_P=' || SUBSTR(OBTER_DESC_ESCALA(nr_seq_escala_p),1,255));
		else 
			nm_anestesista_old_w	:= SUBSTR(obter_nome_pf(cd_anestesista_old_w),1,255);
			ds_historico_w	:= wheb_mensagem_pck.get_texto(300460, 'NM_PACIENTE_W=' || nm_paciente_w || ';DT_AGENDA_W=' || dt_agenda_w || ' ' || nm_agenda_w || 
									';NR_SEQ_AGENDA_P=' || nr_seq_agenda_p || ';NM_ANESTESISTA_OLD=' || nm_anestesista_old_w || ';NM_ANESTESISTA_W=' || nm_anestesista_w || 
									';NR_SEQ_ESCALA_P=' || SUBSTR(OBTER_DESC_ESCALA(nr_seq_escala_p),1,255));
		end if;		
		CALL grava_historico_agenda_cir(nr_seq_agenda_p,ds_historico_w,Obter_Pessoa_Fisica_Usuario(nm_usuario_p,'C'),null,null,null,null,nm_usuario_p);
	end if;					
end if;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE alterar_anestesista_agenda ( nr_seq_agenda_p bigint, cd_anestesista_p text, nr_seq_escala_p bigint, nm_usuario_p text) FROM PUBLIC;

