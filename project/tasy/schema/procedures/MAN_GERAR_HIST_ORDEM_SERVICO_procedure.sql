-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE man_gerar_hist_ordem_servico () AS $body$
DECLARE


nr_seq_ordem_w		bigint;
nr_seq_grupo_des_w		bigint;
nr_seq_grupo_sup_w		bigint;
nr_seq_estagio_w		bigint;
nm_usuario_des_w		varchar(15);
nm_usuario_sup_w		varchar(15);
dt_enc_des_w			timestamp;
qt_min_sup_w			bigint;
qt_min_des_w			bigint;
qt_min_cliente_w		bigint;
qt_min_outro_w		bigint;
nr_sequencia_w		bigint;
dt_referencia_w		timestamp;
ie_estagio_w			varchar(01);

C01 CURSOR FOR
SELECT	a.nr_sequencia,
	a.nr_seq_estagio,
	a.nr_seq_grupo_des,
	a.nr_seq_grupo_sup,
	CASE WHEN b.ie_desenv='S' THEN 'D'  ELSE CASE WHEN b.ie_suporte='S' THEN 'S'  ELSE 'O' END  END
from	Man_estagio_processo b,
	Man_ordem_servico a
where	a.ie_status_ordem in ('1','2')
and	a.nr_seq_estagio	= b.nr_sequencia
and	ie_aguarda_cliente	= 'N';


BEGIN

dt_referencia_w		:= trunc(clock_timestamp(),'dd');
Delete from man_ordem_serv_hist
where	dt_referencia		= dt_referencia_w;

open C01;
loop
fetch C01 into
		nr_seq_ordem_w,
		nr_seq_estagio_w,
		nr_seq_grupo_des_w,
		nr_seq_grupo_sup_w,
		ie_estagio_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	select	nextval('man_ordem_serv_hist_seq')
	into STRICT	nr_sequencia_w
	;

	select max(nm_usuario_exec)
	into STRICT	nm_usuario_des_w
	from	man_ordem_servico_exec
	where	nr_sequencia		= (
		SELECT min(a.nr_sequencia)
		from	Usuario_grupo_des b,
			man_ordem_servico_exec a
		where	a.nr_seq_ordem 	= nr_seq_ordem_w
		and	b.nm_usuario_grupo	= a.nm_usuario_exec);

	select max(nm_usuario_exec)
	into STRICT	nm_usuario_sup_w
	from	man_ordem_servico_exec
	where	nr_sequencia		= (
		SELECT min(a.nr_sequencia)
		from	Usuario_grupo_sup b,
			man_ordem_servico_exec a
		where	a.nr_seq_ordem 	= nr_seq_ordem_w
		and	b.nm_usuario_grupo	= a.nm_usuario_exec);

	select	min(a.dt_atualizacao)
	into STRICT	dt_enc_des_w
	from	man_estagio_processo b,
		man_ordem_serv_estagio a
	where	a.nr_seq_ordem		= nr_seq_ordem_w
	and	a.nr_seq_estagio		= b.nr_sequencia
	and	b.ie_desenv			= 'S';

	qt_min_sup_w			:= 0;
	qt_min_des_w			:= 0;
	qt_min_cliente_w		:= 0;
	qt_min_outro_w		:= 0;

	insert into man_ordem_serv_hist(
		nr_sequencia,
		nr_seq_ordem,
		dt_atualizacao,
		nm_usuario,
		dt_referencia,
		nr_seq_estagio,
		nm_usuario_des,
		nm_usuario_sup,
		nr_seq_grupo_des,
		nr_seq_grupo_sup,
		dt_enc_des,
		qt_min_sup,
		qt_min_des,
		qt_min_cliente,
		qt_min_outro,
		ie_estagio)
	values (
		nr_sequencia_w,
		nr_seq_ordem_w,
		clock_timestamp(),
		'Marcus',
		dt_referencia_w,
		nr_seq_estagio_w,
		nm_usuario_des_w,
		nm_usuario_sup_w,
		nr_seq_grupo_des_w,
		nr_seq_grupo_sup_w,
		dt_enc_des_w,
		qt_min_sup_w,
		qt_min_des_w,
		qt_min_cliente_w,
		qt_min_outro_w,
		ie_estagio_w);
End loop;
close C01;

commit;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE man_gerar_hist_ordem_servico () FROM PUBLIC;

