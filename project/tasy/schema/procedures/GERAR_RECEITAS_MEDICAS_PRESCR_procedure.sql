-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_receitas_medicas_prescr ( nr_prescricao_p bigint, cd_profissional_p text, dt_receita_p timestamp, ds_medicamentos_p text, nr_seq_format_amarelo_p bigint, nr_seq_format_azul_p bigint, nr_seq_format_branco_p bigint, nr_seq_format_padrao_p bigint, ie_tipo_receita_p text, nm_usuario_p text, nr_atendimento_p bigint, ds_erro_p INOUT text) AS $body$
DECLARE

 
nr_prescricao_w				prescr_material.nr_sequencia%type;
nr_sequencia_w				prescr_material.nr_sequencia%type;
ie_tipo_receita_w			varchar(5);
cd_grupo_w					integer;
nr_seq_formatacao_w			bigint;
ds_medicamentos_w			varchar(2000) := '';
cd_grupo_old_w				integer:= 999;
ds_erro_w					varchar(2000);
ie_gerar_w					boolean := False;
count_w						integer := 0;
count_cursor_w				integer := 0;

c01 CURSOR FOR 
SELECT cd_grupo 
from w_gerar_receita 
where nm_usuario  = nm_usuario_p 
and	 nr_prescricao = nr_prescricao_p 
and  obter_se_contido_char(nr_seq_material,ds_medicamentos_p) = 'S' 
group by cd_grupo 
order by cd_grupo;
	
c02 CURSOR FOR 
SELECT nr_seq_material, 
	ie_tipo_receita 
from w_gerar_receita 
where nm_usuario  = nm_usuario_p 
and	 nr_prescricao = nr_prescricao_p 
and  cd_grupo   = cd_grupo_w 
order by cd_grupo, 
	nr_seq_material;	
 

BEGIN 
 
if	((nr_seq_format_amarelo_p = 0) and (Obter_ie_tipo_receita('A',nr_prescricao_p,nm_usuario_p) = 'S') or (nr_seq_format_azul_p = 0)  and (Obter_ie_tipo_receita('Z',nr_prescricao_p,nm_usuario_p) = 'S') or (nr_seq_format_padrao_p = 0) and (Obter_ie_tipo_receita('P',nr_prescricao_p,nm_usuario_p) = 'S') or (nr_seq_format_branco_p = 0) and (Obter_ie_tipo_receita('B',nr_prescricao_p,nm_usuario_p) = 'S')) then 
	ds_erro_p	:= wheb_mensagem_pck.get_texto(277302);
elsif (nr_seq_format_padrao_p <> 0)	and (coalesce(ie_tipo_receita_p::text, '') = '') then 
	ds_erro_p	:= wheb_mensagem_pck.get_texto(277304);
elsif (coalesce(ds_medicamentos_p::text, '') = '') then 
	ds_erro_p	:= wheb_mensagem_pck.get_texto(277303);		
elsif (coalesce(cd_profissional_p::text, '') = '') then 
	ds_erro_p	:= wheb_mensagem_pck.get_texto(277305);
elsif (obter_se_medico(cd_profissional_p, 'M') = 'N') then 
	ds_erro_p	:= wheb_mensagem_pck.get_texto(277306);
else 	 
	/* leitura dos medicamentos e geração da receita */
 
	open c01;
	loop 
	fetch c01 into 
		cd_grupo_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
		begin 
		ds_medicamentos_w	:= '';
		open c02;
		loop 
		fetch c02 into	 
			nr_sequencia_w, 
			ie_tipo_receita_w;
		EXIT WHEN NOT FOUND; /* apply on c02 */
			ie_tipo_receita_w := ie_tipo_receita_w;
			ds_medicamentos_w := ds_medicamentos_w || to_char(nr_sequencia_w) ||',';
		end loop;
		close c02;
		if (ie_tipo_receita_w = 'A') then 
			nr_seq_formatacao_w := nr_seq_format_amarelo_p;
		elsif (ie_tipo_receita_w = 'B') then 
			nr_seq_formatacao_w := nr_seq_format_branco_p;
		elsif (ie_tipo_receita_w = 'Z') then 
			nr_seq_formatacao_w := nr_seq_format_azul_p;
		else 
			nr_seq_formatacao_w := nr_seq_format_padrao_p;
		end if;
		 
		if (nr_seq_format_padrao_p <> 0) and (coalesce(ie_tipo_receita_w::text, '') = '') then 
			ie_tipo_receita_w := ie_tipo_receita_p;
		end if;
		 
		ds_erro_w := gerar_receita_medica_prescr( nr_prescricao_p, cd_profissional_p, dt_receita_p, ie_tipo_receita_w, nr_seq_formatacao_w, ds_medicamentos_w, nm_usuario_p, nr_atendimento_p, ds_erro_w, null);
 
		end;
	end loop;
	close c01;	
end if;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_receitas_medicas_prescr ( nr_prescricao_p bigint, cd_profissional_p text, dt_receita_p timestamp, ds_medicamentos_p text, nr_seq_format_amarelo_p bigint, nr_seq_format_azul_p bigint, nr_seq_format_branco_p bigint, nr_seq_format_padrao_p bigint, ie_tipo_receita_p text, nm_usuario_p text, nr_atendimento_p bigint, ds_erro_p INOUT text) FROM PUBLIC;

