-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE cih_atualiza_dados_importacoes (nr_atendimento_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) AS $body$
DECLARE

 
nr_ficha_ocorrencia_w		bigint;
ds_erro_w			varchar(500);

-- Parametros para as importações 
ie_vincular_medic_conta_w	varchar(1);
ie_importar_medic_w		varchar(1);
ie_importar_propaci_w		varchar(1);


BEGIN 
 
if (nr_atendimento_p IS NOT NULL AND nr_atendimento_p::text <> '') then 
	 
	select	max(nr_ficha_ocorrencia) 
	into STRICT	nr_ficha_ocorrencia_w 
	from	cih_ficha_ocorrencia 
	where	nr_atendimento = nr_atendimento_p;
	 
	 
	if (nr_ficha_ocorrencia_w IS NOT NULL AND nr_ficha_ocorrencia_w::text <> '') then 
			 
		--Importar Cirurgia 
		ie_importar_medic_w := obter_param_usuario(936, 11, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_importar_medic_w);
		ie_importar_propaci_w := obter_param_usuario(936, 23, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_importar_propaci_w);
		ds_erro_w := CIH_Importar_Cirurgia(nr_ficha_ocorrencia_w, nm_usuario_p, ie_importar_medic_w, ie_importar_propaci_w, null, ds_erro_w);
		if (ds_erro_w IS NOT NULL AND ds_erro_w::text <> '') or (ds_erro_w <> '') then 
			CALL wheb_mensagem_pck.exibir_mensagem_abort(245381,'DS_ERRO='|| ds_erro_w);
		end if;
		 
		--Importar Medicamento 
		ie_vincular_medic_conta_w := obter_param_usuario(936, 23, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_vincular_medic_conta_w);
		CALL CIH_Importar_Medicamento(nr_ficha_ocorrencia_w, nm_usuario_p, ie_vincular_medic_conta_w,null);	
		 
		--Importar Cultura		 
		CALL CIH_Importar_Cultura(nr_ficha_ocorrencia_w, nm_usuario_p);
		 
		--Importar Procedimentos 
		CALL cih_importar_procedimentos(nr_ficha_ocorrencia_w, nm_usuario_p);	
		 
	end if;
 
end if;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cih_atualiza_dados_importacoes (nr_atendimento_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) FROM PUBLIC;

