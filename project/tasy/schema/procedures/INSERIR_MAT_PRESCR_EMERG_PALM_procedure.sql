-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE inserir_mat_prescr_emerg_palm ( nr_prescricao_p bigint, cd_material_p bigint, nr_seq_lote_fornec_p text, cd_estabelecimento_p bigint, nm_usuario_p text, ds_retorno_p INOUT text) AS $body$
DECLARE




nr_seq_material_w                      integer;
cd_unidade_medida_consumo_w             varchar(30);
ie_via_aplicacao_w                      varchar(5);
ie_tipo_material_w                      varchar(3);
ie_agrupador_w                                   smallint := 2;
nr_agrupamento_w                     double precision;
cd_intervalo_w                                     varchar(7);
qt_mat_w                                           bigint;

cd_material_w                                     bigint;
nr_seq_lote_fornec_w                  bigint;
ie_possui_reg_w                                   varchar(1);
qt_dose_w                                          double precision;
ds_erro_w                                          varchar(2000) := null;
ie_origem_inf_w                                   prescr_medica.ie_origem_inf%type;
cd_unidade_medida_dose_w         prescr_material.cd_unidade_medida_dose%type;
qt_material_w                                      prescr_material.qt_material%type;
qt_total_dispensar_w                   prescr_material.qt_total_dispensar%type;
ie_regra_disp_w                                   prescr_material.ie_regra_disp%type;
qt_unitaria_w                             prescr_material.qt_unitaria%type;
nr_ocorrencia_w                                  prescr_material.nr_ocorrencia%type;
nm_usuario_medico_w						prescr_medica.nm_usuario%type;
cd_medico_w								prescr_medica.cd_medico%type;
dt_atual_w		varchar(5)	:= to_char(clock_timestamp(),'hh24:mi');


BEGIN

ds_retorno_p := '';

select count(1)
into STRICT     qt_mat_w
from   material
where cd_material = cd_material_p;

if (qt_mat_w > 0) then

         select  max(ie_origem_inf)
         into STRICT     ie_origem_inf_w
         from   prescr_medica
         where nr_prescricao = nr_prescricao_p;

         cd_intervalo_w := obter_param_usuario(998, 1, obter_perfil_ativo, wheb_usuario_pck.get_nm_usuario, cd_estabelecimento_p, cd_intervalo_w);

         select cd_unidade_medida_consumo,
                ie_via_aplicacao,
                ie_tipo_material
         into STRICT   cd_unidade_medida_consumo_w,
                ie_via_aplicacao_w,
                ie_tipo_material_w
         from   material
         where 	cd_material = cd_material_p;

         if (ie_tipo_material_w in ('2','3')) then
                   ie_agrupador_w       := 1;
         end if;

         select coalesce(max('S'),'N'),
                            max(cd_unidade_medida_dose),
                            max(qt_material),
                            max(ie_regra_disp),
                            max(nr_sequencia),
                            max(cd_intervalo),
                            max(ie_via_aplicacao),
                            max(qt_unitaria),
                            max(nr_ocorrencia),
                            max(cd_unidade_medida),
                            max(qt_total_dispensar)
         into STRICT     ie_possui_reg_w,
                            cd_unidade_medida_dose_w,
                            qt_material_w,
                            ie_regra_disp_w,
                            nr_seq_material_w,
                            cd_intervalo_w,
                            ie_via_aplicacao_w,
                            qt_unitaria_w,
                            nr_ocorrencia_w,
                            cd_unidade_medida_consumo_w,
                            qt_total_dispensar_w
         from   prescr_material
         where nr_prescricao =       nr_prescricao_p
         and              cd_material             =       cd_material_p
         and              ((nr_seq_lote_fornec = nr_seq_lote_fornec_p) or ((coalesce(nr_seq_lote_fornec,0) = 0) and (coalesce(nr_seq_lote_fornec_p,0) = 0)));

         if (ie_possui_reg_w = 'S') then
                   /*
                   qt_material_w                            := qt_material_w + 1;
                   qt_total_dispensar_w          := qt_total_dispensar_w + 1;
                   qt_unitaria_w              := qt_unitaria_w + 1;

                   Obter_Quant_Dispensar(cd_estabelecimento_p, cd_material_p, nr_prescricao_p, nr_seq_material_w, cd_intervalo_w,
                                                                  ie_via_aplicacao_w, qt_unitaria_w, 0, nr_ocorrencia_w, '',
                                                                  ie_origem_inf_w, cd_unidade_medida_consumo_w, 1, qt_material_w, qt_total_dispensar_w, ie_regra_disp_w, ds_erro_w, 'N', 'N');
                                                                  */
                   update          prescr_material
                   set               qt_dose                           = qt_dose  + 1,
                                      qt_total_dispensar    = qt_total_dispensar + 1,
                                      qt_material                       = qt_material + 1,
                                      qt_unitaria                        = qt_unitaria + 1
                   where nr_prescricao          = nr_prescricao_p
                   and              cd_material                      = cd_material_p
                   and              ((nr_seq_lote_fornec = nr_seq_lote_fornec_p) or ((coalesce(nr_seq_lote_fornec,0) = 0) and (coalesce(nr_seq_lote_fornec_p,0) = 0)));

                   commit;

         else

				cd_intervalo_w := obter_param_usuario(998, 1, obter_perfil_ativo, wheb_usuario_pck.get_nm_usuario, cd_estabelecimento_p, cd_intervalo_w);

				 select cd_unidade_medida_consumo,
						ie_via_aplicacao,
						ie_tipo_material
				 into STRICT   cd_unidade_medida_consumo_w,
						ie_via_aplicacao_w,
						ie_tipo_material_w
				 from   material
				 where 	cd_material = cd_material_p;

                   select  coalesce(max(nr_agrupamento),0) + 1
                   into STRICT     nr_agrupamento_w
                   from   prescr_material
                   where nr_prescricao = nr_prescricao_p
                   and              ie_agrupador = ie_agrupador_w;

                   select  coalesce(max(nr_sequencia),0) + 1
                   into STRICT     nr_seq_material_w
                   from   prescr_material
                   where nr_prescricao = nr_prescricao_p;

                   begin
                   Insert into Prescr_Material(
                            nr_prescricao,
                            nr_sequencia,
                            ie_origem_inf,
                            cd_material,
                            cd_unidade_medida,
                            qt_dose,
                            qt_unitaria,
                            qt_material,
                            dt_atualizacao,
                            nm_usuario,
                            cd_intervalo,
                            ie_via_aplicacao,
                            nr_agrupamento,
                            cd_motivo_baixa,
                            ie_utiliza_kit,
                            cd_unidade_medida_dose,
                            qt_conversao_dose,
                            ie_urgencia,
                            nr_ocorrencia,
                            qt_total_dispensar,
                            ie_medicacao_paciente,
                            ie_suspenso,
                            ie_agrupador,
                            ie_se_necessario,
                            ie_bomba_infusao,
                            ie_aplic_bolus,
                            ie_aplic_lenta,
                            ie_acm,
                            ie_cultura_cih,
                            ie_antibiograma,
                            ie_uso_antimicrobiano,
                            ie_status_cirurgia,
                            ie_recons_diluente_fixo,
                            nr_seq_lote_fornec,
                            DT_ATUALIZACAO_NREC,
							ds_horarios,
							HR_PRIM_HORARIO)
                   values (
                            nr_prescricao_p,
                            nr_seq_material_w,
                            'E',
                            cd_material_p,
                            cd_unidade_medida_consumo_w,
                            1,
                            1,
                            1,
                            clock_timestamp(),
                            nm_usuario_p,
                            cd_intervalo_w,
                            ie_via_aplicacao_w,
                            nr_agrupamento_w,
                            0,
                            'N',
                            cd_unidade_medida_consumo_w,
                            1,
                            'S',
                            1,
                            1,
                            'N',
                            'N',
                            ie_agrupador_w,
                            'N',
                            'N',
                            'N',
                            'N',
                            'N',
                            'N',
                            'N',
                            'N',
                            'PE',
                            'N',
                            CASE WHEN nr_seq_lote_fornec_p=0 THEN null  ELSE nr_seq_lote_fornec_p END ,
                            clock_timestamp(),
							dt_atual_w,
							dt_atual_w);


                            commit;
                            exception when others then
                                      CALL WHEB_MENSAGEM_PCK.Exibir_Mensagem_Abort(279778, 'VARIAVEL=' || nr_seq_lote_fornec_p);
                            end;
                   end if;


else
         --WHEB_MENSAGEM_PCK.Exibir_Mensagem_Abort(322197, null);
         ds_retorno_p := WHEB_MENSAGEM_PCK.get_texto(322197);
end if;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE inserir_mat_prescr_emerg_palm ( nr_prescricao_p bigint, cd_material_p bigint, nr_seq_lote_fornec_p text, cd_estabelecimento_p bigint, nm_usuario_p text, ds_retorno_p INOUT text) FROM PUBLIC;

