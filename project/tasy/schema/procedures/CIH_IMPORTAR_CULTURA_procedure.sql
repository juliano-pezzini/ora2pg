-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE cih_importar_cultura (nr_ficha_ocorrencia_p bigint, nm_usuario_p text, dt_cultura_p timestamp default null, nr_atendimento_p bigint default null) AS $body$
DECLARE


nr_atendimento_w	bigint;
cd_amostra_cultura_w	bigint;
cd_topografia_w		bigint;

nr_seq_resultado_w	bigint;
nr_seq_resultado_ant_w	bigint;
dt_coleta_w		timestamp;
cd_microorganismo_w	bigint;
cd_microorganismo_ant_w	bigint;
cd_medicamento_w	bigint;
ie_resultado_w		varchar(1);
nr_seq_cultura_w	bigint;

nr_seq_material_w	bigint;
nr_seq_prescr_w		integer;
nr_seq_prescr_ant_w	integer;
qt_itens_w		bigint;
nr_prescricao_w		bigint;
nr_seq_grupo_microorg_w	bigint;

ds_resultado_antib_w	varchar(255);
qt_mic_w		bigint;
cd_setor_atendimento_w	integer;
ie_nao_insere_analito_w	varchar(1);
		
c01 CURSOR FOR
	SELECT	distinct
		d.nr_seq_resultado,
	        coalesce(c.dt_coleta,clock_timestamp()),
		d.cd_microorganismo,
		d.cd_medicamento,
		d.ie_resultado,
		c.nr_seq_prescr,
		b.nr_prescricao,
		d.ds_resultado_antib,
		d.qt_mic,
		a.cd_setor_atendimento
	from	exame_lab_result_antib d,
		exame_lab_result_item c,
		exame_lab_resultado b,
		prescr_medica a,
		exame_laboratorio f,
		prescr_procedimento e
	where	a.nr_prescricao		= b.nr_prescricao
	and	a.nr_prescricao		= e.nr_prescricao
	and	c.nr_seq_prescr		= e.nr_sequencia
	and	f.nr_seq_exame		= e.nr_seq_exame
	and	b.nr_seq_resultado	= c.nr_seq_resultado
	and	c.nr_seq_resultado	= d.nr_seq_resultado
	and	c.nr_sequencia		= d.nr_seq_result_item
	and	((c.nr_seq_material IS NOT NULL AND c.nr_seq_material::text <> '') or (ie_nao_insere_analito_w = 'N'))
	and	a.nr_atendimento	= coalesce(nr_atendimento_p, nr_atendimento_w)
	and (d.ie_resultado		in ('R','S','I') or upper(c.ds_resultado) like '%POSITIV%')
	and	(	(coalesce(dt_cultura_p::text, '') = '') or (ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_prescricao) > ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_cultura_p)))
	and	(((obter_data_aprov_lab(b.nr_prescricao,c.nr_seq_prescr) IS NOT NULL AND (obter_data_aprov_lab(b.nr_prescricao,c.nr_seq_prescr))::text <> ''))
	or (exists (SELECT 1 from result_laboratorio where nr_prescricao = a.nr_prescricao and nr_seq_prescricao = e.nr_sequencia)))
	and	not exists (select	1
				from	cih_cultura e
				where	e.nr_prescricao = b.nr_prescricao
				and	e.nr_seq_prescr = c.nr_seq_prescr)
	
union all

	select	distinct
		d.nr_seq_resultado,
	        coalesce(c.dt_coleta,clock_timestamp()),
		d.cd_microorganismo,
		null,
		d.ie_resultado,
		c.nr_seq_prescr,
		b.nr_prescricao,
		d.ds_resultado_antib,
		d.qt_mic,
		a.cd_setor_atendimento
	from	exame_lab_result_antib d,
		exame_lab_result_item c,
		exame_lab_resultado b,
		prescr_medica a,
		exame_laboratorio f,
		prescr_procedimento e
	where	a.nr_prescricao		= b.nr_prescricao
	and	a.nr_prescricao		= e.nr_prescricao
	and	c.nr_seq_prescr		= e.nr_sequencia
	and	f.nr_seq_exame		= e.nr_seq_exame
	and	b.nr_seq_resultado	= c.nr_seq_resultado
	and	c.nr_seq_resultado	= d.nr_seq_resultado
	and	c.nr_sequencia		= d.nr_seq_result_item
	and	((c.nr_seq_material IS NOT NULL AND c.nr_seq_material::text <> '') or (ie_nao_insere_analito_w = 'N'))
	and	a.nr_atendimento	= coalesce(nr_atendimento_p, nr_atendimento_w)
	and	(	(coalesce(dt_cultura_p::text, '') = '') or (ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_prescricao) > ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_cultura_p)))
	and	f.ie_formato_resultado	= 'SDM'
	and	not exists (select	1
				from	exame_lab_result_antib x
				where	x.nr_seq_resultado	= d.nr_seq_resultado
				and	x.nr_seq_result_item	= d.nr_seq_result_item
				and	d.ie_resultado		in ('R','S','I'))
	and	(((obter_data_aprov_lab(b.nr_prescricao,c.nr_seq_prescr) IS NOT NULL AND (obter_data_aprov_lab(b.nr_prescricao,c.nr_seq_prescr))::text <> '')) 
	or (exists (select 1 from result_laboratorio where nr_prescricao = a.nr_prescricao and nr_seq_prescricao = e.nr_sequencia)))
	and	not exists (select	1
				from	cih_cultura e
				where	e.nr_prescricao = b.nr_prescricao
				and	e.nr_seq_prescr = c.nr_seq_prescr)
	and	not exists (	select	w.nr_seq_exame
				from	exame_lab_dependente y,
					prescr_procedimento w,
					exame_laboratorio q,
					exame_lab_result_antib x,
					exame_lab_result_item k,
					exame_lab_resultado p
				where	y.ie_geracao = 3
				and	y.nr_seq_exame = e.nr_seq_exame
				and	w.nr_prescricao = a.nr_prescricao
				and	w.nr_seq_exame = y.nr_seq_exame_dep
				and	w.nr_seq_superior = e.nr_sequencia
				and	q.nr_seq_exame = y.nr_seq_exame_dep
				and	k.nr_seq_prescr = w.nr_sequencia
				and	w.nr_prescricao = p.nr_prescricao
				and	p.nr_seq_resultado = k.nr_seq_resultado
				and	k.nr_seq_resultado = x.nr_seq_resultado
				and	k.nr_sequencia = x.nr_seq_result_item
				and	x.ie_resultado in ('R','S','I')
				and	q.ie_formato_resultado = 'SM'
				and	coalesce(y.ie_gera_antibiograma,'N') = 'S'
				and	y.nr_seq_grupo_micro = cih_obter_grupo_mic(d.cd_microorganismo))
	order by	1,
			2,
			6,
			3,
			4;

/* microbiologia negativa */

c02 CURSOR FOR
	SELECT	c.nr_seq_resultado,
		coalesce(c.dt_coleta,clock_timestamp()),
		c.nr_seq_prescr,
		b.nr_prescricao,
		a.cd_setor_atendimento
	from	exame_lab_result_item c,
		exame_lab_resultado b,
		exame_laboratorio d,
		prescr_medica a
	where	a.nr_prescricao		= b.nr_prescricao
	and	b.nr_seq_resultado	= c.nr_seq_resultado
	and	d.nr_seq_exame		= c.nr_seq_exame
	and	((c.nr_seq_material IS NOT NULL AND c.nr_seq_material::text <> '') or (ie_nao_insere_analito_w = 'N'))
	and (upper(coalesce(c.ds_resultado,' ')) not like '%INCONCLUS%')
	and	a.nr_atendimento	= coalesce(nr_atendimento_p, nr_atendimento_w)
	and	(((obter_data_aprov_lab(b.nr_prescricao,c.nr_seq_prescr) IS NOT NULL AND (obter_data_aprov_lab(b.nr_prescricao,c.nr_seq_prescr))::text <> ''))
	or (exists (SELECT 1 from result_laboratorio where nr_prescricao = a.nr_prescricao and nr_seq_prescricao = c.nr_seq_prescr)))
	and	((coalesce(dt_cultura_p::text, '') = '') or (ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_prescricao) > ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_cultura_p)))	
	and	d.ie_formato_resultado in ('SM','SDM')
	and	(	(upper(c.ds_resultado) not like '%POSITIV%') or
			(	(coalesce(c.ds_resultado::text, '') = '') and (not exists (select	1
						from	exame_lab_result_antib x
						where	x.nr_seq_resultado = b.nr_seq_resultado
						and	x.nr_seq_result_item = c.nr_sequencia
						and (d.ie_formato_resultado = 'SM' and x.ie_resultado in ('R','S','I'))
						or (d.ie_formato_resultado = 'SDM')))
			)
		)
	and	not exists (select	1
				from	cih_cultura e
				where	e.nr_prescricao = b.nr_prescricao
				and	e.nr_seq_prescr = c.nr_seq_prescr);


BEGIN
ie_nao_insere_analito_w := obter_param_usuario(936, 92, obter_perfil_ativo, wheb_usuario_pck.get_nm_usuario, wheb_usuario_pck.get_cd_estabelecimento, ie_nao_insere_analito_w);

select	coalesce(max(nr_atendimento),0)
into STRICT	nr_atendimento_w
from	cih_ficha_ocorrencia
where	nr_ficha_ocorrencia = nr_ficha_ocorrencia_p;

select	min(cd_amostra_cultura)
into STRICT	cd_amostra_cultura_w
from	cih_amostra_cultura
where	ie_situacao = 'A';

select	min(cd_topografia)
into STRICT	cd_topografia_w
from	cih_topografia
where	ie_situacao = 'A';

select 	coalesce(max(cd_topografia),cd_topografia_w)
into STRICT 	cd_topografia_w
from 	cih_local_infeccao
where 	nr_ficha_ocorrencia = nr_ficha_ocorrencia_p;

cd_microorganismo_ant_w := 0;
nr_seq_resultado_ant_w := 0;
nr_seq_prescr_ant_w 	:= 0;

open c01;
loop
fetch c01 into	nr_seq_resultado_w,
		dt_coleta_w,
		cd_microorganismo_w,
		cd_medicamento_w,
		ie_resultado_w,
		nr_seq_prescr_w,
		nr_prescricao_w,
		ds_resultado_antib_w,
		qt_mic_w,
		cd_setor_atendimento_w;
EXIT WHEN NOT FOUND; /* apply on c01 */


	if (nr_seq_resultado_w <> nr_seq_resultado_ant_w) or (cd_microorganismo_w <> cd_microorganismo_ant_w) or (nr_seq_prescr_w <> nr_seq_prescr_ant_w) then

		select	max(nr_seq_grupo)
		into STRICT	nr_seq_grupo_microorg_w
		from	cih_microorganismo
		where	cd_microorganismo = cd_microorganismo_w;
		
		select	max(nr_seq_material)
		into STRICT	nr_seq_material_w
		from	exame_lab_result_item
		where 	nr_seq_resultado = nr_seq_resultado_w
		and	nr_seq_prescr	 = nr_seq_prescr_w;

		select 	coalesce(max(cd_amostra_cultura),cd_amostra_cultura_w),
			coalesce(max(cd_topografia),cd_topografia_w)
		into STRICT	cd_amostra_cultura_w,
			cd_topografia_w
		from 	material_exame_lab
		where 	nr_sequencia = nr_seq_material_w;

		select	coalesce(max(nr_seq_cultura),0) + 1
		into STRICT	nr_seq_cultura_w
		from	cih_cultura
		where	nr_ficha_ocorrencia = nr_ficha_ocorrencia_p;

		insert into cih_cultura(
			nr_ficha_ocorrencia,
			nr_seq_cultura,
			cd_amostra_cultura,
			dt_coleta,
			cd_microorganismo,
			cd_topografia,
			dt_atualizacao,
			nm_usuario,
			cd_laboratorio,
			ds_codigo_laboratorio,
			ie_resultado,
			cd_caso_infeccao,
			cd_setor_atendimento,
			cd_procedimento,
			ie_multi_resistente,
			nr_prescricao,
			nr_seq_prescr,
			nr_seq_grupo_microorg
		) values (
			nr_ficha_ocorrencia_p,
			nr_seq_cultura_w,
			cd_amostra_cultura_w,
			dt_coleta_w,
			cd_microorganismo_w,
			cd_topografia_w,
			clock_timestamp(),
			nm_usuario_p,
			null,
			null,
			'P',
			null,
			cd_setor_atendimento_w,
			null,
			'N',
			nr_prescricao_w,
			nr_seq_prescr_w,
			nr_seq_grupo_microorg_w);
	end if;
	
	if (cd_medicamento_w IS NOT NULL AND cd_medicamento_w::text <> '') then
		cd_microorganismo_ant_w := cd_microorganismo_w;
		nr_seq_resultado_ant_w	:= nr_seq_resultado_w;
		nr_seq_prescr_ant_w	:= nr_seq_prescr_w;
		
		select 	count(*)
		into STRICT	qt_itens_w
		from	cih_cultura_medic
		where	nr_ficha_ocorrencia	= nr_ficha_ocorrencia_p
		and	nr_seq_cultura		= nr_seq_cultura_w
		and	cd_medicamento		= cd_medicamento_w;

		if (qt_itens_w = 0) and (ie_resultado_w <> 'N') then
		
			insert into cih_cultura_medic(
				nr_ficha_ocorrencia,
				nr_seq_cultura,
				cd_medicamento,
				ie_resultado_cultura,
				dt_atualizacao,
				nm_usuario,
				ds_concentracao
			) values (
				nr_ficha_ocorrencia_p,
				nr_seq_cultura_w,
				cd_medicamento_w,
				CASE WHEN ie_resultado_w='R' THEN 2  ELSE CASE WHEN ie_resultado_w='S' THEN 3  ELSE 4 END  END ,
				clock_timestamp(),
				nm_usuario_p,
				coalesce(ds_resultado_antib_w,qt_mic_w));
		end if;
	end if;
end loop;
close c01;

nr_seq_prescr_ant_w    := 0;
nr_seq_resultado_ant_w := 0;

open c02;
loop
fetch c02 into	nr_seq_resultado_w,
		dt_coleta_w,
		nr_seq_prescr_w,
		nr_prescricao_w,
		cd_setor_atendimento_w;
EXIT WHEN NOT FOUND; /* apply on c02 */

	select	coalesce(max(nr_seq_cultura),0) + 1
	into STRICT	nr_seq_cultura_w
	from	cih_cultura
	where	nr_ficha_ocorrencia = nr_ficha_ocorrencia_p;

	select	max(nr_seq_material)
	into STRICT	nr_seq_material_w
	from	exame_lab_result_item
	where 	nr_seq_resultado = nr_seq_resultado_w
	and	nr_seq_prescr	 = nr_seq_prescr_w;

	select 	coalesce(cd_amostra_cultura,cd_amostra_cultura_w),
		coalesce(cd_topografia,cd_topografia_w)
	into STRICT	cd_amostra_cultura_w,
		cd_topografia_w
	from 	material_exame_lab
	where 	nr_sequencia = nr_seq_material_w;
	
	
	if (ie_nao_insere_analito_w = 'N') or
		(ie_nao_insere_analito_w = 'S' AND (nr_seq_resultado_w <> nr_seq_resultado_ant_w or nr_seq_prescr_w <> nr_seq_prescr_ant_w))  then
		
		nr_seq_prescr_ant_w    := nr_seq_prescr_w;
		nr_seq_resultado_ant_w := nr_seq_resultado_w;

		insert into cih_cultura(
			nr_ficha_ocorrencia,
			nr_seq_cultura,
			cd_amostra_cultura,
			dt_coleta,
			cd_microorganismo,
			cd_topografia,
			dt_atualizacao,
			nm_usuario,
			cd_laboratorio,
			ds_codigo_laboratorio,
			ie_resultado,
			cd_caso_infeccao,
			cd_setor_atendimento,
			cd_procedimento,
			ie_multi_resistente,
			nr_prescricao,
			nr_seq_prescr
		) values (
			nr_ficha_ocorrencia_p,
			nr_seq_cultura_w,
			cd_amostra_cultura_w,
			dt_coleta_w,
			null,
			cd_topografia_w,
			clock_timestamp(),
			nm_usuario_p,
			null,
			null,
			'N',
			null,
			cd_setor_atendimento_w,
			null,
			'N',
			nr_prescricao_w,
			nr_seq_prescr_w);
	end if;

end loop;
close c02;

if (coalesce(wheb_usuario_pck.get_ie_commit, 'S') = 'S') then commit; end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cih_importar_cultura (nr_ficha_ocorrencia_p bigint, nm_usuario_p text, dt_cultura_p timestamp default null, nr_atendimento_p bigint default null) FROM PUBLIC;

