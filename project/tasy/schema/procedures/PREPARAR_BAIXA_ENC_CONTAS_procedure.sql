-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE preparar_baixa_enc_contas ( nr_seq_lote_p bigint, nr_seq_pessoa_p bigint, dt_baixa_p timestamp, ie_acao_p text, cd_pessoa_fisica_p text, cd_cgc_p text, ie_commit_p text, nm_usuario_p text) AS $body$
DECLARE

			 
ie_forma_encontro_contas_w	lote_encontro_contas.ie_forma_encontro_contas%type;
cd_estabelecimento_w		lote_encontro_contas.cd_estabelecimento%type;
nr_seq_pessoa_w			bigint;

C01 CURSOR FOR 
	SELECT	a.nr_sequencia 
	from	pessoa_encontro_contas	a 
	where	a.nr_seq_lote = nr_seq_lote_p 
	and	((ie_acao_p = 'B' and coalesce(a.dt_baixa::text, '') = '') or (ie_acao_p = 'E' and (a.dt_baixa IS NOT NULL AND a.dt_baixa::text <> '')) ) /*OS 1331606 e 1326415*/
 
	and	((a.cd_pessoa_fisica = cd_pessoa_fisica_p) or (coalesce(cd_pessoa_fisica_p::text, '') = '')) 
	and	((a.cd_cgc = cd_cgc_p) or (coalesce(cd_cgc_p::text, '') = ''));


BEGIN 
 
select	max(ie_forma_encontro_contas), 
		max(cd_estabelecimento) 
into STRICT	ie_forma_encontro_contas_w, 
		cd_estabelecimento_w 
from	lote_encontro_contas 
where	nr_sequencia = nr_seq_lote_p;
 
if (coalesce(ie_forma_encontro_contas_w,'G') = 'G') and (ie_acao_p = 'B') then	 
	CALL baixar_lote_encontro_contas(	nr_seq_lote_p, 
					ie_acao_p, 
					dt_baixa_p, 
					cd_pessoa_fisica_p, 
					cd_cgc_p, 
					cd_estabelecimento_w, 
				nm_usuario_p);		
				 
elsif (coalesce(ie_forma_encontro_contas_w,'G') = 'M') and (ie_acao_p = 'B') then	 
	if (coalesce(nr_seq_pessoa_p::text, '') = '') then 
		open C01;
		loop 
		fetch C01 into 
			nr_seq_pessoa_w;
		EXIT WHEN NOT FOUND; /* apply on C01 */	
			CALL baixar_enc_contas_abatimento(	nr_seq_lote_p, 
							dt_baixa_p, 
							ie_acao_p, 
							nr_seq_pessoa_w, 
							nm_usuario_p);
		end loop;
		close C01;		
	else 
		CALL baixar_enc_contas_abatimento(nr_seq_lote_p, 
						dt_baixa_p, 
						ie_acao_p, 
						nr_seq_pessoa_p, 
						nm_usuario_p);	
	end if;
						 
elsif (coalesce(ie_forma_encontro_contas_w,'G') = 'G') and (ie_acao_p = 'E') and (coalesce(nr_seq_pessoa_p,coalesce(cd_pessoa_fisica_p,cd_cgc_p)) is not null) then	 
	 
	if (coalesce(nr_seq_pessoa_p::text, '') = '') then 
		select	a.nr_sequencia 
		into STRICT	nr_seq_pessoa_w 
		from	pessoa_encontro_contas	a 
		where	a.nr_seq_lote		= nr_seq_lote_p 
		and	(a.dt_baixa IS NOT NULL AND a.dt_baixa::text <> '') 
		and	((a.cd_pessoa_fisica	= cd_pessoa_fisica_p) or (coalesce(cd_pessoa_fisica_p::text, '') = '')) 
		and	((a.cd_cgc = cd_cgc_p) or (coalesce(cd_cgc_p::text, '') = ''));
	end if;
	 
	CALL estornar_pessoa_enc_contas(	coalesce(nr_seq_pessoa_p,nr_seq_pessoa_w), 
					dt_baixa_p, 
					ie_commit_p, 
					nm_usuario_p);
					 
elsif (coalesce(ie_forma_encontro_contas_w,'G') = 'G') and (ie_acao_p = 'E') and (coalesce(nr_seq_pessoa_p,coalesce(cd_pessoa_fisica_p,cd_cgc_p)) is null) then 
	 
	CALL estornar_lote_encontro_contas(	nr_seq_lote_p, 
					dt_baixa_p, 
					nm_usuario_p);
					 
elsif (coalesce(ie_forma_encontro_contas_w,'G') = 'M') and (ie_acao_p = 'E') then 
 
 
	if (coalesce(nr_seq_pessoa_p::text, '') = '') then 
		open C01;
		loop 
		fetch C01 into 
			nr_seq_pessoa_w;
		EXIT WHEN NOT FOUND; /* apply on C01 */	
			CALL baixar_enc_contas_abatimento(	nr_seq_lote_p, 
							dt_baixa_p, 
							ie_acao_p, 
							nr_seq_pessoa_w, 
							nm_usuario_p);
		end loop;
		close C01;		
	else 
		CALL baixar_enc_contas_abatimento(nr_seq_lote_p, 
						dt_baixa_p, 
						ie_acao_p, 
						nr_seq_pessoa_p, 
						nm_usuario_p);	
	end if;
					 
end if;
 
if (coalesce(ie_commit_p,'S') = 'S')then 
	commit;
end if;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE preparar_baixa_enc_contas ( nr_seq_lote_p bigint, nr_seq_pessoa_p bigint, dt_baixa_p timestamp, ie_acao_p text, cd_pessoa_fisica_p text, cd_cgc_p text, ie_commit_p text, nm_usuario_p text) FROM PUBLIC;

