-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE permite_escol_esp_medico_js ( nr_atendimento_p bigint, ie_local_p text, ie_permite_escolher_esp_p text, cd_medico_resp_p text, nm_usuario_p text, ds_msg_esp_quest_p INOUT text, ie_permit_esp_p INOUT text) AS $body$
DECLARE

 
cd_especialidade_w	integer;
qt_especialidade_w	bigint := 0;
qt_total_troca_w	bigint := 0;
ds_msg_questona_w	varchar(255);
					
					 

BEGIN 
 
if (ie_permite_escolher_esp_p <> 'N') then 
 
	 
	select	count(*) 
	into STRICT	qt_especialidade_w 
	from	especialidade_medica b, 
		medico_especialidade a 
	where	a.cd_especialidade	= b.cd_especialidade 
	and	a.cd_pessoa_fisica	= cd_medico_resp_p;
		 
	select	count(*) 
	into STRICT	qt_total_troca_w 
	from	atendimento_troca_medico 
	where	nr_atendimento = nr_atendimento_p 
	and	coalesce(cd_especialidade::text, '') = '' 
	and	nr_sequencia = (SELECT	max(nr_sequencia) 
				from	atendimento_troca_medico 
				where	nr_atendimento = nr_atendimento_p);	
				 
	if	((ie_local_p = 'P') and (qt_especialidade_w > 1) and (qt_total_troca_w > 0)) or 
		(ie_local_p = 'I' AND qt_especialidade_w > 1)then 
		 
		if (ie_permite_escolher_esp_p = 'Q') then 
			ds_msg_esp_quest_p := substr(obter_texto_tasy(185725,wheb_usuario_pck.get_nr_seq_idioma),1,255);
		end if;
		ie_permit_esp_p := ie_permite_escolher_esp_p;
	end if;
 
end if;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE permite_escol_esp_medico_js ( nr_atendimento_p bigint, ie_local_p text, ie_permite_escolher_esp_p text, cd_medico_resp_p text, nm_usuario_p text, ds_msg_esp_quest_p INOUT text, ie_permit_esp_p INOUT text) FROM PUBLIC;

