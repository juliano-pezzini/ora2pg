-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE ctb_contab_onl_titulo_repasse (nr_titulo_p titulo_pagar.nr_titulo%type, nm_usuario_p text ) AS $body$
DECLARE

/*
===============================================================================
Purpose: Indentacao

Remarks: n/a

Who         When            What
----------  -----------     --------------------------------------------------
chjreinert  13/mai/2021     OS 2444975 - Indentacao

===============================================================================
*/
cd_centro_custo_w               ctb_repasse_centro_custo.cd_centro_custo%type;
cd_convenio_w                   atend_categoria_convenio.cd_convenio%type;
cd_empresa_w                    empresa.cd_empresa%type;
cd_estabelecimento_w            estabelecimento.cd_estabelecimento%type;
cd_tipo_lote_contab_w           lote_contabil.cd_tipo_lote_contabil%type;
ctb_documento_w                 ctb_documento%rowtype;
ctb_param_lote_tit_repasse_w    ctb_param_lote_tit_repasse%rowtype;
dados_contab_w                  ctb_contab_onl_lote_fin_pck.dados_contab_tf;
ds_convenio_w                   convenio.ds_convenio%type;
ds_lancamento_w                 varchar(10);
ds_notas_fiscais_w              varchar(255);
ds_pessoa_repasse_w             terceiro_v.nm_pessoa%type;
ds_pessoa_titulo_w              pessoa_juridica.ds_razao_social%type;
dt_contabil_w                   titulo_pagar.dt_contabil%type;
dt_emissao_w                    titulo_pagar.dt_emissao%type;
ie_origem_doc_w                 smallint;
nm_agrupador_w                  agrupador_contabil.nm_atributo%type;
nm_paciente_w                   varchar(200);
nr_documento_mov_w              ctb_movimento.nr_documento%type;
nr_documento_w                  ctb_movimento.nr_documento%type;
nr_documento_ww                 titulo_pagar.nr_documento%type;
nr_lote_contabil_w              lote_contabil.nr_lote_contabil%type;
nr_nota_fiscal_w                nota_fiscal.nr_nota_fiscal%type;
nr_seq_agrupamento_w            ctb_movimento.nr_seq_agrupamento%type;
nr_seq_rpa_w                    titulo_pagar.nr_seq_rpa%type;
nr_titulo_original_w            titulo_pagar.nr_titulo_original%type;
nr_titulo_repasse_w             varchar(254);
nr_titulo_w                     titulo_pagar.nr_titulo%type;
vl_movimento_w                  ctb_movimento.vl_movimento%type;

c010 CURSOR FOR
    SELECT  CASE WHEN ie_situacao='D' THEN obter_valor_tit_pagar_desdob(nr_titulo)  ELSE vl_titulo END  vl_transacao,
            cd_pessoa_fisica cd_pessoa_fisica,
            cd_cgc cd_cgc,
            'VL_TITULO_REPASSE' nm_atributo,
            coalesce(nr_seq_trans_fin_contab, ctb_param_lote_tit_repasse_w.nr_seq_trans_repasse) nr_seq_trans_fin,
            nr_titulo || ' ' || substr(obter_nome_pf_pj(cd_pessoa_fisica,cd_cgc),1,60) ds_observacao,
            CASE WHEN ctb_param_lote_tit_repasse_w.ie_data_contab_tit_rep='V' THEN dt_vencimento_atual WHEN ctb_param_lote_tit_repasse_w.ie_data_contab_tit_rep='C' THEN dt_contabil WHEN ctb_param_lote_tit_repasse_w.ie_data_contab_tit_rep='O' THEN dt_vencimento_original  ELSE dt_emissao END  dt_contabil_tit,
            nr_repasse_terceiro nr_repasse_terceiro,
            0 nr_rep_terc_item,
            0 nr_seq_proc_repasse,
            0 nr_atendimento,
            null cd_tributo,
            null cd_conta_contabil,
            'TITULO_PAGAR' nm_tabela,
            a.nr_titulo nr_seq_tab_orig,
            null    nr_seq_tab_compl,
            2       nr_seq_info_ctb
    from    Titulo_pagar a
    where   nr_titulo       = nr_titulo_p
    and     coalesce(nr_seq_tributo::text, '') = ''

union   all

    PERFORM  CASE WHEN a.ie_situacao='D' THEN obter_valor_tit_pagar_desdob(a.nr_titulo)  ELSE vl_titulo END ,
            c.cd_pessoa_fisica,
            c.cd_cgc,
            'VL_TRIBUTO_REPASSE',
            coalesce(a.nr_seq_trans_fin_contab, ctb_param_lote_tit_repasse_w.nr_seq_trans_repasse),
            a.nr_titulo || ' ' || substr(obter_nome_pf_pj(a.cd_pessoa_fisica, a.cd_cgc),1,60) ds_observacao,
            CASE WHEN ctb_param_lote_tit_repasse_w.ie_dt_tit_trib_orig='N' THEN CASE WHEN ctb_param_lote_tit_repasse_w.ie_dt_movto_contab_tit_rep='V' THEN a.dt_vencimento_atual WHEN ctb_param_lote_tit_repasse_w.ie_dt_movto_contab_tit_rep='C' THEN a.dt_contabil WHEN ctb_param_lote_tit_repasse_w.ie_dt_movto_contab_tit_rep='O' THEN a.dt_vencimento_original  ELSE a.dt_emissao END   ELSE to_date(CASE WHEN ctb_param_lote_tit_repasse_w.ie_dt_movto_contab_tit_rep='V' THEN obter_dados_tit_pagar(d.nr_titulo,'VE') WHEN ctb_param_lote_tit_repasse_w.ie_dt_movto_contab_tit_rep='C' THEN to_char(a.dt_contabil, 'dd/mm/yyyy') WHEN ctb_param_lote_tit_repasse_w.ie_dt_movto_contab_tit_rep='O' THEN obter_dados_tit_pagar(d.nr_titulo,'VO')  ELSE obter_dados_tit_pagar(d.nr_titulo,'EM') END ,'dd/mm/yyyy') END ,
            a.nr_repasse_terceiro,
            0 nr_rep_terc_item,
            0 nr_seq_proc_repasse,
            0 nr_atendimento,
            d.cd_tributo,
            null cd_conta_contabil,
            'TITULO_PAGAR' nm_tabela,
            a.nr_titulo             nr_seq_tab_orig,
            a.nr_seq_tributo        nr_seq_tab_compl,
            2       nr_seq_info_ctb
    from    titulo_pagar_imposto d,
            terceiro c,
            repasse_terceiro b,
            Titulo_pagar a
    where   a.nr_titulo     = nr_titulo_p
    and     (a.nr_seq_tributo IS NOT NULL AND a.nr_seq_tributo::text <> '')
    and     a.nr_seq_tributo        = d.nr_sequencia
    and     a.nr_repasse_terceiro   = b.nr_repasse_terceiro
    and     b.nr_seq_terceiro       = c.nr_sequencia
    
union   all

    select  coalesce(obter_valor_repasse_titulo(nr_titulo,'G'),0),
            cd_pessoa_fisica,
            cd_cgc,
            'VL_GLOSA_REPASSE',
            ctb_param_lote_tit_repasse_w.nr_seq_trans_glosa_rep,
            nr_titulo || ' ' || substr(obter_nome_pf_pj(cd_pessoa_fisica,cd_cgc),1,60) ds_observacao,
            CASE WHEN ctb_param_lote_tit_repasse_w.ie_dt_movto_contab_tit_rep='V' THEN a.dt_vencimento_atual WHEN ctb_param_lote_tit_repasse_w.ie_dt_movto_contab_tit_rep='C' THEN dt_contabil WHEN ctb_param_lote_tit_repasse_w.ie_dt_movto_contab_tit_rep='O' THEN  a.dt_vencimento_original  ELSE a.dt_emissao END ,
            a.nr_repasse_terceiro,
            0 nr_rep_terc_item,
            0 nr_seq_proc_repasse,
            0 nr_atendimento,
            null cd_tributo,
            null cd_conta_contabil,
            'TITULO_PAGAR' nm_tabela,
            a.nr_titulo nr_seq_tab_orig,
            null    nr_seq_tab_compl,
            2       nr_seq_info_ctb
    from    Titulo_pagar a
    where   nr_titulo       = nr_titulo_p
    and     coalesce(nr_seq_tributo::text, '') = ''
    and     obter_valor_repasse(nr_repasse_terceiro,'G') <> 0
    --and   a.ie_situacao <> 'D'
    
union   all

    select  coalesce(obter_valor_repasse_titulo(nr_titulo,'M'),0),
            cd_pessoa_fisica,
            cd_cgc,
            'VL_MAIOR_REPASSE',
            ctb_param_lote_tit_repasse_w.nr_seq_trans_maior_rep,
            nr_titulo || ' ' || substr(obter_nome_pf_pj(cd_pessoa_fisica,cd_cgc),1,60) ds_observacao,
            CASE WHEN ctb_param_lote_tit_repasse_w.ie_dt_movto_contab_tit_rep='V' THEN a.dt_vencimento_atual WHEN ctb_param_lote_tit_repasse_w.ie_dt_movto_contab_tit_rep='C' THEN dt_contabil WHEN ctb_param_lote_tit_repasse_w.ie_dt_movto_contab_tit_rep='O' THEN a.dt_vencimento_original  ELSE a.dt_emissao END ,
            a.nr_repasse_terceiro,
            0 nr_rep_terc_item,
            0 nr_seq_proc_repasse,
            0 nr_atendimento,
            null cd_tributo,
            null cd_conta_contabil,
            'TITULO_PAGAR' nm_tabela,
            a.nr_titulo nr_seq_tab_orig,
            null    nr_seq_tab_compl,
            2       nr_seq_info_ctb
    from    Titulo_pagar a
    where   nr_titulo               = nr_titulo_p
    and     coalesce(nr_seq_tributo::text, '') = ''
    and     obter_valor_repasse(nr_repasse_terceiro,'M') <> 0
    --and   a.ie_situacao <> 'D'
    
union   all

    select  vl_repasse,
            c.cd_pessoa_fisica,
            c.cd_cgc,
            'VL_ITEM_REPASSE',
            nr_seq_trans_fin,
            substr(a.ds_observacao,1,255) ds_observacao,
            CASE WHEN ctb_param_lote_tit_repasse_w.ie_dt_movto_contab_tit_rep='C' THEN coalesce(a.dt_contabil,a.dt_lancamento)  ELSE a.dt_lancamento END  dt_movimento,
            a.nr_repasse_terceiro,
            a.nr_sequencia,
            0 nr_seq_proc_repasse,
            a.nr_atendimento,
            null cd_tributo,
            a.cd_conta_contabil,
            'REPASSE_TERCEIRO_ITEM' nm_tabela,
            a.nr_repasse_terceiro nr_seq_tab_orig,
            a.nr_sequencia  nr_seq_tab_compl,
            2       nr_seq_info_ctb
    from    titulo_pagar d,
            terceiro c,
            repasse_terceiro b,
            repasse_terceiro_item a
    where   d.nr_titulo     = nr_titulo_p
    and     a.nr_repasse_terceiro       = b.nr_repasse_terceiro
    and     b.nr_seq_terceiro   = c.nr_sequencia
    and     b.nr_repasse_terceiro = d.nr_repasse_terceiro
    
union all

    select  coalesce(b.vl_repasse,0) vl_repasse,
            a.cd_pessoa_fisica,
            a.cd_cgc,
            'VL_REPASSE_PROC' nm_atributo,
            coalesce(nr_seq_trans_fin_contab, ctb_param_lote_tit_repasse_w.nr_seq_trans_repasse),
            a.nr_titulo || ' ' || substr(obter_nome_pf_pj(a.cd_pessoa_fisica,a.cd_cgc),1,60) ds_observacao,
            CASE WHEN ctb_param_lote_tit_repasse_w.ie_dt_movto_contab_tit_rep='V' THEN a.dt_vencimento_atual WHEN ctb_param_lote_tit_repasse_w.ie_dt_movto_contab_tit_rep='C' THEN a.dt_contabil WHEN ctb_param_lote_tit_repasse_w.ie_dt_movto_contab_tit_rep='O' THEN a.dt_vencimento_original  ELSE a.dt_emissao END ,
            a.nr_repasse_terceiro,
            0 nr_rep_terc_item,
            b.nr_sequencia nr_seq_proc_repasse,
            c.nr_atendimento,
            null cd_tributo,
            null cd_conta_contabil,
            'PROCEDIMENTO_REPASSE' nm_tabela,
            a.nr_titulo nr_seq_tab_orig,
            b.nr_seq_procedimento   nr_seq_tab_compl,
            2       nr_seq_info_ctb
    from    procedimento_paciente c,
            procedimento_repasse b,
            titulo_pagar a
    where   a.nr_titulo     = nr_titulo_p
    and     a.nr_repasse_terceiro   = b.nr_repasse_terceiro
    and     b.nr_seq_procedimento   = c.nr_sequencia
    and     coalesce(a.nr_seq_tributo::text, '') = ''
    and     ctb_param_lote_tit_repasse_w.ie_contab_item_tit_rep = 'S'
    
union all

    select  coalesce(b.vl_repasse,0) vl_repasse,
            a.cd_pessoa_fisica,
            a.cd_cgc,
            'VL_REPASSE_MAT' nm_atributo,
            coalesce(nr_seq_trans_fin_contab, ctb_param_lote_tit_repasse_w.nr_seq_trans_repasse),
            a.nr_titulo || ' ' || substr(obter_nome_pf_pj(a.cd_pessoa_fisica,a.cd_cgc),1,60) ds_observacao,
            CASE WHEN ctb_param_lote_tit_repasse_w.ie_dt_movto_contab_tit_rep='V' THEN a.dt_vencimento_atual WHEN ctb_param_lote_tit_repasse_w.ie_dt_movto_contab_tit_rep='C' THEN a.dt_contabil WHEN ctb_param_lote_tit_repasse_w.ie_dt_movto_contab_tit_rep='O' THEN a.dt_vencimento_original  ELSE a.dt_emissao END ,
            a.nr_repasse_terceiro,
            0 nr_rep_terc_item,
            0 nr_seq_proc_repasse,
            c.nr_atendimento,
            null cd_tributo,
            null cd_conta_contabil,
            'MATERIAL_REPASSE' nm_tabela,
            a.nr_titulo nr_seq_tab_orig,
            b.nr_seq_material       nr_seq_tab_compl,
            2       nr_seq_info_ctb
    from    material_atend_paciente c,
            material_repasse b,
            titulo_pagar a
    where   a.nr_titulo     = nr_titulo_p
    and     a.nr_repasse_terceiro   = b.nr_repasse_terceiro
    and     b.nr_seq_material       = c.nr_sequencia
    and     coalesce(a.nr_seq_tributo::text, '') = ''
    and     ctb_param_lote_tit_repasse_w.ie_contab_item_tit_rep = 'S'
    
union all

    select  b.vl_liquido,
            a.cd_pessoa_fisica,
            a.cd_cgc,
            'VL_REPASSE_VENC',
            coalesce(a.nr_seq_trans_fin_contab, ctb_param_lote_tit_repasse_w.nr_seq_trans_repasse),
            substr(a.nr_titulo || ' ' || substr(obter_nome_pf_pj(a.cd_pessoa_fisica,a.cd_cgc),1,60),1,255) ds_observacao,
            CASE WHEN ctb_param_lote_tit_repasse_w.ie_dt_movto_contab_tit_rep='V' THEN a.dt_vencimento_atual WHEN ctb_param_lote_tit_repasse_w.ie_dt_movto_contab_tit_rep='C' THEN  a.dt_contabil WHEN ctb_param_lote_tit_repasse_w.ie_dt_movto_contab_tit_rep='O' THEN  a.dt_vencimento_original  ELSE a.dt_emissao END ,
            a.nr_repasse_terceiro,
            0 nr_rep_terc_item,
            0 nr_seq_proc_repasse,
            0 nr_atendimento,
            null cd_tributo,
            null cd_conta_contabil,
            'REPASSE_TERCEIRO_VENC' nm_tabela,
            a.nr_titulo nr_seq_tab_orig,
            b.nr_sequencia  nr_seq_tab_compl,
            2       nr_seq_info_ctb
    from    repasse_terceiro_venc b,
            titulo_pagar a
    where   a.nr_titulo             = b.nr_titulo
    and     a.nr_titulo     = b.nr_titulo
    and     a.nr_titulo     = nr_titulo_p
    and     coalesce(a.nr_seq_tributo::text, '') = ''
    and     ctb_param_lote_tit_repasse_w.ie_contab_repasse_venc     = 'S'
    
union   all

    select  coalesce(obter_valor_repasse_titulo(nr_titulo,'L'),0),
            cd_pessoa_fisica,
            cd_cgc,
            'VL_LIBERADO',
            coalesce(nr_seq_trans_fin_contab, ctb_param_lote_tit_repasse_w.nr_seq_trans_repasse),
            nr_titulo || ' ' || substr(obter_nome_pf_pj(cd_pessoa_fisica,cd_cgc),1,60) ds_observacao,
            CASE WHEN ctb_param_lote_tit_repasse_w.ie_dt_movto_contab_tit_rep='V' THEN a.dt_vencimento_atual WHEN ctb_param_lote_tit_repasse_w.ie_dt_movto_contab_tit_rep='C' THEN dt_contabil WHEN ctb_param_lote_tit_repasse_w.ie_dt_movto_contab_tit_rep='O' THEN a.dt_vencimento_original  ELSE a.dt_emissao END ,
            a.nr_repasse_terceiro,
            0 nr_rep_terc_item,
            0 nr_seq_proc_repasse,
            0 nr_atendimento,
            null cd_tributo,
            null cd_conta_contabil,
            'TITULO_PAGAR' nm_tabela,
            a.nr_titulo nr_seq_tab_orig,
            null    nr_seq_tab_compl,
            2       nr_seq_info_ctb
    from    Titulo_pagar a
    where   nr_titulo               = nr_titulo_p
    and     coalesce(nr_seq_tributo::text, '') = ''
    and     obter_valor_repasse(nr_repasse_terceiro,'L') <> 0
    order   by 1;

c010_w c010%rowtype;

c020 CURSOR FOR
    SELECT  cd_centro_custo,
            vl_glosa_repasse vl_valor
    from    ctb_repasse_centro_custo
    where   nr_titulo               = nr_titulo_p
    and     nr_repasse_terceiro     = c010_w.nr_repasse_terceiro
    and     nr_seq_trans_fin        = c010_w.nr_seq_trans_fin
    and     c010_w.nm_atributo      = 'VL_GLOSA_REPASSE'

union

    SELECT  cd_centro_custo,
            vl_maior_repasse vl_valor
    from    ctb_repasse_centro_custo
    where   nr_titulo               = nr_titulo_p
    and     nr_repasse_terceiro     = c010_w.nr_repasse_terceiro
    and     nr_seq_trans_fin        = c010_w.nr_seq_trans_fin
    and     c010_w.nm_atributo      = 'VL_MAIOR_REPASSE'
    
union

    select  cd_centro_custo,
            vl_titulo vl_valor
    from    ctb_repasse_centro_custo
    where   nr_titulo               = nr_titulo_p
    and     nr_repasse_terceiro     = c010_w.nr_repasse_terceiro
    and     nr_seq_trans_fin        = c010_w.nr_seq_trans_fin
    and     c010_w.nm_atributo      = 'VL_TITULO_REPASSE'
    
union

    select  cd_centro_custo,
            vl_vencimento vl_valor
    from    ctb_repasse_centro_custo
    where   nr_titulo               = nr_titulo_p
    and     nr_repasse_terceiro     = c010_w.nr_repasse_terceiro
    and     nr_seq_trans_fin        = c010_w.nr_seq_trans_fin
    and     c010_w.nm_atributo      = 'VL_REPASSE_VENC'
    
union

    select  cd_centro_custo,
            vl_repasse vl_valor
    from    ctb_repasse_centro_custo
    where   nr_titulo               = nr_titulo_p
    and     nr_repasse_terceiro     = c010_w.nr_repasse_terceiro
    and     nr_seq_trans_fin        = c010_w.nr_seq_trans_fin
    and     c010_w.nm_atributo      = 'VL_ITEM_REPASSE'
    
union

    select  cd_centro_custo,
            vl_tributo vl_valor
    from    ctb_repasse_centro_custo
    where   nr_titulo               = nr_titulo_p
    and     nr_repasse_terceiro     = c010_w.nr_repasse_terceiro
    and     nr_seq_trans_fin        = c010_w.nr_seq_trans_fin
    and     c010_w.nm_atributo      = 'VL_TRIBUTO_REPASSE';

    c03 CURSOR FOR
    SELECT  b.nr_nota_fiscal
    from    nota_fiscal b,
            repasse_nota_fiscal a
    where   a.nr_seq_nota_fiscal    = b.nr_sequencia
    and         a.nr_repasse_terceiro       = c010_w.nr_repasse_terceiro;


BEGIN

    nr_titulo_w             := nr_titulo_p;
    cd_tipo_lote_contab_w   := 16;

    select  cd_estabelecimento,
            dt_contabil
    into STRICT    cd_estabelecimento_w,
            dt_contabil_w
    from    titulo_pagar
    where   nr_titulo = nr_titulo_p;

    cd_empresa_w    := obter_empresa_estab(cd_estabelecimento_w);
    nm_agrupador_w  := coalesce(trim(both obter_agrupador_contabil(cd_tipo_lote_contab_w)),'NR_TITULO');

    select  x.*
    into STRICT    ctb_param_lote_tit_repasse_w
    from (
    SELECT  a.*
    from    ctb_param_lote_tit_repasse a
    where   a.cd_empresa    = cd_empresa_w
    and     coalesce(a.cd_estab_exclusivo, cd_estabelecimento_w) = cd_estabelecimento_w
    order by coalesce(a.cd_estab_exclusivo,0) desc) x LIMIT 1;

open c010;
loop
fetch c010 into
        c010_w;
EXIT WHEN NOT FOUND; /* apply on c010 */

    begin
    ds_notas_fiscais_w      := null;
    ds_lancamento_w         := '';

        open c03;
        loop
        fetch c03 into
                nr_nota_fiscal_w;
        EXIT WHEN NOT FOUND; /* apply on c03 */
                ds_notas_fiscais_w := substr(nr_nota_fiscal_w || ', ' || ds_notas_fiscais_w,1,255);
        end loop;
        close c03;

        if (ds_notas_fiscais_w IS NOT NULL AND ds_notas_fiscais_w::text <> '') then
                ds_notas_fiscais_w := substr(ds_notas_fiscais_w ,1,instr(ds_notas_fiscais_w,',',-1)-1);
        end if;

        if (coalesce(nr_titulo_w,0) <> 0) then
            begin
            select  nr_documento
            into STRICT    nr_documento_ww
            from    titulo_pagar
            where   nr_titulo = nr_titulo_w;
            exception when others then
                    nr_documento_ww := 0;
            end;

                nr_documento_mov_w := substr(obter_dados_tit_pagar(nr_titulo_w, 'NFSEQ'),1,10);
        end if;

        nr_documento_w  := nr_titulo_w;

        if (c010_w.ds_observacao IS NOT NULL AND c010_w.ds_observacao::text <> '') then
                nr_documento_w  := c010_w.ds_observacao;
        end if;

        if (nm_agrupador_w = 'NR_TITULO') then
                nr_seq_agrupamento_w    := nr_titulo_w;
        elsif (nm_agrupador_w = 'NR_REPASSE_TERCEIRO')then
                nr_seq_agrupamento_w    := c010_w.nr_repasse_terceiro;
        end if;

        if (coalesce(nr_seq_agrupamento_w,0) = 0) and (c010_w.nm_atributo <> 'VL_ITEM_REPASSE')then
                nr_seq_agrupamento_w := nr_titulo_w;
        else
                nr_seq_agrupamento_w := c010_w.nr_repasse_terceiro;
        end if;

        -- COMPLEMENTO DE HISTORICO
        if (coalesce(nr_titulo_w,0) > 0) then
            begin
            select  nm_pessoa,
                    a.nr_titulo_original,
                    trunc(a.dt_emissao),
                    a.nr_seq_rpa
            into STRICT    ds_pessoa_repasse_w,
                    nr_titulo_original_w,
                    dt_emissao_w,
                    nr_seq_rpa_w
            from    terceiro_v c,
                    repasse_terceiro b,
                    titulo_pagar a
            where   a.nr_repasse_terceiro   = b.nr_repasse_terceiro
            and     b.nr_seq_terceiro       = c.nr_sequencia
            and     a.nr_titulo             = nr_titulo_w;
            exception when others then
                    ds_pessoa_repasse_w := null;
                    nr_titulo_original_w := null;
                    dt_emissao_w := null;
                    nr_seq_rpa_w := null;
            end;
        end if;

        if (c010_w.nm_atributo = 'VL_ITEM_REPASSE') then
            select  to_char(max(a.dt_lancamento),'MM/YYYY')
            into STRICT    ds_lancamento_w
            from    repasse_terceiro_item a
            where   nr_repasse_terceiro     = c010_w.nr_repasse_terceiro
            and     nr_sequencia            = c010_w.nr_rep_terc_item;
        end if;

        /* Somente titulo do repasse*/

        nr_titulo_repasse_w     := substr(obter_titulo_repasse_orig(c010_w.nr_repasse_terceiro),1,80);
        ds_pessoa_titulo_w      := substr(obter_nome_pf_pj(c010_w.cd_pessoa_fisica, c010_w.cd_cgc),1,80);
        c010_w.ds_observacao            := substr(rtrim(c010_w.ds_observacao),1,255);
        cd_convenio_w           := null;
        nm_paciente_w           := '';
        ds_convenio_w           := '';

        if (coalesce(c010_w.nr_atendimento,0) <> 0) then
            cd_convenio_w := obter_convenio_atendimento(c010_w.nr_atendimento);
            nm_paciente_w := substr(obter_pessoa_atendimento(c010_w.nr_atendimento, 'N'),1,60);
            if (coalesce(cd_convenio_w, 0) <> 0) then
                ds_convenio_w := substr(obter_nome_convenio(cd_convenio_w),1,255);
            end if;
        end if;

        CALL ctb_online_pck.definir_atrib_compl(cd_tipo_lote_contab_w);
        CALL ctb_online_pck.set_value_compl_hist('NR_TITULO',nr_titulo_w);
        CALL ctb_online_pck.set_value_compl_hist('DS_OBSERVACAO',c010_w.ds_observacao);
        CALL ctb_online_pck.set_value_compl_hist('DS_PESSOA_TITULO',ds_pessoa_titulo_w);
        CALL ctb_online_pck.set_value_compl_hist('DS_PESSOA_REPASSE',ds_pessoa_repasse_w);
        CALL ctb_online_pck.set_value_compl_hist('NR_REPASSE_TERCEIRO',c010_w.nr_repasse_terceiro);
        CALL ctb_online_pck.set_value_compl_hist('NR_NOTA_REPASSE',ds_notas_fiscais_w);
        CALL ctb_online_pck.set_value_compl_hist('NR_TITULO_ORIGINAL',nr_titulo_original_w);
        CALL ctb_online_pck.set_value_compl_hist('DT_EMISSAO',dt_emissao_w);
        CALL ctb_online_pck.set_value_compl_hist('DT_LANCAMENTO',ds_lancamento_w);
        CALL ctb_online_pck.set_value_compl_hist('NR_TITULO_REPASSE',nr_titulo_repasse_w);
        CALL ctb_online_pck.set_value_compl_hist('NR_ATENDIMENTO',c010_w.nr_atendimento);
        CALL ctb_online_pck.set_value_compl_hist('NM_PACIENTE',nm_paciente_w);
        CALL ctb_online_pck.set_value_compl_hist('CD_CONVENIO',cd_convenio_w);
        CALL ctb_online_pck.set_value_compl_hist('DS_CONVENIO',ds_convenio_W);
        CALL ctb_online_pck.set_value_compl_hist('NR_SEQ_RPA',nr_seq_rpa_w);
        CALL ctb_online_pck.set_value_compl_hist('NR_DOCUMENTO',nr_documento_ww);

        /* Francisco - OS 49512 - 22/02/07 - Gerar movimento com a data do titulo */

        if (coalesce(ctb_param_lote_tit_repasse_w.ie_dt_movto_contab_tit_rep,'L') = 'T') then
            dt_contabil_w := c010_w.dt_contabil_tit;
        end if;

        if (coalesce(nr_documento_mov_w, '0') = '0') then
            nr_documento_mov_w      := nr_titulo_w;
            ie_origem_doc_w         := 2;
        end if;

        ctb_documento_w.cd_tipo_lote_contabil   := cd_tipo_lote_contab_w;
        ctb_documento_w.cd_estabelecimento      := cd_estabelecimento_w;
        ctb_documento_w.dt_competencia          := dt_contabil_w;
        ctb_documento_w.nr_seq_trans_financ     := c010_w.nr_seq_trans_fin;
        ctb_documento_w.nm_atributo             := c010_w.nm_atributo;
        ctb_documento_w.nm_tabela               := c010_w.nm_tabela;
        ctb_documento_w.nr_documento            := c010_w.nr_seq_tab_orig;
        ctb_documento_w.nr_seq_doc_compl        := c010_w.nr_seq_tab_compl;
        ctb_documento_w.nr_seq_info             := c010_w.nr_seq_info_ctb;

        dados_contab_w.cd_estab_movto           := cd_estabelecimento_w;
        dados_contab_w.cd_conta_contabil        := c010_w.cd_conta_contabil;
        dados_contab_w.nr_seq_agrupamento       := nr_seq_agrupamento_w;
        dados_contab_w.dt_transacao             := dt_contabil_w;
        dados_contab_w.nr_seq_trans_fin         := c010_w.nr_seq_trans_fin;
        dados_contab_w.nm_atributo              := c010_w.nm_atributo;
        dados_contab_w.cd_pessoa_fisica         := c010_w.cd_pessoa_fisica;
        dados_contab_w.cd_cnpj                  := c010_w.cd_cgc;
        dados_contab_w.cd_tributo               := c010_w.cd_tributo;
        dados_contab_w.nr_titulo_pagar          := nr_titulo_w;
        dados_contab_w.cd_tributo_regra         := c010_w.cd_tributo;
        dados_contab_w.nr_repasse_terceiro      := c010_w.nr_repasse_terceiro;
        dados_contab_w.nm_tabela                := c010_w.nm_tabela;
        dados_contab_w.ie_origem_documento      := ie_origem_doc_w;
        dados_contab_w.doc                      := ctb_documento_w;

        if ((ctb_param_lote_tit_repasse_w.ie_contab_trib_repasse_cc = 'S' AND c010_w.nm_atributo = 'VL_TRIBUTO_REPASSE') or (c010_w.nm_atributo <> 'VL_TRIBUTO_REPASSE')) and
            (((ctb_param_lote_tit_repasse_w.ie_cc_rep_maior_glosa = 'S') and (c010_w.nm_atributo in ('VL_GLOSA_REPASSE','VL_MAIOR_REPASSE')))
            or (ctb_param_lote_tit_repasse_w.ie_cc_repasse = 'S')) and (c010_w.vl_transacao <> 0) then

            open c020;
            loop
            fetch c020 into
                    cd_centro_custo_w,
                    vl_movimento_w;
            EXIT WHEN NOT FOUND; /* apply on c020 */

                dados_contab_w.cd_centro_custo  := cd_centro_custo_w;
                dados_contab_w.doc.vl_movimento := vl_movimento_w;
                ctb_contab_onl_lote_fin_pck.contabiliza_trans_financ(dados_contab_w, nm_usuario_p);

            end loop;
            close c020;
        else
                dados_contab_w.cd_centro_custo := 0;
                dados_contab_w.doc.vl_movimento := c010_w.vl_transacao;
                ctb_contab_onl_lote_fin_pck.contabiliza_trans_financ(dados_contab_w, nm_usuario_p);
        end if;
    end;
    end loop;
close c010;

if (dados_contab_w.nr_lote_contabil != 0) then
        begin
        update  titulo_pagar
        set     nr_lote_contabil        = dados_contab_w.nr_lote_contabil
        where   nr_titulo               = nr_titulo_p;
        end;
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ctb_contab_onl_titulo_repasse (nr_titulo_p titulo_pagar.nr_titulo%type, nm_usuario_p text ) FROM PUBLIC;

