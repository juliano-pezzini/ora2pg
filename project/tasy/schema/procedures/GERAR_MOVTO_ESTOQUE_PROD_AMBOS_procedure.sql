-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_movto_estoque_prod_ambos ( cd_material_p bigint, qt_movimento_p bigint, cd_unidade_medida_p text, cd_cgc_fornecedor_p text, nr_seq_lote_fornec_p bigint, ie_acao_p text, dt_mesano_referencia_p timestamp, cd_local_estoque_p bigint, cd_estabelecimento_p bigint, nr_lote_producao_p bigint, nr_seq_componente_p bigint, nm_usuario_p text) AS $body$
DECLARE


nr_movimento_estoque_w		movimento_estoque.nr_movimento_estoque%type;
cd_oper_baixa_producao_w	parametro_estoque.cd_oper_baixa_producao%type;
cd_oper_baixa_prod_consig_w	parametro_estoque.cd_oper_baixa_prod_consig%type;
cd_operacao_baixa_w		parametro_estoque.cd_oper_baixa_producao%type;
cd_centro_custo_w		local_estoque.cd_centro_custo%type;


BEGIN

select	coalesce(max(cd_oper_baixa_producao),0),
	coalesce(max(cd_oper_baixa_prod_consig),0)
into STRICT	cd_oper_baixa_producao_w,
	cd_oper_baixa_prod_consig_w
from	parametro_estoque
where	cd_estabelecimento = cd_estabelecimento_p;

if (coalesce(cd_cgc_fornecedor_p, 'X') <> 'X') then
	cd_operacao_baixa_w := cd_oper_baixa_prod_consig_w;
	
	if (cd_operacao_baixa_w = 0) then
		CALL wheb_mensagem_pck.exibir_mensagem_abort(1110064);
		 /* 1110064 - Para finalizar a producao e necessario informar a operacao de baixa producao consignado. */

	end if;
else
	cd_operacao_baixa_w := cd_oper_baixa_producao_w;
end if;

select	coalesce(max(cd_centro_custo), 0)
into STRICT	cd_centro_custo_w
from	local_estoque
where	cd_local_estoque = cd_local_estoque_p;

select	nextval('movimento_estoque_seq')
into STRICT	nr_movimento_estoque_w
;

insert into movimento_estoque(
	nr_movimento_estoque,
	cd_estabelecimento,
	cd_local_estoque,
	dt_movimento_estoque,
	cd_operacao_estoque,
	cd_acao,
	cd_material,
	dt_mesano_referencia,
	qt_movimento,
	dt_atualizacao,
	nm_usuario,
	ie_origem_documento,
	nr_documento,
	cd_unidade_med_mov,
	cd_unidade_medida_estoque,
	cd_lote_fabricacao,
	dt_validade,
	qt_estoque,
	dt_processo,
	cd_centro_custo,
	cd_fornecedor,
	nr_seq_lote_fornec,
	nr_lote_producao,
	nr_sequencia_item_docto)
values (	nr_movimento_estoque_w,
	cd_estabelecimento_p,
	cd_local_estoque_p,
	clock_timestamp(),
	cd_operacao_baixa_w,
	ie_acao_p,
	cd_material_p,
	dt_mesano_referencia_p,
	qt_movimento_p,
	clock_timestamp(),
	nm_usuario_p,
	'7',
	nr_lote_producao_p,
	cd_unidade_medida_p,
	cd_unidade_medida_p,
	nr_lote_producao_p,
	null,
	qt_movimento_p,
	null,
	CASE WHEN cd_centro_custo_w=0 THEN  null  ELSE cd_centro_custo_w END ,
	cd_cgc_fornecedor_p,
	nr_seq_lote_fornec_p,
	nr_lote_producao_p,
	nr_seq_componente_p);

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_movto_estoque_prod_ambos ( cd_material_p bigint, qt_movimento_p bigint, cd_unidade_medida_p text, cd_cgc_fornecedor_p text, nr_seq_lote_fornec_p bigint, ie_acao_p text, dt_mesano_referencia_p timestamp, cd_local_estoque_p bigint, cd_estabelecimento_p bigint, nr_lote_producao_p bigint, nr_seq_componente_p bigint, nm_usuario_p text) FROM PUBLIC;

