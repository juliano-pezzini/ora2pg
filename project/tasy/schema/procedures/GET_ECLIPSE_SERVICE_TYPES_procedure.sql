-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE get_eclipse_service_types ( nr_account_p bigint, general_procedures_p INOUT text, specialist_procedures_p INOUT text, pathology_procedures_p INOUT text ) AS $body$
DECLARE


          
cd_mbs_code_w		varchar(5);
type_of_claim_w 	varchar(1);

c_procedimento CURSOR FOR
SELECT	a.cd_procedimento,
	cd_procedimento_loc,
	coalesce((select x.IE_CLAIM_TYPE
	from eclipse_rules x 
	where (x.cd_procedimento 		= a.cd_procedimento
		or x.CD_GRUPO_PROC 		= b.CD_GRUPO_PROC
		or x.CD_ESPECIALIDADE_PROC 	= (obter_dados_estrut_proc(b.cd_procedimento,b.ie_origem_proced,'C','E'))::numeric 
		or x.CD_AREA_PROC 		= (obter_dados_estrut_proc(b.cd_procedimento,b.ie_origem_proced,'C','A'))::numeric )), 'O')  type_of_claim_w
		-- also find out which field is the internal procedure code 
	from	procedimento_paciente a,
		procedimento b
	where	a.nr_interno_conta		= nr_account_p
	and 	a.CD_PROCEDIMENTO 		= b.CD_PROCEDIMENTO;

BEGIN 

for r_procedimento in c_procedimento loop

	if (r_procedimento.type_of_claim_w = 'O') then
		if (general_procedures_p IS NOT NULL AND general_procedures_p::text <> '') then 
			select 	general_procedures_p ||','|| r_procedimento.cd_procedimento_loc 
			into STRICT 	general_procedures_p
			;
		else
			select 	r_procedimento.cd_procedimento_loc 
			into STRICT 	general_procedures_p
			;
		end if;
	end if;
	
	if (r_procedimento.type_of_claim_w = 'S') then
		if (specialist_procedures_p IS NOT NULL AND specialist_procedures_p::text <> '') then
			select 	specialist_procedures_p ||','||  r_procedimento.cd_procedimento_loc
			into STRICT 	specialist_procedures_p
			;
		else
			select 	r_procedimento.cd_procedimento_loc  
			into STRICT 	specialist_procedures_p
			;
		end if;
	end if;
	
	if (r_procedimento.type_of_claim_w = 'P') then
		if (pathology_procedures_p IS NOT NULL AND pathology_procedures_p::text <> '') then
			select 	pathology_procedures_p ||','||  r_procedimento.cd_procedimento_loc 
			into STRICT 	pathology_procedures_p
			;
		else
			select  r_procedimento.cd_procedimento_loc 
			into STRICT 	pathology_procedures_p
			;
		end if;
	end if;
	
end loop;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE get_eclipse_service_types ( nr_account_p bigint, general_procedures_p INOUT text, specialist_procedures_p INOUT text, pathology_procedures_p INOUT text ) FROM PUBLIC;

