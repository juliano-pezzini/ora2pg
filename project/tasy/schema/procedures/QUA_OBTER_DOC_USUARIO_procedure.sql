-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE qua_obter_doc_usuario ( cd_estabelecimento_p bigint, nm_usuario_p text, ie_lib_setor_usuario_p text, ie_consid_toda_regra_p text, -- troca or por and
 qt_elaborar_p INOUT bigint, qt_validar_p INOUT bigint, qt_revisar_p INOUT bigint, qt_aprovar_p INOUT bigint, qt_ler_p INOUT bigint, ie_exibir_p INOUT text) AS $body$
DECLARE


cd_pessoa_fisica_w	varchar(10);
qt_elaborar_w		bigint;
qt_validar_w		bigint;
qt_revisar_w		bigint;
qt_aprovar_w		bigint;
qt_ler_w			bigint;
ie_exibir_w		varchar(1);
nm_user_w		varchar(50);
qt_aprovar_rev_w		bigint;


BEGIN

select	substr(obter_pessoa_fisica_usuario(nm_usuario_p,'C'),1,10)
into STRICT	cd_pessoa_fisica_w
;

select	count(*) qt_elaborar
into STRICT	qt_elaborar_w
from	qua_documento a
where	coalesce(a.dt_elaboracao::text, '') = ''
and	a.cd_pessoa_elaboracao = cd_pessoa_fisica_w
and	obter_acesso_docto_qual(a.nr_sequencia,nm_usuario_p, cd_estabelecimento_p, ie_lib_setor_usuario_p,ie_consid_toda_regra_p) = 'S'
and	obter_acesso_idioma_qual(a.nr_sequencia, nm_usuario_p, cd_estabelecimento_p, ie_lib_setor_usuario_p, ie_consid_toda_regra_p) = 'S'
and	a.cd_estabelecimento = cd_estabelecimento_p;

select	count(*) qt_validar
into STRICT	qt_validar_w
from	qua_documento a
where	coalesce(a.dt_validacao::text, '') = ''
and	a.cd_pessoa_validacao = cd_pessoa_fisica_w
and	obter_acesso_docto_qual(a.nr_sequencia,nm_usuario_p, cd_estabelecimento_p, ie_lib_setor_usuario_p,ie_consid_toda_regra_p) = 'S'
and	obter_acesso_idioma_qual(a.nr_sequencia, nm_usuario_p, cd_estabelecimento_p, ie_lib_setor_usuario_p, ie_consid_toda_regra_p) = 'S'
and	a.cd_estabelecimento = cd_estabelecimento_p;

select	count(*) qt_revisao
into STRICT	qt_revisar_w
from	qua_doc_revisao a,
	qua_documento b
where	a.nr_seq_doc = b.nr_sequencia
and	coalesce(a.dt_revisao::text, '') = ''
and	a.cd_pessoa_revisao = cd_pessoa_fisica_w
and	obter_acesso_docto_qual(a.nr_seq_doc,nm_usuario_p, cd_estabelecimento_p, ie_lib_setor_usuario_p,ie_consid_toda_regra_p) = 'S'
and	obter_acesso_idioma_qual(a.nr_sequencia, nm_usuario_p, cd_estabelecimento_p, ie_lib_setor_usuario_p, ie_consid_toda_regra_p) = 'S'
and	b.cd_estabelecimento = cd_estabelecimento_p;

select	count(*) qt_aprovar
into STRICT	qt_aprovar_w
from	qua_documento a
where	coalesce(a.dt_aprovacao::text, '') = ''
and	a.cd_pessoa_aprov = cd_pessoa_fisica_w
and	obter_acesso_docto_qual(a.nr_sequencia,nm_usuario_p, cd_estabelecimento_p, ie_lib_setor_usuario_p,ie_consid_toda_regra_p) = 'S'
and	obter_acesso_idioma_qual(a.nr_sequencia, nm_usuario_p, cd_estabelecimento_p, ie_lib_setor_usuario_p, ie_consid_toda_regra_p) = 'S'
and 	qua_obter_se_doc_pend_aprov(a.nr_sequencia,cd_pessoa_fisica_w) = 'S'
and	a.cd_estabelecimento = cd_estabelecimento_p;

select	coalesce(count(*), 0) qt_aprovar_rev
into STRICT	qt_aprovar_rev_w
from	qua_doc_revisao a,
	qua_documento b
where	a.nr_seq_doc = b.nr_sequencia
and	coalesce(a.dt_aprovacao::text, '') = ''
and	a.cd_pessoa_aprovacao = cd_pessoa_fisica_w
and	obter_acesso_docto_qual(a.nr_seq_doc,nm_usuario_p, cd_estabelecimento_p, ie_lib_setor_usuario_p,ie_consid_toda_regra_p) = 'S'
and	obter_acesso_idioma_qual(a.nr_sequencia, nm_usuario_p, cd_estabelecimento_p, ie_lib_setor_usuario_p, ie_consid_toda_regra_p) = 'S'
and	b.cd_estabelecimento = cd_estabelecimento_p;

qt_aprovar_w := qt_aprovar_w + qt_aprovar_rev_w;

select	username
into STRICT	nm_user_w
from	user_users;


if (nm_user_w = 'CORP') then
	begin
		select 	count(*) qt_ler
		into STRICT	qt_ler_w
		from	qua_documento a
		where	substr(obter_acesso_docto_qual(a.nr_sequencia, nm_usuario_p, cd_estabelecimento_p, ie_lib_setor_usuario_p, ie_consid_toda_regra_p ), 1, 1) = 'S'
		and 	substr(obter_acesso_idioma_qual(a.nr_sequencia, nm_usuario_p,cd_estabelecimento_p,ie_lib_setor_usuario_p,ie_consid_toda_regra_p ), 1, 1) = 'S'
		and 	substr(qua_obter_se_subproc_doc_lib(a.nr_sequencia, nm_usuario_p),1,1) = 'S'
		and 	a.ie_situacao = 'A'
		and 	((ie_pergunta = 'S' and obter_se_doc_respondido(a.nr_sequencia, nm_usuario_p) = 'N')
			or (coalesce(ie_pergunta,'N') = 'N' and coalesce(obter_se_doc_lido_usuario(a.nr_sequencia, nm_usuario_p),'N') = 'N'))
		and	qua_obter_se_doc_obrigatorio(a.nr_sequencia, nm_usuario_p) = 'S'
		and	((substr(obter_se_contido_char(a.ie_status, obter_valor_param_usuario(4003, 2, wheb_usuario_pck.get_cd_perfil, nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento)),1,1) = 'S')
			or	(a.ie_status = 'R' AND a.dt_validacao IS NOT NULL AND a.dt_validacao::text <> ''))
		and	(dt_aprovacao IS NOT NULL AND dt_aprovacao::text <> '')
		and	((nr_seq_idioma = wheb_usuario_pck.get_nr_seq_idioma) or (coalesce(nr_seq_idioma::text, '') = ''));
	end;
else
	begin
		select	count(*) qt_ler
		into STRICT	qt_ler_w
		from	qua_documento a
		where	((coalesce(a.ie_pergunta, 'N') = 'N' and coalesce(obter_se_doc_lido_usuario(a.nr_sequencia, nm_usuario_p),'N') = 'N')
			or (a.ie_pergunta = 'S' and obter_se_doc_respondido(a.nr_sequencia, nm_usuario_p) = 'N'))
		and	obter_acesso_docto_qual(a.nr_sequencia,nm_usuario_p, cd_estabelecimento_p, ie_lib_setor_usuario_p, ie_consid_toda_regra_p) = 'S'
		and	obter_acesso_idioma_qual(a.nr_sequencia, nm_usuario_p, cd_estabelecimento_p, ie_lib_setor_usuario_p, ie_consid_toda_regra_p) = 'S'
		and	qua_obter_se_subproc_doc_lib(a.nr_sequencia,nm_usuario_p) = 'S'
		--and	a.cd_estabelecimento = cd_estabelecimento_p
		and	a.ie_situacao	= 'A'
		--and	a.dt_aprovacao is not null
		and	a.ie_status = 'D'
		and	((a.nr_seq_idioma = philips_param_pck.get_nr_seq_idioma) or (coalesce(a.nr_seq_idioma::text, '') = ''))
		and	qua_obter_se_doc_obrigatorio(a.nr_sequencia, nm_usuario_p) = 'S';
		end;
end if;

ie_exibir_w	:= 'N';

if (qt_elaborar_w > 0) or (qt_validar_w > 0) or (qt_revisar_w > 0) or (qt_aprovar_w > 0) or (qt_ler_w > 0) then
	ie_exibir_w	:= 'S';
end if;

qt_elaborar_p	:= qt_elaborar_w;
qt_validar_p	:= qt_validar_w;
qt_revisar_p	:= qt_revisar_w;
qt_aprovar_p	:= qt_aprovar_w;
qt_ler_p	:= qt_ler_w;
ie_exibir_p	:= ie_exibir_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE qua_obter_doc_usuario ( cd_estabelecimento_p bigint, nm_usuario_p text, ie_lib_setor_usuario_p text, ie_consid_toda_regra_p text, qt_elaborar_p INOUT bigint, qt_validar_p INOUT bigint, qt_revisar_p INOUT bigint, qt_aprovar_p INOUT bigint, qt_ler_p INOUT bigint, ie_exibir_p INOUT text) FROM PUBLIC;

