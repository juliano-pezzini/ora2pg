-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_eis_residuos_lixo ( dt_referencia_p timestamp, nm_usuario_p text) AS $body$
DECLARE


cd_cgc_destino_w		setor_residuo_item.cd_cgc_destino%type;
cd_setor_destino_w 		setor_residuo_item.cd_setor_destino%type;
cd_setor_saida_w		setor_residuo.cd_setor_atendimento%type;
nr_seq_item_w 			setor_residuo_item.nr_seq_item%type;
qt_peso_w				setor_residuo_item.qt_peso%type;
cd_estabelecimento_w	setor_residuo.cd_estabelecimento%type;
nr_seq_grupo_w			grupo_residuo.nr_sequencia%type;
cd_cgc_transportadora_w	setor_residuo_item.cd_cgc_transportadora%type;
nr_seq_acondicionamento_w	setor_residuo_item.nr_seq_acondicionamento%type;
nr_seq_nome_comercial_w		setor_residuo_item.nr_seq_nome_comercial%type;
dt_referencia_w			timestamp;
nr_seq_log_w			bigint;
dt_inicio_w				timestamp;
dt_final_w				timestamp;
dt_saida_residuo_w		timestamp;
ds_indicador_w			varchar(50);


c01 CURSOR FOR
	SELECT 	b.cd_cgc_destino,
		b.cd_setor_destino,
		a.cd_setor_atendimento,
		b.nr_seq_item,
		b.qt_peso,
		a.dt_referencia,
		a.cd_estabelecimento,
		trunc(a.dt_saida_residuo),
		b.cd_cgc_transportadora,
		b.nr_seq_acondicionamento,
		b.nr_seq_nome_comercial
	from 	setor_residuo_item b,
		setor_residuo a
	where 	a.nr_sequencia = b.nr_seq_setor
	and	a.dt_saida_residuo between dt_inicio_w and dt_final_w;


BEGIN
dt_inicio_w				:= trunc(dt_referencia_p,'MM');
dt_final_w				:= last_day(fim_dia(dt_referencia_p));

delete	from eis_residuos_lixo
where	dt_registro between dt_inicio_w and dt_final_w;

ds_indicador_w	:= substr(wheb_mensagem_pck.get_texto(305671),1,50);

nr_seq_log_w := gravar_log_indicador(1286, ds_indicador_w, clock_timestamp(), dt_inicio_w, coalesce(wheb_usuario_pck.get_nm_usuario,'Tasy'), nr_seq_log_w);

open c01;
loop
fetch 	c01 into
	cd_cgc_destino_w,
	cd_setor_destino_w,
	cd_setor_saida_w,
	nr_seq_item_w,
	qt_peso_w,
	dt_referencia_w,
	cd_estabelecimento_w,
	dt_saida_residuo_w,
	cd_cgc_transportadora_w,
	nr_seq_acondicionamento_w,
	nr_seq_nome_comercial_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */

	select	coalesce(max(b.nr_seq_grupo),0)
	into STRICT 	nr_seq_grupo_w
	from	residuo b,
		setor_residuo_item c
	where	b.nr_sequencia	= c.nr_seq_item
	and	c.nr_seq_item	= nr_seq_item_w;

	insert into	eis_residuos_lixo(
			nr_seq_item,
			cd_empresa_destino,
			cd_setor_destino,
			cd_setor_saida,
			dt_atualizacao,
			nm_usuario,
			qt_peso_item,
			dt_referencia,
			cd_estabelecimento,
			dt_registro,
			nr_seq_grupo,
			cd_cgc_transportadora,
			nr_seq_acondicionamento,
			nr_seq_nome_comercial)
		values ( nr_seq_item_w,
			cd_cgc_destino_w,
			cd_setor_destino_w,
			cd_setor_saida_w,
			clock_timestamp(),
			nm_usuario_p,
			qt_peso_w,
			dt_referencia_w,
			cd_estabelecimento_w,
			dt_saida_residuo_w,
			nr_seq_grupo_w,
			cd_cgc_transportadora_w,
			nr_seq_acondicionamento_w,
			nr_seq_nome_comercial_w);
end loop;
close c01;

CALL atualizar_log_indicador(clock_timestamp(), nr_seq_log_w);
commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_eis_residuos_lixo ( dt_referencia_p timestamp, nm_usuario_p text) FROM PUBLIC;

