-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE man_gerar_projeto_os ( nr_seq_ordem_p bigint, cd_responsavel_p text, nm_usuario_p text, cd_estabelecimento_p bigint) AS $body$
DECLARE

 
dt_ordem_servico_w			timestamp;
nr_seq_grupo_des_w			bigint;
cd_pessoa_solicitante_w		varchar(10);
ds_dano_breve_w				varchar(80);
nr_seq_localizacao_w		bigint;
nr_seq_projeto_w			bigint;
nr_seq_cliente_w			bigint;
cd_cnpj_w					varchar(14);
nr_seq_gerencia_w			bigint;
nm_pessoa_usuario_w			varchar(100);
nr_seq_hist_w				bigint;
nr_seq_equipe_w				bigint;
nr_seq_papel_w				bigint;
nm_usuario_w				varchar(15);
cd_gerente_w				varchar(10);
ds_setor_atendimento_w		varchar(100);
ds_fone_w					varchar(40);
ds_email_w					varchar(255);
cd_analista_w				varchar(10);
cd_funcao_w					integer;


BEGIN 
select	dt_ordem_servico, 
		nr_seq_grupo_des, 
		cd_pessoa_solicitante, 
		substr(ds_dano_breve,1,80), 
		nr_seq_localizacao, 
		cd_funcao 
into STRICT	dt_ordem_servico_w, 
		nr_seq_grupo_des_w, 
		cd_pessoa_solicitante_w, 
		ds_dano_breve_w, 
		nr_seq_localizacao_w, 
		cd_funcao_w 
from	man_ordem_servico 
where	nr_sequencia = nr_seq_ordem_p;
 
select	nextval('proj_projeto_seq') 
into STRICT	nr_seq_projeto_w
;
 
select	max(cd_cnpj) 
into STRICT	cd_cnpj_w 
from	man_localizacao 
where	nr_sequencia = nr_seq_localizacao_w;
 
select	coalesce(max(nr_seq_cliente),0) 
into STRICT	nr_seq_cliente_w 
from	man_ordem_servico 
where	nr_sequencia = nr_seq_ordem_p;
 
if (nr_seq_cliente_w = 0) then 
	begin 
	select	coalesce(max(nr_sequencia),0) 
	into STRICT	nr_seq_cliente_w 
	from	com_cliente 
	where	cd_cnpj	= cd_cnpj_w;
 
	if (nr_seq_cliente_w = 0) then 
		select	coalesce(max(nr_sequencia),0) 
		into STRICT	nr_seq_cliente_w 
		from	com_cliente 
		where	cd_cnpj	in (	SELECT	cd_cnpj 
					from	man_localizacao_pj 
					where	nr_seq_localizacao = nr_seq_localizacao_w);
	end if;
	end;
end if;
 
select	max(nr_seq_gerencia) 
into STRICT	nr_seq_gerencia_w 
from	grupo_desenvolvimento 
where	nr_sequencia = nr_seq_grupo_des_w;
 
/* Criação do projeto baseado na ordem de serviço */
 
insert	into proj_projeto(nr_sequencia, 
	nr_seq_cliente, 
	dt_atualizacao, 
	nm_usuario, 
	dt_atualizacao_nrec, 
	nm_usuario_nrec, 
	cd_coordenador, 
	cd_gerente_cliente, 
	ds_titulo, 
	dt_inicio_prev, 
	dt_fim_prev, 
	ie_status, 
	dt_inicio_real, 
	dt_fim_real, 
	nr_seq_classif, 
	nm_curto_agenda, 
	dt_projeto, 
	dt_repasse_comercial, 
	nr_seq_forma_cont, 
	ds_observacao, 
	dt_virada, 
	ie_escore, 
	ie_origem, 
	nr_seq_gerencia, 
	nr_seq_ordem_serv, 
	nr_seq_estagio, 
	nr_seq_grupo_des, 
	ie_relat_completo, 
	cd_estabelecimento, 
	cd_funcao) 
values (nr_seq_projeto_w, 
	nr_seq_cliente_w, 
	clock_timestamp(), 
	nm_usuario_p, 
	clock_timestamp(), 
	nm_usuario_p, 
	cd_responsavel_p, 
	cd_pessoa_solicitante_w, 
	ds_dano_breve_w, 
	trunc(clock_timestamp(), 'dd'), 
	null, 
	'I', 
	null, null, 11, null, 
	trunc(clock_timestamp(), 'dd'), 
	null, null, 'Projeto gerado a partir da OS' || nr_seq_ordem_p, 
	null, null, 'D', 
	nr_seq_gerencia_w, 
	nr_seq_ordem_p, 
	1, 
	nr_seq_grupo_des_w, 
	'S', 
	cd_estabelecimento_p, 
	cd_funcao_w);
 
select	nextval('proj_equipe_seq') 
into STRICT	nr_seq_equipe_w
;
 
insert	into proj_equipe -- Equipe de análise 
	(ds_objetivo, 
	dt_atualizacao, 
	dt_atualizacao_nrec, 
	dt_inicio, 
	dt_liberacao, 
	ie_interna_externa, 
	ie_virada, 
	nm_usuario, 
	nm_usuario_nrec, 
	nr_seq_apres, 
	nr_seq_cliente, 
	nr_seq_equipe_funcao, 
	nr_seq_proj, 
	nr_sequencia, 
	nr_seq_virada) 
values (null, 
	clock_timestamp(), 
	clock_timestamp(), 
	null, 
	null, 
	'I', 
	'N', 
	nm_usuario_p, 
	nm_usuario_p, 
	1, 
	null, 
	1, 
	nr_seq_projeto_w, 
	nr_seq_equipe_w, 
	null);
 
select	nextval('proj_equipe_papel_seq') 
into STRICT	nr_seq_papel_w
;
 
select	max(a.nm_usuario) 
into STRICT	nm_usuario_w 
from	usuario a 
where	a.cd_pessoa_fisica = cd_pessoa_solicitante_w;
 
cd_gerente_w := cd_pessoa_solicitante_w;
 
/* 
	Realizado ajuste, uma vez que, foi alterado o PD e não são apenas os gerentes que podem solicitar a abertura do projeto 
 
	select	trim(sis_obter_gerente(nm_usuario_w,'C')) 
	into	cd_gerente_w 
	from	dual; 
*/
 
 
select	max(b.ds_setor_atendimento) 
into STRICT	ds_setor_atendimento_w 
from 	setor_atendimento b, 
	usuario a 
where 	a.cd_setor_atendimento = b.cd_setor_atendimento 
and  	a.cd_pessoa_fisica = cd_gerente_w;
 
select	max(CASE WHEN coalesce(obter_compl_pf(cd_gerente_w,2,'DDT')::text, '') = '' THEN null  ELSE '(' || obter_compl_pf(cd_gerente_w,2,'DDT') || ')' END  || obter_compl_pf(cd_gerente_w,2,'T') || 
	' / ' || CASE WHEN coalesce(a.nr_ddd_celular::text, '') = '' THEN null  ELSE '(' || a.nr_ddd_celular || ')' END  || a.nr_telefone_celular) 
into STRICT	ds_fone_w 
from	pessoa_fisica a 
where	a.cd_pessoa_fisica = cd_gerente_w 
order by 1;
 
select	max(obter_compl_pf(cd_gerente_w,2,'M')) 
into STRICT	ds_email_w 
 
order by 1;
 
insert	into proj_equipe_papel -- insere gerente 
	(cd_pessoa_fisica, 
	ds_atuacao, 
	ds_cargo, 
	ds_email, 
	ds_fone, 
	ds_setor, 
	dt_atualizacao, 
	dt_atualizacao_nrec, 
	dt_fim, 
	dt_fim_resp, 
	dt_inicio_resp, 
	ie_alerta, 
	ie_alocado_original, 
	ie_funcao_rec_migr, 
	ie_situacao, 
	nm_guerra, 
	nm_pessoa, 
	nm_usuario, 
	nm_usuario_nrec, 
	nr_seq_apres, 
	nr_seq_cadastro, 
	nr_seq_equipe, 
	nr_seq_funcao, 
	nr_sequencia, 
	qt_horas_rec_proj) 
values (cd_gerente_w, 
	null, 
	null, 
	ds_email_w, 
	ds_fone_w, 
	ds_setor_atendimento_w, 
	clock_timestamp(), 
	clock_timestamp(), 
	null, 
	null, 
	null, 
	null, 
	'S', 
	null, 
	'A', 
	null, 
	null, 
	nm_usuario_p, 
	nm_usuario_p, 
	1, 
	null, 
	199, 
	51, 
	nr_seq_papel_w, 
	null);
 
select	nextval('proj_equipe_papel_seq') 
into STRICT	nr_seq_papel_w
;
 
select	max(a.cd_pessoa_fisica) 
into STRICT	cd_analista_w 
from	usuario a, 
	man_ordem_serv_tecnico b 
where	a.nm_usuario = b.nm_usuario 
and	b.nr_sequencia = (	SELECT	max(x.nr_sequencia) 
				from	man_ordem_serv_tecnico x 
				where	x.nr_seq_tipo = 21 
				and	(x.dt_liberacao IS NOT NULL AND x.dt_liberacao::text <> '') 
				and	x.nr_seq_ordem_serv = nr_seq_ordem_p);
 
select	max(b.ds_setor_atendimento) 
into STRICT	ds_setor_atendimento_w 
from 	setor_atendimento b, 
	usuario a 
where 	a.cd_setor_atendimento = b.cd_setor_atendimento 
and  	a.cd_pessoa_fisica = cd_analista_w;
 
select	CASE WHEN coalesce(obter_compl_pf(cd_analista_w,2,'DDT')::text, '') = '' THEN null  ELSE '(' || obter_compl_pf(cd_analista_w,2,'DDT') || ')' END  || obter_compl_pf(cd_analista_w,2,'T') || 
	' / ' || CASE WHEN coalesce(a.nr_ddd_celular::text, '') = '' THEN null  ELSE '(' || a.nr_ddd_celular || ')' END  || a.nr_telefone_celular 
into STRICT	ds_fone_w 
from	pessoa_fisica a 
where	a.cd_pessoa_fisica = cd_analista_w 
order by 1;
 
select	obter_compl_pf(cd_analista_w,2,'M') 
into STRICT	ds_email_w 
 
order by 1;
 
insert	into proj_equipe_papel -- insere Analista 
	(cd_pessoa_fisica, 
	ds_atuacao, 
	ds_cargo, 
	ds_email, 
	ds_fone, 
	ds_setor, 
	dt_atualizacao, 
	dt_atualizacao_nrec, 
	dt_fim, 
	dt_fim_resp, 
	dt_inicio_resp, 
	ie_alerta, 
	ie_alocado_original, 
	ie_funcao_rec_migr, 
	ie_situacao, 
	nm_guerra, 
	nm_pessoa, 
	nm_usuario, 
	nm_usuario_nrec, 
	nr_seq_apres, 
	nr_seq_cadastro, 
	nr_seq_equipe, 
	nr_seq_funcao, 
	nr_sequencia, 
	qt_horas_rec_proj) 
values (cd_analista_w, 
	null, 
	null, 
	ds_email_w, 
	ds_fone_w, 
	ds_setor_atendimento_w, 
	clock_timestamp(), 
	clock_timestamp(), 
	null, 
	null, 
	null, 
	null, 
	'S', 
	null, 
	'A', 
	null, 
	null, 
	nm_usuario_p, 
	nm_usuario_p, 
	5, 
	null, 
	199, 
	44, 
	nr_seq_papel_w, 
	null);
 
select	nextval('proj_equipe_seq') 
into STRICT	nr_seq_equipe_w
;
 
insert	into proj_equipe -- Equipe do solicitante 
	(ds_objetivo, 
	dt_atualizacao, 
	dt_atualizacao_nrec, 
	dt_inicio, 
	dt_liberacao, 
	ie_interna_externa, 
	ie_virada, 
	nm_usuario, 
	nm_usuario_nrec, 
	nr_seq_apres, 
	nr_seq_cliente, 
	nr_seq_equipe_funcao, 
	nr_seq_proj, 
	nr_sequencia, 
	nr_seq_virada) 
values (null, 
	clock_timestamp(), 
	clock_timestamp(), 
	null, 
	null, 
	'I', 
	'N', 
	nm_usuario_p, 
	nm_usuario_p, 
	10, 
	null, 
	1, 
	nr_seq_projeto_w, 
	nr_seq_equipe_w, 
	null);
 
select	nextval('proj_equipe_papel_seq') 
into STRICT	nr_seq_papel_w
;
 
select	max(b.ds_setor_atendimento) 
into STRICT	ds_setor_atendimento_w 
from 	setor_atendimento b, 
	usuario a 
where 	a.cd_setor_atendimento = b.cd_setor_atendimento 
and  	a.cd_pessoa_fisica = cd_pessoa_solicitante_w;
 
select	CASE WHEN coalesce(obter_compl_pf(cd_pessoa_solicitante_w,2,'DDT')::text, '') = '' THEN null  ELSE '(' || obter_compl_pf(cd_pessoa_solicitante_w,2,'DDT') || ')' END  || obter_compl_pf(cd_pessoa_solicitante_w,2,'T') || 
	' / ' || CASE WHEN coalesce(a.nr_ddd_celular::text, '') = '' THEN null  ELSE '(' || a.nr_ddd_celular || ')' END  || a.nr_telefone_celular 
into STRICT	ds_fone_w 
from	pessoa_fisica a 
where	a.cd_pessoa_fisica = cd_pessoa_solicitante_w 
order by 1;
 
select	obter_compl_pf(cd_pessoa_solicitante_w,2,'M') 
into STRICT	ds_email_w 
 
order by 1;
 
insert	into proj_equipe_papel -- insere Analista 
	(cd_pessoa_fisica, 
	ds_atuacao, 
	ds_cargo, 
	ds_email, 
	ds_fone, 
	ds_setor, 
	dt_atualizacao, 
	dt_atualizacao_nrec, 
	dt_fim, 
	dt_fim_resp, 
	dt_inicio_resp, 
	ie_alerta, 
	ie_alocado_original, 
	ie_funcao_rec_migr, 
	ie_situacao, 
	nm_guerra, 
	nm_pessoa, 
	nm_usuario, 
	nm_usuario_nrec, 
	nr_seq_apres, 
	nr_seq_cadastro, 
	nr_seq_equipe, 
	nr_seq_funcao, 
	nr_sequencia, 
	qt_horas_rec_proj) 
values (cd_pessoa_solicitante_w, 
	null, 
	null, 
	ds_email_w, 
	ds_fone_w, 
	ds_setor_atendimento_w, 
	clock_timestamp(), 
	clock_timestamp(), 
	null, 
	null, 
	null, 
	null, 
	'S', 
	null, 
	'A', 
	null, 
	null, 
	nm_usuario_p, 
	nm_usuario_p, 
	1, 
	null, 
	199, 
	24, 
	nr_seq_papel_w, 
	null);
 
select	nextval('man_ordem_serv_tecnico_seq') 
into STRICT	nr_seq_hist_w
;
 
select	obter_nome_pf(cd_pessoa_fisica) 
into STRICT 	nm_pessoa_usuario_w 
from 	usuario 
where	nm_usuario = nm_usuario_p;
 
/* Inclusão do histórico de abertura do projeto na ordem de serviço - Conforme norma */
 
Insert into man_ordem_serv_tecnico(nr_sequencia, 
	nr_seq_ordem_serv, 
	dt_atualizacao, 
	nm_usuario, 
	ds_relat_tecnico, 
	cd_versao_tasy, 
	dt_historico, 
	ie_origem, 
	nr_seq_tipo, 
	nm_usuario_lib, 
	dt_liberacao, 
	ie_grau_satisfacao) 
values (nr_seq_hist_w, 
	nr_seq_ordem_p, 
	clock_timestamp(), 
	nm_usuario_p, 
	'Abertura de projeto por ' || nm_pessoa_usuario_w, 
	null, 
	clock_timestamp(), 
	'I', 
	4, nm_usuario_p, clock_timestamp(), null);
 
/* Mudança do status da ordem de serviço para Desenvolvimento em projeto - Conforme norma */
 
update	man_ordem_servico 
set	nr_seq_estagio = 4 
where	nr_sequencia = nr_seq_ordem_p;
 
/* Vinculação da ordem de serviço ao projeto - Conforme norma */
 
/* jcaraujo 26/09/11 - OS362361 - Registrar a Ordem de serviço na documentação do projeto */
 
insert 	into proj_ordem_servico(nr_sequencia,      
	nr_seq_proj,       
	dt_atualizacao,     
	nm_usuario,       
	dt_atualizacao_nrec, 
	nm_usuario_nrec,     
	nr_seq_ordem,      
	nr_seq_cron_etapa,    
	dt_acordo_projeto,    
	dt_proposta_cliente, 
	nr_seq_setor_cli,    
	ie_virada, 
	ie_origem_ordem) 
Values (nextval('proj_ordem_servico_seq'), 
	nr_seq_projeto_w, 
	clock_timestamp(), 
	nm_usuario_p, 
	clock_timestamp(), 
	nm_usuario_p, 
	nr_seq_ordem_p, 
	null, 
	null, 
	null, 
	null, 
	'N', 
	'P');
	 
/* Inclusão do histórico de abertura do projeto no projeto - Conforme norma */
		 
 
if (nr_seq_cliente_w = 0) then 
	begin 
	insert 	into com_cliente_hist(nr_sequencia,      
		nr_seq_cliente,     
		dt_atualizacao,     
		nm_usuario,       
		dt_historico,      
		nr_seq_canal,      
		nr_seq_tipo,       
		ds_titulo,        
		ds_historico,      
		dt_atualizacao_nrec, 
		nm_usuario_nrec,     
		nr_seq_ativ,       
		dt_liberacao,      
		nr_seq_classif,     
		ie_status_projeto,    
		nr_seq_projeto) 
	values (nextval('com_cliente_hist_seq'), 
		nr_seq_cliente_w, 
		clock_timestamp(), 
		nm_usuario_p, 
		clock_timestamp(), 
		null, 
		8, 
		'Abertura de projeto', 
		'Abertura de projeto por ' || nm_pessoa_usuario_w, 
		clock_timestamp(), 
		nm_usuario_p, 
		null, 
		clock_timestamp(), 
		null, 
		'I', 
		nr_seq_projeto_w);
	end;
end if;
 
insert into com_cliente_hist(	nr_sequencia, 
	nr_seq_cliente, 
	dt_atualizacao, 
	nm_usuario, 
	dt_historico, 
	nr_seq_tipo, 
	ds_historico, 
	ds_titulo, 
	dt_liberacao, 
	nr_seq_projeto) 
values (	nextval('com_cliente_hist_seq'), 
	nr_seq_cliente_w, 
	clock_timestamp(), 
	nm_usuario_p, 
	clock_timestamp(), 
	'1', 
	'Projeto aberto atraves da OS: ' || nr_seq_ordem_p, 
	'Histórico de abertura', 
	clock_timestamp(), 
	nr_seq_projeto_w);
 
--proj_desenv_gerar_cronograma(nr_seq_projeto_w, 'I', nm_usuario_p); 
/* OS690983/694213/722048 
proj_desenv_gerar_cronograma(nr_seq_projeto_w, 'P', nm_usuario_p); 
proj_desenv_gerar_cronograma(nr_seq_projeto_w, 'E', nm_usuario_p); 
*/
	 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE man_gerar_projeto_os ( nr_seq_ordem_p bigint, cd_responsavel_p text, nm_usuario_p text, cd_estabelecimento_p bigint) FROM PUBLIC;

