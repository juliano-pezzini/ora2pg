-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE man_vincular_servico_catal_os ( nr_seq_os_p bigint, nr_seq_servico_p bigint, nm_usuario_p text) AS $body$
DECLARE


qt_hora_util_w			double precision;
dt_ordem_servico_w		timestamp;
dt_fim_previsto_w			timestamp;
nr_seq_grupo_trabalho_w		bigint;
nr_seq_grupo_planej_w		bigint;
nr_seq_grupo_trabalho_ww		bigint;
nr_seq_grupo_planej_ww  		bigint;
ie_dt_fim_prev_w			varchar(1);
dt_inicio_previsto_w		timestamp;


BEGIN
ie_dt_fim_prev_w := coalesce(Obter_Valor_Param_Usuario(299,316, Obter_perfil_Ativo, wheb_usuario_pck.get_nm_usuario, wheb_usuario_pck.get_cd_estabelecimento),'S');

if (nr_seq_os_p > 0) and (nr_seq_servico_p > 0) then
	begin
	select	dt_ordem_servico,
		dt_fim_previsto,
		nr_grupo_trabalho,
		nr_grupo_planej,
		dt_inicio_previsto
	into STRICT	dt_ordem_servico_w,
		dt_fim_previsto_w,
		nr_seq_grupo_trabalho_ww,
		nr_seq_grupo_planej_ww,
		dt_inicio_previsto_w
	from	man_ordem_servico
	where	nr_sequencia 	= nr_seq_os_p;

	select	qt_hora_util,
		coalesce(nr_seq_grupo_trabalho, nr_seq_grupo_trabalho_ww),
		coalesce(nr_seq_grupo_planej, nr_seq_grupo_planej_ww)
	into STRICT	qt_hora_util_w,
		nr_seq_grupo_trabalho_w,
		nr_seq_grupo_planej_w
	from	man_catalogo_servico
	where	nr_sequencia	= nr_seq_servico_p;

	if (coalesce(ie_dt_fim_prev_w,'S') = 'I') and (coalesce(dt_inicio_previsto_w,dt_ordem_servico_w) <> dt_ordem_servico_w) then
		dt_ordem_servico_w := dt_inicio_previsto_w;
	end if;

	if (coalesce(ie_dt_fim_prev_w,'S') <> 'N') and -- jcaraujo 18/12/10 - OS276958
		(dt_ordem_servico_w IS NOT NULL AND dt_ordem_servico_w::text <> '') then
		select	coalesce(man_obter_data_fim_catalogo(nr_seq_servico_p, dt_ordem_servico_w, nr_seq_grupo_planej_ww, nr_seq_grupo_trabalho_ww,nm_usuario_p),
			dt_ordem_servico_w + (coalesce(qt_hora_util_w,0) / 24))
		into STRICT	dt_fim_previsto_w
		;
	end if;

	update	man_ordem_servico
	set	nr_seq_cs		= nr_seq_servico_p,
		dt_fim_previsto		= dt_fim_previsto_w,
		nr_grupo_trabalho	= nr_seq_grupo_trabalho_w,
		nr_grupo_planej		= nr_seq_grupo_planej_w
	where	nr_sequencia		= nr_seq_os_p;

	commit;
	end;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE man_vincular_servico_catal_os ( nr_seq_os_p bigint, nr_seq_servico_p bigint, nm_usuario_p text) FROM PUBLIC;

