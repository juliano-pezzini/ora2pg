-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_pagto_unicred_45 ( nr_seq_envio_p bigint, nm_usuario_p text) AS $body$
DECLARE


/* Integração com o sistema SAU/SACC */

ds_conteudo_w		varchar(240);

/* Header */

qt_registros_w		smallint;
vl_total_registro_w	titulo_pagar_escrit.vl_escritural%type;
dt_movto_w		varchar(10);

/* Detalhe*/

nr_titulo_w		varchar(10);--titulo_pagar_escrit.nr_titulo%type;
vl_titulo_w		varchar(20);--titulo_pagar_escrit.vl_escritural%type;
dt_vencimento_w		varchar(10);
ds_conta_w		varchar(20);
cd_lanc_cc_w		varchar(4);
nr_seq_apres_w		bigint;
cd_estabelecimento_w    banco_escritural.cd_estabelecimento%type;

/* Segmento Detalhe*/

c02 CURSOR FOR
SELECT	lpad(b.nr_conta,8,'0') || '-' || substr(coalesce(b.ie_digito_conta,'0'),1),
	'0510',
	lpad(substr(b.nr_titulo,1,9),9,'0'),
	lpad(somente_numero(substr(replace(to_char(b.vl_escritural,'fm0000000000000.00'),',',''),1,16)),16,'0'),
	to_char(c.dt_vencimento_atual,'yymmdd')
FROM titulo_pagar_escrit b, banco_escritural a, titulo_pagar c
LEFT OUTER JOIN pessoa_fisica d ON (c.cd_pessoa_fisica = d.cd_pessoa_fisica)
WHERE b.nr_titulo		= c.nr_titulo and a.nr_sequencia		= b.nr_seq_escrit and a.nr_sequencia		= nr_seq_envio_p;


BEGIN

delete	from w_envio_banco
where	nm_usuario	= nm_usuario_p;

/* Início Header de Arquivo */

nr_seq_apres_w		:= coalesce(nr_seq_apres_w,0) + 1;

select	count(*),
	somente_numero(to_char(sum(b.vl_escritural),'fm0000000000000.00')),
	max(a.cd_estabelecimento)
into STRICT	qt_registros_w,
	vl_total_registro_w,
	cd_estabelecimento_w
FROM titulo_pagar_escrit b, banco_escritural a, titulo_pagar c
LEFT OUTER JOIN pessoa_fisica d ON (c.cd_pessoa_fisica = d.cd_pessoa_fisica)
WHERE b.nr_titulo		= c.nr_titulo and a.nr_sequencia		= b.nr_seq_escrit and a.nr_sequencia		= nr_seq_envio_p;

select	to_char(dt_remessa_retorno,'yymmdd')
into STRICT	dt_movto_w
from	banco e,
	agencia_bancaria d,
	banco_estabelecimento c,
	estabelecimento b,
	banco_escritural a
where	c.cd_banco		= e.cd_banco
and	c.cd_banco		= d.cd_banco
and	c.cd_agencia_bancaria	= d.cd_agencia_bancaria
and	a.nr_seq_conta_banco	= c.nr_sequencia
and	a.cd_estabelecimento	= b.cd_estabelecimento
and	a.nr_sequencia		= nr_seq_envio_p;

ds_conteudo_w	:=	dt_movto_w ||
			lpad(qt_registros_w,4,0) ||
			lpad('0',9,'0') ||
			lpad(vl_total_registro_w,16,0) ||
			lpad(' ',6,' ');

insert	into w_envio_banco(cd_estabelecimento,
	ds_conteudo,
	dt_atualizacao,
	nm_usuario,
	nr_seq_apres,
	nr_seq_apres_2,
	nr_sequencia)
values (cd_estabelecimento_w,
	ds_conteudo_w,
	clock_timestamp(),
	nm_usuario_p,
	nr_seq_apres_w,
	nr_seq_apres_w,
	nextval('w_envio_banco_seq'));
/* Fim Header de Arquivo */

/* Inicio Segmento Detalhe*/

open	c02;
loop
fetch	c02 into
	ds_conta_w,
	cd_lanc_cc_w,
	nr_titulo_w,
	vl_titulo_w,
	dt_vencimento_w;
EXIT WHEN NOT FOUND; /* apply on c02 */

	ds_conteudo_w	:=	ds_conta_w ||
				cd_lanc_cc_w ||
				nr_titulo_w ||
				vl_titulo_w ||
				dt_vencimento_w;

	insert	into w_envio_banco(cd_estabelecimento,
		ds_conteudo,
		dt_atualizacao,
		nm_usuario,
		nr_seq_apres,
		nr_seq_apres_2,
		nr_sequencia)
	values (cd_estabelecimento_w,
		ds_conteudo_w,
		clock_timestamp(),
		nm_usuario_p,
		nr_seq_apres_w,
		nr_seq_apres_w,
		nextval('w_envio_banco_seq'));

end	loop;
close	c02;
/* Final Segmento Detalhe*/

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_pagto_unicred_45 ( nr_seq_envio_p bigint, nm_usuario_p text) FROM PUBLIC;

