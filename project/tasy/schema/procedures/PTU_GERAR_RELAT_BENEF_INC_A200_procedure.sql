-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE ptu_gerar_relat_benef_inc_a200 ( cd_unimed_p text, dt_periodo_p timestamp, ie_apresentar_inco_p text, nm_usuario_p text) AS $body$
DECLARE


nr_seq_retorno_benef_w		bigint;
nr_seq_benef_intercambio_w	bigint;
nr_seq_segurado_w		bigint;
cd_inconsistencia_w		bigint;
cd_usuario_plano_w		varchar(30);
cd_unimed_destino_w		varchar(10);
nr_seq_congenere_w		bigint;
nm_beneficiario_w		varchar(255);
nr_seq_lote_w			bigint;

C01 CURSOR FOR
	SELECT	b.nr_sequencia,
		b.NR_SEQ_BENEF_INTERCAMBIO,
		b.CD_USUARIO_PLANO,
		b.CD_INCONSISTENCIA,
		c.CD_UNIMED_DESTINO,
		c.nr_seq_lote_envio
	from	ptu_retorno_mov_benef		b,
		ptu_retorno_movimentacao	a,
		ptu_intercambio			c
	where	b.NR_SEQ_RETORNO_MOV		= a.nr_sequencia
	and	a.NR_SEQ_INTERCAMBIO		= c.nr_sequencia
	and	a.IE_OPERACAO			= 'R'
	and	dt_periodo_p between c.dt_mov_inicio and c.dt_mov_fim
	and	(((c.cd_unimed_destino)::numeric 	= (cd_unimed_p)::numeric ) or (coalesce(cd_unimed_p::text, '') = ''))
	and	((ie_apresentar_inco_p		= 'S' and b.CD_INCONSISTENCIA not in (3201,3202,3203)) or (ie_apresentar_inco_p = 'N'));



BEGIN

delete	FROM w_pls_relat_inconsist_a200
where	nm_usuario	= nm_usuario_p;

open C01;
loop
fetch C01 into
	nr_seq_retorno_benef_w,
	NR_SEQ_BENEF_INTERCAMBIO_w,
	CD_USUARIO_PLANO_w,
	CD_INCONSISTENCIA_w,
	CD_UNIMED_DESTINO_w,
	nr_seq_lote_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin

	if (NR_SEQ_BENEF_INTERCAMBIO_w IS NOT NULL AND NR_SEQ_BENEF_INTERCAMBIO_w::text <> '') then
		select	nr_seq_segurado,
			NM_BENEFICIARIO
		into STRICT	nr_seq_segurado_w,
			nm_beneficiario_w
		from	PTU_INTERCAMBIO_BENEF
		where	nr_sequencia	= NR_SEQ_BENEF_INTERCAMBIO_w;
	end if;

	select	max(nr_sequencia)
	into STRICT	nr_seq_congenere_w
	from	pls_congenere
	where	(cd_cooperativa)::numeric 	= (CD_UNIMED_DESTINO_w)::numeric;

	insert into w_pls_relat_inconsist_a200(	nr_sequencia,dt_atualizacao,nm_usuario,dt_atualizacao_nrec,nm_usuario_nrec,
			cd_usuario_plano,cd_inconsistencia,nr_seq_segurado,nr_seq_congenere,NR_SEQ_LOTE,
			NM_BENEFICIARIO)
	values (	nextval('w_pls_relat_inconsist_a200_seq'),clock_timestamp(),nm_usuario_p,clock_timestamp(),nm_usuario_p,
			cd_usuario_plano_w,cd_inconsistencia_w,nr_seq_segurado_w,nr_seq_congenere_w,nr_seq_lote_w,
			nm_beneficiario_w);

	end;
end loop;
close C01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ptu_gerar_relat_benef_inc_a200 ( cd_unimed_p text, dt_periodo_p timestamp, ie_apresentar_inco_p text, nm_usuario_p text) FROM PUBLIC;

