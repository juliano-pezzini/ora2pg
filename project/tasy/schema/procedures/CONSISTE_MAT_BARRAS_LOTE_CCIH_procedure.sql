-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE consiste_mat_barras_lote_ccih ( nr_prescricao_p bigint, cd_material_p bigint, nr_seq_material_p bigint, nm_usuario_p text, ds_erro_p INOUT text, nr_seq_lote_p bigint default null) AS $body$
DECLARE


ie_medic_lib_repr_w	varchar(1);
qt_dias_liberado_w		smallint;
qt_dias_solicitado_w	smallint;
ds_erro_w		varchar(255);
nr_dia_util_w		bigint;
ie_dia_uti_w		varchar(1);
cd_estabelecimento_w	bigint;
cd_funcao_origem_w		prescr_medica.cd_funcao_origem%type;
nr_prescricao_w         prescr_medica.nr_prescricao%type;
ie_dias_util_medic_w material.ie_dias_util_medic%type;


BEGIN

select 	cd_estabelecimento
into STRICT	cd_estabelecimento_w
from 	prescr_medica
where 	nr_prescricao = nr_prescricao_p;

if (obter_funcao_ativa = 7029) then
	ie_dia_uti_w := obter_param_usuario(7029, 53, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_dia_uti_w);
else
	ie_dia_uti_w := obter_param_usuario(-1113, 60, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_dia_uti_w);
end if;

if (nr_seq_material_p > 0) then
	begin
	
	select coalesce(max(m.ie_dias_util_medic),'N')
    into STRICT ie_dias_util_medic_w
    from prescr_material p,
         material m
   where p.nr_prescricao = nr_prescricao_p
     and p.nr_sequencia = nr_seq_material_p
     and m.cd_material = p.cd_material;
	
  if (ie_dias_util_medic_w <> 'N') then
	
	--Apenas para lotes agrupados
	nr_prescricao_w := nr_prescricao_p;
	
	if (nr_seq_lote_p IS NOT NULL AND nr_seq_lote_p::text <> '') then
		select	coalesce(max(nr_prescricao), nr_prescricao_p)
		into STRICT	nr_prescricao_w
		from	ap_lote
		where	nr_sequencia = nr_seq_lote_p;
	end if;
	
	select	max(nr_dia_util),
			max(qt_dias_liberado),
			max(qt_dias_solicitado)
	into STRICT	nr_dia_util_w,
			qt_dias_liberado_w,
			qt_dias_solicitado_w	
	from   	prescr_material
	where  	nr_prescricao = nr_prescricao_w
	and		nr_sequencia = nr_seq_material_p;

	select	max(cd_funcao_origem)
	into STRICT	cd_funcao_origem_w
	from	prescr_medica
	where	nr_prescricao = nr_prescricao_w;WITH RECURSIVE cte AS (


	if (cd_funcao_origem_w = 950) then
		select min(p.nr_prescricao)
          into STRICT nr_prescricao_w
        from prescr_medica p,
             prescr_material m WHERE (p.nr_prescricao, m.cd_material)in (SELECT x.nr_prescricao, x.cd_material from prescr_material x where x.nr_prescricao = nr_prescricao_p and x.nr_sequencia = nr_seq_material_p)
  UNION ALL


	if (cd_funcao_origem_w = 950) then
		select min(p.nr_prescricao)
          into STRICT nr_prescricao_w
        from prescr_medica p,
             prescr_material m JOIN cte c ON (c.nr_prescricao and prior m.cd_material =
        prior p.nr_prescricao_anterior)

) SELECT * FROM cte WHERE nr_prescricao = nr_prescricao;
;

		select	max(qt_dias_liberado),
				max(qt_dias_solicitado)
		into STRICT 	qt_dias_liberado_w,
				qt_dias_solicitado_w	
		from 	prescr_material
		where 	nr_prescricao = nr_prescricao_w
		and		nr_sequencia = nr_seq_material_p;
		
	end if;

	if	((coalesce(qt_dias_liberado_w::text, '') = '') and (qt_dias_solicitado_w IS NOT NULL AND qt_dias_solicitado_w::text <> '')) and
		((nr_dia_util_w <> 1 AND ie_dia_uti_w = 'S') or
		((nr_dia_util_w <> 1) and (coalesce(nr_dia_util_w,0) <> 0) and (ie_dia_uti_w = 'N')) or
		(nr_dia_util_w = 1 AND ie_dia_uti_w = 'S'))	then
		ds_erro_w := WHEB_MENSAGEM_PCK.get_texto(280530);
	elsif (qt_dias_liberado_w = 0) then
		ds_erro_w := WHEB_MENSAGEM_PCK.get_texto(280531);
	end if;
	end if;
	end;
end if;

ds_erro_p:= ds_erro_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE consiste_mat_barras_lote_ccih ( nr_prescricao_p bigint, cd_material_p bigint, nr_seq_material_p bigint, nm_usuario_p text, ds_erro_p INOUT text, nr_seq_lote_p bigint default null) FROM PUBLIC;

