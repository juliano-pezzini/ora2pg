-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_agenda_cons_agepac (nr_seq_agepac_p bigint, nr_seq_agecons_p bigint, nm_usuario_p text) AS $body$
DECLARE




cd_pessoa_fisica_w		varchar(10);
cd_convenio_w			bigint;
cd_usuario_convenio_w		varchar(30);
ds_senha_w			varchar(20);
dt_agenda_w			timestamp;
hr_inicio_w			timestamp;
dt_validade_carteira_w		timestamp;
ie_copia_data_w			varchar(01);
cd_agenda_consulta_w		bigint;
dt_agenda_cons_w		timestamp;
cd_categoria_w			varchar(10);
cd_tipo_acomodacao_w		smallint;
nr_doc_convenio_w		varchar(20);
ds_observacao_w			varchar(2000);


BEGIN

ie_copia_data_w := obter_param_usuario(898, 30, obter_perfil_ativo, nm_usuario_p, 0, ie_copia_data_w);


select	cd_agenda
into STRICT	cd_agenda_consulta_w
from	agenda_consulta
where	nr_sequencia	= nr_seq_agecons_p;

select	cd_pessoa_fisica,
	cd_convenio,
	cd_usuario_convenio,
	ds_senha,
	dt_agenda,
	hr_inicio,
	cd_categoria,
	cd_tipo_acomodacao,
	nr_doc_convenio,
	dt_validade_carteira,
	substr(ds_observacao,1,2000)
into STRICT	cd_pessoa_fisica_w,
	cd_convenio_w,
	cd_usuario_convenio_w,
	ds_senha_w,
	dt_agenda_w,
	hr_inicio_w,
	cd_categoria_w,
	cd_tipo_acomodacao_w,
	nr_doc_convenio_w,
	dt_validade_carteira_w,
	ds_observacao_w
from	agenda_paciente
where	nr_sequencia	= nr_seq_agepac_p;


if (cd_pessoa_fisica_w IS NOT NULL AND cd_pessoa_fisica_w::text <> '') then
	begin

	dt_agenda_cons_w	:= null;

	if (ie_copia_data_w = 'S') then
		begin

		delete	from agenda_consulta
		where	dt_agenda		= to_date(to_char(dt_agenda_w, 'dd/mm/yyyy') || ' ' || to_char(hr_inicio_w, 'hh24:mi:ss'), 'dd/mm/yyyy hh24:mi:ss')
		and	cd_agenda		= cd_agenda_consulta_w
		and	ie_status_agenda	= 'L';

		select	max(dt_agenda) + 1/86400
		into STRICT	dt_agenda_cons_w
		from	agenda_consulta
		where	cd_agenda		= cd_agenda_consulta_w
		and	ie_status_agenda	<> 'L'
		and	to_char(dt_agenda, 'dd/mm/yyyy hh24:mi') = to_char(dt_agenda_w, 'dd/mm/yyyy') || ' ' || to_char(hr_inicio_w, 'hh24:mi' );

		end;
	end if;

	update	agenda_consulta
	set	cd_pessoa_fisica	= cd_pessoa_fisica_w,
		cd_convenio		= cd_convenio_w,
		cd_categoria		= cd_categoria_w,
		cd_tipo_acomodacao	= cd_tipo_acomodacao_w,
		cd_usuario_convenio	= cd_usuario_convenio_w,
		nr_doc_convenio		= nr_doc_convenio_w,
		dt_validade_carteira	= dt_validade_carteira_w,
		cd_senha		= ds_senha_w,
		ie_status_agenda	= 'N',
		nr_seq_agepaci		= nr_seq_agepac_p,
		ds_observacao		= ds_observacao_w,
		dt_agenda		= CASE WHEN dt_agenda_cons_w = NULL THEN  CASE WHEN ie_copia_data_w='S' THEN 			to_date(to_char(dt_agenda_w, 'dd/mm/yyyy') || ' ' || to_char(hr_inicio_w, 'hh24:mi:ss'), 'dd/mm/yyyy hh24:mi:ss')  ELSE dt_agenda END   ELSE dt_agenda_cons_w END
	where	nr_sequencia		= nr_seq_agecons_p;


	end;
end if;


commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_agenda_cons_agepac (nr_seq_agepac_p bigint, nr_seq_agecons_p bigint, nm_usuario_p text) FROM PUBLIC;

