-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_w_relat_compo_bancaria ( dt_inicial_p timestamp, dt_final_p timestamp, cd_conta_financeira_p text, nr_titulos_pagar_p text, nr_titulos_receber_p text, nm_usuario_p text) AS $body$
DECLARE

  NR_CURRENT_SEQUENCE_W   bigint;
  CD_CONTA_FINANC_W       bigint;
  DS_CONTA_FINANC_W       varchar(60);
  DS_CONTA_W              varchar(255);
  VL_TOTAL_W              double precision;
  ROW_NUM_C01_W             bigint := 0;
  ROW_NUM_C02_W             bigint := 0;

  C01 CURSOR FOR
  SELECT CD_CONTA_FINANC, DS_CONTA_FINANC, sum(vl_total) vl_total from (
    SELECT c.CD_CONTA_FINANC, c.DS_CONTA_FINANC, (sum(a.vl_baixa)*-1) vl_total
    from TITULO_PAGAR_BAIXA a, TITULO_PAGAR_CLASSIF b, conta_financeira c, banco_estabelecimento_v d
    where a.nr_titulo = b.nr_titulo
    and b.NR_SEQ_CONTA_FINANC = c.cd_conta_financ  
    and ((obter_se_contido(c.cd_conta_financ, cd_conta_financeira_p) = 'S') or coalesce(cd_conta_financeira_p::text, '') = '')    
    and a.NR_SEQ_CONTA_BANCO = d.nr_sequencia
    and a.dt_baixa between dt_inicial_p and fim_dia(dt_final_p)  
    and ((obter_se_contido(a.nr_titulo, nr_titulos_pagar_p) = 'S') or coalesce(nr_titulos_pagar_p::text, '') = '')    
    group by c.CD_CONTA_FINANC, c.DS_CONTA_FINANC
    
union all
 
    select c.CD_CONTA_FINANC, c.DS_CONTA_FINANC, sum(a.VL_RECEBIDO) vl_total
    from TITULO_RECEBER_LIQ a, TITULO_RECEBER_CLASSIF b, conta_financeira c, banco_estabelecimento_v d
    where a.nr_titulo = b.nr_titulo
    and b.CD_CONTA_FINANC = c.cd_conta_financ
    and ((obter_se_contido(c.cd_conta_financ, cd_conta_financeira_p) = 'S') or coalesce(cd_conta_financeira_p::text, '') = '')
    and a.NR_SEQ_CONTA_BANCO = d.nr_sequencia
    and a.DT_RECEBIMENTO between dt_inicial_p and fim_dia(dt_final_p) 
    and ((obter_se_contido(a.nr_titulo, nr_titulos_receber_p) = 'S') or coalesce(nr_titulos_receber_p::text, '') = '')      
    group by c.CD_CONTA_FINANC, c.DS_CONTA_FINANC
  ) alias22
  group by CD_CONTA_FINANC, DS_CONTA_FINANC
  order by CD_CONTA_FINANC;

  C02 CURSOR FOR
  SELECT DS_CONTA_FINANC, DS_CONTA, sum(vl_total) VL_TOTAL from (
    SELECT c.DS_CONTA_FINANC, d.ds_conta, (sum(a.vl_baixa)*-1) vl_total
    from TITULO_PAGAR_BAIXA a, TITULO_PAGAR_CLASSIF b, conta_financeira c, banco_estabelecimento_v d
    where a.nr_titulo = b.nr_titulo
    and b.NR_SEQ_CONTA_FINANC = c.cd_conta_financ
    and c.CD_CONTA_FINANC = CD_CONTA_FINANC_W
    and a.NR_SEQ_CONTA_BANCO = d.nr_sequencia
    and a.dt_baixa between dt_inicial_p and fim_dia(dt_final_p)
    and ((obter_se_contido(a.nr_titulo, nr_titulos_pagar_p) = 'S') or coalesce(nr_titulos_pagar_p::text, '') = '')      
    group by c.DS_CONTA_FINANC, d.ds_conta
    
union all
 
    select c.DS_CONTA_FINANC, d.ds_conta, sum(a.VL_RECEBIDO) vl_total
    from TITULO_RECEBER_LIQ a, TITULO_RECEBER_CLASSIF b, conta_financeira c, banco_estabelecimento_v d
    where a.nr_titulo = b.nr_titulo
    and b.CD_CONTA_FINANC = c.cd_conta_financ
    and c.CD_CONTA_FINANC = CD_CONTA_FINANC_W
    and a.NR_SEQ_CONTA_BANCO = d.nr_sequencia
    and a.DT_RECEBIMENTO between dt_inicial_p and fim_dia(dt_final_p)
    and ((obter_se_contido(a.nr_titulo, nr_titulos_receber_p) = 'S') or coalesce(nr_titulos_receber_p::text, '') = '')      
    group by c.DS_CONTA_FINANC, d.ds_conta
  ) alias14
  group by DS_CONTA_FINANC, ds_conta
  order by DS_CONTA_FINANC, DS_CONTA;


BEGIN        
    DELETE FROM W_REL_COMPO_BANCARIA WHERE nm_usuario = nm_usuario_p;
  OPEN C01;
  LOOP
    FETCH C01 INTO
      CD_CONTA_FINANC_W,
      DS_CONTA_FINANC_W,
      VL_TOTAL_W;
    EXIT WHEN NOT FOUND; /* apply on C01 */
    BEGIN

      ROW_NUM_C01_W := ROW_NUM_C01_W+1;

      select nextval('w_rel_compo_bancaria_seq')
      into STRICT NR_CURRENT_SEQUENCE_W 
;

      INSERT
      INTO W_REL_COMPO_BANCARIA(
        NR_SEQUENCIA,
        DT_ATUALIZACAO,
        DT_ATUALIZACAO_NREC,        
        CD_CONTA_FINANC,
        DS_CONTA_FINANC,
        VL_TOTAL,
        NM_USUARIO,
        NM_USUARIO_NREC,
        NR_LINHA_1
      )
      VALUES (
        NR_CURRENT_SEQUENCE_W,
        clock_timestamp(),
        clock_timestamp(),
        CD_CONTA_FINANC_W,
        DS_CONTA_FINANC_W,
        VL_TOTAL_W,
        NM_USUARIO_P,
        NM_USUARIO_P,
        ROW_NUM_C01_W
      );
      BEGIN
        OPEN C02;
        LOOP
          FETCH C02
          INTO
            DS_CONTA_FINANC_W,
            DS_CONTA_W,
            VL_TOTAL_W;
          EXIT WHEN NOT FOUND; /* apply on C02 */
          BEGIN

            ROW_NUM_C02_W := ROW_NUM_C02_W+1;

            select nextval('w_rel_compo_bancaria_seq') 
            into STRICT NR_CURRENT_SEQUENCE_W 
;

            INSERT
            INTO W_REL_COMPO_BANCARIA(
              NR_SEQUENCIA,
              DT_ATUALIZACAO,
              DT_ATUALIZACAO_NREC, 
              CD_CONTA_FINANC,
              DS_CONTA_FINANC,
              DS_CONTA,
              VL_TOTAL,
              NM_USUARIO,
              NM_USUARIO_NREC,
              NR_LINHA_2
            )
            VALUES (
              NR_CURRENT_SEQUENCE_W,
              clock_timestamp(),
              clock_timestamp(),
              CD_CONTA_FINANC_W,
              DS_CONTA_FINANC_W,
              DS_CONTA_W,
              VL_TOTAL_W,
              NM_USUARIO_P,
              NM_USUARIO_P,
              ROW_NUM_C02_W
            );
          END;
        END LOOP;
        CLOSE C02;
      END;
    END;
  END LOOP;
  CLOSE C01;
  COMMIT;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_w_relat_compo_bancaria ( dt_inicial_p timestamp, dt_final_p timestamp, cd_conta_financeira_p text, nr_titulos_pagar_p text, nr_titulos_receber_p text, nm_usuario_p text) FROM PUBLIC;

