-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE inserir_item_prot_pre_rep ( nr_atendimento_p bigint, nm_usuario_p text, cd_medico_p bigint, dt_prescricao_p timestamp, nr_horas_validade_p text, dt_primeiro_horario_p text, cd_protocolo_p bigint, nr_sequencia_p bigint, qt_peso_p bigint, nr_seq_pend_pac_acao_p bigint, ds_observacao_p text, nm_computador_p text, cd_pessoa_fisica_p text, nr_prescricao_p INOUT bigint) AS $body$
DECLARE

 
nr_prescricao_w				prescr_medica.nr_prescricao%type;
cd_pessoa_paciente_w 		pessoa_fisica.cd_pessoa_fisica%type;
nr_atendimento_ww 			atendimento_paciente.nr_atendimento%type;
cd_estabelecimento_w 		estabelecimento.cd_estabelecimento%type;
cd_estab_w					estabelecimento.cd_estabelecimento%type;
dt_primeiro_horario_w 		prescr_medica.dt_primeiro_horario%type;
ie_origem_inf_w 			prescr_medica.ie_origem_inf%type;
cd_setor_w2					setor_atendimento.cd_setor_atendimento%type;
ie_recem_nato_w 			prescr_medica.ie_recem_nato%type;
cd_pessoa_fisica_w 			pessoa_fisica.cd_pessoa_fisica%type;
qt_altura_cm_w 				pessoa_fisica.qt_altura_cm%type;
qt_peso_w 					pessoa_fisica.qt_peso%type;
ie_rep_alta_w 				prescr_medica.ie_prescricao_alta%type;
ie_hemodialise_w 			prescr_medica.ie_hemodialise%type;
ds_observacao_w 			prescr_medica.ds_observacao%type;
ie_motivo_prescricao_w 		prescr_medica.ie_motivo_prescricao%type;
nr_atendimento_mae_w 		atendimento_paciente.nr_atendimento_mae%type;
cd_setor_mae_w 				setor_atendimento.cd_setor_atendimento%type;
cd_setor_rn_w 				setor_atendimento.cd_setor_atendimento%type;
cd_setor_usuario_w 			setor_atendimento.cd_setor_atendimento%type;
ie_tipo_atendimento_w		atendimento_paciente.ie_tipo_atendimento%type;
nr_seq_proc_w				prescr_procedimento.nr_sequencia%type;
nr_agrupamento_proc_w		prescr_procedimento.nr_agrupamento%type;
nr_seq_proc_novo_w			protocolo_medic_proc.nr_seq_proc%type;
nr_seq_proc_prot_w			protocolo_medic_proc.nr_seq_proc%type;
cd_procedimento_w			protocolo_medic_proc.cd_procedimento%type;
cd_prescritor_w				prescr_medica.cd_prescritor%type;
qt_procedimento_w			protocolo_medic_proc.qt_procedimento%type;
ie_origem_proced_w			protocolo_medic_proc.ie_origem_proced%type;
cd_intervalo_w				protocolo_medic_proc.cd_intervalo%type;
cd_setor_exclusivo_w		protocolo_medic_proc.cd_setor_atendimento%type;
cd_material_exame_w			protocolo_medic_proc.cd_material_exame%type;
nr_seq_exame_w				protocolo_medic_proc.nr_seq_exame%type;
ie_se_necessario_w			protocolo_medic_proc.ie_se_necessario%type;
ie_acm_proced_w				protocolo_medic_proc.ie_acm%type;
hr_prim_horario_proced_w	protocolo_medic_proc.hr_prim_horario%type;
ds_material_especial_w		protocolo_medic_proc.ds_material_especial%type;
ie_agora_w					protocolo_medic_proc.ie_urgencia%type;
nr_seq_proc_interno_w		protocolo_medic_proc.nr_seq_proc_interno%type;
ie_lado_w					protocolo_medic_proc.ie_lado%type;
ie_respiracao_w				protocolo_medic_proc.ie_respiracao%type;
cd_mod_vent_w				protocolo_medic_proc.cd_mod_vent%type;
ie_disp_resp_esp_w			protocolo_medic_proc.ie_disp_resp_esp%type;
qt_fluxo_oxigenio_w			protocolo_medic_proc.qt_fluxo_oxigenio%type;
qt_min_intervalo_w			protocolo_medic_proc.qt_min_intervalo%type;
nr_seq_prot_glic_w			protocolo_medic_proc.nr_seq_prot_glic%type;
ds_dado_clinico_w			protocolo_medic_proc.ds_dado_clinico%type;
ie_objetivo_onco_w			protocolo_medic_proc.ie_objetivo_onco%type;
ie_executar_leito_w			protocolo_medic_proc.ie_executar_leito%type;
nr_seq_contraste_w			protocolo_medic_proc.nr_seq_contraste%type;
ds_exame_fis_achado_cirur_w	protocolo_medic_proc.ds_exame_fis_achado_cirur%type;
ds_resumo_clinico_w			protocolo_medic_proc.ds_resumo_clinico%type;
cd_setor_entrega_w			protocolo_medic_proc.cd_setor_entrega%type;
cd_setor_coleta_w			protocolo_medic_proc.cd_setor_coleta%type;
ds_prescricao_w				protocolo_medic_proc.ds_prescricao%type;
ie_previsao_proced_w		protocolo_medic_proc.ie_horario%type;
cd_medico_exec_w			protocolo_medic_proc.cd_medico_exec%type;
ds_diag_provavel_ap_w		protocolo_medic_proc.ds_diag_provavel_ap%type;
ds_exame_anterior_ap_w		protocolo_medic_proc.ds_exame_anterior_ap%type;
ds_localizacao_lesao_w		protocolo_medic_proc.ds_localizacao_lesao%type;
ds_tempo_doenca_w			protocolo_medic_proc.ds_tempo_doenca%type;
cd_cgc_laboratorio_w		protocolo_medic_proc.cd_cgc_laboratorio%type;
qt_frasco_env_w				protocolo_medic_proc.qt_frasco_env%type;
nr_seq_proc_int_cirur_w		protocolo_medic_proc.nr_seq_proc_int_cirur%type;
qt_peca_ap_w				protocolo_medic_proc.qt_peca_ap%type;
nr_seq_amostra_princ_w		protocolo_medic_proc.nr_seq_amostra_princ%type;
ds_qualidade_peca_ap_w		protocolo_medic_proc.ds_qualidade_peca_ap%type;
ie_forma_exame_w			protocolo_medic_proc.ie_forma_exame%type;
cd_pessoa_coleta_w			protocolo_medic_proc.cd_pessoa_coleta%type;
ds_justificativa_w			protocolo_medic_proc.ds_justificativa%type;
cd_kit_material_w			protocolo_medic_proc.cd_kit_material%type;
ie_amostra_w				protocolo_medic_proc.ie_amostra%type;
cd_convenio_w				convenio.cd_convenio%type;
cd_proced_aux_w				procedimento.cd_procedimento%type;
ie_origem_aux_w				procedimento.ie_origem_proced%type;
ie_situacao_w				procedimento.ie_situacao%type;
ie_tipo_convenio_w			atendimento_paciente.ie_tipo_convenio%type;
cd_categoria_w				atend_categoria_convenio.cd_categoria%type;
cd_plano_convenio_w			atend_categoria_convenio.cd_plano_convenio%type;
nr_seq_solucao_novo_w		protocolo_medic_solucao.nr_seq_solucao%type;
nr_seq_solucao_prot_w		protocolo_medic_solucao.nr_seq_solucao%type;
ie_tipo_dosagem_w			protocolo_medic_solucao.ie_tipo_dosagem%type;
qt_dosagem_w				protocolo_medic_solucao.qt_dosagem%type;
qt_solucao_total_w			protocolo_medic_solucao.qt_solucao_total%type;
qt_tempo_aplicacao_w		protocolo_medic_solucao.qt_tempo_aplicacao%type;
qt_volume_w					protocolo_medic_solucao.qt_volume%type;
ie_bomba_infusao_w			protocolo_medic_solucao.ie_bomba_infusao%type;
ie_esquema_alternado_w		protocolo_medic_solucao.ie_esquema_alternado%type;
ie_calc_aut_w				protocolo_medic_solucao.ie_calc_aut%type;
ie_acm_sol_w				protocolo_medic_solucao.ie_acm%type;
qt_hora_fase_ww				protocolo_medic_solucao.qt_hora_fase%type;
qt_hora_fase_w				protocolo_medic_solucao.qt_hora_fase%type;
ds_solucao_w				protocolo_medic_solucao.ds_solucao%type;
ie_pos_dialisador_w			protocolo_medic_solucao.ie_pos_dialisador%type;
nr_seq_protocolo_w			protocolo_medic_solucao.nr_seq_protocolo%type;
ie_tipo_solucao_w			protocolo_medic_solucao.ie_tipo_solucao%type;
qt_temp_solucao_w			protocolo_medic_solucao.qt_temp_solucao%type;
ie_momento_w				protocolo_medic_solucao.ie_momento%type;
ie_unid_vel_inf_w			protocolo_medic_solucao.ie_unid_vel_inf%type;
ie_se_necessario_Sol_w		protocolo_medic_solucao.ie_se_necessario%type;
ie_solucao_pca_w			protocolo_medic_solucao.ie_solucao_pca%type;
ie_tipo_analgesia_w			protocolo_medic_solucao.ie_tipo_analgesia%type;
ie_pca_modo_prog_w			protocolo_medic_solucao.ie_pca_modo_prog%type;
qt_dose_inicial_pca_w		protocolo_medic_solucao.qt_dose_inicial_pca%type;
qt_vol_infusao_pca_w		protocolo_medic_solucao.qt_vol_infusao_pca%type;
qt_bolus_pca_w				protocolo_medic_solucao.qt_bolus_pca%type;
qt_intervalo_bloqueio_w		protocolo_medic_solucao.qt_intervalo_bloqueio%type;
qt_limite_quatro_hora_w		protocolo_medic_solucao.qt_limite_quatro_hora%type;
qt_dose_ataque_w			protocolo_medic_solucao.qt_dose_ataque%type;
ds_orientacao_w				protocolo_medic_solucao.ds_orientacao%type;
ie_tipo_sol_w				protocolo_medic_solucao.ie_tipo_sol%type;
qt_limite_uma_hora_w		protocolo_medic_solucao.qt_limite_uma_hora%type;
ie_urgencia_Prot_W			protocolo_medic_solucao.ie_urgencia%type;
hr_prim_hor_sol_w			protocolo_medic_solucao.hr_prim_horario%type;
ie_um_dose_inicio_pca_w		protocolo_medic_solucao.ie_um_dose_inicio_pca%type;
ie_um_limite_pca_w			protocolo_medic_solucao.ie_um_limite_pca%type;
ie_um_limite_hora_pca_w		protocolo_medic_solucao.ie_um_limite_hora_pca%type;
ie_um_fluxo_pca_w			protocolo_medic_solucao.ie_um_fluxo_pca%type;
ie_um_bolus_pca_w			protocolo_medic_solucao.ie_um_bolus_pca%type;
ie_via_aplicacao_w			protocolo_medic_solucao.ie_via_aplicacao%type;
cd_intervalo_ww				protocolo_medic_solucao.cd_intervalo%type;
ie_solucao_especial_w		protocolo_medic_solucao.ie_sol_especial%type;
nr_etapas_prot_w			protocolo_medic_solucao.nr_etapas%type;
nr_etapas_w					protocolo_medic_solucao.nr_etapas%type;
ie_aberta_w					protocolo_medic_solucao.ie_aberta%type;
qt_hora_infusao_w			protocolo_medic_solucao.qt_hora_infusao%type;
qt_tempo_infusao_w			protocolo_medic_solucao.qt_tempo_infusao%type;
nr_seq_solucao_w			prescr_solucao.nr_seq_solucao%type;
nr_agrupamento_sol_w		prescr_solucao.nr_agrupamento%type;
--nr_etapas_2w				protocolo_medic_solucao.nr_etapas%type; 
--ie_sol_intermitente_w		prescr_solucao.ie_sol_intermitente%type := 'N'; 
--ie_etapa_interv_w			varchar2(1); 
--VarParam805_w				varchar2(2); 
--varIe_Sol_prescr_w		varchar2(5); 
--ie_check_tipo_interv_w	varchar2(1); 
--ie_arredondar_etapas_w	varchar2(5); 
--ie_continuo_w				varchar2(1); 
--qt_volume_sol_w			number(15,4); 
ds_horarios_sol_w			varchar(2000);
ds_erro_w					varchar(4000);
ds_erro_ww					varchar(4000);
VarRegraPrimHorarioSol_w 	varchar(5);
VarVincularAtendPaciente_w 	varchar(2);
var_pac_usu_w 				varchar(2);
dt_prim_horario_proced_w 	timestamp;
ie_Gera_Setor_PrescrProc_w	varchar(1);
ie_precritor_aux_w 			varchar(1);
ie_gerar_setor_w			varchar(2);
ie_medico_prescr_w			varchar(5);
nr_seq_proc_interno_aux_w	bigint;
qt_setor_exibe_rn_w 		bigint;
ie_setor_mae_w 				varchar(1) := 'N';
ie_etapa_espec_sol_w		varchar(1);
ie_urgencia_w				varchar(1);
ie_perm_etapa_espec_w		varchar(1);
cd_setor_prescr_w 			integer := null;
qt_registro_w 				bigint;
ds_horarios_sol_2w			varchar(255);
ie_etapa_especial_w			varchar(1);
dt_prescricao_w				timestamp;

c01 CURSOR FOR 
SELECT	a.nr_seq_proc + nr_seq_proc_w, 
		a.nr_seq_proc, 
		a.cd_procedimento, 
		a.qt_procedimento, 
		a.ds_observacao, 
		a.ie_origem_proced, 
		a.cd_intervalo, 
		a.cd_setor_atendimento, 
		a.cd_material_exame, 
		a.nr_seq_exame, 
		coalesce(a.ie_se_necessario,'N'), 
		coalesce(a.ie_acm,'N'), 
		coalesce(a.hr_prim_horario, dt_primeiro_horario_p), 
		a.ds_material_especial, 
		a.ie_urgencia, 
		a.nr_seq_proc_interno, 
		a.ie_lado, 
		a.ie_respiracao, 
		a.cd_mod_vent, 
		a.ie_disp_resp_esp, 
		a.qt_fluxo_oxigenio, 
		coalesce(qt_min_intervalo,0), 
		a.nr_seq_prot_glic, 
		a.ds_dado_clinico, 
		ie_objetivo_onco, 
		coalesce(ie_executar_leito, 'N'), 
		nr_seq_contraste, 
		ds_exame_fis_achado_cirur, 
		a.ds_resumo_clinico, 
		a.cd_setor_entrega, 
		a.cd_setor_coleta, 
		SUBSTR(a.ds_prescricao,1,80), 
		a.ie_horario, 
		a.cd_medico_exec, 
		substr(a.ds_diag_provavel_ap,1,255), 
		substr(a.ds_exame_anterior_ap,1,255), 
		substr(a.ds_localizacao_lesao,1,2000), 
		substr(a.ds_tempo_doenca,1,255), 
		substr(a.cd_cgc_laboratorio,1,14), 
		a.qt_frasco_env, 
		a.nr_seq_proc_int_cirur, 
		a.qt_peca_ap, 
		a.nr_seq_amostra_princ, 
		a.ds_qualidade_peca_ap, 
		a.ie_forma_exame, 
		a.cd_pessoa_coleta, 
		a.ds_justificativa, 
		a.cd_kit_material, 
		a.ie_amostra 
FROM protocolo_medic_proc a
LEFT OUTER JOIN exame_laboratorio b ON (a.nr_seq_exame = b.nr_seq_exame)
WHERE ((b.ie_solicitacao = 'S') or (coalesce(a.nr_seq_exame::text, '') = '')) and coalesce(a.nr_seq_solic_bs::text, '') = '' and a.nr_sequencia		= nr_sequencia_p and a.cd_protocolo	 	= cd_protocolo_p order by a.nr_seq_apres;

C02 CURSOR FOR 
SELECT	nr_seq_solucao + nr_seq_solucao_w, 
		nr_seq_solucao, 
		coalesce(ie_tipo_dosagem,'gtm'), 
		qt_dosagem, 
		qt_solucao_total, 
		qt_tempo_aplicacao, 
		coalesce(qt_volume,0), 
		ie_bomba_infusao, 
		ie_esquema_alternado, 
		ie_calc_aut, 
		ie_acm, 
		qt_hora_fase, 
		coalesce(ds_solucao,DS_ROTINA), 
		ie_pos_dialisador, 
		coalesce(ie_hemodialise,'N'), 
		nr_seq_protocolo, 
		ie_tipo_solucao, 
		qt_temp_solucao, 
		ie_momento, 
		ie_unid_vel_inf, 
		ie_se_necessario, 
		ie_solucao_pca, 
		ie_tipo_analgesia, 
		ie_pca_modo_prog, 
		qt_dose_inicial_pca, 
		qt_vol_infusao_pca, 
		qt_bolus_pca, 
		qt_intervalo_bloqueio, 
		qt_limite_quatro_hora, 
		qt_dose_ataque, 
		ds_orientacao, 
		ie_tipo_sol, 
		qt_limite_uma_hora, 
		ie_urgencia, 
		hr_prim_horario, 
		ie_um_dose_inicio_pca, 
		ie_um_limite_pca, 
		ie_um_limite_hora_pca, 
		ie_um_fluxo_pca, 
		ie_um_bolus_pca, 
		ie_via_aplicacao, 
		cd_intervalo, 
		ie_sol_especial, 
		nr_etapas, 
		coalesce(ie_aberta,'N'), 
		coalesce(qt_hora_infusao,0), 
		coalesce(qt_tempo_infusao,0) 
from	protocolo_medic_solucao 
where	coalesce(ie_situacao,'A') = 'A' 
and		nr_sequencia	= nr_sequencia_p 
and		cd_protocolo	= cd_protocolo_p;


BEGIN 
 
if (nr_atendimento_p IS NOT NULL AND nr_atendimento_p::text <> '') then 
	select	cd_pessoa_fisica, 
			cd_estabelecimento 
	into STRICT	cd_pessoa_paciente_w, 
			cd_estabelecimento_w 
	from	atendimento_paciente 
	where	nr_atendimento	= nr_atendimento_p;	
else	 
	select	cd_estabelecimento 
	into STRICT	cd_estabelecimento_w 
	from	usuario 
	where	nm_usuario = nm_usuario_p;
	cd_pessoa_paciente_w	:= cd_pessoa_fisica_p;	
end if;
 
VarVincularAtendPaciente_w := obter_param_usuario(924, 729, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, VarVincularAtendPaciente_w);
ie_precritor_aux_w := obter_param_usuario(924, 580, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_precritor_aux_w);
VarRegraPrimHorarioSol_w := obter_param_usuario(924, 332, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, VarRegraPrimHorarioSol_w);
ie_perm_etapa_espec_w := obter_param_usuario(924, 583, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_perm_etapa_espec_w);
ie_medico_prescr_w := Obter_Param_Usuario(924, 998, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_medico_prescr_w);
ie_Gera_Setor_PrescrProc_w := Obter_Param_Usuario(924, 493, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_Gera_Setor_PrescrProc_w);
ie_etapa_espec_sol_w := Obter_Param_Usuario(924, 1138, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_etapa_espec_sol_w);
if (Obter_Funcao_Ativa	= 950) then 
	var_pac_usu_w := Obter_Param_Usuario(950, 6, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, var_pac_usu_w);
else 
	var_pac_usu_w := Obter_Param_Usuario(924, 42, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, var_pac_usu_w);
end if;
--Obter_Param_Usuario(924,322, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, varIe_Sol_prescr_w); 
--obter_param_usuario(924,805, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, VarParam805_w); 
--obter_param_usuario(924,742, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_arredondar_etapas_w); 
--obter_param_usuario(924,809, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_check_tipo_interv_w); 
--if (Obter_Funcao_Ativa = 950) then 
--	obter_param_usuario(950,42, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_etapa_interv_w); 
--else 
--	obter_param_usuario(924,590, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_etapa_interv_w); 
--end if;	 
 
nr_atendimento_ww := nr_atendimento_p;
 
select 	coalesce(max(nr_atendimento_mae),0) 
into STRICT	nr_atendimento_mae_w 
from	atendimento_paciente 
where 	nr_atendimento = nr_atendimento_p;
 
	if (nr_atendimento_mae_w > 0) then 
		select count(cd_setor_atendimento) 
		into STRICT 	qt_setor_exibe_rn_w 
		from 	setor_atendimento 
		where 	ie_rn_mae = 'S' 
		and 	cd_estabelecimento = cd_estabelecimento_w;
 
		if (qt_setor_exibe_rn_w > 0) then 
			if (var_pac_usu_w in ('A','P')) then 
				cd_setor_prescr_w := obter_unidade_atendimento(nr_atendimento_mae_w,'A','CS');
			elsif (var_pac_usu_w = 'D') then 
			begin 
			 select coalesce(ie_rn_mae,'N'), cd_setor_atendimento 
			 into STRICT 	ie_setor_mae_w, cd_setor_mae_w 
			 from 	setor_atendimento 
			 where cd_setor_atendimento = obter_unidade_atendimento(nr_atendimento_mae_w,'A','CS');
 
			 select coalesce(a.cd_setor_atendimento,0) 
			 into STRICT 	cd_setor_rn_w 
			 from 	unidade_atendimento a 
			 where	a.nr_seq_interno = (SELECT	coalesce(b.nr_seq_unidade_rn,0) 
										from 	setor_atendimento b 
										where 	b.cd_setor_atendimento = obter_unidade_atendimento(nr_atendimento_p,'A','CS'));
			 if (ie_setor_mae_w = 'S') and (cd_setor_mae_w = cd_setor_rn_w) then 
					cd_setor_prescr_w := cd_setor_mae_w;
			 else 
					cd_setor_prescr_w := coalesce(obter_unidade_atendimento(nr_atendimento_p,'A','CS'), 0);
			 end if;
			end;
			else 
				cd_setor_prescr_w := coalesce(obter_unidade_atendimento(nr_atendimento_p,'IA','CS'),obter_unidade_atendimento(nr_atendimento_p,'A','CS'));
			end if;
			 
			select coalesce(ie_rn_mae,'N') 
			into STRICT 	ie_setor_mae_w 
			from 	setor_atendimento		 
			where 	cd_setor_atendimento = cd_setor_prescr_w;
		end if;
	end if;
 
	if (ie_setor_mae_w = 'N') then 
 
		if (var_pac_usu_w = 'U') then 
			begin 
			select	obter_setor_usuario(nm_usuario_p) 
			into STRICT	cd_setor_usuario_w 
			;
 
			select	count(*)  
			into STRICT	qt_registro_w 
			from	setor_atendimento a  
			where	a.cd_setor_atendimento in (	SELECT	b.cd_setor_atendimento   
												from	atend_paciente_unidade b   
												where	b.nr_atendimento		= nr_atendimento_p 
												and		b.cd_setor_atendimento	= cd_setor_usuario_w);
			exception 
			when others then 
				qt_registro_w	:= 0;
			end;
		end if;
 
		if (var_pac_usu_w = 'C') then 
			select	max(cd_setor_atendimento) 
			into STRICT	cd_setor_prescr_w 
			from	computador 
			where	nm_computador_pesquisa = padronizar_nome(upper(nm_computador_p));
			 
			if (coalesce(cd_setor_prescr_w,0) = 0) then 
				Select	coalesce(obter_unidade_atendimento(nr_atendimento_p,'IA','CS'), obter_unidade_atendimento(nr_atendimento_p,'A','CS')) 
				into STRICT	cd_setor_prescr_w	 
				;
			end if;
		elsif (var_pac_usu_w = 'A') then 
				Select	coalesce(obter_unidade_atendimento(nr_atendimento_p,'A','CS'), obter_unidade_atendimento(nr_atendimento_p,'A','CS')) 
				into STRICT	cd_setor_prescr_w	 
				;
		elsif (var_pac_usu_w = 'U') and (nr_atendimento_p > 0) and (qt_registro_w > 0) then 
				cd_setor_prescr_w := cd_setor_usuario_w;	
		elsif (nr_atendimento_p > 0) then 
				Select	coalesce(obter_unidade_atendimento(nr_atendimento_p,'IA','CS'), obter_unidade_atendimento(nr_atendimento_p,'A','CS')) 
				into STRICT	cd_setor_prescr_w	 
				;
		end if;
		if (var_pac_usu_w = 'R') then 
			cd_setor_prescr_w	:= Obter_setor_prescr_regra(obter_perfil_ativo);
		end if;
	end if;
 
if (coalesce(nr_atendimento_p,0) = 0) then 
	if (VarVincularAtendPaciente_w = 'S') then 
		select	max(nr_atendimento) 
		into STRICT	nr_atendimento_ww 
		from	atendimento_paciente a 
		where	cd_pessoa_fisica = cd_pessoa_paciente_w 
		and		cd_estabelecimento = cd_estabelecimento_w 
		and		ie_tipo_atendimento = 1 
		and		coalesce(dt_alta::text, '') = '' 
		and		ie_fim_conta <> 'F';
	elsif (VarVincularAtendPaciente_w = 'T') then 
		select	max(nr_atendimento) 
		into STRICT	nr_atendimento_ww 
		from	atendimento_paciente a 
		where	cd_pessoa_fisica = cd_pessoa_paciente_w 
		and		cd_estabelecimento = cd_estabelecimento_w 
		and		coalesce(dt_alta::text, '') = '' 
		and		ie_fim_conta <> 'F';
	else 
		nr_atendimento_ww := null;
	end if;
end if;	
 
if (nr_atendimento_ww IS NOT NULL AND nr_atendimento_ww::text <> '') then 
	begin 
	select	cd_convenio 
	into STRICT	cd_convenio_w 
	from	atend_categoria_convenio 
	where	nr_atendimento 		= nr_atendimento_ww 
	and		dt_inicio_vigencia	= (	SELECT	max(dt_inicio_vigencia) 
									from	atend_categoria_convenio 
									where	nr_atendimento = nr_atendimento_ww);
	exception 
		when others then 
			cd_convenio_w := null;
 
	end;
	 
	select	max(coalesce(ie_tipo_atendimento,1)) 
	into STRICT	ie_tipo_atendimento_w 
	from	atendimento_paciente 
	where	nr_atendimento	= nr_atendimento_ww;
	 
end if;
 
if (nr_prescricao_p = 0) then 
 
	select	nextval('prescr_medica_seq') 
	into STRICT	nr_prescricao_w 
	;
	 
	select 	coalesce(max('1'),'3') 
	into STRICT	ie_origem_inf_w 
	from	Medico b, 
			Usuario a 
	where 	a.nm_usuario		= nm_usuario_p 
	and		a.cd_pessoa_fisica	= b.cd_pessoa_fisica;	
	 
	begin 
	dt_primeiro_horario_w	:= to_date(to_char(dt_prescricao_p,'dd/mm/yyyy ') || 
				substr(dt_primeiro_horario_p,1,5)||':'||to_char(dt_prescricao_p,'ss'),'dd/mm/yyyy hh24:mi:ss');
	exception 
		when others then 
			dt_primeiro_horario_w	:= clock_timestamp();
	end;
	 
	begin 
	select	cd_pessoa_fisica 
	into STRICT	cd_pessoa_fisica_w 
	from	usuario 
	where	nm_usuario	= nm_usuario_p;
	exception 
		when others then 
			cd_pessoa_fisica_w	:= null;
	end;
	 
	begin 
	select	obter_sinal_vital(nr_atendimento_p,obter_desc_expressao(283402)/*'Altura'*/
), 
			coalesce(qt_peso_p,obter_ultimo_sinal_vital_pf(cd_pessoa_fisica_w,'Peso')) 
	into STRICT	qt_altura_cm_w, 
			qt_peso_w 
	;
	exception 
		when others then 
			qt_altura_cm_w := null;
			qt_peso_w := null;
	end;	
	 
	select	coalesce(max(ie_recem_nato),'N'), 
			coalesce(max(ie_rep_alta),'N'), 
			max(ie_hemodialise), 
			max(ds_observacao), 
			max(ie_motivo_prescricao) 
	into STRICT	ie_recem_nato_w, 
			ie_rep_alta_w, 
			ie_hemodialise_w, 
			ds_observacao_w, 
			ie_motivo_prescricao_w 
	from	protocolo_medicacao 
	where	cd_protocolo	= cd_protocolo_p 
	and		nr_sequencia	= nr_sequencia_p;
 
	insert into prescr_medica( 
		nr_prescricao, 
		cd_pessoa_fisica, 
		nr_atendimento, 
		cd_medico, 
		dt_prescricao, 
		dt_atualizacao, 
		nm_usuario, 
		nr_horas_validade, 
		dt_primeiro_horario, 
		ie_origem_inf, 
		ie_recem_nato, 
		nm_usuario_original, 
		cd_protocolo, 
		nr_seq_protocolo, 
		cd_estabelecimento, 
		cd_prescritor, 
		qt_altura_cm, 
		qt_peso, 
		ie_adep, 
		ie_prescr_emergencia, 
		ie_prescricao_alta, 
		cd_setor_atendimento, 
		ie_hemodialise, 
		ie_prescritor_aux, 
		ds_observacao, 
		cd_funcao_origem, 
		ie_motivo_prescricao, 
		dt_liberacao_medico, 
		dt_liberacao) 
	values ( 
		nr_prescricao_w, 
		cd_pessoa_paciente_w, 
		nr_atendimento_ww, 
		cd_medico_p, 
		dt_prescricao_p, 
		clock_timestamp(), 
		nm_usuario_p, 
		24, 
		clock_timestamp(), -- dt_primeiro_horario_w, 
		ie_origem_inf_w, 
		ie_recem_nato_w, 
		nm_usuario_p, 
		cd_protocolo_p, 
		nr_sequencia_p, 
		cd_estabelecimento_w, 
		cd_pessoa_fisica_w, 
		qt_altura_cm_w, 
		qt_peso_w, 
		'N', 
		'N', 
		ie_rep_alta_w, 
		cd_setor_prescr_w, 
		'R', 
		ie_precritor_aux_w, 
		coalesce(ds_observacao_p,ds_observacao_w), 
		obter_funcao_ativa, 
		ie_motivo_prescricao_w, 
		null, 
		null);
		 
	-- inserção dos medicamentos 
 
	CALL inserir_mat_prescr_prot(				nr_prescricao_w,				-- nr_prescricao_p 
							cd_protocolo_p,					-- cd_protocolo_p 
							nr_sequencia_p,					-- nr_sequencia_p 
							0,								-- nr_seq_material_p 
							1,								-- ie_agrupador_p 
							0,								-- nr_seq_dieta_p 
							0,								-- nr_seq_proc_p 
							0,								-- nr_seq_solucao_p 
							null,							-- nr_seq_dieta_novo_p 
							null,							-- nr_seq_proc_novo_p 
							null,							-- nr_seq_solucao_novo_p 
							cd_intervalo_w,							-- cd_intervalo_p 
							1,								-- qt_protocolo_p 
							nm_usuario_p,					-- nm_usuario_p 
							'N',							-- ie_urgencia_p 
							coalesce(qt_peso_p,0),				-- qt_peso_p 
							dt_primeiro_horario_p,			-- hr_prim_horario_p 
							0,								-- qt_dose_p 
							0,								-- nr_seq_atendimento_p 
							null,							-- ds_justificativa_p 
							null,							-- cd_unidade_medida_p 
							null,							-- ie_gerar_composto_p 
							null,							-- ie_objetivo_p 
							null,							-- qt_dias_solicitado_p 
							null, 							-- ie_indicacao_p 
							null,							-- cd_doenca_cid_p 
							null,							-- ie_via_aplicacao_p 
							null,							-- cd_topografia_cih_p 
							null,							-- ds_recomendacao_p 
							null,							-- ie_sem_dia_inf_p 
							null,							-- ie_se_necessario_p 
							null,							-- ie_acm_p 
							'S',							-- ie_reordenar_medic_p 
							null,							-- cd_microorganismo_cih_p 
							null,							-- cd_amostra_cih_p 
							null,							-- ie_origem_infeccao_p 
							null, 							-- ie_aplic_bolus_p 
							null,							-- ie_dose_espec_agora_p 
							null,							-- qt_dose_especial_p 
							null, 							-- cd_unidade_medida_dose_edit_p 
							null,							-- hr_dose_especial_p 
							null,							-- qt_min_aplic_dose_esp_p 
							null,							-- ds_dose_diferenciada_p default null 
							'S',							-- ie_protocolo_pre_rep_p 
							null);							-- ds_medic_nao_padrao_p 
							 
	-- inserção dos materiais 
	CALL inserir_mat_prescr_prot(nr_prescricao_w,				-- nr_prescricao_p 
							cd_protocolo_p,					-- cd_protocolo_p 
							nr_sequencia_p,					-- nr_sequencia_p 
							0,								-- nr_seq_material_p 
							2,								-- ie_agrupador_p 
							0,								-- nr_seq_dieta_p 
							0,								-- nr_seq_proc_p 
							0,								-- nr_seq_solucao_p 
							null,							-- nr_seq_dieta_novo_p 
							null,							-- nr_seq_proc_novo_p 
							null,							-- nr_seq_solucao_novo_p 
							null,							-- cd_intervalo_p 
							1,								-- qt_protocolo_p 
							nm_usuario_p,					-- nm_usuario_p 
							'N',							-- ie_urgencia_p 
							coalesce(qt_peso_p,0),				-- qt_peso_p 
							dt_primeiro_horario_p,			-- hr_prim_horario_p 
							0,								-- qt_dose_p 
							0,								-- nr_seq_atendimento_p 
							null,							-- ds_justificativa_p 
							null,							-- cd_unidade_medida_p 
							null,							-- ie_gerar_composto_p 
							null,							-- ie_objetivo_p 
							null,							-- qt_dias_solicitado_p 
							null, 							-- ie_indicacao_p 
							null,							-- cd_doenca_cid_p 
							null,							-- ie_via_aplicacao_p 
							null,							-- cd_topografia_cih_p 
							null,							-- ds_recomendacao_p 
							null,							-- ie_sem_dia_inf_p 
							null,							-- ie_se_necessario_p 
							null,							-- ie_acm_p 
							'S',							-- ie_reordenar_medic_p 
							null,							-- cd_microorganismo_cih_p 
							null,							-- cd_amostra_cih_p 
							null,							-- ie_origem_infeccao_p 
							null, 							-- ie_aplic_bolus_p 
							null,							-- ie_dose_espec_agora_p 
							null,							-- qt_dose_especial_p 
							null, 							-- cd_unidade_medida_dose_edit_p 
							null,							-- hr_dose_especial_p 
							null,							-- qt_min_aplic_dose_esp_p 
							null,							-- ds_dose_diferenciada_p default null 
							'S',							-- ie_protocolo_pre_rep_p 
							null);							-- ds_medic_nao_padrao_p 
							
	select	coalesce(max(nr_sequencia),0), 
			coalesce(max(nr_agrupamento),0) 
	into STRICT	nr_seq_proc_w, 
			nr_agrupamento_proc_w 
	from	prescr_procedimento 
	where	nr_prescricao = nr_prescricao_w;
 
	-- inserção dos procedimentos 
	open C01;
	loop 
	fetch C01 into 
		nr_seq_proc_novo_w, 
		nr_seq_proc_prot_w, 
		cd_procedimento_w, 
		qt_procedimento_w, 
		ds_observacao_w, 
		ie_origem_proced_w, 
		cd_intervalo_w, 
		cd_setor_exclusivo_w, 
		cd_material_exame_w, 
		nr_seq_exame_w, 
		ie_se_necessario_w, 
		ie_acm_proced_w, 
		hr_prim_horario_proced_w, 
		ds_material_especial_w, 
		ie_agora_w, 
		nr_seq_proc_interno_w, 
		ie_lado_w, 
		ie_respiracao_w, 
		cd_mod_vent_w, 
		ie_disp_resp_esp_w, 
		qt_fluxo_oxigenio_w, 
		qt_min_intervalo_w, 
		nr_seq_prot_glic_w, 
		ds_dado_clinico_w, 
		ie_objetivo_onco_w, 
		ie_executar_leito_w, 
		nr_seq_contraste_w, 
		ds_exame_fis_achado_cirur_w, 
		ds_resumo_clinico_w, 
		cd_setor_entrega_w, 
		cd_setor_coleta_w, 
		ds_prescricao_w, 
		ie_previsao_proced_w, 
		cd_medico_exec_w, 
		ds_diag_provavel_ap_w, 
		ds_exame_anterior_ap_w, 
		ds_localizacao_lesao_w, 
		ds_tempo_doenca_w, 
		cd_cgc_laboratorio_w, 
		qt_frasco_env_w, 
		nr_seq_proc_int_cirur_w, 
		qt_peca_ap_w, 
		nr_seq_amostra_princ_w, 
		ds_qualidade_peca_ap_w, 
		ie_forma_exame_w, 
		cd_pessoa_coleta_w, 
		ds_justificativa_w, 
		cd_kit_material_w, 
		ie_amostra_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		 
		if (nr_seq_proc_interno_w IS NOT NULL AND nr_seq_proc_interno_w::text <> '') then 
			SELECT * FROM Obter_Proc_Tab_Interno(nr_seq_proc_interno_w, nr_prescricao_w, 0, 0, cd_procedimento_w, ie_origem_proced_w, NULL, null) INTO STRICT cd_procedimento_w, ie_origem_proced_w;
		end if;
 
		if (nr_seq_exame_w IS NOT NULL AND nr_seq_exame_w::text <> '') then 
			begin 
			select	distinct 
					cd_procedimento, 
					ie_origem_proced 
			into STRICT	cd_proced_aux_w, 
					ie_origem_aux_w 
			from	exame_lab_convenio 
			where	nr_seq_exame	= nr_seq_exame_w 
			and		cd_convenio	= cd_convenio_w;
			exception 
				when others then 
					cd_proced_aux_w	:= null;
					ie_origem_aux_w	:= null;
			end;
 
			cd_procedimento_w	:= coalesce(cd_proced_aux_w,cd_procedimento_w);
			ie_origem_proced_w	:= coalesce(ie_origem_aux_w,ie_origem_proced_w);
		end if;
 
		select	coalesce(max(ie_situacao),'A') 
		into STRICT	ie_situacao_w 
		from	procedimento 
		where	cd_procedimento		= cd_procedimento_w 
		and		ie_origem_proced	= ie_origem_proced_w;
 
		if (ie_situacao_w = 'A') then 
 
			if (coalesce(cd_procedimento_w::text, '') = '') and (coalesce(nr_atendimento_ww,0) > 0) then 
				select	a.ie_tipo_convenio, 
						b.cd_convenio, 
						b.cd_categoria, 
						a.cd_estabelecimento, 
						b.cd_plano_convenio 
				into STRICT	ie_tipo_convenio_w, 
						cd_convenio_w, 
						cd_categoria_w, 
						cd_estab_w, 
						cd_plano_convenio_w 
				from	atend_categoria_convenio b, 
						atendimento_paciente a 
				where	a.nr_atendimento	= nr_atendimento_ww 
				and		b.nr_atendimento	= a.nr_atendimento 
				and		b.nr_seq_interno	= obter_atecaco_atendimento(a.nr_atendimento);
 
				SELECT * FROM obter_exame_lab_convenio(	nr_seq_exame_w, cd_convenio_w, cd_categoria_w, ie_tipo_atendimento_w, cd_estab_w, ie_tipo_convenio_w, nr_seq_proc_interno_w, cd_material_exame_w, cd_plano_convenio_w, cd_setor_w2, cd_procedimento_w, ie_origem_proced_w, ds_erro_w, nr_seq_proc_interno_aux_w) INTO STRICT cd_setor_w2, cd_procedimento_w, ie_origem_proced_w, ds_erro_w, nr_seq_proc_interno_aux_w;
 
			end if;
 
			begin 
			select	coalesce(cd_setor_exclusivo,cd_setor_exclusivo_w) 
			into STRICT	cd_setor_exclusivo_w 
			from	procedimento 
			where	cd_procedimento		= cd_procedimento_w 
			and	ie_origem_proced		= ie_origem_proced_w;
			exception 
				when others then 
					cd_setor_exclusivo_w := cd_setor_exclusivo_w;
			end;
 
			ie_gerar_setor_w := obter_se_gerar_setor_rotina(cd_estabelecimento_w, 
															924, 
															cd_procedimento_w, 
															ie_origem_proced_w, 
															nr_seq_proc_interno_w, 
															nr_seq_exame_w, 
															cd_setor_prescr_w, 
															nm_usuario_p);
 
			if (coalesce(cd_setor_exclusivo_w::text, '') = '') and (ie_gerar_setor_w = 'S') then 
				 
				select	obter_setor_atend_proc(	cd_estabelecimento_w, 
												cd_procedimento_w, 
												ie_origem_proced_w, 
												null, 
												cd_setor_prescr_w, 
												nm_usuario_p, 
												nr_seq_proc_interno_w, 
												nr_atendimento_ww) 
				into STRICT	cd_setor_exclusivo_w 
				;
				 
			end if;
			 
			if (coalesce(cd_setor_exclusivo_w::text, '') = '') and (nr_seq_exame_w IS NOT NULL AND nr_seq_exame_w::text <> '') then 
 
				select	obter_setor_atend_proc_lab(	cd_estabelecimento_w, 
													cd_procedimento_w, 
													ie_origem_proced_w, 
													null, 
													cd_setor_prescr_w, 
													null, 
													nr_seq_exame_w) 
				into STRICT	cd_setor_exclusivo_w 
				;
 
			end if;
 
			dt_prim_horario_proced_w	:= null;		
			 
			nr_agrupamento_proc_w	:= nr_agrupamento_proc_w + 1;
 
			if (coalesce(cd_medico_exec_w::text, '') = '') and (ie_medico_prescr_w = 'S') then 
				select	max(cd_prescritor) 
				into STRICT	cd_prescritor_w 
				from	prescr_medica 
				where	Obter_se_medico(cd_prescritor, 'M') = 'S' 
				and		nr_prescricao	= nr_prescricao_w;
				 
				cd_medico_exec_w	:= cd_prescritor_w;
				 
			end if;
 
			if (coalesce(cd_setor_exclusivo_w::text, '') = '') and (ie_Gera_Setor_PrescrProc_w = 'S') and (obter_se_setor_exec(	cd_setor_prescr_w, 
										cd_estabelecimento_w, 
										cd_procedimento_w, 
										ie_origem_proced_w, 
										nr_seq_proc_interno_w) = 'S') then 
				cd_setor_exclusivo_w	:= cd_setor_prescr_w;
			end if;
 
			cd_intervalo_w	:= obter_interv_acm_sn_agora_lib(	cd_estabelecimento_w, 
									2, -- ie_intervalo_p 2:SN 
									0, -- ie_opcao_p max() 
									'P',-- ie_item_p 1:medic,2:material,P:proc,15:solução 
									cd_procedimento_w, 
									null, --cd_intervalo 
									nr_prescricao_w, 
									ie_origem_proced_w, 
									nr_seq_proc_interno_w, 
									'N', 
									cd_setor_prescr_w);
 
			insert into prescr_procedimento( 
				nr_prescricao, 
				nr_sequencia, 
				nr_agrupamento, 
				cd_procedimento, 
				qt_procedimento, 
				dt_atualizacao, 
				nm_usuario, 
				ds_observacao, 
				cd_motivo_baixa, 
				ie_origem_proced, 
				cd_intervalo, 
				ie_urgencia, 
				ie_suspenso, 
				cd_setor_atendimento, 
				dt_prev_execucao, 
				cd_material_exame, 
				nr_seq_exame, 
				ie_status_atend, 
				ie_amostra, 
				ie_origem_inf, 
				ie_se_necessario, 
				ie_acm, 
				nr_ocorrencia, 
				ds_material_especial, 
				nr_seq_interno, 
				nr_seq_proc_interno, 
				ds_dado_clinico, 
				ie_avisar_result, 
				cd_protocolo, 
				nr_seq_protocolo, 
				nr_seq_proc_protocolo, 
				ie_lado, 
				ie_respiracao, 
				cd_mod_vent, 
				ie_disp_resp_esp, 
				qt_fluxo_oxigenio, 
				qt_min_intervalo, 
				nr_seq_prot_glic, 
				ie_objetivo_onco, 
				ie_executar_leito, 
				nr_seq_contraste, 
				ds_exame_fis_achado_cirur, 
				ds_resumo_clinico, 
				cd_setor_coleta, 
				cd_setor_entrega, 
				ds_rotina, 
				cd_medico_exec, 
				ds_diag_provavel_ap, 
				ds_exame_anterior_ap, 
				ds_localizacao_lesao, 
				ds_tempo_doenca, 
				cd_cgc_laboratorio, 
				qt_frasco_env, 
				nr_seq_proc_int_cirur, 
				qt_peca_ap, 
				nr_seq_amostra_princ, 
				ds_qualidade_peca_ap, 
				ie_forma_exame, 
				cd_pessoa_coleta, 
				ds_justificativa) 
			values ( 
				nr_prescricao_w, 
				nr_seq_proc_novo_w, 
				nr_agrupamento_proc_w, 
				cd_procedimento_w, 
				qt_procedimento_w, 
				clock_timestamp(), 
				nm_usuario_p, 
				ds_observacao_w, 
				0, 
				ie_origem_proced_w, 
				cd_intervalo_w, 
				ie_agora_w, 
				'N', 
				cd_setor_exclusivo_w, 
				coalesce(dt_prim_horario_proced_w, dt_primeiro_horario_w), 
				cd_material_exame_w, 
				nr_seq_exame_w, 
				5, 
				coalesce(ie_amostra_w,'N'), 
				'1', 
				ie_se_necessario_w, 
				ie_acm_proced_w, 
				1, 
				ds_material_especial_w, 
				nextval('prescr_procedimento_seq'), 
				nr_seq_proc_interno_w, 
				ds_dado_clinico_w, 
				'N', 
				cd_protocolo_p, 
				nr_sequencia_p, 
				nr_seq_proc_prot_w, 
				ie_lado_w, 
				ie_respiracao_w, 
				cd_mod_vent_w, 
				ie_disp_resp_esp_w, 
				qt_fluxo_oxigenio_w, 
				CASE WHEN qt_min_intervalo_w=0 THEN null  ELSE qt_min_intervalo_w END , 
				nr_seq_prot_glic_w, 
				ie_objetivo_onco_w, 
				ie_executar_leito_w, 
				nr_seq_contraste_w, 
				ds_exame_fis_achado_cirur_w, 
				ds_resumo_clinico_w, 
				cd_setor_coleta_w, 
				cd_setor_entrega_w, 
				ds_prescricao_w, 
				cd_medico_exec_w, 
				ds_diag_provavel_ap_w, 
				ds_exame_anterior_ap_w, 
				ds_localizacao_lesao_w, 
				ds_tempo_doenca_w, 
				cd_cgc_laboratorio_w, 
				qt_frasco_env_w, 
				nr_seq_proc_int_cirur_w, 
				qt_peca_ap_w, 
				nr_seq_amostra_princ_w, 
				ds_qualidade_peca_ap_w, 
				ie_forma_exame_w, 
				cd_pessoa_coleta_w, 
				ds_justificativa_w);
				 
			if (cd_kit_material_w IS NOT NULL AND cd_kit_material_w::text <> '') then 
				CALL Gerar_Kit_Proced_manual(cd_estabelecimento_w, nr_prescricao_w, nr_seq_proc_novo_w, cd_kit_material_w, nm_usuario_p);
			end if;
 
			CALL inserir_mat_prescr_prot(nr_prescricao_w, 
									cd_protocolo_p, 
									nr_sequencia_p, 
									0, 
									5, 
									0, 
									nr_seq_proc_prot_w, 
									0, 
									null, 
									nr_seq_proc_novo_w, 
									null, 
									cd_intervalo_w, 
									1, 
									nm_usuario_p, 
									'N', 
									coalesce(qt_peso_p,0), 
									hr_prim_horario_proced_w, 
									0, 
									0, 
									null, 
									null, 
									null, 
									null, 
									null, 
									null, 
									null, 
									null, 
									null, 
									null, 
									null, 
									null, 
									null, 
									'S', 
									null, 
									null, 
									null, 
									null, 
									null, 
									null, 
									null, 
									null, 
									null, 
									null, 
									'S', 
									null);
			 
			ds_erro_w := consistir_prescr_procedimento(nr_prescricao_w, nr_seq_proc_novo_w, nm_usuario_p, 0, ds_erro_w);		
			 
		end if;
		 
		 
	end loop;
	close C01;
	 
	-- inserção das soluções 
	 
	select	coalesce(max(nr_seq_solucao),0), 
			coalesce(max(nr_agrupamento),0) 
	into STRICT	nr_seq_solucao_w, 
			nr_agrupamento_sol_w 
	from	prescr_solucao 
	where	nr_prescricao = nr_prescricao_w;
	 
	open C02;
	loop 
	fetch C02 into 
		nr_seq_solucao_novo_w, 
		nr_seq_solucao_prot_w, 
		ie_tipo_dosagem_w, 
		qt_dosagem_w, 
		qt_solucao_total_w, 
		qt_tempo_aplicacao_w, 
		qt_volume_w, 
		ie_bomba_infusao_w, 
		ie_esquema_alternado_w, 
		ie_calc_aut_w, 
		ie_acm_sol_w, 
		qt_hora_fase_ww, 
		ds_solucao_w, 
		ie_pos_dialisador_w, 
		ie_hemodialise_w, 
		nr_seq_protocolo_w, 
		ie_tipo_solucao_w, 
		qt_temp_solucao_w, 
		ie_momento_w, 
		ie_unid_vel_inf_w, 
		ie_se_necessario_Sol_w, 
		ie_solucao_pca_w, 
		ie_tipo_analgesia_w, 
		ie_pca_modo_prog_w, 
		qt_dose_inicial_pca_w, 
		qt_vol_infusao_pca_w, 
		qt_bolus_pca_w, 
		qt_intervalo_bloqueio_w, 
		qt_limite_quatro_hora_w, 
		qt_dose_ataque_w, 
		ds_orientacao_w, 
		ie_tipo_sol_w, 
		qt_limite_uma_hora_w, 
		ie_urgencia_Prot_W, 
		hr_prim_hor_sol_w, 
		ie_um_dose_inicio_pca_w, 
		ie_um_limite_pca_w, 
		ie_um_limite_hora_pca_w, 
		ie_um_fluxo_pca_w, 
		ie_um_bolus_pca_w, 
		ie_via_aplicacao_w, 
		cd_intervalo_ww, 
		ie_solucao_especial_w, 
		nr_etapas_prot_w, 
		ie_aberta_w, 
		qt_hora_infusao_w, 
		qt_tempo_infusao_w;
	EXIT WHEN NOT FOUND; /* apply on C02 */
		 
		/* 
		 
		dt_primeiro_horario_w	:= null; 
		 
		if	(varIe_Sol_prescr_w	= 'S') and 
			(qt_tempo_aplicacao_w is null) then 
			qt_tempo_aplicacao_w	:= 1; 
		end if;	 
		 
		if	(ie_etapa_interv_w = 'S') then 
			 
			select	obter_se_intervalo_continuo(cd_intervalo_ww) 
			into		ie_continuo_w 
			from		dual; 
			 
			if (ie_continuo_w = 'S') then 
				qt_volume_sol_w := qt_volume_w; 
			else 
				qt_volume_sol_w := qt_solucao_total_w; 
			end if; 
			 
			calcular_etapas_interv_solucao(	cd_intervalo_ww, 
											qt_tempo_aplicacao_w, 
											ie_arredondar_etapas_w, 
											qt_hora_fase_w, 
											nr_etapas_w, 
											qt_volume_sol_w, 
											qt_dosagem_w); 
		else 
			nr_etapas_w := nr_etapas_prot_w; 
			qt_hora_fase_w := qt_hora_fase_ww ; 
		end if; 
 
		if	(ie_tipo_sol_w = 1) and 
			((nvl(qt_hora_infusao_w,0) > 0) or 
			 (nvl(qt_tempo_infusao_w,0) > 0)) then 
			 ie_sol_intermitente_w := 'S'; 
			 if (nvl(qt_tempo_infusao_w,0) > 0) then 
				qt_hora_fase_w	:= nvl(qt_hora_infusao_w,0) + nvl(qt_tempo_infusao_w,0) / 60; 
			 else	 
				qt_hora_fase_w := nvl(qt_hora_infusao_w,0); 
			 end if;	 
		end if; 
		 
		Select	obter_prim_horario_Sol_regra(nr_etapas_w, dt_prescricao_w, hr_prim_hor_sol_w) 
		into	hr_prim_hor_sol_w 
		from	dual; 
		 
		if	(cd_intervalo_ww is not null) and 
			(ie_check_tipo_interv_w = 'S') then 
			select	nvl(nvl(max(ie_se_necessario),ie_se_necessario_sol_w),'N'), 
					nvl(nvl(max(ie_agora),ie_urgencia_w),'N'), 
					nvl(nvl(max(ie_acm),ie_acm_sol_w),'N') 
			into	ie_se_necessario_sol_w, 
					ie_urgencia_w, 
					ie_acm_sol_w 
			from	intervalo_prescricao 
			where	cd_intervalo = cd_intervalo_ww; 
		end if; 
 
		if	(ie_urgencia_w = 'S') or 
			(ie_urgencia_Prot_W = 'S') then 
			hr_prim_hor_sol_w	:= to_char(sysdate,'hh24:mi'); 
		end if; 
		 
		if	(varIe_Sol_prescr_w	= 'S') and 
			(qt_tempo_aplicacao_w is null) then 
			qt_tempo_aplicacao_w	:= nr_horas_validade_w; 
		end if; 
 
		if	(qt_hora_fase_w 		is null) and 
			(nvl(nr_etapas_w,0) 		> 0) and 
			((nvl(nr_etapas_prot_w,0) 	> 0) or 
			 (nvl(ie_acm_sol_w,'N')		<> 'S') or 
			 (nvl(qt_tempo_aplicacao_w,0)	> 0) or 
			 (nvl(nr_etapas_w,0)		> 1)) then 
			if	(nvl(qt_tempo_aplicacao_w,0) = 0) then 
				qt_tempo_aplicacao_w := 24; 
			end if; 
			qt_hora_fase_w	:= dividir(qt_tempo_aplicacao_w, nr_etapas_w); 
		elsif	(qt_hora_fase_w 		is null) and 
			(qt_tempo_aplicacao_w		is null) and 
			(nr_etapas_prot_w		is null) and 
			(nvl(nr_etapas_w,0) 		= 1) and 
			(nvl(ie_acm_sol_w,'N')		= 'S') then 
			nr_etapas_w	:= null; 
		end if;	 
		 
		nr_agrupamento_sol_w	:= nr_agrupamento_sol_w + 1; 
 
		dt_primeiro_horario_w	:= to_date('30/12/1899 ' || to_char(dt_primeiro_horario_w,'hh24:mi:ss'),'dd/mm/yyyy hh24:mi:ss'); 
		 
		if	(ie_perm_etapa_espec_w	= 'S') and 
			(ie_etapa_espec_sol_w	= 'S') and 
			(nvl(ie_acm_sol_w,'N')	<> 'S') and 
			(nvl(ie_se_necessario_Sol_w,'N') <> 'S') and 
			(nvl(ie_urgencia_w,'N')	<> 'S') and 
			(nvl(ie_esquema_alternado_w,'N') <> 'S') and 
			(nr_horas_validade_w	> 24) and 
			(nr_horas_validade_w	> nvl(qt_tempo_aplicacao_w,0)) and 
			(nvl(ie_tipo_sol_w,0)	<> 2) then 
			ie_etapa_especial_w	:= 'S'; 
			hr_prim_hor_sol_w	:= to_char(sysdate,'hh24:mi'); 
			nr_etapas_2w		:= nr_etapas_w +1; 
		else 
			ie_etapa_especial_w	:= 'N'; 
			nr_etapas_2w		:= nr_etapas_w; 
		end if;	 
		 
		if	(ie_calc_aut_w = 'S') or 
			(VarParam805_w = 'S') then 
			calcula_Horarios_Etapas(to_date(to_char(dt_primeiro_horario_w,'dd/mm/yyyy ')||hr_prim_hor_sol_w, 'dd/mm/yyyy hh24:mi'),nvl(nr_etapas_2w,0),nvl(qt_hora_fase_w,0),nm_usuario_p,'N',qt_tempo_aplicacao_w,ds_horarios_sol_w,ds_horarios_sol_2w,ie_etapa_especial_w,'N'); 
		end if;	*/
 
 
		cd_intervalo_w	:= obter_interv_acm_sn_agora_lib(	cd_estabelecimento_w, 
								2, -- ie_intervalo_p 2:SN 
								0, -- ie_opcao_p max() 
								'15',-- ie_item_p 1:medic,2:material,P:proc,15:solução 
								nr_seq_solucao_novo_w, 
								null, --cd_intervalo 
								nr_prescricao_w, 
								null, 
								null, 
								'N', 
								cd_setor_prescr_w);
		 
		insert into Prescr_Solucao( 
			nr_prescricao, 
			nr_seq_solucao, 
			ie_via_aplicacao, 
			dt_atualizacao, 
			nm_usuario, 
			cd_unidade_medida, 
			ie_tipo_dosagem, 
			qt_dosagem, 
			qt_solucao_total, 
			qt_tempo_aplicacao, 
			ds_solucao, 
			qt_volume, 
			nr_etapas, 
			ie_bomba_infusao, 
			ie_suspenso, 
			nr_agrupamento, 
			ie_esquema_alternado, 
			ie_calc_aut, 
			ie_acm, 
			qt_hora_fase, 
			ds_horarios, 
			hr_prim_horario, 
			ie_urgencia, 
			ie_solucao_especial, 
			ie_pos_dialisador, 
			ie_hemodialise, 
			nr_seq_dialise, 
			nr_seq_protocolo, 
			ie_tipo_solucao, 
			qt_temp_solucao, 
			ie_momento, 
			ie_unid_vel_inf, 
			ie_se_necessario, 
			ie_solucao_pca, 
			ie_tipo_analgesia, 
			ie_pca_modo_prog, 
			qt_dose_inicial_pca, 
			qt_vol_infusao_pca, 
			qt_bolus_pca, 
			qt_intervalo_bloqueio, 
			qt_limite_quatro_hora, 
			qt_dose_ataque, 
			ds_orientacao, 
			ie_tipo_sol, 
			qt_limite_uma_hora, 
			ie_um_limite_hora_pca, 
			ie_um_dose_inicio_pca, 
			ie_um_limite_pca, 
			ie_um_fluxo_pca, 
			ie_um_bolus_pca, 
			cd_intervalo, 
			ie_etapa_especial, 
			cd_protocolo, 
			ie_fator_correcao, 
			ie_aberto, 
			ie_sol_intermitente, 
			qt_hora_infusao, 
			qt_tempo_infusao) 
		values ( 
			nr_prescricao_w, 
			nr_seq_solucao_novo_w, 
			coalesce(ie_via_aplicacao_w,upper(obter_via_usuario('IV'))), 
			clock_timestamp(), 
			nm_usuario_p, 
			lower(obter_unid_med_usua('ml')), 
			ie_tipo_dosagem_w, 
			qt_dosagem_w, 
			qt_solucao_total_w, 
			qt_tempo_aplicacao_w, 
			ds_solucao_w, 
			qt_volume_w, 
			nr_etapas_w, 
			ie_bomba_infusao_w, 
			'N', 
			nr_agrupamento_sol_w, 
			ie_esquema_alternado_w, 
			ie_calc_aut_w, 
			ie_acm_sol_w, 
			qt_hora_fase_w, 
			DS_HORARIOS_SOL_W, 
			CASE WHEN ie_acm_sol_w='S' THEN ''  ELSE hr_prim_hor_sol_w END , 
			coalesce(CASE WHEN ie_urgencia_w='S' THEN  ie_urgencia_w  ELSE coalesce(ie_urgencia_Prot_W,'N') END ,'N'), 
			coalesce(ie_solucao_especial_w,'N'), 
			ie_pos_dialisador_w, 
			ie_hemodialise_w, 
			null, 
			nr_seq_protocolo_w, 
			ie_tipo_solucao_w, 
			qt_temp_solucao_w, 
			ie_momento_w, 
			ie_unid_vel_inf_w, 
			ie_se_necessario_Sol_w, 
			ie_solucao_pca_w, 
			ie_tipo_analgesia_w, 
			ie_pca_modo_prog_w, 
			qt_dose_inicial_pca_w, 
			qt_vol_infusao_pca_w, 
			qt_bolus_pca_w, 
			qt_intervalo_bloqueio_w, 
			qt_limite_quatro_hora_w, 
			qt_dose_ataque_w, 
			substr(ds_orientacao_w,1,2000), 
			ie_tipo_sol_w, 
			qt_limite_uma_hora_w, 
			coalesce(ie_um_limite_hora_pca_w,lower(obter_unid_med_usua('ml'))), 
			ie_um_dose_inicio_pca_w, 
			ie_um_limite_pca_w, 
			ie_um_fluxo_pca_w, 
			ie_um_bolus_pca_w, 
			cd_intervalo_ww, 
			ie_etapa_especial_w, 
			cd_protocolo_p, 
			'', 
			ie_aberta_w, 
			'N', 
			null, 
			null);
 
		if (ie_hemodialise_w in ('N','O')) then 
 
			CALL Inserir_mat_prescr_prot(nr_prescricao_w, 
									cd_protocolo_p, 
									nr_sequencia_p, 
									0, 
									4, 
									0, 
									0, 
									nr_seq_solucao_prot_w, 
									null, 
									null, 
									nr_seq_solucao_novo_w, 
									null, 
									1, 
									nm_usuario_p, 
									coalesce(ie_urgencia_w,'N'), 
									coalesce(qt_peso_p,0), 
									null, 
									0, 
									0, 
									null, 
									null, 
									null, 
									null, 
									null, 
									null, 
									null, 
									null, 
									null, 
									null, 
									null, 
									null, 
									null, 
									'S', 
									null, 
									null, 
									null, 
									null, 
									null, 
									null, 
									null, 
									null, 
									null, 
									null, 
									'S', 
									null);
 
			if (ie_calc_aut_w = 'S') then 
				CALL calcular_Etapas_Esquema(nr_prescricao_w, 
										nr_seq_solucao_novo_w);
			end if;
		else 
			CALL Inserir_mat_prescr_prot(nr_prescricao_w, 
									cd_protocolo_p, 
									nr_sequencia_p, 
									0, 
									13, 
									0, 
									0, 
									nr_seq_solucao_prot_w, 
									null, 
									null, 
									nr_seq_solucao_novo_w, 
									null, 
									1, 
									nm_usuario_p, 
									coalesce(ie_urgencia_w,'N'), 
									coalesce(qt_peso_p,0), 
									null, 
									0, 
									0, 
									null, 
									null, 
									null, 
									null, 
									null, 
									null, 
									null, 
									null, 
									null, 
									null, 
									null, 
									null, 
									null, 
									'S', 
									null, 
									null, 
									null, 
									null, 
									null, 
									null, 
									null, 
									null, 
									null, 
									null, 
									'S', 
									null);
 
		end if;
 
		ds_erro_ww := Consistir_prescr_solucao(	nr_prescricao_w, nr_seq_solucao_novo_w, cd_estabelecimento_w, obter_perfil_ativo, nm_usuario_p, ds_erro_ww);
 
	end loop;
	close C02;
 
end if;
 
CALL gerar_prescr_mat_sem_dt_lib(nr_prescricao_w, 0, obter_perfil_ativo, 'N', nm_usuario_p);
 
commit;
 
end	;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE inserir_item_prot_pre_rep ( nr_atendimento_p bigint, nm_usuario_p text, cd_medico_p bigint, dt_prescricao_p timestamp, nr_horas_validade_p text, dt_primeiro_horario_p text, cd_protocolo_p bigint, nr_sequencia_p bigint, qt_peso_p bigint, nr_seq_pend_pac_acao_p bigint, ds_observacao_p text, nm_computador_p text, cd_pessoa_fisica_p text, nr_prescricao_p INOUT bigint) FROM PUBLIC;

