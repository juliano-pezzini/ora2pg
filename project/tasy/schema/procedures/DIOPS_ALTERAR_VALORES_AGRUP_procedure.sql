-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE diops_alterar_valores_agrup ( nm_usuario_p text, nr_seq_periodo_p bigint, vl_contr_col_adesao_pool_p bigint, vl_corresp_ced_adesao_pool_p bigint, vl_emit_col_adesao_pool_p bigint, vl_contr_col_empres_pool_p bigint, vl_corresp_ced_empres_pool_p bigint, vl_emit_col_empres_pool_p bigint, vl_contr_col_adesao_p bigint, vl_corresp_ced_adesao_p bigint, vl_emit_col_adesao_p bigint, vl_contr_col_empres_p bigint, vl_corresp_ced_empres_p bigint, vl_emit_col_empres_p bigint) AS $body$
DECLARE


vl_movimento_w			diops_movto_agrup_contrat.vl_movimento%type;
cd_tipo_movimento_w		diops_movto_agrup_contrat.cd_tipo_movimento%type;
cd_tipo_contratacao_w		diops_movto_agrup_contrat.cd_tipo_contratacao%type;
ie_mensalidade_conta_w		diops_movto_agrup_contrat.ie_mensalidade_conta%type;
qt_tipo_movimento_w		smallint;
dt_inicial_w			timestamp;
ie_2019_ou_posterior_w		varchar(2);


BEGIN

delete 	FROM diops_movto_agrup_contrat
where	nr_seq_periodo	= nr_seq_periodo_p;

select	trunc(max(dt_periodo_inicial),'yyyy')
into STRICT	dt_inicial_w
from	diops_periodo
where	nr_sequencia	= nr_seq_periodo_p;

if (dt_inicial_w >= to_date('01/01/2019', 'dd/mm/yyyy')) then
	ie_2019_ou_posterior_w := 'S';
else
	ie_2019_ou_posterior_w := 'N';
end if;

qt_tipo_movimento_w	:= 12;
cd_tipo_movimento_w	:= 1;
cd_tipo_contratacao_w	:= 2;
vl_movimento_w		:= 0;
ie_mensalidade_conta_w	:= 'C';

/*Tratamento com o propósito de a cada geração do diops, inicializar a tabela com 4 registros, pois ao gerar o XML é necessário mínimo de 4 tags de movimentação*/

while(qt_tipo_movimento_w > 0) loop
	begin

	if (qt_tipo_movimento_w = 1) then
		vl_movimento_w	:= vl_contr_col_adesao_p;
		ie_mensalidade_conta_w	:= 'M';
        elsif (qt_tipo_movimento_w = 2) then
                vl_movimento_w  := vl_corresp_ced_adesao_p;
                ie_mensalidade_conta_w	:= 'R';
	elsif (qt_tipo_movimento_w = 3) then
		vl_movimento_w	:= vl_emit_col_adesao_p;
		ie_mensalidade_conta_w	:= 'C';
		cd_tipo_contratacao_w 	:= 1;
	elsif (qt_tipo_movimento_w = 4) then
		vl_movimento_w	:= vl_contr_col_empres_p;
		ie_mensalidade_conta_w	:= 'M';
        elsif (qt_tipo_movimento_w = 5) then
                vl_movimento_w := vl_corresp_ced_empres_p;
                ie_mensalidade_conta_w	:= 'R';
	elsif (qt_tipo_movimento_w = 6) then
		vl_movimento_w	:= vl_emit_col_empres_p;
		ie_mensalidade_conta_w	:= 'C';
		cd_tipo_movimento_w	:= 2;
		cd_tipo_contratacao_w 	:= 2;
	elsif (qt_tipo_movimento_w = 7) then
		vl_movimento_w	:= vl_contr_col_adesao_pool_p;
		ie_mensalidade_conta_w	:= 'M';
        elsif (qt_tipo_movimento_w = 8) then
                vl_movimento_w  := vl_corresp_ced_adesao_pool_p;
                ie_mensalidade_conta_w	:= 'R';
	elsif (qt_tipo_movimento_w = 9) then
		vl_movimento_w	:= vl_emit_col_adesao_pool_p;
		ie_mensalidade_conta_w	:= 'C';
		cd_tipo_contratacao_w := 1;
	elsif (qt_tipo_movimento_w = 10) then
		vl_movimento_w	:= vl_contr_col_empres_pool_p;
		ie_mensalidade_conta_w	:= 'M';
        elsif (qt_tipo_movimento_w = 11) then
                vl_movimento_w  := vl_corresp_ced_empres_pool_p;
                ie_mensalidade_conta_w	:= 'R';
	elsif (qt_tipo_movimento_w = 12) then
		vl_movimento_w	:= vl_emit_col_empres_pool_p;
	end if;

	if (ie_2019_ou_posterior_w <> 'N' or ie_mensalidade_conta_w <> 'R') then
		insert into diops_movto_agrup_contrat(	nr_sequencia,
							dt_atualizacao,
							nm_usuario,
							dt_atualizacao_nrec,
							nm_usuario_nrec,
							cd_tipo_contratacao,
							cd_tipo_movimento,
							nr_seq_periodo,
							ie_mensalidade_conta,
							vl_movimento)
						values (nextval('diops_movto_agrup_contrat_seq'),
							clock_timestamp(),
							nm_usuario_p,
							clock_timestamp(),
							nm_usuario_p,
							cd_tipo_contratacao_w,
							cd_tipo_movimento_w,
							nr_seq_periodo_p,
							ie_mensalidade_conta_w,
							vl_movimento_w);
	end if;

	qt_tipo_movimento_w	:= qt_tipo_movimento_w - 1;
	end;
end loop;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE diops_alterar_valores_agrup ( nm_usuario_p text, nr_seq_periodo_p bigint, vl_contr_col_adesao_pool_p bigint, vl_corresp_ced_adesao_pool_p bigint, vl_emit_col_adesao_pool_p bigint, vl_contr_col_empres_pool_p bigint, vl_corresp_ced_empres_pool_p bigint, vl_emit_col_empres_pool_p bigint, vl_contr_col_adesao_p bigint, vl_corresp_ced_adesao_p bigint, vl_emit_col_adesao_p bigint, vl_contr_col_empres_p bigint, vl_corresp_ced_empres_p bigint, vl_emit_col_empres_p bigint) FROM PUBLIC;

