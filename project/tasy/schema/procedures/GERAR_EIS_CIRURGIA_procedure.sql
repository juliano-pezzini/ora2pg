-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_eis_cirurgia ( dt_parametro_P timestamp, NM_USUARIO_P text) AS $body$
DECLARE

 
dt_parametro_w			timestamp;
dt_ano_w				timestamp;
nr_sequencia_w			bigint;
ds_mensagem_w			varchar(2000) := null;
ds_mensagem_ww			varchar(2000) := null;

expressao1_w	varchar(255) := obter_desc_expressao_idioma(284979, null, wheb_usuario_pck.get_nr_seq_idioma);--Cirurgia 
BEGIN 
 
nr_sequencia_w := Gravar_Log_Indicador(11, expressao1_w, clock_timestamp(), trunc(dt_parametro_P), nm_usuario_p, nr_sequencia_w);
 
dt_parametro_w		:= TRUNC(dt_parametro_p, 'month');
dt_ano_w		:= TRUNC(dt_parametro_p, 'year');
 
 
DELETE 	FROM eis_cirurgia 
WHERE 	TRUNC(dt_referencia, 'month') = TRUNC(dt_parametro_p, 'month') 
AND	ie_periodo	= 'M';
 
DELETE	FROM eis_cirurgia 
WHERE 	TRUNC(dt_referencia, 'year') = TRUNC(dt_parametro_p, 'year') 
AND	ie_periodo	= 'A';
 
/*Gravar_Log_Indicador(11, 'MENSAL Dt_parametro: '||dt_parametro_w||' Dt_Ano : '||dt_ano_w||' dt_parametro_p: '||dt_parametro_p, sysdate, trunc(dt_parametro_P), nm_usuario_p, nr_sequencia_w);*/
 
 
ds_mensagem_w := Gerar_Eis_Cir_Diaria(dt_parametro_P, nm_usuario_p, ds_mensagem_w);
ds_mensagem_ww := substr(ds_mensagem_ww || ds_mensagem_w,1,2000);
 
INSERT	INTO EIS_Cirurgia( 
    dt_referencia, 
		cd_estabelecimento, 
		cd_convenio, 
		cd_medico_cirurgiao, 
		cd_medico_anestesista, 
		cd_tipo_anestesia, 
		cd_procedimento, 
		ie_origem_proced, 
		cd_especialidade, 
		cd_setor_atendimento, 
		cd_Unidade, 
		ie_sexo_paciente, 
		ie_faixa_etaria, 
		ie_status_cirurgia, 
		ie_carater_cirurgia, 
		ie_periodo, 
		qt_hora_duracao, 
		qt_ocorrencia, 
	  	qt_min_duracao, 
	  	vl_faturado, 
	  	vl_Custo, 
		vl_resultado, 
		qt_min_anestesista, 
		qt_min_medico, 
		qt_min_enfermagem, 
		qt_min_exturbacao, 
		qt_min_higienizacao, 
		hr_cirurgia, 
		ie_tipo_atendimento, 
		CD_TIPO_CIRURGIA, 
		CD_MUNICIPIO_CONVENIO, 
		ie_video, 
		dt_inicio_real, 
		qt_min_duracao_prev, 
		dt_inicio_prevista, 
		nr_seq_motivo_atraso, 
		nr_seq_proced_niss, 
		ie_asa_estado_paciente, 
		nr_seq_proc_interno, 
		cd_motivo_cancelamento, 
		nr_seq_via, 
		ie_clinica, 
		ie_porte_preco, 
		ie_sangue, 
		cd_procedencia, 
		cd_convenio_glosa, 
		cd_municipio_ibge, 
		cd_tipo_acomodacao, 
		cd_convenio_atendimento, 
		ds_sala_setor, 
		ie_status_agenda, 
		ie_porte, 
		nr_atendimento, 
		cd_categoria, 
		ie_reoperacao, 
		ie_prescr_pepo, 
		ie_agente_pepo, 
		IE_PORTE_ANESTESICO) 
(SELECT		dt_parametro_w, 
    		cd_estabelecimento, 
		cd_convenio, 
		cd_medico_cirurgiao, 
		cd_medico_anestesista, 
		cd_tipo_anestesia, 
		cd_procedimento, 
		ie_origem_proced, 
		cd_especialidade, 
		cd_setor_atendimento, 
		cd_Unidade, 
		ie_sexo_paciente, 
		ie_faixa_etaria, 
		ie_status_cirurgia, 
		ie_carater_cirurgia, 
		'M', 
		qt_hora_duracao, 
		coalesce(SUM(qt_ocorrencia),0), 
	  	coalesce(SUM(qt_min_duracao),0), 
	  	coalesce(SUM(vl_faturado),0), 
	  	coalesce(SUM(vl_Custo),0), 
		coalesce(SUM(vl_resultado),0), 
		coalesce(SUM(qt_min_anestesista),0), 
		coalesce(SUM(qt_min_medico),0), 
		coalesce(SUM(qt_min_enfermagem),0), 
		coalesce(SUM(qt_min_exturbacao),0), 
		coalesce(SUM(qt_min_higienizacao),0), 
		hr_cirurgia, 
		ie_tipo_atendimento, 
		CD_TIPO_CIRURGIA, 
		CD_MUNICIPIO_CONVENIO, 
		ie_video, 
		dt_inicio_real, 
		qt_min_duracao_prev, 
		dt_inicio_prevista, 
		nr_seq_motivo_atraso, 
		nr_seq_proced_niss, 
		ie_asa_estado_paciente, 
		nr_seq_proc_interno, 
		cd_motivo_cancelamento, 
		nr_seq_via, 
		ie_clinica, 
		ie_porte_preco, 
		ie_sangue, 
		cd_procedencia, 
		cd_convenio_glosa, 
		cd_municipio_ibge, 
		cd_tipo_acomodacao, 
		cd_convenio_atendimento, 
		ds_sala_setor, 
		ie_status_agenda, 
		ie_porte, 
		nr_atendimento, 
		cd_categoria, 
		ie_reoperacao, 
		ie_prescr_pepo, 
		ie_agente_pepo, 
		IE_PORTE_ANESTESICO 
FROM		eis_cirurgia 
WHERE		TRUNC(dt_referencia, 'month')	= dt_parametro_w 
AND		ie_periodo	= 'D' 
GROUP BY 	dt_parametro_w, 
		cd_estabelecimento, 
		cd_convenio, 
		cd_medico_cirurgiao, 
		cd_medico_anestesista, 
		cd_tipo_anestesia, 
		cd_procedimento, 
		ie_origem_proced, 
		cd_especialidade, 
		cd_setor_atendimento, 
		cd_Unidade, 
		qt_hora_duracao, 
		ie_sexo_paciente, 
		ie_faixa_etaria, 
		ie_status_cirurgia, 
		ie_carater_cirurgia, 
		hr_cirurgia, 
		ie_tipo_atendimento, 
		CD_TIPO_CIRURGIA, 
		CD_MUNICIPIO_CONVENIO, 
		ie_video, 
		dt_inicio_real, 
		qt_min_duracao_prev, 
		dt_inicio_prevista, 
		nr_seq_motivo_atraso, 
		nr_seq_proced_niss, 
		ie_asa_estado_paciente, 
		nr_seq_proc_interno, 
		cd_motivo_cancelamento, 
		nr_seq_via, 
		ie_clinica, 
		ie_porte_preco, 
		ie_sangue, 
		cd_procedencia, 
		cd_convenio_glosa, 
		cd_municipio_ibge, 
		cd_tipo_acomodacao, 
		cd_convenio_atendimento, 
		ds_sala_setor, 
		ie_status_agenda, 
		ie_porte, 
		nr_atendimento, 
		cd_categoria, 
		ie_reoperacao, 
		ie_prescr_pepo, 
		ie_agente_pepo, 
		IE_PORTE_ANESTESICO);
 
INSERT	INTO EIS_Cirurgia( 
       	dt_referencia, 
   	   	cd_estabelecimento, 
		cd_convenio, 
		cd_medico_cirurgiao, 
		cd_medico_anestesista, 
		cd_tipo_anestesia, 
		cd_procedimento, 
		ie_origem_proced, 
		cd_especialidade, 
		cd_setor_atendimento, 
		cd_Unidade, 
		ie_sexo_paciente, 
		ie_faixa_etaria, 
		ie_status_cirurgia, 
		ie_carater_cirurgia, 
		ie_periodo, 
		qt_hora_duracao, 
		qt_ocorrencia, 
	  	qt_min_duracao, 
	  	vl_faturado, 
	  	vl_Custo, 
		vl_resultado, 
		qt_min_anestesista, 
		qt_min_medico, 
		qt_min_enfermagem, 
		qt_min_exturbacao, 
		qt_min_higienizacao, 
		hr_cirurgia, 
		ie_tipo_atendimento, 
		CD_TIPO_CIRURGIA, 
		CD_MUNICIPIO_CONVENIO, 
		ie_video, 
		dt_inicio_real, 
		qt_min_duracao_prev, 
		dt_inicio_prevista, 
		nr_seq_motivo_atraso, 
		nr_seq_proced_niss, 
		ie_asa_estado_paciente, 
		nr_seq_proc_interno, 
		cd_motivo_cancelamento, 
		nr_seq_via, 
		ie_clinica, 
		ie_porte_preco, 
		ie_sangue, 
		cd_procedencia, 
		cd_convenio_glosa, 
		cd_municipio_ibge, 
		cd_tipo_acomodacao, 
		cd_convenio_atendimento, 
		ds_sala_setor, 
		ie_status_agenda, 
		ie_porte, 
		nr_atendimento, 
		cd_categoria, 
		ie_reoperacao, 
		ie_prescr_pepo, 
		ie_agente_pepo, 
		IE_PORTE_ANESTESICO) 
(SELECT		dt_ano_w, 
		cd_estabelecimento, 
		cd_convenio, 
		cd_medico_cirurgiao, 
		cd_medico_anestesista, 
		cd_tipo_anestesia, 
		cd_procedimento, 
		ie_origem_proced, 
		cd_especialidade, 
		cd_setor_atendimento, 
		cd_Unidade, 
		ie_sexo_paciente, 
		ie_faixa_etaria, 
		ie_status_cirurgia, 
		ie_carater_cirurgia, 
		'A', 
		qt_hora_duracao, 
		coalesce(SUM(qt_ocorrencia),0), 
	  	coalesce(SUM(qt_min_duracao),0), 
	  	coalesce(SUM(vl_faturado),0), 
	  	coalesce(SUM(vl_Custo),0), 
		coalesce(SUM(vl_resultado),0), 
		coalesce(SUM(qt_min_anestesista),0), 
		coalesce(SUM(qt_min_medico),0), 
		coalesce(SUM(qt_min_enfermagem),0), 
		coalesce(SUM(qt_min_exturbacao),0), 
		coalesce(SUM(qt_min_higienizacao),0), 
		hr_cirurgia, 
		ie_tipo_atendimento, 
		CD_TIPO_CIRURGIA, 
		CD_MUNICIPIO_CONVENIO, 
		ie_video, 
		dt_inicio_real, 
		qt_min_duracao_prev, 
		dt_inicio_prevista, 
		nr_seq_motivo_atraso, 
		nr_seq_proced_niss, 
		ie_asa_estado_paciente, 
		nr_seq_proc_interno, 
		cd_motivo_cancelamento, 
		nr_seq_via, 
		ie_clinica, 
		ie_porte_preco, 
		ie_sangue, 
		cd_procedencia, 
		cd_convenio_glosa, 
		cd_municipio_ibge, 
		cd_tipo_acomodacao, 
		cd_convenio_atendimento, 
		ds_sala_setor, 
		ie_status_agenda, 
		ie_porte, 
		nr_atendimento, 
		cd_categoria, 
		ie_reoperacao, 
		ie_prescr_pepo, 
		ie_agente_pepo, 
		IE_PORTE_ANESTESICO 
FROM		eis_cirurgia 
WHERE		TRUNC(dt_referencia, 'year')	= dt_ano_w 
AND		ie_periodo	= 'M' 
GROUP BY 	dt_ano_w, 
   	   	cd_estabelecimento, 
		cd_convenio, 
		cd_medico_cirurgiao, 
		cd_medico_anestesista, 
		cd_tipo_anestesia, 
		cd_procedimento, 
		ie_origem_proced, 
		cd_especialidade, 
		cd_setor_atendimento, 
		cd_Unidade, 
		qt_hora_duracao, 
		ie_sexo_paciente, 
		ie_faixa_etaria, 
		ie_status_cirurgia, 
		ie_carater_cirurgia, 
		hr_cirurgia, 
		ie_tipo_atendimento, 
		CD_TIPO_CIRURGIA, 
		CD_MUNICIPIO_CONVENIO, 
		ie_video, 
		dt_inicio_real, 
		qt_min_duracao_prev, 
		dt_inicio_prevista, 
		nr_seq_motivo_atraso, 
		nr_seq_proced_niss, 
		ie_asa_estado_paciente, 
		nr_seq_proc_interno, 
		cd_motivo_cancelamento, 
		nr_seq_via, 
		ie_clinica, 
		ie_porte_preco, 
		ie_sangue, 
		cd_procedencia, 
		cd_convenio_glosa, 
		cd_municipio_ibge, 
		cd_tipo_acomodacao, 
		cd_convenio_atendimento, 
		ds_sala_setor, 
		ie_status_agenda, 
		ie_porte, 
		nr_atendimento, 
		cd_categoria, 
		ie_reoperacao, 
		ie_prescr_pepo, 
		ie_agente_pepo, 
		IE_PORTE_ANESTESICO);
 
 
CALL gerar_eis_centro_cirurgico(dt_parametro_w,nm_usuario_p);
 
CALL Atualizar_Log_Indicador(clock_timestamp(), nr_sequencia_w);
 
COMMIT;
 
if (coalesce(ds_mensagem_ww,'XPTO') <> 'XPTO') then 
	CALL wheb_mensagem_pck.Exibir_Mensagem_Abort(990753, 'DS_MENSAGEM=' || ds_mensagem_ww );
end if;
 
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_eis_cirurgia ( dt_parametro_P timestamp, NM_USUARIO_P text) FROM PUBLIC;

