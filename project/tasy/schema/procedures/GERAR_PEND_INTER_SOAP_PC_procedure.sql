-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_pend_inter_soap_pc ( nr_seq_reg_p bigint, ie_tipo_encam_p text) AS $body$
DECLARE

 
cd_medico_dest_w		varchar(10);
cd_pessoa_fisica_w		varchar(10);
cd_agenda_w				bigint;
cd_prof_pend_w			varchar(10);
nr_seq_pedido_w			bigint;
nm_usuario_w			lista_pendencias_internas.nm_usuario%type;

C01 CURSOR FOR 
	SELECT	a.cd_medico_dest, 
			a.cd_agenda, 
			substr(obter_pf_usuario(a.nm_usuario,'C'),1,10), 
			obter_pessoa_atendimento(a.nr_atendimento,'C') 
	from	atend_encaminhamento a 
	where	a.nr_sequencia				= nr_seq_reg_p 
	and		(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '') 
	and		coalesce(a.dt_inativacao::text, '') = '' 
	and		a.ie_gerar_pendencia		= 'S' 
	and		a.ie_situacao				= 'A' 
	and		a.ie_proc_encaminhamento	= ie_tipo_encam_p;

C02 CURSOR FOR 
	SELECT	nr_sequencia 
	from	atend_programa_saude a 
	where	a.nr_sequencia	= nr_seq_reg_p 
	and		(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '') 
	and		coalesce(a.dt_inativacao::text, '') = '' 
	and		a.ie_situacao	= 'A';


BEGIN 
if (nr_seq_reg_p IS NOT NULL AND nr_seq_reg_p::text <> '') then 
	nm_usuario_w := wheb_usuario_pck.get_nm_usuario;
 
	if (ie_tipo_encam_p in ('E','T')) then 
		open C01;
		loop 
		fetch C01 into	 
			cd_medico_dest_w, 
			cd_agenda_w, 
			cd_prof_pend_w, 
			cd_pessoa_fisica_w;
		EXIT WHEN NOT FOUND; /* apply on C01 */
			begin 
			insert into lista_pendencias_internas( 
					nr_sequencia, 
					dt_atualizacao, 
					nm_usuario, 
					dt_atualizacao_nrec, 
					nm_usuario_nrec, 
					cd_especialidade, 
					ie_tipo_pendencia, 
					cd_profissional_destino, 
					cd_agenda, 
					cd_profissional_pendencia, 
					nr_seq_programa_saude, 
					dt_pendencia, 
					cd_pessoa_fisica 
					) values ( 
					nextval('lista_pendencias_internas_seq'), 
					clock_timestamp(), 
					nm_usuario_w, 
					clock_timestamp(), 
					nm_usuario_w, 
					null, 
					'C', 
					cd_medico_dest_w, 
					cd_agenda_w, 
					cd_prof_pend_w, 
					null, 
					clock_timestamp(), 
					cd_pessoa_fisica_w);
			end;
		end loop;
		close C01;
		commit;
	 
	elsif (ie_tipo_encam_p = 'P') then 
 
		open C02;
		loop 
		fetch C02 into	 
			nr_seq_pedido_w;
		EXIT WHEN NOT FOUND; /* apply on C02 */
			begin 
			 
			CALL gerar_programa_saude_pep(nr_seq_pedido_w);
			 
			end;
		end loop;
		close C02;
		commit;
		 
	end if;
end if;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_pend_inter_soap_pc ( nr_seq_reg_p bigint, ie_tipo_encam_p text) FROM PUBLIC;

