-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE envia_lista_espera_integracao (NR_SEQ_LISTA_ESPERA_P bigint, IE_ALTERA_STATUS_P text DEFAULT NULL, DS_EVENTO_INTEGRACAO_P text DEFAULT NULL, IE_NOVO_STATUS_P text DEFAULT NULL) AS $body$
DECLARE


  NR_SEQ_REGULACAO_ATEND_W   REGULACAO_ATEND.NR_SEQUENCIA%TYPE;
  IE_STATUS_W                REGULACAO_ATEND.IE_STATUS%TYPE;
  IE_INTEGRACAO_W            varchar(2);
  DS_INTEGRACAO_W            text;
  NM_USUARIO_W               REGULACAO_ATEND.NM_USUARIO%TYPE;
  IE_EVENTO_BIFROST_W        varchar(40);
  CD_EXPRESSAO_W					bigint;


BEGIN

  SELECT MAX(A.NR_SEQ_REGULACAO)
    INTO STRICT NR_SEQ_REGULACAO_ATEND_W
    FROM AGENDA_LISTA_ESPERA A

   WHERE NR_SEQUENCIA = NR_SEQ_LISTA_ESPERA_P;

  IF (NR_SEQ_REGULACAO_ATEND_W IS NOT NULL AND NR_SEQ_REGULACAO_ATEND_W::text <> '') THEN

    SELECT MAX(IE_STATUS)
      INTO STRICT IE_STATUS_W
      FROM REGULACAO_ATEND
     WHERE NR_SEQUENCIA = NR_SEQ_REGULACAO_ATEND_W;

    NM_USUARIO_W := WHEB_USUARIO_PCK.GET_NM_USUARIO;

    IE_INTEGRACAO_W := OBTER_PARAM_USUARIO(366, 4, OBTER_PERFIL_ATIVO, NM_USUARIO_W, NULL, IE_INTEGRACAO_W);



    IF (IE_INTEGRACAO_W = 'I') THEN

      IF (DS_EVENTO_INTEGRACAO_P IS NOT NULL AND DS_EVENTO_INTEGRACAO_P::text <> '') THEN
        IE_EVENTO_BIFROST_W := DS_EVENTO_INTEGRACAO_P;
      ELSIF (coalesce(IE_ALTERA_STATUS_P,'N') = 'N')THEN
        IE_EVENTO_BIFROST_W := 'regulation.waitingList';
      ELSE
        IE_EVENTO_BIFROST_W := 'regulation.waitingList.update';
      END IF;
      
      IF (IE_NOVO_STATUS_P = 'FI') THEN
         CD_EXPRESSAO_W := 1108547;
      ELSIF (IE_NOVO_STATUS_P = 'CA') THEN
        CD_EXPRESSAO_W := 1105223;
      END IF;

      SELECT BIFROST.SEND_INTEGRATION(IE_EVENTO_BIFROST_W,
                                      'com.philips.tasy.integration.atepac.waitinglist.WaitingListRequest',
                                      '{"waitingListOrigin" : "' ||NR_SEQ_LISTA_ESPERA_P || '"'
                                      || (CASE WHEN (IE_NOVO_STATUS_P IS NOT NULL AND IE_NOVO_STATUS_P::text <> '') THEN ', "newStatus" : "' || IE_NOVO_STATUS_P ||'"'  ELSE '' END)
                                      || (CASE WHEN (CD_EXPRESSAO_W IS NOT NULL AND CD_EXPRESSAO_W::text <> '') THEN ', "message" : "' ||obter_expressao_dic_objeto( CD_EXPRESSAO_W) ||'"'  ELSE '' END)
                                      || '}',
                                      NM_USUARIO_W)
        INTO STRICT DS_INTEGRACAO_W
;

    END IF;

  END IF;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE envia_lista_espera_integracao (NR_SEQ_LISTA_ESPERA_P bigint, IE_ALTERA_STATUS_P text DEFAULT NULL, DS_EVENTO_INTEGRACAO_P text DEFAULT NULL, IE_NOVO_STATUS_P text DEFAULT NULL) FROM PUBLIC;

