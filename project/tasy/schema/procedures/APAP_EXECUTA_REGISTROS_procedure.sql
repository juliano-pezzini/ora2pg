-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE apap_executa_registros (nr_seq_linha_p bigint, dt_registro_p timestamp, vl_resultado_p bigint, ds_resultado_p text, dt_resultado_p timestamp, ie_delete_p text default 'N', DS_RESULT_DESC_P text default null, NR_SEQ_ORIGEM_P bigint default null, nr_seq_registro_p INOUT bigint DEFAULT NULL, ds_cor_alerta_p INOUT text  DEFAULT NULL) AS $body$
DECLARE



nm_usuario_w			usuario.nm_usuario%type					:=	wheb_usuario_pck.get_nm_usuario;
cd_estabelecimento_w	estabelecimento.cd_estabelecimento%type	:= 	wheb_usuario_pck.get_cd_estabelecimento;
cd_perfil_w				perfil.cd_perfil%type					:= 	wheb_usuario_pck.get_cd_perfil;
ds_profissional_w		pessoa_fisica.nm_pessoa_fisica%type		:=	obter_pf_usuario(wheb_usuario_pck.get_nm_usuario,'D');
nr_seq_registro_w		w_apap_pac_registro.nr_sequencia%type	:= 	null;	
ie_componente_w			tabela_visao_atributo.ie_componente%type:= null;
ds_lookup_w				w_apap_pac_informacao.ds_lookup%type 	:= null;
ds_result_desc_w		w_apap_pac_registro.ds_result_desc%type := null;
ie_status_w				valor_dominio.vl_dominio%type;
nr_seq_linha_w			w_apap_pac_registro.nr_seq_apap_inf%type;

BEGIN

if (ie_delete_p = 'N') then
	if (coalesce(nr_seq_linha_p,0) > 0) and (dt_registro_p IS NOT NULL AND dt_registro_p::text <> '') and
		((vl_resultado_p IS NOT NULL AND vl_resultado_p::text <> '') or (ds_resultado_p IS NOT NULL AND ds_resultado_p::text <> '') or (dt_resultado_p IS NOT NULL AND dt_resultado_p::text <> '')) then
		nr_seq_registro_w	:= coalesce(nr_seq_registro_p,0);
		select	max(coalesce(a.ie_componente,d.ie_componente)),
				max(b.ds_lookup),
				--max(instr(trim(nvl(obter_desc_expressao(a.cd_exp_valores),a.ds_valores)),ds_resultado_p))
				max(case when(b.nr_seq_temp_conteudo IS NOT NULL AND b.nr_seq_temp_conteudo::text <> '') then position(ds_resultado_p in '1,0')
					 else	position(ds_resultado_p in trim(both coalesce(obter_desc_expressao(a.cd_exp_valores),a.ds_valores)))
				end)	 ie_status
		into STRICT	ie_componente_w,
				ds_lookup_w,
				ie_status_w
		FROM w_apap_pac_informacao b
LEFT OUTER JOIN tabela_visao_atributo a ON (b.nr_seq_visao = a.nr_sequencia AND b.nm_atributo_tabela = a.nm_atributo)
LEFT OUTER JOIN ehr_template_conteudo c ON (b.nr_seq_temp_conteudo = c.nr_sequencia)
LEFT OUTER JOIN ehr_elemento d ON (c.nr_seq_elemento = d.nr_sequencia)
WHERE b.nr_sequencia 			= nr_seq_linha_p;
		if (nr_seq_registro_w = 0) then
			if (ie_componente_w = 'cb') then
				select	coalesce(max(nr_sequencia),0)
				into STRICT	nr_seq_registro_w
				from	w_apap_pac_registro
				where	dt_registro 	= dt_registro_p
				and		nr_seq_apap_inf	= nr_seq_linha_p
                                and NR_SEQ_ORIGEM = NR_SEQ_ORIGEM_P;
			end if;	
		end if;	
		if (coalesce(nr_seq_registro_w,0) = 0) then
			select	nextval('w_apap_pac_registro_seq')
			into STRICT	nr_seq_registro_w
			;

            nr_seq_registro_p := nr_seq_registro_w;
			
			if (ie_componente_w = 'cb') then
				if (ie_status_w = 1) then
					ds_result_desc_w	:= obter_valor_dominio(6, 'S');
				elsif (ie_status_w = 3) then
					ds_result_desc_w	:= obter_valor_dominio(6, 'N');
				end if;	
			end if;	
			if (ds_lookup_w IS NOT NULL AND ds_lookup_w::text <> '') and ((vl_resultado_p IS NOT NULL AND vl_resultado_p::text <> '') or (ds_resultado_p IS NOT NULL AND ds_resultado_p::text <> '')) then
				ds_result_desc_w := Obter_valor_Dinamico_char_bv(ds_lookup_w, 'vl_resultado='||coalesce(to_char(vl_resultado_p),ds_resultado_p)||';', ds_result_desc_w);
			end if;
			
			if (coalesce(ds_result_desc_w::text, '') = '') then
				ds_result_desc_w := vl_resultado_p;
				if (coalesce(ds_result_desc_w::text, '') = '') then
					ds_result_desc_w := ds_resultado_p;
					if (coalesce(ds_result_desc_w::text, '') = '') then
						ds_result_desc_w := pkg_date_formaters_tz.to_varchar(dt_resultado_p,'shortDate',establishment_timezone_utils.gettimezone);
					end if;
				end if;
			end if;

			insert	into	w_apap_pac_registro(	nr_sequencia,
													dt_atualizacao,
													nm_usuario,
													dt_atualizacao_nrec,
													nm_usuario_nrec,
													nr_seq_origem,
													dt_registro,
													vl_resultado,
													ds_resultado,
													nr_seq_apap_inf,
													dt_medicao,
													dt_resultado,
													dt_inicio,
													dt_fim,
													vl_pas,
													vl_pam,
													vl_pad,
													vl_papd,
													vl_paps,
													vl_papm,
													ds_profissional,
													ie_alerta,
													ds_result_desc,
													ie_situacao,
													ie_status_registro)
			values (	nr_seq_registro_w,
													clock_timestamp(),
													nm_usuario_w,
													clock_timestamp(),
													nm_usuario_w,
													NR_SEQ_ORIGEM_P,
													dt_registro_p,
													vl_resultado_p,
													ds_resultado_p,
													nr_seq_linha_p,
													dt_registro_p,
													dt_resultado_p,
													null,
													null,
													null,
													null,
													null,
													null,
													null,
													null,
													ds_profissional_w,
													'N',
													coalesce(ds_result_desc_p,ds_result_desc_w),
													'A',
													'P');
		else
			if (ds_lookup_w IS NOT NULL AND ds_lookup_w::text <> '') and ((vl_resultado_p IS NOT NULL AND vl_resultado_p::text <> '') or (ds_resultado_p IS NOT NULL AND ds_resultado_p::text <> '')) then
				ds_result_desc_w := Obter_valor_Dinamico_char_bv(ds_lookup_w, 'vl_resultado='||coalesce(to_char(vl_resultado_p),ds_resultado_p)||';', ds_result_desc_w);
			end if;
			
			if (ie_componente_w = 'cb') then
				if (ie_status_w = 1) then
					ds_result_desc_w	:= obter_valor_dominio(6, 'S');
				elsif (ie_status_w = 3) then
					ds_result_desc_w	:= obter_valor_dominio(6, 'N');
				end if;	
			end if;	

			if (coalesce(ds_result_desc_w::text, '') = '') then
				ds_result_desc_w := vl_resultado_p;
				if (coalesce(ds_result_desc_w::text, '') = '') then
					ds_result_desc_w := ds_resultado_p;
					if (coalesce(ds_result_desc_w::text, '') = '') then
						ds_result_desc_w := pkg_date_formaters_tz.to_varchar(dt_resultado_p,'shortDate',establishment_timezone_utils.gettimezone);
					end if;
				end if;
			end if;
			
			update	w_apap_pac_registro
			set		vl_resultado	=	vl_resultado_p,
					ds_resultado	=	ds_resultado_p,
					dt_resultado	= 	dt_resultado_p,
					ds_result_desc  = 	coalesce(ds_result_desc_p,ds_result_desc_w),
                    dt_registro     =   coalesce(dt_registro_p, dt_registro)
			where	nr_sequencia	= 	nr_seq_registro_p;
			nr_seq_registro_w := nr_seq_registro_p;

		end if;	
		nr_seq_registro_p := duplicate_register_houdini(nr_seq_registro_p);
	end	if;	
else
	select	max(a.nr_seq_apap_inf)
	into STRICT	nr_seq_linha_w
	from	w_apap_pac_registro a
	where 	a.nr_sequencia		=	nr_seq_registro_p;
	
	delete	FROM w_apap_pac_registro
	where	nr_sequencia	=	nr_seq_registro_p
	and (coalesce(nr_seq_origem::text, '') = '' OR IE_STATUS_HOUDINI = 'L');
	nr_seq_registro_p := 0;
end if;

commit;

CALL apap_atualiza_linha_pai(0,coalesce(nr_seq_linha_p,nr_seq_linha_w));


select	max(ds_cor)
into STRICT	ds_cor_alerta_p
from	w_apap_pac_registro
where	nr_sequencia = nr_seq_registro_w;

end	;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE apap_executa_registros (nr_seq_linha_p bigint, dt_registro_p timestamp, vl_resultado_p bigint, ds_resultado_p text, dt_resultado_p timestamp, ie_delete_p text default 'N', DS_RESULT_DESC_P text default null, NR_SEQ_ORIGEM_P bigint default null, nr_seq_registro_p INOUT bigint DEFAULT NULL, ds_cor_alerta_p INOUT text  DEFAULT NULL) FROM PUBLIC;

