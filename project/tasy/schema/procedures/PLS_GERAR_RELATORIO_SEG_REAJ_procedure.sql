-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_gerar_relatorio_seg_reaj ( nm_usuario_p text) AS $body$
DECLARE


vl_preco_ant_w		double precision;
vl_preco_atual_w	double precision;
vl_preco_anterior_w	double precision;
nr_seq_segurado_w	bigint;
cd_motivo_reajuste_w	varchar(1);
nr_seq_seg_preco_w	bigint;
qt	bigint;
ie	varchar(1);

C01 CURSOR FOR
	SELECT	nr_sequencia
	from	pls_segurado
	where	(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
	and (coalesce(dt_rescisao::text, '') = '' or ((dt_rescisao IS NOT NULL AND dt_rescisao::text <> '') and coalesce(dt_reativacao,dt_rescisao) > dt_rescisao));

C02 CURSOR FOR
	SELECT	vl_preco_ant,
		vl_preco_atual,
		cd_motivo_reajuste,
		nr_sequencia
	from	pls_segurado_preco
	where	nr_seq_segurado = nr_seq_segurado_w
	order by nr_sequencia;


BEGIN

delete	from	w_pls_importacao;

qt	:= 0;
open C01;
loop
fetch C01 into
	nr_seq_segurado_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	ie	:= 'N';
	open C02;
	loop
	fetch C02 into
		vl_preco_ant_w,
		vl_preco_atual_w,
		cd_motivo_reajuste_w,
		nr_seq_seg_preco_w;
	EXIT WHEN NOT FOUND; /* apply on C02 */
		begin
		if	((cd_motivo_reajuste_w not  ('C','A','P','M')) and (vl_preco_anterior_w <> vl_preco_ant_w)) then
		--qt	:= qt + 1;
		ie	:= 'S';
		end if;

		vl_preco_anterior_w	:= vl_preco_atual_w;
		end;
	end loop;
	close C02;
	if (ie = 'S') then
	insert	into	w_pls_importacao(	nr_sequencia, dt_atualizacao, nm_usuario,
				dt_atualizacao_nrec, nm_usuario_nrec, nr_seq_registro)
			values (	nextval('w_pls_importacao_seq'), clock_timestamp(), nm_usuario_p,
				clock_timestamp(), nm_usuario_p, nr_seq_segurado_w);
	qt	:= qt + 1;
	end if;
	end;
end loop;
close C01;


commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_gerar_relatorio_seg_reaj ( nm_usuario_p text) FROM PUBLIC;

