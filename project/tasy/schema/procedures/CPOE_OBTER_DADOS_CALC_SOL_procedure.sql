-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE cpoe_obter_dados_calc_sol ( cd_material_p bigint, qt_dose_p bigint, cd_unidade_medida_p text, qt_dosagem_p bigint, cd_mat_dil_p bigint, qt_dose_dil_p bigint, cd_unid_med_dil_p text, qt_volume_total_p bigint, qt_concentracao_final_p INOUT bigint, qt_horas_dose_p INOUT bigint, qt_dia_dose_p INOUT bigint) AS $body$
DECLARE

				

cd_unid_med_usua_w			varchar(30);
qt_dose_ml_w				cpoe_material.qt_dose%type;
qt_solucao_w				double precision := 0;
qt_base_solucao_w			double precision := 0;
qt_diluente_w				double precision := 0;
qt_concentracao_final_w		double precision := 0;
			

procedure calcularSolucao(	cd_material_p	bigint,
							qt_dose_p		bigint,
							cd_unid_med_p	text ) is
		
;
BEGIN		
	qt_solucao_w := obter_dose_convertida(cd_material_p, qt_dose_p, cd_unid_med_p, 'mg');
end;

procedure calcularBaseSolucao(	cd_material_p	number,
								qt_dose_p		number,
								cd_unid_med_p	varchar2 ) is

begin		
	cd_unid_med_usua_w := obter_unid_med_usua('ml');
	if (upper(cd_unid_med_p) <> upper(cd_unid_med_usua_w)) then
		qt_base_solucao_w := obter_dose_convertida(cd_material_p, qt_dose_p, cd_unid_med_p, cd_unid_med_usua_w);
	else
		qt_base_solucao_w := qt_dose_p;
	end if;
end;

procedure calcularDiluente(	cd_mat_dil_p	number,
							qt_dose_dil_p		number,
							cd_unid_med_dil_p	varchar2 ) is

begin		
	cd_unid_med_usua_w := obter_unid_med_usua('ml');
	if (upper(cd_unid_med_dil_p) <> upper(cd_unid_med_usua_w)) then
		qt_diluente_w := obter_dose_convertida(cd_mat_dil_p, qt_dose_dil_p, cd_unid_med_dil_p, cd_unid_med_usua_w);
	else
		qt_diluente_w := qt_dose_dil_p;
	end if;
end;
	
begin

if (cd_material_p IS NOT NULL AND cd_material_p::text <> '') and (qt_dose_p IS NOT NULL AND qt_dose_p::text <> '') then

	calcularSolucao(cd_material_p, qt_dose_p, cd_unidade_medida_p);
	calcularBaseSolucao(cd_material_p, qt_dose_p, cd_unidade_medida_p);
	calcularDiluente(cd_mat_dil_p, qt_dose_dil_p, cd_unid_med_dil_p);
	
	if (qt_solucao_w > 0) and (qt_volume_total_p > 0) then
		qt_concentracao_final_w := qt_solucao_w / qt_volume_total_p;
	end if;
	
	qt_concentracao_final_p := qt_concentracao_final_w;
	qt_horas_dose_p			:= qt_concentracao_final_w * qt_dosagem_p;
	qt_dia_dose_p			:= qt_horas_dose_p * 24;
	
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cpoe_obter_dados_calc_sol ( cd_material_p bigint, qt_dose_p bigint, cd_unidade_medida_p text, qt_dosagem_p bigint, cd_mat_dil_p bigint, qt_dose_dil_p bigint, cd_unid_med_dil_p text, qt_volume_total_p bigint, qt_concentracao_final_p INOUT bigint, qt_horas_dose_p INOUT bigint, qt_dia_dose_p INOUT bigint) FROM PUBLIC;

