-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE man_gerar_os_nexec_dia_testes ( nm_usuario_p text) AS $body$
DECLARE



cd_estabelecimento_w		bigint;
dt_atual_estagio_w		timestamp;
nr_seq_ordem_serv_w		bigint;
nm_usuario_exec_w		varchar(15);
nr_seq_gerencia_w		bigint	:= 12;
nr_seq_estagio_w		bigint;
ie_gerar_w			varchar(1)	:= 'N';

C01 CURSOR FOR
SELECT	a.nr_sequencia,
	a.nr_seq_estagio,
	a.nm_usuario_exec
from	man_estagio_processo b,
	man_ordem_servico a
where	b.nr_sequencia = a.nr_seq_estagio
and	b.ie_testes = 'S'
and	b.ie_acao = 3
and	b.nr_sequencia not in (231,791)
and	a.ie_status_ordem <> '3'
and	coalesce(a.dt_fim_real::text, '') = ''
and not exists (	select	1
		from	man_ordem_prev_nexec_dia x
		where	x.nr_seq_ordem_servico = a.nr_sequencia
		and	trunc(x.dt_atualizacao_nrec) = trunc(clock_timestamp())
		and	x.nr_seq_gerencia	= 12);


BEGIN


delete from man_ordem_prev_nexec_dia
where	coalesce(nr_seq_motivo::text, '') = ''
and	coalesce(ds_observacao::text, '') = ''
and	coalesce(ds_acao::text, '') = ''
and	trunc(dt_atualizacao_nrec) = trunc(clock_timestamp())
and	nr_seq_gerencia = 12;

begin
	cd_estabelecimento_w	:= wheb_usuario_pck.get_cd_estabelecimento;
exception when others then
	cd_estabelecimento_w	:= 1;
end;


open C01;
loop
fetch C01 into
	nr_seq_ordem_serv_w,
	nr_seq_estagio_w,
	nm_usuario_exec_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	ie_gerar_w	:= 'N';

	select	max(dt_atualizacao)
	into STRICT	dt_atual_estagio_w
	from	man_ordem_serv_estagio
	where	nr_seq_ordem	= nr_seq_ordem_serv_w
	and	nr_seq_estagio	= nr_seq_estagio_w;

	if (nr_seq_estagio_w = 1234) then
		begin
		if (Obter_Qt_Dia_Util_Periodo(dt_atual_estagio_w, clock_timestamp(),cd_estabelecimento_w) >= 1) then
			ie_gerar_w	:= 'S';
		end if;
		end;
	elsif (nr_seq_estagio_w in (1061,1071)) then
		begin
		if (obter_dias_entre_datas(dt_atual_estagio_w, clock_timestamp()) >= 5) then
			ie_gerar_w	:= 'S';
		end if;
		end;
	end if;
	if (ie_gerar_w = 'S') then

		insert into man_ordem_prev_nexec_dia(
			nr_sequencia,
			nr_seq_ordem_servico,
			nr_seq_gerencia,
			dt_atualizacao,
			nm_usuario,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			nr_seq_grupo_sup,
			nm_usuario_exec)
		values (	nextval('man_ordem_prev_nexec_dia_seq'),
			nr_seq_ordem_serv_w,
			nr_seq_gerencia_w,
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			null,
			nm_usuario_exec_w);
	end if;
	end;
end loop;
close C01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE man_gerar_os_nexec_dia_testes ( nm_usuario_p text) FROM PUBLIC;

