-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_obter_regra_ajuste_mat ( cd_estabelecimento_p bigint, nr_seq_prestador_p bigint, nr_seq_material_p bigint, dt_vigencia_p timestamp, ie_tipo_despesa_p text, ie_tipo_tabela_p text, nr_seq_outorgante_p bigint, nr_seq_class_prestador_p bigint, nr_seq_segurado_p bigint, nr_seq_plano_p bigint, nr_seq_contrato_p bigint, ie_tipo_contratacao_p text, nr_seq_contrato_intercambio_p bigint, ie_gravar_log_p text, nm_usuario_p text, nr_seq_mat_conta_p text, ie_tipo_intercambio_p text, sg_uf_operadora_intercambio_p text, nr_seq_categoria_p bigint, cd_convenio_p bigint, cd_categoria_p text, nr_seq_tipo_acomodacao_p bigint, nr_seq_tipo_atendimento_p bigint, nr_seq_clinica_p bigint, ie_tipo_guia_p text, ie_autorizacao_espec_p text, ie_internado_p text, nr_seq_grupo_material_p bigint, ie_tipo_segurado_p text, ie_tipo_vinculo_p text, nr_seq_tipo_prestador_p bigint, ie_preco_plano_p bigint, nr_seq_estrut_mat_p bigint, nr_seq_tipo_uso_p bigint, nr_seq_conta_p bigint, ie_pcmso_p text, dados_guia_p pls_cta_valorizacao_pck.dados_guia, dados_conta_p pls_cta_valorizacao_pck.dados_conta, dados_regra_preco_material_p INOUT pls_cta_valorizacao_pck.dados_regra_preco_material, nr_seq_uni_exec_p bigint default null, ie_regime_atendimento_p pls_conta.ie_regime_atendimento%type default null, ie_regime_atendimento_princ_p pls_conta.ie_regime_atendimento%type default null, ie_saude_ocupacional_p pls_conta.ie_saude_ocupacional%type default null) AS $body$
DECLARE


cd_material_w			pls_material.cd_material_ops%type;
dt_inicio_vigencia_w		timestamp;
tx_ajuste_w			double precision	:= 0;
tx_ajuste_ww			double precision	:= 0;
vl_negociado_w			double precision	:= 0;
vl_negociado_ww			double precision	:= 0;
ie_preco_informado_w		varchar(1)	:= 0;
tx_ajuste_pfb_w			double precision	:= 0;
tx_ajuste_pmc_neut_w		double precision	:= 0;
tx_ajuste_pmc_neg_w		double precision	:= 0;
tx_ajuste_pmc_pos_w		double precision	:= 0;
tx_ajuste_simpro_pfb_w		double precision	:= 0;
tx_ajuste_simpro_pmc_w		double precision	:= 0;
tx_ajuste_pfb_ww		double precision	:= 0;
tx_ajuste_pmc_neut_ww		double precision	:= 0;
tx_ajuste_pmc_neg_ww		double precision	:= 0;
tx_ajuste_pmc_pos_ww		double precision	:= 0;
tx_ajuste_simpro_pfb_ww		double precision	:= 0;
tx_ajuste_simpro_pmc_ww		double precision	:= 0;
cd_grupo_material_w		smallint	:= 0;
cd_subgrupo_material_w		smallint;
cd_classe_material_w		integer;
cd_grupo_w			smallint;
cd_subgrupo_w			smallint	:= 0;
cd_classe_w			integer	:= 0;
dt_fim_vigencia_w		timestamp;
ie_origem_preco_w		varchar(5);
ie_origem_preco_ww		varchar(5);
ie_tipo_material_w		varchar(3);
nr_seq_regra_w			bigint;
ie_tipo_despesa_w		varchar(2);
nr_seq_material_preco_w		bigint;
tx_ajuste_tab_propria_w		double precision;
tx_ajuste_tab_propria_ww	double precision;
nr_seq_grupo_produto_w		bigint;
nr_seq_grupo_contrato_w		bigint;
nr_seq_regra_ww			bigint;
ie_grupo_produto_w		varchar(1)	:= 'S';
ie_grupo_contrato_w		varchar(1)	:= 'S';
ie_grupo_servico_w		varchar(1)	:= 'S';
ie_grupo_material_w		varchar(1)	:= 'S';
nr_seq_estrut_mat_w		bigint;
ie_tabela_adicional_w		bigint;
ie_tabela_adicional_ww		bigint;
dt_base_fixo_w			timestamp;
dt_base_fixo_ww			timestamp;
nr_seq_grupo_uf_w               bigint;
ie_generico_w                   varchar(10)    := 'N';
ie_grupo_uf_w                   varchar(10);
nr_seq_grupo_material_w		bigint;
ie_mat_autorizacao_esp_w	varchar(10);
ds_observacao_log_w		varchar(4000);
cd_prestador_w			varchar(30);
ie_estrut_mat_w			varchar(1);
nr_seq_estrut_regra_w		bigint;
nr_seq_material_preco_ww	bigint;
nr_seq_mat_unimed_w		pls_material.nr_seq_material_unimed%type;	
nr_seq_congenere_prot_w		bigint;
ie_restringe_estab_w		varchar(2);
ie_tipo_preco_brasindice_ww	varchar(3);
ie_tipo_preco_simpro_ww		varchar(1);
ie_tipo_preco_brasindice_w	varchar(3);
ie_tipo_preco_simpro_w		varchar(1);
ie_grupo_operadora_w		varchar(1);
nr_seq_regra_grupo_oper_w	bigint;
vl_pfb_neutra_simpro_w		double precision	:= 0;
vl_pfb_positiva_simpro_w	double precision	:= 0;
vl_pfb_negativa_simpro_w	double precision	:= 0;
vl_pfb_nao_aplicavel_simpro_w	double precision	:= 0;
VL_PFB_NEUTRA_BRASINDICE_w	double precision	:= 0;
vl_pfb_positiva_brasindice_w	double precision	:= 0;
vl_pfb_negativa_brasindice_w	double precision	:= 0;
ie_tipo_ajuste_pfb_w		varchar(2);
vl_pfb_neutra_simpro_ww		double precision	:= 0;
vl_pfb_positiva_simpro_ww	double precision	:= 0;
vl_pfb_negativa_simpro_ww	double precision	:= 0;
vl_pfb_nao_aplicavel_simpro_ww	double precision	:= 0;
VL_PFB_NEUTRA_BRASINDICE_ww	double precision	:= 0;
vl_pfb_positiva_brasindice_ww	double precision	:= 0;
vl_pfb_negativa_brasindice_ww	double precision	:= 0;
ie_tipo_ajuste_pfb_ww		varchar(2);
cd_especialidade_prest_w	varchar(4000);
cd_pessoa_fisica_w		pls_prestador.cd_pessoa_fisica%type;
ie_cooperado_w			varchar(1)	:= 'N';
cd_medico_w			varchar(10);
dt_guia_w			timestamp;
dt_material_w			timestamp	:= clock_timestamp();
dt_preco_w			timestamp 	:= clock_timestamp();
qt_regra_w			bigint;
nr_seq_excecao_preco_mat_w	bigint;
nr_seq_grupo_intercambio_w	bigint;
nr_seq_congenere_w		bigint;
nr_seq_classificacao_w		bigint;
qt_excecao_preco_mat_w		bigint;
dados_prestador_prot_w		pls_cta_valorizacao_pck.dados_prestador_prot;
ie_carteira_valida_w		varchar(1);
ie_especialidade_prest_w	varchar(1);
ie_origem_protocolo_w		pls_conta_mat_v.ie_origem_protocolo%type;
cd_versao_tiss_w		pls_conta_mat_v.cd_versao_tiss%type;
ie_tipo_preco_tab_adic_w	pls_regra_preco_mat.ie_tipo_preco_tab_adic%type;
nr_seq_prest_inter_w		pls_conta_mat_v.nr_seq_prest_inter%type;
nr_seq_mat_tiss_w		pls_material.nr_sequencia%type;
cd_prestador_solic_w	        pls_regra_preco_mat.cd_prestador_solic%type;
ie_acomodacao_autorizada_w	pls_regra_preco_mat.ie_acomodacao_autorizada%type;
cd_tiss_brasindice_w		pls_material.cd_tiss_brasindice%type;
ie_restrito_w			brasindice_preco.ie_restrito%type;
dt_vigencia_w			timestamp;
ie_tipo_atendimento_reemb_w	pls_protocolo_conta.ie_tipo_atendimento%type;
nr_seq_grupo_ajuste_w		pls_material.nr_seq_grupo_ajuste%type;
pr_icms_w			pls_regra_preco_mat.pr_icms%type;
pr_icms_ww			pls_regra_preco_mat.pr_icms%type;
ie_vinc_internado_w		pls_conta.ie_vinc_internacao%type;
nr_seq_mot_reembolso_w		pls_protocolo_conta.nr_seq_mot_reembolso%type;
ie_med_oncologico_w		pls_regra_preco_mat.ie_med_oncologico%type;
qt_idade_benef_w		integer := 0;
ie_utilizar_duas_casas_w	pls_regra_preco_mat.ie_utilizar_duas_casas%type;
ie_ult_valor_fabrica_w		pls_regra_preco_mat.ie_ult_valor_fabrica%type;
ie_benef_remido_w		varchar(1);
ie_benef_remido_ok_w		varchar(1);

c01 CURSOR FOR
	SELECT	/*+ CHOOSE*/		a.nr_sequencia,
		a.dt_inicio_vigencia,
		a.dt_fim_vigencia,
		a.tx_ajuste,
		a.tx_ajuste_pfb,
		a.tx_ajuste_pmc_neut,
		a.tx_ajuste_pmc_neg,
		a.tx_ajuste_pmc_pos,
		a.tx_ajuste_simpro_pfb,
		a.tx_ajuste_simpro_pmc,
		a.ie_origem_preco,
		coalesce(a.vl_negociado,0) vl_negociado,
		a.nr_seq_material_preco,
		a.tx_ajuste_tab_propria,
		a.nr_seq_grupo_produto,
		a.nr_seq_grupo_contrato,
		a.ie_tabela_adicional,
		a.dt_base_fixo,
		a.nr_seq_grupo_uf,
		a.ie_mat_autorizacao_esp,
		a.nr_seq_grupo_material,
		a.nr_seq_estrutura_mat,
		a.ie_tipo_preco_simpro,
		a.ie_tipo_preco_brasindice,
		a.nr_seq_grupo_operadora,
		a.vl_pfb_neutra_simpro,
		a.vl_pfb_positiva_simpro,
		a.vl_pfb_negativa_simpro,
		a.vl_pfb_nao_aplicavel_simpro,
		a.VL_PFB_NEUTRA_BRASINDICE,
		a.vl_pfb_positiva_brasindice,
		a.vl_pfb_negativa_brasindice,
		a.ie_tipo_ajuste_pfb,
		a.nr_seq_regra_atend_cart,
		a.cd_especialidade_prest,
		a.ie_tipo_preco_tab_adic,
		a.cd_versao_tiss,
		a.ie_acomodacao_autorizada,
		a.pr_icms,
		coalesce(a.ie_utilizar_duas_casas,'N') ie_utilizar_duas_casas,
		coalesce(a.ie_ult_valor_fabrica,'N') ie_ult_valor_fabrica,
		coalesce(a.ie_gerar_remido,'N') ie_gerar_remido		
	from	pls_regra_preco_mat a
	where	((ie_restringe_estab_w	= 'N')	or (coalesce(ie_restringe_estab_w::text, '') = '')
	or (a.cd_estabelecimento = cd_estabelecimento_p))
	--Prestador executor
	
	and	((coalesce(a.nr_seq_prestador::text, '') = '') 	or (a.nr_seq_prestador = nr_seq_prestador_p))
	and	((coalesce(a.cd_prestador::text, '') = '') 	or (a.cd_prestador = cd_prestador_w))
	and	((coalesce(a.cd_prestador_prot::text, '') = '')	or (a.cd_prestador_prot = dados_prestador_prot_w.cd_prestador))
	and	((coalesce(a.ie_tipo_vinculo::text, '') = '')	or (a.ie_tipo_vinculo = ie_tipo_vinculo_p))
	and	((coalesce(a.nr_seq_classificacao::text, '') = '') 	or (a.nr_seq_classificacao = nr_seq_class_prestador_p))
	and	((coalesce(a.nr_seq_tipo_prestador::text, '') = '')or (a.nr_seq_tipo_prestador = nr_seq_tipo_prestador_p))
	and	((coalesce(a.nr_seq_tipo_prestador_prot::text, '') = '')or (a.nr_seq_tipo_prestador_prot = dados_prestador_prot_w.nr_seq_tipo_prestador))
	and	(coalesce(a.nr_seq_grupo_prestador::text, '') = '' 	or
		exists	(SELECT	1
			from	pls_preco_prestador x
			where	x.nr_seq_grupo	= a.nr_seq_grupo_prestador
			and	((coalesce(x.nr_seq_prestador::text, '') = '')	or (x.nr_seq_prestador		= nr_seq_prestador_p))
			and	((coalesce(x.nr_seq_classificacao::text, '') = '') or (x.nr_seq_classificacao	= nr_seq_class_prestador_p))
			)
		)
	
	and	a.ie_situacao				= 'A'
	and	dt_vigencia_p >= a.dt_inicio_vigencia
	and	((coalesce(a.dt_fim_vigencia::text, '') = '') 	or (dt_vigencia_p <= fim_dia(a.dt_fim_vigencia)))
	and	((a.ie_tipo_tabela	= ie_tipo_tabela_p)
	or	(((ie_tipo_tabela_p	= 'IP') 	or (ie_tipo_tabela_p	= 'IC'))
	and (a.ie_tipo_tabela	= 'I')) 
		or	(ie_tipo_tabela_p = 'I' AND a.ie_tipo_tabela <> 'P'))
	and	((coalesce(a.ie_tipo_despesa::text, '') = '') 	or (a.ie_tipo_despesa = ie_tipo_despesa_p))
	and	((coalesce(a.nr_seq_outorgante::text, '') = '') 	or (a.nr_seq_outorgante = nr_seq_outorgante_p))
	and	((coalesce(a.ie_tipo_segurado::text, '') = '') 	or (a.ie_tipo_segurado = ie_tipo_segurado_p))
	and	((coalesce(a.ie_preco::text, '') = '') 	or (a.ie_preco = ie_preco_plano_p))
	and	((coalesce(a.ie_tipo_contratacao::text, '') = '') 	or (a.ie_tipo_contratacao = ie_tipo_contratacao_p))
	and	((coalesce(a.nr_seq_plano::text, '') = '') 	or (a.nr_seq_plano = nr_seq_plano_p))
	and	((coalesce(a.nr_seq_material::text, '') = '') 	or (a.nr_seq_material = nr_seq_material_p))
	and	((coalesce(nr_seq_contrato::text, '') = '') 	or (nr_seq_contrato	= nr_seq_contrato_p))
	and	((coalesce(a.nr_seq_categoria::text, '') = '') 	or (a.nr_seq_categoria = nr_seq_categoria_p))
	and	((coalesce(a.cd_convenio::text, '') = '') 	or (a.cd_convenio = cd_convenio_p))
	and	((coalesce(a.cd_categoria::text, '') = '') 	or (a.cd_categoria = cd_categoria_p))
	and	((coalesce(a.nr_seq_intercambio::text, '') = '') 	or (a.nr_seq_intercambio = nr_seq_contrato_intercambio_p))
	and	((coalesce(a.ie_cooperado::text, '') = '') 	or (a.ie_cooperado = 'N') or (a.ie_cooperado	= coalesce(ie_cooperado_w,'N')))
	and	((coalesce(a.ie_pcmso::text, '') = '') 	or (a.ie_pcmso = 'N') or (a.ie_pcmso = ie_pcmso_p))
	and	((coalesce(a.nr_seq_clinica::text, '') = '')	or (a.nr_seq_clinica 	= nr_seq_clinica_p))
	and	((coalesce(a.nr_seq_tipo_uso::text, '') = '') 	or (a.nr_seq_tipo_uso 	= nr_seq_tipo_uso_p))
	and	((coalesce(a.ie_tipo_guia::text, '') = '') 	or (a.ie_tipo_guia 	= ie_tipo_guia_p))
	and     ((coalesce(a.ie_generico_unimed::text, '') = '')	or (a.ie_generico_unimed = 'N') or (a.ie_generico_unimed = ie_generico_w))
	and	((coalesce(a.ie_tipo_intercambio::text, '') = '')	or (a.ie_tipo_intercambio 	= ie_tipo_intercambio_p) or (a.ie_tipo_intercambio = 'A'))
	and	((coalesce(a.ie_internado::text, '') = '') 	or (a.ie_internado 		= ie_internado_p) or (a.ie_internado 	= 'N' ))
	and	((coalesce(a.ie_origem_protocolo::text, '') = '')	or (a.ie_origem_protocolo	= ie_origem_protocolo_w))
	--and	((a.cd_versao_tiss	is null)	or (a.cd_versao_tiss		= cd_versao_tiss_w))
	and	((coalesce(a.nr_seq_congenere::text, '') = '')	or (a.nr_seq_congenere		= nr_seq_congenere_w))
	and	((coalesce(a.nr_seq_congenere_prot::text, '') = '')or (a.nr_seq_congenere_prot 	= nr_seq_congenere_prot_w))	
	and	((coalesce(a.ie_mat_autorizacao_esp::text, '') = '')or (a.ie_mat_autorizacao_esp	= 'N') or (a.ie_mat_autorizacao_esp = ie_autorizacao_espec_p))
	and	((coalesce(a.sg_uf_operadora_intercambio::text, '') = '')or (a.sg_uf_operadora_intercambio	= sg_uf_operadora_intercambio_p))
	and	((coalesce(a.ie_ref_guia_internacao::text, '') = '')or (a.ie_ref_guia_internacao	= 'A') or (a.ie_ref_guia_internacao = ie_vinc_internado_w))
	and	((coalesce(a.nr_seq_tipo_acomodacao::text, '') = '')or (a.nr_seq_tipo_acomodacao = nr_seq_tipo_acomodacao_p))
	and	((coalesce(a.nr_seq_tipo_atendimento::text, '') = '')or (a.nr_seq_tipo_atendimento = nr_seq_tipo_atendimento_p))
	and	((coalesce(a.ie_regime_atendimento::text, '') = '') or (a.ie_regime_atendimento = ie_regime_atendimento_p))
	and	((coalesce(a.ie_saude_ocupacional::text, '') = '') or (a.ie_saude_ocupacional = ie_saude_ocupacional_p))
	and	((coalesce(a.ie_regime_atendimento_princ::text, '') = '')or (a.ie_regime_atendimento_princ   = dados_conta_p.ie_regime_atendimento))
	and	((coalesce(a.ie_atend_pcmso::text, '') = '')or (a.ie_atend_pcmso = 'A') or (a.ie_atend_pcmso		= dados_conta_p.ie_atend_pcmso))
	and	((coalesce(a.nr_seq_prestador_inter::text, '') = '')or (a.nr_seq_prestador_inter = nr_seq_prest_inter_w))
	and	((coalesce(a.nr_seq_grupo_prest_int::text, '') = '')or (pls_obter_se_grupo_prest_int(a.nr_seq_grupo_prest_int, nr_seq_prest_inter_w) = 'S'))
	and	((coalesce(a.cd_prestador_solic::text, '') = '')or (a.cd_prestador_solic	= cd_prestador_solic_w))
	and     (((coalesce(a.ie_acomodacao_autorizada::text, '') = '')or (a.ie_acomodacao_autorizada 	= 'N')) or (a.ie_acomodacao_autorizada = ie_acomodacao_autorizada_w))
	and	((coalesce(a.ie_restringe_hosp::text, '') = '')or (a.ie_restringe_hosp		= 'N') or (a.ie_restringe_hosp	= ie_restrito_w))
	and	((coalesce(a.nr_seq_tipo_atend_princ::text, '') = '')or (a.nr_seq_tipo_atend_princ   = dados_conta_p.nr_seq_tipo_atendimento))
	and	((coalesce(a.ie_tipo_atendimento::text, '') = '')or (a.ie_tipo_atendimento = 'A') or (a.ie_tipo_atendimento = ie_tipo_atendimento_reemb_w))
	and	((coalesce(a.nr_seq_grupo_ajuste::text, '') = '')or (a.nr_seq_grupo_ajuste 	= nr_seq_grupo_ajuste_w))
	and	((coalesce(a.nr_seq_mot_reembolso::text, '') = '')or (a.nr_seq_mot_reembolso 	= nr_seq_mot_reembolso_w))	
	and	((coalesce(a.ie_med_oncologico::text, '') = '')or (a.ie_med_oncologico		= 'N') or (a.ie_med_oncologico	= ie_med_oncologico_w))
	and	((coalesce(a.qt_idade_inicial::text, '') = '') or (a.qt_idade_inicial <= qt_idade_benef_w))
	and	((coalesce(a.qt_idade_final::text, '') = '') or (a.qt_idade_final >= qt_idade_benef_w))  
	and 	((coalesce(a.nr_seq_tipo_conta::text, '') = '') or (a.nr_seq_tipo_conta = dados_conta_p.nr_seq_tipo_conta))
	order by
		coalesce(a.nr_seq_material,0),
		coalesce(a.ie_mat_autorizacao_esp,'N'),
		coalesce(a.ie_tipo_guia,0),
		coalesce(a.nr_seq_prestador,0),
		coalesce(a.cd_prestador,0),
		coalesce(nr_seq_grupo_prestador,0),
		coalesce(a.nr_seq_tipo_prestador,0),
		coalesce(a.nr_seq_clinica,0),
		coalesce(a.nr_seq_tipo_atendimento,0),
		coalesce(a.ie_regime_atendimento,'z'),
		coalesce(a.ie_saude_ocupacional,'z'),		
		coalesce(a.nr_seq_tipo_acomodacao,0),
		coalesce(a.nr_seq_categoria,0),
		coalesce(a.cd_categoria,0),
		coalesce(a.sg_uf_operadora_intercambio,0) desc,
		coalesce(a.ie_tipo_despesa,0),
		coalesce(a.ie_tipo_tabela,'I'),
		coalesce(a.nr_seq_contrato,0),
		coalesce(a.nr_seq_intercambio,0),
		coalesce(a.nr_seq_grupo_material,0),
		coalesce(nr_seq_estrutura_mat,0),
		coalesce(a.ie_generico_unimed,0),
		coalesce(a.ie_restringe_hosp,'N'),
		coalesce(a.nr_seq_plano,0),
		coalesce(a.ie_tipo_contratacao,'AA') desc,
		coalesce(a.ie_preco,'0'),
		coalesce(a.ie_tipo_vinculo,0),
		coalesce(a.ie_tipo_segurado,0),
		coalesce(a.nr_seq_outorgante,0),
		coalesce(a.nr_seq_regra_atend_cart,0),
		coalesce(a.nr_seq_classificacao,0),
		coalesce(a.nr_seq_congenere_prot,0),
		coalesce(a.nr_seq_congenere,0),
		coalesce(a.ie_tipo_intercambio,0),
		coalesce(a.cd_convenio,0),
		coalesce(a.ie_internado,'AA'),
		coalesce(a.ie_pcmso,'N'),
		coalesce(a.ie_atend_pcmso,'A'),
		coalesce(a.ie_origem_protocolo,'A'),
		coalesce(a.cd_versao_tiss,'A'),
		coalesce(a.nr_seq_tipo_uso,0),
		coalesce(a.cd_especialidade_prest,0),
		coalesce(a.ie_cooperado,'N'),
		coalesce(a.nr_seq_prestador_inter,0),
		coalesce(a.nr_seq_grupo_uf, 0),
		coalesce(a.cd_prestador_solic,'A'),
		coalesce(a.ie_acomodacao_autorizada,'N'),
		coalesce(a.nr_seq_tipo_atend_princ,0),
		coalesce(a.ie_regime_atendimento_princ,'z'),
		coalesce(a.ie_tipo_atendimento,'A'),
		coalesce(a.nr_seq_grupo_ajuste, 0),
		coalesce(a.nr_seq_grupo_prest_int,0),
		coalesce(a.ie_med_oncologico,'N'),
		coalesce(a.dt_inicio_vigencia, clock_timestamp()),
		coalesce(a.nr_seq_mot_reembolso,0),
		coalesce(a.nr_seq_tipo_conta, 0);

c02 CURSOR FOR
	SELECT	/*+ CHOOSE*/		a.nr_sequencia,
		a.dt_inicio_vigencia,
		a.dt_fim_vigencia,
		a.tx_ajuste,
		a.tx_ajuste_pfb,
		a.tx_ajuste_pmc_neut,
		a.tx_ajuste_pmc_neg,
		a.tx_ajuste_pmc_pos,
		a.tx_ajuste_simpro_pfb,
		a.tx_ajuste_simpro_pmc,
		a.ie_origem_preco,
		coalesce(a.vl_negociado,0) vl_negociado,
		a.nr_seq_material_preco,
		a.tx_ajuste_tab_propria,
		a.nr_seq_grupo_produto,
		a.nr_seq_grupo_contrato,
		a.ie_tabela_adicional,
		a.dt_base_fixo,
		a.nr_seq_grupo_uf,
		a.ie_mat_autorizacao_esp,
		a.nr_seq_grupo_material,
		a.nr_seq_estrutura_mat,
		a.ie_tipo_preco_simpro,
		a.ie_tipo_preco_brasindice,
		a.nr_seq_grupo_operadora,
		a.vl_pfb_neutra_simpro,
		a.vl_pfb_positiva_simpro,
		a.vl_pfb_negativa_simpro,
		a.vl_pfb_nao_aplicavel_simpro,
		a.VL_PFB_NEUTRA_BRASINDICE,
		a.vl_pfb_positiva_brasindice,
		a.vl_pfb_negativa_brasindice,
		a.ie_tipo_ajuste_pfb,
		a.nr_seq_regra_atend_cart,
		a.cd_especialidade_prest,
		a.ie_tipo_preco_tab_adic,
		a.cd_versao_tiss,
		a.ie_acomodacao_autorizada,
		a.pr_icms,
		coalesce(a.ie_utilizar_duas_casas,'N') ie_utilizar_duas_casas,
		coalesce(a.ie_ult_valor_fabrica,'N') ie_ult_valor_fabrica,
		coalesce(a.ie_gerar_remido,'N') ie_gerar_remido
	from	pls_regra_preco_mat_v a
	where	((ie_restringe_estab_w	= 'N')	or (coalesce(ie_restringe_estab_w::text, '') = '')
	or (a.cd_estabelecimento = cd_estabelecimento_p))
	--Prestador executor
	and	((coalesce(a.nr_seq_prestador::text, '') = '') 	or (a.nr_seq_prestador = nr_seq_prestador_p))
	and	((coalesce(a.cd_prestador::text, '') = '') 	or (a.cd_prestador = cd_prestador_w))
	and	((coalesce(a.cd_prestador_prot::text, '') = '')	or (a.cd_prestador_prot = dados_prestador_prot_w.cd_prestador))
	and	((coalesce(a.ie_tipo_vinculo::text, '') = '')	or (a.ie_tipo_vinculo = ie_tipo_vinculo_p))
	and	((coalesce(a.nr_seq_classificacao::text, '') = '') 	or (a.nr_seq_classificacao = nr_seq_class_prestador_p))
	and	((coalesce(a.nr_seq_tipo_prestador::text, '') = '')or (a.nr_seq_tipo_prestador = nr_seq_tipo_prestador_p))
	and	((coalesce(a.nr_seq_tipo_prestador_prot::text, '') = '')or (a.nr_seq_tipo_prestador_prot = dados_prestador_prot_w.nr_seq_tipo_prestador))
	and	(coalesce(a.nr_seq_grupo_prestador::text, '') = '' 	or
		exists	(SELECT	1
			from	pls_preco_prestador x
			where	x.nr_seq_grupo	= a.nr_seq_grupo_prestador
			and	((coalesce(x.nr_seq_prestador::text, '') = '')	or (x.nr_seq_prestador		= nr_seq_prestador_p))
			and	((coalesce(x.nr_seq_classificacao::text, '') = '') or (x.nr_seq_classificacao	= nr_seq_class_prestador_p))
			)
		)
	and	a.ie_situacao				= 'A'
	and	dt_vigencia_p >= a.dt_inicio_vigencia
	and	((coalesce(a.dt_fim_vigencia::text, '') = '') 	or (dt_vigencia_p <= fim_dia(a.dt_fim_vigencia)))
	and	((a.ie_tipo_tabela	= ie_tipo_tabela_p)
	or	(((ie_tipo_tabela_p	= 'IP') 	or (ie_tipo_tabela_p	= 'IC'))
	and (a.ie_tipo_tabela	= 'I')))
	and	((coalesce(a.ie_tipo_despesa::text, '') = '') 	or (a.ie_tipo_despesa = ie_tipo_despesa_p))
	and	((coalesce(a.nr_seq_outorgante::text, '') = '') 	or (a.nr_seq_outorgante = nr_seq_outorgante_p))
	and	((coalesce(a.ie_tipo_segurado::text, '') = '') 	or (a.ie_tipo_segurado = ie_tipo_segurado_p))
	and	((coalesce(a.ie_preco::text, '') = '') 	or (a.ie_preco = ie_preco_plano_p))
	and	((coalesce(a.ie_tipo_contratacao::text, '') = '') 	or (a.ie_tipo_contratacao = ie_tipo_contratacao_p))
	and	((coalesce(a.nr_seq_plano::text, '') = '') 	or (a.nr_seq_plano = nr_seq_plano_p))
	and	((coalesce(a.nr_seq_material::text, '') = '') 	or (a.nr_seq_material = nr_seq_material_p))
	and	((coalesce(nr_seq_contrato::text, '') = '') 	or (nr_seq_contrato	= nr_seq_contrato_p))
	and	((coalesce(a.nr_seq_categoria::text, '') = '') 	or (a.nr_seq_categoria = nr_seq_categoria_p))
	and	((coalesce(a.cd_convenio::text, '') = '') 	or (a.cd_convenio = cd_convenio_p))
	and	((coalesce(a.cd_categoria::text, '') = '') 	or (a.cd_categoria = cd_categoria_p))
	and	((coalesce(a.nr_seq_intercambio::text, '') = '') 	or (a.nr_seq_intercambio = nr_seq_contrato_intercambio_p))
	and	((coalesce(a.ie_cooperado::text, '') = '') 	or (a.ie_cooperado = 'N') or (a.ie_cooperado	= coalesce(ie_cooperado_w,'N')))
	and	((coalesce(a.ie_pcmso::text, '') = '') 	or (a.ie_pcmso = 'N') or (a.ie_pcmso = ie_pcmso_p))
	and	((coalesce(a.nr_seq_clinica::text, '') = '')	or (a.nr_seq_clinica = nr_seq_clinica_p))
	and	((coalesce(a.nr_seq_tipo_uso::text, '') = '') 	or (a.nr_seq_tipo_uso = nr_seq_tipo_uso_p))
	and	((coalesce(a.ie_tipo_guia::text, '') = '') 	or (a.ie_tipo_guia = ie_tipo_guia_p))
	and     ((coalesce(a.ie_generico_unimed::text, '') = '')	or (a.ie_generico_unimed = 'N') or (a.ie_generico_unimed = ie_generico_w))
	and	((coalesce(a.ie_tipo_intercambio::text, '') = '')	or (a.ie_tipo_intercambio = ie_tipo_intercambio_p) or (a.ie_tipo_intercambio = 'A'))
	and	((coalesce(a.ie_internado::text, '') = '') 	or (a.ie_internado = ie_internado_p) or (a.ie_internado 	= 'N' ))
	and	((coalesce(a.nr_seq_congenere::text, '') = '')	or (a.nr_seq_congenere		= nr_seq_congenere_w))
	and	((coalesce(a.ie_origem_protocolo::text, '') = '')	or (a.ie_origem_protocolo	= ie_origem_protocolo_w))
	--and	((a.cd_versao_tiss	is null)	or (a.cd_versao_tiss	= cd_versao_tiss_w))	
	and	((coalesce(a.nr_seq_congenere_prot::text, '') = '')or (a.nr_seq_congenere_prot 	= nr_seq_congenere_prot_w))	
	and	((coalesce(a.ie_mat_autorizacao_esp::text, '') = '')or (a.ie_mat_autorizacao_esp	= 'N') or (a.ie_mat_autorizacao_esp = ie_autorizacao_espec_p))
	and	((coalesce(a.sg_uf_operadora_intercambio::text, '') = '')or (a.sg_uf_operadora_intercambio	= sg_uf_operadora_intercambio_p))
	and	((coalesce(a.nr_seq_tipo_acomodacao::text, '') = '')or (a.nr_seq_tipo_acomodacao = nr_seq_tipo_acomodacao_p))
	and	((coalesce(a.ie_ref_guia_internacao::text, '') = '')or (a.ie_ref_guia_internacao	= 'A') or (a.ie_ref_guia_internacao = ie_vinc_internado_w))
	and	((coalesce(a.nr_seq_tipo_atendimento::text, '') = '')or (a.nr_seq_tipo_atendimento = nr_seq_tipo_atendimento_p))
	and	((coalesce(a.ie_regime_atendimento::text, '') = '') or (a.ie_regime_atendimento = ie_regime_atendimento_p))
	and	((coalesce(a.ie_saude_ocupacional::text, '') = '') or (a.ie_saude_ocupacional = ie_saude_ocupacional_p))
	and	((coalesce(a.ie_regime_atendimento_princ::text, '') = '')or (a.ie_regime_atendimento_princ   = dados_conta_p.ie_regime_atendimento))
	and	((coalesce(a.ie_atend_pcmso::text, '') = '')or (a.ie_atend_pcmso = 'A') or (a.ie_atend_pcmso	= dados_conta_p.ie_atend_pcmso))
	and	((coalesce(a.nr_seq_prestador_inter::text, '') = '')or (a.nr_seq_prestador_inter = nr_seq_prest_inter_w))
	and	((coalesce(a.nr_seq_grupo_prest_int::text, '') = '')or (pls_obter_se_grupo_prest_int(a.nr_seq_grupo_prest_int, nr_seq_prest_inter_w) = 'S'))
	and	((coalesce(a.cd_prestador_solic::text, '') = '')or (a.cd_prestador_solic	= cd_prestador_solic_w))
	and     (((coalesce(a.ie_acomodacao_autorizada::text, '') = '')or (a.ie_acomodacao_autorizada = 'N')) or (a.ie_acomodacao_autorizada = ie_acomodacao_autorizada_w))
	and	((coalesce(a.ie_restringe_hosp::text, '') = '')or (a.ie_restringe_hosp		= 'N') or (a.ie_restringe_hosp	= ie_restrito_w))
	and	((coalesce(a.nr_seq_tipo_atend_princ::text, '') = '')or (a.nr_seq_tipo_atend_princ = dados_conta_p.nr_seq_tipo_atendimento))
	and	((coalesce(a.ie_tipo_atendimento::text, '') = '')or (a.ie_tipo_atendimento 	= 'A') or (a.ie_tipo_atendimento = ie_tipo_atendimento_reemb_w))
	and	((coalesce(a.nr_seq_grupo_ajuste::text, '') = '')or (a.nr_seq_grupo_ajuste 	= nr_seq_grupo_ajuste_w))
	and	((coalesce(a.nr_seq_mot_reembolso::text, '') = '')or (a.nr_seq_mot_reembolso 	= nr_seq_mot_reembolso_w))
	and	((coalesce(a.ie_med_oncologico::text, '') = '')or (a.ie_med_oncologico		= 'N') or (a.ie_med_oncologico	= ie_med_oncologico_w))
	and	((coalesce(a.qt_idade_inicial::text, '') = '') or (a.qt_idade_inicial <= qt_idade_benef_w))
	and	((coalesce(a.qt_idade_final::text, '') = '') or (a.qt_idade_final >= qt_idade_benef_w))
	and 	((coalesce(a.nr_seq_tipo_conta::text, '') = '') or (a.nr_seq_tipo_conta = dados_conta_p.nr_seq_tipo_conta));

		
BEGIN
ie_restringe_estab_w	:= pls_obter_se_controle_estab('RP');
-- OS 746968 - Utilizar a versao do TISS do material, caso nao tenha, continua com a versao do TISS do protocolo
select	(max(cd_material_ops))::numeric ,
	max(nr_seq_material_unimed),
	max(ds_versao_tiss),
	max(cd_tiss_brasindice),
	max(nr_seq_grupo_ajuste)
into STRICT	cd_material_w,
	nr_seq_mat_unimed_w,
	cd_versao_tiss_w,
	cd_tiss_brasindice_w,
	nr_seq_grupo_ajuste_w
from	pls_material
where	nr_sequencia	= nr_seq_material_p;

dt_vigencia_w := coalesce(dt_vigencia_p, clock_timestamp());
-- padrao null no inicio da execucao da rotina, para que seja usado de forma mais inteligente e otimizada
ie_benef_remido_w := null;

if (nr_seq_segurado_p IS NOT NULL AND nr_seq_segurado_p::text <> '') then
	qt_idade_benef_w := coalesce(pls_obter_dados_segurado(nr_seq_segurado_p,'ID'),0);
end if;

if (cd_tiss_brasindice_w IS NOT NULL AND cd_tiss_brasindice_w::text <> '') then

	select	max(a.ie_restrito),
		max(a.ie_oncologico)
	into STRICT	ie_restrito_w,
		ie_med_oncologico_w
	from	brasindice_preco a
	where	a.cd_tiss = cd_tiss_brasindice_w
	and	a.dt_inicio_vigencia = (SELECT max(x.dt_inicio_vigencia)
					from	brasindice_preco x
					where	x.cd_tiss = cd_tiss_brasindice_w
					and	x.dt_inicio_vigencia <= dt_vigencia_w);
end if;

select  max(ie_tipo_acomodacao )
into STRICT    ie_acomodacao_autorizada_w
from    pls_tipo_acomodacao
where   nr_sequencia    = dados_guia_p.nr_seq_tipo_acomodacao;

	
/* Obter dados do beneficiario */

select	count(1)
into STRICT	qt_excecao_preco_mat_w  
from	pls_excecao_preco_mat  
where	nr_seq_regra	= nr_seq_regra_ww;

if (qt_excecao_preco_mat_w > 0) or (coalesce(nr_seq_mat_conta_p::text, '') = '') then
	select	max(nr_seq_grupo_intercambio),
		max(nr_seq_congenere)
	into STRICT	nr_seq_grupo_intercambio_w,
		nr_seq_congenere_w
	from	pls_segurado               
	where	nr_sequencia	= nr_seq_segurado_p;
end if;

begin
	select	nr_seq_congenere_prot,
		cd_medico_executor,
		dt_atendimento_trunc,
		nr_seq_clas_prest_exec,
		cd_pessoa_fisica_prest,
		nr_seq_prestador_prot,
		cd_prestador_exec,
		nr_seq_congenere_seg,
		nr_seq_tipo_prest_prot,
		nr_seq_clas_prest_prot,
		cd_prestador_prot,
		ie_tipo_vinculo_prest_prot,
		ie_origem_protocolo,
		coalesce(cd_versao_tiss_w,cd_versao_tiss),
		nr_seq_prest_inter,
		cd_prestador_solic,
		ie_tipo_atendimento_reemb,
		ie_vinc_internado,
		nr_seq_mot_reembolso		
	into STRICT	nr_seq_congenere_prot_w,
		cd_medico_w,
		dt_material_w,
		nr_seq_classificacao_w,
		cd_pessoa_fisica_w,
		dados_prestador_prot_w.nr_seq_prestador,
		cd_prestador_w,
		nr_seq_congenere_w,
		dados_prestador_prot_w.nr_seq_tipo_prestador,
		dados_prestador_prot_w.nr_seq_classificacao,
		dados_prestador_prot_w.cd_prestador,
		dados_prestador_prot_w.ie_tipo_vinculo,
		ie_origem_protocolo_w,
		cd_versao_tiss_w,
		nr_seq_prest_inter_w,
		cd_prestador_solic_w,
		ie_tipo_atendimento_reemb_w,
		ie_vinc_internado_w,
		nr_seq_mot_reembolso_w
	from	pls_conta_mat_v
	where	nr_sequencia	= nr_seq_mat_conta_p;	
exception
when others then
	nr_seq_congenere_prot_w := null;
	dt_material_w		:= clock_timestamp();
end;


if (dados_conta_p.ie_ref_guia_internacao IS NOT NULL AND dados_conta_p.ie_ref_guia_internacao::text <> '') then
	ie_vinc_internado_w := dados_conta_p.ie_ref_guia_internacao; 	
end if;

if (coalesce(cd_prestador_w::text, '') = '') then
	select	max(cd_prestador)
	into STRICT	cd_prestador_w             
	from	pls_prestador              
	where	nr_sequencia	= nr_seq_prestador_p;
end if;

if (dados_prestador_prot_w.nr_seq_prestador IS NOT NULL AND dados_prestador_prot_w.nr_seq_prestador::text <> '') and (coalesce(nr_seq_mat_conta_p::text, '') = '') then
	select	max(nr_seq_tipo_prestador),
		max(nr_seq_classificacao),
		max(ie_tipo_vinculo),
		max(cd_prestador)
	into STRICT	dados_prestador_prot_w.nr_seq_tipo_prestador,
		dados_prestador_prot_w.nr_seq_classificacao,
		dados_prestador_prot_w.ie_tipo_vinculo,
		dados_prestador_prot_w.cd_prestador
	from	pls_prestador
	where	nr_sequencia	= dados_prestador_prot_w.nr_seq_prestador;
end if;

ie_generico_w	:= 'N';

if (coalesce(nr_seq_mat_unimed_w::text, '') = '') then
	select max(nr_sequencia)
	into STRICT	nr_seq_mat_unimed_w
	from (
		SELECT	b.nr_sequencia
		from	pls_material_a900	a,
			pls_material_unimed	b
		where	a.nr_seq_material	= nr_seq_material_p
		and	b.cd_material		= a.cd_material_a900
		and 	coalesce(a.dt_fim_vigencia::text, '') = ''
		and	a.dt_inicio_vigencia < dt_vigencia_p
		
union all

		SELECT	b.nr_sequencia
		from	pls_material_a900	a,
			pls_material_unimed	b
		where	a.nr_seq_material	= nr_seq_material_p
		and	b.cd_material		= a.cd_material_a900
		and 	a.dt_fim_vigencia > dt_vigencia_p
		and 	a.dt_inicio_vigencia < dt_vigencia_p) alias4;
end if;
if (nr_seq_mat_unimed_w IS NOT NULL AND nr_seq_mat_unimed_w::text <> '') then
	begin
		select	coalesce(ie_generico,'N')
		into STRICT	ie_generico_w
		from	pls_material_unimed a
		where	nr_sequencia	= nr_seq_mat_unimed_w;
	exception
	when others then
		ie_generico_w	:= 'N';
	end;
end if;

begin
	cd_especialidade_prest_w	:= substr(pls_obter_cod_espec_prest(nr_seq_prestador_p, cd_pessoa_fisica_w)||',',1,4000);
exception
when others then
	cd_especialidade_prest_w	:= null;
end;

if (ie_gravar_log_p = 'S') then
	ds_observacao_log_w :=	';cd_estabelecimento_p='||chr(39)||cd_estabelecimento_p||chr(39)||
		';nr_seq_prestador_p='||chr(39)||nr_seq_prestador_p||chr(39)||
		';cd_prestador_w='||chr(39)||cd_prestador_w||chr(39)||
		';ie_tipo_despesa_p='||chr(39)||ie_tipo_despesa_p||chr(39)||
		';dt_vigencia_p=to_date('||chr(39)||dt_vigencia_p||chr(39)||','||chr(39)||'dd/mm/yyyy'||chr(39)||')'||
		';ie_tipo_tabela_p='||chr(39)||ie_tipo_tabela_p||chr(39)||
		';ie_tipo_tabela_p='||chr(39)||ie_tipo_tabela_p||chr(39)||
		';nr_seq_outorgante_p='||chr(39)||nr_seq_outorgante_p||chr(39)||
		';ie_tipo_vinculo_w='||chr(39)||ie_tipo_vinculo_p||chr(39)||
		';nr_seq_class_prestador_p='||chr(39)||nr_seq_class_prestador_p||chr(39)||
		';ie_tipo_segurado_w='||chr(39)||ie_tipo_segurado_p||chr(39)||
		';ie_preco_w='||chr(39)||ie_preco_plano_p||chr(39)||
		';ie_tipo_contratacao_p='||chr(39)||ie_tipo_contratacao_p||chr(39)||
		';nr_seq_plano_p='||chr(39)||nr_seq_plano_p||chr(39)||
		';nr_seq_estrut_mat_w='||chr(39)||nr_seq_estrut_mat_w||chr(39)||
		';nr_seq_material_p='||chr(39)||nr_seq_material_p||chr(39)||
		';nr_seq_contrato_p='||chr(39)||nr_seq_contrato_p||chr(39)||
		';ie_tipo_intercambio_p='||chr(39)||ie_tipo_intercambio_p||chr(39)||
		';sg_uf_operadora_intercambio_p='||chr(39)||sg_uf_operadora_intercambio_p||chr(39)||
		';nr_seq_categoria_p='||chr(39)||nr_seq_categoria_p||chr(39)||
		';cd_convenio_p='||chr(39)||cd_convenio_p||chr(39)||
		';cd_categoria_p='||chr(39)||cd_categoria_p||chr(39)||
		';nr_seq_tipo_acomodacao_p='||chr(39)||nr_seq_tipo_acomodacao_p||chr(39)||
		';nr_seq_tipo_atendimento_p='||chr(39)||nr_seq_tipo_atendimento_p||chr(39)||
		';nr_seq_clinica_p='||chr(39)||nr_seq_clinica_p||chr(39)||
		';nr_seq_tipo_prestador_w='||chr(39)||nr_seq_tipo_prestador_p||chr(39)||
		';ie_tipo_guia_p='||chr(39)||ie_tipo_guia_p||chr(39)||
		';ie_generico_w='||chr(39)||ie_generico_w||chr(39)||
		';nr_seq_tipo_uso_p='||chr(39)||nr_seq_tipo_uso_p||chr(39)||
		';ie_internado_p='||chr(39)||ie_internado_p||chr(39)||
		';nr_seq_congenere_prot_w='||chr(39)||nr_seq_congenere_prot_w||chr(39)||
		';ie_origem_protocolo_w='||chr(39)||ie_origem_protocolo_w||chr(39)||
		';cd_versao_tiss_w='||chr(39)||cd_versao_tiss_w||chr(39)||
		';IE_MAT_AUTORIZACAO_ESP='||chr(39)||ie_autorizacao_espec_p||chr(39)||
		';nr_seq_tipo_atend_princ='||chr(39)||dados_conta_p.nr_seq_tipo_atendimento||chr(39);
			
	CALL pls_gravar_log_calculo_mat(	ie_gravar_log_p, nr_seq_mat_conta_p, cd_estabelecimento_p,
					'Inicio da definicao do preco', ds_observacao_log_w, 'pls_obter_regra_ajuste_mat',
					0, 0, 0,
					ie_tipo_tabela_p, nr_seq_material_p, nm_usuario_p);
end if;

dt_guia_w	:= trunc(clock_timestamp(),'dd');
if (cd_medico_w IS NOT NULL AND cd_medico_w::text <> '') then
	ie_cooperado_w	:= pls_obter_se_cooperado_ativo(cd_medico_w,coalesce(dt_material_w,dt_guia_w),'X');
end if;

select	count(1)
into STRICT	qt_regra_w
from	pls_regra_preco_ordem_mat
where	ie_tipo_preco = 'M'
and	((ie_tipo_tabela	= ie_tipo_tabela_p)
or	(((ie_tipo_tabela_p	= 'IP') or (ie_tipo_tabela_p	= 'IC')) and (ie_tipo_tabela	= 'I')));

if (qt_regra_w > 0) then
	for r_c02_w in C02() loop
		begin
		nr_seq_regra_ww		:= r_c02_w.nr_sequencia;
		dt_inicio_vigencia_w	:= r_c02_w.dt_inicio_vigencia;
		dt_fim_vigencia_w	:= r_c02_w.dt_fim_vigencia;
		tx_ajuste_ww		:= r_c02_w.tx_ajuste;
		tx_ajuste_pfb_ww	:= r_c02_w.tx_ajuste_pfb;
		tx_ajuste_pmc_neut_ww	:= r_c02_w.tx_ajuste_pmc_neut;
		tx_ajuste_pmc_neg_ww	:= r_c02_w.tx_ajuste_pmc_neg;
		tx_ajuste_pmc_pos_ww	:= r_c02_w.tx_ajuste_pmc_pos;
		tx_ajuste_simpro_pfb_ww	:= r_c02_w.tx_ajuste_simpro_pfb;
		tx_ajuste_simpro_pmc_ww	:= r_c02_w.tx_ajuste_simpro_pmc;
		ie_origem_preco_ww	:= r_c02_w.ie_origem_preco;
		vl_negociado_ww		:= r_c02_w.vl_negociado;
		nr_seq_material_preco_ww:= r_c02_w.nr_seq_material_preco;
		tx_ajuste_tab_propria_ww:= r_c02_w.tx_ajuste_tab_propria;
		nr_seq_grupo_produto_w	:= r_c02_w.nr_seq_grupo_produto;
		nr_seq_grupo_contrato_w	:= r_c02_w.nr_seq_grupo_contrato;
		ie_tabela_adicional_ww	:= r_c02_w.ie_tabela_adicional;
		dt_base_fixo_ww		:= r_c02_w.dt_base_fixo;
		nr_seq_grupo_uf_w	:= r_c02_w.nr_seq_grupo_uf;
		ie_mat_autorizacao_esp_w:= r_c02_w.ie_mat_autorizacao_esp;
		nr_seq_grupo_material_w	:= r_c02_w.nr_seq_grupo_material;
		nr_seq_estrut_regra_w	:= r_c02_w.nr_seq_estrutura_mat;
		ie_tipo_preco_simpro_ww	:= r_c02_w.ie_tipo_preco_simpro;
		ie_tipo_preco_brasindice_ww	:= r_c02_w.ie_tipo_preco_brasindice;
		nr_seq_regra_grupo_oper_w	:= r_c02_w.nr_seq_grupo_operadora;
		vl_pfb_neutra_simpro_ww		:= r_c02_w.vl_pfb_neutra_simpro;
		vl_pfb_positiva_simpro_ww	:= r_c02_w.vl_pfb_positiva_simpro;
		vl_pfb_negativa_simpro_ww	:= r_c02_w.vl_pfb_negativa_simpro;
		vl_pfb_nao_aplicavel_simpro_ww	:= r_c02_w.vl_pfb_nao_aplicavel_simpro;
		VL_PFB_NEUTRA_BRASINDICE_ww	:= r_c02_w.VL_PFB_NEUTRA_BRASINDICE;
		vl_pfb_positiva_brasindice_ww	:= r_c02_w.vl_pfb_positiva_brasindice;
		vl_pfb_negativa_brasindice_ww	:= r_c02_w.vl_pfb_negativa_brasindice;
		ie_tipo_ajuste_pfb_ww		:= r_c02_w.ie_tipo_ajuste_pfb;
		pr_icms_ww			:= r_c02_w.pr_icms;
				
		ie_grupo_produto_w	:= 'S';
		ie_grupo_contrato_w	:= 'S';
		ie_grupo_servico_w	:= 'S';
		ie_grupo_uf_w           := 'S';
		ie_grupo_material_w	:= 'S';
		ie_carteira_valida_w	:= 'S';
		ie_estrut_mat_w		:= 'S';
		ie_grupo_operadora_w	:= 'S';
		ie_especialidade_prest_w:= 'S';
		ie_benef_remido_ok_w	:= 'S';
		
		/* Grupo de contratos */

		if (coalesce(nr_seq_grupo_contrato_w,0) > 0) and
			((coalesce(nr_seq_contrato_p,0) > 0)	or (coalesce(nr_seq_contrato_intercambio_p,0) > 0)) then
			ie_grupo_contrato_w	:= pls_se_grupo_preco_contrato(nr_seq_grupo_contrato_w, nr_seq_contrato_p, nr_seq_contrato_intercambio_p);
		elsif (coalesce(nr_seq_grupo_contrato_w,0) > 0) then
			ie_grupo_contrato_w	:= 'N';
		end if;	
					
		if (nr_seq_estrut_regra_w IS NOT NULL AND nr_seq_estrut_regra_w::text <> '') and (ie_grupo_contrato_w 	= 'S') then
			ie_estrut_mat_w	:= pls_obter_se_mat_estrutura(nr_seq_material_p, nr_seq_estrut_regra_w);
		end if;
		
		nr_seq_mat_tiss_w := null;
		if (r_c02_w.cd_versao_tiss IS NOT NULL AND r_c02_w.cd_versao_tiss::text <> '') then
			 nr_seq_mat_tiss_w := pls_obter_mat_tiss_vigente( nr_seq_mat_tiss_w, clock_timestamp(), nr_seq_material_p, 'S', 'N', r_c02_w.cd_versao_tiss);
		end if;
		
		if (ie_estrut_mat_w 	= 'S') and (ie_grupo_contrato_w 	= 'S') and
			((coalesce(r_c02_w.cd_versao_tiss::text, '') = '') or (nr_seq_mat_tiss_w IS NOT NULL AND nr_seq_mat_tiss_w::text <> '')) then
			if (coalesce(nr_seq_grupo_uf_w,0) > 0) then
				ie_grupo_uf_w	:= pls_obter_se_grupo_uf(nr_seq_grupo_uf_w, sg_uf_operadora_intercambio_p);
			end if;
						
			if (ie_grupo_uf_w = 'S') then

				/* Grupo de produtos */

				if (coalesce(nr_seq_grupo_produto_w,0) > 0) then
					ie_grupo_produto_w	:= pls_se_grupo_preco_produto(nr_seq_grupo_produto_w, nr_seq_plano_p);
				end if;
				
				if (ie_grupo_produto_w = 'S') then
					
					if (ie_grupo_contrato_w = 'S') then
					
						/*Grupo material*/

						if (coalesce(nr_seq_grupo_material_w,0)	<> 0) then
							ie_grupo_material_w	:= pls_se_grupo_preco_material(nr_seq_grupo_material_w, nr_seq_material_p);
						end if;
						
						if (ie_grupo_material_w = 'S') then
							if (coalesce(nr_seq_regra_grupo_oper_w,0) > 0 ) then
								ie_grupo_operadora_w := pls_se_grupo_preco_operadora(nr_seq_regra_grupo_oper_w,coalesce(nr_seq_uni_exec_p,coalesce(nr_seq_congenere_w,nr_seq_congenere_prot_w)));
							end if;
							
							if (ie_grupo_operadora_w	= 'S') then
								if (r_c02_w.nr_seq_regra_atend_cart IS NOT NULL AND r_c02_w.nr_seq_regra_atend_cart::text <> '') then
									ie_carteira_valida_w	:= pls_valida_regra_cart(nr_seq_segurado_p, r_c02_w.nr_seq_regra_atend_cart);
								end if;
								
								if (ie_grupo_operadora_w	= 'S') then
									if (r_c02_w.cd_especialidade_prest	> 0) then
										if	not(cd_especialidade_prest_w like('%'||r_c02_w.cd_especialidade_prest||',%')) then
											ie_especialidade_prest_w	:= 'N';
										end if;
									end if;
								end if;
							end if;
						end if;
					end if;
				end if;
				
				-- se a regra deve limitar aos benef remidos
				if (r_c02_w.ie_gerar_remido = 'S') then
				
					-- aqui verifica se ja buscado se o benef e remido, como a execucao desta rotina e feita por procedimento, entao so precisa levantar essa informacao uma unica vez
					if (coalesce(ie_benef_remido_w::text, '') = '') then
					
						ie_benef_remido_w := pls_obter_se_benef_remido(nr_seq_segurado_p, coalesce(dt_material_w, dt_guia_w));
					end if;
					
					ie_benef_remido_ok_w := ie_benef_remido_w;
				end if;
				

				if (ie_grupo_servico_w		= 'S') and (ie_grupo_contrato_w		= 'S') and (ie_grupo_produto_w		= 'S') and (ie_grupo_material_w		= 'S') and (ie_grupo_operadora_w   	= 'S') and (ie_carteira_valida_w		= 'S') and (ie_especialidade_prest_w 	= 'S') and (ie_benef_remido_ok_w		= 'S') then
					
					nr_seq_excecao_preco_mat_w	:= 0;
				
					select	count(1)
					into STRICT	qt_excecao_preco_mat_w  
					from	pls_excecao_preco_mat  
					where	nr_seq_regra	= nr_seq_regra_ww;
					
					if (qt_excecao_preco_mat_w > 0) then      
						nr_seq_excecao_preco_mat_w := pls_obter_excecao_preco_mat(	nr_seq_regra_ww, cd_material_w, nr_seq_material_p, dt_vigencia_w, ie_preco_plano_p, ie_tipo_contratacao_p, ie_tipo_segurado_p, nr_seq_contrato_p, nr_seq_prestador_p, nr_seq_congenere_w, nr_seq_tipo_prestador_p, nr_seq_grupo_intercambio_w, nr_seq_classificacao_w, nr_seq_class_prestador_p, nr_seq_contrato_intercambio_p, nr_seq_congenere_prot_w, nr_seq_excecao_preco_mat_w, ie_origem_protocolo_w, ie_tipo_intercambio_p, dados_prestador_prot_w.nr_seq_tipo_prestador, dados_conta_p.nr_seq_tipo_atendimento, ie_tipo_despesa_p, nr_seq_prest_inter_w, dados_conta_p.ie_regime_atendimento, dados_conta_p.ie_saude_ocupacional);
					end if;
					
					if (coalesce(nr_seq_excecao_preco_mat_w,0)	= 0) then                      	
						nr_seq_regra_w			:= nr_seq_regra_ww;
						ie_origem_preco_w		:= ie_origem_preco_ww;
						nr_seq_material_preco_w 	:= nr_seq_material_preco_ww;
						tx_ajuste_w			:= tx_ajuste_ww;
						tx_ajuste_pfb_w 		:= tx_ajuste_pfb_ww;
						tx_ajuste_pmc_neut_w		:= tx_ajuste_pmc_neut_ww;
						tx_ajuste_pmc_neg_w		:= tx_ajuste_pmc_neg_ww;
						tx_ajuste_pmc_pos_w		:= tx_ajuste_pmc_pos_ww;
						tx_ajuste_simpro_pfb_w		:= tx_ajuste_simpro_pfb_ww;
						tx_ajuste_simpro_pmc_w		:= tx_ajuste_simpro_pmc_ww;
						ie_tipo_preco_brasindice_w	:= ie_tipo_preco_brasindice_ww;
						ie_tipo_preco_simpro_w		:= ie_tipo_preco_simpro_ww;
						vl_pfb_neutra_simpro_w		:= vl_pfb_neutra_simpro_ww;
						vl_pfb_positiva_simpro_w	:= vl_pfb_positiva_simpro_ww;
						vl_pfb_negativa_simpro_w	:= vl_pfb_negativa_simpro_ww;
						vl_pfb_nao_aplicavel_simpro_w	:= vl_pfb_nao_aplicavel_simpro_ww;
						vl_pfb_neutra_brasindice_w	:= vl_pfb_neutra_brasindice_ww;
						vl_pfb_positiva_brasindice_w	:= vl_pfb_positiva_brasindice_ww;
						vl_pfb_negativa_brasindice_w	:= vl_pfb_negativa_brasindice_ww;
						ie_tipo_ajuste_pfb_w		:= ie_tipo_ajuste_pfb_ww;
						tx_ajuste_tab_propria_w		:= tx_ajuste_tab_propria_ww;
						vl_negociado_w			:= vl_negociado_ww;
						ie_tabela_adicional_w		:= ie_tabela_adicional_ww;
						dt_base_fixo_w			:= dt_base_fixo_ww;
						ie_tipo_preco_tab_adic_w	:= r_c02_w.ie_tipo_preco_tab_adic;
						pr_icms_w			:= pr_icms_ww;
						ie_utilizar_duas_casas_w	:= r_c02_w.ie_utilizar_duas_casas;
						ie_ult_valor_fabrica_w		:= r_c02_w.ie_ult_valor_fabrica;
					end if;	
				end if;
				
			end if;
			
		end if;

		end;
	end loop;
	
else

	for r_c01_w in C01() loop
		begin

		nr_seq_regra_ww		:= r_c01_w.nr_sequencia;
		dt_inicio_vigencia_w	:= r_c01_w.dt_inicio_vigencia;
		dt_fim_vigencia_w	:= r_c01_w.dt_fim_vigencia;
		tx_ajuste_ww		:= r_c01_w.tx_ajuste;
		tx_ajuste_pfb_ww	:= r_c01_w.tx_ajuste_pfb;
		tx_ajuste_pmc_neut_ww	:= r_c01_w.tx_ajuste_pmc_neut;
		tx_ajuste_pmc_neg_ww	:= r_c01_w.tx_ajuste_pmc_neg;
		tx_ajuste_pmc_pos_ww	:= r_c01_w.tx_ajuste_pmc_pos;
		tx_ajuste_simpro_pfb_ww	:= r_c01_w.tx_ajuste_simpro_pfb;
		tx_ajuste_simpro_pmc_ww	:= r_c01_w.tx_ajuste_simpro_pmc;
		ie_origem_preco_ww	:= r_c01_w.ie_origem_preco;
		vl_negociado_ww		:= r_c01_w.vl_negociado;
		nr_seq_material_preco_ww:= r_c01_w.nr_seq_material_preco;
		tx_ajuste_tab_propria_ww:= r_c01_w.tx_ajuste_tab_propria;
		nr_seq_grupo_produto_w	:= r_c01_w.nr_seq_grupo_produto;
		nr_seq_grupo_contrato_w	:= r_c01_w.nr_seq_grupo_contrato;
		ie_tabela_adicional_ww	:= r_c01_w.ie_tabela_adicional;
		dt_base_fixo_ww		:= r_c01_w.dt_base_fixo;
		nr_seq_grupo_uf_w	:= r_c01_w.nr_seq_grupo_uf;
		ie_mat_autorizacao_esp_w:= r_c01_w.ie_mat_autorizacao_esp;
		nr_seq_grupo_material_w	:= r_c01_w.nr_seq_grupo_material;
		nr_seq_estrut_regra_w	:= r_c01_w.nr_seq_estrutura_mat;
		ie_tipo_preco_simpro_ww	:= r_c01_w.ie_tipo_preco_simpro;
		ie_tipo_preco_brasindice_ww	:= r_c01_w.ie_tipo_preco_brasindice;
		nr_seq_regra_grupo_oper_w	:= r_c01_w.nr_seq_grupo_operadora;
		vl_pfb_neutra_simpro_ww		:= r_c01_w.vl_pfb_neutra_simpro;
		vl_pfb_positiva_simpro_ww	:= r_c01_w.vl_pfb_positiva_simpro;
		vl_pfb_negativa_simpro_ww	:= r_c01_w.vl_pfb_negativa_simpro;
		vl_pfb_nao_aplicavel_simpro_ww	:= r_c01_w.vl_pfb_nao_aplicavel_simpro;
		VL_PFB_NEUTRA_BRASINDICE_ww	:= r_c01_w.VL_PFB_NEUTRA_BRASINDICE;
		vl_pfb_positiva_brasindice_ww	:= r_c01_w.vl_pfb_positiva_brasindice;
		vl_pfb_negativa_brasindice_ww	:= r_c01_w.vl_pfb_negativa_brasindice;
		ie_tipo_ajuste_pfb_ww		:= r_c01_w.ie_tipo_ajuste_pfb;
		pr_icms_ww			:= r_c01_w.pr_icms;
		
		ie_grupo_produto_w		:= 'S';
		ie_grupo_contrato_w		:= 'S';
		ie_grupo_servico_w		:= 'S';
		ie_grupo_uf_w           	:= 'S';
		ie_grupo_material_w		:= 'S';
		ie_carteira_valida_w		:= 'S';
		ie_estrut_mat_w			:= 'S';
		ie_grupo_operadora_w		:= 'S';
		ie_especialidade_prest_w	:= 'S';
		ie_benef_remido_ok_w		:= 'S';
		
		/* Grupo de contratos */

		if (coalesce(nr_seq_grupo_contrato_w,0) > 0) and
			((coalesce(nr_seq_contrato_p,0) > 0)	or (coalesce(nr_seq_contrato_intercambio_p,0) > 0)) then
			ie_grupo_contrato_w	:= pls_se_grupo_preco_contrato(nr_seq_grupo_contrato_w, nr_seq_contrato_p, nr_seq_contrato_intercambio_p);
		elsif (coalesce(nr_seq_grupo_contrato_w,0) > 0) then
			ie_grupo_contrato_w	:= 'N';
		end if;	
					
		if (nr_seq_estrut_regra_w IS NOT NULL AND nr_seq_estrut_regra_w::text <> '') and (ie_grupo_contrato_w = 'S') then
			ie_estrut_mat_w	:= pls_obter_se_mat_estrutura(nr_seq_material_p, nr_seq_estrut_regra_w);
		end if;
		
		nr_seq_mat_tiss_w := null;
		if (r_c01_w.cd_versao_tiss IS NOT NULL AND r_c01_w.cd_versao_tiss::text <> '') then
			 nr_seq_mat_tiss_w := pls_obter_mat_tiss_vigente( nr_seq_mat_tiss_w, clock_timestamp(), nr_seq_material_p, 'S', 'N', r_c01_w.cd_versao_tiss);
		end if;
		
		if (ie_estrut_mat_w = 'S') and (ie_grupo_contrato_w = 'S') and
			((coalesce(r_c01_w.cd_versao_tiss::text, '') = '') or (nr_seq_mat_tiss_w IS NOT NULL AND nr_seq_mat_tiss_w::text <> '')) then
			if (coalesce(nr_seq_grupo_uf_w,0) > 0) then
				ie_grupo_uf_w	:= pls_obter_se_grupo_uf(nr_seq_grupo_uf_w, sg_uf_operadora_intercambio_p);
			end if;
						
			if (ie_grupo_uf_w = 'S') then

				/* Grupo de produtos */

				if (coalesce(nr_seq_grupo_produto_w,0) > 0) then
					ie_grupo_produto_w	:= pls_se_grupo_preco_produto(nr_seq_grupo_produto_w, nr_seq_plano_p);
				end if;
				
				if (ie_grupo_produto_w = 'S') then

					if (ie_grupo_contrato_w = 'S') then
					
						/*Grupo material*/

						if (coalesce(nr_seq_grupo_material_w,0)	<> 0) then
							ie_grupo_material_w	:= pls_se_grupo_preco_material(nr_seq_grupo_material_w, nr_seq_material_p);
						end if;
						
						if (ie_grupo_material_w = 'S') then
							if (coalesce(nr_seq_regra_grupo_oper_w,0) > 0 ) then
								ie_grupo_operadora_w := pls_se_grupo_preco_operadora(nr_seq_regra_grupo_oper_w,coalesce(nr_seq_uni_exec_p,coalesce(nr_seq_congenere_w,nr_seq_congenere_prot_w)));
							end if;
							if (ie_grupo_operadora_w	= 'S') then
								if (r_c01_w.nr_seq_regra_atend_cart IS NOT NULL AND r_c01_w.nr_seq_regra_atend_cart::text <> '') then
									ie_carteira_valida_w	:= pls_valida_regra_cart(nr_seq_segurado_p, r_c01_w.nr_seq_regra_atend_cart);
								end if;
								
								if (ie_grupo_operadora_w	= 'S') then
									if (r_c01_w.cd_especialidade_prest	> 0) then
										if	not(cd_especialidade_prest_w like('%'||r_c01_w.cd_especialidade_prest||',%')) then
											ie_especialidade_prest_w	:= 'N';
										end if;
									end if;
								end if;
							end if;
						end if;
					end if;
				end if;
				
				-- se a regra deve limitar aos benef remidos
				if (r_c01_w.ie_gerar_remido = 'S') then
				
					-- aqui verifica se ja buscado se o benef e remido, como a execucao desta rotina e feita por procedimento, entao so precisa levantar essa informacao uma unica vez
					if (coalesce(ie_benef_remido_w::text, '') = '') then
					
						ie_benef_remido_w := pls_obter_se_benef_remido(nr_seq_segurado_p, coalesce(dt_material_w, dt_guia_w));
					end if;
					
					ie_benef_remido_ok_w := ie_benef_remido_w;
				end if;
				
				if (ie_grupo_servico_w		= 'S') and (ie_grupo_contrato_w		= 'S') and (ie_grupo_produto_w		= 'S') and (ie_grupo_material_w		= 'S') and (ie_grupo_operadora_w  	 	= 'S') and (ie_carteira_valida_w		= 'S') and (ie_especialidade_prest_w 	= 'S') and (ie_benef_remido_ok_w		= 'S') then
					
					nr_seq_excecao_preco_mat_w	:= 0;
				
					select	count(1)
					into STRICT	qt_excecao_preco_mat_w  
					from	pls_excecao_preco_mat  
					where	nr_seq_regra	= nr_seq_regra_ww;
					
					if (qt_excecao_preco_mat_w > 0) then      
						nr_seq_excecao_preco_mat_w := pls_obter_excecao_preco_mat(	nr_seq_regra_ww, cd_material_w, nr_seq_material_p, dt_vigencia_w, ie_preco_plano_p, ie_tipo_contratacao_p, ie_tipo_segurado_p, nr_seq_contrato_p, nr_seq_prestador_p, nr_seq_congenere_w, nr_seq_tipo_prestador_p, nr_seq_grupo_intercambio_w, nr_seq_classificacao_w, nr_seq_class_prestador_p, nr_seq_contrato_intercambio_p, nr_seq_congenere_prot_w, nr_seq_excecao_preco_mat_w, ie_origem_protocolo_w, ie_tipo_intercambio_p, dados_prestador_prot_w.nr_seq_tipo_prestador, dados_conta_p.nr_seq_tipo_atendimento, ie_tipo_despesa_p, nr_seq_prest_inter_w, dados_conta_p.ie_regime_atendimento, dados_conta_p.ie_saude_ocupacional);
					end if;  					
			
					if (coalesce(nr_seq_excecao_preco_mat_w,0)	= 0) then                      	
						nr_seq_regra_w			:= nr_seq_regra_ww;
						ie_origem_preco_w		:= ie_origem_preco_ww;
						nr_seq_material_preco_w 	:= nr_seq_material_preco_ww;
						tx_ajuste_w			:= tx_ajuste_ww;
						tx_ajuste_pfb_w 		:= tx_ajuste_pfb_ww;
						tx_ajuste_pmc_neut_w		:= tx_ajuste_pmc_neut_ww;
						tx_ajuste_pmc_neg_w		:= tx_ajuste_pmc_neg_ww;
						tx_ajuste_pmc_pos_w		:= tx_ajuste_pmc_pos_ww;
						tx_ajuste_simpro_pfb_w		:= tx_ajuste_simpro_pfb_ww;
						tx_ajuste_simpro_pmc_w		:= tx_ajuste_simpro_pmc_ww;
						ie_tipo_preco_brasindice_w	:= ie_tipo_preco_brasindice_ww;
						ie_tipo_preco_simpro_w		:= ie_tipo_preco_simpro_ww;
						vl_pfb_neutra_simpro_w		:= vl_pfb_neutra_simpro_ww;
						vl_pfb_positiva_simpro_w	:= vl_pfb_positiva_simpro_ww;
						vl_pfb_negativa_simpro_w	:= vl_pfb_negativa_simpro_ww;
						vl_pfb_nao_aplicavel_simpro_w	:= vl_pfb_nao_aplicavel_simpro_ww;
						vl_pfb_neutra_brasindice_w	:= vl_pfb_neutra_brasindice_ww;
						vl_pfb_positiva_brasindice_w	:= vl_pfb_positiva_brasindice_ww;
						vl_pfb_negativa_brasindice_w	:= vl_pfb_negativa_brasindice_ww;
						ie_tipo_ajuste_pfb_w		:= ie_tipo_ajuste_pfb_ww;
						tx_ajuste_tab_propria_w		:= tx_ajuste_tab_propria_ww;
						vl_negociado_w			:= vl_negociado_ww;
						ie_tabela_adicional_w		:= ie_tabela_adicional_ww;
						dt_base_fixo_w			:= dt_base_fixo_ww;
						ie_tipo_preco_tab_adic_w	:= r_c01_w.ie_tipo_preco_tab_adic;
						pr_icms_w			:= pr_icms_ww;
						ie_utilizar_duas_casas_w	:= r_c01_w.ie_utilizar_duas_casas;
						ie_ult_valor_fabrica_w		:= r_c01_w.ie_ult_valor_fabrica;
					end if;	
				end if;

			end if;
			
		end if;

		end;
	end loop;

end if;
	
if (coalesce(tx_ajuste_w,0) = 0) then
	tx_ajuste_w := 1;
end if;



if (coalesce(nr_seq_regra_w,0) = 0) then
	vl_negociado_w			:= 0;
	tx_ajuste_pfb_w			:= 0;
	tx_ajuste_pmc_neut_w		:= 0;
	tx_ajuste_pmc_neg_w		:= 0;
	tx_ajuste_pmc_pos_w		:= 0;
	tx_ajuste_simpro_pfb_w		:= 0;
	tx_ajuste_simpro_pmc_w		:= 0;
	nr_seq_material_preco_w		:= 0;
	tx_ajuste_tab_propria_w		:= 0;
	vl_pfb_neutra_simpro_w		:= 0;
	vl_pfb_positiva_simpro_w	:= 0;
	vl_pfb_negativa_simpro_w	:= 0;
	vl_pfb_nao_aplicavel_simpro_w	:= 0;
	vl_pfb_neutra_brasindice_w	:= 0;
	vl_pfb_positiva_brasindice_w	:= 0;
	vl_pfb_negativa_brasindice_w	:= 0;
	ie_tipo_ajuste_pfb_w		:= 'U';
	pr_icms_w			:= null;
	ie_utilizar_duas_casas_w	:= null;
	ie_ult_valor_fabrica_w		:= 'N';
end if;

dados_regra_preco_material_p.nr_sequencia		:= nr_seq_regra_w;
dados_regra_preco_material_p.tx_ajuste			:= tx_ajuste_w;
dados_regra_preco_material_p.vl_negociado		:= vl_negociado_w;
dados_regra_preco_material_p.tx_ajuste_pfb		:= tx_ajuste_pfb_w;
dados_regra_preco_material_p.tx_ajuste_pmc_neut		:= tx_ajuste_pmc_neut_w;
dados_regra_preco_material_p.tx_ajuste_pmc_neg		:= tx_ajuste_pmc_neg_w;
dados_regra_preco_material_p.tx_ajuste_pmc_pos		:= tx_ajuste_pmc_pos_w;
dados_regra_preco_material_p.tx_ajuste_simpro_pfb	:= tx_ajuste_simpro_pfb_w;
dados_regra_preco_material_p.tx_ajuste_simpro_pmc	:= tx_ajuste_simpro_pmc_w;
dados_regra_preco_material_p.ie_origem_preco		:= ie_origem_preco_w;
dados_regra_preco_material_p.nr_seq_material_preco	:= nr_seq_material_preco_w;
dados_regra_preco_material_p.tx_ajuste_tab_propria	:= tx_ajuste_tab_propria_w;
dados_regra_preco_material_p.ie_tabela_adicional	:= ie_tabela_adicional_w;
dados_regra_preco_material_p.dt_base_fixo		:= dt_base_fixo_w;
dados_regra_preco_material_p.ie_tipo_preco_brasindice	:= ie_tipo_preco_brasindice_w;
dados_regra_preco_material_p.ie_tipo_preco_simpro	:= ie_tipo_preco_simpro_w;
dados_regra_preco_material_p.vl_pfb_neutra_simpro	:= vl_pfb_neutra_simpro_w;
dados_regra_preco_material_p.vl_pfb_positiva_simpro	:= vl_pfb_positiva_simpro_w;
dados_regra_preco_material_p.vl_pfb_negativa_simpro	:= vl_pfb_negativa_simpro_w;
dados_regra_preco_material_p.vl_pfb_nao_aplicavel_simpro:= vl_pfb_nao_aplicavel_simpro_w;
dados_regra_preco_material_p.vl_pfb_neutra_brasindice	:= vl_pfb_neutra_brasindice_w;
dados_regra_preco_material_p.vl_pfb_positiva_brasindice	:= vl_pfb_positiva_brasindice_w;
dados_regra_preco_material_p.vl_pfb_negativa_brasindice	:= vl_pfb_negativa_brasindice_w;
dados_regra_preco_material_p.ie_tipo_ajuste_pfb		:= ie_tipo_ajuste_pfb_w;
dados_regra_preco_material_p.ie_tipo_preco_tab_adic	:= ie_tipo_preco_tab_adic_w;
dados_regra_preco_material_p.cd_versao_tiss		:= cd_versao_tiss_w;
dados_regra_preco_material_p.pr_icms			:= pr_icms_w;
dados_regra_preco_material_p.ie_utilizar_duas_casas	:= ie_utilizar_duas_casas_w;
dados_regra_preco_material_p.ie_ult_valor_fabrica	:= ie_ult_valor_fabrica_w;
		
			
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_obter_regra_ajuste_mat ( cd_estabelecimento_p bigint, nr_seq_prestador_p bigint, nr_seq_material_p bigint, dt_vigencia_p timestamp, ie_tipo_despesa_p text, ie_tipo_tabela_p text, nr_seq_outorgante_p bigint, nr_seq_class_prestador_p bigint, nr_seq_segurado_p bigint, nr_seq_plano_p bigint, nr_seq_contrato_p bigint, ie_tipo_contratacao_p text, nr_seq_contrato_intercambio_p bigint, ie_gravar_log_p text, nm_usuario_p text, nr_seq_mat_conta_p text, ie_tipo_intercambio_p text, sg_uf_operadora_intercambio_p text, nr_seq_categoria_p bigint, cd_convenio_p bigint, cd_categoria_p text, nr_seq_tipo_acomodacao_p bigint, nr_seq_tipo_atendimento_p bigint, nr_seq_clinica_p bigint, ie_tipo_guia_p text, ie_autorizacao_espec_p text, ie_internado_p text, nr_seq_grupo_material_p bigint, ie_tipo_segurado_p text, ie_tipo_vinculo_p text, nr_seq_tipo_prestador_p bigint, ie_preco_plano_p bigint, nr_seq_estrut_mat_p bigint, nr_seq_tipo_uso_p bigint, nr_seq_conta_p bigint, ie_pcmso_p text, dados_guia_p pls_cta_valorizacao_pck.dados_guia, dados_conta_p pls_cta_valorizacao_pck.dados_conta, dados_regra_preco_material_p INOUT pls_cta_valorizacao_pck.dados_regra_preco_material, nr_seq_uni_exec_p bigint default null, ie_regime_atendimento_p pls_conta.ie_regime_atendimento%type default null, ie_regime_atendimento_princ_p pls_conta.ie_regime_atendimento%type default null, ie_saude_ocupacional_p pls_conta.ie_saude_ocupacional%type default null) FROM PUBLIC;

