-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE fis_efd_define_registro ( nr_seq_regra_efd_p bigint, cd_registro_p text, ie_opcao_p text, ie_arquivo_p bigint) AS $body$
DECLARE


nr_sequencia_w		fis_efd_cad_registro.nr_sequencia%type;
nr_seq_reg_superior_w	fis_efd_cad_registro.nr_seq_reg_superior%type;
nr_seq_apres_w		fis_efd_cad_registro.nr_seq_apres%type;
cd_registro_w 		fis_efd_cad_registro.cd_registro%type;
qt_contador_w		bigint := 0;
qt_contador_aux_w	bigint := 0;
cd_encerramento_w 	varchar(10);
cd_abertura_w		varchar(10);
ie_gerar_w		varchar(1);
ie_arquivo_w		varchar(1);

-- cd_registro_p vem da fis_regra_efd_reg
-- ie_opcao_p - se o registro cd_registro_p acabou de ser marcado ou desmarcado
BEGIN

select	CASE WHEN ie_arquivo_p='1' THEN '1'  ELSE '2' END
into STRICT	ie_arquivo_w
;

if (coalesce(ie_opcao_p,'N') = 'S') then

	begin
	select	coalesce(nr_seq_reg_superior,0)
	into STRICT 	nr_seq_reg_superior_w
	from 	fis_efd_cad_registro a
	where 	a.cd_registro 	= cd_registro_p
	and	ie_arquivo	= ie_arquivo_w
	and	ie_situacao	= 'A';
	exception
	when others then
		nr_seq_reg_superior_w := 0;
	end;

	while	((coalesce(nr_seq_reg_superior_w,0)	> 0) and (qt_contador_w < 10)) loop
		begin
		select	cd_registro
		into STRICT	cd_registro_w
		from	fis_efd_cad_registro
		where	nr_sequencia = nr_seq_reg_superior_w;
		exception
		when others then
			cd_registro_w := 'X';
		end;

		if (coalesce(cd_registro_w,'X') <> 'X') then

			update	fis_regra_efd_reg a
			set	a.ie_gerar 	= 'S'
			where 	a.cd_registro 	= cd_registro_w
			and	nr_seq_regra_efd = nr_seq_regra_efd_p;

			begin
			select	coalesce(nr_seq_reg_superior,0)
			into STRICT 	nr_seq_reg_superior_w
			from 	fis_efd_cad_registro a
			where 	a.cd_registro 	= cd_registro_w
			and	ie_arquivo	= ie_arquivo_w
			and	ie_situacao	= 'A';

			exception
			when others then
				nr_seq_reg_superior_w := 0;
			end;

			qt_contador_w := qt_contador_w + 1;
		else
			nr_seq_reg_superior_w := 0;
		end if;

	end loop;

elsif (coalesce(ie_opcao_p,'N') = 'N') then

	select	nr_sequencia
	into STRICT	nr_seq_reg_superior_w
	from	fis_efd_cad_registro
	where	cd_registro = cd_registro_p
	and	ie_arquivo = ie_arquivo_w;

	qt_contador_aux_w := fis_efd_desmarcar_reg(nr_seq_regra_efd_p, nr_seq_reg_superior_w, qt_contador_aux_w);

end if;

select 	max(a.cd_registro)
into STRICT 	cd_encerramento_w
from   	fis_regra_efd_reg a
where 	substr(a.cd_registro,1,1) 	= substr(cd_registro_p,1,1);

select 	min(a.cd_registro)
into STRICT 	cd_abertura_w
from   	fis_regra_efd_reg a
where 	substr(a.cd_registro,1,1) 	= substr(cd_registro_p,1,1);

select 	max(a.ie_gerar)
into STRICT 	ie_gerar_w
from   	fis_regra_efd_reg a
where 	a.cd_registro 	= cd_abertura_w;

update	fis_regra_efd_reg a
set	a.ie_gerar = ie_gerar_w
where 	a.cd_registro = cd_encerramento_w;

if (ie_opcao_p = 'N') and (substr(cd_registro_p,2,length(cd_registro_p)) = '990') then

	update	fis_regra_efd_reg a
	set	a.ie_gerar = ie_opcao_p
	where 	substr(a.cd_registro,1,1) 	= substr(cd_registro_p,1,1);
end if;

if (substr(cd_registro_p,2,length(cd_registro_p)) = '001') then

	update	fis_regra_efd_reg a
	set	a.ie_gerar = ie_opcao_p
	where 	a.cd_registro = cd_encerramento_w;

end if;

if (substr(cd_registro_p,2,length(cd_registro_p)) = '990') then

	update	fis_regra_efd_reg a
	set	a.ie_gerar = ie_opcao_p
	where 	a.cd_registro = cd_abertura_w;
end if;

commit;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE fis_efd_define_registro ( nr_seq_regra_efd_p bigint, cd_registro_p text, ie_opcao_p text, ie_arquivo_p bigint) FROM PUBLIC;

