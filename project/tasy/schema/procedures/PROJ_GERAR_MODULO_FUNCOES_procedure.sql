-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE proj_gerar_modulo_funcoes (nm_usuario_p text) AS $body$
DECLARE


nr_seq_consultor_w	bigint;
cd_pessoa_fisica_w	varchar(20);
ie_tipo_consultor_w	varchar(10);
nr_seq_modulo_w		bigint;
nr_sequencia_w		bigint;

c01 CURSOR FOR
	SELECT	nr_sequencia,
		cd_pessoa_fisica,
		ie_tipo_consultor
	from	com_canal_consultor
	where	ie_funcao_exec = 'CONSULT';



c02 CURSOR FOR
	SELECT 	nr_sequencia
	from	com_cons_gest_con_mod
	where 	nr_seq_consultor = nr_seq_consultor_w
	and	nr_seq_mod_impl in (SELECT z.nr_sequencia
				     from modulo_implantacao z
				     where coalesce(z.ie_gestao,CASE WHEN ie_tipo_consultor_w='CP' THEN 'P' WHEN ie_tipo_consultor_w='CO' THEN 'O'  ELSE 'P' END ) <> CASE WHEN ie_tipo_consultor_w='CP' THEN 'P' WHEN ie_tipo_consultor_w='CO' THEN 'O'  ELSE 'P' END
				     or z.ie_situacao = 'I');

c03 CURSOR FOR
	SELECT 	a.nr_sequencia
	from	modulo_implantacao a
	where	a.ie_gestao = CASE WHEN ie_tipo_consultor_w='CP' THEN 'P' WHEN ie_tipo_consultor_w='CO' THEN 'O'  ELSE 'P' END
	and	a.ie_situacao = 'A'
	and	exists (SELECT 1 from funcao x where x.NR_SEQ_MOD_IMPL = a.nr_sequencia)
	and	a.nr_sequencia not in (select 	w.nr_seq_mod_impl
				       from 	com_cons_gest_con_mod w
				       where 	w.nr_seq_consultor = nr_seq_consultor_w);


BEGIN
open C01;
loop
fetch C01 into
	nr_seq_consultor_w,
	cd_pessoa_fisica_w,
	ie_tipo_consultor_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
		open C02;
		loop
		fetch C02 into
			nr_seq_modulo_w;
		EXIT WHEN NOT FOUND; /* apply on C02 */
			begin
				delete
				from	COM_CONS_GEST_CON_FUN
				where	nr_seq_conhecimento = nr_seq_modulo_w;

				delete
				from	com_cons_gest_con_mod
				where	nr_sequencia = nr_seq_modulo_w;
			end;
		end loop;
		close C02;

		open C03;
		loop
		fetch C03 into
			nr_seq_modulo_w;
		EXIT WHEN NOT FOUND; /* apply on C03 */
			begin
				select 	nextval('com_cons_gest_con_mod_seq')
				into STRICT	nr_sequencia_w
				;

				insert into COM_CONS_GEST_CON_MOD(nr_sequencia,
								   dt_atualizacao,
								   nm_usuario,
								   dt_atualizacao_nrec,
								   nm_usuario_nrec,
								   nr_seq_consultor,
								   nr_seq_mod_impl,
								   nr_seq_gest_con)
				values (nr_sequencia_w,
								   clock_timestamp(),
								   nm_usuario_p,
								   clock_timestamp(),
								   nm_usuario_p,
								   nr_seq_consultor_w,
								   nr_seq_modulo_w,
								   null);


			end;
		end loop;
		close C03;

		CALL gerar_funcoes_consultor(nr_seq_consultor_w);

	end;
end loop;
close C01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE proj_gerar_modulo_funcoes (nm_usuario_p text) FROM PUBLIC;

