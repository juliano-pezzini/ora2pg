-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE popular_loc_drg_w ( dt_inicio_vigencia_p timestamp, dt_fim_vigencia_p timestamp) AS $body$
DECLARE



loc_drg_ww		LOC_DRG_W%rowtype;
IMP_DRG_BELEGABTEILUNGEN_w	IMP_DRG_BELEGABTEILUNGEN%rowtype;

c01 CURSOR FOR
SELECT	*
from	IMP_DRG_HAUPTABTEILUNGEN
order by field_0;

c01_w	c01%rowtype;



BEGIN

EXECUTE 'truncate table LOC_DRG_W';

open C01;
loop
fetch C01 into
	c01_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	
	if (coalesce(c01_w.field_2::text, '') = '') then --Indica que Ã© um registro de grupo
		begin
		select	cd_grupo_proc
		into STRICT	loc_drg_ww.CD_GRUPO_PROC
		from	grupo_proc
		where	ds_grupo_proc 		= c01_w.field_1
		and	ie_origem_proced	= 15  LIMIT 1;
		
		loc_drg_ww.ds_grupo_proc := substr(c01_w.field_1,1,240);
		
		exception
		when others then

			select coalesce(max(cd_grupo_proc),0) + 1
			into STRICT   loc_drg_ww.CD_GRUPO_PROC
			from   grupo_proc;

			loc_drg_ww.ds_grupo_proc := substr(c01_w.field_1,1,240);

		end;
	else		
		loc_drg_ww.CD_DRG		:= c01_w.field_1;
		loc_drg_ww.DS_DRG		:= c01_w.field_3;
		loc_drg_ww.IE_ORIGEM_PROCED	:= 15;
		loc_drg_ww.IE_TIPO_DRG		:= c01_w.field_2;
		loc_drg_ww.QT_ESTADIA_MIN	:= c01_w.field_7;
		loc_drg_ww.QT_ESTADIA_MAX	:= c01_w.field_9;
		loc_drg_ww.QT_ESTADIA_MEDIA	:= c01_w.field_6;
		loc_drg_ww.TX_DEPARTAMENTO	:= c01_w.field_4;
		loc_drg_ww.TX_ESTADIA_MIN	:= c01_w.field_8;
		loc_drg_ww.TX_ESTADIA_MAX	:= c01_w.field_10;
		loc_drg_ww.TX_TRANSFERENCIA	:= c01_w.field_11;
		loc_drg_ww.DT_INICIO_VIGENCIA	:= to_char(dt_inicio_vigencia_p,'dd/mm/yyyy');
		loc_drg_ww.DT_FINAL_VIGENCIA	:= to_char(dt_fim_vigencia_p,'dd/mm/yyyy');

		begin
		select	*
		into STRICT	IMP_DRG_BELEGABTEILUNGEN_w
		from	IMP_DRG_BELEGABTEILUNGEN
		where	field_1	= c01_w.field_1
		and	(field_2 IS NOT NULL AND field_2::text <> '')  LIMIT 1;
		exception
		when others then
			IMP_DRG_BELEGABTEILUNGEN_w.field_1 := null;
		end;

		if (IMP_DRG_BELEGABTEILUNGEN_w.field_1 IS NOT NULL AND IMP_DRG_BELEGABTEILUNGEN_w.field_1::text <> '') then

			loc_drg_ww.TX_DEPARTAMENTO_TER 		:= IMP_DRG_BELEGABTEILUNGEN_w.field_13;
			loc_drg_ww.TX_ESTADIA_MIN_TER		:= IMP_DRG_BELEGABTEILUNGEN_w.field_10;
			loc_drg_ww.TX_ESTADIA_MAX_TER		:= IMP_DRG_BELEGABTEILUNGEN_w.field_12;
			loc_drg_ww.DT_INICIO_VIGENCIA_TER	:= to_char(dt_inicio_vigencia_p,'dd/mm/yyyy');
			loc_drg_ww.DT_FINAL_VIGENCIA_TER	:= to_char(dt_fim_vigencia_p,'dd/mm/yyyy');

			if (coalesce(IMP_DRG_BELEGABTEILUNGEN_w.field_4::text, '') = '') and (coalesce(IMP_DRG_BELEGABTEILUNGEN_w.field_5::text, '') = '') and (coalesce(IMP_DRG_BELEGABTEILUNGEN_w.field_6::text, '') = '') and (coalesce(IMP_DRG_BELEGABTEILUNGEN_w.field_7::text, '') = '') then

				insert into loc_drg_w values (loc_drg_ww.*);

			else
			
				if (IMP_DRG_BELEGABTEILUNGEN_w.field_4 IS NOT NULL AND IMP_DRG_BELEGABTEILUNGEN_w.field_4::text <> '') then
					loc_drg_ww.IE_TERCEIRO			:= 'X';
					loc_drg_ww.IE_CIRURGIAO			:= 'S';
					loc_drg_ww.IE_ANESTESISTA		:= 'N';
					loc_drg_ww.IE_ASSISTENTE		:= 'N';
					loc_drg_ww.IE_TERAPEUTA_OCUPACIONAL	:= 'N';
					loc_drg_ww.IE_PARTEIRA			:= 'N';
					loc_drg_ww.PR_FUNCAO			:= IMP_DRG_BELEGABTEILUNGEN_w.field_4;

					insert into loc_drg_w values (loc_drg_ww.*);
				end if;

				if (IMP_DRG_BELEGABTEILUNGEN_w.field_5 IS NOT NULL AND IMP_DRG_BELEGABTEILUNGEN_w.field_5::text <> '') then
					loc_drg_ww.IE_TERCEIRO			:= 'X';
					loc_drg_ww.IE_CIRURGIAO			:= 'N';
					loc_drg_ww.IE_ANESTESISTA		:= 'S';
					loc_drg_ww.IE_ASSISTENTE		:= 'S';
					loc_drg_ww.IE_TERAPEUTA_OCUPACIONAL	:= 'N';
					loc_drg_ww.IE_PARTEIRA			:= 'N';
					loc_drg_ww.PR_FUNCAO			:= IMP_DRG_BELEGABTEILUNGEN_w.field_5;

					insert into loc_drg_w values (loc_drg_ww.*);
				end if;
				
				if (IMP_DRG_BELEGABTEILUNGEN_w.field_6 IS NOT NULL AND IMP_DRG_BELEGABTEILUNGEN_w.field_6::text <> '') then
					loc_drg_ww.IE_TERCEIRO			:= 'X';
					loc_drg_ww.IE_CIRURGIAO			:= 'N';
					loc_drg_ww.IE_ANESTESISTA		:= 'N';
					loc_drg_ww.IE_ASSISTENTE		:= 'N';
					loc_drg_ww.IE_TERAPEUTA_OCUPACIONAL	:= 'S';
					loc_drg_ww.IE_PARTEIRA			:= 'S';
					loc_drg_ww.PR_FUNCAO			:= IMP_DRG_BELEGABTEILUNGEN_w.field_6;

					insert into loc_drg_w values (loc_drg_ww.*);
				end if;
				
				if (IMP_DRG_BELEGABTEILUNGEN_w.field_7 IS NOT NULL AND IMP_DRG_BELEGABTEILUNGEN_w.field_7::text <> '') then
					loc_drg_ww.IE_TERCEIRO			:= 'X';
					loc_drg_ww.IE_CIRURGIAO			:= 'N';
					loc_drg_ww.IE_ANESTESISTA		:= 'S';
					loc_drg_ww.IE_ASSISTENTE		:= 'N';
					loc_drg_ww.IE_TERAPEUTA_OCUPACIONAL	:= 'S';
					loc_drg_ww.IE_PARTEIRA			:= 'S';
					loc_drg_ww.PR_FUNCAO			:= IMP_DRG_BELEGABTEILUNGEN_w.field_7;

					insert into loc_drg_w values (loc_drg_ww.*);
				end if;

			end if;
		else
			insert into loc_drg_w values (loc_drg_ww.*);
		end if;
	end if;

end loop;
close C01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE popular_loc_drg_w ( dt_inicio_vigencia_p timestamp, dt_fim_vigencia_p timestamp) FROM PUBLIC;

