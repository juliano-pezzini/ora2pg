-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE montar_alerta_atend_conta ( cd_pessoa_fisica_p text, ie_tipo_p bigint, ds_alerta1_p INOUT text, ds_alerta2_p INOUT text) AS $body$
DECLARE


ds_cartao_w		varchar(60);
ds_obs_cadastro_w	varchar(255);
ds_observacao_w		varchar(255);
ds_classificacao_w	varchar(80);
ds_alerta_w		varchar(2000);
ds_alerta_ww		varchar(2000);
dt_inicio_vigencia_w	timestamp;
dt_final_vigencia_w	timestamp;
ie_alerta_cartao_vigente_w varchar(1);

c01 CURSOR FOR
	SELECT	a.ds_cartao,
		a.ds_observacao ds_obs_cadastro, 
		b.ds_observacao
	from   	cartao_fidelidade 	a, 
		pf_cartao_fidelidade 	b
	where  	a.nr_sequencia = b.nr_seq_cartao
	and (ie_alerta_cartao_vigente_w = 'N' or (coalesce(b.dt_fim_validade::text, '') = '') or (b.dt_fim_validade >= clock_timestamp()))
	and    	a.ie_situacao  = 'A'
	and    	cd_pessoa_fisica  = cd_pessoa_fisica_p;

c02 CURSOR FOR
	SELECT	a.ds_classificacao,
		a.ds_observacao ds_obs_cadastro, 
		b.ds_observacao
	from	classif_pessoa 	a, 
		pessoa_classif 	b
	where	a.nr_sequencia = b.nr_seq_classif
	and    	a.ie_situacao = 'A'
	and    	b.dt_inicio_vigencia <= clock_timestamp() 
	and    	obter_se_mostra_alerta_classif(67, a.nr_sequencia) = 'S'
	and    	((coalesce(b.dt_final_vigencia::text, '') = '') or (b.dt_final_vigencia >= clock_timestamp())) 
	and    	coalesce(b.dt_inativacao::text, '') = ''
	and    	b.cd_pessoa_fisica = cd_pessoa_fisica_p
	and	ie_tipo_p = 1;

C03 CURSOR FOR
	SELECT	a.ds_classificacao,
		a.ds_observacao ds_obs_cadastro, 
		b.ds_observacao,
		b.dt_inicio_vigencia, 
		b.dt_final_vigencia
	from	classif_pessoa a, 
		pessoa_classif b
	where	a.nr_sequencia = b.nr_seq_classif
	and    	a.ie_situacao = 'A'
	and    	obter_se_mostra_alerta_classif(67, a.nr_sequencia) = 'S'
	and    	coalesce(b.dt_inativacao::text, '') = ''
	and    	b.cd_pessoa_fisica = cd_pessoa_fisica_p
	and	ie_tipo_p = 2
	order by b.dt_inicio_vigencia desc;


BEGIN

ds_alerta_w := '';
ie_alerta_cartao_vigente_w := coalesce(obter_valor_param_usuario(67, 688, obter_perfil_ativo, wheb_usuario_pck.get_nm_usuario, 0), 'S');

open C01;
loop
fetch C01 into	
	ds_cartao_w,
	ds_obs_cadastro_w,
	ds_observacao_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	
	ds_alerta_w := substr(ds_alerta_w || '-> ' || ds_cartao_w || chr(10),1,2000);
	
	if (ds_observacao_w IS NOT NULL AND ds_observacao_w::text <> '') then
		ds_alerta_w := substr(ds_alerta_w || '    Observação do paciente: ' || ds_observacao_w || chr(10),1,2000);
	end if;
	
	if (ds_obs_cadastro_w IS NOT NULL AND ds_obs_cadastro_w::text <> '') then
		ds_alerta_w := substr(ds_alerta_w || '    Observação do cartão: ' || ds_obs_cadastro_w || chr(10) || chr(10) ,1,2000);
	end if;
	
	end;
end loop;
close C01;

ds_alerta1_p := ds_alerta_w;

ds_obs_cadastro_w  := '';
ds_observacao_w	   := '';
ds_alerta_ww 	   := '';	

if (ie_tipo_p = 1) then
	begin
	open C02;
	loop
	fetch C02 into	
		ds_classificacao_w,
		ds_obs_cadastro_w,
		ds_observacao_w;
	EXIT WHEN NOT FOUND; /* apply on C02 */
		begin
				
		ds_alerta_ww	:= substr(ds_alerta_ww || '-> ' || ds_classificacao_w || chr(10),1,2000);
		
		if (ds_observacao_w IS NOT NULL AND ds_observacao_w::text <> '') then
			ds_alerta_ww	:= substr(ds_alerta_ww || '    Observação do paciente: ' || ds_observacao_w || chr(10),1,2000);
		end if;

		if (ds_obs_cadastro_w IS NOT NULL AND ds_obs_cadastro_w::text <> '') then
			ds_alerta_ww	:= substr(ds_alerta_ww || '    Observação da classificação: ' || ds_obs_cadastro_w || chr(10) || chr(10),1,2000);
		end if;
		
		end;
	end loop;
	close C02;
	end;
elsif (ie_tipo_p = 2) then
	begin
	open C03;
	loop
	fetch C03 into	
		ds_classificacao_w,
		ds_obs_cadastro_w,
		ds_observacao_w,
		dt_inicio_vigencia_w,
		dt_final_vigencia_w;
	EXIT WHEN NOT FOUND; /* apply on C03 */
		begin
		
		ds_alerta_ww	:= substr(ds_alerta_ww || '-> ' || ds_classificacao_w || chr(10),1,2000);
		
		ds_alerta_ww	:= substr(ds_alerta_ww || '	Vigência Inicial: ' || dt_inicio_vigencia_w || chr(10),1,2000);
		
		ds_alerta_ww	:= substr(ds_alerta_ww || '	Vigência Final: ' || dt_final_vigencia_w || chr(10),1,2000);
		
		if (ds_observacao_w IS NOT NULL AND ds_observacao_w::text <> '') then
			ds_alerta_ww	:= substr(ds_alerta_ww || '    Observação do paciente: ' || ds_observacao_w || chr(10),1,2000);
		end if;
		
		if (ds_obs_cadastro_w IS NOT NULL AND ds_obs_cadastro_w::text <> '') then
			ds_alerta_ww	:= substr(ds_alerta_ww || '    Observação da classificação: ' || ds_obs_cadastro_w || chr(10) || chr(10) ,1,2000);
		end if;
		
		end;
	end loop;
	close C03;
	end;
end if;

ds_alerta2_p := ds_alerta_ww;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE montar_alerta_atend_conta ( cd_pessoa_fisica_p text, ie_tipo_p bigint, ds_alerta1_p INOUT text, ds_alerta2_p INOUT text) FROM PUBLIC;

