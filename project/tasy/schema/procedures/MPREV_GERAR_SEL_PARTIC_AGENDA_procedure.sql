-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE mprev_gerar_sel_partic_agenda ( nr_seq_agendamento_p bigint, nm_usuario_p text) AS $body$
DECLARE


nr_seq_turma_w		bigint;
dt_agenda_w		timestamp;
nr_seq_participante_w	bigint;

c01 CURSOR FOR
	SELECT	a.nr_seq_participante
	from	mprev_grupo_turma_partic a
	where	a.nr_seq_turma = nr_seq_turma_w
	and	dt_agenda_w between a.dt_entrada and coalesce(a.dt_saida,dt_agenda_w)
	and	/* Só gerar se ainda não foi gerado para o agendamento */
		not exists (	SELECT 	1
				from	mprev_sel_partic_agenda x
				where	x.nr_seq_agendamento = nr_seq_agendamento_p
				and	x.nr_seq_participante = a.nr_seq_participante);


BEGIN
if (nr_seq_agendamento_p IS NOT NULL AND nr_seq_agendamento_p::text <> '') then

	select	a.nr_seq_turma,
		a.dt_agenda
	into STRICT	nr_seq_turma_w,
		dt_agenda_w
	from	mprev_agendamento a
	where	a.nr_sequencia	= nr_seq_agendamento_p;

	if (nr_seq_turma_w IS NOT NULL AND nr_seq_turma_w::text <> '') then
		open C01;
		loop
		fetch C01 into
			nr_seq_participante_w;
		EXIT WHEN NOT FOUND; /* apply on C01 */
			begin
			insert into mprev_sel_partic_agenda(nr_sequencia,
				nm_usuario,
				nm_usuario_nrec,
				dt_atualizacao,
				dt_atualizacao_nrec,
				nr_seq_agendamento,
				nr_seq_participante,
				ie_selecionado,
				ie_origem,
				ie_confirmado)
			values (nextval('mprev_sel_partic_agenda_seq'),
				nm_usuario_p,
				nm_usuario_p,
				clock_timestamp(),
				clock_timestamp(),
				nr_seq_agendamento_p,
				nr_seq_participante_w,
				'N',
				'S',
				'N');
			end;
		end loop;
		close C01;
	end if;
	null;
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE mprev_gerar_sel_partic_agenda ( nr_seq_agendamento_p bigint, nm_usuario_p text) FROM PUBLIC;

