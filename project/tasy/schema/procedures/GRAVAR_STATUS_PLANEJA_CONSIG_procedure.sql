-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gravar_status_planeja_consig ( nr_seq_age_consig_p bigint, ie_linha_coluna_p text, ie_coluna_p text, nr_seq_status_p bigint, ie_opcao_p text, nr_seq_agenda_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint) AS $body$
DECLARE


/*
ie_opcao_p 			- (G) Geracao do status/ (D) Desfazer geracao do status
ie_linha_coluna_p	- (L) Linha / (C) Coluna
*/
nr_seq_agenda_w			agenda_pac_consignado.nr_seq_agenda%type;
ds_alteracao_w			varchar(4000);
ds_status_anterior_w	varchar(100);
ds_status_posterior_w	varchar(100);
solicitacao_medica_w	varchar(255);

expressao1_w	varchar(255) := obter_desc_expressao_idioma(774216, null, wheb_usuario_pck.get_nr_seq_idioma);--Desfeito o status da linha do material
BEGIN

if (coalesce(nr_seq_age_consig_p,0) > 0 ) or (coalesce(nr_seq_agenda_p,0) > 0) then
	if (ie_linha_coluna_p = 'L') then
		if (coalesce(nr_seq_agenda_p,0) > 0) then
			SELECT 	max(SUBSTR(obter_ds_status_plan_consig(nr_seq_status),1,255))
			into STRICT   	ds_status_anterior_w
			FROM   	agenda_reg_cor_plan_consig
			WHERE  	nr_seq_agenda 	= nr_seq_agenda_p
			and		ie_linha_coluna = 'L'
			AND    	dt_atualizacao = (SELECT 	MAX(dt_atualizacao)
						  FROM   	agenda_reg_cor_plan_consig
						  WHERE  	nr_seq_agenda 	= nr_seq_agenda_p
						  and		ie_linha_coluna = 'L');
		else
			SELECT 	max(SUBSTR(obter_ds_status_plan_consig(nr_seq_status),1,255))
			into STRICT   	ds_status_anterior_w
			FROM   	agenda_reg_cor_plan_consig
			WHERE  	nr_seq_age_consig 	= nr_seq_age_consig_p
			and		ie_linha_coluna 	= 'L'
			AND    	dt_atualizacao = (SELECT 	MAX(dt_atualizacao)
						  FROM   	agenda_reg_cor_plan_consig
						  WHERE  	nr_seq_age_consig 	= nr_seq_age_consig_p
						  and		ie_linha_coluna 	= 'L');
		end if;
	else
		if (coalesce(nr_seq_agenda_p,0) > 0) then
			SELECT 	max(SUBSTR(obter_ds_status_plan_consig(nr_seq_status),1,255))
			into STRICT   	ds_status_anterior_w
			FROM   	agenda_reg_cor_plan_consig
			WHERE  	nr_seq_agenda 	= nr_seq_agenda_p
			and		ie_coluna 	= ie_coluna_p
			AND    	dt_atualizacao = (SELECT 	MAX(dt_atualizacao)
						  FROM   	agenda_reg_cor_plan_consig
						  WHERE  	nr_seq_agenda 	= nr_seq_agenda_p
						  and		ie_coluna 	= ie_coluna_p);
		else
			SELECT 	max(SUBSTR(obter_ds_status_plan_consig(nr_seq_status),1,255))
			into STRICT   	ds_status_anterior_w
			FROM   	agenda_reg_cor_plan_consig
			WHERE  	nr_seq_age_consig 	= nr_seq_age_consig_p
			and		ie_coluna 		= ie_coluna_p
			AND    	dt_atualizacao = (SELECT 	MAX(dt_atualizacao)
						  FROM   	agenda_reg_cor_plan_consig
						  WHERE  	nr_seq_age_consig 	= nr_seq_age_consig_p
						  and		ie_coluna 		= ie_coluna_p);
		end if;
	end if;

	select  max(SUBSTR(obter_ds_status_plan_consig(nr_seq_status_p),1,255))
	into STRICT	ds_status_posterior_w
	;

	select 	max(nr_seq_agenda),
		max(ds_material)
	into STRICT   	nr_seq_agenda_w,
		solicitacao_medica_w
	from   	agenda_pac_consignado
	where  	nr_sequencia = nr_seq_age_consig_p;

	if (coalesce(nr_seq_agenda_w::text, '') = '') then
		nr_seq_agenda_w := nr_seq_agenda_p;
	end if;
end if;

if (ie_opcao_p = 'G') then
	if (ie_linha_coluna_p = 'L') then --------------------------> STATUS DA LINHA
		if (coalesce(ds_status_anterior_w::text, '') = '') and (ds_status_posterior_w IS NOT NULL AND ds_status_posterior_w::text <> '') then
			ds_alteracao_w	:= substr(wheb_mensagem_pck.get_texto(300760, 'DS_STATUS_POSTERIOR_W=' || ds_status_posterior_w || ';SOLICITACAO_MEDICA_W=' || solicitacao_medica_w), 1, 4000);

			if (ds_alteracao_w IS NOT NULL AND ds_alteracao_w::text <> '') then
				CALL gravar_hist_planeja_consig(nr_seq_agenda_w,'ISL',ds_alteracao_w,nm_usuario_p);
			end if;
		elsif	coalesce(ds_status_anterior_w,'XPTO') <> coalesce(ds_status_posterior_w,'XPTO') then
			ds_alteracao_w	:= substr(wheb_mensagem_pck.get_texto(300761, 'DS_STATUS_ANTERIOR_W=' || ds_status_anterior_w || ';DS_STATUS_POSTERIOR_W=' || ds_status_posterior_w ||
									';SOLICITACAO_MEDICA_W=' || solicitacao_medica_w), 1, 4000);

			if (ds_alteracao_w IS NOT NULL AND ds_alteracao_w::text <> '') then
				CALL gravar_hist_planeja_consig(nr_seq_agenda_w,'AIL',ds_alteracao_w,nm_usuario_p);
			end if;
		end if;
	else  -------------------------- > STATUS DA COLUNA
		if (coalesce(ds_status_anterior_w::text, '') = '') and (ds_status_posterior_w IS NOT NULL AND ds_status_posterior_w::text <> '') then
			if (ie_coluna_p = 'S') then --- coluna material
				ds_alteracao_w	:= substr(wheb_mensagem_pck.get_texto(300762, 'DS_STATUS_POSTERIOR_W=' || ds_status_posterior_w || ';SOLICITACAO_MEDICA_W=' || solicitacao_medica_w), 1, 4000);

				if (ds_alteracao_w IS NOT NULL AND ds_alteracao_w::text <> '') then
					CALL gravar_hist_planeja_consig(nr_seq_agenda_w,'ISC',ds_alteracao_w,nm_usuario_p);
				end if;
			elsif (ie_coluna_p = 'C') then -- Coluna compras
				ds_alteracao_w	:= substr(wheb_mensagem_pck.get_texto(300764, 'DS_STATUS_POSTERIOR_W=' || ds_status_posterior_w || ';SOLICITACAO_MEDICA_W=' || solicitacao_medica_w), 1, 4000);
				
				if (ds_alteracao_w IS NOT NULL AND ds_alteracao_w::text <> '') then
					CALL gravar_hist_planeja_consig(nr_seq_agenda_w,'ISC',ds_alteracao_w,nm_usuario_p);
				end if;
			elsif (ie_coluna_p = 'M') then -- Coluna CME
				ds_alteracao_w	:= substr(wheb_mensagem_pck.get_texto(300765, 'DS_STATUS_POSTERIOR_W=' || ds_status_posterior_w || ';SOLICITACAO_MEDICA_W=' || solicitacao_medica_w), 1, 4000);

				if (ds_alteracao_w IS NOT NULL AND ds_alteracao_w::text <> '') then
					CALL gravar_hist_planeja_consig(nr_seq_agenda_w,'ISC',ds_alteracao_w,nm_usuario_p);
				end if;
			elsif (ie_coluna_p = 'F') then -- Coluna Farmacia
				ds_alteracao_w	:= substr(wheb_mensagem_pck.get_texto(300766, 'DS_STATUS_POSTERIOR_W=' || ds_status_posterior_w || ';SOLICITACAO_MEDICA_W=' || solicitacao_medica_w), 1, 4000);

				if (ds_alteracao_w IS NOT NULL AND ds_alteracao_w::text <> '') then
					CALL gravar_hist_planeja_consig(nr_seq_agenda_w,'ISC',ds_alteracao_w,nm_usuario_p);
				end if;
			elsif (ie_coluna_p = 'R') then -- Coluna Recebimento
				ds_alteracao_w	:= substr(wheb_mensagem_pck.get_texto(300767, 'DS_STATUS_POSTERIOR_W=' || ds_status_posterior_w || ';SOLICITACAO_MEDICA_W=' || solicitacao_medica_w), 1, 4000);

				if (ds_alteracao_w IS NOT NULL AND ds_alteracao_w::text <> '') then
					CALL gravar_hist_planeja_consig(nr_seq_agenda_w,'ISC',ds_alteracao_w,nm_usuario_p);
				end if;
			elsif (ie_coluna_p = 'E') then -- Coluna Engenharia
				ds_alteracao_w	:= substr(wheb_mensagem_pck.get_texto(300768, 'DS_STATUS_POSTERIOR_W=' || ds_status_posterior_w || ';SOLICITACAO_MEDICA_W=' || solicitacao_medica_w), 1, 4000);

				if (ds_alteracao_w IS NOT NULL AND ds_alteracao_w::text <> '') then
					CALL gravar_hist_planeja_consig(nr_seq_agenda_w,'ISC',ds_alteracao_w,nm_usuario_p);
				end if;
			elsif (ie_coluna_p = 'A') then -- Coluna Agendamento
				ds_alteracao_w	:= substr(wheb_mensagem_pck.get_texto(300769, 'DS_STATUS_POSTERIOR_W=' || ds_status_posterior_w || ';SOLICITACAO_MEDICA_W=' || solicitacao_medica_w), 1, 4000);

				if (ds_alteracao_w IS NOT NULL AND ds_alteracao_w::text <> '') then
					CALL gravar_hist_planeja_consig(nr_seq_agenda_w,'ISC',ds_alteracao_w,nm_usuario_p);
				end if;
			elsif (ie_coluna_p = 'P') then -- Coluna Hora
				ds_alteracao_w	:= substr(wheb_mensagem_pck.get_texto(300772, 'DS_STATUS_POSTERIOR_W=' || ds_status_posterior_w), 1, 4000);

				if (ds_alteracao_w IS NOT NULL AND ds_alteracao_w::text <> '') then
					CALL gravar_hist_planeja_consig(nr_seq_agenda_w,'ISC',ds_alteracao_w,nm_usuario_p);
				end if;					
			end if;
		elsif	coalesce(ds_status_anterior_w,'XPTO') <> coalesce(ds_status_posterior_w,'XPTO') then
			if (ie_coluna_p = 'S') then -- coluna material
				ds_alteracao_w	:= substr(wheb_mensagem_pck.get_texto(300773, 'DS_STATUS_ANTERIOR_W=' || ds_status_anterior_w || ';DS_STATUS_POSTERIOR_W=' || ds_status_posterior_w ||
										';SOLICITACAO_MEDICA_W=' || solicitacao_medica_w), 1, 4000);

				if (ds_alteracao_w IS NOT NULL AND ds_alteracao_w::text <> '') then
					CALL gravar_hist_planeja_consig(nr_seq_agenda_w,'ASC',ds_alteracao_w,nm_usuario_p);
				end if;
			elsif (ie_coluna_p = 'C') then -- Coluna compras
				ds_alteracao_w	:= substr(wheb_mensagem_pck.get_texto(300776, 'DS_STATUS_ANTERIOR_W=' || ds_status_anterior_w || ';DS_STATUS_POSTERIOR_W=' || ds_status_posterior_w ||
										';SOLICITACAO_MEDICA_W=' || solicitacao_medica_w), 1, 4000);

				if (ds_alteracao_w IS NOT NULL AND ds_alteracao_w::text <> '') then
					CALL gravar_hist_planeja_consig(nr_seq_agenda_w,'ASC',ds_alteracao_w,nm_usuario_p);
				end if;
			elsif (ie_coluna_p = 'M') then -- Coluna CME
				ds_alteracao_w	:= substr(wheb_mensagem_pck.get_texto(300778, 'DS_STATUS_ANTERIOR_W=' || ds_status_anterior_w || ';DS_STATUS_POSTERIOR_W=' || ds_status_posterior_w ||
										';SOLICITACAO_MEDICA_W=' || solicitacao_medica_w), 1, 4000);

				if (ds_alteracao_w IS NOT NULL AND ds_alteracao_w::text <> '') then
					CALL gravar_hist_planeja_consig(nr_seq_agenda_w,'ASC',ds_alteracao_w,nm_usuario_p);
				end if;
			elsif (ie_coluna_p = 'F') then -- Coluna Farmacia
				ds_alteracao_w	:= substr(wheb_mensagem_pck.get_texto(300777, 'DS_STATUS_ANTERIOR_W=' || ds_status_anterior_w || ';DS_STATUS_POSTERIOR_W=' || ds_status_posterior_w ||
										';SOLICITACAO_MEDICA_W=' || solicitacao_medica_w), 1, 4000);

				if (ds_alteracao_w IS NOT NULL AND ds_alteracao_w::text <> '') then
					CALL gravar_hist_planeja_consig(nr_seq_agenda_w,'ASC',ds_alteracao_w,nm_usuario_p);
				end if;
			elsif (ie_coluna_p = 'R') then -- Coluna Recebimento
				ds_alteracao_w	:= substr(wheb_mensagem_pck.get_texto(300779, 'DS_STATUS_ANTERIOR_W=' || ds_status_anterior_w || ';DS_STATUS_POSTERIOR_W=' || ds_status_posterior_w ||
										';SOLICITACAO_MEDICA_W=' || solicitacao_medica_w), 1, 4000);

				if (ds_alteracao_w IS NOT NULL AND ds_alteracao_w::text <> '') then
					CALL gravar_hist_planeja_consig(nr_seq_agenda_w,'ASC',ds_alteracao_w,nm_usuario_p);
				end if;
			elsif (ie_coluna_p = 'E') then -- Coluna Engenharia
				ds_alteracao_w	:= substr(wheb_mensagem_pck.get_texto(300780, 'DS_STATUS_ANTERIOR_W=' || ds_status_anterior_w || ';DS_STATUS_POSTERIOR_W=' || ds_status_posterior_w ||
										';SOLICITACAO_MEDICA_W=' || solicitacao_medica_w), 1, 4000);

				if (ds_alteracao_w IS NOT NULL AND ds_alteracao_w::text <> '') then
					CALL gravar_hist_planeja_consig(nr_seq_agenda_w,'ASC',ds_alteracao_w,nm_usuario_p);
				end if;
			elsif (ie_coluna_p = 'A') then -- Coluna Agendamento	
				ds_alteracao_w	:= substr(wheb_mensagem_pck.get_texto(300781, 'DS_STATUS_ANTERIOR_W=' || ds_status_anterior_w || ';DS_STATUS_POSTERIOR_W=' || ds_status_posterior_w ||
										';SOLICITACAO_MEDICA_W=' || solicitacao_medica_w), 1, 4000);

				if (ds_alteracao_w IS NOT NULL AND ds_alteracao_w::text <> '') then
					CALL gravar_hist_planeja_consig(nr_seq_agenda_w,'ASC',ds_alteracao_w,nm_usuario_p);
				end if;
			elsif (ie_coluna_p = 'P') then -- Coluna Hora
				ds_alteracao_w	:= substr(wheb_mensagem_pck.get_texto(300783, 'DS_STATUS_ANTERIOR_W=' || ds_status_anterior_w || ';DS_STATUS_POSTERIOR_W=' || ds_status_posterior_w), 1, 4000);

				if (ds_alteracao_w IS NOT NULL AND ds_alteracao_w::text <> '') then
					CALL gravar_hist_planeja_consig(nr_seq_agenda_w,'ASC',ds_alteracao_w,nm_usuario_p);
				end if;		
			end if;
		end if;
	end if;
end if;

if (ie_opcao_p = 'D') then
	if (ie_linha_coluna_p = 'L') then
		if (coalesce(nr_seq_agenda_p,0) > 0) then
			delete from agenda_reg_cor_plan_consig where nr_seq_agenda = nr_seq_agenda_p and ie_linha_coluna = 'L';
		else
			delete from agenda_reg_cor_plan_consig where nr_seq_age_consig = nr_seq_age_consig_p and ie_linha_coluna = 'L';
		end if;

		if (ds_status_anterior_w IS NOT NULL AND ds_status_anterior_w::text <> '') then --- somente ira gravar historico de desfazer linha se possuir um status
			ds_alteracao_w	:=	substr(expressao1_w || ' ' ||solicitacao_medica_w,1,4000);
				if (ds_alteracao_w IS NOT NULL AND ds_alteracao_w::text <> '') then
					CALL gravar_hist_planeja_consig(nr_seq_agenda_w,'DSL',ds_alteracao_w,nm_usuario_p);
				end if;
		end if;
	else
		if (coalesce(nr_seq_agenda_p,0) > 0) then
			delete from agenda_reg_cor_plan_consig where nr_seq_agenda = nr_seq_agenda_p and ie_coluna = ie_coluna_p;
		else
			delete from agenda_reg_cor_plan_consig where nr_seq_age_consig = nr_seq_age_consig_p and ie_coluna = ie_coluna_p;
		end if;

		if (ds_status_anterior_w IS NOT NULL AND ds_status_anterior_w::text <> '') then --- somente ira gravar historico de desfazer coluna se possuir um status
			if (ie_coluna_p = 'S') then --- coluna material
				ds_alteracao_w	:= substr(wheb_mensagem_pck.get_texto(300786, 'SOLICITACAO_MEDICA_W=' || solicitacao_medica_w), 1, 4000);

				if (ds_alteracao_w IS NOT NULL AND ds_alteracao_w::text <> '') then
					CALL gravar_hist_planeja_consig(nr_seq_agenda_w,'DSC',ds_alteracao_w,nm_usuario_p);
				end if;
			elsif (ie_coluna_p = 'C') then --- coluna Compras
				ds_alteracao_w	:= substr(wheb_mensagem_pck.get_texto(300788, 'SOLICITACAO_MEDICA_W=' || solicitacao_medica_w), 1, 4000);

				if (ds_alteracao_w IS NOT NULL AND ds_alteracao_w::text <> '') then
					CALL gravar_hist_planeja_consig(nr_seq_agenda_w,'DSC',ds_alteracao_w,nm_usuario_p);
				end if;
			elsif (ie_coluna_p = 'M') then --- coluna CME
				ds_alteracao_w	:= substr(wheb_mensagem_pck.get_texto(300789, 'SOLICITACAO_MEDICA_W=' || solicitacao_medica_w), 1, 4000);

				if (ds_alteracao_w IS NOT NULL AND ds_alteracao_w::text <> '') then
					CALL gravar_hist_planeja_consig(nr_seq_agenda_w,'DSC',ds_alteracao_w,nm_usuario_p);
				end if;
			elsif (ie_coluna_p = 'F') then --- coluna Farmacia
				ds_alteracao_w	:= substr(wheb_mensagem_pck.get_texto(300789, 'SOLICITACAO_MEDICA_W=' || solicitacao_medica_w), 1, 4000);

				if (ds_alteracao_w IS NOT NULL AND ds_alteracao_w::text <> '') then
					CALL gravar_hist_planeja_consig(nr_seq_agenda_w,'DSC',ds_alteracao_w,nm_usuario_p);
				end if;
			elsif (ie_coluna_p = 'R') then -- Coluna Recebimento
				ds_alteracao_w	:= substr(wheb_mensagem_pck.get_texto(300791, 'SOLICITACAO_MEDICA_W=' || solicitacao_medica_w), 1, 4000);

				if (ds_alteracao_w IS NOT NULL AND ds_alteracao_w::text <> '') then
					CALL gravar_hist_planeja_consig(nr_seq_agenda_w,'DSC',ds_alteracao_w,nm_usuario_p);
				end if;
			elsif (ie_coluna_p = 'E') then -- Coluna Engenharia
				ds_alteracao_w	:= substr(wheb_mensagem_pck.get_texto(300792, 'SOLICITACAO_MEDICA_W=' || solicitacao_medica_w), 1, 4000);

				if (ds_alteracao_w IS NOT NULL AND ds_alteracao_w::text <> '') then
					CALL gravar_hist_planeja_consig(nr_seq_agenda_w,'DSC',ds_alteracao_w,nm_usuario_p);
				end if;
			elsif (ie_coluna_p = 'A') then -- Coluna Agendamento
				ds_alteracao_w	:= substr(wheb_mensagem_pck.get_texto(300792, 'SOLICITACAO_MEDICA_W=' || solicitacao_medica_w), 1, 4000);

				if (ds_alteracao_w IS NOT NULL AND ds_alteracao_w::text <> '') then
					CALL gravar_hist_planeja_consig(nr_seq_agenda_w,'DSC',ds_alteracao_w,nm_usuario_p);
				end if;
			elsif (ie_coluna_p = 'P') then -- Coluna Hora
				ds_alteracao_w	:= substr(wheb_mensagem_pck.get_texto(300795),1 , 4000);

				if (ds_alteracao_w IS NOT NULL AND ds_alteracao_w::text <> '') then
					CALL gravar_hist_planeja_consig(nr_seq_agenda_w,'DSC',ds_alteracao_w,nm_usuario_p);
				end if;				
			end if;
		end if;
	end if;
else
	insert	into agenda_reg_cor_plan_consig(
			nr_sequencia,
			dt_atualizacao,
			nm_usuario,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			nr_seq_age_consig,
			ie_linha_coluna,
			ie_coluna,
			nr_seq_status,
			nr_seq_agenda)
	values (	nextval('agenda_regra_cor_monta_cc_seq'),
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			nr_seq_age_consig_p,
			ie_linha_coluna_p,
			ie_coluna_p,
			nr_seq_status_p,
			nr_seq_agenda_p);
end if;
commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gravar_status_planeja_consig ( nr_seq_age_consig_p bigint, ie_linha_coluna_p text, ie_coluna_p text, nr_seq_status_p bigint, ie_opcao_p text, nr_seq_agenda_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint) FROM PUBLIC;

