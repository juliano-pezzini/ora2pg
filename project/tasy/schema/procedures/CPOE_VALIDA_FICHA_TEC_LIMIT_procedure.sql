-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE cpoe_valida_ficha_tec_limit (( nr_atendimento_p atendimento_paciente.nr_atendimento%type, nr_seq_cpoe_p cpoe_material.nr_sequencia%type, ie_tipo_item_p text, cd_material_p material.cd_material%type, qt_dose_p cpoe_material.qt_dose%type, ds_dose_diferenciada_p cpoe_material.ds_dose_diferenciada%type, cd_unidade_medida_p cpoe_material.cd_unidade_medida%type, cd_pessoa_fisica_p pessoa_fisica.cd_pessoa_fisica%type, cd_intervalo_p intervalo_prescricao.cd_intervalo%type, nr_etapas_p cpoe_material.nr_etapas%type, hr_min_aplicacao_p cpoe_material.hr_min_aplicacao%type, qt_tempo_aplicacao_p cpoe_material.qt_tempo_aplicacao%type, ie_controle_tempo_p cpoe_material.ie_controle_tempo%type, ie_tipo_solucao_p cpoe_material.ie_tipo_solucao%type, dt_inicio_p timestamp, dt_fim_p timestamp, ie_tipo_consistencia_p text, ie_duracao_p cpoe_material.ie_duracao%type, qt_hora_fase_p cpoe_material.qt_hora_fase%type, qt_dose_adicional_p cpoe_material.qt_dose_adicional%type, qt_dose_ataque_p cpoe_material.qt_dose_ataque%type, ds_horarios_p cpoe_material.ds_horarios%type, ie_urgencia_p cpoe_material.ie_urgencia%type, ie_dose_out_p OUT text, cd_unidade_medida_out_p OUT text, qt_dose_out_p OUT bigint, ds_mensagem_dose_out_p OUT text, qt_dose_atend_prescr_out_p OUT bigint, ie_justificativa_out_p OUT text) is ie_dose_diferenciada_w varchar(1) DEFAULT 'N') AS $body$
DECLARE

ds_sql_w			varchar(4000);
qt_dose_total_w		cpoe_material.qt_dose%type;
BEGIN
	ds_sql_w := ' select nvl(sum(obter_dose_convertida(a.cd_material, a.qt_dose, a.cd_unidade_medida, :cd_unidade_medida_regra_p )),0) dose_total
				  from 	cpoe_material_vig_v a,
						table(lista_pck.obter_lista_char( :cd_materiais_ficha_w )) b
				 where	b.cd_registro = a.cd_material
				   and 	a.nr_sequencia <> :nr_seq_cpoe_p ';
	if (ie_consulta_p = 'A') then
		ds_sql_w := ds_sql_w || ' and  a.nr_atendimento = ' || nr_atendimento_p;
	elsif (ie_consulta_p = 'P') then
		ds_sql_w := ds_sql_w || ' and a.cd_pessoa_fisica = ' || cd_pessoa_fisica_p;
	end if;
	
	ds_sql_w := ds_sql_w || ' and ((a.dt_liberacao is not null) or (a.nm_usuario = wheb_usuario_pck.get_nm_usuario))
				   and	a.dt_lib_suspensao is null
				   and	a.dt_suspensao is null';
				
	EXECUTE ds_sql_w into STRICT qt_dose_total_w using cd_unidade_medida_regra_p, cd_materiais_ficha_w, nr_seq_cpoe_p;
	
	return;
end;

function cpoe_obter_qt_horas_aplic
				return;
qt_hora_w	varchar2(30 char);
qt_minutos_w	varchar2(30 char);
begin

if (ie_controle_tempo_p = 'S' and qt_tempo_aplicacao_p > 0 and (ie_tipo_solucao_p = 'C' or ie_tipo_solucao_p = 'V')) then
	qt_horas_w := qt_tempo_aplicacao_p;
elsif (ie_controle_tempo_p = 'N') then
	qt_horas_w := 0;
	if (length(hr_min_aplicacao_p) > 1) then
		qt_hora_w := substr(hr_min_aplicacao_p, 0, 2);
		qt_minutos_w := '0';
		if (length(hr_min_aplicacao_p) > 4) then
			qt_minutos_w := substr(hr_min_aplicacao_p, 4, 5);
		end if;

		qt_horas_w := ((qt_horas_w)::numeric  + ((qt_minutos_w)::numeric  / 60));

	end if;
elsif (ie_controle_tempo_p = 'S' and ie_tipo_solucao_p = 'I') then
	qt_horas_w := 0;
	if (qt_hora_fase_p IS NOT NULL AND qt_hora_fase_p::text <> '') then
		qt_hora_w := substr(qt_hora_fase_p, 0, 2);
		qt_minutos_w := '0';
		if (length(qt_hora_fase_p) > 4) then
			qt_minutos_w := substr(qt_hora_fase_p, 4, 5);
		end if;

		qt_horas_w := ((qt_horas_w)::numeric  + ((qt_minutos_w)::numeric  / 60));
	end if;
end if;

return;

end;

function cpoe_obter_qt_minutos_aplic
				return;
qt_hora_w	varchar2(30 char);
qt_minutos_w	varchar2(30 char);
begin

if (ie_controle_tempo_p = 'S' and qt_tempo_aplicacao_p > 0 and (ie_tipo_solucao_p = 'C' or ie_tipo_solucao_p = 'V')) then
	qt_horas_w := qt_tempo_aplicacao_p * 60;
elsif (ie_controle_tempo_p = 'N') then
	qt_horas_w := 0;
	if (length(hr_min_aplicacao_p) > 1) then
		qt_hora_w := substr(hr_min_aplicacao_p, 0, 2);
		qt_minutos_w := '0';

		if (length(hr_min_aplicacao_p) > 4) then
			qt_minutos_w := substr(hr_min_aplicacao_p, 4, 5);
		end if;

		qt_horas_w := (((qt_horas_w)::numeric  * 60) + (qt_minutos_w)::numeric );
	end if;
elsif (ie_controle_tempo_p = 'S' and ie_tipo_solucao_p = 'I') then
	qt_horas_w := 0;
	if (qt_hora_fase_p IS NOT NULL AND qt_hora_fase_p::text <> '') then
		qt_hora_w := substr(qt_hora_fase_p, 0, 2);
		qt_minutos_w := '0';

		if (length(qt_hora_fase_p) > 4) then
			qt_minutos_w := substr(qt_hora_fase_p, 4, 5);
		end if;

		qt_horas_w := (((qt_horas_w)::numeric  * 60) + (qt_minutos_w)::numeric );
	end if;
end if;

return;

end;

function obter_maior_dose(	qt_dose_conv_p				IN cpoe_material.qt_dose%type,
							qt_dose_adicional_conv_p	IN cpoe_material.qt_dose_adicional%type,
							qt_dose_ataque_conv_p		IN cpoe_material.qt_dose_ataque%type)
							return;

begin
	qt_retorno_w := coalesce(qt_dose_conv_p, 0);

	if (qt_dose_adicional_conv_p > qt_retorno_w) then
		qt_retorno_w := qt_dose_adicional_conv_p;
	end if;

	if (qt_dose_ataque_conv_p > qt_retorno_w) then
		qt_retorno_w := qt_dose_ataque_conv_p;
	end if;

	return;
end;

function obter_menor_dose(	qt_dose_conv_p				IN cpoe_material.qt_dose%type,
							qt_dose_adicional_conv_p	IN cpoe_material.qt_dose_adicional%type,
							qt_dose_ataque_conv_p		IN cpoe_material.qt_dose_ataque%type)
				return;

begin
	qt_retorno_w := coalesce(qt_dose_conv_p, 0);

	if (qt_dose_adicional_conv_p < qt_retorno_w and (qt_dose_adicional_p IS NOT NULL AND qt_dose_adicional_p::text <> '')) then
		qt_retorno_w := qt_dose_adicional_conv_p;
	end if;

	if (qt_dose_ataque_conv_p < qt_retorno_w and (qt_dose_ataque_p IS NOT NULL AND qt_dose_ataque_p::text <> '')) then
		qt_retorno_w := qt_dose_ataque_conv_p;
	end if;

	return;
end;

function obter_expressao_idade( qt_idade_ano_p IN medic_ficha_limite.qt_idade_max%type,
								qt_idade_mes_p IN medic_ficha_limite.qt_idade_max%type,
								qt_idade_dia_p IN medic_ficha_limite.qt_idade_max%type)
								return;
begin
	if (qt_idade_ano_p = 1) then
		ds_idade_w := obter_desc_expressao(678860); -- 1 ano
	elsif (qt_idade_ano_p > 1) then
		ds_idade_w := qt_idade_ano_p || ' ' || obter_desc_expressao(1031200); -- anos
	end if;			
	if (qt_idade_mes_p = 1) then
		ds_idade_w := ds_idade_w || ' ' || obter_desc_expressao(695724); -- 1 mes
	elsif (qt_idade_mes_p > 1) then
		ds_idade_w := ds_idade_w || ' ' || qt_idade_mes_p || ' ' || obter_desc_expressao(348664); -- meses
	end if;			
	if (qt_idade_dia_p = 1) then
		ds_idade_w := ds_idade_w || ' ' || obter_desc_expressao(347503); -- 1 dia
	elsif (qt_idade_dia_p > 1) then
		ds_idade_w := ds_idade_w || ' ' || qt_idade_dia_p || ' ' || obter_desc_expressao(326313); -- dias
	end if;	
	
	return;
end;

function exists_regra return;

  v_aux number(10);
  v_ret boolean;
begin
  v_ret := false;
  open c_cur;
  fetch c_cur
    into v_aux;
  if FOUND then
    v_ret := true;
  end if;
  close c_cur;
  return;
end;

begin

begin

if (cd_material_p IS NOT NULL AND cd_material_p::text <> '') and exists_regra and ((ds_dose_diferenciada_p IS NOT NULL AND ds_dose_diferenciada_p::text <> '') or qt_dose_p > 0) then

	if (ds_dose_diferenciada_p IS NOT NULL AND ds_dose_diferenciada_p::text <> '') then
		ie_dose_diferenciada_w := 'S';
	end if;
	
	select	coalesce(qt_peso, 0),
			coalesce(qt_altura_cm, 0)
	into STRICT	qt_peso_w,
			qt_altura_w
	from	pessoa_fisica
	where 	cd_pessoa_fisica = cd_pessoa_fisica_p;

	qt_peso_w := coalesce(obter_sinal_vital(nr_atendimento_p,'PESO'), qt_peso_w);
	qt_altura_w := coalesce(obter_sinal_vital(nr_atendimento_p,'ALTURA'), qt_altura_w);
	nr_ocorrencia_w	:=	obter_ocorrencia_intervalo(cd_intervalo_p, 24, 'O');

	select	nr_seq_ficha_tecnica
	into STRICT	nr_seq_ficha_tecnica_w
	from	material
	where	cd_material = cd_material_p;

    for regra_w in c01 loop
		if (coalesce(ds_mensagem_dose_out_p::text, '') = '') then
			for dose_w in c02 loop
				qt_dose_w := dose_w.qt_dose;
				qt_dose_total_w := dose_w.qt_dose_total;
				if (ie_dose_diferenciada_w = 'N') then
					if ((nr_etapas_p IS NOT NULL AND nr_etapas_p::text <> '') and  coalesce(cd_intervalo_p::text, '') = '') then
						qt_dose_total_w := qt_dose_w * nr_etapas_p;
					elsif (cd_intervalo_p IS NOT NULL AND cd_intervalo_p::text <> '') then
						qt_dose_total_w := qt_dose_w * obter_ocorrencia_intervalo(cd_intervalo_p, coalesce(qt_tempo_aplicacao_p, 24), 'O');
					end if;
				end if;
			end loop;

			qt_dose_conv_w := obter_dose_convertida(cd_material_p, qt_dose_w, cd_unidade_medida_p, regra_w.cd_unid_med_limite);

			qt_dose_total_conv_w := obter_dose_convertida(cd_material_p, qt_dose_total_w, cd_unidade_medida_p, regra_w.cd_unid_med_limite);

			qt_dose_adic_conv_w := obter_dose_convertida(cd_material_p, coalesce(qt_dose_adicional_p, 0), cd_unidade_medida_p, regra_w.cd_unid_med_limite);

			qt_dose_ataque_conv_w := obter_dose_convertida(cd_material_p, coalesce(qt_dose_ataque_p, 0), cd_unidade_medida_p, regra_w.cd_unid_med_limite);

			for r_c03 in C03 loop -- Busca outros materiais ativos com o mesmo principio ativo
				cd_materiais_ficha_w := cd_materiais_ficha_w || r_c03.cd_material || ',';
			end loop;
			cd_materiais_ficha_w := substr(cd_materiais_ficha_w, 0, length(cd_materiais_ficha_w) -1);

			if (regra_w.ie_dose_limite = 'AT' or regra_w.ie_dose_limite = 'PF') then
				if ((ie_duracao_p IS NOT NULL AND ie_duracao_p::text <> '') and ie_duracao_p = 'C') then
					ie_consiste_dose_limite_w := 'S';
				else
					if (regra_w.ie_dose_limite = 'PF') then
						ie_dose_limite_w := 'P';
					else
						ie_dose_limite_w := 'A';
					end if;
					
					qt_dose_aux_w := getDoseTotal(regra_w.cd_unid_med_limite, ie_dose_limite_w);

					qt_dose_compare_w := qt_dose_total_conv_w + qt_dose_aux_w + qt_dose_adic_conv_w + qt_dose_ataque_conv_w;
					
				end if;
			elsif (regra_w.ie_dose_limite = 'DOSE') then
				qt_dose_compare_w := obter_maior_dose(qt_dose_conv_w, qt_dose_adic_conv_w, qt_dose_ataque_conv_w);
			elsif (qt_peso_w > 0 and position('KG' in regra_w.ie_dose_limite) > 0) then
				qt_dose_aux_w := getDoseTotal(regra_w.cd_unid_med_limite, 'A');
				if (regra_w.ie_dose_limite = 'KG/D' and ie_dose_diferenciada_w = 'N') then
					qt_dose_compare_w := (qt_dose_conv_w + qt_dose_aux_w + qt_dose_adic_conv_w + qt_dose_ataque_conv_w) / qt_peso_w;
				elsif (regra_w.ie_dose_limite = 'KG' or regra_w.ie_dose_limite = 'KG/D') then
					qt_dose_compare_w := (qt_dose_total_conv_w + qt_dose_aux_w + qt_dose_adic_conv_w + qt_dose_ataque_conv_w) / qt_peso_w;
				elsif (regra_w.ie_dose_limite = 'KG/DIA') then
					select	coalesce(sum(obter_dose_convertida(b.cd_material, c.qt_dose, c.cd_unidade_medida_dose, cd_unidade_medida_p)),0)
					into STRICT	qt_dose_aux_w
					from	prescr_mat_hor c,
							prescr_material b,
							prescr_medica a,
							table(lista_pck.obter_lista_char(cd_materiais_ficha_w)) d
					where	a.nr_prescricao		= b.nr_prescricao
					and		a.nr_atendimento	= nr_atendimento_p
					and		b.cd_material		= d.cd_registro
					and		b.nr_prescricao		= c.nr_prescricao
					and		b.nr_sequencia		= c.nr_seq_material
					and     d.cd_registro       = b.cd_material
					and		coalesce(a.dt_suspensao::text, '') = ''
					and		coalesce(b.ie_suspenso,'N')	= 'N'
					and		a.dt_inicio_prescr between clock_timestamp() - interval '1 days' and clock_timestamp()
					and		coalesce(c.dt_suspensao::text, '') = '';

					qt_dose_compare_w := (qt_dose_total_conv_w + qt_dose_aux_w + qt_dose_adic_conv_w + qt_dose_ataque_conv_w) / qt_peso_w;
				elsif (regra_w.ie_dose_limite = 'KG/H' and cpoe_obter_qt_horas_aplic > 0) then
					qt_dose_compare_w := (qt_dose_total_conv_w + qt_dose_aux_w + qt_dose_adic_conv_w + qt_dose_ataque_conv_w) / (qt_peso_w * cpoe_obter_qt_horas_aplic);
				elsif (regra_w.ie_dose_limite = 'KG/MIN' and cpoe_obter_qt_minutos_aplic > 0) then
					qt_dose_compare_w := (qt_dose_total_conv_w + qt_dose_aux_w + qt_dose_adic_conv_w + qt_dose_ataque_conv_w) / (qt_peso_w * cpoe_obter_qt_minutos_aplic);
				end if;
			elsif (regra_w.ie_dose_limite = 'DIA' or regra_w.ie_dose_limite = 'SC') then
				SELECT * FROM cpoe_consiste_dose_dia(nr_atendimento_p, cd_material_p, qt_dose_w, cd_unidade_medida_p, ds_horarios_p, ie_urgencia_p, regra_w.qt_dose_max, regra_w.cd_unid_med_limite, dt_inicio_p, nr_seq_cpoe_p, ie_tipo_item_p, nr_ocorrencia_w, coalesce(qt_dose_adicional_p, 0) + coalesce(qt_dose_ataque_p, 0), cd_materiais_ficha_w) INTO STRICT ie_consiste_dose_limite_w, qt_dose_compare_w;
				if (ie_tipo_consistencia_p = 'MIN') then
					ie_consiste_dose_limite_w := 'N';
				end if;
			end if;

			if (ie_controle_tempo_p = 'S') then
				qt_dose_compare_w := coalesce(qt_dose_compare_w, 0);
			else
				qt_dose_compare_w := coalesce(qt_dose_compare_w, qt_dose_total_conv_w);
			end if;
			
			if (regra_w.qt_peso_max > 0 and regra_w.qt_peso_min > 0) then
				ds_msg_regra_w := wheb_mensagem_pck.get_texto(1199961, 'QT_PESO_MIN=' || regra_w.qt_peso_min  || ';QT_PESO_MAX=' || regra_w.qt_peso_max ) || ', ';
			elsif (regra_w.qt_peso_min > 0) then
				ds_msg_regra_w := wheb_mensagem_pck.get_texto(1199958, 'QT_PESO_MIN=' || regra_w.qt_peso_min ) || ', ';
			elsif (regra_w.qt_peso_max > 0) then
				ds_msg_regra_w := wheb_mensagem_pck.get_texto(1199955, 'QT_PESO_MAX=' || regra_w.qt_peso_max ) || ', ';
			end if;
			
			if (regra_w.qt_sc_max > 0 and regra_w.qt_sc_min > 0) then
				ds_msg_regra_w := ds_msg_regra_w || wheb_mensagem_pck.get_texto(1199964, 'DS_SUPERFICIE_MIN=' || regra_w.qt_sc_min  ||
																						 ';DS_SUPERFICIE_MAX=' || regra_w.qt_sc_max ) || ', ';
			elsif (regra_w.qt_sc_min > 0) then
				ds_msg_regra_w := ds_msg_regra_w || wheb_mensagem_pck.get_texto(1199962, 'DS_SUPERFICIE_MIN=' || regra_w.qt_sc_min ) || ', ';
			elsif (regra_w.qt_sc_max > 0) then
				ds_msg_regra_w := ds_msg_regra_w || wheb_mensagem_pck.get_texto(1199959, 'DS_SUPERFICIE_MAX=' || regra_w.qt_sc_max ) || ', ';
			end if;
			
			ds_idade_max_w := obter_expressao_idade(regra_w.qt_idade_max, regra_w.qt_idade_max_mes, regra_w.qt_idade_max_dia);
			ds_idade_min_w := obter_expressao_idade(regra_w.qt_idade_min, regra_w.qt_idade_min_mes, regra_w.qt_idade_min_dia);
			
			if (ds_idade_min_w IS NOT NULL AND ds_idade_min_w::text <> '' AND ds_idade_max_w IS NOT NULL AND ds_idade_max_w::text <> '') then
				ds_msg_regra_w := ds_msg_regra_w || wheb_mensagem_pck.get_texto(1199960, 'DS_IDADE_MIN=' || ds_idade_min_w || ';DS_IDADE_MAX=' || ds_idade_max_w) || ', ';
			elsif (ds_idade_min_w IS NOT NULL AND ds_idade_min_w::text <> '') then
				ds_msg_regra_w := ds_msg_regra_w || wheb_mensagem_pck.get_texto(1199956, 'DS_IDADE_MIN=' || ds_idade_min_w  ) || ', ';
			elsif (ds_idade_max_w IS NOT NULL AND ds_idade_max_w::text <> '') then
				ds_msg_regra_w := ds_msg_regra_w || wheb_mensagem_pck.get_texto(1199954, 'DS_IDADE_MAX=' || ds_idade_max_w ) || ', ';
			end if;
			
			ds_msg_regra_w := substr(ds_msg_regra_w, 0, length(ds_msg_regra_w) -2);
			
			ds_dose_w := qt_dose_compare_w || ' ' || substr(obter_desc_unid_med(regra_w.cd_unid_med_limite),1,255);
			
			if (ie_tipo_consistencia_p in ('MAX', 'A') and regra_w.qt_dose_max > -1 and (qt_dose_compare_w > regra_w.qt_dose_max or ie_consiste_dose_limite_w = 'S')) then
				ds_dose_regra_w := regra_w.qt_dose_max || ' ' || regra_w.ds_unid_med_limite || '/' || regra_w.ds_dose_limite;
				if (ds_msg_regra_w IS NOT NULL AND ds_msg_regra_w::text <> '') then
					ds_mensagem_dose_out_p  := wheb_mensagem_pck.get_texto(1199969, 'QT_DOSAGEM=' || ds_dose_w
																				|| ';DS_PRINCIPIO_ATIVO=' || obter_desc_ficha_tecnica(regra_w.nr_ficha_tecnica) 
																				|| ';DS_REGRA=' || ds_msg_regra_w
																				|| ';QT_DOSAGEM_REGRA=' || ds_dose_regra_w );
				else
					ds_mensagem_dose_out_p  := wheb_mensagem_pck.get_texto(1200593, 'QT_DOSAGEM=' || ds_dose_w
																				|| ';DS_PRINCIPIO_ATIVO=' || obter_desc_ficha_tecnica(regra_w.nr_ficha_tecnica)
																				|| ';QT_DOSAGEM_REGRA=' || ds_dose_regra_w );
				end if;
				if (regra_w.ie_prescricao = 'N') then
					ds_mensagem_dose_out_p := ds_mensagem_dose_out_p || chr(13) || chr(10) || wheb_mensagem_pck.get_texto(1200057);
				end if;
				qt_dose_out_p := regra_w.qt_dose_max;
			end if;
			
			if (ie_tipo_consistencia_p in ('MIN', 'A') and regra_w.qt_dose_min > 0 and obter_menor_dose(qt_dose_compare_w, qt_dose_adic_conv_w, qt_dose_ataque_conv_w) < regra_w.qt_dose_min) then
				ds_dose_regra_w := regra_w.qt_dose_min || ' ' || regra_w.ds_unid_med_min || '/' || regra_w.ds_dose_limite;
				if (ds_msg_regra_w IS NOT NULL AND ds_msg_regra_w::text <> '') then
					ds_mensagem_dose_out_p  := wheb_mensagem_pck.get_texto(1199971, 'QT_DOSAGEM=' || ds_dose_w
																				|| ';DS_PRINCIPIO_ATIVO=' || obter_desc_ficha_tecnica(regra_w.nr_ficha_tecnica) 
																				|| ';DS_REGRA=' || ds_msg_regra_w
																				|| ';QT_DOSAGEM_REGRA=' || ds_dose_regra_w );
				else
					ds_mensagem_dose_out_p  := wheb_mensagem_pck.get_texto(1200588, 'QT_DOSAGEM=' || ds_dose_w
																				|| ';DS_PRINCIPIO_ATIVO=' || obter_desc_ficha_tecnica(regra_w.nr_ficha_tecnica)
																				|| ';QT_DOSAGEM_REGRA=' || ds_dose_regra_w );
				end if;
				if (regra_w.ie_prescricao = 'N') then
					ds_mensagem_dose_out_p := ds_mensagem_dose_out_p || chr(13) || chr(10) ||  wheb_mensagem_pck.get_texto(1200058);
				end if;
				qt_dose_out_p			:= regra_w.qt_dose_min;
			end if;
			cd_unidade_medida_out_p		:= regra_w.cd_unid_med_limite;
			ie_dose_out_p				:= regra_w.ie_dose_limite;
			ie_justificativa_out_p		:= regra_w.ie_prescricao;
			qt_dose_atend_prescr_out_p	:= qt_dose_compare_w;
		end if;
	end loop;
end if;

exception when others then
	ds_erro_w	:= substr(to_char(sqlerrm),1,2000);

	CALL gravar_log_cpoe(substr('CPOE_VALIDA_FICHA_TEC_LIMIT EXCEPTION: '||ds_erro_w
										||' STACK ' || dbms_utility.format_call_stack
										||' nr_seq_cpoe_p: '||nr_seq_cpoe_p||' qt_tempo_aplicacao_p :'||qt_tempo_aplicacao_p
									    ||' qt_dose_p: '||qt_dose_p||' ds_dose_diferenciada_p: '||ds_dose_diferenciada_p
									    ||' cd_unidade_medida_p:'||cd_unidade_medida_p||' cd_pessoa_fisica_p:'||cd_pessoa_fisica_p
									    ||' cd_intervalo_p :'||cd_intervalo_p||' nr_etapas_p :'||nr_etapas_p
									    ||' dt_inicio_p :'||to_char(dt_inicio_p,'dd/mm/yyyy hh24:mi:ss')||' dt_fim_p :'||to_char(dt_fim_p,'dd/mm/yyyy hh24:mi:ss')
										,1,2000),
			nr_atendimento_p);
	end;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cpoe_valida_ficha_tec_limit (( nr_atendimento_p atendimento_paciente.nr_atendimento%type, nr_seq_cpoe_p cpoe_material.nr_sequencia%type, ie_tipo_item_p text, cd_material_p material.cd_material%type, qt_dose_p cpoe_material.qt_dose%type, ds_dose_diferenciada_p cpoe_material.ds_dose_diferenciada%type, cd_unidade_medida_p cpoe_material.cd_unidade_medida%type, cd_pessoa_fisica_p pessoa_fisica.cd_pessoa_fisica%type, cd_intervalo_p intervalo_prescricao.cd_intervalo%type, nr_etapas_p cpoe_material.nr_etapas%type, hr_min_aplicacao_p cpoe_material.hr_min_aplicacao%type, qt_tempo_aplicacao_p cpoe_material.qt_tempo_aplicacao%type, ie_controle_tempo_p cpoe_material.ie_controle_tempo%type, ie_tipo_solucao_p cpoe_material.ie_tipo_solucao%type, dt_inicio_p timestamp, dt_fim_p timestamp, ie_tipo_consistencia_p text, ie_duracao_p cpoe_material.ie_duracao%type, qt_hora_fase_p cpoe_material.qt_hora_fase%type, qt_dose_adicional_p cpoe_material.qt_dose_adicional%type, qt_dose_ataque_p cpoe_material.qt_dose_ataque%type, ds_horarios_p cpoe_material.ds_horarios%type, ie_urgencia_p cpoe_material.ie_urgencia%type, ie_dose_out_p OUT text, cd_unidade_medida_out_p OUT text, qt_dose_out_p OUT bigint, ds_mensagem_dose_out_p OUT text, qt_dose_atend_prescr_out_p OUT bigint, ie_justificativa_out_p OUT text) is ie_dose_diferenciada_w varchar(1) DEFAULT 'N') FROM PUBLIC;

