-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE lote_ent_ver_se_baixa_aut_ba ( nr_seq_ficha_p bigint, nr_seq_resultado_p bigint, nm_usuario_p text) AS $body$
DECLARE

totalItens_w		bigint := 0;
totalItensNormal_w	bigint := 0;
nrSeqReconvocado_w	bigint := 0;
pessoaClassif_w		bigint := 0;
nrSeqMotPadrao_w	bigint := 0;
nrSeqFichaAnterior_w	bigint := 0;
cdPessoaFisica_w	varchar(10);


BEGIN
    if (nr_seq_ficha_p IS NOT NULL AND nr_seq_ficha_p::text <> '') and (nr_seq_resultado_p IS NOT NULL AND nr_seq_resultado_p::text <> '') then
        select 	nr_seq_ficha_ant,
                cd_pessoa_fisica
        into STRICT	nrSeqFichaAnterior_w,
                cdPessoaFisica_w
        from	lote_ent_sec_ficha
        where	nr_sequencia = nr_seq_ficha_p;

        if (cdPessoaFisica_w IS NOT NULL AND cdPessoaFisica_w::text <> '') then
            begin        
                select count(1)
                into STRICT pessoaClassif_w
                from pessoa_classif
                where cd_pessoa_fisica = cdPessoaFisica_w;
            exception
                when others then
                pessoaClassif_w := 0;
            end;
        end if;

        begin
            select nr_sequencia
            into STRICT nrSeqReconvocado_w
            from lote_ent_reconvocado 
            where nr_seq_ficha_lote = nrSeqFichaAnterior_w;
        exception
            when others then
                nrSeqReconvocado_w := 0;
        end;

        if (nrSeqReconvocado_w > 0) and (pessoaClassif_w = 0) then 
            begin
                select count(eri.nr_seq_exame)
                into STRICT totalItens_w
                from prescr_procedimento pp
                inner join exame_lab_resultado er on er.nr_prescricao = pp.nr_prescricao
                inner join exame_lab_result_item eri on eri.nr_seq_resultado = er.nr_seq_resultado 
                                                        and eri.nr_seq_prescr = pp.nr_sequencia
                where eri.nr_seq_resultado = nr_seq_resultado_p
                and coalesce(pp.dt_baixa::text, '') = ''
                and (eri.nr_seq_material IS NOT NULL AND eri.nr_seq_material::text <> '')
                and ((eri.ds_resultado IS NOT NULL AND eri.ds_resultado::text <> '') 
                    or (eri.pr_resultado IS NOT NULL AND eri.pr_resultado::text <> '') 
                    or (eri.qt_resultado IS NOT NULL AND eri.qt_resultado::text <> ''));
            exception
                when others then
                    totalItens_w := 0;
            end;

            if (totalItens_w > 0) then
                begin    
                    select count(eri.nr_seq_exame)
                    into STRICT totalItensNormal_w
                    from prescr_procedimento pp
                    inner join exame_lab_resultado er on er.nr_prescricao = pp.nr_prescricao
                    inner join exame_lab_result_item eri on eri.nr_seq_resultado = er.nr_seq_resultado 
                                                            and eri.nr_seq_prescr = pp.nr_sequencia
                    where eri.nr_seq_resultado = nr_seq_resultado_p
                    and coalesce(pp.dt_baixa::text, '') = ''
                    and	(eri.nr_seq_material IS NOT NULL AND eri.nr_seq_material::text <> '')
                    and ((eri.ds_resultado IS NOT NULL AND eri.ds_resultado::text <> '') 
                        or (eri.pr_resultado IS NOT NULL AND eri.pr_resultado::text <> '') 
                        or (eri.qt_resultado IS NOT NULL AND eri.qt_resultado::text <> '')) 
                    and (coalesce(eri.ie_acao_criterio_lote,'S') = 'S')
                    and (exists (SELECT ebat.nr_seq_exame 
                                from lote_ent_exame_buscaat ebat 
                                where ebat.nr_seq_exame = eri.nr_seq_exame 
                                and (coalesce(ebat.ie_situacao,'A') = 'A')
                                and (coalesce(ebat.ie_baixa_res_normal,'N') = 'S'))            
                        OR exists (select  ebap.nr_seq_exame
                                    from lote_ent_exame_buscap ebap 
                                    where ebap.nr_seq_exame = eri.nr_seq_exame 
                                    and (coalesce(ebap.ie_situacao,'A') = 'A')
                                    and (coalesce(ebap.ie_baixa_res_normal,'N') = 'S')));
                exception
                    when others then
                        totalItensNormal_w := 0;
                end;
                
                if (totalItens_w = totalItensNormal_w) then 
                    begin
                        select nr_sequencia
                        into STRICT nrSeqMotPadrao_w
                        from lote_ent_baixa_mot
                        where (coalesce(ie_motivo_padrao,'N') = 'S')
                        and ie_situacao = 'A';
                    exception
                    when others then
                        nrSeqMotPadrao_w := null;
                    end;
                
                    CALL lote_ent_baixa_reg_ba(nrSeqReconvocado_w, nrSeqMotPadrao_w);
                end if;
            end if;
        end if;
    end if;

    commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE lote_ent_ver_se_baixa_aut_ba ( nr_seq_ficha_p bigint, nr_seq_resultado_p bigint, nm_usuario_p text) FROM PUBLIC;

