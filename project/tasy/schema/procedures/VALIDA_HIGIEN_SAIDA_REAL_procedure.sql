-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE valida_higien_saida_real ( ie_tipo_p bigint, nm_usuario_p text, cd_estabelecimento_p text, ie_tipo_acomod_p text, cd_setor_atual_p text, cd_unidade_basica_p text, cd_unidade_compl_p text, ds_retorno_p INOUT text) AS $body$
DECLARE



ie_hig_se_setor_sem_acomod_w	varchar(1);
ie_hig_setor_sem_acomod_w	varchar(1);
ie_aguard_higienizar_transf_w	varchar(1);
ie_considera_estr_atend_w	varchar(1);
ie_considerar_hig_estr_w	varchar(1);
ie_exige_senha_transf_alta_w	varchar(1);
ie_inativa_leito_w		varchar(1);
ie_ativa_leito_agrup_w	varchar(1);
ie_continua_processo_w	varchar(1)	:= 'S';
ie_sem_acomod_w		varchar(1);
ie_higieniza_leito_w	varchar(1);


BEGIN


if (ie_tipo_p = 10) then
	begin
	/* Movimentação de Pacientes - Parâmetro [146] - Ao gerar transferência, se o setor escolhido for um setor sem acomodação, gerar higienização para o leito anterior */

	ie_hig_se_setor_sem_acomod_w := obter_param_usuario(3111, 146, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_hig_se_setor_sem_acomod_w);

	if (ie_hig_se_setor_sem_acomod_w = 'N') then
		begin
		ie_sem_acomod_w	:= obter_se_sem_acomodacao(ie_tipo_acomod_p);

		if (ie_sem_acomod_w = 'S') then
			ie_continua_processo_w	:= 'N';
		end if;
		end;
	end if;
	end;
end if;

if (ie_continua_processo_w = 'S') then
	begin
	/* Movimentação de Pacientes - Parâmetro [157] - Higienizar setor sem acomodação ao realizar altas ou transferências  */

	ie_hig_setor_sem_acomod_w := obter_param_usuario(3111, 157, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_hig_setor_sem_acomod_w);

	if (ie_hig_setor_sem_acomod_w = 'S')then
		begin
		ie_sem_acomod_w	:= obter_se_sem_acomodacao(obter_tipo_acomod_leito(cd_setor_atual_p, cd_unidade_basica_p, cd_unidade_compl_p, 'C'));

		if (ie_sem_acomod_w = 'S')then
			ie_continua_processo_w	:= 'N';
		end if;
		end;
	end if;
	end;
end if;

if (ie_continua_processo_w = 'S') then
	begin
	/* Movimentação de Pacientes - Parâmetro [137] - Utilizar status de aguardando higienização ao registrar a transferência do paciente */

	ie_aguard_higienizar_transf_w := obter_param_usuario(3111, 137, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_aguard_higienizar_transf_w);

	if (ie_aguard_higienizar_transf_w <> 'C') then
		begin
		/* Movimentação de Pacientes - Parâmetro [158] - Ao higienizar, considerar os parâmetros de controle de higienização da estrutura de atendimento para altas, transferências e saída real */

		ie_considera_estr_atend_w := obter_param_usuario(3111, 158, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_considera_estr_atend_w);

		if (ie_considera_estr_atend_w = 'S') then
			begin
			ie_higieniza_leito_w	:= obter_se_higieniza_leito(cd_setor_atual_p, cd_unidade_basica_p, cd_unidade_compl_p);

			if (ie_higieniza_leito_w <> 'H')then
				ie_continua_processo_w	:= 'N';
			end if;
			end;
		end if;
		end;
	else
		/* Movimentação de Pacientes - Parâmetro [167] - Ao transferir o paciente, gerar saída real ou alta, considerar controle de higienização da estrutura de atendimento */

		ie_considerar_hig_estr_w := obter_param_usuario(3111, 167, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_considerar_hig_estr_w);

		if (ie_considerar_hig_estr_w = 'N') then
			begin
			ie_higieniza_leito_w	:= obter_se_higieniza_leito(cd_setor_atual_p, cd_unidade_basica_p, cd_unidade_compl_p);

			if (ie_higieniza_leito_w = 'N')then
				ie_continua_processo_w	:= 'N';
			end if;
			end;
		end if;
	end if;
	end;
end if;

ds_retorno_p	:=	ie_continua_processo_w;


end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE valida_higien_saida_real ( ie_tipo_p bigint, nm_usuario_p text, cd_estabelecimento_p text, ie_tipo_acomod_p text, cd_setor_atual_p text, cd_unidade_basica_p text, cd_unidade_compl_p text, ds_retorno_p INOUT text) FROM PUBLIC;

