-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE insert_rule_obj_schem (nr_seq_lote_p bigint, cd_funcao_p bigint, nr_seq_parametro_p bigint, vl_param_origem_p text, cd_estab_param_p bigint, cd_perfil_param_p bigint, nm_usuario_param_p text, nr_seq_obj_schem_p bigint, ie_visivel_p text, nm_tabela_p text, ds_observacao_p text, nm_usuario_p text) AS $body$
DECLARE


    vl_parametro_padrao_w    varchar(1);
    nr_sequencia_w           bigint;
    nr_seq_obj_schem_param_w objeto_schematic_param.nr_sequencia%type;


BEGIN

    select coalesce(max(nr_sequencia), 0)
      into STRICT nr_seq_obj_schem_param_w
      from objeto_schematic_param
     where nr_seq_obj_sch = nr_seq_obj_schem_p;

    /*
    Se por algum motivo, nao houver registro na tabela principal
    cria primeiro registro baseado no valor do parametro padrao. 
    O decode foi feito para os casos de pasta, onde pode haver uma terceira opcao do tipo Somente Visualizar
    */
    if (nr_seq_obj_schem_param_w = 0) then
        begin

            select CASE WHEN vl_parametro_padrao='N' THEN  'N'  ELSE 'S' END 
              into STRICT vl_parametro_padrao_w
              from funcao_parametro
             where nr_sequencia = nr_seq_parametro_p
               and cd_funcao = cd_funcao_p;

            $if $$tasy_local_dict=true $then
            nr_seq_obj_schem_param_w := get_remote_sequence('seq:objeto_schematic_param_seq');
            $else
            select nextval('objeto_schematic_param_seq') into STRICT nr_seq_obj_schem_param_w;
            $end

            insert into objeto_schematic_param(nr_sequencia,
                 vl_parametro_padrao,
                 dt_atualizacao,
                 nm_usuario,
                 dt_atualizacao_nrec,
                 nm_usuario_nrec,
                 cd_funcao,
                 nr_seq_obj_sch)
            values (nr_seq_obj_schem_param_w,
                 vl_parametro_padrao_w,
                 clock_timestamp(),
                 nm_usuario_p,
                 clock_timestamp(),
                 nm_usuario_p,
                 cd_funcao_p,
                 nr_seq_obj_schem_p);

            CALL html_param_converter_log('OBJETO_SCHEMATIC_PARAM',
                                     nr_seq_obj_schem_param_w,
                                     null,
                                     null,
                                     null,
                                     cd_funcao_p,
                                     nr_seq_parametro_p,
                                     vl_param_origem_p,
                                     nr_seq_lote_p,
                                     nm_usuario_p);

        end;
    end if;

    if (upper(nm_tabela_p) = 'OBJETO_SCHEMATIC_PARAM') then
        begin

            update objeto_schematic_param
               set vl_parametro   = ie_visivel_p,
                   nm_usuario     = nm_usuario_p,
                   dt_atualizacao = clock_timestamp()
             where nr_seq_obj_sch = nr_seq_obj_schem_param_w;

            CALL html_param_converter_log('OBJETO_SCHEMATIC_PARAM',
                                     nr_seq_obj_schem_param_w,
                                     null,
                                     null,
                                     null,
                                     cd_funcao_p,
                                     nr_seq_parametro_p,
                                     vl_param_origem_p,
                                     nr_seq_lote_p,
                                     nm_usuario_p);

        end;
    elsif (upper(nm_tabela_p) = 'OBJ_SCHEM_ESTAB') then
        begin

            select coalesce(max(nr_sequencia), 0)
              into STRICT nr_sequencia_w
              from obj_schem_estab
             where nr_seq_obj_schem_param = nr_seq_obj_schem_param_w
               and cd_estabelecimento = cd_estab_param_p;

            if (nr_sequencia_w > 0) then
                begin
                
                    update obj_schem_estab
                       set vl_parametro   = ie_visivel_p,
                           dt_atualizacao = clock_timestamp(),
                           nm_usuario     = nm_usuario_p
                     where nr_sequencia = nr_sequencia_w;

                end;
            else
                begin

                    $if $$tasy_local_dict=true $then
                    nr_sequencia_w := get_remote_sequence('seq:obj_schem_estab_seq');
                    $else
                    select nextval('obj_schem_estab_seq') into STRICT nr_sequencia_w;
                    $end

                    insert into obj_schem_estab(nr_sequencia,
                         dt_atualizacao,
                         nm_usuario,
                         dt_atualizacao_nrec,
                         nm_usuario_nrec,
                         nr_seq_obj_schem_param,
                         cd_estabelecimento,
                         vl_parametro,
                         ds_observacao,
                         cd_funcao)
                    values (nr_sequencia_w,
                         clock_timestamp(),
                         nm_usuario_p,
                         clock_timestamp(),
                         nm_usuario_p,
                         nr_seq_obj_schem_param_w,
                         cd_estab_param_p,
                         ie_visivel_p,
                         ds_observacao_p,
                         cd_funcao_p);

                end;
            end if;

            CALL html_param_converter_log('OBJ_SCHEM_ESTAB',
                                     nr_sequencia_w,
                                     cd_estab_param_p,
                                     null,
                                     null,
                                     cd_funcao_p,
                                     nr_seq_parametro_p,
                                     vl_param_origem_p,
                                     nr_seq_lote_p,
                                     nm_usuario_p);

        end;
    elsif (upper(nm_tabela_p) = 'OBJ_SCHEM_PERFIL') then
        begin

            select coalesce(max(nr_sequencia), 0)
              into STRICT nr_sequencia_w
              from obj_schem_perfil
             where nr_seq_obj_schem_param = nr_seq_obj_schem_param_w
               and coalesce(cd_estabelecimento, 0) = coalesce(cd_estab_param_p, 0)
               and cd_perfil = cd_perfil_param_p;

            if (nr_sequencia_w > 0) then
                begin
                
                    update obj_schem_perfil
                       set vl_parametro   = ie_visivel_p,
                           dt_atualizacao = clock_timestamp(),
                           nm_usuario     = nm_usuario_p
                     where nr_sequencia = nr_sequencia_w;

                end;
            else
                begin

                    $if $$tasy_local_dict=true $then
                    nr_sequencia_w := get_remote_sequence('seq:obj_schem_perfil_seq');
                    $else
                    select nextval('obj_schem_perfil_seq') into STRICT nr_sequencia_w;
                    $end

                    insert into obj_schem_perfil(nr_sequencia,
                         dt_atualizacao,
                         nm_usuario,
                         dt_atualizacao_nrec,
                         nm_usuario_nrec,
                         nr_seq_obj_schem_param,
                         cd_estabelecimento,
                         cd_perfil,
                         vl_parametro,
                         ds_observacao,
                         cd_funcao)
                    values (nr_sequencia_w,
                         clock_timestamp(),
                         nm_usuario_p,
                         clock_timestamp(),
                         nm_usuario_p,
                         nr_seq_obj_schem_param_w,
                         cd_estab_param_p,
                         cd_perfil_param_p,
                         ie_visivel_p,
                         ds_observacao_p,
                         cd_funcao_p);

                end;
            end if;

            CALL html_param_converter_log('OBJ_SCHEM_PERFIL',
                                     nr_sequencia_w,
                                     cd_estab_param_p,
                                     cd_perfil_param_p,
                                     null,
                                     cd_funcao_p,
                                     nr_seq_parametro_p,
                                     vl_param_origem_p,
                                     nr_seq_lote_p,
                                     nm_usuario_p);

        end;
    elsif (upper(nm_tabela_p) = 'OBJ_SCHEM_USUARIO') then
        begin

            select coalesce(max(nr_sequencia), 0)
              into STRICT nr_sequencia_w
              from obj_schem_usuario
             where nr_seq_obj_schem_param = nr_seq_obj_schem_param_w
               and coalesce(cd_estabelecimento, 0) = coalesce(cd_estab_param_p, 0)
               and nm_usuario_param = nm_usuario_param_p;

            if (nr_sequencia_w > 0) then
                begin
                
                    update obj_schem_usuario
                       set vl_parametro   = ie_visivel_p,
                           dt_atualizacao = clock_timestamp(),
                           nm_usuario     = nm_usuario_p
                     where nr_sequencia = nr_sequencia_w;

                end;
            else
                begin

                    $if $$tasy_local_dict=true $then
                    nr_sequencia_w := get_remote_sequence('seq:obj_schem_usuario_seq');
                    $else
                    select nextval('obj_schem_usuario_seq') into STRICT nr_sequencia_w;
                    $end

                    insert into obj_schem_usuario(nr_sequencia,
                         dt_atualizacao,
                         nm_usuario,
                         dt_atualizacao_nrec,
                         nm_usuario_nrec,
                         nr_seq_obj_schem_param,
                         cd_estabelecimento,
                         nm_usuario_param,
                         vl_parametro,
                         ds_observacao,
                         cd_funcao)
                    values (nr_sequencia_w,
                         clock_timestamp(),
                         nm_usuario_p,
                         clock_timestamp(),
                         nm_usuario_p,
                         nr_seq_obj_schem_param_w,
                         cd_estab_param_p,
                         nm_usuario_param_p,
                         ie_visivel_p,
                         ds_observacao_p,
                         cd_funcao_p);

                end;
            end if;

            CALL html_param_converter_log('OBJ_SCHEM_USUARIO',
                                     nr_sequencia_w,
                                     cd_estab_param_p,
                                     null,
                                     nm_usuario_param_p,
                                     cd_funcao_p,
                                     nr_seq_parametro_p,
                                     vl_param_origem_p,
                                     nr_seq_lote_p,
                                     nm_usuario_p);

        end;
    end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE insert_rule_obj_schem (nr_seq_lote_p bigint, cd_funcao_p bigint, nr_seq_parametro_p bigint, vl_param_origem_p text, cd_estab_param_p bigint, cd_perfil_param_p bigint, nm_usuario_param_p text, nr_seq_obj_schem_p bigint, ie_visivel_p text, nm_tabela_p text, ds_observacao_p text, nm_usuario_p text) FROM PUBLIC;

