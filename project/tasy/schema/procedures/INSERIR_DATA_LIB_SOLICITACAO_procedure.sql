-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE inserir_data_lib_solicitacao (nr_seq_solic_p bigint) AS $body$
DECLARE

 
  qt_existe_transfusao_w	bigint;
  q_existe_integracao_w	bigint;

BEGIN
 
  UPDATE san_reserva  
  SET   dt_liberacao_solicitacao = clock_timestamp(), 
      ie_status = 'L' 
  where	 nr_sequencia = nr_seq_solic_p;
 
 
 
  if (coalesce(nr_seq_solic_p,0) > 0) then 
 
    select count(*)   
    into STRICT  qt_existe_transfusao_w 
    from  san_transfusao  
	   where  nr_seq_reserva = nr_seq_solic_p;
 
	   if (coalesce(qt_existe_transfusao_w,0) > 0) then   
		     
      update san_reserva  
		    set   ie_status = 'T'  
		    where  nr_sequencia = nr_seq_solic_p;
 
	   end if;
 
    --início amcom - verifica se existe integração e chama a nova procedure  RF 02 11/06/2015 
    select count(1) 
	   into STRICT  q_existe_integracao_w 
	   from  san_reserva_integracao 
	   where  nr_seq_reserva = nr_seq_solic_p;
 
	   if (coalesce(q_existe_integracao_w,0) > 0) then 
 
		    CALL san_gerar_itens_integracao(nr_seq_solic_p, 
				                wheb_usuario_pck.get_nm_usuario);
 
	   end if;
	   --fim amcom 
 
  end if;
 
  commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE inserir_data_lib_solicitacao (nr_seq_solic_p bigint) FROM PUBLIC;

