-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE agiq_excluir_questoes (ageint_resp_quest_sup_p bigint, nr_seq_ageint_p bigint, nr_seq_ageint_item_p bigint, ie_excluiu_quest_p INOUT text, ie_commit_p text DEFAULT NULL) AS $body$
DECLARE


  ora2pg_rowcount int;
qt_reg_w smallint;

  i RECORD;

BEGIN
  IF (coalesce(ageint_resp_quest_sup_p::text, '') = '') THEN

    DELETE FROM ageint_resp_quest_item
     WHERE nr_seq_ageint = nr_seq_ageint_p
       AND nr_seq_item = nr_seq_ageint_item_p;

    GET DIAGNOSTICS ora2pg_rowcount = ROW_COUNT;


    IF ( ora2pg_rowcount > 0) THEN
      ie_excluiu_quest_p := 'S';
    END IF;

    DELETE FROM ageint_resp_quest a
     WHERE a.nr_seq_ageint = nr_seq_ageint_p
       AND NOT EXISTS (SELECT 1
                         FROM ageint_resp_quest_item x
                         WHERE x.nr_seq_resp_quest = a.nr_sequencia);

    GET DIAGNOSTICS ora2pg_rowcount = ROW_COUNT;


    IF ( ora2pg_rowcount > 0) THEN
      ie_excluiu_quest_p := 'S';
    END IF;
  ELSE
    FOR i IN (WITH RECURSIVE cte AS (
SELECT nr_sequencia
                FROM ageint_resp_quest WHERE nr_seq_superior = ageint_resp_quest_sup_p
  UNION ALL
SELECT nr_sequencia
                FROM ageint_resp_quest JOIN cte c ON (c.nr_sequencia = nr_seq_superior)

) SELECT * FROM cte;
) LOOP

      DELETE FROM ageint_resp_quest_item WHERE nr_seq_resp_quest = i.nr_sequencia;
      GET DIAGNOSTICS ora2pg_rowcount = ROW_COUNT;

      IF ( ora2pg_rowcount > 0) THEN
        ie_excluiu_quest_p := 'S';
      END IF;

      DELETE FROM ageint_resp_quest WHERE nr_sequencia = i.nr_sequencia;
      GET DIAGNOSTICS ora2pg_rowcount = ROW_COUNT;

      IF ( ora2pg_rowcount > 0) THEN
        ie_excluiu_quest_p := 'S';
      END IF;
    END LOOP;
  END IF;

  IF (coalesce(ie_commit_p, 'S') = 'S') THEN
    COMMIT;
  END IF;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE agiq_excluir_questoes (ageint_resp_quest_sup_p bigint, nr_seq_ageint_p bigint, nr_seq_ageint_item_p bigint, ie_excluiu_quest_p INOUT text, ie_commit_p text DEFAULT NULL) FROM PUBLIC;

