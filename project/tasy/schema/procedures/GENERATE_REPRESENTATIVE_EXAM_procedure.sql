-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE generate_representative_exam ( nr_seq_exame_lote_p bigint, nr_seq_exame_p bigint, ds_resultado_p text, cd_resultado_p bigint) AS $body$
DECLARE


qt_exam bigint;


BEGIN

SELECT
    COUNT(*)
INTO STRICT qt_exam
FROM
    san_exame_realizado
WHERE
    nr_seq_exame_lote = nr_seq_exame_lote_p
    AND nr_seq_exame = nr_seq_exame_p;

if (qt_exam = 0) then
    insert into san_exame_realizado( nr_seq_exame_lote,
                                  nr_seq_exame,
                                  dt_atualizacao,
                                  nm_usuario,
                                  nm_usuario_criacao,
                                  ds_resultado,
                                  cd_exp_resultado,
                                  dt_realizado )
                        values ( nr_seq_exame_lote_p,
                                 nr_seq_exame_p,
                                 clock_timestamp(),
                                 'TASY',
                                 'TASY',
                                 ds_resultado_p,
                                 cd_resultado_p,
                                 clock_timestamp() );
else
    update san_exame_realizado
    set dt_atualizacao = clock_timestamp(),
        nm_usuario = 'TASY',
        ds_resultado = ds_resultado_p,
        cd_exp_resultado = cd_resultado_p
    where nr_seq_exame = nr_seq_exame_p
        and nr_seq_exame_lote = nr_seq_exame_lote_p
        and ( cd_exp_resultado = 291833 or coalesce(cd_exp_resultado::text, '') = '' )
        and coalesce(dt_liberacao::text, '') = '';
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE generate_representative_exam ( nr_seq_exame_lote_p bigint, nr_seq_exame_p bigint, ds_resultado_p text, cd_resultado_p bigint) FROM PUBLIC;

