-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE rxt_inat_criar_plan_medico ( nr_seq_campo_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint, ie_tipo_trat_p text, nr_sequencia_p INOUT bigint ) AS $body$
DECLARE


 nr_aplicacoes_w                bigint;
 nr_seq_fase_w                  bigint;
 nr_seq_campo_w                 bigint;
 qt_dose_total_w                double precision;
 qt_dose_diaria_w               double precision;
 qt_tam_x_w                     double precision;
 qt_tam_y_w                     double precision;
 qt_y1novo_w                    double precision;
 qt_dose_monitor_w              double precision;
 qt_x1_w                        double precision;
 qt_x2_w                        double precision;
 qt_y1_w                        double precision;
 qt_ssd_w                       double precision;
 qt_y2_w                        double precision;
 qt_angulo_gantry_w             double precision;
 qt_angulo_colimador_w          double precision;
 qt_angulo_mesa_w               double precision;
 ds_observacao_w                varchar(255);
 nr_seq_posicao_w               bigint;
 ie_tipo_x_w                    varchar(1);
 ie_tipo_y_w                    varchar(1);
 ie_tipo_z_w                    varchar(1);
 nr_seq_energia_rad_w           bigint;
 ds_campo_w                     varchar(80);
 nr_seq_ene_fotons_w            bigint;
 qt_angulo_gantry_final_w       double precision;
 qt_ang_colimador_final_w       double precision;
 ds_observacao_medico_w         varchar(2000);
 nr_seq_aplic_trat_w			rxt_braq_campo_aplic_trat.nr_seq_aplic_trat%type;
 qt_resultado_w					rxt_braq_campo_aplic_trat.qt_resultado%type;
 ds_resultado_w					rxt_braq_campo_aplic_trat.ds_resultado%type;
 nr_seq_resultado_w				rxt_braq_campo_aplic_trat.nr_seq_resultado%type;
 nr_insercao_w					rxt_braq_campo_aplic_trat.nr_insercao%type;
 qt_atividade_ci_w				rxt_braq_campo_aplic_trat.qt_atividade_ci%type;
 qt_tempo_w						rxt_braq_campo_aplic_trat.qt_tempo%type;
 qt_angulacao_w					rxt_braq_campo_aplic_trat.qt_angulacao%type;


BEGIN

if (ie_tipo_trat_p = 'T') then
	select 	nr_aplicacoes,
			nr_seq_fase,
			nr_seq_campo,
			qt_dose_total,
			qt_dose_diaria,
			qt_tam_x,
			qt_tam_y,
			qt_dose_monitor,
			qt_x1,
			qt_x2,
			qt_y1,
			qt_ssd,
			qt_y2,
			qt_angulo_gantry,
			qt_angulo_colimador,
			qt_angulo_mesa,
			ds_observacao,
			nr_seq_posicao,
			ie_tipo_x,
			ie_tipo_y,
			nr_seq_energia_rad,
			ds_campo,
			nr_seq_ene_fotons,
			qt_angulo_gantry_final,
			qt_ang_colimador_final,
			ds_observacao_medico
	into STRICT 	nr_aplicacoes_w,
			nr_seq_fase_w,
			nr_seq_campo_w,
			qt_dose_total_w,
			qt_dose_diaria_w,
			qt_tam_x_w,
			qt_tam_y_w,
			qt_dose_monitor_w,
			qt_x1_w,
			qt_x2_w,
			qt_y1_w,
			qt_ssd_w,
			qt_y2_w,
			qt_angulo_gantry_w,
			qt_angulo_colimador_w,
			qt_angulo_mesa_w,
			ds_observacao_w,
			nr_seq_posicao_w,
			ie_tipo_x_w,
			ie_tipo_y_w,
			nr_seq_energia_rad_w,
			ds_campo_w,
			nr_seq_ene_fotons_w,
			qt_angulo_gantry_final_w,
			qt_ang_colimador_final_w,
			ds_observacao_medico_w
	from 	rxt_campo
	where 	nm_usuario = nm_usuario_p
	and 	nr_sequencia = nr_seq_campo_p;


	select  nextval('rxt_campo_seq')
	into STRICT 	nr_sequencia_p
	;

	insert into rxt_campo(nr_sequencia,
						 dt_atualizacao_nrec,
						 nm_usuario_nrec,
						 dt_atualizacao,
						 nm_usuario,
						 nr_aplicacoes,
						 nr_seq_fase,
						 nr_seq_campo,
						 qt_dose_total,
						 qt_dose_diaria,
						 qt_tam_x,
						 qt_tam_y,
						 qt_dose_monitor,
						 qt_x1,
						 qt_x2,
						 qt_y1,
						 qt_ssd,
						 qt_y2,
						 qt_angulo_gantry,
						 qt_angulo_colimador,
						 qt_angulo_mesa,
						 ds_observacao,
						 nr_seq_posicao,
						 ie_tipo_x,
						 ie_tipo_y,
						 nr_seq_energia_rad,
						 ds_campo,
						 nr_seq_ene_fotons,
						 qt_angulo_gantry_final,
						 qt_ang_colimador_final,
						 ie_situacao,
						 dt_liberacao,
						 nm_usuario_lib,
						 dt_inativacao,
						 nm_usuario_inativacao,
						 ds_observacao_medico,
						 nr_seq_campo_inativacao)
	values (nr_sequencia_p,
						clock_timestamp(),
						 nm_usuario_p,
						 clock_timestamp(),
						 nm_usuario_p,
						 nr_aplicacoes_w,
						 nr_seq_fase_w,
						 nr_seq_campo_w,
						 qt_dose_total_w,
						 qt_dose_diaria_w,
						 qt_tam_x_w,
						 qt_tam_y_w,
						 qt_dose_monitor_w,
						 qt_x1_w,
						 qt_x2_w,
						 qt_y1_w,
						 qt_ssd_w,
						 qt_y2_w,
						 qt_angulo_gantry_w,
						 qt_angulo_colimador_w,
						 qt_angulo_mesa_w,
						 ds_observacao_w,
						 nr_seq_posicao_w,
						 ie_tipo_x_w,
						 ie_tipo_y_w,
						 nr_seq_energia_rad_w,
						 ds_campo_w,
						 nr_seq_ene_fotons_w,
						 qt_angulo_gantry_final_w,
						 qt_ang_colimador_final_w,
						 'A',
						 null,
						 null,
						 null,
						 null,
						 DS_OBSERVACAO_MEDICO_W,
						 nr_seq_campo_p);

	update 	rxt_campo
	set 	dt_inativacao = clock_timestamp(),
			nm_usuario_inativacao = nm_usuario_p,
			ie_situacao = 'I'
	where	 nm_usuario = nm_usuario_p
	and 	nr_sequencia = nr_seq_campo_p;

elsif (ie_tipo_trat_p = 'B') then

	select  nr_seq_aplic_trat,
			qt_resultado,
			ds_resultado,
			nr_seq_resultado,
			nr_insercao,
			nr_seq_campo,
			qt_atividade_ci,
			qt_tempo,
			qt_angulacao,
			ds_observacao_medico
	into STRICT	nr_seq_aplic_trat_w,
			qt_resultado_w,
			ds_resultado_w,
			nr_seq_resultado_w,
			nr_insercao_w,
			nr_seq_campo_w,
			qt_atividade_ci_w,
			qt_tempo_w,
			qt_angulacao_w,
			ds_observacao_medico_w
	from 	rxt_braq_campo_aplic_trat
	where 	nr_sequencia = nr_seq_campo_p
	and 	nm_usuario = nm_usuario_p;

	/*situacao e inativacao*/

	select nextval('rxt_braq_campo_aplic_trat_seq')
	into STRICT nr_sequencia_p
	;

	insert into rxt_braq_campo_aplic_trat(	nr_sequencia,
											dt_atualizacao,
											nm_usuario,
											dt_atualizacao_nrec,
											nm_usuario_nrec,
											ie_situacao,
											nr_seq_campo_inativacao,
											nr_seq_aplic_trat,
											qt_resultado,
											ds_resultado,
											nr_seq_resultado,
											nr_insercao,
											nr_seq_campo,
											qt_atividade_ci,
											qt_tempo,
											qt_angulacao,
											ds_observacao_medico,
											cd_estabelecimento)
	values (nr_sequencia_p,
											clock_timestamp(),
											nm_usuario_p,
											clock_timestamp(),
											nm_usuario_p,
											'A',
											nr_seq_campo_p,
											nr_seq_aplic_trat_w,
											qt_resultado_w,
											ds_resultado_w,
											nr_seq_resultado_w,
											nr_insercao_w,
											nr_seq_campo_w,
											qt_atividade_ci_w,
											qt_tempo_w,
											qt_angulacao_w,
											ds_observacao_medico_w,
											cd_estabelecimento_p);

	update 	rxt_braq_campo_aplic_trat
	set 	dt_inativacao = clock_timestamp(),
			nm_usuario_inativacao = nm_usuario_p,
			ie_situacao = 'I'
	where	nm_usuario 	= nm_usuario_p
	and 	nr_sequencia = nr_seq_campo_p;

end if;
commit;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE rxt_inat_criar_plan_medico ( nr_seq_campo_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint, ie_tipo_trat_p text, nr_sequencia_p INOUT bigint ) FROM PUBLIC;

