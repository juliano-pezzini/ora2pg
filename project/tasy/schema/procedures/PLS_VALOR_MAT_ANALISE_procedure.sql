-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_valor_mat_analise ( nr_seq_auditoria_p bigint, nr_seq_material_p bigint, nr_seq_prest_fornec_p text, ie_tipo_p text, nm_usuario_p text, vl_material_p INOUT bigint) AS $body$
DECLARE


_ora2pg_r RECORD;
/*---------------------------------------------------------------------------
Rotina utilizada para realizar a valorizacao de itens 
inseridos ou alteradas no processo de auditoria.

IE_TIPO_P	:
	R	-	Requisicao
*/
cd_estabelecimento_w		estabelecimento.cd_estabelecimento%type;
nr_seq_prestador_w		pls_prestador.nr_sequencia%type;
dt_solicitacao_w		timestamp;
ie_tipo_despesa_w		pls_material.ie_tipo_despesa%type;
nr_seq_outorgante_w		pls_plano.nr_seq_outorgante%type;
nr_seq_segurado_w		pls_segurado.nr_sequencia%type;
vl_material_w			double precision;
dt_ult_vigencia_w		timestamp;
nr_seq_material_preco_w		bigint;
vl_material_simpro_w		double precision;
vl_material_brasindice_w	double precision;
vl_material_tabela_w		double precision;
nr_seq_plano_w			pls_plano.nr_sequencia%type;
nr_seq_requisicao_w		pls_requisicao.nr_sequencia%type;
nr_seq_tipo_acomodacao_w	pls_requisicao.nr_seq_tipo_acomodacao%type;
nr_seq_categoria_w		pls_regra_categoria.nr_seq_categoria%type;
nr_seq_tipo_atendimento_w	pls_tipo_atendimento.nr_sequencia%type;
ie_tipo_atend_tiss_w		pls_requisicao.ie_tipo_atendimento%type;
nr_seq_clinica_w		pls_requisicao.nr_seq_clinica%type;
ie_tipo_guia_w			pls_requisicao.ie_tipo_guia%type;
dados_regra_preco_material_w	pls_cta_valorizacao_pck.dados_regra_preco_material;
ie_regime_atendimento_w		pls_conta.ie_regime_atendimento%type;
ie_saude_ocupacional_w		pls_conta.ie_saude_ocupacional%type;


BEGIN

if (ie_tipo_p	in ('R')) then
	begin
		select	nr_seq_requisicao
		into STRICT	nr_seq_requisicao_w
		from	pls_auditoria
		where	nr_sequencia	= nr_seq_auditoria_p;
	exception
	when others then
		nr_seq_requisicao_w := null;
	end;
	
	if (nr_seq_requisicao_w IS NOT NULL AND nr_seq_requisicao_w::text <> '') then
		select	a.cd_estabelecimento,
			a.nr_seq_prestador,
			a.dt_requisicao,
			a.nr_seq_segurado,
			a.nr_seq_plano,
			a.nr_seq_tipo_acomodacao,
			a.ie_tipo_atendimento,
			a.nr_seq_clinica,
			a.ie_tipo_guia,
			a.ie_regime_atendimento,
			a.ie_saude_ocupacional
		into STRICT	cd_estabelecimento_w,
			nr_seq_prestador_w,
			dt_solicitacao_w,
			nr_seq_segurado_w,
			nr_seq_plano_w,
			nr_seq_tipo_acomodacao_w,
			ie_tipo_atend_tiss_w,
			nr_seq_clinica_w,
			ie_tipo_guia_w,
			ie_regime_atendimento_w,
			ie_saude_ocupacional_w
		from	pls_requisicao a
		where	a.nr_sequencia = nr_seq_requisicao_w;
		
		/* Obter a categoria do tipo de acomodacao */
		if (nr_seq_tipo_acomodacao_w IS NOT NULL AND nr_seq_tipo_acomodacao_w::text <> '') then
			select	max(nr_seq_categoria) 
			into STRICT	nr_seq_categoria_w
			from	pls_regra_categoria 
			where	nr_seq_tipo_acomodacao	= nr_seq_tipo_acomodacao_w;
		end if;

		begin
			select	nr_sequencia
			into STRICT	nr_seq_tipo_atendimento_w
			from	pls_tipo_atendimento
			where	somente_numero(cd_tiss)	= ie_tipo_atend_tiss_w;
		exception
		when others then
			nr_seq_tipo_atendimento_w	:= null;
		end;

		begin
			select	nr_seq_outorgante
			into STRICT	nr_seq_outorgante_w
			from	pls_plano
			where	nr_sequencia	= nr_seq_plano_w;
		exception
			when others then
			nr_seq_outorgante_w	:= 0;
		end;

		begin
			select	ie_tipo_despesa
			into STRICT	ie_tipo_despesa_w
			from	pls_material
			where	nr_sequencia	= nr_seq_material_p;
		exception
		when others then
			ie_tipo_despesa_w := null;
		end;
		
		if (ie_tipo_despesa_w = '7') then
			SELECT * FROM pls_define_preco_material(	cd_estabelecimento_w, nr_seq_prestador_w, dt_solicitacao_w, nr_seq_material_p, 4, ie_tipo_despesa_w, null, 'A', nr_seq_outorgante_w, nr_seq_segurado_w, null, nr_seq_prest_fornec_p, nr_seq_categoria_w, nr_seq_tipo_acomodacao_w, nr_seq_tipo_atendimento_w, nr_seq_clinica_w, ie_tipo_guia_w, null, null, 'S', null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, vl_material_w, dt_ult_vigencia_w, nr_seq_material_preco_w, vl_material_simpro_w, vl_material_brasindice_w, vl_material_tabela_w, dados_regra_preco_material_w, null, ie_regime_atendimento_w, ie_saude_ocupacional_w) INTO STRICT _ora2pg_r;
 vl_material_w := _ora2pg_r.vl_material_p; dt_ult_vigencia_w := _ora2pg_r.dt_ult_vigencia_p; nr_seq_material_preco_w := _ora2pg_r.nr_seq_material_preco_p; vl_material_simpro_w := _ora2pg_r.vl_material_simpro_p; vl_material_brasindice_w := _ora2pg_r.vl_material_brasindice_p; vl_material_tabela_w := _ora2pg_r.vl_material_tabela_p; dados_regra_preco_material_w := _ora2pg_r.dados_regra_preco_material_p;
							
			if (dados_regra_preco_material_w.nr_sequencia IS NOT NULL AND dados_regra_preco_material_w.nr_sequencia::text <> '') then
				vl_material_p	:= vl_material_w;
				
				CALL pls_requisicao_gravar_hist( nr_seq_requisicao_w, 'L', 'O valor de R$' || trim(both to_char(vl_material_w, '999,999,990.00')) || ' do material ' || nr_seq_material_p ||
					' (sequencia) foi obtido da regra ' || dados_regra_preco_material_w.nr_sequencia || '.', null, nm_usuario_p);

				commit;
			end if;
		end if;
	end if;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_valor_mat_analise ( nr_seq_auditoria_p bigint, nr_seq_material_p bigint, nr_seq_prest_fornec_p text, ie_tipo_p text, nm_usuario_p text, vl_material_p INOUT bigint) FROM PUBLIC;

