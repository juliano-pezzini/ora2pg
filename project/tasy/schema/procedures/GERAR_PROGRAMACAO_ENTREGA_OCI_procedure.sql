-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_programacao_entrega_oci ( nr_ordem_compra_p bigint, nr_item_oci_p bigint, dt_primeira_entrega_p timestamp, qt_entregas_p bigint, ie_periodo_entrega_p bigint, nm_usuario_p text) AS $body$
DECLARE



ie_linha_w		integer;
nr_item_oci_w		integer;
qt_material_w		double precision;
qt_material_ww		double precision;
dt_prevista_entrega_w	timestamp;
qt_prevista_entrega_w	double precision;
qt_prevista_entrega_ww	double precision;
nr_sequencia_w		bigint;


c00 CURSOR FOR
SELECT	nr_item_oci
from	ordem_compra_item
where	nr_ordem_compra = nr_ordem_compra_p
and (nr_item_oci = nr_item_oci_p or nr_item_oci_p = 0);

c01 CURSOR FOR
SELECT	row_number() OVER () AS rownum,
	--a.qt_material,
	--trunc(dividir(a.qt_material, qt_entregas_p)),
	qt_prevista_entrega_ww,
	trunc(dividir(qt_prevista_entrega_ww, qt_entregas_p)),
	CASE WHEN rownum=1 THEN  dt_primeira_entrega_p  ELSE dt_primeira_entrega_p + (ie_periodo_entrega_p * (rownum - 1)) END
from	tabela_sistema b,
	ordem_compra_item a
where	a.nr_ordem_compra = nr_ordem_compra_p
and	a.nr_item_oci = nr_item_oci_w  LIMIT (qt_entregas_p);


BEGIN

OPEN C00;
LOOP
FETCH C00 INTO
	nr_item_oci_w;
EXIT WHEN NOT FOUND; /* apply on c00 */
	begin

	select	coalesce(sum(qt_prevista_entrega),0)
	into STRICT	qt_prevista_entrega_ww
	from	ordem_compra_item_entrega
	where	nr_ordem_compra = nr_ordem_compra_p
	and	nr_item_oci = nr_item_oci_w
	and	coalesce(dt_cancelamento::text, '') = ''
	and	coalesce(qt_real_entrega,0) = 0;

	if (qt_prevista_entrega_ww = 0) then

		select	qt_material
		into STRICT	qt_prevista_entrega_ww
		from	ordem_compra_item
		where	nr_ordem_compra = nr_ordem_compra_p
		and	nr_item_oci = nr_item_oci_w;

	end if;

	delete
	from	ordem_compra_item_entrega
	where	nr_ordem_compra = nr_ordem_compra_p
	and	nr_item_oci = nr_item_oci_w
	and	coalesce(dt_cancelamento::text, '') = ''
	and	coalesce(qt_real_entrega,0) = 0;

	OPEN C01;
	LOOP
	FETCH C01 INTO
		ie_linha_w,
		qt_material_w,
		qt_prevista_entrega_w,
		dt_prevista_entrega_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
		begin

		select	nextval('ordem_compra_item_entrega_seq')
		into STRICT	nr_sequencia_w
		;

		insert into ordem_compra_item_entrega(
			nr_sequencia,
			nr_ordem_compra,
			nr_item_oci,
			dt_prevista_entrega,
			dt_entrega_original,
			dt_entrega_limite,
			qt_prevista_entrega,
			dt_atualizacao,
			nm_usuario)
		values ( nr_sequencia_w,
			nr_ordem_compra_p,
			nr_item_oci_w,
			dt_prevista_entrega_w,
			dt_prevista_entrega_w,
			dt_prevista_entrega_w,
			qt_prevista_entrega_w,
			clock_timestamp(),
			nm_usuario_p);

		if (ie_linha_w = qt_entregas_p) then
			select	sum(qt_prevista_entrega)
			into STRICT	qt_material_ww
			from	ordem_compra_item_entrega
			where	nr_ordem_compra	= nr_ordem_compra_p
			and	nr_item_oci	= nr_item_oci_w
			and	coalesce(dt_cancelamento::text, '') = ''
			and	coalesce(qt_real_entrega,0) = 0;

			if (qt_material_ww	<> qt_material_w) then
				update	ordem_compra_item_entrega
				set	qt_prevista_entrega = qt_prevista_entrega + (qt_material_w - qt_material_ww)
				where	nr_ordem_compra	= nr_ordem_compra_p
				and	nr_item_oci	= nr_item_oci_w
				and	nr_sequencia	= nr_sequencia_w;
			end if;
		end if;

		end;
	end loop;
	close c01;
	end;
end loop;
close c00;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_programacao_entrega_oci ( nr_ordem_compra_p bigint, nr_item_oci_p bigint, dt_primeira_entrega_p timestamp, qt_entregas_p bigint, ie_periodo_entrega_p bigint, nm_usuario_p text) FROM PUBLIC;

