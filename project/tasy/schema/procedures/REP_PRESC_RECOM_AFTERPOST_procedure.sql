-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE rep_presc_recom_afterpost ( nr_prescricao_p bigint, nm_usuario_p text, ie_opcao_p text, nr_sequencia_p bigint, ie_gerar_kit_automatico_p text, ie_check_alta_p text default 'N', ie_acao_p text default 'N') AS $body$
DECLARE


ie_recomendacao_alta_w		varchar(1);
nr_horas_validade_w			integer;
dt_primeiro_horario_w		timestamp;
ie_atualiza_prescr_alta_w	varchar(1);
ie_seleciona_kit_rec_w		varchar(1);
cd_estabelecimento_w		smallint;
cd_convenio_w				bigint;
cd_setor_prescricao_w		prescr_medica.cd_setor_atendimento%type;
nr_seq_agrupamento_w		setor_atendimento.nr_seq_agrupamento%type;
cd_kit_w					kit_mat_recomendacao.cd_kit%type;
cd_recomendacao_w			prescr_recomendacao.cd_recomendacao%type;

c01 CURSOR FOR
	SELECT	cd_kit
	from	kit_mat_recomendacao
	where	cd_recomendacao = cd_recomendacao_w
	and		((coalesce(cd_perfil,0) = 0) or (cd_perfil = obter_perfil_ativo))
	and		((coalesce(cd_convenio::text, '') = '') or (cd_convenio = cd_convenio_w))
	and		((coalesce(nr_seq_agrupamento::text, '') = '') or (nr_seq_agrupamento = nr_seq_agrupamento_w))
	and		((coalesce(cd_setor_atendimento,0) = 0) or (cd_setor_atendimento = cd_setor_prescricao_w));


BEGIN

select	coalesce(max(cd_estabelecimento),1),
		max(cd_setor_atendimento),
		max(obter_convenio_atendimento(nr_atendimento))
into STRICT	cd_estabelecimento_W,
		cd_setor_prescricao_w,
		cd_convenio_w
from	prescr_medica
where	nr_prescricao = nr_prescricao_p;

select	max(nr_seq_agrupamento)
into STRICT	nr_seq_agrupamento_w
from	setor_atendimento
where	cd_setor_atendimento = cd_setor_prescricao_w;

ie_atualiza_prescr_alta_w := Obter_Param_Usuario(924, 409, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_atualiza_prescr_alta_w);
ie_seleciona_kit_rec_w := Obter_Param_Usuario(924, 458, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_seleciona_kit_rec_w);

ie_recomendacao_alta_w := Obter_se_recomendacao_alta(nr_prescricao_p);

if (ie_recomendacao_alta_w  = 'S') then
	begin

	select	max(CASE WHEN ie_atualiza_prescr_alta_w='N' THEN dt_primeiro_horario  ELSE dt_prescricao END ),
		max(nr_horas_validade)
	into STRICT	dt_primeiro_horario_w,
		nr_horas_validade_w
	from	prescr_medica
	where	nr_prescricao = nr_prescricao_p;

	if (ie_atualiza_prescr_alta_w = 'T') then
		nr_horas_validade_w	:= 24;
	end if;

	update	prescr_medica
        set	ie_prescricao_alta 	= 'S',
		dT_primeiro_horario 	= dt_primeiro_horario_w,
		nr_horas_validade	= nr_horas_validade_w
	where	nr_prescricao 		= nr_prescricao_p;

	if (ie_atualiza_prescr_alta_w	<> 'N') then
		CALL Recalcular_hor_prescricao(nr_prescricao_p, nm_usuario_p);
		CALL recalcular_hora_sol(nr_prescricao_p, dt_primeiro_horario_w, cd_estabelecimento_w, obter_perfil_ativo, nm_usuario_p);
	end if;

	commit;
	end;
else
	begin
	if (ie_check_alta_p = 'S') then
		update	prescr_medica
		set	ie_prescricao_alta 	= 'N'
		where	nr_prescricao 	= nr_prescricao_p;
		commit;
	end if;
	end;
end if;

select max(cd_recomendacao)
  into STRICT cd_recomendacao_w
  from prescr_recomendacao
 where nr_prescricao =  nr_prescricao_p
   and nr_sequencia = nr_sequencia_p;

if (ie_acao_p = 'I') then
	CALL Gerar_proced_assoc_rec(nr_prescricao_p, cd_recomendacao_w, nm_usuario_p,'I');
end if;
CALL consistir_itens_prescricao(nr_prescricao_p,nm_usuario_p,ie_opcao_p);

if (ie_seleciona_kit_rec_w = 'N') then
	open c01;
		loop
			fetch c01 into
				cd_kit_w;
			EXIT WHEN NOT FOUND; /* apply on C01 */
				CALL Inserir_kit_recomendacao(nm_usuario_p, nr_prescricao_p, nr_sequencia_p, cd_recomendacao_w, cd_kit_w);
		end loop;
	close C01;
end if;

if (ie_gerar_kit_automatico_p IS NOT NULL AND ie_gerar_kit_automatico_p::text <> '') and (ie_gerar_kit_automatico_p = 'S') then
	CALL Gerar_Kit_rec_Prescricao(cd_estabelecimento_w,nr_prescricao_p,nr_sequencia_p,nm_usuario_p,'N','N');
end if;
commit;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE rep_presc_recom_afterpost ( nr_prescricao_p bigint, nm_usuario_p text, ie_opcao_p text, nr_sequencia_p bigint, ie_gerar_kit_automatico_p text, ie_check_alta_p text default 'N', ie_acao_p text default 'N') FROM PUBLIC;

