-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_rel_consulta_preco ( cd_convenio_p bigint, cd_plano_p text, cd_categoria_p bigint, ie_preco_informado_p bigint, dt_vigencia_p timestamp, cd_tipo_acomodacao_p bigint, ie_tipo_atendimento_p bigint, cd_setor_atendimento_p bigint) AS $body$
DECLARE


		
cd_estabelecimento_w		bigint;
cd_edicao_amb_w			convenio_amb.cd_edicao_amb%type;
cd_edicao_ajuste_w		convenio_amb.cd_edicao_amb%type;
cd_procedimento_tuss_w 		proc_interno.cd_procedimento_tuss%type;
cd_convenio_w			convenio.cd_convenio%type;
cd_plano_w			convenio_plano.cd_plano%type;
cd_edicao_amb_grupo_dif_w		grupo_dif_fat_edicao_regra.cd_edicao_amb%type;
cd_procedimento_w 		proc_interno.cd_procedimento%type;
cd_proc_prior_w			procedimento.cd_procedimento%type;
cd_proced_conv_w			proc_interno_conv.cd_procedimento%type;
cd_convenio_glosa_ww		convenio.cd_convenio%type;
cd_categoria_glosa_ww		categoria_convenio.cd_categoria%type;
cd_categoria_w			categoria_convenio.cd_categoria%type;
cd_edicao_amb_prior_w		proc_interno_conv.cd_edicao_amb%type;
vl_procedimento_w			procedimento_paciente.vl_procedimento%type;
vl_custo_operacional_w		double precision;
vl_anestesista_w			double precision;
vl_medico_w			double precision;
vl_auxiliares_w			double precision;
vl_materiais_w			double precision;
vl_pto_procedimento_w		double precision;
vl_pto_custo_operac_w		double precision;
vl_pto_anestesista_w		double precision;
vl_pto_medico_w			double precision;
vl_pto_auxiliares_w		double precision;
vl_pto_materiais_w		double precision;
vl_count_zero_w 			double precision;
vl_ch_honorarios_w		double precision	:= 1;
vl_ch_custo_oper_w		double precision	:= 1;
vl_m2_filme_w			double precision	:= 0;
vl_retorno_w			double precision;
nr_seq_ajuste_proc_def_w		bigint;
nr_proc_interno_w   		bigint;
nr_sequencia_w  			bigint;
nr_seq_grupo_dif_fat_w		bigint;
nr_seq_cbhpm_edicao_prior_w	convenio_amb.nr_seq_cbhpm_edicao%type;
nr_seq_ajuste_proc_ww		bigint;
nr_seq_cbhpm_edicao_w		bigint;
nr_seq_cbhpm_edicao_regra_w	bigint;
nr_seq_proc_conv_w		bigint;
ie_origem_proced_w		proc_interno.ie_origem_proced%type;
ie_origem_proc_interno_w		proc_interno.ie_origem_proced%type;
ie_preco_informado_w		varchar(10);
ie_origem_proced_conv_w		bigint;
ie_prioridade_edicao_w		varchar(01);	
ie_prioridade_ajuste_proc_w	varchar(01);
ie_proc_interno_conv_w		varchar(10);
ie_regra_prior_edicao_w		varchar(10);
ie_origem_proc_filtro_w		bigint;
ie_origem_proc_prior_w		procedimento.ie_origem_proced%type;
ie_origem_proced_edicao_w		edicao_amb.cd_edicao_amb%type;
ie_tipo_convenio_w		convenio.ie_tipo_convenio%type;
ie_glosa_w			varchar(10);
ie_autor_particular_w		varchar(10);
ie_encontrou_edicao_w		varchar(10);
ie_prioridade_conv_w		bigint;
qt_proc_edicao_w			bigint;
qt_proc_w			bigint;
qt_preco_w			bigint;
qt_porte_anestesico_w		bigint;
qt_pontos_w			preco_amb.qt_pontuacao%type;
dt_inicio_vigencia_w		timestamp;
dt_vigencia_w			timestamp;
dt_inicio_vig_conv_w		timestamp;
ds_procedimento_w 		varchar(255);
ds_pseudo_w			varchar(255);
tx_ajuste_geral_w			double precision	:= 1;
contador_w			double precision	:= 0;

/*Obter_Proc_Tab_Inter_conv*/

c00 CURSOR FOR
SELECT 	nr_sequencia,
	cd_procedimento,
	ie_origem_proced,
	cd_procedimento_tuss,
	nr_seq_grupo_dif_fat	
from	proc_interno
where 	ie_situacao = 'A'
order by nr_sequencia asc;

c02 CURSOR FOR
SELECT 	cd_convenio,
	ie_tipo_convenio
from 	convenio
where 	cd_convenio 	in (SELECT cd_convenio from convenio_estabelecimento where cd_estabelecimento = cd_estabelecimento_w)
and	cd_convenio	= cd_convenio_p
and 	ie_situacao	= 'A'
order 	by 1;

C03 CURSOR FOR
SELECT	cd_plano
from	convenio_plano
where	cd_convenio 	= cd_convenio_w
and	cd_plano 	= coalesce(cd_plano_p, cd_plano)
and	ie_situacao 	= 'A'
order by 1;

c04 CURSOR FOR
SELECT	cd_categoria
from	categoria_convenio
where	cd_convenio 		= cd_convenio_w
and	cd_categoria		= coalesce(cd_categoria_p,cd_categoria)
and 	cd_tipo_acomodacao	= coalesce(cd_tipo_acomodacao_p,cd_tipo_acomodacao)
and	ie_situacao	= 'A'
order by 1;


C05 CURSOR FOR
	SELECT	coalesce(cd_edicao_amb,0)
	from	grupo_dif_fat_edicao_regra
	where	nr_seq_grupo_dif_fat = nr_seq_grupo_dif_fat_w
	and (coalesce(cd_convenio, coalesce(cd_convenio_w,0)) 	= coalesce(cd_convenio_w,0))
	and (coalesce(cd_categoria, coalesce(cd_categoria_w,'0')) 	= coalesce(cd_categoria_w,'0'))
	and (coalesce(cd_plano, coalesce(cd_plano_w,'0')) 	= coalesce(cd_plano_w,'0'))
	and	coalesce(ie_situacao,'A') = 'A'
	order by coalesce(cd_convenio,0),
		coalesce(cd_categoria_w,'0'),
		coalesce(cd_plano,'0');
		
c06 CURSOR FOR
	SELECT	x.ie_prioridade,
		x.dt_inicio_vigencia,
		x.cd_edicao_amb,
		x.nr_seq_cbhpm_edicao
	from	edicao_amb y,
		convenio_amb x
	where	x.cd_edicao_amb 		= y.cd_edicao_amb
	and	x.cd_estabelecimento 	= cd_estabelecimento_w
	and	x.cd_convenio 		= cd_convenio_w
	and	x.cd_categoria 		= cd_categoria_w
	and	coalesce(x.ie_situacao,'A')	= 'A'
	and	ie_regra_prior_edicao_w	= 'DT'
	and	(x.dt_inicio_vigencia =	(SELECT	max(dt_inicio_vigencia)
					from	convenio_amb a
					where	a.cd_estabelecimento 	= cd_estabelecimento_w
					and	a.cd_convenio 		= cd_convenio_w
					and	a.cd_categoria 		= cd_categoria_w
					and	coalesce(a.ie_situacao,'A')= 'A'
					and	dt_vigencia_w between a.dt_inicio_vigencia and coalesce(a.dt_final_vigencia,dt_vigencia_w)))
	
union

	select 	x.ie_prioridade,
		x.dt_inicio_vigencia,
		x.cd_edicao_amb,
		x.nr_seq_cbhpm_edicao
	from	edicao_amb y,
		convenio_amb x
	where	x.cd_edicao_amb 		= y.cd_edicao_amb
	and	x.cd_estabelecimento 	= cd_estabelecimento_w
	and	x.cd_convenio 		= cd_convenio_w
	and	x.cd_categoria 		= cd_categoria_w
	and 	coalesce(x.ie_situacao,'A')	= 'A'
	and	ie_regra_prior_edicao_w	= 'PR'
	and	((coalesce(x.dt_final_vigencia::text, '') = '') or (dt_vigencia_w <= x.dt_final_vigencia))
	order by	1, 2;

c07 CURSOR FOR
SELECT	cd_procedimento,
	ie_origem_proced
from	proc_interno_conv
where	nr_seq_proc_interno		= nr_proc_interno_w
and (cd_convenio			= cd_convenio_w 			or coalesce(cd_convenio::text, '') = '')
and (cd_edicao_amb 			= cd_edicao_amb_prior_w)
and (ie_tipo_atendimento		= ie_tipo_atendimento_p		or coalesce(ie_tipo_atendimento::text, '') = '')
and 	((ie_origem_proc_filtro 		= ie_origem_proc_filtro_w) 	or (coalesce(ie_origem_proc_filtro::text, '') = ''))
and 	((cd_setor_atendimento 		= coalesce(cd_setor_atendimento_p,0)) 	or (coalesce(cd_setor_atendimento::text, '') = ''))
and 	((cd_estabelecimento   		= cd_estabelecimento_w) 		or (coalesce(cd_estabelecimento::text, '') = ''))
and (coalesce(cd_categoria, cd_categoria_w) 	= cd_categoria_w)
and	coalesce(cd_tipo_acomodacao, coalesce(cd_tipo_acomodacao_p,0)) = coalesce(cd_tipo_acomodacao_p,0)
and	dt_vigencia_w between coalesce(dt_inicio_vigencia, dt_vigencia_w) and coalesce(dt_final_vigencia, dt_vigencia_w)
and 	coalesce(nr_seq_cbhpm_edicao, coalesce(nr_seq_cbhpm_edicao_prior_w,0)) = coalesce(nr_seq_cbhpm_edicao_prior_w,0)
and	coalesce(ie_situacao,'A') = 'A'
order by
	coalesce(cd_edicao_amb,0),
	coalesce(nr_seq_cbhpm_edicao,0),
	coalesce(cd_convenio,0),
	coalesce(ie_tipo_atendimento,0),
	coalesce(cd_setor_atendimento,0),
	coalesce(cd_estabelecimento,0),
	coalesce(cd_categoria,'0'),
	coalesce(cd_tipo_acomodacao,0);
	
c08 CURSOR FOR
SELECT	cd_procedimento,
	ie_origem_proced
from	proc_interno_conv
where	nr_seq_proc_interno		= nr_proc_interno_w
and (cd_convenio			= cd_convenio_w 			or coalesce(cd_convenio::text, '') = '')
and (cd_edicao_amb			= cd_edicao_amb_w 		or coalesce(cd_edicao_amb::text, '') = '')
and (ie_tipo_atendimento		= ie_tipo_atendimento_p		or coalesce(ie_tipo_atendimento::text, '') = '')
and 	((ie_origem_proc_filtro 		= ie_origem_proc_filtro_w) 	or (coalesce(ie_origem_proc_filtro::text, '') = ''))
and 	((cd_setor_atendimento 		= coalesce(cd_setor_atendimento_p,0)) 	or (coalesce(cd_setor_atendimento::text, '') = ''))
and 	((cd_estabelecimento   		= cd_estabelecimento_w) 		or (coalesce(cd_estabelecimento::text, '') = ''))
and (coalesce(cd_categoria, coalesce(cd_categoria_w,'0')) 			= coalesce(cd_categoria_w,'0'))
and	coalesce(cd_tipo_acomodacao, coalesce(cd_tipo_acomodacao_p,0)) 		= coalesce(cd_tipo_acomodacao_p,0)
and	dt_vigencia_w between coalesce(dt_inicio_vigencia, dt_vigencia_w) and coalesce(dt_final_vigencia, dt_vigencia_w)
and 	coalesce(nr_seq_cbhpm_edicao, coalesce(nr_seq_cbhpm_edicao_w,0)) 	= coalesce(nr_seq_cbhpm_edicao_w,0)
and	coalesce(ie_situacao,'A') = 'A'
order by
	coalesce(cd_edicao_amb,0),
	coalesce(nr_seq_cbhpm_edicao,0),
	coalesce(cd_convenio,0),
	coalesce(ie_tipo_atendimento,0),
	coalesce(cd_setor_atendimento,0),
	coalesce(cd_estabelecimento,0),
	coalesce(cd_categoria,'0'),
	coalesce(cd_tipo_acomodacao,0);
	

BEGIN

dt_vigencia_w := coalesce(dt_vigencia_p,clock_timestamp());

cd_estabelecimento_w := obter_estabelecimento_ativo();

select	coalesce(max(ie_prioridade_edicao_amb), 'N'),
	coalesce(max(ie_prioridade_ajuste_proc), 'N'),
	coalesce(max(ie_proc_interno_conv), 'N')
into STRICT	ie_prioridade_edicao_w,
	ie_prioridade_ajuste_proc_w,
	ie_proc_interno_conv_w
from	parametro_faturamento
where	cd_estabelecimento	= cd_estabelecimento_w;


delete from w_rel_consulta_preco
where nm_usuario = wheb_usuario_pck.get_nm_usuario;
commit;

open C02;
loop
fetch C02 into	
	cd_convenio_w,
	ie_tipo_convenio_w;
EXIT WHEN NOT FOUND; /* apply on C02 */
begin
		
	select	coalesce(max(ie_regra_prior_edicao), 'DT')
	into STRICT	ie_regra_prior_edicao_w
	from	convenio_estabelecimento
	where	cd_estabelecimento = cd_estabelecimento_w
	and	cd_convenio 	 = cd_convenio_w;
	
	open C04;
	loop
	fetch C04 into	
		cd_categoria_w;
	EXIT WHEN NOT FOUND; /* apply on C04 */
	begin
		
	ie_origem_proc_filtro_w:= Obter_Origem_Proced_Cat(cd_estabelecimento_w, ie_tipo_atendimento_p, ie_tipo_convenio_w, cd_convenio_w, cd_categoria_w);
			
	open C03;
	loop
	fetch C03 into	
		cd_plano_w;
	EXIT WHEN NOT FOUND; /* apply on C03 */
	begin				
						
		open	c00;
		loop
		fetch	c00 into
			nr_proc_interno_w,
			cd_procedimento_w,
			ie_origem_proc_interno_w,
			cd_procedimento_tuss_w,
			nr_seq_grupo_dif_fat_w;			
		EXIT WHEN NOT FOUND; /* apply on c00 */
		begin		
		
		if (coalesce(nr_seq_grupo_dif_fat_w,0) > 0) then	
			cd_edicao_amb_w:= 0;
			open c05;
			loop
			fetch c05 into	
				cd_edicao_amb_grupo_dif_w;
			EXIT WHEN NOT FOUND; /* apply on c05 */
				begin
				cd_edicao_amb_w:= cd_edicao_amb_grupo_dif_w;
				end;
			end loop;
			close c05;
		end if;	
								
		if	((coalesce(nr_seq_grupo_dif_fat_w,0) = 0) or
			((coalesce(nr_seq_grupo_dif_fat_w,0) > 0) and (cd_edicao_amb_w = 0))) then

			if (ie_prioridade_edicao_w = 'N') then	
					select	coalesce(max(cd_edicao_amb),0),
						max(nr_seq_cbhpm_edicao)
					into STRICT	cd_edicao_amb_w,
						nr_seq_cbhpm_edicao_w
					from 	convenio_amb
					where (cd_estabelecimento     = cd_estabelecimento_w)
					and (cd_convenio            = cd_convenio_w)
					and	((cd_categoria		= coalesce(cd_categoria_w,'0')) or (coalesce(cd_categoria_w,'0') ='0'))
					and (coalesce(ie_situacao,'A')   = 'A')
					and 	(dt_inicio_vigencia     = 
							(SELECT	max(dt_inicio_vigencia)
							from 	convenio_amb a	
							where (a.cd_estabelecimento  	= cd_estabelecimento_w)
							and (a.cd_convenio         	= cd_convenio_w)
							and (cd_categoria		= cd_categoria_w)
							and (coalesce(a.ie_situacao,'A')	= 'A')
							and (a.dt_inicio_vigencia 	<=  clock_timestamp())));
			else
				
				if (ie_proc_interno_conv_w = 'S') then
					ie_encontrou_edicao_w	:= 'N';
						
					open C06;
					loop
					fetch C06 into
						ie_prioridade_conv_w,
						dt_inicio_vig_conv_w,
						cd_edicao_amb_prior_w,
						nr_seq_cbhpm_edicao_prior_w;
					EXIT WHEN NOT FOUND; /* apply on C06 */
					begin	
					
						if (ie_encontrou_edicao_w = 'N') then
							cd_proc_prior_w		:= null;
							ie_origem_proc_prior_w	:= null;	
							
							open C07;
							loop
							fetch C07 into	
								cd_proc_prior_w,
								ie_origem_proc_prior_w;
							EXIT WHEN NOT FOUND; /* apply on C07 */
							begin
								ie_encontrou_edicao_w	:= 'S';
								cd_proc_prior_w		:= cd_proc_prior_w;
								ie_origem_proc_prior_w	:= ie_origem_proc_prior_w;
							end;
							end loop;
							close C07;
										
							if (coalesce(cd_proc_prior_w,0) > 0) then
											
								select	coalesce(max(ie_origem_proced), ie_origem_proc_prior_w)
								into STRICT	ie_origem_proced_edicao_w
								from	edicao_amb
								where	cd_edicao_amb	= cd_edicao_amb_prior_w;
												
								if (ie_origem_proced_edicao_w = 5) then
									select	count(*)
									into STRICT	qt_preco_w
									from	cbhpm_preco
									where	cd_procedimento		= cd_proc_prior_w
									and	ie_origem_proced		= ie_origem_proc_prior_w;
								else
									select	count(*)
									into STRICT	qt_preco_w
									from	preco_amb
									where	cd_edicao_amb		= cd_edicao_amb_prior_w
									and	cd_procedimento		= cd_proc_prior_w
									and	ie_origem_proced		= coalesce(ie_origem_proc_prior_w, ie_origem_proced)
									and	trunc(coalesce(dt_vigencia_p,clock_timestamp()),'dd') between coalesce(dt_inicio_vigencia,clock_timestamp() - interval '3650 days') and coalesce(dt_final_vigencia, coalesce(dt_vigencia_p,clock_timestamp()));
								end if;
												
								if (coalesce(qt_preco_w,0) = 0) then
									ie_encontrou_edicao_w	:= 'N';
								else
									cd_procedimento_w		:= cd_proc_prior_w;
									ie_origem_proced_w	:= ie_origem_proc_prior_w;
								end if;
							end if;
							
						end if;						
					end;
					end loop;
					close C06;
						
				end if;
					
				SELECT * FROM obter_edicao_proc_conv(cd_estabelecimento_w, cd_convenio_w, cd_categoria_w, clock_timestamp(), cd_procedimento_w, cd_edicao_amb_w, vl_ch_honorarios_w, vl_ch_custo_oper_w, vl_m2_filme_w, dt_inicio_vigencia_w, tx_ajuste_geral_w, nr_seq_cbhpm_edicao_w) INTO STRICT cd_edicao_amb_w, vl_ch_honorarios_w, vl_ch_custo_oper_w, vl_m2_filme_w, dt_inicio_vigencia_w, tx_ajuste_geral_w, nr_seq_cbhpm_edicao_w;
			end if;			
		end if;
		
		if (coalesce(nr_seq_grupo_dif_fat_w,0) = 0) then
			cd_edicao_ajuste_w	:= 0;
			if (cd_edicao_ajuste_w = 0) then
				begin
				SELECT * FROM obter_regra_ajuste_proc(cd_estabelecimento_w, cd_convenio_w, cd_categoria_w, cd_procedimento_w, ie_origem_proced_w, null, clock_timestamp(), 0, ie_tipo_atendimento_p, 0, null, 0, 0, null, nr_proc_interno_w, null, cd_plano_w, null, null, null, vl_retorno_w, vl_retorno_w, vl_retorno_w, vl_retorno_w, vl_retorno_w, vl_retorno_w, ie_preco_informado_w, ie_glosa_w, vl_retorno_w, vl_retorno_w, cd_edicao_ajuste_w, vl_retorno_w, vl_retorno_w, vl_retorno_w, vl_retorno_w, vl_retorno_w, vl_retorno_w, vl_retorno_w, vl_retorno_w, null, 0, ie_autor_particular_w, cd_convenio_glosa_ww, cd_categoria_glosa_ww, nr_seq_ajuste_proc_ww, null, null, null, null, null, null, null, null, vl_retorno_w, null, null, null, null, null, null, null, null, null, null) INTO STRICT vl_retorno_w, vl_retorno_w, vl_retorno_w, vl_retorno_w, vl_retorno_w, vl_retorno_w, ie_preco_informado_w, ie_glosa_w, vl_retorno_w, vl_retorno_w, cd_edicao_ajuste_w, vl_retorno_w, vl_retorno_w, vl_retorno_w, vl_retorno_w, vl_retorno_w, vl_retorno_w, vl_retorno_w, vl_retorno_w, ie_autor_particular_w, cd_convenio_glosa_ww, cd_categoria_glosa_ww, nr_seq_ajuste_proc_ww, vl_retorno_w;	
				exception
					when others then
					cd_edicao_ajuste_w	:= 0;
				end;
			end if;
			
			if (cd_edicao_ajuste_w IS NOT NULL AND cd_edicao_ajuste_w::text <> '') and (cd_edicao_ajuste_w <> 0) then
				cd_edicao_amb_w		:= cd_edicao_ajuste_w;
			end if;
			
			nr_seq_cbhpm_edicao_regra_w:= null;
			if (coalesce(nr_seq_ajuste_proc_ww,0) > 0) then
				select	max(nr_seq_cbhpm_edicao)
				into STRICT	nr_seq_cbhpm_edicao_regra_w
				from	regra_ajuste_proc
				where 	nr_sequencia		= nr_seq_ajuste_proc_ww;
			end if;
			
		end if;
		
		nr_seq_cbhpm_edicao_w:= coalesce(nr_seq_cbhpm_edicao_regra_w, nr_seq_cbhpm_edicao_w);

		if (cd_convenio_w IS NOT NULL AND cd_convenio_w::text <> '') or (cd_edicao_amb_w IS NOT NULL AND cd_edicao_amb_w::text <> '') or (ie_tipo_atendimento_p IS NOT NULL AND ie_tipo_atendimento_p::text <> '') or (ie_origem_proc_filtro_w IS NOT NULL AND ie_origem_proc_filtro_w::text <> '') or (cd_setor_atendimento_p IS NOT NULL AND cd_setor_atendimento_p::text <> '') then
									
			open c08;
			loop
			fetch c08 into	cd_proced_conv_w,
					ie_origem_proced_conv_w;
			EXIT WHEN NOT FOUND; /* apply on c08 */
			begin
				cd_procedimento_w		:= cd_proced_conv_w;
				ie_origem_proced_w	:= ie_origem_proced_conv_w;
			end;
			end loop;
			close c08;

		end if;							

		SELECT * FROM define_preco_procedimento(cd_estabelecimento_w, cd_convenio_w, cd_categoria_w, dt_vigencia_w, cd_procedimento_w, 0, null, 0, null, 0, 0, 0, 0, null, cd_plano_w, 0, 0, null, vl_procedimento_w, vl_custo_operacional_w, vl_anestesista_w, vl_medico_w, vl_auxiliares_w, vl_materiais_w, vl_pto_procedimento_w, vl_pto_custo_operac_w, vl_pto_anestesista_w, vl_pto_medico_w, vl_pto_auxiliares_w, vl_pto_materiais_w, qt_porte_anestesico_w, qt_pontos_w, cd_edicao_amb_w, ie_preco_informado_w, nr_seq_ajuste_proc_def_w, 0, null, 0, null, null, null, null, null, null, null, null, null, null, null, null, null, ie_origem_proced_w, null, null, null) INTO STRICT vl_procedimento_w, vl_custo_operacional_w, vl_anestesista_w, vl_medico_w, vl_auxiliares_w, vl_materiais_w, vl_pto_procedimento_w, vl_pto_custo_operac_w, vl_pto_anestesista_w, vl_pto_medico_w, vl_pto_auxiliares_w, vl_pto_materiais_w, qt_porte_anestesico_w, qt_pontos_w, cd_edicao_amb_w, ie_preco_informado_w, nr_seq_ajuste_proc_def_w;
						
				select 	count(*)
				into STRICT 	qt_proc_w
				from 	w_rel_consulta_preco 
				where 	nm_usuario 	= wheb_usuario_pck.get_nm_usuario
				and 	ds_pseudo 	= ds_pseudo_w
				and 	vl_preco		= vl_procedimento_w
				and 	ie_origem_proced	= ie_origem_proced_w
				and 	cd_versao	= cd_procedimento_tuss_w
				and 	dt_vigencia	= dt_vigencia_P
				and	cd_procedimento	= cd_procedimento_w
				and	cd_convenio	= cd_convenio_w  
				and	cd_plano		= cd_plano_w  
				and	cd_categoria	= cd_categoria_p
				and	nr_seq_proc_interno = nr_proc_interno_w;

				if	((ie_preco_informado_p = 0 AND vl_procedimento_w > 0) or
					(ie_preco_informado_p = 1 AND vl_procedimento_w <= 0) or (ie_preco_informado_p = 2) and (qt_proc_w = 0)) then
									
					ds_procedimento_w := substr(Obter_Desc_Procedimento(cd_procedimento_w,ie_origem_proced_w),1,255);	
								
					select max(ds_pseudo)
					into STRICT   ds_pseudo_w
					from   proc_interno_pseudo
					where  nr_seq_proc_interno = nr_proc_interno_w;

					select	nextval('w_consulta_preco_seq')
					into STRICT	nr_sequencia_w
					;	
									
					insert	into w_rel_consulta_preco(nr_sequencia,
									dt_atualizacao,    
									nm_usuario,
									ds_pseudo,
									vl_preco,
									ds_origem_preco,
									ie_origem_proced,
									cd_versao,
									dt_vigencia, 
									cd_procedimento,
									ds_item_proc,
									cd_convenio,    
									cd_plano,     
									cd_categoria, 
									nr_seq_proc_interno)
								values (nr_sequencia_w,
									clock_timestamp(),
									wheb_usuario_pck.get_nm_usuario,
									ds_pseudo_w,
									vl_procedimento_w,
									obter_desc_edicao_amb(cd_edicao_amb_w),
									ie_origem_proced_w,
									cd_procedimento_tuss_w,
									dt_vigencia_w,
									cd_procedimento_w,
									ds_procedimento_w,
									cd_convenio_w,
									cd_plano_w,
									cd_categoria_w,
									nr_proc_interno_w);		

				end if;		
			end;
			end loop;
			close c00;
			commit;				
		end;
		end loop;
		close C03;
		
	end;
	end loop;
	close C04;
	
end;
end loop;
close C02;
	
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_rel_consulta_preco ( cd_convenio_p bigint, cd_plano_p text, cd_categoria_p bigint, ie_preco_informado_p bigint, dt_vigencia_p timestamp, cd_tipo_acomodacao_p bigint, ie_tipo_atendimento_p bigint, cd_setor_atendimento_p bigint) FROM PUBLIC;

