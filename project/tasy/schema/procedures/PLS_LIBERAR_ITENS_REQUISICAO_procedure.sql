-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_liberar_itens_requisicao ( nr_seq_requisicao_p bigint, nr_seq_req_proc_p bigint, nr_seq_req_mat_p bigint, qt_item_p bigint, nm_usuario_p text) AS $body$
DECLARE


/* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Finalidade: Liberar os itens que estão negados na requisição
-------------------------------------------------------------------------------------------------------------------
Locais de chamada direta:
[  ]  Objetos do dicionário [X] Tasy (Delphi/Java) [  ] Portal [  ]  Relatórios [ ] Outros:
 ------------------------------------------------------------------------------------------------------------------
Pontos de atenção:Performance.
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */
cd_procedimento_w		pls_requisicao_proc.cd_procedimento%type;
ds_procedimento_w		varchar(255);
nr_seq_material_w		pls_requisicao_mat.nr_seq_material%type;
ds_material_w			varchar(255);
ie_tipo_intercambio_w		pls_requisicao.ie_tipo_intercambio%type;
qt_pedido_aut_w			integer;
qt_pedido_compl_aut_w		integer;
qt_resp_pedido_aut_w		integer;


BEGIN
select	coalesce(ie_tipo_intercambio,'X')
into STRICT	ie_tipo_intercambio_w
from	pls_requisicao
where	nr_sequencia	= nr_seq_requisicao_p;

if (ie_tipo_intercambio_w	= 'E') then
	-- Não é possível liberar os itens de uma requisição de intercâmbio oriunda de outra operadora.
	CALL wheb_mensagem_pck.exibir_mensagem_abort(352289, null);
elsif (ie_tipo_intercambio_w	= 'I') then
	select	count(1)
	into STRICT	qt_pedido_aut_w
	from	ptu_pedido_autorizacao
	where	nr_seq_requisicao	= nr_seq_requisicao_p;

	select	count(1)
	into STRICT	qt_pedido_compl_aut_w
	from	ptu_pedido_autorizacao
	where	nr_seq_requisicao	= nr_seq_requisicao_p;

	if (qt_pedido_aut_w	> 0) or (qt_pedido_compl_aut_w	> 0)	then
		select	count(1)
		into STRICT	qt_resp_pedido_aut_w
		from	ptu_resposta_autorizacao
		where	nr_seq_requisicao	= nr_seq_requisicao_p;

		if (qt_resp_pedido_aut_w	> 0) then
			-- Não é possível liberar os itens de uma requisição de intercâmbio que já possua resposta do pedido de autorização.
			CALL wheb_mensagem_pck.exibir_mensagem_abort(352291, null);
		end if;
	end if;
end if;

if (coalesce(nr_seq_req_proc_p,0) > 0) then

	select	cd_procedimento,
		substr(obter_descricao_procedimento(cd_procedimento,ie_origem_proced),1,255) ds_procedimento
	into STRICT	cd_procedimento_w,
		ds_procedimento_w
	from	pls_requisicao_proc
	where	nr_sequencia 	= nr_seq_req_proc_p;

	update	pls_requisicao_proc
	set	ie_status	= 'P',
		qt_procedimento	= qt_item_p,
		nm_usuario	= nm_usuario_p,
		dt_atualizacao	= clock_timestamp()
	where	nr_sequencia	= nr_seq_req_proc_p;

	CALL pls_gerar_hist_req_web(nr_seq_requisicao_p, 'L',
		wheb_mensagem_pck.get_texto(835904, 'DS_USUARIO=' || nm_usuario_p || ';CD_PROCEDIMENTO=' || cd_procedimento_w || ';DS_PROCEDIMENTO=' || ds_procedimento_w),
		nm_usuario_p);

elsif (coalesce(nr_seq_req_mat_p,0) > 0) then

	select	nr_seq_material,
		substr(pls_obter_desc_material(nr_seq_material),1,255) ds_material
	into STRICT	nr_seq_material_w,
		ds_material_w
	from	pls_requisicao_mat
	where	nr_sequencia 	= nr_seq_req_mat_p;

	update	pls_requisicao_mat
	set	ie_status	= 'P',
		qt_material	= qt_item_p,
		nm_usuario	= nm_usuario_p,
		dt_atualizacao	= clock_timestamp()
	where	nr_sequencia	= nr_seq_req_mat_p;

	CALL pls_gerar_hist_req_web(nr_seq_requisicao_p, 'L',
		wheb_mensagem_pck.get_texto(835908, 'DS_USUARIO=' || nm_usuario_p || ';NR_SEQ_MATERIAL=' || nr_seq_material_w || ';DS_MATERIAL=' || ds_material_w),
		nm_usuario_p);

end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_liberar_itens_requisicao ( nr_seq_requisicao_p bigint, nr_seq_req_proc_p bigint, nr_seq_req_mat_p bigint, qt_item_p bigint, nm_usuario_p text) FROM PUBLIC;

