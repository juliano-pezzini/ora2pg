-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_pad_paciente ( nr_seq_hc_pad_cad_p text, cd_pessoa_fisica_p text, nm_usuario_p text, nr_sequencia_p bigint) AS $body$
DECLARE


nr_seq_pac_equipamento_w				bigint;
nr_seq_pad_equipamento_w				bigint;
nr_seq_pac_servico_w					bigint;
nr_seq_pad_servico_w					bigint;
nr_seq_pac_material_w					bigint;
cd_material_w							bigint;
nr_seq_paciente_w						varchar(100);
qt_tempo_minuto_w						bigint;
nr_seq_frequencia_w						bigint;
ds_observacao_w							varchar(100);
dt_prev_finalizacao_w					timestamp;
dt_revisao_w							timestamp;
ie_via_aplicacao_w						varchar(100);
cd_intervalo_w							varchar(100);
cd_unidade_medida_w						varchar(100);
qt_material_w							varchar(100);

C01 CURSOR FOR
SELECT a.nr_seq_servico,
	   a.qt_tempo_minuto,
	   a.nr_seq_frequencia,
	   a.ds_observacao,
	   b.nr_seq_paciente,
	   a.dt_final,
	   b.dt_revisao
from hc_pad_servico a,
     hc_pad_controle b,
     paciente_home_care c
where a.nr_seq_controle = b.nr_sequencia
and b.nr_seq_paciente = c.nr_sequencia
and b.nr_sequencia = nr_seq_hc_pad_cad_p
and c.cd_pessoa_fisica = cd_pessoa_fisica_p;


C02 CURSOR FOR
SELECT a.nr_seq_equipamento,
	   b.nr_seq_paciente
from hc_pad_equipamento a,
     hc_pad_controle b,
     paciente_home_care c
where a.nr_seq_controle = b.nr_sequencia
and b.nr_seq_paciente = c.nr_sequencia
and b.nr_sequencia = nr_seq_hc_pad_cad_p
and c.cd_pessoa_fisica = cd_pessoa_fisica_p;

C03 CURSOR FOR
SELECT a.cd_material,
	   b.nr_seq_paciente,
	   a.ie_via_aplicacao,
	   a.cd_intervalo,
	   a.cd_unidade_medida,
	   a.qt_material
from hc_pad_material a,
     hc_pad_controle b,
     paciente_home_care c
where a.nr_seq_controle = b.nr_sequencia
and b.nr_seq_paciente = c.nr_sequencia
and b.nr_sequencia = nr_seq_hc_pad_cad_p
and c.cd_pessoa_fisica = cd_pessoa_fisica_p;



BEGIN

open C01;
		loop
		fetch C01 into
			nr_seq_pad_servico_w,
			qt_tempo_minuto_w,
			nr_seq_frequencia_w,
			ds_observacao_w,
			nr_seq_paciente_w,
			dt_prev_finalizacao_w,
			dt_revisao_w;
		EXIT WHEN NOT FOUND; /* apply on C01 */

			begin
				

			select nextval('hc_paciente_servico_seq')
			into STRICT  nr_seq_pac_servico_w
			;

			insert into hc_paciente_servico( nr_sequencia,
											 nm_usuario,
											 nm_usuario_nrec,
											 dt_atualizacao,
											 dt_atualizacao_nrec,
											 nr_seq_servico,
											 nr_seq_pac_home_care,
											 dt_prev_finalizacao,
											 dt_revisao,
											 NR_SEQ_FREQUENCIA,
											 QT_TEMPO_MINUTO,
											 ds_observacao) values (nr_seq_pac_servico_w,
																		 nm_usuario_p,
																		 nm_usuario_p,
																		 clock_timestamp(),
																		 clock_timestamp(),
																		 nr_seq_pad_servico_w,
																		 nr_seq_paciente_w,
																		 dt_prev_finalizacao_w,
																		 dt_revisao_w,
																		 nr_seq_frequencia_w,
																		 qt_tempo_minuto_w,
																		 ds_observacao_w);

			CALL hc_inserir_proc_servico(nr_seq_pad_servico_w, nr_seq_pac_servico_w, nm_usuario_p);

			commit;

			end;
		end loop;
close C01;

open C02;
		loop
		fetch C02 into
			nr_seq_pad_equipamento_w,
			nr_seq_paciente_w;
		EXIT WHEN NOT FOUND; /* apply on C02 */

			begin

			select nextval('hc_pac_equipamento_seq')
			into STRICT  nr_seq_pac_equipamento_w
			;

			
			insert into hc_pac_equipamento( nr_sequencia,
											 nr_seq_paciente,
											 nm_usuario,
											 nm_usuario_nrec,
											 dt_atualizacao,
											 dt_atualizacao_nrec,
											 nr_seq_equipamento) values (nr_seq_pac_equipamento_w,
																		 nr_seq_paciente_w,
																		 nm_usuario_p,
																		 nm_usuario_p,
																		 clock_timestamp(),
																		 clock_timestamp(),
																		 nr_seq_pad_equipamento_w);




			commit;

			end;
		end loop;
close C02;

open C03;
		loop
		fetch C03 into
			cd_material_w,
			nr_seq_paciente_w,
			ie_via_aplicacao_w,
			cd_intervalo_w,			
			cd_unidade_medida_w,		
			qt_material_w;			
		EXIT WHEN NOT FOUND; /* apply on C03 */

			begin

			select nextval('hc_paciente_material_seq')
			into STRICT  nr_seq_pac_material_w
			;
																					
				insert into hc_paciente_material(  nr_sequencia,
													nm_usuario,
													nm_usuario_nrec,
													dt_atualizacao,
													dt_atualizacao_nrec,
													cd_material,
													nr_seq_pac_home_care,
													ie_via_aplicacao,
													cd_intervalo,			
													cd_unidade_medida,		
													qt_material) values (      nr_seq_pac_material_w,
																						nm_usuario_p,
																						nm_usuario_p,
																						clock_timestamp(),
																						clock_timestamp(),
																						cd_material_w,
																						nr_seq_paciente_w,
																						ie_via_aplicacao_w,
																						cd_intervalo_w,			
																						cd_unidade_medida_w,		
																						qt_material_w);
	
	
	
	
				commit;
			end;
		end loop;
close C03;

	update paciente_home_care
	set nr_controle_pad = nr_seq_hc_pad_cad_p
	where nr_sequencia = nr_sequencia_p;
	
	commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_pad_paciente ( nr_seq_hc_pad_cad_p text, cd_pessoa_fisica_p text, nm_usuario_p text, nr_sequencia_p bigint) FROM PUBLIC;

