-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE san_conferir_entrada_hemo ( nr_lista_seq_producao_p text, nm_usuario_p text, ds_mensagem_p INOUT text) AS $body$
DECLARE


nr_seq_lista_w		varchar(4000);
nr_seq_envio_val_w	bigint;
nr_pos_virgula_w	bigint;
nr_sequencia_w		bigint;
ds_mensagem_w		varchar(4000);
ds_derivado_w		varchar(50);

BEGIN
IF (nr_lista_seq_producao_p IS NOT NULL AND nr_lista_seq_producao_p::text <> '') THEN
	BEGIN
	ds_mensagem_w := '';
	nr_seq_lista_w	:= nr_lista_seq_producao_p;
	WHILE(nr_seq_lista_w IS NOT NULL AND nr_seq_lista_w::text <> '') LOOP
		BEGIN
		nr_pos_virgula_w	:= position(',' in nr_seq_lista_w);
		IF (nr_pos_virgula_w > 0)	THEN
			BEGIN
			nr_sequencia_w	:= (SUBSTR(nr_seq_lista_w,1,nr_pos_virgula_w-1))::numeric;
			nr_seq_lista_w	:= SUBSTR(nr_seq_lista_w,nr_pos_virgula_w+1,LENGTH(nr_seq_lista_w));
			IF (nr_sequencia_w > 0) THEN
				BEGIN

				SELECT	MAX(nr_sequencia)
				INTO STRICT	nr_seq_envio_val_w
				FROM	san_envio_derivado_val
				WHERE 	nr_seq_producao	= nr_sequencia_w
				and	ie_status = 'E';

				IF (nr_seq_envio_val_w IS NOT NULL AND nr_seq_envio_val_w::text <> '') THEN
					CALL san_receber_derivado(nr_seq_envio_val_w, nm_usuario_p);
				ELSE
					SELECT	obter_desc_san_derivado(nr_seq_derivado)
					INTO STRICT	ds_derivado_w
					FROM	san_producao
					WHERE	nr_sequencia = nr_sequencia_w;

					ds_mensagem_w := ds_mensagem_w ||ds_derivado_w||'('||nr_sequencia_w||') '|| chr(13);
				END IF;

				END;
			END IF;
			END;
		ELSE
			nr_seq_lista_w := NULL;
		END IF;
		END;
	END LOOP;
	END;
END IF;

IF (ds_mensagem_w IS NOT NULL AND ds_mensagem_w::text <> '') THEN
	ds_mensagem_w := wheb_mensagem_pck.get_texto(309899, 'DS_MENSAGEM_W=' || ds_mensagem_w);
					/*
						Os seguintes hemocomponentes n√£o foram encontrados:
						#@DS_MENSAGEM_W#@
					*/
ELSE
	ds_mensagem_w := wheb_mensagem_pck.get_texto(309898); -- Todos os hemocoponentes foram recebidos com sucesso
END IF;



COMMIT;

ds_mensagem_p := ds_mensagem_w;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE san_conferir_entrada_hemo ( nr_lista_seq_producao_p text, nm_usuario_p text, ds_mensagem_p INOUT text) FROM PUBLIC;

