-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';



--
-- dblink wrapper to call function gerar_ganho_perda_medic_dilu as an autonomous transaction
--
CREATE EXTENSION IF NOT EXISTS dblink;

CREATE OR REPLACE PROCEDURE gerar_ganho_perda_medic_dilu ( nr_prescricao_p bigint, nr_sequencia_p bigint, nr_atendimento_p bigint, nm_usuario_p text, nr_seq_horario_p bigint default null) AS $body$
DECLARE
	-- Change this to reflect the dblink connection string
	v_conn_str  text := format('port=%s dbname=%s user=%s', current_setting('port'), current_database(), current_user);
	v_query     text;

BEGIN
	v_query := 'CALL gerar_ganho_perda_medic_dilu_atx ( ' || quote_nullable(nr_prescricao_p) || ',' || quote_nullable(nr_sequencia_p) || ',' || quote_nullable(nr_atendimento_p) || ',' || quote_nullable(nm_usuario_p) || ',' || quote_nullable(nr_seq_horario_p) || ' )';
	PERFORM * FROM dblink(v_conn_str, v_query) AS p (ret boolean);

END;
$body$ LANGUAGE plpgsql SECURITY DEFINER;




CREATE OR REPLACE PROCEDURE gerar_ganho_perda_medic_dilu_atx ( nr_prescricao_p bigint, nr_sequencia_p bigint, nr_atendimento_p bigint, nm_usuario_p text, nr_seq_horario_p bigint default null) AS $body$
DECLARE

cd_setor_atendimento_w	bigint;
qt_reg_w		bigint;

cd_grupo_material_w			bigint;
cd_classe_material_w		bigint;
cd_subgrupo_material_w		bigint;
cd_material_w				bigint;
qt_diluicao_w				double precision;
nr_seq_tipo_w				bigint;
nr_sequencia_w				bigint;
nr_atendimento_w			bigint;
ie_via_aplicacao_w			varchar(10);
ie_permite_w				varchar(10);
cd_estabelecimento_w		prescr_mat_perda_ganho_reg.cd_estabelecimento%type;
ie_disp_infusao_w			prescr_mat_perda_ganho_reg.ie_bomba_infusao%type;
nr_seq_ficha_tecnica_w		medic_ficha_tecnica.nr_sequencia%type;

C01 CURSOR FOR
	SELECT	nr_seq_tipo,
			coalesce(ie_permite,'S')
	from	prescr_mat_perda_ganho a,
			prescr_mat_perda_ganho_reg b
	where	a.nr_sequencia	= b.nr_seq_regra
	and	coalesce(cd_material,cd_material_w)			= cd_material_w
	and	coalesce(cd_grupo_material,cd_grupo_material_w)	= cd_grupo_material_w
	and	coalesce(cd_subgrupo_material,cd_subgrupo_material_w)= cd_subgrupo_material_w
	and	coalesce(cd_classe_material,cd_classe_material_w)	= cd_classe_material_w
	and	coalesce(b.nr_seq_ficha_tecnica,nr_seq_ficha_tecnica_w) = nr_seq_ficha_tecnica_w
	and	coalesce(cd_setor_atendimento,cd_setor_atendimento_w)	= cd_setor_atendimento_w
	and	coalesce(b.cd_estabelecimento,cd_estabelecimento_w)	= cd_estabelecimento_w
	and	coalesce(ie_via_aplicacao,ie_via_aplicacao_w)		= ie_via_aplicacao_w
	and (coalesce(ie_bomba_infusao,ie_disp_infusao_w) = ie_disp_infusao_w
		or (coalesce(ie_disp_infusao_w::text, '') = '' and coalesce(ie_bomba_infusao::text, '') = ''))
	order by coalesce(cd_material,0),
		coalesce(nr_seq_ficha_tecnica,0),
		coalesce(cd_classe_material,0),
		coalesce(cd_subgrupo_material,0),
		coalesce(cd_grupo_material,0),
		coalesce(cd_setor_atendimento,0),
		coalesce(ie_via_aplicacao,'AAA');
BEGIN

select	count(1)
into STRICT	qt_reg_w
from	prescr_mat_perda_ganho;

select	max(cd_estabelecimento)
into STRICT	cd_estabelecimento_w
from	prescr_medica
where	nr_prescricao = nr_prescricao_p;

if (qt_reg_w	> 0) then
	qt_diluicao_w	:= obter_total_diluicao_medic(nr_prescricao_p,nr_sequencia_p);
	
	if (qt_diluicao_w	> 0) then
		nr_atendimento_w	:= nr_atendimento_p;
		if ( coalesce(nr_atendimento_p::text, '') = '') then
			select	max(nr_atendimento)
			into STRICT	nr_atendimento_w
			from	prescr_medica
			where	nr_prescricao	= nr_prescricao_p;
		end if;
		cd_setor_atendimento_w	:= obter_setor_atendimento( nr_atendimento_w );
		
		select	cd_material,
				coalesce(ie_via_aplicacao,'AAA'),
				ie_bomba_infusao
		into STRICT	cd_material_w,
				ie_via_aplicacao_w,
				ie_disp_infusao_w
		from	prescr_material
		where	nr_prescricao	= nr_prescricao_p
		and		nr_sequencia	= nr_sequencia_p;
		
		select	max(cd_grupo_material),
				max(cd_classe_material),
				max(cd_subgrupo_material),
				coalesce(max(nr_seq_ficha_tecnica),0)
		into STRICT	cd_grupo_material_w,
			cd_classe_material_w,
			cd_subgrupo_material_w,
			nr_seq_ficha_tecnica_w
		from	estrutura_material_v
		where	cd_material	= cd_material_w;

		nr_seq_tipo_w	:= null;

		open C01;
		loop
		fetch C01 into	
			nr_seq_tipo_w,
			ie_permite_w;
		EXIT WHEN NOT FOUND; /* apply on C01 */
			ie_permite_w	:= ie_permite_w;
		end loop;
		close C01;
		
		if (nr_seq_tipo_w IS NOT NULL AND nr_seq_tipo_w::text <> '') and (ie_permite_w = 'S') then

			nr_sequencia_w := Inserir_ganho_perda(	nr_atendimento_w, null, nr_seq_tipo_w, cd_setor_atendimento_w, clock_timestamp(), qt_diluicao_w, 'S', null, null, nm_usuario_p, null, 1, null, nr_sequencia_w, null, null, null, null, nr_seq_horario_p);
		end if;
	end if;
end if;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_ganho_perda_medic_dilu ( nr_prescricao_p bigint, nr_sequencia_p bigint, nr_atendimento_p bigint, nm_usuario_p text, nr_seq_horario_p bigint default null) FROM PUBLIC; -- REVOKE ALL ON PROCEDURE gerar_ganho_perda_medic_dilu_atx ( nr_prescricao_p bigint, nr_sequencia_p bigint, nr_atendimento_p bigint, nm_usuario_p text, nr_seq_horario_p bigint default null) FROM PUBLIC;

