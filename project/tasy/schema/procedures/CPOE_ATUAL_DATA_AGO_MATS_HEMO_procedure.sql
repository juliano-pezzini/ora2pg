-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE cpoe_atual_data_ago_mats_hemo ( nr_atendimento_p atendimento_paciente.nr_atendimento%type, nr_seq_cpoe_p cpoe_hemoterapia.nr_sequencia%type, dt_referencia_p timestamp, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, cd_perfil_p perfil.cd_perfil%type, nm_usuario_p usuario.nm_usuario%type) AS $body$
DECLARE


ds_horarios_w			cpoe_hemoterapia.ds_horarios%type;
ds_horarios_ww			cpoe_hemoterapia.ds_horarios%type;
cd_mat_hem1_w			cpoe_hemoterapia.cd_mat_hem1%type;
cd_mat_hem2_w			cpoe_hemoterapia.cd_mat_hem2%type;
cd_mat_hem3_w			cpoe_hemoterapia.cd_mat_hem3%type;
cd_mat_hem4_w			cpoe_hemoterapia.cd_mat_hem4%type;
cd_mat_hem5_w			cpoe_hemoterapia.cd_mat_hem5%type;
cd_interv_hem1_w		cpoe_hemoterapia.cd_interv_hem1%type;
cd_interv_hem2_w		cpoe_hemoterapia.cd_interv_hem2%type;
cd_interv_hem3_w		cpoe_hemoterapia.cd_interv_hem3%type;
cd_interv_hem4_w		cpoe_hemoterapia.cd_interv_hem4%type;
cd_interv_hem5_w		cpoe_hemoterapia.cd_interv_hem5%type;
hr_prim_hor_hem1_w		cpoe_hemoterapia.hr_prim_hor_hem1%type;
hr_prim_hor_hem2_w		cpoe_hemoterapia.hr_prim_hor_hem2%type;
hr_prim_hor_hem3_w		cpoe_hemoterapia.hr_prim_hor_hem3%type;
hr_prim_hor_hem4_w		cpoe_hemoterapia.hr_prim_hor_hem4%type;
hr_prim_hor_hem5_w		cpoe_hemoterapia.hr_prim_hor_hem5%type;
dt_inicio_hem1_w		cpoe_hemoterapia.dt_inicio_hem1%type;
dt_inicio_hem2_w		cpoe_hemoterapia.dt_inicio_hem2%type;
dt_inicio_hem3_w		cpoe_hemoterapia.dt_inicio_hem3%type;
dt_inicio_hem4_w		cpoe_hemoterapia.dt_inicio_hem4%type;
dt_inicio_hem5_w		cpoe_hemoterapia.dt_inicio_hem5%type;
ie_urgencia_mat_hem1_w	cpoe_hemoterapia.ie_urgencia_mat_hem1%type;
ie_urgencia_mat_hem2_w	cpoe_hemoterapia.ie_urgencia_mat_hem2%type;
ie_urgencia_mat_hem3_w	cpoe_hemoterapia.ie_urgencia_mat_hem3%type;
ie_urgencia_mat_hem4_w	cpoe_hemoterapia.ie_urgencia_mat_hem4%type;
ie_urgencia_mat_hem5_w	cpoe_hemoterapia.ie_urgencia_mat_hem5%type;
dt_fim_w				cpoe_hemoterapia.ds_horarios%type;
dt_prim_horario_w		cpoe_hemoterapia.dt_inicio%type;
qt_min_intervalo_w		intervalo_prescricao.qt_min_intervalo%type;
nr_ocorrencia_w			prescr_material.nr_ocorrencia%type;
dt_referencia_w			timestamp;

	procedure preencher_ds_horarios(cd_interv_mat_p		cpoe_hemoterapia.cd_interv_hem1%type,
									cd_mat_hemo_p		cpoe_hemoterapia.cd_mat_hem1%type,
									dt_fim_hemo_p		cpoe_hemoterapia.dt_fim%type,
									ie_urgencia_mat_p	cpoe_hemoterapia.ie_adm_mat_hem1%type) is
	;
BEGIN

		if (ie_urgencia_mat_p IS NOT NULL AND ie_urgencia_mat_p::text <> '') then
			dt_referencia_w := trunc(dt_referencia_p,'mi') + (ie_urgencia_mat_p)::numeric /1440;
		else
			dt_referencia_w :=  to_date(to_char(dt_referencia_p,'dd/mm/yyyy') || ' ' || to_char(to_date(Obter_prox_hora_cheia(dt_referencia_p),'hh24:mi:ss'),'hh24:mi:ss'),'dd/mm/yyyy hh24:mi:ss');
		end if;

		select	max(qt_min_intervalo)
		into STRICT	qt_min_intervalo_w
		from	intervalo_prescricao
		where	cd_intervalo = cd_interv_mat_p;

		cpoe_calcular_horario_prescr( nr_atendimento_p,cd_interv_mat_p,cd_mat_hemo_p,dt_referencia_w,
								  0,qt_min_intervalo_w,nr_ocorrencia_w,ds_horarios_w,
								  ds_horarios_ww,nm_usuario_p,cd_estabelecimento_p,cd_perfil_p,
								  null,null, null, null,
								  null, ceil((coalesce(dt_fim_hemo_p, dt_referencia_w + 1) - dt_referencia_w)*24) );

		ds_horarios_w := ds_horarios_w||ds_horarios_ww;

	end;

	function obter_se_pro_atrasado( dt_inicio_mat_p		cpoe_hemoterapia.dt_inicio_hem1%type,
									hr_prim_hor_mat_p	cpoe_hemoterapia.hr_prim_hor_hem1%type)
									return;

		if (dt_prim_horario_w < dt_referencia_p) then
			return;
		else
			return;
		end if;
	end;

begin

select	max(cd_mat_hem1),
		max(cd_mat_hem2),
		max(cd_mat_hem3),
		max(cd_mat_hem4),
		max(cd_mat_hem5),
		max(cd_interv_hem1),
		max(cd_interv_hem2),
		max(cd_interv_hem3),
		max(cd_interv_hem4),
		max(cd_interv_hem5),
		max(hr_prim_hor_hem1),
		max(hr_prim_hor_hem2),
		max(hr_prim_hor_hem3),
		max(hr_prim_hor_hem4),
		max(hr_prim_hor_hem5),
		max(dt_inicio_hem1),
		max(dt_inicio_hem2),
		max(dt_inicio_hem3),
		max(dt_inicio_hem4),
		max(dt_inicio_hem5),
		max(ie_urgencia_mat_hem1),
		max(ie_urgencia_mat_hem2),
		max(ie_urgencia_mat_hem3),
		max(ie_urgencia_mat_hem4),
		max(ie_urgencia_mat_hem5),
		max(dt_fim)
into STRICT	cd_mat_hem1_w,
        cd_mat_hem2_w,
        cd_mat_hem3_w,
        cd_mat_hem4_w,
        cd_mat_hem5_w,
        cd_interv_hem1_w,
        cd_interv_hem2_w,
        cd_interv_hem3_w,
        cd_interv_hem4_w,
        cd_interv_hem5_w,
        hr_prim_hor_hem1_w,
        hr_prim_hor_hem2_w,
        hr_prim_hor_hem3_w,
        hr_prim_hor_hem4_w,
        hr_prim_hor_hem5_w,
        dt_inicio_hem1_w,
        dt_inicio_hem2_w,
        dt_inicio_hem3_w,
        dt_inicio_hem4_w,
        dt_inicio_hem5_w,
		ie_urgencia_mat_hem1_w,
		ie_urgencia_mat_hem2_w,
		ie_urgencia_mat_hem3_w,
		ie_urgencia_mat_hem4_w,
		ie_urgencia_mat_hem5_w,
		dt_fim_w
from	cpoe_hemoterapia
where	nr_sequencia = nr_seq_cpoe_p;



if (cd_mat_hem1_w IS NOT NULL AND cd_mat_hem1_w::text <> '') then

	if (obter_se_pro_atrasado(dt_inicio_hem1_w, hr_prim_hor_hem1_w) = 'S') then

		preencher_ds_horarios(cd_interv_hem1_w, cd_mat_hem1_w, dt_fim_w, ie_urgencia_mat_hem1_w);

		update	cpoe_hemoterapia
		set		dt_inicio_hem1 = trunc(dt_referencia_w),
				hr_prim_hor_hem1 = to_char(dt_referencia_w,'hh24:mi'),
				ds_hor_hem1 = ds_horarios_w
		where	nr_sequencia = nr_seq_cpoe_p;
	end if;
end if;

if (cd_mat_hem2_w IS NOT NULL AND cd_mat_hem2_w::text <> '') then

	if (obter_se_pro_atrasado(dt_inicio_hem2_w, hr_prim_hor_hem2_w) = 'S') then

		preencher_ds_horarios(cd_interv_hem2_w, cd_mat_hem2_w, dt_fim_w, ie_urgencia_mat_hem2_w);

		update	cpoe_hemoterapia
		set		dt_inicio_hem2 = trunc(dt_referencia_w),
				hr_prim_hor_hem2 = to_char(dt_referencia_w,'hh24:mi'),
				ds_hor_hem2 = ds_horarios_w
		where	nr_sequencia = nr_seq_cpoe_p;
	end if;
end if;


if (cd_mat_hem3_w IS NOT NULL AND cd_mat_hem3_w::text <> '') then

	if (obter_se_pro_atrasado(dt_inicio_hem3_w, hr_prim_hor_hem3_w) = 'S') then

		preencher_ds_horarios(cd_interv_hem3_w, cd_mat_hem3_w, dt_fim_w, ie_urgencia_mat_hem3_w);

		update	cpoe_hemoterapia
		set		dt_inicio_hem3 = trunc(dt_referencia_w),
				hr_prim_hor_hem3 = to_char(dt_referencia_w,'hh24:mi'),
				ds_hor_hem3 = ds_horarios_w
		where	nr_sequencia = nr_seq_cpoe_p;
	end if;
end if;

if (cd_mat_hem4_w IS NOT NULL AND cd_mat_hem4_w::text <> '') then

	if (obter_se_pro_atrasado(dt_inicio_hem4_w, hr_prim_hor_hem4_w) = 'S') then

		preencher_ds_horarios(cd_interv_hem4_w, cd_mat_hem4_w, dt_fim_w, ie_urgencia_mat_hem4_w);

		update	cpoe_hemoterapia
		set		dt_inicio_hem4 = trunc(dt_referencia_w),
				hr_prim_hor_hem4 = to_char(dt_referencia_w,'hh24:mi'),
				ds_hor_hem4 = ds_horarios_w
		where	nr_sequencia = nr_seq_cpoe_p;
	end if;
end if;

if (cd_mat_hem5_w IS NOT NULL AND cd_mat_hem5_w::text <> '') then

	if (obter_se_pro_atrasado(dt_inicio_hem5_w, hr_prim_hor_hem5_w) = 'S') then

		preencher_ds_horarios(cd_interv_hem5_w, cd_mat_hem5_w, dt_fim_w, ie_urgencia_mat_hem5_w);

		update	cpoe_hemoterapia
		set		dt_inicio_hem5 = trunc(dt_referencia_w),
				hr_prim_hor_hem5 = to_char(dt_referencia_w,'hh24:mi'),
				ds_hor_hem5 = ds_horarios_w
		where	nr_sequencia = nr_seq_cpoe_p;
	end if;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cpoe_atual_data_ago_mats_hemo ( nr_atendimento_p atendimento_paciente.nr_atendimento%type, nr_seq_cpoe_p cpoe_hemoterapia.nr_sequencia%type, dt_referencia_p timestamp, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, cd_perfil_p perfil.cd_perfil%type, nm_usuario_p usuario.nm_usuario%type) FROM PUBLIC;

