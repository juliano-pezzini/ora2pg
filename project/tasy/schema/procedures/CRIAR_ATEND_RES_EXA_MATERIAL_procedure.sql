-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';



CREATE TYPE colunas AS (nm_coluna_w varchar(255));


CREATE OR REPLACE PROCEDURE criar_atend_res_exa_material (nr_atendimento_p bigint, cd_pessoa_fisica_p text, dt_inicial_p timestamp, dt_final_p timestamp, nr_seq_exame_p text, ie_atendimento_p text, ie_sem_aprovacao_p text, ie_ordem_p bigint, nr_seq_protocolo_pep_p bigint, ie_data_p text, nm_usuario_p text, cd_setor_atendimento_p bigint, ie_modo_agrup_p text, cd_material_p bigint) AS $body$
DECLARE



/* vetor */

type vetor is table of colunas index by integer;

/* globais */

vetor_w			vetor;
ivet			integer;
ind			integer;


ds_grupo_exame_lab_w	varchar(50);
nr_seq_grupo_w		bigint;
nr_seq_apresent_w	integer;
nr_seq_apresent_exame_w	bigint;
nr_sequencia_w		bigint;
nr_seq_exame_w		bigint;
nm_exame_w		varchar(100);
nr_seq_material_w	bigint;
ds_unidade_medida_w	varchar(15);
ie_ordem_w		bigint;
ie_ordem_seg_w		bigint;
nr_seq_exames_w		varchar(4000);
dt_inicial_w		varchar(20);
dt_final_w		varchar(20);
dt_resultado_w		varchar(30);
dt_resultado_ww		timestamp;
ds_comando_w		varchar(3000);
ds_parametro_w		varchar(3000);
qt_resultado_w		double precision;
nr_prescricao_w		bigint;
dt_hora_w		varchar(15);
dt_result_w		varchar(20);
ds_referencia_w		varchar(255);
ds_referencia_porc_w	varchar(255);
ds_resultado_w		varchar(2000);
ds_observacao_w		varchar(4000);
pr_resultado_w		double precision;
nm_atributo_w		varchar(20);
qt_decimais_w		integer;
ds_result_w		varchar(20);
nr_seq_w		bigint;
ie_status_atend_ww	bigint	:= 35;
dt_aprovacao_w		timestamp;
ds_cor_w		varchar(20);
ie_formato_resultado_w	varchar(3);
ie_normalidade_w	bigint;
ds_metodo_w		varchar(255);

ie_ordem_ww		bigint;
dt_final_ww		timestamp;
cd_perfil_w		integer;

ie_formato_result_exame_w	varchar(3);
qt_resultado_exame_w		double precision;
pr_resultado_exame_w		double precision;
ds_resultado_exame_w		varchar(4000);

C10 CURSOR FOR /* Grupos dos Exames de Laboratorio */
	SELECT	/* +index(a EXALARE_I1) */
		distinct upper(c.ds_grupo_exame_lab),
		e.nr_seq_grupo,
		coalesce(obter_seq_apresentacao_exame(nr_seq_protocolo_pep_p,null,e.nr_seq_grupo),coalesce(c.nr_seq_apresent,0))
	from	grupo_exame_lab c,
		exame_laboratorio e,
		exame_lab_result_item b,
		prescr_procedimento k,
		prescr_medica x,
		exame_lab_resultado a
	where	a.nr_seq_resultado	= b.nr_seq_resultado
	and	coalesce(ie_grid_pep,'S') = 'S'
	and	b.nr_seq_exame		= e.nr_seq_exame
	and	a.dt_resultado between dt_inicial_p and dt_final_ww
	and	e.nr_seq_grupo		= c.nr_sequencia
	and	((b.qt_resultado IS NOT NULL AND b.qt_resultado::text <> '') or (b.ds_resultado IS NOT NULL AND b.ds_resultado::text <> '') or (b.pr_resultado IS NOT NULL AND b.pr_resultado::text <> ''))
	and	x.nr_prescricao		= a.nr_prescricao
	and	k.nr_sequencia		= b.nr_seq_prescr
	and	x.nr_prescricao		= k.nr_prescricao
	and  	'S' = obter_se_permite_ver_result(k.nr_seq_exame,cd_perfil_w,nm_usuario_p)
	and	((coalesce(nr_seq_protocolo_pep_p::text, '') = '') or (obter_se_exame_protocolo_pep(nr_seq_protocolo_pep_p,b.nr_seq_exame,Obter_Mat_Exame_Lab_prescr(a.nr_prescricao,k.nr_sequencia,1)) = 'S'))
	and	((coalesce(nr_seq_exame_p::text, '') = '') or (obter_se_contido(b.nr_seq_exame,nr_seq_exames_w) = 'S'))
	and	k.ie_status_atend	>= ie_status_atend_ww
	and	((ie_atendimento_p = 'S' AND x.nr_atendimento = nr_atendimento_p) or (ie_atendimento_p <> 'S') and (x.cd_pessoa_fisica = cd_pessoa_fisica_p))
	and	((coalesce(cd_setor_atendimento_p::text, '') = '') or (x.cd_setor_atendimento = cd_setor_atendimento_p))
	and	ie_modo_agrup_p = 'G'
	and	obter_se_exibe_exame(b.nr_seq_exame,cd_material_p) = 'S'
	
union
	/* Ivan em 07/02/2008 - Inclusao dos Resultados de Exames Externos */
	SELECT	/* +index(a EXALARE_I1) */
		distinct upper(c.ds_grupo_exame_lab),
		e.nr_seq_grupo,
		coalesce(obter_seq_apresentacao_exame(nr_seq_protocolo_pep_p,null,e.nr_seq_grupo),coalesce(c.nr_seq_apresent,0))
	from	grupo_exame_lab c,
		exame_laboratorio e,
		exame_lab_result_item b,
		exame_lab_resultado a
	where	a.nr_seq_resultado	= b.nr_seq_resultado
	and	coalesce(ie_grid_pep,'S') = 'S'
	and	b.nr_seq_exame		= e.nr_seq_exame
	and	a.dt_resultado between dt_inicial_p and dt_final_ww
	and	e.nr_seq_grupo		= c.nr_sequencia
	and  	'S' = obter_se_permite_ver_result(e.nr_seq_exame,cd_perfil_w,nm_usuario_p)
	and	((b.qt_resultado IS NOT NULL AND b.qt_resultado::text <> '') or (b.ds_resultado IS NOT NULL AND b.ds_resultado::text <> '') or (b.pr_resultado IS NOT NULL AND b.pr_resultado::text <> ''))
	and	coalesce(a.nr_prescricao::text, '') = ''
	and	(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
	and	((coalesce(cd_setor_atendimento_p::text, '') = '') or (obter_setor_prescricao(a.nr_prescricao,'C') = cd_setor_atendimento_p))
	and	((coalesce(nr_seq_protocolo_pep_p::text, '') = '') or (obter_se_exame_protocolo_pep(nr_seq_protocolo_pep_p,b.nr_seq_exame,Obter_Mat_Exame_Lab_prescr(a.nr_prescricao,b.nr_seq_prescr,1)) = 'S'))
	and	((coalesce(nr_seq_exame_p::text, '') = '') or (obter_se_contido(b.nr_seq_exame,nr_seq_exames_w) = 'S'))
	and	((ie_atendimento_p = 'S' AND a.nr_atendimento = nr_atendimento_p) or
		 ((ie_atendimento_p = 'N') and (a.nr_atendimento in (
							select	nr_atendimento
							from	atendimento_paciente
							where	cd_pessoa_fisica	= cd_pessoa_fisica_p))))
	and	ie_modo_agrup_p = 'G'
	and	obter_se_exibe_exame(b.nr_seq_exame,cd_material_p) = 'S';



c11 CURSOR FOR
	SELECT	/* +index(a EXALARE_I1) */
		distinct
		upper(c.ds_material_exame),
		c.nr_sequencia,
		coalesce(obter_seq_apresentacao_exame(nr_seq_protocolo_pep_p,null,null),coalesce(c.nr_seq_apresent,0))
	from	material_exame_lab c,
		exame_laboratorio e,
		exame_lab_result_item b,
		prescr_procedimento k,
		prescr_medica x,
		exame_lab_resultado a
	where	a.nr_seq_resultado	= b.nr_seq_resultado
	and	coalesce(ie_grid_pep,'S') = 'S'
	and	b.nr_seq_exame		= e.nr_seq_exame
	and  	'S' = obter_se_permite_ver_result(k.nr_seq_exame,cd_perfil_w,nm_usuario_p)
	and	a.dt_resultado between dt_inicial_p and dt_final_ww
	and	c.nr_sequencia		= Obter_Mat_Exame_Lab_prescr(a.nr_prescricao,k.nr_sequencia,1)
	and	((b.qt_resultado IS NOT NULL AND b.qt_resultado::text <> '') or (b.ds_resultado IS NOT NULL AND b.ds_resultado::text <> '') or (b.pr_resultado IS NOT NULL AND b.pr_resultado::text <> ''))
	and	x.nr_prescricao		= a.nr_prescricao
	and	k.nr_sequencia		= b.nr_seq_prescr
	and	x.nr_prescricao		= k.nr_prescricao
	and	((coalesce(nr_seq_protocolo_pep_p::text, '') = '') or (obter_se_exame_protocolo_pep(nr_seq_protocolo_pep_p,b.nr_seq_exame,Obter_Mat_Exame_Lab_prescr(a.nr_prescricao,k.nr_sequencia,1)) = 'S'))
	and	((coalesce(nr_seq_exame_p::text, '') = '') or (obter_se_contido(b.nr_seq_exame,nr_seq_exames_w) = 'S'))
	and	k.ie_status_atend	>= ie_status_atend_ww
	and	((ie_atendimento_p = 'S' AND x.nr_atendimento = nr_atendimento_p) or (ie_atendimento_p <> 'S') and (x.cd_pessoa_fisica = cd_pessoa_fisica_p))
	and	((coalesce(cd_setor_atendimento_p::text, '') = '') or (x.cd_setor_atendimento = cd_setor_atendimento_p))
	and	ie_modo_agrup_p = 'M'
	and	obter_se_exibe_exame(b.nr_seq_exame,cd_material_p) = 'S'
	
union
	/* Ivan em 07/02/2008 - Inclusao dos Resultados de Exames Externos */
	SELECT	/* +index(a EXALARE_I1) */
		DISTINCT
		UPPER(coalesce(c.ds_material_exame,obter_desc_expressao(327119))),
		coalesce(c.nr_sequencia,999999),
		coalesce(obter_seq_apresentacao_exame(nr_seq_protocolo_pep_p,null,null),coalesce(c.nr_seq_apresent,0))
	FROM exame_laboratorio e, exame_lab_resultado a, exame_lab_result_item b
LEFT OUTER JOIN material_exame_lab c ON (b.nr_seq_material = c.nr_sequencia)
WHERE a.nr_seq_resultado	= b.nr_seq_resultado and coalesce(ie_grid_pep,'S') = 'S' and b.nr_seq_exame		= e.nr_seq_exame and 'S' = obter_se_permite_ver_result(e.nr_seq_exame,cd_perfil_w,nm_usuario_p) and a.dt_resultado between dt_inicial_p and dt_final_ww --	and	c.nr_sequencia		= Obter_Mat_Exame_Lab_prescr(a.nr_prescricao,b.nr_seq_prescr,1)
  and ((b.qt_resultado IS NOT NULL AND b.qt_resultado::text <> '') or (b.ds_resultado IS NOT NULL AND b.ds_resultado::text <> '') or (b.pr_resultado IS NOT NULL AND b.pr_resultado::text <> '')) and coalesce(a.nr_prescricao::text, '') = '' and (a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '') and ((coalesce(cd_setor_atendimento_p::text, '') = '') or (obter_setor_prescricao(a.nr_prescricao,'C') = cd_setor_atendimento_p)) and ((coalesce(nr_seq_protocolo_pep_p::text, '') = '') or (obter_se_exame_protocolo_pep(nr_seq_protocolo_pep_p,b.nr_seq_exame,Obter_Mat_Exame_Lab_prescr(a.nr_prescricao,b.nr_seq_prescr,1)) = 'S')) and ((coalesce(nr_seq_exame_p::text, '') = '') or (obter_se_contido(b.nr_seq_exame,nr_seq_exames_w) = 'S')) and ((ie_atendimento_p = 'S' AND a.nr_atendimento = nr_atendimento_p) or
		 ((ie_atendimento_p = 'N') and (a.nr_atendimento in (
							select	nr_atendimento
							from	atendimento_paciente
							where	cd_pessoa_fisica	= cd_pessoa_fisica_p)))) and ie_modo_agrup_p = 'M' and obter_se_exibe_exame(b.nr_seq_exame,cd_material_p) = 'S';


C15 CURSOR FOR
	SELECT	/* +index(a EXALARE_I1) */
		distinct b.nr_seq_exame,
		'    '|| e.nm_exame,
		Obter_Mat_Exame_Lab_prescr(a.nr_prescricao,k.nr_sequencia,1),
		substr(b.ds_unidade_medida,1,15),
		e.nr_seq_grupo,


coalesce(obter_seq_apresentacao_exame(nr_seq_protocolo_pep_p,null,e.nr_seq_grupo),CASE WHEN ie_modo_agrup_p='M' THEN coalesce(d.nr_seq_apresent,0)  ELSE coalesce(c.nr_seq_apresent,0) END ),
		coalesce(obter_seq_apresentacao_exame(nr_seq_protocolo_pep_p,b.nr_seq_exame,null),coalesce(e.nr_seq_apresent,0)),
		substr(Obter_Metodo_Exame_Lab(b.nr_seq_metodo,2),1,80),
		CASE WHEN ie_modo_agrup_p='M' THEN Obter_Mat_Exame_Lab_prescr(a.nr_prescricao,k.nr_sequencia,1)  ELSE e.nr_seq_grupo END ,
		--e.ie_formato_resultado,
		substr(Obter_Formato_Result_Exame(e.nr_seq_exame,d.nr_sequencia),1,3) ie_formato_resultado,
		b.qt_resultado,
		b.ds_resultado,
		b.pr_resultado
	from	material_exame_lab d,
		grupo_exame_lab c,
		exame_laboratorio e,
		exame_lab_result_item b,
		prescr_procedimento k,
		prescr_medica x,
		exame_lab_resultado a
	where	a.nr_seq_resultado	= b.nr_seq_resultado
	and	coalesce(ie_grid_pep,'S') 	= 'S'
	and	a.dt_resultado between dt_inicial_p and dt_final_ww
	and	b.nr_seq_exame		= e.nr_seq_exame
	and	e.nr_seq_grupo		= c.nr_sequencia
	and	x.nr_prescricao		= k.nr_prescricao
	and  	'S' = obter_se_permite_ver_result(k.nr_seq_exame,cd_perfil_w,nm_usuario_p)
	and	((coalesce(cd_setor_atendimento_p::text, '') = '') or (x.cd_setor_atendimento = cd_setor_atendimento_p))
	and	((coalesce(nr_seq_protocolo_pep_p::text, '') = '') or (obter_se_exame_protocolo_pep(nr_seq_protocolo_pep_p,b.nr_seq_exame,Obter_Mat_Exame_Lab_prescr(a.nr_prescricao,k.nr_sequencia,1)) = 'S'))
	and	((coalesce(nr_seq_exame_p::text, '') = '') or (obter_se_contido(b.nr_seq_exame,nr_seq_exames_w) = 'S'))
	and	((ie_atendimento_p = 'S' AND x.nr_atendimento = nr_atendimento_p) or (ie_atendimento_p <> 'S') and (x.cd_pessoa_fisica = cd_pessoa_fisica_p))
	and	x.nr_prescricao		= a.nr_prescricao
	and	k.nr_prescricao		= a.nr_prescricao
	and	k.nr_sequencia		= b.nr_seq_prescr
	and	k.ie_status_atend	>= ie_status_atend_ww
	--and	b.ds_resultado is not null
	--and	b.ds_resultado		<> '0'
	--and	e.ie_formato_resultado in	('D','DL','DV','MS','MSL','S','SDM','SM')
	and	d.nr_sequencia		= Obter_Mat_Exame_Lab_prescr(a.nr_prescricao,k.nr_sequencia,1)
	and	obter_se_exibe_exame(b.nr_seq_exame,cd_material_p) = 'S'
	
union
	/* Ivan em 07/02/2008 - Inclusao dos Resultados de Exames Externos */
	SELECT	/* +index(a EXALARE_I1) */
		distinct b.nr_seq_exame,
		'    '|| e.nm_exame,
		coalesce(b.nr_seq_material,999999),
		substr(b.ds_unidade_medida,1,15),
		e.nr_seq_grupo,


coalesce(obter_seq_apresentacao_exame(nr_seq_protocolo_pep_p,null,e.nr_seq_grupo),CASE WHEN ie_modo_agrup_p='M' THEN coalesce(d.nr_seq_apresent,0)  ELSE coalesce(c.nr_seq_apresent,0) END ),
		coalesce(obter_seq_apresentacao_exame(nr_seq_protocolo_pep_p,b.nr_seq_exame,null),coalesce(e.nr_seq_apresent,0)),
		substr(Obter_Metodo_Exame_Lab(b.nr_seq_metodo,2),1,80),
		CASE WHEN ie_modo_agrup_p='M' THEN coalesce(b.nr_seq_material,999999)  ELSE e.nr_seq_grupo END ,
		--e.ie_formato_resultado,
		substr(Obter_Formato_Result_Exame(e.nr_seq_exame,d.nr_sequencia),1,3) ie_formato_resultado,
		b.qt_resultado,
		b.ds_resultado,
		b.pr_resultado
	FROM exame_laboratorio e, grupo_exame_lab c, exame_lab_resultado a, exame_lab_result_item b
LEFT OUTER JOIN material_exame_lab d ON (b.nr_seq_material = d.nr_sequencia)
WHERE a.nr_seq_resultado	= b.nr_seq_resultado and coalesce(ie_grid_pep,'S') 	= 'S' and a.dt_resultado between dt_inicial_p and dt_final_ww and b.nr_seq_exame		= e.nr_seq_exame and e.nr_seq_grupo		= c.nr_sequencia and coalesce(a.nr_prescricao::text, '') = '' and (a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '') and 'S' = obter_se_permite_ver_result(e.nr_seq_exame,cd_perfil_w,nm_usuario_p) and ((coalesce(nr_seq_protocolo_pep_p::text, '') = '') or (obter_se_exame_protocolo_pep(nr_seq_protocolo_pep_p,b.nr_seq_exame,Obter_Mat_Exame_Lab_prescr(a.nr_prescricao,b.nr_seq_prescr,1)) = 'S')) and ((coalesce(nr_seq_exame_p::text, '') = '') or (obter_se_contido(b.nr_seq_exame,nr_seq_exames_w) = 'S')) and ((ie_atendimento_p = 'S' AND a.nr_atendimento = nr_atendimento_p) or
		 ((ie_atendimento_p = 'N') and (a.nr_atendimento in (
							select	nr_atendimento
							from	atendimento_paciente
							where	cd_pessoa_fisica	= cd_pessoa_fisica_p)))) and ((coalesce(cd_setor_atendimento_p::text, '') = '') or (obter_setor_prescricao(a.nr_prescricao,'C') = cd_setor_atendimento_p))  and obter_se_exibe_exame(b.nr_seq_exame,cd_material_p) = 'S';


/* Resultado em valor */

C20 CURSOR FOR
	SELECT	/* +index(a EXALARE_I1) */
		distinct b.nr_seq_exame,
		'    '|| e.nm_exame,
		Obter_Mat_Exame_Lab_prescr(a.nr_prescricao,k.nr_sequencia,1),
		substr(b.ds_unidade_medida,1,15),
		e.nr_seq_grupo,


coalesce(obter_seq_apresentacao_exame(nr_seq_protocolo_pep_p,null,e.nr_seq_grupo),CASE WHEN ie_modo_agrup_p='M' THEN coalesce(d.nr_seq_apresent,0)  ELSE coalesce(c.nr_seq_apresent,0) END ),
		coalesce(obter_seq_apresentacao_exame(nr_seq_protocolo_pep_p,b.nr_seq_exame,null),coalesce(e.nr_seq_apresent,0)),
		substr(Obter_Metodo_Exame_Lab(b.nr_seq_metodo,2),1,80),
		CASE WHEN ie_modo_agrup_p='M' THEN Obter_Mat_Exame_Lab_prescr(a.nr_prescricao,k.nr_sequencia,1)  ELSE e.nr_seq_grupo END
	from	material_exame_lab d,
		grupo_exame_lab c,
		exame_laboratorio e,
		exame_lab_result_item b,
		prescr_procedimento k,
		prescr_medica x,
		exame_lab_resultado a
	where	a.nr_seq_resultado	= b.nr_seq_resultado
	and	coalesce(ie_grid_pep,'S') = 'S'
	and  	'S' = obter_se_permite_ver_result(k.nr_seq_exame,cd_perfil_w,nm_usuario_p)
	and	a.dt_resultado between dt_inicial_p and dt_final_ww
	and	b.nr_seq_exame		= e.nr_seq_exame
	and	e.nr_seq_grupo		= c.nr_sequencia
	and	x.nr_prescricao		= k.nr_prescricao
	and	((coalesce(nr_seq_protocolo_pep_p::text, '') = '') or (obter_se_exame_protocolo_pep(nr_seq_protocolo_pep_p,b.nr_seq_exame,Obter_Mat_Exame_Lab_prescr(a.nr_prescricao,k.nr_sequencia,1)) = 'S'))
	and	((coalesce(nr_seq_exame_p::text, '') = '') or (obter_se_contido(b.nr_seq_exame,nr_seq_exames_w) = 'S'))
	and	((ie_atendimento_p = 'S' AND x.nr_atendimento = nr_atendimento_p) or (ie_atendimento_p <> 'S') and (x.cd_pessoa_fisica = cd_pessoa_fisica_p))
	and	x.nr_prescricao		= a.nr_prescricao
	and	k.nr_prescricao		= a.nr_prescricao
	and	k.nr_sequencia		= b.nr_seq_prescr
	and	k.ie_status_atend	>= ie_status_atend_ww
	and (coalesce(b.qt_resultado,0) <> 0)
	and (substr(Obter_Formato_Result_Exame(e.nr_seq_exame,d.nr_sequencia),1,3) in ('CA','CV','DV','VP','V'))
	and	((coalesce(cd_setor_atendimento_p::text, '') = '') or (x.cd_setor_atendimento = cd_setor_atendimento_p))
	and	d.nr_sequencia = Obter_Mat_Exame_Lab_prescr(a.nr_prescricao,k.nr_sequencia,1)
	and	obter_se_exibe_exame(b.nr_seq_exame,cd_material_p) = 'S'
	
union
	/* Ivan em 07/02/2008 - Inclusao dos Resultados de Exames Externos */
	SELECT	/* +index(a EXALARE_I1) */
		distinct b.nr_seq_exame,
		'    '|| e.nm_exame,
		coalesce(b.nr_seq_material,999999),
		substr(b.ds_unidade_medida,1,15),
		e.nr_seq_grupo,


coalesce(obter_seq_apresentacao_exame(nr_seq_protocolo_pep_p,null,e.nr_seq_grupo),CASE WHEN ie_modo_agrup_p='M' THEN coalesce(d.nr_seq_apresent,0)  ELSE coalesce(c.nr_seq_apresent,0) END ),
		coalesce(obter_seq_apresentacao_exame(nr_seq_protocolo_pep_p,b.nr_seq_exame,null),coalesce(e.nr_seq_apresent,0)),
		substr(Obter_Metodo_Exame_Lab(b.nr_seq_metodo,2),1,80),
		CASE WHEN ie_modo_agrup_p='M' THEN coalesce(b.nr_seq_material,999999)  ELSE e.nr_seq_grupo END 
	FROM exame_laboratorio e, grupo_exame_lab c, exame_lab_resultado a, exame_lab_result_item b
LEFT OUTER JOIN material_exame_lab d ON (b.nr_seq_material = d.nr_sequencia)
WHERE a.nr_seq_resultado	= b.nr_seq_resultado and coalesce(ie_grid_pep,'S') 	= 'S' and a.dt_resultado between dt_inicial_p and dt_final_ww and b.nr_seq_exame		= e.nr_seq_exame and e.nr_seq_grupo		= c.nr_sequencia and coalesce(a.nr_prescricao::text, '') = '' and (a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '') and 'S' = obter_se_permite_ver_result(e.nr_seq_exame,cd_perfil_w,nm_usuario_p) and ((coalesce(nr_seq_protocolo_pep_p::text, '') = '') or (obter_se_exame_protocolo_pep(nr_seq_protocolo_pep_p,b.nr_seq_exame,Obter_Mat_Exame_Lab_prescr(a.nr_prescricao,b.nr_seq_prescr,1)) = 'S')) and ((coalesce(nr_seq_exame_p::text, '') = '') or (obter_se_contido(b.nr_seq_exame,nr_seq_exames_w) = 'S')) and ((ie_atendimento_p = 'S' AND a.nr_atendimento = nr_atendimento_p) or
		 ((ie_atendimento_p = 'N') and (a.nr_atendimento in (
							select	nr_atendimento
							from	atendimento_paciente
							where	cd_pessoa_fisica	= cd_pessoa_fisica_p)))) and (coalesce(b.qt_resultado,0) <> 0) and (substr(Obter_Formato_Result_Exame(e.nr_seq_exame,d.nr_sequencia),1,3) in ('CA','CV','DV','VP','V')) and ((coalesce(cd_setor_atendimento_p::text, '') = '') or (obter_setor_prescricao(a.nr_prescricao,'C') = cd_setor_atendimento_p))  and obter_se_exibe_exame(b.nr_seq_exame,cd_material_p) = 'S';
	--and	d.nr_sequencia = Obter_Mat_Exame_Lab_prescr(a.nr_prescricao,b.nr_seq_prescr,1);
/* Resultado em procentagem */

C21 CURSOR FOR
	SELECT	/* +index(a EXALARE_I1) */
		distinct b.nr_seq_exame,
		'    '|| e.nm_exame,
		Obter_Mat_Exame_Lab_prescr(a.nr_prescricao,k.nr_sequencia,1),
		substr(b.ds_unidade_medida,1,15),
		e.nr_seq_grupo,


coalesce(obter_seq_apresentacao_exame(nr_seq_protocolo_pep_p,null,e.nr_seq_grupo),CASE WHEN ie_modo_agrup_p='M' THEN coalesce(d.nr_seq_apresent,0)  ELSE coalesce(c.nr_seq_apresent,0) END ),
		coalesce(obter_seq_apresentacao_exame(nr_seq_protocolo_pep_p,b.nr_seq_exame,null),coalesce(e.nr_seq_apresent,0)),
		substr(Obter_Metodo_Exame_Lab(b.nr_seq_metodo,2),1,80),
		CASE WHEN ie_modo_agrup_p='M' THEN Obter_Mat_Exame_Lab_prescr(a.nr_prescricao,k.nr_sequencia,1)  ELSE e.nr_seq_grupo END
	from	material_exame_lab d,
		grupo_exame_lab c,
		exame_laboratorio e,
		exame_lab_result_item b,
		prescr_procedimento k,
		prescr_medica x,
		exame_lab_resultado a
	where	a.nr_seq_resultado	= b.nr_seq_resultado
	and	coalesce(ie_grid_pep,'S') 	= 'S'
	and	a.dt_resultado between dt_inicial_p and dt_final_ww
	and	b.nr_seq_exame		= e.nr_seq_exame
	and	e.nr_seq_grupo		= c.nr_sequencia
	and	x.nr_prescricao		= k.nr_prescricao
	and  	'S' = obter_se_permite_ver_result(k.nr_seq_exame,cd_perfil_w,nm_usuario_p)
	and	((coalesce(cd_setor_atendimento_p::text, '') = '') or (x.cd_setor_atendimento = cd_setor_atendimento_p))
	and	((coalesce(nr_seq_protocolo_pep_p::text, '') = '') or (obter_se_exame_protocolo_pep(nr_seq_protocolo_pep_p,b.nr_seq_exame,Obter_Mat_Exame_Lab_prescr(a.nr_prescricao,k.nr_sequencia,1)) = 'S'))
	and	((coalesce(nr_seq_exame_p::text, '') = '') or (obter_se_contido(b.nr_seq_exame,nr_seq_exames_w) = 'S'))
	and	((ie_atendimento_p = 'S' AND x.nr_atendimento = nr_atendimento_p) or (ie_atendimento_p <> 'S') and (x.cd_pessoa_fisica = cd_pessoa_fisica_p))
	and	x.nr_prescricao		= a.nr_prescricao
	and	k.nr_prescricao		= a.nr_prescricao
	and	k.nr_sequencia		= b.nr_seq_prescr
	and	k.ie_status_atend	>= ie_status_atend_ww
	and	(b.pr_resultado IS NOT NULL AND b.pr_resultado::text <> '')
	and (substr(Obter_Formato_Result_Exame(e.nr_seq_exame,d.nr_sequencia),1,3) in ('CA','P','VP'))
	and	d.nr_sequencia		= Obter_Mat_Exame_Lab_prescr(a.nr_prescricao,k.nr_sequencia,1)
	and	obter_se_exibe_exame(b.nr_seq_exame,cd_material_p) = 'S'
	
union
	/* Ivan em 07/02/2008 - Inclusao dos Resultados de Exames Externos */
	SELECT	/* +index(a EXALARE_I1) */
		distinct b.nr_seq_exame,
		'    '|| e.nm_exame,
		coalesce(b.nr_seq_material,999999),
		substr(b.ds_unidade_medida,1,15),
		e.nr_seq_grupo,


coalesce(obter_seq_apresentacao_exame(nr_seq_protocolo_pep_p,null,e.nr_seq_grupo),CASE WHEN ie_modo_agrup_p='M' THEN coalesce(d.nr_seq_apresent,0)  ELSE coalesce(c.nr_seq_apresent,0) END ),
		coalesce(obter_seq_apresentacao_exame(nr_seq_protocolo_pep_p,b.nr_seq_exame,null),coalesce(e.nr_seq_apresent,0)),
		substr(Obter_Metodo_Exame_Lab(b.nr_seq_metodo,2),1,80),
		CASE WHEN ie_modo_agrup_p='M' THEN coalesce(b.nr_seq_material,999999)  ELSE e.nr_seq_grupo END 
	FROM exame_laboratorio e, grupo_exame_lab c, exame_lab_resultado a, exame_lab_result_item b
LEFT OUTER JOIN material_exame_lab d ON (b.nr_seq_material = d.nr_sequencia)
WHERE a.nr_seq_resultado	= b.nr_seq_resultado and coalesce(ie_grid_pep,'S') 	= 'S' and a.dt_resultado between dt_inicial_p and dt_final_ww and b.nr_seq_exame		= e.nr_seq_exame and e.nr_seq_grupo		= c.nr_sequencia and 'S' = obter_se_permite_ver_result(e.nr_seq_exame,cd_perfil_w,nm_usuario_p) and coalesce(a.nr_prescricao::text, '') = '' and (a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '') and ((coalesce(cd_setor_atendimento_p::text, '') = '') or (obter_setor_prescricao(a.nr_prescricao,'C') = cd_setor_atendimento_p)) and (substr(Obter_Formato_Result_Exame(e.nr_seq_exame,d.nr_sequencia),1,3) in ('CA','P','VP')) and ((coalesce(nr_seq_protocolo_pep_p::text, '') = '') or (obter_se_exame_protocolo_pep(nr_seq_protocolo_pep_p,b.nr_seq_exame,Obter_Mat_Exame_Lab_prescr(a.nr_prescricao,b.nr_seq_prescr,1)) = 'S')) and ((coalesce(nr_seq_exame_p::text, '') = '') or (obter_se_contido(b.nr_seq_exame,nr_seq_exames_w) = 'S')) and ((ie_atendimento_p = 'S' AND a.nr_atendimento = nr_atendimento_p) or
		 ((ie_atendimento_p = 'N') and (a.nr_atendimento in (
							select	nr_atendimento
							from	atendimento_paciente
							where	cd_pessoa_fisica	= cd_pessoa_fisica_p)))) and (b.pr_resultado IS NOT NULL AND b.pr_resultado::text <> '')  and obter_se_exibe_exame(b.nr_seq_exame,cd_material_p) = 'S';
	--and	d.nr_sequencia = Obter_Mat_Exame_Lab_prescr(a.nr_prescricao,b.nr_seq_prescr,1);
/* Resultado descritivo */

C22 CURSOR FOR
	SELECT	/* +index(a EXALARE_I1) */
		distinct b.nr_seq_exame,
		'    '|| e.nm_exame,
		Obter_Mat_Exame_Lab_prescr(a.nr_prescricao,k.nr_sequencia,1),
		substr(b.ds_unidade_medida,1,15),
		e.nr_seq_grupo,


coalesce(obter_seq_apresentacao_exame(nr_seq_protocolo_pep_p,null,e.nr_seq_grupo),CASE WHEN ie_modo_agrup_p='M' THEN coalesce(d.nr_seq_apresent,0)  ELSE coalesce(c.nr_seq_apresent,0) END ),
		coalesce(obter_seq_apresentacao_exame(nr_seq_protocolo_pep_p,b.nr_seq_exame,null),coalesce(e.nr_seq_apresent,0)),
		CASE WHEN ie_modo_agrup_p='M' THEN Obter_Mat_Exame_Lab_prescr(a.nr_prescricao,k.nr_sequencia,1)  ELSE e.nr_seq_grupo END
	from	material_exame_lab d,
		grupo_exame_lab c,
		exame_laboratorio e,
		exame_lab_result_item b,
		prescr_procedimento k,
		prescr_medica x,
		exame_lab_resultado a
	where	a.nr_seq_resultado	= b.nr_seq_resultado
	and	coalesce(ie_grid_pep,'S') 	= 'S'
	and	a.dt_resultado between dt_inicial_p and dt_final_ww
	and	b.nr_seq_exame		= e.nr_seq_exame
	and	e.nr_seq_grupo		= c.nr_sequencia
	and	x.nr_prescricao		= k.nr_prescricao
	and  	'S' = obter_se_permite_ver_result(k.nr_seq_exame,cd_perfil_w,nm_usuario_p)
	and	((coalesce(cd_setor_atendimento_p::text, '') = '') or (x.cd_setor_atendimento = cd_setor_atendimento_p))
	and	((coalesce(nr_seq_protocolo_pep_p::text, '') = '') or (obter_se_exame_protocolo_pep(nr_seq_protocolo_pep_p,b.nr_seq_exame,Obter_Mat_Exame_Lab_prescr(a.nr_prescricao,k.nr_sequencia,1)) = 'S'))
	and	((coalesce(nr_seq_exame_p::text, '') = '') or (obter_se_contido(b.nr_seq_exame,nr_seq_exames_w) = 'S'))
	and	((ie_atendimento_p = 'S' AND x.nr_atendimento = nr_atendimento_p) or (ie_atendimento_p <> 'S') and (x.cd_pessoa_fisica = cd_pessoa_fisica_p))
	and	x.nr_prescricao		= a.nr_prescricao
	and	k.nr_prescricao		= a.nr_prescricao
	and	k.nr_sequencia		= b.nr_seq_prescr
	and	k.ie_status_atend	>= ie_status_atend_ww
	and	(b.ds_resultado IS NOT NULL AND b.ds_resultado::text <> '')
	and	b.ds_resultado		<> '0'
	and (substr(Obter_Formato_Result_Exame(e.nr_seq_exame,d.nr_sequencia),1,3) in ('D','DL','DV','MS','MSL','S','SDM','SM'))
	and	d.nr_sequencia		= Obter_Mat_Exame_Lab_prescr(a.nr_prescricao,k.nr_sequencia,1)
	and	obter_se_exibe_exame(b.nr_seq_exame,cd_material_p) = 'S'
	
union
	/* Ivan em 07/02/2008 - Inclusao dos Resultados de Exames Externos */
	SELECT	/* +index(a EXALARE_I1) */
		distinct b.nr_seq_exame,
		'    '|| e.nm_exame,
		coalesce(b.nr_seq_material,999999),
		substr(b.ds_unidade_medida,1,15),
		e.nr_seq_grupo,


coalesce(obter_seq_apresentacao_exame(nr_seq_protocolo_pep_p,null,e.nr_seq_grupo),CASE WHEN ie_modo_agrup_p='M' THEN coalesce(d.nr_seq_apresent,0)  ELSE coalesce(c.nr_seq_apresent,0) END ),
		coalesce(obter_seq_apresentacao_exame(nr_seq_protocolo_pep_p,b.nr_seq_exame,null),coalesce(e.nr_seq_apresent,0)),
		CASE WHEN ie_modo_agrup_p='M' THEN coalesce(b.nr_seq_material,999999)  ELSE e.nr_seq_grupo END 
	FROM exame_laboratorio e, grupo_exame_lab c, exame_lab_resultado a, exame_lab_result_item b
LEFT OUTER JOIN material_exame_lab d ON (b.nr_seq_material = d.nr_sequencia)
WHERE a.nr_seq_resultado	= b.nr_seq_resultado and coalesce(ie_grid_pep,'S') 	= 'S' and a.dt_resultado between dt_inicial_p and dt_final_ww and b.nr_seq_exame		= e.nr_seq_exame and e.nr_seq_grupo		= c.nr_sequencia and 'S' = obter_se_permite_ver_result(e.nr_seq_exame,cd_perfil_w,nm_usuario_p) and coalesce(a.nr_prescricao::text, '') = '' and (a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '') and (substr(Obter_Formato_Result_Exame(e.nr_seq_exame,d.nr_sequencia),1,3) in ('D','DL','DV','MS','MSL','S','SDM','SM')) and ((coalesce(cd_setor_atendimento_p::text, '') = '') or (obter_setor_prescricao(a.nr_prescricao,'C') = cd_setor_atendimento_p)) and ((coalesce(nr_seq_protocolo_pep_p::text, '') = '') or (obter_se_exame_protocolo_pep(nr_seq_protocolo_pep_p,b.nr_seq_exame,Obter_Mat_Exame_Lab_prescr(a.nr_prescricao,b.nr_seq_prescr,1)) = 'S')) and ((coalesce(nr_seq_exame_p::text, '') = '') or (obter_se_contido(b.nr_seq_exame,nr_seq_exames_w) = 'S')) and ((ie_atendimento_p = 'S' AND a.nr_atendimento = nr_atendimento_p) or
		 ((ie_atendimento_p = 'N') and (a.nr_atendimento in (
							select	nr_atendimento
							from	atendimento_paciente
							where	cd_pessoa_fisica	= cd_pessoa_fisica_p)))) and (b.ds_resultado IS NOT NULL AND b.ds_resultado::text <> '') and b.ds_resultado		<> '0'  and obter_se_exibe_exame(b.nr_seq_exame,cd_material_p) = 'S';
	--and	d.nr_sequencia = Obter_Mat_Exame_Lab_prescr(a.nr_prescricao,b.nr_seq_prescr,1);
C30 CURSOR FOR
	SELECT	nr_seq_exame,
		nm_exame,
		nr_seq_material,
		ds_unidade_medida,
		ie_ordem,
		ie_ordem_seg,
		nr_apres_grupo,
		nr_apres_exame,
		ie_formato_resultado,
		ds_metodo
	from	w_result_exame_temp
	where	nm_usuario	= nm_usuario_p
	group by
		nr_seq_exame,
		nm_exame,
		nr_seq_material,
		ds_unidade_medida,
		ie_ordem,
		ie_ordem_seg,
		nr_apres_grupo,
		nr_apres_exame,
		ie_formato_resultado,
		ds_metodo;

/* Datas em ordem decrescente */

c02 CURSOR FOR
	SELECT	/* +index(a EXALARE_I1) */
		to_char(CASE WHEN coalesce(x.nr_seq_origem::text, '') = '' THEN  obter_data_result_exame_pep(a.dt_resultado, b.dt_result_item, b.dt_digitacao, x.dt_coleta, dt_prev_execucao,ie_data_p, b.dt_aprovacao)  ELSE x.dt_prev_execucao END , 'dd/mm/yyyy hh24:mi:ss'),
		CASE WHEN coalesce(x.nr_seq_origem::text, '') = '' THEN obter_data_result_exame_pep(a.dt_resultado, b.dt_result_item, b.dt_digitacao, x.dt_coleta, dt_prev_execucao, ie_data_p, b.dt_aprovacao)  ELSE x.dt_prev_execucao END
	from	exame_laboratorio e,
		exame_lab_result_item b,
		prescr_procedimento x,
		prescr_medica d,
		exame_lab_resultado a
	where	a.nr_seq_resultado	= b.nr_seq_resultado
	and	coalesce(ie_grid_pep,'S') 	= 'S'
	and	b.nr_seq_exame		= e.nr_seq_exame
	and	d.nr_prescricao 	= a.nr_prescricao
	and	d.nr_prescricao		= x.nr_prescricao
	and	x.nr_sequencia		= b.nr_seq_prescr
	and  	'S' = obter_se_permite_ver_result(x.nr_seq_exame,cd_perfil_w,nm_usuario_p)
	and	x.ie_status_atend	>= ie_status_atend_ww
	and	((coalesce(cd_setor_atendimento_p::text, '') = '') or (d.cd_setor_atendimento = cd_setor_atendimento_p))
	and	a.dt_resultado between dt_inicial_p and dt_final_ww
	and	ie_atendimento_p	= 'S'
	and	((coalesce(nr_seq_protocolo_pep_p::text, '') = '') or (obter_se_exame_protocolo_pep(nr_seq_protocolo_pep_p,b.nr_seq_exame,Obter_Mat_Exame_Lab_prescr(a.nr_prescricao,x.nr_sequencia,1)) = 'S'))
	and	((coalesce(nr_seq_exame_p::text, '') = '') or (obter_se_contido(b.nr_seq_exame,nr_seq_exames_w) = 'S'))  /* Marcus 17/06/2006 */
	and	((b.qt_resultado IS NOT NULL AND b.qt_resultado::text <> '') or (b.ds_resultado IS NOT NULL AND b.ds_resultado::text <> '') or (b.pr_resultado IS NOT NULL AND b.pr_resultado::text <> ''))
	and	d.nr_atendimento = nr_atendimento_p
	and	obter_se_exibe_exame(b.nr_seq_exame,cd_material_p) = 'S'
	
union

	SELECT	/* +index(a EXALARE_I1) */
		to_char(CASE WHEN coalesce(x.nr_seq_origem::text, '') = '' THEN  obter_data_result_exame_pep(a.dt_resultado, b.dt_result_item, b.dt_digitacao, x.dt_coleta, dt_prev_execucao,ie_data_p, b.dt_aprovacao)  ELSE x.dt_prev_execucao END ,'dd/mm/yyyy hh24:mi:ss'),
		CASE WHEN coalesce(x.nr_seq_origem::text, '') = '' THEN  obter_data_result_exame_pep(a.dt_resultado, b.dt_result_item, b.dt_digitacao, x.dt_coleta, dt_prev_execucao, ie_data_p, b.dt_aprovacao)  ELSE x.dt_prev_execucao END 
	from	exame_laboratorio e,
		exame_lab_result_item b,
		prescr_procedimento x,
		prescr_medica d,
		exame_lab_resultado a
	where	a.nr_seq_resultado	= b.nr_seq_resultado
	and	coalesce(ie_grid_pep,'S') 	= 'S'
	and	b.nr_seq_exame		= e.nr_seq_exame
	and	d.nr_prescricao 	= a.nr_prescricao
	and	d.nr_prescricao		= x.nr_prescricao
	and	x.nr_sequencia		= b.nr_seq_prescr
	and  	'S' = obter_se_permite_ver_result(x.nr_seq_exame,cd_perfil_w,nm_usuario_p)
	and	x.ie_status_atend	>= ie_status_atend_ww
	and	((coalesce(cd_setor_atendimento_p::text, '') = '') or (d.cd_setor_atendimento = cd_setor_atendimento_p))
	and	a.dt_resultado between dt_inicial_p and dt_final_ww
	and	ie_atendimento_p	= 'N'
	and	((coalesce(nr_seq_protocolo_pep_p::text, '') = '') or (obter_se_exame_protocolo_pep(nr_seq_protocolo_pep_p,b.nr_seq_exame,Obter_Mat_Exame_Lab_prescr(a.nr_prescricao,x.nr_sequencia,1)) = 'S'))
	and	((coalesce(nr_seq_exame_p::text, '') = '') or (obter_se_contido(b.nr_seq_exame,nr_seq_exames_w) = 'S'))  /* Marcus 17/06/2006 */
	and	((b.qt_resultado IS NOT NULL AND b.qt_resultado::text <> '') or (b.ds_resultado IS NOT NULL AND b.ds_resultado::text <> '') or (b.pr_resultado IS NOT NULL AND b.pr_resultado::text <> ''))
	and	d.cd_pessoa_fisica = cd_pessoa_fisica_p
	and	obter_se_exibe_exame(b.nr_seq_exame,cd_material_p) = 'S'
	
union
	/* Ivan em 07/02/2008 - Inclusao dos Resultados de Exames Externos */
	select	/* +index(a EXALARE_I1) */
		to_char(obter_data_result_exame_pep(a.dt_resultado, b.dt_result_item, b.dt_digitacao, null, null, ie_data_p, b.dt_aprovacao),'dd/mm/yyyy hh24:mi:ss'),
		obter_data_result_exame_pep(a.dt_resultado, b.dt_result_item, b.dt_digitacao, null, null, ie_data_p, b.dt_aprovacao)
	from	exame_laboratorio e,
		exame_lab_result_item b,
		exame_lab_resultado a
	where	a.nr_seq_resultado	= b.nr_seq_resultado
	and	coalesce(ie_grid_pep,'S') 	= 'S'
	and	b.nr_seq_exame		= e.nr_seq_exame
	and	coalesce(a.nr_prescricao::text, '') = ''
	and	(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
	and  	'S' = obter_se_permite_ver_result(e.nr_seq_exame,cd_perfil_w,nm_usuario_p)
	and	a.dt_resultado between dt_inicial_p and dt_final_ww
	and	ie_atendimento_p	= 'S'
	and	((coalesce(cd_setor_atendimento_p::text, '') = '') or (obter_setor_prescricao(a.nr_prescricao,'C') = cd_setor_atendimento_p))
	and	((coalesce(nr_seq_protocolo_pep_p::text, '') = '') or (obter_se_exame_protocolo_pep(nr_seq_protocolo_pep_p,b.nr_seq_exame,Obter_Mat_Exame_Lab_prescr(a.nr_prescricao,b.nr_seq_prescr,1)) = 'S'))
	and	((coalesce(nr_seq_exame_p::text, '') = '') or (obter_se_contido(b.nr_seq_exame,nr_seq_exames_w) = 'S'))  /* Marcus 17/06/2006 */
	and	((b.qt_resultado IS NOT NULL AND b.qt_resultado::text <> '') or (b.ds_resultado IS NOT NULL AND b.ds_resultado::text <> '') or (b.pr_resultado IS NOT NULL AND b.pr_resultado::text <> ''))
	and	a.nr_atendimento = nr_atendimento_p
	and	obter_se_exibe_exame(b.nr_seq_exame,cd_material_p) = 'S'
	
union

	select	/* +index(a EXALARE_I1) */
		to_char(obter_data_result_exame_pep(a.dt_resultado, b.dt_result_item, b.dt_digitacao, null, null, ie_data_p, b.dt_aprovacao), 'dd/mm/yyyy hh24:mi:ss'),
		obter_data_result_exame_pep(a.dt_resultado, b.dt_result_item, b.dt_digitacao, null, null, ie_data_p, b.dt_aprovacao)
	from	exame_laboratorio e,
		exame_lab_result_item b,
		exame_lab_resultado a
	where	a.nr_seq_resultado	= b.nr_seq_resultado
	and	coalesce(ie_grid_pep,'S') 	= 'S'
	and	b.nr_seq_exame		= e.nr_seq_exame
	and  	'S' = obter_se_permite_ver_result(e.nr_seq_exame,cd_perfil_w,nm_usuario_p)
	and	coalesce(a.nr_prescricao::text, '') = ''
	and	(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
	and	obter_se_exibe_exame(b.nr_seq_exame,cd_material_p) = 'S'
	and	a.dt_resultado between dt_inicial_p and dt_final_ww
	and	ie_atendimento_p	= 'N'
	and	((coalesce(cd_setor_atendimento_p::text, '') = '') or (obter_setor_prescricao(a.nr_prescricao,'C') = cd_setor_atendimento_p))
	and	((coalesce(nr_seq_protocolo_pep_p::text, '') = '') or (obter_se_exame_protocolo_pep(nr_seq_protocolo_pep_p,b.nr_seq_exame,Obter_Mat_Exame_Lab_prescr(a.nr_prescricao,b.nr_seq_prescr,1)) = 'S'))
	and	((coalesce(nr_seq_exame_p::text, '') = '') or (obter_se_contido(b.nr_seq_exame,nr_seq_exames_w) = 'S'))  /* Marcus 17/06/2006 */
	and	((b.qt_resultado IS NOT NULL AND b.qt_resultado::text <> '') or (b.ds_resultado IS NOT NULL AND b.ds_resultado::text <> '') or (b.pr_resultado IS NOT NULL AND b.pr_resultado::text <> ''))
	and	a.nr_atendimento in (	select	nr_atendimento
					from	atendimento_paciente
					where	cd_pessoa_fisica	= cd_pessoa_fisica_p)
	order by 2 desc;

/* Datas em ordem crescente */

c002 CURSOR FOR
	--select	to_char(a.dt_resultado,'dd/mm/yyyy hh24:mi:ss'),
	--		a.dt_resultado
	SELECT	/* +index(a EXALARE_I1) */
		to_char(CASE WHEN coalesce(x.nr_seq_origem::text, '') = '' THEN  obter_data_result_exame_pep(a.dt_resultado, b.dt_result_item, b.dt_digitacao, x.dt_coleta, dt_prev_execucao,ie_data_p,b.dt_aprovacao)  ELSE x.dt_prev_execucao END ,'dd/mm/yyyy hh24:mi:ss'),
		CASE WHEN coalesce(x.nr_seq_origem::text, '') = '' THEN  obter_data_result_exame_pep(a.dt_resultado, b.dt_result_item, b.dt_digitacao, x.dt_coleta, dt_prev_execucao, ie_data_p, b.dt_aprovacao)  ELSE x.dt_prev_execucao END
	from	exame_laboratorio e,
		exame_lab_result_item b,
		prescr_procedimento x,
		prescr_medica d,
		exame_lab_resultado a
	where	a.nr_seq_resultado	= b.nr_seq_resultado
	and	coalesce(ie_grid_pep,'S') 	= 'S'
	and	b.nr_seq_exame		= e.nr_seq_exame
	and	d.nr_prescricao 	= a.nr_prescricao
	and	d.nr_prescricao		= x.nr_prescricao
	and	x.nr_sequencia		= b.nr_seq_prescr
	and  	'S' = obter_se_permite_ver_result(x.nr_seq_exame,cd_perfil_w,nm_usuario_p)
	and	x.ie_status_atend	>= ie_status_atend_ww
	and	((coalesce(cd_setor_atendimento_p::text, '') = '') or (d.cd_setor_atendimento = cd_setor_atendimento_p))
	and	a.dt_resultado between dt_inicial_p and dt_final_ww
	and	ie_atendimento_p	= 'S'
	and	((coalesce(nr_seq_protocolo_pep_p::text, '') = '') or (obter_se_exame_protocolo_pep(nr_seq_protocolo_pep_p,b.nr_seq_exame,Obter_Mat_Exame_Lab_prescr(a.nr_prescricao,x.nr_sequencia,1)) = 'S'))
	and	((coalesce(nr_seq_exame_p::text, '') = '') or (obter_se_contido(b.nr_seq_exame,nr_seq_exames_w) = 'S'))  /* Marcus 17/06/2006 */
	and	((b.qt_resultado IS NOT NULL AND b.qt_resultado::text <> '') or (b.ds_resultado IS NOT NULL AND b.ds_resultado::text <> '') or (b.pr_resultado IS NOT NULL AND b.pr_resultado::text <> ''))
	and	d.nr_atendimento = nr_atendimento_p
	and	obter_se_exibe_exame(b.nr_seq_exame,cd_material_p) = 'S'
	
union

	--select	to_char(a.dt_resultado,'dd/mm/yyyy hh24:mi:ss'),
	--		a.dt_resultado
	SELECT	/* +index(a EXALARE_I1) */
		to_char(CASE WHEN coalesce(x.nr_seq_origem::text, '') = '' THEN obter_data_result_exame_pep(a.dt_resultado, b.dt_result_item, b.dt_digitacao, x.dt_coleta, dt_prev_execucao,ie_data_p, b.dt_aprovacao)  ELSE x.dt_prev_execucao END , 'dd/mm/yyyy hh24:mi:ss'),
		CASE WHEN coalesce(x.nr_seq_origem::text, '') = '' THEN  obter_data_result_exame_pep(a.dt_resultado, b.dt_result_item, b.dt_digitacao, x.dt_coleta, dt_prev_execucao, ie_data_p, b.dt_aprovacao)  ELSE x.dt_prev_execucao END 
	from	exame_laboratorio e,
		exame_lab_result_item b,
		prescr_procedimento x,
		prescr_medica d,
		exame_lab_resultado a
	where	a.nr_seq_resultado	= b.nr_seq_resultado
	and	coalesce(ie_grid_pep,'S') 	= 'S'
	and	b.nr_seq_exame		= e.nr_seq_exame
	and	d.nr_prescricao 	= a.nr_prescricao
	and	d.nr_prescricao		= x.nr_prescricao
	and	x.nr_sequencia		= b.nr_seq_prescr
	and	x.ie_status_atend	>= ie_status_atend_ww
	and  	'S' = obter_se_permite_ver_result(x.nr_seq_exame,cd_perfil_w,nm_usuario_p)
	and	((coalesce(cd_setor_atendimento_p::text, '') = '') or (d.cd_setor_atendimento = cd_setor_atendimento_p))
	and	a.dt_resultado between dt_inicial_p and dt_final_ww
	and	ie_atendimento_p	= 'N'
	and	((coalesce(nr_seq_protocolo_pep_p::text, '') = '') or (obter_se_exame_protocolo_pep(nr_seq_protocolo_pep_p,b.nr_seq_exame,Obter_Mat_Exame_Lab_prescr(a.nr_prescricao,x.nr_sequencia,1)) = 'S'))
	and	((coalesce(nr_seq_exame_p::text, '') = '') or (obter_se_contido(b.nr_seq_exame,nr_seq_exames_w) = 'S'))  /* Marcus 17/06/2006 */
	and	((b.qt_resultado IS NOT NULL AND b.qt_resultado::text <> '') or (b.ds_resultado IS NOT NULL AND b.ds_resultado::text <> '') or (b.pr_resultado IS NOT NULL AND b.pr_resultado::text <> ''))
	and	d.cd_pessoa_fisica = cd_pessoa_fisica_p
	and	obter_se_exibe_exame(b.nr_seq_exame,cd_material_p) = 'S'
	
union
	/* Ivan em 07/02/2008 - Inclusao dos Resultados de Exames Externos */
	--select	to_char(a.dt_resultado,'dd/mm/yyyy hh24:mi:ss'),
	--		a.dt_resultado
	select	/* +index(a EXALARE_I1) */
		to_char(obter_data_result_exame_pep(a.dt_resultado, b.dt_result_item, b.dt_digitacao, null, null, ie_data_p, b.dt_aprovacao), 'dd/mm/yyyy hh24:mi:ss'),
		obter_data_result_exame_pep(a.dt_resultado, b.dt_result_item, b.dt_digitacao, null, null, ie_data_p, b.dt_aprovacao)
	from	exame_laboratorio e,
		exame_lab_result_item b,
		exame_lab_resultado a
	where	a.nr_seq_resultado	= b.nr_seq_resultado
	and	coalesce(ie_grid_pep,'S') 	= 'S'
	and	b.nr_seq_exame		= e.nr_seq_exame
	and	coalesce(a.nr_prescricao::text, '') = ''
	and	(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
	and  	'S' = obter_se_permite_ver_result(e.nr_seq_exame,cd_perfil_w,nm_usuario_p)
	and	a.dt_resultado between dt_inicial_p and dt_final_ww
	and	ie_atendimento_p	= 'S'
	and	((coalesce(cd_setor_atendimento_p::text, '') = '') or (obter_setor_prescricao(a.nr_prescricao,'C') = cd_setor_atendimento_p))
	and	((coalesce(nr_seq_protocolo_pep_p::text, '') = '') or (obter_se_exame_protocolo_pep(nr_seq_protocolo_pep_p,b.nr_seq_exame,Obter_Mat_Exame_Lab_prescr(a.nr_prescricao,b.nr_seq_prescr,1)) = 'S'))
	and	((coalesce(nr_seq_exame_p::text, '') = '') or (obter_se_contido(b.nr_seq_exame,nr_seq_exames_w) = 'S'))  /* Marcus 17/06/2006 */
	and	((b.qt_resultado IS NOT NULL AND b.qt_resultado::text <> '') or (b.ds_resultado IS NOT NULL AND b.ds_resultado::text <> '') or (b.pr_resultado IS NOT NULL AND b.pr_resultado::text <> ''))
	and	a.nr_atendimento = nr_atendimento_p
	and	obter_se_exibe_exame(b.nr_seq_exame,cd_material_p) = 'S'
	
union

	--select	to_char(a.dt_resultado,'dd/mm/yyyy hh24:mi:ss'),
	--		a.dt_resultado
	select	/* +index(a EXALARE_I1) */
		to_char(obter_data_result_exame_pep(a.dt_resultado, b.dt_result_item, b.dt_digitacao, null, null, ie_data_p, b.dt_aprovacao), 'dd/mm/yyyy hh24:mi:ss'),
		obter_data_result_exame_pep(a.dt_resultado, b.dt_result_item, b.dt_digitacao, null, null, ie_data_p, b.dt_aprovacao)
	from	exame_laboratorio e,
		exame_lab_result_item b,
		exame_lab_resultado a
	where	a.nr_seq_resultado	= b.nr_seq_resultado
	and	coalesce(ie_grid_pep,'S') 	= 'S'
	and	b.nr_seq_exame		= e.nr_seq_exame
	and	obter_se_exibe_exame(b.nr_seq_exame,cd_material_p) = 'S'
	and	coalesce(a.nr_prescricao::text, '') = ''
	and	(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
	and	a.dt_resultado between dt_inicial_p and dt_final_ww
	and  	'S' = obter_se_permite_ver_result(e.nr_seq_exame,cd_perfil_w,nm_usuario_p)
	and	ie_atendimento_p	= 'N'
	and	((coalesce(cd_setor_atendimento_p::text, '') = '') or (obter_setor_prescricao(a.nr_prescricao,'C') = cd_setor_atendimento_p))
	and	((coalesce(nr_seq_protocolo_pep_p::text, '') = '') or (obter_se_exame_protocolo_pep(nr_seq_protocolo_pep_p,b.nr_seq_exame,Obter_Mat_Exame_Lab_prescr(a.nr_prescricao,b.nr_seq_prescr,1)) = 'S'))
	and	((coalesce(nr_seq_exame_p::text, '') = '') or (obter_se_contido(b.nr_seq_exame,nr_seq_exames_w) = 'S'))  /* Marcus 17/06/2006 */
	and	((b.qt_resultado IS NOT NULL AND b.qt_resultado::text <> '') or (b.ds_resultado IS NOT NULL AND b.ds_resultado::text <> '') or (b.pr_resultado IS NOT NULL AND b.pr_resultado::text <> ''))
	and	a.nr_atendimento in (	select	nr_atendimento
					from	atendimento_paciente
					where	cd_pessoa_fisica	= cd_pessoa_fisica_p)
	order by 2;


c03 CURSOR FOR
	SELECT	/* +index(a EXALARE_I1) */
		b.nr_seq_exame,
		--campo_mascara(b.qt_resultado, nvl(b.qt_decimais,0)),
		b.qt_resultado,
		b.ds_resultado,
		b.ds_observacao,
		b.pr_resultado,
		a.dt_resultado,
		--b.dt_aprovacao,
		obter_data_aprov_lab(a.nr_prescricao, b.nr_seq_prescr), /* Rafael em 2/7/2007 OS61582 */
		coalesce(b.qt_decimais,0),
		d.nr_prescricao,
		x.nr_sequencia,
		to_char(a.dt_resultado, 'hh24:mi'),
		to_char(a.dt_resultado, 'dd/mm/yy'),
		Obter_Mat_Exame_Lab_prescr(d.nr_prescricao,x.nr_sequencia,1),
		substr(obter_valor_ref_exame(b.nr_seq_resultado,b.nr_sequencia),1,255),
		substr(obter_valor_ref_exame_porc(b.nr_seq_resultado,b.nr_sequencia),1,255),
		substr(Obter_Metodo_Exame_Lab(b.nr_seq_metodo,2),1,80),
		b.ie_normalidade
	from	exame_lab_result_item b,
		prescr_procedimento x,
		prescr_medica d,
		exame_lab_resultado a
	where	a.nr_seq_resultado	= b.nr_seq_resultado
	and	d.nr_prescricao 	= a.nr_prescricao
	and	d.nr_prescricao		= x.nr_prescricao
	and	x.nr_sequencia		= b.nr_seq_prescr
	and  	'S' = obter_se_permite_ver_result(x.nr_seq_exame,cd_perfil_w,nm_usuario_p)
	and	x.ie_status_atend	>= ie_status_atend_ww
	and	a.dt_resultado between dt_inicial_p and dt_final_ww
	and	ie_atendimento_p	= 'S'
	and	((coalesce(cd_setor_atendimento_p::text, '') = '') or (d.cd_setor_atendimento = cd_setor_atendimento_p))
	and	((b.qt_resultado IS NOT NULL AND b.qt_resultado::text <> '') or (b.ds_resultado IS NOT NULL AND b.ds_resultado::text <> '') or (b.pr_resultado IS NOT NULL AND b.pr_resultado::text <> ''))
	and	d.nr_atendimento = nr_atendimento_p
	--and	a.dt_resultado	= to_date(vetor_w(ind).nm_coluna_w,'dd/mm/yyyy hh24:mi:ss')
	and	CASE WHEN coalesce(x.nr_seq_origem::text, '') = '' THEN obter_data_result_exame_pep(a.dt_resultado, b.dt_result_item, b.dt_digitacao, x.dt_coleta, dt_prev_execucao, ie_data_p, b.dt_aprovacao)  ELSE x.dt_prev_execucao END  =

to_date(vetor_w[ind].nm_coluna_w,'dd/mm/yyyy hh24:mi:ss')
	and	obter_se_exibe_exame(b.nr_seq_exame,cd_material_p) = 'S'
	
union

	SELECT	/* +index(a EXALARE_I1) */
		b.nr_seq_exame,
		--campo_mascara(b.qt_resultado, nvl(b.qt_decimais,0)),
		b.qt_resultado,
		b.ds_resultado,
		b.ds_observacao,
		b.pr_resultado,
		a.dt_resultado,
		--b.dt_aprovacao,
		obter_data_aprov_lab(a.nr_prescricao, b.nr_seq_prescr), /* Rafael em 2/7/2007 OS61582 */
		coalesce(b.qt_decimais,0),
		d.nr_prescricao,
		x.nr_sequencia,
		to_char(a.dt_resultado, 'hh24:mi'),
		to_char(a.dt_resultado, 'dd/mm/yy'),
		Obter_Mat_Exame_Lab_prescr(d.nr_prescricao,x.nr_sequencia,1),
		substr(obter_valor_ref_exame(b.nr_seq_resultado,b.nr_sequencia),1,255),
		substr(obter_valor_ref_exame_porc(b.nr_seq_resultado,b.nr_sequencia),1,255),
		substr(Obter_Metodo_Exame_Lab(b.nr_seq_metodo,2),1,80),
		b.ie_normalidade
	from	exame_lab_result_item b,
		prescr_procedimento x,
		prescr_medica d,
		exame_lab_resultado a
	where	a.nr_seq_resultado	= b.nr_seq_resultado
	and	d.nr_prescricao 	= a.nr_prescricao
	and	d.nr_prescricao		= x.nr_prescricao
	and	x.nr_sequencia		= b.nr_seq_prescr
	and  	'S' = obter_se_permite_ver_result(x.nr_seq_exame,cd_perfil_w,nm_usuario_p)
	and	x.ie_status_atend	>= ie_status_atend_ww
	and	a.dt_resultado between dt_inicial_p and dt_final_ww
	and	ie_atendimento_p	= 'N'
	and	((coalesce(cd_setor_atendimento_p::text, '') = '') or (d.cd_setor_atendimento = cd_setor_atendimento_p))
	and	((b.qt_resultado IS NOT NULL AND b.qt_resultado::text <> '') or (b.ds_resultado IS NOT NULL AND b.ds_resultado::text <> '') or (b.pr_resultado IS NOT NULL AND b.pr_resultado::text <> ''))
	and	d.cd_pessoa_fisica = cd_pessoa_fisica_p
	--and	a.dt_resultado	= to_date(vetor_w(ind).nm_coluna_w,'dd/mm/yyyy hh24:mi:ss')
	and	CASE WHEN coalesce(x.nr_seq_origem::text, '') = '' THEN obter_data_result_exame_pep(a.dt_resultado, b.dt_result_item, b.dt_digitacao, x.dt_coleta, dt_prev_execucao, ie_data_p, b.dt_aprovacao)  ELSE x.dt_prev_execucao END  =

to_date(vetor_w[ind].nm_coluna_w, 'dd/mm/yyyy hh24:mi:ss')
	and	obter_se_exibe_exame(b.nr_seq_exame,cd_material_p) = 'S'
	
union

	select	/* +index(a EXALARE_I1) */
		b.nr_seq_exame,
		--campo_mascara(b.qt_resultado, nvl(b.qt_decimais,0)),
		b.qt_resultado,
		b.ds_resultado,
		b.ds_observacao,
		b.pr_resultado,
		a.dt_resultado,
		--b.dt_aprovacao,
		a.dt_liberacao,
		coalesce(b.qt_decimais,0),
		Null,
		Null,
		to_char(a.dt_resultado, 'hh24:mi'),
		to_char(a.dt_resultado, 'dd/mm/yy'),
		coalesce(b.nr_seq_material,999999),
		substr(obter_valor_ref_exame(b.nr_seq_resultado,b.nr_sequencia),1,255),
		substr(obter_valor_ref_exame_porc(b.nr_seq_resultado,b.nr_sequencia),1,255),
		substr(Obter_Metodo_Exame_Lab(b.nr_seq_metodo,2),1,80),
		b.ie_normalidade
	from	exame_lab_result_item b,
		exame_lab_resultado a
	where	a.nr_seq_resultado	= b.nr_seq_resultado
	and	coalesce(a.nr_prescricao::text, '') = ''
	and	(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
	and  	'S' = obter_se_permite_ver_result(b.nr_seq_exame,cd_perfil_w,nm_usuario_p)
	and	a.dt_resultado between dt_inicial_p and dt_final_ww
	and	ie_atendimento_p	= 'S'
	and	((b.qt_resultado IS NOT NULL AND b.qt_resultado::text <> '') or (b.ds_resultado IS NOT NULL AND b.ds_resultado::text <> '') or (b.pr_resultado IS NOT NULL AND b.pr_resultado::text <> ''))
	and	a.nr_atendimento = nr_atendimento_p
	and	((coalesce(cd_setor_atendimento_p::text, '') = '') or (obter_setor_prescricao(a.nr_prescricao,'C') = cd_setor_atendimento_p))
	--and	a.dt_resultado	= to_date(vetor_w(ind).nm_coluna_w,'dd/mm/yyyy hh24:mi:ss')
	and	obter_data_result_exame_pep(a.dt_resultado, b.dt_result_item, b.dt_digitacao, null, null, ie_data_p, b.dt_aprovacao) = to_date(vetor_w[ind].nm_coluna_w, 'dd/mm/yyyy hh24:mi:ss')
	and	obter_se_exibe_exame(b.nr_seq_exame,cd_material_p) = 'S'
	
union

	select	/* +index(a EXALARE_I1) */
		b.nr_seq_exame,
		--campo_mascara(b.qt_resultado, nvl(b.qt_decimais,0)),
		b.qt_resultado,
		b.ds_resultado,
		b.ds_observacao,
		b.pr_resultado,
		a.dt_resultado,
		--b.dt_aprovacao,
		a.dt_liberacao,
		coalesce(b.qt_decimais,0),
		Null,
		Null,
		to_char(a.dt_resultado, 'hh24:mi'),
		to_char(a.dt_resultado, 'dd/mm/yy'),
		coalesce(b.nr_seq_material,999999),
		substr(obter_valor_ref_exame(b.nr_seq_resultado,b.nr_sequencia),1,255),
		substr(obter_valor_ref_exame_porc(b.nr_seq_resultado,b.nr_sequencia),1,255),
		substr(Obter_Metodo_Exame_Lab(b.nr_seq_metodo,2),1,80),
		b.ie_normalidade
	from	exame_lab_result_item b,
		exame_lab_resultado a
	where	a.nr_seq_resultado	= b.nr_seq_resultado
	and	coalesce(a.nr_prescricao::text, '') = ''
	and	(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
	and  	'S' = obter_se_permite_ver_result(b.nr_seq_exame,cd_perfil_w,nm_usuario_p)
	and	a.dt_resultado between dt_inicial_p and dt_final_ww
	and	ie_atendimento_p	= 'N'
	and	((coalesce(cd_setor_atendimento_p::text, '') = '') or (obter_setor_prescricao(a.nr_prescricao,'C') = cd_setor_atendimento_p))
	and	((b.qt_resultado IS NOT NULL AND b.qt_resultado::text <> '') or (b.ds_resultado IS NOT NULL AND b.ds_resultado::text <> '') or (b.pr_resultado IS NOT NULL AND b.pr_resultado::text <> ''))
	and	a.nr_atendimento in (	select	nr_atendimento
					from	atendimento_paciente
					where	cd_pessoa_fisica	= cd_pessoa_fisica_p)
	--and	a.dt_resultado	= to_date(vetor_w(ind).nm_coluna_w,'dd/mm/yyyy hh24:mi:ss');
	and	obter_data_result_exame_pep(a.dt_resultado, b.dt_result_item, b.dt_digitacao, null, null, ie_data_p, b.dt_aprovacao) = to_date(vetor_w[ind].nm_coluna_w, 'dd/mm/yyyy hh24:mi:ss')
	and	obter_se_exibe_exame(b.nr_seq_exame,cd_material_p) = 'S';
C04 CURSOR FOR
	SELECT	nr_sequencia
	from	w_result_exame_grid
	where	nr_seq_exame	= nr_seq_exame_w
	and	nr_seq_material	= nr_seq_material_w
	and	nm_usuario	= nm_usuario_p;



BEGIN


cd_perfil_w	:= obter_perfil_ativo;
dt_final_ww	:= fim_dia(dt_final_p);

if (ie_sem_aprovacao_p = 'S') then
	ie_status_atend_ww	:= 30;
end if;

if (nr_seq_exame_p IS NOT NULL AND nr_seq_exame_p::text <> '') then
	nr_seq_exames_w		:= '(' || nr_seq_exame_p || ')';
end if;

delete	FROM w_result_exame_grid
where	nm_usuario = nm_usuario_p;

delete	FROM w_result_exame_temp
where	nm_usuario = nm_usuario_p;

commit;

ivet	:= 0;
if (ie_ordem_p = 1) then
	begin
	open	c02;
	loop
	fetch c02 into
		dt_resultado_w,
		dt_resultado_ww;
	EXIT WHEN NOT FOUND; /* apply on c02 */
		begin
		ivet := ivet + 1;
		vetor_w[ivet].nm_coluna_w := dt_resultado_w;
		end;
	end loop;
	close c02;
	end;
else
	begin
	open	c002;
	loop
	fetch c002 into
		dt_resultado_w,
		dt_resultado_ww;
	EXIT WHEN NOT FOUND; /* apply on c002 */
		begin
		ivet := ivet + 1;
		vetor_w[ivet].nm_coluna_w := dt_resultado_w;
		end;
	end loop;
	close c002;
	end;
end if;

/* completar vetor se necessario  */

ind := ivet;
while(ind < 57) loop
	begin
	ind := ind + 1;
	vetor_w[ind].nm_coluna_w := null;
	end;
end loop;

select	nextval('w_result_exame_grid_seq')
into STRICT	nr_sequencia_w
;

insert into w_result_exame_grid(
	nr_sequencia,
	nm_usuario,
	nr_seq_exame,
	nm_exame,
	nr_seq_material,
	ds_unidade_medida,
	ds_referencia,
	ie_ordem,
	ie_ordem_seg,
	nr_apres_grupo,
	nr_apres_exame,
	ds_metodo,
	ds_result1,
	ds_result2,
	ds_result3,
	ds_result4,
	ds_result5,
	ds_result6,
	ds_result7,
	ds_result8,
	ds_result9,
	ds_result10,
	ds_result11,
	ds_result12,
	ds_result13,
	ds_result14,
	ds_result15,
	ds_result16,
	ds_result17,
	ds_result18,
	ds_result19,
	ds_result20,
	ds_result21,
	ds_result22,
	ds_result23,
	ds_result24,
	ds_result25,
	ds_result26,
	ds_result27,
	ds_result28,
	ds_result29,
	ds_result30,
	ds_result31,
	ds_result32,
	ds_result33,
	ds_result34,
	ds_result35,
	ds_result36,
	ds_result37,
	ds_result38,
	ds_result39,
	ds_result40,
	ds_result41,
	ds_result42,
	ds_result43,
	ds_result44,
	ds_result45,
	ds_result46,
	ds_result47,
	ds_result48,
	ds_result49,
	ds_result50,
	ds_result51,
	ds_result52,
	ds_result53,
	ds_result54,
	ds_result55,
	ds_result56,
	ds_result57)
Values ( nr_sequencia_w,
	nm_usuario_p,
	null,
	obter_desc_expressao(767648),
	null,
	'',
	'',
	-3,
	0,
	0,
	0,
	'',
	vetor_w[1].nm_coluna_w,
	vetor_w[2].nm_coluna_w,
	vetor_w[3].nm_coluna_w,
	vetor_w[4].nm_coluna_w,
	vetor_w[5].nm_coluna_w,
	vetor_w[6].nm_coluna_w,
	vetor_w[7].nm_coluna_w,
	vetor_w[8].nm_coluna_w,
	vetor_w[9].nm_coluna_w,
	vetor_w[10].nm_coluna_w,
	vetor_w[11].nm_coluna_w,
	vetor_w[12].nm_coluna_w,
	vetor_w[13].nm_coluna_w,
	vetor_w[14].nm_coluna_w,
	vetor_w[15].nm_coluna_w,
	vetor_w[16].nm_coluna_w,
	vetor_w[17].nm_coluna_w,
	vetor_w[18].nm_coluna_w,
	vetor_w[19].nm_coluna_w,
	vetor_w[20].nm_coluna_w,
	vetor_w[21].nm_coluna_w,
	vetor_w[22].nm_coluna_w,
	vetor_w[23].nm_coluna_w,
	vetor_w[24].nm_coluna_w,
	vetor_w[25].nm_coluna_w,
	vetor_w[26].nm_coluna_w,
	vetor_w[27].nm_coluna_w,
	vetor_w[28].nm_coluna_w,
	vetor_w[29].nm_coluna_w,
	vetor_w[30].nm_coluna_w,
	vetor_w[31].nm_coluna_w,
	vetor_w[32].nm_coluna_w,
	vetor_w[33].nm_coluna_w,
	vetor_w[34].nm_coluna_w,
	vetor_w[35].nm_coluna_w,
	vetor_w[36].nm_coluna_w,
	vetor_w[37].nm_coluna_w,
	vetor_w[38].nm_coluna_w,
	vetor_w[39].nm_coluna_w,
	vetor_w[40].nm_coluna_w,
	vetor_w[41].nm_coluna_w,
	vetor_w[42].nm_coluna_w,
	vetor_w[43].nm_coluna_w,
	vetor_w[44].nm_coluna_w,
	vetor_w[45].nm_coluna_w,
	vetor_w[46].nm_coluna_w,
	vetor_w[47].nm_coluna_w,
	vetor_w[48].nm_coluna_w,
	vetor_w[49].nm_coluna_w,
	vetor_w[50].nm_coluna_w,
	vetor_w[51].nm_coluna_w,
	vetor_w[52].nm_coluna_w,
	vetor_w[53].nm_coluna_w,
	vetor_w[54].nm_coluna_w,
	vetor_w[55].nm_coluna_w,
	vetor_w[56].nm_coluna_w,
	vetor_w[57].nm_coluna_w);

open	c10;
loop
fetch c10 into
		ds_grupo_exame_lab_w,
		nr_seq_grupo_w,
		nr_seq_apresent_w;
	EXIT WHEN NOT FOUND; /* apply on c10 */

	select	nextval('w_result_exame_grid_seq')
	into STRICT	nr_sequencia_w
	;

	insert into w_result_exame_grid(
		nr_sequencia,
		nm_usuario,
		nm_exame,
		ie_ordem,
		ie_ordem_seg,
		nr_apres_grupo,
		nr_apres_exame)
	values (
		nr_sequencia_w,
		nm_usuario_p,
		ds_grupo_exame_lab_w,
		nr_seq_grupo_w,
		1,
		nr_seq_apresent_w,
		-2);

end loop;
close c10;

open	c11;
loop
fetch c11 into
		ds_grupo_exame_lab_w,
		nr_seq_grupo_w,
		nr_seq_apresent_w;
	EXIT WHEN NOT FOUND; /* apply on c11 */


	select	nextval('w_result_exame_grid_seq')
	into STRICT	nr_sequencia_w
	;

	insert into w_result_exame_grid(
		nr_sequencia,
		nm_usuario,
		nm_exame,
		ie_ordem,
		ie_ordem_seg,
		nr_apres_grupo,
		nr_apres_exame)
	values (
		nr_sequencia_w,
		nm_usuario_p,
		ds_grupo_exame_lab_w,
		nr_seq_grupo_w,
		1,
		nr_seq_apresent_w,
		-2);

end loop;
close c11;

open C15;
loop
fetch C15 into	nr_seq_exame_w,
		nm_exame_w,
		nr_seq_material_w,
		ds_unidade_medida_w,
		nr_seq_grupo_w,
		nr_seq_apresent_w,
		nr_seq_apresent_exame_w,
		ds_metodo_w,
		ie_ordem_ww,
		ie_formato_result_exame_w,
		qt_resultado_exame_w,
		ds_resultado_exame_w,
		pr_resultado_exame_w;
EXIT WHEN NOT FOUND; /* apply on C15 */
	begin

	if (coalesce(qt_resultado_exame_w,0) <> 0) and (ie_formato_result_exame_w in ('CA','CV','DV','VP','V')) then

		insert into w_result_exame_temp(
			nm_usuario,
			nr_seq_exame,
			nm_exame,
			nr_seq_material,
			ds_unidade_medida,
			ie_ordem,
			ie_ordem_seg,
			nr_apres_grupo,
			nr_apres_exame,
			ie_formato_resultado,
			ds_metodo)
		values (
			nm_usuario_p,
			nr_seq_exame_w,
			nm_exame_w,
			nr_seq_material_w,
			ds_unidade_medida_w,
			ie_ordem_ww,
			2,
			nr_seq_apresent_w,
			nr_seq_apresent_exame_w,
			'V',
			ds_metodo_w);
	end if;

	if (pr_resultado_exame_w IS NOT NULL AND pr_resultado_exame_w::text <> '') and (ie_formato_result_exame_w in ('CA','P','VP')) then

		insert into w_result_exame_temp(
			nm_usuario,
			nr_seq_exame,
			nm_exame,
			nr_seq_material,
			ds_unidade_medida,
			ie_ordem,
			ie_ordem_seg,
			nr_apres_grupo,
			nr_apres_exame,
			ie_formato_resultado,
			ds_metodo)
		values (
			nm_usuario_p,
			nr_seq_exame_w,
			nm_exame_w ||' ( % )',
			nr_seq_material_w,
			ds_unidade_medida_w,
			ie_ordem_ww,
			2,
			nr_seq_apresent_w,
			nr_seq_apresent_exame_w,
			'P',
			ds_metodo_w);
	end if;

	if (ie_formato_result_exame_w in ('D','DL','DV','MS','MSL','S','SDM','SM')) and (ds_resultado_exame_w	<> '0') and (ds_resultado_exame_w IS NOT NULL AND ds_resultado_exame_w::text <> '') then
		insert into w_result_exame_temp(
			nm_usuario,
			nr_seq_exame,
			nm_exame,
			nr_seq_material,
			ds_unidade_medida,
			ie_ordem,
			ie_ordem_seg,
			nr_apres_grupo,
			nr_apres_exame,
			ie_formato_resultado,
			ds_metodo)
		values (
			nm_usuario_p,
			nr_seq_exame_w,
			nm_exame_w,
			nr_seq_material_w,
			ds_unidade_medida_w,
			ie_ordem_ww,
			2,
			nr_seq_apresent_w,
			nr_seq_apresent_exame_w,
			'D',
			ds_metodo_w);
	end if;

	end;
end loop;
close C15;


open	c30;
loop
fetch c30 into
		nr_seq_exame_w,
		nm_exame_w,
		nr_seq_material_w,
		ds_unidade_medida_w,
		ie_ordem_w,
		ie_ordem_seg_w,
		nr_seq_apresent_w,
		nr_seq_apresent_exame_w,
		ie_formato_resultado_w,
		ds_metodo_w;
	EXIT WHEN NOT FOUND; /* apply on c30 */

	select	nextval('w_result_exame_grid_seq')
	into STRICT	nr_sequencia_w
	;

	insert into w_result_exame_grid(
		nr_sequencia,
		nm_usuario,
		nr_seq_exame,
		nm_exame,
		nr_seq_material,
		ds_unidade_medida,
		ie_ordem,
		ie_ordem_seg,
		nr_apres_grupo,
		nr_apres_exame,
		ie_formato_resultado,
		ds_metodo)
	values (
		nr_sequencia_w,
		nm_usuario_p,
		nr_seq_exame_w,
		nm_exame_w,
		nr_seq_material_w,
		ds_unidade_medida_w,
		ie_ordem_w,
		ie_ordem_seg_w,
		nr_seq_apresent_w,
		nr_seq_apresent_exame_w,
		ie_formato_resultado_w,
		ds_metodo_w);
end loop;
close c30;

insert into w_result_exame_grid(
	nr_sequencia,
	nm_usuario,
	ie_ordem,
	ie_ordem_seg,
	nr_apres_grupo,
	nr_apres_exame)
SELECT	nextval('w_result_exame_grid_seq'),nm_usuario_p,-10,0,-10,-10;

insert into w_result_exame_grid(
	nr_sequencia,
	nm_usuario,
	ie_ordem,
	ie_ordem_seg,
	nr_apres_grupo,
	nr_apres_exame)
SELECT	nextval('w_result_exame_grid_seq'),nm_usuario_p,-7,0,-7,-7;

insert into w_result_exame_grid(
	nr_sequencia,
	nm_usuario,
	ie_ordem,
	ie_ordem_seg,
	nr_apres_grupo,
	nr_apres_exame)
SELECT	nextval('w_result_exame_grid_seq'),nm_usuario_p,-4,0,-4,-4;

/* gerar itens x horarios */

ind := 0;
while(ind < 57) loop
	begin
	ind := ind + 1;
	open	c03;
	loop
	fetch c03 into	nr_seq_exame_w,
			qt_resultado_w,
			ds_resultado_w,
			ds_observacao_w,
			pr_resultado_w,
			dt_resultado_ww,
			dt_aprovacao_w,
			qt_decimais_w,
			nr_prescricao_w,
			nr_sequencia_w,
			dt_hora_w,
			dt_result_w,
			nr_seq_material_w,
			ds_referencia_w,
			ds_referencia_porc_w,
			ds_metodo_w,
			ie_normalidade_w;
	EXIT WHEN NOT FOUND; /* apply on c03 */
		begin
		ds_cor_w	:= '';
		if (coalesce(dt_aprovacao_w::text, '') = '') then
			begin
			select	CASE WHEN length(to_char(ind))=1 THEN '0'||to_char(ind)  ELSE to_char(ind) END
			into STRICT	ds_cor_w
			;

			ds_cor_w	:= ds_cor_w ||'602,';
			end;
		elsif (coalesce(ie_normalidade_w,0) > 0) then
			begin
			select	CASE WHEN length(to_char(ind))=1 THEN '0'||to_char(ind)  ELSE to_char(ind) END
			into STRICT	ds_cor_w
			;

			ds_cor_w	:= ds_cor_w ||to_char(ie_normalidade_w)||',';
			end;
		end if;

		ds_comando_w	:=	' update w_result_exame_grid '||
					' set ds_result' || to_char(ind) || ' = :nr_prescricao' ||
					', ds_referencia = '|| chr(39) || obter_desc_expressao(753394) || chr(39) ||
					' where ie_ordem = -4 '||
					' and nm_usuario = :nm_usuario';

		ds_parametro_w	:= 'nr_prescricao='||nr_prescricao_w||'#@#@nm_usuario='||nm_usuario_p||'#@#@';

		CALL exec_sql_dinamico_bv('TASY', ds_comando_w,ds_parametro_w);


		ds_comando_w	:=	' update w_result_exame_grid '||
					' set ds_result' || to_char(ind) || ' = :ds_hora' ||
					', ds_referencia = '|| chr(39) || obter_desc_expressao(291374) || chr(39) ||
					' where ie_ordem = -7 '||
					' and nm_usuario = :nm_usuario';

		ds_parametro_w	:= 'ds_hora='||dt_hora_w||'#@#@nm_usuario='||nm_usuario_p||'#@#@';

		CALL exec_sql_dinamico_bv('TASY', ds_comando_w,ds_parametro_w);


		ds_comando_w	:=	' update w_result_exame_grid '||
					' set ds_result' || to_char(ind) || ' = :ds_resultado' ||
					', ds_referencia = '|| chr(39) || obter_desc_expressao(287198) || chr(39) ||
					' where ie_ordem = -10 '||
					' and nm_usuario = :nm_usuario';

		ds_parametro_w	:= 'ds_resultado='||dt_result_w||'#@#@nm_usuario='||nm_usuario_p||'#@#@';

		CALL exec_sql_dinamico_bv('TASY', ds_comando_w,ds_parametro_w);


		if (coalesce(qt_resultado_w,0) <> 0) then
			begin
			ds_result_w	:= qt_resultado_w;
			if (qt_resultado_w < 1) then
				ds_result_w	:= replace(ds_result_w,',','0,');
			end if;

			ds_comando_w	:=	' update w_result_exame_grid '||
						' set ds_result' || to_char(ind) || ' = :ds_resultado' ||
						' ,ds_cor = ds_cor || :ds_cor' ||
						' ,ds_referencia = :ds_referencia' ||
						' where nr_seq_exame	= :nr_seq_exame'    ||
						' and nr_seq_material	= :nr_seq_material' ||
						' and ie_formato_resultado = :ie_formato '||
						' and nm_usuario = :nm_usuario';
			ds_result_w := replace(ds_result_w,'.',',');

			ds_parametro_w	:= 	'ds_resultado='||ds_result_w||'#@#@ds_cor='||ds_cor_w||'#@#@ds_referencia='||ds_referencia_w||


'#@#@nr_seq_exame='||nr_seq_exame_w||'#@#@nr_seq_material='||nr_seq_material_w||'#@#@ie_formato='||'V'||'#@#@nm_usuario='||nm_usuario_p||'#@#@';
			CALL exec_sql_dinamico_bv('TASY', ds_comando_w,ds_parametro_w);
			end;
		end if;

		if (coalesce(pr_resultado_w,0) <> 0) then
			begin
				ds_result_w	:= pr_resultado_w;
			if (pr_resultado_w < 1) then
				ds_result_w	:= replace(pr_resultado_w,',','0,');
			end if;

			ds_comando_w	:=	' update w_result_exame_grid '||
						' set ds_result' || to_char(ind) || ' = :ds_resultado' ||
						' ,ds_cor = ds_cor || :ds_cor' ||
						' ,ds_referencia = :ds_referencia' ||
						' where nr_seq_exame	= :nr_seq_exame'    ||
						' and nr_seq_material	= :nr_seq_material' ||
						' and ie_formato_resultado = :ie_formato '||
						' and nm_usuario = :nm_usuario';
			ds_result_w := replace(ds_result_w,'.',',');

			ds_parametro_w	:= 	'ds_resultado='||ds_result_w||'#@#@ds_cor='||ds_cor_w||'#@#@ds_referencia='||ds_referencia_porc_w||


'#@#@nr_seq_exame='||nr_seq_exame_w||'#@#@nr_seq_material='||nr_seq_material_w||'#@#@ie_formato='||'P'||'#@#@nm_usuario='||nm_usuario_p||'#@#@';

			CALL exec_sql_dinamico_bv('TASY', ds_comando_w,ds_parametro_w);
			end;
		end if;

		if (ds_resultado_w IS NOT NULL AND ds_resultado_w::text <> '') then
			begin

			ds_comando_w	:=	' update w_result_exame_grid '||
						' set ds_result' || to_char(ind) || ' = :ds_resultado' ||
						' ,ds_cor = ds_cor || :ds_cor' ||
						' ,ds_referencia = :ds_referencia' ||
						' where nr_seq_exame	= :nr_seq_exame'    ||
						' and nr_seq_material	= :nr_seq_material' ||
						' and ie_formato_resultado = :ie_formato '||
						' and nm_usuario = :nm_usuario';

			ds_parametro_w	:= 	'ds_resultado='||ds_resultado_w||'#@#@ds_cor='||ds_cor_w||'#@#@ds_referencia='||ds_referencia_w||


'#@#@nr_seq_exame='||nr_seq_exame_w||'#@#@nr_seq_material='||nr_seq_material_w||'#@#@ie_formato='||'D'||'#@#@nm_usuario='||nm_usuario_p||'#@#@';

			CALL exec_sql_dinamico_bv('TASY', ds_comando_w,ds_parametro_w);
			end;
		end if;

		if (ds_observacao_w IS NOT NULL AND ds_observacao_w::text <> '') then
			begin
			open c04;
			loop
			fetch c04 into nr_sequencia_w;
			EXIT WHEN NOT FOUND; /* apply on c04 */
				begin

				select	nextval('w_result_exame_obs_seq')
				into STRICT	nr_seq_w
				;

				insert into w_result_exame_obs(
						nr_sequencia,
						nm_usuario,
						nr_seq_result,
						dt_resultado,
						ds_observacao)
				values (		nr_seq_w,
						nm_usuario_p,
						nr_sequencia_w,
						dt_resultado_ww,
						ds_observacao_w);
				end;
			end loop;
			close c04;
			end;
		end if;
		end;
	end loop;
	close c03;
	end;
end loop;

ds_comando_w	:= 	' update w_result_exame_grid '||
			' set ds_material = Obter_Material_Exame_Lab(nr_seq_material,null,3) '||
			' where nm_usuario = :nm_usuario';

ds_parametro_w	:= 'nm_usuario='||nm_usuario_p||'#@#@';
CALL exec_sql_dinamico_bv('TASY', ds_comando_w,ds_parametro_w);


commit;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE criar_atend_res_exa_material (nr_atendimento_p bigint, cd_pessoa_fisica_p text, dt_inicial_p timestamp, dt_final_p timestamp, nr_seq_exame_p text, ie_atendimento_p text, ie_sem_aprovacao_p text, ie_ordem_p bigint, nr_seq_protocolo_pep_p bigint, ie_data_p text, nm_usuario_p text, cd_setor_atendimento_p bigint, ie_modo_agrup_p text, cd_material_p bigint) FROM PUBLIC;

