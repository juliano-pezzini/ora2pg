-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE fis_gerar_reg_c110_icmsipi ( nr_seq_controle_p bigint, nr_seq_nota_p bigint) AS $body$
DECLARE


/*REGISTRO C110: INFORMAÇÃO COMPLEMENTAR DA NOTA FISCAL (CÓDIGO 01,1B, 04 e 55).*/



-- VARIABLES
ie_gerou_dados_bloco_w	varchar(1) := 'N';
ds_observacao_w		nota_fiscal.ds_observacao%type;
nr_seq_icmsipi_C110_w	fis_efd_icmsipi_C110.nr_sequencia%type;
nr_cod_0450_w		fis_efd_icmsipi_controle.nr_cod_0450%type;


-- USUARIO
nm_usuario_w usuario.nm_usuario%type;


BEGIN
/*Obteção do usuário ativo no tasy*/

nm_usuario_w := Obter_Usuario_Ativo;


begin

select	ds_observacao
into STRICT	ds_observacao_w
from	nota_fiscal
where	nr_sequencia = nr_seq_nota_p  LIMIT 1;

exception
when others then
	ds_observacao_w:= null;
end;

if (coalesce(ds_observacao_w, 'XX') <> 'XX') then
	begin	
	
	if (ie_gerou_dados_bloco_w = 'N') then
		ie_gerou_dados_bloco_w:=	'S';
	end if;
	
	/*Pega a sequencial e adciona mais 1 para inserir o registro posterior, esse campo serve para nao perder o sequancial do cd_inf*/

	nr_cod_0450_w := fis_obter_seq_0450_icmsipi(nr_seq_controle_p, nr_cod_0450_w);
	
	/*Busca da sequencia da tabela especificada - fis_efd_icmsipi_C110 */

	select	nextval('fis_efd_icmsipi_c110_seq')
	into STRICT	nr_seq_icmsipi_C110_w
	;
	
	insert into fis_efd_icmsipi_C110(	nr_sequencia,
						dt_atualizacao,
						nm_usuario,
						dt_atualizacao_nrec,
						nm_usuario_nrec,
						cd_reg,
						cd_inf,
						ds_txt_compl,
						nr_seq_controle,
						nr_seq_nota)
				values (	nr_seq_icmsipi_C110_w,
						clock_timestamp(),
						nm_usuario_w,
						clock_timestamp(),
						nm_usuario_w,
						'C110',
						nr_cod_0450_w,
						null,
						nr_seq_controle_p,
						nr_seq_nota_p);	
	end;
end if;

/*Atualização informação no controle de geração de registro para SIM*/

if (ie_gerou_dados_bloco_w = 'S') then
	update	fis_efd_icmsipi_controle
	set	ie_mov_C 	= 'S'
	where	nr_sequencia 	= nr_seq_controle_p;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE fis_gerar_reg_c110_icmsipi ( nr_seq_controle_p bigint, nr_seq_nota_p bigint) FROM PUBLIC;

