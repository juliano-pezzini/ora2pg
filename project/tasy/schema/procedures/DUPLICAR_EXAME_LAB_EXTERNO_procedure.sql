-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE duplicar_exame_lab_externo ( nr_sequencia_p bigint, nm_usuario_p text, nr_atendimento_p bigint default null, cd_medico_p text default null) AS $body$
DECLARE


cd_pessoa_fisica_w	    varchar(10);
ie_nivel_atencao_w		varchar(1);
nr_seq_resultado_w		bigint;
nr_seq_exame_lab_w		bigint;


C01 CURSOR FOR
	SELECT	a.*
	from	exame_lab_result_item a
	where	nr_seq_resultado = nr_sequencia_p
	order by nr_sequencia;

Vet01 C01%RowType;


BEGIN


if (nr_sequencia_p > 0) then

	select	coalesce(max(nr_seq_resultado),0)+1
	into STRICT	nr_seq_resultado_w
	from	exame_lab_resultado;


	ie_nivel_atencao_w := wheb_assist_pck.get_nivel_atencao_perfil;

	insert	into exame_lab_resultado(nr_seq_resultado,
				dt_resultado,
				dt_atualizacao,
				nm_usuario,
				nr_prescricao,
				nr_atendimento,
				cd_medico,
				nr_seq_protocolo,
				dt_liberacao,
				cd_pessoa_fisica,
				ie_nivel_atencao)
				SELECT	nr_seq_resultado_w,
					dt_resultado,
					dt_atualizacao,
					nm_usuario_p,
					nr_prescricao,
					nr_atendimento_p,
					cd_medico_p,
					nr_seq_protocolo,
					dt_liberacao,
					cd_pessoa_fisica,
					ie_nivel_atencao_w
				from	exame_lab_resultado
				where	nr_seq_resultado 	= nr_sequencia_p;

	COMMIT;


	open C01;
		loop
		fetch C01 into
			Vet01;
		EXIT WHEN NOT FOUND; /* apply on C01 */
			begin

			nr_seq_exame_lab_w := nr_seq_exame_lab_w + 1;

			insert into EXAME_LAB_RESULT_ITEM(nr_seq_resultado,
												nr_sequencia,
												 nr_seq_exame,
												 dt_atualizacao,
												 nm_usuario,
												 qt_resultado,
												 ds_resultado,
												 nr_seq_metodo,
												 nr_seq_material,
												 pr_resultado,
												 ie_status,
												 dt_aprovacao,
												 nm_usuario_aprovacao,
												 nr_seq_prescr,
												 pr_minimo,
												 pr_maximo,
												 qt_minima,
												 qt_maxima,
												 ds_observacao,
												 ds_referencia,
												 ds_unidade_medida,
												 qt_decimais,
												 ds_regra,
												 dt_coleta,
												 nr_seq_reagente,
												 nr_seq_formato,
												 cd_medico_resp,
												 dt_impressao,
												 nr_seq_unid_med,
												 cd_equipamento,
												 ie_consiste,
												 ds_protocolo_externo,
												 ie_normalidade,
												 ie_restringe_resultado,
												 dt_digitacao,
												 nr_seq_formato_red,
												 nr_seq_metodo_exame,
												 nr_lote_reagente,
												 nr_seq_assinatura,
												 nr_seq_assinat_inativ,
												 dt_validade_reagente,
												 ds_resultado_curto,
												 nm_usuario_liberacao,
												 dt_liberacao,
												 nr_seq_motivo_bloqueio,
												 ds_obs_bloq_result,
												 nr_seq_lote_patol,
												 ds_obs_lote_ent,
												 ie_acao_criterio_lote,
												 ds_mensagem_criterio,
												 nr_seq_material_integr,
												 ds_obs_curta,
												 dt_exame_ext,
												 ds_referencia_ext,
												 ds_metodo_criterio,
												 ds_material_criterio,
												 nm_usuario_prim_dig,
												 ie_tipo_val_crit,
												 ds_acao_criterio,
												 ds_result_sug_crit,
												 ie_valor_crit,
												 ds_metodo_ext,
												 dt_visualizacao,
												 nm_usuario_visualizacao,
												 ie_resultado_critico,
												 ds_hash_assinatura,
												 ie_resultado_relevante,
												 nm_usuario_seg_dig)
									values ( nr_seq_resultado_w,
											 Vet01.nr_sequencia,
											 Vet01.nr_seq_exame,
											 Vet01.dt_atualizacao,
											 Vet01.nm_usuario,
											 Vet01.qt_resultado,
											 Vet01.ds_resultado,
											 Vet01.nr_seq_metodo,
											 Vet01.nr_seq_material,
											 Vet01.pr_resultado,
											 Vet01.ie_status,
											 Vet01.dt_aprovacao,
											 Vet01.nm_usuario_aprovacao,
											 Vet01.nr_seq_prescr,
											 Vet01.pr_minimo,
											 Vet01.pr_maximo,
											 Vet01.qt_minima,
											 Vet01.qt_maxima,
											 Vet01.ds_observacao,
											 Vet01.ds_referencia,
											 Vet01.ds_unidade_medida,
											 Vet01.qt_decimais,
											 Vet01.ds_regra,
											 Vet01.dt_coleta,
											 Vet01.nr_seq_reagente,
											 Vet01.nr_seq_formato,
											 Vet01.cd_medico_resp,
											 Vet01.dt_impressao,
											 Vet01.nr_seq_unid_med,
											 Vet01.cd_equipamento,
											 Vet01.ie_consiste,
											 Vet01.ds_protocolo_externo,
											 Vet01.ie_normalidade,
											 Vet01.ie_restringe_resultado,
											 Vet01.dt_digitacao,
											 Vet01.nr_seq_formato_red,
											 Vet01.nr_seq_metodo_exame,
											 Vet01.nr_lote_reagente,
											 Vet01.nr_seq_assinatura,
											 Vet01.nr_seq_assinat_inativ,
											 Vet01.dt_validade_reagente,
											 Vet01.ds_resultado_curto,
											 Vet01.nm_usuario_liberacao,
											 Vet01.dt_liberacao,
											 Vet01.nr_seq_motivo_bloqueio,
											 Vet01.ds_obs_bloq_result,
											 Vet01.nr_seq_lote_patol,
											 Vet01.ds_obs_lote_ent,
											 Vet01.ie_acao_criterio_lote,
											 Vet01.ds_mensagem_criterio,
											 Vet01.nr_seq_material_integr,
											 Vet01.ds_obs_curta,
											 Vet01.dt_exame_ext,
											 Vet01.ds_referencia_ext,
											 Vet01.ds_metodo_criterio,
											 Vet01.ds_material_criterio,
											 Vet01.nm_usuario_prim_dig,
											 Vet01.ie_tipo_val_crit,
											 Vet01.ds_acao_criterio,
											 Vet01.ds_result_sug_crit,
											 Vet01.ie_valor_crit,
											 Vet01.ds_metodo_ext,
											 Vet01.dt_visualizacao,
											 Vet01.nm_usuario_visualizacao,
											 Vet01.ie_resultado_critico,
											 Vet01.ds_hash_assinatura,
											 Vet01.ie_resultado_relevante,
											 Vet01.nm_usuario_seg_dig);
			commit;

			/*begin

			copia_campo_long_de_para_Java(	'EXAME_LAB_RESULT_ITEM',
						'DS_RESULTADO',
						' where nr_seq_resultado = :nr_seq_resultado and nr_sequencia = :nr_seq ',
						'nr_seq_resultado='||nr_sequencia_p||';nr_seq='||Vet01.nr_sequencia,
						'EXAME_LAB_RESULT_ITEM',
						'DS_RESULTADO',
						' where nr_seq_resultado = :nr_seq_resultado and nr_sequencia = :nr_seq ',
						'nr_seq_resultado='||nr_seq_resultado_w||';nr_seq='||Vet01.nr_sequencia,
						'L');
						commit;

				exception
						when others then

						copia_campo_long_de_para(	'EXAME_LAB_RESULT_ITEM',
						'DS_RESULTADO',
						' where nr_seq_resultado = :nr_seq_resultado and nr_sequencia = :nr_seq ',
						'nr_seq_resultado='||nr_sequencia_p||';nr_seq='||Vet01.nr_sequencia,
						'EXAME_LAB_RESULT_ITEM',
						'DS_RESULTADO',
						'where nr_seq_resultado = :nr_seq_resultado and nr_sequencia = :nr_seq ',
						'nr_seq_resultado='||nr_seq_resultado_w||';nr_seq='||Vet01.nr_sequencia);

						commit;
				end;*/
			end;
		end loop;
		close C01;
end if;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE duplicar_exame_lab_externo ( nr_sequencia_p bigint, nm_usuario_p text, nr_atendimento_p bigint default null, cd_medico_p text default null) FROM PUBLIC;

