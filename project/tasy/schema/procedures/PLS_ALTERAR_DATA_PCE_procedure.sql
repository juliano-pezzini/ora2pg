-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_alterar_data_pce ( nr_seq_segurado_p bigint, dt_pce_p timestamp, nm_usuario_p text) AS $body$
DECLARE


dt_inclusao_pce_w	pls_segurado.dt_inclusao_pce%type;
qt_pagador_pf_w		bigint;
				

BEGIN

if	(nr_seq_segurado_p IS NOT NULL AND nr_seq_segurado_p::text <> '' AND dt_pce_p IS NOT NULL AND dt_pce_p::text <> '') then
	select	dt_inclusao_pce,
		(select	count(1)
		from	pls_contrato_pagador x
		where	x.nr_sequencia = a.nr_seq_pagador
		and	(x.cd_pessoa_fisica IS NOT NULL AND x.cd_pessoa_fisica::text <> ''))
	into STRICT	dt_inclusao_pce_w,
		qt_pagador_pf_w
	from	pls_segurado a
	where	nr_sequencia = nr_seq_segurado_p;

	if (qt_pagador_pf_w > 0) then
		update	pls_segurado
		set	dt_inclusao_pce	= dt_pce_p,
			dt_atualizacao	= clock_timestamp(),
			nm_usuario	= nm_usuario_p
		where	nr_sequencia	= nr_seq_segurado_p;
			
		CALL pls_gerar_segurado_historico(	nr_seq_segurado_p, '112', clock_timestamp(), wheb_mensagem_pck.get_texto(1171422),
						wheb_mensagem_pck.get_texto(1171461) || ': ' || dt_inclusao_pce_w || chr(13) || wheb_mensagem_pck.get_texto(1171432) || ': ' || dt_pce_p, null, null, null, 
						null, null, null, null,
						null, null, null, null, 
						nm_usuario_p, 'N');

		commit;
	else
		CALL wheb_mensagem_pck.exibir_mensagem_abort(1171466);
	end if;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_alterar_data_pce ( nr_seq_segurado_p bigint, dt_pce_p timestamp, nm_usuario_p text) FROM PUBLIC;

