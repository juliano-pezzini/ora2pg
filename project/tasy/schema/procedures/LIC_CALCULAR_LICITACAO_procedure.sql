-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE lic_calcular_licitacao ( nr_seq_licitacao_p bigint, ie_gera_historico_p text, nm_usuario_p text) AS $body$
DECLARE

					 
nr_seq_lic_item_w		bigint;
nr_seq_fornec_w		bigint;
cd_material_w		integer;
vl_item_w			double precision;
ds_fornecedor_w		varchar(100);
ds_material_w		varchar(255);
nr_seq_lote_w		integer;
nr_lote_compra_w	varchar(255);

c00 CURSOR FOR 
SELECT	substr(obter_nome_pf_pj(null, a.cd_cgc_fornec),1,100) ds_fornecedor, 
	b.nr_seq_lic_item, 
	substr(lic_obter_desc_mat_lote(a.nr_seq_licitacao,b.nr_seq_lic_item),1,255) ds_material 
from	reg_lic_fornec a, 
	reg_lic_item_fornec b 
where	a.nr_sequencia	= b.nr_seq_fornec 
and	a.nr_seq_licitacao	= nr_seq_licitacao_p 
and	coalesce(b.vl_original,0)	= 0;
	
c01 CURSOR FOR 
SELECT	nr_seq_lic_item, 
	cd_material, 
	nr_seq_lote, 
	nr_lote_compra 
from	reg_lic_item 
where	nr_seq_licitacao	 = nr_seq_licitacao_p 
and	((coalesce(ie_lote,'N') = 'S') or (coalesce(nr_seq_lote::text, '') = ''));


BEGIN 
 
delete 
from	reg_lic_vencedor 
where	nr_seq_licitacao	= nr_seq_licitacao_p;
commit;
 
open C00;
loop 
fetch C00 into	 
	ds_fornecedor_w, 
	nr_seq_lic_item_w, 
	ds_material_w;
EXIT WHEN NOT FOUND; /* apply on C00 */
	begin 
	CALL wheb_mensagem_pck.exibir_mensagem_abort(266171,'DS_FORNECEDOR=' || ds_fornecedor_w || ';NR_SEQ_LIC_ITEM=' || nr_seq_lic_item_w || ';DS_MATERIAL=' || ds_material_w);
	--'O fornecedor ' || ds_fornecedor_w || ' não informou o preço da proposta inicial para o item (Seq: ' || nr_seq_lic_item_w || ') ' || ds_material_w); 
	end;
end loop;
close C00;
 
open C01;
loop 
fetch C01 into	 
	nr_seq_lic_item_w, 
	cd_material_w, 
	nr_seq_lote_w, 
	nr_lote_compra_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin 
 
	nr_seq_fornec_w	:= obter_fornec_venc_licitacao(nr_seq_licitacao_p,nr_seq_lic_item_w);
 
	if (nr_seq_fornec_w > 0) then 
	 
		begin 
		select	CASE WHEN coalesce(b.vl_item,0)=0 THEN coalesce(b.vl_original,0)  ELSE coalesce(b.vl_item,0) END  
		into STRICT	vl_item_w 
		from	reg_lic_fornec a, 
			reg_lic_item_fornec b 
		where	a.nr_sequencia			= b.nr_seq_fornec 
		and	a.nr_sequencia			= nr_seq_fornec_w 
		and	a.nr_seq_licitacao			= nr_seq_licitacao_p 
		and	b.nr_seq_lic_item			= nr_seq_lic_item_w 
		and	coalesce(a.ie_situacao, 'A')		<> 'I' 
		and	coalesce(b.ie_qualificado, 'S')		= 'S' 
		and	coalesce(b.ie_qualif_lance_fornec,'S')	= 'S';
		exception when no_data_found then 
			vl_item_w	:= 0;
		end;
		 
		insert into reg_lic_vencedor( 
			nr_sequencia, 
			dt_atualizacao, 
			nm_usuario, 
			nr_seq_licitacao, 
			nr_seq_lic_item, 
			cd_material, 
			nr_seq_fornec, 
			vl_item, 
			nr_seq_lote, 
			nr_lote_compra) 
		values (	nextval('reg_lic_vencedor_seq'), 
			clock_timestamp(), 
			nm_usuario_p, 
			nr_seq_licitacao_p, 
			nr_seq_lic_item_w, 
			cd_material_w, 
			nr_seq_fornec_w, 
			vl_item_w, 
			nr_seq_lote_w, 
			nr_lote_compra_w);
	end if;
	end;	
end loop;
close C01;
 
if (ie_gera_historico_p = 'S') then 
	insert into reg_lic_historico( 
		nr_sequencia, 
		dt_atualizacao, 
		nm_usuario, 
		ie_tipo_historico, 
		ds_observacao, 
		nr_seq_licitacao) 
	values (	nextval('reg_lic_historico_seq'), 
		clock_timestamp(), 
		nm_usuario_p, 
		'CL', 
		WHEB_MENSAGEM_PCK.get_texto(312564), --Cálculo da licitação. 
		nr_seq_licitacao_p);
end if;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE lic_calcular_licitacao ( nr_seq_licitacao_p bigint, ie_gera_historico_p text, nm_usuario_p text) FROM PUBLIC;

