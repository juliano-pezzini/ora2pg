-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_guia_morte_noms ( dt_inicial_p timestamp, dt_final_p timestamp, ie_sobreescrever_p text, nm_usuario_p text) AS $body$
DECLARE


nr_seq_pessoa_endereco_w  bigint;
record_w				guia_morte_noms%rowtype;
nr_seq_estab_end_w		end_endereco.nr_sequencia%type;
nr_seq_local_obito_w	declaracao_obito.nr_seq_local_obito%type;
nr_seq_causa_morte_w	declaracao_obito.nr_seq_causa_morte%type;
nr_person_name_decl_w	declaracao_obito.nr_seq_person_name%type;
nr_seq_parentesco_w		declaracao_obito.nr_seq_parentesco%type;
nr_seq_ocor_endereco_w	declaracao_obito.nr_seq_ocor_endereco%type;
nr_seq_end_acidente_w declaracao_obito.nr_seq_end_acidente%type;
cd_cid_direta_w 		declaracao_obito.cd_cid_direta%type;
qt_peso_pf_w			pessoa_fisica.qt_peso%type;
qt_altura_cm_pf_w		pessoa_fisica.qt_altura_cm%type;
cd_nacionalidade_w		pessoa_fisica.cd_nacionalidade%type;
cd_cargo_w				pessoa_fisica.cd_cargo%type;
ie_unid_med_peso_w		atendimento_sinal_vital.ie_unid_med_peso%type;
ie_unid_med_altura_w	atendimento_sinal_vital.ie_unid_med_altura%type;
qt_peso_atual_w			atendimento_sinal_vital.qt_peso_atual%type;
qt_peso_w				atendimento_sinal_vital.qt_peso%type;
qt_altura_cm_w			atendimento_sinal_vital.qt_altura_cm%type;
qt_altura_m_w			atendimento_sinal_vital.qt_altura_m%type;
count_w		integer := 1;
cd_convenio_W integer;
nr_seq_catalogo_pac_w	end_endereco.nr_sequencia%type;
cd_pessoa_mae_w			pessoa_fisica.cd_pessoa_fisica%type;
nr_seq_pessoa_end_estab_w	pessoa_endereco.nr_sequencia%type;

c_consulta_atendimento CURSOR FOR
SELECT	a.nr_atendimento,
		a.nr_atendimento_mae,
		a.cd_pessoa_fisica,
		a.cd_estabelecimento,
		g.nr_sequencia nr_seq_declaracao,
		g.cd_medico,
		SUBSTR(coalesce(g.ds_diagnostico,'NO APLICA'),1,150) DEFDESC_LES,
		g.ie_obito_mulher DEFDURANTE,
		g.ie_gravidez_causou_morte DEFTPO_EMB,
		g.ie_morte_compl_gravidez DEFCOM_EMB,
		coalesce(G.CD_LUGAR_OCOR,'99') DEFLUG_OCU,
		CASE WHEN coalesce(obter_se_morte_materna_mx(a.nr_atendimento),0)=0 THEN '0'  ELSE '1' END  DEFVERMAT
from	atendimento_paciente a,
		declaracao_obito g
where	a.nr_atendimento = g.nr_atendimento
and 	g.ie_situacao = 'A'
and		(g.dt_obito IS NOT NULL AND g.dt_obito::text <> '')
and 	(g.dt_liberacao IS NOT NULL AND g.dt_liberacao::text <> '')
and 	coalesce(g.dt_inativacao::text, '') = ''
and 	IE_STATUS_ATENDIMENTO <>	 'C'
and	not exists (SELECT 	1
		from	nascimento x
		where	x.ie_unico_nasc_vivo = 'N'
		and	x.nr_atend_rn = a.nr_atendimento)
and	not exists (select	1
		from	guia_morte_noms z
		where	z.nr_atendimento = a.nr_atendimento)
and	g.dt_obito between pkg_date_utils.start_of(dt_inicial_p,'MONTH') and pkg_date_utils.end_of(dt_final_p,'MONTH');

c_consulta_atendimento_w c_consulta_atendimento%rowtype;

c_consulta_cid_1 CURSOR FOR
SELECT	rpad(a.cd_doenca,4) cd_doenca,
		rpad(a.ds_causa_cid,100) ds_causa_cid,
		a.ie_tipo_tempo_dir ie_tipo_tempo_dir,
		coalesce(a.qt_tempo_dir,'999') qt_tempo_dir
from	declaracao_obito_cid a
where	a.nr_seq_declaracao = c_consulta_atendimento_w.nr_seq_declaracao
ORDER BY dt_atualizacao;

c_consulta_cid_2 CURSOR FOR
SELECT	rpad(a.cd_doenca,4) cd_doenca,
		rpad(a.ds_causa_cid,100) ds_causa_cid,
		a.ie_tipo_tempo_dir ie_tipo_tempo_dir,
		coalesce(a.qt_tempo_dir,'999') qt_tempo_dir
from	declaracao_obito_cid a
where	a.nr_seq_declaracao = c_consulta_atendimento_w.nr_seq_declaracao
ORDER BY dt_atualizacao;

c_consulta_cid_1w c_consulta_cid_1%rowtype;
c_consulta_cid_2w c_consulta_cid_2%rowtype;


BEGIN

if (dt_inicial_p IS NOT NULL AND dt_inicial_p::text <> '') and (dt_final_p IS NOT NULL AND dt_final_p::text <> '') and (nm_usuario_p IS NOT NULL AND nm_usuario_p::text <> '') then
	begin

	if (ie_sobreescrever_p = 'S') then
		delete 	from guia_morte_noms
		where 	dt_obito between pkg_date_utils.start_of(dt_inicial_p,'MONTH')
		and pkg_date_utils.end_of(dt_final_p,'MONTH')
		and coalesce(dt_liberacao::text, '') = '';
		commit;
	end if;

	open c_consulta_atendimento;
	loop
	fetch c_consulta_atendimento into
		c_consulta_atendimento_w;
	EXIT WHEN NOT FOUND; /* apply on c_consulta_atendimento */
		begin

		record_w.ds_causa_1 		:= null;
		record_w.cd_tempo_causa_1 	:= null;
		record_w.qt_tempo_causa_1 	:= null;
		record_w.ds_causa_1a 		:= null;
		record_w.cd_tempo_causa_1a 	:= null;
		record_w.qt_tempo_causa_1a 	:= null;
		record_w.ds_causa_2 		:= null;
		record_w.cd_tempo_causa_2 	:= null;
		record_w.qt_tempo_causa_2 	:= null;
		record_w.ds_causa_2a 		:= null;
		record_w.cd_tempo_causa_2a 	:= null;
		record_w.qt_tempo_causa_2a 	:= null;
		record_w.ds_causa_3 		:= null;
		record_w.cd_tempo_causa_3 	:= null;
		record_w.qt_tempo_causa_3 	:= null;
		record_w.ds_causa_3a 		:= null;
		record_w.cd_tempo_causa_3a 	:= null;
		record_w.qt_tempo_causa_3a 	:= null;
		record_w.ds_causa_4 		:= null;
		record_w.cd_tempo_causa_4 	:= null;
		record_w.qt_tempo_causa_4 	:= null;
		record_w.ds_causa_4a 		:= null;
		record_w.cd_tempo_causa_4a 	:= null;
		record_w.qt_tempo_causa_4a 	:= null;
		record_w.ds_causa_5 		:= null;
		record_w.cd_tempo_causa_5 	:= null;
		record_w.qt_tempo_causa_5 	:= null;
		record_w.ds_causa_5a 		:= null;
		record_w.cd_tempo_causa_5a 	:= null;
		record_w.qt_tempo_causa_5a 	:= null;
		record_w.ds_causa_6 		:= null;
		record_w.cd_tempo_causa_6 	:= null;
		record_w.qt_tempo_causa_6 	:= null;
		record_w.ds_causa_6a 		:= null;
		record_w.cd_tempo_causa_6a 	:= null;
		record_w.qt_tempo_causa_6a 	:= null;
		count_w						:= 1;
		c_consulta_cid_1w := null;


		/*
		open c_consulta_cid_1;
		loop
		fetch c_consulta_cid_1 into
			c_consulta_cid_1w;
		exit when c_consulta_cid_1%notfound;
			begin
				if (count_w <= 10) then
					CASE count_w
					WHEN 1 THEN


						record_w.ds_causa_1 := c_consulta_cid_1w.ds_causa_cid;
						record_w.cd_tempo_causa_1 := c_consulta_cid_1w.ie_tipo_tempo_dir;
						record_w.qt_tempo_causa_1 := c_consulta_cid_1w.qt_tempo_dir;
					WHEN 2 THEN


						record_w.ds_causa_1a := c_consulta_cid_1w.ds_causa_cid;
						record_w.cd_tempo_causa_1a := c_consulta_cid_1w.ie_tipo_tempo_dir;
						record_w.qt_tempo_causa_1a := c_consulta_cid_1w.qt_tempo_dir;
					WHEN 3 THEN


						record_w.ds_causa_2 := c_consulta_cid_1w.ds_causa_cid;
						record_w.cd_tempo_causa_2 := c_consulta_cid_1w.ie_tipo_tempo_dir;
						record_w.qt_tempo_causa_2 := c_consulta_cid_1w.qt_tempo_dir;
					WHEN 4 THEN


						record_w.ds_causa_2a := c_consulta_cid_1w.ds_causa_cid;
						record_w.cd_tempo_causa_2a := c_consulta_cid_1w.ie_tipo_tempo_dir;
						record_w.qt_tempo_causa_2a := c_consulta_cid_1w.qt_tempo_dir;
					WHEN 5 THEN


						record_w.ds_causa_3 := c_consulta_cid_1w.ds_causa_cid;
						record_w.cd_tempo_causa_3 := c_consulta_cid_1w.ie_tipo_tempo_dir;
						record_w.qt_tempo_causa_3 := c_consulta_cid_1w.qt_tempo_dir;
					WHEN 6 THEN


						record_w.ds_causa_3a := c_consulta_cid_1w.ds_causa_cid;
						record_w.cd_tempo_causa_3a := c_consulta_cid_1w.ie_tipo_tempo_dir;
						record_w.qt_tempo_causa_3a := c_consulta_cid_1w.qt_tempo_dir;
					WHEN 7 THEN


						record_w.ds_causa_4 := c_consulta_cid_1w.ds_causa_cid;
						record_w.cd_tempo_causa_4 := c_consulta_cid_1w.ie_tipo_tempo_dir;
						record_w.qt_tempo_causa_4 := c_consulta_cid_1w.qt_tempo_dir;
					WHEN 8 THEN


						record_w.ds_causa_4a := c_consulta_cid_1w.ds_causa_cid;
						record_w.cd_tempo_causa_4a := c_consulta_cid_1w.ie_tipo_tempo_dir;
						record_w.qt_tempo_causa_4a := c_consulta_cid_1w.qt_tempo_dir;
					WHEN 9 THEN
						record_w.ds_causa_5a := c_consulta_cid_1w.ds_causa_cid;
						record_w.cd_tempo_causa_5a := c_consulta_cid_1w.ie_tipo_tempo_dir;
						record_w.qt_tempo_causa_5a := c_consulta_cid_1w.qt_tempo_dir;
					WHEN 10 THEN


						record_w.ds_causa_6a := c_consulta_cid_1w.ds_causa_cid;
						record_w.cd_tempo_causa_6a := c_consulta_cid_1w.ie_tipo_tempo_dir;
						record_w.qt_tempo_causa_6a := c_consulta_cid_1w.qt_tempo_dir;
					END CASE;
				end if;
		count_w := count_w + 1;
			end;
		end loop;
		close c_consulta_cid_1;

		count_w	:= 1;

		open c_consulta_cid_2;
		loop
		fetch c_consulta_cid_2 into
			c_consulta_cid_2w;
		exit when c_consulta_cid_2%notfound;
			begin
				CASE count_w
				WHEN 1 THEN
					record_w.ds_causa_5 := c_consulta_cid_2w.ds_causa_cid;
					record_w.cd_tempo_causa_5 := c_consulta_cid_2w.ie_tipo_tempo_dir;
					record_w.qt_tempo_causa_5 := c_consulta_cid_2w.qt_tempo_dir;
				WHEN 2 THEN
					record_w.ds_causa_6 := c_consulta_cid_2w.ds_causa_cid;
					record_w.cd_tempo_causa_6 := c_consulta_cid_2w.ie_tipo_tempo_dir;
					record_w.qt_tempo_causa_6 := c_consulta_cid_2w.qt_tempo_dir;
				END CASE;

			count_w := count_w + 1;
			end;
		end loop;
		close c_consulta_cid_2;
		*/
		select 	max(x.nr_seq_pessoa_endereco)
		into STRICT	nr_seq_estab_end_w
		from	estabelecimento n,
				pessoa_juridica x
		where	x.cd_cgc = n.cd_cgc
		and		n.cd_estabelecimento = WHEB_USUARIO_PCK.get_cd_estabelecimento;

		/*Declaraçao óbito*/

		select	d.dt_obito,
				--to_char(d.dt_obito,'YY')||'0'||lpad(d.nr_declaracao,6,'0') DEFFOLIO,

				--lpad(d.nr_declaracao,9,'0') DEFFOLIOCO,
				d.nr_declaracao DEFFOLIO,
				d.nr_declaracao DEFFOLIOCO,
				d.dt_obito DEFFECH_DEF,
				PKG_DATE_FORMATERS.TO_VARCHAR(d.dt_obito,'shortTime', wheb_usuario_pck.get_cd_estabelecimento, wheb_usuario_pck.get_nm_usuario) DEFHORA,
				CASE WHEN coalesce(d.ie_recebeu_atendimento,'N')='S' THEN '1'  ELSE '2' END  DEFATENCIO,
				CASE WHEN coalesce(d.ie_autopsia,'N')='S' THEN '1'  ELSE '2' END  DEFNECROPS,
				RPAD(d.CD_CID_DIRETA,4) DEFCAUSABAS,
				d.cd_cid_direta,
				coalesce(d.IE_OBITO_TRABALHO,'N') DEFDESEMPE,
				/*DECODE(d.ie_emissor,
					'2',d.ds_cedula_prof_cert,
					'10',d.ds_cedula_prof_cert,
					'9',SUBSTR(NVL(obter_crm_medico(d.cd_medico),'8888888'),1,7),
					'88888888') DEFCEDCERTIFI,*/
				coalesce(D.DS_CEDULA_PROF_CERT, SUBSTR(coalesce(obter_crm_medico(d.cd_medico),'8888888'),1,7)) DEFCEDCERTIFI,
				/*CASE WHEN (d.ie_emissor IS NULL OR d.ie_emissor = '8' OR d.ie_emissor = '9') THEN (select pfm.nr_seq_person_name from pessoa_fisica pfm where pfm.cd_pessoa_fisica = d.cd_medico)
					 ELSE d.nr_seq_person_cert
				END DEFNOMBCERTIFI,*/
				coalesce(d.nr_seq_person_cert,(select pfm.nr_seq_person_name from pessoa_fisica pfm where pfm.cd_pessoa_fisica = d.cd_medico)) DEFNOMBCERTIFI,
				CASE WHEN coalesce(d.IE_ASSINOU_CERT_OBITO,'N')='S' THEN '1' END  DEFFIRMOCERT,
				NULL DEFFECH_CER,
				'8888888888' DEFOFICIAL,
				'8888888888' DEFLIBRONUM,
				'8888888888' DEFNACTARC,
				null DEFFECH_REG,
				d.dt_atualizacao DEFFEC_CRE,
				d.dt_atualizacao DEFFEC_MOD,
				coalesce(obter_dados_cat_sitios(d.nr_seq_local_obito,'CD_SITIO'),'99') DEFINSTCAPT,
				coalesce(d.ie_tipo_certif_obt,'1') DEFTIPFORM,
				d.dt_liberacao DEFEXTEMPORANEO, --máscara DD
				coalesce(d.IE_EMISSOR,'0') DEFCERTIFI,
				coalesce(CASE WHEN obter_inform_adic_usuario_mx(d.nm_usuario,'IE_NIVEL_USUARIO_SEED')=1 THEN 'EDO' WHEN obter_inform_adic_usuario_mx(d.nm_usuario,'IE_NIVEL_USUARIO_SEED')=2 THEN 'JURIS' WHEN obter_inform_adic_usuario_mx(d.nm_usuario,'IE_NIVEL_USUARIO_SEED')=3 THEN  'UNME' WHEN obter_inform_adic_usuario_mx(d.nm_usuario,'IE_NIVEL_USUARIO_SEED')=4 THEN  'SEMEF'  ELSE 'SEED' END , 'SEED') DEFUSU_CRE,
				coalesce(obter_inform_adic_usuario_mx(d.nm_usuario,'IE_NIVEL_USUARIO_SEED'),'3') DEFNIVCAPT_CRE,
				obter_inform_adic_usuario_mx(d.nm_usuario,'IE_NIVEL_USUARIO_SEED') DEFUSU_MOD,
				coalesce(obter_inform_adic_usuario_mx(d.nm_usuario,'IE_NIVEL_USUARIO_SEED'),'3') DEFNIVCAPT,
				null DEFJURCAPT_CRE,
				d.nr_seq_local_obito,
				d.nr_seq_causa_morte,
				CASE WHEN(select max(x.ie_tipo_acidente) from causa_morte x where x.nr_sequencia = d.nr_seq_causa_morte)=2 THEN coalesce(d.ie_parentesco_agressor,'99')  ELSE '88' END  DEFLUG_OCU,
				coalesce(lpad(d.nr_notificacao, 10, 0), '9999999999') DEFACTAMP,
				d.nr_seq_person_name,
				d.nr_seq_parentesco,
				--nvl(lpad(d.nr_notificacao, 12, 0), '9999999999') DEFACTAMP,
				CASE WHEN d.ie_emissor=1 THEN 'NO APLICA'  WHEN d.ie_emissor=2 THEN  'NO APLICA'  ELSE d.ds_espc_cert END  ds_espc_cert,
				coalesce(get_info_end_endereco(CASE WHEN d.ie_emissor='1' THEN   nr_seq_estab_end_w  ELSE coalesce(d.nr_seq_cert_endereco, nr_seq_estab_end_w) END ,'ESTADO_PROVINCI','C'),'00') DEFENT_CERT,
				coalesce(get_info_end_endereco(CASE WHEN d.ie_emissor='1' THEN   nr_seq_estab_end_w  ELSE coalesce(d.nr_seq_cert_endereco, nr_seq_estab_end_w) END ,'MUNICIPIO','C'),'999') DEFDEL_CERT,
				coalesce(get_info_end_endereco(CASE WHEN d.ie_emissor='1' THEN   nr_seq_estab_end_w  ELSE coalesce(d.nr_seq_cert_endereco, nr_seq_estab_end_w) END ,'LOCALIDADE_AREA','C'),'9999') DEFLOC_CERT,
				coalesce(get_info_end_endereco(CASE WHEN d.ie_emissor='1' THEN   nr_seq_estab_end_w  ELSE coalesce(d.nr_seq_cert_endereco, nr_seq_estab_end_w) END ,'CODIGO_POSTAL','D'),'00000') DEFCP_CERT,
				coalesce(get_info_end_endereco(CASE WHEN d.ie_emissor='1' THEN   nr_seq_estab_end_w  ELSE coalesce(d.nr_seq_cert_endereco, nr_seq_estab_end_w) END ,'TIPO_LOGRAD','C'),'99') DEFTIPOVIA_CERT,
				coalesce(get_info_end_endereco(CASE WHEN d.ie_emissor='1' THEN   nr_seq_estab_end_w  ELSE coalesce(d.nr_seq_cert_endereco, nr_seq_estab_end_w) END ,'RUA_VIALIDADE','D'),'NO ESPECIFICADO') DEFNOMVIA_CERT,
				coalesce(get_info_end_endereco(CASE WHEN d.ie_emissor='1' THEN   nr_seq_estab_end_w  ELSE coalesce(d.nr_seq_cert_endereco, nr_seq_estab_end_w) END ,'NUMERO','D') || get_info_end_endereco(CASE WHEN d.ie_emissor='1' THEN   nr_seq_estab_end_w  ELSE coalesce(d.nr_seq_cert_endereco, nr_seq_estab_end_w) END ,'NUM_EXT_ALFA','D'),'SN')  DEFNUMEXT_CERT, -- esse cara tem que concatenar
				coalesce(get_info_end_endereco(CASE WHEN d.ie_emissor='1' THEN   nr_seq_estab_end_w  ELSE coalesce(d.nr_seq_cert_endereco, nr_seq_estab_end_w) END ,'NUMERO_INT','D') || get_info_end_endereco(CASE WHEN d.ie_emissor='1' THEN   nr_seq_estab_end_w  ELSE coalesce(d.nr_seq_cert_endereco, nr_seq_estab_end_w) END ,'COMPLEMENTO','D'),'SN') DEFNUMINT_CERT, --
				coalesce(get_info_end_endereco(CASE WHEN d.ie_emissor='1' THEN   nr_seq_estab_end_w  ELSE coalesce(d.nr_seq_cert_endereco, nr_seq_estab_end_w) END ,'BAIRRO_VILA','D'),'NO ESPECIFICADO') DEFNOMASEN_CERT,
				CASE WHEN get_info_end_endereco(CASE WHEN d.ie_emissor='1' THEN   nr_seq_estab_end_w  ELSE coalesce(d.nr_seq_cert_endereco, nr_seq_estab_end_w) END ,'CODIGO_POSTAL','D')='99999' THEN  '1'  ELSE '2' END  IE_IGNORAR_CP_CERT,
				coalesce(get_info_end_endereco(CASE WHEN d.ie_emissor='1' THEN   nr_seq_estab_end_w  ELSE coalesce(d.nr_seq_cert_endereco, nr_seq_estab_end_w) END ,'TIPO_BAIRRO','C'),'46') DEFTIPOASEN_CERT,
				coalesce(d.nr_ddi_telefone_cert,'999'),
				coalesce(d.nr_telefone_cert,'9999999999'),
				d.nr_seq_ocor_endereco,
				d.nr_seq_end_acidente
		into STRICT	record_w.dt_obito,
				record_w.nr_folio,
				record_w.nr_declaracao_obito,
				record_w.dt_ocorrencia_def,
				record_w.hr_ocorrencia_def,
				record_w.ie_recebeu_atendimento,
				record_w.ie_autopsia,
				record_w.cd_cid_basica,
				cd_cid_direta_w,
				record_w.ie_obito_trabalho,
				record_w.nr_cedula_medico_certif,
				nr_person_name_decl_w,
				record_w.ie_assinou_cert_obito,
				record_w.dt_cert_obito,
				record_w.nr_declaracao_oficial,
				record_w.ds_livro_cert_obito,
				record_w.nr_certificado_obito,
				record_w.dt_capt_reg,
				record_w.dt_criacao_cre,
				record_w.dt_modificacao,
				record_w.cd_sitio_capt,
				record_w.ie_tipo_certif_obt,
				record_w.dt_captura,
				record_w.ie_emissor_certif,
				record_w.ie_usuario_capt_reg,
				record_w.ie_nivel_usu_capt_cre,
				record_w.nm_usuario_mod,
				record_w.ie_nivel_ult_mod,
				record_w.cd_jurisdicao_capt_cre,
				nr_seq_local_obito_w,
				nr_seq_causa_morte_w,
				record_w.ie_parentesco_agressor_def,
				record_w.nr_notificacao_def,
				record_w.nr_seq_person_name_inf,
				nr_seq_parentesco_w,
				record_w.ds_espc_cert,
				record_w.cd_entidade_cert,
				record_w.cd_municipio_cert,
				record_w.cd_localidade_cert,
				record_w.cd_codigo_postal_cert,
				record_w.cd_tipo_vialidad_cert,
				record_w.ds_endereco_certif,
				record_w.nr_exterior_cert,
				record_w.nr_interior_cert,
				record_w.ds_asentamiento_cert, -- campo nao esta em tela
				record_w.ie_ignorar_cp_cert,
				record_w.cd_tipo_asentamiento_cert,
				record_w.nr_ddi_telefone_certif,
				record_w.nr_telefone_certif,
				nr_seq_ocor_endereco_w,
				nr_seq_end_acidente_w
		from	declaracao_obito d
		where	d.nr_sequencia = c_consulta_atendimento_w.nr_seq_declaracao
		and		(d.dt_liberacao IS NOT NULL AND d.dt_liberacao::text <> '')
		and		coalesce(d.dt_inativacao::text, '') = '';

		record_w.IE_CONTA_REG_CIVIL := 'N';

		-- CD_ASENTAMIENTO_CERT esse campo é um localizador, porem nao é usado aki
		SELECT nextval('person_name_seq')
		INTO STRICT record_w.nr_seq_person_name_cert
		;

		INSERT INTO person_name(nr_sequencia,dt_atualizacao,nm_usuario,dt_atualizacao_nrec,nm_usuario_nrec,ds_type,ds_given_name,ds_family_name,ds_component_name_1,ds_component_name_2,ds_component_name_3)
		SELECT record_w.nr_seq_person_name_cert,clock_timestamp(),nm_usuario_p,clock_timestamp(),nm_usuario_p,ds_type,ds_given_name,ds_family_name,coalesce(ds_component_name_1, 'SIN INFORMACION'),ds_component_name_2,ds_component_name_3
		FROM person_name
		WHERE nr_sequencia = nr_person_name_decl_w;

		select	max(cd_pessoa_mae),
				max(dt_nascimento)
		into STRICT	cd_pessoa_mae_w,
				record_w.dt_nascimento_def
		from	pessoa_fisica
		where 	cd_pessoa_fisica = c_consulta_atendimento_w.cd_pessoa_fisica;

		if (cd_pessoa_mae_w IS NOT NULL AND cd_pessoa_mae_w::text <> '') then
			select 	max(b.dt_nascimento)
			into STRICT	record_w.dt_nascimento_def
			from	nascimento b
			where	nr_atend_rn = c_consulta_atendimento_w.nr_atendimento;
		end if;

		/*Paciente*/

		select	coalesce(get_info_end_endereco(coalesce(c.nr_seq_pessoa_endereco,(select max(y.nr_seq_pessoa_endereco) from compl_pessoa_fisica y where y.cd_pessoa_fisica = b.cd_pessoa_mae and ie_tipo_complemento = 1)), 'ESTADO_PROVINCI', 'C'),'00') DEFENT_HAB,
				coalesce(get_info_end_endereco(coalesce(c.nr_seq_pessoa_endereco,(select max(y.nr_seq_pessoa_endereco) from compl_pessoa_fisica y where y.cd_pessoa_fisica = b.cd_pessoa_mae and ie_tipo_complemento = 1)), 'MUNICIPIO', 'C'),'000') DEFDEL_HAB,
				coalesce(get_info_end_endereco(coalesce(c.nr_seq_pessoa_endereco,(select max(y.nr_seq_pessoa_endereco) from compl_pessoa_fisica y where y.cd_pessoa_fisica = b.cd_pessoa_mae and ie_tipo_complemento = 1)), 'LOCALIDADE_AREA', 'C'),'000') DEFLOC_HAB,
				coalesce(get_info_end_endereco(coalesce(c.nr_seq_pessoa_endereco,(select max(y.nr_seq_pessoa_endereco) from compl_pessoa_fisica y where y.cd_pessoa_fisica = b.cd_pessoa_mae and ie_tipo_complemento = 1)),'TIPO_LOGRAD','C'),'99') DEFTIPOVIA_HAB,
				coalesce(substr(upper(trim(elimina_acentuacao(get_info_end_endereco(coalesce(c.nr_seq_pessoa_endereco,(select max(y.nr_seq_pessoa_endereco) from compl_pessoa_fisica y where y.cd_pessoa_fisica = b.cd_pessoa_mae and ie_tipo_complemento = 1)), 'RUA_VIALIDADE', 'D')))),1,100),'NO ESPECIFICADO') DEFNOMVIA_HAB,
				substr(coalesce(get_info_end_endereco(coalesce(c.nr_seq_pessoa_endereco,(select max(y.nr_seq_pessoa_endereco) from compl_pessoa_fisica y where y.cd_pessoa_fisica = b.cd_pessoa_mae and ie_tipo_complemento = 1)),'NUMERO','D')  || get_info_end_endereco(c.nr_seq_pessoa_endereco,'NUM_EXT_ALFA','D'),'SN'),1,20) DEFNUMEXT_HAB,
				substr(coalesce(get_info_end_endereco(coalesce(c.nr_seq_pessoa_endereco,(select max(y.nr_seq_pessoa_endereco) from compl_pessoa_fisica y where y.cd_pessoa_fisica = b.cd_pessoa_mae and ie_tipo_complemento = 1)),'NUMERO_INT','D') || get_info_end_endereco(c.nr_seq_pessoa_endereco,'COMPLEMENTO','D'),'SN'),1,20) DEFNUMINT_HAB,-- COMPLEMENTO
				coalesce(get_info_end_endereco(coalesce(c.nr_seq_pessoa_endereco,(select max(y.nr_seq_pessoa_endereco) from compl_pessoa_fisica y where y.cd_pessoa_fisica = b.cd_pessoa_mae and ie_tipo_complemento = 1)),'TIPO_BAIRRO','C'),'99') DEFTIPOASEN_HAB,
				substr(elimina_acentuacao(trim(coalesce(get_info_end_endereco(coalesce(c.nr_seq_pessoa_endereco,(select max(y.nr_seq_pessoa_endereco) from compl_pessoa_fisica y where y.cd_pessoa_fisica = b.cd_pessoa_mae and ie_tipo_complemento = 1)), 'BAIRRO_VILA', 'D'), 'NO ESPECIFICADO'))),1,100) DEFNOMASEN_HAB,
				substr(trim(coalesce(get_info_end_endereco(coalesce(c.nr_seq_pessoa_endereco,(select max(y.nr_seq_pessoa_endereco) from compl_pessoa_fisica y where y.cd_pessoa_fisica = b.cd_pessoa_mae and ie_tipo_complemento = 1)),'CODIGO_POSTAL','D'),'00000')),1,5) DEFCP_HAB,
				coalesce(get_info_end_endereco(coalesce(c.nr_seq_pessoa_endereco,(select max(y.nr_seq_pessoa_endereco) from compl_pessoa_fisica y where y.cd_pessoa_fisica = b.cd_pessoa_mae and ie_tipo_complemento = 1)),'PAIS','C'),'142') PaisResidencia,
				case 	when obter_idade(b.dt_nascimento, coalesce(record_w.dt_obito, clock_timestamp()), 'A') > 5
						then CASE WHEN b.nr_seq_lingua_indigena=77 THEN  '9' WHEN b.nr_seq_lingua_indigena=59 THEN '8' WHEN b.nr_seq_lingua_indigena=60 THEN  '0'  ELSE (CASE WHEN (b.nr_seq_lingua_indigena IS NOT NULL AND b.nr_seq_lingua_indigena::text <> '') THEN 1 ELSE 2 END) END
						else '8'
				end LENG_INDIG,
				b.dt_nascimento DEFFECH_NAC,
				case when trunc(pkg_date_utils.get_diffdate(record_w.dt_nascimento_def,coalesce(record_w.dt_obito, clock_timestamp()),'DAY')) > 29 then '000000000'
						 else lpad(coalesce(coalesce(b.nr_cert_nasc,(select max(y.nr_dnv) from atendimento_paciente x, nascimento y where x.nr_atendimento = y.nr_atend_rn and x.cd_pessoa_fisica = b.cd_pessoa_fisica)),'888888888'),9,'0')
				end DEFFOL_CN,
				case when obter_idade(b.dt_nascimento, coalesce(record_w.dt_obito, clock_timestamp()), 'A') < 10 then '8'
						 else to_char(coalesce(CASE WHEN b.ie_estado_civil=11 THEN 5 WHEN b.ie_estado_civil=12 THEN 1 WHEN b.ie_estado_civil=13 THEN 3 WHEN b.ie_estado_civil=14 THEN 2 WHEN b.ie_estado_civil=15 THEN 4 WHEN b.ie_estado_civil=16 THEN 6 WHEN b.ie_estado_civil=99 THEN 9 END ,'9'))
				end DEFEDO_CIV,
				case when trunc(pkg_date_utils.get_diffdate(record_w.dt_nascimento_def,coalesce(record_w.dt_obito, clock_timestamp()),'YEAR')) > 1 then '3'
						 when trunc(pkg_date_utils.get_diffdate(record_w.dt_nascimento_def,coalesce(record_w.dt_obito, clock_timestamp()),'MONTH')) > 1 then '2'
						 when trunc(pkg_date_utils.get_diffdate(record_w.dt_nascimento_def,coalesce(record_w.dt_obito, clock_timestamp()),'DAY')) > 1 then '1'
						 when trunc(pkg_date_utils.get_diffdate(record_w.dt_nascimento_def,coalesce(record_w.dt_obito, clock_timestamp()),'HOUR')) > 1 then '0'
						 else '4'
				end DEFCLV_EDA,
				case when trunc(pkg_date_utils.get_diffdate(record_w.dt_nascimento_def,coalesce(record_w.dt_obito, clock_timestamp()),'YEAR')) > 1 then trunc(pkg_date_utils.get_diffdate(record_w.dt_nascimento_def,coalesce(record_w.dt_obito, clock_timestamp()),'YEAR'))
						 when trunc(pkg_date_utils.get_diffdate(record_w.dt_nascimento_def,coalesce(record_w.dt_obito, clock_timestamp()),'MONTH')) > 1 then trunc(pkg_date_utils.get_diffdate(record_w.dt_nascimento_def,coalesce(record_w.dt_obito, clock_timestamp()),'MONTH'))
						 when trunc(pkg_date_utils.get_diffdate(record_w.dt_nascimento_def,coalesce(record_w.dt_obito, clock_timestamp()),'DAY')) > 1 then trunc(pkg_date_utils.get_diffdate(record_w.dt_nascimento_def,coalesce(record_w.dt_obito, clock_timestamp()),'DAY'))
						 when trunc(pkg_date_utils.get_diffdate(record_w.dt_nascimento_def,coalesce(record_w.dt_obito, clock_timestamp()),'HOUR')) > 1 then trunc(pkg_date_utils.get_diffdate(record_w.dt_nascimento_def,coalesce(record_w.dt_obito, clock_timestamp()),'HOUR'))
						 else trunc(pkg_date_utils.get_diffdate(record_w.dt_nascimento_def,coalesce(record_w.dt_obito, clock_timestamp()),'MINUTE'))
				end DEFEDAD,
				case when trunc(pkg_date_utils.get_diffdate(record_w.dt_nascimento_def,coalesce(record_w.dt_obito, clock_timestamp()),'DAY')) > 29 then '88'
						 else coalesce(coalesce((select Max(to_char(qt_sem_ig_total)) from nascimento y where nr_atend_rn = c_consulta_atendimento_w.nr_atendimento), (select max(to_char(qt_sem_ig_cronologica)) from parto where nr_atendimento = c_consulta_atendimento_w.nr_atendimento_mae)), '99')
				end DEFSEMGESTA,
				case when trunc(pkg_date_utils.get_diffdate(record_w.dt_nascimento_def,coalesce(record_w.dt_obito, clock_timestamp()),'DAY')) > 29 then '8888'
						 else coalesce(to_char(coalesce(b.qt_peso, qt_peso_nasc) * 1000), (select max(to_char(qt_peso)) from nascimento y where nr_atend_rn = c_consulta_atendimento_w.nr_atendimento))
				end DEFPESO,
				coalesce(trim(both b.cd_curp),'XXXX999999XXXXXX99') DEFCURP,
				CASE WHEN b.ie_sexo='M' THEN 1 WHEN b.ie_sexo='F' THEN 2  ELSE 0 END  DEFSEXO,
				case when(b.ie_sexo <> 'F') then '8'
						 when(b.ie_sexo = 'F' and trunc(pkg_date_utils.get_diffdate(record_w.dt_nascimento_def,coalesce(record_w.dt_obito, clock_timestamp()),'YEAR')) not between 8 and 59) then '8'
						 else c_consulta_atendimento_w.defdurante
				end DEFDURANTE,
				case when(b.ie_sexo <> 'F') then '8'
						 when(b.ie_sexo = 'F' and trunc(pkg_date_utils.get_diffdate(record_w.dt_nascimento_def,coalesce(record_w.dt_obito, clock_timestamp()),'YEAR')) not between 8 and 59) then '8'
						 else c_consulta_atendimento_w.deftpo_emb
				end DEFTPO_EMB,
				case when(b.ie_sexo <> 'F') then '8'
						 when(b.ie_sexo = 'F' and trunc(pkg_date_utils.get_diffdate(record_w.dt_nascimento_def,coalesce(record_w.dt_obito, clock_timestamp()),'YEAR')) not between 8 and 59) then '8'
						 else c_consulta_atendimento_w.defcom_emb
				end DEFCOM_EMB,
				b.nr_seq_person_name,
				case when obter_idade(b.dt_nascimento, coalesce(record_w.dt_obito, clock_timestamp()), 'A') < 4 then '88'
					else CASE WHEN b.ie_grau_instrucao='1' THEN '03' WHEN b.ie_grau_instrucao='2' THEN '02' WHEN b.ie_grau_instrucao='3' THEN '05' WHEN b.ie_grau_instrucao='4' THEN '04' WHEN b.ie_grau_instrucao='5' THEN '07' WHEN b.ie_grau_instrucao='6' THEN '06' WHEN b.ie_grau_instrucao='7' THEN '09' WHEN b.ie_grau_instrucao='8' THEN '08' WHEN b.ie_grau_instrucao='9' THEN '11' WHEN b.ie_grau_instrucao='10' THEN '10' WHEN b.ie_grau_instrucao='11' THEN '11' WHEN b.ie_grau_instrucao='12' THEN '10' WHEN b.ie_grau_instrucao='16' THEN '11' WHEN b.ie_grau_instrucao='17' THEN '10' WHEN b.ie_grau_instrucao='18' THEN '12' WHEN b.ie_grau_instrucao='19' THEN '13' WHEN b.ie_grau_instrucao='20' THEN '01' WHEN b.ie_grau_instrucao='99' THEN '99'  ELSE '00' END 
				end DEFESCOLAR,
				case when obter_idade(b.dt_nascimento, coalesce(record_w.dt_obito, clock_timestamp()), 'A') < 11 then '88'
				      else (select 	max(x.ie_ocupacao_habitual)
						from 	complemento_mexico x,
								cat_ocupacao_hab y
						where 	nr_atendimento = c_consulta_atendimento_w.nr_atendimento
						and    	x.ie_ocupacao_habitual = y.cd_ocupacao)
				end DEFOCUPACI,
				case when obter_idade(b.dt_nascimento, coalesce(record_w.dt_obito, clock_timestamp()), 'A') < 11 then '0'
						 else (select max(x.ie_trabalha_atual) from complemento_mexico x where nr_atendimento = c_consulta_atendimento_w.nr_atendimento)
				end DEFTRABAJA,
				b.qt_peso,
				qt_altura_cm,
				b.cd_nacionalidade,
				b.cd_cargo,
				c.nr_seq_pessoa_endereco,
				coalesce((select max(x.cd_endereco_catalogo)
					from  end_endereco x
					where x.ie_informacao = 'ESTADO_PROVINCI'
					and	  x.nr_seq_catalogo = obter_catalogo_nom(c_consulta_atendimento_w.cd_estabelecimento)
					and (x.sg_estado_tasy = b.sg_estado_nasc or b.sg_estado_nasc = x.cd_endereco_catalogo))
				,'') DEFENNAC,
				(select max(y.nr_seq_pessoa_endereco) from compl_pessoa_fisica y where y.cd_pessoa_fisica = b.cd_pessoa_fisica and ie_tipo_complemento = 1)
		into STRICT	record_w.cd_estado_hab_def,
				record_w.cd_municipio_hab_def,
				record_w.cd_localidade_hab_def,
				record_w.cd_tipo_vialidad_hab,--cd_tipo_vialidad_hab era isso cd_tipo_vialidad_def,
				record_w.ds_endereco_hab_def,
				record_w.nr_exterior_hab, -- concat
				record_w.nr_interior_hab, -- concat
				record_w.cd_tipo_asentamiento_hab,
				record_w.ds_bairro_hab_def,
				record_w.cd_codigo_postal_hab, -- ver
				record_w.nr_seq_pais_def,
				record_w.nr_seq_lingua_indigena_def,
				record_w.dt_nascimento_def,
				record_w.nr_certificado_nasc_def,
				record_w.ie_estado_civil_def,
				record_w.ie_tipo_idade_def,
				record_w.qt_idade_def,
				record_w.qt_semanas_gestacao,
				record_w.qt_peso_gramas,
				record_w.cd_curp_def,
				record_w.ie_sexo_def,
				record_w.ie_periodo_ocorr_def,
				record_w.ie_gravidez_causou_morte,
				record_w.ie_morte_complicou_gravidez,
				record_w.nr_seq_person_name_def,
				record_w.ie_grau_instrucao_def,
				record_w.cd_cargo_def,
				record_w.ie_trabalha_def,
				qt_peso_pf_w,
				qt_altura_cm_pf_w,
				cd_nacionalidade_w,
				cd_cargo_w,
				nr_seq_pessoa_endereco_w,
				record_w.cd_estado_nasc,
				nr_seq_catalogo_pac_w
		FROM pessoa_fisica b
LEFT OUTER JOIN compl_pessoa_fisica c ON (b.cd_pessoa_fisica = c.cd_pessoa_fisica AND 1 = c.ie_tipo_complemento)
WHERE b.cd_pessoa_fisica = c_consulta_atendimento_w.cd_pessoa_fisica;

		--record_w.ie_trabalha_def	:= '9';


		-- Catalogo nr_seq_catalogo_hab
		select	max(b.nr_seq_catalogo)
		into STRICT	record_w.nr_seq_catalogo_hab
		from	end_endereco b,
				pessoa_endereco_item a
		where	b.nr_sequencia = a.nr_seq_end_endereco
		and		a.nr_seq_pessoa_endereco = nr_seq_pessoa_endereco_w;

		select OBTER_SE_ESTRANGEIRO_NOMS(nr_seq_pessoa_endereco_w)
		into STRICT record_w.ie_reside_exterior
		;

		if (record_w.ie_reside_exterior = 'S') then
			record_w.cd_estado_hab_def := '88';
			record_w.cd_tipo_vialidad_hab := '97'; -- cd_tipo_vialidad_hab cd_tipo_vialidad_def
			record_w.nr_exterior_hab := 'SN';
			record_w.nr_interior_hab := 'SN';
			record_w.cd_tipo_asentamiento_hab := '00';
			record_w.ds_bairro_hab_def := 'NO APLICA';
			record_w.cd_codigo_postal_hab := '00000';
			record_w.ie_ignorar_cp_def := '2'; --IE_IGNORAR_CP_HAB
			record_w.cd_tipo_asentamiento_cert := '44';
		else
			if (record_w.cd_codigo_postal_hab = '99999') then
				record_w.ie_ignorar_cp_def := '1';
			else
				record_w.ie_ignorar_cp_def := '2';
			end if;
		end if;

		if (record_w.cd_estado_hab_def = '88') then
			record_w.cd_municipio_hab_def := '997';
		elsif (record_w.cd_estado_hab_def = '99') then
			record_w.cd_municipio_hab_def := '998';
		elsif (record_w.cd_estado_hab_def = '00') then
			record_w.cd_municipio_hab_def := '999';
		end if;

		if (record_w.cd_municipio_hab_def = '997') then
			record_w.cd_localidade_hab_def := '9997';
		elsif (record_w.cd_municipio_hab_def = '998') then
			record_w.cd_localidade_hab_def := '9998';
		elsif (record_w.cd_municipio_hab_def = '999') then
			record_w.cd_localidade_hab_def := '9999';
		end if;

		select	coalesce(max(x.cd_sitio), '00') DEFSITIO
		into STRICT	record_w.cd_sitio_def
		from	cat_sitios x
		where 	x.nr_sequencia = nr_seq_local_obito_w;

		/*Estabelecimento*/

		select
				CASE WHEN record_w.cd_sitio_def='01' THEN rpad(coalesce(obter_dados_cat_clues(m.cd_internacional,'DS_ESTAB_SAUDE'),'NO APLICA'),50) WHEN record_w.cd_sitio_def='02' THEN rpad(coalesce(obter_dados_cat_clues(m.cd_internacional,'DS_ESTAB_SAUDE'),'NO APLICA'),50) WHEN record_w.cd_sitio_def='03' THEN rpad(coalesce(obter_dados_cat_clues(m.cd_internacional,'DS_ESTAB_SAUDE'),'NO APLICA'),50) WHEN record_w.cd_sitio_def='04' THEN rpad(coalesce(obter_dados_cat_clues(m.cd_internacional,'DS_ESTAB_SAUDE'),'NO APLICA'),50) WHEN record_w.cd_sitio_def='05' THEN rpad(coalesce(obter_dados_cat_clues(m.cd_internacional,'DS_ESTAB_SAUDE'),'NO APLICA'),50) WHEN record_w.cd_sitio_def='06' THEN rpad(coalesce(obter_dados_cat_clues(m.cd_internacional,'DS_ESTAB_SAUDE'),'NO APLICA'),50) WHEN record_w.cd_sitio_def='07' THEN rpad(coalesce(obter_dados_cat_clues(m.cd_internacional,'DS_ESTAB_SAUDE'),'NO APLICA'),50) WHEN record_w.cd_sitio_def='08' THEN rpad(coalesce(obter_dados_cat_clues(m.cd_internacional,'DS_ESTAB_SAUDE'),'NO APLICA'),50) WHEN record_w.cd_sitio_def='09' THEN rpad(coalesce(obter_dados_cat_clues(m.cd_internacional,'DS_ESTAB_SAUDE'),'NO APLICA'),50)  ELSE 'NO APLICA' END  DEFUNIMED,
				CASE WHEN record_w.cd_sitio_def='01' THEN m.cd_internacional WHEN record_w.cd_sitio_def='02' THEN m.cd_internacional WHEN record_w.cd_sitio_def='03' THEN m.cd_internacional WHEN record_w.cd_sitio_def='04' THEN m.cd_internacional WHEN record_w.cd_sitio_def='05' THEN m.cd_internacional WHEN record_w.cd_sitio_def='06' THEN m.cd_internacional WHEN record_w.cd_sitio_def='07' THEN m.cd_internacional WHEN record_w.cd_sitio_def='08' THEN m.cd_internacional WHEN record_w.cd_sitio_def='09' THEN m.cd_internacional  ELSE '9997' END  DEFCLUES,
				m.cd_internacional DEFCLUESCAPT_CRE,
				m.cd_internacional DEFCLUESCAPT,
				coalesce(obter_dados_cat_clues(m.cd_internacional,'CD_ESTADO'),'99') CEDOCAPT,
				'97' DEFENT_REG,
				'997' DEFDEL_REG,
				'9997' DEFLOC_REG,
				lpad(coalesce(obter_dados_cat_clues(m.cd_internacional,'CD_ESTADO'),'00'),2,'0') DEFEDOCAPT_CRE,
				lpad(coalesce(obter_dados_cat_clues(m.cd_internacional,'CD_MUNICIPIO'),'999'),3,'0') DEFMPOCAPT_CRE,--ok
				lpad(coalesce(obter_dados_cat_clues(m.cd_internacional,'CD_ESTADO'),'00'),2,'0') DEFEDOCAPT,
				lpad(coalesce(obter_dados_cat_clues(m.cd_internacional,'CD_JURISDICAO'),'99'),2,'0') DEFJURCAPT,
				lpad(coalesce(obter_dados_cat_clues(m.cd_internacional,'CD_MUNICIPIO'),'999'),3,'0') DEFMPOCAPT,
				CASE WHEN record_w.cd_sitio_def='01' THEN m.nr_seq_pessoa_endereco WHEN record_w.cd_sitio_def='02' THEN m.nr_seq_pessoa_endereco WHEN record_w.cd_sitio_def='03' THEN m.nr_seq_pessoa_endereco WHEN record_w.cd_sitio_def='04' THEN m.nr_seq_pessoa_endereco WHEN record_w.cd_sitio_def='05' THEN m.nr_seq_pessoa_endereco WHEN record_w.cd_sitio_def='06' THEN m.nr_seq_pessoa_endereco WHEN record_w.cd_sitio_def='07' THEN m.nr_seq_pessoa_endereco WHEN record_w.cd_sitio_def='08' THEN m.nr_seq_pessoa_endereco WHEN record_w.cd_sitio_def='9' THEN m.nr_seq_pessoa_endereco  ELSE nr_seq_ocor_endereco_w END  DEFCLUES,
				nom_obter_jurisdicao_def(n.cd_estabelecimento,m.cd_internacional,null) DEFJUR_DEF
		into STRICT	record_w.ds_estab_saude_def,
				record_w.cd_internacional_def,
				record_w.cd_internacional_capt_cre,
				record_w.cd_clues_mod_reg,
				record_w.cd_estado_capt,
				record_w.cd_estado_reg,
				record_w.cd_municipio_reg,
				record_w.cd_localidade_reg,
				record_w.cd_estado_capt_cre,
				record_w.cd_municipio_capt_cre,
				record_w.cd_estado_ult_mod,
				record_w.cd_jurisdicao_capt_reg,
				record_w.cd_municipio_capt_reg,
				nr_seq_pessoa_end_estab_w,
				record_w.cd_jurisdicao_ocor_def
		from	estabelecimento n,
				pessoa_juridica m
		where	m.cd_cgc = n.cd_cgc
		and		n.cd_estabelecimento = c_consulta_atendimento_w.cd_estabelecimento;


		/* Se informado na tela o local da ocorrencia, considera o da tela */

		if (nr_seq_ocor_endereco_w IS NOT NULL AND nr_seq_ocor_endereco_w::text <> '') then
			nr_seq_pessoa_endereco_w	:= nr_seq_ocor_endereco_w;
		/* Se não informado e Lugar do pacinete - HOGAR */

		elsif (record_w.cd_sitio_def = '11') then
			nr_seq_pessoa_endereco_w	:= nr_seq_catalogo_pac_w;
		else
			/*Senão considera da pessoa jurídica do estabelecimento */

			nr_seq_pessoa_endereco_w	:= nr_seq_pessoa_end_estab_w;
		end if;

		-- Catalogo nr_seq_catalogo_def
		select	max(b.nr_seq_catalogo),
				coalesce(get_info_end_endereco(nr_seq_pessoa_endereco_w,'ESTADO_PROVINCI','C'),'00') DEFENT_DEF,
				coalesce(get_info_end_endereco(nr_seq_pessoa_endereco_w,'MUNICIPIO','C'),'999') DEFDEL_DEF,
				coalesce(get_info_end_endereco(nr_seq_pessoa_endereco_w,'LOCALIDADE_AREA','C'),'9999') DEFLOC_DEF,
				coalesce(get_info_end_endereco(nr_seq_pessoa_endereco_w,'CODIGO_POSTAL','D'),'00000') DEFCP_DEF,
				coalesce(get_info_end_endereco(nr_seq_pessoa_endereco_w,'TIPO_LOGRAD','C'),'99') DEFTIPOVIA_DEF,
				coalesce(get_info_end_endereco(nr_seq_pessoa_endereco_w,'RUA_VIALIDADE','D'),'NO ESPECIFICADO') DEFNOMVIA_DEF,
				coalesce(get_info_end_endereco(nr_seq_pessoa_endereco_w,'NUMERO','D') || get_info_end_endereco(nr_seq_pessoa_endereco_w,'NUM_EXT_ALFA','D'), 'SN') DEFNUMEXT_DEF,
				coalesce(get_info_end_endereco(nr_seq_pessoa_endereco_w,'NUMERO_INT','D') || get_info_end_endereco(nr_seq_pessoa_endereco_w,'COMPLEMENTO','D'), 'SN') DEFNUMINT_DEF,
				coalesce(get_info_end_endereco(nr_seq_pessoa_endereco_w,'TIPO_BAIRRO','C'),'46') DEFTIPOASEN_DEF,
				coalesce(get_info_end_endereco(nr_seq_pessoa_endereco_w,'BAIRRO_VILA','D'),'NO ESPECIFICADO') DEFNOMASEN_DEF
				--nvl(get_info_end_endereco(nr_seq_pessoa_endereco_w,'CD_JURISDICAO','C'),'99') DEFJUR_DEF
		into STRICT	record_w.nr_seq_catalogo_def,
				record_w.cd_estado_ocor_def,
				record_w.cd_municipio_ocor_def,
				record_w.cd_localidade_ocor_def,
				record_w.cd_codigo_postal_def,
				record_w.cd_tipo_vialidad_def,
				record_w.ds_endereco_ocor_def,
				record_w.nr_exterior_def,
				record_w.nr_interior_def,
				record_w.cd_tipo_asentamiento_def,
				record_w.ds_bairro_ocor_def
				--record_w.cd_jurisdicao_ocor_def
		from	end_endereco b,
				pessoa_endereco_item a
		where	b.nr_sequencia = a.nr_seq_end_endereco
		and		a.nr_seq_pessoa_endereco = nr_seq_pessoa_endereco_w;

		select CASE WHEN record_w.cd_cp_ocor_def='99999' THEN '1'  ELSE '2' END  seIgnoraCPDefuncion -- codigo fonte
		into STRICT record_w.ie_ignorar_cp_def
		;

		--------------------------------CONSULTAS ADICIONAIS---------------------------------------------
		select	coalesce(lpad(max(x.cd_grau_parentesco_mx),2,'0'),'99') DEFPARENTINFOR
		into STRICT	record_w.ds_family_name_inf
		from 	cat_grau_parentesco x
		where 	x.nr_sequencia = (	SELECT	p.cd_parentesco_mx
									from	grau_parentesco p
									where	p.nr_sequencia = nr_seq_parentesco_w);

		/*Dados ocorrencia*/
 -- comentado por orientacao do analista
		/*select	substr(nvl(upper(elimina_acentuacao(max(x.ds_endereco))),'NO APLICA'),1,80) DEFDOM_ACC,
				substr(nvl(upper(elimina_acentuacao(max(x.ds_bairro))),'NO APLICA'),1,60) DEFCOL_ACC,
				lpad(nvl(max(x.nr_seq_entidade),'88'),2,'0') DEFENT_ACC,
				lpad(nvl(max(x.nr_seq_municipio),'888'),3,'0') DEFDEL_ACC,
				lpad(nvl(max(x.nr_seq_localidade),'8888'),4,'0') DEFLOC_ACC
		into	record_w.ds_endereco_ocor_acidente,
				record_w.ds_bairro_ocor_acidente, -- conflito com outro lugar
				record_w.cd_estado_ocor_acidente,
				record_w.cd_municipio_ocor_acidente,
				record_w.cd_localidade_ocor_acidente
		from 	sinan_dados_ocorrencia x,
				notificacao_sinan z,
				cih_doenca_compulsoria w
		where 	x.nr_seq_notificacao(+) = z.nr_sequencia
		and 	z.nr_seq_doenca_compulsoria = w.nr_sequencia
		and 	w.ie_tipo_doenca = 'V'
		and 	z.nr_atendimento = c_consulta_atendimento_w.nr_atendimento;

		select	nvl2(x.nr_sequencia, 1, 0)  defverepi
		into	record_w.ie_vig_epidemiologica
		from	cih_doenca_compulsoria x
		where	x.ie_tipo_doenca is not null
		and		x.cd_doenca_cid = cd_cid_direta_w;
*/
		select 	max(ie_tipo_acidente) muerteAccidentalViolenta
		into STRICT 	record_w.ie_morte_acidente
		from 	causa_morte
		where 	nr_sequencia = nr_seq_causa_morte_w;

		select
			CASE WHEN record_w.ie_morte_acidente='1' THEN record_w.ie_morte_acidente WHEN record_w.ie_morte_acidente='2' THEN  record_w.ie_morte_acidente  ELSE '8' END  DEFPRESUNT,
			CASE WHEN record_w.ie_morte_acidente='1' THEN record_w.ie_obito_trabalho WHEN record_w.ie_morte_acidente='2' THEN  record_w.ie_obito_trabalho  ELSE '8' END  DEFDESEMPE,
			CASE WHEN record_w.ie_morte_acidente='1' THEN c_consulta_atendimento_w.deflug_ocu WHEN record_w.ie_morte_acidente='2' THEN  c_consulta_atendimento_w.deflug_ocu  ELSE '88' END  DEFLUG_OCU,
			CASE WHEN record_w.ie_morte_acidente='1' THEN record_w.nr_notificacao_def WHEN record_w.ie_morte_acidente='2' THEN  record_w.nr_notificacao_def  ELSE '8888888888' END  DEFACTAMP
		into STRICT
			record_w.ie_tipo_acidente,
			record_w.ie_obito_trabalho,
			record_w.cd_lugar_acc_mg_def,
			record_w.nr_notificacao_def
		;

		if (record_w.ie_morte_acidente IN ('1', '2')) then

			select
				coalesce(get_info_end_endereco(nr_seq_end_acidente_w,'TIPO_LOGRAD','C'),'99') DEFTIPOVIA_ACC,
				coalesce(get_info_end_endereco(nr_seq_end_acidente_w,'RUA_VIALIDADE','D'),'NO ESPECIFICADO') DEFNOMVIA_ACC,
				coalesce(get_info_end_endereco(nr_seq_end_acidente_w,'ESTADO_PROVINCI','C'),'97') DEFENT_ACC,
				coalesce(get_info_end_endereco(nr_seq_end_acidente_w,'MUNICIPIO','C'),'997') DEFDEL_ACC,
				coalesce(get_info_end_endereco(nr_seq_end_acidente_w,'LOCALIDADE_AREA','C'), '9997') DEFLOC_ACC,
				coalesce(get_info_end_endereco(nr_seq_end_acidente_w,'CODIGO_POSTAL','C'),'00000') DEFCP_ACC,
				CASE WHEN coalesce(get_info_end_endereco(nr_seq_end_acidente_w,'CODIGO_POSTAL','C'),'00000')='99999' THEN '1'  ELSE '2' END  seIgnoraCP,
				coalesce(get_info_end_endereco(nr_seq_end_acidente_w,'NUMERO','D') || get_info_end_endereco(nr_seq_end_acidente_w,'NUM_EXT_ALFA','D') ,'SN')  DEFNUMEXT_ACC,
				coalesce(get_info_end_endereco(nr_seq_end_acidente_w,'NUMERO_INT','D') || get_info_end_endereco(nr_seq_end_acidente_w,'COMPLEMENTO','D'),'SN') DEFNUMINT_ACC,
				coalesce(get_info_end_endereco(nr_seq_end_acidente_w,'TIPO_BAIRRO','C'),'46') DEFTIPOASEN_ACC,
				coalesce(get_info_end_endereco(nr_seq_end_acidente_w,'BAIRRO_VILA','D'),'SIN INFORMACIÓN') DEFNOMASEN_ACC
			into STRICT
				record_w.cd_tipo_vialidad_acc,
				record_w.ds_endereco_ocor_acidente,
				record_w.cd_estado_ocor_acidente,
				record_w.cd_municipio_ocor_acidente,
				record_w.cd_localidade_ocor_acidente,
				record_w.cd_codigo_postal_acc,
				record_w.ie_ignorar_cp_acc,
				record_w.nr_exterior_acc,
				record_w.nr_interior_acc,
				record_w.cd_tipo_asentamiento_acc,
				record_w.ds_bairro_ocor_acidente
			;

		else

			record_w.cd_tipo_vialidad_acc := '97'; --DEFTIPOVIA_ACC
			record_w.ds_endereco_ocor_acidente := 'NO APLICA'; --DEFNOMVIA_ACC
			record_w.cd_estado_ocor_acidente := '97'; --DEFENT_ACC
			record_w.cd_municipio_ocor_acidente := '997'; --DEFDEL_ACC
			record_w.cd_localidade_ocor_acidente := '9997'; --DEFLOC_ACC
			record_w.cd_codigo_postal_acc := '00000'; --DEFCP_ACC
			record_w.ie_ignorar_cp_acc := '2'; --seIgnoraCP
			record_w.nr_exterior_acc := 'NA'; --DEFNUMEXT_ACC
			record_w.nr_interior_acc := 'NA'; --DEFNUMINT_ACC
			record_w.cd_tipo_asentamiento_acc := '44'; --DEFTIPOASEN_ACC
			record_w.ds_bairro_ocor_acidente := 'NO APLICA'; --DEFNOMASEN_ACC
		end if;

		record_w.ds_tipo_vialidad_acc			:= record_w.ds_endereco_ocor_acidente;
		record_w.ds_tipo_asentamiento_acc		:= record_w.ds_bairro_ocor_acidente;

		select	max(lpad(coalesce(obter_dados_cat_derecho(cd_tipo_convenio_mx,'CD_DER_FETAL'),'00'),2,'00')) DEFDERECHO,
				max(cd_convenio)
		into STRICT	record_w.cd_der_fetal_def,
				cd_convenio_w
		from 	convenio
		where 	cd_convenio = (	SELECT	cd_convenio
								from	atend_categoria_convenio
								where	nr_seq_interno = Obter_Atecaco_atendimento(c_consulta_atendimento_w.nr_atendimento));


		select	max(lpad(coalesce(obter_dados_cat_derecho(cd_tipo_convenio_mx,'CD_DER_FETAL'),'88'),2,'00')) DEFDERECHO2
		into STRICT 	record_w.cd_der_fetal_def_2
		from 	convenio
		where 	cd_convenio = (	SELECT	cd_convenio
								from	atend_categoria_convenio
								where	nr_seq_interno = Obter_Atecaco_atendimento(c_consulta_atendimento_w.nr_atendimento) and cd_convenio <> cd_convenio_w);

		if (coalesce(record_w.cd_der_fetal_def_2,0) = 0) then
			record_w.cd_der_fetal_def_2 := '88';
		end if;


		select	CASE WHEN record_w.cd_der_fetal_def='00' THEN 'NO APLICA' WHEN record_w.cd_der_fetal_def='01' THEN 'NO APLICA' WHEN record_w.cd_der_fetal_def='88' THEN 'NO APLICA' WHEN record_w.cd_der_fetal_def='99' THEN 'NO APLICA'  ELSE coalesce(max(cd_usuario_convenio||cd_complemento),'NO ESPECIFICADO') END  DEFAFIL_DH
		into STRICT	record_w.nr_filiacao_def
		from 	atend_categoria_convenio
		where 	nr_seq_interno = Obter_Atecaco_atendimento(c_consulta_atendimento_w.nr_atendimento);

		select	CASE WHEN max(x.ie_brasileiro)='S' THEN '1'  ELSE '2' END  DEFNACION,
				CASE WHEN max(x.ie_brasileiro)='S' THEN record_w.cd_estado_nasc  ELSE '88' END  DEFENNAC
		into STRICT	record_w.ie_nacionalidade_def,
				record_w.cd_estado_nasc
		from 	nacionalidade x
		where 	x.cd_nacionalidade = cd_nacionalidade_w;

		if (record_w.ie_nacionalidade_def = '2') then
			select max(b.nm_pais)
			into STRICT record_w.ds_nacionalidade
			from nacionalidade a, cat_pais b
			where a.ie_situacao = 'A'
			and a.cd_externo = to_char(b.cd_pais)
			and a.cd_nacionalidade = cd_nacionalidade_w;
		else
			record_w.ds_nacionalidade := 'NO APLICA';
		end if;

		/*Sinais vitais*/

		select	max(a.ie_unid_med_peso),
				max(a.ie_unid_med_altura),
				substr(max(a.qt_peso_atual),1,3),
				substr(max(a.qt_peso),1,3),
				max(a.qt_altura_cm),
				max(a.qt_altura_m)
		into STRICT	ie_unid_med_peso_w,
				ie_unid_med_altura_w,
				qt_peso_atual_w,
				qt_peso_w,
				qt_altura_cm_w,
				qt_altura_m_w
		from (	SELECT	nr_sequencia,
						ie_unid_med_peso,
						ie_unid_med_altura,
						qt_peso_atual,
						qt_peso,
						qt_altura_cm,
						qt_altura_m
				from    atendimento_sinal_vital
				where   nr_atendimento = c_consulta_atendimento_w.nr_atendimento
				order by nr_sequencia desc) a LIMIT 1;

		if (upper(ie_unid_med_peso_w) = 'G') then
			record_w.qt_peso_kg_def := trunc(qt_peso_atual_w/1000); /*DEFPESOKG*/
			record_w.qt_peso_gr_def := qt_peso_atual_w; /*DEFPESOM*/
		else
			record_w.qt_peso_kg_def := trunc(qt_peso_w); /*DEFPESOKG*/
			record_w.qt_peso_gr_def := qt_peso_w * 1000; /*DEFPESOM*/
		end if;

		/*DEFPESOKG*/

		if (coalesce(record_w.qt_peso_kg_def::text, '') = '') then
			record_w.qt_peso_kg_def := coalesce(trunc(qt_peso_pf_w),'999');
		end if;

		/*DEFPESOM*/

		if (coalesce(record_w.qt_peso_gr_def::text, '') = '') then
			record_w.qt_peso_gr_def := coalesce((qt_peso_pf_w * 1000),'999');
		end if;

		if (upper(ie_unid_med_altura_w) = 'CM') then
			record_w.qt_altura_mt_def := trunc(qt_altura_cm_w/100); /*DEFTALLA_MT*/
			record_w.qt_altura_cm_def := mod(qt_altura_cm_w,100); /*DEFTALLA_CM*/
		else
			record_w.qt_altura_mt_def := TRUNC(qt_altura_m_w); /*DEFTALLA_MT*/
			record_w.qt_altura_cm_def := mod((qt_altura_m_w * 100),100); /*DEFTALLA_CM*/
		end if;

		/*DEFTALLA_MT*/

		if (coalesce(record_w.qt_altura_mt_def::text, '') = '') then
			record_w.qt_altura_mt_def := coalesce(trunc(qt_altura_cm_pf_w/100),'9');
		end if;

		/*DEFTALLA_CM*/

		if (coalesce(record_w.qt_altura_cm_def::text, '') = '') then
			record_w.qt_altura_cm_def := coalesce(mod(qt_altura_cm_pf_w,100),'99');
		end if;

		record_w.nr_atendimento				:= c_consulta_atendimento_w.nr_atendimento;
		record_w.ds_diagnostico_les_def		:= c_consulta_atendimento_w.defdesc_les;
		record_w.ie_morte_materna			:= c_consulta_atendimento_w.defvermat;
		record_w.ie_retificado 				:= '0';
		record_w.ie_bloq_perfil_fed 		:= '0';
		record_w.ie_bloq_perfil_est 		:= '0';
		record_w.ie_controle_interno 		:= '0';
		record_w.dt_atualizacao 			:= clock_timestamp();
		record_w.nm_usuario 				:= nm_usuario_p;
		record_w.dt_atualizacao_nrec 			:= clock_timestamp();
		record_w.nm_usuario_nrec 				:= nm_usuario_p;

		select coalesce(CASE WHEN obter_inform_adic_usuario_mx(nm_usuario_p,'IE_NIVEL_USUARIO_SEED')='1' THEN 'EDO' WHEN obter_inform_adic_usuario_mx(nm_usuario_p,'IE_NIVEL_USUARIO_SEED')='2' THEN 'JURIS' WHEN obter_inform_adic_usuario_mx(nm_usuario_p,'IE_NIVEL_USUARIO_SEED')='3' THEN  'UNME' WHEN obter_inform_adic_usuario_mx(nm_usuario_p,'IE_NIVEL_USUARIO_SEED')='4' THEN  'SEMEF'  ELSE 'SEED' END , 'SEED')
		into STRICT record_w.nm_usuario_mod
		;

		select 	nextval('guia_morte_noms_seq')
		into STRICT	record_w.nr_sequencia
		;

		insert into guia_morte_noms values (record_w.*);

		end;
	end loop;
	close c_consulta_atendimento;
	end;
end if;
commit;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_guia_morte_noms ( dt_inicial_p timestamp, dt_final_p timestamp, ie_sobreescrever_p text, nm_usuario_p text) FROM PUBLIC;

