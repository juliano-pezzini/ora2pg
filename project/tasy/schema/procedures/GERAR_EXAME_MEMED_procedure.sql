-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_exame_memed (nr_atendimento_p text ,nr_seq_solicitacao_p text ,nm_usuario_p text ,id_prescription_p text DEFAULT NULL,id_p text DEFAULT NULL,nome_p text DEFAULT NULL,unit_p text DEFAULT NULL,quantidade_p text DEFAULT NULL,posologia_p text DEFAULT NULL,exames_sus_codigo_p text DEFAULT NULL,exames_tuss_codigo_p text DEFAULT NULL,ds_ext_urlpdf_p text DEFAULT NULL,data_json_p text DEFAULT NULL) AS $body$
DECLARE

  ds_justificativa_w pedido_exame_externo.ds_justificativa%TYPE;
  ds_solicitacao_w   pedido_exame_externo.ds_solicitacao%TYPE;

BEGIN
  ds_solicitacao_w := '<html tasy="html5">' ||
                      '<p style="text-align:left;">' ||
                      '<span style="font-size:16px;">' || '<a href="' ||
                      ds_ext_urlpdf_p || '">' ||
                      obter_desc_expressao(1038770) || '</a>' ||
                      '</p></span>' || '</html>';

  ds_justificativa_w := '- exames_sus_codigo ' || exames_sus_codigo_p ||
                        chr(10) || '- exames_sus_codigo ' ||
                        exames_tuss_codigo_p || chr(10) ||
                        '- exames_sus_codigo ' || posologia_p;

  UPDATE pedido_exame_externo t
     SET t.ds_justificativa = ds_justificativa_w
        ,t.ds_solicitacao   = ds_solicitacao_w
        ,t.cd_ext_idexame   = id_prescription_p
        ,t.ds_ext_urlpdf    = ds_ext_urlpdf_p
        ,dt_atualizacao     = clock_timestamp()
        ,t.dt_liberacao      = NULL
        ,t.dt_inativacao     = NULL
   WHERE t.nr_sequencia = nr_seq_solicitacao_p;

  INSERT INTO pedido_exame_externo_item(nr_sequencia
    ,dt_atualizacao
    ,nm_usuario
    ,nr_seq_pedido
    ,nr_seq_exame
    ,qt_exame
    ,nr_seq_apresent
    ,ds_justificativa
    ,dt_atualizacao_nrec
    ,nm_usuario_nrec
    ,dt_liberacao)
  VALUES (nextval('pedido_exame_externo_item_seq')
    ,clock_timestamp()
    ,nm_usuario_p
    ,nr_seq_solicitacao_p
    ,NULL
    ,quantidade_p
    ,0
    ,ds_justificativa_w
    ,clock_timestamp()
    ,nm_usuario_p
    ,NULL);

  INSERT INTO pedido_exame_externo_aud(nr_sequencia
    ,nr_seq_pedido
    ,dt_atualizacao
    ,nm_usuario
    ,dt_atualizacao_nrec
    ,nm_usuario_nrec
    ,ds_json)
  VALUES (nextval('pedido_exame_externo_aud_seq')
    ,id_prescription_p
    ,clock_timestamp()
    ,nm_usuario_p
    ,clock_timestamp()
    ,nm_usuario_p
    ,data_json_p);

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_exame_memed (nr_atendimento_p text ,nr_seq_solicitacao_p text ,nm_usuario_p text ,id_prescription_p text DEFAULT NULL,id_p text DEFAULT NULL,nome_p text DEFAULT NULL,unit_p text DEFAULT NULL,quantidade_p text DEFAULT NULL,posologia_p text DEFAULT NULL,exames_sus_codigo_p text DEFAULT NULL,exames_tuss_codigo_p text DEFAULT NULL,ds_ext_urlpdf_p text DEFAULT NULL,data_json_p text DEFAULT NULL) FROM PUBLIC;

