-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_prescr_mat_diluicao ( nr_prescricao_p bigint, nr_sequencia_p bigint, nm_usuario_p text, cd_perfil_p bigint) AS $body$
DECLARE


qt_dose_diferenciada_w		double precision;
cd_setor_atendimento_w		integer;
nr_seq_via_acesso_w		bigint;
cd_estabelecimento_w		bigint;
ds_lista_restricao_w		varchar(2000);
cd_material_w			bigint;
cd_material_sem_apresent_w	bigint;
qt_idade_w			double precision;
qt_peso_w			real;
cd_unidade_medida_dose_w	varchar(30);
qt_dose_medic_w			double precision;
ie_via_aplicacao_w		varchar(5);
cd_pessoa_fisica_w		varchar(50);
ds_dose_diferenciada_w		varchar(50);
ds_hora_w			varchar(5);
ds_dose_diferenciada_ww		varchar(50);
ds_horarios_padr_w		varchar(2000);
nr_seq_restricao_w		bigint;
ie_loop_w			bigint;
qt_minuto_aplicacao_w		bigint;
h				bigint;
k				bigint;
qt_diluicao_w			double precision;
cd_unid_med_diluente_w		varchar(30);

c01 CURSOR FOR
SELECT	coalesce(qt_minuto_aplicacao,0),
	qt_diluicao,
	cd_unid_med_diluente
from	material_diluicao
where	((cd_setor_atendimento	= cd_setor_atendimento_w)
or (coalesce(cd_setor_atendimento::text, '') = ''))
and	((coalesce(cd_setor_excluir::text, '') = '') or (cd_setor_excluir <> cd_setor_atendimento_w))
and	obter_se_regra_diluicao_setor(nr_seq_interno, cd_setor_atendimento_w) = 'S'
and	((coalesce(nr_seq_via_acesso::text, '') = '') or (nr_seq_via_acesso = nr_seq_via_acesso_w))
and	cd_estabelecimento	= cd_estabelecimento_w
and	((obter_se_contido(nr_seq_restricao, ds_lista_restricao_w) = 'S') or (coalesce(nr_seq_restricao::text, '') = ''))
and	ie_reconstituicao	= 'N'
and	cd_material		= coalesce(cd_material_sem_apresent_w, cd_material_w)
and	qt_idade_w between obter_idade_diluicao(cd_material,nr_sequencia,'MIN') and obter_idade_diluicao(cd_material,nr_sequencia,'MAX')
and	qt_peso_w  between coalesce(qt_peso_min,0) and coalesce(qt_peso_max,999999)
and	((coalesce(cd_unidade_medida::text, '') = '') or (cd_unidade_medida	= cd_unidade_medida_dose_w))
and	coalesce(obter_conversao_unid_med_cons(cd_material_w,cd_unidade_medida_dose_w,qt_dose_diferenciada_w),0) between
	coalesce(obter_conversao_unid_med_cons(cd_material_w,cd_unidade_medida,qt_dose_min),0) and
	coalesce(obter_conversao_unid_med_cons(cd_material_w,cd_unidade_medida,qt_dose_max),9999999)
and	((ie_via_aplicacao	= ie_via_aplicacao_w) or (coalesce(ie_via_aplicacao::text, '') = ''))
order by 	ie_via_aplicacao desc,
		cd_setor_atendimento desc,
		qt_idade_min desc,
		qt_idade_max desc,
		nr_seq_prioridade desc,
		nr_seq_restricao desc;

c03 CURSOR FOR
SELECT	nr_seq_restricao
from	paciente_rep_prescricao a
where	(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
and	cd_pessoa_fisica = cd_pessoa_fisica_w
and	dt_inativacao is  null
and	((coalesce(a.dt_fim::text, '') = '') or (clock_timestamp() between coalesce(a.dt_inicio,clock_timestamp() - interval '1 days') and a.dt_fim + 86399/86400));


BEGIN

select	max(a.cd_setor_atendimento),
	max(a.cd_estabelecimento),
	max(obter_idade(b.dt_nascimento,coalesce(b.dt_obito,clock_timestamp()),'DIA')),
	coalesce(max(a.qt_peso),0),
	max(b.cd_pessoa_fisica)
into STRICT	cd_setor_atendimento_w,
	cd_estabelecimento_w,
	qt_idade_w,
	qt_peso_w,
	cd_pessoa_fisica_w
from	pessoa_fisica b,
	prescr_medica a
where	a.nr_prescricao		= nr_prescricao_p
and	a.cd_pessoa_fisica	= b.cd_pessoa_fisica;

Select	coalesce(cd_material,0),
	ie_via_aplicacao,
	cd_mat_sem_apresent,
	ds_dose_diferenciada,
	nr_seq_via_acesso,
	qt_dose,
	cd_unidade_medida_dose,
	ds_horarios
into STRICT	cd_material_w,
	ie_via_aplicacao_w,
	cd_material_sem_apresent_w,
	ds_dose_diferenciada_w,
	nr_seq_via_acesso_w,
	qt_dose_medic_w,
	cd_unidade_medida_dose_w,
	ds_horarios_padr_w
from	prescr_material
where	nr_prescricao = nr_prescricao_p
and	nr_sequencia  = nr_sequencia_p
and	(cd_material IS NOT NULL AND cd_material::text <> '');
begin
open c03;
loop
fetch c03 into
	nr_seq_restricao_w;
EXIT WHEN NOT FOUND; /* apply on c03 */
	ds_lista_restricao_w	:= nr_seq_restricao_w  || ',' || ds_lista_restricao_w;
end loop;
close c03;

delete from prescr_mat_diluicao
where	nr_prescricao	= nr_prescricao_p
and	nr_seq_material	= nr_sequencia_p;

commit;

if (ds_dose_diferenciada_w IS NOT NULL AND ds_dose_diferenciada_w::text <> '') then
	ds_dose_diferenciada_ww	:= ds_dose_diferenciada_w;
	ie_loop_w		:= 0;
	while(ds_dose_diferenciada_ww IS NOT NULL AND ds_dose_diferenciada_ww::text <> '') and (ie_loop_w < 101) LOOP
		begin

		select	position('-' in ds_dose_diferenciada_ww)
		into STRICT	h
		;

		if (h > 0) then
			qt_dose_diferenciada_w	:= replace(substr(ds_dose_diferenciada_ww, 1, h-1),'/',',');
			ds_dose_diferenciada_ww	:= substr(ds_dose_diferenciada_ww, h+1, 50);
		else
			qt_dose_diferenciada_w	:= replace(ds_dose_diferenciada_ww,'/',',');
			ds_dose_diferenciada_ww	:= null;
		end if;


		select	position(' ' in ds_horarios_padr_w)
		into STRICT	k
		;

		if (k > 1) and ((substr(ds_horarios_padr_w, 1, k -1) IS NOT NULL AND (substr(ds_horarios_padr_w, 1, k -1))::text <> '')) then
			ds_hora_w		:= substr(ds_horarios_padr_w, 1, k-1);
			ds_hora_w		:= replace(ds_hora_w, ' ','');
			ds_horarios_padr_w	:= substr(ds_horarios_padr_w, k + 1, 2000);
		elsif (ds_horarios_padr_w IS NOT NULL AND ds_horarios_padr_w::text <> '') then
			ds_hora_w 		:= replace(ds_horarios_padr_w,' ','');
			ds_horarios_padr_w	:= '';
		end if;

		if (length(ds_hora_w) = 2) then
			ds_hora_w	:= ds_hora_w || ':00';
		end if;

		if (coalesce(qt_dose_diferenciada_w,0) > 0) then

			open c01;
			loop
			fetch c01 into
				qt_minuto_aplicacao_w,
				qt_diluicao_w,
				cd_unid_med_diluente_w;
			EXIT WHEN NOT FOUND; /* apply on c01 */
				qt_minuto_aplicacao_w	:= qt_minuto_aplicacao_w;
				qt_diluicao_w		:= qt_diluicao_w;
				cd_unid_med_diluente_w	:= cd_unid_med_diluente_w;
			end loop;
			close c01;

			insert into prescr_mat_diluicao(nr_sequencia,
				dt_atualizacao,
				nm_usuario,
				dt_atualizacao_nrec,
				nm_usuario_nrec,
				nr_prescricao,
				nr_seq_material,
				qt_dose_diferenciada,
				qt_min_aplicacao,
				ds_hora,
				ie_ordem,
				qt_diluicao,
				cd_unid_med_diluente)
			values (nextval('prescr_mat_diluicao_seq'),
				clock_timestamp(),
				nm_usuario_p,
				clock_timestamp(),
				nm_usuario_p,
				nr_prescricao_p,
				nr_sequencia_p,
				coalesce(qt_dose_diferenciada_w,0),
				qt_minuto_aplicacao_w,
				ds_hora_w,
				ie_loop_w,
				qt_diluicao_w,
				cd_unid_med_diluente_w);
		end if;
		ie_loop_w	:=  ie_loop_w + 1;
		end;
	end loop;

	commit;

end if;

exception
when others then
	null;
end;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_prescr_mat_diluicao ( nr_prescricao_p bigint, nr_sequencia_p bigint, nm_usuario_p text, cd_perfil_p bigint) FROM PUBLIC;

