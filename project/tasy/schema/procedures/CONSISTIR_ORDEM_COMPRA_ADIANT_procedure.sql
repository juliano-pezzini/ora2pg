-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE consistir_ordem_compra_adiant (nr_ordem_compra_p bigint, nr_adiantamento_p bigint, vl_vinculado_p bigint, ds_erro_p INOUT text, NM_USUARIO_P text) AS $body$
DECLARE

 
		 
qt_existe_w				bigint;
vl_saldo_adiantamento_w			double precision;
vl_vinculado_w				double precision;
vl_ordem_compra_w			double precision;
ds_erro_w				varchar(254) := '';
cd_cgc_adiantamento_w			varchar(14);
cd_cgc_ordem_compra_w			varchar(14);
cd_pf_adiantamento_w			varchar(10);
cd_pf_ordem_compra_w			varchar(10);
ie_adiantamento_outro_cnpj_w		varchar(1);
cd_estabelecimento_w			smallint;


BEGIN 
 
select	count(*) 
into STRICT	qt_existe_w 
from	adiantamento_pago 
where	nr_adiantamento	= nr_adiantamento_p;
 
 
if (qt_existe_w = 0) then 
	ds_erro_w	:= WHEB_MENSAGEM_PCK.get_texto(280647) || chr(13);	
 
else 
	select	obter_valor_liquido_ordem(nr_ordem_compra), 
		cd_cgc_fornecedor, 
		cd_pessoa_fisica, 
		cd_estabelecimento 
	into STRICT	vl_ordem_compra_w, 
		cd_cgc_ordem_compra_w, 
		cd_pf_ordem_compra_w, 
		cd_estabelecimento_w 
	from	ordem_compra 
	where	nr_ordem_compra = nr_ordem_compra_p;
 
	select	vl_saldo, 
		cd_cgc, 
		cd_pessoa_fisica 
	into STRICT	vl_saldo_adiantamento_w, 
		cd_cgc_adiantamento_w, 
		cd_pf_adiantamento_w 
	from	adiantamento_pago 
	where	nr_adiantamento	= nr_adiantamento_p;
 
	select	coalesce(sum(vl_vinculado), 0) 
	into STRICT	vl_vinculado_w 
	from	ordem_compra_adiant_pago 
	where	nr_ordem_compra	= nr_ordem_compra_p;
 
	select	substr(coalesce(obter_valor_param_usuario(917,199,Obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w),'S'),1,1) 
	into STRICT	ie_adiantamento_outro_cnpj_w 
	;
 
	if (ie_adiantamento_outro_cnpj_w <> 'S') and 
		((cd_cgc_adiantamento_w <> cd_cgc_ordem_compra_w) or (cd_pf_adiantamento_w <> cd_pf_ordem_compra_w)) then 
		ds_erro_w	:= WHEB_MENSAGEM_PCK.get_texto(280646) || chr(13);
	end if;
 
	if (vl_vinculado_p > vl_saldo_adiantamento_w) then 
		ds_erro_w	:= WHEB_MENSAGEM_PCK.get_texto(280648) || chr(13);
	end if;
 
	if	((vl_vinculado_w + vl_vinculado_p) > vl_ordem_compra_w) then 
		ds_erro_w	:= WHEB_MENSAGEM_PCK.get_texto(280652) || chr(13);
	end if;
 
end if;
 
ds_erro_p	:= ds_erro_w;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE consistir_ordem_compra_adiant (nr_ordem_compra_p bigint, nr_adiantamento_p bigint, vl_vinculado_p bigint, ds_erro_p INOUT text, NM_USUARIO_P text) FROM PUBLIC;

