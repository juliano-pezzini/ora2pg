-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_gerar_agenda_integrada ( nr_seq_atendimento_p bigint, cd_pessoa_fisica_p text, nm_usuario_p text, nr_seq_evento_atend_p bigint, cd_estabelecimento_p bigint, cd_profissional_p text, cd_convenio_p text, ds_parametro1_p text, nr_seq_segurado_p bigint, cd_pessoa_rn_benef_p text, cd_convenio_retorno_p INOUT text) AS $body$
DECLARE


cd_cgc_outorgante_w		varchar(15);
cd_convenio_w			varchar(15);
nm_pessoa_w			varchar(255);
nr_seq_status_w			bigint;
dt_nascimento_w			timestamp;
ie_sexo_w			varchar(1);
nr_seq_segurado_w		bigint;
cd_usuario_plano_w		varchar(40);
dt_validade_carteira_w		timestamp;
nr_idade_benef_w		bigint;
cd_categoria_w			agenda_integrada.cd_categoria%type;
cd_plano_w			agenda_integrada.cd_plano%type;
cd_convenio_ww			convenio.cd_convenio%type;
param_agenda_integrada_w	varchar(2);
nr_seq_agenda_w			agenda_integrada.nr_sequencia%type;
cd_usuario_convenio_w		varchar(30);
nr_doc_convenio_w		varchar(20);
cd_tipo_acomodacao_w		smallint;
ds_observacao_w			varchar(4000);
cd_tipo_agenda_w		bigint := null;
cd_pessoa_mae_w 		pessoa_fisica.cd_pessoa_mae%type;
cd_pessoa_fisica_w		pessoa_fisica.cd_pessoa_fisica%type;
nr_telefone_w			agenda_integrada.nr_telefone%type;
qt_altura_cm_w			agenda_integrada.qt_altura_cm%type;
qt_altura_cm_ant_w		agenda_integrada.qt_altura_cm%type;
qt_peso_w			agenda_integrada.qt_peso%type;
qt_peso_ant_w			agenda_integrada.qt_peso%type;
qt_idade_pac_w			agenda_integrada.qt_idade_pac%type;
ie_altu_agenda_anterior_w	varchar(1);
ie_peso_agenda_anterior_w	varchar(1);
cd_estabelecimento_w		estabelecimento.cd_estabelecimento%type;
aux_w		smallint;


BEGIN

begin
   cd_estabelecimento_w :=   coalesce(cd_estabelecimento_p,wheb_usuario_pck.get_cd_estabelecimento);
exception
when others then
   cd_estabelecimento_w := 1;
end;

begin
	select	cd_cgc_outorgante
	into STRICT 	cd_cgc_outorgante_w
	from	pls_outorgante
	where	cd_estabelecimento = cd_estabelecimento_p;
exception
when others then
	cd_cgc_outorgante_w	:= '';
end;

if (coalesce(cd_convenio_p::text, '') = '') then
	begin
	select	max(cd_convenio)
	into STRICT	cd_convenio_w
	from	convenio
	where	cd_cgc = cd_cgc_outorgante_w;
	exception
	when others then
		CALL wheb_mensagem_pck.exibir_mensagem_abort(267231);
	end;
else
	cd_convenio_w	:= cd_convenio_p;
end if;

if (nr_seq_segurado_p IS NOT NULL AND nr_seq_segurado_p::text <> '')  then
	begin
	select max(substr(pls_obter_dados_segurado(nr_seq_segurado_p,'PF'),1,255))
	into STRICT cd_pessoa_fisica_w
	;
	end;
elsif (cd_pessoa_rn_benef_p IS NOT NULL AND cd_pessoa_rn_benef_p::text <> '') then
	cd_pessoa_fisica_w := cd_pessoa_rn_benef_p;
else
	cd_pessoa_fisica_w := cd_pessoa_fisica_p;
end if;

begin
	select	substr(obter_nome_pf(cd_pessoa_fisica_w),1,60)
	into STRICT	nm_pessoa_w
	;
exception
when others then
	nm_pessoa_w 	:= '';
end;

select	max(nr_sequencia)
into STRICT	nr_seq_status_w
from	agenda_integrada_status
where	ie_status_tasy	= 'EA'
and 	ie_situacao = 'A';

begin
select	max(dt_nascimento),
	max(ie_sexo),
	obter_fone_pac_agenda(max(cd_pessoa_fisica)) nr_telefone,
	max(qt_altura_cm),
	ageint_obter_dados_agenda_ant(max(cd_pessoa_fisica), clock_timestamp(),'','','A') qt_altura_cm_ant,
	max(qt_peso),
	ageint_obter_dados_agenda_ant(max(cd_pessoa_fisica), clock_timestamp(),'','','P') qt_peso_ant,
	Obter_Idade_PF(max(cd_pessoa_fisica),clock_timestamp(),'A')
into STRICT	dt_nascimento_w,
	ie_sexo_w,
	nr_telefone_w,
	qt_altura_cm_w,
	qt_altura_cm_ant_w,
	qt_peso_w,
	qt_peso_ant_w,
	qt_idade_pac_w
from	pessoa_fisica
where	cd_pessoa_fisica 	= cd_pessoa_fisica_w;
exception
when others then
	dt_nascimento_w		:= '';
	ie_sexo_w		:= '';
	nr_telefone_w		:= '';
	qt_altura_cm_w		:= '';
	qt_altura_cm_ant_w	:= '';
	qt_peso_w		:= '';
	qt_peso_ant_w		:= '';
end;

if ( (coalesce(nr_seq_segurado_p::text, '') = '') and (coalesce(cd_pessoa_rn_benef_p::text, '') = '') ) then
	begin
		select	nr_seq_segurado
		into STRICT	nr_seq_segurado_w
		from	pls_atendimento
		where	nr_sequencia	= nr_seq_atendimento_p;
	exception
	when others then
		nr_seq_segurado_w	:= '';
	end;

	if (nr_seq_segurado_w	= '') then
		begin
			select	max(nr_sequencia)
			into STRICT	nr_seq_segurado_w
			from	pls_segurado
			where	cd_pessoa_fisica = cd_pessoa_fisica_w;
		exception
		when others then
			nr_seq_segurado_w	:= '';
		end;
	end if;

elsif (cd_pessoa_rn_benef_p IS NOT NULL AND cd_pessoa_rn_benef_p::text <> '') then

	begin
	select max(cd_pessoa_mae)
	into STRICT cd_pessoa_mae_w
	from pessoa_fisica
	where cd_pessoa_fisica = cd_pessoa_rn_benef_p;



	SELECT COUNT(1)
	into STRICT aux_w
	FROM pls_segurado
	WHERE cd_pessoa_fisica = cd_pessoa_mae_w
	AND ie_situacao_atend = 'A';

	if ( aux_w = 1)then
		SELECT nr_sequencia
		into STRICT	nr_seq_segurado_w
		FROM pls_segurado
		WHERE cd_pessoa_fisica = cd_pessoa_mae_w
		AND ie_situacao_atend = 'A';
	else
		nr_seq_segurado_w := 0;
	end if;
	end;
else
	nr_seq_segurado_w := nr_seq_segurado_p;
end if;

if ((coalesce(nr_seq_segurado_p::text, '') = '') and (coalesce(cd_pessoa_rn_benef_p::text, '') = '')) then
begin
	begin
		select	substr(pls_obter_dados_segurado(nr_seq_segurado_w,'C'),1,255),
			substr(pls_obter_dados_segurado(nr_seq_segurado_w,'V'),1,255)
		into STRICT	cd_usuario_plano_w,
			dt_validade_carteira_w
		from 	pls_atendimento
		where	nr_sequencia	= nr_seq_atendimento_p;
	exception
	when others then
		cd_usuario_plano_w		:= '';
		dt_validade_carteira_w		:= '';
	end;

	select	obter_dados_seg_entrada_unica(nr_seq_segurado_w,'CV')
	into STRICT	cd_convenio_ww
	;

	if (cd_convenio_ww = cd_convenio_p) then
		cd_convenio_w	:= cd_convenio_ww;
		select	obter_dados_seg_entrada_unica(nr_seq_segurado_w,'CA'),
			obter_dados_seg_entrada_unica(nr_seq_segurado_w,'PLC')
		into STRICT	cd_categoria_w,
			cd_plano_w
		;
	else
		cd_categoria_w	:= null;
		cd_plano_w	:= null;
	end if;
end;
else
	cd_usuario_plano_w	:= obter_dados_seg_entrada_unica(nr_seq_segurado_w, 'CI');
	cd_convenio_w	:= obter_dados_seg_entrada_unica(nr_seq_segurado_w, 'CV');
	dt_validade_carteira_w	:= obter_dados_seg_entrada_unica(nr_seq_segurado_w, 'VC');
	cd_categoria_w	:=	obter_dados_seg_entrada_unica(nr_seq_segurado_w, 'CA');
	cd_plano_w	:=	obter_dados_seg_entrada_unica(nr_seq_segurado_w, 'PLC');
end if;

if ( coalesce(cd_pessoa_rn_benef_p::text, '') = '' ) then
	nr_idade_benef_w	:= pls_obter_idade_segurado(nr_seq_segurado_w, clock_timestamp(), 'A');

else
	nr_idade_benef_w	:= Obter_Idade_PF(cd_pessoa_rn_benef_p,clock_timestamp(),'A');
end if;

select	nextval('agenda_integrada_seq')
into STRICT	nr_seq_agenda_w
;


param_agenda_integrada_w	:= coalesce(obter_valor_param_usuario(869, 13, Obter_Perfil_Ativo, nm_usuario_p, cd_estabelecimento_w), 'N');
ie_peso_agenda_anterior_w	:= coalesce(obter_valor_param_usuario(869, 15, Obter_Perfil_Ativo, nm_usuario_p, cd_estabelecimento_w), 'N');
ie_altu_agenda_anterior_w	:= coalesce(obter_valor_param_usuario(869, 16, Obter_Perfil_Ativo, nm_usuario_p, cd_estabelecimento_w), 'N');

if (param_agenda_integrada_w in ('AG', 'AT')) then

	begin
	if ( coalesce(cd_pessoa_rn_benef_p::text, '') = '' ) then
		SELECT * FROM gerar_convenio_ageint(	cd_pessoa_fisica_w, cd_tipo_agenda_w, nr_seq_agenda_w, param_agenda_integrada_w, cd_convenio_w, cd_categoria_w, cd_usuario_convenio_w, dt_validade_carteira_w, nr_doc_convenio_w, cd_tipo_acomodacao_w, cd_plano_w, nm_usuario_p, ds_observacao_w) INTO STRICT cd_convenio_w, cd_categoria_w, cd_usuario_convenio_w, dt_validade_carteira_w, nr_doc_convenio_w, cd_tipo_acomodacao_w, cd_plano_w, ds_observacao_w;
	else
		SELECT * FROM gerar_convenio_ageint(	cd_pessoa_mae_w, cd_tipo_agenda_w, nr_seq_agenda_w, param_agenda_integrada_w, cd_convenio_w, cd_categoria_w, cd_usuario_convenio_w, dt_validade_carteira_w, nr_doc_convenio_w, cd_tipo_acomodacao_w, cd_plano_w, nm_usuario_p, ds_observacao_w) INTO STRICT cd_convenio_w, cd_categoria_w, cd_usuario_convenio_w, dt_validade_carteira_w, nr_doc_convenio_w, cd_tipo_acomodacao_w, cd_plano_w, ds_observacao_w;
	end if;
	end;
end if;

if (ie_peso_agenda_anterior_w = 'S') then
    qt_peso_w := qt_peso_ant_w;
end if;

if (ie_altu_agenda_anterior_w = 'S') then
   qt_altura_cm_w := qt_altura_cm_ant_w;
end if;

if (coalesce(nr_idade_benef_w::text, '') = '') then
    nr_idade_benef_w := qt_idade_pac_w;
end if;

insert into agenda_integrada(nr_Sequencia, cd_pessoa_fisica, nr_seq_status,
	dt_inicio_agendamento, dt_atualizacao, nm_usuario,
	dt_atualizacao_nrec,nm_usuario_nrec, nr_seq_atend_pls,
	cd_convenio,cd_profissional,ie_turno,
	cd_estabelecimento, nm_paciente, nr_seq_evento_atend,
	dt_nascimento, nr_telefone, ie_sexo,
	cd_usuario_convenio, dt_validade_carteira, qt_idade_pac,
	cd_plano, cd_categoria, qt_altura_cm, qt_peso)
values (nr_seq_agenda_w, cd_pessoa_fisica_w, nr_seq_status_w,
	clock_timestamp(), clock_timestamp(), nm_usuario_p,
	clock_timestamp(), nm_usuario_p, nr_seq_atendimento_p,
	cd_convenio_w,cd_profissional_p,'2',
	cd_estabelecimento_p,nm_pessoa_w, nr_seq_evento_atend_p,
	dt_nascimento_w, nr_telefone_w, ie_sexo_w,
	cd_usuario_plano_w, dt_validade_carteira_w, nr_idade_benef_w,
	cd_plano_w, cd_categoria_w, qt_altura_cm_w, qt_peso_w);

commit;

cd_convenio_retorno_p := cd_convenio_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_gerar_agenda_integrada ( nr_seq_atendimento_p bigint, cd_pessoa_fisica_p text, nm_usuario_p text, nr_seq_evento_atend_p bigint, cd_estabelecimento_p bigint, cd_profissional_p text, cd_convenio_p text, ds_parametro1_p text, nr_seq_segurado_p bigint, cd_pessoa_rn_benef_p text, cd_convenio_retorno_p INOUT text) FROM PUBLIC;

