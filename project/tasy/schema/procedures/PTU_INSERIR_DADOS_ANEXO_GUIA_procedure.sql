-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE ptu_inserir_dados_anexo_guia ( nr_seq_guia_p pls_guia_plano.nr_sequencia%type, nr_seq_pedido_anexo_p ptu_pedido_aut_anexo.nr_sequencia%type, ds_biometria_p pls_lote_anexo_guias_aut.ds_biometria%type, nm_usuario_p text) AS $body$
DECLARE

 
/* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ 
finalidade: Inserir os dados do anexo importado para as tabelas de anexo da guia 
------------------------------------------------------------------------------------------------------------------- 
locais de chamada direta: 
[ ] objetos do dicionário [ ] tasy (delphi/java) [ ] portal [ ] relatórios [ ] outros: 
 ------------------------------------------------------------------------------------------------------------------ 
pontos de atenção:performance. 
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */
 
 
cd_guia_w			pls_guia_plano.cd_guia%type;
dt_autorizacao_w		pls_guia_plano.dt_autorizacao%type;
ie_recem_nascido_w		pls_guia_plano.ie_recem_nascido%type;
nr_seq_guia_principal_w		pls_guia_plano.nr_seq_guia_principal%type;
ie_status_w			pls_guia_plano.ie_status%type;
ds_observacao_w			pls_guia_plano.ds_observacao%type;
dt_solicitacao_w		pls_guia_plano.dt_solicitacao%type;
cd_senha_w			pls_guia_plano.cd_senha%type;
cd_usuario_plano_w		varchar(30);
nm_beneficiario_w		varchar(50);
nr_seq_segurado_w		pls_guia_plano.nr_seq_segurado%type;
cd_guia_referencia_w		pls_guia_plano.cd_guia%type;
qt_idade_w			integer;
ie_sexo_w			pls_lote_anexo_guias_aut.ie_sexo%type;
nr_seq_lote_anexo_guia_w	pls_lote_anexo_guias_aut.nr_sequencia%type;
nm_profissional_solic_w		ptu_pedido_aut_anexo.nm_profissional_solic%type;
nr_telef_prof_solic_w		ptu_pedido_aut_anexo.nr_telef_prof_solic%type;
ds_justificativa_w		ptu_pedido_aut_anexo.ds_justificativa%type;
ds_email_prof_solic_w		ptu_pedido_aut_anexo.ds_email_prof_solic%type;
ds_especificacao_w		ptu_pedido_aut_anexo.ds_especificacao%type;
qt_peso_w			ptu_pedido_aut_anexo.qt_peso%type;
qt_altura_w			ptu_pedido_aut_anexo.qt_altura%type;
qt_superficie_corporal_w	ptu_pedido_aut_anexo.qt_superficie_corporal%type;
ds_procedimento_cirurgico_w	ptu_pedido_aut_anexo.ds_procedimento_cirurgico%type;
dt_real_proc_cirurgico_w	ptu_pedido_aut_anexo.dt_real_proc_cirurgico%type;
ds_area_irradiada_w		ptu_pedido_aut_anexo.ds_area_irradiada%type;
dt_radioterapia_w		ptu_pedido_aut_anexo.dt_radioterapia%type;
nr_ciclo_previsto_w		ptu_pedido_aut_anexo.nr_ciclo_previsto%type;
nr_ciclo_atual_w		ptu_pedido_aut_anexo.nr_ciclo_atual%type;
qt_intervalo_ciclo_w		ptu_pedido_aut_anexo.qt_intervalo_ciclo%type;
ds_quimioterapia_w		ptu_pedido_aut_anexo.ds_quimioterapia%type;
dt_quimioterapia_w		ptu_pedido_aut_anexo.dt_quimioterapia%type;
qt_dose_total_w			ptu_pedido_aut_anexo.qt_dose_total%type;
qt_dose_dia_w			ptu_pedido_aut_anexo.qt_dose_dia%type;
nr_campos_w			ptu_pedido_aut_anexo.nr_campos%type;
dt_inicio_previsto_w		ptu_pedido_aut_anexo.dt_inicio_previsto%type;
qt_dias_previsto_w		ptu_pedido_aut_anexo.qt_dias_previsto%type;
ie_tipo_anexo_w			pls_guia_plano_proc.ie_tipo_anexo%type;
ds_obs_pedido_aut_w		ptu_pedido_aut_anexo.ds_observacao%type;
qt_reg_anex_guia_proc_w		integer;
qt_reg_anex_guia_mat_w		integer;
nr_seq_lote_guia_w		pls_lote_anexo_guias_aut.nr_sequencia%type;
nr_seq_lote_proc_w		pls_lote_anexo_proc_aut.nr_sequencia%type;
nr_seq_lote_mat_w		pls_lote_anexo_mat_aut.nr_sequencia%type;
dt_prevista_w			ptu_pedido_aut_servico.dt_provavel%type;
ie_via_administracao_w		pls_lote_anexo_mat_aut.ie_via_administracao%type;
ie_frequencia_dose_w		ptu_pedido_aut_servico.qt_frequencia_adm%type;
cd_anvisa_w			ptu_pedido_aut_servico.cd_anvisa%type;
cd_referencia_fab_w		ptu_pedido_aut_servico.cd_referencia_fab%type;
ie_tipo_ordem_w     	pls_lote_anexo_mat_aut.ie_opcao_fabricante%type;
nr_dia_ciclo_atual_w		ptu_pedido_aut_anexo.nr_dia_ciclo_atual%type;
qt_unidade_medida_w		ptu_pedido_aut_servico.qt_unidade_medida%type;
qt_dosagem_total_w		ptu_pedido_aut_servico.qt_dosagem_total%type;

c01 CURSOR FOR 
	SELECT	nr_sequencia 
	from	pls_guia_plano_proc 
	where	nr_seq_guia	= nr_seq_guia_p 
	and	ie_tipo_anexo	= ie_tipo_anexo_w;
	
c02 CURSOR FOR 
	SELECT	nr_sequencia 
	from	pls_guia_plano_mat 
	where	nr_seq_guia	= nr_seq_guia_p 
	and	ie_tipo_anexo	= ie_tipo_anexo_w;

BEGIN 
if (nr_seq_guia_p IS NOT NULL AND nr_seq_guia_p::text <> '') then 
	select	cd_guia, 
		dt_autorizacao, 
		ie_recem_nascido, 
		nr_seq_guia_principal, 
		ie_status, 
		dt_solicitacao, 
		cd_senha, 
		substr(pls_obter_dados_segurado(nr_seq_segurado,'CR'),1,255) cd_usuario_plano, 
		--substr(pls_obter_dados_segurado(nr_seq_segurado,'N'),1,255) nm_beneficiario, 
		nr_seq_segurado 
	into STRICT	cd_guia_w, 
		dt_autorizacao_w, 
		ie_recem_nascido_w, 
		nr_seq_guia_principal_w, 
		ie_status_w, 
		dt_solicitacao_w, 
		cd_senha_w, 
		cd_usuario_plano_w, 
		--nm_beneficiario_w, 
		nr_seq_segurado_w 
	from	pls_guia_plano 
	where	nr_sequencia	= nr_seq_guia_p;
		 
	if (nr_seq_guia_principal_w IS NOT NULL AND nr_seq_guia_principal_w::text <> '') then 
		select	cd_guia 
		into STRICT	cd_guia_referencia_w 
		from	pls_guia_plano 
		where	nr_sequencia	= nr_seq_guia_principal_w;
	end if;
 
	begin 
		select	CASE WHEN a.ie_sexo='M' THEN '1'  ELSE '3' END , 
			obter_idade(a.dt_nascimento,clock_timestamp(),'A') qt_idade, 
			a.nm_pessoa_fisica 
		into STRICT	ie_sexo_w, 
			qt_idade_w, 
			nm_beneficiario_w 
		from	pessoa_fisica a, 
			pls_segurado b 
		where	a.cd_pessoa_fisica	= b.cd_pessoa_fisica 
		and	b.nr_sequencia		= nr_seq_segurado_w;
	exception 
	when others then 
		ie_sexo_w		:= null;
		qt_idade_w		:= null;
		nm_beneficiario_w	:= null;
	end;
	 
	 
	select	nm_profissional_solic, 
		nr_telef_prof_solic, 
		ds_justificativa, 
		ds_email_prof_solic, 
		ds_especificacao, 
		qt_peso, 
		qt_altura, 
		qt_superficie_corporal, 
		ds_procedimento_cirurgico, 
		dt_real_proc_cirurgico, 
		ds_area_irradiada, 
		dt_radioterapia, 
		nr_ciclo_previsto, 
		nr_ciclo_atual, 
		qt_intervalo_ciclo, 
		ds_quimioterapia, 
		dt_quimioterapia, 
		qt_dose_total, 
		qt_dose_dia, 
		nr_campos, 
		dt_inicio_previsto, 
		qt_dias_previsto, 
		ie_tipo_anexo, 
		substr(ds_observacao,1,500), 
		nr_dia_ciclo_atual 
	into STRICT	nm_profissional_solic_w, 
		nr_telef_prof_solic_w, 
		ds_justificativa_w, 
		ds_email_prof_solic_w, 
		ds_especificacao_w, 
		qt_peso_w, 
		qt_altura_w, 
		qt_superficie_corporal_w, 
		ds_procedimento_cirurgico_w, 
		dt_real_proc_cirurgico_w, 
		ds_area_irradiada_w, 
		dt_radioterapia_w, 
		nr_ciclo_previsto_w, 
		nr_ciclo_atual_w, 
		qt_intervalo_ciclo_w, 
		ds_quimioterapia_w, 
		dt_quimioterapia_w, 
		qt_dose_total_w, 
		qt_dose_dia_w, 
		nr_campos_w, 
		dt_inicio_previsto_w, 
		qt_dias_previsto_w, 
		ie_tipo_anexo_w, 
		ds_obs_pedido_aut_w, 
		nr_dia_ciclo_atual_w 
	from	ptu_pedido_aut_anexo 
	where	nr_sequencia	= nr_seq_pedido_anexo_p;
	 
	 
	select	max(nr_sequencia) 
	into STRICT	nr_seq_lote_anexo_guia_w 
	from	pls_lote_anexo_guias_aut 
	where	nr_seq_guia	= nr_seq_guia_p 
	and	ie_tipo_anexo	= ie_tipo_anexo_w;
	 
	if (coalesce(nr_seq_lote_anexo_guia_w::text, '') = '') then 
		select	nextval('pls_lote_anexo_guias_aut_seq') 
		into STRICT	nr_seq_lote_anexo_guia_w 
		;
 
		insert 	into pls_lote_anexo_guias_aut(nr_sequencia, nr_seq_lote_anexo, dt_atualizacao, 
			 nm_usuario, dt_atualizacao_nrec, nm_usuario_nrec, 
			 cd_ans, cd_guia, cd_guia_prestador, 
			 cd_guia_referencia, dt_solicitacao, cd_senha, 
			 dt_autorizacao, cd_usuario_plano, ie_recem_nascido, 
			 nm_beneficiario, cd_cnes, ds_biometria, 
			 nm_profissional_solic, nr_telef_prof_solic, ds_justificativa, 
			 ds_email_prof_solic, ds_especificacao, qt_peso, 
			 qt_altura, qt_superficie_corporal, qt_idade_benef, 
			 ie_sexo, ds_procedimento_cirurgico, dt_real_proc_cirurgico, 
			 ds_area_irradiada, dt_radioterapia, nr_ciclo_previsto, 
			 nr_ciclo_atual, qt_intervalo_ciclo, ds_quimioterapia, 
			 dt_quimioterapia, qt_dose_total, qt_dose_dia, 
			 nr_campos, dt_inicio_previsto, qt_dias_previsto, 
			 nr_seq_guia, ie_tipo_anexo, ie_status, 
			 nr_seq_guia_principal, qt_campo_irradiacao, ds_observacao, 
			 nr_dia_ciclo_atual) 
		values (nr_seq_lote_anexo_guia_w, null, clock_timestamp(), 
			 nm_usuario_p, clock_timestamp(), nm_usuario_p, 
			 null, cd_guia_w, null, 
			 cd_guia_referencia_w, dt_solicitacao_w, cd_senha_w, 
			 dt_autorizacao_w, cd_usuario_plano_w, ie_recem_nascido_w, 
			 nm_beneficiario_w, null, ds_biometria_p, 
			 nm_profissional_solic_w, nr_telef_prof_solic_w, ds_justificativa_w, 
			 ds_email_prof_solic_w, ds_especificacao_w, qt_peso_w, 
			 qt_altura_w, qt_superficie_corporal_w, qt_idade_w, 
			 ie_sexo_w, ds_procedimento_cirurgico_w, dt_real_proc_cirurgico_w, 
			 ds_area_irradiada_w, dt_radioterapia_w, nr_ciclo_previsto_w, 
			 nr_ciclo_atual_w, qt_intervalo_ciclo_w, ds_quimioterapia_w, 
			 dt_quimioterapia_w, qt_dose_total_w, qt_dose_dia_w, 
			 nr_campos_w, dt_inicio_previsto_w, qt_dias_previsto_w, 
			 nr_seq_guia_p, ie_tipo_anexo_w, ie_status_w, 
			 nr_seq_guia_principal_w, null, ds_obs_pedido_aut_w, 
			 nr_dia_ciclo_atual_w);
			 
		insert	into pls_lote_anexo_diag_aut(nr_sequencia, nr_seq_lote_anexo_guia, dt_atualizacao, 
			 nm_usuario, dt_atualizacao_nrec, nm_usuario_nrec, 
			 ie_classificacao, cd_doenca, dt_diagnostico, 
			 ie_estadia_tumor, ie_tipo_quimioterapia, cd_finalidade_tratamento, 
			 ie_capacidade_funcional, ds_plano_terapeutico, ds_diagnostico, 
			 cd_diagnostico_imagem, ds_observacao, ie_tipo_diagnostico, 
			 ie_metastases, ie_nodulo, ie_tumor) 
		(SELECT	nextval('pls_lote_anexo_diag_aut_seq'), nr_seq_lote_anexo_guia_w, clock_timestamp(), 
			nm_usuario_p, clock_timestamp(), nm_usuario_p, 
			'', cd_doenca, dt_diagnostico, 
			ie_estadia_tumor, ie_tipo_quimioterapia, cd_finalidade_tratamento, 
			ie_capacidade_funcional, ds_plano_terapeutico, ds_diagnostico, 
			cd_diagnostico_imagem, ds_observacao, ie_tipo_diagnostico, 
			ie_metastases, ie_nodulo, ie_tumor 
		from	ptu_pedido_aut_diag_anexo 
		where	nr_seq_pedido_anexo	= nr_seq_pedido_anexo_p);	
		 
		update	pls_guia_plano 
		set	ie_anexo_guia	= 'S' 
		where	nr_sequencia	= nr_seq_guia_p;
	end if;
 
	for	r_c01_w in c01	loop 
		select	nr_sequencia 
		into STRICT	nr_seq_lote_guia_w 
		from  pls_lote_anexo_guias_aut 
		where  nr_seq_guia	= nr_seq_guia_p 
		and	ie_tipo_anexo	= ie_tipo_anexo_w;
 
		begin 
			select	dt_provavel 
			into STRICT	dt_prevista_w 
			from	ptu_pedido_aut_servico 
			where	nr_seq_guia_proc	= r_c01_w.nr_sequencia;
		exception 
		when others then 
			select	dt_provavel 
			into STRICT	dt_prevista_w 
			from	ptu_pedido_compl_aut_serv 
			where	nr_seq_guia_proc	= r_c01_w.nr_sequencia;
		end;
		 
		select	nextval('pls_lote_anexo_proc_aut_seq') 
		into STRICT	nr_seq_lote_proc_w 
		;
 
		insert into pls_lote_anexo_proc_aut(dt_atualizacao, nm_usuario, dt_atualizacao_nrec, 
			 nm_usuario_nrec, cd_procedimento, ie_origem_proced, 
			 ie_status, nr_seq_plano_proc, nr_seq_lote_anexo_guia, 
			 nr_sequencia, dt_prev_realizacao) 
		(SELECT clock_timestamp(), nm_usuario_p, clock_timestamp(), 
			 nm_usuario_p, cd_procedimento, ie_origem_proced, 
			 ie_status, nr_sequencia, nr_seq_lote_guia_w, 
			 nr_seq_lote_proc_w, dt_prevista_w 
		 from	 pls_guia_plano_proc 
		 where	 nr_sequencia = r_c01_w.nr_sequencia);
	end loop;
 
	for	r_c02_w in c02	loop 
		select	nr_sequencia 
		into STRICT	nr_seq_lote_guia_w 
		from  pls_lote_anexo_guias_aut 
		where  nr_seq_guia	= nr_seq_guia_p 
		and	ie_tipo_anexo	= ie_tipo_anexo_w;
 
		select	nextval('pls_lote_anexo_mat_aut_seq') 
		into STRICT	nr_seq_lote_mat_w 
		;
		 
		begin 
			select	dt_provavel, 
				lpad(cd_via_administracao,2,'0'), 
				qt_frequencia_adm, 
				cd_anvisa, 
				cd_referencia_fab, 
				to_char(ie_tipo_ordem), 
				qt_unidade_medida, 
				qt_dosagem_total 
			into STRICT	dt_prevista_w, 
				ie_via_administracao_w, 
				ie_frequencia_dose_w, 
				cd_anvisa_w, 
				cd_referencia_fab_w, 
				ie_tipo_ordem_w, 
				qt_unidade_medida_w, 
				qt_dosagem_total_w 
			from	ptu_pedido_compl_aut_serv 
			where	nr_seq_guia_mat	= r_c02_w.nr_sequencia;
		exception 
		when others then 
			select	dt_provavel, 
				lpad(cd_via_administracao,2,'0'), 
				qt_frequencia_adm, 
				cd_anvisa, 
				cd_referencia_fab, 
				to_char(ie_tipo_ordem), 
				qt_unidade_medida, 
				qt_dosagem_total 
			into STRICT	dt_prevista_w, 
				ie_via_administracao_w, 
				ie_frequencia_dose_w, 
				cd_anvisa_w, 
				cd_referencia_fab_w, 
				ie_tipo_ordem_w, 
				qt_unidade_medida_w, 
				qt_dosagem_total_w 
			from	ptu_pedido_aut_servico 
			where	nr_seq_guia_mat	= r_c02_w.nr_sequencia;
		end;
		 
		insert into pls_lote_anexo_mat_aut(cd_tipo_tabela_imp, dt_atualizacao, dt_atualizacao_nrec, 
			 ie_status, nm_usuario, nm_usuario_nrec , nr_seq_lote_anexo_guia, 
			 nr_seq_plano_mat, nr_sequencia, nr_seq_material, 
			 dt_prevista, ie_via_administracao, ie_frequencia_dose, 
			 cd_ref_fabricante_imp, nr_registro_anvisa,ie_opcao_fabricante, 
			 qt_unidade_medida, qt_dosagem_total) 
		(SELECT cd_tipo_tabela_imp, clock_timestamp(), clock_timestamp(), 
			 ie_status, nm_usuario_p, nm_usuario_p , nr_seq_lote_guia_w, 
			 nr_sequencia, nr_seq_lote_mat_w, nr_seq_material, 
			 dt_prevista_w, ie_via_administracao_w, ie_frequencia_dose_w, 
			 cd_referencia_fab_w, cd_anvisa_w, ie_tipo_ordem_w, 
			 qt_unidade_medida_w, qt_dosagem_total_w 
		 from 	 pls_guia_plano_mat 
		 where 	 nr_sequencia = r_c02_w.nr_sequencia);
	end loop;
end if;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ptu_inserir_dados_anexo_guia ( nr_seq_guia_p pls_guia_plano.nr_sequencia%type, nr_seq_pedido_anexo_p ptu_pedido_aut_anexo.nr_sequencia%type, ds_biometria_p pls_lote_anexo_guias_aut.ds_biometria%type, nm_usuario_p text) FROM PUBLIC;

