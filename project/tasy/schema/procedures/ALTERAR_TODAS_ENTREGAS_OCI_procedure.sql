-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE alterar_todas_entregas_oci ( nr_ordem_compra_p bigint, ie_opcao_prevista_p bigint, dt_prevista_entrega_p timestamp, ie_opcao_limite_p bigint, dt_entrega_limite_p timestamp, nm_usuario_p text) AS $body$
DECLARE


qt_register_w          bigint;
dt_expected_delivery_w ordem_compra_item_entrega.dt_prevista_entrega%type;

c01 CURSOR FOR
SELECT nr_item_oci
from ordem_compra_item
where nr_ordem_compra = nr_ordem_compra_p;

BEGIN

if (ie_opcao_prevista_p = 0) then
	dt_expected_delivery_w := dt_prevista_entrega_p;
elsif (ie_opcao_prevista_p = 1) then
	dt_expected_delivery_w := coalesce(dt_entrega_limite_p,clock_timestamp());
end if;

if (dt_expected_delivery_w IS NOT NULL AND dt_expected_delivery_w::text <> '') then
	for item in c01
	loop
		select count(*)
		into STRICT qt_register_w
		from ordem_compra_item_entrega
		where nr_ordem_compra = nr_ordem_compra_p
		and nr_item_oci = item.nr_item_oci
		and trunc(dt_prevista_entrega) = trunc(dt_expected_delivery_w);

		if (qt_register_w = 0) then
			update   ordem_compra_item_entrega
			set	dt_prevista_entrega	= dt_expected_delivery_w
			where	nr_ordem_compra	= nr_ordem_compra_p
			and nr_item_oci = item.nr_item_oci  LIMIT 1;
		end if;
	end loop;

    CALL inserir_historico_ordem_compra(
		nr_ordem_compra_p,
		'S',
		WHEB_MENSAGEM_PCK.get_texto(297106),
		WHEB_MENSAGEM_PCK.get_texto(297107,'DT_PARAMETRO_P='||to_char(dt_expected_delivery_w,'dd/mm/yyyy')),
		nm_usuario_p);
 end if;

if (ie_opcao_limite_p = 0) then
	update	ordem_compra_item_entrega
	set	dt_entrega_limite	= dt_entrega_limite_p
	where	nr_ordem_compra	= nr_ordem_compra_p;
	
	CALL inserir_historico_ordem_compra(
		nr_ordem_compra_p,
		'S',
		WHEB_MENSAGEM_PCK.get_texto(297131),
		WHEB_MENSAGEM_PCK.get_texto(297132,'DT_PARAMETRO_P='||to_char(dt_entrega_limite_p,'dd/mm/yyyy')),
		nm_usuario_p);
	
elsif (ie_opcao_limite_p = 1) then
	update   ordem_compra_item_entrega
	set	dt_entrega_limite	= dt_prevista_entrega_p
	where	nr_ordem_compra	= nr_ordem_compra_p;
	
	CALL inserir_historico_ordem_compra(
		nr_ordem_compra_p,
		'S',
		WHEB_MENSAGEM_PCK.get_texto(297131),
		WHEB_MENSAGEM_PCK.get_texto(297132,'DT_PARAMETRO_P='||to_char(dt_prevista_entrega_p,'dd/mm/yyyy')),
		nm_usuario_p);
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE alterar_todas_entregas_oci ( nr_ordem_compra_p bigint, ie_opcao_prevista_p bigint, dt_prevista_entrega_p timestamp, ie_opcao_limite_p bigint, dt_entrega_limite_p timestamp, nm_usuario_p text) FROM PUBLIC;

