-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';



--
-- dblink wrapper to call function integrar_matrix_ws_v7 as an autonomous transaction
--
CREATE EXTENSION IF NOT EXISTS dblink;

CREATE OR REPLACE PROCEDURE integrar_matrix_ws_v7 (nr_seq_evento_p bigint, nr_prescricao_p bigint default 0, nr_seq_prescricao_p bigint default 0, nr_atendimento_p bigint default 0, nr_seq_exame_p bigint default 0, cd_material_exame_p text default null) AS $body$
DECLARE
	-- Change this to reflect the dblink connection string
	v_conn_str  text := format('port=%s dbname=%s user=%s', current_setting('port'), current_database(), current_user);
	v_query     text;

BEGIN
	v_query := 'CALL integrar_matrix_ws_v7_atx ( ' || quote_nullable(nr_seq_evento_p) || ',' || quote_nullable(nr_prescricao_p) || ',' || quote_nullable(nr_seq_prescricao_p) || ',' || quote_nullable(nr_atendimento_p) || ',' || quote_nullable(nr_seq_exame_p) || ',' || quote_nullable(cd_material_exame_p) || ' )';
	PERFORM * FROM dblink(v_conn_str, v_query) AS p (ret boolean);

END;
$body$ LANGUAGE plpgsql SECURITY DEFINER;




CREATE OR REPLACE PROCEDURE integrar_matrix_ws_v7_atx (nr_seq_evento_p bigint, nr_prescricao_p bigint default 0, nr_seq_prescricao_p bigint default 0, nr_atendimento_p bigint default 0, nr_seq_exame_p bigint default 0, cd_material_exame_p text default null) AS $body$
DECLARE
ie_operacao_w varchar(1);
ds_parametro_w varchar(100);
ie_realizar_integracao_w varchar(1) := 'N';

BEGIN
																		
if (OBTER_SE_INTEGRACAO_ATIVA(nr_seq_evento_p,53) = 'S') then

   if (nr_seq_evento_p in (885,886)) then
      if nr_seq_evento_p in (886) then
         ie_operacao_w := 'E';
         select	CASE WHEN count(*)=0 THEN 'N'  ELSE 'S' END
         into STRICT	  ie_realizar_integracao_w
         from	  lab_exame_equip a,
                equipamento_lab b
         where	a.nr_seq_exame = nr_seq_exame_p
         and 	  a.cd_equipamento = b.cd_equipamento
         and 	  b.ds_sigla = 'MATRIX';
      else
		 ie_operacao_w := 'I';
         if (coalesce(cd_material_exame_p::text, '') = '') then
           select  CASE WHEN count(*)=0 THEN 'N'  ELSE 'S' END
           into STRICT	   ie_realizar_integracao_w
           from	   matrix_pedido_ws_v7_v a
           where   a.nr_prescricao = nr_prescricao_p
           and    exists (SELECT 1 
	                        from   matrix_procedimento_ws_v b 
	                        where  a.nr_prescricao = b.numero_atendimento);
         else           
           SELECT  CASE WHEN count(*)=0 THEN 'N'  ELSE 'S' END 
           into STRICT	   ie_realizar_integracao_w
           FROM material_exame_lab g, lab_exame_equip e, exame_laboratorio d, atendimento_paciente a, prescr_medica b
LEFT OUTER JOIN setor_atendimento f ON (b.cd_setor_atendimento = f.cd_setor_atendimento)
WHERE a.nr_atendimento = b.nr_atendimento AND b.nr_prescricao = nr_prescricao_p AND d.nr_seq_exame = nr_seq_exame_p AND g.cd_material_exame = cd_material_exame_p AND d.nr_seq_exame = e.nr_seq_exame  and (f.cd_setor_externo IS NOT NULL AND f.cd_setor_externo::text <> '') AND e.cd_equipamento = f.cd_equipamento AND CASE WHEN coalesce(e.nr_seq_material::text, '') = '' THEN  g.nr_sequencia  ELSE e.nr_seq_material END  = g.nr_sequencia AND f.ds_sigla = 'MATRIX';
         end if;
      end if;

      ds_parametro_w := 'nr_prescricao='||nr_prescricao_p||';ie_operacao='||ie_operacao_w||';nr_sequencia='||nr_seq_prescricao_p||';';
   end if;

   if (nr_seq_evento_p = 887) then
      select CASE WHEN count(1)=0 THEN 'N'  ELSE 'S' END
      into STRICT	 ie_realizar_integracao_w
      FROM atend_paciente_unidade apu, atendimento_paciente ap, prescr_medica pm
LEFT OUTER JOIN pf_codigo_externo pce ON (pm.cd_pessoa_fisica = pce.cd_pessoa_fisica AND 'MX' = pce.ie_tipo_codigo_externo)
WHERE pm.nr_atendimento = nr_atendimento_p and ap.nr_atendimento = pm.nr_atendimento and ap.ie_tipo_atendimento = 1  and apu.nr_seq_interno = (SELECT	coalesce(max(nr_seq_interno),0)
                                   from 	atend_paciente_unidade a
                                   where	a.nr_atendimento 		= ap.nr_atendimento
                                   and 	  coalesce(a.dt_saida_unidade, a.dt_entrada_unidade + 9999)	= (select max(coalesce(b.dt_saida_unidade, b.dt_entrada_unidade + 9999))
                                                                                                   from   atend_paciente_unidade b
                                                                                                   where  b.nr_atendimento 	= ap.nr_atendimento))  and apu.nr_atendimento = pm.nr_atendimento and exists (select 1 
               from   matrix_procedimento_ws_v b 
               where  b.numero_Atendimento = pm.nr_prescricao);

      ds_parametro_w := 'numero_atendimento='||nr_atendimento_p||';';
   end if;
end if;

if (ie_realizar_integracao_w = 'S') then
   CALL gravar_agend_integracao(nr_seq_evento_p => nr_seq_evento_p, ds_parametros_p => ds_parametro_w);
end if;

if (coalesce(wheb_usuario_pck.get_ie_commit, 'S') = 'S') then
    commit;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE integrar_matrix_ws_v7 (nr_seq_evento_p bigint, nr_prescricao_p bigint default 0, nr_seq_prescricao_p bigint default 0, nr_atendimento_p bigint default 0, nr_seq_exame_p bigint default 0, cd_material_exame_p text default null) FROM PUBLIC; -- REVOKE ALL ON PROCEDURE integrar_matrix_ws_v7_atx (nr_seq_evento_p bigint, nr_prescricao_p bigint default 0, nr_seq_prescricao_p bigint default 0, nr_atendimento_p bigint default 0, nr_seq_exame_p bigint default 0, cd_material_exame_p text default null) FROM PUBLIC;

