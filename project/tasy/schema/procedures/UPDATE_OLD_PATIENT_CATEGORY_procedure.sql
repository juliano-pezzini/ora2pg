-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE update_old_patient_category ( nr_atendimento_p bigint, nr_sequencia_p bigint ) AS $body$
DECLARE


	dt_start_category_w timestamp;
	dt_start_category_ww timestamp;
	dt_end_category_ww timestamp;
	dt_end_category_w timestamp;
	dt_alta_w timestamp;
	nr_sequencia_ww patient_category_log.nr_sequencia%type:=0;
	nr_seq_pat_cat_new_w patient_category_log.nr_seq_patient_category_new%type:=0;
	nr_seq_pat_cat_new_www patient_category_log.nr_seq_patient_category_new%type:=0;
	nr_seq_pat_cat_old_w patient_category_log.nr_seq_patient_category_old%type:=0;
	qt_error smallint:=0;

BEGIN
    if (nr_atendimento_p IS NOT NULL AND nr_atendimento_p::text <> '' AND nr_sequencia_p IS NOT NULL AND nr_sequencia_p::text <> '') then
        begin
            SELECT max(dt_start_category), max(nr_seq_patient_category_new), max(dt_end_category), max(nr_seq_patient_category_old)
            into STRICT dt_start_category_w, nr_seq_pat_cat_new_w, dt_end_category_w, nr_seq_pat_cat_old_w
            FROM patient_category_log
            where nr_atendimento=nr_atendimento_p
            and nr_sequencia=nr_sequencia_p;
        exception when no_data_found then
                qt_error:=1;
        end;
        begin
            select	CASE WHEN OBTER_SE_ATENDIMENTO_ALTA(nr_atendimento_p)='S' THEN  max(dt_alta) WHEN OBTER_SE_ATENDIMENTO_ALTA(nr_atendimento_p)='N' THEN  max(clock_timestamp()) END
            into STRICT	dt_alta_w
            from	atendimento_paciente
            where	nr_atendimento = nr_atendimento_p;
        exception when no_data_found then
            qt_error:=1;
        end;
        if (trunc(dt_start_category_w)= trunc(obter_data_entrada(nr_atendimento_p))) then

            select min(dt_start_category),min(nr_sequencia)
            into STRICT dt_start_category_ww, nr_sequencia_ww
            from patient_category_log
            where nr_atendimento=nr_atendimento_p
            and dt_start_category > trunc(dt_start_category_w);
			if (dt_start_category_ww IS NOT NULL AND dt_start_category_ww::text <> '' AND nr_sequencia_ww IS NOT NULL AND nr_sequencia_ww::text <> '') then
				update patient_category_log
				set nr_seq_patient_category_old = nr_seq_pat_cat_new_w,
						 dt_atualizacao = clock_timestamp(),
						  nm_usuario = coalesce(wheb_usuario_pck.get_nm_usuario,'TASY1')
						  where nr_atendimento=nr_atendimento_p
						  and nr_sequencia = nr_sequencia_ww;
						
			    commit;
			end if;
        else
            select max(dt_end_category)
            into STRICT dt_end_category_ww
            from patient_category_log
            where nr_atendimento=nr_atendimento_p
            and dt_end_category < trunc(dt_end_category_w);

            select max(nr_seq_patient_category_new)
            into STRICT  nr_seq_pat_cat_new_www
            from patient_category_log
            where trunc(dt_end_category)=trunc(dt_end_category_ww)
            and nr_atendimento=nr_atendimento_p;

            update patient_category_log
            set nr_seq_patient_category_old = nr_seq_pat_cat_new_www,
                     dt_atualizacao = clock_timestamp(),
                      nm_usuario = coalesce(wheb_usuario_pck.get_nm_usuario,'TASY1')
                      where nr_atendimento=nr_atendimento_p
                      and nr_sequencia = nr_sequencia_p;
            commit;
        end if;
    end if;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE update_old_patient_category ( nr_atendimento_p bigint, nr_sequencia_p bigint ) FROM PUBLIC;

