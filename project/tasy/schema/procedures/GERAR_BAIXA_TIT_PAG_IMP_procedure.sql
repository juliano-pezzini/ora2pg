-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_baixa_tit_pag_imp ( nr_titulo_p titulo_pagar.nr_titulo%type, nm_usuario_p usuario.nm_usuario%type) AS $body$
DECLARE


vl_baixa_w		            titulo_receber_trib_baixa.vl_baixa%type;
vl_saldo_tributo_w	        titulo_receber_trib.vl_saldo%type;
cd_estabelecimento_w        parametros_contas_pagar.cd_estabelecimento%type;
cd_tipo_baixa_w             parametros_contas_pagar.cd_tipo_baixa_padrao%type;
nr_titulo_pagar_w           titulo_receber_trib_baixa.nr_titulo%type;
nr_seq_tit_rec_tib_baixa_w  titulo_receber_trib_baixa.nr_sequencia%type;

c01 CURSOR FOR
SELECT  c.vl_baixa, 
        a.nr_titulo,
        c.nr_sequencia
from    titulo_pagar a,
        titulo_receber_trib b,
        titulo_receber_trib_baixa c
where   a.nr_seq_tit_rec_trib = b.nr_sequencia
and     b.nr_sequencia = c.nr_seq_tit_trib
and     coalesce(c.ie_baixa_tit_pag::text, '') = ''
and     c.nr_titulo = nr_titulo_p;


BEGIN
cd_estabelecimento_w := Obter_estab_usuario(nm_usuario_p);

begin
select	cd_tipo_baixa_padrao
into STRICT	cd_tipo_baixa_w
from	parametros_contas_pagar
where	cd_estabelecimento	= cd_estabelecimento_w;
exception
    when no_data_found then
        cd_tipo_baixa_w := 1;
    when too_many_rows then
        raise;
end;

open c01;
loop
fetch c01 into
    vl_baixa_w,
    nr_titulo_pagar_w,
    nr_seq_tit_rec_tib_baixa_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
    CALL baixa_titulo_pagar( cd_estabelecimento_p     => cd_estabelecimento_w,
                        cd_tipo_baixa_p          => cd_tipo_baixa_w,
                        nr_titulo_p              => nr_titulo_pagar_w,
                        vl_baixa_p               => vl_baixa_w,
                        nm_usuario_p             => nm_usuario_p,
                        nr_seq_trans_financ_p    => null,
                        nr_bordero_p             => null,
                        nr_seq_escrit_p          => null,
                        dt_transacao_p           => clock_timestamp(),
                        nr_seq_conta_banco_p     => null);

    CALL atualizar_saldo_tit_pagar(  nr_titulo_p     => nr_titulo_pagar_w,
                                nm_usuario_p    => nm_usuario_p);
                                    
    update titulo_receber_trib_baixa
    set ie_baixa_tit_pag = 'S'
    where nr_sequencia = nr_seq_tit_rec_tib_baixa_w;
end loop;
close c01;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_baixa_tit_pag_imp ( nr_titulo_p titulo_pagar.nr_titulo%type, nm_usuario_p usuario.nm_usuario%type) FROM PUBLIC;

