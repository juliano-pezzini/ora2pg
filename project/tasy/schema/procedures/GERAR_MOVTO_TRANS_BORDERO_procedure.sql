-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_movto_trans_bordero ( nr_bordero_p bigint, cd_estabelecimento_p bigint, dt_transacao_p timestamp, dt_pagto_cheque_p timestamp, ie_acao_p text, nm_usuario_p text) AS $body$
DECLARE

/*ie_acao_p
	'I' inclusao da baixa
	'E' exclusao da baixa*/
ie_atualiza_dtpagto_cheque_w	varchar(255);
ds_transacao_w			varchar(255);
nr_cheque_w			varchar(20)	:= null;
ie_bordero_banco_w		varchar(5);
ie_lib_bordero_w		varchar(1)	:= 'N';
nr_documento_w			numeric(20);
vl_saldo_bordero_w		double precision;
vl_borero_w			double precision;
vl_cheque_w			double precision;
vl_imposto_bordero_w		double precision;
vl_bordero_w			double precision;
vl_acrescimos_w			double precision;
vl_descontos_w			double precision;
vl_imposto_div_w		double precision;
nr_seq_trans_tit_bordero_w	bigint;
nr_seq_movto_orig_w		bigint;
ie_estorno_w			varchar(1);
nr_seq_trans_fin_baixa_w	bigint;
nr_seq_trans_w			bigint;
nr_seq_movto_w			bigint;
nr_seq_conta_banco_w		bigint;
nr_titulo_w			bigint;
nr_seq_cheque_w			bigint;
nr_seq_trans_cheque_cp_w	bigint;
cont_w				bigint;
qt_registro_w			bigint;
qt_divisor_w			bigint;
nr_titulo_ww			bigint;
cd_tipo_baixa_w			integer;
nr_sequencia_w			integer;
ie_acao_w			smallint;
dt_compensacao_w		timestamp;
dt_liberacao_w			timestamp;
nr_seq_tf_tipo_baixa_w		bigint;
ie_tf_tipo_baixa_w		varchar(1);
CD_CGC_DESTINATARIO_w		varchar(255);
CD_PESSOA_DESTINATARIO_w	varchar(255);
IE_GERAR_TRIB_TEMP_w		varchar(255);
nr_titulo_bordero_w		bigint;
vl_impost_bord_w		double precision;
vl_tributos_bord_w		double precision;
ie_trans_fin_baixa_tit_w	varchar(1);	
ie_busca_baixa_trans_w		varchar(2);
ie_data_baixa_vencimento_w	varchar(1);
dt_vencimento_atual_w		timestamp;
nr_seq_trans_financ_w		bordero_tit_pagar.nr_seq_trans_financ%type;
vl_transacao_w			movto_trans_financ.vl_transacao%type;
/* Projeto Multimoeda - Variaveis */

vl_bordero_estrang_w		double precision;
vl_complemento_w		double precision;
vl_cotacao_bordero_w		double precision;
cd_moeda_bordero_w		integer;
vl_cheque_estrang_w		double precision;
vl_cotacao_cheque_w		cotacao_moeda.vl_cotacao%type;
cd_moeda_cheque_w		integer;
vl_saldo_estrang_w		double precision;
ie_forma_gerar_trib_w	varchar(1);
nr_titulo_trib_w		titulo_pagar.nr_titulo%type;
nr_seq_cheque_baixa_w	cheque_bordero_titulo.nr_seq_cheque%type;
nr_seq_baixa_w			titulo_pagar_baixa.nr_sequencia%type;
qt_tit_trib_w			bigint;
nr_seq_movto_bco_w		movto_trans_financ.nr_sequencia%type;
cd_centro_custo_w		titulo_pagar_bordero_v.cd_centro_custo%type;
cd_pessoa_fisica_w      titulo_pagar_bordero_v.cd_pessoa_fisica%type;
cd_cgc_w                titulo_pagar_bordero_v.cd_cgc%type;


C01 CURSOR FOR
	SELECT	a.nr_titulo,
		a.dt_vencimento_atual,
		a.vl_bordero,
		a.nr_seq_trans_fin_baixa,
		a.nr_documento,
		coalesce(a.vl_juros_bordero,0) + coalesce(a.vl_multa_bordero,0) + coalesce(a.vl_out_desp_bordero,0),
		coalesce(a.vl_desconto_bordero,0),
		b.cd_cgc,
		b.cd_pessoa_fisica,
		a.nr_seq_trans_financ,
		a.vl_bordero_estrang,
		a.cd_centro_custo
	from	titulo_pagar b,
		titulo_pagar_bordero_v a
	where	a.nr_titulo	= b.nr_titulo
	and	a.nr_bordero	= nr_bordero_p;

C02 CURSOR FOR
	SELECT	a.nr_sequencia,
		a.vl_cheque,
		a.nr_cheque,
		a.CD_CGC_DESTINATARIO,
		a.CD_PESSOA_DESTINATARIO,
		a.vl_cheque_estrang,
		a.vl_cotacao,
		a.cd_moeda
	from	cheque a
	where	coalesce(a.dt_cancelamento::text, '') = ''
	and	a.nr_sequencia in (	SELECT	x.nr_seq_cheque
					from	cheque_bordero_titulo x
					where	x.nr_bordero		= nr_bordero_p);

C03 CURSOR FOR
	SELECT	coalesce(sum(vl_bordero),0) + coalesce(sum(vl_juros_bordero),0) + coalesce(sum(vl_multa_bordero),0) +
		coalesce(sum(vl_out_desp_bordero),0) - coalesce(sum(vl_desconto_bordero),0) vl_transacao,
		coalesce(nr_seq_trans_fin_baixa,nr_seq_trans_tit_bordero_w) nr_seq_trans_fin,
		coalesce(sum(vl_bordero_estrang),0) vl_transacao_estrang
	from	titulo_pagar_bordero_v
	where	nr_bordero	= nr_bordero_p
	group	by nr_seq_trans_fin_baixa;
	
C04 CURSOR FOR
	/*select	nr_titulo
	from	titulo_pagar_bordero_v
	where	nr_bordero = nr_bordero_p; OS 1258214 - Troquei pois precisa verificar se existe imposto nessa tabela temp para titulos q n estao mais no bordero*/
	SELECT	nr_titulo
	from	w_titulo_pagar_imposto
	where	nr_bordero = nr_bordero_p
	group by nr_titulo;


C05 CURSOR FOR
	SELECT	coalesce(sum(vl_bordero),0) + coalesce(sum(vl_juros_bordero),0) + coalesce(sum(vl_multa_bordero),0) +
		coalesce(sum(vl_out_desp_bordero),0) - coalesce(sum(vl_desconto_bordero),0) vl_transacao,
		coalesce(sum(vl_bordero_estrang),0) vl_transacao_estrang,
        cd_pessoa_fisica,
        cd_cgc
	from	titulo_pagar_bordero_v
	where	nr_bordero	= nr_bordero_p
	group    by cd_pessoa_fisica, cd_cgc;


BEGIN
-- afstringari 179820 23/11/2009
ie_atualiza_dtpagto_cheque_w := obter_param_usuario(855, 27, Obter_Perfil_Ativo, nm_usuario_p, cd_estabelecimento_p, ie_atualiza_dtpagto_cheque_w);
ie_tf_tipo_baixa_w := obter_param_usuario(855, 54, Obter_Perfil_Ativo, nm_usuario_p, cd_estabelecimento_p, ie_tf_tipo_baixa_w);
ie_busca_baixa_trans_w := obter_param_usuario(855, 65, Obter_Perfil_Ativo, nm_usuario_p, cd_estabelecimento_p, ie_busca_baixa_trans_w);
ie_data_baixa_vencimento_w := obter_param_usuario(851, 201, Obter_Perfil_Ativo, nm_usuario_p, cd_estabelecimento_p, ie_data_baixa_vencimento_w);
ie_forma_gerar_trib_w := obter_param_usuario(855, 13, Obter_Perfil_Ativo, nm_usuario_p, cd_estabelecimento_p, ie_forma_gerar_trib_w);

select	nr_seq_conta_banco,
	nr_seq_trans_financ,
	coalesce(cd_tipo_baixa, 1),
	dt_liberacao,
	cd_moeda,
	vl_cotacao
into STRICT	nr_seq_conta_banco_w,
	nr_seq_trans_w,
	cd_tipo_baixa_w,
	dt_liberacao_w,
	cd_moeda_bordero_w,
	vl_cotacao_bordero_w
from	bordero_pagamento
where	nr_bordero		= nr_bordero_p;

/* ahoffelder - OS 371021 - 19/10/2011 */

if (ie_tf_tipo_baixa_w = 'S') then

	select	max(a.nr_seq_trans_fin)
	into STRICT	nr_seq_tf_tipo_baixa_w
	from	tipo_baixa_cpa a
	where	a.cd_tipo_baixa		= cd_tipo_baixa_w;

else
	nr_seq_tf_tipo_baixa_w	:= null;
end if;

select max(ie_bordero_banco)
into STRICT ie_bordero_banco_w
from bordero_pagamento
where nr_bordero = nr_bordero_p;

if (coalesce(ie_bordero_banco_w::text, '') = '' or ie_bordero_banco_w  = 'P') then
	select	max(ie_bordero_banco),
			max(nr_seq_trans_cheque_cp),
			max(nr_seq_trans_tit_bordero),
			coalesce(max(ie_lib_bordero),'N'),
			coalesce(max(ie_trans_fin_baixa_tit),'N')
	into STRICT	ie_bordero_banco_w,
			nr_seq_trans_cheque_cp_w,
			nr_seq_trans_tit_bordero_w,
			ie_lib_bordero_w,
			ie_trans_fin_baixa_tit_w
	from	parametros_contas_pagar
	where	cd_estabelecimento	= cd_estabelecimento_p;
else
	select 	max(nr_seq_trans_cheque_cp),
			max(nr_seq_trans_tit_bordero),
			coalesce(max(ie_lib_bordero),'N'),
			coalesce(max(ie_trans_fin_baixa_tit),'N')
	into STRICT 	nr_seq_trans_cheque_cp_w,
			nr_seq_trans_tit_bordero_w,
			ie_lib_bordero_w,
			ie_trans_fin_baixa_tit_w
	from	parametros_contas_pagar
	where	cd_estabelecimento	= cd_estabelecimento_p;
end if;

select	coalesce(sum(vl_bordero),0) +
	coalesce(sum(vl_juros_bordero),0) +
	coalesce(sum(vl_multa_bordero), 0) -
	coalesce(sum(vl_desconto_bordero),0) +
	coalesce(sum(vl_out_desp_bordero), 0),
	coalesce(sum(vl_bordero_estrang),0)
into STRICT	vl_saldo_bordero_w,
	vl_saldo_estrang_w
from	titulo_pagar_bordero_v
where	nr_bordero 	= nr_bordero_p
and	coalesce(dt_liquidacao::text, '') = '';

select	coalesce(sum(vl_imposto),0)
into STRICT	vl_imposto_bordero_w
from	w_titulo_pagar_imposto
where	nr_bordero	= nr_bordero_p;

if ( coalesce(ie_forma_gerar_trib_w,'N') = 'B') and ( coalesce(vl_imposto_bordero_w,0) > 0) then
	
	open C04;
	loop
	fetch C04 into	
		nr_titulo_trib_w;
	EXIT WHEN NOT FOUND; /* apply on C04 */
		begin
		
			/*OS 1258214 Verificar se o titulo retornado no cursor ainda esta no bordero*/

			select	count(*)
			into STRICT	qt_tit_trib_w
			from	titulo_pagar_bordero_v
			where	nr_titulo 	= nr_titulo_trib_w
			and		nr_bordero 	= nr_bordero_p;
			
			/* OS 1258214 Se retornar 0, o titulo possui o tributo gerado na w_titulo_pagar_imposto pra esse bordero, mas o titulo n consta mais no bordero, entao deve ser excluido para nao gerar tributo
			no titulo  e tambem nao interferir no valor no movimento do banco*/
			if (qt_tit_trib_w = 0) then
				delete 	FROM w_titulo_pagar_imposto
				where	nr_bordero	= nr_bordero_p
				and		nr_titulo	= nr_titulo_trib_w;
			end if;	
					
		end;
	end loop;
	close C04;

end if;

-- Edgar 12/02/2008, OS 80633, calcular tributos que serao gerados na baixa do titulo
select	coalesce(sum(vl_imposto),0)
into STRICT	vl_imposto_bordero_w
from	w_titulo_pagar_imposto
where	nr_bordero	= nr_bordero_p;

nr_seq_movto_orig_w	:= null;
ie_estorno_w		:= null;

if (ie_acao_p = 'E') then
	select	max(nr_sequencia)
	into STRICT	nr_seq_movto_orig_w
	from	movto_trans_financ
	where	nr_bordero	= nr_bordero_p;
	
	ie_estorno_w	:= 'E';
	
	select	max(vl_transacao)
	into STRICT	vl_transacao_w
	from	movto_trans_financ
	where	nr_sequencia	= nr_seq_movto_orig_w;
	
	if (vl_saldo_bordero_w <> vl_transacao_w) then
		vl_tributos_bord_w := 0;
		open C01;
		loop
		fetch C01 into
			nr_titulo_w,
			dt_vencimento_atual_w,
			vl_borero_w,
			nr_seq_trans_fin_baixa_w,
			nr_documento_w,
			vl_acrescimos_w,
			vl_descontos_w,
			CD_CGC_DESTINATARIO_w,
			CD_PESSOA_DESTINATARIO_w,
			nr_seq_trans_financ_w,
			vl_bordero_estrang_w,
			cd_centro_custo_w;
		EXIT WHEN NOT FOUND; /* apply on C01 */
			
		select	coalesce(sum(vl_imposto),0)
		into STRICT	vl_impost_bord_w
		from	w_titulo_pagar_imposto
		where	nr_titulo	= nr_titulo_w;
		
		vl_tributos_bord_w:= vl_tributos_bord_w + vl_impost_bord_w;	
		end loop;
		close c01;
		
		if ( coalesce(ie_forma_gerar_trib_w,'N') = 'B') and ( coalesce(vl_imposto_bordero_w,0) > 0) then
		
			select	coalesce(sum(vl_imposto),0)
			into STRICT	vl_tributos_bord_w
			from	w_titulo_pagar_imposto
			where	nr_bordero	= nr_bordero_p;
		
		end if;
		
	end if;	
end if;

vl_saldo_bordero_w	:= vl_saldo_bordero_w - coalesce(vl_tributos_bord_w,vl_imposto_bordero_w);
if (ie_acao_p = 'I') and (ie_lib_bordero_w = 'S') and (coalesce(dt_liberacao_w::text, '') = '') then
	--E necessario que seja liberado o pagamento do bordero para poder efetuar a baixa do mesmo!
	CALL wheb_mensagem_pck.exibir_mensagem_abort(186188);
end if;

if (coalesce(nr_seq_conta_banco_w, 0) <> 0) then
	select	count(*)
	into STRICT	cont_w
	from	cheque a
	where	coalesce(a.dt_cancelamento::text, '') = ''
	and	a.nr_sequencia in (	SELECT	x.nr_seq_cheque
					from	cheque_bordero_titulo x
					where	x.nr_bordero		= nr_bordero_p);

	if (coalesce(ie_bordero_banco_w, 'B') = 'B') or
		((cont_w = 0) and coalesce(ie_bordero_banco_w, 'C') = 'C') then		/* Edgar 14/12/2006 OS 45944, incluida rotina de cheque */
		
		if (coalesce(nr_seq_trans_w,0) = 0) then
			select	coalesce(min(nr_sequencia), 0)
			into STRICT	nr_seq_trans_w
			from	transacao_financeira
			where	ie_acao = 5
			and	ie_situacao = 'A'
			and	coalesce(ie_banco,'N') <> 'N'
			and	cd_estabelecimento = cd_estabelecimento_p;
		end if;

		if (nr_seq_trans_w = 0) then
			--Transacao de baixa de bordero nao cadastrada!
			CALL wheb_mensagem_pck.exibir_mensagem_abort(186190);
		end if;

		/* Se tiver um cheque so, pode jogar o numero do cheque no campo de documento */

		select	max(nr_cheque),
			count(*)
		into STRICT	nr_cheque_w,
			qt_registro_w
		from	cheque a
		where	coalesce(a.dt_cancelamento::text, '') = ''
		and	a.nr_sequencia in (	SELECT	x.nr_seq_cheque
						from	cheque_bordero_titulo x
						where	x.nr_bordero		= nr_bordero_p);

		if (qt_registro_w > 1) then
			nr_cheque_w	:= null;
		end if;
		
		if (ie_trans_fin_baixa_tit_w = 'S') then

			open C01;
			loop
			fetch C01 into
				nr_titulo_w,
				dt_vencimento_atual_w,
				vl_borero_w,
				nr_seq_trans_fin_baixa_w,
				nr_documento_w,
				vl_acrescimos_w,
				vl_descontos_w,
				CD_CGC_DESTINATARIO_w,
				CD_PESSOA_DESTINATARIO_w,
				nr_seq_trans_financ_w,
				vl_bordero_estrang_w,
				cd_centro_custo_w;
			EXIT WHEN NOT FOUND; /* apply on C01 */
							
			if (nr_seq_trans_fin_baixa_w <> coalesce(nr_seq_tf_tipo_baixa_w,nr_seq_trans_w)) then			
				CALL wheb_mensagem_pck.exibir_mensagem_abort(191819);
			end if;
			
			end loop;
			close c01;
						
		end if;

		select	nextval('movto_trans_financ_seq')
		into STRICT	nr_seq_movto_w
		;
		
		if (ie_busca_baixa_trans_w = 'S') then
			select	max(cd_tipo_baixa)
			into STRICT	cd_tipo_baixa_w
			from	transacao_financeira
			where	nr_sequencia = coalesce(nr_seq_tf_tipo_baixa_w,nr_seq_trans_w);
			
			if (coalesce(cd_tipo_baixa_w::text, '') = '') then
				select	coalesce(cd_tipo_baixa_padrao,1)
				into STRICT	cd_tipo_baixa_w
				from	parametros_contas_pagar
				where	cd_estabelecimento = cd_estabelecimento_p;
			end if;
		end if;
		
		/* Projeto Multimoeda - Verifica se o bordero e em moeda estrangeira, caso positivo calcula os valores para gravar no movimento*/

		if (coalesce(vl_saldo_estrang_w,0) <> 0 and coalesce(vl_cotacao_bordero_w,0) <> 0) then
			if (ie_acao_p = 'I') then
				vl_complemento_w := vl_saldo_bordero_w - vl_saldo_estrang_w;
			else
				vl_saldo_estrang_w := vl_saldo_estrang_w * -1;
				vl_complemento_w := (vl_saldo_bordero_w * -1) - vl_saldo_estrang_w;
			end if;
		else
			vl_saldo_estrang_w := null;
			vl_complemento_w := null;
			vl_cotacao_bordero_w := null;
			cd_moeda_bordero_w := null;
		end if;

		insert into movto_trans_financ(nr_sequencia,
			dt_transacao,
			nr_seq_trans_financ,
			vl_transacao,
			dt_atualizacao,
			nm_usuario,
			nr_bordero,
			dt_referencia_saldo,
			nr_seq_banco,
			cd_tipo_baixa_cpa,
			nr_lote_contabil,
			ie_conciliacao,
			nr_documento,
			nr_seq_movto_orig,
			ie_estorno,
			vl_transacao_estrang,
			vl_complemento,
			vl_cotacao,
			cd_moeda)
		values (nr_seq_movto_w,
			dt_transacao_p,
			coalesce(nr_seq_tf_tipo_baixa_w,nr_seq_trans_w),
			CASE WHEN ie_acao_p='I' THEN  vl_saldo_bordero_w  ELSE vl_saldo_bordero_w * - 1 END ,
			clock_timestamp(),
			nm_usuario_p,
			nr_bordero_p,
			clock_timestamp(),
			nr_seq_conta_banco_w,
			cd_tipo_baixa_w,
			0,
			'N',
			nr_cheque_w,
			nr_seq_movto_orig_w,
			ie_estorno_w,
			vl_saldo_estrang_w,
			vl_complemento_w,
			vl_cotacao_bordero_w,
			cd_moeda_bordero_w);

		if (ie_acao_p = 'I') then
			CALL atualizar_transacao_financeira(cd_estabelecimento_p, nr_seq_movto_w, nm_usuario_p, 'I');
		end if;
	elsif (ie_bordero_banco_w = 'C') or (ie_bordero_banco_w = 'R' AND cont_w > 0) or (ie_bordero_banco_w = 'A' AND cont_w > 0) then

		select	coalesce(sum(a.vl_cheque),0),
			coalesce(sum(a.vl_cheque_estrang),0)
		into STRICT	vl_cheque_w,
			vl_cheque_estrang_w
		from	cheque a
		where	coalesce(a.dt_cancelamento::text, '') = ''
		and	a.nr_sequencia in (	SELECT	x.nr_seq_cheque
						from	cheque_bordero_titulo x
						where	x.nr_bordero		= nr_bordero_p);

		/* Projeto Multimoeda - Quando for transacao em moeda estrangeira verifica o saldo em moeda estrangeira. */

		if (coalesce(vl_cheque_estrang_w,0) <> 0 and coalesce(vl_saldo_estrang_w,0) <> 0) then
			if (vl_cheque_estrang_w <> vl_saldo_estrang_w) then
				--O valor total dos cheques nao bate com o valor total do bordero!
				CALL wheb_mensagem_pck.exibir_mensagem_abort(186196,'vl_cheque_w='|| vl_cheque_estrang_w||';vl_saldo_bordero_w='||vl_saldo_estrang_w);
			end if;
		else
			if (vl_cheque_w <> vl_saldo_bordero_w) then
				--O valor total dos cheques nao bate com o valor total do bordero!
				CALL wheb_mensagem_pck.exibir_mensagem_abort(186196,'vl_cheque_w='|| vl_cheque_w||';vl_saldo_bordero_w='||vl_saldo_bordero_w);
			end if;
		end if;

		if (coalesce(nr_seq_trans_cheque_cp_w::text, '') = '') then
			--A transacao de cheque de bordero nao foi informada! Verifique os parametros do contas a pagar.
			CALL wheb_mensagem_pck.exibir_mensagem_abort(186191);
		end if;

		select	ie_acao,
			ds_transacao
		into STRICT	ie_acao_w,
			ds_transacao_w
		from	transacao_financeira
		where	nr_sequencia	= nr_seq_trans_cheque_cp_w;

		-- Edgar 30/01/2008, OS 81295, coloquei consistencia abaixo
		if (ie_acao_w = 5)  then
			--Nao e possivel fazer a baixa deste bordero!
			CALL wheb_mensagem_pck.exibir_mensagem_abort(186199,'ds_transacao_w='||ds_transacao_w);
		end if;

		open C02;
		loop
		fetch C02 into
			nr_seq_cheque_w,
			vl_cheque_w,
			nr_cheque_w,
			CD_CGC_DESTINATARIO_w,
			CD_PESSOA_DESTINATARIO_w,
			vl_cheque_estrang_w,
			vl_cotacao_cheque_w,
			cd_moeda_cheque_w;
		EXIT WHEN NOT FOUND; /* apply on C02 */
			begin
			if (ie_acao_w = 16) then
				select	dt_compensacao
				into STRICT	dt_compensacao_w
				from	cheque
				where	nr_sequencia	= nr_seq_cheque_w;

				if (dt_compensacao_w IS NOT NULL AND dt_compensacao_w::text <> '')  and (ie_acao_p = 'I') then
					--O cheque ' || nr_cheque_w || ' ja foi lancado no controle bancario!
					CALL wheb_mensagem_pck.exibir_mensagem_abort(186200, 'nr_cheque_w='||nr_cheque_w);
				end if;
			end if;
			
			
			if (ie_trans_fin_baixa_tit_w = 'S') then

				open C01;
				loop
				fetch C01 into
					nr_titulo_w,
					dt_vencimento_atual_w,
					vl_borero_w,
					nr_seq_trans_fin_baixa_w,
					nr_documento_w,
					vl_acrescimos_w,
					vl_descontos_w,
					CD_CGC_DESTINATARIO_w,
					CD_PESSOA_DESTINATARIO_w,
					nr_seq_trans_financ_w,
					vl_bordero_estrang_w,
					cd_centro_custo_w;
				EXIT WHEN NOT FOUND; /* apply on C01 */
					
				if (nr_seq_trans_fin_baixa_w <> nr_seq_trans_cheque_cp_w) then			
					CALL wheb_mensagem_pck.exibir_mensagem_abort(191819);
				end if;
				
				end loop;
				close c01;
							
			end if;
			
			if (ie_busca_baixa_trans_w = 'S') then
				select	max(cd_tipo_baixa)
				into STRICT	cd_tipo_baixa_w
				from	transacao_financeira
				where	nr_sequencia = nr_seq_trans_cheque_cp_w;
				
				if (coalesce(cd_tipo_baixa_w::text, '') = '') then
					select	coalesce(cd_tipo_baixa_padrao,1)
					into STRICT	cd_tipo_baixa_w
					from	parametros_contas_pagar
					where	cd_estabelecimento = cd_estabelecimento_p;
				end if;
			end if;

			select	nextval('movto_trans_financ_seq')
			into STRICT	nr_seq_movto_w
			;
			
			/* Projeto Multimoeda - Verifica se o bordero e em moeda estrangeira, caso positivo calcula os valores para gravar no movimento*/

			if (coalesce(vl_cheque_estrang_w,0) <> 0 and coalesce(vl_cotacao_cheque_w,0) <> 0) then
				if (ie_acao_p = 'I') then
					vl_complemento_w := vl_cheque_w - vl_cheque_estrang_w;
				else
					vl_cheque_estrang_w := vl_cheque_estrang_w * -1;
					vl_complemento_w := (vl_cheque_w * -1) - vl_cheque_estrang_w;
				end if;
			else
				vl_cheque_estrang_w := null;
				vl_complemento_w := null;
				vl_cotacao_cheque_w := null;
				cd_moeda_cheque_w := null;
			end if;
		
			insert into movto_trans_financ(nr_sequencia,
				dt_transacao,
				nr_seq_trans_financ,
				vl_transacao,
				dt_atualizacao,
				nm_usuario,
				dt_referencia_saldo,
				nr_seq_banco,
				nr_lote_contabil,
				ie_conciliacao,
				nr_seq_cheque_cp,
				nr_documento,
				nr_bordero,
				cd_tipo_baixa_cpa,
				cd_cgc,
				cd_pessoa_fisica,
				vl_transacao_estrang,
				vl_complemento,
				vl_cotacao,
				cd_moeda)
			values (nr_seq_movto_w,
				dt_transacao_p,
				nr_seq_trans_cheque_cp_w,
				CASE WHEN ie_acao_p='I' THEN  vl_cheque_w  ELSE vl_cheque_w * - 1 END ,
				clock_timestamp(),
				nm_usuario_p,
				clock_timestamp(),
				nr_seq_conta_banco_w,
				0,
				'N',
				nr_seq_cheque_w,
				nr_cheque_w,
				nr_bordero_p,
				cd_tipo_baixa_w,
				CD_CGC_DESTINATARIO_w,
				CD_PESSOA_DESTINATARIO_w,
				vl_cheque_estrang_w,
				vl_complemento_w,
				vl_cotacao_cheque_w,
				cd_moeda_cheque_w);

			if (ie_acao_P = 'I') then
				CALL atualizar_transacao_financeira(cd_estabelecimento_p, nr_seq_movto_w, nm_usuario_p, 'I');
			end if;
			end;
		end loop;
		close C02;

		open C01;
		loop
		fetch C01 into
			nr_titulo_w,
			dt_vencimento_atual_w,
			vl_borero_w,
			nr_seq_trans_fin_baixa_w,
			nr_documento_w,
			vl_acrescimos_w,
			vl_descontos_w,
			CD_CGC_DESTINATARIO_w,
			CD_PESSOA_DESTINATARIO_w,
			nr_seq_trans_financ_w,
			vl_bordero_estrang_w,
			cd_centro_custo_w;
		EXIT WHEN NOT FOUND; /* apply on C01 */
			begin
			if (ie_busca_baixa_trans_w = 'S') then
				select	max(cd_tipo_baixa)
				into STRICT	cd_tipo_baixa_w
				from	transacao_financeira
				where	nr_sequencia = coalesce(nr_seq_tf_tipo_baixa_w,coalesce(nr_seq_trans_fin_baixa_w, nr_seq_trans_w));
				
				if (coalesce(cd_tipo_baixa_w::text, '') = '') then
					select	coalesce(cd_tipo_baixa_padrao,1)
					into STRICT	cd_tipo_baixa_w
					from	parametros_contas_pagar
					where	cd_estabelecimento = cd_estabelecimento_p;
				end if;
			end if;
			
			
			if (ie_acao_p = 'I') then
				CALL Baixa_Titulo_Pagar(cd_estabelecimento_p,
							cd_tipo_baixa_w,
							nr_titulo_w,
							vl_borero_w,
							nm_usuario_p,
							coalesce(nr_seq_tf_tipo_baixa_w,coalesce(nr_seq_trans_fin_baixa_w, nr_seq_trans_w)),
							nr_bordero_p,
							null,
							dt_transacao_p,
							null);
				
				select 	max(nr_seq_cheque)
				into STRICT 	nr_seq_cheque_baixa_w
				from 	cheque_bordero_titulo
				where 	nr_titulo = nr_titulo_w
				and 	nr_bordero = nr_bordero_p;

				select	max(nr_sequencia)
				into STRICT	nr_seq_baixa_w
				from	titulo_pagar_baixa
				where	nr_titulo = nr_titulo_w;

				update	titulo_pagar_baixa
				set		nr_seq_cheque_cp = nr_seq_cheque_baixa_w
				where	nr_titulo = nr_titulo_w
				and		nr_sequencia = nr_seq_baixa_w;
				
				/*Inicio OS 1286791 - Tentar identificar o movimento gerado no banco para a baixa, e vincular ela na baixa em questao.*/

				if (nr_seq_cheque_baixa_w IS NOT NULL AND nr_seq_cheque_baixa_w::text <> '') then
					
					nr_seq_movto_bco_w := null;
					
					select	max(a.nr_sequencia)
					into STRICT	nr_seq_movto_bco_w
					from	movto_trans_financ a
					where	a.nr_bordero 		= nr_bordero_p
					and		a.nr_seq_cheque_cp 	= nr_seq_cheque_baixa_w
					and		a.vl_transacao		> 0; --Apenas transacoes positivas, de baixas, e nao estornos.
					
					/*Se achar o movimento no banco para esse bordero e cheque, atualizar na baixa do titulo, */

					if (nr_seq_movto_bco_w IS NOT NULL AND nr_seq_movto_bco_w::text <> '') then
					
						update	titulo_pagar_baixa a
						set		a.nr_seq_movto_trans_fin 	= nr_seq_movto_bco_w
						where	a.nr_titulo					= nr_titulo_w
						and		a.nr_sequencia				= nr_seq_baixa_w
						and		coalesce(a.nr_seq_movto_trans_fin::text, '') = '';
					
					end if;
							
				end if;			
							
				CALL Atualizar_Saldo_Tit_Pagar(nr_titulo_w, nm_usuario_p);
				CALL Gerar_W_Tit_Pag_imposto(nr_titulo_w,nm_usuario_p);
			end if;
			end;
		end loop;
		close C01;

	elsif (ie_bordero_banco_w = 'T') or (ie_bordero_banco_w = 'A' AND cont_w = 0) then /* Um lancamento para cada titulo */
		open C01;
		loop
		fetch C01 into
			nr_titulo_w,
			dt_vencimento_atual_w,
			vl_bordero_w,
			nr_seq_trans_fin_baixa_w,
			nr_documento_w,
			vl_acrescimos_w,
			vl_descontos_w,
			CD_CGC_DESTINATARIO_w,
			CD_PESSOA_DESTINATARIO_w,
			nr_seq_trans_financ_w,
			vl_bordero_estrang_w,
			cd_centro_custo_w;
		EXIT WHEN NOT FOUND; /* apply on C01 */
			begin
			if (coalesce(nr_seq_trans_tit_bordero_w::text, '') = '') then
				CALL wheb_mensagem_pck.exibir_mensagem_abort(186192);

			end if;

			if (coalesce(nr_documento_w::text, '') = '') then
				select	max(nr_seq_cheque)
				into STRICT	nr_seq_cheque_w
				from	cheque_bordero_titulo
				where	nr_titulo	= nr_titulo_w;

				if (nr_seq_cheque_w IS NOT NULL AND nr_seq_cheque_w::text <> '') then
					select	nr_cheque
					into STRICT	nr_documento_w
					from	cheque
					where	nr_sequencia	= nr_seq_cheque_w;
				end if;
			end if;
						
			if (ie_trans_fin_baixa_tit_w = 'S') and (nr_seq_trans_fin_baixa_w <> coalesce(nr_seq_tf_tipo_baixa_w,coalesce(nr_seq_trans_financ_w,coalesce(nr_seq_trans_fin_baixa_w,coalesce(nr_seq_trans_tit_bordero_w,nr_seq_trans_w))))) then			
				CALL wheb_mensagem_pck.exibir_mensagem_abort(191819);			
			end if;

			select	nextval('movto_trans_financ_seq')
			into STRICT	nr_seq_movto_w
			;

			/* Francisco - OS 93321 - 02/06/2008 */

			vl_bordero_w	:= vl_bordero_w + vl_acrescimos_w - vl_descontos_w;

			/* Francisco - OS 152695 - 09/07/2009 - Tratar acao */

			select	max(ie_acao),
				max(ds_transacao)
			into STRICT	ie_acao_w,
				ds_transacao_w
			from	transacao_financeira
			where	nr_sequencia	= coalesce(nr_seq_tf_tipo_baixa_w,coalesce(nr_seq_trans_financ_w,coalesce(nr_seq_trans_fin_baixa_w,coalesce(nr_seq_trans_tit_bordero_w,nr_seq_trans_w))));

			if (ie_acao_w <> 2) then
				--A transacao "' || ds_transacao_w || '" nao possui acao "Baixa de titulo a pagar", verifique.
				CALL wheb_mensagem_pck.exibir_mensagem_abort(186201,'ds_transacao_w='||ds_transacao_w);
			end if;
			

			select	coalesce(sum(vl_imposto),0)
			into STRICT	vl_imposto_div_w
			from	w_titulo_pagar_imposto
			where	1 = 1
			and	nr_bordero	= nr_bordero_p
			and	nr_titulo	= nr_titulo_w;
			
			if (ie_acao_p	= 'E') then
				select	coalesce(max(IE_GERAR_TRIB_TEMP), 'N')
				into STRICT	IE_GERAR_TRIB_TEMP_w
				from	parametros_contas_pagar
				where	cd_estabelecimento	= cd_estabelecimento_p;


				if (IE_GERAR_TRIB_TEMP_W = 'S') then
					select	coalesce(sum(vl_imposto),0)
					into STRICT	vl_imposto_div_w
					from	w_titulo_pagar_imposto
					where	1 = 1
					and	nr_titulo	= nr_titulo_w;
				end if;
			end if;
						
			vl_bordero_w	:= vl_bordero_w - coalesce(vl_imposto_div_w,0);
			/* Projeto Multimoeda - Verifica se o bordero e em moeda estrangeira, caso positivo deduz o imposto aplicando a cotacao*/

			if (coalesce(vl_bordero_estrang_w,0) <> 0 and coalesce(vl_cotacao_bordero_w,0) <> 0) then
				vl_bordero_estrang_w := vl_bordero_estrang_w - (coalesce(vl_imposto_div_w,0) / vl_cotacao_bordero_w);
			end if;
			
			if (ie_busca_baixa_trans_w = 'S') then
				select	max(cd_tipo_baixa)
				into STRICT	cd_tipo_baixa_w
				from	transacao_financeira
				where	nr_sequencia = coalesce(nr_seq_tf_tipo_baixa_w,coalesce(nr_seq_trans_financ_w,coalesce(nr_seq_trans_fin_baixa_w,coalesce(nr_seq_trans_tit_bordero_w,nr_seq_trans_w))));

				if (coalesce(cd_tipo_baixa_w::text, '') = '') then
					select	coalesce(cd_tipo_baixa_padrao,1)
					into STRICT	cd_tipo_baixa_w
					from	parametros_contas_pagar
					where	cd_estabelecimento = cd_estabelecimento_p;
				end if;
			end if;
			
			/* Projeto Multimoeda - Verifica se o bordero e em moeda estrangeira, caso positivo calcula os valores para gravar no movimento*/

			if (coalesce(vl_bordero_estrang_w,0) <> 0 and coalesce(vl_cotacao_bordero_w,0) <> 0) then
				if (ie_acao_p = 'I') then
					vl_complemento_w := vl_bordero_w - vl_bordero_estrang_w;
				else
					vl_bordero_estrang_w := vl_bordero_estrang_w * -1;
					vl_complemento_w := (vl_bordero_w * -1) - vl_bordero_estrang_w;
				end if;
			else
				vl_bordero_estrang_w := null;
				vl_complemento_w := null;
				vl_cotacao_bordero_w := null;
				cd_moeda_bordero_w := null;
			end if;
			
			insert into movto_trans_financ(nr_sequencia,
				dt_transacao,
				nr_seq_trans_financ,
				vl_transacao,
				dt_atualizacao,
				nm_usuario,
				nr_bordero,
				nr_seq_titulo_pagar,
				nr_documento,
				nr_seq_cheque_cp,
				dt_referencia_saldo,
				nr_seq_banco,
				cd_tipo_baixa_cpa,
				nr_lote_contabil,
				ie_conciliacao,
				CD_CGC,
				CD_PESSOA_FISICA,
				vl_transacao_estrang,
				vl_complemento,
				vl_cotacao,
				cd_moeda,
				cd_centro_custo)
			values (nr_seq_movto_w,
				CASE WHEN ie_data_baixa_vencimento_w='S' THEN dt_vencimento_atual_w  ELSE dt_transacao_p END ,
				coalesce(nr_seq_tf_tipo_baixa_w,coalesce(nr_seq_trans_financ_w,coalesce(nr_seq_trans_fin_baixa_w,coalesce(nr_seq_trans_tit_bordero_w,nr_seq_trans_w)))),
				CASE WHEN ie_acao_p='I' THEN  vl_bordero_w  ELSE vl_bordero_w * - 1 END ,
				clock_timestamp(),
				nm_usuario_p,
				nr_bordero_p,
				nr_titulo_w,
				nr_documento_w,
				nr_seq_cheque_w,
				clock_timestamp(),
				nr_seq_conta_banco_w,
				cd_tipo_baixa_w,
				0,
				'N',
				CD_CGC_DESTINATARIO_w,
				CD_PESSOA_DESTINATARIO_w,
				vl_bordero_estrang_w,
				vl_complemento_w,
				vl_cotacao_bordero_w,
				cd_moeda_bordero_w,
				cd_centro_custo_w);


			if (ie_acao_p = 'I') then

				CALL atualizar_transacao_financeira(cd_estabelecimento_p, nr_seq_movto_w, nm_usuario_p, ie_acao_p);
			end if;
			end;
		end loop;
		close C01;
	elsif (ie_bordero_banco_w = 'R') then /* movimentacoes por transacao financeira de baixa dos titulos */
		if (coalesce(nr_seq_trans_tit_bordero_w::text, '') = '') then
			--Nao foi iformada a "Transacao titulo bordero"! Verifique os parametros do Contas a Pagar.
			CALL wheb_mensagem_pck.exibir_mensagem_abort(186193);
		end if;
		
		open C03;
		loop
		fetch C03 into
			vl_bordero_w,
			nr_seq_trans_fin_baixa_w,
			vl_bordero_estrang_w;
		EXIT WHEN NOT FOUND; /* apply on C03 */
			begin
			
			if (ie_trans_fin_baixa_tit_w = 'S') and (nr_seq_trans_fin_baixa_w <> coalesce(nr_seq_trans_fin_baixa_w,nr_seq_trans_tit_bordero_w)) then			
				CALL wheb_mensagem_pck.exibir_mensagem_abort(191819);			
			end if;
			
			select	nextval('movto_trans_financ_seq')
			into STRICT	nr_seq_movto_w
			;
			
			vl_imposto_div_w	:= vl_imposto_bordero_w * dividir_sem_round(vl_bordero_w,vl_saldo_bordero_w);
			vl_bordero_w	:= vl_bordero_w - coalesce(vl_imposto_div_w,0);
			/* Projeto Multimoeda - Verifica se o bordero e em moeda estrangeira, caso positivo deduz o imposto do valor estrangeiro*/

			if (coalesce(vl_bordero_estrang_w,0) <> 0 and coalesce(vl_saldo_estrang_w,0) <> 0 and coalesce(vl_cotacao_bordero_w,0) <> 0) then
				vl_imposto_div_w := (vl_imposto_bordero_w / vl_cotacao_bordero_w) * dividir_sem_round(vl_bordero_estrang_w,vl_saldo_estrang_w);
				vl_bordero_estrang_w := vl_bordero_estrang_w - coalesce(vl_imposto_div_w,0);
			end if;
			
			if (ie_busca_baixa_trans_w = 'S') then
				select	max(cd_tipo_baixa)
				into STRICT	cd_tipo_baixa_w
				from	transacao_financeira
				where	nr_sequencia = coalesce(nr_seq_trans_fin_baixa_w,nr_seq_trans_tit_bordero_w);
				
				if (coalesce(cd_tipo_baixa_w::text, '') = '') then
					select	coalesce(cd_tipo_baixa_padrao,1)
					into STRICT	cd_tipo_baixa_w
					from	parametros_contas_pagar
					where	cd_estabelecimento = cd_estabelecimento_p;
				end if;
			end if;
			
			/* Projeto Multimoeda - Verifica se o bordero e em moeda estrangeira, caso positivo calcula os valores para gravar no movimento*/

			if (coalesce(vl_bordero_estrang_w,0) <> 0 and coalesce(vl_cotacao_bordero_w,0) <> 0) then
				if (ie_acao_p = 'I') then
					vl_complemento_w := vl_bordero_w - vl_bordero_estrang_w;
				else
					vl_bordero_estrang_w := vl_bordero_estrang_w * -1;
					vl_complemento_w := (vl_bordero_w * -1) - vl_bordero_estrang_w;
				end if;
			else
				vl_bordero_estrang_w := null;
				vl_complemento_w := null;
				vl_cotacao_bordero_w := null;
				cd_moeda_bordero_w := null;
			end if;
			
			insert into movto_trans_financ(nr_sequencia,
				dt_transacao,
				nr_seq_trans_financ,
				vl_transacao,
				dt_atualizacao,
				nm_usuario,
				nr_bordero,
				dt_referencia_saldo,
				nr_seq_banco,
				cd_tipo_baixa_cpa,
				nr_lote_contabil,
				ie_conciliacao,
				vl_transacao_estrang,
				vl_complemento,
				vl_cotacao,
				cd_moeda)
			values (nr_seq_movto_w,
				dt_transacao_p,
				coalesce(nr_seq_trans_fin_baixa_w,nr_seq_trans_tit_bordero_w),
				CASE WHEN ie_acao_p='I' THEN  vl_bordero_w  ELSE vl_bordero_w * - 1 END ,
				clock_timestamp(),
				nm_usuario_p,
				nr_bordero_p,
				clock_timestamp(),
				nr_seq_conta_banco_w,
				cd_tipo_baixa_w,
				0,
				'N',
				vl_bordero_estrang_w,
				vl_complemento_w,
				vl_cotacao_bordero_w,
				cd_moeda_bordero_w);

			if (ie_acao_p = 'I') then
				CALL atualizar_transacao_financeira(cd_estabelecimento_p, nr_seq_movto_w, nm_usuario_p, ie_acao_p);
			end if;
			end;
		end loop;
		close C03;

		open C01;
		loop
		fetch C01 into
			nr_titulo_w,
			dt_vencimento_atual_w,
			vl_borero_w,
			nr_seq_trans_fin_baixa_w,
			nr_documento_w,
			vl_acrescimos_w,
			vl_descontos_w,
			CD_CGC_DESTINATARIO_w,
			CD_PESSOA_DESTINATARIO_w,
			nr_seq_trans_financ_w,
			vl_bordero_estrang_w,
			cd_centro_custo_w;
		EXIT WHEN NOT FOUND; /* apply on C01 */
			begin
			
			if (ie_busca_baixa_trans_w = 'S') then
				select	max(cd_tipo_baixa)
				into STRICT	cd_tipo_baixa_w
				from	transacao_financeira
				where	nr_sequencia = coalesce(nr_seq_trans_fin_baixa_w, nr_seq_trans_w);
				
				if (coalesce(cd_tipo_baixa_w::text, '') = '') then
					select	coalesce(cd_tipo_baixa_padrao,1)
					into STRICT	cd_tipo_baixa_w
					from	parametros_contas_pagar
					where	cd_estabelecimento = cd_estabelecimento_p;
				end if;
			end if;

			if (ie_acao_p = 'I') then
				CALL Baixa_Titulo_Pagar(cd_estabelecimento_p,
							cd_tipo_baixa_w,
							nr_titulo_w,
							vl_borero_w,
							nm_usuario_p,
							coalesce(nr_seq_trans_fin_baixa_w, nr_seq_trans_w),
							nr_bordero_p,
							null,
							dt_transacao_p,
							null);

				select 	max(nr_seq_cheque)
				into STRICT 	nr_seq_cheque_baixa_w
				from 	cheque_bordero_titulo
				where 	nr_titulo = nr_titulo_w
				and 	nr_bordero = nr_bordero_p;

				select	max(nr_sequencia)
				into STRICT	nr_seq_baixa_w
				from	titulo_pagar_baixa
				where	nr_titulo = nr_titulo_w;

				update	titulo_pagar_baixa
				set		nr_seq_cheque_cp = nr_seq_cheque_baixa_w
				where	nr_titulo = nr_titulo_w
				and		nr_sequencia = nr_seq_baixa_w;								

				CALL Atualizar_Saldo_Tit_Pagar(nr_titulo_w, nm_usuario_p);
				CALL Gerar_W_Tit_Pag_imposto(nr_titulo_w,nm_usuario_p);
			end if;
			end;
		end loop;
		close C01;
	elsif (ie_bordero_banco_w = 'F') then /* movimentacoes agrupada por pessoa */
			
    if (coalesce(nr_seq_trans_w,0) = 0) then
			select	coalesce(min(nr_sequencia), 0)
			into STRICT	nr_seq_trans_w
			from	transacao_financeira
			where	ie_acao = 5
			and	ie_situacao = 'A'
			and	coalesce(ie_banco,'N') <> 'N'
			and	cd_estabelecimento = cd_estabelecimento_p;
		end if;

		if (nr_seq_trans_w = 0) then
			--Transacao de baixa de bordero nao cadastrada!
			CALL wheb_mensagem_pck.exibir_mensagem_abort(186190);
		end if;

		if (ie_trans_fin_baixa_tit_w = 'S') then      

			open C01;
			loop
			fetch C01 into
				nr_titulo_w,
				dt_vencimento_atual_w,
				vl_bordero_w,
				nr_seq_trans_fin_baixa_w,
				nr_documento_w,
				vl_acrescimos_w,
				vl_descontos_w,
				CD_CGC_DESTINATARIO_w,
				CD_PESSOA_DESTINATARIO_w,
				nr_seq_trans_financ_w,
				vl_bordero_estrang_w,
				cd_centro_custo_w;
			EXIT WHEN NOT FOUND; /* apply on C01 */
							
			if (nr_seq_trans_fin_baixa_w <> coalesce(nr_seq_tf_tipo_baixa_w,nr_seq_trans_w)) then	
				CALL wheb_mensagem_pck.exibir_mensagem_abort(191819);
			end if;
			
			end loop;
			close c01;
						
		end if;
		
		open C05;
		loop
		fetch C05 into
			vl_bordero_w,
			vl_bordero_estrang_w,
			cd_pessoa_fisica_w,
			cd_cgc_w;
		EXIT WHEN NOT FOUND; /* apply on C05 */
			begin
		
				select	nextval('movto_trans_financ_seq')
				into STRICT	nr_seq_movto_w
				;
				
				vl_imposto_div_w	:= vl_imposto_bordero_w * dividir_sem_round(vl_bordero_w,vl_saldo_bordero_w);
				vl_bordero_w	:= vl_bordero_w - coalesce(vl_imposto_div_w,0);
				/* Projeto Multimoeda - Verifica se o bordero e em moeda estrangeira, caso positivo deduz o imposto do valor estrangeiro*/

				if (coalesce(vl_bordero_estrang_w,0) <> 0 and coalesce(vl_saldo_estrang_w,0) <> 0 and coalesce(vl_cotacao_bordero_w,0) <> 0) then
					vl_imposto_div_w := (vl_imposto_bordero_w / vl_cotacao_bordero_w) * dividir_sem_round(vl_bordero_estrang_w,vl_saldo_estrang_w);
					vl_bordero_estrang_w := vl_bordero_estrang_w - coalesce(vl_imposto_div_w,0);
				end if;
				
				if (ie_busca_baixa_trans_w = 'S') then
					select	max(cd_tipo_baixa)
					into STRICT	cd_tipo_baixa_w
					from	transacao_financeira
					where	nr_sequencia = coalesce(nr_seq_tf_tipo_baixa_w,nr_seq_trans_w);
					
					if (coalesce(cd_tipo_baixa_w::text, '') = '') then
						select	coalesce(cd_tipo_baixa_padrao,1)
						into STRICT	cd_tipo_baixa_w
						from	parametros_contas_pagar
						where	cd_estabelecimento = cd_estabelecimento_p;
					end if;
					
				end if;
				
				/* Projeto Multimoeda - Verifica se o bordero e em moeda estrangeira, caso positivo calcula os valores para gravar no movimento*/

				if (coalesce(vl_bordero_estrang_w,0) <> 0 and coalesce(vl_cotacao_bordero_w,0) <> 0) then
					if (ie_acao_p = 'I') then
						vl_complemento_w := vl_bordero_w - vl_bordero_estrang_w;
					else
						vl_bordero_estrang_w := vl_bordero_estrang_w * -1;
						vl_complemento_w := (vl_bordero_w * -1) - vl_bordero_estrang_w;
					end if;
				else
					vl_bordero_estrang_w := null;
					vl_complemento_w := null;
					vl_cotacao_bordero_w := null;
					cd_moeda_bordero_w := null;
				end if;
				
				insert into movto_trans_financ(nr_sequencia,
					dt_transacao,
					nr_seq_trans_financ,
					vl_transacao,
					dt_atualizacao,
					nm_usuario,
					nr_bordero,
					dt_referencia_saldo,
					nr_seq_banco,
					cd_tipo_baixa_cpa,
					nr_lote_contabil,
					ie_conciliacao,
					vl_transacao_estrang,
					vl_complemento,
					vl_cotacao,
					cd_moeda,
					cd_pessoa_fisica,
					cd_cgc)
				values (nr_seq_movto_w,
					dt_transacao_p,
					coalesce(nr_seq_tf_tipo_baixa_w,nr_seq_trans_w),
					CASE WHEN ie_acao_p='I' THEN  vl_bordero_w  ELSE vl_bordero_w * - 1 END ,
					clock_timestamp(),
					nm_usuario_p,
					nr_bordero_p,
					clock_timestamp(),
					nr_seq_conta_banco_w,
					cd_tipo_baixa_w,
					0,
					'N',
					vl_bordero_estrang_w,
					vl_complemento_w,
					vl_cotacao_bordero_w,
					cd_moeda_bordero_w,
					cd_pessoa_fisica_w,
					cd_cgc_w);
					
				if (ie_acao_p = 'I') then
					CALL atualizar_transacao_financeira(cd_estabelecimento_p, nr_seq_movto_w, nm_usuario_p, ie_acao_p);
				end if;
			
			end;
		end loop;
		close C05;
	end if;	
else
	open C01;
	loop
	fetch C01 into
		nr_titulo_w,
		dt_vencimento_atual_w,
		vl_borero_w,
		nr_seq_trans_fin_baixa_w,
		nr_documento_w,
		vl_acrescimos_w,
		vl_descontos_w,
		CD_CGC_DESTINATARIO_w,
		CD_PESSOA_DESTINATARIO_w,
		nr_seq_trans_financ_w,
		vl_bordero_estrang_w,
		cd_centro_custo_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin
		if (ie_acao_p = 'I') then
			if (ie_busca_baixa_trans_w = 'S') then
				select	max(cd_tipo_baixa)
				into STRICT	cd_tipo_baixa_w
				from	transacao_financeira
				where	nr_sequencia = coalesce(nr_seq_tf_tipo_baixa_w,coalesce(nr_seq_trans_fin_baixa_w, nr_seq_trans_w));
				if (coalesce(cd_tipo_baixa_w::text, '') = '') then
					select	coalesce(cd_tipo_baixa_padrao,1)
					into STRICT	cd_tipo_baixa_w
					from	parametros_contas_pagar
					where	cd_estabelecimento = cd_estabelecimento_p;
				end if;
			end if;
						
			CALL Baixa_Titulo_Pagar(cd_estabelecimento_p,
						cd_tipo_baixa_w,
						nr_titulo_w,
						vl_borero_w,
						nm_usuario_p,
						coalesce(nr_seq_tf_tipo_baixa_w,coalesce(nr_seq_trans_fin_baixa_w, nr_seq_trans_w)),
						nr_bordero_p,
						null,
						dt_transacao_p,
						null);
					
			select 	max(nr_seq_cheque)
			into STRICT 	nr_seq_cheque_baixa_w
			from 	cheque_bordero_titulo
			where 	nr_titulo = nr_titulo_w
			and 	nr_bordero = nr_bordero_p;

			select	max(nr_sequencia)
			into STRICT	nr_seq_baixa_w
			from	titulo_pagar_baixa
			where	nr_titulo = nr_titulo_w;

			update	titulo_pagar_baixa
			set		nr_seq_cheque_cp = nr_seq_cheque_baixa_w
			where	nr_titulo = nr_titulo_w
			and		nr_sequencia = nr_seq_baixa_w;						

			CALL Atualizar_Saldo_Tit_Pagar(nr_titulo_w,nm_usuario_p);
			CALL Gerar_W_Tit_Pag_imposto(nr_titulo_w,nm_usuario_p);
		end if;
		end;
	end loop;
	close C01;
end if;

if (ie_acao_p = 'I') and (ie_atualiza_dtpagto_cheque_w = 'S') then
	update	cheque a
	set 	a.dt_pagamento = coalesce(a.dt_pagamento, coalesce(dt_pagto_cheque_p, clock_timestamp()))
	where	a.nr_sequencia in (	SELECT	x.nr_seq_cheque
					from	cheque_bordero_titulo x
					where	x.nr_bordero		= nr_bordero_p);
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_movto_trans_bordero ( nr_bordero_p bigint, cd_estabelecimento_p bigint, dt_transacao_p timestamp, dt_pagto_cheque_p timestamp, ie_acao_p text, nm_usuario_p text) FROM PUBLIC;

