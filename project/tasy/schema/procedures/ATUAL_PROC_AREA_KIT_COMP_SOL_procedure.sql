-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE atual_proc_area_kit_comp_sol ( nr_seq_processo_p bigint, nr_prescricao_p bigint, nr_seq_solucao_p bigint, dt_horario_p timestamp, nr_seq_material_p bigint, ie_sup_oral_p text) AS $body$
DECLARE

				
nr_seq_material_w		integer;
nr_seq_area_prep_w	bigint;
varsql_row_count_w	bigint;
ds_erro_w		varchar(1800);
ie_grava_log_gedipa_w	varchar(1);

c01 CURSOR FOR
SELECT	a.nr_seq_material,
		a.nr_seq_area_prep
from   	prescr_mat_hor a,
		prescr_material b,
		prescr_solucao c
where  	a.nr_prescricao		= b.nr_prescricao
and		a.nr_seq_material		= b.nr_sequencia
and		a.ie_agrupador			= 4
and		a.nr_seq_processo		= nr_seq_processo_p
and		a.dt_horario			= dt_horario_p
and		b.ie_agrupador			= 4
and		b.nr_prescricao			= c.nr_prescricao
and		b.nr_sequencia_solucao	= c.nr_seq_solucao
and		c.nr_prescricao			= nr_prescricao_p
and		c.nr_seq_solucao		= nr_seq_solucao_p
and		Obter_se_horario_liberado(a.dt_lib_horario, a.dt_horario) = 'S'
group by
		a.nr_seq_material,
		a.nr_seq_area_prep
order by
		a.nr_seq_material,
		a.nr_seq_area_prep;
	
c02 CURSOR FOR
SELECT	a.nr_seq_material,
		a.nr_seq_area_prep
from   	prescr_mat_hor a,
		prescr_material b	
where  	a.nr_prescricao		= b.nr_prescricao
and		a.nr_seq_material	= b.nr_sequencia
and		a.ie_agrupador		= 8
and		b.ie_agrupador		= 8
and		a.nr_seq_processo	= nr_seq_processo_p
and		b.nr_prescricao 	= nr_prescricao_p
and		b.nr_sequencia 		= nr_seq_material_p
and		a.dt_horario		= dt_horario_p
and		Obter_se_horario_liberado(a.dt_lib_horario, a.dt_horario) = 'S'
group by
		a.nr_seq_material,
		a.nr_seq_area_prep
order by
		a.nr_seq_material,
		a.nr_seq_area_prep;
	
c03 CURSOR FOR
SELECT	a.nr_seq_material,
		a.nr_seq_area_prep
from   	prescr_mat_hor a,
		prescr_material b	
where  	a.nr_prescricao		= b.nr_prescricao
and		a.nr_seq_material	= b.nr_sequencia
and		a.ie_agrupador		= 12
and		b.ie_agrupador		= 12
and		a.nr_seq_processo	= nr_seq_processo_p
and		b.nr_prescricao 	= nr_prescricao_p
and		b.nr_sequencia 		= nr_seq_material_p
and		a.dt_horario		= dt_horario_p
and		Obter_se_horario_liberado(a.dt_lib_horario, a.dt_horario) = 'S'
group by
		a.nr_seq_material,
		a.nr_seq_area_prep
order by
		a.nr_seq_material,
		a.nr_seq_area_prep;
					

BEGIN

select	coalesce(max(ie_grava_log_gedipa),'S')
into STRICT	ie_grava_log_gedipa_w
from	parametros_farmacia
where	cd_estabelecimento = coalesce(wheb_usuario_pck.get_cd_estabelecimento,1);

if (ie_grava_log_gedipa_w = 'S') then
	insert into log_gedipa(nr_sequencia, dt_log, nr_log, nm_objeto_execucao, nm_objeto_chamado, ds_parametros, ds_log)
	values (obter_nextval_sequence('log_gedipa'), clock_timestamp(), 905, 'ATUAL_PROC_AREA_KIT_COMP_SOL', null, 'nr_seq_processo_p='||to_char(nr_seq_processo_p)||'; nr_prescricao_p='||to_char(nr_prescricao_p)||'; nr_seq_solucao_p='||to_char(nr_seq_solucao_p)||'; dt_horario_p='||PKG_DATE_FORMATERS_TZ.TO_VARCHAR(dt_horario_p, 'timestamp', ESTABLISHMENT_TIMEZONE_UTILS.getTimeZone), obter_desc_expressao(292013) || ' da procedure ATUAL_PROC_AREA_KIT_COMP_SOL'
);
end if;

if (nr_seq_processo_p IS NOT NULL AND nr_seq_processo_p::text <> '') and (nr_prescricao_p IS NOT NULL AND nr_prescricao_p::text <> '') and (nr_seq_solucao_p IS NOT NULL AND nr_seq_solucao_p::text <> '') and (dt_horario_p IS NOT NULL AND dt_horario_p::text <> '') then
	begin
	
	if (ie_grava_log_gedipa_w = 'S') then
		insert into log_gedipa(nr_sequencia, dt_log, nr_log, nm_objeto_execucao, nm_objeto_chamado, ds_parametros, ds_log)
		values (obter_nextval_sequence('log_gedipa'), clock_timestamp(), 910, 'ATUAL_PROC_AREA_KIT_COMP_SOL', null, null, 'Open do cursor c01');
	end if;
	
	open c01;
	loop
	fetch c01 into	
			nr_seq_material_w,
			nr_seq_area_prep_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
		begin
		
		if (ie_grava_log_gedipa_w = 'S') then
			insert into log_gedipa(nr_sequencia, dt_log, nr_log, nm_objeto_execucao, nm_objeto_chamado, ds_parametros, ds_log)
			values (obter_nextval_sequence('log_gedipa'), clock_timestamp(), 915, 'ATUAL_PROC_AREA_KIT_COMP_SOL', null,'nr_seq_processo_p='||to_char(nr_seq_processo_p)||'; nr_seq_area_prep_w='||to_char(nr_seq_area_prep_w)||'; dt_horario_p='||PKG_DATE_FORMATERS_TZ.TO_VARCHAR(dt_horario_p, 'timestamp', ESTABLISHMENT_TIMEZONE_UTILS.getTimeZone)||'; nr_prescricao_p='||to_char(nr_prescricao_p)||'; nr_seq_material_w='||to_char(nr_seq_material_w), 'Update 01 na tabela PRESCR_MAT_HOR');
		end if;
		
		update	prescr_mat_hor a
		set		a.nr_seq_processo	= nr_seq_processo_p,
				a.nr_seq_area_prep	= nr_seq_area_prep_w
		where	a.nr_sequencia in (
					SELECT	x.nr_sequencia
					from	prescr_mat_hor x,
							prescr_material y
					where	x.nr_prescricao		= y.nr_prescricao
					and		x.nr_seq_material	= y.nr_sequencia
					and		y.ie_agrupador 		in (4,2)
					and 	x.ie_agrupador 		in (4,2)
					and		x.dt_horario		= dt_horario_p
					and		y.nr_prescricao		= nr_prescricao_p
					and		y.nr_seq_kit		= nr_seq_material_w
					and		Obter_se_horario_liberado(x.dt_lib_horario, x.dt_horario) = 'S');
					
		if (ie_grava_log_gedipa_w = 'S') then			
			insert into log_gedipa(nr_sequencia, dt_log, nr_log, nm_objeto_execucao, nm_objeto_chamado, ds_parametros, ds_log)
			values (obter_nextval_sequence('log_gedipa'), clock_timestamp(), 920, 'ATUAL_PROC_AREA_KIT_COMP_SOL', null, null, 'End fetch do cursor c01');							
		end if;
		end;
	end loop;
	close c01;
	
	if (ie_grava_log_gedipa_w = 'S') then
		insert into log_gedipa(nr_sequencia, dt_log, nr_log, nm_objeto_execucao, nm_objeto_chamado, ds_parametros, ds_log)
		values (obter_nextval_sequence('log_gedipa'), clock_timestamp(), 925, 'ATUAL_PROC_AREA_KIT_COMP_SOL', null, null, 'Close do cursor c01');								
	end if;
	end;	
	
elsif (nr_seq_processo_p IS NOT NULL AND nr_seq_processo_p::text <> '') and (nr_prescricao_p IS NOT NULL AND nr_prescricao_p::text <> '') and (coalesce(nr_seq_solucao_p::text, '') = '') and (nr_seq_material_p IS NOT NULL AND nr_seq_material_p::text <> '') and (coalesce(ie_sup_oral_p,'N') = 'N') and (dt_horario_p IS NOT NULL AND dt_horario_p::text <> '') then
	begin
	
	if (ie_grava_log_gedipa_w = 'S') then
		insert into log_gedipa(nr_sequencia, dt_log, nr_log, nm_objeto_execucao, nm_objeto_chamado, ds_parametros, ds_log)
		values (obter_nextval_sequence('log_gedipa'), clock_timestamp(), 910, 'ATUAL_PROC_AREA_KIT_COMP_SOL', null, null, 'Open do cursor c02');
	end if;
	
	open c02;
	loop
	fetch c02 into	nr_seq_material_w,
			nr_seq_area_prep_w;
	EXIT WHEN NOT FOUND; /* apply on c02 */
		begin

		if (ie_grava_log_gedipa_w = 'S') then
			insert into log_gedipa(nr_sequencia, dt_log, nr_log, nm_objeto_execucao, nm_objeto_chamado, ds_parametros, ds_log)
			values (obter_nextval_sequence('log_gedipa'), clock_timestamp(), 915, 'ATUAL_PROC_AREA_KIT_COMP_SOL', null,'nr_seq_processo_p='||to_char(nr_seq_processo_p)||'; nr_seq_area_prep_w='||to_char(nr_seq_area_prep_w)||'; dt_horario_p='||PKG_DATE_FORMATERS_TZ.TO_VARCHAR(dt_horario_p, 'timestamp', ESTABLISHMENT_TIMEZONE_UTILS.getTimeZone)||'; nr_prescricao_p='||to_char(nr_prescricao_p)||'; nr_seq_material_w='||to_char(nr_seq_material_w), 'Update 01 na tabela PRESCR_MAT_HOR-2');
		end if;
		
		update	prescr_mat_hor a
		set		a.nr_seq_processo	= nr_seq_processo_p,
					a.nr_seq_area_prep	= nr_seq_area_prep_w
		where	a.nr_sequencia in (
					SELECT	x.nr_sequencia
					from	prescr_mat_hor x,
							prescr_material y
					where	x.nr_prescricao		= y.nr_prescricao
					and		x.nr_seq_material	= y.nr_sequencia
					and		y.ie_agrupador 		= 8
					and 	x.ie_agrupador 		= 8
					and		x.dt_horario		= dt_horario_p
					and		y.nr_prescricao		= nr_prescricao_p
					and		y.nr_seq_kit		= nr_seq_material_w
					and		Obter_se_horario_liberado(x.dt_lib_horario, x.dt_horario) = 'S');
		
		if (ie_grava_log_gedipa_w = 'S') then
			insert into log_gedipa(nr_sequencia, dt_log, nr_log, nm_objeto_execucao, nm_objeto_chamado, ds_parametros, ds_log)
			values (obter_nextval_sequence('log_gedipa'), clock_timestamp(), 920, 'ATUAL_PROC_AREA_KIT_COMP_SOL', null, null, 'End fetch do cursor c02');							
		end if;
		end;
	end loop;
	close c02;
	
	if (ie_grava_log_gedipa_w = 'S') then
		insert into log_gedipa(nr_sequencia, dt_log, nr_log, nm_objeto_execucao, nm_objeto_chamado, ds_parametros, ds_log)
		values (obter_nextval_sequence('log_gedipa'), clock_timestamp(), 925, 'ATUAL_PROC_AREA_KIT_COMP_SOL', null, null, 'Close do cursor c02');								
	end if;
	
	end;
elsif (nr_seq_processo_p IS NOT NULL AND nr_seq_processo_p::text <> '') and (nr_prescricao_p IS NOT NULL AND nr_prescricao_p::text <> '') and (coalesce(nr_seq_solucao_p::text, '') = '') and (nr_seq_material_p IS NOT NULL AND nr_seq_material_p::text <> '') and (coalesce(ie_sup_oral_p,'N') = 'S') and (dt_horario_p IS NOT NULL AND dt_horario_p::text <> '') then
	begin
	
	if (ie_grava_log_gedipa_w = 'S') then
		insert into log_gedipa(nr_sequencia, dt_log, nr_log, nm_objeto_execucao, nm_objeto_chamado, ds_parametros, ds_log)
		values (obter_nextval_sequence('log_gedipa'), clock_timestamp(), 910, 'ATUAL_PROC_AREA_KIT_COMP_SOL', null, null, 'Open do cursor c03');
	end if;
	
	open c03;
	loop
	fetch c03 into	nr_seq_material_w,
			nr_seq_area_prep_w;
	EXIT WHEN NOT FOUND; /* apply on c03 */
		begin
		
		if (ie_grava_log_gedipa_w = 'S') then
			insert into log_gedipa(nr_sequencia, dt_log, nr_log, nm_objeto_execucao, nm_objeto_chamado, ds_parametros, ds_log)
			values (obter_nextval_sequence('log_gedipa'), clock_timestamp(), 915, 'ATUAL_PROC_AREA_KIT_COMP_SOL', null,'nr_seq_processo_p='||to_char(nr_seq_processo_p)||'; nr_seq_area_prep_w='||to_char(nr_seq_area_prep_w)||'; dt_horario_p='||PKG_DATE_FORMATERS_TZ.TO_VARCHAR(dt_horario_p, 'timestamp', ESTABLISHMENT_TIMEZONE_UTILS.getTimeZone)||'; nr_prescricao_p='||to_char(nr_prescricao_p)||'; nr_seq_material_w='||to_char(nr_seq_material_w), 'Update 01 na tabela PRESCR_MAT_HOR-3');
		end if;
		
		update	prescr_mat_hor a
		set	a.nr_seq_processo	= nr_seq_processo_p,
			a.nr_seq_area_prep	= nr_seq_area_prep_w
		where	a.nr_sequencia in (
					SELECT	x.nr_sequencia
					from	prescr_mat_hor x,
						prescr_material y
					where	x.nr_prescricao		= y.nr_prescricao
					and	x.nr_seq_material	= y.nr_sequencia
					and	y.ie_agrupador 		= 12
					and 	x.ie_agrupador 		= 12
					and	x.dt_horario		= dt_horario_p
					and	y.nr_prescricao		= nr_prescricao_p
					and	y.nr_seq_kit		= nr_seq_material_w
					and	Obter_se_horario_liberado(x.dt_lib_horario, x.dt_horario) = 'S');
					
		if (ie_grava_log_gedipa_w = 'S') then
			insert into log_gedipa(nr_sequencia, dt_log, nr_log, nm_objeto_execucao, nm_objeto_chamado, ds_parametros, ds_log)
			values (obter_nextval_sequence('log_gedipa'), clock_timestamp(), 920, 'ATUAL_PROC_AREA_KIT_COMP_SOL', null, null, 'End fetch do cursor c02');
		end if;
		end;
	end loop;
	close c03;
	
	if (ie_grava_log_gedipa_w = 'S') then		
		insert into log_gedipa(nr_sequencia, dt_log, nr_log, nm_objeto_execucao, nm_objeto_chamado, ds_parametros, ds_log)
		values (obter_nextval_sequence('log_gedipa'), clock_timestamp(), 925, 'ATUAL_PROC_AREA_KIT_COMP_SOL', null, null, 'Close do cursor c03');
	end if;	
	
	end;
end if;
if (ie_grava_log_gedipa_w = 'S') then
	insert into log_gedipa(nr_sequencia, dt_log, nr_log, nm_objeto_execucao, nm_objeto_chamado, ds_parametros, ds_log)
	values (obter_nextval_sequence('log_gedipa'), clock_timestamp(), 930, 'ATUAL_PROC_AREA_KIT_COMP_SOL', null, 'nr_seq_processo_p='||to_char(nr_seq_processo_p)||'; nr_prescricao_p='||to_char(nr_prescricao_p)||'; nr_seq_solucao_p='||to_char(nr_seq_solucao_p)||'; dt_horario_p='||PKG_DATE_FORMATERS_TZ.TO_VARCHAR(dt_horario_p, 'timestamp', ESTABLISHMENT_TIMEZONE_UTILS.getTimeZone), obter_desc_expressao(290116) || ' da procedure ATUAL_PROC_AREA_KIT_COMP_SOL'
);
end if;
exception
when others then
	ds_erro_w	:= substr(SQLERRM(SQLSTATE),1,1800);
	if (ie_grava_log_gedipa_w = 'S') then
		insert into log_gedipa(nr_sequencia, dt_log, nr_log, nm_objeto_execucao, nm_objeto_chamado, ds_parametros, ds_log)
		values (obter_nextval_sequence('log_gedipa'), clock_timestamp(), 905, 'ATUAL_PROC_AREA_KIT_COMP_SOL', null, 'nr_seq_processo_p='||to_char(nr_seq_processo_p)||'; nr_prescricao_p='||to_char(nr_prescricao_p)||'; nr_seq_solucao_p='||to_char(nr_seq_solucao_p)||'; dt_horario_p='||PKG_DATE_FORMATERS_TZ.TO_VARCHAR(dt_horario_p, 'timestamp', ESTABLISHMENT_TIMEZONE_UTILS.getTimeZone), obter_desc_expressao(289744) || ' na ' || lower(obter_desc_expressao(308293)) || ' da procedure ATUAL_PROC_AREA_KIT_COMP_SOL'
);
	end if;
	
	if (coalesce(wheb_usuario_pck.get_ie_commit, 'S') = 'S') then commit; end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE atual_proc_area_kit_comp_sol ( nr_seq_processo_p bigint, nr_prescricao_p bigint, nr_seq_solucao_p bigint, dt_horario_p timestamp, nr_seq_material_p bigint, ie_sup_oral_p text) FROM PUBLIC;

