-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE cpoe_ajustar_prescr_mat_proc ( nr_atendimento_p bigint, nr_seq_procedimento_p bigint, nr_seq_proc_interno_p bigint, cd_intervalo_p text, ds_horarios_p text, nr_ocorrencia_p bigint, cd_estabelecimento_p bigint, cd_perfil_p bigint, nm_usuario_p text) AS $body$
DECLARE

									
cd_interv_pad_w			proc_int_mat_prescr.cd_intervalo%type;
cd_convenio_w			atend_categoria_convenio.cd_convenio%type;
cd_setor_atendimento_w	setor_atendimento.cd_setor_atendimento%type;
cd_paciente_w			atendimento_paciente.cd_pessoa_fisica%type;
ie_tipo_atendimento_w	atendimento_paciente.ie_tipo_atendimento%type;
qt_peso_w				prescr_medica.qt_peso%type;
nr_sequencia_w			cpoe_material.nr_sequencia%type;
cd_material_w			cpoe_material.cd_material%type;
cd_medico_w				cpoe_procedimento.cd_medico%type;
qt_idade_dia_w			double precision;
count_w					bigint;
ie_urgencia_w			cpoe_material.ie_urgencia%type;
									
C01 CURSOR FOR
	SELECT 	nr_sequencia,
			cd_material
	from 	cpoe_material
	where 	nr_atendimento = nr_atendimento_p
	and 	nr_seq_procedimento = nr_seq_procedimento_p
	and		(cd_material IS NOT NULL AND cd_material::text <> '');

C02 CURSOR FOR
SELECT	cd_intervalo,
	dt_prev_execucao,
	ds_horarios,
	ie_se_necessario,
	ie_acm,
	ie_urgencia,
	qt_procedimento,
	ie_administracao,
	ie_evento_unico,
	dt_inicio,
	dt_fim,
	ie_duracao
from	cpoe_procedimento
where	nr_sequencia = nr_seq_procedimento_p;	
c02_w	c02%rowtype;	
		

BEGIN

if (nr_atendimento_p IS NOT NULL AND nr_atendimento_p::text <> '') and (nr_seq_proc_interno_p IS NOT NULL AND nr_seq_proc_interno_p::text <> '') then
	open C01;
	loop
	fetch C01 into	
		nr_sequencia_w,
		cd_material_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
	
		select	max(cd_medico),
					max(ie_urgencia)
		into STRICT		cd_medico_w,
					ie_urgencia_w
		from 		cpoe_procedimento
		where	nr_sequencia = nr_seq_procedimento_p;
	
		begin
			select	max(cd_convenio)
			into STRICT	cd_convenio_w
			from	atend_categoria_convenio
			where	nr_atendimento = nr_atendimento_p
			and		nr_seq_interno = obter_atecaco_atendimento(nr_atendimento_p);
		exception
		when others then
			cd_convenio_w := null;
		end;
		
		cd_setor_atendimento_w	:= cpoe_obter_setor_atend_prescr(nr_atendimento_p, cd_estabelecimento_p, cd_perfil_p, nm_usuario_p);
		
		select	max(cd_pessoa_fisica),
				coalesce(max(ie_tipo_atendimento),1)
		into STRICT	cd_paciente_w,
				ie_tipo_atendimento_w
		from	atendimento_paciente
		where	nr_atendimento	= nr_atendimento_p;
		
		select  coalesce((max(obter_idade(dt_nascimento, clock_timestamp(), 'DIA')))::numeric ,0)
		into STRICT	qt_idade_dia_w
		from	pessoa_fisica
		where	cd_pessoa_fisica = cd_paciente_w;
		
		begin
			select 	max(obter_sinal_vital(nr_atendimento_p,'PESO'))
			into STRICT	qt_peso_w
			;
		exception
		when others then
			qt_peso_w := null;
		end;
	
		select	max(a.cd_intervalo),
				count(a.nr_sequencia)
		into STRICT	cd_interv_pad_w,	
				count_w
		from	proc_int_mat_prescr a
		where	coalesce(a.ie_situacao,'A')	= 'A'
		and		((coalesce(a.cd_convenio_exc::text, '') = '') or (a.cd_convenio_exc <> cd_convenio_w))
		and		((coalesce(a.cd_medico::text, '') = '') or (a.cd_medico = cd_medico_w))
		and		Obter_se_mat_setor(a.nr_sequencia, cd_setor_atendimento_w, cd_convenio_w, ie_tipo_atendimento_w) = 'S'
		and		((coalesce(a.ie_tipo_atendimento::text, '') = '') or (a.ie_tipo_atendimento = ie_tipo_atendimento_w))
		and		((coalesce(a.cd_convenio::text, '') = '') or (a.cd_convenio = cd_convenio_w))
		and		((coalesce(a.cd_setor_atendimento::text, '') = '') or (a.cd_setor_atendimento = cd_setor_atendimento_w))
		and		((coalesce(a.cd_estabelecimento::text, '') = '') or (a.cd_estabelecimento = cd_estabelecimento_p))
		and		coalesce(qt_idade_dia_w,1) between coalesce(obter_idade_mat_int_prescr(a.nr_sequencia,'MIN'),0) and coalesce(obter_idade_mat_int_prescr(a.nr_sequencia,'MAX'),9999999)
		and		cpoe_obter_se_medic_lib_med(nr_atendimento_p, a.cd_material, 'S', a.ie_via_aplicacao, ie_tipo_atendimento_w, cd_setor_atendimento_w,
											cd_perfil_p, cd_convenio_w, nm_usuario_p, cd_estabelecimento_p, cd_paciente_w, clock_timestamp()) = 'S'
		and		a.nr_seq_proc_interno = nr_seq_proc_interno_p
		and 	a.cd_material = cd_material_w
		and		coalesce(qt_peso_w,0) between coalesce(a.qt_peso_min,0) and coalesce(a.qt_peso_max,999);
		
		if (coalesce(cd_interv_pad_w::text, '') = '') and (count_w > 0) then
		
			update 	cpoe_material
			set 	cd_intervalo 	= cd_intervalo_p,
					ds_horarios		= ds_horarios_p,
					nr_ocorrencia 	= nr_ocorrencia_p
			where 	nr_sequencia = nr_sequencia_w;
		
		end if;

        update 	cpoe_material a
        set 	a.ie_urgencia = ie_urgencia_w
        where 	a.nr_sequencia = nr_sequencia_w;

	end loop;
	close C01;
	
	open C02;
	loop
	fetch C02 into	
		c02_w;
	EXIT WHEN NOT FOUND; /* apply on C02 */
		begin
		if (coalesce(nr_seq_procedimento_p,0) > 0) then
			update	cpoe_procedimento
			set	cd_intervalo 	 = c02_w.cd_intervalo,
				dt_prev_execucao = c02_w.dt_prev_execucao,
				ds_horarios	 = c02_w.ds_horarios,
				ie_se_necessario = c02_w.ie_se_necessario,
				ie_acm		 = c02_w.ie_acm,
				ie_urgencia	 = c02_w.ie_urgencia,
				qt_procedimento	 = c02_w.qt_procedimento,
				ie_administracao = c02_w.ie_administracao,
        				ie_evento_unico= c02_w.ie_evento_unico,
				dt_inicio = c02_w.dt_inicio,
				dt_fim = c02_w.dt_fim,
				ie_duracao = c02_w.ie_duracao
			where	nr_seq_proc_princ = nr_seq_procedimento_p;

		end if;
		end;
	end loop;
	close C02;
	
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cpoe_ajustar_prescr_mat_proc ( nr_atendimento_p bigint, nr_seq_procedimento_p bigint, nr_seq_proc_interno_p bigint, cd_intervalo_p text, ds_horarios_p text, nr_ocorrencia_p bigint, cd_estabelecimento_p bigint, cd_perfil_p bigint, nm_usuario_p text) FROM PUBLIC;

