-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_lote_atend_prescr_desdob ( nr_prescricao_p bigint, nr_sequencia_p bigint, nr_seq_horario_p bigint, ie_so_aprazado_p text, nm_usuario_p text, ie_origem_lote_p text, nr_etapa_p bigint default 0) AS $body$
DECLARE



nr_sequencia_w			bigint;
cd_material_w			bigint;
nr_seq_mat_hor_w		bigint;
nr_seq_mat_hor_ant_w		bigint;
nr_seq_solucao_w		bigint;	
nr_seq_solucao_ant_w		bigint := 0;
cd_unidade_medida_w		varchar(30);
ie_gerar_lote_null_w		varchar(3);
qt_dispensar_w			double precision;
qt_dispensar_hor_w		double precision;
nr_seq_turno_w			bigint;
nr_seq_turno_ant_w		bigint := 0;
cd_setor_atendimento_w		integer;
dt_horario_w			timestamp;
dt_horario_ant_w		timestamp;
hr_inicio_turno_w		varchar(5);
hr_hora_w			varchar(5);
dt_atend_lote_w			timestamp;
dt_inicio_turno_w		timestamp;
cd_estabelecimento_w		smallint;
ie_urgente_w			varchar(1);
ds_maq_user_w 			varchar(80);
cd_perfil_ativo_w		integer;
nr_seq_classif_w		bigint;
nr_seq_classif_ant_w		bigint := 0;
ds_erro_w			varchar(2000);
qt_min_antes_atend_w		bigint;
qt_min_receb_setor_w		bigint;
qt_min_entr_setor_w		bigint;
qt_min_disp_farm_w		bigint;
qt_min_atend_farm_w		bigint;
qt_min_inicio_atend_w		bigint;
cd_tipo_baixa_w			smallint;
ie_conta_paciente_w		varchar(1);
ie_atualiza_estoque_w		varchar(1);
cd_local_estoque_w		smallint;
cd_local_estoque_ant_w		smallint := 0;
ie_hora_antes_w			varchar(1);
ie_classif_nao_padrao_w		varchar(15);
qt_prioridade_w			smallint;
ie_lote_acm_sn_w		varchar(1);
ie_gerar_acm_w			varchar(1);
ie_gerar_sn_w			varchar(1);
ie_acm_w			varchar(1);
ie_se_necessario_w		varchar(1);
ie_gera_lote_orig_w		varchar(1);
ie_gera_lote_medic_pac_w	varchar(1);
ie_gerar_novo_lote_turno_dia_w	varchar(15);
ie_gerar_lote_area_w		varchar(1);
ie_gerar_solucao_separado_w	varchar(1);
ie_termolabil_w			varchar(1);
ie_alto_risco_w			varchar(1);
ie_novo_lote_dia_w		varchar(1);
cd_material_ww			bigint;
nr_seq_prescr_mat_w		bigint;
ie_gera_novo_lote_w		varchar(1);
ie_desdobra_mesmo_turno_w	varchar(1);
ie_gerar_lote_apos_horario_w	varchar(1);
ie_gera_lote_desdobrado_w	varchar(1);
ie_itens_proced_sep_w		varchar(1);
nr_sequencia_proc_w		integer;
nr_sequencia_proc_ant_w		integer;
ie_gerar_lote_acm_sn_uti_w	varchar(1);
ie_setor_atual_w		varchar(1);
nr_atendimento_w		bigint;
nr_seq_regra_termo_w		bigint;
nr_seq_regra_ne_w		bigint;
ie_itens_associados_termo_w	varchar(1);
ie_itens_associados_ne_w	varchar(1);
ie_motivo_prescricao_w		varchar(5);
ie_gera_lote_separado_w		varchar(1);
nr_seq_lote_sep_w		bigint;
ie_gerar_lote_solucao_w		varchar(1);
ie_ajusta_local_item_sol_w	varchar(1);
ie_setor_lote_w			setor_atendimento.ie_gerar_lote%type;
ie_quimio_w			varchar(1);
qt_prioridade_hor_w		classif_lote_disp_far.qt_prioridade%type;
ie_gera_integracao_w		varchar(1);
--ie_gerar_lote_disp_w	regra_local_dispensacao.ie_gerar_lote_manipulacao%type := 'S';

--ie_gerar_lote_disp_ww	material_diluicao.ie_gerar_lote_manipulacao%type := 'S';
ie_agrupador_w  		prescr_mat_hor.ie_agrupador%type;
--nr_seq_mat_diluicao_w	prescr_material.nr_seq_mat_diluicao%type;
nr_seq_regra_local_w	regra_local_dispensacao.nr_sequencia%type;
ie_geracao_rotina_w		varchar(1);
nr_sequencia_proc_ww		prescr_material.nr_sequencia_proc%type;
ie_gerar_sol_separado_w		parametros_farmacia.ie_gerar_sol_separado%type;
qt_existe_regra_w		bigint;
nr_regra_local_disp_w	bigint;
ie_gerar_ap_lote_w		regra_local_dispensacao.ie_gerar_ap_lote%type;
qt_contr_pador_w 			bigint;
ie_controlado_w			prescr_mat_hor.ie_controlado%type;
nr_seq_regra_recomend_w		parametros_farmacia.nr_seq_regra_recomend%type;
nr_seq_regra_controlado_w	parametros_farmacia.nr_seq_regra_controlado%type;
ie_itens_assoc_recomend_w	regra_geracao_lote_sep.ie_itens_associados%type;
ie_itens_assoc_controlado_w	regra_geracao_lote_sep.ie_itens_associados%type;
nr_seq_empresa_w		empresa_integracao.nr_sequencia%type;
ie_existe_w			varchar(1) := 'N';
dt_prescricao_w		timestamp;
ie_origem_lote_w		varchar(100);
nr_seq_mat_hor_aip_ais_w	bigint;
ds_param_integ_hl7_w		varchar(4000) := '';
ds_param_bifrost_w			varchar(255);
cd_pessoa_fisica_w			pessoa_fisica.cd_pessoa_fisica%type;
nr_seq_lote_w			bigint;
reg_integracao_p			gerar_int_padrao.reg_integracao;
VarNaoGerarSoPrimeiraEtapa_w	varchar(5);
ie_desdobrar_solucao_w		varchar(1);
ie_send_integration_w varchar(1) := 'N';

-- Busca os materiais principais que possuem associados
C01 CURSOR FOR
	SELECT  b.cd_material,
		b.nr_sequencia,
		c.nr_sequencia,
		b.cd_unidade_medida,
		b.qt_dispensar,
		b.qt_dispensar_hor,
		coalesce(b.nr_seq_turno,-1),
		b.dt_horario,
		to_char(b.dt_horario,'hh24:mi'),
		coalesce(a.cd_estabelecimento,1),
		b.ie_urgente,
		b.nr_seq_classif,
		coalesce(b.cd_local_estoque,coalesce(c.cd_local_estoque,a.cd_local_estoque)) cd_local,
		coalesce(c.nr_sequencia_proc,0),
		coalesce(b.nr_regra_local_disp,c.nr_seq_regra_local)
	from	material x,
		prescr_mat_hor b,
		prescr_material c,
		prescr_medica   a
	where	a.nr_prescricao = b.nr_prescricao
	and	x.cd_material	= c.cd_material
	and	a.nr_prescricao	= c.nr_prescricao
	and	c.nr_sequencia	= b.nr_seq_material
	and	a.nr_prescricao = nr_prescricao_p
	and coalesce(b.nr_seq_superior::text, '') = ''						
	and	Obter_se_setor_lote(cd_setor_atendimento_w) = 'S'
	and	((coalesce(nr_sequencia_p, 0) = 0) or (c.nr_sequencia = nr_sequencia_p))
	and	((coalesce(nr_seq_horario_p, 0) = 0) or (b.nr_sequencia = nr_seq_horario_p))
	and	((coalesce(ie_so_aprazado_p, 'N') = 'N') or (coalesce(ie_so_aprazado_p, 'N') = ie_aprazado))
	and	coalesce(b.ie_situacao,'A') <> 'I'
	and	coalesce(c.ie_suspenso,'N') <> 'S'
	and	coalesce(x.ie_gerar_lote,'S') = 'S'
	and	coalesce(a.dt_suspensao::text, '') = ''
	and	coalesce(b.dt_suspensao::text, '') = ''
	and	coalesce(c.nr_sequencia_solucao::text, '') = ''
	and	coalesce(c.cd_motivo_baixa,0) = 0
	and	coalesce(c.dt_baixa::text, '') = ''
	and	((ie_gerar_lote_null_w = 'S') or (c.ds_horarios IS NOT NULL AND c.ds_horarios::text <> '') or (ie_origem_lote_p = 'AIP'))
	and	((VarNaoGerarSoPrimeiraEtapa_w = 'N') or (coalesce(b.nr_etapa_sol,1) = 1)  or (ie_origem_lote_p = 'GASR'))
	and	(b.nr_seq_turno IS NOT NULL AND b.nr_seq_turno::text <> '')
	and	coalesce(b.ie_gerar_lote,'S') = 'S'
	and	coalesce(c.ie_gerar_lote,'S') = 'S'
	and	coalesce(b.qt_dispensar_hor,0) > 0
	and	coalesce(b.nr_seq_lote::text, '') = ''
	and (b.nr_seq_classif IS NOT NULL AND b.nr_seq_classif::text <> '')
	and	((coalesce(c.ie_agrupador,0) <> 5) or (coalesce(ie_itens_proced_sep_w,'N') = 'N'))
	and	((ie_gerar_acm_w = 'S') or (ie_gerar_acm_w = 'N' and (coalesce(c.ie_acm, 'N') = 'N' or coalesce(b.ie_dose_especial,'N') = 'S')) or ((ie_gerar_lote_acm_sn_uti_w = 'S') and (obter_classif_setor(cd_setor_atendimento_w) = 4)))
	and	((ie_gerar_sn_w = 'S') or (ie_gerar_sn_w = 'N' and (coalesce(c.ie_se_necessario, 'N') = 'N' or coalesce(b.ie_dose_especial,'N') = 'S')) or ((ie_gerar_lote_acm_sn_uti_w = 'S') and (obter_classif_setor(cd_setor_atendimento_w) = 4)))
	and	((ie_gera_lote_orig_w = 'N') or ((ie_origem_lote_p <> 'AIP') or (coalesce(b.ie_aprazado,'N') = 'S')))
	and	((ie_gera_lote_medic_pac_w = 'S') or ((ie_gera_lote_medic_pac_w = 'N') and (coalesce(ie_medicacao_paciente,'N') = 'N')))
	and	((ie_gerar_lote_area_w = 'S') or (coalesce(b.nr_seq_area_prep::text, '') = ''))
	and	((ie_origem_lote_p <> 'AIS') or ((ie_origem_lote_p = 'AIS') and exists (	SELECT	1
												from	prescr_mat_hor d
												where	d.nr_prescricao   = c.nr_prescricao						
												and	d.nr_seq_material = c.nr_seq_kit
												and	d.ie_agrupador = 4)))
	and	Obter_se_horario_liberado(b.dt_lib_horario, b.dt_horario) = 'S'
	and	((coalesce(x.ie_termolabil,'N') = 'N') or (coalesce(nr_seq_regra_termo_w,0) = 0))
	and	((coalesce(ie_itens_associados_termo_w,'N') = 'N') or
		((ie_itens_associados_termo_w = 'S') and not exists (	select	1
									from	prescr_material d
									where	d.nr_prescricao = c.nr_prescricao
									and	d.nr_sequencia = b.nr_seq_superior
									and exists (select 1 from material z where z.cd_material = d.cd_material and z.ie_termolabil = 'S'))))
	and	((coalesce(b.ie_agrupador,0) <> 8) or (coalesce(nr_seq_regra_ne_w,0) = 0))
	and	((coalesce(ie_itens_associados_ne_w,'N') = 'N') or
		((ie_itens_associados_ne_w = 'S') and not exists (	select	1
									from	prescr_material d
									where	d.nr_prescricao = c.nr_prescricao
									and	d.nr_sequencia = b.nr_seq_superior
									and	d.ie_agrupador = 8)))
	and	((coalesce(ie_alto_risco_w,'N') = 'N') or ((coalesce(ie_alto_risco_w,'N') = 'S') and (obter_se_material_risco(cd_setor_atendimento_w,b.cd_material) = 'N')))
	and 	((coalesce(ie_gera_lote_separado_w,'N') = 'N') or ((coalesce(ie_gera_lote_separado_w,'N') = 'S') and (coalesce(x.ie_gera_lote_separado,'N') = 'N')))
	and	((coalesce(c.nr_seq_recomendacao,0) = 0) or (coalesce(nr_seq_regra_recomend_w,0) = 0))
	and	((coalesce(ie_itens_assoc_recomend_w,'N') = 'N') or
		((ie_itens_assoc_recomend_w = 'S') and not exists (	select	1
									from	prescr_recomendacao d
									where	d.nr_prescricao = c.nr_prescricao
									and	d.nr_sequencia = c.nr_seq_recomendacao)))
	and	((obter_se_medic_controlado(b.cd_material) = 'N') or (coalesce(nr_seq_regra_controlado_w,0) = 0))
	and	((coalesce(ie_itens_assoc_controlado_w,'N') = 'N') or
		((ie_itens_assoc_controlado_w = 'S') and not exists (	select	1
									from	prescr_material d
									where	d.nr_prescricao = c.nr_prescricao
									and	d.nr_sequencia = b.nr_seq_superior
									and exists (select 1 from medic_controlado z where z.cd_material = d.cd_material and z.ie_situacao = 'A' and coalesce(z.cd_estabelecimento, cd_estabelecimento_w) = cd_estabelecimento_w))))
	and (exists (select  1
					 from  prescr_material y,
					  	   prescr_mat_hor k
					where  y.nr_prescricao = c.nr_prescricao
					  and k.nr_prescricao = y.nr_prescricao
					  and k.nr_seq_material = y.nr_sequencia
					  and (y.nr_sequencia_diluicao = c.nr_sequencia or 
						    y.nr_seq_kit  = c.nr_sequencia or
						    k.nr_seq_superior = c.nr_sequencia)
					  and coalesce(y.nr_seq_recomendacao::text, '') = ''))
	order by dt_horario,
		 cd_local,
		 nr_seq_classif;
		
-- Busca os materiais associados (cursor 1)
c10 CURSOR FOR
	SELECT  b.cd_material,
		b.nr_sequencia,
		b.cd_unidade_medida,
		b.qt_dispensar,
		b.qt_dispensar_hor,
		coalesce(b.nr_seq_turno,-1),
		b.dt_horario,
		to_char(b.dt_horario,'hh24:mi'),
		coalesce(a.cd_estabelecimento,1),
		b.ie_urgente,
		b.nr_seq_classif,
		coalesce(b.cd_local_estoque,coalesce(c.cd_local_estoque,a.cd_local_estoque)) cd_local,
		b.ie_agrupador,
		coalesce(b.nr_regra_local_disp,c.nr_seq_regra_local)
	from	material x,
		prescr_mat_hor  b,
		prescr_material c,
		prescr_medica   a
	where	a.nr_prescricao = b.nr_prescricao
	and	a.nr_prescricao	= c.nr_prescricao
	and	c.nr_sequencia	= b.nr_seq_material
	and	a.nr_prescricao = nr_prescricao_p
	and	x.cd_material	= c.cd_material
	and	coalesce(x.ie_gerar_lote,'S') = 'S'
	and	coalesce(nr_seq_prescr_mat_w, 0) > 0
	and	coalesce(b.nr_seq_lote::text, '') = ''
	and	Obter_se_setor_lote(cd_setor_atendimento_w) = 'S'
	and	coalesce(c.nr_sequencia_solucao::text, '') = ''
	and (obter_se_associado(a.nr_prescricao, b.nr_seq_superior, nr_seq_prescr_mat_w) = 'S' or (c.nr_sequencia_proc = nr_sequencia_proc_ww))
	and	((VarNaoGerarSoPrimeiraEtapa_w = 'N') or (coalesce(b.nr_etapa_sol,1) = 1)  or (ie_origem_lote_p = 'GASR'))
	and	coalesce(c.nr_seq_kit,0) <> nr_seq_prescr_mat_w
	and	c.cd_motivo_baixa = 0
	and	Obter_se_horario_liberado(b.dt_lib_horario, b.dt_horario) = 'S'
	--and	(nvl(b.ie_horario_especial, 'N') = 'N' or nvl(b.ie_dose_especial,'N') = 'S')
	and	coalesce(b.ie_gerar_lote,'S') = 'S'
	and	coalesce(c.ie_gerar_lote,'S') = 'S'
	and	coalesce(b.qt_dispensar_hor,0) > 0
	and	coalesce(c.dt_baixa::text, '') = ''
	and	(b.nr_seq_turno IS NOT NULL AND b.nr_seq_turno::text <> '')
	and (b.nr_seq_classif IS NOT NULL AND b.nr_seq_classif::text <> '')
	and	b.nr_seq_turno = nr_seq_turno_w
	and	((ie_gerar_acm_w = 'S') or (ie_gerar_acm_w = 'N' and (coalesce(c.ie_acm, 'N') = 'N' or coalesce(b.ie_dose_especial,'N') = 'S')) or ((ie_gerar_lote_acm_sn_uti_w = 'S') and (obter_classif_setor(cd_setor_atendimento_w) = 4)))
	and	((ie_gerar_sn_w = 'S') or (ie_gerar_sn_w = 'N' and (coalesce(c.ie_se_necessario, 'N') = 'N' or coalesce(b.ie_dose_especial,'N') = 'S')) or ((ie_gerar_lote_acm_sn_uti_w = 'S') and (obter_classif_setor(cd_setor_atendimento_w) = 4)))
	and	((ie_origem_lote_p <> 'AIS') or	(ie_origem_lote_p = 'AIS' AND b.ie_aprazado = 'S'))
	and	((ie_gera_lote_orig_w = 'N') or ((ie_origem_lote_p <> 'AIP') or (coalesce(b.ie_aprazado,'N') = 'S')))
	and	((ie_gera_lote_medic_pac_w = 'S') or ((ie_gera_lote_medic_pac_w = 'N') and (coalesce(ie_medicacao_paciente,'N') = 'N')))
	and	((ie_gerar_lote_area_w = 'S') or (coalesce(b.nr_seq_area_prep::text, '') = ''))
	--and	((nvl(ie_termolabil_w,'N') = 'N') or ((nvl(ie_termolabil_w,'N') = 'S') and (nvl(x.ie_termolabil,'N') = 'N')))
	and	((coalesce(x.ie_termolabil,'N') = 'N') or (coalesce(nr_seq_regra_termo_w,0) = 0))
	and	((coalesce(ie_itens_associados_termo_w,'N') = 'N') or
		((ie_itens_associados_termo_w = 'S') and not exists (	SELECT	1
									from	prescr_material d
									where	d.nr_prescricao = c.nr_prescricao
									and	d.nr_sequencia = b.nr_seq_superior
									and exists (select 1 from material z where z.cd_material = d.cd_material and z.ie_termolabil = 'S'))))
	and	((coalesce(b.ie_agrupador,0) <> 8) or (coalesce(nr_seq_regra_ne_w,0) = 0))
	and	((coalesce(ie_itens_associados_ne_w,'N') = 'N') or
		((ie_itens_associados_ne_w = 'S') and not exists (	select	1
									from	prescr_material d
									where	d.nr_prescricao = c.nr_prescricao
									and	d.nr_sequencia = b.nr_seq_superior
									and	d.ie_agrupador = 8)))
	and	((coalesce(ie_alto_risco_w,'N') = 'N') or ((coalesce(ie_alto_risco_w,'N') = 'S') and (obter_se_material_risco(cd_setor_atendimento_w,b.cd_material) = 'N')))
	and	((coalesce(c.nr_seq_recomendacao,0) = 0) or (coalesce(nr_seq_regra_recomend_w,0) = 0))
	and	((coalesce(ie_itens_assoc_recomend_w,'N') = 'N') or
		((ie_itens_assoc_recomend_w = 'S') and not exists (	select	1
									from	prescr_recomendacao d
									where	d.nr_prescricao = c.nr_prescricao
									and	d.nr_sequencia = c.nr_seq_recomendacao)))
	and	((obter_se_medic_controlado(b.cd_material) = 'N') or (coalesce(nr_seq_regra_controlado_w,0) = 0))
	and	((coalesce(ie_itens_assoc_controlado_w,'N') = 'N') or
		((ie_itens_assoc_controlado_w = 'S') and not exists (	select	1
									from	prescr_material d
									where	d.nr_prescricao = c.nr_prescricao
									and	d.nr_sequencia = b.nr_seq_superior
									and exists (select 1 from medic_controlado z where z.cd_material = d.cd_material and z.ie_situacao = 'A' and coalesce(z.cd_estabelecimento, cd_estabelecimento_w) = cd_estabelecimento_w))))
	
union all

	select  b.cd_material,
		b.nr_sequencia,
		b.cd_unidade_medida,
		b.qt_dispensar,
		b.qt_dispensar_hor,
		coalesce(b.nr_seq_turno,-1),
		b.dt_horario,
		to_char(b.dt_horario,'hh24:mi'),
		coalesce(a.cd_estabelecimento,1),
		b.ie_urgente,
		b.nr_seq_classif,
		coalesce(b.cd_local_estoque,coalesce(c.cd_local_estoque,a.cd_local_estoque)) cd_local,
		b.ie_agrupador,
		c.nr_seq_regra_local
	from	material x,
		prescr_mat_hor  b,
		prescr_material c,
		prescr_medica   a
	where	a.nr_prescricao = b.nr_prescricao
	and	a.nr_prescricao	= c.nr_prescricao
	and	c.nr_sequencia	= b.nr_seq_material
	and	x.cd_material	= c.cd_material
	and	coalesce(x.ie_gerar_lote,'S') = 'S'
	and	a.nr_prescricao = nr_prescricao_p
	and	coalesce(nr_seq_prescr_mat_w, 0) > 0
	and	coalesce(b.nr_seq_lote::text, '') = ''
	and	coalesce(c.nr_sequencia_solucao::text, '') = ''
	and	coalesce(c.nr_seq_kit,0)	= nr_seq_prescr_mat_w
	and	c.cd_motivo_baixa = 0
	and	Obter_se_horario_liberado(b.dt_lib_horario, b.dt_horario) = 'S'
	and	coalesce(b.ie_gerar_lote,'S') = 'S'
	and	coalesce(c.ie_gerar_lote,'S') = 'S'
	and	Obter_se_setor_lote(cd_setor_atendimento_w) = 'S'
	--and	(nvl(b.ie_horario_especial, 'N') = 'N' or nvl(b.ie_dose_especial,'N') = 'S')
	and	coalesce(c.dt_baixa::text, '') = ''
	and	coalesce(b.qt_dispensar_hor,0) > 0
	and	(b.nr_seq_turno IS NOT NULL AND b.nr_seq_turno::text <> '')
	and (b.nr_seq_classif IS NOT NULL AND b.nr_seq_classif::text <> '')
	and	((ie_gerar_lote_null_w = 'S') or (c.ds_horarios IS NOT NULL AND c.ds_horarios::text <> '') or (ie_origem_lote_p = 'AIP'))
	and	((VarNaoGerarSoPrimeiraEtapa_w = 'N') or (coalesce(b.nr_etapa_sol,1) = 1)  or (ie_origem_lote_p = 'GASR'))
	and	b.nr_seq_turno = nr_seq_turno_w
	and	((ie_gerar_acm_w = 'S') or (ie_gerar_acm_w = 'N' and (coalesce(c.ie_acm, 'N') = 'N' or coalesce(b.ie_dose_especial,'N') = 'S')) or ((ie_gerar_lote_acm_sn_uti_w = 'S') and (obter_classif_setor(cd_setor_atendimento_w) = 4)))
	and	((ie_gerar_sn_w = 'S') or (ie_gerar_sn_w = 'N' and (coalesce(c.ie_se_necessario, 'N') = 'N' or coalesce(b.ie_dose_especial,'N') = 'S')) or ((ie_gerar_lote_acm_sn_uti_w = 'S') and (obter_classif_setor(cd_setor_atendimento_w) = 4)))
	and	((ie_origem_lote_p <> 'AIS') or	(ie_origem_lote_p = 'AIS' AND b.ie_aprazado = 'S'))
	and	((ie_gera_lote_orig_w = 'N') or ((ie_origem_lote_p <> 'AIP') or (coalesce(b.ie_aprazado,'N') = 'S')))
	and	((ie_gera_lote_medic_pac_w = 'S') or ((ie_gera_lote_medic_pac_w = 'N') and (coalesce(ie_medicacao_paciente,'N') = 'N')))
	and	((ie_gerar_lote_area_w = 'S') or (coalesce(b.nr_seq_area_prep::text, '') = ''))
	--and	((nvl(ie_termolabil_w,'N') = 'N') or ((nvl(ie_termolabil_w,'N') = 'S') and (nvl(x.ie_termolabil,'N') = 'N')))
	and	((coalesce(x.ie_termolabil,'N') = 'N') or (coalesce(nr_seq_regra_termo_w,0) = 0))
	and	((coalesce(ie_itens_associados_termo_w,'N') = 'N') or
		((ie_itens_associados_termo_w = 'S') and not exists (	select	1
									from	prescr_material d
									where	d.nr_prescricao = c.nr_prescricao
									and	d.nr_sequencia = b.nr_seq_superior
									and exists (select 1 from material z where z.cd_material = d.cd_material and z.ie_termolabil = 'S'))))
	and	((coalesce(b.ie_agrupador,0) <> 8) or (coalesce(nr_seq_regra_ne_w,0) = 0))
	and	((coalesce(ie_itens_associados_ne_w,'N') = 'N') or
		((ie_itens_associados_ne_w = 'S') and not exists (	select	1
									from	prescr_material d
									where	d.nr_prescricao = c.nr_prescricao
									and	d.nr_sequencia = b.nr_seq_superior
									and	d.ie_agrupador = 8)))
	and	((coalesce(ie_alto_risco_w,'N') = 'N') or ((coalesce(ie_alto_risco_w,'N') = 'S') and (obter_se_material_risco(cd_setor_atendimento_w,b.cd_material) = 'N')))
	and	((coalesce(c.nr_seq_recomendacao,0) = 0) or (coalesce(nr_seq_regra_recomend_w,0) = 0))
	and	((coalesce(ie_itens_assoc_recomend_w,'N') = 'N') or
		((ie_itens_assoc_recomend_w = 'S') and not exists (	select	1
									from	prescr_recomendacao d
									where	d.nr_prescricao = c.nr_prescricao
									and	d.nr_sequencia = c.nr_seq_recomendacao)))
	and	((obter_se_medic_controlado(b.cd_material) = 'N') or (coalesce(nr_seq_regra_controlado_w,0) = 0))
	and	((coalesce(ie_itens_assoc_controlado_w,'N') = 'N') or
		((ie_itens_assoc_controlado_w = 'S') and not exists (	select	1
									from	prescr_material d
									where	d.nr_prescricao = c.nr_prescricao
									and	d.nr_sequencia = b.nr_seq_superior
									and exists (select 1 from medic_controlado z where z.cd_material = d.cd_material and z.ie_situacao = 'A' and coalesce(z.cd_estabelecimento, cd_estabelecimento_w) = cd_estabelecimento_w))))
	order by cd_local,
		 nr_seq_classif,
		 dt_horario;
		
-- Busca os materiais principais que nao possuem associados	
C11 CURSOR FOR
	SELECT  b.cd_material,
		b.nr_sequencia,
		c.nr_sequencia,
		b.cd_unidade_medida,
		b.qt_dispensar,
		b.qt_dispensar_hor,
		coalesce(b.nr_seq_turno,-1),
		b.dt_horario,
		to_char(b.dt_horario,'hh24:mi'),
		coalesce(a.cd_estabelecimento,1),
		b.ie_urgente,
		b.nr_seq_classif,
		coalesce(b.cd_local_estoque,coalesce(c.cd_local_estoque,a.cd_local_estoque)) cd_local,
		coalesce(b.nr_regra_local_disp,c.nr_seq_regra_local)
	from	material x,
		prescr_mat_hor  b,
		prescr_material c,
		prescr_medica   a
	where	a.nr_prescricao = b.nr_prescricao
	and	x.cd_material	= c.cd_material
	and	a.nr_prescricao	= c.nr_prescricao
	and	c.nr_sequencia	= b.nr_seq_material
	and	a.nr_prescricao = nr_prescricao_p
	and	Obter_se_setor_lote(cd_setor_atendimento_w) = 'S'
	and	((coalesce(nr_sequencia_p, 0) = 0) or (c.nr_sequencia = nr_sequencia_p))
	and	((coalesce(nr_seq_horario_p, 0) = 0) or (b.nr_sequencia = nr_seq_horario_p))
	and	((coalesce(ie_so_aprazado_p, 'N') = 'N') or (coalesce(ie_so_aprazado_p, 'N') = ie_aprazado))
	and	coalesce(b.ie_situacao,'A') <> 'I'
	and	coalesce(c.ie_suspenso,'N') <> 'S'
	and	coalesce(x.ie_gerar_lote,'S') = 'S'
	and	coalesce(a.dt_suspensao::text, '') = ''
	and	coalesce(b.dt_suspensao::text, '') = ''
	and	coalesce(c.cd_motivo_baixa,0) = 0
	and	coalesce(c.dt_baixa::text, '') = ''
	and	(b.nr_seq_turno IS NOT NULL AND b.nr_seq_turno::text <> '')
	and	((ie_gerar_lote_null_w = 'S') or (c.ds_horarios IS NOT NULL AND c.ds_horarios::text <> '') or (ie_origem_lote_p = 'AIP'))
	and	((VarNaoGerarSoPrimeiraEtapa_w = 'N') or (coalesce(b.nr_etapa_sol,1) = 1)  or (ie_origem_lote_p = 'GASR'))
	and	coalesce(c.nr_sequencia_solucao::text, '') = ''
	and	coalesce(c.nr_sequencia_proc::text, '') = ''
	and	coalesce(b.ie_gerar_lote,'S') = 'S'
	and	coalesce(c.ie_gerar_lote,'S') = 'S'
	and	coalesce(b.qt_dispensar_hor,0) > 0
	and	coalesce(b.nr_seq_superior::text, '') = ''
	and	coalesce(b.nr_seq_lote::text, '') = ''
	and (b.nr_seq_classif IS NOT NULL AND b.nr_seq_classif::text <> '')
	and	((coalesce(c.ie_agrupador,0) <> 5) or (coalesce(ie_itens_proced_sep_w,'N') = 'N'))
	and	((ie_gerar_acm_w = 'S') or (ie_gerar_acm_w = 'N' and (coalesce(c.ie_acm, 'N') = 'N' or coalesce(b.ie_dose_especial,'N') = 'S')) or ((ie_gerar_lote_acm_sn_uti_w = 'S') and (obter_classif_setor(cd_setor_atendimento_w) = 4)))
	and	((ie_gerar_sn_w = 'S') or (ie_gerar_sn_w = 'N' and (coalesce(c.ie_se_necessario, 'N') = 'N' or coalesce(b.ie_dose_especial,'N') = 'S')) or ((ie_gerar_lote_acm_sn_uti_w = 'S') and (obter_classif_setor(cd_setor_atendimento_w) = 4)))
	and	((ie_gera_lote_orig_w = 'N') or ((ie_origem_lote_p <> 'AIP') or (coalesce(b.ie_aprazado,'N') = 'S')))
	and	((ie_gera_lote_medic_pac_w = 'S') or ((ie_gera_lote_medic_pac_w = 'N') and (coalesce(ie_medicacao_paciente,'N') = 'N')))
	and	((ie_gerar_lote_area_w = 'S') or (coalesce(b.nr_seq_area_prep::text, '') = ''))
	and	((ie_origem_lote_p <> 'AIS') or ((ie_origem_lote_p = 'AIS') and exists (	SELECT	1
												from	prescr_mat_hor d
												where	d.nr_prescricao   = c.nr_prescricao						
												and	d.nr_seq_material = c.nr_seq_kit
												and	d.ie_agrupador = 4)))
	and	Obter_se_horario_liberado(b.dt_lib_horario, b.dt_horario) = 'S'
	--and	((nvl(ie_termolabil_w,'N') = 'N') or ((nvl(ie_termolabil_w,'N') = 'S') and (nvl(x.ie_termolabil,'N') = 'N')))
	and	((coalesce(x.ie_termolabil,'N') = 'N') or (coalesce(nr_seq_regra_termo_w,0) = 0))
	and	((coalesce(b.ie_agrupador,0) <> 8) or (coalesce(nr_seq_regra_ne_w,0) = 0))
	and	((coalesce(ie_alto_risco_w,'N') = 'N') or ((coalesce(ie_alto_risco_w,'N') = 'S') and (obter_se_material_risco(cd_setor_atendimento_w,b.cd_material) = 'N')))
	and 	((coalesce(ie_gera_lote_separado_w,'N') = 'N') or ((coalesce(ie_gera_lote_separado_w,'N') = 'S') and (coalesce(x.ie_gera_lote_separado,'N') = 'N')))
	and	((coalesce(c.nr_seq_recomendacao,0) = 0) or (coalesce(nr_seq_regra_recomend_w,0) = 0))
	and	((coalesce(ie_itens_assoc_recomend_w,'N') = 'N') or
		((ie_itens_assoc_recomend_w = 'S') and not exists (	select	1
									from	prescr_recomendacao d
									where	d.nr_prescricao = c.nr_prescricao
									and	d.nr_sequencia = c.nr_seq_recomendacao)))
	and	((obter_se_medic_controlado(b.cd_material) = 'N') or (coalesce(nr_seq_regra_controlado_w,0) = 0))
	and	((coalesce(ie_itens_assoc_controlado_w,'N') = 'N') or
		((ie_itens_assoc_controlado_w = 'S') and not exists (	select	1
									from	prescr_material d
									where	d.nr_prescricao = c.nr_prescricao
									and	d.nr_sequencia = b.nr_seq_superior
									and exists (select 1 from medic_controlado z where z.cd_material = d.cd_material and z.ie_situacao = 'A' and coalesce(z.cd_estabelecimento, cd_estabelecimento_w) = cd_estabelecimento_w))))
	and (not exists (	select	1
				from	prescr_material y
				where	y.nr_prescricao = c.nr_prescricao
				and (y.nr_sequencia_diluicao = c.nr_sequencia or 
				     y.nr_seq_kit	= c.nr_sequencia)
				and coalesce(y.nr_seq_recomendacao::text, '') = ''))
	order by dt_horario,
		cd_local,
		nr_seq_classif;	

-- Busca os materiais principais - somente solucao
C12 CURSOR FOR
	SELECT  b.cd_material,
		b.nr_sequencia,
		c.nr_sequencia,
		c.nr_sequencia_solucao,
		b.cd_unidade_medida,
		b.qt_dispensar,
		b.qt_dispensar_hor,
		coalesce(b.nr_seq_turno,-1),
		b.dt_horario,
		to_char(b.dt_horario,'hh24:mi'),
		coalesce(a.cd_estabelecimento,1),
		b.ie_urgente,
		b.nr_seq_classif,
		coalesce(b.cd_local_estoque,coalesce(c.cd_local_estoque,a.cd_local_estoque)) cd_local,
		b.ie_controlado,
		coalesce(b.nr_regra_local_disp,c.nr_seq_regra_local)
	from	material x,
		prescr_mat_hor  b,
		prescr_material c,
		prescr_medica   a,
		prescr_solucao	s
	where	a.nr_prescricao = b.nr_prescricao
	and	x.cd_material	= c.cd_material
	and	a.nr_prescricao	= c.nr_prescricao
	and	c.nr_sequencia	= b.nr_seq_material
	and c.nr_prescricao = s.nr_prescricao
	and c.nr_sequencia_solucao = s.nr_seq_solucao
	and	a.nr_prescricao = nr_prescricao_p
	and	((coalesce(nr_seq_horario_p, 0) = 0) or (b.nr_sequencia = nr_seq_horario_p))
	and	((coalesce(nr_etapa_p,0) = 0) or (b.nr_etapa_sol = nr_etapa_p AND ie_origem_lote_p = 'GASR'))
	and	((coalesce(ie_so_aprazado_p, 'N') = 'N') or (coalesce(ie_so_aprazado_p, 'N') = ie_aprazado))
	and	coalesce(b.ie_situacao,'A') <> 'I'
	and	coalesce(c.ie_suspenso,'N') <> 'S'
	and	coalesce(x.ie_gerar_lote,'S') = 'S'
	and	Obter_se_setor_lote(cd_setor_atendimento_w) = 'S'
	and	coalesce(a.dt_suspensao::text, '') = ''
	and	coalesce(b.dt_suspensao::text, '') = ''
	and	coalesce(c.cd_motivo_baixa,0) = 0
	and	coalesce(c.dt_baixa::text, '') = ''
	and	(b.nr_seq_turno IS NOT NULL AND b.nr_seq_turno::text <> '')
	and	((ie_gerar_lote_null_w = 'S') or (s.hr_prim_horario IS NOT NULL AND s.hr_prim_horario::text <> '') or (ie_origem_lote_p in ('AIP', 'AIS')))
	and	((VarNaoGerarSoPrimeiraEtapa_w = 'N') or (c.nr_sequencia_solucao = coalesce(nr_sequencia_p, 0)) or (b.nr_etapa_sol = 1) or ((ie_origem_lote_p = 'GASR') and (coalesce(nr_sequencia_p, 0) = 0)))
	and	coalesce(b.ie_gerar_lote,'S') = 'S'
	and	coalesce(c.ie_gerar_lote,'S') = 'S'
	and	coalesce(b.qt_dispensar_hor,0) > 0
	and	coalesce(b.nr_seq_lote::text, '') = ''
	and (b.nr_seq_classif IS NOT NULL AND b.nr_seq_classif::text <> '')
	--and	nvl(b.ie_horario_especial, 'N') = 'N'
	and	coalesce(ie_gerar_lote_solucao_w, 'S') = 'S'
	and	((ie_gerar_acm_w = 'S') or (ie_gerar_acm_w = 'N' and (coalesce(c.ie_acm, 'N') = 'N' or coalesce(b.ie_dose_especial,'N') = 'S')) or ((ie_gerar_lote_acm_sn_uti_w = 'S') and (obter_classif_setor(cd_setor_atendimento_w) = 4)))
	and	((ie_gerar_sn_w = 'S') or (ie_gerar_sn_w = 'N' and (coalesce(c.ie_se_necessario, 'N') = 'N' or coalesce(b.ie_dose_especial,'N') = 'S')) or ((ie_gerar_lote_acm_sn_uti_w = 'S') and (obter_classif_setor(cd_setor_atendimento_w) = 4)))
	and	((ie_gera_lote_orig_w = 'N') or ((ie_origem_lote_p <> 'AIP') or (coalesce(b.ie_aprazado,'N') = 'S')))
	and	((ie_gera_lote_medic_pac_w = 'S') or ((ie_gera_lote_medic_pac_w = 'N') and (coalesce(ie_medicacao_paciente,'N') = 'N')))
	and	((ie_gerar_lote_area_w = 'S') or (coalesce(b.nr_seq_area_prep::text, '') = ''))
	and	Obter_se_horario_liberado(b.dt_lib_horario, b.dt_horario) = 'S'
	--and	((nvl(ie_termolabil_w,'N') = 'N') or ((nvl(ie_termolabil_w,'N') = 'S') and (nvl(x.ie_termolabil,'N') = 'N')))
	and	((coalesce(x.ie_termolabil,'N') = 'N') or (coalesce(nr_seq_regra_termo_w,0) = 0))
	and	((coalesce(ie_itens_associados_termo_w,'N') = 'N') or
		((ie_itens_associados_termo_w = 'S') and not exists (	SELECT	1
									from	prescr_material d
									where	d.nr_prescricao = c.nr_prescricao
									and	d.nr_sequencia = b.nr_seq_superior
									and exists (select 1 from material z where z.cd_material = d.cd_material and z.ie_termolabil = 'S'))))
	and	((coalesce(b.ie_agrupador,0) <> 8) or (coalesce(nr_seq_regra_ne_w,0) = 0))
	and	((coalesce(ie_itens_associados_ne_w,'N') = 'N') or
		((ie_itens_associados_ne_w = 'S') and not exists (	select	1
									from	prescr_material d
									where	d.nr_prescricao = c.nr_prescricao
									and	d.nr_sequencia = b.nr_seq_superior
									and	d.ie_agrupador = 8)))
	and	((coalesce(ie_alto_risco_w,'N') = 'N') or ((coalesce(ie_alto_risco_w,'N') = 'S') and (obter_se_material_risco(cd_setor_atendimento_w,b.cd_material) = 'N')))
	and ((coalesce(ie_gera_lote_separado_w,'N') = 'N') or ((coalesce(ie_gera_lote_separado_w,'N') = 'S') and (coalesce(x.ie_gera_lote_separado,'N') = 'N')))
	and coalesce(ie_gerar_solucao_separado_w,'N') = 'N'
	and	((coalesce(c.nr_seq_recomendacao,0) = 0) or (coalesce(nr_seq_regra_recomend_w,0) = 0))
	and	((coalesce(ie_itens_assoc_recomend_w,'N') = 'N') or
		((ie_itens_assoc_recomend_w = 'S') and not exists (	select	1
									from	prescr_recomendacao d
									where	d.nr_prescricao = c.nr_prescricao
									and	d.nr_sequencia = c.nr_seq_recomendacao)))
	and	((obter_se_medic_controlado(b.cd_material) = 'N') or (coalesce(nr_seq_regra_controlado_w,0) = 0))
	and	((coalesce(ie_itens_assoc_controlado_w,'N') = 'N') or
		((ie_itens_assoc_controlado_w = 'S') and not exists (	select	1
									from	prescr_material d
									where	d.nr_prescricao = c.nr_prescricao
									and	d.nr_sequencia = b.nr_seq_superior
									and exists (select 1 from medic_controlado z where z.cd_material = d.cd_material and z.ie_situacao = 'A' and coalesce(z.cd_estabelecimento, cd_estabelecimento_w) = cd_estabelecimento_w))))
	order by nr_sequencia_solucao,
		dt_horario, 
		cd_local,
		 nr_seq_classif;
		
-- Busca os materiais associados dos itens da solucao
C13 CURSOR FOR
	SELECT  b.cd_material,
		b.nr_sequencia,
		c.nr_sequencia_solucao,
		b.cd_unidade_medida,
		b.qt_dispensar,
		b.qt_dispensar_hor,
		coalesce(b.nr_seq_turno,-1),
		b.dt_horario,
		to_char(b.dt_horario,'hh24:mi'),
		coalesce(a.cd_estabelecimento,1),
		b.ie_urgente,
		b.nr_seq_classif,
		coalesce(b.cd_local_estoque,coalesce(c.cd_local_estoque,a.cd_local_estoque)) cd_local,
		coalesce(b.nr_regra_local_disp,c.nr_seq_regra_local)
	from	material x,
		prescr_mat_hor  b,
		prescr_material c,
		prescr_medica   a
	where	a.nr_prescricao = b.nr_prescricao
	and	x.cd_material	= c.cd_material
	and	a.nr_prescricao	= c.nr_prescricao
	and	c.nr_sequencia	= b.nr_seq_material
	and	a.nr_prescricao = nr_prescricao_p
	and	((coalesce(nr_sequencia_p, 0) = 0) or (c.nr_sequencia = nr_sequencia_p))
	and	((coalesce(nr_seq_horario_p, 0) = 0) or (b.nr_sequencia = nr_seq_horario_p))
	and	((coalesce(ie_so_aprazado_p, 'N') = 'N') or (coalesce(ie_so_aprazado_p, 'N') = ie_aprazado))
	and	coalesce(b.ie_situacao,'A') <> 'I'
	and	coalesce(c.ie_suspenso,'N') <> 'S'
	and	coalesce(x.ie_gerar_lote,'S') = 'S'
	and	((ie_gerar_lote_null_w = 'S') or (c.ds_horarios IS NOT NULL AND c.ds_horarios::text <> '') or (ie_origem_lote_p = 'AIP'))
	and	((VarNaoGerarSoPrimeiraEtapa_w = 'N') or (c.nr_sequencia_solucao = coalesce(nr_sequencia_p, 0)) or (b.nr_etapa_sol = 1) or ((ie_origem_lote_p = 'GASR') and (coalesce(nr_sequencia_p, 0) = 0)))
	and	coalesce(a.dt_suspensao::text, '') = ''
	and	coalesce(b.dt_suspensao::text, '') = ''
	and	Obter_se_setor_lote(cd_setor_atendimento_w) = 'S'
	and	b.nr_seq_superior = nr_seq_prescr_mat_w
	and	b.nr_seq_turno = nr_seq_turno_w
	and	coalesce(c.cd_motivo_baixa,0) = 0
	and	coalesce(c.dt_baixa::text, '') = ''
	and	(b.nr_seq_turno IS NOT NULL AND b.nr_seq_turno::text <> '')
	and	coalesce(b.ie_gerar_lote,'S') = 'S'
	and	coalesce(c.ie_gerar_lote,'S') = 'S'
	and	coalesce(b.qt_dispensar_hor,0) > 0
	and	coalesce(b.nr_seq_lote::text, '') = ''
	and (b.nr_seq_classif IS NOT NULL AND b.nr_seq_classif::text <> '')
	and	((ie_gerar_acm_w = 'S') or (ie_gerar_acm_w = 'N' and (coalesce(c.ie_acm, 'N') = 'N' or coalesce(b.ie_dose_especial,'N') = 'S')) or ((ie_gerar_lote_acm_sn_uti_w = 'S') and (obter_classif_setor(cd_setor_atendimento_w) = 4)))
	and	((ie_gerar_sn_w = 'S') or (ie_gerar_sn_w = 'N' and (coalesce(c.ie_se_necessario, 'N') = 'N' or coalesce(b.ie_dose_especial,'N') = 'S')) or ((ie_gerar_lote_acm_sn_uti_w = 'S') and (obter_classif_setor(cd_setor_atendimento_w) = 4)))
	and	((ie_gera_lote_orig_w = 'N') or ((ie_origem_lote_p <> 'AIP') or (coalesce(b.ie_aprazado,'N') = 'S')))
	and	((ie_gera_lote_medic_pac_w = 'S') or ((ie_gera_lote_medic_pac_w = 'N') and (coalesce(ie_medicacao_paciente,'N') = 'N')))
	and	((ie_gerar_lote_area_w = 'S') or (coalesce(b.nr_seq_area_prep::text, '') = ''))
	and	((ie_origem_lote_p <> 'AIS') or ((ie_origem_lote_p = 'AIS') and exists (	SELECT	1
												from	prescr_mat_hor d
												where	d.nr_prescricao   = c.nr_prescricao						
												and	d.nr_seq_material = c.nr_seq_kit
												and	d.ie_agrupador = 4)))
	and	Obter_se_horario_liberado(b.dt_lib_horario, b.dt_horario) = 'S'
	--and	((nvl(ie_termolabil_w,'N') = 'N') or ((nvl(ie_termolabil_w,'N') = 'S') and (nvl(x.ie_termolabil,'N') = 'N')))
	and	((coalesce(x.ie_termolabil,'N') = 'N') or (coalesce(nr_seq_regra_termo_w,0) = 0))
	and	((coalesce(ie_itens_associados_termo_w,'N') = 'N') or
		((ie_itens_associados_termo_w = 'S') and not exists (	select	1
									from	prescr_material d
									where	d.nr_prescricao = c.nr_prescricao
									and	d.nr_sequencia = b.nr_seq_superior
									and exists (select 1 from material z where z.cd_material = d.cd_material and z.ie_termolabil = 'S'))))
	and	((coalesce(b.ie_agrupador,0) <> 8) or (coalesce(nr_seq_regra_ne_w,0) = 0))
	and	((coalesce(ie_itens_associados_ne_w,'N') = 'N') or
		((ie_itens_associados_ne_w = 'S') and not exists (	select	1
									from	prescr_material d
									where	d.nr_prescricao = c.nr_prescricao
									and	d.nr_sequencia = b.nr_seq_superior
									and	d.ie_agrupador = 8)))
	and	((coalesce(ie_alto_risco_w,'N') = 'N') or ((coalesce(ie_alto_risco_w,'N') = 'S') and (obter_se_material_risco(cd_setor_atendimento_w,b.cd_material) = 'N')))
	and	((coalesce(c.nr_seq_recomendacao,0) = 0) or (coalesce(nr_seq_regra_recomend_w,0) = 0))
	and	((coalesce(ie_itens_assoc_recomend_w,'N') = 'N') or
		((ie_itens_assoc_recomend_w = 'S') and not exists (	select	1
									from	prescr_recomendacao d
									where	d.nr_prescricao = c.nr_prescricao
									and	d.nr_sequencia = c.nr_seq_recomendacao)))
	and	((obter_se_medic_controlado(b.cd_material) = 'N') or (coalesce(nr_seq_regra_controlado_w,0) = 0))
	and	((coalesce(ie_itens_assoc_controlado_w,'N') = 'N') or
		((ie_itens_assoc_controlado_w = 'S') and not exists (	select	1
									from	prescr_material d
									where	d.nr_prescricao = c.nr_prescricao
									and	d.nr_sequencia = b.nr_seq_superior
									and exists (select 1 from medic_controlado z where z.cd_material = d.cd_material and z.ie_situacao = 'A' and coalesce(z.cd_estabelecimento, cd_estabelecimento_w) = cd_estabelecimento_w))))
	order by  dt_horario, 
		cd_local,
		 nr_seq_classif;

-- Busca os  materiais principais, vinculados a procedimentos.
C15 CURSOR FOR
	SELECT  b.cd_material,
		b.nr_sequencia,
		c.nr_sequencia,
		b.cd_unidade_medida,
		b.qt_dispensar,
		b.qt_dispensar_hor,
		coalesce(b.nr_seq_turno,-1),
		b.dt_horario,
		to_char(b.dt_horario,'hh24:mi'),
		coalesce(a.cd_estabelecimento,1),
		b.ie_urgente,
		b.nr_seq_classif,
		coalesce(b.cd_local_estoque,coalesce(c.cd_local_estoque,a.cd_local_estoque)) cd_local,
		nr_sequencia_proc,
		coalesce(b.nr_regra_local_disp,c.nr_seq_regra_local)
	from	material x,
		prescr_mat_hor b,
		prescr_material c,
		prescr_medica   a
	where	a.nr_prescricao = b.nr_prescricao
	and	x.cd_material	= c.cd_material
	and	a.nr_prescricao	= c.nr_prescricao
	and	c.nr_sequencia	= b.nr_seq_material
	and	a.nr_prescricao = nr_prescricao_p
	and	Obter_se_setor_lote(cd_setor_atendimento_w) = 'S'
	and	((coalesce(nr_sequencia_p, 0) = 0) or (c.nr_sequencia = nr_sequencia_p))
	and	((coalesce(nr_seq_horario_p, 0) = 0) or (b.nr_sequencia = nr_seq_horario_p))
	and	((coalesce(ie_so_aprazado_p, 'N') = 'N') or (coalesce(ie_so_aprazado_p, 'N') = ie_aprazado))
	and	coalesce(b.ie_situacao,'A') <> 'I'
	and	coalesce(c.ie_suspenso,'N') <> 'S'
	and	coalesce(x.ie_gerar_lote,'S') = 'S'
	and	coalesce(a.dt_suspensao::text, '') = ''
	and	coalesce(b.dt_suspensao::text, '') = ''
	and	coalesce(c.nr_sequencia_solucao::text, '') = ''
	and	(nr_sequencia_proc IS NOT NULL AND nr_sequencia_proc::text <> '')
	and	coalesce(c.cd_motivo_baixa,0) = 0
	and	coalesce(c.dt_baixa::text, '') = ''
	and	((ie_gerar_lote_null_w = 'S') or (c.ds_horarios IS NOT NULL AND c.ds_horarios::text <> '') or (ie_origem_lote_p = 'AIP'))
	and	((VarNaoGerarSoPrimeiraEtapa_w = 'N') or (coalesce(b.nr_etapa_sol,1) = 1)  or (ie_origem_lote_p = 'GASR'))
	and	(b.nr_seq_turno IS NOT NULL AND b.nr_seq_turno::text <> '')
	and	coalesce(b.ie_gerar_lote,'S') = 'S'
	and	coalesce(c.ie_gerar_lote,'S') = 'S'
	and	coalesce(b.qt_dispensar_hor,0) > 0
	and	coalesce(b.nr_seq_lote::text, '') = ''
	and	((coalesce(c.ie_agrupador,0) = 5) or (coalesce(ie_itens_proced_sep_w,'N') = 'S'))
	and	((ie_gerar_acm_w = 'S') or (ie_gerar_acm_w = 'N' and (coalesce(c.ie_acm, 'N') = 'N' or coalesce(b.ie_dose_especial,'N') = 'S')) or ((ie_gerar_lote_acm_sn_uti_w = 'S') and (obter_classif_setor(cd_setor_atendimento_w) = 4)))
	and	((ie_gerar_sn_w = 'S') or (ie_gerar_sn_w = 'N' and (coalesce(c.ie_se_necessario, 'N') = 'N' or coalesce(b.ie_dose_especial,'N') = 'S')) or ((ie_gerar_lote_acm_sn_uti_w = 'S') and (obter_classif_setor(cd_setor_atendimento_w) = 4)))
	and	((ie_gera_lote_orig_w = 'N') or ((ie_origem_lote_p <> 'AIP') or (coalesce(b.ie_aprazado,'N') = 'S')))
	and	((ie_gera_lote_medic_pac_w = 'S') or ((ie_gera_lote_medic_pac_w = 'N') and (coalesce(ie_medicacao_paciente,'N') = 'N')))
	and	((ie_gerar_lote_area_w = 'S') or (coalesce(b.nr_seq_area_prep::text, '') = ''))
	and	((ie_origem_lote_p <> 'AIS') or ((ie_origem_lote_p = 'AIS') and exists (	SELECT	1
												from	prescr_mat_hor d
												where	d.nr_prescricao   = c.nr_prescricao						
												and	d.nr_seq_material = c.nr_seq_kit
												and	d.ie_agrupador = 4)))
	and	Obter_se_horario_liberado(b.dt_lib_horario, b.dt_horario) = 'S'
	--and	((nvl(ie_termolabil_w,'N') = 'N') or ((nvl(ie_termolabil_w,'N') = 'S') and (nvl(x.ie_termolabil,'N') = 'N')))
	and	((coalesce(x.ie_termolabil,'N') = 'N') or (coalesce(nr_seq_regra_termo_w,0) = 0))
	and	((coalesce(ie_itens_associados_termo_w,'N') = 'N') or
		((ie_itens_associados_termo_w = 'S') and not exists (	select	1
									from	prescr_material d
									where	d.nr_prescricao = c.nr_prescricao
									and	d.nr_sequencia = b.nr_seq_superior
									and exists (select 1 from material z where z.cd_material = d.cd_material and z.ie_termolabil = 'S'))))
	and	((coalesce(b.ie_agrupador,0) <> 8) or (coalesce(nr_seq_regra_ne_w,0) = 0))
	and	((coalesce(ie_itens_associados_ne_w,'N') = 'N') or
		((ie_itens_associados_ne_w = 'S') and not exists (	select	1
									from	prescr_material d
									where	d.nr_prescricao = c.nr_prescricao
									and	d.nr_sequencia = b.nr_seq_superior
									and	d.ie_agrupador = 8)))
	and	((coalesce(ie_alto_risco_w,'N') = 'N') or ((coalesce(ie_alto_risco_w,'N') = 'S') and (obter_se_material_risco(cd_setor_atendimento_w,b.cd_material) = 'N')))
	and 	((coalesce(ie_gera_lote_separado_w,'N') = 'N') or ((coalesce(ie_gera_lote_separado_w,'N') = 'S') and (coalesce(x.ie_gera_lote_separado,'N') = 'N')))
	and	((coalesce(c.nr_seq_recomendacao,0) = 0) or (coalesce(nr_seq_regra_recomend_w,0) = 0))
	and	((coalesce(ie_itens_assoc_recomend_w,'N') = 'N') or
		((ie_itens_assoc_recomend_w = 'S') and not exists (	select	1
									from	prescr_recomendacao d
									where	d.nr_prescricao = c.nr_prescricao
									and	d.nr_sequencia = c.nr_seq_recomendacao)))
	and	((obter_se_medic_controlado(b.cd_material) = 'N') or (coalesce(nr_seq_regra_controlado_w,0) = 0))
	and	((coalesce(ie_itens_assoc_controlado_w,'N') = 'N') or
		((ie_itens_assoc_controlado_w = 'S') and not exists (	select	1
									from	prescr_material d
									where	d.nr_prescricao = c.nr_prescricao
									and	d.nr_sequencia = b.nr_seq_superior
									and exists (select 1 from medic_controlado z where z.cd_material = d.cd_material and z.ie_situacao = 'A' and coalesce(z.cd_estabelecimento, cd_estabelecimento_w) = cd_estabelecimento_w))))
	order by dt_horario,
		 cd_local,
		 nr_seq_classif,
		 nr_sequencia_proc;
		
-- Busca os materiais associados (cursor 15)
c16 CURSOR FOR
	SELECT  b.cd_material,
		b.nr_sequencia,
		b.cd_unidade_medida,
		b.qt_dispensar,
		b.qt_dispensar_hor,
		coalesce(b.nr_seq_turno,-1),
		b.dt_horario,
		to_char(b.dt_horario,'hh24:mi'),
		coalesce(a.cd_estabelecimento,1),
		b.ie_urgente,
		b.nr_seq_classif,
		coalesce(b.cd_local_estoque,coalesce(c.cd_local_estoque,a.cd_local_estoque)) cd_local,
		coalesce(b.nr_regra_local_disp,c.nr_seq_regra_local)
	from	material x,
		prescr_mat_hor  b,
		prescr_material c,
		prescr_medica   a
	where	a.nr_prescricao = b.nr_prescricao
	and	a.nr_prescricao	= c.nr_prescricao
	and	c.nr_sequencia	= b.nr_seq_material
	and	a.nr_prescricao = nr_prescricao_p
	and	x.cd_material	= c.cd_material
	and	coalesce(x.ie_gerar_lote,'S') = 'S'
	and	coalesce(nr_seq_prescr_mat_w, 0) > 0
	and	coalesce(b.nr_seq_lote::text, '') = ''
	and	Obter_se_setor_lote(cd_setor_atendimento_w) = 'S'
	and	coalesce(c.nr_sequencia_solucao::text, '') = ''
 	and	b.nr_seq_superior = nr_seq_prescr_mat_w
	and	coalesce(c.nr_seq_kit,0) <> nr_seq_prescr_mat_w
	and	c.cd_motivo_baixa = 0
	and	Obter_se_horario_liberado(b.dt_lib_horario, b.dt_horario) = 'S'
	and	((ie_gerar_lote_null_w = 'S') or (c.ds_horarios IS NOT NULL AND c.ds_horarios::text <> '') or (ie_origem_lote_p = 'AIP'))
	and	((VarNaoGerarSoPrimeiraEtapa_w = 'N') or (coalesce(b.nr_etapa_sol,1) = 1)  or (ie_origem_lote_p = 'GASR'))
	--and	nvl(b.ie_horario_especial, 'N') = 'N'
	and	coalesce(b.ie_gerar_lote,'S') = 'S'
	and	coalesce(c.ie_gerar_lote,'S') = 'S'
	and	coalesce(b.qt_dispensar_hor,0) > 0
	and	coalesce(c.dt_baixa::text, '') = ''
	and	(b.nr_seq_turno IS NOT NULL AND b.nr_seq_turno::text <> '')
	and	b.nr_seq_turno = nr_seq_turno_w
	and	((ie_gerar_acm_w = 'S') or (ie_gerar_acm_w = 'N' and (coalesce(c.ie_acm, 'N') = 'N' or coalesce(b.ie_dose_especial,'N') = 'S')) or ((ie_gerar_lote_acm_sn_uti_w = 'S') and (obter_classif_setor(cd_setor_atendimento_w) = 4)))
	and	((ie_gerar_sn_w = 'S') or (ie_gerar_sn_w = 'N' and (coalesce(c.ie_se_necessario, 'N') = 'N' or coalesce(b.ie_dose_especial,'N') = 'S')) or ((ie_gerar_lote_acm_sn_uti_w = 'S') and (obter_classif_setor(cd_setor_atendimento_w) = 4)))
	and	((ie_origem_lote_p <> 'AIS') or	(ie_origem_lote_p = 'AIS' AND b.ie_aprazado = 'S'))
	and	((ie_gera_lote_orig_w = 'N') or ((ie_origem_lote_p <> 'AIP') or (coalesce(b.ie_aprazado,'N') = 'S')))
	and	((ie_gera_lote_medic_pac_w = 'S') or ((ie_gera_lote_medic_pac_w = 'N') and (coalesce(ie_medicacao_paciente,'N') = 'N')))
	and	((ie_gerar_lote_area_w = 'S') or (coalesce(b.nr_seq_area_prep::text, '') = ''))
	--and	((nvl(ie_termolabil_w,'N') = 'N') or ((nvl(ie_termolabil_w,'N') = 'S') and (nvl(x.ie_termolabil,'N') = 'N')))
	and	((coalesce(x.ie_termolabil,'N') = 'N') or (coalesce(nr_seq_regra_termo_w,0) = 0))
	and	((coalesce(ie_itens_associados_termo_w,'N') = 'N') or
		((ie_itens_associados_termo_w = 'S') and not exists (	SELECT	1
									from	prescr_material d
									where	d.nr_prescricao = c.nr_prescricao
									and	d.nr_sequencia = b.nr_seq_superior
									and exists (select 1 from material z where z.cd_material = d.cd_material and z.ie_termolabil = 'S'))))
	and	((coalesce(b.ie_agrupador,0) <> 8) or (coalesce(nr_seq_regra_ne_w,0) = 0))
	and	((coalesce(ie_itens_associados_ne_w,'N') = 'N') or
		((ie_itens_associados_ne_w = 'S') and not exists (	select	1
									from	prescr_material d
									where	d.nr_prescricao = c.nr_prescricao
									and	d.nr_sequencia = b.nr_seq_superior
									and	d.ie_agrupador = 8)))
	and	((coalesce(ie_alto_risco_w,'N') = 'N') or ((coalesce(ie_alto_risco_w,'N') = 'S') and (obter_se_material_risco(cd_setor_atendimento_w,b.cd_material) = 'N')))
	and	((coalesce(c.nr_seq_recomendacao,0) = 0) or (coalesce(nr_seq_regra_recomend_w,0) = 0))
	and	((coalesce(ie_itens_assoc_recomend_w,'N') = 'N') or
		((ie_itens_assoc_recomend_w = 'S') and not exists (	select	1
									from	prescr_recomendacao d
									where	d.nr_prescricao = c.nr_prescricao
									and	d.nr_sequencia = c.nr_seq_recomendacao)))
	and	((obter_se_medic_controlado(b.cd_material) = 'N') or (coalesce(nr_seq_regra_controlado_w,0) = 0))
	and	((coalesce(ie_itens_assoc_controlado_w,'N') = 'N') or
		((ie_itens_assoc_controlado_w = 'S') and not exists (	select	1
									from	prescr_material d
									where	d.nr_prescricao = c.nr_prescricao
									and	d.nr_sequencia = b.nr_seq_superior
									and exists (select 1 from medic_controlado z where z.cd_material = d.cd_material and z.ie_situacao = 'A' and coalesce(z.cd_estabelecimento, cd_estabelecimento_w) = cd_estabelecimento_w))))
	
union all

	select  b.cd_material,
		b.nr_sequencia,
		b.cd_unidade_medida,
		b.qt_dispensar,
		b.qt_dispensar_hor,
		coalesce(b.nr_seq_turno,-1),
		b.dt_horario,
		to_char(b.dt_horario,'hh24:mi'),
		coalesce(a.cd_estabelecimento,1),
		b.ie_urgente,
		b.nr_seq_classif,
		coalesce(b.cd_local_estoque,coalesce(c.cd_local_estoque,a.cd_local_estoque)) cd_local,
		coalesce(b.nr_regra_local_disp,c.nr_seq_regra_local)
	from	material x,
		prescr_mat_hor  b,
		prescr_material c,
		prescr_medica   a
	where	a.nr_prescricao = b.nr_prescricao
	and	a.nr_prescricao	= c.nr_prescricao
	and	c.nr_sequencia	= b.nr_seq_material
	and	x.cd_material	= c.cd_material
	and	coalesce(x.ie_gerar_lote,'S') = 'S'
	and	a.nr_prescricao = nr_prescricao_p
	and	coalesce(nr_seq_prescr_mat_w, 0) > 0
	and	coalesce(b.nr_seq_lote::text, '') = ''
	and	coalesce(c.nr_sequencia_solucao::text, '') = ''
	and	coalesce(c.nr_seq_kit,0)	= nr_seq_prescr_mat_w
	and	c.cd_motivo_baixa = 0
	and	Obter_se_horario_liberado(b.dt_lib_horario, b.dt_horario) = 'S'
	and	coalesce(b.ie_gerar_lote,'S') = 'S'
	and	coalesce(c.ie_gerar_lote,'S') = 'S'
	and	Obter_se_setor_lote(cd_setor_atendimento_w) = 'S'
	--and	nvl(b.ie_horario_especial, 'N') = 'N'
	and	coalesce(c.dt_baixa::text, '') = ''
	and	coalesce(b.qt_dispensar_hor,0) > 0
	and	(b.nr_seq_turno IS NOT NULL AND b.nr_seq_turno::text <> '')
	and	((ie_gerar_lote_null_w = 'S') or (c.ds_horarios IS NOT NULL AND c.ds_horarios::text <> '') or (ie_origem_lote_p = 'AIP'))
	and	((VarNaoGerarSoPrimeiraEtapa_w = 'N') or (coalesce(b.nr_etapa_sol,1) = 1)  or (ie_origem_lote_p = 'GASR'))
	and	b.nr_seq_turno = nr_seq_turno_w
	and	((ie_gerar_acm_w = 'S') or (ie_gerar_acm_w = 'N' and (coalesce(c.ie_acm, 'N') = 'N' or coalesce(b.ie_dose_especial,'N') = 'S')) or ((ie_gerar_lote_acm_sn_uti_w = 'S') and (obter_classif_setor(cd_setor_atendimento_w) = 4)))
	and	((ie_gerar_sn_w = 'S') or (ie_gerar_sn_w = 'N' and (coalesce(c.ie_se_necessario, 'N') = 'N' or coalesce(b.ie_dose_especial,'N') = 'S')) or ((ie_gerar_lote_acm_sn_uti_w = 'S') and (obter_classif_setor(cd_setor_atendimento_w) = 4)))
	and	((ie_origem_lote_p <> 'AIS') or	(ie_origem_lote_p = 'AIS' AND b.ie_aprazado = 'S'))
	and	((ie_gera_lote_orig_w = 'N') or ((ie_origem_lote_p <> 'AIP') or (coalesce(b.ie_aprazado,'N') = 'S')))
	and	((ie_gera_lote_medic_pac_w = 'S') or ((ie_gera_lote_medic_pac_w = 'N') and (coalesce(ie_medicacao_paciente,'N') = 'N')))
	and	((ie_gerar_lote_area_w = 'S') or (coalesce(b.nr_seq_area_prep::text, '') = ''))
	--and	((nvl(ie_termolabil_w,'N') = 'N') or ((nvl(ie_termolabil_w,'N') = 'S') and (nvl(x.ie_termolabil,'N') = 'N')))
	and	((coalesce(x.ie_termolabil,'N') = 'N') or (coalesce(nr_seq_regra_termo_w,0) = 0))
	and	((coalesce(ie_itens_associados_termo_w,'N') = 'N') or
		((ie_itens_associados_termo_w = 'S') and not exists (	select	1
									from	prescr_material d
									where	d.nr_prescricao = c.nr_prescricao
									and	d.nr_sequencia = b.nr_seq_superior
									and exists (select 1 from material z where z.cd_material = d.cd_material and z.ie_termolabil = 'S'))))
	and	((coalesce(b.ie_agrupador,0) <> 8) or (coalesce(nr_seq_regra_ne_w,0) = 0))
	and	((coalesce(ie_itens_associados_ne_w,'N') = 'N') or
		((ie_itens_associados_ne_w = 'S') and not exists (	select	1
									from	prescr_material d
									where	d.nr_prescricao = c.nr_prescricao
									and	d.nr_sequencia = b.nr_seq_superior
									and	d.ie_agrupador = 8)))
	and	((coalesce(ie_alto_risco_w,'N') = 'N') or ((coalesce(ie_alto_risco_w,'N') = 'S') and (obter_se_material_risco(cd_setor_atendimento_w,b.cd_material) = 'N')))
	and	((coalesce(c.nr_seq_recomendacao,0) = 0) or (coalesce(nr_seq_regra_recomend_w,0) = 0))
	and	((coalesce(ie_itens_assoc_recomend_w,'N') = 'N') or
		((ie_itens_assoc_recomend_w = 'S') and not exists (	select	1
									from	prescr_recomendacao d
									where	d.nr_prescricao = c.nr_prescricao
									and	d.nr_sequencia = c.nr_seq_recomendacao)))
	and	((obter_se_medic_controlado(b.cd_material) = 'N') or (coalesce(nr_seq_regra_controlado_w,0) = 0))
	and	((coalesce(ie_itens_assoc_controlado_w,'N') = 'N') or
		((ie_itens_assoc_controlado_w = 'S') and not exists (	select	1
									from	prescr_material d
									where	d.nr_prescricao = c.nr_prescricao
									and	d.nr_sequencia = b.nr_seq_superior
									and exists (select 1 from medic_controlado z where z.cd_material = d.cd_material and z.ie_situacao = 'A' and coalesce(z.cd_estabelecimento, cd_estabelecimento_w) = cd_estabelecimento_w))))
	order by cd_local,
		 nr_seq_classif,
		 dt_horario;
		
C02 CURSOR FOR
	SELECT	to_char(b.hr_inicial,'hh24:mi')
	from	regra_turno_disp_param b,
		regra_turno_disp a
	where	a.nr_sequencia		= b.nr_seq_turno
	and	a.cd_estabelecimento	= cd_estabelecimento_w
	and	a.nr_sequencia		= nr_seq_turno_w
	and (coalesce(b.cd_setor_atendimento,cd_setor_atendimento_w)	= cd_setor_atendimento_w)
	order by coalesce(b.cd_setor_atendimento,0),
		to_char(b.hr_inicial,'hh24:mi');
	
C03 CURSOR FOR
	SELECT	cd_setor_atendimento,
		nr_seq_turno,
		nr_seq_classif,
		qt_min_antes_atend,
		qt_min_receb_setor,
		qt_min_entr_setor,
		qt_min_disp_farm,
		qt_min_atend_farm,
		qt_min_inicio_atend,
		coalesce(ie_hora_antes,'H')
	from	regra_tempo_disp
	where	cd_estabelecimento	= cd_estabelecimento_w
	and	coalesce(ie_situacao, 'A')	= 'A'
	order by coalesce(nr_seq_classif,0), 
		coalesce(nr_seq_turno,0),
		coalesce(cd_setor_atendimento,0);

C20 CURSOR FOR
	SELECT	cd_tipo_baixa
	from	regra_disp_lote_farm
	where	((ie_motivo_prescricao = ie_motivo_prescricao_w) or (coalesce(ie_motivo_prescricao::text, '') = ''))
	and		clock_timestamp() between pkg_date_utils.get_time(clock_timestamp(),TO_CHAR(coalesce(dt_hora_inicio,clock_timestamp()),'hh24:mi:ss')) and
							pkg_date_utils.get_time(clock_timestamp(),TO_CHAR(coalesce(dt_hora_fim,clock_timestamp()),'hh24:mi:ss'))
	and		pkg_date_utils.start_of(clock_timestamp(), 'dd',0) between pkg_date_utils.start_of(dt_inicio_vigencia, 'dd',0) and pkg_date_utils.start_of(coalesce(dt_fim_vigencia,clock_timestamp()), 'dd',0)
	and		coalesce(cd_setor_atendimento,cd_setor_atendimento_w)	= cd_setor_atendimento_w
	and		coalesce(cd_estabelecimento,cd_estabelecimento_w)	= cd_estabelecimento_w
	and		coalesce(ie_situacao,'A') = 'A'
	and 	((ie_quimio_w <> 'S' and coalesce(ie_quimioterapicas,'N') <> 'S') or (ie_quimio_w = 'S'))
	order by CASE WHEN ie_quimioterapicas='S' THEN 'Z'  ELSE CASE WHEN ie_quimioterapicas='N' THEN 'C'  ELSE 'B' END  END ,
		coalesce(cd_setor_atendimento,0), coalesce(ie_motivo_prescricao,0);

C04 CURSOR FOR
	SELECT	nr_sequencia
	from	ap_lote
	where	nr_prescricao = nr_prescricao_p
	order by nr_sequencia;
	
c05 CURSOR FOR
	SELECT	nr_sequencia
	from	regra_geracao_lote_sep
	where (coalesce(cd_estabelecimento::text, '') = '' or cd_estabelecimento = cd_estabelecimento_w)
	order by coalesce(nr_prioridade,999);
	
C07 CURSOR FOR
	SELECT	nr_sequencia
	from	ap_lote
	where	nr_prescricao = nr_prescricao_p
	and		coalesce(ie_integracao::text, '') = '';


BEGIN


select 	coalesce(max('S'),'N')
into STRICT	ie_quimio_w
from	paciente_atendimento
where	nr_prescricao = nr_prescricao_p;

begin

select	substr(obter_inf_sessao(0) ||' - ' || obter_inf_sessao(1),1,80)
into STRICT	ds_maq_user_w	
;

cd_perfil_ativo_w	:= obter_perfil_ativo;

if (coalesce(cd_perfil_ativo_w,0) = 0) then
    cd_perfil_ativo_w    := Obter_dados_usuario_opcao(nm_usuario_p, 'CPI');
end if;

select	max(cd_setor_atendimento),
		max(cd_estabelecimento),
		max(nr_atendimento),
		max(ie_motivo_prescricao),
		max(cd_pessoa_fisica)
into STRICT	cd_setor_atendimento_w,
		cd_estabelecimento_w,
		nr_atendimento_w,
		ie_motivo_prescricao_w,
		cd_pessoa_fisica_w
from	prescr_medica
where	nr_prescricao	= nr_prescricao_p;

CALL define_local_disp_prescr(nr_prescricao_p, nr_sequencia_p, cd_perfil_ativo_w, nm_usuario_p);

ie_setor_atual_w := obter_param_usuario(1113, 378, cd_perfil_ativo_w, nm_usuario_p, cd_estabelecimento_w, ie_setor_atual_w);

if (ie_setor_atual_w = 'S') and (ie_origem_lote_p = 'AIP') then
	cd_setor_atendimento_w := coalesce(obter_setor_atendimento(nr_atendimento_w),cd_setor_atendimento_w);
end if;

select	max(ie_classif_urgencia),
	coalesce(max(ie_gerar_acm_lote), 'S'),
	coalesce(max(ie_gerar_sn_lote), 'S'),
	coalesce(max(ie_gerar_novo_lote_turno_dia),'S'),
	coalesce(max(ie_gerar_lote_area),'S'),
	coalesce(max(ie_gerar_solucao_separado),'S'),
	'N',
	'N',
	coalesce(max(ie_novo_lote_dia),'N'),
	coalesce(max(ie_gerar_lote_apos_horario),'S'),
	coalesce(max(ie_lote_desdobrado),'N'),
	coalesce(max(ie_desdobra_mesmo_turno),'N'),
	coalesce(max(ie_gerar_mat_proced_sep),'N'),
	coalesce(max(ie_gerar_lote_acm_sn_uti),'N'),
	max(nr_seq_regra_termo),
	max(nr_seq_regra_ne),
	coalesce(max(ie_gerar_mat_separado),'N'),
	coalesce(max(ie_gerar_lote_solucao),'S'),
	coalesce(max(ie_ajusta_local_item_sol),'N'),
	coalesce(max(ie_gera_integracao), 'S'),
	coalesce(max(ie_gerar_sol_separado),'N'),
	max(nr_seq_regra_recomend),
	max(nr_seq_regra_controlado),
	coalesce(max(ie_desdobra_solucao),'N')
into STRICT	ie_classif_nao_padrao_w,
	ie_gerar_acm_w,
	ie_gerar_sn_w,
	ie_gerar_novo_lote_turno_dia_w,
	ie_gerar_lote_area_w,
	ie_gerar_solucao_separado_w,
	ie_termolabil_w,
	ie_alto_risco_w,
	ie_novo_lote_dia_w,
	ie_gerar_lote_apos_horario_w,
	ie_gera_lote_desdobrado_w,
	ie_desdobra_mesmo_turno_w,
	ie_itens_proced_sep_w,
	ie_gerar_lote_acm_sn_uti_w,
	nr_seq_regra_termo_w,
	nr_seq_regra_ne_w,
	ie_gera_lote_separado_w,
	ie_gerar_lote_solucao_w,
	ie_ajusta_local_item_sol_w,
	ie_gera_integracao_w,
	ie_gerar_sol_separado_w,
	nr_seq_regra_recomend_w,
	nr_seq_regra_controlado_w,
	ie_desdobrar_solucao_w
from	parametros_farmacia
where	cd_estabelecimento	= cd_estabelecimento_w;

if (coalesce(nr_seq_regra_termo_w,0) > 0) then
	select	ie_itens_associados
	into STRICT	ie_itens_associados_termo_w
	from 	regra_geracao_lote_sep
	where 	cd_estabelecimento = cd_estabelecimento_w
	and	nr_sequencia = nr_seq_regra_termo_w;
end if;	

if (coalesce(nr_seq_regra_ne_w,0) > 0) then
	select	ie_itens_associados
	into STRICT	ie_itens_associados_ne_w
	from 	regra_geracao_lote_sep
	where 	cd_estabelecimento = cd_estabelecimento_w
	and	nr_sequencia = nr_seq_regra_ne_w;
end if;	

if (coalesce(nr_seq_regra_recomend_w,0) > 0) then	
	select	max(ie_itens_associados)
	into STRICT	ie_itens_assoc_recomend_w
	from 	regra_geracao_lote_sep
	where 	cd_estabelecimento = cd_estabelecimento_w
	and	nr_sequencia = nr_seq_regra_recomend_w;
end if;

if (coalesce(nr_seq_regra_controlado_w,0) > 0) then	
	select	max(ie_itens_associados)
	into STRICT	ie_itens_assoc_controlado_w
	from 	regra_geracao_lote_sep
	where 	cd_estabelecimento = cd_estabelecimento_w
	and	nr_sequencia = nr_seq_regra_controlado_w;
end if;

ie_gera_lote_orig_w := coalesce(obter_valor_param_usuario(1113, 138, Obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w),'N'); /* Virgilio 26/05/2009*/
ie_gera_lote_orig_w := coalesce(obter_valor_param_usuario(1113, 138, Obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w),'N'); /* Virgilio 26/05/2009*/
ie_gera_lote_medic_pac_w := coalesce(obter_valor_param_usuario(924, 389, Obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w),'N'); /* Virgilio 06/08/2009*/
ie_gerar_lote_null_w	:= coalesce(obter_valor_param_usuario(924, 873, Obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w),'S');
VarNaoGerarSoPrimeiraEtapa_w	:= coalesce(obter_valor_param_usuario(924, 924, Obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w), 'N');

/*Fabio e Jonas - Para que busque a parametrizacao do ADEP e caso for D(Depende da regra) ai entao e verificado nos parametros da farmacia*/

if (ie_origem_lote_p in ('AIP','GAI', 'AIS')) then
	begin
	ie_lote_acm_sn_w	:= coalesce(obter_valor_param_usuario(1113, 107, Obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w),'S');	
	if (ie_lote_acm_sn_w = 'S') or (ie_lote_acm_sn_w = 'N') then
		ie_gerar_acm_w	:= ie_lote_acm_sn_w;
		ie_gerar_sn_w	:= ie_lote_acm_sn_w;
	end if;
	end;
end if;

insert into ap_lote_log(
	nr_sequencia,
	dt_atualizacao, 
	nm_usuario, 
	dt_atualizacao_nrec, 
	nm_usuario_nrec, 
	nr_prescricao, 
	nr_seq_mat_hor, 
	nr_seq_lote, 
	ds_tipo_item, 
	ds_conteudo, 
	ds_stack)
values (nextval('ap_lote_log_seq'),
	clock_timestamp(),
	nm_usuario_p,
	clock_timestamp(),
	nm_usuario_p,
	nr_prescricao_p,
	nr_seq_horario_p,
	null,
	'Gerar_Lote_Atend_Prescr_Desdob1',
	' nr_prescricao_p='                || nr_prescricao_p                || ' nr_sequencia_p='             || nr_sequencia_p             ||
	' nr_seq_horario_p='               || nr_seq_horario_p               || ' ie_so_aprazado_p='           || ie_so_aprazado_p           ||
	' nm_usuario_p='                   || nm_usuario_p                   || ' ie_origem_lote_p='           || ie_origem_lote_p           ||
	' cd_setor_atendimento_w='         || cd_setor_atendimento_w         || ' ie_itens_proced_sep_w='      || ie_itens_proced_sep_w      ||
	' ie_desdobra_mesmo_turno_w='      || ie_desdobra_mesmo_turno_w      || ' ie_gerar_lote_null_w='       || ie_gerar_lote_null_w       ||	
	' cd_estabelecimento_w='           || cd_estabelecimento_w           || ' nr_atendimento_w='           || nr_atendimento_w           ||
	' ie_setor_atual_w='               || ie_setor_atual_w               || ' ie_classif_nao_padrao_w='    || ie_classif_nao_padrao_w    ||
	' ie_gerar_acm_w='                 || ie_gerar_acm_w                 ||	' ie_gerar_sn_w='              || ie_gerar_sn_w              ||
	' ie_gerar_novo_lote_turno_dia_w=' || ie_gerar_novo_lote_turno_dia_w ||	' ie_gerar_lote_area_w='       || ie_gerar_lote_area_w       ||
	' ie_gerar_solucao_separado_w='    || ie_gerar_solucao_separado_w    || ' nr_seq_regra_termo_w='       || nr_seq_regra_termo_w       ||
	' ie_alto_risco_w='                || ie_alto_risco_w                || ' ie_novo_lote_dia_w='         || ie_novo_lote_dia_w         ||
	' ie_gera_lote_desdobrado_w='      || ie_gera_lote_desdobrado_w      || ' ie_gera_lote_orig_w='        || ie_gera_lote_orig_w        ||
	' ie_gerar_lote_apos_horario_w='   || ie_gerar_lote_apos_horario_w   || ' ie_lote_acm_sn_w='           || ie_lote_acm_sn_w           ||
	' ie_gerar_lote_acm_sn_uti_w='     || ie_gerar_lote_acm_sn_uti_w     || ' ie_gera_lote_medic_pac_w='   || ie_gera_lote_medic_pac_w   ||
	' ie_gera_lote_separado_w='        || ie_gera_lote_separado_w        || ' nr_seq_regra_ne_w='          || nr_seq_regra_ne_w,
	substr(dbms_utility.format_call_stack,1,2000));

if (ie_ajusta_local_item_sol_w = 'S') then
	CALL ajustar_local_item_sol(nr_prescricao_p,nm_usuario_p);
end if;

open C20;
loop
fetch C20 into	
	cd_tipo_baixa_w;
EXIT WHEN NOT FOUND; /* apply on C20 */
	begin
	cd_tipo_baixa_w	:= cd_tipo_baixa_w;
	end;
end loop;
close C20;

if (cd_tipo_baixa_w IS NOT NULL AND cd_tipo_baixa_w::text <> '') then
	select	max(ie_conta_paciente),
		max(ie_atualiza_estoque)
	into STRICT	ie_conta_paciente_w,
		ie_atualiza_estoque_w
	from	tipo_baixa_prescricao
	where	cd_tipo_baixa		= cd_tipo_baixa_w
	and	ie_prescricao_devolucao = 'P';
end if;

ie_gera_novo_lote_w := 'N';

open C01;
loop
fetch C01 into	
	cd_material_w,
	nr_seq_mat_hor_w,
	nr_seq_prescr_mat_w,
	cd_unidade_medida_w,
	qt_dispensar_w,
	qt_dispensar_hor_w,
	nr_seq_turno_w,
	dt_horario_w,
	hr_hora_w,
	cd_estabelecimento_w,
	ie_urgente_w,
	nr_seq_classif_w,
	cd_local_estoque_w,
	nr_sequencia_proc_ww,
	nr_regra_local_disp_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin

	select	coalesce(max(ie_gerar_ap_lote),'S') ,coalesce(max(ie_send_info_to_integration), 'N')
	into STRICT	ie_gerar_ap_lote_w, ie_send_integration_w
	from	regra_local_dispensacao
	where	nr_sequencia = nr_regra_local_disp_w;
	
	ie_gera_novo_lote_w := 'N';
	
	insert into ap_lote_log(
		nr_sequencia,
		dt_atualizacao, 
		nm_usuario, 
		dt_atualizacao_nrec, 
		nm_usuario_nrec, 
		nr_prescricao, 
		nr_seq_mat_hor, 
		nr_seq_lote, 
		ds_tipo_item, 
		ds_conteudo, 
		ds_stack)
	values (nextval('ap_lote_log_seq'),
		clock_timestamp(),
		nm_usuario_p,
		clock_timestamp(),
		nm_usuario_p,
		nr_prescricao_p,
		nr_seq_horario_p,
		null,
		'Gerar_Lote_Atend_Prescr_Desdob2',
		' nr_seq_turno_w = '		|| nr_seq_turno_w ||
		' nr_seq_turno_ant_w = '	|| nr_seq_turno_ant_w ||
		' nr_seq_classif_w = '		|| nr_seq_classif_w ||
		' nr_seq_classif_ant_w = '	|| nr_seq_classif_ant_w ||
		' dt_horario_w = '		|| PKG_DATE_FORMATERS_TZ.TO_VARCHAR(dt_horario_w, 'timestamp', ESTABLISHMENT_TIMEZONE_UTILS.getTimeZone)|| 
		' dt_horario_ant_w = '		|| PKG_DATE_FORMATERS_TZ.TO_VARCHAR(dt_horario_ant_w, 'timestamp', ESTABLISHMENT_TIMEZONE_UTILS.getTimeZone)|| 
		' hr_hora_w = '			|| PKG_DATE_FORMATERS_TZ.TO_VARCHAR(to_date(hr_hora_w, 'hh24:mi'), 'shortTime', ESTABLISHMENT_TIMEZONE_UTILS.getTimeZone)|| 
		' cd_local_estoque_w = '	|| cd_local_estoque_w || 
		' cd_local_estoque_ant_w = '|| cd_local_estoque_ant_w ||
		' nr_seq_mat_hor_w = '		|| nr_seq_mat_hor_w	|| 
		' nr_seq_mat_hor_ant_w = '	|| nr_seq_mat_hor_ant_w ||
		' nr_seq_prescr_mat_w = '	|| nr_seq_prescr_mat_w ||
		' ie_urgente_w = '			|| ie_urgente_w || 
		' ie_gera_novo_lote_w = '	|| ie_gera_novo_lote_w ||
		' nr_prescricao_p = '		|| nr_prescricao_p ||
		' nr_sequencia_p = '		|| nr_sequencia_p ||
		' ie_gerar_ap_lote_w='		|| ie_gerar_ap_lote_w ||
		' ie_origem_lote_p='		|| ie_origem_lote_p ||
		' nr_regra_local_disp_w='	|| nr_regra_local_disp_w,
		substr(dbms_utility.format_call_stack,1,2000));	
	
	if	((ie_gerar_ap_lote_w = 'S') or ((ie_origem_lote_p = 'AIP') or (ie_origem_lote_p = 'AIS'))) and
		((nr_seq_turno_w <> nr_seq_turno_ant_w) or (nr_seq_classif_w <> nr_seq_classif_ant_w) or
		((pkg_date_utils.start_of(dt_horario_w,'dd',0) <> pkg_date_utils.start_of(dt_horario_ant_w,'dd',0)) and (ie_gerar_novo_lote_turno_dia_w = 'S')) or
		(((dt_horario_w - dt_inicio_turno_w) > 1) and (ie_novo_lote_dia_w = 'S')) or (cd_local_estoque_w <> cd_local_estoque_ant_w) or
		((ie_desdobra_mesmo_turno_w in ('S', 'A')) and (nr_seq_mat_hor_w <> nr_seq_mat_hor_ant_w) and ((ie_gera_lote_desdobrado_w <> 'A') or (ie_urgente_w <> 'S'))) or
		((ie_desdobra_mesmo_turno_w = 'T') and (to_char(dt_horario_w,'hh24:mi') <> to_char(dt_horario_ant_w,'hh24:mi')) and ((ie_gera_lote_desdobrado_w <> 'A') or (ie_urgente_w <> 'S')))) and
		((ie_gerar_lote_apos_horario_w = 'S') or (dt_horario_w > clock_timestamp()) or (ie_origem_lote_p = 'AIP') or (ie_origem_lote_p = 'AIS')) then
		begin
		OPEN C02;
		LOOP
			FETCH C02 INTO
				hr_inicio_turno_w;
			EXIT WHEN NOT FOUND; /* apply on c02 */
			begin
			hr_inicio_turno_w	:= hr_inicio_turno_w;
			end;
		END LOOP;
		CLOSE C02;
		
		select	coalesce(max(qt_prioridade),999)
		into STRICT	qt_prioridade_w
		from	classif_lote_disp_far
		where	nr_sequencia	= nr_seq_classif_w;

		if (hr_hora_w < hr_inicio_turno_w) then
			dt_inicio_turno_w	:= pkg_date_utils.get_time(dt_horario_w - 1,hr_inicio_turno_w);
		else
			dt_inicio_turno_w	:= pkg_date_utils.get_time(dt_horario_w,hr_inicio_turno_w);
		end if;
		
		select	nextval('ap_lote_seq')
		into STRICT	nr_sequencia_w
		;
		
		insert into ap_lote(
			nr_sequencia,
			dt_inicio_turno,
			dt_prim_horario,
			dt_atualizacao,
			nm_usuario,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			dt_geracao_lote,
			nr_prescricao,
			nr_seq_turno,
			ie_status_lote,
			cd_setor_atendimento,
			nr_seq_classif,
			nm_usuario_geracao,
			ds_maquina_geracao,
			cd_perfil_geracao,
			qt_min_atraso_inicio_atend,
			qt_min_atraso_atend,
			qt_min_atraso_disp,
			qt_min_atraso_entrega,
			qt_min_atraso_receb,
			cd_tipo_baixa,
			ie_conta_paciente,
			ie_atualiza_estoque,
			cd_local_estoque,
			qt_prioridade,
			ie_origem_lote,
			nr_seq_local_geracao,
			nr_atendimento)
		values ( nr_sequencia_w,
			dt_inicio_turno_w,
			dt_horario_w,
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			nr_prescricao_p,
			nr_seq_turno_w,
			'G',
			cd_setor_atendimento_w,
			nr_seq_classif_w,
			nm_usuario_p,
			ds_maq_user_w,
			cd_perfil_ativo_w,
			0,
			0,
			0,
			0,
			0,
			cd_tipo_baixa_w,
			ie_conta_paciente_w,
			ie_atualiza_estoque_w,
			cd_local_estoque_w,
			qt_prioridade_w,
			ie_origem_lote_p,
			'DB',
			nr_atendimento_w);
    if (ie_send_integration_w ='S' )then
            CALL acceptance_submission_cancel(nr_sequencia_w,clock_timestamp(),null,'A',nr_prescricao_p,nm_usuario_p);
    end if;
		ie_gera_novo_lote_w := 'N';
		end;
	end if;
		
	if	((ie_gerar_ap_lote_w = 'S') or ((ie_origem_lote_p = 'AIP') or (ie_origem_lote_p = 'AIS'))) and
		((ie_gerar_lote_apos_horario_w = 'S') or (dt_horario_w > clock_timestamp()) or (ie_origem_lote_p = 'AIP') or (ie_origem_lote_p = 'AIS')) and (nr_sequencia_w > 0) then
	
		nr_seq_turno_ant_w		:= nr_seq_turno_w;
		nr_seq_classif_ant_w	:= nr_seq_classif_w;
		cd_local_estoque_ant_w	:= cd_local_estoque_w;
		dt_horario_ant_w		:= dt_horario_w;
		nr_seq_mat_hor_ant_w	:= nr_seq_mat_hor_w;
	
		insert into ap_lote_item(
			nr_sequencia,
			dt_atualizacao,
			nm_usuario,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			nr_seq_lote,
			nr_seq_mat_hor,
			ie_prescrito,
			qt_dispensar,
			qt_total_dispensar,
			cd_material,
			cd_unidade_medida,
			ie_urgente)
		values (nextval('ap_lote_item_seq'),
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			nr_sequencia_w,
			nr_seq_mat_hor_w,
			'S',
			coalesce(qt_dispensar_hor_w,0),
			qt_dispensar_w,
			cd_material_w,
			cd_unidade_medida_w,
			ie_urgente_w);
		
		if	((ie_gerar_lote_apos_horario_w = 'S') or (dt_horario_w > clock_timestamp()) or (ie_origem_lote_p = 'AIP') or (ie_origem_lote_p = 'AIS')) then

			update	prescr_mat_hor
			set	nr_seq_lote	= nr_sequencia_w
			where	nr_sequencia	= nr_seq_mat_hor_w;	

			/*if	((ie_origem_lote_p = 'AIP') or (ie_origem_lote_p = 'AIS')) and	
				(ie_gera_integracao_w = 'S') then
				disp_prescr_mat_hor(nr_prescricao_p, nr_seq_mat_hor_w, nm_usuario_p);
			end if;*/
		end if;
		
		select	coalesce(max(qt_prioridade),999)
		into STRICT	qt_prioridade_hor_w
		from	classif_lote_disp_far
		where	nr_sequencia	= nr_seq_classif_w;
		
		if (qt_prioridade_hor_w <> qt_prioridade_w) and (qt_prioridade_hor_w < qt_prioridade_w) then
			update	ap_lote
			set	nr_seq_classif = nr_seq_classif_w
			where	nr_sequencia = nr_sequencia_w;
		end if;
		
		if	((ie_origem_lote_p = 'AIP') or (ie_origem_lote_p = 'AIS') or (ie_origem_lote_p = 'AGND')) then
			nr_seq_mat_hor_aip_ais_w := nr_seq_mat_hor_w;
		end if;
		
		open C10;
		loop
		fetch C10 into	
			cd_material_ww,
			nr_seq_mat_hor_w,
			cd_unidade_medida_w,
			qt_dispensar_w,
			qt_dispensar_hor_w,
			nr_seq_turno_w,
			dt_horario_w,
			hr_hora_w,
			cd_estabelecimento_w,
			ie_urgente_w,
			nr_seq_classif_w,
			cd_local_estoque_w,
			ie_agrupador_w,
			nr_seq_regra_local_w;
		EXIT WHEN NOT FOUND; /* apply on C10 */
			begin

			select	coalesce(max(ie_gerar_ap_lote),'S'),coalesce(max(ie_send_info_to_integration), 'N')
			into STRICT	ie_gerar_ap_lote_w,ie_send_integration_w
			from	regra_local_dispensacao
			where	nr_sequencia = nr_seq_regra_local_w;		
			insert into ap_lote_log(
				nr_sequencia,
				dt_atualizacao, 
				nm_usuario, 
				dt_atualizacao_nrec, 
				nm_usuario_nrec, 
				nr_prescricao, 
				nr_seq_mat_hor, 
				nr_seq_lote, 
				ds_tipo_item, 
				ds_conteudo, 
				ds_stack)
			values (nextval('ap_lote_log_seq'),
				clock_timestamp(),
				nm_usuario_p,
				clock_timestamp(),
				nm_usuario_p,
				nr_prescricao_p,
				nr_seq_horario_p,
				null,
				'Gerar_Lote_Atend_Prescr_Desdob6',
				' cd_material_ww = '				|| cd_material_ww || 
				' nr_seq_turno_w = '				|| nr_seq_turno_w ||
				' nr_seq_classif_w = '				|| nr_seq_classif_w ||
				' nr_seq_classif_ant_w = '			|| nr_seq_classif_ant_w || 
				' dt_horario_w = '					|| PKG_DATE_FORMATERS_TZ.TO_VARCHAR(dt_horario_w, 'timestamp', ESTABLISHMENT_TIMEZONE_UTILS.getTimeZone)|| 
				' dt_horario_ant_w = '				|| PKG_DATE_FORMATERS_TZ.TO_VARCHAR(dt_horario_ant_w, 'timestamp', ESTABLISHMENT_TIMEZONE_UTILS.getTimeZone)|| 
				' hr_hora_w = '						|| PKG_DATE_FORMATERS_TZ.TO_VARCHAR(to_date(hr_hora_w,'hh24:mi'), 'shortTime', ESTABLISHMENT_TIMEZONE_UTILS.getTimeZone)|| 
				' cd_local_estoque_w = '			|| cd_local_estoque_w || 
				' ie_gerar_novo_lote_turno_dia_w = '|| ie_gerar_novo_lote_turno_dia_w || 
				' nr_seq_mat_hor_w = '				|| nr_seq_mat_hor_w	|| 
				' nr_seq_mat_hor_ant_w = '			|| nr_seq_mat_hor_ant_w ||
				' nr_seq_prescr_mat_w = '			|| nr_seq_prescr_mat_w ||
				' ie_urgente_w = '					|| ie_urgente_w || 
				' nr_seq_regra_local_w = '			|| nr_seq_regra_local_w ||
				' nr_prescricao_p = '				|| nr_prescricao_p ||
				' nr_sequencia_p = '				|| nr_sequencia_p,
				substr(dbms_utility.format_call_stack,1,2000));	
				
			
			
			/*ie_gerar_lote_disp_w := 'S';
			ie_gerar_lote_disp_ww := 'S';
			if	(ie_agrupador_w = 3) then --Caso for uma diluicao sistema verifica
				select	nvl(max(ie_gerar_lote_manipulacao), 'S')
				into	ie_gerar_lote_disp_w
				from	regra_local_dispensacao
				where	nr_sequencia = nr_seq_regra_local_w;
				
				select	max(a.nr_seq_mat_diluicao)
				into	nr_seq_mat_diluicao_w
				from	prescr_material a,
					prescr_mat_hor b
				where	a.nr_prescricao = b.nr_prescricao
				and	a.nr_sequencia = b.nr_seq_material
				and	b.nr_sequencia = nr_seq_mat_hor_w;
				
				select 	nvl(max(m.ie_gerar_lote_manipulacao),'S')
				into	ie_gerar_lote_disp_ww
				from	material_diluicao m
				where 	m.nr_seq_interno = nr_seq_mat_diluicao_w;
			end if;*/


			-- Alterado de trunc(dt_horario_w,'dd')  p/  trunc(dt_horario_w,'hh') , para gerar somente os associados do horario.
			if (ie_gerar_ap_lote_w = 'S') and (to_char(dt_horario_w,'hh24:mi') = to_char(dt_horario_ant_w,'hh24:mi')) and
				(((coalesce(ie_gerar_novo_lote_turno_dia_w,'N') = 'S') and (PKG_DATE_UTILS.start_of(dt_horario_w,'dd',0) = PKG_DATE_UTILS.start_of(dt_horario_ant_w,'dd',0))) or (coalesce(ie_gerar_novo_lote_turno_dia_w,'N') = 'N')) /*and
				((ie_gerar_lote_disp_w = 'S') and (ie_gerar_lote_disp_ww = 'S'))*/
 then
			
				insert into ap_lote_item(
					nr_sequencia,
					dt_atualizacao,
					nm_usuario,
					dt_atualizacao_nrec,
					nm_usuario_nrec,
					nr_seq_lote,
					nr_seq_mat_hor,
					ie_prescrito,
					qt_dispensar,
					qt_total_dispensar,
					cd_material,
					cd_unidade_medida,
					ie_urgente)
				values (nextval('ap_lote_item_seq'),
					clock_timestamp(),
					nm_usuario_p,
					clock_timestamp(),
					nm_usuario_p,
					nr_sequencia_w,
					nr_seq_mat_hor_w,
					'S',
					coalesce(qt_dispensar_hor_w,0),
					qt_dispensar_w,
					cd_material_ww,
					cd_unidade_medida_w,
					ie_urgente_w);	

				if	((ie_gerar_lote_apos_horario_w = 'S') or (dt_horario_w > clock_timestamp()) or (ie_origem_lote_p = 'AIP') or (ie_origem_lote_p = 'AIS')) then
					update	prescr_mat_hor
					set	nr_seq_lote	= nr_sequencia_w
					where	nr_sequencia	= nr_seq_mat_hor_w;
					
					/*if	((ie_origem_lote_p = 'AIP') or (ie_origem_lote_p = 'AIS')) and	
						(ie_gera_integracao_w = 'S') then
						disp_prescr_mat_hor(nr_prescricao_p, nr_seq_mat_hor_w, nm_usuario_p);
					end if;*/
				end if;
				
				ie_gera_novo_lote_w := 'S';
			end if;
			end;
		end loop;
		close C10;
	end if;
	end;
end loop;
close C01;
if (coalesce(wheb_usuario_pck.get_ie_commit, 'S') = 'S') then commit; end if;

nr_seq_turno_ant_w	:= 0;
nr_seq_classif_ant_w	:= 0;
dt_horario_ant_w	:= null;
cd_local_estoque_ant_w	:= 0;
nr_sequencia_w := null;

open C11;
loop
fetch C11 into	
	cd_material_w,
	nr_seq_mat_hor_w,
	nr_seq_prescr_mat_w,
	cd_unidade_medida_w,
	qt_dispensar_w,
	qt_dispensar_hor_w,
	nr_seq_turno_w,
	dt_horario_w,
	hr_hora_w,
	cd_estabelecimento_w,
	ie_urgente_w,
	nr_seq_classif_w,
	cd_local_estoque_w,
	nr_regra_local_disp_w;
EXIT WHEN NOT FOUND; /* apply on C11 */
	begin
	
	select	coalesce(max(ie_gerar_ap_lote),'S'),coalesce(max(ie_send_info_to_integration), 'N')
	into STRICT	ie_gerar_ap_lote_w, ie_send_integration_w
	from	regra_local_dispensacao
	where	nr_sequencia = nr_regra_local_disp_w;
	
	if (ie_setor_atual_w = 'S') and (ie_origem_lote_p = 'AIP') then
		
		cd_local_estoque_w := obter_local_disp_prescr_item(	nr_prescricao_p,
									nr_seq_prescr_mat_w,
									obter_perfil_ativo,
									'N',
									'S',
									'S',
									nm_usuario_p);
		
	end if;
	
	insert into ap_lote_log(
		nr_sequencia,
		dt_atualizacao, 
		nm_usuario, 
		dt_atualizacao_nrec, 
		nm_usuario_nrec, 
		nr_prescricao, 
		nr_seq_mat_hor, 
		nr_seq_lote, 
		ds_tipo_item, 
		ds_conteudo, 
		ds_stack)
	values (nextval('ap_lote_log_seq'),
		clock_timestamp(),
		nm_usuario_p,
		clock_timestamp(),
		nm_usuario_p,
		nr_prescricao_p,
		nr_seq_horario_p,
		null,
		'Gerar_Lote_Atend_Prescr_Desdob3',
		' nr_seq_turno_w = ' 		|| nr_seq_turno_w || 
		' nr_seq_turno_ant_w = '	|| nr_seq_turno_ant_w || 
		' nr_seq_classif_w = '		|| nr_seq_classif_w ||
		' nr_seq_classif_ant_w = '	|| nr_seq_classif_ant_w || 
		' dt_horario_w = '			|| PKG_DATE_FORMATERS_TZ.TO_VARCHAR(dt_horario_w, 'timestamp', ESTABLISHMENT_TIMEZONE_UTILS.getTimeZone)||
		' dt_horario_ant_w = '		|| PKG_DATE_FORMATERS_TZ.TO_VARCHAR(dt_horario_ant_w, 'timestamp', ESTABLISHMENT_TIMEZONE_UTILS.getTimeZone)|| 
		' hr_hora_w = '				|| PKG_DATE_FORMATERS_TZ.TO_VARCHAR(to_date(hr_hora_w,'hh24:mi'), 'shortTime', ESTABLISHMENT_TIMEZONE_UTILS.getTimeZone)|| 
		' cd_local_estoque_w = '	|| cd_local_estoque_w ||
		' cd_local_estoque_ant_w = '|| cd_local_estoque_ant_w || 
		' nr_seq_mat_hor_w = '		|| nr_seq_mat_hor_w ||
		' nr_seq_mat_hor_ant_w = '	|| nr_seq_mat_hor_ant_w ||
		' nr_seq_prescr_mat_w = '	|| nr_seq_prescr_mat_w || 
		' ie_urgente_w = '			|| ie_urgente_w ||
		' nr_prescricao_p = '		|| nr_prescricao_p ||
		' nr_sequencia_p = '		|| nr_sequencia_p||
		';ie_gerar_ap_lote_w='		||ie_gerar_ap_lote_w,
		substr(dbms_utility.format_call_stack,1,2000));
		
	if (ie_gerar_ap_lote_w = 'S') and
		((nr_seq_turno_w <> nr_seq_turno_ant_w) or (nr_seq_classif_w <> nr_seq_classif_ant_w) or
		((PKG_DATE_UTILS.start_of(dt_horario_w,'dd',0) <> PKG_DATE_UTILS.start_of(dt_horario_ant_w,'dd',0)) and (ie_gerar_novo_lote_turno_dia_w = 'S')) or
		(((dt_horario_w - dt_inicio_turno_w) >= 1) and (ie_novo_lote_dia_w = 'S')) or
		((ie_desdobra_mesmo_turno_w = 'S') and (nr_seq_mat_hor_w <> nr_seq_mat_hor_ant_w) and ((ie_gera_lote_desdobrado_w <> 'A') or (ie_urgente_w <> 'S'))) or
		((ie_desdobra_mesmo_turno_w = 'T') and (to_char(dt_horario_w,'hh24:mi') <> to_char(dt_horario_ant_w,'hh24:mi')) and ((ie_gera_lote_desdobrado_w <> 'A') or (ie_urgente_w <> 'S'))) or (cd_local_estoque_w <> cd_local_estoque_ant_w)) and
		((ie_gerar_lote_apos_horario_w = 'S') or (dt_horario_w > clock_timestamp()) or (ie_origem_lote_p = 'AIP') or (ie_origem_lote_p = 'AIS')) then
		begin
		OPEN C02;
		LOOP
			FETCH C02 INTO
				hr_inicio_turno_w;
			EXIT WHEN NOT FOUND; /* apply on c02 */
			begin
			hr_inicio_turno_w	:= hr_inicio_turno_w;
			end;
		END LOOP;
		CLOSE C02;
		
		select	coalesce(max(qt_prioridade),999)
		into STRICT	qt_prioridade_w
		from	classif_lote_disp_far
		where	nr_sequencia	= nr_seq_classif_w;

		if (hr_hora_w < hr_inicio_turno_w) then
			dt_inicio_turno_w	:= pkg_date_utils.get_time(dt_horario_w - 1,hr_inicio_turno_w);
		else
			dt_inicio_turno_w	:= pkg_date_utils.get_time(dt_horario_w,hr_inicio_turno_w);
		end if;
		
		select	nextval('ap_lote_seq')
		into STRICT	nr_sequencia_w
		;
		
		insert into ap_lote_log(
			nr_sequencia,
			dt_atualizacao, 
			nm_usuario, 
			dt_atualizacao_nrec, 
			nm_usuario_nrec, 
			nr_prescricao, 
			nr_seq_mat_hor, 
			nr_seq_lote, 
			ds_tipo_item, 
			ds_conteudo, 
			ds_stack)
		values (nextval('ap_lote_log_seq'),
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			nr_prescricao_p,
			nr_seq_horario_p,
			null,
			'Gerar_Lote_Atend_Prescr_Desdob31',
			' nr_seq_turno_w = '		|| nr_seq_turno_w || 
			' nr_seq_turno_ant_w = '	|| nr_seq_turno_ant_w ||
			' nr_seq_classif_w = '		|| nr_seq_classif_w ||
			' nr_seq_classif_ant_w = '	|| nr_seq_classif_ant_w ||
			' dt_horario_w = '			|| PKG_DATE_FORMATERS_TZ.TO_VARCHAR(dt_horario_w, 'timestamp', ESTABLISHMENT_TIMEZONE_UTILS.getTimeZone)||
			' dt_horario_ant_w = '		|| PKG_DATE_FORMATERS_TZ.TO_VARCHAR(dt_horario_ant_w, 'timestamp', ESTABLISHMENT_TIMEZONE_UTILS.getTimeZone)||
			' hr_hora_w = '				|| PKG_DATE_FORMATERS_TZ.TO_VARCHAR(to_date(hr_hora_w,'hh24:mi'), 'shortTime', ESTABLISHMENT_TIMEZONE_UTILS.getTimeZone)|| 
			' cd_local_estoque_w = '	|| cd_local_estoque_w ||
			' cd_local_estoque_ant_w = '|| cd_local_estoque_ant_w || 
			' nr_seq_mat_hor_w = '		|| nr_seq_mat_hor_w ||
			' nr_seq_mat_hor_ant_w = '	|| nr_seq_mat_hor_ant_w ||
			' nr_seq_prescr_mat_w = '	|| nr_seq_prescr_mat_w ||
			' ie_urgente_w = '			|| ie_urgente_w ||
			' nr_prescricao_p = '		|| nr_prescricao_p ||
			' nr_sequencia_p = '		|| nr_sequencia_p||
			';ie_gerar_ap_lote_w='		||ie_gerar_ap_lote_w || 
			' nr_seq_lote='				|| nr_sequencia_w,
			substr(dbms_utility.format_call_stack,1,2000));
		
		insert into ap_lote(
			nr_sequencia,
			dt_inicio_turno,
			dt_prim_horario,
			dt_atualizacao,
			nm_usuario,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			dt_geracao_lote,
			nr_prescricao,
			nr_seq_turno,
			ie_status_lote,
			cd_setor_atendimento,
			nr_seq_classif,
			nm_usuario_geracao,
			ds_maquina_geracao,
			cd_perfil_geracao,
			qt_min_atraso_inicio_atend,
			qt_min_atraso_atend,
			qt_min_atraso_disp,
			qt_min_atraso_entrega,
			qt_min_atraso_receb,
			cd_tipo_baixa,
			ie_conta_paciente,
			ie_atualiza_estoque,
			cd_local_estoque,
			qt_prioridade,
			ie_origem_lote,
			nr_seq_local_geracao,
			nr_atendimento)
		values ( nr_sequencia_w,
			dt_inicio_turno_w,
			dt_horario_w,
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			nr_prescricao_p,
			nr_seq_turno_w,
			'G',
			cd_setor_atendimento_w,
			nr_seq_classif_w,
			nm_usuario_p,
			ds_maq_user_w,
			cd_perfil_ativo_w,
			0,
			0,
			0,
			0,
			0,
			cd_tipo_baixa_w,
			ie_conta_paciente_w,
			ie_atualiza_estoque_w,
			cd_local_estoque_w,
			qt_prioridade_w,
			ie_origem_lote_p,
			'DB',
			nr_atendimento_w);
     if (ie_send_integration_w ='S' )then
            CALL acceptance_submission_cancel(nr_sequencia_w,clock_timestamp(),null,'A',nr_prescricao_p,nm_usuario_p);
     end if;
		
		if	((ie_origem_lote_p = 'AIP') or (ie_origem_lote_p = 'AIS') or (ie_origem_lote_p = 'AGND')) then
			nr_seq_mat_hor_aip_ais_w := nr_seq_mat_hor_w;
		end if;
		end;
		
	end if;
	
	
	if (ie_gerar_ap_lote_w = 'S') and
		((ie_gerar_lote_apos_horario_w = 'S') or (dt_horario_w > clock_timestamp()) or (ie_origem_lote_p = 'AIP') or (ie_origem_lote_p = 'AIS')) and (nr_sequencia_w > 0) then
	
		nr_seq_turno_ant_w	:= nr_seq_turno_w;
		nr_seq_classif_ant_w	:= nr_seq_classif_w;
		cd_local_estoque_ant_w	:= cd_local_estoque_w;
		dt_horario_ant_w	:= dt_horario_w;
		nr_seq_mat_hor_ant_w	:= nr_seq_mat_hor_w;

		
		insert into ap_lote_item(
			nr_sequencia,
			dt_atualizacao,
			nm_usuario,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			nr_seq_lote,
			nr_seq_mat_hor,
			ie_prescrito,
			qt_dispensar,
			qt_total_dispensar,
			cd_material,
			cd_unidade_medida,
			ie_urgente)
		values (nextval('ap_lote_item_seq'),
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			nr_sequencia_w,
			nr_seq_mat_hor_w,
			'S',
			coalesce(qt_dispensar_hor_w,0),
			qt_dispensar_w,
			cd_material_w,
			cd_unidade_medida_w,
			ie_urgente_w);
		
		/*if	((ie_origem_lote_p = 'AIP') or (ie_origem_lote_p = 'AIS')) and	
				(ie_gera_integracao_w = 'S') then
				disp_prescr_mat_hor(nr_prescricao_p, nr_seq_mat_hor_w, nm_usuario_p);
		end if;*/
		
		if	((ie_gerar_lote_apos_horario_w = 'S') or (dt_horario_w > clock_timestamp()) or (ie_origem_lote_p = 'AIP') or (ie_origem_lote_p = 'AIS')) then
			update	prescr_mat_hor
			set	nr_seq_lote	= nr_sequencia_w
			where	nr_sequencia	= nr_seq_mat_hor_w;	
		
		end if;
	
		select	coalesce(max(qt_prioridade),999)
		into STRICT	qt_prioridade_hor_w
		from	classif_lote_disp_far
		where	nr_sequencia	= nr_seq_classif_w;
		
		if (qt_prioridade_hor_w <> qt_prioridade_w) and (qt_prioridade_hor_w < qt_prioridade_w) then
			update	ap_lote
			set	nr_seq_classif = nr_seq_classif_w
			where	nr_sequencia = nr_sequencia_w;
		end if;
	end if;
	end;
end loop;
close C11;
if (coalesce(wheb_usuario_pck.get_ie_commit, 'S') = 'S') then commit; end if;

nr_seq_turno_ant_w	:= 0;
nr_seq_classif_ant_w	:= 0;
dt_horario_ant_w	:= null;
cd_local_estoque_ant_w	:= 0;
nr_seq_solucao_ant_w	:= 0;

-- Somente para solucao
open C12;
loop
fetch C12 into	
	cd_material_w,
	nr_seq_mat_hor_w,
	nr_seq_prescr_mat_w,
	nr_seq_solucao_w,
	cd_unidade_medida_w,
	qt_dispensar_w,
	qt_dispensar_hor_w,
	nr_seq_turno_w,
	dt_horario_w,
	hr_hora_w,
	cd_estabelecimento_w,
	ie_urgente_w,
	nr_seq_classif_w,
	cd_local_estoque_w,
	ie_controlado_w,
	nr_regra_local_disp_w;
EXIT WHEN NOT FOUND; /* apply on C12 */
	begin	
	
	select	coalesce(max(ie_gerar_ap_lote),'S'),coalesce(max(ie_send_info_to_integration), 'N')
	into STRICT	ie_gerar_ap_lote_w, ie_send_integration_w
	from	regra_local_dispensacao
	where	nr_sequencia = nr_regra_local_disp_w;
	
	if (ie_setor_atual_w = 'S') and (ie_origem_lote_p = 'AIP') then
		
		cd_local_estoque_w := obter_local_disp_prescr_item(	nr_prescricao_p,
									nr_seq_prescr_mat_w,
									obter_perfil_ativo,
									'N',
									'S',
									'S',
									nm_usuario_p);
		
	end if;
	
	insert into ap_lote_log(
		nr_sequencia,
		dt_atualizacao, 
		nm_usuario, 
		dt_atualizacao_nrec, 
		nm_usuario_nrec, 
		nr_prescricao, 
		nr_seq_mat_hor, 
		nr_seq_lote, 
		ds_tipo_item, 
		ds_conteudo, 
		ds_stack)
	values (nextval('ap_lote_log_seq'),
		clock_timestamp(),
		nm_usuario_p,
		clock_timestamp(),
		nm_usuario_p,
		nr_prescricao_p,
		nr_seq_horario_p,
		null,
		'Gerar_Lote_Atend_Prescr_Desdob4',
		' nr_seq_turno_w = '		|| nr_seq_turno_w || 
		' nr_seq_turno_ant_w = '	|| nr_seq_turno_ant_w || 
		' nr_seq_classif_w = '		|| nr_seq_classif_w ||
		' nr_seq_classif_ant_w = '	|| nr_seq_classif_ant_w || 
		' dt_horario_w = '			|| PKG_DATE_FORMATERS_TZ.TO_VARCHAR(dt_horario_w, 'timestamp', ESTABLISHMENT_TIMEZONE_UTILS.getTimeZone)||
		' dt_horario_ant_w = '		|| PKG_DATE_FORMATERS_TZ.TO_VARCHAR(dt_horario_ant_w, 'timestamp', ESTABLISHMENT_TIMEZONE_UTILS.getTimeZone)|| 
		' hr_hora_w = '				|| PKG_DATE_FORMATERS_TZ.TO_VARCHAR(to_date(hr_hora_w,'hh24:mi'), 'shortTime', ESTABLISHMENT_TIMEZONE_UTILS.getTimeZone) ||
		' cd_local_estoque_w = '	|| cd_local_estoque_w ||
		' cd_local_estoque_ant_w = '|| cd_local_estoque_ant_w ||
		' nr_seq_mat_hor_w = '		|| nr_seq_mat_hor_w ||
		' nr_seq_mat_hor_ant_w = '	|| nr_seq_mat_hor_ant_w || 
		' nr_seq_prescr_mat_w = '	|| nr_seq_prescr_mat_w || 
		' ie_urgente_w = '			|| ie_urgente_w ||
		' nr_seq_solucao_w = '		|| nr_seq_solucao_w || 
		' nr_seq_solucao_ant_w = '	|| nr_seq_solucao_ant_w || 
		' nr_prescricao_p = '		|| nr_prescricao_p ||
		' nr_sequencia_p = '		|| nr_sequencia_p ||
		';ie_gerar_ap_lote_w='		||ie_gerar_ap_lote_w,

		substr(dbms_utility.format_call_stack,1,2000));

	if (ie_gerar_ap_lote_w = 'S') and
		(((nr_seq_turno_w <> nr_seq_turno_ant_w) or
		(nr_seq_classif_w <> nr_seq_classif_ant_w AND nr_seq_solucao_w <> nr_seq_solucao_ant_w) or --OS 810229
		((coalesce(ie_gerar_sol_separado_w,'N') = 'S') and (nr_seq_solucao_w <> nr_seq_solucao_ant_w)) or
		((PKG_DATE_UTILS.start_of(dt_horario_w,'dd',0) <> PKG_DATE_UTILS.start_of(dt_horario_ant_w,'dd',0)) and (ie_gerar_novo_lote_turno_dia_w = 'S')) or
		(((dt_horario_w - dt_inicio_turno_w) > 1) and (ie_novo_lote_dia_w = 'S')) or
		((ie_desdobra_mesmo_turno_w in ('S', 'A')) and (nr_seq_solucao_w <> nr_seq_solucao_ant_w) and ((ie_gera_lote_desdobrado_w <> 'A') or (ie_urgente_w <> 'S'))) or
		((ie_desdobra_mesmo_turno_w in ('S', 'T')) and (to_char(dt_horario_w,'hh24:mi') <> to_char(dt_horario_ant_w,'hh24:mi')) and ((ie_gera_lote_desdobrado_w <> 'A') or (ie_urgente_w <> 'S'))) or
		((coalesce(ie_desdobrar_solucao_w,'N') = 'S') and (ie_desdobra_mesmo_turno_w in ('T','S')) and (nr_seq_solucao_w = nr_seq_solucao_ant_w) and (ie_gera_lote_desdobrado_w <> 'A')) or
		(ie_ajusta_local_item_sol_w <> 'S' AND cd_local_estoque_w <> cd_local_estoque_ant_w)) and
		((ie_gerar_lote_apos_horario_w = 'S') or (dt_horario_w > clock_timestamp()) or (ie_origem_lote_p = 'AIP') or (ie_origem_lote_p = 'AIS'))) then
		begin
		OPEN C02;
		LOOP
			FETCH C02 INTO
				hr_inicio_turno_w;
			EXIT WHEN NOT FOUND; /* apply on c02 */
			begin
			hr_inicio_turno_w	:= hr_inicio_turno_w;
			end;
		END LOOP;
		CLOSE C02;
		
		select	coalesce(max(qt_prioridade),999)
		into STRICT	qt_prioridade_w
		from	classif_lote_disp_far
		where	nr_sequencia	= nr_seq_classif_w;

		if (hr_hora_w < hr_inicio_turno_w) then
			dt_inicio_turno_w	:= pkg_date_utils.get_time(dt_horario_w - 1,hr_inicio_turno_w);
		else
			dt_inicio_turno_w	:= pkg_date_utils.get_time(dt_horario_w,hr_inicio_turno_w);
		end if;
		
		select	nextval('ap_lote_seq')
		into STRICT	nr_sequencia_w
		;
		insert into ap_lote(
			nr_sequencia,
			dt_inicio_turno,
			dt_prim_horario,
			dt_atualizacao,
			nm_usuario,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			dt_geracao_lote,
			nr_prescricao,
			nr_seq_turno,
			ie_status_lote,
			cd_setor_atendimento,
			nr_seq_classif,
			nm_usuario_geracao,
			ds_maquina_geracao,
			cd_perfil_geracao,
			qt_min_atraso_inicio_atend,
			qt_min_atraso_atend,
			qt_min_atraso_disp,
			qt_min_atraso_entrega,
			qt_min_atraso_receb,
			cd_tipo_baixa,
			ie_conta_paciente,
			ie_atualiza_estoque,
			cd_local_estoque,
			qt_prioridade,
			ie_origem_lote,
			nr_seq_local_geracao,
			nr_atendimento)
		values ( nr_sequencia_w,
			dt_inicio_turno_w,
			dt_horario_w,
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			nr_prescricao_p,
			nr_seq_turno_w,
			'G',
			cd_setor_atendimento_w,
			nr_seq_classif_w,
			nm_usuario_p,
			ds_maq_user_w,
			cd_perfil_ativo_w,
			0,
			0,
			0,
			0,
			0,
			cd_tipo_baixa_w,
			ie_conta_paciente_w,
			ie_atualiza_estoque_w,
			cd_local_estoque_w,
			qt_prioridade_w,
			ie_origem_lote_p,
			'DB',
			nr_atendimento_w);
    if (ie_send_integration_w ='S' )then
            CALL acceptance_submission_cancel(nr_sequencia_w,clock_timestamp(),null,'A',nr_prescricao_p,nm_usuario_p);
    end if;
		if	((ie_origem_lote_p = 'AIP') or (ie_origem_lote_p = 'AIS') or (ie_origem_lote_p = 'AGND')) then
			nr_seq_mat_hor_aip_ais_w := nr_seq_mat_hor_w;
		end if;			
		end;
	else
		
		if (coalesce(ie_controlado_w,'N') = 'S') then
			update 	ap_lote
			set 	nr_Seq_classif = nr_seq_classif_w
			where 	nr_sequencia = nr_sequencia_w;
		end if;
	end if;
	
	if (ie_gerar_ap_lote_w = 'S') and
		(((ie_gerar_lote_apos_horario_w = 'S') or (dt_horario_w > clock_timestamp()) or (ie_origem_lote_p = 'AIP') or (ie_origem_lote_p = 'AIS'))) and (nr_sequencia_w > 0) then

		nr_seq_turno_ant_w	:= nr_seq_turno_w;
		nr_seq_classif_ant_w	:= nr_seq_classif_w;
		cd_local_estoque_ant_w	:= cd_local_estoque_w;
		dt_horario_ant_w	:= dt_horario_w;
		nr_seq_solucao_ant_w	:= nr_seq_solucao_w;
		nr_seq_mat_hor_ant_w	:= nr_seq_mat_hor_w;
		
		insert into ap_lote_item(
			nr_sequencia,
			dt_atualizacao,
			nm_usuario,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			nr_seq_lote,
			nr_seq_mat_hor,
			ie_prescrito,
			qt_dispensar,
			qt_total_dispensar,
			cd_material,
			cd_unidade_medida,
			ie_urgente)
		values (nextval('ap_lote_item_seq'),
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			nr_sequencia_w,
			nr_seq_mat_hor_w,
			'S',
			coalesce(qt_dispensar_hor_w,0),
			qt_dispensar_w,
			cd_material_w,
			cd_unidade_medida_w,
			ie_urgente_w);
		
		if	((ie_gerar_lote_apos_horario_w = 'S') or (dt_horario_w > clock_timestamp()) or (ie_origem_lote_p = 'AIP') or (ie_origem_lote_p = 'AIS')) then
			update	prescr_mat_hor
			set	nr_seq_lote	= nr_sequencia_w
			where	nr_sequencia	= nr_seq_mat_hor_w;	
		end if;
		
		select	coalesce(max(qt_prioridade),999)
		into STRICT	qt_prioridade_hor_w
		from	classif_lote_disp_far
		where	nr_sequencia	= nr_seq_classif_w;
		
		if (qt_prioridade_hor_w <> qt_prioridade_w) and (qt_prioridade_hor_w < qt_prioridade_w) then
			update	ap_lote
			set	nr_seq_classif = nr_seq_classif_w
			where	nr_sequencia = nr_sequencia_w;
			
	/*		if	((ie_origem_lote_p = 'AIP') or (ie_origem_lote_p = 'AIS')) and	
				(ie_gera_integracao_w = 'S') then
				disp_prescr_mat_hor(nr_prescricao_p, nr_seq_mat_hor_w, nm_usuario_p);
			end if;*/
		end if;
		
		open C13;
		loop
		fetch C13 into	
			cd_material_w,
			nr_seq_mat_hor_w,
			nr_seq_solucao_w,
			cd_unidade_medida_w,
			qt_dispensar_w,
			qt_dispensar_hor_w,
			nr_seq_turno_w,
			dt_horario_w,
			hr_hora_w,
			cd_estabelecimento_w,
			ie_urgente_w,
			nr_seq_classif_w,
			cd_local_estoque_w,
			nr_regra_local_disp_w;
		EXIT WHEN NOT FOUND; /* apply on C13 */
			begin
			
			select	coalesce(max(ie_gerar_ap_lote),'S'),coalesce(max(ie_send_info_to_integration), 'N')
			into STRICT	ie_gerar_ap_lote_w, ie_send_integration_w
			from	regra_local_dispensacao
			where	nr_sequencia = nr_regra_local_disp_w;
			
		insert into ap_lote_log(
			nr_sequencia,
			dt_atualizacao, 
			nm_usuario, 
			dt_atualizacao_nrec, 
			nm_usuario_nrec, 
			nr_prescricao, 
			nr_seq_mat_hor, 
			nr_seq_lote, 
			ds_tipo_item, 
			ds_conteudo, 
			ds_stack)
		values (nextval('ap_lote_log_seq'),
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			nr_prescricao_p,
			nr_seq_horario_p,
			null,
			'Gerar_Lote_Atend_Prescr_Desdob10',
			' cd_material_w = '			|| cd_material_w || 
			' nr_seq_mat_hor_w = '		|| nr_seq_mat_hor_w || 
			' nr_seq_classif_w = '		|| nr_seq_classif_w ||
			' cd_local_estoque_w = '	|| cd_local_estoque_w || 
			' dt_horario_w = '			|| PKG_DATE_FORMATERS_TZ.TO_VARCHAR(dt_horario_w, 'timestamp', ESTABLISHMENT_TIMEZONE_UTILS.getTimeZone) ||
			' dt_horario_ant_w = '		|| PKG_DATE_FORMATERS_TZ.TO_VARCHAR(dt_horario_ant_w, 'timestamp', ESTABLISHMENT_TIMEZONE_UTILS.getTimeZone)|| 
			' hr_hora_w = '				|| PKG_DATE_FORMATERS_TZ.TO_VARCHAR(to_date(hr_hora_w,'hh24:mi'), 'shortTime', ESTABLISHMENT_TIMEZONE_UTILS.getTimeZone) ||
			' nr_seq_turno_w = '		|| nr_seq_turno_w ||
			' cd_local_estoque_ant_w = '|| cd_local_estoque_ant_w || 
			' nr_seq_mat_hor_w = '		|| nr_seq_mat_hor_w ||
			' nr_seq_mat_hor_ant_w = '	|| nr_seq_mat_hor_ant_w || 
			' nr_seq_prescr_mat_w = '	|| nr_seq_prescr_mat_w || 
			' ie_urgente_w = '			|| ie_urgente_w ||
			' nr_seq_solucao_w = '		|| nr_seq_solucao_w || 
			' nr_seq_solucao_ant_w = '	|| nr_seq_solucao_ant_w || 
			' nr_prescricao_p = '		|| nr_prescricao_p ||
			' nr_sequencia_p = '		|| nr_sequencia_p,
			substr(dbms_utility.format_call_stack,1,2000));
			
			if (ie_gerar_ap_lote_w = 'S') and (to_char(dt_horario_w,'hh24:mi') = to_char(dt_horario_ant_w,'hh24:mi')) and (PKG_DATE_UTILS.start_of(dt_horario_w,'dd',0) = PKG_DATE_UTILS.start_of(dt_horario_ant_w,'dd',0)) then
			
				insert into ap_lote_item(
					nr_sequencia,
					dt_atualizacao,
					nm_usuario,
					dt_atualizacao_nrec,
					nm_usuario_nrec,
					nr_seq_lote,
					nr_seq_mat_hor,
					ie_prescrito,
					qt_dispensar,
					qt_total_dispensar,
					cd_material,
					cd_unidade_medida,
					ie_urgente)
				values (nextval('ap_lote_item_seq'),
					clock_timestamp(),
					nm_usuario_p,
					clock_timestamp(),
					nm_usuario_p,
					nr_sequencia_w,
					nr_seq_mat_hor_w,
					'S',
					coalesce(qt_dispensar_hor_w,0),
					qt_dispensar_w,
					cd_material_w,
					cd_unidade_medida_w,
					ie_urgente_w);		
				
				if	((ie_gerar_lote_apos_horario_w = 'S') or (dt_horario_w > clock_timestamp()) or (ie_origem_lote_p = 'AIP') or (ie_origem_lote_p = 'AIS')) then
					update	prescr_mat_hor
					set	nr_seq_lote	= nr_sequencia_w
					where	nr_sequencia	= nr_seq_mat_hor_w;
					
					/*if	((ie_origem_lote_p = 'AIP') or (ie_origem_lote_p = 'AIS')) and	
						(ie_gera_integracao_w = 'S') then
						disp_prescr_mat_hor(nr_prescricao_p, nr_seq_mat_hor_w, nm_usuario_p);
					end if;*/
				end if;
			end if;
			end;
		end loop;
		close C13;
	end if;	
	end;
end loop;
close C12;
if (coalesce(wheb_usuario_pck.get_ie_commit, 'S') = 'S') then commit; end if;

nr_seq_turno_ant_w	:= 0;
nr_seq_classif_ant_w	:= 0;
dt_horario_ant_w	:= null;
cd_local_estoque_ant_w	:= 0;
nr_seq_mat_hor_ant_w	:= 0;
nr_sequencia_proc_ant_w	:= 0;
nr_sequencia_w			:= null;

ie_gera_novo_lote_w := 'N';
open C15;
loop
fetch C15 into	
	cd_material_w,
	nr_seq_mat_hor_w,
	nr_seq_prescr_mat_w,
	cd_unidade_medida_w,
	qt_dispensar_w,
	qt_dispensar_hor_w,
	nr_seq_turno_w,
	dt_horario_w,
	hr_hora_w,
	cd_estabelecimento_w,
	ie_urgente_w,
	nr_seq_classif_w,
	cd_local_estoque_w,
	nr_sequencia_proc_w,
	nr_regra_local_disp_w;
EXIT WHEN NOT FOUND; /* apply on C15 */
	begin
	
	select	coalesce(max(ie_gerar_ap_lote),'S'),coalesce(max(ie_send_info_to_integration), 'N')
	into STRICT	ie_gerar_ap_lote_w, ie_send_integration_w
	from	regra_local_dispensacao
	where	nr_sequencia = nr_regra_local_disp_w;
	
	if (ie_setor_atual_w = 'S') and (ie_origem_lote_p = 'AIP') then
		
		cd_local_estoque_w := obter_local_disp_prescr_item(	nr_prescricao_p,
									nr_seq_prescr_mat_w,
									obter_perfil_ativo,
									'N',
									'S',
									'S',
									nm_usuario_p);
		
	end if;
	
	ie_gera_novo_lote_w := 'N';
	
	insert into ap_lote_log(
		nr_sequencia,
		dt_atualizacao, 
		nm_usuario, 
		dt_atualizacao_nrec, 
		nm_usuario_nrec, 
		nr_prescricao, 
		nr_seq_mat_hor, 
		nr_seq_lote, 
		ds_tipo_item, 
		ds_conteudo, 
		ds_stack)
	values (nextval('ap_lote_log_seq'),
		clock_timestamp(),
		nm_usuario_p,
		clock_timestamp(),
		nm_usuario_p,
		nr_prescricao_p,
		nr_seq_horario_p,
		null,
		'Gerar_Lote_Atend_Prescr_Desdob5',
		' nr_seq_turno_w = ' 			|| nr_seq_turno_w || 
		' nr_seq_turno_ant_w = '		|| nr_seq_turno_ant_w || 
		' nr_seq_classif_w = '			|| nr_seq_classif_w ||
		' nr_seq_classif_ant_w = '		|| nr_seq_classif_ant_w || 
		' dt_horario_w = '				|| PKG_DATE_FORMATERS_TZ.TO_VARCHAR(dt_horario_w, 'timestamp', ESTABLISHMENT_TIMEZONE_UTILS.getTimeZone) ||
		' dt_horario_ant_w = '			|| PKG_DATE_FORMATERS_TZ.TO_VARCHAR(dt_horario_ant_w, 'timestamp', ESTABLISHMENT_TIMEZONE_UTILS.getTimeZone)|| 
		' hr_hora_w = '					|| PKG_DATE_FORMATERS_TZ.TO_VARCHAR(to_date(hr_hora_w,'hh24:mi'), 'shortTime', ESTABLISHMENT_TIMEZONE_UTILS.getTimeZone) ||
		' cd_local_estoque_w = '		|| cd_local_estoque_w || 
		' cd_local_estoque_ant_w = '	|| cd_local_estoque_ant_w || 
		' nr_seq_mat_hor_w = '			|| nr_seq_mat_hor_w || 
		' nr_seq_mat_hor_ant_w = '		|| nr_seq_mat_hor_ant_w || 
		' nr_seq_prescr_mat_w = '		|| nr_seq_prescr_mat_w ||
		' ie_urgente_w = '				|| ie_urgente_w || 
		' nr_sequencia_proc_w = '		|| nr_sequencia_proc_w || 
		' nr_sequencia_proc_ant_w = '	|| nr_sequencia_proc_ant_w ||
		' nr_prescricao_p = '			|| nr_prescricao_p ||
		' nr_sequencia_p = '			|| nr_sequencia_p,
		substr(dbms_utility.format_call_stack,1,2000));
	
	if	((nr_seq_turno_w <> nr_seq_turno_ant_w) or (nr_seq_classif_w <> nr_seq_classif_ant_w) or
		((PKG_DATE_UTILS.start_of(dt_horario_w,'dd',0) <> PKG_DATE_UTILS.start_of(dt_horario_ant_w,'dd',0)) and (ie_gerar_novo_lote_turno_dia_w = 'S')) or
		(((dt_horario_w - dt_inicio_turno_w) > 1) and (ie_novo_lote_dia_w = 'S')) or (cd_local_estoque_w <> cd_local_estoque_ant_w) or (nr_sequencia_proc_w <> nr_sequencia_proc_ant_w))and
		((ie_gerar_lote_apos_horario_w = 'S') or
		((dt_horario_w > clock_timestamp()) or (ie_origem_lote_p = 'AIP') or (ie_origem_lote_p = 'AIS'))) and (ie_gerar_ap_lote_w = 'S') then
		begin
		OPEN C02;
		LOOP
			FETCH C02 INTO
				hr_inicio_turno_w;
			EXIT WHEN NOT FOUND; /* apply on c02 */
			begin
			hr_inicio_turno_w	:= hr_inicio_turno_w;
			end;
		END LOOP;
		CLOSE C02;
		
		select	coalesce(max(qt_prioridade),999)
		into STRICT	qt_prioridade_w
		from	classif_lote_disp_far
		where	nr_sequencia	= nr_seq_classif_w;

		if (hr_hora_w < hr_inicio_turno_w) then
			dt_inicio_turno_w	:= pkg_date_utils.get_time(dt_horario_w - 1,hr_inicio_turno_w);
		else
			dt_inicio_turno_w	:= pkg_date_utils.get_time(dt_horario_w,hr_inicio_turno_w);
		end if;
		
		select	nextval('ap_lote_seq')
		into STRICT	nr_sequencia_w
		;
		
		insert into ap_lote(
			nr_sequencia,
			dt_inicio_turno,
			dt_prim_horario,
			dt_atualizacao,
			nm_usuario,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			dt_geracao_lote,
			nr_prescricao,
			nr_seq_turno,
			ie_status_lote,
			cd_setor_atendimento,
			nr_seq_classif,
			nm_usuario_geracao,
			ds_maquina_geracao,
			cd_perfil_geracao,
			qt_min_atraso_inicio_atend,
			qt_min_atraso_atend,
			qt_min_atraso_disp,
			qt_min_atraso_entrega,
			qt_min_atraso_receb,
			cd_tipo_baixa,
			ie_conta_paciente,
			ie_atualiza_estoque,
			cd_local_estoque,
			qt_prioridade,
			ie_origem_lote,
			nr_seq_local_geracao,
			nr_atendimento)
		values ( nr_sequencia_w,
			dt_inicio_turno_w,
			dt_horario_w,
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			nr_prescricao_p,
			nr_seq_turno_w,
			'G',
			cd_setor_atendimento_w,
			nr_seq_classif_w,
			nm_usuario_p,
			ds_maq_user_w,
			cd_perfil_ativo_w,
			0,
			0,
			0,
			0,
			0,
			cd_tipo_baixa_w,
			ie_conta_paciente_w,
			ie_atualiza_estoque_w,
			cd_local_estoque_w,
			qt_prioridade_w,
			ie_origem_lote_p,
			'DB',
			nr_atendimento_w);
    if (ie_send_integration_w ='S' )then
            CALL acceptance_submission_cancel(nr_sequencia_w,clock_timestamp(),null,'A',nr_prescricao_p,nm_usuario_p);
    end if;	
		ie_gera_novo_lote_w := 'N';
		if	((ie_origem_lote_p = 'AIP') or (ie_origem_lote_p = 'AIS') or (ie_origem_lote_p = 'AGND')) then
			nr_seq_mat_hor_aip_ais_w := nr_seq_mat_hor_w;
		end if;
		end;
	end if;
		
	if	((ie_gerar_lote_apos_horario_w = 'S') or
		((dt_horario_w > clock_timestamp()) or (ie_origem_lote_p = 'AIP') or (ie_origem_lote_p = 'AIS'))) and (ie_gerar_ap_lote_w = 'S') then
		
		nr_seq_turno_ant_w	:= nr_seq_turno_w;
		nr_seq_classif_ant_w	:= nr_seq_classif_w;
		cd_local_estoque_ant_w	:= cd_local_estoque_w;
		dt_horario_ant_w	:= dt_horario_w;
		nr_seq_mat_hor_ant_w	:= nr_seq_mat_hor_w;
		nr_sequencia_proc_ant_w	:= nr_sequencia_proc_w;
			
		insert into ap_lote_item(
			nr_sequencia,
			dt_atualizacao,
			nm_usuario,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			nr_seq_lote,
			nr_seq_mat_hor,
			ie_prescrito,
			qt_dispensar,
			qt_total_dispensar,
			cd_material,
			cd_unidade_medida,
			ie_urgente)
		values (nextval('ap_lote_item_seq'),
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			nr_sequencia_w,
			nr_seq_mat_hor_w,
			'S',
			coalesce(qt_dispensar_hor_w,0),
			qt_dispensar_w,
			cd_material_w,
			cd_unidade_medida_w,
			ie_urgente_w);
		
		if	((ie_gerar_lote_apos_horario_w = 'S') or (dt_horario_w > clock_timestamp()) or (ie_origem_lote_p = 'AIP') or (ie_origem_lote_p = 'AIS')) then
			update	prescr_mat_hor
			set	nr_seq_lote	= nr_sequencia_w
			where	nr_sequencia	= nr_seq_mat_hor_w;

			/*if	((ie_origem_lote_p = 'AIP') or (ie_origem_lote_p = 'AIS')) and	
				(ie_gera_integracao_w = 'S') then
				disp_prescr_mat_hor(nr_prescricao_p, nr_seq_mat_hor_w, nm_usuario_p);
			end if;*/
		end if;
	end if;
	
	select	coalesce(max(qt_prioridade),999)
	into STRICT	qt_prioridade_hor_w
	from	classif_lote_disp_far
	where	nr_sequencia	= nr_seq_classif_w;
	
	if (qt_prioridade_hor_w <> qt_prioridade_w) and (qt_prioridade_hor_w < qt_prioridade_w) then
		update	ap_lote
		set	nr_seq_classif = nr_seq_classif_w
		where	nr_sequencia = nr_sequencia_w;
	end if;
	
	open C16;
	loop
	fetch C16 into	
		cd_material_ww,
		nr_seq_mat_hor_w,
		cd_unidade_medida_w,
		qt_dispensar_w,
		qt_dispensar_hor_w,
		nr_seq_turno_w,
		dt_horario_w,
		hr_hora_w,
		cd_estabelecimento_w,
		ie_urgente_w,
		nr_seq_classif_w,
		cd_local_estoque_w,
		nr_regra_local_disp_w;
		EXIT WHEN NOT FOUND; /* apply on C16 */
			begin

			select	coalesce(max(ie_gerar_ap_lote),'S'),coalesce(max(ie_send_info_to_integration), 'N')
			into STRICT	ie_gerar_ap_lote_w, ie_send_integration_w
			from	regra_local_dispensacao
			where	nr_sequencia = nr_regra_local_disp_w;

			if (ie_gerar_ap_lote_w = 'S') and (PKG_DATE_UTILS.start_of(dt_horario_w,'dd',0) = PKG_DATE_UTILS.start_of(dt_horario_ant_w,'dd',0)) then
				insert into ap_lote_item(
					nr_sequencia,
					dt_atualizacao,
					nm_usuario,
					dt_atualizacao_nrec,
					nm_usuario_nrec,
					nr_seq_lote,
					nr_seq_mat_hor,
					ie_prescrito,
					qt_dispensar,
					qt_total_dispensar,
					cd_material,
					cd_unidade_medida,
					ie_urgente)
				values (nextval('ap_lote_item_seq'),
					clock_timestamp(),
					nm_usuario_p,
					clock_timestamp(),
					nm_usuario_p,
					nr_sequencia_w,
					nr_seq_mat_hor_w,
					'S',
					coalesce(qt_dispensar_hor_w,0),
					qt_dispensar_w,
					cd_material_ww,
					cd_unidade_medida_w,
					ie_urgente_w);	

				if	((ie_gerar_lote_apos_horario_w = 'S') or (dt_horario_w > clock_timestamp()) or (ie_origem_lote_p = 'AIP') or (ie_origem_lote_p = 'AIS')) then
					update	prescr_mat_hor
					set	nr_seq_lote	= nr_sequencia_w
					where	nr_sequencia	= nr_seq_mat_hor_w;
					
					/*if	((ie_origem_lote_p = 'AIP') or (ie_origem_lote_p = 'AIS')) and	
						(ie_gera_integracao_w = 'S') then
						disp_prescr_mat_hor(nr_prescricao_p, nr_seq_mat_hor_w, nm_usuario_p);
					end if;*/
				end if;
				
				ie_gera_novo_lote_w := 'S';
			end if;
			end;
		end loop;
		close C16;
	end;
end loop;
close C15;
if (coalesce(wheb_usuario_pck.get_ie_commit, 'S') = 'S') then commit; end if;

select	Obter_se_setor_lote(cd_setor_atendimento)
into STRICT	ie_setor_lote_w
from	prescr_medica
where	nr_prescricao = nr_prescricao_p;

if (ie_setor_lote_w = 'S') then
	if (coalesce(ie_gera_lote_separado_w,'N') = 'S') then
		CALL gerar_mat_lote_separado(nr_prescricao_p, 0, 0, ie_so_aprazado_p, nm_usuario_p, ie_origem_lote_p);
	end if;

	if (ie_gerar_solucao_separado_w = 'S') then
		CALL gerar_lote_sep_solucao(nr_prescricao_p, 0, 0, 'N', nm_usuario_p, 'GPMH');
	end if;

	open c05;
	loop
	fetch c05 into
		nr_seq_lote_sep_w;
	EXIT WHEN NOT FOUND; /* apply on c05 */
		begin
		if (coalesce(nr_seq_regra_termo_w,0) > 0) and (coalesce(nr_seq_regra_termo_w,0) = coalesce(nr_seq_lote_sep_w,0)) then
			CALL gerar_lote_sep_termolabil(nr_prescricao_p, 0, 0, ie_so_aprazado_p, nm_usuario_p, ie_origem_lote_p);
		end if;
		
		if (coalesce(nr_seq_regra_ne_w,0) > 0) and (coalesce(nr_seq_regra_ne_w,0) = coalesce(nr_seq_lote_sep_w,0)) then
			CALL gerar_lote_sep_nutri_enteral(nr_prescricao_p,0,0,ie_so_aprazado_p,nm_usuario_p,ie_origem_lote_p);
		end if;
		
		if (coalesce(nr_seq_regra_recomend_w,0) > 0) and (coalesce(nr_seq_regra_recomend_w,0) = coalesce(nr_seq_lote_sep_w,0)) then
			CALL gerar_lote_sep_recomend(nr_prescricao_p, 0, 0, ie_so_aprazado_p, nm_usuario_p, ie_origem_lote_p);
		end if;
		
		if (coalesce(nr_seq_regra_controlado_w,0) > 0) and (coalesce(nr_seq_regra_controlado_w,0) = coalesce(nr_seq_lote_sep_w,0)) then
			CALL gerar_lote_sep_controlado(nr_prescricao_p, 0, 0, ie_so_aprazado_p, nm_usuario_p, ie_origem_lote_p);
		end if;
		end;
	end loop;
	close c05;
end if;

if (coalesce(wheb_usuario_pck.get_ie_commit, 'S') = 'S') then commit; end if;

open C03;
loop
fetch C03 into	
	cd_setor_atendimento_w,
	nr_seq_turno_w,
	nr_seq_classif_w,
	qt_min_antes_atend_w,
	qt_min_receb_setor_w,
	qt_min_entr_setor_w,
	qt_min_disp_farm_w,
	qt_min_atend_farm_w,
	qt_min_inicio_atend_w,
	ie_hora_antes_w;
EXIT WHEN NOT FOUND; /* apply on C03 */
	begin
	if (ie_hora_antes_w = 'H') then
		begin
		update	ap_lote
		set	dt_atend_lote		= round(dt_prim_horario - dividir(qt_min_antes_atend_w,1440),'mi'),
			dt_limite_inicio_atend	= round(dt_prim_horario - dividir(qt_min_inicio_atend_w,1440),'mi'),
			dt_limite_atend		= round(dt_prim_horario - dividir(qt_min_atend_farm_w,1440),'mi'),
			dt_limite_disp_farm	= round(dt_prim_horario - dividir(qt_min_disp_farm_w,1440),'mi'),
			dt_limite_entrega_setor	= round(dt_prim_horario - dividir(qt_min_entr_setor_w,1440),'mi'),
			dt_limite_receb_setor	= round(dt_prim_horario - dividir(qt_min_receb_setor_w,1440),'mi')
		where	nr_prescricao		= nr_prescricao_p
		and	((coalesce(cd_setor_atendimento_w::text, '') = '') or (cd_setor_atendimento_w = cd_setor_atendimento))
		and	((coalesce(nr_seq_turno_w::text, '') = '') or (nr_seq_turno_w = nr_seq_turno))
		and	((coalesce(nr_seq_classif_w::text, '') = '') or (nr_seq_classif_w = nr_seq_classif));
		end;
	elsif (ie_hora_antes_w = 'I') then
		begin
		update	ap_lote
		set	dt_atend_lote		= round(dt_inicio_turno - dividir(qt_min_antes_atend_w,1440),'mi'),
			dt_limite_inicio_atend	= round(dt_prim_horario - dividir(qt_min_inicio_atend_w,1440),'mi'),
			dt_limite_atend		= round(dt_prim_horario - dividir(qt_min_atend_farm_w,1440),'mi'),
			dt_limite_disp_farm	= round(dt_prim_horario - dividir(qt_min_disp_farm_w,1440),'mi'),
			dt_limite_entrega_setor	= round(dt_prim_horario - dividir(qt_min_entr_setor_w,1440),'mi'),
			dt_limite_receb_setor	= round(dt_prim_horario - dividir(qt_min_receb_setor_w,1440),'mi')
		where	nr_prescricao		= nr_prescricao_p
		and	((coalesce(cd_setor_atendimento_w::text, '') = '') or (cd_setor_atendimento_w = cd_setor_atendimento))
		and	((coalesce(nr_seq_turno_w::text, '') = '') or (nr_seq_turno_w = nr_seq_turno))
		and	((coalesce(nr_seq_classif_w::text, '') = '') or (nr_seq_classif_w = nr_seq_classif));
		end;
	elsif (ie_hora_antes_w = 'T') then
		begin
		update	ap_lote
		set	dt_atend_lote		= CASE WHEN to_char(round(dt_inicio_turno - dividir(qt_min_antes_atend_w,1440),'mi'), 'hh24:mi:ss')='00:00:00' THEN  --OS186690
			round(dt_inicio_turno - dividir(qt_min_antes_atend_w,1440),'mi') + 1/86400  ELSE round(dt_inicio_turno - dividir(qt_min_antes_atend_w,1440),'mi') END ,
			dt_limite_inicio_atend	= CASE WHEN to_char(round(dt_inicio_turno - dividir(qt_min_inicio_atend_w,1440),'mi'), 'hh24:mi:ss')='00:00:00' THEN			round(dt_inicio_turno - dividir(qt_min_inicio_atend_w,1440),'mi') + 1/86400  ELSE round(dt_inicio_turno - dividir(qt_min_inicio_atend_w,1440),'mi') END , 
			dt_limite_atend		= round(dt_inicio_turno - dividir(qt_min_atend_farm_w,1440),'mi'),
			dt_limite_disp_farm	= round(dt_inicio_turno - dividir(qt_min_disp_farm_w,1440),'mi'),
			dt_limite_entrega_setor	= round(dt_inicio_turno - dividir(qt_min_entr_setor_w,1440),'mi'),
			dt_limite_receb_setor	= round(dt_inicio_turno - dividir(qt_min_receb_setor_w,1440),'mi')
		where	nr_prescricao		= nr_prescricao_p
		and	((coalesce(cd_setor_atendimento_w::text, '') = '') or (cd_setor_atendimento_w = cd_setor_atendimento))
		and	((coalesce(nr_seq_turno_w::text, '') = '') or (nr_seq_turno_w = nr_seq_turno))
		and	((coalesce(nr_seq_classif_w::text, '') = '') or (nr_seq_classif_w = nr_seq_classif));
		end;
	end if;
	end;
end loop;
close C03;

select	max(cd_setor_atendimento)
into STRICT	cd_setor_atendimento_w
from	prescr_medica
where	nr_prescricao	= nr_prescricao_p;

begin
select	nr_sequencia
into STRICT	nr_seq_empresa_w
from	empresa_integracao
where	upper(nm_empresa) = 'SWISSLOG';

select	'S'
into STRICT	ie_existe_w
from	far_setores_integracao
where	nr_seq_empresa_int = nr_seq_empresa_w
and	cd_setor_atendimento = cd_setor_atendimento_w;
exception
when others then
	nr_seq_empresa_w := 0;
	ie_existe_w := 'N';
end;

if (ie_existe_w = 'S') then	
	select	coalesce(max(dt_prescricao),clock_timestamp())
	into STRICT 	dt_prescricao_w
	from	prescr_medica
	where	nr_prescricao = nr_prescricao_p;				
	ie_origem_lote_w := ie_origem_lote_p;
	if (ie_origem_lote_p in ('AIP','AIS','AGND')) then
		ie_origem_lote_w := ie_origem_lote_p || nr_seq_mat_hor_aip_ais_w;
	end if;
	ds_param_integ_hl7_w := 'nr_atendimento=' || nr_atendimento_w || obter_separador_bv ||
				'nr_prescricao=' || nr_prescricao_p || obter_separador_bv ||
				'ie_aprazado=' || ie_origem_lote_w || obter_separador_bv ||
				'ie_origem=' || 'GLAP' || obter_separador_bv || 
				'nr_seq_horario_p=' || null || obter_separador_bv;
	if (obter_se_envia_swisslog(434, nr_prescricao_p, 'GLAP', ie_origem_lote_w) = 'S') then
		CALL swisslog_gerar_integracao(434, ds_param_integ_hl7_w);		
		update	ap_lote
		set 	ie_integracao = 'W'
		where 	nr_prescricao = nr_prescricao_p;
	end if;

end if;

open C07;
loop
fetch C07 into	
	nr_seq_lote_w;
EXIT WHEN NOT FOUND; /* apply on C07 */
	begin
	
	select	max(cd_local_estoque)
	into STRICT	cd_local_estoque_w
	from 	ap_lote
	where 	nr_Sequencia = nr_seq_lote_w;
	
	reg_integracao_p.cd_estab_documento	:= cd_estabelecimento_w;
	reg_integracao_p.cd_local_estoque	:= cd_local_estoque_w;
	reg_integracao_p.cd_setor_atendimento	:= cd_setor_atendimento_w;
	reg_integracao_p.nr_seq_agrupador	:= nr_seq_lote_w;
	
	reg_integracao_p := gerar_int_padrao.gravar_integracao('260', nr_seq_lote_w, nm_usuario_p, reg_integracao_p);
	
	ds_param_bifrost_w := '{"batchCode" : ' || nr_seq_lote_w ||
						' , "personCode" : "' || cd_pessoa_fisica_w || '"' ||
						' , "encounterNumber" : ' || nr_atendimento_w ||'}';
	
	CALL execute_bifrost_integration(130,ds_param_bifrost_w);
	
	update	ap_lote
	set	ie_integracao = 'W'
	where nr_sequencia = nr_seq_lote_w;
	
	end;
end loop;
close C07;

select	count(*)
into STRICT	qt_existe_regra_w
from	dis_regra_setor
where	cd_setor_atendimento = cd_setor_atendimento_w;

if (qt_existe_regra_w > 0) then
	begin
	CALL intdisp_gerar_mat_hor(nr_prescricao_p,'1');
	end;
end if;

open C04;
loop
fetch C04 into	
	nr_sequencia_w;
EXIT WHEN NOT FOUND; /* apply on C04 */
	begin	
	select	obter_se_lote_rotina(nr_sequencia_w)
	into STRICT	ie_geracao_rotina_w
	;
	
	update	ap_lote
	set	ie_geracao_rotina = ie_geracao_rotina_w
	where	nr_sequencia = nr_sequencia_w;
	end;
end loop;
close C04;

exception
when others then
	ds_erro_w	:= substr(SQLERRM(SQLSTATE),1,2000);
	CALL gravar_log_tasy(5236, ds_erro_w, nm_usuario_p);
end;

if (coalesce(wheb_usuario_pck.get_ie_commit, 'S') = 'S') then commit; end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_lote_atend_prescr_desdob ( nr_prescricao_p bigint, nr_sequencia_p bigint, nr_seq_horario_p bigint, ie_so_aprazado_p text, nm_usuario_p text, ie_origem_lote_p text, nr_etapa_p bigint default 0) FROM PUBLIC;

