-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_copiar_sca_dependentes ( nr_seq_titular_p bigint, nr_seq_sca_vinculo_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) AS $body$
DECLARE

			
nr_seq_segurado_w	bigint;
nr_seq_plano_sca_w	bigint;
nr_seq_tabela_w		bigint;
ds_erro_w		varchar(255);
qt_sca_segurado_w	bigint;
nr_seq_contrato_w	bigint;
nr_seq_vinculo_sca_w	bigint;
			
C01 CURSOR FOR
	SELECT	nr_sequencia
	from	pls_segurado
	where	nr_seq_titular	= nr_seq_titular_p
	and 	(((coalesce(dt_rescisao::text, '') = '') and (coalesce(dt_cancelamento::text, '') = '')) or ((dt_rescisao IS NOT NULL AND dt_rescisao::text <> '') and (coalesce(dt_limite_utilizacao,dt_rescisao) >= clock_timestamp())));


BEGIN

open C01;
loop
fetch C01 into	
	nr_seq_segurado_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin	
	select	nr_seq_tabela,
		nr_seq_plano
	into STRICT	nr_seq_tabela_w,
		nr_seq_plano_sca_w
	from	pls_sca_vinculo
	where	nr_sequencia	= nr_seq_sca_vinculo_p;
	
	select	max(nr_seq_contrato)
	into STRICT	nr_seq_contrato_w
	from	pls_segurado
	where	nr_sequencia	= nr_seq_segurado_w;
	
	select	count(*)
	into STRICT	qt_sca_segurado_w
	from	pls_sca_vinculo
	where	nr_seq_segurado	= nr_seq_segurado_w
	and	nr_seq_plano	= nr_seq_plano_sca_w;

	if (qt_sca_segurado_w = 0) then		
		ds_erro_w := pls_consistir_plano_sca(nr_seq_segurado_w, nr_seq_plano_sca_w, nr_seq_tabela_w, null, cd_estabelecimento_p, ds_erro_w);
		
		if (coalesce(ds_erro_w::text, '') = '') then
			select	nextval('pls_sca_vinculo_seq')
			into STRICT	nr_seq_vinculo_sca_w
			;
			
			insert into pls_sca_vinculo(	nr_sequencia,dt_atualizacao,nm_usuario,dt_atualizacao_nrec,nm_usuario_nrec,
				nr_seq_segurado,nr_seq_plano,nr_seq_tabela,nr_seq_pagador,nr_seq_vendedor_canal,
				nr_seq_vendedor_pf,dt_inicio_vigencia,dt_reajuste,qt_idade_limite,dt_inclusao_benef,
				ie_dependente,ie_lancamento_mensalidade,ie_embutido_produto,ds_observacao,ie_geracao_valores)
			(SELECT	nr_seq_vinculo_sca_w,clock_timestamp(),nm_usuario_p,clock_timestamp(),nm_usuario_p,
				nr_seq_segurado_w,nr_seq_plano_sca_w,nr_seq_tabela_w,nr_seq_pagador,nr_seq_vendedor_canal,
				nr_seq_vendedor_pf,dt_inicio_vigencia,dt_reajuste,qt_idade_limite,dt_inclusao_benef,
				ie_dependente,ie_lancamento_mensalidade,'N','Copiada a SCA do titular para o dependente',ie_geracao_valores
			from	pls_sca_vinculo
			where	nr_sequencia	= nr_seq_sca_vinculo_p);
					
			CALL pls_duplicar_tabela_preco_sca(nr_seq_contrato_w,nr_seq_vinculo_sca_w,nr_seq_tabela_w,'N',nm_usuario_p);
			CALL pls_liberar_vinculo_sca(null, null, nr_seq_vinculo_sca_w, 'L', 'N', 'N', nm_usuario_p, cd_estabelecimento_p);
		end if;
	end if;	
	end;
end loop;
close C01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_copiar_sca_dependentes ( nr_seq_titular_p bigint, nr_seq_sca_vinculo_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) FROM PUBLIC;

