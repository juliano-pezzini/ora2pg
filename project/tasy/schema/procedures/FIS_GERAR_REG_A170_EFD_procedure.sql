-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE fis_gerar_reg_a170_efd ( nr_seq_controle_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint, dt_inicio_p timestamp, dt_fim_p timestamp, cd_empresa_p bigint, ds_separador_p text, nr_seq_superior_p bigint, qt_linha_p INOUT bigint, nr_sequencia_p INOUT bigint, vl_pis_nota_p INOUT bigint, vl_cofins_nota_p INOUT bigint, vl_base_pis_nota_p INOUT bigint, vl_base_cofins_nota_p INOUT bigint) AS $body$
DECLARE


nr_seq_regra_efd_w	bigint;
cd_tributo_pis_w	smallint;
cd_tributo_cofins_w	smallint;
cd_st_pis_w		varchar(15);
cd_st_cofins_w		varchar(15);
ie_tipo_nota_w		varchar(1);
nr_versao_efd_w		varchar(5);
tp_registro_w		varchar(4);
nr_linha_w		bigint 	:= qt_linha_p;
nr_seq_registro_w	bigint 	:= nr_sequencia_p;
ds_arquivo_w		varchar(4000);
ds_arquivo_compl_w	varchar(4000);
ds_linha_w		varchar(8000);
sep_w			varchar(1)	:= ds_separador_p;
nr_nota_fiscal_w	varchar(255);
ie_local_gerar_sped_w	varchar(1);

contador_w		bigint	:= 0;
vl_rateado_w		double precision	:= 0;
vl_item_w		double precision	:= 0;
vl_rateio_w		double precision	:= 0;
qt_itens_nota_w		bigint;
vl_descontos_w		double precision	:= 0;
nr_interno_conta_w	bigint;

vl_base_pis_w		double precision;
vl_base_cofins_w	double precision;
pr_aliquota_pis_w	double precision;
pr_aliquota_cofins_w	double precision;
vl_pis_w		double precision    := 0;
vl_cofins_w		double precision;
vl_pis_itens_w		double precision	:= 0;
vl_cofins_itens_w	double precision	:= 0;
nr_seq_protocolo_w	bigint;
nr_seq_lote_prot_w	bigint;
vl_pis_total_w		double precision	:= 0;
vl_cofins_total_w	double precision	:= 0;
vl_base_pis_total_w	double precision	:= 0;
vl_base_cofins_total_w	double precision	:= 0;

c01 CURSOR FOR
	SELECT	'A170' tp_registro,
		coalesce(b.nr_item_sequencial, b.nr_item_nf) nr_item_nf,
		coalesce(to_char(b.cd_material),'P' || b.cd_procedimento || coalesce(to_char(b.ie_origem_proced),'1')) cd_material,
		replace(replace(b.ds_complemento,chr(10),''),chr(13),'') ds_complemento,
		b.vl_total_item_nf,
		b.vl_desconto,
		'' ie_bc_credito,
		CASE WHEN substr(Obter_se_nota_entrada_saida(nr_seq_superior_p),1,1)='E' THEN  0  ELSE '' END  ie_origem_credito,
		CASE WHEN substr(Obter_se_nota_entrada_saida(nr_seq_superior_p),1,1)='E' THEN  coalesce(coalesce(c.ie_tributacao_pis,p.ie_tributacao_pis),'50')  ELSE coalesce(coalesce(c.ie_tributacao_pis_saida,p.ie_tributacao_pis),'01') END  cd_st_pis,
		substr(replace(campo_mascara_virgula_casas(b.vl_total_item_nf,2),'.',''),1,15) vl_base_pis,
		substr(replace(campo_mascara_virgula_casas((b.vl_total_item_nf * tax_efd_get_rate(cd_tributo_pis_w, a.cd_estabelecimento, a.nr_sequencia) / 100),2),'.',''),1,15) vl_pis,
		tax_efd_get_rate(cd_tributo_pis_w, a.cd_estabelecimento, a.nr_sequencia) pr_aliquota_pis,
		CASE WHEN substr(Obter_se_nota_entrada_saida(nr_seq_superior_p),1,1)='E' THEN  coalesce(coalesce(c.ie_tributacao_cofins,p.ie_tributacao_cofins),'50')  ELSE coalesce(coalesce(c.ie_tribut_cofins_saida,p.ie_tributacao_cofins),'01') END  cd_st_cofins,
		substr(replace(campo_mascara_virgula_casas(b.vl_total_item_nf,2),'.',''),1,15) vl_base_cofins,
		substr(replace(campo_mascara_virgula_casas((b.vl_total_item_nf * tax_efd_get_rate(cd_tributo_cofins_w, a.cd_estabelecimento, a.nr_sequencia) / 100),2),'.',''),1,15) vl_cofins,
		tax_efd_get_rate(cd_tributo_cofins_w, a.cd_estabelecimento, a.nr_sequencia) pr_aliquota_cofins,
		a.cd_cgc,
		a.cd_pessoa_fisica,
		coalesce(b.cd_conta_contabil, coalesce(c.cd_conta_contabil_efd, p.cd_conta_contabil_efd)) cd_conta_contabil
	FROM operacao_nota o, nota_fiscal a, nota_fiscal_item b
LEFT OUTER JOIN material_fiscal c ON (b.cd_material = c.cd_material)
LEFT OUTER JOIN procedimento_fiscal p ON (b.cd_procedimento = p.cd_procedimento AND b.ie_origem_proced = p.ie_origem_proced)
WHERE a.nr_sequencia		= b.nr_sequencia    and a.cd_operacao_nf	= o.cd_operacao_nf and o.ie_servico		= 'S' and b.vl_total_item_nf > 0 and a.cd_estabelecimento	= cd_estabelecimento_p and a.nr_sequencia		= nr_seq_superior_p order by
		b.nr_item_nf;

vet01	c01%rowtype;

c02 CURSOR FOR
	SELECT	tp_registro,
		cd_material,
		ds_complemento,
		vl_total_item_nf,
		vl_desconto,
		ie_bc_credito,
		ie_origem_credito,
		cd_st_pis,
		CASE WHEN cd_st_pis='04' THEN 0 WHEN cd_st_pis='06' THEN 0 WHEN cd_st_pis='49' THEN 0  ELSE vl_base_pis END  vl_base_pis,
		CASE WHEN cd_st_pis='04' THEN 0 WHEN cd_st_pis='06' THEN 0 WHEN cd_st_pis='49' THEN 0  ELSE pr_aliquota_pis END  pr_aliquota_pis,
		CASE WHEN cd_st_pis='04' THEN 0 WHEN cd_st_pis='06' THEN 0 WHEN cd_st_pis='49' THEN 0  ELSE vl_pis END  vl_pis,
		cd_st_cofins,
		CASE WHEN cd_st_pis='04' THEN 0 WHEN cd_st_pis='06' THEN 0 WHEN cd_st_pis='49' THEN 0  ELSE vl_base_cofins END  vl_base_cofins,
		CASE WHEN cd_st_pis='04' THEN 0 WHEN cd_st_pis='06' THEN 0 WHEN cd_st_pis='49' THEN 0  ELSE pr_aliquota_cofins END  pr_aliquota_cofins,
		CASE WHEN cd_st_pis='04' THEN 0 WHEN cd_st_pis='06' THEN 0 WHEN cd_st_pis='49' THEN 0  ELSE vl_cofins END  vl_cofins,
		coalesce(cd_conta_contabil, cd_conta_contabil_efd) cd_conta_contabil
	from	(SELECT	'A170' tp_registro,
			to_char(m.cd_material) cd_material,
			'' ds_complemento,
			sum(coalesce(b.vl_material,0)) vl_total_item_nf,
			0 vl_desconto,
			'' ie_bc_credito,
			'' ie_origem_credito,
			CASE WHEN substr(Obter_se_nota_entrada_saida(nr_seq_superior_p),1,1)='S' THEN  coalesce(to_char(coalesce(ie_tributacao_pis_saida,c.ie_tributacao_pis)),'01')  ELSE coalesce(to_char(coalesce(c.ie_tributacao_pis_saida,c.ie_tributacao_pis)),'50') END  cd_st_pis,
			sum(coalesce(b.vl_material,0)) vl_base_pis,
			tax_efd_get_rate(cd_tributo_pis_w, n.cd_estabelecimento, n.nr_sequencia) pr_aliquota_pis,
			round(((coalesce(sum(coalesce(b.vl_material,0)),0) * tax_efd_get_rate(cd_tributo_pis_w, n.cd_estabelecimento, n.nr_sequencia)) / 100),2) vl_pis,
			CASE WHEN substr(Obter_se_nota_entrada_saida(nr_seq_superior_p),1,1)='S' THEN  coalesce(to_char(coalesce(c.ie_tributacao_cofins,c.ie_tribut_cofins_saida)),'01')  ELSE coalesce(to_char(coalesce(c.ie_tribut_cofins_saida,c.ie_tributacao_cofins)),'50') END  cd_st_cofins,
			sum(coalesce(b.vl_material,0)) vl_base_cofins,
			tax_efd_get_rate(cd_tributo_cofins_w, n.cd_estabelecimento, n.nr_sequencia) pr_aliquota_cofins,
			round(((coalesce(sum(coalesce(b.vl_material,0)),0) * tax_efd_get_rate(cd_tributo_cofins_w, n.cd_estabelecimento, n.nr_sequencia)) / 100),2) vl_cofins,
			max(b.cd_conta_contabil) cd_conta_contabil,
			max(c.cd_conta_contabil_efd) cd_conta_contabil_efd
		FROM nota_fiscal n, conta_paciente_resumo b, conta_paciente a, material m
LEFT OUTER JOIN material_fiscal c ON (m.cd_material = c.cd_material)
WHERE b.nr_interno_conta = a.nr_interno_conta and n.nr_interno_conta = a.nr_interno_conta and b.cd_material = m.cd_material  --and	a.dt_mesano_referencia between dt_inicio_p and fim_dia(dt_fim_p)

		--and	m.cd_classif_fiscal is null
  and n.nr_sequencia = nr_seq_superior_p and coalesce(b.qt_exclusao_conta,0) = 0 GROUP BY
			m.cd_material,
			m.ds_material,
			c.ie_tributacao_cofins,
			c.ie_tributacao_pis,
			m.cd_classif_fiscal,
			c.ie_tributacao_pis_saida,
			c.ie_tribut_cofins_saida,
      n.cd_estabelecimento,
      n.nr_sequencia
		 HAVING	sum(coalesce(b.vl_material,0)) > 0
		
union all

		select	'A170' tp_registro,
			'P' || b.cd_procedimento || p.ie_origem_proced cd_material,
			'' ds_complemento,
			sum(coalesce(b.vl_procedimento,0)) vl_total_item_nf,
			0 vl_desconto,
			'' ie_bc_credito,
			'' ie_origem_credito,
			CASE WHEN substr(Obter_se_nota_entrada_saida(nr_seq_superior_p),1,1)='S' THEN  '01'  ELSE '50' END  cd_st_pis,
			sum(coalesce(b.vl_procedimento,0)) vl_base_pis,
			tax_efd_get_rate(cd_tributo_pis_w, n.cd_estabelecimento, n.nr_sequencia) pr_aliquota_pis,
			round(((sum(coalesce(vl_procedimento,0)) * tax_efd_get_rate(cd_tributo_pis_w, n.cd_estabelecimento, n.nr_sequencia)) / 100),2) vl_pis,
			CASE WHEN substr(Obter_se_nota_entrada_saida(nr_seq_superior_p),1,1)='S' THEN  '01'  ELSE '50' END  cd_st_cofins,
			sum(coalesce(b.vl_procedimento,0)) vl_base_cofins,
			tax_efd_get_rate(cd_tributo_cofins_w, n.cd_estabelecimento, n.nr_sequencia) pr_aliquota_cofins,
			round(((sum(coalesce(vl_procedimento,0)) * tax_efd_get_rate(cd_tributo_cofins_w, n.cd_estabelecimento, n.nr_sequencia)) / 100),2) vl_cofins,
			max(b.cd_conta_contabil)cd_conta_contabil,
			max(c.cd_conta_contabil_efd) cd_conta_contabil_efd
		FROM nota_fiscal n, conta_paciente_resumo b, conta_paciente a, procedimento p
LEFT OUTER JOIN procedimento_fiscal c ON (p.cd_procedimento = c.cd_procedimento AND p.ie_origem_proced = c.ie_origem_proced)
WHERE b.nr_interno_conta = a.nr_interno_conta and n.nr_interno_conta = a.nr_interno_conta and b.cd_procedimento = p.cd_procedimento and b.ie_origem_proced = p.ie_origem_proced   --and	a.dt_mesano_referencia between dt_inicio_p and fim_dia(dt_fim_p)
  and n.nr_sequencia = nr_seq_superior_p and coalesce(b.qt_exclusao_conta,0) = 0 GROUP BY
			b.cd_procedimento,
			p.ie_origem_proced,
      n.cd_estabelecimento, 
      n.nr_sequencia
		 HAVING	sum(coalesce(b.vl_procedimento,0)) > 0
		
union all

		select	'A170' tp_registro,
			to_char(m.cd_material) cd_material,
			'' ds_complemento,
			sum(coalesce(b.vl_material,0)) vl_total_item_nf,
			0 vl_desconto,
			'' ie_bc_credito,
			'' ie_origem_credito,
			CASE WHEN substr(Obter_se_nota_entrada_saida(nr_seq_superior_p),1,1)='S' THEN  coalesce(to_char(coalesce(c.ie_tributacao_pis_saida,c.ie_tributacao_pis)),'01')  ELSE coalesce(to_char(coalesce(c.ie_tributacao_pis_saida,c.ie_tributacao_pis)),'50') END  cd_st_pis,
			sum(coalesce(b.vl_material,0)) vl_base_pis,
			tax_efd_get_rate(cd_tributo_pis_w, n.cd_estabelecimento, n.nr_sequencia) pr_aliquota_pis,
			round(((coalesce(sum(coalesce(b.vl_material,0)),0) * tax_efd_get_rate(cd_tributo_pis_w, n.cd_estabelecimento, n.nr_sequencia)) / 100),2) vl_pis,
			CASE WHEN substr(Obter_se_nota_entrada_saida(nr_seq_superior_p),1,1)='S' THEN  coalesce(to_char(coalesce(c.ie_tribut_cofins_saida,c.ie_tributacao_cofins)),'01')  ELSE coalesce(to_char(coalesce(c.ie_tribut_cofins_saida,c.ie_tributacao_cofins)),'50') END  cd_st_cofins,
			sum(coalesce(b.vl_material,0)) vl_base_cofins,
			tax_efd_get_rate(cd_tributo_cofins_w, n.cd_estabelecimento, n.nr_sequencia) pr_aliquota_cofins,
			round(((coalesce(sum(coalesce(b.vl_material,0)),0) * tax_efd_get_rate(cd_tributo_cofins_w, n.cd_estabelecimento, n.nr_sequencia)) / 100),2) vl_cofins,
			max(b.cd_conta_contabil)cd_conta_contabil,
			max(c.cd_conta_contabil_efd) cd_conta_contabil_efd
		FROM nota_fiscal n, conta_paciente_resumo b, conta_paciente a, material m
LEFT OUTER JOIN material_fiscal c ON (m.cd_material = c.cd_material)
WHERE b.nr_interno_conta = a.nr_interno_conta and n.nr_seq_protocolo = a.nr_seq_protocolo and b.cd_material = m.cd_material  --and	a.dt_mesano_referencia between dt_inicio_p and fim_dia(dt_fim_p)

		--and	m.cd_classif_fiscal is null
  and n.nr_sequencia = nr_seq_superior_p and coalesce(b.qt_exclusao_conta,0) = 0 GROUP BY
			m.cd_material,
			m.ds_material,
			c.ie_tributacao_cofins,
			c.ie_tributacao_pis,
			m.cd_classif_fiscal,
			c.ie_tributacao_pis_saida,
			c.ie_tribut_cofins_saida,
      n.cd_estabelecimento, 
      n.nr_sequencia
		 HAVING	sum(coalesce(b.vl_material,0)) > 0
		
union all

		select	'A170' tp_registro,
			'P' || b.cd_procedimento || p.ie_origem_proced cd_material,
			'' ds_complemento,
			sum(coalesce(b.vl_procedimento,0)) vl_total_item_nf,
			0 vl_desconto,
			'' ie_bc_credito,
			'' ie_origem_credito,
			CASE WHEN substr(Obter_se_nota_entrada_saida(nr_seq_superior_p),1,1)='S' THEN  '01'  ELSE '50' END  cd_st_pis,
			sum(coalesce(b.vl_procedimento,0)) vl_base_pis,
			tax_efd_get_rate(cd_tributo_pis_w, n.cd_estabelecimento, n.nr_sequencia) pr_aliquota_pis,
			round(((sum(coalesce(vl_procedimento,0)) * tax_efd_get_rate(cd_tributo_pis_w, n.cd_estabelecimento, n.nr_sequencia)) / 100),2) vl_pis,
			CASE WHEN substr(Obter_se_nota_entrada_saida(nr_seq_superior_p),1,1)='S' THEN  '01'  ELSE '50' END  cd_st_cofins,
			sum(coalesce(b.vl_procedimento,0)) vl_base_cofins,
			tax_efd_get_rate(cd_tributo_cofins_w, n.cd_estabelecimento, n.nr_sequencia) pr_aliquota_cofins,
			round(((sum(coalesce(vl_procedimento,0)) * tax_efd_get_rate(cd_tributo_cofins_w, n.cd_estabelecimento, n.nr_sequencia)) / 100),2) vl_cofins,
			max(b.cd_conta_contabil)cd_conta_contabil,
			max(c.cd_conta_contabil_efd) cd_conta_contabil_efd
		FROM nota_fiscal n, conta_paciente_resumo b, conta_paciente a, procedimento p
LEFT OUTER JOIN procedimento_fiscal c ON (p.cd_procedimento = c.cd_procedimento AND p.ie_origem_proced = c.ie_origem_proced)
WHERE b.nr_interno_conta = a.nr_interno_conta and n.nr_seq_protocolo = a.nr_seq_protocolo and b.cd_procedimento = p.cd_procedimento and b.ie_origem_proced = p.ie_origem_proced   --and	a.dt_mesano_referencia between dt_inicio_p and fim_dia(dt_fim_p)
  and n.nr_sequencia = nr_seq_superior_p and coalesce(b.qt_exclusao_conta,0) = 0 GROUP BY
			b.cd_procedimento,
			p.ie_origem_proced,
      n.cd_estabelecimento, 
      n.nr_sequencia
		 HAVING	sum(coalesce(b.vl_procedimento,0)) > 0
		
union all

		select	'A170' tp_registro,
			to_char(m.cd_material) cd_material,
			'' ds_complemento,
			sum(coalesce(b.vl_material,0)) vl_total_item_nf,
			0 vl_desconto,
			'' ie_bc_credito,
			'' ie_origem_credito,
			CASE WHEN substr(Obter_se_nota_entrada_saida(nr_seq_superior_p),1,1)='S' THEN  coalesce(to_char(coalesce(c.ie_tributacao_pis_saida,c.ie_tributacao_pis)),'01')  ELSE coalesce(to_char(c.ie_tributacao_pis_saida),'50') END  cd_st_pis,
			sum(coalesce(b.vl_material,0)) vl_base_pis,
			tax_efd_get_rate(cd_tributo_pis_w, n.cd_estabelecimento, n.nr_sequencia) pr_aliquota_pis,
			round(((coalesce(sum(coalesce(b.vl_material,0)),0) * tax_efd_get_rate(cd_tributo_pis_w, n.cd_estabelecimento, n.nr_sequencia)) / 100),2) vl_pis,
			CASE WHEN substr(Obter_se_nota_entrada_saida(nr_seq_superior_p),1,1)='S' THEN  coalesce(to_char(coalesce(c.ie_tribut_cofins_saida,c.ie_tributacao_cofins)),'01')  ELSE coalesce(to_char(c.ie_tribut_cofins_saida),'50') END  cd_st_cofins,
			sum(coalesce(b.vl_material,0)) vl_base_cofins,
			tax_efd_get_rate(cd_tributo_cofins_w, n.cd_estabelecimento, n.nr_sequencia) pr_aliquota_cofins,
			round(((coalesce(sum(coalesce(b.vl_material,0)),0) * tax_efd_get_rate(cd_tributo_cofins_w, n.cd_estabelecimento, n.nr_sequencia)) / 100),2) vl_cofins,
			max(b.cd_conta_contabil)cd_conta_contabil,
			max(c.cd_conta_contabil_efd) cd_conta_contabil_efd
		FROM protocolo_convenio p, nota_fiscal n, conta_paciente_resumo b, conta_paciente a, material m
LEFT OUTER JOIN material_fiscal c ON (m.cd_material = c.cd_material)
WHERE b.nr_interno_conta = a.nr_interno_conta and n.nr_seq_lote_prot = p.nr_seq_lote_protocolo and p.nr_seq_protocolo = a.nr_seq_protocolo and b.cd_material = m.cd_material  --and	a.dt_mesano_referencia between dt_inicio_p and fim_dia(dt_fim_p)

		--and	m.cd_classif_fiscal is null
  and n.nr_sequencia = nr_seq_superior_p and coalesce(b.qt_exclusao_conta,0) = 0 GROUP BY
			m.cd_material,
			m.ds_material,
			c.ie_tributacao_cofins,
			c.ie_tributacao_pis,
			m.cd_classif_fiscal,
			c.ie_tributacao_pis_saida,
			c.ie_tribut_cofins_saida,
      n.cd_estabelecimento, 
      n.nr_sequencia
		 HAVING	sum(coalesce(b.vl_material,0)) > 0
		
union all

		select	'A170' tp_registro,
			'P' || b.cd_procedimento || p.ie_origem_proced cd_material,
			'' ds_complemento,
			sum(coalesce(b.vl_procedimento,0)) vl_total_item_nf,
			0 vl_desconto,
			'' ie_bc_credito,
			'' ie_origem_credito,
			CASE WHEN substr(Obter_se_nota_entrada_saida(nr_seq_superior_p),1,1)='S' THEN  '01'  ELSE '50' END  cd_st_pis,
			sum(coalesce(b.vl_procedimento,0)) vl_base_pis,
			tax_efd_get_rate(cd_tributo_pis_w, n.cd_estabelecimento, n.nr_sequencia) pr_aliquota_pis,
			round(((sum(coalesce(vl_procedimento,0)) * tax_efd_get_rate(cd_tributo_pis_w, n.cd_estabelecimento, n.nr_sequencia)) / 100),2) vl_pis,
			CASE WHEN substr(Obter_se_nota_entrada_saida(nr_seq_superior_p),1,1)='S' THEN  '01'  ELSE '50' END  cd_st_cofins,
			sum(coalesce(b.vl_procedimento,0)) vl_base_cofins,
			tax_efd_get_rate(cd_tributo_cofins_w, n.cd_estabelecimento, n.nr_sequencia) pr_aliquota_cofins,
			round(((sum(coalesce(vl_procedimento,0)) * tax_efd_get_rate(cd_tributo_cofins_w, n.cd_estabelecimento, n.nr_sequencia)) / 100),2) vl_cofins,
			max(b.cd_conta_contabil) cd_conta_contabil,
			max(d.cd_conta_contabil_efd) cd_conta_contabil_efd
		FROM nota_fiscal n, protocolo_convenio c, conta_paciente_resumo b, conta_paciente a, procedimento p
LEFT OUTER JOIN procedimento_fiscal d ON (p.cd_procedimento = d.cd_procedimento AND p.ie_origem_proced = d.ie_origem_proced)
WHERE b.nr_interno_conta = a.nr_interno_conta and n.nr_seq_lote_prot = c.nr_seq_lote_protocolo and c.nr_seq_protocolo = a.nr_seq_protocolo and b.cd_procedimento = p.cd_procedimento and b.ie_origem_proced = p.ie_origem_proced   --and	a.dt_mesano_referencia between dt_inicio_p and fim_dia(dt_fim_p)
  and n.nr_sequencia = nr_seq_superior_p and coalesce(b.qt_exclusao_conta,0) = 0 GROUP BY
			b.cd_procedimento,
			p.ie_origem_proced,
      n.cd_estabelecimento, 
      n.nr_sequencia HAVING	sum(coalesce(b.vl_procedimento,0)) > 0
		) alias218
	order by
		pr_aliquota_pis,
		vl_cofins,
		vl_pis;
	
vet02	c02%rowtype;


BEGIN
select	nr_seq_regra_efd
into STRICT	nr_seq_regra_efd_w
from	fis_efd_controle
where	nr_sequencia	= nr_seq_controle_p;

select 	cd_tributo_pis,
	cd_tributo_cofins
into STRICT	cd_tributo_pis_w,
	cd_tributo_cofins_w
from	fis_regra_efd
where	nr_sequencia	= nr_seq_regra_efd_w;

select	coalesce(nr_interno_conta,0),
	coalesce(nr_seq_protocolo,0),
	coalesce(nr_seq_lote_prot,0)
into STRICT	nr_interno_conta_w,
	nr_seq_protocolo_w,
	nr_seq_lote_prot_w
from	nota_fiscal
where	nr_sequencia	= nr_seq_superior_p;

select	coalesce(vl_descontos,0)
into STRICT	vl_descontos_w
from	nota_fiscal
where	nr_sequencia	= nr_seq_superior_p;

select	count(1)
into STRICT	qt_itens_nota_w
from	nota_fiscal_item
where	nr_sequencia	= nr_seq_superior_p  LIMIT 1;

if (vl_descontos_w = 0) then
	vl_rateio_w	:= 0;
else
	vl_rateio_w	:= vl_descontos_w / qt_itens_nota_w;
end if;

ie_local_gerar_sped_w := obter_param_usuario(5500, 25, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_local_gerar_sped_w);

if	((ie_local_gerar_sped_w = 'N') or
	((nr_interno_conta_w = 0) and (nr_seq_protocolo_w = 0) and (nr_seq_lote_prot_w = 0))) then
	open c01;
	loop
	fetch c01 into	
		vet01;
	EXIT WHEN NOT FOUND; /* apply on c01 */
		begin	
		contador_w := contador_w + 1;
		select	substr(Obter_se_nota_entrada_saida(nr_seq_superior_p),1,1)
		into STRICT	ie_tipo_nota_w
		;
		
		if (vet01.vl_total_item_nf > vl_rateio_w) then
			vl_item_w := vet01.vl_total_item_nf - vl_rateio_w;
			vl_rateado_w := vl_rateado_w + vl_rateio_w;
		end if;
		
		if (contador_w = qt_itens_nota_w) then
			if (vl_rateado_w < vl_descontos_w) then
				vl_item_w	:= vl_item_w - (vl_descontos_w - vl_rateado_w);
			elsif (vl_rateado_w > vl_descontos_w) then
				vl_item_w	:= vl_item_w - (vl_rateado_w - vl_descontos_w);
			end if;
		end if;

		if (vet01.cd_st_pis = '06') or (vet01.cd_st_pis = '98') or (vet01.cd_st_pis = '49') then
			vl_base_pis_w 		:= 0;
			pr_aliquota_pis_w 	:= 0;
			vl_pis_w		:= 0;
		else
			vl_base_pis_w 		:= vl_item_w;
			pr_aliquota_pis_w 	:= vet01.pr_aliquota_pis;
			vl_pis_w		:= round((vl_item_w * obter_pr_imposto(cd_tributo_pis_w)/100)::numeric,2);
		end if;

		if (vet01.cd_st_cofins = '06') or (vet01.cd_st_cofins = '98') or (vet01.cd_st_cofins = '49') then
			vl_base_cofins_w 	:= 0;
			pr_aliquota_cofins_w 	:= 0;
			vl_cofins_w		:= 0;
		else
			vl_base_cofins_w 	:= vl_item_w;
			pr_aliquota_cofins_w 	:= vet01.pr_aliquota_cofins;
			vl_cofins_w		:= round((vl_item_w * obter_pr_imposto(cd_tributo_cofins_w)/100)::numeric,2);

		end if;
		
		ds_linha_w	:= substr(	sep_w || vet01.tp_registro							||
						sep_w || substr(contador_w,1,4)							||
						sep_w || substr(vet01.cd_material,1,60)						||
						sep_w || vet01.ds_complemento							||
						sep_w || substr(sped_formatar_numericos(vl_item_w,2,','),1,17)			||
						sep_w || substr(sped_formatar_numericos(vet01.vl_desconto,2,','),1, 17)		||
						sep_w || substr(vet01.ie_bc_credito,1,2)					||
						sep_w || substr(vet01.ie_origem_credito,1,1)					||
						sep_w || substr(vet01.cd_st_pis,1,2)						||
						sep_w || substr(sped_formatar_numericos(vl_base_pis_w,2,','),1,17)		||
						sep_w || substr(sped_formatar_numericos(coalesce(pr_aliquota_pis_w,0),2,','),1,17)		||
						sep_w || substr(sped_formatar_numericos(coalesce(vl_pis_w,0),2,','),1,17)			||
						sep_w || substr(vet01.cd_st_cofins,1,2)						||
						sep_w || substr(sped_formatar_numericos(vl_base_cofins_w,2,','),1,17)		||
						sep_w || substr(sped_formatar_numericos(coalesce(pr_aliquota_cofins_w,0),2,','),1,17)	||
						sep_w || substr(sped_formatar_numericos(coalesce(vl_cofins_w,0),2,','),1,17)		||
						sep_w || vet01.cd_conta_contabil						||
						sep_w || ''									||
						sep_w,1,8000);
		
		if (vet01.cd_st_pis = '04') then
			insert into w_sped_efd_m400(vl_item,
				ie_tributacao_cst)
			values (replace(campo_mascara(vl_base_pis_w,2),'.',','),
				'04');
		end if;
		
		ds_arquivo_w		:= substr(ds_linha_w,1,4000);
		ds_arquivo_compl_w	:= substr(ds_linha_w,4001,4000);
		nr_seq_registro_w	:= nr_seq_registro_w + 1;
		nr_linha_w		:= nr_linha_w + 1;
		
		vl_pis_total_w		:= vl_pis_total_w + vl_pis_w;
		vl_cofins_total_w	:= vl_cofins_total_w + vl_cofins_w;
		vl_base_pis_total_w	:= vl_base_pis_total_w + vl_base_pis_w;
		vl_base_cofins_total_w	:= vl_base_cofins_total_w + vl_base_cofins_w;
		
		insert into fis_efd_0900(	nr_sequencia,
									dt_atualizacao,
									nm_usuario,
									dt_atualizacao_nrec,
									nm_usuario_nrec,
									nr_seq_controle,
									ds_registro,
									cd_cst,
									cd_ind_oper,
									vl_registro )
						values ( 	nextval('fis_efd_0900_seq'),
									clock_timestamp(),
									nm_usuario_p,
									clock_timestamp(),
									nm_usuario_p,
									nr_seq_controle_p,
									'A170',
									vet01.cd_st_cofins,
									0,
									vl_item_w );
		
		insert into fis_efd_arquivo(nr_sequencia,
			nm_usuario,
			dt_atualizacao,
			nm_usuario_nrec,
			dt_atualizacao_nrec,
			nr_seq_controle_efd,
			nr_linha,
			cd_registro,
			ds_arquivo,
			ds_arquivo_compl)
		values (nr_seq_registro_w,
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			nr_seq_controle_p,
			nr_linha_w,
			vet01.tp_registro,
			ds_arquivo_w,
			ds_arquivo_compl_w);
		end;
	end loop;
	close c01;
end if;

if (ie_local_gerar_sped_w = 'C') or
	(((nr_interno_conta_w <> 0) or (nr_seq_protocolo_w <> 0) or (nr_seq_lote_prot_w <> 0)) and (ie_local_gerar_sped_w = 'A')) then
	select	nr_nota_fiscal
	into STRICT	nr_nota_fiscal_w
	from	nota_fiscal
	where	nr_sequencia	= nr_seq_superior_p;

	open c02;
	loop
	fetch c02 into	
		vet02;
	EXIT WHEN NOT FOUND; /* apply on c02 */
		begin	
		contador_w := contador_w + 1;
		
		select	substr(Obter_se_nota_entrada_saida(nr_seq_superior_p),1,1)
		into STRICT	ie_tipo_nota_w
		;
		
		ds_linha_w	:= substr(	sep_w || vet02.tp_registro							||
						sep_w || substr(contador_w,1,4)							||
						sep_w || substr(vet02.cd_material,1,60)						||
						sep_w || vet02.ds_complemento							||
						sep_w || substr(sped_formatar_numericos(vet02.vl_total_item_nf,2,','),1,17)	||
						sep_w || substr(sped_formatar_numericos(vet02.vl_desconto,2,','),1, 17)		||
						sep_w || substr(vet02.ie_bc_credito,1,2)					||
						sep_w || substr(vet02.ie_origem_credito,1,1)					||
						sep_w || substr(vet02.cd_st_pis,1,2)						||
						sep_w || substr(sped_formatar_numericos(vet02.vl_base_pis,2,','),1,17)		||
						sep_w || substr(sped_formatar_numericos(coalesce(vet02.pr_aliquota_pis,0),2,','),1,17)	||
						sep_w || substr(sped_formatar_numericos(coalesce(vet02.vl_pis,0),2,','),1,17)	||
						sep_w || substr(vet02.cd_st_cofins,1,2)						||
						sep_w || substr(sped_formatar_numericos(vet02.vl_base_cofins,2,','),1,17)	||
						sep_w || substr(sped_formatar_numericos(coalesce(vet02.pr_aliquota_cofins,0),2,','),1,17)	||
						sep_w || substr(sped_formatar_numericos(coalesce(vet02.vl_cofins,0),2,','),1,17)		||
						sep_w || vet02.cd_conta_contabil						||
						sep_w || ''									||
						sep_w,1,8000);
		
		if (vet02.cd_st_pis = '04') then
			insert into w_sped_efd_m400(vl_item,
				ie_tributacao_cst)
			values (substr(sped_formatar_numericos(vet02.vl_base_pis,2,','),1,17),
				'04');
		end if;		
		
		ds_arquivo_w		:= substr(ds_linha_w,1,4000);
		ds_arquivo_compl_w	:= substr(ds_linha_w,4001,4000);
		nr_seq_registro_w	:= nr_seq_registro_w + 1;
		nr_linha_w		:= nr_linha_w + 1;

		vl_pis_total_w		:= vl_pis_total_w + substr(sped_formatar_numericos(vet02.vl_pis,2,','),1,17);
		vl_cofins_total_w	:= vl_cofins_total_w + substr(sped_formatar_numericos(vet02.vl_cofins,2,','),1,17);
		vl_base_pis_total_w	:= vl_base_pis_total_w + substr(sped_formatar_numericos(vet02.vl_base_pis,2,','),1,17);
		vl_base_cofins_total_w	:= vl_base_cofins_total_w + substr(sped_formatar_numericos(vet02.vl_base_cofins,2,','),1,17);
		
		insert into fis_efd_0900(	nr_sequencia,
									dt_atualizacao,
									nm_usuario,
									dt_atualizacao_nrec,
									nm_usuario_nrec,
									nr_seq_controle,
									ds_registro,
									cd_cst,
									cd_ind_oper,
									vl_registro )
						values ( 	nextval('fis_efd_0900_seq'),
									clock_timestamp(),
									nm_usuario_p,
									clock_timestamp(),
									nm_usuario_p,
									nr_seq_controle_p,
									'A170',
									vet02.cd_st_cofins,
									0,
									vet02.vl_total_item_nf );
		
		insert into fis_efd_arquivo(nr_sequencia,
			nm_usuario,
			dt_atualizacao,
			nm_usuario_nrec,
			dt_atualizacao_nrec,
			nr_seq_controle_efd,
			nr_linha,
			cd_registro,
			ds_arquivo,
			ds_arquivo_compl)
		values (nr_seq_registro_w,
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			nr_seq_controle_p,
			nr_linha_w,
			vet02.tp_registro,
			ds_arquivo_w,
			ds_arquivo_compl_w);
		
		end;
	end loop;
	close c02;
end if;


commit;

qt_linha_p		:= nr_linha_w;
nr_sequencia_p		:= nr_seq_registro_w;
vl_pis_nota_p		:= vl_pis_total_w;
vl_cofins_nota_p	:= vl_cofins_total_w;
vl_base_pis_nota_p	:= vl_base_pis_total_w;
vl_base_cofins_nota_p	:= vl_base_cofins_total_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE fis_gerar_reg_a170_efd ( nr_seq_controle_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint, dt_inicio_p timestamp, dt_fim_p timestamp, cd_empresa_p bigint, ds_separador_p text, nr_seq_superior_p bigint, qt_linha_p INOUT bigint, nr_sequencia_p INOUT bigint, vl_pis_nota_p INOUT bigint, vl_cofins_nota_p INOUT bigint, vl_base_pis_nota_p INOUT bigint, vl_base_cofins_nota_p INOUT bigint) FROM PUBLIC;

