-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';



CREATE TYPE registro_titular AS (nr_seq_titular_ww bigint, ie_linha_ww bigint);


CREATE OR REPLACE PROCEDURE pls_gerar_cartao_sbc ( nr_seq_lote_p bigint, nr_seq_segurado_p bigint, nm_usuario_p text) AS $body$
DECLARE

			
			
nr_seq_segurado_w		bigint;
ie_linha_reg_w			bigint;
nr_vetor_w			bigint;
nr_sequencial_w			bigint;
ds_estipulante_w		varchar(255);
ds_plano_w			varchar(255);
nm_titular_w			varchar(255);
nm_beneficiario_w		varchar(255);
dt_adesao_w			varchar(255);
dt_validade_w			varchar(255);
dt_nascimento_w			varchar(255);
ds_carencia_mensagem_w		varchar(255);
ds_trilha_1_w			varchar(255);
ds_trilha_2_w			varchar(255);
cd_usuario_plano_w		varchar(255);
ds_carencia_w			varchar(4000);
nr_seq_plano_w			bigint;
nr_seq_titular_w		bigint;
dt_cpt_w			varchar(255);
nr_cartao_nac_sus_w 		pessoa_fisica.nr_cartao_nac_sus%type;
type vetor is table of registro_titular index by integer;
vetor_w				vetor;

C01 CURSOR FOR
	SELECT	CASE WHEN coalesce(nr_seq_titular::text, '') = '' THEN nr_seq_segurado  ELSE nr_seq_titular END ,
		row_number() OVER () AS rownum
	from	pls_carteira_emissao_corresp_v
	where	nr_seq_lote	= nr_seq_lote_p;
	
C02 CURSOR FOR
	SELECT	b.nr_sequencia
	from	pls_segurado_carteira	a,
		pls_segurado		b,
		pls_carteira_emissao	c,
		pls_lote_carteira	d
	where	a.nr_seq_segurado	= b.nr_sequencia
	and	c.nr_seq_seg_carteira	= a.nr_sequencia
	and	c.nr_seq_lote		= d.nr_sequencia
	and	((d.nr_sequencia		= nr_seq_lote_p and (nr_seq_lote_p IS NOT NULL AND nr_seq_lote_p::text <> '')) or (b.nr_sequencia		= nr_seq_segurado_p and (nr_seq_segurado_p IS NOT NULL AND nr_seq_segurado_p::text <> '')));

BEGIN

open C01;
loop
fetch C01 into	
	nr_seq_segurado_w,
	ie_linha_reg_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	
	nr_vetor_w	:= vetor_w.count+1;
	vetor_w[nr_vetor_w].nr_seq_titular_ww	:= nr_seq_segurado_w;
	vetor_w[nr_vetor_w].ie_linha_ww		:= ie_linha_reg_w;
	
	end;
end loop;
close C01;

delete	FROM w_pls_interface_carteira
where	((nr_seq_lote	= nr_seq_lote_p) or (nr_seq_segurado = nr_seq_segurado_p));

open C02;
loop
fetch C02 into	
	nr_seq_segurado_w;
EXIT WHEN NOT FOUND; /* apply on C02 */
	begin
	
	
	SELECT	wheb_mensagem_pck.get_texto(1105947)||': '||substr(obter_nome_pf_pj(b.cd_pf_estipulante,cd_cgc_estipulante),1,250),
		wheb_mensagem_pck.get_texto(1105948)||': '||c.ds_plano||' - '||wheb_mensagem_pck.get_texto(1105949)||' - '||CASE WHEN c.Ie_acomodacao='I' THEN 'Individual' WHEN c.Ie_acomodacao='C' THEN 'Coletivo'  ELSE 'Nenhum' END  ds_plano,
		wheb_mensagem_pck.get_texto(1105950)||': '||e.cd_usuario_plano ds_cartao_ident_cod,
		wheb_mensagem_pck.get_texto(1105951)||': ' ||UPPER(d.nm_pessoa_fisica) nm_segurado,
		wheb_mensagem_pck.get_texto(1105952)||': '|| TO_CHAR(a.dt_contratacao, 'dd/mm/yyyy') ds_contratacao,
		wheb_mensagem_pck.get_texto(1105953)||': '||SUBSTR(TO_CHAR(e.dt_validade_carteira,'month'),1,3)||'/'||TO_CHAR(e.dt_validade_carteira,'yyyy') dt_validade_carteira,
		wheb_mensagem_pck.get_texto(1105958)||': Vide Contrato' ,
		wheb_mensagem_pck.get_texto(1105959)||': '||TO_CHAR(d.dt_nascimento,'dd/mm/yyyy') dt_nascimento,
		'0000'||a.cd_pessoa_fisica barras,		
		e.cd_usuario_plano ds_cartao_ident_bar,
		c.nr_sequencia,
		CASE WHEN coalesce(a.nr_seq_titular::text, '') = '' THEN a.nr_sequencia  ELSE a.nr_seq_titular END ,
		d.nr_cartao_nac_sus
	into STRICT	ds_estipulante_w,
		ds_plano_w,
		cd_usuario_plano_w,
		nm_beneficiario_w,
		dt_adesao_w,
		dt_validade_w,
		ds_carencia_mensagem_w,
		dt_nascimento_w,
		ds_trilha_1_w,
		ds_trilha_2_w,
		nr_seq_plano_w,
		nr_seq_titular_w,
		nr_cartao_nac_sus_w
	FROM	pls_segurado		a,
		pls_contrato		b,
		pls_plano		c,
		pessoa_fisica		d,
		pls_segurado_carteira 	e
	WHERE	a.cd_pessoa_fisica	= d.cd_pessoa_fisica
	AND	a.nr_seq_plano		= c.nr_sequencia
	aND	a.nr_seq_contrato	= b.nr_sequencia
	AND	e.nr_seq_segurado	= a.nr_sequencia
	AND	a.nr_sequencia		= nr_seq_segurado_w;
	
	ds_carencia_w	:= '';
	dt_cpt_w	:= pls_obter_dados_cart_unimed(nr_seq_segurado_w,nr_seq_plano_w,'CPTSBC',0);
	
	nm_titular_w	:= wheb_mensagem_pck.get_texto(1105960)||': '|| substr(pls_obter_dados_segurado(nr_seq_titular_w,'N'),1,255);
	
	for i in 1..vetor_w.count loop
		if (vetor_w[i].nr_seq_titular_ww = nr_seq_titular_w) then
			nr_sequencial_w	:= vetor_w[i].ie_linha_ww;
			exit;
		end if;
	end loop;
	
	insert into w_pls_interface_carteira(	nr_sequencia,dt_atualizacao,nm_usuario,dt_atualizacao_nrec,nm_usuario_nrec,
			nr_seq_lote,nr_seq_segurado,ds_estipulante,nm_plano,cd_usuario_plano,
			nm_beneficiario,dt_adesao,dt_validade_carteira,dt_nascimento,ds_mensagem_carencia,
			ds_trilha_1,ds_trilha_2,ds_carencia,dt_cpt,nm_titular,nr_seq_titular_interno, ds_cns)
	values (	nextval('w_pls_interface_carteira_seq'),clock_timestamp(),nm_usuario_p,clock_timestamp(),nm_usuario_p,
			nr_seq_lote_p,nr_seq_segurado_w,ds_estipulante_w,ds_plano_w,cd_usuario_plano_w,
			nm_beneficiario_w,dt_adesao_w,dt_validade_w,dt_nascimento_w,ds_carencia_mensagem_w,
			ds_trilha_1_w,ds_trilha_2_w,ds_carencia_w,dt_cpt_w,nm_titular_w,nr_sequencial_w, nr_cartao_nac_sus_w);
	end;
end loop;
close C02;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_gerar_cartao_sbc ( nr_seq_lote_p bigint, nr_seq_segurado_p bigint, nm_usuario_p text) FROM PUBLIC;

