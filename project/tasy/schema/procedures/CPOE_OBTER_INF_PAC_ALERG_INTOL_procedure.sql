-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE cpoe_obter_inf_pac_alerg_intol ( cd_pessoa_fisica_p pessoa_fisica.cd_pessoa_fisica%type, cd_material_p material.cd_material%type, cd_perfil_p perfil.cd_perfil%type, cd_setor_atendimento_p setor_atendimento.cd_setor_atendimento%type, nr_atendimento_p atendimento_paciente.nr_atendimento%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, ie_classificacao_p paciente_alergia.ie_classificacao%type, ie_alergico_p out text, ds_mensagem_p out text, ie_severidade_p out paciente_alergia.ie_intensidade%type, nr_seq_reacao_p out paciente_alergia.nr_seq_reacao%type, ie_consiste_just_p out text, ie_consiste_bloq_p out text, ie_existe_regra_ativa_p out text, nr_seq_ficha_tecnica_p out paciente_alergia.nr_seq_ficha_tecnica%type) is ie_exibir_w varchar(1) AS $body$
BEGIN
	return;
end;

begin

SELECT * FROM cpoe_verifica_se_pac_alergico(cd_pessoa_fisica_p, cd_material_p, ie_alergico_w, ds_mensagem_w, ie_severidade_w, nr_seq_reacao_w, ie_classificacao_p, nr_seq_ficha_tecnica_w) INTO STRICT ie_alergico_w, ds_mensagem_w, ie_severidade_w, nr_seq_reacao_w, nr_seq_ficha_tecnica_w;

ie_exibir_w := 'N';
ie_consiste_just_w := 'N';
ie_consiste_bloq_w := 'N';
ie_existe_regra_ativa_w := 'N';
ie_severidade_regra_exibe_w := 'D';
ie_severidade_regra_just_w := 'D';
ie_severidade_regra_bloq_w := 'D';

ie_alergico_w := coalesce(ie_alergico_w, 'N');

if (ie_alergico_w = 'S') then

	if (coalesce(ie_classificacao_p, 'A') = 'A') then
		ds_tabela_regra_w := 'cpoe_regra_alergia';

	elsif (coalesce(ie_classificacao_p, 'A') = 'I') then
		ds_tabela_regra_w := 'cpoe_regra_intolerancia';
	end if;

	EXECUTE obter_sql_severidade(ds_tabela_regra_w)
	into STRICT	ie_severidade_regra_exibe_w,
			ie_severidade_regra_just_w,
			ie_severidade_regra_bloq_w,
			ie_existe_regra_ativa_w
	using	IN cd_perfil_p,
			IN cd_perfil_p,
			IN cd_setor_atendimento_p,
			IN cd_setor_atendimento_p,
			IN nr_atendimento_p,
			IN cd_estabelecimento_p,
			IN cd_estabelecimento_p;

	-- IE_SEVERIDADE_EXIBE
	if (ie_severidade_regra_exibe_w = 'D') then
		ie_exibir_w := 'S';

	elsif (ie_severidade_regra_exibe_w = ie_severidade_w) then
		ie_exibir_w := 'S';

	elsif ((ie_severidade_regra_exibe_w = 'L') and (ie_severidade_w in ('M', 'I'))) then
		ie_exibir_w := 'S';

	elsif (ie_severidade_regra_exibe_w = 'M' AND ie_severidade_w = 'I') then
		ie_exibir_w := 'S';
	end if;

	if (ie_exibir_w = 'S') then

		-- IE_SEVERIDADE_JUST
		if (ie_severidade_regra_just_w = 'D') then
			ie_consiste_just_w := 'S';

		elsif (ie_severidade_regra_just_w = ie_severidade_w) then
			ie_consiste_just_w := 'S';

		elsif ((ie_severidade_regra_just_w = 'L') and (ie_severidade_w in ('M', 'I'))) then
			ie_consiste_just_w := 'S';

		elsif (ie_severidade_regra_just_w = 'M' AND ie_severidade_w = 'I') then
			ie_consiste_just_w := 'S';
		end if;

		-- IE_SEVERIDADE_BLOQ
		if (ie_severidade_regra_bloq_w = 'D') then
			ie_consiste_bloq_w := 'N';

		elsif (ie_severidade_regra_bloq_w = ie_severidade_w) then
			ie_consiste_bloq_w := 'S';

		elsif ((ie_severidade_regra_bloq_w = 'L') and (ie_severidade_w in ('M', 'I'))) then
			ie_consiste_bloq_w := 'S';

		elsif (ie_severidade_regra_bloq_w = 'M' AND ie_severidade_w = 'I') then
			ie_consiste_bloq_w := 'S';
		end if;
	else
		ie_alergico_w := 'N';
	end if;
end if;

ie_alergico_p := ie_alergico_w;
ds_mensagem_p := ds_mensagem_w;
ie_severidade_p := ie_severidade_w;
nr_seq_reacao_p := nr_seq_reacao_w;
ie_consiste_just_p := ie_consiste_just_w;
ie_consiste_bloq_p := ie_consiste_bloq_w;
ie_existe_regra_ativa_p := ie_existe_regra_ativa_w;
nr_seq_ficha_tecnica_p := nr_seq_ficha_tecnica_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cpoe_obter_inf_pac_alerg_intol ( cd_pessoa_fisica_p pessoa_fisica.cd_pessoa_fisica%type, cd_material_p material.cd_material%type, cd_perfil_p perfil.cd_perfil%type, cd_setor_atendimento_p setor_atendimento.cd_setor_atendimento%type, nr_atendimento_p atendimento_paciente.nr_atendimento%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, ie_classificacao_p paciente_alergia.ie_classificacao%type, ie_alergico_p out text, ds_mensagem_p out text, ie_severidade_p out paciente_alergia.ie_intensidade%type, nr_seq_reacao_p out paciente_alergia.nr_seq_reacao%type, ie_consiste_just_p out text, ie_consiste_bloq_p out text, ie_existe_regra_ativa_p out text, nr_seq_ficha_tecnica_p out paciente_alergia.nr_seq_ficha_tecnica%type) is ie_exibir_w varchar(1) FROM PUBLIC;

