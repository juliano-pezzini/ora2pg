-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pre_agendar_cirurgia_js ( cd_agenda_p bigint, hr_inicio_p timestamp, cd_pessoa_fisica_p text, cd_medico_p text, nr_seq_proc_interno_p bigint, cd_convenio_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint, ds_orientacao_p text, ie_lado_p text, qt_tempo_proc_p bigint, nm_paciente_p text, ds_erro_p INOUT text, ie_carater_p text, nr_seq_atend_futuro_p bigint default null, nr_atendimento_p bigint default 0) AS $body$
DECLARE


ds_w			varchar(4000) := '';
ds_orientacoes_w	varchar(4000);
cd_w			integer;
ds_erro_w		varchar(255) := '';
ds_erro_2_w		varchar(255) := '';
nr_sequencia_w		bigint;
nr_sequencia_ww		bigint;
nr_seq_rtf_srtring_w	bigint;


c01 CURSOR FOR
SELECT  1,
	coalesce(ds_orientacao,' ') ds_orientacao,
	0 nr_sequencia
from    orientacao_cirurgia
where   nr_sequencia         =  (select   max(nr_sequencia)
				from     orientacao_cirurgia)

union

select	2,
	coalesce(ds_orientacao_usuario,' ') ds_orientacao,
	0 nr_sequencia
from	proc_interno
where	nr_sequencia		   =	nr_seq_proc_interno_p

union

select	3,
	coalesce(ds_orientacao,' ') ds_orientacao,
	0 nr_sequencia
from	proc_interno_conv_orient
where	nr_seq_proc_interno	=	nr_seq_proc_interno_p
and	coalesce(cd_convenio::text, '') = ''

union

select	4,
	coalesce(ds_orientacao,' ') ds_orientacao,
	0 nr_sequencia
from	proc_interno_conv_orient
where	nr_seq_proc_interno	=	nr_seq_proc_interno_p
and	cd_convenio 		   =	cd_convenio_p

union

select	5,
	' ' ds_orientacao,
	nr_sequencia
from	convenio_doc_atend
where	cd_convenio		      =	cd_convenio_p
and	ie_documento		   =	'CIR';


BEGIN

ds_erro_p := '';

open C01;
loop
fetch C01 into
	cd_w,
	ds_w,
	nr_sequencia_ww;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	if (cd_w = 5) then
		nr_seq_rtf_srtring_w := converte_rtf_string('	select	ds_documento
					from	convenio_doc_atend
					where	nr_sequencia = :nr_sequencia_p', nr_sequencia_ww, nm_usuario_p, nr_seq_rtf_srtring_w);
		select	substr(ds_texto_clob,4000,1)
		into STRICT	ds_w
		from	tasy_conversao_rtf
		where	nr_sequencia = nr_seq_rtf_srtring_w;
	end if;

	ds_orientacoes_w := ds_orientacoes_w || ds_w ||chr(10);

	end;
end loop;
close C01;

if (ds_orientacoes_w = '') then
	ds_orientacoes_w := wheb_mensagem_pck.get_texto(278084);
end if;

SELECT * FROM pre_agendar_cirurgia(cd_agenda_p, hr_inicio_p, cd_pessoa_fisica_p, cd_medico_p, nr_seq_proc_interno_p, cd_convenio_p, nm_usuario_p, cd_estabelecimento_p, ds_orientacoes_w, ie_lado_p, qt_tempo_proc_p, ds_erro_w, nr_sequencia_w, nm_paciente_p, ie_carater_p, ds_erro_2_w, nr_seq_atend_futuro_p, nr_atendimento_p, null, null) INTO STRICT ds_erro_w, nr_sequencia_w, ds_erro_2_w;

if (coalesce(nr_sequencia_w,0) > 0) then
	CALL gerar_dados_proc_adic(nr_sequencia_w, nm_usuario_p, cd_estabelecimento_p);
end if;

ds_erro_p := ds_erro_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pre_agendar_cirurgia_js ( cd_agenda_p bigint, hr_inicio_p timestamp, cd_pessoa_fisica_p text, cd_medico_p text, nr_seq_proc_interno_p bigint, cd_convenio_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint, ds_orientacao_p text, ie_lado_p text, qt_tempo_proc_p bigint, nm_paciente_p text, ds_erro_p INOUT text, ie_carater_p text, nr_seq_atend_futuro_p bigint default null, nr_atendimento_p bigint default 0) FROM PUBLIC;

