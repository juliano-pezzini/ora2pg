-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_escala_mews_mentor (nr_seq_sinal_vital_p bigint, nr_seq_pend_pac_acao_p bigint, nm_usuario_p text) AS $body$
DECLARE


qt_freq_cardiaca_p	    atendimento_sinal_vital.QT_FREQ_CARDIACA%type;
qt_freq_resp_p	        atendimento_sinal_vital.QT_FREQ_RESP%type;
qt_pa_sistolica_p	    atendimento_sinal_vital.QT_PA_SISTOLICA%type;
qt_temp_p               atendimento_sinal_vital.QT_TEMP%type;
nr_atendimento_w        atendimento_sinal_vital.NR_ATENDIMENTO%type;
qt_nivel_con_w          atendimento_sinal_vital.IE_NIVEL_CONSCIENCIA%type;
cd_profissional_w       ESCALA_MEWS.CD_PROFISSIONAL%type;
nr_sequencia_w          ESCALA_MEWS.NR_SEQUENCIA%type;
nr_regras_atendidas_w   varchar(255);


BEGIN

if (coalesce(nr_seq_sinal_vital_p,0) > 0) then

    select coalesce(max(QT_FREQ_CARDIACA),0),
           coalesce(max(QT_FREQ_RESP),0),
           coalesce(max(QT_PA_SISTOLICA),0),
           coalesce(max(QT_TEMP),0),
           coalesce(max(IE_NIVEL_CONSCIENCIA),0),
           coalesce(max(cd_pessoa_fisica),0),
           max(nr_atendimento)
    into STRICT   qt_freq_cardiaca_p,
           qt_freq_resp_p,
           qt_pa_sistolica_p,
           qt_temp_p,
           qt_nivel_con_w,
           cd_profissional_w,
           nr_atendimento_w
    from ATENDIMENTO_SINAL_VITAL
    where nr_sequencia = nr_seq_sinal_vital_p;

    if ((qt_freq_cardiaca_p > 0 or
        qt_freq_resp_p > 0 or
        qt_pa_sistolica_p > 0 or
        qt_temp_p > 0 or
        qt_nivel_con_w > 0) and ((cd_profissional_w IS NOT NULL AND cd_profissional_w::text <> '') and cd_profissional_w > 0) and
        (nr_atendimento_w IS NOT NULL AND nr_atendimento_w::text <> '')) then

        select nextval('escala_mews_seq')
		into STRICT  nr_sequencia_w
;

        insert into ESCALA_MEWS(DT_AVALIACAO,
                                 CD_PROFISSIONAL,
                                 DT_ATUALIZACAO,
                                 NR_SEQUENCIA,
                                 NM_USUARIO,
                                 IE_SITUACAO,
                                 NR_ATENDIMENTO,
                                 DT_ATUALIZACAO_NREC,
                                 NM_USUARIO_NREC,
                                 QT_TEMP,
                                 DT_LIBERACAO,
                                 QT_FREQ_RESP,
                                 QT_FREQ_CARDIACA,
                                 QT_PA_SISTOLICA,
                                 IE_NIVEL_CONSCIENCIA,
                                 NR_SEQ_SINAL_VITAL,
                                 NR_SEQ_PEND_PAC_ACAO)
                         values (clock_timestamp(),
                                 cd_profissional_w,
                                 clock_timestamp(),
                                 nr_sequencia_w,
                                 nm_usuario_p,
                                 'A',
                                 nr_atendimento_w,
                                 clock_timestamp(),
                                 nm_usuario_p,
                                 qt_temp_p,
                                 clock_timestamp(),
                                 qt_freq_resp_p,
                                 qt_freq_cardiaca_p,
                                 qt_pa_sistolica_p,
                                 qt_nivel_con_w,
                                 nr_seq_sinal_vital_p,
                                 nr_seq_pend_pac_acao_p);


		update GQA_PEND_PAC_ACAO_DEST
		set	   dt_encerramento = clock_timestamp()
		where  nr_seq_pend_pac_acao = nr_seq_pend_pac_acao_p;

		update  GQA_PEND_PAC_ACAO
		set	   dt_encerramento = clock_timestamp()
		where  nr_sequencia = nr_seq_pend_pac_acao_p;


    end if;

commit;

end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_escala_mews_mentor (nr_seq_sinal_vital_p bigint, nr_seq_pend_pac_acao_p bigint, nm_usuario_p text) FROM PUBLIC;

