-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE obter_dados_ativ_intermitente ( nr_seq_graf_atual_p bigint, dt_value_X_p text, ds_agente_P INOUT text, ds_dosagem_p INOUT text, ie_fim_administracao_P INOUT text, qt_dose_p INOUT bigint, ds_observacao_p INOUT text, dt_inicio_intermit_p INOUT text, dt_inicio_intermit_date_p INOUT timestamp, dt_value_x_date_p timestamp default null) AS $body$
DECLARE


ds_agente_w		varchar(60);
ds_dosagem_w		varchar(255);
ie_fim_administracao_w	varchar(2);
qt_dose_w		double precision;
ds_observacao_w		varchar(255);
dt_inicio_intermit_w	timestamp;
dt_value_w				timestamp;


BEGIN
if (dt_value_x_date_p IS NOT NULL AND dt_value_x_date_p::text <> '') then
	dt_value_w	:= dt_value_x_date_p;
else
	dt_value_w	:= to_date(dt_value_X_p, 'dd/mm/yyyy hh24:mi:ss');
end if;

select	obter_desc_agente(max(nr_seq_agente)) ds_agente,
	obter_desc_dosagem_agente(max(nr_sequencia), 2) ds_dosagem,
	obter_se_fim_administracao(max(nr_sequencia)) ie_fim_administracao
into STRICT	ds_agente_w,
	ds_dosagem_w,
	ie_fim_administracao_w
from	cirurgia_agente_anestesico
where	nr_sequencia = nr_seq_graf_atual_p
and	coalesce(ie_situacao,'A') = 'A';

select	coalesce(max(qt_dose),0) qt_dose,
	max(ds_observacao) ds_observacao,
	coalesce(max(dt_inicio_adm), dt_value_w)  dt_inicio_intermit
into STRICT	qt_dose_w,
	ds_observacao_w,
	dt_inicio_intermit_w
from	cirurgia_agente_anest_ocor
where	coalesce(dt_final_adm::text, '') = ''
and	coalesce(ie_situacao,'A') = 'A'
and	nr_seq_cirur_agente = nr_seq_graf_atual_p;

ds_agente_p		:= ds_agente_w;
ds_dosagem_p		:= ds_dosagem_w;
ie_fim_administracao_p	:= ie_fim_administracao_w;
qt_dose_p		:= qt_dose_w;
ds_observacao_p		:= ds_observacao_w;

if (coalesce(dt_value_x_date_p::text, '') = '') then
   dt_inicio_intermit_p	:= to_char(dt_inicio_intermit_w,'dd/mm/yyyy hh24:mi:ss');
end if;

dt_inicio_intermit_date_p  := dt_inicio_intermit_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE obter_dados_ativ_intermitente ( nr_seq_graf_atual_p bigint, dt_value_X_p text, ds_agente_P INOUT text, ds_dosagem_p INOUT text, ie_fim_administracao_P INOUT text, qt_dose_p INOUT bigint, ds_observacao_p INOUT text, dt_inicio_intermit_p INOUT text, dt_inicio_intermit_date_p INOUT timestamp, dt_value_x_date_p timestamp default null) FROM PUBLIC;

