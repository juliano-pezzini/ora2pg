-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE obter_edicao_proc_conv (cd_estabelecimento_p bigint, cd_convenio_p bigint, cd_categoria_p text, dt_conta_p timestamp, cd_procedimento_p bigint, cd_edicao_amb_p INOUT bigint, VL_CH_HONORARIOS_p INOUT bigint, VL_CH_CUSTO_OPER_p INOUT bigint, VL_M2_FILME_p INOUT bigint, dt_vigencia_p INOUT timestamp, tx_ajuste_geral_p INOUT bigint, nr_seq_cbhpm_edicao_p INOUT bigint, ie_origem_proced_p bigint default null) AS $body$
DECLARE


VL_CH_HONORARIOS_W		double precision;
VL_CH_CUSTO_OPER_W		double precision;
VL_M2_FILME_W			double precision;
dt_vigencia_w			timestamp;
dt_final_vigencia_w		timestamp;
cd_edicao_amb_w			integer;
ie_origem_proced_w		bigint;
ie_origem_proced_edicao_w	bigint;
qt_preco_w			bigint	:= 0;
TX_AJUSTE_GERAL_w		double precision;
IE_DATA_VIG_CBHPM_w		varchar(01);
ie_prioridade_w			bigint;
IE_REGRA_PRIOR_EDICAO_w		varchar(03)	:= 'DT';
nr_seq_cbhpm_edicao_w		bigint	:= null;
IE_PRIOR_EDICAO_CBHPM_w		varchar(01)	:= 'N';
ie_calculo_tuss_w		varchar(10);
ie_consiste_ult_edicao_amb_w	parametro_faturamento.ie_consiste_ult_edicao_amb%type :='N';
ie_tipo_convenio_w		convenio.ie_tipo_convenio%type;

c01 CURSOR FOR
	SELECT 	x.ie_prioridade,
		x.CD_EDICAO_AMB,
       		CASE WHEN coalesce(x.VL_CH_HONORARIOS::text, '') = '' THEN 1 WHEN x.VL_CH_HONORARIOS=0 THEN 1  ELSE x.VL_CH_HONORARIOS END ,
	       	CASE WHEN coalesce(x.VL_CH_CUSTO_OPER::text, '') = '' THEN 1 WHEN x.VL_CH_CUSTO_OPER=0 THEN 1  ELSE x.VL_CH_CUSTO_OPER END ,
       		coalesce(x.VL_FILME,0),
		x.dt_inicio_vigencia,
		x.dt_final_vigencia,
		coalesce(x.TX_AJUSTE_GERAL, 1),
		null
	FROM	edicao_amb y, CONVENIO_AMB x
	WHERE (x.CD_ESTABELECIMENTO     = CD_ESTABELECIMENTO_P)
	AND (x.CD_CONVENIO            = CD_CONVENIO_P)
	AND (x.CD_CATEGORIA           = coalesce(CD_CATEGORIA_P,CD_CATEGORIA))
	and (x.cd_edicao_amb	  = y.cd_edicao_amb)
	and	((IE_DATA_VIG_CBHPM_w 	= 'N') or (y.ie_origem_proced <> 5))
	AND (coalesce(x.IE_SITUACAO,'A')	= 'A')
	and	IE_REGRA_PRIOR_EDICAO_w	= 'DT'
	AND 	(x.DT_INICIO_VIGENCIA     =
      		(SELECT MAX(DT_INICIO_VIGENCIA)
	       	FROM 	CONVENIO_AMB A
	       	WHERE (A.CD_ESTABELECIMENTO  = CD_ESTABELECIMENTO_P)
	        AND (A.CD_CONVENIO         = CD_CONVENIO_P)
	        AND (A.CD_CATEGORIA        = coalesce(CD_CATEGORIA_P,CD_CATEGORIA))
		AND (coalesce(A.IE_SITUACAO,'A')= 'A')
	        AND (A.DT_INICIO_VIGENCIA <=  DT_CONTA_P)))
	
union

	SELECT 	x.ie_prioridade,
		x.CD_EDICAO_AMB,
       		CASE WHEN coalesce(x.VL_CH_HONORARIOS::text, '') = '' THEN 1 WHEN x.VL_CH_HONORARIOS=0 THEN 1  ELSE x.VL_CH_HONORARIOS END ,
	       	CASE WHEN coalesce(x.VL_CH_CUSTO_OPER::text, '') = '' THEN 1 WHEN x.VL_CH_CUSTO_OPER=0 THEN 1  ELSE x.VL_CH_CUSTO_OPER END ,
       		coalesce(x.VL_FILME,0),
		x.dt_inicio_vigencia,
		x.dt_final_vigencia,
		coalesce(x.TX_AJUSTE_GERAL, 1),
		null
	FROM	edicao_amb y, CONVENIO_AMB x
	WHERE (x.CD_ESTABELECIMENTO     = CD_ESTABELECIMENTO_P)
	AND (x.CD_CONVENIO            = CD_CONVENIO_P)
	AND (x.CD_CATEGORIA           = coalesce(CD_CATEGORIA_P,CD_CATEGORIA))
	and (x.cd_edicao_amb	  = y.cd_edicao_amb)
	and	((IE_DATA_VIG_CBHPM_w 	= 'N') or (y.ie_origem_proced <> 5))
	AND (coalesce(x.IE_SITUACAO,'A')	= 'A')
	and	IE_REGRA_PRIOR_EDICAO_w	= 'PR'
	
union

	SELECT 	x.ie_prioridade,
		x.CD_EDICAO_AMB,
       		CASE WHEN coalesce(x.VL_CH_HONORARIOS::text, '') = '' THEN 1 WHEN x.VL_CH_HONORARIOS=0 THEN 1  ELSE x.VL_CH_HONORARIOS END ,
	       	CASE WHEN coalesce(x.VL_CH_CUSTO_OPER::text, '') = '' THEN 1 WHEN x.VL_CH_CUSTO_OPER=0 THEN 1  ELSE x.VL_CH_CUSTO_OPER END ,
       		coalesce(x.VL_FILME,0),
		x.dt_inicio_vigencia,
		x.dt_final_vigencia,
		coalesce(x.TX_AJUSTE_GERAL, 1),
		x.nr_seq_cbhpm_edicao
	FROM	edicao_amb y, CONVENIO_AMB x
	WHERE (x.CD_ESTABELECIMENTO     = CD_ESTABELECIMENTO_P)
	AND (x.CD_CONVENIO            = CD_CONVENIO_P)
	AND (x.CD_CATEGORIA           = coalesce(CD_CATEGORIA_P,CD_CATEGORIA))
	and (x.cd_edicao_amb	  = y.cd_edicao_amb)
	and (IE_DATA_VIG_CBHPM_w	  = 'S')
	and (y.ie_origem_proced 	  = 5)
	AND (coalesce(x.IE_SITUACAO,'A')	  = 'A')
	and (coalesce(IE_PRIOR_EDICAO_CBHPM_w,'N') <> 'R')
	AND 	(x.DT_INICIO_VIGENCIA     =
      		(SELECT min(DT_INICIO_VIGENCIA)
	       	FROM 	edicao_amb z, CONVENIO_AMB A
	       	WHERE (A.CD_ESTABELECIMENTO  = CD_ESTABELECIMENTO_P)
	        AND (A.CD_CONVENIO         = CD_CONVENIO_P)
	        AND (A.CD_CATEGORIA        = coalesce(CD_CATEGORIA_P,CD_CATEGORIA))
		and	z.cd_edicao_amb		= a.cd_edicao_amb
		and	z.ie_origem_proced	= 5
		AND (coalesce(A.IE_SITUACAO,'A')= 'A')
		AND (PKG_DATE_UTILS.start_of(DT_CONTA_P,'dd',0) between A.DT_INICIO_VIGENCIA and coalesce(a.dt_final_vigencia, dt_conta_p))))
	
union all

	SELECT 	x.ie_prioridade,
		x.CD_EDICAO_AMB,
       		CASE WHEN coalesce(x.VL_CH_HONORARIOS::text, '') = '' THEN 1 WHEN x.VL_CH_HONORARIOS=0 THEN 1  ELSE x.VL_CH_HONORARIOS END ,
	       	CASE WHEN coalesce(x.VL_CH_CUSTO_OPER::text, '') = '' THEN 1 WHEN x.VL_CH_CUSTO_OPER=0 THEN 1  ELSE x.VL_CH_CUSTO_OPER END ,
       		coalesce(x.VL_FILME,0),
		x.dt_inicio_vigencia,
		x.dt_final_vigencia,
		coalesce(x.TX_AJUSTE_GERAL, 1),
		x.nr_seq_cbhpm_edicao
	FROM	edicao_amb y, CONVENIO_AMB x
	WHERE (x.CD_ESTABELECIMENTO     = CD_ESTABELECIMENTO_P)
	AND (x.CD_CONVENIO            = CD_CONVENIO_P)
	AND (x.CD_CATEGORIA           = coalesce(CD_CATEGORIA_P,CD_CATEGORIA))
	and (x.cd_edicao_amb	  = y.cd_edicao_amb)
	and (IE_DATA_VIG_CBHPM_w	  = 'S')
	and (y.ie_origem_proced 	  = 5)
	AND (coalesce(x.IE_SITUACAO,'A')	  = 'A')
	and (coalesce(IE_PRIOR_EDICAO_CBHPM_w,'N') = 'R')	
	order by 1, 6;


BEGIN

select	coalesce(max(IE_DATA_VIG_CBHPM), 'N'),
		coalesce(max(IE_PRIOR_EDICAO_CBHPM),'N'),
		coalesce(max(ie_consiste_ult_edicao_amb),'N')
into STRICT	IE_DATA_VIG_CBHPM_w,
		IE_PRIOR_EDICAO_CBHPM_w,
		ie_consiste_ult_edicao_amb_w
from	parametro_faturamento
where	cd_estabelecimento	= cd_estabelecimento_p;

select	coalesce(max(IE_REGRA_PRIOR_EDICAO), 'DT')
into STRICT	IE_REGRA_PRIOR_EDICAO_w
from	convenio_estabelecimento
where	cd_estabelecimento 	= CD_ESTABELECIMENTO_P
and	cd_convenio		= cd_convenio_p;

if (ie_data_vig_cbhpm_w	= 'R') then
	
	select	coalesce(max(ie_data_vig_cbhpm), 'N')
	into STRICT	ie_data_vig_cbhpm_w
	from	convenio_estabelecimento
	where	cd_convenio		= cd_convenio_p
	and	cd_estabelecimento 	= cd_estabelecimento_p;

end if;

open	c01;
loop
fetch	c01 into
	ie_prioridade_w,
	CD_EDICAO_AMB_W,
       	VL_CH_HONORARIOS_W,
       	VL_CH_CUSTO_OPER_W,
       	VL_M2_FILME_W,
	dt_vigencia_w,
	dt_final_vigencia_w,
	TX_AJUSTE_GERAL_w,
	nr_seq_cbhpm_edicao_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	begin

	if (qt_preco_w = 0) and
		((coalesce(dt_final_vigencia_w::text, '') = '') or (PKG_DATE_UTILS.start_of(dt_conta_p,'dd',0) <= dt_final_vigencia_w)) then
		begin

		ie_calculo_tuss_w:= 'S';
				
		begin

		select	max(ie_tipo_convenio)
		into STRICT	ie_tipo_convenio_w
		from 	convenio
		where 	cd_convenio = cd_convenio_p;

		SELECT	MAX(ie_origem_proced),
			coalesce(max(ie_calculo_tuss),'S')
		INTO STRICT	ie_origem_proced_edicao_w,
			ie_calculo_tuss_w
		FROM	edicao_amb
		WHERE	cd_edicao_amb	= cd_edicao_amb_w;
		exception
			when others then
			ie_calculo_tuss_w:= 'S';
		end;
		
		if	(ie_calculo_tuss_w <> 'S' AND ie_origem_proced_edicao_w = 8) then
			ie_origem_proced_w	:= 8;
		elsif (cd_edicao_amb_w	= 2004) or (ie_origem_proced_edicao_w = 5) then
			ie_origem_proced_w	:= 5;
		elsif (ie_origem_proced_edicao_w = 6) then
			ie_origem_proced_w	:= 6;
		else
			/*select	nvl(min(b.ie_origem_proced),1)
			into	ie_origem_proced_w
			from	procedimento	a,
				preco_amb	b
			where	a.cd_procedimento	= cd_procedimento_p
			and 	a.cd_procedimento	= b.cd_procedimento
			and 	b.cd_edicao_amb		= cd_edicao_amb_w;*/

			-- Melhoria identificada ao fazer o Profiler durante a verificacao da OS 324150
			select	coalesce(min(b.ie_origem_proced),1)
			into STRICT	ie_origem_proced_w
			from	preco_amb	b
			where	b.cd_procedimento	= cd_procedimento_p
			and 	b.cd_edicao_amb		= cd_edicao_amb_w;
			
			if (ie_origem_proced_w	<> ie_origem_proced_edicao_w) then
				ie_origem_proced_w	:= ie_origem_proced_edicao_w;
			end if;			
			
		end if;

		if (ie_origem_proced_w = 5) then
			if	((coalesce(IE_PRIOR_EDICAO_CBHPM_w,'N') = 'S') and (IE_DATA_VIG_CBHPM_w = 'N') and (IE_REGRA_PRIOR_EDICAO_w = 'PR')) then
				
				select	count(*)
				into STRICT	qt_preco_w
				from	cbhpm_preco
				where	cd_procedimento		= cd_procedimento_p
				and	ie_origem_proced	= coalesce(ie_origem_proced_p, ie_origem_proced_w)
				and 	dt_vigencia		= dt_vigencia_w;
				
			elsif	((coalesce(IE_PRIOR_EDICAO_CBHPM_w,'N') = 'R') and (IE_REGRA_PRIOR_EDICAO_w = 'PR')) then
				
				if (coalesce(nr_seq_cbhpm_edicao_w,0) > 0) then
					select 	coalesce(max(dt_vigencia),dt_vigencia_w)
					into STRICT	dt_vigencia_w
					from 	cbhpm_edicao
					where 	nr_sequencia = nr_seq_cbhpm_edicao_w;
				end if;
				
				select	count(*)
				into STRICT	qt_preco_w
				from	cbhpm_preco
				where	cd_procedimento		= cd_procedimento_p
				and	ie_origem_proced	= coalesce(ie_origem_proced_p, ie_origem_proced_w)
				and 	dt_vigencia		= dt_vigencia_w;
				
			else
				select	count(*)
				into STRICT	qt_preco_w
				from	cbhpm_preco
				where	cd_procedimento		= cd_procedimento_p
				and	ie_origem_proced	= coalesce(ie_origem_proced_p, ie_origem_proced_w);
			end if;
		elsif	((ie_calculo_tuss_w <> 'S') and (ie_origem_proced_edicao_w = 8) and (ie_origem_proced_w = 8)) then
			select	count(*)
			into STRICT	qt_preco_w
			from	preco_tuss
			where	cd_edicao_amb		= cd_edicao_amb_w
			and	cd_procedimento		= cd_procedimento_p
			and	ie_origem_proced	= ie_origem_proced_w;
		elsif (ie_tipo_convenio_w = 13) then
			/*for DVA option price calculation this is required*/

			select	coalesce(max(ie_origem_proced),20)
			into STRICT	ie_origem_proced_w
			from	dva_price_catalogue
			where	cd_procedimento		= cd_procedimento_p
			and 	nr_edicao_amb		= cd_edicao_amb_w;

			select 	count(*)
			into STRICT	qt_preco_w
			from 	dva_price_catalogue
			where	nr_edicao_amb		= cd_edicao_amb_w
			and	cd_procedimento		= cd_procedimento_p
			and	ie_origem_proced	= coalesce(ie_origem_proced_p,ie_origem_proced_w);

			if (qt_preco_w = 0) then

				select	count(*)
				into STRICT	qt_preco_w
				from	preco_amb
				where	cd_edicao_amb		= cd_edicao_amb_w
				and	cd_procedimento		= cd_procedimento_p
				and	ie_origem_proced	in (coalesce(ie_origem_proced_p, ie_origem_proced_w), 5)
				and	PKG_DATE_UTILS.start_of(dt_conta_p,'dd',0) between coalesce(dt_inicio_vigencia,clock_timestamp() - interval '3650 days') and coalesce(dt_final_vigencia, dt_conta_p);
			end if;
		else
			select	count(*)
			into STRICT	qt_preco_w
			from	preco_amb
			where	cd_edicao_amb		= cd_edicao_amb_w
			and	cd_procedimento		= cd_procedimento_p
			and	ie_origem_proced	in (coalesce(ie_origem_proced_p, ie_origem_proced_w), 5)
			and	PKG_DATE_UTILS.start_of(dt_conta_p,'dd',0) between coalesce(dt_inicio_vigencia,clock_timestamp() - interval '3650 days') and coalesce(dt_final_vigencia, dt_conta_p);
			/* OS 76639 - Ricardo - Retirada a linha abaixo para colocar o IN acima  and ie_origem_proced = ie_origem_proced_w */

		end if;


		if (coalesce(cd_procedimento_p,0) = 0) then
			qt_preco_w	:= 1;
		end if;			

		if (qt_preco_w > 0) then
			cd_edicao_amb_p			:= cd_edicao_amb_w;
			VL_CH_HONORARIOS_p		:= VL_CH_HONORARIOS_w;
			VL_CH_CUSTO_OPER_p		:= VL_CH_CUSTO_OPER_w;
			VL_M2_FILME_p			:= VL_M2_FILME_w;
			dt_vigencia_p			:= dt_vigencia_w;
			TX_AJUSTE_GERAL_p		:= TX_AJUSTE_GERAL_w;
			nr_seq_cbhpm_edicao_p		:= nr_seq_cbhpm_edicao_w;
			exit;
		end if;

		end;
	end if;

	end;
end loop;
close c01;

if (coalesce(cd_edicao_amb_p::text, '') = '') then
	
	
	--Tdpaula 806587
	If (coalesce(ie_consiste_ult_edicao_amb_w,'N') = 'S') Then
		cd_edicao_amb_p			:= -1;
		VL_CH_HONORARIOS_p		:= 0;
		VL_CH_CUSTO_OPER_p		:= 0;
		VL_M2_FILME_p			:= 0;
		dt_vigencia_p			:= clock_timestamp();
		TX_AJUSTE_GERAL_p		:= 0;
		nr_seq_cbhpm_edicao_p		:= 0;
	Else
		cd_edicao_amb_p			:= cd_edicao_amb_w;
		VL_CH_HONORARIOS_p		:= VL_CH_HONORARIOS_w;
		VL_CH_CUSTO_OPER_p		:= VL_CH_CUSTO_OPER_w;
		VL_M2_FILME_p			:= VL_M2_FILME_w;
		dt_vigencia_p			:= dt_vigencia_w;
		TX_AJUSTE_GERAL_p		:= TX_AJUSTE_GERAL_w;
		nr_seq_cbhpm_edicao_p	:= nr_seq_cbhpm_edicao_w;
	End If;
	
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE obter_edicao_proc_conv (cd_estabelecimento_p bigint, cd_convenio_p bigint, cd_categoria_p text, dt_conta_p timestamp, cd_procedimento_p bigint, cd_edicao_amb_p INOUT bigint, VL_CH_HONORARIOS_p INOUT bigint, VL_CH_CUSTO_OPER_p INOUT bigint, VL_M2_FILME_p INOUT bigint, dt_vigencia_p INOUT timestamp, tx_ajuste_geral_p INOUT bigint, nr_seq_cbhpm_edicao_p INOUT bigint, ie_origem_proced_p bigint default null) FROM PUBLIC;

