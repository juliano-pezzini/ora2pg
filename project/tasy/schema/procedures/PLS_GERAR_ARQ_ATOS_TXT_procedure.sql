-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_gerar_arq_atos_txt ( nr_seq_pls_fatura_p pls_fatura.nr_sequencia%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nm_usuario_p usuario.nm_usuario%type) AS $body$
DECLARE


nr_seq_registro_w		w_ptu_envio_arq.nr_seq_apres%type := 0;
ds_conteudo_w			w_ptu_envio_arq.ds_conteudo%type;
vl_servico_integral_w		varchar(30);
vl_total_servico_w		varchar(30);
dt_execucao_w			varchar(8);

c01 CURSOR( nr_seq_pls_fatura_pc	pls_fatura.nr_sequencia%type) FOR
	SELECT	nr_fatura,
		dt_emissao_fatura,
		(dt_ano_fatura || dt_mes_fatura) dt_mesano_referencia,
		vl_total_servico,
		nr_sequencia
	from	pls_lote_arq_fundacao_txt
	where	nr_seq_pls_fatura	= nr_seq_pls_fatura_pc  LIMIT 1;

c02 CURSOR( nr_seq_lote_arq_fundacao_pc	pls_lote_arq_fundacao_txt.nr_sequencia%type) FOR
	SELECT	cd_guia,
		'0' id_identificador_guia,
		nr_guia_referencia,
		cd_usuario,
		ie_ato_cooperativo,
		cd_prestador_executante,
		nm_prestador_solicitante,
		ds_tipo_prestador,
		cd_unimed_executora,
		vl_servico_integral,
		cd_servico,
		dt_atendimento,
		'S' ie_taxa_adm,
		dt_emissao
	from	pls_movto_arq_fundacao_txt
	where	nr_seq_lote		= nr_seq_lote_arq_fundacao_pc;
BEGIN
delete	FROM w_ptu_envio_arq
where	nm_usuario = nm_usuario_p;

for r_C01_w in C01( nr_seq_pls_fatura_p ) loop
	nr_seq_registro_w	:= nr_seq_registro_w + 1;

	select	lpad(substr(replace(replace(campo_mascara_virgula(coalesce(replace(r_C01_w.vl_total_servico,'.',''),'0')),',',''),'.',''),1,17),17,'0')
	into STRICT	vl_total_servico_w
	;

	-- | CAMPO		| DESCRIÇÃO		| FIXO
	ds_conteudo_w :=	'1'								|| 	-- | TP_REG 	| Tipo do registro		| '1'
				lpad(substr(coalesce(r_C01_w.nr_fatura,'0'),1,10),10,'0')		||	-- | NRO_FATURA	| Número da fatura		|
				lpad(substr(coalesce(r_C01_w.dt_emissao_fatura,'0'),1,8),8,'0')	||	-- | EMISSAO_FATURA	| Data de emissão da fatura	|
				lpad(substr(coalesce(r_C01_w.dt_mesano_referencia,'0'),1,6),6,'0')	||	-- | COMPET_FATURA	| Competência da fatura		|
				vl_total_servico_w						||	-- | VALOR_FATURA	| Valor da fatura		|
				lpad(substr(coalesce(to_char(clock_timestamp(),'ddmmyyyy'),'0'),1,8),8,'0')	||	-- | DATA_GERACAO	| Data de geração do arquivo	|
				'02';									-- | VERSAO_LAYOUT	| Versão do layout		| '02'
	insert into w_ptu_envio_arq(nr_sequencia,
		dt_atualizacao,
		nm_usuario,
		ds_conteudo,
		nr_seq_apres)
	values (nextval('w_ptu_envio_arq_seq'),
		clock_timestamp(),
		nm_usuario_p,
		ds_conteudo_w,
		nr_seq_registro_w);

	for r_C02_w in C02( r_C01_w.nr_sequencia ) loop
		nr_seq_registro_w	:= nr_seq_registro_w + 1;

		select	lpad(substr(replace(replace(campo_mascara_virgula(coalesce(replace(r_C02_w.vl_servico_integral,'.',''),'0')),',',''),'.',''),1,13),13,'0')
		into STRICT	vl_servico_integral_w
		;

		begin
		dt_execucao_w := coalesce(r_C02_w.dt_atendimento,r_C02_w.dt_emissao);
		exception
		when others then
			dt_execucao_w := lpad('0',8,'0');
		end;
																-- | CAMPO			| DESCRIÇÃO		| FIXO
		ds_conteudo_w	:= 	'2' 										||	-- | TP_REG			| Tipo do registro		| '2'
					lpad(substr(coalesce(r_C02_w.cd_guia,0),1,20),20,0)					|| 	-- | GUIA			| Número da guia		|
					lpad(substr(coalesce(r_C02_w.id_identificador_guia,'0'),1,18),18,'0')		||	-- | IDENTIFICADOR_GUIA	| Identificador único da guia	|
					lpad(substr(coalesce(r_C02_w.nr_guia_referencia,'0'),1,4),4,'0')			||	-- | SEQUENCIA_GUIA		| Sequencial do procedimento na guia|
					lpad(substr(coalesce(r_C02_w.cd_usuario,'0'),1,16),16,'0')				||	-- | BENEFICIARIO		| Código do beneficiário		|
					rpad(substr(coalesce(r_C02_w.ie_ato_cooperativo,' '),1,1),1,' ')			||	-- | ATO_COOPERATIVO	| Indicador de ato cooperativo	|
					lpad(substr(coalesce(r_C02_w.cd_prestador_executante,'0'),1,10),10,'0')		||	-- | COD_PRESTADOR		| Código do prestador		|
					rpad(substr(coalesce(r_C02_w.nm_prestador_solicitante,' '),1,40),40,' ')		||	-- | NOME_PRESTADOR	| Nome do prestador		|
					lpad(substr(coalesce(r_C02_w.ds_tipo_prestador,'0'),1,2),2,'0')			||	-- | TIPO_PRESTADOR		| Tipo do prestador		|
					lpad(substr(coalesce(r_C02_w.cd_unimed_executora,'0'),1,4),4,'0')			||	-- | CODIGO_EXECUTORA	| Código da Unimed executora	|
					vl_servico_integral_w 								||	-- | VALOR_INTEGRAL		| Valor integral do procedimento	|
					rpad(substr(coalesce(r_C02_w.cd_servico,' '),1,10),10,' ')				||	-- | CODIGO_PROCEDIMENTO	| Código do procedimento	|
					dt_execucao_w									||	-- | DATA_EXECUCAO		| Data de execução do atendimento	|
					r_C02_w.ie_taxa_adm;									-- | IND_TAXA_ADMINISTRATIVA| Indicador da taxa administratvia	| 'S'
		insert into w_ptu_envio_arq(nr_sequencia,
			dt_atualizacao,
			nm_usuario,
			ds_conteudo,
			nr_seq_apres)
		values (nextval('w_ptu_envio_arq_seq'),
			clock_timestamp(),
			nm_usuario_p,
			ds_conteudo_w,
			nr_seq_registro_w);
	end loop;
end loop;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_gerar_arq_atos_txt ( nr_seq_pls_fatura_p pls_fatura.nr_sequencia%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nm_usuario_p usuario.nm_usuario%type) FROM PUBLIC;

