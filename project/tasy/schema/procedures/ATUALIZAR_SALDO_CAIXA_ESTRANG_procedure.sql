-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE atualizar_saldo_caixa_estrang (cd_estabelecimento_p bigint, nr_seq_lote_p bigint, nr_seq_caixa_p bigint, nr_seq_caixa_saldo_p bigint, nm_usuario_p text) AS $body$
DECLARE


/* Projeto Multimoeda - As validacoes sao realizadas na procedure atualizar_saldo_caixa. Esta procedure e apenas uma extensao, 
	realizando o tratamento das transacoes em moeda estrangeira e atualizando apenas o saldo em moeda estrangeira.
	e recomendado que esta procedure seja chamada apenas pela atualizar_saldo_caixa, para que o processo nao ocorra
	de forma incompleta. */
-- NaO REALIZAR COMMIT NESTA PROCEDURE
dt_referencia_saldo_w		timestamp;
ie_saldo_caixa_w		varchar(01);
vl_atualizado_w			double precision	:= 0;
nr_seq_caixa_w			bigint	:= 0;
nr_seq_movto_w			bigint	:= 0;
ie_caixa_w			varchar(01)	:= null;
ie_banco_w			varchar(01)	:= null;
vl_saldo_atual_w		double precision;
ie_saldo_negativo_w		varchar(1);
ie_saldo_neg_cheque_w		varchar(1);
vl_saldo_avista_w		double precision	:= 0;
vl_saldo_pre_w			double precision	:= 0;

ie_cheque_pre_w			varchar(1);
vl_cheque_pre_w			double precision	:= 0;
vl_cheque_vista_w		double precision	:= 0;
vl_especie_w			double precision	:= 0;
nr_seq_movto_origem_w		bigint;
nr_seq_movto_transf_w		bigint;
ie_cheque_vista_w		varchar(1);
ie_especie_w			varchar(1);
vl_cheque_vista_dep_w		double precision;
vl_cheque_pre_dep_w		double precision;
ie_acao_w			varchar(1) := 'I';
ds_transacao_w			varchar(255)	:= '';
vl_especie_dep_w		double precision;
ie_saldo_dep_cheque_w		varchar(255);

nr_sequencia_w			bigint;
nr_seq_trans_banco_w		bigint;
nr_seq_banco_od_w		bigint;
dt_transacao_w			timestamp;
nr_seq_trans_financ_w		bigint;
vl_transacao_estrang_w		double precision;
cd_pessoa_fisica_w		varchar(255);
cd_cgc_w			varchar(255);
nr_seq_titulo_pagar_w		bigint;
nr_seq_titulo_receber_w		bigint;
nr_bordero_w			bigint;
nr_adiantamento_w		bigint;
nr_seq_caixa_od_w		bigint;
cd_conta_contabil_w		varchar(255);
cd_centro_custo_w		bigint;
nr_seq_nota_fiscal_w		bigint;
nr_interno_conta_w		bigint;
nr_documento_w			varchar(255);
ds_historico_w			varchar(255);
cd_tipo_recebimento_w		bigint;
cd_tipo_baixa_cpa_w		bigint;
nr_seq_cheque_w			bigint;
nr_seq_conv_receb_w		bigint;
nr_seq_deposito_w		bigint;
nr_seq_banco_escrit_w		bigint;
nr_lote_contabil_w		bigint;
nr_adiant_pago_w		bigint;
ie_conciliacao_w		varchar(255);
nr_seq_cheque_cp_w		bigint;
cd_historico_w			varchar(255);
nr_bordero_rec_w		bigint;
nr_seq_movto_cartao_w		bigint;
nr_seq_motivo_dev_w		bigint;
dt_conferencia_w		timestamp;
ie_rejeitado_w			varchar(15);

cd_moeda_empresa_w		integer;
cd_moeda_w			integer;
vl_transacao_w			double precision;
vl_cotacao_w			cotacao_moeda.vl_cotacao%type;
cd_moeda_trans_w		integer;
vl_complemento_w		double precision;

c01 CURSOR FOR
SELECT	distinct cd_moeda
from	caixa_saldo_estrang
where	nr_seq_caixa_saldo = nr_seq_caixa_saldo_p;

c02 CURSOR FOR
SELECT	a.nr_sequencia,
	a.nr_seq_trans_financ,
	a.vl_transacao_estrang,
	a.dt_referencia_saldo,
	a.nr_seq_caixa,
	coalesce(b.ie_caixa,'N'),
	coalesce(b.ie_banco,'N'),
	a.nr_seq_banco_od,
	coalesce(b.ie_saldo_caixa,'N'),
	CASE WHEN b.ie_cheque_cr='P' THEN 'S'  ELSE 'N' END ,
	CASE WHEN b.ie_cheque_cr='V' THEN 'S'  ELSE 'N' END ,
	CASE WHEN b.ie_especie='S' THEN 'S'  ELSE 'N' END ,
	a.nr_seq_deposito,
	b.ds_transacao,
	b.nr_seq_trans_banco,
	coalesce(a.ie_rejeitado,'N')
from	transacao_financeira b,
	movto_trans_financ a
where	a.nr_seq_trans_financ	= b.nr_sequencia
and	a.nr_seq_lote		= nr_seq_lote_p
and	coalesce(a.cd_moeda,cd_moeda_empresa_w) = cd_moeda_w  -- Projeto Multimoeda - Busca apenas o que e referente a moeda do saldo
and	a.nr_seq_caixa		= nr_seq_caixa_p;


BEGIN

begin
select	coalesce(ie_saldo_negativo,'S'),
	coalesce(ie_saldo_dep_cheque,'N'),
	coalesce(ie_saldo_neg_cheque,'N')
into STRICT	ie_saldo_negativo_w,
	ie_saldo_dep_cheque_w,
	ie_saldo_neg_cheque_w
from	parametro_tesouraria
where	cd_estabelecimento	= cd_estabelecimento_p;
exception
when no_data_found then
	/*Os parametros da tesouraria nao estao cadastrados!*/

	CALL wheb_mensagem_pck.exibir_mensagem_abort(220466);
end;

/* Projeto Multimoeda - Busca a moeda padrao da empresa */

select	obter_moeda_padrao_empresa(cd_estabelecimento_p,'E')
into STRICT	cd_moeda_empresa_w
;

open	c01;
loop
fetch	c01 into
	cd_moeda_w;
EXIT WHEN NOT FOUND; /* apply on c01 */

	OPEN	c02;
	LOOP
	FETCH	c02 into
		nr_seq_movto_w,
		nr_seq_trans_financ_w,
		vl_transacao_estrang_w,
		dt_referencia_saldo_w,
		nr_seq_caixa_w,
		ie_caixa_w,
		ie_banco_w,
		nr_seq_banco_od_w,
		ie_saldo_caixa_w,
		ie_cheque_pre_w,
		ie_cheque_vista_w,
		ie_especie_w,
		nr_seq_deposito_w,
		ds_transacao_w,
		nr_seq_trans_banco_w,
		ie_rejeitado_w;
	EXIT WHEN NOT FOUND; /* apply on c02 */
		begin
		/* Francisco - OS  71633 - 19/02/2008 - Estorno de lote  para a Atualizar_transacao_financeira */

		if (vl_transacao_estrang_w < 0) then
			ie_acao_w	:= 'E';
		else
			ie_acao_w	:= 'I';
		end if;

		CALL atualizar_transacao_financeira(cd_estabelecimento_p,
						nr_seq_movto_w,
						nm_usuario_p,
						ie_acao_w);
		if (ie_caixa_w	= 'D') or (ie_caixa_w	= 'T') or (ie_caixa_w	= 'A') then
			if (ie_saldo_caixa_w	= 'S') and (coalesce(ie_rejeitado_w,'N') <> 'S') then
				vl_atualizado_w		:= coalesce(vl_atualizado_w,0) + coalesce(vl_transacao_estrang_w,0);
			elsif (ie_saldo_caixa_w	= 'E') or (coalesce(ie_rejeitado_w,'N') = 'S') then
				vl_atualizado_w		:= coalesce(vl_atualizado_w,0) + (coalesce(vl_transacao_estrang_w,0) * -1);
			end if;
		end if;

		if (ie_banco_w <> 'N') and (nr_seq_banco_od_w IS NOT NULL AND nr_seq_banco_od_w::text <> '') then

			select	nextval('movto_trans_financ_seq')
			into STRICT	nr_sequencia_w
			;

			select	nr_seq_banco_od,
				dt_transacao,
				nr_seq_trans_financ,
				vl_transacao,
				cd_pessoa_fisica,
				cd_cgc,
				nr_seq_titulo_pagar,
				nr_seq_titulo_receber,
				nr_bordero,
				nr_adiantamento,
				nr_seq_banco_od,
				nr_seq_caixa_od,
				cd_conta_contabil,
				cd_centro_custo,
				nr_seq_nota_fiscal,
				nr_interno_conta,
				nr_documento,
				ds_historico,
				cd_tipo_recebimento,
				cd_tipo_baixa_cpa,
				nr_seq_cheque,
				nr_seq_conv_receb,
				nr_seq_deposito,
				nr_seq_banco_escrit,
				nr_lote_contabil,
				nr_adiant_pago,
				ie_conciliacao,
				nr_seq_cheque_cp,
				cd_historico,
				nr_bordero_rec,
				nr_seq_movto_cartao,
				nr_seq_motivo_dev,
				dt_conferencia,
				vl_transacao_estrang,
				vl_complemento,
				vl_cotacao,
				cd_moeda
			into STRICT	nr_seq_banco_od_w,
				dt_transacao_w,
				nr_seq_trans_financ_w,
				vl_transacao_w,
				cd_pessoa_fisica_w,
				cd_cgc_w,
				nr_seq_titulo_pagar_w,
				nr_seq_titulo_receber_w,
				nr_bordero_w,
				nr_adiantamento_w,
				nr_seq_banco_od_w,
				nr_seq_caixa_od_w,
				cd_conta_contabil_w,
				cd_centro_custo_w,
				nr_seq_nota_fiscal_w,
				nr_interno_conta_w,
				nr_documento_w,
				ds_historico_w,
				cd_tipo_recebimento_w,
				cd_tipo_baixa_cpa_w,
				nr_seq_cheque_w,
				nr_seq_conv_receb_w,
				nr_seq_deposito_w,
				nr_seq_banco_escrit_w,
				nr_lote_contabil_w,
				nr_adiant_pago_w,
				ie_conciliacao_w,
				nr_seq_cheque_cp_w,
				cd_historico_w,
				nr_bordero_rec_w,
				nr_seq_movto_cartao_w,
				nr_seq_motivo_dev_w,
				dt_conferencia_w,
				vl_transacao_estrang_w,
				vl_complemento_w,
				vl_cotacao_w,
				cd_moeda_trans_w
			from	movto_trans_financ
			where	nr_sequencia	= nr_seq_movto_w;

			--  ATENcaO !!! NaO CHAMAR ATUALIZAR_TRANSACAO_FINANCEIRA NESTE INSERT POIS A TRANSACAO Ja FOI ATUALIZADO NA TRANSAcaO DE ORIGEM
			insert	into movto_trans_financ(nr_sequencia,
				nm_usuario,
				dt_atualizacao,
				nr_seq_banco,
				dt_transacao,
				nr_seq_trans_financ,
				vl_transacao,
				cd_pessoa_fisica,
				cd_cgc,
				nr_seq_titulo_pagar,
				nr_seq_titulo_receber,
				nr_bordero,
				nr_adiantamento,
				nr_seq_banco_od,
				nr_seq_caixa_od,
				cd_conta_contabil,
				cd_centro_custo,
				nr_seq_nota_fiscal,
				nr_interno_conta,
				nr_documento,
				ds_historico,
				cd_tipo_recebimento,
				cd_tipo_baixa_cpa,
				nr_seq_cheque,
				nr_seq_conv_receb,
				nr_seq_deposito,
				nr_seq_banco_escrit,
				nr_lote_contabil,
				nr_adiant_pago,
				ie_conciliacao,
				nr_seq_cheque_cp,
				ie_origem_lancamento,
				cd_historico,
				nr_bordero_rec,
				nr_seq_movto_cartao,
				nr_seq_motivo_dev,
				dt_conferencia,
				vl_transacao_estrang,
				vl_complemento,
				vl_cotacao,
				cd_moeda)
			VALUES (nr_sequencia_w,
				nm_usuario_p,
				clock_timestamp(),
				nr_seq_banco_od_w,
				dt_transacao_w,
				nr_seq_trans_financ_w,
				vl_transacao_w,
				cd_pessoa_fisica_w,
				cd_cgc_w,
				nr_seq_titulo_pagar_w,
				nr_seq_titulo_receber_w,
				nr_bordero_w,
				nr_adiantamento_w,
				nr_seq_banco_od_w,
				nr_seq_caixa_od_w,
				cd_conta_contabil_w,
				cd_centro_custo_w,
				nr_seq_nota_fiscal_w,
				nr_interno_conta_w,
				nr_documento_w,
				ds_historico_w,
				cd_tipo_recebimento_w,
				cd_tipo_baixa_cpa_w,
				nr_seq_cheque_w,
				nr_seq_conv_receb_w,
				nr_seq_deposito_w,
				nr_seq_banco_escrit_w,
				nr_lote_contabil_w,
				nr_adiant_pago_w,
				ie_conciliacao_w,
				nr_seq_cheque_cp_w,
				'T', --Ajustado na 2740216. Na OS 1233089 trocoram  de T para C  nessa rotina e na Atualizar_Saldo_Caixa, e 9 dias depois devido a problemas na OS 1282713 retornaram para T novamente somente na Atualizar_Saldo_Caixa, faltando essa Atualizar_Saldo_Caixa_estrang.
				cd_historico_w,
				nr_bordero_rec_w,
				nr_seq_movto_cartao_w,
				nr_seq_motivo_dev_w,
				dt_conferencia_w,
				vl_transacao_estrang_w,
				vl_complemento_w,
				vl_cotacao_w,
				cd_moeda_trans_w);
			--  ATENcaO !!! NaO CHAMAR ATUALIZAR_TRANSACAO_FINANCEIRA NESTE INSERT POIS A TRANSACAO Ja FOI ATUALIZADO NA TRANSAcaO DE ORIGEM
		end if;
		
		if (nr_seq_trans_banco_w IS NOT NULL AND nr_seq_trans_banco_w::text <> '') and (nr_seq_banco_od_w IS NOT NULL AND nr_seq_banco_od_w::text <> '') then

			select	nextval('movto_trans_financ_seq')
			into STRICT	nr_sequencia_w
			;

			--  ATENcaO !!! NaO CHAMAR ATUALIZAR_TRANSACAO_FINANCEIRA NESTE INSERT POIS A TRANSACAO Ja FOI ATUALIZADO NA TRANSAcaO DE ORIGEM
			insert	into movto_trans_financ(nr_sequencia,
				nm_usuario,
				dt_atualizacao,
				nr_seq_banco,
				dt_transacao,
				nr_seq_trans_financ,
				vl_transacao,
				cd_pessoa_fisica,
				cd_cgc,
				nr_seq_titulo_pagar,
				nr_seq_titulo_receber,
				nr_bordero,
				nr_adiantamento,
				nr_seq_banco_od,
				nr_seq_caixa_od,
				cd_conta_contabil,
				cd_centro_custo,
				nr_seq_nota_fiscal,
				nr_interno_conta,
				nr_documento,
				ds_historico,
				cd_tipo_recebimento,
				cd_tipo_baixa_cpa,
				nr_seq_cheque,
				nr_seq_conv_receb,
				nr_seq_deposito,
				nr_seq_banco_escrit,
				nr_lote_contabil,
				nr_adiant_pago,
				ie_conciliacao,
				nr_seq_cheque_cp,
				ie_origem_lancamento,
				cd_historico,
				nr_bordero_rec,
				nr_seq_movto_cartao,
				nr_seq_motivo_dev,
				dt_conferencia,
				vl_transacao_estrang,
				vl_complemento,
				vl_cotacao,
				cd_moeda)
			SELECT	nr_sequencia_w,
				nm_usuario_p,
				clock_timestamp(),
				nr_seq_banco_od,
				dt_transacao,
				nr_seq_trans_banco_w,
				vl_transacao,
				cd_pessoa_fisica,
				cd_cgc,
				nr_seq_titulo_pagar,
				nr_seq_titulo_receber,
				nr_bordero,
				nr_adiantamento,
				nr_seq_banco_od,
				nr_seq_caixa_od,
				cd_conta_contabil,
				cd_centro_custo,
				nr_seq_nota_fiscal,
				nr_interno_conta,
				nr_documento,
				ds_historico,
				cd_tipo_recebimento,
				cd_tipo_baixa_cpa,
				nr_seq_cheque,
				nr_seq_conv_receb,
				nr_seq_deposito,
				nr_seq_banco_escrit,
				nr_lote_contabil,
				nr_adiant_pago,
				ie_conciliacao,
				nr_seq_cheque_cp,
				'T', --Ajustado na 2740216. Na OS 1233089 trocoram  de T para C  nessa rotina e na Atualizar_Saldo_Caixa, e 9 dias depois devido a problemas na OS 1282713 retornaram para T novamente somente na Atualizar_Saldo_Caixa, faltando essa Atualizar_Saldo_Caixa_estrang.
				cd_historico,
				nr_bordero_rec,
				nr_seq_movto_cartao,
				nr_seq_motivo_dev,
				dt_conferencia,
				vl_transacao_estrang,
				vl_complemento,
				vl_cotacao,
				cd_moeda
			from	movto_trans_financ
			where	nr_sequencia	= nr_seq_movto_w;
			--  ATENcaO !!! NaO CHAMAR ATUALIZAR_TRANSACAO_FINANCEIRA NESTE INSERT POIS A TRANSACAO Ja FOI ATUALIZADO NA TRANSAcaO DE ORIGEM
		end if;

		if (ie_saldo_dep_cheque_w = 'S') and (nr_seq_deposito_w IS NOT NULL AND nr_seq_deposito_w::text <> '') then

			select	coalesce(sum(CASE WHEN obter_se_cheque_cr_avista(a.nr_seq_cheque)='S' THEN a.vl_cheque_estrang  ELSE 0 END ),0),
				coalesce(sum(CASE WHEN obter_se_cheque_cr_avista(a.nr_seq_cheque)='N' THEN a.vl_cheque_estrang  ELSE 0 END ),0)
			into STRICT	vl_cheque_vista_dep_w,
				vl_cheque_pre_dep_w
			from	deposito_cheque b,
				cheque_cr a
			where	a.nr_seq_cheque		= b.nr_seq_cheque
			and	b.nr_seq_deposito	= nr_seq_deposito_w;

			if (sign(vl_transacao_estrang_w) < 0) then
				vl_cheque_pre_dep_w	:= vl_cheque_pre_dep_w * -1;
				vl_cheque_vista_dep_w	:= vl_cheque_vista_dep_w * -1;
			end if;

			if (ie_saldo_caixa_w = 'S') then
				vl_cheque_pre_w		:= vl_cheque_pre_w + vl_cheque_pre_dep_w * -1;
				vl_cheque_vista_w	:= vl_cheque_vista_w + vl_cheque_vista_dep_w * -1;
			elsif (ie_saldo_caixa_w = 'E') then
				vl_cheque_pre_w		:= vl_cheque_pre_w + vl_cheque_pre_dep_w;
				vl_cheque_vista_w	:= vl_cheque_vista_w + vl_cheque_vista_dep_w;
			end if;

			select	coalesce(max(vl_especie_estrang),0)
			into STRICT	vl_especie_dep_w
			from	deposito
			where	nr_sequencia	= nr_seq_deposito_w;

			if (sign(vl_transacao_estrang_w) < 0) then
				vl_especie_dep_w	:= vl_especie_dep_w * -1;
			end if;

			if (ie_saldo_caixa_w = 'S') then
				vl_especie_w		:= vl_especie_w + vl_especie_dep_w * -1;
			elsif (ie_saldo_caixa_w = 'E') then
				vl_especie_w		:= vl_especie_w + vl_especie_dep_w;
			end if;
		end if;
		
		if (ie_caixa_w in ('A','M')) then
			if (ie_cheque_pre_w = 'S') then
				if (ie_saldo_caixa_w = 'S') then
					vl_cheque_pre_w	:= vl_cheque_pre_w - vl_transacao_estrang_w;
				else
					vl_cheque_pre_w	:= vl_cheque_pre_w + vl_transacao_estrang_w;
				end if;
			elsif (ie_cheque_vista_w = 'S') then
				if (ie_saldo_caixa_w = 'S') then
					vl_cheque_vista_w	:= vl_cheque_vista_w - vl_transacao_estrang_w;
				else
					vl_cheque_vista_w	:= vl_cheque_vista_w + vl_transacao_estrang_w;
				end if;
			elsif (ie_especie_w = 'S') then
				if (ie_saldo_caixa_w = 'S') then
					vl_especie_w	:= vl_especie_w - vl_transacao_estrang_w;
				else
					vl_especie_w	:= vl_especie_w + vl_transacao_estrang_w;
				end if;	
			end if;
			
		elsif (ie_caixa_w = 'T') and (coalesce(nr_seq_deposito_w::text, '') = '' or ie_saldo_dep_cheque_w = 'N') then
			
			if (ie_saldo_caixa_w = 'S') then
				
				select	max(nr_sequencia)
				into STRICT	nr_seq_movto_origem_w
				from	movto_trans_financ
				where	nr_seq_movto_transf	= nr_seq_movto_w;

				if (nr_seq_movto_origem_w IS NOT NULL AND nr_seq_movto_origem_w::text <> '') then

					select	CASE WHEN b.ie_cheque_cr='P' THEN 'S'  ELSE 'N' END ,
						CASE WHEN b.ie_cheque_cr='V' THEN 'S'  ELSE 'N' END ,
						CASE WHEN b.ie_especie='S' THEN 'S'  ELSE 'N' END
					into STRICT	ie_cheque_pre_w,
						ie_cheque_vista_w,
						ie_especie_w
					from	transacao_financeira b,
						movto_trans_financ a
					where	a.nr_seq_trans_financ	= b.nr_sequencia
					and	a.nr_sequencia		= nr_seq_movto_origem_w;

				end if;

				if (ie_cheque_pre_w = 'S') then
					vl_cheque_pre_w		:= vl_cheque_pre_w + (vl_transacao_estrang_w * -1);	
				elsif (ie_cheque_vista_w = 'S') then
					vl_cheque_vista_w	:= vl_cheque_vista_w + (vl_transacao_estrang_w * -1);
				elsif (ie_especie_w = 'S') then
					vl_especie_w		:= vl_especie_w + (vl_transacao_estrang_w * -1);
				end if;

			elsif (ie_saldo_caixa_w	= 'E') then
			
				select	max(nr_sequencia)
				into STRICT	nr_seq_movto_transf_w
				from	movto_trans_financ
				where	nr_seq_movto_transf	= nr_seq_movto_w;

				if (nr_seq_movto_transf_w IS NOT NULL AND nr_seq_movto_transf_w::text <> '') then
					select	max(nr_sequencia)
					into STRICT	nr_seq_movto_origem_w
					from	movto_trans_financ
					where	nr_seq_movto_transf	= nr_seq_movto_transf_w;
				end if;

				if (nr_seq_movto_origem_w IS NOT NULL AND nr_seq_movto_origem_w::text <> '') then

					select	CASE WHEN b.ie_cheque_cr='P' THEN 'S'  ELSE 'N' END ,
						CASE WHEN b.ie_cheque_cr='V' THEN 'S'  ELSE 'N' END ,
						CASE WHEN b.ie_especie='S' THEN 'S'  ELSE 'N' END
					into STRICT	ie_cheque_pre_w,
						ie_cheque_vista_w,
						ie_especie_w
					from	transacao_financeira b,
						movto_trans_financ a
					where	a.nr_seq_trans_financ	= b.nr_sequencia
					and	a.nr_sequencia		= nr_seq_movto_origem_w;
				end if;

				if (ie_cheque_pre_w = 'S') then
					vl_cheque_pre_w		:= vl_cheque_pre_w + vl_transacao_estrang_w;	
				elsif (ie_cheque_vista_w = 'S') then
					vl_cheque_vista_w 	:= vl_cheque_vista_w + vl_transacao_estrang_w;
				elsif (ie_especie_w = 'S') then
					vl_especie_w		:= vl_especie_w + vl_transacao_estrang_w;
				end if;	
			end if;	
		end if;

		end;
	end loop;
	close c02;

	if (ie_saldo_negativo_w = 'N') then
		
		select	a.vl_saldo,
			coalesce(vl_cheque_vista_atual,0),
			coalesce(vl_cheque_pre_atual,0)
		into STRICT	vl_saldo_atual_w,
			vl_saldo_avista_w,
			vl_saldo_pre_w
		from	caixa_saldo_estrang a
		where	a.cd_moeda	= cd_moeda_w
		and	a.nr_seq_caixa_saldo = nr_seq_caixa_saldo_p;

		if	((vl_saldo_atual_w - coalesce(vl_atualizado_w,0)) < 0) then
			CALL wheb_mensagem_pck.exibir_mensagem_abort(220480,'VL_SALDO_ATUAL_W='||vl_saldo_atual_w||';VL_SALDO_FECHAMENTO_W='||(vl_saldo_atual_w - vl_atualizado_w));
		end if;
		
		if (coalesce(ie_saldo_neg_cheque_w,'N') = 'S') then
			if	((vl_saldo_avista_w + coalesce(vl_cheque_vista_w,0)) < 0) then
				CALL wheb_mensagem_pck.exibir_mensagem_abort(354262,'VL_SALDO_ATUAL_W='||vl_saldo_avista_w||';VL_SALDO_FECHAMENTO_W='||(vl_saldo_avista_w + coalesce(vl_cheque_vista_w,0)));
			end if;
			if	((vl_saldo_pre_w + coalesce(vl_cheque_pre_w,0)) < 0) then
				CALL wheb_mensagem_pck.exibir_mensagem_abort(354262,'VL_SALDO_ATUAL_W='||vl_saldo_pre_w||';VL_SALDO_FECHAMENTO_W='||(vl_saldo_pre_w + coalesce(vl_cheque_pre_w,0)));
			end if;
		end if;
	end if;

	update	caixa_saldo_estrang
	set	vl_saldo		= vl_saldo - coalesce(vl_atualizado_w,0),
		vl_cheque_pre_atual	= coalesce(vl_cheque_pre_atual,0) + coalesce(vl_cheque_pre_w,0),
		vl_cheque_vista_atual	= coalesce(vl_cheque_vista_atual,0) + coalesce(vl_cheque_vista_w,0),
		vl_especie_atual	= coalesce(vl_especie_atual,0) + coalesce(vl_especie_w,0)
	where	cd_moeda = cd_moeda_w
	and	nr_seq_caixa_saldo = nr_seq_caixa_saldo_p;

	update	caixa_saldo_estrang
	set	vl_saldo_avista	= vl_saldo - coalesce(vl_cheque_pre_atual,0)
	where	cd_moeda = cd_moeda_w
	and	nr_seq_caixa_saldo = nr_seq_caixa_saldo_p;
	
	vl_atualizado_w := 0;
	vl_cheque_pre_w := 0;
	vl_cheque_vista_w := 0;
	vl_especie_w := 0;

end loop;
close c01;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE atualizar_saldo_caixa_estrang (cd_estabelecimento_p bigint, nr_seq_lote_p bigint, nr_seq_caixa_p bigint, nr_seq_caixa_saldo_p bigint, nm_usuario_p text) FROM PUBLIC;

