-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE call_alterar_dados_atend (nr_seq_atendimento_p bigint, ie_origem_atendimento_p text, ie_origem_atendimento_novo_p text, nm_usuario_p text) AS $body$
DECLARE


DS_HISTORICO_W	 		varchar(4000);
DS_ORIGEM_NOVO_W		varchar(255);
DS_ORIGEM_ANTERIOR_W		varchar(255);
NR_HIST_GERADO_SISTEMA_W	double precision;


BEGIN

	if (nr_seq_atendimento_p IS NOT NULL AND nr_seq_atendimento_p::text <> '') then

		SELECT SUBSTR(obter_desc_expressao(cd_exp_valor_dominio, ds_valor_dominio), 1, 254)
   		  INTO STRICT DS_ORIGEM_NOVO_W
		  FROM valor_dominio
		 WHERE cd_dominio = 3180
		   AND vl_dominio = ie_origem_atendimento_novo_p;

		SELECT	MAX(nr_sequencia)
		INTO STRICT	NR_HIST_GERADO_SISTEMA_W
		FROM	PLS_TIPO_HISTORICO_ATEND
		WHERE	ie_gerado_sistema	= 'S'
		AND	ie_situacao		= 'A';

		SELECT SUBSTR(obter_desc_expressao(cd_exp_valor_dominio, ds_valor_dominio), 1, 254)
   		  INTO STRICT DS_ORIGEM_ANTERIOR_W
		  FROM valor_dominio
		 WHERE cd_dominio = 3180
		   AND vl_dominio = ie_origem_atendimento_p;


		DS_HISTORICO_W := substr(wheb_mensagem_pck.get_texto(383077)||chr(13)||chr(10)||
					 wheb_mensagem_pck.get_texto(383084)||chr(13)||chr(10)||
						chr(9)||wheb_mensagem_pck.get_texto(383093)||DS_ORIGEM_ANTERIOR_W||chr(13)||chr(10)||
						chr(9)||wheb_mensagem_pck.get_texto(383094)||DS_ORIGEM_NOVO_W,1,4000);


		UPDATE PLS_ATENDIMENTO
		SET    IE_ORIGEM_ATENDIMENTO = ie_origem_atendimento_novo_p,
		       DT_ATUALIZACAO = clock_timestamp(),
		       NM_USUARIO = nm_usuario_p
		WHERE  NR_SEQUENCIA = nr_seq_atendimento_p;

		INSERT INTO PLS_ATENDIMENTO_HISTORICO(
			NR_SEQUENCIA
			,NR_SEQ_ATENDIMENTO
			,DS_HISTORICO_LONG
			,IE_GERADO_SISTEMA
			,DT_ATUALIZACAO
			,NM_USUARIO
			,DT_ATUALIZACAO_NREC
			,NM_USUARIO_NREC
			,NR_SEQ_TIPO_HISTORICO
			,DT_HISTORICO)
		VALUES (nextval('pls_atendimento_historico_seq')
			,NR_SEQ_ATENDIMENTO_P
			,DS_HISTORICO_W
			,'S'
			,clock_timestamp()
			,nm_usuario_p
			,clock_timestamp()
			,nm_usuario_p
			,NR_HIST_GERADO_SISTEMA_W
			,clock_timestamp());

		COMMIT;
	END IF;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE call_alterar_dados_atend (nr_seq_atendimento_p bigint, ie_origem_atendimento_p text, ie_origem_atendimento_novo_p text, nm_usuario_p text) FROM PUBLIC;

