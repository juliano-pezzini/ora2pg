-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE ajusta_valida_prescricao ( nr_prescricao_p bigint, nm_usuario_p text, cd_perfil_p bigint, cd_estabelecimento_p bigint) AS $body$
DECLARE

									  
dt_prescricao_w			timestamp;									
dt_primeiro_horario_w	timestamp;	
dt_entrada_w			timestamp;
VarQuantMaxAntesAjust  integer;
VarQuantMaxAposAjust  integer;
ie_hemodialise_w    varchar(1);
cd_setor_atendimento_w integer;
dt_lib_medico_w     timestamp;
nr_atendimento_w    bigint;


BEGIN 
VarQuantMaxAntesAjust := Obter_Param_Usuario(924, 1140, cd_perfil_p, nm_usuario_p, cd_estabelecimento_p, VarQuantMaxAntesAjust);
VarQuantMaxAposAjust := Obter_Param_Usuario(924, 1141, cd_perfil_p, nm_usuario_p, cd_estabelecimento_p, VarQuantMaxAposAjust);
 
SELECT	max(dt_prescricao), 
		max(ie_hemodialise), 
		max(cd_setor_atendimento), 
		max(dt_liberacao_medico), 
		max(nr_atendimento) 
INTO STRICT dt_prescricao_w, ie_hemodialise_w,  cd_setor_atendimento_w , dt_lib_medico_w, nr_atendimento_w 
FROM PRESCR_MEDICA 
WHERE NR_PRESCRICAO = nr_prescricao_p;
 
SELECT	MAX(DT_ENTRADA) INTO STRICT dt_entrada_w 
FROM	ATENDIMENTO_PACIENTE 
WHERE	NR_ATENDIMENTO = nr_atendimento_w;
 
if (dt_prescricao_w between dt_entrada_w - VarQuantMaxAntesAjust and dt_entrada_w + VarQuantMaxAposAjust) then 
 
	if (ie_hemodialise_w = 'P') then 
	  dt_primeiro_horario_w	:= obter_prox_hora_cheia(clock_timestamp());
	else 
		dt_primeiro_horario_w	:= Obter_Prim_Horario_Prescricao(nr_atendimento_w,cd_setor_atendimento_w,dt_entrada_w,nm_usuario_p,'R');	
	end if;
 
	UPDATE	PRESCR_MEDICA 
	SET		DT_PRESCRICAO    = dt_entrada_w, 
			dt_primeiro_horario = dt_primeiro_horario_w, 
			DT_INICIO_PRESCR  = to_date(to_char(dt_entrada_w,'dd/mm/yyyy') || ' ' || to_char(dt_primeiro_horario_w,'hh24:mi:ss'),'dd/mm/yyyy hh24:mi:ss') 
	WHERE	NR_PRESCRICAO  = nr_prescricao_p;
  commit;
	 
	 
	CALL RECALCULAR_HOR_PRESCRICAO(nr_prescricao_p,nm_usuario_p);
	CALL RECALCULAR_HORA_SOL(nr_prescricao_p, dt_primeiro_horario_w,cd_estabelecimento_p, cd_perfil_p, nm_usuario_p);
  -- plt_estender_liberacao(nr_prescricao_p,nm_usuario_p,cd_perfil_p,cd_estabelecimento_p);							  
 
end if;
								  
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ajusta_valida_prescricao ( nr_prescricao_p bigint, nm_usuario_p text, cd_perfil_p bigint, cd_estabelecimento_p bigint) FROM PUBLIC;

