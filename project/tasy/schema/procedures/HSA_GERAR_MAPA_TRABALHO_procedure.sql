-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE hsa_gerar_mapa_trabalho ( nr_prescricao_p bigint, nr_seq_prescr_p bigint, nm_usuario_p text) AS $body$
DECLARE

 
nr_prescricao_w		bigint;
nr_prescr_w		varchar(255);
ds_setor_w		varchar(255);
nm_pessoa_fisica_w	varchar(255);
ds_idade_w		varchar(255);
ds_sexo_w		varchar(255);
ds_cpd_w		varchar(255);
ds_destino_w		varchar(255);
ds_categoria_w		varchar(255);
ds_situacao_w		varchar(255);
nm_medico_w		varchar(255);
ds_contato_w		varchar(255);
ds_dig_w		varchar(255);
dt_coleta_w		varchar(255);
dt_entrega_w		varchar(255);
ds_exames_w		varchar(255);
ds_observacao_w		varchar(255);
nr_seq_grupo_par_w	bigint;

nr_seq_formato_w	bigint;
qt_linhas_w		bigint;
nm_exame1_w		varchar(255);
nm_exame2_w		varchar(255);

cont_w			bigint;
nr_sequencia_w		bigint;
nr_total_w		bigint;
nr_linha_w		bigint;
nr_pagina_w		varchar(20);

c01 CURSOR FOR 
SELECT	distinct 
	a.nr_prescricao, 
	(obter_desc_expressao(295394)/*'Pedido: '*/
 ||': '|| a.nr_prescricao) nr_prescr, 
	(obter_desc_expressao(329821)/*'Setor: '*/
 || obter_nome_setor(a.cd_setor_atendimento)) ds_setor, 
	('Nome: ' || obter_nome_pf(c.cd_pessoa_fisica)) nm_pessoa_fisica, 
	(obter_desc_expressao(326096)/*'Idade: '*/
 || obter_dados_pf(c.cd_pessoa_fisica, 'I')) ds_idade, 
	('Sexo: ' || OBTER_SEXO_PF(c.cd_pessoa_fisica, 'C')) ds_sexo, 
	('CPD:') ds_cpd, 
	(obter_desc_expressao(329684)/*'Destino: '*/
 || obter_nome_setor(a.cd_setor_entrega)) ds_destino, 
	(obter_desc_expressao(651009)/*'Categoria: '*/
) ds_categoria, 
	('Sit.: ') ds_situacao, 
	('Dr(a): ' || a.cd_medico || '   ' || substr(obter_nome_medico(a.cd_medico, 'N'),1,20)) nm_medico, 
	(obter_desc_expressao(629938)/*'Contato: '*/
) ds_contato, 
	('Dig.: ') ds_dig, 
	(obter_desc_expressao(285474)/*'Coleta: '*/
 ||': '|| to_date(b.dt_coleta, 'dd/mm/yy hh24:mi')) dt_coleta, 
	(obter_desc_expressao(289280)/*'Entrega: '*/
 ||': '|| to_date(a.dt_entrega, 'dd/mm/yy hh24:mi')) dt_entrega, 
	('Exa: ' || substr(obter_exames_prescr_lab(a.nr_prescricao, null, null, null, null, 'CE', ';', 0), 1, 80)) ds_exames, 
	('Obs: ') ds_observacao, 
	e.nr_seq_grupo nr_seq_grupo_par 
from	atendimento_paciente c, 
	grupo_exame_lab g, 
	exame_laboratorio e, 
	prescr_medica a, 
	prescr_procedimento b 
where	a.nr_prescricao		= b.nr_prescricao 
and	c.nr_atendimento	        = a.nr_atendimento 
and	e.nr_seq_exame		= b.nr_seq_exame 
and	g.nr_sequencia		= e.nr_seq_grupo 
and	g.nr_sequencia		in (6, 7, 8) 
and	a.nr_prescricao		= nr_prescricao_p 
and	((b.nr_sequencia	= nr_seq_prescr_p) or (coalesce(nr_seq_prescr_p::text, '') = ''));

c02 CURSOR FOR 
SELECT	nr_seq_formato, 
	round(count(*) /2) qt_linhas 
from	exame_lab_format_item 
where	nr_seq_formato in ( 
	SELECT	distinct obter_formato_exame(b.nr_seq_exame, f.nr_sequencia, null, 'M') 
	from	grupo_exame_lab e, 
		exame_laboratorio l, 
		material_exame_lab f, 
		prescr_procedimento b, 
		prescr_medica a 
	where	a.nr_prescricao		= b.nr_prescricao 
	and	e.nr_sequencia		= l.nr_seq_grupo 
	and	b.cd_material_exame	= f.cd_material_exame 
	and	b.nr_seq_exame		= l.nr_seq_exame 
	and	a.nr_prescricao		= nr_prescricao_p 
	and	e.nr_sequencia		= nr_seq_grupo_par_w 
	and	(obter_formato_exame(b.nr_seq_exame, f.nr_sequencia, null, 'M') IS NOT NULL AND (obter_formato_exame(b.nr_seq_exame, f.nr_sequencia, null, 'M'))::text <> '')) 
group by nr_seq_formato;

c03 CURSOR FOR 
SELECT	substr(LAB_OBTER_FORMATO_ITEM(nr_seq_formato_par2,(nr_linha_par*2) -1) || '.................',1,20) || ':________________' nm_exame1, 
	substr(LAB_OBTER_FORMATO_ITEM(nr_seq_formato_par2,(nr_linha_par*2)) || '.................',1,20) || ':________________' nm_exame2 
from ( 
	SELECT	nr_seq_formato_w nr_seq_formato_par2, row_number() OVER () AS nr_linha_par 
	from	tabela_sistema LIMIT (qt_linhas_w)) alias6;


BEGIN 
 
delete	from w_mapa_lab_ispg 
where	nm_usuario	= nm_usuario_p;
 
commit;
 
nr_pagina_w	:= 0;
nr_linha_w	:= 0;
 
open c01;
loop 
fetch c01 into 
	nr_prescricao_w, 
	nr_prescr_w, 
	ds_setor_w, 
	nm_pessoa_fisica_w, 
	ds_idade_w, 
	ds_sexo_w, 
	ds_cpd_w, 
	ds_destino_w, 
	ds_categoria_w, 
	ds_situacao_w, 
	nm_medico_w, 
	ds_contato_w, 
	ds_dig_w, 
	dt_coleta_w, 
	dt_entrega_w, 
	ds_exames_w, 
	ds_observacao_w, 
	nr_seq_grupo_par_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
 
	select	nextval('w_mapa_lab_ispg_seq') 
	into STRICT	nr_sequencia_w 
	;
 
	nr_linha_w	:= nr_linha_w + 1;
	insert into w_mapa_lab_ispg(nr_sequencia, 
		 dt_atualizacao, 
		 nr_linha, 
		 ds_linha, 
		 nm_usuario) 
	values (nr_sequencia_w, 
		 clock_timestamp(), 
		 nr_linha_w, 
		 nr_prescr_w || '   ' || ds_setor_w, 
		 nm_usuario_p);
 
	select	nextval('w_mapa_lab_ispg_seq') 
	into STRICT	nr_sequencia_w 
	;
 
	nr_linha_w	:= nr_linha_w + 1;
	insert into w_mapa_lab_ispg(nr_sequencia, 
		 dt_atualizacao, 
		 nr_linha, 
		 ds_linha, 
		 nm_usuario) 
	values (nr_sequencia_w, 
		 clock_timestamp(), 
		 nr_linha_w, 
		 nm_pessoa_fisica_w || '   ' || ds_idade_w || ' ' || ds_sexo_w || ' ' || ds_cpd_w, 
		 nm_usuario_p);
 
	select	nextval('w_mapa_lab_ispg_seq') 
	into STRICT	nr_sequencia_w 
	;
 
	nr_linha_w	:= nr_linha_w + 1;
	insert into w_mapa_lab_ispg(nr_sequencia, 
		 dt_atualizacao, 
		 nr_linha, 
		 ds_linha, 
		 nm_usuario) 
	values (nr_sequencia_w, 
		 clock_timestamp(), 
		 nr_linha_w, 
		 ds_destino_w || '   ' || ds_categoria_w || ' ' || ds_situacao_w, 
		 nm_usuario_p);
 
	select	nextval('w_mapa_lab_ispg_seq') 
	into STRICT	nr_sequencia_w 
	;
 
	nr_linha_w	:= nr_linha_w + 1;
	insert into w_mapa_lab_ispg(nr_sequencia, 
		 dt_atualizacao, 
		 nr_linha, 
		 ds_linha, 
		 nm_usuario) 
	values (nr_sequencia_w, 
		 clock_timestamp(), 
		 nr_linha_w, 
		 nm_medico_w || '   ' || ds_contato_w || '   ' || ds_dig_w, 
		 nm_usuario_p);
 
	select	nextval('w_mapa_lab_ispg_seq') 
	into STRICT	nr_sequencia_w 
	;
 
	nr_linha_w	:= nr_linha_w + 1;
	insert into w_mapa_lab_ispg(nr_sequencia, 
		 dt_atualizacao, 
		 nr_linha, 
		 ds_linha, 
		 nm_usuario) 
	values (nr_sequencia_w, 
		 clock_timestamp(), 
		 nr_linha_w, 
		 dt_coleta_w || '   ' || dt_entrega_w, 
		 nm_usuario_p);
 
	select	nextval('w_mapa_lab_ispg_seq') 
	into STRICT	nr_sequencia_w 
	;
 
	nr_linha_w	:= nr_linha_w + 1;
	insert into w_mapa_lab_ispg(nr_sequencia, 
		 dt_atualizacao, 
		 nr_linha, 
		 ds_linha, 
		 nm_usuario) 
	values (nr_sequencia_w, 
		 clock_timestamp(), 
		 nr_linha_w, 
		 ds_exames_w, 
		 nm_usuario_p);
 
	select	nextval('w_mapa_lab_ispg_seq') 
	into STRICT	nr_sequencia_w 
	;
 
	nr_linha_w	:= nr_linha_w + 1;
	insert into w_mapa_lab_ispg(nr_sequencia, 
		 dt_atualizacao, 
		 nr_linha, 
		 ds_linha, 
		 nm_usuario) 
	values (nr_sequencia_w, 
		 clock_timestamp(), 
		 nr_linha_w, 
		 ds_observacao_w, 
		 nm_usuario_p);
 
	cont_w	:= 0;
 
	open c02;
	loop 
	fetch c02 into 
		nr_seq_formato_w, 
		qt_linhas_w;
	EXIT WHEN NOT FOUND; /* apply on c02 */
 
		open c03;
		loop 
		fetch c03 into 
			nm_exame1_w, 
			nm_exame2_w;
		EXIT WHEN NOT FOUND; /* apply on c03 */
 
			if (cont_w	< 22) then 
				select	nextval('w_mapa_lab_ispg_seq') 
				into STRICT	nr_sequencia_w 
				;
 
				nr_linha_w	:= nr_linha_w + 1;
				insert into w_mapa_lab_ispg(nr_sequencia, 
					 dt_atualizacao, 
					 nr_linha, 
					 ds_linha, 
					 nm_usuario) 
				values (nr_sequencia_w, 
					 clock_timestamp(), 
					 nr_linha_w, 
					 nm_exame1_w || '   ' || nm_exame2_w, 
					 nm_usuario_p);
				cont_w		:= cont_w + 1;
			else 
 
				select	nextval('w_mapa_lab_ispg_seq') 
				into STRICT	nr_sequencia_w 
				;
 
				nr_linha_w	:= nr_linha_w + 1;
				insert into w_mapa_lab_ispg(nr_sequencia, 
					 dt_atualizacao, 
					 nr_linha, 
					 ds_linha, 
					 nm_usuario) 
				values (nr_sequencia_w, 
					 clock_timestamp(), 
					 nr_linha_w, 
					 '', 
					 nm_usuario_p);
 
				select	nextval('w_mapa_lab_ispg_seq') 
				into STRICT	nr_sequencia_w 
				;
 
				nr_linha_w	:= nr_linha_w + 1;
				insert into w_mapa_lab_ispg(nr_sequencia, 
					 dt_atualizacao, 
					 nr_linha, 
					 ds_linha, 
					 nm_usuario) 
				values (nr_sequencia_w, 
					 clock_timestamp(), 
					 nr_linha_w, 
					 nr_prescr_w || '   ' || ds_setor_w, 
					 nm_usuario_p);
 
				select	nextval('w_mapa_lab_ispg_seq') 
				into STRICT	nr_sequencia_w 
				;
 
				nr_linha_w	:= nr_linha_w + 1;
				insert into w_mapa_lab_ispg(nr_sequencia, 
					 dt_atualizacao, 
					 nr_linha, 
					 ds_linha, 
					 nm_usuario) 
				values (nr_sequencia_w, 
					 clock_timestamp(), 
					 nr_linha_w, 
					 nm_pessoa_fisica_w || '   ' || ds_idade_w || ' ' || ds_sexo_w || ' ' || ds_cpd_w, 
					 nm_usuario_p);
 
				select	nextval('w_mapa_lab_ispg_seq') 
				into STRICT	nr_sequencia_w 
				;
 
				nr_linha_w	:= nr_linha_w + 1;
				insert into w_mapa_lab_ispg(nr_sequencia, 
					 dt_atualizacao, 
					 nr_linha, 
					 ds_linha, 
					 nm_usuario) 
				values (nr_sequencia_w, 
					 clock_timestamp(), 
					 nr_linha_w, 
					 ds_destino_w || '   ' || ds_categoria_w || ' ' || ds_situacao_w, 
					 nm_usuario_p);
 
				select	nextval('w_mapa_lab_ispg_seq') 
				into STRICT	nr_sequencia_w 
				;
 
				nr_linha_w	:= nr_linha_w + 1;
				insert into w_mapa_lab_ispg(nr_sequencia, 
					 dt_atualizacao, 
					 nr_linha, 
					 ds_linha, 
					 nm_usuario) 
				values (nr_sequencia_w, 
					 clock_timestamp(), 
					 nr_linha_w, 
					 nm_medico_w || '   ' || ds_contato_w || '   ' || ds_dig_w, 
					 nm_usuario_p);
 
				select	nextval('w_mapa_lab_ispg_seq') 
				into STRICT	nr_sequencia_w 
				;
 
				nr_linha_w	:= nr_linha_w + 1;
				insert into w_mapa_lab_ispg(nr_sequencia, 
					 dt_atualizacao, 
					 nr_linha, 
					 ds_linha, 
					 nm_usuario) 
				values (nr_sequencia_w, 
					 clock_timestamp(), 
					 nr_linha_w, 
					 dt_coleta_w || '   ' || dt_entrega_w, 
					 nm_usuario_p);
 
				select	nextval('w_mapa_lab_ispg_seq') 
				into STRICT	nr_sequencia_w 
				;
 
				nr_linha_w	:= nr_linha_w + 1;
				insert into w_mapa_lab_ispg(nr_sequencia, 
					 dt_atualizacao, 
					 nr_linha, 
					 ds_linha, 
					 nm_usuario) 
				values (nr_sequencia_w, 
					 clock_timestamp(), 
					 nr_linha_w, 
					 ds_exames_w, 
					 nm_usuario_p);
 
				select	nextval('w_mapa_lab_ispg_seq') 
				into STRICT	nr_sequencia_w 
				;
 
				nr_linha_w	:= nr_linha_w + 1;
				insert into w_mapa_lab_ispg(nr_sequencia, 
					 dt_atualizacao, 
					 nr_linha, 
					 ds_linha, 
					 nm_usuario) 
				values (nr_sequencia_w, 
					 clock_timestamp(), 
					 nr_linha_w, 
					 ds_observacao_w, 
					 nm_usuario_p);
 
				cont_w	:= 0;
 
			end if;
 
		end loop;
		close c03;
 
	end loop;
	close c02;
 
	select	max(nr_linha) 
	into STRICT	nr_total_w 
	from	w_mapa_lab_ispg 
	where	nm_usuario	= nm_usuario_p;
 
	if (mod(nr_total_w, 33) <> 1) then 
		while(mod(nr_total_w, 33) <> 1) loop 
 
			select	nextval('w_mapa_lab_ispg_seq') 
			into STRICT	nr_sequencia_w 
			;
 
			nr_linha_w	:= nr_linha_w + 1;
			insert into w_mapa_lab_ispg(nr_sequencia, 
				 dt_atualizacao, 
				 nr_linha, 
				 ds_linha, 
				 nm_usuario) 
			values (nr_sequencia_w, 
				 clock_timestamp(), 
				 nr_linha_w, 
				 '', 
				 nm_usuario_p);
			nr_total_w	:= nr_total_w + 1;
		end loop;
	end if;
 
end loop;
close c01;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE hsa_gerar_mapa_trabalho ( nr_prescricao_p bigint, nr_seq_prescr_p bigint, nm_usuario_p text) FROM PUBLIC;

