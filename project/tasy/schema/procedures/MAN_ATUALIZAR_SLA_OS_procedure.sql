-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE man_atualizar_sla_os ( nr_seq_sla_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text, ie_prioridade_p text, ie_classificacao_p text, nr_seq_localizacao_p bigint, nr_seq_grupo_trab_p bigint, dt_ordem_servico_p timestamp, dt_inicio_p timestamp, nr_seq_estagio_p bigint, nr_seq_equipamento_p bigint, nr_seq_classif_p bigint, ie_parado_p text, ie_verifica_estagio_p text default 'S', ie_verifica_tipo_equip_p text default 'S') AS $body$
DECLARE


qt_min_inicio_w		bigint;
qt_min_termino_w		bigint;
nr_seq_sla_w		bigint;
nr_seq_sla_regra_w		bigint;
nr_sequencia_w		bigint;
dt_inicio_prev_w		timestamp;
dt_termino_prev_w		timestamp;
qt_reg_w			bigint;
ie_tempo_w		varchar(15);
nr_seq_estagio_w		bigint;
nr_seq_tipo_equip_w	bigint;
nr_seq_tipo_equip_ww	bigint;
nr_seq_equipamento_w	bigint;
ie_tipo_sla_w		man_sla_regra.ie_tipo_sla%type;	
ie_utiliza_sla_w		varchar(255) := obter_valor_param_usuario(299,57,wheb_usuario_pck.get_cd_perfil,coalesce(nm_usuario_p,wheb_usuario_pck.get_nm_usuario),wheb_usuario_pck.get_cd_estabelecimento);

C01 CURSOR FOR
SELECT	b.nr_seq_sla,
	b.qt_min_inicio,
	b.qt_min_termino,
	b.ie_tempo,
	b.nr_seq_estagio,
	b.nr_seq_equipamento,
	b.nr_seq_tipo_equipamento,
	b.nr_sequencia,
	b.ie_tipo_sla
FROM man_sla_regra b, man_sla a
LEFT OUTER JOIN man_sla_loc c ON (a.nr_sequencia = c.nr_seq_sla)
WHERE a.nr_sequencia				= b.nr_seq_sla  and a.dt_vigencia				<= clock_timestamp() and coalesce(c.nr_seq_local,nr_seq_localizacao_p)	= nr_seq_localizacao_p and coalesce(a.nr_seq_grupo_trab, coalesce(nr_seq_grupo_trab_p,0)) = coalesce(nr_seq_grupo_trab_p,0) and b.ie_classificacao				= ie_classificacao_p and coalesce(ie_prioridade,ie_prioridade_p)		= ie_prioridade_p and coalesce(nr_seq_estagio, coalesce(nr_seq_estagio_p,0)) 	= coalesce(nr_seq_estagio_p,0) and coalesce(nr_seq_classif, coalesce(nr_seq_classif_p,0)) 	= coalesce(nr_seq_classif_p,0) and coalesce(nr_seq_equipamento, coalesce(nr_seq_equipamento_p,0)) = coalesce(nr_seq_equipamento_p,0) and ((not ie_verifica_tipo_equip_p = 'S') or (ie_verifica_tipo_equip_p = 'S' and coalesce(nr_seq_tipo_equipamento, coalesce(nr_seq_tipo_equip_w,0)) = coalesce(nr_seq_tipo_equip_w,0))) and coalesce(b.ie_parado, coalesce(ie_parado_p,'X'))		= coalesce(ie_parado_p,'X') and coalesce(a.ie_situacao,'A') 			= 'A' and ((c.nr_seq_local IS NOT NULL AND c.nr_seq_local::text <> '') or ie_utiliza_sla_w = 'L') order by coalesce(ie_prioridade,' '),
        c.nr_seq_sla,
        CASE WHEN ie_utiliza_sla_w='l' THEN  ''  ELSE c.nr_seq_local END  desc,
        a.nr_seq_grupo_trab desc,
        b.nr_seq_equipamento desc,
        b.nr_seq_estagio desc,
        b.nr_seq_classif desc,
        b.nr_seq_tipo_equipamento desc,
        b.ie_parado desc,
        c.nr_seq_local desc;


BEGIN
select	coalesce(max(nr_seq_tipo_equip),0)
into STRICT	nr_seq_tipo_equip_w
from	man_equipamento
where	nr_sequencia = nr_seq_equipamento_p;

open C01;
loop
fetch C01 into	
	nr_seq_sla_w,
	qt_min_inicio_w,
	qt_min_termino_w,
	ie_tempo_w,
	nr_seq_estagio_w,
	nr_seq_equipamento_w,
	nr_seq_tipo_equip_ww,
	nr_seq_sla_regra_w,
	ie_tipo_sla_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	nr_seq_sla_w		:= nr_seq_sla_w;
	nr_seq_sla_regra_w		:= nr_seq_sla_regra_w;
End loop;
close C01;
if (nr_seq_sla_w > 0) then
	if (ie_tempo_w = 'COR') then
		dt_inicio_prev_w	:= clock_timestamp() + (qt_min_inicio_w / 1440);
		dt_termino_prev_w	:= clock_timestamp() + (qt_min_termino_w / 1440);
	else
		dt_inicio_prev_w	:= man_obter_hor_com(cd_estabelecimento_p, clock_timestamp(), qt_min_inicio_w);
		dt_termino_prev_w	:= man_obter_hor_com(cd_estabelecimento_p, clock_timestamp(), qt_min_termino_w);
	end if;

	if	((not(ie_verifica_estagio_p = 'S')) or (coalesce(nr_seq_estagio_w,0) > 0)) then
		CALL wheb_usuario_pck.SET_IE_EXECUTAR_TRIGGER('N');
		
		update	man_ordem_serv_sla
		set	qt_min_inicio 	= qt_min_inicio_w,
			qt_min_termino	= qt_min_termino_w,
			dt_inicio_prev	= dt_inicio_prev_w,
			dt_termino_prev	= dt_termino_prev_w,
			nr_seq_status	= 415,
			ie_tempo		= ie_tempo_w,
			qt_desvio_inic	= 0,
			dt_inicio		 = NULL,
			qt_min_real_os	 = NULL,
			nr_seq_estagio	= nr_seq_estagio_w,
			nr_seq_sla	= nr_seq_sla_w,
			nr_seq_sla_regra	= nr_seq_sla_regra_w,
			ie_tipo_sla		= ie_tipo_sla_w,
			dt_atualizacao = clock_timestamp(),
			nm_usuario = nm_usuario_p
		where	nr_sequencia	= nr_seq_sla_p;

		CALL wheb_usuario_pck.SET_IE_EXECUTAR_TRIGGER('S');
	end if;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE man_atualizar_sla_os ( nr_seq_sla_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text, ie_prioridade_p text, ie_classificacao_p text, nr_seq_localizacao_p bigint, nr_seq_grupo_trab_p bigint, dt_ordem_servico_p timestamp, dt_inicio_p timestamp, nr_seq_estagio_p bigint, nr_seq_equipamento_p bigint, nr_seq_classif_p bigint, ie_parado_p text, ie_verifica_estagio_p text default 'S', ie_verifica_tipo_equip_p text default 'S') FROM PUBLIC;

