-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE inserir_prof_escala_regra ( nr_seq_escala_p bigint, dt_inicial_p timestamp, dt_final_p timestamp, dt_referencia_p timestamp, ds_lista_data_desc_p text, nm_usuario_p text) AS $body$
DECLARE

 
nr_sequencia_w		bigint;
dt_inicio_w		timestamp;
dt_inicio_aux_w		timestamp;
hr_inicial_w		varchar(20);
hr_final_w		varchar(20);
cd_pf_aux_w		varchar(10)	:= '0';
cd_pessoa_fisica_w	varchar(10)	:= '0';
ie_pf_escala_w		boolean		:= false;
vl_pos_w			bigint;
i			integer;
ds_lista_data_desc_w	varchar(32000);

C01 CURSOR FOR 
	SELECT	a.nr_sequencia, 
		trunc(a.dt_inicio) dt_inicio, 
		to_char(a.dt_inicio,'hh24:mi') hr_inicial, 
		to_char(a.dt_fim,'hh24:mi') hr_final 
	from	escala_diaria a 
	where	a.nr_seq_escala		= nr_seq_escala_p 
	and	coalesce(a.ie_profis_aleatorio,'N')	= 'N' 
	and	a.dt_inicio between dt_inicial_p and dt_final_p 
	and	coalesce(a.cd_pessoa_fisica::text, '') = '' 
	order by a.dt_inicio;

C02 CURSOR FOR 
	SELECT	x.cd_pessoa_fisica 
	from (SELECT	b.cd_pessoa_fisica, 
			b.nm_pessoa_fisica 
		from	pessoa_fisica b, 
			escala_horario_medico a 
		where	b.cd_pessoa_fisica	= a.cd_pessoa_fisica 
		and	a.hr_inicial	= hr_inicial_w 
		and	a.hr_final		= hr_final_w 
		and	obter_se_escala_horario_lib(a.nr_sequencia,nr_sequencia_w) = 'S' 
		
union
 
		select	cd_pessoa_fisica_w, 
			coalesce(substr(obter_nome_pf(cd_pessoa_fisica_w),1,60),' ') 
		 
		order by 2) x;


BEGIN 
ds_lista_data_desc_w := ds_lista_data_desc_p;
 
open C01;
loop 
fetch C01 into 
	nr_sequencia_w, 
	dt_inicio_w, 
	hr_inicial_w, 
	hr_final_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin 
	if (coalesce(ds_lista_data_desc_w,'X') <> 'X') and (instr(ds_lista_data_desc_w,';',1,2) > 2) then 
		begin 
		vl_pos_w	:= position(';' in ds_lista_data_desc_w) + 1;
		i		:= 1;
 
		while(vl_pos_w > 0) and (instr(ds_lista_data_desc_w,';',vl_pos_w) > vl_pos_w) loop 
			begin 
			i	:= i + 1;
 
			begin 
			dt_inicio_aux_w	:= to_date(substr(ds_lista_data_desc_w,vl_pos_w,instr(ds_lista_data_desc_w,';',1,i) - vl_pos_w));
			exception 
			when others then 
				dt_inicio_aux_w := null;
			end;
 
			if (dt_inicio_aux_w IS NOT NULL AND dt_inicio_aux_w::text <> '') and (dt_inicio_aux_w = dt_inicio_w) then 
				goto continue_loop;
			end if;
 
			vl_pos_w := instr(ds_lista_data_desc_w,';',1,i) + 1;
			end;
		end loop;
		end;
	end if;
 
	begin 
	select	x.cd_profissional_regra 
	into STRICT	cd_pessoa_fisica_w 
	from (SELECT	a.cd_profissional_regra, 
			a.dt_inicio 
		from	escala_horario_medico b, 
			escala_diaria a 
		where	a.cd_profissional_regra	= b.cd_pessoa_fisica 
		and	a.nr_seq_escala		= nr_seq_escala_p 
		and	coalesce(a.ie_profis_aleatorio,'N')	= 'N' 
		and	to_char(a.dt_inicio,'hh24:mi')	= b.hr_inicial 
		and	to_char(a.dt_fim,'hh24:mi')	= b.hr_final 
		and	b.hr_inicial		= hr_inicial_w 
		and	b.hr_final			= hr_final_w 
		and	a.dt_inicio between dt_referencia_p and dt_final_p 
		and	obter_se_escala_horario_lib(b.nr_sequencia,a.nr_sequencia) = 'S' 
		and	obter_se_escala_horario_lib(b.nr_sequencia,nr_sequencia_w) = 'S' 
		
union all
 
		SELECT	a.cd_profissional_regra, 
			a.dt_inicio 
		from	escala_horario_medico b, 
			escala_diaria a 
		where	a.cd_profissional_regra	= b.cd_pessoa_fisica 
		and	a.nr_seq_escala		= nr_seq_escala_p 
		and	coalesce(a.ie_profis_aleatorio,'N')	= 'N' 
		and	to_char(a.dt_inicio,'hh24:mi')	= b.hr_inicial 
		and	to_char(a.dt_fim,'hh24:mi')	= b.hr_final 
		and	b.hr_inicial		<> hr_inicial_w 
		and	b.hr_final			<> hr_final_w 
		and	a.dt_inicio between dt_referencia_p and dt_final_p 
		and	obter_se_esc_horario_vinc_lib(b.nr_sequencia,a.nr_sequencia,nr_sequencia_w) = 'S' 
		and	obter_se_esc_horario_vinc_lib(b.nr_sequencia,nr_sequencia_w,null) = 'S' 
		and exists (	select	1 
				from	escala_horario_medico x 
				where	x.hr_inicial	= hr_inicial_w 
				and	x.hr_final	= hr_final_w 
				and	(x.cd_pessoa_fisica IS NOT NULL AND x.cd_pessoa_fisica::text <> '') 
				and	obter_se_esc_horario_vinc_lib(x.nr_sequencia,nr_sequencia_w,a.nr_sequencia) = 'S') 
		order by 2 desc) x LIMIT 1;
	exception 
	when others then 
		cd_pessoa_fisica_w := '0';
	end;
 
	open C02;
	loop 
	fetch C02 into	 
		cd_pf_aux_w;
	EXIT WHEN NOT FOUND; /* apply on C02 */
		begin 
		if (cd_pf_aux_w = cd_pessoa_fisica_w) then 
			ie_pf_escala_w		:= true;
		elsif (ie_pf_escala_w) then 
			begin 
			cd_pessoa_fisica_w	:= cd_pf_aux_w;
			ie_pf_escala_w		:= false;
			exit;
			end;
		end if;
		end;
	end loop;
	close C02;
 
	if (ie_pf_escala_w) then 
		begin 
		cd_pessoa_fisica_w	:= '0';
		ie_pf_escala_w		:= false;
		end;
	end if;
 
	if (cd_pessoa_fisica_w = '0') then 
		begin 
		select	x.cd_pessoa_fisica 
		into STRICT	cd_pessoa_fisica_w 
		from (SELECT	b.cd_pessoa_fisica 
			from	pessoa_fisica b, 
				escala_horario_medico a 
			where	b.cd_pessoa_fisica	= a.cd_pessoa_fisica 
			and	a.hr_inicial	= hr_inicial_w 
			and	a.hr_final		= hr_final_w 
			and	obter_se_escala_horario_lib(a.nr_sequencia,nr_sequencia_w) = 'S' 
			order by b.nm_pessoa_fisica) x LIMIT 1;
		exception 
		when others then 
			cd_pessoa_fisica_w := '0';
		end;
	end if;
 
	if (cd_pessoa_fisica_w <> '0') then 
		update	escala_diaria 
		set	cd_pessoa_fisica	= cd_pessoa_fisica_w, 
			cd_pessoa_origem	= cd_pessoa_fisica_w, 
			cd_profissional_regra	= cd_pessoa_fisica_w, 
			ie_profis_aleatorio	= 'N', 
			dt_atualizacao	= clock_timestamp(), 
			nm_usuario	= nm_usuario_p 
		where	nr_sequencia	= nr_sequencia_w;
	end if;
	 
	<<continue_loop>> 
	null;
	end;
end loop;
close C01;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE inserir_prof_escala_regra ( nr_seq_escala_p bigint, dt_inicial_p timestamp, dt_final_p timestamp, dt_referencia_p timestamp, ds_lista_data_desc_p text, nm_usuario_p text) FROM PUBLIC;

