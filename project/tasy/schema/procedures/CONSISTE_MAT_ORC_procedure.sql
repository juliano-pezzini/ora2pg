-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE consiste_mat_orc ( nr_seq_orcamento_p bigint, cd_material_p bigint, qt_material_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text, ie_autorizacao_p INOUT text, ie_regra_p INOUT text ) AS $body$
DECLARE

				
nr_atendimento_w		bigint;				
dt_orcamento_w		timestamp;
ie_tipo_atendimento_w	bigint;
cd_convenio_w		bigint;
cd_categoria_w		varchar(20);
cd_plano_w		varchar(10);
ie_glosa_w		varchar(20);
ds_retorno_w		varchar(200);
nr_retorno_w		double precision;
ie_regra_w		varchar(10);
ie_consiste_glosa_partic_w 	varchar(10);
ie_consiste_regra_plano_w	varchar(10);


BEGIN


ie_consiste_glosa_partic_w := Obter_Param_Usuario(106, 44, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_consiste_glosa_partic_w);
ie_consiste_regra_plano_w := Obter_Param_Usuario(106, 28, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_consiste_regra_plano_w);

select 	coalesce(nr_atendimento,0),
	dt_orcamento,
	coalesce(ie_tipo_atendimento,0),
	cd_convenio,
	cd_categoria,
	cd_plano
into STRICT	nr_atendimento_w,
	dt_orcamento_w,
	ie_tipo_atendimento_w,
	cd_convenio_w,	
	cd_categoria_w,
	cd_plano_w
from	orcamento_paciente
where	nr_sequencia_orcamento  =  nr_seq_orcamento_p;

if (ie_consiste_glosa_partic_w = 'S') then

	SELECT * FROM glosa_material(	cd_estabelecimento_p, 	-- cd_estabelecimento_p
			nr_atendimento_w,        -- nr_atendimento_p
			dt_orcamento_w,          -- dt_atendimento_p
			cd_material_p,           -- cd_material_p
			qt_material_p,           -- qt_material_p
			0,                       -- cd_tipo_acomodacao_p
			ie_tipo_atendimento_w,   -- ie_tipo_atendimento_p
			0,                       -- cd_setor_atendimento_p
			0,                       -- qt_idade_p
			0,                       -- cd_proc_referencia_p
			0,                       -- ie_origem_proced_p
			0,                       -- nr_sequencia_p
			0,                       -- nr_seq_proc_interno_p
			cd_convenio_w, 	        -- cd_convenio_p     	 in
			cd_categoria_w,          -- cd_categoria_p    	 in
			nr_retorno_w,            -- ie_tipo_convenio_p	 out
			ds_retorno_w,            -- ie_classif_convenio_p out
			ds_retorno_w,            -- cd_autorizacao_p    	 out
			nr_retorno_w,            -- nr_seq_autorizacao_p  out
			nr_retorno_w,            -- qt_autorizada_p    	 out
			ds_retorno_w,            -- cd_senha_p    	 out
			ds_retorno_w,            -- nm_responsavel_p    	 out
			ie_glosa_w,              -- ie_glosa_p		 out
			nr_retorno_w,            -- cd_situacao_glosa_p	 out
			nr_retorno_w,            -- pr_glosa_p		 out
			nr_retorno_w, 		-- vl_glosa_p		 out
			nr_retorno_w,            -- cd_motivo_exc_conta_p out
			ds_retorno_w,            -- ie_autor_particular_p out
			nr_retorno_w,            -- cd_convenio_glosa_p	 out
			ds_retorno_w,            -- cd_categoria_glosa_p	 out
			nr_retorno_w,            -- nr_seq_regra_ajuste_p out
			nr_seq_orcamento_p) INTO STRICT 
			cd_convenio_w, 
			cd_categoria_w, 
			nr_retorno_w, 
			ds_retorno_w, 
			ds_retorno_w, 
			nr_retorno_w, 
			nr_retorno_w, 
			ds_retorno_w, 
			ds_retorno_w, 
			ie_glosa_w, 
			nr_retorno_w, 
			nr_retorno_w, 
			nr_retorno_w, 
			nr_retorno_w, 
			ds_retorno_w, 
			nr_retorno_w, 
			ds_retorno_w, 
			nr_retorno_w;    -- nr_seq_orcamento_p	 in
end if;

if (ie_glosa_w <> 'L') then
	ie_autorizacao_p	:= 'B';
	ie_regra_p		:= 0;
elsif (coalesce(cd_plano_w, '0') <> '0') and (ie_consiste_regra_plano_w = 'S' or
	ie_consiste_regra_plano_w = 'M') then
	
	SELECT * FROM consiste_mat_plano_convenio(	cd_convenio_w, cd_plano_w, cd_material_p, nr_atendimento_w, 0, ds_retorno_w, ds_retorno_w, ie_regra_w, nr_retorno_w, qt_material_p, dt_orcamento_w, null, cd_estabelecimento_p, cd_categoria_w, ie_tipo_atendimento_w) INTO STRICT ds_retorno_w, ds_retorno_w, ie_regra_w, nr_retorno_w;
					
	if (ie_regra_w = '1')  or (ie_regra_w = '2') then
		ie_autorizacao_p := 'B';
	elsif (ie_regra_w = '3') then
		ie_autorizacao_p := 'P';
	end if;
	
	ie_regra_p	:= ie_regra_w;	
end if;	

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE consiste_mat_orc ( nr_seq_orcamento_p bigint, cd_material_p bigint, qt_material_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text, ie_autorizacao_p INOUT text, ie_regra_p INOUT text ) FROM PUBLIC;

