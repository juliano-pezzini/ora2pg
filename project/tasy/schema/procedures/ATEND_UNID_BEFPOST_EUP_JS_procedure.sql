-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE atend_unid_befpost_eup_js ( nr_acompanhante_p bigint, cd_senha_p text, nr_doc_convenio_p text, dt_entrada_p timestamp, nr_seq_queixa_p bigint, cd_medico_resp_p text, nr_seq_tipo_acidente_p bigint, nr_seq_cobertura_p bigint, cd_procedencia_p bigint, cd_empresa_p bigint, ie_clinica_p bigint, nr_seq_classificacao_p bigint, cd_estab_atend_p bigint, nr_seq_agrupamento_p bigint, cd_tipo_acomod_conv_p bigint, cd_categoria_p text, cd_tipo_acomodacao_p bigint, ie_tipo_atendimento_p bigint, ie_insert_p text, cd_pessoa_fisica_p text, cd_unidade_compl_p text, cd_unidade_basica_p text, nr_atendimento_p bigint, cd_convenio_p bigint, cd_plano_p text, cd_setor_atendimento_p bigint, ie_edicao_p text, dt_saida_p timestamp, dt_saida_old_p timestamp, nm_usuario_p text, ds_msg_abort_p INOUT text, ds_msg_setor_lib_abort_p INOUT text, ds_msg_setor_lib_inf_p INOUT text, ds_msg_setor_lib_excl_p INOUT text, ds_msg_exclui_atend_p INOUT text, ie_situacao_unid_p INOUT text, nr_seq_interno_unid_p INOUT text, cd_classif_setor_p INOUT bigint, qt_regra_inf_diag_p INOUT bigint, ie_necessita_vaga_p INOUT text, ds_msg_acomp_abort_p INOUT text, ds_msg_acomp_confi_p INOUT text, ds_msg_nome_pac_abort_p INOUT text, ds_msg_nome_pac_conf_p INOUT text) AS $body$
DECLARE

 
cd_estabelecimento_w		smallint;
ie_setor_acomod_w		varchar(1);
ie_acomod_lib_categ_w		varchar(2);
ie_tipo_acomod_convenio_w	varchar(1);
ie_inativa_unid_agrup_w		varchar(1);
ie_regra_setor_medico_conv_w	varchar(1);
ie_consist_num_acomp_w		varchar(2);
ie_consist_nome_pac_w		varchar(2);
ie_inat_unid_inter_pac_w	varchar(2);
					

BEGIN 
 
cd_estabelecimento_w := wheb_usuario_pck.get_cd_estabelecimento;
 
ie_setor_acomod_w := Obter_param_Usuario(916, 94, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_setor_acomod_w);
ie_tipo_acomod_convenio_w := Obter_param_Usuario(916, 266, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_tipo_acomod_convenio_w);
ie_acomod_lib_categ_w := Obter_param_Usuario(916, 276, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_acomod_lib_categ_w);
ie_regra_setor_medico_conv_w := Obter_param_Usuario(916, 652, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_regra_setor_medico_conv_w);
ie_inat_unid_inter_pac_w := Obter_param_Usuario(916, 737, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_inat_unid_inter_pac_w);
ie_consist_num_acomp_w := Obter_param_Usuario(916, 991, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_consist_num_acomp_w);
 
ie_consist_nome_pac_w := Obter_param_Usuario(3111, 304, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_consist_nome_pac_w);
 
ds_msg_abort_p := atend_unid_befpost_abort_js(nr_seq_agrupamento_p, cd_tipo_acomod_conv_p, ie_tipo_acomod_convenio_w, cd_estabelecimento_w, cd_categoria_p, ie_acomod_lib_categ_w, cd_tipo_acomodacao_p, ie_tipo_atendimento_p, ie_setor_acomod_w, ie_insert_p, cd_pessoa_fisica_p, cd_unidade_compl_p, cd_unidade_basica_p, nr_atendimento_p, cd_convenio_p, cd_plano_p, cd_setor_atendimento_p, ie_edicao_p, dt_saida_p, dt_saida_old_p, nm_usuario_p, ds_msg_abort_p);
if (ds_msg_abort_p IS NOT NULL AND ds_msg_abort_p::text <> '') then 
	goto final;
end if;
 
SELECT * FROM atend_unid_befpost_conf_js(ie_consist_nome_pac_w, nr_acompanhante_p, cd_unidade_compl_p, cd_unidade_basica_p, ie_consist_num_acomp_w, cd_senha_p, nr_doc_convenio_p, cd_estab_atend_p, cd_convenio_p, cd_categoria_p, ie_tipo_atendimento_p, nr_seq_classificacao_p, cd_setor_atendimento_p, cd_plano_p, ie_clinica_p, cd_empresa_p, cd_procedencia_p, nr_seq_cobertura_p, nr_seq_tipo_acidente_p, cd_tipo_acomodacao_p, cd_medico_resp_p, cd_pessoa_fisica_p, nr_atendimento_p, nr_seq_queixa_p, dt_entrada_p, ds_msg_setor_lib_abort_p, ds_msg_setor_lib_inf_p, ds_msg_setor_lib_excl_p, ds_msg_exclui_atend_p, ds_msg_acomp_abort_p, ds_msg_acomp_confi_p, ds_msg_nome_pac_abort_p, ds_msg_nome_pac_conf_p) INTO STRICT ds_msg_setor_lib_abort_p, ds_msg_setor_lib_inf_p, ds_msg_setor_lib_excl_p, ds_msg_exclui_atend_p, ds_msg_acomp_abort_p, ds_msg_acomp_confi_p, ds_msg_nome_pac_abort_p, ds_msg_nome_pac_conf_p;
if (ds_msg_setor_lib_abort_p IS NOT NULL AND ds_msg_setor_lib_abort_p::text <> '') or (ds_msg_acomp_abort_p IS NOT NULL AND ds_msg_acomp_abort_p::text <> '') then 
	goto final;
end if;
	 
if (coalesce(cd_setor_atendimento_p,0) > 0) then 
	 
	if (ie_inat_unid_inter_pac_w = 'S') and (ie_insert_p = 'S') then 
		 
		select	max(ie_situacao) 
		into STRICT	ie_situacao_unid_p 
		from  unidade_atendimento                                  
		where  cd_setor_atendimento = cd_setor_atendimento_p 
		and   cd_unidade_basica = cd_unidade_basica_p 
		and   cd_unidade_compl = cd_unidade_compl_p;
		 
		select	max(nr_seq_interno) 
		into STRICT	nr_seq_interno_unid_p 
		from  unidade_atendimento       
		where  cd_setor_atendimento = cd_setor_atendimento_p 
		and   cd_unidade_basica = cd_unidade_basica_p 
		and   cd_unidade_compl = cd_unidade_compl_p;
	end if;	
	 
	select	cd_classif_setor 
	into STRICT	cd_classif_setor_p 
	from 	setor_atendimento 
	where cd_setor_atendimento = cd_setor_atendimento_p;
	 
	select	coalesce(max(ie_verifica_se_gv),'N') 
	into STRICT	ie_necessita_vaga_p 
	from	setor_atendimento 
	where 	cd_setor_atendimento = cd_setor_atendimento_p;
 
end if;
 
if (ie_regra_setor_medico_conv_w = 'S') then	 
	CALL obter_se_med_lib_conv_setor(cd_medico_resp_p, cd_convenio_p, cd_setor_atendimento_p, null);
end if;
 
select	coalesce(max(1),0) 
into STRICT	qt_regra_inf_diag_p 
from	regra_cons_inf_diag_eup 
where 	cd_procedencia = cd_procedencia_p 
and  	ie_tipo_atendimento = ie_tipo_atendimento_p;
 
 
<<final>> 
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE atend_unid_befpost_eup_js ( nr_acompanhante_p bigint, cd_senha_p text, nr_doc_convenio_p text, dt_entrada_p timestamp, nr_seq_queixa_p bigint, cd_medico_resp_p text, nr_seq_tipo_acidente_p bigint, nr_seq_cobertura_p bigint, cd_procedencia_p bigint, cd_empresa_p bigint, ie_clinica_p bigint, nr_seq_classificacao_p bigint, cd_estab_atend_p bigint, nr_seq_agrupamento_p bigint, cd_tipo_acomod_conv_p bigint, cd_categoria_p text, cd_tipo_acomodacao_p bigint, ie_tipo_atendimento_p bigint, ie_insert_p text, cd_pessoa_fisica_p text, cd_unidade_compl_p text, cd_unidade_basica_p text, nr_atendimento_p bigint, cd_convenio_p bigint, cd_plano_p text, cd_setor_atendimento_p bigint, ie_edicao_p text, dt_saida_p timestamp, dt_saida_old_p timestamp, nm_usuario_p text, ds_msg_abort_p INOUT text, ds_msg_setor_lib_abort_p INOUT text, ds_msg_setor_lib_inf_p INOUT text, ds_msg_setor_lib_excl_p INOUT text, ds_msg_exclui_atend_p INOUT text, ie_situacao_unid_p INOUT text, nr_seq_interno_unid_p INOUT text, cd_classif_setor_p INOUT bigint, qt_regra_inf_diag_p INOUT bigint, ie_necessita_vaga_p INOUT text, ds_msg_acomp_abort_p INOUT text, ds_msg_acomp_confi_p INOUT text, ds_msg_nome_pac_abort_p INOUT text, ds_msg_nome_pac_conf_p INOUT text) FROM PUBLIC;

