-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE san_doacao_afterpost_hemoterap ( ie_atualiza_sangue_p text, nr_seq_doacao_p bigint, nr_seq_exame_lote_p bigint, pr_hematocrito_p bigint, nr_seq_campanha_doacao_p bigint, cd_pessoa_fisica_p text, ie_opcao_p text, dt_registro_p timestamp, ds_observacao_p text, cd_perfil_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text, ds_brinde_p INOUT text, nr_seq_mensagem_p INOUT bigint) AS $body$
DECLARE

 
ie_atualiza_hematocrito_w			varchar(1);
ie_atualizar_data_retorno_w			varchar(1);
ie_atualizar_dados_paciente_w			varchar(1);
ie_preenche_auto_dados_tf_w			varchar(1);
nr_seq_hematocrito_w	bigint;
nr_sangue_w		varchar(20);
ie_numero_bolsa_w				varchar(1);
ie_fim_num_retorno_p				varchar(1);
ie_seq_isbt_existe_p				varchar(1);


BEGIN 
 
if (ie_atualiza_sangue_p = 'S') then 
	begin 
	nr_sangue_w	:= obter_numero_sangue_seq(cd_estabelecimento_p);
 
	CALL san_atualizar_numero_sangue(nr_seq_doacao_p, nr_sangue_w);
	 
	select	coalesce(max(ie_numero_bolsa),'N') 
	into STRICT	ie_numero_bolsa_w 
	from	san_parametro 
	where	cd_estabelecimento = cd_estabelecimento_p;
	 
	if (ie_numero_bolsa_w = 'S') then 
		CALL San_atualizar_numero_bolsa(nr_seq_doacao_p, nr_sangue_w);
	end if;
	end;
end if;
 
/* Hemoterapia - Parâmetro [45] - Ao informar o percentual para Hematócrito, atualizar o resultado do exame na triagem */
 
ie_atualiza_hematocrito_w := obter_param_usuario(450, 45, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_atualiza_hematocrito_w);
 
if (ie_atualiza_hematocrito_w = 'S') then 
	begin 
	select	max(nr_seq_hematocrito) 
	into STRICT	nr_seq_hematocrito_w 
	from	san_parametro;
 
	if (nr_seq_hematocrito_w IS NOT NULL AND nr_seq_hematocrito_w::text <> '') and (nr_seq_exame_lote_p IS NOT NULL AND nr_seq_exame_lote_p::text <> '') then 
		begin 
		update	san_exame_realizado 
		set	vl_resultado	= pr_hematocrito_p 
		where	nr_seq_exame	= nr_seq_hematocrito_w 
		and	san_obter_destino_exame(nr_seq_exame, 1) = 'S' 
		and	nr_seq_exame_lote	= nr_seq_exame_lote_p;
		end;
	end if;
	end;
end if;
 
commit;
 
/* Hemoterapia - Parâmetro [110] - Atualizar automaticamente a data de retorno da doação */
 
ie_atualizar_data_retorno_w := obter_param_usuario(450, 110, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_atualizar_data_retorno_w);
 
if (ie_atualizar_data_retorno_w = 'S') then 
	CALL atualizar_data_retorno_doador(nr_seq_doacao_p, nm_usuario_p);
end if;
 
if (nr_seq_campanha_doacao_p IS NOT NULL AND nr_seq_campanha_doacao_p::text <> '') and (nr_seq_campanha_doacao_p > 0) then 
	CALL san_atualizar_doacao_campanha(nr_seq_campanha_doacao_p, nr_seq_doacao_p);
end if;
 
/* Hemoterapia - Parâmetro [274] - Ao cadastrar uma doação, registrar as informações dos sinais vitais do PEP */
 
ie_atualizar_dados_paciente_w := obter_param_usuario(450, 274, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_atualizar_dados_paciente_w);
 
if (ie_atualizar_dados_paciente_w = 'S') then	 
	CALL san_atualizar_dados_doador(nr_seq_doacao_p);
end if;
 
SELECT * FROM San_gerar_seq_ISBT(nr_seq_doacao_p, nm_usuario_p, ie_fim_num_retorno_p, ie_seq_isbt_existe_p) INTO STRICT ie_fim_num_retorno_p, ie_seq_isbt_existe_p;
if (ie_fim_num_retorno_p = 'S') then 
	nr_seq_mensagem_p	:= 291187;
elsif (ie_seq_isbt_existe_p = 'S') then 
	nr_seq_mensagem_p	:= 333497; 	
end if;
 
/*[360] - Ao realizar a amostra de reteste preencher automaticamente as informações da triagem física*/
 
/*obter_param_usuario(450, 360, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_preenche_auto_dados_tf_w); 
if	(ie_preenche_auto_dados_tf_w = 'S') then 
	san_atualizar_dados_amostra( 
	nr_seq_doacao_p, 
	nm_usuario_p); 
	 
end if;*/
 
 
 
ds_brinde_p := san_consistir_brindes_doacao( 
	nr_seq_doacao_p, cd_pessoa_fisica_p, ie_opcao_p, dt_registro_p, ds_observacao_p, ds_brinde_p, cd_perfil_p, nm_usuario_p, cd_estabelecimento_p);
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE san_doacao_afterpost_hemoterap ( ie_atualiza_sangue_p text, nr_seq_doacao_p bigint, nr_seq_exame_lote_p bigint, pr_hematocrito_p bigint, nr_seq_campanha_doacao_p bigint, cd_pessoa_fisica_p text, ie_opcao_p text, dt_registro_p timestamp, ds_observacao_p text, cd_perfil_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text, ds_brinde_p INOUT text, nr_seq_mensagem_p INOUT bigint) FROM PUBLIC;

