-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE qt_consistir_pac_prof ( nr_seq_prof_p bigint, nr_seq_local_p bigint, dt_agenda_p timestamp, qt_tempo_prep_pac_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint, nr_seq_Agenda_p bigint, ds_resultado_p INOUT text) AS $body$
DECLARE


qt_agendado_w		bigint;
qt_marcado_w		bigint;
ie_pac_local_w		varchar(1);
ie_prof_hor_w		varchar(1);


BEGIN

if (nr_seq_prof_p	> 0) then
	select	count(*)
	into STRICT	qt_agendado_w
	from	agenda_quimio
	where	dt_agenda_p between dt_agenda and dt_agenda + (qt_tempo_prep_pac_p - 1) / 1440
	and (nr_sequencia	<> nr_seq_agenda_p or coalesce(nr_seq_agenda_p::text, '') = '')
	and	nr_seq_prof	= nr_seq_prof_p
	and	ie_status_Agenda <> 'C';

	select	count(*)
	into STRICT	qt_marcado_w
	from	agenda_quimio_marcacao
	where	dt_agenda_p between dt_agenda and dt_agenda + (qt_tempo_prep_pac_p - 1) / 1440
	and	nr_seq_prof	= nr_seq_prof_p;

	ie_pac_local_w	:= Qt_Obter_Se_Pac_Local(nr_seq_prof_p, nr_seq_local_p);

	ie_prof_hor_w	:= Qt_Obter_Se_Prof_Hor(nr_seq_prof_p, dt_agenda_p, cd_estabelecimento_p);

	if (ie_pac_local_w	= 'N') then
		ds_resultado_p	:= 'L';
	elsif (ie_prof_hor_w	= 'N') then
		ds_resultado_p	:= 'H';
	elsif (qt_Agendado_w	> 0) or (qt_marcado_w	> 0) then
		ds_resultado_p	:= 'M';
	end if;
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE qt_consistir_pac_prof ( nr_seq_prof_p bigint, nr_seq_local_p bigint, dt_agenda_p timestamp, qt_tempo_prep_pac_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint, nr_seq_Agenda_p bigint, ds_resultado_p INOUT text) FROM PUBLIC;

