-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE man_gerar_usuario_executor ( nr_sequencia_p bigint, nm_usuario_p text, ie_opcao_p text) AS $body$
DECLARE


nm_usuario_exec_w	varchar(60);
nr_seq_servico_w		bigint;
qt_existe_w		bigint;
nr_seq_tipo_exec_w	bigint;
cd_setor_atendimento_w	integer;
ie_usuario_servico_w	varchar(5);

/*ie_opcao_p
1 - Líder do grupo desenvolvimento
2 - Usuário executor do serviço
3 - Líder do grupo do suporte

*/
C01 CURSOR FOR
	SELECT	nm_usuario_executor,
		nr_seq_tipo_exec
	from	servico_setor_define_exec a,
		servico_setor_atend_exec b
	where	b.cd_setor_atendimento	= cd_setor_atendimento_w
	and	b.nr_seq_servico		= nr_seq_servico_w
	and	b.nr_sequencia		= a.nr_seq_servico_setor
	and	coalesce(dt_inicio_vigencia,clock_timestamp()) <= clock_timestamp()
	and	coalesce(dt_fim_vigencia,clock_timestamp())	>= clock_timestamp();


BEGIN

if (ie_opcao_p = '1') then
	select	max(c.nm_usuario_grupo)
	into STRICT	nm_usuario_exec_w
	from	grupo_desenvolvimento a,
		man_ordem_servico b,
		usuario_grupo_des c
	where	a.nr_sequencia = c.nr_seq_grupo
	and	c.ie_funcao_usuario = 'S'
	and	b.nr_sequencia = nr_sequencia_p
	and	a.nr_sequencia = b.nr_seq_grupo_des;

elsif (ie_opcao_p = '2') then
	select	nr_seq_servico,
		cd_setor_atendimento
	into STRICT	nr_seq_servico_w,
		cd_setor_atendimento_w
	from	man_ordem_servico
	where	nr_sequencia = nr_sequencia_p;

	if (coalesce(nr_seq_servico_w,0) > 0) then
		begin
		open C01;
		loop
		fetch C01 into
			nm_usuario_exec_w,
			nr_seq_tipo_exec_w;
		EXIT WHEN NOT FOUND; /* apply on C01 */
			begin
			if (coalesce(nm_usuario_exec_w,'X') <> 'X') then
				begin
				select	count(*)
				into STRICT	qt_existe_w
				from	man_ordem_servico_exec
				where	nr_seq_ordem 	= nr_sequencia_p
				and	nm_usuario_exec	= nm_usuario_exec_w;

				select	substr(man_obter_se_usuario_servico(nr_seq_servico_w, nm_usuario_exec_w,obter_setor_usuario(nm_usuario_exec_w), 'E'),1,1)
				into STRICT	ie_usuario_servico_w
				;

				if (qt_existe_w = 0) and (ie_usuario_servico_w <> 'N') then
					insert 	into man_ordem_servico_exec(
						nr_sequencia,
						nr_seq_ordem,
						dt_atualizacao,
						nm_usuario,
						nm_usuario_exec,
						qt_min_prev,
						dt_ult_visao,
						nr_seq_funcao,
						dt_recebimento,
						nr_seq_tipo_exec)
					values (	nextval('man_ordem_servico_exec_seq'),
						nr_sequencia_p,
						clock_timestamp(),
						nm_usuario_p,
						nm_usuario_exec_w,
						null,
						null,
						null,
						clock_timestamp(),
						nr_seq_tipo_exec_w);
				end if;
				end;
			end if;
			end;
		end loop;
		close C01;
		end;
	end if;
elsif (ie_opcao_p = '3') then
	select	max(a.nm_usuario_lider)
	into STRICT	nm_usuario_exec_w
	from	grupo_suporte a,
		man_ordem_servico b
	where	b.nr_sequencia = nr_sequencia_p
	and	a.nr_sequencia = b.nr_seq_grupo_sup;
end if;

if (coalesce(nm_usuario_exec_w,'X') <> 'X') and (ie_opcao_p <> '2') then
	begin
	select	count(*)
	into STRICT	qt_existe_w
	from	man_ordem_servico_exec
	where	nr_seq_ordem 	= nr_sequencia_p
	and	nm_usuario_exec	= nm_usuario_exec_w;

	if (qt_existe_w = 0) then
		insert 	into man_ordem_servico_exec(
			nr_sequencia,
			nr_seq_ordem,
			dt_atualizacao,
			nm_usuario,
			nm_usuario_exec,
			qt_min_prev,
			dt_ult_visao,
			nr_seq_funcao,
			dt_recebimento,
			nr_seq_tipo_exec)
		values (	nextval('man_ordem_servico_exec_seq'),
			nr_sequencia_p,
			clock_timestamp(),
			nm_usuario_p,
			nm_usuario_exec_w,
			null,
			null,
			null,
			clock_timestamp(),
			nr_seq_tipo_exec_w);
	end if;
	end;
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE man_gerar_usuario_executor ( nr_sequencia_p bigint, nm_usuario_p text, ie_opcao_p text) FROM PUBLIC;

