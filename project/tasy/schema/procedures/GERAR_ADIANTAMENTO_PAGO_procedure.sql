-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_adiantamento_pago (nr_titulo_p bigint, nm_usuario_p text) AS $body$
DECLARE


cd_estabelecimento_w	smallint;
dt_liquidacao_w		timestamp;
vl_titulo_w		double precision;
CD_MOEDA_PADRAO_w	integer;
cd_cgc_w		varchar(14);
cd_pessoa_fisica_w	varchar(10);
ie_tipo_titulo_w	varchar(5);
ie_situacao_w		varchar(5);
ie_adiant_liq_tit_w	varchar(1);
vl_adiantamento_w	double precision;
vl_saldo_titulo_w	double precision;
nr_adiantamento_w	bigint;
nr_sequencia_w		bigint;


BEGIN

select	a.cd_estabelecimento,
	a.dt_liquidacao,
	a.vl_titulo,
	b.CD_MOEDA_PADRAO,
	a.cd_cgc,
	a.cd_pessoa_fisica,
	a.ie_tipo_titulo,
	a.ie_situacao,
	coalesce(b.ie_adiant_liq_tit,'S'),
	vl_saldo_titulo
into STRICT	cd_estabelecimento_w,
	dt_liquidacao_w,
	vl_titulo_w,
	CD_MOEDA_PADRAO_w,
	cd_cgc_w,
	cd_pessoa_fisica_w,
	ie_tipo_titulo_w,
	ie_situacao_w,
	ie_adiant_liq_tit_w,
	vl_saldo_titulo_w
from	PARAMETROS_CONTAS_PAGAR b,
	titulo_pagar a
where	a.cd_estabelecimento	= b.cd_estabelecimento
and	a.nr_titulo		= nr_titulo_p;

select	coalesce(max(nr_adiantamento),0)
into STRICT	nr_adiantamento_w
from	adiantamento_pago
where	nr_titulo_original	= nr_titulo_p
and	vl_saldo		> 0;

if (nr_adiantamento_w 	= 0) and (ie_tipo_titulo_w	= '5') and (dt_liquidacao_w IS NOT NULL AND dt_liquidacao_w::text <> '') and (ie_situacao_w		= 'L') and (ie_adiant_liq_tit_w	= 'S') then

	insert into ADIANTAMENTO_PAGO(NR_ADIANTAMENTO,
		CD_ESTABELECIMENTO,
		DT_ATUALIZACAO,
		NM_USUARIO,
		DT_ADIANTAMENTO,
		VL_ADIANTAMENTO,
		VL_SALDO,
		CD_MOEDA,
		CD_PESSOA_FISICA,
		CD_CGC,
		CD_BANCO,
		NR_LOTE_CONTABIL,
		DS_OBSERVACAO,
		DT_BAIXA,
		NR_SEQ_TRANS_FIN,
		nr_titulo_original)
	values (nextval('adiantamento_pago_seq'),
		cd_estabelecimento_w,
		clock_timestamp(),
		nm_usuario_p,
		DT_LIQUIDACAO_w,
		vl_titulo_w,
		vl_titulo_w,
		CD_MOEDA_PADRAO_w,
		cd_pessoa_fisica_w,
		cd_cgc_w,
		null,
		null,
		null,
		null,
		null,
		nr_titulo_p);
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_adiantamento_pago (nr_titulo_p bigint, nm_usuario_p text) FROM PUBLIC;

