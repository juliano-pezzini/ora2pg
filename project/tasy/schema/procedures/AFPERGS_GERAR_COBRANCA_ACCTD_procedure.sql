-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE afpergs_gerar_cobranca_acctd ( nr_seq_cobr_escrit_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) AS $body$
DECLARE

 
 
nr_sequencia_w		bigint	:= 0;
ds_seq_w		varchar(15);
ds_conteudo_w		varchar(500);
vl_soma_tit_w		double precision	:= 0;

/* ######## VARIÁVEIS HEADER ######## */
 
ie_tipo_registro_w	varchar(2);
ds_remessa_retorno_w	varchar(10);
cd_conta_w		varchar(15);
ds_fixo_w		varchar(10);
dt_emissao_w		varchar(10);

 
/* ######## VARIÁVEIS DETALHE ######## */
 
--ie_tipo_registro_w	varchar2(2); 
--cd_conta_w		varchar2(15); 
cd_pessoa_fisica_w	varchar(14);
nr_titulo_w		varchar(10);
cd_especie_w		varchar(4);
cd_competencia_w	varchar(20);
dt_vencimento_w		varchar(10);
vl_titulo_w		double precision	:= 0;
vl_titulo_format_w	varchar(15);
cd_banco_w		varchar(3);
cd_inadimplencia_w	varchar(1);
cd_aceite_w		varchar(1);
--dt_emissao_w		varchar2(6); 
nm_associado_w		varchar(40);
ds_endereco_w		varchar(50);
cd_cep_w		varchar(8);
ds_cidade_w		varchar(15);
ds_uf_w			valor_dominio.vl_dominio%type;

 
/* ######## VARIÁVEIS TRAILER ######## */
 
--ie_tipo_registro_w	varchar2(2); 
vl_total_titulo_w	varchar(15);

 
C01 CURSOR FOR 
	SELECT	rpad(to_char(d.nr_sequencia),10,' ') cd_pessoa_fisica, 
		rpad(lpad(b.nr_titulo,8,'0')||lpad(calcula_digito('BANRISUL',lpad(b.nr_titulo,8,'0')),2,'0'),10,' ') nr_titulo, 
		rpad('Competência '|| to_char(dt_remessa_retorno,'mm/yyyy'),19,' ') cd_competencia, 
		to_char(b.dt_vencimento,'ddmmyy') dt_vencimento, 
		coalesce(c.vl_cobranca,0), 
		CASE WHEN substr(obter_se_titulos_vencidos(b.cd_pessoa_fisica,d.cd_cgc,last_day(add_months(a.dt_remessa_retorno,-1))),1,255)='S' THEN '1'  ELSE '0' END  cd_inadimplencia, 
		to_char(b.dt_emissao,'ddmmyy'), 
		rpad(b.nm_pessoa,36,' ') nm_associado, 
		rpad(elimina_acentuacao(substr(CASE WHEN coalesce(d.nr_sequencia::text, '') = '' THEN  obter_dados_pf_pj(b.cd_pessoa_fisica, b.cd_cgc, 'E')  ELSE pls_obter_compl_pagador(e.nr_seq_pagador,'EN') END ,1,120)),50,' ') ds_endereco, 
		rpad(somente_numero(substr(pls_obter_compl_pagador(d.nr_sequencia, 'CEP'),1,8)),8,' ') cd_cep, 
		rpad(substr(pls_obter_compl_pagador(d.nr_sequencia, 'CI'),1,15),15,' ') ds_cidade, 
		rpad(substr(pls_obter_compl_pagador(d.nr_sequencia, 'UF'),1,2),2,' ') ds_uf 
	from	cobranca_escritural a, 
		titulo_receber_cobr c, 
		titulo_receber_v b, 
		pls_mensalidade e, 
		pls_contrato_pagador d 
	where	a.nr_sequencia		= c.nr_seq_cobranca 
	and	c.nr_titulo		= b.nr_titulo 
	and	b.nr_seq_mensalidade	= e.nr_sequencia 
	and	e.nr_seq_pagador	= d.nr_sequencia 
	and	a.nr_sequencia		= nr_seq_cobr_escrit_p;

 

BEGIN 
delete from	w_envio_banco;
 
/* ######## HEADER ######## */
 
ds_conteudo_w		:= '';
nr_sequencia_w		:= nr_sequencia_w + 1;
ie_tipo_registro_w	:= '01';
ds_remessa_retorno_w	:= 'REMESSA';
cd_conta_w		:= '10081001298083';
ds_fixo_w		:= 'AFPERGS';
ds_seq_w		:= lpad(nr_sequencia_w,6,'0');
 
select	to_char(a.dt_remessa_retorno,'DDMMYY') 
into STRICT	dt_emissao_w	 
from	cobranca_escritural a, 
	estabelecimento b, 
	banco_estabelecimento c 
where	a.cd_estabelecimento	= b.cd_estabelecimento 
and	a.nr_seq_conta_banco	= c.nr_sequencia 
and	a.nr_sequencia		= nr_seq_cobr_escrit_p;
 
ds_conteudo_w	:=	ie_tipo_registro_w	||	ds_remessa_retorno_w	||	rpad(' ',2,' ')		|| 
			cd_conta_w		||	rpad(' ',2,' ')		||	ds_fixo_w		|| 
			rpad(' ',2,' ')		||	dt_emissao_w		||	rpad(' ',183,' ')	|| 
			ds_seq_w;
			 
			 
insert into	w_envio_banco(nr_sequencia, 
	nm_usuario, 
	dt_atualizacao, 
	nm_usuario_nrec, 
	dt_atualizacao_nrec, 
	cd_estabelecimento, 
	ds_conteudo, 
	nr_seq_apres) 
values (nextval('w_envio_banco_seq'), 
	nm_usuario_p, 
	clock_timestamp(), 
	nm_usuario_p, 
	clock_timestamp(), 
	cd_estabelecimento_p, 
	ds_conteudo_w, 
	1);
	 
	 
	 
/* ######## DETALHE ######## */
 
ie_tipo_registro_w	:= '3';
cd_especie_w		:= '8059';
cd_banco_w		:= '041';
cd_aceite_w		:= 'A';
cd_conta_w		:= '10081001298083';
 
open C01;
loop 
fetch C01 into	 
	cd_pessoa_fisica_w, 
	nr_titulo_w, 
	cd_competencia_w, 
	dt_vencimento_w, 
	vl_titulo_w, 
	cd_inadimplencia_w, 
	dt_emissao_w, 
	nm_associado_w, 
	ds_endereco_w, 
	cd_cep_w, 
	ds_cidade_w, 
	ds_uf_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin 
	ds_conteudo_w		:= '';
	nr_sequencia_w		:= nr_sequencia_w + 1;
	vl_soma_tit_w		:= vl_soma_tit_w + vl_titulo_w;
	vl_titulo_format_w	:= rpad(Campo_Mascara_virgula_casas(vl_titulo_w,2),10,' ');
	ds_seq_w		:= lpad(nr_sequencia_w,6,'0');
	 
	ds_conteudo_w	:=	ie_tipo_registro_w	||	rpad(' ',1,' ')	||	cd_conta_w		||	rpad(' ',2,' ')	|| 
				cd_pessoa_fisica_w	||	rpad(' ',2,' ')	||	nr_titulo_w		||	rpad(' ',2,' ')	|| 
				cd_especie_w		||	rpad(' ',2,' ')	||	cd_competencia_w	||	rpad(' ',2,' ')	|| 
				dt_vencimento_w		||	rpad(' ',2,' ')	||	vl_titulo_format_w	||	rpad(' ',2,' ')	|| 
				cd_banco_w		||	rpad(' ',2,' ')	||	cd_inadimplencia_w	||	cd_aceite_w	|| 
				dt_emissao_w		||	rpad(' ',2,' ')	||	nm_associado_w		||	rpad(' ',2,' ')	|| 
				ds_endereco_w		||	rpad(' ',2,' ')	||	cd_cep_w		||	rpad(' ',2,' ')	|| 
				ds_cidade_w		||	rpad(' ',2,' ')	||	ds_uf_w			||	rpad(' ',2,' ')	|| 
				ds_seq_w;			
 
			 
	insert into	w_envio_banco(nr_sequencia, 
		nm_usuario, 
		dt_atualizacao, 
		nm_usuario_nrec, 
		dt_atualizacao_nrec, 
		cd_estabelecimento, 
		ds_conteudo, 
		nr_seq_apres) 
	values (nextval('w_envio_banco_seq'), 
		nm_usuario_p, 
		clock_timestamp(), 
		nm_usuario_p, 
		clock_timestamp(), 
		cd_estabelecimento_p, 
		ds_conteudo_w, 
		3);		
	 
	end;
end loop;
close C01;		
			 
 
			 
/* ######## TRAILER ######## */
			 
ds_conteudo_w		:= '';
nr_sequencia_w		:= nr_sequencia_w + 1;
ie_tipo_registro_w	:= '9';
vl_total_titulo_w	:= rpad(Campo_Mascara_virgula_casas(vl_soma_tit_w,2),10,' ');
ds_seq_w		:= lpad(nr_sequencia_w,6,'0');
 
ds_conteudo_w		:=	ie_tipo_registro_w	||	rpad(' ',76,' ')	||	vl_total_titulo_w	|| 
				rpad(' ',138,' ')	||	ds_seq_w;
			 
			 
insert into	w_envio_banco(nr_sequencia, 
	nm_usuario, 
	dt_atualizacao, 
	nm_usuario_nrec, 
	dt_atualizacao_nrec, 
	cd_estabelecimento, 
	ds_conteudo, 
	nr_seq_apres) 
values (nextval('w_envio_banco_seq'), 
	nm_usuario_p, 
	clock_timestamp(), 
	nm_usuario_p, 
	clock_timestamp(), 
	cd_estabelecimento_p, 
	ds_conteudo_w, 
	9);				
			 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE afpergs_gerar_cobranca_acctd ( nr_seq_cobr_escrit_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) FROM PUBLIC;

