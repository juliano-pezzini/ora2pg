-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE eis_gerar_retorno_convenio (dt_referencia_p timestamp, nm_usuario_p text, IE_DIARIO_MENSAL_P text) AS $body$
DECLARE


  vl_pago_w       eis_retorno_convenio.vl_pago%type;
  vl_naceito_w    eis_retorno_convenio.vl_naceito%type;
  vl_aceito_w     eis_retorno_convenio.vl_aceito%type;
  vl_glosa_w      eis_retorno_convenio.vl_glosa%type;
  dt_referencia_w timestamp;
  dt_ref_final_w  timestamp;
  R RECORD;
  S RECORD;

BEGIN

if IE_DIARIO_MENSAL_P = 'M' then
    dt_referencia_w		:= trunc(dt_referencia_p,'month');
    dt_ref_final_w		:= last_day(trunc(dt_referencia_p,'month')) + 86399/86400;
else
    dt_referencia_w		:= trunc(dt_referencia_p,'dd');
    dt_ref_final_w		:= trunc(dt_referencia_p,'dd');
end if;


delete from	eis_retorno_convenio
      where	dt_referencia between dt_referencia_w and dt_ref_final_w;


for R IN(SELECT t.* from (select	
                a.vl_pago + a.vl_adicional as vl_pago,
                a.vl_amenor vl_naceito,
                a.vl_glosado vl_aceito,
                (a.vl_amenor + a.vl_glosado) vl_glosa, 
                obter_valor_conpaci_guia(a.nr_interno_conta, a.cd_autorizacao, 1) vl_conta,
                substr(obter_nome_convenio(b.cd_convenio_parametro),1,255) ds_convenio,
                b.cd_convenio_parametro cd_convenio,
                substr(OBTER_VALOR_DOMINIO(11,g.ie_tipo_convenio),1,255) ds_tipo_convenio,
                g.ie_tipo_convenio ie_tipo_convenio,
                c.dt_retorno dt_referencia,
                trunc(c.dt_baixa_cr) dt_baixa_cr,
                substr(obter_empresa_estab(b.cd_estabelecimento),1,255) cd_empresa,
                e.ie_tipo_atendimento,
                substr(obter_valor_dominio(12,ie_tipo_atendimento),1,255) ds_tipo_atendimento,
                f.cd_categoria,
                (substr(obter_nome_convenio(b.cd_convenio_parametro),1,150) || ' - ' || f.ds_categoria) ds_categoria,
                c.cd_estabelecimento,
                a.nm_usuario nm_usuario_glosa,
                b.nr_interno_conta,
                obter_setor_atendimento(e.nr_atendimento) cd_setor_atendimento,
                substr(obter_nome_setor(obter_setor_atendimento(e.nr_atendimento)),1,255) ds_setor_atendimento,
                substr(b.nr_interno_conta||' - '||obter_nome_pf_pj(e.cd_pessoa_fisica,null),1,255) ds_conta_paciente,
                a.cd_autorizacao
        from 	categoria_convenio f,
                atendimento_paciente e,
                conta_paciente b,
                convenio_retorno_item a,
                convenio_retorno c,
                convenio g
        where	a.nr_interno_conta 		= b.nr_interno_conta
         and	c.cd_convenio			= b.cd_convenio_parametro
         and	c.cd_convenio			= g.cd_convenio
         and	a.nr_Seq_retorno 		= c.nr_sequencia
         and	b.nr_atendimento		= e.nr_atendimento
         and	c.cd_convenio			= f.cd_convenio
         and	b.cd_categoria_parametro 	= f.cd_categoria
) t where dt_referencia between dt_referencia_w and dt_ref_final_w) loop	


     vl_pago_w     :=  R.vl_pago;
     vl_naceito_w  :=  R.vl_naceito;
     vl_aceito_w   :=  R.vl_aceito;
     vl_glosa_w    :=  R.vl_glosa;

     for S in(SELECT sum(obter_valores_guia_grc(c.nr_seq_lote_hist,c.nr_interno_conta,c.cd_autorizacao,'VG')) vl_aceito, 	
                     sum(obter_valores_guia_grc(c.nr_seq_lote_hist,c.nr_interno_conta,c.cd_autorizacao,'VP')) vl_pago,
                     sum(coalesce((select obter_valores_guia_grc(z.nr_seq_lote_hist,z.nr_interno_conta,z.cd_autorizacao,'VA') 
                                from lote_audit_hist_guia z 
                               where z.nr_seq_lote_hist = c.nr_seq_lote_hist 
                                 and z.cd_autorizacao   = c.cd_autorizacao
                                 and z.nr_interno_conta = c.nr_interno_conta
                                 and z.nr_seq_lote_hist = (select max(x.nr_seq_lote_hist)
                                                             from lote_audit_hist_guia x
                                                            where x.nr_interno_conta = R.nr_interno_conta
                                                              and x.cd_autorizacao   = R.cd_autorizacao)),0)) vl_naceito 
                from lote_audit_hist_guia c
               where c.cd_autorizacao = R.cd_autorizacao
                 and c.nr_interno_conta = R.nr_interno_conta) loop 

         vl_pago_w     :=  coalesce(vl_pago_w,0) + coalesce(S.vl_pago,0);
         vl_naceito_w  :=  coalesce(S.vl_naceito,0);
         vl_aceito_w   :=  coalesce(vl_aceito_w,0) + coalesce(S.vl_aceito,0);
         vl_glosa_w    :=  vl_aceito_w + vl_naceito_w;

    end loop;

     INSERT INTO eis_retorno_convenio(
                    cd_estabelecimento,
                    dt_atualizacao,
                    nm_usuario,
                    cd_autorizacao,
                    ds_conta_paciente,
                    ds_setor_atendimento,
                    cd_setor_atendimento,
                    nr_interno_conta,
                    nm_usuario_glosa,
                    ds_categoria,
                    cd_categoria,
                    ds_tipo_atendimento,
                    ie_tipo_atendimento,
                    cd_empresa,
                    dt_baixa_cr,
                    dt_referencia,
                    ie_tipo_convenio,
                    ds_tipo_convenio,
                    cd_convenio,
                    ds_convenio,
                    vl_conta,
                    vl_glosa,
                    vl_aceito,
                    vl_naceito,
                    vl_pago
                ) VALUES (
                    R.cd_estabelecimento,
                    clock_timestamp(),
                    nm_usuario_p,
                    R.cd_autorizacao,
                    R.ds_conta_paciente,
                    R.ds_setor_atendimento,
                    R.cd_setor_atendimento,
                    R.nr_interno_conta,
                    R.nm_usuario_glosa,
                    R.ds_categoria,
                    R.cd_categoria,
                    R.ds_tipo_atendimento,
                    R.ie_tipo_atendimento,
                    R.cd_empresa,
                    R.dt_baixa_cr,
                    trunc(R.dt_referencia),
                    R.ie_tipo_convenio,
                    R.ds_tipo_convenio,
                    R.cd_convenio,
                    R.ds_convenio,
                    R.vl_conta,
                    vl_glosa_w,
                    vl_aceito_w,
                    vl_naceito_w,
                    vl_pago_w
                );

end loop;
commit;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eis_gerar_retorno_convenio (dt_referencia_p timestamp, nm_usuario_p text, IE_DIARIO_MENSAL_P text) FROM PUBLIC;

