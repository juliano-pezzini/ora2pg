-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';



CREATE TYPE especialidades_vec AS (cd_especialidade integer, ds_especialidade varchar(40));


CREATE OR REPLACE PROCEDURE w_pls_gerar_espec_contrato ( dt_inicial_p timestamp, dt_final_p timestamp, nr_seq_grupo_p bigint, nr_seq_contrato_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) AS $body$
DECLARE


ie_commit_w		bigint := 0;
dt_mes_w		timestamp;
cd_especialidade_w	bigint;
ds_especialidade_w	varchar(255);
qt_registros_w		bigint;
qt_tot_registros_w	bigint;
nr_seq_relat_espec_w	bigint;
nr_seq_grupo_w		bigint;
nr_seq_contrato_w	bigint;
nr_vetor_w		bigint;
i			bigint;
dt_emissao_w		timestamp;
dt_fim_mes_w		timestamp;
type vetor is table of especialidades_vec index by integer;
vetor_w				vetor;

C01 CURSOR FOR
	SELECT	dt_mes
	from	mes_v
	where	dt_mes between dt_inicial_p and dt_final_p
	order by	dt_mes;

C02 CURSOR FOR
	SELECT	h.cd_especialidade,
		h.ds_especialidade
	from	pls_segurado		a,
		pls_conta		b,
		pls_grupo_contrato	c,
		pls_contrato_grupo	d,
		pls_contrato		f,
		pls_guia_plano		g,
		ESPECIALIDADE_MEDICA	h
	where	b.nr_seq_segurado	= a.nr_sequencia
	and	d.nr_seq_grupo		= c.nr_sequencia
	and	d.nr_seq_contrato	= f.nr_sequencia
	and	a.nr_seq_contrato	= f.nr_sequencia
	and	b.cd_guia		= g.cd_guia
	and	g.CD_ESPECIALIDADE	= h.CD_ESPECIALIDADE
	and	b.ie_status		= 'F'
	and	((c.nr_sequencia	= nr_seq_grupo_w and (nr_seq_grupo_w IS NOT NULL AND nr_seq_grupo_w::text <> '')) or (coalesce(nr_seq_grupo_w::text, '') = ''))
	and	((f.nr_sequencia	= nr_seq_contrato_w and (nr_seq_contrato_w IS NOT NULL AND nr_seq_contrato_w::text <> '')) or (coalesce(nr_seq_contrato_w::text, '') = ''))
	group by h.ds_especialidade,h.cd_especialidade;



BEGIN

nr_seq_grupo_w		:= nr_seq_grupo_p;
nr_seq_contrato_w	:= nr_seq_contrato_p;

if (nr_seq_grupo_w = '0') then
	nr_seq_grupo_w	:= null;
end if;

if (nr_seq_contrato_w = '0') then
	nr_seq_contrato_w	:= null;
end if;

CALL Exec_sql_Dinamico('Tasy', 'truncate table W_PLS_RELAT_ESPECIALIDADE');
--pls_posicionar_sequence_cache('W_PLS_RELAT_ESPECIALIDADE','NR_SEQUENCIA','R',1000);
open C02;
loop
fetch C02 into
	cd_especialidade_w,
	ds_especialidade_w;
EXIT WHEN NOT FOUND; /* apply on C02 */
	begin
	nr_vetor_w	:= vetor_w.count+1;
	vetor_w[nr_vetor_w].cd_especialidade	:= cd_especialidade_w;
	vetor_w[nr_vetor_w].ds_especialidade	:= ds_especialidade_w;
	end;
end loop;
close C02;

open C01;
loop
fetch C01 into
	dt_mes_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	dt_fim_mes_w	:= fim_mes(dt_mes_w);

	i			:= 0;
	for i in 1..vetor_w.count loop
		cd_especialidade_w	:= vetor_w[i].cd_especialidade;
		ds_especialidade_w	:= vetor_w[i].ds_especialidade;

		select	COUNT(1)
		INTO STRICT	qt_tot_registros_w
		from	pls_guia_plano		g,
			pls_segurado		a,
			pls_conta		b,
			pls_contrato		f,
			pls_grupo_contrato	c,
			pls_contrato_grupo	d,
			ESPECIALIDADE_MEDICA	h
		where	b.cd_guia		= g.cd_guia
		AND	b.nr_seq_segurado	= a.nr_sequencia
		and	d.nr_seq_grupo		= c.nr_sequencia
		and	d.nr_seq_contrato	= f.nr_sequencia
		and	a.nr_seq_contrato	= f.nr_sequencia
		and	g.CD_ESPECIALIDADE	= h.CD_ESPECIALIDADE
		and	b.ie_status		= 'F'
		and	b.dt_atendimento_referencia between dt_mes_w and dt_fim_mes_w
		and	((c.nr_sequencia	= nr_seq_grupo_w and (nr_seq_grupo_w IS NOT NULL AND nr_seq_grupo_w::text <> '')) or (coalesce(nr_seq_grupo_w::text, '') = ''))
		and	((f.nr_sequencia	= nr_seq_contrato_w and (nr_seq_contrato_w IS NOT NULL AND nr_seq_contrato_w::text <> '')) or (coalesce(nr_seq_contrato_w::text, '') = ''))
		and	h.cd_especialidade	= cd_especialidade_w;

		select	nextval('w_pls_relat_especialidade_seq')
		into STRICT	nr_seq_relat_espec_w
		;

		insert into W_PLS_RELAT_ESPECIALIDADE(	nr_sequencia,dt_atualizacao,nm_usuario,dt_atualizacao_nrec,nm_usuario_nrec,
				cd_especialidade,ds_especialidade,dt_mes_referencia,qt_registro)
		values (	nr_seq_relat_espec_w,clock_timestamp(),nm_usuario_p,clock_timestamp(),nm_usuario_p,
				cd_especialidade_w,ds_especialidade_w,dt_mes_w,qt_tot_registros_w);

		commit;

	end loop;
	end;
end loop;
close C01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE w_pls_gerar_espec_contrato ( dt_inicial_p timestamp, dt_final_p timestamp, nr_seq_grupo_p bigint, nr_seq_contrato_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) FROM PUBLIC;

