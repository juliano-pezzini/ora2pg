-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE liberar_prescricao_nutricao (nr_seq_prescricao_p bigint, nm_usuario_p text) AS $body$
DECLARE


nr_atendimento_w	bigint;
cd_setor_atendimento_w	bigint;
qt_reg_w		bigint;
cd_estabelecimento_w	bigint;
nr_seq_atend_w		bigint;
nr_seq_servico_w	bigint;
nr_seq_serv_atend_w	bigint;
dt_prescricao_w		timestamp;

C01 CURSOR FOR
	SELECT	nr_sequencia
	from	nut_servico
	where	cd_estabelecimento	= cd_estabelecimento_w
	and	ie_situacao		= 'A'
	order by coalesce(nr_seq_apres, 0);



BEGIN

select	nr_atendimento,
	trunc(dt_prescricao, 'dd'),
	cd_setor_atendimento
into STRICT	nr_atendimento_w,
	dt_prescricao_w,
	cd_setor_atendimento_w
from	nut_prescricao
where	nr_sequencia		= nr_seq_prescricao_p;

update	nut_prescricao
set	dt_liberacao		= clock_timestamp(),
	nm_usuario		= nm_usuario_p,
	ie_status_prescricao	= 'C'
where	nr_sequencia		= nr_seq_prescricao_p;

select	count(*)
into STRICT	qt_reg_w
from	nut_atend_dia
where	nr_atendimento		= nr_atendimento_w
and	dt_atendimento		= dt_prescricao_w
and	cd_setor_atendimento	= cd_setor_atendimento_w;

if (qt_reg_w	= 0) then

	select	nextval('nut_atend_dia_seq')
	into STRICT	nr_seq_atend_w
	;

	insert	into nut_atend_dia(nr_sequencia,
		nr_atendimento,
		dt_atendimento,
		cd_setor_atendimento,
		dt_atualizacao,
		nm_usuario,
		dt_atualizacao_nrec,
		nm_usuario_nrec)
	values (nr_seq_atend_w,
		nr_atendimento_w,
		dt_prescricao_w,
		cd_setor_atendimento_w,
		clock_timestamp(),
		nm_usuario_p,
		clock_timestamp(),
		nm_usuario_p);

	open C01;
	loop
	fetch C01 into
		nr_seq_servico_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin

		select	nextval('nut_atend_servico_seq')
		into STRICT	nr_seq_serv_atend_w
		;

		insert	into nut_atend_servico(nr_sequencia,
			nr_seq_atend,
			nr_seq_servico,
			dt_atualizacao,
			nm_usuario,
			dt_atualizacao_nrec,
			nm_usuario_nrec)
		values (nr_seq_serv_atend_w,
			nr_seq_atend_w,
			nr_seq_servico_w,
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p);

		end;
	end loop;
	close C01;

end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE liberar_prescricao_nutricao (nr_seq_prescricao_p bigint, nm_usuario_p text) FROM PUBLIC;

