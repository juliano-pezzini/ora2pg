-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE dispensacao_quimio ( ie_administracao_p text, nr_atendimento_p bigint, nr_seq_atendimento_p bigint, nr_prescricao_p bigint, nr_seq_ordem_p bigint, dt_referencia_p timestamp, cd_local_saida_p bigint, cd_estab_ordem_prod_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint, ds_erro_p INOUT text) AS $body$
DECLARE


ie_perm_somente_disp_ordem_w	varchar(1);
ie_utiliza_transferencia_w		varchar(1);
nr_atendimento_w			bigint;
ie_ordem_anterior_w		varchar(1);
cd_serie_nf_w			varchar(5);
ie_utiliza_regra_padrao_w		varchar(1);


BEGIN

if (coalesce(nr_atendimento_p::text, '') = '') then
	begin
	select	nr_atendimento
	into STRICT	nr_atendimento_w
	from	prescr_medica
	where	nr_prescricao = nr_prescricao_p;

	if (coalesce(nr_atendimento_w::text, '') = '') then
		ds_erro_p	:= substr(obter_texto_tasy(62107, wheb_usuario_pck.get_nr_seq_idioma),1,255);
	end if;
	end;
else
	nr_atendimento_w	:= nr_atendimento_p;
end if;

CALL valida_atendimento_dispensacao(nr_seq_ordem_p);

if (coalesce(ds_erro_p::text, '') = '') then
	begin
	/* Quimioterapia - Parametro [86] - Permite somente realizar dispensacao seguindo a ordem */

	ie_perm_somente_disp_ordem_w := obter_param_usuario(3130, 86, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_perm_somente_disp_ordem_w);

	if (ie_perm_somente_disp_ordem_w = 'S') then
		begin
		select	CASE WHEN obter_qt_ordem_anterior(nr_seq_ordem_p, nr_prescricao_p)=0 THEN  'N'  ELSE 'S' END
		into STRICT	ie_ordem_anterior_w
		;

		if (ie_ordem_anterior_w = 'S') then
			ds_erro_p	:= substr(obter_texto_tasy(62110, wheb_usuario_pck.get_nr_seq_idioma),1,255);
		end if;
		end;
	end if;
	end;
end if;

if (coalesce(ds_erro_p::text, '') = '') then
	begin
	if (ie_administracao_p = 'S') then
		begin
		/* Quimioterapia - Parametro [199] - Ao dispensar a ordem manipulacao utilizar a transferencia de estoque para outro estabelecimento */

		ie_utiliza_transferencia_w := obter_param_usuario(3130, 199, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_utiliza_transferencia_w);

		if (ie_utiliza_transferencia_w = 'S') then
			begin
			select	max(cd_serie_nf)
			into STRICT	cd_serie_nf_w
			from	serie_nota_fiscal
			where	cd_estabelecimento	= cd_estab_ordem_prod_p
			and	ie_situacao	= 'A';

			CALL gerar_nf_transf_prescr_cmiv(	
				nr_seq_ordem_p,
				obter_estab_atend(nr_atendimento_w),
				cd_estabelecimento_p,
				cd_local_saida_p,
				obter_parametros_nf_quimio('OS'),
				obter_parametros_nf_quimio('NS'),
				obter_parametros_nf_quimio('OE'),
				obter_parametros_nf_quimio('NE'),
				obter_parametros_nf_quimio('CO'),
				cd_serie_nf_w,
				nm_usuario_p);
			end;
		end if;
		end;
	end if;

	CALL gerar_chegada_dose(
		dt_referencia_p,
		nr_prescricao_p,
		nm_usuario_p);
		
	ie_utiliza_regra_padrao_w := obter_param_usuario(3130, 220, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_utiliza_regra_padrao_w);
		
	if (ie_utiliza_regra_padrao_w = 'S') then
		CALL gerar_dispensacao_quimio(nr_seq_atendimento_p, cd_estabelecimento_p, nr_atendimento_p, nr_seq_ordem_p, nm_usuario_p);
		CALL gerar_conta_disp_quimio(nr_seq_ordem_p, nr_atendimento_p, nm_usuario_p);
	elsif (ie_utiliza_regra_padrao_w = 'M') then
		CALL gerar_quimio_melhor_apresent(nr_seq_atendimento_p, cd_estabelecimento_p,nr_atendimento_p,nr_seq_ordem_p, nm_usuario_p);
		CALL gerar_conta_disp_quimio(nr_seq_ordem_p, nr_atendimento_p, nm_usuario_p);	
	else
		CALL baixar_prescr_cmiv(nr_seq_ordem_p, nm_usuario_p, cd_estabelecimento_p);	
	end if;


	if (ie_administracao_p = 'S') then
		begin
		CALL disp_regra_quimio(
			nr_atendimento_w,
			nr_seq_atendimento_p,
			nr_seq_ordem_p,
			nm_usuario_p);
		end;
	end if;
	end;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE dispensacao_quimio ( ie_administracao_p text, nr_atendimento_p bigint, nr_seq_atendimento_p bigint, nr_prescricao_p bigint, nr_seq_ordem_p bigint, dt_referencia_p timestamp, cd_local_saida_p bigint, cd_estab_ordem_prod_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint, ds_erro_p INOUT text) FROM PUBLIC;

