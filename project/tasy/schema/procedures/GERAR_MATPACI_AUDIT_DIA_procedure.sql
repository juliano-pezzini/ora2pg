-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_matpaci_audit_dia ( cd_material_p bigint, dt_inicial_p timestamp, nr_dias_p bigint, qt_mat_lanc_dia_p bigint, nr_atendimento_p bigint, nr_interno_conta_p bigint, nr_seq_atepacu_p bigint, cd_local_estoque_p bigint, nr_seq_auditoria_p bigint, nr_seq_motivo_p bigint, nm_usuario_p text ) AS $body$
DECLARE

				 
nr_sequencia_w			bigint;
cd_convenio_w			integer;
cd_categoria_w			varchar(10);
dt_atendimento_w			timestamp;
dt_entrada_unidade_w		timestamp;
cd_material_w			bigint;
qt_material_w			double precision;
ie_convenio_conta_param_w		varchar(1);
cd_estabelecimento_w		smallint;
nr_doc_convenio_w		varchar(20);
ie_tipo_guia_w			varchar(5);
cd_senha_w			varchar(30);
dt_periodo_inicial_w		timestamp;
dt_periodo_final_w		timestamp;
cd_setor_atendimento_w		integer;
cd_unidade_medida_w		varchar(30);

BEGIN 
 
dt_atendimento_w := dt_inicial_p;
qt_material_w := coalesce(qt_mat_lanc_dia_p,1);
 
select	cd_estabelecimento 
into STRICT	cd_estabelecimento_w 
from	conta_paciente 
where	nr_interno_conta = nr_interno_conta_p;
 
select	max(dt_entrada_unidade), 
	max(cd_setor_atendimento) 
into STRICT	dt_entrada_unidade_w, 
	cd_setor_atendimento_w 
from	atend_paciente_unidade 
where	nr_seq_interno = nr_seq_atepacu_p;
 
select	cd_unidade_medida_consumo 
into STRICT	cd_unidade_medida_w 
from	material 
where	cd_material = cd_material_p;
 
select	coalesce(max(ie_convenio_conta_param),'N') 
into STRICT	ie_convenio_conta_param_w 
from	parametro_faturamento 
where	cd_estabelecimento = cd_estabelecimento_w;
 
select	max(dt_periodo_inicial), 
	max(dt_periodo_final) 
into STRICT	dt_periodo_inicial_w, 
	dt_periodo_final_w 
from	auditoria_conta_paciente 
where	nr_sequencia = nr_seq_auditoria_p;
 
if (ie_convenio_conta_param_w = 'S') then 
	begin 
	select	cd_convenio_parametro, 
		cd_categoria_parametro 
	into STRICT	cd_convenio_w, 
		cd_categoria_w 
	from	conta_paciente 
	where	nr_interno_conta = nr_interno_conta_p;	
	end;
else 
	-- Obter o convÃªnio de execucao 
	SELECT * FROM obter_convenio_execucao(	nr_atendimento_p, dt_entrada_unidade_w, cd_convenio_w, cd_categoria_w, nr_doc_convenio_w, ie_tipo_guia_w, cd_senha_w) INTO STRICT cd_convenio_w, cd_categoria_w, nr_doc_convenio_w, ie_tipo_guia_w, cd_senha_w;
end if;
 
for i in 1..nr_dias_p loop 
	begin 
	 
	if (dt_periodo_inicial_w IS NOT NULL AND dt_periodo_inicial_w::text <> '') and (dt_periodo_final_w IS NOT NULL AND dt_periodo_final_w::text <> '') and (dt_periodo_inicial_w < dt_atendimento_w) and (dt_periodo_final_w > dt_atendimento_w) then 
		 
		select	nextval('material_atend_paciente_seq') 
		into STRICT	nr_sequencia_w 
		;
 
		insert into material_atend_paciente(	 
				nr_sequencia, 
				cd_material, 
				dt_atendimento, 
				cd_convenio, 
				cd_categoria, 
				nr_seq_atepacu, 
				cd_setor_atendimento, 
				dt_entrada_unidade, 
				qt_material, 
				cd_local_estoque, 
				dt_Atualizacao, 
				nm_usuario, 
				nr_atendimento, 
				cd_unidade_medida, 
				cd_acao, 
				ie_valor_informado, 
				nr_interno_conta, 
				ie_auditoria) 
		values (	nr_sequencia_w, 
				cd_material_p, 
				dt_atendimento_w, 
				cd_convenio_w, 
				cd_categoria_w, 
				nr_seq_atepacu_p, 
				cd_setor_atendimento_w, 
				dt_entrada_unidade_w, 
				qt_material_w, 
				null, 
				clock_timestamp(), 
				nm_usuario_p, 
				nr_atendimento_p, 
				cd_unidade_medida_w, 
				'1', 
				'N', 
				nr_interno_conta_p, 
				'S');
		 
		--calcular item 
		CALL atualiza_preco_material(nr_sequencia_w,nm_usuario_p);
		 
		--atualizar a auditoria do item	 
		CALL atualizar_itens_audit_conta(nr_seq_auditoria_p, nr_sequencia_w, 1, qt_material_w, nm_usuario_p, nr_seq_motivo_p);
	 
		dt_atendimento_w := dt_atendimento_w +1;
	 
	end if;
	 
	end;
end loop;
 
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_matpaci_audit_dia ( cd_material_p bigint, dt_inicial_p timestamp, nr_dias_p bigint, qt_mat_lanc_dia_p bigint, nr_atendimento_p bigint, nr_interno_conta_p bigint, nr_seq_atepacu_p bigint, cd_local_estoque_p bigint, nr_seq_auditoria_p bigint, nr_seq_motivo_p bigint, nm_usuario_p text ) FROM PUBLIC;

