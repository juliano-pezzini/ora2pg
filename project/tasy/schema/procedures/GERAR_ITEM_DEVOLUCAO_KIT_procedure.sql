-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_item_devolucao_kit ( nr_atendimento_p bigint, nr_devolucao_p bigint, nr_prescricao_p bigint, cd_setor_atendimento_p bigint, cd_local_estoque_p bigint, cd_motivo_devolucao_p bigint, cd_material_p bigint, qt_material_p bigint, cd_estabelecimento_p bigint, nr_seq_item_devolucao_p bigint, nm_usuario_p text) AS $body$
DECLARE



nr_sequencia_w			bigint;
cd_material_w			integer;
dt_atendimento_w			timestamp;
cd_unidade_medida_w		varchar(30);
qt_material_w			double precision;
nr_sequencia_prescricao_w		integer;
dt_entrada_unidade_w		timestamp;
nr_seq_atendimento_w		bigint;
cd_local_estoque_w		smallint;
nr_prescricao_w			bigint;
cd_kit_material_w			bigint;
cd_material_ww			integer;
dt_baixa_conta_w			timestamp;

C01 CURSOR FOR
	SELECT	cd_material,
		qt_material,
		obter_dados_material(cd_material,'UME')
	from  	componente_kit
	where 	cd_kit_material = cd_kit_material_w;


BEGIN

select	a.cd_material,
	a.nr_prescricao,
	a.dt_atendimento,
	a.nr_sequencia_prescricao,
	a.nr_seq_atendimento,
	a.dt_entrada_unidade,
	a.cd_local_estoque,
	a.dt_baixa_conta
into STRICT	cd_material_ww,
	nr_prescricao_w,
	dt_atendimento_w,
	nr_sequencia_prescricao_w,
	nr_seq_atendimento_w,
	dt_entrada_unidade_w,
	cd_local_estoque_w,
	dt_baixa_conta_w
from	item_devolucao_material_pac a,
	devolucao_material_pac b
where	a.nr_devolucao           = b.nr_devolucao
and	b.nr_atendimento	= nr_atendimento_p
and	a.cd_material 		= cd_material_p
and	b.nr_devolucao		= nr_devolucao_p
and	a.nr_sequencia		= nr_seq_item_devolucao_p
and	b.cd_setor_atendimento	= coalesce(cd_setor_atendimento_p, b.cd_setor_atendimento);

select  c.cd_kit_material
into STRICT	cd_kit_material_w
from    material b,
	material_estab c
where   c.cd_material = b.cd_material
and    	c.cd_material = cd_material_ww
and 	cd_estabelecimento = cd_estabelecimento_p;

open C01;
loop
fetch C01 into
	cd_material_w,
	qt_material_w,
	cd_unidade_medida_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin

	if (coalesce(dt_baixa_conta_w::text, '') = '') then
		begin
		select	coalesce(max(nr_sequencia),0) + 1
		into STRICT	nr_sequencia_w
		from	item_devolucao_material_pac
		where	nr_devolucao = nr_devolucao_p;

		insert into ITEM_DEVOLUCAO_MATERIAL_PAC(
			nr_devolucao,
			nr_sequencia,
			cd_material,
			dt_atendimento,
			cd_local_estoque,
			cd_unidade_medida,
			cd_motivo_devolucao,
			dt_atualizacao,
			nm_usuario_devol,
			qt_material,
			nr_prescricao,
			nr_sequencia_prescricao,
			ie_tipo_baixa_estoque,
			dt_entrada_unidade,
			nr_seq_atendimento,
			nm_usuario)
		values (
			nr_devolucao_p,
			nr_sequencia_w,
			cd_material_w,
			dt_atendimento_w,
			CASE WHEN cd_local_estoque_p=0 THEN  coalesce(cd_local_estoque_w,0)   ELSE cd_local_estoque_p END ,
			cd_unidade_medida_w,
			cd_motivo_devolucao_p,
			clock_timestamp(),
			nm_usuario_p,
			qt_material_p,
			nr_prescricao_p,
			nr_sequencia_prescricao_w,
			0,
			dt_entrada_unidade_w,
			nr_seq_atendimento_w,
			nm_usuario_p);
		end;
	end if;
	end;
end loop;
close c01;

commit;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_item_devolucao_kit ( nr_atendimento_p bigint, nr_devolucao_p bigint, nr_prescricao_p bigint, cd_setor_atendimento_p bigint, cd_local_estoque_p bigint, cd_motivo_devolucao_p bigint, cd_material_p bigint, qt_material_p bigint, cd_estabelecimento_p bigint, nr_seq_item_devolucao_p bigint, nm_usuario_p text) FROM PUBLIC;

