-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE consistir_exc_atend_eup_js ( nm_usuario_p text, nr_atendimento_p bigint, ds_msg_prescricao_p INOUT text, ds_msg_laudo_sus_p INOUT text, ds_msg_erro_p INOUT text, ds_msg_conf_exclusao_p INOUT text) AS $body$
DECLARE

 
cd_estabelecimento_w	smallint;	
ie_consiste_prescr_w	varchar(1);
ie_consiste_laudo_sus_w	varchar(1);
ie_permite_exc_atend_w	varchar(1);
qt_prescr_atend_w	bigint;
qt_atend_w		bigint;
qt_laudo_sus_w		bigint;
ds_msg_prescricao_w	varchar(255);
ds_msg_laudo_sus_w	varchar(255);
ds_msg_erro_w		varchar(255);
ds_msg_conf_exclusao_w	varchar(255);
ie_continua_execucao_w	varchar(1) := 'S';

		 

BEGIN 
 
cd_estabelecimento_w := wheb_usuario_pck.get_cd_estabelecimento;
 
ie_permite_exc_atend_w := Obter_param_Usuario(916, 17, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_permite_exc_atend_w);
ie_consiste_prescr_w := Obter_param_Usuario(916, 118, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_consiste_prescr_w);
ie_consiste_laudo_sus_w := Obter_param_Usuario(916, 231, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_consiste_laudo_sus_w);
 
 
if (coalesce(nr_atendimento_p,0) > 0) then 
 
	if (ie_permite_exc_atend_w = 'N') and (ie_continua_execucao_w = 'S') then 
		 
		ie_continua_execucao_w := 'N';
		ds_msg_erro_w := substr(obter_texto_tasy(93900, wheb_usuario_pck.get_nr_seq_idioma),1,255);
	end if;
 
	if (ie_consiste_laudo_sus_w = 'N') and (ie_continua_execucao_w = 'S') then 
		 
		select	count(*) 
		into STRICT	qt_laudo_sus_w 
		from	sus_laudo_paciente 
		where 	nr_atendimento = nr_atendimento_p;
		 
		if (qt_laudo_sus_w > 0) then 
			ie_continua_execucao_w := 'N';
			ds_msg_laudo_sus_w := substr(obter_texto_tasy(93891, wheb_usuario_pck.get_nr_seq_idioma),1,255);
		end if;
	end if;
 
	if (ie_consiste_prescr_w = 'S') and (ie_continua_execucao_w = 'S') then 
	 
		select	count(*) 
		into STRICT	qt_prescr_atend_w 
		from 	prescr_medica  
		where	nr_atendimento = nr_atendimento_p;
		if (qt_prescr_atend_w > 0) then 
			ie_continua_execucao_w := 'S';
			ds_msg_prescricao_w := substr(obter_texto_tasy(93887, wheb_usuario_pck.get_nr_seq_idioma),1,255);
		end if;
	end if;
	 
	if (ie_continua_execucao_w = 'S') then 
	 
		select	count(*) 
		into STRICT	qt_atend_w 
		from	atendimento_paciente 
		where	nr_atendimento = nr_atendimento_p;
	 
		if (qt_atend_w > 0) then 
			ds_msg_conf_exclusao_w := substr(obter_texto_tasy(93892, wheb_usuario_pck.get_nr_seq_idioma),1,255);
		end if;
	end if;
end if;
 
ds_msg_prescricao_p 	:= ds_msg_prescricao_w;
ds_msg_laudo_sus_p 	:= ds_msg_laudo_sus_w;
ds_msg_erro_p		:= ds_msg_erro_w;
ds_msg_conf_exclusao_p	:= ds_msg_conf_exclusao_w;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE consistir_exc_atend_eup_js ( nm_usuario_p text, nr_atendimento_p bigint, ds_msg_prescricao_p INOUT text, ds_msg_laudo_sus_p INOUT text, ds_msg_erro_p INOUT text, ds_msg_conf_exclusao_p INOUT text) FROM PUBLIC;

