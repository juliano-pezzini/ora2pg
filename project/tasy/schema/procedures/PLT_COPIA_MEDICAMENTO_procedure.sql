-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE plt_copia_medicamento ( nr_prescricao_p bigint, nr_seq_regra_p bigint, dt_prescricao_p timestamp, dt_primeiro_horario_p text, cd_perfil_p bigint, ie_ajustar_qt_p text, ds_lista_p text, ie_modificar_p text, ie_reinicia_cont_dias_p text, nm_usuario_p text, cd_estabelecimento_p bigint, ie_estende_inc_p text, ie_copia_agora_p text, nr_agrupamento_p bigint) AS $body$
DECLARE



dt_prescricao_w				timestamp := dt_prescricao_p;
dt_inicio_prescr_tes_w		timestamp;
dt_validade_prescr_tes_w	timestamp;
ie_altera_dt_proxima_dose_w	varchar(2);
ie_calcula_validade_w		varchar(2) := 'S'; -- Nao implementado
nr_prescricao_w				bigint;
nr_seq_apres_w				bigint;
qt_se_necessario_w			bigint;
qt_w						bigint;
ie_composto_w				varchar(10);
ie_minutos_w				varchar(10);
ds_horarios_padr_w			varchar(2000);
nr_agrup_aux_w				bigint;
ie_dias_util_medic_w		varchar(1);
cd_unidade_medida_w			varchar(20);
ie_permite_substituir_w		varchar(1);
nr_sequencia_w				bigint;
nr_sequencia_dil_w			bigint;
ie_limpar_prim_hor_acm_w	varchar(10);
qt_unitaria_w				double precision;
qt_material_w				double precision;
ds_horarios_w				varchar(2000);
ds_horarios_prim_w			varchar(2000);
ds_horarios_aux_w			varchar(2000);
ds_horarios_reordenados_w	varchar(2000);
cont_w						bigint;
ds_horarios2_w				varchar(2000);
ds_horarios_ww				varchar(2000);
hr_prim_horario_w			varchar(5);
hr_prim_horario_aux_w		varchar(5);
ie_gerar_diluicao_w			varchar(1);
hr_prim_horario_ww			varchar(5);
nr_dia_util_w				bigint;
cd_material_w				integer;
cd_material_dil_w			integer;
nr_horas_validade_w			integer;
nr_horas_validade_mae_w		integer;
ie_operacao_w				varchar(1);
ie_origem_inf_w				varchar(1);
ds_erro_w					varchar(255);
cd_intervalo_w				varchar(7);
ie_via_aplicacao_w			varchar(5);
dt_primeiro_horario_w		timestamp;
dt_primeiro_horario_mae_w	timestamp;
dt_prim_horario_w			varchar(20);
cd_classif_setor_w			varchar(2);
cd_classif_setor_ww			integer;
ie_agrupador_w				smallint;
ie_acm_w					varchar(1);
ie_nao_padronizado_w		varchar(1);
dt_prim_hora_int_w			timestamp;
hr_prim_hora_medic_w		varchar(10);
varcopiajust_w				varchar(1);
ie_controle_medico_w		bigint;
qt_dias_liberado_w			bigint;
ds_dose_dif_w				varchar(255);
ie_aux_w					varchar(1);
i							bigint;
k							bigint;
dt_horario_w				timestamp;
dt_inicio_prescr_w			timestamp;
dt_validade_prescr_w		timestamp;
dt_proxima_dose_w			timestamp;
dt_proxima_dose_orig_w		timestamp;
qt_dias_lib_atend_w			bigint;
qt_dias_lib_atend_ww		bigint;
ie_copia_direta_w			varchar(15);
ie_regra_disp_w				varchar(1);
nr_seq_material_delete_w	integer;
cd_perfil_w					integer;
hr_prim_horario_interv_w	timestamp;
dt_inicio_prescr_ww			timestamp;
hr_inicio_prescr_w			varchar(10);
qt_hor_w					bigint;
cd_setor_atendimento_w		bigint;
ie_prescr_agora_pa_w		varchar(1);
ie_regra_prim_hor_ant_w		varchar(15);
ie_regra_horarios_ant_w		varchar(15);
ie_regra_prim_horarios_ant_w varchar(15);
ie_elimina_hor_ant_w		varchar(15);
ie_reordenar_ant_w			varchar(15);
ie_regra_prim_hor_w			varchar(15);
ie_regra_horarios_w			varchar(15);
ie_regra_prim_horarios_w	varchar(15);
ie_elimina_hor_w			varchar(15);
ie_reordenar_w				varchar(15);
nr_atendimento_w			bigint;
ie_regra_geral_w			varchar(15);
ie_copiar_w					varchar(15);
ie_cobra_paciente_w			varchar(15);
ds_observacao_w				varchar(4000);
ds_observacao_enf_w			varchar(2000);
qt_dose_w					double precision;
nr_seq_regra_w				bigint;
cd_motivo_baixa_w			bigint;
dt_baixa_w					timestamp;
ie_utiliza_kit_w			varchar(15);
cd_unidade_medida_dose_w	varchar(30);
qt_conversao_dose_w			double precision;
nr_ocorrencia_w				double precision;
qt_total_dispensar_w		double precision;
cd_fornec_consignado_w		varchar(30);
nr_sequencia_solucao_w		integer;
nr_sequencia_proc_w			integer;
qt_solucao_w				double precision;
ds_dose_diferenciada_w		varchar(50);
ie_medicacao_paciente_w		varchar(30);
ie_suspenso_w				varchar(30);
ie_se_necessario_w			varchar(30);
qt_min_aplicacao_w			bigint;
ie_bomba_infusao_w			varchar(30);
ie_aplic_bolus_w			varchar(30);
ie_aplic_lenta_w			varchar(30);
ie_objetivo_w				varchar(30);
cd_topografia_cih_w			bigint;
ie_origem_infeccao_w		varchar(30);
cd_amostra_cih_w			bigint;
cd_microorganismo_cih_w		bigint;
ie_uso_antimicrobiano_w		varchar(30);
cd_protocolo_w				bigint;
nr_seq_protocolo_w			bigint;
nr_seq_mat_protocolo_w		bigint;
qt_hora_aplicacao_w			bigint;
ie_recons_diluente_fixo_w	varchar(30);
qt_vel_infusao_w			double precision;
ds_justificativa_w			varchar(2000);
ie_sem_aprazamento_w		varchar(1);
ie_indicacao_w				varchar(1);
qt_total_dias_lib_w			integer;
nr_seq_substituto_w			integer;
ie_lado_w					varchar(1);
dt_inicio_medic_w			timestamp;
qt_dia_prim_hor_w			bigint;
qt_dia_prim_hor_mae_w		bigint;
qt_vol_adic_reconst_w		double precision;
qt_hora_intervalo_w			double precision;
qt_min_intervalo_w			integer;
ie_urgencia_w				varchar(10);
cd_mat_aux_w				bigint;
cd_intervalo_aux_w			varchar(50);
ie_agora_aux_w				varchar(50);
ie_regra_dose_especial_w	varchar(1);
qt_dose_especial_w			double precision;	
ie_dose_espec_agora_w		varchar(1);
hr_dose_especial_w			varchar(5);
ds_horarios_medico_w		varchar(2000);
nr_prescricoes_w			varchar(2000);
nr_prescricoes_lista_w		varchar(2000) := ' ';
nr_agrupamento_w			double precision;
nr_agrup_acum_w				bigint;
ds_lista_w					varchar(4000);
tam_lista_w					bigint;
tam_prescricao_w			bigint;
ie_pos_virgula_w			smallint;
ie_pos_espaco_w				smallint;
nr_prescr_lista_w			bigint;
nr_prescr_ant_w				bigint;
nr_seq_lista_w				integer;
ds_prescricao_w				varchar(255);
ie_horario_sem_apraso_w		varchar(1);
qt_regra_1h_w				bigint;
ie_padronizado_w			varchar(15);
cd_pessoa_fisica_w			varchar(10);
ie_tipo_item_w				varchar(10) := 'M';
dt_suspensao_progr_w		timestamp;
nr_seq_anterior_w			integer;
nr_prescricao_original_w	bigint;
ie_consiste_w				varchar(1);
qt_copia_w					bigint;
ie_diluente_copiado_w		varchar(1);
qt_inconsistencia_w			bigint;
nr_seq_dil_w				bigint;
ie_prescr_composto_w		varchar(15);
ie_mesmo_zerado_w			varchar(1);
cd_grupo_material_w			bigint;
cd_subgrupo_material_w		bigint;
cd_classe_material_w		bigint;
cd_classe_mate_w			bigint;
cd_grupo_mate_w				bigint;
cd_subgrupo_mate_w			bigint;
hr_prim_aux_w				varchar(10);
dt_prim_aux_w				timestamp;
hr_prim_hor_w				varchar(10);
dt_prim_hor_w				timestamp;
ie_permite_acm_w			varchar(1) := 'S';
ie_permite_acm_param_w		varchar(1) := 'S';
ds_medic_nao_padrao_w		varchar(255);
ie_ajusta_w					varchar(1) := 'N';
nr_seq_composto_w			bigint;
ds_lista_composto_w			varchar(2000);
var_param1097_w				varchar(5);
qt_operacao_w				double precision;
ie_copiar_def_infecto_w		varchar(1);
ie_estendida_liberacao_w	varchar(1);
ie_gerar_lote_w				varchar(1) := 'S';
ie_gera_disp_acm_sn_w		varchar(1);
ie_copia_obs_w				varchar(1);	
nr_prescricao_orig_w		bigint;
nr_seq_mat_orig_w			bigint;
nr_seq_material_w 			bigint;
ie_copia_albumina_w			varchar(1);
ie_alterou_dose_dil_w		varchar(1);
ds_observacao_far_w			prescr_material.ds_observacao_far%type;
qt_ref_diluente_w			prescr_material.qt_ref_diluente%type;
nr_seq_mat_diluicao_ww		prescr_material.nr_seq_mat_diluicao%type;
var_copia_diluicao_w		varchar(1);
ie_urgencia_ww				prescr_material.ie_urgencia%type;
cd_kit_material_w			prescr_material.cd_kit_material%type;
nr_seq_kit_w				prescr_material.nr_seq_kit%type;
ie_questiona_mod_atb_w		varchar(1);
qt_dias_solicitado_w		prescr_material.qt_dias_solicitado%type;
qt_dias_liberado_ww			prescr_material.qt_dias_liberado%type;
qt_horas_estabilidade_w		prescr_material.qt_horas_estabilidade%type;
ie_kit_w 					varchar(1);

ie_rastre_prescr_cm_w		varchar(1);
ds_rastre_prescr_cm_w		varchar(2000);
ds_rastre_prescr_cm_ins_w	varchar(2000);


c02 CURSOR FOR
SELECT	a.ie_copiar,
		a.ie_regra_geral,
		a.nr_sequencia,
		coalesce(cd_material,0) cd_material,
		coalesce(cd_intervalo,'AAAAAAAAAA') cd_intervalo,
		a.ie_agora,
		coalesce(nr_seq_apres,99) nr_seq_apres,
		coalesce(ie_dose_especial,'N') ie_dose_especial,
		coalesce(a.cd_classe_material,0) cd_classe_material,
		coalesce(a.cd_grupo_material,0) cd_grupo_material,
		coalesce(a.cd_subgrupo_material,0)  cd_subgrupo_material
from	rep_regra_copia_crit a
where	1 = 1
and		coalesce(a.cd_material,cd_material_w)	= cd_material_w
and		((a.cd_intervalo		= cd_intervalo_w) or (coalesce(a.cd_intervalo::text, '') = ''))
and		(((coalesce(a.ie_agora,'S')	= 'S') and (a.ie_agora = ie_urgencia_w)) or (coalesce(a.ie_agora,'N')	= 'N'))
and		((coalesce(a.ie_acm,'S')	= 'S') or (a.ie_acm = ie_acm_w))
and		((coalesce(a.ie_se_necessario,'S')	= 'S') or (a.ie_se_necessario = ie_se_necessario_w))
and     coalesce(a.cd_classe_material,cd_classe_material_w) = cd_classe_material_w
and     coalesce(a.cd_grupo_material,cd_grupo_material_w)   = cd_grupo_material_w
and     coalesce(a.cd_subgrupo_material,cd_subgrupo_material_w) = cd_subgrupo_material_w 	
and		((coalesce(nr_seq_regra_p,0) = 0) or (a.nr_seq_regra = nr_seq_regra_p))
and		a.ie_tipo_item	= 'MED'
and		ie_agrupador_w		<> 2

union all

SELECT	a.ie_copiar,
		a.ie_regra_geral,
		a.nr_sequencia,
		coalesce(cd_material,0) cd_material,
		coalesce(cd_intervalo,'AAAAAAAAAA') cd_intervalo,
		ie_agora,
		coalesce(nr_seq_apres,99) nr_seq_apres,
		'N' ie_dose_especial,
		coalesce(a.cd_classe_material,0) cd_classe_material,
		coalesce(a.cd_grupo_material,0) cd_grupo_material,
		coalesce(a.cd_subgrupo_material,0) cd_subgrupo_material
from	rep_regra_copia_crit a
where	1 = 1
and		coalesce(a.cd_material,cd_material_w)	= cd_material_w
and		((coalesce(a.cd_intervalo::text, '') = '') or (a.cd_intervalo = cd_intervalo_w))
and		(((coalesce(a.ie_agora,'S')	= 'S') and (a.ie_agora = ie_urgencia_w)) or (coalesce(a.ie_agora,'N')	= 'N'))
and		((coalesce(a.ie_acm,'S')	= 'S') or (a.ie_acm = ie_acm_w))
and		((coalesce(a.ie_se_necessario,'S')	= 'S') or (a.ie_se_necessario		= ie_se_necessario_w))
and     coalesce(a.cd_classe_material,cd_classe_material_w) = cd_classe_material_w
and     coalesce(a.cd_grupo_material,cd_grupo_material_w)   = cd_grupo_material_w
and     coalesce(a.cd_subgrupo_material,cd_subgrupo_material_w) = cd_subgrupo_material_w 	 
and		((a.nr_seq_regra = nr_seq_regra_p) or (coalesce(nr_seq_regra_p,0) = 0))
and		a.ie_tipo_item	= 'MAT'
and		ie_agrupador_w		= 2
order by 
		nr_seq_apres,
		cd_material, 
		cd_intervalo,
		ie_agora,
		cd_grupo_material,
		cd_subgrupo_material,	
		cd_classe_material;

c03 CURSOR FOR
SELECT	CASE WHEN ie_regra_geral_w='H' THEN  null  ELSE ie_regra_prim_hor END ,
		CASE WHEN ie_regra_geral_w='H' THEN  ie_regra_horarios END ,
		CASE WHEN ie_regra_geral_w='H' THEN ie_regra_prim_horarios END ,
		CASE WHEN ie_regra_geral_w='H' THEN ie_elimina_hor END ,
		CASE WHEN ie_regra_geral_w='H' THEN ie_reordenar END
from	rep_regra_copia_hor
where	nr_seq_regra_copia	= nr_seq_regra_w
order by coalesce(nr_seq_apres,999) desc;

c04 CURSOR FOR
SELECT	dt_horario
from	prescr_mat_hor a
where	((coalesce(dt_suspensao::text, '') = '') or (ie_modificar_p = 'S') or
		 ((nr_seq_motivo_susp IS NOT NULL AND nr_seq_motivo_susp::text <> '') and exists (SELECT 1 from MOTIVO_SUSPENSAO_PRESCR x where x.nr_sequencia = a.nr_seq_motivo_susp and x.IE_COPIAR = 'S')))
and		coalesce(ie_situacao,'A')	= 'A'
and		coalesce(ie_dose_especial,'N') <> 'S'
and		coalesce(ie_horario_especial,'N') = 'N'
and		nr_seq_material	= nr_seq_lista_w
and		nr_prescricao	= nr_prescr_lista_w
order by dt_horario;

c05 CURSOR FOR
SELECT  a.ie_origem_inf,
		a.cd_material,
		a.cd_unidade_medida,
		a.qt_dose,
		a.qt_unitaria,
		a.qt_material,
		a.cd_intervalo,
		trim(both reordenar_horarios(dt_inicio_prescr_tes_w, trim(both a.ds_horarios))),
		a.ds_horarios,
		a.ds_horarios_medico,
		a.ds_observacao,
		a.ie_via_aplicacao,
		coalesce(a.ie_cobra_paciente,'S'),
		CASE WHEN coalesce(a.ie_regra_disp,'X')='D' THEN  a.cd_motivo_baixa  ELSE CASE WHEN coalesce(a.ie_cobra_paciente,'S')='S' THEN  0  ELSE a.cd_motivo_baixa END  END ,
		CASE WHEN coalesce(a.ie_regra_disp,'X')='D' THEN  clock_timestamp()  ELSE CASE WHEN coalesce(a.ie_cobra_paciente,'S')='S' THEN  null  ELSE clock_timestamp() END  END ,
		a.ie_utiliza_kit,
		a.cd_unidade_medida_dose,
		a.qt_conversao_dose,
		a.nr_ocorrencia,
		a.qt_total_dispensar,
		a.cd_fornec_consignado,
		a.qt_solucao,
		a.ie_medicacao_paciente,
		CASE WHEN a.ie_se_necessario='S' THEN  null  ELSE CASE WHEN ie_regra_geral_w='I' THEN  a.hr_prim_horario  ELSE to_char(to_date('30/12/1899'||substr(dt_primeiro_horario_p,1,5),'dd/mm/yyyy hh24:mi'),'hh24:mi') END  END ,
		a.ie_agrupador,
		a.nr_dia_util,
		CASE WHEN b.ie_situacao='A' THEN  'N'  ELSE 'S' END ,
		a.ie_se_necessario,
		a.qt_min_aplicacao,
		a.ie_bomba_infusao,
		coalesce(a.ie_aplic_bolus,'N'),
		coalesce(a.ie_aplic_lenta,'N'),
		CASE WHEN ie_permite_acm_w='S' THEN coalesce(a.ie_acm,'N')  ELSE 'N' END ,
		coalesce(a.ie_uso_antimicrobiano,'N'),
		a.cd_protocolo,
		a.nr_seq_protocolo,
		a.nr_seq_mat_protocolo,
		a.qt_hora_aplicacao,
		'N',
		CASE WHEN VarCopiaJust_w='S' THEN CASE WHEN coalesce(a.qt_total_dias_lib,0)=0 THEN  a.ds_justificativa  ELSE CASE WHEN Obter_se_maior(a.qt_total_dias_lib, a.nr_dia_util+1)='N' THEN a.ds_justificativa END  END   ELSE '' END ,
		a.ie_sem_aprazamento,
		a.qt_total_dias_lib,
		a.nr_seq_substituto,
		a.qt_dia_prim_hor,
		CASE WHEN coalesce(a.ie_regra_disp,'X')='D' THEN  a.ie_regra_disp  ELSE null END ,
		a.qt_vol_adic_reconst,
		a.ie_urgencia,
		a.hr_prim_horario,
		ie_permite_substituir,
		a.ie_dose_espec_agora,
		a.nr_agrupamento,
		a.dt_suspensao_progr,
		a.nr_sequencia,
		a.nr_seq_mat_diluicao,
		Obter_estrutura_material(b.cd_material,'G'),
		Obter_estrutura_material(b.cd_material,'S'),
		Obter_estrutura_material(b.cd_material,'C'),
		a.qt_ref_diluente,
		a.ie_alterou_dose_dil
From	Material b,
		Prescr_Material a
where	b.ie_situacao		= 'A'
and		a.cd_material 		= b.cd_material
and		((a.ie_suspenso 	<> 'S') or (ie_modificar_p	= 'S'))
and		a.ie_agrupador in (3,7,9)
and 	coalesce(var_copia_diluicao_w,'S') <> 'N'
and		a.nr_sequencia_diluicao	= nr_Seq_lista_w
and		a.nr_prescricao 	= nr_prescr_lista_w;

C09 CURSOR FOR
SELECT	b.nr_sequencia,
		obter_ocorrencia_intervalo(b.cd_intervalo,coalesce(a.nr_horas_validade,24),'H'),
		b.dt_proxima_dose,
		b.nr_sequencia_anterior,
		coalesce(b.nr_prescricao_anterior,b.nr_prescricao_original),
		b.cd_material,
		b.cd_intervalo,
		b.hr_prim_horario
from	prescr_material b,
		prescr_medica a
where	((b.ie_origem_inf	<> 'K') or (Var_param1097_w = 'S'))
and		obter_se_interv_superior_24h(b.cd_intervalo,null) = 'S'
and 	((coalesce(obter_se_material_padronizado(cd_estabelecimento_p, b.cd_material),'N') = 'S') or (ie_nao_padronizado_w = 'S'))
and		b.ie_agrupador in (1,2)
and		a.nr_prescricao	= b.nr_prescricao
and		a.nr_prescricao	= nr_prescricao_p;

c10 CURSOR FOR
SELECT	nr_sequencia
from	prescr_material
where	coalesce(nr_sequencia_solucao::text, '') = ''
and		coalesce(nr_sequencia_proc::text, '') = ''
and		coalesce(nr_sequencia_dieta::text, '') = ''
and		coalesce(nr_sequencia_diluicao::text, '') = ''
and		ie_agrupador		= 1
and		nr_prescricao		= nr_prescricao_p;

c11 CURSOR FOR
SELECT	nr_sequencia
from	prescr_material
where	coalesce(nr_seq_kit::text, '') = ''
and		coalesce(nr_sequencia_diluicao::text, '') = ''
and		coalesce(nr_sequencia_solucao::text, '') = ''	
and		ie_origem_inf	<> 'K'
and		nr_sequencia	<> nr_seq_lista_w
and		ie_agrupador	= 1
and		nr_agrupamento	= nr_agrupamento_w
and		obter_se_gerar_item_plt('M',nr_prescricao, nr_sequencia, nr_agrupamento, ie_item_superior, nr_seq_kit) = 'N'
and		nr_prescricao	= nr_prescr_lista_w;

c12 CURSOR FOR
SELECT a.nr_sequencia,
       a.nr_seq_kit,
       a.nr_prescricao_anterior
  from prescr_material a,
       table(lista_pck.obter_lista(nr_prescricoes_lista_w)) b
 where a.nr_prescricao = b.nr_registro 
   and a.nr_prescricao = nr_prescricao_p
   and (a.nr_seq_kit IS NOT NULL AND a.nr_seq_kit::text <> '')
   and a.ie_agrupador in (1,2);

BEGIN

select	max(dt_inicio_prescr),
		max(nr_horas_validade),
		max(dt_validade_prescr)
into STRICT	dt_inicio_prescr_tes_w,
		nr_horas_validade_w,
		dt_validade_prescr_tes_w
from	prescr_medica
where	nr_prescricao	= nr_prescricao_p;

cd_perfil_w	:= cd_perfil_p;
CALL Wheb_assist_pck.set_informacoes_usuario(cd_estabelecimento_p, cd_perfil_w, nm_usuario_p);
ie_padronizado_w 			:=	Wheb_assist_pck.obterParametroFuncao(924,18);
ie_nao_padronizado_w		:=  Wheb_assist_pck.obterParametroFuncao(924,111);
ie_questiona_mod_atb_w		:=  Wheb_assist_pck.obterParametroFuncao(950,129);
VarCopiaJust_w				:=  Wheb_assist_pck.obterParametroFuncao(924,135);
ie_copia_direta_w			:=	Wheb_assist_pck.obterParametroFuncao(924,173);
ie_horario_sem_apraso_w		:=	Wheb_assist_pck.obterParametroFuncao(924,207);
ie_prescr_composto_w		:=	Wheb_assist_pck.obterParametroFuncao(924,224);
ie_prescr_agora_pa_w		:=	Wheb_assist_pck.obterParametroFuncao(924,311);
ie_limpar_prim_hor_acm_w	:=	Wheb_assist_pck.obterParametroFuncao(924,445);
ie_altera_dt_proxima_dose_w	:=	Wheb_assist_pck.obterParametroFuncao(924,694);
ie_gerar_diluicao_w			:=	Wheb_assist_pck.obterParametroFuncao(924,813);
ie_permite_acm_param_w		:=	Wheb_assist_pck.obterParametroFuncao(924,839);
var_param1097_w				:=	Wheb_assist_pck.obterParametroFuncao(924,1097);
ie_copia_obs_w				:=	Wheb_assist_pck.obterParametroFuncao(924,997);
var_copia_diluicao_w		:=	Wheb_assist_pck.obterParametroFuncao(924,1077);

ie_rastre_prescr_cm_w := obter_se_info_rastre_prescr('CM', wheb_usuario_pck.get_nm_usuario, obter_perfil_ativo, wheb_usuario_pck.get_cd_estabelecimento);

ie_copiar_def_infecto_w := Obter_Param_Usuario(7043, 28, cd_perfil_w, nm_usuario_p, cd_estabelecimento_p, ie_copiar_def_infecto_w);

select	max(ie_copia_albumina)
into STRICT	ie_copia_albumina_w
from	parametro_medico
where 	cd_estabelecimento = cd_estabelecimento_p;

select	max(ie_gera_disp_acm_sn)
into STRICT	ie_gera_disp_acm_sn_w
from	parametros_farmacia
where	cd_estabelecimento	= cd_estabelecimento_p;

dt_primeiro_horario_w	:= converte_char_data('30/12/1899',substr(dt_primeiro_horario_p,1,5),null);

ds_lista_w	:= ds_lista_p;

while (ds_lista_w IS NOT NULL AND ds_lista_w::text <> '') loop
	begin
	tam_lista_w			:= length(ds_lista_w);
	ie_pos_virgula_w	:= position(',' in ds_lista_w);
	ds_prescricao_w		:= substr(ds_lista_w,1,(ie_pos_virgula_w - 1));
	ie_pos_espaco_w		:= position(' ' in ds_prescricao_w);
	tam_prescricao_w	:= length(ds_prescricao_w);
	nr_prescr_lista_w	:= (substr(ds_prescricao_w,1,(ie_pos_espaco_w - 1)))::numeric;
	nr_seq_lista_w		:= (substr(ds_prescricao_w,(ie_pos_espaco_w + 1), tam_prescricao_w))::numeric;
	if (position(nr_prescr_lista_w || ',' in nr_prescricoes_lista_w) = 0) then
	    nr_prescricoes_lista_w := nr_prescricoes_lista_w || nr_prescr_lista_w || ',';
	end if;
	
	if (ie_rastre_prescr_cm_w = 'S') then
		ds_rastre_prescr_cm_w := substr(ds_rastre_prescr_cm_w || pls_util_pck.enter_w
			|| $$plsql_unit || ':' || $$plsql_line  || pls_util_pck.enter_w
			|| 'nr_prescr_lista_w:' || nr_prescr_lista_w || pls_util_pck.enter_w
			|| 'nr_seq_lista_w:' || nr_seq_lista_w, 1, 2000);
	end if;
	
	select	max(coalesce(a.nr_seq_anterior,a.nr_sequencia)),
		CASE WHEN max(a.ie_agrupador)=2 THEN 'MAT'  ELSE 'M' END
	into STRICT	nr_seq_anterior_w,
			ie_tipo_item_w
	From	Material b,
			Prescr_Material a
	where	a.cd_material 	= b.cd_material
	and		a.nr_Sequencia	= nr_seq_lista_w
	and		a.nr_prescricao = nr_prescr_lista_w;
	
	CALL plt_consiste_extensao_item(dt_inicio_prescr_tes_w, dt_validade_prescr_tes_w, nr_prescr_lista_w, nr_seq_lista_w, ie_tipo_item_w, nr_seq_regra_p, nm_usuario_p, cd_perfil_p, cd_estabelecimento_p);
	
	select	count(nr_sequencia)
	into STRICT	qt_inconsistencia_w
	from	w_copia_plano
	where	nr_prescricao	= nr_prescr_lista_w
	and		nr_seq_item	= nr_seq_lista_w
	and		ie_tipo_item	IN ('M', 'MAT')
	and		nm_usuario	= nm_usuario_p
	and		((ie_permite	= 'N') or (ie_estende_inc_p = 'N'))  LIMIT 1;	
	
	if (ie_rastre_prescr_cm_w = 'S') then
		ds_rastre_prescr_cm_w := substr(ds_rastre_prescr_cm_w || pls_util_pck.enter_w
			|| $$plsql_unit || ':' || $$plsql_line  || pls_util_pck.enter_w
			|| 'qt_inconsistencia_w:' || qt_inconsistencia_w, 1, 2000);
	end if;
	
	if	((qt_inconsistencia_w	= 0) or (ie_modificar_p 	= 'S')) then	
	
		select	max(cd_setor_atendimento),
				max(nr_atendimento),
				max(dt_primeiro_horario),
				max(nr_horas_validade),
				coalesce(max(ie_estendida_liberacao),'N')
		into STRICT	cd_setor_atendimento_w,
				nr_atendimento_w,						
				dt_primeiro_horario_mae_w,
				nr_horas_validade_mae_w,
				ie_estendida_liberacao_w
		from	prescr_medica
		where	nr_prescricao =  nr_prescr_lista_w  LIMIT 1;

		if (ie_permite_acm_param_w	= 'D') then
			ie_permite_acm_w	:= obter_se_setor_acm(cd_setor_atendimento_w);
		else
			ie_permite_acm_w	:= ie_permite_acm_param_w;
		end if;
		
		if (ie_regra_geral_w <> 'I') and (nr_atendimento_w > 0) and (ie_prescr_agora_pa_w = 'S') then
			
			cd_classif_setor_ww := Obter_Unidade_Atendimento(nr_atendimento_w,'A','CS');
			
			if (cd_classif_setor_ww IS NOT NULL AND cd_classif_setor_ww::text <> '') then
				Select	cd_classif_setor
				into STRICT	cd_classif_setor_w
				from	setor_atendimento
				where	cd_setor_atendimento = cd_classif_setor_ww;
			
				if (cd_classif_setor_w	= '1') then
					dt_prim_horario_w	:= to_char(clock_timestamp() + interval '10 days'/1440,'dd/mm/yyyy hh24:mi:ss');
					dt_primeiro_horario_w	:= to_date(substr(dt_prim_horario_w,1,15)||'0:00','dd/mm/yyyy hh24:mi:ss');
				end if;
			end if;
		end if;	
		
		select	a.ie_origem_inf,
				a.cd_material,
				a.cd_unidade_medida,
				a.qt_dose,
				a.qt_unitaria,
				a.qt_material,
				a.cd_intervalo,
				trim(both reordenar_horarios(dt_inicio_prescr_tes_w, trim(both a.ds_horarios))),
				a.ds_horarios,
				a.ds_horarios_medico,
				a.ds_observacao,				
				a.ie_via_aplicacao,
				coalesce(a.ie_cobra_paciente,'S'),
				CASE WHEN coalesce(a.ie_regra_disp,'X')='D' THEN  a.cd_motivo_baixa  ELSE CASE WHEN coalesce(a.ie_cobra_paciente,'S')='S' THEN  0  ELSE a.cd_motivo_baixa END  END ,
				CASE WHEN coalesce(a.ie_regra_disp,'X')='D' THEN  clock_timestamp()  ELSE CASE WHEN coalesce(a.ie_cobra_paciente,'S')='S' THEN  null  ELSE clock_timestamp() END  END ,
				a.ie_utiliza_kit,
				a.cd_unidade_medida_dose,
				a.qt_conversao_dose,
				a.nr_ocorrencia,
				a.qt_total_dispensar,
				a.cd_fornec_consignado,
				CASE WHEN coalesce(a.nr_sequencia_solucao::text, '') = '' THEN  null  ELSE a.nr_sequencia_solucao END ,
				CASE WHEN coalesce(a.nr_sequencia_proc::text, '') = '' THEN  null  ELSE a.nr_sequencia_proc END ,
				a.qt_solucao,
				a.ds_dose_diferenciada,
				a.ie_medicacao_paciente,
				CASE WHEN a.ie_se_necessario='S' THEN  null  ELSE CASE WHEN ie_regra_geral_w='I' THEN  a.hr_prim_horario  ELSE to_char(to_date('30/12/1899'||substr(dt_primeiro_horario_p,1,5),'dd/mm/yyyy hh24:mi'),'hh24:mi') END  END ,
				a.ie_agrupador,
				a.nr_dia_util,
				CASE WHEN b.ie_situacao='A' THEN  'N'  ELSE 'S' END ,
				a.ie_se_necessario,
				a.qt_min_aplicacao,
				a.ie_bomba_infusao,
				coalesce(a.ie_aplic_bolus,'N'),
				coalesce(a.ie_aplic_lenta,'N'),
				CASE WHEN ie_permite_acm_w='S' THEN coalesce(a.ie_acm,'N')  ELSE 'N' END ,
				a.ie_objetivo,
				a.cd_topografia_cih,
				a.ie_origem_infeccao,
				a.cd_amostra_cih,
				a.cd_microorganismo_cih,
				coalesce(a.ie_uso_antimicrobiano,'N'),
				a.cd_protocolo,
				a.nr_seq_protocolo,
				a.nr_seq_mat_protocolo,
				a.qt_hora_aplicacao,
				'N',
				a.qt_vel_infusao,
				CASE WHEN VarCopiaJust_w='S' THEN a.ds_justificativa  ELSE '' END ,
				a.ie_sem_aprazamento,
				a.ie_indicacao,
				a.dt_proxima_dose,
				a.qt_total_dias_lib,
				a.nr_seq_substituto,
				a.ie_lado,
				a.dt_inicio_medic,
				a.qt_dia_prim_hor,
				CASE WHEN coalesce(a.ie_regra_disp,'X')='D' THEN  a.ie_regra_disp  ELSE null END ,
				a.qt_vol_adic_reconst,
				a.qt_hora_intervalo,
				a.qt_min_intervalo,
				a.ie_urgencia,
				a.hr_prim_horario,
				ie_permite_substituir,
				a.nr_agrupamento,
				a.qt_dose_especial,
				a.ie_dose_espec_agora,
				a.hr_dose_especial,
				a.nr_agrupamento,
				a.dt_suspensao_progr,
				coalesce(a.nr_prescricao_original,a.nr_prescricao),
				coalesce(a.nr_seq_anterior,a.nr_sequencia),
				Obter_estrutura_material(b.cd_material,'G'),
				Obter_estrutura_material(b.cd_material,'S'),
				Obter_estrutura_material(b.cd_material,'C'),
				a.ds_medic_nao_padrao,
				a.qt_dia_prim_hor,
				CASE WHEN ie_copia_obs_w='S' THEN a.ds_observacao_enf  ELSE CASE WHEN  ie_copia_obs_w='E' THEN  a.ds_observacao_enf  ELSE null END  END ,
				CASE WHEN ie_copia_obs_w='S' THEN a.ds_observacao_far  ELSE CASE WHEN  ie_copia_obs_w='F' THEN  a.ds_observacao_far  ELSE null END  END ,
				qt_ref_diluente,
				a.cd_kit_material,
				a.nr_seq_kit,
				a.qt_dias_solicitado,
				a.qt_dias_liberado
		into STRICT		ie_origem_inf_w,
				cd_material_w,
				cd_unidade_medida_w,
				qt_dose_w,
				qt_unitaria_w,
				qt_material_w,
				cd_intervalo_w,
				ds_horarios_reordenados_w,
				ds_horarios_w,
				ds_horarios_medico_w,
				ds_observacao_w,				
				ie_via_aplicacao_w,
				ie_cobra_paciente_w,
				cd_motivo_baixa_w,
				dt_baixa_w,
				ie_utiliza_kit_w,
				cd_unidade_medida_dose_w,
				qt_conversao_dose_w,
				nr_ocorrencia_w,
				qt_total_dispensar_w,
				cd_fornec_consignado_w,
				nr_sequencia_solucao_w,
				nr_sequencia_proc_w,
				qt_solucao_w,
				ds_dose_diferenciada_w,
				ie_medicacao_paciente_w,
				hr_prim_horario_w,
				ie_agrupador_w,
				nr_dia_util_w,
				ie_suspenso_w,
				ie_se_necessario_w,
				qt_min_aplicacao_w,
				ie_bomba_infusao_w,
				ie_aplic_bolus_w,
				ie_aplic_lenta_w,
				ie_acm_w,
				ie_objetivo_w,
				cd_topografia_cih_w,
				ie_origem_infeccao_w,
				cd_amostra_cih_w,
				cd_microorganismo_cih_w,
				ie_uso_antimicrobiano_w,
				cd_protocolo_w,
				nr_seq_protocolo_w,
				nr_seq_mat_protocolo_w,
				qt_hora_aplicacao_w,
				ie_recons_diluente_fixo_w,
				qt_vel_infusao_w,
				ds_justificativa_w,
				ie_sem_aprazamento_w,
				ie_indicacao_w,
				dt_proxima_dose_w,
				qt_total_dias_lib_w,
				nr_seq_substituto_w,
				ie_lado_w,
				dt_inicio_medic_w,
				qt_dia_prim_hor_w,
				ie_regra_disp_w,
				qt_vol_adic_reconst_w,
				qt_hora_intervalo_w,
				qt_min_intervalo_w,
				ie_urgencia_w,
				hr_prim_horario_aux_w,
				IE_PERMITE_SUBSTITUIR_w,
				nr_agrup_aux_w,
				qt_dose_especial_w,
				ie_dose_espec_agora_w,
				hr_dose_especial_w,
				nr_agrupamento_w,
				dt_suspensao_progr_w,
				nr_prescricao_original_w,
				nr_seq_anterior_w,
				cd_grupo_material_w,
				cd_subgrupo_material_w,
				cd_classe_material_w,
				ds_medic_nao_padrao_w,
				qt_dia_prim_hor_mae_w,
				ds_observacao_enf_w,
				ds_observacao_far_w,
				qt_ref_diluente_w,
				cd_kit_material_w, 
				nr_seq_kit_w,
				qt_dias_solicitado_w,
				qt_dias_liberado_ww
		From		Material b,
				Prescr_Material a
		where		a.cd_material 		= b.cd_material
		and		a.nr_Sequencia		= nr_seq_lista_w
		and		a.nr_prescricao 	= nr_prescr_lista_w;
		
		select	count(b.cd_material)
		into STRICT	qt_w
		From	Material b,
			Prescr_Material a
		where	a.cd_material 		= b.cd_material
		and	verifica_medic_padronizado(a.nr_prescricao, a.cd_material, ie_padronizado_w) = 'S'
		and	((coalesce(ie_copia_agora_p,'S')	= 'S') or
			 ((ie_copia_agora_p = 'N') and (coalesce(a.ie_urgencia,'N') = 'N')))
		and	a.nr_Sequencia		= nr_seq_lista_w
		and	a.nr_prescricao 	= nr_prescr_lista_w  LIMIT 1;
		
		if (ie_rastre_prescr_cm_w = 'S') then
			ds_rastre_prescr_cm_w := substr(ds_rastre_prescr_cm_w || pls_util_pck.enter_w
				|| $$plsql_unit || ':' || $$plsql_line || pls_util_pck.enter_w
				|| 'qt_w:' || qt_w || pls_util_pck.enter_w
				|| 'ie_padronizado_w:' || ie_padronizado_w || pls_util_pck.enter_w
				|| 'nr_seq_lista_w:' || nr_seq_lista_w || pls_util_pck.enter_w
				|| 'nr_prescr_lista_w:' || nr_prescr_lista_w || pls_util_pck.enter_w, 1, 2000);
		end if;

		if (qt_w > 0) then

			if (ie_agrupador_w = 1) then
				ie_tipo_item_w := 'M';
			else
				ie_tipo_item_w := 'MAT';
			end if;

			ie_copiar_w := 'N';
			
			open C02;
			loop
			fetch C02 into	
				ie_copiar_w,
				ie_regra_geral_w,
				nr_seq_regra_w,
				cd_mat_aux_w,
				cd_intervalo_aux_w,
				ie_agora_aux_w,
				nr_seq_apres_w,
				ie_regra_dose_especial_w,
				cd_classe_mate_w,
				cd_grupo_mate_w,
				cd_subgrupo_mate_w;
			EXIT WHEN NOT FOUND; /* apply on C02 */
				ie_copiar_w		:= ie_copiar_w;
				ie_regra_geral_w	:= ie_regra_geral_w;
				nr_seq_regra_w		:= nr_seq_regra_w;
			end loop;
			close C02;
			
			if (ie_regra_geral_w	<> 'I') then
				open C03;
				loop
				fetch C03 into	
					ie_regra_prim_hor_w,
					ie_regra_horarios_w,
					ie_regra_prim_horarios_w,
					ie_elimina_hor_w,
					ie_reordenar_w;
				EXIT WHEN NOT FOUND; /* apply on C03 */
					ie_regra_prim_hor_w	:= ie_regra_prim_hor_w;
					ie_regra_horarios_w	:= ie_regra_horarios_w;
					ie_regra_prim_horarios_w := ie_regra_prim_horarios_w;
					ie_elimina_hor_w	:= ie_elimina_hor_w;
					ie_reordenar_w		:= ie_reordenar_w;
					
					if (ie_regra_horarios_w <> 'HS') then
						ie_regra_prim_hor_ant_w	:= ie_regra_prim_hor_w;
						ie_regra_horarios_ant_w	:= ie_regra_horarios_w;
						ie_regra_prim_horarios_ant_w := ie_regra_prim_horarios_w;
						ie_elimina_hor_ant_w	:= ie_elimina_hor_w;
						ie_reordenar_ant_w	:= ie_reordenar_w;
					end if;
				end loop;
				close C03;
			else
				hr_prim_horario_w	:= hr_prim_horario_aux_w;
			end if;

			if (ie_reordenar_w = 'S') then
				ds_horarios_w	:= ds_horarios_reordenados_w;
				ds_horarios_w := Reordenar_Horarios_Prescr(dt_inicio_prescr_tes_w, ds_horarios_w);
			end if;

			if (ie_acm_w = 'S') then
				ds_horarios_w	:= wheb_mensagem_pck.get_texto(309807); -- ACM
				if (ie_limpar_prim_hor_acm_w = 'S') then
					hr_prim_horario_w := '';
				end if;
			end if;
			
			select	coalesce(max(nr_sequencia),0) + 1
			into STRICT	nr_sequencia_w
			from	prescr_material
			where	nr_prescricao = nr_prescricao_p;
			
			if (ie_regra_dose_especial_w = 'N') then
				qt_dose_especial_w := null;
				ie_dose_espec_agora_w := 'N';
				hr_dose_especial_w := null;
			end if;

			if (coalesce(nr_agrupamento_p,0)	> 0) then
				nr_agrup_acum_w	:= nr_agrupamento_p;
			else
				select	coalesce(max(nr_agrupamento),0) + 1
				into STRICT	nr_agrup_acum_w
				from	prescr_material
				where	nr_prescricao = nr_prescricao_p;					
			end if;
			
			select 	max(qt_conversao)
			into STRICT	qt_conversao_dose_w
			from 	unidade_medida_dose_v
			where 	cd_material = cd_material_w
			and 	cd_unidade_medida = cd_unidade_medida_dose_w;
			
			qt_unitaria_w	:= dividir(qt_dose_w, QT_CONVERSAO_DOSE_w);
			
			if (ie_gera_disp_acm_sn_w = 'N' AND (ie_acm_w = 'S' or ie_se_necessario_w = 'S' )) then
				ie_gerar_lote_w := 'N';
			end if;
			
			ie_urgencia_ww := 'N';
			
			if (coalesce(ie_urgencia_w,'N') = 'S') and (coalesce(ie_modificar_p,'N') = 'S') and (coalesce(ie_regra_geral_w,'N') = 'I') then
				ie_urgencia_ww 		:= 'S';
				ds_horarios_w		:= to_Char(clock_timestamp(),'hh24:mi');
				hr_prim_horario_w	:= to_Char(clock_timestamp(),'hh24:mi');
			end if;
			
			Insert  into Prescr_Material(
				nr_prescricao,
				nr_sequencia,
				ie_origem_inf,
				cd_material,
				cd_unidade_medida,
				qt_dose,
				qt_unitaria,
				qt_material,
				dt_atualizacao,
				nm_usuario,
				cd_intervalo,
				ds_horarios,
				ds_observacao,
				ds_observacao_enf,
				ie_via_aplicacao,
				nr_agrupamento,
				ie_cobra_paciente,
				cd_motivo_baixa,
				dt_baixa,
				ie_utiliza_kit,
				cd_unidade_medida_dose,
				qt_conversao_dose,
				nr_ocorrencia,
				qt_total_dispensar,
				cd_fornec_consignado,
				nr_sequencia_solucao,
				nr_sequencia_proc,
				qt_solucao,
				ds_dose_diferenciada,
				ie_medicacao_paciente,
				hr_prim_horario,
				ie_agrupador,
				nr_dia_util,
				ie_suspenso,
				ie_se_necessario,
				qt_min_aplicacao,
				ie_bomba_infusao,
				ie_aplic_bolus,
				ie_aplic_lenta,
				ie_acm,
				ie_objetivo,
				cd_topografia_cih,
				ie_origem_infeccao,
				cd_amostra_cih,
				cd_microorganismo_cih,
				ie_uso_antimicrobiano,
				cd_protocolo,
				nr_seq_protocolo,
				nr_seq_mat_protocolo,
				qt_hora_aplicacao,
				ie_recons_diluente_fixo,
				qt_vel_infusao,
				ds_justificativa,
				ie_sem_aprazamento,
				ie_indicacao,
				dt_proxima_dose,
				qt_total_dias_lib,
				nr_seq_substituto,
				ie_lado,
				--dt_inicio_medic, Retirado pela solicitacao da OS 1617058
				qt_dia_prim_hor,
				ie_regra_disp,
				qt_vol_adic_reconst,
				qt_hora_intervalo,
				qt_min_intervalo,
				ie_urgencia,
				IE_PERMITE_SUBSTITUIR,
				qt_dose_especial,
				ie_dose_espec_agora,
				hr_dose_especial,
				dt_suspensao_progr,
				nr_prescricao_original,
				nr_seq_anterior,
				nr_prescricao_anterior,
				nr_sequencia_anterior,
				ds_medic_nao_padrao,
				ie_gerar_lote,
				ds_observacao_far,
				cd_kit_material,
				nr_seq_kit)
			values (
				nr_prescricao_p,
				nr_sequencia_w,
				ie_origem_inf_w,
				cd_material_w,
				cd_unidade_medida_w,
				qt_dose_w,
				qt_unitaria_w,
				qt_material_w,
				clock_timestamp(),
				nm_usuario_p,
				cd_intervalo_w,
				ds_horarios_w,
				ds_observacao_w,
				ds_observacao_enf_w,
				ie_via_aplicacao_w,
				nr_agrup_acum_w,
				ie_cobra_paciente_w,
				cd_motivo_baixa_w,
				dt_baixa_w,
				ie_utiliza_kit_w,
				cd_unidade_medida_dose_w,
				qt_conversao_dose_w,
				nr_ocorrencia_w,
				qt_total_dispensar_w,
				cd_fornec_consignado_w,
				nr_sequencia_solucao_w,
				nr_sequencia_proc_w,
				qt_solucao_w,
				ds_dose_diferenciada_w,
				ie_medicacao_paciente_w,
				hr_prim_horario_w,
				ie_agrupador_w,
				nr_dia_util_w,
				ie_suspenso_w,
				ie_se_necessario_w,
				qt_min_aplicacao_w,
				ie_bomba_infusao_w,
				ie_aplic_bolus_w,
				ie_aplic_lenta_w,
				ie_acm_w,
				ie_objetivo_w,
				cd_topografia_cih_w,
				ie_origem_infeccao_w,
				cd_amostra_cih_w,
				cd_microorganismo_cih_w,
				ie_uso_antimicrobiano_w,
				cd_protocolo_w,
				nr_seq_protocolo_w,
				nr_seq_mat_protocolo_w,
				qt_hora_aplicacao_w,
				ie_recons_diluente_fixo_w,
				qt_vel_infusao_w,
				ds_justificativa_w,
				ie_sem_aprazamento_w,
				ie_indicacao_w,
				dt_proxima_dose_w,
				qt_total_dias_lib_w,
				nr_seq_substituto_w,
				ie_lado_w,
				--dt_inicio_medic_w, Retirado pela solicitacao da OS 1617058
				qt_dia_prim_hor_w,
				ie_regra_disp_w,
				qt_vol_adic_reconst_w,
				qt_hora_intervalo_w,
				qt_min_intervalo_w,
				ie_urgencia_ww,
				IE_PERMITE_SUBSTITUIR_w,
				qt_dose_especial_w,
				ie_dose_espec_agora_w,
				hr_dose_especial_w,
				dt_suspensao_progr_w,
				nr_prescricao_original_w,
				nr_seq_anterior_w,
				nr_prescr_lista_w,
				nr_seq_lista_w,
				ds_medic_nao_padrao_w,
				ie_gerar_lote_w,
				ds_observacao_far_w,
				cd_kit_material_w, 
				nr_seq_kit_w);
			
			if (ie_rastre_prescr_cm_w = 'S') then
				begin
					ds_rastre_prescr_cm_ins_w := substr('INSERT '
						|| $$plsql_unit || ':' || $$plsql_line || pls_util_pck.enter_w
						|| 'nr_sequencia_w:' || nr_sequencia_w || pls_util_pck.enter_w
						|| 'ie_origem_inf_w:' || ie_origem_inf_w || pls_util_pck.enter_w
						|| 'cd_material_w:' || cd_material_w || pls_util_pck.enter_w
						|| 'cd_unidade_medida_w:' || cd_unidade_medida_w || pls_util_pck.enter_w
						|| 'qt_dose_w:' || qt_dose_w || pls_util_pck.enter_w
						|| 'qt_unitaria_w:' || qt_unitaria_w || pls_util_pck.enter_w
						|| 'qt_material_w:' || qt_material_w || pls_util_pck.enter_w
						|| 'cd_intervalo_w:' || cd_intervalo_w || pls_util_pck.enter_w
						|| 'ds_horarios_w:' || ds_horarios_w || pls_util_pck.enter_w
						|| 'ds_observacao_w:' || ds_observacao_w || pls_util_pck.enter_w
						|| 'ds_observacao_enf_w:' || ds_observacao_enf_w || pls_util_pck.enter_w
						|| 'ie_via_aplicacao_w:' || ie_via_aplicacao_w || pls_util_pck.enter_w
						|| 'nr_agrup_acum_w:' || nr_agrup_acum_w || pls_util_pck.enter_w
						|| 'ie_cobra_paciente_w:' || ie_cobra_paciente_w || pls_util_pck.enter_w
						|| 'cd_motivo_baixa_w:' || cd_motivo_baixa_w || pls_util_pck.enter_w
						|| 'dt_baixa_w:' || to_char(dt_baixa_w, 'dd/mm/yyyy hh24:mi:ss') || pls_util_pck.enter_w
						|| 'ie_utiliza_kit_w:' || ie_utiliza_kit_w || pls_util_pck.enter_w
						|| 'cd_unidade_medida_dose_w:' || cd_unidade_medida_dose_w || pls_util_pck.enter_w
						|| 'qt_conversao_dose_w:' || qt_conversao_dose_w || pls_util_pck.enter_w
						|| 'nr_ocorrencia_w:' || nr_ocorrencia_w || pls_util_pck.enter_w
						|| 'qt_total_dispensar_w:' || qt_total_dispensar_w || pls_util_pck.enter_w
						|| 'cd_fornec_consignado_w:' || cd_fornec_consignado_w || pls_util_pck.enter_w
						|| 'nr_sequencia_solucao_w:' || nr_sequencia_solucao_w || pls_util_pck.enter_w
						|| 'nr_sequencia_proc_w:' || nr_sequencia_proc_w || pls_util_pck.enter_w
						|| 'qt_solucao_w:' || qt_solucao_w || pls_util_pck.enter_w
						|| 'ds_dose_diferenciada_w:' || ds_dose_diferenciada_w || pls_util_pck.enter_w
						|| 'ie_medicacao_paciente_w:' || ie_medicacao_paciente_w || pls_util_pck.enter_w
						|| 'hr_prim_horario_w:' || hr_prim_horario_w || pls_util_pck.enter_w
						|| 'ie_agrupador_w:' || ie_agrupador_w || pls_util_pck.enter_w
						|| 'nr_dia_util_w:' || nr_dia_util_w || pls_util_pck.enter_w
						|| 'ie_suspenso_w:' || ie_suspenso_w || pls_util_pck.enter_w
						|| 'ie_se_necessario_w:' || ie_se_necessario_w || pls_util_pck.enter_w
						|| 'qt_min_aplicacao_w:' || qt_min_aplicacao_w || pls_util_pck.enter_w
						|| 'ie_bomba_infusao_w:' || ie_bomba_infusao_w || pls_util_pck.enter_w
						|| 'ie_aplic_bolus_w:' || ie_aplic_bolus_w || pls_util_pck.enter_w
						|| 'ie_aplic_lenta_w:' || ie_aplic_lenta_w || pls_util_pck.enter_w
						|| 'ie_acm_w:' || ie_acm_w || pls_util_pck.enter_w
						|| 'ie_objetivo_w:' || ie_objetivo_w || pls_util_pck.enter_w
						|| 'cd_topografia_cih_w:' || cd_topografia_cih_w || pls_util_pck.enter_w
						|| 'ie_origem_infeccao_w:' || ie_origem_infeccao_w || pls_util_pck.enter_w
						|| 'cd_amostra_cih_w:' || cd_amostra_cih_w || pls_util_pck.enter_w
						|| 'cd_microorganismo_cih_w:' || cd_microorganismo_cih_w || pls_util_pck.enter_w
						|| 'ie_uso_antimicrobiano_w:' || ie_uso_antimicrobiano_w || pls_util_pck.enter_w
						|| 'cd_protocolo_w:' || cd_protocolo_w || pls_util_pck.enter_w
						|| 'nr_seq_protocolo_w:' || nr_seq_protocolo_w || pls_util_pck.enter_w
						|| 'nr_seq_mat_protocolo_w:' || nr_seq_mat_protocolo_w || pls_util_pck.enter_w
						|| 'qt_hora_aplicacao_w:' || qt_hora_aplicacao_w || pls_util_pck.enter_w
						|| 'ie_recons_diluente_fixo_w:' || ie_recons_diluente_fixo_w || pls_util_pck.enter_w
						|| 'qt_vel_infusao_w:' || qt_vel_infusao_w || pls_util_pck.enter_w
						|| 'ds_justificativa_w:' || ds_justificativa_w || pls_util_pck.enter_w
						|| 'ie_sem_aprazamento_w:' || ie_sem_aprazamento_w || pls_util_pck.enter_w
						|| 'ie_indicacao_w:' || ie_indicacao_w || pls_util_pck.enter_w
						|| 'dt_proxima_dose_w:' || to_char(dt_proxima_dose_w, 'dd/mm/yyyy hh24:mi:ss') || pls_util_pck.enter_w
						|| 'qt_total_dias_lib_w:' || qt_total_dias_lib_w || pls_util_pck.enter_w
						|| 'nr_seq_substituto_w:' || nr_seq_substituto_w || pls_util_pck.enter_w
						|| 'ie_lado_w:' || ie_lado_w || pls_util_pck.enter_w
						|| 'dt_inicio_medic_w:' || to_char(dt_inicio_medic_w, 'dd/mm/yyyy hh24:mi:ss') || pls_util_pck.enter_w
						|| 'qt_dia_prim_hor_w:' || qt_dia_prim_hor_w || pls_util_pck.enter_w
						|| 'ie_regra_disp_w:' || ie_regra_disp_w || pls_util_pck.enter_w
						|| 'qt_vol_adic_reconst_w:' || qt_vol_adic_reconst_w || pls_util_pck.enter_w
						|| 'qt_hora_intervalo_w:' || qt_hora_intervalo_w || pls_util_pck.enter_w
						|| 'qt_min_intervalo_w:' || qt_min_intervalo_w || pls_util_pck.enter_w
						|| 'ie_urgencia_ww:' || ie_urgencia_ww || pls_util_pck.enter_w
						|| 'ie_permite_substituir_w:' || ie_permite_substituir_w || pls_util_pck.enter_w
						|| 'qt_dose_especial_w:' || qt_dose_especial_w || pls_util_pck.enter_w
						|| 'ie_dose_espec_agora_w:' || ie_dose_espec_agora_w || pls_util_pck.enter_w
						|| 'hr_dose_especial_w:' || hr_dose_especial_w || pls_util_pck.enter_w
						|| 'dt_suspensao_progr_w:' || to_char(dt_suspensao_progr_w, 'dd/mm/yyyy hh24:mi:ss') || pls_util_pck.enter_w
						|| 'nr_prescricao_original_w:' || nr_prescricao_original_w || pls_util_pck.enter_w
						|| 'nr_seq_anterior_w:' || nr_seq_anterior_w || pls_util_pck.enter_w
						|| 'nr_prescr_lista_w:' || nr_prescr_lista_w || pls_util_pck.enter_w
						|| 'nr_seq_lista_w:' || nr_seq_lista_w || pls_util_pck.enter_w
						|| 'ds_medic_nao_padrao_w:' || ds_medic_nao_padrao_w || pls_util_pck.enter_w
						|| 'ie_gerar_lote_w:' || ie_gerar_lote_w || pls_util_pck.enter_w
						|| 'ds_observacao_far_w:' || ds_observacao_far_w || pls_util_pck.enter_w
						|| 'cd_kit_material_w:' || cd_kit_material_w || pls_util_pck.enter_w
						|| 'nr_seq_kit_w:' || nr_seq_kit_w, 1, 2000);
				exception
					when others then						
						ds_rastre_prescr_cm_ins_w := substr('INSERT '
							|| $$plsql_unit || ':' || $$plsql_line || pls_util_pck.enter_w
							|| 'sqlcode:' || SQLSTATE || pls_util_pck.enter_w
							|| 'sqlerrm:' || substr(sqlerrm, 1, 200), 1, 2000);
				end;
				
				CALL gerar_log_prescricao(
					nr_prescricao_p		=> nr_prescricao_p,
					nr_seq_item_p		=> nr_sequencia_w,
					ie_agrupador_p		=> null,
					nr_seq_horario_p	=> null,
					ie_tipo_item_p		=> 'M',
					ds_log_p			=> ds_rastre_prescr_cm_ins_w,
					nm_usuario_p		=> wheb_usuario_pck.get_nm_usuario,
					nr_seq_objeto_p		=> 17764,
					ie_commit_p			=> 'N'
				);
				
				if (nr_seq_kit_w IS NOT NULL AND nr_seq_kit_w::text <> '') then
					begin
						select coalesce(max('S'), 'N')
						into STRICT ie_kit_w
						from prescr_material
						where nr_prescricao = nr_prescricao_p
						and nr_sequencia = nr_seq_kit_w;
						
						ds_rastre_prescr_cm_w := substr(ds_rastre_prescr_cm_w || pls_util_pck.enter_w
							|| $$plsql_unit || ':' || $$plsql_line || pls_util_pck.enter_w
							|| 'ie_kit_w:' || ie_kit_w, 1, 2000);
					exception
						when others then						
							ds_rastre_prescr_cm_w := substr(ds_rastre_prescr_cm_w || pls_util_pck.enter_w
								|| $$plsql_unit || ':' || $$plsql_line || pls_util_pck.enter_w
								|| 'sqlcode:' || SQLSTATE || pls_util_pck.enter_w
								|| 'sqlerrm:' || substr(sqlerrm, 1, 200), 1, 2000);
					end;
				end if;				
			end if;

			if (nr_agrup_acum_w = 1) and (ie_copia_albumina_w = 'S') then	

				CALL REP_copia_albumina(
							nr_prescr_lista_w,	
							nr_prescricao_p,		
							nr_seq_lista_w,		
							nr_sequencia_w,		
							nm_usuario_p);	
			end if;
		
			if (coalesce(wheb_usuario_pck.get_ie_commit, 'S') = 'S') then commit; end if;

			if (ie_modificar_p <> 'S') then			
			
				qt_dia_prim_hor_w	:= 0;
				if (hr_prim_horario_w <> '') and (hr_prim_horario_w <> '  :  ') and (hr_prim_horario_w < to_char(dt_inicio_prescr_tes_w,'hh24:mi')) then
					qt_dia_prim_hor_w	:= 1;
				end if;
			
				update	prescr_material
				set 	qt_dia_prim_hor		= qt_dia_prim_hor_w
				where	nr_prescricao 		= nr_prescricao_p
				and	nr_sequencia		= nr_sequencia_w
				and	(hr_prim_horario IS NOT NULL AND hr_prim_horario::text <> '');	
				
			else
			
				update	prescr_material
				set 	qt_dia_prim_hor		= qt_dia_prim_hor_w,
						dt_inicio_medic		= dt_inicio_medic_w
				where	nr_prescricao 		= nr_prescricao_p
				and		nr_sequencia		= nr_sequencia_w
				and		(hr_prim_horario IS NOT NULL AND hr_prim_horario::text <> '');

			end if;			
			
			 --Exclui os medicamentos de acordo com o parametro 198 da prescricao - Ivan em 25/03/2008 OS84773 
			open c10;
			loop
			fetch c10 into
				nr_seq_material_delete_w;
			EXIT WHEN NOT FOUND; /* apply on c10 */
				if (consiste_se_copia_medic(nr_prescricao_p, nr_seq_material_delete_w, cd_estabelecimento_p, nm_usuario_p) = 'N') then
					delete	from prescr_material
					where	nr_prescricao	= nr_prescricao_p
					and	nr_sequencia	= nr_seq_material_delete_w;
				end if;
			end loop;
			close c10;
			
			 --Remove as informacoes de substituicao apos copiar - Ivan em 25/03/2008 OS84773 
			if (ie_copia_direta_w = 'N') then
				update	prescr_material
				set		nr_seq_substituto	 = NULL
				where	nr_prescricao		= nr_prescricao_p
				and		(nr_seq_substituto IS NOT NULL AND nr_seq_substituto::text <> '');
			end if;
			
			begin
			insert into prescr_material_cid(
				nr_sequencia,
				cd_doenca_cid,
				nr_prescricao,
				nr_sequencia_medic,
				dt_atualizacao,
				nm_usuario,
				dt_atualizacao_nrec,
				nm_usuario_nrec)
			SELECT	nextval('prescr_material_cid_seq'),
				cd_doenca_cid,
				nr_prescricao_p,
				nr_sequencia_w,
				clock_timestamp(),
				nm_usuario_p,
				clock_timestamp(),
				nm_usuario_p
			from	prescr_material_cid
			where	nr_prescricao	= nr_prescr_lista_w
			and	nr_sequencia_medic = nr_seq_lista_w;			
			exception
				when others then
				ie_aux_w := 'X';
			end;
			
			select	coalesce(max(ie_dias_util_medic),'N')
			into STRICT	ie_dias_util_medic_w
			from	material
			where	cd_material	= cd_material_w  LIMIT 1;

			if (ie_reinicia_cont_dias_p	= 'S') and (ie_dias_util_medic_w		<> 'N') and (ie_modificar_p			= 'S') then

				update	prescr_material
				set		nr_dia_util			= CASE WHEN coalesce(nr_dia_util_w,0)=0 THEN 0  ELSE 1 END ,
						qt_total_dias_lib 	= 0
				where	nr_prescricao 		= nr_prescricao_p
				and		nr_sequencia		= nr_sequencia_w;
				
			elsif (ie_modificar_p = 'S') and (ie_dias_util_medic_w <> 'N') and (ie_reinicia_cont_dias_p = 'N') and (ie_questiona_mod_atb_w = 'S') then
				
				if (coalesce(nr_dia_util_w,0) = 0) then
					update  prescr_material
					set		qt_total_dias_lib 	= 0,
							nr_dia_util 		= nr_dia_util_w,
							qt_dias_solicitado 	= qt_dias_solicitado_w,
							qt_dias_liberado 	= qt_dias_liberado_ww
					where	nr_prescricao 		= nr_prescricao_p
					and		nr_sequencia		= nr_sequencia_w;
				end if;
			
			elsif (ie_dias_util_medic_w	<> 'N') and (ie_modificar_p		= 'N') then

				SELECT * FROM Consiste_Util_Medic(nr_prescricao_p, nr_atendimento_w, dt_prescricao_p, cd_material_w, nr_dia_util_w, QT_DIAS_LIBERADO_w, ie_controle_medico_w, qt_dias_lib_atend_w) INTO STRICT nr_dia_util_w, QT_DIAS_LIBERADO_w, ie_controle_medico_w, qt_dias_lib_atend_w;
				
				if (qt_dia_prim_hor_mae_w		= 0) and (nr_horas_validade_mae_w	> 24) and (ie_estendida_liberacao_w	= 'S') then
					nr_dia_util_w	:= nr_dia_util_w	+ 1;
				end if;	
				
				update	prescr_material
				set	nr_dia_util		= nr_dia_util_w,
					qt_total_dias_lib 	= qt_dias_lib_atend_w
				where	nr_prescricao 		= nr_prescricao_p
				and	nr_sequencia		= nr_sequencia_w;				
				
				if (qt_dias_lib_atend_w = 0) and (QT_DIAS_LIBERADO_w IS NOT NULL AND QT_DIAS_LIBERADO_w::text <> '') then
					qt_dias_lib_atend_ww	:= QT_DIAS_LIBERADO_w;
				else
					qt_dias_lib_atend_ww	:= qt_dias_lib_atend_w;
				end if;
				
				IF (ie_copiar_def_infecto_w = 'S') AND
					(((ie_dias_util_medic_w = 'O') AND
					((coalesce(qt_dias_lib_atend_ww,QT_DIAS_LIBERADO_w) - nr_dia_util_w) <> 1)) OR
					((ie_dias_util_medic_w = 'S') AND
					((coalesce(qt_dias_lib_atend_ww,QT_DIAS_LIBERADO_w) - nr_dia_util_w) <> 0 ))) THEN
					CALL CIH_Copia_Def_Infecto(nr_prescr_lista_w,nr_seq_lista_w,nr_prescricao_p,nr_sequencia_w,nm_usuario_p);	
				end if;	

				
			end if;
			
			select	count(*)
			into STRICT	qt_regra_1h_w
			from	material b,
					intervalo_prescricao d,
					prescr_material a,
					prescr_medica c
			where	a.cd_material		= b.cd_material
			and 	b.ie_tipo_material 	in (0,2,3)
			and		coalesce(a.nr_sequencia_solucao::text, '') = ''
			and 	a.cd_intervalo		= d.cd_intervalo
			and		a.nr_prescricao		= c.nr_prescricao
			and		a.nr_prescricao 	= nr_prescricao_p
			and		a.nr_sequencia		= nr_sequencia_w  LIMIT 1;
			
			if (ie_regra_geral_w = 'H') then
			
				if (ie_regra_horarios_w = 'HS') then
				
					select	CASE WHEN count(*)=0 THEN 'N'  ELSE 'S' END
					into STRICT	ie_composto_w
					from	prescr_material
					where	nr_prescricao	= nr_prescr_lista_w
					and		cd_material	<> cd_material_w
					and		nr_agrupamento	= nr_agrup_aux_w;

					select	count(*)
					into STRICT	qt_hor_w
					from	rep_horario_hor_pac
					where	nr_atendimento	= nr_atendimento_w
					and		cd_material	= cd_material_w
					and		cd_intervalo	= cd_intervalo_w
					and		coalesce(ie_composto,ie_composto_w)	= ie_composto_w
					and		coalesce(dt_cancelamento::text, '') = ''  LIMIT 1;

					if (qt_hor_w	= 0) then
						ie_regra_prim_hor_w	:= ie_regra_prim_hor_ant_w;
						ie_regra_horarios_w	:= ie_regra_horarios_ant_w;
						ie_regra_prim_horarios_w := ie_regra_prim_horarios_ant_w;
						ie_elimina_hor_w	:= ie_elimina_hor_ant_w;
						ie_reordenar_w		:= ie_reordenar_ant_w;
					end if;

				end if;
				
				if (ie_regra_horarios_w in ('HA', 'HI')) then
					ds_horarios_w	:= null;
					open c04;
					loop
					fetch c04 into	
						dt_horario_w;
					EXIT WHEN NOT FOUND; /* apply on c04 */
						if (PKG_DATE_UTILS.extract_field('MINUTE', dt_horario_w) = 0) then
							if (coalesce(ds_horarios_w::text, '') = '') then
								ds_horarios_w	:= to_char(dt_horario_w,'hh24');
							else
								ds_horarios_w	:= ds_horarios_w ||' ' || to_char(dt_horario_w,'hh24');
							end if;
				 		else
							if (coalesce(ds_horarios_w::text, '') = '') then
								ds_horarios_w	:= to_char(dt_horario_w,'hh24:mi');
							else
								ds_horarios_w	:= ds_horarios_w ||' ' || to_char(dt_horario_w,'hh24:mi');
							end if;
						end if;
					end loop;
					close c04;
					
					if (coalesce(ie_reordenar_w,'S') = 'S') then
						ds_horarios_w	:= reordenar_horarios(dt_inicio_prescr_tes_w, trim(both ds_horarios_w));
						ds_horarios_w := Reordenar_Horarios_Prescr(dt_inicio_prescr_tes_w, ds_horarios_w);
					end if;
					
					if (ie_acm_w = 'S') then
						ds_horarios_w	:= wheb_mensagem_pck.get_texto(309807);
					end if;
					
					if (ie_se_necessario_w = 'S') then
						ds_horarios_w	:= wheb_mensagem_pck.get_texto(309808); -- SN
					end if;
					
					select	max(ie_operacao),
							max(qt_operacao)
					into STRICT	ie_operacao_w,
							qt_operacao_w
					from	intervalo_prescricao
					where	cd_intervalo	= cd_intervalo_w  LIMIT 1;
					
					if (ds_horarios_w not in (wheb_mensagem_pck.get_texto(309807),wheb_mensagem_pck.get_texto(309808))) or ((coalesce(ds_horarios_w::text, '') = '') and (ie_operacao_w = 'D')) then
						ds_horarios_prim_w	:= ds_horarios_w;
						if (position(' ' in ds_horarios_prim_w) = 0) then
							ds_horarios_prim_w	:= ds_horarios_prim_w || ' ';
						end if;

						hr_prim_horario_w	:= substr(ds_horarios_prim_w,1,position(' ' in ds_horarios_prim_w) - 1);
						if (position(':' in hr_prim_horario_w) = 0) then
							hr_prim_horario_w	:= substr(hr_prim_horario_w || ':00',1,5);
						end if;
						
						if (ie_operacao_w in ('F','V')) then
							hr_prim_horario_w	:= obter_primeiro_horario(cd_intervalo_w,nr_prescricao_p,cd_material_w,ie_via_aplicacao_w);
						end if;
						
						select	max(dt_inicio_prescr)
						into STRICT	dt_inicio_prescr_ww
						from	prescr_medica
						where	nr_prescricao	= nr_prescricao_p  LIMIT 1;
						
						nr_ocorrencia_w		:= 0;
						begin
						dt_prim_hora_int_w 	:= PKG_DATE_UTILS.get_Time(dt_prescricao_w, hr_prim_horario_w);
						exception when others then
							dt_prim_hora_int_w	:= dt_inicio_prescr_tes_w;
						end;
						
						
						if (to_char(dt_primeiro_horario_w,'hh24:mi:ss') < to_char(clock_timestamp() + interval '1 days','hh24:mi:ss')) then
							dt_inicio_prescr_ww := PKG_DATE_UTILS.get_DateTime(clock_timestamp() + interval '1 days', dt_primeiro_horario_w);
						else
							dt_inicio_prescr_ww := PKG_DATE_UTILS.get_DateTime(clock_timestamp(), dt_primeiro_horario_w);
						end if;
						
						if	--(dt_prim_hora_int_w < dt_inicio_prescr_ww) and
							(ie_agrupador_w = 1) then
							
							if (somente_numero(nr_prescricoes_w) = 0) then
								nr_prescricoes_w	:= to_char(nr_prescricao_p);
							end if;

							hr_prim_horario_interv_w	:= obter_prim_hor_medic_interv(nr_atendimento_w,nr_prescricoes_w,dt_inicio_prescr_ww, cd_material_w, cd_intervalo_w,null,'H',null, qt_dose_w);
							
							begin
							dt_prim_hora_int_w 	:= PKG_DATE_UTILS.get_Time(dt_prescricao_w, PKG_DATE_UTILS.extract_field('HOUR', hr_prim_horario_interv_w), PKG_DATE_UTILS.extract_field('MINUTE', hr_prim_horario_interv_w), 0);
							exception when others then
								dt_prim_hora_int_w	:= dt_inicio_prescr_tes_w;
							end;
						end if;
						
						dt_prim_hora_int_w	:= coalesce(dt_prim_hora_int_w,dt_primeiro_horario_w);
						
						if (ie_regra_horarios_w = 'HI') and (coalesce(qt_operacao_w,0) > 0) and (ie_operacao_w in ('H')) then
							
							if (ie_operacao_w in ('H')) and (dt_prim_hora_int_w not between dt_inicio_prescr_tes_w and (dt_prim_hora_int_w + qt_operacao_w)) then
								
								while(dt_prim_hora_int_w not between dt_inicio_prescr_tes_w and (dt_prim_hora_int_w + qt_operacao_w)) loop
									dt_prim_hora_int_w	:= dt_prim_hora_int_w + qt_operacao_w/24;
								end loop;
							end if;
						end if;
												
						hr_prim_horario_w	:= to_char(dt_prim_hora_int_w, 'hh24:mi');
						
						SELECT * FROM Calcular_Horario_Prescricao(nr_prescricao_p, cd_intervalo_w, dt_primeiro_horario_w, dt_prim_hora_int_w, nr_horas_validade_w, cd_material_w, qt_hora_intervalo_w, qt_min_intervalo_w, nr_ocorrencia_w, ds_horarios_w, ds_horarios2_w, 'N', ds_dose_diferenciada_w) INTO STRICT nr_ocorrencia_w, ds_horarios_w, ds_horarios2_w;

						ds_horarios_w	:= ds_horarios_w || ds_horarios2_w;
						
						qt_dia_prim_hor_w	:= 0;
						if (hr_prim_horario_w <> '') and (hr_prim_horario_w <> '  :  ') and (hr_prim_horario_w < to_char(dt_inicio_prescr_tes_w,'hh24:mi')) then
							qt_dia_prim_hor_w	:= 1;
						end if;
					end if;
					
					
					if (ie_acm_w = 'S') and (ie_limpar_prim_hor_acm_w = 'S') then
						hr_prim_horario_w := '';
					end if;
					
					update	prescr_material
					set 	ds_horarios		= ds_horarios_w,
							hr_prim_horario		= hr_prim_horario_w,
							qt_dia_prim_hor		= qt_dia_prim_hor_w
					where	(hr_prim_horario IS NOT NULL AND hr_prim_horario::text <> '')
					and		nr_sequencia		= nr_sequencia_w
					and		nr_prescricao 		= nr_prescricao_p;
					
				elsif (ie_regra_horarios_w = 'H1') then
					nr_ocorrencia_w	:= 0;
					hr_prim_hora_medic_w		:= obter_primeiro_horario(cd_intervalo_w,nr_prescricao_p,cd_material_w,ie_via_aplicacao_w);
				
					
					if (to_char(dt_primeiro_horario_w,'hh24:mi:ss') < to_char(clock_timestamp(),'hh24:mi:ss')) then
						dt_inicio_prescr_ww := PKG_DATE_UTILS.get_DateTime(clock_timestamp() + interval '1 days', dt_primeiro_horario_w);
					else
						dt_inicio_prescr_ww := PKG_DATE_UTILS.get_DateTime(clock_timestamp(), dt_primeiro_horario_w);
					end if;
					
					if (ie_agrupador_w in (1,16)) then
						begin
						
						if (somente_numero(nr_prescricoes_w) = 0) then
							nr_prescricoes_w	:= to_char(nr_prescricao_p);
						end if;
						
						if (ie_regra_prim_hor_w = 'I') then
							if (ie_agrupador_w = 1) then
								hr_prim_horario_interv_w	:= obter_prim_hor_medic_interv(nr_atendimento_w,nr_prescricoes_w,dt_inicio_prescr_ww, cd_material_w, cd_intervalo_w,ie_regra_prim_hor_w,null,null, qt_dose_w);				
							elsif (ie_agrupador_w = 16) then
								hr_prim_horario_interv_w	:= obter_prim_hor_leite_interv(nr_atendimento_w,nr_prescricoes_w,dt_inicio_prescr_ww, cd_material_w, cd_intervalo_w,ie_regra_prim_hor_w,null,null, qt_dose_w);				
							end if;
						else
							if (ie_agrupador_w = 1) then
								hr_prim_horario_interv_w	:= obter_prim_hor_medic_interv(nr_atendimento_w,nr_prescricoes_w,dt_inicio_prescr_ww, cd_material_w, cd_intervalo_w,null,ie_regra_prim_hor_w,null, qt_dose_w);				
							elsif (ie_agrupador_w = 16) then
								hr_prim_horario_interv_w	:= obter_prim_hor_leite_interv(nr_atendimento_w,nr_prescricoes_w,dt_inicio_prescr_ww, cd_material_w, cd_intervalo_w,null,ie_regra_prim_hor_w,null, qt_dose_w);				
							end if;
						end if;
						
						
						if (coalesce(hr_prim_horario_interv_w::text, '') = '') or (hr_prim_horario_interv_w < dt_inicio_prescr_ww) then
							hr_prim_hora_medic_w	:= hr_prim_hora_medic_w;
						else
							hr_prim_hora_medic_w	:= to_char(hr_prim_horario_interv_w,'hh24:mi');
						end if;
						
				
						end;
					end if;
					
					select	max(ie_operacao)
					into STRICT	ie_operacao_w
					from	intervalo_prescricao
					where	cd_intervalo	= cd_intervalo_w  LIMIT 1;

					if (ie_operacao_w in ('F','V')) then
						hr_prim_hora_medic_w	:= obter_primeiro_horario(cd_intervalo_w,nr_prescricao_p,cd_material_w,ie_via_aplicacao_w);
					end if;
					
					hr_prim_horario_w	:= hr_prim_hora_medic_w;
					
					update	prescr_material
					set	hr_prim_horario	= hr_prim_hora_medic_w
					where	nr_prescricao 	= nr_prescricao_p
					and	nr_sequencia	= nr_sequencia_w;
					
					dt_prim_hora_int_w 	:= to_date('30/12/1899 '|| hr_prim_horario_w ||':00','dd/mm/yyyy hh24:mi:ss');
					
					SELECT * FROM Calcular_Horario_Prescricao(nr_prescricao_p, cd_intervalo_w, dt_primeiro_horario_w, coalesce(dt_prim_hora_int_w,dt_primeiro_horario_w), nr_horas_validade_w, cd_material_w, coalesce(qt_hora_intervalo_w,0), coalesce(qt_min_intervalo_w,0), nr_ocorrencia_w, ds_horarios_w, ds_horarios2_w, 'N', ds_dose_diferenciada_w) INTO STRICT nr_ocorrencia_w, ds_horarios_w, ds_horarios2_w;

					ds_horarios_w	:= ds_horarios_w || ds_horarios2_w;
					
					
					if (ie_se_necessario_w = 'S') then
						select	coalesce(max(b.qt_se_necessario),0),
								coalesce(max(b.ie_mesmo_zerado),'N')
						into STRICT		nr_ocorrencia_w,
								ie_mesmo_zerado_w
						from		intervalo_prescricao a,
								intervalo_setor b
						where	a.cd_intervalo 		= b.cd_intervalo
						and		coalesce(b.cd_setor_atendimento,cd_setor_atendimento_w)	= cd_setor_atendimento_w
						and		coalesce(b.cd_estab, cd_estabelecimento_p)			= cd_estabelecimento_p
						and		a.cd_intervalo 		= cd_intervalo_w
						and		((b.cd_material = cd_material_w) or (coalesce(b.cd_material::text, '') = ''))
						and		((b.ie_via_aplicacao = coalesce(ie_via_aplicacao_w,b.ie_via_aplicacao)) or (coalesce(b.ie_via_aplicacao::text, '') = ''))
						and		((b.cd_unidade_basica = coalesce(obter_unid_atend_setor_atual(nr_atendimento_w,cd_setor_atendimento_w,'UB'),b.cd_unidade_basica)) or (coalesce(b.cd_unidade_basica::text, '') = ''))  LIMIT 1;

						if (coalesce(nr_ocorrencia_w,0) = 0) and (ie_mesmo_zerado_w = 'N') then
							select	coalesce(max(qt_se_necessario),1)
							into STRICT		nr_ocorrencia_w
							from		intervalo_prescricao
							where	cd_intervalo	= cd_intervalo_w  LIMIT 1;
						end if;

						ds_horarios_w	:= wheb_mensagem_pck.get_texto(309808);

					elsif (ie_acm_w = 'S') then
						select	coalesce(max(b.qt_se_necessario),0),
								coalesce(max(b.ie_mesmo_zerado),'N')
						into STRICT		nr_ocorrencia_w,
								ie_mesmo_zerado_w
						from		intervalo_prescricao a,
								intervalo_setor b
						where	a.cd_intervalo 		= b.cd_intervalo
						and		coalesce(b.cd_setor_atendimento,cd_setor_atendimento_w)	= cd_setor_atendimento_w
						and		coalesce(b.cd_estab, cd_estabelecimento_p)			= cd_estabelecimento_p
						and		a.cd_intervalo 		= cd_intervalo_w
						and		((b.cd_material = cd_material_w) or (coalesce(b.cd_material::text, '') = ''))
						and		((b.ie_via_aplicacao = coalesce(ie_via_aplicacao_w,b.ie_via_aplicacao)) or (coalesce(b.ie_via_aplicacao::text, '') = ''))
						and		((b.cd_unidade_basica = coalesce(obter_unid_atend_setor_atual(nr_atendimento_w,cd_setor_atendimento_w,'UB'),b.cd_unidade_basica)) or (coalesce(b.cd_unidade_basica::text, '') = ''))  LIMIT 1;
						
						if (coalesce(nr_ocorrencia_w,0) = 0) and (ie_mesmo_zerado_w = 'N') then
					
							select	coalesce(max(qt_se_necessario),1)
							into STRICT	nr_ocorrencia_w
							from	intervalo_prescricao
							where	cd_intervalo	= cd_intervalo_w  LIMIT 1;
						end if;

						ds_horarios_w	:= wheb_mensagem_pck.get_texto(309807);
					end if;
					
					qt_dia_prim_hor_w	:= 0;
					if (hr_prim_horario_w <> '') and (hr_prim_horario_w <> '  :  ') and (hr_prim_horario_w < to_char(dt_inicio_prescr_ww,'hh24:mi')) then
						qt_dia_prim_hor_w	:= 1;
					end if;
					
					if (ie_reordenar_w = 'S') then
						ds_horarios_w	:= reordenar_horarios(dt_inicio_prescr_ww, trim(both ds_horarios_w));
					end if;
					
					if (ie_acm_w = 'S') then
						ds_horarios_w		:= wheb_mensagem_pck.get_texto(309807);
					end if;
					if (ie_se_necessario_w = 'S') then
						ds_horarios_w	:= wheb_mensagem_pck.get_texto(309808);
					end if;
					
					update	prescr_material
					set 		nr_ocorrencia		= nr_ocorrencia_w,
							qt_total_dispensar	= qt_total_dispensar_w,
							qt_material			= coalesce(qt_material_w,1),
							ds_horarios			= ds_horarios_w,
							ie_regra_disp		= CASE WHEN coalesce(ie_regra_disp,'X')='D' THEN  ie_regra_disp  ELSE ie_regra_disp_w END ,
							qt_dia_prim_hor		= qt_dia_prim_hor_w
					where	nr_prescricao 		= nr_prescricao_p
					and	nr_sequencia			= nr_sequencia_w
					and	(hr_prim_horario IS NOT NULL AND hr_prim_horario::text <> '');

					if (coalesce(ds_dose_diferenciada_w::text, '') = '') and (ie_operacao_w		in ('X', 'H')) and (ie_ajustar_qt_p 	= 'S') and (nr_horas_validade_w 	<> 24) and (ie_calcula_validade_w = 'N') then
						begin
						update	prescr_medica
						set	nr_horas_validade	= 24
						where	nr_prescricao		= nr_prescricao_p;
						
						
						if (ie_acm_w = 'S') then
							ds_horarios_w		:= wheb_mensagem_pck.get_texto(309807);
						end if;
						
						if (ie_se_necessario_w = 'S') then
							ds_horarios_w	:= wheb_mensagem_pck.get_texto(309808);
						end if;
						
						update	prescr_material
						set 	hr_dose_especial	 = NULL,
							qt_dose_especial	 = NULL,
							nr_ocorrencia		= nr_ocorrencia_w,
							qt_total_dispensar	= qt_total_dispensar_w,
							qt_material		= coalesce(qt_material_w,1),
							ds_horarios		= ds_horarios_w,
							ie_regra_disp		= CASE WHEN coalesce(ie_regra_disp,'X')='D' THEN  ie_regra_disp  ELSE ie_regra_disp_w END
						where	nr_prescricao 		= nr_prescricao_p
						and	nr_sequencia		= nr_sequencia_w;
						end;
					end if;
					
					ds_horarios_prim_w	:= ds_horarios_w;			
					
				elsif (ie_regra_horarios_w = 'HS') then

					select	CASE WHEN count(*)=0 THEN 'N'  ELSE 'S' END
					into STRICT	ie_composto_w
					from	prescr_material
					where	nr_prescricao	= nr_prescr_lista_w
					and		cd_material	<> cd_material_w
					and		nr_agrupamento	= nr_agrup_aux_w;
					
					select	max(ds_horario)
					into STRICT	ds_horarios_aux_w
					from	rep_horario_hor_pac
					where	nr_atendimento	= nr_atendimento_w
					and	cd_material	= cd_material_w
					and	cd_intervalo	= cd_intervalo_w
					and	coalesce(ie_composto,ie_composto_w)	= ie_composto_w
					and	coalesce(dt_cancelamento::text, '') = '';
					
					if (ds_horarios_aux_w IS NOT NULL AND ds_horarios_aux_w::text <> '') then
						ds_horarios_w	:= ds_horarios_aux_w;

						if (ie_acm_w = 'S') then
							ds_horarios_w	:= wheb_mensagem_pck.get_texto(309807);
						end if;
						if (ie_se_necessario_w = 'S') then
							ds_horarios_w	:= wheb_mensagem_pck.get_texto(309808);
						end if;
					
						update	prescr_material
						set 	ds_horarios		= ds_horarios_w
						where	nr_prescricao 		= nr_prescricao_p
						and	nr_sequencia		= nr_sequencia_w
						and	(hr_prim_horario IS NOT NULL AND hr_prim_horario::text <> '');
					end if;
					
				elsif (ie_regra_horarios_w = 'HO') then
				
					if (ie_acm_w = 'S') then
						ds_horarios_w		:= wheb_mensagem_pck.get_texto(309807);
						ds_horarios_medico_w	:= wheb_mensagem_pck.get_texto(309807);
					end if;
					
					if (ie_se_necessario_w = 'S') then
						ds_horarios_w	:= wheb_mensagem_pck.get_texto(309808);
						ds_horarios_medico_w	:= wheb_mensagem_pck.get_texto(309808);
					end if;
					
					update	prescr_material
					set 	ds_horarios		= coalesce(ds_horarios_medico_w,ds_horarios_w)
					where	nr_prescricao 		= nr_prescricao_p
					and	nr_sequencia		= nr_sequencia_w
					and	(hr_prim_horario IS NOT NULL AND hr_prim_horario::text <> '');
				end if;
				
				/*ds_horarios_prim_w	:= ds_horarios_w; OS 1696898*/

				
				if	((to_char(dt_primeiro_horario_w,'hh24:mi') <> to_char(dt_primeiro_horario_mae_w,'hh24:mi')) or (coalesce(nr_horas_validade_w,0)	<> coalesce(nr_horas_validade_mae_w,0))) and (coalesce(ie_elimina_hor_w,'S') = 'S') then
					
					if (ie_reordenar_w = 'S') then                                            					
						if (ie_regra_prim_horarios_w = 'B') then
							ds_horarios_aux_w	:= Reordenar_Horarios_copia(ds_horarios_w);
							hr_prim_aux_w		:= obter_prim_dshorarios(ds_horarios_aux_w);
							dt_prim_aux_w		:= converte_char_data(to_char(dt_inicio_prescr_tes_w,'dd/mm/yyyy'),hr_prim_aux_w,dt_inicio_prescr_tes_w);

							hr_prim_hor_w		:= obter_prim_dshorarios(ds_horarios_w);
							dt_prim_hor_w		:= converte_char_data(to_char(dt_inicio_prescr_tes_w,'dd/mm/yyyy'),hr_prim_hor_w,dt_inicio_prescr_tes_w);
							
							if (dt_prim_hor_w between dt_inicio_prescr_tes_w and dt_prim_aux_w) then
								ds_horarios_w	:= ds_horarios_w;
							elsif (dt_prim_aux_w between dt_inicio_prescr_tes_w and dt_prim_hor_w) then
								ds_horarios_w	:= ds_horarios_aux_w;
							else
								ds_horarios_w := reordenar_horarios_prescr(dt_inicio_prescr_tes_w, ds_horarios_w);
							end if;
						else
							ds_horarios_w := reordenar_horarios_prescr(dt_inicio_prescr_tes_w, ds_horarios_w);
						end if;
					end if;
					
					if (coalesce(ie_reordenar_ant_w,'S')  = 'S') and (coalesce(ie_regra_horarios_w,'XPTO') <> 'HS') and (ie_regra_prim_horarios_w = 'P') then
						ds_horarios_w := reordenar_horarios_prescr(dt_inicio_prescr_tes_w, ds_horarios_w);	
					end if;
					
					ie_minutos_w	:= 'S';
					if (position(':' in ds_horarios_w) = 0) then
						ie_minutos_w	:= 'N';
					end if;
					
					select	Eliminar_horarios_vigencia(ds_horarios_w, cd_intervalo_w, dt_inicio_prescr_tes_w, dt_inicio_prescr_tes_w, qt_hora_intervalo_w, qt_min_intervalo_w, nr_prescricao_p)
					into STRICT	ds_horarios_w
					;
					
					if (ie_minutos_w	= 'N') then
						ds_horarios_padr_w	:= ds_horarios_w;
						ds_horarios_w		:= '';
						while(ds_horarios_padr_w IS NOT NULL AND ds_horarios_padr_w::text <> '') loop
							select	position(':' in ds_horarios_padr_w)
							into STRICT	k
							;
				
							if (k > 1) and ((substr(ds_horarios_padr_w, 1, k -1) IS NOT NULL AND (substr(ds_horarios_padr_w, 1, k -1))::text <> '')) then
								ds_horarios_w		:= ds_horarios_w || substr(ds_horarios_padr_w, 1, k-1);
								ds_horarios_padr_w	:= substr(ds_horarios_padr_w, k + 3, 2000);
							elsif (ds_horarios_padr_w IS NOT NULL AND ds_horarios_padr_w::text <> '') then
								ds_horarios_w		:= trim(both ds_horarios_padr_w);
								ds_horarios_padr_w	:= '';
							end if;
						end loop;
					end if;
					
					if (ie_acm_w = 'S') then
						ds_horarios_w		:= wheb_mensagem_pck.get_texto(309807);
					end if;
					if (ie_se_necessario_w = 'S') then
						ds_horarios_w	:= wheb_mensagem_pck.get_texto(309808);
					end if;
					
					update	prescr_material
					set 	ds_horarios		= ds_horarios_w
					where	nr_prescricao 		= nr_prescricao_p
					and	nr_sequencia		= nr_sequencia_w
					and	(hr_prim_horario IS NOT NULL AND hr_prim_horario::text <> '');
				end if;

				ds_horarios_prim_w	:= ds_horarios_w; /*OS 1696898*/
				
				if (ie_regra_prim_horarios_w = 'B') then
					update	prescr_material
					set 	hr_prim_horario		 = NULL
					where	nr_prescricao 		= nr_prescricao_p
					and	nr_sequencia		= nr_sequencia_w
					and	(hr_prim_horario IS NOT NULL AND hr_prim_horario::text <> '');
				elsif (ie_regra_prim_horarios_w = 'P') and (upper(ds_horarios_prim_w) <> wheb_mensagem_pck.get_texto(309807)) and (upper(ds_horarios_prim_w)<> wheb_mensagem_pck.get_texto(309808)) then
					
					ds_horarios_prim_w	:= trim(both ds_horarios_prim_w);

					if (position(' ' in ds_horarios_prim_w) = 0) then		
						ds_horarios_prim_w	:= ds_horarios_prim_w || ' ';
					end if;

					hr_prim_horario_w	:= substr(ds_horarios_prim_w,1,position(' ' in ds_horarios_prim_w) - 1);
					if (position(':' in hr_prim_horario_w) = 0) then
						hr_prim_horario_w	:= hr_prim_horario_w || ':00';
					end if;
					
					qt_dia_prim_hor_w	:= 0;
					if (hr_prim_horario_w <> '') and (hr_prim_horario_w <> '  :  ') and (hr_prim_horario_w < to_char(dt_inicio_prescr_tes_w,'hh24:mi')) then
						qt_dia_prim_hor_w	:= 1;
					end if;
					
					if (ie_acm_w = 'S') and (ie_limpar_prim_hor_acm_w = 'S') then
						hr_prim_horario_w := '';
					end if;
					
					update	prescr_material
					set 	hr_prim_horario		= hr_prim_horario_w,
						qt_dia_prim_hor		= qt_dia_prim_hor_w
					where	nr_prescricao 		= nr_prescricao_p
					and	nr_sequencia		= nr_sequencia_w;
					--and	hr_prim_horario		is not null;
				end if;
				
			elsif (ie_regra_geral_w = '1H') and (qt_regra_1h_w > 0) then

				select	d.ie_operacao,
						c.dt_inicio_prescr,
						to_char(c.dt_primeiro_horario,'hh24:mi') hr_inicio_prescr
				into STRICT	ie_operacao_w,
						dt_inicio_prescr_ww,
						hr_inicio_prescr_w
				from	material b,
						intervalo_prescricao d,
						prescr_material a,
						prescr_medica c
				where	a.cd_material		= b.cd_material
				and 	b.ie_tipo_material 	in (0,2,3)
				and		coalesce(a.nr_sequencia_solucao::text, '') = ''
				and 	a.cd_intervalo		= d.cd_intervalo
				and		a.nr_prescricao		= c.nr_prescricao
				and		a.nr_prescricao 	= nr_prescricao_p
				and		a.nr_sequencia		= nr_sequencia_w;
				
				ds_horarios_ww		:= ds_horarios_w;
				hr_prim_horario_ww	:= hr_prim_horario_w;
					
				if (ie_se_necessario_w <> 'S') then
					nr_ocorrencia_w	:= 0;
					hr_prim_hora_medic_w		:= obter_primeiro_horario(cd_intervalo_w,nr_prescricao_p,cd_material_w,ie_via_aplicacao_w);
					
					if (ie_regra_prim_hor_w in ('I','H')) and (ie_agrupador_w in (1,16)) then
						begin
						nr_prescricoes_w	:= to_char(NR_PRESCRICAO_P);
						
						if (ie_regra_prim_hor_w = 'I') then
							if (ie_agrupador_w = 1) then
								hr_prim_horario_interv_w	:= obter_prim_hor_medic_interv(nr_atendimento_w,nr_prescricoes_w,dt_inicio_prescr_ww, cd_material_w, cd_intervalo_w,ie_regra_prim_hor_w,null,null, qt_dose_w);				
							elsif (ie_agrupador_w = 16) then
								hr_prim_horario_interv_w	:= obter_prim_hor_leite_interv(nr_atendimento_w,nr_prescricoes_w,dt_inicio_prescr_ww, cd_material_w, cd_intervalo_w,ie_regra_prim_hor_w,null,null, qt_dose_w);				
							end if;
						else
							if (ie_agrupador_w = 1) then
								hr_prim_horario_interv_w	:= obter_prim_hor_medic_interv(nr_atendimento_w,nr_prescricoes_w,dt_inicio_prescr_ww, cd_material_w, cd_intervalo_w,null,ie_regra_prim_hor_w,null, qt_dose_w);				
							elsif (ie_agrupador_w = 16) then
								hr_prim_horario_interv_w	:= obter_prim_hor_leite_interv(nr_atendimento_w,nr_prescricoes_w,dt_inicio_prescr_ww, cd_material_w, cd_intervalo_w,null,ie_regra_prim_hor_w,null, qt_dose_w);				
							end if;
						end if;

						if (coalesce(hr_prim_horario_interv_w::text, '') = '') or
							(ie_regra_prim_hor_w = 'I' AND hr_prim_horario_interv_w < dt_inicio_prescr_ww) then
							hr_prim_hora_medic_w	:= hr_prim_hora_medic_w;
						else
							hr_prim_hora_medic_w	:= to_char(hr_prim_horario_interv_w,'hh24:mi');
						end if;
						end;
					end if;

					if (ie_operacao_w in ('F','V')) and (ie_regra_prim_hor_w <> 'I') then
						hr_prim_hora_medic_w	:= obter_primeiro_horario(cd_intervalo_w,NR_PRESCRICAO_p,cd_material_w,ie_via_aplicacao_w);
					end if;
						
					if (ie_regra_geral_w <> 'I') then
						hr_prim_horario_w	:= hr_prim_hora_medic_w;
						update	prescr_material
						set	hr_prim_horario	= hr_prim_hora_medic_w
						where	nr_prescricao 	= nr_prescricao_p
						and	nr_sequencia	= nr_sequencia_w;
					end if;

					dt_prim_hora_int_w 	:= converte_char_data(to_char(dt_prescricao_w,'dd/mm/yyyy'), hr_prim_horario_w ||':00',null);
					SELECT * FROM Calcular_Horario_Prescricao(nr_prescricao_p, cd_intervalo_w, dt_primeiro_horario_w, coalesce(dt_prim_hora_int_w,dt_primeiro_horario_w), nr_horas_validade_w, cd_material_w, qt_hora_intervalo_w, qt_min_intervalo_w, nr_ocorrencia_w, ds_horarios_w, ds_horarios2_w, 'N', ds_dose_diferenciada_w) INTO STRICT nr_ocorrencia_w, ds_horarios_w, ds_horarios2_w;

					ds_horarios_w	:= ds_horarios_w || ds_horarios2_w;

				end if;
				
				if (ie_se_necessario_w = 'S') then
					select	coalesce(max(b.qt_se_necessario),0),
						coalesce(max(b.ie_mesmo_zerado),'N')
					into STRICT	qt_se_necessario_w,
						ie_mesmo_zerado_w
					from	intervalo_prescricao a,
						intervalo_setor b
					where	a.cd_intervalo 		= b.cd_intervalo
					and	coalesce(b.cd_setor_atendimento,cd_setor_atendimento_w)	= cd_setor_atendimento_w
					and	coalesce(b.cd_estab, cd_estabelecimento_p)			= cd_estabelecimento_p
					and	a.cd_intervalo 		= cd_intervalo_w
					and	((b.cd_material = cd_material_w) or (coalesce(b.cd_material::text, '') = ''))
					and	((b.ie_via_aplicacao = coalesce(ie_via_aplicacao_w,b.ie_via_aplicacao)) or (coalesce(b.ie_via_aplicacao::text, '') = ''))
					and	((b.cd_unidade_basica = coalesce(obter_unid_atend_setor_atual(nr_atendimento_w,cd_setor_atendimento_w,'UB'),b.cd_unidade_basica)) or (coalesce(b.cd_unidade_basica::text, '') = ''))  LIMIT 1;
						
					if (coalesce(qt_se_necessario_w,0) = 0) and (ie_mesmo_zerado_w = 'N') then
					
						select	coalesce(max(qt_se_necessario),1)
						into STRICT	qt_se_necessario_w
						from	intervalo_prescricao
						where	cd_intervalo	= cd_intervalo_w  LIMIT 1;
					end if;
					nr_ocorrencia_w	:= qt_se_necessario_w;	
					ds_horarios_w	:= wheb_mensagem_pck.get_texto(309808);

				elsif (ie_acm_w = 'S') then

					select	coalesce(max(b.qt_se_necessario),0),
						coalesce(max(b.ie_mesmo_zerado),'N')
					into STRICT	qt_se_necessario_w,
						ie_mesmo_zerado_w
					from	intervalo_prescricao a,
						intervalo_setor b
					where	a.cd_intervalo 		= b.cd_intervalo
					and	coalesce(b.cd_setor_atendimento,cd_setor_atendimento_w)	= cd_setor_atendimento_w
					and	coalesce(b.cd_estab, cd_estabelecimento_p)			= cd_estabelecimento_p
					and	a.cd_intervalo 		= cd_intervalo_w
					and		((b.cd_material = cd_material_w) or (coalesce(b.cd_material::text, '') = ''))
					and		((b.ie_via_aplicacao = coalesce(ie_via_aplicacao_w,b.ie_via_aplicacao)) or (coalesce(b.ie_via_aplicacao::text, '') = ''))
					and		((b.cd_unidade_basica = coalesce(obter_unid_atend_setor_atual(nr_atendimento_w,cd_setor_atendimento_w,'UB'),b.cd_unidade_basica)) or (coalesce(b.cd_unidade_basica::text, '') = ''))  LIMIT 1;
						
					if (coalesce(qt_se_necessario_w,0) = 0) and (ie_mesmo_zerado_w = 'N') then
				
						select	coalesce(max(qt_se_necessario),1)
						into STRICT	qt_se_necessario_w
						from	intervalo_prescricao
						where	cd_intervalo	= cd_intervalo_w  LIMIT 1;
					end if;
					nr_ocorrencia_w	:= qt_se_necessario_w;
					ds_horarios_w	:= wheb_mensagem_pck.get_texto(309807);
				end if;

				if (ds_dose_diferenciada_w IS NOT NULL AND ds_dose_diferenciada_w::text <> '') then
					ds_dose_dif_w	:= ds_dose_diferenciada_w;
					qt_material_w	:= 0;
					while (ds_dose_dif_w IS NOT NULL AND ds_dose_dif_w::text <> '') LOOP
						begin
						i	:= position('-' in ds_dose_dif_w);
						if (i > 0) then
							qt_material_w		:= qt_material_w + somente_numero(substr(ds_dose_dif_w, 1, i-1));
							ds_dose_dif_w		:= substr(ds_dose_dif_w, i+1, 255);
						else
							qt_material_w		:= qt_material_w + somente_numero(ds_dose_dif_w);
							ds_dose_dif_w		:= '';
						end if;

						end;
					end loop;

					qt_material_w	:= obter_conversao_unid_med_cons(cd_material_w,cd_unidade_medida_dose_w,qt_material_w);
				end if;

				SELECT * FROM Obter_Quant_Dispensar(cd_estabelecimento_p, cd_material_w, nr_prescricao_p, nr_sequencia_w, cd_intervalo_w, ie_via_aplicacao_w, qt_unitaria_w, qt_dose_especial_w, nr_ocorrencia_w, ds_dose_diferenciada_w, ie_origem_inf_w, cd_unidade_medida_dose_w, 1, qt_material_w, qt_total_dispensar_w, ie_regra_disp_w, ds_erro_w, ie_se_necessario_w, ie_acm_w) INTO STRICT qt_material_w, qt_total_dispensar_w, ie_regra_disp_w, ds_erro_w;

				if (coalesce(hr_prim_horario_ww::text, '') = '') then
					ds_horarios_w	:= ds_horarios_ww;
				end if;
					
				qt_dia_prim_hor_w	:= 0;
				if (hr_prim_horario_w <> '') and (hr_prim_horario_w <> '  :  ') and (hr_prim_horario_w < to_char(dt_inicio_prescr_ww,'hh24:mi')) then
					qt_dia_prim_hor_w	:= 1;
				end if;
					
				if (ie_reordenar_w = 'S') then
					ds_horarios_w	:= reordenar_horarios(dt_inicio_prescr_ww, trim(both ds_horarios_w));
				end if;

				update	prescr_material
				set 	NR_OCORRENCIA		= nr_ocorrencia_w,
					qt_total_dispensar	= qt_total_dispensar_w,
					qt_material		= qt_material_w,
					ds_horarios		= ds_horarios_w,
					ie_regra_disp		= CASE WHEN coalesce(ie_regra_disp,'X')='D' THEN  ie_regra_disp  ELSE ie_regra_disp_w END ,
					qt_dia_prim_hor		= qt_dia_prim_hor_w
				where	nr_prescricao 		= nr_prescricao_p
				and	nr_sequencia		= nr_sequencia_w;
				--and	hr_prim_horario		is not null; Tratamento identico a REP
				CALL Ajustar_Prescr_Material(nr_prescricao_p,nr_sequencia_w);
			end if;
			



			if (qt_se_necessario_w <> nr_ocorrencia_w) then
				Select	max(obter_ocorrencias_horarios_rep(ds_horarios_w))
				into STRICT	nr_ocorrencia_w
				;
			end if;
				
			SELECT * FROM Obter_Quant_Dispensar(cd_estabelecimento_p, cd_material_w, nr_prescricao_p, nr_sequencia_w, cd_intervalo_w, ie_via_aplicacao_w, qt_unitaria_w, qt_dose_especial_w, nr_ocorrencia_w, ds_dose_diferenciada_w, ie_origem_inf_w, cd_unidade_medida_dose_w, 1, qt_material_w, qt_total_dispensar_w, ie_regra_disp_w, ds_erro_w, ie_se_necessario_w, ie_acm_w) INTO STRICT qt_material_w, qt_total_dispensar_w, ie_regra_disp_w, ds_erro_w;
						
			update	prescr_material
			set 	NR_OCORRENCIA		= nr_ocorrencia_w,
				qt_total_dispensar	= qt_total_dispensar_w,
				qt_material		= qt_material_w,
				ie_regra_disp		= CASE WHEN coalesce(ie_regra_disp,'X')='D' THEN  ie_regra_disp  ELSE ie_regra_disp_w END
			where	nr_prescricao 		= nr_prescricao_p
			and	nr_sequencia		= nr_sequencia_w;
			--and	hr_prim_horario		is not null; Tratamento identico a REP
			
			update	prescr_material
			set	hr_prim_horario	 = NULL,
				ds_horarios	 = NULL
			where	nr_prescricao	= nr_prescricao_p
			and	coalesce(ie_sem_aprazamento,'N')	= 'S'
			and	ie_horario_sem_apraso_w		= 'S'
			and	ie_agrupador	= 1;

			if (coalesce(wheb_usuario_pck.get_ie_commit, 'S') = 'S') then commit; end if;
			ds_lista_composto_w	:= null;
			--compostos
			open C11;
			loop
			fetch C11 into	
				nr_seq_composto_w;
			EXIT WHEN NOT FOUND; /* apply on C11 */
				begin
				if (coalesce(ds_lista_composto_w::text, '') = '') then
					ds_lista_composto_w	:= nr_prescr_lista_w || ' ' || nr_seq_composto_w || ',';
				else
					ds_lista_composto_w	:= ds_lista_composto_w || nr_prescr_lista_w || ' ' || nr_seq_composto_w || ',';
				end if;	
				end;
			end loop;
			close C11;
			
			if (ds_lista_composto_w IS NOT NULL AND ds_lista_composto_w::text <> '') then
				CALL PLT_copia_medicamento(nr_Prescricao_p, nr_seq_regra_p, dt_prescricao_p,dt_primeiro_horario_p,cd_perfil_p,
							ie_ajustar_qt_p,ds_lista_composto_w,ie_modificar_p,ie_reinicia_cont_dias_p,
							nm_usuario_p,cd_estabelecimento_p,ie_estende_inc_p,ie_copia_agora_p,nr_agrup_acum_w);
			end if;
			
			open C05; --Diluentes
			loop
			fetch C05 into	
				ie_origem_inf_w,
				cd_material_w,
				cd_unidade_medida_w,
				qt_dose_w,
				qt_unitaria_w,
				qt_material_w,
				cd_intervalo_w,
				ds_horarios_reordenados_w,
				ds_horarios_w,
				ds_horarios_medico_w,
				ds_observacao_w,
				ie_via_aplicacao_w,
				ie_cobra_paciente_w,
				cd_motivo_baixa_w,
				dt_baixa_w,
				ie_utiliza_kit_w,
				cd_unidade_medida_dose_w,
				qt_conversao_dose_w,
				nr_ocorrencia_w,
				qt_total_dispensar_w,
				cd_fornec_consignado_w,
				qt_solucao_w,
				ie_medicacao_paciente_w,
				hr_prim_horario_w,
				ie_agrupador_w,
				nr_dia_util_w,
				ie_suspenso_w,
				ie_se_necessario_w,
				qt_min_aplicacao_w,
				ie_bomba_infusao_w,
				ie_aplic_bolus_w,
				ie_aplic_lenta_w,
				ie_acm_w,
				ie_uso_antimicrobiano_w,
				cd_protocolo_w,
				nr_seq_protocolo_w,
				nr_seq_mat_protocolo_w,
				qt_hora_aplicacao_w,
				ie_recons_diluente_fixo_w,
				ds_justificativa_w,
				ie_sem_aprazamento_w,
				qt_total_dias_lib_w,
				nr_seq_substituto_w,
				qt_dia_prim_hor_w,
				ie_regra_disp_w,
				qt_vol_adic_reconst_w,
				ie_urgencia_w,
				hr_prim_horario_aux_w,
				IE_PERMITE_SUBSTITUIR_w,
				ie_dose_espec_agora_w,
				nr_agrupamento_w,
				dt_suspensao_progr_w,
				nr_seq_dil_w,
				nr_seq_mat_diluicao_ww,
				cd_grupo_material_w,
				cd_subgrupo_material_w,
				cd_classe_material_w,
				qt_ref_diluente_w,
				ie_alterou_dose_dil_w;
			EXIT WHEN NOT FOUND; /* apply on C05 */
				
				select	coalesce(max('S'),'N')
				into STRICT	ie_diluente_copiado_w
				from	prescr_material
				where	nr_prescricao		= nr_prescricao_p
				and		nr_sequencia_diluicao	= nr_sequencia_w
				and		cd_material		= cd_material_w
				and		qt_dose			= qt_dose_w
				and		ie_via_aplicacao	= ie_via_aplicacao_w
				--and		cd_intervalo		= cd_intervalo_w
				and		ie_agrupador		= ie_agrupador_w  LIMIT 1;
			
				if (ie_diluente_copiado_w	= 'N') then
				
					ie_copiar_w := 'N';
				
					open C02;
					loop
					fetch C02 into	
						ie_copiar_w,
						ie_regra_geral_w,
						nr_seq_regra_w,
						cd_mat_aux_w,
						cd_intervalo_aux_w,
						ie_agora_aux_w,
						nr_seq_apres_w,
						ie_regra_dose_especial_w,
						cd_classe_mate_w,
						cd_grupo_mate_w,
						cd_subgrupo_mate_w;
					EXIT WHEN NOT FOUND; /* apply on C02 */
						ie_copiar_w		:= ie_copiar_w;
						ie_regra_geral_w	:= ie_regra_geral_w;
						nr_seq_regra_w		:= nr_seq_regra_w;
					end loop;
					close C02;
					
					if (ie_regra_geral_w	<> 'I') then
						open C03;
						loop
						fetch C03 into	
							ie_regra_prim_hor_w,
							ie_regra_horarios_w,
							ie_regra_prim_horarios_w,
							ie_elimina_hor_w,
							ie_reordenar_w;
						EXIT WHEN NOT FOUND; /* apply on C03 */
							ie_regra_prim_hor_w	:= ie_regra_prim_hor_w;
							ie_regra_horarios_w	:= ie_regra_horarios_w;
							ie_regra_prim_horarios_w := ie_regra_prim_horarios_w;
							ie_elimina_hor_w	:= ie_elimina_hor_w;
							ie_reordenar_w		:= ie_reordenar_w;
							
							if (ie_regra_horarios_w <> 'HS') then
								ie_regra_prim_hor_ant_w	:= ie_regra_prim_hor_w;
								ie_regra_horarios_ant_w	:= ie_regra_horarios_w;
								ie_regra_prim_horarios_ant_w := ie_regra_prim_horarios_w;
								ie_elimina_hor_ant_w	:= ie_elimina_hor_w;
								ie_reordenar_ant_w	:= ie_reordenar_w;
							end if;
						end loop;
						close C03;
					else
						hr_prim_horario_w	:= hr_prim_horario_aux_w;
					end if;
					
					if (ie_reordenar_w = 'S') then
						ds_horarios_w	:= ds_horarios_reordenados_w;
						ds_horarios_w := Reordenar_Horarios_Prescr(dt_inicio_prescr_tes_w, ds_horarios_w);
					end if;
					
					if (coalesce(ds_horarios_w::text, '') = '') then
						select	substr(ds_horarios,1,255)
						into STRICT	ds_horarios_w
						from	prescr_material
						where	nr_prescricao  = nr_prescricao_p
						and		nr_sequencia   = nr_sequencia_w;
					end if;	
					
					select	coalesce(max(nr_sequencia),0) + 1
					into STRICT	nr_sequencia_dil_w
					from	prescr_material
					where	nr_prescricao = nr_prescricao_p;
					
					if (ie_regra_dose_especial_w = 'N') then
						qt_dose_especial_w := null;
						ie_dose_espec_agora_w := 'N';
						hr_dose_especial_w := null;
					end if;
					
					if (ie_gera_disp_acm_sn_w = 'N' AND (ie_acm_w = 'S' or ie_se_necessario_w = 'S' )) then
						ie_gerar_lote_w := 'N';
					end if;
					
					ie_urgencia_ww := 'N';
			
					if (coalesce(ie_urgencia_w,'N') = 'S') and (coalesce(ie_modificar_p,'N') = 'S') and (coalesce(ie_regra_geral_w,'N') = 'I') then
						ie_urgencia_ww 		:= 'S';
						ds_horarios_w		:= to_Char(clock_timestamp(),'hh24:mi');
						hr_prim_horario_w	:= to_Char(clock_timestamp(),'hh24:mi');
					end if;
					
					Insert  into Prescr_Material(
						nr_prescricao,
						nr_sequencia,
						ie_origem_inf,
						cd_material,
						cd_unidade_medida,
						qt_dose,
						qt_unitaria,
						qt_material,
						dt_atualizacao,
						nm_usuario,
						cd_intervalo,
						ds_horarios,
						ds_observacao,
						ie_via_aplicacao,
						nr_agrupamento,
						ie_cobra_paciente,
						cd_motivo_baixa,
						dt_baixa,
						ie_utiliza_kit,
						cd_unidade_medida_dose,
						qt_conversao_dose,
						nr_ocorrencia,
						qt_total_dispensar,
						cd_fornec_consignado,
						qt_solucao,
						ie_medicacao_paciente,
						nr_sequencia_diluicao,
						hr_prim_horario,
						ie_agrupador,
						nr_dia_util,
						ie_suspenso,
						ie_se_necessario,
						qt_min_aplicacao,
						ie_bomba_infusao,
						ie_aplic_bolus,
						ie_aplic_lenta,
						ie_acm,
						ie_uso_antimicrobiano,
						cd_protocolo,
						nr_seq_protocolo,
						nr_seq_mat_protocolo,
						qt_hora_aplicacao,
						ie_recons_diluente_fixo,
						ds_justificativa,
						ie_sem_aprazamento,
						qt_total_dias_lib,
						nr_seq_substituto,
						qt_dia_prim_hor,
						ie_regra_disp,
						qt_vol_adic_reconst,
						ie_urgencia,
						IE_PERMITE_SUBSTITUIR,
						ie_dose_espec_agora,
						dt_suspensao_progr,
						nr_prescricao_anterior,
						nr_sequencia_anterior,
						ie_gerar_lote,
						qt_ref_diluente,
						nr_seq_mat_diluicao,
						ie_alterou_dose_dil)
					values (nr_prescricao_p,
						nr_sequencia_dil_w,
						ie_origem_inf_w,
						cd_material_w,
						cd_unidade_medida_w,
						qt_dose_w,
						qt_unitaria_w,
						qt_material_w,
						clock_timestamp(),
						nm_usuario_p,
						cd_intervalo_w,
						ds_horarios_w,
						ds_observacao_w,
						ie_via_aplicacao_w,
						0,
						ie_cobra_paciente_w,
						cd_motivo_baixa_w,
						dt_baixa_w,
						ie_utiliza_kit_w,
						cd_unidade_medida_dose_w,
						qt_conversao_dose_w,
						nr_ocorrencia_w,
						qt_total_dispensar_w,
						cd_fornec_consignado_w,
						qt_solucao_w,
						ie_medicacao_paciente_w,
						nr_sequencia_w,
						hr_prim_horario_w,
						ie_agrupador_w,
						nr_dia_util_w,
						ie_suspenso_w,
						ie_se_necessario_w,
						qt_min_aplicacao_w,
						ie_bomba_infusao_w,
						ie_aplic_bolus_w,
						ie_aplic_lenta_w,
						ie_acm_w,
						ie_uso_antimicrobiano_w,
						cd_protocolo_w,
						nr_seq_protocolo_w,
						nr_seq_mat_protocolo_w,
						qt_hora_aplicacao_w,
						ie_recons_diluente_fixo_w,
						ds_justificativa_w,
						ie_sem_aprazamento_w,
						qt_total_dias_lib_w,
						nr_seq_substituto_w,
						qt_dia_prim_hor_w,
						ie_regra_disp_w,
						qt_vol_adic_reconst_w,
						ie_urgencia_ww,
						IE_PERMITE_SUBSTITUIR_w,
						ie_dose_espec_agora_w,
						dt_suspensao_progr_w,
						nr_prescr_lista_w,
						nr_seq_dil_w,
						ie_gerar_lote_w,
						qt_ref_diluente_w,
						nr_seq_mat_diluicao_ww,
						ie_alterou_dose_dil_w);
						
					if (coalesce(wheb_usuario_pck.get_ie_commit, 'S') = 'S') then commit; end if;	
						
					qt_dia_prim_hor_w	:= 0;
					if (hr_prim_horario_w <> '') and (hr_prim_horario_w <> '  :  ') and (hr_prim_horario_w < to_char(dt_inicio_prescr_tes_w,'hh24:mi')) then
						qt_dia_prim_hor_w	:= 1;
					end if;

					update	prescr_material
					set 	qt_dia_prim_hor		= qt_dia_prim_hor_w
					where	nr_prescricao 		= nr_prescricao_p
					and	nr_sequencia		= nr_sequencia_dil_w
					and	(hr_prim_horario IS NOT NULL AND hr_prim_horario::text <> '');
					
					-- Exclui os medicamentos de acordo com o parametro 198 da prescricao - Ivan em 25/03/2008 OS84773 
					open c10;
					loop
					fetch c10 into
						nr_seq_material_delete_w;
					EXIT WHEN NOT FOUND; /* apply on c10 */
						if (consiste_se_copia_medic(nr_prescricao_p, nr_seq_material_delete_w, cd_estabelecimento_p, nm_usuario_p) = 'N') then
							delete	from prescr_material
							where	nr_prescricao	= nr_prescricao_p
							and	nr_sequencia	= nr_seq_material_delete_w;
						end if;
					end loop;
					close c10;
					
					-- Remove as informacoes de substituicao apos copiar - Ivan em 25/03/2008 OS84773 
					if (ie_copia_direta_w = 'N') then
						update	prescr_material
						set	nr_seq_substituto	 = NULL
						where	nr_prescricao		= nr_prescricao_p
						and	(nr_seq_substituto IS NOT NULL AND nr_seq_substituto::text <> '');
					end if;
					
					select	coalesce(max(ie_dias_util_medic),'N')
					into STRICT	ie_dias_util_medic_w
					from	material
					where	cd_material	= cd_material_w;

					if (ie_reinicia_cont_dias_p	= 'S') and (ie_dias_util_medic_w		<> 'N') and (ie_modificar_p			= 'S') then			

						update	prescr_material
						set	nr_dia_util		= 1,
							qt_total_dias_lib 	= 0
						where	nr_prescricao 		= nr_prescricao_p
						and	nr_sequencia		= nr_sequencia_dil_w;
						
					elsif (ie_dias_util_medic_w	<> 'N') and (ie_modificar_p		= 'N') then

						SELECT * FROM Consiste_Util_Medic(nr_prescricao_p, nr_atendimento_w, dt_prescricao_p, cd_material_w, nr_dia_util_w, QT_DIAS_LIBERADO_w, ie_controle_medico_w, qt_dias_lib_atend_w) INTO STRICT nr_dia_util_w, QT_DIAS_LIBERADO_w, ie_controle_medico_w, qt_dias_lib_atend_w;
						
						update	prescr_material
						set	nr_dia_util		= nr_dia_util_w,
							qt_total_dias_lib 	= qt_dias_lib_atend_w
						where	nr_prescricao 		= nr_prescricao_p
						and	nr_sequencia		= nr_sequencia_dil_w;
					end if;

					if (ie_regra_geral_w = 'H') then
					
						if (ie_regra_horarios_w = 'HS') then
						
							select	CASE WHEN count(*)=0 THEN 'N'  ELSE 'S' END
							into STRICT	ie_composto_w
							from	prescr_material
							where	nr_prescricao	= nr_prescr_lista_w
							and	cd_material	<> cd_material_w
							and	nr_agrupamento	= nr_agrup_aux_w;
							
							select	count(*)
							into STRICT	qt_hor_w
							from	rep_horario_hor_pac
							where	nr_atendimento	= nr_atendimento_w
							and	cd_material	= cd_material_w
							and	cd_intervalo	= cd_intervalo_w
							and	coalesce(ie_composto,ie_composto_w)	= ie_composto_w
							and	coalesce(dt_cancelamento::text, '') = '';
							
							if (qt_hor_w	= 0) then
								ie_regra_prim_hor_w	:= ie_regra_prim_hor_ant_w;
								ie_regra_horarios_w	:= ie_regra_horarios_ant_w;
								ie_regra_prim_horarios_w := ie_regra_prim_horarios_ant_w;
								ie_elimina_hor_w	:= ie_elimina_hor_ant_w;
								ie_reordenar_w		:= ie_reordenar_ant_w;
							end if;
						end if;
						
						
						if (ie_regra_horarios_w = 'HA') then
							ds_horarios_w	:= null;
							open c04;
							loop
							fetch c04 into	
								dt_horario_w;
							EXIT WHEN NOT FOUND; /* apply on c04 */
								if (PKG_DATE_UTILS.extract_field('MINUTE', dt_horario_w) = 0) then
									if (coalesce(ds_horarios_w::text, '') = '') then
										ds_horarios_w	:= to_char(dt_horario_w,'hh24');
									else
										ds_horarios_w	:= ds_horarios_w ||' ' || to_char(dt_horario_w,'hh24');
									end if;
								else
									if (coalesce(ds_horarios_w::text, '') = '') then
										ds_horarios_w	:= to_char(dt_horario_w,'hh24:mi');
									else
										ds_horarios_w	:= ds_horarios_w ||' ' || to_char(dt_horario_w,'hh24:mi');
									end if;
								end if;
							end loop;
							close c04;
							
							if (coalesce(ie_reordenar_w,'S') = 'S') then
								ds_horarios_w	:= reordenar_horarios(dt_inicio_prescr_tes_w, trim(both ds_horarios_w));
								ds_horarios_w := Reordenar_Horarios_Prescr(dt_inicio_prescr_tes_w, ds_horarios_w);
							end if;
						
							update	prescr_material
							set 	ds_horarios		= ds_horarios_w
							where	nr_prescricao 		= nr_prescricao_p
							and	nr_sequencia		= nr_sequencia_dil_w
							and	(hr_prim_horario IS NOT NULL AND hr_prim_horario::text <> '');
						elsif (ie_regra_horarios_w = 'HS') then

							select	CASE WHEN count(*)=0 THEN 'N'  ELSE 'S' END
							into STRICT	ie_composto_w
							from	prescr_material
							where	nr_prescricao	= nr_prescr_lista_w
							and	cd_material	<> cd_material_w
							and	nr_agrupamento	= nr_agrup_aux_w;
							
							select	max(ds_horario)
							into STRICT	ds_horarios_aux_w
							from	rep_horario_hor_pac
							where	nr_atendimento	= nr_atendimento_w
							and	cd_material	= cd_material_w
							and	cd_intervalo	= cd_intervalo_w
							and	coalesce(ie_composto,ie_composto_w)	= ie_composto_w
							and	coalesce(dt_cancelamento::text, '') = '';
							
							if (ie_acm_w = 'S') then
								ds_horarios_w	:= wheb_mensagem_pck.get_texto(309807);
							end if;
							if (ie_se_necessario_w = 'S') then
								ds_horarios_w	:= wheb_mensagem_pck.get_texto(309808);
							end if;						
							
							if (ds_horarios_aux_w IS NOT NULL AND ds_horarios_aux_w::text <> '') then
								ds_horarios_w	:= ds_horarios_aux_w;
								update	prescr_material
								set 	ds_horarios		= ds_horarios_w
								where	nr_prescricao 		= nr_prescricao_p
								and	nr_sequencia		= nr_sequencia_dil_w
								and	(hr_prim_horario IS NOT NULL AND hr_prim_horario::text <> '');
							end if;
							
						elsif (ie_regra_horarios_w = 'HO') then
							update	prescr_material
							set 	ds_horarios		= coalesce(ds_horarios_medico_w,ds_horarios_w)
							where	nr_prescricao 		= nr_prescricao_p
							and	nr_sequencia		= nr_sequencia_dil_w
							and	(hr_prim_horario IS NOT NULL AND hr_prim_horario::text <> '');
						end if;
						
						select	max(dt_primeiro_horario),
							max(nr_horas_validade)
						into STRICT	dt_primeiro_horario_mae_w,
							nr_horas_validade_mae_w
						from	prescr_medica
						where	nr_prescricao = nr_prescr_lista_w  LIMIT 1;
						
						ds_horarios_prim_w	:= ds_horarios_w;
						
						if	((to_char(dt_primeiro_horario_w,'hh24:mi') <> to_char(dt_primeiro_horario_mae_w,'hh24:mi')) or (coalesce(nr_horas_validade_w,0) <> coalesce(nr_horas_validade_mae_w,0))) and (coalesce(ie_elimina_hor_w,'S') = 'S') then
							
							if (ie_reordenar_w = 'S') then
								ds_horarios_w := reordenar_horarios_prescr(dt_inicio_prescr_tes_w, ds_horarios_w);
							end if;
							
							ie_minutos_w	:= 'S';
							if (position(':' in ds_horarios_w) = 0) then
								ie_minutos_w	:= 'N';
							end if;
							
							select	Eliminar_horarios_vigencia(ds_horarios_w, cd_intervalo_w, dt_inicio_prescr_tes_w, dt_inicio_prescr_tes_w, qt_hora_intervalo_w, qt_min_intervalo_w, nr_prescricao_p)
							into STRICT	ds_horarios_w
							;
							
							if (ie_minutos_w	= 'N') then
								ds_horarios_padr_w	:= ds_horarios_w;
								ds_horarios_w		:= '';
								while(ds_horarios_padr_w IS NOT NULL AND ds_horarios_padr_w::text <> '') loop
									select	position(':' in ds_horarios_padr_w)
									into STRICT	k
									;
						
									if (k > 1) and ((substr(ds_horarios_padr_w, 1, k -1) IS NOT NULL AND (substr(ds_horarios_padr_w, 1, k -1))::text <> '')) then
										ds_horarios_w		:= ds_horarios_w || substr(ds_horarios_padr_w, 1, k-1);
										ds_horarios_padr_w	:= substr(ds_horarios_padr_w, k + 3, 2000);
									elsif (ds_horarios_padr_w IS NOT NULL AND ds_horarios_padr_w::text <> '') then
										ds_horarios_w		:= ds_horarios_padr_w;
										ds_horarios_padr_w	:= '';
									end if;
								end loop;
							end if;
							
							update	prescr_material
							set 	ds_horarios		= ds_horarios_w
							where	nr_prescricao 		= nr_prescricao_p
							and	nr_sequencia		= nr_sequencia_dil_w
							and	(hr_prim_horario IS NOT NULL AND hr_prim_horario::text <> '');
						end if;

						if (ie_regra_prim_horarios_w = 'B') then
							update	prescr_material
							set 	hr_prim_horario		 = NULL
							where	nr_prescricao 		= nr_prescricao_p
							and	nr_sequencia		= nr_sequencia_dil_w
							and	(hr_prim_horario IS NOT NULL AND hr_prim_horario::text <> '');
						elsif (ie_regra_prim_horarios_w = 'P') and (upper(ds_horarios_prim_w) <> wheb_mensagem_pck.get_texto(309807)) and (upper(ds_horarios_prim_w) <> wheb_mensagem_pck.get_texto(309808)) then

							if (position(' ' in ds_horarios_prim_w) = 0) then			
								ds_horarios_prim_w	:= ds_horarios_prim_w || ' ';
							end if;

							hr_prim_horario_w	:= substr(ds_horarios_prim_w,1,position(' ' in ds_horarios_prim_w) - 1);
							if (position(':' in hr_prim_horario_w) = 0) then
								hr_prim_horario_w	:= hr_prim_horario_w || ':00';
							end if;
							
							qt_dia_prim_hor_w	:= 0;
							if (hr_prim_horario_w <> '') and (hr_prim_horario_w <> '  :  ') and (hr_prim_horario_w < to_char(dt_inicio_prescr_tes_w,'hh24:mi')) then
								qt_dia_prim_hor_w	:= 1;
							end if;

							if (ie_acm_w = 'S') and (ie_limpar_prim_hor_acm_w = 'S') then
								hr_prim_horario_w := '';
							end if;
							
							update	prescr_material
							set 	hr_prim_horario		= hr_prim_horario_w,
									qt_dia_prim_hor		= qt_dia_prim_hor_w
							where	nr_prescricao 		= nr_prescricao_p
							and		nr_sequencia		= nr_sequencia_dil_w;
						end if;
						
					end if;
					
				    if (coalesce(ds_horarios_w::text, '') = '') then
						select	substr(ds_horarios,1,255)
						into STRICT	ds_horarios_w
						from	prescr_material
						where	nr_prescricao  = nr_prescricao_p
						and		nr_sequencia   = nr_sequencia_w;
					end if;
					
					if (qt_se_necessario_w <> nr_ocorrencia_w) then
						Select	max(obter_ocorrencias_horarios_rep(ds_horarios_w))
						into STRICT	nr_ocorrencia_w
						;
					end if;
					
					SELECT * FROM Obter_Quant_Dispensar(cd_estabelecimento_p, cd_material_w, nr_prescricao_p, nr_sequencia_dil_w, cd_intervalo_w, ie_via_aplicacao_w, qt_unitaria_w, 0, nr_ocorrencia_w, ds_dose_diferenciada_w, ie_origem_inf_w, cd_unidade_medida_dose_w, 1, qt_material_w, qt_total_dispensar_w, ie_regra_disp_w, ds_erro_w, ie_se_necessario_w, ie_acm_w) INTO STRICT qt_material_w, qt_total_dispensar_w, ie_regra_disp_w, ds_erro_w;
								
					update	prescr_material
					set 	NR_OCORRENCIA		= nr_ocorrencia_w,
							qt_total_dispensar	= qt_total_dispensar_w,
							qt_material		= qt_material_w,
							ie_regra_disp		= CASE WHEN coalesce(ie_regra_disp,'X')='D' THEN  ie_regra_disp  ELSE ie_regra_disp_w END
						where	nr_prescricao 		= nr_prescricao_p
					and	nr_sequencia		= nr_sequencia_dil_w
					and	(hr_prim_horario IS NOT NULL AND hr_prim_horario::text <> '');				
				
				end if;

			end loop;
			close C05;
			
			select	CASE WHEN count(a.nr_sequencia)=0 THEN 'N'  ELSE 'S' END
			into STRICT	ie_ajusta_w
			from	prescr_material a,
				prescr_material b
			where	a.nr_prescricao = b.nr_prescricao
			and	a.nr_prescricao	= nr_prescricao_p
			and	b.nr_prescricao	= nr_prescricao_p
			and	a.nr_sequencia	= nr_sequencia_w
			and	b.nr_sequencia_diluicao = a.nr_sequencia
			and	a.ds_horarios	<> b.ds_horarios  LIMIT 1;
			
			if (ie_ajusta_w	= 'S') then
				CALL Ajustar_Prescr_Material(nr_prescricao_p,nr_sequencia_w);
			end if;
			
			select	coalesce(max('S'),'N')
			into STRICT	ie_consiste_w
			from	prescr_material
			where	nr_prescricao	= nr_prescricao_p
			and		nr_sequencia	= nr_sequencia_w  LIMIT 1;
			
			if (ie_consiste_w	= 'S') then
				select	count(*)
				into STRICT	cont_w
				from	prescr_material
				where 	nr_prescricao		= nr_prescricao_p
				and	nr_sequencia_diluicao	= nr_sequencia_w
				and	ie_agrupador in (3,7,9);
				
				if (ie_gerar_diluicao_w = 'S') and (cont_w = 0) then
						CALL gerar_reconst_diluicao(nr_prescricao_p, nr_sequencia_w, 'A');
					begin
						CALL ajustar_prescr_material(nr_prescricao_p, nr_sequencia_w);
					exception when others then
						CALL gerar_log_prescr_mat(nr_prescricao_p, nr_sequencia_w, null, null, 'M', substr(sqlerrm, 1, 4000), nm_usuario_p, 'N');
					end;
				end if;
				
				ds_erro_w := consistir_prescr_material(nr_prescricao_p, nr_sequencia_w, nm_usuario_p, cd_perfil_w, ds_erro_w);
			end if;

			begin
				qt_horas_estabilidade_w	:= obter_estabilidade_mat_prescr(nr_prescricao_p, nr_sequencia_w);
			exception when others then
				qt_horas_estabilidade_w := null;
			end;
			
			if (qt_horas_estabilidade_w IS NOT NULL AND qt_horas_estabilidade_w::text <> '') then
				update	prescr_material
				set		qt_horas_estabilidade	= qt_horas_estabilidade_w
				where	nr_prescricao			= nr_prescricao_p
				and		nr_sequencia			= nr_sequencia_w;
			end if;

		end if;
		
		if (coalesce(wheb_usuario_pck.get_ie_commit, 'S') = 'S') then commit; end if;
	end if;
	
	if (ie_rastre_prescr_cm_w = 'S') then
		ds_rastre_prescr_cm_w := substr('Rastreabilidade copia de medicamentos' || pls_util_pck.enter_w
			|| $$plsql_unit || ':' || $$plsql_line  || pls_util_pck.enter_w
			|| 'nr_prescricao_p:' || nr_prescricao_p || pls_util_pck.enter_w
			|| 'nr_seq_regra_p:' || nr_seq_regra_p || pls_util_pck.enter_w
			|| 'dt_prescricao_p:' || to_char(dt_prescricao_p, 'dd/mm/yyyy hh24:mi:ss') || pls_util_pck.enter_w
			|| 'dt_primeiro_horario_p:' || dt_primeiro_horario_p || pls_util_pck.enter_w
			|| 'cd_perfil_p:' || cd_perfil_p || pls_util_pck.enter_w
			|| 'ie_ajustar_qt_p:' || ie_ajustar_qt_p || pls_util_pck.enter_w
			|| 'ds_lista_p:' || ds_lista_p || pls_util_pck.enter_w
			|| 'ie_modificar_p:' || ie_modificar_p || pls_util_pck.enter_w
			|| 'ie_reinicia_cont_dias_p:' || ie_reinicia_cont_dias_p || pls_util_pck.enter_w
			|| 'nm_usuario_p:' || nm_usuario_p || pls_util_pck.enter_w
			|| 'cd_estabelecimento_p:' || cd_estabelecimento_p || pls_util_pck.enter_w
			|| 'ie_estende_inc_p:' || ie_estende_inc_p || pls_util_pck.enter_w
			|| 'ie_copia_agora_p:' || ie_copia_agora_p || pls_util_pck.enter_w
			|| 'nr_agrupamento_p:' || nr_agrupamento_p
			|| ds_rastre_prescr_cm_w, 1, 2000);

		CALL gerar_log_prescricao(
			nr_prescricao_p		=> nr_prescricao_p,
			nr_seq_item_p		=> nr_sequencia_w,
			ie_agrupador_p		=> null,
			nr_seq_horario_p	=> null,
			ie_tipo_item_p		=> 'M',
			ds_log_p			=> ds_rastre_prescr_cm_w,
			nm_usuario_p		=> wheb_usuario_pck.get_nm_usuario,
			nr_seq_objeto_p		=> 17764,
			ie_commit_p			=> 'N'
		);
	end if;
	
	nr_prescr_ant_w			:= nr_prescr_lista_w;
	ds_lista_w			:= substr(ds_lista_w,(ie_pos_virgula_w + 1),tam_lista_w);	
	end;
end loop;

/* Sincroniza os kits */

if (trim(both nr_prescricoes_lista_w) <> '') then
  for r_c012_w in c12
  loop
    select coalesce(max(a.nr_sequencia), 0)
    into STRICT   nr_seq_kit_w   
    from   prescr_material a
    where  a.nr_prescricao = nr_prescricao_p
    and    a.nr_prescricao_anterior = r_c012_w.nr_prescricao_anterior
    and    a.nr_sequencia_anterior = r_c012_w.nr_seq_kit
    and    a.nr_sequencia <> a.nr_sequencia_anterior
    and    a.ie_origem_inf <> 'K'
    and    a.ie_agrupador in (1,2);

    if (nr_seq_kit_w > 0) then
      update prescr_material
      set    nr_seq_kit = nr_seq_kit_w
      where  nr_prescricao = nr_prescricao_p
      and    nr_sequencia = r_c012_w.nr_sequencia;
    end if;
  end loop;
end if;

select	max(dt_inicio_prescr),
		max(dt_validade_prescr)
into STRICT	dt_inicio_prescr_w,
		dt_validade_prescr_w
from	prescr_medica
where	nr_prescricao = nr_prescricao_p  LIMIT 1;

open C09;
loop
fetch C09 into
	nr_sequencia_w,
	qt_hora_intervalo_w,
	dt_proxima_dose_w,
	nr_seq_anterior_w,
	nr_prescricao_original_w,
	cd_material_w,
	cd_intervalo_w,
	hr_prim_horario_w;
EXIT WHEN NOT FOUND; /* apply on C09 */
	begin
	if (qt_hora_intervalo_w > 24) then
		if (dt_proxima_dose_w IS NOT NULL AND dt_proxima_dose_w::text <> '') and (dt_proxima_dose_w not between dt_inicio_prescr_w and dt_validade_prescr_w) and (ie_modificar_p = 'N') then
			begin
			qt_dia_prim_hor_w := PKG_DATE_UTILS.extract_field('DAY', dt_inicio_prescr_w) - PKG_DATE_UTILS.extract_field('DAY', dt_proxima_dose_w);
			if (qt_dia_prim_hor_w	< 0) then
				qt_dia_prim_hor_w	:= 0;
			end if;
			
			update	prescr_material
			set		ie_administrar	= 'N',
					hr_prim_horario	= to_char(dt_proxima_dose_w,'hh24:mi'),
					ds_horarios	= to_char(dt_proxima_dose_w,'hh24:mi'),
					qt_dia_prim_hor = qt_dia_prim_hor_w
			where	nr_sequencia	= nr_sequencia_w
			and		nr_prescricao	= nr_prescricao_p;
			end;
		end if;

		dt_proxima_dose_orig_w	:= dt_proxima_dose_w;
		dt_horario_w			:= null;
			
		if (nr_seq_anterior_w IS NOT NULL AND nr_seq_anterior_w::text <> '') then
			
			select	max(dt_proxima_dose),
					coalesce(max(hr_prim_horario), hr_prim_horario_w)
			into STRICT	dt_proxima_dose_w,
					hr_prim_horario_w
			from	prescr_material
			where	/*nvl(hr_prim_horario, hr_prim_horario_w) = hr_prim_horario_w
			and		*/
cd_intervalo = cd_intervalo_w
			and		cd_material = cd_material_w
			and		nr_sequencia = nr_seq_anterior_w
			and		nr_prescricao = nr_prescricao_original_w
			and		coalesce(ie_modificado,'N') = 'N';
			
			hr_prim_horario_w	:= coalesce(hr_prim_horario_w, to_char(dt_inicio_prescr_w, 'hh24:mi'));
			
			if (coalesce(dt_proxima_dose_w::text, '') = '') then
				dt_proxima_dose_w	:= dt_proxima_dose_orig_w;
				
				select	max(dt_horario)
				into STRICT	dt_horario_w
				from	prescr_mat_hor
				where	nr_seq_material	= nr_sequencia_w
				and	nr_prescricao	= nr_prescricao_p;
			else
				
				update	prescr_material
				set	dt_proxima_dose	= dt_proxima_dose_w,
					dt_administrar 	= dt_proxima_dose_w
				where	nr_sequencia	= nr_sequencia_w
				and	nr_prescricao	= nr_prescricao_p;
			end if;
		else
		
			select	max(dt_horario)
			into STRICT	dt_horario_w
			from	prescr_mat_hor
			where	nr_seq_material	= nr_sequencia_w
			and	nr_prescricao	= nr_prescricao_p;
		
			dt_proxima_dose_w	:= dt_horario_w;
		end if;
		
		if	((coalesce(dt_proxima_dose_w::text, '') = '') or (dt_proxima_dose_w between dt_inicio_prescr_w and dt_validade_prescr_w)) then
			begin
			
			if (dt_proxima_dose_w IS NOT NULL AND dt_proxima_dose_w::text <> '') then
				if (dt_inicio_prescr_w > dt_proxima_dose_w) then
					qt_dia_prim_hor_w := PKG_DATE_UTILS.start_of(dt_inicio_prescr_w, 'dd', 0) - PKG_DATE_UTILS.start_of(dt_proxima_dose_w, 'dd', 0);
				else
					qt_dia_prim_hor_w := PKG_DATE_UTILS.start_of(dt_proxima_dose_w, 'dd', 0) - PKG_DATE_UTILS.start_of(dt_inicio_prescr_w, 'dd', 0);
				end if;
			else
				if (hr_prim_horario_w < to_char(dt_inicio_prescr_w,'hh24:mi')) then
					qt_dia_prim_hor_w	:= 1;

				else
					qt_dia_prim_hor_w	:= 0;
				end if;
			end if;
			
			if (qt_dia_prim_hor_w not between 0 and 1) then
				qt_dia_prim_hor_w	:= 0;
			end if;
			if (mod(qt_hora_intervalo_w,24) > 0) and (dt_proxima_dose_w IS NOT NULL AND dt_proxima_dose_w::text <> '') then
				update	prescr_material
				set		hr_prim_horario	= to_char(dt_proxima_dose_w,'hh24:mi'),
						ds_horarios		= to_char(dt_proxima_dose_w,'hh24:mi '),
						dt_administrar 	= dt_proxima_dose_w
				where	nr_sequencia	= nr_sequencia_w
				and		nr_prescricao	= nr_prescricao_p;
			end if;	
			
			dt_proxima_dose_w	:= coalesce(dt_horario_w, dt_proxima_dose_w) + qt_hora_intervalo_w/24;
			
			if (mod(qt_hora_intervalo_w,24) > 0) then
				
				update	prescr_material
				set		dt_proxima_dose	= dt_proxima_dose_w,
						ie_administrar	 = NULL,
						qt_dia_prim_hor	= qt_dia_prim_hor_w
				where	nr_sequencia	= nr_sequencia_w
				and		nr_prescricao	= nr_prescricao_p;
			else
			   	
				update	prescr_material
				set		hr_prim_horario	= to_char(dt_proxima_dose_w,'hh24:mi'),
						ds_horarios	= to_char(dt_proxima_dose_w,'hh24:mi '),
						dt_proxima_dose	= dt_proxima_dose_w,
						--dt_administrar 	= dt_proxima_dose_w,
						ie_administrar	 = NULL,
						qt_dia_prim_hor	= qt_dia_prim_hor_w
				where	nr_sequencia	= nr_sequencia_w
				and		nr_prescricao	= nr_prescricao_p;
			end if;
				
			end;
		elsif (ie_altera_dt_proxima_dose_w = 'S') and (dt_proxima_dose_w IS NOT NULL AND dt_proxima_dose_w::text <> '') and (dt_proxima_dose_w < dt_inicio_prescr_w) then
			begin
			
			if	((dt_horario_w IS NOT NULL AND dt_horario_w::text <> '') and (dt_horario_w	>= dt_inicio_prescr_w) and (dt_horario_w	< dt_validade_prescr_w)) then
				dt_proxima_dose_w	:= dt_horario_w + qt_hora_intervalo_w/24;
			else
				dt_proxima_dose_w	:= dt_inicio_prescr_w + qt_hora_intervalo_w/24;
			end if;	
			
			qt_dia_prim_hor_w := PKG_DATE_UTILS.extract_field('DAY', dt_inicio_prescr_w) - PKG_DATE_UTILS.extract_field('DAY', dt_proxima_dose_w);
			if (qt_dia_prim_hor_w	< 0) then
				qt_dia_prim_hor_w	:= 0;
			end if;
		
			update	prescr_material
			set		hr_prim_horario = to_char(dt_proxima_dose_w, 'hh24:mi'),
					dt_proxima_dose	= dt_proxima_dose_w,
					dt_administrar 	= dt_proxima_dose_w,
					ds_horarios		= to_char(dt_proxima_dose_w, 'hh24:mi'),
					qt_dia_prim_hor = qt_dia_prim_hor_w,
					ie_administrar	 = NULL
			where	nr_sequencia	= nr_sequencia_w
			and		nr_prescricao	= nr_prescricao_p;
			
			end;		
		elsif (dt_proxima_dose_w IS NOT NULL AND dt_proxima_dose_w::text <> '') and (ie_modificar_p = 'N') then
			begin
			
			qt_dia_prim_hor_w := PKG_DATE_UTILS.extract_field('DAY', dt_inicio_prescr_w) - PKG_DATE_UTILS.extract_field('DAY', dt_proxima_dose_w);
			if (qt_dia_prim_hor_w	< 0) then
				qt_dia_prim_hor_w	:= 0;
			end if;
			
			update	prescr_material
			set		ie_administrar	= 'N',
					ie_regra_disp	= 'N',
					qt_dia_prim_hor	= qt_dia_prim_hor_w
			where	nr_sequencia	= nr_sequencia_w
			and		nr_prescricao	= nr_prescricao_p;

			update	prescr_material
			set		ie_administrar		= 'N',
					ie_regra_disp		= 'N'
			where	nr_sequencia_diluicao	= nr_sequencia_w
			and		nr_prescricao		= nr_prescricao_p;

			update	prescr_mat_hor
			set		ie_situacao	= 'I'
			where	nr_seq_material	= nr_sequencia_w
			and		nr_prescricao	= nr_prescricao_p;
			
			update	prescr_mat_hor
			set		ie_situacao	= 'I'
			where	nr_seq_superior	= nr_sequencia_w
			and		nr_prescricao	= nr_prescricao_p;
			
			end;
		end if;
	elsif (ie_altera_dt_proxima_dose_w = 'S') then
			dt_proxima_dose_orig_w	:= dt_proxima_dose_w;
			dt_horario_w			:= null;
				
			if (nr_seq_anterior_w IS NOT NULL AND nr_seq_anterior_w::text <> '') then
				
				hr_prim_horario_w	:= coalesce(hr_prim_horario_w, to_char(dt_inicio_prescr_w, 'hh24:mi'));
				
				select	max(dt_proxima_dose)
				into STRICT	dt_proxima_dose_w
				from	prescr_material
				where	coalesce(hr_prim_horario, hr_prim_horario_w) = hr_prim_horario_w
				and		cd_intervalo = cd_intervalo_w
				and		cd_material = cd_material_w
				and		nr_sequencia = nr_seq_anterior_w
				and		nr_prescricao = nr_prescricao_original_w
				and		coalesce(ie_modificado,'N') = 'N';
				
				if (coalesce(dt_proxima_dose_w::text, '') = '') then
					dt_proxima_dose_w	:= dt_proxima_dose_orig_w;
					
					select	max(dt_horario)
					into STRICT	dt_horario_w
					from	prescr_mat_hor
					where	nr_seq_material	= nr_sequencia_w
					and		nr_prescricao	= nr_prescricao_p;
				else
					
					update	prescr_material
					set		dt_proxima_dose	= dt_proxima_dose_w,
							dt_administrar 	= dt_proxima_dose_w
					where	nr_sequencia	= nr_sequencia_w
					and		nr_prescricao	= nr_prescricao_p;
				end if;
			else
			
				select	max(dt_horario)
				into STRICT	dt_horario_w
				from	prescr_mat_hor
				where	nr_seq_material	= nr_sequencia_w
				and		nr_prescricao	= nr_prescricao_p;
			
				dt_proxima_dose_w	:= dt_horario_w;
			end if;
	
			if (dt_proxima_dose_w IS NOT NULL AND dt_proxima_dose_w::text <> '') and (dt_proxima_dose_w < dt_inicio_prescr_w) then
				begin
				
				if	((dt_horario_w IS NOT NULL AND dt_horario_w::text <> '') and (dt_horario_w	>= dt_inicio_prescr_w) and (dt_horario_w	< dt_validade_prescr_w)) then
					dt_proxima_dose_w	:= dt_horario_w + qt_hora_intervalo_w/24;
				else
					dt_proxima_dose_w	:= dt_inicio_prescr_w + qt_hora_intervalo_w/24;
				end if;	
					
				hr_prim_horario_w	:= to_char(dt_proxima_dose_w, 'hh24:mi');
				
				select	max(ie_via_aplicacao),
						max(qt_unitaria),
						max(nr_ocorrencia),
						max(ie_origem_inf),
						max(cd_unidade_medida_dose),
						max(qt_material),
						max(qt_total_dispensar),
						coalesce(max(ie_se_necessario), 'N'),
						coalesce(max(ie_acm), 'N')
				into STRICT	ie_via_aplicacao_w,
						qt_unitaria_w,
						nr_ocorrencia_w,
						ie_origem_inf_w,
						cd_unidade_medida_dose_w,
						qt_material_w,
						qt_total_dispensar_w,
						ie_se_necessario_w,
						ie_acm_w
				from	prescr_material
				where	nr_sequencia = nr_sequencia_w
				and		nr_prescricao = nr_prescricao_p;
					
				SELECT * FROM Obter_Quant_Dispensar(cd_estabelecimento_p, cd_material_w, nr_prescricao_p, nr_sequencia_w, cd_intervalo_w, ie_via_aplicacao_w, qt_unitaria_w, 0, nr_ocorrencia_w, '', ie_origem_inf_w, cd_unidade_medida_dose_w, 1, qt_material_w, qt_total_dispensar_w, ie_regra_disp_w, ds_erro_w, ie_se_necessario_w, ie_acm_w) INTO STRICT qt_material_w, qt_total_dispensar_w, ie_regra_disp_w, ds_erro_w;
				
				qt_dia_prim_hor_w	:= 0;
				if (hr_prim_horario_w <> '') and (hr_prim_horario_w <> '  :  ') and (hr_prim_horario_w < to_char(dt_inicio_prescr_w,'hh24:mi')) then
					qt_dia_prim_hor_w	:= 1;
				end if;
				
				update	prescr_material
				set 	hr_prim_horario		= hr_prim_horario_w,
						dt_proxima_dose		= dt_proxima_dose_w,
						dt_administrar		= dt_proxima_dose_w,
						ds_horarios			= to_char(dt_proxima_dose_w, 'hh24:mi'),
						nr_ocorrencia		= nr_ocorrencia_w,
						qt_total_dispensar	= qt_total_dispensar_w,
						qt_material			= coalesce(qt_material_w,1),
						ie_regra_disp		= CASE WHEN coalesce(ie_regra_disp,'X')='D' THEN  ie_regra_disp  ELSE ie_regra_disp_w END ,
						qt_dia_prim_hor		= qt_dia_prim_hor_w
				where	nr_sequencia		= nr_sequencia_w
				and		nr_prescricao 		= nr_prescricao_p;
				
				end;
			end if;
	end if;
	
	select	CASE WHEN count(a.nr_sequencia)=0 THEN 'N'  ELSE 'S' END
	into STRICT	ie_ajusta_w
	from	prescr_material a,
			prescr_material b
	where	a.nr_prescricao = b.nr_prescricao
	and	a.nr_prescricao	= nr_prescricao_p
	and	b.nr_prescricao	= nr_prescricao_p
	and	b.nr_sequencia_diluicao = nr_sequencia_w
	and	coalesce(a.ds_horarios, 'XPTO') <> coalesce(b.ds_horarios, 'XPTO')  LIMIT 1;

	if (ie_ajusta_w = 'S') then
		CALL Ajustar_Prescr_Material(nr_prescricao_p,nr_sequencia_w);
	end if;
	
	end;
end loop;
close C09;

if (ie_prescr_composto_w	= 'S') then
	CALL PLT_Ajustar_agrupamento(nr_prescricao_p);
end if;

if (coalesce(wheb_usuario_pck.get_ie_commit, 'S') = 'S') then commit; end if;


end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE plt_copia_medicamento ( nr_prescricao_p bigint, nr_seq_regra_p bigint, dt_prescricao_p timestamp, dt_primeiro_horario_p text, cd_perfil_p bigint, ie_ajustar_qt_p text, ds_lista_p text, ie_modificar_p text, ie_reinicia_cont_dias_p text, nm_usuario_p text, cd_estabelecimento_p bigint, ie_estende_inc_p text, ie_copia_agora_p text, nr_agrupamento_p bigint) FROM PUBLIC;

