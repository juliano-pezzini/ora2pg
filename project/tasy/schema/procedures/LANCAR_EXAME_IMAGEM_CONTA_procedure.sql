-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE lancar_exame_imagem_conta ( nr_seq_proc_interno_p bigint, nr_seq_agenda_p bigint, nm_usuario_p text) AS $body$
DECLARE


nr_prescricao_w			prescr_procedimento.nr_prescricao%type;
nr_seq_prescricao_w		prescr_procedimento.nr_sequencia%type;
cd_procedimento_w		prescr_procedimento.cd_procedimento%type;
ie_origem_proced_w		prescr_procedimento.ie_origem_proced%type;
qt_procedimento_w		prescr_procedimento.qt_procedimento%type;
cd_setor_atendimento_w	prescr_procedimento.cd_setor_atendimento%type;
cd_medico_exec_w		prescr_procedimento.cd_medico_exec%type;
nr_seq_exame_w			prescr_procedimento.nr_seq_exame%type;
ie_lado_w				prescr_procedimento.ie_lado%type;
dt_prev_execucao_w		prescr_procedimento.dt_prev_execucao%type;
nr_seq_propaci_w		procedimento_paciente.nr_sequencia%type;


BEGIN

if (nr_seq_proc_interno_p IS NOT NULL AND nr_seq_proc_interno_p::text <> '') and (nr_seq_agenda_p IS NOT NULL AND nr_seq_agenda_p::text <> '') then
	begin

	select 	max(nr_prescricao),
			max(nr_sequencia),
			max(cd_procedimento),
			max(ie_origem_proced),
			max(qt_procedimento),
			max(cd_setor_atendimento),
			max(cd_medico_exec),
			coalesce(max(ie_lado),'A'),
			max(dt_prev_execucao)
	into STRICT	nr_prescricao_w,
			nr_seq_prescricao_w,
			cd_procedimento_w,
			ie_origem_proced_w,
			qt_procedimento_w,
			cd_setor_atendimento_w,
			cd_medico_exec_w,
			ie_lado_w,
			dt_prev_execucao_w
	from  	prescr_procedimento p
	where	p.nr_seq_proc_interno = nr_seq_proc_interno_p
	and     p.nr_seq_agenda = nr_seq_agenda_p;

	if (coalesce(nr_prescricao_w,0) > 0) and (coalesce(nr_seq_prescricao_w,0) > 0) then
		begin
		
		select	coalesce(max(nr_sequencia),0)
		into STRICT	nr_seq_propaci_w
		from	procedimento_paciente
		where	nr_prescricao			= nr_prescricao_w
		and		nr_sequencia_prescricao	= nr_seq_prescricao_w
		and     coalesce(nr_seq_proc_princ::text, '') = '';
		
		if (nr_seq_propaci_w = 0) then
			begin
			
				CALL Gerar_Proc_Pac_item_Prescr(nr_prescricao_w,
							nr_seq_prescricao_w, 
							null, 
							null,
							nr_seq_proc_interno_p,
							cd_procedimento_w, 
							ie_origem_proced_w,
							qt_procedimento_w, 
							cd_setor_atendimento_w,
							9,
							dt_prev_execucao_w,
							nm_usuario_p, 
							cd_medico_exec_w, 
							null,
							ie_lado_w, 
							null);
			end;
		end if;
		end;
	end if;
	end;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE lancar_exame_imagem_conta ( nr_seq_proc_interno_p bigint, nr_seq_agenda_p bigint, nm_usuario_p text) FROM PUBLIC;

