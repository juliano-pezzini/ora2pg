-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE consistir_interv_solic_exame ( nr_prescricao_p bigint, nr_sequencia_p bigint, ds_erro_p INOUT text, ie_lib_prescr_p INOUT text, qt_horas_p INOUT bigint, qt_minutos_p INOUT bigint, ie_quantidade_p INOUT text, ds_mensagem_regra_p INOUT text, ds_mensagem_data_p INOUT text, dt_ultima_data_p INOUT timestamp, cd_perfil_p bigint, nm_usuario_p text ) AS $body$
DECLARE



ds_erro_w						varchar(2000) := '';
cd_procedimento_w				bigint;
ie_origem_proced_w				bigint;
dt_prev_execucao_w				timestamp;
dt_ultimo_exec_w				timestamp;
dt_validade_prescr_w			timestamp;
dt_inicio_prescr_w				timestamp;
cd_estabelecimento_w			smallint;
nr_seq_exame_w					bigint;
nr_seq_grupo_w					bigint;
nr_seq_proc_interno_w			bigint;
qt_hora_w						double precision;
qt_hora_ww						double precision;
qt_min_ref_w					double precision;
qt_minutos_w					double precision;
qt_minutos_ww					double precision;
nr_atendimento_w				bigint;
nr_seq_derivado_regra_w			bigint;
qt_prescricao_cons_w			bigint;
ds_procedimentos_w				varchar(2000) := '';
nr_seq_exame_lab_w				bigint;
nr_seq_grupo_lab_w				bigint;	
nr_seq_exame_interno_w			bigint;
cd_setor_atendimento_w			bigint;
ie_mes_corrente_w				varchar(20);
cd_material_exame_w				varchar(20);
ie_recem_nato_w					varchar(20);
ie_considera_setor_w			varchar(1);
cd_area_procedimento_regra_w	bigint;
nr_seq_regra_w					bigint;
cd_especialidade_regra_w		bigint;
cd_grupo_proc_regra_w			bigint;
cd_procedimento_regra_w			bigint;
ie_origem_proced_regra_w		bigint;
ie_tipo_atendimento_w			smallint;
cd_area_procedimento_prescr_w	bigint;
cd_especialidade_prescr_w		bigint;
cd_grupo_proc_prescr_w			bigint;
ie_lib_prescr_w					varchar(1) := 'N';/* Rafael em 20/12/2007 cfe Marcus x PC */
cd_convenio_w					integer;	     /*David em 08/07/2008 OS 99741*/
qt_permitida_w					integer;
qt_executada_periodo_w			bigint := 0;
dt_limite_minimo_w				timestamp;
cd_pessoa_fisica_w				varchar(10);
ie_consiste_lado_w				varchar(10);
ie_lado_w						varchar(10);
nr_seq_derivado_w				bigint := 0;
ie_considera_validade_w			varchar(1);
ie_considerar_pessoa_fisica_w	varchar(1);
nr_seq_forma_org_sus_w			bigint := 0;
nr_seq_grupo_sus_w				bigint := 0;
nr_seq_subgrupo_sus_w			bigint := 0;
ds_mensagem_regra_w				varchar(255);


C01 CURSOR FOR
	SELECT	cd_procedimento,
			ie_origem_proced,
			nr_seq_exame,
			nr_seq_proc_interno,
			dt_prev_execucao,
			cd_material_exame,
			ie_lado,
			cd_material_exame,
			coalesce(nr_seq_derivado,0)
	from	prescr_procedimento
	where	nr_prescricao		= nr_prescricao_p
	and		nr_sequencia		= nr_sequencia_p
	and		coalesce(ie_suspenso,'N')	<> 'S';

C02 CURSOR FOR
	SELECT	coalesce(a.qt_hora,0),
			coalesce(a.qt_minutos,0),
			a.nr_seq_exame_lab,
			a.nr_seq_grupo_lab,
			a.nr_seq_exame_interno,
			a.cd_area_procedimento,
			a.cd_especialidade,
			a.cd_grupo_proc,
			a.cd_procedimento,
			a.ie_origem_proced,
			a.ie_lib_prescr,
			coalesce(a.qt_permitida,1),
			a.ie_consiste_lado,
			a.nr_sequencia,
			coalesce(a.ie_considerar_setor,'N'),
			a.ie_mes_corrente,
			a.nr_seq_derivado,
			coalesce(a.ie_considera_validade,'N'),
			coalesce(a.ds_mensagem_regra,''),
			coalesce(ie_considerar_pessoa_fisica,'N')
	from	regra_interv_sol_exame a
	where	coalesce(a.nr_seq_exame_lab, coalesce(nr_seq_exame_w,0))			= coalesce(nr_seq_exame_w,0)
	and		coalesce(a.cd_material_exame, coalesce(cd_material_exame_w,'0'))		= coalesce(cd_material_exame_w,'0')
	and		coalesce(a.nr_seq_grupo_lab, coalesce(nr_seq_grupo_w,0))			= coalesce(nr_seq_grupo_w,0)
	and		coalesce(a.nr_seq_exame_interno, coalesce(nr_seq_proc_interno_w,0))	= coalesce(nr_seq_proc_interno_w,0)
	and		coalesce(a.cd_area_procedimento, coalesce(cd_area_procedimento_prescr_w,0))	= coalesce(cd_area_procedimento_prescr_w,0)
	and		coalesce(a.cd_especialidade, coalesce(cd_especialidade_prescr_w,0))	= coalesce(cd_especialidade_prescr_w,0)
	and		coalesce(a.cd_grupo_proc, coalesce(cd_grupo_proc_prescr_w,0))		= coalesce(cd_grupo_proc_prescr_w,0)
	and		coalesce(a.cd_procedimento, coalesce(cd_procedimento_w,0))		= coalesce(cd_procedimento_w,0)
	and		coalesce(a.ie_origem_proced, coalesce(ie_origem_proced_w,0))		= coalesce(ie_origem_proced_w,0)
	and		coalesce(a.ie_tipo_atendimento, coalesce(ie_tipo_atendimento_w,0))	= coalesce(ie_tipo_atendimento_w,0)
	and		coalesce(a.nr_seq_forma_org,nr_seq_forma_org_sus_w)			= nr_seq_forma_org_sus_w
	and		coalesce(a.nr_seq_grupo,nr_seq_grupo_sus_w)				= nr_seq_grupo_sus_w
	and		coalesce(a.nr_seq_subgrupo,nr_seq_subgrupo_sus_w)			= nr_seq_subgrupo_sus_w
	and		coalesce(a.nr_seq_derivado, nr_seq_derivado_w)			= nr_seq_derivado_w
	and		a.cd_estabelecimento						= cd_estabelecimento_w
	and		((coalesce(a.cd_convenio::text, '') = '') or (a.cd_convenio = cd_convenio_w))
	and		not exists (	SELECT	*
							from	regra_interv_exame_exc x
							where	coalesce(x.cd_grupo_proc,coalesce(cd_grupo_proc_prescr_w,0)) 		 = coalesce(cd_grupo_proc_prescr_w,0)
							and		coalesce(x.cd_especialidade,coalesce(cd_especialidade_prescr_w,0)) 	 = coalesce(cd_especialidade_prescr_w,0)
							and		coalesce(x.cd_area_procedimento,coalesce(cd_area_procedimento_prescr_w,0)) = coalesce(cd_area_procedimento_prescr_w,0)
							and		coalesce(x.cd_procedimento,coalesce(cd_procedimento_w,0)) 		 = coalesce(cd_procedimento_w,0)				
							and		coalesce(x.cd_pessoa_fisica, coalesce(Obter_Pessoa_Fisica_Usuario(nm_usuario_p, 'C'),0)) 		 = coalesce(Obter_Pessoa_Fisica_Usuario(nm_usuario_p, 'C'),0)
							and		coalesce(x.cd_perfil_excluir, coalesce(cd_perfil_p,0))	=	coalesce(cd_perfil_p, 0)
							and		x.nr_seq_regra 							 = a.nr_sequencia)
	and		((exists (	select	nr_sequencia
						from	regra_interv_sol_setor
						where	nr_seq_regra	= a.nr_sequencia
						and		coalesce(cd_perfil, coalesce(cd_perfil_p,0))	=	coalesce(cd_perfil_p, 0)
						and		coalesce(cd_setor_atendimento,coalesce(cd_setor_atendimento_w,0)) = coalesce(cd_setor_atendimento_w,0)
						and		coalesce(cd_pessoa_fisica, coalesce(Obter_Pessoa_Fisica_Usuario(nm_usuario_p, 'C'),0))	=	coalesce(Obter_Pessoa_Fisica_Usuario(nm_usuario_p, 'C'),0)))	or  not exists (	select	nr_sequencia
							from	regra_interv_sol_setor
							where	nr_seq_regra	= a.nr_sequencia))
	order by
		coalesce(nr_seq_exame_lab,0),
		coalesce(nr_seq_exame_interno,0),
		coalesce(nr_seq_grupo_lab,0),
		coalesce(cd_procedimento,0),
		coalesce(cd_grupo_proc,0),
		coalesce(cd_especialidade,0),
		coalesce(cd_area_procedimento,0),
		coalesce(nr_seq_forma_org,0),
		coalesce(nr_seq_subgrupo,0),
		coalesce(nr_seq_grupo,0);


BEGIN
begin

select	cd_estabelecimento,
		nr_atendimento,
		obter_convenio_atendimento(nr_atendimento),
		CASE WHEN ie_recem_nato='S' THEN coalesce(CD_RECEM_NATO,cd_pessoa_fisica)  ELSE cd_pessoa_fisica END ,
		cd_setor_atendimento,
		coalesce(ie_recem_nato,'N'),
		dt_validade_prescr,
		dt_inicio_prescr
into STRICT	cd_estabelecimento_w,
		nr_atendimento_w,
		cd_convenio_w,
		cd_pessoa_fisica_w,
		cd_setor_atendimento_w,
		ie_recem_nato_w,
		dt_validade_prescr_w,
		dt_inicio_prescr_w
from	prescr_medica
where	nr_prescricao	= nr_prescricao_p;
exception
	when others then
		cd_estabelecimento_w	:= 1;
end;

begin
select	ie_tipo_atendimento
into STRICT	ie_tipo_atendimento_w
from	atendimento_paciente
where	nr_atendimento	= nr_atendimento_w;
exception
	when others then
		ie_tipo_atendimento_w	:= null;
end;

open C01;
loop
fetch C01 into	
	cd_procedimento_w,
	ie_origem_proced_w,
	nr_seq_exame_w,
	nr_seq_proc_interno_w,
	dt_prev_execucao_w,
	cd_material_exame_w,
	ie_lado_w,
	cd_material_exame_w,
	nr_seq_derivado_w;
EXIT WHEN NOT FOUND; /* apply on C01 */	

	if (nr_seq_exame_w IS NOT NULL AND nr_seq_exame_w::text <> '') then
		begin
		select	nr_seq_grupo
		into STRICT	nr_seq_grupo_w
		from	exame_laboratorio
		where	nr_seq_exame	= nr_seq_exame_w;
		exception
			when others then
				nr_seq_grupo_w	:= null;
		end;
	end if;	
	
	select	cd_grupo_proc,
			cd_especialidade,
			cd_area_procedimento
	into STRICT	cd_grupo_proc_prescr_w,
			cd_especialidade_prescr_w,
			cd_area_procedimento_prescr_w
	from	estrutura_procedimento_v
	where	cd_procedimento		= cd_procedimento_w
	and		ie_origem_proced	= ie_origem_proced_w;
	
	/* obter estrutura do procedimento sus unificado*/

	select	coalesce(substr(sus_obter_seq_estrut_proc(sus_obter_estrut_proc(cd_procedimento_w, ie_origem_proced_w, 'C', 'F'),'F'),1,10),0),
			coalesce(substr(sus_obter_seq_estrut_proc(sus_obter_estrut_proc(cd_procedimento_w, ie_origem_proced_w, 'C', 'G'),'G'),1,10),0),
			coalesce(substr(sus_obter_seq_estrut_proc(sus_obter_estrut_proc(cd_procedimento_w, ie_origem_proced_w, 'C', 'S'),'S'),1,10),0)
	into STRICT	nr_seq_forma_org_sus_w,
			nr_seq_grupo_sus_w,
			nr_seq_subgrupo_sus_w
	;
	
	OPEN C02;
	Loop
	Fetch c02 into	
		qt_hora_w,
		qt_minutos_w,
		nr_seq_exame_lab_w,
		nr_seq_grupo_lab_w,
		nr_seq_exame_interno_w,
		cd_area_procedimento_regra_w,
		cd_especialidade_regra_w,
		cd_grupo_proc_regra_w,
		cd_procedimento_regra_w,
		ie_origem_proced_regra_w,
		ie_lib_prescr_w,
		qt_permitida_w,
		ie_consiste_lado_w,
		nr_seq_regra_w,
		ie_considera_setor_w,
		ie_mes_corrente_w,
		nr_seq_derivado_regra_w,
		ie_considera_validade_w,
		ds_mensagem_regra_w,
		ie_considerar_pessoa_fisica_w;
	EXIT WHEN NOT FOUND; /* apply on c02 */
		qt_hora_w	:= qt_hora_w;
		qt_minutos_w	:= qt_minutos_w;
	END Loop;
	CLOSE C02;
	
	qt_horas_p	:= coalesce(qt_hora_w,0);
	qt_minutos_p	:= coalesce(qt_minutos_w,0);
	
	qt_hora_ww	:= coalesce(qt_hora_w,0);
	qt_minutos_ww	:= coalesce(qt_minutos_w,0);
	
	if (qt_minutos_ww = 0) and (qt_hora_ww = 0) then
		qt_minutos_ww	:= 999;
		qt_minutos_p	:= 999;
		qt_minutos_w	:= 999;
	end if;	
	
	if (qt_minutos_w > 0) then
		qt_minutos_w	:= dividir(qt_minutos_w,1440);
	end if;
	
	if (qt_hora_w > 0) then
		qt_hora_w := ((qt_hora_w * 60) /1440);
	end if;
	
	begin
		dt_limite_minimo_w 	:= dt_prev_execucao_w - qt_hora_w - qt_minutos_w;
	exception when others then
		dt_limite_minimo_w := clock_timestamp();
	end;
	
	if (Obter_se_setor_intev_proc(cd_setor_atendimento_w, nr_seq_regra_w) = 'S') then

		if (nr_seq_exame_w IS NOT NULL AND nr_seq_exame_w::text <> '') and (nr_seq_exame_lab_w IS NOT NULL AND nr_seq_exame_lab_w::text <> '') and (nr_seq_exame_w = nr_seq_exame_lab_w) then
			begin

			select	max(b.dt_prev_execucao)
			into STRICT	dt_ultimo_exec_w
			from	prescr_procedimento b,
					prescr_medica a
			where	a.nr_prescricao		= b.nr_prescricao
			and		((a.nr_atendimento	= nr_atendimento_w AND ie_considerar_pessoa_fisica_w = 'N') or
					 (a.cd_pessoa_fisica = cd_pessoa_fisica_w AND ie_considerar_pessoa_fisica_w = 'S'))
			and		CASE WHEN ie_recem_nato='S' THEN coalesce(a.CD_RECEM_NATO,a.cd_pessoa_fisica)  ELSE a.cd_pessoa_fisica END 	= cd_pessoa_fisica_w
			and		b.cd_material_exame	= cd_material_exame_w
			and		coalesce(a.ie_recem_nato,'N') = ie_recem_nato_w
			and		((coalesce(ie_mes_corrente_w,'N') = 'N') or (PKG_DATE_UTILS.start_of(b.dt_prev_execucao,'month',0) = PKG_DATE_UTILS.start_of(clock_timestamp(),'month',0)))
			and		((coalesce(ie_consiste_lado_w,'N')	= 'N') or (b.ie_lado	= ie_lado_w))
			and		coalesce(a.dt_suspensao::text, '') = ''
			and		((coalesce(ie_considera_setor_w,'N') = 'N') or (a.cd_setor_atendimento = cd_setor_atendimento_w))
			and		Obter_se_setor_intev_proc(a.cd_setor_atendimento, nr_seq_regra_w) = 'S'
			and		coalesce(b.ie_suspenso,'N')	<> 'S'
			and		b.nr_seq_exame		= nr_seq_exame_w
			AND		(((a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '') OR (a.dt_liberacao_medico IS NOT NULL AND a.dt_liberacao_medico::text <> '')) OR (b.nr_prescricao = nr_prescricao_p AND b.nr_sequencia <> nr_sequencia_p));	

			exception
				when others then
					dt_ultimo_exec_w	:= null;
			end;

			begin
			select	sum(b.qt_procedimento)
			into STRICT	qt_executada_periodo_w
			from	prescr_procedimento b,
					prescr_medica a
			where	a.nr_prescricao		= b.nr_prescricao
			and		((a.nr_atendimento	= nr_atendimento_w AND ie_considerar_pessoa_fisica_w = 'N') or
					 (a.cd_pessoa_fisica = cd_pessoa_fisica_w AND ie_considerar_pessoa_fisica_w = 'S'))
			and		((a.nr_prescricao	<> nr_prescricao_p) or (b.nr_sequencia	<> nr_sequencia_p))
			and		CASE WHEN ie_recem_nato='S' THEN coalesce(a.CD_RECEM_NATO,a.cd_pessoa_fisica)  ELSE a.cd_pessoa_fisica END 	= cd_pessoa_fisica_w
			and		b.cd_material_exame	= cd_material_exame_w
			and		coalesce(a.dt_suspensao::text, '') = ''
			and		coalesce(b.ie_suspenso,'N')	<> 'S'
			and		coalesce(a.ie_recem_nato,'N') = ie_recem_nato_w
			and		((coalesce(ie_mes_corrente_w,'N') = 'N') or (PKG_DATE_UTILS.start_of(b.dt_prev_execucao,'month',0) = PKG_DATE_UTILS.start_of(clock_timestamp(),'month',0)))
			and		Obter_se_setor_intev_proc(a.cd_setor_atendimento, nr_seq_regra_w) = 'S'
			and		((coalesce(ie_considera_setor_w,'N') = 'N') or (a.cd_setor_atendimento = cd_setor_atendimento_w))
			and		((coalesce(ie_consiste_lado_w,'N')	= 'N') or (b.ie_lado	= ie_lado_w))
			and		((a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '') or (a.dt_liberacao_medico IS NOT NULL AND a.dt_liberacao_medico::text <> '') or (a.nr_prescricao = nr_prescricao_p AND b.nr_sequencia <> nr_sequencia_p))
			and		((ie_considera_validade_w = 'S' AND b.dt_prev_execucao > dt_inicio_prescr_w) or
					 (ie_considera_validade_w = 'N' AND b.dt_prev_execucao between dt_limite_minimo_w and dt_prev_execucao_w))
			and		b.nr_seq_exame		= nr_seq_exame_w;
			exception
				when others then
					qt_executada_periodo_w	:= 0;
			end;	
				
		elsif (nr_seq_proc_interno_w IS NOT NULL AND nr_seq_proc_interno_w::text <> '') and (nr_seq_exame_interno_w IS NOT NULL AND nr_seq_exame_interno_w::text <> '') then
			begin

			select	max(b.dt_prev_execucao)
			into STRICT	dt_ultimo_exec_w
			from	prescr_procedimento b,
					prescr_medica a
			where	a.nr_prescricao		= b.nr_prescricao
			and		CASE WHEN ie_recem_nato='S' THEN coalesce(a.CD_RECEM_NATO,a.cd_pessoa_fisica)  ELSE a.cd_pessoa_fisica END 	= cd_pessoa_fisica_w
			and		((a.nr_atendimento	= nr_atendimento_w AND ie_considerar_pessoa_fisica_w = 'N') or
					 (a.cd_pessoa_fisica = cd_pessoa_fisica_w AND ie_considerar_pessoa_fisica_w = 'S'))
			and		coalesce(b.cd_material_exame,0)	= coalesce(cd_material_exame_w,0)
			and		coalesce(a.ie_recem_nato,'N') = ie_recem_nato_w
			and		((coalesce(ie_mes_corrente_w,'N') = 'N') or (PKG_DATE_UTILS.start_of(b.dt_prev_execucao,'month',0) = PKG_DATE_UTILS.start_of(clock_timestamp(),'month',0)))
			and		Obter_se_setor_intev_proc(a.cd_setor_atendimento, nr_seq_regra_w) = 'S'
			and		((coalesce(ie_considera_setor_w,'N') = 'N') or (a.cd_setor_atendimento = cd_setor_atendimento_w))
			and		((coalesce(ie_consiste_lado_w,'N')	= 'N') or (b.ie_lado	= ie_lado_w))
			and		coalesce(a.dt_suspensao::text, '') = ''
			and		coalesce(b.ie_suspenso,'N')	<> 'S'
			and		b.nr_seq_proc_interno	= nr_seq_proc_interno_w
			AND		(((a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '') OR (a.dt_liberacao_medico IS NOT NULL AND a.dt_liberacao_medico::text <> '')) OR (b.nr_prescricao = nr_prescricao_p AND b.nr_sequencia <> nr_sequencia_p));
			

			exception
				when others then
					dt_ultimo_exec_w	:= null;
			end;

			begin
			select	sum(b.qt_procedimento)
			into STRICT	qt_executada_periodo_w
			from	prescr_procedimento b,
					prescr_medica a
			where	a.nr_prescricao		= b.nr_prescricao
			and		CASE WHEN ie_recem_nato='S' THEN coalesce(a.CD_RECEM_NATO,a.cd_pessoa_fisica)  ELSE a.cd_pessoa_fisica END 	= cd_pessoa_fisica_w
			and		((a.nr_atendimento	= nr_atendimento_w AND ie_considerar_pessoa_fisica_w = 'N') or
					 (a.cd_pessoa_fisica = cd_pessoa_fisica_w AND ie_considerar_pessoa_fisica_w = 'S'))
			and		((a.nr_prescricao	<> nr_prescricao_p) or (b.nr_sequencia	<> nr_sequencia_p))
			and		coalesce(b.cd_material_exame,0)	= coalesce(cd_material_exame_w,0)
			and		coalesce(a.ie_recem_nato,'N') = ie_recem_nato_w
			and		((coalesce(ie_mes_corrente_w,'N') = 'N') or (PKG_DATE_UTILS.start_of(b.dt_prev_execucao,'month',0) = PKG_DATE_UTILS.start_of(clock_timestamp(),'month',0)))
			and		((coalesce(ie_consiste_lado_w,'N')	= 'N') or (b.ie_lado	= ie_lado_w))
			and		coalesce(a.dt_suspensao::text, '') = ''
			and		Obter_se_setor_intev_proc(a.cd_setor_atendimento, nr_seq_regra_w) = 'S'
			and		((coalesce(ie_considera_setor_w,'N') = 'N') or (a.cd_setor_atendimento = cd_setor_atendimento_w))
			and		coalesce(b.ie_suspenso,'N')	<> 'S'
			and		((a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '') or (a.dt_liberacao_medico IS NOT NULL AND a.dt_liberacao_medico::text <> '') or (a.nr_prescricao = nr_prescricao_p AND b.nr_sequencia <> nr_sequencia_p))
			and		((ie_considera_validade_w = 'S' AND b.dt_prev_execucao > dt_inicio_prescr_w) or
					 (ie_considera_validade_w = 'N' AND b.dt_prev_execucao between dt_limite_minimo_w and dt_prev_execucao_w))
			and		b.nr_seq_proc_interno	= nr_seq_proc_interno_w;
			exception
				when others then
					qt_executada_periodo_w	:= 0;
			end;
			
		elsif (nr_seq_exame_w IS NOT NULL AND nr_seq_exame_w::text <> '') and (nr_seq_grupo_lab_w IS NOT NULL AND nr_seq_grupo_lab_w::text <> '') then
			begin

			select	max(b.dt_prev_execucao)
			into STRICT	dt_ultimo_exec_w
			from	exame_laboratorio c,
					prescr_procedimento b,
					prescr_medica a
			where	a.nr_prescricao		= b.nr_prescricao
			and		((a.nr_atendimento	= nr_atendimento_w AND ie_considerar_pessoa_fisica_w = 'N') or
					 (a.cd_pessoa_fisica = cd_pessoa_fisica_w AND ie_considerar_pessoa_fisica_w = 'S'))
			and		CASE WHEN ie_recem_nato='S' THEN coalesce(a.CD_RECEM_NATO,a.cd_pessoa_fisica)  ELSE a.cd_pessoa_fisica END 	= cd_pessoa_fisica_w
			and		coalesce(b.cd_material_exame,'XPTO')	= coalesce(cd_material_exame_w,'XPTO')
			and		((coalesce(ie_mes_corrente_w,'N') = 'N') or (PKG_DATE_UTILS.start_of(b.dt_prev_execucao,'month',0) = PKG_DATE_UTILS.start_of(clock_timestamp(),'month',0)))
			and		coalesce(a.ie_recem_nato,'N') = ie_recem_nato_w
			and		b.nr_seq_exame		= c.nr_seq_exame
			and		c.nr_seq_grupo		= nr_seq_grupo_lab_w
			and		b.nr_seq_exame		= nr_seq_exame_w
			and		Obter_se_setor_intev_proc(a.cd_setor_atendimento, nr_seq_regra_w) = 'S'
			and		((coalesce(ie_considera_setor_w,'N') = 'N') or (a.cd_setor_atendimento = cd_setor_atendimento_w))
			and		((coalesce(ie_consiste_lado_w,'N')	= 'N') or (b.ie_lado	= ie_lado_w))
			and		coalesce(a.dt_suspensao::text, '') = ''
			and		coalesce(b.ie_suspenso,'N')	<> 'S'
			AND		(((a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '') OR (a.dt_liberacao_medico IS NOT NULL AND a.dt_liberacao_medico::text <> '')) OR (b.nr_prescricao = nr_prescricao_p AND b.nr_sequencia <> nr_sequencia_p));
			exception
				when others then
					dt_ultimo_exec_w	:= null;
			end;

			begin
			select	sum(b.qt_procedimento)
			into STRICT	qt_executada_periodo_w
			from	exame_laboratorio c,
					prescr_procedimento b,
					prescr_medica a
			where	a.nr_prescricao		= b.nr_prescricao
			and		CASE WHEN ie_recem_nato='S' THEN coalesce(a.CD_RECEM_NATO,a.cd_pessoa_fisica)  ELSE a.cd_pessoa_fisica END 	= cd_pessoa_fisica_w
			and		((a.nr_atendimento	= nr_atendimento_w AND ie_considerar_pessoa_fisica_w = 'N') or
					 (a.cd_pessoa_fisica = cd_pessoa_fisica_w AND ie_considerar_pessoa_fisica_w = 'S'))
			and		((a.nr_prescricao	<> nr_prescricao_p) or (b.nr_sequencia	<> nr_sequencia_p))
			and		coalesce(b.cd_material_exame,'XPTO')	= coalesce(cd_material_exame_w,'XPTO')
			and		b.nr_seq_exame		= c.nr_seq_exame
			and		((coalesce(ie_mes_corrente_w,'N') = 'N') or (PKG_DATE_UTILS.start_of(b.dt_prev_execucao,'month',0) = PKG_DATE_UTILS.start_of(clock_timestamp(),'month',0)))
			and		c.nr_seq_grupo		= nr_seq_grupo_lab_w
			and		b.nr_seq_exame		= nr_seq_exame_w
			and		coalesce(a.ie_recem_nato,'N') = ie_recem_nato_w
			and		Obter_se_setor_intev_proc(a.cd_setor_atendimento, nr_seq_regra_w) = 'S'
			and		((coalesce(ie_considera_setor_w,'N') = 'N') or (a.cd_setor_atendimento = cd_setor_atendimento_w))
			and		((coalesce(ie_consiste_lado_w,'N')	= 'N') or (b.ie_lado	= ie_lado_w))
			and		coalesce(a.dt_suspensao::text, '') = ''
			and		coalesce(b.ie_suspenso,'N')	<> 'S'
			and		((ie_considera_validade_w = 'S' AND b.dt_prev_execucao > dt_inicio_prescr_w) or
					 (ie_considera_validade_w = 'N' AND b.dt_prev_execucao between dt_limite_minimo_w and dt_prev_execucao_w))
			and		((a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '') or (a.dt_liberacao_medico IS NOT NULL AND a.dt_liberacao_medico::text <> '') or (a.nr_prescricao = nr_prescricao_p AND b.nr_sequencia <> nr_sequencia_p));
			exception
				when others then
					qt_executada_periodo_w	:= 0;
			end;
			
		elsif (cd_procedimento_regra_w IS NOT NULL AND cd_procedimento_regra_w::text <> '') and (cd_procedimento_w = cd_procedimento_regra_w) and (ie_origem_proced_w = ie_origem_proced_regra_w) then
			begin

			select	max(b.dt_prev_execucao)
			into STRICT	dt_ultimo_exec_w
			from	prescr_procedimento b,
					prescr_medica a
			where	a.nr_prescricao		= b.nr_prescricao
			and		CASE WHEN ie_recem_nato='S' THEN coalesce(a.CD_RECEM_NATO,a.cd_pessoa_fisica)  ELSE a.cd_pessoa_fisica END 	= cd_pessoa_fisica_w
			and		((a.nr_atendimento	= nr_atendimento_w AND ie_considerar_pessoa_fisica_w = 'N') or
					 (a.cd_pessoa_fisica = cd_pessoa_fisica_w AND ie_considerar_pessoa_fisica_w = 'S'))
			and		b.cd_procedimento	= cd_procedimento_w
			and		((coalesce(ie_mes_corrente_w,'N') = 'N') or (PKG_DATE_UTILS.start_of(b.dt_prev_execucao,'month',0) = PKG_DATE_UTILS.start_of(clock_timestamp(),'month',0)))
			and		b.ie_origem_proced	= ie_origem_proced_w
			and		coalesce(a.ie_recem_nato,'N') = ie_recem_nato_w
			and		Obter_se_setor_intev_proc(a.cd_setor_atendimento, nr_seq_regra_w) = 'S'
			and		((coalesce(ie_considera_setor_w,'N') = 'N') or (a.cd_setor_atendimento = cd_setor_atendimento_w))
			and		((coalesce(ie_consiste_lado_w,'N')	= 'N') or (b.ie_lado	= ie_lado_w))
			and		coalesce(a.dt_suspensao::text, '') = ''
			and		coalesce(b.ie_suspenso,'N')	<> 'S'
			AND		(((a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '') OR (a.dt_liberacao_medico IS NOT NULL AND a.dt_liberacao_medico::text <> '')) OR (b.nr_prescricao = nr_prescricao_p AND b.nr_sequencia <> nr_sequencia_p));
			exception
				when others then
					dt_ultimo_exec_w	:= null;
			end;

			begin
			select	sum(b.qt_procedimento)
			into STRICT	qt_executada_periodo_w
			from	prescr_procedimento b,
					prescr_medica a
			where	a.nr_prescricao		= b.nr_prescricao
			and		CASE WHEN ie_recem_nato='S' THEN coalesce(a.CD_RECEM_NATO,a.cd_pessoa_fisica)  ELSE a.cd_pessoa_fisica END 	= cd_pessoa_fisica_w
			and		((a.nr_atendimento	= nr_atendimento_w AND ie_considerar_pessoa_fisica_w = 'N') or
					 (a.cd_pessoa_fisica = cd_pessoa_fisica_w AND ie_considerar_pessoa_fisica_w = 'S'))
			and		((a.nr_prescricao	<> nr_prescricao_p) or (b.nr_sequencia	<> nr_sequencia_p))
			and		b.cd_procedimento	= cd_procedimento_w
			and		b.ie_origem_proced	= ie_origem_proced_w
			and		Obter_se_setor_intev_proc(a.cd_setor_atendimento, nr_seq_regra_w) = 'S'
			and		((coalesce(ie_mes_corrente_w,'N') = 'N') or (PKG_DATE_UTILS.start_of(b.dt_prev_execucao,'month',0) = PKG_DATE_UTILS.start_of(clock_timestamp(),'month',0)))
			and		((coalesce(ie_considera_setor_w,'N') = 'N') or (a.cd_setor_atendimento = cd_setor_atendimento_w))
			and		((coalesce(ie_consiste_lado_w,'N')	= 'N') or (b.ie_lado	= ie_lado_w))
			and		coalesce(a.dt_suspensao::text, '') = ''
			and		coalesce(a.ie_recem_nato,'N') = ie_recem_nato_w
			and		coalesce(b.ie_suspenso,'N')	<> 'S'
			and		((ie_considera_validade_w = 'S' AND b.dt_prev_execucao > dt_inicio_prescr_w) or
					 (ie_considera_validade_w = 'N' AND b.dt_prev_execucao between dt_limite_minimo_w and dt_prev_execucao_w))
			and		((a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '') or (a.dt_liberacao_medico IS NOT NULL AND a.dt_liberacao_medico::text <> '') or (a.nr_prescricao = nr_prescricao_p AND b.nr_sequencia <> nr_sequencia_p));
			exception
				when others then
					qt_executada_periodo_w	:= 0;
			end;
			
		elsif (nr_seq_derivado_regra_w IS NOT NULL AND nr_seq_derivado_regra_w::text <> '') and (nr_seq_derivado_w IS NOT NULL AND nr_seq_derivado_w::text <> '') then
			begin

			select	max(b.dt_prev_execucao)
			into STRICT	dt_ultimo_exec_w
			from	prescr_procedimento b,
					prescr_medica a
			where	a.nr_prescricao		= b.nr_prescricao
			and		CASE WHEN ie_recem_nato='S' THEN coalesce(a.cd_recem_nato,a.cd_pessoa_fisica)  ELSE a.cd_pessoa_fisica END 	= cd_pessoa_fisica_w
			and		((a.nr_atendimento	= nr_atendimento_w AND ie_considerar_pessoa_fisica_w = 'N') or
					 (a.cd_pessoa_fisica = cd_pessoa_fisica_w AND ie_considerar_pessoa_fisica_w = 'S'))
			and		b.nr_seq_derivado	= nr_seq_derivado_w
			and		((coalesce(ie_mes_corrente_w,'N') = 'N') or (PKG_DATE_UTILS.start_of(b.dt_prev_execucao,'month',0) = PKG_DATE_UTILS.start_of(clock_timestamp(),'month',0)))
			and		coalesce(a.ie_recem_nato,'N') = ie_recem_nato_w
			and		Obter_se_setor_intev_proc(a.cd_setor_atendimento, nr_seq_regra_w) = 'S'
			and		((coalesce(ie_considera_setor_w,'N') = 'N') or (a.cd_setor_atendimento = cd_setor_atendimento_w))
			and		((coalesce(ie_consiste_lado_w,'N')	= 'N') or (b.ie_lado	= ie_lado_w))
			and		coalesce(a.dt_suspensao::text, '') = ''
			and		coalesce(b.ie_suspenso,'N')	<> 'S'
			AND		(((a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '') OR (a.dt_liberacao_medico IS NOT NULL AND a.dt_liberacao_medico::text <> '')) OR (b.nr_prescricao = nr_prescricao_p AND b.nr_sequencia <> nr_sequencia_p));
			exception
				when others then
					dt_ultimo_exec_w	:= null;
			end;

			begin
			select	sum(b.qt_procedimento)
			into STRICT	qt_executada_periodo_w
			from	prescr_procedimento b,
					prescr_medica a
			where	a.nr_prescricao		= b.nr_prescricao
			and		CASE WHEN ie_recem_nato='S' THEN coalesce(a.CD_RECEM_NATO,a.cd_pessoa_fisica)  ELSE a.cd_pessoa_fisica END 	= cd_pessoa_fisica_w
			and		((a.nr_atendimento	= nr_atendimento_w AND ie_considerar_pessoa_fisica_w = 'N') or
					 (a.cd_pessoa_fisica = cd_pessoa_fisica_w AND ie_considerar_pessoa_fisica_w = 'S'))
			and		((a.nr_prescricao	<> nr_prescricao_p) or (b.nr_sequencia	<> nr_sequencia_p))
			and		b.nr_seq_derivado	= nr_seq_derivado_w
			and		Obter_se_setor_intev_proc(a.cd_setor_atendimento, nr_seq_regra_w) = 'S'
			and		((coalesce(ie_mes_corrente_w,'N') = 'N') or (PKG_DATE_UTILS.start_of(b.dt_prev_execucao,'month',0) = PKG_DATE_UTILS.start_of(clock_timestamp(),'month',0)))
			and		((coalesce(ie_considera_setor_w,'N') = 'N') or (a.cd_setor_atendimento = cd_setor_atendimento_w))
			and		((coalesce(ie_consiste_lado_w,'N')	= 'N') or (b.ie_lado	= ie_lado_w))
			and		coalesce(a.dt_suspensao::text, '') = ''
			and		coalesce(a.ie_recem_nato,'N') = ie_recem_nato_w
			and		coalesce(b.ie_suspenso,'N')	<> 'S'
			and		((ie_considera_validade_w = 'S' AND b.dt_prev_execucao > dt_inicio_prescr_w) or
					 (ie_considera_validade_w = 'N' AND b.dt_prev_execucao between dt_limite_minimo_w and dt_prev_execucao_w))
			and		((a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '') or (a.dt_liberacao_medico IS NOT NULL AND a.dt_liberacao_medico::text <> '') or (a.nr_prescricao = nr_prescricao_p AND b.nr_sequencia <> nr_sequencia_p));
			exception
				when others then
					qt_executada_periodo_w	:= 0;
			end;	
		
		elsif (cd_grupo_proc_regra_w IS NOT NULL AND cd_grupo_proc_regra_w::text <> '') then
			begin

			select	max(b.dt_prev_execucao)
			into STRICT	dt_ultimo_exec_w
			from	estrutura_procedimento_v c,
				prescr_procedimento b,
				prescr_medica a
			where	a.nr_prescricao		= b.nr_prescricao
			and		CASE WHEN ie_recem_nato='S' THEN coalesce(a.CD_RECEM_NATO,a.cd_pessoa_fisica)  ELSE a.cd_pessoa_fisica END 	= cd_pessoa_fisica_w
			and		((a.nr_atendimento	= nr_atendimento_w AND ie_considerar_pessoa_fisica_w = 'N') or
					 (a.cd_pessoa_fisica = cd_pessoa_fisica_w AND ie_considerar_pessoa_fisica_w = 'S'))
			--and		b.cd_procedimento	= cd_procedimento_w
			and		b.ie_origem_proced	= ie_origem_proced_w
			and		b.cd_procedimento	= c.cd_procedimento
			and		((coalesce(ie_mes_corrente_w,'N') = 'N') or (PKG_DATE_UTILS.start_of(b.dt_prev_execucao,'month',0) = PKG_DATE_UTILS.start_of(clock_timestamp(),'month',0)))
			and		b.ie_origem_proced	= c.ie_origem_proced
			and		c.cd_grupo_proc		= cd_grupo_proc_regra_w
			and		coalesce(a.ie_recem_nato,'N') = ie_recem_nato_w
			and		Obter_se_setor_intev_proc(a.cd_setor_atendimento, nr_seq_regra_w) = 'S'
			and		((coalesce(ie_considera_setor_w,'N') = 'N') or (a.cd_setor_atendimento = cd_setor_atendimento_w))
			and		((coalesce(ie_consiste_lado_w,'N')	= 'N') or (b.ie_lado	= ie_lado_w))
			and		coalesce(a.dt_suspensao::text, '') = ''
			and		coalesce(b.ie_suspenso,'N')	<> 'S'
			AND		(((a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '') OR (a.dt_liberacao_medico IS NOT NULL AND a.dt_liberacao_medico::text <> '')) OR (b.nr_prescricao = nr_prescricao_p AND b.nr_sequencia <> nr_sequencia_p));
			exception
				when others then
					dt_ultimo_exec_w	:= null;
			end;
			
			begin
			select	sum(b.qt_procedimento)
			into STRICT	qt_executada_periodo_w
			from	estrutura_procedimento_v c,
					prescr_procedimento b,
					prescr_medica a
			where	a.nr_prescricao		= b.nr_prescricao
			and		CASE WHEN ie_recem_nato='S' THEN coalesce(a.CD_RECEM_NATO,a.cd_pessoa_fisica)  ELSE a.cd_pessoa_fisica END 	= cd_pessoa_fisica_w
			and		((a.nr_atendimento	= nr_atendimento_w AND ie_considerar_pessoa_fisica_w = 'N') or
					 (a.cd_pessoa_fisica = cd_pessoa_fisica_w AND ie_considerar_pessoa_fisica_w = 'S'))
			and		((a.nr_prescricao	<> nr_prescricao_p) or (b.nr_sequencia	<> nr_sequencia_p))
			--and		b.cd_procedimento	= cd_procedimento_w
			and		b.ie_origem_proced	= ie_origem_proced_w
			and		b.cd_procedimento	= c.cd_procedimento
			and		b.ie_origem_proced	= c.ie_origem_proced
			and		c.cd_grupo_proc		= cd_grupo_proc_regra_w
			and		coalesce(a.ie_recem_nato,'N') = ie_recem_nato_w
			and		((coalesce(ie_mes_corrente_w,'N') = 'N') or (PKG_DATE_UTILS.start_of(b.dt_prev_execucao,'month',0) = PKG_DATE_UTILS.start_of(clock_timestamp(),'month',0)))
			and		Obter_se_setor_intev_proc(a.cd_setor_atendimento, nr_seq_regra_w) = 'S'
			and		((coalesce(ie_considera_setor_w,'N') = 'N') or (a.cd_setor_atendimento = cd_setor_atendimento_w))
			and		((coalesce(ie_consiste_lado_w,'N')	= 'N') or (b.ie_lado	= ie_lado_w))
			and		coalesce(a.dt_suspensao::text, '') = ''
			and		coalesce(b.ie_suspenso,'N')	<> 'S'
			and		((ie_considera_validade_w = 'S' AND b.dt_prev_execucao > dt_inicio_prescr_w) or
					 (ie_considera_validade_w = 'N' AND b.dt_prev_execucao between dt_limite_minimo_w and dt_prev_execucao_w))
			and		((a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '') or (a.dt_liberacao_medico IS NOT NULL AND a.dt_liberacao_medico::text <> '') or (a.nr_prescricao = nr_prescricao_p AND b.nr_sequencia <> nr_sequencia_p));
			exception
				when others then
					qt_executada_periodo_w	:= 0;
			end;
			
		elsif (cd_especialidade_regra_w IS NOT NULL AND cd_especialidade_regra_w::text <> '') then
			begin		
			
			select	max(b.dt_prev_execucao)
			into STRICT	dt_ultimo_exec_w
			from	estrutura_procedimento_v c,
					prescr_procedimento b,
					prescr_medica a
			where	a.nr_prescricao		= b.nr_prescricao
			and		CASE WHEN ie_recem_nato='S' THEN coalesce(a.CD_RECEM_NATO,a.cd_pessoa_fisica)  ELSE a.cd_pessoa_fisica END 	= cd_pessoa_fisica_w
			and		((a.nr_atendimento	= nr_atendimento_w AND ie_considerar_pessoa_fisica_w = 'N') or
					 (a.cd_pessoa_fisica = cd_pessoa_fisica_w AND ie_considerar_pessoa_fisica_w = 'S'))
			and		b.cd_procedimento	= cd_procedimento_w
			and		b.ie_origem_proced	= ie_origem_proced_w
			and		b.cd_procedimento	= c.cd_procedimento
			and		b.ie_origem_proced	= c.ie_origem_proced
			and		c.cd_especialidade	= cd_especialidade_regra_w
			and		((coalesce(ie_mes_corrente_w,'N') = 'N') or (PKG_DATE_UTILS.start_of(b.dt_prev_execucao,'month',0) = PKG_DATE_UTILS.start_of(clock_timestamp(),'month',0)))
			and		Obter_se_setor_intev_proc(a.cd_setor_atendimento, nr_seq_regra_w) = 'S'
			and		((coalesce(ie_considera_setor_w,'N') = 'N') or (a.cd_setor_atendimento = cd_setor_atendimento_w))
			and		((coalesce(ie_consiste_lado_w,'N')	= 'N') or (b.ie_lado	= ie_lado_w))
			and		coalesce(a.dt_suspensao::text, '') = ''
			and		coalesce(a.ie_recem_nato,'N') = ie_recem_nato_w
			and		coalesce(b.ie_suspenso,'N')	<> 'S'
			AND		(((a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '') OR (a.dt_liberacao_medico IS NOT NULL AND a.dt_liberacao_medico::text <> '')) OR (b.nr_prescricao = nr_prescricao_p AND b.nr_sequencia <> nr_sequencia_p));
			exception
				when others then
					dt_ultimo_exec_w	:= null;
			end;
			
			begin
			select	sum(b.qt_procedimento)
			into STRICT	qt_executada_periodo_w
			from	estrutura_procedimento_v c,
					prescr_procedimento b,
					prescr_medica a
			where	a.nr_prescricao		= b.nr_prescricao
			and		CASE WHEN ie_recem_nato='S' THEN coalesce(a.CD_RECEM_NATO,a.cd_pessoa_fisica)  ELSE a.cd_pessoa_fisica END 	= cd_pessoa_fisica_w
			and		((a.nr_atendimento	= nr_atendimento_w AND ie_considerar_pessoa_fisica_w = 'N') or
					 (a.cd_pessoa_fisica = cd_pessoa_fisica_w AND ie_considerar_pessoa_fisica_w = 'S'))
			and		((a.nr_prescricao	<> nr_prescricao_p) or (b.nr_sequencia	<> nr_sequencia_p))
			and		b.cd_procedimento	= cd_procedimento_w
			and		b.ie_origem_proced	= ie_origem_proced_w
			and		b.cd_procedimento	= c.cd_procedimento
			and		b.ie_origem_proced	= c.ie_origem_proced
			and		c.cd_especialidade	= cd_especialidade_regra_w
			and		Obter_se_setor_intev_proc(a.cd_setor_atendimento, nr_seq_regra_w) = 'S'
			and		((coalesce(ie_mes_corrente_w,'N') = 'N') or (PKG_DATE_UTILS.start_of(b.dt_prev_execucao,'month',0) = PKG_DATE_UTILS.start_of(clock_timestamp(),'month',0)))
			and		((coalesce(ie_considera_setor_w,'N') = 'N') or (a.cd_setor_atendimento = cd_setor_atendimento_w))
			and		((coalesce(ie_consiste_lado_w,'N')	= 'N') or (b.ie_lado	= ie_lado_w))
			and		coalesce(a.dt_suspensao::text, '') = ''
			and		coalesce(a.ie_recem_nato,'N') = ie_recem_nato_w
			and		coalesce(b.ie_suspenso,'N')	<> 'S'
			and		((ie_considera_validade_w = 'S' AND b.dt_prev_execucao > dt_inicio_prescr_w) or
					 (ie_considera_validade_w = 'N' AND b.dt_prev_execucao between dt_limite_minimo_w and dt_prev_execucao_w))
			and		((a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '') or (a.dt_liberacao_medico IS NOT NULL AND a.dt_liberacao_medico::text <> '') or (a.nr_prescricao = nr_prescricao_p AND b.nr_sequencia <> nr_sequencia_p));
			exception
				when others then
					qt_executada_periodo_w	:= 0;
			end;
			
		elsif (cd_area_procedimento_regra_w IS NOT NULL AND cd_area_procedimento_regra_w::text <> '') then
			begin
			
			select	max(b.dt_prev_execucao)
			into STRICT	dt_ultimo_exec_w
			from	estrutura_procedimento_v c,
					prescr_procedimento b,
					prescr_medica a
			where	a.nr_prescricao		= b.nr_prescricao
			and		CASE WHEN ie_recem_nato='S' THEN coalesce(a.CD_RECEM_NATO,a.cd_pessoa_fisica)  ELSE a.cd_pessoa_fisica END 	= cd_pessoa_fisica_w
			and		((a.nr_atendimento	= nr_atendimento_w AND ie_considerar_pessoa_fisica_w = 'N') or
					 (a.cd_pessoa_fisica = cd_pessoa_fisica_w AND ie_considerar_pessoa_fisica_w = 'S'))
			and		b.cd_procedimento	= cd_procedimento_w
			and		b.ie_origem_proced	= ie_origem_proced_w
			and		b.cd_procedimento	= c.cd_procedimento
			and		b.ie_origem_proced	= c.ie_origem_proced
			and		c.cd_area_procedimento	= cd_area_procedimento_regra_w
			and		((coalesce(ie_mes_corrente_w,'N') = 'N') or (PKG_DATE_UTILS.start_of(b.dt_prev_execucao,'month',0) = PKG_DATE_UTILS.start_of(clock_timestamp(),'month',0)))
			and		Obter_se_setor_intev_proc(a.cd_setor_atendimento, nr_seq_regra_w) = 'S'
			and		((coalesce(ie_considera_setor_w,'N') = 'N') or (a.cd_setor_atendimento = cd_setor_atendimento_w))
			and		((coalesce(ie_consiste_lado_w,'N')	= 'N') or (b.ie_lado	= ie_lado_w))
			and		coalesce(a.ie_recem_nato,'N') = ie_recem_nato_w
			and		coalesce(a.dt_suspensao::text, '') = ''
			and		coalesce(b.ie_suspenso,'N')	<> 'S'
			AND		(((a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '') OR (a.dt_liberacao_medico IS NOT NULL AND a.dt_liberacao_medico::text <> '')) OR (b.nr_prescricao = nr_prescricao_p AND b.nr_sequencia <> nr_sequencia_p));
			exception
				when others then
					dt_ultimo_exec_w	:= null;
			end;
			
			begin
			select	sum(b.qt_procedimento)
			into STRICT	qt_executada_periodo_w
			from	estrutura_procedimento_v c,
					prescr_procedimento b,
					prescr_medica a
			where	a.nr_prescricao		= b.nr_prescricao
			and		CASE WHEN ie_recem_nato='S' THEN coalesce(a.CD_RECEM_NATO,a.cd_pessoa_fisica)  ELSE a.cd_pessoa_fisica END 	= cd_pessoa_fisica_w
			and		((a.nr_atendimento	= nr_atendimento_w AND ie_considerar_pessoa_fisica_w = 'N') or
					 (a.cd_pessoa_fisica = cd_pessoa_fisica_w AND ie_considerar_pessoa_fisica_w = 'S'))
			and		((a.nr_prescricao	<> nr_prescricao_p) or (b.nr_sequencia	<> nr_sequencia_p))
			and		b.cd_procedimento	= cd_procedimento_w
			and		b.ie_origem_proced	= ie_origem_proced_w
			and		b.cd_procedimento	= c.cd_procedimento
			and		b.ie_origem_proced	= c.ie_origem_proced
			and		c.cd_area_procedimento	= cd_area_procedimento_regra_w
			and		((coalesce(ie_mes_corrente_w,'N') = 'N') or (PKG_DATE_UTILS.start_of(b.dt_prev_execucao,'month',0) = PKG_DATE_UTILS.start_of(clock_timestamp(),'month',0)))
			and		Obter_se_setor_intev_proc(a.cd_setor_atendimento, nr_seq_regra_w) = 'S'
			and		((coalesce(ie_considera_setor_w,'N') = 'N') or (a.cd_setor_atendimento = cd_setor_atendimento_w))
			and		((coalesce(ie_consiste_lado_w,'N')	= 'N') or (b.ie_lado	= ie_lado_w))
			and		coalesce(a.dt_suspensao::text, '') = ''
			and		coalesce(a.ie_recem_nato,'N') = ie_recem_nato_w
			and		((ie_considera_validade_w = 'S' AND b.dt_prev_execucao > dt_inicio_prescr_w) or
					 (ie_considera_validade_w = 'N' AND b.dt_prev_execucao between dt_limite_minimo_w and dt_prev_execucao_w))
			and		coalesce(b.ie_suspenso,'N')	<> 'S'
			and		((a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '') or (a.dt_liberacao_medico IS NOT NULL AND a.dt_liberacao_medico::text <> '') or (a.nr_prescricao = nr_prescricao_p AND b.nr_sequencia <> nr_sequencia_p));
			exception
				when others then
					qt_executada_periodo_w	:= 0;
			end;
			
		end if;
	end if;
	
	if (qt_hora_ww > 0) then
		qt_hora_w := (qt_hora_ww * 60);
	end if;
	
	
	
	select	coalesce(max(b.qt_procedimento),0)
	into STRICT	qt_prescricao_cons_w
	from	prescr_procedimento b
	where	b.nr_prescricao	= nr_prescricao_p
	and	b.nr_sequencia	= nr_sequencia_p;	

	qt_executada_periodo_w	:= coalesce(qt_executada_periodo_w,0) + coalesce(qt_prescricao_cons_w,0);
	
	qt_min_ref_w	:= dividir((qt_hora_w + qt_minutos_ww),1440);	
	
	if (nr_seq_derivado_w IS NOT NULL AND nr_seq_derivado_w::text <> '') and (qt_permitida_w IS NOT NULL AND qt_permitida_w::text <> '') and (qt_executada_periodo_w > qt_permitida_w) then
		ie_quantidade_p	:= 'S';
	end if;
	
	if	((dt_ultimo_exec_w IS NOT NULL AND dt_ultimo_exec_w::text <> '') and
		((dt_prev_execucao_w - dt_ultimo_exec_w) < qt_min_ref_w)) and
		((coalesce(qt_permitida_w::text, '') = '') or (qt_executada_periodo_w > qt_permitida_w)) then	
		ds_procedimentos_w	:= WHEB_MENSAGEM_PCK.get_texto(457533,'HOURS='|| qt_hora_w ||';MINUTES='|| qt_minutos_w);
	end if;

end loop;
close C01;

if (dt_ultimo_exec_w IS NOT NULL AND dt_ultimo_exec_w::text <> '') then
	dt_ultima_data_p := dt_ultimo_exec_w;
end if;

if (ds_procedimentos_w IS NOT NULL AND ds_procedimentos_w::text <> '') then
	ds_erro_w	:= ds_procedimentos_w;
	ds_mensagem_data_p := PKG_DATE_FORMATERS_TZ.TO_VARCHAR(dt_ultimo_exec_w + ((coalesce(qt_hora_w,0) + coalesce(qt_minutos_ww,0))/1440), 'timestamp', ESTABLISHMENT_TIMEZONE_UTILS.getTimeZone);
else
	ds_mensagem_data_p := PKG_DATE_FORMATERS_TZ.TO_VARCHAR(dt_prev_execucao_w + ((coalesce(qt_horas_p,0) * 60) + coalesce(qt_minutos_p,0))/1440, 'timestamp', ESTABLISHMENT_TIMEZONE_UTILS.getTimeZone);
end if;


ds_erro_p	:= substr(ds_erro_w,1,255);
ie_lib_prescr_p		:= ie_lib_prescr_w;
ds_mensagem_regra_p	:= ds_mensagem_regra_w;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE consistir_interv_solic_exame ( nr_prescricao_p bigint, nr_sequencia_p bigint, ds_erro_p INOUT text, ie_lib_prescr_p INOUT text, qt_horas_p INOUT bigint, qt_minutos_p INOUT bigint, ie_quantidade_p INOUT text, ds_mensagem_regra_p INOUT text, ds_mensagem_data_p INOUT text, dt_ultima_data_p INOUT timestamp, cd_perfil_p bigint, nm_usuario_p text ) FROM PUBLIC;

