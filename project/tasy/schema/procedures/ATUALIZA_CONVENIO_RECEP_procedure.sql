-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE atualiza_convenio_recep ( nr_seq_agenda_p bigint, cd_pessoa_fisica_p bigint) AS $body$
DECLARE


cd_convenio_w			pessoa_titular_convenio.cd_convenio%type;
cd_categoria_w			pessoa_titular_convenio.cd_categoria%type;
cd_plano_convenio_w		pessoa_titular_convenio.cd_plano_convenio%type;
cd_usuario_conv_w		pessoa_titular_convenio.cd_usuario_convenio%type;
dt_validade_carteira_w	pessoa_titular_convenio.dt_validade_carteira%type;
cd_empresa_ref_w		pessoa_titular_convenio.cd_empresa_refer%type;
ie_possui_registro_w					varchar(1);


BEGIN
if (coalesce(nr_seq_agenda_p, 0) > 0) then
	select 	cd_convenio,
		cd_categoria,
		cd_plano,
		cd_usuario_convenio,
		dt_validade_carteira,
		cd_empresa_ref
	into STRICT	cd_convenio_w,
		cd_categoria_w,
		cd_plano_convenio_w,
		cd_usuario_conv_w,
		dt_validade_carteira_w,
		cd_empresa_ref_w
	from	agenda_paciente
	where 	nr_sequencia = nr_seq_agenda_p;

	if (cd_convenio_w IS NOT NULL AND cd_convenio_w::text <> '') then
		select 	CASE WHEN count(*)=0 THEN  'N'  ELSE 'S' END
		into STRICT	ie_possui_registro_w
		from 	pessoa_titular_convenio
		where	cd_pessoa_fisica = cd_pessoa_fisica_p
		and		cd_convenio = cd_convenio_w
		and		cd_categoria = coalesce(cd_categoria_w, 0)  LIMIT 1;

		if (ie_possui_registro_w = 'N') then
			insert 	into pessoa_titular_convenio(
												NR_SEQUENCIA,
												DT_ATUALIZACAO,
												NM_USUARIO,
												CD_PESSOA_FISICA,
												CD_CONVENIO,
												CD_CATEGORIA,
												cd_plano_convenio,
												cd_usuario_convenio,
												dt_validade_carteira,
												cd_empresa_refer,
												dt_atualizacao_nrec,
												nm_usuario_nrec
												)
			values (
					nextval('pessoa_titular_convenio_seq'),
					clock_timestamp(),
					obter_usuario_ativo,
					cd_pessoa_fisica_p,
					cd_convenio_w,
					cd_categoria_w,
					cd_plano_convenio_w,
					cd_usuario_conv_w,
					dt_validade_carteira_w,
					cd_empresa_ref_w,
					clock_timestamp(),
					obter_usuario_ativo
					);
		end if;
	end if;
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE atualiza_convenio_recep ( nr_seq_agenda_p bigint, cd_pessoa_fisica_p bigint) FROM PUBLIC;

