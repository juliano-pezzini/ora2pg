-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gestao_prontuario_same ( nr_sequencia_p bigint, nm_usuario_p text, cd_pessoa_fisica_p text, cd_setor_solicitante_p bigint, nr_seq_local_p bigint, nr_seq_caixa_p bigint, nr_seq_agrup_p bigint, nr_seq_agrupados_p text, nr_seq_operacao_p bigint, ds_observacao_p text, nr_seq_tipo_operacao_p bigint, dt_operacao_p timestamp default null, cd_estabelecimento_p bigint default null, cd_maco_p text default null) AS $body$
DECLARE


ie_same_hist_w		integer;
nr_sequencia_w		bigint;
nr_seq_agrup_w		bigint := 0;
nr_seq_operacao_w	bigint;
ie_status_w		bigint := 0;
nr_seq_local_w		bigint;
nr_atendimento_w	bigint;
ie_tipo_atendimento_w	smallint := 0;
ie_tipo_atend_caixa_w	smallint;
ds_tipo_atendimento_w	varchar(60);
cd_pessoa_fisica_w	varchar(10);
nr_prontuario_w		bigint;
qt_itens_w		bigint;
ie_setor_same_w		varchar(1);
cd_estabelecimento_w	smallint;
cd_setor_same_w		integer;
dt_liberacao_caixa_w	timestamp;
ie_caixa_liberada_w	varchar(1);
ie_tipo_atend_pront_w	smallint;
nr_seq_same_hist_w	bigint;
nr_seq_caixa_ant_w	bigint;
ie_voltar_local_ant_w	varchar(1);
cd_estab_same_w			same_prontuario.cd_estabelecimento%type;

ie_status_na_devolucao_w	varchar(10) := coalesce(obter_valor_param_usuario(941,82,obter_perfil_ativo,nm_usuario_p,cd_estabelecimento_p),'D');
ie_armazena_na_devolucao_w	varchar(10) := coalesce(obter_valor_param_usuario(941,234,obter_perfil_ativo,nm_usuario_p,cd_estabelecimento_p),'S');

BEGIN


if (cd_estabelecimento_p IS NOT NULL AND cd_estabelecimento_p::text <> '') then
	cd_estabelecimento_w := cd_estabelecimento_p;
else
	select	max(cd_estabelecimento)
	into STRICT	cd_estabelecimento_w
	from	usuario
	where	nm_usuario = nm_usuario_p;
end if;


ie_setor_same_w := Obter_Param_Usuario(941, 78, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_setor_same_w);
ie_caixa_liberada_w := Obter_Param_Usuario(941, 204, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_caixa_liberada_w);
ie_voltar_local_ant_w := Obter_Param_Usuario(941, 221, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_voltar_local_ant_w);

select	coalesce(MAX(nr_atendimento),0)
into STRICT	nr_atendimento_w
from	same_prontuario
where	nr_sequencia	= nr_sequencia_p;

nr_seq_local_w		:= nr_seq_local_p;
nr_seq_operacao_w	:= nr_seq_operacao_p;

if (nr_seq_operacao_p = 8) then
	select	COUNT(*)
	into STRICT	ie_same_hist_w
	from	same_prontuario_hist
	where	nr_seq_same = nr_sequencia_p;

	if (nr_seq_caixa_p IS NOT NULL AND nr_seq_caixa_p::text <> '') then
		begin
		select	nr_seq_local,
			coalesce(ie_tipo_atendimento,0)
		into STRICT	nr_seq_local_w,
			ie_tipo_atend_caixa_w
		from	same_caixa
		where	nr_sequencia = nr_seq_caixa_p;
		exception
			when others then
			nr_seq_local_w		:= null;
			ie_tipo_atend_caixa_w	:= null;
		end;
	end if;

end if;
if (nr_seq_operacao_p = 9) then
	begin
	update	same_prontuario
	set	nr_seq_local = nr_seq_local_p
	where	nr_sequencia = nr_sequencia_p;
	end;
elsif (nr_seq_operacao_p = 10) then
	begin
	select	coalesce(MAX(nr_seq_agrup),0),
		coalesce(MAX(ie_status),0),
		max(cd_pessoa_fisica)
	into STRICT	nr_seq_agrup_w,
		ie_status_w,
		cd_pessoa_fisica_w
	from	same_prontuario
	where	nr_sequencia = nr_sequencia_p;

	update	same_prontuario
	set	nr_seq_agrup = nr_seq_agrup_p,
		ie_status    = '2',
		nr_seq_volume = 0
	where	nr_sequencia = nr_sequencia_p
	and	nr_sequencia <> nr_seq_agrup_p
	and	coalesce(nr_seq_agrup::text, '') = ''
	and	ie_status not in (3,4,6,10);

	CALL same_ordernar_volume_pront(cd_pessoa_fisica_w,0,nm_usuario_p,cd_Estabelecimento_w);

	end;
elsif (nr_seq_operacao_p = 11) then
	begin
	update	same_prontuario
	set	ie_status = '4',
		cd_setor_atendimento = coalesce(cd_setor_solicitante_p, cd_setor_atendimento),
		nr_seq_local = coalesce(nr_seq_local_p, nr_seq_local)
	where	nr_sequencia = nr_sequencia_p;
	end;
elsif (nr_seq_operacao_p = 20) then
	begin
	update	same_prontuario
	set	ie_status = '7',
		cd_setor_atendimento = coalesce(cd_setor_solicitante_p, cd_setor_atendimento),
		nr_seq_local = coalesce(nr_seq_local_p, nr_seq_local)
	where	nr_sequencia = nr_sequencia_p;
	nr_seq_operacao_w := 11;
	end;
elsif (nr_seq_operacao_p = 17) then
	begin
	update	same_prontuario
	set	ie_status = '8',
		cd_setor_atendimento = coalesce(cd_setor_solicitante_p, cd_setor_atendimento)
	where	nr_sequencia = nr_sequencia_p;
	nr_seq_operacao_w := 11;
	end;
elsif (nr_seq_operacao_p = 12) then
	begin

	select	obter_prontuario_pf(cd_Estabelecimento_w, CD_PESSOA_FISICA),
		CD_PESSOA_FISICA,
		coalesce(ie_tipo_atend_prontuario,0),
		cd_estabelecimento
	into STRICT	nr_prontuario_w,
		cd_pessoa_fisica_w,
		ie_tipo_atend_pront_w,
		cd_estab_same_w
	from	same_prontuario
	where	nr_sequencia = nr_sequencia_p;

	select 	count(*)
	into STRICT	qt_itens_w
	from	TRANSF_PRONTUARIO a,
			same_prontuario b
	where	a.cd_pessoa_fisica = cd_pessoa_fisica_w
	and a.cd_pessoa_fisica = b.cd_pessoa_fisica
	and	((a.ie_tipo_atend_prontuario = ie_tipo_atend_pront_w) or (ie_tipo_atend_pront_w = 0) or (coalesce(a.ie_tipo_atend_prontuario::text, '') = ''))
	and	coalesce(a.DT_RECEBIMENTO::text, '') = ''
	and	coalesce(a.DT_CANCELAMENTO::text, '') = ''
	and b.CD_ESTABELECIMENTO = cd_estab_same_w
  and a.CD_ESTABELECIMENTO = cd_estab_same_w
	and	not exists (SELECT 1 from TRANSF_PRONTUARIO_ENVELOPE c where c.NR_SEQ_TRANSF = a.nr_sequencia);

	if (qt_itens_w > 0) then
		CALL WHEB_MENSAGEM_PCK.Exibir_Mensagem_Abort(186826);
	end if;

	select	coalesce(cd_setor_solicitante_p, cd_setor_atendimento)
	into STRICT	cd_setor_same_w
	from	same_prontuario
	where	nr_sequencia = nr_sequencia_p;

	if (ie_setor_same_w = 'S') then
		select	coalesce(obter_setor_same(cd_estabelecimento_w, nr_sequencia_p),cd_setor_same_w)
		into STRICT	cd_setor_same_w
		;
	end if;
	
	update	same_prontuario
	set	ie_status = '1',
		cd_setor_atendimento = cd_setor_same_w,
		nr_seq_local = coalesce(nr_seq_local_p, nr_seq_local)
	where	nr_sequencia = nr_sequencia_p;		

	/* Seta o status de todas as solicitacoes que estao entregues e sem data de devolucao para devolvido */

	CALL same_devolver_solic(nr_atendimento_w,nr_prontuario_w);

	end;
elsif (nr_seq_operacao_p = 33) then
	begin
	
	nr_seq_operacao_w:= 12;

	select	obter_prontuario_pf(cd_Estabelecimento_w, CD_PESSOA_FISICA),
		CD_PESSOA_FISICA,
		coalesce(ie_tipo_atend_prontuario,0),
		cd_estabelecimento
	into STRICT	nr_prontuario_w,
		cd_pessoa_fisica_w,
		ie_tipo_atend_pront_w,
		cd_estab_same_w
	from	same_prontuario
	where	nr_sequencia = nr_sequencia_p;

	select 	count(*)
	into STRICT	qt_itens_w
	from	TRANSF_PRONTUARIO a,
			same_prontuario b
	where	a.cd_pessoa_fisica = cd_pessoa_fisica_w
	and a.cd_pessoa_fisica = b.cd_pessoa_fisica
	and	((a.ie_tipo_atend_prontuario = ie_tipo_atend_pront_w) or (ie_tipo_atend_pront_w = 0) or (coalesce(a.ie_tipo_atend_prontuario::text, '') = ''))
	and	coalesce(a.DT_RECEBIMENTO::text, '') = ''
	and	coalesce(a.DT_CANCELAMENTO::text, '') = ''
	and b.CD_ESTABELECIMENTO = cd_estab_same_w
	and	not exists (SELECT 1 from TRANSF_PRONTUARIO_ENVELOPE c where c.NR_SEQ_TRANSF = a.nr_sequencia);

	if (qt_itens_w > 0) then
		CALL WHEB_MENSAGEM_PCK.Exibir_Mensagem_Abort(186826);
	end if;

	select	coalesce(cd_setor_solicitante_p, cd_setor_atendimento)
	into STRICT	cd_setor_same_w
	from	same_prontuario
	where	nr_sequencia = nr_sequencia_p;

	if (ie_setor_same_w = 'S') then
		select	coalesce(obter_setor_same(cd_estabelecimento_w, nr_sequencia_p),cd_setor_same_w)
		into STRICT	cd_setor_same_w
		;
	end if;

	-- Nao setar para 'Armazenado' se utiliza o status  'V = Em Devolucao' e configuracao indicar que nao deve armazenar. Setara para armazenado somente no status 'D = Devolvido'
	if (ie_status_na_devolucao_w = 'V' AND ie_armazena_na_devolucao_w = 'N') then
		update	same_prontuario
		set	cd_setor_atendimento = cd_setor_same_w,
			nr_seq_local = coalesce(nr_seq_local_p, nr_seq_local)
		where	nr_sequencia = nr_sequencia_p;
	else
		update	same_prontuario
		set	ie_status = '1',
			cd_setor_atendimento = cd_setor_same_w,
			nr_seq_local = coalesce(nr_seq_local_p, nr_seq_local)
		where	nr_sequencia = nr_sequencia_p;		
	end if;

	/* Seta o status de todas as solicitacoes que estao entregues e sem data de devolucao para devolvido */

	CALL same_devolver_solic(nr_atendimento_w,nr_prontuario_w);

	end;
elsif (nr_seq_operacao_p = 3) then
	begin

	update	same_prontuario
	set	ie_status = '3',
		cd_setor_atendimento = coalesce(cd_setor_solicitante_p, cd_setor_atendimento),
		nr_seq_local = coalesce(nr_seq_local_p, nr_seq_local)
	where	nr_sequencia = nr_sequencia_p;

	nr_seq_operacao_w := 11;

	end;
elsif (nr_seq_operacao_p = 13) then
	begin
	begin
	
	select	max(nr_sequencia)
	into STRICT	nr_seq_same_hist_w
	from	SAME_PRONTUARIO_HIST
	where	nr_Seq_same = nr_sequencia_p
	and	nr_seq_operacao = 13;
	
	select	coalesce(max(nr_seq_caixa),0)
	into STRICT	nr_seq_caixa_ant_w
	from	same_prontuario_hist
	where	nr_sequencia = nr_seq_same_hist_w;
	
	select	nr_seq_local,
		coalesce(ie_tipo_atendimento,0),
		dt_liberacao
	into STRICT	nr_seq_local_w,
		ie_tipo_atend_caixa_w,
		dt_liberacao_caixa_w
	from	same_caixa
	where	nr_sequencia = nr_seq_caixa_p;
	exception
		when others then
		nr_seq_local_w		:= null;
		ie_tipo_atend_caixa_w	:= 0;
		dt_liberacao_caixa_w := null;
	end;

	if (ie_caixa_liberada_w = 'S') then
		if (dt_liberacao_caixa_w IS NOT NULL AND dt_liberacao_caixa_w::text <> '') and (nr_seq_caixa_ant_w <> nr_seq_caixa_p) and (nr_seq_caixa_ant_w > 0) then
			CALL wheb_mensagem_pck.exibir_mensagem_abort(213407);
		end if;
	end if;
	
	if (nr_atendimento_w <> 0) then
		select	ie_tipo_atendimento
		into STRICT	ie_tipo_atendimento_w
		from	atendimento_paciente
		where	nr_atendimento = nr_atendimento_w;
	end if;

	if (ie_tipo_atend_caixa_w <> 0) and (ie_tipo_atend_caixa_w <> ie_tipo_atendimento_w) then


		select	SUBSTR(obter_valor_dominio(12,ie_tipo_atend_caixa_w),1,50)
		into STRICT	ds_tipo_atendimento_w
		;
		CALL wheb_mensagem_pck.exibir_mensagem_abort(186828,'DS_TIPO_ATENDIMENTO='||ds_tipo_atendimento_w);
	end if;


	update	same_prontuario
	set	nr_seq_caixa 		= nr_seq_caixa_p,
		nr_seq_local_ant	= nr_seq_local,
		nr_seq_local 		= nr_seq_local_w,
		cd_setor_atendimento 	= coalesce(cd_setor_solicitante_p,cd_setor_atendimento),
		cd_maco			= cd_maco_p
	where	nr_sequencia = nr_sequencia_p;
	
	
	end;
elsif (nr_seq_operacao_p = 14) then
	begin		
	
	if (ie_voltar_local_ant_w = 'N') then
		begin
			update	same_prontuario
			set	nr_seq_caixa  = NULL,
				nr_seq_local_ant  = NULL,
				cd_maco	 = NULL
			where	nr_sequencia = nr_sequencia_p;
		end;
	elsif (ie_voltar_local_ant_w = 'S') then
		begin
			update	same_prontuario
			set	nr_seq_caixa  = NULL,
				nr_seq_local = nr_seq_local_ant,
				nr_seq_local_ant  = NULL,
				cd_maco	 = NULL
			where	nr_sequencia = nr_sequencia_p;
		end;
	end if;			
		
	end;
elsif (nr_seq_operacao_p = 15) then
	begin
	update	same_prontuario
	set	ie_status    = '6'
	where	nr_sequencia = nr_sequencia_p;
	end;
elsif (nr_seq_operacao_p = 18) then /* Ivan em 23/06/2007 OS58890 */
	begin
	update	same_prontuario
	set	ie_status    = '1'
	where	nr_sequencia = nr_sequencia_p;
	end;
elsif (nr_seq_operacao_p = 19) then /* Ivan em 20/02/2008 OS77153*/
	update	same_prontuario
	set	ie_status    = '9'
	where	nr_sequencia = nr_sequencia_p;
elsif (nr_seq_operacao_p = 22) then /* Ivan em 20/02/2008 OS77153 */
	nr_seq_operacao_w	:= 18;
elsif (nr_seq_operacao_p = 27) then /* OS 342960 */
	begin
	update	same_prontuario
	set	nr_seq_local = nr_seq_local_w
	where	nr_sequencia = nr_sequencia_p;
	end;
elsif (nr_seq_operacao_p = 30) then
	begin
	update	same_prontuario
	set	ie_status    = '10',
		dt_inativacao = clock_timestamp(),
		nm_usuario_inativacao = nm_usuario_p
	where	nr_sequencia = nr_sequencia_p;
	end;
elsif (nr_seq_operacao_p = 31) then
	begin
	select	ie_status
	into STRICT	ie_status_w
	from	same_prontuario
	where	nr_sequencia = nr_sequencia_p;
	
	if (ie_status_w not in (1,6,10)) then
		update	same_prontuario
		set	ie_status    = '1',
			dt_atualizacao = clock_timestamp(),
			nm_usuario = nm_usuario_p
		where	nr_sequencia = nr_sequencia_p;
	end if;
	
	end;
elsif (nr_seq_operacao_p = 32) then
	begin
	update	same_prontuario
	set	ie_status    = '1',
		dt_inativacao  = NULL,
		nm_usuario_inativacao  = NULL,
		dt_atualizacao = clock_timestamp(),
		nm_usuario = nm_usuario_p
	where	nr_sequencia = nr_sequencia_p;
	end;
end if;

if	((ie_same_hist_w = 0) or (nr_seq_operacao_p <> 8)) and
	((nr_seq_agrup_w = 0) and (ie_status_w not in (3,4,6,10))) then

	select	nextval('same_prontuario_hist_seq')
	into STRICT	nr_sequencia_w
	;

	insert into same_prontuario_hist(
		nr_sequencia,
		nr_seq_same,
		dt_atualizacao,
		nm_usuario,
		nr_seq_operacao,
		dt_historico,
		nr_seq_caixa,
		nr_seq_local,
		cd_pessoa_fisica,
		cd_setor_solicitante,
		ds_observacao,
		nr_seq_tipo_operacao
	) values (
		nr_sequencia_w,
		nr_sequencia_p,
		coalesce(dt_operacao_p,clock_timestamp()),
		nm_usuario_p,
		nr_seq_operacao_w,
		coalesce(dt_operacao_p,clock_timestamp()),
		nr_seq_caixa_p,
		nr_seq_local_w,
		cd_pessoa_fisica_p,
		cd_setor_solicitante_p,
		ds_observacao_p,
		nr_seq_tipo_operacao_p
	);

end if;

--if (nvl(wheb_usuario_pck.get_ie_commit, 'S') = 'S') then commit; end if;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gestao_prontuario_same ( nr_sequencia_p bigint, nm_usuario_p text, cd_pessoa_fisica_p text, cd_setor_solicitante_p bigint, nr_seq_local_p bigint, nr_seq_caixa_p bigint, nr_seq_agrup_p bigint, nr_seq_agrupados_p text, nr_seq_operacao_p bigint, ds_observacao_p text, nr_seq_tipo_operacao_p bigint, dt_operacao_p timestamp default null, cd_estabelecimento_p bigint default null, cd_maco_p text default null) FROM PUBLIC;

