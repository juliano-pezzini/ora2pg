-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE atualiza_antimicrobiano_dia ( nr_prescricao_p bigint, nr_sequencia_p bigint) AS $body$
DECLARE



nr_dia_util_w				bigint;
qt_dias_solicitado_w		smallint;
qt_dias_liberado_w			smallint;
nr_seq_avaliacao_w			bigint;
ie_objetivo_w				varchar(1);
cd_topografia_cih_w			bigint;
ie_origem_infeccao_w		varchar(1);
cd_amostra_cih_w			bigint;
cd_microorganismo_cih_w		bigint;
ie_cultura_cih_w			varchar(1);
ie_antibiograma_w			varchar(1);
ie_uso_antimicrobiano_w		varchar(1);
ds_justificativa_w			varchar(2000);
nr_dia_util_ww				bigint;
cd_material_ww				integer;

c01 CURSOR FOR
	SELECT	a.nr_dia_util,
			a.qt_dias_solicitado,
			a.qt_dias_liberado,
			a.nr_seq_avaliacao,
			a.ie_objetivo,
			a.cd_topografia_cih,
			a.ie_origem_infeccao,
			a.cd_amostra_cih,
			a.cd_microorganismo_cih,
			a.ie_cultura_cih,
			a.ie_antibiograma,
			a.ie_uso_antimicrobiano,
			a.ds_justificativa
	from	prescr_material a
	where	1 = 1
	and		not exists (	SELECT	1
							from	prescr_material_erro x
							where	a.nr_prescricao	= x.nr_prescricao
							and	a.nr_sequencia	= x.nr_seq_prescricao)
	and		a.ie_agrupador	= 1
	and		a.cd_material	= cd_material_ww
	and		a.nr_sequencia	<> nr_sequencia_p
	and		a.nr_prescricao	= nr_prescricao_p;

BEGIN

select	coalesce(max(cd_material),0),
		coalesce(max(nr_dia_util),0)
into STRICT	cd_material_ww,
		nr_dia_util_ww
from	prescr_material
where	nr_sequencia	= nr_sequencia_p
and		nr_prescricao	= nr_prescricao_p;

OPEN C01;
LOOP
FETCH C01 into
	nr_dia_util_w,
	qt_dias_solicitado_w,
	qt_dias_liberado_w,
	nr_seq_avaliacao_w,
	ie_objetivo_w,
	cd_topografia_cih_w,
	ie_origem_infeccao_w,
	cd_amostra_cih_w,
	cd_microorganismo_cih_w,
	ie_cultura_cih_w,
	ie_antibiograma_w,
	ie_uso_antimicrobiano_w,
	ds_justificativa_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin

	update	prescr_material
	set		qt_dias_solicitado	= coalesce(qt_dias_solicitado,qt_dias_solicitado_w),
			qt_dias_liberado	= coalesce(qt_dias_liberado,qt_dias_liberado_w),
			nr_seq_avaliacao	= coalesce(nr_seq_avaliacao,nr_seq_avaliacao_w),
			ie_objetivo		= coalesce(ie_objetivo,ie_objetivo_w),
			cd_topografia_cih	= coalesce(cd_topografia_cih,cd_topografia_cih_w),
			ie_origem_infeccao	= coalesce(ie_origem_infeccao,ie_origem_infeccao_w),
			cd_amostra_cih		= coalesce(cd_amostra_cih,cd_amostra_cih_w),
			cd_microorganismo_cih	= coalesce(cd_microorganismo_cih,cd_microorganismo_cih_w),
			ie_cultura_cih		= coalesce(ie_cultura_cih,ie_cultura_cih_w),
			ie_antibiograma		= coalesce(ie_antibiograma,ie_antibiograma_w),
			ie_uso_antimicrobiano	= coalesce(ie_uso_antimicrobiano,ie_uso_antimicrobiano_w),
			ds_justificativa	= coalesce(ds_justificativa,ds_justificativa_w)
	where	1 = 1
	and		nr_dia_util_ww		= 1
	and		nr_sequencia		= nr_sequencia_p
	and		nr_prescricao		= nr_prescricao_p;

	end;
END LOOP;
close c01;

commit;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE atualiza_antimicrobiano_dia ( nr_prescricao_p bigint, nr_sequencia_p bigint) FROM PUBLIC;

