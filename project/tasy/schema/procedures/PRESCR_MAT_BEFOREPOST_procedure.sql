-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE prescr_mat_beforepost ( nr_prescricao_p bigint, cd_material_p bigint, nr_sequencia_p bigint, ie_via_aplicacao_p text, cd_setor_atendimento_p bigint, nr_atendimento_p bigint, qt_material_p INOUT bigint, ds_observacao_via_p INOUT text, ie_obriga_jusificativa_p INOUT text, ie_material_padronizado_p INOUT text, ie_classif_custo_p INOUT text, ie_obriga_just_dose_p INOUT text, ie_justificativa_padrao_p INOUT text, qt_limite_pessoa_p INOUT bigint, nr_dias_lib_p INOUT bigint, ds_pergunta_p INOUT text, cd_estabelecimento_p bigint, cd_perfil_p bigint, nm_usuario_p text, ie_inserindo_dil_p text, ie_acao_executada_p bigint, ds_msg_control_medic_p INOUT text, cd_msg_via_sonda_p INOUT bigint, cd_material_subs_p INOUT bigint, ds_material_subs_p INOUT text, ds_msg_mat_p INOUT text, cd_pessoa_fisica_p text, qt_peso_p bigint, ie_se_necessario_p text, cd_intervalo_p text, nr_dia_util_p bigint) AS $body$
DECLARE

 
ie_mensagem_sonda_w			char(1);
ie_dieta_prescr_w			char(1);
ie_via_sonda_w				char(1);
ie_agrupador_w				prescr_material.ie_agrupador%type;


BEGIN 
 
qt_material_p				:= 0;
qt_limite_pessoa_p			:= 0;
ie_obriga_just_dose_p		:= 'N';
ie_material_padronizado_p	:= 'S';
ds_observacao_via_p			:= '';
 
select	count(*) 
into STRICT	qt_material_p 
from	prescr_material 
where	nr_prescricao 	= nr_prescricao_p 
and		cd_material 	= cd_material_p 
and		nr_sequencia 	<> nr_sequencia_p;
 
select 	max(ie_agrupador) 
into STRICT	ie_agrupador_w 
from	prescr_material 
where	nr_prescricao = nr_prescricao_p 
and		cd_material = cd_material_p 
and		nr_sequencia = nr_sequencia_p;
 
if (ie_via_aplicacao_p IS NOT NULL AND ie_via_aplicacao_p::text <> '') then 
	ds_observacao_via_p			:= obter_dados_via_aplicacao(cd_material_p,ie_via_aplicacao_p,cd_setor_atendimento_p,'R');
end if;
 
ie_obriga_jusificativa_p	:= obter_se_exige_just_material(cd_material_p,cd_setor_atendimento_p,cd_estabelecimento_p, ie_via_aplicacao_p, nr_prescricao_p, cd_intervalo_p, ie_se_necessario_p, ie_agrupador_w);
ie_material_padronizado_p	:= obter_se_material_padronizado(cd_estabelecimento_p,cd_material_p);
ie_classif_custo_p			:= obter_dados_material_estab(cd_material_p,cd_estabelecimento_p,'CU');
 
select	coalesce(max(ie_obriga_just_dose), 'N') ie_obriga_just_dose, 
		coalesce(obter_dados_medic_atb_var(max(cd_material),cd_estabelecimento_p,max(ie_justificativa_padrao),'JP',null,null,null), 'N') ie_justificativa_padrao, 
		coalesce(max(qt_limite_pessoa),0) qt_limite_pessoa, 
		coalesce(max(ie_mensagem_sonda),'N'), 
		max(ds_mensagem) 
into STRICT	ie_obriga_just_dose_p, 
		ie_justificativa_padrao_p, 
		qt_limite_pessoa_p, 
		ie_mensagem_sonda_w, 
		ds_msg_mat_p 
from	material 
where	cd_material = cd_material_p;		
 
if (coalesce(ie_inserindo_dil_p,'N') <> 'S') then 
 
	if (nr_dia_util_p > 0) and (ie_acao_executada_p != 3) then 
		ds_msg_control_medic_p	:= obter_msg_control_medic(nr_dia_util_p, cd_material_p, cd_pessoa_fisica_p, null);	
	end if;
	 
	if (ie_mensagem_sonda_w = 'S') then 
		select	coalesce(max(ie_via_sonda),'N') 
		into STRICT	ie_via_sonda_w 
		from	via_aplicacao 
		where	ie_via_aplicacao = ie_via_aplicacao_p;
		 
		if (ie_via_sonda_w = 'S') then 
			-- Este medicamento não deve ser administrado via sonda! 
			cd_msg_via_sonda_p	:= 192955;
		else 
			select	coalesce(max('S'),'N') ie_dieta 
			into STRICT	ie_dieta_prescr_w 
			from	prescr_dieta a, 
					dieta b where		a.nr_prescricao = nr_prescricao_p 
			and		a.cd_dieta = b.cd_dieta 
			and		b.ie_tipo_dieta = 'E' LIMIT 1;
			 
			if (ie_dieta_prescr_w = 'S') then 
				select	max(cd_material_subs) 
				into STRICT	cd_material_subs_p 
				from	material 
				where	cd_material = cd_material_p;
				 
				if (cd_material_subs_p IS NOT NULL AND cd_material_subs_p::text <> '') then 
					ds_material_subs_p	:=	obter_desc_material(cd_material_subs_p);
					-- Existe uma dieta enteral nesta prescrição! Este medicamento não deve ser administrado via sonda. 
					-- Sugestão para substituição: Med. #@DS_MATERIAL#@ (Cód. #@CD_MATERIAL#@). 
					cd_msg_via_sonda_p	:= 192956;
				else 
					-- Existe uma dieta enteral nesta prescrição! Este medicamento não deve ser administrado via sonda. 
					cd_msg_via_sonda_p	:= 194660;
				end if;
			end if;
		end if;
	end if;
end if;
 
if (ie_acao_executada_p <> 1) then 
	ds_msg_mat_p	:= '';
elsif (coalesce(ds_msg_mat_p::text, '') = '') then 
	ds_msg_mat_p	:= obter_padrao_param_prescr(	nr_atendimento_p, 
													cd_material_p, 
													ie_via_aplicacao_p, 
													cd_setor_atendimento_p, 
													cd_pessoa_fisica_p, 
													obter_idade_pf(cd_pessoa_fisica_p, clock_timestamp(), 'A'), 
													qt_peso_p, 
													ie_se_necessario_p, 
													'M', 
													cd_intervalo_p);
end if;
 
select	max(nr_dias_lib) 
into STRICT	nr_dias_lib_p 
from	rep_controle_atb 
where	nr_sequencia = (SELECT	max(nr_sequencia) 
						from	rep_controle_atb 
						where	nr_atendimento 	= nr_atendimento_p 
						and 	cd_material	= cd_material_p);
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE prescr_mat_beforepost ( nr_prescricao_p bigint, cd_material_p bigint, nr_sequencia_p bigint, ie_via_aplicacao_p text, cd_setor_atendimento_p bigint, nr_atendimento_p bigint, qt_material_p INOUT bigint, ds_observacao_via_p INOUT text, ie_obriga_jusificativa_p INOUT text, ie_material_padronizado_p INOUT text, ie_classif_custo_p INOUT text, ie_obriga_just_dose_p INOUT text, ie_justificativa_padrao_p INOUT text, qt_limite_pessoa_p INOUT bigint, nr_dias_lib_p INOUT bigint, ds_pergunta_p INOUT text, cd_estabelecimento_p bigint, cd_perfil_p bigint, nm_usuario_p text, ie_inserindo_dil_p text, ie_acao_executada_p bigint, ds_msg_control_medic_p INOUT text, cd_msg_via_sonda_p INOUT bigint, cd_material_subs_p INOUT bigint, ds_material_subs_p INOUT text, ds_msg_mat_p INOUT text, cd_pessoa_fisica_p text, qt_peso_p bigint, ie_se_necessario_p text, cd_intervalo_p text, nr_dia_util_p bigint) FROM PUBLIC;

