-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_lib_bloqueio_telefone ( cd_estabelecimento_p bigint, nr_atendimento_p bigint, nm_usuario_p text, cd_setor_atendimento_p bigint, cd_unidade_basica_p text, cd_unidade_compl_p text, ie_codigo_bloq_lib_p bigint) AS $body$
DECLARE


/*Fixo para Liberação do telefone
ie_codigo_bloq_lib_p
10 = Liberação
12 = Bloqueio */
nr_seq_evento_w			bigint;
nr_ramal_w			integer;
cd_setor_atendimento_w		integer;
cd_unidade_basica_w		varchar(10);
cd_unidade_compl_w		varchar(10);
qt_existe_tel_w			smallint;
ds_observacao_w			varchar(255);
nm_paciente_w			varchar(100);


BEGIN
select	count(*)
into STRICT	qt_existe_tel_w
from	atend_lanc_auto
where	nr_seq_evento = 92
and	nr_atendimento = nr_atendimento_p;
if (qt_existe_tel_w > 0) then
	begin
	cd_setor_atendimento_w		:= cd_setor_atendimento_p;
	cd_unidade_basica_w		:= cd_unidade_basica_p;
	cd_unidade_compl_w		:= cd_unidade_compl_p;

	if (coalesce(cd_setor_atendimento_p::text, '') = '') or (cd_setor_atendimento_p = 0) then
		select	cd_setor_atendimento,
			cd_unidade_basica,
			cd_unidade_compl
		into STRICT	cd_setor_atendimento_w,
			cd_unidade_basica_w,
			cd_unidade_compl_w
		from	atend_paciente_unidade
		where	nr_seq_interno	= obter_atepacu_paciente(nr_atendimento_p, 'A');
	end if;

	select	coalesce(max(nr_ramal),0)
	into STRICT	nr_ramal_w
	from	unidade_atendimento
	where	cd_setor_atendimento	= cd_setor_atendimento_w
	and	cd_unidade_basica	= cd_unidade_basica_w
	and	cd_unidade_compl	= cd_unidade_compl_w;

	if (nr_ramal_w <> 0) then
		begin
		select	substr(obter_pessoa_atendimento(nr_atendimento_p, 'N'),1,100)
		into STRICT	nm_paciente_w
		;
		ds_observacao_w	:= wheb_mensagem_pck.get_texto(307853,	'NR_ATENDIMENTO_W=' || nr_atendimento_p || ';' ||
																'NM_PACIENTE_W=' || nm_paciente_w);
						-- Atendimento: #@NR_ATENDIMENTO_W#@ Paciente: #@NM_PACIENTE_W#@
		insert into tel_reg_evento(
			nr_sequencia,
			cd_estabelecimento,
			dt_atualizacao,
			nm_usuario,
			dt_evento,
			nr_ramal,
			cd_evento,
			nr_seq_evento,
			nr_seq_acao,
			cd_setor_atendimento,
			cd_unidade_basica,
			cd_unidade_compl,
			ds_observacao,
			IE_PROCESSADO)
		values (	nextval('tel_reg_evento_seq'),
			cd_estabelecimento_p,
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			nr_ramal_w,
			0,
			ie_codigo_bloq_lib_p,
			16, /*Fixo para Registro de Liberação/ Bloqueios de telefone*/
			cd_setor_atendimento_w,
			cd_unidade_basica_w,
			cd_unidade_compl_w,
			substr(ds_observacao_w,1,255),
			0);
		end;
	end if;
	end;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_lib_bloqueio_telefone ( cd_estabelecimento_p bigint, nr_atendimento_p bigint, nm_usuario_p text, cd_setor_atendimento_p bigint, cd_unidade_basica_p text, cd_unidade_compl_p text, ie_codigo_bloq_lib_p bigint) FROM PUBLIC;

