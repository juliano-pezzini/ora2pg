-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE obter_vl_trib_deferido ( NR_INTERNO_CONTA_P CONTA_PACIENTE_RESUMO.NR_INTERNO_CONTA%TYPE, RECORDSET_P INOUT REFCURSOR, IE_PROC_MATERIAL_P text, CD_MATERIAL_P CONTA_PACIENTE_RESUMO_IMP.CD_MATERIAL%TYPE, CD_PROCEDIMENTO_P CONTA_PACIENTE_RESUMO_IMP.CD_PROCEDIMENTO%TYPE ) AS $body$
BEGIN

OPEN RECORDSET_P FOR
SELECT
	A.VL_IMPOSTO			AS VL_IMPOSTO,
	B.CD_CONTA_CONTABIL		AS CD_CONTA_CONTABIL
FROM CONTA_PACIENTE_RESUMO_IMP A,
		TRIBUTO_REGRA_DEFERIDO B
WHERE
	A.CD_TRIBUTO = B.CD_TRIBUTO
	AND B.NR_SEQUENCIA IN (
		SELECT COALESCE(
			(SELECT C.NR_SEQUENCIA FROM TRIBUTO_REGRA_DEFERIDO C
                WHERE c.CD_CONVENIO_PARAMETRO = a.CD_CONVENIO_PARAMETRO AND c.CD_TRIBUTO = a.CD_TRIBUTO and c.IE_CONTAB_PROV_RECEITAS = 'S'),
			(SELECT d.NR_SEQUENCIA FROM TRIBUTO_REGRA_DEFERIDO D 
                WHERE coalesce(d.CD_CONVENIO_PARAMETRO::text, '') = '' AND d.CD_TRIBUTO = A.CD_TRIBUTO and d.IE_CONTAB_PROV_RECEITAS = 'S')
		) 
	)
	AND A.NR_INTERNO_CONTA = NR_INTERNO_CONTA_P
	AND (
		(IE_PROC_MATERIAL_P = 'M' AND A.CD_MATERIAL = CD_MATERIAL_P)
		OR (IE_PROC_MATERIAL_P = 'P' AND A.CD_PROCEDIMENTO = CD_PROCEDIMENTO_P)
	);

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE obter_vl_trib_deferido ( NR_INTERNO_CONTA_P CONTA_PACIENTE_RESUMO.NR_INTERNO_CONTA%TYPE, RECORDSET_P INOUT REFCURSOR, IE_PROC_MATERIAL_P text, CD_MATERIAL_P CONTA_PACIENTE_RESUMO_IMP.CD_MATERIAL%TYPE, CD_PROCEDIMENTO_P CONTA_PACIENTE_RESUMO_IMP.CD_PROCEDIMENTO%TYPE ) FROM PUBLIC;

