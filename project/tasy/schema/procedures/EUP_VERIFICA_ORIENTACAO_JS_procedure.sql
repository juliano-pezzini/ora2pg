-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE eup_verifica_orientacao_js ( nr_atendimento_p bigint, cd_convenio_p bigint, ie_origem_proced_p bigint, cd_procedimento_p bigint, cd_material_exame_p text, ie_mostra_obs_tecnica_p text, nr_seq_exame_p bigint, nr_prescricao_p bigint, ie_orien_formatada_p text, nr_seq_proc_interno_p bigint, nm_usuario_p text, ds_orientacao_p INOUT text, ie_orientacao_eup_p INOUT text) AS $body$
DECLARE

nr_seq_orientacao_w			bigint;
ds_orientacao_w				text			:= '';	
ds_orientacao_usuario_w		varchar(4000) 	:= '';		
ie_orientacao_eup_w			varchar(1) 	:= 'S';
c01 CURSOR FOR
	SELECT	nr_sequencia 
	from 	proc_interno_orientacao 
	where 	nr_seq_proc_interno = nr_seq_proc_interno_p 
	and 	ie_tipo_orientacao = 'C';

BEGIN
if (ie_orien_formatada_p = 'S') then 
		open c01;
		loop 
		fetch c01 into nr_seq_orientacao_w;
		EXIT WHEN NOT FOUND; /* apply on c01 */
		begin 
				select	ds_orientacao 
				into STRICT	ds_orientacao_w 
				from 	proc_interno_orientacao 
				where 	nr_sequencia = nr_seq_orientacao_w;
				ds_orientacao_p	:= ds_orientacao_p || ' ' || ds_orientacao_w;
		end;
		end loop;
		close c01;
			goto final;
else 
	if (coalesce(nr_seq_exame_p,0) > 0) then 
		ds_orientacao_w := substr(obter_orientacao_exame_id_sexo(nr_seq_exame_p, nr_prescricao_p, wheb_usuario_pck.get_cd_estabelecimento, ie_mostra_obs_tecnica_p, null, null, null),1,2000);		
		ds_orientacao_w := ds_orientacao_w || substr(obter_orientacao_exame_id_sexo(nr_seq_exame_p, nr_prescricao_p, wheb_usuario_pck.get_cd_estabelecimento, ie_mostra_obs_tecnica_p, null, null, null),2001,4000);		
		ds_orientacao_w := ds_orientacao_w || substr(obter_orientacao_exame_id_sexo(nr_seq_exame_p, nr_prescricao_p, wheb_usuario_pck.get_cd_estabelecimento, 'N','N','S', null),1,2000);		
		ds_orientacao_usuario_w := substr(obter_orientacao_exame_id_sexo(nr_seq_exame_p, nr_prescricao_p, wheb_usuario_pck.get_cd_estabelecimento,'N', 'S','N','N'),1,4000);		
		if (coalesce(ds_orientacao_w::text, '') = '') then			 
			ds_orientacao_w := substr(obter_orientacao_exame(nr_seq_exame_p, cd_material_exame_p, ie_mostra_obs_tecnica_p),1,2000);			
			ds_orientacao_w := ds_orientacao_w || substr(obter_orientacao_exame(nr_seq_exame_p, cd_material_exame_p, ie_mostra_obs_tecnica_p),2001,4000);
		end if;
		if (ds_orientacao_usuario_w IS NOT NULL AND ds_orientacao_usuario_w::text <> '') then			 
			ds_orientacao_w := substr(ds_orientacao_w || ds_orientacao_usuario_w,1,4000);			
		end if;
	else 
		ds_orientacao_w := substr(Obter_Orientacao_Proc(cd_procedimento_p, ie_origem_proced_p, cd_convenio_p, nr_seq_proc_interno_p, nr_atendimento_p, 0),1,4000);
	end if;	
	 
	select (coalesce(max(ie_orientacao_eup),'S')) 
	into STRICT	ie_orientacao_eup_w 
	from	exame_laboratorio 
	where 	nr_seq_exame = nr_seq_exame_p;
 
end if;
ie_orientacao_eup_p := ie_orientacao_eup_w;
ds_orientacao_p := ds_orientacao_w;
<<final>> 
commit;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eup_verifica_orientacao_js ( nr_atendimento_p bigint, cd_convenio_p bigint, ie_origem_proced_p bigint, cd_procedimento_p bigint, cd_material_exame_p text, ie_mostra_obs_tecnica_p text, nr_seq_exame_p bigint, nr_prescricao_p bigint, ie_orien_formatada_p text, nr_seq_proc_interno_p bigint, nm_usuario_p text, ds_orientacao_p INOUT text, ie_orientacao_eup_p INOUT text) FROM PUBLIC;

