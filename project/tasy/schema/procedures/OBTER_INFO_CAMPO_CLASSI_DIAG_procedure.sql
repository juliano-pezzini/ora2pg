-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE obter_info_campo_classi_diag ( nr_atendimento_p bigint, ds_atributo_p text, cd_perfil_p bigint, ie_marcar_aut_p INOUT text, ie_edita_grid_p INOUT text, ie_visivel_p INOUT text, ds_label_p INOUT text, ds_grid_p INOUT text, nr_apresent_p INOUT bigint) AS $body$
DECLARE


ds_atrib_dominio_w				classificacao_diagnostico.ie_classificacao_diagnostico%type;
nr_seq_tipo_episodio_w        	restricao_diagnostico.nr_seq_tipo_episodio%type;
nr_seq_tipo_admi_fat_w        	restricao_diagnostico.nr_seq_tipo_admissao_fat%type;
ie_regra_w						varchar(1);


BEGIN

	if (ds_atributo_p = 'IE_DIAG_PRINC_EPISODIO') then
	    	ds_atrib_dominio_w := 'DPE';
	elsif (ds_atributo_P = 'IE_DIAG_REFERENCIA') then
		ds_atrib_dominio_w := 'UBE';
	elsif (ds_atributo_P = 'IE_DIAG_TRATAMENTO') then
		ds_atrib_dominio_w := 'BEH';
	elsif (ds_atributo_P = 'IE_DIAG_ADMISSAO') then
		ds_atrib_dominio_w := 'AUF';
	elsif (ds_atributo_P = 'IE_DIAG_ALTA') then
		ds_atrib_dominio_w := 'ENT';
	elsif (ds_atributo_P = 'IE_DIAG_CIRURGIA') then
		ds_atrib_dominio_w := 'OPD';
	elsif (ds_atributo_P = 'IE_DIAG_OBITO') then
		ds_atrib_dominio_w := 'TOD';
	elsif (ds_atributo_P = 'IE_DIAG_PRE_CIR') then
		ds_atrib_dominio_w := 'POD';
	elsif (ds_atributo_P = 'IE_DIAG_PRINC_DEPART') then
		ds_atrib_dominio_w := 'FAC';
	elsif (ds_atributo_P = 'IE_DIAG_TRAT_CERT') then
		ds_atrib_dominio_w := 'BHS';
	elsif (ds_atributo_P = 'IE_DIAG_CRONICO') then
		ds_atrib_dominio_w := 'FAL';
	elsif (ds_atributo_P = 'IE_DIAG_TRAT_ESPECIAL') then
		ds_atrib_dominio_w := 'ASV';		
	end if;
	
	select  	max(ds_curta),
		max(ds_curta_grid),
		coalesce(max(ie_valor_padrao), 'N'),
		coalesce(max(ie_permite_edicao_grid), 'S'),
		max(nr_seq_apresentacao)
	into STRICT	ds_label_p,
		ds_grid_p,
		ie_marcar_aut_p,
		ie_edita_grid_p,
		nr_apresent_p
	from    classificacao_diagnostico
	where   ie_classificacao_diagnostico = ds_atrib_dominio_w;
	
	if (ds_atributo_P = 'IE_RELEVANTE_DRG') then
		select  	obter_desc_expressao(953921),
			obter_desc_expressao(953921),
			'S',
			'S',
			25
		into STRICT	ds_label_p,
			ds_grid_p,
			ie_marcar_aut_p,
			ie_edita_grid_p,
			nr_apresent_p
		;
	end if;
	
	ie_visivel_p := 'S';
	
	select  coalesce(max(nr_seq_tipo_admissao_fat),0)
	into STRICT    nr_seq_tipo_admi_fat_w
	from    atendimento_paciente
	where   nr_atendimento = nr_atendimento_p;

	select  coalesce(max(nr_seq_tipo_episodio),0)
	into STRICT    nr_seq_tipo_episodio_w
	from    episodio_paciente
	where   nr_sequencia = obter_episodio_atendimento(nr_atendimento_p);
	
	select  case count(*) when 0 then 'N' else 'S' end
	into STRICT	ie_regra_w
	from    classificacao_diagnostico a ,
			restricao_diagnostico b
	where   b.nr_seq_classificacao   = a.nr_sequencia
	and     a.ie_classificacao_diagnostico = ds_atrib_dominio_w;
	
	if (ie_regra_w = 'S') then
	
		select  	coalesce(max('S'),'N')
		into STRICT	ie_visivel_p
		from    	classificacao_diagnostico a ,
			restricao_diagnostico b
		where   	b.nr_seq_classificacao   = a.nr_sequencia
		and     	a.ie_classificacao_diagnostico = ds_atrib_dominio_w
		and	((coalesce(b.cd_perfil::text, '') = '') or (b.cd_perfil = cd_perfil_p))
		and	((coalesce(b.nr_seq_tipo_episodio,0) = 0) or (b.nr_seq_tipo_episodio = nr_seq_tipo_episodio_w))
		and	((coalesce(b.nr_seq_tipo_admissao_fat,0) = 0) or (b.nr_seq_tipo_admissao_fat = nr_seq_tipo_admi_fat_w));

	else
		ie_visivel_p := 'S';
	end if;


end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE obter_info_campo_classi_diag ( nr_atendimento_p bigint, ds_atributo_p text, cd_perfil_p bigint, ie_marcar_aut_p INOUT text, ie_edita_grid_p INOUT text, ie_visivel_p INOUT text, ds_label_p INOUT text, ds_grid_p INOUT text, nr_apresent_p INOUT bigint) FROM PUBLIC;

