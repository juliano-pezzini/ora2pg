-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_proc_pac_medico_exame ( nr_seq_procedimento_p procedimento_pac_executado.nr_seq_procedimento%type, nr_seq_proc_int_exec_p procedimento_pac_executado.nr_seq_proc_int_exec%type, nm_usuario_p usuario.nm_usuario%type) AS $body$
DECLARE


ie_situacao_w			constant varchar(1) := 'A';

cd_procedimento_w		proc_interno.cd_procedimento%type;
ie_origem_proced_w		proc_interno.ie_origem_proced%type;

nr_prescricao_w			prescr_medica.nr_prescricao%type;

nr_seq_prescr_proc_w	prescr_procedimento.nr_sequencia%type;
ie_lado_w				prescr_procedimento.ie_lado%type;
qt_procedimento_w		prescr_procedimento.qt_procedimento%type;

nr_atendimento_w		atendimento_paciente.nr_atendimento%type;

cd_setor_atendimento_w	setor_atendimento.cd_setor_atendimento%type;

nr_seq_propacmed_w		procedimento_pac_medico.nr_sequencia%type;
cd_departamento_w		procedimento_pac_medico.cd_departamento%type;

nr_seq_propaci_w		procedimento_paciente.nr_sequencia%type;


BEGIN

	if (coalesce(nr_seq_procedimento_p, 0) <> 0) then
		
		select	max(pm.nr_atendimento),
				max(pm.nr_prescricao),
				max(pp.nr_sequencia),
				max(pp.ie_lado),
				max(pp.qt_procedimento)
		into STRICT	nr_atendimento_w,
				nr_prescricao_w,
				nr_seq_prescr_proc_w,
				ie_lado_w,
				qt_procedimento_w
		from	prescr_procedimento pp,
				prescr_medica pm
		where	pm.nr_prescricao = pp.nr_prescricao
		and		pp.nr_seq_interno = nr_seq_procedimento_p;
		
		select	obter_setor_atendimento(nr_atendimento_w)
		into STRICT	cd_setor_atendimento_w
		;
		
		select	obter_departamento_setor(cd_setor_atendimento_w)
		into STRICT	cd_departamento_w
		;
		
		select	nextval('procedimento_pac_medico_seq')
		into STRICT	nr_seq_propacmed_w
		;
		
		select	max(cd_procedimento),
			max(ie_origem_proced)
		into STRICT	cd_procedimento_w,
			ie_origem_proced_w
		from	proc_interno
		where	nr_sequencia = nr_seq_proc_int_exec_p;
		
		insert into procedimento_pac_medico(
			nr_sequencia,
			dt_atualizacao, 
			nm_usuario, 
			dt_atualizacao_nrec, 
			nm_usuario_nrec, 
			ie_situacao, 
			nr_atendimento, 
			nr_seq_episodio,
			cd_setor_atendimento, 
			cd_procedimento, 
			dt_procedimento, 
			ie_lado,
			ie_origem_proced, 
			nr_seq_proc_interno,
			qt_procedimento,
			cd_departamento
		) values (
			nr_seq_propacmed_w,
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			ie_situacao_w,
			nr_atendimento_w,
			obter_episodio_atendimento(nr_atendimento_w),
			cd_setor_atendimento_w,
			cd_procedimento_w,
			clock_timestamp(),
			ie_lado_w,
			ie_origem_proced_w,
			nr_seq_proc_int_exec_p,
			qt_procedimento_w,
			cd_departamento_w
		);
		
		CALL liberar_proc_pac_medic(
			nr_seq_proc_pac_med_p => nr_seq_propacmed_w,
			nm_usuario_p => nm_usuario_p
			);
		
		commit;
		
		select	max(nr_seq_propaci)
		into STRICT	nr_seq_propaci_w
		from	procedimento_pac_medico
		where	nr_sequencia = nr_seq_propacmed_w;
		
		if (nr_seq_propaci_w IS NOT NULL AND nr_seq_propaci_w::text <> '') then
			update	procedimento_paciente
			set	nr_prescricao			= nr_prescricao_w,
				nr_sequencia_prescricao	= nr_seq_prescr_proc_w	
			where	nr_sequencia		= nr_seq_propaci_w;
		end if;
		
		update	prescr_procedimento
		set	dt_baixa		= clock_timestamp(),
			cd_motivo_baixa	= 1,
			dt_atualizacao	= clock_timestamp(),
			nm_usuario_baixa	= nm_usuario_p,
			ie_status_execucao	= '20'
		where 	nr_seq_interno	= nr_seq_procedimento_p;

	end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_proc_pac_medico_exame ( nr_seq_procedimento_p procedimento_pac_executado.nr_seq_procedimento%type, nr_seq_proc_int_exec_p procedimento_pac_executado.nr_seq_proc_int_exec%type, nm_usuario_p usuario.nm_usuario%type) FROM PUBLIC;

