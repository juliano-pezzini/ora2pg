-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE obstet_nascimento_newrecord ( ie_parto_selected_p text, ie_nascimento_selected_p text, ie_sala_parto_selected_p text, atend_parto_p text, ie_historia_atual_selected_p text, ie_consiste_nascidos_p text, ie_exige_hist_pregressa_p text, nr_atendimento_p bigint,		--nr_atendimento do WPaciente 
 nr_atendimento_wdbp_p bigint,		--nr_atendimento do WDBPanel 
 nr_sequencia_wdbp_p INOUT bigint 	--nr_sequencia do WDBPanel 
 ) AS $body$
DECLARE

		 
qt_atendimento_paciente_w	bigint := 0;
qt_nascidos_w		bigint := 0;
nr_nova_seq_atendimento_w	bigint := 0;
		

BEGIN 
 
if (ie_parto_selected_p = 'S') and (ie_nascimento_selected_p = 'S') then 
	begin 
	if (atend_parto_p IS NOT NULL AND atend_parto_p::text <> '') and (nr_atendimento_p IS NOT NULL AND nr_atendimento_p::text <> '') then 
		begin 
		select	count(*) 
		into STRICT	qt_atendimento_paciente_w 
		from	atendimento_paciente 
		where	nr_atendimento = nr_atendimento_p 
		and	ie_tipo_atendimento in (atend_parto_p);
		 
		if (qt_atendimento_paciente_w > 0) then 
			begin 
			--42078 - Não é permitido realizar lançamentos sobre partos/nascimentos para este tipo de atendimento. Parâmetro[348]. 
			CALL Wheb_mensagem_pck.exibir_mensagem_abort(42078);
			end;
		end if;
		end;
	end if;
	end;
end if;
 
if (ie_nascimento_selected_p = 'S') and (ie_sala_parto_selected_p = 'S') and (nr_atendimento_wdbp_p IS NOT NULL AND nr_atendimento_wdbp_p::text <> '') then 
	begin 
	if (ie_consiste_nascidos_p = 'S') then 
		begin 
		select	coalesce(sum(coalesce(qt_nasc_mortos,0) + coalesce(qt_nasc_vivos,0)),0) 
		into STRICT 	qt_nascidos_w 
		from	parto 
		where	nr_atendimento = nr_atendimento_p;
		end;
		 
		if (qt_nascidos_w = 0) then 
			begin 
			if (Obter_Funcao_Ativa = 872) then 
			  --295506 - É necessário informar a quantidade de nascidos na pasta Parto, subaba História do Parto. Parâmetro [512]. 
      			  CALL Wheb_mensagem_pck.exibir_mensagem_abort(295506);
			else 
			 --42086 - É necessário informar a quantidade de nascidos na pasta Parto, subaba História do Parto. Parâmetro [502]. 
			 CALL Wheb_mensagem_pck.exibir_mensagem_abort(42086);
			end if;
			end;
		end if;
		 
	end if;
	 
	if (coalesce(nr_sequencia_wdbp_p::text, '') = '') then 
		begin 
		select	coalesce(max(nr_sequencia),0) +1 
		into STRICT 	nr_nova_seq_atendimento_w 
		from	nascimento 
		where	nr_atendimento = nr_atendimento_wdbp_p;
		end;
	end if;
	end;
end if;
 
if (ie_parto_selected_p = 'S') and (ie_historia_atual_selected_p = 'S') and (ie_exige_hist_pregressa_p = 'S') and (nr_atendimento_wdbp_p IS NOT NULL AND nr_atendimento_wdbp_p::text <> '') then 
	begin 
	--42089 - É necessário cadastrar a História pregressa antes de informar a História do parto. Parâmetro [524]. 
	CALL Wheb_mensagem_pck.exibir_mensagem_abort(42089);
	end;
end if;
 
nr_sequencia_wdbp_p := nr_nova_seq_atendimento_w;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE obstet_nascimento_newrecord ( ie_parto_selected_p text, ie_nascimento_selected_p text, ie_sala_parto_selected_p text, atend_parto_p text, ie_historia_atual_selected_p text, ie_consiste_nascidos_p text, ie_exige_hist_pregressa_p text, nr_atendimento_p bigint, nr_atendimento_wdbp_p bigint, nr_sequencia_wdbp_p INOUT bigint  ) FROM PUBLIC;

