-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE prescr_medica_newrecord_eup ( NM_USUARIO_P text, CD_CONVENIO_P bigint, NR_ATENDIMENTO_P text, IE_TIPO_ATENDIMENTO_P bigint, DS_ERRO_P INOUT text, CD_PESSOA_RESPONSAVEL_P text, CD_PESSOA_FISICA_P text, IE_EXIGE_CPF_PACIENTE_P INOUT text, DS_MSG_P INOUT text, QT_PRESCR_MEDICA_P INOUT bigint, DS_MSG_ERRO_P INOUT text, NR_ATENDIMENTO_PAC_P text, NR_SEQ_AGENDA_P text, CD_TIPO_AGENDA_P bigint, CD_SETOR_USUARIO_P bigint, NR_ATENDIMENTO_PRESCR_P text, CD_SETOR_ATENDIMENTO_P bigint, DT_PRESCRICAO_P timestamp, NR_CONTROLE_P INOUT bigint, NR_SEQUENCIA_P INOUT bigint, QT_PESO_P INOUT bigint, QT_ALTURA_CM_P INOUT bigint, CD_SETOR_ENTREGA_P INOUT bigint, CD_SETOR_ATEND_P INOUT bigint, CD_SETOR_AGENDA_SERVICO_P INOUT text, DS_MSG_AVISO_P INOUT text, DT_PRIMEIRO_HORARIO_P INOUT timestamp, NM_COMPUTADOR_P text, CD_SETOR_ATEN_COMP_P INOUT bigint, NR_SEQ_FORMA_LAUDO_P INOUT text) AS $body$
DECLARE

 
IE_BLOQ_ATEND_ESTRANG_W		varchar(1);	
CD_ESTABELECIMENTO_W 		smallint;
IE_OBTER_SE_CONV_EXIGE_CPF_W 	varchar(1);
IE_EXIG_CPF_CONVENIO_W		varchar(1);
CD_IDADE_PF_W			smallint;
CD_PESSOA_FISICA_W		varchar(50);
DS_OBTER_COMPL_PF_W		varchar(255);
IE_BRASILEIRO_W			varchar(1) := 'N';
IE_OBTER_EXIG_CPF_CONVENIO_W	varchar(1);
IE_SOMENTE_PRI_PRESCRICAO_W	varchar(1);
IE_NR_MIN_PRESCR_ALTA_W		bigint;
IE_GERAR_PRESCR_CONTA_DEF_W	varchar(1);
IE_ATUALIZA_SETOR_ENTR_W	varchar(1);
IE_BUSCA_ENTREGA_LAUDO_W	varchar(1);


BEGIN 
CD_ESTABELECIMENTO_W := WHEB_USUARIO_PCK.GET_CD_ESTABELECIMENTO;
IE_BLOQ_ATEND_ESTRANG_W  := OBTER_PARAM_USUARIO(916, 665, OBTER_PERFIL_ATIVO, NM_USUARIO_P, CD_ESTABELECIMENTO_W, IE_BLOQ_ATEND_ESTRANG_W );
IE_EXIG_CPF_CONVENIO_W  := OBTER_PARAM_USUARIO(916, 501, OBTER_PERFIL_ATIVO, NM_USUARIO_P, CD_ESTABELECIMENTO_W, IE_EXIG_CPF_CONVENIO_W );
IE_SOMENTE_PRI_PRESCRICAO_W := OBTER_PARAM_USUARIO(916, 818, OBTER_PERFIL_ATIVO, NM_USUARIO_P, CD_ESTABELECIMENTO_W, IE_SOMENTE_PRI_PRESCRICAO_W);
IE_NR_MIN_PRESCR_ALTA_W := OBTER_PARAM_USUARIO(916, 123, OBTER_PERFIL_ATIVO, NM_USUARIO_P, CD_ESTABELECIMENTO_W, IE_NR_MIN_PRESCR_ALTA_W);
IE_GERAR_PRESCR_CONTA_DEF_W := OBTER_PARAM_USUARIO(916, 384, OBTER_PERFIL_ATIVO, NM_USUARIO_P, CD_ESTABELECIMENTO_W, IE_GERAR_PRESCR_CONTA_DEF_W);
IE_ATUALIZA_SETOR_ENTR_W := OBTER_PARAM_USUARIO(916, 270, OBTER_PERFIL_ATIVO, NM_USUARIO_P, CD_ESTABELECIMENTO_W, IE_ATUALIZA_SETOR_ENTR_W);
IE_BUSCA_ENTREGA_LAUDO_W := OBTER_PARAM_USUARIO(916, 750, OBTER_PERFIL_ATIVO, NM_USUARIO_P, CD_ESTABELECIMENTO_W, IE_BUSCA_ENTREGA_LAUDO_W);
 
IF (IE_SOMENTE_PRI_PRESCRICAO_W = 'S') THEN 
	SELECT 	COUNT(*) QT_PRESCR_MEDICA 
	INTO STRICT	QT_PRESCR_MEDICA_P 
	FROM 	PRESCR_MEDICA 
	WHERE 	NR_ATENDIMENTO = NR_ATENDIMENTO_P 
	AND 	coalesce(DT_SUSPENSAO::text, '') = '';
ELSE 
	QT_PRESCR_MEDICA_P := 0;
END IF;	
 
SELECT 	IE_EXIGE_CPF_PACIENTE 
INTO STRICT 	IE_OBTER_SE_CONV_EXIGE_CPF_W 
FROM  	CONVENIO_ESTABELECIMENTO 
WHERE 	CD_CONVENIO = CD_CONVENIO_P   
AND	CD_ESTABELECIMENTO = CD_ESTABELECIMENTO_W;
 
 
IF ( IE_BLOQ_ATEND_ESTRANG_W = 'S') AND ( IE_OBTER_SE_CONV_EXIGE_CPF_W = 'S') THEN 
	DS_ERRO_P := VERIFICA_CPF_PF_ATENDIMENTO( NR_ATENDIMENTO_P, CD_CONVENIO_P, IE_TIPO_ATENDIMENTO_P, DS_ERRO_P);
END IF;
 
 
IF ( IE_EXIG_CPF_CONVENIO_W = 'S') THEN 
	IE_OBTER_EXIG_CPF_CONVENIO_W:= 'N';
	CD_PESSOA_FISICA_W := CD_PESSOA_FISICA_P;
	SELECT 	OBTER_IDADE_PF(CD_PESSOA_FISICA_P, clock_timestamp(), 'A') IE_IDADE_PF 
	INTO STRICT	CD_IDADE_PF_W 
	;
	 
	IF (CD_IDADE_PF_W < 18) THEN 
		CD_PESSOA_FISICA_W := CD_PESSOA_RESPONSAVEL_P;
	END IF;
		SELECT 	trim(both coalesce(NR_CPF,OBTER_COMPL_PF(CD_PESSOA_FISICA_W,3,'C'))), 
			OBTER_SE_BRASILEIRO(CD_PESSOA_FISICA_W) 
		INTO STRICT	DS_OBTER_COMPL_PF_W,IE_BRASILEIRO_W 
		FROM  	PESSOA_FISICA 
		WHERE 	CD_PESSOA_FISICA = CD_PESSOA_FISICA_P;
		 
	IF (coalesce(DS_OBTER_COMPL_PF_W::text, '') = '') 
		AND (IE_BRASILEIRO_W = 'S') THEN 
		IE_OBTER_EXIG_CPF_CONVENIO_W := 'S';
	END IF;
	 
	IF (IE_OBTER_EXIG_CPF_CONVENIO_W = 'S') THEN 
		SELECT * FROM CONSISTIR_CPF_PAC_EUP_JS(CD_CONVENIO_P, CD_ESTABELECIMENTO_W, NR_ATENDIMENTO_P, IE_EXIGE_CPF_PACIENTE_P, DS_MSG_P) INTO STRICT IE_EXIGE_CPF_PACIENTE_P, DS_MSG_P;
	END IF;
END IF;
 
DS_MSG_ERRO_P := CONSISITIR_REGRA_PRESCRICAO_JS(NR_ATENDIMENTO_P, IE_NR_MIN_PRESCR_ALTA_W, IE_GERAR_PRESCR_CONTA_DEF_W, DS_MSG_ERRO_P);
SELECT * FROM OBTER_VALORES_PRESCR_MEDICA_JS(NR_ATENDIMENTO_PAC_P, NR_ATENDIMENTO_P, NR_SEQ_AGENDA_P, CD_TIPO_AGENDA_P, CD_SETOR_USUARIO_P, NR_ATENDIMENTO_PRESCR_P, CD_SETOR_ATENDIMENTO_P, DT_PRESCRICAO_P, NM_USUARIO_P, NR_CONTROLE_P, NR_SEQUENCIA_P, QT_PESO_P, QT_ALTURA_CM_P, CD_SETOR_ENTREGA_P, CD_SETOR_ATEND_P, CD_SETOR_AGENDA_SERVICO_P, DS_MSG_AVISO_P, DT_PRIMEIRO_HORARIO_P) INTO STRICT NR_CONTROLE_P, NR_SEQUENCIA_P, QT_PESO_P, QT_ALTURA_CM_P, CD_SETOR_ENTREGA_P, CD_SETOR_ATEND_P, CD_SETOR_AGENDA_SERVICO_P, DS_MSG_AVISO_P, DT_PRIMEIRO_HORARIO_P;
 
IF (IE_ATUALIZA_SETOR_ENTR_W = 'C')THEN 
	SELECT 	coalesce(MAX(CD_SETOR_ATENDIMENTO),0) CD_SETOR_ATENDIMENTO 
	INTO STRICT	CD_SETOR_ATEN_COMP_P 
	FROM 	COMPUTADOR 
	WHERE 	nm_computador_pesquisa = padronizar_nome(UPPER(NM_COMPUTADOR_P));
END IF;
 
IF (IE_BUSCA_ENTREGA_LAUDO_W = 'S')THEN 
	SELECT	coalesce(MAX(NR_SEQ_FORMA_LAUDO),0) NR_SEQ_FORMA_LAUDO 
	INTO STRICT	NR_SEQ_FORMA_LAUDO_P 
	FROM	ATENDIMENTO_PACIENTE 
	WHERE	NR_ATENDIMENTO = NR_ATENDIMENTO_P;
END IF;
--GRAVAR_LOG_LAB(81,NR_SEQ_FORMA_LAUDO_P,'SBHERKENHOFF'); 
COMMIT;
 
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE prescr_medica_newrecord_eup ( NM_USUARIO_P text, CD_CONVENIO_P bigint, NR_ATENDIMENTO_P text, IE_TIPO_ATENDIMENTO_P bigint, DS_ERRO_P INOUT text, CD_PESSOA_RESPONSAVEL_P text, CD_PESSOA_FISICA_P text, IE_EXIGE_CPF_PACIENTE_P INOUT text, DS_MSG_P INOUT text, QT_PRESCR_MEDICA_P INOUT bigint, DS_MSG_ERRO_P INOUT text, NR_ATENDIMENTO_PAC_P text, NR_SEQ_AGENDA_P text, CD_TIPO_AGENDA_P bigint, CD_SETOR_USUARIO_P bigint, NR_ATENDIMENTO_PRESCR_P text, CD_SETOR_ATENDIMENTO_P bigint, DT_PRESCRICAO_P timestamp, NR_CONTROLE_P INOUT bigint, NR_SEQUENCIA_P INOUT bigint, QT_PESO_P INOUT bigint, QT_ALTURA_CM_P INOUT bigint, CD_SETOR_ENTREGA_P INOUT bigint, CD_SETOR_ATEND_P INOUT bigint, CD_SETOR_AGENDA_SERVICO_P INOUT text, DS_MSG_AVISO_P INOUT text, DT_PRIMEIRO_HORARIO_P INOUT timestamp, NM_COMPUTADOR_P text, CD_SETOR_ATEN_COMP_P INOUT bigint, NR_SEQ_FORMA_LAUDO_P INOUT text) FROM PUBLIC;

