-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE schematic_gerar_sql_ativacao ( nr_seq_objeto_p objeto_schematic.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type) AS $body$
DECLARE



/* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Finalidade: Criar os parâmetros de ativação do componente selecionado
-------------------------------------------------------------------------------------------------------------------
Locais de chamada direta:
[  ]  Objetos do dicionário [ x] Tasy (Delphi/Java) [  ] Portal [  ]  Relatórios [ ] Outros:
 ------------------------------------------------------------------------------------------------------------------
Pontos de atenção:

++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */
nm_tabela_w			tabela_sistema.nm_tabela%type;
nm_tabela_superior_w		tabela_sistema.nm_tabela%type;
nr_seq_visao_w			tabela_visao.nr_sequencia%type;
ie_tipo_componente_w		objeto_schematic.ie_tipo_componente%type;
nr_seq_cham_externa_w		objeto_schematic.nr_seq_cham_externa%type;
ie_tipo_objeto_w		objeto_schematic.ie_tipo_objeto%type;

nm_atributo_w			varchar(100);
ds_sql_w			varchar(2000);
nr_seq_ativacao_w		bigint;
nr_seq_ativ_param_w		bigint;
nr_seq_obj_sup_ativ_w		bigint;
nr_seq_apres_w			bigint := 1;
ie_sequencia_criacao_w		bigint;
nm_parametro_w			varchar(30);
nm_atributo_ref_w		varchar(30);
qt_w				bigint;

c01 CURSOR FOR
	SELECT 	b.nm_atributo,
		b.ie_sequencia_criacao
	from 	integridade_atributo b,
		integridade_referencial a,
		tabela_Sistema t
	where 	a.nm_integridade_referencial 	= b.nm_integridade_referencial
	and 	a.nm_tabela 			= b.nm_tabela
	and 	a.nm_tabela 			= nm_tabela_w
	and 	t.nm_tabela 			= nm_tabela_w
	and 	a.nm_tabela_referencia 		= nm_tabela_superior_w
	and 	somente_numero(a.nm_integridade_referencial) = 0
	Order by ie_sequencia_criacao;

c02 CURSOR FOR
	SELECT	a.nr_sequencia,
		a.nm_parametro
	from	obj_schematic_ativ_param a
	where	a.nr_seq_objeto	= nr_seq_objeto_p;

--Select utilizado somente para carregar os parâmetros do WAE - Chamada externa
c03 CURSOR( nr_seq_chamada_externa_pc  funcao_chamada_ext_param.nr_sequencia%type ) FOR
	SELECT	b.nm_parametro,
		b.nr_seq_apres
	from	funcao_chamada_externa a,
		funcao_chamada_ext_param b
	where	b.nr_seq_cham_externa = a.nr_sequencia
	and	b.nr_seq_cham_externa = nr_seq_chamada_externa_pc
	order	by nr_seq_apres asc;

BEGIN

select	a.ie_tipo_componente,
	a.nr_seq_cham_externa,
	a.ie_tipo_objeto
into STRICT	ie_tipo_componente_w,
	nr_seq_cham_externa_w,
	ie_tipo_objeto_w
from	objeto_schematic a
where	a.nr_sequencia	= nr_seq_objeto_p;


--Carregamento dos parâmetros para o componente do DBPanel
if ( ie_tipo_componente_w = 'WDBP' ) then

	select	a.nm_tabela,
		a.nr_seq_visao,
		b.nm_tabela,
		a.nr_seq_obj_sup_ativ
	into STRICT	nm_tabela_w,
		nr_seq_visao_w,
		nm_tabela_superior_w,
		nr_seq_obj_sup_ativ_w
	from	objeto_schematic a,
		objeto_schematic b
	where	b.nr_sequencia	= a.nr_seq_obj_sup_ativ
	and	a.nr_sequencia	= nr_seq_objeto_p;

	ds_sql_w := null;

	select	nextval('tabela_sistema_ativacao_seq')
	into STRICT	nr_seq_ativacao_w
	;

	insert into tabela_sistema_ativacao(ds_sql, dt_atualizacao, dt_atualizacao_nrec,
		nm_tabela, nm_usuario, nm_usuario_nrec,
		nr_sequencia, nr_seq_visao)
	values (' ', clock_timestamp(), clock_timestamp(),
		nm_tabela_w, nm_usuario_p, nm_usuario_p,
		nr_seq_ativacao_w, nr_seq_visao_w);

	open C01;
	loop
	fetch C01 into
		nm_atributo_w,
		ie_sequencia_criacao_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin

		if (coalesce(ds_sql_w::text, '') = '') then
			ds_sql_w	:= ' and ' || nm_atributo_w || ' = :' || nm_atributo_w;
		else
			ds_sql_w	:= ds_sql_w || chr(13) ||' and ' || nm_atributo_w || ' = :' || nm_atributo_w;
		end if;

		select	b.nm_atributo
		into STRICT	nm_atributo_ref_w
		from   	indice_atributo b,
			indice a
		where  	a.nm_indice 			= b.nm_indice
		and    	a.nm_tabela 			= b.nm_tabela
		and    	a.nm_tabela 			= nm_tabela_superior_w
		and    	a.ie_tipo   			= 'PK'
		and	b.nr_sequencia			= ie_sequencia_criacao_w;

		select	nextval('obj_schematic_ativ_param_seq')
		into STRICT	nr_seq_ativ_param_w
		;

		insert into obj_schematic_ativ_param(
			nr_sequencia, dt_atualizacao, nm_usuario,
			dt_atualizacao_nrec, nm_usuario_nrec, nr_seq_ativacao,
			nr_seq_objeto, nm_parametro, nr_seq_apres,
			ie_origem_param, nr_seq_obj_ref, nm_atributo_ref)
		values (nr_seq_ativ_param_w, clock_timestamp(), nm_usuario_p,
			clock_timestamp(), nm_usuario_p, nr_seq_ativacao_w,
			nr_seq_objeto_p, nm_atributo_w, nr_seq_apres_w,
			'O', nr_seq_obj_sup_ativ_w,nm_atributo_ref_w);

		nr_seq_apres_w := nr_seq_apres_w + 1;
		end;
	end loop;
	close C01;

	RAISE NOTICE 'sql=%', ds_sql_w;

	if (ds_sql_w IS NOT NULL AND ds_sql_w::text <> '') then

		update	tabela_sistema_ativacao
		set	ds_sql		= ds_sql_w
		where	nr_sequencia	= nr_seq_ativacao_w;

		update	objeto_schematic
		set	nr_seq_ativacao = nr_seq_ativacao_w
		where	nr_sequencia	= nr_seq_objeto_p;

	end if;

--Carregamento dos parâmetros para o componente do WAE - Chamada externa
elsif ((ie_tipo_componente_w = 'WAE' or ie_tipo_objeto_w = 'WPL') AND nr_seq_cham_externa_w IS NOT NULL AND nr_seq_cham_externa_w::text <> '') then

	for c03_w in C03( nr_seq_cham_externa_w ) loop

		select	count(*)
		into STRICT	qt_w
		from	obj_schematic_ativ_param
		where	nr_seq_objeto = nr_seq_objeto_p
		and	nm_parametro = c03_w.nm_parametro;

		if (qt_w = 0) then

			insert into obj_schematic_ativ_param(
				nr_sequencia, dt_atualizacao, nm_usuario,
				dt_atualizacao_nrec, nm_usuario_nrec, nr_seq_objeto,
				nm_parametro, nr_seq_apres, ie_origem_param )
			values (nextval('obj_schematic_ativ_param_seq'), clock_timestamp(), nm_usuario_p,
				clock_timestamp(), nm_usuario_p, nr_seq_objeto_p,
				c03_w.nm_parametro, c03_w.nr_seq_apres, null);
		end if;
	end loop;

end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE schematic_gerar_sql_ativacao ( nr_seq_objeto_p objeto_schematic.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type) FROM PUBLIC;

