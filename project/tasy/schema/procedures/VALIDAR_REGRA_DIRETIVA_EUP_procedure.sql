-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE validar_regra_diretiva_eup ( cd_pessoa_fisica_p text, nm_usuario_p text) AS $body$
DECLARE

 
qt_dias_validade_w 	diretriz_atendimento_param.qt_dias_validade%type;
ie_novo_atendimento_w	diretriz_atendimento_param.ie_novo_atendimento%type;
ie_diretriz_w		diretriz_atendimento_param.ie_diretriz%type;
dt_alta_w		atendimento_paciente.dt_alta%type;
dt_diretriz_w		atendimento_paciente.dt_atualizacao%type;
nr_seq_diretriz_w	diretriz_atendimento.nr_sequencia%type;
qt_dias_ult_atend_w	bigint;

 
c01 CURSOR FOR 
SELECT 	qt_dias_validade, 
	ie_novo_atendimento, 
	ie_diretriz 
from 	diretriz_atendimento_param 
where	ie_situacao = 'A';		
					 

BEGIN 
 
	open C01;
	loop 
	fetch C01 into	 
		qt_dias_validade_w, 
		ie_novo_atendimento_w, 
		ie_diretriz_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin 
			select	max(nr_sequencia) 
			into STRICT	nr_seq_diretriz_w 
			from	diretriz_atendimento 
			where	cd_pessoa_fisica = cd_pessoa_fisica_p		 
			and	ie_diretriz = ie_diretriz_w 
			and	ie_status = 'C' 
			and	(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '');
			 
			if (nr_seq_diretriz_w IS NOT NULL AND nr_seq_diretriz_w::text <> '') then 
				if (ie_novo_atendimento_w = 'S') then 
					CALL alterar_status_diretriz(nr_seq_diretriz_w, 'P', null, nm_usuario_p);
				else 
					select 	max(dt_alta) 
					into STRICT	dt_alta_w 
					from	atendimento_paciente a, 
						diretriz_atendimento b 
					where	a.cd_pessoa_fisica = b.cd_pessoa_fisica 
					and	a.cd_pessoa_fisica = cd_pessoa_fisica_p 
					and	b.nr_sequencia = nr_seq_diretriz_w 
					and	dt_alta >= b.dt_atualizacao 
					and	ie_tipo_atendimento in (1,3); --Internado, Pronto socorro; 
					
					if (dt_alta_w IS NOT NULL AND dt_alta_w::text <> '') then 
						qt_dias_ult_atend_w := clock_timestamp() - dt_alta_w;
						 
						if (qt_dias_ult_atend_w > qt_dias_validade_w) then 
							CALL alterar_status_diretriz(nr_seq_diretriz_w, 'P', null, nm_usuario_p);
						end if;
					end if;
				end if;
			end if;
		end;
	end loop;
	close C01;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE validar_regra_diretiva_eup ( cd_pessoa_fisica_p text, nm_usuario_p text) FROM PUBLIC;

