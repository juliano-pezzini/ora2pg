-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE manchester_sinal_vital ( nr_atendimento_p bigint, cd_pessoa_fisica_p text, nm_usuario_p text, qt_escala_dor_p bigint, cd_escala_dor_p text, qt_temp_p bigint, qt_freq_cardiaca_p bigint, qt_freq_resp_p bigint, qt_glicemia_capilar_p bigint, qt_pa_sistolica_p bigint, qt_pa_diastolica_p bigint, qt_saturacao_o2_p bigint, ie_perf_cap_p text default '', ie_cond_sat_o2_p text default null, nr_sequencia_p INOUT bigint DEFAULT NULL, ie_glic_extrapol_p atendimento_sinal_vital.ie_glic_extrapol%type default null, ie_sitio_p atendimento_sinal_vital.ie_sitio%type default null) AS $body$
DECLARE


nr_sequencia_w			bigint;
ds_erro_w				varchar(2000);
ie_sitio_w				smallint;
nr_seq_sinal_vital_w	bigint;
nr_regras_atendidas_w   varchar(2000);
										

BEGIN
begin
IF (nr_atendimento_p IS NOT NULL AND nr_atendimento_p::text <> '') AND
	((qt_escala_dor_p IS NOT NULL AND qt_escala_dor_p::text <> '') OR (qt_temp_p IS NOT NULL AND qt_temp_p::text <> '') OR (qt_freq_cardiaca_p IS NOT NULL AND qt_freq_cardiaca_p::text <> '') OR (qt_freq_resp_p IS NOT NULL AND qt_freq_resp_p::text <> '') OR (qt_glicemia_capilar_p IS NOT NULL AND qt_glicemia_capilar_p::text <> '') OR (qt_pa_sistolica_p IS NOT NULL AND qt_pa_sistolica_p::text <> '') OR (qt_pa_diastolica_p IS NOT NULL AND qt_pa_diastolica_p::text <> '') OR (qt_saturacao_o2_p IS NOT NULL AND qt_saturacao_o2_p::text <> '') OR (ie_perf_cap_p <> '') OR (ie_cond_sat_o2_p IS NOT NULL AND ie_cond_sat_o2_p::text <> '')) THEN

	SELECT	MAX(nr_sequencia)
	INTO STRICT	nr_sequencia_w
	FROM	triagem_pronto_atend
	WHERE	nr_atendimento = nr_atendimento_p;
	
    if (coalesce(pkg_i18n.get_user_locale, 'pt_BR') = 'de_DE') then
        if (qt_temp_p > 0) then
            ie_sitio_w := coalesce(ie_sitio_p, 5);
        end if;
    else
	if (qt_temp_p > 0) then
		ie_sitio_w := 5; /*Dominio 1558,  Sitio timpanico -- Conforme regra do Protocolo de risco manchester, 
							a classificacao do paciente pode demorar entre 2 e 3 minutos, portanto a unica 
							forma rapida para medir a temperatura do paciente, e com o aparelho que afere a 
							temperatura pela via timpanica, caso o hospital nao possuir este aparelho, o mesmo 
							deve adequar se a regra do Manchester e nao o sistema Verificar historico da Enf 
							Patricia na OS 883143 da data 28/05/2015 08:51:00  --*/
	end if;
    end if;
	
	
	Select	nextval('atendimento_sinal_vital_seq')
	into STRICT	nr_seq_sinal_vital_w
	;


	INSERT INTO atendimento_sinal_vital(nr_sequencia,
			nr_atendimento,
			cd_pessoa_fisica,
			dt_sinal_vital,
			dt_atualizacao,
			nm_usuario,
			qt_escala_dor,
			cd_escala_dor,
			qt_temp,
			qt_freq_cardiaca,
			qt_freq_resp,
			qt_glicemia_capilar,
			qt_pa_sistolica,
			qt_pa_diastolica,
			qt_saturacao_o2,
			nr_seq_triagem,
			dt_liberacao,
			ie_situacao,
			ie_sitio,
			ie_perf_cap,
			ie_cond_sat_o2,
            ie_glic_extrapol)
		VALUES (nr_seq_sinal_vital_w,
			nr_atendimento_p,
			cd_pessoa_fisica_p,
			clock_timestamp(),
			clock_timestamp(),
			nm_usuario_p,
			qt_escala_dor_p,
			cd_escala_dor_p,
			qt_temp_p,
			qt_freq_cardiaca_p,
			qt_freq_resp_p,
			qt_glicemia_capilar_p,
			qt_pa_sistolica_p,
			qt_pa_diastolica_p,
			qt_saturacao_o2_p,
			nr_sequencia_w,
			clock_timestamp(),
			'A',
			ie_sitio_w,
			ie_perf_cap_p,
			ie_cond_sat_o2_p,
            ie_glic_extrapol_p);

			COMMIT;
			
			CALL gerar_lanc_automatico_tabela(nr_atendimento_p,412,upper('ATENDIMENTO_SINAL_VITAL'),nr_seq_sinal_vital_w,nm_usuario_p);
			
			nr_sequencia_p := nr_seq_sinal_vital_w;

    /*Executa mentor para verificar se o sinal vital ira dispara alguma regra de suporte a decisao clinica*/

    if (coalesce(nr_seq_sinal_vital_w, 0) > 0) and (coalesce(nr_atendimento_p, 0) > 0) then
        begin
            nr_regras_atendidas_w := GQA_Liberacao_Sinal_Vital(nr_seq_sinal_vital_w, nm_usuario_p);
            CALL gera_protocolo_assistencial(nr_atendimento_p, nm_usuario_p);
        exception
        when others then
            null;
        end;
    end if;
			
END IF;

exception
when others then
	ds_erro_w := substr(sqlerrm(SQLSTATE),2000);

	CALL gravar_log_tasy(99995,
					substr('Erro ao inserir Sinais Vitais no manchester = ' || ds_erro_w,1,2000),
					wheb_usuario_pck.get_nm_usuario);	
end;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE manchester_sinal_vital ( nr_atendimento_p bigint, cd_pessoa_fisica_p text, nm_usuario_p text, qt_escala_dor_p bigint, cd_escala_dor_p text, qt_temp_p bigint, qt_freq_cardiaca_p bigint, qt_freq_resp_p bigint, qt_glicemia_capilar_p bigint, qt_pa_sistolica_p bigint, qt_pa_diastolica_p bigint, qt_saturacao_o2_p bigint, ie_perf_cap_p text default '', ie_cond_sat_o2_p text default null, nr_sequencia_p INOUT bigint DEFAULT NULL, ie_glic_extrapol_p atendimento_sinal_vital.ie_glic_extrapol%type default null, ie_sitio_p atendimento_sinal_vital.ie_sitio%type default null) FROM PUBLIC;

