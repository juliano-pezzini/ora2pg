-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_autor_integracao (nr_seq_procedimento_p bigint, cd_procedimento_p bigint, ie_origem_proced_p bigint, cd_proced_tuss_p bigint, cd_proced_convenio_p text, qt_solicitada_p bigint default 1, nr_sequencia_autor_p bigint DEFAULT NULL, nm_usuario_p text DEFAULT NULL, ie_commit_p text default 'N') AS $body$
DECLARE


qt_regra_integracao_w		integer := 0;
cd_procedimento_tuss_w		bigint;
qt_solicitada_w			bigint;
lista_procedimentos_w		varchar(2000);

cd_area_proc_w			bigint;
cd_espec_proc_w			bigint;
cd_grupo_proc_w			bigint;

cd_estabelecimento_w		estabelecimento.cd_estabelecimento%type;
ie_tipo_autorizacao_w		autorizacao_convenio.ie_tipo_autorizacao%type;
ie_resp_autor_w			autorizacao_convenio.ie_resp_autor%type;
ie_tipo_atendimento_w		atendimento_paciente.ie_tipo_atendimento%type;
cd_convenio_w			convenio.cd_convenio%type;

nr_seq_regra_w			bigint;
qt_autor_integrada_w		integer := 0;
ie_tipo_regra_w			varchar(1);

CRegra CURSOR FOR
SELECT	c.nr_sequencia,
	coalesce(c.ie_tipo_regra,'G')
from	regra_autor_integracao c
where	c.cd_estabelecimento 	= cd_estabelecimento_w
and	c.cd_convenio 		= cd_convenio_w
and	coalesce(c.ie_situacao,'A') = 'A'
and	coalesce(c.ie_resp_autor,coalesce(ie_resp_autor_w,'0')) 		= coalesce(ie_resp_autor_w,'0')
and	coalesce(c.ie_tipo_autorizacao,coalesce(ie_tipo_autorizacao_w,'0'))	= coalesce(ie_tipo_autorizacao_w,'0')
and	coalesce(C.ie_tipo_atendimento,coalesce(ie_tipo_atendimento_w,0))	= coalesce(ie_tipo_atendimento_w,0)
and	coalesce(c.cd_procedimento,cd_procedimento_p) 		= cd_procedimento_p
and	((coalesce(c.cd_procedimento::text, '') = '') or (coalesce(c.ie_origem_proced,ie_origem_proced_p) = ie_origem_proced_p))
and	coalesce(c.cd_area_procedimento,cd_area_proc_w)		= cd_area_proc_w
and	coalesce(c.cd_grupo_proc,cd_grupo_proc_w)			= cd_grupo_proc_w
and	coalesce(c.cd_especialidade,cd_espec_proc_w)			= cd_espec_proc_w
order by coalesce(c.cd_procedimento,0),
	coalesce(c.cd_grupo_proc,0),
	coalesce(c.cd_especialidade,0),
	coalesce(c.cd_area_procedimento,0),
	coalesce(c.ie_tipo_autorizacao,0),
	coalesce(c.ie_tipo_atendimento,0),
	c.ie_resp_autor desc;





BEGIN

if (qt_solicitada_p = 0) then
	qt_solicitada_w := 1;
else
	qt_solicitada_w := qt_solicitada_p;
end if;

begin
select	a.cd_estabelecimento,
	a.ie_tipo_autorizacao,
	a.ie_resp_autor,
	substr(obter_tipo_atend_autor(a.nr_atendimento,a.nr_seq_agenda,a.nr_seq_agenda_consulta,a.nr_seq_age_integ,a.nr_seq_paciente_setor,'C'),1,1),
	a.cd_convenio
into STRICT	cd_estabelecimento_w,
	ie_tipo_autorizacao_w,
	ie_resp_autor_w,
	ie_tipo_atendimento_w,
	cd_convenio_w
from	autorizacao_convenio a,
	estagio_autorizacao e
where	a.nr_sequencia = nr_sequencia_autor_p
and	coalesce(a.cd_senha::text, '') = ''
and	a.nr_seq_estagio = e.nr_sequencia
and	e.ie_interno not in ('70','10','90');
exception
when others then
	cd_convenio_w := null;
end;


select	count(*)
into STRICT	qt_regra_integracao_w
from	regra_autor_integracao
where	cd_estabelecimento = cd_estabelecimento_w
and	cd_convenio	= cd_convenio_w
and	coalesce(ie_situacao,'A') = 'A';

if (qt_regra_integracao_w > 0) then

	select	count(*)
	into STRICT	qt_autor_integrada_w
	from	autorizacao_integracao
	where	nr_sequencia_autor = nr_sequencia_autor_p;

	select	cd_area_procedimento,
		cd_especialidade,
		cd_grupo_proc
	into STRICT	cd_area_proc_w,
		cd_espec_proc_w,
		cd_grupo_proc_w
	from	estrutura_procedimento_v
	where	cd_procedimento = cd_procedimento_p
	and	ie_origem_proced = ie_origem_proced_p;

	lista_procedimentos_w := null;
	open CRegra;
	loop
	fetch CRegra into
		nr_seq_regra_w,
		ie_tipo_regra_w;
	EXIT WHEN NOT FOUND; /* apply on CRegra */
		begin
		nr_seq_regra_w := nr_seq_regra_w;
		ie_tipo_regra_w := ie_tipo_regra_w;
		end;
	end loop;
	close CRegra;



	if (nr_seq_regra_w IS NOT NULL AND nr_seq_regra_w::text <> '') and (ie_tipo_regra_w = 'G')then

		if (qt_autor_integrada_w = 0) then

			insert	into autorizacao_integracao(nr_sequencia,
				dt_atualizacao,
				dt_atualizacao_nrec,
				nm_usuario,
				nm_usuario_nrec,
				cd_status_autorizacao,
				nr_sequencia_autor,
				nr_seq_regra_geracao,
				ds_lista_procedimentos,
				ds_lista_sequences)
			values (nextval('autorizacao_integracao_seq'),
				clock_timestamp(),
				clock_timestamp(),
				nm_usuario_p,
				nm_usuario_p,
				'P',
				nr_sequencia_autor_p,
				nr_seq_regra_w,
				'C'||coalesce(cd_proced_tuss_p,coalesce(cd_proced_convenio_p,cd_procedimento_p))||'Q'||coalesce(qt_solicitada_w,1),
				NR_SEQ_PROCEDIMENTO_P||',');

		else

			update	autorizacao_integracao a
			set	dt_atualizacao = clock_timestamp(),
				nm_usuario     = nm_usuario_p,
				ds_lista_procedimentos = ds_lista_procedimentos||'C'||coalesce(cd_proced_tuss_p,coalesce(cd_proced_convenio_p,cd_procedimento_p))||'Q'||coalesce(qt_solicitada_w,1),
				ds_lista_sequences     = ds_lista_sequences||NR_SEQ_PROCEDIMENTO_P||','
			where	a.nr_sequencia_autor   = nr_sequencia_autor_p;
		end if;




	end if;


end if;


if (ie_commit_p = 'S') then
	 commit;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_autor_integracao (nr_seq_procedimento_p bigint, cd_procedimento_p bigint, ie_origem_proced_p bigint, cd_proced_tuss_p bigint, cd_proced_convenio_p text, qt_solicitada_p bigint default 1, nr_sequencia_autor_p bigint DEFAULT NULL, nm_usuario_p text DEFAULT NULL, ie_commit_p text default 'N') FROM PUBLIC;

