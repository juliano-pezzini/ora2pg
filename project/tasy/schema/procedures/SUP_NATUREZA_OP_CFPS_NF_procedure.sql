-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE sup_natureza_op_cfps_nf ( nr_sequencia_p nota_fiscal.nr_sequencia%type) AS $body$
DECLARE

 
 
cd_mun_ibge_prest_w	varchar(7);
cd_mun_ibge_tom_w	varchar(7);
cd_uf_prestador_w	varchar(2);
cd_uf_tomador_w		varchar(2);
nr_seq_item_serv_w	procedimento.nr_seq_item_serv%type;
cd_setor_digitacao_w	nota_fiscal.cd_setor_digitacao%type;
cd_operacao_nf_w	nota_fiscal.cd_operacao_nf%type;
cd_estabelecimento_w	nota_fiscal.cd_estabelecimento%type;
ie_cfps_natop_nf_w	parametro_compras.ie_cfps_natop_nf%type;
					
c01 CURSOR FOR 
	SELECT	nr_sequencia, 
		ie_tipo_situacao, 
		nr_seq_item_serv, 
		cd_setor_atendimento, 
		cd_natureza_operacao 
	from	regra_cfps 
	where	cd_estabelecimento = cd_estabelecimento_w 
	and	nr_seq_item_serv  = nr_seq_item_serv_w 
	and	coalesce(cd_operacao_nf,cd_operacao_nf_w) = cd_operacao_nf_w 
	and	coalesce(cd_setor_atendimento,cd_setor_digitacao_w) = cd_setor_digitacao_w 
	and	coalesce(ie_def_nat_oper,'N') = 'S' 
	and	(cd_natureza_operacao IS NOT NULL AND cd_natureza_operacao::text <> '') 
	order by ie_tipo_situacao asc;

	 
C02 CURSOR FOR 
	SELECT	nr_sequencia, 
		nr_item_nf, 
		cd_estabelecimento 
	from	nota_fiscal_item 
	where	nr_sequencia    = nr_sequencia_p 
	order by nr_item_nf asc;
	
vet01			c01%rowType;
vet02			c02%rowType;


BEGIN 
 
select	max(cd_operacao_nf), 
	max(cd_estabelecimento) 
into STRICT	cd_operacao_nf_w, 
	cd_estabelecimento_w 
from	nota_fiscal 
where	nr_sequencia = nr_sequencia_p;
 
 
select	coalesce(max(ie_cfps_natop_nf),'N') 
into STRICT	ie_cfps_natop_nf_w 
from	parametro_compras 
where	cd_estabelecimento = cd_estabelecimento_w;
 
 
if (ie_cfps_natop_nf_w = 'S') then 
	begin 
 
	begin 
 
	open C02;
	loop 
	fetch C02 into	 
		vet02;
	EXIT WHEN NOT FOUND; /* apply on C02 */
		begin 
		 
		select	max(p.nr_seq_item_serv), 
			max(a.cd_setor_digitacao), 
			substr(nfe_obter_dados_pj(max(a.cd_cgc_emitente),'IBGE'),1,7), 
			substr(CASE WHEN coalesce(max(a.cd_pessoa_fisica)::text, '') = '' THEN nfe_obter_dados_pj(max(a.cd_cgc),'IBGE')  ELSE OBTER_COMPL_PF(max(a.cd_pessoa_fisica),1,'CDMDV') END ,1,7), 
			substr(nfe_obter_dados_pj(max(a.cd_cgc_emitente),'UF'),1,7), 
			substr(CASE WHEN coalesce(max(a.cd_pessoa_fisica)::text, '') = '' THEN nfe_obter_dados_pj(max(a.cd_cgc),'UF')  ELSE OBTER_COMPL_PF(max(a.cd_pessoa_fisica),1,'UF') END ,1,7) 
		into STRICT	nr_seq_item_serv_w, 
			cd_setor_digitacao_w, 
			cd_mun_ibge_prest_w, 
			cd_mun_ibge_tom_w, 
			cd_uf_prestador_w, 
			cd_uf_tomador_w 
		from	nota_fiscal a, 
			nota_fiscal_item b, 
			procedimento p 
		where	a.nr_sequencia = b.nr_sequencia 
		and	b.nr_sequencia = vet02.nr_sequencia 
		and	b.nr_item_nf  = vet02.nr_item_nf 
		and	b.cd_procedimento  = p.cd_procedimento 
		and	coalesce(b.ie_origem_proced,p.ie_origem_proced)  = p.ie_origem_proced;
		 
		end;
	end loop;
	close C02;
 
	open C01;
	loop 
	fetch C01 into	 
		vet01;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin 
		 
		 
		if (cd_mun_ibge_prest_w = cd_mun_ibge_tom_w) and (vet01.ie_tipo_situacao = '01') then 
			 
			update	nota_fiscal 
			set	cd_natureza_operacao = vet01.cd_natureza_operacao 
			where	nr_sequencia = nr_sequencia_p 
			and	cd_estabelecimento = cd_estabelecimento_w;
			commit;
			exit;
			 
		elsif (cd_uf_prestador_w = cd_uf_tomador_w) and (cd_mun_ibge_prest_w <> cd_mun_ibge_tom_w) and (not cd_uf_tomador_w in ('IN','EX')) and (vet01.ie_tipo_situacao = '02') then 
			 
			update	nota_fiscal 
			set	cd_natureza_operacao = vet01.cd_natureza_operacao 
			where	nr_sequencia = nr_sequencia_p 
			and	cd_estabelecimento = cd_estabelecimento_w;
			commit;
			exit;
			 
		elsif (cd_uf_prestador_w <> cd_uf_tomador_w) and (not cd_uf_tomador_w in ('IN','EX')) and (vet01.ie_tipo_situacao = '03') then 
			 
			update	nota_fiscal 
			set	cd_natureza_operacao = vet01.cd_natureza_operacao 
			where	nr_sequencia = nr_sequencia_p 
			and	cd_estabelecimento = cd_estabelecimento_w;
			commit;
			exit;
			 
		elsif (cd_uf_prestador_w <> cd_uf_tomador_w) and (cd_uf_tomador_w in ('IN','EX')) and (vet01.ie_tipo_situacao = '04') then 
			 
			update	nota_fiscal 
			set	cd_natureza_operacao = vet01.cd_natureza_operacao 
			where	nr_sequencia = nr_sequencia_p 
			and	cd_estabelecimento = cd_estabelecimento_w;	
			commit;
			exit;
			 
		elsif (cd_uf_prestador_w = cd_uf_tomador_w) and (cd_mun_ibge_prest_w <> cd_mun_ibge_tom_w) and (not cd_uf_tomador_w in ('IN','EX')) and (vet01.ie_tipo_situacao = '05') then 
			 
			update	nota_fiscal 
			set	cd_natureza_operacao = vet01.cd_natureza_operacao 
			where	nr_sequencia = nr_sequencia_p 
			and	cd_estabelecimento = cd_estabelecimento_w;
			commit;
			exit;
			 
		elsif (cd_uf_prestador_w <> cd_uf_tomador_w) and (not cd_uf_tomador_w in ('IN','EX')) and (vet01.ie_tipo_situacao = '06') then 
			 
			update	nota_fiscal 
			set	cd_natureza_operacao = vet01.cd_natureza_operacao 
			where	nr_sequencia = nr_sequencia_p 
			and	cd_estabelecimento = cd_estabelecimento_w;
			commit;
			exit;
			 
		elsif (cd_uf_prestador_w <> cd_uf_tomador_w) and (cd_uf_tomador_w in ('IN','EX')) and (vet01.ie_tipo_situacao = '07') then 
			 
			update	nota_fiscal 
			set	cd_natureza_operacao = vet01.cd_natureza_operacao 
			where	nr_sequencia = nr_sequencia_p 
			and	cd_estabelecimento = cd_estabelecimento_w;
			commit;
			exit;
						 
		end if;
		 
		end;
	end loop;
	close C01;
 
	exception 
		when others then 
		rollback;
 
	end;
 
	 
	end;
end if;
 
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE sup_natureza_op_cfps_nf ( nr_sequencia_p nota_fiscal.nr_sequencia%type) FROM PUBLIC;

