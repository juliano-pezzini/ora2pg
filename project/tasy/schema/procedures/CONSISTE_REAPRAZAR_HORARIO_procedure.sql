-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE consiste_reaprazar_horario ( cd_estabelecimento_p bigint, nr_atendimento_p bigint, ie_tipo_item_p text, cd_item_p text, cd_intervalo_p text, qt_item_p bigint, dt_horario_p timestamp, dt_horario_desejado_p timestamp, ie_reaprazar_seguintes_p text, nr_prescricoes_p text, nr_prescricao_p bigint, nr_seq_item_p bigint, ie_laboratorio_p text, nr_seq_motivo_p bigint, ds_justificativa_p text, nm_usuario_p text, ds_lista_eliminados_p INOUT text, nr_seq_proc_interno_p bigint, ds_erro_p INOUT text) AS $body$
DECLARE



nr_prescricao_w			prescr_medica.nr_prescricao%type;
nr_prescr_atual_w		prescr_medica.nr_prescricao%type;
nr_seq_item_w			bigint;
qt_minutos_w			bigint;
ds_lista_eliminados_w	varchar(255);
ie_adep_w				char(1);
cd_setor_pac_w			setor_atendimento.cd_setor_atendimento%type;
dt_fim_w				timestamp;
ie_data_proc_w			varchar(15);
ie_data_lib_prescr_w	varchar(15);
ie_exibe_suspenso_w		varchar(15);
nr_seq_horario_w		bigint;
nr_prescricoes_w		varchar(4000);
dt_horario_w			timestamp;
ie_agrupador_w			prescr_material.ie_agrupador%type;
ie_via_aplicacao_w		prescr_material.ie_via_aplicacao%type;
cd_setor_atendimento_w	prescr_medica.cd_setor_atendimento%type;
ds_erro_w				varchar(2000);
ie_primeiro_horario_w	varchar(1);
ie_existe_hor_antes_w	varchar(1);
ie_existe_hor_depois_w	varchar(1);
dt_menor_horario_w		timestamp;
dt_maior_horario_w		timestamp;

c01 CURSOR FOR
SELECT	a.nr_prescricao nr_prescricao, /* dietas orais */
	null nr_seq_item,
	c.nr_sequencia
from	prescr_dieta_hor c,
	prescr_medica a
where	c.nr_prescricao = a.nr_prescricao
and	obter_se_prescr_lib_adep(a.dt_liberacao_medico, a.dt_liberacao, a.dt_liberacao_farmacia, ie_data_lib_prescr_w) = 'S'
and	obter_se_exibir_rep_adep_setor(cd_setor_pac_w,a.cd_setor_atendimento,coalesce(a.ie_adep,'S')) = 'S'
and	coalesce(c.ie_situacao,'A') = 'A'
and	coalesce(c.dt_fim_horario::text, '') = ''
and	coalesce(c.dt_suspensao::text, '') = ''
and	a.nr_atendimento = nr_atendimento_p
and	obter_se_valor_contido(a.nr_prescricao, nr_prescricoes_w) = 'S'
and	a.dt_prescricao > clock_timestamp() - interval '500 days'
and	c.dt_horario > clock_timestamp() - interval '500 days'
and	a.dt_validade_prescr between clock_timestamp() and dt_fim_w + 3
and	c.cd_refeicao = cd_item_p
and	((('N' = 'S' AND c.dt_horario >= dt_horario_p) or
	  ('N' = 'N' AND c.dt_horario = dt_horario_p and qt_minutos_w > 0)) or (c.dt_horario = dt_horario_p and qt_minutos_w < 0))
and	ie_tipo_item_p = 'D'
and	Obter_se_horario_liberado(c.dt_lib_horario, c.dt_horario) = 'S'

union

select	a.nr_prescricao nr_prescricao, /* dietas orais */
	b.nr_sequencia nr_seq_item,
	c.nr_sequencia
from	prescr_medica a,
	prescr_dieta b,
	prescr_dieta_hor c
where	c.nr_prescricao = a.nr_prescricao
and	c.nr_prescricao	= b.nr_prescricao
and	c.nr_seq_dieta	= b.nr_sequencia
and	obter_se_prescr_lib_adep(a.dt_liberacao_medico, a.dt_liberacao, a.dt_liberacao_farmacia, ie_data_lib_prescr_w) = 'S'
and	obter_se_exibir_rep_adep_setor(cd_setor_pac_w,a.cd_setor_atendimento,coalesce(a.ie_adep,'S')) = 'S'
and	coalesce(c.ie_situacao,'A') = 'A'
and	coalesce(c.dt_fim_horario::text, '') = ''
and	coalesce(c.dt_suspensao::text, '') = ''
and	a.nr_atendimento = nr_atendimento_p
and	obter_se_valor_contido(a.nr_prescricao, nr_prescricoes_w) = 'S'
and	a.dt_prescricao > clock_timestamp() - interval '500 days'
and	c.dt_horario > clock_timestamp() - interval '500 days'
and	a.dt_validade_prescr between clock_timestamp() and dt_fim_w + 3
and	coalesce(c.cd_refeicao::text, '') = ''
and	to_char(b.cd_dieta) = cd_item_p
and	((('N' = 'S' AND c.dt_horario >= dt_horario_p) or
	  ('N' = 'N' AND c.dt_horario = dt_horario_p and qt_minutos_w > 0)) or (c.dt_horario = dt_horario_p and qt_minutos_w < 0))
and	ie_tipo_item_p = 'D'
and	Obter_se_horario_liberado(c.dt_lib_horario, c.dt_horario) = 'S'

union

select	a.nr_prescricao nr_prescricao, /* suplementos orais */
	b.nr_sequencia nr_seq_item,
	c.nr_sequencia
from	prescr_mat_hor c,
	prescr_material b,
	prescr_medica a
where	c.nr_prescricao = b.nr_prescricao
and	c.nr_seq_material = b.nr_sequencia
and	b.nr_prescricao = a.nr_prescricao
and	obter_se_prescr_lib_adep(a.dt_liberacao_medico, a.dt_liberacao, a.dt_liberacao_farmacia, ie_data_lib_prescr_w) = 'S'
and	coalesce(a.ie_adep,'S') = 'S'
and	b.ie_agrupador = 12
and	coalesce(c.ie_situacao,'A') = 'A'
and	coalesce(c.ie_horario_especial,'N') = 'N'
and	coalesce(c.dt_fim_horario::text, '') = ''
and	coalesce(c.dt_suspensao::text, '') = ''
and	a.nr_atendimento = nr_atendimento_p
and	a.dt_prescricao > clock_timestamp() - interval '500 days'
and	c.dt_horario > clock_timestamp() - interval '500 days'
and	a.dt_validade_prescr between clock_timestamp() and dt_fim_w +3
and	b.cd_material = cd_item_p
and	coalesce(b.cd_intervalo,'XPTO') = coalesce(cd_intervalo_p,'XPTO')
and	coalesce(b.qt_dose,1) = coalesce(qt_item_p,coalesce(b.qt_dose,1))
and	(((ie_reaprazar_seguintes_p = 'S' AND c.dt_horario >= dt_horario_p) or
	  (ie_reaprazar_seguintes_p = 'N' AND c.dt_horario = dt_horario_p and qt_minutos_w > 0)) or (c.dt_horario = dt_horario_p and qt_minutos_w < 0))
and	ie_tipo_item_p = 'S'
and	Obter_se_horario_liberado(c.dt_lib_horario, c.dt_horario) = 'S'

union

select	a.nr_prescricao nr_prescricao, /* medicamentos */
	b.nr_sequencia nr_seq_item,
	c.nr_sequencia
from	prescr_mat_hor c,
	prescr_material b,
	prescr_medica a
where	c.nr_prescricao = b.nr_prescricao
and	c.nr_seq_material = b.nr_sequencia
and	b.nr_prescricao = a.nr_prescricao
and	obter_se_prescr_lib_adep(a.dt_liberacao_medico, a.dt_liberacao, a.dt_liberacao_farmacia, ie_data_lib_prescr_w) = 'S'
and	obter_se_exibir_rep_adep_setor(cd_setor_pac_w,a.cd_setor_atendimento,coalesce(a.ie_adep,'S')) = 'S'
and	b.ie_agrupador = 1
and	coalesce(c.ie_situacao,'A') = 'A'
and	coalesce(c.ie_horario_especial,'N') = 'N'
and	coalesce(c.ie_adep,'S') = 'S'
and	coalesce(c.dt_fim_horario::text, '') = ''
and	coalesce(c.dt_suspensao::text, '') = ''
and	a.nr_atendimento = nr_atendimento_p
and	a.dt_prescricao > clock_timestamp() - interval '500 days'
and	c.dt_horario > clock_timestamp() - interval '500 days'
and	a.dt_validade_prescr between clock_timestamp() and dt_fim_w +3
and	b.cd_material = cd_item_p
and	coalesce(b.cd_intervalo,'XPTO') = coalesce(cd_intervalo_p,'XPTO')
and	coalesce(b.qt_dose,1) = coalesce(qt_item_p,coalesce(b.qt_dose,1))
and	(((ie_reaprazar_seguintes_p = 'S' AND c.dt_horario >= dt_horario_p) or
	  (ie_reaprazar_seguintes_p = 'N' AND c.dt_horario = dt_horario_p and qt_minutos_w > 0)) or (c.dt_horario = dt_horario_p and qt_minutos_w < 0))
and	ie_tipo_item_p = 'M'
and	Obter_se_horario_liberado(c.dt_lib_horario, c.dt_horario) = 'S'

union

select	a.nr_prescricao nr_prescricao, /* materiais */
	b.nr_sequencia nr_seq_item,
	c.nr_sequencia
from	prescr_mat_hor c,
	prescr_material b,
	prescr_medica a
where	c.nr_prescricao = b.nr_prescricao
and	c.nr_seq_material = b.nr_sequencia
and	b.nr_prescricao = a.nr_prescricao
and	obter_se_prescr_lib_adep(a.dt_liberacao_medico, a.dt_liberacao, a.dt_liberacao_farmacia, ie_data_lib_prescr_w) = 'S'
and	obter_se_exibir_rep_adep_setor(cd_setor_pac_w,a.cd_setor_atendimento,coalesce(a.ie_adep,'S')) = 'S'
and	b.ie_agrupador = 2
and	coalesce(c.ie_situacao,'A') = 'A'
and	coalesce(c.ie_horario_especial,'N') = 'N'
and	coalesce(c.dt_fim_horario::text, '') = ''
and	coalesce(c.dt_suspensao::text, '') = ''
and	a.nr_atendimento = nr_atendimento_p
and	a.dt_prescricao > clock_timestamp() - interval '500 days'
and	c.dt_horario > clock_timestamp() - interval '500 days'
and	a.dt_validade_prescr between clock_timestamp() and dt_fim_w +3
and	b.cd_material = cd_item_p
and	coalesce(b.cd_intervalo,'XPTO') = coalesce(cd_intervalo_p,'XPTO')
and	coalesce(b.qt_dose,1) = coalesce(qt_item_p,coalesce(b.qt_dose,1))
and	(((ie_reaprazar_seguintes_p = 'S' AND c.dt_horario >= dt_horario_p) or
	  (ie_reaprazar_seguintes_p = 'N' AND c.dt_horario = dt_horario_p and qt_minutos_w > 0)) or (c.dt_horario = dt_horario_p and qt_minutos_w < 0))
and	ie_tipo_item_p = 'MAT'
and	Obter_se_horario_liberado(c.dt_lib_horario, c.dt_horario) = 'S'

union

select	a.nr_prescricao nr_prescricao, /* procedimentos e controles de glicemia */
	b.nr_sequencia nr_seq_item,
	c.nr_sequencia
from	prescr_proc_hor c,
	prescr_procedimento b,
	prescr_medica a
where	c.nr_prescricao = b.nr_prescricao
and	c.nr_seq_procedimento = b.nr_sequencia
and	b.nr_prescricao = a.nr_prescricao
and	(obter_data_lib_proc_adep(a.dt_liberacao, a.dt_liberacao_medico, ie_data_proc_w) IS NOT NULL AND (obter_data_lib_proc_adep(a.dt_liberacao, a.dt_liberacao_medico, ie_data_proc_w))::text <> '')
and	obter_se_exibir_adep_suspensos(b.dt_suspensao, ie_exibe_suspenso_w) = 'S'
and	obter_se_exibir_rep_adep_setor(cd_setor_pac_w,a.cd_setor_atendimento,coalesce(a.ie_adep,'S')) = 'S'
and	((coalesce(b.nr_seq_exame::text, '') = '' and ie_laboratorio_p = 'N') or ((b.nr_seq_exame IS NOT NULL AND b.nr_seq_exame::text <> '') and ie_laboratorio_p = 'S'))
and	coalesce(c.ie_situacao,'A') = 'A'
and	coalesce(c.ie_horario_especial,'N') = 'N'
and	coalesce(c.dt_fim_horario::text, '') = ''
and	coalesce(c.dt_suspensao::text, '') = ''
and	a.nr_atendimento = nr_atendimento_p
and	a.dt_prescricao > clock_timestamp() - interval '500 days'
and	c.dt_horario > clock_timestamp() - interval '500 days'
and	a.dt_validade_prescr between clock_timestamp() and dt_fim_w +3
and	b.cd_procedimento = cd_item_p
and	coalesce(b.cd_intervalo,'XPTO') = coalesce(cd_intervalo_p,'XPTO')
and	coalesce(b.qt_procedimento,1) = coalesce(qt_item_p,coalesce(b.qt_procedimento,1))
and	(((ie_reaprazar_seguintes_p = 'S' AND c.dt_horario >= dt_horario_p) or
	  (ie_reaprazar_seguintes_p = 'N' AND c.dt_horario = dt_horario_p and qt_minutos_w > 0)) or (c.dt_horario = dt_horario_p and qt_minutos_w < 0))
and	ie_tipo_item_p in ('P','G','C','I')
and	coalesce(b.nr_seq_proc_interno,0) = coalesce(nr_seq_proc_interno_p, 0)
and	Obter_se_horario_liberado(c.dt_lib_horario, c.dt_horario) = 'S'

union

select	a.nr_prescricao nr_prescricao, /* recomendações */
	b.nr_sequencia nr_seq_item,
	c.nr_sequencia
from	prescr_rec_hor c,
	prescr_recomendacao b,
	prescr_medica a
where	c.nr_prescricao = b.nr_prescricao
and	c.nr_seq_recomendacao = b.nr_sequencia
and	b.nr_prescricao = a.nr_prescricao
and	obter_se_prescr_lib_adep(a.dt_liberacao_medico, a.dt_liberacao, a.dt_liberacao_farmacia, ie_data_lib_prescr_w) = 'S'
and	obter_se_exibir_rep_adep_setor(cd_setor_pac_w,a.cd_setor_atendimento,coalesce(a.ie_adep,'S')) = 'S'
and	coalesce(c.ie_situacao,'A') = 'A'
and	coalesce(c.ie_horario_especial,'N') = 'N'
and	coalesce(c.dt_fim_horario::text, '') = ''
and	coalesce(c.dt_suspensao::text, '') = ''
and	a.nr_atendimento = nr_atendimento_p
and	a.dt_prescricao > clock_timestamp() - interval '500 days'
and	c.dt_horario > clock_timestamp() - interval '500 days'
and	a.dt_validade_prescr between clock_timestamp() and dt_fim_w +3
and	coalesce(to_char(b.cd_recomendacao),b.ds_recomendacao) = cd_item_p
and	coalesce(b.cd_intervalo,'XPTO') = coalesce(cd_intervalo_p,'XPTO')
and	coalesce(b.qt_recomendacao,1) = coalesce(qt_item_p,coalesce(b.qt_recomendacao,1))
and	(((ie_reaprazar_seguintes_p = 'S' AND c.dt_horario >= dt_horario_p) or
	  (ie_reaprazar_seguintes_p = 'N' AND c.dt_horario = dt_horario_p and qt_minutos_w > 0)) or (c.dt_horario = dt_horario_p and qt_minutos_w < 0))
and	ie_tipo_item_p = 'R'
and	Obter_se_horario_liberado(c.dt_lib_horario, c.dt_horario) = 'S'

union

select	a.nr_sequencia nr_prescricao, /* sae */
	b.nr_sequencia nr_seq_item,
	c.nr_sequencia
from	pe_prescr_proc_hor c,
	pe_prescr_proc b,
	pe_prescricao a
where	c.nr_seq_pe_proc = b.nr_sequencia
and	b.nr_seq_prescr = a.nr_sequencia
and	(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
and	coalesce(b.ie_adep,'N') in ('S','M')
and	coalesce(c.ie_situacao,'A') = 'A'
and	coalesce(c.ie_horario_especial,'N') = 'N'
and	coalesce(c.dt_fim_horario::text, '') = ''
and	coalesce(c.dt_suspensao::text, '') = ''
and	a.nr_atendimento = nr_atendimento_p
and	a.dt_prescricao > clock_timestamp() - interval '500 days'
and	c.dt_horario > clock_timestamp() - interval '500 days'
and	a.dt_validade_prescr between clock_timestamp() and dt_fim_w +3
and	b.nr_seq_proc = cd_item_p
and	coalesce(b.cd_intervalo,'XPTO') = coalesce(cd_intervalo_p,'XPTO')
and	(((ie_reaprazar_seguintes_p = 'S' AND c.dt_horario >= dt_horario_p) or
	  (ie_reaprazar_seguintes_p = 'N' AND c.dt_horario = dt_horario_p and qt_minutos_w > 0)) or (c.dt_horario = dt_horario_p and qt_minutos_w < 0))
and	ie_tipo_item_p = 'E'
order by 1,2;

c02 CURSOR FOR
SELECT	a.nr_prescricao nr_prescricao,
		b.nr_sequencia nr_seq_item,
		c.nr_sequencia nr_seq_hor,
		c.dt_horario dt_horario,
		b.ie_agrupador,
		b.ie_via_aplicacao,
		a.cd_setor_atendimento
from	prescr_mat_hor c,
		prescr_material b,
		prescr_medica a
where	c.nr_prescricao = b.nr_prescricao
and		c.nr_seq_material = b.nr_sequencia
and		b.nr_prescricao = a.nr_prescricao
and		obter_se_prescr_lib_adep(a.dt_liberacao_medico, a.dt_liberacao, a.dt_liberacao_farmacia, ie_data_lib_prescr_w) = 'S'
and		coalesce(a.ie_adep,'S') = 'S'
and		b.ie_agrupador in (1)
and		coalesce(c.ie_situacao,'A') = 'A'
and		coalesce(c.ie_horario_especial,'N') = 'N'
and		coalesce(c.ie_adep,'S') = 'S'
and		coalesce(c.dt_suspensao::text, '') = ''
and		obter_se_prescr_adep(a.nr_prescricao, b.nr_sequencia, nr_prescricao_p, nr_seq_item_p, nr_prescricoes_w) = 'S'
and		a.dt_validade_prescr > clock_timestamp()
and		b.cd_material = cd_item_p
and		coalesce(b.cd_intervalo,'XPTO') = coalesce(cd_intervalo_p,'XPTO')
and		coalesce(b.qt_dose,1) = coalesce(qt_item_p,1)
and		((a.nr_prescricao = nr_prescricao_p) or (coalesce(nr_prescricao_p::text, '') = ''))
and		Obter_se_horario_liberado(c.dt_lib_horario, c.dt_horario) = 'S'
and		a.nr_atendimento = nr_atendimento_p
and		ie_tipo_item_p = 'M';


BEGIN

nr_prescricoes_w	:= replace(nr_prescricoes_p,' ','');

if (nr_atendimento_p IS NOT NULL AND nr_atendimento_p::text <> '') and (ie_tipo_item_p IS NOT NULL AND ie_tipo_item_p::text <> '') and (dt_horario_p IS NOT NULL AND dt_horario_p::text <> '') and (dt_horario_desejado_p IS NOT NULL AND dt_horario_desejado_p::text <> '') and (nr_prescricoes_w IS NOT NULL AND nr_prescricoes_w::text <> '') and (ie_laboratorio_p IS NOT NULL AND ie_laboratorio_p::text <> '') and (nm_usuario_p IS NOT NULL AND nm_usuario_p::text <> '') then

	qt_minutos_w := (dt_horario_desejado_p - dt_horario_p) * 1440;


	CALL wheb_assist_pck.set_informacoes_usuario(cd_estabelecimento_p, obter_perfil_ativo, nm_usuario_p);
	ie_data_proc_w			:= wheb_assist_pck.obterParametroFuncao(924, 223);
	ie_data_lib_prescr_w		:= wheb_assist_pck.obterParametroFuncao(1113, 115);
	ie_exibe_suspenso_w		:= wheb_assist_pck.obterParametroFuncao(1113, 117);

	dt_fim_w	:= clock_timestamp() + interval '3 days';

	cd_setor_pac_w := Obter_Unidade_Atendimento(nr_atendimento_p, 'IA', 'CS');

	/* obter diferença horário */

	open c01;
	loop
	fetch c01 into
		nr_prescricao_w,
		nr_seq_item_w,
		nr_seq_horario_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
		begin

		if (nr_prescricao_w = nr_prescricao_p) and (nr_prescricao_p IS NOT NULL AND nr_prescricao_p::text <> '') and (nr_seq_item_p	= nr_seq_item_w) then
			ie_adep_w	:= 'S';
		elsif (nr_prescricoes_w IS NOT NULL AND nr_prescricoes_w::text <> '') then
			ie_adep_w	:= obter_se_valor_contido(nr_prescricao_w, nr_prescricoes_w);
		else
			ie_adep_w	:= 'S';
		end if;

		if (ie_adep_w	= 'S') then
			ds_lista_eliminados_w := Obter_horarios_eliminados(cd_estabelecimento_p, nm_usuario_p, nr_atendimento_p, ie_tipo_item_p, cd_item_p, cd_intervalo_p, ie_laboratorio_p, nr_prescricao_w, nr_seq_item_w, qt_minutos_w, ds_lista_eliminados_w, ie_reaprazar_seguintes_p, nr_seq_horario_w);
		end if;
		end;
	end loop;
	close c01;

	ds_erro_p	:= '';
	ie_primeiro_horario_w	:= null;

	open C02;
	loop
	fetch C02 into
		nr_prescricao_w,
		nr_seq_item_w,
		nr_seq_horario_w,
		dt_horario_w,
		ie_agrupador_w,
		ie_via_aplicacao_w,
		cd_setor_atendimento_w;
	EXIT WHEN NOT FOUND; /* apply on C02 */
		begin

 		-- Se for primeiro horário do item a ser reaprazado  e 'horários seguintes marcado' não validar!
		if (coalesce(ie_primeiro_horario_w::text, '') = '') then
		    select	coalesce(max('N'),'S')
			into STRICT	ie_primeiro_horario_w
			from	prescr_mat_hor
			where	nr_prescricao = nr_prescricao_w
			and		nr_seq_material = nr_seq_item_w
			and		dt_horario < dt_horario_p
			and		coalesce(ie_horario_especial,'N') = 'N'
			and		coalesce(dt_suspensao::text, '') = '';
		end if;

		if	(ie_primeiro_horario_w = 'S' AND ie_reaprazar_seguintes_p = 'S') then
			Exit;
		end if;
		-- Fim valida se é prim. horario
		-- Bucar menor horário do item
		select	coalesce(min(dt_horario),dt_horario_p)
		into STRICT	dt_menor_horario_w
		from	prescr_mat_hor
		where	nr_prescricao = nr_prescricao_w
		and		nr_seq_material = nr_seq_item_w
		and		dt_horario < dt_horario_p
		and		coalesce(ie_horario_especial,'N') = 'N'
		and		coalesce(dt_suspensao::text, '') = '';

		--Buscar maior horário anterior ao que está sendo reaprazado
		select	coalesce(max(dt_horario),dt_horario_p)
		into STRICT	dt_maior_horario_w
		from	prescr_mat_hor
		where	nr_prescricao = nr_prescricao_w
		and		nr_seq_material = nr_seq_item_w
		and		dt_horario between dt_menor_horario_w and dt_horario_p
		and		dt_horario <> dt_horario_p
		and		coalesce(ie_horario_especial,'N') = 'N'
		and		coalesce(dt_suspensao::text, '') = '';

		if (ie_primeiro_horario_w = 'S') then

		    -- Pega o maior horário do item
			select	coalesce(max(dt_horario),dt_horario_p)
			into STRICT	dt_maior_horario_w
			from	prescr_mat_hor
			where	nr_prescricao = nr_prescricao_w
			and		nr_seq_material = nr_seq_item_w
			and		dt_horario <> dt_horario_p
			and		coalesce(ie_horario_especial,'N') = 'N'
			and		coalesce(dt_suspensao::text, '') = '';

			--Pega o 'segundo'  horário pra ter como base de comparação com o primeiro e identificar qtd de horas entre o 1º e 2º horário
			select	coalesce(min(dt_horario),dt_horario_p)
			into STRICT	dt_menor_horario_w
			from	prescr_mat_hor
			where	nr_prescricao = nr_prescricao_w
			and		nr_seq_material = nr_seq_item_w
			and		dt_horario between dt_horario_p and dt_maior_horario_w
			and		dt_horario <> dt_horario_p
			and		coalesce(ie_horario_especial,'N') = 'N'
			and		coalesce(dt_suspensao::text, '') = '';

			if (dt_horario_desejado_p <> dt_horario_w) then
				ds_erro_w := verifica_intervalo_horas(nr_prescricao_w, nr_seq_item_w, cd_setor_atendimento_w, cd_item_p, ie_via_aplicacao_w, abs(dt_menor_horario_w - dt_horario_desejado_p) * 24, ds_erro_w, ie_agrupador_w);

		     	if (ds_erro_w IS NOT NULL AND ds_erro_w::text <> '') then
					ds_erro_p := ds_erro_w;
				end if;
			end if;

			exit;

		else

		    if (dt_horario_desejado_p <> dt_horario_w) then
				ds_erro_w := verifica_intervalo_horas(nr_prescricao_w, nr_seq_item_w, cd_setor_atendimento_w, cd_item_p, ie_via_aplicacao_w, abs(dt_maior_horario_w - dt_horario_desejado_p) * 24, ds_erro_w, ie_agrupador_w);

		     	if (ds_erro_w IS NOT NULL AND ds_erro_w::text <> '') then
					ds_erro_p := ds_erro_w;
					exit;
				end if;
			end if;

		end if;

		end;
	end loop;
	close C02;

end if;

ds_lista_eliminados_p := ds_lista_eliminados_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE consiste_reaprazar_horario ( cd_estabelecimento_p bigint, nr_atendimento_p bigint, ie_tipo_item_p text, cd_item_p text, cd_intervalo_p text, qt_item_p bigint, dt_horario_p timestamp, dt_horario_desejado_p timestamp, ie_reaprazar_seguintes_p text, nr_prescricoes_p text, nr_prescricao_p bigint, nr_seq_item_p bigint, ie_laboratorio_p text, nr_seq_motivo_p bigint, ds_justificativa_p text, nm_usuario_p text, ds_lista_eliminados_p INOUT text, nr_seq_proc_interno_p bigint, ds_erro_p INOUT text) FROM PUBLIC;

