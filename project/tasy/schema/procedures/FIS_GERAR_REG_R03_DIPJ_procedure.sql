-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE fis_gerar_reg_r03_dipj ( nr_seq_controle_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint, dt_inicio_p timestamp, dt_fim_p timestamp, cd_empresa_p bigint, qt_linha_p INOUT bigint, nr_sequencia_p INOUT bigint) AS $body$
DECLARE

 
 
cd_cnpj_w			varchar(14);
nm_repres_w			varchar(255);
cd_cpf_repres_w			varchar(255);
nr_ddd_telefone_repres_w	varchar(255);
nr_telefone_repres_w		varchar(255);
nr_ddd_fax_repres_w		varchar(255);
nr_fax_repres_w			varchar(255);
ds_email_repres_w		varchar(255);
nm_respo_w			varchar(255);
cd_cpf_respo_w			varchar(255);
cd_prof_respo_w			varchar(255);
sg_estado_respo_w		varchar(255);
nr_ddd_telefone_respo_w		varchar(255);
nr_telefone_respo_w		varchar(255);
nr_ddd_fax_respo_w		varchar(255);
nr_fax_respo_w			varchar(255);
ds_email_respo_w		varchar(255);

nr_linha_w			bigint := qt_linha_p;
nr_seq_registro_w		bigint := nr_sequencia_p;
ds_arquivo_w			varchar(4000);
ds_arquivo_compl_w		varchar(4000);
ds_linha_w			varchar(8000);
sep_w				varchar(1) := '|';
ie_arquivo_w			varchar(15);
nr_ramal_resp_w			compl_pessoa_fisica.nr_ramal%type;
nr_ramal_repres_w		compl_pessoa_fisica.nr_ramal%type;

c01 CURSOR FOR 
	SELECT a.cd_cgc cd_cnpj, 
		obter_nome_pf(e.cd_titular) nm_repres, 
		obter_dados_pf(e.cd_titular, 'CPF') cd_cpf_repres, 
		substr(obter_dados_pf_pj(e.cd_titular, null, 'DDT'),1,4) nr_ddd_telefone_repres, 
		substr(obter_dados_pf_pj(e.cd_titular, null, 'T'),1,9) nr_telefone_repres, 
		substr(obter_dados_pf_pj(e.cd_titular, null, 'DDF'),1,4) nr_ddd_fax_repres, 
		substr(obter_dados_pf_pj(e.cd_titular, null, 'FAX'),1,9) nr_fax_repres, 
		substr(obter_dados_pf_pj(e.cd_titular, null, 'M'),1,115) ds_email_repres, 
		obter_nome_pf(e.cd_contabilista) nm_respo, 
		obter_dados_pf(e.cd_contabilista, 'CPF') cd_cpf_respo, 
		obter_dados_pf(e.cd_contabilista,'CPR') cd_prof_respo, 
		substr(obter_dados_pf_pj(e.cd_contabilista, null, 'UF'),1,2) sg_estado_respo, 
		substr(obter_dados_pf_pj(e.cd_contabilista, null, 'DDT'),1,4) nr_ddd_telefone_respo, 
		substr(obter_dados_pf_pj(e.cd_contabilista, null, 'T'),1,9) nr_telefone_respo, 
		substr(obter_dados_pf_pj(e.cd_contabilista, null, 'DDF'),1,4) nr_ddd_fax_respo, 
		substr(obter_dados_pf_pj(e.cd_contabilista, null, 'FAX'),1,9) nr_fax_respo, 
		substr(obter_dados_pf_pj(e.cd_contabilista, null, 'M'),1,115) ds_email_respo, 
		substr(obter_dados_pf_pj(e.cd_contabilista, null, 'RAM'),1,5) nr_ramal_resp, 
		substr(obter_dados_pf_pj(e.cd_titular, null, 'RAM'),1,5) nr_ramal_repres 
	from	estabelecimento a, 
		empresa e 
	where	a.cd_empresa		= e.cd_empresa 
	and	a.cd_estabelecimento	= cd_estabelecimento_p;


BEGIN 
open c01;
loop 
fetch c01 into	 
	cd_cnpj_w, 
	nm_repres_w, 
	cd_cpf_repres_w, 
	nr_ddd_telefone_repres_w, 
	nr_telefone_repres_w, 
	nr_ddd_fax_repres_w,	 
	nr_fax_repres_w,	 
	ds_email_repres_w, 
	nm_respo_w, 
	cd_cpf_respo_w, 
	cd_prof_respo_w, 
	sg_estado_respo_w, 
	nr_ddd_telefone_respo_w, 
	nr_telefone_respo_w, 
	nr_ddd_fax_respo_w, 
	nr_fax_respo_w, 
	ds_email_respo_w, 
	nr_ramal_resp_w, 
	nr_ramal_repres_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	begin	 
	 
	ds_linha_w	:= substr(	'R03' 						|| 
					' '						|| 
					rpad('0',4,'0')					|| 
					cd_cnpj_w 					|| 
					'0'						|| 
					'0'						|| 
					rpad(coalesce(nm_repres_w, ' '),150,' ')		|| 
					cd_cpf_repres_w					|| 
					rpad(coalesce(nr_ddd_telefone_repres_w, ' '),4,' ')	|| 
					rpad(coalesce(nr_telefone_repres_w, ' '),9,' ')	|| 
					rpad(coalesce(to_char(nr_ramal_repres_w), ' '), 5, ' ')	|| 
					rpad(coalesce(nr_ddd_fax_repres_w, ' '),4,' ')	|| 
					rpad(coalesce(nr_fax_repres_w, ' '),9,' ')		|| 
					rpad(coalesce(ds_email_repres_w, ' '),115,' ')	|| 
					rpad(coalesce(nm_respo_w, ' '),150,' ')		|| 
					cd_cpf_respo_w					|| 
					rpad(coalesce(cd_prof_respo_w, ' '),15,' ')		|| 
					rpad(coalesce(sg_estado_respo_w,' '),2,' ')		|| 
					rpad(coalesce(nr_ddd_telefone_respo_w, ' '),4,' ')	|| 
					rpad(coalesce(nr_telefone_respo_w, ' '),9,' ')	|| 
					rpad(coalesce(to_char(nr_ramal_resp_w), ' '),5,' ')		|| 
					rpad(coalesce(nr_ddd_fax_respo_w, ' '),4,' ')	|| 
					rpad(coalesce(nr_fax_respo_w, ' '),9,' ')		|| 
					rpad(coalesce(ds_email_respo_w, ' '),115,' ')	|| 
					rpad(' ',10,' '),1,8000);
	 
	ds_arquivo_w		:= substr(ds_linha_w,1,4000);
	ds_arquivo_compl_w	:= substr(ds_linha_w,4001,4000);
	nr_seq_registro_w	:= nr_seq_registro_w + 1;
	nr_linha_w 		:= nr_linha_w + 1;
	 
	insert into fis_dipj_registro(nr_sequencia, 
		nm_usuario, 
		dt_atualizacao, 
		nm_usuario_nrec, 
		dt_atualizacao_nrec, 
		nr_seq_controle_dipj, 
		nr_linha, 
		cd_registro, 
		ds_arquivo, 
		ds_arquivo_compl) 
	values (nr_seq_registro_w, 
		nm_usuario_p, 
		clock_timestamp(), 
		nm_usuario_p, 
		clock_timestamp(), 
		nr_seq_controle_p, 
		nr_linha_w, 
		'R03', 
		ds_arquivo_w, 
		ds_arquivo_compl_w);
	end;
end loop;
close c01;
 
commit;
 
qt_linha_p	:= nr_linha_w;
nr_sequencia_p	:= nr_seq_registro_w;	
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE fis_gerar_reg_r03_dipj ( nr_seq_controle_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint, dt_inicio_p timestamp, dt_fim_p timestamp, cd_empresa_p bigint, qt_linha_p INOUT bigint, nr_sequencia_p INOUT bigint) FROM PUBLIC;

