-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';



CREATE TYPE campos_Original AS (nr_sequencia			bigint,
		nr_seq_pacote 			bigint,
		ie_valor_informado 		varchar(1),
		vl_material 			double precision,
		vl_material_tiss		double precision,
		vl_repasse_calc   		double precision,
		vl_unitario 			double precision);
CREATE TYPE campos AS (nr_seq_pacote bigint);


CREATE OR REPLACE PROCEDURE atualizar_material_pacote ( nr_atendimento_p bigint, nr_interno_conta_p bigint, cd_convenio_p bigint, nm_usuario_p text) AS $body$
DECLARE


----------------------------------------------------------------------------------------------------
		ie_valor_inf_pacote_w	varchar(01);
		nr_seq_valor_desc_w		bigint;		

type Vetor_Original is
	table of campos_original index by integer;

x integer := 1;
Vetor_Pacote_Original_w		Vetor_Original;
-----------------------------------------------------------------------------------------------------
type vetor is table of campos index by integer;
i integer := 1;
vetor_pacote_w				vetor;
ie_material_ok_w			boolean;
nr_sequencia_w				bigint;
dt_conta_w					timestamp;
cd_material_w				bigint;
cd_material_ww				bigint;
cd_material_q_w				bigint;
ie_tipo_acomod_w			varchar(2);
cd_grupo_material_w			bigint;
cd_subgrupo_material_w		bigint;
cd_classe_material_w		bigint;
nr_seq_pacote_w				bigint;
nr_seq_pac_mat_w			bigint;
qt_dias_pacote_w			integer;
qt_dias_uti_w				integer;
qt_dias_hospital_w			integer;
ie_excedente_w				smallint;
ie_inclui_exclui_w			varchar(01);
dt_inicio_pacote_w			timestamp;
dt_final_pacote_w			timestamp;
nr_seq_procedimento_w		bigint;
cd_convenio_w				integer;
cd_categoria_w				varchar(10);
qt_limite_w					double precision;
qt_acumulado_w				double precision;
qt_material_w				double precision;
cd_setor_atendimento_w		bigint;
ie_tipo_atendimento_w		smallint;
cd_setor_pacote_w			bigint;
nr_seq_tipo_acomod_w		bigint;
ie_exige_gabarito_w			varchar(01);
qt_regra_w					bigint;
cd_estabelecimento_w		smallint;
qt_regras_w					smallint := 0;
nr_sequencia_pacote_w		bigint;
ie_regra_w					integer := 0;
cd_motivo_exc_conta_w		bigint;
nr_seq_gerada_w				bigint;
qt_regra_valor_w			bigint;
vl_unitario_w				double precision;
vl_material_w				double precision;
vl_mat_conta_w				double precision;
nr_interno_conta_w			bigint;
nr_conta_compl_w			bigint;
qt_idade_paciente_w			smallint;
pr_desconto_w				double precision;
nr_prescricao_w				bigint;
nr_sequencia_prescricao_w	integer;
ie_objetivo_w				varchar(1);
cd_local_estoque_w			smallint;
dt_atualizacao_estoque_w	timestamp;
cd_mat_w					bigint;
nr_conta_w					bigint;
vl_mat_dia_w				double precision;
ds_erro_w					varchar(2000);
ie_atualizar_itens_pcte_w	varchar(1);
nr_seq_pacote_mat_w			bigint;
ie_inclui_exclui_www		varchar(1);
ds_msg_w					varchar(255):= '';
ie_agrupar_itens_w			varchar(1);
ie_ordem_w					smallint;
cd_material_agrup_w			integer;
cd_material_agrup_ww		integer;
ds_material_agrup_w			varchar(255);
cd_classif_setor_w			varchar(2);
ie_consiste_dias_setores_uti_w		varchar(1);
ie_consiste_cirurgia_w		varchar(1);
nr_cirurgia_pacote_w		bigint;
nr_cirurgia_w				bigint;
cd_material_acum_w			bigint;
cd_material_ant_w			bigint;
cd_classe_acum_w			integer;
cd_classe_ant_w				integer;
cd_subgrupo_acum_w			pacote_material.cd_subgrupo_material%type;
cd_subgrupo_ant_w			pacote_material.cd_subgrupo_material%type;
cd_grupo_acum_w				pacote_material.cd_grupo_material%type;
cd_grupo_ant_w				pacote_material.cd_grupo_material%type;
nr_seq_familia_w			bigint;
dt_atendimento_w			timestamp;
nr_interno_conta_ww			bigint;
nr_seq_proc_origem_w		bigint;
ie_somente_referencia_w		varchar(1):= 'N';
ie_sexo_w					varchar(1);
nr_seq_regra_lanc_w			bigint;
ie_inserir_item_zerado_w	varchar(1);
cd_setor_pacote_aux_w		bigint;
qt_regra_setor_exclusivo_w	bigint;
ie_setor_exclusivo_w		varchar(1);
cd_centro_custo_w			integer;
ie_ratear_item_w			varchar(1);
vl_negociado_w				double precision;
dt_limite_uti_w				timestamp;
dt_limite_setores_w			timestamp;
cd_classe_material_ww		estrutura_material_v.cd_classe_material%type;
vl_cotacao_w				COTACAO_MOEDA.vl_cotacao%type;
cd_moeda_pacote_w			PACOTE.cd_moeda%type;
ie_consiste_limite_item_w	pacote_material.ie_consiste_limite_item%type := 'N';

vl_mat_orig_w				material_atend_paciente.vl_material%type;
vl_unit_mat_orig_w			material_atend_paciente.vl_unitario%type;
ie_valor_informado_w		varchar(1);
nr_seq_proc_pacote_w		bigint;
vl_material_inform_w		double precision;
vl_material_tiss_inform_w	double precision;
vl_repasse_calc_inform_w	double precision;
vl_unitario_inform_w		double precision;

cd_situacao_glosa_w		material_atend_paciente.cd_situacao_glosa%type;
ie_resp_cred_manual_w		material_atend_paciente.ie_responsavel_credito%type;
vl_mat_informado_w		double precision;
cd_local_estoque_mat_w		material_atend_paciente.cd_local_estoque%type;

ie_clinica_w			atendimento_paciente.ie_clinica%type;
ie_tipo_convenio_aux2_w		convenio.ie_tipo_convenio%type;
ie_classif_contabil_w		convenio.ie_classif_contabil%type;
dt_entrada_w			atendimento_paciente.dt_entrada%type;
cd_conta_receita_w		material_atend_paciente.cd_conta_contabil%type;
cd_plano_w			atend_categoria_convenio_v.cd_plano_convenio%type;
ie_complexidade_sus_w		sus_procedimento.ie_complexidade%type;
ie_tipo_financ_sus_w		sus_procedimento.ie_tipo_financiamento%type;
cd_sequencia_parametro_w	procedimento_paciente.cd_sequencia_parametro%type;

c010 CURSOR FOR
SELECT nr_seq_pacote,
	dt_inicio_pacote,
 	dt_final_pacote,
	ie_excedente,
	nr_seq_procedimento,
	ie_tipo_acomod,
	cd_setor_exclusivo,
	nr_seq_tipo_acomod,
	coalesce(ie_exige_gabarito,'N'),
	a.nr_sequencia,
	a.qt_dias_uti,
	a.qt_dias_hospital,
	coalesce(ie_consiste_cirurgia,'N'),
	coalesce(a.nr_seq_proc_origem,0)
from	conta_paciente c,
	procedimento_paciente b,
	atendimento_pacote a
where 	a.nr_atendimento	= nr_atendimento_p
and	c.nr_interno_conta	= nr_interno_conta_p
and 	a.cd_convenio		= cd_convenio_p
and 	a.nr_seq_procedimento	= b.nr_sequencia
and 	b.nr_interno_conta	= c.nr_interno_conta
and	c.ie_status_acerto	= 1
order by
	nr_seq_alocacao,
	dt_inicio_pacote;

c020 CURSOR FOR
SELECT 	1 ie_ordem,
	nr_sequencia,
	a.cd_material,
	dt_conta,
	qt_material,
	c.ie_tipo_atendimento,
	a.cd_setor_atendimento,
	a.nr_seq_proc_pacote,
	a.vl_unitario,
	a.vl_material,
	a.nr_prescricao,
	a.nr_sequencia_prescricao,
	--obter_total_mat_dia(a.dt_atendimento, a.nr_interno_conta, a.cd_material),   tdpaula em 23/10/2010 os260821 - substituido por um select ao  abrir o  cursor
	0 cd_mat_agrup,
	a.dt_atendimento,
	a.nr_interno_conta,
	a.nr_seq_regra_lanc,
	d.cd_classe_material,
	a.cd_local_estoque
from 	atendimento_paciente c,
 	conta_paciente b,
	material_atend_paciente a,
	estrutura_material_v d
where ((a.nr_atendimento = nr_atendimento_p) or ((c.nr_atendimento_mae = nr_atendimento_p) and (c.ie_trat_conta_rn = obter_desc_expressao(962487)))) --os 224852
  --and a.nr_atendimento		= b.nr_atendimento --os 224852
  and b.nr_interno_conta	= nr_interno_conta_p
  and a.nr_atendimento		= c.nr_atendimento
  and a.nr_interno_conta	= b.nr_interno_conta
  and a.cd_material		= d.cd_material
  and to_char(a.cd_setor_atendimento)	= coalesce(cd_setor_pacote_w, a.cd_setor_atendimento) -- incluido o to_char os 232149
  and to_char(a.cd_convenio)	= cd_convenio_p /* to_char - para nao pegar indice matpaci_cat_conv_fk_i*/
  and a.dt_conta between dt_inicio_pacote_w and dt_final_pacote_w
  and coalesce(a.cd_motivo_exc_conta::text, '') = ''
  and b.ie_status_acerto = 1
  and ((ie_atualizar_itens_pcte_w = 'S') or ((ie_atualizar_itens_pcte_w = 'N') and (coalesce(a.nr_seq_proc_pacote::text, '') = '')))
  and ((ie_agrupar_itens_w = 'N') or ((ie_agrupar_itens_w = 'S') and (coalesce(obter_material_agrup(a.cd_material,2),0) = 0)))
  and ((ie_somente_referencia_w = 'N') or ((ie_somente_referencia_w = 'S') and (coalesce(a.nr_seq_proc_princ, 0) = nr_seq_proc_origem_w)))
  and ((ie_inserir_item_zerado_w = 'S') or ((	SELECT	sum(x.qt_material)
						from	material_atend_paciente x
						where	x.nr_interno_conta = a.nr_interno_conta
						and	x.cd_material = a.cd_material
						and	coalesce(x.nr_seq_proc_pacote::text, '') = ''	) <> 0))

union all

select  2 ie_ordem,
	nr_sequencia,
	a.cd_material,
	dt_conta,
	qt_material,
	c.ie_tipo_atendimento,
	a.cd_setor_atendimento,
	a.nr_seq_proc_pacote,
	a.vl_unitario,
	a.vl_material,
	a.nr_prescricao,
	a.nr_sequencia_prescricao,
	--obter_total_mat_dia(a.dt_atendimento, a.nr_interno_conta, a.cd_material),
	obter_material_agrup(a.cd_material,2) cd_mat_agrup,
	a.dt_atendimento,
	a.nr_interno_conta,
	a.nr_seq_regra_lanc,
	d.cd_classe_material,
	a.cd_local_estoque
from 	atendimento_paciente c,
 	conta_paciente b,
	material_atend_paciente a,
	estrutura_material_v d
where a.nr_atendimento		= nr_atendimento_p
  and a.nr_atendimento		= b.nr_atendimento
  and b.nr_interno_conta	= nr_interno_conta_p
  and a.nr_atendimento		= c.nr_atendimento
  and a.nr_interno_conta		= b.nr_interno_conta
  and a.cd_material		= d.cd_material
  and a.cd_setor_atendimento	= coalesce(cd_setor_pacote_w, a.cd_setor_atendimento)
  and to_char(a.cd_convenio)	= cd_convenio_p /* to_char - para nao pegar indice matpaci_cat_conv_fk_i*/
  and a.dt_conta between dt_inicio_pacote_w and dt_final_pacote_w
  and coalesce(a.cd_motivo_exc_conta::text, '') = ''
  and b.ie_status_acerto = 1
  and ((ie_atualizar_itens_pcte_w = 'S') or ((ie_atualizar_itens_pcte_w = 'N') and (coalesce(a.nr_seq_proc_pacote::text, '') = '')))
  and ((ie_agrupar_itens_w = 'S') and (coalesce(obter_material_agrup(a.cd_material,2),0) > 0))
  and ((ie_somente_referencia_w = 'N') or ((ie_somente_referencia_w = 'S') and (coalesce(a.nr_seq_proc_princ, 0) = nr_seq_proc_origem_w)))
  and ((ie_inserir_item_zerado_w = 'S') or ((	select	sum(x.qt_material)
						from	material_atend_paciente x
						where	x.nr_interno_conta = a.nr_interno_conta
						and	x.cd_material = a.cd_material
						and	coalesce(x.nr_seq_proc_pacote::text, '') = ''	) <> 0))
order by ie_ordem,
	cd_mat_agrup,
	cd_classe_material,
	cd_material,
	cd_setor_atendimento,
	dt_conta,
	qt_material;

c030 CURSOR FOR
	SELECT	ie_inclui_exclui,
		ie_excedente,
		coalesce(qt_limite,0),
		dividir(coalesce(pr_desconto,0),100),
		a.nr_sequencia,
		a.cd_material,
		a.cd_classe_material,
		a.cd_subgrupo_material,
		a.cd_grupo_material,
		a.ie_setor_exclusivo,
		coalesce(a.ie_ratear_item,'S'),
		a.vl_negociado,
		coalesce(a.ie_consiste_limite_item,'N')
	from	pacote_material a
	where	a.nr_seq_pacote					= nr_seq_pacote_w
	and	(((coalesce(ie_considera_generico, 'N') = 'N') and coalesce(a.cd_material,cd_material_w)			= cd_material_ww) or (coalesce(a.cd_material::text, '') = '')  or (coalesce(ie_considera_generico, 'N') = 'S')  and (obter_se_mat_generico(a.cd_material, cd_material_w) = 'S'))
	and	coalesce(a.cd_classe_material,cd_classe_material_w)	= cd_classe_material_w
	and	coalesce(a.cd_subgrupo_material,cd_subgrupo_material_w)= cd_subgrupo_material_w
	and	coalesce(a.cd_grupo_material,cd_grupo_material_w)	= cd_grupo_material_w
	and	coalesce(a.cd_setor_atendimento,cd_setor_atendimento_w)= cd_setor_atendimento_w
	and	coalesce(a.ie_tipo_atendimento,ie_tipo_atendimento_w)	= ie_tipo_atendimento_w
	and	qt_idade_paciente_w		between coalesce(qt_idade_min, 0) and coalesce(qt_idade_max, 999)	-- edgar 06/10/2005 os 23079
	and	((coalesce(a.ie_objetivo::text, '') = '') or (a.ie_objetivo = ie_objetivo_w))
	and	((ie_exige_gabarito_w = 'N') or (nr_seq_pac_acomod = nr_seq_tipo_acomod_w))
	and	((ie_valor	= 'N') or
		((ie_valor	= 'U') and (vl_unitario_w <= vl_maximo) and (vl_unitario_w >= vl_minimo)) or
		((ie_valor	= 'T') and (vl_material_w <= vl_maximo) and (vl_material_w >= vl_minimo)) or
		((ie_valor	= 'C') and (vl_mat_conta_w <= vl_maximo) and (vl_mat_conta_w >= vl_minimo)))
	and	coalesce(a.nr_seq_familia,nr_seq_familia_w)	= nr_seq_familia_w
	and	coalesce(ie_sexo, coalesce(ie_sexo_w,'A'))	= coalesce(ie_sexo_w,'A')
	and	((coalesce(ie_somente_sem_rla,'N')='N') or (coalesce(ie_somente_sem_rla,'N') = 'S' and coalesce(nr_seq_regra_lanc_w::text, '') = ''))
	and	coalesce(cd_centro_custo, coalesce(cd_centro_custo_w, 0)) = coalesce(cd_centro_custo_w, 0)
	and	((coalesce(nr_seq_estrutura::text, '') = '') or (consistir_se_mat_estrut_vig(nr_seq_estrutura,cd_material_w, dt_atendimento_w) = 'S'))
	and 	coalesce(a.cd_local_estoque,coalesce(cd_local_estoque_mat_w,0)) = coalesce(cd_local_estoque_mat_w,0)
	order by
		coalesce(a.cd_material, 0),
	  	coalesce(a.cd_classe_material, 0),
	  	coalesce(a.cd_subgrupo_material, 0),
	  	coalesce(a.cd_grupo_material, 0),
		coalesce(a.cd_setor_atendimento, 0),
		coalesce(a.ie_tipo_atendimento, 0),
		coalesce(a.ie_objetivo, 0),
		coalesce(a.nr_seq_familia,0),
		coalesce(a.ie_sexo, 'A'),
		coalesce(cd_centro_custo, 0),
		coalesce(nr_seq_estrutura,0),
		coalesce(a.cd_local_estoque,0);

c033 CURSOR FOR
	SELECT	a.ie_inclui_exclui,
		a.ie_excedente,
		coalesce(a.qt_limite,0),
		dividir(coalesce(a.pr_desconto,0),100),
		a.nr_sequencia		
	from	pacote_material a,
		pacote_material_adic b
	where	a.nr_seq_pacote					= nr_seq_pacote_w
	and	a.nr_seq_pacote					= b.nr_seq_pacote
	and	a.nr_sequencia					= b.nr_seq_mat
	and	(((coalesce(ie_considera_generico, 'N') = 'N') and coalesce(b.cd_material,cd_material_w)			= cd_material_ww) or (coalesce(b.cd_material::text, '') = '')  or (coalesce(ie_considera_generico, 'N') = 'S')  and (obter_se_mat_generico(b.cd_material, cd_material_w) = 'S'))
	and	coalesce(a.cd_setor_atendimento,cd_setor_atendimento_w)= cd_setor_atendimento_w
	and	coalesce(a.ie_tipo_atendimento,ie_tipo_atendimento_w)	= ie_tipo_atendimento_w
	and	qt_idade_paciente_w		between coalesce(qt_idade_min, 0) and coalesce(qt_idade_max, 999)	-- edgar 06/10/2005 os 23079
	and	((coalesce(a.ie_objetivo::text, '') = '') or (a.ie_objetivo = ie_objetivo_w))
	and	((ie_exige_gabarito_w = 'N') or (nr_seq_pac_acomod = nr_seq_tipo_acomod_w))
	and	((ie_valor	= 'N') or
		((ie_valor	= 'U') and (vl_unitario_w <= vl_maximo) and (vl_unitario_w >= vl_minimo)) or
		((ie_valor	= 'T') and (vl_material_w <= vl_maximo) and (vl_material_w >= vl_minimo)) or
		((ie_valor	= 'X') and (vl_mat_dia_w <= vl_maximo) and (vl_material_w >= vl_minimo)) or
		((ie_valor	= 'C') and (vl_mat_conta_w <= vl_maximo) and (vl_mat_conta_w >= vl_minimo)))
	and	coalesce(ie_sexo, coalesce(ie_sexo_w, 'A')) = coalesce(ie_sexo_w, 'A')
	and	((coalesce(ie_somente_sem_rla,'N')='N') or (coalesce(ie_somente_sem_rla,'N') = 'S' and coalesce(nr_seq_regra_lanc_w::text, '') = ''))
	and	coalesce(a.cd_centro_custo, coalesce(cd_centro_custo_w, 0)) = coalesce(cd_centro_custo_w, 0)
	and	((coalesce(a.nr_seq_estrutura::text, '') = '') or (consistir_se_mat_estrut_vig(a.nr_seq_estrutura,cd_material_w, dt_atendimento_w) = 'S'))
	and 	coalesce(a.cd_local_estoque,coalesce(cd_local_estoque_mat_w,0)) = coalesce(cd_local_estoque_mat_w,0)
	order by
		coalesce(b.cd_material, 0),
		coalesce(a.cd_setor_atendimento, 0),
		coalesce(a.ie_tipo_atendimento, 0),
		coalesce(a.ie_objetivo, 0),
		coalesce(a.ie_sexo, 'A'),
		coalesce(a.cd_centro_custo, 0),
		coalesce(a.nr_seq_estrutura, 0);


c040 CURSOR FOR
	SELECT	dt_inicio_pacote,
		dt_final_pacote,
		ie_excedente,
		cd_setor_atendimento
	from atend_pacote_regra
	where nr_seq_pacote = nr_sequencia_pacote_w
	  and nr_atendimento = nr_atendimento_p
	order by dt_inicio_pacote;

c050 CURSOR FOR
	SELECT	nr_sequencia,
		ie_valor_informado,
		nr_seq_proc_pacote,
		vl_material,
		vl_material_tiss,
		vl_repasse_calc,
		vl_unitario,
		cd_situacao_glosa
	from 	conta_paciente b,
		material_atend_paciente a
	where	a.nr_atendimento	= nr_atendimento_p
	and	a.nr_interno_conta	= nr_interno_conta_p
	and	a.cd_convenio		= cd_convenio_p
	and	a.nr_interno_conta	= b.nr_interno_conta
	and	a.nr_sequencia		<> coalesce(a.nr_seq_proc_pacote, 0)
	and	b.ie_status_acerto	= 1
	and	coalesce(a.cd_motivo_exc_conta::text, '') = '';

c060 CURSOR FOR
	SELECT	nr_sequencia
	from 	conta_paciente b,
		material_atend_paciente a
	where	a.nr_atendimento	= nr_atendimento_p
	and	a.nr_interno_conta	= nr_interno_conta_p
	and	a.cd_convenio		= cd_convenio_p
	and	a.nr_interno_conta	= b.nr_interno_conta
	and	coalesce(a.nr_seq_proc_pacote::text, '') = ''
	and	b.ie_status_acerto	= 1
	and	coalesce(a.cd_motivo_exc_conta::text, '') = '';



BEGIN

select	a.cd_estabelecimento,
	obter_idade(b.dt_nascimento, clock_timestamp(), 'A'),
	coalesce(ie_sexo,'A'),
	a.ie_clinica,
	dt_entrada
into STRICT	cd_estabelecimento_w,
	qt_idade_paciente_w,
	ie_sexo_w,
	ie_clinica_w,
	dt_entrada_w
from	pessoa_fisica b,
	atendimento_paciente a
where	a.nr_atendimento	= nr_atendimento_p
and	a.cd_pessoa_fisica	= b.cd_pessoa_fisica;

ie_atualizar_itens_pcte_w	:= 	obter_valor_param_usuario(67,228,obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w);
ie_agrupar_itens_w	  	:=	obter_valor_param_usuario(67,253,obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w);
ie_consiste_dias_setores_uti_w	:= 	obter_valor_param_usuario(67,304,obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w);
ie_somente_referencia_w		:= 	coalesce(obter_valor_param_usuario(67,482,obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w),'N');
ie_inserir_item_zerado_w	:=	coalesce(obter_valor_param_usuario(67,630,obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w),'S');

SELECT * FROM obter_convenio_particular(cd_estabelecimento_w, cd_convenio_w, cd_categoria_w) INTO STRICT cd_convenio_w, cd_categoria_w;

select	max(cd_motivo_exc_conta),
	coalesce(max(ie_valor_inf_pacote),'N')
into STRICT	cd_motivo_exc_conta_w,
	ie_valor_inf_pacote_w
from	parametro_faturamento
where	cd_estabelecimento	= cd_estabelecimento_w;

select 	count(*)
into STRICT	qt_regra_valor_w
from	pacote_material b,
	pacote a
where	a.nr_seq_pacote  = b.nr_seq_pacote
and	a.cd_convenio = cd_convenio_w
and	coalesce(ie_valor,'N') <>  'N';

-------------------------------------------------------------
open c050; --- MATERIAL_ATEND_PACIENTE
loop
fetch c050 into
	nr_sequencia_w,
	ie_valor_informado_w,
	nr_seq_proc_pacote_w,
	vl_material_inform_w,
	vl_material_tiss_inform_w,
	vl_repasse_calc_inform_w,
	vl_unitario_inform_w,
	cd_situacao_glosa_W;
EXIT WHEN NOT FOUND; /* apply on c050 */
	begin
	
	x := coalesce(Vetor_Pacote_Original_w.Count,0) + 1;

	Vetor_Pacote_Original_w[x].nr_seq_pacote	:= nr_seq_proc_pacote_w;
	Vetor_Pacote_Original_w[x].nr_sequencia		:= nr_sequencia_w;
	Vetor_Pacote_Original_w[x].ie_valor_informado	:= ie_valor_informado_w;
	Vetor_Pacote_Original_w[x].vl_material		:= vl_material_inform_w;
	Vetor_Pacote_Original_w[x].vl_material_tiss	:= vl_material_tiss_inform_w;
	Vetor_Pacote_Original_w[x].vl_repasse_calc	:= vl_repasse_calc_inform_w;
	Vetor_Pacote_Original_w[x].vl_unitario		:= vl_unitario_inform_w;

	if ((coalesce(cd_situacao_glosa_w,0) not in (8,10,23)) and (coalesce(ie_resp_cred_manual_w,'N') = 'N')) then	
		
		update	material_atend_paciente
		set	nr_seq_proc_pacote 	 = NULL,
			ie_valor_informado 	= 'N'
		where	nr_sequencia		= nr_sequencia_w;

		if (ie_valor_informado_w = 'S') and (ie_valor_inf_pacote_w	= 'N') then
			CALL atualiza_preco_material(nr_sequencia_w, nm_usuario_p);

			select	coalesce(max(vl_material), 0)
			into STRICT	vl_mat_informado_w
			from	material_atend_paciente
			where	nr_sequencia = nr_sequencia_w;

			if (vl_mat_informado_w = 0) then
				update	material_atend_paciente
				set	nr_seq_proc_pacote	 = NULL,
					ie_valor_informado	= 'S',
					vl_material		= vl_material_inform_w,
					vl_material_tiss	= vl_material_tiss_inform_w,
					vl_repasse_calc 	= vl_repasse_calc_inform_w,
					vl_unitario		= vl_unitario_inform_w
				where	nr_sequencia		= nr_sequencia_w;
			end if;
		end if;
		
	end if;
	
	end;
end loop;
close c050;
-------------------------------------------------------------
open c010;
loop
fetch c010 into
 	nr_seq_pacote_w,
	dt_inicio_pacote_w,
	dt_final_pacote_w,
	ie_excedente_w,
	nr_seq_procedimento_w,
	ie_tipo_acomod_w,
	cd_setor_pacote_w,
	nr_seq_tipo_acomod_w,
	ie_exige_gabarito_w,
	nr_sequencia_pacote_w,
	qt_dias_uti_w,
	qt_dias_hospital_w,
	ie_consiste_cirurgia_w,
	nr_seq_proc_origem_w;
	EXIT WHEN NOT FOUND; /* apply on c010 */

	cd_material_q_w		:= 0;
	cd_material_agrup_ww	:= 0;
	qt_acumulado_w		:= 0;
	ds_material_agrup_w	:= '';
	ie_inclui_exclui_w 	:= 'E';

	cd_material_ant_w	:= 0;
	cd_classe_ant_w		:= 0;
	cd_subgrupo_ant_w	:= 0;
	cd_grupo_ant_w		:= 0;

	if (ie_consiste_cirurgia_w = 'S') then
		select	coalesce(somente_numero(obter_dados_propaci('NC',nr_seq_proc_origem)),0)
		into STRICT	nr_cirurgia_pacote_w
		from 	atendimento_pacote
		where	nr_atendimento = nr_atendimento_p
		and 	nr_sequencia = nr_sequencia_pacote_w;
	end if;

	select	count(*)
	into STRICT	qt_regra_setor_exclusivo_w
	from	pacote_material
	where	nr_seq_pacote = nr_seq_pacote_w
	and	coalesce(ie_setor_exclusivo,'N') = 'S';

	cd_setor_pacote_aux_w	:= null;

	if (qt_regra_setor_exclusivo_w > 0) then
		cd_setor_pacote_aux_w	:= cd_setor_pacote_w;
		cd_setor_pacote_w	:= null;
	end if;

	open c020;
	loop
	fetch c020 into
		ie_ordem_w,
		nr_sequencia_w,
		cd_material_w,
		dt_conta_w,
		qt_material_w,
		ie_tipo_atendimento_w,
		cd_setor_atendimento_w,
		nr_seq_pac_mat_w,
		vl_unitario_w,
		vl_material_w,
		nr_prescricao_w,
		nr_sequencia_prescricao_w,
	--	vl_mat_dia_w,
		cd_material_agrup_w,
		dt_atendimento_w,
		nr_interno_conta_ww,
		nr_seq_regra_lanc_w,
		cd_classe_material_ww,
		cd_local_estoque_mat_w;
	EXIT WHEN NOT FOUND; /* apply on c020 */

/* marcus em 08/2/2005 os14482 */

	vl_mat_conta_w		:= 0;
	cd_sequencia_parametro_w := null;
	if (qt_regra_valor_w > 0) then
		select	sum(vl_material)
		into STRICT	vl_mat_conta_w
		from	material_atend_paciente
		where	nr_atendimento		= nr_atendimento_p
		and	nr_interno_conta	= nr_interno_conta_p
		and	cd_material		= cd_material_w;
	end if;

/* tdpaula em 23/10/2010 os260821 */


/*SO-2220426*/

	select  coalesce(sum(vl_material), 0)
	into STRICT    vl_mat_dia_w
	from    material_atend_paciente
	where   nr_interno_conta        = nr_interno_conta_ww
	and     cd_material             = cd_material_w
	and     coalesce(cd_motivo_exc_conta::text, '') = ''
	and     dt_atendimento between ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_atendimento_w) and ESTABLISHMENT_TIMEZONE_UTILS.endOfDay(coalesce(dt_atendimento_w,clock_timestamp()));


	ie_material_ok_w := false;
	if (nr_seq_pac_mat_w IS NOT NULL AND nr_seq_pac_mat_w::text <> '') and (vetor_pacote_w.count >= 1) then
		for i in 1..vetor_pacote_w.count loop
			if (nr_seq_pac_mat_w = vetor_pacote_w[i].nr_seq_pacote) then
				ie_material_ok_w := true;
				exit;
			end if;
		end loop;
	end if;

	if (not ie_material_ok_w) then

		ie_inclui_exclui_w 	:= 'I';
		if (cd_material_w	<> cd_material_q_w) then
			select	coalesce(max(cd_material_agrup),cd_material_w)
			into STRICT	cd_material_ww
			from	material_agrup
			where	cd_material			= cd_material_w
			and	ie_motivo			= 2;

			select 	cd_grupo_material,
				cd_subgrupo_material,
				cd_classe_material,
				coalesce(nr_seq_familia,0)
			into STRICT	cd_grupo_material_w,
				cd_subgrupo_material_w,
				cd_classe_material_w,
				nr_seq_familia_w
			from 	estrutura_material_v
			where 	cd_material			= cd_material_w;

			/* para o parametro [253] funcionar corretamente e necessario que o material agrupador esteja apontando para ele proprio, por exemplo os itens 1,2,3 e 4 irao agrupar no item 5.
			portanto no cadastro de material todos os itens 1,2,3,4, inclusive o 5 devem estar informado que o material agrupador sera o 5 */
			if (ie_agrupar_itens_w = 'S') and (ie_ordem_w = 2) and (cd_material_agrup_ww  <> cd_material_ww) then
				ds_material_agrup_w:= '';
				qt_acumulado_w	:= 0;
			end if;
			/*felipe martini  em 23/02/2009 os 128431
			deve-se limpar a variavel qt_acumulado_w sempre que nao haver um material agrupador.
			*/
			if (ie_agrupar_itens_w	= 'S') and (ie_ordem_w		= 1) then
				qt_acumulado_w		:= 0;
			end if;

			cd_material_agrup_ww	:=  cd_material_ww;
			ds_material_agrup_w	:=  cd_material_agrup_ww; -- guarda os itens que sao provenientes desse agrupamento e que irao influenciar no excedente
			cd_material_q_w		:=  cd_material_w;

			-- retirado o if abaixo (os 157858)

			--if	(ie_agrupar_itens_w = 'N') then

			--	qt_acumulado_w	:= 0;

			--end if;
		end if;
		qt_regra_w			:= 0;

		begin
		select	max(ie_objetivo)
		into STRICT	ie_objetivo_w
		from	prescr_material
		where	nr_prescricao	= nr_prescricao_w
		and	nr_sequencia	= nr_sequencia_prescricao_w;
		exception
		when others then
			ie_objetivo_w	:= null;
		end;

		ie_ratear_item_w	:= 'S';

		select 	max(cd_centro_custo)
		into STRICT	cd_centro_custo_w
		from 	setor_atendimento
		where 	cd_setor_atendimento = cd_setor_atendimento_w;


		if (coalesce(nr_interno_conta_p,0) > 0) then
			/*SE TEM MOEDA NO PACOTE, ENTAO VERIFICA SE TEM VALOR DE COTAcaO*/


			/* CASO EXISTA VALOR, ENTAO CONVERTE OS VALORES DO PROCEDIMENTO */

			begin
				select 	cd_moeda
				into STRICT 	cd_moeda_pacote_w
				from 	pacote
				where   nr_seq_pacote = nr_seq_pacote_w;
			exception
			when others then
				cd_moeda_pacote_w := null;
			end;

			 /*GRAVAR_LOG_CLIENTE('***ATUALIZA MAT*** INICIO');*/

			if (coalesce(cd_moeda_pacote_w,0) > 0) then
				/*obtem a cotacao mais atual*/

				vl_cotacao_w 		:= obter_valor_convertido_cotacao(nr_interno_conta_p,cd_moeda_pacote_w);

				 /*GRAVAR_LOG_CLIENTE('Valor cotacao = '||vl_cotacao_w);*/

				if (vl_cotacao_w > 0) then
					if (coalesce(vl_unitario_w,0) >0) then
						vl_unitario_w 	:= (vl_unitario_w / vl_cotacao_w);
					end if;

					if (coalesce(vl_material_w,0) >0) then
						vl_material_w 	:= (vl_material_w/vl_cotacao_w);
					end if;

					if (coalesce(vl_mat_conta_w,0) >0) then
						vl_mat_conta_w	:= (vl_mat_conta_w/vl_cotacao_w);
					end if;
				 end if;
				 /*GRAVAR_LOG_CLIENTE('vl_unitario_w convertido= '||vl_unitario_w);
				 GRAVAR_LOG_CLIENTE('vl_material_w convertido= '||vl_material_w);
				 GRAVAR_LOG_CLIENTE('vl_mat_conta_w convertido= '||vl_mat_conta_w);*/
			end if;
			/*GRAVAR_LOG_CLIENTE('***ATUALIZA MAT*** FIM');*/

		end if;

	------verifica os criterios pela estrutura
		open c030; -- PACOTE_MATERIAL
		loop
		fetch c030 into
			ie_inclui_exclui_w,
			ie_excedente_w,
			qt_limite_w,
			pr_desconto_w,
			nr_seq_pacote_mat_w,
			cd_material_acum_w,
			cd_classe_acum_w,
			cd_subgrupo_acum_w,
			cd_grupo_acum_w,
			ie_setor_exclusivo_w,
			ie_ratear_item_w,
			vl_negociado_w,
			ie_consiste_limite_item_w;
		EXIT WHEN NOT FOUND; /* apply on c030 */
			ie_inclui_exclui_w	:= ie_inclui_exclui_w;
			nr_seq_pacote_mat_w	:= nr_seq_pacote_mat_w;
			qt_regra_w		:= qt_regra_w + 1;
		end loop;
		close c030;

		if (coalesce(cd_material_acum_w,0) > 0) and (cd_material_ant_w <> cd_material_w) and (ie_agrupar_itens_w = 'N') then
			qt_acumulado_w	:= 0;
		elsif (coalesce(cd_classe_acum_w,0) > 0) and (cd_classe_ant_w <> cd_classe_material_w) and (ie_agrupar_itens_w = 'N') then
			qt_acumulado_w	:= 0;
		elsif (coalesce(cd_subgrupo_acum_w,0) > 0) and (cd_subgrupo_ant_w <> cd_subgrupo_material_w) and (ie_agrupar_itens_w = 'N') then
			qt_acumulado_w	:= 0;
		elsif (coalesce(cd_grupo_acum_w,0) > 0) and (cd_grupo_ant_w <> cd_grupo_material_w) and (ie_agrupar_itens_w = 'N') then
			qt_acumulado_w	:= 0;
		elsif (ie_consiste_limite_item_w = 'S') and (cd_material_ant_w <> cd_material_w) and (ie_agrupar_itens_w = 'N') then
			qt_acumulado_w	:= 0;
		end if;

		pr_desconto_w			:= coalesce(pr_desconto_w,0);
		ie_inclui_exclui_www		:= ie_inclui_exclui_w;

		open c033;
		loop
		fetch c033 into
			ie_inclui_exclui_w,
			ie_excedente_w,
			qt_limite_w,
			pr_desconto_w,
			nr_seq_pacote_mat_w;
		EXIT WHEN NOT FOUND; /* apply on c033 */
			ie_inclui_exclui_w	:= ie_inclui_exclui_w;
			nr_seq_pacote_mat_w	:= nr_seq_pacote_mat_w;
			qt_regra_w		:= qt_regra_w + 1;
		end loop;
		close c033;

		pr_desconto_w			:= coalesce(pr_desconto_w,0);
		ie_inclui_exclui_www		:= ie_inclui_exclui_w;

		if (qt_regra_w = 0) and (ie_exige_gabarito_w = 'S') then
			goto proximo;
		end if;

		if (coalesce(cd_setor_pacote_aux_w,0) > 0) and (coalesce(ie_setor_exclusivo_w,'N') = 'N') and (cd_setor_pacote_aux_w <> cd_setor_atendimento_w) then
			goto proximo;
		end if;

		select 	coalesce(max(cd_classif_setor),3)
		into STRICT	cd_classif_setor_w
		from 	setor_atendimento
		where 	cd_setor_atendimento = cd_setor_atendimento_w;

		if (ie_consiste_dias_setores_uti_w = 'R') then

			select 	Obter_Data_UTI_Setor(nr_atendimento_p, dt_inicio_pacote_w, dt_final_pacote_w, coalesce(qt_dias_uti_w,0), 'UTI'),
				Obter_Data_UTI_Setor(nr_atendimento_p, dt_inicio_pacote_w, dt_final_pacote_w, coalesce(qt_dias_hospital_w,0), 'SETOR')
			into STRICT	dt_limite_uti_w,
				dt_limite_setores_w
			;

			if	((cd_classif_setor_w = 4) and ((coalesce(qt_dias_uti_w,0) = 0) or (dt_conta_w  > dt_limite_uti_w))) then
				ie_inclui_exclui_w:= 'E';
			elsif	((cd_classif_setor_w <> 4) and ((coalesce(qt_dias_hospital_w,0) = 0) or (dt_conta_w  > dt_limite_setores_w))) then
				ie_inclui_exclui_w:= 'E';
			end if;

		elsif (ie_consiste_dias_setores_uti_w = 'S') then
			/*SO-2220426*/

			if	((cd_classif_setor_w = 4) and (((ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_conta_w) - ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_inicio_pacote_w)) > qt_dias_uti_w) or (qt_dias_uti_w = 0))) then
				ie_inclui_exclui_w:= 'E';
			elsif	((cd_classif_setor_w = 1) and (((ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_conta_w) - ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_inicio_pacote_w)) > coalesce(qt_dias_hospital_w,0)))) then
				ie_inclui_exclui_w:= 'E';
			elsif	((cd_classif_setor_w not in (1,4)) and (((ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_conta_w) - ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_inicio_pacote_w)) > coalesce(qt_dias_hospital_w,0)))) then
				ie_inclui_exclui_w:= 'E';
			end if;

		end if;

		if (ie_consiste_cirurgia_w = 'S') and (nr_cirurgia_pacote_w <> 0) then

			select 	coalesce(nr_cirurgia,0)
			into STRICT	nr_cirurgia_w
			from 	material_atend_paciente
			where 	nr_sequencia = nr_sequencia_w;

			if	(nr_cirurgia_w <> nr_cirurgia_pacote_w AND nr_cirurgia_w <> 0) then
				ie_inclui_exclui_w:= 'E';
			end if;

		end if;


		/* elemar em 20/02/04 os5276 */

		if (ie_inclui_exclui_w = 'I') then
			select	count(*)
			into STRICT	qt_regras_w
			from atend_pacote_regra
			where nr_seq_pacote	= nr_sequencia_pacote_w
			  and nr_atendimento	= nr_atendimento_p;

			if (qt_regras_w > 0) then
				ie_regra_w := 0;
				open c040;
				loop
					fetch c040 into dt_inicio_pacote_w,
							dt_final_pacote_w,
							ie_excedente_w,
							cd_setor_pacote_w;
					EXIT WHEN NOT FOUND; /* apply on c040 */


					if (coalesce(cd_setor_pacote_w::text, '') = '') or (cd_setor_pacote_w = cd_setor_atendimento_w) then
						if (dt_conta_w	>= dt_inicio_pacote_w) and (dt_conta_w	<= dt_final_pacote_w) then
							ie_regra_w := 1;
							if (ie_excedente_w = 1) then /* conta particular */
								update material_atend_paciente
								set 	nr_interno_conta	 = NULL,
									cd_convenio		= cd_convenio_w,
									cd_categoria		= cd_categoria_w,
									nr_seq_proc_pacote	 = NULL
								where nr_sequencia		= nr_sequencia_w;
								CALL atualiza_preco_material(nr_sequencia_w,nm_usuario_p);
							end if;
						end if;
					end if;
				end loop;
				close c040;
			end if;
		end if;

		if (ie_regra_w = 0) then /* elemar em 20/02/04 os5276 */
			
			select	coalesce(max(ie_tipo_convenio),0),
				max(ie_classif_contabil)
			into STRICT	ie_tipo_convenio_aux2_w,
				ie_classif_contabil_w
			from	convenio
			where	cd_convenio	= cd_convenio_p;
			
			/* obter o tipo de acomodacao do convenio */

			begin
				select	cd_plano_convenio
				into STRICT	cd_plano_w
				from	atend_categoria_convenio_v
				where	nr_atendimento	= nr_atendimento_p
				and	cd_convenio	= cd_convenio_p
				and	cd_categoria	= cd_categoria_w;
				exception
						when others then
						begin
						select	cd_plano_convenio
						into STRICT	cd_plano_w
						from	atend_categoria_convenio_v
						where	nr_atendimento	= nr_atendimento_p
						and	cd_convenio	= cd_convenio_p;
						exception
							when others then
							cd_plano_w		:= null;
						end;					
			end;
			
			if (nr_interno_conta_w IS NOT NULL AND nr_interno_conta_w::text <> '') and (ie_tipo_convenio_aux2_w = 3) then
				
				SELECT * FROM sus_obter_complex_financ_aih(nr_interno_conta_w, ie_complexidade_sus_w, ie_tipo_financ_sus_w) INTO STRICT ie_complexidade_sus_w, ie_tipo_financ_sus_w;

			end if;
			
			begin
				SELECT * FROM define_conta_material(
					cd_estabelecimento_w, cd_material_w, 1, ie_clinica_w, cd_setor_atendimento_w, ie_classif_contabil_w, ie_tipo_atendimento_w, ie_tipo_convenio_aux2_w, cd_convenio_p, cd_categoria_w, cd_local_estoque_w, null, dt_entrada_w, cd_conta_receita_w, cd_centro_custo_w, cd_plano_w, 'S', null, ie_complexidade_sus_w, ie_tipo_financ_sus_w) INTO STRICT cd_conta_receita_w, cd_centro_custo_w;
					
					cd_sequencia_parametro_w := philips_contabil_pck.get_parametro_conta_contabil();
			end;
			------verifica os criterios pela quantidade
			if (ie_inclui_exclui_w = 'I') then
				/* elemar - foi incluido este if abaixo em 22/05/03 para acertar no hvc*/

				if (qt_limite_w > 0) then
					if	/* (qt_material_w > qt_limite_w) or elemar - 08/06/04 - pode gerar erro */
						((qt_acumulado_w + qt_material_w) > qt_limite_w) then
						/* elemar - 08/06/04 - desdobrar material excedente ao pacote*/

						if (ie_exige_gabarito_w = 'S')  or (qt_limite_w > 0) then
							if	((qt_limite_w - qt_acumulado_w) > 0) then
								delete FROM material_repasse
								where nr_seq_material = nr_sequencia_w;

								/*fabio os34145 - passei para n para nao atualizar o estoque e abaixo update para atualizar o

local*/
								nr_seq_gerada_w := duplicar_mat_paciente(nr_sequencia_w, nm_usuario_p, 'N', nr_seq_gerada_w);
								CALL duplicar_mat_atend_pac_conv(nr_sequencia_w, nr_seq_gerada_w, nm_usuario_p);

								select	cd_material,
									nr_interno_conta
								into STRICT	cd_mat_w,
									nr_conta_w
								from	material_atend_paciente
								where	nr_sequencia = nr_sequencia_w;


								update material_atend_paciente
								set	qt_material	  = (qt_limite_w - qt_acumulado_w),
									nr_seq_proc_pacote= nr_seq_procedimento_w,
									cd_conta_contabil     	= cd_conta_receita_w,
									cd_centro_custo_receita	= CASE WHEN cd_centro_custo_w=0 THEN null  ELSE cd_centro_custo_w END ,
									vl_unitario	  = (vl_unitario / CASE WHEN qt_material=0 THEN 1  ELSE qt_material END ) * (qt_limite_w - qt_acumulado_w),
									vl_material	  = (vl_material / CASE WHEN qt_material=0 THEN 1  ELSE qt_material END ) * (qt_limite_w - qt_acumulado_w),
									cd_sequencia_parametro = cd_sequencia_parametro_w
								where nr_sequencia = nr_sequencia_w;

								CALL gerar_log_pacote(nr_conta_w, nr_seq_procedimento_w, WHEB_MENSAGEM_PCK.get_texto(301543,'CD_MAT_W='|| CD_MAT_W ||';NR_SEQUENCIA_W='|| NR_SEQUENCIA_W), nm_usuario_p,null,null);
															/*Atualizacao de material - #@CD_MAT_W#@ Seq. #@NR_SEQUENCIA_W#@*/

								select	cd_local_estoque,
									dt_atualizacao_estoque
								into STRICT	cd_local_estoque_w,
									dt_atualizacao_estoque_w
								from	material_atend_paciente
								where	nr_sequencia = nr_sequencia_w;

								update material_atend_paciente
								set	cd_local_estoque = cd_local_estoque_w,
									dt_atualizacao_estoque = dt_atualizacao_estoque_w,
									qt_material = ((qt_acumulado_w + qt_material_w) - qt_limite_w),
									vl_material = (vl_material / CASE WHEN qt_material=0 THEN 1  ELSE qt_material END ) * ((qt_acumulado_w + qt_material_w) - qt_limite_w)
								where nr_sequencia = nr_seq_gerada_w;

								update	material_atend_paciente
								set	vl_unitario	= (vl_material / CASE WHEN qt_material=0 THEN 1  ELSE qt_material END )
								where	nr_sequencia	= nr_seq_gerada_w;


								nr_sequencia_w	:= nr_seq_gerada_w;

							end if;
							qt_acumulado_w	:= qt_acumulado_w + qt_material_w;
						end if;

						ie_inclui_exclui_w	:= 'E';
					else
						qt_acumulado_w := qt_acumulado_w	+ qt_material_w;
					end if;
				end if;
			end if;

			------define acao sistema
			if (ie_inclui_exclui_w = 'I') then

				select	cd_material,
					nr_interno_conta
				into STRICT	cd_mat_w,
					nr_conta_w
				from	material_atend_paciente
				where	nr_sequencia = nr_sequencia_w;


				update	material_atend_paciente
				set	nr_seq_proc_pacote	= nr_seq_procedimento_w,
					cd_conta_contabil     	= cd_conta_receita_w,
					cd_centro_custo_receita	= CASE WHEN cd_centro_custo_w=0 THEN null  ELSE cd_centro_custo_w END ,
					ie_ratear_item		= ie_ratear_item_w,
					cd_sequencia_parametro = cd_sequencia_parametro_w
				where	nr_sequencia		= nr_sequencia_w;

				CALL gerar_log_pacote(nr_conta_w, nr_seq_procedimento_w, WHEB_MENSAGEM_PCK.get_texto(301543,'CD_MAT_W='|| CD_MAT_W ||';NR_SEQUENCIA_W='|| NR_SEQUENCIA_W) , nm_usuario_p,null,null);
											/*Atualizacao de material - #@CD_MAT_W#@ Seq. #@NR_SEQUENCIA_W#@*/

				if (vl_negociado_w IS NOT NULL AND vl_negociado_w::text <> '') then
					update	material_atend_paciente
					set	vl_material		= (coalesce(qt_material,1) * vl_negociado_w),
						ie_valor_informado	= 'S'
					where	nr_sequencia		= nr_sequencia_w;
				end if;

				vl_negociado_w	:= null;

			else
				pr_desconto_w := coalesce(pr_desconto_w,0);
				ds_msg_w:= '';
				if (ie_inclui_exclui_www = 'I') then
					ds_msg_w:= WHEB_MENSAGEM_PCK.get_texto(301553,
							'NR_SEQ_PROCEDIMENTO_W='|| NR_SEQ_PROCEDIMENTO_W ||
							';NR_SEQ_PACOTE_MAT_W='|| NR_SEQ_PACOTE_MAT_W );
						/*Pacote: #@NR_SEQ_PROCEDIMENTO_W#@   Regra: #@NR_SEQ_PACOTE_MAT_W#@   (I) Qtde Limite Excedente*/

				elsif (ie_inclui_exclui_www = 'E') then
					ds_msg_w:= WHEB_MENSAGEM_PCK.get_texto(301554,
							'NR_SEQ_PROCEDIMENTO_W='|| NR_SEQ_PROCEDIMENTO_W ||
							';NR_SEQ_PACOTE_MAT_W='|| NR_SEQ_PACOTE_MAT_W );
						/*Pacote: #@NR_SEQ_PROCEDIMENTO_W#@   Regra: #@NR_SEQ_PACOTE_MAT_W#@   (E) Excluido do Pacote*/

				end if;

				if (ie_agrupar_itens_w = 'S') and (ie_ordem_w = 2) then
					ds_msg_w:= WHEB_MENSAGEM_PCK.get_texto(301555,'DS_MSG_W='|| DS_MSG_W ||';DS_MATERIAL_AGRUP_W='|| DS_MATERIAL_AGRUP_W);
							/*#@DS_MSG_W#@ Material agrupamento: #@DS_MATERIAL_AGRUP_W#@*/

				end if;

				if (ie_excedente_w = 1) then /* conta particular */
					update material_atend_paciente
					set 	nr_interno_conta	 = NULL,
						cd_convenio		= cd_convenio_w,
						cd_categoria		= cd_categoria_w,
						nr_seq_proc_pacote	 = NULL,
						vl_tabela_original	= vl_material,
						vl_material		= vl_material - (vl_material * pr_desconto_w),
						vl_unitario		= vl_unitario - (vl_unitario * pr_desconto_w),
						ie_valor_informado	= CASE WHEN pr_desconto_w=0 THEN ie_valor_informado  ELSE 'S' END ,
						ds_observacao		= substr(CASE WHEN ds_msg_w = NULL THEN ds_observacao  ELSE ds_msg_w END ,1,255)
					where nr_sequencia		= nr_sequencia_w;
					CALL atualiza_preco_material(nr_sequencia_w,nm_usuario_p);
				elsif (ie_excedente_w = 2) then /* conta normal */
					update material_atend_paciente
					set 	nr_seq_proc_pacote 	 = NULL,
						vl_material		= vl_material - (vl_material * pr_desconto_w),
						vl_tabela_original	= vl_material,
						vl_unitario		= vl_unitario - (vl_unitario * pr_desconto_w),
						ie_valor_informado	= CASE WHEN pr_desconto_w=0 THEN ie_valor_informado  ELSE 'S' END ,
						ds_observacao		= substr(CASE WHEN ds_msg_w = NULL THEN ds_observacao  ELSE ds_msg_w END ,1,255)
					where nr_sequencia		= nr_sequencia_w;
				/* elemar - 08/06/04 - inclui excedentes 3 e 4 */

				elsif (ie_excedente_w = 3) then /* outra conta normal */
					begin

					select	nr_interno_conta
					into STRICT	nr_interno_conta_w
					from	material_atend_paciente
					where	nr_sequencia	= nr_sequencia_w;

					nr_conta_compl_w := obter_conta_pac_complementar(nr_interno_conta_w, nr_conta_compl_w);


					update material_atend_paciente
					set 	nr_seq_proc_pacote 	 = NULL,
						nr_interno_conta	= nr_conta_compl_w,
						vl_tabela_original	= vl_material,
						vl_material		= vl_material - (vl_material * pr_desconto_w),
						vl_unitario		= vl_unitario - (vl_unitario * pr_desconto_w),
						ie_valor_informado	= CASE WHEN pr_desconto_w=0 THEN ie_valor_informado  ELSE 'S' END ,
						ds_observacao		= substr(CASE WHEN ds_msg_w = NULL THEN ds_observacao  ELSE ds_msg_w END ,1,255)
					where nr_sequencia		= nr_sequencia_w;

					end;
				elsif (ie_excedente_w = 6) then /* outra conta normal  - status em definitivo*/
					begin

					select	nr_interno_conta
					into STRICT	nr_interno_conta_w
					from	material_atend_paciente
					where	nr_sequencia	= nr_sequencia_w;

					nr_conta_compl_w := obter_conta_pac_complementar(nr_interno_conta_w, nr_conta_compl_w);


					update material_atend_paciente
					set 	nr_seq_proc_pacote 	 = NULL,
						nr_interno_conta	= nr_conta_compl_w,
						vl_material		= vl_material - (vl_material * pr_desconto_w),
						vl_tabela_original	= vl_material,
						vl_unitario		= vl_unitario - (vl_unitario * pr_desconto_w),
						ie_valor_informado	= CASE WHEN pr_desconto_w=0 THEN ie_valor_informado  ELSE 'S' END ,
						ds_observacao		= substr(CASE WHEN ds_msg_w = NULL THEN ds_observacao  ELSE ds_msg_w END ,1,255)
					where nr_sequencia		= nr_sequencia_w;

					CALL recalcular_conta_paciente(nr_conta_compl_w, nm_usuario_p);
					CALL atualizar_resumo_conta(nr_conta_compl_w, 2);


					update	conta_paciente
					set	ie_status_acerto	= 2,
						nr_conta_pacote_exced	= nr_interno_conta_w
					where	nr_interno_conta	= nr_conta_compl_w;
					end;
				elsif (ie_excedente_w = 4) then /* mover item para excluido */
					if (coalesce(cd_motivo_exc_conta_w::text, '') = '') then
						update material_atend_paciente
						set 	nr_seq_proc_pacote 	 = NULL
						where nr_sequencia		= nr_sequencia_w;
					else
						update material_atend_paciente
						set 	nr_seq_proc_pacote 	 = NULL,
							nr_interno_conta	 = NULL,
							dt_acerto_conta		 = NULL,
							cd_motivo_exc_conta	= cd_motivo_exc_conta_w,
							ds_observacao		= substr(WHEB_MENSAGEM_PCK.get_texto(301556,'DS_OBSERVACAO_W='|| DS_OBSERVACAO ||';NR_INTERNO_CONTA_W='|| NR_INTERNO_CONTA ||';NR_SEQ_PROCEDIMENTO_W='|| NR_SEQ_PROCEDIMENTO_W),1,255) /*#@DS_OBSERVACAO_W#@ Regra pacote - Conta: #@NR_INTERNO_CONTA_W#@ - Pacote: #@NR_SEQ_PROCEDIMENTO_W#@*/
						where nr_sequencia		= nr_sequencia_w;
					end if;

				elsif (ie_excedente_w = 5) then /* dispersao */
					select	cd_material,
						nr_interno_conta
					into STRICT	cd_mat_w,
						nr_conta_w
					from	material_atend_paciente
					where	nr_sequencia = nr_sequencia_w;

					update material_atend_paciente
					set 	nr_seq_proc_pacote 	= nr_seq_procedimento_w,
						ie_dispersao		= 'S'
					where nr_sequencia		= nr_sequencia_w;

					CALL gerar_log_pacote(nr_conta_w, nr_seq_procedimento_w, WHEB_MENSAGEM_PCK.get_texto(301543,'CD_MAT_W='|| CD_MAT_W ||';NR_SEQUENCIA_W='|| NR_SEQUENCIA_W), nm_usuario_p,null,null);
												/*'Atualizacao de material - ' || cd_mat_w || ' Seq. ' || nr_sequencia_w*/

				end if;

				if (ie_excedente_w in (1,2,3,6)) and (pr_desconto_w > 0) then

					select	max(vl_material),
						max(vl_unitario)
					into STRICT	vl_mat_orig_w,
						vl_unit_mat_orig_w
					from	material_atend_paciente
					where	nr_sequencia = nr_sequencia_w;

					insert into mat_atend_pac_desc_pacote( nr_sequencia, dt_atualizacao, nm_usuario, dt_atualizacao_nrec, nm_usuario_nrec, nr_seq_matpaci, nr_seq_proc_pacote,
						vl_original, pr_desconto, vl_unitario_original)
					values ( nextval('mat_atend_pac_desc_pacote_seq'), clock_timestamp(), nm_usuario_p, clock_timestamp(), nm_usuario_p, nr_sequencia_w, nr_seq_procedimento_w,
						vl_mat_orig_w, pr_desconto_w, vl_unit_mat_orig_w
					);

				end if;

			end if;
		end if;
		<<proximo>>
		null;
	end if;

	if (cd_material_ant_w <> cd_material_w) and (ie_agrupar_itens_w = 'N') then
		cd_material_ant_w:= cd_material_w;
	end if;

	if (coalesce(cd_classe_acum_w,0) > 0) and (cd_classe_ant_w <> cd_classe_material_w) and (ie_agrupar_itens_w = 'N') then
		cd_classe_ant_w:= cd_classe_material_w;
	end if;

	if (coalesce(cd_subgrupo_acum_w,0) > 0) and (cd_subgrupo_ant_w <> cd_subgrupo_material_w) and (ie_agrupar_itens_w = 'N') then
		cd_subgrupo_ant_w:= cd_subgrupo_material_w;
	end if;

	if (coalesce(cd_grupo_acum_w,0) > 0) and (cd_grupo_ant_w <> cd_grupo_material_w) and (ie_agrupar_itens_w = 'N') then
		cd_grupo_ant_w:= cd_grupo_material_w;
	end if;

	end loop;
	close c020;
	vetor_pacote_w(coalesce(vetor_pacote_w.count,0) + 1).nr_seq_pacote := nr_seq_procedimento_w;
end loop;
close c010;

--------------------------------------------------------------
open c060; --- MATERIAL_ATEND_PACIENTE
loop
fetch c060 into
	nr_sequencia_w;
EXIT WHEN NOT FOUND; /* apply on c060 */
	begin
	
	if (ie_valor_inf_pacote_w	= 'S') then
		select	coalesce(max(nr_sequencia),0)
		into STRICT	nr_seq_valor_desc_w
		from	mat_atend_paciente_valor
		where	nr_seq_material	= nr_sequencia_w
		and	ie_tipo_valor = 96;
	
		if (nr_seq_valor_desc_w 	<> 0) then
			select	coalesce(VL_material,0)
			into STRICT	VL_material_w
			from 	mat_atend_paciente_valor
			where 	nr_seq_material		= nr_sequencia_w
			and	ie_tipo_valor		= 96
			and	nr_sequencia		= nr_seq_valor_desc_w;

			update	Material_atend_paciente
			set 	nr_seq_proc_pacote	 = NULL,
				vl_material		= VL_material_w,
				vl_tabela_original	 = NULL,
				ie_dispersao		= 'N',
				ie_valor_informado	= 'S'
			where 	nr_sequencia		= nr_sequencia_w;
		else
			update	Material_atend_paciente
			set 	nr_seq_proc_pacote	 = NULL,
				vl_material		= coalesce(vl_tabela_original,vl_material),
				vl_tabela_original	 = NULL,
				ie_dispersao		= 'N',
				ie_valor_informado	= 'N'
			where 	nr_sequencia		= nr_sequencia_w;
		end if;
	else
		for i in 1..Vetor_Pacote_Original_w.count loop
			if (Vetor_Pacote_Original_w[i].nr_sequencia = nr_sequencia_w) then
				if (Vetor_Pacote_Original_w[i].ie_valor_informado = 'S')	then
					update	material_atend_paciente
					set	nr_seq_proc_pacote	 = NULL,
						ie_valor_informado	= 'S',
						vl_material 		= Vetor_Pacote_Original_w[i].vl_material,
						vl_material_tiss 	= Vetor_Pacote_Original_w[i].vl_material_tiss,
						vl_repasse_calc 	= Vetor_Pacote_Original_w[i].vl_repasse_calc,
						vl_unitario 		= Vetor_Pacote_Original_w[i].vl_unitario
					where	nr_sequencia		= nr_sequencia_w;
				else
					update	Material_atend_paciente
					set 	vl_material		= coalesce(vl_tabela_original,vl_material),
						vl_tabela_original	 = NULL,
						ie_dispersao		= 'N'
					where 	nr_sequencia		= nr_sequencia_w;	
				end if;
				exit;
			end if;												
		end loop;
	end if;
	
	end;
end loop;
close c060;
--------------------------------------------------------------


--Guarda o valor da conta antes de executar o rateio. (Regra conta Excedente)
if (2 = philips_param_pck.get_cd_pais) and -- 2 = Mexico
	(nr_interno_conta_p IS NOT NULL AND nr_interno_conta_p::text <> '') then
	CALL atualizar_vl_conta_excedente(nr_interno_conta_p,'N',nm_usuario_p);
end if;

if (coalesce(wheb_usuario_pck.get_ie_commit, 'S') = 'S') then commit; end if;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE atualizar_material_pacote ( nr_atendimento_p bigint, nr_interno_conta_p bigint, cd_convenio_p bigint, nm_usuario_p text) FROM PUBLIC;

