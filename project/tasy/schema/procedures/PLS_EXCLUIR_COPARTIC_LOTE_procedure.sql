-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_excluir_copartic_lote ( nr_seq_lote_p bigint, nr_seq_conta_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint) AS $body$
DECLARE


/* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Finalidade: Excluir a coparticipação do lote
-------------------------------------------------------------------------------------------------------------------

Locais de chamada direta: 
[  ]  Objetos do dicionário [ X ] Tasy (Delphi/Java) [  ] Portal [  ]  Relatórios [ ] Outros:
 ------------------------------------------------------------------------------------------------------------------

Pontos de atenção:
-------------------------------------------------------------------------------------------------------------------

Referências:
	OPS - Controle de Coparticipações
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */
nr_seq_conta_coparticipacao_w		pls_lib_coparticipacao.nr_seq_conta_coparticipacao%type;
nr_seq_segurado_w			pls_lib_coparticipacao.nr_seq_segurado%type;
vl_coparticipacao_w			pls_lib_coparticipacao.vl_coparticipacao%type;
vl_coparticipacao_conta_w		pls_lib_coparticipacao.vl_coparticipacao%type;
nr_seq_copartic_w			pls_lib_coparticipacao.nr_sequencia%type;
nr_seq_conta_proc_w			pls_conta_proc.nr_sequencia%type;
nr_seq_conta_mat_w			pls_conta_mat.nr_sequencia%type;
nr_seq_analise_w			pls_analise_conta.nr_sequencia%type;
nm_beneficiario_w			varchar(255);

C01 CURSOR FOR
	SELECT	a.nr_sequencia,
		a.nr_seq_conta_coparticipacao,
		a.nr_seq_segurado,
		a.vl_coparticipacao
	from	pls_lib_coparticipacao	a
	where	a.nr_seq_lote	= nr_seq_lote_p
	and	a.nr_seq_conta	= nr_seq_conta_p;


BEGIN
vl_coparticipacao_conta_w	:= 0;

open C01;
loop
fetch C01 into
	nr_seq_copartic_w,
	nr_seq_conta_coparticipacao_w,
	nr_seq_segurado_w,
	vl_coparticipacao_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	delete	from pls_coparticipacao_critica
	where	nr_seq_lib_copartic	= nr_seq_copartic_w;
	
	delete	from pls_lib_coparticipacao
	where	nr_sequencia	= nr_seq_copartic_w;
	
	if (nr_seq_conta_coparticipacao_w IS NOT NULL AND nr_seq_conta_coparticipacao_w::text <> '') then --Voltar o status da coparticipação para pendente
	
		select	a.nr_seq_conta_proc,
			a.nr_seq_conta_mat,
			b.nr_seq_analise
		into STRICT	nr_seq_conta_proc_w,
			nr_seq_conta_mat_w,
			nr_seq_analise_w
		from	pls_conta_coparticipacao a,
			pls_conta b
		where	a.nr_seq_conta	= b.nr_sequencia
		and	a.nr_sequencia	= nr_seq_conta_coparticipacao_w;		
		
		update	pls_conta_coparticipacao
		set	ie_status_mensalidade	= 'P',
			vl_copartic_mens	 = NULL,
			tx_copartic_mens	 = NULL,
			nr_seq_regra_limite_copartic	 = NULL
		where	nr_sequencia	= nr_seq_conta_coparticipacao_w
		and	ie_status_mensalidade	= 'L';
	end if;
	
	vl_coparticipacao_conta_w	:= vl_coparticipacao_conta_w + vl_coparticipacao_w;
	end;
end loop;
close C01;

nm_beneficiario_w	:= substr(pls_obter_dados_segurado(nr_seq_segurado_w, 'N'),1,255);

CALL pls_gravar_hist_lote_copartic(	nr_seq_lote_p,
				substr('Excluída a(s) coparticipação(ões) da conta ' || nr_seq_conta_p || ' do beneficiário: ' ||nr_seq_segurado_w || ' - ' || nm_beneficiario_w ||
				' com o valor: ' || campo_mascara_virgula(vl_coparticipacao_conta_w)|| chr(13) || chr(10) ||
				'Análise = '||coalesce(nr_seq_analise_w,0)|| chr(13) || chr(10)||
				'nr_seq_conta_proc = '||coalesce(nr_seq_conta_proc_w,0)|| chr(13) || chr(10)||
				'nr_seq_conta_mat = '||coalesce(nr_seq_conta_mat_w,0),1,4000),
				nm_usuario_p,
				cd_estabelecimento_p);

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_excluir_copartic_lote ( nr_seq_lote_p bigint, nr_seq_conta_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint) FROM PUBLIC;

