-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE consistir_setor_prescr_js ( cd_setor_atendimento_p bigint, nr_atendimento_p bigint, dt_passagem_p timestamp, cd_convenio_p bigint, cd_procedimento_p bigint, ie_origem_proced_p bigint, ie_tipo_atendimento_p bigint, nr_seq_exame_p bigint, nr_seq_classificacao_p bigint, cd_categoria_p text, ie_tipo_atendimento_pac_p bigint, cd_estabelecimento_p bigint, cd_perfil_p bigint, nm_usuario_p text, cd_setor_prescricao_p bigint, cd_pessoa_fisica_p INOUT text, ie_medico_executor_p INOUT text, cd_medico_executor_p INOUT text, ie_consiste_edicao_p INOUT text, ie_proc_edicao_p INOUT text, ie_pacote_convenio_p INOUT text) AS $body$
DECLARE

ie_tipo_passagem_regra_w	varchar(1);
qt_pac_unidade_w		bigint;
ie_medico_executor_w  		varchar(1);
cd_cgc_w			varchar(14);
cd_medico_executor_w		varchar(10);
cd_pessoa_fisica_w		varchar(10);
vl_parametro_w			varchar(1);
dt_execucao_w			timestamp;		

BEGIN 
if (cd_setor_atendimento_p <> 0)then 
	begin 
	ie_tipo_passagem_regra_w	:= obter_tipo_passagem_regra(cd_setor_atendimento_p);
	if (ie_tipo_passagem_regra_w = 'T')then 
		begin 
		select 	count(*) 
		into STRICT	qt_pac_unidade_w 
		from 	atend_paciente_unidade 
		where 	nr_atendimento = nr_atendimento_p;
		if (qt_pac_unidade_w = 0)then 
			begin 
			CALL gerar_entrada_setor_prescr(	nr_atendimento_p, 
							cd_setor_atendimento_p, 
							dt_passagem_p, 
							nm_usuario_p);
			end;
		end if;
		end;
	else 
		begin 
		CALL gravar_atend_paci_uni_eup_js(	nr_atendimento_p, 
						cd_setor_atendimento_p, 
						dt_passagem_p, 
						cd_perfil_p, 
						cd_estabelecimento_p, 
						nm_usuario_p);
		end;
	end if;
	end;
end if;
--Entrada unica de pacientes 
if (obter_funcao_ativa = 916) then 
	dt_execucao_w:= clock_timestamp();
else 
	dt_execucao_w:= null;
end if;
SELECT * FROM consiste_medico_executor(	cd_estabelecimento_p, cd_convenio_p, cd_setor_atendimento_p, cd_procedimento_p, ie_origem_proced_p, ie_tipo_atendimento_p, nr_seq_exame_p, null, ie_medico_executor_w, cd_cgc_w, cd_medico_executor_w, cd_pessoa_fisica_w, null, coalesce(dt_execucao_w, coalesce(dt_passagem_p,clock_timestamp())), nr_seq_classificacao_p, 'N', null, cd_setor_prescricao_p) INTO STRICT ie_medico_executor_w, cd_cgc_w, cd_medico_executor_w, cd_pessoa_fisica_w;
cd_pessoa_fisica_p	:= cd_pessoa_fisica_w;
ie_medico_executor_p	:= ie_medico_executor_w;
cd_medico_executor_p	:= cd_medico_executor_w;	
vl_parametro_w := obter_param_usuario(916, 222, cd_perfil_p, nm_usuario_p, cd_estabelecimento_p, vl_parametro_w);			
ie_consiste_edicao_p	:= vl_parametro_w;
ie_proc_edicao_p	:= obter_se_proc_edicao(	cd_estabelecimento_p, 
							cd_convenio_p, 
							cd_categoria_p, 
							dt_passagem_p, 
							cd_procedimento_p, 
							ie_tipo_atendimento_pac_p);
ie_pacote_convenio_p	:= obter_se_pacote_convenio(	cd_procedimento_p, 
							ie_origem_proced_p, 
							cd_convenio_p, 
							cd_estabelecimento_p);
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE consistir_setor_prescr_js ( cd_setor_atendimento_p bigint, nr_atendimento_p bigint, dt_passagem_p timestamp, cd_convenio_p bigint, cd_procedimento_p bigint, ie_origem_proced_p bigint, ie_tipo_atendimento_p bigint, nr_seq_exame_p bigint, nr_seq_classificacao_p bigint, cd_categoria_p text, ie_tipo_atendimento_pac_p bigint, cd_estabelecimento_p bigint, cd_perfil_p bigint, nm_usuario_p text, cd_setor_prescricao_p bigint, cd_pessoa_fisica_p INOUT text, ie_medico_executor_p INOUT text, cd_medico_executor_p INOUT text, ie_consiste_edicao_p INOUT text, ie_proc_edicao_p INOUT text, ie_pacote_convenio_p INOUT text) FROM PUBLIC;

