-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pfcs_calculate_device_in_use ( nr_seq_indicator_p bigint, cd_estabelecimento_p text, nm_usuario_p text) AS $body$
DECLARE


	nr_seq_operational_level_w		pfcs_operational_level.nr_sequencia%type;
	pfcs_panel_detail_seq_w			pfcs_panel_detail.nr_sequencia%type;
	nr_seq_panel_w					pfcs_panel_detail.nr_seq_panel%type;
	pfcs_flag_settings          	bigint := 0;
	nr_time_for_alarms				bigint := 48;
	qt_total_in_use             	pfcs_panel.vl_indicator%type;

	ie_started_status 				varchar(5) := 'S';
	ie_finished_status 				varchar(5) := 'F';
	ie_matching_status				varchar(5) := 'S';

	ds_pat                       	varchar(15) := 'Patient';
	ds_prac             			varchar(15) := 'Practitioner';
	ds_bed_const					varchar(10) := 'Bed';
	ds_department_const				varchar(20) := 'Department';

	ds_complete_status				varchar(15) := 'COMPLETED';
	ds_active_status				varchar(15) := 'ACTIVE';
	ds_planned_status				varchar(15) := 'PLANNED';
	ds_arrived_status				varchar(15) := 'ARRIVED';

	ds_tl_dev_type 					varchar(10) := 'TL';
	ds_monitor_dev_type 			varchar(10) := 'Monitor';
	ds_service_requested      		varchar(10) := 'E0403';
	ds_service_completed			varchar(10) := 'E0404';
	ds_red_alarm_code				varchar(10) := 'A0401';
	ds_yellow_alarm_code			varchar(10) := 'A0402';
	cd_attending_role				varchar(20) := '405279007';
	 ie_active								smallint := 1;

	/* Cursor to read from pfcs integration tables */

	c01_inuse_from_pfcs CURSOR FOR
		SELECT eid.ds_value nr_encounter,
			pat.patient_id id_patient,
			pfcs_get_human_name(enc.nr_seq_patient, ds_pat) nm_patient,
			pfcs_get_tele_time(dev.nr_sequencia, ie_started_status) nr_tele_time,
			enc.ds_reason diagnosis,
			pat.birthdate dob_patiente,
             trunc(months_between(coalesce(pat.deceased_date, clock_timestamp()), pat.birthdate)/12) qt_idade_paciente,
			pat.gender gender,
			enc.ds_classification ds_classification,
			enc.period_start dt_entrance,
			pfcs_get_human_name(pfcs_get_practitioner_seq(enc.nr_sequencia, cd_attending_role), ds_prac) ds_attending_physician,
			pfcs_get_code_status_tl(pat.nr_sequencia)  ds_dnr_status,
			pfcs_get_location(enc.nr_sequencia, ds_department_const) ds_department,
			pfcs_get_location(enc.nr_sequencia, ds_bed_const) ds_bed,
			dev.id_device cd_equipamento,
			dev.ds_device_name ds_equipamento,
			pfcs_get_alarms_count(pat.nr_sequencia, ds_yellow_alarm_code, nr_time_for_alarms) nr_yellow_alarm_count,
			pfcs_get_alarms_count(pat.nr_sequencia, ds_red_alarm_code, nr_time_for_alarms) nr_red_alarm_count,
			pfcs_get_battery_status(pat.nr_sequencia) battery_status,
      pfcs_get_discharge_ord_status(enc.nr_sequencia, cd_estabelecimento_p) ie_discharge_status
		from pfcs_service_request sr,
			pfcs_encounter enc,
			pfcs_patient pat,
			pfcs_encounter_identifier eid,
			pfcs_device dev
		where
			( (sr.si_status = ds_complete_status and sr.cd_service = ds_service_completed) or (sr.si_status = ds_active_status and sr.cd_service = ds_service_requested))
			and sr.nr_seq_encounter = enc.nr_sequencia
			and enc.si_status in (ds_planned_status, ds_arrived_status)
			and eid.nr_seq_encounter = enc.nr_sequencia
			and enc.nr_seq_patient = pat.nr_sequencia
			and pat.ie_active = ie_active
			and pat.nr_seq_organization = (cd_estabelecimento_p)::numeric
			and dev.nr_seq_patient = pat.nr_sequencia
			and dev.si_status = ds_active_status
			and dev.ds_device_type = ds_monitor_dev_type;

	/*Cursor to read from tasy table */

	c01_from_tasy CURSOR FOR
		SELECT
			eq.cd_equipamento cd_equipamento,
			eq.ds_equipamento ds_equipamento,
			obter_setor_atual_paciente(cr.nr_atendimento) cd_department,
			apu.cd_unidade_basica cd_unidade_basica,
			ap.cd_pessoa_fisica id_patient,
			apu.nr_atendimento nr_encounter,
			coalesce(get_formatted_person_name(ap.cd_pessoa_fisica, 'capitalizeFirstLetter'), obter_nome_pf(ap.cd_pessoa_fisica)) nm_patient,
			ap.ds_sintoma_paciente diagnosis,
			pc_obter_dt_nascimento(ap.cd_pessoa_fisica) dob_patiente,
            obter_dados_pf(ap.cd_pessoa_fisica, 'I') qt_idade_paciente,
			substr(obter_Sexo_PF(ap.cd_pessoa_fisica,'D'),1,20) ds_gender,
			pfcs_get_time_on_tele(ap.nr_atendimento,  'TL', cd_estabelecimento_p) nr_tele_time,
			obter_desc_setor_atend(obter_setor_atual_paciente(cr.nr_atendimento)) ds_department,
			pfcs_obter_lista_dados_classif(ap.cd_pessoa_fisica) ds_classification,
			ap.dt_entrada dt_entrance,
			coalesce(get_formatted_person_name(ap.cd_medico_resp, 'capitalizeFirstLetter'), obter_nome_pf(ap.cd_medico_resp)) ds_attending_physician,
			obter_unidade_atendimento(cr.nr_atendimento,'IAA','U') ds_bed,
			pfcs_get_dnr_status(apu.nr_atendimento, cd_estabelecimento_p) ds_dnr_status,
      pfcs_get_discharge_ord_status(ap.nr_atendimento, cd_estabelecimento_p) ie_discharge_status
		from
			unidade_atend_equip uae,
			equipamento eq,
			atend_paciente_unidade apu,
			atendimento_paciente ap,
			cpoe_recomendacao cr,
			tipo_recomendacao tr,
			setor_atendimento sa
		where eq.cd_estabelecimento = (cd_estabelecimento_p)::numeric
			and eq.ie_tipo_equipamento = ds_tl_dev_type
			and uae.cd_equipamento = eq.cd_equipamento
			and ap.nr_atendimento = apu.nr_atendimento
			and apu.cd_unidade_basica = uae.cd_unidade_basica
			and apu.cd_setor_atendimento = uae.cd_setor_atendimento
			and apu.cd_unidade_compl = uae.cd_unidade_compl
			and ap.nr_atendimento = cr.nr_atendimento
			and cr.cd_recomendacao = tr.cd_tipo_recomendacao
			and uae.cd_setor_atendimento = sa.cd_setor_atendimento
			and coalesce(ap.dt_cancelamento::text, '') = ''
			and coalesce(ap.dt_alta::text, '') = ''
			and coalesce(cr.dt_suspensao::text, '') = ''
			and apu.dt_saida_unidade is  null
			and (
				pfcs_get_recommendation_status(cr.nr_sequencia) = ie_started_status or
				pfcs_get_recommendation_status(cr.nr_sequencia) = ie_finished_status)
			and tr.ie_telemetria = ie_matching_status
			and eq.cd_equipamento in (SELECT distinct uaq.cd_equipamento
					from unidade_atend_equip uaq,
						equipamento eq
					where uaq.cd_equipamento = eq.cd_equipamento
						and eq.cd_estabelecimento = (cd_estabelecimento_p)::numeric 
				);
	
BEGIN

		nr_seq_operational_level_w := pfcs_get_structure_level(
										cd_establishment_p => cd_estabelecimento_p,
										ie_level_p => 'O',
										ie_info_p => 'C');

		select ie_table_origin into STRICT pfcs_flag_settings from pfcs_general_rule where (ie_table_origin IS NOT NULL AND ie_table_origin::text <> '');

		if (pfcs_flag_settings = 0 or pfcs_flag_settings = 2)
		then
			qt_total_in_use := pfcs_get_tele_total_device(ds_tl_dev_type, 'U', cd_estabelecimento_p);

			for r_c01 in c01_from_tasy loop
				select nextval('pfcs_panel_detail_seq') into STRICT pfcs_panel_detail_seq_w;
				CALL pfcs_pck_v2.pfcs_insert_details(
					nr_seq_indicator_p => nr_seq_indicator_p,
					nr_seq_operational_level_p	=> nr_seq_operational_level_w,
					nm_usuario_p => nm_usuario_p,
					nr_panel_detail_seq_p => pfcs_panel_detail_seq_w,
					nr_encounter_p => r_c01.nr_encounter,
					id_patient_p => r_c01.id_patient,
					nm_patient_p => r_c01.nm_patient,
					dt_birthdate_p => r_c01.dob_patiente,
					ds_primary_diagnosis_p => r_c01.diagnosis,
					ds_gender_p => r_c01.ds_gender,
					ds_dnr_status_p => r_c01.ds_dnr_status,
					qt_time_telemetry_p => r_c01.nr_tele_time,
					ds_classification_p => r_c01.ds_classification,
					dt_entrance_p => r_c01.dt_entrance,
					ds_service_line_p => r_c01.ds_attending_physician,
					cd_department_p => obter_setor_atual_paciente(r_c01.nr_encounter),
					ds_department_p => obter_desc_setor_atend(obter_setor_atual_paciente(r_c01.nr_encounter)),
					ds_bed_location_p => obter_unidade_atendimento(r_c01.nr_encounter,'IAA','U'),
					cd_equipamento_p => r_c01.cd_equipamento,
					ds_device_p => r_c01.ds_equipamento,
                    ie_discharge_status_p =>  r_c01.ie_discharge_status,
                    ds_age_range_p => r_c01.qt_idade_paciente
					);

			end loop;
			 := pfcs_pck_v2.pfcs_generate_results(
				vl_indicator_p => qt_total_in_use, ds_reference_value_p => '', nr_seq_indicator_p => nr_seq_indicator_p, nr_seq_operational_level_p => nr_seq_operational_level_w, nm_usuario_p => nm_usuario_p, nr_seq_panel_p => nr_seq_panel_w);

			CALL pfcs_pck_v2.pfcs_update_detail(
				nr_seq_indicator_p => nr_seq_indicator_p,
				nr_seq_panel_p => nr_seq_panel_w,
				nr_seq_operational_level_p => nr_seq_operational_level_w,
				nm_usuario_p => nm_usuario_p);

		end if;

		if (pfcs_flag_settings = 1 or pfcs_flag_settings = 2)
		then
			qt_total_in_use := pfcs_get_tele_device_from_intg(ds_monitor_dev_type, 'U', cd_estabelecimento_p);

			for r_c01 in c01_inuse_from_pfcs loop
				select nextval('pfcs_panel_detail_seq') into STRICT pfcs_panel_detail_seq_w;
				CALL pfcs_pck_v2.pfcs_insert_details(
					nr_seq_indicator_p => nr_seq_indicator_p,
					nr_seq_operational_level_p	=> nr_seq_operational_level_w,
					nm_usuario_p => nm_usuario_p,
					nr_panel_detail_seq_p => pfcs_panel_detail_seq_w,
					nr_encounter_p => r_c01.nr_encounter,
					id_patient_p => r_c01.id_patient,
					nm_patient_p => r_c01.nm_patient,
					dt_birthdate_p => r_c01.dob_patiente,
					ds_primary_diagnosis_p => r_c01.diagnosis,
					ds_gender_p => r_c01.gender,
					ds_dnr_status_p => r_c01.ds_dnr_status,
					qt_time_telemetry_p => r_c01.nr_tele_time,
					ds_classification_p => r_c01.ds_classification,
					dt_entrance_p => r_c01.dt_entrance,
					ds_service_line_p => r_c01.ds_attending_physician,
					cd_department_p => r_c01.ds_department,
					ds_department_p => r_c01.ds_department,
					ds_bed_location_p => r_c01.ds_bed,
					qt_red_alarms_p => r_c01.nr_red_alarm_count,
					qt_yellow_alarms_p => r_c01.nr_yellow_alarm_count,
					cd_equipamento_p => r_c01.cd_equipamento,
					ds_device_p => r_c01.ds_equipamento,
					ds_battery_status_p => r_c01.battery_status,
                    ie_discharge_status_p =>  r_c01.ie_discharge_status,
                    ds_age_range_p => r_c01.qt_idade_paciente
					);

			end loop;
			 := pfcs_pck_v2.pfcs_generate_results(
				vl_indicator_p => qt_total_in_use, ds_reference_value_p => '', nr_seq_indicator_p => nr_seq_indicator_p, nr_seq_operational_level_p => nr_seq_operational_level_w, nm_usuario_p => nm_usuario_p, nr_seq_panel_p => nr_seq_panel_w);

			CALL pfcs_pck_v2.pfcs_update_detail(
				nr_seq_indicator_p => nr_seq_indicator_p,
				nr_seq_panel_p => nr_seq_panel_w,
				nr_seq_operational_level_p => nr_seq_operational_level_w,
				nm_usuario_p => nm_usuario_p);

		end if;

	commit;


	CALL pfcs_pck_v2.pfcs_activate_records(
			nr_seq_indicator_p => nr_seq_indicator_p,
			nr_seq_operational_level_p => nr_seq_operational_level_w,
			nm_usuario_p => nm_usuario_p);

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pfcs_calculate_device_in_use ( nr_seq_indicator_p bigint, cd_estabelecimento_p text, nm_usuario_p text) FROM PUBLIC;

