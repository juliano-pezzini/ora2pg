-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pfcs_length_patient_stay_day ( nr_seq_indicator_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text, qt_days_p bigint default 7) AS $body$
DECLARE


pfcs_panel_detail_seq_w		pfcs_panel_detail.nr_sequencia%type;
nr_seq_panel_w			pfcs_panel.nr_sequencia%type;
qt_total_dias_com_w		bigint := 0;
qt_total_dias_sem_w		bigint := 0;
qt_total_com_w 			bigint := 0;
qt_total_sem_w 			bigint := 0;
ie_confirmed_w			varchar(1);
nr_seq_operational_level_w  pfcs_operational_level.nr_sequencia%type;

c01 CURSOR FOR
SELECT  a.nr_atendimento nr_encounter,
        obter_sexo_pf(a.CD_PESSOA_FISICA, 'D') ds_gender,
        pfcs_get_age_range(obter_data_nascto_pf(a.CD_PESSOA_FISICA)) ds_age_range,
        Obter_Unidade_Atendimento(a.nr_atendimento,'IAA','S') ds_current_location,
        Obter_Unidade_Atendimento(a.nr_atendimento,'IAA','UB')||' '||Obter_Unidade_Atendimento(a.nr_atendimento,'IAA','UC') ds_bed_assigned,
        a.dt_entrada dt_entrance,
        round(obter_dias_internacao(a.nr_atendimento)) qt_time_total_hospitalization,
        a.dt_alta dt_discharge,
        COALESCE((SELECT	MAX('S')
                FROM atend_paciente_adic f
                    JOIN atendimento_paciente b ON f.nr_atendimento = b.nr_atendimento
                    JOIN paciente_exame e ON b.cd_pessoa_fisica = e.cd_pessoa_fisica
					WHERE   coalesce(e.dt_inativacao::text, '') = ''
                    AND     f.nr_atendimento = a.nr_atendimento
                    AND		coalesce(f.ie_atend_covid_posit, 'N') = 'S'),
			(SELECT	MAX('S')
					FROM	pfcs_diagnosis d,
							diagnostico_doenca c
					WHERE	((c.cd_doenca = d.cd_doenca) or (c.cd_doenca = replace(d.cd_doenca, '.', '')))
					AND 	c.nr_atendimento = a.nr_atendimento
					AND		coalesce(d.ie_positivo, 'N') = 'S'),
            (SELECT
                   MAX('S')
                FROM
                    prescr_procedimento   pp
                    INNER JOIN prescr_medica pm ON pp.nr_prescricao = pm.nr_prescricao
                    INNER JOIN exame_lab_result_item elri ON pp.nr_sequencia = elri.nr_seq_prescr
                    INNER JOIN exame_lab_resultado elr ON pm.nr_prescricao = elr.nr_prescricao AND elri.nr_seq_resultado = elr.nr_seq_resultado
                WHERE
                    pfcs_lab_obter_se_exame_covid(pp.nr_seq_exame) = 'S'
                    AND pm.nr_atendimento =  a.nr_atendimento
                    AND pp.ie_status_atend >= 35
                    AND (pm.dt_liberacao IS NOT NULL AND pm.dt_liberacao::text <> '')
					AND substr(UPPER(coalesce(elri.ds_resultado, 0)),1,7) = substr(UPPER(obter_desc_expressao(296109)),1,7)), 'N') ie_confirmed
from    atendimento_paciente a
where  	dt_alta > (clock_timestamp() - qt_days_p)
and 	cd_estabelecimento = cd_estabelecimento_p;

BEGIN
nr_seq_operational_level_w := pfcs_get_structure_level(
    cd_establishment_p => cd_estabelecimento_p,
    ie_level_p => 'O',
    ie_info_p => 'C');

	for c01_w in c01 loop
	begin

		if (upper(c01_w.ie_confirmed) = 'S')then
			qt_total_dias_com_w := qt_total_dias_com_w + c01_w.qt_time_total_hospitalization;
			qt_total_com_w := qt_total_com_w + 1;
			ie_confirmed_w := 'S';
		else
			qt_total_dias_sem_w := qt_total_dias_sem_w + c01_w.qt_time_total_hospitalization;
			qt_total_sem_w := qt_total_sem_w + 1;
			ie_confirmed_w := 'N';
		end if;


		select	nextval('pfcs_panel_detail_seq')
		into STRICT	pfcs_panel_detail_seq_w
		;

		insert into pfcs_panel_detail(
			nr_sequencia,
			nm_usuario,
			dt_atualizacao,
			nm_usuario_nrec,
			dt_atualizacao_nrec,
			ie_situation,
			nr_seq_indicator,
			nr_seq_operational_level)
		values (
			pfcs_panel_detail_seq_w,
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			'T',
			nr_seq_indicator_p,
			nr_seq_operational_level_w);

		insert into pfcs_detail_patient(
			nr_sequencia,
			nm_usuario,
			dt_atualizacao,
			nm_usuario_nrec,
			dt_atualizacao_nrec,
			nr_seq_detail,
			ds_gender,
			nr_encounter,
			ds_age_range,
			ds_current_location,
			dt_entrance,
			qt_time_total_hospitalization,
			dt_expected_discharge,
			ie_confirmed,
			ds_bed_assigned)
		values (
			nextval('pfcs_detail_patient_seq'),
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			pfcs_panel_detail_seq_w,
			c01_w.ds_gender,
			c01_w.nr_encounter,
			c01_w.ds_age_range,
			c01_w.ds_current_location,
			c01_w.dt_entrance,
			c01_w.qt_time_total_hospitalization,
			c01_w.dt_discharge,
			ie_confirmed_w,
			c01_w.ds_bed_assigned);

	end;
	end loop;

commit;

nm_usuario_p => nm_usuario_p := pfcs_pck.pfcs_generate_results(
		vl_indicator_p => qt_total_dias_com_w, vl_indicator_aux_p => qt_total_dias_sem_w, vl_indicator_help_p => qt_total_com_w, vl_indicator_assist_p => qt_total_sem_w, cd_reference_value_p => '1', ds_reference_value_p => obter_desc_expressao(965750), cd_reference_aux_p => '1', ds_reference_aux_p => obter_desc_expressao(965750), nr_seq_indicator_p => nr_seq_indicator_p, nr_seq_operational_level_p => nr_seq_operational_level_w, nm_usuario_p => nm_usuario_p, nr_seq_panel_p => nr_seq_panel_w);

nm_usuario_p => nm_usuario_p := pfcs_pck.pfcs_generate_results(
		vl_indicator_p => qt_total_dias_sem_w, vl_indicator_aux_p => qt_total_dias_com_w, vl_indicator_help_p => qt_total_sem_w, vl_indicator_assist_p => qt_total_com_w, nr_seq_indicator_p => nr_seq_indicator_p, cd_reference_value_p => '0', ds_reference_value_p => obter_desc_expressao(965752), cd_reference_aux_p => '0', ds_reference_aux_p => obter_desc_expressao(965752), nr_seq_operational_level_p => nr_seq_operational_level_w, nm_usuario_p => nm_usuario_p, nr_seq_panel_p => nr_seq_panel_w);


CALL pfcs_pck.pfcs_update_detail(
		nr_seq_indicator_p => nr_seq_indicator_p,
		nr_seq_panel_p => nr_seq_panel_w,
		nr_seq_operational_level_p => nr_seq_operational_level_w,
		nm_usuario_p => nm_usuario_p);

CALL pfcs_pck.pfcs_activate_records(
		nr_seq_indicator_p => nr_seq_indicator_p,
		nr_seq_operational_level_p => nr_seq_operational_level_w,
		nm_usuario_p => nm_usuario_p);


end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pfcs_length_patient_stay_day ( nr_seq_indicator_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text, qt_days_p bigint default 7) FROM PUBLIC;

