-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE consiste_prescr_material ( NR_PRESCRICAO_P bigint, NR_ATENDIMENTO_P bigint, DT_PRESCRICAO_P timestamp, CD_MATERIAL_P bigint, IE_LIBERADO_P INOUT text) AS $body$
DECLARE



qt_horas_util_pac_w		double precision;
qt_horas_util_w			double precision;
dt_prescricao_w			timestamp;



BEGIN

IE_LIBERADO_P			:= 'S';

select	coalesce(max(qt_horas_util_pac),0)
into STRICT	qt_horas_util_pac_w
from	material
where	cd_material	= cd_material_P;

if (qt_horas_util_pac_w > 0) then
	begin
	begin
	select	max(b.dt_prescricao)
	into STRICT	dt_prescricao_w
	from 	prescr_material a,
		prescr_medica b
	where	a.nr_prescricao	= b.nr_prescricao
	  and	b.nr_atendimento	= nr_atendimento_p
	  and	b.dt_prescricao 	< dt_prescricao_p
	  and	a.cd_material	= cd_material_p;
	exception
		when others then
		dt_prescricao_w 	:= dt_prescricao_p;
	end;
	qt_horas_util_w		:= ((dt_prescricao_p - dt_prescricao_w) * 24);
	if (qt_horas_util_w	< qt_horas_util_pac_w) then
		ie_liberado_p	:= 'N';
	end if;
	end;
end if;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE consiste_prescr_material ( NR_PRESCRICAO_P bigint, NR_ATENDIMENTO_P bigint, DT_PRESCRICAO_P timestamp, CD_MATERIAL_P bigint, IE_LIBERADO_P INOUT text) FROM PUBLIC;

