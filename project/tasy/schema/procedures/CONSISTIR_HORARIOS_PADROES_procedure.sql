-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE consistir_horarios_padroes ( cd_item_p text, nr_prescricoes_p text, ds_horarios_p text, nr_seq_horario_p bigint, ds_erro_p INOUT text) AS $body$
DECLARE


ds_horarios_itens_w				varchar(2000);
ds_horario_w					varchar(2000);
ds_hor_aux_w					varchar(2000);
ds_horarios_inconsistentes_w	varchar(2000);
x								bigint;
qt_horarios_prescr				bigint;
qt_horarios_itens				bigint;
ds_horarios_w					varchar(2000);


BEGIN

ds_horarios_w		:= ds_horarios_p;

ds_hor_aux_w	:= substr(replace(replace(ds_horarios_w,' ',''),':',''),1,2000);

x	:= 1;
while(x	< length(ds_horarios_w)) loop
	if (substr(ds_hor_aux_w,x,1) not in ('0','1','2','3','4','5','6','7','8','9')) then
		ds_erro_p	:= wheb_mensagem_pck.get_texto(279141);
		exit;
	end if;
	x	:= x + 1;
end loop;

ds_horarios_itens_w :=	substr(obter_horarios_item(cd_item_p, nr_prescricoes_p, nr_seq_horario_p),2,2000);

qt_horarios_prescr := obter_quantidade_horarios(ds_horarios_w);
qt_horarios_itens := obter_quantidade_horarios(ds_horarios_itens_w);

if (qt_horarios_prescr > qt_horarios_itens) or (qt_horarios_prescr < qt_horarios_itens) then
	ds_erro_p	:= wheb_mensagem_pck.get_texto(279140);
end if;

if (coalesce(ds_erro_p::text, '') = '') then
	begin
	select	max(Obter_Se_hor_validade_padrao(nr_prescricoes_p, ds_horarios_w))
	into STRICT	ds_horarios_inconsistentes_w
	;
	exception when others then
		ds_horarios_inconsistentes_w := null;
	end;

	if (ds_horarios_inconsistentes_w IS NOT NULL AND ds_horarios_inconsistentes_w::text <> '') then
		ds_erro_p	:= wheb_mensagem_pck.get_texto(279145);
	end if;
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE consistir_horarios_padroes ( cd_item_p text, nr_prescricoes_p text, ds_horarios_p text, nr_seq_horario_p bigint, ds_erro_p INOUT text) FROM PUBLIC;

