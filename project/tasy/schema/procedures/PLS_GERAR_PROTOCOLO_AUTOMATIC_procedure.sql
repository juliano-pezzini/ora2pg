-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_gerar_protocolo_automatic ( nr_seq_prestador_p bigint, dt_competencia_p timestamp, nr_seq_protocolo_p INOUT bigint, ie_tipo_protocolo_p bigint, nr_protocolo_prestador_p bigint, qt_max_contas_p bigint, cd_estabelecimento_p bigint, dt_protocolo_p timestamp, nm_usuario_p text, nr_seq_prot_referencia_p bigint, nr_seq_lote_p bigint, nr_seq_lote_apres_autom_p bigint, ie_commit_p text, dt_recebimento_p timestamp) AS $body$
DECLARE


nr_seq_protocolo_w      bigint;
nr_seq_outorgante_w	bigint;
nr_seq_lote_w		bigint;
dt_competencia_w	timestamp;
ie_data_competencia_w	pls_cta_regra_apres_aut.ie_data_competencia%type;


BEGIN
/*
ie_tipo_protocolo_p
Segundo valores do dominio 1746
*/
nr_seq_lote_w := nr_seq_lote_p;

if (nr_seq_lote_w = 0 ) then
  nr_seq_lote_w := null;
end if;

select	max(nr_sequencia)
into STRICT	nr_seq_outorgante_w
from    pls_outorgante
where   cd_estabelecimento = cd_estabelecimento_p;

select	max(ie_data_competencia)
into STRICT	ie_data_competencia_w
from	pls_cta_regra_apres_aut;

dt_competencia_w	:= dt_competencia_p;

begin
	select	dt_mes_competencia
	into STRICT	dt_competencia_w
	from	pls_lote_apres_automatica
	where	nr_sequencia = nr_seq_lote_apres_autom_p;
exception
when others then
	dt_competencia_w := null;
end;

--Se parâmetro da data competência estiver como não se aplica, então mantém comportamento da obtenção da data e 

--não atualizará a mesma se lote de apresentação automática j[á tiver data
if (coalesce(ie_data_competencia_w, 'N') = 'N') then
	if (coalesce(dt_competencia_w::text, '') = '') then
		dt_competencia_w	:= pls_obter_dataref_prot_imp( 	nr_seq_prestador_p, 'T', dt_competencia_p,
									dt_protocolo_p, dt_recebimento_p, clock_timestamp(),
									ie_tipo_protocolo_p,null, cd_estabelecimento_p);
	end if;
else --Se data competência igual a atual, sempre atualizará a dt_compeência nesse ponto
	dt_competencia_w	:= clock_timestamp();
end if;

insert into pls_protocolo_conta(nr_sequencia, nm_usuario, dt_atualizacao,
        nm_usuario_nrec, dt_atualizacao_nrec, ie_situacao,
        ie_status, dt_mes_competencia, cd_estabelecimento,
        ie_tipo_guia, ie_apresentacao, dt_protocolo,
        nr_seq_prestador, nr_protocolo_prestador, qt_contas_informadas,
	dt_base_venc, ie_tipo_protocolo, nr_seq_prot_referencia,
	nr_seq_outorgante, ie_guia_fisica, nr_seq_lote_conta,
	ie_origem_protocolo, nr_seq_lote_apres_autom, dt_recebimento)
values (nextval('pls_protocolo_conta_seq'), nm_usuario_p, clock_timestamp(),
        nm_usuario_p, clock_timestamp(), 'D',
        1, dt_competencia_w, cd_estabelecimento_p,
        ie_tipo_protocolo_p, 'A', dt_protocolo_p,
        nr_seq_prestador_p, nr_protocolo_prestador_p, qt_max_contas_p,
	clock_timestamp(), 'C', nr_seq_prot_referencia_p,
	nr_seq_outorgante_w, 'N', nr_seq_lote_w,
	'T', nr_seq_lote_apres_autom_p,coalesce(dt_competencia_p,clock_timestamp())) returning nr_sequencia into nr_seq_protocolo_p;

/*OS 404880 Diogo - adicionado o ie_commit_p para que não haja commit antes da finalização dos lotes de apresentação automática */

if (coalesce(ie_commit_p,'S')	= 'S') then
	commit;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_gerar_protocolo_automatic ( nr_seq_prestador_p bigint, dt_competencia_p timestamp, nr_seq_protocolo_p INOUT bigint, ie_tipo_protocolo_p bigint, nr_protocolo_prestador_p bigint, qt_max_contas_p bigint, cd_estabelecimento_p bigint, dt_protocolo_p timestamp, nm_usuario_p text, nr_seq_prot_referencia_p bigint, nr_seq_lote_p bigint, nr_seq_lote_apres_autom_p bigint, ie_commit_p text, dt_recebimento_p timestamp) FROM PUBLIC;

