-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_reconsistir_glosas_oc ( nr_seq_conta_p bigint, ds_param1_p text, ds_param2_p text, ds_param3_p text, nr_seq_analise_p bigint, nr_seq_grupo_atual_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text ) AS $body$
DECLARE


nr_seq_oc_benef_w		bigint;
nr_seq_analise_conta_item_w	bigint;
nr_seq_mot_lib_w		bigint;
nr_seq_conta_proc_w		bigint;
nr_seq_conta_mat_w		bigint;
nr_seq_proc_partic_w		bigint;
nr_seq_glosa_w			bigint;
ie_status_w			varchar(5);
ie_status_ww			varchar(5);
ie_consistencia_w		varchar(2);
nr_seq_glosa_oc_gerada_w	bigint;
ie_tipo_item_w			varchar(2);
nr_seq_ocorrencia_w		bigint;
ie_auditoria_conta_w		varchar(2);
ie_finalizar_analise_w		varchar(2);
ie_status_oc_w			varchar(2);
qt_existe_ocorrencia_w		bigint:= 0;
ie_situacao_w			varchar(1);
ie_origem_analise_w		bigint;

C01 CURSOR FOR
	SELECT	nr_sequencia,
		ie_situacao,
		nr_seq_proc,
		nr_seq_mat,
		nr_seq_proc_partic,
		nr_seq_ocorrencia
	from	pls_ocorrencia_benef
	where	nr_seq_conta		= nr_seq_conta_p
	and	coalesce(nr_seq_conta_pos_estab::text, '') = ''
	and	coalesce(nr_seq_requisicao::text, '') = ''
	and	coalesce(nr_seq_guia_plano::text, '') = '';

C02 CURSOR FOR
	SELECT	b.nr_sequencia,
		b.ie_situacao,
		a.nr_sequencia,
		null,
		null
	from	pls_conta_proc a,
		pls_conta_glosa b
	where	a.nr_sequencia = b.nr_seq_conta_proc
	and	a.nr_seq_conta = nr_seq_conta_p
	and	coalesce(nr_seq_ocorrencia_benef,0) = 0
	and	not exists (	SELECT	x.nr_sequencia
				from	pls_ocorrencia_benef x
				where	x.nr_seq_glosa = b.nr_sequencia	)
	
union

	select	b.nr_sequencia,
		b.ie_situacao,
		null,
		a.nr_sequencia,
		null
	from	pls_conta_mat a,
		pls_conta_glosa b
	where	a.nr_sequencia = b.nr_seq_conta_mat
	and	a.nr_seq_conta = nr_seq_conta_p
	and	coalesce(nr_seq_ocorrencia_benef,0) = 0
	and	not exists (	select	x.nr_sequencia
				from	pls_ocorrencia_benef x
				where	x.nr_seq_glosa = b.nr_sequencia	)
	
union

	select	a.nr_sequencia,
		a.ie_situacao,
		null,
		null,
		null
	from	pls_conta_glosa a
	where	a.nr_seq_conta = nr_seq_conta_p
	and	coalesce(nr_seq_ocorrencia_benef,0) = 0
	and	not exists (	select	x.nr_sequencia
				from	pls_ocorrencia_benef x
				where	x.nr_seq_glosa = a.nr_sequencia	);


BEGIN

open C02;
loop
fetch C02 into
	nr_seq_glosa_w,
	ie_status_ww,
	nr_seq_conta_proc_w,
	nr_seq_conta_mat_w,
	nr_seq_proc_partic_w;
EXIT WHEN NOT FOUND; /* apply on C02 */
	begin

	update	pls_conta_glosa
	set	ie_situacao		= 'I',
		ie_forma_inativacao	 = NULL
	where	nr_sequencia		= nr_seq_glosa_w;

	end;
end loop;
close C02;

update	pls_ocorrencia_benef
set	ie_situacao		= 'I',
	ie_forma_inativacao	 = NULL
where	nr_seq_conta		= nr_seq_conta_p
and	coalesce(nr_seq_conta_pos_estab::text, '') = ''
and	coalesce(nr_seq_requisicao::text, '') = ''
and	coalesce(nr_seq_guia_plano::text, '') = '';

open C01;
loop
fetch C01 into
	nr_seq_oc_benef_w,
	ie_status_ww,
	nr_seq_conta_proc_w,
	nr_seq_conta_mat_w,
	nr_seq_proc_partic_w,
	nr_seq_ocorrencia_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin

	begin
	select	ie_auditoria_conta,
		ie_finalizar_analise
	into STRICT	ie_auditoria_conta_w,
		ie_finalizar_analise_w
	from	pls_ocorrencia
	where	nr_sequencia = nr_seq_ocorrencia_w;
	exception
	when others then
		ie_auditoria_conta_w	:= null;
		ie_finalizar_analise_w	:= null;
	end;

	select	max(nr_sequencia)
	into STRICT	nr_seq_analise_conta_item_w
	from	pls_analise_conta_item
	where	nr_seq_ocorrencia	= nr_seq_oc_benef_w
	and	nr_seq_analise		= nr_seq_analise_p;

	if (coalesce(nr_seq_analise_conta_item_w,0) > 0) then

		begin
		select	ie_status,
			ie_consistencia
		into STRICT	ie_status_w,
			ie_consistencia_w
		from	pls_analise_conta_item
		where	nr_sequencia		= nr_seq_analise_conta_item_w;
		exception
		when others then
			ie_consistencia_w	:= null;
			ie_status_w		:= null;
		end;

		if (ie_status_w in ('A', 'N', 'L')) and (coalesce(ie_consistencia_w,'N') = 'S') and
			((ie_auditoria_conta_w = 'N') or (ie_finalizar_analise_w = 'N')) then
			begin
			CALL pls_desfazer_lib_glosa_oc(	nr_seq_analise_conta_item_w, null, nm_usuario_p,
							nr_seq_conta_p, nr_seq_analise_p, nr_seq_oc_benef_w,
							'O', cd_estabelecimento_p, nr_seq_grupo_atual_p,
							null, 'S','S');
			ie_status_w := 'P';
			exception
			when others then
				null;
			end;

			if (ie_status_w in ('A', 'L')) then
				ie_situacao_w := 'I';
			elsif (ie_status_w = 'N') then
				ie_situacao_w := 'A';
			end if;

		end if;

		if (ie_status_w in ('E', 'C')) and --Necessita correção
			(ie_finalizar_analise_w = 'S') then
			ie_status_w		:= 'P';
			ie_situacao_w		:= 'A';
		end if;

		if (ie_status_w = 'I') and (ie_auditoria_conta_w = 'S') then
			ie_status_w 		:= 'P';
			ie_situacao_w		:= 'A';
		end if;

		if (ie_status_w = 'P') or (ie_status_w = 'I') then
			if (ie_auditoria_conta_w = 'N') then
				ie_status_w 		:= 'I';
				ie_situacao_w		:= 'I';
			elsif (ie_finalizar_analise_w = 'N') then
				ie_status_w 		:= 'E';
				ie_situacao_w		:= 'A';
			end if;
		end if;

		update	pls_analise_conta_item
		set	ie_status	= ie_status_w,
			ie_situacao	= coalesce(ie_situacao_w,CASE WHEN ie_status_w='N' THEN 'A' WHEN ie_status_w='P' THEN 'A' WHEN ie_status_w='L' THEN 'A'  ELSE 'I' END )
		where	nr_sequencia	= nr_seq_analise_conta_item_w;
	end if;

	end;
end loop;
close C01;

CALL pls_consistir_conta(nr_seq_conta_p, cd_estabelecimento_p, nm_usuario_p,'N',null,null,null,'S');

select	max(ie_origem_analise)
into STRICT	ie_origem_analise_w
from	pls_analise_conta
where	nr_sequencia = nr_seq_analise_p;

/* Francisco - 15/06/2012 - Já chama na PLS_RECONSISTIR_ANALISE
if	(ie_origem_analise_w = 3) then
	pls_atual_w_resumo_conta_ptu(	nr_seq_conta_p, null, null,
					null, nr_seq_analise_p, nm_usuario_p	);

else
	pls_atualiza_w_resumo_conta(	nr_seq_conta_p, null, null,
					null, nr_seq_analise_p, nm_usuario_p	);
end if;*/
select	max(nr_sequencia)
into STRICT	nr_seq_mot_lib_w
from	pls_mot_lib_analise_conta
where	cd_estabelecimento = cd_estabelecimento_p
and	ie_reconsistencia  = 'S';

if (coalesce(nr_seq_mot_lib_w,0) = 0) then
	--'Motivo padrão para liberação das glosas/ocorrências reconsistidas não informado. Verifique.'
	CALL wheb_mensagem_pck.exibir_mensagem_abort(177504);
end if;

open C01;
loop
fetch C01 into
	nr_seq_oc_benef_w,
	ie_status_ww,
	nr_seq_conta_proc_w,
	nr_seq_conta_mat_w,
	nr_seq_proc_partic_w,
	nr_seq_ocorrencia_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin

	begin
	select	ie_auditoria_conta,
		ie_finalizar_analise
	into STRICT	ie_auditoria_conta_w,
		ie_finalizar_analise_w
	from	pls_ocorrencia
	where	nr_sequencia = nr_seq_ocorrencia_w;
	exception
	when others then
		ie_auditoria_conta_w	:= null;
		ie_finalizar_analise_w	:= null;
	end;

	select	max(nr_sequencia)
	into STRICT	nr_seq_analise_conta_item_w
	from	pls_analise_conta_item
	where	nr_seq_ocorrencia	= nr_seq_oc_benef_w
	and	nr_seq_analise		= nr_seq_analise_p;

	if (coalesce(nr_seq_analise_conta_item_w,0) > 0) then

		begin
		select	nr_seq_conta_proc,
			nr_seq_conta_mat,
			ie_status,
			ie_consistencia
		into STRICT	nr_seq_conta_proc_w,
			nr_seq_conta_mat_w,
			ie_status_w,
			ie_consistencia_w
		from	pls_analise_conta_item
		where	nr_sequencia		= nr_seq_analise_conta_item_w;
		exception
		when others then
			nr_seq_conta_proc_w	:= null;
			nr_seq_conta_mat_w	:= null;
			ie_status_w		:= null;
		end;

		if (ie_status_w in ('A', 'N', 'L')) then

			if (coalesce(ie_consistencia_w,'N') = 'S') then
				begin
				CALL pls_desfazer_lib_glosa_oc(	nr_seq_analise_conta_item_w, null, nm_usuario_p,
								nr_seq_conta_p, nr_seq_analise_p, nr_seq_oc_benef_w,
								'O', cd_estabelecimento_p, nr_seq_grupo_atual_p,
								null, 'S','S');

				if (ie_status_ww	= 'I') then
					CALL pls_conta_liberar_glosa_oc(	nr_seq_analise_conta_item_w, nr_seq_analise_p, nr_seq_mot_lib_w,
									'Parecer inserido automáticamente pela reconsistência do item.', nm_usuario_p, cd_estabelecimento_p,
									nr_seq_grupo_atual_p, 'N', 'S','S');
				end if;

				exception
				when others then
					null;
				end;
			end if;

		elsif (ie_status_w		= 'E') and (ie_status_ww		= 'I') then --Necessita correção
			update	pls_analise_conta_item
			set	ie_status	= 'C',
				ie_situacao	= 'I'
			where	nr_sequencia	= nr_seq_analise_conta_item_w;

		elsif (ie_status_w 		= 'C') and (ie_status_ww		= 'A') then --Corrigida
			update	pls_analise_conta_item
			set	ie_status	= 'E',
				ie_situacao	= 'A'
			where	nr_sequencia	= nr_seq_analise_conta_item_w;

		elsif (ie_status_w = 'P') 	and (ie_status_ww	= 'I') 	then
			CALL pls_conta_liberar_glosa_oc(	nr_seq_analise_conta_item_w,nr_seq_analise_p, nr_seq_mot_lib_w,
							'Parecer inserido automáticamente pela reconsistência do item.', nm_usuario_p, cd_estabelecimento_p,
							nr_seq_grupo_atual_p, 'N', 'S','S');
		end if;
	end if;

	end;
end loop;
close C01;

open C02;
loop
fetch C02 into
	nr_seq_glosa_w,
	ie_status_ww,
	nr_seq_conta_proc_w,
	nr_seq_conta_mat_w,
	nr_seq_proc_partic_w;
EXIT WHEN NOT FOUND; /* apply on C02 */
	begin

	select	max(nr_sequencia)
	into STRICT	nr_seq_analise_conta_item_w
	from	pls_analise_conta_item
	where	nr_seq_glosa		= nr_seq_glosa_w
	and	nr_seq_analise		= nr_seq_analise_p;

	if (coalesce(nr_seq_analise_conta_item_w,0) > 0) then

		begin
		select	nr_seq_conta_proc,
			nr_seq_conta_mat,
			ie_status,
			ie_consistencia
		into STRICT	nr_seq_conta_proc_w,
			nr_seq_conta_mat_w,
			ie_status_w,
			ie_consistencia_w
		from	pls_analise_conta_item
		where	nr_sequencia		= nr_seq_analise_conta_item_w;
		exception
		when others then
			nr_seq_conta_proc_w	:= null;
			nr_seq_conta_mat_w	:= null;
			ie_status_w		:= null;
		end;

		if (ie_status_w in ('A', 'N', 'L')) then

			if (coalesce(ie_consistencia_w,'N') = 'S') then
				begin
				CALL pls_desfazer_lib_glosa_oc(	nr_seq_analise_conta_item_w, null, nm_usuario_p,
								nr_seq_conta_p, nr_seq_analise_p, nr_seq_glosa_w,
								'G', cd_estabelecimento_p, nr_seq_grupo_atual_p,
								null, 'S','S');

				if (ie_status_ww	= 'I') then
					CALL pls_conta_liberar_glosa_oc(	nr_seq_analise_conta_item_w, nr_seq_analise_p, nr_seq_mot_lib_w,
									'Parecer inserido automáticamente pela reconsistência do item.', nm_usuario_p, cd_estabelecimento_p,
									nr_seq_grupo_atual_p, 'N', 'S','S');
				end if;

				exception
				when others then
					null;
				end;
			end if;

		elsif (ie_status_w		= 'E') and (ie_status_ww		= 'I') then --Necessita correção
			update	pls_analise_conta_item
			set	ie_status	= 'C',
				ie_situacao	= 'I'
			where	nr_sequencia	= nr_seq_analise_conta_item_w;

		elsif (ie_status_w 		= 'C') and (ie_status_ww		= 'A') then --Corrigida
			update	pls_analise_conta_item
			set	ie_status	= 'E',
				ie_situacao	= 'N'
			where	nr_sequencia	= nr_seq_analise_conta_item_w;

		elsif (ie_status_w = 'P') then

			if (ie_status_ww	= 'I') then
				CALL pls_conta_liberar_glosa_oc(	nr_seq_analise_conta_item_w, nr_seq_analise_p, nr_seq_mot_lib_w,
								'Parecer inserido automáticamente pela reconsistência do item.', nm_usuario_p, cd_estabelecimento_p,
								nr_seq_grupo_atual_p, 'N', 'S','S');
			end if;

		end if;
	end if;

	end;
end loop;
close C02;

/*Copiar as glosas e ocorrencias para a tabela ser usado na análise*/

CALL pls_gerar_analise_conta_item(nr_seq_conta_p, nr_seq_analise_p, cd_estabelecimento_p, nm_usuario_p);

update	pls_conta_proc
set	ie_status = 'A'
where	nr_seq_conta = nr_seq_conta_p;

update	pls_conta_mat
set	ie_status = 'A'
where	nr_seq_conta = nr_seq_conta_p;

update	pls_conta
set	ie_status = 'A'
where	nr_sequencia = nr_seq_conta_p;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_reconsistir_glosas_oc ( nr_seq_conta_p bigint, ds_param1_p text, ds_param2_p text, ds_param3_p text, nr_seq_analise_p bigint, nr_seq_grupo_atual_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text ) FROM PUBLIC;

