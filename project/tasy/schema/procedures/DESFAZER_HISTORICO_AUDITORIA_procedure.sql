-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE desfazer_historico_auditoria (nr_seq_hist_audit_p bigint, nm_usuario_p text) AS $body$
DECLARE

 
nr_seq_lote_recurso_w	bigint;
nr_seq_lote_audit_w	bigint;
ie_definir_analisada_w	varchar(1);
cd_estabelecimento_w	smallint;
qt_item_w		bigint;
qt_item_analisado_w	bigint;


BEGIN 
 
select	max(coalesce(nr_seq_lote_recurso,0)), 
	max(coalesce(nr_seq_lote_audit,0)) 
into STRICT	nr_seq_lote_recurso_w, 
	nr_seq_lote_audit_w 
from	conta_paciente_ret_hist 
where	nr_sequencia	= nr_seq_hist_audit_p;
 
if (nr_seq_lote_recurso_w <> 0) then 
	CALL WHEB_MENSAGEM_PCK.Exibir_Mensagem_Abort(279798, 'NR_SEQ_LOTE=' || nr_seq_lote_recurso_w);
end if;
 
if (nr_seq_lote_audit_w <> 0) then 
	CALL WHEB_MENSAGEM_PCK.Exibir_Mensagem_Abort(279801, 'NR_SEQ_LOTE=' || nr_seq_lote_audit_w);
end if;
 
select	max(c.cd_estabelecimento) 
into STRICT	cd_estabelecimento_w 
from	convenio_retorno c, 
	convenio_retorno_item b, 
	convenio_retorno_glosa a 
where	b.nr_seq_retorno		= c.nr_sequencia 
and	a.nr_seq_ret_item		= b.nr_sequencia 
and	a.nr_seq_conpaci_ret_hist	= nr_seq_hist_audit_p;
 
if (cd_estabelecimento_w IS NOT NULL AND cd_estabelecimento_w::text <> '') then	/* ahoffelder - OS 324188 - 26/05/2011 */
 
 
	ie_definir_analisada_w := Obter_Param_Usuario(27, 153, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_definir_analisada_w);
 
	if (ie_definir_analisada_w = 'S') then 
 
		update	convenio_retorno_item 
		set	ie_analisada	= 'N' 
		where	nr_sequencia	in (SELECT	nr_seq_ret_item 
			from	convenio_retorno_glosa 
			where	nr_seq_conpaci_ret_hist	= nr_seq_hist_audit_p);
 
	end if;
 
end if;
 
update	convenio_retorno_glosa 
set	nr_seq_conpaci_ret_hist	 = NULL, 
	nm_usuario		= nm_usuario_p, 
	dt_atualizacao		= clock_timestamp() 
where	nr_seq_conpaci_ret_hist	= nr_seq_hist_audit_p;
 
update	titulo_receber_liq 
set	nr_seq_conpaci_ret_hist	 = NULL, 
	ds_observacao		= ds_observacao || WHEB_MENSAGEM_PCK.get_texto(279803) || nr_seq_lote_audit_w || WHEB_MENSAGEM_PCK.get_texto(279804) || nr_seq_lote_recurso_w || WHEB_MENSAGEM_PCK.get_texto(279806) || nr_seq_hist_audit_p 
where	nr_seq_conpaci_ret_hist	= nr_seq_hist_audit_p;
 
delete	from conta_paciente_ret_hist 
where	nr_sequencia	= nr_seq_hist_audit_p;
 
commit;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE desfazer_historico_auditoria (nr_seq_hist_audit_p bigint, nm_usuario_p text) FROM PUBLIC;

