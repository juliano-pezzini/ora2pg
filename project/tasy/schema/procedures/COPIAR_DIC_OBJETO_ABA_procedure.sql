-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE copiar_dic_objeto_aba ( cd_funcao_p bigint, nr_seq_objeto_p bigint, nm_usuario_p text, nr_seq_criado_p INOUT bigint , ie_html_p text default 'N') AS $body$
DECLARE


nr_seq_objeto_w	bigint;
ds_mascara_w	varchar(255);
ie_tipo_edicao_w	dic_objeto.ie_tipo_edicao%type;

C04 CURSOR FOR
	SELECT 	a.nr_sequencia,
		trim(both upper(a.ds_mascara)) ds_mascara,
		a.nm_campo_base,
		a.ie_tipo_edicao
	from 	dic_objeto a
	where 	a.nr_seq_obj_sup = nr_seq_objeto_w
	and	substr(a.NM_CAMPO_BASE,1,2) in ('DT','VL','QT')
	and	(a.ds_mascara IS NOT NULL AND a.ds_mascara::text <> '');

c05 CURSOR FOR
	SELECT 	a.nr_sequencia,
			a.nm_campo_base,
			a.ie_tipo_edicao
	from 	dic_objeto a
	where 	a.nr_seq_obj_sup = nr_seq_objeto_w
	and		coalesce(a.ie_tipo_edicao::text, '') = '';


c04_w c04%rowtype;


BEGIN
if (cd_funcao_p IS NOT NULL AND cd_funcao_p::text <> '') and (nr_seq_objeto_p IS NOT NULL AND nr_seq_objeto_p::text <> '') and (nm_usuario_p IS NOT NULL AND nm_usuario_p::text <> '') then
	begin
	select	nextval('dic_objeto_seq')
	into STRICT	nr_seq_objeto_w
	;

	insert into dic_objeto(
		nr_sequencia,
		dt_atualizacao,
		nm_usuario,
		dt_atualizacao_nrec,
		nm_usuario_nrec,
		ie_tipo_objeto,
		nm_objeto,
		ds_texto,
		cd_funcao,
		ds_sql,
		ie_configuravel,
		ds_comando,
		cd_exp_texto,
		cd_exp_informacao,
		ie_situacao)
	SELECT	nr_seq_objeto_w,
		clock_timestamp(),
		nm_usuario_p,
		clock_timestamp(),
		nm_usuario_p,
		ie_tipo_objeto,
		nm_objeto,
		ds_texto,
		cd_funcao_p,
		ds_sql,
		ie_configuravel,
		ds_comando,
		cd_exp_texto,
		cd_exp_informacao,
		ie_situacao
	from	dic_objeto
	where	nr_sequencia = nr_seq_objeto_p;

	insert into dic_objeto(
		nr_sequencia,
		dt_atualizacao,
		nm_usuario,
		dt_atualizacao_nrec,
		nm_usuario_nrec,
		ie_tipo_objeto,
		nr_seq_obj_sup,
		nr_seq_apres,
		nm_campo_base,
		nm_campo_tela,
		qt_largura,
		ie_read_only,
		cd_funcao,
		ds_mascara,
		ie_configuravel,
		ds_comando,
		cd_exp_texto,
		cd_exp_informacao,
		ie_situacao,
		nm_objeto,
		CD_EXP_CAMPO_TELA,
		IE_TIPO_EDICAO,
		IE_TIPO_OBJ_COL_WCP,
		CD_MASCARA,
		IE_TOTALIZAR,
		IE_VISIBLE)
	SELECT	nextval('dic_objeto_seq'),
		clock_timestamp(),
		nm_usuario_p,
		clock_timestamp(),
		nm_usuario_p,
		ie_tipo_objeto,
		nr_seq_objeto_w,
		nr_seq_apres,
		nm_campo_base,
		nm_campo_tela,
		qt_largura,
		ie_read_only,
		cd_funcao_p,
		ds_mascara,
		ie_configuravel,
		ds_comando,
		cd_exp_texto,
		cd_exp_informacao,
		ie_situacao,
		nm_objeto,
		CD_EXP_CAMPO_TELA,
		IE_TIPO_EDICAO,
		IE_TIPO_OBJ_COL_WCP,
		CD_MASCARA,
		IE_TOTALIZAR,
		IE_VISIBLE
	from	dic_objeto
	where	nr_seq_obj_sup = nr_seq_objeto_p;
	end;
end if;

if (ie_html_p	= 'S') then

	update	dic_objeto
	set  	QT_LARGURA	= least(QT_LARGURA + trunc(QT_LARGURA * 0.30), 999),
		dt_atualizacao = clock_timestamp()
	where	nr_seq_obj_sup = nr_seq_objeto_w
	and	(QT_LARGURA IS NOT NULL AND QT_LARGURA::text <> '');

	open c04;
	loop
	fetch c04 into
		c04_w;
	EXIT WHEN NOT FOUND; /* apply on c04 */
		begin
		ds_mascara_w := null;

		if (c04_w.ie_tipo_edicao = 'N') and (substr(c04_w.NM_CAMPO_BASE,1,2) = 'VL') then

			ds_mascara_w	:= 'currency()';
		else
			begin
			/*if 	(upper(c04_w.ds_mascara) = 'DD/MM/YYYY HH:MM:SS') then
				--ds_mascara_w := 'dd/MM/yyyy HH:mm:ss';
				ds_mascara_w := 'date(timestamp)';
			elsif (upper(c04_w.ds_mascara) = 'DD/MM/YYYY') then
				--ds_mascara_w := 'dd/MM/yyyy';
				ds_mascara_w := 'date(shortDate)';
			elsif (upper(c04_w.ds_mascara) = 'DD/MM/YYYY HH:MM') then
				--ds_mascara_w := 'dd/MM/yyyy HH:mm';
				ds_mascara_w := 'date(short)';
			elsif (upper(c04_w.ds_mascara) = 'HH:MM') then
				ds_mascara_w := 'date(shortTime)';
			end if;*/
			ds_mascara_w	:= Obter_Mascara_Convertida(c04_w.ds_mascara,c04_w.NM_CAMPO_BASE);
			end;
		end if;

		if (ds_mascara_w IS NOT NULL AND ds_mascara_w::text <> '') then
			update 	dic_objeto
			set  	ds_mascara = ds_mascara_w,
				dt_atualizacao = clock_timestamp()
			where  	nr_sequencia = c04_w.nr_sequencia;
		end if;

		end;
	end loop;
	close c04;

	/* Ajustar tipo de edução nulo - Não ficar gerando mensagem */

	for r_c05 in c05 loop
		if (r_c05.nm_campo_base like 'VL_%') or (r_c05.nm_campo_base like 'NR_%') or (r_c05.nm_campo_base like 'QT_%') or (r_c05.nm_campo_base like 'PR_%') then
			ie_tipo_edicao_w	:= 'N';
		elsif (r_c05.nm_campo_base like 'DT_%') then
			ie_tipo_edicao_w	:= 'D';
		else
			ie_tipo_edicao_w	:= 'V';
		end if;

		update	dic_objeto
		set		ie_tipo_edicao	= ie_tipo_edicao_w
		where	nr_sequencia	= r_c05.nr_sequencia;
	end loop;
end if;

nr_seq_criado_p	:= nr_seq_objeto_w;
commit;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE copiar_dic_objeto_aba ( cd_funcao_p bigint, nr_seq_objeto_p bigint, nm_usuario_p text, nr_seq_criado_p INOUT bigint , ie_html_p text default 'N') FROM PUBLIC;

