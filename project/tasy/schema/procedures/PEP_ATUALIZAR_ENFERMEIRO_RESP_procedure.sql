-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pep_atualizar_enfermeiro_resp ( lista_nr_atendimento_p text, cd_pessoa_fisica_p text, nm_usuario_p text) AS $body$
DECLARE


qt_enfermeiro_w		bigint := 0;
cd_pessoa_fisica_w	varchar(10);
nr_atendimento_w	bigint;
ds_lista_aux_w		varchar(4000) := '';
ds_nr_atendimento_w	varchar(15);
k			integer;


BEGIN

ds_lista_aux_w := lista_nr_atendimento_p;

while (ds_lista_aux_w IS NOT NULL AND ds_lista_aux_w::text <> '') loop
	begin
	select	position(',' in ds_lista_aux_w)
	into STRICT	k
	;

	if (k > 1) and ((substr(ds_lista_aux_w, 1, k -1) IS NOT NULL AND (substr(ds_lista_aux_w, 1, k -1))::text <> '')) then
		ds_nr_atendimento_w	:= substr(ds_lista_aux_w, 1, k-1);
		nr_atendimento_w	:= replace(ds_nr_atendimento_w, ',','');
		ds_lista_aux_w		:= substr(ds_lista_aux_w, k + 1, 2000);
	elsif (ds_lista_aux_w IS NOT NULL AND ds_lista_aux_w::text <> '') then
		nr_atendimento_w	:= replace(ds_lista_aux_w,',','');
		ds_lista_aux_w	:= '';
	end if;

	select	coalesce(count(*),0)
	into STRICT	qt_enfermeiro_w
	from	atend_enfermagem_resp
	where	nr_atendimento = nr_atendimento_w;

	if (coalesce(qt_enfermeiro_w,0) > 0) then
		select	coalesce(max(cd_pessoa_fisica),'0')
		into STRICT	cd_pessoa_fisica_w
		from	atend_enfermagem_resp
		where	nr_atendimento = nr_atendimento_w
		and	nr_sequencia = (SELECT	max(nr_sequencia)
					  from		atend_enfermagem_resp
					  where	nr_atendimento = nr_atendimento_w);

		update	atend_enfermagem_resp
		set	dt_final_resp = clock_timestamp()
		where	nr_atendimento = nr_atendimento_w
		and	nr_sequencia = (SELECT	max(nr_sequencia)
					  from		atend_enfermagem_resp
					  where	nr_atendimento = nr_atendimento_w);
	end if;

	if (coalesce(cd_pessoa_fisica_p::text, '') = '') then
		delete from atend_enfermagem_resp
		where nr_sequencia = (	SELECT	max(nr_sequencia)
					from	atend_enfermagem_resp
					where	nr_atendimento = nr_atendimento_w)
		and nr_atendimento = nr_atendimento_w;
	else
		insert into atend_enfermagem_resp(
							nr_sequencia,
							dt_atualizacao,
							nm_usuario,
							cd_pessoa_fisica,
							nr_atendimento,
							cd_pessoa_resp_ant,
							dt_inicio_resp)
						SELECT	nextval('atend_enfermagem_resp_seq'),
							clock_timestamp(),
							nm_usuario_p,
							cd_pessoa_fisica_p,
							nr_atendimento_w,
							coalesce(cd_pessoa_fisica_w, null),
							clock_timestamp()
						;
	end if;
	end;
end loop;
commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pep_atualizar_enfermeiro_resp ( lista_nr_atendimento_p text, cd_pessoa_fisica_p text, nm_usuario_p text) FROM PUBLIC;

