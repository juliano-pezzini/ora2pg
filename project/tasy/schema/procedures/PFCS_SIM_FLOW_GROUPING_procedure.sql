-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pfcs_sim_flow_grouping (cd_estabelecimento_p bigint) AS $body$
DECLARE


-- Variables
last_updated_fhir_w     timestamp := null;
last_updated_db_w       timestamp := null;
nr_seq_organization_w   pfcs_organization.nr_sequencia%type;

-- Cursors
--- Departments/Units
c01_dpts CURSOR(nr_seq_organization_p bigint) FOR
SELECT distinct
    s.ds_setor_atendimento,
    s.cd_setor_atendimento,
    CASE WHEN s.ie_semi_intensiva='S' THEN  'SD'  ELSE s.cd_classif_setor END  cd_classif_setor,
    upper(p.cd_unit) cd_unit
from pfcs_simulation_flow p,
    setor_atendimento s
where p.nr_seq_organization = nr_seq_organization_p
    and s.cd_estabelecimento = cd_estabelecimento_p
    and s.ie_situacao = 'A'
    and trim(both replace(upper(p.cd_unit),'_', ' ')) = trim(both replace(upper(s.ds_setor_atendimento),'_', ' '))
    and trim(both p.dt_simulation) in (to_char(clock_timestamp(), 'YYYY-MM-DD'), to_char(clock_timestamp() + interval '1 days', 'YYYY-MM-DD'));

--- Simulation values (capacity)
c02_cap CURSOR(cd_unit_p text, nr_seq_organization_p bigint) FOR
SELECT trim(both sim.dt_simulation) dt_simulation,
    sim.nr_hour,
    sim.dt_atualizacao,
    sim.nm_usuario,
    sim.dt_atualizacao_nrec,
    sim.nm_usuario_nrec,
    sim.nr_value nr_value_sim,
    std.nr_value nr_value_std
from pfcs_simulation_flow sim,
    pfcs_simulation_flow std
where upper(sim.cd_unit) = cd_unit_p
    and upper(std.cd_unit) = concat(cd_unit_p, '_STD')
    and sim.nr_hour = std.nr_hour
    and trim(both sim.dt_simulation) = trim(both std.dt_simulation)
    and trim(both sim.dt_simulation) in (to_char(clock_timestamp(), 'YYYY-MM-DD'), to_char(clock_timestamp() + interval '1 days', 'YYYY-MM-DD'))
    and sim.nr_seq_organization = std.nr_seq_organization
    and sim.nr_seq_organization = nr_seq_organization_p
order by 1, 2 asc;

--- Simulation values (admissions)
c03_arr CURSOR(cd_unit_p text, nr_seq_organization_p bigint) FOR
SELECT trim(both sim.dt_simulation) dt_simulation,
    sim.nr_hour,
    sim.nr_value nr_value_sim,
    std.nr_value nr_value_std
from pfcs_simulation_flow sim,
    pfcs_simulation_flow std
where upper(sim.cd_unit) = concat(cd_unit_p, '_ARRIVAL')
    and upper(std.cd_unit) = concat(cd_unit_p, '_ARRIVAL_STD')
    and sim.nr_hour = std.nr_hour
    and trim(both sim.dt_simulation) = trim(both std.dt_simulation)
    and trim(both sim.dt_simulation) in (to_char(clock_timestamp(), 'YYYY-MM-DD'), to_char(clock_timestamp() + interval '1 days', 'YYYY-MM-DD'))
    and sim.nr_seq_organization = std.nr_seq_organization
    and sim.nr_seq_organization = nr_seq_organization_p
order by 1, 2 asc;

--- Simulation values (discharges)
c04_exi CURSOR(cd_unit_p text, nr_seq_organization_p bigint) FOR
SELECT trim(both sim.dt_simulation) dt_simulation,
    sim.nr_hour,
    sim.nr_value nr_value_sim,
    std.nr_value nr_value_std
from pfcs_simulation_flow sim,
    pfcs_simulation_flow std
where upper(sim.cd_unit) = concat(cd_unit_p, '_EXIT')
    and upper(std.cd_unit) = concat(cd_unit_p, '_EXIT_STD')
    and sim.nr_hour = std.nr_hour
    and trim(both sim.dt_simulation) = trim(both std.dt_simulation)
    and trim(both sim.dt_simulation) in (to_char(clock_timestamp(), 'YYYY-MM-DD'), to_char(clock_timestamp() + interval '1 days', 'YYYY-MM-DD'))
    and sim.nr_seq_organization = std.nr_seq_organization
    and sim.nr_seq_organization = nr_seq_organization_p
order by 1, 2 asc;
BEGIN
    select max(nr_sequencia)
    into STRICT nr_seq_organization_w
    from pfcs_organization
    where cd_estabelecimento = cd_estabelecimento_p;

    select max(dt_atualizacao)
    into STRICT last_updated_fhir_w
    from pfcs_simulation_flow
    where nr_seq_organization = nr_seq_organization_w;

    select max(dt_atualizacao)
    into STRICT last_updated_db_w
    from pfcs_patient_simulation
    where cd_estabelecimento = cd_estabelecimento_p;

    if (((last_updated_fhir_w > last_updated_db_w) or (coalesce(last_updated_db_w::text, '') = ''))
            and (nr_seq_organization_w IS NOT NULL AND nr_seq_organization_w::text <> '')
            and (last_updated_fhir_w IS NOT NULL AND last_updated_fhir_w::text <> '')) then

        delete from pfcs_simulation_flow
        where to_date(dt_simulation || ' ' || nr_hour, 'YYYY-MM-DD HH24') < (clock_timestamp() - (1/24))
            and nr_seq_organization = nr_seq_organization_w;
        commit;

        delete from pfcs_patient_simulation where cd_estabelecimento = cd_estabelecimento_p;
        commit;

        for c01_w in c01_dpts(nr_seq_organization_w) loop
            for c02_w in c02_cap(c01_w.cd_unit, nr_seq_organization_w) loop
                insert into pfcs_patient_simulation(
                    nr_sequencia,
                    dt_atualizacao,
                    dt_atualizacao_nrec,
                    nm_usuario,
                    nm_usuario_nrec,
                    cd_unit,
                    dt_simulation,
                    hr_time_simulation,
                    cd_estabelecimento,
                    cd_classif_setor,
                    nr_mean_pred_capacity,
                    nr_sd_pred_capacity)
                values (
                    nextval('pfcs_patient_simulation_seq'),
                    last_updated_fhir_w,
                    last_updated_fhir_w,
                    c02_w.nm_usuario,
                    c02_w.nm_usuario_nrec,
                    c01_w.cd_setor_atendimento,
                    trunc(to_date(c02_w.dt_simulation,'YYYY-MM-DD')),
                    c02_w.nr_hour,
                    cd_estabelecimento_p,
                    c01_w.cd_classif_setor,
                    c02_w.nr_value_sim,
                    c02_w.nr_value_std);
            end loop;

            for c03_w in c03_arr(c01_w.cd_unit, nr_seq_organization_w) loop
                update pfcs_patient_simulation
                set nr_mean_pred_arrival = c03_w.nr_value_sim,
                    nr_sd_pred_arrival = c03_w.nr_value_std
                where dt_simulation = trunc(to_date(c03_w.dt_simulation,'YYYY-MM-DD'))
                    and hr_time_simulation = c03_w.nr_hour
                    and cd_unit = c01_w.cd_setor_atendimento;
            end loop;

            for c04_w in c04_exi(c01_w.cd_unit, nr_seq_organization_w) loop
                update pfcs_patient_simulation
                set nr_mean_pred_discharges = c04_w.nr_value_sim,
                    nr_sd_pred_discharges = c04_w.nr_value_std
                where dt_simulation = trunc(to_date(c04_w.dt_simulation,'YYYY-MM-DD'))
                    and hr_time_simulation = c04_w.nr_hour
                    and cd_unit = c01_w.cd_setor_atendimento;
            end loop;
        end loop;
        commit;
    end if;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pfcs_sim_flow_grouping (cd_estabelecimento_p bigint) FROM PUBLIC;

