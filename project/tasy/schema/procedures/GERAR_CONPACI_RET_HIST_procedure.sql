-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_conpaci_ret_hist ( nr_sequencia_p bigint, ie_acao_p bigint, dt_historico_p timestamp, nm_usuario_p text, nr_seq_ret_hist_p bigint) AS $body$
DECLARE

 
nr_seq_hist_audit_w	bigint;
nr_sequencia_w		bigint;

nr_interno_conta_w		bigint;
cd_autorizacao_w		varchar(20);
nr_seq_protocolo_w		bigint;
vl_historico_w		double precision;
cd_estabelecimento_w		smallint;

cd_moeda_w			integer;

nr_titulo_w			bigint;
dt_vencimento_w		timestamp;
vl_saldo_w			double precision;

nr_seq_ret_item_w		bigint;
nr_seq_retorno_w		bigint;
ie_vincular_todos_w	varchar(1);

C001 CURSOR FOR 
	SELECT distinct 
		nr_titulo, 
		dt_vencimento, 
		vl_saldo_titulo 
	from (SELECT nr_titulo, 
			 dt_vencimento, 
	   	 vl_saldo_titulo 
		from titulo_receber 
		where nr_interno_conta = nr_interno_conta_w 
		 and nr_documento = somente_numero(cd_autorizacao_w) 
		
union
 
		select nr_titulo, 
			 dt_vencimento, 
	   	 vl_saldo_titulo 
		from titulo_receber 
		where coalesce(nr_documento,0) = 0 
		 and nr_interno_conta = nr_interno_conta_w 
		
union
 
		select nr_titulo, 
			 dt_vencimento, 
	   	 vl_saldo_titulo 
		from titulo_receber 
		where coalesce(nr_interno_conta,0) = 0 
	 	 and nr_seq_protocolo = nr_seq_protocolo_w) alias3 
	order by dt_vencimento;


BEGIN 
 
select coalesce(max(nr_sequencia),0) 
into STRICT nr_seq_hist_audit_w 
from hist_audit_conta_paciente 
where ie_acao = ie_acao_p;
 
if (nr_seq_hist_audit_w = 0) then 
	CALL wheb_mensagem_pck.exibir_mensagem_abort(256030);
end if;
 
select CASE WHEN a.vl_pendente=0 THEN  a.vl_reapresentacao  ELSE a.vl_pendente END , 
	a.nr_interno_conta, 
	a.cd_autorizacao, 
	b.nr_seq_protocolo, 
	b.cd_estabelecimento 
into STRICT	vl_historico_w, 
	nr_interno_conta_w, 
	cd_autorizacao_w, 
	nr_seq_protocolo_w, 
	cd_estabelecimento_w 
from	conta_paciente b, 
	conta_paciente_retorno a 
where a.nr_interno_conta = b.nr_interno_conta 
 and a.nr_sequencia = nr_sequencia_p;
 
if (vl_historico_w = 0) then 
	CALL wheb_mensagem_pck.exibir_mensagem_abort(256031);
end if;
 
select max(a.nr_sequencia), 
	max(a.nr_seq_retorno) 
into STRICT	nr_seq_ret_item_w, 
	nr_seq_retorno_w 
from	convenio_retorno b, 
	convenio_retorno_item a 
where b.nr_sequencia = a.nr_seq_retorno 
 and b.ie_status_retorno = 'F' 
 and a.nr_interno_conta = nr_interno_conta_w 
 and a.cd_autorizacao = cd_autorizacao_w 
 and b.dt_fechamento <= (SELECT coalesce(max(dt_historico), max(dt_inicial)) 
				FROM conta_paciente_ret_hist y
LEFT OUTER JOIN conta_paciente_retorno x ON (y.nr_seq_conpaci_ret = x.nr_sequencia)
WHERE x.nr_sequencia = nr_sequencia_p );
 
select nextval('conta_paciente_ret_hist_seq') 
into STRICT nr_sequencia_w
;
 
insert into conta_paciente_ret_hist(	nr_sequencia, nr_seq_conpaci_ret, dt_historico, 
	vl_historico, nr_seq_hist_audit, dt_atualizacao, 
	nm_usuario, nr_seq_ret_item, ds_observacao, nm_usuario_resp) 
values (	nr_sequencia_w, nr_sequencia_p, dt_historico_p, 
	vl_historico_w, nr_seq_hist_audit_w, clock_timestamp(), 
	nm_usuario_p, nr_seq_ret_item_w, null, nm_usuario_p);
 
ie_vincular_todos_w := obter_param_usuario(66, 19, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_vincular_todos_w);
 
if (ie_vincular_todos_w	= 'S') then 
 
	update	convenio_retorno_glosa 
	set	nr_seq_conpaci_ret_hist	= nr_sequencia_w 
	where	nr_seq_conpaci_ret_hist	in (SELECT	nr_sequencia 
		from	conta_paciente_ret_hist 
		where	(nr_seq_hist_audit IS NOT NULL AND nr_seq_hist_audit::text <> '') 
		and	coalesce(nr_seq_lote_audit::text, '') = '' 
		and	nr_seq_conpaci_ret	= nr_sequencia_p 
		and	nr_sequencia		<> nr_sequencia_w);
 
elsif (ie_vincular_todos_w	= 'E') then 
 
	update	convenio_retorno_glosa 
	set	nr_seq_conpaci_ret_hist	= nr_sequencia_w 
	where	nr_seq_conpaci_ret_hist	= nr_seq_ret_hist_p;
 
end if;
 
/* 
if	(ie_acao_p in (0,3)) then 
	select cd_moeda_padrao 
	into cd_moeda_w 
	from parametro_contas_receber 
	where cd_estabelecimento = cd_estabelecimento_w; 
	 
	open C001; 
	loop 
		fetch C001 into	nr_titulo_w, 
					dt_vencimento_w, 
					vl_saldo_w; 
		exit when C001%notfound; 
 
		select nvl(max(nr_sequencia),0) + 1 
		into nr_sequencia_w 
		from titulo_receber_liq 
		where nr_titulo = nr_titulo_w; 
 
		insert into titulo_receber_liq (nr_titulo, nr_sequencia, dt_recebimento, vl_recebido, vl_descontos, 
							 vl_juros, vl_multa, cd_moeda, dt_atualizacao, nm_usuario, 
							 cd_tipo_recebimento, ie_acao, cd_serie_nf_devol, nr_nota_fiscal_devol, 
							 cd_banco, cd_agencia_bancaria, nr_documento, nr_lote_banco, 
							 cd_cgc_emp_cred, nr_cartao_cred, nr_adiantamento, nr_lote_contabil, 
							 nr_seq_trans_fin, vl_rec_maior, vl_glosa, nr_seq_ret_item, nr_seq_retorno, ie_lib_caixa) 
		values (nr_titulo_w, nr_sequencia_w, sysdate, 0, 0, 
			 0, 0, cd_moeda_w, sysdate, nm_usuario_p, 
			 1, 'I', null, null, 
			 null, null, null, null, 
			 null, null, null, null, 
			 null, 0, vl_historico_w, nr_seq_ret_item_w, nr_seq_retorno_w, 'S'); 
 
		-- Edgar 11/01/2006, OS 27445, gravar log de onde est√° vindo a baixa 
		if	(sysdate < to_date('01/03/2006','dd/mm/yyyy')) then 
 
			insert into log_XXtasy 
				(DT_ATUALIZACAO, 
				NM_USUARIO, 
				CD_LOG, 
				DS_LOG) 
			values	(sysdate, 
				nm_usuario_P, 
				55557, 
				'NR_TITULO = ' || nr_titulo_w || ' NR_SEQUENCIA = ' || nr_sequencia_w || 
				' NR_SEQ_RETORNO = ' || nr_seq_retorno_w || ' vl_glosa = ' || vl_historico_w || 
				' Gerar_ConPaci_Ret_Hist'); 
 
		end if; 
 
 
		atualizar_saldo_tit_rec(nr_titulo_w, nm_usuario_p); 
	end loop; 
	close C001; 
end if; 
*/
 
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_conpaci_ret_hist ( nr_sequencia_p bigint, ie_acao_p bigint, dt_historico_p timestamp, nm_usuario_p text, nr_seq_ret_hist_p bigint) FROM PUBLIC;

