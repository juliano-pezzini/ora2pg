-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE consistir_material_autor_cir (nr_seq_autorizacao_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text, ds_erro_p INOUT text) AS $body$
DECLARE


cd_grupo_material_w	integer;
cd_subgrupo_material_w	integer;
cd_classe_material_w	integer;
cd_material_w		integer;
qt_min_fornec_w		bigint := 0;
nr_seq_mat_autor_w	bigint;
qt_fornec_autor_w	bigint;
ds_erro_w		varchar(4000) := null;
ds_material_w		varchar(255);

c01 CURSOR FOR
SELECT 	b.cd_material,
	b.nr_sequencia
from 	autorizacao_cirurgia a,
	material_autor_cirurgia b
where	a.nr_sequencia	= b.nr_seq_autorizacao
and	a.nr_sequencia	= nr_seq_autorizacao_p;

c02 CURSOR FOR
SELECT 	qt_min_fornec
from 	regra_autor_cir_fornec
where	cd_estabelecimento						= cd_estabelecimento_p
and	coalesce(cd_grupo_material,coalesce(cd_grupo_material_w,0))		= coalesce(cd_grupo_material_w,0)
and	coalesce(cd_subgrupo_material,coalesce(cd_subgrupo_material_w,0))		= coalesce(cd_subgrupo_material_w,0)
and 	coalesce(cd_classe_material,coalesce(cd_classe_material_w,0))		= coalesce(cd_classe_material_w,0)
and	coalesce(cd_material,coalesce(cd_material_w,0))				= coalesce(cd_material_w,0)
order by
	coalesce(cd_grupo_material,0),
	coalesce(cd_subgrupo_material,0),
	coalesce(cd_classe_material,0),
	coalesce(cd_material,0);


BEGIN

if (nr_seq_autorizacao_p IS NOT NULL AND nr_seq_autorizacao_p::text <> '') then

	open C01;
	loop
	fetch C01 into
		cd_material_w,
		nr_seq_mat_autor_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		select 	cd_grupo_material,
			cd_subgrupo_material,
			cd_classe_material,
			ds_material
		into STRICT	cd_grupo_material_w,
			cd_subgrupo_material_w,
			cd_classe_material_w,
			ds_material_w
		from 	estrutura_material_v
		where	cd_material	= cd_material_w;

		open C02;
		loop
		fetch C02 into
			qt_min_fornec_w;
		EXIT WHEN NOT FOUND; /* apply on C02 */
		end loop;
		close C02;

		if (qt_min_fornec_w > 0) then

			select 	count(*)
			into STRICT 	qt_fornec_autor_w
			from 	material_autor_cir_cot
			where	nr_sequencia	= nr_seq_mat_autor_w;

			if (qt_fornec_autor_w < qt_min_fornec_w) then
				ds_erro_w	:= ds_erro_w || to_char(cd_material_w)||' - '||ds_material_w||WHEB_MENSAGEM_PCK.get_texto(279106)||to_char(qt_min_fornec_w)||chr(13);
			end if;

		end if;

	end loop;
	close C01;

	ds_erro_p	:= ds_erro_w;

end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE consistir_material_autor_cir (nr_seq_autorizacao_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text, ds_erro_p INOUT text) FROM PUBLIC;

