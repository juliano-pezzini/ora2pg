-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE cpoe_vincular_atend ( ie_tipo_item_p text, nr_sequencia_p bigint, nr_prescricao_p bigint, nr_atendimento_p bigint, nm_usuario_p text, ie_opcao_p text) AS $body$
DECLARE

					
					
c01 CURSOR FOR	
	SELECT	a.nr_prescricao
	from	prescr_dieta	b,
			prescr_medica	a
	where	ie_tipo_item_p	in ('D')
	and		a.nr_prescricao		=	b.nr_prescricao
	and		coalesce(a.nr_atendimento::text, '') = ''
	and		nr_seq_dieta_cpoe	=	nr_sequencia_p

union

	SELECT	a.nr_prescricao
	from	prescr_material	b,
			prescr_medica	a
	where	ie_tipo_item_p	in ('SNE','S','LD')
	and		a.nr_prescricao		=	b.nr_prescricao		
	and		coalesce(a.nr_atendimento::text, '') = ''	
	and		nr_seq_dieta_cpoe	=	nr_sequencia_p

union

	select	a.nr_prescricao
	from	rep_jejum	b,
			prescr_medica	a
	where	ie_tipo_item_p	in ('J')
	and		a.nr_prescricao		=	b.nr_prescricao
	and		coalesce(a.nr_atendimento::text, '') = ''	
	and		nr_seq_dieta_cpoe	=	nr_sequencia_p

union

	select	a.nr_prescricao
	from	prescr_material	b,
			prescr_medica	a
	where	ie_tipo_item_p	in ('M','SOL','MAT')
	and		a.nr_prescricao		=	b.nr_prescricao	
	and		coalesce(a.nr_atendimento::text, '') = ''
	and		nr_seq_mat_cpoe	=	nr_sequencia_p

union

	select	a.nr_prescricao
	from	prescr_procedimento	b,
			prescr_medica	a
	where	ie_tipo_item_p	in ('P','HM','AP')
	and		a.nr_prescricao		=	b.nr_prescricao	
	and		coalesce(a.nr_atendimento::text, '') = ''
	and		nr_seq_proc_cpoe	=	nr_sequencia_p

union

	select	a.nr_prescricao
	from	prescr_gasoterapia	b,
			prescr_medica	a
	where	ie_tipo_item_p	in ('O')
	and		a.nr_prescricao		=	b.nr_prescricao	
	and		coalesce(a.nr_atendimento::text, '') = ''
	and		nr_seq_gas_cpoe		=	nr_sequencia_p

union

	select	a.nr_prescricao
	from	prescr_recomendacao b,
			prescr_medica	a
	where	ie_tipo_item_p	in ('R')
	and		a.nr_prescricao		=	b.nr_prescricao	
	and		coalesce(a.nr_atendimento::text, '') = ''		
	and		nr_seq_rec_cpoe		=	nr_sequencia_p	

union

	select	a.nr_prescricao
	from	nut_pac	b,
			prescr_medica	a
	where	ie_tipo_item_p	in ('NPTA','NPTI')
	and		a.nr_prescricao		=	b.nr_prescricao
	and		coalesce(a.nr_atendimento::text, '') = ''			
	and		b.nr_seq_npt_cpoe	=	nr_sequencia_p

union

	select	a.nr_prescricao
	from	prescr_solucao	b,
			prescr_medica	a
	where	ie_tipo_item_p	in ('DI')
	and		a.nr_prescricao		=	b.nr_prescricao
	and		coalesce(a.nr_atendimento::text, '') = ''	
	and		nr_seq_dialise_cpoe	=	nr_sequencia_p;



BEGIN

if (ie_opcao_p	= 'V') then

	if (coalesce(nr_prescricao_p::text, '') = '') then
		if (ie_tipo_item_p = 'P') then
			
			update	cpoe_procedimento
			set	nr_atendimento	= nr_atendimento_p,
				dt_atualizacao	= clock_timestamp(),
				nm_usuario	= nm_usuario_p
			where	nr_sequencia	= nr_sequencia_p
			and	coalesce(nr_atendimento::text, '') = '';
			
		elsif (ie_tipo_item_p in ('D','J','SNE','LD','S','NPTA','NPTI')) then
			
			update	cpoe_dieta
			set	nr_atendimento	= nr_atendimento_p,
				dt_atualizacao	= clock_timestamp(),
				nm_usuario	= nm_usuario_p
			where	nr_sequencia	= nr_sequencia_p
			and	coalesce(nr_atendimento::text, '') = '';
			
		elsif (ie_tipo_item_p in ('MAT','SOL','M')) then	
			
			update	cpoe_material
			set	nr_atendimento	= nr_atendimento_p,
				dt_atualizacao	= clock_timestamp(),
				nm_usuario	= nm_usuario_p
			where	nr_sequencia	= nr_sequencia_p
			and	coalesce(nr_atendimento::text, '') = '';		
			
		elsif (ie_tipo_item_p = 'O') then	
			
			update	cpoe_gasoterapia
			set	nr_atendimento	= nr_atendimento_p,
				dt_atualizacao	= clock_timestamp(),
				nm_usuario	= nm_usuario_p
			where	nr_sequencia	= nr_sequencia_p
			and	coalesce(nr_atendimento::text, '') = '';				
			
		elsif (ie_tipo_item_p = 'R') then	
			
			update	cpoe_recomendacao
			set	nr_atendimento	= nr_atendimento_p,
				dt_atualizacao	= clock_timestamp(),
				nm_usuario	= nm_usuario_p
			where	nr_sequencia	= nr_sequencia_p
			and	coalesce(nr_atendimento::text, '') = '';						

		elsif (ie_tipo_item_p = 'HM') then	
			
			update	cpoe_hemoterapia
			set	nr_atendimento	= nr_atendimento_p,
				dt_atualizacao	= clock_timestamp(),
				nm_usuario	= nm_usuario_p
			where	nr_sequencia	= nr_sequencia_p
			and	coalesce(nr_atendimento::text, '') = '';						
			
		elsif (ie_tipo_item_p = 'DI') then	
			
			update	cpoe_dialise
			set	nr_atendimento	= nr_atendimento_p,
				dt_atualizacao	= clock_timestamp(),
				nm_usuario	= nm_usuario_p
			where	nr_sequencia	= nr_sequencia_p
			and	coalesce(nr_atendimento::text, '') = '';						
			
		elsif (ie_tipo_item_p = 'AP') then	
			
			update	cpoe_anatomia_patologica
			set	nr_atendimento	= nr_atendimento_p,
				dt_atualizacao	= clock_timestamp(),
				nm_usuario	= nm_usuario_p
			where	nr_sequencia	= nr_sequencia_p
			and	coalesce(nr_atendimento::text, '') = '';						
		end if;
		
		FOR c01_W IN c01
		LOOP
			update 	prescr_medica
			set		nr_atendimento = nr_atendimento_p
			where 	nr_prescricao = c01_W.nr_prescricao
			and 	coalesce(nr_atendimento::text, '') = '';
			
			commit;		
			CALL CPOE_Vincular_atend_prescr( c01_W.nr_prescricao, nr_atendimento_p, nm_usuario_p );
		END LOOP c01;
		
	else
	
		if (nr_atendimento_p IS NOT NULL AND nr_atendimento_p::text <> '') then
			
			update 	prescr_medica
			set		nr_atendimento = nr_atendimento_p
			where 	nr_prescricao = nr_prescricao_p
			and 	coalesce(nr_atendimento::text, '') = '';
			
			commit;			
		end if;
	
		CALL CPOE_Vincular_atend_prescr( nr_prescricao_p, nr_atendimento_p, nm_usuario_p );
	end if;	

else

	if (ie_tipo_item_p = 'P') then
		
		update	cpoe_procedimento
		set	nr_atendimento	 = NULL,
			dt_atualizacao	= clock_timestamp(),
			nm_usuario	= nm_usuario_p
		where	nr_sequencia	= nr_sequencia_p
		and	coalesce(dt_liberacao::text, '') = '';
		
	elsif (ie_tipo_item_p in ('D','J','SNE','LD','S','NPTA','NPTI')) then
		
		update	cpoe_dieta
		set	nr_atendimento	 = NULL,
			dt_atualizacao	= clock_timestamp(),
			nm_usuario	= nm_usuario_p
		where	nr_sequencia	= nr_sequencia_p
		and	coalesce(dt_liberacao::text, '') = '';
		
	elsif (ie_tipo_item_p in ('MAT','SOL','M')) then	
		
		update	cpoe_material
		set	nr_atendimento	 = NULL,
			dt_atualizacao	= clock_timestamp(),
			nm_usuario	= nm_usuario_p
		where	nr_sequencia	= nr_sequencia_p
		and	coalesce(dt_liberacao::text, '') = '';		
		
	elsif (ie_tipo_item_p = 'O') then	
		
		update	cpoe_gasoterapia
		set	nr_atendimento	 = NULL,
			dt_atualizacao	= clock_timestamp(),
			nm_usuario	= nm_usuario_p
		where	nr_sequencia	= nr_sequencia_p
		and	coalesce(dt_liberacao::text, '') = '';				
		
	elsif (ie_tipo_item_p = 'R') then	
		
		update	cpoe_recomendacao
		set	nr_atendimento	 = NULL,
			dt_atualizacao	= clock_timestamp(),
			nm_usuario	= nm_usuario_p
		where	nr_sequencia	= nr_sequencia_p
		and	coalesce(dt_liberacao::text, '') = '';						

	elsif (ie_tipo_item_p = 'HM') then	
		
		update	cpoe_hemoterapia
		set	nr_atendimento	 = NULL,
			dt_atualizacao	= clock_timestamp(),
			nm_usuario	= nm_usuario_p
		where	nr_sequencia	= nr_sequencia_p
		and	coalesce(dt_liberacao::text, '') = '';						
		
	elsif (ie_tipo_item_p = 'DI') then	
		
		update	cpoe_dialise
		set	nr_atendimento	 = NULL,
			dt_atualizacao	= clock_timestamp(),
			nm_usuario	= nm_usuario_p
		where	nr_sequencia	= nr_sequencia_p
		and	coalesce(dt_liberacao::text, '') = '';						
		
	elsif (ie_tipo_item_p = 'AP') then	
		
		update	cpoe_anatomia_patologica
		set	nr_atendimento	 = NULL,
			dt_atualizacao	= clock_timestamp(),
			nm_usuario	= nm_usuario_p
		where	nr_sequencia	= nr_sequencia_p
		and	coalesce(dt_liberacao::text, '') = '';						
	end if;	

end if;	
	
commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cpoe_vincular_atend ( ie_tipo_item_p text, nr_sequencia_p bigint, nr_prescricao_p bigint, nr_atendimento_p bigint, nm_usuario_p text, ie_opcao_p text) FROM PUBLIC;

