-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE dis_consultar_pendencias_item ( cd_material_p bigint, cd_estabelecimento_p bigint, qt_dias_consulta_p bigint, nm_usuario_p text) AS $body$
DECLARE


dt_prevista_entrega_w	timestamp;
dt_mesano_referencia_w	timestamp;
qt_prevista_entrega_w	double precision;
qt_prevista_saida_w	double precision;
qt_dia_anterior_w		double precision;
qt_final_dia_w		double precision;

cd_material_ww		integer;
cd_material_estoque_w	integer;
ds_lista_material_w		varchar(255);

C01 CURSOR FOR
	SELECT	trunc(clock_timestamp()) + dia
	from (SELECT	row_number() OVER () -1 dia
			from	tabela_sistema) alias2 ORDER by 1 asc LIMIT (-1);

C02 CURSOR FOR
SELECT	a.cd_material
from	material a
where	a.cd_material_estoque = cd_material_estoque_w;


BEGIN
delete FROM w_mapa_estoque where nm_usuario = nm_usuario_p;

select	dt_mesano_vigente
into STRICT	dt_mesano_referencia_w
from	parametro_estoque
where	cd_estabelecimento = cd_estabelecimento_p;

select	a.cd_material_estoque
into STRICT	cd_material_estoque_w
from	material a
where	a.cd_material = cd_material_p;

ds_lista_material_w := cd_material_estoque_w || ',';

open C02;
loop
fetch C02 into
	cd_material_ww;
EXIT WHEN NOT FOUND; /* apply on C02 */
	ds_lista_material_w := substr(ds_lista_material_w || cd_material_ww || ',',1,255);
end loop;
close C02;

qt_dia_anterior_w := obter_saldo_disp_estoque(cd_estabelecimento_p,cd_material_p,null,dt_mesano_referencia_w);
open C01;
loop
fetch C01 into
	dt_prevista_entrega_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	select	coalesce(sum(obter_quantidade_convertida(b.cd_material,coalesce(qt_prevista_entrega,0),b.cd_unidade_medida_compra,'UME') -
			obter_quantidade_convertida(b.cd_material,coalesce(qt_real_entrega,0),b.cd_unidade_medida_compra,'UME')),0)
	into STRICT	qt_prevista_entrega_w
	from	ordem_compra_item_entrega a,
		ordem_compra_item b,
		ordem_compra c
	where	a.nr_ordem_compra = b.nr_ordem_compra
	and	a.nr_item_oci = b.nr_item_oci
	and	a.nr_ordem_compra = c.nr_ordem_compra
	and	coalesce(a.dt_cancelamento::text, '') = ''
	and	coalesce(c.nr_seq_motivo_cancel::text, '') = ''
	and	coalesce(c.dt_baixa::text, '') = ''
	and	coalesce(b.dt_reprovacao::text, '') = ''
	and	substr(obter_se_contido(b.cd_material,ds_lista_material_w),1,1) = 'S'
	and	a.dt_prevista_entrega = dt_prevista_entrega_w
	and	coalesce(a.qt_prevista_entrega,0) > coalesce(a.qt_real_entrega,0)
	and	c.cd_estabelecimento = cd_estabelecimento_p;

	select	coalesce(sum(obter_quantidade_convertida(b.cd_material,coalesce(qt_prevista_entrega,0),b.cd_unidade_venda,'UME')),0)
	into STRICT	qt_prevista_saida_w
	from	dis_pedido_item_entrega a,
		dis_pedido_item b,
		dis_pedido c
	where	a.nr_sequencia_item = b.nr_sequencia
	and	b.nr_seq_pedido = c.nr_sequencia
	and	coalesce(b.nr_seq_motivo_cancel::text, '') = ''
	and	coalesce(c.nr_seq_motivo_cancel::text, '') = ''
	and	coalesce(c.dt_baixa::text, '') = ''
	and	substr(obter_se_contido(b.cd_material,ds_lista_material_w),1,1) = 'S'
	and	a.dt_prevista_entrega = dt_prevista_entrega_w
	and	c.cd_estabelecimento = cd_estabelecimento_p;

	if (qt_prevista_entrega_w <> 0) or (qt_prevista_saida_w <> 0) or (dt_prevista_entrega_w = trunc(clock_timestamp())) then
		begin
		qt_final_dia_w := (qt_dia_anterior_w + qt_prevista_entrega_w - qt_prevista_saida_w);

		insert into	w_mapa_estoque(
			nr_sequencia,
			dt_atualizacao,
			cd_codigo,
			nm_usuario,
			qt_saldo_anterior,
			qt_entrada1,
			qt_saida1,
			qt_saldo_atual,
			ds_descricao)
		values (nextval('w_mapa_estoque_seq'),
			dt_prevista_entrega_w,
			cd_material_p,
			nm_usuario_p,
			qt_dia_anterior_w,
			qt_prevista_entrega_w,
			qt_prevista_saida_w,
			qt_final_dia_w,
			ds_lista_material_w);

		qt_dia_anterior_w := qt_final_dia_w;
		end;
	end if;
	end;
end loop;
close C01;

commit;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE dis_consultar_pendencias_item ( cd_material_p bigint, cd_estabelecimento_p bigint, qt_dias_consulta_p bigint, nm_usuario_p text) FROM PUBLIC;

