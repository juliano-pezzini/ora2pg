-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE importar_item_cotacao_xls ( nr_cot_compra_p cot_compra.nr_cot_compra%type, cd_cgc_fornecedor_p cot_compra_forn.cd_cgc_fornecedor%type, cd_unidade_medida_compra_p cot_compra_item.cd_unidade_medida_compra%type, nr_item_cot_compra_p cot_compra_forn_item.nr_item_cot_compra%type, vl_unitario_material_p cot_compra_forn_item.vl_unitario_material%type, vl_desconto_p cot_compra_forn_item.vl_desconto%type, ds_marca_fornec_p cot_compra_forn_item.ds_marca_fornec%type, ds_observacao_p cot_compra_forn_item.ds_observacao%type, inconsistencia_importacao_p INOUT text) AS $body$
BEGIN

begin
select 	coalesce(item.erro_item,item.erro_unidade)
into STRICT inconsistencia_importacao_p    
from 	pessoa_juridica pj,
        cot_compra_forn cot_forn,
        (SELECT cot_item.nr_cot_compra,
                cot_forn.cd_cgc_fornecedor,
                case when count(case when cot_forn_item.nr_item_cot_compra = nr_item_cot_compra_p then 1 end) = 0 then obter_desc_expressao(344524) end erro_item, 
                case when count(case when cot_item.cd_unidade_medida_compra = cd_unidade_medida_compra_p  then 1 end) = 0 then OBTER_DESC_EXPRESSAO(300803)||' '||OBTER_DESC_EXPRESSAO(796824) end erro_unidade
        from 	cot_compra_item cot_item,
                cot_compra_forn_item cot_forn_item,
                cot_compra_forn cot_forn
        where 	cot_item.nr_cot_compra		= cot_forn.nr_cot_compra
        and 	cot_forn_item.nr_seq_cot_forn 	= cot_forn.nr_sequencia 
        and 	cot_item.nr_cot_compra 		= cot_forn_item.nr_cot_compra
        and 	cot_item.nr_item_cot_compra 	= cot_forn_item.nr_item_cot_compra
        group by        cot_item.nr_cot_compra,cot_forn.cd_cgc_fornecedor) item
where 	pj.cd_cgc 			        = cot_forn.cd_cgc_fornecedor
and     item.nr_cot_compra                      = cot_forn.nr_cot_compra
and     item.cd_cgc_fornecedor                  = cot_forn.cd_cgc_fornecedor
and 	cot_forn.cd_cgc_fornecedor 	        = cd_cgc_fornecedor_p
and     cot_forn.nr_cot_compra                  = nr_cot_compra_p
group by item.erro_item,item.erro_unidade;
exception when no_data_found then
        inconsistencia_importacao_p := obter_desc_expressao(309013);
end;

if coalesce(inconsistencia_importacao_p::text, '') = '' then
    update	cot_compra_forn_item 
    set	        vl_unitario_material 	= vl_unitario_material_p,
                vl_desconto 		= vl_desconto_p,
                ds_marca_fornec 	= ds_marca_fornec_p,
                ds_observacao 		= case when ds_observacao like '%'||ds_observacao_p||'%' then ds_observacao else ds_observacao||' '||ds_observacao_p end
    where       nr_cot_compra		= nr_cot_compra_p
    and		cd_cgc_fornecedor	= cd_cgc_fornecedor_p
    and		nr_item_cot_compra	= nr_item_cot_compra_p;
    commit;
else
    inconsistencia_importacao_p := OBTER_DESC_EXPRESSAO(287582)||' '||nr_item_cot_compra_p||': '||inconsistencia_importacao_p;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE importar_item_cotacao_xls ( nr_cot_compra_p cot_compra.nr_cot_compra%type, cd_cgc_fornecedor_p cot_compra_forn.cd_cgc_fornecedor%type, cd_unidade_medida_compra_p cot_compra_item.cd_unidade_medida_compra%type, nr_item_cot_compra_p cot_compra_forn_item.nr_item_cot_compra%type, vl_unitario_material_p cot_compra_forn_item.vl_unitario_material%type, vl_desconto_p cot_compra_forn_item.vl_desconto%type, ds_marca_fornec_p cot_compra_forn_item.ds_marca_fornec%type, ds_observacao_p cot_compra_forn_item.ds_observacao%type, inconsistencia_importacao_p INOUT text) FROM PUBLIC;

