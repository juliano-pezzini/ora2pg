-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE consistir_desfazer_presc_onco ( nr_prescricao_p bigint, ds_erro_p INOUT text ) AS $body$
DECLARE

    ds_erro_w                    varchar(4000);
    quantidade_w                 bigint;

BEGIN
    quantidade_w := 0;
    BEGIN
        SELECT
            COUNT(*)
        INTO STRICT quantidade_w
        FROM
            material_atend_paciente
        WHERE
            (nr_prescricao IS NOT NULL AND nr_prescricao::text <> '')
            AND nr_prescricao = nr_prescricao_p
            AND coalesce(cd_motivo_exc_conta::text, '') = '';

    EXCEPTION
        WHEN no_data_found THEN
            ds_erro_w := NULL;
        WHEN OTHERS THEN
            ds_erro_w := NULL;
            RAISE;
    END;

    IF ( quantidade_w > 0 ) THEN
        ds_erro_w := wheb_mensagem_pck.get_texto(279028);
    END IF;

    BEGIN
        SELECT
            COUNT(*)
        INTO STRICT quantidade_w
        FROM
            paciente_atend_medic   medic
            INNER JOIN paciente_atendimento   atend ON medic.nr_seq_atendimento = atend.nr_seq_atendimento
        WHERE
            medic.ie_administracao = 'A' AND
            atend.nr_seq_atendimento = (
                SELECT
                    pa.nr_seq_atendimento
                FROM
                    paciente_atendimento pa
                WHERE
                    pa.nr_prescricao = nr_prescricao_p AND
                    (pa.nr_seq_atendimento IS NOT NULL AND pa.nr_seq_atendimento::text <> ''));


        IF ( quantidade_w > 0 ) THEN
            ds_erro_w := wheb_mensagem_pck.get_texto(1191756);
        END IF;

        SELECT
            COUNT(*)
        INTO STRICT quantidade_w
        FROM
            prescr_mat_hor
        WHERE
            nr_prescricao = nr_prescricao_p
            AND (dt_checagem IS NOT NULL AND dt_checagem::text <> '');

        IF ( quantidade_w > 0 ) THEN
            ds_erro_w := wheb_mensagem_pck.get_texto(1191757);
        END IF;

        SELECT
            COUNT(*)
        INTO STRICT quantidade_w
        FROM
            can_ordem_prod
        WHERE
            nr_prescricao = nr_prescricao_p
            AND (dt_checagem IS NOT NULL AND dt_checagem::text <> '');

        IF ( quantidade_w > 0 ) THEN
            ds_erro_w := wheb_mensagem_pck.get_texto(1191758);
        END IF;

    EXCEPTION
        WHEN no_data_found THEN
            ds_erro_w := NULL;
            NULL;
        WHEN OTHERS THEN
            ds_erro_w := NULL;
            NULL;
            RAISE;
    END;

    ds_erro_p := ds_erro_w;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE consistir_desfazer_presc_onco ( nr_prescricao_p bigint, ds_erro_p INOUT text ) FROM PUBLIC;

