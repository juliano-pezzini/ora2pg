-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pep_add_clinical_note ((result_exam_codes_p text, ie_copy_option_p text, ie_tipo_evolucao_p evolucao_paciente.ie_tipo_evolucao%type, cd_pessoa_fisica_p evolucao_paciente.cd_pessoa_fisica%type, nm_usuario_p evolucao_paciente.nm_usuario%type, cd_evolucao_p out evolucao_paciente.cd_evolucao%type) is c_all_results CURSOR(nr_prescricao_p prescr_medica.nr_prescricao%type) FOR SELECT obter_desc_exame(b.nr_seq_exame) as nm_exame, c.qt_minima, c.qt_maxima, CASE WHEN b.ds_resultado is not null AND b.QT_RESULTADO IS not null THEN obter_desc_expressao(970652)||': '||b.ds_resultado||' / '||obter_desc_expressao(297049)||': '||b.QT_RESULTADO WHEN b.ds_resultado is null AND b.qt_resultado IS not null THEN obter_desc_expressao(297049)||': '||b.QT_RESULTADO WHEN b.qt_resultado is null AND b.ds_resultado is not null THEN obter_desc_expressao(970652)||': '||b.ds_resultado ELSE '' END as DS_RESULTADO, b.dt_coleta dt_coleta, g.ds_material_exame, b.ds_referencia, b.qt_resultado from exame_lab_resultado a, exame_lab_result_item b, exame_lab_padrao c, w_result_exame_grid d, prescr_medica e, exame_laboratorio f, material_exame_lab g where e.nr_prescricao = a.nr_prescricao and d.nr_seq_exame = b.nr_seq_exame and d.nr_sequencia = ( select max(x.nr_sequencia) from w_result_exame_grid x where x.nr_seq_exame = d.nr_seq_exame ) and b.nr_seq_resultado = a.nr_seq_resultado and a.nr_prescricao = nr_prescricao_p and c.nr_seq_exame = b.nr_seq_exame and b.nr_seq_material = g.nr_sequencia and b.nr_seq_exame = f.nr_seq_exame and c.nr_seq_exame = b.nr_seq_exame and ((trim(b.ds_resultado) is not null) or (trim(b.qt_resultado) is not null)) order by 1) AS $body$
BEGIN

       return;
  end;

  function make_line(nm_exame_p          exame_laboratorio.nm_exame%type,
                     qt_minima_p         exame_lab_padrao.qt_minima%type,
                     qt_maxima_p         exame_lab_padrao.qt_maxima%type,
                     ds_resultado_p      exame_lab_result_item.ds_resultado%type,
                     dt_coleta_p         exame_lab_result_item.dt_coleta%type,
                     ds_material_exame_p material_exame_lab.ds_material_exame%type,
                     ds_referencia_p     exame_lab_result_item.ds_referencia%type,
                     qt_resultado_p      exame_lab_result_item.qt_resultado%type,
                     result_title_p      varchar2,
                     nm_material_title_p varchar2,
                     coleta_date_title_p varchar2,
                     nm_exame_title_p    varchar2,
                     comparation_title_p varchar2,
                     value_title_p       varchar2,
                     lower_p             varchar2,
                     higher_p            varchar2) return;
  begin
    ds_retorno_w := '';
    ds_retorno_w := ds_retorno_w || '</br>';
    ds_retorno_w := ds_retorno_w || '<b>' || trim(both result_title_p) || '</b></br>';
    ds_retorno_w := ds_retorno_w || '<b>' || trim(both nm_material_title_p) || ':</b>' || chr(38) || 'nbsp; ' ||
                    trim(both ds_material_exame_p) || '</br>';
    ds_retorno_w := ds_retorno_w || '<b>' || trim(both coleta_date_title_p) || '</b>' || chr(38) || 'nbsp; ' ||
                    trim(both pkg_date_formaters.to_varchar(dt_coleta_p,
                                                       'timestamp',
                                                       obter_estabelecimento_ativo,
                                                       obter_usuario_ativo)) || '</br>';
    ds_retorno_w := ds_retorno_w || '<b>' || trim(both nm_exame_title_p) || '</b>' || chr(38) || 'nbsp; ' ||
                    trim(both nm_exame_p) || '</br>';

    if  coalesce(ds_referencia_p::text, '') = '' and  (qt_minima_p IS NOT NULL AND qt_minima_p::text <> '') and (qt_maxima_p IS NOT NULL AND qt_maxima_p::text <> '')
    then
        
        ds_retorno_w := ds_retorno_w || '<b>' || trim(both comparation_title_p) || ':</b>' || chr(38) || 'nbsp; ' ||
                    formatValue(qt_minima_p) || chr(38)  || 'nbsp; ~ ' || chr(38)  || 'nbsp;' || formatValue(qt_maxima_p) || chr(38)  || 'nbsp;' || '</br>';
    else
        ds_retorno_w := ds_retorno_w || '<b>' || trim(both comparation_title_p) || ':</b>' || chr(38) || 'nbsp; ' ||
                    trim(both ds_referencia_p) || '</br>';
    end if;


    if  length( COALESCE(ds_resultado_p,'') ) > 0 OR  coalesce(qt_resultado_p::text, '') = ''
    then
        ds_retorno_w := ds_retorno_w || '<b>' || trim(both value_title_p) || ':</b>' || chr(38) || 'nbsp;' ||
                        trim(both ds_resultado_p) || chr(38) || 'nbsp; ';
    else
         ds_retorno_w := ds_retorno_w || '<b>' || trim(both value_title_p) || ':</b>' || chr(38) || 'nbsp;' ||
                        formatValue(qt_resultado_p) || chr(38) || 'nbsp; ';
    end if;

    if (qt_resultado_p IS NOT NULL AND qt_resultado_p::text <> '') and (qt_minima_p IS NOT NULL AND qt_minima_p::text <> '') and (qt_maxima_p IS NOT NULL AND qt_maxima_p::text <> '')
    then
      if qt_resultado_p < qt_minima_p
      then
        ds_retorno_w := ds_retorno_w || chr(38) || 'nbsp; (' || trim(both lower_p) || ')' || '</br>';
      elsif qt_resultado_p > qt_maxima_p
      then
        ds_retorno_w := ds_retorno_w || chr(38) || 'nbsp; (' || trim(both higher_p) || ')' || '</br>';
      else
        ds_retorno_w := ds_retorno_w || '</br>';
      end if;
    end if;

    return;
  end;
begin
  ds_evolucao_w := '';
  if (result_exam_codes_p IS NOT NULL AND result_exam_codes_p::text <> '')
  then
    select cast(regexp_substr(result_exam_codes_p, '[^-]+', 1, 1) as bigint)
      into STRICT nr_prescricao_w
;
    select ap.nr_atendimento
      into STRICT nr_atendimento_w
      from prescr_medica        pm,
           atendimento_paciente ap
     where pm.nr_atendimento = ap.nr_atendimento
       and pm.nr_prescricao = nr_prescricao_w
     order by 1;
    select trim(both obter_desc_expressao(952387))
      into STRICT result_title_w
;
    select trim(both obter_desc_expressao(515571))
      into STRICT nm_material_title_w
;
    select trim(both obter_desc_expressao(507627))
      into STRICT coleta_date_title_w
;
    select trim(both obter_desc_expressao(576976))
      into STRICT nm_exame_title_w
;
    select trim(both obter_desc_expressao(301492))
      into STRICT comparation_title_w
;
    select trim(both obter_desc_expressao(301251))
      into STRICT value_title_w
;
    lower_w := 'L';
    higher_w := 'H';
    if ie_copy_option_p = '0'
    then
      open c_all_results(nr_prescricao_w);
      loop
        fetch c_all_results
          into nm_exame_w, qt_minima_w, qt_maxima_w, ds_resultado_w, dt_coleta_w, ds_material_exame_w, ds_referencia_w, qt_resultado_w;
        EXIT WHEN NOT FOUND; /* apply on c_all_results */
        ds_evolucao_w := ds_evolucao_w || make_line(nm_exame_w,
                                                    qt_minima_w,
                                                    qt_maxima_w,
                                                    ds_resultado_w,
                                                    dt_coleta_w,
                                                    ds_material_exame_w,
                                                    ds_referencia_w,
                                                    qt_resultado_w,
                                                    result_title_w,
                                                    nm_material_title_w,
                                                    coleta_date_title_w,
                                                    nm_exame_title_w,
                                                    comparation_title_w,
                                                    value_title_w,
                                                    lower_w,
                                                    higher_w);
      end loop;
      close c_all_results;
    elsif ie_copy_option_p = '1'
    then
      open c_selected_results(nr_prescricao_w, result_exam_codes_p);
      loop
        fetch c_selected_results
          into nm_exame_w, qt_minima_w, qt_maxima_w, ds_resultado_w, dt_coleta_w, ds_material_exame_w, ds_referencia_w, qt_resultado_w;
        EXIT WHEN NOT FOUND; /* apply on c_selected_results */
        ds_evolucao_w := ds_evolucao_w || make_line(nm_exame_w,
                                                    qt_minima_w,
                                                    qt_maxima_w,
                                                    ds_resultado_w,
                                                    dt_coleta_w,
                                                    ds_material_exame_w,
                                                    ds_referencia_w,
                                                    qt_resultado_w,
                                                    result_title_w,
                                                    nm_material_title_w,
                                                    coleta_date_title_w,
                                                    nm_exame_title_w,
                                                    comparation_title_w,
                                                    value_title_w,
                                                    lower_w,
                                                    higher_w);
      end loop;
      close c_selected_results;
    elsif ie_copy_option_p = '2'
    then
      open c_not_selected(nr_prescricao_w, result_exam_codes_p);
      loop
        fetch c_not_selected
          into nm_exame_w, qt_minima_w, qt_maxima_w, ds_resultado_w, dt_coleta_w, ds_material_exame_w, ds_referencia_w, qt_resultado_w;
        EXIT WHEN NOT FOUND; /* apply on c_not_selected */
        ds_evolucao_w := ds_evolucao_w || make_line(nm_exame_w,
                                                    qt_minima_w,
                                                    qt_maxima_w,
                                                    ds_resultado_w,
                                                    dt_coleta_w,
                                                    ds_material_exame_w,
                                                    ds_referencia_w,
                                                    qt_resultado_w,
                                                    result_title_w,
                                                    nm_material_title_w,
                                                    coleta_date_title_w,
                                                    nm_exame_title_w,
                                                    comparation_title_w,
                                                    value_title_w,
                                                    lower_w,
                                                    higher_w);
      end loop;
      close c_not_selected;
    end if;
    select nextval('evolucao_paciente_seq')
      into STRICT cd_evolucao_p
;
    begin_html_w := '<html tasy="html5"><body><p style="text-align:left;"><span style="font-size:18px;font-family:Comic Sans MS, cursive;color:#000000;">';
    end_html_w := '</span></p></body></html>';
    ds_evolucao_w := trim(both begin_html_w) || trim(both ds_evolucao_w) || trim(both end_html_w);
    insert into evolucao_paciente(cd_evolucao,
       ds_evolucao,
       dt_evolucao,
       ie_tipo_evolucao,
       ie_evolucao_clinica,
       cd_pessoa_fisica,
       dt_atualizacao,
       nm_usuario,
       nr_atendimento,
       ie_nivel_atencao,
       ie_situacao,
       ie_avaliador_aux,
       ie_evolucao_dor,
       ie_acao)
    values (cd_evolucao_p,
       ds_evolucao_w,
       clock_timestamp(),
       '1',
       ie_tipo_evolucao_p,
       cd_pessoa_fisica_p,
       clock_timestamp(),
       nm_usuario_p,
       nr_atendimento_w,
       'T',
       'A',
       'N',
       'N',
       'I');
  end if;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pep_add_clinical_note ((result_exam_codes_p text, ie_copy_option_p text, ie_tipo_evolucao_p evolucao_paciente.ie_tipo_evolucao%type, cd_pessoa_fisica_p evolucao_paciente.cd_pessoa_fisica%type, nm_usuario_p evolucao_paciente.nm_usuario%type, cd_evolucao_p out evolucao_paciente.cd_evolucao%type) is c_all_results CURSOR(nr_prescricao_p prescr_medica.nr_prescricao%type) FOR SELECT obter_desc_exame(b.nr_seq_exame) as nm_exame, c.qt_minima, c.qt_maxima, CASE WHEN b.ds_resultado is not null AND b.QT_RESULTADO IS not null THEN obter_desc_expressao(970652)||': '||b.ds_resultado||' / '||obter_desc_expressao(297049)||': '||b.QT_RESULTADO WHEN b.ds_resultado is null AND b.qt_resultado IS not null THEN obter_desc_expressao(297049)||': '||b.QT_RESULTADO WHEN b.qt_resultado is null AND b.ds_resultado is not null THEN obter_desc_expressao(970652)||': '||b.ds_resultado ELSE '' END as DS_RESULTADO, b.dt_coleta dt_coleta, g.ds_material_exame, b.ds_referencia, b.qt_resultado from exame_lab_resultado a, exame_lab_result_item b, exame_lab_padrao c, w_result_exame_grid d, prescr_medica e, exame_laboratorio f, material_exame_lab g where e.nr_prescricao = a.nr_prescricao and d.nr_seq_exame = b.nr_seq_exame and d.nr_sequencia = ( select max(x.nr_sequencia) from w_result_exame_grid x where x.nr_seq_exame = d.nr_seq_exame ) and b.nr_seq_resultado = a.nr_seq_resultado and a.nr_prescricao = nr_prescricao_p and c.nr_seq_exame = b.nr_seq_exame and b.nr_seq_material = g.nr_sequencia and b.nr_seq_exame = f.nr_seq_exame and c.nr_seq_exame = b.nr_seq_exame and ((trim(b.ds_resultado) is not null) or (trim(b.qt_resultado) is not null)) order by 1) FROM PUBLIC;

