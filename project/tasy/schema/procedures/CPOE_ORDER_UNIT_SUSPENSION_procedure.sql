-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';



CREATE TYPE cpoe_rp AS (qt_item bigint);
CREATE TYPE cpoe_order_unit AS (qt_item bigint);


CREATE OR REPLACE PROCEDURE cpoe_order_unit_suspension (nr_atendimento_p bigint, lista_itens_p text, nm_usuario_p text) AS $body$
DECLARE

									
ds_items_suspend_w          varchar(2000);
ie_tipo_item_w      	    varchar(255);
item_w          		    varchar(255);
nr_order_unit_w			    varchar(255); --cpoe_order_unit.nr_order_unit%type;
nr_rp_w			            varchar(255); --cpoe_rp.nr_sequencia_rp%type;
i_order_unit                integer;
i_cpoe_rp                   integer;
nr_seq_item_w               bigint;--cpoe_material.nr_sequencia%type;
nr_seq_cpoe_rp_w            bigint := NULL;
nr_seq_cpoe_order_unit_w    bigint;
qt_item_w          bigint;
qt_suspended_w      bigint;
ie_se_liberado_w            varchar(1);
ds_error_w                  varchar(1000);
type vetor_cpoe_rp is table of cpoe_rp index by varchar(10);
vetor_cpoe_rp_w     vetor_cpoe_rp;
type vetor_order_unit is table of cpoe_order_unit index by varchar(10);
vetor_order_unit_w     vetor_order_unit;



BEGIN
ds_items_suspend_w :=   substr(lista_itens_p,2,length(lista_itens_p) - 2 );
WHILE (ds_items_suspend_w IS NOT NULL AND ds_items_suspend_w::text <> '') LOOP

    nr_seq_item_w := substr( ds_items_suspend_w,1,position(';' in ds_items_suspend_w) - 1);--254658 = sequencia do registro
    ds_items_suspend_w := substr( ds_items_suspend_w,position(';' in ds_items_suspend_w) + 1,length( ds_items_suspend_w ) - 1);--  ;M;S,  456786;D;N,  15648;P;S]
    ie_tipo_item_w := substr( ds_items_suspend_w,0,position(';' in ds_items_suspend_w) - 1);--'M' = Tipo item
    ds_items_suspend_w := substr( ds_items_suspend_w,position(';' in ds_items_suspend_w),length( ds_items_suspend_w ));--;S,  456786;D;N,  15648;P;S]r
    ie_se_liberado_w := substr( ds_items_suspend_w,position(';' in ds_items_suspend_w) + 1,position(',' in ds_items_suspend_w) - 2);--'S' = Se liberado
    ds_items_suspend_w := substr( ds_items_suspend_w,position(',' in ds_items_suspend_w) + 1,length( ds_items_suspend_w ));-- 456786;D;N,  15648;P;S]
    nr_seq_cpoe_order_unit_w    := null;
    nr_seq_cpoe_rp_w    := null;

    if (ie_se_liberado_w = 'S') then
        
        IF (ie_tipo_item_w in ('MA','M')) THEN
            BEGIN
            SELECT  nr_seq_cpoe_order_unit,
                    nr_seq_cpoe_rp
            INTO STRICT    nr_seq_cpoe_order_unit_w,
                    nr_seq_cpoe_rp_w
            FROM    cpoe_material
            WHERE   nr_atendimento  = nr_atendimento_p
            AND     nr_sequencia    = nr_seq_item_w;
            EXCEPTION
                WHEN OTHERS THEN
                    nr_seq_cpoe_order_unit_w    := NULL;
                    nr_seq_cpoe_rp_w            := NULL;
                RAISE;
            END;
        ELSIF (ie_tipo_item_w = 'N') THEN
            BEGIN
            SELECT  nr_seq_cpoe_order_unit
            INTO STRICT    nr_seq_cpoe_order_unit_w
            FROM    cpoe_dieta
            WHERE   nr_atendimento  = nr_atendimento_p
            AND     nr_sequencia    = nr_seq_item_w;
            EXCEPTION
                WHEN OTHERS THEN
                    nr_seq_cpoe_order_unit_w    := NULL;
                RAISE;
            END;
        ELSIF (ie_tipo_item_w = 'P') THEN
            BEGIN
            SELECT  nr_seq_cpoe_order_unit
            INTO STRICT    nr_seq_cpoe_order_unit_w
            FROM    cpoe_procedimento
            WHERE   nr_atendimento  = nr_atendimento_p
            AND     nr_sequencia    = nr_seq_item_w;
            EXCEPTION
                WHEN OTHERS THEN
                    nr_seq_cpoe_order_unit_w    :=  NULL;
                RAISE;
            END;
        ELSIF (ie_tipo_item_w = 'G') THEN
            BEGIN
            SELECT  nr_seq_cpoe_order_unit
            INTO STRICT    nr_seq_cpoe_order_unit_w
            FROM    cpoe_gasoterapia
            WHERE   nr_atendimento  = nr_atendimento_p
            AND     nr_sequencia    = nr_seq_item_w;
            EXCEPTION
                WHEN OTHERS THEN
                    nr_seq_cpoe_order_unit_w    := NULL;
                RAISE;
            END;
        ELSIF (ie_tipo_item_w = 'R') THEN
            BEGIN
            SELECT  nr_seq_cpoe_order_unit
            INTO STRICT    nr_seq_cpoe_order_unit_w
            FROM    cpoe_recomendacao
            WHERE   nr_atendimento  = nr_atendimento_p
            AND     nr_sequencia    = nr_seq_item_w;
            EXCEPTION
                WHEN OTHERS THEN
                    nr_seq_cpoe_order_unit_w    := NULL;
                RAISE;
            END;
        ELSIF (ie_tipo_item_w = 'H') THEN
            BEGIN
            SELECT  nr_seq_cpoe_order_unit
            INTO STRICT    nr_seq_cpoe_order_unit_w
            FROM    cpoe_hemoterapia
            WHERE   nr_atendimento  = nr_atendimento_p
            AND     nr_sequencia    = nr_seq_item_w;
            EXCEPTION
                WHEN OTHERS THEN
                    nr_seq_cpoe_order_unit_w    := NULL;
                RAISE;
            END;
        ELSIF (ie_tipo_item_w in ('D','DI','DP')) THEN
            BEGIN
            SELECT  nr_seq_cpoe_order_unit
            INTO STRICT    nr_seq_cpoe_order_unit_w
            FROM    cpoe_dialise
            WHERE   nr_atendimento  = nr_atendimento_p
            AND     nr_sequencia    = nr_seq_item_w;
            EXCEPTION
               WHEN OTHERS THEN
                    nr_seq_cpoe_order_unit_w    := NULL;
                RAISE;
            END;
        ELSIF (ie_tipo_item_w = 'AP') THEN
            BEGIN
            SELECT  nr_seq_cpoe_order_unit
            INTO STRICT    nr_seq_cpoe_order_unit_w
            FROM    cpoe_anatomia_patologica
            WHERE   nr_atendimento  = nr_atendimento_p
            AND     nr_sequencia    = nr_seq_item_w;
            EXCEPTION
                WHEN OTHERS THEN
                    nr_seq_cpoe_order_unit_w    := NULL;
                RAISE;
            END;
        END IF;

        IF (nr_seq_cpoe_order_unit_w IS NOT NULL AND nr_seq_cpoe_order_unit_w::text <> '') THEN
            IF (vetor_order_unit_w.exists(nr_seq_cpoe_order_unit_w)) THEN
                vetor_order_unit_w[nr_seq_cpoe_order_unit_w].qt_item    := vetor_order_unit_w[nr_seq_cpoe_order_unit_w].qt_item + 1;
            else
                vetor_order_unit_w[nr_seq_cpoe_order_unit_w].qt_item    := 1;
            END IF;
        END IF;

        IF (nr_seq_cpoe_rp_w IS NOT NULL AND nr_seq_cpoe_rp_w::text <> '') THEN
            IF (vetor_cpoe_rp_w.exists(nr_seq_cpoe_rp_w)) THEN
                vetor_cpoe_rp_w[nr_seq_cpoe_rp_w].qt_item    := vetor_cpoe_rp_w[nr_seq_cpoe_rp_w].qt_item + 1;
            else
                vetor_cpoe_rp_w[nr_seq_cpoe_rp_w].qt_item    := 1;
            END IF;
        END IF;
    end if;
END LOOP;

i_order_unit    := vetor_order_unit_w.first;  -- Get first element of array
WHILE (i_order_unit IS NOT NULL AND i_order_unit::text <> '') LOOP
    nr_seq_cpoe_order_unit_w    := (i_order_unit)::numeric;

    SELECT  COUNT(1)
    INTO STRICT    qt_item_w
    FROM    itens_cpoe_v
    WHERE   nr_atendimento = nr_atendimento_p
    AND     nr_seq_cpoe_order_unit = nr_seq_cpoe_order_unit_w;

    SELECT  COUNT(1)
    INTO STRICT    qt_suspended_w
    FROM    itens_cpoe_v
    WHERE   nr_atendimento = nr_atendimento_p
    AND     nr_seq_cpoe_order_unit = nr_seq_cpoe_order_unit_w
    and     (dt_lib_suspensao IS NOT NULL AND dt_lib_suspensao::text <> '');

    IF (qt_item_w = qt_suspended_w) THEN
        UPDATE cpoe_order_unit SET dt_lib_suspensao = clock_timestamp(), nm_usuario_susp = nm_usuario_p WHERE nr_sequencia =  nr_seq_cpoe_order_unit_w;
    END IF;

    i_order_unit := vetor_order_unit_w.NEXT(i_order_unit);
END LOOP;

i_cpoe_rp       := vetor_cpoe_rp_w.first;
WHILE (i_cpoe_rp IS NOT NULL AND i_cpoe_rp::text <> '') LOOP
     nr_seq_cpoe_rp_w    := (i_cpoe_rp)::numeric;

    SELECT  COUNT(1)
    INTO STRICT    qt_item_w
    FROM    itens_cpoe_v
    WHERE   nr_atendimento = nr_atendimento_p
    AND     nr_seq_cpoe_rp = nr_seq_cpoe_rp_w;

    SELECT  COUNT(1)
    INTO STRICT    qt_suspended_w
    FROM    itens_cpoe_v
    WHERE   nr_atendimento = nr_atendimento_p
    AND     nr_seq_cpoe_rp = nr_seq_cpoe_rp_w
    and     (dt_lib_suspensao IS NOT NULL AND dt_lib_suspensao::text <> '');

    IF (qt_item_w = qt_suspended_w) THEN
       UPDATE cpoe_rp SET dt_lib_suspensao = clock_timestamp(), nm_usuario_susp = nm_usuario_p WHERE nr_sequencia =  nr_seq_cpoe_rp_w;
    END IF;

    i_cpoe_rp := vetor_cpoe_rp_w.NEXT(i_cpoe_rp);
END LOOP;
exception
WHEN data_exception THEN
ds_error_w := substr(sqlerrm,1,1000);
	CALL gravar_log_cpoe('CPOE_ORDER_UNIT_SUSPENSION exception: '||ds_error_w||
			' nr_atendimento_p: '||nr_atendimento_p||
			' lista_itens_p: '||lista_itens_p||
			' nm_usuario_p: '||nm_usuario_p,nr_atendimento_p);
when others then
	rollback;
	ds_error_w := substr(sqlerrm,1,1000);
	CALL gravar_log_cpoe('CPOE_ORDER_UNIT_SUSPENSION exception: '||ds_error_w||
			' nr_atendimento_p: '||nr_atendimento_p||
			' lista_itens_p: '||lista_itens_p||
			' nm_usuario_p: '||nm_usuario_p,nr_atendimento_p);

	commit;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cpoe_order_unit_suspension (nr_atendimento_p bigint, lista_itens_p text, nm_usuario_p text) FROM PUBLIC;

