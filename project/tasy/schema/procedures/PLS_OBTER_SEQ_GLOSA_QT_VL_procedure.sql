-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_obter_seq_glosa_qt_vl ( nr_seq_conta_p bigint, nr_seq_conta_proc_p bigint, nr_seq_conta_mat_p bigint, nr_seq_proc_partic_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint, nr_seq_maior_vl_p INOUT bigint, nr_seq_maior_qt_p INOUT bigint ) AS $body$
DECLARE


nr_seq_retorno_w		bigint	:= 0;
qt_glosa_w			double precision;
vl_glosa_w			double precision;
ie_glosa_manual_w		varchar(1);


BEGIN

select	max(ie_glosa_manual)
into STRICT	ie_glosa_manual_w
from	pls_param_analise_conta
where	cd_estabelecimento = cd_estabelecimento_p;

if (coalesce(ie_glosa_manual_w,'N') = 'S') then

	select 	max(nr_sequencia)
	into STRICT	nr_seq_retorno_w
	from	pls_analise_conta_item
	where	(((nr_seq_conta = nr_seq_conta_p) and (coalesce(nr_seq_conta_proc, coalesce(nr_seq_conta_mat,coalesce(nr_seq_proc_partic,0))) = 0))
	or	 (nr_seq_conta = nr_seq_conta_p and ((nr_seq_conta_proc = nr_seq_conta_proc_p) or (nr_seq_conta_mat = nr_seq_conta_mat_p) or (nr_seq_proc_partic = nr_seq_proc_partic_p))))
	and	coalesce(nr_seq_discussao::text, '') = ''
	and	coalesce(nr_seq_conta_pos_estab::text, '') = ''
	and	ie_principal = 'S'
	and	not ie_status in ('P', 'L');

end if;

if (coalesce(nr_seq_retorno_w,0) = 0) then

	select 	max(nr_sequencia)
	into STRICT	nr_seq_retorno_w
	from	pls_analise_conta_item
	where	((nr_seq_conta = nr_seq_conta_p) and (coalesce(nr_seq_conta_proc, coalesce(nr_seq_conta_mat,coalesce(nr_seq_proc_partic,0))) = 0))
	and	coalesce(nr_seq_discussao::text, '') = ''
	and	coalesce(nr_seq_conta_pos_estab::text, '') = ''
	and	ie_status = 'N';

	if (coalesce(nr_seq_retorno_w,0) = 0) then
		select	max(qt_glosa),
			max(vl_glosa)
		into STRICT	qt_glosa_w,
			vl_glosa_w
		from	pls_analise_conta_item
		where	(((nr_seq_conta = nr_seq_conta_p) and (coalesce(nr_seq_conta_proc, coalesce(nr_seq_conta_mat,coalesce(nr_seq_proc_partic,0))) = 0))
		or	 (nr_seq_conta = nr_seq_conta_p and ((nr_seq_conta_proc = nr_seq_conta_proc_p) or (nr_seq_conta_mat = nr_seq_conta_mat_p) or (nr_seq_proc_partic = nr_seq_proc_partic_p))))
		and	coalesce(nr_seq_discussao::text, '') = ''
		and	coalesce(nr_seq_conta_pos_estab::text, '') = ''
		and	ie_status in ('L', 'N');

		if (coalesce(vl_glosa_w,0) > 0) then
			select	max(nr_sequencia)
			into STRICT	nr_seq_maior_vl_p
			from	pls_analise_conta_item
			where	(((nr_seq_conta = nr_seq_conta_p) and (coalesce(nr_seq_conta_proc, coalesce(nr_seq_conta_mat,coalesce(nr_seq_proc_partic,0))) = 0))
			or	 (nr_seq_conta = nr_seq_conta_p and ((nr_seq_conta_proc = nr_seq_conta_proc_p) or (nr_seq_conta_mat = nr_seq_conta_mat_p) or (nr_seq_proc_partic = nr_seq_proc_partic_p))))
			and	coalesce(nr_seq_discussao::text, '') = ''
			and	coalesce(nr_seq_conta_pos_estab::text, '') = ''
			and	ie_status in ('L', 'N')
			and	vl_glosa = vl_glosa_w;
		end if;

		if (coalesce(qt_glosa_w,0) > 0) then
			select	max(nr_sequencia)
			into STRICT	nr_seq_maior_qt_p
			from	pls_analise_conta_item
			where	(((nr_seq_conta = nr_seq_conta_p) and (coalesce(nr_seq_conta_proc, coalesce(nr_seq_conta_mat,coalesce(nr_seq_proc_partic,0))) = 0))
			or	 (nr_seq_conta = nr_seq_conta_p and ((nr_seq_conta_proc = nr_seq_conta_proc_p) or (nr_seq_conta_mat = nr_seq_conta_mat_p) or (nr_seq_proc_partic = nr_seq_proc_partic_p))))
			and	coalesce(nr_seq_discussao::text, '') = ''
			and	coalesce(nr_seq_conta_pos_estab::text, '') = ''
			and	ie_status in ('L', 'N')
			and	qt_glosa = qt_glosa_w;
		end if;
	else
		nr_seq_maior_vl_p	:= nr_seq_retorno_w;
		nr_seq_maior_qt_p  	:= nr_seq_retorno_w;
	end if;
else
	nr_seq_maior_vl_p	:= nr_seq_retorno_w;
	nr_seq_maior_qt_p  	:= nr_seq_retorno_w;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_obter_seq_glosa_qt_vl ( nr_seq_conta_p bigint, nr_seq_conta_proc_p bigint, nr_seq_conta_mat_p bigint, nr_seq_proc_partic_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint, nr_seq_maior_vl_p INOUT bigint, nr_seq_maior_qt_p INOUT bigint ) FROM PUBLIC;

