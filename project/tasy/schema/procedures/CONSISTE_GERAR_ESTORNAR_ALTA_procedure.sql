-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE consiste_gerar_estornar_alta ( ds_observacao_p text, ie_gerar_alta_uti_p text, ie_gerar_alta_uti_pac_p text, ie_alta_condicionada_p text, ie_alta_prescr_prev_p text, ie_permite_alta_lanc_post_p text, ie_mat_pend_adep_alta_p text, ie_consiste_transferencia_p text, cd_hospital_dest_p text, cd_empresa_transp_p text, ie_consiste_empresa_transp_p text, cd_motivo_alta_p bigint, nr_atendimento_p bigint, cd_setor_atendimento_p bigint, dt_alta_p timestamp, cd_motivo_permanencia_p bigint, cd_estabelecimento_p bigint, ie_inserir_motivo_perm_p INOUT text, ds_avaliacao_alta_p INOUT text, ie_prescr_dev_pend_p INOUT text, ds_erro_p INOUT text, ie_itens_nao_adm_p INOUT text, nm_usuario_p text) AS $body$
DECLARE


ie_permite_gerar_alta_uti_w	varchar(1);
ie_atend_paciente_unidade_w	varchar(1);
ie_obito_motivo_alta_w		motivo_alta.ie_obito%type;
ie_gasto_pendente_w		varchar(1);
ie_gasto_pend_proced_eup_w	varchar(1);
ie_data_gasto_superior_w	varchar(1);
ie_prescr_prev_w		varchar(1);
ie_mat_pend_adep_w		varchar(1);
ie_prescr_dev_pend_w		varchar(1) := 'N';
ds_setores_w			varchar(4000);
ds_erro_w			varchar(2000);
ie_transferencia_w		motivo_alta.ie_transferencia%type;
cd_setor_atend_w		atend_paciente_unidade.cd_setor_atendimento%type;
cd_unidade_basica_w		atend_paciente_unidade.cd_unidade_basica%type;
cd_unidade_compl_w		atend_paciente_unidade.cd_unidade_compl%type;
qt_minuto_max_w			bigint;
qt_min_perm_setor_w		numeric(20);
ie_inserir_motivo_perm_w	varchar(1) := 'N';
ie_bloq_alta_inf_w		motivo_alta.ie_bloq_alta_inf%type;
ie_impedir_alta_ps_w		varchar(1);
ie_consiste_ps_w		varchar(1);
ds_valor_parametro_w		varchar(255);
ie_exige_just_mot_alta_w	varchar(1);
ie_exibir_grid_w		varchar(1);
ie_Consist_Prescr_pend_w	varchar(1);
ie_prescr_pende_w		varchar(1);
ie_Consist_CNS_infor_w		varchar(1);
ie_CNS_ifor_w			varchar(1);
nr_consiste_obito_w		med_avaliacao_paciente.nr_seq_tipo_avaliacao%type;
ie_bloquear_alta_w		varchar(1);
ie_consiste_proc_rec_w		varchar(10);

BEGIN
if (nr_atendimento_p IS NOT NULL AND nr_atendimento_p::text <> '') and (nm_usuario_p IS NOT NULL AND nm_usuario_p::text <> '') then
	begin

	select	coalesce(max(ie_obito),'N'),
		coalesce(max(ie_bloq_alta_inf),'N'),
		coalesce(max(ie_transferencia),'N')
	into STRICT	ie_obito_motivo_alta_w,
		ie_bloq_alta_inf_w,
		ie_transferencia_w
	from	motivo_alta
	where	cd_motivo_alta	= cd_motivo_alta_p;
		
	ie_exibir_grid_w := obter_valor_param_usuario(3111, 246, wheb_usuario_pck.get_cd_perfil,wheb_usuario_pck.get_nm_usuario, wheb_usuario_pck.get_cd_estabelecimento);	
	ie_Consist_Prescr_pend_w := coalesce(obter_valor_param_usuario(3111, 253, obter_perfil_ativo,obter_usuario_ativo, obter_estabelecimento_ativo),'S');	
	ie_Consist_CNS_infor_w := coalesce(obter_valor_param_usuario(3111, 257, obter_perfil_ativo,obter_usuario_ativo, obter_estabelecimento_ativo),'N');
	nr_consiste_obito_w := obter_valor_param_usuario(3111, 330, wheb_usuario_pck.get_cd_perfil,wheb_usuario_pck.get_nm_usuario, wheb_usuario_pck.get_cd_estabelecimento);
	ie_consiste_proc_rec_w := obter_valor_param_usuario(3111, 107, wheb_usuario_pck.get_cd_perfil,wheb_usuario_pck.get_nm_usuario, wheb_usuario_pck.get_cd_estabelecimento);
	
	if (ie_Consist_Prescr_pend_w = 'N') then
		select 	max(obter_prescr_pendente_atend(nr_atendimento_p))
		into STRICT	ie_prescr_pende_w
		;
		
		if (ie_prescr_pende_w = 'S') then
			CALL Wheb_mensagem_pck.exibir_mensagem_abort(231117);		
		end if;
	end if;
	
	if (ie_Consist_CNS_infor_w = 'S') then
		
		select	coalesce(obter_se_cns_informado(nr_atendimento_p),'N')
		into STRICT	ie_CNS_ifor_w
		;
		
		if (ie_CNS_ifor_w = 'N') then
			CALL Wheb_mensagem_pck.exibir_mensagem_abort(231928);		
		end if;		
	end if;
	
	if (ie_gerar_alta_uti_p = 'S') then
		begin
				
		ie_permite_gerar_alta_uti_w := permite_gerar_alta_uti(wheb_usuario_pck.get_cd_setor_atendimento, cd_motivo_alta_p);		
		
		if (ie_permite_gerar_alta_uti_w = 'N') then
			begin
			CALL Wheb_mensagem_pck.exibir_mensagem_abort(198468);		
			end;
		end if;
		end;
	end if;
		
		
		if (ie_obito_motivo_alta_w = 'S') and (nr_consiste_obito_w IS NOT NULL AND nr_consiste_obito_w::text <> '') then
			begin
				select	CASE WHEN count(1)=0 THEN  'S'  ELSE 'N' END
				into STRICT	ie_bloquear_alta_w
				from	med_avaliacao_paciente
				where	nr_atendimento = nr_atendimento_p
				and		(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
				and 	ie_situacao = 'A'
				and		nr_seq_tipo_avaliacao = nr_consiste_obito_w;
				
				if (ie_bloquear_alta_w = 'S') then
					ds_avaliacao_alta_p := SUBSTR(obter_descricao_padrao('MED_TIPO_AVALIACAO','DS_TIPO', nr_consiste_obito_w),1,100);
				end if;
			end;
		end if;
		
	if (ie_gerar_alta_uti_pac_p = 'S') then
		begin
		
		select	coalesce(max('S'),'N')
		into STRICT	ie_atend_paciente_unidade_w
		from	atend_paciente_unidade
		where	nr_atendimento = nr_atendimento_p
		and	coalesce(dt_saida_unidade::text, '') = ''
		and	obter_classif_setor(cd_setor_atendimento) = 4;
		
		if (ie_atend_paciente_unidade_w = 'S') and (ie_obito_motivo_alta_w = 'N') then
			begin
			CALL Wheb_mensagem_pck.exibir_mensagem_abort(198469);		
			end;
		end if;
		
		
	
		end;
	end if;
	
	if (ie_alta_condicionada_p in ('S','E')) then
		begin
		
		ie_gasto_pendente_w		:= obter_gasto_pendente(nr_atendimento_p);
		ie_gasto_pend_proced_eup_w	:= obter_gasto_pend_proced_eup(nr_atendimento_p,ie_alta_prescr_prev_p,dt_alta_p);
		
		if (ie_gasto_pendente_w = 'S') or (ie_gasto_pend_proced_eup_w = 'S') then
			begin
			
			ds_erro_w		:= wheb_mensagem_pck.get_texto(279773);
			ds_erro_w		:= ds_erro_w || wheb_mensagem_pck.get_texto(279774);
			ie_prescr_dev_pend_w	:= 'S';
			end;
		end if;
		end;
	elsif (ie_alta_condicionada_p = 'P') then
		ie_gasto_pend_proced_eup_w	:= obter_gasto_pend_proced_eup(nr_atendimento_p,ie_alta_prescr_prev_p,dt_alta_p);
		if (ie_gasto_pend_proced_eup_w = 'S') then
				begin
				ds_erro_w		:= wheb_mensagem_pck.get_texto(279775);
				ds_erro_w		:= ds_erro_w || wheb_mensagem_pck.get_texto(279774);
				ie_prescr_dev_pend_w	:= 'S';
				end;
		end if;
	elsif (ie_alta_condicionada_p = 'D') then
		ie_gasto_pendente_w		:= obter_gasto_pendente(nr_atendimento_p);
		if (ie_gasto_pendente_w = 'S') then
				begin
				ds_erro_w		:= wheb_mensagem_pck.get_texto(279776);
				ds_erro_w		:= ds_erro_w || wheb_mensagem_pck.get_texto(279774);
				ie_prescr_dev_pend_w	:= 'S';
				end;
		end if;
	end if;
	
	if (coalesce(ds_erro_w::text, '') = '') then
		begin
		
		ie_data_gasto_superior_w := obter_gasto_superior_nao_canc(nr_atendimento_p,dt_alta_p);
			
			
		if (ie_exibir_grid_w = 'N') and (ie_permite_alta_lanc_post_p <> 'S') and (ie_data_gasto_superior_w = 'S') then
			begin
			
			ds_setores_w	:= obter_setor_gasto_sup_nao_canc(nr_atendimento_p,dt_alta_p);
			
			if (ie_permite_alta_lanc_post_p = 'D')then
				begin
				
				if (ie_bloq_alta_inf_w = 'S')then
					begin
					CALL Wheb_mensagem_pck.exibir_mensagem_abort(198470,'DS_SETORES='||ds_setores_w);										
					end;
				end if;
				
				end;
			elsif (ie_permite_alta_lanc_post_p = 'N')then
				begin
				CALL Wheb_mensagem_pck.exibir_mensagem_abort(198470,'DS_SETORES='||ds_setores_w);				
				
				end;
			end if;
			
			end;
		end if;
		
		if (ie_alta_prescr_prev_p <> 'S') then
			begin
		
			ie_prescr_prev_w	:= obter_se_prescr_prev(nr_atendimento_p,dt_alta_p);
		
			if (ie_prescr_prev_w = 'S') then
				begin
				CALL Wheb_mensagem_pck.exibir_mensagem_abort(198471);				
				end;
			end if;
			end;
		end if;
	
		ie_mat_pend_adep_w	:= obter_se_atend_pendente_adm(nr_atendimento_p,'N');
	
		if (ie_mat_pend_adep_alta_p <> 'N') and (ie_mat_pend_adep_alta_p <> 'D') and (ie_mat_pend_adep_w = 'N') then							
			
			if (ie_mat_pend_adep_alta_p = 'S') then
				CALL Wheb_mensagem_pck.exibir_mensagem_abort(198472);				
			else	
				ds_erro_w	:= wheb_mensagem_pck.get_texto(279777);
			end if;
								
		elsif (ie_mat_pend_adep_alta_p = 'D') and (ie_mat_pend_adep_w = 'N') then
			
			select	CASE WHEN count(1)=0 THEN 'N'  ELSE 'S' END
			into STRICT	ie_itens_nao_adm_p
			from	itens_nao_administrados_v
			where	((ie_consiste_proc_rec_w = 'S') or (ie_tipo = 1))
			and	nr_atendimento = nr_atendimento_p;
		end if;
		
		if (ie_consiste_transferencia_p = 'S') or (ie_consiste_empresa_transp_p = 'S') then
			begin
						
			if (ie_transferencia_w = 'S') then
				begin
				if (ie_consiste_transferencia_p = 'S') and (cd_motivo_alta_p IS NOT NULL AND cd_motivo_alta_p::text <> '') and (coalesce(cd_hospital_dest_p::text, '') = '') then
					begin
					CALL Wheb_mensagem_pck.exibir_mensagem_abort(198473);									
					end;
				end if;
				
				if (ie_consiste_empresa_transp_p = 'S') and (coalesce(cd_empresa_transp_p::text, '') = '') then
					begin
					CALL Wheb_mensagem_pck.exibir_mensagem_abort(198474);					
					end;
				end if;
				
				end;
			end if;
			end;
		end if;
		
		ds_valor_parametro_w := obter_valor_param_usuario(
			3111, 195, wheb_usuario_pck.get_cd_perfil,
			wheb_usuario_pck.get_nm_usuario, wheb_usuario_pck.get_cd_estabelecimento);
		if (ds_valor_parametro_w = 'S') and (coalesce(ds_observacao_p::text, '') = '') then
			begin
			ie_exige_just_mot_alta_w := exige_justificativa_mot_alta(cd_motivo_alta_p);
			if (ie_exige_just_mot_alta_w = 'S') then
				begin
				CALL Wheb_mensagem_pck.exibir_mensagem_abort(105055);				
				end;
			end if;
			end;
		end if;
	
		select	max(x.cd_setor_atendimento),
			max(x.cd_unidade_basica),
			max(x.cd_unidade_compl)
		into STRICT	cd_setor_atend_w,
			cd_unidade_basica_w,
			cd_unidade_compl_w
		from	atend_paciente_unidade x,
			atendimento_paciente y
		where	y.nr_atendimento = nr_atendimento_p
		and	x.nr_atendimento = y.nr_atendimento
		and	x.nr_seq_interno = (	SELECT	coalesce(max(a.nr_seq_interno),0)	
						from 	atend_paciente_unidade a
						where	a.nr_atendimento = y.nr_atendimento
	  					and 	coalesce(a.dt_saida_unidade, a.dt_entrada_unidade + 9999)	=
							(	select max(coalesce(b.dt_saida_unidade, b.dt_entrada_unidade + 9999))
								from atend_paciente_unidade b
								where b.nr_atendimento 	= y.nr_atendimento)
						);
		
		if (cd_setor_atend_w IS NOT NULL AND cd_setor_atend_w::text <> '') then
			begin
			select	qt_minuto_max
			into STRICT	qt_minuto_max_w
			from	setor_atendimento
			where	cd_setor_atendimento	= cd_setor_atend_w;
			end;
		else
			qt_minuto_max_w	:= 0;
		end if;
		
		if (qt_minuto_max_w <> 0) then
			begin
			qt_min_perm_setor_w	:= obter_min_permanencia_setor(nr_atendimento_p,cd_setor_atend_w,cd_unidade_basica_w,cd_unidade_compl_w);
			
			if (qt_minuto_max_w > qt_min_perm_setor_w) and (coalesce(cd_motivo_permanencia_p::text, '') = '') then
				begin
				CALL Wheb_mensagem_pck.exibir_mensagem_abort(198475);				
				end;
			end if;
			
			ie_inserir_motivo_perm_w	:= 'S';
			end;
		end if;
		
		ie_impedir_alta_ps_w := obter_param_usuario(3111, 170, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_impedir_alta_ps_w);

		if (ie_impedir_alta_ps_w = 'S') then
			begin
			select	verifica_tempo_internacao_ps(nr_atendimento_p,dt_alta_p)
			into STRICT	ie_consiste_ps_w
			;

			if (ie_consiste_ps_w = 'S') then
				begin
				ds_erro_w	:= substr(obter_texto_tasy(60403, wheb_usuario_pck.get_nr_seq_idioma),1,255);
				end;
			end if;
			end;
		end if;
		end;
	end if;
	end;
end if;
ds_erro_p			:= ds_erro_w;
ie_prescr_dev_pend_p		:= ie_prescr_dev_pend_w;
ie_inserir_motivo_perm_p	:= ie_inserir_motivo_perm_w;
commit;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE consiste_gerar_estornar_alta ( ds_observacao_p text, ie_gerar_alta_uti_p text, ie_gerar_alta_uti_pac_p text, ie_alta_condicionada_p text, ie_alta_prescr_prev_p text, ie_permite_alta_lanc_post_p text, ie_mat_pend_adep_alta_p text, ie_consiste_transferencia_p text, cd_hospital_dest_p text, cd_empresa_transp_p text, ie_consiste_empresa_transp_p text, cd_motivo_alta_p bigint, nr_atendimento_p bigint, cd_setor_atendimento_p bigint, dt_alta_p timestamp, cd_motivo_permanencia_p bigint, cd_estabelecimento_p bigint, ie_inserir_motivo_perm_p INOUT text, ds_avaliacao_alta_p INOUT text, ie_prescr_dev_pend_p INOUT text, ds_erro_p INOUT text, ie_itens_nao_adm_p INOUT text, nm_usuario_p text) FROM PUBLIC;

