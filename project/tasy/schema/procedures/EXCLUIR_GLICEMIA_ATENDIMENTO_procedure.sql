-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE excluir_glicemia_atendimento (nr_atendimento_p bigint, nr_seq_glicemia_p bigint, nr_seq_protocolo_p bigint, nr_glicemia_atend_p bigint, nr_seq_medicao_p bigint, nm_usuario_p text) AS $body$
DECLARE


qt_medicao_w	bigint;


BEGIN
if (nr_atendimento_p IS NOT NULL AND nr_atendimento_p::text <> '') and (nr_seq_glicemia_p IS NOT NULL AND nr_seq_glicemia_p::text <> '') and (nr_seq_protocolo_p IS NOT NULL AND nr_seq_protocolo_p::text <> '') and (nr_glicemia_atend_p IS NOT NULL AND nr_glicemia_atend_p::text <> '') and (nm_usuario_p IS NOT NULL AND nm_usuario_p::text <> '') then
	/* excluir glicemia completa */

	if (coalesce(nr_seq_medicao_p,0) = 0) then
		/* excluir glicemia */

		delete
		from	atendimento_glicemia
		where	nr_atendimento = nr_atendimento_p
		and	nr_seq_protocolo = nr_seq_protocolo_p
		and	nr_glicemia_atend = nr_glicemia_atend_p;
	else
		/* gerar log exclusao */

		insert into atendimento_glicemia_exc(
								nr_sequencia,
								dt_atualizacao_nrec,
								nm_usuario_nrec,
								dt_atualizacao,
								nm_usuario,
								nr_atendimento,
								nr_seq_protocolo,
								nr_glicemia_atend,
								nr_glicemia,
								ie_status_glicemia,
								dt_prev_controle,
								dt_controle,
								dt_proximo_controle,
								qt_glicemia,
								qt_var_glicemia,
								qt_min_var,
								ds_sugestao,
								ds_observacao,
								qt_ui_insulina_calc,
								qt_ui_insulina_adm,
								qt_min_interv_fut,
								dt_limite_ant,
								dt_limite_pos
								)
							SELECT	nextval('atendimento_glicemia_exc_seq'),
								clock_timestamp(),
								nm_usuario_p,
								dt_atualizacao_nrec,
								nm_usuario_nrec,
								nr_atendimento,
								nr_seq_protocolo,
								nr_glicemia_atend,
								nr_glicemia,
								ie_status_glicemia,
								dt_prev_controle,
								dt_controle,
								dt_proximo_controle,
								qt_glicemia,
								qt_var_glicemia,
								qt_min_var,
								ds_sugestao,
								ds_observacao,
								qt_ui_insulina_calc,
								qt_ui_insulina_adm,
								qt_min_interv_fut,
								dt_limite_ant,
								dt_limite_pos
							from	atendimento_glicemia
							where	nr_atendimento = nr_atendimento_p
							and	nr_seq_protocolo = nr_seq_protocolo_p
							and	nr_glicemia_atend = nr_glicemia_atend_p
							and	nr_sequencia = nr_seq_medicao_p;

		/* excluir glicemia */

		delete
		from	atendimento_glicemia
		where	nr_atendimento = nr_atendimento_p
		and	coalesce(nr_seq_glicemia,0) = coalesce(nr_seq_glicemia_p,nr_seq_glicemia)
		and	nr_seq_protocolo = nr_seq_protocolo_p
		and	nr_glicemia_atend = nr_glicemia_atend_p
		and	nr_sequencia = nr_seq_medicao_p;

		/* validar status glicemia atendimento */

		if (coalesce(nr_seq_glicemia_p,0) > 0) then
			select	count(*)
			into STRICT	qt_medicao_w
			from	atendimento_glicemia
			where	nr_seq_glicemia = nr_seq_glicemia_p;

			if (qt_medicao_w = 0) then
				update	atend_glicemia
				set	ie_status_glic	= 'P',
					dt_inicio_glic	 = NULL,
					cd_pf_inic_glic	 = NULL
				where	nr_sequencia		= nr_seq_glicemia_p;
			end if;
		end if;
	end if;
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE excluir_glicemia_atendimento (nr_atendimento_p bigint, nr_seq_glicemia_p bigint, nr_seq_protocolo_p bigint, nr_glicemia_atend_p bigint, nr_seq_medicao_p bigint, nm_usuario_p text) FROM PUBLIC;

