-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE carregar_info_prescricao_js ( nr_prescricao_p bigint, ie_mostra_nome_p text, ie_idade_completa_p text, nr_atendimento_p INOUT bigint, dt_prescricao_p INOUT text, nm_medico_p INOUT text, nm_pessoa_fisica_p INOUT text, nr_idade_p INOUT text, dt_liberacao_p INOUT text, cd_pessoa_fisica_p INOUT text, ie_sexo_p INOUT text, ds_setor_atendimento_p INOUT text, ds_forma_entrega_p INOUT text, dt_entrega_p INOUT text, dt_menstruacao_p INOUT text, qt_peso_p INOUT bigint, qt_altura_p INOUT bigint, nr_prontuario_p INOUT bigint, qt_exames_p INOUT bigint, qt_exames_sem_result_p INOUT bigint, cd_convenio_p INOUT bigint, ie_tipo_atendimento_p INOUT bigint, dt_entrada_atend_p INOUT text) AS $body$
DECLARE

					 
ie_tipo_idade_w		varchar(1);
ie_exibe_medico_ext_exame_w varchar(1);
				

BEGIN 
ie_exibe_medico_ext_exame_w := 'N';
 
ie_exibe_medico_ext_exame_w := Obter_Param_Usuario(722, 330, wheb_usuario_pck.get_cd_perfil, wheb_usuario_pck.get_nm_usuario, wheb_usuario_pck.get_cd_estabelecimento, ie_exibe_medico_ext_exame_w);
 
select	CASE WHEN ie_idade_completa_p='S' THEN 'S'  ELSE 'A' END  
into STRICT	ie_tipo_idade_w
;
 
select	max(a.nr_atendimento), 
	max(to_char(a.dt_prescricao,'dd/mm/yyyy hh24:mi:ss')), 
	max(CASE WHEN ie_exibe_medico_ext_exame_w='N' THEN  obter_nome_medico(a.cd_medico,'N')  ELSE coalesce(lab_obter_medico_ext_atend(a.nr_atendimento),obter_nome_medico(a.cd_medico,'N')) END ) nm_medico, 
	max(substr(obter_nome_prescricao_ep(a.nr_prescricao,ie_mostra_nome_p),1,100)) nm_pessoa_fisica, 
	max(obter_idade_pf(a.cd_pessoa_fisica,clock_timestamp(),ie_tipo_idade_w)) nr_idade, 
	max(to_char(a.dt_liberacao,'dd/mm/yyyy hh24:mi:ss')), 
	max(a.cd_pessoa_fisica), 
	max(obter_sexo_prescricao(a.nr_prescricao)) ie_sexo, 
	max(obter_nome_setor(a.cd_setor_atendimento)) ds_Setor_atendimento, 
	max(substr(descricao_forma_entrega_laudo(nr_seq_forma_laudo),1,100)) ds_forma_entrega, 
	max(to_char(a.dt_entrega,'dd/mm/yyyy hh24:mi:ss')), 
	max(to_char(a.dt_mestruacao,'dd/mm/yyyy hh24:mi:ss')), 
	coalesce(max(a.qt_peso),max(obter_peso_atend_prescr(a.nr_atendimento))), 
	max(a.qt_altura_cm), 
	max(b.nr_prontuario), 
	max(b.cd_convenio), 
	max(b.ie_tipo_atendimento), 
	max(to_char(b.dt_entrada,'dd/mm/yyyy hh24:mi:ss')) 
into STRICT	nr_atendimento_p, 
	dt_prescricao_p, 
	nm_medico_p, 
	nm_pessoa_fisica_p, 
	nr_idade_p, 
	dt_liberacao_p, 
	cd_pessoa_fisica_p, 
	ie_sexo_p, 
	ds_setor_atendimento_p, 
	ds_forma_entrega_p, 
	dt_entrega_p, 
	dt_menstruacao_p, 
	qt_peso_p, 
	qt_altura_p, 
	nr_prontuario_p, 
	cd_convenio_p, 
	ie_tipo_atendimento_p, 
	dt_entrada_atend_p 
from 	atendimento_paciente_v b, 
	prescr_medica a 
where 	a.nr_atendimento = b.nr_atendimento 
and 	nr_prescricao = nr_prescricao_p;
 
select 	coalesce(count(*),0) 
into STRICT	qt_exames_p 
from 	prescr_procedimento a 
where 	(a.nr_seq_exame IS NOT NULL AND a.nr_seq_exame::text <> '') 
and 	coalesce(a.ie_suspenso,'N') = 'N' 
and 	obter_tipo_baixa_prescr(a.cd_motivo_baixa) = 'N' 
and 	a.nr_prescricao = nr_prescricao_p;
 
select	coalesce(count(*),0) 
into STRICT	qt_exames_sem_result_p 
from 	prescr_procedimento a, 
	exame_lab_result_item b, 
	exame_lab_resultado c 
where 	c.nr_prescricao = a.nr_prescricao 
and	b.nr_seq_prescr = a.nr_sequencia 
and	b.nr_seq_resultado = c.nr_seq_resultado 
and 	obter_tipo_baixa_prescr(a.cd_motivo_baixa) = 'N' 
and	a.ie_status_atend < 30 
and	(b.nr_seq_material IS NOT NULL AND b.nr_seq_material::text <> '') 
and	a.nr_prescricao = nr_prescricao_p;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE carregar_info_prescricao_js ( nr_prescricao_p bigint, ie_mostra_nome_p text, ie_idade_completa_p text, nr_atendimento_p INOUT bigint, dt_prescricao_p INOUT text, nm_medico_p INOUT text, nm_pessoa_fisica_p INOUT text, nr_idade_p INOUT text, dt_liberacao_p INOUT text, cd_pessoa_fisica_p INOUT text, ie_sexo_p INOUT text, ds_setor_atendimento_p INOUT text, ds_forma_entrega_p INOUT text, dt_entrega_p INOUT text, dt_menstruacao_p INOUT text, qt_peso_p INOUT bigint, qt_altura_p INOUT bigint, nr_prontuario_p INOUT bigint, qt_exames_p INOUT bigint, qt_exames_sem_result_p INOUT bigint, cd_convenio_p INOUT bigint, ie_tipo_atendimento_p INOUT bigint, dt_entrada_atend_p INOUT text) FROM PUBLIC;

