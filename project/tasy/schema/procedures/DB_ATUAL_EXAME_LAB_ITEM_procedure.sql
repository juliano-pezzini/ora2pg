-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE db_atual_exame_lab_item ( nr_prescricao_p bigint, nr_seq_prescr_p bigint, cd_exame_integracao_p text, cd_analito_p text, ds_resultado_p text, ds_observacao_p text, nm_usuario_p text, ds_referencia_p text, ds_unidade_medida_p text, ds_metodo_p text, nr_atendimento_db_p text, ds_erro_p INOUT text, ds_logs_proc_p INOUT text) AS $body$
DECLARE

 
nr_seq_exame_w			prescr_procedimento.nr_seq_exame%type;
cd_analito_w			exame_laboratorio.cd_exame%type;
cd_analito_ww			exame_laboratorio.cd_exame%type;
nr_seq_exame_analito_ww	prescr_procedimento.nr_seq_exame%type;
nr_seq_resultado_w		exame_lab_resultado.nr_seq_resultado%type;
qt_resultado_w			exame_lab_result_item.qt_resultado%type;
ds_resultado_w			exame_lab_result_item.ds_resultado%type;
pr_resultado_w			exame_lab_result_item.pr_resultado%type;
ie_formato_resultado_w exame_laboratorio.ie_formato_resultado%type;
nr_seq_metodo_w			exame_lab_result_item.nr_seq_metodo%type;
nr_seq_material_w		material_exame_lab.nr_sequencia%type;	
ds_referencia_w			exame_lab_result_item.ds_referencia%type;
ds_pedido_ext_w			prescr_medica.ds_pedido_ext%type;
ds_erro_w				varchar(4000);
ds_logs_proc_w			varchar(4000);
	

BEGIN 
ds_logs_proc_w := '';
ds_erro_w := '';
ds_referencia_w := replace(ds_referencia_p,CHR(10),CHR(13)||CHR(10));
	 
select 	MAX(a.nr_seq_exame), 
		MAX(b.nr_sequencia) 
into STRICT	nr_seq_exame_w, 
		nr_seq_material_w 
from 	prescr_procedimento a,	 
		material_exame_lab b 
where 	a.cd_material_exame = b.cd_material_exame 
and		a.nr_prescricao = nr_prescricao_p 
and		a.nr_sequencia = nr_seq_prescr_p;
 
 
if (position(cd_analito_p in cd_exame_integracao_p) > 0) then 
	cd_analito_ww := cd_exame_integracao_p;
else 
	cd_analito_ww := cd_analito_p;
end if;
 
ds_logs_proc_w := WHEB_MENSAGEM_PCK.get_texto(277700,'CD_ANALITO='||cd_analito_ww||';NR_PRESCRICAO='||nr_prescricao_p||';NR_SEQ_PRESCR='||nr_seq_prescr_p)||CHR(13)||CHR(10);
 
-- Busca pelo código do analito 
select	max(coalesce(e.cd_exame_integracao, e.cd_exame)) 
into STRICT	cd_analito_w 
from	exame_laboratorio e 
where	e.nr_seq_exame = (SELECT nr_seq_exame 
			 from equipamento_lab b, 
				lab_exame_equip a 
			 WHERE	a.cd_equipamento = b.cd_equipamento 
			 AND	a.cd_exame_equip = cd_analito_ww 
			 AND	upper(b.ds_sigla) = 'DB' 
			 AND	a.nr_seq_exame = nr_seq_exame_w);
 
 
ds_logs_proc_w := substr(ds_logs_proc_w||WHEB_MENSAGEM_PCK.get_texto(277702,null)||cd_analito_ww||CHR(13)||CHR(10),1,4000);WITH RECURSIVE cte AS (

 
if (coalesce(cd_analito_w::text, '') = '') then 
 
	select	max(coalesce(e.cd_exame_integracao, e.cd_exame)) 
	into STRICT	cd_analito_w 
	from	exame_laboratorio e WHERE nr_seq_superior = nr_seq_exame_w
  UNION ALL
 
 
if (coalesce(cd_analito_w::text, '') = '') then 
 
	select	max(coalesce(e.cd_exame_integracao, e.cd_exame)) 
	into STRICT	cd_analito_w 
	from	exame_laboratorio e JOIN cte c ON (c.prior nr_seq_exame = e.nr_seq_superior)

) SELECT * FROM cte WHERE nr_seq_exame = (SELECT nr_seq_exame 
				from equipamento_lab b, 
				   lab_exame_equip a 
				WHERE	a.cd_equipamento = b.cd_equipamento 
				AND	a.cd_exame_equip = cd_analito_ww 
				AND	upper(b.ds_sigla) = 'DB' 
				AND	a.nr_seq_exame = e.nr_seq_exame);
;
 
	ds_logs_proc_w := substr(ds_logs_proc_w||WHEB_MENSAGEM_PCK.get_texto(277703,null)||cd_analito_ww||CHR(13)||CHR(10),1,4000);
 
end if;
 
--Caso não encontre o analito com o código do resultado, o resultado é inserido no exame principal 
if (coalesce(cd_analito_w::text, '') = '') then 
	 
	select max(coalesce(cd_exame_integracao, cd_exame)) 
	into STRICT cd_analito_w 
	from exame_laboratorio 
	where coalesce(ie_situacao,'A') = 'A' 
	and	 nr_seq_exame = nr_seq_exame_w;
	 
	if (cd_analito_w IS NOT NULL AND cd_analito_w::text <> '') then 
		ds_logs_proc_w := substr(ds_logs_proc_w||WHEB_MENSAGEM_PCK.get_texto(277704,null)||cd_analito_ww||CHR(13)||CHR(10),1,4000);
	end if;
end if;
 
if (cd_analito_w IS NOT NULL AND cd_analito_w::text <> '') then 
 
	--gravar_log_tasy(30, '5nr_prescricao_p '||nr_prescricao_p||' nr_seq_prescricao_w '|| nr_seq_prescr_p ||' cd_analito_w '|| cd_analito_w || ' qt_resultado_p '||qt_resultado_w || ' ds_resultado_p '||ds_resultado_p, nm_usuario_p); 
	--commit; 
	begin 
	select 	max(ie_formato_resultado) 
	into STRICT 	ie_formato_resultado_w 
	from 	exame_laboratorio 
	where 	coalesce(cd_exame_integracao, cd_exame) = cd_analito_w;
	 
	ds_logs_proc_w := substr(ds_logs_proc_w ||WHEB_MENSAGEM_PCK.get_texto(277706,'IE_FORMATO_RESULTADO='||ie_formato_resultado_w||';CD_ANALITO='||cd_analito_w)||CHR(13)||CHR(10),1,4000);
				 
	if (substr(ie_formato_resultado_w,1,1) = 'P') then 
		select (coalesce(replace(ds_resultado_p, '.', ','),0))::numeric  
		into STRICT  pr_resultado_w 
		;
		ds_logs_proc_w := substr(ds_logs_proc_w ||WHEB_MENSAGEM_PCK.get_texto(277707,null)||pr_resultado_w||CHR(13)||CHR(10),1,4000);
	elsif (substr(ie_formato_resultado_w,1,1) = 'V') then 
		begin 
			select (coalesce(ds_resultado_p,0))::numeric  
			into STRICT qt_resultado_w 
			;
		exception 
		when others then 
			begin 
			select (coalesce(replace(ds_resultado_p, '.', ','),0))::numeric  
			into STRICT qt_resultado_w 
			;
			end;
			 
		ds_logs_proc_w := substr(ds_logs_proc_w ||WHEB_MENSAGEM_PCK.get_texto(277708,null)||qt_resultado_w||CHR(13)||CHR(10),1,4000);
		end;
	else 
		ds_resultado_w := trim(both ds_resultado_p);
		ds_logs_proc_w := substr(ds_logs_proc_w ||WHEB_MENSAGEM_PCK.get_texto(277710,null)||ds_resultado_p||CHR(13)||CHR(10),1,4000);
	end if;
 
	ds_erro_p := Atualizar_Lab_Result_Item(	nr_prescricao_p, nr_seq_prescr_p, cd_analito_w, qt_resultado_w, pr_resultado_w, ds_resultado_w, ds_observacao_p, null, null, nm_usuario_p, null, ds_referencia_w, ds_unidade_medida_p, null, null, ds_erro_p);
	exception 
	when others then 
		ds_erro_p := WHEB_MENSAGEM_PCK.get_texto(277711,null)||substr(sqlerrm,1,3500);
	end;
	 
	if (ds_observacao_p IS NOT NULL AND ds_observacao_p::text <> '') then 
		 
		select 	MAX(nr_seq_resultado) 
		into STRICT	nr_seq_resultado_w 
		from	exame_lab_resultado 
		where 	nr_prescricao = nr_prescricao_p;
		 
		if (nr_seq_resultado_w IS NOT NULL AND nr_seq_resultado_w::text <> '') then 
			 
			update 	exame_lab_result_item 
			set		ds_observacao = ds_observacao_p 
			where 	nr_seq_exame = nr_seq_exame_w 
			and		nr_seq_resultado = nr_seq_resultado_w 
			and		nr_seq_prescr = nr_seq_prescr_p;	
		 
		end if;
	 
	end if;
 
	if (ds_referencia_w IS NOT NULL AND ds_referencia_w::text <> '') then 
 
		select 	MAX(nr_seq_resultado) 
		into STRICT	nr_seq_resultado_w 
		from	exame_lab_resultado 
		where 	nr_prescricao = nr_prescricao_p;
		 
		if (nr_seq_resultado_w IS NOT NULL AND nr_seq_resultado_w::text <> '') then 
			 
			select 	MAX(nr_seq_exame) 
			into STRICT	nr_seq_exame_analito_ww 
			from	exame_laboratorio 
			where	coalesce(cd_exame_integracao, cd_exame) = cd_analito_w;
			 
			update 	exame_lab_result_item 
			set		ds_referencia_ext = ds_referencia_w 
			where 	nr_seq_exame = nr_seq_exame_analito_ww 
			and		nr_seq_resultado = nr_seq_resultado_w 
			and		nr_seq_prescr = nr_seq_prescr_p;	
		 
		end if;
	 
	end if;
	 
	if (ds_metodo_p IS NOT NULL AND ds_metodo_p::text <> '') then 
		 
		select 	MAX(a.nr_seq_metodo) 
		into STRICT	nr_seq_metodo_w 
		from 	metodo_exame_lab_int a, 
				equipamento_lab b 
		where 	a.cd_equipamento = b.cd_equipamento 
		and		a.cd_metodo_integracao = ds_metodo_p 
		and		upper(b.ds_sigla) = 'DB';
		 
		if (coalesce(nr_seq_metodo_w::text, '') = '') then 
			select 	MAX(nr_sequencia) 
			into STRICT	nr_seq_metodo_w 
			from	metodo_exame_lab 
			where	cd_integracao = ds_metodo_p;
		end if;		
		 
		if (nr_seq_metodo_w IS NOT NULL AND nr_seq_metodo_w::text <> '') then 
			ds_logs_proc_w := substr(ds_logs_proc_w ||chr(13)||chr(10)||WHEB_MENSAGEM_PCK.get_texto(277712,'NR_SEQ_METODO='||nr_seq_metodo_w||';NR_PRESCRICAO='||nr_prescricao_p),1,3900);
			--atualizar formato/metodo no resultado 
			select 	MAX(nr_seq_resultado) 
			into STRICT	nr_seq_resultado_w 
			from	exame_lab_resultado 
			where 	nr_prescricao = nr_prescricao_p;
			 
			if (nr_seq_resultado_w IS NOT NULL AND nr_seq_resultado_w::text <> '') then 
				update 	exame_lab_result_item 
				set		nr_seq_metodo = nr_seq_metodo_w, 
						nr_seq_formato = obter_formato_exame(nr_seq_exame_w,nr_seq_material_w,nr_seq_metodo_w,'L') 
				where 	(nr_seq_formato IS NOT NULL AND nr_seq_formato::text <> '') 
				and		nr_seq_resultado = nr_seq_resultado_w 
				and		nr_seq_prescr = nr_seq_prescr_p;				
			end if;
		 
		end if;
		 
		if (nr_atendimento_db_p IS NOT NULL AND nr_atendimento_db_p::text <> '') then 
		 
			update 	prescr_procedimento 
			set 	ds_pedido_ext_item 	= nr_atendimento_db_p, 
					dt_atualizacao 		= clock_timestamp(), 
					nm_usuario			= nm_usuario_p 
			where 	nr_prescricao 		= nr_prescricao_p 
			and		nr_sequencia		= nr_seq_prescr_p;			
		 
			select 	MAX(ds_pedido_ext) 
			into STRICT 	ds_pedido_ext_w 
			from 	prescr_medica 
			where	nr_prescricao = nr_prescricao_p;
			 
			if (coalesce(ds_pedido_ext_w::text, '') = '') then 
				update 	prescr_medica 
				set 	ds_pedido_ext = nr_atendimento_db_p, 
						dt_atualizacao = clock_timestamp(), 
						nm_usuario = nm_usuario_p 
				where	nr_prescricao = nr_prescricao_p;
			end if;
		end if;
	end if;
	 
	commit;	
	 
	ds_logs_proc_p := substr(ds_logs_proc_w,1,255);
else 
	ds_logs_proc_w := substr(ds_logs_proc_w||WHEB_MENSAGEM_PCK.get_texto(277714,'CD_ANALITO='||cd_analito_ww)||CHR(13)||CHR(10),1,4000);
	ds_logs_proc_p := substr(ds_logs_proc_w,1,255);
end if;
	 
		 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE db_atual_exame_lab_item ( nr_prescricao_p bigint, nr_seq_prescr_p bigint, cd_exame_integracao_p text, cd_analito_p text, ds_resultado_p text, ds_observacao_p text, nm_usuario_p text, ds_referencia_p text, ds_unidade_medida_p text, ds_metodo_p text, nr_atendimento_db_p text, ds_erro_p INOUT text, ds_logs_proc_p INOUT text) FROM PUBLIC;

