-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_migracao_contrato_web ( nr_seq_segurado_p pls_segurado.nr_sequencia%type, nr_seq_contrato_atual_p pls_contrato.nr_sequencia%type, nr_seq_contrato_mig_p pls_contrato.nr_sequencia%type, dt_migracao_p pls_migracao_beneficiario.dt_migracao%type, dt_limite_utilizacao_p pls_migracao_beneficiario.dt_limite_utilizacao%type, nr_seq_pagador_p pls_contrato_pagador.nr_sequencia%type, nr_seq_plano_p pls_plano.nr_sequencia%type, nr_seq_tabela_preco_p pls_tabela_preco.nr_sequencia%type, ie_migrar_dependente_p pls_migracao_beneficiario.ie_migrar_dependente%type, nm_usuario_p text, nr_seq_migacao_p INOUT pls_migracao_beneficiario.nr_sequencia%type) AS $body$
DECLARE

/* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Finalidade:
Solicitar a migração de contrato, no acesso de Relacionamento cliente.
-------------------------------------------------------------------------------------------------------------------
Locais de chamada direta:
[  ]  Objetos do dicionário [ ] Tasy (Delphi/Java) [ x ] Portal [  ]  Relatórios [ ] Outros:
 ------------------------------------------------------------------------------------------------------------------
Pontos de atenção:

++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */
nr_seq_migacao_w	pls_migracao_beneficiario.nr_sequencia%type;


BEGIN

begin
	select	max(nr_sequencia)
	into STRICT	nr_seq_migacao_w
	from	pls_migracao_beneficiario
	where	nr_seq_segurado = nr_seq_segurado_p
	and	ie_status = 1; --Solicitaçõa em aberto
exception
when others then
	nr_seq_migacao_w	:= null;
end;

if (nr_seq_migacao_w IS NOT NULL AND nr_seq_migacao_w::text <> '') then

	update	pls_migracao_beneficiario
	set	nr_seq_contrato_mig 	= nr_seq_contrato_mig_p,
		dt_migracao 		= dt_migracao_p,
		dt_limite_utilizacao	= dt_limite_utilizacao_p,
		nr_seq_pagador 		= nr_seq_pagador_p,
		nr_seq_plano 		= nr_seq_plano_p,
		nr_seq_tabela_preco 	= nr_seq_tabela_preco_p,
		nm_usuario 		= nm_usuario_p,
		dt_solicitacao		= clock_timestamp(),
		ie_migrar_dependente	= ie_migrar_dependente_p
	where	nr_sequencia 		= nr_seq_migacao_w;
else
	insert into pls_migracao_beneficiario(	nr_seq_contrato_mig, dt_migracao, dt_limite_utilizacao,
			nr_seq_pagador, nr_seq_plano, nr_seq_tabela_preco,
			nr_seq_segurado, nm_usuario, dt_atualizacao,
			nr_sequencia, nr_seq_contrato_atual, ie_status,
			dt_solicitacao,ie_migrar_dependente)
	values (	nr_seq_contrato_mig_p, dt_migracao_p, dt_limite_utilizacao_p,
			nr_seq_pagador_p, nr_seq_plano_p, nr_seq_tabela_preco_p,
			nr_seq_segurado_p, nm_usuario_p, clock_timestamp(),
			nextval('pls_migracao_beneficiario_seq'), nr_seq_contrato_atual_p, 1,
			clock_timestamp(), ie_migrar_dependente_p) returning nr_sequencia into nr_seq_migacao_w;

end if;

nr_seq_migacao_p	:= nr_seq_migacao_w;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_migracao_contrato_web ( nr_seq_segurado_p pls_segurado.nr_sequencia%type, nr_seq_contrato_atual_p pls_contrato.nr_sequencia%type, nr_seq_contrato_mig_p pls_contrato.nr_sequencia%type, dt_migracao_p pls_migracao_beneficiario.dt_migracao%type, dt_limite_utilizacao_p pls_migracao_beneficiario.dt_limite_utilizacao%type, nr_seq_pagador_p pls_contrato_pagador.nr_sequencia%type, nr_seq_plano_p pls_plano.nr_sequencia%type, nr_seq_tabela_preco_p pls_tabela_preco.nr_sequencia%type, ie_migrar_dependente_p pls_migracao_beneficiario.ie_migrar_dependente%type, nm_usuario_p text, nr_seq_migacao_p INOUT pls_migracao_beneficiario.nr_sequencia%type) FROM PUBLIC;

