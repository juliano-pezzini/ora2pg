-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_escritural_darf (nr_seq_darf_p bigint, cd_banco_p bigint, nr_seq_conta_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint) AS $body$
DECLARE


dt_vencimento_w		timestamp;
nr_seq_escritural_w		bigint;
nr_titulo_w		bigint;
qt_cancelado_w		bigint;

vl_juros_darf_w				darf.vl_juros%type;
vl_multa_darf_w				darf.vl_multa%type;

c01 CURSOR FOR
SELECT	a.nr_titulo
from 	darf_titulo_pagar a
where	nr_seq_darf	= nr_seq_darf_p;


BEGIN

select	nextval('banco_escritural_seq')
into STRICT	nr_seq_escritural_w
;

select	c.dt_vencimento
into STRICT	dt_vencimento_w
from	darf c
where	c.nr_sequencia	= nr_seq_darf_p;

select 	count(*)
into STRICT 	qt_cancelado_w
from 	titulo_pagar a,
	darf_titulo_pagar b,
	darf c
where	a.nr_titulo 	= b.nr_titulo
and 	b.nr_seq_darf 	= c.nr_sequencia
and 	a.ie_situacao 	= 'C'
and 	c.nr_sequencia 	= nr_seq_darf_p;

if (qt_cancelado_w > 0) then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(290461);

end if;

insert	into banco_escritural(nr_sequencia,
	cd_banco,
	nr_seq_conta_banco,
	cd_estabelecimento,
	ie_cobranca_pagto,
	ie_remessa_retorno,
	dt_remessa_retorno,
	dt_atualizacao,
	nm_usuario,
	dt_atualizacao_nrec,
	nm_usuario_nrec,
	ds_observacao)
values (nr_seq_escritural_w,
	cd_banco_p,
	nr_seq_conta_p,
	cd_estabelecimento_p,
	'C',
	'R',
	dt_vencimento_w,
	clock_timestamp(),
	nm_usuario_p,
	clock_timestamp(),
	nm_usuario_p,
	'Gerado a partir da DARF ' || nr_seq_darf_p);

open	c01;
loop
fetch	c01 into
	nr_titulo_w;
EXIT WHEN NOT FOUND; /* apply on c01 */

	CALL gerar_titulo_escritural(nr_titulo_w,nr_seq_escritural_w,nm_usuario_p);

end	loop;
close	c01;

--OS 1750569 in√≠cio
if (nr_seq_darf_p IS NOT NULL AND nr_seq_darf_p::text <> '') then

	select	max(a.vl_juros),
			max(a.vl_multa)
	into STRICT	vl_juros_darf_w,
			vl_multa_darf_w
	from	darf a
	where	a.nr_sequencia = nr_seq_darf_p;

	/*Pegar o titulo de maior valor no lote escritural para inserir os juros e multa do lote darf.*/

	nr_titulo_w := null;
	select	max(a.nr_titulo)
	into STRICT	nr_titulo_w
	from	titulo_pagar_escrit a
	where	a.nr_seq_escrit = nr_seq_escritural_w
	and		a.vl_escritural = (SELECT max(x.vl_escritural)
							   from   titulo_pagar_escrit x
							   where  x.nr_seq_escrit = nr_seq_escritural_w);

	if (nr_titulo_w IS NOT NULL AND nr_titulo_w::text <> '') then

		update	titulo_pagar_escrit
		set		vl_juros = coalesce(vl_juros,0) + coalesce(vl_juros_darf_w,0),
				vl_multa = coalesce(vl_multa,0) + coalesce(vl_multa_darf_w,0)
		where	nr_seq_escrit 	= nr_seq_escritural_w
		and		nr_titulo 		= nr_titulo_w;

	end if;



end if;
--OS 1750569 fim.
update 	darf
set 	nr_seq_escritural	= nr_seq_escritural_w
where 	nr_sequencia	= nr_seq_darf_p;
commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_escritural_darf (nr_seq_darf_p bigint, cd_banco_p bigint, nr_seq_conta_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint) FROM PUBLIC;

