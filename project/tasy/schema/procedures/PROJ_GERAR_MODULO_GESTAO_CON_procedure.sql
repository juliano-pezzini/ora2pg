-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE proj_gerar_modulo_gestao_con (nr_seq_gest_con_p bigint, nr_seq_consultor_p bigint, nm_usuario_p text) AS $body$
DECLARE


nr_sequencia_w		bigint;
cd_modulo_w		bigint;
ie_tipo_consultor_w	varchar(5);


c01 CURSOR FOR
SELECT	a.nr_sequencia
from	modulo_implantacao a
where	not exists (	select	1
                     	from	COM_CONS_GEST_CON_MOD z
                     	where	z.nr_seq_mod_impl = a.nr_sequencia
                     	and	z.NR_SEQ_CONSULTOR  = nr_seq_consultor_p
			and	nr_seq_gest_con	    = nr_seq_gest_con_p);


BEGIN
select	max(CASE WHEN coalesce(ie_tipo_consultor,'A')='CO' THEN 'O' WHEN coalesce(ie_tipo_consultor,'A')='CP' THEN 'P'  ELSE 'A' END )
into STRICT	ie_tipo_consultor_w
from	com_canal_consultor
where	nr_sequencia = nr_seq_consultor_p;

open c01;
	loop
	fetch c01 into	cd_modulo_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */

	select	nextval('com_cons_gest_con_fun_seq')
	into STRICT	nr_sequencia_w
	;

	insert	into com_cons_gest_con_mod(	nr_sequencia,
						nr_seq_consultor,
						nr_seq_mod_impl,
						nr_seq_etapa,
						dt_atualizacao,
						nm_usuario,
						dt_atualizacao_nrec,
						nm_usuario_nrec,
						nr_seq_gest_con)
					values (	nr_sequencia_w,
						nr_seq_consultor_p,
						cd_modulo_w,
						null,
						clock_timestamp(),
						nm_usuario_p,
						clock_timestamp(),
						nm_usuario_p,
						nr_seq_gest_con_p);

	CALL com_gerar_funcao_conhecimento(	nr_sequencia_w,
					cd_modulo_w,
					nm_usuario_p,
					ie_tipo_consultor_w);

	commit;

	end loop;
	close c01;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE proj_gerar_modulo_gestao_con (nr_seq_gest_con_p bigint, nr_seq_consultor_p bigint, nm_usuario_p text) FROM PUBLIC;

