-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE obter_pre_natal_suep_inf ( nr_seq_suep_p bigint, nr_atendimento_p bigint, dt_ultima_menstruacao_p INOUT text, qt_ig_semana_p INOUT text, qt_ig_dia_p INOUT text, dt_prov_parto_p INOUT text, dt_us_p INOUT text, qt_ig_sem_us_p INOUT text, qt_ig_dia_us_p INOUT text, dt_prov_parto_us_p INOUT text, qt_gestacoes_p INOUT text, qt_natimortos_p INOUT text, qt_parto_normal_p INOUT text, qt_filhos_vivos_p INOUT text, qt_filhos_mortos_p INOUT text, qt_abortos_p INOUT text, dt_evolucao_p INOUT text, qt_ig_sem_p INOUT text, qt_ig_dia_ev_p INOUT text, qt_ig_sem_us_ev_p INOUT text, qt_ig_dia_us_ev_p INOUT text, qt_contracoes_p INOUT text, ie_dinamica_uterina_p INOUT text, nr_seq_evolucao_p INOUT med_evolucao.nr_sequencia%type, qt_parto_cesario_p INOUT text, qt_au_cm_p INOUT text, ie_posicao_p INOUT text, ie_toque_p INOUT text, nr_feto_p INOUT text, ie_movimento_fetal_p INOUT text, qt_bcf_p INOUT text) AS $body$
DECLARE


	nr_seq_ult_pre_natal_w	med_pac_pre_natal.nr_sequencia%type;
	nr_evol_pre_natal_w		med_pac_pre_natal_evol.nr_sequencia%type;


BEGIN
	
	select	max(nr_sequencia)
	into STRICT	nr_seq_ult_pre_natal_w
	from	med_pac_pre_natal 
	where	coalesce(dt_inativacao::text, '') = ''
	and		(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
	and		nr_atendimento in (	SELECT	nr_atendimento 
								from	atendimento_paciente 
								where	coalesce(dt_inativacao::text, '') = ''
								and		(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
								and		cd_pessoa_fisica = OBTER_PESSOA_ATENDIMENTO(nr_atendimento_p,'C'));
								
	select	max(nr_sequencia)
	into STRICT	nr_evol_pre_natal_w
	from	med_pac_pre_natal_evol
	where	nr_seq_pre_natal = nr_seq_ult_pre_natal_w
	and		coalesce(dt_inativacao::text, '') = ''
	and		(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
	and		dt_evolucao = (	
				SELECT	max(dt_evolucao)
				from	med_pac_pre_natal_evol 
				where	nr_seq_pre_natal = nr_seq_ult_pre_natal_w
				and		coalesce(dt_inativacao::text, '') = ''
				and		(dt_liberacao IS NOT NULL AND dt_liberacao::text <> ''));
				
	select	substr(obter_valor_dominio(3895,max(c.ie_dinamica_uterina)),1,255) ie_dinamica_uterina
	into STRICT	ie_dinamica_uterina_p
	from	enf_tri_obstetrica c
	where	c.nr_atendimento = (SELECT	max(nr_atendimento)
								from	med_pac_pre_natal 
								where	nr_sequencia = nr_seq_ult_pre_natal_w);
								
	if ((nr_seq_ult_pre_natal_w IS NOT NULL AND nr_seq_ult_pre_natal_w::text <> '') and nr_seq_ult_pre_natal_w > 0) then
									
		select	PKG_DATE_FORMATERS.to_varchar(b.dt_ultima_menstruacao, 'shortDate', wheb_usuario_pck.get_cd_estabelecimento, wheb_usuario_pck.get_nm_usuario ) dt_ultima_menstruacao,
				b.qt_ig_semana,
				b.qt_ig_dia,
				PKG_DATE_FORMATERS.to_varchar(b.dt_prov_parto, 'shortDate', wheb_usuario_pck.get_cd_estabelecimento, wheb_usuario_pck.get_nm_usuario ) dt_prov_parto,
				b.qt_ig_sem_us,
				b.qt_ig_dia_us,
				b.qt_gestacoes,
				b.qt_natimortos,
				b.qt_parto_normal,
				b.qt_filhos_vivos,
				b.qt_filhos_mortos,
				b.qt_abortos,
				b.qt_parto_cesario
		into STRICT	dt_ultima_menstruacao_p,
				qt_ig_semana_p,
				qt_ig_dia_p,
				dt_prov_parto_p,
				qt_ig_sem_us_p,
				qt_ig_dia_us_p,
				qt_gestacoes_p,
				qt_natimortos_p,
				qt_parto_normal_p,
				qt_filhos_vivos_p,
				qt_filhos_mortos_p,
				qt_abortos_p,
				qt_parto_cesario_p
		from	med_pac_pre_natal b
		where	b.nr_sequencia = nr_seq_ult_pre_natal_w;									
					
		if (nr_evol_pre_natal_w > 0) then
			select	a.qt_ig_sem,
					a.qt_ig_dia,
					PKG_DATE_FORMATERS.to_varchar(a.dt_us, 'shortDate', wheb_usuario_pck.get_cd_estabelecimento, wheb_usuario_pck.get_nm_usuario ) dt_us, 
					a.qt_ig_sem_us, 
					a.qt_ig_dia_us, 
					PKG_DATE_FORMATERS.to_varchar(a.dt_prov_parto_us, 'short', wheb_usuario_pck.get_cd_estabelecimento, wheb_usuario_pck.get_nm_usuario ) dt_prov_parto_us, 
					PKG_DATE_FORMATERS.to_varchar(a.dt_evolucao, 'short', wheb_usuario_pck.get_cd_estabelecimento, wheb_usuario_pck.get_nm_usuario ) dt_evolucao, 
					a.qt_contracoes,
					a.nr_seq_evolucao,
					a.qt_au_cm,
					substr(obter_valor_dominio(1469, a.ie_posicao),1,30),
					a.ie_toque,
					a.nr_feto,
					substr(obter_valor_dominio(3863, a.ie_movimento_fetal),1,30),
					a.qt_bcf
			into STRICT	qt_ig_sem_p,
					qt_ig_dia_ev_p,
					dt_us_p,
					qt_ig_sem_us_ev_p,
					qt_ig_dia_us_ev_p,
					dt_prov_parto_us_p,
					dt_evolucao_p,
					qt_contracoes_p,
					nr_seq_evolucao_p,
					qt_au_cm_p,
					ie_posicao_p,
					ie_toque_p,
					nr_feto_p,
					ie_movimento_fetal_p,
					qt_bcf_p
			from	med_pac_pre_natal_evol a
			where	a.nr_sequencia = nr_evol_pre_natal_w;
		else
			select	PKG_DATE_FORMATERS.to_varchar(d.dt_us, 'shortDate', wheb_usuario_pck.get_cd_estabelecimento, wheb_usuario_pck.get_nm_usuario ) dt_us,
					PKG_DATE_FORMATERS.to_varchar(d.dt_prov_parto_us, 'shortDate', wheb_usuario_pck.get_cd_estabelecimento, wheb_usuario_pck.get_nm_usuario ) dt_prov_parto_us,
					null,
					QT_IG_SEMANA,
					QT_IG_DIA, 
					QT_IG_SEM_US, 
					QT_IG_DIA_US, 
					null,
					nr_seq_evolucao
			into STRICT	dt_us_p,
					dt_prov_parto_us_p,
					dt_evolucao_p,
					qt_ig_sem_p,
					qt_ig_dia_ev_p,
					qt_ig_sem_us_ev_p,
					qt_ig_dia_us_ev_p,
					qt_contracoes_p,
					nr_seq_evolucao_p
			from	med_pac_pre_natal d
			where 	d.nr_sequencia = nr_seq_ult_pre_natal_w;	
		end if;

	end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE obter_pre_natal_suep_inf ( nr_seq_suep_p bigint, nr_atendimento_p bigint, dt_ultima_menstruacao_p INOUT text, qt_ig_semana_p INOUT text, qt_ig_dia_p INOUT text, dt_prov_parto_p INOUT text, dt_us_p INOUT text, qt_ig_sem_us_p INOUT text, qt_ig_dia_us_p INOUT text, dt_prov_parto_us_p INOUT text, qt_gestacoes_p INOUT text, qt_natimortos_p INOUT text, qt_parto_normal_p INOUT text, qt_filhos_vivos_p INOUT text, qt_filhos_mortos_p INOUT text, qt_abortos_p INOUT text, dt_evolucao_p INOUT text, qt_ig_sem_p INOUT text, qt_ig_dia_ev_p INOUT text, qt_ig_sem_us_ev_p INOUT text, qt_ig_dia_us_ev_p INOUT text, qt_contracoes_p INOUT text, ie_dinamica_uterina_p INOUT text, nr_seq_evolucao_p INOUT med_evolucao.nr_sequencia%type, qt_parto_cesario_p INOUT text, qt_au_cm_p INOUT text, ie_posicao_p INOUT text, ie_toque_p INOUT text, nr_feto_p INOUT text, ie_movimento_fetal_p INOUT text, qt_bcf_p INOUT text) FROM PUBLIC;

