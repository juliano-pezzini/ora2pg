-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE medicine_validation_emar ( cd_mat_barra_p text, cd_mat_prescricao_p bigint, cd_estabelecimento_p bigint, ie_tipo_barra_p text, cd_material_p INOUT bigint, ds_erro_p INOUT text, ie_valido_p INOUT text, cd_funcao_p text default null) AS $body$
DECLARE


qt_material_w		bigint;
nr_seq_lote_w		bigint;
nr_seq_loteagrup_w	bigint;
cd_kit_mat_w		bigint;
ds_validade_w		varchar(100);
ds_material_w		varchar(255);
cd_unid_med_w		varchar(30);
nr_etiqueta_lp_w	varchar(30);					
					
C01 CURSOR FOR
	SELECT	1 nr_seq,
		cd_mat_prescricao_p cd_material
	
	
union

	SELECT	2,
		a.cd_material_generico cd_material 
	 from	material a                         
	 where 	a.cd_material = cd_mat_prescricao_p        
	 and 	(a.cd_material_generico IS NOT NULL AND a.cd_material_generico::text <> '')  
	
union
 
	select	3,                                   
		a.cd_material                       
	from	material a                           
	where	cd_material_generico = (	select  coalesce(cd_material_generico, cd_material) 
						from     material                               
						where    cd_material = cd_mat_prescricao_p)            
	 and	a.cd_material <> cd_mat_prescricao_p                   
	 and	a.cd_material <> a.cd_material_generico         
	 order  by 1;
BEGIN

ie_valido_p	:= 'N';

SELECT * FROM converte_codigo_barras(	cd_mat_barra_p, cd_estabelecimento_p, ie_tipo_barra_p, null, cd_material_p, qt_material_w, nr_seq_lote_w, nr_seq_loteagrup_w, cd_kit_mat_w, ds_validade_w, ds_material_w, cd_unid_med_w, nr_etiqueta_lp_w, ds_erro_p, cd_funcao_p, null) INTO STRICT cd_material_p, qt_material_w, nr_seq_lote_w, nr_seq_loteagrup_w, cd_kit_mat_w, ds_validade_w, ds_material_w, cd_unid_med_w, nr_etiqueta_lp_w, ds_erro_p;



for r_c01 in c01 loop
	begin
	if (cd_material_p	= r_c01.cd_material) then
		ie_valido_p	:= 'S';
	end if;
	end;
end loop;


commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE medicine_validation_emar ( cd_mat_barra_p text, cd_mat_prescricao_p bigint, cd_estabelecimento_p bigint, ie_tipo_barra_p text, cd_material_p INOUT bigint, ds_erro_p INOUT text, ie_valido_p INOUT text, cd_funcao_p text default null) FROM PUBLIC;

