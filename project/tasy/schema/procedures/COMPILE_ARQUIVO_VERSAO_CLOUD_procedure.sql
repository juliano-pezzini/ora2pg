-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE compile_arquivo_versao_cloud (cd_versao_p text, nm_arquivo_p text, nm_usuario_p text, NR_PACOTE_P text) AS $body$
DECLARE


ds_consulta_w	    varchar(4000);
ds_update_w	        varchar(4000);
ds_where_w          varchar(2000);
ds_erro_w			varchar(2000);
ds_comando_w	    text;
ds_comando_linha_w	text;
c02              	integer;
retorno_w        	integer;
nr_index_original_w	bigint;
nr_index_final_w	bigint;
nr_byte_w			bigint;
i					bigint;
i_fim_w				bigint;
c					bigint;
res 				bigint;
script_list_w	DBMS_SQL.VARCHAR2A;
ds_encode_w 		varchar(100);
nr_seq_w bigint;
nr_pacote_w bigint;
nr_release_w bigint;
nr_service_pack_w bigint;
str_version_w varchar(10);
db_version_w bigint;
ie_plataform_app_w varchar(1); -- aplicacao_tasy.ie_tipo_aplicacao%TYPE;
obj_command_w       boolean := false;
ds_erro_plsql_w     text;
ds_command_starts_w varchar(4000);
nm_object_w         varchar(200);
pos_last_char_w     integer;
nm_fase_w           text := 'COMPILE_ARQUIVO_VERSAO_CLOUD'; -- cloud_upgrade_log.ds_mensagem%type := 'COMPILE_ARQUIVO_VERSAO_CLOUD';
  cerror RECORD;

BEGIN

select	value
into STRICT	ds_encode_w
from	nls_database_parameters
where	parameter = 'NLS_CHARACTERSET';

if (ds_encode_w = 'AL32UTF8') then
	EXECUTE 'ALTER SESSION SET NLS_LENGTH_SEMANTICS=CHAR';
end if;

-- Base dos clientes
if (nm_arquivo_p not in ('A', 'P')) then
    EXECUTE 'select a.ie_tipo_aplicacao from aplicacao_tasy a where lower(a.cd_aplicacao_tasy) = ''tasy''' into STRICT ie_plataform_app_w;

    ds_consulta_w := ' SELECT a.nr_sequencia, a.nr_pacote, a.NR_RELEASE, a.nr_service_pack, a.ds_comando FROM ajuste_versao_cliente a';
    ds_update_w := 'update	ajuste_versao_cliente a set a.ie_compila = ''S'' ';
    if (ie_plataform_app_w != 'H') then
        ds_where_w := ' where  a.cd_versao = '||chr(39)||cd_versao_p||chr(39)||
                ' and	(('||chr(39)||nr_pacote_p||chr(39)||' = ' ||chr(39)||'999999'||chr(39)|| ') or ' ||
                   ' ((a.nr_pacote <= '||chr(39)||nr_pacote_p||chr(39)||') or (a.ie_durante_versao = '||chr(39)||'S'||chr(39)||' ))) ' ||
                ' and	((('||chr(39)||nm_arquivo_p||chr(39)||' = ' ||chr(39)||'DF1'||chr(39)|| ') and (a.nr_ordem < 100)) or (('||chr(39)||nm_arquivo_p||chr(39)||' = '||chr(39)||'MF2'||chr(39)||') and (a.nr_ordem > 100)))' ||
                ' and a.ie_tipo_script <>  '||chr(39)||'E'||chr(39);
    else
        ds_where_w := ' where  a.cd_versao = '||chr(39)||cd_versao_p||chr(39)||
                ' and	(('||chr(39)||nr_pacote_p||chr(39)||' = ' ||chr(39)||'999999'||chr(39)|| ') or ' ||
                   ' ((a.nr_service_pack <= '||chr(39)||nr_pacote_p||chr(39)||') or (a.ie_durante_versao = '||chr(39)||'S'||chr(39)||' ))) ' ||
                ' and	((('||chr(39)||nm_arquivo_p||chr(39)||' = ' ||chr(39)||'DF1'||chr(39)|| ') and (a.nr_ordem < 100)) or (('||chr(39)||nm_arquivo_p||chr(39)||' = '||chr(39)||'MF2'||chr(39)||') and (a.nr_ordem > 100)))' ||
                ' and a.ie_tipo_script <>  '||chr(39)||'E'||chr(39);
    end if;
    ds_consulta_w := ds_consulta_w || ds_where_w ||' ORDER BY nr_release, nr_ordem, nr_sequencia';
    ds_update_w := ds_update_w || ds_where_w;

else
	ds_consulta_w := ' SELECT  a.NR_SEQUENCIA, a.NR_SEQUENCIA nr_pacote, a.NR_SEQUENCIA nr_release, null nr_service_pack, a.ds_comando ' 	||
			' FROM  ajuste_versao_base_cliente a ';

    ds_update_w := 'update ajuste_versao_base_cliente a set a.ie_compila = ''S'', dt_atualizacao = sysdate, nm_usuario = '''||nm_usuario_p||'''';

    ds_where_w := ' where	 a.ie_fase = '||chr(39)||nm_arquivo_p||chr(39)||
			' and a.ie_compila = '||chr(39)||'N'||chr(39);

    ds_consulta_w := ds_consulta_w || ds_where_w || ' ORDER BY a.nr_sequencia';
    ds_update_w := ds_update_w || ds_where_w;

end if;

C02 := DBMS_SQL.OPEN_CURSOR;
DBMS_SQL.PARSE(C02, ds_consulta_w, dbms_sql.Native);
DBMS_SQL.DEFINE_COLUMN(C02,1,nr_seq_w);
DBMS_SQL.DEFINE_COLUMN(C02,2,nr_pacote_w);
DBMS_SQL.DEFINE_COLUMN(C02,3,nr_release_w);
DBMS_SQL.DEFINE_COLUMN(C02,4,nr_service_pack_w);
DBMS_SQL.DEFINE_COLUMN(C02,5,ds_comando_w);
retorno_w := DBMS_SQL.execute(C02);

while( DBMS_SQL.FETCH_ROWS(C02) > 0 ) loop
        DBMS_SQL.COLUMN_VALUE(C02, 1, nr_seq_w);
        DBMS_SQL.COLUMN_VALUE(C02, 2, nr_pacote_w);
        DBMS_SQL.COLUMN_VALUE(C02, 3, nr_release_w);
        DBMS_SQL.COLUMN_VALUE(C02, 4, nr_service_pack_w);
        DBMS_SQL.COLUMN_VALUE(C02, 5, ds_comando_w);
		begin

        obj_command_w := (REGEXP_INSTR(ds_comando_w, '^(create)|(create or replace)$',1,1,0,'i') > 0);

        if (obj_command_w) then
          ds_command_starts_w := substr(regexp_replace(regexp_replace(regexp_replace(ds_comando_w,'('||chr(13)||')',' '),'('||chr(10)||')',' '),'( ){2,}',' '),1,4000);
          nm_object_w := upper(regexp_substr(ds_command_starts_w,'\S*\s',1,5,'im'));
          if (nm_object_w = 'BODY' or length(nm_object_w) <= 0) then
            nm_object_w := upper(regexp_substr(ds_command_starts_w,'\S*\s',1,6,'im'));
          end if;

          pos_last_char_w := position('(' in nm_object_w);
          if (pos_last_char_w > 0) then
            nm_object_w := substr(nm_object_w,1,pos_last_char_w-1);
          end if;
        end if;

        EXECUTE ds_comando_w;

        CALL insert_log_cloud(cd_versao_p,null, nm_usuario_p, nm_fase_w||' - command performed with success', ds_comando_w, null, false,'C',nr_seq_w,nr_pacote_w,nr_release_w, nr_service_pack_w);
		exception
            when others then
            begin
                ds_erro_w := substr(SQLERRM,1,2000);

                if (obj_command_w) then
                    ds_erro_plsql_w := '';
                    ds_erro_plsql_w := ds_erro_plsql_w||nm_object_w||chr(13);
                    for cerror in (SELECT er.line, er.position, er.attribute, er.text from user_errors er where name = nm_object_w) loop
                        ds_erro_plsql_w := ds_erro_plsql_w||chr(13)||cerror.line||'/'||cerror.position||' - '||cerror.attribute||' - '||cerror.text;
                    end loop;
                end if;

                if (length(ds_erro_plsql_w) <= 0) then
                    ds_erro_plsql_w := ds_erro_w;
                end if;
                CALL insert_log_cloud(cd_versao_p,null, nm_usuario_p, nm_fase_w||' - '||ds_erro_plsql_w, ds_comando_W, null, true,'C',nr_seq_w,nr_pacote_w,nr_release_w,nr_service_pack_w);
            end;
        end;
END LOOP;
DBMS_SQL.CLOSE_CURSOR(C02);
commit;

if ((ds_update_w IS NOT NULL AND ds_update_w::text <> '') and length(ds_update_w) > 0) then
    EXECUTE ds_update_w;
    commit;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE compile_arquivo_versao_cloud (cd_versao_p text, nm_arquivo_p text, nm_usuario_p text, NR_PACOTE_P text) FROM PUBLIC;

