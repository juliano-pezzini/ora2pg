-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE estornar_alteracao_venc_cre ( nm_usuario_p text, nr_titulo_p bigint, nr_sequencia_p bigint) AS $body$
DECLARE


nr_sequencia_w bigint;
dt_vencimento_w timestamp;
vl_juros_w		double precision;
vl_multa_w		double precision;
dt_anterior_w		timestamp;


BEGIN

select max(nr_sequencia) + 1
into STRICT nr_sequencia_w
from alteracao_vencimento
where nr_titulo = nr_titulo_p;


insert into alteracao_vencimento(
	nr_titulo,
	nr_sequencia,
	dt_anterior,
	dt_vencimento,
	cd_motivo,
	dt_atualizacao,
	nm_usuario,
	dt_alteracao,
	ds_observacao,
	nr_externo,
	vl_juros,
	vl_multa,
	tx_juros,
	tx_multa,
	dt_base_juros_multa,
	ie_calc_juros_multa,
	ie_juros_multa_usuario,
	nr_seq_alt_vencto_orig)
SELECT nr_titulo,
	nr_sequencia_w,
	dt_anterior,
	dt_vencimento,
	4,
	dt_atualizacao,
	nm_usuario_p,
	dt_alteracao,
	ds_observacao,
	nr_externo,
	vl_juros * -1,
	vl_multa * -1,
	tx_juros,
	tx_multa,
	dt_base_juros_multa,
	ie_calc_juros_multa,
	ie_juros_multa_usuario,
	nr_sequencia
	from alteracao_vencimento
	where nr_titulo = nr_titulo_p
	and nr_sequencia = nr_sequencia_p;


select max(a.dt_vencimento), coalesce(max(a.vl_juros),0),coalesce(max(a.vl_multa),0)
into STRICT dt_vencimento_w,
vl_juros_w,
vl_multa_w
from alteracao_vencimento a
where a.nr_titulo = nr_titulo_p
and 	cd_motivo <> 4
and not exists (SELECT 1
from alteracao_vencimento b
where nr_seq_alt_vencto_orig = a.nr_sequencia
and b.nr_titulo = a.nr_titulo);

select max(b.dt_vencimento)
into STRICT dt_anterior_w
from titulo_receber b
where b.nr_titulo = nr_titulo_p;


update titulo_receber
set vl_saldo_juros = vl_juros_w,
vl_saldo_multa = vl_multa_w,
dt_pagamento_previsto = coalesce(dt_vencimento_w,dt_anterior_w)
where nr_titulo = nr_titulo_p;



commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE estornar_alteracao_venc_cre ( nm_usuario_p text, nr_titulo_p bigint, nr_sequencia_p bigint) FROM PUBLIC;

