-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE sus_gerar_w_esus_ativ_col ( nr_seq_lote_p esus_lote_envio.nr_sequencia%type, ie_tipo_lote_esus_p esus_lote_envio.ie_tipo_lote_esus%type, cd_cnes_estab_p estabelecimento.cd_cns%type, nm_usuario_p usuario.nm_usuario%type) AS $body$
DECLARE


					

					
nr_seq_exp_w				w_esus_atividade_coletiva.nr_sequencia%type;
cd_uuid_original_w			w_esus_atividade_coletiva.cd_uuid_original%type;
nr_data_atividade_w			w_esus_atividade_coletiva.nr_data_atividade%type;
cd_cns_profis_resp_w			w_esus_atividade_coletiva.cd_cns_profis_resp%type;
cd_cns_profissional_w			w_esus_ativ_col_profis.cd_cns_profissional%type;
ie_sexo_paciente_w			w_esus_ativ_col_partic.ie_sexo_paciente%type;
cd_cns_participante_w			w_esus_ativ_col_partic.cd_cns_participante%type;
nm_mae_pessoa_fisica_w			w_esus_ativ_col_partic.nm_mae_pessoa_fisica%type;
nm_municipio_nac_pac_ww			w_esus_ativ_col_partic.nm_municipio_nac_pac%type;
nm_municipio_nac_pac_w			w_esus_ativ_col_partic.nm_municipio_nac_pac%type;
dt_nascimento_paciente_w		w_esus_ativ_col_partic.dt_nascimento_paciente%type;
dt_nascimento_partic_w			w_esus_ativ_col_partic.dt_nascimento_partic%type;

nr_sequencia_w				esus_atividade_coletiva.nr_sequencia%type;
cd_estabelecimento_w			esus_atividade_coletiva.cd_estabelecimento%type;
dt_atualizacao_w			esus_atividade_coletiva.dt_atualizacao%type;
nm_usuario_w				esus_atividade_coletiva.nm_usuario%type;
dt_atualizacao_nrec_w			esus_atividade_coletiva.dt_atualizacao_nrec%type;
nm_usuario_nrec_w			esus_atividade_coletiva.nm_usuario_nrec%type;
cd_profissional_resp_w			esus_atividade_coletiva.cd_profissional_resp%type;
cd_cnes_unidade_w			esus_atividade_coletiva.cd_cnes_unidade%type;
cd_cnes_unidade_ww			esus_atividade_coletiva.cd_cnes_unidade%type;
nr_seq_sus_equipe_w			esus_atividade_coletiva.nr_seq_sus_equipe%type;
nr_participantes_w			esus_atividade_coletiva.nr_participantes%type;
nr_avaliacao_alterad_w			esus_atividade_coletiva.nr_avaliacao_alterad%type;
dt_atividade_w				esus_atividade_coletiva.dt_atividade%type;
dt_hora_inicio_w			esus_atividade_coletiva.dt_hora_inicio%type;
dt_hora_final_w				esus_atividade_coletiva.dt_hora_final%type;
nr_inep_w				esus_atividade_coletiva.nr_inep%type;
nr_programacao_parti_w			esus_atividade_coletiva.nr_programacao_parti%type;
ds_local_atividade_w			esus_atividade_coletiva.ds_local_atividade%type;
ie_atividade_w				esus_atividade_coletiva.ie_atividade%type;
ie_quest_admin_funci_w			esus_atividade_coletiva.ie_quest_admin_funci%type;
ie_processo_trabalho_w			esus_atividade_coletiva.ie_processo_trabalho%type;
ie_diag_monit_territ_w			esus_atividade_coletiva.ie_diag_monit_territ%type;
ie_planej_monit_acao_w			esus_atividade_coletiva.ie_planej_monit_acao%type;
ie_dis_pro_tera_sing_w			esus_atividade_coletiva.ie_dis_pro_tera_sing%type;
ie_educac_permanente_w			esus_atividade_coletiva.ie_educac_permanente%type;
ie_outros_temas_w			esus_atividade_coletiva.ie_outros_temas%type;
ie_comunidade_geral_w			esus_atividade_coletiva.ie_comunidade_geral%type;
ie_crianca_zero_tres_w			esus_atividade_coletiva.ie_crianca_zero_tres%type;
ie_cria_quatro_cinco_w			esus_atividade_coletiva.ie_cria_quatro_cinco%type;
ie_crianca_seis_onze_w			esus_atividade_coletiva.ie_crianca_seis_onze%type;
ie_adolecente_w				esus_atividade_coletiva.ie_adolecente%type;
ie_mulher_w				esus_atividade_coletiva.ie_mulher%type;
ie_gestante_w				esus_atividade_coletiva.ie_gestante%type;
ie_homem_w				esus_atividade_coletiva.ie_homem%type;
ie_familiares_w				esus_atividade_coletiva.ie_familiares%type;
ie_idoso_w				esus_atividade_coletiva.ie_idoso%type;
ie_pessoa_doenc_cron_w			esus_atividade_coletiva.ie_pessoa_doenc_cron%type;
ie_usuario_tabaco_w			esus_atividade_coletiva.ie_usuario_tabaco%type;
ie_usuario_alcool_w			esus_atividade_coletiva.ie_usuario_alcool%type;
ie_usuario_drogas_w			esus_atividade_coletiva.ie_usuario_drogas%type;
ie_transtorno_mental_w			esus_atividade_coletiva.ie_transtorno_mental%type;
ie_profissional_educ_w			esus_atividade_coletiva.ie_profissional_educ%type;
ie_outro_public_alvo_w			esus_atividade_coletiva.ie_outro_public_alvo%type;
ie_alimenta_saudavel_w			esus_atividade_coletiva.ie_alimenta_saudavel%type;
ie_aplic_topic_fluor_w			esus_atividade_coletiva.ie_aplic_topic_fluor%type;
ie_saude_ocular_w			esus_atividade_coletiva.ie_saude_ocular%type;
ie_aut_pes_doenc_cro_w			esus_atividade_coletiva.ie_aut_pes_doenc_cro%type;
ie_cidad_dir_humanos_w			esus_atividade_coletiva.ie_cidad_dir_humanos%type;
ie_saude_trabalhador_w			esus_atividade_coletiva.ie_saude_trabalhador%type;
ie_dependencia_quimi_w			esus_atividade_coletiva.ie_dependencia_quimi%type;
ie_envelhecimento_w			esus_atividade_coletiva.ie_envelhecimento%type;
ie_esc_dental_superv_w			esus_atividade_coletiva.ie_esc_dental_superv%type;
ie_planta_medic_fito_w			esus_atividade_coletiva.ie_planta_medic_fito%type;
ie_prat_ativi_fisica_w			esus_atividade_coletiva.ie_prat_ativi_fisica%type;
ie_prat_corp_men_pic_w			esus_atividade_coletiva.ie_prat_corp_men_pic%type;
ie_prev_viol_cul_paz_w			esus_atividade_coletiva.ie_prev_viol_cul_paz%type;
ie_saude_ambiental_w			esus_atividade_coletiva.ie_saude_ambiental%type;
ie_saude_bucal_w			esus_atividade_coletiva.ie_saude_bucal%type;
ie_saude_mental_w			esus_atividade_coletiva.ie_saude_mental%type;
ie_saude_sexual_repr_w			esus_atividade_coletiva.ie_saude_sexual_repr%type;
ie_sema_saude_escola_w			esus_atividade_coletiva.ie_sema_saude_escola%type;
ie_agrav_negligencia_w			esus_atividade_coletiva.ie_agrav_negligencia%type;
ie_antropometria_w			esus_atividade_coletiva.ie_antropometria%type;
ie_outras_praticas_w			esus_atividade_coletiva.ie_outras_praticas%type;
ie_saude_auditiva_w			esus_atividade_coletiva.ie_saude_auditiva%type;
ie_desenvo_linguagem_w			esus_atividade_coletiva.ie_desenvo_linguagem%type;
ie_verif_sit_vacinal_w			esus_atividade_coletiva.ie_verif_sit_vacinal%type;
ie_pnct_sessao_1_w			esus_atividade_coletiva.ie_pnct_sessao_1%type;
ie_pnct_sessao_2_w			esus_atividade_coletiva.ie_pnct_sessao_2%type;
ie_pnct_sessao_3_w			esus_atividade_coletiva.ie_pnct_sessao_3%type;
ie_pnct_sessao_4_w			esus_atividade_coletiva.ie_pnct_sessao_4%type;
dt_liberacao_w				esus_atividade_coletiva.dt_liberacao%type;
nr_seq_lote_envio_w			esus_atividade_coletiva.nr_seq_lote_envio%type;
ie_acao_comb_aedes_w			esus_atividade_coletiva.ie_acao_comb_aedes%type;
ie_pratic_outro_proc_w			esus_atividade_coletiva.ie_pratic_outro_proc%type;
ie_turno_atendimento_w			esus_atividade_coletiva.ie_turno_atendimento%type;
cd_outro_proced_w			esus_atividade_coletiva.cd_outro_proced%type;
ie_outr_tema_saude_w			esus_atividade_coletiva.ie_outr_tema_saude%type;
cd_cnes_atividade_w			esus_atividade_coletiva.cd_cnes_atividade%type;
cd_cbo_prof_w				esus_atividade_coletiva.cd_cbo_prof%type;
ie_pse_educacao_w			esus_atividade_coletiva.ie_pse_educacao%type;
ie_pse_saude_w				esus_atividade_coletiva.ie_pse_saude%type;


cd_contra_chave_rem_w		w_esus_header_footer.cd_contra_chave_rem%type;
cd_uuid_instal_rem_w		w_esus_header_footer.cd_uuid_instal_rem%type;
cd_contra_chave_ori_w		w_esus_header_footer.cd_contra_chave_ori%type;
cd_uuid_instal_orig_w		w_esus_header_footer.cd_uuid_instal_orig%type;
cd_municipio_ibge_ww		w_esus_header_footer.cd_municipio_ibge%type;

AtivCol CURSOR FOR
	SELECT 	nr_sequencia,
		cd_estabelecimento,
		dt_atualizacao,
		nm_usuario,
		dt_atualizacao_nrec,
		nm_usuario_nrec,
		cd_profissional_resp,
		cd_cnes_unidade,
		nr_seq_sus_equipe,
		nr_participantes,
		nr_avaliacao_alterad,
		dt_atividade,
		dt_hora_inicio,
		dt_hora_final,
		nr_inep,
		nr_programacao_parti,
		ds_local_atividade,
		ie_atividade,
		ie_quest_admin_funci,
		ie_processo_trabalho,
		ie_diag_monit_territ,
		ie_planej_monit_acao,
		ie_dis_pro_tera_sing,
		ie_educac_permanente,
		ie_outros_temas,
		ie_comunidade_geral,
		ie_crianca_zero_tres,
		ie_cria_quatro_cinco,
		ie_crianca_seis_onze,
		ie_adolecente,
		ie_mulher,
		ie_gestante,
		ie_homem,
		ie_familiares,
		ie_idoso,
		ie_pessoa_doenc_cron,
		ie_usuario_tabaco,
		ie_usuario_alcool,
		ie_usuario_drogas,
		ie_transtorno_mental,
		ie_profissional_educ,
		ie_outro_public_alvo,
		ie_alimenta_saudavel,
		ie_aplic_topic_fluor,
		ie_saude_ocular,
		ie_aut_pes_doenc_cro,
		ie_cidad_dir_humanos,
		ie_saude_trabalhador,
		ie_dependencia_quimi,
		ie_envelhecimento,
		ie_esc_dental_superv,
		ie_planta_medic_fito,
		ie_prat_ativi_fisica,
		ie_prat_corp_men_pic,
		ie_prev_viol_cul_paz,
		ie_saude_ambiental,
		ie_saude_bucal,
		ie_saude_mental,
		ie_saude_sexual_repr,
		ie_sema_saude_escola,
		ie_agrav_negligencia,
		ie_antropometria,
		ie_outras_praticas,
		ie_saude_auditiva,
		ie_desenvo_linguagem,
		ie_verif_sit_vacinal,
		ie_pnct_sessao_1,
		ie_pnct_sessao_2,
		ie_pnct_sessao_3,
		ie_pnct_sessao_4,
		dt_liberacao,
		nr_seq_lote_envio,
		cd_uuid_original,
		ie_acao_comb_aedes,
		ie_pratic_outro_proc,
		ie_turno_atendimento,
		cd_outro_proced,
		ie_outr_tema_saude,
		cd_cnes_atividade,
		cd_cbo_prof,
                ie_pse_educacao,
                ie_pse_saude
	from	esus_atividade_coletiva	
	where	nr_seq_lote_envio = nr_seq_lote_p
	order by nr_sequencia;

AtivColProf CURSOR FOR
	SELECT	nr_sequencia,
		dt_atualizacao,
		nm_usuario,
		dt_atualizacao_nrec,
		nm_usuario_nrec,
		cd_profissional,
		cd_cbo,
		nr_seq_ativ_colet
	from 	esus_ativ_col_profis
	where 	nr_seq_ativ_colet = nr_sequencia_w;
	
AtivColPart CURSOR FOR
	SELECT 	nr_sequencia,
		dt_atualizacao,
		nm_usuario,
		dt_atualizacao_nrec,
		nm_usuario_nrec,
		cd_pessoa_particip,
		ie_avaliacao_alterada,
		qt_peso_kg,
		qt_altura_cm,
		ie_parou_fumar,
		ie_abandonou_grupo,
		nr_seq_ativ_colet
	from	esus_ativ_col_partic
	where	nr_seq_ativ_colet = nr_sequencia_w;

AtivCol_w               AtivCol%rowtype;
AtivColProf_w 		AtivColProf%rowtype;
AtivColPart_w		AtivColPart%rowtype;
	

BEGIN

delete 	from w_esus_atividade_coletiva
where	nr_seq_lote_envio = nr_seq_lote_p;

delete	from w_esus_ativ_col_profis
where	nr_seq_lote_envio = nr_seq_lote_p;

delete	from w_esus_ativ_col_partic
where	nr_seq_lote_envio = nr_seq_lote_p;


for AtivCol_w in AtivCol loop
        begin

        nr_sequencia_w				:= AtivCol_w.nr_sequencia;
        cd_estabelecimento_w			:= AtivCol_w.cd_estabelecimento;
        dt_atualizacao_w			:= AtivCol_w.dt_atualizacao;
        nm_usuario_w				:= AtivCol_w.nm_usuario;
        dt_atualizacao_nrec_w			:= AtivCol_w.dt_atualizacao_nrec;
        nm_usuario_nrec_w			:= AtivCol_w.nm_usuario_nrec;
        cd_profissional_resp_w			:= AtivCol_w.cd_profissional_resp;
        cd_cnes_unidade_w			:= AtivCol_w.cd_cnes_unidade;
        nr_seq_sus_equipe_w			:= AtivCol_w.nr_seq_sus_equipe;
        nr_participantes_w			:= AtivCol_w.nr_participantes;
        nr_avaliacao_alterad_w			:= AtivCol_w.nr_avaliacao_alterad;
        dt_atividade_w				:= AtivCol_w.dt_atividade;
        dt_hora_inicio_w			:= AtivCol_w.dt_hora_inicio;
        dt_hora_final_w				:= AtivCol_w.dt_hora_final;
        nr_inep_w				:= AtivCol_w.nr_inep;
        nr_programacao_parti_w			:= AtivCol_w.nr_programacao_parti;
        ds_local_atividade_w			:= AtivCol_w.ds_local_atividade;
        ie_atividade_w				:= AtivCol_w.ie_atividade;
        ie_quest_admin_funci_w			:= AtivCol_w.ie_quest_admin_funci;
        ie_processo_trabalho_w			:= AtivCol_w.ie_processo_trabalho;
        ie_diag_monit_territ_w			:= AtivCol_w.ie_diag_monit_territ;
        ie_planej_monit_acao_w			:= AtivCol_w.ie_planej_monit_acao;
        ie_dis_pro_tera_sing_w			:= AtivCol_w.ie_dis_pro_tera_sing;
        ie_educac_permanente_w			:= AtivCol_w.ie_educac_permanente;
        ie_outros_temas_w			:= AtivCol_w.ie_outros_temas;
        ie_comunidade_geral_w			:= AtivCol_w.ie_comunidade_geral;
        ie_crianca_zero_tres_w			:= AtivCol_w.ie_crianca_zero_tres;
        ie_cria_quatro_cinco_w			:= AtivCol_w.ie_cria_quatro_cinco;
        ie_crianca_seis_onze_w			:= AtivCol_w.ie_crianca_seis_onze;
        ie_adolecente_w				:= AtivCol_w.ie_adolecente;
        ie_mulher_w				:= AtivCol_w.ie_mulher;
        ie_gestante_w				:= AtivCol_w.ie_gestante;
        ie_homem_w				:= AtivCol_w.ie_homem;
        ie_familiares_w				:= AtivCol_w.ie_familiares;
        ie_idoso_w				:= AtivCol_w.ie_idoso;
        ie_pessoa_doenc_cron_w			:= AtivCol_w.ie_pessoa_doenc_cron;
        ie_usuario_tabaco_w			:= AtivCol_w.ie_usuario_tabaco;
        ie_usuario_alcool_w			:= AtivCol_w.ie_usuario_alcool;
        ie_usuario_drogas_w			:= AtivCol_w.ie_usuario_drogas;
        ie_transtorno_mental_w			:= AtivCol_w.ie_transtorno_mental;
        ie_profissional_educ_w			:= AtivCol_w.ie_profissional_educ;
        ie_outro_public_alvo_w			:= AtivCol_w.ie_outro_public_alvo;
        ie_alimenta_saudavel_w			:= AtivCol_w.ie_alimenta_saudavel;
        ie_aplic_topic_fluor_w			:= AtivCol_w.ie_aplic_topic_fluor;
        ie_saude_ocular_w			:= AtivCol_w.ie_saude_ocular;
        ie_aut_pes_doenc_cro_w			:= AtivCol_w.ie_aut_pes_doenc_cro;
        ie_cidad_dir_humanos_w			:= AtivCol_w.ie_cidad_dir_humanos;
        ie_saude_trabalhador_w			:= AtivCol_w.ie_saude_trabalhador;
        ie_dependencia_quimi_w			:= AtivCol_w.ie_dependencia_quimi;
        ie_envelhecimento_w			:= AtivCol_w.ie_envelhecimento;
        ie_esc_dental_superv_w			:= AtivCol_w.ie_esc_dental_superv;
        ie_planta_medic_fito_w			:= AtivCol_w.ie_planta_medic_fito;
        ie_prat_ativi_fisica_w			:= AtivCol_w.ie_prat_ativi_fisica;
        ie_prat_corp_men_pic_w			:= AtivCol_w.ie_prat_corp_men_pic;
        ie_prev_viol_cul_paz_w			:= AtivCol_w.ie_prev_viol_cul_paz;
        ie_saude_ambiental_w			:= AtivCol_w.ie_saude_ambiental;
        ie_saude_bucal_w			:= AtivCol_w.ie_saude_bucal;
        ie_saude_mental_w			:= AtivCol_w.ie_saude_mental;
        ie_saude_sexual_repr_w			:= AtivCol_w.ie_saude_sexual_repr;
        ie_sema_saude_escola_w			:= AtivCol_w.ie_sema_saude_escola;
        ie_agrav_negligencia_w			:= AtivCol_w.ie_agrav_negligencia;
        ie_antropometria_w			:= AtivCol_w.ie_antropometria;
        ie_outras_praticas_w			:= AtivCol_w.ie_outras_praticas;
        ie_saude_auditiva_w			:= AtivCol_w.ie_saude_auditiva;
        ie_desenvo_linguagem_w			:= AtivCol_w.ie_desenvo_linguagem;
        ie_verif_sit_vacinal_w			:= AtivCol_w.ie_verif_sit_vacinal;
        ie_pnct_sessao_1_w			:= AtivCol_w.ie_pnct_sessao_1;
        ie_pnct_sessao_2_w			:= AtivCol_w.ie_pnct_sessao_2;
        ie_pnct_sessao_3_w			:= AtivCol_w.ie_pnct_sessao_3;
        ie_pnct_sessao_4_w			:= AtivCol_w.ie_pnct_sessao_4;
        dt_liberacao_w				:= AtivCol_w.dt_liberacao;
        nr_seq_lote_envio_w			:= AtivCol_w.nr_seq_lote_envio;
        cd_uuid_original_w			:= AtivCol_w.cd_uuid_original;
        ie_acao_comb_aedes_w			:= AtivCol_w.ie_acao_comb_aedes;
        ie_pratic_outro_proc_w			:= AtivCol_w.ie_pratic_outro_proc;
        ie_turno_atendimento_w			:= AtivCol_w.ie_turno_atendimento;
        cd_outro_proced_w			:= AtivCol_w.cd_outro_proced;
        ie_outr_tema_saude_w			:= AtivCol_w.ie_outr_tema_saude;
        cd_cnes_atividade_w			:= AtivCol_w.cd_cnes_atividade;
        cd_cbo_prof_w				:= AtivCol_w.cd_cbo_prof;
        ie_pse_educacao_w                       := AtivCol_w.ie_pse_educacao;
        ie_pse_saude_w                          := AtivCol_w.ie_pse_saude;

        select	nextval('w_esus_atividade_coletiva_seq')
        into STRICT	nr_seq_exp_w
;		

        if (ie_atividade_w > '03') then
                begin
                ie_quest_admin_funci_w		:= '';
                ie_processo_trabalho_w		:= '';
                ie_diag_monit_territ_w		:= '';
                ie_planej_monit_acao_w		:= '';
                ie_dis_pro_tera_sing_w		:= '';
                ie_educac_permanente_w		:= '';
                ie_outros_temas_w		:= '';
                end;
        else
                begin
                ie_comunidade_geral_w		:= '';
                ie_crianca_zero_tres_w		:= '';
                ie_cria_quatro_cinco_w		:= '';
                ie_crianca_seis_onze_w		:= '';
                ie_adolecente_w			:= '';
                ie_mulher_w			:= '';
                ie_gestante_w			:= '';
                ie_homem_w			:= '';
                ie_familiares_w			:= '';
                ie_idoso_w			:= '';
                ie_pessoa_doenc_cron_w		:= '';
                ie_usuario_tabaco_w		:= '';
                ie_usuario_alcool_w		:= '';
                ie_usuario_drogas_w		:= '';
                ie_transtorno_mental_w		:= '';
                ie_profissional_educ_w		:= '';
                ie_outro_public_alvo_w		:= '';
                ie_alimenta_saudavel_w		:= '';
                ie_aut_pes_doenc_cro_w		:= '';
                ie_cidad_dir_humanos_w		:= '';
                ie_dependencia_quimi_w		:= '';
                ie_envelhecimento_w		:= '';
                ie_planta_medic_fito_w		:= '';
                ie_prev_viol_cul_paz_w		:= '';
                ie_saude_ambiental_w		:= '';
                ie_saude_bucal_w		:= '';
                ie_saude_mental_w		:= '';
                ie_saude_trabalhador_w		:= '';
                ie_saude_sexual_repr_w		:= '';
                ie_sema_saude_escola_w		:= '';
                ie_agrav_negligencia_w		:= '';			
                ie_outras_praticas_w		:= '';

                if (coalesce(ie_atividade_w,'X') <> '06') then
                        begin
                        ie_antropometria_w	:= '';
                        ie_aplic_topic_fluor_w	:= '';
                        ie_desenvo_linguagem_w	:= '';
                        ie_esc_dental_superv_w	:= '';
                        ie_prat_ativi_fisica_w	:= '';
                        ie_pnct_sessao_1_w	:= '';
                        ie_pnct_sessao_2_w	:= '';
                        ie_pnct_sessao_3_w	:= '';
                        ie_pnct_sessao_4_w	:= '';
                        ie_saude_auditiva_w	:= '';
                        ie_saude_ocular_w	:= '';
                        ie_verif_sit_vacinal_w	:= '';
                        ie_outras_praticas_w	:= '';
                        ie_pratic_outro_proc_w	:= '';
                        end;
                end if;
                end;
        end if;		

        if (coalesce(ie_pratic_outro_proc_w,'X') = 'S') then
                cd_outro_proced_w		:= cd_outro_proced_w;
        else
                cd_outro_proced_w		:= '';
        end if;

        if (dt_atividade_w IS NOT NULL AND dt_atividade_w::text <> '') then
                nr_data_atividade_w	:=  rpad(((dt_atividade_w - to_date('01/01/1970 00:00:00','dd/mm/yyyy hh24:mi:ss')) * 86400),13,0);
        else
                nr_data_atividade_w	:= null;
        end if;		

        cd_cns_profis_resp_w		:= substr(obter_dados_pf(cd_profissional_resp_w,'CNS'),1,15);

        if (coalesce(ds_local_atividade_w,'X') <> 'X') then
                begin
                nr_inep_w		:= null;
                cd_cnes_atividade_w	:= '';
                end;
        elsif (coalesce(nr_inep_w,0) <> 0) then
                cd_cnes_atividade_w	:= '';	
        end if;

        select	coalesce(max(cd_cnes_unidade),'0')
        into STRICT	cd_cnes_unidade_ww
        from	w_esus_header_footer
        where	nr_seq_lote_envio = nr_seq_lote_p;

        if (cd_cnes_unidade_w <> cd_cnes_unidade_ww) then
                begin
                cd_contra_chave_rem_w	:= substr(sus_gerar_uuid_esus(cd_cnes_unidade_w,'C'),1,50);
                cd_uuid_instal_rem_w	:= substr(sus_gerar_uuid_esus(cd_cnes_unidade_w,'U'),1,50);
                cd_contra_chave_ori_w	:= cd_contra_chave_rem_w;
                cd_uuid_instal_orig_w	:= cd_uuid_instal_rem_w;			
                cd_municipio_ibge_ww	:= sus_obter_dados_equipe(nr_seq_sus_equipe_w,'CM');
                cd_municipio_ibge_ww	:= substr(cd_municipio_ibge_ww||Calcula_Digito('MODULO10',cd_municipio_ibge_ww),1,7);

                update 	w_esus_header_footer
                set 	cd_cnes_unidade = cd_cnes_unidade_w,
                        cd_cnes_serealizado = cd_cnes_unidade_w,
                        cd_contra_chave_rem = cd_contra_chave_rem_w,
                        cd_uuid_instal_rem = cd_uuid_instal_rem_w,
                        cd_contra_chave_ori = cd_contra_chave_ori_w,
                        cd_uuid_instal_orig = cd_uuid_instal_orig_w,
                        cd_municipio_ibge = cd_municipio_ibge_ww
                where	nr_seq_lote_envio = nr_seq_lote_p;

                end;
        end if;

        if (coalesce(cd_uuid_original_w,'X') = 'X')  then
                cd_uuid_original_w := coalesce(sus_gerar_uuid_esus(cd_cnes_unidade_w,'U'),'0');
                update esus_atividade_coletiva set cd_uuid_original = cd_uuid_original_w where  nr_sequencia = nr_sequencia_w;
        end if;	

        insert into w_esus_atividade_coletiva(	nr_sequencia,
                                                cd_estabelecimento,
                                                dt_atualizacao,
                                                nm_usuario,
                                                dt_atualizacao_nrec,
                                                nm_usuario_nrec,
                                                cd_profissional_resp,
                                                cd_cnes_unidade,
                                                nr_seq_sus_equipe,
                                                nr_participantes,
                                                nr_avaliacao_alterad,
                                                dt_atividade,
                                                dt_hora_inicio,
                                                dt_hora_final,
                                                nr_inep,
                                                nr_programacao_parti,
                                                ds_local_atividade,
                                                ie_atividade,
                                                ie_quest_admin_funci,
                                                ie_processo_trabalho,
                                                ie_diag_monit_territ,
                                                ie_planej_monit_acao,
                                                ie_dis_pro_tera_sing,
                                                ie_educac_permanente,
                                                ie_outros_temas,
                                                ie_comunidade_geral,
                                                ie_crianca_zero_tres,
                                                ie_cria_quatro_cinco,
                                                ie_crianca_seis_onze,
                                                ie_adolecente,
                                                ie_mulher,
                                                ie_gestante,
                                                ie_homem,
                                                ie_familiares,
                                                ie_idoso,
                                                ie_pessoa_doenc_cron,
                                                ie_usuario_tabaco,
                                                ie_usuario_alcool,
                                                ie_usuario_drogas,
                                                ie_transtorno_mental,
                                                ie_profissional_educ,
                                                ie_outro_public_alvo,
                                                ie_alimenta_saudavel,
                                                ie_aplic_topic_fluor,
                                                ie_saude_ocular,
                                                ie_aut_pes_doenc_cro,
                                                ie_cidad_dir_humanos,
                                                ie_saude_trabalhador,
                                                ie_dependencia_quimi,
                                                ie_envelhecimento,
                                                ie_esc_dental_superv,
                                                ie_planta_medic_fito,
                                                ie_prat_ativi_fisica,
                                                ie_prat_corp_men_pic,
                                                ie_prev_viol_cul_paz,
                                                ie_saude_ambiental,
                                                ie_saude_bucal,
                                                ie_saude_mental,
                                                ie_saude_sexual_repr,
                                                ie_sema_saude_escola,
                                                ie_agrav_negligencia,
                                                ie_antropometria,
                                                ie_outras_praticas,
                                                ie_saude_auditiva,
                                                ie_desenvo_linguagem,
                                                ie_verif_sit_vacinal,
                                                ie_pnct_sessao_1,
                                                ie_pnct_sessao_2,
                                                ie_pnct_sessao_3,
                                                ie_pnct_sessao_4,
                                                nr_seq_lote_envio,
                                                cd_uuid_original,
                                                ie_acao_comb_aedes,
                                                ie_pratic_outro_proc,
                                                ie_turno_atendimento,
                                                cd_outro_proced,
                                                ie_outr_tema_saude,
                                                cd_cnes_atividade,
                                                cd_cbo_prof,
                                                nr_seq_ficha,
                                                nr_data_atividade,
                                                cd_cns_profis_resp,
                                                ie_pse_educacao,
                                                ie_pse_saude)
                                        values (nr_seq_exp_w,
                                                cd_estabelecimento_w,
                                                dt_atualizacao_w,
                                                nm_usuario_w,
                                                dt_atualizacao_nrec_w,
                                                nm_usuario_nrec_w,
                                                cd_profissional_resp_w,
                                                cd_cnes_unidade_w,
                                                nr_seq_sus_equipe_w,
                                                nr_participantes_w,
                                                nr_avaliacao_alterad_w,
                                                dt_atividade_w,
                                                dt_hora_inicio_w,
                                                dt_hora_final_w,
                                                substr(nr_inep_w,1,8),
                                                nr_programacao_parti_w,
                                                substr(ds_local_atividade_w,1,250),
                                                ie_atividade_w,
                                                CASE WHEN ie_quest_admin_funci_w='S' THEN '1'  ELSE '' END ,
                                                CASE WHEN ie_processo_trabalho_w='S' THEN '2'  ELSE '' END ,
                                                CASE WHEN ie_diag_monit_territ_w='S' THEN '3'  ELSE '' END ,
                                                CASE WHEN ie_planej_monit_acao_w='S' THEN '4'  ELSE '' END ,
                                                CASE WHEN ie_dis_pro_tera_sing_w='S' THEN '5'  ELSE '' END ,
                                                CASE WHEN ie_educac_permanente_w='S' THEN '6'  ELSE '' END ,
                                                CASE WHEN ie_outros_temas_w='S' THEN '7'  ELSE '' END ,
                                                CASE WHEN ie_comunidade_geral_w='S' THEN '1'  ELSE '' END ,
                                                CASE WHEN ie_crianca_zero_tres_w='S' THEN '2'  ELSE '' END ,
                                                CASE WHEN ie_cria_quatro_cinco_w='S' THEN '3'  ELSE '' END ,
                                                CASE WHEN ie_crianca_seis_onze_w='S' THEN '4'  ELSE '' END ,
                                                CASE WHEN ie_adolecente_w='S' THEN '5'  ELSE '' END ,
                                                CASE WHEN ie_mulher_w='S' THEN '6'  ELSE '' END ,
                                                CASE WHEN ie_gestante_w='S' THEN '7'  ELSE '' END ,
                                                CASE WHEN ie_homem_w='S' THEN '8'  ELSE '' END ,
                                                CASE WHEN ie_familiares_w='S' THEN '9'  ELSE '' END ,
                                                CASE WHEN ie_idoso_w='S' THEN '10'  ELSE '' END ,
                                                CASE WHEN ie_pessoa_doenc_cron_w='S' THEN '12'  ELSE '' END ,
                                                CASE WHEN ie_usuario_tabaco_w='S' THEN '13'  ELSE '' END ,
                                                CASE WHEN ie_usuario_alcool_w='S' THEN '14'  ELSE '' END ,
                                                CASE WHEN ie_usuario_drogas_w='S' THEN '15'  ELSE '' END ,
                                                CASE WHEN ie_transtorno_mental_w='S' THEN '16'  ELSE '' END ,
                                                CASE WHEN ie_profissional_educ_w='S' THEN '17'  ELSE '' END ,
                                                CASE WHEN ie_outro_public_alvo_w='S' THEN '18'  ELSE '' END ,
                                                CASE WHEN ie_alimenta_saudavel_w='S' THEN '1'  ELSE '' END ,
                                                CASE WHEN ie_aplic_topic_fluor_w='S' THEN '2'  ELSE '' END ,
                                                CASE WHEN ie_saude_ocular_w='S' THEN '3'  ELSE '' END ,
                                                CASE WHEN ie_aut_pes_doenc_cro_w='S' THEN '4'  ELSE '' END ,
                                                CASE WHEN ie_cidad_dir_humanos_w='S' THEN '5'  ELSE '' END ,
                                                CASE WHEN ie_saude_trabalhador_w='S' THEN '6'  ELSE '' END ,
                                                CASE WHEN ie_dependencia_quimi_w='S' THEN '7'  ELSE '' END ,
                                                CASE WHEN ie_envelhecimento_w='S' THEN '8'  ELSE '' END ,
                                                CASE WHEN ie_esc_dental_superv_w='S' THEN '9'  ELSE '' END ,
                                                CASE WHEN ie_planta_medic_fito_w='S' THEN '10'  ELSE '' END ,
                                                CASE WHEN ie_prat_ativi_fisica_w='S' THEN '11'  ELSE '' END ,
                                                ie_prat_corp_men_pic_w,
                                                CASE WHEN ie_prev_viol_cul_paz_w='S' THEN '13'  ELSE '' END ,
                                                CASE WHEN ie_saude_ambiental_w='S' THEN '14'  ELSE '' END ,
                                                CASE WHEN ie_saude_bucal_w='S' THEN '15'  ELSE '' END ,
                                                CASE WHEN ie_saude_mental_w='S' THEN '16'  ELSE '' END ,
                                                CASE WHEN ie_saude_sexual_repr_w='S' THEN '17'  ELSE '' END ,
                                                CASE WHEN ie_sema_saude_escola_w='S' THEN '18'  ELSE '' END ,
                                                CASE WHEN ie_agrav_negligencia_w='S' THEN '19'  ELSE '' END ,
                                                CASE WHEN ie_antropometria_w='S' THEN '20'  ELSE '' END ,
                                                CASE WHEN ie_outras_praticas_w='S' THEN '12'  ELSE '' END ,
                                                CASE WHEN ie_saude_auditiva_w='S' THEN '22'  ELSE '' END ,
                                                CASE WHEN ie_desenvo_linguagem_w='S' THEN '23'  ELSE '' END ,
                                                CASE WHEN ie_verif_sit_vacinal_w='S' THEN '24'  ELSE '' END ,
                                                CASE WHEN ie_pnct_sessao_1_w='S' THEN '25'  ELSE '' END ,
                                                CASE WHEN ie_pnct_sessao_2_w='S' THEN '26'  ELSE '' END ,
                                                CASE WHEN ie_pnct_sessao_3_w='S' THEN '27'  ELSE '' END ,
                                                CASE WHEN ie_pnct_sessao_4_w='S' THEN '28'  ELSE '' END ,
                                                nr_seq_lote_envio_w,	
                                                cd_uuid_original_w,
                                                CASE WHEN ie_acao_comb_aedes_w='S' THEN '29'  ELSE '' END ,
                                                CASE WHEN ie_pratic_outro_proc_w='S' THEN '30'  ELSE '' END ,
                                                ie_turno_atendimento_w,
                                                cd_outro_proced_w,
                                                CASE WHEN ie_outr_tema_saude_w='S' THEN '21'  ELSE '' END ,
                                                cd_cnes_atividade_w,
                                                cd_cbo_prof_w,
                                                nr_sequencia_w,
                                                nr_data_atividade_w,
                                                cd_cns_profis_resp_w,
                                                CASE WHEN ie_pse_educacao_w='S' THEN 'true'  ELSE 'false' END ,
                                                CASE WHEN ie_pse_saude_w='S' THEN 'true'  ELSE 'false' END );

        for AtivColProf_w in AtivColProf loop
                begin
                cd_cns_profissional_w		:= substr(obter_dados_pf(AtivColProf_w.cd_profissional,'CNS'),1,15);

                insert into w_esus_ativ_col_profis(	nr_sequencia,
                                                        dt_atualizacao,
                                                        nm_usuario,
                                                        dt_atualizacao_nrec,
                                                        nm_usuario_nrec,
                                                        cd_profissional,       
                                                        cd_cbo,
                                                        nr_seq_ativ_colet,
                                                        nr_seq_w_ativ_col,
                                                        nr_seq_lote_envio,
                                                        nr_seq_ficha,
                                                        cd_cns_profissional)
                                                values (nextval('w_esus_ativ_col_profis_seq'),
                                                        AtivColProf_w.dt_atualizacao,
                                                        AtivColProf_w.nm_usuario,
                                                        AtivColProf_w.dt_atualizacao_nrec,
                                                        AtivColProf_w.nm_usuario_nrec,
                                                        AtivColProf_w.cd_profissional,
                                                        AtivColProf_w.cd_cbo,
                                                        AtivColProf_w.nr_seq_ativ_colet,
                                                        nr_seq_exp_w,
                                                        nr_seq_lote_p,
                                                        nr_sequencia_w,
                                                        cd_cns_profissional_w);

                end;
        end loop;

        for AtivColPart_w in AtivColPart loop
                begin
                ie_sexo_paciente_w		:= substr(sus_gerar_depara_esus(obter_dados_pf(AtivColPart_w.cd_pessoa_particip,'SE'),'SEXO'),1,20);
                cd_cns_participante_w		:= substr(obter_dados_pf(AtivColPart_w.cd_pessoa_particip,'CNS'),1,15);
                nm_mae_pessoa_fisica_w		:= upper(elimina_acentos(obter_compl_pf(AtivColPart_w.cd_pessoa_particip, 5, 'N'),'S'));
                nm_municipio_nac_pac_ww		:= substr(obter_dados_pf(AtivColPart_w.cd_pessoa_particip, 'MN'),1,6);
                nm_municipio_nac_pac_w		:= substr(nm_municipio_nac_pac_ww||Calcula_Digito('MODULO10',nm_municipio_nac_pac_ww),1,7);
                dt_nascimento_paciente_w	:= to_date(substr(obter_dados_pf(AtivColPart_w.cd_pessoa_particip,'DN'),1,10),'dd/mm/yyyy');

                if (dt_nascimento_paciente_w IS NOT NULL AND dt_nascimento_paciente_w::text <> '') then
                        dt_nascimento_partic_w	:=  ((dt_nascimento_paciente_w - to_date('01/01/1970 00:00:00','dd/mm/yyyy hh24:mi:ss')) * 86400);
                else
                        dt_nascimento_partic_w	:= null;
                end if;

                insert into w_esus_ativ_col_partic(	nr_sequencia,
                                                        dt_atualizacao,
                                                        nm_usuario,
                                                        dt_atualizacao_nrec,
                                                        nm_usuario_nrec,
                                                        cd_pessoa_particip,
                                                        ie_avaliacao_alterada,
                                                        qt_peso_kg,
                                                        qt_altura_cm,
                                                        ie_parou_fumar,
                                                        ie_abandonou_grupo,
                                                        nr_seq_ativ_colet,
                                                        nr_seq_w_ativ_col,
                                                        nr_seq_lote_envio,
                                                        nr_seq_ficha,
                                                        ie_sexo_paciente,
                                                        cd_cns_participante,
                                                        nm_mae_pessoa_fisica,
                                                        nm_municipio_nac_pac,
                                                        dt_nascimento_paciente,
                                                        dt_nascimento_partic)
                                                values (	nextval('w_esus_ativ_col_partic_seq'),
                                                        AtivColPart_w.dt_atualizacao,
                                                        AtivColPart_w.nm_usuario,
                                                        AtivColPart_w.dt_atualizacao_nrec,
                                                        AtivColPart_w.nm_usuario_nrec,
                                                        AtivColPart_w.cd_pessoa_particip,
                                                        CASE WHEN AtivColPart_w.ie_avaliacao_alterada='S' THEN 'true' WHEN AtivColPart_w.ie_avaliacao_alterada='N' THEN 'false'  ELSE '' END ,
                                                        replace(AtivColPart_w.qt_peso_kg,',','.'),
                                                        replace(AtivColPart_w.qt_altura_cm,',','.'),
                                                        CASE WHEN AtivColPart_w.ie_parou_fumar='S' THEN 'true' WHEN AtivColPart_w.ie_parou_fumar='N' THEN 'false'  ELSE '' END ,
                                                        CASE WHEN AtivColPart_w.ie_abandonou_grupo='S' THEN 'true' WHEN AtivColPart_w.ie_abandonou_grupo='N' THEN 'false'  ELSE '' END ,
                                                        AtivColPart_w.nr_seq_ativ_colet,
                                                        nr_seq_exp_w,
                                                        nr_seq_lote_p,
                                                        nr_sequencia_w,
                                                        ie_sexo_paciente_w,
                                                        cd_cns_participante_w,
                                                        nm_mae_pessoa_fisica_w,
                                                        nm_municipio_nac_pac_w,
                                                        dt_nascimento_paciente_w,
                                                        dt_nascimento_partic_w);

                end;
        end loop;

        end;
end loop;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE sus_gerar_w_esus_ativ_col ( nr_seq_lote_p esus_lote_envio.nr_sequencia%type, ie_tipo_lote_esus_p esus_lote_envio.ie_tipo_lote_esus%type, cd_cnes_estab_p estabelecimento.cd_cns%type, nm_usuario_p usuario.nm_usuario%type) FROM PUBLIC;

