-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_conv_regra_desc (nr_sequencia_p bigint, nm_usuario_p text) AS $body$
DECLARE


cd_convenio_w		integer;
vl_conta_w		double precision;
nr_sequencia_w		bigint;
qt_regra_desc_item_w	bigint;
cd_item_w		bigint;
ie_origem_proced_w	bigint;
ie_tipo_item_w		varchar(1);
cd_classe_material_w	integer;
cd_grupo_material_w    	smallint;
cd_subgrupo_material_w	smallint;
cd_area_procedimento_w	bigint;
cd_especialidade_w	bigint;
cd_grupo_proc_w		bigint;
pr_desconto_w		double precision;
nr_interno_conta_w		bigint;
nr_seq_desconto_w	bigint;
vl_desconto_w		double precision;
vl_conta_ww		double precision;
vl_desc_item_w		double precision;
ie_emite_conta_w		smallint;
ie_tipo_desconto_w		smallint;
vl_desconto_item_w	double precision;	
ie_forma_desc_w		varchar(1);	
nr_seq_atepacu_w		bigint;
cd_tipo_acomodacao_w	smallint;
nr_atendimento_w		bigint;
qt_item_w		bigint;
ie_considera_qtde_w	varchar(1);
cd_pessoa_fisica_w	varchar(10);
dt_vigencia_w		timestamp;
ie_tipo_atendimento_w	atendimento_paciente.ie_tipo_atendimento%type;

cd_categoria_w  conta_paciente.cd_categoria_parametro%type;
			
C01 CURSOR FOR
	SELECT	nr_sequencia
	from	conv_regra_desc
	where	vl_conta_w between vl_inicial and vl_final
	and	cd_convenio = cd_convenio_w
	order by	nr_sequencia;
	
C02 CURSOR FOR
	SELECT	cd_material cd_item,
		0 ie_origem_proced,
		'M' ie_tipo_item,
		ie_emite_conta,
		nr_seq_atepacu,
		nr_atendimento,
		dt_atendimento,
		sum(qt_material)
	from	material_atend_paciente
	where	nr_interno_conta = nr_interno_conta_w
	and	coalesce(cd_motivo_exc_conta::text, '') = ''
	and	ie_tipo_desconto_w = 6
	group by
		cd_material,
		0,
		'M',
		ie_emite_conta,
		nr_seq_atepacu,
		nr_atendimento,
		dt_atendimento
	
union all

	SELECT	cd_procedimento,
		ie_origem_proced,
		'P' ie_tipo_item,
		ie_emite_conta,
		nr_seq_atepacu,
		nr_atendimento,
		dt_procedimento,
		sum(qt_procedimento)
	from	procedimento_paciente
	where	nr_interno_conta = nr_interno_conta_w
	and	coalesce(cd_motivo_exc_conta::text, '') = ''
	and	ie_tipo_desconto_w = 6
	group by
		cd_procedimento,
		ie_origem_proced,
		'P',
		ie_emite_conta,
		nr_seq_atepacu,
		nr_atendimento,
		dt_procedimento
	
union all

	select	cd_procedimento,
		ie_origem_proced,
		'E' ie_tipo_item,
		ie_emite_conta,
		nr_seq_atepacu,
		nr_atendimento,
		dt_procedimento,
		sum(qt_procedimento)
	from	procedimento_paciente
	where	nr_interno_conta = nr_interno_conta_w
	and	coalesce(cd_motivo_exc_conta::text, '') = ''
	and	ie_tipo_desconto_w = 4
	group by
		cd_procedimento,
		ie_origem_proced,
		'E',
		ie_emite_conta,
		nr_seq_atepacu,
		nr_atendimento,
		dt_procedimento
	
union all

	select	cd_material,
		0 ie_origem_proced,
		'E' ie_tipo_item,
		ie_emite_conta,
		nr_seq_atepacu,
		nr_atendimento,
		dt_atendimento,
		sum(qt_material)
	from	material_atend_paciente
	where	nr_interno_conta = nr_interno_conta_w
	and	coalesce(cd_motivo_exc_conta::text, '') = ''
	and	ie_tipo_desconto_w = 4
	group by 
		cd_material,
		0,
		'E',
		ie_emite_conta,
		nr_seq_atepacu,
		nr_atendimento,
		dt_atendimento
	order by 1;
	
C03 CURSOR FOR
	SELECT	coalesce(pr_desconto,0),
			coalesce(vl_desconto,0),
			coalesce(ie_forma_desc,'P'),
			coalesce(ie_considera_qtde,'N')
	from	conv_regra_desc_item
	where	coalesce(cd_area_procedimento,cd_area_procedimento_w) = cd_area_procedimento_w
	and	coalesce(cd_especialidade,cd_especialidade_w) = cd_especialidade_w
	and	coalesce(cd_grupo_proc,cd_grupo_proc_w) = cd_grupo_proc_w
	and	coalesce(cd_procedimento,cd_item_w) = cd_item_w
	and	((coalesce(cd_procedimento,cd_item_w) = cd_item_w) or (coalesce(ie_origem_proced,ie_origem_proced_w) = ie_origem_proced_w))
	and	coalesce(cd_tipo_acomodacao,cd_tipo_acomodacao_w) = cd_tipo_acomodacao_w
	and	coalesce(cd_pessoa_fisica,cd_pessoa_fisica_w) = cd_pessoa_fisica_w
	and	ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_vigencia_w) between coalesce(ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_inicio_vigencia), ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_vigencia_w)) and coalesce(dt_final_vigencia, dt_vigencia_w)
	and	nr_seq_regra_desc = nr_sequencia_w
	and	ie_tipo_item = 'P'
	and coalesce(cd_categoria,cd_categoria_w) = cd_categoria_w
	and coalesce(ie_tipo_atendimento, ie_tipo_atendimento_w) = ie_tipo_atendimento_w
	order by
		coalesce(ie_tipo_atendimento,0),
		coalesce(cd_pessoa_fisica,'0'),
		coalesce(cd_procedimento,0),
		coalesce(cd_grupo_proc,0),
		coalesce(cd_especialidade,0),
		coalesce(cd_area_procedimento,0),
		coalesce(cd_tipo_acomodacao,0);
	
C04 CURSOR FOR
	SELECT	coalesce(pr_desconto,0),
		coalesce(vl_desconto,0),
		coalesce(ie_forma_desc,'P'),
		coalesce(ie_considera_qtde,'N')
	from	conv_regra_desc_item
	where	coalesce(cd_classe_material,cd_classe_material_w) = cd_classe_material_w
	and	coalesce(cd_grupo_material,cd_grupo_material_w) = cd_grupo_material_w
	and	coalesce(cd_subgrupo_material,cd_subgrupo_material_w) = cd_subgrupo_material_w
	and	coalesce(cd_tipo_acomodacao,cd_tipo_acomodacao_w) = cd_tipo_acomodacao_w
	and	coalesce(cd_pessoa_fisica,cd_pessoa_fisica_w) = cd_pessoa_fisica_w
	and	coalesce(cd_material,cd_item_w) = cd_item_w
	and	ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_vigencia_w) between coalesce(ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_inicio_vigencia), ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_vigencia_w)) and coalesce(dt_final_vigencia, dt_vigencia_w)
	and	nr_seq_regra_desc = nr_sequencia_w
	and	ie_tipo_item = 'M'
	and coalesce(cd_categoria,cd_categoria_w) = cd_categoria_w
	and	coalesce(ie_tipo_atendimento, ie_tipo_atendimento_w) = ie_tipo_atendimento_w
	order by
		coalesce(ie_tipo_atendimento,0),
		coalesce(cd_pessoa_fisica,'0'),
		coalesce(cd_material,0),
		coalesce(cd_grupo_material,0),
		coalesce(cd_subgrupo_material,0),
		coalesce(cd_classe_material,0),
		coalesce(cd_tipo_acomodacao,0);
		
C05 CURSOR FOR
	SELECT 	nr_sequencia
	from 	conta_paciente_desc_item
	where 	nr_seq_desconto = nr_sequencia_p
	and 	ie_calcula = 'S'
	and	((cd_material = cd_item_w) or (cd_procedimento = cd_item_w))
	order by
		vl_conta;

C06 CURSOR FOR
	SELECT	coalesce(pr_desconto,0),
		coalesce(vl_desconto,0),
		coalesce(ie_forma_desc,'P'),
		coalesce(ie_considera_qtde,'N')
	from	conv_regra_desc_item
	where	coalesce(ie_emite_conta,ie_emite_conta_w) = ie_emite_conta_w
	and	coalesce(cd_tipo_acomodacao,cd_tipo_acomodacao_w) = cd_tipo_acomodacao_w
	and	coalesce(cd_pessoa_fisica,cd_pessoa_fisica_w) = cd_pessoa_fisica_w
	and	ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_vigencia_w) between coalesce(ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_inicio_vigencia), ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_vigencia_w)) and coalesce(dt_final_vigencia, dt_vigencia_w)
	and	nr_seq_regra_desc = nr_sequencia_w
	and	ie_tipo_item = 'E'
	and coalesce(cd_categoria,cd_categoria_w) = cd_categoria_w
	and coalesce(ie_tipo_atendimento, ie_tipo_atendimento_w) = ie_tipo_atendimento_w
	order by
		coalesce(ie_emite_conta,0);
		
C07 CURSOR FOR
	SELECT 	nr_sequencia
	from 	conta_paciente_desc_item
	where 	nr_seq_desconto = nr_sequencia_p
	and 	ie_calcula = 'S'
	and	cd_estrutura = ie_emite_conta_w
	order by
		vl_conta;


BEGIN
select 	max(nr_interno_conta),
	max(ie_tipo_desconto)
into STRICT 	nr_interno_conta_w,
	ie_tipo_desconto_w
from 	conta_paciente_desconto
where 	nr_sequencia = nr_sequencia_p;

select	max(cd_convenio_parametro),max(cd_categoria_parametro)
	--max(obter_valor_conta(nr_interno_conta_w,0))
into STRICT	cd_convenio_w, cd_categoria_w
	--vl_conta_w
from	conta_paciente
where	nr_interno_conta = nr_interno_conta_w;

select	max(a.ie_tipo_atendimento)
into STRICT	ie_tipo_atendimento_w
from	atendimento_paciente a,
		conta_paciente b
where	a.nr_atendimento 	= b.nr_atendimento
and		b.nr_interno_conta 	= nr_interno_conta_w;

begin
vl_conta_w	:= obter_valor_conta(nr_interno_conta_w,0);
exception
when others then
	vl_conta_w	:= 0;
end;

open C01;
loop
fetch C01 into	
	nr_sequencia_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	
	select	count(1)
	into STRICT	qt_regra_desc_item_w
	from	conv_regra_desc_item
	where	nr_seq_regra_desc	= nr_sequencia_w  LIMIT 1;
	
	if (qt_regra_desc_item_w > 0) then	
		open C02;
		loop
		fetch C02 into	
			cd_item_w,
			ie_origem_proced_w,
			ie_tipo_item_w,
			ie_emite_conta_w,
			nr_seq_atepacu_w,
			nr_atendimento_w,
			dt_vigencia_w,
			qt_item_w;
		EXIT WHEN NOT FOUND; /* apply on C02 */
			begin
			select	coalesce(max(cd_tipo_acomodacao),0)
			into STRICT	cd_tipo_acomodacao_w
			from	atend_paciente_unidade
			where	nr_seq_interno	= nr_seq_atepacu_w
			and	nr_atendimento	= nr_atendimento_w;
			
			select	max(cd_pessoa_fisica)
			into STRICT	cd_pessoa_fisica_w
			from	atendimento_paciente
			where	nr_atendimento = nr_atendimento_w;
			
			if (ie_tipo_item_w = 'M') then
				select	cd_classe_material,
					cd_grupo_material,    
					cd_subgrupo_material
				into STRICT	cd_classe_material_w,      
					cd_grupo_material_w,    
					cd_subgrupo_material_w
				from	estrutura_material_v
				where	cd_material	= cd_item_w;
				
				open C04;
				loop
				fetch C04 into	
					pr_desconto_w,
					vl_desconto_item_w,
					ie_forma_desc_w,
					ie_considera_qtde_w;
				EXIT WHEN NOT FOUND; /* apply on C04 */
					begin
					pr_desconto_w 		:= pr_desconto_w;
					vl_desconto_item_w	:= vl_desconto_item_w;
					ie_forma_desc_w		:= ie_forma_desc_w;
					ie_considera_qtde_w	:= ie_considera_qtde_w;
					
					open C05;
					loop
					fetch C05 into	
						nr_seq_desconto_w;
					EXIT WHEN NOT FOUND; /* apply on C05 */
						begin
						if (ie_forma_desc_w = 'P') then
							select	round((vl_conta /100) * pr_desconto_w,2)
							into STRICT	vl_desc_item_w
							from	conta_paciente_desc_item
							where 	nr_sequencia = nr_seq_desconto_w;
						else
							if (ie_considera_qtde_w = 'S') then
								vl_desconto_item_w	:= vl_desconto_item_w * qt_item_w;
							end if;
						
							select	round((vl_desconto_item_w / vl_conta) * 100,2)
							into STRICT	pr_desconto_w
							from	conta_paciente_desc_item
							where 	nr_sequencia = nr_seq_desconto_w;
							
							vl_desc_item_w	:= vl_desconto_item_w;
						end if;
						
						update 	conta_paciente_desc_item
						set 	pr_desconto	= pr_desconto_w,
	    						vl_desconto	= vl_desc_item_w,
	    						vl_liquido	= vl_conta - vl_desc_item_w
						where 	nr_sequencia	= nr_seq_desconto_w;
						
						end;
					end loop;
					close C05;
					
					end;
				end loop;
				close C04;
				
			elsif (ie_tipo_item_w = 'P') then
			
				select	cd_area_procedimento,
					cd_especialidade,
					cd_grupo_proc
				into STRICT	cd_area_procedimento_w,
					cd_especialidade_w,
					cd_grupo_proc_w
				from	estrutura_procedimento_v
				where	cd_procedimento = cd_item_w
				and	ie_origem_proced = ie_origem_proced_w;				
								
				open C03;
				loop
				fetch C03 into	
					pr_desconto_w,
					vl_desconto_item_w,
					ie_forma_desc_w,
					ie_considera_qtde_w;
				EXIT WHEN NOT FOUND; /* apply on C03 */
					begin
					pr_desconto_w 		:= pr_desconto_w;
					vl_desconto_item_w	:= vl_desconto_item_w;
					ie_forma_desc_w		:= ie_forma_desc_w;
					ie_considera_qtde_w	:= ie_considera_qtde_w;					
					
					open C05;
					loop
					fetch C05 into	
						nr_seq_desconto_w;
					EXIT WHEN NOT FOUND; /* apply on C05 */
						begin
						
						if (ie_forma_desc_w = 'P') then
						
							select	round((vl_conta /100) * pr_desconto_w,2)
							into STRICT	vl_desc_item_w
							from	conta_paciente_desc_item
							where 	nr_sequencia = nr_seq_desconto_w;
						else
						
							if (ie_considera_qtde_w = 'S') then
								vl_desconto_item_w	:= vl_desconto_item_w * qt_item_w;
							end if;
						
							select	round((vl_desconto_item_w / vl_conta) * 100,2)
							into STRICT	pr_desconto_w
							from	conta_paciente_desc_item
							where 	nr_sequencia = nr_seq_desconto_w;
							
							vl_desc_item_w	:= vl_desconto_item_w;
						
						end if;
						
						update 	conta_paciente_desc_item
						set 	pr_desconto = pr_desconto_w,
	    						vl_desconto = vl_desc_item_w,
	    						vl_liquido  = vl_conta - vl_desc_item_w
						where 	nr_sequencia = nr_seq_desconto_w;
						
						end;
					end loop;
					close C05;
					
					end;
				end loop;
				close C03;
			
			elsif (ie_tipo_item_w = 'E') then
				
				open C06;
				loop
				fetch C06 into	
					pr_desconto_w,
					vl_desconto_item_w,
					ie_forma_desc_w,
					ie_considera_qtde_w;
				EXIT WHEN NOT FOUND; /* apply on C06 */
					begin
					pr_desconto_w 		:= pr_desconto_w;
					vl_desconto_item_w	:= vl_desconto_item_w;
					ie_forma_desc_w		:= ie_forma_desc_w;
					ie_considera_qtde_w	:= ie_considera_qtde_w;
					
					open C07;
					loop
					fetch C07 into	
						nr_seq_desconto_w;
					EXIT WHEN NOT FOUND; /* apply on C07 */
						begin
						
						if (ie_forma_desc_w = 'P') then
						
							select	round((vl_conta /100) * pr_desconto_w,2)
							into STRICT	vl_desc_item_w
							from	conta_paciente_desc_item
							where 	nr_sequencia = nr_seq_desconto_w;
						else
						
							if (ie_considera_qtde_w = 'S') then
								vl_desconto_item_w	:= vl_desconto_item_w * qt_item_w;
							end if;
						
							select	round((vl_desconto_item_w / vl_conta) * 100,2)
							into STRICT	pr_desconto_w
							from	conta_paciente_desc_item
							where 	nr_sequencia = nr_seq_desconto_w;
							
							vl_desc_item_w	:= vl_desconto_item_w;
						
						end if;
						
						update 	conta_paciente_desc_item
						set 	pr_desconto = pr_desconto_w,
	    						vl_desconto = vl_desc_item_w,
	    						vl_liquido  = vl_conta - vl_desc_item_w
						where 	nr_sequencia = nr_seq_desconto_w;
						
						end;
					end loop;
					close C07;
					
					end;
				end loop;
				close C06;
				
			end if;
			
			
			end;
		end loop;
		close C02;	
		
	end if;
	
	end;
end loop;
close C01;

select	vl_conta
into STRICT	vl_conta_ww
from	conta_paciente_desconto
where	nr_sequencia	= nr_sequencia_p;

select	coalesce(sum(vl_desconto),0)
into STRICT	vl_desconto_w
from	conta_paciente_desc_item
where	nr_seq_desconto		= nr_sequencia_p;

update	conta_paciente_desconto
set	vl_desconto	= vl_desconto_w,
	pr_desconto	= dividir((vl_desconto_w * 100),vl_conta_ww),
	vl_liquido	= vl_conta - vl_desconto_w,
	nm_usuario	= nm_usuario_p,
	dt_atualizacao	= clock_timestamp()
where	nr_sequencia	= nr_sequencia_p;

if (coalesce(wheb_usuario_pck.get_ie_commit, 'S') = 'S') then commit; end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_conv_regra_desc (nr_sequencia_p bigint, nm_usuario_p text) FROM PUBLIC;

