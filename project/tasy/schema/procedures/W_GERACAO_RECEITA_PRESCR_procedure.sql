-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE w_geracao_receita_prescr ( cd_estabelecimento_p bigint, nr_prescricao_p bigint, nm_usuario_p text) AS $body$
DECLARE


cd_material_w			prescr_material.cd_material%type;
nr_sequencia_w			prescr_material.nr_seq_material%type;
cd_medicamento_w		medic_controlado.cd_medicamento%type;
cd_medicamento_old_w	medic_controlado.cd_medicamento%type;
ie_tipo_receita_w		varchar(15);
qt_item_max_w			bigint;
count_w					bigint;
cd_grupo_w				integer;

c01 CURSOR FOR
SELECT   a.cd_material,
		 a.nr_sequencia,
		 coalesce((Obter_inf_medic_control(a.cd_material,'Q'))::numeric ,999) qt_max_item,
		 coalesce(substr(Obter_inf_medic_control(a.cd_material,'M'),1,2),obter_desc_expressao(704816)/*'Outros'*/) cd_medicamento,
		 substr(Obter_inf_medic_control(a.cd_material,'T'),1,2) ie_tipo_receita
from     prescr_material a
where    a.nr_prescricao  = nr_prescricao_p
and  coalesce(a.dt_suspensao::text, '') = ''
and  obter_se_medic_controlado(a.cd_material) = 'S'
and  a.ie_agrupador in (1,4,12)
order by 3,4,2,1;


BEGIN

delete
from  w_gerar_receita
where nm_usuario = nm_usuario_p;

commit;

count_w		:= 0;
cd_grupo_w  := 0;
cd_medicamento_old_w := 'XPTO';

open c01;
loop
fetch c01 into
	cd_material_w,
	nr_sequencia_w,
	qt_item_max_w,
	cd_medicamento_w,
	ie_tipo_receita_w;
	commit;
EXIT WHEN NOT FOUND; /* apply on c01 */

	if (cd_medicamento_old_w <> cd_medicamento_w) or (qt_item_max_w = count_w) then
		cd_medicamento_old_w  := cd_medicamento_w;
		count_w		:= 1;
		cd_grupo_w	:= cd_grupo_w + 1;
	else
		count_w := count_w + 1;
	end if;

	insert into w_gerar_receita(
				cd_material,
				cd_medicamento,
				cd_grupo,
				ie_tipo_receita,
				nr_prescricao,
				nr_seq_material,
				nm_usuario)
	values ( cd_material_w,
				cd_medicamento_w,
				cd_grupo_w,
				ie_tipo_receita_w,
				nr_prescricao_p,
				nr_sequencia_w,
				nm_usuario_p);

end loop;
close c01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE w_geracao_receita_prescr ( cd_estabelecimento_p bigint, nr_prescricao_p bigint, nm_usuario_p text) FROM PUBLIC;

