-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gc_prescr_mat2_beforepost_js ( cd_material_p bigint, cd_material_ant_p bigint, nr_prescricao_p bigint, cd_fornec_consignado_p text, qt_material_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint, ds_mensagem_p INOUT text ) AS $body$
DECLARE


grupo_mat_lanc_w		varchar(200);
se_contido_char_w		varchar(1);
vinc_sis_externo_w		varchar(1);
ie_mat_codigo			varchar(1);
qt_material_sistema_externo_w	integer;
qt_prescr_material_w		bigint;
ie_consistir_qt_disp_mat_esp_w	varchar(1);
ie_possui_qtde_disp_cir		varchar(1);
ds_mensagem_w			varchar(255);


BEGIN

if (cd_material_p IS NOT NULL AND cd_material_p::text <> '') then
	begin

	grupo_mat_lanc_w := obter_param_usuario(900, 262, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, grupo_mat_lanc_w);
	vinc_sis_externo_w := obter_param_usuario(900, 204, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, vinc_sis_externo_w);
	ie_mat_codigo := obter_param_usuario(900, 301, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_mat_codigo);
	ie_consistir_qt_disp_mat_esp_w := obter_param_usuario(900, 377, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_consistir_qt_disp_mat_esp_w);

	se_contido_char_w:= obter_se_contido_char(Obter_estrutura_material(cd_material_p,'G'),grupo_mat_lanc_w);

	if (coalesce(grupo_mat_lanc_w,'XPTO') <> 'XPTO') and (se_contido_char_w = 'N') then
		begin
		-- (-20011, substr(obter_texto_tasy (47714, wheb_usuario_pck.get_nr_seq_idioma),1,255) || '#@#@');
		CALL Wheb_mensagem_pck.exibir_mensagem_abort(47714);
		end;
	end if;

	select	count(*)
	into STRICT	qt_material_sistema_externo_w
	from	material_sistema_externo
	where	ie_sistema = 'I'
	and	cd_material = cd_material_p;

	if (vinc_sis_externo_w = 'S') and (qt_material_sistema_externo_w = 0) then
		begin
		--(-20011, substr(obter_texto_tasy (47715, wheb_usuario_pck.get_nr_seq_idioma),1,255) || '#@#@');
		CALL Wheb_mensagem_pck.exibir_mensagem_abort(47715);
		end;
	end if;

	select	count(*)
	into STRICT	qt_prescr_material_w
	from	prescr_material
	where	cd_material = cd_material_p
	and	nr_prescricao = nr_prescricao_p;

	if (ie_mat_codigo = 'N') and (cd_material_ant_p <> cd_material_p) and (qt_prescr_material_w > 0) then
		begin
		--(-20011, substr(obter_texto_tasy (54645, wheb_usuario_pck.get_nr_seq_idioma),1,255) || '#@#@');
		CALL Wheb_mensagem_pck.exibir_mensagem_abort(54645);
		end;
	end if;

	ie_possui_qtde_disp_cir := obter_se_possui_qtde_disp_cir(nr_prescricao_p,cd_material_p,cd_fornec_consignado_p,qt_material_p);

	if (ie_consistir_qt_disp_mat_esp_w <> 'N') and (ie_possui_qtde_disp_cir = 'N') then
		begin

		if (ie_consistir_qt_disp_mat_esp_w = 'A') then
			begin
			ds_mensagem_w := substr(obter_texto_tasy( 95683, wheb_usuario_pck.get_nr_seq_idioma),1,255);
			end;
		else
			begin
			--(-20011, substr(obter_texto_tasy (95684, wheb_usuario_pck.get_nr_seq_idioma),1,255)  || '#@#@');
			CALL Wheb_mensagem_pck.exibir_mensagem_abort(95684);
			end;
		end if;

		end;
	end if;

      end;
end if;

ds_mensagem_p := ds_mensagem_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gc_prescr_mat2_beforepost_js ( cd_material_p bigint, cd_material_ant_p bigint, nr_prescricao_p bigint, cd_fornec_consignado_p text, qt_material_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint, ds_mensagem_p INOUT text ) FROM PUBLIC;

