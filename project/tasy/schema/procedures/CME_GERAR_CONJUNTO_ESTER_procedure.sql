-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE cme_gerar_conjunto_ester (nr_requisicao_p bigint, cd_setor_ester_p bigint, nm_usuario_p text) AS $body$
DECLARE


cd_setor_w			integer;
nr_seq_conj_w			bigint;
qt_conjunto_w			bigint;
qt_cont_w			bigint;
nr_seq_embalagem_w		bigint;
qt_ponto_w			double precision;
nr_seq_cont_w			bigint;
cd_estabelecimento_w		smallint;
ds_observacao_w			varchar(4000);
ds_conj_cont_w			varchar(255);
nr_controle_w			bigint;
cd_medico_w			varchar(10);
qt_dia_validade_w		bigint;
qt_regra_w			bigint;
ie_indeterminado_w		varchar(1);
dt_validade_w		timestamp;


C01 CURSOR FOR
SELECT	a.nr_seq_conjunto,
	a.qt_conjunto
from	cm_requisicao_item a,
	cm_conjunto b
where	a.nr_seq_requisicao = nr_requisicao_p
and	a.nr_seq_conjunto = b.nr_sequencia
and	coalesce(b.ie_gerar_conj_auto,'S') = 'S';


BEGIN

select	cd_setor_atendimento,
	cd_estabelecimento,
	ds_observacao
into STRICT	cd_setor_w,
	cd_estabelecimento_w,
	ds_observacao_w
from	cm_requisicao
where	nr_sequencia = nr_requisicao_p;

open C01;
loop
fetch C01 into
	nr_seq_conj_w,
	qt_conjunto_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin

	qt_cont_w	:= 0;

	select 	nr_seq_embalagem,
		coalesce(qt_ponto,0),
		cd_medico
	into STRICT	nr_seq_embalagem_w,
		qt_ponto_w,
		cd_medico_w
	from	cm_conjunto
	where	nr_sequencia = nr_seq_conj_w;

	begin
	select	coalesce(qt_dia_validade, 1)
	into STRICT	qt_dia_validade_w
	from	cm_classif_embalagem
	where	nr_sequencia = nr_seq_embalagem_w;
	exception
	when others then
		qt_dia_validade_w := 1;
	end;

	select	count(*)
	into STRICT	qt_regra_w
	from	cm_classif_embalagem
	where	nr_sequencia = nr_seq_embalagem_w
	and	coalesce(ie_indeterminado,'N') = 'S';

	if (qt_dia_validade_w > 0) and (qt_regra_w = 0) then
		ie_indeterminado_w := 'N';
		dt_validade_w := (clock_timestamp() + qt_dia_validade_w);
	else
		dt_validade_w := null;
		ie_indeterminado_w := 'S';
	end if;

	while(qt_cont_w < qt_conjunto_w) loop
		begin

		select	nextval('cm_conjunto_cont_seq')
		into STRICT	nr_seq_cont_w
		;

		select 	coalesce(max(nr_seq_controle),0) + 1
		into STRICT	nr_controle_w
		from 	cm_conjunto_cont;

		insert into	cm_conjunto_cont(
			nr_sequencia,
			cd_estabelecimento,
			nr_seq_conjunto,
			dt_atualizacao,
			nm_usuario,
			ie_status_conjunto,
			dt_origem,
			nm_usuario_origem,
			nr_seq_embalagem,
			dt_receb_ester,
			nm_usuario_ester,
			nr_seq_ciclo,
			dt_validade,
			ie_indeterminado,
			nr_seq_conj_fisico,
			dt_saida,
			nm_usuario_saida,
			nr_seq_agenda,
			cd_pessoa_fisica,
			cd_cgc,
			cd_local_estoque,
			dt_aloc_agenda,
			nm_usuario_agenda,
			dt_baixa_cirurgia,
			nr_cirurgia,
			cd_setor_atend_orig,
			cd_setor_atend_dest,
			qt_ponto,
			vl_esterilizacao,
			cd_setor_atendimento,
			nr_seq_cliente,
			nr_seq_controle,
			nr_seq_lote,
			ds_observacao,
			cd_pessoa_resp,
			ie_tipo_esterilizacao,
			nr_atendimento,
			dt_lancamento_automatico,
			nr_seq_pepo,
			cd_perfil_ativo,
			nm_usuario_vinc,
			dt_vinculo_conj,
			ie_situacao) values (nr_seq_cont_w,
					cd_estabelecimento_w,
					nr_seq_conj_w,
					clock_timestamp(),
					nm_usuario_p,
					1,
					clock_timestamp(),
					nm_usuario_p,
					nr_seq_embalagem_w,
					clock_timestamp(),
					nm_usuario_p,
					null,
					dt_validade_w,
					ie_indeterminado_w,
					null, null, null, null,
					cd_medico_w,
					null, null, null, null, null, null,
					cd_setor_w,
					null,
					qt_ponto_w,
					0,
					cd_setor_ester_p,
					null,
					nr_controle_w,
					null,
					wheb_mensagem_pck.get_texto(311004,'NR_REQUISICAO='||nr_requisicao_p),
					null, null, null, null, null, null, null, null,'A');

		commit;

		ds_conj_cont_w := substr(ds_conj_cont_w || ', ' || nr_seq_cont_w,1,255);

		CALL cme_incluir_itens_controle(nr_seq_cont_w, nm_usuario_p);

		qt_cont_w := qt_cont_w + 1;

		end;
	end loop;

	end;
end loop;
close C01;

if (ds_observacao_w IS NOT NULL AND ds_observacao_w::text <> '') then
	begin
	select	length(ds_observacao)
	INTO STRICT	qt_cont_w
	from	cm_requisicao
	where	nr_sequencia = nr_requisicao_p;

	if (qt_cont_w < 3700) then

	update	cm_requisicao
	set	ds_observacao =	substr(ds_observacao_w || chr(13) ||
				  wheb_mensagem_pck.get_texto(311017,'DS_CONJ_CONT='||substr(ds_conj_cont_w,3,255)),1,255)
	where	nr_sequencia = nr_requisicao_p;

	end if;
	end;
else
	begin
	update	cm_requisicao
	set	ds_observacao =	substr(wheb_mensagem_pck.get_texto(311017,'DS_CONJ_CONT='||substr(ds_conj_cont_w,3,255)),1,255)
	where	nr_sequencia = nr_requisicao_p;
	end;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cme_gerar_conjunto_ester (nr_requisicao_p bigint, cd_setor_ester_p bigint, nm_usuario_p text) FROM PUBLIC;

