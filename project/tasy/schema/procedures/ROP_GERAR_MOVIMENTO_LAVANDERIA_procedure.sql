-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE rop_gerar_movimento_lavanderia ( nr_seq_lavanderia_p bigint, nr_seq_local_destino_p bigint, nm_usuario_p text) AS $body$
DECLARE


nr_seq_roupa_w				bigint;
nr_seq_local_w				bigint;
cd_pessoa_fisica_w			varchar(10);
cd_estabelecimento_w			smallint;
nr_seq_operacao_w			bigint;
nr_seq_lote_w				bigint;
ie_evento_w				varchar(15);
qt_peso_w				double precision;
qt_roupa_w				double precision;

c01 CURSOR FOR
SELECT	distinct
	rop_obter_local_atual_roupa(nr_seq_roupa)
from	rop_lavanderia_item
where	nr_seq_lavanderia = nr_seq_lavanderia_p;

c02 CURSOR FOR
SELECT	a.nr_seq_roupa,
	a.qt_peso,
	a.qt_roupa
from	rop_lavanderia_item a
where	a.nr_seq_lavanderia = nr_seq_lavanderia_p
and	rop_obter_local_atual_roupa(a.nr_seq_roupa) = nr_seq_local_w;


BEGIN

select	obter_pessoa_fisica_usuario(nm_usuario_p,'C'),
	cd_estabelecimento
into STRICT	cd_pessoa_fisica_w,
	cd_estabelecimento_w
from	rop_lavanderia
where	nr_sequencia = nr_seq_lavanderia_p;

select	ie_evento
into STRICT	ie_evento_w
from	rop_lavanderia
where	nr_sequencia = nr_seq_lavanderia_p;

if (ie_evento_w = 'S') then
	select	coalesce(min(nr_sequencia),0)
	into STRICT	nr_seq_operacao_w
	from	rop_operacao
	where	ie_situacao = 'A'
	and	ie_operacao = 'TS'
	and	ie_tipo_operacao = '3';
else
	select	coalesce(min(nr_sequencia),0)
	into STRICT	nr_seq_operacao_w
	from	rop_operacao
	where	ie_situacao = 'A'
	and	ie_operacao = 'TS'
	and	ie_tipo_operacao = '4';
end if;

if (nr_seq_operacao_w = 0) then

	select	coalesce(min(nr_sequencia),0)
	into STRICT	nr_seq_operacao_w
	from	rop_operacao
	where	ie_situacao = 'A'
	and	ie_operacao = 'TS';
end if;

if (nr_seq_operacao_w = 0) then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(265537);
	--'Deve ser cadastrado uma operacao da rouparia com tipo Transferencia entre Setores.'

	--'Esse cadastro de faz em Cadastros Gerais - Aplicacao Principal - Rouparia - Operacao com a peca de roupa'
end if;

open C01;
loop
fetch C01 into	
	nr_seq_local_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin

	if (coalesce(nr_seq_local_w::text, '') = '') then
		CALL wheb_mensagem_pck.exibir_mensagem_abort(265538);
		--'Existe itens neste lote da lavanderia que estao sem nenhum local atual. Verifique.'
	end if;
		
		
	select	nextval('rop_lote_movto_seq')
	into STRICT	nr_seq_lote_w
	;
	
	insert into rop_lote_movto(
		nr_sequencia,
		cd_estabelecimento,
		dt_atualizacao,
		nm_usuario,
		dt_atualizacao_nrec,
		nm_usuario_nrec,
		dt_registro,
		nr_seq_operacao,
		cd_pessoa_fisica,
		nr_seq_local,
		nr_seq_local_orig_dest,
		dt_liberacao,
		ds_observacao,
		nr_seq_lavanderia)
	values (nr_seq_lote_w,
		cd_estabelecimento_w,
		clock_timestamp(),
		nm_usuario_p,
		clock_timestamp(),
		nm_usuario_p,
		clock_timestamp(),
		nr_seq_operacao_w,
		cd_pessoa_fisica_w,
		nr_seq_local_w,
		nr_seq_local_destino_p,
		null,
		--'Este lote de movimentacao foi gerado apartir de um lote da lavanderia: ' || nr_seq_lavanderia_p,
		wheb_mensagem_pck.get_texto(311757,'NR_SEQ_LAVANDERIA=' || nr_seq_lavanderia_p),
		nr_seq_lavanderia_p);

	open C02;
	loop
	fetch C02 into	
		nr_seq_roupa_w,
		qt_peso_w,
		qt_roupa_w;
	EXIT WHEN NOT FOUND; /* apply on C02 */
		begin
		
		insert into rop_movto_roupa(
			nr_sequencia,
			nr_seq_lote,
			dt_atualizacao,
			nm_usuario,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			nr_seq_roupa,
			qt_peso,
			qt_roupa,
			dt_origem,
			dt_destino,
			cd_estabelecimento,
			ie_oper_correta)
		values (nextval('rop_movto_roupa_seq'),
			nr_seq_lote_w,
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			nr_seq_roupa_w,
			qt_peso_w,
			qt_roupa_w,
			clock_timestamp(),
			clock_timestamp(),
			cd_estabelecimento_w,
			'S');
			
			update	rop_roupa
			set	nr_seq_local	= nr_seq_local_destino_p,
				dt_atualizacao	= clock_timestamp(),
				nm_usuario	= nm_usuario_p
			where	nr_sequencia	= nr_seq_roupa_w;
		end;
	end loop;
	close C02;
	
	end;
end loop;
close C01;

update	rop_lavanderia
set	dt_confirmacao = clock_timestamp()
where	nr_sequencia = nr_seq_lavanderia_p;

update	rop_lote_movto
set	dt_liberacao	= clock_timestamp()
where nr_seq_lavanderia = nr_seq_lavanderia_p;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE rop_gerar_movimento_lavanderia ( nr_seq_lavanderia_p bigint, nr_seq_local_destino_p bigint, nm_usuario_p text) FROM PUBLIC;

