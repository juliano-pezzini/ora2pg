-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_sequencia_cheque_cpa ( cd_conta_p bigint, nr_cheque_p INOUT bigint) AS $body$
DECLARE


nr_ultimo_cheque_w	bigint;
nr_cheque_ini_w		bigint;
nr_cheque_fim_w		bigint;

nr_ultimo_ch_w		banco_estabelecimento.nr_ultimo_cheque%type;



BEGIN

--buscar cheque inicial, final e ultimo cheque informado no cadastro do banco.
select	coalesce(nr_ultimo_cheque,0),
	coalesce(nr_cheque_ini,0),
	coalesce(nr_cheque_fim,0)
into STRICT	nr_ultimo_ch_w,
	nr_cheque_ini_w,
	nr_cheque_fim_w
from	banco_estabelecimento
where	nr_sequencia = cd_conta_p;

/*OS 1248451 - Melhoria caso existir salvo alguma coisa no campo diferente de numero. No select acima estava fazendo INTO em uma variavel NUMBER sendo que o campo na tabela é varchar2.
Agora faz INTO na variavel do mesmo tipo da tabela acima, onde nao ocorrera erro nesse select, e aqui em baixo, tratamos a variavel que é number para considerar apenas numeros do select acima, e incrementar +1, o que fazia direto n oselect acima antes*/
nr_ultimo_cheque_w := somente_numero(nr_ultimo_ch_w);
nr_ultimo_cheque_w := coalesce(nr_ultimo_cheque_w,0)+1;

if ( (nr_cheque_ini_w <> 0) or (nr_cheque_fim_w <> 0) ) then
	if (nr_ultimo_cheque_w > nr_cheque_fim_w AND nr_cheque_fim_w <> 0) or ( nr_ultimo_cheque_w < nr_cheque_ini_w AND nr_cheque_ini_w <> 0) then
		--R.aise_application_error(-20011,'A sequencia do número do cheque  está fora da sequência informada no cadastro do banco, nos campos "Nr cheque inicial" e "Nr cheque Final"');
		CALL wheb_mensagem_pck.exibir_mensagem_abort(227592);
	end if;
end if;

if (nr_ultimo_cheque_w IS NOT NULL AND nr_ultimo_cheque_w::text <> '') then
    -- OS 1248451 - Retirado esse update abaixo conforme solicitado pelo analista na análise.
	/*update	banco_estabelecimento
	set	nr_ultimo_cheque = nr_ultimo_cheque_w
	where	nr_sequencia = cd_conta_p;*/
	nr_cheque_p := nr_ultimo_cheque_w;
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_sequencia_cheque_cpa ( cd_conta_p bigint, nr_cheque_p INOUT bigint) FROM PUBLIC;

