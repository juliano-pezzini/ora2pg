-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE ctb_gerar_aux_event_conhec_cop ( nm_usuario_p usuario.nm_usuario%type, cd_empresa_p empresa.cd_empresa%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, dt_inicial_p ctb_livro_auxiliar.dt_inicial%type, dt_final_p ctb_livro_auxiliar.dt_final%type, dt_liberacao_p ctb_livro_auxiliar.dt_liberacao%type, ie_gerar_arquivo_p ctb_livro_auxiliar.ie_tipo_livro_ecd%type, nr_seq_regra_p ctb_livro_auxiliar.nr_sequencia%type, ie_tipo_segurado_p pls_conta.ie_tipo_segurado%type, ie_tipo_protocolo_p pls_protocolo_conta.ie_tipo_protocolo%type, ie_gerar_ind_classif_p ctb_livro_auxiliar.ie_tipo_livro_ecd%type) AS $body$
DECLARE

						
dt_contabil_w					timestamp;
dt_liquidacao_w					timestamp;
dt_referencia_month_w				timestamp;
nr_contador_w					bigint := 0;
ie_nao_aplica_recalc_w				varchar(1);
ie_glosa_w					varchar(1);
ds_operacao_w					varchar(255);
qt_prest_outros_w				bigint;
nr_titulo_w					bigint;
ie_lote_ajuste_prod_w				pls_parametro_contabil.ie_lote_ajuste_prod%type;
ie_forma_contab_taxa_pgto_w			pls_parametro_contabil.ie_forma_contab_taxa_pgto%type;
ie_forma_contab_reembolso_w			pls_parametro_contabil.ie_forma_contab_reembolso%type;
dt_emissao_w					titulo_receber.dt_emissao%type;
dt_vencimento_w					titulo_receber.dt_vencimento%type;
ie_prestador_codificacao_w			pls_esquema_contabil.ie_prestador_codificacao%type;
cd_conta_debito_w				conta_contabil.cd_conta_contabil%type;
cd_conta_credito_w				conta_contabil.cd_conta_contabil%type;
ie_tipo_segurado_w				ctb_livro_auxiliar.ie_tipo_segurado%type;
ds_observacao_w					varchar(255);
ds_observacao_item_w				varchar(255);
ie_tipo_compartilhamento_w			pls_segurado_repasse.ie_tipo_compartilhamento%type;
ie_tipo_repasse_w				pls_segurado_repasse.ie_tipo_repasse%type;
dt_repasse_w					pls_segurado_repasse.dt_repasse%type;
dt_fim_repasse_w				pls_segurado_repasse.dt_fim_repasse%type;
dt_ref_repasse_w				pls_conta_proc.dt_procedimento%type;
ie_data_tipo_segurado_w				pls_parametros.ie_data_tipo_segurado%type;
qt_regra_evento_w                   		bigint;
qt_regra_reemb_taxa_w           		bigint;

/*Variaveis para geracao do arquivo*/

dt_inicial_w					timestamp;
dt_final_w					timestamp;
nr_planilha_w					smallint;
qt_registros_w					bigint;
qt_limite_w					bigint := 999999;
ds_erro_w					varchar(255);
ds_local_w					varchar(255);
nm_arquivo_w					varchar(255);
arq_texto_w					utl_file.file_type;
ds_nome_livro_w					varchar(255);
ds_periodo_w					varchar(255);						

------------------------------------------------											
							
c_linha CURSOR FOR
	SELECT	a.nr_seq_protocolo										|| ';' ||
		a.nr_documento											|| ';' ||
		a.ds_tipo_protocolo										|| ';' ||
		coalesce(to_char(a.cd_procedimento),a.cd_material_ops)						|| ';' ||
		a.ds_item_mat_proc										|| ';' ||
		a.dt_ocorrencia											|| ';' ||
		a.dt_conhecimento										|| ';' ||
		a.cd_beneficiario										|| ';' ||
		substr(obter_valor_dominio(6,pls_obter_se_benef_remido(a.nr_seq_segurado,
			a.dt_ocorrencia)),1,255)								|| ';' ||
		a.nm_usuario_evento										|| ';' ||
		substr(pls_obter_se_corresp_assumida(a.ie_tipo_segurado,
			a.nr_cpf_cnpj),1,255)									|| ';' ||
		a.nm_usuario_princ										|| ';' ||
		a.ds_tipo_segurado										|| ';' ||
		a.nr_cpf_cnpj_adic										|| ';' ||
		a.nm_prestador											|| ';' ||
		a.ds_operacao											|| ';' ||
		a.ds_tipo_documento										|| ';' ||
		a.ds_grupo_ans											|| ';' ||
		substr(pls_obter_se_corresp_assumida(a.ie_tipo_segurado,
			a.nr_protocolo_ans),1,255)								|| ';' ||
		a.ds_tipo_vinculo_operadora									|| ';' ||
		a.ds_ato_cooperado										|| ';' ||
		a.ds_modalidade_contrat										|| ';' ||
		a.ds_tipo_regulamentacao									|| ';' ||
		a.ds_tipo_contratacao										|| ';' ||
		a.ds_segmentacao										|| ';' ||
		substr(pls_obter_se_corresp_assumida(a.ie_tipo_segurado,
			a.nr_contrato),1,255)									|| ';' ||
		a.vl_evento											|| ';' ||
		a.vl_pagar											|| ';' ||
		a.vl_ajuste											|| ';' ||
		a.vl_glosa											|| ';' ||
		a.vl_coparticipacao                                                                             || ';' ||
		a.vl_taxa_pgto											|| ';' ||
		a.dt_pagamento											|| ';' ||
		a.dt_contabilizacao										|| ';' ||
		a.dt_emissao											|| ';' ||
		a.dt_vencimento											|| ';' ||
		a.nr_titulo											|| ';' ||
		a.cd_conta_contabil   										|| ';' ||
		substr(ctb_obter_classif_conta(a.cd_conta_contabil, null, dt_final_w),1,255)			|| ';' ||
		a.cd_conta_contrapartida   							         	|| ';' ||
		substr(ctb_obter_classif_conta(a.cd_conta_contrapartida, null, dt_final_w),1,255)  		|| ';' ||
		substr(obter_valor_dominio(3579,ie_tipo_evento),1,255)						|| ';' ||
                substr(obter_valor_dominio(3384, a.ie_tipo_repasse), 1,255)                                     || ';' ||
                substr(obter_valor_dominio(8980, a.ie_tipo_compartilhamento), 1,255)                            || ';' ||
		a.dt_inicio_compartilhamento									|| ';' ||
		a.dt_fim_compartilhamento									|| ';' ||
		a.vl_deferido											|| ';' ||	
		a.cd_abi											|| ';' ||
		a.nr_aih											|| ';' ||
		a.ds_observacao ds_linha
	from	w_ctb_livro_aux_event_liq a
	where	nr_seq_reg_auxiliar = nr_seq_regra_p
	order by (nr_documento)::numeric;

c_medica CURSOR FOR
	/*PROTOCOLO PROCEDIMENTO*/

	SELECT 	c.nr_sequencia nr_documento,
		e.ie_tipo_protocolo ie_tipo_protocolo,
		null cd_material_ops,
		coalesce(r.cd_procedimento,p.cd_procedimento) cd_procedimento,
		coalesce(r.ie_origem_proced,p.ie_origem_proced) ie_origem_proced,
		substr(obter_descricao_procedimento(coalesce(r.cd_procedimento,p.cd_procedimento),coalesce(r.ie_origem_proced,p.ie_origem_proced)),1,255) ds_item_mat_proc,
		p.dt_procedimento dt_ocorrencia,
		e.dt_mes_competencia dt_conhecimento,
		(SELECT	max(t.dt_liquidacao)
		FROM pls_pagamento_prestador p, pls_lote_pagamento l, pls_pag_prest_vencimento v
LEFT OUTER JOIN titulo_pagar t ON (v.nr_titulo = t.nr_titulo)
WHERE l.nr_sequencia		= r.nr_seq_lote_pgto and l.nr_sequencia		= p.nr_seq_lote and p.nr_sequencia		= v.nr_seq_pag_prestador and p.nr_seq_prestador	= r.nr_seq_prestador_pgto  ) dt_liquidacao,
		substr(pls_obter_dados_segurado(s.nr_sequencia,'C'),1,255) cd_beneficiario,
		substr(pls_obter_dados_segurado(s.nr_sequencia,'N'),1,255)  nm_beneficiario,
		substr(pls_obter_dados_segurado(coalesce(s.nr_seq_titular,s.nr_sequencia),'N'),1,255)  nm_usuario_princ,
		c.ie_tipo_segurado ie_tipo_segurado,
		substr(CASE WHEN qt_prest_outros_w=0 THEN r.nm_prestador_pgto  ELSE pls_obter_dados_prestador(c.nr_seq_prestador_exec,'N') END ,1,255) nm_prestador,
		substr(pls_obter_dados_segurado(coalesce(s.nr_seq_titular,s.nr_sequencia),'CPF'),1,255) cd_cpf_cgc,
		'Despesas com Eventos / Sinistros' ds_operacao,
		'CM' ie_tipo_documento,
		substr(pls_obter_dados_grupo_ans(p.nr_seq_grupo_ans,'D'),1,255) ds_grupo_ans,
		substr(pls_obter_dados_prestador(r.nr_seq_prestador_pgto,'TR'),1,255) ds_tipo_vinculo_operadora,
		coalesce(r.ie_ato_cooperado,p.ie_ato_cooperado) ie_ato_cooperado,
		y.ie_preco ie_modalidade_contrat,	
		y.ie_regulamentacao ie_regulamentacao,
		y.ie_tipo_contratacao ie_tipo_contratacao,
		y.ie_segmentacao ie_segmentacao,
		coalesce(pls_obter_valor_prov_resumo(c.nr_sequencia,r.nr_sequencia,r.vl_apresentado,r.vl_calculado,r.vl_liberado,r.vl_taxa_adm,r.vl_taxa_adm_co,r.vl_taxa_adm_mat,ie_forma_contab_taxa_pgto_w,'P'), 0) vl_evento,
		pls_obter_valor_prov_resumo(c.nr_sequencia,r.nr_sequencia,r.vl_apresentado,r.vl_calculado,r.vl_liberado,r.vl_taxa_adm,r.vl_taxa_adm_co,r.vl_taxa_adm_mat,ie_forma_contab_taxa_pgto_w,'A') vl_ajuste,
		coalesce(r.vl_liberado, coalesce(p.vl_liberado,0)) vl_pagamento,
		coalesce(r.vl_glosa,0) vl_glosa,
		( 	select 	coalesce(sum(o.vl_coparticipacao * dividir_sem_round(r.vl_liberado,p.vl_liberado)),0)
			from	pls_conta_coparticipacao o
			where   p.nr_sequencia = o.nr_seq_conta_proc
			and	c.nr_sequencia  = o.nr_seq_conta
			and	o.ie_status_coparticipacao	in ('D','S')
			and o.ie_status_mensalidade <> 'C') vl_coparticipacao,
		coalesce(r.vl_taxa_adm,0) + coalesce(r.vl_taxa_adm_co,0) + coalesce(r.vl_taxa_adm_mat,0) vl_taxa_pgto,
		e.dt_mes_competencia dt_contabilizacao,
		coalesce(r.cd_conta_prov_cred, coalesce(p.cd_conta_provisao_cred, p.cd_conta_cred)) cd_conta_credito,
		coalesce(r.cd_conta_prov_deb, coalesce(p.cd_conta_provisao_deb, p.cd_conta_deb)) cd_conta_debito,
		t.nr_contrato nr_contrato,
		r.nr_sequencia nr_seq_resumo,
		CASE WHEN y.ie_tipo_operacao='A' THEN  'SCA'  ELSE coalesce(y.nr_protocolo_ans, y.cd_scpa) END  nr_protocolo_ans,
		s.nr_sequencia	nr_seq_segurado,
		p.nr_seq_grupo_ans nr_seq_grupo_ans,
		e.nr_sequencia nr_seq_protocolo,
		c.nr_seq_fatura nr_seq_fatura,
		r.nr_sequencia nr_seq_conta_resumo,
		coalesce(coalesce(substr(pls_obter_dados_prestador(c.nr_seq_prestador_exec,'CPF'),1,255),
			substr(pls_obter_dados_prestador(c.nr_seq_prestador_exec,'CGC'),1,255)), 
				substr(CASE WHEN e.ie_tipo_protocolo='I' THEN substr(pls_obter_cnpj_congenere(e.nr_seq_congenere),1,255)  ELSE coalesce(Obter_Cpf_Pessoa_Fisica(c.cd_pessoa_fisica), c.cd_cgc) END ,1,255)) nr_cpf_cnpj_adic,
		coalesce(s.nr_seq_titular,s.nr_sequencia) nr_seq_titular,
		CASE WHEN qt_prest_outros_w=0 THEN  r.nr_seq_prestador_pgto  ELSE coalesce(c.nr_seq_prestador_exec,e.nr_seq_congenere) END  nr_seq_prestador,
		null nr_seq_arquivo,
		k.ie_tipo_grupo_ans,
		e.nr_seq_congenere,
		e.dt_mes_competencia,
		null vl_deferido,
		null cd_abi,
		null nr_aih
	FROM pls_conta_medica_resumo r, pls_protocolo_conta e, pls_conta c
LEFT OUTER JOIN pls_segurado s ON (c.nr_seq_segurado = s.nr_sequencia)
LEFT OUTER JOIN pls_plano y ON (c.nr_seq_plano = y.nr_sequencia)
LEFT OUTER JOIN pls_contrato t ON (s.nr_seq_contrato = t.nr_sequencia)
, pls_conta_proc p
LEFT OUTER JOIN ans_grupo_despesa k ON (p.nr_seq_grupo_ans = k.nr_sequencia)
WHERE c.nr_sequencia 		= p.nr_seq_conta and e.nr_sequencia 		= c.nr_seq_protocolo    and p.nr_sequencia 		= r.nr_seq_conta_proc and c.nr_sequencia 		= r.nr_seq_conta  and e.dt_mes_competencia between dt_inicial_w and dt_final_w and (ie_gerar_ind_classif_p <> 'N'
	or	substr(coalesce(r.cd_classif_prov_deb,coalesce(p.cd_classif_prov_deb,p.cd_classif_deb)),1,5) = '4.1.1') and e.ie_tipo_protocolo = 'C' and (c.ie_tipo_segurado = ie_tipo_segurado_p or coalesce(ie_tipo_segurado_p::text, '') = '') and (e.ie_tipo_protocolo = ie_tipo_protocolo_p or coalesce(ie_tipo_protocolo_p::text, '') = '') and r.ie_situacao = 'A' and p.ie_status <> 'D' and c.ie_status <> 'C' /*and	not exists(	select	1
				from	pls_item_recalculo y
				where	y.nr_seq_procedimento = p.nr_sequencia
				and	y.nr_seq_conta_resumo <> r.nr_sequencia)*/
 
union all

	/*PROTOCOLO MATERIAL*/

	select 	c.nr_sequencia nr_documento,
		e.ie_tipo_protocolo ie_tipo_protocolo,
		substr(pls_obter_dados_conta_mat(coalesce(r.nr_seq_conta_mat,m.nr_sequencia),'O'),1,14) cd_material_ops,
		null cd_procedimento,
		null ie_origem_proced,
		substr(pls_obter_dados_conta_mat(coalesce(r.nr_seq_conta_mat,m.nr_sequencia),'D'),1,14) ds_item_mat_proc,
		m.dt_atendimento dt_ocorrencia,
		e.dt_mes_competencia dt_conhecimento,
		(select	max(t.dt_liquidacao)
		FROM pls_pagamento_prestador p, pls_lote_pagamento l, pls_pag_prest_vencimento v
LEFT OUTER JOIN titulo_pagar t ON (v.nr_titulo = t.nr_titulo)
WHERE l.nr_sequencia		= r.nr_seq_lote_pgto and l.nr_sequencia		= p.nr_seq_lote and p.nr_sequencia		= v.nr_seq_pag_prestador and p.nr_seq_prestador	= r.nr_seq_prestador_pgto  ) dt_liquidacao,
		substr(pls_obter_dados_segurado(s.nr_sequencia,'C'),1,255) cd_beneficiario,
		substr(pls_obter_dados_segurado(s.nr_sequencia,'N'),1,255)  nm_beneficiario,
		substr(pls_obter_dados_segurado(coalesce(s.nr_seq_titular,s.nr_sequencia),'N'),1,255)  nm_usuario_princ,
		c.ie_tipo_segurado ie_tipo_segurado,
		substr(CASE WHEN qt_prest_outros_w=0 THEN r.nm_prestador_pgto  ELSE pls_obter_dados_prestador(c.nr_seq_prestador_exec,'N') END ,1,255) nm_prestador,
		substr(pls_obter_dados_segurado(coalesce(s.nr_seq_titular,s.nr_sequencia),'CPF'),1,255) cd_cpf_cgc,
		'Despesas com Eventos / Sinistros' ds_operacao,
		'CM' ie_tipo_documento,
		substr(pls_obter_dados_grupo_ans(m.nr_seq_grupo_ans,'D'),1,255) ds_grupo_ans,
		substr(pls_obter_dados_prestador(r.nr_seq_prestador_pgto,'TR'),1,255) ds_tipo_vinculo_operadora,
		coalesce(r.ie_ato_cooperado,m.ie_ato_cooperado) ie_ato_cooperado,
		y.ie_preco ie_modalidade_contrat,	
		y.ie_regulamentacao ie_regulamentacao,
		y.ie_tipo_contratacao ie_tipo_contratacao,
		y.ie_segmentacao ie_segmentacao,
		coalesce(pls_obter_valor_prov_resumo(c.nr_sequencia,r.nr_sequencia,r.vl_apresentado,r.vl_calculado,r.vl_liberado,r.vl_taxa_adm,r.vl_taxa_adm_co,r.vl_taxa_adm_mat,ie_forma_contab_taxa_pgto_w,'P'), 0) vl_evento,
		pls_obter_valor_prov_resumo(c.nr_sequencia,r.nr_sequencia,r.vl_apresentado,r.vl_calculado,r.vl_liberado,r.vl_taxa_adm,r.vl_taxa_adm_co,r.vl_taxa_adm_mat,ie_forma_contab_taxa_pgto_w,'A') vl_ajuste,
		coalesce(r.vl_liberado, coalesce(m.vl_liberado,0)) vl_pagamento,
		coalesce(r.vl_glosa,0) vl_glosa,
		( 	select 	coalesce(sum(o.vl_coparticipacao * dividir_sem_round(r.vl_liberado,m.vl_liberado)),0)
			from	pls_conta_coparticipacao o
			where   m.nr_sequencia = o.nr_seq_conta_mat
			and	c.nr_sequencia  = o.nr_seq_conta 
			and	o.ie_status_coparticipacao	in ('D','S')
			and o.ie_status_mensalidade <> 'C') vl_coparticipacao,
		coalesce(r.vl_taxa_adm,0) + coalesce(r.vl_taxa_adm_co,0) + coalesce(r.vl_taxa_adm_mat,0) vl_taxa_pgto,
		e.dt_mes_competencia dt_contabilizacao,
		coalesce(r.cd_conta_prov_cred, coalesce(m.cd_conta_provisao_cred, m.cd_conta_cred)) cd_conta_credito,
		coalesce(r.cd_conta_prov_deb, coalesce(m.cd_conta_provisao_deb, m.cd_conta_deb)) cd_conta_debito,
		t.nr_contrato nr_contrato,
		r.nr_sequencia nr_seq_resumo,
		CASE WHEN y.ie_tipo_operacao='A' THEN  'SCA'  ELSE coalesce(y.nr_protocolo_ans, y.cd_scpa) END  nr_protocolo_ans,
		s.nr_sequencia	nr_seq_segurado,
		m.nr_seq_grupo_ans nr_seq_grupo_ans,
		e.nr_sequencia nr_seq_protocolo,
		c.nr_seq_fatura nr_seq_fatura,
		r.nr_sequencia nr_seq_conta_resumo,
		coalesce(coalesce(substr(pls_obter_dados_prestador(c.nr_seq_prestador_exec,'CPF'),1,255),
			substr(pls_obter_dados_prestador(c.nr_seq_prestador_exec,'CGC'),1,255)), 
				substr(CASE WHEN e.ie_tipo_protocolo='I' THEN substr(pls_obter_cnpj_congenere(e.nr_seq_congenere),1,255)  ELSE coalesce(Obter_Cpf_Pessoa_Fisica(c.cd_pessoa_fisica), c.cd_cgc) END ,1,255)) nr_cpf_cnpj_adic,
		coalesce(s.nr_seq_titular,s.nr_sequencia) nr_seq_titular,
		CASE WHEN qt_prest_outros_w=0 THEN  r.nr_seq_prestador_pgto  ELSE coalesce(c.nr_seq_prestador_exec,e.nr_seq_congenere) END  nr_seq_prestador,
		null nr_seq_arquivo,
		k.ie_tipo_grupo_ans,
		e.nr_seq_congenere,
		e.dt_mes_competencia,
		null vl_deferido,
		null cd_abi,
		null nr_aih
	FROM pls_conta_medica_resumo r, pls_protocolo_conta e, pls_conta c
LEFT OUTER JOIN pls_segurado s ON (c.nr_seq_segurado = s.nr_sequencia)
LEFT OUTER JOIN pls_plano y ON (c.nr_seq_plano = y.nr_sequencia)
LEFT OUTER JOIN pls_contrato t ON (s.nr_seq_contrato = t.nr_sequencia)
, pls_conta_mat m
LEFT OUTER JOIN ans_grupo_despesa k ON (m.nr_seq_grupo_ans = k.nr_sequencia)
WHERE c.nr_sequencia 		= m.nr_seq_conta and e.nr_sequencia 		= c.nr_seq_protocolo    and c.nr_sequencia 		= r.nr_seq_conta and m.nr_sequencia 		= r.nr_seq_conta_mat  and e.dt_mes_competencia between dt_inicial_w and dt_final_w and (ie_gerar_ind_classif_p <> 'N'
	or	substr(coalesce(r.cd_classif_prov_deb,coalesce(m.cd_classif_prov_deb,m.cd_classif_deb)),1,5) = '4.1.1') and e.ie_tipo_protocolo = 'C' and (c.ie_tipo_segurado = ie_tipo_segurado_p or coalesce(ie_tipo_segurado_p::text, '') = '') and (e.ie_tipo_protocolo = ie_tipo_protocolo_p or coalesce(ie_tipo_protocolo_p::text, '') = '') and r.ie_situacao = 'A' and m.ie_status <> 'D' and c.ie_status <> 'C' /*and	not exists(	select	1
				from	pls_item_recalculo y
				where	y.nr_seq_material = m.nr_sequencia
				and	y.nr_seq_conta_resumo <> r.nr_sequencia)*/
 
union all

	select 	c.nr_sequencia nr_documento,
		e.ie_tipo_protocolo ie_tipo_protocolo,
		null cd_material_ops,
		p.cd_procedimento cd_procedimento,
		p.ie_origem_proced ie_origem_proced,
		substr(obter_descricao_procedimento(p.cd_procedimento,p.ie_origem_proced),1,255) ds_item_mat_proc,
		p.dt_procedimento dt_ocorrencia,
		e.dt_mes_competencia dt_conhecimento,
		(select	max(t.dt_liquidacao)
			FROM pls_conta_medica_resumo r, pls_pagamento_prestador p, pls_lote_pagamento l, pls_pag_prest_vencimento v
LEFT OUTER JOIN titulo_pagar t ON (v.nr_titulo = t.nr_titulo)
WHERE l.nr_sequencia		= r.nr_seq_lote_pgto and l.nr_sequencia		= p.nr_seq_lote and p.nr_sequencia		= v.nr_seq_pag_prestador and p.nr_seq_prestador	= r.nr_seq_prestador_pgto  and r.nr_seq_conta		= c.nr_sequencia and r.nr_seq_conta_proc	= p.nr_sequencia ) dt_liquidacao,
		substr(pls_obter_dados_segurado(s.nr_sequencia,'C'),1,255) cd_beneficiario,
		substr(pls_obter_dados_segurado(s.nr_sequencia,'N'),1,255)  nm_beneficiario,
		substr(pls_obter_dados_segurado(coalesce(s.nr_seq_titular,s.nr_sequencia),'N'),1,255)  nm_usuario_princ,
		c.ie_tipo_segurado ie_tipo_segurado,
		substr(CASE WHEN e.ie_tipo_protocolo='I' THEN pls_obter_nome_congenere(e.nr_seq_congenere)  ELSE obter_nome_pf_pj(c.cd_pessoa_fisica, c.cd_cgc) END ,1,255) nm_prestador,		
		substr(pls_obter_dados_segurado(coalesce(s.nr_seq_titular,s.nr_sequencia),'CPF'),1,255) cd_cpf_cgc,
		CASE WHEN e.ie_tipo_protocolo='I' THEN obter_desc_expressao(973290) WHEN e.ie_tipo_protocolo='R' THEN 'Despesas com Reembolso' WHEN e.ie_tipo_protocolo='F' THEN 'Corresponsabilidade Cedida'  ELSE '' END  ds_operacao,
		'CM' ie_tipo_documento,
		substr(pls_obter_dados_grupo_ans(p.nr_seq_grupo_ans,'D'),1,255) ds_grupo_ans,
		substr(CASE WHEN coalesce(c.nr_seq_prestador_exec, 0)=0 THEN  			CASE WHEN coalesce(ie_tipo_protocolo_p,e.ie_tipo_protocolo)='I' THEN obter_desc_expressao(822559) WHEN coalesce(ie_tipo_protocolo_p,e.ie_tipo_protocolo)='F' THEN 'Corresponsabilidade Cedida' WHEN coalesce(ie_tipo_protocolo_p,e.ie_tipo_protocolo)='R' THEN  'Reembolso'  ELSE '' END   ELSE pls_obter_dados_prestador(c.nr_seq_prestador_exec, 'TR') END , 1,255) ds_tipo_vinculo_operadora,
		p.ie_ato_cooperado ie_ato_cooperado,
		y.ie_preco ie_modalidade_contrat,	
		y.ie_regulamentacao ie_regulamentacao,
		y.ie_tipo_contratacao ie_tipo_contratacao,
		y.ie_segmentacao ie_segmentacao,
		coalesce(p.vl_procedimento_imp, 0) vl_evento,
		coalesce((	select	max(r.vl_liberado)
			from	pls_conta_medica_resumo	r
			where	p.nr_sequencia		= r.nr_seq_conta_proc
			and	c.nr_sequencia		= r.nr_seq_conta),0) - coalesce(p.vl_provisao,0) vl_ajuste,
		coalesce(p.vl_liberado,0) vl_pagamento,
		coalesce(p.vl_glosa,0) vl_glosa,
		( 	select 	sum(coalesce(o.vl_coparticipacao,0))
			from	pls_conta_coparticipacao o
			where   p.nr_sequencia = o.nr_seq_conta_proc
			and	c.nr_sequencia  = o.nr_seq_conta
			and	o.ie_status_coparticipacao in ('D','S')
			and o.ie_status_mensalidade <> 'C') vl_coparticipacao,
		0 vl_taxa_pgto,
		e.dt_mes_competencia dt_contabilizacao,
		p.cd_conta_cred cd_conta_credito,
		p.cd_conta_deb cd_conta_debito,
		t.nr_contrato nr_contrato,
		(select	max(r.nr_sequencia)
			from	pls_conta_medica_resumo	r
			where	p.nr_sequencia		= r.nr_seq_conta_proc
			and	c.nr_sequencia		= r.nr_seq_conta) nr_seq_resumo,
			CASE WHEN y.ie_tipo_operacao='A' THEN  'SCA'  ELSE coalesce(y.nr_protocolo_ans, y.cd_scpa) END  nr_protocolo_ans,
		s.nr_sequencia	nr_seq_segurado,
		p.nr_seq_grupo_ans nr_seq_grupo_ans,
		e.nr_sequencia nr_seq_protocolo,
		c.nr_seq_fatura nr_seq_fatura,
		null nr_seq_conta_resumo,
		coalesce(coalesce(substr(pls_obter_dados_prestador(c.nr_seq_prestador_exec,'CPF'),1,255),
			substr(pls_obter_dados_prestador(c.nr_seq_prestador_exec,'CGC'),1,255)), 
				CASE WHEN e.ie_tipo_protocolo='I' THEN substr(pls_obter_cnpj_congenere(e.nr_seq_congenere),1,255)  ELSE coalesce(Obter_Cpf_Pessoa_Fisica(c.cd_pessoa_fisica), c.cd_cgc) END ) nr_cpf_cnpj_adic,
		coalesce(s.nr_seq_titular,s.nr_sequencia) nr_seq_titular,
		coalesce(c.nr_seq_prestador_exec,e.nr_seq_congenere) nr_seq_prestador,
		null nr_seq_arquivo,
		k.ie_tipo_grupo_ans,
		e.nr_seq_congenere,
		e.dt_mes_competencia,
		null vl_deferido,
		null cd_abi,
		null nr_aih
	FROM pls_conta c
LEFT OUTER JOIN pls_segurado s ON (c.nr_seq_segurado = s.nr_sequencia)
LEFT OUTER JOIN pls_contrato t ON (s.nr_seq_contrato = t.nr_sequencia)
LEFT OUTER JOIN pls_plano y ON (s.nr_seq_plano = y.nr_sequencia)
, pls_conta_proc p
LEFT OUTER JOIN ans_grupo_despesa k ON (p.nr_seq_grupo_ans = k.nr_sequencia)
, pls_protocolo_conta e
LEFT OUTER JOIN pls_congenere i ON (e.nr_seq_congenere = i.nr_sequencia)
WHERE c.nr_sequencia 		= p.nr_seq_conta and e.nr_sequencia 		= c.nr_seq_protocolo      and ((e.dt_mes_competencia between dt_inicial_p and dt_final_w
	and	((e.ie_tipo_protocolo <> 'R') or ie_forma_contab_reembolso_w = 'L'))
	or	(e.dt_mes_competencia between dt_inicial_p and dt_final_w
	and	((e.ie_tipo_protocolo = 'R') and ie_forma_contab_reembolso_w = 'C'))
	or	(e.dt_mes_competencia between dt_inicial_p and dt_final_w
	and	((e.ie_tipo_protocolo = 'R') and ie_forma_contab_reembolso_w = 'M'))) and (ie_gerar_ind_classif_p <> 'N'
	or	substr(p.cd_classif_deb,1,5) = '4.1.1') and e.ie_tipo_protocolo in ('I','R','F') and c.ie_status <> 'C' and p.ie_status <> 'D' and (c.ie_tipo_segurado = ie_tipo_segurado_p or coalesce(ie_tipo_segurado_p::text, '') = '') and (e.ie_tipo_protocolo = ie_tipo_protocolo_p or coalesce(ie_tipo_protocolo_p::text, '') = '') and qt_regra_evento_w > 0
	 
union all

	select 	c.nr_sequencia nr_documento,
		e.ie_tipo_protocolo ie_tipo_protocolo,
		substr(pls_obter_dados_conta_mat(m.nr_sequencia,'O'),1,255) cd_material_ops,
		null cd_procedimento,
		null ie_origem_proced,
		substr(pls_obter_dados_conta_mat(m.nr_sequencia,'D'),1,255) ds_item_mat_proc,
		m.dt_atendimento dt_ocorrencia,
		e.dt_mes_competencia dt_conhecimento,
		(select	max(t.dt_liquidacao)
		FROM pls_conta_medica_resumo r, pls_pagamento_prestador p, pls_lote_pagamento l, pls_pag_prest_vencimento v
LEFT OUTER JOIN titulo_pagar t ON (v.nr_titulo = t.nr_titulo)
WHERE l.nr_sequencia		= r.nr_seq_lote_pgto and l.nr_sequencia		= p.nr_seq_lote and p.nr_sequencia		= v.nr_seq_pag_prestador and p.nr_seq_prestador	= r.nr_seq_prestador_pgto  and r.nr_seq_conta		= c.nr_sequencia and r.nr_seq_conta_mat	= p.nr_sequencia ) dt_liquidacao,
		substr(pls_obter_dados_segurado(s.nr_sequencia,'C'),1,255) cd_beneficiario,
		substr(pls_obter_dados_segurado(s.nr_sequencia,'N'),1,255)  nm_beneficiario,
		substr(pls_obter_dados_segurado(coalesce(s.nr_seq_titular,s.nr_sequencia),'N'),1,255)  nm_usuario_princ,
		c.ie_tipo_segurado ie_tipo_segurado,
		substr(CASE WHEN e.ie_tipo_protocolo='I' THEN pls_obter_nome_congenere(e.nr_seq_congenere)  ELSE obter_nome_pf_pj(c.cd_pessoa_fisica, c.cd_cgc) END ,1,255) nm_prestador,
		substr(pls_obter_dados_segurado(coalesce(s.nr_seq_titular,s.nr_sequencia),'CPF'),1,255) cd_cpf_cgc,
		CASE WHEN e.ie_tipo_protocolo='I' THEN obter_desc_expressao(973290) WHEN e.ie_tipo_protocolo='R' THEN 'Despesas com Reembolso' WHEN e.ie_tipo_protocolo='F' THEN 'Corresponsabilidade Cedida'  ELSE '' END  ds_operacao,
		'CM' ie_tipo_documento,
		substr(pls_obter_dados_grupo_ans(m.nr_seq_grupo_ans,'D'),1,255) ds_grupo_ans,
		substr(CASE WHEN coalesce(c.nr_seq_prestador_exec, 0)=0 THEN  			CASE WHEN coalesce(ie_tipo_protocolo_p,e.ie_tipo_protocolo)='I' THEN obter_desc_expressao(822559) WHEN coalesce(ie_tipo_protocolo_p,e.ie_tipo_protocolo)='F' THEN 'Corresponsabilidade Cedida' WHEN coalesce(ie_tipo_protocolo_p,e.ie_tipo_protocolo)='R' THEN  'Reembolso'  ELSE '' END   ELSE pls_obter_dados_prestador(c.nr_seq_prestador_exec, 'TR') END , 1,255) ds_tipo_vinculo_operadora,
		m.ie_ato_cooperado ie_ato_cooperado,
		y.ie_preco ie_modalidade_contrat,	
		y.ie_regulamentacao ie_regulamentacao,
		y.ie_tipo_contratacao ie_tipo_contratacao,
		y.ie_segmentacao ie_segmentacao,
		coalesce(m.vl_material_imp, 0) vl_evento,
		coalesce((	select	max(r.vl_liberado)
			from	pls_conta_medica_resumo	r
			where	m.nr_sequencia		= r.nr_seq_conta_mat
			and	c.nr_sequencia		= r.nr_seq_conta),0) - coalesce(m.vl_provisao,0) vl_ajuste,
		coalesce(m.vl_liberado,0) vl_pagamento,
		coalesce(m.vl_glosa,0) vl_glosa,
		( 	select 	coalesce(sum(o.vl_coparticipacao),0)
			from	pls_conta_coparticipacao o
			where   m.nr_sequencia = o.nr_seq_conta_mat
			and	c.nr_sequencia  = o.nr_seq_conta 
			and	o.ie_status_coparticipacao	in ('D','S')
			and o.ie_status_mensalidade <> 'C') vl_coparticipacao,
		0 vl_taxa_pgto,
		e.dt_mes_competencia dt_contabilizacao,
		m.cd_conta_cred cd_conta_credito,
		m.cd_conta_deb cd_conta_debito,
		t.nr_contrato nr_contrato,
		(select	max(r.nr_sequencia)
		from	pls_conta_medica_resumo	r
		where	m.nr_sequencia		= r.nr_seq_conta_mat
		and	c.nr_sequencia		= r.nr_seq_conta) nr_seq_resumo,
		CASE WHEN y.ie_tipo_operacao='A' THEN  'SCA'  ELSE coalesce(y.nr_protocolo_ans, y.cd_scpa) END  nr_protocolo_ans,
		s.nr_sequencia	nr_seq_segurado,
		m.nr_seq_grupo_ans nr_seq_grupo_ans,
		e.nr_sequencia nr_seq_protocolo,
		c.nr_seq_fatura nr_seq_fatura,
		null nr_seq_conta_resumo,
		coalesce(coalesce(substr(pls_obter_dados_prestador(c.nr_seq_prestador_exec,'CPF'),1,255),
			substr(pls_obter_dados_prestador(c.nr_seq_prestador_exec,'CGC'),1,255)), 
				CASE WHEN e.ie_tipo_protocolo='I' THEN substr(pls_obter_cnpj_congenere(e.nr_seq_congenere),1,255)  ELSE coalesce(Obter_Cpf_Pessoa_Fisica(c.cd_pessoa_fisica), c.cd_cgc) END ) nr_cpf_cnpj_adic,
		coalesce(s.nr_seq_titular,s.nr_sequencia) nr_seq_titular,
		coalesce(c.nr_seq_prestador_exec,e.nr_seq_congenere) nr_seq_prestador,
		null nr_seq_arquivo,
		k.ie_tipo_grupo_ans,
		e.nr_seq_congenere,
		e.dt_mes_competencia,
		null vl_deferido,
		null cd_abi,
		null nr_aih
	FROM pls_conta c
LEFT OUTER JOIN pls_segurado s ON (c.nr_seq_segurado = s.nr_sequencia)
LEFT OUTER JOIN pls_contrato t ON (s.nr_seq_contrato = t.nr_sequencia)
LEFT OUTER JOIN pls_plano y ON (s.nr_seq_plano = y.nr_sequencia)
, pls_conta_mat m
LEFT OUTER JOIN ans_grupo_despesa k ON (m.nr_seq_grupo_ans = k.nr_sequencia)
, pls_protocolo_conta e
LEFT OUTER JOIN pls_congenere i ON (e.nr_seq_congenere = i.nr_sequencia)
WHERE c.nr_sequencia 		= m.nr_seq_conta and e.nr_sequencia 		= c.nr_seq_protocolo      and ((e.dt_mes_competencia between dt_inicial_p and dt_final_w
	and	((e.ie_tipo_protocolo <> 'R') or ie_forma_contab_reembolso_w = 'C'))
	or	(e.dt_mes_competencia between dt_inicial_p and dt_final_w
	and	((e.ie_tipo_protocolo = 'R') and ie_forma_contab_reembolso_w = 'L'))
	or	(e.dt_mes_competencia between dt_inicial_p and dt_final_w
	and	((e.ie_tipo_protocolo = 'R') and ie_forma_contab_reembolso_w = 'M'))) and (ie_gerar_ind_classif_p <> 'N'
	or	substr(m.cd_classif_deb,1,5) = '4.1.1') and e.ie_tipo_protocolo in ('I','R','F') and c.ie_status <> 'C' and m.ie_status <> 'D' and (c.ie_tipo_segurado = ie_tipo_segurado_p or coalesce(ie_tipo_segurado_p::text, '') = '') and (e.ie_tipo_protocolo = ie_tipo_protocolo_p or coalesce(ie_tipo_protocolo_p::text, '') = '') and qt_regra_evento_w > 0
	 
union all

	select 	c.nr_sequencia nr_documento,
		e.ie_tipo_protocolo ie_tipo_protocolo,
		null cd_material_ops,
		p.cd_procedimento cd_procedimento,
		p.ie_origem_proced ie_origem_proced,
		substr(obter_descricao_procedimento(p.cd_procedimento,p.ie_origem_proced),1,255) ds_item_mat_proc,
		p.dt_procedimento dt_ocorrencia,
		e.dt_mes_competencia dt_conhecimento,
		(select	max(t.dt_liquidacao)
			FROM pls_conta_medica_resumo r, pls_pagamento_prestador p, pls_lote_pagamento l, pls_pag_prest_vencimento v
LEFT OUTER JOIN titulo_pagar t ON (v.nr_titulo = t.nr_titulo)
WHERE l.nr_sequencia		= r.nr_seq_lote_pgto and l.nr_sequencia		= p.nr_seq_lote and p.nr_sequencia		= v.nr_seq_pag_prestador and p.nr_seq_prestador	= r.nr_seq_prestador_pgto  and r.nr_seq_conta		= c.nr_sequencia and r.nr_seq_conta_proc	= p.nr_sequencia ) dt_liquidacao,
		substr(pls_obter_dados_segurado(s.nr_sequencia,'C'),1,255) cd_beneficiario,
		substr(pls_obter_dados_segurado(s.nr_sequencia,'N'),1,255)  nm_beneficiario,
		substr(pls_obter_dados_segurado(coalesce(s.nr_seq_titular,s.nr_sequencia),'N'),1,255)  nm_usuario_princ,
		c.ie_tipo_segurado ie_tipo_segurado,
		substr(CASE WHEN e.ie_tipo_protocolo='I' THEN pls_obter_nome_congenere(e.nr_seq_congenere)  ELSE obter_nome_pf_pj(c.cd_pessoa_fisica, c.cd_cgc) END ,1,255) nm_prestador,		
		substr(pls_obter_dados_segurado(coalesce(s.nr_seq_titular,s.nr_sequencia),'CPF'),1,255) cd_cpf_cgc,
		CASE WHEN e.ie_tipo_protocolo='I' THEN obter_desc_expressao(973290) WHEN e.ie_tipo_protocolo='R' THEN 'Despesas com Reembolso' WHEN e.ie_tipo_protocolo='F' THEN 'Corresponsabilidade Cedida'  ELSE null END  ds_operacao,
		'CM' ie_tipo_documento,
		substr(pls_obter_dados_grupo_ans(p.nr_seq_grupo_ans,'D'),1,255) ds_grupo_ans,
		substr(CASE WHEN coalesce(c.nr_seq_prestador_exec, 0)=0 THEN  			CASE WHEN coalesce(ie_tipo_protocolo_p,e.ie_tipo_protocolo)='I' THEN obter_desc_expressao(822559) WHEN coalesce(ie_tipo_protocolo_p,e.ie_tipo_protocolo)='F' THEN 'Corresponsabilidade Cedida' WHEN coalesce(ie_tipo_protocolo_p,e.ie_tipo_protocolo)='R' THEN  'Reembolso'  ELSE null END   ELSE pls_obter_dados_prestador(c.nr_seq_prestador_exec, 'TR') END , 1,255) ds_tipo_vinculo_operadora,
		p.ie_ato_cooperado ie_ato_cooperado,
		y.ie_preco ie_modalidade_contrat,	
		y.ie_regulamentacao ie_regulamentacao,
		y.ie_tipo_contratacao ie_tipo_contratacao,
		y.ie_segmentacao ie_segmentacao,
		coalesce(p.vl_procedimento_imp,0) - (coalesce(p.vl_taxa_material_imp,0) + coalesce(p.vl_taxa_servico_imp,0) + coalesce(p.vl_taxa_co_imp,0)) vl_evento,
		0 vl_ajuste,
		coalesce(p.vl_procedimento_imp,0) - (coalesce(p.vl_taxa_material_imp,0) + coalesce(p.vl_taxa_servico_imp,0) + coalesce(p.vl_taxa_co_imp,0)) - coalesce(p.vl_glosa,0) vl_pagamento,
		coalesce(p.vl_glosa,0) vl_glosa,
		( 	select 	sum(coalesce(o.vl_coparticipacao,0))
			from	pls_conta_coparticipacao o
			where   p.nr_sequencia = o.nr_seq_conta_proc
			and	c.nr_sequencia  = o.nr_seq_conta
			and	o.ie_status_coparticipacao in ('D','S')
			and o.ie_status_mensalidade <> 'C') vl_coparticipacao,
		0 vl_taxa_pgto,
		e.dt_mes_competencia dt_contabilizacao,
		p.cd_conta_cred_tx_inter_glosa cd_conta_credito,
		p.cd_conta_deb_tx_inter_glosa cd_conta_debito,
		t.nr_contrato nr_contrato,
		(select	max(r.nr_sequencia)
			from	pls_conta_medica_resumo	r
			where	p.nr_sequencia		= r.nr_seq_conta_proc
			and	c.nr_sequencia		= r.nr_seq_conta) nr_seq_resumo,
			CASE WHEN y.ie_tipo_operacao='A' THEN  'SCA'  ELSE coalesce(y.nr_protocolo_ans, y.cd_scpa) END  nr_protocolo_ans,
		s.nr_sequencia	nr_seq_segurado,
		p.nr_seq_grupo_ans nr_seq_grupo_ans,
		e.nr_sequencia nr_seq_protocolo,
		c.nr_seq_fatura nr_seq_fatura,
		null nr_seq_conta_resumo,
		coalesce(coalesce(substr(pls_obter_dados_prestador(c.nr_seq_prestador_exec,'CPF'),1,255),
			substr(pls_obter_dados_prestador(c.nr_seq_prestador_exec,'CGC'),1,255)), 
				CASE WHEN e.ie_tipo_protocolo='I' THEN substr(pls_obter_cnpj_congenere(e.nr_seq_congenere),1,255)  ELSE coalesce(Obter_Cpf_Pessoa_Fisica(c.cd_pessoa_fisica), c.cd_cgc) END ) nr_cpf_cnpj_adic,
		coalesce(s.nr_seq_titular,s.nr_sequencia) nr_seq_titular,
		coalesce(c.nr_seq_prestador_exec,e.nr_seq_congenere) nr_seq_prestador,
		null nr_seq_arquivo,
		k.ie_tipo_grupo_ans,
		e.nr_seq_congenere,
		e.dt_mes_competencia,
		null vl_deferido,
		null cd_abi,
		null nr_aih
	FROM pls_conta c
LEFT OUTER JOIN pls_segurado s ON (c.nr_seq_segurado = s.nr_sequencia)
LEFT OUTER JOIN pls_contrato t ON (s.nr_seq_contrato = t.nr_sequencia)
LEFT OUTER JOIN pls_plano y ON (s.nr_seq_plano = y.nr_sequencia)
, pls_conta_proc p
LEFT OUTER JOIN ans_grupo_despesa k ON (p.nr_seq_grupo_ans = k.nr_sequencia)
, pls_protocolo_conta e
LEFT OUTER JOIN pls_congenere i ON (e.nr_seq_congenere = i.nr_sequencia)
WHERE c.nr_sequencia 		= p.nr_seq_conta and e.nr_sequencia 		= c.nr_seq_protocolo      and ((e.dt_mes_competencia between dt_inicial_p and dt_final_w
	and	((e.ie_tipo_protocolo <> 'R') or ie_forma_contab_reembolso_w = 'L'))
	or	(e.dt_mes_competencia between dt_inicial_p and dt_final_w
	and	((e.ie_tipo_protocolo = 'R') and ie_forma_contab_reembolso_w = 'C'))
	or	(e.dt_mes_competencia between dt_inicial_p and dt_final_w
	and	((e.ie_tipo_protocolo = 'R') and ie_forma_contab_reembolso_w = 'M'))) and (ie_gerar_ind_classif_p <> 'N'
	or	substr(p.cd_classif_tx_glosa_deb,1,5) = '4.1.1') and e.ie_tipo_protocolo = 'I' and c.ie_status <> 'C' and p.ie_status <> 'D' and (c.ie_tipo_segurado = ie_tipo_segurado_p or coalesce(ie_tipo_segurado_p::text, '') = '') and (e.ie_tipo_protocolo = ie_tipo_protocolo_p or coalesce(ie_tipo_protocolo_p::text, '') = '') and qt_regra_reemb_taxa_w > 0
	 
union all

	select 	c.nr_sequencia nr_documento,
		e.ie_tipo_protocolo ie_tipo_protocolo,
		substr(pls_obter_dados_conta_mat(m.nr_sequencia,'O'),1,255) cd_material_ops,
		null cd_procedimento,
		null ie_origem_proced,
		substr(pls_obter_dados_conta_mat(m.nr_sequencia,'D'),1,255) ds_item_mat_proc,
		m.dt_atendimento dt_ocorrencia,
		e.dt_mes_competencia dt_conhecimento,
		(select	max(t.dt_liquidacao)
		FROM pls_conta_medica_resumo r, pls_pagamento_prestador p, pls_lote_pagamento l, pls_pag_prest_vencimento v
LEFT OUTER JOIN titulo_pagar t ON (v.nr_titulo = t.nr_titulo)
WHERE l.nr_sequencia		= r.nr_seq_lote_pgto and l.nr_sequencia		= p.nr_seq_lote and p.nr_sequencia		= v.nr_seq_pag_prestador and p.nr_seq_prestador	= r.nr_seq_prestador_pgto  and r.nr_seq_conta		= c.nr_sequencia and r.nr_seq_conta_mat	= p.nr_sequencia ) dt_liquidacao,
		substr(pls_obter_dados_segurado(s.nr_sequencia,'C'),1,255) cd_beneficiario,
		substr(pls_obter_dados_segurado(s.nr_sequencia,'N'),1,255)  nm_beneficiario,
		substr(pls_obter_dados_segurado(coalesce(s.nr_seq_titular,s.nr_sequencia),'N'),1,255)  nm_usuario_princ,
		c.ie_tipo_segurado ie_tipo_segurado,
		substr(CASE WHEN e.ie_tipo_protocolo='I' THEN pls_obter_nome_congenere(e.nr_seq_congenere)  ELSE obter_nome_pf_pj(c.cd_pessoa_fisica, c.cd_cgc) END ,1,255) nm_prestador,
		substr(pls_obter_dados_segurado(coalesce(s.nr_seq_titular,s.nr_sequencia),'CPF'),1,255) cd_cpf_cgc,
		CASE WHEN e.ie_tipo_protocolo='I' THEN obter_desc_expressao(973290) WHEN e.ie_tipo_protocolo='R' THEN 'Despesas com Reembolso' WHEN e.ie_tipo_protocolo='F' THEN 'Corresponsabilidade Cedida'  ELSE null END  ds_operacao,
		'CM' ie_tipo_documento,
		substr(pls_obter_dados_grupo_ans(m.nr_seq_grupo_ans,'D'),1,255) ds_grupo_ans,
		substr(CASE WHEN coalesce(c.nr_seq_prestador_exec, 0)=0 THEN  			CASE WHEN coalesce(ie_tipo_protocolo_p,e.ie_tipo_protocolo)='I' THEN obter_desc_expressao(822559) WHEN coalesce(ie_tipo_protocolo_p,e.ie_tipo_protocolo)='F' THEN 'Corresponsabilidade Cedida' WHEN coalesce(ie_tipo_protocolo_p,e.ie_tipo_protocolo)='R' THEN  'Reembolso'  ELSE null END   ELSE pls_obter_dados_prestador(c.nr_seq_prestador_exec, 'TR') END , 1,255) ds_tipo_vinculo_operadora,
		m.ie_ato_cooperado ie_ato_cooperado,
		y.ie_preco ie_modalidade_contrat,	
		y.ie_regulamentacao ie_regulamentacao,
		y.ie_tipo_contratacao ie_tipo_contratacao,
		y.ie_segmentacao ie_segmentacao,
		coalesce(m.vl_material_imp,0) - coalesce(m.vl_taxa_material_imp,0) vl_evento,
		0 vl_ajuste,
		coalesce(m.vl_material_imp,0) - coalesce(m.vl_taxa_material_imp,0) - coalesce(m.vl_glosa,0) vl_pagamento,
		coalesce(m.vl_glosa,0) vl_glosa,
		( 	select 	coalesce(sum(o.vl_coparticipacao),0)
			from	pls_conta_coparticipacao o
			where   m.nr_sequencia = o.nr_seq_conta_mat
			and	c.nr_sequencia  = o.nr_seq_conta 
			and	o.ie_status_coparticipacao	in ('D','S')
			and o.ie_status_mensalidade <> 'C') vl_coparticipacao,
		0 vl_taxa_pgto,
		e.dt_mes_competencia dt_contabilizacao,
		m.cd_conta_cred_tx_inter_glosa cd_conta_credito,
		m.cd_conta_deb_tx_inter_glosa cd_conta_debito,
		t.nr_contrato nr_contrato,
		(select	max(r.nr_sequencia)
		from	pls_conta_medica_resumo	r
		where	m.nr_sequencia		= r.nr_seq_conta_mat
		and	c.nr_sequencia		= r.nr_seq_conta) nr_seq_resumo,
		CASE WHEN y.ie_tipo_operacao='A' THEN  'SCA'  ELSE coalesce(y.nr_protocolo_ans, y.cd_scpa) END  nr_protocolo_ans,
		s.nr_sequencia	nr_seq_segurado,
		m.nr_seq_grupo_ans nr_seq_grupo_ans,
		e.nr_sequencia nr_seq_protocolo,
		c.nr_seq_fatura nr_seq_fatura,
		null nr_seq_conta_resumo,
		coalesce(coalesce(substr(pls_obter_dados_prestador(c.nr_seq_prestador_exec,'CPF'),1,255),
			substr(pls_obter_dados_prestador(c.nr_seq_prestador_exec,'CGC'),1,255)), 
				CASE WHEN e.ie_tipo_protocolo='I' THEN substr(pls_obter_cnpj_congenere(e.nr_seq_congenere),1,255)  ELSE coalesce(Obter_Cpf_Pessoa_Fisica(c.cd_pessoa_fisica), c.cd_cgc) END ) nr_cpf_cnpj_adic,
		coalesce(s.nr_seq_titular,s.nr_sequencia) nr_seq_titular,
		coalesce(c.nr_seq_prestador_exec,e.nr_seq_congenere) nr_seq_prestador,
		null nr_seq_arquivo,
		k.ie_tipo_grupo_ans,
		e.nr_seq_congenere,
		e.dt_mes_competencia,
		null vl_deferido,
		null cd_abi,
		null nr_aih
	FROM pls_conta c
LEFT OUTER JOIN pls_segurado s ON (c.nr_seq_segurado = s.nr_sequencia)
LEFT OUTER JOIN pls_contrato t ON (s.nr_seq_contrato = t.nr_sequencia)
LEFT OUTER JOIN pls_plano y ON (s.nr_seq_plano = y.nr_sequencia)
, pls_conta_mat m
LEFT OUTER JOIN ans_grupo_despesa k ON (m.nr_seq_grupo_ans = k.nr_sequencia)
, pls_protocolo_conta e
LEFT OUTER JOIN pls_congenere i ON (e.nr_seq_congenere = i.nr_sequencia)
WHERE c.nr_sequencia 		= m.nr_seq_conta and e.nr_sequencia 		= c.nr_seq_protocolo      and ((e.dt_mes_competencia between dt_inicial_p and dt_final_w
	and	((e.ie_tipo_protocolo <> 'R') or ie_forma_contab_reembolso_w = 'C'))
	or	(e.dt_mes_competencia between dt_inicial_p and dt_final_w
	and	((e.ie_tipo_protocolo = 'R') and ie_forma_contab_reembolso_w = 'L'))
	or	(e.dt_mes_competencia between dt_inicial_p and dt_final_w
	and	((e.ie_tipo_protocolo = 'R') and ie_forma_contab_reembolso_w = 'M'))) and (ie_gerar_ind_classif_p <> 'N'
	or	substr(m.cd_classif_tx_glosa_deb,1,5) = '4.1.1') and e.ie_tipo_protocolo = 'I' and c.ie_status <> 'C' and m.ie_status <> 'D' and (c.ie_tipo_segurado = ie_tipo_segurado_p or coalesce(ie_tipo_segurado_p::text, '') = '') and (e.ie_tipo_protocolo = ie_tipo_protocolo_p or coalesce(ie_tipo_protocolo_p::text, '') = '') and qt_regra_reemb_taxa_w > 0
	 
union all
	
	select 	c.nr_sequencia nr_documento,
		e.ie_tipo_protocolo ie_tipo_protocolo,
		null cd_material_ops,
		p.cd_procedimento cd_procedimento,
		p.ie_origem_proced ie_origem_proced,
		substr(obter_descricao_procedimento(p.cd_procedimento,p.ie_origem_proced),1,255) ds_item_mat_proc,
		p.dt_procedimento dt_ocorrencia,
		e.dt_mes_competencia dt_conhecimento,
		(select	max(t.dt_liquidacao)
			FROM pls_conta_medica_resumo r, pls_pagamento_prestador p, pls_lote_pagamento l, pls_pag_prest_vencimento v
LEFT OUTER JOIN titulo_pagar t ON (v.nr_titulo = t.nr_titulo)
WHERE l.nr_sequencia		= r.nr_seq_lote_pgto and l.nr_sequencia		= p.nr_seq_lote and p.nr_sequencia		= v.nr_seq_pag_prestador and p.nr_seq_prestador	= r.nr_seq_prestador_pgto  and r.nr_seq_conta		= c.nr_sequencia and r.nr_seq_conta_proc	= p.nr_sequencia ) dt_liquidacao,
		substr(pls_obter_dados_segurado(s.nr_sequencia,'C'),1,255) cd_beneficiario,
		substr(pls_obter_dados_segurado(s.nr_sequencia,'N'),1,255)  nm_beneficiario,
		substr(pls_obter_dados_segurado(coalesce(s.nr_seq_titular,s.nr_sequencia),'N'),1,255)  nm_usuario_princ,
		c.ie_tipo_segurado ie_tipo_segurado,
		substr(CASE WHEN e.ie_tipo_protocolo='I' THEN pls_obter_nome_congenere(e.nr_seq_congenere)  ELSE obter_nome_pf_pj(c.cd_pessoa_fisica, c.cd_cgc) END ,1,255) nm_prestador,		
		substr(pls_obter_dados_segurado(coalesce(s.nr_seq_titular,s.nr_sequencia),'CPF'),1,255) cd_cpf_cgc,
		CASE WHEN e.ie_tipo_protocolo='I' THEN obter_desc_expressao(973290) WHEN e.ie_tipo_protocolo='R' THEN 'Despesas com Reembolso' WHEN e.ie_tipo_protocolo='F' THEN 'Corresponsabilidade Cedida'  ELSE '' END  ds_operacao,
		'CM' ie_tipo_documento,
		substr(pls_obter_dados_grupo_ans(p.nr_seq_grupo_ans,'D'),1,255) ds_grupo_ans,
		substr(CASE WHEN coalesce(c.nr_seq_prestador_exec, 0)=0 THEN  			CASE WHEN coalesce(ie_tipo_protocolo_p,e.ie_tipo_protocolo)='I' THEN obter_desc_expressao(822559) WHEN coalesce(ie_tipo_protocolo_p,e.ie_tipo_protocolo)='F' THEN 'Corresponsabilidade Cedida' WHEN coalesce(ie_tipo_protocolo_p,e.ie_tipo_protocolo)='R' THEN  'Reembolso'  ELSE '' END   ELSE pls_obter_dados_prestador(c.nr_seq_prestador_exec, 'TR') END , 1,255) ds_tipo_vinculo_operadora,
		p.ie_ato_cooperado ie_ato_cooperado,
		y.ie_preco ie_modalidade_contrat,	
		y.ie_regulamentacao ie_regulamentacao,
		y.ie_tipo_contratacao ie_tipo_contratacao,
		y.ie_segmentacao ie_segmentacao,
		coalesce(p.vl_taxa_material_imp,0) + coalesce(p.vl_taxa_servico_imp,0) + coalesce(p.vl_taxa_co_imp,0) vl_evento,
		0 vl_ajuste,
		coalesce(p.vl_taxa_material_imp,0) + coalesce(p.vl_taxa_servico_imp,0) + coalesce(p.vl_taxa_co_imp,0) vl_pagamento,
		0 vl_glosa,
		0 vl_coparticipacao,
		0 vl_taxa_pgto,
		e.dt_mes_competencia dt_contabilizacao,
		p.cd_conta_cred_tx_inter cd_conta_credito,
		p.cd_conta_deb_tx_inter cd_conta_debito,
		t.nr_contrato nr_contrato,
		(select	max(r.nr_sequencia)
			from	pls_conta_medica_resumo	r
			where	p.nr_sequencia		= r.nr_seq_conta_proc
			and	c.nr_sequencia		= r.nr_seq_conta) nr_seq_resumo,
			CASE WHEN y.ie_tipo_operacao='A' THEN  'SCA'  ELSE coalesce(y.nr_protocolo_ans, y.cd_scpa) END  nr_protocolo_ans,
		s.nr_sequencia	nr_seq_segurado,
		p.nr_seq_grupo_ans nr_seq_grupo_ans,
		e.nr_sequencia nr_seq_protocolo,
		c.nr_seq_fatura nr_seq_fatura,
		null nr_seq_conta_resumo,
		coalesce(coalesce(substr(pls_obter_dados_prestador(c.nr_seq_prestador_exec,'CPF'),1,255),
			substr(pls_obter_dados_prestador(c.nr_seq_prestador_exec,'CGC'),1,255)), 
				CASE WHEN e.ie_tipo_protocolo='I' THEN substr(pls_obter_cnpj_congenere(e.nr_seq_congenere),1,255)  ELSE coalesce(Obter_Cpf_Pessoa_Fisica(c.cd_pessoa_fisica), c.cd_cgc) END ) nr_cpf_cnpj_adic,
		coalesce(s.nr_seq_titular,s.nr_sequencia) nr_seq_titular,
		coalesce(c.nr_seq_prestador_exec,e.nr_seq_congenere) nr_seq_prestador,
		null nr_seq_arquivo,
		k.ie_tipo_grupo_ans,
		e.nr_seq_congenere,
		e.dt_mes_competencia,
		null vl_deferido,
		null cd_abi,
		null nr_aih
	FROM pls_conta c
LEFT OUTER JOIN pls_segurado s ON (c.nr_seq_segurado = s.nr_sequencia)
LEFT OUTER JOIN pls_contrato t ON (s.nr_seq_contrato = t.nr_sequencia)
LEFT OUTER JOIN pls_plano y ON (s.nr_seq_plano = y.nr_sequencia)
, pls_conta_proc p
LEFT OUTER JOIN ans_grupo_despesa k ON (p.nr_seq_grupo_ans = k.nr_sequencia)
, pls_protocolo_conta e
LEFT OUTER JOIN pls_congenere i ON (e.nr_seq_congenere = i.nr_sequencia)
WHERE c.nr_sequencia 		= p.nr_seq_conta and e.nr_sequencia 		= c.nr_seq_protocolo      and ((e.dt_mes_competencia between dt_inicial_p and dt_final_w
	and	((e.ie_tipo_protocolo <> 'R') or ie_forma_contab_reembolso_w = 'L'))
	or	(e.dt_mes_competencia between dt_inicial_p and dt_final_w
	and	((e.ie_tipo_protocolo = 'R') and ie_forma_contab_reembolso_w = 'C'))
	or	(e.dt_mes_competencia between dt_inicial_p and dt_final_w
	and	((e.ie_tipo_protocolo = 'R') and ie_forma_contab_reembolso_w = 'M'))) and (ie_gerar_ind_classif_p <> 'N'
	or	substr(p.cd_classif_tx_inter_deb,1,5) = '4.1.1') and e.ie_tipo_protocolo = 'I' and c.ie_status <> 'C' and p.ie_status <> 'D' and (c.ie_tipo_segurado = ie_tipo_segurado_p or coalesce(ie_tipo_segurado_p::text, '') = '') and (e.ie_tipo_protocolo = ie_tipo_protocolo_p or coalesce(ie_tipo_protocolo_p::text, '') = '') and qt_regra_reemb_taxa_w > 0
	 
union all

	select 	c.nr_sequencia nr_documento,
		e.ie_tipo_protocolo ie_tipo_protocolo,
		substr(pls_obter_dados_conta_mat(m.nr_sequencia,'O'),1,255) cd_material_ops,
		null cd_procedimento,
		null ie_origem_proced,
		substr(pls_obter_dados_conta_mat(m.nr_sequencia,'D'),1,255) ds_item_mat_proc,
		m.dt_atendimento dt_ocorrencia,
		e.dt_mes_competencia dt_conhecimento,
		(select	max(t.dt_liquidacao)
		FROM pls_conta_medica_resumo r, pls_pagamento_prestador p, pls_lote_pagamento l, pls_pag_prest_vencimento v
LEFT OUTER JOIN titulo_pagar t ON (v.nr_titulo = t.nr_titulo)
WHERE l.nr_sequencia		= r.nr_seq_lote_pgto and l.nr_sequencia		= p.nr_seq_lote and p.nr_sequencia		= v.nr_seq_pag_prestador and p.nr_seq_prestador	= r.nr_seq_prestador_pgto  and r.nr_seq_conta		= c.nr_sequencia and r.nr_seq_conta_mat	= p.nr_sequencia ) dt_liquidacao,
		substr(pls_obter_dados_segurado(s.nr_sequencia,'C'),1,255) cd_beneficiario,
		substr(pls_obter_dados_segurado(s.nr_sequencia,'N'),1,255)  nm_beneficiario,
		substr(pls_obter_dados_segurado(coalesce(s.nr_seq_titular,s.nr_sequencia),'N'),1,255)  nm_usuario_princ,
		c.ie_tipo_segurado ie_tipo_segurado,
		substr(CASE WHEN e.ie_tipo_protocolo='I' THEN pls_obter_nome_congenere(e.nr_seq_congenere)  ELSE obter_nome_pf_pj(c.cd_pessoa_fisica, c.cd_cgc) END ,1,255) nm_prestador,
		substr(pls_obter_dados_segurado(coalesce(s.nr_seq_titular,s.nr_sequencia),'CPF'),1,255) cd_cpf_cgc,
		CASE WHEN e.ie_tipo_protocolo='I' THEN obter_desc_expressao(973290) WHEN e.ie_tipo_protocolo='R' THEN 'Despesas com Reembolso' WHEN e.ie_tipo_protocolo='F' THEN 'Corresponsabilidade Cedida'  ELSE '' END  ds_operacao,
		'CM' ie_tipo_documento,
		substr(pls_obter_dados_grupo_ans(m.nr_seq_grupo_ans,'D'),1,255) ds_grupo_ans,
		substr(CASE WHEN coalesce(c.nr_seq_prestador_exec, 0)=0 THEN  			CASE WHEN coalesce(ie_tipo_protocolo_p,e.ie_tipo_protocolo)='I' THEN obter_desc_expressao(822559) WHEN coalesce(ie_tipo_protocolo_p,e.ie_tipo_protocolo)='F' THEN 'Corresponsabilidade Cedida' WHEN coalesce(ie_tipo_protocolo_p,e.ie_tipo_protocolo)='R' THEN  'Reembolso'  ELSE '' END   ELSE pls_obter_dados_prestador(c.nr_seq_prestador_exec, 'TR') END , 1,255) ds_tipo_vinculo_operadora,
		m.ie_ato_cooperado ie_ato_cooperado,
		y.ie_preco ie_modalidade_contrat,	
		y.ie_regulamentacao ie_regulamentacao,
		y.ie_tipo_contratacao ie_tipo_contratacao,
		y.ie_segmentacao ie_segmentacao,
		m.vl_taxa_material_imp vl_evento,
		0 vl_ajuste,
		m.vl_taxa_material_imp vl_pagamento,
		0 vl_glosa,
		0 vl_coparticipacao,
		0 vl_taxa_pgto,
		e.dt_mes_competencia dt_contabilizacao,
		m.cd_conta_cred_tx_inter cd_conta_credito,
		m.cd_conta_deb_tx_inter cd_conta_debito,
		t.nr_contrato nr_contrato,
		(select	max(r.nr_sequencia)
		from	pls_conta_medica_resumo	r
		where	m.nr_sequencia		= r.nr_seq_conta_mat
		and	c.nr_sequencia		= r.nr_seq_conta) nr_seq_resumo,
		CASE WHEN y.ie_tipo_operacao='A' THEN  'SCA'  ELSE coalesce(y.nr_protocolo_ans, y.cd_scpa) END  nr_protocolo_ans,
		s.nr_sequencia	nr_seq_segurado,
		m.nr_seq_grupo_ans nr_seq_grupo_ans,
		e.nr_sequencia nr_seq_protocolo,
		c.nr_seq_fatura nr_seq_fatura,
		null nr_seq_conta_resumo,
		coalesce(coalesce(substr(pls_obter_dados_prestador(c.nr_seq_prestador_exec,'CPF'),1,255),
			substr(pls_obter_dados_prestador(c.nr_seq_prestador_exec,'CGC'),1,255)), 
				CASE WHEN e.ie_tipo_protocolo='I' THEN substr(pls_obter_cnpj_congenere(e.nr_seq_congenere),1,255)  ELSE coalesce(Obter_Cpf_Pessoa_Fisica(c.cd_pessoa_fisica), c.cd_cgc) END ) nr_cpf_cnpj_adic,
		coalesce(s.nr_seq_titular,s.nr_sequencia) nr_seq_titular,
		coalesce(c.nr_seq_prestador_exec,e.nr_seq_congenere) nr_seq_prestador,
		null nr_seq_arquivo,
		k.ie_tipo_grupo_ans,
		e.nr_seq_congenere,
		e.dt_mes_competencia,
		null vl_deferido,
		null cd_abi,
		null nr_aih
	FROM pls_conta c
LEFT OUTER JOIN pls_segurado s ON (c.nr_seq_segurado = s.nr_sequencia)
LEFT OUTER JOIN pls_contrato t ON (s.nr_seq_contrato = t.nr_sequencia)
LEFT OUTER JOIN pls_plano y ON (s.nr_seq_plano = y.nr_sequencia)
, pls_conta_mat m
LEFT OUTER JOIN ans_grupo_despesa k ON (m.nr_seq_grupo_ans = k.nr_sequencia)
, pls_protocolo_conta e
LEFT OUTER JOIN pls_congenere i ON (e.nr_seq_congenere = i.nr_sequencia)
WHERE c.nr_sequencia 		= m.nr_seq_conta and e.nr_sequencia 		= c.nr_seq_protocolo      and ((e.dt_mes_competencia between dt_inicial_p and dt_final_w
	and	((e.ie_tipo_protocolo <> 'R') or ie_forma_contab_reembolso_w = 'C'))
	or	(e.dt_mes_competencia between dt_inicial_p and dt_final_w
	and	((e.ie_tipo_protocolo = 'R') and ie_forma_contab_reembolso_w = 'L'))
	or	(e.dt_mes_competencia between dt_inicial_p and dt_final_w
	and	((e.ie_tipo_protocolo = 'R') and ie_forma_contab_reembolso_w = 'M'))) and (ie_gerar_ind_classif_p <> 'N'
	or	substr(m.cd_classif_tx_inter_deb,1,5) = '4.1.1') and e.ie_tipo_protocolo = 'I' and c.ie_status <> 'C' and m.ie_status <> 'D' and (c.ie_tipo_segurado = ie_tipo_segurado_p or coalesce(ie_tipo_segurado_p::text, '') = '') and (e.ie_tipo_protocolo = ie_tipo_protocolo_p or coalesce(ie_tipo_protocolo_p::text, '') = '') and qt_regra_reemb_taxa_w > 0
	 
union all

	select	c.nr_sequencia nr_documento,
		p.ie_tipo_protocolo,
		x.cd_material_ops,
		x.cd_procedimento,
		x.ie_origem_proced,
		x.ds_item_mat_proc,
		x.dt_ocorrencia,
		l.dt_referencia_inicio dt_conhecimento,
		null dt_liquidacao,
		substr(pls_obter_dados_segurado(s.nr_sequencia,'C'),1,255) cd_beneficiario,
		substr(pls_obter_dados_segurado(s.nr_sequencia,'N'),1,255) nm_beneficiario,
		substr(pls_obter_dados_segurado(coalesce(s.nr_seq_titular,s.nr_sequencia),'N'),1,255)  nm_usuario_princ,
		c.ie_tipo_segurado ie_tipo_segurado,
		substr(pls_obter_dados_prestador(CASE WHEN ie_prestador_codificacao_w='E' THEN c.nr_seq_prestador_exec WHEN ie_prestador_codificacao_w='S' THEN c.nr_seq_prestador  ELSE p.nr_seq_prestador END ,'N'),1,255) nm_prestador,
		substr(pls_obter_dados_segurado(coalesce(s.nr_seq_titular,s.nr_sequencia),'CPF'),1,255) cd_cpf_cgc,
		ds_operacao_w ds_operacao,
		'CM' ie_tipo_documento,
		x.ds_grupo_ans,
		substr(pls_obter_dados_prestador(CASE WHEN ie_prestador_codificacao_w='E' THEN c.nr_seq_prestador_exec WHEN ie_prestador_codificacao_w='S' THEN c.nr_seq_prestador  ELSE p.nr_seq_prestador END ,'TR'),1,255) ds_tipo_vinculo_operadora,
		x.ie_ato_cooperado,
		y.ie_preco ie_modalidade_contrat,
		y.ie_regulamentacao ie_regulamentacao,
		y.ie_tipo_contratacao ie_tipo_contratacao,
		y.ie_segmentacao ie_segmentacao,
		x.vl_evento,
		0 vl_ajuste,
		0 vl_pagamento,
		0 vl_glosa,
		0 vl_coparticipacao,
		0 vl_taxa_pgto,
		l.dt_referencia_inicio dt_contabilizacao,
		x.cd_conta_credito,
		x.cd_conta_debito,
		t.nr_contrato nr_contrato,
		null nr_seq_resumo,
		CASE WHEN y.ie_tipo_operacao='A' THEN  'SCA'  ELSE coalesce(y.nr_protocolo_ans, y.cd_scpa) END  nr_protocolo_ans,
		s.nr_sequencia	nr_seq_segurado,
		x.nr_seq_grupo_ans,
		p.nr_sequencia nr_seq_protocolo,
		c.nr_seq_fatura nr_seq_fatura,
		null nr_seq_conta_resumo,
		coalesce(coalesce(substr(pls_obter_dados_prestador(CASE WHEN ie_prestador_codificacao_w='E' THEN c.nr_seq_prestador_exec WHEN ie_prestador_codificacao_w='S' THEN c.nr_seq_prestador  ELSE p.nr_seq_prestador END ,'CPF'),1,255),
			substr(pls_obter_dados_prestador(CASE WHEN ie_prestador_codificacao_w='E' THEN c.nr_seq_prestador_exec WHEN ie_prestador_codificacao_w='S' THEN c.nr_seq_prestador  ELSE p.nr_seq_prestador END ,'CGC'),1,255)), 
				CASE WHEN p.ie_tipo_protocolo='I' THEN substr(pls_obter_cnpj_congenere(p.nr_seq_congenere),1,255)  ELSE coalesce(obter_cpf_pessoa_fisica(c.cd_pessoa_fisica), c.cd_cgc) END ) nr_cpf_cnpj_adic,
		coalesce(s.nr_seq_titular,s.nr_sequencia) nr_seq_titular,
		CASE WHEN ie_prestador_codificacao_w='E' THEN c.nr_seq_prestador_exec WHEN ie_prestador_codificacao_w='S' THEN c.nr_seq_prestador  ELSE p.nr_seq_prestador END  nr_seq_prestador,
		a.nr_sequencia nr_seq_arquivo,
		x.ie_tipo_grupo_ans,
		p.nr_seq_congenere,
		p.dt_mes_competencia,
		null vl_deferido,
		null cd_abi,
		null nr_aih
	FROM (select	'P' ie_proc_mat,
			cp.cd_procedimento,
			cp.ie_origem_proced,
			substr(obter_descricao_procedimento(cp.cd_procedimento,cp.ie_origem_proced),1,255) ds_item_mat_proc,
			null cd_material_ops,
			cp.dt_procedimento dt_ocorrencia,
			cp.nr_seq_grupo_ans,
			substr(pls_obter_dados_grupo_ans(cp.nr_seq_grupo_ans,'D'),1,255) ds_grupo_ans,
			cp.ie_ato_cooperado,
			coalesce(i.vl_total, 0) vl_evento,
			i.cd_conta_debito,
			i.cd_conta_credito,
			b.nr_seq_aviso_conta,
			k.ie_tipo_grupo_ans
		FROM ptu_aviso_proc_item i, ptu_aviso_procedimento b, pls_conta_proc cp
LEFT OUTER JOIN ans_grupo_despesa k ON (cp.nr_seq_grupo_ans = k.nr_sequencia)
WHERE b.nr_sequencia		= i.nr_seq_aviso_procedimento and cp.nr_sequencia  	= b.nr_seq_conta_proc  and cp.ie_status		<> 'D' and (ie_gerar_ind_classif_p	<> 'N'
		or	substr(i.cd_classif_debito,1,5) = '4.1.1')
		 
union all

		select	'M' ie_proc_mat,
			null cd_procedimento,
			null ie_origem_proced,
			substr(pls_obter_dados_conta_mat(cm.nr_sequencia,'D'),1,255) ds_item_mat_proc,
			substr(pls_obter_dados_conta_mat(cm.nr_sequencia,'O'),1,255) cd_material_ops,
			cm.dt_atendimento dt_ocorrencia,
			cm.nr_seq_grupo_ans,
			substr(pls_obter_dados_grupo_ans(cm.nr_seq_grupo_ans,'D'),1,255) ds_grupo_ans,
			cm.ie_ato_cooperado,
			coalesce(i.vl_total, 0) vl_evento,
			i.cd_conta_debito,
			i.cd_conta_credito,
			b.nr_seq_aviso_conta,
			k.ie_tipo_grupo_ans
		FROM ptu_aviso_mat_item i, ptu_aviso_material b, pls_conta_mat cm
LEFT OUTER JOIN ans_grupo_despesa k ON (cm.nr_seq_grupo_ans = k.nr_sequencia)
WHERE b.nr_sequencia		= i.nr_seq_aviso_material and cm.nr_sequencia		= b.nr_seq_conta_mat  and cm.ie_status		<> 'D' and (ie_gerar_ind_classif_p	<> 'N'
		or	substr(i.cd_classif_debito,1,5) = '4.1.1') ) x, pls_protocolo_conta p, ptu_lote_aviso l, ptu_aviso_protocolo ap, ptu_aviso_conta ac, ptu_aviso_arquivo a, pls_conta c
LEFT OUTER JOIN pls_segurado s ON (c.nr_seq_segurado = s.nr_sequencia)
LEFT OUTER JOIN pls_contrato t ON (s.nr_seq_contrato = t.nr_sequencia)
LEFT OUTER JOIN pls_plano y ON (s.nr_seq_plano = y.nr_sequencia)
WHERE l.nr_sequencia		= a.nr_seq_lote and a.nr_sequencia		= ap.nr_seq_arquivo and ap.nr_sequencia		= ac.nr_seq_aviso_protocolo and ac.nr_sequencia		= x.nr_seq_aviso_conta and p.nr_sequencia		= ap.nr_seq_protocolo and c.nr_sequencia		= ac.nr_seq_conta    and l.dt_referencia_inicio between dt_inicial_p and dt_final_w and c.ie_status <> 'C' and (c.ie_tipo_segurado = ie_tipo_segurado_p or coalesce(ie_tipo_segurado_p::text, '') = '') and (p.ie_tipo_protocolo = ie_tipo_protocolo_p or coalesce(ie_tipo_protocolo_p::text, '') = '')
	 
union all

	select	null nr_documento,
		null ie_tipo_protocolo,
		null cd_material_ops,
		null cd_procedimento,
		null ie_origem_proced,
		null ds_item_mat_proc,
		null dt_ocorrencia,
		l.dt_importacao dt_conhecimento,
		null dt_liquidacao,
		null cd_beneficiario,
		null nm_beneficiario,
		null nm_usuario_princ,
		null ie_tipo_segurado,
		null nm_prestador,
		null cd_cpf_cgc,
		ds_operacao_w ds_operacao,
		'CM' ie_tipo_documento,
		null ds_grupo_ans,
		null ds_tipo_vinculo_operadora,
		null ie_ato_cooperado,
		null ie_modalidade_contrat,
		null ie_regulamentacao,
		null ie_tipo_contratacao,
		null ie_segmentacao,
		x.vl_evento,
		0 vl_ajuste,
		0 vl_pagamento,
		x.vl_glosa,
		0 vl_coparticipacao,
		0 vl_taxa_pgto,
		l.dt_importacao dt_contabilizacao,
		x.cd_conta_credito,
		x.cd_conta_debito,
		null nr_contrato,
		null nr_seq_resumo,
		null nr_protocolo_ans,
		null nr_seq_segurado,
		null nr_seq_grupo_ans,
		null nr_seq_protocolo,
		null nr_seq_fatura,
		null nr_seq_conta_resumo,
		null nr_cpf_cnpj_adic,
		null nr_seq_titular,
		null nr_seq_prestador,
		a.nr_sequencia nr_seq_arquivo,
		null ie_tipo_grupo_ans,
		null nr_seq_congenere,
		null dt_mes_competencia,
		null vl_deferido,
		null cd_abi,
		null nr_aih
	from (select	'P' ie_proc_mat,
			coalesce(b.vl_total, 0) vl_evento,
			0 vl_glosa,
			b.cd_conta_debito,
			b.cd_conta_credito,
			b.nr_seq_aviso_conta
		from	ptu_aviso_procedimento	b
		where (ie_gerar_ind_classif_p	<> 'N'
		or	substr(b.cd_classif_debito,1,5) = '4.1.1')
		
union all

		select	'M' ie_proc_mat,
			coalesce(b.vl_total, 0) vl_evento,
			0 vl_glosa,
			b.cd_conta_debito,
			b.cd_conta_credito,
			b.nr_seq_aviso_conta
		from	ptu_aviso_material	b
		where (ie_gerar_ind_classif_p	<> 'N'
		or	substr(b.cd_classif_debito,1,5) = '4.1.1')) x,
		ptu_lote_aviso		l,
		ptu_aviso_arquivo	a,
		ptu_aviso_protocolo	ap,
		ptu_aviso_conta		ac
	where	l.nr_sequencia		= a.nr_seq_lote
	and	a.nr_sequencia		= ap.nr_seq_arquivo
	and	ap.nr_sequencia		= ac.nr_seq_aviso_protocolo
	and	ac.nr_sequencia		= x.nr_seq_aviso_conta
	and	l.dt_importacao between dt_inicial_p and dt_final_w
	
union all

	select	b.nr_sequencia nr_documento,
		a.ie_tipo_protocolo ie_tipo_protocolo,
		null cd_material_ops,
		c.cd_procedimento cd_procedimento,
		c.ie_origem_proced ie_origem_proced,
		substr(obter_descricao_procedimento(c.cd_procedimento,c.ie_origem_proced),1,255) ds_item_mat_proc,
		c.dt_procedimento dt_ocorrencia,
		i.dt_mes_competencia dt_conhecimento,
		(	select	max(t.dt_liquidacao)
			from	pls_pag_prest_vencimento w,
				pls_pagamento_prestador z,
				titulo_pagar t
			where	z.nr_sequencia		= w.nr_seq_pag_prestador
			and	w.nr_titulo		= t.nr_titulo
			and	z.nr_seq_lote		= e.nr_seq_lote_pgto
			and	z.nr_seq_prestador	= e.nr_seq_prestador_pgto) dt_liquidacao,
		substr(pls_obter_dados_segurado(s.nr_sequencia,'C'),1,255) cd_beneficiario,
		substr(pls_obter_dados_segurado(s.nr_sequencia,'N'),1,255) nm_beneficiario,
		substr(pls_obter_dados_segurado(coalesce(s.nr_seq_titular,s.nr_sequencia),'N'),1,255) nm_usuario_princ,
		b.ie_tipo_segurado ie_tipo_segurado,
		substr(pls_obter_dados_prestador(b.nr_seq_prestador_exec,'N'),1,255) nm_prestador,
		substr(pls_obter_dados_segurado(coalesce(s.nr_seq_titular,s.nr_sequencia),'CPF'),1,255) nr_cpf_cnpj,
		'Despesas com Eventos / Sinistros' ds_operacao,
		'CM' ie_tipo_documento,
		substr(pls_obter_dados_grupo_ans(c.nr_seq_grupo_ans,'D'),1,255) ds_grupo_ans,
		substr(pls_obter_dados_prestador(b.nr_seq_prestador_exec,'TR'),1,255) ds_tipo_vinculo_operadora,
		c.ie_ato_cooperado ie_ato_cooperado,
		y.ie_preco ie_modalidade_contrat,
		y.ie_regulamentacao ie_regulamentacao,
		y.ie_tipo_contratacao ie_tipo_contratacao,
		y.ie_segmentacao ie_segmentacao,
		e.vl_liberado vl_evento,
		null vl_ajuste,
		e.vl_liberado vl_pagamento,
		null vl_glosa,
		null vl_coparticipacao,
		null vl_taxa_pgto,
		trunc(i.dt_mes_competencia) dt_contabilizacao,
		e.cd_conta_cred_pag cd_conta_credito,
		e.cd_conta_deb_pag cd_conta_debito,
		t.nr_contrato nr_contrato,
		null nr_seq_resumo,
		CASE WHEN y.ie_tipo_operacao='A' THEN  'SCA'  ELSE coalesce(y.nr_protocolo_ans, y.cd_scpa) END  nr_protocolo_ans,
		s.nr_sequencia	nr_seq_segurado,
		c.nr_seq_grupo_ans nr_seq_grupo_ans,
		a.nr_sequencia nr_seq_protocolo,
		null nr_seq_fatura,
		null nr_seq_conta_resumo,
		coalesce(substr(pls_obter_dados_prestador(b.nr_seq_prestador_exec,'CPF'),1,255), substr(pls_obter_dados_prestador(b.nr_seq_prestador_exec,'CGC'),1,255)) nr_cpf_cnpj_adic,
		coalesce(s.nr_seq_titular,s.nr_sequencia) nr_seq_titular,
		b.nr_seq_prestador_exec nr_seq_prestador,
		null nr_seq_arquivo,
		k.ie_tipo_grupo_ans ie_tipo_grupo_ans,
		null nr_seq_congenere,
		null dt_mes_competencia,
		null vl_deferido,
		null cd_abi,
		null nr_aih
	FROM pls_lote_pagamento i, pls_rec_glosa_protocolo g, pls_rec_glosa_conta f, pls_conta_rec_resumo_item e, pls_rec_glosa_proc d, pls_protocolo_conta a, pls_conta b
LEFT OUTER JOIN pls_segurado s ON (b.nr_seq_segurado = s.nr_sequencia)
LEFT OUTER JOIN pls_plano y ON (b.nr_seq_plano = y.nr_sequencia)
LEFT OUTER JOIN pls_contrato t ON (s.nr_seq_contrato = t.nr_sequencia)
, pls_conta_proc c
LEFT OUTER JOIN ans_grupo_despesa k ON (c.nr_seq_grupo_ans = k.nr_sequencia)
WHERE a.nr_sequencia			= b.nr_seq_protocolo and b.nr_sequencia			= c.nr_seq_conta and c.nr_sequencia			= d.nr_seq_conta_proc and d.nr_sequencia			= e.nr_seq_proc_rec and f.nr_sequencia			= e.nr_seq_conta_rec and g.nr_sequencia			= f.nr_seq_protocolo     and e.nr_seq_lote_pgto		= i.nr_sequencia and i.dt_mes_competencia between dt_inicial_w and dt_final_w and coalesce(coalesce(cd_conta_cred_apres,cd_conta_deb_apres),0) = 0 and (ie_gerar_ind_classif_p <> 'N'
	or	substr(e.cd_classif_deb_pag,1,5) = '4.1.1') and a.ie_tipo_protocolo = 'C' and (b.ie_tipo_segurado = ie_tipo_segurado_p or coalesce(ie_tipo_segurado_p::text, '') = '') and (a.ie_tipo_protocolo = ie_tipo_protocolo_p or coalesce(ie_tipo_protocolo_p::text, '') = '')
	 
union all

	select	b.nr_sequencia nr_documento,
		a.ie_tipo_protocolo ie_tipo_protocolo,
		substr(pls_obter_dados_conta_mat(c.nr_sequencia,'O'),1,14) cd_material_ops,
		null cd_procedimento,
		null ie_origem_proced,
		substr(pls_obter_dados_conta_mat(c.nr_sequencia,'D'),1,14) ds_item_mat_proc,
		c.dt_atendimento dt_ocorrencia,
		i.dt_mes_competencia dt_conhecimento,
		(	select	max(t.dt_liquidacao)
			from	pls_pag_prest_vencimento w,
				pls_pagamento_prestador z,
				titulo_pagar t
			where	z.nr_sequencia		= w.nr_seq_pag_prestador
			and	w.nr_titulo		= t.nr_titulo
			and	z.nr_seq_lote		= e.nr_seq_lote_pgto
			and	z.nr_seq_prestador	= e.nr_seq_prestador_pgto) dt_liquidacao,
		substr(pls_obter_dados_segurado(s.nr_sequencia,'C'),1,255) cd_beneficiario,
		substr(pls_obter_dados_segurado(s.nr_sequencia,'N'),1,255) nm_beneficiario,
		substr(pls_obter_dados_segurado(coalesce(s.nr_seq_titular,s.nr_sequencia),'N'),1,255) nm_usuario_princ,
		b.ie_tipo_segurado ie_tipo_segurado,
		substr(pls_obter_dados_prestador(b.nr_seq_prestador_exec,'N'),1,255) nm_prestador,
		substr(pls_obter_dados_segurado(coalesce(s.nr_seq_titular,s.nr_sequencia),'CPF'),1,255) nr_cpf_cnpj,
		'Despesas com Eventos / Sinistros' ds_operacao,
		'CM' ie_tipo_documento,
		substr(pls_obter_dados_grupo_ans(c.nr_seq_grupo_ans,'D'),1,255) ds_grupo_ans,
		substr(pls_obter_dados_prestador(b.nr_seq_prestador_exec,'TR'),1,255) ds_tipo_vinculo_operadora,
		c.ie_ato_cooperado ie_ato_cooperado,
		y.ie_preco ie_modalidade_contrat,
		y.ie_regulamentacao ie_regulamentacao,
		y.ie_tipo_contratacao ie_tipo_contratacao,
		y.ie_segmentacao ie_segmentacao,
		e.vl_liberado vl_evento,
		null vl_ajuste,
		e.vl_liberado vl_pagamento,
		null vl_glosa,
		null vl_coparticipacao,
		null vl_taxa_pgto,
		trunc(i.dt_mes_competencia) dt_contabilizacao,
		e.cd_conta_cred_pag cd_conta_credito,
		e.cd_conta_deb_pag cd_conta_debito,
		t.nr_contrato nr_contrato,
		null nr_seq_resumo,
		CASE WHEN y.ie_tipo_operacao='A' THEN  'SCA'  ELSE coalesce(y.nr_protocolo_ans, y.cd_scpa) END  nr_protocolo_ans,
		s.nr_sequencia	nr_seq_segurado,
		c.nr_seq_grupo_ans nr_seq_grupo_ans,
		a.nr_sequencia nr_seq_protocolo,
		null nr_seq_fatura,
		null nr_seq_conta_resumo,
		coalesce(substr(pls_obter_dados_prestador(b.nr_seq_prestador_exec,'CPF'),1,255), substr(pls_obter_dados_prestador(b.nr_seq_prestador_exec,'CGC'),1,255)) nr_cpf_cnpj_adic,
		coalesce(s.nr_seq_titular,s.nr_sequencia) nr_seq_titular,
		b.nr_seq_prestador_exec nr_seq_prestador,
		null nr_seq_arquivo,
		k.ie_tipo_grupo_ans ie_tipo_grupo_ans,
		null nr_seq_congenere,
		null dt_mes_competencia,
		null vl_deferido,
		null cd_abi,
		null nr_aih
	FROM pls_lote_pagamento i, pls_rec_glosa_protocolo g, pls_rec_glosa_conta f, pls_conta_rec_resumo_item e, pls_rec_glosa_mat d, pls_protocolo_conta a, pls_conta b
LEFT OUTER JOIN pls_segurado s ON (b.nr_seq_segurado = s.nr_sequencia)
LEFT OUTER JOIN pls_plano y ON (b.nr_seq_plano = y.nr_sequencia)
LEFT OUTER JOIN pls_contrato t ON (s.nr_seq_contrato = t.nr_sequencia)
, pls_conta_mat c
LEFT OUTER JOIN ans_grupo_despesa k ON (c.nr_seq_grupo_ans = k.nr_sequencia)
WHERE a.nr_sequencia			= b.nr_seq_protocolo and b.nr_sequencia			= c.nr_seq_conta and c.nr_sequencia			= d.nr_seq_conta_mat and d.nr_sequencia			= e.nr_seq_mat_rec and f.nr_sequencia			= e.nr_seq_conta_rec and g.nr_sequencia			= f.nr_seq_protocolo     and e.nr_seq_lote_pgto		= i.nr_sequencia and i.dt_mes_competencia between dt_inicial_w and dt_final_w and coalesce(coalesce(cd_conta_cred_apres,cd_conta_deb_apres),0) = 0 and (ie_gerar_ind_classif_p <> 'N'
	or	substr(e.cd_classif_deb_pag,1,5) = '4.1.1') and a.ie_tipo_protocolo = 'C' and (b.ie_tipo_segurado = ie_tipo_segurado_p or coalesce(ie_tipo_segurado_p::text, '') = '') and (a.ie_tipo_protocolo = ie_tipo_protocolo_p or coalesce(ie_tipo_protocolo_p::text, '') = '')
	 
union all

	select 	c.nr_sequencia nr_documento,
		null ie_tipo_protocolo,
		null cd_material_ops,
		null cd_procedimento,
		null ie_origem_proced,
		null ds_item_mat_proc,
		c.dt_internacao dt_ocorrencia,
		coalesce(p.dt_recebimento,p.dt_processo) dt_conhecimento,
		t.dt_liquidacao,
		substr(pls_obter_dados_segurado(s.nr_sequencia,'C'),1,255) cd_beneficiario,
		substr(pls_obter_dados_segurado(s.nr_sequencia,'N'),1,255) nm_beneficiario,
		substr(pls_obter_dados_segurado(coalesce(s.nr_seq_titular,s.nr_sequencia),'N'),1,255)  nm_usuario_princ,
		s.ie_tipo_segurado,
		pls_obter_desc_prest_processo(c.nr_seq_prestador) nm_prestador,
		substr(pls_obter_dados_segurado(coalesce(s.nr_seq_titular,s.nr_sequencia),'CPF'),1,255) cd_cpf_cgc,
		'Despesas com Eventos / Sinistros' ds_operacao,
		'PC' ie_tipo_documento,
		null ds_grupo_ans,
		substr(pls_obter_dados_prestador(c.nr_seq_prestador,'TR'),1,255) ds_tipo_vinculo_operadora,
		null ie_ato_cooperado,
		a.ie_preco ie_modalidade_contrat,
		a.ie_regulamentacao,
		a.ie_tipo_contratacao,
		a.ie_segmentacao,
		coalesce(c.vl_ressarcir, pls_conta_processo_obter_valor(c.nr_sequencia)) vl_evento,
		null vl_ajuste,
		c.vl_ressarcir vl_pagamento,
		null vl_glosa,
		null vl_coparticipacao,
		null vl_taxa_pgto,
		p.dt_processo dt_contabilizacao,
		c.cd_conta_cred cd_conta_credito,
		c.cd_conta_deb cd_conta_debito,
		r.nr_contrato,
		null nr_seq_resumo,
		CASE WHEN a.ie_tipo_operacao='A' THEN  'SCA'  ELSE coalesce(a.nr_protocolo_ans, a.cd_scpa) END  nr_protocolo_ans,
		s.nr_sequencia nr_seq_segurado,
		null nr_seq_grupo_ans,
		null nr_seq_protocolo,
		null nr_seq_fatura,
		null nr_seq_conta_resumo,
		coalesce(substr(pls_obter_dados_prestador(c.nr_seq_prestador,'CPF'),1,255),
			substr(pls_obter_dados_prestador(c.nr_seq_prestador,'CGC'),1,255)) nr_cpf_cnpj_adic,
		coalesce(s.nr_seq_titular,s.nr_sequencia) nr_seq_titular,
		c.nr_seq_prestador,
		null nr_seq_arquivo,
		null ie_tipo_grupo_ans,
		null nr_seq_congenere,
		null dt_mes_competencia,
		coalesce(c.vl_deferido,0) vl_deferido,
		p.cd_abi cd_abi,
		c.nr_aih nr_aih
	FROM pls_processo_gru g, pls_processo p
LEFT OUTER JOIN titulo_pagar t ON (p.nr_sequencia = t.nr_seq_processo)
, pls_processo_conta c
LEFT OUTER JOIN pls_segurado s ON (c.nr_seq_segurado = s.nr_sequencia)
LEFT OUTER JOIN pls_contrato r ON (s.nr_seq_contrato = r.nr_sequencia)
LEFT OUTER JOIN pls_plano a ON (s.nr_seq_plano = a.nr_sequencia)
WHERE p.nr_sequencia		= c.nr_seq_processo     and t.nr_seq_proc_gru	= g.nr_sequencia and c.nr_seq_proc_gru	= g.nr_sequencia and p.dt_processo between dt_inicial_w and dt_final_w and ((coalesce(ie_tipo_segurado_w, 'X')	= coalesce(s.ie_tipo_segurado, 'X'))
	or (coalesce(ie_tipo_segurado_w, 'X')	= 'X')) and (ie_gerar_ind_classif_p <> 'N'
	or 	substr(c.cd_classif_deb,1,5) = '4.1.1')
	 
union all

	select 	c.nr_sequencia nr_documento,	
		null ie_tipo_protocolo,
		null cd_material_ops,
		null cd_procedimento,
		null ie_origem_proced,
		null ds_item_mat_proc,
		c.dt_internacao dt_ocorrencia,
		coalesce(p.dt_recebimento,p.dt_processo) dt_conhecimento,
		null dt_liquidacao,
		substr(pls_obter_dados_segurado(s.nr_sequencia,'C'),1,255) cd_beneficiario,
		substr(pls_obter_dados_segurado(s.nr_sequencia,'N'),1,255)  nm_beneficiario,
		substr(pls_obter_dados_segurado(coalesce(s.nr_seq_titular,s.nr_sequencia),'N'),1,255)  nm_usuario_princ,
		s.ie_tipo_segurado,
		pls_obter_desc_prest_processo(c.nr_seq_prestador) nm_prestador,
		substr(pls_obter_dados_segurado(coalesce(s.nr_seq_titular,s.nr_sequencia),'CPF'),1,255) cd_cpf_cgc,
		'Despesas com Eventos / Sinistros' ds_operacao,
		'PC' ie_tipo_documento,
		null ds_grupo_ans,
		substr(pls_obter_dados_prestador(c.nr_seq_prestador,'TR'),1,255) ds_tipo_vinculo_operadora,
		null ie_ato_cooperado,
		a.ie_preco ie_modalidade_contrat,
		a.ie_regulamentacao,
		a.ie_tipo_contratacao,
		a.ie_segmentacao,
		coalesce(c.vl_ressarcir, pls_conta_processo_obter_valor(c.nr_sequencia)) vl_evento,
		null vl_ajuste,
		c.vl_ressarcir vl_pagamento,
		null vl_glosa,
		null vl_coparticipacao,
		null vl_taxa_pgto,
		p.dt_processo dt_contabilizacao,
		c.cd_conta_cred cd_conta_credito,
		c.cd_conta_deb cd_conta_debito,
		r.nr_contrato,
		null nr_seq_resumo,
		CASE WHEN a.ie_tipo_operacao='A' THEN  'SCA'  ELSE coalesce(a.nr_protocolo_ans, a.cd_scpa) END  nr_protocolo_ans,
		s.nr_sequencia nr_seq_segurado,
		null nr_seq_grupo_ans,
		null nr_seq_protocolo,
		null nr_seq_fatura,
		null nr_seq_conta_resumo,
		coalesce(substr(pls_obter_dados_prestador(c.nr_seq_prestador,'CPF'),1,255),
			substr(pls_obter_dados_prestador(c.nr_seq_prestador,'CGC'),1,255)) nr_cpf_cnpj_adic,
		coalesce(s.nr_seq_titular,s.nr_sequencia) nr_seq_titular,
		c.nr_seq_prestador,
		null nr_seq_arquivo,
		null ie_tipo_grupo_ans,
		null nr_seq_congenere,
		null dt_mes_competencia,
		coalesce(c.vl_deferido,0) vl_deferido,
		p.cd_abi cd_abi,
		c.nr_aih nr_aih
	FROM pls_processo p, pls_processo_conta c
LEFT OUTER JOIN pls_segurado s ON (c.nr_seq_segurado = s.nr_sequencia)
LEFT OUTER JOIN pls_contrato r ON (s.nr_seq_contrato = r.nr_sequencia)
LEFT OUTER JOIN pls_plano a ON (s.nr_seq_plano = a.nr_sequencia)
WHERE p.nr_sequencia		= c.nr_seq_processo    and p.dt_processo between dt_inicial_w and dt_final_w and ((coalesce(ie_tipo_segurado_w, 'X')	= coalesce(s.ie_tipo_segurado, 'X'))
	or (coalesce(ie_tipo_segurado_w, 'X')	= 'X')) and coalesce(c.nr_seq_proc_gru::text, '') = '' and (ie_gerar_ind_classif_p <> 'N'
	or 	substr(c.cd_classif_deb,1,5) = '4.1.1')
	 
union all

	select 	c.nr_sequencia nr_documento,
		null ie_tipo_protocolo,
		null cd_material_ops,
		null cd_procedimento,
		null ie_origem_proced,
		null ds_item_mat_proc,
		c.dt_internacao dt_ocorrencia,
		coalesce(p.dt_recebimento,p.dt_processo) dt_conhecimento,
		t.dt_liquidacao,
		substr(pls_obter_dados_segurado(s.nr_sequencia,'C'),1,255) cd_beneficiario,
		substr(pls_obter_dados_segurado(s.nr_sequencia,'N'),1,255) nm_beneficiario,
		substr(pls_obter_dados_segurado(coalesce(s.nr_seq_titular,s.nr_sequencia),'N'),1,255)  nm_usuario_princ,
		s.ie_tipo_segurado,
		pls_obter_desc_prest_processo(c.nr_seq_prestador) nm_prestador,
		substr(pls_obter_dados_segurado(coalesce(s.nr_seq_titular,s.nr_sequencia),'CPF'),1,255) cd_cpf_cgc,
		'Despesas com Eventos / Sinistros' ds_operacao,
		'PR' ie_tipo_documento,
		null ds_grupo_ans,
		substr(pls_obter_dados_prestador(c.nr_seq_prestador,'TR'),1,255) ds_tipo_vinculo_operadora,
		null ie_ato_cooperado,
		a.ie_preco ie_modalidade_contrat,
		a.ie_regulamentacao,
		a.ie_tipo_contratacao,
		a.ie_segmentacao,
		coalesce(b.vl_provisao, 0) vl_evento,
		null vl_ajuste,
		c.vl_ressarcir vl_pagamento,
		null vl_glosa,
		null vl_coparticipacao,
		null vl_taxa_pgto,
		p.dt_processo dt_contabilizacao,
		b.cd_conta_cred_prov cd_conta_credito,
		b.cd_conta_deb_prov cd_conta_debito,
		r.nr_contrato,
		null nr_seq_resumo,
		CASE WHEN a.ie_tipo_operacao='A' THEN  'SCA'  ELSE coalesce(a.nr_protocolo_ans, a.cd_scpa) END  nr_protocolo_ans,
		s.nr_sequencia nr_seq_segurado,
		null nr_seq_grupo_ans,
		null nr_seq_protocolo,
		null nr_seq_fatura,
		null nr_seq_conta_resumo,
		coalesce(substr(pls_obter_dados_prestador(c.nr_seq_prestador,'CPF'),1,255),
			substr(pls_obter_dados_prestador(c.nr_seq_prestador,'CGC'),1,255)) nr_cpf_cnpj_adic,
		coalesce(s.nr_seq_titular,s.nr_sequencia) nr_seq_titular,
		c.nr_seq_prestador,
		null nr_seq_arquivo,
		null ie_tipo_grupo_ans,
		null nr_seq_congenere,
		null dt_mes_competencia,
		0 vl_deferido,
		p.cd_abi cd_abi,
		c.nr_aih nr_aih
	FROM pls_processo_gru g, pls_processo_competencia d, pls_processo_contas_comp b, pls_processo p
LEFT OUTER JOIN titulo_pagar t ON (p.nr_sequencia = t.nr_seq_processo)
, pls_processo_conta c
LEFT OUTER JOIN pls_segurado s ON (c.nr_seq_segurado = s.nr_sequencia)
LEFT OUTER JOIN pls_contrato r ON (s.nr_seq_contrato = r.nr_sequencia)
LEFT OUTER JOIN pls_plano a ON (s.nr_seq_plano = a.nr_sequencia)
WHERE p.nr_sequencia		= c.nr_seq_processo     and t.nr_seq_proc_gru	= g.nr_sequencia and c.nr_seq_proc_gru	= g.nr_sequencia and c.nr_sequencia		= b.nr_seq_conta and b.nr_seq_competencia	= d.nr_sequencia and d.dt_competencia between dt_inicial_w and dt_final_w and ((coalesce(ie_tipo_segurado_w, 'X')	= coalesce(s.ie_tipo_segurado, 'X'))
	or (coalesce(ie_tipo_segurado_w, 'X')	= 'X')) and b.ie_tipo_movimentacao = 'P' and coalesce(b.vl_provisao, 0) <> 0 and (ie_gerar_ind_classif_p <> 'N'
	or 	substr(b.cd_classif_deb_prov,1,5) = '4.1.1')
	 
union all

	select 	c.nr_sequencia nr_documento,
		null ie_tipo_protocolo,
		null cd_material_ops,
		null cd_procedimento,
		null ie_origem_proced,
		null ds_item_mat_proc,
		c.dt_internacao dt_ocorrencia,
		coalesce(p.dt_recebimento,p.dt_processo) dt_conhecimento,
		null dt_liquidacao,
		substr(pls_obter_dados_segurado(s.nr_sequencia,'C'),1,255) cd_beneficiario,
		substr(pls_obter_dados_segurado(s.nr_sequencia,'N'),1,255) nm_beneficiario,
		substr(pls_obter_dados_segurado(coalesce(s.nr_seq_titular,s.nr_sequencia),'N'),1,255)  nm_usuario_princ,
		s.ie_tipo_segurado,
		pls_obter_desc_prest_processo(c.nr_seq_prestador) nm_prestador,
		substr(pls_obter_dados_segurado(coalesce(s.nr_seq_titular,s.nr_sequencia),'CPF'),1,255) cd_cpf_cgc,
		'Despesas com Eventos / Sinistros' ds_operacao,
		'PR' ie_tipo_documento,
		null ds_grupo_ans,
		substr(pls_obter_dados_prestador(c.nr_seq_prestador,'TR'),1,255) ds_tipo_vinculo_operadora,
		null ie_ato_cooperado,
		a.ie_preco ie_modalidade_contrat,
		a.ie_regulamentacao,
		a.ie_tipo_contratacao,
		a.ie_segmentacao,
		coalesce(b.vl_provisao, 0) vl_evento,
		null vl_ajuste,
		c.vl_ressarcir vl_pagamento,
		null vl_glosa,
		null vl_coparticipacao,
		null vl_taxa_pgto,
		p.dt_processo dt_contabilizacao,
		b.cd_conta_cred_prov cd_conta_credito,
		b.cd_conta_deb_prov cd_conta_debito,
		r.nr_contrato,
		null nr_seq_resumo,
		CASE WHEN a.ie_tipo_operacao='A' THEN  'SCA'  ELSE coalesce(a.nr_protocolo_ans, a.cd_scpa) END  nr_protocolo_ans,
		s.nr_sequencia nr_seq_segurado,
		null nr_seq_grupo_ans,
		null nr_seq_protocolo,
		null nr_seq_fatura,
		null nr_seq_conta_resumo,
		coalesce(substr(pls_obter_dados_prestador(c.nr_seq_prestador,'CPF'),1,255),
			substr(pls_obter_dados_prestador(c.nr_seq_prestador,'CGC'),1,255)) nr_cpf_cnpj_adic,
		coalesce(s.nr_seq_titular,s.nr_sequencia) nr_seq_titular,
		c.nr_seq_prestador,
		null nr_seq_arquivo,
		null ie_tipo_grupo_ans,
		null nr_seq_congenere,
		null dt_mes_competencia,
		0 vl_deferido,
		p.cd_abi cd_abi,
		c.nr_aih nr_aih
	FROM pls_processo p, pls_processo_competencia d, pls_processo_contas_comp b, pls_processo_conta c
LEFT OUTER JOIN pls_segurado s ON (c.nr_seq_segurado = s.nr_sequencia)
LEFT OUTER JOIN pls_contrato r ON (s.nr_seq_contrato = r.nr_sequencia)
LEFT OUTER JOIN pls_plano a ON (s.nr_seq_plano = a.nr_sequencia)
WHERE p.nr_sequencia		= c.nr_seq_processo    and c.nr_sequencia		= b.nr_seq_conta and b.nr_seq_competencia	= d.nr_sequencia and d.dt_competencia between dt_inicial_w and dt_final_w and ((coalesce(ie_tipo_segurado_w, 'X')	= coalesce(s.ie_tipo_segurado, 'X'))
	or (coalesce(ie_tipo_segurado_w, 'X')	= 'X')) and coalesce(c.nr_seq_proc_gru::text, '') = '' and b.ie_tipo_movimentacao = 'P' and coalesce(b.vl_provisao, 0) <> 0 and (ie_gerar_ind_classif_p <> 'N'
	or 	substr(b.cd_classif_deb_prov,1,5) = '4.1.1')
	 
union all

	select 	c.nr_sequencia nr_documento,
		null ie_tipo_protocolo,
		null cd_material_ops,
		null cd_procedimento,
		null ie_origem_proced,
		null ds_item_mat_proc,
		c.dt_internacao dt_ocorrencia,
		coalesce(p.dt_recebimento,p.dt_processo) dt_conhecimento,
		t.dt_liquidacao,
		substr(pls_obter_dados_segurado(s.nr_sequencia,'C'),1,255) cd_beneficiario,
		substr(pls_obter_dados_segurado(s.nr_sequencia,'N'),1,255) nm_beneficiario,
		substr(pls_obter_dados_segurado(coalesce(s.nr_seq_titular,s.nr_sequencia),'N'),1,255)  nm_usuario_princ,
		s.ie_tipo_segurado,
		pls_obter_desc_prest_processo(c.nr_seq_prestador) nm_prestador,
		substr(pls_obter_dados_segurado(coalesce(s.nr_seq_titular,s.nr_sequencia),'CPF'),1,255) cd_cpf_cgc,
		'Despesas com Eventos / Sinistros' ds_operacao,
		'AJ' ie_tipo_documento,
		null ds_grupo_ans,
		substr(pls_obter_dados_prestador(c.nr_seq_prestador,'TR'),1,255) ds_tipo_vinculo_operadora,
		null ie_ato_cooperado,
		a.ie_preco ie_modalidade_contrat,
		a.ie_regulamentacao,
		a.ie_tipo_contratacao,
		a.ie_segmentacao,
		coalesce(b.vl_ajuste, 0) vl_evento,
		null vl_ajuste,
		c.vl_ressarcir vl_pagamento,
		null vl_glosa,
		null vl_coparticipacao,
		null vl_taxa_pgto,
		p.dt_processo dt_contabilizacao,
		b.cd_conta_cred_ajuste cd_conta_credito,
		b.cd_conta_deb_ajuste cd_conta_debito,
		r.nr_contrato,
		null nr_seq_resumo,
		CASE WHEN a.ie_tipo_operacao='A' THEN  'SCA'  ELSE coalesce(a.nr_protocolo_ans, a.cd_scpa) END  nr_protocolo_ans,
		s.nr_sequencia nr_seq_segurado,
		null nr_seq_grupo_ans,
		null nr_seq_protocolo,
		null nr_seq_fatura,
		null nr_seq_conta_resumo,
		coalesce(substr(pls_obter_dados_prestador(c.nr_seq_prestador,'CPF'),1,255),
			substr(pls_obter_dados_prestador(c.nr_seq_prestador,'CGC'),1,255)) nr_cpf_cnpj_adic,
		coalesce(s.nr_seq_titular,s.nr_sequencia) nr_seq_titular,
		c.nr_seq_prestador,		
		null nr_seq_arquivo,
		null ie_tipo_grupo_ans,
		null nr_seq_congenere,
		null dt_mes_competencia,
		0 vl_deferido,
		p.cd_abi cd_abi,
		c.nr_aih nr_aih
	FROM pls_processo_gru g, pls_processo_competencia d, pls_processo_contas_comp b, pls_processo p
LEFT OUTER JOIN titulo_pagar t ON (p.nr_sequencia = t.nr_seq_processo)
, pls_processo_conta c
LEFT OUTER JOIN pls_segurado s ON (c.nr_seq_segurado = s.nr_sequencia)
LEFT OUTER JOIN pls_contrato r ON (s.nr_seq_contrato = r.nr_sequencia)
LEFT OUTER JOIN pls_plano a ON (s.nr_seq_plano = a.nr_sequencia)
WHERE p.nr_sequencia		= c.nr_seq_processo     and t.nr_seq_proc_gru	= g.nr_sequencia and c.nr_seq_proc_gru	= g.nr_sequencia and c.nr_sequencia		= b.nr_seq_conta and b.nr_seq_competencia	= d.nr_sequencia and d.dt_competencia between dt_inicial_w and dt_final_w and ((coalesce(ie_tipo_segurado_w, 'X')	= coalesce(s.ie_tipo_segurado, 'X'))
	or (coalesce(ie_tipo_segurado_w, 'X')	= 'X')) and b.ie_tipo_movimentacao = 'P' and coalesce(b.vl_ajuste, 0) <> 0 and (ie_gerar_ind_classif_p <> 'N'
	or 	substr(b.cd_classif_deb_ajuste,1,5) = '4.1.1')
	 
union all

	select 	c.nr_sequencia nr_documento,
		null ie_tipo_protocolo,
		null cd_material_ops,
		null cd_procedimento,
		null ie_origem_proced,
		null ds_item_mat_proc,
		c.dt_internacao dt_ocorrencia,
		coalesce(p.dt_recebimento,p.dt_processo) dt_conhecimento,
		null dt_liquidacao,
		substr(pls_obter_dados_segurado(s.nr_sequencia,'C'),1,255) cd_beneficiario,
		substr(pls_obter_dados_segurado(s.nr_sequencia,'N'),1,255) nm_beneficiario,
		substr(pls_obter_dados_segurado(coalesce(s.nr_seq_titular,s.nr_sequencia),'N'),1,255)  nm_usuario_princ,
		s.ie_tipo_segurado,
		pls_obter_desc_prest_processo(c.nr_seq_prestador) nm_prestador,
		substr(pls_obter_dados_segurado(coalesce(s.nr_seq_titular,s.nr_sequencia),'CPF'),1,255) cd_cpf_cgc,
		'Despesas com Eventos / Sinistros' ds_operacao,
		'AJ' ie_tipo_documento,
		null ds_grupo_ans,
		substr(pls_obter_dados_prestador(c.nr_seq_prestador,'TR'),1,255) ds_tipo_vinculo_operadora,
		null ie_ato_cooperado,
		a.ie_preco ie_modalidade_contrat,
		a.ie_regulamentacao,
		a.ie_tipo_contratacao,
		a.ie_segmentacao,
		coalesce(b.vl_ajuste, 0) vl_evento,
		null vl_ajuste,
		c.vl_ressarcir vl_pagamento,
		null vl_glosa,
		null vl_coparticipacao,
		null vl_taxa_pgto,
		p.dt_processo dt_contabilizacao,
		b.cd_conta_cred_ajuste cd_conta_credito,
		b.cd_conta_deb_ajuste cd_conta_debito,
		r.nr_contrato,
		null nr_seq_resumo,
		CASE WHEN a.ie_tipo_operacao='A' THEN  'SCA'  ELSE coalesce(a.nr_protocolo_ans, a.cd_scpa) END  nr_protocolo_ans,
		s.nr_sequencia nr_seq_segurado,
		null nr_seq_grupo_ans,
		null nr_seq_protocolo,
		null nr_seq_fatura,
		null nr_seq_conta_resumo,
		coalesce(substr(pls_obter_dados_prestador(c.nr_seq_prestador,'CPF'),1,255),
			substr(pls_obter_dados_prestador(c.nr_seq_prestador,'CGC'),1,255)) nr_cpf_cnpj_adic,
		coalesce(s.nr_seq_titular,s.nr_sequencia) nr_seq_titular,
		c.nr_seq_prestador,
		null nr_seq_arquivo,
		null ie_tipo_grupo_ans,
		null nr_seq_congenere,
		null dt_mes_competencia,
		0 vl_deferido,
		p.cd_abi cd_abi,
		c.nr_aih nr_aih
	FROM pls_processo p, pls_processo_competencia d, pls_processo_contas_comp b, pls_processo_conta c
LEFT OUTER JOIN pls_segurado s ON (c.nr_seq_segurado = s.nr_sequencia)
LEFT OUTER JOIN pls_contrato r ON (s.nr_seq_contrato = r.nr_sequencia)
LEFT OUTER JOIN pls_plano a ON (s.nr_seq_plano = a.nr_sequencia)
WHERE p.nr_sequencia		= c.nr_seq_processo    and c.nr_sequencia		= b.nr_seq_conta and b.nr_seq_competencia	= d.nr_sequencia and d.dt_competencia between dt_inicial_w and dt_final_w and ((coalesce(ie_tipo_segurado_w, 'X')	= coalesce(s.ie_tipo_segurado, 'X'))
	or (coalesce(ie_tipo_segurado_w, 'X')	= 'X')) and coalesce(c.nr_seq_proc_gru::text, '') = '' and b.ie_tipo_movimentacao = 'P' and coalesce(b.vl_ajuste, 0) <> 0 and (ie_gerar_ind_classif_p <> 'N'
	or 	substr(b.cd_classif_deb_ajuste,1,5) = '4.1.1')	
	 
union all

	select 	c.nr_sequencia nr_documento,
		null ie_tipo_protocolo,
		null cd_material_ops,
		null cd_procedimento,
		null ie_origem_proced,
		null ds_item_mat_proc,
		c.dt_internacao dt_ocorrencia,
		coalesce(p.dt_recebimento,p.dt_processo) dt_conhecimento,
		t.dt_liquidacao,
		substr(pls_obter_dados_segurado(s.nr_sequencia,'C'),1,255) cd_beneficiario,
		substr(pls_obter_dados_segurado(s.nr_sequencia,'N'),1,255) nm_beneficiario,
		substr(pls_obter_dados_segurado(coalesce(s.nr_seq_titular,s.nr_sequencia),'N'),1,255)  nm_usuario_princ,
		s.ie_tipo_segurado,
		pls_obter_desc_prest_processo(c.nr_seq_prestador) nm_prestador,
		substr(pls_obter_dados_segurado(coalesce(s.nr_seq_titular,s.nr_sequencia),'CPF'),1,255) cd_cpf_cgc,
		'Despesas com Eventos / Sinistros' ds_operacao,
		'PC' ie_tipo_documento,
		null ds_grupo_ans,
		substr(pls_obter_dados_prestador(c.nr_seq_prestador,'TR'),1,255) ds_tipo_vinculo_operadora,
		null ie_ato_cooperado,
		a.ie_preco ie_modalidade_contrat,
		a.ie_regulamentacao,
		a.ie_tipo_contratacao,
		a.ie_segmentacao,
		pls_conta_processo_obter_valor(c.nr_sequencia) vl_evento,
		null vl_ajuste,
		c.vl_ressarcir vl_pagamento,
		null vl_glosa,
		null vl_coparticipacao,
		null vl_taxa_pgto,
		p.dt_processo dt_contabilizacao,
		c.cd_conta_cred_processo cd_conta_credito_processo,
		c.cd_conta_deb_processo cd_conta_debito_processo,
		r.nr_contrato,
		null nr_seq_resumo,
		CASE WHEN a.ie_tipo_operacao='A' THEN  'SCA'  ELSE coalesce(a.nr_protocolo_ans, a.cd_scpa) END  nr_protocolo_ans,
		s.nr_sequencia nr_seq_segurado,
		null nr_seq_grupo_ans,
		null nr_seq_protocolo,
		null nr_seq_fatura,
		null nr_seq_conta_resumo,
		coalesce(substr(pls_obter_dados_prestador(c.nr_seq_prestador,'CPF'),1,255),
			substr(pls_obter_dados_prestador(c.nr_seq_prestador,'CGC'),1,255)) nr_cpf_cnpj_adic,
		coalesce(s.nr_seq_titular,s.nr_sequencia) nr_seq_titular,
		c.nr_seq_prestador,
		null nr_seq_arquivo,
		null ie_tipo_grupo_ans,
		null nr_seq_congenere,
		null dt_mes_competencia,
		coalesce(c.vl_deferido,0) vl_deferido,
		p.cd_abi cd_abi,
		c.nr_aih nr_aih
	FROM pls_processo_gru g, pls_processo p
LEFT OUTER JOIN titulo_pagar t ON (p.nr_sequencia = t.nr_seq_processo)
, pls_processo_conta c
LEFT OUTER JOIN pls_segurado s ON (c.nr_seq_segurado = s.nr_sequencia)
LEFT OUTER JOIN pls_contrato r ON (s.nr_seq_contrato = r.nr_sequencia)
LEFT OUTER JOIN pls_plano a ON (s.nr_seq_plano = a.nr_sequencia)
WHERE p.nr_sequencia		= c.nr_seq_processo     and t.nr_seq_proc_gru	= g.nr_sequencia and c.nr_seq_proc_gru	= g.nr_sequencia and p.dt_processo between dt_inicial_w and dt_final_w and ((coalesce(ie_tipo_segurado_w, 'X')	= coalesce(s.ie_tipo_segurado, 'X'))
	or (coalesce(ie_tipo_segurado_w, 'X')	= 'X')) and (ie_gerar_ind_classif_p <> 'N'
	or 	substr(c.cd_classif_deb_processo,1,5) = '4.1.1') and pls_conta_processo_obter_valor(c.nr_sequencia) > 0
	 
union all

	select 	c.nr_sequencia nr_documento,	
		null ie_tipo_protocolo,
		null cd_material_ops,
		null cd_procedimento,
		null ie_origem_proced,
		null ds_item_mat_proc,
		c.dt_internacao dt_ocorrencia,
		coalesce(p.dt_recebimento,p.dt_processo) dt_conhecimento,
		null dt_liquidacao,
		substr(pls_obter_dados_segurado(s.nr_sequencia,'C'),1,255) cd_beneficiario,
		substr(pls_obter_dados_segurado(s.nr_sequencia,'N'),1,255)  nm_beneficiario,
		substr(pls_obter_dados_segurado(coalesce(s.nr_seq_titular,s.nr_sequencia),'N'),1,255)  nm_usuario_princ,
		s.ie_tipo_segurado,
		pls_obter_desc_prest_processo(c.nr_seq_prestador) nm_prestador,
		substr(pls_obter_dados_segurado(coalesce(s.nr_seq_titular,s.nr_sequencia),'CPF'),1,255) cd_cpf_cgc,
		'Despesas com Eventos / Sinistros' ds_operacao,
		'PC' ie_tipo_documento,
		null ds_grupo_ans,
		substr(pls_obter_dados_prestador(c.nr_seq_prestador,'TR'),1,255) ds_tipo_vinculo_operadora,
		null ie_ato_cooperado,
		a.ie_preco ie_modalidade_contrat,
		a.ie_regulamentacao,
		a.ie_tipo_contratacao,
		a.ie_segmentacao,
		pls_conta_processo_obter_valor(c.nr_sequencia) vl_evento,
		null vl_ajuste,
		c.vl_ressarcir vl_pagamento,
		null vl_glosa,
		null vl_coparticipacao,
		null vl_taxa_pgto,
		p.dt_processo dt_contabilizacao,
		c.cd_conta_cred_processo cd_conta_credito_processo,
		c.cd_conta_deb_processo cd_conta_debito_processo,
		r.nr_contrato,
		null nr_seq_resumo,
		CASE WHEN a.ie_tipo_operacao='A' THEN  'SCA'  ELSE coalesce(a.nr_protocolo_ans, a.cd_scpa) END  nr_protocolo_ans,
		s.nr_sequencia nr_seq_segurado,
		null nr_seq_grupo_ans,
		null nr_seq_protocolo,
		null nr_seq_fatura,
		null nr_seq_conta_resumo,
		coalesce(substr(pls_obter_dados_prestador(c.nr_seq_prestador,'CPF'),1,255),
			substr(pls_obter_dados_prestador(c.nr_seq_prestador,'CGC'),1,255)) nr_cpf_cnpj_adic,
		coalesce(s.nr_seq_titular,s.nr_sequencia) nr_seq_titular,
		c.nr_seq_prestador,
		null nr_seq_arquivo,
		null ie_tipo_grupo_ans,
		null nr_seq_congenere,
		null dt_mes_competencia,
		coalesce(c.vl_deferido,0) vl_deferido,
		p.cd_abi cd_abi,
		c.nr_aih nr_aih
	FROM pls_processo p, pls_processo_conta c
LEFT OUTER JOIN pls_segurado s ON (c.nr_seq_segurado = s.nr_sequencia)
LEFT OUTER JOIN pls_contrato r ON (s.nr_seq_contrato = r.nr_sequencia)
LEFT OUTER JOIN pls_plano a ON (s.nr_seq_plano = a.nr_sequencia)
WHERE p.nr_sequencia		= c.nr_seq_processo    and p.dt_processo between dt_inicial_w and dt_final_w and ((coalesce(ie_tipo_segurado_w, 'X')	= coalesce(s.ie_tipo_segurado, 'X'))
	or (coalesce(ie_tipo_segurado_w, 'X')	= 'X')) and coalesce(c.nr_seq_proc_gru::text, '') = '' and (ie_gerar_ind_classif_p <> 'N'
	or 	substr(c.cd_classif_deb_processo,1,5) = '4.1.1') and pls_conta_processo_obter_valor(c.nr_sequencia) > 0 order by nr_documento;
	
vet_medica c_medica%rowtype;

c_movimento CURSOR FOR
	SELECT	'N' ie_tipo_movto
	
	
union all

	SELECT	'G' ie_tipo_movto
	
	where	ie_glosa_w = 'S';
	
c_movimento_w c_movimento%rowtype;

BEGIN

CALL wheb_usuario_pck.set_ie_executar_trigger('N');

dt_inicial_w	:= trunc(dt_inicial_p,'dd');
dt_final_w	:= fim_dia(dt_final_p);

select	count(*)
into STRICT	qt_regra_evento_w
from	pls_esquema_contabil a
where	dt_inicial_w between dt_inicio_vigencia and coalesce(dt_fim_vigencia, dt_final_w)
and	ie_tipo_regra = 'IC'
and	coalesce(a.ie_tipo_movimentacao, 11) = 11
and 	a.cd_estabelecimento = cd_estabelecimento_p
and	exists (	SELECT	1
		from	pls_esquema_contabil_seg b
		where	b.nr_seq_regra_esquema = a.nr_sequencia);					

select	count(*)
into STRICT	qt_regra_reemb_taxa_w
from	pls_esquema_contabil a
where 	dt_inicial_w between dt_inicio_vigencia and coalesce(dt_fim_vigencia, dt_final_w)
and	ie_tipo_regra = 'IC'
and	coalesce(a.ie_tipo_movimentacao, 33) in (33,34)
and 	a.cd_estabelecimento = cd_estabelecimento_p
and	exists (	SELECT	1
		from	pls_esquema_contabil_seg b
		where	b.nr_seq_regra_esquema = a.nr_sequencia);

select	max(ie_lote_ajuste_prod),	
	coalesce(max(ie_forma_contab_taxa_pgto),'N')
into STRICT	ie_lote_ajuste_prod_w,
	ie_forma_contab_taxa_pgto_w
from	pls_parametro_contabil
where	cd_estabelecimento = cd_estabelecimento_p;

dt_referencia_month_w	:= trunc(dt_inicial_p,'month');

select	sum(CASE WHEN ie_prestador_codificacao='P' THEN  0  ELSE 1 END ) qt_prest_outros
into STRICT	qt_prest_outros_w
from	pls_esquema_contabil
where	ie_tipo_regra		= 'PP'
and	cd_estabelecimento	= cd_estabelecimento_p
and	dt_referencia_month_w between dt_inicio_vigencia and coalesce(dt_fim_vigencia, dt_referencia_month_w);

select	coalesce(max(ie_forma_contab_reembolso),'C')
into STRICT	ie_forma_contab_reembolso_w
from	pls_parametro_contabil
where	cd_estabelecimento = cd_estabelecimento_p;

select	max(a.ie_prestador_codificacao)
into STRICT	ie_prestador_codificacao_w
from	pls_esquema_contabil	a
where	a.ie_tipo_regra		= 'AC'
and	a.cd_estabelecimento	= cd_estabelecimento_p
and	dt_referencia_month_w between a.dt_inicio_vigencia and coalesce(a.dt_fim_vigencia,dt_referencia_month_w);

select	max(ie_tipo_segurado)
into STRICT	ie_tipo_segurado_w
from	ctb_livro_auxiliar
where	nr_sequencia = nr_seq_regra_p;

select	coalesce(max(a.ie_data_tipo_segurado),'A')
into STRICT	ie_data_tipo_segurado_w
from	pls_parametros a
where	a.cd_estabelecimento = cd_estabelecimento_p;

select	substr(obter_desc_expressao(922923),1,255)
into STRICT	ds_observacao_w
;

ds_operacao_w	:= wheb_mensagem_pck.get_texto(1044378);

if (ie_gerar_arquivo_p = 'N') then

	delete
	from	w_ctb_livro_aux_event_liq a
	where	nr_seq_reg_auxiliar = nr_seq_regra_p;

	commit;

	ie_nao_aplica_recalc_w := obter_param_usuario(1314, 3, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_nao_aplica_recalc_w);

	open c_medica;
	loop
	fetch c_medica into	
		vet_medica;
	EXIT WHEN NOT FOUND; /* apply on c_medica */
		begin
		
		/* Foi feito este nvl devido aos casos de selects que retornam explicitamente nulo o dt_ocorrencia, passando a utilizar o dt_conhecimento */

		if (ie_data_tipo_segurado_w = 'A') then
			dt_ref_repasse_w	:= coalesce(vet_medica.dt_ocorrencia, vet_medica.dt_conhecimento);
		else
			dt_ref_repasse_w	:= vet_medica.dt_mes_competencia;
		end if;
		
		SELECT * FROM pls_obter_dados_repasse(	dt_ref_repasse_w, vet_medica.nr_seq_segurado, vet_medica.nr_seq_congenere, ie_tipo_repasse_w, ie_tipo_compartilhamento_w, dt_repasse_w, dt_fim_repasse_w) INTO STRICT ie_tipo_repasse_w, ie_tipo_compartilhamento_w, dt_repasse_w, dt_fim_repasse_w;

		if (vet_medica.ie_tipo_protocolo = 'C') then
			select max(t.dt_emissao),
				max(t.dt_vencimento_original),
				max(v.nr_titulo)
			into STRICT	dt_emissao_w,
				dt_vencimento_w,
				nr_titulo_w
			from	pls_pagamento_prestador 	a,
				pls_conta_medica_resumo 	r,
				titulo_pagar 			t,
				pls_pag_prest_vencimento 	v,
				pls_lote_pagamento	 	l,
				pls_conta 			c
			where	a.nr_seq_prestador 	= r.nr_seq_prestador_pgto
			and 	a.nr_sequencia      	= v.nr_seq_pag_prestador
			and	v.nr_titulo      	= t.nr_titulo
			and	l.nr_sequencia 		= r.nr_seq_lote_pgto
			and	a.nr_seq_lote		= l.nr_sequencia
			and	r.nr_sequencia 		= vet_medica.nr_seq_conta_resumo
			and	r.nr_seq_conta		= vet_medica.nr_documento
			and	c.nr_sequencia 		= r.nr_seq_conta;
			
		elsif (vet_medica.ie_tipo_protocolo = 'R') then
			select max(t.dt_emissao),
				max(t.dt_vencimento_original),
				coalesce(max(t.nr_titulo),0)
			into STRICT	dt_emissao_w,
				dt_vencimento_w,
				nr_titulo_w
			from	pls_protocolo_conta		p,
				titulo_pagar			t
			where	p.nr_sequencia = t.nr_seq_reembolso
			and	p.nr_sequencia = vet_medica.nr_seq_protocolo;
			
		elsif (vet_medica.ie_tipo_protocolo = 'I') then
			select max(t.dt_emissao),
				max(t.dt_vencimento_original),
				max(t.nr_titulo)
			into STRICT	dt_emissao_w,
				dt_vencimento_w,
				nr_titulo_w
			from   	titulo_pagar t,
				ptu_fatura   f
			where  	f.nr_sequencia = t.nr_titulo
			and	f.nr_sequencia = vet_medica.nr_seq_fatura;
		end if;
			
		nr_contador_w := nr_contador_w + 1;
			
		if (vet_medica.vl_ajuste < 0 or ie_lote_ajuste_prod_w = 'R') then
			vet_medica.vl_ajuste	:= 0;
		end if;
		
		if (vet_medica.nr_seq_arquivo IS NOT NULL AND vet_medica.nr_seq_arquivo::text <> '') then
			select	coalesce(max('S'),'N')
			into STRICT	ie_glosa_w
			from	ptu_aviso_glosa_bx		g,
				ptu_aviso_glosa_bx_dados	d
			where	g.nr_sequencia		= d.nr_seq_glosa_baixa
			and	g.nr_seq_arquivo	= vet_medica.nr_seq_arquivo;
		end if;
		
		open c_movimento;
		loop
		fetch c_movimento into
			c_movimento_w;
		EXIT WHEN NOT FOUND; /* apply on c_movimento */
			begin
			if (c_movimento_w.ie_tipo_movto = 'N') then
				cd_conta_debito_w	:= vet_medica.cd_conta_debito;
				cd_conta_credito_w	:= vet_medica.cd_conta_credito;
			else
				cd_conta_debito_w	:= vet_medica.cd_conta_credito;
				cd_conta_credito_w	:= vet_medica.cd_conta_debito;
				vet_medica.vl_evento	:= vet_medica.vl_evento * -1;
			end if;
		
		ds_observacao_item_w	:= null;
		
		if (vet_medica.ie_tipo_segurado in ('C','I','T')) then
			ds_observacao_item_w	:= ds_observacao_w;
		end if;
		
			insert into w_ctb_livro_aux_event_liq(	nr_sequencia,
					dt_atualizacao,
					nm_usuario,
					dt_atualizacao_nrec,
					nm_usuario_nrec,
					nr_documento,
					ie_tipo_protocolo,
					ds_tipo_protocolo,
					cd_material_ops,
					cd_procedimento,
					ie_origem_proced,
					ds_item_mat_proc,
					dt_ocorrencia,
					dt_conhecimento,
					cd_beneficiario,
					nm_usuario_evento,
					nm_usuario_princ,
					ie_tipo_segurado,
					ds_tipo_segurado,
					nm_prestador,
					nr_cpf_cnpj,
					ds_operacao,
					ie_tipo_documento,
					ds_tipo_documento,
					ds_grupo_ans,
					nr_protocolo_ans,
					ds_tipo_vinculo_operadora,
					ie_ato_cooperado,
					ds_ato_cooperado,
					ie_preco,
					ds_modalidade_contrat,
					ie_regulamentacao,
					ds_tipo_regulamentacao,
					ie_tipo_contratacao,
					ds_tipo_contratacao,
					ie_segmentacao,
					ds_segmentacao,
					vl_evento,
					vl_pagar,
					vl_ajuste,
					vl_glosa,
					vl_coparticipacao,
					vl_taxa_pgto,
					dt_contabilizacao,
					dt_pagamento,
					cd_conta_contabil,
					cd_conta_contrapartida,
					nr_contrato,
					ie_tipo_livro,
					dt_referencia,
					nr_seq_reg_auxiliar,
					nr_seq_segurado,
					nr_seq_grupo_ans,
					dt_emissao,
					dt_vencimento,
					nr_cpf_cnpj_adic,
					nr_titulo,
					nr_linha,
					nr_seq_pagador,
					nr_seq_prestador,
					nr_seq_protocolo,
					ie_tipo_evento,
					ie_tipo_compartilhamento,
                                        ie_tipo_repasse,
					dt_inicio_compartilhamento,
					dt_fim_compartilhamento,
					ds_observacao,
					vl_deferido,
					cd_abi,
					nr_aih)
				values (	nextval('w_ctb_livro_aux_event_liq_seq'),
					clock_timestamp(),
					nm_usuario_p,
					clock_timestamp(),
					nm_usuario_p,
					vet_medica.nr_documento,
					vet_medica.ie_tipo_protocolo,
					obter_valor_dominio(3648,vet_medica.ie_tipo_protocolo),
					vet_medica.cd_material_ops,
					vet_medica.cd_procedimento,
					vet_medica.ie_origem_proced,
					vet_medica.ds_item_mat_proc,
					vet_medica.dt_ocorrencia,
					vet_medica.dt_conhecimento,
					vet_medica.cd_beneficiario,
					vet_medica.nm_beneficiario,
					vet_medica.nm_usuario_princ,
					vet_medica.ie_tipo_segurado,
					obter_valor_dominio(2406,vet_medica.ie_tipo_segurado),
					vet_medica.nm_prestador,
					vet_medica.cd_cpf_cgc,
					vet_medica.ds_operacao,
					vet_medica.ie_tipo_documento,
					obter_valor_dominio(8372,vet_medica.ie_tipo_documento),
					vet_medica.ds_grupo_ans,
					vet_medica.nr_protocolo_ans,
					vet_medica.ds_tipo_vinculo_operadora,
					vet_medica.ie_ato_cooperado,
					obter_valor_dominio(3418,vet_medica.ie_ato_cooperado),
					vet_medica.ie_modalidade_contrat,
					obter_valor_dominio(1669,vet_medica.ie_modalidade_contrat),
					vet_medica.ie_regulamentacao,
					obter_valor_dominio(2157,vet_medica.ie_regulamentacao),
					vet_medica.ie_tipo_contratacao,
					obter_valor_dominio(1666,vet_medica.ie_tipo_contratacao),
					vet_medica.ie_segmentacao,
					obter_valor_dominio(1665,vet_medica.ie_segmentacao),
					vet_medica.vl_evento,
					vet_medica.vl_pagamento,
					vet_medica.vl_ajuste,
					vet_medica.vl_glosa,
					coalesce(vet_medica.vl_coparticipacao,0),
					vet_medica.vl_taxa_pgto,
					vet_medica.dt_contabilizacao,
					vet_medica.dt_liquidacao,
					cd_conta_debito_w,
					cd_conta_credito_w,
					vet_medica.nr_contrato,
					7,
					dt_final_w,
					nr_seq_regra_p,
					vet_medica.nr_seq_segurado,
					vet_medica.nr_seq_grupo_ans,
					dt_emissao_w,
					dt_vencimento_w,
					vet_medica.nr_cpf_cnpj_adic,
					nr_titulo_w,
					nr_contador_w,
					vet_medica.nr_seq_titular,
					vet_medica.nr_seq_prestador,
					vet_medica.nr_seq_protocolo,
					vet_medica.ie_tipo_grupo_ans,
					ie_tipo_compartilhamento_w,
                                        ie_tipo_repasse_w,
					dt_repasse_w,
					dt_fim_repasse_w,
					ds_observacao_item_w,
					vet_medica.vl_deferido,
					vet_medica.cd_abi,
					vet_medica.nr_aih);
				
			if (mod(nr_contador_w, 1000) = 0) then
				commit;
			end if;
			
			end;
		end loop;
		close c_movimento;	
		end;
	end loop;
	close c_medica;
	
	update	ctb_livro_auxiliar
	set	qt_registros	= nr_contador_w
	where	nr_sequencia	= nr_seq_regra_p;
		
	commit;

end if;

if (ie_gerar_arquivo_p = 'S') then
	begin
	nm_arquivo_w	:= 'RegAuxEventosConhecidosAvisados' || to_char(clock_timestamp(),'ddmmyyyyhh24miss') || nm_usuario_p || '.csv';
	ds_nome_livro_w	:= 'Registro Auxiliar de Eventos Conhecidos ou Avisados';
	ds_periodo_w	:= wheb_mensagem_pck.get_texto(1098702, 'DT_INICIAL='|| dt_inicial_w || ';DT_FINAL='|| dt_final_w || ';DT_LIBERACAO='|| dt_liberacao_p);
	
	SELECT * FROM obter_evento_utl_file(1, null, ds_local_w, ds_erro_w) INTO STRICT ds_local_w, ds_erro_w;

	arq_texto_w := utl_file.fopen(ds_local_w,nm_arquivo_w,'W', 32000);

	utl_file.put_line(arq_texto_w, ds_nome_livro_w);
	utl_file.put_line(arq_texto_w, ds_periodo_w);
	utl_file.put_line(arq_texto_w, obter_desc_expressao(1080517));
	utl_file.fflush(arq_texto_w);
	for vetl in c_linha loop
		begin
		utl_file.put_line(arq_texto_w,vetl.ds_linha);
		utl_file.fflush(arq_texto_w);
		end;
	end loop;
	end;
end if;

commit;

CALL wheb_usuario_pck.set_ie_executar_trigger('S');

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ctb_gerar_aux_event_conhec_cop ( nm_usuario_p usuario.nm_usuario%type, cd_empresa_p empresa.cd_empresa%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, dt_inicial_p ctb_livro_auxiliar.dt_inicial%type, dt_final_p ctb_livro_auxiliar.dt_final%type, dt_liberacao_p ctb_livro_auxiliar.dt_liberacao%type, ie_gerar_arquivo_p ctb_livro_auxiliar.ie_tipo_livro_ecd%type, nr_seq_regra_p ctb_livro_auxiliar.nr_sequencia%type, ie_tipo_segurado_p pls_conta.ie_tipo_segurado%type, ie_tipo_protocolo_p pls_protocolo_conta.ie_tipo_protocolo%type, ie_gerar_ind_classif_p ctb_livro_auxiliar.ie_tipo_livro_ecd%type) FROM PUBLIC;

