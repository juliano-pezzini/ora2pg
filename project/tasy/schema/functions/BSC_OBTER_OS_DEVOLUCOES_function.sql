-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION bsc_obter_os_devolucoes (dt_inicial_p timestamp, dt_final_p timestamp) RETURNS bigint AS $body$
DECLARE

 
 
pr_devolucoes_w		double precision;


BEGIN 
 
SELECT round((SUM(qt_voltas)/SUM(total_os) * 100)::numeric,2) perc_voltas 
into STRICT	pr_devolucoes_w 
FROM (SELECT COUNT(*) qt_voltas, 
		  0 total_os 
	FROM (SELECT a.nr_sequencia, 
		    obter_qt_volta_os(a.nr_sequencia) qt_volta_os 
	   FROM  man_ordem_servico_v a, 
	      man_estagio_processo b 
	   WHERE a.nr_seq_estagio = b.nr_sequencia 
	   AND  b.ie_desenv = 'S' 
	   and a.dt_ordem_servico between dt_inicial_p and dt_final_p) alias6 
	WHERE qt_volta_os > 1 
	
UNION ALL
 
	SELECT 0 qt_voltas, 
	    COUNT(*) total_os 
	FROM  man_ordem_servico_v a, 
		  man_estagio_processo b 
	WHERE a.nr_seq_estagio = b.nr_sequencia 
	AND  b.ie_desenv = 'S' 
	and a.dt_ordem_servico between dt_inicial_p and dt_final_p) alias8;
 
return pr_devolucoes_w;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION bsc_obter_os_devolucoes (dt_inicial_p timestamp, dt_final_p timestamp) FROM PUBLIC;

