-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION pls_obter_qt_benef_municipio ( cd_municipio_ibge_p bigint, nr_seq_contrato_p bigint, ie_opcao_p text) RETURNS bigint AS $body$
DECLARE


/*
ie_opcao_p:
	'TM' 	= Titular masc.
	'TF' 	= Titular fem.
	'TT' 	= Titular total
	'DM' 	= Dependente masc.
	'DF' 	= Dependente fem.
	'DT' 	= Dependente total
	'AM' 	= Agregado masc.
	'AF' 	= Agregado fem.
	'AT' 	= Agregado total
	'T' 	= Total

	'TTM' 	= Totalizador titular masc.
	'TTF' 	= Totalizador titular fem.
	'TTT' 	= Totalizador titular total
	'TDM' 	= Totalizador dependente masc.
	'TDF' 	= Totalizador dependente fem.
	'TDT' 	= Totalizador dependente total
	'TAM' 	= Totalizador agregado masc.
	'TAF' 	= Totalizador agregado fem.
	'TAT' 	= Totalizador agregado total
	'TT' 	= Totalizador total
*/
ds_retorno_w	bigint;


BEGIN

if (ie_opcao_p IS NOT NULL AND ie_opcao_p::text <> '') then
	if (ie_opcao_p in ('TM', 'TF', 'TT', 'DM', 'DF', 'DT', 'AM', 'AF', 'AT', 'T')) then

		select	count(*)
		into STRICT	ds_retorno_w
		from	sus_municipio		d,
			compl_pessoa_fisica	c,
			pessoa_fisica		b,
			pls_segurado		a
		where	a.cd_pessoa_fisica 	= b.cd_pessoa_fisica
		and	b.cd_pessoa_fisica 	= c.cd_pessoa_fisica
		and	c.cd_municipio_ibge 	= d.cd_municipio_ibge
		and	a.nr_seq_contrato 	= nr_seq_contrato_p
		and	d.cd_municipio_ibge	= cd_municipio_ibge_p
		and	c.ie_tipo_complemento 	= 1
		and	coalesce(a.dt_rescisao::text, '') = ''
		and	coalesce(a.dt_cancelamento::text, '') = ''
		and	((ie_opcao_p = 'TM' and coalesce(a.nr_seq_titular::text, '') = '' and b.ie_sexo = 'M')
		or (ie_opcao_p = 'TF' and coalesce(a.nr_seq_titular::text, '') = '' and b.ie_sexo = 'F')
		or (ie_opcao_p = 'TT' and coalesce(a.nr_seq_titular::text, '') = '')
		or (ie_opcao_p = 'DM' and (a.nr_seq_titular IS NOT NULL AND a.nr_seq_titular::text <> '') and b.ie_sexo = 'M' and (coalesce(a.ie_tipo_parentesco,1) = 1 and a.nr_seq_parentesco <> 125))
		or (ie_opcao_p = 'DF' and (a.nr_seq_titular IS NOT NULL AND a.nr_seq_titular::text <> '') and b.ie_sexo = 'F' and (coalesce(a.ie_tipo_parentesco,1) = 1 and a.nr_seq_parentesco <> 125))
		or (ie_opcao_p = 'DT' and (a.nr_seq_titular IS NOT NULL AND a.nr_seq_titular::text <> '') and (coalesce(a.ie_tipo_parentesco,1) = 1 and a.nr_seq_parentesco <> 125))
		or (ie_opcao_p = 'AM' and (a.nr_seq_titular IS NOT NULL AND a.nr_seq_titular::text <> '') and b.ie_sexo = 'M' and (a.ie_tipo_parentesco = 2 or a.nr_seq_parentesco = 125))
		or (ie_opcao_p = 'AF' and (a.nr_seq_titular IS NOT NULL AND a.nr_seq_titular::text <> '') and b.ie_sexo = 'F' and (a.ie_tipo_parentesco = 2 or a.nr_seq_parentesco = 125))
		or (ie_opcao_p = 'AT' and (a.nr_seq_titular IS NOT NULL AND a.nr_seq_titular::text <> '') and (a.ie_tipo_parentesco = 2 or a.nr_seq_parentesco = 125))
		or (ie_opcao_p = 'T'));

	elsif (ie_opcao_p in ('TTM', 'TTF', 'TTT', 'TDM', 'TDF', 'TDT', 'TAM', 'TAF', 'TAT', 'Total')) then

		select	count(*)
		into STRICT	ds_retorno_w
		from	sus_municipio		d,
			compl_pessoa_fisica	c,
			pessoa_fisica		b,
			pls_segurado		a
		where	a.cd_pessoa_fisica 	= b.cd_pessoa_fisica
		and	b.cd_pessoa_fisica 	= c.cd_pessoa_fisica
		and	c.cd_municipio_ibge 	= d.cd_municipio_ibge
		and	a.nr_seq_contrato 	= nr_seq_contrato_p
		and	c.ie_tipo_complemento 	= 1
		and	coalesce(a.dt_rescisao::text, '') = ''
		and	coalesce(a.dt_cancelamento::text, '') = ''
		and	((ie_opcao_p = 'TTM' and coalesce(a.nr_seq_titular::text, '') = '' and b.ie_sexo = 'M')
		or (ie_opcao_p = 'TTF' and coalesce(a.nr_seq_titular::text, '') = '' and b.ie_sexo = 'F')
		or (ie_opcao_p = 'TTT' and coalesce(a.nr_seq_titular::text, '') = '')
		or (ie_opcao_p = 'TDM' and (a.nr_seq_titular IS NOT NULL AND a.nr_seq_titular::text <> '') and b.ie_sexo = 'M' and (coalesce(a.ie_tipo_parentesco,1) = 1 and a.nr_seq_parentesco <> 125))
		or (ie_opcao_p = 'TDF' and (a.nr_seq_titular IS NOT NULL AND a.nr_seq_titular::text <> '') and b.ie_sexo = 'F' and (coalesce(a.ie_tipo_parentesco,1) = 1 and a.nr_seq_parentesco <> 125))
		or (ie_opcao_p = 'TDT' and (a.nr_seq_titular IS NOT NULL AND a.nr_seq_titular::text <> '') and (coalesce(a.ie_tipo_parentesco,1) = 1 and a.nr_seq_parentesco <> 125))
		or (ie_opcao_p = 'TAM' and (a.nr_seq_titular IS NOT NULL AND a.nr_seq_titular::text <> '') and b.ie_sexo = 'M' and (a.ie_tipo_parentesco = 2 or a.nr_seq_parentesco = 125))
		or (ie_opcao_p = 'TAF' and (a.nr_seq_titular IS NOT NULL AND a.nr_seq_titular::text <> '') and b.ie_sexo = 'F' and (a.ie_tipo_parentesco = 2 or a.nr_seq_parentesco = 125))
		or (ie_opcao_p = 'TAT' and (a.nr_seq_titular IS NOT NULL AND a.nr_seq_titular::text <> '') and (a.ie_tipo_parentesco = 2 or a.nr_seq_parentesco = 125))
		or (ie_opcao_p = 'Total'));

	end if;

end if;

return	ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION pls_obter_qt_benef_municipio ( cd_municipio_ibge_p bigint, nr_seq_contrato_p bigint, ie_opcao_p text) FROM PUBLIC;

