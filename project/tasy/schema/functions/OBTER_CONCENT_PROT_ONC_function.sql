-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_concent_prot_onc ( nr_seq_paciente_p bigint, nr_seq_material_p bigint, ie_opcao_p text) RETURNS varchar AS $body$
DECLARE


cd_material_w				integer;
qt_dose_medic_w				double precision;
qt_dose_prescr_w			double precision;
qt_dose_prescr_dil_w		double precision;
qt_dose_reconst_w			double precision;
qt_dose_diluente_w			double precision;
qt_dose_rediluente_w		double precision;
qt_concent_ml_w				double precision := 0;
qt_concentracao_ml_w		double precision;
qt_concentracao_min_ml_w	double precision;
qt_conversao_w				double precision;
cd_unidade_medida_dose_w	varchar(30);
ds_concentracao_ml_w		varchar(255);
ds_concentracao_ml_final_w	varchar(255);
ds_concentracao_min_ml_w	varchar(255);
retorno_w					varchar(255);
qt_solucao_w				double precision;
ie_via_aplicacao_w			varchar(5);
cd_setor_atendimento_w		integer;
qt_idade_w					double precision;
qt_peso_w					double precision;
qt_concentracao_w			double precision;
ds_unid_med_mat_prescr_w	varchar(255);
ds_unid_med_cons_volume_w	varchar(255);
cd_unid_med_cons_peso_w		varchar(30);
cd_unid_med_mat_reconst_w	varchar(30);
cd_estabelecimento_w		bigint;
cd_protocolo_w				bigint;
nr_Seq_medicacao_w			integer;
ie_agrupador_w				smallint;


BEGIN

cd_estabelecimento_w 	:= wheb_usuario_pck.get_cd_estabelecimento;
cd_setor_atendimento_w  := wheb_usuario_pck.get_cd_setor_atendimento;

/*material, Concentracao, dose e unidade de medida  */

select	max(cd_material),
		max(CD_UNID_MED_PRESCR),
		coalesce(max(obter_conversao_ml(cd_material, qt_dose_prescr,CD_UNID_MED_PRESCR)),0),
		max(ie_via_aplicacao),
		max(qt_dose_prescr)
into STRICT	cd_material_w,
		cd_unidade_medida_dose_w,
		qt_dose_medic_w,
		ie_via_aplicacao_w,
		qt_dose_prescr_w
from	paciente_protocolo_medic
where	nr_seq_paciente = nr_seq_paciente_p
and		nr_seq_material = nr_seq_material_p;


select	max(coalesce(qt_conversao,0))
into STRICT	qt_conversao_w
from	material_conversao_unidade
where	upper(cd_unidade_medida) = upper(OBTER_UNID_MED_USUA('ML'))
and		cd_material = cd_material_w;

select	max(coalesce(CASE WHEN upper(CD_UNID_MED_BASE_CONC)=(upper(OBTER_UNID_MED_USUA('ML'))) THEN  coalesce(QT_CONVERSAO_MG,0)  ELSE dividir(QT_CONVERSAO_MG, qt_conversao_w) END ,0))
into STRICT	qt_concentracao_w
from	material
where	cd_material	= cd_material_w;

select	max(obter_idade(b.dt_nascimento,coalesce(b.dt_obito,clock_timestamp()),'M')),
		max(coalesce(a.qt_peso,0)),
		max(a.cd_protocolo),
		max(a.nr_seq_medicacao)
into STRICT	qt_idade_w,
		qt_peso_w,
		cd_protocolo_w,
		nr_seq_medicacao_w	
from	paciente_Setor a,

		pessoa_fisica b

where	b.cd_pessoa_fisica = a.cd_pessoa_fisica
and		a.nr_seq_paciente = nr_seq_paciente_p;

qt_idade_w	:= dividir(qt_idade_w,12);

select	coalesce(max(qt_concentracao),0),
		coalesce(max(qt_concentracao_min),0),
		max(substr(obter_desc_unid_med(cd_unid_med_cons_volume),1,255)),
		max(cd_unid_med_cons_peso)
into STRICT	qt_concentracao_ml_w,
		qt_concentracao_min_ml_w,
		ds_unid_med_cons_volume_w,
		cd_unid_med_cons_peso_w
from	material_prescr
where	coalesce(cd_setor_atendimento, coalesce(cd_setor_atendimento_w,0)) = coalesce(cd_setor_atendimento_w,0)
and		coalesce(cd_protocolo, coalesce(cd_protocolo_w,0)) = coalesce(cd_protocolo_w,0)
and		coalesce(nr_seq_medicacao, coalesce(nr_seq_medicacao_w,0)) = coalesce(nr_seq_medicacao_w,0)
and		coalesce(ie_via_aplicacao, coalesce(ie_via_aplicacao_w,0)) = coalesce(ie_via_aplicacao_w,0)
and		qt_idade_w between coalesce(qt_idade_min,0) and coalesce(qt_idade_max,999)
and		qt_peso_w between coalesce(qt_peso_min,0) and coalesce(qt_peso_max,999)
and		(qt_concentracao IS NOT NULL AND qt_concentracao::text <> '')
and		((coalesce(cd_estabelecimento::text, '') = '') or (cd_estabelecimento = cd_estabelecimento_w))
and		ie_tipo = '2'
and		cd_material = cd_material_w;

if	--(qt_dose_medic_w > 0) and
	((qt_concentracao_ml_w > 0) or (qt_concentracao_min_ml_w > 0)) and (qt_concentracao_w > 0) then
	
	select	coalesce(max(qt_conversao),0)
	into STRICT	qt_conversao_w
	from	material_conversao_unidade
	where	cd_material = cd_material_w
	and	upper(cd_unidade_medida) = upper(OBTER_UNID_MED_USUA('ML'));
	
	/*Reconstituicao*/

	select  max(coalesce(obter_conversao_ml(cd_material, qt_dose,CD_UNID_MED_PRESCR),0)),
			max(substr(obter_desc_unid_med(CD_UNID_MED_PRESCR),1,255)),
			max(ie_agrupador),
			max(QT_DOSE)
	into STRICT	qt_dose_reconst_w,
			ds_unid_med_mat_prescr_w,
			ie_agrupador_w,
			qt_dose_prescr_dil_w
	from	paciente_protocolo_medic
	where	nr_seq_paciente = nr_seq_paciente_p
	and		nr_seq_diluicao	= nr_seq_material_p;
	
	if (qt_dose_medic_w > 0) or (qt_dose_reconst_w > 0) then
		/*Diluicao*/

		
		if (ie_agrupador_w <> 3) then
		
			select  max(coalesce(obter_conversao_ml(cd_material, qt_dose,CD_UNID_MED_PRESCR),0))
			into STRICT	qt_dose_diluente_w
			from	paciente_protocolo_medic
			where	nr_seq_paciente 		= nr_seq_paciente_p
			and		nr_seq_diluicao	= nr_seq_material_p
			and		ie_agrupador = 3;
			
		end if;

		/*Rediluicao*/

		
		if (ie_agrupador_w <> 7) then
		
			select  max(coalesce(obter_conversao_ml(cd_material, qt_dose,CD_UNID_MED_PRESCR),0)),
					max(coalesce(qt_dose_prescr,0))
			into STRICT	qt_dose_rediluente_w,
					qt_solucao_w
			from	paciente_protocolo_medic
			where	nr_seq_paciente 		= nr_seq_paciente_p
			and		nr_seq_diluicao	= nr_seq_material_p
			and		ie_agrupador = 7;

			
		end if;
		
		qt_concent_ml_w	:= qt_concentracao_w;
		
		if (qt_dose_reconst_w > 0) then
			qt_concent_ml_w := dividir(qt_dose_prescr_dil_w, (qt_dose_medic_w + qt_dose_prescr_dil_w));			
		end if;
				
		if (qt_dose_diluente_w > 0) then
			qt_concent_ml_w := dividir((qt_concent_ml_w * qt_dose_medic_w), qt_dose_diluente_w + qt_dose_medic_w);
		end if;

		if (qt_dose_rediluente_w > 0) then
			qt_concent_ml_w := dividir((qt_concent_ml_w * qt_solucao_w), qt_solucao_w + qt_dose_rediluente_w);
		end if;
		
		if	((qt_concent_ml_w > qt_concentracao_ml_w) or (qt_concent_ml_w < qt_concentracao_min_ml_w)) then
			
			 ds_concentracao_ml_w := replace(to_char(qt_concentracao_ml_w,'FM999.0009'),'.',',');
			 ds_concentracao_min_ml_w := replace(to_char(qt_concentracao_min_ml_w,'FM999.0009'),'.',',');
			 ds_concentracao_ml_final_w := replace(to_char(qt_concent_ml_w,'FM999.0009'),'.',',');
			
			 if (trunc(qt_concentracao_ml_w) = 0) then
				ds_concentracao_ml_w := '0'|| replace(to_char(qt_concentracao_ml_w,'FM999.0009'),'.',',');
			 end if;
			
			 if (trunc(qt_concentracao_min_ml_w) = 0) then
				ds_concentracao_min_ml_w := '0'|| replace(to_char(qt_concentracao_min_ml_w,'FM999.0009'),'.',',');
			 end if;
			
			 if (trunc(qt_concent_ml_w) = 0) then
				ds_concentracao_ml_final_w := '0'|| replace(to_char(qt_concent_ml_w,'FM999.0009'),'.',',');
			 end if;
			
			if (ie_opcao_p	=  'M') then
				if (qt_concent_ml_w > qt_concentracao_ml_w) then
					retorno_w	:= substr(obter_desc_expressao(727000)||' ( '||ds_concentracao_ml_final_w|| ' ) '||obter_desc_expressao(727002)|| ds_concentracao_ml_w ||' '||cd_unidade_medida_dose_w ||obter_desc_expressao(727006)||ds_unid_med_mat_prescr_w||'.',1,255);
				elsif (qt_concent_ml_w < qt_concentracao_min_ml_w) then
					retorno_w	:= substr(obter_desc_expressao(727000)||' ( '||ds_concentracao_ml_final_w|| ' ) '||obter_desc_expressao(727004)|| ds_concentracao_min_ml_w ||' '||cd_unidade_medida_dose_w ||obter_desc_expressao(727006)||ds_unid_med_mat_prescr_w||'.',1,255);
				end if;
			else				
			   retorno_w	:= 'S';
			end if;
		end if;
	end if;
end if;

return retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_concent_prot_onc ( nr_seq_paciente_p bigint, nr_seq_material_p bigint, ie_opcao_p text) FROM PUBLIC;

