-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION pls_obter_vinc_medico_prest ( cd_medico_p text, nr_seq_prestador_p bigint, dt_procedimento_p timestamp) RETURNS varchar AS $body$
DECLARE


ds_retorno_w			varchar(2)	:= 'S';
qt_credenciado_w		bigint;
ie_tipo_vinculo_w		varchar(1);

BEGIN

select	count(1)
into STRICT	qt_credenciado_w
from	pls_prestador_medico
where	cd_medico		= cd_medico_p
and	ie_tipo_vinculo		= 'C'
and	nr_seq_prestador	= nr_seq_prestador_p;
if (qt_credenciado_w = 0) then
	select	max(a.ie_tipo_historico)
	into STRICT 	ie_tipo_vinculo_w
	from	pls_credenciamento_hist a
	where	a.nr_seq_prestador = nr_seq_prestador_p
	and	a.cd_pessoa_fisica 	= cd_medico_p
	and	trunc(a.dt_historico,'dd') >= trunc(dt_procedimento_p,'dd')
	and	a.dt_historico = (	SELECT min(x.dt_historico)
					from	pls_credenciamento_hist x
					where	x.nr_seq_prestador = nr_seq_prestador_p
					and	x.cd_pessoa_fisica 	= cd_medico_p
					and	trunc(x.dt_historico,'dd') >= trunc(dt_procedimento_p,'dd'));
	if (coalesce(ie_tipo_vinculo_w,'C') = 'D') then
		select	count(1)
		into STRICT	qt_credenciado_w
		from	pls_prestador_medico
		where	cd_medico		= cd_medico_p
		--and	ie_situacao		= 'A'
		and	nr_seq_prestador	= nr_seq_prestador_p
		and	trunc(dt_procedimento_p) >= trunc(coalesce(dt_inclusao,dt_procedimento_p),'dd')
		and 	trunc(dt_procedimento_p) < trunc(coalesce(dt_exclusao,dt_procedimento_p+1));

		if (qt_credenciado_w = 0) then
			ds_retorno_w 	:= 'X';
		else
			ds_retorno_w	:= 'C';
			goto final;
		end if;
	end if;
end if;

select  coalesce(max(ie_tipo_vinculo),'X')
into STRICT    ds_retorno_w
from    pls_prestador_medico
where   cd_medico               = cd_medico_p
and	nr_seq_prestador	= nr_seq_prestador_p
--and	ie_situacao		= 'A'
and	trunc(coalesce(dt_procedimento_p,clock_timestamp()),'dd') between trunc(coalesce(dt_inclusao,clock_timestamp()),'dd') and  fim_dia(coalesce(dt_exclusao,clock_timestamp()));

if (ds_retorno_w	= 'X') then
	select  coalesce(max(ie_tipo_vinculo),'X')
	into STRICT    ds_retorno_w
	from    pls_prestador
	where   cd_pessoa_fisica	= cd_medico_p
	and	nr_sequencia		= nr_seq_prestador_p;
end if;

<<final>>
return	ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION pls_obter_vinc_medico_prest ( cd_medico_p text, nr_seq_prestador_p bigint, dt_procedimento_p timestamp) FROM PUBLIC;

