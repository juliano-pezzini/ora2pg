-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';



CREATE TYPE campos AS (ds_dias_aplicacao	varchar(6));


CREATE OR REPLACE FUNCTION obter_prim_dia_trat_onc (nr_seq_paciente_p bigint) RETURNS bigint AS $body$
DECLARE

type Vetor is table of campos index by integer;


ds_dias_aplicacao_w	varchar(4000);
ds_dias_aplicacao_ww	varchar(4000);
i 			integer;
y 			integer;
k 			integer	:= 1;
z 			integer;
X			varchar(1);
r			integer := 1;
cont_w			bigint;
posicao_w			bigint;

ds_valido_w 		varchar(13)		:= '0123456789D,-';
ds_texto_w		varchar(255);
dia_w			bigint		:= 9999999;
dia_retorno_w		bigint		:= 9999999;

dias_w			Vetor;

C01 CURSOR FOR
	SELECT	a.ds_dias_aplicacao
	from	paciente_protocolo_medic a
	where	a.nr_seq_paciente	= nr_seq_paciente_p
	and	coalesce(a.nr_seq_diluicao::text, '') = ''
	
union

	SELECT	a.ds_dias_aplicacao
	from	paciente_protocolo_proc a
	where	a.nr_seq_paciente	= nr_seq_paciente_p
	
union

	select	a.ds_dias_aplicacao
	from	paciente_protocolo_soluc a
	where	a.nr_seq_paciente	= nr_seq_paciente_p;


BEGIN
open C01;
loop
fetch C01 into
	ds_dias_aplicacao_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	ds_dias_aplicacao_w	:= Replace(ds_dias_aplicacao_w,' ','');
		ds_texto_w		:= '';
		FOR y IN 1..length(ds_dias_aplicacao_w) LOOP
			X	:= substr(upper(ds_dias_aplicacao_w), y, 1);
			if (position(X in ds_valido_w) > 0) then
				ds_texto_w	:= ds_texto_w || X;
			else
				-- Erro na padronização dos horários do mat/med
				CALL Wheb_mensagem_pck.exibir_mensagem_abort(264522);
			end if;
		END LOOP;
	end;

	ds_dias_aplicacao_w	:= ds_texto_w;
	z	:= 0;
	ds_dias_aplicacao_w	:= ds_dias_aplicacao_w ||',';
	cont_w	:= 0;
	dias_w.delete;

	while	(ds_dias_aplicacao_w IS NOT NULL AND ds_dias_aplicacao_w::text <> '') LOOP
		begin
		posicao_w	:= position(',' in ds_dias_aplicacao_w);
		z := z + 1;
		dias_w[z].ds_dias_aplicacao	:= substr(ds_dias_aplicacao_w,1,posicao_w - 1);
		ds_dias_aplicacao_w		:= substr(ds_dias_aplicacao_w,posicao_w + 1,length(ds_dias_aplicacao_w));
		cont_w	:= cont_w + 1;
		if (cont_w > 100) then
			exit;
		end if;
		end;
	end loop;

	for i in 1..dias_w.count loop
		begin
		dia_w	:= substr(dias_w[i].ds_dias_aplicacao,2,length(dias_w[i].ds_dias_aplicacao));
		if (dia_w	<= dia_retorno_w) then
			dia_retorno_w	:= dia_w;
		end if;
		end;
	end loop;

end loop;
close C01;

if (dia_retorno_w	>= 9999999) then
	dia_retorno_w	:= 1;
end if;

return	dia_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION obter_prim_dia_trat_onc (nr_seq_paciente_p bigint) FROM PUBLIC;

