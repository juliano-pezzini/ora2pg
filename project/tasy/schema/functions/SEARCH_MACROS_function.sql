-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION search_macros ( cd_function_p bigint, ds_macro_p text, ds_locale_p text, ie_type_return_p text) RETURNS SETOF SEARCH_MACROS_TABLE AS $body$
DECLARE
 TYPE cursor_ref REFCURSOR;
			
/*
ie_type_return_p
'P' = Present
'R' = Replace		
*/
			
	
search_macros_r		search_macros_row := search_macros_row(null,null,null,null,null);

ds_macro_w			varchar(255);
nr_seq_macro_w		bigint;
ds_macro_cliente_w	varchar(255);
nr_seq_macro_cliente_w	bigint;
ds_locale_w			varchar(20);
ie_encontrou_macro_w	varchar(1);

cursor_macro CURSOR FOR
SELECT 	nr_sequencia,
		ds_macro
from	funcao_macro
where	cd_funcao = coalesce(cd_function_p, cd_funcao)
and	coalesce(ie_situacao,'A') = 'A'
and	ds_macro = coalesce(ds_macro_p, ds_macro)
and 	(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '');

cursor_macro_client CURSOR FOR
SELECT 	nr_sequencia,
	ds_macro,
	ds_locale
from   	funcao_macro_cliente
where  	nr_seq_macro = nr_seq_macro_w
and    	upper(coalesce(ds_locale,'0')) = upper(coalesce(ds_locale_p,'0'))
and    	coalesce(dt_inativacao::text, '') = ''
and    	(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '');

cursor_macro_subst CURSOR FOR
SELECT 	nr_sequencia,
	ds_macro
from	funcao_macro
where	cd_funcao = coalesce(cd_function_p, cd_funcao)
and	ds_macro = coalesce(ds_macro_p, ds_macro)
and 	(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '');

cursor_macro_client_subst CURSOR FOR
SELECT 	nr_sequencia,
		ds_macro,
		ds_locale
from   	funcao_macro_cliente
where  	nr_seq_macro = nr_seq_macro_w
and    	coalesce(dt_inativacao::text, '') = ''
and    	(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '');
	

BEGIN
if (ie_type_return_p = 'P') then
	begin
	open cursor_macro;
	loop
	fetch cursor_macro into
		nr_seq_macro_w,
		ds_macro_w;
	EXIT WHEN NOT FOUND; /* apply on cursor_macro */
		begin
		ie_encontrou_macro_w := 'N';
		open cursor_macro_client;
		loop
		fetch cursor_macro_client into
			nr_seq_macro_cliente_w,
			ds_macro_cliente_w,
			ds_locale_w;
		EXIT WHEN NOT FOUND; /* apply on cursor_macro_client */
			begin
			ie_encontrou_macro_w := 'S';
			search_macros_r := search_macros_row(ds_macro_w,nr_seq_macro_w,ds_macro_cliente_w,nr_seq_macro_cliente_w,ds_locale_w);
			RETURN NEXT search_macros_r;
			end;
		end loop;
		close cursor_macro_client;
		
		if (ie_encontrou_macro_w <> 'S') then
			begin
			search_macros_r := search_macros_row(ds_macro_w,nr_seq_macro_w,ds_macro_w,null,ds_locale_w);
			RETURN NEXT search_macros_r;
			end;
		end if;
		
		end;
	end loop;
	close cursor_macro;
	end;
else
	begin
	open cursor_macro_subst;
	loop
	fetch cursor_macro_subst into	
		nr_seq_macro_w,
		ds_macro_w;
	EXIT WHEN NOT FOUND; /* apply on cursor_macro_subst */
		begin
		search_macros_r := search_macros_row(ds_macro_w,nr_seq_macro_w,ds_macro_w,null,ds_locale_w);
		RETURN NEXT search_macros_r;
		
		open cursor_macro_client_subst;
		loop
		fetch cursor_macro_client_subst into	
			nr_seq_macro_cliente_w,
			ds_macro_cliente_w,
			ds_locale_w;
		EXIT WHEN NOT FOUND; /* apply on cursor_macro_client_subst */
			begin
			search_macros_r := search_macros_row(ds_macro_w,nr_seq_macro_w,ds_macro_cliente_w,nr_seq_macro_cliente_w,ds_locale_w);
			RETURN NEXT search_macros_r;		
			end;
		end loop;
		close cursor_macro_client_subst;
		end;
	end loop;
	close cursor_macro_subst;
	end;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION search_macros ( cd_function_p bigint, ds_macro_p text, ds_locale_p text, ie_type_return_p text) FROM PUBLIC;

