-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_dados_lote_audit_item (nr_seq_audit_item_p bigint, ie_opcao_p text) RETURNS varchar AS $body$
DECLARE


ds_retorno_w		varchar(255);
nr_seq_ret_glosa_w	bigint;
vl_item_w		double precision;
qt_item_w		lote_audit_hist_item.qt_item%type;
qt_item_conta_w		lote_audit_hist_item.qt_item%type;
cd_item_w		bigint;
vl_unit_item_w		double precision;
nr_seq_propaci_w	procedimento_paciente.nr_sequencia%type;
nr_seq_matpaci_w	material_atend_paciente.nr_sequencia%type;
nr_conta_w		conta_paciente.nr_interno_conta%type;
ie_origem_w		procedimento_paciente.ie_origem_proced%type;
nr_doc_conv_w		conta_paciente_guia.cd_autorizacao%type;
qt_mesmo_cod_w		procedimento_paciente.qt_procedimento%type;
/*
ie_opcao_p	
	'AT' - Atendimento
	'AU' - Autorizacao
	'CO' - Conta
	'CP' - Codigo Procedimento
	'CPL' - Codigo Procedimento Localizacao
	'CM' - Codigo Material
	'DP' - Procedimento
	'DM' - Material
	'PF' - Paciente
	'IT' - Descricao do item
	'ITCC' - Descricao do item com codigo
	'VR' - Valor reversao
	'CMGRG' - Codigo material GRG
	'DEGRG' - Data de execusao GRG
	'VO' - Valor original
	'SA' - Setor atendimento
*/
BEGIN

select	coalesce(max(nr_seq_ret_glosa), 0),
	coalesce(max(qt_item),0)
into STRICT	nr_seq_ret_glosa_w,
	qt_item_w
from	lote_audit_hist_item
where	nr_sequencia	= nr_seq_audit_item_p;

ds_retorno_w		:= '';
if (nr_seq_ret_glosa_w > 0) then
	if (ie_opcao_p = 'AT') then
		select	max(c.nr_atendimento)
		into STRICT	ds_retorno_w
		from	conta_paciente c,
			convenio_retorno_item b,
			convenio_retorno_glosa a
		where	b.nr_interno_conta	= c.nr_interno_conta
		and	a.nr_seq_ret_item	= b.nr_sequencia
		and	a.nr_sequencia		= nr_seq_ret_glosa_w;
	elsif (ie_opcao_p = 'AU') then
		select	max(b.cd_autorizacao)
		into STRICT	ds_retorno_w
		from	convenio_retorno_item b,
			convenio_retorno_glosa a
		where	a.nr_seq_ret_item	= b.nr_sequencia
		and	a.nr_sequencia		= nr_seq_ret_glosa_w;
	elsif (ie_opcao_p = 'CO') then
		select	max(b.nr_interno_conta)
		into STRICT	ds_retorno_w
		from	convenio_retorno_item b,
			convenio_retorno_glosa a
		where	a.nr_seq_ret_item	= b.nr_sequencia
		and	a.nr_sequencia		= nr_seq_ret_glosa_w;
	elsif (ie_opcao_p = 'CP') then
		select	max(a.cd_procedimento)
		into STRICT	ds_retorno_w
		from	convenio_retorno_glosa a
		where	a.nr_sequencia		= nr_seq_ret_glosa_w;
	elsif (ie_opcao_p = 'CPL') then
		select	max(b.cd_procedimento_loc)
		into STRICT	ds_retorno_w
		from	convenio_retorno_glosa a,
			procedimento b
		where	b.cd_procedimento = a.cd_procedimento
		and     b.ie_origem_proced = a.ie_origem_proced
		and     a.nr_sequencia = nr_seq_ret_glosa_w;
	elsif (ie_opcao_p = 'CM') then
		select	max(a.cd_material)
		into STRICT	ds_retorno_w
		from	convenio_retorno_glosa a
		where	a.nr_sequencia		= nr_seq_ret_glosa_w;
	elsif (ie_opcao_p = 'DP') then
		select	max(obter_descricao_procedimento(a.cd_procedimento, a.ie_origem_proced))
		into STRICT	ds_retorno_w
		from	convenio_retorno_glosa a
		where	a.nr_sequencia		= nr_seq_ret_glosa_w;
	elsif (ie_opcao_p = 'DM') then
		select	max(obter_desc_material(a.cd_material))
		into STRICT	ds_retorno_w
		from	convenio_retorno_glosa a
		where	a.nr_sequencia		= nr_seq_ret_glosa_w;
	elsif (ie_opcao_p = 'PF') then
		select	substr(obter_nome_pf(e.cd_pessoa_fisica), 1, 255)
		into STRICT	ds_retorno_w
		from	pessoa_fisica e,
			atendimento_paciente d,
			conta_paciente c,
			convenio_retorno_item b,
			convenio_retorno_glosa a
		where	d.cd_pessoa_fisica	= e.cd_pessoa_fisica
		and	c.nr_atendimento	= d.nr_atendimento
		and	b.nr_interno_conta	= c.nr_interno_conta
		and	a.nr_seq_ret_item	= b.nr_sequencia
		and	a.nr_sequencia		= nr_seq_ret_glosa_w;
	end if;

end if;

if (ie_opcao_p = 'IT') then

	select	max(ds_item)
	into STRICT	ds_retorno_w
	from (SELECT	substr(obter_desc_proc_conta(a.nr_seq_propaci),1,255) ds_item
		from	lote_audit_hist_item a
		where	a.nr_sequencia	= nr_seq_audit_item_p
		and	(a.nr_seq_propaci IS NOT NULL AND a.nr_seq_propaci::text <> '')
		
union

		SELECT	substr(obter_desc_matpaci(a.nr_seq_matpaci),1,255) ds_item
		from	lote_audit_hist_item a
		where	a.nr_sequencia	= nr_seq_audit_item_p
		and	(a.nr_seq_matpaci IS NOT NULL AND a.nr_seq_matpaci::text <> '')) alias8;

elsif (ie_opcao_p = 'ITCC') then

	select	max(ds_item)
	into STRICT	ds_retorno_w
	from (SELECT	substr(a.cd_procedimento_pac || ' - ' || obter_desc_proc_conta(a.nr_seq_propaci),1,255) ds_item
		from	lote_audit_hist_item a
		where	a.nr_sequencia	= nr_seq_audit_item_p
		and	(a.nr_seq_propaci IS NOT NULL AND a.nr_seq_propaci::text <> '')
		
union

		SELECT	substr(a.cd_material_atend_paciente || ' - ' || obter_desc_matpaci(a.nr_seq_matpaci),1,255) ds_item
		from	lote_audit_hist_item a
		where	a.nr_sequencia	= nr_seq_audit_item_p
		and	(a.nr_seq_matpaci IS NOT NULL AND a.nr_seq_matpaci::text <> '')) alias8;
		
elsif (ie_opcao_p = 'VR') then

	select	coalesce(sum(vl_item),0)
	into STRICT	vl_item_w
	from (SELECT	coalesce(b.vl_procedimento,0) vl_item
		from	procedimento_paciente b,
			lote_audit_hist_item a
		where	a.nr_sequencia		= nr_seq_audit_item_p
		and	a.nr_seq_propaci_partic	= b.nr_sequencia
		
union all

		SELECT	coalesce(b.vl_material,0) vl_item
		from	material_atend_paciente b,
			lote_audit_hist_item a
		where	a.nr_sequencia		= nr_seq_audit_item_p
		and	a.nr_seq_matpaci_partic	= b.nr_sequencia) alias5;

	ds_retorno_w	:= vl_item_w;

elsif (ie_opcao_p = 'CMGRG') then

	select	max(b.cd_material)
	into STRICT	ds_retorno_w
	from	material_atend_paciente b,
		lote_audit_hist_item a
	where	a.nr_sequencia		= nr_seq_audit_item_p
	and	a.nr_seq_matpaci	= b.nr_sequencia;

elsif (ie_opcao_p = 'DEGRG') then

	select	max(dt_execusao)
	into STRICT	ds_retorno_w
	from (SELECT	b.dt_procedimento dt_execusao
		from	procedimento_paciente b,
			lote_audit_hist_item a
		where	a.nr_seq_propaci	= b.nr_sequencia
		and	a.nr_sequencia	= nr_seq_audit_item_p
		
union

		SELECT	b.dt_prescricao dt_execusao
		from	material_atend_paciente b,
			lote_audit_hist_item a
		where	a.nr_seq_matpaci	= b.nr_sequencia
		and	a.nr_sequencia	= nr_seq_audit_item_p) alias2;
		
elsif (ie_opcao_p = 'VO') then

	if (coalesce(nr_seq_ret_glosa_w,0) > 0) then
	
		select	coalesce(sum(vl_cobrado),0)
		into STRICT	ds_retorno_w
		from	convenio_retorno_glosa
		where	nr_sequencia	= nr_seq_ret_glosa_w;
	
	else	
		begin
		select	x.vl_item,
			x.cd_item,
			x.qt_item,
			x.vl_unit_item,
			x.nr_seq_propaci,
			x.nr_seq_matpaci,
			x.nr_conta,
			x.ie_origem,
			x.nr_doc_conv
		into STRICT	vl_item_w,
			cd_item_w,
			qt_item_conta_w,
			vl_unit_item_w,
			nr_seq_propaci_w,
			nr_seq_matpaci_w,
			nr_conta_w,
			ie_origem_w,
			nr_doc_conv_w
		from (SELECT	x.vl_procedimento vl_item,
				x.cd_procedimento cd_item,
				x.qt_procedimento qt_item,
				0 vl_unit_item,
				0 nr_seq_matpaci,
				x.nr_sequencia nr_seq_propaci,
				x.nr_interno_conta nr_conta,
				x.ie_origem_proced ie_origem,
				coalesce(x.nr_doc_convenio,'0') nr_doc_conv
			from	procedimento_paciente x,
				lote_audit_hist_item a
			where	x.nr_sequencia	= a.nr_seq_propaci
			and	a.nr_sequencia	= nr_seq_audit_item_p
			
union

			SELECT	x.vl_material vl_item,
				x.cd_material cd_item,
				x.qt_material qt_item,
				coalesce(x.vl_unitario,0) vl_unit_item,
				x.nr_sequencia nr_seq_matpaci,
				0 nr_seq_propaci,
				x.nr_interno_conta nr_conta,
				0 ie_origem,
				coalesce(x.nr_doc_convenio,'0') nr_doc_conv
			from	material_atend_paciente x,
				lote_audit_hist_item a
			where	x.nr_sequencia	= a.nr_seq_matpaci		
			and	a.nr_sequencia	= nr_seq_audit_item_p) x
		where	1 = 1;
		exception
		when others then
			vl_item_w 		:= 0;
			cd_item_w 		:= 0;
			qt_item_conta_w 	:= 0;
			vl_unit_item_w 		:= 0;
			nr_seq_propaci_w 	:= 0;
			nr_seq_matpaci_w 	:= 0;
			nr_conta_w		:= 0;
			ie_origem_w		:= 0;
			nr_doc_conv_w		:= '0';
			ds_retorno_w		:= 0;
		end;
		
		
		if (nr_seq_matpaci_w > 0) then
		
			if (qt_item_w <> qt_item_conta_w)and (vl_unit_item_w > 0)then
				
				ds_retorno_w := (qt_item_w * vl_unit_item_w);
			else
				ds_retorno_w := coalesce(vl_item_w,0);				
			end if;
		elsif (nr_seq_propaci_w > 0) then
			
			if (qt_item_w <> qt_item_conta_w) then
				select	dividir(sum(a.vl_procedimento),sum(a.qt_procedimento)),
					sum(qt_procedimento) qt_mesmo_cod
				into STRICT	vl_unit_item_w,
					qt_mesmo_cod_w
				from	procedimento_paciente a
				where	coalesce(a.cd_motivo_exc_conta::text, '') = ''
				and	a.cd_procedimento = cd_item_w
				and	a.ie_origem_proced = ie_origem_w
				and	a.nr_interno_conta = nr_conta_w
				and	coalesce(a.nr_doc_convenio,nr_doc_conv_w)  = nr_doc_conv_w
				and	a.vl_procedimento = vl_item_w;
				
				if (qt_mesmo_cod_w = qt_item_w) then
					ds_retorno_w := (qt_item_w * vl_unit_item_w);
				else	
					ds_retorno_w := coalesce(vl_item_w,0);
				end if;
				
				
				
			else	
				ds_retorno_w := coalesce(vl_item_w,0);
			end if;
		
		end if;
		
	end if;
	
elsif (ie_opcao_p = 'SA') then

	select	max(cd_setor_atendimento)
	into STRICT	ds_retorno_w
	from (
		SELECT	max(x.cd_setor_atendimento) cd_setor_atendimento
		from	procedimento_paciente x,
			lote_audit_hist_item a
		where	x.nr_sequencia		= a.nr_seq_propaci
		and	a.nr_sequencia		= nr_seq_audit_item_p
		
union

		SELECT	max(x.cd_setor_atendimento) cd_setor_atendimento
		from	material_atend_paciente x,
			lote_audit_hist_item a
		where	x.nr_sequencia		= a.nr_seq_matpaci
		and	a.nr_sequencia		= nr_seq_audit_item_p) alias4;

end if;

return	ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_dados_lote_audit_item (nr_seq_audit_item_p bigint, ie_opcao_p text) FROM PUBLIC;

