-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_se_agenda_horario_disp (cd_agenda_p bigint, dt_agenda_p timestamp) RETURNS varchar AS $body$
DECLARE


ie_horario_w		varchar(1) := 'N';
qt_hor_agenda_w	bigint;
ie_dia_semana_w	smallint;
ie_feriado_w		varchar(1);
nr_seq_esp_w		bigint;
ie_hor_adic_w		varchar(1);


BEGIN
if (cd_agenda_p IS NOT NULL AND cd_agenda_p::text <> '') and (dt_agenda_p IS NOT NULL AND dt_agenda_p::text <> '') and (trunc(dt_agenda_p,'dd') >= trunc(clock_timestamp(),'dd')) then
	/* agendamento */


	/* --> Rafael em 11/04/2008 OS87657;
	select	count(*)
	into	qt_hor_agenda_w
	from	agenda_paciente
	where	cd_agenda = cd_agenda_p
	and	dt_agenda between trunc(dt_agenda_p) and trunc(dt_agenda_p) + 86399/86400;

	if	(qt_hor_agenda_w > 0) then
		select	decode(count(*),0,'N','S')
		into	ie_horario_w
		from	agenda_paciente
		where	cd_agenda = cd_agenda_p
		and	dt_agenda between trunc(dt_agenda_p) and trunc(dt_agenda_p) + 86399/86400
		and	ie_status_agenda = 'L';
	else
	*/
	/* dia semana */
		select	obter_cod_dia_semana(dt_agenda_p)
		into STRICT	ie_dia_semana_w
		;

		/* feriado */

		select	CASE WHEN count(*)=0 THEN 'N'  ELSE 'S' END
		into STRICT	ie_feriado_w
		from	feriado a,
			agenda b
		where	a.cd_estabelecimento = obter_estab_agenda(cd_agenda_p)
		and	a.dt_feriado = dt_agenda_p
		and	b.cd_agenda = cd_agenda_p;
		
		/* horario especial */

		select	coalesce(max(nr_sequencia),0),
			coalesce(max(ie_horario_adicional),'N')
		into STRICT	nr_seq_esp_w,
			ie_hor_adic_w
		from	agenda_horario_esp
		where	cd_agenda = cd_agenda_p
		and	((ie_dia_semana = ie_dia_semana_w) or ((ie_dia_semana = 9) and (ie_dia_semana_w not in (1,7))) or (coalesce(ie_dia_semana::text, '') = ''))
		and dt_agenda_p between pkg_date_utils.start_of(dt_agenda,'DAY') and pkg_date_utils.end_of(coalesce(dt_agenda_fim,dt_agenda),'DAY');

		/* cadastro */

		select	CASE WHEN count(*)=0 THEN 'N'  ELSE 'S' END
		into STRICT	ie_horario_w
		from	agenda_horario a
		where	cd_agenda = cd_agenda_p
		and	((dt_dia_semana = ie_dia_semana_w) or (dt_dia_semana = 9))
		and	((nr_seq_esp_w = 0) or (ie_hor_adic_w = 'S'))
		and	((coalesce(dt_final_vigencia::text, '') = '') or (dt_final_vigencia >= trunc(dt_agenda_p)))
		and	((coalesce(dt_inicio_vigencia::text, '') = '') or (dt_inicio_vigencia <= trunc(dt_agenda_p)))
		and	to_char(hr_inicial,'hh24:mi:ss') < to_char(hr_final,'hh24:mi:ss')
		and	coalesce(nr_minuto_intervalo,0) > 0
		and	ie_feriado_w <> 'S';

		/* horario especial */

		if (ie_horario_w = 'N') then
			select	CASE WHEN count(*)=0 THEN 'N'  ELSE 'S' END
			into STRICT	ie_horario_w
			from 	agenda_horario_esp a
			where	hr_inicial < hr_final
			and	coalesce(nr_minuto_intervalo,0) > 0
			and	cd_agenda = cd_agenda_p
			and	((ie_dia_semana = ie_dia_semana_w) or ((ie_dia_semana = 9) and (ie_dia_semana_w not in (1,7))) or (coalesce(ie_dia_semana::text, '') = ''))
			and dt_agenda_p between pkg_date_utils.start_of(dt_agenda,'DAY') and pkg_date_utils.end_of(coalesce(dt_agenda_fim,dt_agenda),'DAY');
		end if;
	/*end if;*/

end if;

return ie_horario_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_se_agenda_horario_disp (cd_agenda_p bigint, dt_agenda_p timestamp) FROM PUBLIC;

