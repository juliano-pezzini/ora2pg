-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION exibir_alerta_job_copia (nm_usuario_p usuario.nm_usuario%type, cd_funcao_p bigint) RETURNS varchar AS $body$
DECLARE


	ie_exibir_alerta_w	varchar(1);
	ie_retorno_w		varchar(1);
	qt_count_acesso_w 	integer;
	qt_count_job_w 		integer;
	qt_count_itens_w	integer;
	ie_job_parada_w 	varchar(1);
	qt_falha_w 			integer;
	ie_base_philips_w 	varchar(1);
	ie_cpoe_ativa_w 	varchar(1);
	dt_inicio_filtro_w	timestamp;
	dt_fim_filtro_w		timestamp;
	cd_funcao_cpoe_w 	constant prescr_medica.cd_funcao_origem%type := 2314;
    ds_processo_job_w   constant log_cpoe.ds_processo%type := 'JOB';

	cItensCPOE CURSOR FOR
	SELECT count(*) total_reg
	  from (SELECT 1
			  from cpoe_material a
			 where a.dt_prox_geracao between dt_inicio_filtro_w and dt_fim_filtro_w
			   and (((coalesce(a.dt_fim::text, '') = '') and (a.ie_duracao = 'C')) or (a.dt_fim > dt_fim_filtro_w))
			   and (a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
			   and (a.nr_atendimento IS NOT NULL AND a.nr_atendimento::text <> '')
			   and coalesce(a.dt_suspensao::text, '') = ''
			   and coalesce(a.dt_lib_suspensao::text, '') = ''
			   and coalesce(a.nr_seq_receita_amb, 0) = 0
			   and coalesce(a.ie_retrogrado, 'N') = 'N'
			   and coalesce(a.cd_funcao_origem, cd_funcao_cpoe_w) = cd_funcao_cpoe_w
			 
union all

			select 1
			  from cpoe_dieta a
			 where a.dt_prox_geracao between dt_inicio_filtro_w and dt_fim_filtro_w
			   and (((coalesce(a.dt_fim::text, '') = '') and (a.ie_duracao = 'C')) or (a.dt_fim > dt_fim_filtro_w))
			   and (a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
			   and (a.nr_atendimento IS NOT NULL AND a.nr_atendimento::text <> '')
			   and coalesce(a.dt_suspensao::text, '') = ''
			   and coalesce(a.dt_lib_suspensao::text, '') = ''
			   and coalesce(a.ie_retrogrado, 'N') = 'N'
			   and coalesce(a.ie_dose_unica,'N') = 'N'
			   and coalesce(a.cd_funcao_origem, cd_funcao_cpoe_w) = cd_funcao_cpoe_w 
			 
union all

			select 1
			  from cpoe_recomendacao a
			 where a.dt_prox_geracao between dt_inicio_filtro_w and dt_fim_filtro_w
			   and (((coalesce(a.dt_fim::text, '') = '') and (a.ie_duracao = 'C')) or (a.dt_fim > dt_fim_filtro_w))
			   and (a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
			   and (a.nr_atendimento IS NOT NULL AND a.nr_atendimento::text <> '')
			   and coalesce(a.dt_suspensao::text, '') = ''
			   and coalesce(a.dt_lib_suspensao::text, '') = ''
			   and coalesce(a.ie_retrogrado, 'N') = 'N'
			   and coalesce(a.cd_funcao_origem, cd_funcao_cpoe_w) = cd_funcao_cpoe_w 
			 
union all

			select 1
			  from cpoe_gasoterapia a
			 where a.dt_prox_geracao between dt_inicio_filtro_w and dt_fim_filtro_w
			   and (((coalesce(a.dt_fim::text, '') = '') and (a.ie_duracao = 'C')) or (a.dt_fim > dt_fim_filtro_w))
			   and (a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
			   and (a.nr_atendimento IS NOT NULL AND a.nr_atendimento::text <> '')
			   and coalesce(a.dt_suspensao::text, '') = ''
			   and coalesce(a.dt_lib_suspensao::text, '') = ''
			   and coalesce(a.ie_retrogrado, 'N') = 'N'
			   and coalesce(a.cd_funcao_origem, cd_funcao_cpoe_w) = cd_funcao_cpoe_w 
			 
union all

			select 1
			  from cpoe_procedimento a
			 where a.dt_prox_geracao between dt_inicio_filtro_w and dt_fim_filtro_w
			   and (((coalesce(a.dt_fim::text, '') = '') and (a.ie_duracao = 'C')) or (a.dt_fim > dt_fim_filtro_w))
			   and (a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
			   and (a.nr_atendimento IS NOT NULL AND a.nr_atendimento::text <> '')
			   and coalesce(a.dt_suspensao::text, '') = ''
			   and coalesce(a.dt_lib_suspensao::text, '') = ''
			   and coalesce(a.ie_retrogrado, 'N') = 'N'
			   and coalesce(a.cd_funcao_origem, cd_funcao_cpoe_w) = cd_funcao_cpoe_w 
			 
union all

			select 1
			  from cpoe_dialise a
			 where a.dt_prox_geracao between dt_inicio_filtro_w and dt_fim_filtro_w
			   and (((coalesce(a.dt_fim::text, '') = '') and (a.ie_duracao = 'C')) or (a.dt_fim > dt_fim_filtro_w))
			   and (a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
			   and (a.nr_atendimento IS NOT NULL AND a.nr_atendimento::text <> '')
			   and coalesce(a.dt_suspensao::text, '') = ''
			   and coalesce(a.dt_lib_suspensao::text, '') = ''
			   and coalesce(a.ie_retrogrado, 'N') = 'N'
			   and coalesce(a.cd_funcao_origem, cd_funcao_cpoe_w) = cd_funcao_cpoe_w 
	   LIMIT 1) alias75;

BEGIN
	dt_inicio_filtro_w	:= clock_timestamp() - interval '3 days';
	dt_fim_filtro_w		:= clock_timestamp() + interval '1 days';
	ie_retorno_w := 'N';
	qt_count_acesso_w := 0;
	qt_count_itens_w := 0;
    ie_base_philips_w := coalesce(obter_se_base_wheb,'N');

	select	coalesce(max(a.ie_exibir_alerta_job_copia),'S')
	into STRICT	ie_exibir_alerta_w
	from	parametro_medico a
	where	a.cd_estabelecimento = obter_estabelecimento_ativo;

    if (ie_exibir_alerta_w = 'S' and ie_base_philips_w = 'N') then
        select coalesce(max(obter_se_exibir_fun_html5_tasy( obter_se_base_wheb,
                                                       obter_estabelecimento_ativo,
                                                       cd_funcao,
                                                       ie_situacao,
                                                       ie_status_html,
                                                       ie_versao_uso)),'N')
          into STRICT ie_cpoe_ativa_w
          from funcao
         where cd_funcao = cd_funcao_cpoe_w;

        if (ie_cpoe_ativa_w = 'S') then
    
            /* Para a CPOE ira exibir o alerta somente no primeiro acesso do dia para o usuario */

            if (cd_funcao_p = cd_funcao_cpoe_w) then
                select count(*)
                  into STRICT qt_count_acesso_w
                  from log_acesso_funcao a
                 where a.cd_funcao = cd_funcao_p
                   and a.nm_usuario = nm_usuario_p
                   and a.dt_acesso >= trunc(clock_timestamp());
            end if;

            if (qt_count_acesso_w = 0) then
                select count(*),
                       coalesce(max(a.parada),'N'),
                       coalesce(max(a.falhas),0)
                  into STRICT qt_count_job_w,
                       ie_job_parada_w,
                       qt_falha_w
                  from job_v a
                 where lower(a.comando) like 'cpoe_copiar_itens_%';

                if ((qt_count_job_w = 0) or (ie_job_parada_w <> 'N') or (qt_falha_w > 0)) then
                    
                    select count(*)
                      into STRICT qt_count_job_w
                      from log_cpoe a
                     where a.dt_atualizacao > trunc(clock_timestamp()) - 2
                       and a.ds_processo = ds_processo_job_w;

                    if (qt_count_job_w = 0) then
						/* Verifica se tem algum item prescrito na CPOE */

						for cItensCPOE_w in cItensCPOE
						loop
							qt_count_itens_w := cItensCPOE_w.total_reg;
						end loop;
						
						if (qt_count_itens_w > 0) then
							ie_retorno_w := 'S';
						end if;
                    end if;
                end if;
            end if;
        end if;
    end if;

	return ie_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION exibir_alerta_job_copia (nm_usuario_p usuario.nm_usuario%type, cd_funcao_p bigint) FROM PUBLIC;

