-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION pls_obter_vl_plano_proposta ( nr_seq_proposta_benef_p bigint, nr_seq_plano_p bigint) RETURNS bigint AS $body$
DECLARE


vl_retorno_w		double precision := 0;
vl_proposta_sca_w		double precision := 0;
vl_total_proposta_sca_w	double precision := 0;
nr_seq_tabela_sca_w	bigint;
nr_seq_titular_w		bigint;
nr_seq_titular_contrato_w	bigint;
nr_contrato_w		bigint;
nr_seq_contrato_w		bigint;
qt_idade_benef_w		smallint;
cd_beneficiario_w		varchar(15);
ie_beneficiario_titular_w	varchar(10);
ie_grau_parentesco_w	varchar(2);
ie_grau_dependencia_w	varchar(2);
dt_contratacao_w		timestamp;
dt_inicio_proposta_w	timestamp;


C01 CURSOR FOR
	SELECT	nr_seq_tabela
	from	pls_plano_servico_adic a
	where	nr_seq_plano		= nr_seq_plano_p
	and	dt_contratacao_w 		between coalesce(dt_inicio_vigencia, dt_contratacao_w) and coalesce(dt_fim_vigencia, dt_contratacao_w)
	and	((ie_grau_dependencia_w 	= ie_grau_dependencia) or (ie_grau_dependencia = 'A'))
	and	not exists (	SELECT	1
				from	pls_sca_vinculo		x,
					pls_proposta_beneficiario	y
				where	x.nr_seq_benef_proposta	= y.nr_sequencia
				and	y.nr_sequencia		= nr_seq_proposta_benef_p
				and	x.nr_seq_tabela		= a.nr_seq_tabela);

C02 CURSOR FOR
	SELECT	nr_seq_tabela
	from	pls_sca_regra_contrato a
	where	nr_seq_contrato		= nr_seq_contrato_w
	and	dt_inicio_proposta_w 	between coalesce(dt_inicio_vigencia,dt_inicio_proposta_w) and fim_dia(coalesce(dt_fim_vigencia,dt_inicio_proposta_w))
	and	((coalesce(ie_geracao_valores,'B') 	= ie_beneficiario_titular_w) or coalesce(ie_geracao_valores,'B') = 'B')
	and	not exists (	SELECT	1
				from	pls_sca_vinculo		x,
					pls_proposta_beneficiario	y
				where	x.nr_seq_benef_proposta	= y.nr_sequencia
				and	y.nr_sequencia		= nr_seq_proposta_benef_p
				and	x.nr_seq_tabela		= a.nr_seq_tabela);

C03 CURSOR FOR
	SELECT	a.nr_seq_tabela
	from	pls_sca_vinculo		a,
		pls_proposta_beneficiario	b
	where	a.nr_seq_benef_proposta	= b.nr_sequencia
	and	b.nr_sequencia		= nr_seq_proposta_benef_p;

C04 CURSOR FOR
	SELECT	coalesce(vl_preco_atual,0)
	from	pls_plano_preco
	where	nr_seq_tabela				= nr_seq_tabela_sca_w
	and	qt_idade_benef_w 				between qt_idade_inicial and qt_idade_final
	and	coalesce(ie_grau_titularidade,ie_grau_parentesco_w)	= ie_grau_parentesco_w
	order by	coalesce(ie_grau_titularidade,' ');


BEGIN
select	a.cd_beneficiario,
	coalesce(a.dt_contratacao, b.dt_inicio_proposta),
	a.nr_seq_titular,
	a.nr_seq_titular_contrato,
	b.nr_seq_contrato,
	dt_inicio_proposta,
	CASE WHEN coalesce(nr_seq_titular::text, '') = '' THEN CASE WHEN coalesce(nr_seq_titular_contrato::text, '') = '' THEN 'T'  ELSE 'D' END   ELSE 'D' END
into STRICT	cd_beneficiario_w,
	dt_contratacao_w,
	nr_seq_titular_w,
	nr_seq_titular_contrato_w,
	nr_contrato_w,
	dt_inicio_proposta_w,
	ie_beneficiario_titular_w
from	pls_proposta_beneficiario	a,
	pls_proposta_adesao	b
where	a.nr_seq_proposta		= b.nr_sequencia
and	a.nr_sequencia		= nr_seq_proposta_benef_p
and	coalesce(a.dt_cancelamento::text, '') = '';

if (nr_contrato_w IS NOT NULL AND nr_contrato_w::text <> '') then
	select	max(nr_sequencia)
	into STRICT	nr_seq_contrato_w
	from	pls_contrato
	where	nr_contrato = nr_contrato_w;
end if;

if (coalesce(nr_seq_titular_w::text, '') = '' and coalesce(nr_seq_titular_contrato_w::text, '') = '') then
	ie_grau_dependencia_w 	:= 'T';
else
	ie_grau_dependencia_w 	:= 'D';
end if;

select	substr(Obter_Idade_PF(cd_beneficiario_w,clock_timestamp(),'A'),1,3)
into STRICT	qt_idade_benef_w
;

ie_grau_parentesco_w	:= coalesce(substr(pls_obter_garu_dependencia_seg(nr_seq_proposta_benef_p,'P'),1,2),'X');

open C01;
loop
fetch C01 into
	nr_seq_tabela_sca_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	open C04;
	loop
	fetch C04 into
		vl_proposta_sca_w;
	EXIT WHEN NOT FOUND; /* apply on C04 */
		begin
		vl_total_proposta_sca_w 	:= vl_total_proposta_sca_w + vl_proposta_sca_w;
		end;
	end loop;
	close C04;
	end;
end loop;
close C01;

if (nr_seq_contrato_w IS NOT NULL AND nr_seq_contrato_w::text <> '') then
	begin
	open C02;
	loop
	fetch C02 into
		nr_seq_tabela_sca_w;
	EXIT WHEN NOT FOUND; /* apply on C02 */
		begin
		open C04;
		loop
		fetch C04 into
			vl_proposta_sca_w;
		EXIT WHEN NOT FOUND; /* apply on C04 */
			begin
			vl_total_proposta_sca_w 	:= vl_total_proposta_sca_w + vl_proposta_sca_w;
			end;
		end loop;
		close C04;
		end;
	end loop;
	close C02;
	end;
end if;

open C03;
loop
fetch C03 into
	nr_seq_tabela_sca_w;
EXIT WHEN NOT FOUND; /* apply on C03 */
	begin
	open C04;
	loop
	fetch C04 into
		vl_proposta_sca_w;
	EXIT WHEN NOT FOUND; /* apply on C04 */
		begin
		vl_total_proposta_sca_w 	:= vl_total_proposta_sca_w + vl_proposta_sca_w;
		end;
	end loop;
	close C04;
	end;
end loop;
close C03;



vl_retorno_w	:= vl_total_proposta_sca_w;

return vl_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION pls_obter_vl_plano_proposta ( nr_seq_proposta_benef_p bigint, nr_seq_plano_p bigint) FROM PUBLIC;

