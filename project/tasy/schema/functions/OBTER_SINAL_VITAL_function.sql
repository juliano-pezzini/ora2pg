-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_sinal_vital ( nr_atendimento_p bigint, ie_sinal_p text) RETURNS bigint AS $body$
DECLARE


vl_retorno_w		double precision;
nr_atend_alta_w		bigint;


BEGIN

if (nr_atendimento_p > 0) and (ie_sinal_p IS NOT NULL AND ie_sinal_p::text <> '') then
	begin
		
	if (upper(ie_sinal_p) = 'PESO') then
		select	max(qt_peso)
		into STRICT	vl_retorno_w
		from	atendimento_sinal_vital	
		where	nr_sequencia = (SELECT	coalesce(max(nr_sequencia),-1)
					from	atendimento_sinal_vital
					where	(qt_peso IS NOT NULL AND qt_peso::text <> '')
					and	nr_atendimento	= nr_atendimento_p
					and	coalesce(ie_situacao,'A') = 'A'
					and	coalesce(IE_RN,'N')	= 'N');
	elsif (ie_sinal_p = 'FC') then
		select	max(qt_freq_cardiaca)
		into STRICT	vl_retorno_w
		from	atendimento_sinal_vital	
		where	nr_sequencia = (SELECT	coalesce(max(nr_sequencia),-1)
					from	atendimento_sinal_vital
					where	(qt_freq_cardiaca IS NOT NULL AND qt_freq_cardiaca::text <> '')
					and	nr_atendimento	= nr_atendimento_p
					and	coalesce(ie_situacao,'A') = 'A'
					and	coalesce(IE_RN,'N')	= 'N');
	elsif (ie_sinal_p = 'FR') then
		select	max(qt_freq_resp)
		into STRICT	vl_retorno_w
		from	atendimento_sinal_vital	
		where	nr_sequencia = (SELECT	coalesce(max(nr_sequencia),-1)
					from	atendimento_sinal_vital
					where	(qt_freq_resp IS NOT NULL AND qt_freq_resp::text <> '')
					and	nr_atendimento	= nr_atendimento_p
					and	coalesce(ie_situacao,'A') = 'A'
					and	coalesce(IE_RN,'N')	= 'N');
	elsif (ie_sinal_p = 'PAMIN') then
		select	max(qt_pa_diastolica)
		into STRICT	vl_retorno_w
		from	atendimento_sinal_vital	
		where	nr_sequencia = (SELECT	coalesce(max(nr_sequencia),-1)
					from	atendimento_sinal_vital
					where	(qt_pa_diastolica IS NOT NULL AND qt_pa_diastolica::text <> '')
					and	(qt_pa_sistolica IS NOT NULL AND qt_pa_sistolica::text <> '')
					and	nr_atendimento	= nr_atendimento_p
					and	coalesce(ie_situacao,'A') = 'A'
					and	coalesce(IE_RN,'N')	= 'N');
	elsif (ie_sinal_p = 'PAMAX') then
		select	max(qt_pa_sistolica)
		into STRICT	vl_retorno_w
		from	atendimento_sinal_vital	
		where	nr_sequencia = (SELECT	coalesce(max(nr_sequencia),-1)
					from	atendimento_sinal_vital
					where	(qt_pa_sistolica IS NOT NULL AND qt_pa_sistolica::text <> '')
					and	(qt_pa_diastolica IS NOT NULL AND qt_pa_diastolica::text <> '')
					and	nr_atendimento	= nr_atendimento_p
					and	coalesce(ie_situacao,'A') = 'A'
					and	coalesce(IE_RN,'N')	= 'N');
	elsif (ie_sinal_p = 'SC') then
		select	max(qt_superf_corporia)
		into STRICT	vl_retorno_w
		from	atendimento_sinal_vital	
		where	nr_sequencia = (SELECT	coalesce(max(nr_sequencia),-1)
					from	atendimento_sinal_vital
					where	(qt_superf_corporia IS NOT NULL AND qt_superf_corporia::text <> '')
					and	nr_atendimento	= nr_atendimento_p
					and	coalesce(ie_situacao,'A') = 'A'
					and	coalesce(IE_RN,'N')	= 'N');
	elsif (ie_sinal_p = 'IMC') then
		select	max(qt_imc)
		into STRICT	vl_retorno_w
		from	atendimento_sinal_vital	
		where	nr_sequencia = (SELECT	coalesce(max(nr_sequencia),-1)
					from	atendimento_sinal_vital
					where	(qt_imc IS NOT NULL AND qt_imc::text <> '')
					and	nr_atendimento	= nr_atendimento_p
					and	coalesce(ie_situacao,'A') = 'A'
					and	coalesce(IE_RN,'N')	= 'N');
	elsif (upper(ie_sinal_p) = 'ALTURA') then
		select	max(qt_altura_cm)
		into STRICT	vl_retorno_w
		from	atendimento_sinal_vital	
		where	nr_sequencia = (SELECT	coalesce(max(nr_sequencia),-1)
					from	atendimento_sinal_vital
					where	(qt_altura_cm IS NOT NULL AND qt_altura_cm::text <> '')
					and	nr_atendimento	= nr_atendimento_p
					and	coalesce(ie_situacao,'A') = 'A'
					and	coalesce(IE_RN,'N')	= 'N');
	elsif (ie_sinal_p = 'ALTURA_M') then
				select	max(qt_altura_m)
				into STRICT	vl_retorno_w
				from	atendimento_sinal_vital	
				where	nr_sequencia = (SELECT	coalesce(max(nr_sequencia),-1)
							from	atendimento_sinal_vital
							where	(qt_altura_m IS NOT NULL AND qt_altura_m::text <> '')
							and	nr_atendimento	= nr_atendimento_p
							and	coalesce(ie_situacao,'A') = 'A'
							and	coalesce(IE_RN,'N')	= 'N');
	elsif (ie_sinal_p = 'Temp') then
		select	max(qt_temp)
		into STRICT	vl_retorno_w
		from	atendimento_sinal_vital
		where	nr_sequencia = (SELECT	coalesce(max(nr_sequencia),-1)
					from	atendimento_sinal_vital
					where	(qt_temp IS NOT NULL AND qt_temp::text <> '')
					and	nr_atendimento	= nr_atendimento_p
					and	coalesce(ie_situacao,'A') = 'A'
					and	coalesce(IE_RN,'N')	= 'N');
	elsif (ie_sinal_p = 'ESCDOR') then
		select	max(qt_escala_dor)
		into STRICT	vl_retorno_w
		from	atendimento_sinal_vital
		where	nr_sequencia = (SELECT	coalesce(max(nr_sequencia),-1)
					from	atendimento_sinal_vital
					where	(qt_escala_dor IS NOT NULL AND qt_escala_dor::text <> '')
					and	nr_atendimento	= nr_atendimento_p
					and	coalesce(ie_situacao,'A') = 'A'
					and	coalesce(IE_RN,'N')	= 'N');
	elsif (ie_sinal_p = 'PAM') then
		select	max(qt_pam)
		into STRICT	vl_retorno_w
		from	atendimento_sinal_vital
		where	nr_sequencia = (SELECT	coalesce(max(nr_sequencia),-1)
					from	atendimento_sinal_vital
					where	(qt_pam IS NOT NULL AND qt_pam::text <> '')
					and	nr_atendimento	= nr_atendimento_p
					and	coalesce(ie_situacao,'A') = 'A'
					and	coalesce(IE_RN,'N')	= 'N');					
	elsif (ie_sinal_p = 'GC') then
		select	max(qt_glicemia_capilar)
		into STRICT	vl_retorno_w
		from	atendimento_sinal_vital
		where	nr_sequencia = (SELECT	coalesce(max(nr_sequencia),-1)
					from	atendimento_sinal_vital
					where	(qt_glicemia_capilar IS NOT NULL AND qt_glicemia_capilar::text <> '')
					and	nr_atendimento	= nr_atendimento_p
					and	coalesce(ie_situacao,'A') = 'A'
					and	coalesce(IE_RN,'N')	= 'N');	
	elsif (ie_sinal_p = 'REDOR') then
		select	max(NR_SEQ_RESULT_DOR)
		into STRICT	vl_retorno_w
		from	atendimento_sinal_vital
		where	nr_sequencia = (SELECT	coalesce(max(nr_sequencia),-1)
					from	atendimento_sinal_vital
					where	(NR_SEQ_RESULT_DOR IS NOT NULL AND NR_SEQ_RESULT_DOR::text <> '')
					and	nr_atendimento	= nr_atendimento_p
					and	coalesce(ie_situacao,'A') = 'A'
					and	coalesce(IE_RN,'N')	= 'N');	
	elsif (ie_sinal_p = 'SAT') then
		select	max(qt_saturacao_o2)
		into STRICT	vl_retorno_w
		from	atendimento_sinal_vital
		where	nr_sequencia = (SELECT	coalesce(max(nr_sequencia),-1)
					from	atendimento_sinal_vital
					where	(qt_saturacao_o2 IS NOT NULL AND qt_saturacao_o2::text <> '')
					and	nr_atendimento	= nr_atendimento_p
					and	coalesce(ie_situacao,'A') = 'A'
					and	coalesce(IE_RN,'N')	= 'N');	
	elsif (ie_sinal_p = 'QT_ABD') then			
		select	max(qt_perimitro_abdominal)
		into STRICT	vl_retorno_w
		from	atendimento_sinal_vital
		where	nr_sequencia = (SELECT	coalesce(max(nr_sequencia), -1)
					from	atendimento_sinal_vital
					where	(qt_perimitro_abdominal IS NOT NULL AND qt_perimitro_abdominal::text <> '')
					and	nr_atendimento	= nr_atendimento_p
					and	coalesce(ie_situacao,'A') = 'A'
					and	coalesce(IE_RN,'N')	= 'N');
	elsif (ie_sinal_p = 'QT_QDR') then			
		select	max(qt_perimetro_quadril)
		into STRICT	vl_retorno_w
		from	atendimento_sinal_vital
		where	nr_sequencia = (SELECT	coalesce(max(nr_sequencia),-1)
					from	atendimento_sinal_vital
					where	(qt_perimetro_quadril IS NOT NULL AND qt_perimetro_quadril::text <> '')
					and	nr_atendimento	= nr_atendimento_p
					and	coalesce(ie_situacao,'A') = 'A'
					and	coalesce(IE_RN,'N')	= 'N');	
	elsif (ie_sinal_p = 'MEDICAO') then			
		select	max(ie_tipo_medicao)
		into STRICT	vl_retorno_w
		from	atendimento_sinal_vital
		where	nr_sequencia = (SELECT	coalesce(max(nr_sequencia),-1)
					from	atendimento_sinal_vital
					where	(ie_tipo_medicao IS NOT NULL AND ie_tipo_medicao::text <> '')
					and	nr_atendimento	= nr_atendimento_p
					and	coalesce(ie_situacao,'A') = 'A'
					and	coalesce(IE_RN,'N')	= 'N');	
	elsif (ie_sinal_p = 'CIRCUNFERENCIA') then			
		select	max(qt_circunf_cintura)
		into STRICT	vl_retorno_w
		from	atendimento_sinal_vital
		where	nr_sequencia = (SELECT	coalesce(max(nr_sequencia),-1)
					from	atendimento_sinal_vital
					where	(qt_circunf_cintura IS NOT NULL AND qt_circunf_cintura::text <> '')
					and	nr_atendimento	= nr_atendimento_p
					and	coalesce(ie_situacao,'A') = 'A'
					and	coalesce(IE_RN,'N')	= 'N');	
	end if;	
	
	end;

	if (coalesce(vl_retorno_w::text, '') = '') then

		select 	max(nr_atend_alta)
		into STRICT	nr_atend_alta_w
		from 	atendimento_paciente
		where	nr_atendimento = nr_atendimento_p;
		
		if (nr_atend_alta_w IS NOT NULL AND nr_atend_alta_w::text <> '') then
			begin
				
			if (ie_sinal_p = 'Peso') then
				select	max(qt_peso)
				into STRICT	vl_retorno_w
				from	atendimento_sinal_vital	
				where	nr_sequencia = (SELECT	coalesce(max(nr_sequencia),-1)
							from	atendimento_sinal_vital
							where	(qt_peso IS NOT NULL AND qt_peso::text <> '')
							and	nr_atendimento	= nr_atend_alta_w
							and	coalesce(ie_situacao,'A') = 'A'
							and	coalesce(IE_RN,'N')	= 'N');
			elsif (ie_sinal_p = 'FC') then
				select	max(qt_freq_cardiaca)
				into STRICT	vl_retorno_w
				from	atendimento_sinal_vital	
				where	nr_sequencia = (SELECT	coalesce(max(nr_sequencia),-1)
							from	atendimento_sinal_vital
							where	(qt_freq_cardiaca IS NOT NULL AND qt_freq_cardiaca::text <> '')
							and	nr_atendimento	= nr_atend_alta_w
							and	coalesce(ie_situacao,'A') = 'A'
							and	coalesce(IE_RN,'N')	= 'N');
			elsif (ie_sinal_p = 'FR') then
				select	max(qt_freq_resp)
				into STRICT	vl_retorno_w
				from	atendimento_sinal_vital	
				where	nr_sequencia = (SELECT	coalesce(max(nr_sequencia),-1)
							from	atendimento_sinal_vital
							where	(qt_freq_resp IS NOT NULL AND qt_freq_resp::text <> '')
							and	nr_atendimento	= nr_atend_alta_w
							and	coalesce(ie_situacao,'A') = 'A'
							and	coalesce(IE_RN,'N')	= 'N');
			elsif (ie_sinal_p = 'PAMIN') then
				select	max(qt_pa_diastolica)
				into STRICT	vl_retorno_w
				from	atendimento_sinal_vital	
				where	nr_sequencia = (SELECT	coalesce(max(nr_sequencia),-1)
							from	atendimento_sinal_vital
							where	(qt_pa_diastolica IS NOT NULL AND qt_pa_diastolica::text <> '')
							and	(qt_pa_sistolica IS NOT NULL AND qt_pa_sistolica::text <> '')
							and	nr_atendimento	= nr_atend_alta_w
							and	coalesce(ie_situacao,'A') = 'A'
							and	coalesce(IE_RN,'N')	= 'N');
			elsif (ie_sinal_p = 'PAMAX') then
				select	max(qt_pa_sistolica)
				into STRICT	vl_retorno_w
				from	atendimento_sinal_vital	
				where	nr_sequencia = (SELECT	coalesce(max(nr_sequencia),-1)
							from	atendimento_sinal_vital
							where	(qt_pa_sistolica IS NOT NULL AND qt_pa_sistolica::text <> '')
							and	(qt_pa_diastolica IS NOT NULL AND qt_pa_diastolica::text <> '')
							and	nr_atendimento	= nr_atend_alta_w
							and	coalesce(ie_situacao,'A') = 'A'
							and	coalesce(IE_RN,'N')	= 'N');
			elsif (ie_sinal_p = 'SC') then
				select	max(qt_superf_corporia)
				into STRICT	vl_retorno_w
				from	atendimento_sinal_vital	
				where	nr_sequencia = (SELECT	coalesce(max(nr_sequencia),-1)
							from	atendimento_sinal_vital
							where	(qt_superf_corporia IS NOT NULL AND qt_superf_corporia::text <> '')
							and	nr_atendimento	= nr_atend_alta_w
							and	coalesce(ie_situacao,'A') = 'A'
							and	coalesce(IE_RN,'N')	= 'N');
			elsif (ie_sinal_p = 'IMC') then
				select	max(qt_imc)
				into STRICT	vl_retorno_w
				from	atendimento_sinal_vital	
				where	nr_sequencia = (SELECT	coalesce(max(nr_sequencia),-1)
							from	atendimento_sinal_vital
							where	(qt_imc IS NOT NULL AND qt_imc::text <> '')
							and	nr_atendimento	= nr_atend_alta_w
							and	coalesce(ie_situacao,'A') = 'A'
							and	coalesce(IE_RN,'N')	= 'N');
			elsif (ie_sinal_p = 'Altura') then
				select	max(qt_altura_cm)
				into STRICT	vl_retorno_w
				from	atendimento_sinal_vital	
				where	nr_sequencia = (SELECT	coalesce(max(nr_sequencia),-1)
							from	atendimento_sinal_vital
							where	(qt_altura_cm IS NOT NULL AND qt_altura_cm::text <> '')
							and	nr_atendimento	= nr_atend_alta_w
							and	coalesce(ie_situacao,'A') = 'A'
							and	coalesce(IE_RN,'N')	= 'N');
			elsif (ie_sinal_p = 'Altura') then
				select	max(qt_altura_cm)
				into STRICT	vl_retorno_w
				from	atendimento_sinal_vital	
				where	nr_sequencia = (SELECT	coalesce(max(nr_sequencia),-1)
							from	atendimento_sinal_vital
							where	(qt_altura_cm IS NOT NULL AND qt_altura_cm::text <> '')
							and	nr_atendimento	= nr_atend_alta_w
							and	coalesce(ie_situacao,'A') = 'A'
							and	coalesce(IE_RN,'N')	= 'N');
			elsif (ie_sinal_p = 'Temp') then
				select	max(qt_temp)
				into STRICT	vl_retorno_w
				from	atendimento_sinal_vital
				where	nr_sequencia = (SELECT	coalesce(max(nr_sequencia),-1)
							from	atendimento_sinal_vital
							where	(qt_temp IS NOT NULL AND qt_temp::text <> '')
							and	nr_atendimento	= nr_atend_alta_w
							and	coalesce(ie_situacao,'A') = 'A'
							and	coalesce(IE_RN,'N')	= 'N');
			elsif (ie_sinal_p = 'ESCDOR') then
				select	max(qt_escala_dor)
				into STRICT	vl_retorno_w
				from	atendimento_sinal_vital
				where	nr_sequencia = (SELECT	coalesce(max(nr_sequencia),-1)
							from	atendimento_sinal_vital
							where	(qt_escala_dor IS NOT NULL AND qt_escala_dor::text <> '')
							and	nr_atendimento	= nr_atendimento_p
							and	coalesce(ie_situacao,'A') = 'A'
							and	coalesce(IE_RN,'N')	= 'N');
			elsif (ie_sinal_p = 'PAM') then
				select	max(qt_pam)
				into STRICT	vl_retorno_w
				from	atendimento_sinal_vital
				where	nr_sequencia = (SELECT	coalesce(max(nr_sequencia),-1)
							from	atendimento_sinal_vital
							where	(qt_pam IS NOT NULL AND qt_pam::text <> '')
							and	nr_atendimento	= nr_atendimento_p
							and	coalesce(ie_situacao,'A') = 'A'
							and	coalesce(IE_RN,'N')	= 'N');							
			elsif (ie_sinal_p = 'GC') then
				select	max(qt_glicemia_capilar)
				into STRICT	vl_retorno_w
				from	atendimento_sinal_vital
				where	nr_sequencia = (SELECT	coalesce(max(nr_sequencia),-1)
							from	atendimento_sinal_vital
							where	(qt_glicemia_capilar IS NOT NULL AND qt_glicemia_capilar::text <> '')
							and	nr_atendimento	= nr_atendimento_p
							and	coalesce(ie_situacao,'A') = 'A'
							and	coalesce(IE_RN,'N')	= 'N');	
			elsif (ie_sinal_p = 'QT_ABD') then	
				select	max(qt_perimitro_abdominal)
				into STRICT	vl_retorno_w
				from	atendimento_sinal_vital
				where	nr_sequencia = (SELECT	coalesce(max(nr_sequencia),-1)
							from	atendimento_sinal_vital
							where	(qt_perimitro_abdominal IS NOT NULL AND qt_perimitro_abdominal::text <> '')
							and	nr_atendimento	= nr_atendimento_p
							and	coalesce(ie_situacao,'A') = 'A'
							and	coalesce(IE_RN,'N')	= 'N');		
			elsif (ie_sinal_p = 'QT_QDR') then	
				select	max(qt_perimetro_quadril)
				into STRICT	vl_retorno_w
				from	atendimento_sinal_vital
				where	nr_sequencia = (SELECT	coalesce(max(nr_sequencia),-1)
							from	atendimento_sinal_vital
							where	(qt_perimetro_quadril IS NOT NULL AND qt_perimetro_quadril::text <> '')
							and	nr_atendimento	= nr_atendimento_p
							and	coalesce(ie_situacao,'A') = 'A'
							and	coalesce(IE_RN,'N')	= 'N');
			elsif (ie_sinal_p = 'MEDICAO') then
				select	max(ie_tipo_medicao)
				into STRICT	vl_retorno_w
				from	atendimento_sinal_vital
				where	nr_sequencia = (SELECT	coalesce(max(nr_sequencia),-1)
							from	atendimento_sinal_vital
							where	(ie_tipo_medicao IS NOT NULL AND ie_tipo_medicao::text <> '')
							and	nr_atendimento	= nr_atend_alta_w
							and	coalesce(ie_situacao,'A') = 'A'
							and	coalesce(IE_RN,'N')	= 'N');	
			elsif (ie_sinal_p = 'CIRCUNFERENCIA') then
				select	max(qt_circunf_cintura)
				into STRICT	vl_retorno_w
				from	atendimento_sinal_vital
				where	nr_sequencia = (SELECT	coalesce(max(nr_sequencia),-1)
							from	atendimento_sinal_vital
							where	(qt_circunf_cintura IS NOT NULL AND qt_circunf_cintura::text <> '')
							and	nr_atendimento	= nr_atend_alta_w
							and	coalesce(ie_situacao,'A') = 'A'
							and	coalesce(IE_RN,'N')	= 'N');	
			end if;
			end;
		
		end if;
	end if;

end if;

return vl_retorno_w;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_sinal_vital ( nr_atendimento_p bigint, ie_sinal_p text) FROM PUBLIC;

