-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';



--
-- dblink wrapper to call function tws_is_lab_exam as an autonomous transaction
--
CREATE EXTENSION IF NOT EXISTS dblink;

CREATE OR REPLACE FUNCTION tws_is_lab_exam ( nr_prescricao_p bigint, cd_pessoa_fisica_p text, nr_sequencia_p bigint) RETURNS varchar AS $body$
DECLARE
	-- Change this to reflect the dblink connection string
	v_conn_str  text := format('port=%s dbname=%s user=%s', current_setting('port'), current_database(), current_user);
	v_query     text;

	v_ret	varchar;
BEGIN
	v_query := 'SELECT * FROM tws_is_lab_exam_atx ( ' || quote_nullable(nr_prescricao_p) || ',' || quote_nullable(cd_pessoa_fisica_p) || ',' || quote_nullable(nr_sequencia_p) || ' )';
	SELECT * INTO v_ret FROM dblink(v_conn_str, v_query) AS p (ret varchar);
	RETURN v_ret;

END;
$body$ LANGUAGE plpgsql SECURITY DEFINER;




CREATE OR REPLACE FUNCTION tws_is_lab_exam_atx ( nr_prescricao_p bigint, cd_pessoa_fisica_p text, nr_sequencia_p bigint) RETURNS varchar AS $body$
DECLARE


ds_retorno_w  varchar(1) := 'N';
lab_count_w bigint;
BEGIN

select count(*) into STRICT lab_count_w
             FROM exame_laboratorio c  JOIN(SELECT a.nr_prescricao,b.cd_pessoa_fisica,a.nr_seq_exame
             FROM prescr_procedimento a,  prescr_medica b  WHERE a.nr_prescricao   = b.nr_prescricao
             AND coalesce(obter_se_motivo_baixa_conta(a.cd_motivo_baixa), 'S') = 'S'
             AND coalesce(a.nr_seq_lote_externo::text, '') = ''  AND (coalesce(a.ie_pendente_amostra, 'N')  = 'N')
             AND (a.cd_material_exame IS NOT NULL AND a.cd_material_exame::text <> '')  AND coalesce(ie_mostrar_web,'S') = 'S'
             AND coalesce(a.ie_suspenso,'N')  = 'N'
             AND (a.nr_seq_exame IS NOT NULL AND a.nr_seq_exame::text <> '') and b.cd_pessoa_fisica = cd_pessoa_fisica_p and a.nr_prescricao = nr_prescricao_p and a.nr_sequencia = nr_sequencia_p) a ON a.nr_seq_exame = c.nr_seq_exame
             WHERE c.ie_anatomia_patologica='N';
if (lab_count_w > 0) then
ds_retorno_w := 'S';
end if;
RETURN ds_retorno_w;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION tws_is_lab_exam ( nr_prescricao_p bigint, cd_pessoa_fisica_p text, nr_sequencia_p bigint) FROM PUBLIC; -- REVOKE ALL ON FUNCTION tws_is_lab_exam_atx ( nr_prescricao_p bigint, cd_pessoa_fisica_p text, nr_sequencia_p bigint) FROM PUBLIC;

