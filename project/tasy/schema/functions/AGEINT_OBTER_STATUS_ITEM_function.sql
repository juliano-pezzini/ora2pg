-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION ageint_obter_status_item (nr_seq_agenda_int_p bigint, nr_sequencia_item_p bigint, ie_opcao_p text default 'D') RETURNS varchar AS $body$
DECLARE


ds_retorno_w    		varchar(100);
nr_seq_agenda_cons_w	agenda_consulta.nr_sequencia%type;
nr_seq_agenda_exame_w	agenda_paciente.nr_sequencia%type;
nr_seq_pend_quimio_w	bigint;
ds_status_w             	varchar(100);
ie_status_agenda_w      	varchar(3);
ie_Tipo_agendamento_w	varchar(10);
ie_tipo_pend_agenda_w	varchar(10);
ie_Status_quimio_w		varchar(3);
nr_seq_proc_interno_w	bigint;
ie_pendencia_agenda_w 	varchar(1);


BEGIN
if (ie_opcao_p <> 'C') then
        ds_retorno_w := wheb_mensagem_pck.get_texto(306962, null); -- Nao agendado
else
        ds_Retorno_W    := 'L';
end if;

select  coalesce(nr_seq_agenda_cons,0),
        coalesce(nr_seq_agenda_exame,0),
	coalesce(nr_seq_pend_quimio,0),
	coalesce(ie_Tipo_agendamento,'X'),
	coalesce(ie_tipo_pend_agenda,'X')
into STRICT    nr_seq_agenda_cons_w,
        nr_seq_agenda_exame_w,
	nr_seq_pend_quimio_w,
	ie_Tipo_agendamento_w,
	ie_tipo_pend_agenda_w
from    agenda_integrada_item
where   nr_sequencia = nr_sequencia_item_p
and     nr_seq_agenda_int = nr_seq_agenda_int_p;


if (nr_seq_agenda_cons_w <> 0) then
        select  obter_desc_expressao(b.cd_exp_valor_dominio),
                a.ie_status_Agenda
        into STRICT    ds_status_w,
                ie_status_agenda_w
        from    valor_dominio_v b,
                agenda_consulta a
        where   a.nr_sequencia = nr_seq_agenda_cons_w
        and     a.ie_status_agenda      = b.vl_dominio
        and     b.cd_dominio    = 83;
        if (ie_opcao_p     = 'C') then
                ds_retorno_w    := ie_status_agenda_w;
        else
                ds_retorno_w    := ds_status_w;
        end if;
elsif (nr_seq_agenda_exame_w <> 0) then
        select  max(obter_desc_expressao(b.cd_exp_valor_dominio)),
                max(a.ie_status_Agenda),
		max(a.nr_seq_proc_interno)
        into STRICT    ds_status_w,
                ie_status_agenda_w,
		nr_seq_proc_interno_w
        from    VALOR_DOMINIO_V b,
                agenda_paciente a
        where   a.nr_sequencia = nr_seq_agenda_exame_w
        and     a.ie_status_agenda      = b.vl_dominio
        and     b.cd_dominio    = 83;
        if (ie_opcao_p     = 'C') then
                ds_retorno_w    := ie_status_agenda_w;
        else
                ds_retorno_w    := ds_status_w;
        end if;
	
	if (coalesce(nr_seq_proc_interno_w::text, '') = '') then
		if (ie_opcao_p     = 'C') then
        	        ds_retorno_w    := 'C';
       		else
       		        ds_retorno_w    := wheb_mensagem_pck.get_texto(254986, null); -- Cancelado
        	end if;		
	end if;
	
elsif (nr_seq_pend_quimio_w <> 0) then
 

	select 	coalesce(max('S'),'N')
	into STRICT 	ie_pendencia_agenda_w	
	from 	agenda_quimio
	where 	nr_seq_pend_agenda = nr_seq_pend_quimio_w;
	
	if (ie_pendencia_agenda_w = 'S') then
		ie_status_agenda_w	:= Qt_Obter_Status_Pendencia(nr_seq_pend_quimio_w);
	else
		ie_status_agenda_w := 'N';
	end if;
	
	if (ie_status_agenda_w = 'S') then
		ds_status_w		:= wheb_mensagem_pck.get_texto(306963, null); -- Ciclo agendado
	elsif (ie_status_agenda_w = 'N') then
		ds_status_w		:= wheb_mensagem_pck.get_texto(306969, null); -- Ciclo nao agendado
	elsif (ie_status_agenda_w = 'A') then
		ds_status_w		:= wheb_mensagem_pck.get_texto(306970, null); -- Ciclo dias agendado
	elsif (ie_status_agenda_w = 'C') then
		ds_status_w		:= wheb_mensagem_pck.get_texto(306971, null); -- Ciclo cancelado
	end if;
	if (ie_opcao_p     = 'C') then
                ds_retorno_w    := ie_status_agenda_w;
        else
                ds_retorno_w    := ds_status_w;
	end if;
elsif (ie_tipo_agendamento_w	= 'Q') and (ie_tipo_pend_agenda_w	<> 'Q') then 	
	select	coalesce(max(ie_status_agenda),'X')
	into STRICT	ie_status_quimio_w
	from	agenda_quimio
	where	nr_seq_ageint_item	= nr_sequencia_item_p;
	if (ie_status_quimio_w	= 'X') then
		ds_status_w	:= wheb_mensagem_pck.get_texto(306972, null); -- Item nao agendado
	elsif (ie_status_quimio_w	= 'C') then
		ds_status_w	:= wheb_mensagem_pck.get_texto(306973, null); -- Item cancelado
	else
		ds_status_w	:= wheb_mensagem_pck.get_texto(306974, null); -- Item agendado
	end if;

	if (ie_opcao_p     = 'C') then
                ds_retorno_w    := ie_status_quimio_w;
        else
                ds_retorno_w    := ds_status_w;
	end if;
end if;

return  ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION ageint_obter_status_item (nr_seq_agenda_int_p bigint, nr_sequencia_item_p bigint, ie_opcao_p text default 'D') FROM PUBLIC;

