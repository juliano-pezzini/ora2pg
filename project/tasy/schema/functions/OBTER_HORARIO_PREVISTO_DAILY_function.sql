-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_horario_previsto_daily ( CD_AGENDA_P bigint, CD_TIPO_AGENDA_P bigint, DT_AGENDA_P timestamp) RETURNS varchar AS $body$
DECLARE

	NR_MIN_ATRASO_W   bigint;
	HR_ATENDIDO_W 	timestamp;
	FINAL_PREVISTO_W  timestamp;
	ATRASO_W         	bigint;
	DS_RETORNO_W           varchar(60);


BEGIN

	SELECT coalesce(MAX(NR_MIN_ATRASO), 0)
	INTO STRICT NR_MIN_ATRASO_W
	FROM PARAMETRO_AGENDA
	WHERE CD_ESTABELECIMENTO = OBTER_ESTABELECIMENTO_ATIVO;

	DS_RETORNO_W := 0;
	ATRASO_W := 0;

	IF (CD_TIPO_AGENDA_P IN (3, 5)) THEN
		SELECT 	(MAX(DT_ATENDIDO) - MAX((dt_agenda) + (nr_minuto_duracao/1440)))*1440
		INTO STRICT	ATRASO_W
		FROM 	AGENDA_CONSULTA
		WHERE 	CD_AGENDA = CD_AGENDA_P
		AND 	DT_AGENDA <= DT_AGENDA_P
		AND		TRUNC(DT_AGENDA) = TRUNC(DT_AGENDA_P)
		AND 	(DT_ATENDIDO IS NOT NULL AND DT_ATENDIDO::text <> '');
	ELSE
		SELECT 	(MAX(B.DT_BAIXA) - MAX((A.HR_INICIO) + (A.NR_MINUTO_DURACAO/1440)))*1440
		INTO STRICT	ATRASO_W
		FROM 	AGENDA_PACIENTE A,
				PRESCR_PROCEDIMENTO B
		WHERE 	A.CD_AGENDA = CD_AGENDA_P
		AND 	A.DT_AGENDA <= DT_AGENDA_P
		AND		TRUNC(A.DT_AGENDA) = TRUNC(DT_AGENDA_P)
		AND		A.NR_SEQUENCIA = B.NR_SEQ_AGENDA
		AND 	(B.DT_BAIXA IS NOT NULL AND B.DT_BAIXA::text <> '');
	END IF;

	IF (ATRASO_W > 0)THEN
		DS_RETORNO_W := ATRASO_W;
	END IF;

	RETURN DS_RETORNO_W;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_horario_previsto_daily ( CD_AGENDA_P bigint, CD_TIPO_AGENDA_P bigint, DT_AGENDA_P timestamp) FROM PUBLIC;

