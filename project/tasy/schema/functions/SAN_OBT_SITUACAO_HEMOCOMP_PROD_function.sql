-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION san_obt_situacao_hemocomp_prod (nr_seq_producao_p bigint, ie_tipo_res_p text) RETURNS varchar AS $body$
DECLARE


ie_situacao_w	varchar(10);
ds_sql_w	varchar(255);
ds_situacao_w	varchar(255);

/*
R	-> Reservado
T	-> Transfundido
E	-> Emprestado
L	-> Liberado
G	-> Geladeira
D	-> Inutilizado / Descartado
*/
C01 CURSOR FOR
	SELECT	ds
	from (SELECT	CASE WHEN count(*)=0 THEN null  ELSE 'R' END  ds
		from	san_reserva a,
			san_producao x
		where	x.nr_sequencia		= nr_seq_producao_p
		and	x.nr_seq_reserva	= a.nr_sequencia
		and	coalesce(x.nr_seq_inutil::text, '') = ''
		
union

		select	CASE WHEN count(*)=0 THEN null  ELSE 'T' END  ds
		from	san_transfusao a,
			san_producao x
		where	x.nr_sequencia		= nr_seq_producao_p
		and	x.nr_seq_transfusao	= a.nr_sequencia
		and	coalesce(x.nr_seq_inutil::text, '') = ''
		
union

		select	CASE WHEN count(*)=0 THEN null  ELSE 'E' END  ds
		from	san_emprestimo a,
			san_producao x
		where	x.nr_sequencia		= nr_seq_producao_p
		and	x.nr_seq_emp_saida	= a.nr_sequencia
		and	coalesce(x.nr_seq_inutil::text, '') = ''
		
union

		select	CASE WHEN count(*)=0 THEN null  ELSE 'L' END  ds
		from	san_producao x
		where	x.nr_sequencia	= nr_seq_producao_p
		and	(x.dt_conferencia IS NOT NULL AND x.dt_conferencia::text <> '')
		and	coalesce(x.nr_seq_inutil::text, '') = ''
		
union

		select	CASE WHEN count(*)=0 THEN null  ELSE 'G' END  ds
		from	san_producao x
		where	x.nr_sequencia	= nr_seq_producao_p
		and	(x.dt_fim_producao IS NOT NULL AND x.dt_fim_producao::text <> '')
		and	coalesce(x.dt_conferencia::text, '') = ''
		and	coalesce(x.nr_seq_inutil::text, '') = ''
		
union

		select	CASE WHEN count(*)=0 THEN null  ELSE 'D' END  ds
		from	san_inutilizacao a,
			san_producao x
		where	x.nr_sequencia	= nr_seq_producao_p
		and	x.nr_seq_inutil	= a.nr_sequencia) alias14
	where	(ds IS NOT NULL AND ds::text <> '');


BEGIN
if (nr_seq_producao_p IS NOT NULL AND nr_seq_producao_p::text <> '') then

	open C01;
	loop
	fetch C01 into
		ie_situacao_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin
		if (ie_tipo_res_p = 'D') then
			select	CASE WHEN ie_situacao_w='R' THEN wheb_mensagem_pck.get_texto(803068) WHEN ie_situacao_w='T' THEN wheb_mensagem_pck.get_texto(803069) WHEN ie_situacao_w='E' THEN wheb_mensagem_pck.get_texto(803070) WHEN ie_situacao_w='L' THEN wheb_mensagem_pck.get_texto(803071) WHEN ie_situacao_w='G' THEN wheb_mensagem_pck.get_texto(803072) WHEN ie_situacao_w='D' THEN wheb_mensagem_pck.get_texto(803073) END
			into STRICT	ds_sql_w
			;
			ds_situacao_w	:= ds_situacao_w||ds_sql_w||',';
	else
		ds_situacao_w	:= ds_situacao_w||ie_situacao_w||',';
	end if;
		end;
	end loop;
	close C01;
	ds_situacao_w	:= substr(ds_situacao_w,1,length(ds_situacao_w)-1);
end if;

return	ds_situacao_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION san_obt_situacao_hemocomp_prod (nr_seq_producao_p bigint, ie_tipo_res_p text) FROM PUBLIC;

