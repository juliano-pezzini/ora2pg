-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION get_billing_date ( nr_atendimento_p ATENDIMENTO_PACIENTE.NR_ATENDIMENTO%TYPE, nr_prescricao_p prescr_mipres.nr_prescricao%TYPE ) RETURNS timestamp AS $body$
DECLARE

    dt_emissao_w        nota_fiscal.dt_emissao%TYPE;
    nr_interno_conta_w  conta_paciente.nr_interno_conta%TYPE;
    nr_sequencia_w      nota_fiscal.nr_sequencia%TYPE;

  contas RECORD;

BEGIN

    FOR contas in (
        SELECT b.nr_interno_conta
         FROM prescr_mipres   a,
              conta_paciente  b
        WHERE a.nr_atendimento = b.nr_atendimento
          AND a.nr_atendimento = nr_atendimento_p
          AND a.nr_prescricao = nr_prescricao_p
          AND IE_STATUS_ACERTO = 2
     GROUP BY b.nr_interno_conta ,a.nr_prescricao
    )

    LOOP

        IF ((contas.nr_interno_conta IS NOT NULL AND contas.nr_interno_conta::text <> '') AND coalesce(dt_emissao_w::text, '') = '') THEN
            SELECT obter_nf_conta(contas.nr_interno_conta, 7) nr_nota_fiscal
              INTO STRICT nr_sequencia_w
;

            IF (nr_sequencia_w IS NOT NULL AND nr_sequencia_w::text <> '') THEN
                SELECT obter_data_nota_fiscal(nr_sequencia_w, 'EM') dt_emissao_nf
                  INTO STRICT dt_emissao_w
;
            END IF;
        END IF;

    END LOOP;

    RETURN dt_emissao_w;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION get_billing_date ( nr_atendimento_p ATENDIMENTO_PACIENTE.NR_ATENDIMENTO%TYPE, nr_prescricao_p prescr_mipres.nr_prescricao%TYPE ) FROM PUBLIC;

