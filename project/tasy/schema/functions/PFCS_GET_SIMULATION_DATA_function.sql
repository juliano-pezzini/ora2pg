-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION pfcs_get_simulation_data ( cd_estabelecimento_p bigint, nr_hour_p bigint default 0, ie_type_p bigint default null, cd_classif_setor_p text default null, cd_unit_p text default null, ie_std char default 'N') RETURNS varchar AS $body$
DECLARE


nr_hour_w           smallint       :=  to_number(to_char((clock_timestamp() + (nr_hour_p/24)), 'HH24'));
dt_simulation_w     timestamp            :=  trunc(clock_timestamp() + (nr_hour_p/24));
ds_pred_vl_w        varchar(50)    :=  null;

---- ie_type_p
-- 1 Capacity
-- 2 Arrival
-- 3 Discharges
---- ie_std
-- 'N' return prediction value
-- 'S' return prediction value + ; + standard deviation (Example: 5;3)
BEGIN
    if (ie_type_p IS NOT NULL AND ie_type_p::text <> '')  then
        select case ie_type_p
            when 1 then concat(
                coalesce(sum(nr_mean_pred_capacity),0),
                CASE WHEN ie_std='S' THEN  ';' || round(dividir(sum(nr_sd_pred_capacity), count(nr_sd_pred_capacity)))  ELSE '' END )
            when 2 then concat(
                coalesce(sum(nr_mean_pred_arrival),0),
                CASE WHEN ie_std='S' THEN  ';' || round(dividir(sum(nr_sd_pred_arrival), count(nr_sd_pred_arrival)))  ELSE '' END )
            when 3 then concat(
                coalesce(sum(nr_mean_pred_discharges),0),
                CASE WHEN ie_std='S' THEN  ';' || round(dividir(sum(nr_sd_pred_discharges), count(nr_sd_pred_discharges)))  ELSE '' END )
            else null
        end
        into STRICT ds_pred_vl_w
        from pfcs_patient_simulation
        where dt_simulation = dt_simulation_w
            and hr_time_simulation = nr_hour_w
            and (coalesce(cd_classif_setor_p::text, '') = '' or cd_classif_setor = cd_classif_setor_p)
            and (coalesce(cd_unit_p::text, '') = '' or cd_unit = cd_unit_p)
            and (coalesce(cd_estabelecimento_p::text, '') = '' or cd_estabelecimento = cd_estabelecimento_p);
    end if;

    RETURN ds_pred_vl_w;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION pfcs_get_simulation_data ( cd_estabelecimento_p bigint, nr_hour_p bigint default 0, ie_type_p bigint default null, cd_classif_setor_p text default null, cd_unit_p text default null, ie_std char default 'N') FROM PUBLIC;

