-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_dose_terap_convert (cd_material_p bigint, qt_dose_p bigint, nr_seq_dose_terap_origem_p bigint, nr_seq_dose_terap_dest_p bigint) RETURNS bigint AS $body$
DECLARE


cd_unid_med_terap_origem_w	unidade_medida.cd_unidade_medida%type;
cd_unid_med_terap_dest_w	unidade_medida.cd_unidade_medida%type;
qt_dose_convet_w	cpoe_material.qt_dose%type;

function obter_unid_med_terap(nr_seq_dose_terap_p bigint) return unidade_medida.cd_unidade_medida%type is
cd_unid_med_terap_w	unidade_medida.cd_unidade_medida%type;

BEGIN
	select	min(a.cd_unidade_medida)
	into STRICT	cd_unid_med_terap_w
	from	material_conversao_unidade a,
		unidade_medida b,
		regra_dose_terap c
	where	a.cd_material = cd_material_p
	and	a.cd_unidade_medida = b.cd_unidade_medida
	and	b.ie_unidade_med_inter in ('mg', 'MCG', 'UI')
	and	c.nr_sequencia = nr_seq_dose_terap_p
	and upper(b.ie_unidade_med_inter) = upper(c.ie_unidade)
	order by a.ie_prioridade;
	
	return cd_unid_med_terap_w;
end;

begin
if ((nr_seq_dose_terap_origem_p IS NOT NULL AND nr_seq_dose_terap_origem_p::text <> '') and (nr_seq_dose_terap_dest_p IS NOT NULL AND nr_seq_dose_terap_dest_p::text <> '') and (qt_dose_p IS NOT NULL AND qt_dose_p::text <> '') and (cd_material_p IS NOT NULL AND cd_material_p::text <> '')) then
	cd_unid_med_terap_origem_w := obter_unid_med_terap(nr_seq_dose_terap_origem_p);
	cd_unid_med_terap_dest_w := obter_unid_med_terap(nr_seq_dose_terap_dest_p);

	if (cd_unid_med_terap_origem_w IS NOT NULL AND cd_unid_med_terap_origem_w::text <> '' AND cd_unid_med_terap_dest_w IS NOT NULL AND cd_unid_med_terap_dest_w::text <> '') then
		qt_dose_convet_w := Obter_dose_convertida(cd_material_p, qt_dose_p, cd_unid_med_terap_origem_w, cd_unid_med_terap_dest_w);
	end if;
end if;

return coalesce(qt_dose_convet_w, qt_dose_p);

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_dose_terap_convert (cd_material_p bigint, qt_dose_p bigint, nr_seq_dose_terap_origem_p bigint, nr_seq_dose_terap_dest_p bigint) FROM PUBLIC;

