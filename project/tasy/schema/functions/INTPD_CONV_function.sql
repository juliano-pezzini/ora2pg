-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION intpd_conv ( nm_tabela_p text, nm_atributo_p text, cd_valor_p text, nr_seq_regra_p bigint default null, ie_conversao_p text default 'I', ie_conv_int_ext_p text default 'I') RETURNS varchar AS $body$
DECLARE


/*
ie_conversao_p: 	Onde fica o De-Para na integracao: [I] = Interno (no Tasy); [E] = Externo (no sistema para qual o Tasy envia/recebe informacao
ie_conv_int_ext_p:	Que tipo de conversao sera realizado: [I] Obter valor interno com base no valor externo; [E] Obter valor externo com base num valor interno
*/
cd_conversao_w			conversao_meio_externo.cd_interno%type;
cd_cgc_w			conversao_meio_externo.cd_cgc%type;


BEGIN
if (ish_param_pck.get_se_regra_ish(nr_seq_regra_p) = 'S') then
	select	cd_cgc
	into STRICT	cd_cgc_w
	from	estabelecimento
	where	cd_estabelecimento = obter_estabelecimento_ativo;
end if;	


if (coalesce(ie_conversao_p,'X') = 'E') then
	cd_conversao_w	:=	cd_valor_p;
else
	begin
	if (coalesce(ie_conv_int_ext_p,'X') = 'I') then
		begin
		if (nr_seq_regra_p > 0) then
			begin
			select	cd_interno
			into STRICT	cd_conversao_w
			from	conversao_meio_externo
			where	nm_tabela	= nm_tabela_p
			and	nm_atributo	= nm_atributo_p
			and	cd_externo	= cd_valor_p
			and	nr_seq_regra 	= nr_seq_regra_p
			and	((coalesce(cd_cgc_w::text, '') = '') or (coalesce(cd_cgc, cd_cgc_w) = cd_cgc_w))  LIMIT 1;			
			exception
			when others then
				cd_conversao_w	:=	null;
			end;
		else
			begin
			select	cd_interno
			into STRICT	cd_conversao_w
			from	conversao_meio_externo
			where	nm_tabela	= nm_tabela_p
			and	nm_atributo	= nm_atributo_p
			and	cd_externo	= cd_valor_p
			and	((coalesce(cd_cgc_w::text, '') = '') or (coalesce(cd_cgc, cd_cgc_w) = cd_cgc_w))  LIMIT 1;			
			exception
			when others then
				cd_conversao_w	:=	null;
			end;
		end if;
		end;
	else
		begin
		if (nr_seq_regra_p > 0) then
			begin
			select	cd_externo
			into STRICT	cd_conversao_w
			from	conversao_meio_externo
			where	nm_tabela	= nm_tabela_p
			and	nm_atributo	= nm_atributo_p
			and	cd_interno	= cd_valor_p
			and	nr_seq_regra 	= nr_seq_regra_p
			and	((coalesce(cd_cgc_w::text, '') = '') or (coalesce(cd_cgc, cd_cgc_w) = cd_cgc_w))  LIMIT 1;			
			exception
			when others then
				cd_conversao_w	:=	null;
			end;
		else
			begin
			select	cd_externo
			into STRICT	cd_conversao_w
			from	conversao_meio_externo
			where	nm_tabela	= nm_tabela_p
			and	nm_atributo	= nm_atributo_p
			and	cd_interno	= cd_valor_p
			and	((coalesce(cd_cgc_w::text, '') = '') or (coalesce(cd_cgc, cd_cgc_w) = cd_cgc_w))  LIMIT 1;			
			exception
			when others then
				cd_conversao_w	:=	null;
			end;
		end if;
		end;
	end if;
	end;
end if;

return cd_conversao_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION intpd_conv ( nm_tabela_p text, nm_atributo_p text, cd_valor_p text, nr_seq_regra_p bigint default null, ie_conversao_p text default 'I', ie_conv_int_ext_p text default 'I') FROM PUBLIC;

