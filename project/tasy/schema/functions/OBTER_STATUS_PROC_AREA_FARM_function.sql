-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_status_proc_area_farm (nr_seq_prescr_mat_hor_p bigint) RETURNS varchar AS $body$
DECLARE


dt_entrega_setor_w		can_ordem_prod.dt_entrega_setor%type;
dt_fim_preparo_w		can_ordem_prod.dt_fim_preparo%type;
dt_inicio_preparo_w		can_ordem_prod.dt_inicio_preparo%type;
dt_conferencia_w		can_ordem_prod.dt_conferencia%type;
dt_cancelamento_w		paciente_atend_medic.dt_cancelamento%type;
dt_fim_adm_w			paciente_atendimento.dt_fim_adm%type;
dt_primeira_checagem_w	prescr_mat_hor.dt_primeira_checagem%type;
dt_checagem_w			prescr_mat_hor.dt_checagem%type;
dt_administracao_w		can_ordem_prod.dt_administracao%type;
dt_suspensao_w			prescr_mat_hor.dt_suspensao%type;

ie_status_w		varchar(15);


BEGIN
	ie_status_w := 'G';
	
	select
		max(cop.dt_entrega_setor),
		max(cop.dt_fim_preparo),
		max(cop.dt_inicio_preparo),
		max(cop.dt_conferencia),
		max(cop.dt_cancelamento),
		max(pa.dt_fim_adm),
		max(pmh.dt_primeira_checagem),
		max(pmh.dt_checagem),
		max(pmh.dt_fim_horario),
		max(pmh.dt_suspensao)
	into STRICT
		dt_entrega_setor_w,
		dt_fim_preparo_w,
		dt_inicio_preparo_w,
		dt_conferencia_w,
		dt_cancelamento_w,
		dt_fim_adm_w,
		dt_primeira_checagem_w,
		dt_checagem_w,
		dt_administracao_w,
		dt_suspensao_w
	from 	prescr_mat_hor pmh
	inner 	join can_ordem_item_prescr coip on coip.nr_seq_mat_hor = pmh.nr_sequencia
	inner 	join can_ordem_prod cop on cop.nr_sequencia = coip.nr_seq_ordem
	inner 	join paciente_atendimento pa on pa.nr_seq_atendimento = cop.nr_seq_atendimento
	where 	pmh.nr_sequencia = nr_seq_prescr_mat_hor_p;

	if (dt_conferencia_w IS NOT NULL AND dt_conferencia_w::text <> '') then
		ie_status_w := 'L';
	end if;

	if ((dt_inicio_preparo_w IS NOT NULL AND dt_inicio_preparo_w::text <> '') and coalesce(dt_fim_preparo_w::text, '') = '') then
		ie_status_w := 'F';
	end if;
	
	if (dt_cancelamento_w IS NOT NULL AND dt_cancelamento_w::text <> '') then
		ie_status_w := 'C';
	end if;
	
	if (dt_suspensao_w IS NOT NULL AND dt_suspensao_w::text <> '') then
		ie_status_w := 'S';
	end if;
	
	if (dt_fim_preparo_w IS NOT NULL AND dt_fim_preparo_w::text <> '') then
		ie_status_w := 'P';
	end if;
	
	if (dt_entrega_setor_w IS NOT NULL AND dt_entrega_setor_w::text <> '') then
		ie_status_w := 'D';
	end if;
	
	if ((dt_primeira_checagem_w IS NOT NULL AND dt_primeira_checagem_w::text <> '') and coalesce(dt_checagem_w::text, '') = '') then
		ie_status_w := 'Q';
	end if;
	
	if ((dt_fim_adm_w IS NOT NULL AND dt_fim_adm_w::text <> '') or (dt_administracao_w IS NOT NULL AND dt_administracao_w::text <> '')) then
		ie_status_w := 'A';
	end if;
	
	return ie_status_w;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_status_proc_area_farm (nr_seq_prescr_mat_hor_p bigint) FROM PUBLIC;

