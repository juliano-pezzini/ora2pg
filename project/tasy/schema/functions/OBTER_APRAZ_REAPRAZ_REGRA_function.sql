-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_apraz_reapraz_regra ( ie_tipo_item_p text, nr_atendimento_p atendimento_paciente.nr_atendimento%type, ie_acao_p text, nm_usuario_p usuario.nm_usuario%type) RETURNS varchar AS $body$
DECLARE

cd_setor_atendimento_w	setor_atendimento.cd_setor_atendimento%type;
cd_estabelecimento_w	estabelecimento.cd_estabelecimento%type;
cd_perfil_w				perfil.cd_perfil%type;
ie_classe_prof_w		usuario.ie_profissional%type;
ie_tipo_item_w			integer;
ie_retorno_w			varchar(1) := 'S';
ie_existe_regra_w		varchar(1);
ie_existe_regra_permite_w	varchar(1);

c_regra CURSOR(ie_tipo_item_pc	integer) FOR
SELECT	a.ie_permissao ie_tipo_permissao,
	 CASE ie_tipo_item_pc
	    when 1 then a.ie_medicamentos
	    when 2 then a.ie_solucoes
	    when 3 then a.ie_nutricao
	    when 4 then a.ie_exames_proc
	    when 5 then a.ie_recomendacoes
	    when 6 then a.ie_intervencoes
	    else 'S' end ie_permite_item
from	regra_apra_reapra_adep a
where	((a.cd_estabelecimento = cd_estabelecimento_w) or (coalesce(a.cd_estabelecimento::text, '') = ''))
and		((a.cd_setor_atendimento = cd_setor_atendimento_w) or (coalesce(a.cd_setor_atendimento::text, '') = ''))
and		((a.cd_perfil = cd_perfil_w) or (coalesce(a.cd_perfil::text, '') = ''))
and		((a.ie_profissional = ie_classe_prof_w) or (coalesce(a.ie_profissional::text, '') = ''))
order by
	coalesce(a.cd_setor_atendimento,99999),
	coalesce(a.cd_perfil,99999),
	coalesce(a.ie_profissional, 'ZZZZZ'),
	a.nr_sequencia;

BEGIN

select 	coalesce(max('S'), 'N') ie_existe_regra
into STRICT	ie_existe_regra_w
from	regra_apra_reapra_adep a;

if (ie_tipo_item_p IS NOT NULL AND ie_tipo_item_p::text <> '') and (nr_atendimento_p IS NOT NULL AND nr_atendimento_p::text <> '') and (ie_acao_p IS NOT NULL AND ie_acao_p::text <> '') and (nm_usuario_p IS NOT NULL AND nm_usuario_p::text <> '') and (ie_existe_regra_w <> 'N') then

	cd_estabelecimento_w := wheb_usuario_pck.get_cd_estabelecimento;
	cd_setor_atendimento_w := Obter_Unidade_Atendimento(nr_atendimento_p,'A','CS');
	cd_perfil_w := wheb_usuario_pck.get_cd_perfil;
	
	select	max(a.ie_profissional) ie_classe_prof
	into STRICT	ie_classe_prof_w
	from	usuario a
	where	a.nm_usuario = nm_usuario_p;
	
	if (ie_tipo_item_p = 'M') then
		ie_tipo_item_w	:= 1;
	elsif (ie_tipo_item_p = 'SOL') then
		ie_tipo_item_w	:= 2;
	elsif (ie_tipo_item_p in ('S', 'SNE', 'D', 'LD', 'NPP', 'NAN')) then
		ie_tipo_item_w := 3;
	elsif (ie_tipo_item_p in ('P', 'L', 'G')) then
		ie_tipo_item_w := 4;
	elsif (ie_tipo_item_p = 'R') then
		ie_tipo_item_w := 5;
	elsif (ie_tipo_item_p = 'E') then
		ie_tipo_item_w := 6;
	end if;
	
	select 	coalesce(max('S'), 'N')
	into STRICT	ie_existe_regra_permite_w
	from	regra_apra_reapra_adep a
	where (a.ie_profissional = ie_classe_prof_w)
	and		((a.cd_estabelecimento = cd_estabelecimento_w) or (coalesce(a.cd_estabelecimento::text, '') = ''))
	and		((a.cd_setor_atendimento = cd_setor_atendimento_w) or (coalesce(a.cd_setor_atendimento::text, '') = ''))
	and		((a.cd_perfil = cd_perfil_w) or (coalesce(a.cd_perfil::text, '') = ''))
	and		(((ie_tipo_item_w = 1) and (a.ie_medicamentos = 'S') and (a.ie_permissao in (ie_acao_p, 'X'))) or
			((ie_tipo_item_w = 2) and (a.ie_solucoes = 'S') and (a.ie_permissao in (ie_acao_p, 'X'))) or
			((ie_tipo_item_w = 3) and (a.ie_nutricao = 'S') and (a.ie_permissao in (ie_acao_p, 'X'))) or
			((ie_tipo_item_w = 4) and (a.ie_exames_proc = 'S') and (a.ie_permissao in (ie_acao_p, 'X'))) or
			((ie_tipo_item_w = 5) and (a.ie_recomendacoes = 'S') and (a.ie_permissao in (ie_acao_p, 'X'))) or
			((ie_tipo_item_w = 6) and (a.ie_intervencoes = 'S') and (a.ie_permissao in (ie_acao_p, 'X'))));
	
	if (coalesce(ie_tipo_item_w, 0) > 0) and (ie_existe_regra_permite_w = 'N') then
		for c_regra_w in c_regra(ie_tipo_item_w) loop
			if (c_regra_w.ie_permite_item <> 'S') or
				(c_regra_w.ie_tipo_permissao <> ie_acao_p AND c_regra_w.ie_tipo_permissao <> 'X') then
				ie_retorno_w := 'N';
			end if;
			exit;
		end loop;
	end if;
end if;

return	ie_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_apraz_reapraz_regra ( ie_tipo_item_p text, nr_atendimento_p atendimento_paciente.nr_atendimento%type, ie_acao_p text, nm_usuario_p usuario.nm_usuario%type) FROM PUBLIC;

