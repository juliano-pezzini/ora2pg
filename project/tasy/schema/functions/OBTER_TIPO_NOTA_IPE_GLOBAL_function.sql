-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_tipo_nota_ipe_global ( ie_tipo_atendimento_p bigint, ie_tipo_item_p bigint, cd_item_p bigint, ie_origem_proced_p bigint, cd_cgc_hospital_p text, nr_interno_conta_p bigint) RETURNS bigint AS $body$
DECLARE


/* ie_tipo_item			1-Proc/Taxas/Serv	2-Mat/Med

*/
/* ie_tipo_atendimento		1-Internado	3-Pronto Socorro 7-Externo(Exames) 8-Ambulatorial 	*/

cd_grupo_proc_w			bigint;
cd_especialidade_w		bigint;
cd_area_procedimento_w		bigint;
tp_nota_w			smallint;



BEGIN

select coalesce(max(cd_grupo_proc),0),
	 coalesce(max(cd_especialidade),0),
	 coalesce(max(cd_area_procedimento),0)
into STRICT	 cd_grupo_proc_w,
	 cd_especialidade_w,
	 cd_area_procedimento_w
from	 estrutura_procedimento_v
where	 cd_procedimento	= cd_item_p
and 	ie_origem_proced	= ie_origem_proced_p
and	ie_tipo_item_p		= 1;

tp_nota_w := obter_tipo_nota_ipergs(ie_tipo_atendimento_p, ie_tipo_item_p,cd_area_procedimento_w, cd_especialidade_w,cd_grupo_proc_w,cd_item_p, ie_origem_proced_p, nr_interno_conta_p);

if (coalesce(tp_nota_w,0) = 0) then

	if (ie_tipo_item_p	= 1) then
		begin
		tp_nota_w			:= 55;

		select coalesce(max(cd_grupo_proc),0),
			 coalesce(max(cd_especialidade),0),
			 coalesce(max(cd_area_procedimento),0)
		into STRICT	 cd_grupo_proc_w,
			 cd_especialidade_w,
			 cd_area_procedimento_w
		from	 estrutura_procedimento_v
		where	 cd_procedimento	= cd_item_p
		and 	ie_origem_proced	= ie_origem_proced_p;

		if (ie_tipo_atendimento_p	= 1) then
			begin
			if (cd_area_procedimento_w		= 1) then
				tp_nota_w			:= 75;
			elsif (cd_area_procedimento_w		= 2) then
				tp_nota_w			:= 75;
			elsif (cd_area_procedimento_w		= 4) then
				tp_nota_w			:= 75;
			elsif (cd_area_procedimento_w		= 3) then
				tp_nota_w			:= 77;
			else
				tp_nota_w			:= 76;
			end if;
			end;
		end if;

		if (ie_tipo_atendimento_p	= 8) then
			begin
			if (cd_area_procedimento_w		= 1) then
				tp_nota_w			:= 85;
			elsif (cd_area_procedimento_w		= 2) then
				tp_nota_w			:= 85;
			elsif (cd_area_procedimento_w		= 4) then
				tp_nota_w			:= 85;
			elsif (cd_area_procedimento_w		= 3) then
				tp_nota_w			:= 87;
			else
				tp_nota_w			:= 86;
			end if;
			end;
		end if;

		if (ie_tipo_atendimento_p	= 3) then
			tp_nota_w			:= 55;
		end if;

		if (ie_tipo_atendimento_p	= 7) then
			tp_nota_w			:= 35;
		end if;

		if (ie_tipo_atendimento_p	= 1) or (ie_tipo_atendimento_p	= 8) then
			begin
			/* OS 181968 - Guilherme - Hospital Bruno Born*/

			if (cd_cgc_hospital_p = '91162511000165') then
				if (cd_item_p in (32130449,27040470)) then
					begin
					if (ie_tipo_atendimento_p	= 1) then
						tp_nota_w			:= 75;
					elsif (ie_tipo_atendimento_p	= 8) then
						tp_nota_w			:= 85;
					end if;
					end;
				end if;
			end if;
			end;
		end if;
		end;
	end if;


	if (ie_tipo_item_p	= 2) then
		begin
		if (ie_tipo_atendimento_p	= 1) then
			tp_nota_w			:= 76;
		elsif (ie_tipo_atendimento_p	= 8) then
			tp_nota_w			:= 86;
		elsif (ie_tipo_atendimento_p	= 3) then
			tp_nota_w			:= 55;
		elsif (ie_tipo_atendimento_p	= 7) then
			tp_nota_w			:= 35;
		else
			tp_nota_w			:= 55;
		end if;
		end;
	end if;

end if;

RETURN tp_nota_w;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_tipo_nota_ipe_global ( ie_tipo_atendimento_p bigint, ie_tipo_item_p bigint, cd_item_p bigint, ie_origem_proced_p bigint, cd_cgc_hospital_p text, nr_interno_conta_p bigint) FROM PUBLIC;

