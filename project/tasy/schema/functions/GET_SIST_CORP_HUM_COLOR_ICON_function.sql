-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION get_sist_corp_hum_color_icon (nr_atendimento_p bigint, nr_seq_suep_p bigint, ie_card_type_p text) RETURNS varchar AS $body$
DECLARE


   nr_pontuacao_aa_w smallint := null;
   ds_return_final_w varchar(6);
   exec_w varchar(300);

   c01 CURSOR FOR
      SELECT distinct fld_nm_sub_content
        from (SELECT get_color_graf_sv(a.cd_setor_atendimento,
                                       a.cd_pessoa_fisica,
                                       b.nr_seq_inf,
                                       b.nr_sequencia,
                                       a.nr_atendimento) fld_nm_sub_content
                from w_suep a,
                w_suep_item b, 
                w_suep_item_data c
               where b.nr_seq_suep = a.nr_sequencia
                 and b.nr_sequencia = c.nr_seq_suep_item
                 and a.nr_atendimento = nr_atendimento_p
                 and a.nm_usuario = wheb_usuario_pck.get_nm_usuario
                 and b.ie_grupo_suep = ie_card_type_p
               group by a.cd_setor_atendimento,
                        a.cd_pessoa_fisica,
                        b.nr_seq_inf,
                        b.nr_sequencia,
                        a.nr_atendimento) alias1;
   r01 c01%rowtype;

   c02 CURSOR FOR
      SELECT distinct obter_ref_exame_suep_v2(obter_pessoa_atendimento(d.nr_atendimento,
                                                                       'C'),
                                              e.nr_seq_exame,
                                              nr_seq_suep_p,
                                              nr_atendimento_p,
                                              ie_card_type_p) fld_nm_sub_content
        from exame_lab_resultado d, exame_lab_result_item e
       where d.nr_seq_resultado = e.nr_seq_resultado
         and obter_se_lib_nivel_atencao(d.ie_nivel_atencao,
                                        'T',
                                        d.nm_usuario,
                                        d.nr_prescricao) = 'S'
         and (coalesce(d.ie_nivel_atencao, 'T') = 'P' or
             coalesce(d.ie_nivel_atencao, 'T') = 'S' or
             coalesce(d.ie_nivel_atencao, 'T') = 'T')
         and d.nr_atendimento = nr_atendimento_p
         and (e.qt_resultado IS NOT NULL AND e.qt_resultado::text <> '')
         and (d.dt_liberacao IS NOT NULL AND d.dt_liberacao::text <> '')
         and (obter_se_contido(e.nr_seq_exame,
                               obter_lista_inf_lab_exam(nr_seq_suep_p,
                                                        ie_card_type_p)) = 'S');
   r02 c02%rowtype;


BEGIN
    select SUEP_MD_PCK.GET_DEFAULT_COLOR_MD('string')
      into STRICT ds_return_final_w
;

   if (nr_atendimento_p IS NOT NULL AND nr_atendimento_p::text <> '') then

       open c01;
       loop
          fetch c01
            into r01;
          EXIT WHEN NOT FOUND; /* apply on c01 */
          exec_w := 'CALL SUEP_MD_PCK.GET_COLOR_HUM_COLOR_ICON_MD(:1, :2) INTO :result';
          EXECUTE exec_w
            USING IN r01.fld_nm_sub_content, ds_return_final_w,  OUT ds_return_final_w;

       end loop;
       close c01;

       open c02;
       loop
        fetch c02
            into r02;
        EXIT WHEN NOT FOUND; /* apply on c02 */
         exec_w := 'CALL SUEP_MD_PCK.GET_COLOR_HUM_COLOR_ICON_MD(:1, :2) INTO :result';
          EXECUTE exec_w
            USING IN r02.fld_nm_sub_content, ds_return_final_w,  OUT ds_return_final_w;
        end loop;
          close c02;
   end if;

   return ds_return_final_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION get_sist_corp_hum_color_icon (nr_atendimento_p bigint, nr_seq_suep_p bigint, ie_card_type_p text) FROM PUBLIC;

