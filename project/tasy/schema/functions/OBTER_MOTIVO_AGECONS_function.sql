-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_motivo_agecons ( nr_seq_agenda_p bigint, ie_status_p text, nr_seq_motivo_p bigint) RETURNS varchar AS $body$
DECLARE


ds_motivo_w				varchar(255);

nr_seq_motivo_reserva_w	bigint;
dt_agenda_w				timestamp;
cd_agenda_w				agenda_consulta.cd_agenda%type;
nr_seq_motivo_bloq_ag_w	bigint;
ie_dia_semana_w			smallint;


BEGIN
if (nr_seq_agenda_p IS NOT NULL AND nr_seq_agenda_p::text <> '') and (ie_status_p IS NOT NULL AND ie_status_p::text <> '') then

	if (ie_status_p = 'II') then

		select	obter_motivo_inativ_agecons(nr_seq_agenda_p,nr_seq_motivo_p)
		into STRICT	ds_motivo_w
		;

	elsif (ie_status_p = 'B') then

		select	obter_motivo_bloq_agecons(nr_seq_agenda_p,nr_seq_motivo_p)
		into STRICT	ds_motivo_w
		;

		if (coalesce(ds_motivo_w::text, '') = '') then
			select	max(dt_agenda),
					max(cd_agenda)
			into STRICT	dt_agenda_w,
					cd_agenda_w
			from	agenda_consulta
			where	nr_sequencia = nr_seq_agenda_p;

			if (cd_agenda_w IS NOT NULL AND cd_agenda_w::text <> '') and (dt_agenda_w IS NOT NULL AND dt_agenda_w::text <> '') then
				select	obter_cod_dia_semana(dt_agenda_w)
				into STRICT	ie_dia_semana_w
				;

				nr_seq_motivo_bloq_ag_w := Obter_motivo_bloqueio_agenda(cd_agenda_w, dt_agenda_w, ie_dia_semana_w, nr_seq_motivo_bloq_ag_w);

				if (nr_seq_motivo_bloq_ag_w IS NOT NULL AND nr_seq_motivo_bloq_ag_w::text <> '') then
					select	max(substr(a.ds_motivo,1,255))
					into STRICT	ds_motivo_w
					from	agenda_motivo a
					where	a.nr_sequencia = nr_seq_motivo_bloq_ag_w;
				end if;

			end if;

		end if;

	elsif (ie_status_p = 'C') then

		select	obter_motivo_cancel_agecons(nr_seq_agenda_p,nr_seq_motivo_p)
		into STRICT	ds_motivo_w
		;

	elsif (ie_status_p in ('F','I')) then

		select	obter_motivo_falta_agecons(nr_seq_agenda_p)
		into STRICT	ds_motivo_w
		;
	elsif (ie_status_p = 'R') then

		select	max(nr_seq_motivo_reserva)
		into STRICT	nr_seq_motivo_reserva_w
		from	agenda_consulta
		where	nr_sequencia = nr_seq_agenda_p;

		if (nr_seq_motivo_reserva_w IS NOT NULL AND nr_seq_motivo_reserva_w::text <> '') then

			select	substr(ds_motivo,1,255)
			into STRICT	ds_motivo_w
			from	agenda_motivo
			where	nr_sequencia = nr_seq_motivo_reserva_w;

		end if;

	else

		select	obter_motivo_transf_agecons(nr_seq_agenda_p, nr_seq_motivo_p)
		into STRICT	ds_motivo_w
		;

	end if;

end if;

return ds_motivo_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_motivo_agecons ( nr_seq_agenda_p bigint, ie_status_p text, nr_seq_motivo_p bigint) FROM PUBLIC;

