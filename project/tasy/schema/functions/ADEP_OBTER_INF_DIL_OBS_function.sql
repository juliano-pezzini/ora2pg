-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION adep_obter_inf_dil_obs ( nr_prescricao_p bigint, nr_seq_item_p bigint) RETURNS varchar AS $body$
DECLARE

varIeGravarDiluicao_w		varchar(1);
ie_exibe_justif_pt_w		varchar(2);
ds_dil_obs_w				varchar(4000);
cd_material_w				integer;
cd_medic_w					integer;
cd_funcao_ativa_w			bigint;
qt_dose_w					double precision;
qt_dose_ml_w				double precision;
qt_dose_ml_final_w			double precision;
cd_unid_med_dose_w			varchar(30) := '';
ds_material_w				varchar(100);
ie_possui_diluente_w		varchar(1);
ie_mostrar_dil_pt_w			varchar(1);
ds_material_ww				varchar(100);
ds_reduzida_w				varchar(100);
ds_obs_enf_w				varchar(4000) := '';
ds_dil_w					varchar(4000) := '';
ds_comp_w					varchar(4000) := '';
ds_bomba_w					varchar(4000) := '';
ds_riscos_w					varchar(4000) := '';
ie_bomba_infusao_w			varchar(4000) := '';
ds_obs_med_w				varchar(4000) := '';
ds_dose_ml_w				varchar(4000) := '';
ds_justificativa_w			varchar(4000) := '';
DS_DILUIR_W					varchar(4000) := '';
ds_obs_far_w				varchar(4000) := '';
qt_dias_liberado_w			double precision;
ds_retorno_w				varchar(4000) := '';
ds_reconstituir_w			varchar(2000) := '';
ds_adm_ui_w					varchar(2000) := '';
ds_hora_w					varchar(10) := '';
ie_administrar_ui_w			varchar(10) := '';
ie_aplicar_medic_w			varchar(10) := '';
ie_aplicar_ww				varchar(10) := '';
ie_um_prescrita_w			varchar(10);
ie_mostrar_aplic_ataque_w	varchar(10);
ie_agrupador_w				smallint;
ie_agrupador_ww				smallint;
nr_casas_w					bigint;
qt_reconst_w				double precision;
qt_dose_mat_w				double precision;
cd_setor_prescr_w			setor_atendimento.cd_setor_atendimento%type;
cont_w						double precision;
CONT_WW						double precision;
qt_dose_ml_teste_w			double precision;
qt_dose_ml_ataque_w			double precision;
qt_dose_especial_w			double precision;
qt_volume_cad_w				double precision;
qt_volume_equipo_w			double precision;
qt_ret_volume_equipo_w		double precision := 0;
qt_volume_ww				double precision;
cd_mat_ww					bigint;
qt_dose_mat_str_w			varchar(20) := '';
ie_separar_w				varchar(2);
cd_unid_med_dose_mat_w		varchar(30) := '';
qt_solucao_w				double precision := 0;
qt_solucao_str_w			varchar(10) :='';
ds_dose_diferenciada_w		varchar(50);
ds_ataque_w					varchar(50);
ds_erro_w					varchar(4000);
ds_aux_diluir_w				varchar(4000);
ds_rediluir_w				varchar(4000);
ie_consistedoseconsumomedic_w varchar(4000);
ie_ordem_w					smallint;
qt_solucao_ww				double precision := 0;
qt_min_aplicacao_w			smallint  := 0;
qt_min_aplicacao_ant_w		smallint  := 0;
qt_hora_aplicacao_ant_w		smallint  := 0;
qt_hora_aplicacao_w			smallint  := 0;
ds_min_aplicacao_w			varchar(255) := '';
cd_volume_final_w			double precision := 0;
mascara_w					smallint := 0;
qt_dose_str_w				varchar(20) := '';
cd_volume_final_str_w		varchar(20) := '';
qt_diluicao_w				double precision := 0;
qt_conversao_w				double precision;
qt_dose_dil_w				double precision;
cd_diluente_w				integer  := 0;
ds_diluente_w				varchar(100) := '';
qt_diluicao_str_w			varchar(20) := '';
ds_intervalo_w				varchar(50) := '';
cd_unidade_medida_w			varchar(30);
ie_fator_correcao_w			varchar(3);
ds_conv_ml_w				varchar(20) := '';
qt_conv_ml_w				double precision;
cd_estabelecimento_w		smallint;
qt_registro_w				smallint := 0;
ie_descr_redu_dil_w			varchar(1);
ie_via_aplicacao_w			varchar(5);
cd_intervalo_w				varchar(7);
qt_ml_diluente_w			double precision;
ds_volume_w					varchar(100);
ds_tempo_w					varchar(100);
qt_dose_medic_ml_w			double precision;
ds_aplicar_w				varchar(200);
ds_diluicao_edit_w			varchar(2000);
ie_aplicar_w				varchar(1);
ds_dose_diluicao_w			varchar(100);
qt_dose_unid_med_cons_w		double precision;
qt_vol_adic_reconst_w		double precision;
qt_dose_medic_w				double precision;
ie_indice_w					smallint;
cd_material_red_w			integer;
qt_dose_red_w				double precision;
cd_unid_med_dose_red_w		varchar(30) := '';
qt_solucao_red_w			double precision := 0;
qt_dose_ml_red_w			double precision;
ds_material_red_ww			varchar(100);
ds_reduzida_red_w			varchar(100);
ds_material_red_w			varchar(100);
cd_volume_final_red_w		double precision := 0;
qt_diluicao_aux_w			double precision;
cd_unid_med_diluente_aux_w	varchar(50);
ie_mostrar_estabilidade_w	varchar(1);
qt_estagio_armazenamento_w	bigint;
ds_estagio_armazenamento_w	varchar(255);
qt_estabilidade_w			bigint;
ds_tempo_estabilidade_w		varchar(255);
ds_inf_adic_w				varchar(2000);
ie_higroscopico_w			varchar(1);
ie_fotosensivel_w			varchar(1);
ie_mostrar_foto_w			varchar(1);
ie_termolabil_w				varchar(1);
nr_casas_diluicao_w			bigint;
nr_casas_diluicao_padrao_w	bigint;
ie_consiste_dose_consumo_w	varchar(1) := 'S';
qt_unit_medic_w				double precision;
qt_unit_medic_div_w			double precision;
ie_mostrar_concentracao_w	varchar(1);
qt_concentracao_total_w		double precision;
cd_unid_med_concetracao_w	varchar(50);
cd_unid_med_base_conc_w		varchar(50);
ds_total_reconst_w			varchar(255);
qt_volume_adic_w			double precision;
ie_apres_vol_reconst_w		varchar(1);
qt_total_w					double precision;
qt_dose_aux_w				double precision;
qt_min_aplic_dose_esp_w		prescr_material.qt_min_aplic_dose_esp%type;
ie_proporcao_w				material_diluicao.ie_proporcao%type;
qt_volume_medic_w			material_diluicao.qt_volume_medic%type;
ie_aplic_bolus_w			prescr_material.ie_aplic_bolus%type;
ie_lentamente_w 			prescr_material.ie_aplic_lenta%type;
nr_seq_substituto_w   		prescr_material.nr_seq_substituto%type;
nr_agrupamento_w			prescr_material.nr_agrupamento%type;
ie_agrupador_www			prescr_material.ie_agrupador%type;
ie_item_superior_w			prescr_material.ie_item_superior%type;
qtd_w						numeric(5);
ds_informacao_item_w 		varchar(2000);
qt_conversao_ww 			material_conversao_unidade.qt_conversao%type;
ds_justificativa_cpoe_w 	cpoe_material.ds_justificativa%type;

c00 CURSOR FOR
SELECT	b.qt_dose,
		b.qt_min_aplicacao,
		b.qt_hora_aplicacao,
		b.cd_unidade_medida_dose,
		b.qt_solucao,
		b.cd_unidade_medida,
		b.cd_material,
		a.cd_estabelecimento,
		b.cd_intervalo,
		b.ie_via_aplicacao,
		b.ds_dose_diferenciada,
		1 ie_indice,
		null ds_hora,
		1 ie_ordem,
		0 qt_diluicao,
		null cd_unid_med_diluente,
		a.cd_setor_atendimento,
		b.qt_unitaria,
		b.ie_agrupador,
		Obter_vol_Dispositivo_solucao(b.ie_bomba_infusao),
		coalesce(b.ie_fator_correcao,'N'),
		b.qt_dose_especial,
		b.qt_min_aplic_dose_esp
from 	prescr_material b,
		prescr_medica a
where 	a.nr_prescricao	= b.nr_prescricao
and		b.nr_sequencia	= nr_seq_item_p
and		a.nr_prescricao	= nr_prescricao_p
and		b.ie_agrupador	in (1, 5, 8, 12, 14)
and		not exists (	select	1
						from	prescr_mat_diluicao x
						where	x.nr_prescricao	= b.nr_prescricao
						and		x.nr_seq_material = b.nr_sequencia)

union

select	coalesce(c.qt_dose_diferenciada, b.qt_dose),
		coalesce(c.qt_min_aplicacao, b.qt_min_aplicacao),
		b.qt_hora_aplicacao,
		b.cd_unidade_medida_dose,
		b.qt_solucao,
		b.cd_unidade_medida,
		b.cd_material,
		a.cd_estabelecimento,
		b.cd_intervalo,
		b.ie_via_aplicacao,
		b.ds_dose_diferenciada,
		2 ie_indice,
		c.ds_hora,
		c.ie_ordem,
		c.qt_diluicao,
		c.cd_unid_med_diluente,
		a.cd_setor_atendimento,
		b.qt_unitaria,
		b.ie_agrupador,
		Obter_vol_Dispositivo_solucao(b.ie_bomba_infusao),
		coalesce(b.ie_fator_correcao,'N'),
		b.qt_dose_especial,
		b.qt_min_aplic_dose_esp
from 	prescr_mat_diluicao c,
		prescr_material b,
		prescr_medica a
where 	a.nr_prescricao	= b.nr_prescricao
and		c.nr_prescricao	= b.nr_prescricao
and		c.nr_seq_material = b.nr_sequencia
and		b.nr_sequencia	= nr_seq_item_p
and		a.nr_prescricao	= nr_prescricao_p
and		b.ie_agrupador	in (1,5,8,12, 14)
order by ie_ordem;
c01 CURSOR FOR
SELECT	a.cd_material,
		a.qt_dose,
		coalesce(a.qt_vol_adic_reconst,0),
		a.qt_min_aplicacao,
		a.qt_hora_aplicacao,
		a.cd_unidade_medida_dose,
		a.ie_agrupador,
		a.qt_solucao,
		obter_conversao_ml(a.cd_material,a.qt_dose,a.cd_unidade_medida_dose),
		substr(b.ds_material,1,100),
		substr(b.ds_reduzida,1,100),
		ie_diluir_inteiro,
		x.qt_volume,
		x.qt_concentracao_total,
		x.cd_unid_med_concetracao,
		x.cd_unid_med_base_conc,
		x.ie_proporcao,
		x.qt_volume_medic
FROM material b, prescr_material a
LEFT OUTER JOIN material_diluicao x ON (a.nr_seq_mat_diluicao = x.nr_seq_interno)
WHERE ((a.nr_sequencia_diluicao = nr_seq_item_p) or (a.nr_sequencia = nr_seq_item_p)) and a.nr_prescricao		= nr_prescricao_p  and a.cd_material = b.cd_material and a.ie_agrupador IN (3,7,9) order by a.ie_agrupador desc;

	function get_UoM( ds_valor_p text) return text is
	;
BEGIN
		if (ds_valor_p = 'ml') and (pkg_i18n.get_user_locale() = 'en_AU') then
			return 'mL';
		else
			return ds_valor_p;
		end if;
	end;

	function addDoseLimitDescription return varchar2 as
		qt_dose_maxima_cpoe_w		cpoe_material.qt_dose_maxima%type;
		qt_dose_range_max_w		cpoe_material.qt_dose_range_max%type;
		qt_dose_range_min_w		cpoe_material.qt_dose_range_min%type;
		ds_unidade_medida_cpoe_w	varchar(100);
		ds_dose_maxima_cpoe_w		varchar(400);
		ds_dose_range_min_w		varchar(400);
		ds_dose_range_max_w		varchar(400);
		ds_retorno_w			varchar(4000);
	begin
		select	coalesce(max(qt_dose_maxima), 0),
			coalesce(max(qt_dose_range_max), 0),
			coalesce(max(qt_dose_range_min), 0),
			max(Obter_Desc_Unid_Med(cd_unidade_medida))
		into STRICT 	qt_dose_maxima_cpoe_w,
			qt_dose_range_max_w, 
			qt_dose_range_min_w,
			ds_unidade_medida_cpoe_w		
		from 	cpoe_material 
		where 	nr_sequencia = (SELECT 	max(nr_seq_mat_cpoe)
					from 	prescr_material
					where	nr_prescricao = nr_prescricao_p
					and	nr_sequencia  = nr_seq_item_p);
		
		if (qt_dose_maxima_cpoe_w > 0) then
			ds_dose_maxima_cpoe_w 	:= replace(obter_desc_expressao(970217), '#@QT_MAXIMUM_DOSE#@', qt_dose_maxima_cpoe_w);
			ds_dose_maxima_cpoe_w	:= replace(ds_dose_maxima_cpoe_w, '#@DS_UNIT_MEASUREMENT#@', ds_unidade_medida_cpoe_w);
		end if;
		
		if (qt_dose_range_min_w > 0) then
			ds_dose_range_min_w 	:= replace(obter_desc_expressao(656905), '#@QT_DOSE_MIN_P#@', qt_dose_range_min_w) || ' ' || ds_unidade_medida_cpoe_w;
		end if;
		
		if (qt_dose_range_max_w > 0) then
			ds_dose_range_max_w 	:= replace(obter_desc_expressao(656951), '#@QT_DOSE_MAX_P#@', qt_dose_range_max_w) || ' ' || ds_unidade_medida_cpoe_w;
		end if;
		
		ds_retorno_w	:= null;
		
		if (ds_dose_maxima_cpoe_w IS NOT NULL AND ds_dose_maxima_cpoe_w::text <> '') then
			ds_retorno_w	:= ds_dose_maxima_cpoe_w ||chr(10);
		end if;
		
		if (ds_dose_range_min_w IS NOT NULL AND ds_dose_range_min_w::text <> '') then
			ds_retorno_w	:= ds_retorno_w||ds_dose_range_min_w ||chr(10);
		end if;
		
		if (ds_dose_range_max_w IS NOT NULL AND ds_dose_range_max_w::text <> '') then
			ds_retorno_w	:= ds_retorno_w||ds_dose_range_max_w ||chr(10);
		end if;

		return ds_retorno_w;
	end;

BEGIN
if (nr_prescricao_p IS NOT NULL AND nr_prescricao_p::text <> '') and (nr_seq_item_p IS NOT NULL AND nr_seq_item_p::text <> '') then
	varIeGravarDiluicao_w := Obter_Param_Usuario(1113, 635, Obter_perfil_ativo, wheb_usuario_pck.get_nm_usuario, wheb_usuario_pck.get_cd_estabelecimento, varIeGravarDiluicao_w);

	select	substr(max(a.ds_diluicao_edit),1,1900),
			max(a.cd_material),
			max(coalesce(b.ie_aplicar,'S')),
			max(coalesce(a.ie_aplicar,'X')),
			max(coalesce(obter_conversao_ml(a.cd_material, a.qt_dose, a.cd_unidade_medida_dose), a.qt_dose)),
			coalesce(max(a.ie_aplic_bolus),'N'),
			coalesce(max(a.ie_aplic_lenta),'N')
	into STRICT	ds_diluicao_edit_w,
			cd_mat_ww,
			ie_aplicar_medic_w,
			ie_aplicar_ww,
			qt_dose_medic_w,
			ie_aplic_bolus_w,
			ie_lentamente_w
	from	prescr_material a,
			material b
	where	a.cd_material	= b.cd_material
	and		a.nr_prescricao	= nr_prescricao_p
	and		a.nr_sequencia	= nr_seq_item_p;
	ds_informacao_item_w := null;
	if (ie_aplic_bolus_w = 'S') then
		ds_informacao_item_w := wheb_mensagem_pck.get_texto(886236, null);
	elsif (ie_lentamente_w = 'S') then
		ds_informacao_item_w :=  wheb_mensagem_pck.get_texto(886235, null);
	end if;
	select	max(a.qt_dose)
	into STRICT	qt_dose_dil_w
	from 	prescr_material a
	where 	a.nr_sequencia_diluicao = nr_seq_item_p
	and		a.nr_prescricao			= nr_prescricao_p
	and		a.ie_agrupador			in (3);
	if (ie_aplicar_ww = 'N') then
		ie_aplicar_medic_w	:= 'N';
	elsif (ie_aplicar_ww = 'S') then
		ie_aplicar_medic_w	:= 'S';
	end if;
	select	max(cd_estabelecimento),
			max(cd_setor_atendimento)
	into STRICT	cd_estabelecimento_w,
			cd_setor_prescr_w
	from	prescr_medica
	where	nr_prescricao	= nr_Prescricao_p;
	select	max(Obter_Funcao_Ativa)
	into STRICT	cd_funcao_ativa_w
	;
	if (coalesce(varIeGravarDiluicao_w,'S') = 'S') then
		ds_diluicao_edit_w	:= substr(obter_diluicao_medic(nr_seq_item_p,nr_prescricao_p),1,2000);
	else
		ds_diluicao_edit_w	:= '';
	end if;
	select	coalesce(max(nr_casas_diluicao),0),
			coalesce(max(ie_separar),'S'),
			coalesce(max(ie_administrar_ui),'N'),
			coalesce(max(ie_aplicar),'N'),
			coalesce(max(ie_descr_redu_dil),'N'),
			coalesce(max(ie_mostrar_estabilidade),'N'),
			coalesce(max(ie_apres_vol_reconst),'N'),
			coalesce(max(ie_mostrar_aplic_ataque),'N'),
			coalesce(max(ie_mostrar_foto),'S'),
			coalesce(max(ie_mostrar_concentracao),'N'),
			coalesce(max(ie_exibe_justif_pt),'N'),
			coalesce(max(ie_mostrar_dil_pt),'S')
	into STRICT	nr_casas_diluicao_padrao_w,
			ie_separar_w,
			ie_administrar_ui_w,
			ie_aplicar_w,
			ie_descr_redu_dil_w,
			ie_mostrar_estabilidade_w,
			ie_apres_vol_reconst_w,
			ie_mostrar_aplic_ataque_w,
			ie_mostrar_foto_w,
			ie_mostrar_concentracao_w,
			ie_exibe_justif_pt_w,
			ie_mostrar_dil_pt_w
	from	parametro_medico
	where	cd_estabelecimento	= cd_estabelecimento_w;
	----- INICIAL Obter_Diluicao_Medic
	if	((coalesce(ie_mostrar_dil_pt_w,'S') = 'S') or (cd_funcao_ativa_w <> 950)) then

		if (ds_diluicao_edit_w IS NOT NULL AND ds_diluicao_edit_w::text <> '') then
			ds_retorno_w	:= ds_diluicao_edit_w;
		elsif (ie_aplicar_w = 'S') then
			ie_possui_diluente_w	:= 'N';
			open C00;
			loop
			fetch C00 into
				qt_dose_mat_w,
				qt_min_aplicacao_w,
				qt_hora_aplicacao_w,
				cd_unid_med_dose_mat_w,
				qt_solucao_ww,
				cd_unidade_medida_w,
				cd_medic_w,
				cd_estabelecimento_w,
				cd_intervalo_w,
				ie_via_aplicacao_w,
				ds_dose_diferenciada_w,
				ie_indice_w,
				ds_hora_w,
				ie_ordem_w,
				qt_diluicao_aux_w,
				cd_unid_med_diluente_aux_w,
				cd_setor_prescr_w,
				qt_unit_medic_w,
				ie_agrupador_ww,
				qt_volume_equipo_w,
				ie_fator_Correcao_w,
				qt_dose_especial_w,
				qt_min_aplic_dose_esp_w;
			EXIT WHEN NOT FOUND; /* apply on C00 */
				if (coalesce(ie_fator_Correcao_w,'N') = 'S') and (coalesce(qt_volume_equipo_w,0) > 0) and (coalesce(qt_dose_medic_w,0) > 0) and (coalesce(qt_dose_dil_w,0) > 0) then
					qt_total_w		:= qt_dose_medic_w + qt_dose_dil_w;
					qt_dose_aux_w	:= dividir((qt_dose_medic_w * 100), qt_total_w);	/*regra de 3 - pegar o percentual que a dose do medicamento representa em relacao a dose total somada com o diluente*/
					qt_conv_ml_w	:= dividir((qt_dose_aux_w * qt_volume_equipo_w), 100) + qt_dose_medic_w;	/* Regra de 3 para ver quanto sera repassado a dose do medicamento, de acordo com o percentual que a dose representa */
				else
					select	obter_conversao_ml(cd_medic_w,qt_dose_mat_w,cd_unid_med_dose_mat_w)
					into STRICT	qt_conv_ml_w
					;
				end if;
				if (coalesce(qt_conv_ml_w,0) = 0) then
					select	obter_conversao_ml(cd_medic_w,qt_dose_mat_w,cd_unid_med_dose_mat_w)
					into STRICT	qt_conv_ml_w
					;
				end if;
				select	coalesce(max(nr_casas_diluicao),0),
						coalesce(max(ie_separar),'S'),
						coalesce(max(ie_administrar_ui),'N'),
						coalesce(max(ie_aplicar),'N'),
						coalesce(max(ie_descr_redu_dil),'N'),
						coalesce(max(ie_mostrar_estabilidade),'N'),
						coalesce(max(ie_apres_vol_reconst),'N'),
						coalesce(max(ie_mostrar_aplic_ataque),'N'),
						coalesce(max(ie_mostrar_foto),'S'),
						coalesce(max(ie_mostrar_concentracao),'N')
				into STRICT	nr_casas_diluicao_w,
						ie_separar_w,
						ie_administrar_ui_w,
						ie_aplicar_w,
						ie_descr_redu_dil_w,
						ie_mostrar_estabilidade_w,
						ie_apres_vol_reconst_w,
						ie_mostrar_aplic_ataque_w,
						ie_mostrar_foto_w,
						ie_mostrar_concentracao_w
				from	parametro_medico
				where	cd_estabelecimento	= cd_estabelecimento_w;
				select	max(obter_casas_diluicao(cd_mat_ww, cd_setor_prescr_w))
				into STRICT	nr_casas_w
				;
				if (nr_casas_w > 0) then
					nr_casas_diluicao_w	:= nr_casas_w;
				end if;
				if (cd_intervalo_w IS NOT NULL AND cd_intervalo_w::text <> '') then
					select	max(ds_prescricao)
					into STRICT	ds_intervalo_w
					from	intervalo_prescricao
					where	cd_intervalo	= cd_intervalo_w;
					if (ie_via_aplicacao_w IS NOT NULL AND ie_via_aplicacao_w::text <> '') then
						ds_intervalo_w	:= ds_intervalo_w ||' '||ie_via_aplicacao_w;
					end if;
				end if;
				select	coalesce(max(ie_um_prescrita),'N')
				into STRICT	ie_um_prescrita_w
				from	regra_unid_med_diluente
				where	cd_setor_atendimento 	= cd_setor_prescr_w
				and		coalesce(cd_unidade_medida,cd_unid_med_dose_mat_w)	= cd_unid_med_dose_mat_w;
				if (ie_um_prescrita_w = 'S') then
					qt_conv_ml_w	:= 0;
				end if;
				if (qt_conv_ml_w > 0) then
					if (qt_conv_ml_w >= 1) or (round(qt_conv_ml_w,nr_casas_diluicao_w) >= 1) then
						if (nr_casas_diluicao_w = 0) then
							ds_conv_ml_w	:= substr(to_char(qt_conv_ml_w)||' '||get_UoM(obter_unid_med_usua('ml')),1,20);
						else
							ds_conv_ml_w	:= substr(to_char(round(qt_conv_ml_w,nr_casas_diluicao_w))||' '||get_UoM(obter_unid_med_usua('ml')),1,20);
						end if;
					elsif (nr_casas_diluicao_w = 0) then
						ds_conv_ml_w	:= substr('0'||to_char(qt_conv_ml_w)||' '||get_UoM(obter_unid_med_usua('ml')),1,20);
					else
						ds_conv_ml_w	:= substr('0'||to_char(round(qt_conv_ml_w,nr_casas_diluicao_w))||' '||get_UoM(obter_unid_med_usua('ml')),1,20);
					end if;
				end if;
				qt_dose_mat_str_w	:= qt_dose_mat_w;
				open c01;
				loop
				fetch c01 into
					cd_material_w,
					qt_dose_w,
					qt_vol_adic_reconst_w,
					qt_min_aplicacao_ant_w,
					qt_hora_aplicacao_ant_w,
					cd_unid_med_dose_w,
					ie_agrupador_w,
					qt_solucao_w,
					qt_dose_ml_w,
					ds_material_ww,
					ds_reduzida_w,
					ie_ConsisteDoseConsumoMedic_w,
					qt_volume_cad_w,
					qt_concentracao_total_w,
					cd_unid_med_concetracao_w,
					cd_unid_med_base_conc_w,
					ie_proporcao_w,
					qt_volume_medic_w;
				EXIT WHEN NOT FOUND; /* apply on c01 */
					begin
					if (ie_ConsisteDoseConsumoMedic_w = 'N') and (coalesce(ie_proporcao_w,'F') = 'F') and (coalesce(qt_volume_medic_w,0) > 0) then
					   qt_conv_ml_w := qt_volume_medic_w;
					end if;
					if (ie_agrupador_w = 3) and (coalesce(ie_fator_Correcao_w,'N') = 'S') and (coalesce(qt_volume_equipo_w,0) > 0) and (coalesce(qt_dose_medic_w,0) > 0) and (coalesce(qt_dose_ml_w,0) > 0) then
						qt_total_w		:= qt_dose_medic_w + qt_dose_ml_w;
						qt_dose_aux_w	:= dividir((qt_dose_ml_w * 100), qt_total_w);	/*regra de 3 - pegar o percentual que a dose do medicamento representa em relacao a dose total somada com o diluente*/
						qt_dose_ml_w	:= dividir((qt_dose_aux_w * qt_volume_equipo_w), 100) + qt_dose_ml_w;	/* Regra de 3 para ver quanto sera repassado a dose do medicamento, de acordo com o percentual que a dose representa */
					end if;
					select	CASE WHEN qt_unit_medic_w=0 THEN 1  ELSE qt_unit_medic_w END
					into STRICT	qt_unit_medic_div_w
					;
					if (ie_ConsisteDoseConsumoMedic_w = 'S') then
						qt_dose_mat_w	:= obter_dose_convertida(cd_medic_w, ceil(qt_unit_medic_w),
											cd_unidade_medida_w,cd_unid_med_dose_mat_w);
						select	obter_conversao_ml(cd_medic_w,qt_dose_mat_w,cd_unid_med_dose_mat_w)
						into STRICT	qt_conv_ml_w
						;
						select	coalesce(max(ie_um_prescrita),'N')
						into STRICT	ie_um_prescrita_w
						from	regra_unid_med_diluente
						where	cd_setor_atendimento 	= cd_setor_prescr_w
						and		coalesce(cd_unidade_medida,cd_unid_med_dose_mat_w)	= cd_unid_med_dose_mat_w;
						if (ie_um_prescrita_w = 'S') then
							qt_conv_ml_w	:= 0;
						end if;
						if (qt_conv_ml_w > 0) and (upper(cd_unid_med_dose_mat_w) <> upper(substr(obter_unid_med_usua('ML'),1,255))) then
							if (qt_conv_ml_w >= 1) then
								if (nr_casas_diluicao_w = 0) then
									ds_conv_ml_w	:= substr(to_char(qt_conv_ml_w)||' '||get_UoM(obter_unid_med_usua('ml')),1,20);
								else
									ds_conv_ml_w	:= substr(to_char(round(qt_conv_ml_w,nr_casas_diluicao_w))||' '||get_UoM(obter_unid_med_usua('ml')),1,20);
								end if;
							elsif (nr_casas_diluicao_w = 0) then
								ds_conv_ml_w	:= substr('0'||to_char(qt_conv_ml_w)||' '||get_UoM(obter_unid_med_usua('ml')),1,20);
							else
								ds_conv_ml_w	:= substr('0'||to_char(round(qt_conv_ml_w,nr_casas_diluicao_w))||' '||get_UoM(obter_unid_med_usua('ml')),1,20);
							end if;
						end if;
						qt_dose_mat_str_w	:= qt_dose_mat_w;
					end if;
					if (cd_material_w IS NOT NULL AND cd_material_w::text <> '') and (qt_dose_w IS NOT NULL AND qt_dose_w::text <> '') and (cd_unid_med_dose_w IS NOT NULL AND cd_unid_med_dose_w::text <> '') and (ie_agrupador_w = 9) and (coalesce(qt_registro_w,0) = 0) then
						begin
						select	obter_conversao_ml(cd_material_w,qt_dose_w + qt_vol_adic_reconst_w,cd_unid_med_dose_w)
						into STRICT	qt_conv_ml_w
						;
						select	coalesce(max(ie_um_prescrita),'N')
						into STRICT	ie_um_prescrita_w
						from	regra_unid_med_diluente
						where	cd_setor_atendimento 	= cd_setor_prescr_w
						and	coalesce(cd_unidade_medida,cd_unid_med_dose_w)	= cd_unid_med_dose_w;
						if (ie_um_prescrita_w = 'S') then
							qt_conv_ml_w	:= 0;
						end if;
						qt_conv_ml_w	:= obter_conversao_ml(cd_medic_w,qt_dose_mat_w,cd_unid_med_dose_mat_w);
						if (coalesce(ie_fator_Correcao_w,'N') = 'S') and (coalesce(qt_volume_equipo_w,0) > 0) and (coalesce(qt_dose_medic_w,0) > 0) and (coalesce(qt_dose_ml_w,0) > 0) then
							qt_conv_ml_w	:= dividir((qt_dose_aux_w * qt_volume_equipo_w), 100) + qt_conv_ml_w;	/* Regra de 3 para ver quanto sera repassado a dose do medicamento, de acordo com o percentual que a dose representa */
						end if;
						if (qt_conv_ml_w > 0) then
							if (qt_conv_ml_w >= 1) then
								if (nr_casas_diluicao_w = 0) then
									ds_conv_ml_w	:= substr(to_char(qt_conv_ml_w)||' '||get_UoM(obter_unid_med_usua('ml')),1,20);
								else
									ds_conv_ml_w	:= substr(to_char(round(qt_conv_ml_w,nr_casas_diluicao_w))||' '||get_UoM(obter_unid_med_usua('ml')),1,20);
								end if;
							elsif (nr_casas_diluicao_w = 0) then
								ds_conv_ml_w	:= substr('0'||to_char(qt_conv_ml_w)||' '||get_UoM(obter_unid_med_usua('ml')),1,20);
							else
								ds_conv_ml_w	:= substr('0'||to_char(round(qt_conv_ml_w,nr_casas_diluicao_w))||' '||get_UoM(obter_unid_med_usua('ml')),1,20);
							end if;
						end if;
						select 	CASE WHEN ie_descr_redu_dil_w='S' THEN ds_reduzida_w  ELSE ds_material_ww END
						into STRICT	ds_material_w
						;
						if (qt_dose_w < 1) or (mod(qt_dose_w, trunc(qt_dose_w)) <> 0) then
							mascara_w	:= 0;
						else
							mascara_w	:= 1;
						end if;
						if (nr_casas_diluicao_w > 3) then
							nr_casas_diluicao_w := 3;
						end if;
						Select 	CASE WHEN mascara_w=0 THEN  campo_mascara(qt_dose_w, nr_casas_diluicao_w)  ELSE campo_mascara(qt_dose_w, 0) END
						into STRICT	qt_dose_str_w
						;
						select	max(qt_conversao)
						into STRICT	qt_conversao_w
						from	material_conversao_unidade
						where	cd_material		= cd_medic_w
						and	cd_unidade_medida	= cd_unidade_medida_w;
						if (ie_apres_vol_reconst_w = 'S') and (qt_vol_adic_reconst_w > 0) then
							select	obter_conversao_ml(cd_material_w,qt_dose_w + qt_vol_adic_reconst_w,cd_unid_med_dose_w)
							into STRICT	qt_volume_adic_w
							;
							ds_total_reconst_w := substr(' (' || wheb_mensagem_pck.get_texto(306837, null) || ' '|| qt_volume_adic_w ||' '||get_UoM(obter_unid_med_usua('ml'))||').',1,255); -- Volume total apos reconstituicao
						end if;
						if (coalesce(qt_conversao_w::text, '') = '') then
							ds_reconstituir_w := 	ds_reconstituir_w || wheb_mensagem_pck.get_texto(306838, null) ||get_UoM(cd_unidade_medida_w)|| -- Reconstituir cada
									' ' || wheb_mensagem_pck.get_texto(306840, null) || ' ' ||replace_number_locale(qt_dose_str_w)||' '||cd_unid_med_dose_w|| -- em
									' ' || wheb_mensagem_pck.get_texto(306844, null) || ' ' ||ds_material_w || coalesce(ds_total_reconst_w,'.') || chr(13) || chr(10); -- de
						else
							ds_reconstituir_w := 	ds_reconstituir_w || wheb_mensagem_pck.get_texto(306838, null) || qt_conversao_w || ' ' ||get_UoM(cd_unidade_medida_w)|| -- Reconstituir cada
									' ' || wheb_mensagem_pck.get_texto(306840, null) || ' ' || replace_number_locale(qt_dose_str_w)||' '||cd_unid_med_dose_w|| -- em
									' ' || wheb_mensagem_pck.get_texto(306844, null) || ' ' || ds_material_w || coalesce(ds_total_reconst_w,'.') || chr(13) || chr(10); -- de
						end if;
						end;
					end if;
					if (ie_indice_w		= 2) and (coalesce(qt_registro_w,0)	= 0) and (coalesce(ds_rediluir_w::text, '') = '') then
						select	max(a.cd_material),
								max(a.qt_dose),
								max(a.cd_unidade_medida_dose),
								max(a.qt_solucao),
								max(obter_conversao_ml(a.cd_material,a.qt_dose,a.cd_unidade_medida_dose)),
								max(substr(b.ds_material,1,100)),
								max(substr(b.ds_reduzida,1,100))
						into STRICT	cd_material_red_w,
								qt_dose_red_w,
								cd_unid_med_dose_red_w,
								qt_solucao_red_w,
								qt_dose_ml_red_w,
								ds_material_red_ww,
								ds_reduzida_red_w
						from 	material b,
								prescr_material a
						where 	((a.nr_sequencia_diluicao = nr_seq_item_p) or (a.nr_sequencia = nr_seq_item_p))
						  and 	a.nr_prescricao = nr_prescricao_p
						  and	a.cd_material = b.cd_material
						  and	a.ie_agrupador = 7;
						if (cd_material_red_w IS NOT NULL AND cd_material_red_w::text <> '') and (qt_dose_red_w IS NOT NULL AND qt_dose_red_w::text <> '') and (cd_unid_med_dose_red_w IS NOT NULL AND cd_unid_med_dose_red_w::text <> '') then
							select 	CASE WHEN ie_descr_redu_dil_w='S' THEN ds_reduzida_red_w  ELSE ds_material_red_ww END
							into STRICT	ds_material_red_w
							;
							cd_volume_final_red_w := qt_dose_ml_red_w + qt_solucao_red_w;
							if (nr_casas_diluicao_w > 0) then
								qt_solucao_red_w	:= round(qt_solucao_red_w,nr_casas_diluicao_w);
							end if;
							if (nr_casas_diluicao_w > 0) then
								qt_dose_ml_red_w	:= round(qt_dose_ml_red_w,nr_casas_diluicao_w);
							end if;
							if (nr_casas_diluicao_w > 0) then
								qt_dose_red_w	:= round(qt_dose_red_w,nr_casas_diluicao_w);
							end if;
							if (qt_solucao_red_w < 1) or (mod(qt_solucao_red_w, trunc(qt_solucao_red_w)) <> 0) then
								mascara_w	:= 0;
							else
								mascara_w	:= 1;
							end if;
							ds_dose_diluicao_w	:= replace_number_locale(qt_dose_ml_red_w) ||' '||obter_unid_med_usua('ml');
							if (qt_dose_ml_red_w = 0) then
								begin
								ds_dose_diluicao_w	:= replace_number_locale(qt_dose_red_w) ||' '||cd_unid_med_dose_red_w;
								end;
							end if;
							select 	CASE WHEN mascara_w=0 THEN  campo_mascara(qt_solucao_red_w, 2)  ELSE campo_mascara(qt_solucao_red_w, 0) END
							into STRICT	qt_solucao_str_w
							;
							if (ie_separar_w = 'S') then
								ds_rediluir_w := ds_rediluir_w|| wheb_mensagem_pck.get_texto(306845, null) || ' '||replace_number_locale(qt_solucao_str_w) ||' '||get_UoM(obter_unid_med_usua('ml')) || ' ' || wheb_mensagem_pck.get_texto(306846, null) || ' ' || -- Separar		desta solucao em
										ds_dose_diluicao_w ||' ' || wheb_mensagem_pck.get_texto(306844, null) || ' '||ds_material_red_w || chr(13) || chr(10); -- de
							else
								ds_rediluir_w := ds_rediluir_w|| wheb_mensagem_pck.get_texto(306848, null) || ' '||replace_number_locale(qt_solucao_str_w)||' '||get_UoM(obter_unid_med_usua('ml'))||' ' || wheb_mensagem_pck.get_texto(306846, null) || ' '|| -- Rediluir		desta solucao em
										ds_dose_diluicao_w ||' ' || wheb_mensagem_pck.get_texto(306844, null) || ' '||ds_material_red_w || chr(13) || chr(10); -- de
							end if;
						end if;
					end if;
					if (cd_material_w IS NOT NULL AND cd_material_w::text <> '') and (qt_dose_w IS NOT NULL AND qt_dose_w::text <> '') and (cd_unid_med_dose_w IS NOT NULL AND cd_unid_med_dose_w::text <> '') and (ie_agrupador_w = 3) then
						begin
						select	coalesce(max(ie_um_prescrita),'N')
						into STRICT	ie_um_prescrita_w
						from	regra_unid_med_diluente
						where	cd_setor_atendimento 	= cd_setor_prescr_w
						and		coalesce(cd_unidade_medida,cd_unid_med_dose_mat_w)	= cd_unid_med_dose_mat_w;
						if (ie_um_prescrita_w = 'S') then
							qt_dose_ml_w	:= 0;
						end if;
						qt_ml_diluente_w	:= qt_dose_ml_w;
						select 	CASE WHEN ie_descr_redu_dil_w='S' THEN ds_reduzida_w  ELSE ds_material_ww END
						into STRICT	ds_material_w
						;
						if (ie_agrupador_ww = 8) or (ie_agrupador_ww = 12) then
							ds_aux_diluir_w	:= wheb_mensagem_pck.get_texto(306849, null); -- do produto
						else
							ds_aux_diluir_w	:= wheb_mensagem_pck.get_texto(306852, null); -- do medicamento
						end if;
						if (ds_reconstituir_w IS NOT NULL AND ds_reconstituir_w::text <> '') then
							ds_aux_diluir_w	:= wheb_mensagem_pck.get_texto(306853, null); --  da reconstituicao
						end if;
						if (nr_casas_diluicao_w = 0) then
							ds_dose_diluicao_w	:= substr(replace_number_locale(qt_dose_ml_w) ||' '||get_UoM(obter_unid_med_usua('ml')),1,100);
						else
							ds_dose_diluicao_w	:= substr(replace_number_locale(round(qt_dose_ml_w,nr_casas_diluicao_w)) ||' '||get_UoM(obter_unid_med_usua('ml')),1,100);
						end if;
						if (qt_dose_ml_w = 0) then
							begin
							ds_dose_diluicao_w	:= replace_number_locale(qt_dose_w) ||' '||cd_unid_med_dose_w;
							end;
						end if;
						if (coalesce(qt_solucao_w,0)	> 0) then
							if (qt_volume_cad_w	> 0) then /*Caldas - OS153626 13/07/2009 */
								select	max(obter_conversao_ml(cd_material_w,qt_dose_w,cd_unid_med_dose_w))
								into STRICT	qt_dose_ml_teste_w
								;
								if (qt_solucao_w >= 1) then
									if (nr_casas_diluicao_w = 0) then
										ds_dose_diluicao_w	:= substr(to_char(qt_solucao_w)||' '||get_UoM(obter_unid_med_usua('ml')),1,100);
										ds_conv_ml_w		:= substr(to_char(qt_dose_ml_teste_w)||' '||get_UoM(obter_unid_med_usua('ml')),1,20);
									else
										ds_dose_diluicao_w	:= substr(to_char(round(qt_solucao_w,nr_casas_diluicao_w))||' '||get_UoM(obter_unid_med_usua('ml')),1,100);
										ds_conv_ml_w	:= substr(to_char(round(qt_dose_ml_teste_w,nr_casas_diluicao_w))||' '||get_UoM(obter_unid_med_usua('ml')),1,20);
									end if;
								elsif (nr_casas_diluicao_w = 0) then
									ds_dose_diluicao_w	:= substr('0'||to_char(qt_solucao_w)||' '||get_UoM(obter_unid_med_usua('ml')),1,100);
									ds_conv_ml_w	:= substr('0'||to_char(qt_dose_ml_teste_w)||' '||get_UoM(obter_unid_med_usua('ml')),1,20);
								else
									ds_dose_diluicao_w	:= substr('0'||to_char(round(qt_solucao_w,nr_casas_diluicao_w))||' '||get_UoM(obter_unid_med_usua('ml')),1,100);
									ds_conv_ml_w	:= substr('0'||to_char(round(qt_dose_ml_teste_w,nr_casas_diluicao_w))||' '||get_UoM(obter_unid_med_usua('ml')),1,20);
								end if;
								qt_conv_ml_w	:= qt_dose_ml_teste_w;
							else
								if (qt_solucao_w >= 1) then
									if (nr_casas_diluicao_w = 0) then
										ds_conv_ml_w	:= substr(to_char(qt_solucao_w)||' '||get_UoM(obter_unid_med_usua('ml')),1,20);
									else
										ds_conv_ml_w	:= substr(to_char(round(qt_solucao_w,nr_casas_diluicao_w))||' '||get_UoM(obter_unid_med_usua('ml')),1,20);
									end if;
								elsif (nr_casas_diluicao_w = 0) then
									ds_conv_ml_w	:= substr('0'||to_char(qt_solucao_w)||' '||get_UoM(obter_unid_med_usua('ml')),1,20);
								else
									ds_conv_ml_w	:= substr('0'||to_char(round(qt_solucao_w,nr_casas_diluicao_w))||' '||get_UoM(obter_unid_med_usua('ml')),1,20);
								end if;
								qt_conv_ml_w	:= qt_solucao_w;
							end if;
						end if;
						select	coalesce(max(ie_um_prescrita),'N')
						into STRICT	ie_um_prescrita_w
						from	regra_unid_med_diluente
						where	cd_setor_atendimento 	= cd_setor_prescr_w
						and		coalesce(cd_unidade_medida,cd_unid_med_dose_mat_w)	= cd_unid_med_dose_mat_w;
						if (ie_um_prescrita_w = 'S') then
							qt_conv_ml_w	:= 0;
							ds_conv_ml_w	:= '';
						end if;
						if (ie_indice_w = 2) then
							if (ie_agrupador_ww = 8) or (ie_agrupador_ww = 12) then
								ds_aux_diluir_w	:= wheb_mensagem_pck.get_texto(306849, null); -- do produto
							else
								ds_aux_diluir_w	:= wheb_mensagem_pck.get_texto(306852, null); -- do medicamento
							end if;
							if (ds_reconstituir_w IS NOT NULL AND ds_reconstituir_w::text <> '') then
								ds_aux_diluir_w	:= wheb_mensagem_pck.get_texto(306853, null); -- da reconstituicao
							end if;
							if (qt_min_aplicacao_w IS NOT NULL AND qt_min_aplicacao_w::text <> '') then
								ds_tempo_w	:= wheb_mensagem_pck.get_texto(306840, null) || ' ' || to_char(qt_min_aplicacao_w) || ' ' || wheb_mensagem_pck.get_texto(306858, null) || ' ' || ds_hora_w; -- em		min. no horario
							end if;
							if (nr_casas_diluicao_w > 0) then
								ds_volume_w := substr(' '||to_char(round(qt_conv_ml_w + qt_ml_diluente_w,nr_casas_diluicao_w)) ||' '||get_UoM(obter_unid_med_usua('ml')),1,100);
								if (ie_ConsisteDoseConsumoMedic_w = 'S') then
									ds_volume_w	:= substr(' '||to_char(round((((qt_conv_ml_w + qt_dose_ml_w) * qt_unit_medic_w) / ceil(qt_unit_medic_div_w)),nr_casas_diluicao_w)) ||' '||get_UoM(obter_unid_med_usua('ml')),1,100);
								end if;
								if (ie_administrar_ui_w = 'S') then
									select	count(*)
									into STRICT	cont_ww
									from	material_conversao_unidade
									where	cd_material	= cd_mat_ww
									and	upper(cd_unidade_medida) = upper(obter_unid_med_usua('UI'));
									if (cont_ww > 0) then
										select	count(*)
										into STRICT	cont_ww
										from	regra_setor_conv_unid
										where	cd_material	= cd_mat_ww
										and	upper(cd_unidade_medida) = upper(obter_unid_med_usua('UI'))
										and	cd_setor_atendimento = cd_setor_prescr_w;
										if (cont_ww > 0) then
											ds_adm_ui_w	:= ' '||to_char(Obter_dose_convertida(cd_mat_ww,round(qt_conv_ml_w + qt_ml_diluente_w,nr_casas_diluicao_w), get_UoM(obter_unid_med_usua('ml')),obter_unid_med_usua('UI'))) ||' '||obter_unid_med_usua('UI');
										end if;
									end if;
								end if;
							else
								ds_volume_w	:= substr(' '||to_char(qt_conv_ml_w + qt_ml_diluente_w) ||' '||get_UoM(obter_unid_med_usua('ml')),1,100);
								if (ie_ConsisteDoseConsumoMedic_w = 'S') then
									ds_volume_w	:= substr(' '||to_char((((qt_conv_ml_w + qt_dose_ml_w) * qt_unit_medic_w) / ceil(qt_unit_medic_div_w))) ||' '||get_UoM(obter_unid_med_usua('ml')),1,100);
								end if;
								if (ie_administrar_ui_w = 'S') then
									select	count(*)
									into STRICT	cont_ww
									from	material_conversao_unidade
									where	cd_material = cd_mat_ww
									and	upper(cd_unidade_medida) = upper(obter_unid_med_usua('UI'));
									if (cont_ww > 0) then
										select	count(*)
										into STRICT	cont_ww
										from	regra_setor_conv_unid
										where	cd_material	= cd_mat_ww
										and	upper(cd_unidade_medida) = upper(obter_unid_med_usua('UI'))
										and	cd_setor_atendimento = cd_setor_prescr_w;
										if (cont_ww > 0) then
											ds_adm_ui_w	:= ' '||to_char(Obter_dose_convertida(cd_mat_ww, (qt_conv_ml_w + qt_ml_diluente_w),get_UoM(obter_unid_med_usua('ml')),obter_unid_med_usua('UI'))) ||' '||obter_unid_med_usua('UI');
										end if;
									end if;
								end if;
							end if;
							
							if (ds_volume_w IS NOT NULL AND ds_volume_w::text <> '') then
								ds_aplicar_w	:= wheb_mensagem_pck.get_texto(306859, null) || replace_number_locale(ds_volume_w) || ' '|| ds_tempo_w ||' '||ds_informacao_item_w; -- Administrar
								if (ds_adm_ui_w IS NOT NULL AND ds_adm_ui_w::text <> '') then
									ds_aplicar_w	:= ds_aplicar_w || chr(13) || ' ' || wheb_mensagem_pck.get_texto(306859, null) || replace_number_locale(ds_adm_ui_w) || ' '|| ds_tempo_w||' '||ds_informacao_item_w; -- Administrar
								end if;
							elsif (ds_tempo_w IS NOT NULL AND ds_tempo_w::text <> '') then
								ds_aplicar_w	:= wheb_mensagem_pck.get_texto(306859, null) ||ds_tempo_w||' '||ds_informacao_item_w; -- Administrar
							end if;
							select	max(obter_conversao_ml(cd_material_w,qt_diluicao_aux_w,cd_unid_med_diluente_aux_w))
							into STRICT	qt_dose_ml_w
							;
							if (nr_casas_diluicao_w = 0) then
								ds_dose_diluicao_w	:= substr(replace_number_locale(qt_dose_ml_w) ||' '||get_UoM(obter_unid_med_usua('ml')),1,100);
							else
								ds_dose_diluicao_w	:= substr(replace_number_locale(round(qt_dose_ml_w,nr_casas_diluicao_w)) ||' '||get_UoM(obter_unid_med_usua('ml')),1,100);
							end if;
							if (qt_dose_ml_w = 0) then
								ds_dose_diluicao_w	:= replace_number_locale(qt_diluicao_aux_w) ||' '||cd_unid_med_diluente_aux_w;
							end if;
							if (ie_separar_w = 'S') then
								ds_diluir_w := 	ds_diluir_w ||wheb_mensagem_pck.get_texto(306845, null) || ' '||replace_number_locale(qt_dose_mat_str_w)||' '||cd_unid_med_dose_mat_w|| ds_aux_diluir_w||' ' || wheb_mensagem_pck.get_texto(306840, null) || ' '|| -- Separar		em
										ds_dose_diluicao_w ||' ' || wheb_mensagem_pck.get_texto(306844, null) || ' '||ds_material_w || chr(13) || chr(10) || -- de
										ds_rediluir_w || ds_aplicar_w || chr(13) || chr(10);
							else
								ds_diluir_w := 	ds_diluir_w ||wheb_mensagem_pck.get_texto(306860, null) || ' '||replace_number_locale(qt_dose_mat_str_w)||' '||cd_unid_med_dose_mat_w|| ds_aux_diluir_w||' ' || wheb_mensagem_pck.get_texto(306840, null) || ' '|| -- Diluir		em
										ds_dose_diluicao_w ||' ' || wheb_mensagem_pck.get_texto(306844, null) || ' '||ds_material_w || chr(13) || chr(10) || -- de
										ds_rediluir_w || ds_aplicar_w || chr(13) || chr(10);
							end if;
						elsif (coalesce(ds_conv_ml_w::text, '') = '') and (coalesce(ds_diluir_w::text, '') = '') then
							if (ds_dose_diferenciada_w IS NOT NULL AND ds_dose_diferenciada_w::text <> '') then
								if (ie_agrupador_ww = 8) or (ie_agrupador_ww = 12) then
									ds_aux_diluir_w	:= lower(wheb_mensagem_pck.get_texto(306865, null)); -- produto
								else
									ds_aux_diluir_w	:= lower(wheb_mensagem_pck.get_texto(306866, null)); -- medicamento
								end if;
								if (ds_reconstituir_w IS NOT NULL AND ds_reconstituir_w::text <> '') then
									ds_aux_diluir_w	:= lower(wheb_mensagem_pck.get_texto(306867, null)); -- reconstituicao
								end if;
								if (ie_separar_w = 'S') then
									ds_diluir_w := 	ds_diluir_w ||wheb_mensagem_pck.get_texto(306845, null)||' '|| ds_aux_diluir_w || ' '|| wheb_mensagem_pck.get_texto(306862,null) || ' ('||ds_dose_diferenciada_w||') ' || wheb_mensagem_pck.get_texto(306840, null) || ' '|| -- Separar		conforme dose do horario		em
										ds_dose_diluicao_w||' ' || wheb_mensagem_pck.get_texto(306844, null) || ' '||ds_material_w || chr(13) || chr(10); -- de
								else
								ds_diluir_w := 	ds_diluir_w ||wheb_mensagem_pck.get_texto(306860, null) || ' '|| ds_aux_diluir_w || '  '|| wheb_mensagem_pck.get_texto(306862,null) || ' ('||ds_dose_diferenciada_w||') ' || wheb_mensagem_pck.get_texto(306840, null) || ' '|| -- Diluir		conforme dose do horario		em
										ds_dose_diluicao_w||' ' || wheb_mensagem_pck.get_texto(306844, null) || ' '||ds_material_w || chr(13) || chr(10); --  de
								end if;
							elsif (ie_separar_w = 'S') then
								ds_diluir_w := 	ds_diluir_w ||wheb_mensagem_pck.get_texto(306845, null) ||' '||replace_number_locale(qt_dose_mat_str_w)||' '||cd_unid_med_dose_mat_w|| ds_aux_diluir_w||' ' || wheb_mensagem_pck.get_texto(306840, null) || ' '|| -- Separar		em
									ds_dose_diluicao_w||' ' || wheb_mensagem_pck.get_texto(306844, null) || ' '||ds_material_w || chr(13) || chr(10); -- de
							else
								ds_diluir_w := 	ds_diluir_w ||wheb_mensagem_pck.get_texto(306860, null)||' '||replace_number_locale(qt_dose_mat_str_w)||' '||cd_unid_med_dose_mat_w|| ds_aux_diluir_w||' ' || wheb_mensagem_pck.get_texto(306840, null) || ' '|| -- Diluir		em
									ds_dose_diluicao_w||' ' || wheb_mensagem_pck.get_texto(306844, null) || ' '||ds_material_w || chr(13) || chr(10); -- de
							end if;
						elsif (coalesce(ds_diluir_w::text, '') = '') then
								if (ie_ConsisteDoseConsumoMedic_w = 'N') and (coalesce(ie_proporcao_w,'F') = 'F') and (coalesce(qt_volume_medic_w,0) > 0) then
								   ds_conv_ml_w := substr(qt_volume_medic_w||' '||get_UoM(obter_unid_med_usua('ml')),1,20);
								end if;
							if (ds_dose_diferenciada_w IS NOT NULL AND ds_dose_diferenciada_w::text <> '') then
								if (ie_agrupador_ww = 8) or (ie_agrupador_ww = 12) then
									ds_aux_diluir_w	:= lower(wheb_mensagem_pck.get_texto(306865, null)); -- produto
								else
									ds_aux_diluir_w	:= lower(wheb_mensagem_pck.get_texto(306866, null)); -- medicamento
								end if;
								if (ds_reconstituir_w IS NOT NULL AND ds_reconstituir_w::text <> '') then
									ds_aux_diluir_w	:= lower(wheb_mensagem_pck.get_texto(306867, null)); -- reconstituicao
								end if;
								if (ie_separar_w = 'S') then
									ds_diluir_w := 	ds_diluir_w ||wheb_mensagem_pck.get_texto(306845, null) || ' '||ds_aux_diluir_w||' ' ||wheb_mensagem_pck.get_texto(306862,null)|| ' ('||ds_dose_diferenciada_w||') ' || wheb_mensagem_pck.get_texto(306840, null) || ' '||
										ds_dose_diluicao_w||' ' || wheb_mensagem_pck.get_texto(306844, null) || ' '||ds_material_w || chr(13) || chr(10);
									else
										ds_diluir_w := 	ds_diluir_w ||wheb_mensagem_pck.get_texto(306860, null)||' '||ds_aux_diluir_w||' ' ||wheb_mensagem_pck.get_texto(306862,null)|| ' ('||ds_dose_diferenciada_w||') ' || wheb_mensagem_pck.get_texto(306840, null) || ' '||
										ds_dose_diluicao_w||' ' || wheb_mensagem_pck.get_texto(306844, null) || ' '||ds_material_w || chr(13) || chr(10);
								end if;
							elsif (ie_separar_w = 'S') then
								ds_diluir_w := 	ds_diluir_w ||wheb_mensagem_pck.get_texto(306845, null) || ' ' ||ds_conv_ml_w ||ds_aux_diluir_w||' ' || wheb_mensagem_pck.get_texto(306840, null) || ' '||
									ds_dose_diluicao_w||' ' || wheb_mensagem_pck.get_texto(306844, null) || ' '||ds_material_w || chr(13) || chr(10);
							else
								ds_diluir_w := 	ds_diluir_w ||wheb_mensagem_pck.get_texto(306860, null)||' ' ||ds_conv_ml_w ||ds_aux_diluir_w||' ' || wheb_mensagem_pck.get_texto(306840, null) || ' '||
									ds_dose_diluicao_w||' ' || wheb_mensagem_pck.get_texto(306844, null) || ' '||ds_material_w || chr(13) || chr(10);
							end if;
						elsif (ie_separar_w = 'S') then
							ds_diluir_w := 	ds_diluir_w ||wheb_mensagem_pck.get_texto(306845, null) || ' ' || wheb_mensagem_pck.get_texto(306869,null) ||' '|| -- a solucao em
								ds_dose_diluicao_w ||' ' || wheb_mensagem_pck.get_texto(306844, null) || ' '||ds_material_w || chr(13) || chr(10);
						else
							ds_diluir_w := 	ds_diluir_w ||wheb_mensagem_pck.get_texto(306860, null)||' ' || wheb_mensagem_pck.get_texto(306869,null) ||' '|| --  a solucao em
								ds_dose_diluicao_w ||' ' || wheb_mensagem_pck.get_texto(306844, null) || ' '||ds_material_w || chr(13) || chr(10);
						end if;
						end;
					end if;
					if (cd_material_w IS NOT NULL AND cd_material_w::text <> '') and (qt_dose_w IS NOT NULL AND qt_dose_w::text <> '') and (cd_unid_med_dose_w IS NOT NULL AND cd_unid_med_dose_w::text <> '') and (ie_agrupador_w = 7) and (ie_indice_w <> 2) then
						begin
						select 	CASE WHEN ie_descr_redu_dil_w='S' THEN ds_reduzida_w  ELSE ds_material_ww END
						into STRICT	ds_material_w
						;
						cd_volume_final_w := qt_dose_ml_w + qt_solucao_w;
						if (nr_casas_diluicao_w > 0) then
							qt_solucao_w	:= round(qt_solucao_w,nr_casas_diluicao_w);
						end if;
						if (qt_dose_ml_w > 0) and (nr_casas_diluicao_W > 0) then
						   qt_dose_ml_w := round(qt_dose_ml_w,nr_casas_diluicao_w);
						end if;
						if (qt_dose_w > 0) and (nr_casas_diluicao_W > 0) then
						   qt_dose_w := round(qt_dose_w,nr_casas_diluicao_w);
						end if;
						if (qt_solucao_w < 1) or (mod(qt_solucao_w, trunc(qt_solucao_w)) <> 0) then
							mascara_w	:= 0;
						else
							mascara_w	:= 1;
						end if;
						ds_dose_diluicao_w	:= substr(replace_number_locale(qt_dose_ml_w) ||' '||get_UoM(obter_unid_med_usua('ml')),1,100);
						if (qt_dose_ml_w = 0) then
							begin
							ds_dose_diluicao_w	:= replace_number_locale(qt_dose_w) ||' '||cd_unid_med_dose_w;
							end;
						end if;
						Select 	CASE WHEN mascara_w=0 THEN  campo_mascara(qt_solucao_w, 2)  ELSE campo_mascara(qt_solucao_w, 0) END
						into STRICT	qt_solucao_str_w
						;
						if (ie_separar_w = 'S') then
							ds_rediluir_w := ds_rediluir_w||wheb_mensagem_pck.get_texto(306845, null) || ' '||replace_number_locale(qt_solucao_str_w)||' '||get_UoM(obter_unid_med_usua('ml'))||' ' ||wheb_mensagem_pck.get_texto(306846,null)|| ' '||
									ds_dose_diluicao_w ||' ' || wheb_mensagem_pck.get_texto(306844, null) || ' '||ds_material_w || chr(13) || chr(10);
						else
							ds_rediluir_w := ds_rediluir_w||wheb_mensagem_pck.get_texto(306848, null)||' '||replace_number_locale(qt_solucao_str_w)||' '||get_UoM(obter_unid_med_usua('ml'))||' ' ||wheb_mensagem_pck.get_texto(306846,null)|| ' '||
									ds_dose_diluicao_w ||' ' || wheb_mensagem_pck.get_texto(306844, null) || ' '||ds_material_w || chr(13) || chr(10);
						end if;
						end;
					end if;
					end;
					ie_possui_diluente_w	:= 'S';
				end loop;
				close c01;
				qt_registro_w	:= qt_registro_w + 1;
				if (ie_mostrar_concentracao_w = 'S') then
					begin
					if (qt_concentracao_total_w IS NOT NULL AND qt_concentracao_total_w::text <> '') and (cd_unid_med_concetracao_w IS NOT NULL AND cd_unid_med_concetracao_w::text <> '') and (cd_unid_med_base_conc_w IS NOT NULL AND cd_unid_med_base_conc_w::text <> '') then
						ds_rediluir_w := ds_rediluir_w || wheb_mensagem_pck.get_texto(306873,null) ||': ' || replace_number_locale(qt_concentracao_total_w) || ' ' || -- Concentracao ideal
							cd_unid_med_concetracao_w || '/' || cd_unid_med_base_conc_w || chr(13) || chr(10);
					end if;
					end;
				end if;
			end loop;
			close C00;
			--ds_aplicar_w	:= '';
			if (cd_volume_final_w < 1) or (mod(cd_volume_final_w, trunc(cd_volume_final_w)) <> 0) then
				mascara_w	:= 0;
			else
				mascara_w	:= 1;
			end if;
			if (qt_min_aplicacao_w IS NOT NULL AND qt_min_aplicacao_w::text <> '') and (qt_hora_aplicacao_w IS NOT NULL AND qt_hora_aplicacao_w::text <> '') and
				((coalesce(qt_min_aplicacao_w,0) > 0) and (coalesce(qt_hora_aplicacao_w,0) > 0))then
				ds_tempo_w	:=  ' ' || wheb_mensagem_pck.get_texto(306840, null) || ' ' || to_char(qt_hora_aplicacao_w) || ' ' || wheb_mensagem_pck.get_texto(306879,null) || ' ' || wheb_mensagem_pck.get_texto(306894,null) || ' '|| to_char(qt_min_aplicacao_w) || ' '|| lower(wheb_mensagem_pck.get_texto(306874,null)); --h. e		min.
			elsif (coalesce(qt_min_aplicacao_w::text, '') = '') and (qt_hora_aplicacao_w IS NOT NULL AND qt_hora_aplicacao_w::text <> '') then
				ds_tempo_w	:= ' ' || wheb_mensagem_pck.get_texto(306840, null) || ' ' || to_char(qt_hora_aplicacao_w) || ' ' || wheb_mensagem_pck.get_texto(306879,null);
			elsif (qt_min_aplicacao_w IS NOT NULL AND qt_min_aplicacao_w::text <> '') and (coalesce(qt_hora_aplicacao_w::text, '') = '') then
				ds_tempo_w	:= ' ' || wheb_mensagem_pck.get_texto(306840, null) || ' ' || to_char(qt_min_aplicacao_w) || ' '|| lower(wheb_mensagem_pck.get_texto(306874,null)); -- min.
			end if;
			ds_volume_w := null;
			if (coalesce(ie_fator_Correcao_w,'N') = 'S') and (coalesce(qt_volume_equipo_w,0) > 0) and (coalesce(qt_dose_medic_w,0) > 0) and (ie_um_prescrita_w <> 'S') and
				((coalesce(qt_dose_dil_w,0) > 0) or (coalesce(qt_dose_ml_w,0) > 0)) then
				 qt_ret_volume_equipo_w		:= qt_volume_equipo_w;
			end if;
			Select 	CASE WHEN mascara_w=0 THEN  campo_mascara(cd_volume_final_w - qt_ret_volume_equipo_w, 2)  ELSE campo_mascara(cd_volume_final_w - qt_ret_volume_equipo_w, 0) END
			into STRICT	cd_volume_final_str_w
			;
			if (qt_solucao_ww IS NOT NULL AND qt_solucao_ww::text <> '') and (qt_solucao_ww > 0) then
				if (nr_casas_diluicao_w > 0) then
					ds_volume_w	:= substr(' '||to_char(round(qt_solucao_ww - qt_ret_volume_equipo_w,nr_casas_diluicao_w)) ||' '||get_UoM(obter_unid_med_usua('ml')),1,100);
					qt_volume_ww	:= round(qt_solucao_ww,nr_casas_diluicao_w);
				else
					ds_volume_w	:= substr(' '||to_char(qt_solucao_ww - qt_ret_volume_equipo_w) ||' '||get_UoM(obter_unid_med_usua('ml')),1,100);
					qt_volume_ww	:= qt_solucao_ww;
				end if;
			elsif (ie_aplicar_w = 'S') then
				begin
				if (ds_rediluir_w IS NOT NULL AND ds_rediluir_w::text <> '') then
					ds_volume_w	:= substr(' '||to_char(cd_volume_final_str_w)  ||' '||get_UoM(obter_unid_med_usua('ml')),1,100);
				elsif (ds_diluir_w IS NOT NULL AND ds_diluir_w::text <> '') then
					if (nr_casas_diluicao_w > 0) then
						ds_volume_w	:= substr(' '||to_char(round(qt_conv_ml_w + qt_ml_diluente_w - qt_ret_volume_equipo_w,nr_casas_diluicao_w)) ||' '||get_UoM(obter_unid_med_usua('ml')),1,100);
						qt_volume_ww	:= round(qt_conv_ml_w + qt_ml_diluente_w,nr_casas_diluicao_w);
						if (coalesce(qt_volume_medic_w,0) > 0) then
							qt_conversao_ww := Obter_dose_convertida(cd_medic_w, qt_conv_ml_w, get_UoM(obter_unid_med_usua('ml')), cd_unid_med_dose_mat_w);
							if (coalesce(qt_conversao_ww,0) > 0) then
								ds_volume_w	:= ' '||to_char(round(((qt_conv_ml_w + qt_dose_ml_w ) * qt_dose_mat_w) / ceil(qt_conversao_ww),nr_casas_diluicao_w)) ||' '||obter_desc_unid_med(get_UoM(obter_unid_med_usua('ml')));
							end if;
						end if;
						if (ie_ConsisteDoseConsumoMedic_w = 'S') then
							ds_volume_w	:= substr(' '||to_char(round(((qt_conv_ml_w + qt_dose_ml_w ) * qt_unit_medic_w) / ceil(qt_unit_medic_div_w),nr_casas_diluicao_w)) ||' '||get_UoM(obter_unid_med_usua('ml')),1,100);
							qt_volume_ww	:= round(((qt_conv_ml_w + qt_dose_ml_w) * qt_unit_medic_w) / ceil(qt_unit_medic_div_w),nr_casas_diluicao_w);
						end if;
					else
						ds_volume_w	:= substr(' '||to_char(qt_conv_ml_w + qt_ml_diluente_w - qt_ret_volume_equipo_w) ||' '||get_UoM(obter_unid_med_usua('ml')),1,100);
						qt_volume_ww	:= qt_conv_ml_w + qt_ml_diluente_w;
						if (ie_ConsisteDoseConsumoMedic_w = 'S') then
							ds_volume_w	:= substr(' '||to_char((((qt_conv_ml_w + qt_dose_ml_w) * qt_unit_medic_w) / ceil(qt_unit_medic_div_w))) ||' '||get_UoM(obter_unid_med_usua('ml')),1,100);
							qt_volume_ww	:= (((qt_conv_ml_w + qt_dose_ml_w) * qt_unit_medic_w) / ceil(qt_unit_medic_div_w));
						end if;
					end if;
				elsif (ds_conv_ml_w IS NOT NULL AND ds_conv_ml_w::text <> '') then
					ds_volume_w	:= ' '||ds_conv_ml_w;
				end if;
				end;
			end if;
			if	((ie_indice_w <> 2) or (ie_possui_diluente_w = 'N')) and (coalesce(ds_aplicar_w::text, '') = '') then
				if (ds_volume_w IS NOT NULL AND ds_volume_w::text <> '') then
					ds_aplicar_w	:= wheb_mensagem_pck.get_texto(306859, null)|| replace_number_locale(ds_volume_w) ------ NAO UTILIZADO INICIALMENTE
																	/*|| ' ('||ds_intervalo_w||') '*/
||' '|| ds_tempo_w||' '||ds_informacao_item_w;
					if (ie_administrar_ui_w = 'S') then
						select	count(*)
						into STRICT	cont_ww
						from	material_conversao_unidade
						where	cd_material	= cd_mat_ww
						and	upper(cd_unidade_medida) = upper(obter_unid_med_usua('UI'));
						if (cont_ww > 0) then
							select	count(*)
							into STRICT	cont_ww
							from	regra_setor_conv_unid
							where	cd_material	= cd_mat_ww
							and	upper(cd_unidade_medida) = upper(obter_unid_med_usua('UI'))
							and	cd_setor_atendimento = cd_setor_prescr_w;
							if (cont_ww > 0) then
								ds_adm_ui_w	:= wheb_mensagem_pck.get_texto(306859, null) || ' '|| to_char(Obter_dose_convertida(cd_mat_ww,qt_volume_ww, get_UoM(obter_unid_med_usua('ml')),obter_unid_med_usua('UI'))) ||' '||obter_unid_med_usua('UI') || ------ NAO UTILIZADO INICIALMENTE
																																		/*' (' || ds_intervalo_w ||') '*/
' '|| ds_tempo_w||' '||ds_informacao_item_w;
								ds_aplicar_w	:= ds_aplicar_w || chr(13) || chr(10) ||ds_adm_ui_w;
							end if;
						end if;
					end if;
				elsif (ds_tempo_w IS NOT NULL AND ds_tempo_w::text <> '') then
					ds_aplicar_w	:= wheb_mensagem_pck.get_texto(306859, null)||ds_tempo_w||' '||ds_informacao_item_w;
				end if;
			else
				ds_rediluir_w	:= '';
			end if;
			ds_retorno_w 	:= /*ds_reconstituir_w || ds_diluir_w || ds_rediluir_w || */
ds_aplicar_w;
			ds_retorno_w	:= replace(ds_retorno_w,' ,',' 0,');
			ds_retorno_w	:= replace(ds_retorno_w,' .',' 0,');
			ds_retorno_w	:= substr(ds_retorno_w,1,2000);
		end if;
	end if;

	if (pkg_i18n.get_user_locale = 'en_AU') then
		select 	max(b.ie_agrupador)
		into STRICT	ie_agrupador_w
		from 	prescr_material b,
			prescr_medica a
		where 	a.nr_prescricao	= b.nr_prescricao
		and	b.nr_sequencia	= nr_seq_item_p
		and	a.nr_prescricao	= nr_prescricao_p;

		if (ie_agrupador_w = 8) then
			select	max(ds_orientacao)
			into STRICT	ds_retorno_w
			from	cpoe_dieta
			where 	nr_sequencia = (SELECT 	max(nr_seq_dieta_cpoe)
						from 	prescr_material
						where	nr_prescricao = nr_prescricao_p
						and	nr_sequencia  = nr_seq_item_p);
		elsif (coalesce(ds_retorno_w::text, '') = '') then
			select	max(DS_ORIENTACAO_PREPARO)
			into STRICT	ds_retorno_w
			from	cpoe_material
			where 	nr_sequencia = (SELECT 	max(nr_seq_mat_cpoe)
						from 	prescr_material
						where	nr_prescricao = nr_prescricao_p
						and	nr_sequencia  = nr_seq_item_p);
		end if;
	end if;

	----- FINAL Obter_Diluicao_Medic
	select	substr(plt_obter_compostos(max(nr_prescricao), max(nr_sequencia), max(nr_agrupamento),CASE WHEN max(ie_agrupador)=1 THEN 'M'  ELSE null END ),1,1900),
			max(ds_observacao),
			max(ds_observacao_enf),
			max(ds_observacao_far),
			substr(obter_conversao_ml(max(cd_material), max(qt_dose), max(cd_unidade_medida_dose)),1,80),
			substr(obter_valor_dominio(1537,max(IE_BOMBA_INFUSAO)),1,80),
			max(ie_bomba_infusao),
			substr(Obter_riscos_medic(max(cd_material)),1,1000),
			coalesce(max(qt_dias_liberado),0),
			coalesce(max(nr_seq_substituto), 0),
			max(nr_agrupamento),
			max(ie_agrupador),
			coalesce(max(ie_item_superior), 'N'),
			max(obter_justificativa_item(nr_prescricao, nr_sequencia, CASE WHEN ie_agrupador=8 THEN  'S'  ELSE 'MAT' END ))
	into STRICT	ds_comp_w,
			ds_obs_med_w,
			ds_obs_enf_w,
			ds_obs_far_w,
			ds_dose_ml_w,
			ds_bomba_w,
			ie_bomba_infusao_w,
			ds_riscos_w,
			qt_dias_liberado_w,
			nr_seq_substituto_w,
			nr_agrupamento_w,
			ie_agrupador_www,
			ie_item_superior_w,
			ds_justificativa_cpoe_w
	from	prescr_material
	where	nr_prescricao 	= nr_prescricao_p
	and		nr_sequencia	= nr_seq_item_p;
	
	ds_retorno_w	:= addDoseLimitDescription() || ds_retorno_w;

	if (nr_seq_substituto_w > 0 AND ie_item_superior_w = 'N') then
		select 	count(*)
		into STRICT 	qtd_w
		from 	prescr_material a
		where	nr_prescricao 		= nr_prescricao_p
		and		nr_sequencia		= nr_seq_item_p
		and		nr_agrupamento  	= nr_agrupamento_w
		and 	ie_item_superior	= 'S'
		and		ie_agrupador		= ie_agrupador_www
		and 	coalesce(dt_suspensao::text, '') = ''
		and 	coalesce(nr_seq_substituto::text, '') = '';
		if (qtd_w = 0) then
			ds_comp_w := null;
		end if;
	end if;
	if (ds_comp_w IS NOT NULL AND ds_comp_w::text <> '') then
		if (ds_retorno_w IS NOT NULL AND ds_retorno_w::text <> '') then
			ds_retorno_w := substr(ds_retorno_w || chr(10) || wheb_mensagem_pck.get_texto(306813, null) || ds_comp_w,1,1900);
		else
			ds_retorno_w := substr(wheb_mensagem_pck.get_texto(306813, null) || ds_comp_w,1,1900);
		end if;
	end if;
	if (ds_bomba_w IS NOT NULL AND ds_bomba_w::text <> '') and (ie_bomba_infusao_w <> 'N') then
		if (ds_retorno_w IS NOT NULL AND ds_retorno_w::text <> '') then
			ds_retorno_w	:= ds_retorno_w || chr(13) || wheb_mensagem_pck.get_texto(306898, null) || ': ' || ds_bomba_w; -- Dispositivo
		else
			ds_retorno_w	:= wheb_mensagem_pck.get_texto(306898, null) || ': ' || ds_bomba_w;
		end if;
	end if;

	if (ds_obs_med_w IS NOT NULL AND ds_obs_med_w::text <> '') and ((pkg_i18n.get_user_locale <> 'en_AU') or (pkg_i18n.get_user_locale = 'en_AU' and ie_agrupador_www not in (1,4,8))) then
		if (ds_retorno_w IS NOT NULL AND ds_retorno_w::text <> '') then
			ds_retorno_w := substr(ds_retorno_w || chr(10)|| chr(13) || wheb_mensagem_pck.get_texto(357657, null) || ds_obs_med_w,1,1900) || chr(10) || chr(13); --  Notes:
		else
			ds_retorno_w := substr(wheb_mensagem_pck.get_texto(357657, null) || ds_obs_med_w,1,1900) || chr(10) || chr(13); --  Notes:
		end if;
	end if;
	if (ds_riscos_w IS NOT NULL AND ds_riscos_w::text <> '') then
		if (ds_retorno_w IS NOT NULL AND ds_retorno_w::text <> '') then
			ds_retorno_w := substr(ds_retorno_w || chr(10) || ds_riscos_w,1,1900) || chr(10) || chr(13);
		else
			ds_retorno_w := substr(ds_riscos_w,1,1900) || chr(10) || chr(13);
		end if;
	end if;
	if (ds_obs_enf_w IS NOT NULL AND ds_obs_enf_w::text <> '') then
		if (ds_retorno_w IS NOT NULL AND ds_retorno_w::text <> '') then
			ds_retorno_w := substr(ds_retorno_w || chr(10) || wheb_mensagem_pck.get_texto(306905, null) || ds_obs_enf_w,1,1900); -- - OBS ENF:
		else
			ds_retorno_w := substr(wheb_mensagem_pck.get_texto(306905, null) || ds_obs_enf_w,1,1900); -- - OBS ENF:
		end if;
	end if;
	if (ds_obs_far_w IS NOT NULL AND ds_obs_far_w::text <> '') then
		if (ds_retorno_w IS NOT NULL AND ds_retorno_w::text <> '') then
			ds_retorno_w := substr(ds_retorno_w || chr(10) || wheb_mensagem_pck.get_texto(306907, null) || ds_obs_far_w,1,1900); -- - OBS FAR:
		else
			ds_retorno_w := substr(wheb_mensagem_pck.get_texto(306907, null) || ds_obs_far_w,1,1900); -- - OBS FAR:
		end if;
	end if;

	SELECT  max(ds_justificativa)
	INTO STRICT    ds_justificativa_w
	FROM    prescr_material
	WHERE   nr_prescricao 	= nr_prescricao_p
	AND     nr_sequencia	= nr_seq_item_p;

	if (ds_justificativa_w IS NOT NULL AND ds_justificativa_w::text <> '') and (ie_exibe_justif_pt_w = 'S') then
		if (ds_retorno_w IS NOT NULL AND ds_retorno_w::text <> '') then
			ds_retorno_w := substr(ds_retorno_w || chr(10) || wheb_mensagem_pck.get_texto(306908,null) || ': ' || ds_justificativa_w,1,1900) || chr(10) || chr(13); --  Justificativa:
		else
			ds_retorno_w := substr(wheb_mensagem_pck.get_texto(306908,null)|| ': '  || ds_justificativa_w,1,1900) || chr(10) || chr(13); -- Justificativa:
		end if;
	end if;

	if (qt_dias_liberado_w	> 0) then
		if (ds_retorno_w IS NOT NULL AND ds_retorno_w::text <> '') then
			ds_retorno_w := substr(ds_retorno_w || chr(10) || wheb_mensagem_pck.get_texto(306909, null) || ' ' || qt_dias_liberado_w,1,1900)||chr(10); -- Dias liberado:
		else
			ds_retorno_w := substr(wheb_mensagem_pck.get_texto(306909, null) || qt_dias_liberado_w,1,1900) ||chr(10); -- Dias liberado:
		end if;
	end if;

end if;
return substr(trim(both ds_retorno_w),1,2000);
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION adep_obter_inf_dil_obs ( nr_prescricao_p bigint, nr_seq_item_p bigint) FROM PUBLIC;

