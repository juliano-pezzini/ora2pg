-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_seq_prescr_prescricao ( nr_prescricao_p bigint, ds_sigla_equip_p text, cd_exame_p text) RETURNS bigint AS $body$
DECLARE


nr_seq_prescr_w		bigint := null;
nr_seq_exame_w		bigint := null;

/*Cursor C01 is
	select	el.nr_seq_exame
	from	exame_laboratorio el
	where nvl(el.cd_exame_integracao, el.cd_exame) = cd_exame_p
	union
	select	e.nr_seq_exame
	from	exame_laboratorio e
	where	e.nr_seq_exame 	= obter_equip_exame_integracao(cd_exame_p,ds_sigla_equip_p, 1, nr_prescricao_p)
	order by 1;*/
BEGIN

if (nr_prescricao_p IS NOT NULL AND nr_prescricao_p::text <> '') and (cd_exame_p IS NOT NULL AND cd_exame_p::text <> '') then

/*	open c01;
	loop
	fetch c01 into
		nr_seq_exame_w;
	exit when c01%notfound;
		begin

		exit;

		end;
	end loop;
	close c01;

	if	(not nr_seq_exame_w is null) then

		select	max(nr_sequencia)
		into	nr_seq_prescr_w
		from	prescr_procedimento
		where	nr_prescricao 	= nr_prescricao_p
		and	nr_seq_exame 	= nr_seq_exame_w;

	end if;	*/
	select	max(a.nr_sequencia)
	into STRICT	nr_seq_prescr_w
	from	prescr_procedimento a,
			(SELECT	el.nr_seq_exame
			from	exame_laboratorio el
			where 	coalesce(el.cd_exame_integracao, el.cd_exame) = cd_exame_p
			
union

			SELECT	e.nr_seq_exame
			from	exame_laboratorio e
			where	e.nr_seq_exame 	= obter_equip_exame_integracao(cd_exame_p,ds_sigla_equip_p, 1, nr_prescricao_p)) b
	where	a.nr_prescricao = nr_prescricao_p
	and		a.nr_seq_exame = b.nr_seq_exame;



end if;

return	nr_seq_prescr_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_seq_prescr_prescricao ( nr_prescricao_p bigint, ds_sigla_equip_p text, cd_exame_p text) FROM PUBLIC;

