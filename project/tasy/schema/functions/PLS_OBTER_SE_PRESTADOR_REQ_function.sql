-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION pls_obter_se_prestador_req ( cd_prestador_solic_imp_p text, cd_guia_p text, nr_seq_segurado_p bigint) RETURNS bigint AS $body$
DECLARE

nr_seq_requisicao_w	bigint;
nr_seq_prestador_w	bigint;
nr_seq_guia_w		bigint;

C01 CURSOR(cd_prestador_solic_imp_p text) FOR
	SELECT	nr_sequencia
	from	pls_prestador
	where	upper(cd_prestador) = upper(cd_prestador_solic_imp_p);

BEGIN
nr_seq_prestador_w	:= null;

for r_c01 in C01(cd_prestador_solic_imp_p) loop

	-- busca a sequência da guia
	select	max(nr_sequencia)
	into STRICT	nr_seq_guia_w
	from	pls_guia_plano
	where	cd_guia_pesquisa = cd_guia_p
	and	nr_seq_segurado  = nr_seq_segurado_p;

	-- se encontrar, busca a requisição
	if (nr_seq_guia_w IS NOT NULL AND nr_seq_guia_w::text <> '')	then

		select	max(nr_seq_requisicao)
		into STRICT	nr_seq_requisicao_w
		from	pls_execucao_requisicao
		where	nr_seq_guia	= nr_seq_guia_w;

		-- se encontrou a requisição verifica se o prestador é igual ao que está sendo importado
		if (nr_seq_requisicao_w IS NOT NULL AND nr_seq_requisicao_w::text <> '')	then
			select	max(nr_seq_prestador)
			into STRICT	nr_seq_prestador_w
			from	pls_requisicao
			where 	nr_sequencia	 = nr_seq_requisicao_w
			and	nr_seq_prestador = r_C01.nr_sequencia;

			-- se tiver prestador retorna direto
			if (nr_seq_prestador_w IS NOT NULL AND nr_seq_prestador_w::text <> '')	then
				return nr_seq_prestador_w;
			end if;
		end if;
	end if;
 end loop;

 return	nr_seq_prestador_w;

 end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION pls_obter_se_prestador_req ( cd_prestador_solic_imp_p text, cd_guia_p text, nr_seq_segurado_p bigint) FROM PUBLIC;

