-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_habilita_trans_nf ( nr_sequencia_p text, ie_tipo_nota_p text) RETURNS varchar AS $body$
DECLARE


ds_retorno_w			varchar(1) := 'S';
qt_transmissao_w		bigint;
ie_tipo_transmissao_w		nfe_transmissao.ie_tipo_transmissao%type;
ie_status_transmissao_w		nfe_transmissao.ie_status_transmissao%type;
nr_protocolo_w			nota_fiscal_lote_nfe.nr_protocolo%type;


BEGIN

select	count(a.nr_sequencia)
into STRICT	qt_transmissao_w
from	nfe_transmissao a,
	nfe_transmissao_nf b
where	a.nr_sequencia = b.nr_seq_transmissao
and	b.nr_seq_nota_fiscal = nr_sequencia_p
and	a.ie_tipo_nota = ie_tipo_nota_p;

if (qt_transmissao_w > 0) then
	begin

	select  ie_tipo_transmissao,
		ie_status_transmissao,
		nr_protocolo
	into STRICT	ie_tipo_transmissao_w,
		ie_status_transmissao_w,
		nr_protocolo_w
	from (SELECT coalesce(a.ie_tipo_transmissao,1) ie_tipo_transmissao,
		coalesce(a.ie_status_transmissao,'E') ie_status_transmissao,
		substr(obter_protocolo_trans(a.nr_sequencia),1,255) nr_protocolo
	from	nfe_transmissao a,
		nfe_transmissao_nf b
	where	a.nr_sequencia = b.nr_seq_transmissao
	and	b.nr_seq_nota_fiscal = nr_sequencia_p
	and	a.ie_tipo_nota = ie_tipo_nota_p
	order by a.nr_sequencia desc) alias5 LIMIT 1;

	if (ie_tipo_transmissao_w = 1) and (ie_status_transmissao_w = 'T') and (nr_protocolo_w IS NOT NULL AND nr_protocolo_w::text <> '') then
		begin

		ds_retorno_w := 'N';

		end;
	end if;

	end;
end if;

return	ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_habilita_trans_nf ( nr_sequencia_p text, ie_tipo_nota_p text) FROM PUBLIC;

