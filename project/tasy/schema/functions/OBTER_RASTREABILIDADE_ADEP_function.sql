-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_rastreabilidade_adep ( nr_prescricao_p bigint, ie_tipo_processo_p rastreabilidade_adep.ie_tipo_processo%type ) RETURNS varchar AS $body$
DECLARE


ie_gravar_processo_w varchar(1);
nr_seq_regra_w rastreabilidade_adep.nr_sequencia%type;
nr_chave_rastr_w integer;
ie_gera_log_w varchar(1);


BEGIN

ie_gera_log_w := 'N';
nr_seq_regra_w := wheb_assist_pck.obter_seq_rastr_adep;
nr_chave_rastr_w := coalesce(length(regexp_replace(dbms_utility.format_call_stack, '[^('||chr(13)||chr(10)||')]+', null)),0);

if ((nr_seq_regra_w IS NOT NULL AND nr_seq_regra_w::text <> '') and
        nr_chave_rastr_w >= wheb_assist_pck.obter_chave_rastr_adep) then
    select  coalesce(max('S'),'N')
    into STRICT    ie_gravar_processo_w
    from    rastreabilidade_adep a
    where   a.nr_sequencia = nr_seq_regra_w
    and     a.ie_tipo_processo = ie_tipo_processo_p;

    if (ie_gravar_processo_w = 'S') then
        ie_gera_log_w := 'S';
    end if;
    CALL wheb_assist_pck.set_chave_rastr_adep(nr_chave_rastr_w);
end if;

if (ie_gera_log_w = 'N') then
    select  max(a.nr_sequencia)
    into STRICT    nr_seq_regra_w
    from    rastreabilidade_adep a
    where   a.ie_tipo_processo = ie_tipo_processo_p
    and (a.nm_usuario_regra = wheb_usuario_pck.get_nm_usuario or coalesce(a.nm_usuario_regra::text, '') = '')
    and (a.cd_perfil = wheb_usuario_pck.get_cd_perfil or coalesce(a.cd_perfil::text, '') = '')
    and (a.cd_estabelecimento = wheb_usuario_pck.get_cd_estabelecimento or coalesce(a.cd_estabelecimento::text, '') = '')
    and     clock_timestamp() between coalesce(a.dt_inicio_vigencia,clock_timestamp() - interval '1 days') and coalesce(a.dt_fim_vigencia,clock_timestamp() + interval '1 days');

    if (nr_seq_regra_w IS NOT NULL AND nr_seq_regra_w::text <> '') then
        CALL wheb_assist_pck.set_regra_rastr_adep(nr_seq_regra_w, nr_chave_rastr_w, nr_prescricao_p);
        ie_gera_log_w := 'S';
    end if;
end if;

return ie_gera_log_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_rastreabilidade_adep ( nr_prescricao_p bigint, ie_tipo_processo_p rastreabilidade_adep.ie_tipo_processo%type ) FROM PUBLIC;

