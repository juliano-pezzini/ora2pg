-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION spa_obter_dados ( nr_seq_spa_p bigint, ie_opcao_p text) RETURNS varchar AS $body$
DECLARE


cd_classificacao_w	integer;
nr_titulo_w		bigint;
nr_nota_fiscal_w	varchar(255);
nr_interno_conta_w	bigint;
nr_atendimento_w	bigint;
ds_titulo_w		varchar(2000);
ds_nota_fiscal_w	varchar(2000);
ds_conta_w		varchar(2000);
ds_atendimento_w	varchar(2000);
ds_retorno_w		varchar(4000);
nr_adiantamento_w	bigint;
ds_adiantamento_w	varchar(2000);

C01 CURSOR FOR
	SELECT	cd_classificacao,
		nr_titulo,
		nr_nota_fiscal,
		nr_interno_conta,
		nr_atendimento,
		nr_adiantamento
	from	spa_movimento
	where	nr_seq_spa = nr_seq_spa_p;

/* ie_opcao_p =
T = Título ( retorna os títulos da SPA, separados por vírgula )
NF = Nota Fiscal ( retorna as notas fiscais da SPA, separadas por vírgula )
C = Conta ( retorna as contas da SPA, separadas por vírgula )
A = Atendimento ( retorna os atendimentos da SPA, separados por vírgula )
D = Adiantamentos (retorna os adiantamentos da SPA, separados por vírgula)
*/
BEGIN

open C01;
loop
fetch C01 into
	cd_classificacao_w,
	nr_titulo_w,
	nr_nota_fiscal_w,
	nr_interno_conta_w,
	nr_atendimento_w,
	nr_adiantamento_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	if (cd_classificacao_w = 1) then
		ds_atendimento_w := ds_atendimento_w || nr_atendimento_w || ', ';
	elsif (cd_classificacao_w = 2) then
		ds_conta_w := ds_conta_w || nr_interno_conta_w || ', ';
	elsif (cd_classificacao_w = 3) then
		ds_nota_fiscal_w := ds_nota_fiscal_w || nr_nota_fiscal_w || ', ';
	elsif (cd_classificacao_w = 4) then
		ds_titulo_w := ds_titulo_w || nr_titulo_w || ', ';
	elsif (cd_classificacao_w = 8) then
		ds_adiantamento_w := ds_adiantamento_w || nr_adiantamento_w|| ', ';
	end if;
	end;
end loop;
close C01;
if (ie_opcao_p = 'T') then
	ds_retorno_w	:= substr(ds_titulo_w,1,length(ds_titulo_w) - 2);
elsif (ie_opcao_p = 'NF') then
	ds_retorno_w	:= substr(ds_nota_fiscal_w,1,length(ds_nota_fiscal_w) - 2);
elsif (ie_opcao_p = 'C') then
	ds_retorno_w	:= substr(ds_conta_w,1,length(ds_conta_w) - 2);
elsif (ie_opcao_p = 'A') then
	ds_retorno_w	:= substr(ds_atendimento_w,1,length(ds_atendimento_w) - 2);
elsif (ie_opcao_p = 'D') then
	ds_retorno_w	:= substr(ds_adiantamento_w,1,length(ds_adiantamento_w) - 2);
end if;

return	ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION spa_obter_dados ( nr_seq_spa_p bigint, ie_opcao_p text) FROM PUBLIC;

