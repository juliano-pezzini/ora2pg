-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_status_solic_proj_rec (nr_solic_compra_p bigint) RETURNS varchar AS $body$
DECLARE



ds_retorno_mensagem_w		varchar(255) := '';
dt_liberacao_w				solic_compra.dt_liberacao%type;
nr_seq_motivo_cancel_w		solic_compra.nr_seq_motivo_cancel%type;
qt_itens_nao_reprov_w		bigint;



BEGIN

select	dt_liberacao,
	nr_seq_motivo_cancel
into STRICT	dt_liberacao_w,
	nr_seq_motivo_cancel_w
from	solic_compra
where	nr_solic_compra = nr_solic_compra_p;

if (coalesce(nr_seq_motivo_cancel_w::text, '') = '') then

	if (obter_se_solic_em_ordem(nr_solic_compra_p) <> 'S') then
		begin

			if (obter_se_solic_em_cotacao(nr_solic_compra_p) = 'S') then
				--Com cotação
				ds_retorno_mensagem_w := wheb_mensagem_pck.get_Texto(402817);
			elsif (coalesce(dt_liberacao_w::text, '') = '') then
				--Não liberada
				ds_retorno_mensagem_w := wheb_mensagem_pck.get_Texto(402814);
			else
				select  count(*)
				into STRICT	qt_itens_nao_reprov_w
				from    solic_compra_item
				where   nr_solic_compra = nr_solic_compra_p
				and     coalesce(dt_reprovacao::text, '') = '';

				if (qt_itens_nao_reprov_w = 0) then
					--Reprovada
					ds_retorno_mensagem_w := wheb_mensagem_pck.get_Texto(667706);
				else
					--Liberada
					ds_retorno_mensagem_w := wheb_mensagem_pck.get_Texto(402815);
				end if;

			end if;
		end;
	else
		--Com ordem
		ds_retorno_mensagem_w := wheb_mensagem_pck.get_Texto(445167);
	end if;
else
	--Cancelada
	ds_retorno_mensagem_w := wheb_mensagem_pck.get_Texto(402833);

end if;

return	ds_retorno_mensagem_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_status_solic_proj_rec (nr_solic_compra_p bigint) FROM PUBLIC;

