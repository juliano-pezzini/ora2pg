-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_se_worklist_liberado ( cd_perfil_p bigint, nm_usuario_p text, cd_cat_item_wl_p bigint, nr_seq_worklist_p bigint) RETURNS varchar AS $body$
DECLARE


ie_regra_w					varchar(1);
ie_regra_liberado_w			varchar(1)	:= 'N';
cd_perfil_w					wl_perfil.cd_perfil%type;
nm_usuario_wl_w				wl_perfil.nm_usuario_wl%type;
nr_seq_grupo_usuario_w		wl_perfil.nr_seq_grupo_usuario%type;
cd_departamento_w			wl_perfil.cd_departamento%type;
cd_setor_w					wl_perfil.cd_setor_atendimento%type;
nr_seq_grupo_w				usuario_grupo.nr_seq_grupo%type;
nr_seq_tasklist_w			wl_worklist.nr_sequencia%type;
nr_seq_tasklist_control_w	wl_worklist.nr_sequencia%type := 0;

c01 CURSOR FOR
	SELECT	d.cd_perfil,
			d.nm_usuario_wl,
			d.nr_seq_grupo_usuario,
			d.cd_departamento,
			d.cd_setor_atendimento,
			x.nr_sequencia
	from	wl_worklist x,
			wl_regra_worklist a,
			wl_item b,
			wl_regra_item c,
			wl_perfil d
	where	x.nr_seq_item = b.nr_sequencia
	and		a.nr_seq_item = b.nr_sequencia
	and		a.nr_sequencia = c.nr_seq_regra
	and		c.nr_sequencia = d.nr_seq_regra_item
	and		c.nr_sequencia = x.nr_seq_regra
	and		x.nr_seq_item = cd_cat_item_wl_p
	and		x.nr_sequencia = nr_seq_worklist_p
	and		d.ie_situacao = 'A'
	and		b.ie_situacao = 'A';
	
c02 CURSOR FOR
	SELECT	nr_seq_grupo
	from	usuario_grupo
	where	nm_usuario_grupo = nm_usuario_p;


BEGIN

select	(CASE WHEN (max(x.nr_sequencia) IS NOT NULL AND (max(x.nr_sequencia))::text <> '') THEN 'S' ELSE 'N' END)
into STRICT	ie_regra_w
from	wl_worklist x,
		wl_regra_worklist a,
		wl_item b,
		wl_regra_item c
where	x.nr_seq_item = b.nr_sequencia
and		a.nr_seq_item = b.nr_sequencia
and		a.nr_sequencia = c.nr_seq_regra
and (c.nr_sequencia = x.nr_seq_regra or nm_usuario_p = x.nm_usuario_nrec or obter_pf_usuario(nm_usuario_p, 'C') = x.cd_profissional)
and		x.nr_seq_item = cd_cat_item_wl_p
and		x.nr_sequencia = nr_seq_worklist_p
and		b.ie_situacao = 'A';

if ( ie_regra_w = 'S' ) then

	ie_regra_liberado_w := 'S';
	
	open c01;
	loop
	fetch c01 into
		cd_perfil_w,
		nm_usuario_wl_w,
		nr_seq_grupo_usuario_w,
		cd_departamento_w,
		cd_setor_w,
		nr_seq_tasklist_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
		begin
		
		if (nr_seq_tasklist_control_w <> nr_seq_tasklist_w) then
			ie_regra_liberado_w := 'N';
			if (cd_perfil_w = cd_perfil_p) then
				ie_regra_liberado_w := 'S';
			elsif (nm_usuario_wl_w = nm_usuario_p) then
				ie_regra_liberado_w := 'S';
			elsif ((cd_departamento_w IS NOT NULL AND cd_departamento_w::text <> '') and obter_se_dept_usuario(cd_departamento_w,nm_usuario_p) = 'S') then
				ie_regra_liberado_w := 'S';
			elsif ((cd_setor_w IS NOT NULL AND cd_setor_w::text <> '') and obter_se_setor_usuario(cd_setor_w,nm_usuario_p) = 'S') then
				ie_regra_liberado_w := 'S';
			elsif (nr_seq_grupo_usuario_w IS NOT NULL AND nr_seq_grupo_usuario_w::text <> '') then
				open c02;
				loop
				fetch c02 into
				nr_seq_grupo_usuario_w;
				EXIT WHEN NOT FOUND; /* apply on c02 */
					begin
					if (nr_seq_grupo_w = nr_seq_grupo_usuario_w) then
						ie_regra_liberado_w := 'S';
					end if;
					end;
				end loop;
				close c02;
			end if;
			if (ie_regra_liberado_w = 'S') then
				nr_seq_tasklist_control_w := nr_seq_tasklist_w;
			end if;
		end if;
		end;
	end loop;
	close c01;
end if;


return	ie_regra_liberado_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_se_worklist_liberado ( cd_perfil_p bigint, nm_usuario_p text, cd_cat_item_wl_p bigint, nr_seq_worklist_p bigint) FROM PUBLIC;

