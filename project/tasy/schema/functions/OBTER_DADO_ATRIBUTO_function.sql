-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_dado_atributo ( nm_tabela_p text, nm_atributo_p text, nr_seq_idioma_p bigint default null, ie_html_p text default 'N') RETURNS varchar AS $body$
DECLARE


ds_dado_w			varchar(4500);
cd_dominio_w			bigint;
ds_dominio_w			varchar(300);
nm_tabela_referencia_w		varchar(255);
ds_retorno_retorno_tab_ref_w	varchar(1000);
ds_atributo_w			varchar(4000);
ds_cadastro_w			varchar(255);
ie_cadastro_geral_w		varchar(3);
ds_funcao_w			varchar(80);
ds_aplicacao_w			varchar(15);
nr_seq_modulo_w			bigint;
cd_expressao_w			bigint;

	procedure VerificaTabelaPrincipal(nm_tabela_pai text) is
	ds_tabela_adicional_w varchar(50);
	ds_cadastro_adicional_w varchar(80);
	ie_cadastro_geral_adicional_w varchar(3);
	
BEGIN
		SELECT	MAX(SUBSTR(obter_desc_expressao(cd_exp_cadastro, ds_cadastro), 1, 254)),
			MAX(ie_cadastro_geral),
			MAX(nm_tabela)
		into STRICT 	ds_cadastro_adicional_w,
			ie_cadastro_geral_adicional_w,
			ds_tabela_adicional_w
		FROM	tabela_sistema
		WHERE	nm_tabela = (SELECT nm_tabela_superior FROM tabela_sistema WHERE nm_tabela = nm_tabela_pai);

		if 	(ds_cadastro_adicional_w IS NOT NULL AND ds_cadastro_adicional_w::text <> '' AND ie_cadastro_geral_adicional_w = 'S') then
			ds_cadastro_w := substr(ds_cadastro_adicional_w  || ' > ' || ds_cadastro_w, 1, 255);
			VerificaTabelaPrincipal(ds_tabela_adicional_w);
		end if;
	end;

BEGIN
ds_dado_w			:= '';
nm_tabela_referencia_w		:= '';
ds_dominio_w			:= '';


select 	max(cd_dominio),
	max(substr(obter_desc_expressao(cd_exp_desc, ds_atributo),1,4000))
into STRICT	cd_dominio_w,
	ds_atributo_w
from 	Tabela_Atributo
where	nm_tabela	= nm_tabela_p
  and	nm_atributo	= nm_atributo_p;

if (cd_dominio_w IS NOT NULL AND cd_dominio_w::text <> '') then
	select	substr(wheb_mensagem_pck.get_texto(284570) || substr(obter_desc_expressao(CD_EXP_DESC_DOMINIO, a.ds_dominio), 1, 254) || ' (' ||
		cd_dominio_w || ')' || chr(10) || wheb_mensagem_pck.get_texto(284579) || substr(obter_desc_expressao(b.cd_exp_modulo,b.nm_modulo),1,254), 1, 300)
	into STRICT	ds_dominio_w
	FROM dominio a
LEFT OUTER JOIN modulo_tasy b ON (a.nr_seq_modulo = b.nr_sequencia)
WHERE a.cd_dominio	= cd_dominio_w;
else
	select	max(nm_tabela_referencia)
	into STRICT	nm_tabela_referencia_w
	from 	integridade_referencial b,
		integridade_atributo a
	where	a.nm_tabela			= nm_tabela_p
	and	a.nm_atributo			= nm_atributo_p
	and 	a.nm_tabela			= b.nm_tabela
        and	a.nm_integridade_referencial	= b.nm_integridade_referencial;

	if (nm_tabela_referencia_w IS NOT NULL AND nm_tabela_referencia_w::text <> '') then
		select	max(substr(obter_desc_expressao(cd_exp_cadastro, ds_cadastro), 1, 254)),
			max(ie_cadastro_geral),
			max(ds_aplicacao),
			max(nr_seq_modulo)
		into STRICT	ds_cadastro_w,
			ie_cadastro_geral_w,
			ds_aplicacao_w,
			nr_seq_modulo_w
		from	tabela_sistema
		where	nm_tabela = nm_tabela_referencia_w;

		ds_retorno_retorno_tab_ref_w := wheb_mensagem_pck.get_texto(284572) || ds_cadastro_w || ' ' || nm_tabela_referencia_w || chr(10);

		if (ie_cadastro_geral_w = 'S') then

			select 	max(coalesce(cd_aplicacao_tasy, ds_aplicacao_w))
			into STRICT	ds_aplicacao_w
			from	modulo_tasy
			where	nr_sequencia  = nr_seq_modulo_w;

			VerificaTabelaPrincipal(nm_tabela_referencia_w);

			if ((ie_html_p IS NOT NULL AND ie_html_p::text <> '') and ie_html_p = 'S') then
				cd_expressao_w := 1027897;
			else
				cd_expressao_w := 284573;
			end if;

			ds_retorno_retorno_tab_ref_w	:= ds_retorno_retorno_tab_ref_w || wheb_mensagem_pck.get_texto(cd_expressao_w) ||
											substr(obter_desc_aplicacao(ds_aplicacao_w),1,255) || ' > ' ||
											substr(Obter_Nome_Modulo(nr_seq_modulo_w),1,255) || ' > ' ||
											substr(ds_cadastro_w,1,255) || chr(10);
/*		else
			select	substr(obter_desc_funcao(max(cd_funcao)),1,80)
			into	ds_funcao_w
			from	funcao_tabela
			where	nm_tabela = nm_tabela_referencia_w;

			if	(ds_funcao_w is not null) then
				ds_retorno_retorno_tab_ref_w	:= ds_retorno_retorno_tab_ref_w || 'Função: ' || ds_funcao_w || chr(10);
			end if;*/
		end if;
	end if;
end if;

ds_dado_w	:= ds_atributo_w || chr(10) || ds_dominio_w || ds_retorno_retorno_tab_ref_w;

RETURN ds_dado_w;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_dado_atributo ( nm_tabela_p text, nm_atributo_p text, nr_seq_idioma_p bigint default null, ie_html_p text default 'N') FROM PUBLIC;

