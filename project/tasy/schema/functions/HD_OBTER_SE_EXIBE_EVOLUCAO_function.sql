-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION hd_obter_se_exibe_evolucao (cd_tipo_evolucao_p text, cd_perfil_p bigint, nr_atendimento_p bigint default 0) RETURNS varchar AS $body$
DECLARE

qt_regas_evolucao_w	tipo_evolucao_acesso.nr_sequencia%type;
ie_retorno_w		varchar(1);
nm_usuario_w		usuario.nm_usuario%type;
cd_estabelecimento_w	usuario.cd_estabelecimento%type;
cd_setor_atendimento_w	usuario.cd_setor_atendimento%type;
cd_pessoa_fisica_w	hd_dialise.cd_pessoa_fisica%type;


BEGIN

ie_retorno_w	:= 'S';

select	coalesce(max(nr_sequencia),0)
into STRICT	qt_regas_evolucao_w
from	tipo_evolucao_acesso
where	cd_tipo_evolucao = cd_tipo_evolucao_p;

if (qt_regas_evolucao_w > 0) then

select	max(cd_pessoa_fisica)
into STRICT 	cd_pessoa_fisica_w
from 	hd_dialise
where 	nr_atendimento = nr_atendimento_p;

nm_usuario_w := wheb_usuario_pck.get_nm_usuario();
cd_estabelecimento_w := wheb_usuario_pck.get_cd_estabelecimento();
cd_setor_atendimento_w := wheb_usuario_pck.get_cd_setor_atendimento();

select CASE WHEN count(a.nr_sequencia)=0 THEN  'N'  ELSE 'S' END
  into STRICT ie_retorno_w
  from tipo_evolucao_acesso a, usuario b
 where a.cd_tipo_evolucao = cd_tipo_evolucao_p
	and b.nm_usuario = nm_usuario_w
   and coalesce(a.ie_permite_acesso, 'S') = 'S'
   and ((a.cd_perfil = cd_perfil_p) or (coalesce(a.cd_perfil::text, '') = ''))
   and ((a.ie_tipo_evolucao =
       obter_dados_usuario_opcao(nm_usuario_w, 'F')) or (coalesce(a.ie_tipo_evolucao::text, '') = ''))
   and ((b.nm_usuario = nm_usuario_w and
       b.cd_pessoa_fisica = coalesce(a.cd_pessoa_fisica, b.cd_pessoa_fisica)) or (coalesce(a.cd_pessoa_fisica::text, '') = ''))
   and ((a.cd_tipo_evolucao = cd_tipo_evolucao_p and
       a.cd_estabelecimento = cd_estabelecimento_w) or (coalesce(a.cd_estabelecimento::text, '') = ''))
   and ((a.cd_setor_paciente = obter_setor_atendimento(nr_atendimento_p)) or (coalesce(a.cd_setor_paciente::text, '') = ''))
   and consiste_se_pertence_grupo(nr_seq_grupo_pac, cd_pessoa_fisica_w) = 'S'
   and ((a.Cd_Setor_Atendimento = cd_setor_atendimento_w) or (coalesce(a.Cd_Setor_Atendimento::text, '') = ''));
else
	ie_retorno_w := 'S';
end if;

return	ie_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION hd_obter_se_exibe_evolucao (cd_tipo_evolucao_p text, cd_perfil_p bigint, nr_atendimento_p bigint default 0) FROM PUBLIC;

