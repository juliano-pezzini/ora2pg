-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION cus_obter_var_disponibilidade ( cd_centro_controle_p bigint, cd_nivel_capacidade_p bigint, dt_referencia_p timestamp) RETURNS bigint AS $body$
DECLARE


cd_tabela_custo_w			integer	:= 0;
cd_tabela_custo_ant_w		integer	:= 0;
qt_disponibilidade_w			double precision	:= 0;
qt_disponibilidade_ant_w		double precision	:= 0;
pr_var_disponibilidade_w		double precision	:= 0;
dt_referencia_ant_w			timestamp;
qt_diferenca_w			double precision	:= 0;


BEGIN

select	pkg_date_utils.add_month(dt_referencia_p, -1,0)
into STRICT	dt_referencia_ant_w
;

/* Busca tabela do mês */

select	coalesce(max(a.cd_tabela_custo),0)
into STRICT	cd_tabela_custo_w
from	tabela_custo a
where	a.cd_tipo_tabela_custo = 2
and	a.dt_mes_referencia = dt_referencia_p;

/* Busca tabela do mês anterior */

select	coalesce(max(a.cd_tabela_custo),0)
into STRICT	cd_tabela_custo_ant_w
from	tabela_custo a
where	a.cd_tipo_tabela_custo = 2
and	a.dt_mes_referencia = dt_referencia_ant_w;

/* Busca disponibilidade do mês */

select	coalesce(sum(x.qt_disponibilidade),0)
into STRICT	qt_disponibilidade_w
from	capac_centro_controle x,
	tabela_custo y
where	y.cd_tabela_custo    = x.cd_tabela_custo
and	x.cd_centro_controle = cd_centro_controle_p
and	x.cd_nivel_capacidade = coalesce(cd_nivel_capacidade_p,x.cd_nivel_capacidade)
and	x.cd_tabela_custo    = cd_tabela_custo_w;

/* Busca disponibilidade do mês anterior */

select	coalesce(sum(x.qt_disponibilidade),0)
into STRICT	qt_disponibilidade_ant_w
from	capac_centro_controle x,
	tabela_custo y
where	y.cd_tabela_custo    = x.cd_tabela_custo
and	x.cd_centro_controle = cd_centro_controle_p
and	x.cd_nivel_capacidade = coalesce(cd_nivel_capacidade_p,x.cd_nivel_capacidade)
and	x.cd_tabela_custo    = cd_tabela_custo_ant_w;

/* Calcula % de variação da disponibilidade entre os meses */

pr_var_disponibilidade_w		:= ((dividir(qt_disponibilidade_w,qt_disponibilidade_ant_w) - 1)*100);

return	pr_var_disponibilidade_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION cus_obter_var_disponibilidade ( cd_centro_controle_p bigint, cd_nivel_capacidade_p bigint, dt_referencia_p timestamp) FROM PUBLIC;

