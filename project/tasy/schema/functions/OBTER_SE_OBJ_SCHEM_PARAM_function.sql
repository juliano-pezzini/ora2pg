-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_se_obj_schem_param ( nr_seq_obj_schem_param_p objeto_schematic_param.nr_sequencia%type, cd_funcao_p funcao.cd_funcao%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, cd_perfil_p perfil.cd_perfil%type, nm_usuario_p usuario.nm_usuario%type, nr_seq_obj_schematic_p objeto_schematic.nr_sequencia%type default null, ie_configuravel_p objeto_schematic.ie_configuravel%type default null) RETURNS varchar AS $body$
DECLARE


vl_retorno_w			varchar(255) := 'S';
vl_parametro_padrao_w		varchar(10);
vl_parametro_default_w		varchar(10);
vl_parametro_pais_w			varchar(10);
cd_estabelecimento_w		integer;
i				integer;
nr_seq_obj_schem_param_w	bigint;
ie_configuravel_w		varchar(10);


ie_nivel_atencao_perfil_w			varchar(1);
ie_restringe_nivel_prim_w		varchar(1);
ie_restringe_nivel_sec_w		varchar(1);
ie_restringe_nivel_ter_w		varchar(1);


c01 CURSOR FOR
	SELECT	vl_parametro
	from obj_schem_perfil
	where nr_seq_obj_schem_param	= nr_seq_obj_schem_param_w
	  and cd_perfil    = cd_perfil_p
	  and coalesce(cd_estabelecimento,cd_estabelecimento_w) = cd_estabelecimento_w
	order by coalesce(cd_estabelecimento,0);


BEGIN

if (ie_configuravel_p IS NOT NULL AND ie_configuravel_p::text <> '') then
    ie_configuravel_w := ie_configuravel_p;
else
    select	max(ie_configuravel)
    into STRICT	ie_configuravel_w
    from	objeto_schematic
    where	nr_sequencia	= nr_seq_obj_schematic_p;
end if;

if	(ie_configuravel_w = 'S') then --Apenas se está definido como 'Configurável', deve ser as regras.

	SELECT max(ie_visualiza)
	into STRICT vl_parametro_pais_w
	FROM Tab_pais
	WHERE nr_Seq_tab_ref = nr_seq_obj_schematic_p
	and cd_pais = coalesce(Obter_Nr_Seq_Locale(nm_usuario_p), 1);

	select	max(a.nr_sequencia),
			max(a.vl_parametro_padrao),
			coalesce(max(ie_restringe_nivel_primario),'N'),
			coalesce(max(ie_restringe_nivel_secundario),'N'),
			coalesce(max(ie_restringe_nivel_terciario),'N'),
			coalesce(MAX(COALESCE(vl_parametro, COALESCE(vl_parametro_pais_w, VL_PARAMETRO_PADRAO))),'S')
	into STRICT	nr_seq_obj_schem_param_w,
			vl_parametro_padrao_w,
			ie_restringe_nivel_prim_w,
			ie_restringe_nivel_sec_w,
			ie_restringe_nivel_ter_w,
			vl_parametro_default_w
	from	objeto_schematic_param a
	where	a.nr_seq_obj_sch = nr_seq_obj_schematic_p;




	if (cd_perfil_p IS NOT NULL AND cd_perfil_p::text <> '') and ( cd_perfil_p > 0 ) then

		Select  coalesce(max(ie_nivel_atencao),'T')
		into STRICT	ie_nivel_atencao_perfil_w
		from	perfil
		where  	cd_perfil =  cd_perfil_p;

		if ((ie_nivel_atencao_perfil_w IS NOT NULL AND ie_nivel_atencao_perfil_w::text <> '') and
		    ((ie_restringe_nivel_prim_w = 'S' and ie_nivel_atencao_perfil_w = 'P' ) or (ie_restringe_nivel_sec_w = 'S' and ie_nivel_atencao_perfil_w = 'S' ) or (ie_restringe_nivel_ter_w = 'S' and ie_nivel_atencao_perfil_w = 'T' )))then

			vl_retorno_w := 'N';

		end if;

	end if;

	if (coalesce(vl_retorno_w,'S') = 'S') then



		if (vl_parametro_padrao_w = 'C') then

			if (obter_se_base_corp = 'S' or obter_se_base_wheb = 'S') then
				vl_retorno_w := 'S';
			else
				vl_retorno_w := 'N';
			end if;

		elsif (vl_parametro_padrao_w = 'I') then
				vl_retorno_w := 'N';
		else
			cd_estabelecimento_w	:= coalesce(cd_estabelecimento_p, 1);

			begin
			select	vl_parametro
			into STRICT	vl_retorno_w
			from obj_schem_usuario
			where nr_seq_obj_schem_param	= nr_seq_obj_schem_param_w
			  and nm_usuario_param = nm_usuario_p
			  and coalesce(cd_estabelecimento,cd_estabelecimento_w) = cd_estabelecimento_w  LIMIT 1;
			 exception
				when others then
					begin
					i := 0;
					open c01;
					loop
					fetch c01 into vl_retorno_w;
					EXIT WHEN NOT FOUND; /* apply on c01 */
					i := i + 1;
					end loop;
					close c01;

					if (i = 0) then
						begin
						select	vl_parametro
						into STRICT	vl_retorno_w
						from obj_schem_estab
						where nr_seq_obj_schem_param	= nr_seq_obj_schem_param_w
						  and cd_estabelecimento    = cd_estabelecimento_w;
						exception
							when others then
								begin
								vl_retorno_w	:= vl_parametro_default_w;
								exception
									when others then
									   vl_retorno_w := 'S';
								end;
							end;
					end if;
					end;

			end;
		end if;
	end if;
end if;

return	coalesce(vl_retorno_w,'S');

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_se_obj_schem_param ( nr_seq_obj_schem_param_p objeto_schematic_param.nr_sequencia%type, cd_funcao_p funcao.cd_funcao%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, cd_perfil_p perfil.cd_perfil%type, nm_usuario_p usuario.nm_usuario%type, nr_seq_obj_schematic_p objeto_schematic.nr_sequencia%type default null, ie_configuravel_p objeto_schematic.ie_configuravel%type default null) FROM PUBLIC;

