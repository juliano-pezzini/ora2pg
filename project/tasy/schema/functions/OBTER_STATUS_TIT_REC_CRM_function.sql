-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_status_tit_rec_crm ( nr_titulo_p bigint) RETURNS varchar AS $body$
DECLARE


/*Function usada para trazer o ds_status do titulo a receber referente ao sistema CRM (Integração Tasy x CRM)*/

ds_situacao_w			varchar(40);
vl_saldo_titulo_w	titulo_receber.vl_saldo_titulo%type;
vl_titulo_w			titulo_receber.vl_titulo%type;
ie_situacao_w			titulo_receber.ie_situacao%type;
dt_vencimento_w			timestamp;
dt_pagamento_previsto_w		timestamp;



BEGIN
select  vl_saldo_titulo,
	vl_titulo,
	dt_vencimento,
	ie_situacao,
	dt_pagamento_previsto
into STRICT	vl_saldo_titulo_w,
	vl_titulo_w,
	dt_vencimento_w,
	ie_situacao_w,
	dt_pagamento_previsto_w
from	titulo_receber
where 	nr_titulo	= nr_titulo_p;

if (vl_titulo_w > 0) and (vl_saldo_titulo_w < vl_titulo_w) and (vl_saldo_titulo_w > 0) then
	ds_situacao_w	:= 'BAIXADO PARCIAL';
elsif (clock_timestamp() > dt_pagamento_previsto_w) and (vl_saldo_titulo_w > 0) then
	ds_situacao_w	:= 'VENCIDO';
elsif (ie_situacao_w = 1) then
	ds_situacao_w	:= 'ABERTO';
elsif (ie_situacao_w = 3) then
	ds_situacao_w	:= 'CANCELADO';
else
	ds_situacao_w	:= 'BAIXADO';
end if;

return ds_situacao_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_status_tit_rec_crm ( nr_titulo_p bigint) FROM PUBLIC;

