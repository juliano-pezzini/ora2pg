-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION cpoe_obter_prescr_alta (ds_itens_liberados_p text) RETURNS bigint AS $body$
DECLARE


nr_prescricao_w			bigint;
ie_opcao_prescr_ww		varchar(2000);
ie_opcao_prescr_w		varchar(255);
item_w				varchar(255);
nr_seq_reg_item_w		cpoe_dieta.nr_sequencia%type;


BEGIN
ie_opcao_prescr_ww := ds_itens_liberados_p;

while(ie_opcao_prescr_ww IS NOT NULL AND ie_opcao_prescr_ww::text <> '') and (coalesce(nr_prescricao_w::text, '') = '') loop
	begin

	if (position(';' in ie_opcao_prescr_ww) = 0) and (ie_opcao_prescr_ww IS NOT NULL AND ie_opcao_prescr_ww::text <> '') then
		ie_opcao_prescr_ww := ie_opcao_prescr_ww||';';
	end if;

	item_w := substr(ie_opcao_prescr_ww, 1, position(';' in ie_opcao_prescr_ww) - 1);
	ie_opcao_prescr_w := substr(item_w, 1, position(',' in item_w) - 1);
	nr_seq_reg_item_w := (substr(item_w, position(',' in item_w) + 1, length(item_w)))::numeric;
	ie_opcao_prescr_ww := substr(ie_opcao_prescr_ww, position(';' in ie_opcao_prescr_ww) + 1, length(ie_opcao_prescr_ww));

	if (ie_opcao_prescr_w IS NOT NULL AND ie_opcao_prescr_w::text <> '') then
		case ie_opcao_prescr_w
			when 'MA' then
				begin
				select  max(OBTER_PRESCR_ITEM_CPOE(nr_sequencia,cpoe_obter_tipo_item('CPOE_MATERIAL',nr_sequencia),nr_atendimento, cd_pessoa_fisica))
				into STRICT    nr_prescricao_w
				from    cpoe_material
				where   nr_sequencia = nr_seq_reg_item_w
				and	coalesce(ie_item_alta,'N') = 'S';
				end;
			when 'M' then
				begin
				select  max(OBTER_PRESCR_ITEM_CPOE(nr_sequencia,cpoe_obter_tipo_item('CPOE_MATERIAL',nr_sequencia),nr_atendimento, cd_pessoa_fisica))
				into STRICT    nr_prescricao_w
				from    cpoe_material
				where   nr_sequencia = nr_seq_reg_item_w
				and	coalesce(ie_item_alta,'N') = 'S';
				end;
			when 'N' then --Nutricao
			begin
				select  max(OBTER_PRESCR_ITEM_CPOE(nr_sequencia,cpoe_obter_tipo_item('CPOE_DIETA',nr_sequencia),nr_atendimento, cd_pessoa_fisica))
				into STRICT    nr_prescricao_w
				from    cpoe_dieta
				where   nr_sequencia = nr_seq_reg_item_w
				and	coalesce(ie_item_alta,'N') = 'S';
			end;
			when 'P' then --Procedimentos
			begin
				select  max(OBTER_PRESCR_ITEM_CPOE(nr_sequencia,cpoe_obter_tipo_item('CPOE_PROCEDIMENTO',nr_sequencia),nr_atendimento, cd_pessoa_fisica))
				into STRICT    nr_prescricao_w
				from    cpoe_procedimento
				where   nr_sequencia = nr_seq_reg_item_w
				and	coalesce(ie_item_alta,'N') = 'S';
			end;
			when 'G' then --Gasoterapia
			begin
				select  max(OBTER_PRESCR_ITEM_CPOE(nr_sequencia,cpoe_obter_tipo_item('CPOE_GASOTERAPIA',nr_sequencia),nr_atendimento, cd_pessoa_fisica))
				into STRICT    nr_prescricao_w
				from    cpoe_gasoterapia
				where   nr_sequencia = nr_seq_reg_item_w
				and	coalesce(ie_item_alta,'N') = 'S';
			end;
			when 'R' then --Recomendação
			begin
				select  max(OBTER_PRESCR_ITEM_CPOE(nr_sequencia,cpoe_obter_tipo_item('CPOE_RECOMENDACAO',nr_sequencia),nr_atendimento, cd_pessoa_fisica))
				into STRICT    nr_prescricao_w
				from    cpoe_recomendacao
				where   nr_sequencia = nr_seq_reg_item_w
				and	coalesce(ie_item_alta,'N') = 'S';
			end;
			when 'H' then --Hemoterapia
			begin
				select  max(OBTER_PRESCR_ITEM_CPOE(nr_sequencia,cpoe_obter_tipo_item('CPOE_HEMOTERAPIA',nr_sequencia),nr_atendimento, cd_pessoa_fisica))
				into STRICT    nr_prescricao_w
				from    cpoe_hemoterapia
				where   nr_sequencia = nr_seq_reg_item_w
				and	coalesce(ie_item_alta,'N') = 'S';
			end;
			when 'DI' then --Dialysis
			begin
				select  max(OBTER_PRESCR_ITEM_CPOE(nr_sequencia,cpoe_obter_tipo_item('CPOE_DIALISE',nr_sequencia),nr_atendimento, cd_pessoa_fisica))
				into STRICT    nr_prescricao_w
				from    cpoe_dialise
				where   nr_sequencia = nr_seq_reg_item_w
				and	coalesce(ie_item_alta,'N') = 'S';
			end;
			when 'AP' then --Anatomia patologica
			begin
				select  max(OBTER_PRESCR_ITEM_CPOE(nr_sequencia,cpoe_obter_tipo_item('CPOE_ANATOMIA_PATOLOGICA',nr_sequencia),nr_atendimento, cd_pessoa_fisica))
				into STRICT    nr_prescricao_w
				from    cpoe_anatomia_patologica
				where   nr_sequencia = nr_seq_reg_item_w
				and	coalesce(ie_item_alta,'N') = 'S';
			end;

		end case;
	end if;

	end;
end loop;

return	nr_prescricao_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION cpoe_obter_prescr_alta (ds_itens_liberados_p text) FROM PUBLIC;

