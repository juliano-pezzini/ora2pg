-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION pls_obter_dados_proposta ( nr_seq_proposta_p bigint, ie_tipo_retorno_p text) RETURNS varchar AS $body$
DECLARE


/* IE_TIPO_RETORNO_P
	NE - Nome estipulante
	C - Contrato GERADO (Existe tambem o campo nr_seq_contrato na pls_proposta_adesao que refere-se ao contrato VINCULADO na proposta)
	NRC - Numero do contrato gerado (NR_CONTRATO)
	TE - Tipo estipulante da proposta
	TP - Tipo proposta
	V -  Valor da proposta
	CL -  Cliente
	EF - Estipulante pf
	EJ - Estipulante pj
	VE - Vendedor canal
	CA - Data da aprovacao do contrato
	S - Status da proposta de adesao
	SA - Situacao do adiantamento
*/
ds_retorno_w			varchar(255);
cd_cgc_estipulante_w		varchar(14);
cd_estipulante_w		varchar(10);
nm_estipulante_w		varchar(255);
nr_seq_contrato_gerado_w	bigint;
ie_tipo_proposta_w		smallint;
vl_proposta_w			bigint;
nr_seq_cliente_w		bigint;
nr_seq_vendedor_canal_w		bigint;
nr_seq_vendedor_pf_w		bigint;
nr_contrato_gerado_w		bigint;
ie_status_w			varchar(1);
qt_adiantamento_w		integer;
vl_saldo_adiantamento_w		adiantamento.vl_saldo%type;
ie_status_adiantamento_w	adiantamento.ie_status%type;


BEGIN

if (nr_seq_proposta_p IS NOT NULL AND nr_seq_proposta_p::text <> '') then
	if (ie_tipo_retorno_p in ('C','NRC','CA')) then
		select	max(nr_sequencia),
			max(nr_contrato)
		into STRICT	nr_seq_contrato_gerado_w,
			nr_contrato_gerado_w
		from	pls_contrato
		where	nr_seq_proposta	= nr_seq_proposta_p;
		
		if (ie_tipo_retorno_p	= 'C') then
			ds_retorno_w		:= nr_seq_contrato_gerado_w;
		elsif (ie_tipo_retorno_p	= 'NRC') then
			ds_retorno_w		:= nr_contrato_gerado_w;
		elsif (ie_tipo_retorno_p = 'CA') then
			if (nr_seq_contrato_gerado_w IS NOT NULL AND nr_seq_contrato_gerado_w::text <> '') then
				select	to_char(dt_aprovacao,'dd/mm/yyyy')
				into STRICT	ds_retorno_w
				from	pls_contrato
				where	nr_sequencia	= nr_seq_contrato_gerado_w;
			end if;
		end if;
	else
		select	cd_cgc_estipulante,
			cd_estipulante,
			ie_tipo_proposta,
			vl_proposta,
			coalesce(nr_seq_cliente,0),
			coalesce(nr_seq_vendedor_canal,0),
			coalesce(nr_seq_vendedor_pf,0),
			ie_status
		into STRICT	cd_cgc_estipulante_w,
			cd_estipulante_w,
			ie_tipo_proposta_w,
			vl_proposta_w,
			nr_seq_cliente_w,
			nr_seq_vendedor_canal_w,
			nr_seq_vendedor_pf_w,
			ie_status_w
		from	pls_proposta_adesao
		where	nr_sequencia	= nr_seq_proposta_p;
		
		if (ie_tipo_retorno_p	= 'NE') then
			if (cd_cgc_estipulante_w IS NOT NULL AND cd_cgc_estipulante_w::text <> '') then
				nm_estipulante_w	:= obter_razao_social(cd_cgc_estipulante_w);
			elsif (cd_estipulante_w IS NOT NULL AND cd_estipulante_w::text <> '') then
				nm_estipulante_w	:= obter_nome_pf(cd_estipulante_w);
			end if;
			
			ds_retorno_w		:= nm_estipulante_w;
		elsif (ie_tipo_retorno_p = 'TE') then
			if (coalesce(cd_cgc_estipulante_w::text, '') = '') then
				ds_retorno_w	:= 'PF';
			elsif (coalesce(cd_estipulante_w::text, '') = '') then
				ds_retorno_w	:= 'PJ';
			end if;
		elsif (ie_tipo_retorno_p = 'TP') then
				ds_retorno_w	:= ie_tipo_proposta_w;
		elsif (ie_tipo_retorno_p = 'V') then
			ds_retorno_w	:= vl_proposta_w;
		elsif (ie_tipo_retorno_p = 'EF') then
			ds_retorno_w	:= cd_estipulante_w;
		elsif (ie_tipo_retorno_p = 'EJ') then
			ds_retorno_w	:= cd_cgc_estipulante_w;
		elsif (ie_tipo_retorno_p = 'VE') then
			ds_retorno_w	:= nr_seq_vendedor_canal_w;
		elsif (ie_tipo_retorno_p = 'CL') then
			ds_retorno_w	:= nr_seq_cliente_w;
		elsif (ie_tipo_retorno_p = 'VF') then
			ds_retorno_w	:= nr_seq_vendedor_pf_w;
		elsif (ie_tipo_retorno_p = 'S') then
			ds_retorno_w := ie_status_w;
		elsif (ie_tipo_retorno_p = 'SA') then
			select	count(1)
			into STRICT	qt_adiantamento_w
			from	adiantamento a,
				pls_proposta_pagador b
			where	a.nr_seq_proposta_pagador	= b.nr_sequencia
			and	b.nr_seq_proposta		= nr_seq_proposta_p;
			
			if (qt_adiantamento_w > 0) then
				select	sum(a.vl_saldo),
					max(a.ie_status)
				into STRICT	vl_saldo_adiantamento_w,
					ie_status_adiantamento_w
				from	adiantamento a,
					pls_proposta_pagador b
				where	a.nr_seq_proposta_pagador	= b.nr_sequencia
				and	b.nr_seq_proposta		= nr_seq_proposta_p;
				
				if (vl_saldo_adiantamento_w = 0) then
					ds_retorno_w	:= 'Baixado';
				else
					select	CASE WHEN ie_status_adiantamento_w='D' THEN 'Pago'  ELSE expressao_pck.obter_desc_expressao(331245) END
					into STRICT	ds_retorno_w
					;
				end if;
			else
				ds_retorno_w	:= '';
			end if;
		end if;
	end if;
end if;

return	ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION pls_obter_dados_proposta ( nr_seq_proposta_p bigint, ie_tipo_retorno_p text) FROM PUBLIC;

