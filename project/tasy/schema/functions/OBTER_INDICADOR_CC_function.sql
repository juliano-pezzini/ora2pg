-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_indicador_cc ( cd_estabelecimento_p bigint, dt_referencia_p timestamp, cd_centro_controle_p bigint, cd_centro_distrib_p bigint, ie_rotina_obtencao_p text, nr_seq_tabela_p bigint) RETURNS bigint AS $body$
DECLARE

 
qt_indicador_w		double precision;
qt_dia_w			bigint;
ie_orcado_real_w	tabela_custo.ie_orcado_real%type;


BEGIN 
begin 
select	a.ie_orcado_real 
into STRICT	ie_orcado_real_w 
from	tabela_custo a 
where	nr_sequencia	= nr_seq_tabela_p;
 
exception when others then 
	ie_orcado_real_w	:= '';
end;
 
/*1 numero total de contas*/
 
if (ie_rotina_obtencao_p = '1') then 
	select count(*) 
	into STRICT 	qt_indicador_w 
	from 	conta_paciente 
	where 	dt_mesano_referencia between trunc(dt_referencia_p,'month') and last_day(dt_referencia_p);
end if;
 
/*2 numero total de internações*/
 
if (ie_rotina_obtencao_p = '2') then 
	select	sum(nr_admissoes) 
	into STRICT	qt_indicador_w 
	from 	eis_ocupacao_hospitalar 
	where	dt_referencia between trunc(dt_referencia_p,'month') and last_day(dt_referencia_p) 
	and 	ie_periodo = 'M';
end if;
 
/*3 numero de atendimentos no centro de controle */
 
if (ie_rotina_obtencao_p = '3') then 
	select sum(nr_admissoes) 
	into STRICT 	qt_indicador_w 
	from	eis_ocupacao_hospitalar 
	where	dt_referencia between trunc(dt_referencia_p,'month') and last_day(dt_referencia_p) 
	and	ie_periodo = 'M' 
	and	cd_setor_atendimento in (SELECT cd_setor_atendimento 
		from setor_atendimento 
		where cd_centro_controle = cd_centro_controle_p);
end if;
 
/*4 numero de pacientes dia no centro de con*/
 
if (ie_rotina_obtencao_p = '4') then 
	select sum(nr_pacientes) 
	into STRICT 	qt_indicador_w 
	from	eis_ocupacao_hospitalar 
	where	dt_referencia between trunc(dt_referencia_p,'month') and last_day(dt_referencia_p) 
	and	ie_periodo = 'M' 
	and	cd_setor_atendimento in (SELECT cd_setor_atendimento 
		from	setor_atendimento 
		where	cd_centro_controle = cd_centro_controle_p);
end if;
 
/*5 numero de procedimentos do centro de controle*/
 
if (ie_rotina_obtencao_p = '5') then 
	select sum(qt_procedimento) 
	into STRICT 	qt_indicador_w 
	from 	eis_proced_faturado 
	where 	dt_contabil = trunc(dt_referencia_p,'month') 
	and 	ie_periodo = 'M' 
	and	cd_setor_atendimento in (SELECT cd_setor_atendimento 
		from setor_atendimento 
		where cd_centro_controle = cd_centro_controle_p);
end if;
 
/*6 numero de horas dos procedimentos do cen*/
 
if (ie_rotina_obtencao_p = '6') then 
	qt_indicador_w	:= 0;
end if;
 
/*7 numero de leitos ativos por centro de controle*/
 
if (ie_rotina_obtencao_p = '7') then 
	select	count(distinct dt_referencia) 
	into STRICT	qt_dia_w 
	from	eis_ocupacao_setor_v 
	where	dt_referencia between trunc(dt_referencia_p,'month') and last_day(dt_referencia_p) 
	and	cd_estabelecimento	= cd_estabelecimento_p 
	and	ie_periodo = 'D' 
	and	cd_setor_atendimento in (SELECT cd_setor_atendimento 
		from setor_atendimento 
		where cd_centro_controle = cd_centro_controle_p);
 
	select	sum(nr_leitos_ocupados + nr_leitos_livres) / qt_dia_w 
	into STRICT 	qt_indicador_w 
	from	eis_ocupacao_setor_v 
	where	dt_referencia between trunc(dt_referencia_p,'month') and last_day(dt_referencia_p) 
	and	cd_estabelecimento	= cd_estabelecimento_p 
	and	ie_periodo = 'D' 
	and	cd_setor_atendimento in (SELECT cd_setor_atendimento 
		from setor_atendimento 
		where cd_centro_controle = cd_centro_controle_p);
end if;
 
 
/* 8      % de ocupação do setor */
 
if (ie_rotina_obtencao_p = '8') then 
	select	dividir(sum(nr_leitos_ocupados) * 100, sum(CASE WHEN ie_temp='S' THEN nr_leitos_ocupados  ELSE nr_leitos_ocupados + nr_leitos_livres END )) 
	into STRICT 	qt_indicador_w 
	from	eis_ocupacao_setor_v 
	where	dt_referencia between trunc(dt_referencia_p,'month') and last_day(dt_referencia_p) 
	and	cd_estabelecimento	= cd_estabelecimento_p 
	and	ie_periodo = 'D' 
	and	cd_setor_atendimento in (SELECT cd_setor_atendimento 
		from setor_atendimento 
		where cd_centro_controle = cd_centro_controle_p);
end if;
 
/* -8      % de ocupação do setor */
 
if (ie_rotina_obtencao_p = '-8') then 
	select	sum(nr_leitos_ocupados) 
	into STRICT 	qt_indicador_w 
	from	eis_ocupacao_setor_v 
	where	dt_referencia between trunc(dt_referencia_p,'month') and last_day(dt_referencia_p) 
	and	cd_estabelecimento	= cd_estabelecimento_p 
	and	ie_periodo = 'D' 
	and	cd_setor_atendimento in (SELECT cd_setor_atendimento 
		from setor_atendimento 
		where cd_centro_controle = cd_centro_controle_p);
end if;
 
/* 9     numero de cirurgias */
 
if (ie_rotina_obtencao_p = '9') then 
	select sum(qt_ocorrencia) 
	into STRICT 	qt_indicador_w 
	from 	eis_cirurgia 
	where	dt_referencia = trunc(dt_referencia_p,'month') 
	and	ie_periodo = 'M' 
	and	cd_setor_atendimento in (SELECT cd_setor_atendimento 
		from setor_atendimento 
		where cd_centro_controle = cd_centro_controle_p);
end if;
 
/*10     tempo das cirurgias em horas*/
 
if (ie_rotina_obtencao_p = '10') then 
	select sum(coalesce(qt_min_duracao,0) / 60) 
	into STRICT 	qt_indicador_w 
	from 	eis_cirurgia 
	where 	dt_referencia = trunc(dt_referencia_p,'month') 
	and 	cd_setor_atendimento in (SELECT cd_setor_atendimento 
		from setor_atendimento 
		where cd_centro_controle = cd_centro_controle_p);
end if;
 
/*11     itens dispensados por centro de controle*/
 
if (ie_rotina_obtencao_p = '11') then 
	select coalesce(sum(qt_itens),0) 
	into STRICT 	qt_indicador_w 
	from 	eis_atendimento_mat a 
	where 	dt_referencia 	= trunc(dt_referencia_p,'month') 
    and	ie_periodo		= 'M' 
	and	cd_centro_custo	= cd_centro_controle_p 
	and	exists (SELECT 1 
		 
		where coalesce(cd_centro_distrib_p::text, '') = '' 
		
union
 
		SELECT 1 
		from 	local_estoque l 
		where 	l.cd_centro_custo 	= cd_centro_distrib_p 
		and	l.cd_local_estoque	= a.cd_local_estoque);
end if;
 
 
/*12     capacidade utilizada */
 
if (ie_rotina_obtencao_p = '12') then 
	select coalesce(max(a.qt_disponibilidade),0) 
	into STRICT 	qt_indicador_w 
	from 	tabela_custo b, 
		capac_centro_controle a 
	where 	b.dt_mes_referencia 	= trunc(dt_referencia_p,'month') 
	and	b.cd_tipo_tabela_custo	= 2 
	and	a.cd_centro_controle	= cd_centro_controle_p 
	and	a.nr_seq_tabela			= b.nr_sequencia 
	and	coalesce(b.cd_estabelecimento, a.cd_estabelecimento)	= a.cd_estabelecimento 
	and	a.cd_estabelecimento	= cd_estabelecimento_p 
	and	a.nr_sequencia_nivel	= 4 
	and	b.ie_orcado_real	= ie_orcado_real_w;
end if;
 
/*13     capacidade teórica */
 
if (ie_rotina_obtencao_p = '13') then 
	select coalesce(sum(a.qt_disponibilidade),0) 
	into STRICT 	qt_indicador_w 
	from 	tabela_custo b, 
		capac_centro_controle a 
	where 	b.dt_mes_referencia 	= trunc(dt_referencia_p,'month') 
	and	b.cd_tipo_tabela_custo	= 2 
	and	a.cd_centro_controle	= cd_centro_controle_p 
	and	a.nr_seq_tabela			= b.nr_sequencia 
	and	coalesce(b.cd_estabelecimento, a.cd_estabelecimento)	= a.cd_estabelecimento 
	and	a.cd_estabelecimento	= cd_estabelecimento_p 
	and	a.nr_sequencia_nivel	= 1 
	and	b.ie_orcado_real	= ie_orcado_real_w;
end if;
 
/* 14 Solicitações de compra*/
 
if (ie_rotina_obtencao_p = '14') then 
	select	count(*) 
	into STRICT	qt_indicador_w 
	from	solic_compra a 
	where	a.cd_estabelecimento	= cd_estabelecimento_p 
	and	trunc(dt_solicitacao_compra,'mm') = dt_referencia_p 
	and	a.cd_setor_atendimento in (	SELECT	x.cd_setor_atendimento 
						from	setor_atendimento x 
						where	x.cd_estabelecimento_base = cd_estabelecimento_p 
						and	x.cd_centro_controle = cd_centro_controle_p);
end if;
 
/* 15 Numero de Exames por centro controle*/
 
if (ie_rotina_obtencao_p = '15') then 
select	coalesce(sum(a.qt_procedimento),0) 
into STRICT	qt_indicador_w 
from	eis_proced_laborat a 
where	a.dt_referencia	= dt_referencia_p 
and	a.ie_periodo		= 'M' 
and	a.cd_estabelecimento	= cd_estabelecimento_p 
and	a.cd_setor_atendimento in ( SELECT	x.cd_setor_atendimento 
				   from	setor_atendimento x 
				   where	x.cd_centro_controle = cd_centro_controle_p 
				   and	x.cd_estabelecimento_base = cd_estabelecimento_p);
end if;
/* 16 - Ponto de equilibrio por centro controle em valor*/
 
if (ie_rotina_obtencao_p = '16') then 
	select	cus_obter_ponto_equilibrio(cd_estabelecimento_p, dt_referencia_p, cd_centro_controle_p,'V') 
	into STRICT	qt_indicador_w 
	;
end if;
 
if (ie_rotina_obtencao_p = '17') then 
	select	sum(qt_nasc_vivo) + sum(qt_nasc_morto) 
	into STRICT	qt_indicador_w 
	from	eis_nascimento 
	where	trunc(dt_nascimento,'mm') = dt_referencia_p;
end if;
 
/* 18 - Ponto de equilibrio por centro controle em quantidade*/
 
if (ie_rotina_obtencao_p = '18') then 
	select	cus_obter_ponto_equilibrio(cd_estabelecimento_p, dt_referencia_p, cd_centro_controle_p,'Q') 
	into STRICT	qt_indicador_w 
	;
end if;
 
/*19     Capacidade prática */
 
if (ie_rotina_obtencao_p = '19') then 
	select coalesce(sum(a.qt_disponibilidade),0) 
	into STRICT 	qt_indicador_w 
	from 	tabela_custo b, 
		capac_centro_controle a 
	where 	b.dt_mes_referencia 	= trunc(dt_referencia_p,'month') 
	and	b.cd_tipo_tabela_custo	= 2 
	and	a.cd_centro_controle	= cd_centro_controle_p 
	and	a.cd_tabela_custo		= b.cd_tabela_custo 
	and	coalesce(b.cd_estabelecimento, a.cd_estabelecimento)	= a.cd_estabelecimento 
	and	b.cd_estabelecimento	= cd_estabelecimento_p 
	and	a.nr_sequencia_nivel	= 2 
	and	b.ie_orcado_real	= ie_orcado_real_w;
end if;
 
/*20     Capacidade de Atendimento */
 
if (ie_rotina_obtencao_p = '20') then 
	select coalesce(sum(a.qt_disponibilidade),0) 
	into STRICT 	qt_indicador_w 
	from 	tabela_custo b, 
		capac_centro_controle a 
	where 	b.dt_mes_referencia 	= trunc(dt_referencia_p,'month') 
	and	b.cd_tipo_tabela_custo	= 2 
	and	a.cd_centro_controle	= cd_centro_controle_p 
	and	a.cd_tabela_custo		= b.cd_tabela_custo 
	and	coalesce(b.cd_estabelecimento, a.cd_estabelecimento)	= a.cd_estabelecimento 
	and	b.cd_estabelecimento	= cd_estabelecimento_p 
	and	a.nr_sequencia_nivel	= 3 
	and	b.ie_orcado_real	= ie_orcado_real_w;
end if;
 
/*21 - Capacidade utilizada - Ponto de Equilibrio */
 
 
if (ie_rotina_obtencao_p = '21') then 
 
	select	coalesce(max(qt_base_ponto_equil),max(qt_disponibilidade)) 
	into STRICT	qt_indicador_w 
	from	tabela_custo b, 
		capac_centro_controle a 
	where	a.cd_tabela_custo	= b.cd_tabela_custo 
	and	a.cd_centro_controle	= cd_centro_controle_p 
	and	a.cd_estabelecimento	= cd_estabelecimento_p 
	and	coalesce(b.cd_estabelecimento, a.cd_estabelecimento)	= a.cd_estabelecimento 
	and	b.cd_tipo_tabela_custo	= 2 
	and	b.dt_mes_referencia 	= trunc(dt_referencia_p,'month') 
	and	nr_sequencia_nivel	= 4 
	and	b.ie_orcado_real	= ie_orcado_real_w;
end if;
 
 
/*22 - Número de movimentações por centro de controle*/
 
 
if (ie_rotina_obtencao_p = '22') then 
 
	select	coalesce(sum(obter_qt_passagem_setor(a.cd_estabelecimento_base, a.cd_setor_atendimento, dt_referencia_p, dt_referencia_p, 'M')), 0) 
	into STRICT	qt_indicador_w 
	from	setor_atendimento	a 
	where	a.cd_estabelecimento_base	= cd_estabelecimento_p 
	and	a.cd_centro_controle	= cd_centro_controle_p;
	 
end if;
 
return	qt_indicador_w;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_indicador_cc ( cd_estabelecimento_p bigint, dt_referencia_p timestamp, cd_centro_controle_p bigint, cd_centro_distrib_p bigint, ie_rotina_obtencao_p text, nr_seq_tabela_p bigint) FROM PUBLIC;

