-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION planserv_obter_dados_medico ( nr_atendimento_p bigint, cd_medico_p text, nr_crm_medico_p text, uf_crm_medico_p text, ie_resp_solic_p text, ie_opcao_p text) RETURNS varchar AS $body$
DECLARE


			
ds_retorno_w		varchar(255);
cd_medico_w		medico.cd_pessoa_fisica%type;
nr_crm_w		medico.nr_crm%type;
uf_crm_w		medico.uf_crm%type;
ds_sigla_cons_w		varchar(10);

/*ie_resp_solic_p
S - Applicant
R - Responsible
E - Performer


ie_opcao_p
C - Doctor Code
R - Doctor's CRM
U - State of Doctor's CRM
S - Abbreviation of professional council
*/
C01 CURSOR FOR
	SELECT	a.cd_medico,
		c.nr_crm,
		c.uf_crm,
		substr(Obter_Conselho_Profissional(b.nr_seq_conselho,'S'),1,10) sigla
	from	prescr_medica a,
		pessoa_fisica b,
		medico c
	where	a.cd_medico		= b.cd_pessoa_fisica
	and	b.cd_pessoa_fisica 	= c.cd_pessoa_fisica	
	and	a.nr_atendimento 	= nr_atendimento_p
	order by a.nr_prescricao desc;



BEGIN

if	((coalesce(obter_tipo_atendimento(nr_atendimento_p),0) = 7) or (ie_resp_solic_p = 'E')) then

	open C01;
	loop
	fetch C01 into	
		cd_medico_w,
		nr_crm_w,
		uf_crm_w,
		ds_sigla_cons_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin
		cd_medico_w	:= cd_medico_w;
		nr_crm_w	:= nr_crm_w;
		uf_crm_w	:= uf_crm_w;
		ds_sigla_cons_w	:= ds_sigla_cons_w;
		end;
	end loop;
	close C01;
else
	cd_medico_w	:= cd_medico_p;
	nr_crm_w	:= nr_crm_medico_p;
	uf_crm_w	:= uf_crm_medico_p;
	ds_sigla_cons_w	:= substr(OBTER_DADOS_MEDICO(cd_medico_p,'SGCRM'),1,10);
end if;

if (ie_opcao_p = 'C') then
	ds_retorno_w := cd_medico_w;
elsif (ie_opcao_p = 'R') then
	ds_retorno_w := nr_crm_w;
elsif (ie_opcao_p = 'U') then	
	ds_retorno_w := uf_crm_w;
elsif (ie_opcao_p = 'S') then	
	ds_retorno_w := ds_sigla_cons_w;
end if;

return	ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION planserv_obter_dados_medico ( nr_atendimento_p bigint, cd_medico_p text, nr_crm_medico_p text, uf_crm_medico_p text, ie_resp_solic_p text, ie_opcao_p text) FROM PUBLIC;

