-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_regulacao_vinculadas (nr_sequencia_p bigint, ie_tipo_p text default 'E') RETURNS varchar AS $body$
DECLARE


ds_vinculado_w			varchar(255) := null;
ds_status_w				varchar(255);
ds_equipamento_w		varchar(255);
ds_material_w			varchar(255);
ds_procedimento_w		varchar(255);

c01 CURSOR FOR
SELECT substr(ds_equipamento, 1, 255) ds_equipamento,
	substr(obter_valor_dominio(8890,a.ie_status), 1, 255) ds_status
from regulacao_atend a,
	hc_pac_equipamento c,
	man_equipamento d
where c.nr_seq_paciente = nr_sequencia_p
	and a.nr_seq_equip_home = c.nr_sequencia
	and d.nr_sequencia = c.nr_seq_equip_control;

c02 CURSOR FOR
SELECT substr(CASE WHEN(somente_numero(a.cd_material_envio))=0 THEN  obter_medicamento_regulacao(a.cd_material)  ELSE a.cd_material_envio END , 1, 255) ds_material,
	substr(CASE WHEN(somente_numero(cd_procedimento_envio))=0 THEN obter_descricao_procedimento(cd_procedimento,ie_origem_proced)  ELSE coalesce(obter_descricao_procedimento(cd_procedimento_envio,ie_origem_proced),cd_procedimento_envio) END , 1, 255)  ds_procedimento,
	substr(obter_valor_dominio(8890,a.ie_status), 1, 255) ds_status
from regulacao_atend a,
	hc_pac_equipamento c
where c.nr_sequencia = nr_sequencia_p
	and a.nr_seq_home_care = c.nr_seq_paciente;


BEGIN

	if (ie_tipo_p = 'E') then
		open c01;
		loop
		fetch c01 into
			ds_equipamento_w,
			ds_status_w;
		EXIT WHEN NOT FOUND; /* apply on c01 */
			begin
				if (ds_vinculado_w IS NOT NULL AND ds_vinculado_w::text <> '') then
					ds_vinculado_w := ds_vinculado_w || '; ';
				elsif (coalesce(ds_vinculado_w::text, '') = '') then
					ds_vinculado_w := '';
				end if;

				ds_vinculado_w := ds_vinculado_w || ds_equipamento_w || ' - ' || ds_status_w;
			end;
		end loop;
		close c01;
	else
		open c02;
		loop
		fetch c02 into
			ds_material_w,
			ds_procedimento_w,
			ds_status_w;
		EXIT WHEN NOT FOUND; /* apply on c02 */
			begin
				if (ds_vinculado_w IS NOT NULL AND ds_vinculado_w::text <> '') then
					ds_vinculado_w := ds_vinculado_w || '; ';
				elsif (coalesce(ds_vinculado_w::text, '') = '') then
					ds_vinculado_w := '';
				end if;

				if (ds_procedimento_w IS NOT NULL AND ds_procedimento_w::text <> '') then
					ds_vinculado_w :=  ds_vinculado_w || ds_procedimento_w || ' - ' || ds_status_w;
				else
					ds_vinculado_w :=  ds_vinculado_w || ds_material_w || ' - ' || ds_status_w;
				end if;
			end;
		end loop;
		close c02;
	end if;

	return	ds_vinculado_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_regulacao_vinculadas (nr_sequencia_p bigint, ie_tipo_p text default 'E') FROM PUBLIC;

