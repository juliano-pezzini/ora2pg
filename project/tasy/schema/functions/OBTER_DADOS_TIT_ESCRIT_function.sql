-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_dados_tit_escrit ( nr_titulo_p bigint, nr_seq_escrit_p bigint, ie_opcao_p text) RETURNS varchar AS $body$
DECLARE


/* ie_opcao

VL	valor líquido
DE	descrição do estabelecimento
BE 	beneficiario
VT	valor  do titulo
VST	saldo do titulo
SJ	saldo do juros
SM 	saldo  da multa
DV	data  de vencimento atual
NB	numero do bloqueto
DA	valor dia antecipado
NF	número nota fiscal
ND	numero do documeto
I	inconsistente
VI	valor imposto
TP	tipo pagamento
R	Rejeitado
DFB	diferença bloqueto
ST           situação do título

*/
ds_retorno_w			varchar(255);
vl_liquido_w			double precision;
ds_estabelecimento_w		varchar(255);
ds_beneficiario_w		varchar(255);
vl_titulo_w			double precision;
vl_saldo_titulo_w		double precision;
vl_saldo_juros_w		double precision;
vl_saldo_multa_w		double precision;
dt_vencimento_atual_w		timestamp;
nr_bloqueto_w			varchar(100);
vl_dia_antecipacao_w		double precision;
nr_nota_fiscal_w		varchar(255);
nr_documento_w			varchar(40);
ie_inconsistente_w 		varchar(1);
vl_imposto_w 			double precision;
ds_tipo_pagamento_w 		varchar(255);
vl_diferenca_bloq_w		double precision;
ie_rejeitado_w			varchar(1);
ie_situacao_w                   varchar(1);


BEGIN

select (a.vl_escritural + a.vl_acrescimo - a.vl_desconto + coalesce(a.vl_juros,0) + coalesce(a.vl_multa,0) + coalesce(a.vl_despesa,0)) vl_liquido,
	substr(obter_inconsist_rem_escrit(null,a.nr_seq_escrit,a.nr_titulo),1,1),
	substr(obter_valor_dominio(1049,a.ie_tipo_pagamento),1,254)
into STRICT	vl_liquido_w,
	ie_inconsistente_w,
	ds_tipo_pagamento_w
from	titulo_pagar_escrit a
where	a.nr_titulo	= nr_titulo_p
and	a.nr_seq_escrit	= nr_seq_escrit_p;

select	substr(obter_nome_estabelecimento(a.cd_estabelecimento),1,255) ds_estabelecimento,
	coalesce(a.vl_dia_antecipacao,0),
	substr(obter_nome_pf_pj(a.cd_pessoa_fisica, a.cd_cgc),1, 200),
	a.vl_titulo,
	a.vl_saldo_titulo,
	a.vl_saldo_juros,
	a.vl_saldo_multa,
	a.dt_vencimento_atual,
	a.nr_bloqueto,
	a.nr_documento,
	(obter_dados_tit_pagar(a.nr_titulo,'T'))::numeric ,
	obter_diferenca_bloqueto(a.nr_titulo,null),
	a.ie_situacao
into STRICT	ds_estabelecimento_w,
	vl_dia_antecipacao_w,
	ds_beneficiario_w,
	vl_titulo_w,
	vl_saldo_titulo_w,
	vl_saldo_juros_w,
	vl_saldo_multa_w,
	dt_vencimento_atual_w,
	nr_bloqueto_w,
	nr_documento_w,
	vl_imposto_w,
	vl_diferenca_bloq_w,
	ie_situacao_w
from	titulo_pagar a
where	a.nr_titulo	= nr_titulo_p;

select  max(a.nr_nota_fiscal)
into STRICT 	nr_nota_fiscal_w
from 	nota_fiscal a,
	titulo_pagar b
where 	a.nr_sequencia	= b.nr_seq_nota_fiscal
and 	b.nr_titulo	= nr_titulo_p;

select (select coalesce(max('S'),'N')
	from 	erro_escritural x
	where 	x.ie_rejeitado = 'R'
	and 	position(x.cd_erro in a.ds_erro) > 0
	and 	x.cd_banco = d.cd_banco) ie_rejeitado
into STRICT 	ie_rejeitado_w
from    banco_escritural d,
	titulo_pagar_escrit a
where   a.nr_seq_escrit  = d.nr_sequencia
and   	a.nr_seq_escrit  = nr_seq_escrit_p
and  	a.nr_titulo      = nr_titulo_p
order by a.nr_titulo;


if (ie_opcao_p	= 'VL') then

	ds_retorno_w	:= vl_liquido_w;

elsif (ie_opcao_p	= 'DE') then

	ds_retorno_w	:= ds_estabelecimento_w;

elsif (ie_opcao_p	= 'BE')	then

	ds_retorno_w 	:= ds_beneficiario_w;

elsif (ie_opcao_p	= 'VT')	then

	ds_retorno_w 	:= vl_titulo_w;

elsif (ie_opcao_p	= 'VST')	then

	ds_retorno_w 	:= vl_saldo_titulo_w;

elsif (ie_opcao_p	= 'SJ')	then

	ds_retorno_w 	:= vl_saldo_juros_w;

elsif (ie_opcao_p	= 'SM')	then

	ds_retorno_w 	:= vl_saldo_multa_w;

elsif (ie_opcao_p	= 'DV')	then

	ds_retorno_w 	:= dt_vencimento_atual_w;

elsif (ie_opcao_p	= 'NB')	then

	ds_retorno_w 	:= nr_bloqueto_w;

elsif (ie_opcao_p	= 'DA')	then

	ds_retorno_w 	:= vl_dia_antecipacao_w;

elsif (ie_opcao_p	= 'NF')	then

	ds_retorno_w 	:= nr_nota_fiscal_w;

elsif (ie_opcao_p	= 'ND') then

	ds_retorno_w	:= nr_documento_w;

elsif (ie_opcao_p	= 'I') then

	ds_retorno_w	:= ie_inconsistente_w;

elsif (ie_opcao_p	= 'VI') then

	ds_retorno_w	:= vl_imposto_w;

elsif (ie_opcao_p	= 'TP') then

	ds_retorno_w	:= ds_tipo_pagamento_w;

elsif (ie_opcao_p	= 'R') then

	ds_retorno_w	:= ie_rejeitado_w;

elsif (ie_opcao_p	= 'DFB') then

	ds_retorno_w	:= vl_diferenca_bloq_w;

elsif (ie_opcao_p	= 'ST') then
	ds_retorno_w	:= ie_situacao_w;

end if;

RETURN ds_retorno_w;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_dados_tit_escrit ( nr_titulo_p bigint, nr_seq_escrit_p bigint, ie_opcao_p text) FROM PUBLIC;

