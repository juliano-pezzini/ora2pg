-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION tiss_obter_codigo_prestador (cd_convenio_p bigint, cd_estabelecimento_p bigint, cd_pessoa_fisica_p text, cd_cgc_p text, cd_setor_atendimento_p bigint, ie_opcao_p text, dt_procedimento_p timestamp, ie_tipo_atendimento_p bigint, cd_categoria_p text default null, ie_funcao_medico_p text default null) RETURNS varchar AS $body$
DECLARE


ds_retorno_w		varchar(100) := '';
nr_cpf_w		varchar(100) := '';
cd_cgc_estab_w		varchar(100) := '';
cd_interno_w		varchar(100) := '';
cd_cgc_w		varchar(100) := '';
ie_crm_w		varchar(100) := '';
nr_crm_w		varchar(100) := '';
ds_versao_w		varchar(20);
cont_w			bigint;
ds_mascara_crm_w	varchar(255) := '';
qt_digitos_crm_w	double precision  := '';
nr_crm_mascara_w	varchar(255) := '';

/*
ie_opcao_p	
'CPF'
'CI'		-Código no convênio
'CGC'
*/
BEGIN

if (coalesce(cd_pessoa_fisica_p,'0') <> '0') then
	-- Edgar 11/09/2007, OS 67991
	select	coalesce(max(ie_crm),'N'),
		max(ds_mascara_crm)
	into STRICT	ie_crm_w,
		ds_mascara_crm_w
	from	tiss_parametros_convenio
	where	cd_convenio		= cd_convenio_p
	and	cd_estabelecimento	= cd_estabelecimento_p;

	select	max(tiss_obter_versao(cd_convenio_p, cd_estabelecimento_p))
	into STRICT	ds_versao_w
	;

	cd_interno_w		:= obter_medico_convenio(cd_estabelecimento_p, cd_pessoa_fisica_p, cd_convenio_p, null, (coalesce(obter_especialidade_medico(cd_pessoa_fisica_p, 'C'),0))::numeric , cd_categoria_p, cd_setor_atendimento_p,dt_procedimento_p, ie_tipo_atendimento_p, ie_funcao_medico_p, null);

	if (coalesce(cd_interno_w::text, '') = '') then
		if (ie_crm_w = 'N') then
			select	max(nr_cpf)
			into STRICT	nr_cpf_w
			from	pessoa_fisica
			where	cd_pessoa_fisica	= cd_pessoa_fisica_p;
		elsif (ie_crm_w = 'P') then

			if (coalesce(ds_versao_w, '2.01.02') = '2.01.02') then
				select	max(nr_crm)
				into STRICT	cd_interno_w
				from	medico
				where	cd_pessoa_fisica	= cd_pessoa_fisica_p;
			else
				select	max(nr_crm)
				into STRICT	nr_crm_w
				from	medico
				where	cd_pessoa_fisica	= cd_pessoa_fisica_p;

				if (ds_mascara_crm_w IS NOT NULL AND ds_mascara_crm_w::text <> '') then
		
					if (length(nr_crm_w) < length(ds_mascara_crm_w)) then
						qt_digitos_crm_w	:= length(ds_mascara_crm_w);
						nr_crm_w		:= lpad(nr_crm_w, qt_digitos_crm_w,0);
					end if;			

					begin
					select	TISS_OBTER_COD_USUARIO_MASC(nr_crm_w, ds_mascara_crm_w)
					into STRICT	nr_crm_mascara_w
					;
			
					exception
					when others then
						nr_crm_mascara_w	:= null;
					end;
				
					if (nr_crm_mascara_w IS NOT NULL AND nr_crm_mascara_w::text <> '') then
						nr_crm_w	:= nr_crm_mascara_w;
					end if;
				end if;

				cd_interno_w	:= nr_crm_w;

			end if;

		else
			if (coalesce(ds_versao_w, '2.01.02') = '2.01.02') then
				select	max(nr_crm)
				into STRICT	nr_cpf_w
				from	medico
				where	cd_pessoa_fisica	= cd_pessoa_fisica_p;
			else
				select	max(nr_crm)
				into STRICT	nr_crm_w
				from	medico
				where	cd_pessoa_fisica	= cd_pessoa_fisica_p;

				if (ds_mascara_crm_w IS NOT NULL AND ds_mascara_crm_w::text <> '') then
		
					if (length(nr_crm_w) < length(ds_mascara_crm_w)) then
						qt_digitos_crm_w	:= length(ds_mascara_crm_w);
						nr_crm_w		:= lpad(nr_crm_w, qt_digitos_crm_w,0);
					end if;			

					begin
					select	TISS_OBTER_COD_USUARIO_MASC(nr_crm_w, ds_mascara_crm_w)
					into STRICT	nr_crm_mascara_w
					;
			
					exception
					when others then
						nr_crm_mascara_w	:= null;
					end;
				
					if (nr_crm_mascara_w IS NOT NULL AND nr_crm_mascara_w::text <> '') then
						nr_crm_w	:= nr_crm_mascara_w;
					end if;
				end if;

				nr_cpf_w := nr_crm_w;

			end if;

			if (coalesce(nr_cpf_w::text, '') = '') then
				select	max(nr_cpf)
				into STRICT	nr_cpf_w
				from	pessoa_fisica
				where	cd_pessoa_fisica	= cd_pessoa_fisica_p;
			end if;
			nr_cpf_w	:= lpad(nr_cpf_w, 11, '0');
		end if;
	end if;
elsif (coalesce(cd_cgc_p,'X') <> 'X') then

	select	max(cd_prestador_convenio)
	into STRICT	cd_interno_w
	from	convenio_prestador
	where	cd_convenio			= cd_convenio_p
	and	cd_estabelecimento		= cd_estabelecimento_p
	and	cd_cgc				= cd_cgc_p
	and	coalesce(dt_procedimento_p,clock_timestamp())	between coalesce(dt_inicio_vigencia,clock_timestamp() - interval '9999 days') and fim_dia(coalesce(dt_fim_vigencia, clock_timestamp()));
	
	if (coalesce(cd_interno_w::text, '') = '') then
		select	max(cd_cgc)
		into STRICT	cd_cgc_estab_w
		from	estabelecimento
		where	cd_estabelecimento	= cd_estabelecimento_p;
		if (cd_cgc_estab_w = cd_cgc_p) then

			select	count(*)
			into STRICT	cont_w
			from	convenio_estabelecimento
			where	cd_estabelecimento	= cd_estabelecimento_p
			and	cd_convenio		= cd_convenio_p;

			if (cont_w > 0) then
				select	max(cd_interno)
				into STRICT	cd_interno_w
				from	convenio_estabelecimento
				where	cd_estabelecimento	= cd_estabelecimento_p
				and	cd_convenio		= cd_convenio_p;
			else
				select	max(Obter_Valor_Conv_Estab(cd_convenio, cd_estabelecimento_p, 'CD_INTERNO'))
				into STRICT	cd_interno_w
				from	convenio
				where	cd_convenio		= cd_convenio_p;
			end if;
		end if;
		if (coalesce(cd_interno_w::text, '') = '') and (ie_opcao_p = 'CGC') then
			select	coalesce(max(cd_cgc),'')
			into STRICT	cd_cgc_w
			from	pessoa_juridica
			where	cd_cgc			= cd_cgc_p;
		end if;
	end if;
end if;

if (ie_opcao_p = 'CI') then
	ds_retorno_w		:= cd_interno_w;
elsif (cd_interno_w IS NOT NULL AND cd_interno_w::text <> '') then
	ds_retorno_w	:= '';
elsif (nr_cpf_w IS NOT NULL AND nr_cpf_w::text <> '') and (ie_opcao_p = 'CPF') then
	ds_retorno_w	:= lpad(trim(both nr_cpf_w), 11, '0');
elsif (cd_cgc_p IS NOT NULL AND cd_cgc_p::text <> '') and (ie_opcao_p = 'CGC') then
	ds_retorno_w	:= cd_cgc_w;
elsif (nr_crm_w IS NOT NULL AND nr_crm_w::text <> '') and (ie_opcao_p = 'CRM') then
	ds_retorno_w	:= nr_crm_w;
end if;

return	ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION tiss_obter_codigo_prestador (cd_convenio_p bigint, cd_estabelecimento_p bigint, cd_pessoa_fisica_p text, cd_cgc_p text, cd_setor_atendimento_p bigint, ie_opcao_p text, dt_procedimento_p timestamp, ie_tipo_atendimento_p bigint, cd_categoria_p text default null, ie_funcao_medico_p text default null) FROM PUBLIC;

