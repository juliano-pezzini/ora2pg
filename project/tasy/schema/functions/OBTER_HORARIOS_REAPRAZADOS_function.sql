-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_horarios_reaprazados ( nr_seq_pe_prescr_p bigint, nr_seq_pe_proc_p bigint, nr_seq_sae_duplicado_p bigint default 0) RETURNS varchar AS $body$
DECLARE


ds_retorno_horario_w  pe_prescr_proc.ds_horarios%type;
ds_horario_w          varchar(50);
dt_validade_prescr_w  pe_prescricao.dt_validade_prescr%type;
dt_inicio_prescr_w    pe_prescricao.dt_inicio_prescr%type;
dt_aux_w			  timestamp;
qt_dias_dif_w		  smallint;

C01 CURSOR FOR

	SELECT dt_horario,
	lpad(coalesce(pkg_date_utils.extract_field('HOUR', dt_horario, 0), 0),2,'0') DT_HORA,
	lpad(coalesce(pkg_date_utils.extract_field('MINUTE', dt_horario, 0), 0),2,'0') DT_MINUTO
	from   	pe_prescr_proc_hor
	where nr_seq_pe_prescr = nr_seq_pe_prescr_p
	and nr_seq_pe_proc = nr_seq_pe_proc_p
	order by dt_horario;	

BEGIN

	if (nr_seq_sae_duplicado_p > 0) then
		select dt_validade_prescr, dt_inicio_prescr
		into STRICT dt_validade_prescr_w, dt_inicio_prescr_w
		from pe_prescricao
		where nr_sequencia = nr_seq_sae_duplicado_p;
	end if;
	
	dt_aux_w := dt_inicio_prescr_w;
	qt_dias_dif_w := 999;

	for	r_c01_w in c01 loop
		begin
		
		if (qt_dias_dif_w = 999) then
			qt_dias_dif_w :=  trunc(dt_inicio_prescr_w) - trunc(r_c01_w.dt_horario);
		end if;
		
		ds_horario_w := r_c01_w.DT_HORA;
		if (r_c01_w.DT_MINUTO > 0) then
		   ds_horario_w := ds_horario_w || ':'||r_c01_w.DT_MINUTO;
		end if;
		
		dt_aux_w := r_c01_w.dt_horario + qt_dias_dif_w;
					
		if ((dt_aux_w > dt_inicio_prescr_w) and (dt_aux_w > dt_validade_prescr_w) and (nr_seq_sae_duplicado_p > 0))then		
			ds_retorno_horario_w := ds_horario_w || ' ' || ds_retorno_horario_w;
		elsif (length(ds_retorno_horario_w) > 0)then
			ds_retorno_horario_w := ds_retorno_horario_w || ' ' || ds_horario_w;
		else
			ds_retorno_horario_w := ds_horario_w;
		end if;

		end;
	end loop;

return ds_retorno_horario_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_horarios_reaprazados ( nr_seq_pe_prescr_p bigint, nr_seq_pe_proc_p bigint, nr_seq_sae_duplicado_p bigint default 0) FROM PUBLIC;

