-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_valor_liquido_oci ( nr_ordem_compra_p bigint, nr_item_oci_p bigint) RETURNS bigint AS $body$
DECLARE


vl_item_w				double precision;
vl_item_ww			double precision;
vl_desconto_w			double precision;
vl_desconto_ww			double precision := 0;
pr_tributo_w			double precision;
vl_retorno_w			double precision;
vl_retorno_div_w			double precision;
pr_descontos_w			ordem_compra_item.pr_descontos%type;
vl_unitario_material_w	ordem_compra_item.vl_unitario_material%type;
qt_material_w			ordem_compra_item.qt_material%type;
vl_tributo_w			ordem_compra_item_trib.vl_tributo%type;


BEGIN

select	coalesce(coalesce(vl_total_item,(qt_material*vl_unitario_material)),0),
		coalesce(pr_descontos,0),
		coalesce(vl_desconto,0),
		vl_unitario_material,
		qt_material
into STRICT	vl_item_w,
		pr_descontos_w,
		vl_desconto_w,
		vl_unitario_material_w,
		qt_material_w
from	ordem_compra_item
where	nr_ordem_compra 		= nr_ordem_compra_p
and	nr_item_oci		= nr_item_oci_p;

select	coalesce(sum(CASE WHEN b.ie_soma_diminui='S' THEN  pr_tributo WHEN b.ie_soma_diminui='D' THEN pr_tributo * -1  ELSE 0 END ),0),
	coalesce(sum(CASE WHEN b.ie_soma_diminui='S' THEN  VL_TRIBUTO WHEN b.ie_soma_diminui='D' THEN VL_TRIBUTO * -1  ELSE 0 END ),0)
into STRICT	pr_tributo_w,
	vl_tributo_w
from	tributo b,
	ordem_compra_item_trib a
where	a.cd_tributo		= b.cd_tributo
and 	a.nr_ordem_compra		= nr_ordem_compra_p
and 	a.nr_item_oci		= nr_item_oci_p;

if (coalesce(vl_desconto_w,0) > 0) then
	vl_item_w		:= 	vl_item_w - coalesce(vl_desconto_w,0);
else
	vl_item_w		:= 	vl_item_w - ((vl_item_w * pr_descontos_w) / 100);
end if;

if (vl_desconto_w > 0) then
	vl_desconto_ww 		:= vl_desconto_w;
else
	vl_desconto_ww		:= 	coalesce((((vl_unitario_material_w * qt_material_w) * pr_descontos_w) / 100),0);
end if;

vl_item_ww 			:= coalesce(vl_item_w,0) + coalesce(vl_desconto_ww,0);

/*Se tem valor do tributo, gera diretamente o valor do tributo sem precisar calcular pelo percentual, pois não há necessidade*/

if (vl_tributo_w <> 0) then
	vl_retorno_div_w	:= vl_tributo_w;
else
	vl_retorno_div_w	:= round((dividir(vl_item_ww, 100) * pr_tributo_w)::numeric, 2);
end if;


vl_retorno_w	 		:= vl_item_ww + round((vl_retorno_div_w)::numeric,4) - coalesce(vl_desconto_ww,0);

return vl_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_valor_liquido_oci ( nr_ordem_compra_p bigint, nr_item_oci_p bigint) FROM PUBLIC;

