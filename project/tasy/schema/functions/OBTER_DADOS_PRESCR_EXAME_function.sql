-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_dados_prescr_exame (nr_prescricao_p bigint) RETURNS varchar AS $body$
DECLARE


nm_exame_w	varchar(30);
dt_aprovacao_w  timestamp;
dt_coleta_w	timestamp;
dt_digitacao_w	timestamp;
ds_retorno_w	varchar(4000);
ds_retorno1_w	varchar(500);
ds_mascara_w	varchar(100);

c01 CURSOR FOR
SELECT	substr(obter_desc_exame(b.nr_seq_exame),1,30),
	dt_aprovacao,
	coalesce(to_date(lab_obter_data_recoleta(nr_prescricao_p,b.NR_SEQ_PRESCR,a.nm_usuario,0),'dd/mm/yyyy hh24:mi:ss') ,(b.dt_coleta)),
	b.dt_digitacao
from	exame_lab_result_item b,
	exame_lab_resultado a
where	a.nr_prescricao = nr_prescricao_p
and	a.nr_seq_resultado = b.nr_seq_resultado
and	(nr_seq_material IS NOT NULL AND nr_seq_material::text <> '');


BEGIN

ds_mascara_w := pkg_date_formaters.localize_mask('timestamp', pkg_date_formaters.getUserLanguageTag(wheb_usuario_pck.get_cd_estabelecimento, wheb_usuario_pck.get_nm_usuario));

	open c01;
	loop
	fetch c01 into
		nm_exame_w,
		dt_aprovacao_w,
		dt_coleta_w,
		dt_digitacao_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
		begin

		ds_retorno_w	:= ds_retorno_w || rpad(nm_exame_w,32,' ') || rpad(coalesce(to_char(dt_coleta_w, ds_mascara_w),wheb_mensagem_pck.get_texto(802718)),21,' ') || rpad(coalesce(to_char(dt_digitacao_w, ds_mascara_w),wheb_mensagem_pck.get_texto(802718)),21,' ') || rpad(to_char(dt_aprovacao_w, ds_mascara_w),19,' ') ||  chr(13);

		end;

	end loop;
	close C01;

if (ds_retorno_w IS NOT NULL AND ds_retorno_w::text <> '') then
	ds_retorno1_w	:= rpad(wheb_mensagem_pck.get_texto(798800),32,' ') || rpad(wheb_mensagem_pck.get_texto(802719),21,' ') || rpad(wheb_mensagem_pck.get_texto(802720),21,' ') || rpad(wheb_mensagem_pck.get_texto(802721),19,' ');
	ds_retorno_w	:= ds_retorno1_w ||  chr(13) || ds_retorno_w;
end if;
return ds_retorno_w;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_dados_prescr_exame (nr_prescricao_p bigint) FROM PUBLIC;

