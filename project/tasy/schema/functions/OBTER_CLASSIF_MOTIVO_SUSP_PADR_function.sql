-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_classif_motivo_susp_padr (CD_PERFIL_P bigint, CD_ESTABELECIMENTO_P bigint, IE_TIPO_P text, CD_CLASSIFICACAO_P bigint, IE_OPCAO_P text ) RETURNS bigint AS $body$
DECLARE


/*
IE_TIPO_P
C	- Classificação
M	- Motivo
*/
nr_seq_classificacao_w	classif_suspensao_prescr.nr_sequencia%type;
nr_seq_motivo_w			motivo_suspensao_prescr.nr_sequencia%type;
nr_seq_retorno_w		bigint;


BEGIN

if (ie_tipo_p = 'C') then

	select 	MAX(nr_sequencia)
	into STRICT	nr_seq_retorno_w
	from   	classif_suspensao_prescr a
	where  	exists (SELECT 1 from motivo_suspensao_prescr x
				  where x.nr_seq_classif       	= a.nr_sequencia
				  and   x.cd_estabelecimento   	= cd_estabelecimento_p
				  and   x.ie_opcao             	in (ie_opcao_p,'T')
				  and   x.ie_situacao          	= 'A'
				  and   coalesce(x.ie_utilizacao,'A') in ('R','A'))
	and		ie_padrao = 'S'
	and		Obter_Se_Classif_Susp_Lib(a.nr_sequencia) = 'S'
	and	   	coalesce(a.cd_perfil,cd_perfil_p)			= cd_perfil_p;


elsif (ie_tipo_p = 'M') then

	select  max(nr_sequencia)
	into STRICT	nr_seq_retorno_w
	from    motivo_suspensao_prescr
	where   cd_estabelecimento		= cd_estabelecimento_p
	and     ie_opcao 				in (ie_opcao_p,'T')
	and     ie_situacao 			= 'A'
	and     ((coalesce(nr_seq_classif::text, '') = '') or (nr_seq_classif = cd_classificacao_p) or (cd_classificacao_p = 0))
	and     coalesce(ie_utilizacao,'A') 	in ('R','A')
	and		ie_padrao				= 'S'
	and		Obter_Se_motivo_Susp_Lib(nr_sequencia) = 'S';

end if;

RETURN	coalesce(nr_seq_retorno_w,0);

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_classif_motivo_susp_padr (CD_PERFIL_P bigint, CD_ESTABELECIMENTO_P bigint, IE_TIPO_P text, CD_CLASSIFICACAO_P bigint, IE_OPCAO_P text ) FROM PUBLIC;

