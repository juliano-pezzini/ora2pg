-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION ctb_obter_permissao_movto_lote ( nr_lote_contabil_p bigint, cd_conta_contabil_p text, cd_perfil_p bigint, nm_usuario_p text) RETURNS varchar AS $body$
DECLARE


cd_tipo_lote_contabil_w	bigint;
cd_conta_contabil_w	varchar(20);
ie_permite_w		varchar(1);
ie_regra_w		varchar(1);

c01 CURSOR FOR
SELECT	ie_permite
from	ctb_digitacao_movto_lib a
where	coalesce(cd_perfil_lib, cd_perfil_p) = cd_perfil_p
and	coalesce(nm_usuario_lib, nm_usuario_p) = nm_usuario_p
and	coalesce(cd_conta_contabil, cd_conta_contabil_w) = cd_conta_contabil_w
and	coalesce(cd_tipo_lote_contabil, cd_tipo_lote_contabil_w) = cd_tipo_lote_contabil_w
order by	nm_usuario_lib desc,
	cd_perfil_lib desc,
	cd_conta_contabil desc,
	cd_tipo_lote_contabil desc;


BEGIN
ie_permite_w	:= 'S';

begin
select	'S'
into STRICT	ie_regra_w
from	ctb_digitacao_movto_lib LIMIT 1;
exception
when others then
	ie_regra_w	:= 'N';
end;

if (ie_regra_w = 'S') then
	begin
	cd_conta_contabil_w	:= coalesce(cd_conta_contabil_p,'X');

	begin
	select	cd_tipo_lote_contabil
	into STRICT	cd_tipo_lote_contabil_w
	from	lote_contabil
	where	nr_lote_contabil = nr_lote_contabil_p;
	exception
	when others then
		cd_tipo_lote_contabil_w := 0;
	end;

	open c01;
	loop
	fetch c01 into
		ie_permite_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
	end loop;
	close c01;
	end;
end if;

return	ie_permite_w;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION ctb_obter_permissao_movto_lote ( nr_lote_contabil_p bigint, cd_conta_contabil_p text, cd_perfil_p bigint, nm_usuario_p text) FROM PUBLIC;

