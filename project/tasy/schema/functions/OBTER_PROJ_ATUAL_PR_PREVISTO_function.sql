-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_proj_atual_pr_previsto ( nr_seq_projeto_p bigint, ie_tipo_cronograma_p text default null) RETURNS bigint AS $body$
DECLARE


ie_use_average_w			varchar(1);
pr_previsto_w			double precision := 0;
qt_horas_projeto_w	double precision := 0;

c01 CURSOR FOR
SELECT	obter_prev_cron_proj(nr_sequencia, clock_timestamp()) pr_previsto,
	qt_total_horas qt_hora_prev
from	proj_cronograma
where	nr_seq_proj = nr_seq_projeto_p
and 	ie_situacao = 'A'
and 	(dt_aprovacao IS NOT NULL AND dt_aprovacao::text <> '')
and	ie_tipo_cronograma in (WITH RECURSIVE cte AS (

					SELECT	coalesce(trim(both regexp_substr(ie_tipo_cronograma_p,'[^,]+', 1, level)), ie_tipo_cronograma)
					
					(regexp_substr(ie_tipo_cronograma_p, '[^,]+', 1, level) IS NOT NULL AND (regexp_substr(ie_tipo_cronograma_p, '[^,]+', 1, level))::text <> '')
				  UNION ALL

					SELECT	coalesce(trim(both regexp_substr(ie_tipo_cronograma_p,'[^,]+', 1, level)), ie_tipo_cronograma) JOIN cte c ON ()

) SELECT * FROM cte;
);
BEGIN

select	CASE WHEN count(1)=1 THEN  'N'  ELSE 'S' END
into STRICT	ie_use_average_w
from	proj_cronograma
where	nr_seq_proj = nr_seq_projeto_p
and 	ie_situacao = 'A'
and 	(dt_aprovacao IS NOT NULL AND dt_aprovacao::text <> '')
and	ie_tipo_cronograma in (WITH RECURSIVE cte AS (

					SELECT	coalesce(trim(both regexp_substr(ie_tipo_cronograma_p,'[^,]+', 1, level)), ie_tipo_cronograma)
					
					(regexp_substr(ie_tipo_cronograma_p, '[^,]+', 1, level) IS NOT NULL AND (regexp_substr(ie_tipo_cronograma_p, '[^,]+', 1, level))::text <> '')
				  UNION ALL

					SELECT	coalesce(trim(both regexp_substr(ie_tipo_cronograma_p,'[^,]+', 1, level)), ie_tipo_cronograma) JOIN cte c ON ()

) SELECT * FROM cte;
);

if (ie_use_average_w = 'S') then
	begin
		select	proj_obter_qt_total_horas_cron(nr_seq_projeto_p, 0, 'T', ie_tipo_cronograma_p, 'S')
		into STRICT	qt_horas_projeto_w
		;
		
		if (qt_horas_projeto_w <> 0) then	
			for r_c01 in c01 loop
				-- Calculo da porcentagem previsto das atividades fase, devem considerar o peso das atividade filhas em relacao a ela, e nao simplesmente a quantidade de atividades filhas
				pr_previsto_w := pr_previsto_w +  ((r_c01.qt_hora_prev / qt_horas_projeto_w) * r_c01.pr_previsto);
			end loop;	
		end if;			
	end;
else
	select	max(obter_prev_cron_proj(nr_sequencia, clock_timestamp()))
	into STRICT	pr_previsto_w
	from (
			SELECT	max(nr_sequencia) nr_sequencia
			from	proj_cronograma
			where	nr_seq_proj = nr_seq_projeto_p
			and 	IE_SITUACAO = 'A'
			and 	(DT_APROVACAO IS NOT NULL AND DT_APROVACAO::text <> '')
		) alias5;
end if;

if (pr_previsto_w < 0) then
	pr_previsto_w := 0;
elsif (pr_previsto_w > 100) then
	pr_previsto_w := 100;
end if;

return pr_previsto_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_proj_atual_pr_previsto ( nr_seq_projeto_p bigint, ie_tipo_cronograma_p text default null) FROM PUBLIC;

