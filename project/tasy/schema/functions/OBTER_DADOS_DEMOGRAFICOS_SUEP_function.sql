-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_dados_demograficos_suep ( nr_atendimento_p bigint, cd_pessoa_fisica_p text, nr_seq_item_p bigint, ie_tipo_inf_p text) RETURNS varchar AS $body$
DECLARE


ds_return_w varchar(255) := null;


BEGIN

select CASE ie_tipo_inf_p
	WHEN 'ID'  THEN c.ds_dominio || ': ' || b.ID
	WHEN 'CPF' THEN c.ds_dominio || ': ' || b.CPF
	WHEN 'MRS' THEN c.ds_dominio || ': ' || b.MRS
	WHEN 'HMP' THEN c.ds_dominio || ': ' || b.HMP
	WHEN 'WKP' THEN c.ds_dominio || ': ' || b.WKP
	WHEN 'ADR' THEN c.ds_dominio || ': ' || b.ADR
	WHEN 'CTY' THEN c.ds_dominio || ': ' || b.CTY
	WHEN 'STA' THEN c.ds_dominio || ': ' || b.STA
	WHEN 'CTR' THEN c.ds_dominio || ': ' || b.CTR
	WHEN 'ZIP' THEN c.ds_dominio || ': ' || b.ZIP
	WHEN 'RAC' THEN c.ds_dominio || ': ' || b.RAC
	WHEN 'PFS' THEN c.ds_dominio || ': ' || b.PFS
	ELSE null
END as DS_INF

into STRICT ds_return_w

from (SELECT ie_tipo_inf from informacao_suep where nr_seq_item = nr_seq_item_p order by nr_seq_apres asc) a,
		(select     b.cd_pessoa_fisica as ID,
					b.nr_cpf as CPF,
					obter_valor_dominio(5,b.ie_estado_civil) as MRS,
					d.nr_telefone_celular as HMP,
					d.nr_telefone as WKP,
					substr(d.ds_endereco || ' ' || d.nr_endereco, 1, 255) as ADR,
					substr(d.ds_municipio, 1, 255) as CTY,
					substr(d.sg_estado, 1, 255) as STA,
					substr(obter_nome_pais(d.nr_seq_pais),1,255) as CTR,
					d.cd_cep as ZIP,
					substr(obter_desc_cor_pele(b.nr_seq_cor_pele),1,255) as RAC,
					substr(b.cd_cargo, 1, 255) as PFS

		from	pessoa_fisica b,
				compl_pessoa_fisica d

		where	b.cd_pessoa_fisica = cd_pessoa_fisica_p
		and		d.cd_pessoa_fisica = b.cd_pessoa_fisica
		and		d.ie_tipo_complemento = 1) b,

		(SELECT  vl_dominio, obter_desc_expressao(cd_exp_valor_dominio) as ds_dominio FROM valor_dominio_v WHERE  cd_dominio = 9791 AND ie_situacao = 'A') c

where	a.IE_TIPO_INF = ie_tipo_inf_p
and		c.vl_dominio = a.IE_TIPO_INF
and		ie_tipo_inf_p in (select f.IE_TIPO_INF as DS_INF from (select ie_tipo_inf from informacao_suep where nr_seq_item = nr_seq_item_p order by nr_seq_apres asc) f);

if ((nr_atendimento_p IS NOT NULL AND nr_atendimento_p::text <> '') and ie_tipo_inf_p = 'INS' or ie_tipo_inf_p = 'MDC') then
	select CASE ie_tipo_inf_p
		WHEN 'INS' THEN c.ds_dominio || ': ' || b.INS
		WHEN 'MDC' THEN c.ds_dominio || ': ' || b.MDC
		ELSE null
	END as DS_INF

	into STRICT ds_return_w

	from (SELECT ie_tipo_inf from informacao_suep where nr_seq_item = nr_seq_item_p order by nr_seq_apres asc) a,
			(select	substr(c.ds_convenio, 1, 255) as INS,
			substr(obter_nome_medico(a.CD_MEDICO_RESP, 'N'), 1, 255) as MDC

			from	atendimento_paciente a,
					convenio c

			where	a.nr_atendimento = nr_atendimento_p
			and		c.cd_convenio = Obter_Convenio_Atendimento(nr_atendimento_p)) b,
			(select vl_dominio, obter_desc_expressao(cd_exp_valor_dominio) as ds_dominio from valor_dominio_v where cd_dominio = 9791 and ie_situacao = 'A') c

	where	a.IE_TIPO_INF = ie_tipo_inf_p
	and		c.vl_dominio = a.IE_TIPO_INF
	and		ie_tipo_inf_p in (select e.IE_TIPO_INF as DS_INF from (select ie_tipo_inf from informacao_suep where nr_seq_item = nr_seq_item_p order by nr_seq_apres asc) e);

end if;

return ds_return_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_dados_demograficos_suep ( nr_atendimento_p bigint, cd_pessoa_fisica_p text, nr_seq_item_p bigint, ie_tipo_inf_p text) FROM PUBLIC;

