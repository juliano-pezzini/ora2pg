-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_intervalos_mov_musc ( cd_pessoa_fisica_p text, nr_seq_art_mov_musculo_p bigint, nr_seq_toxina_p bigint default 1) RETURNS varchar AS $body$
DECLARE


ds_retorno_w		varchar(2000);
qt_idade_w		integer;
qt_peso_w		double precision;
qt_dose_max_w		double precision;
qt_dose_min_w		double precision;
qt_pontos_max_w		double precision;
qt_pontos_min_w		double precision;
ds_dose_max_w		varchar(255);
ds_dose_min_w		varchar(255);
ds_pontos_max_w		varchar(255);
ds_pontos_min_w		varchar(255);


BEGIN

select	max(obter_idade(dt_nascimento,clock_timestamp(),'A'))
into STRICT	qt_idade_w
from	pessoa_fisica
where	cd_pessoa_fisica = cd_pessoa_fisica_p;

select	coalesce(max(qt_peso),0)
into STRICT	qt_peso_w
from	atendimento_sinal_vital
where	nr_sequencia = (SELECT	coalesce(max(nr_sequencia),-1)
			from	atendimento_sinal_vital
			where	(qt_peso IS NOT NULL AND qt_peso::text <> '')
			and	cd_paciente	= cd_pessoa_fisica_p
			and	ie_situacao = 'A'
			and	coalesce(IE_RN,'N')	= 'N');


select	coalesce(max(a.qt_pontos_min),0),
	coalesce(max(a.qt_pontos_max),0),
	coalesce(max(a.qt_dose_min),0),
	coalesce(max(a.qt_dose_max),0)
into STRICT	qt_pontos_min_w,
	qt_pontos_max_w,
	qt_dose_min_w,
	qt_dose_max_w
from 	artic_mov_musculo_regra a
where 	a.nr_seq_art_mov_musculo = nr_seq_art_mov_musculo_p
and	qt_idade_w between a.qt_idade_min and a.qt_idade_max
and 	qt_peso_w between coalesce(a.qt_peso_min,0) and coalesce(a.qt_peso_max,999)
and	coalesce(a.nr_seq_toxina,nr_seq_toxina_p) = nr_seq_toxina_p;

if (qt_dose_min_w = 0) then
	ds_dose_min_w := wheb_mensagem_pck.get_texto(308389) || ', '; -- Mín: não informado
else
	ds_dose_min_w := wheb_mensagem_pck.get_texto(308391) || ': '||qt_dose_min_w||', '; --  Mín
end if;

if (qt_dose_max_w = 0) then
	ds_dose_max_w := wheb_mensagem_pck.get_texto(308390) || '; '; -- Máx: não informado
else
	ds_dose_max_w := wheb_mensagem_pck.get_texto(308392) || ': '||qt_dose_max_w||'; '; -- Máx
end if;

if (qt_pontos_min_w = 0) then
	ds_pontos_min_w := wheb_mensagem_pck.get_texto(308389) || ', '; -- Mín: não informado
else
	ds_pontos_min_w := wheb_mensagem_pck.get_texto(308391) || ': '||qt_pontos_min_w||', '; -- Mín
end if;

if (qt_pontos_max_w = 0) then
	ds_pontos_max_w := wheb_mensagem_pck.get_texto(308390) || '; '; -- Máx: não informado
else
	ds_pontos_max_w := wheb_mensagem_pck.get_texto(308392) || ': '||qt_pontos_max_w||'; '; -- Máx
end if;

ds_retorno_w := wheb_mensagem_pck.get_texto(308393,	'DS_DOSE_MIN_W=' || ds_dose_min_w || ';' ||
													'DS_DOSE_MAX_W=' || ds_dose_max_w || ';' ||
													'DS_PONTOS_MIN_W=' || ds_pontos_min_w || ';' ||
													'DS_PONTOS_MAX_W=' || ds_pontos_max_w);
			/*
				Dose: 	#@DS_DOSE_MIN_W#@	#@DS_DOSE_MAX_W#@
				Pontos: 	#@DS_PONTOS_MIN_W#@	#@DS_PONTOS_MAX_W#@
			*/
return	ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_intervalos_mov_musc ( cd_pessoa_fisica_p text, nr_seq_art_mov_musculo_p bigint, nr_seq_toxina_p bigint default 1) FROM PUBLIC;

