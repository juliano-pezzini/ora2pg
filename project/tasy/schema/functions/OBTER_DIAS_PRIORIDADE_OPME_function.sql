-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_dias_prioridade_opme ( nr_seq_Agenda_p bigint, nr_sequencia_p bigint) RETURNS varchar AS $body$
DECLARE


qt_dias_w               bigint;
nr_sequencia_w          bigint;
qt_dias_minimo_w                smallint;
qt_dias_maximo_w                smallint;
ie_regra_w              varchar(80);
ie_prioridade_w         varchar(1);

C01 CURSOR FOR
        SELECT  nr_sequencia,
                qt_dias_minimo,
                qt_dias_maximo,
                ie_regra
        from    regra_prioridade_opme;

BEGIN

if (nr_seq_Agenda_p IS NOT NULL AND nr_seq_Agenda_p::text <> '') then
        select  obter_dias_entre_datas(clock_timestamp(),hr_inicio)
        into STRICT    qt_dias_w
        from    agenda_paciente
        where   nr_sequencia = nr_seq_agenda_p;
end if;

if (nr_sequencia_p IS NOT NULL AND nr_sequencia_p::text <> '') then
        select  max(obter_dias_entre_datas(clock_timestamp(), dt_atualizacao_nrec))
        into STRICT    qt_dias_w
        from    atend_pac_int_opme
        where   nr_sequencia = nr_sequencia_p;
end if;

open C01;
loop
fetch C01 into
        nr_sequencia_w,
        qt_dias_minimo_w,
        qt_dias_maximo_w,
        ie_regra_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
        begin
        if (qt_dias_minimo_w <= qt_dias_w) and (qt_dias_maximo_w >= qt_dias_w)and (ie_regra_w = 'U') then
                        ie_prioridade_w := 'U';
        elsif (qt_dias_minimo_w <= qt_dias_w) and (qt_dias_maximo_w >= qt_dias_w) and (ie_regra_w = 'M') then
                        ie_prioridade_w := 'M';
        elsif (qt_dias_minimo_w <= qt_dias_w) and (qt_dias_maximo_w >= qt_dias_w) and (ie_regra_w = 'N') then
                        ie_prioridade_w := 'N';
        end if;
        end;
end loop;
close C01;

if (qt_dias_w < 0) then
        ie_prioridade_w := 'X';
end if;

return  ie_prioridade_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_dias_prioridade_opme ( nr_seq_Agenda_p bigint, nr_sequencia_p bigint) FROM PUBLIC;

