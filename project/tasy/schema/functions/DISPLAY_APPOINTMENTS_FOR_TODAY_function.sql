-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION display_appointments_for_today ( cd_pessoa_fisica_p text ) RETURNS varchar AS $body$
DECLARE



  ds_mensagem_w		varchar(4000)	:= 'N';
  ds_mensagem_list		varchar(4000)	:= '';
  ds_curta_w agenda.ds_curta%type := null;

  allAppointments CURSOR FOR
    SELECT  v.*
    FROM    scheduling_check_today_appts_v v
    WHERE   v.cd_pessoa_fisica = cd_pessoa_fisica_p
    AND     ie_status_agenda IN ('A', 'C');


BEGIN
   
					ds_mensagem_w		:= Wheb_mensagem_pck.get_texto(1148079, 'TODAYS_DATE=' || TRUNC(clock_timestamp()));

           for x in allAppointments loop
            select DS_CURTA into STRICT ds_curta_w from agenda where cd_agenda = x.cd_agenda;
           	ds_mensagem_list	:= ds_mensagem_list || '-' || x.HR_AGENDA ||  '-' ||x.DS_TIPO_AGENDA  || '-' || coalesce(x.ds_agenda,ds_curta_w) || '-' || x.DS_STATUS ||chr(10)||chr(13);
          end loop;

         ds_mensagem_w  :=  substr(ds_mensagem_w || CHR(10)||CHR(13)||ds_mensagem_list, 1, 4000);

  return ds_mensagem_w;
  end;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION display_appointments_for_today ( cd_pessoa_fisica_p text ) FROM PUBLIC;

