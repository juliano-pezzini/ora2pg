-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_aprov_exame_regra ( nr_seq_exame_p bigint, cd_pessoa_fisica_p text, ds_campo_p text, qt_result_p bigint ) RETURNS varchar AS $body$
DECLARE


nr_prescricao_w		bigint;
nr_seq_prescr_w		bigint;
nr_seq_resultado_w	bigint;

pr_resultado_w		double precision;
qt_resultado_w		double precision;

pr_minimo_w		double precision;
pr_maximo_w		double precision;
ie_referencia_w		varchar(1);

vl_resultado_w		double precision;
vl_resultado_min_w	double precision;
vl_resultado_max_w	double precision;

ie_resultado_w		varchar(1) := 'N';

nr_seq_grupo_w		bigint;


BEGIN


ie_resultado_w	:= 'N';

if (cd_pessoa_fisica_p IS NOT NULL AND cd_pessoa_fisica_p::text <> '') and (nr_seq_exame_p IS NOT NULL AND nr_seq_exame_p::text <> '') then

	-- Busca dados da regra conforme Exame
	select	max(pr_minimo),
		max(pr_maximo),
		max(ie_referencia)
	into STRICT	pr_minimo_w,
		pr_maximo_w,
		ie_referencia_w
	from	lab_regra_aprovacao_exame
	where	nr_seq_exame	= nr_seq_exame_p;

	if	((coalesce(pr_minimo_w::text, '') = '') and (coalesce(pr_maximo_w::text, '') = '')) then

		select	max(nr_seq_grupo)
		into STRICT	nr_seq_grupo_w
		from	exame_laboratorio
		where	nr_seq_exame 	= nr_seq_exame_p;


		select	max(pr_minimo),
			max(pr_maximo),
			max(ie_referencia)
		into STRICT	pr_minimo_w,
			pr_maximo_w,
			ie_referencia_w
		from	lab_regra_aprovacao_exame
		where	nr_seq_grupo	= nr_seq_grupo_w;

	end if;


	if	(pr_minimo_w IS NOT NULL AND pr_minimo_w::text <> '' AND pr_maximo_w IS NOT NULL AND pr_maximo_w::text <> '') then

		--Busca a última prescrição do paciente que possua a o exame
		select	max(e.nr_prescricao)
		into STRICT	nr_prescricao_w
		from	prescr_procedimento e,
			(SELECT	nr_prescricao
			from	prescr_medica
			where	cd_pessoa_fisica	= cd_pessoa_fisica_p) p
		where	e.nr_prescricao = p.nr_prescricao
		and	e.nr_seq_exame	= nr_seq_exame_p;


		if (nr_prescricao_w IS NOT NULL AND nr_prescricao_w::text <> '') then

			select	max(nr_sequencia)
			into STRICT	nr_seq_prescr_w
			from	prescr_procedimento
			where	nr_prescricao 	= nr_prescricao_w
			and	nr_seq_exame	= nr_seq_exame_p;

			select	max(nr_seq_resultado)
			into STRICT	nr_seq_resultado_w
			from	exame_lab_resultado
			where	nr_prescricao	= nr_prescricao_w;

			if (nr_seq_resultado_w IS NOT NULL AND nr_seq_resultado_w::text <> '') then

				select	CASE WHEN ds_campo_p='pr_resultado' THEN  pr_resultado  ELSE qt_resultado END
				into STRICT	vl_resultado_w
				from	exame_lab_result_item
				where	nr_seq_exame 	 = nr_seq_exame_p
				and	nr_seq_resultado = nr_seq_resultado_w;


				select	(vl_resultado_w - ((vl_resultado_w)*(pr_minimo_w / 100))),
					(vl_resultado_w + ((vl_resultado_w)*(pr_maximo_w / 100)))
				into STRICT	vl_resultado_min_w,
					vl_resultado_max_w
				;


				if (qt_result_p >= vl_resultado_min_w) and (qt_result_p <= vl_resultado_max_w) then

					ie_resultado_w := 'S';

				end if;


			elsif (ie_referencia_w = 'S') then

				ie_resultado_w := 'S';

			end if;

		elsif (ie_referencia_w = 'S') then

			ie_resultado_w := 'S';

		end if;

	else

		ie_resultado_w := 'N';

	end if;

end if;

return	ie_resultado_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_aprov_exame_regra ( nr_seq_exame_p bigint, cd_pessoa_fisica_p text, ds_campo_p text, qt_result_p bigint ) FROM PUBLIC;

