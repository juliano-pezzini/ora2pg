-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION spa_obter_dados_nota_credito ( nr_titulo_receber_p bigint, ie_opcao_p text) RETURNS varchar AS $body$
DECLARE


/* ie_opcao_p

'NN'  Numero da nota de credito 		 	NR_SEQUENCIA
'LR'   Lote de recurso	   
'VN'  Valor da nota de credito			VL_NOTA_CREDITO
'SN'  Saldo da nota de credito			VL_SALDO
'DE'  Data de emissao da nota de credito		DT_NOTA_CREDITO
'PJ'  Pessoa juridica
*/
ds_retorno_w				varchar(255):= '';
nr_sequencia_w 				nota_credito.nr_sequencia%type;
nr_seq_lote_audit_w			nota_credito.nr_seq_lote_audit_hist%type;
vl_nota_credito_w			nota_credito.vl_nota_credito%type;
vl_saldo_w				nota_credito.vl_saldo%type;
dt_nota_credito_w			nota_credito.dt_nota_credito%type;
ds_razao_social_w			pessoa_juridica.ds_razao_social%type;


BEGIN
	begin
	select	a.nr_sequencia,
		to_number(coalesce(	(select	max(x.nr_seq_lote_audit)
				from	lote_audit_hist x
				where	x.nr_sequencia	= a.nr_seq_lote_audit_hist),
				(select	max(y.nr_seq_lote_audit)
				from	lote_audit_hist y,
					lote_audit_hist_guia x
				where	x.nr_sequencia		= a.nr_seq_lote_hist_guia
				and	x.nr_seq_lote_hist	= y.nr_sequencia))) nr_seq_lote_audit,
		a.vl_nota_credito,
		a.vl_saldo,
		a.dt_nota_credito,
		substr(obter_razao_social(a.cd_cgc),1,255) ds_razao_social
	into STRICT	nr_sequencia_w,
		nr_seq_lote_audit_w,
		vl_nota_credito_w,
		vl_saldo_w,
		dt_nota_credito_w,
		ds_razao_social_w
	from 	nota_credito a
	where 	a.nr_titulo_receber = nr_titulo_receber_p
	order by a.nr_sequencia desc LIMIT 1;
	exception
	when others then
		return ds_retorno_w;
	end;

/*'NN'  Numero da nota de credito*/

if (ie_opcao_p = 'NN') then
	ds_retorno_w := to_char(nr_sequencia_w);
/*'LR'   Lote de recurso*/

elsif (ie_opcao_p = 'LR') then
	ds_retorno_w := to_char(nr_seq_lote_audit_w);
/*'VN'  Valor da nota de credito*/

elsif (ie_opcao_p = 'VN') then
	ds_retorno_w := to_char(vl_nota_credito_w);
/*'SN'  Saldo da nota de credito*/

elsif (ie_opcao_p = 'SN') then
	ds_retorno_w := to_char(vl_saldo_w);
/*'DE'  Data de emissao da nota de credito*/

elsif (ie_opcao_p = 'DE') then
	ds_retorno_w := to_char(dt_nota_credito_w);
/*'PJ'  Pessoa juridica*/

elsif (ie_opcao_p = 'PJ') then
	ds_retorno_w := to_char(ds_razao_social_w);
end if;
	
return	ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION spa_obter_dados_nota_credito ( nr_titulo_receber_p bigint, ie_opcao_p text) FROM PUBLIC;

