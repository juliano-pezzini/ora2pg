-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION hsj_obter_valores_auditoria (nr_seq_item_p bigint, ie_valor_p text, ie_item_p text) RETURNS bigint AS $body$
DECLARE


vl_antes_auditoria_w	double precision;
vl_apos_auditoria_w	double precision;
qt_ajuste_item_w	double precision;
cd_item_w		bigint;
ie_origem_item_w	bigint;
nr_interno_conta_w	bigint;


BEGIN
if (ie_item_p = 'P') then
	Select	cd_procedimento,
		ie_origem_proced,
		nr_interno_conta
	into STRICT	cd_item_w,
		ie_origem_item_w,
		nr_interno_conta_w
	from	procedimento_paciente
	where	nr_sequencia = nr_seq_item_p;

	/* Busca a quantidade do item que foi ajustada pela auditoria */

	Select	coalesce(sum(qt_ajuste),0)
	into STRICT	qt_ajuste_item_w
	from	auditoria_propaci
	where	nr_seq_propaci = nr_seq_item_p;

	/*Busca o valorr antes e depois da auditoria da conta */

	Select	sum(vl_procedimento) - ((sum(vl_procedimento) / CASE WHEN sum(qt_procedimento)=0 THEN 1  ELSE sum(qt_procedimento) END  ) * (qt_ajuste_item_w)),
		sum(vl_procedimento)
	into STRICT	vl_antes_auditoria_w,
		vl_apos_auditoria_w
	from	procedimento_paciente
	where	(cd_procedimento)::numeric  = cd_item_w
	and	ie_origem_proced = ie_origem_item_w
	and	nr_interno_conta = nr_interno_conta_w
	and	coalesce(cd_motivo_exc_conta::text, '') = '';

else
	Select	cd_material,
		nr_interno_conta
	into STRICT	cd_item_w,
		nr_interno_conta_w
	from	material_atend_paciente
	where	nr_sequencia = nr_seq_item_p;

	/* Busca a quantidade do item que foi ajustada pela auditoria */

	Select	coalesce(sum(qt_ajuste),0)
	into STRICT	qt_ajuste_item_w
	from	auditoria_matpaci
	where	nr_seq_matpaci = nr_seq_item_p;

	/*Busca o valorr antes e depois da auditoria da conta */

	Select	sum(vl_material) - ((sum(vl_material) / CASE WHEN sum(qt_material)=0 THEN 1  ELSE sum(qt_material) END  ) * (qt_ajuste_item_w)),
		sum(vl_material)
	into STRICT	vl_antes_auditoria_w,
		vl_apos_auditoria_w
	from	material_atend_paciente
	where	(cd_material)::numeric  = cd_item_w
	and	nr_interno_conta = nr_interno_conta_w
	and	coalesce(cd_motivo_exc_conta::text, '') = '';
end if;

if (ie_valor_p = 'A') then
	Return	vl_antes_auditoria_w;
else
	Return	vl_apos_auditoria_w;
end if;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION hsj_obter_valores_auditoria (nr_seq_item_p bigint, ie_valor_p text, ie_item_p text) FROM PUBLIC;

