-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION sus_obter_cbo_proc_med_comp ( cd_procedimento_p bigint, ie_origem_proced_p bigint, cd_cbo_p text, dt_procedimento_p timestamp default clock_timestamp()) RETURNS varchar AS $body$
DECLARE

/* ********************************************************************
-> CBO DA FAMILIA 2232:

CASO O PROCEDIMENTO TENHA ALGUM CBO DA FAMILIA 2232
CADASTRADO NO SIGTAP, O SISTEMA ACEITARÁ QUALQUER CBO
DA FAMILIA 2232.


-> CBO DA FAMILIA 2231, 2251, 2252, 2253:

CASO O PROCEDIMENTO TENHA ALGUM CBO DA FAMILIA 2231,2251,
2252, 2253 CADASTRADO NO SIGTAP, O SISTEMA ACEITARÁ QUALQUER
CBO DA FAMILIA 2231,2251, 2252, 2253.


EXEMPLO:

	PROCEDIMENTO DE MÉDIA COMPLEXIDADE SÓ TEM CADASTRADO O
	CBO 2231F9, O SISTEMA ACEITARÁ QUALQUER CBO DA FAMILIA:
	2231, 2251, 2252, 2253.

	PROCEDIMENTO DE MÉDIA COMPLEXIDADE SÓ TEM CADASTRADO O
	CBO 223208, O SISTEMA ACEITARÁ QUALQUER CBO DA FAMILIA:
	2232.
******************************************************************** */
ds_retorno_w		varchar(15) := 'N';
ie_complexidade_w	sus_procedimento.ie_complexidade%type;
qt_cbo_comp_w		bigint := 0;
qt_porc_regra_w		bigint := 0;
qt_porc_bpaC_w		bigint := 0;
cd_cbo_w		varchar(6);


BEGIN

cd_cbo_w := substr(cd_cbo_p,1,4);

if (cd_cbo_w in ('2232','2231','2251','2252','2253')) then
	begin

	begin
	select	coalesce(ie_complexidade,'0')
	into STRICT	ie_complexidade_w
	from	sus_procedimento a
	where	a.cd_procedimento = cd_procedimento_p
	and	a.ie_origem_proced = ie_origem_proced_p
	and	sus_obter_se_detalhe_proc(a.cd_procedimento,a.ie_origem_proced,'10039',dt_procedimento_p) = 0  LIMIT 1;
	exception
	when others then
		ie_complexidade_w	:= '0';
	end;

	if (ie_complexidade_w = 'MC') then
		begin

		begin
		select	count(1)
		into STRICT	qt_porc_regra_w
		from	sus_procedimento_registro x
		where	x.cd_procedimento 	= cd_procedimento_p
		and	x.ie_origem_proced 	= ie_origem_proced_p
		and	x.cd_registro		in (3,4,5)  LIMIT 1;
		exception
		when others then
			qt_porc_regra_w := 0;
		end;

		if (qt_porc_regra_w > 0) then
			begin

			begin
			select	count(1)
			into STRICT 	qt_porc_bpaC_w
			from	sus_procedimento_registro x
			where	x.cd_procedimento 	= cd_procedimento_p
			and	x.ie_origem_proced 	= ie_origem_proced_p
			and	x.cd_registro		= 1  LIMIT 1;
				exception
			when others then
				qt_porc_bpaC_w	:= 0;
			end;

			if (qt_porc_bpaC_w = 0) then
				begin

				select 	count(1)
				into STRICT	qt_cbo_comp_w
				from	sus_procedimento_cbo x
				where 	x.cd_procedimento = cd_procedimento_p
				and	x.ie_origem_proced = ie_origem_proced_p
				and 	(((cd_cbo_w = '2232') and (substr(x.cd_cbo,1,4) = '2232')) or (substr(x.cd_cbo,1,4) in ('2231','2251','2252','2253')))  LIMIT 1;

				if (qt_cbo_comp_w > 0) then
					ds_retorno_w := 'S';
				end if;

				end;
			end if;

			end;
		end if;

		end;
	end if;

	end;
end if;

return	ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION sus_obter_cbo_proc_med_comp ( cd_procedimento_p bigint, ie_origem_proced_p bigint, cd_cbo_p text, dt_procedimento_p timestamp default clock_timestamp()) FROM PUBLIC;

