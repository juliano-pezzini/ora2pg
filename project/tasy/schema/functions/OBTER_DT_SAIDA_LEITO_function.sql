-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_dt_saida_leito ( nr_sequencia_p bigint, cd_setor_desejado_p bigint, dt_prevista_p timestamp, qt_dia_p bigint, nr_seq_interno_p bigint) RETURNS timestamp AS $body$
DECLARE

 
cd_unidade_compl_w	varchar(10);
cd_unidade_basica_w	varchar(10);
dt_saida_w		timestamp;


BEGIN 
 
select	cd_unidade_basica, 
	cd_unidade_compl 
into STRICT	cd_unidade_basica_w, 
	cd_unidade_compl_w 
from	unidade_atendimento 
where	nr_seq_interno = nr_seq_interno_p;
 
select	max(coalesce(obter_data_entrada(nr_atendimento),dt_prevista) + coalesce(qt_dia,0) + (coalesce(qt_horas,0)/24)) 
into STRICT	dt_saida_w 
from	gestao_vaga 
where	cd_setor_desejado	= cd_setor_desejado_p 
and	cd_unidade_basica	= cd_unidade_basica_w 
and	cd_unidade_compl	= cd_unidade_compl_w 
and	nr_sequencia		<> nr_sequencia_p 
and	ie_status 		not in ('N','D','C') 
and	(((trunc(dt_prevista_p)			between trunc(dt_prevista) and trunc(dt_prevista + qt_dia-1)) or (trunc(dt_prevista_p + qt_dia_p-1)	between trunc(dt_prevista) and trunc(dt_prevista + qt_dia-1))) or 
	(dt_prevista_p				between dt_prevista and dt_prevista + (qt_horas + 1/24)));
	  
 
return	dt_saida_w;
	 
end	;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_dt_saida_leito ( nr_sequencia_p bigint, cd_setor_desejado_p bigint, dt_prevista_p timestamp, qt_dia_p bigint, nr_seq_interno_p bigint) FROM PUBLIC;

