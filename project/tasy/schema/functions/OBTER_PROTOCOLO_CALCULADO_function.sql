-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_protocolo_calculado ( nr_seq_protocolo_p bigint, ie_opcao_p text) RETURNS varchar AS $body$
DECLARE


vl_procedimento_w	varchar(20);


BEGIN

if (coalesce(nr_seq_protocolo_p,0) > 0) then

	select	replace(replace(replace(replace(to_char(coalesce(sum(vl_procedimento),0),'999,999,999,990.99'), ',', 'X'),'.', ','), 'X', '.'),' ','') vl_procedimento
	into STRICT	vl_procedimento_w
	from (SELECT	coalesce(sum(c.vl_procedimento),0) vl_procedimento,
			a.nr_sequencia
		from	pls_protocolo_conta	a,
			pls_conta		b,
			pls_conta_proc		c
		where	a.nr_sequencia	= b.nr_seq_protocolo
		and	b.nr_sequencia	= c.nr_seq_conta
		and	a.nr_sequencia	= nr_seq_protocolo_p
		and	'VP'		= ie_opcao_p
		and	a.ie_situacao not in ('I', 'RE', 'A')
		and	coalesce(a.ie_tipo_protocolo,'C') in ('C','I')
		group by	a.nr_sequencia
		
union

		SELECT	coalesce(sum(c.vl_material),0),
			a.nr_sequencia
		from	pls_protocolo_conta	a,
			pls_conta		b,
			pls_conta_mat		c
		where	a.nr_sequencia	= b.nr_seq_protocolo
		and	b.nr_sequencia	= c.nr_seq_conta
		and	a.nr_sequencia	= nr_seq_protocolo_p
		and	'VP'		= ie_opcao_p
		and	a.ie_situacao not in ('I', 'RE', 'A')
		and	coalesce(a.ie_tipo_protocolo,'C') in ('C','I')
		group by a.nr_sequencia
		
union

		select	coalesce(sum(c.vl_glosa),0) vl_procedimento,
			a.nr_sequencia
		from	pls_protocolo_conta	a,
			pls_conta		b,
			pls_conta_proc		c
		where	a.nr_sequencia	= b.nr_seq_protocolo
		and	b.nr_sequencia	= c.nr_seq_conta
		and	a.nr_sequencia	= nr_seq_protocolo_p
		and	'VG'		= ie_opcao_p
		and	a.ie_situacao not in ('I', 'RE', 'A')
		and	coalesce(a.ie_tipo_protocolo,'C') in ('C','I')
		group by a.nr_sequencia
		
union

		select	coalesce(sum(c.vl_glosa),0),
			a.nr_sequencia
		from	pls_protocolo_conta	a,
			pls_conta		b,
			pls_conta_mat		c
		where	a.nr_sequencia	= b.nr_seq_protocolo
		and	b.nr_sequencia	= c.nr_seq_conta
		and	a.nr_sequencia	= nr_seq_protocolo_p
		and	'VG'		= ie_opcao_p
		and	a.ie_situacao not in ('I', 'RE', 'A')
		and	coalesce(a.ie_tipo_protocolo,'C') in ('C','I')
		group by a.nr_sequencia
		
union

		select	coalesce(sum(c.vl_procedimento_imp),0) vl_procedimento,
			a.nr_sequencia
		from	pls_protocolo_conta	a,
			pls_conta		b,
			pls_conta_proc		c
		where	a.nr_sequencia	= b.nr_seq_protocolo
		and	b.nr_sequencia	= c.nr_seq_conta
		and	a.nr_sequencia	= nr_seq_protocolo_p
		and	'VA'		= ie_opcao_p
		and	a.ie_situacao not in ('I', 'RE', 'A')
		and	coalesce(a.ie_tipo_protocolo,'C') in ('C','I')
		group by a.nr_sequencia
		
union

		select	coalesce(sum(c.vl_material_imp),0),
			a.nr_sequencia
		from	pls_protocolo_conta	a,
			pls_conta		b,
			pls_conta_mat		c
		where	a.nr_sequencia	= b.nr_seq_protocolo
		and	b.nr_sequencia	= c.nr_seq_conta
		and	a.nr_sequencia	= nr_seq_protocolo_p
		and	'VA'		= ie_opcao_p
		and	a.ie_situacao not in ('I', 'RE', 'A')
		and	coalesce(a.ie_tipo_protocolo,'C') in ('C','I')
		group by a.nr_sequencia) alias39;

end if;

return	vl_procedimento_w;


end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_protocolo_calculado ( nr_seq_protocolo_p bigint, ie_opcao_p text) FROM PUBLIC;

