-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';



CREATE TYPE registro_titular AS (nr_seq_titular_w bigint, ie_linha_w bigint);


CREATE OR REPLACE FUNCTION pls_sequencia_benef_emissao ( nr_seq_lote_p bigint, nr_seq_titular_p bigint) RETURNS bigint AS $body$
DECLARE


nr_seq_segurado_w	bigint;
ie_linha_reg_w		bigint;
nr_vetor_w		bigint;
nr_sequencial_w		bigint;
type vetor is table of registro_titular index by integer;
vetor_w				vetor;

C01 CURSOR FOR
	SELECT	CASE WHEN coalesce(nr_seq_titular::text, '') = '' THEN nr_seq_segurado  ELSE nr_seq_titular END ,
		row_number() OVER () AS rownum
	from	pls_carteira_emissao_corresp_v
	where	nr_seq_lote	= nr_seq_lote_p;

BEGIN

open C01;
loop
fetch C01 into
	nr_seq_segurado_w,
	ie_linha_reg_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin

	nr_vetor_w	:= vetor_w.count+1;
	vetor_w[nr_vetor_w].nr_seq_titular_w	:= nr_seq_segurado_w;
	vetor_w[nr_vetor_w].ie_linha_w		:= ie_linha_reg_w;

	end;
end loop;
close C01;

for i in 1..vetor_w.count loop
	if (vetor_w[i].nr_seq_titular_w = nr_seq_titular_p) then
		nr_sequencial_w	:= vetor_w[i].ie_linha_w;
	end if;
end loop;

return	nr_sequencial_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION pls_sequencia_benef_emissao ( nr_seq_lote_p bigint, nr_seq_titular_p bigint) FROM PUBLIC;

