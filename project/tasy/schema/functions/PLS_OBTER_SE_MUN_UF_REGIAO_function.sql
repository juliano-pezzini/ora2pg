-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION pls_obter_se_mun_uf_regiao ( cd_municipio_ibge_p sus_municipio.cd_municipio_ibge%type, sg_estado_p text, nr_seq_regiao_p pls_regiao.nr_sequencia%type) RETURNS varchar AS $body$
DECLARE


ie_retorno_w                    varchar(1);
qt_registro_w                   integer;
ie_abrange_nac_w                pls_regiao.ie_abrange_nac%type;


BEGIN

ie_retorno_w    := 'N';
/*Se a região não for nula*/

if (nr_seq_regiao_p IS NOT NULL AND nr_seq_regiao_p::text <> '')	then

	select  max(ie_abrange_nac)
        into STRICT    ie_abrange_nac_w
        from    pls_regiao
        where   nr_sequencia = nr_seq_regiao_p;

        /*Se a região não abrenge território nacional */

        if (ie_abrange_nac_w = 'N' or coalesce(ie_abrange_nac_w::text, '') = '') then
                if (cd_municipio_ibge_p IS NOT NULL AND cd_municipio_ibge_p::text <> '') then
			/*verifica se o municipio informado está dentro da região*/

			select  count(1)
                        into STRICT    qt_registro_w
                        from    pls_regiao_local a
                        where   a.nr_seq_regiao         = nr_seq_regiao_p
                        and     a.cd_municipio_ibge     = cd_municipio_ibge_p;

                        if (qt_registro_w > 0) then
                                ie_retorno_w    := 'S';
                        end if;
	end if;
                if (sg_estado_p IS NOT NULL AND sg_estado_p::text <> '') then
                        /*verifica se o estado informado está dentro da região*/

			select  count(1)
                        into STRICT    qt_registro_w
                        from    pls_regiao_local a
                        where   a.nr_seq_regiao         = nr_seq_regiao_p
                        and     a.sg_uf_municipio       = sg_estado_p;

                        if (qt_registro_w > 0) then
                                ie_retorno_w    := 'S';
                        end if;
                end if;
        else    /*Se a região abrangir nacionalmente retorna 'S'*/
		ie_retorno_w := 'S';
        end if;
end if;

return  ie_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION pls_obter_se_mun_uf_regiao ( cd_municipio_ibge_p sus_municipio.cd_municipio_ibge%type, sg_estado_p text, nr_seq_regiao_p pls_regiao.nr_sequencia%type) FROM PUBLIC;

