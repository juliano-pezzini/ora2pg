-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_se_perg_prev_alta ( nr_atendimento_p bigint, cd_medico_p text, cd_estabelecimento_p bigint, nm_usuario_p text) RETURNS varchar AS $body$
DECLARE
			
 
dt_alta_prevista_w	timestamp;
dt_alta_w		timestamp;
cd_medico_resp_w	varchar(15);
ds_parametro_w		varchar(15) := 'N';
ds_retorno_w		varchar(15);


BEGIN 
 
ds_parametro_w := obter_param_usuario(281, 358, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ds_parametro_w);
 
if (ds_parametro_w = 'E') then 
	select	coalesce(max('N'),'S') 
	into STRICT	ds_retorno_w 
	from	atend_previsao_alta 
	where	nr_atendimento = nr_atendimento_p 
	and	(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '') 
	and	(dt_previsto_alta IS NOT NULL AND dt_previsto_alta::text <> '') 
	and	trunc(dt_previsto_alta,'dd') >= trunc(clock_timestamp(),'dd') 
	and	obter_se_especialidade_medico(cd_medico_p,cd_especialidade) = 'S';
	 
	return	ds_retorno_w;
else 
	select	dt_previsto_alta, 	 
		dt_alta, 	 
		cd_medico_resp 
	into STRICT	dt_alta_prevista_w,	 
		dt_alta_w,	 
		cd_medico_resp_w 
	from	atendimento_paciente 
	WHERE  nr_atendimento = nr_atendimento_p;
 
	if (ds_parametro_w <> 'N') and 
		((ds_parametro_w in ('AN','TN')) or ((coalesce(dt_alta_prevista_w::text, '') = '') or (trunc(dt_alta_prevista_w, 'dd') < trunc(clock_timestamp(), 'dd')))) and (coalesce(dt_alta_w::text, '') = '') and 
		((ds_parametro_w in ('T','TN')) or (ds_parametro_w in ('A','AN') and cd_medico_resp_w = cd_medico_p)) then 
		return	'S';
	else 
		return	'N';
	end if;
end if;
 
end	;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_se_perg_prev_alta ( nr_atendimento_p bigint, cd_medico_p text, cd_estabelecimento_p bigint, nm_usuario_p text) FROM PUBLIC;

