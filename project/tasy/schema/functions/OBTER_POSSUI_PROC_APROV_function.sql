-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_possui_proc_aprov (nr_cot_compra_p bigint) RETURNS varchar AS $body$
DECLARE


ds_retorno_w		varchar(1) := 'N';
cd_processo_aprov_w	processo_aprov_estrut.cd_processo_aprov%type;
nr_seq_aprovacao_w	cot_compra_item.nr_seq_aprovacao%type;
cd_material_w		cot_compra_item.cd_material%type;
nr_item_cot_compra_w	cot_compra_item.nr_item_cot_compra%type;
nr_seq_cot_forn_w	cot_compra_resumo.nr_seq_cot_forn%type;
cd_centro_custo_w	solic_compra.cd_centro_custo%type;
cd_local_estoque_w	solic_compra.cd_local_estoque%type;
ie_urgente_w		solic_compra.ie_urgente%type;
cd_conta_contabil_w	solic_compra.cd_conta_contabil%type;
cd_cgc_fornecedor_w	cot_compra_forn.cd_cgc_fornecedor%type;
cd_pessoa_fisica_w	cot_compra_forn.cd_pessoa_fisica%type;
cd_estabelecimento_w	cot_compra.cd_estabelecimento%type;
cd_perfil_ativo_w	perfil.cd_perfil%type;
nr_seq_proj_rec_w	cot_compra_item.nr_seq_proj_rec%type;

c01 CURSOR FOR
SELECT	a.nr_seq_aprovacao,
	a.cd_material,
	a.nr_item_cot_compra,
	a.nr_seq_proj_rec,
	b.nr_seq_cot_forn,
	substr(obter_dados_solic_item_cot(a.nr_cot_compra, a.nr_item_cot_compra, 'C'),1,10) cd_centro_custo,
	substr(obter_dados_solic_item_cot(a.nr_cot_compra, a.nr_item_cot_compra, 'L'),1,10) cd_local_estoque,
	substr(obter_dados_solic_item_cot(a.nr_cot_compra, a.nr_item_cot_compra, 'U'),1,1) ie_urgente,
	substr(obter_dados_solic_item_cot(a.nr_cot_compra, a.nr_item_cot_compra, 'CC'),1,20) cd_conta_contabil
from 	cot_compra_item a,
	cot_compra_resumo b,
	estrutura_material_v e
where	a.nr_cot_compra = b.nr_cot_compra
and	a.nr_item_cot_compra = b.nr_item_cot_compra
and	a.cd_material = e.cd_material
and 	coalesce(a.dt_aprovacao::text, '') = ''
and	a.nr_cot_compra = nr_cot_compra_p
order by e.cd_grupo_material,
	e.cd_subgrupo_material,
	e.cd_classe_material,
	e.cd_material;


BEGIN

select	cd_estabelecimento,
	obter_perfil_ativo
into STRICT	cd_estabelecimento_w,
	cd_perfil_ativo_w
from	cot_compra
where	nr_cot_compra = nr_cot_compra_p;

open c01;
loop
fetch c01 into	
	nr_seq_aprovacao_w,
	cd_material_w,
	nr_item_cot_compra_w,
	nr_seq_proj_rec_w,
	nr_seq_cot_forn_w,
	cd_centro_custo_w,
	cd_local_estoque_w,
	ie_urgente_w,
	cd_conta_contabil_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	begin
	
	if (coalesce(nr_seq_aprovacao_w::text, '') = '') then
			
		if (coalesce(cd_centro_custo_w::text, '') = '') then
			select	coalesce(max(cd_centro_custo),null)
			into STRICT	cd_centro_custo_w
			from	local_estoque
			where	cd_estabelecimento	= cd_estabelecimento_w
			and	cd_local_estoque		= cd_local_estoque_w;
			
		end if;

		select	cd_cgc_fornecedor,
			cd_pessoa_fisica
		into STRICT	cd_cgc_fornecedor_w,
			cd_pessoa_fisica_w
		from	cot_compra_forn
		where	nr_cot_compra = nr_cot_compra_p
		and	nr_sequencia = nr_seq_cot_forn_w;

		if (cd_cgc_fornecedor_w IS NOT NULL AND cd_cgc_fornecedor_w::text <> '') then
			cd_pessoa_fisica_w	:= null;
		end if;
	
		cd_processo_aprov_w := obter_processo_aprovacao(
			cd_material_w, cd_centro_custo_w, null, cd_local_estoque_w, null,  -- cd_local_estoque_destino_p - usado somente na requisicao
			null,  -- cd_operacao_estoque_p - usado somente na requisicao
			cd_conta_contabil_w, cd_cgc_fornecedor_w, cd_pessoa_fisica_w, 'C', ie_urgente_w, cd_estabelecimento_w, cd_perfil_ativo_w, nr_seq_proj_rec_w, nr_cot_compra_p, cd_processo_aprov_w);	
		
		if (coalesce(cd_processo_aprov_w,0) > 0) then
			ds_retorno_w := 'S';
		end if;
	
	end if;
	end;
end loop;
close c01;

return	ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_possui_proc_aprov (nr_cot_compra_p bigint) FROM PUBLIC;

