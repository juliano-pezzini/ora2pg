-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION lab_obter_result_ant_seq ( nr_prescricao_p bigint, nr_seq_exame_p bigint, ie_opcao_p text, nr_seq_anterior_p bigint) RETURNS varchar AS $body$
DECLARE


cd_pessoa_fisica_w		varchar(20);
cd_estabelecimento_w		bigint;
ie_recem_nato_w			varchar(1);

nr_seq_anterior_w	bigint;
nr_prescricao_w		varchar(20);
dt_aprovacao_w		timestamp;
ds_resultado_w		varchar(2000);
ds_unidade_medida_w	varchar(40);

ds_retorno_w		varchar(2000);

c01 CURSOR FOR
SELECT 	row_number() OVER () AS nr_seq_anterior,
	a.*
from ( select	to_char(a.nr_prescricao) nr_prescricao,
		obter_data_aprov_lab(b.nr_prescricao,c.nr_seq_prescr) dt_aprovacao,
		substr(coalesce(coalesce(CASE WHEN c.ds_resultado='0' THEN ''  ELSE CASE WHEN d.ie_formato_resultado='V' THEN ''  ELSE c.ds_resultado END  END ,	coalesce(to_char(c.qt_resultado),to_char(CASE WHEN c.pr_resultado=0 THEN ''  ELSE c.pr_resultado END ))),c.ds_resultado),1,100) ds_resultado,
		substr(obter_lab_unid_med(c.nr_seq_unid_med,'D'),1,40)
	from	exame_laboratorio d,
		exame_lab_result_item c,
		exame_lab_resultado b,
		prescr_medica a
	where	b.nr_seq_resultado	= c.nr_seq_resultado
	and	d.nr_seq_exame 		= c.nr_seq_exame
	and	b.nr_prescricao		= a.nr_prescricao
	and 	a.nr_prescricao 	< nr_prescricao_p
	and	a.cd_pessoa_fisica	= cd_pessoa_fisica_w
	and 	c.nr_seq_exame		= nr_seq_exame_p
	and	coalesce(a.ie_recem_nato,'N') = ie_recem_nato_w
	and	(obter_data_aprov_lab(b.nr_prescricao,c.nr_seq_prescr) IS NOT NULL AND (obter_data_aprov_lab(b.nr_prescricao,c.nr_seq_prescr))::text <> '')
	order by dt_aprovacao desc) a;


BEGIN

select	cd_pessoa_fisica,
	cd_estabelecimento,
	coalesce(ie_recem_nato,'N')
into STRICT	cd_pessoa_fisica_w,
	cd_estabelecimento_w,
	ie_recem_nato_w
from	prescr_medica
where	nr_prescricao = nr_prescricao_p;

open c01;
loop
	fetch c01 into	nr_seq_anterior_w,
			nr_prescricao_w,
			dt_aprovacao_w,
			ds_resultado_w,
			ds_unidade_medida_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */

	if (nr_seq_anterior_w = nr_seq_anterior_p) then

		if (ie_opcao_p = 'R') then
			ds_retorno_w := ds_resultado_w;
		elsif (ie_opcao_p = 'D') then
			ds_retorno_w := to_char(dt_aprovacao_w,'dd/mm/yyyy');
		elsif (ie_opcao_p = 'H') then
			ds_retorno_w := to_char(dt_aprovacao_w,'hh24:mi');
		elsif (ie_opcao_p = 'P') then
			ds_retorno_w := nr_prescricao_w;
		elsif (ie_opcao_p = 'DH') then
			ds_retorno_w := to_char(dt_aprovacao_w,'dd/mm/yyyy')||to_char(dt_aprovacao_w,'hh24:mi');
		elsif (ie_opcao_p = 'RM') then
			ds_retorno_w := ds_resultado_w||' '||ds_unidade_medida_w;
		end if;

	end if;

end loop;
close c01;

return ds_retorno_w;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION lab_obter_result_ant_seq ( nr_prescricao_p bigint, nr_seq_exame_p bigint, ie_opcao_p text, nr_seq_anterior_p bigint) FROM PUBLIC;

