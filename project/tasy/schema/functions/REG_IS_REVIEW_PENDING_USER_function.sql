-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION reg_is_review_pending_user ( nr_seq_revision_p bigint, nm_usuario_p text ) RETURNS varchar AS $body$
DECLARE


nr_seq_rev_control_w			reg_version_approvers.nr_seq_rev_control%type;
nm_author_w				reg_doc_revisor.nm_usuario_revisor%type;
ie_review_pending_w			varchar(1);


BEGIN

select	reg_fetch_revision_author(nr_seq_revision_p)
into STRICT	nm_author_w
;

select	CASE WHEN count(1)=0 THEN  'N'  ELSE 'S' END
into STRICT	ie_review_pending_w
from	reg_version_revision
where	nr_sequencia = nr_seq_revision_p
and	ie_status_revisao in ('U', 'A')
and (nm_author_w = nm_usuario_p or reg_doc_has_user_delegation(nr_seq_documento, 'C', nm_author_w, nm_usuario_p) = 'S');

if (ie_review_pending_w = 'N') then

	select	max(nr_sequencia)
	into STRICT	nr_seq_rev_control_w
	from	reg_revision_control
	where	nr_seq_revisao = nr_seq_revision_p;

	select	CASE WHEN count(1)=0 THEN  'N'  ELSE 'S' END
	into STRICT	ie_review_pending_w
	from	reg_version_revision vr,
		reg_version_approvers va
	where	vr.nr_sequencia = va.nr_seq_revision
	and	vr.nr_sequencia = nr_seq_revision_p
	and (va.nm_approver = nm_usuario_p or reg_doc_has_user_delegation(vr.nr_seq_documento, va.ie_approver_type, va.nm_approver, nm_usuario_p) = 'S')
	and	va.nr_seq_rev_control = nr_seq_rev_control_w
	and	(
			(va.ie_approver_type = 'R' and (
								(vr.ie_status_revisao = 'R' and coalesce(va.ie_aceito::text, '') = '') or (vr.ie_status_revisao = 'S' and coalesce(va.dt_approved::text, '') = '')
							)
			) or (va.ie_approver_type = 'A' and vr.ie_status_revisao = 'P' and coalesce(va.ie_aceito::text, '') = '')
		);

end if;

return ie_review_pending_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION reg_is_review_pending_user ( nr_seq_revision_p bigint, nm_usuario_p text ) FROM PUBLIC;

