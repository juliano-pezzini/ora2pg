-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_se_cc_lib_solic_compra ( cd_centro_custo_p bigint, nm_usuario_p text) RETURNS varchar AS $body$
DECLARE


cd_centro_custo_usuario_w	bigint;
cd_setor_usuario_w		bigint;
ie_param_22_w			varchar(15);
ie_liberado_w			varchar(1) := 'S';
ie_restringe_consulta_w		varchar(1);
ie_cc_setor_w			varchar(1);
cd_estabelecimento_w		bigint;
qt_registros_w			bigint;


BEGIN

select	wheb_usuario_pck.get_cd_estabelecimento
into STRICT	cd_estabelecimento_w
;

select	coalesce(max(obter_valor_param_usuario(913, 22,  obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w)),'N'),
	coalesce(max(obter_valor_param_usuario(913, 244, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w)),'N')
into STRICT	ie_param_22_w,
	ie_restringe_consulta_w
;

if (ie_restringe_consulta_w = 'N') then
	ie_liberado_w	:= 'S';

elsif (ie_param_22_w = 'N') then
	ie_liberado_w	:= 'S';

elsif (ie_param_22_w = 'T') then

	--T - C.Custo setores liberados ao usuário + C.Custo Cad.Usuário
	select	count(*)
	into STRICT	qt_registros_w
	from	setor_atendimento b,
		usuario_setor a
	where	a.cd_setor_atendimento = b.cd_setor_atendimento
	and	a.nm_usuario_param = nm_usuario_p
	and	b.cd_centro_custo = cd_centro_custo_p;

	if (qt_registros_w = 0) then
		ie_liberado_w := 'N';

		select	cd_setor_atendimento
		into STRICT	cd_setor_usuario_w
		from	usuario
		where	nm_usuario = nm_usuario_p;

		if (cd_setor_usuario_w > 0) then

			select	cd_centro_custo
			into STRICT	cd_centro_custo_usuario_w
			from	setor_atendimento
			where	cd_setor_atendimento = cd_setor_usuario_w;

			if (cd_centro_custo_usuario_w = cd_centro_custo_p) then
				ie_liberado_w := 'S';
			end if;
		end if;

	else
		ie_liberado_w := 'S';
	end if;

elsif (ie_param_22_w in ('S','O')) then

	--C.Custo setores liberados ao usuário (Usuário X Setor)
	select	count(*)
	into STRICT	qt_registros_w
	from	setor_atendimento b,
		usuario_setor a
	where	a.cd_setor_atendimento = b.cd_setor_atendimento
	and	a.nm_usuario_param = nm_usuario_p
	and	b.cd_centro_custo = cd_centro_custo_p;

	if (qt_registros_w = 0) then
		ie_liberado_w := 'N';
	else
		ie_liberado_w := 'S';
	end if;

elsif (ie_param_22_w = 'C') then

	--C.Custo setores liberados ao usuário (Usuário X Setor) +  Centro custo adicional (Regra)
	select	count(*)
	into STRICT	qt_registros_w
	from	setor_atendimento b,
		usuario_setor a
	where	a.cd_setor_atendimento = b.cd_setor_atendimento
	and	a.nm_usuario_param = nm_usuario_p
	and	b.cd_centro_custo = cd_centro_custo_p;

	if (qt_registros_w = 0) then
		ie_liberado_w := 'N';

		select	cd_setor_atendimento
		into STRICT	cd_setor_usuario_w
		from	usuario
		where	nm_usuario = nm_usuario_p;

		if (cd_setor_usuario_w > 0) then

			select	obter_se_ccusto_setor(cd_setor_usuario_w, cd_centro_custo_p, 2)
			into STRICT	ie_liberado_w
			;

		end if;

	else
		ie_liberado_w := 'S';
	end if;

elsif (ie_param_22_w = 'A') then

	--Centro custo do usuário (Cadastro) + Centro custo adicional (Regra)
	select	cd_setor_atendimento
	into STRICT	cd_setor_usuario_w
	from	usuario
	where	nm_usuario = nm_usuario_p;

	select	coalesce(obter_se_ccusto_setor(cd_setor_usuario_w, cd_centro_custo_p, 2),'S')
	into STRICT	ie_liberado_w
	;

elsif (ie_param_22_w = 'U') then

	--Centro de custo do usuário (Cadastro)
	ie_liberado_w := 'N';

	select	cd_setor_atendimento
	into STRICT	cd_setor_usuario_w
	from	usuario
	where	nm_usuario = nm_usuario_p;

	if (cd_setor_usuario_w > 0) then

		select	cd_centro_custo
		into STRICT	cd_centro_custo_usuario_w
		from	setor_atendimento
		where	cd_setor_atendimento = cd_setor_usuario_w;

		if (cd_centro_custo_usuario_w = cd_centro_custo_p) then
			ie_liberado_w := 'S';
		end if;
	end if;
end if;

return	ie_liberado_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_se_cc_lib_solic_compra ( cd_centro_custo_p bigint, nm_usuario_p text) FROM PUBLIC;

