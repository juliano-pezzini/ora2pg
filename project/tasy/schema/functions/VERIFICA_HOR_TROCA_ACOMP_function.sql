-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION verifica_hor_troca_acomp ( cd_setor_atendimento_p bigint, nr_atendimento_p bigint, dt_entrada_p timestamp, nr_tipo_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint ) RETURNS varchar AS $body$
DECLARE

			 
ds_retorno_w 			varchar(1)  := 'S';
cd_tipo_acomodacao_w		atend_categoria_convenio.cd_tipo_acomodacao%TYPE;
cd_convenio_w			bigint;	
qt_regra_w			bigint 	:= 0;
ie_forma_tipo_acomod_w		varchar(1);		
cd_perfil_w  			bigint;
				

BEGIN 
	 
	select 	Obter_Convenio_Atendimento(nr_atendimento_p)			 
	into STRICT 	cd_convenio_w			 
	;
	 
	ie_forma_tipo_acomod_w := Obter_Param_Usuario(8014, 117, obter_perfil_ativo, wheb_usuario_pck.get_nm_usuario, wheb_usuario_pck.get_cd_estabelecimento, ie_forma_tipo_acomod_w);
	 
	cd_perfil_w := wheb_usuario_pck.get_cd_perfil;
	 
	if (ie_forma_tipo_acomod_w = 'C') then 
		select	coalesce(max(cd_tipo_acomodacao),0) 
		into STRICT	cd_tipo_acomodacao_w 
		from	atend_categoria_convenio a 
		where	a.nr_atendimento	= nr_atendimento_p 
		and	a.dt_inicio_vigencia	= (SELECT max(dt_inicio_vigencia) 
						  from		atend_categoria_convenio b 
						  where	nr_atendimento	= nr_atendimento_p);
	else 
		select	coalesce(max(cd_tipo_acomodacao),0) 
		into STRICT	cd_tipo_acomodacao_w 
		from	atend_paciente_unidade 
		where	nr_seq_interno = obter_atepacu_paciente(nr_atendimento_p,'A');
	end if;
 
	select 	count(*) 
	into STRICT 	qt_regra_w 
	from 	setor_atend_hor_acomp 
	where 	cd_setor_atendimento 	= cd_setor_atendimento_p;		
 
if (qt_regra_w	> 0) then 
		 
	select count(*) 
	into STRICT qt_regra_w 
	from setor_atend_hor_acomp 
	where cd_setor_atendimento 	= cd_setor_atendimento_p 
	and  ((ie_dia_semana = pkg_date_utils.get_WeekDay(dt_entrada_p) 
		OR ((ie_dia_semana = 9) AND (pkg_date_utils.is_business_day(dt_entrada_p) = 1))) 
		OR coalesce(ie_dia_semana::text, '') = '')			 
	and (coalesce( nr_tipo_p, coalesce(nr_seq_tipo ,0)) = coalesce(nr_seq_tipo, 0) or coalesce(nr_seq_tipo::text, '') = '') 
	and (coalesce(cd_convenio_w, 0) = coalesce(cd_convenio, 0) or coalesce(cd_convenio::text, '') = '') 
	and ( coalesce(cd_tipo_acomodacao, 0) = coalesce( cd_tipo_acomodacao_w, 0) or coalesce(cd_tipo_acomodacao::text, '') = '') 
	and  to_char(dt_entrada_p,'HH24:mi:ss') between to_char(dt_inicio_troca,'HH24:mi:ss') and to_char(dt_fim_troca,'HH24:mi:ss') 
	and  cd_perfil_w = coalesce(cd_perfil,cd_perfil_w);
	 
	 
	if (qt_regra_w = 0) then 
		ds_retorno_w	:= 'N';
	end if;
end if;
	 
return	ds_retorno_w;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION verifica_hor_troca_acomp ( cd_setor_atendimento_p bigint, nr_atendimento_p bigint, dt_entrada_p timestamp, nr_tipo_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint ) FROM PUBLIC;

