-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION hd_obter_formula ( cd_pessoa_fisica_p text, seq_grid_p bigint, ds_formula_p text, qt_casas_decimais_p bigint, ie_grafico_p text) RETURNS varchar AS $body$
DECLARE


nr_seq_hd_item_w	bigint;
nr_seq_exame_w		bigint;
ds_formula_w		varchar(2000);
ie_formula_ok_w		integer;
ds_formula_aux_w	varchar(2000);
ie_tamanho_w		integer;
i			integer;

nr_seq_exame_ww		bigint;

ds_resultado_w		varchar(255);
aspas_w			varchar(1) := '';
ds_resultado_ant_w	varchar(255);
ds_resultado_str_w	varchar(255);

qt_casas_decimais_w	bigint;
ie_sexo_w		varchar(1);


BEGIN

ds_formula_w	:= ds_formula_p;
ie_formula_ok_w	:= position('@' in ds_formula_w);

if (ie_formula_ok_w > 0) then

	ds_formula_aux_w 	:= ds_formula_w;


	while(position('@' in ds_formula_aux_w) > 0) loop

		ie_formula_ok_w := position('@' in ds_formula_aux_w);
		ie_tamanho_w := 0;

		for i in ie_formula_ok_w..length(ds_formula_aux_w) + 1 loop

			if	((substr(ds_formula_aux_w, i, 1) in (' ','/','*','+','-','(',')','@',',')) or (i = length(ds_formula_aux_w) + 1)) and
				(i > (ie_formula_ok_w + 1)) then

				ie_tamanho_w := i;
				exit;

			end if;

		end loop;

		begin

		nr_seq_hd_item_w	:= to_number(substr(ds_formula_aux_w, ie_formula_ok_w + 1, ie_tamanho_w - (ie_formula_ok_w + 1)));

		exception
			when others then
				nr_seq_hd_item_w	:= to_number(replace(substr(ds_formula_aux_w, ie_formula_ok_w + 1, ie_tamanho_w - (ie_formula_ok_w +  1)),',','.'));
		end;

		select	coalesce(max(nr_seq_exame),null)
		into STRICT	nr_seq_exame_w
		from	hd_item_controle_exame
		where	nr_sequencia	= nr_seq_hd_item_w;

		nr_seq_exame_ww		:= replace(nr_seq_exame_w,',','.');

		ds_formula_aux_w 	:= replace((replace(ds_formula_aux_w, '@' || nr_seq_hd_item_w, nr_seq_exame_ww)),' ','');
		ds_formula_w 	 	:= ds_formula_aux_w;

	end loop;

end if;

ie_formula_ok_w := position('@' in ds_formula_w);

if (coalesce(ie_formula_ok_w,0) = 0) then

	if (position('PESSOA_FISICA' in upper(ds_formula_w)) > 0) then
		ds_formula_w	:= replace(upper(ds_formula_w),'PESSOA_FISICA',cd_pessoa_fisica_p);
	end if;

	if (position('SEXO' in upper(ds_formula_w)) > 0) then

		select 	CASE WHEN ie_sexo='M' THEN 0 WHEN ie_sexo='F' THEN 1 END
		into STRICT	ie_sexo_w
		from 	pessoa_fisica
		where 	cd_pessoa_fisica = cd_pessoa_fisica_p;

		ds_formula_w	:= replace(upper(ds_formula_w),'SEXO',ie_sexo_w);
	end if;

	if (position('DATA_REFERENCIA' in upper(ds_formula_w)) > 0) then
		ds_formula_w	:= replace(upper(ds_formula_w),'DATA_REFERENCIA',seq_grid_p);
	end if;

	if (position('PET_CREATININA' in upper(ds_formula_w)) > 0) then
		ds_formula_w	:= replace(upper(ds_formula_w),'PET_CREATININA',chr(39)||'PET_CREATININA'||chr(39));
	end if;

	if (position('PET_GLICOSE' in upper(ds_formula_w)) > 0) then
		ds_formula_w	:= replace(upper(ds_formula_w),'PET_GLICOSE',chr(39)||'PET_GLICOSE'||chr(39));
	end if;

	--obter_valor_dinamico('select ' || ds_formula_w || ' from dual', ds_resultado_w);
	ds_resultado_w := obter_valor_dinamico_char_bv('select '||ds_formula_w||' from dual', null, ds_resultado_w);

	if (coalesce(ds_resultado_w::text, '') = '') or (ds_resultado_w = '') then
		ds_resultado_w := obter_valor_dinamico('select ' || replace(ds_formula_w, ',', '.') || ' from dual', ds_resultado_w);
	end if;

	if (ie_grafico_p = 'N') then
		CALL gravar_log_tasy(783, to_char(clock_timestamp(),'dd/mm/yyyy hh24:mi:ss')||to_char(nr_seq_hd_item_w),'rhtakano');
	end if;

	ds_resultado_ant_w := ds_resultado_w;
	if (position('PET_CREATININA' in upper(ds_resultado_w)) > 0) then
		ds_resultado_str_w := substr(ds_resultado_w,position('PET_CREATININA' in upper(ds_resultado_w)),100);
	end if;

	if (position('PET_GLICOSE' in upper(ds_resultado_w)) > 0) then
		ds_resultado_str_w := substr(ds_resultado_w,position('PET_GLICOSE' in upper(ds_resultado_w)),100);
	end if;

	begin

	select	campo_mascara_virgula_casas((ds_resultado_w)::numeric , qt_casas_decimais_p)
	--select 	campo_mascara_virgula(to_number(ds_resultado_w))
	into STRICT	ds_resultado_w
	;

	exception
		when others then
		begin

		select	campo_mascara_virgula_casas((somente_numero_exame(ds_resultado_w))::numeric , qt_casas_decimais_p)
		into STRICT	ds_resultado_w
		;

		ds_resultado_w := ds_resultado_w||ds_resultado_str_w;

		exception
			when others then
			ds_resultado_w := ds_resultado_ant_w;
		end;
	end;

	if (position('PET_CREATININA' in upper(ds_resultado_w)) > 0) then
		ds_resultado_w	:= replace(upper(ds_resultado_w),'PET_CREATININA',' - '||Hd_Obter_Valor_Pet(ds_resultado_w,'C'));
	end if;

	if (position('PET_GLICOSE' in upper(ds_resultado_w)) > 0) then
		ds_resultado_w	:= replace(upper(ds_resultado_w),'PET_GLICOSE',' - '||Hd_Obter_Valor_Pet(ds_resultado_w,'G'));
	end if;
end if;


return ds_resultado_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION hd_obter_formula ( cd_pessoa_fisica_p text, seq_grid_p bigint, ds_formula_p text, qt_casas_decimais_p bigint, ie_grafico_p text) FROM PUBLIC;

