-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION nicu_get_support_icons_type (NR_SEQ_PATIENT_P bigint, ID_RULE_P text) RETURNS varchar AS $body$
DECLARE


  RETORNO_W     varchar(3000);
  ID_RULE_MEC_W bigint := 0;
  ID_RULE_MED_W bigint := 0;


BEGIN

  SELECT COUNT(0)
    INTO STRICT ID_RULE_MEC_W
    FROM NICU_CLINICAL_RULE NC
    JOIN NICU_OBSERVATION NO
      ON NO.ID_RULE = NC.ID_RULE
   WHERE 1 = 1
     AND NO.DS_OBSERVATION LIKE 'Start date/time'
     AND NO.NR_SEQUENCIA IN (SELECT MAX(NO.NR_SEQUENCIA) NR_SEQ
            FROM NICU_OBSERVATION NO
            JOIN NICU_CLINICAL_RULE NC
              ON NC.ID_RULE = NO.ID_RULE
           WHERE NC.IE_CATEGORY IN ('FEN', 'CNS', 'CVS', 'RESP', 'HEME', 'INFX', 'FAMILIES')
             AND UPPER(NC.ID_RULE) LIKE '%SUPPORT_ICON%'
             AND NC.IE_APP = '360Detail'
             AND NO.NR_SEQ_PATIENT = NR_SEQ_PATIENT_P
             AND UPPER(NO.DS_OBSERVATION) LIKE 'START DATE/TIME'
             AND NC.ID_RULE = ID_RULE_P
           GROUP BY NO.ID_RULE, NC.IE_CATEGORY, NO.CD_SNOMED_IN);

  SELECT COUNT(0)
    INTO STRICT ID_RULE_MED_W
    FROM NICU_MED_ADMINISTRATION NA
    JOIN NICU_CLINICAL_RULE NCA
      ON TO_CHAR(NCA.CD_SNOMED_OUT) LIKE TO_CHAR(NA.CD_SNOMED_BODY_SYSTEM)
   WHERE NCA.IE_APP = '360Detail'
     AND NA.NR_SEQ_PATIENT = NR_SEQ_PATIENT_P
     AND NCA.ID_RULE = ID_RULE_P
     AND coalesce(NA.DT_END_ADMINISTRATION::text, '') = '';


  IF (ID_RULE_P LIKE 'INFX_Support_Icon') THEN
    RETORNO_W := 'NORMAL';

  ELSIF (ID_RULE_P LIKE 'CNS_Support_Icon_MED') THEN
    IF (ID_RULE_MEC_W = 1 AND ID_RULE_MED_W = 1) THEN
      RETORNO_W := 'BOTH';
    ELSIF (ID_RULE_MEC_W = 1 AND ID_RULE_MED_W = 0) THEN
      RETORNO_W := 'MECHANICAL';
    ELSIF (ID_RULE_MEC_W = 0 AND ID_RULE_MED_W = 1) THEN
      RETORNO_W := 'MEDICINAL';
    ELSE
      RETORNO_W := 'NORMAL';
    END IF;

  ELSIF (ID_RULE_P LIKE 'CNS_Support_Icon_Infant_Cooling') THEN
    IF (ID_RULE_MEC_W = 1 AND ID_RULE_MED_W = 0) THEN
      RETORNO_W := 'MECHANICAL';
    ELSE
      RETORNO_W := 'NORMAL';
    END IF;

  ELSIF (ID_RULE_P LIKE 'HEME_Support_Icon') THEN
    IF (ID_RULE_MEC_W = 1 AND ID_RULE_MED_W = 1) THEN
      RETORNO_W := 'BOTH';
    ELSIF (ID_RULE_MEC_W = 1 AND ID_RULE_MED_W = 0) THEN
      RETORNO_W := 'MECHANICAL';
    ELSIF (ID_RULE_MEC_W = 0 AND ID_RULE_MED_W = 1) THEN
      RETORNO_W := 'MEDICINAL';
    ELSE
      RETORNO_W := 'NORMAL';
    END IF;

  ELSIF (ID_RULE_P LIKE 'RESP_Support_Icon') THEN
    IF (ID_RULE_MEC_W = 1 AND ID_RULE_MED_W = 1) THEN
      RETORNO_W := 'BOTH';
    ELSIF (ID_RULE_MEC_W = 1 AND ID_RULE_MED_W = 0) THEN
      RETORNO_W := 'MECHANICAL';
    ELSIF (ID_RULE_MEC_W = 0 AND ID_RULE_MED_W = 1) THEN
      RETORNO_W := 'MEDICINAL';
    ELSE
      RETORNO_W := 'NORMAL';
    END IF;

  ELSIF (ID_RULE_P LIKE 'FEN_Support_Icon') THEN
    IF (ID_RULE_MEC_W = 1 AND ID_RULE_MED_W = 1) THEN
      RETORNO_W := 'BOTH';
    ELSIF (ID_RULE_MEC_W = 1 AND ID_RULE_MED_W = 0) THEN
      RETORNO_W := 'MECHANICAL';
    ELSIF (ID_RULE_MEC_W = 0 AND ID_RULE_MED_W = 1) THEN
      RETORNO_W := 'MEDICINAL';
    ELSE
      RETORNO_W := 'NORMAL';
    END IF;

  ELSIF (ID_RULE_P LIKE 'CVS_Support_Icon') THEN
    IF (ID_RULE_MEC_W = 1 AND ID_RULE_MED_W = 1) THEN
      RETORNO_W := 'BOTH';
    ELSIF (ID_RULE_MEC_W = 1 AND ID_RULE_MED_W = 0) THEN
      RETORNO_W := 'MECHANICAL';
    ELSIF (ID_RULE_MEC_W = 0 AND ID_RULE_MED_W = 1) THEN
      RETORNO_W := 'MEDICINAL';
    ELSE
      RETORNO_W := 'NORMAL';
    END IF;

  ELSIF (ID_RULE_P LIKE 'FAMILIES_Support_Icon') THEN
    IF (ID_RULE_MEC_W = 0 AND ID_RULE_MED_W = 1) THEN
      RETORNO_W := 'MEDICINAL';
    ELSE
      RETORNO_W := 'NORMAL';
    END IF;

  END IF;

  RETURN RETORNO_W;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION nicu_get_support_icons_type (NR_SEQ_PATIENT_P bigint, ID_RULE_P text) FROM PUBLIC;

