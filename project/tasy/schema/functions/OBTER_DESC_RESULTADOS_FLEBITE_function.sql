-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_desc_resultados_flebite ( nr_atendimento_p bigint, nr_sequencia_p bigint, dt_flebite_p timestamp, ie_opcao_p text) RETURNS varchar AS $body$
DECLARE

/* 
Último grau da flebite		'GF' 
Fotor de risco			'FR' 
Protocolo prescrito SAE		'PP' 
Flebite - Gravidade 			'FG' 
Porcentagem Protocolo Preventino	'PO' 
Porcentagem Protocolo Preventino	'PT' 
Tempo permanência AVP		'AVP' 
*/
 
			 
qt_prescrito_w		bigint;
qt_prescrito_adesao_w	bigint;
ds_retorno_w		varchar(255);
ie_porcentagem_w		double precision;
dt_inicio_avp_w		timestamp;
dt_fim_avp_w		timestamp;
dias_avp_w		bigint;
horas_w			bigint;
nr_seq_avp_w		bigint;
	

BEGIN 
 
 
if (ie_opcao_p = 'GF') then 
	 
	select 	max(ie_flebite) 
	into STRICT	ds_retorno_w 
	from  	escala_flebite_ins 
	where 	nr_atendimento = nr_atendimento_p 
	and  	trunc(dt_avaliacao) = trunc(dt_flebite_p);
	 
elsif (ie_opcao_p = 'FR') then 
 
	select	max(substr(obter_descricao_item_EIF(nr_seq_item),1,255)) 
	into STRICT 	ds_retorno_w 
	from	escala_eif_item 
	where	nr_seq_item = nr_sequencia_p;
	 
elsif (ie_opcao_p = 'PP') then 
 
	select 	count(*) 
	into STRICT	qt_prescrito_w 
	from	Pe_prescricao 
	where	nr_seq_pend_pac_acao = nr_sequencia_p;
	 
	if (qt_prescrito_w > 0) then 
		ds_retorno_w := qt_prescrito_w;
	else	 
		ds_retorno_w := '0';
	end if;
 
elsif (ie_opcao_p = 'FG') then 
 
	select 	ie_flebite 
	into STRICT	ds_retorno_w 
	from  	escala_flebite_ins 
	where 	nr_sequencia = nr_sequencia_p;
	 
elsif (ie_opcao_p = 'PO') then 
 
	select 	count(*) 
	into STRICT	qt_prescrito_adesao_w 
	from	pe_prescricao a, 
		gqa_pendencia_pac b, 
		gqa_pendencia_regra c, 
		escala_flebite_ins d, 
		gqa_pend_pac_acao e 
	where	a.nr_atendimento = nr_atendimento_p 
	and	a.nr_seq_pend_pac_acao = e.nr_sequencia 
	and	e.nr_seq_pend_pac = b.nr_sequencia 
	and	b.nr_seq_pend_regra = c.nr_sequencia 
	and	b.nr_seq_escala = d.nr_sequencia 
	and	d.ie_flebite = 0 
	and	b.ie_escala = 88 
	and	trunc(b.dt_atualizacao_nrec) = trunc(dt_flebite_p);
	 
	select 	count(*) 
	into STRICT	qt_prescrito_w 
	from	gqa_pendencia_pac b, 
		gqa_pendencia_regra c, 
		escala_flebite_ins d 
	where	b.nr_atendimento = nr_atendimento_p 
	and	b.nr_seq_pend_regra = c.nr_sequencia 
	and	b.nr_seq_escala = d.nr_sequencia 
	and	d.ie_flebite = 0 
	and	b.ie_escala = 88 
	and	trunc(b.dt_atualizacao_nrec) = trunc(dt_flebite_p);
	 
	ie_porcentagem_w := (Dividir(qt_prescrito_adesao_w,qt_prescrito_w)*100);
	 
	if (ie_porcentagem_w >= 85) then 
		ds_retorno_w := 1;
	else	 
		ds_retorno_w := 0;
	end if;
	 
elsif (ie_opcao_p = 'PT') then 
	 
	select 	count(*) 
	into STRICT	qt_prescrito_adesao_w 
	from	pe_prescricao a, 
		gqa_pendencia_pac b, 
		gqa_pendencia_regra c, 
		escala_flebite_ins d, 
		gqa_pend_pac_acao e 
	where	a.nr_atendimento = nr_atendimento_p 
	and	a.nr_seq_pend_pac_acao = e.nr_sequencia 
	and	e.nr_seq_pend_pac = b.nr_sequencia 
	and	b.nr_seq_pend_regra = c.nr_sequencia 
	and	b.nr_seq_escala = d.nr_sequencia 
	and	d.ie_flebite = nr_sequencia_p 
	and	b.ie_escala = 88 
	and	trunc(b.dt_atualizacao_nrec) = trunc(dt_flebite_p);
	 
	select 	count(*) 
	into STRICT	qt_prescrito_w 
	from	gqa_pendencia_pac b, 
		gqa_pendencia_regra c, 
		escala_flebite_ins d 
	where	b.nr_atendimento = nr_atendimento_p 
	and	b.nr_seq_pend_regra = c.nr_sequencia 
	and	b.nr_seq_escala = d.nr_sequencia 
	and	d.ie_flebite = nr_sequencia_p 
	and	b.ie_escala = 88	 
	and	trunc(b.dt_atualizacao_nrec) = trunc(dt_flebite_p);
	 
	ie_porcentagem_w := (Dividir(qt_prescrito_adesao_w,qt_prescrito_w)*100);
	 
	if (ie_porcentagem_w >= 85) then 
		ds_retorno_w := 1;
	else	 
		ds_retorno_w := 0;
	end if;
	 
elsif (ie_opcao_p = 'AVP') then 
 
	select	dt_instalacao, 
		dt_retirada 
	into STRICT	dt_inicio_avp_w, 
		dt_fim_avp_w	 
	from	qua_evento_flebite 
	where	nr_sequencia = nr_sequencia_p;
 
	dias_avp_w := (coalesce(dt_fim_avp_w,clock_timestamp())- dt_inicio_avp_w);
	horas_w := (coalesce(dt_fim_avp_w,clock_timestamp())- dt_inicio_avp_w)*24;
	 
 
	if (dias_avp_w < 1) then 
		ds_retorno_w := Wheb_mensagem_pck.get_texto(309121); --'Menos que 1 dia'; 
	elsif (dias_avp_w = 1) then
		ds_retorno_w := Wheb_mensagem_pck.get_texto(309122); --'1 dia'; 
	elsif (dias_avp_w >= 5) then
		ds_retorno_w := Wheb_mensagem_pck.get_texto(309124); --'5 ou mais dias'; 
	else
		ds_retorno_w := dias_avp_w|| ' ' || Wheb_mensagem_pck.get_texto(309125); --' dias'; 
	end if;
	 
end if;
 
return	ds_retorno_w;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_desc_resultados_flebite ( nr_atendimento_p bigint, nr_sequencia_p bigint, dt_flebite_p timestamp, ie_opcao_p text) FROM PUBLIC;

