-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_qtde_maior_estoque_max (cd_local_estoque_p bigint, cd_material_p bigint, qt_material_p bigint, nr_requisicao_p bigint, cd_estabelecimento_p bigint) RETURNS bigint AS $body$
DECLARE


qt_estoque_disp_w		double precision := 0;
qt_pendente_w		double precision := 0;
qt_estoque_max_w		double precision := 0;
qt_total_w		double precision := 0;
qt_retorno_w		double precision := 0;


BEGIN

select	max(coalesce(qt_estoque_maximo,0))
into STRICT	qt_estoque_max_w
from	padrao_estoque_local
where	cd_material		= cd_material_p
and	cd_local_estoque		= cd_local_estoque_p
and	cd_estabelecimento		= cd_estabelecimento_p;

if (qt_estoque_max_w > 0) then
	begin

	select	obter_saldo_disp_estoque(cd_estabelecimento_p,cd_material_p,cd_local_estoque_p,clock_timestamp())
	into STRICT	qt_estoque_disp_w
	;

	/* Alterado por Fabio para melhoria de performance - OS386555
	select 	nvl(sum(a.qt_material_requisitada),0)
	into	qt_pendente_w
	from   	requisicao_material_pendente_v a,
		operacao_estoque b
	where  	a.cd_estabelecimento 		= cd_estabelecimento_p
	and	a.cd_local_estoque_destino 		= cd_local_estoque_p
	and	a.cd_operacao_estoque 		= b.cd_operacao_estoque
	and   	a.cd_material	 		= cd_material_p
	and	a.nr_requisicao			<> nr_requisicao_p
	and   	b.ie_tipo_requisicao 		= '2';
	*/
	select 	coalesce(sum(c.qt_material_requisitada),0)
	into STRICT	qt_pendente_w
	from	operacao_estoque o ,
		requisicao_material b,
		item_requisicao_material c
	where	b.nr_requisicao		= c.nr_requisicao
	and	b.cd_operacao_estoque	= o.cd_operacao_estoque
	and	coalesce(c.cd_motivo_baixa, 0)	= 0
	and	b.cd_estabelecimento	= cd_estabelecimento_p
	and	b.cd_local_estoque_destino	= cd_local_estoque_p
	and   	c.cd_material		= cd_material_p
	and	b.nr_requisicao		<> nr_requisicao_p
	and   	o.ie_tipo_requisicao		= '2';


	qt_total_w := (qt_estoque_disp_w + qt_pendente_w + qt_material_p);

	if (qt_total_w > qt_estoque_max_w) then
		qt_retorno_w := 	(qt_total_w - qt_estoque_max_w);
	end if;

	end;
end if;

return qt_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_qtde_maior_estoque_max (cd_local_estoque_p bigint, cd_material_p bigint, qt_material_p bigint, nr_requisicao_p bigint, cd_estabelecimento_p bigint) FROM PUBLIC;

