-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';



CREATE TYPE regraModelo AS (
			nr_seq_grupo 		modelo_grupo_regra_visual.nr_seq_grupo%type,
			ie_acao			varchar(1));


CREATE OR REPLACE FUNCTION obter_grupos_quest_visivel ( nr_seq_modelo_p bigint, nr_seq_pergunta_p bigint, ds_resultado_p text) RETURNS varchar AS $body$
DECLARE


/* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Finalidade:
-------------------------------------------------------------------------------------------------------------------
Locais de chamada direta:
[  ]  Objetos do dicionário [ ] Tasy (Delphi/Java) [  ] Portal [  ]  Relatórios [ ] Outros:
 ------------------------------------------------------------------------------------------------------------------
Pontos de atenção:
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */
type listaRegras is table of regraModelo;

ds_grupo_w		varchar(255)	:= null;
nr_seq_grupo_w		modelo_grupo_regra_visual.nr_seq_grupo%type	:= null;
ie_operacao_regra_w	modelo_grupo_regra_visual.ie_operacao%type	:= null;
ds_resultado_regra_w	modelo_grupo_regra_visual.ds_resultado%type	:= null;
ie_acao_w		varchar(1);
rc_regra_modelo_w	regraModelo;
tb_lista_Regras_w	listaRegras := listaRegras();
nr_registros_table_w	integer;

c01 CURSOR FOR
	SELECT	a.nr_seq_grupo,
		a.ds_resultado,
		a.ie_operacao
	from	modelo_grupo_regra_visual a,
		modelo_grupo_conteudo b
	where	a.nr_seq_grupo		= b.nr_sequencia
	and	b.nr_seq_modelo		= nr_seq_modelo_p
	and	a.nr_seq_pergunta 	= nr_seq_pergunta_p;

c02 CURSOR FOR
	SELECT	distinct a.nr_seq_grupo
	from	modelo_grupo_regra_visual a,
		modelo_grupo_conteudo b
	where	a.nr_seq_grupo		= b.nr_sequencia
	and	b.nr_seq_modelo		= nr_seq_modelo_p
	and	a.nr_seq_pergunta 	= nr_seq_pergunta_p;
BEGIN

if (nr_seq_modelo_p IS NOT NULL AND nr_seq_modelo_p::text <> '') and (nr_seq_pergunta_p IS NOT NULL AND nr_seq_pergunta_p::text <> '') then

	for	row_c02 in c02 loop
		tb_lista_Regras_w.extend;
		rc_regra_modelo_w.nr_seq_grupo := row_c02.nr_seq_grupo;
		tb_lista_Regras_w(tb_lista_Regras_w.last) := rc_regra_modelo_w;
	end loop;

	open C01;
	loop
	fetch C01 into
		nr_seq_grupo_w,
		ds_resultado_regra_w,
		ie_operacao_regra_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin
		if (ie_operacao_regra_w IS NOT NULL AND ie_operacao_regra_w::text <> '') then
			/* Por padrão ocultar */

			ie_acao_w	:= 'O';
			if (ie_operacao_regra_w = '=') then
				if (ds_resultado_regra_w = ds_resultado_p) or (coalesce(ds_resultado_regra_w::text, '') = '' and coalesce(ds_resultado_p::text, '') = '') then
					ie_acao_w	:= 'V';
				end if;
			elsif (ie_operacao_regra_w = '<>') then
				if (ds_resultado_regra_w <> ds_resultado_p and (ds_resultado_regra_w IS NOT NULL AND ds_resultado_regra_w::text <> '')) or (coalesce(ds_resultado_regra_w::text, '') = '' and (ds_resultado_p IS NOT NULL AND ds_resultado_p::text <> '')) then
					ie_acao_w	:= 'V';
				end if;
			elsif (ie_operacao_regra_w = '>') then
				if (ds_resultado_regra_w < ds_resultado_p) then
					ie_acao_w	:= 'V';
				end if;
			elsif (ie_operacao_regra_w = '<') then
				if (ds_resultado_regra_w > ds_resultado_p) then
					ie_acao_w	:= 'V';
				end if;
			end if;

			for i in tb_lista_Regras_w.first .. tb_lista_Regras_w.last loop

				if (tb_lista_Regras_w[i].nr_seq_grupo = nr_seq_grupo_w) and
					((tb_lista_Regras_w[i]coalesce(.ie_acao::text, '') = '') or (tb_lista_Regras_w[i].ie_acao = 'O')) then
					tb_lista_Regras_w[i].ie_acao := ie_acao_w;
				end if;

			end loop;

		end if;
		end;
	end loop;
	close C01;

	nr_registros_table_w := tb_lista_Regras_w.last;
	if (nr_registros_table_w IS NOT NULL AND nr_registros_table_w::text <> '') then

		for i in tb_lista_Regras_w.first .. tb_lista_Regras_w.last loop
			ds_grupo_w	:= ds_grupo_w || tb_lista_Regras_w[i].ie_acao || '=' || tb_lista_Regras_w[i].nr_seq_grupo || ';';
		end loop;

	end if;

end if;

return	ds_grupo_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_grupos_quest_visivel ( nr_seq_modelo_p bigint, nr_seq_pergunta_p bigint, ds_resultado_p text) FROM PUBLIC;

