-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_erro_produto_ger_des (dt_parametro_p timestamp, nr_seq_gerencia_p bigint, ie_tipo_valor_p text, ie_duvida_desenv_p text) RETURNS bigint AS $body$
DECLARE


qt_total_w		double precision;
qt_total_tec_w		double precision;
qt_erro_w		double precision;
qt_retorno_w	double precision;

dt_ref_mes_w	timestamp;
dt_fim_mes_w	timestamp;


BEGIN

dt_ref_mes_w			:= pkg_date_utils.start_of(dt_parametro_p,'MONTH',0);
dt_fim_mes_w			:= pkg_date_utils.end_of(dt_ref_mes_w,'MONTH',0);

if (ie_tipo_valor_p	= 'A') then
	dt_ref_mes_w			:= pkg_date_utils.add_month(pkg_date_utils.start_of(dt_parametro_p,'MONTH',0), -11,0);
	dt_fim_mes_w			:= pkg_date_utils.start_of(dt_parametro_p,'MONTH',0);
end if;

	if (ie_duvida_desenv_p = 'S') then
		select	count(*) qt_total_os,
			sum(CASE WHEN COM_Obter_Tipo_Classif_OS(a.nr_sequencia)='W' THEN 1  ELSE 0 END ) qt_erro_os
		into STRICT	qt_total_w,
				qt_erro_w
		FROM man_ordem_servico a
LEFT OUTER JOIN grupo_desenvolvimento b ON (a.nr_seq_grupo_des = b.nr_sequencia)
WHERE a.dt_ordem_servico between dt_ref_mes_w and dt_fim_mes_w  and ((nr_seq_gerencia_p = 0) or (b.nr_seq_gerencia	= nr_seq_gerencia_p)) and exists (SELECT 1
			from 	man_estagio_processo y,
				man_ordem_serv_estagio x
			where	y.nr_sequencia = x.nr_seq_estagio
			and	x.nr_seq_ordem = a.nr_sequencia
			and	y.ie_desenv	= 'S');
	else
		select	count(*) qt_total_os,
			sum(CASE WHEN COM_Obter_Tipo_Classif_OS(a.nr_sequencia)='W' THEN 1  ELSE 0 END ) qt_erro_os
		into STRICT	qt_total_w,
				qt_erro_w
		FROM man_ordem_servico a
LEFT OUTER JOIN grupo_desenvolvimento b ON (a.nr_seq_grupo_des = b.nr_sequencia)
WHERE a.dt_ordem_servico between dt_ref_mes_w and dt_fim_mes_w  and ((nr_seq_gerencia_p = 0) or (b.nr_seq_gerencia	= nr_seq_gerencia_p));
	end if;

		/*
		Tecnologia
		Verifica as OS que
			- Passou pela Tecnologia
			- Tem atividade realizada
			- Tem histórico da tecnologia
			- Porém foi encerrada em um grupo de desenvolvimento
		Esta situação é para tratar as OS onde: o Desenvolvimento necessita de alteração em componente, é feita a alteração e devolvido para finalizarem a customização da função.
		*/
		if ( nr_seq_gerencia_p = 2) then
			select	count(*) qt_total_os
			into STRICT	qt_total_tec_w
			FROM man_ordem_servico a
LEFT OUTER JOIN grupo_desenvolvimento b ON (a.nr_seq_grupo_des = b.nr_sequencia)
WHERE a.dt_ordem_servico between dt_ref_mes_w and dt_fim_mes_w  and b.nr_seq_gerencia	!= 2 and exists (
				SELECT 	1
				from	man_ordem_serv_ativ c,
					grupo_desenvolvimento d,
					usuario_grupo_des e
				where	a.nr_sequencia = c.nr_seq_ordem_serv
				and	d.nr_seq_gerencia = 2
				and	e.nr_seq_grupo = d.nr_sequencia
				and	c.nm_usuario_exec = e.nm_usuario_grupo) and exists (
				SELECT 	1
				from	man_ordem_serv_tecnico	c,
					grupo_desenvolvimento d,
					usuario_grupo_des e
				where	a.nr_sequencia = c.nr_seq_ordem_serv
				and	d.nr_seq_gerencia = 2
				and	e.nr_seq_grupo = d.nr_sequencia
				and	c.nm_usuario = e.nm_usuario_grupo) and exists (
				select	1
				from	man_ordem_serv_estagio f,
					man_estagio_processo g
				where	f.nr_seq_ordem = a.nr_sequencia
				and	g.nr_sequencia = f.nr_seq_estagio
				and	g.ie_tecnologia = 'S');

			qt_total_w := qt_total_w + qt_total_tec_w;

		end if;

		qt_retorno_w	:= dividir(qt_erro_w, qt_total_w)*100;

if (ie_tipo_valor_p	in ('A', 'T')) then
	return	qt_erro_w;
else
	return	qt_retorno_w;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_erro_produto_ger_des (dt_parametro_p timestamp, nr_seq_gerencia_p bigint, ie_tipo_valor_p text, ie_duvida_desenv_p text) FROM PUBLIC;

