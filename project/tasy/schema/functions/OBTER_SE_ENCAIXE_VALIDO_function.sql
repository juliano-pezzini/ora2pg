-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_se_encaixe_valido ( cd_agenda_p bigint, dt_agenda_p timestamp, qt_dias_p bigint) RETURNS varchar AS $body$
DECLARE


ds_retorno_w	varchar(255);
ie_valido_w	varchar(1);
ie_dia_semana_w	smallint;
qt_dia_atual_w	bigint:= 0;
qt_dias_w	bigint;
ie_virgula_w	varchar(1):= 'N';
dt_agenda_w	timestamp;


BEGIN

dt_agenda_w	:= dt_agenda_p;
qt_dia_atual_w	:= 0;
qt_dias_w	:= qt_dias_p;

if (cd_agenda_p IS NOT NULL AND cd_agenda_p::text <> '') and (dt_agenda_p IS NOT NULL AND dt_agenda_p::text <> '') then

	while(qt_dia_atual_w < qt_dias_w) loop
		begin

		qt_dia_atual_w	:= qt_dia_atual_w + 1;

		/* Obter dia semana */

		select	obter_cod_dia_semana(dt_agenda_w)
		into STRICT	ie_dia_semana_w
		;

		/* Consistir se horÃ¡rio */

		select	CASE WHEN count(*)=0 THEN 'N'  ELSE 'S' END
		into STRICT	ie_valido_w
		from	agenda_turno
		where	cd_agenda = cd_agenda_p
		and	to_char(hr_inicial,'hh24:mi') <= to_char(dt_agenda_w,'hh24:mi')
		and	to_char(hr_final,'hh24:mi') >= to_char(dt_agenda_w,'hh24:mi')
		and	((coalesce(dt_final_vigencia::text, '') = '') or (dt_final_vigencia >= trunc(dt_agenda_w)))
		and	((coalesce(dt_inicio_vigencia::text, '') = '') or (dt_inicio_vigencia <= trunc(dt_agenda_w)))
		and	ie_dia_semana_w not in (1,7)
		and	((ie_dia_semana = ie_dia_semana_w) or (ie_dia_semana = 9));

		if (ie_valido_w = 'N') then
			if (ie_virgula_w = 'N') then
				ie_virgula_w := 'S';
				ds_retorno_w := ie_dia_semana_w;
			elsif (ie_virgula_w = 'S') and (position(ie_dia_semana_w in ds_retorno_w) = 0) then
				ds_retorno_w := ds_retorno_w || ',' || ie_dia_semana_w;
			end if;
		end if;

		dt_agenda_w := dt_agenda_w + 1;

		end;
	end loop;

end if;

return ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_se_encaixe_valido ( cd_agenda_p bigint, dt_agenda_p timestamp, qt_dias_p bigint) FROM PUBLIC;

