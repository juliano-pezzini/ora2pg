-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_banda_relatorio_dinamico ( nr_seq_relatorio_p bigint, nr_tipo_banda_p bigint) RETURNS varchar AS $body$
DECLARE


nr_sequencia_w 		bigint;
ds_nome_banda_w 	varchar(255);
layout_todos_campos_w 	varchar(9000);
json_config_campo_w 	varchar(300);
qt_altura_banda_w bigint;
qt_comprimento_banda_w bigint;

c01 CURSOR FOR
	SELECT nr_sequencia
    from relatorio_dinamico
    where nr_tipo_banda  = nr_tipo_banda_p
	and nr_seq_relatorio = nr_seq_relatorio_p;


BEGIN
	open c01;
	loop
	fetch c01 into
		nr_sequencia_w;
    EXIT WHEN NOT FOUND; /* apply on c01 */

		select obter_campo_relatorio_dinamico(nr_sequencia_w)
		into STRICT json_config_campo_w
		;

		layout_todos_campos_w := layout_todos_campos_w || ',' || json_config_campo_w;
    end loop;
    close c01;

    layout_todos_campos_w := substr(layout_todos_campos_w,2,length(layout_todos_campos_w));

   select
    max(qt_tamanho_banda),
    max(qt_altura_banda)
    into STRICT   
    qt_comprimento_banda_w,
    qt_altura_banda_w
    from relatorio_dinamico
    where nr_tipo_banda  = nr_tipo_banda_p
    and nr_seq_relatorio = nr_seq_relatorio_p;

    select obter_desc_expressao(CASE WHEN nr_tipo_banda_p=1 THEN  486585 WHEN nr_tipo_banda_p=2 THEN  1023254 WHEN nr_tipo_banda_p=3 THEN  931087  ELSE 486586 END )
	into STRICT ds_nome_banda_w
;

    return '{"name": "' || coalesce(ds_nome_banda_w,0) || '"'
    || ',"width": "' || coalesce(qt_comprimento_banda_w,0) || '"'
    || ',"height": "'  || qt_altura_banda_w || '"'
    || ',"fields" : [' || layout_todos_campos_w || ']}';

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_banda_relatorio_dinamico ( nr_seq_relatorio_p bigint, nr_tipo_banda_p bigint) FROM PUBLIC;

