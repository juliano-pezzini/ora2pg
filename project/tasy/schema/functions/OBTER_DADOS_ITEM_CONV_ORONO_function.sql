-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_dados_item_conv_orono (cd_convenio_p conversao_proc_convenio.cd_convenio%type, cd_categoria_p conversao_proc_convenio.cd_categoria%type, cd_plano_p conversao_proc_convenio.cd_plano%type, ie_tipo_item_p conversao_proc_convenio.ie_tipo_atendimento%type, cd_item_p conversao_proc_convenio.cd_procedimento%type, ie_origem_proced_p conversao_proc_convenio.ie_origem_proced%type, ie_estrutura_completa_p conversao_proc_convenio.ie_situacao%type, cd_especialidade_med_p conversao_proc_convenio.cd_especialidade_medica%type, ie_tipo_atendimento_p conversao_proc_convenio.ie_tipo_atendimento%type, nr_atendimento_p atendimento_paciente.nr_atendimento%type, nr_seq_proc_interno_p conversao_proc_convenio.nr_seq_proc_interno%type, nr_seq_exame_p conversao_proc_convenio.nr_seq_exame%type, ie_cod_desc_p conversao_proc_convenio.ie_situacao%type, dt_autorizacao_p autorizacao_convenio.dt_autorizacao%type) RETURNS varchar AS $body$
DECLARE


/* tipo do item    1-procedimentos/servicos 2-materiais/medicamentos */

/* estrutura completa s-sim (validade toda estrutura) n-nao (valida so proc) */

/* ie_cod_desc_p
	C - Codigo do item no Convenio
	D - Descricao do item no Convenio
	M - Tipo do material no Convenio
*/
cd_convenio_w           conversao_proc_convenio.cd_convenio%type := cd_convenio_p;
cd_categoria_w          conversao_proc_convenio.cd_categoria%type := cd_categoria_p;
cd_item_w               conversao_proc_convenio.cd_procedimento%type := cd_item_p;
ie_tipo_item_w          conversao_proc_convenio.ie_tipo_atendimento%type := ie_tipo_item_p;
ie_origem_proced_w      conversao_proc_convenio.ie_origem_proced%type := ie_origem_proced_p;
ie_estrutura_completa_w conversao_proc_convenio.ie_situacao%type := ie_estrutura_completa_p;
cd_especialidade_med_w  conversao_proc_convenio.cd_especialidade_medica%type := cd_especialidade_med_p;
ie_tipo_atendimento_w   conversao_proc_convenio.ie_tipo_atendimento%type := ie_tipo_atendimento_p;
nr_atendimento_w        atendimento_paciente.nr_atendimento%type := nr_atendimento_p;
nr_seq_proc_interno_w   conversao_proc_convenio.nr_seq_proc_interno%type := nr_seq_proc_interno_p;
nr_seq_exame_w          conversao_proc_convenio.nr_seq_exame%type := nr_seq_exame_p;
ie_cod_desc_w           conversao_proc_convenio.ie_situacao%type := ie_cod_desc_p;
dt_autorizacao_w        autorizacao_convenio.dt_autorizacao%type := dt_autorizacao_p;
cd_codigo_convenio_w    conversao_proc_convenio.cd_proc_convenio%type;
ds_item_convenio_w      conversao_proc_convenio.ds_proc_convenio%type;
cd_grupo_proc_w         conversao_proc_convenio.cd_grupo_proced%type;
cd_espec_proc_w         conversao_proc_convenio.cd_especial_proced%type;
cd_area_proc_w          conversao_proc_convenio.cd_area_proced%type;
cd_grupo_mat_w          conversao_material_convenio.cd_grupo_material%type;
cd_subgrupo_mat_w       conversao_material_convenio.cd_subgrupo_material%type;
cd_classe_mat_w         conversao_material_convenio.cd_classe_material%type;
ie_tipo_mat_w           conversao_material_convenio.ie_tipo_material%type;
cd_setor_atendimento_w  conversao_proc_convenio.cd_setor_atendimento%type := 0;
ds_item_w               conversao_proc_convenio.ds_proc_convenio%type;
dia_semana_w            conversao_proc_convenio.qt_ano_max_dia%type := 0;
dia_feriado_w           feriado.dt_feriado%type;
ie_feriado_w            pessoa_fisica.ie_sexo%type := 'N';
cd_estabelecimento_w    conversao_material_convenio.cd_estabelecimento%type;
nr_sequencia_w          conversao_material_convenio.nr_sequencia%type;
nr_seq_proc_pacote_w    procedimento_paciente.nr_seq_proc_pacote%type;
nr_seq_pacote_w         conversao_proc_convenio.nr_seq_pacote%type;
ie_tipo_material_conv_w conversao_material_convenio.ie_tipo_material_conv%type;
ie_clinica_w            atendimento_paciente.ie_clinica%type;
cd_plano_w              conversao_proc_convenio.cd_plano%type := cd_plano_p;
ie_sexo_w               pessoa_fisica.ie_sexo%type;
dt_nascimento_w         pessoa_fisica.dt_nascimento%type;
qt_idade_w              pessoa_fisica.nr_seq_cartorio_nasc%type;
data_atual_w            pessoa_fisica.dt_nascimento%type := clock_timestamp();
retorno_w               conversao_material_convenio.ds_material_convenio%type;

c01 CURSOR FOR
	SELECT cd_proc_convenio,
           coalesce(ds_proc_convenio,ds_item_w)
	from conversao_proc_convenio
	where cd_convenio = cd_convenio_w
	and coalesce(cd_categoria, coalesce(cd_categoria_w, '0')) = coalesce(cd_categoria_w, '0')
    and coalesce(cd_plano, coalesce(cd_plano_w, '0')) = coalesce(cd_plano_w, '0')
	and coalesce(cd_procedimento,coalesce(cd_item_w, 0)) = coalesce(cd_item_w, 0)
	and coalesce(ie_origem_proced,coalesce(ie_origem_proced_w,0)) = coalesce(ie_origem_proced_w, 0)
	and coalesce(cd_area_proced,coalesce(cd_area_proc_w, 0)) = coalesce(cd_area_proc_w, 0)
	and coalesce(cd_especial_proced,coalesce(cd_espec_proc_w, 0)) = coalesce(cd_espec_proc_w, 0)
	and coalesce(cd_grupo_proced,coalesce(cd_grupo_proc_w, 0)) = coalesce(cd_grupo_proc_w, 0)
	and coalesce(nr_seq_proc_interno, coalesce(nr_seq_proc_interno_w,0)) = coalesce(nr_seq_proc_interno_w, 0)
	and coalesce(nr_seq_exame, coalesce(nr_seq_exame_w, 0)) = coalesce(nr_seq_exame_w ,0)
	and ie_situacao	= 'A'
	and (coalesce(cd_especialidade_medica, coalesce(cd_especialidade_med_w, 0)) = coalesce(cd_especialidade_med_w, 0))
	and (coalesce(ie_tipo_atendimento, coalesce(ie_tipo_atendimento_w, 0)) = coalesce(ie_tipo_atendimento_w, 0))
	and (coalesce(cd_setor_atendimento, coalesce(cd_setor_atendimento_w, 0)) = coalesce(cd_setor_atendimento_w, 0))
	and (coalesce(cd_estabelecimento, coalesce(cd_estabelecimento_w, 1)) = coalesce(cd_estabelecimento_w, 1))
	and ((coalesce(upper(ie_feriado), 'A') = 'A') or (upper(ie_feriado) = ie_feriado_w))
	and coalesce(nr_seq_pacote, coalesce(nr_seq_pacote_w,0)) = coalesce(nr_seq_pacote_w, 0)
	and coalesce(ie_clinica, coalesce(ie_clinica_w,0)) = coalesce(ie_clinica_w, 0)
    and coalesce(ie_sexo, coalesce(ie_sexo_w, '0')) = coalesce(ie_sexo_w, '0')
    and coalesce(qt_idade_w,0) between
        coalesce(obter_idade_conversao_proc(nr_sequencia, qt_ano_min, qt_ano_min_mes, qt_ano_min_dia, qt_ano_max, qt_ano_max_mes, qt_ano_max_dia, 'MIN'), 0) and 
        coalesce(obter_idade_conversao_proc(nr_sequencia, qt_ano_min, qt_ano_min_mes, qt_ano_min_dia, qt_ano_max, qt_ano_max_mes, qt_ano_max_dia, 'MAX'),9999999999)
	and ((coalesce(dt_autorizacao_w::text, '') = '')
     or (dt_autorizacao_w between coalesce(dt_inicio_vigencia, dt_autorizacao_w) and coalesce(dt_vigencia_final, dt_autorizacao_w) + 86399/89400))
	and ((coalesce(dt_dia_semana, dia_semana_w) = dia_semana_w) or (dt_dia_semana = 9))
	and (((coalesce(hr_final::text, '') = '') or (coalesce(hr_inicial::text, '') = '')) or (coalesce(dt_autorizacao_w, clock_timestamp())
        between 
        to_date(to_char(coalesce(dt_autorizacao_w, clock_timestamp()),'dd/mm/yyyy') || ' ' ||coalesce(to_char(hr_inicial,'hh24:mi:ss'), '00:00:01'),'dd/mm/yyyy hh24:mi:ss')
        and 
        to_date(to_char(coalesce(dt_autorizacao_w, clock_timestamp()),'dd/mm/yyyy') || ' ' ||coalesce(to_char(hr_final,'hh24:mi:ss'), '23:59:59'),'dd/mm/yyyy hh24:mi:ss')))
	order by coalesce(cd_procedimento, 0),
			 coalesce(cd_grupo_proced, 0),
			 coalesce(cd_especial_proced, 0),
			 coalesce(cd_area_proced, 0),
			 coalesce(ie_clinica, 0),
			 coalesce(cd_categoria, ' ');

c02 CURSOR FOR
	SELECT cd_material_convenio,
           coalesce(ds_material_convenio, ds_item_w),
           coalesce(ie_tipo_material_conv, ie_tipo_mat_w)
	from conversao_material_convenio
	where cd_convenio = cd_convenio_w
	and coalesce(cd_categoria, coalesce(cd_categoria_w, '0')) = coalesce(cd_categoria_w, '0')
	and coalesce(cd_material, cd_item_w) = cd_item_w
	and coalesce(cd_grupo_material, cd_grupo_mat_w) = cd_grupo_mat_w
	and coalesce(cd_subgrupo_material, cd_subgrupo_mat_w) = cd_subgrupo_mat_w
	and coalesce(cd_classe_material, cd_classe_mat_w) = cd_classe_mat_w
	and coalesce(ie_tipo_material, ie_tipo_mat_w) = ie_tipo_mat_w
	and coalesce(ie_clinica, coalesce(ie_clinica_w, 0)) = coalesce(ie_clinica_w, 0)
    and (coalesce(cd_estabelecimento, coalesce(cd_estabelecimento_w, 1)) = coalesce(cd_estabelecimento_w, 1))
    and (coalesce(ie_tipo_atendimento, coalesce(ie_tipo_atendimento_w, 0)) = coalesce(ie_tipo_atendimento_w, 0))
	and ie_situacao = 'A'
    and ((coalesce(dt_autorizacao_w::text, '') = '')
     or (dt_autorizacao_w between coalesce(dt_inicio_vigencia, dt_autorizacao_w) and coalesce(dt_final_vigencia, dt_autorizacao_w) + 86399/89400))
	and ((coalesce(dt_dia_semana, dia_semana_w) = dia_semana_w) or (dt_dia_semana = 9))
	and (((coalesce(hr_final::text, '') = '') or (coalesce(hr_inicial::text, '') = '')) or (coalesce(dt_autorizacao_w, clock_timestamp())
        between
        to_date(to_char(coalesce(dt_autorizacao_w, clock_timestamp()),'dd/mm/yyyy') || ' ' ||coalesce(to_char(hr_inicial,'hh24:mi:ss'), '00:00:01'),'dd/mm/yyyy hh24:mi:ss')
        and 
        to_date(to_char(coalesce(dt_autorizacao_w, clock_timestamp()),'dd/mm/yyyy') || ' ' ||coalesce(to_char(hr_final,'hh24:mi:ss'), '23:59:59'),'dd/mm/yyyy hh24:mi:ss')))
	order by coalesce(cd_material, 0),
			 coalesce(cd_grupo_material, 0),
			 coalesce(cd_subgrupo_material, 0),
			 coalesce(cd_classe_material, 0),
			 coalesce(ie_tipo_material, '0'),
			 coalesce(ie_clinica, 0),
			 coalesce(cd_categoria, ' ');


BEGIN

select wheb_usuario_pck.get_cd_estabelecimento
into STRICT cd_estabelecimento_w
;

nr_seq_pacote_w := 0;

begin
    select a.ie_clinica, b.ie_sexo, b.dt_nascimento
    into STRICT ie_clinica_w, ie_sexo_w, dt_nascimento_w
    from atendimento_paciente a, pessoa_fisica b
    where b.cd_pessoa_fisica = a.cd_pessoa_fisica	
    and a.nr_atendimento = nr_atendimento_w;
exception
    when no_data_found or too_many_rows then
        ie_clinica_w := null;
end;

if (ie_tipo_item_w = 1) then
	begin
	/* busca estrutura procedimento */

	if (ie_estrutura_completa_w = 'N') then
		cd_grupo_proc_w	:= 99999999;
		cd_espec_proc_w	:= 99999999;
		cd_area_proc_w	:= 99999999;
	else
		begin
            select cd_grupo_proc,
                   cd_especialidade,
                   cd_area_procedimento
            into STRICT cd_grupo_proc_w,
                 cd_espec_proc_w,
                 cd_area_proc_w
            from estrutura_procedimento_v
            where cd_procedimento = cd_item_w
            and	ie_origem_proced = ie_origem_proced_w;
		exception
            when no_data_found or too_many_rows then
                cd_grupo_proc_w	:= 0;
		end;
	end if;

    begin
        select obter_dias_entre(dt_nascimento_w, data_atual_w) idade
        into STRICT qt_idade_w
;
    exception
        when no_data_found then
            qt_idade_w := 0;
    end;

    begin
        select coalesce(max(a.nr_sequencia),0)
        into STRICT nr_sequencia_w
        from procedimento_paciente a
        where a.nr_atendimento = nr_atendimento_w
        and a.cd_procedimento = cd_item_w
        and a.ie_origem_proced = ie_origem_proced_w
        and coalesce(a.cd_motivo_exc_conta::text, '') = '';
    exception
        when no_data_found or too_many_rows then
            nr_sequencia_w := 0;
    end;

    dia_semana_w := pkg_date_utils.get_weekday(dt_autorizacao_w);

    begin
        select a.dt_feriado
        into STRICT dia_feriado_w
        from feriado a
        where pkg_date_utils.start_of(a.dt_feriado, 'DD', 0) = 
              pkg_date_utils.start_of(dt_autorizacao_w, 'DD', 0)  LIMIT 1;
    exception
        when no_data_found or too_many_rows then
            dia_feriado_w := null;
    end;

    if (dia_feriado_w IS NOT NULL AND dia_feriado_w::text <> '')then
        ie_feriado_w := 'S';
    else
        ie_feriado_w := 'N';
    end if;
	
	if (nr_sequencia_w > 0) then
		
		select max(cd_setor_atendimento),
			   max(nr_seq_proc_pacote)
		into STRICT cd_setor_atendimento_w,
			 nr_seq_proc_pacote_w
		from procedimento_paciente
		where nr_sequencia = nr_sequencia_w;
		
		if (coalesce(nr_seq_proc_pacote_w,0) > 0) then
			select coalesce(max(nr_seq_pacote), 0)
			into STRICT nr_seq_pacote_w
			from atendimento_pacote
			where nr_seq_procedimento = nr_seq_proc_pacote_w
			and nr_atendimento = nr_atendimento_w;
		end if;
	
	end if;
	
	/* busca descricao do procedimento para o convenio */

	begin
	open c01;
	loop
	fetch c01 into
		cd_codigo_convenio_w,
		ds_item_convenio_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
		begin
            cd_codigo_convenio_w := cd_codigo_convenio_w;
            ds_item_convenio_w := ds_item_convenio_w;
		end;
	end loop;
	close c01;
	end;
	end;
else
	begin
	/* busca estrutura material */

	begin
        select cd_grupo_material,
               cd_subgrupo_material,
               cd_classe_material,
               ie_tipo_material
        into STRICT cd_grupo_mat_w,
             cd_subgrupo_mat_w,
             cd_classe_mat_w,
             ie_tipo_mat_w
        from estrutura_material_v
        where cd_material = cd_item_w;
	exception
        when no_data_found or too_many_rows then
            cd_grupo_mat_w := 0;
	end;

	ds_item_convenio_w := ds_item_w;
	
	/* busca descricao do material para o convenio */

	begin
	open c02;
	loop
	fetch c02 into
		cd_codigo_convenio_w,
		ds_item_convenio_w,
		ie_tipo_material_conv_w;
	EXIT WHEN NOT FOUND; /* apply on c02 */
		begin
            cd_codigo_convenio_w := cd_codigo_convenio_w;
            ds_item_convenio_w := ds_item_convenio_w;
            ie_tipo_material_conv_w := ie_tipo_material_conv_w;
		end;
	end loop;
	close c02;
	end;
	end;
end if;

if (ie_cod_desc_w = 'C') then
	retorno_w := cd_codigo_convenio_w;
elsif (ie_cod_desc_w = 'D') then
	retorno_w := ds_item_convenio_w;
elsif (ie_cod_desc_w = 'M') then
	retorno_w := ie_tipo_material_conv_w;
end if;

return retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_dados_item_conv_orono (cd_convenio_p conversao_proc_convenio.cd_convenio%type, cd_categoria_p conversao_proc_convenio.cd_categoria%type, cd_plano_p conversao_proc_convenio.cd_plano%type, ie_tipo_item_p conversao_proc_convenio.ie_tipo_atendimento%type, cd_item_p conversao_proc_convenio.cd_procedimento%type, ie_origem_proced_p conversao_proc_convenio.ie_origem_proced%type, ie_estrutura_completa_p conversao_proc_convenio.ie_situacao%type, cd_especialidade_med_p conversao_proc_convenio.cd_especialidade_medica%type, ie_tipo_atendimento_p conversao_proc_convenio.ie_tipo_atendimento%type, nr_atendimento_p atendimento_paciente.nr_atendimento%type, nr_seq_proc_interno_p conversao_proc_convenio.nr_seq_proc_interno%type, nr_seq_exame_p conversao_proc_convenio.nr_seq_exame%type, ie_cod_desc_p conversao_proc_convenio.ie_situacao%type, dt_autorizacao_p autorizacao_convenio.dt_autorizacao%type) FROM PUBLIC;

