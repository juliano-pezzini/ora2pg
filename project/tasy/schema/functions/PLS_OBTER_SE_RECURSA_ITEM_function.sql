-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION pls_obter_se_recursa_item ( nr_seq_conta_p pls_conta.nr_sequencia%type, nr_seq_prestador_p pls_prestador.nr_sequencia%type) RETURNS varchar AS $body$
DECLARE


ds_retorno_w		varchar(1)	:= 'S';
qt_recurso_w		integer;
ie_exibe_portal_w	pls_lote_pagamento.ie_exibe_portal%type;

C01 CURSOR(nr_seq_conta_pc		pls_rec_glosa_conta.nr_sequencia%type) FOR
	SELECT	a.nr_sequencia,
		'P' ie_tipo_item,
		(SELECT	count(1)
		 from	pls_conta_glosa x
		 where	x.nr_seq_conta_proc = a.nr_sequencia
		 and	x.ie_situacao = 'A') qt_glosa_item,
		(select	count(1)
		 from	pls_conta_glosa x
		 where	x.nr_seq_conta = a.nr_seq_conta
		 and	coalesce(x.nr_seq_conta_proc::text, '') = ''
		 and	coalesce(x.nr_seq_conta_mat::text, '') = ''
		 and	x.ie_situacao = 'A') qt_glosa_conta,
		(select	count(1)
		 from	w_pls_recurso_glosa x
		 where	x.nr_seq_conta_mat = a.nr_sequencia
		 and	x.ie_tipo_inclusao = 'P') qt_itens_pendentes,
		(select	max(x.nr_seq_lote_pgto)
		 from	pls_conta_medica_resumo x
		 where	x.nr_seq_conta = a.nr_seq_conta
		 and	x.nr_seq_conta_proc = a.nr_sequencia) nr_seq_lote_pgto
	from	pls_conta_proc a
	where	a.nr_seq_conta = nr_seq_conta_pc
	and	a.vl_glosa > 0
	
union all

	select	a.nr_sequencia,
		'M' ie_tipo_item,
		(select	count(1)
		 from	pls_conta_glosa x
		 where	x.nr_seq_conta_mat = a.nr_sequencia
		 and	x.ie_situacao = 'A') qt_glosa_item,
		(select	count(1)
		 from	pls_conta_glosa x
		 where	x.nr_seq_conta = a.nr_seq_conta
		 and	coalesce(x.nr_seq_conta_proc::text, '') = ''
		 and	coalesce(x.nr_seq_conta_mat::text, '') = ''
		 and	x.ie_situacao = 'A') qt_glosa_conta,
		(select	count(1)
		 from	w_pls_recurso_glosa x
		 where	x.nr_seq_conta_mat = a.nr_sequencia
		 and	x.ie_tipo_inclusao = 'M') qt_itens_pendentes,
		(select	max(x.nr_seq_lote_pgto)
		 from	pls_conta_medica_resumo x
		 where	x.nr_seq_conta = a.nr_seq_conta
		 and	x.nr_seq_conta_mat = a.nr_sequencia) nr_seq_lote_pgto
	from	pls_conta_mat a
	where	a.nr_seq_conta = nr_seq_conta_pc
	and	a.vl_glosa > 0;
BEGIN

for r_C01_w in C01(nr_seq_conta_p) loop

	ds_retorno_w := 'S';

	if	(r_C01_w.qt_glosa_item = 0 AND r_C01_w.qt_glosa_conta = 0) or (r_C01_w.qt_itens_pendentes > 0) then
		ds_retorno_w := 'N';
	end if;

	if (ds_retorno_w = 'S') then
		select	coalesce(max(ie_exibe_portal),'S')
		into STRICT	ie_exibe_portal_w
		from	pls_lote_pagamento
		where	nr_sequencia = r_c01_w.nr_seq_lote_pgto;

		if (ie_exibe_portal_w = 'R') then
			ds_retorno_w := 'N';
		end if;
	end if;

	if (ds_retorno_w = 'S') then
		if (pls_obter_recursa_item_regra(r_C01_w.nr_sequencia, nr_seq_conta_p, nr_seq_prestador_p, r_C01_w.ie_tipo_item) <> 'S') then
			ds_retorno_w := 'N';
		end if;
	end if;

	if (ds_retorno_w = 'S') then
		if (r_C01_w.ie_tipo_item = 'P') then
			select 	count(1)
			into STRICT	qt_recurso_w
			from	pls_rec_glosa_proc y,
				pls_rec_glosa_conta x,
				pls_rec_glosa_protocolo w
			where 	y.nr_seq_conta_proc = r_C01_w.nr_sequencia
			and	x.nr_sequencia  = y.nr_seq_conta_rec
			and	w.nr_sequencia  = x.nr_seq_protocolo
			and	x.ie_status	!= '3'
			and	w.ie_status not in (3,4,6,10);

			if (qt_recurso_w > 0) then
				ds_retorno_w := 'N';
			end if;
		else
			select 	count(1)
			into STRICT	qt_recurso_w
			from	pls_rec_glosa_mat y,
				pls_rec_glosa_conta x,
				pls_rec_glosa_protocolo w
			where 	y.nr_seq_conta_mat = r_C01_w.nr_sequencia
			and	x.nr_sequencia  = y.nr_seq_conta_rec
			and	w.nr_sequencia  = x.nr_seq_protocolo
			and	x.ie_status	!= '3'
			and	w.ie_status not in (3,4,6,10);

			if (qt_recurso_w > 0) then
				ds_retorno_w := 'N';
			end if;
		end if;
	end if;

	if (ds_retorno_w = 'S') then
		exit;
	end if;

end loop;

return	ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION pls_obter_se_recursa_item ( nr_seq_conta_p pls_conta.nr_sequencia%type, nr_seq_prestador_p pls_prestador.nr_sequencia%type) FROM PUBLIC;

