-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_inf_hor_prescr (nr_atendimento_p bigint, nr_prescricao_p bigint, dt_inicial_p timestamp, dt_final_p timestamp, cd_material_w bigint, qt_dose_w bigint, cd_unid_med_dose_w text, cd_intervalo_w text, ie_via_w text, ie_opcao_p text) RETURNS varchar AS $body$
DECLARE


/*  IE_OPCAO_P
D =	prescr_dieta_hor
M = 	prescr_mat_hor
SNE =   prescr_mat_hor
R = 	prescr_rec_hor
*/
dt_horario_w		timestamp;
dt_horario_ant_w	timestamp := to_date('01/01/2000','dd/mm/yyyy');
ie_situacao_w 		varchar(1);
dt_horarios_w		varchar(2000) := ' ';

c01 CURSOR FOR
	SELECT	distinct h.dt_horario,
			substr(replace(obter_status_hor_prescr(h.nr_sequencia,'D'),'N',''),1,1)
	from	prescr_dieta_hor h,
		prescr_medica m
	where	h.nr_prescricao = m.nr_prescricao
	and	h.dt_horario between dt_inicial_p and dt_final_p
	and	m.nr_atendimento = nr_atendimento_p
	and	ie_opcao_p	= 'D'
	and	Obter_se_horario_liberado(h.dt_lib_horario, h.dt_horario) = 'S'
	
union all

	SELECT	distinct h.dt_horario,
		CASE WHEN replace(obter_status_hor_prescr(h.nr_sequencia,'M'),'N','')='E' THEN ''  ELSE substr(replace(obter_status_hor_prescr(h.nr_sequencia,'M'),'N',''),1,1) END
	from	prescr_material a,
		prescr_mat_hor h,
		prescr_medica m
	where	h.nr_prescricao = m.nr_prescricao
	and	a.nr_prescricao = m.nr_prescricao
	and	a.cd_material 	= h.cd_material
	and	h.dt_horario between dt_inicial_p and dt_final_p
	and	m.nr_atendimento = nr_atendimento_p
	and	((m.nr_prescricao = nr_prescricao_p)  or (nr_prescricao_p = 0))
	and	h.cd_material	= cd_material_w
	and	a.qt_dose	= qt_dose_w
	and	a.cd_unidade_medida_dose = cd_unid_med_dose_w
	and	a.cd_intervalo	= cd_intervalo_w
	and	a.ie_via_aplicacao = ie_via_w
	and	coalesce(a.ie_se_necessario,'N') = 'N'
	and	coalesce(a.ie_acm,'N') = 'N'
	and	ie_opcao_p	= 'M'
	and	Obter_se_horario_liberado(h.dt_lib_horario, h.dt_horario) = 'S'
	
union all

	select	distinct h.dt_horario,
		substr(replace(obter_status_hor_prescr(h.nr_sequencia,'R'),'N',''),1,1)
	from	prescr_recomendacao a,
		prescr_rec_hor h,
		prescr_medica m
	where	h.nr_prescricao = m.nr_prescricao
	and	a.nr_prescricao = m.nr_prescricao
	and	h.dt_horario between dt_inicial_p and dt_final_p
	and	m.nr_atendimento = nr_atendimento_p
	and	a.cd_intervalo	= cd_intervalo_w
	and	a.cd_recomendacao = cd_material_w
	and	ie_opcao_p	= 'R'
	and	Obter_se_horario_liberado(h.dt_lib_horario, h.dt_horario) = 'S'
	
union all

	select 	--distinct to_date(to_char(m.dt_prescricao,'dd/mm/yyyy') || ' ' || s.hr_prim_horario || ':00','dd/mm/yyyy hh24:mi:ss'),
		distinct h.dt_horario,
		substr(obter_status_solucao_prescr(2, a.nr_prescricao, a.nr_sequencia),1,5)
	from	prescr_material a,
		prescr_mat_hor h,
		prescr_medica m
	where	h.nr_prescricao = m.nr_prescricao
	and	a.nr_prescricao = m.nr_prescricao
	and	a.cd_material 	= h.cd_material
	and	h.dt_horario between dt_inicial_p and dt_final_p
	and	m.nr_atendimento = nr_atendimento_p
	and	h.cd_material	= cd_material_w
	and	a.qt_dose	= qt_dose_w
	and	a.cd_unidade_medida_dose = cd_unid_med_dose_w
	and	a.cd_intervalo	= cd_intervalo_w
	and	a.ie_via_aplicacao = ie_via_w
	and	ie_opcao_p	= 'SNE'
	and	Obter_se_horario_liberado(h.dt_lib_horario, h.dt_horario) = 'S'
	order by
		1;



BEGIN
open c01;
loop
fetch c01 into
	dt_horario_w,
	ie_situacao_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	begin

	if (trunc(dt_horario_ant_w) <> trunc(dt_horario_w)) then

		dt_horarios_w := dt_horarios_w || chr(13) || chr(10) || replace(to_char(dt_horario_w,'dd/mm hh24:mi'),':00','') || ie_situacao_w;
	else
		dt_horarios_w := dt_horarios_w || ' ' || replace(to_char(dt_horario_w,'hh24:mi'),':00','') || ie_situacao_w;
	end if;

	dt_horario_ant_w := dt_horario_w;

	end;
end loop;
close c01;

return	substr(dt_horarios_w,4,length(dt_horarios_w) - 3);

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_inf_hor_prescr (nr_atendimento_p bigint, nr_prescricao_p bigint, dt_inicial_p timestamp, dt_final_p timestamp, cd_material_w bigint, qt_dose_w bigint, cd_unid_med_dose_w text, cd_intervalo_w text, ie_via_w text, ie_opcao_p text) FROM PUBLIC;

