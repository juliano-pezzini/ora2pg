-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION pls_obter_dados_escrit_quota (nr_seq_escrit_quota_parc_p pls_escrit_quota_parcela.nr_sequencia%type, ie_opcao_p text) RETURNS varchar AS $body$
DECLARE

								 
/* 
ie_opcao_p 
	'NC' - Nome do cooperado 
	'NT' - Número do título 
	'EM' - E-mail do cooperado 
	'DB' - Data de emissão do bloqueto 
*/
	 
ds_retorno_w			varchar(4000)	:= null;
cd_pessoa_fisica_w		pls_cooperado.cd_pessoa_fisica%type;
cd_cgc_w			pls_cooperado.cd_cgc%type;
nr_seq_cooperado_w		pls_escrituracao_quota.nr_seq_cooperado%type;


BEGIN 
 
if (ie_opcao_p = 'NC') then 
	select	max(b.nr_seq_cooperado) 
	into STRICT	nr_seq_cooperado_w 
	from	pls_escrituracao_quota b, 
		pls_escrit_quota_parcela a 
	where	a.nr_seq_escrituracao	= b.nr_sequencia 
	and	a.nr_sequencia		= nr_seq_escrit_quota_parc_p;
 
	select	max(cd_pessoa_fisica), 
		max(cd_cgc) 
	into STRICT	cd_pessoa_fisica_w, 
		cd_cgc_w 
	from	pls_cooperado 
	where	nr_sequencia 	= nr_seq_cooperado_w;
 
	if (cd_pessoa_fisica_w IS NOT NULL AND cd_pessoa_fisica_w::text <> '') or (cd_cgc_w IS NOT NULL AND cd_cgc_w::text <> '') then 
		ds_retorno_w 		:= obter_nome_pf_pj(cd_pessoa_fisica_w, cd_cgc_w);
	end if;
 
elsif (ie_opcao_p = 'NT') then 
	select	max(b.nr_titulo) 
	into STRICT	ds_retorno_w 
	from	pls_escrit_quota_parcela b 
	where	b.nr_sequencia	= nr_seq_escrit_quota_parc_p;
	 
elsif (ie_opcao_p = 'EM') then 
	select	max(b.nr_seq_cooperado) 
	into STRICT	nr_seq_cooperado_w 
	from	pls_escrituracao_quota b, 
		pls_escrit_quota_parcela a 
	where	a.nr_seq_escrituracao	= b.nr_sequencia 
	and	a.nr_sequencia		= nr_seq_escrit_quota_parc_p;
	 
	if (nr_seq_cooperado_w IS NOT NULL AND nr_seq_cooperado_w::text <> '') then 
		begin 
		ds_retorno_w := substr(pls_obter_dados_cooperado(nr_seq_cooperado_w,'EM'),1,4000);
		exception 
		when others then 
			ds_retorno_w := null;
		end;
	end if;
 
elsif (ie_opcao_p = 'DB') then 
	select	max(c.dt_atualizacao_nrec) 
	into STRICT	ds_retorno_w 
	from	pls_escrit_quota_parcela	b, 
		titulo_receber			a, 
		titulo_receber_bloqueto		c 
	where	a.nr_titulo	= b.nr_titulo 
	and	a.nr_titulo	= c.nr_titulo 
	and	b.nr_sequencia	= nr_seq_escrit_quota_parc_p;
end if;
 
return	ds_retorno_w;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION pls_obter_dados_escrit_quota (nr_seq_escrit_quota_parc_p pls_escrit_quota_parcela.nr_sequencia%type, ie_opcao_p text) FROM PUBLIC;

