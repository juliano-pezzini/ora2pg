-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_immunization_status (nr_sequencia_p bigint , nr_seq_vac_modelo_p bigint default null) RETURNS bigint AS $body$
DECLARE


ie_retorno_w		bigint;
ie_executed_w    varchar(1);
dt_vacina_w  timestamp;
dt_prevista_execucao_w timestamp;
ie_dose_w varchar(2);
dt_liberacao_w timestamp;
ie_localidade_inf_w varchar(1);
dt_cancelamento_w timestamp;
DT_INATIVACAO_w timestamp;
IE_SITUACAO_w varchar(1);
ie_dose_inicio_w vacinas_modelo.ie_dose_inicio%type;

ano_1_w bigint;
ano_2_w bigint;

qt_ano_w bigint;


BEGIN

ie_retorno_w := 2;

if (nr_sequencia_p IS NOT NULL AND nr_sequencia_p::text <> '') then

select ie_executado ,dt_vacina,dt_prevista_execucao,ie_dose,dt_liberacao,ie_localidade_inf ,dt_cancelamento,DT_INATIVACAO, ie_situacao
into STRICT ie_executed_w,dt_vacina_w,dt_prevista_execucao_w,ie_dose_w ,dt_liberacao_w,ie_localidade_inf_w ,dt_cancelamento_w,DT_INATIVACAO_w, IE_SITUACAO_w
from paciente_vacina where nr_sequencia = nr_sequencia_p;

 ano_1_w := PKG_DATE_UTILS.extract_field('YEAR',dt_vacina_w);
 ano_2_w := PKG_DATE_UTILS.extract_field('YEAR',dt_prevista_execucao_w);

 if ((nr_seq_vac_modelo_p IS NOT NULL AND nr_seq_vac_modelo_p::text <> '') and nr_seq_vac_modelo_p <> 0) then
     select max(qt_anos_prim_dose), coalesce(max(ie_dose_inicio),'1D')
     into STRICT qt_ano_w, ie_dose_inicio_w
     from vacinas_modelo where nr_sequencia = nr_seq_vac_modelo_p
     and coalesce(ie_dose_inicio, '1D') = ie_dose_w;
 end if;

if (ie_executed_w = 'S' and ((ie_dose_w = ie_dose_inicio_w and (qt_ano_w IS NOT NULL AND qt_ano_w::text <> '') and ano_1_w <= ano_2_w)
    or ((dt_vacina_w IS NOT NULL AND dt_vacina_w::text <> '') 
        and ((ie_dose_w = ie_dose_inicio_w and PKG_DATE_UTILS.get_Date(1,dt_vacina_w) <= PKG_DATE_UTILS.get_Date(1,dt_prevista_execucao_w)) or ((dt_prevista_execucao_w IS NOT NULL AND dt_prevista_execucao_w::text <> '') and dt_vacina_w <= dt_prevista_execucao_w))))) then
    ie_retorno_w := 5;

elsif (ie_executed_w = 'S' and dt_vacina_w > dt_prevista_execucao_w ) then 

    ie_retorno_w := 6;

elsif (coalesce(dt_vacina_w::text, '') = '' and  (dt_prevista_execucao_w IS NOT NULL AND dt_prevista_execucao_w::text <> '') and dt_prevista_execucao_w < clock_timestamp()) then
  
    ie_retorno_w := 3;

elsif ((coalesce(dt_vacina_w::text, '') = '' and  (dt_prevista_execucao_w IS NOT NULL AND dt_prevista_execucao_w::text <> '') and dt_prevista_execucao_w >= clock_timestamp()) or (coalesce(dt_vacina_w::text, '') = '' and  coalesce(dt_prevista_execucao_w::text, '') = '')  ) then

    ie_retorno_w := 2;

elsif (dt_liberacao_w IS NOT NULL AND dt_liberacao_w::text <> '') then
    ie_retorno_w := 7;

end if;

  if (IE_SITUACAO_w = 'I' and  (DT_INATIVACAO_w IS NOT NULL AND DT_INATIVACAO_w::text <> '')) then
       ie_retorno_w := 8;
  elsif (dt_cancelamento_w IS NOT NULL AND dt_cancelamento_w::text <> '') then
      ie_retorno_w := 4;
  end if;
end if;
return	ie_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_immunization_status (nr_sequencia_p bigint , nr_seq_vac_modelo_p bigint default null) FROM PUBLIC;

