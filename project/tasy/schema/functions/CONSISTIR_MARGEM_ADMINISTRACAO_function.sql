-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION consistir_margem_administracao ( nr_seq_horario_p bigint, ie_tipo_item_p text, dt_horario_adm_p timestamp, qt_min_margem_p bigint, cd_perfil_p bigint, ie_opcao_p text, qt_min_margem_ant_p bigint default null, nr_prescricao_p bigint DEFAULT NULL, dt_horario_p timestamp DEFAULT NULL, ie_html_p text default 'N') RETURNS varchar AS $body$
DECLARE

/*
ie_opcao_p
	M - Margem em minutos
	S - Se esta na margem ou nao
	C - Consistiu "antes" ou "depois"	
*/
ie_margem_w		varchar(1) := 'S';
ie_tipo_margem_w	varchar(1);
dt_horario_w		timestamp;
qt_min_adm_w		bigint;
qt_min_margem_apos_w	bigint; -- Parametro 12 - ADEP
qt_min_margem_ant_w	bigint; -- Parametro - ADEP
qt_min_margem_just_w    bigint; -- Parametro - ADEP
cd_material_w		bigint;
ie_checagem_w		varchar(1);
dt_inicio_prescr_w	timestamp;
dt_validade_prescr_w	timestamp;
cd_subgrupo_mat_w	integer;
cd_grupo_mat_w		integer;
cd_classe_mat_w		integer;
ie_gas_horario_w	varchar(1);
cd_estabelecimento_w	bigint;
cd_setor_atendimento_w  setor_atendimento.cd_setor_atendimento%type;
nr_atendimento_w    prescr_medica.nr_atendimento%type;
nr_seq_gas_cpoe_w   cpoe_gasoterapia.nr_sequencia%type;


BEGIN
qt_min_margem_apos_w	:= coalesce(qt_min_margem_p,0);
qt_min_margem_ant_w	:= coalesce(qt_min_margem_ant_p,0);
qt_min_margem_just_w 	:= 0;
ie_margem_w := 'S';

if (nr_seq_horario_p IS NOT NULL AND nr_seq_horario_p::text <> '') and (ie_tipo_item_p IS NOT NULL AND ie_tipo_item_p::text <> '') and (dt_horario_adm_p IS NOT NULL AND dt_horario_adm_p::text <> '') and
	((qt_min_margem_p > 0) or (qt_min_margem_ant_w > 0)) then

    select  max(a.nr_atendimento)
    into STRICT    nr_atendimento_w
    from    prescr_medica a,
            prescr_mat_hor b
    where   a.nr_prescricao = b.nr_prescricao
    and     b.nr_sequencia = nr_seq_horario_p;
    
    if (coalesce(nr_atendimento_w::text, '') = '') then
        select  max(a.nr_atendimento)
        into STRICT    nr_atendimento_w
        from    prescr_medica a
        where   a.nr_prescricao = nr_prescricao_p;
    end if;

    cd_setor_atendimento_w := Obter_Unidade_Atendimento( nr_atendimento_p 	=> nr_atendimento_w,
							 ie_opcao_p 		=> 'A',
							 ie_informacao_p	=> 'CS');

	/* obter horario */

	if (ie_tipo_item_p in ('M','MAT','S','LD','SNE')) then		
		select	max(dt_horario),
			coalesce(max(ie_checagem),'N'),
			max(cd_material)
		into STRICT	dt_horario_w,
			ie_checagem_w,
			cd_material_w
		from	prescr_mat_hor
		where	nr_sequencia = nr_seq_horario_p
		and	Obter_se_horario_liberado(dt_lib_horario, dt_horario) = 'S';

		select	max(cd_grupo_material),
			max(cd_subgrupo_material),
			max(cd_classe_material)
		into STRICT	cd_grupo_mat_w,
			cd_subgrupo_mat_w,
			cd_classe_mat_w
		from	estrutura_material_v
		where	cd_material	= cd_material_w;

		select	coalesce(max(qt_minutos), 0),
                coalesce(max(qt_minutos_ant), qt_min_margem_ant_w),
                coalesce(max(qt_minutos_just), 0)
		into STRICT	qt_min_margem_apos_w,
                qt_min_margem_ant_w,
                qt_min_margem_just_w
		from	adep_regra_margem_adm
		where	coalesce(cd_perfil, cd_perfil_p) = cd_perfil_p
		and	    coalesce(cd_material,cd_material_w)	= cd_material_w
		and	    coalesce(cd_grupo_material,cd_grupo_mat_w)		= cd_grupo_mat_w
		and	    coalesce(cd_subgrupo_material,cd_subgrupo_mat_w)	= cd_subgrupo_mat_w
		and	    coalesce(cd_classe_material,cd_classe_mat_w)		= cd_classe_mat_w
        and     ((cd_setor_atendimento = cd_setor_atendimento_w) or (coalesce(cd_setor_atendimento::text, '') = ''));

		if (qt_min_margem_apos_w = 0 and (qt_min_margem_just_w = 0 or ie_html_p = 'N')) then
		    qt_min_margem_apos_w := qt_min_margem_p;
		    qt_min_margem_just_w := 0;
		elsif (qt_min_margem_just_w > 0 and ie_html_p = 'S') then
		    qt_min_margem_apos_w := 0;
		end if;

	--elsif	(ie_tipo_item_p = 'P') then
	elsif (ie_tipo_item_p in ('P','G','C','HM','I')) then
		select	max(dt_horario),
			coalesce(max(ie_checagem),'N')
		into STRICT	dt_horario_w,
			ie_checagem_w
		from	prescr_proc_hor
		where	nr_sequencia = nr_seq_horario_p
		and	Obter_se_horario_liberado(dt_lib_horario, dt_horario) = 'S';
	elsif (ie_tipo_item_p = 'R') then
		select	max(dt_horario),
			coalesce(max(ie_checagem),'N')
		into STRICT	dt_horario_w,
			ie_checagem_w
		from	prescr_rec_hor
		where	nr_sequencia = nr_seq_horario_p
		and	Obter_se_horario_liberado(dt_lib_horario, dt_horario) = 'S';
	elsif (ie_tipo_item_p = 'E') then
		select	max(dt_horario),
			coalesce(max(ie_checagem),'N')
		into STRICT	dt_horario_w,
			ie_checagem_w
		from	pe_prescr_proc_hor
		where	nr_sequencia = nr_seq_horario_p;	
	elsif (ie_tipo_item_p = 'D') or (ie_tipo_item_p = 'DE') then
		select	max(dt_horario),
			coalesce(max(ie_checagem),'N')
		into STRICT	dt_horario_w,
			ie_checagem_w
		from	prescr_dieta_hor
		where	nr_sequencia = nr_seq_horario_p
		and	Obter_se_horario_liberado(dt_lib_horario, dt_horario) = 'S';
	elsif (ie_tipo_item_p = 'O') then	
		if (coalesce(nr_seq_horario_p,0)	= 0) then
			if (coalesce(nr_prescricao_p,0)	> 0) then
                select	max(b.nr_sequencia)
                into STRICT	nr_seq_gas_cpoe_w
                from	prescr_gasoterapia a,
                        cpoe_gasoterapia b
                where   a.nr_seq_gas_cpoe = b.nr_sequencia
                and     a.nr_prescricao	= nr_prescricao_p;

                select	max(a.dt_inicio_prescr)
                into STRICT	dt_inicio_prescr_w
                from	prescr_medica a
                where	a.nr_prescricao	= nr_prescricao_p;

                select	min(b.dt_horario),
                        max('N')
                into STRICT	dt_horario_w,
                        ie_checagem_w
                from	prescr_gasoterapia	a,
                        prescr_gasoterapia_hor b,
                        cpoe_gasoterapia c
                where	a.nr_prescricao = b.nr_prescricao
                and	    a.nr_sequencia = b.nr_seq_gasoterapia
                and     c.nr_sequencia = a.nr_seq_gas_cpoe
                and     a.nr_seq_gas_cpoe = nr_seq_gas_cpoe_w
                and     b.dt_horario > dt_inicio_prescr_w
                and     coalesce(b.dt_fim_horario::text, '') = ''
                and     coalesce(b.dt_suspensao::text, '') = ''
                and     coalesce(b.ie_horario_especial, 'N') = 'N';

                if (coalesce(dt_horario_w::text, '') = '') then
                    select	max(c.dt_liberacao),
                            max(a.dt_validade_prescr),
                            max('N')
                    into STRICT	dt_inicio_prescr_w,
                            dt_validade_prescr_w,
                            ie_checagem_w
                    from	prescr_medica a,
                            prescr_gasoterapia b,
                            cpoe_gasoterapia c
                    where   b.nr_seq_gas_cpoe = c.nr_sequencia 	
                    and     a.nr_prescricao = b.nr_prescricao
                    and     a.nr_prescricao	= nr_prescricao_p;

                    if (coalesce(dt_inicio_prescr_w::text, '') = '') then
                        select	max(a.dt_inicio_prescr),
                                max(a.dt_validade_prescr),
                                max('N')
                        into STRICT	dt_inicio_prescr_w,
                                dt_validade_prescr_w,
                                ie_checagem_w
                        from	prescr_medica a
                        where	a.nr_prescricao	= nr_prescricao_p;
                    end if;
                end if;
			else
				ie_checagem_w	:= 'L';
			end if;
		else
			select 	cd_estabelecimento
			into STRICT	cd_estabelecimento_w
			from	prescr_medica
			where	nr_prescricao = nr_prescricao_p;
			ie_gas_horario_w := obter_param_usuario(1113, 538, cd_perfil_p, wheb_usuario_pck.get_nm_usuario, cd_estabelecimento_w, ie_gas_horario_w);
			if (ie_gas_horario_w = 'N') then
                select	max(c.dt_liberacao),
                        max('N')
                into STRICT	dt_inicio_prescr_w,
                        ie_checagem_w
                from	prescr_medica a,
                        prescr_gasoterapia b,
                        cpoe_gasoterapia c
                where   a.nr_prescricao = b.nr_prescricao
                and     b.nr_seq_gas_cpoe = c.nr_sequencia 	
                and     a.nr_prescricao	= nr_prescricao_p;

                if (coalesce(dt_inicio_prescr_w::text, '') = '') then
                    select  max(coalesce(a.dt_prev_execucao, b.dt_inicio_prescr)),
                            max('N')
                    into STRICT	dt_inicio_prescr_w,
                            ie_checagem_w
                    from	prescr_gasoterapia a,
                            prescr_medica b
                    where   b.nr_prescricao = a.nr_prescricao		
                    and	    a.nr_prescricao = nr_prescricao_p;
                end if;
			elsif (ie_gas_horario_w = 'S') then
				select	max(dt_horario),
					max('N')
				into STRICT	dt_horario_w,
					ie_checagem_w
				from	prescr_gasoterapia_hor
				where	nr_sequencia = nr_seq_horario_p
				and	Obter_se_horario_liberado(dt_lib_horario, dt_horario) = 'S';
			end if;
		end if;
	elsif (ie_tipo_item_p	= 'SOL') and (dt_horario_p IS NOT NULL AND dt_horario_p::text <> '') then
		dt_horario_w	:= dt_horario_p;
		ie_checagem_w	:= 'N';
	end if;
	if (ie_checagem_w <> 'L') then
		--select	trunc(abs(sysdate - dt_horario_w) * 1440)

	/* obter margem adm */

		if	((qt_min_margem_apos_w > 0) or (qt_min_margem_ant_w > 0) or (qt_min_margem_just_w > 0)) then
			if (ie_tipo_item_p			= 'O') and (coalesce(nr_seq_horario_p,0)	= 0) and (coalesce(dt_horario_w::text, '') = '') then
				if (dt_horario_adm_p > dt_validade_prescr_w) then
					select	trunc(abs(dt_horario_adm_p - dt_validade_prescr_w) * 1440)
					into STRICT	qt_min_adm_w
					;
					/* validar horario x margem */

          if (qt_min_adm_w <= qt_min_margem_apos_w AND qt_min_margem_apos_w > 0) then
						ie_margem_w := 'S';
						ie_tipo_margem_w := 'D';
          elsif ((qt_min_adm_w <= (qt_min_margem_apos_w + qt_min_margem_just_w)) and (qt_min_margem_just_w > 0)) then
						ie_margem_w := 'S';
						ie_tipo_margem_w := 'J';
          else
						ie_margem_w := 'N';
						ie_tipo_margem_w := 'D';
          end if;

				elsif (dt_horario_adm_p < dt_inicio_prescr_w) then
					select	trunc(abs(dt_inicio_prescr_w - dt_horario_adm_p) * 1440)
					into STRICT	qt_min_adm_w
					;
					/* validar horario x margem */

					if (qt_min_adm_w > qt_min_margem_ant_w) and (qt_min_margem_ant_w > 0) then
						ie_margem_w := 'N';
						ie_tipo_margem_w := 'A';
					end if;
				end if;			
			elsif (dt_horario_adm_p > dt_horario_w) then
				select	trunc(abs(dt_horario_adm_p - dt_horario_w) * 1440)
				into STRICT	qt_min_adm_w
				;
				/* validar horario x margem */

          if (qt_min_adm_w <= qt_min_margem_apos_w AND qt_min_margem_apos_w > 0) then
						ie_margem_w := 'S';
						ie_tipo_margem_w := 'D';
          elsif ((qt_min_adm_w <= (qt_min_margem_apos_w + qt_min_margem_just_w)) and (qt_min_margem_just_w > 0)) then
						ie_margem_w := 'S';
						ie_tipo_margem_w := 'J';
          else
						ie_margem_w := 'N';
						ie_tipo_margem_w := 'D';
          end if;

			elsif (dt_horario_adm_p < dt_horario_w) then
				select	trunc(abs(dt_horario_w - dt_horario_adm_p) * 1440)
				into STRICT	qt_min_adm_w
				;
				/* validar horario x margem */

				if (qt_min_adm_w > qt_min_margem_ant_w) and (qt_min_margem_ant_w > 0) then
					ie_margem_w := 'N';
					ie_tipo_margem_w := 'A';
				end if;
			end if;
		end if;	
	else
		ie_margem_w := 'S';
	end if;
end if;
if (coalesce(nr_seq_horario_p,0) = 0) and (ie_tipo_item_p = 'HM')  then
	if (dt_horario_adm_p > clock_timestamp()) then
		select	trunc(abs(dt_horario_adm_p - clock_timestamp()) * 1440)
		into STRICT	qt_min_adm_w
		;
		/* validar horario x margem */

    if (qt_min_adm_w <= qt_min_margem_apos_w AND qt_min_margem_apos_w > 0) then
      ie_margem_w := 'S';
      ie_tipo_margem_w := 'D';
    elsif ((qt_min_adm_w <= (qt_min_margem_apos_w + qt_min_margem_just_w)) and (qt_min_margem_just_w > 0)) then
      ie_margem_w := 'S';
      ie_tipo_margem_w := 'J';
    else
      ie_margem_w := 'N';
      ie_tipo_margem_w := 'D';
    end if;

	elsif (dt_horario_adm_p < clock_timestamp()) then
		select	trunc(abs(clock_timestamp() - dt_horario_adm_p) * 1440)
		into STRICT	qt_min_adm_w
		;
		/* validar horario x margem */

		if (qt_min_adm_w > qt_min_margem_ant_w) and (qt_min_margem_ant_w > 0) then
			ie_margem_w := 'N';
			ie_tipo_margem_w := 'A';
		end if;
	end if;
end if;
if (ie_opcao_p	in ('M','MAT')) then
	if (ie_tipo_margem_w	= 'D' or ie_tipo_margem_w	= 'J') then
		return to_char(qt_min_margem_apos_w + qt_min_margem_just_w);
	elsif (ie_tipo_margem_w	= 'A') then
		return to_char(qt_min_margem_ant_w);
	end if;
elsif (ie_opcao_p	= 'S') then
	return ie_margem_w;
else	
	return ie_tipo_margem_w;
end if;
return null; --Garantir que havera algum retorno para nao gerar erro.
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION consistir_margem_administracao ( nr_seq_horario_p bigint, ie_tipo_item_p text, dt_horario_adm_p timestamp, qt_min_margem_p bigint, cd_perfil_p bigint, ie_opcao_p text, qt_min_margem_ant_p bigint default null, nr_prescricao_p bigint DEFAULT NULL, dt_horario_p timestamp DEFAULT NULL, ie_html_p text default 'N') FROM PUBLIC;

