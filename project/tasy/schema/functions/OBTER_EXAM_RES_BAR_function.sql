-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_exam_res_bar (nr_atendimento_p atendimento_paciente.nr_atendimento%type) RETURNS varchar AS $body$
DECLARE

ds_retorno_w		varchar(32000);
ds_exam_w varchar(250);

C01 CURSOR FOR
SELECT
 distinct
substr(NM_EXAME,1,150) ||': '|| coalesce(CASE WHEN c.ds_resultado='0' THEN null  ELSE CASE WHEN d.ie_formato_resultado='V' THEN null  ELSE c.ds_resultado END  END ,to_char(c.qt_resultado),to_char(CASE WHEN c.pr_resultado=0 THEN null  ELSE c.pr_resultado END ),c.ds_resultado)val
	from	exame_laboratorio d,
		exame_lab_result_item c,
		exame_lab_resultado b,
        result_laboratorio a
	where	b.nr_seq_resultado	= c.nr_seq_resultado
	  and	d.nr_seq_exame 		= c.nr_seq_exame
	  and nr_atendimento	= nr_atendimento_p
       and a.nr_prescricao=b.nr_prescricao
        and ((c.ds_resultado IS NOT NULL AND c.ds_resultado::text <> '') or (c.qt_resultado IS NOT NULL AND c.qt_resultado::text <> '') or (c.pr_resultado IS NOT NULL AND c.pr_resultado::text <> '') )
;



BEGIN

open c01;
loop
fetch c01 into
		ds_exam_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	begin
	if (coalesce(ds_retorno_w::text, '') = '') then
		ds_retorno_w := ds_exam_w;
	else
		ds_retorno_w := ds_retorno_w || ', ' || ds_exam_w;

	end if;
	end;
end loop;
close c01;


return	ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_exam_res_bar (nr_atendimento_p atendimento_paciente.nr_atendimento%type) FROM PUBLIC;

