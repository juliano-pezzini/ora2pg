-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_dados_pf_pj_estab ( cd_estabelecimento_p bigint, cd_pessoa_fisica_p text, cd_cgc_p text, ie_opcao_p text) RETURNS varchar AS $body$
DECLARE


/* Opcao para dados referentes ao estabelecimento
ECP - Condicao de pagamento
EFP - Forma de pagamento
ENC - Contato
ENR - Ramal
M   - Email
ECQ - Classificacao qualidade
EPE - Prazo de entrega
EVM - Valor minimo NF
ERF - Referencia fornecedor
ECD - Conta diferente nota fiscal
ATIV - Codigo da atividade prestada
TDO - Taxa desconto ordem
TDF - Taxa desconto financeiro
ISS -  Tipo de Retencao de ISS
MCOM - E-mail com restircao 'Receber e-mail comercial'
*/
cd_cond_pagto_w			pessoa_juridica.cd_cond_pagto%type;
ie_forma_pagto_w		pessoa_juridica_estab.ie_forma_pagto%type;
nr_ramal_contato_w		pessoa_juridica.nr_ramal_contato%type;
nm_pessoa_contato_w		pessoa_juridica.nm_pessoa_contato%type;
ds_email_w			pessoa_juridica_estab.ds_email%type;
ie_qualidade_w			pessoa_juridica_estab.ie_qualidade%type;
vl_minimo_nf_w			pessoa_juridica.vl_minimo_nf%type;
qt_dia_prazo_entrega_w		pessoa_juridica.qt_dia_prazo_entrega%type;
cd_referencia_fornec_w		pessoa_juridica.cd_referencia_fornec%type;
ie_conta_dif_nf_w		pessoa_juridica_estab.ie_conta_dif_nf%type;
ds_retorno_w			varchar(254);

/* Campos referente ao fornecedor - somente ate eles permanecerem na tabela pessoa_juridica*/

cd_cond_pagto_ww		pessoa_juridica.cd_cond_pagto%type;
nm_pessoa_contato_ww		pessoa_juridica.nm_pessoa_contato%type;
nr_ramal_contato_ww		pessoa_juridica.nr_ramal_contato%type;
ds_email_ww			pessoa_juridica_estab.ds_email%type;
ie_qualidade_ww			pessoa_juridica_estab.ie_qualidade%type;
qt_dia_prazo_entrega_ww		pessoa_juridica.qt_dia_prazo_entrega%type;
vl_minimo_nf_ww			pessoa_juridica.vl_minimo_nf%type;
cd_referencia_fornec_ww		pessoa_juridica.cd_referencia_fornec%type;
nr_codigo_serv_prest_w		pessoa_juridica_estab.nr_codigo_serv_prest%type;
qt_existe_w			smallint;
tx_desc_ordem_w			pessoa_juridica_estab.tx_desc_ordem%type;
pr_desc_financeiro_w		pessoa_juridica_estab.pr_desc_financeiro%type;
ie_retem_iss_w			pessoa_juridica_estab.ie_retem_iss%type;
qt_regristro_w			bigint;


BEGIN

if (coalesce(cd_estabelecimento_p::text, '') = '') or
/*	((cd_pessoa_fisica_p is not null and cd_pessoa_fisica_p <> '')) then Alterado pelo Anderson em 16/02/2009 - Nao funcionava no Sadalla*/

	(coalesce(cd_pessoa_fisica_p,'X') <> 'X') then
	begin
	select	substr(obter_dados_pf_pj(cd_pessoa_fisica_p, cd_cgc_p, ie_opcao_p),1,254)
	into STRICT	ds_retorno_w
	;
	return	ds_retorno_w;
	end;
else
	begin
	select	cd_cond_pagto,
		nm_pessoa_contato,
		nr_ramal_contato,
		ds_email,
		ie_qualidade,
		qt_dia_prazo_entrega,
		vl_minimo_nf,
		cd_referencia_fornec
	into STRICT	cd_cond_pagto_ww,
		nm_pessoa_contato_ww,
		nr_ramal_contato_ww,
		ds_email_ww,
		ie_qualidade_ww,
		qt_dia_prazo_entrega_ww,
		vl_minimo_nf_ww,
		cd_referencia_fornec_ww
	from	pessoa_juridica
	where	cd_cgc 	= cd_cgc_p;

	select	count(*)
	into STRICT	qt_existe_w
	from	pessoa_juridica_estab
	where	cd_cgc 			= cd_cgc_p
	and	cd_estabelecimento	= cd_estabelecimento_p;
	if (qt_existe_w = 0) then
		cd_cond_pagto_w		:= cd_cond_pagto_ww;
		nm_pessoa_contato_w	:= nm_pessoa_contato_ww;
		nr_ramal_contato_w	:= nr_ramal_contato_ww;
		ds_email_w		:= ds_email_ww;
		ie_qualidade_w		:= ie_qualidade_ww;
		qt_dia_prazo_entrega_w	:= qt_dia_prazo_entrega_ww;
		vl_minimo_nf_w		:= vl_minimo_nf_ww;
		cd_referencia_fornec_w	:= cd_referencia_fornec_ww;
	else
		begin	
		select	coalesce(cd_cond_pagto, cd_cond_pagto_ww),
			ie_forma_pagto,
			coalesce(nm_pessoa_contato, nm_pessoa_contato_ww),
			coalesce(nr_ramal_contato, nr_ramal_contato_ww),
			coalesce(ds_email, ds_email_ww),
			coalesce(ie_qualidade, ie_qualidade_ww),
			coalesce(qt_dia_prazo_entrega, qt_dia_prazo_entrega_ww),
			coalesce(vl_minimo_nf, vl_minimo_nf_ww),
			coalesce(cd_referencia_fornec, cd_referencia_fornec_ww),
			coalesce(ie_conta_dif_nf, 'N'),
			coalesce(tx_desc_ordem,0),
			coalesce(pr_desc_financeiro,0),
			nr_codigo_serv_prest,
			ie_retem_iss
		into STRICT	cd_cond_pagto_w,
			ie_forma_pagto_w,
			nm_pessoa_contato_w,
			nr_ramal_contato_w,
			ds_email_w,
			ie_qualidade_w,
			qt_dia_prazo_entrega_w,
			vl_minimo_nf_w,
			cd_referencia_fornec_w,
			ie_conta_dif_nf_w,
			tx_desc_ordem_w,
			pr_desc_financeiro_w,
			nr_codigo_serv_prest_w,
			ie_retem_iss_w
		from	pessoa_juridica_estab
		where	cd_cgc 			= cd_cgc_p
		and	cd_estabelecimento	= cd_estabelecimento_p;	
		end;
	end if;

	/* Tratamento realizado para operadoras - OS 365827 */

	if (cd_cgc_p IS NOT NULL AND cd_cgc_p::text <> '') then
		select	count(*)
		into STRICT	qt_regristro_w
		from	pls_congenere  
		where	cd_cgc 		   = cd_cgc_p
		and 	cd_estabelecimento = cd_estabelecimento_p;

		ds_email_ww := ds_email_w;

		if (qt_regristro_w > 0) then
			select	coalesce(max(ds_email),ds_email_ww)
			into STRICT	ds_email_w
			from	pessoa_juridica_compl
			where	ie_tipo_complemento = 8
			and	cd_cgc 		    = cd_cgc_p;			
		end if;
	end if;

	if (ie_opcao_p = 'ECP') then
		return cd_cond_pagto_w;
	elsif (ie_opcao_p = 'EFP') then
		return ie_forma_pagto_W;
	elsif (ie_opcao_p = 'ENC') then
		return nm_pessoa_contato_w;
	elsif (ie_opcao_p = 'ENR') then
		return nr_ramal_contato_w;
	elsif (ie_opcao_p = 'M') then
		return ds_email_w;
	elsif (ie_opcao_p = 'ECQ') then
		return ie_qualidade_w;
	elsif (ie_opcao_p = 'EPE') then
		return qt_dia_prazo_entrega_w;
	elsif (ie_opcao_p = 'EVM') then
		return vl_minimo_nf_w;
	elsif (ie_opcao_p = 'ERF') then
		return cd_referencia_fornec_w;
	elsif (ie_opcao_p = 'ECD') then
		return ie_conta_dif_nf_w;
	elsif (ie_opcao_p = 'ATIV') then
		return nr_codigo_serv_prest_w;
	elsif (ie_opcao_p = 'ISS') then
		return ie_retem_iss_w;	
	elsif (ie_opcao_p = 'TDO') then
		return tx_desc_ordem_w;
	elsif (ie_opcao_p = 'TDF') then
		return 	pr_desc_financeiro_w;
	elsif (ie_opcao_p = 'MCOM') then
		begin
		select	coalesce(a.ds_email,'')
		into STRICT	ds_email_w
		from	pessoa_juridica_estab a
		where	a.cd_cgc 			= cd_cgc_p
		and	a.cd_estabelecimento		= cd_estabelecimento_p
		and	a.ie_rec_email_comercial	= 'S';
		return ds_email_w;
		end;
	else
		begin
		select	substr(obter_dados_pf_pj(cd_pessoa_fisica_p, cd_cgc_p, ie_opcao_p),1,254)
		into STRICT	ds_retorno_w
		;
		return	ds_retorno_w;
		end;
	end if;
	end;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_dados_pf_pj_estab ( cd_estabelecimento_p bigint, cd_pessoa_fisica_p text, cd_cgc_p text, ie_opcao_p text) FROM PUBLIC;

