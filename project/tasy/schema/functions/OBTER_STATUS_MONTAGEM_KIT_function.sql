-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_status_montagem_kit ( nr_seq_kit_Estoque_p bigint) RETURNS varchar AS $body$
DECLARE


ie_status_w	varchar(15);


BEGIN
begin
select	'UT'
into STRICT	ie_status_w
from	kit_estoque
where	nr_sequencia = nr_seq_kit_Estoque_p
and	(dt_utilizacao IS NOT NULL AND dt_utilizacao::text <> '');
exception
when others then
	ie_status_w := null;
end;

if (coalesce(ie_status_w,'X') = 'X') then
	begin

	begin
	select	max(ie_status)
	into STRICT	ie_status_w
	from (SELECT	'DI' ie_status
		from	kit_estoque a,
			requisicao_material b,
			item_requisicao_material c
		where	a.nr_sequencia = nr_seq_kit_Estoque_p
		and	b.nr_requisicao = c.nr_requisicao
		and	a.nr_sequencia = c.nr_seq_kit_estoque
		and	b.ie_origem_requisicao = 'DKT'
		and	(a.cd_setor_destino IS NOT NULL AND a.cd_setor_destino::text <> '')
		
union all

		SELECT	null ie_status
		from	kit_estoque a,
			requisicao_material b,
			item_requisicao_material c
		where	a.nr_sequencia = nr_seq_kit_Estoque_p
		and	b.nr_requisicao = c.nr_requisicao
		and	a.nr_seq_kit_origem = c.nr_seq_kit_estoque
		and	b.ie_origem_requisicao = 'RKT'  LIMIT 1) alias4;
	exception
	when others then
		ie_status_w := null;
	end;

	if (coalesce(ie_status_w,'X') = 'X') then
		begin
		begin
		select	null
		into STRICT	ie_status_w
		from	kit_estoque_comp
		where	nr_seq_kit_Estoque = nr_seq_kit_Estoque_p  LIMIT 1;
		exception
		when others then
			ie_status_w := 'PS';
		end;

		if (coalesce(ie_status_w,'X') = 'X') then
			begin
			select	'PS'
			into STRICT	ie_status_w
			from	kit_estoque_comp
			where	nr_seq_kit_Estoque = nr_seq_kit_Estoque_p
			and	coalesce(ie_gerado_barras,'X') = 'N'  LIMIT 1;
			exception
			when others then
				ie_status_w := 'PD';
			end;
		end if;
		end;
	end if;

	end;
elsif (ie_status_w = 'UT') and (coalesce(obter_requisicao_reposicao_kit(nr_seq_kit_Estoque_p),0) > 0) then

	select	coalesce(max('FI'),ie_status_w)
	into STRICT	ie_status_w
	from	kit_estoque
	where	nr_seq_kit_origem = nr_seq_kit_Estoque_p;

end if;

return	ie_status_w;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_status_montagem_kit ( nr_seq_kit_Estoque_p bigint) FROM PUBLIC;

