-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION gerar_json_pacs ( nr_prescricao_p prescr_procedimento.nr_prescricao%TYPE, nr_seq_prescricao_p prescr_procedimento.nr_sequencia%TYPE, nr_prontuario_p bigint) RETURNS varchar AS $body$
DECLARE


ds_json_pacs_w			             varchar(4000);
nr_prescricao_w                      prescr_procedimento.nr_prescricao%TYPE NOT NULL := nr_prescricao_p;
nr_seq_prescricao_w                  prescr_procedimento.nr_sequencia%TYPE NOT NULL := nr_seq_prescricao_p;
nr_prontuario_w                      pessoa_fisica.nr_prontuario%TYPE NOT NULL := nr_prontuario_p;
ds_url_pacs_w                        PARAMETRO_MEDICO.ds_url_pacs%type;
nm_usuario_carestream_w              funcao_parametro.vl_parametro%type;
ds_senha_carestream_w	             funcao_parametro.vl_parametro%type;
ds_pront_seq_w						 funcao_parametro.vl_parametro%type;
nr_seq_agenda_w		                 prescr_procedimento.nr_seq_agenda%type;
cd_funcao_w                          funcao_parametro.cd_funcao%type := 281;
nr_seq_nm_usuario_w                  funcao_parametro.NR_SEQUENCIA%type := 1550;
nr_seq_ds_senha_w                    funcao_parametro.NR_SEQUENCIA%type := 1551;
nr_seq_pront_seq_w                   funcao_parametro.NR_SEQUENCIA%type := 1554;
nr_acesso_dicom_w                 prescr_procedimento.nr_acesso_dicom%TYPE;
cd_pessoa_fisica_w                prescr_medica.cd_pessoa_fisica%TYPE;


BEGIN

    select Wheb_assist_pck.obterParametroFuncao(cd_funcao_w, nr_seq_nm_usuario_w) into STRICT nm_usuario_carestream_w;
    select Wheb_assist_pck.obterParametroFuncao(cd_funcao_w, nr_seq_ds_senha_w) into STRICT ds_senha_carestream_w;
	select Wheb_assist_pck.obterParametroFuncao(cd_funcao_w, nr_seq_pront_seq_w) into STRICT ds_pront_seq_w;

    select	max(a.nr_seq_agenda),
            max(a.NR_ACESSO_DICOM),
            max(b.cd_pessoa_fisica)
    into STRICT	  nr_seq_agenda_w,
            nr_acesso_dicom_w,
            cd_pessoa_fisica_w
    from	prescr_procedimento a,
          prescr_medica b    
    where	a.nr_prescricao = nr_prescricao_w
    and		a.nr_sequencia = nr_seq_prescricao_w
    and a.nr_prescricao = b.nr_prescricao;

    select	max(ds_url_pacs)
    into STRICT	ds_url_pacs_w
    from  	PARAMETRO_MEDICO 
    where	cd_estabelecimento	= wheb_usuario_pck.get_cd_estabelecimento;

    if ds_pront_seq_w = 'S' then
        ds_json_pacs_w := '{"UserName":"'||nm_usuario_carestream_w||'","Password":"'||ds_senha_carestream_w||'","QueryString":"user_name='||nm_usuario_carestream_w||chr(38)||'password='||ds_senha_carestream_w||chr(38)||'patient_id='||nr_prontuario_w||chr(38)||'accession_number='||nr_seq_agenda_w||'"}';
    else
        ds_json_pacs_w := '{"UserName":"'||nm_usuario_carestream_w||'","Password":"'||ds_senha_carestream_w||'","QueryString":"user_name='||nm_usuario_carestream_w||chr(38)||'password='||ds_senha_carestream_w||chr(38)||'patient_id='||cd_pessoa_fisica_w||chr(38)||'accession_number='||nr_acesso_dicom_w||'"}';
    end if;
return '[{"json":'||ds_json_pacs_w||',"url":"'||ds_url_pacs_w||'"}]';

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 IMMUTABLE;
-- REVOKE ALL ON FUNCTION gerar_json_pacs ( nr_prescricao_p prescr_procedimento.nr_prescricao%TYPE, nr_seq_prescricao_p prescr_procedimento.nr_sequencia%TYPE, nr_prontuario_p bigint) FROM PUBLIC;

