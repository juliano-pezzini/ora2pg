-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION cpoe_get_discharge_date_rp ( nr_seq_order_unit_p cpoe_order_unit.nr_sequencia%type, nr_atendimento_p atend_previsao_alta.nr_atendimento%type) RETURNS timestamp AS $body$
DECLARE


si_type_of_prescription_w   cpoe_order_unit.si_type_of_prescription%type;
dt_discharge_date_w			atend_previsao_alta.dt_previsto_alta%type;
ds_return_w					timestamp;


BEGIN

	select	si_type_of_prescription
	into STRICT	si_type_of_prescription_w
	from	cpoe_order_unit
	where	nr_sequencia = nr_seq_order_unit_p;

	if (si_type_of_prescription_w = 'INPDP') then
        begin
            select	dt_previsto_alta
            into STRICT	dt_discharge_date_w
            from (	SELECT	dt_previsto_alta 
                        from 	atend_previsao_alta 
                        where nr_atendimento = nr_atendimento_p
                        and (dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
                        and ie_situacao = 'A' 
                        order by nr_sequencia desc) alias2 LIMIT 1;
            exception when no_data_found then
            ds_return_w := null;
        end;
		ds_return_w := dt_discharge_date_w;
	end if;

  return ds_return_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION cpoe_get_discharge_date_rp ( nr_seq_order_unit_p cpoe_order_unit.nr_sequencia%type, nr_atendimento_p atend_previsao_alta.nr_atendimento%type) FROM PUBLIC;

