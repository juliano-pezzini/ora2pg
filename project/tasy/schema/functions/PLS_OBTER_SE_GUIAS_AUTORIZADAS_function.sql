-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION pls_obter_se_guias_autorizadas ( cd_guia_p text, nr_seq_protocolo_p bigint, ie_tipo_guia_p text, nr_seq_segurado_p bigint, cd_estabelecimento_p bigint) RETURNS varchar AS $body$
DECLARE


ie_retorno_w		varchar(1) := 'N';
cd_guia_w		varchar(20);
ie_status_w		smallint;

C01 CURSOR FOR	
	SELECT	a.nr_sequencia,
		a.ie_status
	from	pls_guia_plano a
	where	((a.cd_guia = cd_guia_p AND a.ie_tipo_guia = ie_tipo_guia_p) or
		(a.cd_guia_principal = cd_guia_p AND a.ie_tipo_guia = '8'))
	and	a.nr_seq_segurado = nr_seq_segurado_p
	and	coalesce(a.ie_utilizado,'N') in ('P','N')
	and	a.ie_status = '1'
	and	not exists (SELECT   b.nr_sequencia
				 from     pls_conta	 b
				 where    b.nr_seq_guia		= a.nr_sequencia
				 and      b.nr_seq_protocolo	= nr_seq_protocolo_p)
	order by 	1;				
	/*and	a.cd_estabelecimento = cd_estabelecimento_p OS 387054 - Felipe - 02/12/2011 */
				 	
	

BEGIN

open C01;
loop
fetch C01 into	
	cd_guia_w,
	ie_status_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	
	if (ie_status_w = 1) then
		ie_retorno_w := 'S';
	end if;
	
	end;
end loop;
close C01;

return	ie_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION pls_obter_se_guias_autorizadas ( cd_guia_p text, nr_seq_protocolo_p bigint, ie_tipo_guia_p text, nr_seq_segurado_p bigint, cd_estabelecimento_p bigint) FROM PUBLIC;

