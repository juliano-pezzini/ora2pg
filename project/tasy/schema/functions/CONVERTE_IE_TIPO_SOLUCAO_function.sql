-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION converte_ie_tipo_solucao ( nr_prescricao_p prescr_material.nr_prescricao%type, nr_seq_solucao_p prescr_material.nr_sequencia_solucao%type ) RETURNS bigint AS $body$
DECLARE


/*
prescr_solucao ie_tipo_sol dominio 3121
1 Solucao intermitente (medicamentos de horario ou solucoes nao-continuas cujo tempo de infusao e menor que o intervalo entre as doses)
2 Solucao em esquema alternado (quando ha periodos do dia com e sem etapas a serem infundidas)
3 Solucao continua (etapas ligadas, sem espaco de tempo entre elas)
4 Solucao especial (com velocidade de infusao variavel)
5 Solucao para analgesia controlada pelo paciente (PCA)

prescr_solucao campos REP equivalencia
1 = IE_SOL_INTERMITENTE
2 = IE_ESQUEMA_ALTERNADO
4 = IE_SOLUCAO_ESPECIAL
5 = IE_SOLUCAO_PCA
*/
ie_tipo_solucao_w prescr_solucao.ie_tipo_sol%type;
ie_tipo_sol_conv_w bigint;
ie_sol_intermitente_w prescr_solucao.ie_sol_intermitente%type;
ie_esquema_alternado_w prescr_solucao.ie_esquema_alternado%type;
ie_solucao_especial_w prescr_solucao.ie_solucao_especial%type;
ie_solucao_pca_w prescr_solucao.ie_solucao_pca%type;
cd_intervalo_w prescr_solucao.cd_intervalo%type;
ie_interv_continuo_w intervalo_prescricao.ie_continuo%type;


BEGIN

if (nr_prescricao_p IS NOT NULL AND nr_prescricao_p::text <> '' AND nr_seq_solucao_p IS NOT NULL AND nr_seq_solucao_p::text <> '') then
    select  max(a.ie_tipo_sol),
            coalesce(max(ie_sol_intermitente), 'N'),
            coalesce(max(ie_esquema_alternado), 'N'),
            coalesce(max(ie_solucao_especial), 'N'),
            coalesce(max(ie_solucao_pca), 'N'),
            coalesce(max(cd_intervalo), 'N')
    into STRICT    ie_tipo_solucao_w,
            ie_sol_intermitente_w,
            ie_esquema_alternado_w,
            ie_solucao_especial_w,
            ie_solucao_pca_w,
            cd_intervalo_w
    from    prescr_solucao a
    where   a.nr_prescricao = nr_prescricao_p
    and     a.nr_seq_solucao = nr_seq_solucao_p;

    select  coalesce(max(a.ie_continuo), 'N')
    into STRICT    ie_interv_continuo_w
    from    intervalo_prescricao a
    where   a.cd_intervalo = cd_intervalo_w;

    if (ie_tipo_solucao_w IS NOT NULL AND ie_tipo_solucao_w::text <> '') then
        ie_tipo_sol_conv_w := ie_tipo_solucao_w;
    end if;

    if (coalesce(ie_tipo_sol_conv_w::text, '') = '') then
        if (ie_solucao_pca_w = 'S') then
            ie_tipo_sol_conv_w := 5;
        elsif (ie_esquema_alternado_w = 'S') then
            ie_tipo_sol_conv_w := 2;
        elsif (ie_solucao_especial_w = 'S') then
            ie_tipo_sol_conv_w := 4;
        elsif (ie_sol_intermitente_w = 'N' or
                ie_interv_continuo_w = 'S') then
            ie_tipo_sol_conv_w := 3;
        elsif (ie_sol_intermitente_w = 'S') then
            ie_tipo_sol_conv_w := 1;
        end if;
    end if;
end if;

return ie_tipo_sol_conv_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION converte_ie_tipo_solucao ( nr_prescricao_p prescr_material.nr_prescricao%type, nr_seq_solucao_p prescr_material.nr_sequencia_solucao%type ) FROM PUBLIC;

