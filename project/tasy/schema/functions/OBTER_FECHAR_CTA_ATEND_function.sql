-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_fechar_cta_atend ( NR_INTERNO_CONTA_P bigint) RETURNS varchar AS $body$
DECLARE


ie_fecha_cta_w		varchar(1)	:= 'S';
ie_fecha_atend_w		varchar(1)	:= 'S';
ie_fecha_cta_ww		varchar(1)	:= 'S';
ie_fecha_atend_ww		varchar(1)	:= 'S';
ds_incons_w			varchar(2000):= '';
ie_fim_w			boolean	:= False;
ie_pos_w			bigint	:= 0;
ie_pos_proc_w			bigint	:= 0;
ie_cont_w			bigint	:= 0;
cd_incons_w			numeric(22)	:= 0;
cd_incons_ww			varchar(50);
qt_incons_w			bigint	:= 0;
cd_estabelecimento_w		bigint;


BEGIN


select replace(ds_inconsistencia,' ',',') || ',',
	cd_estabelecimento
into STRICT	ds_incons_w,
	cd_estabelecimento_w
from	conta_paciente
where	nr_interno_conta = nr_interno_conta_p;

while not ie_fim_w loop
	begin
	qt_incons_w	:= qt_incons_w + 1;
	ie_pos_w := position(',' in ds_incons_w);
	if (ie_pos_w > 0) then
		begin

		cd_incons_ww	:= substr(ds_incons_w,1,ie_pos_w);
		ie_pos_proc_w	:= position('(' in cd_incons_ww);

		if (ie_pos_proc_w > 0) then
			cd_incons_ww	:= substr(cd_incons_ww,1,ie_pos_proc_w);
		end if;

		cd_incons_w 	:= somente_numero(cd_incons_ww);
		ds_incons_w 	:= substr(ds_incons_w,ie_pos_w + 1,length(ds_incons_w));

		ie_fecha_cta_ww		:= '';
		ie_fecha_atend_ww	:= '';
		select	min(coalesce(c.ie_fecha_conta,coalesce(b.ie_fecha_conta,a.ie_fecha_conta))),
			min(coalesce(c.ie_fecha_atendimento,coalesce(b.ie_fecha_atendimento,a.ie_fecha_atendimento))),
			count(*)
		into STRICT	ie_fecha_cta_ww,
			ie_fecha_atend_ww,
			ie_cont_w
		FROM inconsistencia a
LEFT OUTER JOIN inconsistencia_estab b ON (a.nr_sequencia = b.nr_seq_inconsistencia AND cd_estabelecimento_w = b.cd_estabelecimento)
LEFT OUTER JOIN inconsistencia_perfil c ON (a.nr_sequencia = c.nr_seq_inconsistencia AND obter_perfil_ativo = c.cd_perfil AND cd_estabelecimento_w = c.cd_estabelecimento)
WHERE a.cd_inconsistencia	= cd_incons_w;
		if (ie_cont_w = 1) then
			if (ie_fecha_cta_ww = 'N') then
				ie_fecha_cta_w	:= 'N';
			end if;
			if (ie_fecha_atend_ww = 'N') then
				ie_fecha_atend_w	:= 'N';
			end if;
		end if;
		end;
	end if;
	ie_fim_w := (ie_pos_w < 1) or (qt_incons_w > 100);
	end;
end loop;
RETURN ie_fecha_cta_w || ie_fecha_atend_w;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_fechar_cta_atend ( NR_INTERNO_CONTA_P bigint) FROM PUBLIC;

