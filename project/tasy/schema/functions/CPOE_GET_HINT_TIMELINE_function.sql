-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION cpoe_get_hint_timeline ( nr_seq_item_p bigint, ie_tipo_item_p text, cd_perfil_p bigint, dt_referencia_p timestamp, dt_inicio_grid_p timestamp, ds_hora_coluna_p text) RETURNS varchar AS $body$
DECLARE

ds_prescr_w				varchar(50);
ds_aux_w				varchar(50);
ds_adm_w				varchar(50);
dt_atual_w				timestamp;
dt_referencia_w			timestamp;
dt_horario_retorno_w	timestamp;
dt_inicio_grid_w		timestamp;
dt_inicio_grid_ww		timestamp;
dt_fim_horario_w		timestamp;
ds_retorno_w			varchar(2000);
dt_fim_etapa_w			timestamp;
dt_lib_w				timestamp;
nr_seq_horario_w		bigint;

BEGIN
/* 
Retiramos estes selects daqui pois esta function é chamada muitas vezes, evitando assim 3 consultas desnecessárias as tabelas de dic_expressao 
--ds_prescr_w := wheb_mensagem_pck.get_texto(460318) || ' '; ---Presc.:; 
--ds_adm_w	:= wheb_mensagem_pck.get_texto(460317) || '.: '; --Adm.: 
--ds_aux_w	:= ' ' || wheb_mensagem_pck.get_texto(460313) || ' '; ---' até '; 
*/
 
 
dt_atual_w := trunc(clock_timestamp(),'hh');
dt_inicio_grid_ww := dt_atual_w - (cpoe_obter_quant_horas_ant(cd_perfil_p)/24);
dt_inicio_grid_w := coalesce(dt_inicio_grid_p, dt_inicio_grid_ww);
dt_referencia_w := to_date(to_char(dt_referencia_p,'dd/mm/yyyy')||' '||ds_hora_coluna_p||':00','dd/mm/yyyy hh24:mi');
 
if (trunc(dt_inicio_grid_w) <> trunc(clock_timestamp())) and (dt_referencia_w - 1 between dt_inicio_grid_w and fim_dia(dt_inicio_grid_w)) then 
	dt_referencia_w := dt_referencia_w - 1;
end if;
 
if (dt_referencia_w	< dt_inicio_grid_w) then 
	dt_referencia_w := dt_referencia_w + 1;
end if;
 
ds_retorno_w := null;
if (ie_tipo_item_p = 'M') then 
 
	select	max(dt_liberacao) 
	into STRICT	dt_lib_w 
	from	cpoe_material 
	where	nr_sequencia = nr_seq_item_p;
	 
	if (dt_lib_w IS NOT NULL AND dt_lib_w::text <> '') then 
 
		select 	max(b.dt_horario), 
				max(b.dt_fim_horario), 
				max(b.nr_sequencia) 
		into STRICT	dt_horario_retorno_w, 
				dt_fim_horario_w, 
				nr_seq_horario_w 
		from	prescr_material a, 
				prescr_mat_hor b, 
				cpoe_material c 
		where	a.nr_prescricao = b.nr_prescricao 
		and		a.nr_sequencia = b.nr_seq_material 
		and		a.nr_seq_mat_cpoe = c.nr_sequencia 
		and		c.nr_sequencia = nr_seq_item_p 
		and		a.ie_agrupador = 1 
		and		trunc(b.dt_horario,'hh') = dt_referencia_w 
		and		coalesce(b.ie_horario_especial,'N') = 'N';
		 
		if (coalesce(dt_horario_retorno_w::text, '') = '') then 
			select 	max(b.dt_horario + 1) 
			into STRICT	dt_horario_retorno_w 
			from	prescr_material a, 
					prescr_mat_hor b, 
					cpoe_material c 
			where	a.nr_prescricao = b.nr_prescricao 
			and		a.nr_sequencia = b.nr_seq_material 
			and		a.nr_seq_mat_cpoe = c.nr_sequencia 
			and		c.nr_sequencia = nr_seq_item_p 
			and		a.ie_agrupador = 1 
			and		trunc(b.dt_horario + 1,'hh') = dt_referencia_w 
			and		coalesce(b.ie_horario_especial,'N') = 'N';
		end if;
		 
		 
		if (dt_horario_retorno_w IS NOT NULL AND dt_horario_retorno_w::text <> '') then 
			ds_prescr_w := wheb_mensagem_pck.get_texto(460318) || ' '; ---Presc.:; 
			ds_retorno_w := ds_prescr_w||to_char(dt_horario_retorno_w,'dd/mm/yyyy hh24:mi');
		end if;
		 
		if (dt_fim_horario_w IS NOT NULL AND dt_fim_horario_w::text <> '') and (ds_retorno_w IS NOT NULL AND ds_retorno_w::text <> '') then 
			dt_fim_horario_w := coalesce(cpoe_data_adm_item(nr_seq_item_p, ie_tipo_item_p, nr_seq_horario_w, null),dt_fim_horario_w);
			ds_adm_w	:= wheb_mensagem_pck.get_texto(460317) || '.: '; --Adm.: 
			ds_retorno_w := ds_retorno_w ||'<br>'||ds_adm_w||to_char(dt_fim_horario_w,'dd/mm/yyyy hh24:mi');
		end if;	
	end if;	
	 
elsif (ie_tipo_item_p = 'SOL') then 
 
	select	max(dt_liberacao) 
	into STRICT	dt_lib_w 
	from	cpoe_material 
	where	nr_sequencia = nr_seq_item_p;
	 
	if (dt_lib_w IS NOT NULL AND dt_lib_w::text <> '') then 
	 
		select 	max(b.dt_horario), 
				max(b.dt_fim_horario), 
				max(cpoe_obter_data_final_etapa(b.dt_horario,qt_hora_fase)) 
		into STRICT	dt_horario_retorno_w, 
				dt_fim_horario_w, 
				dt_fim_etapa_w 
		from	prescr_material a, 
				prescr_mat_hor b, 
				cpoe_material c 
		where	a.nr_prescricao = b.nr_prescricao 
		and		a.nr_sequencia = b.nr_seq_material 
		and		a.nr_seq_mat_cpoe = c.nr_sequencia 
		and		c.nr_sequencia = nr_seq_item_p 
		and		a.ie_agrupador = 4 
		and		coalesce(b.ie_horario_especial,'N') = 'N' 
		and		dt_referencia_w between trunc(dt_horario,'hh') and trunc(cpoe_obter_data_final_etapa(b.dt_horario,qt_hora_fase),'hh');
		 
		if (coalesce(dt_horario_retorno_w::text, '') = '') then 
			select 	max(b.dt_horario + 1), 
					max(cpoe_obter_data_final_etapa(b.dt_horario + 1,qt_hora_fase)) 
			into STRICT	dt_horario_retorno_w, 
					dt_fim_etapa_w 
			from	prescr_material a, 
					prescr_mat_hor b, 
					cpoe_material c 
			where	a.nr_prescricao = b.nr_prescricao 
			and		a.nr_sequencia = b.nr_seq_material 
			and		a.nr_seq_mat_cpoe = c.nr_sequencia 
			and		c.nr_sequencia = nr_seq_item_p 
			and		coalesce(b.ie_horario_especial,'N') = 'N' 
			and		a.ie_agrupador = 4 
			and		dt_referencia_w between trunc(b.dt_horario + 1,'hh') and trunc(cpoe_obter_data_final_etapa(b.dt_horario + 1,qt_hora_fase),'hh');		
		end if;
 
		if (dt_horario_retorno_w IS NOT NULL AND dt_horario_retorno_w::text <> '') then 
			ds_prescr_w := wheb_mensagem_pck.get_texto(460318) || ' '; ---Presc.:; 
			ds_aux_w	:= ' ' || wheb_mensagem_pck.get_texto(460313) || ' '; ---' até '; 
			ds_retorno_w := ds_prescr_w||to_char(dt_horario_retorno_w,'dd/mm/yyyy hh24:mi')||ds_aux_w|| to_char(dt_fim_etapa_w,'dd/mm/yyyy hh24:mi');
		end if;
		 
		if (dt_fim_horario_w IS NOT NULL AND dt_fim_horario_w::text <> '') then 
			dt_fim_horario_w := coalesce(cpoe_data_adm_item(nr_seq_item_p, ie_tipo_item_p, null, dt_horario_retorno_w),dt_fim_horario_w);
			ds_adm_w	:= wheb_mensagem_pck.get_texto(460317) || '.: '; --Adm.: 
			ds_retorno_w := ds_retorno_w ||'<br>'||ds_adm_w||to_char(dt_fim_horario_w,'dd/mm/yyyy hh24:mi');
		end if;	
	end if;	
	 
elsif (ie_tipo_item_p = 'MA') then 
 
	select	max(dt_liberacao) 
	into STRICT	dt_lib_w 
	from	cpoe_material 
	where	nr_sequencia = nr_seq_item_p;
	 
	if (dt_lib_w IS NOT NULL AND dt_lib_w::text <> '') then 
	 
		select 	max(b.dt_horario), 
				max(b.dt_fim_horario), 
				max(b.nr_sequencia) 
		into STRICT	dt_horario_retorno_w, 
				dt_fim_horario_w, 
				nr_seq_horario_w 
		from	prescr_material a, 
				prescr_mat_hor b, 
				cpoe_material c 
		where	a.nr_prescricao = b.nr_prescricao 
		and		a.nr_sequencia = b.nr_seq_material 
		and		a.nr_seq_mat_cpoe = c.nr_sequencia 
		and		c.nr_sequencia = nr_seq_item_p 
		and		coalesce(b.ie_horario_especial,'N') = 'N' 
		and		a.ie_agrupador = 2 
		and		trunc(b.dt_horario,'hh') = dt_referencia_w;
		 
		if (coalesce(dt_horario_retorno_w::text, '') = '') then 
			select 	max(b.dt_horario + 1) 
			into STRICT	dt_horario_retorno_w 
			from	prescr_material a, 
					prescr_mat_hor b, 
					cpoe_material c 
			where	a.nr_prescricao = b.nr_prescricao 
			and		a.nr_sequencia = b.nr_seq_material 
			and		a.nr_seq_mat_cpoe = c.nr_sequencia 
			and		c.nr_sequencia = nr_seq_item_p 
			and		coalesce(b.ie_horario_especial,'N') = 'N' 
			and		a.ie_agrupador = 2 
			and		trunc(b.dt_horario + 1,'hh') = dt_referencia_w;
		end if;
		 
		if (dt_horario_retorno_w IS NOT NULL AND dt_horario_retorno_w::text <> '') then 
			ds_prescr_w := wheb_mensagem_pck.get_texto(460318) || ' '; ---Presc.:; 
			ds_retorno_w := ds_prescr_w||to_char(dt_horario_retorno_w,'dd/mm/yyyy hh24:mi');
		end if;
		 
		if (dt_fim_horario_w IS NOT NULL AND dt_fim_horario_w::text <> '') and (ds_retorno_w IS NOT NULL AND ds_retorno_w::text <> '') then 
			dt_fim_horario_w := coalesce(cpoe_data_adm_item(nr_seq_item_p, ie_tipo_item_p, nr_seq_horario_w, null),dt_fim_horario_w);
			ds_adm_w	:= wheb_mensagem_pck.get_texto(460317) || '.: '; --Adm.: 
			ds_retorno_w := ds_retorno_w ||'<br>'||ds_adm_w||to_char(dt_fim_horario_w,'dd/mm/yyyy hh24:mi');
		end if;	
	end if;	
	 
elsif (ie_tipo_item_p = 'R') then 
 
	select	max(dt_liberacao) 
	into STRICT	dt_lib_w 
	from	cpoe_recomendacao 
	where	nr_sequencia = nr_seq_item_p;
	 
	if (dt_lib_w IS NOT NULL AND dt_lib_w::text <> '') then 
	 
		select 	max(b.dt_horario), 
				max(b.dt_fim_horario), 
				max(b.nr_sequencia) 
		into STRICT	dt_horario_retorno_w, 
				dt_fim_horario_w, 
				nr_seq_horario_w 
		from	prescr_recomendacao a, 
				prescr_rec_hor b, 
				cpoe_recomendacao c 
		where	a.nr_prescricao = b.nr_prescricao 
		and		a.nr_sequencia = b.nr_seq_recomendacao 
		and		a.nr_seq_rec_cpoe = c.nr_sequencia 
		and		c.nr_sequencia = nr_seq_item_p 
		and		trunc(b.dt_horario,'hh') = dt_referencia_w;
		 
		if (coalesce(dt_horario_retorno_w::text, '') = '') then 
			select 	max(b.dt_horario + 1) 
			into STRICT	dt_horario_retorno_w 
			from	prescr_recomendacao a, 
					prescr_rec_hor b, 
					cpoe_recomendacao c 
			where	a.nr_prescricao = b.nr_prescricao 
			and		a.nr_sequencia = b.nr_seq_recomendacao 
			and		a.nr_seq_rec_cpoe = c.nr_sequencia 
			and		c.nr_sequencia = nr_seq_item_p 
			and		trunc(b.dt_horario + 1,'hh') = dt_referencia_w;
		end if;
		 
		if (dt_horario_retorno_w IS NOT NULL AND dt_horario_retorno_w::text <> '') then 
			ds_prescr_w := wheb_mensagem_pck.get_texto(460318) || ' '; ---Presc.:; 
			ds_retorno_w := ds_prescr_w||to_char(dt_horario_retorno_w,'dd/mm/yyyy hh24:mi');
		end if;
		 
		if (dt_fim_horario_w IS NOT NULL AND dt_fim_horario_w::text <> '') and (ds_retorno_w IS NOT NULL AND ds_retorno_w::text <> '') then 
			dt_fim_horario_w := coalesce(cpoe_data_adm_item(nr_seq_item_p, ie_tipo_item_p, null, dt_horario_retorno_w),dt_fim_horario_w);
			ds_adm_w	:= wheb_mensagem_pck.get_texto(460317) || '.: '; --Adm.: 
			ds_retorno_w := ds_retorno_w ||'<br>'||ds_adm_w||to_char(dt_fim_horario_w,'dd/mm/yyyy hh24:mi');
		end if;	
	end if;	
 
elsif (ie_tipo_item_p = 'P') then 
 
	select	max(dt_liberacao) 
	into STRICT	dt_lib_w 
	from	cpoe_procedimento 
	where	nr_sequencia = nr_seq_item_p;
	 
	if (dt_lib_w IS NOT NULL AND dt_lib_w::text <> '') then 
 
		select 	max(b.dt_horario), 
				max(b.dt_fim_horario) 
		into STRICT	dt_horario_retorno_w, 
				dt_fim_horario_w 
		from	prescr_procedimento a, 
				prescr_proc_hor b, 
				cpoe_procedimento c 
		where	a.nr_prescricao = b.nr_prescricao 
		and		a.nr_sequencia = b.nr_seq_procedimento 
		and		a.nr_seq_proc_cpoe = c.nr_sequencia 
		and		c.nr_sequencia = nr_seq_item_p 
		and		trunc(b.dt_horario,'hh') = dt_referencia_w;
		 
		if (coalesce(dt_horario_retorno_w::text, '') = '') then 
			select 	max(b.dt_horario + 1) 
			into STRICT	dt_horario_retorno_w 
			from	prescr_procedimento a, 
					prescr_proc_hor b, 
					cpoe_procedimento c 
			where	a.nr_prescricao = b.nr_prescricao 
			and		a.nr_sequencia = b.nr_seq_procedimento 
			and		a.nr_seq_proc_cpoe = c.nr_sequencia 
			and		c.nr_sequencia = nr_seq_item_p 
			and		trunc(b.dt_horario + 1,'hh') = dt_referencia_w;
		end if;
		 
		if (dt_horario_retorno_w IS NOT NULL AND dt_horario_retorno_w::text <> '') then 
			ds_prescr_w := wheb_mensagem_pck.get_texto(460318) || ' '; ---Presc.:; 
			ds_retorno_w := ds_prescr_w||to_char(dt_horario_retorno_w,'dd/mm/yyyy hh24:mi');
		end if;
		 
		if (dt_fim_horario_w IS NOT NULL AND dt_fim_horario_w::text <> '') and (ds_retorno_w IS NOT NULL AND ds_retorno_w::text <> '') then 
			dt_fim_horario_w := coalesce(cpoe_data_adm_item(nr_seq_item_p, ie_tipo_item_p, null, dt_horario_retorno_w),dt_fim_horario_w);
			ds_adm_w	:= wheb_mensagem_pck.get_texto(460317) || '.: '; --Adm.: 
			ds_retorno_w := ds_retorno_w ||'<br>'||ds_adm_w||to_char(dt_fim_horario_w,'dd/mm/yyyy hh24:mi');
		end if;	
	end if;	
	 
elsif (ie_tipo_item_p = 'O') then 
 
	select	max(dt_liberacao) 
	into STRICT	dt_lib_w 
	from	cpoe_dieta 
	where	nr_sequencia = nr_seq_item_p;
	 
	if (dt_lib_w IS NOT NULL AND dt_lib_w::text <> '') then 
	 
		select 	max(b.dt_horario), 
				max(b.dt_fim_horario), 
				max(b.nr_sequencia) 
		into STRICT	dt_horario_retorno_w, 
				dt_fim_horario_w, 
				nr_seq_horario_w 
		from	prescr_dieta a, 
				prescr_dieta_hor b, 
				cpoe_dieta c 
		where	a.nr_prescricao = b.nr_prescricao 
		and		a.nr_sequencia = b.nr_seq_dieta 
		and		a.nr_seq_dieta_cpoe = c.nr_sequencia 
		and		c.nr_sequencia = nr_seq_item_p 
		and		trunc(b.dt_horario,'hh') = dt_referencia_w;
		 
		if (coalesce(dt_horario_retorno_w::text, '') = '') then 
			select 	max(b.dt_horario + 1) 
			into STRICT	dt_horario_retorno_w 
			from	prescr_dieta a, 
					prescr_dieta_hor b, 
					cpoe_dieta c 
			where	a.nr_prescricao = b.nr_prescricao 
			and		a.nr_sequencia = b.nr_seq_dieta 
			and		a.nr_seq_dieta_cpoe = c.nr_sequencia 
			and		c.nr_sequencia = nr_seq_item_p 
			and		trunc(b.dt_horario + 1,'hh') = dt_referencia_w;
		end if;
		 
		if (dt_horario_retorno_w IS NOT NULL AND dt_horario_retorno_w::text <> '') then 
			ds_prescr_w := wheb_mensagem_pck.get_texto(460318) || ' '; ---Presc.:; 
			ds_retorno_w := ds_prescr_w||to_char(dt_horario_retorno_w,'dd/mm/yyyy hh24:mi');
		end if;
		 
		if (dt_fim_horario_w IS NOT NULL AND dt_fim_horario_w::text <> '') and (ds_retorno_w IS NOT NULL AND ds_retorno_w::text <> '') then 
			dt_fim_horario_w := coalesce(cpoe_data_adm_item(nr_seq_item_p, ie_tipo_item_p, null, dt_horario_retorno_w),dt_fim_horario_w);
			ds_adm_w	:= wheb_mensagem_pck.get_texto(460317) || '.: '; --Adm.: 
			ds_retorno_w := ds_retorno_w ||'<br>'||ds_adm_w||to_char(dt_fim_horario_w,'dd/mm/yyyy hh24:mi');
		end if;	
	end if;	
	 
elsif (ie_tipo_item_p = 'S') then 
	 
	select	max(dt_liberacao) 
	into STRICT	dt_lib_w 
	from	cpoe_dieta 
	where	nr_sequencia = nr_seq_item_p;
	 
	if (dt_lib_w IS NOT NULL AND dt_lib_w::text <> '') then 
	 
		select 	max(b.dt_horario), 
				max(b.dt_fim_horario), 
				max(b.nr_sequencia) 
		into STRICT	dt_horario_retorno_w, 
				dt_fim_horario_w, 
				nr_seq_horario_w 
		from	prescr_material a, 
				prescr_mat_hor b, 
				cpoe_dieta c 
		where	a.nr_prescricao = b.nr_prescricao 
		and		a.nr_sequencia = b.nr_seq_material 
		and		a.nr_seq_dieta_cpoe = c.nr_sequencia 
		and		c.nr_sequencia = nr_seq_item_p 
		and		a.ie_agrupador = 12 
		and		coalesce(b.ie_horario_especial,'N') = 'N' 
		and		trunc(b.dt_horario,'hh') = dt_referencia_w;
		 
		if (coalesce(dt_horario_retorno_w::text, '') = '') then 
			select 	max(b.dt_horario +1) 
			into STRICT	dt_horario_retorno_w 
			from	prescr_material a, 
					prescr_mat_hor b, 
					cpoe_dieta c 
			where	a.nr_prescricao = b.nr_prescricao 
			and		a.nr_sequencia = b.nr_seq_material 
			and		a.nr_seq_dieta_cpoe = c.nr_sequencia 
			and		c.nr_sequencia = nr_seq_item_p 
			and		a.ie_agrupador = 12 
			and		coalesce(b.ie_horario_especial,'N') = 'N' 
			and		trunc(b.dt_horario + 1,'hh') = dt_referencia_w;
		end if;
		 
		if (dt_horario_retorno_w IS NOT NULL AND dt_horario_retorno_w::text <> '') then 
			ds_prescr_w := wheb_mensagem_pck.get_texto(460318) || ' '; ---Presc.:; 
			ds_retorno_w := ds_prescr_w||to_char(dt_horario_retorno_w,'dd/mm/yyyy hh24:mi');
		end if;
		 
		if (dt_fim_horario_w IS NOT NULL AND dt_fim_horario_w::text <> '') and (ds_retorno_w IS NOT NULL AND ds_retorno_w::text <> '') then 
			dt_fim_horario_w := coalesce(cpoe_data_adm_item(nr_seq_item_p, ie_tipo_item_p, nr_seq_horario_w, null),dt_fim_horario_w);
			ds_adm_w	:= wheb_mensagem_pck.get_texto(460317) || '.: '; --Adm.: 
			ds_retorno_w := ds_retorno_w ||'<br>'||ds_adm_w||to_char(dt_fim_horario_w,'dd/mm/yyyy hh24:mi');
		end if;	
	end if;	
	 
elsif (ie_tipo_item_p = 'E') then 
 
	select	max(dt_liberacao) 
	into STRICT	dt_lib_w 
	from	cpoe_dieta 
	where	nr_sequencia = nr_seq_item_p;
	 
	if (dt_lib_w IS NOT NULL AND dt_lib_w::text <> '') then 
	 
		select 	max(b.dt_horario), 
				max(b.dt_fim_horario), 
				max(cpoe_obter_dt_fim_etapa_ent(b.dt_horario, c.hr_prim_horario, c.qt_tempo_pausa, coalesce(c.qt_hora_fase, c.qt_tempo_aplic), c.nr_ocorrencia, c.ie_continuo)) 
		into STRICT	dt_horario_retorno_w, 
				dt_fim_horario_w, 
				dt_fim_etapa_w 
		from	prescr_material a, 
				prescr_mat_hor b, 
				cpoe_dieta c 
		where	a.nr_prescricao = b.nr_prescricao 
		and		a.nr_sequencia = b.nr_seq_material 
		and		a.nr_seq_dieta_cpoe = c.nr_sequencia 
		and		c.nr_sequencia = nr_seq_item_p 
		and		a.ie_agrupador = 8 
		and		coalesce(b.ie_horario_especial,'N') = 'N' 
		and		dt_referencia_w between trunc(b.dt_horario,'hh') and trunc(cpoe_obter_dt_fim_etapa_ent(b.dt_horario, c.hr_prim_horario, c.qt_tempo_pausa, coalesce(c.qt_hora_fase, c.qt_tempo_aplic), c.nr_ocorrencia, c.ie_continuo),'hh');
		 
		if (coalesce(dt_horario_retorno_w::text, '') = '') then 
			select 	max(b.dt_horario +1), 
					max(cpoe_obter_dt_fim_etapa_ent(b.dt_horario +1, c.hr_prim_horario, c.qt_tempo_pausa, coalesce(c.qt_hora_fase, c.qt_tempo_aplic), c.nr_ocorrencia, c.ie_continuo)) 
			into STRICT	dt_horario_retorno_w, 
					dt_fim_etapa_w 
			from	prescr_material a, 
					prescr_mat_hor b, 
					cpoe_dieta c 
			where	a.nr_prescricao = b.nr_prescricao 
			and		a.nr_sequencia = b.nr_seq_material 
			and		a.nr_seq_dieta_cpoe = c.nr_sequencia 
			and		c.nr_sequencia = nr_seq_item_p 
			and		a.ie_agrupador = 8 
			and		coalesce(b.ie_horario_especial,'N') = 'N' 
			and		dt_referencia_w between trunc(b.dt_horario,'hh') and trunc(cpoe_obter_dt_fim_etapa_ent(b.dt_horario +1, c.hr_prim_horario, c.qt_tempo_pausa, coalesce(c.qt_hora_fase, c.qt_tempo_aplic), c.nr_ocorrencia, c.ie_continuo),'hh');
		end if;
		 
		if (dt_horario_retorno_w IS NOT NULL AND dt_horario_retorno_w::text <> '') then 
			ds_prescr_w := wheb_mensagem_pck.get_texto(460318) || ' '; ---Presc.:; 
			ds_aux_w	:= ' ' || wheb_mensagem_pck.get_texto(460313) || ' '; ---' até '; 
			ds_retorno_w := ds_prescr_w||to_char(dt_horario_retorno_w,'dd/mm/yyyy hh24:mi')||ds_aux_w|| to_char(dt_fim_etapa_w,'dd/mm/yyyy hh24:mi');
		end if;
		 
		if (dt_fim_horario_w IS NOT NULL AND dt_fim_horario_w::text <> '') then 
			dt_fim_horario_w := coalesce(cpoe_data_adm_item(nr_seq_item_p, ie_tipo_item_p, null, dt_horario_retorno_w),dt_fim_horario_w);
			ds_adm_w	:= wheb_mensagem_pck.get_texto(460317) || '.: '; --Adm.: 
			ds_retorno_w := ds_retorno_w ||'<br>'||ds_adm_w||to_char(dt_fim_horario_w,'dd/mm/yyyy hh24:mi');
		end if;
	end if;
	 
elsif (ie_tipo_item_p = 'L') then 
 
	select	max(dt_liberacao) 
	into STRICT	dt_lib_w 
	from	cpoe_dieta 
	where	nr_sequencia = nr_seq_item_p;
	 
	if (dt_lib_w IS NOT NULL AND dt_lib_w::text <> '') then 
 
		select 	max(b.dt_horario), 
				max(b.dt_fim_horario), 
				max(b.nr_sequencia) 
		into STRICT	dt_horario_retorno_w, 
				dt_fim_horario_w, 
				nr_seq_horario_w 
		from	prescr_material a, 
				prescr_mat_hor b, 
				cpoe_dieta c 
		where	a.nr_prescricao = b.nr_prescricao 
		and		a.nr_sequencia = b.nr_seq_material 
		and		a.nr_seq_dieta_cpoe = c.nr_sequencia 
		and		c.nr_sequencia = nr_seq_item_p 
		and		a.ie_agrupador = 16 
		and		coalesce(b.ie_horario_especial,'N') = 'N' 
		and		trunc(b.dt_horario,'hh') = dt_referencia_w;
		 
		if (coalesce(dt_horario_retorno_w::text, '') = '') then 
			select 	max(b.dt_horario +1) 
			into STRICT	dt_horario_retorno_w				 
			from	prescr_material a, 
					prescr_mat_hor b, 
					cpoe_dieta c 
			where	a.nr_prescricao = b.nr_prescricao 
			and		a.nr_sequencia = b.nr_seq_material 
			and		a.nr_seq_dieta_cpoe = c.nr_sequencia 
			and		c.nr_sequencia = nr_seq_item_p 
			and		a.ie_agrupador = 16 
			and		coalesce(b.ie_horario_especial,'N') = 'N' 
			and		trunc(b.dt_horario +1,'hh') = dt_referencia_w;
		end if;
		 
		if (dt_horario_retorno_w IS NOT NULL AND dt_horario_retorno_w::text <> '') then 
			ds_prescr_w := wheb_mensagem_pck.get_texto(460318) || ' '; ---Presc.:; 
			ds_retorno_w := ds_prescr_w||to_char(dt_horario_retorno_w,'dd/mm/yyyy hh24:mi');
		end if;
		 
		if (dt_fim_horario_w IS NOT NULL AND dt_fim_horario_w::text <> '') and (ds_retorno_w IS NOT NULL AND ds_retorno_w::text <> '') then 
			dt_fim_horario_w := coalesce(cpoe_data_adm_item(nr_seq_item_p, ie_tipo_item_p, nr_seq_horario_w, null),dt_fim_horario_w);
			ds_adm_w	:= wheb_mensagem_pck.get_texto(460317) || '.: '; --Adm.: 
			ds_retorno_w := ds_retorno_w ||'<br>'||ds_adm_w||to_char(dt_fim_horario_w,'dd/mm/yyyy hh24:mi');
		end if;	
	end if;	
	 
elsif (ie_tipo_item_p = 'J') then 
 
	select	max(dt_liberacao) 
	into STRICT	dt_lib_w 
	from	cpoe_dieta 
	where	nr_sequencia = nr_seq_item_p;
	 
	if (dt_lib_w IS NOT NULL AND dt_lib_w::text <> '') then 
	 
		select 	max(b.dt_inicio), 
				max(coalesce(b.dt_fim,a.dt_validade_prescr)) 
		into STRICT	dt_horario_retorno_w, 
				dt_fim_etapa_w 
		from	prescr_medica a, 
				rep_jejum b, 
				cpoe_dieta c 
		where	a.nr_prescricao = b.nr_prescricao 
		and		b.nr_seq_dieta_cpoe = c.nr_sequencia 
		and		c.nr_sequencia = nr_seq_item_p 
		and		dt_referencia_w between trunc(b.dt_inicio,'hh') and coalesce(b.dt_fim,a.dt_validade_prescr);
		 
		if (coalesce(dt_horario_retorno_w::text, '') = '') then 
			select 	max(b.dt_inicio +1), 
					max(coalesce(b.dt_fim,a.dt_validade_prescr) +1) 
			into STRICT	dt_horario_retorno_w, 
					dt_fim_etapa_w 
			from	prescr_medica a, 
					rep_jejum b, 
					cpoe_dieta c 
			where	a.nr_prescricao = b.nr_prescricao 
			and		b.nr_seq_dieta_cpoe = c.nr_sequencia 
			and		c.nr_sequencia = nr_seq_item_p 
			and		dt_referencia_w between trunc(b.dt_inicio +1,'hh') and coalesce(b.dt_fim,a.dt_validade_prescr) +1;
		end if;
		 
		 
		if (dt_horario_retorno_w IS NOT NULL AND dt_horario_retorno_w::text <> '') then 
			dt_fim_horario_w := coalesce(cpoe_data_adm_item(nr_seq_item_p, ie_tipo_item_p, null, dt_horario_retorno_w),dt_fim_horario_w);
			ds_prescr_w := wheb_mensagem_pck.get_texto(460318) || ' '; ---Presc.:; 
			ds_aux_w	:= ' ' || wheb_mensagem_pck.get_texto(460313) || ' '; ---' até '; 
			ds_retorno_w := ds_prescr_w||to_char(dt_horario_retorno_w,'dd/mm/yyyy hh24:mi')||ds_aux_w|| to_char(dt_fim_etapa_w,'dd/mm/yyyy hh24:mi');
		end if;
	end if;
	 
elsif (ie_tipo_item_p = 'DI') then 
 
	select	max(dt_liberacao) 
	into STRICT	dt_lib_w 
	from	cpoe_dialise 
	where	nr_sequencia = nr_seq_item_p;
	 
	if (dt_lib_w IS NOT NULL AND dt_lib_w::text <> '') then 
	 
		select	max(b.dt_inicio_dialise), 
				max(CASE WHEN substr(obter_status_solucao_prescr(1, a.nr_prescricao, a.nr_seq_solucao),1,3)='T' THEN  a.dt_status  ELSE null END ), 
				max(cpoe_obter_data_final_etapa(b.dt_inicio_dialise,c.qt_hora_min_sessao)) 
		into STRICT	dt_horario_retorno_w, 
				dt_fim_horario_w, 
				dt_fim_etapa_w 
		from	prescr_solucao a, 
				hd_prescricao b, 
				cpoe_dialise c 
		where	a.nr_prescricao = b.nr_prescricao 
		and		a.nr_seq_dialise = b.nr_sequencia 
		and		b.nr_seq_dialise_cpoe = c.nr_sequencia 
		and		c.nr_sequencia = nr_seq_item_p 
		and		dt_referencia_w between trunc(b.dt_inicio_dialise,'hh') and trunc(cpoe_obter_data_final_etapa(b.dt_inicio_dialise,c.qt_hora_min_sessao),'hh');
		 
		if (coalesce(dt_horario_retorno_w::text, '') = '') then 
			select	max(b.dt_inicio_dialise +1), 
					max(cpoe_obter_data_final_etapa(b.dt_inicio_dialise +1,c.qt_hora_min_sessao)) 
			into STRICT	dt_horario_retorno_w, 
					dt_fim_etapa_w 
			from	prescr_solucao a, 
					hd_prescricao b, 
					cpoe_dialise c 
			where	a.nr_prescricao = b.nr_prescricao 
			and		a.nr_seq_dialise = b.nr_sequencia 
			and		b.nr_seq_dialise_cpoe = c.nr_sequencia 
			and		c.nr_sequencia = nr_seq_item_p 
			and		dt_referencia_w between trunc(b.dt_inicio_dialise +1,'hh') and trunc(cpoe_obter_data_final_etapa(b.dt_inicio_dialise +1,c.qt_hora_min_sessao),'hh');
		end if;
		 
		if (dt_horario_retorno_w IS NOT NULL AND dt_horario_retorno_w::text <> '') then 
			ds_prescr_w := wheb_mensagem_pck.get_texto(460318) || ' '; ---Presc.:; 
			ds_aux_w	:= ' ' || wheb_mensagem_pck.get_texto(460313) || ' '; ---' até '; 
			ds_retorno_w := ds_prescr_w||to_char(dt_horario_retorno_w,'dd/mm/yyyy hh24:mi')||ds_aux_w|| to_char(dt_fim_etapa_w,'dd/mm/yyyy hh24:mi');
		end if;
		 
		if (dt_fim_horario_w IS NOT NULL AND dt_fim_horario_w::text <> '') then 
			ds_adm_w	:= wheb_mensagem_pck.get_texto(460317) || '.: '; --Adm.: 
			ds_retorno_w := ds_retorno_w ||'<br>'||ds_adm_w||to_char(dt_fim_horario_w,'dd/mm/yyyy hh24:mi');
		end if;	
	end if;	
	 
elsif (ie_tipo_item_p = 'G') then 
 
	select	max(dt_liberacao) 
	into STRICT	dt_lib_w 
	from	cpoe_gasoterapia 
	where	nr_sequencia = nr_seq_item_p;
	 
	if (dt_lib_w IS NOT NULL AND dt_lib_w::text <> '') then 
		 
		select 	max(b.dt_horario), 
				max(b.dt_fim_horario), 
				max(cpoe_obter_dt_fim_etapa_gas(b.dt_horario, c.qt_hora_fase, c.nr_ocorrencia, c.ie_modo_adm)), 
				max(b.nr_sequencia) 
		into STRICT	dt_horario_retorno_w, 
				dt_fim_horario_w, 
				dt_fim_etapa_w, 
				nr_seq_horario_w 
		from	prescr_gasoterapia a, 
				prescr_gasoterapia_hor b, 
				cpoe_gasoterapia c 
		where	a.nr_prescricao = b.nr_prescricao 
		and		a.nr_sequencia = b.nr_seq_gasoterapia 
		and		a.nr_seq_gas_cpoe = c.nr_sequencia 
		and		c.nr_sequencia = nr_seq_item_p 
		and		dt_referencia_w between trunc(b.dt_horario,'hh') and trunc(cpoe_obter_dt_fim_etapa_gas(b.dt_horario, c.qt_hora_fase, c.nr_ocorrencia, c.ie_modo_adm),'hh');
		 
		if (coalesce(dt_horario_retorno_w::text, '') = '') then 
			select 	max(b.dt_horario +1), 
					max(cpoe_obter_dt_fim_etapa_gas(b.dt_horario +1, c.qt_hora_fase, c.nr_ocorrencia, c.ie_modo_adm)) 
			into STRICT	dt_horario_retorno_w, 
					dt_fim_etapa_w 
			from	prescr_gasoterapia a, 
					prescr_gasoterapia_hor b, 
					cpoe_gasoterapia c 
			where	a.nr_prescricao = b.nr_prescricao 
			and		a.nr_sequencia = b.nr_seq_gasoterapia 
			and		a.nr_seq_gas_cpoe = c.nr_sequencia 
			and		c.nr_sequencia = nr_seq_item_p 
			and		dt_referencia_w between trunc(b.dt_horario +1,'hh') and trunc(cpoe_obter_dt_fim_etapa_gas(b.dt_horario +1, c.qt_hora_fase, c.nr_ocorrencia, c.ie_modo_adm),'hh');
		end if;
		 
		if (dt_horario_retorno_w IS NOT NULL AND dt_horario_retorno_w::text <> '') then 
			ds_prescr_w := wheb_mensagem_pck.get_texto(460318) || ' '; ---Presc.:; 
			ds_aux_w	:= ' ' || wheb_mensagem_pck.get_texto(460313) || ' '; ---' até '; 
			ds_retorno_w := ds_prescr_w||to_char(dt_horario_retorno_w,'dd/mm/yyyy hh24:mi')||ds_aux_w|| to_char(dt_fim_etapa_w,'dd/mm/yyyy hh24:mi');
		end if;
		 
		if (dt_fim_horario_w IS NOT NULL AND dt_fim_horario_w::text <> '') then 
			dt_fim_horario_w := coalesce(cpoe_data_adm_item(nr_seq_item_p, ie_tipo_item_p, nr_seq_horario_w, null),dt_fim_horario_w);
			ds_adm_w	:= wheb_mensagem_pck.get_texto(460317) || '.: '; --Adm.: 
			ds_retorno_w := ds_retorno_w ||'<br>'||ds_adm_w||to_char(dt_fim_horario_w,'dd/mm/yyyy hh24:mi');
		end if;	
	end if;	
	 
elsif (ie_tipo_item_p = 'H') then 
 
	select	max(dt_liberacao) 
	into STRICT	dt_lib_w 
	from	cpoe_hemoterapia 
	where	nr_sequencia = nr_seq_item_p;
	 
	if (dt_lib_w IS NOT NULL AND dt_lib_w::text <> '') then 
	 
		select	max(a.dt_horario), 
				max(a.dt_fim_horario), 
				max(cpoe_obter_dt_fim_etapa_hem(a.dt_horario, d.qt_hora_min_infusao, d.nr_ocorrencia, d.cd_intervalo, a.nr_etapa)) 
		into STRICT	dt_horario_retorno_w, 
				dt_fim_horario_w, 
				dt_fim_etapa_w 
		from	prescr_proc_hor a, 
				prescr_procedimento b, 
				prescr_solic_bco_sangue c, 
				cpoe_hemoterapia d 
		where	a.nr_prescricao = b.nr_prescricao 
		and		a.nr_seq_procedimento = b.nr_sequencia 
		and		b.nr_prescricao = c.nr_prescricao 
		and		b.nr_seq_solic_sangue = c.nr_sequencia 
		and		c.nr_seq_hemo_cpoe = d.nr_sequencia 
		and		d.nr_sequencia = nr_seq_item_p 
		and		dt_referencia_w between trunc(a.dt_horario,'hh') and trunc(cpoe_obter_dt_fim_etapa_hem(a.dt_horario, d.qt_hora_min_infusao, d.nr_ocorrencia, d.cd_intervalo, a.nr_etapa),'hh');
		 
		if (coalesce(dt_horario_retorno_w::text, '') = '') then	 
			select	max(a.dt_horario +1), 
					max(cpoe_obter_dt_fim_etapa_hem(a.dt_horario +1, d.qt_hora_min_infusao, d.nr_ocorrencia, d.cd_intervalo, a.nr_etapa)) 
			into STRICT	dt_horario_retorno_w, 
					dt_fim_etapa_w 
			from	prescr_proc_hor a, 
					prescr_procedimento b, 
					prescr_solic_bco_sangue c, 
					cpoe_hemoterapia d 
			where	a.nr_prescricao = b.nr_prescricao 
			and		a.nr_seq_procedimento = b.nr_sequencia 
			and		b.nr_prescricao = c.nr_prescricao 
			and		b.nr_seq_solic_sangue = c.nr_sequencia 
			and		c.nr_seq_hemo_cpoe = d.nr_sequencia 
			and		d.nr_sequencia = nr_seq_item_p 
			and		dt_referencia_w between trunc(a.dt_horario +1,'hh') and trunc(cpoe_obter_dt_fim_etapa_hem(a.dt_horario +1, d.qt_hora_min_infusao, d.nr_ocorrencia, d.cd_intervalo, a.nr_etapa),'hh');
		end if;
		 
		if (dt_horario_retorno_w IS NOT NULL AND dt_horario_retorno_w::text <> '') then 
			ds_prescr_w := wheb_mensagem_pck.get_texto(460318) || ' '; ---Presc.:; 
			ds_aux_w	:= ' ' || wheb_mensagem_pck.get_texto(460313) || ' '; ---' até '; 
			ds_retorno_w := ds_prescr_w||to_char(dt_horario_retorno_w,'dd/mm/yyyy hh24:mi')||ds_aux_w|| to_char(dt_fim_etapa_w,'dd/mm/yyyy hh24:mi');
		end if;
		 
		if (dt_fim_horario_w IS NOT NULL AND dt_fim_horario_w::text <> '') then 
			dt_fim_horario_w := coalesce(cpoe_data_adm_item(nr_seq_item_p, ie_tipo_item_p, nr_seq_horario_w, null),dt_fim_horario_w);
			ds_adm_w	:= wheb_mensagem_pck.get_texto(460317) || '.: '; --Adm.: 
			ds_retorno_w := ds_retorno_w ||'<br>'||ds_adm_w||to_char(dt_fim_horario_w,'dd/mm/yyyy hh24:mi');
		end if;	
	end if;	
end if;
	 
return ds_retorno_w;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION cpoe_get_hint_timeline ( nr_seq_item_p bigint, ie_tipo_item_p text, cd_perfil_p bigint, dt_referencia_p timestamp, dt_inicio_grid_p timestamp, ds_hora_coluna_p text) FROM PUBLIC;

