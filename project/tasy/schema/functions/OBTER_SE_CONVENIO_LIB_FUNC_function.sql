-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_se_convenio_lib_func (cd_estabelecimento_p bigint, cd_convenio_p bigint, cd_funcao_p bigint, ie_opcao_p text, dt_referencia_p timestamp) RETURNS varchar AS $body$
DECLARE

 
ie_liberado_w		varchar(01)	:= 'S';
qt_regra_w		bigint;
cd_perfil_w		bigint;
qt_registro_w		bigint;
ie_considera_tab_w 	varchar(1);
ie_conv_estab_w		varchar(1);
/*QT - Se existe convenio cadastrado.... 
*/
 

BEGIN 
cd_perfil_w	:= coalesce(obter_perfil_ativo,0);
begin 
	SELECT	coalesce(max(1),0) 
	INTO STRICT	qt_regra_w 
	FROM	CONVEIO_ESTAB_FUNC_LIB a 
	WHERE	a.cd_estabelecimento	= cd_estabelecimento_p 
	AND		coalesce(a.IE_PERMITE_CONVENIO,'S')	= 'N' 
	AND		a.cd_funcao			= cd_funcao_p 
	AND		coalesce(a.cd_perfil,cd_perfil_w)	= cd_perfil_w 
	AND (coalesce(a.dt_inicio_regra,coalesce(dt_referencia_p,clock_timestamp()))		<= coalesce(dt_referencia_p,clock_timestamp()))  LIMIT 1;
exception 
when others then 
	qt_regra_w := 0;
end;
 
begin 
	select 	coalesce(max(1),0) 
	into STRICT 	qt_registro_w 
	from 	convenio_estabelecimento b 
	where 	b.cd_estabelecimento = cd_estabelecimento_p 
	and 	b.cd_convenio = cd_convenio_p  LIMIT 1;
 
exception 
when others then 
	qt_registro_w := 0;
end;
 
IF 	ie_opcao_p = 'QT' THEN 
	RETURN qt_regra_w;
END IF;	
 
IF (qt_regra_w	<> 0) THEN 
 
	SELECT	CASE WHEN COUNT(*)=0 THEN 'S'  ELSE 'N' END  
	INTO STRICT	ie_liberado_w 
	FROM	CONVEIO_ESTAB_FUNC_LIB 
	WHERE	cd_convenio		= cd_convenio_p 
	AND	cd_funcao		= cd_funcao_p 
	AND	coalesce(IE_PERMITE_CONVENIO,'S')	= 'N' 
	AND	cd_estabelecimento	= cd_estabelecimento_p 
	AND	coalesce(cd_perfil,cd_perfil_w)	= cd_perfil_w 
	AND (coalesce(dt_inicio_regra,coalesce(dt_referencia_p,clock_timestamp()))		<= coalesce(dt_referencia_p,clock_timestamp()));
END IF;
	 
if (cd_funcao_p = 869) then 
 
	select coalesce(max(IE_CONSISTE_CONV_ESTAB),'N') 
	into STRICT ie_conv_estab_w 
	from parametro_agenda_integrada 
	where coalesce(cd_estabelecimento, cd_estabelecimento_p) = cd_estabelecimento_p;
 
	if (ie_conv_estab_w = 'S') and (qt_registro_w = 0) and (ie_liberado_w = 'S') then 
		ie_liberado_w := 'N';
	end if;
else 
	ie_considera_tab_w := Obter_Param_Usuario(916, 669, obter_perfil_ativo, wheb_usuario_pck.get_nm_usuario, cd_estabelecimento_p, ie_considera_tab_w);
 
	if (ie_considera_tab_w = 'S') and (qt_registro_w = 0) and (ie_liberado_w = 'S') then 
		ie_liberado_w := 'N';
	end if;
end if;
 
 
RETURN	ie_liberado_w;
 
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_se_convenio_lib_func (cd_estabelecimento_p bigint, cd_convenio_p bigint, cd_funcao_p bigint, ie_opcao_p text, dt_referencia_p timestamp) FROM PUBLIC;

