-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION pls_obter_totais_analise (nr_analise_p bigint, nr_id_transacao_p bigint, nr_seq_conta_p bigint, ie_campo text) RETURNS bigint AS $body$
DECLARE


vl_retorno  double precision;

/* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Finalidade: Obter os valores totais da analise para serem exibidos nos totalizadores da tela
------------------------------------------------------------------------------------------------

Locais de chamada direta: 
[ ]  Objetos do dicionario [X] Tasy (Delphi/Java) [  ] Portal [  ]  Relatorios [ ] Outros:
 -----------------------------------------------------------------------------------------------

Pontos de atencao:

VL_AP = Valor Apresentado
VL_GL = Valor Glosa
VL_LB = Valor Liberado
VL_CL = Valor Calculado
QT_AP = Quantidade Apresentado
QT_LB = Quantidade Liberado
VL_PD = Valor Pendente

++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */
BEGIN

    if (ie_campo = 'VL_AP') then
    
        select tab.vl_apresentado
          into STRICT vl_retorno
          from w_pls_analise_item a,  
            (SELECT (coalesce((select sum(p.vl_procedimento_imp)  
                            from    pls_conta_proc_v p  
                           where    p.nr_seq_analise    = b.nr_sequencia  
                             and    p.nr_seq_conta = coalesce(nr_seq_conta_p,p.nr_seq_conta) 
                             and    p.ie_status not in ('D','M')),0) +   
                    (coalesce((select sum(p.vl_material_imp)  
                            from    pls_conta_mat_v p  
                           where    p.nr_seq_analise    = b.nr_sequencia  
                             and    p.nr_seq_conta = coalesce(nr_seq_conta_p,p.nr_seq_conta) 
                             and    p.ie_status not in ('D','M')),0)
                            )
                    ) vl_apresentado  
              from pls_analise_conta b  
             where  nr_sequencia = nr_analise_p
            ) tab  
         where a.nr_seq_analise = nr_analise_p
           and a.nr_id_transacao = nr_id_transacao_p
           and a.ie_tipo_linha = 'C'  
           and (a.nr_seq_conta IS NOT NULL AND a.nr_seq_conta::text <> '')  
           and a.nr_seq_conta = coalesce(nr_seq_conta_p,a.nr_seq_conta);

    elsif (ie_campo = 'VL_GL') then
    
        select  tab.vl_glosa
          into STRICT vl_retorno
          from w_pls_analise_item a,  
            (SELECT (coalesce((select sum(p.vl_glosa)  
                            from pls_conta_proc_v p  
                           where p.nr_seq_analise    = b.nr_sequencia  
                             and p.nr_seq_conta = coalesce(nr_seq_conta_p,p.nr_seq_conta)    
                             and p.ie_status not in ('D','M')),0) +  
                    coalesce((select sum(p.vl_glosa)  
                           from pls_conta_mat_v p  
                          where p.nr_seq_analise    = b.nr_sequencia  
                            and p.nr_seq_conta = coalesce(nr_seq_conta_p,p.nr_seq_conta) 
                            and p.ie_status not in ('D','M')),0
                        )
                    ) vl_glosa
              from pls_analise_conta b  
             where  nr_sequencia = nr_analise_p
            ) tab  
        where a.nr_seq_analise = nr_analise_p
          and a.nr_id_transacao = nr_id_transacao_p
          and a.ie_tipo_linha = 'C'  
          and (a.nr_seq_conta IS NOT NULL AND a.nr_seq_conta::text <> '')  
          and a.nr_seq_conta = coalesce(nr_seq_conta_p,a.nr_seq_conta);
    
    elsif (ie_campo = 'VL_LB') then
    
        select tab.vl_liberado
          into STRICT vl_retorno
          from w_pls_analise_item a,
            (SELECT (coalesce((select sum(p.vl_liberado)  
                            from pls_conta_proc_v p  
                           where p.nr_seq_analise    = b.nr_sequencia  
                             and p.nr_seq_conta = coalesce(nr_seq_conta_p,p.nr_seq_conta)    
                             and p.ie_status not in ('D','M')),0) +  
                     coalesce((select sum(p.vl_liberado)  
                            from pls_conta_mat_v p  
                           where p.nr_seq_analise    = b.nr_sequencia  
                             and p.nr_seq_conta = coalesce(nr_seq_conta_p,p.nr_seq_conta)    
                             and p.ie_status not in ('D','M')),0
                        )
                    )vl_liberado
            from pls_analise_conta b  
           where nr_sequencia = nr_analise_p
        ) tab  
        where a.nr_seq_analise = nr_analise_p
         and a.nr_id_transacao = nr_id_transacao_p
         and a.ie_tipo_linha = 'C'  
         and (a.nr_seq_conta IS NOT NULL AND a.nr_seq_conta::text <> '')  
         and a.nr_seq_conta = coalesce(nr_seq_conta_p,a.nr_seq_conta);

    elsif (ie_campo = 'VL_CL') then
    
        select tab.vl_calculado
          into STRICT vl_retorno
          from w_pls_analise_item a,
            (SELECT (coalesce((select sum(p.vl_procedimento)  
                            from pls_conta_proc_v p  
                           where p.nr_seq_analise  = b.nr_sequencia  
                             and p.nr_seq_conta = coalesce(nr_seq_conta_p,p.nr_seq_conta)    
                             and p.ie_status  not in ('D','M')),0) +  
                    coalesce((select sum(p.vl_material)  
                           from pls_conta_mat_v p  
                          where p.nr_seq_analise  = b.nr_sequencia  
                            and p.nr_seq_conta = coalesce(nr_seq_conta_p,p.nr_seq_conta) 
                            and p.ie_status  not in ('D','M')),0)
                    ) vl_calculado
              from pls_analise_conta b  
             where  nr_sequencia = nr_analise_p
            ) tab  
        where a.nr_seq_analise = nr_analise_p
         and a.nr_id_transacao = nr_id_transacao_p
         and a.ie_tipo_linha = 'C'      
         and (a.nr_seq_conta IS NOT NULL AND a.nr_seq_conta::text <> '')  
         and a.nr_seq_conta = coalesce(nr_seq_conta_p,a.nr_seq_conta);
    
    elsif (ie_campo = 'QT_AP') then
    
        select coalesce(sum(a.qt_apresentada),0)
          into STRICT vl_retorno
          from w_pls_analise_item a 
         where a.nr_seq_analise = nr_analise_p
           and a.nr_id_transacao = nr_id_transacao_p
           and a.ie_tipo_linha = 'IC'  
        and a.ie_tipo_item in ('M', 'P')
           and (a.nr_seq_conta IS NOT NULL AND a.nr_seq_conta::text <> '')  
           and a.nr_seq_conta = coalesce(nr_seq_conta_p,a.nr_seq_conta);

    elsif (ie_campo = 'QT_LB') then
    
        select coalesce(sum(a.qt_liberado),0)
          into STRICT vl_retorno
          from w_pls_analise_item a 
         where a.nr_seq_analise = nr_analise_p
           and a.nr_id_transacao = nr_id_transacao_p
           and a.ie_tipo_linha = 'IC'  
        and a.ie_tipo_item in ('M', 'P')
           and (a.nr_seq_conta IS NOT NULL AND a.nr_seq_conta::text <> '')  
           and a.nr_seq_conta = coalesce(nr_seq_conta_p,a.nr_seq_conta);

    elsif (ie_campo = 'VL_PD') then
    
        select coalesce(sum(a.vl_apresentado),0)
          into STRICT vl_retorno
          from w_pls_analise_item a 
         where a.nr_seq_analise = nr_analise_p
           and a.nr_id_transacao = nr_id_transacao_p
           and a.ie_tipo_linha = 'IC'  
           and a.ie_tipo_item in ('M', 'P')
           and a.ie_status_item = 'P'
           and (a.nr_seq_conta IS NOT NULL AND a.nr_seq_conta::text <> '')  
           and a.nr_seq_conta = coalesce(nr_seq_conta_p,a.nr_seq_conta);

    else 
        vl_retorno := 0;
    end if;

return vl_retorno;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION pls_obter_totais_analise (nr_analise_p bigint, nr_id_transacao_p bigint, nr_seq_conta_p bigint, ie_campo text) FROM PUBLIC;

