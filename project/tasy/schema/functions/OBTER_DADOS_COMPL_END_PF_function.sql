-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_dados_compl_end_pf ( cd_pessoa_fisica_p compl_pessoa_fisica.cd_pessoa_fisica%TYPE, ie_tipo_complemento_p compl_pessoa_fisica.ie_tipo_complemento%TYPE DEFAULT null, ie_opcao_p compl_pessoa_fisica.ie_tipo_complemento%TYPE DEFAULT null) RETURNS varchar AS $body$
DECLARE


/* 
DESCRICAO DOS TIPOS DE COMPLEMENTOS : VARIAVEL DE VALIDACAO [ ie_tipo_complemento_p type:varchar2 ]

     1 - residencial
     2 - Comercial
     3 - responsavel
     4 - Pai
     5 - Mae
     6 - Conjuge
     7 - Hospedagem
     8 - Todos
     9 - Adicional	
     99- Todos
     
TIPOS DE DESCRICAO DE COMPLEMENTOS : VARIAVEL DE VALIDACAO [ ie_opcao_p type:number ]
    
    5 - cidade
    7 - cep
    8 - nome da rua + numero + bairro (endereco)
    9 - nome da rua + numero + bairro + cidade (endereco)
    10- nome da rua + numero + bairro + cidade + cep (endereco)
*/
    nr_sequencia_compl_w    compl_pessoa_fisica.nr_sequencia%TYPE;
    ie_tipo_complemento_w   compl_pessoa_fisica.ie_tipo_complemento%TYPE;
    ie_opcao_w              compl_pessoa_fisica.ie_tipo_complemento%TYPE;
    ds_retorno_w            varchar(255);
    ds_descricao_w          varchar(255);



BEGIN
    IF ( coalesce(cd_pessoa_fisica_p::text, '') = '' ) THEN
        ds_retorno_w := null;
        RETURN ds_retorno_w;

    ELSE

        IF ( coalesce(ie_opcao_p::text, '') = '' ) THEN
            ie_opcao_w := 8;
        ELSE
            ie_opcao_w := ie_opcao_p;
        END IF;

        IF ( coalesce(ie_tipo_complemento_p::text, '') = '' ) THEN
            ie_tipo_complemento_w := 1;
        ELSE
            ie_tipo_complemento_w := ie_tipo_complemento_p;
        END IF;

            SELECT
                MAX(nr_sequencia)
            INTO STRICT nr_sequencia_compl_w
            FROM
                compl_pessoa_fisica
            WHERE
                cd_pessoa_fisica = cd_pessoa_fisica_p
            AND ie_tipo_complemento = ie_tipo_complemento_w;


            IF ( coalesce(nr_sequencia_compl_w::text, '') = '' ) THEN
                ds_retorno_w := null;
                RETURN ds_retorno_w;
            ELSE

                IF ( ie_opcao_w = 5 ) THEN
                    SELECT
                        cidade
                    INTO STRICT ds_descricao_w
                    FROM (
                            SELECT
                                rtrim(ltrim(rtrim(ltrim(a.ds_municipio || CASE WHEN coalesce(a.ds_municipio::text, '') = '' THEN  ''  ELSE ', ' END
                                                        )), ','), ',') cidade
                            FROM
                                compl_pessoa_fisica a
                            WHERE
                                a.cd_pessoa_fisica = cd_pessoa_fisica_p
                                AND a.ie_tipo_complemento = ie_tipo_complemento_w
                            ORDER BY
                                a.nr_sequencia DESC
                        ) alias6 LIMIT 1;

                END IF;


                IF ( ie_opcao_w = 7 ) THEN
                    SELECT
                        cep
                    INTO STRICT ds_descricao_w
                    FROM (
                            SELECT
                                rtrim(ltrim(rtrim(ltrim(a.cd_cep || CASE WHEN coalesce(a.cd_cep::text, '') = '' THEN  ''  ELSE ', ' END
                                                        )), ','), ',') cep
                            FROM
                                compl_pessoa_fisica a
                            WHERE
                                a.cd_pessoa_fisica = cd_pessoa_fisica_p
                                AND a.ie_tipo_complemento = ie_tipo_complemento_w
                            ORDER BY
                                a.nr_sequencia DESC
                        ) alias6 LIMIT 1;

                END IF;

                
                IF ( ie_opcao_w = 8 ) THEN
                    SELECT
                        endereco
                    INTO STRICT ds_descricao_w
                    FROM (
                            SELECT
                                rtrim(ltrim(rtrim(ltrim(a.ds_endereco
                                                        || CASE WHEN coalesce(a.ds_endereco::text, '') = '' THEN  ''  ELSE ', ' END 
                                                        || a.ds_compl_end
                                                        || CASE WHEN coalesce(a.ds_compl_end::text, '') = '' THEN  ''  ELSE ', ' END 
                                                        || a.ds_bairro
                                                        || CASE WHEN coalesce(a.ds_bairro::text, '') = '' THEN  ''  ELSE ', ' END 
                                                        || a.ds_complemento)), ','), ',') endereco
                            FROM
                                compl_pessoa_fisica a
                            WHERE
                                a.cd_pessoa_fisica = cd_pessoa_fisica_p
                                AND a.ie_tipo_complemento = ie_tipo_complemento_w
                            ORDER BY
                                a.nr_sequencia DESC
                        ) alias8 LIMIT 1;

                END IF;

                IF ( ie_opcao_w = 9 ) THEN
                    SELECT
                        endereco
                    INTO STRICT ds_descricao_w
                    FROM (
                            SELECT
                                rtrim(ltrim(rtrim(ltrim(a.ds_endereco
                                                        || CASE WHEN coalesce(a.ds_endereco::text, '') = '' THEN  ''  ELSE ', ' END
                                                        || a.ds_compl_end
                                                        || CASE WHEN coalesce(a.ds_compl_end::text, '') = '' THEN  ''  ELSE ', ' END 
                                                        || a.ds_bairro
                                                        || CASE WHEN coalesce(a.ds_bairro::text, '') = '' THEN  ''  ELSE ', ' END 
                                                        || a.ds_complemento)
                                                        || CASE WHEN coalesce(a.ds_complemento::text, '') = '' THEN  ''  ELSE ', ' END 
                                                        || a.ds_municipio
                                                        || CASE WHEN coalesce(a.ds_municipio::text, '') = '' THEN  ''  ELSE ', ' END 
                                                        ), ','), ',') endereco
                            FROM
                                compl_pessoa_fisica a
                            WHERE
                                a.cd_pessoa_fisica = cd_pessoa_fisica_p
                                AND a.ie_tipo_complemento = ie_tipo_complemento_w
                            ORDER BY
                                a.nr_sequencia DESC
                        ) alias10 LIMIT 1;

                END IF;


                IF ( ie_opcao_w = 10 ) THEN
                    SELECT
                        endereco
                    INTO STRICT ds_descricao_w
                    FROM (
                            SELECT
                                rtrim(ltrim(rtrim(ltrim(a.ds_endereco
                                                        || CASE WHEN coalesce(a.ds_endereco::text, '') = '' THEN  ''  ELSE ', ' END 
                                                        || a.ds_compl_end
                                                        || CASE WHEN coalesce(a.ds_compl_end::text, '') = '' THEN  ''  ELSE ', ' END 
                                                        || a.ds_bairro
                                                        || CASE WHEN coalesce(a.ds_bairro::text, '') = '' THEN  ''  ELSE ', ' END 
                                                        || a.ds_complemento)
                                                        || CASE WHEN coalesce(a.ds_complemento::text, '') = '' THEN  ''  ELSE ', ' END 
                                                        || a.ds_municipio
                                                        || CASE WHEN coalesce(a.ds_municipio::text, '') = '' THEN  ''  ELSE ', ' END 
                                                        || a.cd_cep
                                                        || CASE WHEN coalesce(a.cd_cep::text, '') = '' THEN  ''  ELSE ', ' END 
                                                        ), ','), ',') endereco
                            FROM
                                compl_pessoa_fisica a
                            WHERE
                                a.cd_pessoa_fisica = cd_pessoa_fisica_p
                                AND a.ie_tipo_complemento = ie_tipo_complemento_w
                            ORDER BY
                                a.nr_sequencia DESC
                        ) alias11 LIMIT 1;

                END IF;

                IF (ds_descricao_w IS NOT NULL AND ds_descricao_w::text <> '') THEN
                    ds_retorno_w := ds_descricao_w;
                ELSE
                    ds_retorno_w := NULL;
                END IF;
            END IF;
        END IF;

RETURN ds_retorno_w;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_dados_compl_end_pf ( cd_pessoa_fisica_p compl_pessoa_fisica.cd_pessoa_fisica%TYPE, ie_tipo_complemento_p compl_pessoa_fisica.ie_tipo_complemento%TYPE DEFAULT null, ie_opcao_p compl_pessoa_fisica.ie_tipo_complemento%TYPE DEFAULT null) FROM PUBLIC;

