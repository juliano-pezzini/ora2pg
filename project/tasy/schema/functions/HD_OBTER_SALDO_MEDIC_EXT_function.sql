-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION hd_obter_saldo_medic_ext (cd_material_p bigint, cd_pessoa_fisica_p text, ie_opcao_p text) RETURNS bigint AS $body$
DECLARE

nr_seq_medic_ext_w	bigint;
qt_saldo_pac_w		bigint := 0;
qt_medicamento_w	bigint := 0;
qt_retorno_w		bigint := 0;
qt_medic_pac_w		bigint := 0;
qt_saldo_w		bigint := 0;


BEGIN

select	max(nr_sequencia)
into STRICT	nr_seq_medic_ext_w
from	hd_medic_externo
where	cd_material = cd_material_p;

if (nr_seq_medic_ext_w IS NOT NULL AND nr_seq_medic_ext_w::text <> '') then
	/*select	max(sum(x.qt_material) - nvl(hd_obter_qt_med_utilizado(x.cd_pessoa_fisica,y.nr_seq_medic),0)) qt_saldo
	into	qt_saldo_pac_w
	from 	hd_lote_paciente x,
		hd_entrega_medic y
	where 	x.nr_seq_entrega = y.nr_sequencia
	and	x.cd_pessoa_fisica = cd_pessoa_fisica_p
	and	y.nr_seq_medic = nr_seq_medic_ext_w
	and	y.dt_liberacao is not null
	and	y.cd_estabelecimento = wheb_usuario_pck.get_cd_estabelecimento
	group by x.cd_pessoa_fisica,
		 y.nr_seq_medic;	*/
	qt_saldo_pac_w :=	coalesce(hd_obter_qt_saldo_medic(null,nr_seq_medic_ext_w,cd_pessoa_fisica_p, wheb_usuario_pck.get_cd_estabelecimento),0);

	select	sum(coalesce((substr(hd_obter_dados_entrega(nr_sequencia,'T'),1,10))::numeric ,0)) qt_medic,
		sum(coalesce(substr(hd_obter_qt_total_medic_pac(nr_sequencia),1,255),0)) qt_medic_pac
	into STRICT	qt_medicamento_w,
		qt_medic_pac_w
	from	hd_entrega_medic
	where	(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
	and	nr_seq_medic = nr_seq_medic_ext_w
	and	cd_estabelecimento = wheb_usuario_pck.get_cd_estabelecimento;

	qt_saldo_w := qt_medicamento_w - qt_medic_pac_w;


end if;

if (ie_opcao_p = 'SA') then --Saldo pacienteo
	qt_retorno_w	:= qt_saldo_pac_w;
elsif (ie_opcao_p = 'SNC') then -- Saldo n√£o vinculado a pacientes
	qt_retorno_w	:= qt_saldo_w;
end if;

return	qt_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION hd_obter_saldo_medic_ext (cd_material_p bigint, cd_pessoa_fisica_p text, ie_opcao_p text) FROM PUBLIC;

