-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_dados_visao_atributo ( nr_seq_visao_p bigint, nm_atributo_p text, ie_opcao_p text) RETURNS varchar AS $body$
DECLARE

nm_tabela_w varchar(2000);
ds_retorno_w	varchar(4000);

cd_dominio_w			bigint;

ds_dominio_w			varchar(300);

nm_tabela_referencia_w		varchar(255);

ds_retorno_retorno_tab_ref_w	varchar(1000);

ds_atributo_w			varchar(4000);

ds_cadastro_w			varchar(254);

ie_cadastro_geral_w		varchar(3);

ds_funcao_w			varchar(80);

ds_aplicacao_w			varchar(15);

nr_seq_modulo_w			bigint;



	procedure VerificaTabelaPrincipal(nm_tabela_pai text) is

	ds_tabela_adicional_w varchar(50);

	ds_cadastro_adicional_w varchar(80);

	ie_cadastro_geral_adicional_w varchar(3);

	
BEGIN

		SELECT	MAX(SUBSTR(obter_desc_expressao(cd_exp_cadastro, ds_cadastro), 1, 254)),

			MAX(ie_cadastro_geral),

			MAX(nm_tabela)

		into STRICT 	ds_cadastro_adicional_w,

			ie_cadastro_geral_adicional_w,

			ds_tabela_adicional_w

		FROM	tabela_sistema

		WHERE	nm_tabela = (SELECT nm_tabela_superior FROM tabela_sistema WHERE nm_tabela = nm_tabela_pai);



		if (ds_cadastro_adicional_w IS NOT NULL AND ds_cadastro_adicional_w::text <> '' AND ie_cadastro_geral_adicional_w = 'S') then

			ds_cadastro_w := ds_cadastro_adicional_w  || ' > ' || ds_cadastro_w;

			VerificaTabelaPrincipal(ds_tabela_adicional_w);

		end if;

	end;


begin

	if (ie_opcao_p = 'D') then



		nm_tabela_referencia_w		:= '';

		ds_dominio_w			:= '';

		SELECT 	CASE WHEN coalesce(max(a.cd_dominio)::text, '') = '' THEN  max(c.cd_dominio)  ELSE max(a.cd_dominio) END  cd_dominio ,
			max(substr(obter_desc_expressao((CASE WHEN coalesce(a.cd_exp_desc::text, '') = '' THEN  c.cd_exp_desc  ELSE a.cd_exp_desc END ), c.ds_atributo),1,4000)) ds_expressao,
      max(c.nm_tabela)
		into STRICT	cd_dominio_w,
			ds_atributo_w,
      nm_tabela_w
		  FROM TABELA_VISAO_ATRIBUTO A, TABELA_VISAO b, TABELA_ATRIBUTO c
		 WHERE A.NM_ATRIBUTO = nm_atributo_p
		   and a.nr_SEQUENCIA = nr_seq_visao_p
		   and a.nr_sequencia = b.nr_sequencia
		   and b.nm_tabela = c.nm_tabela
		   and a.nm_atributo = c.nm_atributo;



		if (cd_dominio_w IS NOT NULL AND cd_dominio_w::text <> '') then

			select	substr(wheb_mensagem_pck.get_texto(284570) || substr(obter_desc_expressao(CD_EXP_DESC_DOMINIO, a.ds_dominio), 1, 254) || ' (' ||
				cd_dominio_w || ')' || chr(10) || wheb_mensagem_pck.get_texto(284579) || substr(obter_desc_expressao(b.cd_exp_modulo,b.nm_modulo),1,254), 1, 300)
			into STRICT	ds_dominio_w
			FROM dominio a
LEFT OUTER JOIN modulo_tasy b ON (a.nr_seq_modulo = b.nr_sequencia)
WHERE a.cd_dominio	= cd_dominio_w;

		else

			select	max(nm_tabela_referencia)
			into STRICT	nm_tabela_referencia_w
			from 	integridade_referencial b,
				integridade_atributo a
			where	a.nm_tabela			= nm_tabela_w
			  and	a.nm_atributo			= nm_atributo_p
			  and a.nm_tabela			= b.nm_tabela
		        and a.nm_integridade_referencial	= b.nm_integridade_referencial;

			if (nm_tabela_referencia_w IS NOT NULL AND nm_tabela_referencia_w::text <> '') then

				select	max(substr(obter_desc_expressao(cd_exp_cadastro, ds_cadastro), 1, 254)),
					max(ie_cadastro_geral),
					max(ds_aplicacao),
					max(nr_seq_modulo)
				into STRICT	ds_cadastro_w,
					ie_cadastro_geral_w,
					ds_aplicacao_w,
					nr_seq_modulo_w
				from	tabela_sistema
				where	nm_tabela	= nm_tabela_referencia_w;

				ds_retorno_retorno_tab_ref_w		:= wheb_mensagem_pck.get_texto(284572) || ds_cadastro_w || ' ' || nm_tabela_referencia_w || chr(10);

				if (ie_cadastro_geral_w = 'S') then

					select 	max(coalesce(cd_aplicacao_tasy, ds_aplicacao_w))
					into STRICT	ds_aplicacao_w
					from	modulo_tasy
					where	nr_sequencia  = nr_seq_modulo_w;

					VerificaTabelaPrincipal(nm_tabela_referencia_w);

					ds_retorno_retorno_tab_ref_w	:= ds_retorno_retorno_tab_ref_w || wheb_mensagem_pck.get_texto(284573) ||

													substr(obter_desc_aplicacao(ds_aplicacao_w),1,255) || ' > ' ||

													substr(Obter_Nome_Modulo(nr_seq_modulo_w),1,255) || ' > ' ||

													substr(ds_cadastro_w,1,255) || chr(10);

				end if;

			end if;

		end if;
		ds_retorno_w := ds_atributo_w || chr(10) || ds_dominio_w || ds_retorno_retorno_tab_ref_w;

	else
		select	CASE WHEN ie_opcao_p='L' THEN  obter_desc_expressao(cd_exp_label, ds_label) WHEN ie_opcao_p='V' THEN  ds_valores  ELSE obter_desc_expressao(cd_exp_label, ds_label) END

		into STRICT	ds_retorno_w

		from	tabela_visao_atributo

		where	nr_sequencia	= nr_seq_visao_p

		and	nm_atributo	= nm_atributo_p;
	end if;


	return	ds_retorno_w;



end	;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_dados_visao_atributo ( nr_seq_visao_p bigint, nm_atributo_p text, ie_opcao_p text) FROM PUBLIC;

