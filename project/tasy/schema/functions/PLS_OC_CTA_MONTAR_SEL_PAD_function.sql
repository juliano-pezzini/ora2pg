-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION pls_oc_cta_montar_sel_pad ( ie_incidencia_regra_p text, dados_restricao_p pls_tipos_ocor_pck.dados_restricao_select, nm_usuario_p usuario.nm_usuario%type) RETURNS varchar AS $body$
DECLARE

/* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Finalidade: Cria os selects padrões de acordo com a aplicacao da regra sendo verifica
-------------------------------------------------------------------------------------------------------------------
Locais de chamada direta:
[X]  Objetos do dicionário [ ] Tasy (Delphi/Java) [  ] Portal [  ]  Relatórios [ ] Outros:
 ------------------------------------------------------------------------------------------------------------------
Pontos de atenção:
Cuidar com os ALIAS... Dar nome padronizado, para facilitar identificação e não repetir..
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */
ds_select_w		varchar(4000);


BEGIN

-- Montar select base
-- Os selects que forem montados nesta function poderão ser usados em vários lugares diferentes em situações diferentes, portanto  deve ser respeitado o mesmo número de colunas
-- para todos os selects, para que, na hora que forem executados nã seje necessário verificar qual dos mesmos está sendo usado, podendo obter os valores desejados atrvés do cursor
-- dinãmico e usá-los para manipulação de registros.
-- Por padrão usar o select da conta, se a incidência da regra for nos itens então são montados os selects por item.
-- Por conta
ds_select_w	:=	'select	conta.nr_sequencia	nr_seq_conta , ' || pls_tipos_ocor_pck.enter_w ||
			'	null			nr_seq_item, '|| pls_tipos_ocor_pck.enter_w ||
			'	''C''			ie_tipo_item ' || pls_tipos_ocor_pck.enter_w ||
			'from	pls_protocolo_conta	prot,' || pls_tipos_ocor_pck.enter_w ||
			'	pls_conta_ocor_v	conta' || pls_tipos_ocor_pck.enter_w ||
			'where	1 = 1 ' ||
			dados_restricao_p.ds_restricao_lote ||
			dados_restricao_p.ds_restricao_protocolo || pls_tipos_ocor_pck.enter_w ||
			'and	conta.nr_seq_protocolo = prot.nr_sequencia ' ||
			dados_restricao_p.ds_restricao_conta;

-- Por procedimento
if (ie_incidencia_regra_p = 'P') then

	ds_select_w	:=	'select	proc.nr_seq_conta	nr_seq_conta, '|| pls_tipos_ocor_pck.enter_w ||
				'	proc.nr_sequencia	nr_seq_item, ' || pls_tipos_ocor_pck.enter_w ||
				'	''P''			ie_tipo_item ' || pls_tipos_ocor_pck.enter_w ||
				'from	pls_protocolo_conta prot,' || pls_tipos_ocor_pck.enter_w ||
				'	pls_conta_ocor_v conta,' || pls_tipos_ocor_pck.enter_w ||
				'	pls_conta_proc_ocor_v proc' || pls_tipos_ocor_pck.enter_w ||
				'where	1 = 1 ' ||
				dados_restricao_p.ds_restricao_lote ||
				dados_restricao_p.ds_restricao_protocolo || pls_tipos_ocor_pck.enter_w ||
				'and	conta.nr_seq_protocolo = prot.nr_sequencia ' ||
				dados_restricao_p.ds_restricao_conta || pls_tipos_ocor_pck.enter_w ||
				'and	proc.nr_seq_conta = conta.nr_sequencia ' ||
				dados_restricao_p.ds_restricao_proc;
-- Por material
elsif (ie_incidencia_regra_p = 'M') then

	ds_select_w	:= 	'select	mat.nr_seq_conta	nr_seq_conta, ' || pls_tipos_ocor_pck.enter_w ||
				'	mat.nr_sequencia	nr_seq_item, '|| pls_tipos_ocor_pck.enter_w ||
				'	''M''			ie_tipo_item ' || pls_tipos_ocor_pck.enter_w ||
				'from	pls_protocolo_conta prot,' || pls_tipos_ocor_pck.enter_w ||
				'	pls_conta_ocor_v conta,' || pls_tipos_ocor_pck.enter_w ||
				'	pls_conta_mat_ocor_v mat' || pls_tipos_ocor_pck.enter_w ||
				'where	1 = 1 ' ||
				dados_restricao_p.ds_restricao_lote ||
				dados_restricao_p.ds_restricao_protocolo || pls_tipos_ocor_pck.enter_w ||
				'and	conta.nr_seq_protocolo = prot.nr_sequencia ' ||
				dados_restricao_p.ds_restricao_conta || pls_tipos_ocor_pck.enter_w ||
				'and	mat.nr_seq_conta = conta.nr_sequencia ' ||
				dados_restricao_p.ds_restricao_mat;
-- Por procedimento / material  e Conforme a regra externa.
elsif	((ie_incidencia_regra_p = 'PM') or (ie_incidencia_regra_p = 'RV')) then

	ds_select_w	:= 	'select	proc.nr_seq_conta	nr_seq_conta, '|| pls_tipos_ocor_pck.enter_w ||
				'	proc.nr_sequencia	nr_seq_item, ' || pls_tipos_ocor_pck.enter_w ||
				'	''P''			ie_tipo_item ' || pls_tipos_ocor_pck.enter_w ||
				'from	pls_protocolo_conta prot,' || pls_tipos_ocor_pck.enter_w ||
				'	pls_conta_ocor_v conta,' || pls_tipos_ocor_pck.enter_w ||
				'	pls_conta_proc_ocor_v proc' || pls_tipos_ocor_pck.enter_w ||
				'where	1 = 1 ' ||
				dados_restricao_p.ds_restricao_lote ||
				dados_restricao_p.ds_restricao_protocolo || pls_tipos_ocor_pck.enter_w ||
				'and	conta.nr_seq_protocolo = prot.nr_sequencia ' ||
				dados_restricao_p.ds_restricao_conta || pls_tipos_ocor_pck.enter_w ||
				'and	proc.nr_seq_conta = conta.nr_sequencia ' ||
				dados_restricao_p.ds_restricao_proc || pls_tipos_ocor_pck.enter_w ||
				'union ' || pls_tipos_ocor_pck.enter_w ||
				'select	mat.nr_seq_conta	nr_seq_conta, ' || pls_tipos_ocor_pck.enter_w ||
				'	mat.nr_sequencia	nr_seq_item, '|| pls_tipos_ocor_pck.enter_w ||
				'	''M''		ie_tipo_item ' || pls_tipos_ocor_pck.enter_w ||
				'from	pls_protocolo_conta prot,' || pls_tipos_ocor_pck.enter_w ||
				'	pls_conta_ocor_v conta,' || pls_tipos_ocor_pck.enter_w ||
				'	pls_conta_mat_ocor_v mat' || pls_tipos_ocor_pck.enter_w ||
				'where	1 = 1 ' ||
				dados_restricao_p.ds_restricao_lote ||
				dados_restricao_p.ds_restricao_protocolo || pls_tipos_ocor_pck.enter_w ||
				'and	conta.nr_seq_protocolo = prot.nr_sequencia ' ||
				dados_restricao_p.ds_restricao_conta || pls_tipos_ocor_pck.enter_w ||
				'and	mat.nr_seq_conta = conta.nr_sequencia ' ||
				dados_restricao_p.ds_restricao_mat;
end if;

return	ds_select_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION pls_oc_cta_montar_sel_pad ( ie_incidencia_regra_p text, dados_restricao_p pls_tipos_ocor_pck.dados_restricao_select, nm_usuario_p usuario.nm_usuario%type) FROM PUBLIC;

