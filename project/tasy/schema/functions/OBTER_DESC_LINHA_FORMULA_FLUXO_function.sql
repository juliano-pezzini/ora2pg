-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_desc_linha_formula_fluxo (ds_formula_p text, dt_referencia_p timestamp, dt_inicial_p timestamp, dt_final_p timestamp, ie_diario_p text, cd_estabelecimento_p bigint, ie_restringe_estab_p text, nm_usuario_p text) RETURNS varchar AS $body$
DECLARE


ds_retorno_w		formula_fluxo_caixa_agrup.ds_formula%type;
ds_formula_orig_w	formula_fluxo_caixa_agrup.ds_formula%type;
ds_formula_w		formula_fluxo_caixa_agrup.ds_formula%type;
ds_formula_ww		formula_fluxo_caixa_agrup.ds_formula%type;
ds_formula_fim_w	formula_fluxo_caixa_agrup.ds_formula%type;
nm_tabela_w		valor_fluxo_caixa_agrup.nm_tabela%type;
nm_atributo_w		valor_fluxo_caixa_agrup.nm_atributo%type;
ds_macro_w		formula_fluxo_caixa_agrup.ds_macro%type;
ie_tipo_formula_w	formula_fluxo_caixa_agrup.ie_tipo_formula%type;
ie_possui_macro_w	integer;
nr_pos_inicial_w	integer;
nr_pos_final_w		integer;
ie_formula_w		varchar(1);
ie_fechamento_diario_w	varchar(10);
cd_empresa_w		estabelecimento.cd_empresa%type;
vl_especie_w		caixa_receb.vl_especie%type;

dt_referencia_w		timestamp;
dt_inicio_mes_w		timestamp;
dt_final_mes_w		timestamp;
dt_inicial_w		timestamp;
dt_fechamento_w		timestamp;
dt_fechamento_mes_w	timestamp;
dt_inicio_dia_w		timestamp;


BEGIN

ds_formula_orig_w	:= ds_formula_p;
ds_retorno_w		:= '';
dt_inicio_mes_w		:= trunc(dt_inicial_p,'month');
dt_final_mes_w		:= trunc(dt_final_p,'month');

if (coalesce(ie_diario_p,'S')	= 'S') then

	dt_referencia_w	:= fim_dia(dt_referencia_p);
	dt_inicial_w	:= trunc(dt_inicial_p,'dd');

else

	dt_referencia_w	:= fim_mes(dt_referencia_p);
	dt_inicial_w	:= trunc(dt_inicial_p,'month');

end if;

dt_inicio_dia_w		:= trunc(dt_referencia_w,'dd');

select	max(a.cd_empresa)
into STRICT	cd_empresa_w
from	estabelecimento a
where	a.cd_estabelecimento	= cd_estabelecimento_p;

ie_possui_macro_w	:= coalesce(position('#' in ds_formula_orig_w),0);

if (ie_possui_macro_w > 0) then

	while(ds_formula_orig_w IS NOT NULL AND ds_formula_orig_w::text <> '') loop
		begin

		nr_pos_inicial_w	:= coalesce(position('#' in ds_formula_orig_w),0);
		nr_pos_final_w		:= coalesce(position('@' in ds_formula_orig_w),0);
		ie_formula_w		:= substr(ds_formula_orig_w, nr_pos_inicial_w + 1,1);
		ds_macro_w		:= substr(ds_formula_orig_w, nr_pos_inicial_w + 3, nr_pos_final_w - (nr_pos_inicial_w + 3));
		ds_formula_w		:= '';
		ds_formula_fim_w	:= '';

		if (ie_formula_w = 'A') then -- Fazer select dos atributos e realizar a troca
			select	upper(a.nm_tabela),
				upper(a.nm_atributo)
			into STRICT	nm_tabela_w,
				nm_atributo_w
			from	valor_fluxo_caixa_agrup a
			where	a.ds_macro = ds_macro_w;

			if (nm_tabela_w	= 'CAIXA_RECEB') and (nm_atributo_w	= 'VL_ESPECIE') then

				select	coalesce(sum(a.vl_especie),0)
				into STRICT	ds_formula_w
				from	estabelecimento e,
					caixa d,
					caixa_saldo_diario c,
					caixa_receb a
				where	substr(obter_se_filtro_fluxo(null,null,null,nm_usuario_p,d.nr_sequencia),1,255) = 'S'
				and (d.cd_estabelecimento = cd_estabelecimento_p or ie_restringe_estab_p = 'N')
				and	e.cd_empresa		= cd_empresa_w
				and	d.ie_fluxo		= 'S'
				and	d.ie_situacao		= 'A'
				and	d.cd_estabelecimento	= e.cd_estabelecimento
				and	c.nr_seq_caixa		= d.nr_sequencia
				and	a.nr_seq_saldo_caixa	= c.nr_sequencia
				and	(a.dt_fechamento IS NOT NULL AND a.dt_fechamento::text <> '')
				and	a.dt_recebimento	< dt_referencia_w;

			elsif (nm_tabela_w	= 'PROJETO_RECURSO_SALDO') and (nm_atributo_w	= 'VL_SALDO') then

				select	sum(coalesce(a.vl_saldo,0))
				into STRICT	ds_formula_w
				from	projeto_recurso_saldo a
				where	a.nr_seq_projeto in (SELECT	b.nr_seq_proj_rec
					from	w_filtro_fluxo b
					where	b.nm_usuario	= nm_usuario_p)
				and	a.dt_mesano_referencia	between dt_inicio_mes_w and dt_final_mes_w;

			elsif (nm_tabela_w	= 'FLUXO_CAIXA_FECHAMENTO') and (nm_atributo_w	= 'VL_SALDO_FINAL') then

				select	max(x.dt_referencia)
				into STRICT	dt_fechamento_w
				from	fluxo_caixa_fechamento x
				where	x.dt_referencia		< dt_inicial_w
				and	coalesce(x.cd_estabelecimento, cd_estabelecimento_p) = cd_estabelecimento_p;

				ie_fechamento_diario_w := Obter_Param_Usuario(830, 22, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_fechamento_diario_w);

				if (ie_fechamento_diario_w = 'S') then

					select	coalesce(max(a.vl_saldo_final),0)
					into STRICT	ds_formula_w
					from	fluxo_caixa_fechamento a
					where	a.cd_empresa	= cd_empresa_w
					and	a.dt_referencia	= dt_fechamento_w
					and	coalesce(ie_tipo_fluxo, 'G')		= 'G'
					and	coalesce(a.cd_estabelecimento, cd_estabelecimento_p) = cd_estabelecimento_p;

				else

					dt_fechamento_mes_w	:= trunc(dt_fechamento_w,'month');

					if (dt_fechamento_w	= dt_fechamento_mes_w) then

						select	coalesce(max(a.vl_saldo_final),0)
						into STRICT	ds_formula_w
						from	fluxo_caixa_fechamento a
						where	a.cd_empresa		= cd_empresa_w
						and	a.dt_referencia		= dt_fechamento_w
						and	coalesce(ie_tipo_fluxo, 'G')	= 'G'
						and	coalesce(a.cd_estabelecimento, cd_estabelecimento_p) = cd_estabelecimento_p;

					end if;

				end if;

			elsif (nm_tabela_w	= 'CAIXA_SALDO_DIARIO') and (nm_atributo_w	= 'VL_SALDO_AVISTA') then

				select	coalesce(sum(vl_saldo_avista),0)
				into STRICT	ds_formula_w
				from	(SELECT	coalesce(a.vl_saldo_avista,a.vl_saldo) vl_saldo_avista
					from	estabelecimento c,
						caixa b,
						caixa_saldo_diario a
					where	substr(obter_se_filtro_fluxo(null,null,null,nm_usuario_p,b.nr_sequencia),1,255) = 'S'
					and (b.cd_estabelecimento = cd_estabelecimento_p or ie_restringe_estab_p = 'N')
					and	c.cd_empresa		= cd_empresa_w
					and	b.cd_estabelecimento	= c.cd_estabelecimento
					and	a.nr_seq_caixa		= b.nr_sequencia
					and	b.ie_situacao		= 'A'
					and	b.ie_fluxo 		= 'S'
					and	a.dt_saldo		=
						(select	max(dt_saldo)
						from	caixa_saldo_diario x
						where	x.nr_seq_caixa	= a.nr_seq_caixa
						and	x.dt_saldo	<= dt_referencia_w)
					and	a.dt_saldo		between dt_inicio_dia_w and dt_referencia_w
					
union all

					SELECT	coalesce(a.vl_saldo_avista,a.vl_saldo) vl_saldo_avista
					from	estabelecimento c,
						caixa b,
						caixa_saldo_diario a
					where	substr(obter_se_filtro_fluxo(null,null,null,nm_usuario_p,b.nr_sequencia),1,255) = 'S'
					and (b.cd_estabelecimento = cd_estabelecimento_p or ie_restringe_estab_p = 'N')
					and	c.cd_empresa		= cd_empresa_w
					and	b.cd_estabelecimento	= c.cd_estabelecimento
					and	a.nr_seq_caixa		= b.nr_sequencia
					and	b.ie_situacao		= 'A'
					and	b.ie_fluxo 		= 'S'
					and	a.dt_saldo		=
						(select	max(dt_saldo)
						from	caixa_saldo_diario x
						where	x.nr_seq_caixa	= a.nr_seq_caixa
						and	x.dt_saldo	<= dt_referencia_w)
					and (a.dt_saldo < dt_inicio_dia_w or a.dt_saldo > dt_referencia_w)) alias17;

			elsif (nm_tabela_w	= 'FUNCTION') and (nm_atributo_w	= 'VL_CARTAO_CREDITO') then

				select	coalesce(sum(CASE WHEN b.ie_saldo_caixa='E' THEN a.vl_transacao WHEN b.ie_saldo_caixa='S' THEN coalesce(a.vl_transacao,0) * -1 END ),0)
				into STRICT	ds_formula_w
				from	estabelecimento e,
					caixa d,
					caixa_saldo_diario c,
					transacao_financeira b,
					movto_cartao_cr f,
					movto_trans_financ a
				where	substr(obter_se_filtro_fluxo(null,null,null,nm_usuario_p,d.nr_sequencia),1,255) = 'S'
				and (d.cd_estabelecimento = cd_estabelecimento_p or ie_restringe_estab_p = 'N')
				and	e.cd_empresa		= cd_empresa_w
				and	d.ie_fluxo		= 'S'
				and	d.ie_situacao		= 'A'
				and	d.cd_estabelecimento	= e.cd_estabelecimento
				and	c.nr_seq_caixa		= d.nr_sequencia
				and	a.nr_seq_saldo_caixa	= c.nr_sequencia
				and	b.ie_caixa		in ('D', 'T', 'A')
				and	b.ie_saldo_caixa	in ('S','E')
				and	a.nr_seq_trans_financ	= b.nr_sequencia
				and	coalesce(f.ie_tipo_cartao,'C')	= 'C'
				and	a.nr_seq_movto_cartao	= f.nr_sequencia
				and	(a.nr_seq_movto_cartao IS NOT NULL AND a.nr_seq_movto_cartao::text <> '')
				and	(a.nr_seq_saldo_caixa IS NOT NULL AND a.nr_seq_saldo_caixa::text <> '')
				and	a.dt_transacao		< dt_referencia_w;

			elsif (nm_tabela_w	= 'FUNCTION') and (nm_atributo_w	= 'VL_CARTAO_DEBITO') then

				select	coalesce(sum(CASE WHEN b.ie_saldo_caixa='E' THEN a.vl_transacao WHEN b.ie_saldo_caixa='S' THEN coalesce(a.vl_transacao,0) * -1 END ),0)
				into STRICT	ds_formula_w
				from	estabelecimento e,
					caixa d,
					caixa_saldo_diario c,
					transacao_financeira b,
					movto_cartao_cr f,
					movto_trans_financ a
				where	substr(obter_se_filtro_fluxo(null,null,null,nm_usuario_p,d.nr_sequencia),1,255) = 'S'
				and (d.cd_estabelecimento = cd_estabelecimento_p or ie_restringe_estab_p = 'N')
				and	e.cd_empresa		= cd_empresa_w
				and	d.ie_fluxo		= 'S'
				and	d.ie_situacao		= 'A'
				and	d.cd_estabelecimento	= e.cd_estabelecimento
				and	c.nr_seq_caixa		= d.nr_sequencia
				and	a.nr_seq_saldo_caixa	= c.nr_sequencia
				and	b.ie_caixa		in ('D', 'T', 'A')
				and	b.ie_saldo_caixa	in ('S','E')
				and	a.nr_seq_trans_financ	= b.nr_sequencia
				and	coalesce(f.ie_tipo_cartao,'C')	= 'D'
				and	a.nr_seq_movto_cartao	= f.nr_sequencia
				and	(a.nr_seq_movto_cartao IS NOT NULL AND a.nr_seq_movto_cartao::text <> '')
				and	(a.nr_seq_saldo_caixa IS NOT NULL AND a.nr_seq_saldo_caixa::text <> '')
				and	a.dt_transacao		< dt_referencia_w;

			elsif (nm_tabela_w	= 'FUNCTION') and (nm_atributo_w	= 'VL_CHEQUE_AVISTA') then

				select	coalesce(sum(CASE WHEN b.ie_saldo_caixa='E' THEN a.vl_transacao WHEN b.ie_saldo_caixa='S' THEN coalesce(a.vl_transacao,0) * -1 END ),0)
				into STRICT	ds_formula_w
				from	estabelecimento e,
					caixa d,
					caixa_saldo_diario c,
					transacao_financeira b,
					cheque_cr f,
					movto_trans_financ a
				where	substr(obter_se_filtro_fluxo(null,null,null,nm_usuario_p,d.nr_sequencia),1,255) = 'S'
				and (d.cd_estabelecimento = cd_estabelecimento_p or ie_restringe_estab_p = 'N')
				and	e.cd_empresa		= cd_empresa_w
				and	d.ie_fluxo		= 'S'
				and	d.ie_situacao		= 'A'
				and	d.cd_estabelecimento	= e.cd_estabelecimento
				and	c.nr_seq_caixa		= d.nr_sequencia
				and	a.nr_seq_saldo_caixa	= c.nr_sequencia
				and	b.ie_caixa		in ('D', 'T', 'A')
				and	b.ie_saldo_caixa	in ('S','E')
				and	a.nr_seq_trans_financ	= b.nr_sequencia
				and	((coalesce(f.ie_forma_pagto::text, '') = '' and substr(obter_se_cheque_cr_avista(f.nr_seq_cheque),1,1) = 'S') or
					f.ie_forma_pagto = 'AV')
				and	a.nr_seq_cheque		= f.nr_seq_cheque
				and	(a.nr_seq_cheque IS NOT NULL AND a.nr_seq_cheque::text <> '')
				and	(a.nr_seq_saldo_caixa IS NOT NULL AND a.nr_seq_saldo_caixa::text <> '')
				and	a.dt_transacao		< dt_referencia_w;

			elsif (nm_tabela_w	= 'FUNCTION') and (nm_atributo_w	= 'VL_CHEQUE_PRE') then

				select	coalesce(sum(CASE WHEN b.ie_saldo_caixa='E' THEN a.vl_transacao WHEN b.ie_saldo_caixa='S' THEN coalesce(a.vl_transacao,0) * -1 END ),0)
				into STRICT	ds_formula_w
				from	estabelecimento e,
					caixa d,
					caixa_saldo_diario c,
					transacao_financeira b,
					cheque_cr f,
					movto_trans_financ a
				where	substr(obter_se_filtro_fluxo(null,null,null,nm_usuario_p,d.nr_sequencia),1,255) = 'S'
				and (d.cd_estabelecimento = cd_estabelecimento_p or ie_restringe_estab_p = 'N')
				and	e.cd_empresa		= cd_empresa_w
				and	d.ie_fluxo		= 'S'
				and	d.ie_situacao		= 'A'
				and	d.cd_estabelecimento	= e.cd_estabelecimento
				and	c.nr_seq_caixa		= d.nr_sequencia
				and	a.nr_seq_saldo_caixa	= c.nr_sequencia
				and	b.ie_caixa		in ('D', 'T', 'A')
				and	b.ie_saldo_caixa	in ('S','E')
				and	a.nr_seq_trans_financ	= b.nr_sequencia
				and	((coalesce(f.ie_forma_pagto::text, '') = '' and substr(obter_se_cheque_cr_avista(f.nr_seq_cheque),1,1) = 'N') or
					f.ie_forma_pagto = 'PD')
				and	a.nr_seq_cheque		= f.nr_seq_cheque
				and	(a.nr_seq_cheque IS NOT NULL AND a.nr_seq_cheque::text <> '')
				and	(a.nr_seq_saldo_caixa IS NOT NULL AND a.nr_seq_saldo_caixa::text <> '')
				and	a.dt_transacao		< dt_referencia_w;

			elsif (nm_tabela_w	= 'FUNCTION') and (nm_atributo_w	= 'VL_CHEQUE_CP_AVISTA') then

				select	coalesce(sum(CASE WHEN b.ie_saldo_caixa='E' THEN a.vl_transacao WHEN b.ie_saldo_caixa='S' THEN coalesce(a.vl_transacao,0) * -1 END ),0)
				into STRICT	ds_formula_w
				from	estabelecimento e,
					caixa d,
					caixa_saldo_diario c,
					transacao_financeira b,
					cheque f,
					movto_trans_financ a
				where	substr(obter_se_filtro_fluxo(null,null,null,nm_usuario_p,d.nr_sequencia),1,255) = 'S'
				and (d.cd_estabelecimento = cd_estabelecimento_p or ie_restringe_estab_p = 'N')
				and	e.cd_empresa		= cd_empresa_w
				and	d.ie_fluxo		= 'S'
				and	d.ie_situacao		= 'A'
				and	d.cd_estabelecimento	= e.cd_estabelecimento
				and	c.nr_seq_caixa		= d.nr_sequencia
				and	a.nr_seq_saldo_caixa	= c.nr_sequencia
				and	b.ie_caixa		in ('D', 'T', 'A')
				and	b.ie_saldo_caixa	in ('S','E')
				and	a.nr_seq_trans_financ	= b.nr_sequencia
				and	trunc(coalesce(f.dt_emissao,clock_timestamp()),'dd')	= trunc(coalesce(f.dt_vencimento,coalesce(f.dt_emissao,clock_timestamp())),'dd')
				and	a.nr_seq_cheque_cp	= f.nr_sequencia
				and	(a.nr_seq_cheque_cp IS NOT NULL AND a.nr_seq_cheque_cp::text <> '')
				and	(a.nr_seq_saldo_caixa IS NOT NULL AND a.nr_seq_saldo_caixa::text <> '')
				and	a.dt_transacao		< dt_referencia_w;

			elsif (nm_tabela_w	= 'FUNCTION') and (nm_atributo_w	= 'VL_CHEQUE_CP_PRE') then

				select	coalesce(sum(CASE WHEN b.ie_saldo_caixa='E' THEN a.vl_transacao WHEN b.ie_saldo_caixa='S' THEN coalesce(a.vl_transacao,0) * -1 END ),0)
				into STRICT	ds_formula_w
				from	estabelecimento e,
					caixa d,
					caixa_saldo_diario c,
					transacao_financeira b,
					cheque f,
					movto_trans_financ a
				where	substr(obter_se_filtro_fluxo(null,null,null,nm_usuario_p,d.nr_sequencia),1,255) = 'S'
				and (d.cd_estabelecimento = cd_estabelecimento_p or ie_restringe_estab_p = 'N')
				and	e.cd_empresa		= cd_empresa_w
				and	d.ie_fluxo		= 'S'
				and	d.ie_situacao		= 'A'
				and	d.cd_estabelecimento	= e.cd_estabelecimento
				and	c.nr_seq_caixa		= d.nr_sequencia
				and	a.nr_seq_saldo_caixa	= c.nr_sequencia
				and	b.ie_caixa		in ('D', 'T', 'A')
				and	b.ie_saldo_caixa	in ('S','E')
				and	a.nr_seq_trans_financ	= b.nr_sequencia
				and	trunc(coalesce(f.dt_emissao,clock_timestamp()),'dd')	<> trunc(coalesce(f.dt_vencimento,coalesce(f.dt_emissao,clock_timestamp())),'dd')
				and	a.nr_seq_cheque_cp	= f.nr_sequencia
				and	(a.nr_seq_cheque_cp IS NOT NULL AND a.nr_seq_cheque_cp::text <> '')
				and	(a.nr_seq_saldo_caixa IS NOT NULL AND a.nr_seq_saldo_caixa::text <> '')
				and	a.dt_transacao		< dt_referencia_w;

			elsif (nm_tabela_w	= 'FUNCTION') and (nm_atributo_w	= 'VL_SALDO_BANCO') then

				select	coalesce(sum(obter_saldo_banco_diario(b.nr_sequencia, dt_referencia_w - 1)),0)
				into STRICT	ds_formula_w
				from	estabelecimento c,
					banco_saldo b,
					banco_estabelecimento a
				where	substr(obter_se_filtro_fluxo(a.nr_sequencia,null,null,nm_usuario_p,null),1,255) = 'S'
				and (a.cd_estabelecimento = cd_estabelecimento_p or ie_restringe_estab_p = 'N')
				and	c.cd_empresa		= cd_empresa_w
				and	a.cd_estabelecimento	= c.cd_estabelecimento
				and	b.nr_seq_conta		= a.nr_sequencia
				and	a.ie_tipo_relacao	in ('C', 'ECC')
				and	a.ie_fluxo_caixa	= 'S'
				and	a.ie_situacao		= 'A'
				and	b.dt_referencia		=
					(SELECT	max(dt_referencia)
					from	banco_saldo x
					where	x.nr_seq_conta	= b.nr_seq_conta
					and	x.dt_referencia	<= dt_referencia_w);

			elsif (nm_tabela_w	= 'FUNCTION') and (nm_atributo_w	= 'VL_OUTRAS ENTRADAS') then

				select	coalesce(sum(a.vl_especie),0)
				into STRICT	vl_especie_w
				from	estabelecimento e,
					caixa d,
					caixa_saldo_diario c,
					caixa_receb a
				where	substr(obter_se_filtro_fluxo(null,null,null,nm_usuario_p,d.nr_sequencia),1,255) = 'S'
				and (d.cd_estabelecimento = cd_estabelecimento_p or ie_restringe_estab_p = 'N')
				and	e.cd_empresa		= cd_empresa_w
				and	d.ie_fluxo		= 'S'
				and	d.ie_situacao		= 'A'
				and	d.cd_estabelecimento	= e.cd_estabelecimento
				and	c.nr_seq_caixa		= d.nr_sequencia
				and	a.nr_seq_saldo_caixa	= c.nr_sequencia
				and	(a.dt_fechamento IS NOT NULL AND a.dt_fechamento::text <> '')
				and	a.dt_recebimento	< dt_referencia_w;

				select	coalesce(sum(a.vl_transacao),0) - coalesce(vl_especie_w,0)
				into STRICT	ds_formula_w
				from	estabelecimento e,
					caixa d,
					caixa_saldo_diario c,
					transacao_financeira b,
					movto_trans_financ a
				where	substr(obter_se_filtro_fluxo(null,null,null,nm_usuario_p,d.nr_sequencia),1,255) = 'S'
				and (d.cd_estabelecimento = cd_estabelecimento_p or ie_restringe_estab_p = 'N')
				and	e.cd_empresa		= cd_empresa_w
				and	d.ie_fluxo		= 'S'
				and	d.ie_situacao		= 'A'
				and	d.cd_estabelecimento	= e.cd_estabelecimento
				and	c.nr_seq_caixa		= d.nr_sequencia
				and	a.nr_seq_saldo_caixa	= c.nr_sequencia
				and	b.ie_caixa		in ('D', 'T', 'A')
				and	b.ie_saldo_caixa	= 'E'
				and	a.nr_seq_trans_financ	= b.nr_sequencia
				and	coalesce(a.nr_seq_cheque_cp::text, '') = ''
				and	coalesce(a.nr_seq_cheque::text, '') = ''
				and	coalesce(a.nr_seq_movto_cartao::text, '') = ''
				and	(a.nr_seq_saldo_caixa IS NOT NULL AND a.nr_seq_saldo_caixa::text <> '')
				and	a.dt_transacao		< dt_referencia_w;

			elsif (nm_tabela_w	= 'FUNCTION') and (nm_atributo_w	= 'VL_OUTRAS_SAIDAS') then

				select	coalesce(sum(a.vl_transacao),0) * -1
				into STRICT	ds_formula_w
				from	estabelecimento e,
					caixa d,
					caixa_saldo_diario c,
					transacao_financeira b,
					movto_trans_financ a
				where	substr(obter_se_filtro_fluxo(null,null,null,nm_usuario_p,d.nr_sequencia),1,255) = 'S'
				and (d.cd_estabelecimento = cd_estabelecimento_p or ie_restringe_estab_p = 'N')
				and	e.cd_empresa		= cd_empresa_w
				and	d.ie_fluxo		= 'S'
				and	d.ie_situacao		= 'A'
				and	d.cd_estabelecimento	= e.cd_estabelecimento
				and	c.nr_seq_caixa		= d.nr_sequencia
				and	a.nr_seq_saldo_caixa	= c.nr_sequencia
				and	b.ie_caixa		in ('D', 'T', 'A')
				and	b.ie_saldo_caixa	= 'S'
				and	a.nr_seq_trans_financ	= b.nr_sequencia
				and	coalesce(a.nr_seq_cheque_cp::text, '') = ''
				and	coalesce(a.nr_seq_cheque::text, '') = ''
				and	coalesce(a.nr_seq_movto_cartao::text, '') = ''
				and	(a.nr_seq_saldo_caixa IS NOT NULL AND a.nr_seq_saldo_caixa::text <> '')
				and	a.dt_transacao		< dt_referencia_w;

			elsif (nm_tabela_w	= 'FUNCTION') and (nm_atributo_w	= 'DS_CONTA') then

				select	max(ds_conta)
				into STRICT	ds_formula_w
				from	(SELECT	coalesce(sum(obter_saldo_banco_diario(b.nr_sequencia, dt_referencia_w - 1)),0) vl_saldo,
						a.nr_sequencia,
						a.ds_conta
					from	estabelecimento c,
						banco_saldo b,
						banco_estabelecimento_v a
					where	substr(obter_se_filtro_fluxo(a.nr_sequencia,null,null,nm_usuario_p,null),1,255) = 'S'
					and (a.cd_estabelecimento = cd_estabelecimento_p or ie_restringe_estab_p = 'N')
					and	c.cd_empresa		= cd_empresa_w
					and	a.cd_estabelecimento	= c.cd_estabelecimento
					and	b.nr_seq_conta		= a.nr_sequencia
					and	a.ie_tipo_relacao	in ('C', 'ECC')
					and	a.ie_fluxo_caixa	= 'S'
					and	a.ie_situacao		= 'A'
					and	b.dt_referencia		=
						(select	max(dt_referencia)
						from	banco_saldo x
						where	x.nr_seq_conta	= b.nr_seq_conta
						and	x.dt_referencia	<= dt_referencia_w)
					group by	a.nr_sequencia,
						a.ds_conta) alias12
				where	coalesce(vl_saldo,0)	<> 0;

			elsif (nm_tabela_w	= 'CAIXA') and (nm_atributo_w	= 'DS_CAIXA') then

				select	max(ds_caixa)
				into STRICT	ds_formula_w
				from (SELECT	coalesce(sum(CASE WHEN b.ie_saldo_caixa='E' THEN a.vl_transacao WHEN b.ie_saldo_caixa='S' THEN coalesce(a.vl_transacao,0) * -1 END ),0) vl_transacao,
						d.nr_sequencia,
						d.ds_caixa
					from	estabelecimento e,
						caixa d,
						caixa_saldo_diario c,
						transacao_financeira b,
						movto_trans_financ a
					where	substr(obter_se_filtro_fluxo(null,null,null,nm_usuario_p,d.nr_sequencia),1,255) = 'S'
					and (d.cd_estabelecimento = cd_estabelecimento_p or ie_restringe_estab_p = 'N')
					and	e.cd_empresa		= cd_empresa_w
					and	d.ie_fluxo		= 'S'
					and	d.ie_situacao		= 'A'
					and	d.cd_estabelecimento	= e.cd_estabelecimento
					and	c.nr_seq_caixa		= d.nr_sequencia
					and	a.nr_seq_saldo_caixa	= c.nr_sequencia
					and	b.ie_caixa		in ('D', 'T', 'A')
					and	b.ie_saldo_caixa	in ('S','E')
					and	a.nr_seq_trans_financ	= b.nr_sequencia
					and	(a.nr_seq_saldo_caixa IS NOT NULL AND a.nr_seq_saldo_caixa::text <> '')
					and	a.dt_transacao		< dt_referencia_w
					group by	d.nr_sequencia,
						d.ds_caixa) alias12
				where	coalesce(vl_transacao,0)	<> 0;

			elsif (nm_tabela_w	= 'BANDEIRA_CARTAO_CR') and (nm_atributo_w	= 'DS_BANDEIRA') then

				select	max(ds_bandeira)
				into STRICT	ds_formula_w
				from (SELECT	coalesce(sum(CASE WHEN b.ie_saldo_caixa='E' THEN a.vl_transacao WHEN b.ie_saldo_caixa='S' THEN coalesce(a.vl_transacao,0) * -1 END ),0) vl_transacao,
						g.nr_sequencia,
						g.ds_bandeira
					from	estabelecimento e,
						caixa d,
						caixa_saldo_diario c,
						transacao_financeira b,
						bandeira_cartao_cr g,
						movto_cartao_cr f,
						movto_trans_financ a
					where	substr(obter_se_filtro_fluxo(null,null,null,nm_usuario_p,d.nr_sequencia),1,255) = 'S'
					and (d.cd_estabelecimento = cd_estabelecimento_p or ie_restringe_estab_p = 'N')
					and	e.cd_empresa		= cd_empresa_w
					and	d.ie_fluxo		= 'S'
					and	d.ie_situacao		= 'A'
					and	d.cd_estabelecimento	= e.cd_estabelecimento
					and	c.nr_seq_caixa		= d.nr_sequencia
					and	a.nr_seq_saldo_caixa	= c.nr_sequencia
					and	b.ie_caixa		in ('D', 'T', 'A')
					and	b.ie_saldo_caixa	in ('S','E')
					and	a.nr_seq_trans_financ	= b.nr_sequencia
					and	f.nr_seq_bandeira	= g.nr_sequencia
					and	a.nr_seq_movto_cartao	= f.nr_sequencia
					and	(a.nr_seq_movto_cartao IS NOT NULL AND a.nr_seq_movto_cartao::text <> '')
					and	(a.nr_seq_saldo_caixa IS NOT NULL AND a.nr_seq_saldo_caixa::text <> '')
					and	a.dt_transacao		< dt_referencia_w
					group by	g.nr_sequencia,
						g.ds_bandeira) alias13
				where	coalesce(vl_transacao,0)	<> 0;

			elsif (nm_tabela_w	= 'BANCO') and (nm_atributo_w	= 'DS_BANCO') then

				select	max(ds_banco)
				into STRICT	ds_formula_w
				from	(SELECT	coalesce(sum(obter_saldo_banco_diario(b.nr_sequencia, dt_referencia_w - 1)),0) vl_saldo,
						d.cd_banco,
						d.ds_banco
					from	estabelecimento c,
						banco_saldo b,
						banco d,
						banco_estabelecimento_v a
					where	a.cd_banco		= d.cd_banco
					and	substr(obter_se_filtro_fluxo(a.nr_sequencia,null,null,nm_usuario_p,null),1,255) = 'S'
					and (a.cd_estabelecimento = cd_estabelecimento_p or ie_restringe_estab_p = 'N')
					and	c.cd_empresa		= cd_empresa_w
					and	a.cd_estabelecimento	= c.cd_estabelecimento
					and	b.nr_seq_conta		= a.nr_sequencia
					and	a.ie_tipo_relacao	in ('C', 'ECC')
					and	a.ie_fluxo_caixa	= 'S'
					and	a.ie_situacao		= 'A'
					and	b.dt_referencia		=
						(select	max(dt_referencia)
						from	banco_saldo x
						where	x.nr_seq_conta	= b.nr_seq_conta
						and	x.dt_referencia	<= dt_referencia_w)
					group by	d.cd_banco,
						d.ds_banco) alias12
				where	coalesce(vl_saldo,0)	<> 0;

			end if;

		elsif (ie_formula_w = 'F') then -- Verificar a outra formula utilizada por esta
			select	max(a.ds_formula),
				max(a.ie_tipo_formula)
			into STRICT	ds_formula_ww,
				ie_tipo_formula_w
			from	formula_fluxo_caixa_agrup a
			where	a.ds_macro = ds_macro_w;

			ds_formula_w	:= OBTER_DESC_LINHA_FORMULA_FLUXO(	ds_formula_ww,
										dt_referencia_p,
										dt_inicial_p,
										dt_final_p,
										ie_diario_p,
										cd_estabelecimento_p,
										ie_restringe_estab_p,
										nm_usuario_p);

		end if;

		/* Alterar a macro pelo valor/descrição obtido */

		ds_retorno_w	:= 	substr(ds_retorno_w ||
					substr(ds_formula_orig_w,1,nr_pos_inicial_w - 1) ||
					replace(ds_formula_w,',','.'),1,4000);

		/* Retirar a formula até a macro alterada e passar para a póxima*/

		if (nr_pos_final_w = 0) then

			ds_retorno_w		:= ds_retorno_w || substr(ds_formula_orig_w,1,4000); /* adicionar ao final do registro de retorno caso haja descrições depois da ultima macro */
			ds_formula_orig_w	:= null;

		else

			ds_formula_orig_w	:= substr(ds_formula_orig_w,nr_pos_final_w + 1,4000);

		end if;

		end;
	end	loop;
else
	ds_retorno_w	:= ds_formula_orig_w;
end if;

return	ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_desc_linha_formula_fluxo (ds_formula_p text, dt_referencia_p timestamp, dt_inicial_p timestamp, dt_final_p timestamp, ie_diario_p text, cd_estabelecimento_p bigint, ie_restringe_estab_p text, nm_usuario_p text) FROM PUBLIC;

