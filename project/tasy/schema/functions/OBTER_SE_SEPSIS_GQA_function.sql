-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_se_sepsis_gqa (nr_seq_sepse_p bigint, qt_suspeita_regra_p bigint, qt_confirmada_regra_p bigint, ie_status_sepse_p text, nm_tabela_p text default 'ESCALA_SEPSE') RETURNS varchar AS $body$
DECLARE


qt_disfuncao_w        	bigint  := 0;
qt_suspeita_w       	bigint  := 0;
qt_ambos_w       	    bigint  := 0;
ds_retorno_w			varchar(1) := 'S';
ie_presente_em_duas_regras_w varchar(1) := 'N';
ie_resultado_w			varchar(1);
nr_seq_atributo_w		bigint;
qt_pontuacao_w			bigint;

--'S','Sinal de alerta para sepse','G','Sinal de disfunção orgânica','A','Ambos')
BEGIN

if (nm_tabela_p = 'ESCALA_SEPSE_INFANTIL') then
	select sum(case when b.ie_tipo = 'A' then coalesce(a.qt_pontuacao, 0) else 0 end),
		   sum(case when b.ie_tipo = 'G' then coalesce(a.qt_pontuacao, 0) else 0 end),
		   sum(case when b.ie_tipo = 'S' then coalesce(a.qt_pontuacao, 0) else 0 end)
	into STRICT   qt_ambos_w,
		   qt_disfuncao_w,
		   qt_suspeita_w
	from   escala_sepse_infantil_item a,
		   sepse_atributo b 
	where  a.nr_seq_escala    = nr_seq_sepse_p
	and    a.nr_seq_atributo  = b.nr_sequencia;
else
	select sum(case when b.ie_tipo = 'A' then coalesce(a.qt_pontuacao, 0) else 0 end),
		   sum(case when b.ie_tipo = 'G' then coalesce(a.qt_pontuacao, 0) else 0 end),
		   sum(case when b.ie_tipo = 'S' then coalesce(a.qt_pontuacao, 0) else 0 end)
	into STRICT   qt_ambos_w,
		   qt_disfuncao_w,
		   qt_suspeita_w
	from   escala_sepse_item a,
		   sepse_atributo b 
	where  a.nr_seq_escala    = nr_seq_sepse_p
	and    a.nr_seq_atributo  = b.nr_sequencia;	
end if;


if (qt_ambos_w > 0) then

    SELECT case when count(1) > 1 then 'S' else 'N' end 
    into STRICT   ie_presente_em_duas_regras_w
    FROM (
        SELECT 'SUSPEITAMAISAMBOS' tipo
        FROM    gqa_pendencia_regra a,
                gqa_pendencia b
        WHERE   b.nr_sequencia = a.NR_SEQ_PENDENCIA
        AND     b.ie_situacao = 'A'
        AND     a.ie_situacao = 'A'
        AND     b.ie_tipo_pendencia = 4
        AND     a.qt_var_suspeita <= (qt_suspeita_w + qt_ambos_w)
        AND     a.qt_var_confirmada <= (qt_disfuncao_w)
        AND     A.ie_regra_sepse  = ie_status_sepse_p
        
UNION ALL

        SELECT 'DOMAISAMBOS' tipo
        FROM    gqa_pendencia_regra a,
                gqa_pendencia b
        WHERE   b.nr_sequencia = a.NR_SEQ_PENDENCIA
        AND     b.ie_situacao = 'A'
        AND     a.ie_situacao = 'A'
        AND     b.ie_tipo_pendencia = 4
        AND     a.qt_var_suspeita <= (qt_suspeita_w)
        AND     a.qt_var_confirmada <= (qt_disfuncao_w + qt_ambos_w)
        AND     A.ie_regra_sepse  = ie_status_sepse_p
	) x;

end if;


if (
	((qt_suspeita_w >= coalesce(qt_suspeita_regra_p,0))  and (qt_disfuncao_w + qt_ambos_w >= coalesce(qt_confirmada_regra_p,0)) and ((ie_presente_em_duas_regras_w <> 'S') or (coalesce(qt_confirmada_regra_p,0) > 0))) or
    ((qt_suspeita_w + qt_ambos_w >= coalesce(qt_suspeita_regra_p,0)) and (qt_disfuncao_w  >= coalesce(qt_confirmada_regra_p,0)) and (ie_presente_em_duas_regras_w <> 'S'))
   ) then
	ds_retorno_w := 'S';
else
	ds_retorno_w := 'N';
end if;

return ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_se_sepsis_gqa (nr_seq_sepse_p bigint, qt_suspeita_regra_p bigint, qt_confirmada_regra_p bigint, ie_status_sepse_p text, nm_tabela_p text default 'ESCALA_SEPSE') FROM PUBLIC;

