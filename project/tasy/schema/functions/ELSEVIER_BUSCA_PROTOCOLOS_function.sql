-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION elsevier_busca_protocolos (dt_inicial_p timestamp, dt_final_p timestamp, cd_setor_p bigint, nr_atendimento_p bigint) RETURNS varchar AS $body$
DECLARE

  ds_retorno_w varchar(4000) := null;
  ds_count_w   bigint := 0;
  ds_total_w   bigint := 0;

  c1 CURSOR FOR
    SELECT dados.cd_protocolo prt
      from (SELECT SUBSTR(Obter_desc_protocolo(a.cd_protocolo), 1, 100) ds,
                   a.cd_protocolo,
                   a.cd_setor_atendimento,
                   a.nr_atendimento
              FROM cpoe_material a
             WHERE coalesce(a.cd_protocolo, 0) > 0
               and trunc(a.dt_liberacao) >= trunc(dt_inicial_p)
               and trunc(a.dt_liberacao) <= trunc(dt_final_p)

union all

            select SUBSTR(Obter_desc_protocolo(a.cd_protocolo), 1, 100) ds,
                   a.cd_protocolo,
                   a.cd_setor_atendimento,
                   a.nr_atendimento
              from CPOE_PROCEDIMENTO a
             where coalesce(a.cd_protocolo, 0) > 0
               and trunc(a.dt_liberacao) >= trunc(dt_inicial_p)
               and trunc(a.dt_liberacao) <= trunc(dt_final_p)
            
union all

            select SUBSTR(Obter_desc_protocolo(a.cd_protocolo), 1, 100) ds,
                   a.cd_protocolo,
                   a.cd_setor_atendimento,
                   a.nr_atendimento
              from CPOE_RECOMENDACAO a
             where coalesce(a.cd_protocolo, 0) > 0
               and trunc(a.dt_liberacao) >= trunc(dt_inicial_p)
               and trunc(a.dt_liberacao) <= trunc(dt_final_p)
            
union all

            select SUBSTR(Obter_desc_protocolo(a.cd_protocolo), 1, 100) ds,
                   a.cd_protocolo,
                   a.cd_setor_atendimento,
                   a.nr_atendimento
              from CPOE_DIETA a
             where coalesce(a.cd_protocolo, 0) > 0
               and trunc(a.dt_liberacao) >= trunc(dt_inicial_p)
               and trunc(a.dt_liberacao) <= trunc(dt_final_p)
            
union all

            select SUBSTR(Obter_desc_protocolo(a.cd_protocolo), 1, 100) ds,
                   a.cd_protocolo,
                   a.cd_setor_atendimento,
                   a.nr_atendimento
              from CPOE_HEMOTERAPIA a
             where coalesce(a.cd_protocolo, 0) > 0
               and trunc(a.dt_liberacao) >= trunc(dt_inicial_p)
               and trunc(a.dt_liberacao) <= trunc(dt_final_p)
            
union all

            select SUBSTR(Obter_desc_protocolo(a.cd_protocolo), 1, 100) ds,
                   a.cd_protocolo,
                   a.cd_setor_atendimento,
                   a.nr_atendimento
              from CPOE_GASOTERAPIA a
             where coalesce(a.cd_protocolo, 0) > 0
               and trunc(a.dt_liberacao) >= trunc(dt_inicial_p)
               and trunc(a.dt_liberacao) <= trunc(dt_final_p)
            
union all

            select SUBSTR(Obter_desc_protocolo(a.cd_protocolo), 1, 100) ds,
                   a.cd_protocolo,
                   a.cd_setor_atendimento,
                   a.nr_atendimento
              from CPOE_DIALISE a
             where coalesce(a.cd_protocolo, 0) > 0
               and trunc(a.dt_liberacao) >= trunc(dt_inicial_p)
               and trunc(a.dt_liberacao) <= trunc(dt_final_p)) dados
     where exists (select *
              from protocolo_guia_inf b
             where dados.cd_protocolo = b.nr_seq_protocolo
               and not exists (select 1
                      from protocolo_modulo
                     where cd_tipo_protocolo in (b.nr_seq_tipo_prot)))
       and dados.cd_setor_atendimento = cd_setor_p
       and dados.nr_atendimento = nr_atendimento_p
     group by dados.ds, dados.cd_protocolo, dados.cd_setor_atendimento;

BEGIN

  FOR protocolos in c1 LOOP
    ds_retorno_w := protocolos.prt;

    select sum(con.cnt) total
      into STRICT ds_count_w
      from (SELECT tt.ds,
                   tt.cd_protocolo,
                   tt.cd_setor_atendimento,
                   tt.cnt,
                   dt_inicial_p            dtini,
                   dt_final_p              dtfim,
                   nr_atendimento_p        atd
              from (select distinct(dados.ds),
                                    dados.cd_protocolo,
                                    dados.cd_setor_atendimento,
                                    count(distinct(dados.ds)) over (partition by dados.ds) as cnt
                      from (select obter_Desc_material(a.cd_material) ds,
                                   a.cd_protocolo,
                                   a.cd_setor_atendimento,
                                   a.nr_atendimento
                              from cpoe_material a
                             where coalesce(a.cd_protocolo, 0) > 0
                               and trunc(a.dt_liberacao) >=
                                   trunc(dt_inicial_p)
                               and trunc(a.dt_liberacao) <= trunc(dt_final_p)
                               and a.cd_setor_atendimento = cd_setor_p) dados
                    
union all

                    SELECT distinct(dados.ds),
                                    dados.cd_protocolo,
                                    dados.cd_setor_atendimento,
                                    count(distinct(dados.ds)) over (partition by dados.ds) as cnt
                      from (select obter_desc_proc_interno(a.nr_seq_proc_interno) ds,
                                   a.cd_protocolo,
                                   a.cd_setor_atendimento,
                                   a.nr_atendimento
                              from CPOE_PROCEDIMENTO a
                             where coalesce(a.cd_protocolo, 0) > 0
                               and trunc(a.dt_liberacao) >=
                                   trunc(dt_inicial_p)
                               and trunc(a.dt_liberacao) <= trunc(dt_final_p)
                               and a.cd_setor_atendimento = cd_setor_p) dados
                    
union all

                    select distinct(dados.ds),
                                    dados.cd_protocolo,
                                    dados.cd_setor_atendimento,
                                    count(distinct(dados.ds)) over (partition by dados.ds) as cnt
                      from (select obter_desc_recomendacao(a.cd_recomendacao) ds,
                                   a.cd_protocolo,
                                   a.cd_setor_atendimento,
                                   a.nr_atendimento
                              from CPOE_RECOMENDACAO a
                             where coalesce(a.cd_protocolo, 0) > 0
                               and trunc(a.dt_liberacao) >=
                                   trunc(dt_inicial_p)
                               and trunc(a.dt_liberacao) <= trunc(dt_final_p)
                                  
                               and a.cd_setor_atendimento = cd_setor_p) dados
                    
union all

                    select distinct(dados.ds),
                                    dados.cd_protocolo,
                                    dados.cd_setor_atendimento,
                                    count(distinct(dados.ds)) over (partition by dados.ds) as cnt
                      from (select cpoe_obter_ds_dieta_rel(a.ie_tipo_dieta,
                                                           a.cd_dieta) ds,
                                   a.cd_protocolo,
                                   a.cd_setor_atendimento,
                                   a.nr_atendimento
                              from CPOE_DIETA a
                             where coalesce(a.cd_protocolo, 0) > 0
                               and trunc(a.dt_liberacao) >=
                                   trunc(dt_inicial_p)
                               and trunc(a.dt_liberacao) <= trunc(dt_final_p)
                                  
                               and a.cd_setor_atendimento = cd_setor_p) dados
                    
union all

                    select distinct(dados.ds),
                                    dados.cd_protocolo,
                                    dados.cd_setor_atendimento,
                                    count(distinct(dados.ds)) over (partition by dados.ds) as cnt
                      from (select obter_desc_hemocomponente(a.nr_seq_derivado) ds,
                                   a.cd_protocolo,
                                   a.cd_setor_atendimento,
                                   a.nr_atendimento
                              from CPOE_HEMOTERAPIA a
                             where coalesce(a.cd_protocolo, 0) > 0
                               and trunc(a.dt_liberacao) >=
                                   trunc(dt_inicial_p)
                               and trunc(a.dt_liberacao) <= trunc(dt_final_p)
                               and a.cd_setor_atendimento = cd_setor_p) dados
                    
union all

                    select distinct(dados.ds),
                                    dados.cd_protocolo,
                                    dados.cd_setor_atendimento,
                                    count(distinct(dados.ds)) over (partition by dados.ds) as cnt
                      from (select obter_desc_gas(a.nr_seq_gas) ds,
                                   a.cd_protocolo,
                                   a.cd_setor_atendimento,
                                   a.nr_atendimento
                              from CPOE_GASOTERAPIA a
                             where coalesce(a.cd_protocolo, 0) > 0
                               and trunc(a.dt_liberacao) >=
                                   trunc(dt_inicial_p)
                               and trunc(a.dt_liberacao) <= trunc(dt_final_p)
                               and a.cd_setor_atendimento = cd_setor_p) dados
                    
union all

                    select distinct(dados.ds),
                                    dados.cd_protocolo,
                                    dados.cd_setor_atendimento,
                                    count(distinct(dados.ds)) over (partition by dados.ds) as cnt
                      from (select CPOE_Obter_desc_dialise(a.ie_tipo_dialise,
                                                           a.nr_seq_protocolo,
                                                           a.dt_lib_suspensao,
                                                           a.dt_suspensao,
                                                           a.qt_fluxo_sangue,
                                                           a.qt_hora_min_sessao,
                                                           'S',
                                                           a.ie_hemodialise,
                                                           a.ie_tipo_peritoneal,
                                                           a.qt_volume_ciclo,
                                                           a.qt_hora_min_duracao,
                                                           a.ie_categoria,
                                                           a.dt_atualizacao_peso,
                                                           a.ie_baixado_por_alta,
                                                           a.dt_alta_medico) ds,
                                   a.cd_protocolo,
                                   a.cd_setor_atendimento,
                                   a.nr_atendimento
                              from CPOE_DIALISE a
                             where coalesce(a.cd_protocolo, 0) > 0
                               and trunc(a.dt_liberacao) >=
                                   trunc(dt_inicial_p)
                               and trunc(a.dt_liberacao) <= trunc(dt_final_p)
                               and a.cd_setor_atendimento = cd_setor_p) dados
                     where dados.nr_atendimento = nr_atendimento_p) tt
             where (tt.ds IS NOT NULL AND tt.ds::text <> '')
               and tt.cd_protocolo in (ds_retorno_w)
               and exists (select *
                      from protocolo_guia_inf b
                     where tt.cd_protocolo = b.nr_seq_protocolo)
             group by tt.ds,
                      tt.cd_protocolo,
                      tt.cd_setor_atendimento,
                      tt.cnt) con;

    ds_total_w := ds_total_w + ds_count_w;
  END LOOP;

  return(ds_total_w);
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION elsevier_busca_protocolos (dt_inicial_p timestamp, dt_final_p timestamp, cd_setor_p bigint, nr_atendimento_p bigint) FROM PUBLIC;

