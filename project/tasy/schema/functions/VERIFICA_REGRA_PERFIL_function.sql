-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION verifica_regra_perfil ( NR_SEQ_TIPO_CONSULTA_P bigint, CD_CIAP_P text, CD_PESSOA_FISICA_P bigint, NR_ATENDIMENTO_P bigint) RETURNS varchar AS $body$
DECLARE


regra_w   ehr_tipo_registro.CD_ESPECIALIDADE %type;
ds_retorno_w   ehr_tipo_registro.DS_TIPO_REGISTRO %type;
obter_perfil_w  perfil.cd_perfil%type;
	

BEGIN

select count(1)
into STRICT regra_w
from ehr_tipo_registro a, ehr_regra_consulta_pepa b
where a.nr_sequencia = b.cd_consulta_pepa
and a.nr_sequencia =  NR_SEQ_TIPO_CONSULTA_P;

if (regra_w = 0) then
	ds_retorno_w := 'S';
else
	obter_perfil_w := obter_perfil_ativo;
	select count(1)
	into STRICT regra_w
	from	ehr_tipo_registro a,
			ehr_regra_consulta_pepa b 
	where a.nr_sequencia = b.cd_consulta_pepa
	and a.nr_sequencia =  NR_SEQ_TIPO_CONSULTA_P
	and COALESCE(b.cd_perfil,obter_perfil_w) = obter_perfil_w
    and COALESCE(b.IE_SEXO, Obter_Sexo_PF(CD_PESSOA_FISICA_P, 'C')) = Obter_Sexo_PF(CD_PESSOA_FISICA_P, 'C')
    and Obter_Idade_PF(CD_PESSOA_FISICA_P, clock_timestamp(), 'A') between COALESCE(b.nr_idade_min, 0) and COALESCE(b.nr_idade_max, 999)
    and (CD_CIAP_P = COALESCE(b.cd_ciap,'0') or coalesce(b.cd_ciap::text, '') = '')
    and (b.CD_SERVICO in (SELECT m.nr_seq_servico
                         from   atendimento_servico m
                         where  m.nr_Atendimento = NR_ATENDIMENTO_P)
        or coalesce(b.CD_SERVICO::text, '') = '');
	
	if (regra_w > 0) then
		ds_retorno_w := 'S';
	else
		ds_retorno_w := 'N';
	end if;
end if;
return ds_retorno_w;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION verifica_regra_perfil ( NR_SEQ_TIPO_CONSULTA_P bigint, CD_CIAP_P text, CD_PESSOA_FISICA_P bigint, NR_ATENDIMENTO_P bigint) FROM PUBLIC;

