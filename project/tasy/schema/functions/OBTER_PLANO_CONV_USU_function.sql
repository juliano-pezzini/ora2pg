-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_plano_conv_usu (cd_usuario_convenio_p text, cd_convenio_p bigint, cd_Categoria_p text, cd_estabelecimento_p bigint, dt_atendimento_p timestamp) RETURNS varchar AS $body$
DECLARE


ds_retorno_w		varchar(60);
ie_plano_lib_w		varchar(1) := 'N';
cd_plano_convenio_w	varchar(60);
qt_plano_conv_w		integer;


BEGIN

select	trim(both max(cd_plano_convenio))
into STRICT	cd_plano_convenio_w
from	w_usuario_convenio
where	elimina_caracteres_especiais(replace(cd_usuario_convenio,'/',''))	= cd_usuario_convenio_p;

select	count(*)
into STRICT	qt_plano_conv_w
from	convenio_plano
where	cd_convenio	= cd_convenio_p
and	cd_plano	= cd_plano_convenio_w
and	ie_situacao = 'A';

if (cd_plano_convenio_w IS NOT NULL AND cd_plano_convenio_w::text <> '') and (qt_plano_conv_w > 0) then
	select	Obter_Plano_Lib_Categoria(cd_convenio_p, cd_Categoria_p, cd_plano_convenio_w, cd_estabelecimento_p, dt_atendimento_p)
	into STRICT	ie_plano_lib_w
	;
	if (ie_plano_lib_w = 'S') then
		ds_retorno_w	:= cd_plano_convenio_w;
	end if;
end if;

return	ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_plano_conv_usu (cd_usuario_convenio_p text, cd_convenio_p bigint, cd_Categoria_p text, cd_estabelecimento_p bigint, dt_atendimento_p timestamp) FROM PUBLIC;

