-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_conteudo_email_cirurgia ( nr_cirurgia_p bigint, cd_declaracao_p text, cd_pessoa_fisica_p text) RETURNS varchar AS $body$
DECLARE

 
nm_medico_cirurgiao_w	varchar(200);
nm_paciente_w			varchar(200);
ds_procedimento_w		PROCEDIMENTO.DS_PROCEDIMENTO%type;
dt_cirurgia_w			varchar(20);
nr_cirurgia_w			bigint;
ds_declaracao_w			varchar(4000);
ds_convenio_w			varchar(40);
ds_categoria_w			varchar(40);
ds_proc_adic_w			varchar(1000);
ds_proc_adic_aux_w		varchar(270);
nr_atendimento_w		bigint;
nr_prescricao_w			bigint;
nm_participante_w		varchar(255);

C01 CURSOR FOR 
	SELECT	substr(obter_desc_prescr_proc(cd_procedimento,ie_origem_proced, nr_seq_proc_interno),1,240)  
	from	prescr_procedimento 
	where	nr_prescricao = nr_prescricao_w 
	order by 1;


BEGIN 
 
select	substr(obter_nome_medico(CD_MEDICO_CIRURGIAO,'N'),1,200) nm_medico_cirurgiao, 
		substr(obter_exame_agenda(cd_procedimento_princ, ie_origem_proced, nr_seq_proc_interno),1,255) ds_procedimento, 
		coalesce(dt_inicio_real,dt_inicio_prevista) dt_cirurgia, 
		substr(obter_nome_pf_pj(CD_PESSOA_FISICA,null),1,200) nm_paciente, 
		nr_atendimento, 
		nr_prescricao 
into STRICT	nm_medico_cirurgiao_w, 
		ds_procedimento_w, 
		dt_cirurgia_w, 
		nm_paciente_w, 
		nr_atendimento_w, 
		nr_prescricao_w 
from 	cirurgia 
where	nr_cirurgia = nr_cirurgia_p;
 
select	substr(obter_categoria_convenio(cd_convenio,cd_categoria),1,30) ds_categoria, 
		substr(obter_nome_convenio(cd_convenio),1,40) ds_convenio 
into STRICT	ds_categoria_w, 
		ds_convenio_w		 
from	atend_categoria_convenio 
where	nr_atendimento = nr_atendimento_w;
 
select	substr(obter_nome_pf(cd_pessoa_fisica_p),1,254) 
into STRICT	nm_participante_w
;
 
 
open C01;
loop 
fetch C01 into	 
	ds_proc_adic_aux_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin 
	if (coalesce(ds_proc_adic_w::text, '') = '') then 
		ds_proc_adic_w := ds_proc_adic_aux_w;
	else	 
		ds_proc_adic_w	:= ds_proc_adic_w || ', ' || ds_proc_adic_aux_w;
	end if;	
	end;
end loop;
close C01;
	 
select	ds_declaracao 
into STRICT	ds_declaracao_w 
from 	declaracao 
where 	cd_declaracao	= cd_declaracao_p;
 
 
ds_declaracao_w	:= substr(replace_macro(ds_declaracao_w,'@procedimento',ds_procedimento_w),1,4000);
ds_declaracao_w	:= substr(replace_macro(ds_declaracao_w,'@cirurgiao',nm_medico_cirurgiao_w),1,4000);
ds_declaracao_w	:= substr(replace_macro(ds_declaracao_w,'@paciente',nm_paciente_w),1,4000);
ds_declaracao_w	:= substr(replace_macro(ds_declaracao_w,'@data',dt_cirurgia_w),1,4000);
ds_declaracao_w	:= substr(replace_macro(ds_declaracao_w,'@cirurgia',nr_cirurgia_w),1,4000);
ds_declaracao_w	:= substr(replace_macro(ds_declaracao_w,'@convenio',ds_convenio_w),1,4000);
ds_declaracao_w	:= substr(replace_macro(ds_declaracao_w,'@categoria',ds_categoria_w),1,4000);
ds_declaracao_w	:= substr(replace_macro(ds_declaracao_w,'@procadic',ds_proc_adic_w),1,4000);
ds_declaracao_w	:= substr(replace_macro(ds_declaracao_w,'@participante',nm_participante_w),1,4000);
 
return 	ds_declaracao_w;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_conteudo_email_cirurgia ( nr_cirurgia_p bigint, cd_declaracao_p text, cd_pessoa_fisica_p text) FROM PUBLIC;

