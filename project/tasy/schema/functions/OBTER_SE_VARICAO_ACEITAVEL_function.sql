-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_se_varicao_aceitavel ( nr_seq_derivado_p bigint, nr_cirurgia_p bigint) RETURNS varchar AS $body$
DECLARE



qt_dispensado_w		double precision;
qt_utilizado_w		double precision;
qt_variacao_w		double precision;
qt_variacao_perc_w	double precision;


BEGIN

select	sum(a.qt_dose * (obter_volume_hemocomponente(a.nr_seq_derivado,'V'))::numeric ) qt_volume_disp,
	sum(b.qt_dose) qt_volume_util
into STRICT	qt_dispensado_w,
	qt_utilizado_w
from	cirurgia_agente_anestesico a,
	cirurgia_agente_anest_ocor b
where	a.nr_sequencia		= b.nr_seq_cirur_agente
and	a.nr_cirurgia		= nr_cirurgia_p
and	a.nr_seq_derivado	= nr_seq_derivado_p
and	ie_tipo			= 5
and	coalesce(a.ie_situacao,'A')  = 'A'
and	coalesce(b.ie_situacao,'A')  = 'A';

select	coalesce(qt_variacao,30)
into STRICT	qt_variacao_w
from	san_derivado
where	nr_sequencia	= nr_seq_derivado_p;

select	dividir(abs(qt_dispensado_w - qt_utilizado_w),qt_dispensado_w) * 100
into STRICT	qt_variacao_perc_w
;

if (qt_variacao_perc_w > qt_variacao_w) then
	return 'N';
else
	return 'S';
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_se_varicao_aceitavel ( nr_seq_derivado_p bigint, nr_cirurgia_p bigint) FROM PUBLIC;

