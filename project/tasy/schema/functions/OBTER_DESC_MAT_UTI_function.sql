-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_desc_mat_uti ( cd_material_orig_p bigint, cd_material_p bigint, nr_seq_atendimento_p bigint, nr_seq_material_p bigint, nr_prescricao_p bigint, nr_sequencia_p bigint, nr_agrupamento_p bigint, ie_opcao_p bigint, qt_etiquetas_p bigint, nr_seq_horario_p bigint) RETURNS varchar AS $body$
DECLARE


ds_mat_proc_w		varchar(2000);
cd_material_w		bigint;
qt_dose_dil_w		double precision;
cd_unidade_med_dil_w	varchar(30);
qt_dose_w		double precision;
nr_agrupamento_w	double precision;
qt_item_w		bigint;
x			bigint;
cd_unid_med_dose_w	varchar(30);
ds_material_w		varchar(255);
ds_item_aux_w		varchar(255);
ds_mat_retorno_w	varchar(255);
nr_seq_protocolo_w	integer;
cd_protocolo_w		bigint;
ds_rotina_w		varchar(100);
ds_recomendacao_w	varchar(255);
ie_agrupador_w		smallint;

c01 CURSOR FOR
SELECT	distinct
	rpad(substr(obter_desc_redu_material(b.cd_material),1,30),30,' ') || ' ' || Campo_Mascara_virgula_rel(trunc(dividir(b.qt_dose,coalesce(qt_etiquetas_p,1)),2)) || ' ' || b.cd_unidade_medida_dose  || ' Vol: ' || Campo_Mascara_virgula_rel(obter_conversao_ml(b.cd_material,b.qt_dose,b.cd_unidade_medida_dose)) || ' mL'
from	prescr_material b
where	b.nr_agrupamento	= nr_agrupamento_p
and	b.nr_prescricao		= nr_prescricao_p
and	b.ie_agrupador		not in (3,4,5,6,8,10,11,12)
and	b.cd_material		<> cd_material_w
and (coalesce(b.nr_sequencia_diluicao,coalesce(nr_seq_material_p,0)) = coalesce(nr_seq_material_p,0))
and	coalesce(b.dt_suspensao::text, '') = ''
and	b.ie_agrupador = ie_agrupador_w;


BEGIN
if (cd_material_orig_p IS NOT NULL AND cd_material_orig_p::text <> '') and (cd_material_p IS NOT NULL AND cd_material_p::text <> '') then

	if (coalesce(cd_material_w::text, '') = '') then
		select	max(a.cd_material),
			max(a.qt_dose),
			max(a.cd_unidade_medida_dose),
			max(a.nr_agrupamento),
			max(a.cd_protocolo),
			max(a.nr_seq_protocolo),
			max(a.ie_agrupador)
		into STRICT	cd_material_w,
			qt_dose_w,
			cd_unid_med_dose_w,
			nr_agrupamento_w,
			cd_protocolo_w,
			nr_seq_protocolo_w,
			ie_agrupador_w
		from	prescr_medica b,
			prescr_material a
		where	a.nr_prescricao		= b.nr_prescricao
		and	a.nr_prescricao		= nr_prescricao_p
		and	a.nr_sequencia		= nr_sequencia_p
		and	coalesce(a.dt_suspensao::text, '') = '';

		select	max(qt_dose)
		into STRICT	qt_dose_w
		from	prescr_mat_hor a
		where	a.nr_prescricao		= nr_prescricao_p
		and	a.nr_seq_material	= nr_sequencia_p
		and	a.nr_sequencia		= nr_seq_horario_p;

	end if;

	/*informações do diluente*/

	select	max(qt_dose),
		max(CD_UNIDADE_MEDIDA_DOSE)
	into STRICT	qt_dose_dil_w,
		cd_unidade_med_dil_w
	from	prescr_material
	where	nr_prescricao		= nr_prescricao_p
	and	nr_sequencia_diluicao	= nr_sequencia_p
	and	ie_agrupador		= 3
	and	coalesce(dt_suspensao::text, '') = '';

	/*Item principal da prescrição*/

	ds_mat_proc_w	:= rpad(substr(obter_desc_redu_material(cd_material_w),1,30),30,' ') || ' ' || Campo_Mascara_virgula_rel(trunc(dividir(qt_dose_w,coalesce(qt_etiquetas_p,1)),2)) || ' ' || cd_unid_med_dose_w || ' Vol: ' || Campo_Mascara_virgula_rel(obter_conversao_ml(cd_material_w,qt_dose_w,cd_unid_med_dose_w)) || ' mL' ||'@';

	/*itens agrupados ao item principal*/

	open C01;
	loop
	fetch C01 into
		ds_material_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		ds_mat_proc_w	:= ds_mat_proc_w || ds_material_w || '@';
	end loop;
	close C01;

	/*diluente do item principal*/

	ds_mat_proc_w	:= ds_mat_proc_w || rpad(substr(obter_desc_redu_material(obter_diluente_material(nr_prescricao_p, nr_sequencia_p)),1,30),30,' ') || ' '|| Campo_Mascara_virgula_rel(trunc(dividir(qt_dose_dil_w,coalesce(qt_etiquetas_p,1)),2)) || ' ' || cd_unidade_med_dil_w||'@';

	x 		:= 1;
	qt_item_w	:= 0;
	ds_item_aux_w	:= '';

	while(x <= length(ds_mat_proc_w)) loop
		if (substr(ds_mat_proc_w,x,1) <> '@') then
			ds_item_aux_w	:= ds_item_aux_w || substr(ds_mat_proc_w,x,1);
		end if;

		if (substr(ds_mat_proc_w,x,1) = '@') then
			qt_item_w	:= qt_item_w + 1;
			if (ie_opcao_p	= qt_item_w) then
				ds_mat_retorno_w := ds_item_aux_w;
				exit;
			elsif (ie_opcao_p	> qt_item_w) then
				ds_item_aux_w	 := '';
				ds_mat_retorno_w := '';
			end if;
			ds_item_aux_w	:= '';
		end if;

		x := x + 1;
	end loop;

	ds_mat_proc_w	:= ds_mat_retorno_w;

	if (ie_opcao_p = 11) then
		ds_mat_proc_w := ds_recomendacao_w;
	end if;

end if;


return ds_mat_proc_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_desc_mat_uti ( cd_material_orig_p bigint, cd_material_p bigint, nr_seq_atendimento_p bigint, nr_seq_material_p bigint, nr_prescricao_p bigint, nr_sequencia_p bigint, nr_agrupamento_p bigint, ie_opcao_p bigint, qt_etiquetas_p bigint, nr_seq_horario_p bigint) FROM PUBLIC;

