-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION sinan_get_atend_anzics ( NR_SEQUENCIA_P NOTIFICACAO_SINAN.NR_SEQUENCIA%TYPE ) RETURNS ATEND_ANZICS.NR_SEQUENCIA%TYPE AS $body$
DECLARE

  NR_SEQUENCIA_W   ATEND_ANZICS.NR_SEQUENCIA%TYPE;

  C_DATA CURSOR FOR
      SELECT  MAX(N.NR_ATENDIMENTO) NR_ATENDIMENTO,
              MAX(C.NR_SEQ_FORMULARIO_CLINICO) NR_SEQ_FORMULARIO_CLINICO,
              MAX(N.DT_NOTIFICACAO) DT_NOTIFICACAO
      FROM    NOTIFICACAO_SINAN N,
              CIH_DOENCA_COMPULSORIA C
      WHERE   C.NR_SEQUENCIA = N.NR_SEQ_DOENCA_COMPULSORIA
      AND     N.NR_SEQUENCIA = NR_SEQUENCIA_P
      AND     (C.CD_DOENCA_CID IS NOT NULL AND C.CD_DOENCA_CID::text <> '')
      AND     (C.NR_SEQ_FORMULARIO_CLINICO IS NOT NULL AND C.NR_SEQ_FORMULARIO_CLINICO::text <> '');
BEGIN
  FOR C_DATA_LINE IN C_DATA
  LOOP
    SELECT  coalesce(MAX(A.NR_SEQUENCIA), 0)
    INTO STRICT    NR_SEQUENCIA_W
    FROM    ATEND_ANZICS A
    WHERE   A.NR_ATENDIMENTO = C_DATA_LINE.NR_ATENDIMENTO
    AND     A.DT_GENERATE = C_DATA_LINE.DT_NOTIFICACAO
    AND     A.IE_SITUACAO = 'A'
    AND     A.NR_SEQ_ANZICS = C_DATA_LINE.NR_SEQ_FORMULARIO_CLINICO;
  END LOOP;

  RETURN NR_SEQUENCIA_W;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION sinan_get_atend_anzics ( NR_SEQUENCIA_P NOTIFICACAO_SINAN.NR_SEQUENCIA%TYPE ) FROM PUBLIC;

