-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION consiste_setor_prescr_proc (nr_prescricao_p bigint, cd_setor_atendimento_p bigint, cd_procedimento_p bigint, ie_origem_proced_p bigint, cd_setor_procedimento_p bigint, ie_consiste_setor_adic_p text) RETURNS varchar AS $body$
DECLARE


ds_retorno_w		varchar(255) := '';
cd_setor_prescr_w	integer;
ds_setor_prescr_w	varchar(100);
cd_setor_exclusivo_w	integer;
cd_setor_adic_w		integer;
ds_setor_exclusivo_w	varchar(100);
cd_setor_liberado_w	integer;
qt_setor_adicional_w	bigint;
ds_setor_procedimento_w	varchar(100);
cd_setor_adicional_w	integer;


BEGIN

select	coalesce(max(cd_setor_entrega),0)
into STRICT	cd_setor_prescr_w
from	prescr_medica
where	nr_prescricao	= nr_prescricao_p;

if (cd_setor_prescr_w > 0) then
	begin

	select	ds_setor_atendimento
	into STRICT	ds_setor_prescr_w
	from	setor_atendimento
	where	cd_setor_atendimento	= cd_setor_prescr_w;

	select	coalesce(max(cd_setor_exclusivo),0)
	into STRICT	cd_setor_exclusivo_w
	from	procedimento
	where	cd_procedimento		= cd_procedimento_p
	and	ie_origem_proced	= ie_origem_proced_p;

	if (ie_consiste_setor_adic_p = 'S') and (cd_setor_procedimento_p  > 0) then
		begin

		select	count(*)
		into STRICT	qt_setor_adicional_w
		from	PROCEDIMENTO_SETOR_ATEND
		where	cd_procedimento		= cd_procedimento_p
		and	ie_origem_proced	= ie_origem_proced_p;

		if (qt_setor_adicional_w > 0) then
			begin

			select	coalesce(max(cd_setor_atendimento),0)
			into STRICT	cd_setor_adic_w
			from	PROCEDIMENTO_SETOR_ATEND
			where	cd_procedimento		= cd_procedimento_p
			and	ie_origem_proced	= ie_origem_proced_p
			and	cd_setor_atendimento	= cd_setor_procedimento_p;

			if (cd_setor_adic_w = 0) then
				select	max(ds_setor_atendimento)
				into STRICT	ds_setor_procedimento_w
				from	setor_atendimento
				where	cd_setor_atendimento	= cd_setor_procedimento_p;
				ds_retorno_w	:= wheb_mensagem_pck.get_texto(306613, 'DS_SETOR_PROC=' || ds_setor_procedimento_w);
				-- O setor #@DS_SETOR_PROC#@ não está liberado como setor adicional do procedimento!
			end if;

			end;
		end if;

		end;

	elsif (ie_consiste_setor_adic_p = 'P') and (cd_setor_procedimento_p  > 0) then

		select	count(*)
		into STRICT	qt_setor_adicional_w
		from	PROCEDIMENTO_SETOR_ATEND
		where	cd_procedimento		= cd_procedimento_p
		and	ie_origem_proced	= ie_origem_proced_p;

		if (qt_setor_adicional_w > 0) then
			begin

			select	coalesce(max(cd_setor_atendimento),0)
			into STRICT	cd_setor_adic_w
			from	PROCEDIMENTO_SETOR_ATEND
			where	cd_procedimento		= cd_procedimento_p
			and	ie_origem_proced	= ie_origem_proced_p
			and	cd_setor_atendimento	= cd_setor_procedimento_p;

			if (cd_setor_adic_w = 0) then
				select	max(ds_setor_atendimento)
				into STRICT	ds_setor_procedimento_w
				from	setor_atendimento
				where	cd_setor_atendimento	= cd_setor_procedimento_p;
				ds_retorno_w	:= Wheb_mensagem_pck.get_texto(306614, 'DS_SETOR_PROC=' || ds_setor_procedimento_w);
				-- O setor #@DS_SETOR_PROC#@ não está liberado como setor adicional do procedimento!
			else
				select	coalesce(max(cd_setor_atendimento),0)
				into STRICT	cd_setor_adicional_w
				from	procedimento_setor_atend
				where	cd_procedimento		= cd_procedimento_p
				and	ie_origem_proced	= ie_origem_proced_p
				and	cd_setor_atendimento	= cd_setor_prescr_w;

				if (cd_setor_adicional_w = 0) then
					select	max(ds_setor_atendimento)
					into STRICT	ds_setor_procedimento_w
					from	setor_atendimento
					where	cd_setor_atendimento	= cd_setor_procedimento_p;
					ds_retorno_w	:= Wheb_mensagem_pck.get_texto(306615, 	'DS_SETOR_PROC=' || ds_setor_procedimento_w || ';' ||
																			'DS_SETOR_PRESCR=' || ds_setor_prescr_w);
					-- O setor #@DS_SETOR_PROC#@ é diferente do setor da prescrição, #@DS_SETOR_PRESCR#@
				end if;
			end if;

			end;
		end if;
	end if;

	if (cd_setor_exclusivo_w > 0) then
		begin

		select	ds_setor_atendimento
		into STRICT	ds_setor_exclusivo_w
		from	setor_atendimento
		where	cd_setor_atendimento	= cd_setor_exclusivo_w;

		if (cd_setor_prescr_w <> cd_setor_exclusivo_w) then
			ds_retorno_w	:= 'O setor ' || ds_setor_exclusivo_w ||
					   ' é diferente do setor da prescrição, ' || ds_setor_prescr_w;
		end if;

		end;
	end if;

	end;
end if;

return	ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION consiste_setor_prescr_proc (nr_prescricao_p bigint, cd_setor_atendimento_p bigint, cd_procedimento_p bigint, ie_origem_proced_p bigint, cd_setor_procedimento_p bigint, ie_consiste_setor_adic_p text) FROM PUBLIC;

