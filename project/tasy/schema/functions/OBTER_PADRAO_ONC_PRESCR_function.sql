-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_padrao_onc_prescr (nr_seq_paciente_p bigint, nr_seq_material_p bigint, cd_material_p bigint, ie_opcao_p text, ie_pasta_p text) RETURNS varchar AS $body$
DECLARE

/* 
Descrição 				Campo				ie_opcao_p 
Unidade medida			CD_UNIDADE_MEDIDA		'UM' (Nao tem no atendimento do ciclo)  
Via administrativa			IE_VIA_APLICACAO			'V' 
Disp de infusão			IE_BOMBA_INFUSAO			'DI' 
Aplicação(hora/min)			QT_MIN_APLICACAO			'MA' 
Aplicação(hora/min)			QT_HORA_APLICACAO		'HA' 
Se Necessário 			IE_SE_NECESSARIO 			'SN' 
Intervalo				CD_INTERVALO			'I' 
Agora				IE_URGENCIA			'A' 
Observação				DS_OBSERVACAO 			'O' 
 
 
Descrição 				ie_pasta_p 
 
Protocolo				P 
Atendimento do ciclo			C 
 
*/
 
 
ds_retorno_w				varchar(255) := null;
ds_resultado_w				varchar(255) := null;
cd_setor_atendimento_w			integer;
cd_pessoa_fisica_w			varchar(10);
ie_dias_util_medic_w			varchar(1);
ie_via_aplicacao_w			varchar(5);
cd_unidade_medida_consumo_w		varchar(30);
ie_tipo_material_w			varchar(3);
ie_bomba_infusao_w			varchar(1);
ie_medic_paciente_w			varchar(1);
cd_estabelecimento_w			smallint;
qt_peso_w				real;

 

BEGIN 
 
cd_estabelecimento_w := wheb_usuario_pck.get_cd_estabelecimento;
 
If (cd_material_p > 0) then 
 
 
 
	SELECT max(ie_dias_util_medic), 
			MAX(SUBSTR(coalesce(obter_unidade_medida_prior_onc(cd_material,cd_estabelecimento_w),obter_dados_material_estab(cd_material,cd_estabelecimento_w,'UMS')),1,30)), 
			max(ie_via_aplicacao), 
			max(ie_tipo_material), 
			max(ie_bomba_infusao), 
			coalesce(max(ie_medic_paciente),'N') 
	into STRICT	ie_dias_util_medic_w, 
			cd_unidade_medida_consumo_w, 
			ie_via_aplicacao_w, 
			ie_tipo_material_w, 
			ie_bomba_infusao_w, 
			ie_medic_paciente_w 
	 FROM material 
	 WHERE cd_material = cd_material_p;
 
end if;
 
If (ie_opcao_p = 'UM') and (cd_unidade_medida_consumo_w IS NOT NULL AND cd_unidade_medida_consumo_w::text <> '') then 
	 
	ds_retorno_w := cd_unidade_medida_consumo_w;
	 
	 
elsif (ie_pasta_p = 'P') then 
 
	Select max(cd_setor_atendimento), 
			max(cd_pessoa_fisica), 
			max(qt_peso) 
	into STRICT	cd_setor_atendimento_w, 
		cd_pessoa_fisica_w, 
		qt_peso_w		 
	from	paciente_setor		 
	where	nr_seq_paciente = nr_seq_paciente_p;
	 
	 
	If (ie_opcao_p = 'V') then 
		select Obter_Padrao_Param_Prescr(NULL,cd_material_p,ie_via_aplicacao_w,cd_setor_atendimento_w,cd_pessoa_fisica_w,Obter_Idade_PF(cd_pessoa_fisica_w, clock_timestamp(), 'A'),qt_peso_w,'N','V') 
		into STRICT  ds_resultado_w 
		;
		 
		ds_retorno_w := coalesce(ds_resultado_w,ie_via_aplicacao_w);
	end if;
	 
	If (ie_opcao_p = 'DI') then 
		select Obter_Padrao_Param_Prescr(NULL,cd_material_p,ie_via_aplicacao_w,cd_setor_atendimento_w,cd_pessoa_fisica_w,Obter_Idade_PF(cd_pessoa_fisica_w, clock_timestamp(), 'A'),qt_peso_w,'N','DI') 
		into STRICT  ds_resultado_w 
		;
		 
		ds_retorno_w := coalesce(ds_resultado_w,ie_bomba_infusao_w);
	end if;
	 
	If (ie_opcao_p = 'MA') then 
		select Obter_Padrao_Param_Prescr(NULL,cd_material_p,ie_via_aplicacao_w,cd_setor_atendimento_w,cd_pessoa_fisica_w,Obter_Idade_PF(cd_pessoa_fisica_w, clock_timestamp(), 'A'),qt_peso_w,'N','MA') 
		into STRICT  ds_resultado_w 
		;
		 
		ds_retorno_w := coalesce(ds_resultado_w,'');
	end if;
	 
	If (ie_opcao_p = 'HA') then 
		select Obter_Padrao_Param_Prescr(NULL,cd_material_p,ie_via_aplicacao_w,cd_setor_atendimento_w,cd_pessoa_fisica_w,Obter_Idade_PF(cd_pessoa_fisica_w, clock_timestamp(), 'A'),qt_peso_w,'N','HA') 
		into STRICT  ds_resultado_w 
		;
		 
		ds_retorno_w := coalesce(ds_resultado_w,'');
 
	end if;
	 
	If (ie_opcao_p = 'SN') then 
		select Obter_Padrao_Param_Prescr(NULL,cd_material_p,ie_via_aplicacao_w,cd_setor_atendimento_w,cd_pessoa_fisica_w,Obter_Idade_PF(cd_pessoa_fisica_w, clock_timestamp(), 'A'),qt_peso_w,'N','SN') 
		into STRICT  ds_resultado_w 
		;
		 
		ds_retorno_w := coalesce(ds_resultado_w,'');
	end if;
	 
	If (ie_opcao_p = 'I') then 
		select Obter_Padrao_Param_Prescr(NULL,cd_material_p,ie_via_aplicacao_w,cd_setor_atendimento_w,cd_pessoa_fisica_w,Obter_Idade_PF(cd_pessoa_fisica_w, clock_timestamp(), 'A'),qt_peso_w,'N','I') 
		into STRICT  ds_resultado_w 
		;
		 
		ds_retorno_w := coalesce(ds_resultado_w,'');
	end if;
	 
	If (ie_opcao_p = 'A') then 
		select Obter_Padrao_Param_Prescr(NULL,cd_material_p,ie_via_aplicacao_w,cd_setor_atendimento_w,cd_pessoa_fisica_w,Obter_Idade_PF(cd_pessoa_fisica_w, clock_timestamp(), 'A'),qt_peso_w,'N','A') 
		into STRICT  ds_resultado_w 
		;
		 
		ds_retorno_w := coalesce(ds_resultado_w,'');
	end if;
	 
	If (ie_opcao_p = 'O') then 
		select Obter_Padrao_Param_Prescr(NULL,cd_material_p,ie_via_aplicacao_w,cd_setor_atendimento_w,cd_pessoa_fisica_w,Obter_Idade_PF(cd_pessoa_fisica_w, clock_timestamp(), 'A'),qt_peso_w,'N','O') 
		into STRICT  ds_resultado_w 
		;
		 
		ds_retorno_w := coalesce(ds_resultado_w,'');
	end if;
 
 
elsif (ie_pasta_p = 'C') then 
 
	Select max(cd_setor_atendimento), 
			max(cd_pessoa_fisica), 
			max(qt_peso) 
	into STRICT	cd_setor_atendimento_w, 
		cd_pessoa_fisica_w, 
		qt_peso_w		 
	from	paciente_setor		 
	where	nr_seq_paciente = nr_seq_paciente_p;
	 
	 
	If (ie_opcao_p = 'V') then 
		select Obter_Padrao_Param_Prescr(NULL,cd_material_p,ie_via_aplicacao_w,cd_setor_atendimento_w,cd_pessoa_fisica_w,Obter_Idade_PF(cd_pessoa_fisica_w, clock_timestamp(), 'A'),qt_peso_w,'N','V') 
		into STRICT  ds_resultado_w 
		;
		 
		ds_retorno_w := coalesce(ds_resultado_w,ie_via_aplicacao_w);
	end if;
	 
	If (ie_opcao_p = 'DI') then 
		select Obter_Padrao_Param_Prescr(NULL,cd_material_p,ie_via_aplicacao_w,cd_setor_atendimento_w,cd_pessoa_fisica_w,Obter_Idade_PF(cd_pessoa_fisica_w, clock_timestamp(), 'A'),qt_peso_w,'N','DI') 
		into STRICT  ds_resultado_w 
		;
		 
		ds_retorno_w := coalesce(ds_resultado_w,ie_bomba_infusao_w);
	end if;
	 
	If (ie_opcao_p = 'MA') then 
		select Obter_Padrao_Param_Prescr(NULL,cd_material_p,ie_via_aplicacao_w,cd_setor_atendimento_w,cd_pessoa_fisica_w,Obter_Idade_PF(cd_pessoa_fisica_w, clock_timestamp(), 'A'),qt_peso_w,'N','MA') 
		into STRICT  ds_resultado_w 
		;
		 
		ds_retorno_w := coalesce(ds_resultado_w,'');
	end if;
	 
	If (ie_opcao_p = 'HA') then 
		select Obter_Padrao_Param_Prescr(NULL,cd_material_p,ie_via_aplicacao_w,cd_setor_atendimento_w,cd_pessoa_fisica_w,Obter_Idade_PF(cd_pessoa_fisica_w, clock_timestamp(), 'A'),qt_peso_w,'N','HA') 
		into STRICT  ds_resultado_w 
		;
		 
		ds_retorno_w := coalesce(ds_resultado_w,'');
 
	end if;
	 
	If (ie_opcao_p = 'SN') then 
		select Obter_Padrao_Param_Prescr(NULL,cd_material_p,ie_via_aplicacao_w,cd_setor_atendimento_w,cd_pessoa_fisica_w,Obter_Idade_PF(cd_pessoa_fisica_w, clock_timestamp(), 'A'),qt_peso_w,'N','SN') 
		into STRICT  ds_resultado_w 
		;
		 
		ds_retorno_w := coalesce(ds_resultado_w,'');
	end if;
	 
	If (ie_opcao_p = 'I') then 
		select Obter_Padrao_Param_Prescr(NULL,cd_material_p,ie_via_aplicacao_w,cd_setor_atendimento_w,cd_pessoa_fisica_w,Obter_Idade_PF(cd_pessoa_fisica_w, clock_timestamp(), 'A'),qt_peso_w,'N','I') 
		into STRICT  ds_resultado_w 
		;
		 
		ds_retorno_w := coalesce(ds_resultado_w,'');
	end if;
	 
	If (ie_opcao_p = 'A') then 
		select Obter_Padrao_Param_Prescr(NULL,cd_material_p,ie_via_aplicacao_w,cd_setor_atendimento_w,cd_pessoa_fisica_w,Obter_Idade_PF(cd_pessoa_fisica_w, clock_timestamp(), 'A'),qt_peso_w,'N','A') 
		into STRICT  ds_resultado_w 
		;
		 
		ds_retorno_w := coalesce(ds_resultado_w,'');
	end if;
	 
	If (ie_opcao_p = 'O') then 
		select Obter_Padrao_Param_Prescr(NULL,cd_material_p,ie_via_aplicacao_w,cd_setor_atendimento_w,cd_pessoa_fisica_w,Obter_Idade_PF(cd_pessoa_fisica_w, clock_timestamp(), 'A'),qt_peso_w,'N','O') 
		into STRICT  ds_resultado_w 
		;
		 
		ds_retorno_w := coalesce(ds_resultado_w,'');
	end if;
	 
	 
end if;
 
 
return ds_retorno_w;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_padrao_onc_prescr (nr_seq_paciente_p bigint, nr_seq_material_p bigint, cd_material_p bigint, ie_opcao_p text, ie_pasta_p text) FROM PUBLIC;

