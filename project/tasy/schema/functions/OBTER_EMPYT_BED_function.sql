-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_empyt_bed ( cd_setor_atendimento_p bigint, ie_sexo_p text, dt_base_p timestamp ) RETURNS bigint AS $body$
DECLARE

    qt_leito_livre_w            unidade_atendimento.QT_DIAS_PREV_INTERD%type;
    qt_prevista_internacao_w    unidade_atendimento.QT_DIAS_PREV_INTERD%type;
    qt_previsto_alta_w          unidade_atendimento.QT_DIAS_PREV_INTERD%type;
    qt_transferencia_interna_w  unidade_atendimento.QT_DIAS_PREV_INTERD%type;
    qt_transferencia_externa_w  unidade_atendimento.QT_DIAS_PREV_INTERD%type;
    qt_result_w                 unidade_atendimento.QT_DIAS_PREV_INTERD%type;
    dt_base_w                   unidade_atendimento.DT_ATUALIZACAO%type;

BEGIN
	dt_base_w := trunc(dt_base_p);
    SELECT
        COUNT(1)
    INTO STRICT qt_leito_livre_w
    FROM
        unidade_atendimento b
    WHERE
            b.ie_status_unidade = 'L'
        AND b.cd_setor_atendimento = cd_setor_atendimento_p
        AND ( ( ie_sexo_p IN ( 'M', 'F' )
                AND b.ie_sexo_paciente = ie_sexo_p )
              OR ( ie_sexo_p NOT IN ( 'M', 'F' )
                   AND b.ie_sexo_paciente NOT IN ( 'M', 'F' ) ) );

    SELECT
        COUNT(1)
    INTO STRICT qt_prevista_internacao_w
    FROM
        gestao_vaga          g,
        unidade_atendimento  ua
    WHERE
            g.nr_atendimento = ua.nr_atendimento
        AND g.cd_setor_desejado = cd_setor_atendimento_p
        AND g.ie_status = 'A' 				/* aguardando*/
        AND trunc(coalesce(g.dt_prevista, g.dt_solicitacao)) = dt_base_w
        AND ( ( ie_sexo_p IN ( 'M', 'F' )
                AND ua.ie_sexo_paciente = ie_sexo_p )
              OR ( ie_sexo_p NOT IN ( 'M', 'F' )
                   AND coalesce(ua.ie_sexo_paciente, 'x') NOT IN ( 'M', 'F' ) ) );

    SELECT
        COUNT(1)
    INTO STRICT qt_previsto_alta_w
    FROM
        atendimento_paciente  ap,
        unidade_atendimento   ua
    WHERE
            trunc(ap.dt_previsto_alta) = dt_base_w
        AND ua.nr_atendimento = ap.nr_atendimento
        AND ua.cd_setor_atendimento = cd_setor_atendimento_p
        AND ( ( ie_sexo_p IN ( 'M', 'F' )
                AND ua.ie_sexo_paciente = ie_sexo_p )
              OR ( ie_sexo_p NOT IN ( 'M', 'F' )
                   AND coalesce(ua.ie_sexo_paciente, 'x') NOT IN ( 'M', 'F' ) ) );

    SELECT
        COUNT(1)
    INTO STRICT qt_transferencia_interna_w
    FROM
        gestao_vaga          g,
        unidade_atendimento  ua
    WHERE
            g.nr_atendimento = ua.nr_atendimento
        AND g.cd_setor_desejado = cd_setor_atendimento_p
        AND g.ie_status = 'TI' 				/* transferencia interna*/
        AND trunc(coalesce(g.dt_prevista, g.dt_solicitacao)) = dt_base_w
        AND ( ( ie_sexo_p IN ( 'M', 'F' )
                AND ua.ie_sexo_paciente = ie_sexo_p )
              OR ( ie_sexo_p NOT IN ( 'M', 'F' )
                   AND coalesce(ua.ie_sexo_paciente, 'x') NOT IN ( 'M', 'F' ) ) );

    SELECT
        COUNT(1)
    INTO STRICT qt_transferencia_externa_w
    FROM
        gestao_vaga          g,
        unidade_atendimento  ua
    WHERE
            g.nr_atendimento = ua.nr_atendimento
        AND g.cd_setor_desejado = cd_setor_atendimento_p
        AND g.ie_status = 'TE' 				/* transferencia externa */
        AND trunc(coalesce(g.dt_prevista, g.dt_solicitacao)) = dt_base_w
        AND ( ( ie_sexo_p IN ( 'M', 'F' )
                AND ua.ie_sexo_paciente = ie_sexo_p )
              OR ( ie_sexo_p NOT IN ( 'M', 'F' )
                   AND coalesce(ua.ie_sexo_paciente, 'x') NOT IN ( 'M', 'F' ) ) );

    qt_result_w := GREATEST(0, qt_leito_livre_w - qt_prevista_internacao_w + qt_previsto_alta_w - qt_transferencia_interna_w - qt_transferencia_externa_w);
    RETURN qt_result_w;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_empyt_bed ( cd_setor_atendimento_p bigint, ie_sexo_p text, dt_base_p timestamp ) FROM PUBLIC;

