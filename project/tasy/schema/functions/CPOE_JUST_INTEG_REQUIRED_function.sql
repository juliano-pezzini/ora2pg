-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION cpoe_just_integ_required (nr_seq_cpoe_p cpoe_material.nr_sequencia%type, nr_atendimento_p cpoe_material.nr_atendimento%type, cd_pessoa_fisica_p cpoe_material.cd_pessoa_fisica%type, cd_perfil_p cpoe_material.cd_perfil_ativo%type ) RETURNS varchar AS $body$
DECLARE


ds_retorno_w			varchar(1);
ie_possui_registro_w	integer;
ie_integ_ativa_w		cliente_integracao.ie_situacao%type;


BEGIN

	ds_retorno_w := 'N';

	select coalesce(max(a.ie_situacao), 'I')
	  into STRICT ie_integ_ativa_w
	  from cliente_integracao a
	 where a.nr_seq_inf_integracao = 826;

	if (ie_integ_ativa_w = 'A') then

		/* Verifica se o sequencial da CPOE tem algum alerta sem justificativa para evitar a liberacao do item */

		select count(*) ie_possui_registro
		  into STRICT ie_possui_registro_w
		  from (
				SELECT
					case cd_api
						when 'A' then
							case ds_sub_tipo_api
								when 'DRUG' then cpoe_obter_se_obriga_just(medispan_convert_level_just(cd_api, ds_severity), nr_atendimento_p, cd_perfil_p)
								else 'N'
							end
						else cpoe_obter_se_obriga_just(medispan_convert_level_just(cd_api, ds_severity), nr_atendimento_p, cd_perfil_p) 
					end ds_justify_required,
					ds_justificativa
				from (
					SELECT
						a.nr_sequencia,
						a.cd_api,
						a.ds_sub_tipo_api,
						case a.nr_gravidade
							when 0 then 'MINOR'
							when 1 then 'CONTRAINDICATED'
							when 2 then 'MAJOR'
							when 3 then 'MODERATE'
							when 4 then 'MODERATE'
							when 5 then 'INFO'
							else ''
						end ds_severity,
						b.ds_justificativa
					FROM table(lista_pck.obter_lista_char(get_list_API_available(nr_atendimento_p, cd_pessoa_fisica_p, 'N'))) c, alerta_api a
LEFT OUTER JOIN cpoe_justif_interacao b ON (a.nr_seq_cpoe = b.nr_seq_mat_cpoe AND a.cd_material = b.cd_material_interacao AND a.cd_api = b.cd_api AND a.nr_gravidade = b.nr_gravidade AND a.ds_resultado_curto = b.ds_resultado_curto)
, coalesce(a
LEFT OUTER JOIN coalesce(b ON (coalesce(a.ds_sub_tipo_api, 'XPTO') = coalesce(b.ds_sub_tipo_api, 'XPTO'))
WHERE c.cd_registro = a.cd_api       and a.nr_seq_cpoe = nr_seq_cpoe_p and coalesce(a.ie_status_requisicao::text, '') = ''
					 ) alias12
				where (nr_sequencia IS NOT NULL AND nr_sequencia::text <> '')
				) alias14
		 where ds_justify_required = 'S'
		  and coalesce(ds_justificativa::text, '') = '';
		
		if (ie_possui_registro_w > 0) then
			ds_retorno_w := 'S';
		end if;
	end if;

	return ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION cpoe_just_integ_required (nr_seq_cpoe_p cpoe_material.nr_sequencia%type, nr_atendimento_p cpoe_material.nr_atendimento%type, cd_pessoa_fisica_p cpoe_material.cd_pessoa_fisica%type, cd_perfil_p cpoe_material.cd_perfil_ativo%type ) FROM PUBLIC;

