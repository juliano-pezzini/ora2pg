-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION pfcs_get_algorithm_visibility ( cd_algorithm_p text, cd_profile_p bigint default null, cd_establishment_p bigint default null, nm_user_p text default null) RETURNS varchar AS $body$
DECLARE


/*
    Get algorithm visibility based on username, profile and/or establishment following the standard restriction order used on TASY
    cd_algorithm_p:
        - SIM: SIMULATION
        - LOS: REMAINING LOS
        - FF: FREQUENT FLYER
        - EDI: TRS
        - LACE: READMISSION RISK

    RETURN 'Y' (yes) or 'N' (no)
*/
ie_visible_w varchar(1) := 'Y';


BEGIN
    select coalesce(max(v.ie_visibility), 'Y')
    into STRICT ie_visible_w
    from (
        SELECT sett.ie_visibility,
            sett.cd_estabelecimento cd_establishment,
            sett.cd_perfil cd_profile,
            sett.nm_usuario_regra nm_user
        from pfcs_algorithm_settings sett,
            pfcs_algorithm alg
        where sett.nr_seq_pfcs_algorithm = alg.nr_sequencia
            and alg.cd_algorithm = cd_algorithm_p
            and sett.nr_seq_pfcs_algorithm = alg.nr_sequencia
            and coalesce(sett.nm_usuario_regra, nm_user_p) = nm_user_p
            and coalesce(sett.cd_perfil, cd_profile_p) = cd_profile_p
            and coalesce(sett.cd_estabelecimento, cd_establishment_p) = cd_establishment_p
        order by sett.nm_usuario_regra, sett.cd_perfil, sett.cd_estabelecimento asc
    ) v LIMIT 1;

    return ie_visible_w;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION pfcs_get_algorithm_visibility ( cd_algorithm_p text, cd_profile_p bigint default null, cd_establishment_p bigint default null, nm_user_p text default null) FROM PUBLIC;

