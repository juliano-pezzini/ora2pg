-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_dados_armaz_mat_frac ( nr_etiqueta_p bigint, ie_tipo_p text default 1) RETURNS varchar AS $body$
DECLARE


nr_seq_estab_w		bigint;
nr_seq_estagio_w	bigint;
cd_material_w		bigint;
ds_retorno_w		varchar(255);


BEGIN

select	max(nr_sequencia)
into STRICT	nr_seq_estagio_w
from 	mat_estagio_armaz
where 	ie_estagio 	= '4';

if (nr_etiqueta_p IS NOT NULL AND nr_etiqueta_p::text <> '') then

	select	max(g.cd_material)
	into STRICT	cd_material_w
	from	prescr_material a,
			prescr_mat_hor g,
			gedipa_etapa_hor y
	where	g.nr_prescricao		= a.nr_prescricao
	and		a.nr_sequencia		= g.nr_seq_material
	and 	y.nr_seq_horario	= g.nr_sequencia
	and		a.ie_agrupador		= 1
	and		coalesce(g.dt_suspensao::text, '') = ''
	and		coalesce(a.nr_sequencia_diluicao::text, '') = ''
	and		g.nr_seq_etiqueta	= nr_etiqueta_p;

		select	coalesce(min(nr_sequencia),0)
		into STRICT	nr_seq_estab_w
		from	material_armazenamento
		where	cd_material					= cd_material_w
		--and		nvl(cd_estabelecimento, 1)	= 1
		and		coalesce(cd_estabelecimento, coalesce(wheb_usuario_pck.get_cd_estabelecimento,0)) = coalesce(wheb_usuario_pck.get_cd_estabelecimento,0)
		and		nr_seq_estagio	in (nr_seq_estagio_w)
		and		converte_estab_hor(ie_tempo_estab, qt_estabilidade)	=	(	SELECT	min(converte_estab_hor(ie_tempo_estab, qt_estabilidade))
																			from	material_armazenamento
																			where	cd_material		= cd_material_w
																			and		nr_seq_estagio	in (nr_seq_estagio_w)
																		);

		if (ie_tipo_p = 1) then
			if (nr_seq_estab_w > 0) then

				select	substr((qt_estabilidade ||' '|| substr(obter_valor_dominio(1246,ie_tempo_estab),1,100)),1,255)
				into STRICT	ds_retorno_w
				from	material_armazenamento
				where	nr_sequencia = nr_seq_estab_w;

			else

				ds_retorno_w := ' ';

			end if;
		else

			select	substr(obter_descricao_padrao('MAT_FORMA_ARMAZ','DS_FORMA_ARMAZ',nr_seq_forma),1,80)
			into STRICT	ds_retorno_w
			from	material_armazenamento
			where	cd_material	=	cd_material_w
			and		obter_se_contido(nr_seq_estagio,nr_seq_estagio_w) = 'S';

		end if;

end if;

return ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_dados_armaz_mat_frac ( nr_etiqueta_p bigint, ie_tipo_p text default 1) FROM PUBLIC;

