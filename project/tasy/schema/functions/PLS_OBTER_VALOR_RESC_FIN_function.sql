-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION pls_obter_valor_resc_fin ( nr_seq_resc_fin_p pls_solic_rescisao_fin.nr_sequencia%type, ie_opcao_p text) RETURNS bigint AS $body$
DECLARE


vl_item_w		double precision;
vl_cobrar_w		double precision;
vl_devolver_w		double precision;
dt_solicitacao_w	pls_solicitacao_rescisao.dt_solicitacao%type;
vl_devolucao_w		double precision;

C01 CURSOR FOR
	SELECT	sum(a.vl_item) vl_total,
		a.nr_seq_mensalidade,
		a.nr_titulo,
		b.vl_saldo_titulo vl_saldo,
		(	SELECT	coalesce(sum(x.vl_recebido),0) + coalesce(sum(x.vl_descontos),0)
			from	titulo_receber_liq x
			where	x.nr_titulo = a.nr_titulo) vl_baixa,
		sum(a.vl_devolucao_mens) vl_devolucao,
		(	select	max(coalesce(a.dt_inicio_cobertura, b.dt_inicio_cobertura))
			from	pls_mensalidade_segurado a,
				pls_mensalidade_seg_item b
			where	a.nr_sequencia = b.nr_seq_mensalidade_seg
			and	b.nr_sequencia = a.nr_seq_item_mensalidade) dt_inicio_cobertura,
		(	select	max(coalesce(a.dt_fim_cobertura, b.dt_fim_cobertura))
			from	pls_mensalidade_segurado a,
				pls_mensalidade_seg_item b
			where	a.nr_sequencia = b.nr_seq_mensalidade_seg
			and	b.nr_sequencia = a.nr_seq_item_mensalidade) dt_fim_cobertura,
		b.ie_situacao,
		(	select	coalesce(sum(x.vl_descontos),0)
			from	titulo_receber_liq x
			where	x.nr_titulo = a.nr_titulo
			and	x.nr_seq_resc_fin = nr_seq_resc_fin_p) vl_descontos_resc
	FROM table(pls_obj_dados_rescisao_pck.obter_dados_rescisao(nr_seq_resc_fin_p, wheb_usuario_pck.get_cd_estabelecimento)) a
LEFT OUTER JOIN titulo_receber b ON (a.nr_titulo = b.nr_titulo)
WHERE a.ie_tipo_item = 1 group by
		a.nr_seq_mensalidade,
		a.nr_titulo,
		b.vl_saldo_titulo,
		a.nr_seq_item_mensalidade,
		b.ie_situacao;

BEGIN

select	a.dt_solicitacao
into STRICT	dt_solicitacao_w
from	pls_solicitacao_rescisao a,
	pls_solic_rescisao_fin b
where	a.nr_sequencia = b.nr_seq_solicitacao
and	b.nr_sequencia = nr_seq_resc_fin_p;

select	coalesce(sum(vl_item),0)
into STRICT	vl_cobrar_w
from	table(pls_obj_dados_rescisao_pck.obter_dados_rescisao(nr_seq_resc_fin_p, wheb_usuario_pck.get_cd_estabelecimento))
where	ie_tipo_valor 	= 'R'
and	ie_tipo_item 	<> 1
and	ie_acao 	<> 3;

select	coalesce(sum(vl_item),0)
into STRICT	vl_devolver_w
from (SELECT	coalesce(CASE WHEN ie_tipo_item=1 THEN sum(vl_devolucao_mens)  ELSE sum(vl_item) END ,0) vl_item
	from	table(pls_obj_dados_rescisao_pck.obter_dados_rescisao(nr_seq_resc_fin_p, wheb_usuario_pck.get_cd_estabelecimento))
	where	ie_tipo_valor 	= 'P'
	and	ie_tipo_item 	<> 1
	and	ie_acao 	<> 3
	group by
		ie_tipo_item) alias7;

for r_c01_w in C01 loop
	begin
	vl_devolucao_w	:= r_c01_w.vl_devolucao - r_c01_w.vl_descontos_resc;

	if (r_c01_w.ie_situacao <> 3) and (vl_devolucao_w > 0) then
		if (r_c01_w.vl_saldo = 0) then --Se pagou valor total
			vl_devolver_w	:= vl_devolver_w + vl_devolucao_w;
		elsif	(r_c01_w.vl_baixa = 0 AND dt_solicitacao_w between r_c01_w.dt_inicio_cobertura and r_c01_w.dt_fim_cobertura) then --Se nÃ£o pagou nada
			vl_cobrar_w	:= vl_cobrar_w + r_c01_w.vl_total;
		elsif (r_c01_w.vl_baixa > vl_devolucao_w) then
			vl_devolver_w	:= vl_devolver_w + (r_c01_w.vl_baixa - vl_devolucao_w);
		elsif	(r_c01_w.vl_baixa < vl_devolucao_w AND dt_solicitacao_w between r_c01_w.dt_inicio_cobertura and r_c01_w.dt_fim_cobertura) then
			vl_cobrar_w	:=  vl_cobrar_w + (vl_devolucao_w - r_c01_w.vl_baixa);
		end if;
	end if;
	end;
end loop;

if (ie_opcao_p = 'SC') then --Saldo a cobrar
	if (vl_cobrar_w > vl_devolver_w) then
		vl_item_w	:= vl_cobrar_w - vl_devolver_w;
	else
		vl_item_w := 0;
	end if;
elsif (ie_opcao_p = 'SD') then --Saldo a devolver
	if (vl_devolver_w > vl_cobrar_w) then
		vl_item_w	:= vl_devolver_w - vl_cobrar_w;
	else
		vl_item_w := 0;
	end if;
end if;

return	coalesce(vl_item_w,0);

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION pls_obter_valor_resc_fin ( nr_seq_resc_fin_p pls_solic_rescisao_fin.nr_sequencia%type, ie_opcao_p text) FROM PUBLIC;

