-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION gqa_vinculo_etapa (nr_sequencia_p bigint) RETURNS varchar AS $body$
DECLARE


  ie_permite_alterar_w       gqa_pendencia_regra.ie_permite_alterar%TYPE;
  ie_permite_alterar_tempo_w gqa_pendencia_regra.ie_permite_alterar_tempo%TYPE;
  dt_fim_w                   gqa_protocolo_etapa_pac.dt_fim%TYPE;
  dt_prevista_fim_w          gqa_protocolo_etapa_pac.dt_prevista_fim%TYPE;
  nr_seq_etapa_w             gqa_protocolo_etapa_pac.nr_seq_etapa%TYPE;
  return_w                   varchar(1) := 'N';


BEGIN
  IF gqa_validar_pontos_etapa(nr_sequencia_p) = 'S' THEN
    BEGIN
      SELECT t.dt_fim
            ,t.dt_prevista_fim
            ,t.nr_seq_etapa
        INTO STRICT dt_fim_w
            ,dt_prevista_fim_w
            ,nr_seq_etapa_w
        FROM gqa_protocolo_etapa_pac t
       WHERE t.nr_sequencia = nr_sequencia_p;

      SELECT t.ie_permite_alterar
            ,t.ie_permite_alterar_tempo
        INTO STRICT ie_permite_alterar_w
            ,ie_permite_alterar_tempo_w
        FROM gqa_pendencia_regra t
       WHERE t.nr_sequencia = nr_seq_etapa_w;
    EXCEPTION
      WHEN no_data_found THEN
        NULL;
    END;

    IF coalesce(dt_fim_w::text, '') = '' OR ((dt_fim_w IS NOT NULL AND dt_fim_w::text <> '') AND ie_permite_alterar_w = 'S') THEN

      IF dt_prevista_fim_w < clock_timestamp() OR (dt_prevista_fim_w >= clock_timestamp() AND ie_permite_alterar_tempo_w = 'S') THEN
        return_w := 'S';
      END IF;
    END IF;
  END IF;

  RETURN return_w;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION gqa_vinculo_etapa (nr_sequencia_p bigint) FROM PUBLIC;

