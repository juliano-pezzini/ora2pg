-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_itens_prescr_farm (nr_prescricao_p bigint) RETURNS varchar AS $body$
DECLARE


qt_registro_w		bigint;
Qt_registro_medic_w	bigint	:= 0;
Qt_registro_mat_w	bigint	:= 0;
Qt_registro_SNE_w	bigint	:= 0;
Qt_registro_supl_w	bigint	:= 0;
ds_result_w		varchar(500);
ie_agrupador_w		smallint;
dt_inicio_anal_farm_w	timestamp;

C01 CURSOR FOR
	SELECT	count(*),
		ie_agrupador
	from	prescr_material
	where	nr_prescricao	= nr_prescricao_p
	and	ie_agrupador in (1,2,8,12)
	and	coalesce(ie_suspenso, 'N')	<> 'S'
	group by ie_agrupador;


BEGIN

/*
ESTA FUNCTION FAZ O SEGUINTE TRATAMENTO - OS 287406 ( A pedido do HSL)
Exibir prescrições que estão com a anáilise iniciada.
Exibir todas prescrições que tenham itens
Não exibir prescrições que possuam todos os itens suspensos
Exibir todas as prescrições que não tenha nenhum item
*/
select	max(dt_inicio_analise_farm)
into STRICT	dt_inicio_anal_farm_w
from	prescr_medica
where	nr_prescricao = nr_prescricao_p;

if (dt_inicio_anal_farm_w IS NOT NULL AND dt_inicio_anal_farm_w::text <> '') then
	Ds_result_w	:= wheb_mensagem_pck.get_texto(309563); -- Iniciada
end if;


select	count(*)
into STRICT	Qt_registro_w
from	prescr_procedimento
where	nr_prescricao	= nr_prescricao_p
and	coalesce(nr_seq_origem::text, '') = ''
and	coalesce(nr_seq_exame::text, '') = ''
and 	((Obter_se_exibe_proced(nr_prescricao,nr_sequencia,ie_tipo_proced,'O') = 'S') or (Obter_se_exibe_proced(nr_prescricao,nr_sequencia,ie_tipo_proced,'IVC') = 'S'))
and	coalesce(ie_suspenso, 'N') 	<> 'S';

if (Qt_registro_w <> 0) then
	Ds_result_w	:= 	Ds_result_w || ' ' || wheb_mensagem_pck.get_texto(309515) || ' '|| Qt_registro_w;
end if;

select	count(*)
into STRICT	Qt_registro_w
from	prescr_procedimento
where	nr_prescricao	= nr_prescricao_p
and	coalesce(nr_seq_origem::text, '') = ''
and	(nr_seq_exame IS NOT NULL AND nr_seq_exame::text <> '')
and 	((Obter_se_exibe_proced(nr_prescricao,nr_sequencia,ie_tipo_proced,'O') = 'S') or (Obter_se_exibe_proced(nr_prescricao,nr_sequencia,ie_tipo_proced,'IVC') = 'S'))
and	coalesce(ie_suspenso, 'N') 	<> 'S';

if (Qt_registro_w <> 0) then
	Ds_result_w	:= Ds_result_w || ' ' || wheb_mensagem_pck.get_texto(309524) || ' '|| Qt_registro_w;
end if;

open C01;
loop
fetch C01 into
	qt_registro_w,
	ie_agrupador_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	if (ie_agrupador_w = 1) then
		Qt_registro_medic_w	:= qt_registro_w;
	elsif (ie_agrupador_w = 2) then
		Qt_registro_mat_w	:= qt_registro_w;
	elsif (ie_agrupador_w = 8) then
		Qt_registro_SNE_w	:= qt_registro_w;
	elsif (ie_agrupador_w = 12) then
		Qt_registro_supl_w	:= qt_registro_w;
	end if;
	end;
end loop;
close C01;

if (Qt_registro_medic_w > 0) then
	Ds_result_w	:= Ds_result_w ||' ' || wheb_mensagem_pck.get_texto(309525) || ' '|| Qt_registro_medic_w;
end if;

if (Qt_registro_SNE_w > 0) then
	Ds_result_w	:= Ds_result_w ||' ' || wheb_mensagem_pck.get_texto(309526) || ' '|| Qt_registro_SNE_w;
end if;

if (Qt_registro_supl_w > 0) then
	Ds_result_w	:= Ds_result_w ||' ' || wheb_mensagem_pck.get_texto(309528) || ' '|| Qt_registro_supl_w;
end if;

select	count(*)
into STRICT	Qt_registro_w
from	prescr_solucao
where	nr_prescricao	= nr_prescricao_p
and	coalesce(ie_suspenso, 'N')	<> 'S'
and	coalesce(ie_hemodialise,'N')	= 'N';

if (Qt_registro_w <> 0) then
	Ds_result_w	:= Ds_result_w ||' ' || wheb_mensagem_pck.get_texto(309531) || ' '|| Qt_registro_w;
end if;

select	count(*)
into STRICT	Qt_registro_w
from	prescr_solucao
where	nr_prescricao	= nr_prescricao_p
and	coalesce(ie_suspenso, 'N')	<> 'S'
and	coalesce(ie_hemodialise,'N')	= 'S';

if (Qt_registro_w <> 0) then
	Ds_result_w	:= Ds_result_w ||' ' || wheb_mensagem_pck.get_texto(309534) || ' '|| Qt_registro_w;
end if;

select	count(*)
into STRICT	Qt_registro_w
from	prescr_solucao
where	nr_prescricao	= nr_prescricao_p
and	coalesce(ie_suspenso, 'N')	<> 'S'
and	coalesce(ie_hemodialise,'N')	= 'P';

if (Qt_registro_w <> 0) then
	Ds_result_w	:= Ds_result_w ||' ' || wheb_mensagem_pck.get_texto(309538) || ' '|| Qt_registro_w;
end if;

select	count(*)
into STRICT	Qt_registro_w
from	prescr_dieta
where	nr_prescricao	= nr_prescricao_p
and	coalesce(ie_suspenso, 'N')	<> 'S';
if (Qt_registro_w <> 0) then
	Ds_result_w	:= Ds_result_w||' ' || wheb_mensagem_pck.get_texto(309539) || ' '|| Qt_registro_w;
end if;

select	count(*)
into STRICT	Qt_registro_w
from	rep_jejum
where	nr_prescricao	= nr_prescricao_p
and	coalesce(ie_suspenso, 'N')	<> 'S';
if (Qt_registro_w <> 0) then
	Ds_result_w	:= Ds_result_w||' ' || wheb_mensagem_pck.get_texto(309541) || ' '|| Qt_registro_w;
end if;

select	count(*)
into STRICT	Qt_registro_w
from	prescr_recomendacao
where	nr_prescricao	= nr_prescricao_p
and	coalesce(ie_suspenso, 'N')	<> 'S';
if (Qt_registro_w <> 0) then
	Ds_result_w	:= Ds_result_w ||' ' || wheb_mensagem_pck.get_texto(309544) || ' '|| Qt_registro_w;
end if;

Select sum(ct)
into STRICT	Qt_registro_w
from (	SELECT	count(*) ct

	from	NUT_PACIENTE
	where	nr_prescricao	= nr_prescricao_p
	and	coalesce(ie_suspenso, 'N')	<> 'S'
	
union all

	SELECT	count(*)
	from	NUT_PAC
	where	nr_prescricao	= nr_prescricao_p
	and 	coalesce(ie_npt_adulta,'N')  = 'S'
	and	coalesce(ie_suspenso, 'N')	<> 'S'
) alias6;

if (Qt_registro_w <> 0) then
	Ds_result_w	:= Ds_result_w||' ' || wheb_mensagem_pck.get_texto(309545) || ' '|| Qt_registro_w;
end if;

select	count(*)
into STRICT	Qt_registro_w
from	NUT_PAC
where	nr_prescricao	= nr_prescricao_p
and 	coalesce(ie_npt_adulta,'N') not in ('S', 'P')
and	coalesce(ie_suspenso, 'N')	<> 'S';
if (Qt_registro_w <> 0) then
	Ds_result_w	:= Ds_result_w||' ' || wheb_mensagem_pck.get_texto(309546) || ' '|| Qt_registro_w;
end if;

select	count(*)
into STRICT	Qt_registro_w
from	NUT_PAC
where	nr_prescricao	= nr_prescricao_p
and 	coalesce(ie_npt_adulta,'N') = 'P'
and	coalesce(ie_suspenso, 'N')	<> 'S';
if (Qt_registro_w <> 0) then
	Ds_result_w	:= Ds_result_w||' ' ||  wheb_mensagem_pck.get_texto(458619) || ' '|| Qt_registro_w;
end if;


select	count(*)
into STRICT	Qt_registro_w
from	prescr_solic_bco_sangue
where	nr_prescricao	= nr_prescricao_p;
if (Qt_registro_w <> 0) then
	Ds_result_w	:= Ds_result_w ||' ' || wheb_mensagem_pck.get_texto(309547) || ' '|| Qt_registro_w;
end if;

select	count(*)
into STRICT	qt_registro_w
from	prescr_leite_deriv
where	nr_prescricao = nr_prescricao_p;
if (Qt_registro_w <> 0) then
	Ds_result_w	:= Ds_result_w ||' ' || wheb_mensagem_pck.get_texto(309548) || ' '|| Qt_registro_w;
end if;

select	count(*)
into STRICT	Qt_registro_w
from	prescr_gasoterapia
where	nr_prescricao	= nr_prescricao_p
and	coalesce(ie_suspenso, 'N')	<> 'S';
if (Qt_registro_w <> 0) then
	Ds_result_w	:= Ds_result_w ||' ' || wheb_mensagem_pck.get_texto(309550) || ' '|| Qt_registro_w;
end if;


select	count(*)
into STRICT	Qt_registro_w
from	prescr_opme
where	nr_prescricao	= nr_prescricao_p
and	coalesce(ie_suspenso, 'N')	<> 'S';
if (Qt_registro_w <> 0) then
	Ds_result_w	:= Ds_result_w ||' ' || wheb_mensagem_pck.get_texto(309564) || ' '|| Qt_registro_w; -- OPME
end if;


if (Qt_registro_mat_w > 0) then
	Ds_result_w	:= Ds_result_w ||' ' || wheb_mensagem_pck.get_texto(309562) || ' '|| Qt_registro_mat_w;
end if;

if (substr(Ds_result_w,1,1) = ' ') then
	Ds_result_w	:= substr(Ds_result_w,2,length(Ds_result_w));
end if;

--Exibir todas as prescrições que não tenha nenhum item;
if (coalesce(Ds_result_w::text, '') = '') then
	SELECT	sum(qt_registro)
	into STRICT	qt_registro_w
	FROM (
		SELECT COUNT(*) qt_registro
		FROM   prescr_procedimento
		WHERE  nr_prescricao = nr_prescricao_p
		
UNION

		SELECT COUNT(*) qt_registro
		FROM   prescr_solucao
		WHERE  nr_prescricao = nr_prescricao_p
		
UNION

		SELECT COUNT(*) qt_registro
		FROM   prescr_dieta
		WHERE  nr_prescricao = nr_prescricao_p
		
UNION

		SELECT COUNT(*) qt_registro
		FROM   rep_jejum
		WHERE  nr_prescricao = nr_prescricao_p
		
UNION

		SELECT COUNT(*) qt_registro
		FROM   prescr_recomendacao
		WHERE  nr_prescricao = nr_prescricao_p
		
UNION

		SELECT COUNT(*) qt_registro
		FROM   NUT_PACIENTE
		WHERE  nr_prescricao = nr_prescricao_p
		
UNION

		SELECT COUNT(*) qt_registro
		FROM   NUT_PAC
		WHERE  nr_prescricao = nr_prescricao_p
		
UNION

		SELECT COUNT(*) qt_registro
		FROM   prescr_solic_bco_sangue
		WHERE  nr_prescricao = nr_prescricao_p
		
UNION

		SELECT COUNT(*) qt_registro
		FROM   prescr_leite_deriv
		WHERE  nr_prescricao = nr_prescricao_p
		
UNION

		SELECT COUNT(*) qt_registro
		FROM   prescr_gasoterapia
		WHERE  nr_prescricao = nr_prescricao_p
		
UNION

		SELECT COUNT(*) qt_registro
		FROM   prescr_opme
		WHERE  nr_prescricao = nr_prescricao_p
		
UNION

		SELECT COUNT(*) qt_registro
		FROM   prescr_material
		WHERE  nr_prescricao = nr_prescricao_p) alias15;
	if (qt_registro_w = 0) then
		Ds_result_w	:= ' ' || wheb_mensagem_pck.get_texto(309567) || ' '|| qt_registro_w; -- Nenhum
	end if;
end if;

return Ds_result_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_itens_prescr_farm (nr_prescricao_p bigint) FROM PUBLIC;

