-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_se_permite_commitar_os ( nr_sequencia_p man_ordem_servico.nr_sequencia%type, ds_version_p phi_so_market_anomaly.ds_version%type ) RETURNS varchar AS $body$
DECLARE


ie_market_anomaly_w	man_ordem_servico.ie_market_anomaly%type;
ds_version_w		phi_so_market_anomaly.ds_version%type;
ie_defeito_w		phi_so_market_anomaly.ie_receive_version_pass%type;
ds_retorno_w		phi_so_market_anomaly.ie_receive_version_pass%type;


BEGIN
	ds_version_w := ds_version_p;
	ds_retorno_w := 'S';

	select 	max(CASE WHEN ie_classificacao='E' THEN  'S'  ELSE 'N' END ), max(coalesce(ie_market_anomaly, 'N'))
	into STRICT 	ie_defeito_w, ie_market_anomaly_w
	from 	man_ordem_servico
	where 	nr_sequencia = nr_sequencia_p;

	if (ie_defeito_w = 'S' and ie_market_anomaly_w = 'S') then
		if (length(ds_version_w) > 10) then
			ds_version_w := substr(ds_version_w,1,9);
		end if;

		select 	CASE WHEN count(1)=0 THEN  'N'  ELSE 'S' END
		into STRICT	ds_retorno_w
		from	phi_so_market_anomaly
		where	nr_seq_service_order = nr_sequencia_p
		and 	ds_version = ds_version_w;
	end if;

return ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_se_permite_commitar_os ( nr_sequencia_p man_ordem_servico.nr_sequencia%type, ds_version_p phi_so_market_anomaly.ds_version%type ) FROM PUBLIC;

