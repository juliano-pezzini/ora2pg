-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_se_reverte_alta (nr_prescricao_p prescr_medica.nr_prescricao%type, nr_seq_item_p bigint, nr_seq_horario_p bigint, ie_agrupador_p bigint, nr_seq_solic_sangue_p bigint default null, ie_npt_adulta_p nut_pac.ie_npt_adulta%type default null) RETURNS varchar AS $body$
DECLARE


ie_retorno_w			varchar(1);
nr_seq_max_reversao_w	bigint;
nr_seq_max_alta_w		bigint;
qt_suspenso_alta_w		integer;
ie_tipo_solucao_w		prescr_solucao_evento.ie_tipo_solucao%type;
							

BEGIN
ie_retorno_w		:= 'N';
qt_suspenso_alta_w	:= 0;
ie_tipo_solucao_w	:= 0;

if (nr_prescricao_p IS NOT NULL AND nr_prescricao_p::text <> '') then
	if (ie_agrupador_p	= 8) then
		ie_tipo_solucao_w	:= 2;
	elsif (nr_seq_solic_sangue_p IS NOT NULL AND nr_seq_solic_sangue_p::text <> '') then
		ie_tipo_solucao_w	:= 3;
	elsif (ie_npt_adulta_p = 'P') then
		ie_tipo_solucao_w	:= 7;
	elsif (ie_npt_adulta_p = 'N') then
		ie_tipo_solucao_w	:= 5;
	elsif (ie_npt_adulta_p IS NOT NULL AND ie_npt_adulta_p::text <> '') then
		ie_tipo_solucao_w	:= 4;
	end if;
	
	if (ie_tipo_solucao_w > 0) then
		if (ie_tipo_solucao_w = 2) then
			select	coalesce(sum(CASE WHEN a.ie_alteracao=38 THEN 1  ELSE -1 END ),0)
			into STRICT	qt_suspenso_alta_w
			from	prescr_solucao_evento	a
			where	a.nr_prescricao		= nr_prescricao_p
			and		a.nr_seq_material	= nr_seq_item_p
			and		a.ie_tipo_solucao	= ie_tipo_solucao_w
			and		a.ie_alteracao		in (38,51);
		elsif (ie_tipo_solucao_w = 3) then
			select	coalesce(sum(CASE WHEN a.ie_alteracao=38 THEN 1  ELSE -1 END ),0)
			into STRICT	qt_suspenso_alta_w
			from	prescr_solucao_evento	a
			where	a.nr_prescricao			= nr_prescricao_p
			and		a.nr_seq_procedimento	= nr_seq_item_p
			and		a.ie_tipo_solucao		= ie_tipo_solucao_w
			and		a.ie_alteracao		in (38,51);
		elsif (ie_tipo_solucao_w in (4,5,7)) then
			select	coalesce(sum(CASE WHEN a.ie_alteracao=38 THEN 1  ELSE -1 END ),0)
			into STRICT	qt_suspenso_alta_w
			from	prescr_solucao_evento	a
			where	a.nr_prescricao			= nr_prescricao_p
			and		a.nr_seq_nut_neo		= nr_seq_item_p
			and		a.ie_tipo_solucao		= ie_tipo_solucao_w
			and		a.ie_alteracao		in (38,51);
		end if;
	else
		if (ie_agrupador_p IS NOT NULL AND ie_agrupador_p::text <> '') then
			select	coalesce(sum(CASE WHEN a.ie_alteracao=24 THEN 1  ELSE -1 END ),0)
			into STRICT	qt_suspenso_alta_w
			from	prescr_mat_alteracao	a
			where	a.nr_prescricao		= nr_prescricao_p
			and		a.nr_seq_horario	= nr_seq_horario_p
			and		a.ie_alteracao		in (24,25);
		else
			select	coalesce(sum(CASE WHEN a.ie_alteracao=24 THEN 1  ELSE -1 END ),0)
			into STRICT	qt_suspenso_alta_w
			from	prescr_mat_alteracao	a
			where	a.nr_prescricao			= nr_prescricao_p
			and		a.nr_seq_procedimento	= nr_seq_item_p
			and		a.nr_seq_horario_proc	= nr_seq_horario_p
			and		a.ie_alteracao		in (24,25);
		end if;
	end if;
end if;

if (qt_suspenso_alta_w > 0) then --Se sobrar uma suspensão por alta então o item pode ser revertido
	ie_retorno_w	:= 'S';
end if;

return	ie_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_se_reverte_alta (nr_prescricao_p prescr_medica.nr_prescricao%type, nr_seq_item_p bigint, nr_seq_horario_p bigint, ie_agrupador_p bigint, nr_seq_solic_sangue_p bigint default null, ie_npt_adulta_p nut_pac.ie_npt_adulta%type default null) FROM PUBLIC;

