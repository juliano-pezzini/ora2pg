-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION gpt_obter_itens_incons (nr_atendimento_p bigint, cd_pessoa_fisica_p text, nr_prescricao_p bigint, ie_lib_farm_p text default null, nm_usuario_p text DEFAULT NULL) RETURNS varchar AS $body$
DECLARE


ds_retorno_w			varchar(1);
	
c01 CURSOR FOR
	SELECT	a.nr_prescricao
	from	prescr_medica a
	where	a.nr_prescricao			=	coalesce(nr_prescricao_p,a.nr_prescricao)
	and		a.nr_atendimento 		= 	nr_atendimento_p
	and		a.cd_pessoa_fisica 		= 	cd_pessoa_fisica_p
	and 	((coalesce(ie_lib_farm_p,'S') = 'N') or (coalesce(ie_lib_farm,'N') = 'S'))
	and		(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
	and 	coalesce(a.dt_liberacao_farmacia::text, '') = ''
	and		(a.dt_inicio_analise_farm IS NOT NULL AND a.dt_inicio_analise_farm::text <> '')
	and		a.nm_usuario_analise_farm   = nm_usuario_p
	
union

	SELECT	a.nr_prescricao
	from	prescr_medica a
	where	a.nr_prescricao			=	coalesce(nr_prescricao_p,a.nr_prescricao)
	and		coalesce(a.nr_atendimento::text, '') = ''
	and 	a.cd_pessoa_fisica = cd_pessoa_fisica_p
	and 	((coalesce(ie_lib_farm_p,'S') = 'N') or (coalesce(ie_lib_farm,'N') = 'S'))
	and		(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
	and 	coalesce(a.dt_liberacao_farmacia::text, '') = ''
	and		(a.dt_inicio_analise_farm IS NOT NULL AND a.dt_inicio_analise_farm::text <> '')
	and		a.nm_usuario_analise_farm    = nm_usuario_p;

BEGIN

ds_retorno_w := 'N';

for c01_w in c01
	loop
	
	select 	coalesce(max('S'),'N')
	into STRICT	ds_retorno_w
	from	prescr_gasoterapia a
	where	a.nr_prescricao			= c01_w.nr_prescricao
	and		coalesce(a.ie_suspenso, 'N') <> 'S'
	and		(a.nr_seq_inconsistencia IS NOT NULL AND a.nr_seq_inconsistencia::text <> '');

	if (ds_retorno_w = 'S') then
		return ds_retorno_w;
	end if;	
		
	end loop;

select	coalesce(max('S'),'N')
into STRICT	ds_retorno_w
from	prescr_medica a,
		prescr_material b
where	a.nr_prescricao = b.nr_prescricao
and 	((coalesce(ie_lib_farm_p,'S') = 'N') or (coalesce(ie_lib_farm,'N') = 'S'))
and		(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
and 	coalesce(a.dt_liberacao_farmacia::text, '') = ''
and		b.ie_agrupador in (1,4,5)
and		coalesce(b.ie_suspenso,'N') 		= 'N'
and		a.dt_suspensao IS  NULL
and		(a.dt_inicio_analise_farm IS NOT NULL AND a.dt_inicio_analise_farm::text <> '')
and		a.nm_usuario_analise_farm   = nm_usuario_p
and		(((b.ie_agrupador in (1,5)) and (gpt_obter_se_incons_item(b.nr_seq_mat_cpoe,'CPOE_MATERIAL') = 'S')) or
		  ((b.ie_agrupador = 4) and (gpt_obter_se_incons_item(b.nr_seq_mat_cpoe,'SOLUCAO') = 'S')))
and		a.nr_prescricao				=	coalesce(nr_prescricao_p,a.nr_prescricao)
and		a.nr_atendimento 			= 	nr_atendimento_p
and		a.cd_pessoa_fisica 			= 	cd_pessoa_fisica_p;

if (ds_retorno_w = 'N') then

    select	coalesce(max('S'),'N')
	into STRICT	ds_retorno_w
	from	prescr_medica a,
			prescr_material b
	where	a.nr_prescricao 	= b.nr_prescricao
	and		a.nr_prescricao		=	coalesce(nr_prescricao_p,a.nr_prescricao)
	and		coalesce(a.nr_atendimento::text, '') = ''
	and		b.ie_agrupador in (1,4,5)
	and		coalesce(b.ie_suspenso,'N') 		= 'N'
	and		a.dt_suspensao IS  NULL
	and		(((b.ie_agrupador in (1,5)) and (gpt_obter_se_incons_item(b.nr_seq_mat_cpoe,'CPOE_MATERIAL') = 'S')) or
			  ((b.ie_agrupador = 4) and (gpt_obter_se_incons_item(b.nr_seq_mat_cpoe,'SOLUCAO') = 'S')))
	and 	a.cd_pessoa_fisica = cd_pessoa_fisica_p
	and 	((coalesce(ie_lib_farm_p,'S') = 'N') or (coalesce(ie_lib_farm,'N') = 'S'))
	and		(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
	and 	coalesce(a.dt_liberacao_farmacia::text, '') = ''
	and		(a.dt_inicio_analise_farm IS NOT NULL AND a.dt_inicio_analise_farm::text <> '')
	and		a.nm_usuario_analise_farm    = nm_usuario_p;
	
end if;

return coalesce(ds_retorno_w,'N');

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION gpt_obter_itens_incons (nr_atendimento_p bigint, cd_pessoa_fisica_p text, nr_prescricao_p bigint, ie_lib_farm_p text default null, nm_usuario_p text DEFAULT NULL) FROM PUBLIC;

