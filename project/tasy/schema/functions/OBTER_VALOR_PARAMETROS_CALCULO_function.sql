-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_valor_parametros_calculo ( nm_tabela_p text, nm_atributo_p text, tp_resultado_p text, nr_atendimento_p bigint, ie_tempo_busca text, nr_tempo_busca bigint, ds_data_pesquisa_p text, cd_pessoa_fisica_p text, cd_chave_p bigint) RETURNS bigint AS $body$
DECLARE


vl_resultado_w		numeric(20);
dt_date_interval_w	varchar(300);
ds_identifier_w		varchar(50);
ds_sql				varchar(1000);


BEGIN

if ((nr_atendimento_p IS NOT NULL AND nr_atendimento_p::text <> '') or (cd_pessoa_fisica_p IS NOT NULL AND cd_pessoa_fisica_p::text <> '')) then

	if (cd_chave_p = 1) then
		ds_identifier_w := ' and nr_atendimento = ' || nr_atendimento_p || ' ';

	elsif (cd_chave_p = 2) then
		ds_identifier_w := ' and cd_pessoa_fisica = ' || cd_pessoa_fisica_p || ' ';

	end if;

	if ((ie_tempo_busca IS NOT NULL AND ie_tempo_busca::text <> '') and (nr_tempo_busca IS NOT NULL AND nr_tempo_busca::text <> '') and (ds_data_pesquisa_p IS NOT NULL AND ds_data_pesquisa_p::text <> '')) then

		if (ie_tempo_busca = 'D') then
			dt_date_interval_w := ' and ' || ds_data_pesquisa_p || ' <= ESTABLISHMENT_TIMEZONE_UTILS.endOfDay(ESTABLISHMENT_TIMEZONE_UTILS.getCurrentDate)
				and	' || ds_data_pesquisa_p || ' >= ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(ESTABLISHMENT_TIMEZONE_UTILS.getCurrentDate) - ' || nr_tempo_busca || ' ';

		elsif (ie_tempo_busca = 'H') then
			dt_date_interval_w := ' and	' || ds_data_pesquisa_p || ' <= ESTABLISHMENT_TIMEZONE_UTILS.getCurrentDate
				and	' || ds_data_pesquisa_p || ' >= ESTABLISHMENT_TIMEZONE_UTILS.getCurrentDate - ' || nr_tempo_busca || '/24 ';

		elsif (ie_tempo_busca = 'M') then
			dt_date_interval_w := ' and	' || ds_data_pesquisa_p || ' <= ESTABLISHMENT_TIMEZONE_UTILS.getCurrentDate
				and	' || ds_data_pesquisa_p || ' >= ESTABLISHMENT_TIMEZONE_UTILS.getCurrentDate - ' || nr_tempo_busca || '/1440 ';

		end if;

	end if;

	if (upper(tp_resultado_p) = 'MAIOR') then
		ds_sql := ' select max(' || nm_atributo_p || ') from (select ' || nm_atributo_p || ' from ' || nm_tabela_p || ' where 1=1 ' || ds_identifier_w || dt_date_interval_w || ')';

	elsif (upper(tp_resultado_p) = 'MENOR') then
		ds_sql := ' select min(' || nm_atributo_p || ') from (select ' || nm_atributo_p || ' from ' || nm_tabela_p || ' where 1=1 ' || ds_identifier_w || dt_date_interval_w || ')';

	elsif (upper(tp_resultado_p) = 'ULTIMO') then
		ds_sql := ' select ' || nm_atributo_p || ' from (select ' || nm_atributo_p || ' from ' || nm_tabela_p || ' where 1=1 ' || ds_identifier_w || dt_date_interval_w || ' order by ' ||
					ds_data_pesquisa_p || ' desc, nr_sequencia desc) where rownum = 1';

	elsif (upper(tp_resultado_p) = 'PRIMEIRO') then
		ds_sql := ' select ' || nm_atributo_p || ' from (select ' || nm_atributo_p || ' from ' || nm_tabela_p || ' where 1=1 ' || ds_identifier_w || dt_date_interval_w || ' order by ' ||
					ds_data_pesquisa_p || ' asc, nr_sequencia asc) where rownum = 1';

	elsif (upper(tp_resultado_p) = 'PENULTIMO') then
		ds_sql := ' select ' || nm_atributo_p || ' from (select ' || nm_atributo_p || ', rownum RN from (select ' || nm_atributo_p || ' from ' || nm_tabela_p || ' where 1=1 ' || ds_identifier_w ||
					dt_date_interval_w || ' order by ' || ds_data_pesquisa_p || ' desc, nr_sequencia desc) where rownum <= 2) where RN = 2';

	end if;

	EXECUTE
		ds_sql
	into STRICT
		vl_resultado_w;


else
	vl_resultado_w := 0;
end if;

return	vl_resultado_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_valor_parametros_calculo ( nm_tabela_p text, nm_atributo_p text, tp_resultado_p text, nr_atendimento_p bigint, ie_tempo_busca text, nr_tempo_busca bigint, ds_data_pesquisa_p text, cd_pessoa_fisica_p text, cd_chave_p bigint) FROM PUBLIC;

