-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION sus_obter_nr_ordem_laudo_arq ( nr_ordem_laudo_p bigint) RETURNS varchar AS $body$
DECLARE

 
ds_retorno_w		varchar(255);					
					 

BEGIN 
 
begin 
select	max(substr(to_char(a.dt_emissao,'yyyy')||c.cd_prestador_laudo_ach|| 
	adiciona_zeros_esquerda(to_char(coalesce(a.nr_ordem_laudo,a.nr_laudo_sus)),6)|| 
	calcula_Digito('MODULO11',to_char(a.dt_emissao,'yyyy')||c.cd_prestador_laudo_ach|| 
	adiciona_zeros_esquerda(to_char(coalesce(a.nr_ordem_laudo,a.nr_laudo_sus)),6)),1,13)) 
into STRICT	ds_retorno_w 
from	sus_laudo_paciente a, 
	sus_lote_autor b, 
	sus_parametros_aih c 
where	a.nr_seq_lote = b.nr_sequencia 
and	b.cd_estabelecimento = c.cd_estabelecimento 
and	a.nr_ordem_laudo = nr_ordem_laudo_p 
and	a.ie_classificacao = 1 
and	a.ie_tipo_laudo_sus = 0;
exception 
when others then 
	ds_retorno_w := '';
end;
 
if (ds_retorno_w = '') then 
	begin 
	 
	begin 
	select	max(substr(to_char(a.dt_emissao,'yyyy')||c.cd_prestador_laudo_ach|| 
		adiciona_zeros_esquerda(to_char(coalesce(a.nr_ordem_laudo,a.nr_laudo_sus)),6)|| 
		calcula_Digito('MODULO11',to_char(a.dt_emissao,'yyyy')||c.cd_prestador_laudo_ach|| 
		adiciona_zeros_esquerda(to_char(coalesce(a.nr_ordem_laudo,a.nr_laudo_sus)),6)),1,13)) 
	into STRICT	ds_retorno_w 
	from	sus_laudo_paciente a, 
		sus_lote_autor b, 
		sus_parametros_aih c 
	where	a.nr_seq_lote = b.nr_sequencia 
	and	b.cd_estabelecimento = c.cd_estabelecimento 
	and	a.nr_ordem_laudo = nr_ordem_laudo_p 
	and	a.ie_classificacao = 1 
	and	a.ie_tipo_laudo_sus = 1;
	exception 
	when others then 
		ds_retorno_w := '';
	end;
	 
	if (ds_retorno_w = '') then 
		begin 
		 
		begin 
		select	max(substr(to_char(a.dt_emissao,'yyyy')||c.cd_prestador_laudo_ach|| 
			adiciona_zeros_esquerda(to_char(coalesce(a.nr_ordem_laudo,a.nr_laudo_sus)),6)|| 
			calcula_Digito('MODULO11',to_char(a.dt_emissao,'yyyy')||c.cd_prestador_laudo_ach|| 
			adiciona_zeros_esquerda(to_char(coalesce(a.nr_ordem_laudo,a.nr_laudo_sus)),6)),1,13)) 
		into STRICT	ds_retorno_w 
		from	sus_laudo_paciente a, 
			sus_lote_autor b, 
			sus_parametros_aih c 
		where	a.nr_seq_lote = b.nr_sequencia 
		and	b.cd_estabelecimento = c.cd_estabelecimento 
		and	a.nr_ordem_laudo = nr_ordem_laudo_p 
		and	a.ie_classificacao = 1 
		and	a.ie_tipo_laudo_sus = 2;
		exception 
		when others then 
			ds_retorno_w := '';
		end;
		 
		end;
	end if;
	end;
end if;
 
return	ds_retorno_w;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION sus_obter_nr_ordem_laudo_arq ( nr_ordem_laudo_p bigint) FROM PUBLIC;

