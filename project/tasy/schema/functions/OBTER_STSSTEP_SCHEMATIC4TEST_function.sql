-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_stsstep_schematic4test (NR_SEQ_SCRIPT_P bigint, NR_SEQ_EXECUTION_P bigint) RETURNS bigint AS $body$
DECLARE

STATUS_W	varchar(255);
NR_SEQ_ACTION_W bigint;

BEGIN
	--function that return status step with fail or succeful
	IF (NR_SEQ_SCRIPT_P IS NOT NULL AND NR_SEQ_SCRIPT_P::text <> '') THEN
        SELECT NR_SEQ_ACTION
            INTO STRICT NR_SEQ_ACTION_W
        FROM SCHEM_TEST_LOG
        WHERE NR_SEQ_SCRIPT = NR_SEQ_SCRIPT_P
        AND DS_ACTION_EXEC NOT LIKE 'none' AND IE_STATUS = '2' AND coalesce(IE_MANUAL::text, '') = ''
        AND NR_SEQUENCIA = (SELECT DISTINCT max(NR_SEQUENCIA) FROM SCHEM_TEST_LOG WHERE NR_SEQ_SCRIPT = NR_SEQ_SCRIPT_P
        AND DS_ACTION_EXEC NOT LIKE 'none' AND IE_STATUS = '2' AND coalesce(IE_MANUAL::text, '') = '')
        AND NR_SEQ_SCHEDULE = (SELECT DISTINCT max(NR_SEQ_SCHEDULE) FROM SCHEM_TEST_LOG WHERE NR_SEQ_SCRIPT = NR_SEQ_SCRIPT_P
        AND DS_ACTION_EXEC NOT LIKE 'none' AND IE_STATUS = '2' AND coalesce(IE_MANUAL::text, '') = '');

        IF (NR_SEQ_ACTION_W IS NOT NULL AND NR_SEQ_ACTION_W::text <> '') THEN
          IF (NR_SEQ_ACTION_W > NR_SEQ_EXECUTION_P) THEN
            STATUS_W := '4';
          ELSE
            IF (NR_SEQ_ACTION_W = NR_SEQ_EXECUTION_P) THEN
              STATUS_W := '2';
            ELSE
              IF (NR_SEQ_ACTION_W < NR_SEQ_EXECUTION_P) or (coalesce(NR_SEQ_ACTION_W::text, '') = '')  THEN
                  STATUS_W := '1';
              END IF;
            END IF;
          END IF;
          ELSE
            STATUS_W := '0';
        END IF;
END IF;

RETURN STATUS_W;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_stsstep_schematic4test (NR_SEQ_SCRIPT_P bigint, NR_SEQ_EXECUTION_P bigint) FROM PUBLIC;

