-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_bloqueio_multiplo_ditado (ds_nr_seq_interno_lista_p text, ie_opcao_p text) RETURNS varchar AS $body$
DECLARE




ie_retorno_w			varchar(4000);

nr_seq_interno_w    numeric(20);

ds_possib_w			varchar(6000);

qt_controle_w			bigint;

qt_pos_separador_w		bigint;

ds_possib_aux_w			varchar(6000);



ie_controle_digitacao_w varchar(4000);

ie_controle_ditado_w varchar(4000);

ie_controle_status_w varchar(4000);




BEGIN



ds_possib_w := ds_nr_seq_interno_lista_p;



if (position('(' in ds_possib_w) > 0 ) and (position(')' in ds_possib_w) > 0 ) then

	ds_possib_w		:= substr(ds_nr_seq_interno_lista_p,(position('(' in ds_nr_seq_interno_lista_p)+1),(position(')' in ds_nr_seq_interno_lista_p)-2));

end if;



qt_controle_w 		:= 0;



qt_pos_separador_w 	:= position(',' in ds_possib_w);



if (qt_pos_separador_w = 0) then

  qt_pos_separador_w := -1;

end if;





while( qt_pos_separador_w >= 0 )  and ( qt_controle_w < 1000 ) loop



	ie_controle_digitacao_w := '';

	ie_controle_ditado_w := '';

	ie_controle_status_w := '';



  if (qt_pos_separador_w = 0) then

    nr_seq_interno_w := (ds_possib_w)::numeric;

    qt_pos_separador_w := -1;

  else

    nr_seq_interno_w := (substr(ds_possib_w,1,qt_pos_separador_w-1))::numeric;

  end if;





	SELECT CASE WHEN count(*)=0 THEN ''  ELSE 'DIGITACAO' END  DS

	INTO STRICT   ie_controle_digitacao_w

	FROM	prescr_procedimento prescr_proc

	WHERE prescr_proc.nr_seq_interno = nr_seq_interno_w

	and exists (SELECT 1

                from controle_digitacao_laudo cdl

                where cdl.nr_prescricao = prescr_proc.nr_prescricao

                and   cdl.nr_seq_prescr = prescr_proc.nr_sequencia);



	SELECT CASE WHEN count(*)=0 THEN ''  ELSE 'DITAR' END  DS

	INTO STRICT   ie_controle_ditado_w

	FROM	controle_ditar_laudo cdl

	WHERE cdl.nr_seq_interno = nr_seq_interno_w;



	if (ie_opcao_p = 'D') then

		SELECT CASE WHEN count(*)=0 THEN ''  ELSE 'STATUS' END  DS

		INTO STRICT   ie_controle_status_w

		FROM	prescr_procedimento prescr_proc

		WHERE nr_seq_interno = nr_seq_interno_w

		and   ie_status_execucao <> '20';

	end if;



	if (ie_opcao_p = 'A') then

		SELECT CASE WHEN count(*)=0 THEN ''  ELSE 'STATUS' END  DS

		INTO STRICT   ie_controle_status_w

		FROM	prescr_procedimento prescr_proc

		WHERE nr_seq_interno = nr_seq_interno_w

		and (ie_status_execucao <> '30' AND ie_status_execucao <> '35');

	end if;



	if (ie_controle_digitacao_w IS NOT NULL AND ie_controle_digitacao_w::text <> '') then

		ie_retorno_w := ie_retorno_w || ie_controle_digitacao_w ||','|| nr_seq_interno_w||';';

	end if;



	if (ie_controle_ditado_w IS NOT NULL AND ie_controle_ditado_w::text <> '') then

		ie_retorno_w := ie_retorno_w || ie_controle_ditado_w ||','|| nr_seq_interno_w||';';

	end if;



	if (ie_controle_status_w IS NOT NULL AND ie_controle_status_w::text <> '') then

		ie_retorno_w := ie_retorno_w || ie_controle_status_w ||','|| nr_seq_interno_w||';';

	end if;



  if (qt_pos_separador_w > 0 ) then

     ds_possib_w		:= substr(ds_possib_w,qt_pos_separador_w+1,length(ds_possib_w));

     qt_pos_separador_w 	:= position(',' in ds_possib_w);

  end if;



	qt_controle_w		:= qt_controle_w + 1;

end loop;

return ie_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_bloqueio_multiplo_ditado (ds_nr_seq_interno_lista_p text, ie_opcao_p text) FROM PUBLIC;

