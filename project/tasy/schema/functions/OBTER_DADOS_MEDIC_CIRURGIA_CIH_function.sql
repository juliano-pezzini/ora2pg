-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_dados_medic_cirurgia_cih (nr_seq_medic_cirurgia_p bigint, ie_opcao_p text) RETURNS varchar AS $body$
DECLARE

 
ds_retorno_w		varchar(150) := '';
nr_seq_cirurgia_w	bigint;
dt_inicio_adm_w		timestamp;
cd_medicamento_w	bigint;
unidade_medida_w	varchar(30);
qt_dose_w		double precision;
nr_atendimento_w	bigint;
dt_termino_cirurgia_w	timestamp;

/* 
D = Dose 
U = Unidade de medida 
*/
 
		 

BEGIN 
 
if (nr_seq_medic_cirurgia_p IS NOT NULL AND nr_seq_medic_cirurgia_p::text <> '') then 
 
	select	a.nr_seq_cirurgia_pac, 
		b.dt_atendimento, 
		b.cd_medicamento, 
		cih_obter_dados_ficha(a.nr_ficha_ocorrencia,1) 
	into STRICT	nr_seq_cirurgia_w, 
		dt_inicio_adm_w, 
		cd_medicamento_w, 
		nr_atendimento_w 
	from	cih_cirurgia a, 
		cih_cirurgia_medic b 
	where	a.nr_seq_cirurgia 	= b.nr_seq_cirurgia 
	and	a.nr_ficha_ocorrencia 	= b.nr_ficha_ocorrencia 
	and	b.nr_sequencia 		= nr_seq_medic_cirurgia_p;
 
	/*select	to_date(obter_dados_cirurgia(nr_seq_cirurgia_w,'DT'),'dd/mm/yyyy hh24:mi:ss') 
	into	dt_termino_cirurgia_w 
	from dual;*/
 
	 
	dt_termino_cirurgia_w := to_date(obter_dados_cirurgia(nr_seq_cirurgia_w,'DT'),'dd/mm/yyyy hh24:mi:ss');
	 
	begin 
	select	max(a.cd_unid_medida_adm), 
		sum(b.qt_dose) 
	into STRICT	unidade_medida_w, 
		qt_dose_w 
	from	material c, 
		cirurgia_agente_anestesico a, 
		cirurgia_agente_anest_ocor b 
	where	b.nr_seq_cirur_agente 	= a.nr_sequencia 
	and	a.cd_material		= c.cd_material 
	and	a.nr_cirurgia		= nr_seq_cirurgia_w 
	and	c.cd_medicamento 	= cd_medicamento_w 
	and	coalesce(a.ie_situacao,'A')	= 'A'	 
	and	coalesce(b.ie_situacao,'A')	= 'A'	 
	having	min(b.dt_inicio_adm) 	= dt_inicio_adm_w;
	exception 
	when no_data_found then 
		unidade_medida_w := null;
		qt_dose_w 	 := null;
	end;
 
	if (coalesce(unidade_medida_w::text, '') = '') and (coalesce(qt_dose_w::text, '') = '') then 
		begin 
		select	max(e.cd_um_dose_adm), 
			sum(e.qt_dose_adm) 
		into STRICT	unidade_medida_w, 
			qt_dose_w 
		from	material c, 
			prescr_mat_alteracao e, 
			prescr_medica a, 
			prescr_material b, 
			setor_atendimento s 
		where 	e.nr_prescricao   	= b.nr_prescricao 
		and 	e.nr_seq_prescricao	= b.nr_sequencia	 
		and	a.nr_prescricao		= b.nr_prescricao 
		and	b.cd_material	 	= c.cd_material	 
		and	s.cd_setor_atendimento	= a.cd_setor_Atendimento 
		and 	a.nr_atendimento	= nr_atendimento_w 
		and	c.cd_medicamento 	= cd_medicamento_w 
		and	s.cd_classif_Setor	= 2 
		and	a.dt_prescricao between dt_termino_cirurgia_w and dt_termino_cirurgia_w + 1 
		and 	e.nr_sequencia = (SELECT max(y.nr_sequencia) 
					from	prescr_mat_alteracao y 
					where	y.nr_prescricao = e.nr_prescricao 
					and	y.nr_seq_prescricao = e.nr_seq_prescricao 
					and	y.ie_alteracao = 3 
					and	coalesce(to_char(y.dt_hor_acm_sn,'dd/mm/yyyy hh24:mi:ss'),substr(plt_obter_dados_hor_item(coalesce(coalesce(coalesce(coalesce(y.nr_seq_horario, y.nr_seq_horario_proc), y.nr_seq_horario_rec),y.nr_seq_horario_dieta),y.nr_seq_horario_sae),y.ie_tipo_item,'H'),1,19)) = 
						coalesce(to_char(e.dt_hor_acm_sn,'dd/mm/yyyy hh24:mi:ss'),substr(plt_obter_dados_hor_item(coalesce(coalesce(coalesce(coalesce(e.nr_seq_horario, e.nr_seq_horario_proc), e.nr_seq_horario_rec),e.nr_seq_horario_dieta),e.nr_seq_horario_sae),e.ie_tipo_item,'H'),1,19))) 
		group	by e.cd_um_dose_adm 
		having	min(e.dt_alteracao) 	= dt_inicio_adm_w;
		exception 
		when no_data_found then 
			unidade_medida_w := null;
			qt_dose_w 	 := null;
		end;
	end if;
 
	if (ie_opcao_p = 'D') then 
		ds_retorno_w := qt_dose_w;
	elsif (ie_opcao_p = 'U') then 
		ds_retorno_w := unidade_medida_w;
	end if;
	 
end if;
 
return	ds_retorno_w;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_dados_medic_cirurgia_cih (nr_seq_medic_cirurgia_p bigint, ie_opcao_p text) FROM PUBLIC;

