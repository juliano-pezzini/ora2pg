-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_fone_pac_agenda (cd_pessoa_fisica_p text) RETURNS varchar AS $body$
DECLARE


ds_celular_w		varchar(255);
ds_residencial_w	varchar(255);
ds_comercial_w	varchar(255);
ds_telefone_w		varchar(4000);
ie_utilizar_mascara_w	varchar(1);
ie_utilizar_ddi_w	varchar(1);
ie_atual_iniciais_tel_w	varchar(1);
ie_tel_celular_w	varchar(1);
ie_tel_comercial_w	varchar(1);
ie_tel_residencial_w	varchar(1);
ie_tel_fax_w		varchar(1);
ie_tel_resp_w		varchar(1);
nr_ddd_res_w		varchar(10);
nr_dd_cel_w		varchar(10);
nr_ddd_com_w		varchar(10);
nr_ddd_resp_w		varchar(10);
nr_ddd_fax_w		varchar(10);
ds_fax_resp_w		varchar(255);
ds_fax_w		varchar(255);
ds_telefone_resp_w	varchar(255);
nr_ddd_fax_pac_w	varchar(3);
ie_tel_hospedagem_w	varchar(1);
ds_hospedagem_w		varchar(15);
ie_tel_complemento_w varchar(1) := 'N';
ie_tel_complemento2_w varchar(1) := 'N';
ds_celular2_w		varchar(255);
nr_dd_cel2_w		varchar(10);


BEGIN

ie_utilizar_mascara_w := obter_param_usuario(821, 304, obter_perfil_ativo, wheb_usuario_pck.get_nm_usuario, wheb_usuario_pck.get_cd_estabelecimento, ie_utilizar_mascara_w);
ie_utilizar_ddi_w := obter_param_usuario(0, 219, obter_perfil_ativo, wheb_usuario_pck.get_nm_usuario, wheb_usuario_pck.get_cd_estabelecimento, ie_utilizar_ddi_w);

select 	coalesce(max(ie_atualizar_iniciais_tel),'S'),
	coalesce(max(ie_tel_celular),'S'),
	coalesce(max(ie_tel_comercial),'S'),
	coalesce(max(ie_tel_residencial),'S'),
	coalesce(max(ie_tel_fax),'N'),
	coalesce(max(ie_tel_resp),'N'),
	coalesce(max(ie_tel_hospedagem),'N')
into STRICT	ie_atual_iniciais_tel_w,
	ie_tel_celular_w,
	ie_tel_comercial_w,
	ie_tel_residencial_w,
	ie_tel_fax_w,
	ie_tel_resp_w,
	ie_tel_hospedagem_w
from	parametro_agenda
where 	cd_estabelecimento = obter_estabelecimento_ativo;


if (coalesce(ie_utilizar_ddi_w,'N') = 'S') then

	if (cd_pessoa_fisica_p IS NOT NULL AND cd_pessoa_fisica_p::text <> '') then
		
		select	substr(obter_nr_cel_int(max(p.nr_ddi_celular), max(p.nr_telefone_celular)),1,255)
		into STRICT	ds_celular_w
		from	compl_pessoa_fisica p
		where	p.cd_pessoa_fisica = cd_pessoa_fisica_p
		and		p.ie_tipo_complemento = 1;
		
		
		select	CASE WHEN ie_tel_celular_w='C' THEN  coalesce(ds_celular_w ,obter_telefone_pf_html5(cd_pessoa_fisica_p,0))  WHEN ie_tel_celular_w='S' THEN  obter_telefone_pf_html5(cd_pessoa_fisica_p,0) WHEN ie_tel_celular_w='F' THEN obter_telefone_pf_html5(cd_pessoa_fisica_p,0)  ELSE '' END  ,
			CASE WHEN ie_tel_celular_w='F' THEN  coalesce(ds_celular_w,'')  ELSE '' END  ,
			obter_telefone_pf_html5(cd_pessoa_fisica_p,4),
			obter_telefone_pf_html5(cd_pessoa_fisica_p,5)
		into STRICT	ds_celular_w,
			ds_celular2_w,
			ds_residencial_w,
			ds_comercial_w
		;

		if (coalesce(ds_celular_w::text, '') = '' and (ds_celular2_w IS NOT NULL AND ds_celular2_w::text <> '')) then
			ds_celular_w := ds_celular2_w;
			ds_celular2_w := null;
		end if;

		if (ie_tel_fax_w = 'S') then
			ds_fax_w := obter_telefone_pf_html5(cd_pessoa_fisica_p,11);
		end if;
		
		if (ie_tel_resp_w = 'S') then
			ds_telefone_resp_w	:= obter_compl_pf(cd_pessoa_fisica_p,3,'TDDI');
			ds_fax_resp_w		:= obter_compl_pf(cd_pessoa_fisica_p,3,'DDIFAX');
		end if;	
		
		if (ie_tel_hospedagem_w = 'S') then			
			ds_hospedagem_w := obter_telefone_pf_html5(cd_pessoa_fisica_p,8);
		end if;
		
		if (ie_atual_iniciais_tel_w = 'S') then
			
			if (ds_celular_w IS NOT NULL AND ds_celular_w::text <> '') and ( ie_tel_celular_w 	<> 'N') then
				if (ds_celular2_w IS NOT NULL AND ds_celular2_w::text <> '') and (ie_tel_celular_w = 'F') then
					ds_telefone_w := ds_telefone_w || 'M1: '|| ds_celular_w || ' M2: ' || ds_celular2_w || ' ';
				else	
					ds_telefone_w := ds_telefone_w || 'M: '|| ds_celular_w || ' ';
				end if;	
			end if;
			
			if (ds_residencial_w IS NOT NULL AND ds_residencial_w::text <> '') and (ie_tel_residencial_w	= 'S') then
				ds_telefone_w := ds_telefone_w || 'R: ' || ds_residencial_w || ' ';
			end if;
			
			if (ds_comercial_w IS NOT NULL AND ds_comercial_w::text <> '') and (ie_tel_comercial_w	= 'S') then
				ds_telefone_w := ds_telefone_w || 'C: ' || ds_comercial_w || ' ';
			end if;
			
			if (ds_fax_w IS NOT NULL AND ds_fax_w::text <> '') and (ie_tel_fax_w = 'S') then
				ds_telefone_w := ds_telefone_w || 'F: ' || ds_fax_w || ' ';	
			end if;
			
			if (ds_telefone_resp_w IS NOT NULL AND ds_telefone_resp_w::text <> '') and (ie_tel_resp_w = 'S') then
				ds_telefone_w := ds_telefone_w || 'RP: ' || ds_telefone_resp_w || ' ' || ds_fax_resp_w;	
			end if;
			
			if (ds_hospedagem_w IS NOT NULL AND ds_hospedagem_w::text <> '') and (ie_tel_hospedagem_w = 'S') then
				ds_telefone_w := ds_telefone_w || 'H: ' || ds_hospedagem_w;	
			end if;
			
			ds_telefone_w	:= substr(ds_telefone_w,1,80);
			
		else
			if (ds_celular_w IS NOT NULL AND ds_celular_w::text <> '') and (ie_tel_celular_w 	<> 'N') then
				if (ds_celular2_w IS NOT NULL AND ds_celular2_w::text <> '') and (ie_tel_celular_w = 'F') then
					ds_telefone_w := ds_telefone_w || ' ' || ds_celular_w || ' ' || ds_celular2_w || ' ';
				else	
					ds_telefone_w := ds_telefone_w || ' ' || ds_celular_w || ' ';
				end if;
			end if;
			if (ds_residencial_w IS NOT NULL AND ds_residencial_w::text <> '') and (ie_tel_residencial_w	= 'S') then
				ds_telefone_w := ds_telefone_w || ' ' || ds_residencial_w || ' ';
			end if;
			if (ds_comercial_w IS NOT NULL AND ds_comercial_w::text <> '') and (ie_tel_comercial_w	= 'S') then
				ds_telefone_w := ds_telefone_w || ' ' || ds_comercial_w || ' ';
			end if;
			if (ds_fax_w IS NOT NULL AND ds_fax_w::text <> '') and (ie_tel_fax_w = 'S') then
				ds_telefone_w := ds_telefone_w || ' ' || ds_fax_w || ' ';	
			end if;
			if (ds_telefone_resp_w IS NOT NULL AND ds_telefone_resp_w::text <> '') and (ie_tel_resp_w = 'S') then
				ds_telefone_w := ds_telefone_w || ' ' || ds_telefone_resp_w || ' ' || ds_fax_resp_w;	
			end if;
			if (ds_hospedagem_w IS NOT NULL AND ds_hospedagem_w::text <> '') and (ie_tel_hospedagem_w = 'S') then
				ds_telefone_w := ds_telefone_w || ' ' || ds_hospedagem_w || ' ';	
			end if;
			
			ds_telefone_w	:= substr(ds_telefone_w,2,80);
		
		end if;
	end if;

else

	if (cd_pessoa_fisica_p IS NOT NULL AND cd_pessoa_fisica_p::text <> '') then
		select	obter_telefone_pf(cd_pessoa_fisica_p,4),
				obter_telefone_pf(cd_pessoa_fisica_p,5)
		into STRICT	ds_residencial_w,
				ds_comercial_w
		;
		
		if (ie_tel_fax_w = 'S') then
			
			if (ie_utilizar_mascara_w = 'S') then
			
				select	max(p.ds_fax),
						max(p.nr_ddd_fax)
				into STRICT	ds_fax_w,
						nr_ddd_fax_pac_w
				from	compl_pessoa_fisica p
				where	p.cd_pessoa_fisica 		= cd_pessoa_fisica_p
				and		p.ie_tipo_complemento 	= 1;
				
				ds_fax_w := '('||nr_ddd_fax_pac_w||') '||''||agenda_obter_tel_masc(ds_fax_w,wheb_usuario_pck.get_nm_usuario,wheb_usuario_pck.get_cd_estabelecimento);
			else
				ds_fax_w := obter_telefone_pf(cd_pessoa_fisica_p,11);
			end if;
			
		end if;
		
		if (ie_tel_resp_w = 'S') then
		
			nr_ddd_resp_w		:= '('||obter_compl_pf(cd_pessoa_fisica_p,3,'DDT')||')';	
			
			ds_telefone_resp_w	:= obter_compl_pf(cd_pessoa_fisica_p,3,'T');
		
			nr_ddd_fax_w		:= '('||obter_compl_pf(cd_pessoa_fisica_p,3,'DDF')||')';
		
			ds_fax_resp_w		:= obter_compl_pf(cd_pessoa_fisica_p,3,'FAX');
					
			if (ie_utilizar_mascara_w = 'S') then
				
				if (ds_telefone_resp_w IS NOT NULL AND ds_telefone_resp_w::text <> '') then
					ds_telefone_resp_w := nr_ddd_resp_w||' '||agenda_obter_tel_masc(ds_telefone_resp_w,wheb_usuario_pck.get_nm_usuario,wheb_usuario_pck.get_cd_estabelecimento);
				end if;
				
				if (ds_fax_resp_w IS NOT NULL AND ds_fax_resp_w::text <> '') then
					ds_fax_resp_w := nr_ddd_fax_w||' '||agenda_obter_tel_masc(ds_fax_resp_w,wheb_usuario_pck.get_nm_usuario,wheb_usuario_pck.get_cd_estabelecimento);
				end if;
			end if;
		
		end if;	
		
		if (ie_tel_celular_w = 'C') then
			ds_celular_w := OBTER_COMPL_PF(cd_pessoa_fisica_p, 1, 'TCEL'); --tipo complemento 1
			
			if (ds_celular_w IS NOT NULL AND ds_celular_w::text <> '') then
				ie_tel_complemento_w := 'S';
			else
				ds_celular_w := obter_telefone_pf(cd_pessoa_fisica_p,0);
			end if;
			
		elsif (ie_tel_celular_w = 'S') then
			ds_celular_w := obter_telefone_pf(cd_pessoa_fisica_p,0);
		elsif (ie_tel_celular_w = 'F') then	
			ds_celular_w := obter_telefone_pf(cd_pessoa_fisica_p,0);
			ds_celular2_w := OBTER_COMPL_PF(cd_pessoa_fisica_p, 1, 'TCEL');
			
			if (coalesce(ds_celular_w::text, '') = '' and (ds_celular2_w IS NOT NULL AND ds_celular2_w::text <> '')) then
				ds_celular_w := ds_celular2_w;
				ds_celular2_w := null;
			end if;
			
			if (ds_celular2_w IS NOT NULL AND ds_celular2_w::text <> '') then
				ie_tel_complemento2_w := 'S';
			end if;
		else
			ds_celular_w := '';
		end if;
		
		if (ie_tel_complemento_w = 'S') then
			SELECT	nr_ddd_celular
			INTO STRICT	nr_dd_cel_w
			FROM (SELECT a.nr_ddd_celular
					 FROM	compl_pessoa_fisica a
					 WHERE	a.cd_pessoa_fisica = cd_pessoa_fisica_p
					 AND	a.ie_tipo_complemento = 1 --tipo complemento 1
					 ORDER	BY a.nr_sequencia DESC) alias1 LIMIT 1;
		else
			select 	max(nr_ddd_celular)
			into STRICT	nr_dd_cel_w
			from 	pessoa_fisica
			where 	cd_pessoa_fisica =  cd_pessoa_fisica_p;
		end if;

		if (ie_tel_complemento2_w = 'S') then
			SELECT	nr_ddd_celular
			INTO STRICT	nr_dd_cel2_w
			FROM (SELECT a.nr_ddd_celular
					 FROM	compl_pessoa_fisica a
					 WHERE	a.cd_pessoa_fisica = cd_pessoa_fisica_p
					 AND	a.ie_tipo_complemento = 1 --tipo complemento 1
					 ORDER	BY a.nr_sequencia DESC) alias1 LIMIT 1;
		end if;
		
		if (nr_dd_cel_w IS NOT NULL AND nr_dd_cel_w::text <> '') then
			nr_dd_cel_w	:= '('||nr_dd_cel_w||')';
		end if;

		if (nr_dd_cel2_w IS NOT NULL AND nr_dd_cel2_w::text <> '') then
			nr_dd_cel2_w	:= '('||nr_dd_cel2_w||')';
		end if;
		
		if (ie_tel_hospedagem_w = 'S') then
			select	max(p.nr_telefone)
			into STRICT	ds_hospedagem_w
			from	compl_pessoa_fisica p
			where	p.cd_pessoa_fisica = cd_pessoa_fisica_p	
			and	p.ie_tipo_complemento = 8;
		end if;
		
		
		if (ie_utilizar_mascara_w = 'S') then
			ds_residencial_w	:= obter_telefone_pf(cd_pessoa_fisica_p,1);
			ds_comercial_w		:= obter_telefone_pf(cd_pessoa_fisica_p,2);
			
			nr_ddd_res_w		:= '('||obter_compl_pf(cd_pessoa_fisica_p,1,'DDT')||')';
			nr_ddd_com_w		:= '('||obter_compl_pf(cd_pessoa_fisica_p,2,'DDT')||')';
				
			ds_residencial_w 	:= nr_ddd_res_w||' '||agenda_obter_tel_masc(ds_residencial_w,wheb_usuario_pck.get_nm_usuario,wheb_usuario_pck.get_cd_estabelecimento);
		
			ds_celular_w 	 	:= nr_dd_cel_w||' '||agenda_obter_tel_masc(ds_celular_w,wheb_usuario_pck.get_nm_usuario,wheb_usuario_pck.get_cd_estabelecimento);
			ds_celular2_w 	 	:= nr_dd_cel2_w||' '||agenda_obter_tel_masc(ds_celular2_w,wheb_usuario_pck.get_nm_usuario,wheb_usuario_pck.get_cd_estabelecimento);
		
			ds_comercial_w	 	:= nr_ddd_com_w||' '||agenda_obter_tel_masc(ds_comercial_w,wheb_usuario_pck.get_nm_usuario,wheb_usuario_pck.get_cd_estabelecimento);
			
			ds_hospedagem_w		:= agenda_obter_tel_masc(ds_hospedagem_w,wheb_usuario_pck.get_nm_usuario,wheb_usuario_pck.get_cd_estabelecimento);
		end if;
		
		if ( ie_atual_iniciais_tel_w = 'S') then
			
			if (ds_celular_w IS NOT NULL AND ds_celular_w::text <> '') and (ie_tel_celular_w 	<> 'N') then
				if (ds_celular2_w IS NOT NULL AND ds_celular2_w::text <> '') and (ie_tel_celular_w 	= 'F') then
					if (ie_utilizar_mascara_w = 'N') then
						ds_telefone_w := ds_telefone_w || 'M1: '||nr_dd_cel_w|| ds_celular_w || ' ';
						ds_telefone_w := ds_telefone_w || 'M2: '||nr_dd_cel2_w|| ds_celular2_w || ' ';
					else
						ds_telefone_w := ds_telefone_w || 'M1: '|| ds_celular_w || ' ';
						ds_telefone_w := ds_telefone_w || 'M2: '|| ds_celular2_w || ' ';
					end if;				
				else
					if (ie_utilizar_mascara_w = 'N') then
						ds_telefone_w := ds_telefone_w || 'M: '||nr_dd_cel_w|| ds_celular_w || ' ';
					else
						ds_telefone_w := ds_telefone_w || 'M: '|| ds_celular_w || ' ';
					end if;
				end if;
			end if;
			
			if (ds_residencial_w IS NOT NULL AND ds_residencial_w::text <> '') and (ie_tel_residencial_w	= 'S') then
				ds_telefone_w := ds_telefone_w || 'R: ' || ds_residencial_w || ' ';
			end if;
			
			if (ds_comercial_w IS NOT NULL AND ds_comercial_w::text <> '') and (ie_tel_comercial_w	= 'S') then
				ds_telefone_w := ds_telefone_w || 'C: ' || ds_comercial_w || ' ';
			end if;
			
			if (ds_fax_w IS NOT NULL AND ds_fax_w::text <> '') and (ie_tel_fax_w = 'S') then
				ds_telefone_w := ds_telefone_w || 'F: ' || ds_fax_w || ' ';	
			end if;
			
			if (ds_telefone_resp_w IS NOT NULL AND ds_telefone_resp_w::text <> '') and (ie_tel_resp_w = 'S') then
				ds_telefone_w := ds_telefone_w || 'RP: ' || ds_telefone_resp_w || ' ' || ds_fax_resp_w;	
			end if;
			
			if (ds_hospedagem_w IS NOT NULL AND ds_hospedagem_w::text <> '') and (ie_tel_hospedagem_w = 'S') then
				ds_telefone_w := ds_telefone_w || 'H: ' || ds_hospedagem_w;	
			end if;
			
			ds_telefone_w	:= substr(ds_telefone_w,1,80);
			
		else
			if (ds_celular_w IS NOT NULL AND ds_celular_w::text <> '') and (ie_tel_celular_w 	<> 'N') then
				if (ds_celular2_w IS NOT NULL AND ds_celular2_w::text <> '') and (ie_tel_celular_w 	= 'F') then
					if (ie_utilizar_mascara_w = 'N') then
						ds_telefone_w := ds_telefone_w || ' ' || nr_dd_cel_w|| ds_celular_w || ' ';
						ds_telefone_w := ds_telefone_w || ' ' || nr_dd_cel2_w|| ds_celular2_w || ' ';
					else
						ds_telefone_w := ds_telefone_w || ' ' || ds_celular_w || ' ';
						ds_telefone_w := ds_telefone_w || ' ' || ds_celular2_w || ' ';
					end if;	
				else				
					if (ie_utilizar_mascara_w = 'N') then
						ds_telefone_w := ds_telefone_w || ' ' || nr_dd_cel_w|| ds_celular_w || ' ';
					else
						ds_telefone_w := ds_telefone_w || ' ' || ds_celular_w || ' ';
					end if;
				end if;
			end if;
			if (ds_residencial_w IS NOT NULL AND ds_residencial_w::text <> '') and (ie_tel_residencial_w	= 'S') then
				ds_telefone_w := ds_telefone_w || ' ' || ds_residencial_w || ' ';
			end if;
			if (ds_comercial_w IS NOT NULL AND ds_comercial_w::text <> '') and (ie_tel_comercial_w	= 'S') then
				ds_telefone_w := ds_telefone_w || ' ' || ds_comercial_w || ' ';
			end if;
			if (ds_fax_w IS NOT NULL AND ds_fax_w::text <> '') and (ie_tel_fax_w = 'S') then
				ds_telefone_w := ds_telefone_w || ' ' || ds_fax_w || ' ';	
			end if;
			if (ds_telefone_resp_w IS NOT NULL AND ds_telefone_resp_w::text <> '') and (ie_tel_resp_w = 'S') then
				ds_telefone_w := ds_telefone_w || ' ' || ds_telefone_resp_w || ' ' || ds_fax_resp_w;	
			end if;
			if (ds_hospedagem_w IS NOT NULL AND ds_hospedagem_w::text <> '') and (ie_tel_hospedagem_w = 'S') then
				ds_telefone_w := ds_telefone_w || ' ' || ds_hospedagem_w || ' ';	
			end if;
			
			ds_telefone_w	:= substr(ds_telefone_w,2,80);
		
		end if;
	end if;
end if;

return ds_telefone_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_fone_pac_agenda (cd_pessoa_fisica_p text) FROM PUBLIC;

