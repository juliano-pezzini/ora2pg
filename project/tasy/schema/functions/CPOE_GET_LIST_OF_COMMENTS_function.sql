-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION cpoe_get_list_of_comments ( NR_SEQ_REFERENCE_P bigint, NM_TABLE_P text, si_option_p text, si_validation_type_p text default null, IE_TIPO_ITEM_JUST_P CPOE_COMMENT_LINKAGE.IE_TIPO_ITEM_JUST%TYPE default null) RETURNS varchar AS $body$
DECLARE

					ds_return_w 			varchar(32767);
					ds_si_w					varchar(15);
				
c_comments CURSOR FOR
SELECT	b.ds_comment, trim(both a.DS_ADDITIONAL_TEXT) as DS_ADDITIONAL_TEXT
from	cpoe_std_comment b,
		cpoe_comment_linkage a
where	a.nr_seq_std_comment = b.nr_sequencia
and		a.nr_seq_cpoe_material = NR_SEQ_REFERENCE_P
and		nm_table_p = 'CPOE_MATERIAL'
and     coalesce(a.SI_VALIDATION_TYPE, 0) = coalesce(SI_VALIDATION_TYPE_P, 0)
and     coalesce(a.IE_TIPO_ITEM_JUST, 0) = coalesce(IE_TIPO_ITEM_JUST_P, 0)

union all

select	cpoe_concat_cmt_proc(b.ds_comment, b.ds_additional_matter, a.ds_additional_text), null as ds_additional_text
from	cpoe_std_comment b,
		cpoe_comment_linkage a
where	a.nr_seq_std_comment = b.nr_sequencia
and		a.nr_seq_cpoe_proced = NR_SEQ_REFERENCE_P
and		nm_table_p = 'CPOE_PROCEDIMENTO'

union all

select	b.ds_comment, trim(both a.DS_ADDITIONAL_TEXT) as DS_ADDITIONAL_TEXT
from	cpoe_std_comment b,
		cpoe_comment_linkage a
where	a.nr_seq_std_comment = b.nr_sequencia
and		a.nr_seq_cpoe_nutricao = NR_SEQ_REFERENCE_P
and		nm_table_p = 'CPOE_DIETA'

union all

select	b.ds_comment, trim(both a.DS_ADDITIONAL_TEXT) as DS_ADDITIONAL_TEXT
from	cpoe_std_comment b,
		cpoe_comment_linkage a
where	a.nr_seq_std_comment = b.nr_sequencia
and		a.nr_seq_cpoe_recomend = NR_SEQ_REFERENCE_P
and		nm_table_p = 'CPOE_RECOMENDACAO'

union all

select	b.ds_comment, trim(both a.DS_ADDITIONAL_TEXT) as DS_ADDITIONAL_TEXT
from	cpoe_std_comment b,
		cpoe_comment_linkage a
where	a.nr_seq_std_comment = b.nr_sequencia
and		a.nr_seq_cpoe_dialise = NR_SEQ_REFERENCE_P
and		nm_table_p = 'CPOE_DIALISE'

union all

select	b.ds_comment, trim(both a.DS_ADDITIONAL_TEXT) as DS_ADDITIONAL_TEXT
from	cpoe_std_comment b,
		cpoe_comment_linkage a
where	a.nr_seq_std_comment = b.nr_sequencia
and		a.nr_seq_cpoe_anat_pat = NR_SEQ_REFERENCE_P
and		nm_table_p = 'CPOE_ANATOMIA_PATOLOGICA'

union all

select	b.ds_comment, trim(both a.DS_ADDITIONAL_TEXT) as DS_ADDITIONAL_TEXT
from	cpoe_std_comment b,
		cpoe_comment_linkage a
where	a.nr_seq_std_comment = b.nr_sequencia
and		a.nr_seq_cpoe_gasoterapia = NR_SEQ_REFERENCE_P
and		nm_table_p = 'CPOE_GASOTERAPIA'

union all

select	b.ds_comment, trim(both a.DS_ADDITIONAL_TEXT) as DS_ADDITIONAL_TEXT
from	cpoe_std_comment b,
		cpoe_comment_linkage a
where	a.nr_seq_std_comment = b.nr_sequencia
and		a.nr_seq_cpoe_hemoterapia = NR_SEQ_REFERENCE_P
and		nm_table_p = 'CPOE_HEMOTERAPIA'

union all

select	b.ds_comment, trim(both a.DS_ADDITIONAL_TEXT) as DS_ADDITIONAL_TEXT
from	cpoe_std_comment b,
		cpoe_comment_linkage a
where	a.nr_seq_std_comment = b.nr_sequencia
and		a.nr_seq_cpoe_just_item = NR_SEQ_REFERENCE_P
and		a.si_validation_type = si_validation_type_p
and		nm_table_p = 'CPOE_JUSTIFICATIVA_ITEM'

union all

select	b.ds_comment, trim(both a.DS_ADDITIONAL_TEXT) as DS_ADDITIONAL_TEXT
from	cpoe_std_comment b,
		cpoe_comment_linkage a
where	a.nr_seq_std_comment = b.nr_sequencia
and		a.NR_SEQ_CPOE_JUST_INTER = NR_SEQ_REFERENCE_P
and		nm_table_p = 'CPOE_JUSTIFICATIVA_INTER'

union all

select	b.ds_comment, trim(both a.DS_ADDITIONAL_TEXT) as DS_ADDITIONAL_TEXT
from	cpoe_std_comment b,
		cpoe_comment_linkage a
where	a.nr_seq_std_comment = b.nr_sequencia
and		a.nr_seq_cpoe_order_unit = NR_SEQ_REFERENCE_P
and		nm_table_p = 'CPOE_ORDER_UNIT'

union all

select	b.ds_comment, trim(both a.DS_ADDITIONAL_TEXT) as DS_ADDITIONAL_TEXT
from	cpoe_std_comment b,
		cpoe_comment_linkage a
where	a.nr_seq_std_comment = b.nr_sequencia
and		a.nr_seq_cpoe_rp = NR_SEQ_REFERENCE_P
and		nm_table_p = 'CPOE_RP';

c_comments_tmp CURSOR FOR
SELECT	b.ds_comment, trim(both a.DS_ADDITIONAL_TEXT) as DS_ADDITIONAL_TEXT
from	cpoe_std_comment b,
		cpoe_comment_linkage a
where	a.nr_seq_std_comment = b.nr_sequencia
and		a.nr_seq_cpoe_material_tmp = NR_SEQ_REFERENCE_P
and		nm_table_p = 'CPOE_MATERIAL'
and     coalesce(a.SI_VALIDATION_TYPE, 0) = coalesce(SI_VALIDATION_TYPE_P, 0)
and     coalesce(a.IE_TIPO_ITEM_JUST, 0) = coalesce(IE_TIPO_ITEM_JUST_P, 0)

union all

select	cpoe_concat_cmt_proc(b.ds_comment, b.ds_additional_matter, a.ds_additional_text), null as ds_additional_text
from	cpoe_std_comment b,
		cpoe_comment_linkage a
where	a.nr_seq_std_comment = b.nr_sequencia
and		a.nr_seq_cpoe_proced_tmp = NR_SEQ_REFERENCE_P
and		nm_table_p = 'CPOE_PROCEDIMENTO'

union all

select	b.ds_comment, trim(both a.DS_ADDITIONAL_TEXT) as DS_ADDITIONAL_TEXT
from	cpoe_std_comment b,
		cpoe_comment_linkage a
where	a.nr_seq_std_comment = b.nr_sequencia
and		a.nr_seq_cpoe_nutricao_tmp = NR_SEQ_REFERENCE_P
and		nm_table_p = 'CPOE_DIETA'

union all

select	b.ds_comment, trim(both a.DS_ADDITIONAL_TEXT) as DS_ADDITIONAL_TEXT
from	cpoe_std_comment b,
		cpoe_comment_linkage a
where	a.nr_seq_std_comment = b.nr_sequencia
and		a.nr_seq_cpoe_recomend_tmp = NR_SEQ_REFERENCE_P
and		nm_table_p = 'CPOE_RECOMENDACAO'

union all

select	b.ds_comment, trim(both a.DS_ADDITIONAL_TEXT) as DS_ADDITIONAL_TEXT
from	cpoe_std_comment b,
		cpoe_comment_linkage a
where	a.nr_seq_std_comment = b.nr_sequencia
and		a.nr_seq_cpoe_dialise_tmp = NR_SEQ_REFERENCE_P
and		nm_table_p = 'CPOE_DIALISE'

union all

select	b.ds_comment, trim(both a.DS_ADDITIONAL_TEXT) as DS_ADDITIONAL_TEXT
from	cpoe_std_comment b,
		cpoe_comment_linkage a
where	a.nr_seq_std_comment = b.nr_sequencia
and		a.nr_seq_cpoe_anat_pat_tmp = NR_SEQ_REFERENCE_P
and		nm_table_p = 'CPOE_ANATOMIA_PATOLOGICA'

union all

select	b.ds_comment, trim(both a.DS_ADDITIONAL_TEXT) as DS_ADDITIONAL_TEXT
from	cpoe_std_comment b,
		cpoe_comment_linkage a
where	a.nr_seq_std_comment = b.nr_sequencia
and		a.nr_seq_cpoe_gasoterapia_tmp = NR_SEQ_REFERENCE_P
and		nm_table_p = 'CPOE_GASOTERAPIA'

union all

select	b.ds_comment, trim(both a.DS_ADDITIONAL_TEXT) as DS_ADDITIONAL_TEXT
from	cpoe_std_comment b,
		cpoe_comment_linkage a
where	a.nr_seq_std_comment = b.nr_sequencia
and		a.nr_seq_cpoe_hemoterapia_tmp = NR_SEQ_REFERENCE_P
and		nm_table_p = 'CPOE_HEMOTERAPIA'

union all

select	b.ds_comment, trim(both a.DS_ADDITIONAL_TEXT) as DS_ADDITIONAL_TEXT
from	cpoe_std_comment b,
		cpoe_comment_linkage a
where	a.nr_seq_std_comment = b.nr_sequencia
and		a.nr_seq_cpoe_just_item_tmp = NR_SEQ_REFERENCE_P
and		nm_table_p = 'CPOE_JUSTIFICATIVA_ITEM'
and		a.si_validation_type = si_validation_type_p

union all

select	b.ds_comment, trim(both a.DS_ADDITIONAL_TEXT) as DS_ADDITIONAL_TEXT
from	cpoe_std_comment b,
		cpoe_comment_linkage a
where	a.nr_seq_std_comment = b.nr_sequencia
and		a.NR_SEQ_CPOE_JUST_INTER_TMP = NR_SEQ_REFERENCE_P
and		nm_table_p = 'CPOE_JUSTIFICATIVA_INTER'

union all

select	b.ds_comment, trim(both a.DS_ADDITIONAL_TEXT) as DS_ADDITIONAL_TEXT
from	cpoe_std_comment b,
		cpoe_comment_linkage a
where	a.nr_seq_std_comment = b.nr_sequencia
and		a.nr_seq_cpoe_order_unit_tmp = NR_SEQ_REFERENCE_P
and		nm_table_p = 'CPOE_ORDER_UNIT'

union all

select	b.ds_comment, trim(both a.DS_ADDITIONAL_TEXT) as DS_ADDITIONAL_TEXT
from	cpoe_std_comment b,
		cpoe_comment_linkage a
where	a.nr_seq_std_comment = b.nr_sequencia
and		a.nr_seq_cpoe_rp_tmp = NR_SEQ_REFERENCE_P
and		nm_table_p = 'CPOE_RP';

/* 	SI_OPTION_P
	DTF - Token field separator with description
	DC 	- Comma separator with description
 */
BEGIN

if (SI_OPTION_P = 'DTF') then
	ds_si_w := '#$';
elsif (SI_OPTION_P = 'DC') then
	ds_si_w := ', ';
end if;

for r_c_comments in c_comments loop
	ds_return_w	:= ds_return_w || r_c_comments.ds_comment;
    if (r_c_comments.ds_additional_text IS NOT NULL AND r_c_comments.ds_additional_text::text <> '') then
        ds_return_w := ds_return_w || ': ' || r_c_comments.ds_additional_text || ds_si_w;
    else
        ds_return_w := ds_return_w || ds_si_w;
    end if;
end loop;

if (coalesce(ds_return_w::text, '') = '') then
	for r_c_comments_tmp in c_comments_tmp loop
		ds_return_w	:= ds_return_w || r_c_comments_tmp.ds_comment;
        if (r_c_comments_tmp.ds_additional_text IS NOT NULL AND r_c_comments_tmp.ds_additional_text::text <> '') then
            ds_return_w := ds_return_w || ': ' || r_c_comments_tmp.ds_additional_text || ds_si_w;
        else
            ds_return_w := ds_return_w || ds_si_w;
        end if;
	end loop;
end if;

return	SUBSTR(ds_return_w, 1, LENGTH(ds_return_w) - LENGTH(ds_si_w));

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION cpoe_get_list_of_comments ( NR_SEQ_REFERENCE_P bigint, NM_TABLE_P text, si_option_p text, si_validation_type_p text default null, IE_TIPO_ITEM_JUST_P CPOE_COMMENT_LINKAGE.IE_TIPO_ITEM_JUST%TYPE default null) FROM PUBLIC;

