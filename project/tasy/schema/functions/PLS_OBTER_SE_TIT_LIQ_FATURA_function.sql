-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION pls_obter_se_tit_liq_fatura (nr_seq_fatura_p pls_fatura.nr_sequencia%type ) RETURNS varchar AS $body$
DECLARE


-- Edgar 19/06/2013, OS 529002. FUNCTION PARA RETORNAR SE OS TÍTULOS DA FATURA (PLS_FATURA) ESTÃO COM BAIXAS, ALTERAÇÃO, DE VALOR, OU ALGUM OUTRO EVENTO QUE ALTERE O SALDO DO TÍTULO.
ie_retorno_w			varchar(255) := 'N';
vl_titulo_w			titulo_receber.vl_titulo%type;
vl_saldo_titulo_w		titulo_receber.vl_saldo_titulo%type;
nr_titulo_w			titulo_receber.nr_titulo%type;
nr_titulo_ndc_w			titulo_receber.nr_titulo%type;
vl_tributo_w			titulo_receber_trib.vl_tributo%type;


BEGIN
-- Obter os títulos de faturamento
select	max(nr_titulo),
	max(nr_titulo_ndc)
into STRICT	nr_titulo_w,
	nr_titulo_ndc_w
from	pls_fatura
where	nr_sequencia	= nr_seq_fatura_p;

if (nr_titulo_w IS NOT NULL AND nr_titulo_w::text <> '') then
	-- Valores do título
	select	vl_titulo,
		vl_saldo_titulo
	into STRICT	vl_titulo_w,
		vl_saldo_titulo_w
	from	titulo_receber
	where	nr_titulo	= nr_titulo_w;

	-- O faturamento pode ter gerado tributo que desconta do título gerado
	select	coalesce(max(vl_tributo),0)
	into STRICT	vl_tributo_w
	from	titulo_receber_trib	x
	where	x.nr_titulo		= nr_titulo_w
	and	x.ie_origem_tributo	= 'CD';

	-- Verificar diferença
	if	(vl_titulo_w <> (vl_saldo_titulo_w + vl_tributo_w)) then
		ie_retorno_w	:= 'S';
	end if;
end if;

if (nr_titulo_ndc_w IS NOT NULL AND nr_titulo_ndc_w::text <> '') then
	-- Valores do título
	select	vl_titulo,
		vl_saldo_titulo
	into STRICT	vl_titulo_w,
		vl_saldo_titulo_w
	from	titulo_receber
	where	nr_titulo	= nr_titulo_ndc_w;

	-- O faturamento pode ter gerado tributo que desconta do título gerado
	select	coalesce(max(vl_tributo),0)
	into STRICT	vl_tributo_w
	from	titulo_receber_trib	x
	where	x.nr_titulo		= nr_titulo_ndc_w
	and	x.ie_origem_tributo	= 'CD';

	-- Verificar diferença
	if	(vl_titulo_w <> (vl_saldo_titulo_w + vl_tributo_w)) then
		ie_retorno_w	:= 'S';
	end if;
end if;

return	ie_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION pls_obter_se_tit_liq_fatura (nr_seq_fatura_p pls_fatura.nr_sequencia%type ) FROM PUBLIC;

