-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION ctb_mot_nao_contab_copart ( nr_seq_conta_p bigint, nr_seq_conta_copartic_contab_p bigint, nr_lote_contabil_p bigint) RETURNS varchar AS $body$
DECLARE


dt_mes_competencia_w			pls_protocolo_conta.dt_mes_competencia%type;
cd_estabelecimento_w			pls_conta.cd_estabelecimento%type;
dt_referencia_lote_w			lote_contabil.dt_referencia%type;
cd_estabelecimento_lote_w		lote_contabil.cd_estabelecimento%type;
ie_status_w				pls_conta.ie_status%type;
ie_tipo_protocolo_w			pls_protocolo_conta.ie_tipo_protocolo%type;
ie_status_coparticipacao_w		pls_conta_coparticipacao.ie_status_coparticipacao%type;
ie_estorno_custo_w			pls_conta_coparticipacao.ie_estorno_custo%type;
vl_coparticipacao_w			pls_conta_copartic_contab.vl_coparticipacao%type;
dt_estorno_w				pls_conta_coparticipacao.dt_estorno%type;
dt_fechamento_discussao_w		pls_conta_coparticipacao.dt_fechamento_discussao%type;
cd_conta_deb_provisao_w			pls_conta_copartic_contab.cd_conta_deb_provisao%type;
cd_conta_cred_provisao_w		pls_conta_copartic_contab.cd_conta_cred_provisao%type;
vl_retorno_w				varchar(4000);


BEGIN

select	dt_referencia,
	cd_estabelecimento
into STRICT 	dt_referencia_lote_w,
	cd_estabelecimento_lote_w
from 	lote_contabil
where 	nr_lote_contabil 	= nr_lote_contabil_p;

select		c.dt_mes_competencia,
		x.cd_estabelecimento,
		a.ie_status,
		x.ie_tipo_protocolo,
		b.ie_status_coparticipacao,
		coalesce(b.ie_estorno_custo,'N'),
		c.vl_coparticipacao,
		b.dt_estorno,
		b.dt_fechamento_discussao,
		c.cd_conta_deb_provisao,		
		c.cd_conta_cred_provisao
into STRICT		dt_mes_competencia_w,
		cd_estabelecimento_w,
		ie_status_w,
		ie_tipo_protocolo_w,
		ie_status_coparticipacao_w,
		ie_estorno_custo_w,
		vl_coparticipacao_w,
		dt_estorno_w,
		dt_fechamento_discussao_w,
		cd_conta_deb_provisao_w,		
		cd_conta_cred_provisao_w
from		pls_conta 			a,
		pls_conta_coparticipacao	b,
		pls_conta_copartic_contab	c,
		pls_protocolo_conta 		x
where		x.nr_sequencia			= a.nr_seq_protocolo
and		b.nr_seq_conta			= a.nr_sequencia
and		c.nr_seq_conta_copartic		= b.nr_sequencia
and		b.nr_seq_conta   		= nr_seq_conta_p
and		c.nr_sequencia 			= nr_seq_conta_copartic_contab_p;

if ((dt_mes_competencia_w IS NOT NULL AND dt_mes_competencia_w::text <> '') and vl_coparticipacao_w > 0) then
	if (ie_tipo_protocolo_w in ('C','I','F') and ie_status_coparticipacao_w not in ('D','S')) then
		vl_retorno_w := substr(vl_retorno_w || ' ' || obter_desc_expressao(1035651), 1, 4000);
	end if;

	if (ie_tipo_protocolo_w = 'R' and ie_status_coparticipacao_w = 'N') then
		vl_retorno_w := substr(vl_retorno_w || ' ' || obter_desc_expressao(1035654), 1, 4000);
	end if;


	if (dt_mes_competencia_w not between trunc(dt_referencia_lote_w, 'month') and fim_dia(fim_mes(dt_referencia_lote_w))) then
		vl_retorno_w := substr(vl_retorno_w || ' ' || obter_desc_expressao(1035614), 1, 4000);
	end if;
end if;

if ((dt_estorno_w IS NOT NULL AND dt_estorno_w::text <> '') and vl_coparticipacao_w < 0) then
	if (ie_estorno_custo_w = 'S') then
		if (dt_estorno_w not between trunc(dt_referencia_lote_w, 'month') and fim_dia(fim_mes(dt_referencia_lote_w))) then
			vl_retorno_w := substr(vl_retorno_w || ' ' || obter_desc_expressao(1035612), 1, 4000);
		end if;

		if (ie_tipo_protocolo_w in ('C','I','F') and ie_status_coparticipacao_w not in ('D','S')) then
			vl_retorno_w := substr(vl_retorno_w || ' ' || obter_desc_expressao(1035651), 1, 4000);
		end if;
	else
		vl_retorno_w := substr(vl_retorno_w || ' ' || obter_desc_expressao(1035610), 1, 4000);
	end if;
end if;

if ((dt_fechamento_discussao_w IS NOT NULL AND dt_fechamento_discussao_w::text <> '') and ie_estorno_custo_w = 'N') then
	if (dt_fechamento_discussao_w not between trunc(dt_referencia_lote_w, 'month') and fim_dia(fim_mes(dt_referencia_lote_w))) then
		vl_retorno_w := substr(vl_retorno_w || ' ' || obter_desc_expressao(1035608), 1, 4000);
	end if;

	if (ie_status_coparticipacao_w <> 'F') then
		vl_retorno_w := substr(vl_retorno_w || ' ' || obter_desc_expressao(1035606), 1, 4000);
	end if;
end if;

/* Verificacoes comuns a todos os unions*/

if (vl_coparticipacao_w = 0) then
	vl_retorno_w := substr(vl_retorno_w || ' ' || obter_desc_expressao(1035602), 1, 4000);
end if;

if (cd_estabelecimento_w <> cd_estabelecimento_lote_w) then
	vl_retorno_w := substr(vl_retorno_w || ' ' || obter_desc_expressao(968753), 1, 4000);
end if;

if (ie_status_w not in ('F','S')) then
	vl_retorno_w := substr(vl_retorno_w || ' ' || obter_desc_expressao(1035600), 1, 4000);
end if;

if (coalesce(cd_conta_deb_provisao_w::text, '') = '' or coalesce(cd_conta_cred_provisao_w::text, '') = '') then
	vl_retorno_w := substr(vl_retorno_w || ' ' || obter_desc_expressao(1035598), 1, 4000);
end if;

if (ie_tipo_protocolo_w not in ('C','I','R','F')) then
	vl_retorno_w := substr(vl_retorno_w || ' ' || obter_desc_expressao(1035604), 1, 4000);
end if;

if (coalesce(length(vl_retorno_w), 0) = 0) then
  	vl_retorno_w := obter_desc_expressao(968763);
end if;

return	vl_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION ctb_mot_nao_contab_copart ( nr_seq_conta_p bigint, nr_seq_conta_copartic_contab_p bigint, nr_lote_contabil_p bigint) FROM PUBLIC;

