-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_email_regra_auto (nr_sequencia_p bigint, nr_seq_regra_p bigint) RETURNS varchar AS $body$
DECLARE


ds_retorno_w		text := '';
ds_email_w		varchar(255);
cd_pessoa_fisica_w	varchar(10);
cd_cgc_w		varchar(14);
ie_somente_conectado_w	regra_envio_email_auto.ie_somente_conectado%type;
ie_conectado_w		varchar(1);

c01 CURSOR FOR
	SELECT	cd_pessoa_fisica,
		cd_cgc,
		ds_email,
		coalesce(ie_somente_conectado,'N')
	from	regra_envio_email_auto
	where	nr_seq_rel_auto = nr_sequencia_p
	and 	((coalesce(nr_seq_regra_p, 0) = 0) or (nr_sequencia = nr_seq_regra_p));


BEGIN
open c01;
	loop
	fetch c01 into
		cd_pessoa_fisica_w,
		cd_cgc_w,
		ds_email_w,
		ie_somente_conectado_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
		begin		
		if (coalesce(cd_pessoa_fisica_w,'X') <> 'X') and (ie_somente_conectado_w = 'S') then
			ie_conectado_w := coalesce(substr(obter_se_usuario_conectado(obter_usuario_pessoa(cd_pessoa_fisica_w)),1,1),'N');
		end if;
		
		if (coalesce(cd_cgc_w,'X') <> 'X') or (ie_somente_conectado_w = 'N') or (ie_conectado_w = 'S') then
			begin
			if (coalesce(ds_email_w,'X') = 'X') then
				begin
				if (coalesce(cd_pessoa_fisica_w,'X') <> 'X') then
					ds_email_w	:=	substr(obter_dados_pf_pj(cd_pessoa_fisica_w,'','M'),1,255);
				elsif (coalesce(cd_cgc_w,'X') <> 'X') then
					ds_email_w	:=	substr(obter_dados_pf_pj('',cd_cgc_w,'M'),1,255);
                    if (coalesce(ds_email_w::text, '') = '') then
                        begin
                            select max(a.DS_EMAIL)
                            into STRICT ds_email_w
                            from PESSOA_JURIDICA_ESTAB a
                            where a.cd_cgc = cd_cgc_w;
                        end;
                    end if;
				end if;
				end;
			end if;
			
			ds_retorno_w := ds_email_w || ', ' || ds_retorno_w;
			end;
		end if;
		end;
	end loop;
close c01;

return	ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_email_regra_auto (nr_sequencia_p bigint, nr_seq_regra_p bigint) FROM PUBLIC;

