-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_inf_medic_control (cd_material_p bigint, ie_informacao_p text) RETURNS varchar AS $body$
DECLARE


cd_classificacao_w    medic_controlado.cd_classificacao_receita%type;
cd_medicamento_w	   medic_controlado.cd_medicamento%type;
ie_tipo_receita_w	   varchar(10);
qt_max_item_w           bigint;
retorno_w		   varchar(2000);


BEGIN

select a.cd_classificacao_receita cd_classif,
	a.cd_medicamento cd_medicamento,
	obter_qt_item_max_receita(a.cd_classificacao_receita,a.cd_medicamento)  qt_max_reg,
	d.ie_tipo_receita
into STRICT	cd_classificacao_w,
	cd_medicamento_w,
	qt_max_item_w,
	ie_tipo_receita_w
from medic_controlado a,
	tipo_medic_controlado b,
	material c,
	regra_geracao_receita d
where a.cd_material = cd_material_p
and a.nr_seq_tipo   = b.nr_sequencia
and c.cd_material   = a.cd_material
and	d.cd_lista       = a.cd_classificacao_receita
and	d.cd_medicamento = a.cd_medicamento
and	coalesce(b.ie_situacao,'A') = 'A'
and	coalesce(a.ie_situacao,'A') = 'A'
and coalesce(b.ie_receita,'S')  = 'S'
and coalesce(c.ie_receita,'S')  = 'S'
and (a.cd_classificacao_receita IS NOT NULL AND a.cd_classificacao_receita::text <> '')
and (a.cd_medicamento IS NOT NULL AND a.cd_medicamento::text <> '')
and obter_qt_item_max_receita(a.cd_classificacao_receita,a.cd_medicamento) > 0
order by a.cd_medicamento,
	a.cd_classificacao LIMIT 1;

if (upper(ie_informacao_p) = 'Q') then
	if (qt_max_item_w > 0) then
		retorno_w	:=  to_char(qt_max_item_w);
	else
		retorno_w	:=  null;
	end if;
elsif (upper(ie_informacao_p) = 'M') then
	retorno_w	:= cd_medicamento_w;
elsif (upper(ie_informacao_p) = 'C') then
	retorno_w	:= cd_classificacao_w;
elsif (upper(ie_informacao_p) = 'T') then
	retorno_w	:= ie_tipo_receita_w;
else
	retorno_w	:= null;
end if;


return retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_inf_medic_control (cd_material_p bigint, ie_informacao_p text) FROM PUBLIC;

