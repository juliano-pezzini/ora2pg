-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION lab_integra_obr_data_hl7 ( nr_prescricao_p prescr_procedimento.nr_prescricao%TYPE, nr_sequencia_p prescr_procedimento.nr_sequencia%TYPE) RETURNS varchar AS $body$
DECLARE


    id_obr_w       varchar(1);
    nr_order_w     varchar(14);
    diagnostic_w   varchar(100);
    json_aux_w     philips_json;
    ds_message_w   text;

BEGIN
    json_aux_w := philips_json();
    BEGIN
        SELECT '1' id_obr,
               nr_prescricao_p nr_order,
               CASE WHEN obter_ultimo_cid_atend_pac(b.nr_atendimento, 'P', 'D', 0)='' THEN  ''  ELSE obter_ultimo_cid_atend_pac(b.nr_atendimento, 'P', 'D', 0) END  diagnostic
        INTO STRICT id_obr_w,
             nr_order_w,
             diagnostic_w
        FROM prescr_medica         b,
             prescr_procedimento   c
        WHERE b.nr_prescricao = c.nr_prescricao
        AND (b.dt_liberacao IS NOT NULL AND b.dt_liberacao::text <> '')
		AND c.nr_prescricao = nr_prescricao_p
		AND c.nr_sequencia = nr_sequencia_p;

        json_aux_w.put('id_obr', id_obr_w);
        json_aux_w.put('nr_order', nr_order_w);
        json_aux_w.put('diagnostic', diagnostic_w);
        dbms_lob.createtemporary(ds_message_w, true);
        json_aux_w.(ds_message_w);
    EXCEPTION
        WHEN no_data_found OR too_many_rows THEN
            ds_message_w := '';
    END;

    RETURN ds_message_w;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION lab_integra_obr_data_hl7 ( nr_prescricao_p prescr_procedimento.nr_prescricao%TYPE, nr_sequencia_p prescr_procedimento.nr_sequencia%TYPE) FROM PUBLIC;

