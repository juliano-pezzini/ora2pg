-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION lab_abrevia_texto ( ds_texto_p text, ie_opcao_p text) RETURNS varchar AS $body$
DECLARE


/*
T - Todas as palavras abreviadas
M - Somente palavras do meio abreviadas
*/
ds_texto_w			varchar(80);
ds_lista_texto_w	varchar(255);
ie_texto_ok_w		varchar(1)	:= 'N';
ds_texto_abrev_w	varchar(60);
ds_ultimo_texto_w	varchar(80);
ds_retorno_texto_w	varchar(255)	:= '';
ds_retorno_w		varchar(255)	:= '';
ds_texto_comp_w		varchar(255);
ds_ultima_letra_w	varchar(1);
k			smallint;
i			smallint;
j			bigint	:= 0;


pos_palavra_w		bigint;
qt_mais_palavras_w		bigint;



BEGIN

select	obter_initcap(ds_texto_p)
into STRICT	ds_texto_w
;

if (ie_opcao_p = 'M') then
	ds_lista_texto_w	:= ds_texto_w;

	/* Rotina para retirar os espaços em branco após o texto */

	while(ie_texto_ok_w	= 'N') loop
		begin
		select	substr(ds_lista_texto_w,length(ds_lista_texto_w),length(ds_lista_texto_w))
		into STRICT	ds_ultima_letra_w
		;

		if (ds_ultima_letra_w = ' ') then
			ds_lista_texto_w	:= substr(ds_lista_texto_w,1,length(ds_lista_texto_w)-1);
		else
			ie_texto_ok_w	:= 'S';
		end if;

		end;
	end loop;

	/* Inserir um espaço em branco para delimitar o fim do texto */

	ds_lista_texto_w	:= ds_lista_texto_w || ' ';

	while(ds_lista_texto_w IS NOT NULL AND ds_lista_texto_w::text <> '') loop
		begin
		j	:= j+1; /* Variável "j" criada para não abreviar o primeiro texto */
		select	position(' ' in ds_lista_texto_w)
		into STRICT	pos_palavra_w
		;

		if (pos_palavra_w > 0) then
			ds_texto_comp_w	:= substr(ds_lista_texto_w,1,pos_palavra_w - 1);

			ds_lista_texto_w	:= substr(ds_lista_texto_w,pos_palavra_w + 1,length(ds_lista_texto_w));
			if (j > 1) then

				/* Verifica se é a última palavra */

				select	position(' ' in ds_lista_texto_w)
				into STRICT	qt_mais_palavras_w
				;

				if (qt_mais_palavras_w > 0) then
					ds_texto_comp_w	:= upper(substr(ds_texto_comp_w,1,1));
				end if;
			end if;

			if (length(ds_texto_comp_w) > 0) then
				ds_retorno_texto_w	:= ds_retorno_texto_w || ds_texto_comp_w || ' ';
			end if;

		end if;
		end;

	end loop;

	ds_retorno_w := substr(ds_retorno_texto_w,1,length(ds_retorno_texto_w)-1);
else
	k	:= position(' ' in ds_texto_w);

	ds_texto_abrev_w := substr(ds_texto_w,1,k-1);

	for i in k..length(ds_texto_w) loop
		begin
		if (substr(ds_texto_w,i,1) = upper(substr(ds_texto_w,i,1))) then
			if (coalesce(ds_ultimo_texto_w::text, '') = '') then
				ds_ultimo_texto_w := substr(ds_texto_w,i,1);
			else
				ds_ultimo_texto_w := ds_ultimo_texto_w || substr(ds_texto_w,i,1);
			end if;
		end if;
		end;
	end loop;

	if (ie_opcao_p = 'T') then
		ds_texto_abrev_w := substr(ds_texto_abrev_w,1,1);
	end if;

	ds_retorno_w := ds_texto_abrev_w || replace(ds_ultimo_texto_w,'  ',' ');
end if;

return 	ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION lab_abrevia_texto ( ds_texto_p text, ie_opcao_p text) FROM PUBLIC;

