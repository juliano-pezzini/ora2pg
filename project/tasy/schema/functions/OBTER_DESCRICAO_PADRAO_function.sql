-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_descricao_padrao ( nm_tabela_p text, ds_campo_p text, cd_chave_p text) RETURNS varchar AS $body$
DECLARE


ds_comando_w			varchar(2000);
ds_campo_chave_w			varchar(50);
ds_tipo_campo_w			varchar(10);
cd_chave_w				varchar(255);
qt_tamanho_w			integer;

vl_retorno_w			varchar(255);
c001				  	integer;		
retorno_w				integer;


BEGIN
if (nm_tabela_p IS NOT NULL AND nm_tabela_p::text <> '') and (ds_campo_p IS NOT NULL AND ds_campo_p::text <> '') and (cd_chave_p IS NOT NULL AND cd_chave_p::text <> '') then
	begin
	begin
	select max(nm_atributo)
	into STRICT ds_campo_chave_w
	from 	indice_atributo b,
		indice a
	where	a.nm_tabela	= nm_tabela_p
	  and	a.nm_tabela	= b.nm_tabela
	  and	a.nm_indice	= b.nm_indice
	  and	a.ie_tipo	= 'PK';
	exception
		when others THEN
			ds_campo_chave_w := '';
	end;

	begin
	select ie_tipo_atributo,
		 coalesce(qt_tamanho,50)
	into STRICT ds_tipo_campo_w,
	     qt_tamanho_w
	from tabela_atributo
	where nm_tabela = nm_tabela_p
	  and nm_atributo = ds_campo_p;
	exception
		when others THEN
			ds_tipo_campo_w := '';
	end;

	cd_chave_w := cd_chave_p;
/*	if (ds_tipo_campo_w = 'VARCHAR2') then
		cd_chave_w := chr(39)||cd_chave_w||chr(39);
	end if;*/
	ds_comando_w	:= 'select ' || ds_campo_p || ' from ' || nm_tabela_p ||
				' where ' || ds_campo_chave_w || '::text = $1 ';

--	begin

	-- C001 := DBMS_SQL.OPEN_CURSOR;
	-- DBMS_SQL.PARSE(C001, ds_comando_w, dbms_sql.Native);
	-- dbms_sql.define_column(C001,1,cd_chave_w,255);
	-- DBMS_SQL.BIND_VARIABLE(C001, 'CD_CHAVE', cd_chave_w,255);
	-- retorno_w := DBMS_SQL.execute(c001);
	-- retorno_w := DBMS_SQL.fetch_rows(c001);
	-- DBMS_SQL.COLUMN_VALUE(C001, 1, vl_retorno_w );
	-- DBMS_SQL.CLOSE_CURSOR(C001);

	execute ds_comando_w
	   into vl_retorno_w
	  using cd_chave_w;

	-- exception	
	-- when others THEN
	-- 	DBMS_SQL.CLOSE_CURSOR(C001);
	-- end;
	end;
end if;

RETURN vl_retorno_w;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_descricao_padrao ( nm_tabela_p text, ds_campo_p text, cd_chave_p text) FROM PUBLIC;

