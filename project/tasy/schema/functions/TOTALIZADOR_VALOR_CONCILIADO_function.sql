-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION totalizador_valor_conciliado (nr_seq_extrato_p bigint, nr_seq_extrato_movto_p bigint, ie_conciliado_p text) RETURNS bigint AS $body$
DECLARE


ie_tipo_arquivo_w   extrato_cartao_cr_arq.ie_tipo_arquivo%type;
vl_retorno_w     bigint;


BEGIN

    select max(ie_tipo_arquivo)
    into STRICT ie_tipo_arquivo_w
    from extrato_cartao_cr_arq
    where nr_seq_extrato = nr_seq_extrato_p;

    if (ie_tipo_arquivo_w = 'F') then
        if (ie_conciliado_p = 'C') then
            select coalesce(max(vl_parcela),0)
            into STRICT vl_retorno_w
            from extrato_cartao_cr_movto
            where nr_sequencia = nr_seq_extrato_movto_p
            and coalesce(vl_saldo_concil_fin,0) = 0;

            return vl_retorno_w;
        else
            select coalesce(max(vl_parcela),0)
            into STRICT vl_retorno_w
            from extrato_cartao_cr_movto
            where nr_sequencia = nr_seq_extrato_movto_p
            and coalesce(vl_saldo_concil_fin,0) != 0;

            return vl_retorno_w;
        end if;
    else
        if (ie_conciliado_p = 'C') then
            select coalesce(max(vl_parcela),0)
            into STRICT vl_retorno_w
            from extrato_cartao_cr_movto
            where nr_sequencia = nr_seq_extrato_movto_p
            and (nr_seq_extrato_parcela IS NOT NULL AND nr_seq_extrato_parcela::text <> '');

            return vl_retorno_w;
        else
            select coalesce(max(vl_parcela),0)
            into STRICT vl_retorno_w
            from extrato_cartao_cr_movto
            where nr_sequencia = nr_seq_extrato_movto_p
            and coalesce(nr_seq_extrato_parcela::text, '') = '';

            return vl_retorno_w;
        end if;
    end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION totalizador_valor_conciliado (nr_seq_extrato_p bigint, nr_seq_extrato_movto_p bigint, ie_conciliado_p text) FROM PUBLIC;

