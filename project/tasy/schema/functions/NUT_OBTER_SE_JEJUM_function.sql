-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION nut_obter_se_jejum ( nr_atendimento_p bigint, cd_setor_atendimento_p bigint, dt_servico_inicial_p timestamp, dt_servico_final_p timestamp) RETURNS varchar AS $body$
DECLARE


ds_retorno_w	varchar(1);


BEGIN

if (nr_atendimento_p IS NOT NULL AND nr_atendimento_p::text <> '') and (cd_setor_atendimento_p IS NOT NULL AND cd_setor_atendimento_p::text <> '') and (dt_servico_inicial_p IS NOT NULL AND dt_servico_inicial_p::text <> '') and (dt_servico_final_p IS NOT NULL AND dt_servico_final_p::text <> '') then

	SELECT	CASE WHEN COUNT(*)=0 THEN 'N'  ELSE 'S' END
	INTO STRICT	ds_retorno_w
	FROM	nut_atend_serv_dia a,
		prescr_medica b,
		rep_jejum c
	WHERE	a.nr_atendimento = b.nr_atendimento
	AND	b.nr_prescricao = c.nr_prescricao
	AND	(b.dt_liberacao IS NOT NULL AND b.dt_liberacao::text <> '')
	AND	coalesce(b.dt_suspensao::text, '') = ''
	AND	coalesce(c.ie_suspenso,'N') = 'N'
	AND	a.dt_servico BETWEEN b.dt_inicio_prescr AND b.dt_validade_prescr
	AND	a.nr_atendimento = nr_atendimento_p
	AND	a.cd_setor_atendimento = cd_setor_atendimento_p
	AND	a.dt_servico BETWEEN TRUNC(dt_servico_inicial_p,'dd') AND TRUNC(dt_servico_final_p,'dd') + 86399/86400
	and	coalesce(c.dt_fim,clock_timestamp()) >= clock_timestamp();

	if (ds_retorno_w = 'N') then

		select	CASE WHEN COUNT(*)=0 THEN 'N'  ELSE 'S' END
		into STRICT	ds_retorno_w
		from	nut_Atend_Serv_dia a,
			nut_Atend_serv_dia_rep b,
			prescr_dieta_hor c
		where	a.nr_sequencia = b.nr_seq_serv_dia
		and	a.dt_servico between trunc(dt_servico_inicial_p,'dd') and trunc(dt_servico_final_p,'dd') + 86399/86400
		and	a.cd_setor_Atendimento = cd_setor_Atendimento_p
		and	a.nr_atendimento = nr_Atendimento_p
		and	b.nr_prescr_oral = c.nr_prescricao
		and	to_char(a.dt_servico,'dd/mm/yyyy hh24:mi') = to_char(c.dt_horario,'dd/mm/yyyy hh24:mi')
		and	(c.dt_bloqueio IS NOT NULL AND c.dt_bloqueio::text <> '')
		and	coalesce(c.dt_desbloqueio_dieta::text, '') = '';

	end if;
end if;

return	ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION nut_obter_se_jejum ( nr_atendimento_p bigint, cd_setor_atendimento_p bigint, dt_servico_inicial_p timestamp, dt_servico_final_p timestamp) FROM PUBLIC;

