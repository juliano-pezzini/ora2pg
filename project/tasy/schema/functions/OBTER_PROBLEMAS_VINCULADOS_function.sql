-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_problemas_vinculados ( nr_seq_prog_saude_p bigint, cd_pessoa_fisica_p text ) RETURNS varchar AS $body$
DECLARE

    ds_retorno_w 	varchar(4000) := '';
	ds_problema_w	lista_problema_pac.ds_problema%type;	

	
C01 CURSOR FOR
	SELECT 	distinct l.ds_problema
	FROM	lista_problema_pac       l,
			atend_prog_saude_probl   a,
			atend_programa_saude     s
    WHERE
            a.nr_seq_problema = l.nr_sequencia
            AND a.nr_seq_prog_saude = s.nr_sequencia
            AND s.nr_seq_programa_saude = nr_seq_prog_saude_p
            AND a.cd_pessoa_fisica = cd_pessoa_fisica_p
            AND (l.dt_liberacao IS NOT NULL AND l.dt_liberacao::text <> '')
            AND coalesce(l.dt_inativacao::text, '') = ''
	ORDER BY ds_problema;
	

BEGIN
    IF (cd_pessoa_fisica_p IS NOT NULL AND cd_pessoa_fisica_p::text <> '') AND (nr_seq_prog_saude_p IS NOT NULL AND nr_seq_prog_saude_p::text <> '') THEN
	
		open C01;
		loop
		fetch C01 into	
			ds_problema_w;
		EXIT WHEN NOT FOUND; /* apply on C01 */
			begin
			
				if (coalesce(ds_retorno_w::text, '') = '') then
				
					ds_retorno_w :=  ds_problema_w;
				
				else
				
					ds_retorno_w :=  substr(ds_retorno_w||', '||ds_problema_w,1,255);
				
				end if;
						
			end;
		end loop;
		close C01;
		

    END IF;

    RETURN ds_retorno_w;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_problemas_vinculados ( nr_seq_prog_saude_p bigint, cd_pessoa_fisica_p text ) FROM PUBLIC;

