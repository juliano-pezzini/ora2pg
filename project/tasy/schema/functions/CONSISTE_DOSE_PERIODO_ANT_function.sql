-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION consiste_dose_periodo_ant ( nr_atendimento_p bigint, nr_prescricao_p bigint, nr_seq_material_p bigint, qt_dose_limite_p bigint, ie_solucao_p text, dt_aprazamento_p timestamp, cd_material_p bigint, qt_dose_p bigint, cd_unidade_medida_dose_p text, ds_horarios_p text, ie_urgencia_p text, ie_delphijava_p text) RETURNS varchar AS $body$
DECLARE


cd_material_w			prescr_mat_hor.cd_material%type;
qt_dose_w				prescr_mat_hor.qt_dose%type;
qt_dose_adm_w			double precision;
qt_total_dose_adm_w		double precision;
qt_total_dose_pres_w	double precision;
cd_unid_med_dose_adm_w	prescr_mat_hor.cd_unidade_medida_dose%type;
cd_unid_med_dose_w		prescr_mat_hor.cd_unidade_medida_dose%type;
dt_horario_w			prescr_mat_hor.dt_horario%type;
dt_horario_consist_w	prescr_mat_hor.dt_horario%type;
dt_horario_consist_ww	prescr_mat_hor.dt_horario%type;
ds_horarios_w			prescr_material.ds_horarios%type;
nr_sequencia_solucao_w	prescr_material.nr_sequencia_solucao%type;
ie_urgencia_w			prescr_solucao.ie_urgencia%type;
ds_retorno_w			varchar(50)	:= 'S';
k						integer;
qt_dia_adic_w			bigint := 0;
dt_inicio_prescr_w		timestamp;
ds_hora_w				varchar(07);
ie_urgente_w			char(1);
ie_agrupador_w			prescr_material.ie_agrupador%type;
qt_dose_especial_w		prescr_material.qt_dose_especial%type;
hr_dose_especial_w		prescr_material.hr_dose_especial%type;
hr_dose_especial_ww 	varchar(255);
hr_dose_especial_www	timestamp;

c02 CURSOR FOR
	SELECT 	coalesce(sum(c.qt_dose),0) qt_dose,
			c.cd_unidade_medida_dose 
	from   	prescr_medica a,
			prescr_material b,
			prescr_mat_hor c
	where  	a.nr_prescricao 	= b.nr_prescricao
	and	   	a.nr_prescricao  	= c.nr_prescricao
	and	   	c.nr_seq_material 	= b.nr_sequencia
	and	   	b.cd_material	 	= cd_material_w
	and	   	a.nr_atendimento	= nr_atendimento_p
	and	   	((a.nr_prescricao 	<> nr_prescricao_p and (b.ie_acm = 'N' and b.ie_se_necessario = 'N')) or (b.ie_acm = 'S' or b.ie_se_necessario = 'S'))
	and    	c.dt_horario 		between(dt_horario_w - 1) + (1/86000) and (dt_horario_w) + (1/86000)
	and		c.ie_horario_especial	= 'N'
	and	  	coalesce(a.dt_suspensao::text, '') = ''
	and		coalesce(c.dt_suspensao::text, '') = ''
	group by 
			c.cd_unidade_medida_dose;			

c03 CURSOR FOR
	SELECT	a.cd_material,
			a.qt_dose,
			a.cd_unidade_medida_dose,
			b.ds_horarios,
			coalesce(a.ie_urgencia,'N')
	from	prescr_material a,
			prescr_solucao b
	where	a.nr_prescricao 		= b.nr_prescricao
	and		a.nr_prescricao 		= nr_prescricao_p
	and		a.nr_sequencia			= nr_seq_material_p
	and		a.nr_sequencia_solucao	= b.nr_seq_solucao;
	
c04 CURSOR FOR
	SELECT 	a.cd_material,
			a.qt_dose,
			a.cd_unidade_medida_dose,
			b.ds_horarios,
			coalesce(b.ie_urgencia,'N')
	from   	prescr_material a,
			prescr_solucao b
	where  	a.nr_sequencia_solucao = b.nr_seq_solucao
	and		coalesce(b.ie_se_necessario, 'N') = 'N' 
	and		coalesce(b.ie_acm, 'N') = 'N'
	and		a.nr_prescricao = b.nr_prescricao	   
	and		a.nr_prescricao = nr_prescricao_p
	and		a.cd_material	= cd_material_w
	and		a.nr_sequencia <> nr_seq_material_p
	and		a.ie_agrupador = 4;

c05 CURSOR FOR
	SELECT 	cd_material,
			qt_dose,
			cd_unidade_medida_dose,
			ds_horarios,
			coalesce(ie_urgencia,'N'),
			nr_sequencia_solucao
	from   	prescr_material
	where  	nr_prescricao	= nr_prescricao_p
	and		cd_material	= cd_material_w
	and		coalesce(ie_se_necessario, 'N') = 'N'
	and 	coalesce(ie_acm, 'N') = 'N'
	and		nr_sequencia <> nr_seq_material_p
	and		ie_agrupador in (1,4,8,12);
	
procedure obter_dose_extra(cd_material_p bigint,
							qt_dose_p bigint,
							cd_unid_med_dose_p text,
							ds_horarios_p text,
							ie_urgente_p text,
							ie_solucao_p text,
							qt_dose_especial_p bigint,
							hr_dose_especial_p text) is
							;
BEGIN

	cd_material_w 		:= cd_material_p;
	qt_dose_w			:= qt_dose_p;
	cd_unid_med_dose_w	:= cd_unid_med_dose_p;
	ds_horarios_w		:= ds_horarios_p;
	ie_urgente_w		:= ie_urgente_p;
	qt_dose_especial_w 	:= qt_dose_especial_p;
	hr_dose_especial_ww	:= hr_dose_especial_p;
	
	if (hr_dose_especial_ww IS NOT NULL AND hr_dose_especial_ww::text <> '') and (coalesce(qt_dose_especial_w,0) > 0) then
		
		select 	padroniza_horario_prescr(hr_dose_especial_ww, to_char(dt_inicio_prescr_w,'dd/mm/yyyy hh24:mi:ss'))
		into STRICT	hr_dose_especial_ww
		;
		
		if (position('A' in hr_dose_especial_ww) > 0) and (qt_dia_adic_w	= 0) then
			qt_dia_adic_w	:= 1;
		elsif (position('AA' in hr_dose_especial_ww) > 0) then
			qt_dia_adic_w	:= qt_dia_adic_w + 1;
		end if;
		
		hr_dose_especial_www := pkg_date_utils.get_time(dt_inicio_prescr_w + qt_dia_adic_w, replace(hr_dose_especial_ww, 'A', ''), 0);
		
		qt_dia_adic_w := 0;
	end if;

	ds_horarios_w	:= replace(replace(replace(ds_horarios_w,'  ',' '),'  ',' '),'  ',' ');

	if (ds_horarios_w <> 'ACM') and (ds_horarios_w <> 'SN') then
		
		select	padroniza_horario_prescr(ds_horarios_w, to_char(dt_inicio_prescr_w,'dd/mm/yyyy hh24:mi:ss')) || ' '
		into STRICT	ds_horarios_w
		;
					
		while (ds_horarios_w IS NOT NULL AND ds_horarios_w::text <> '') loop
		begin
			
			select	position(' ' in ds_horarios_w)
			into STRICT	k
			;
			
			if (k > 1) and ((substr(ds_horarios_w, 1, k -1) IS NOT NULL AND (substr(ds_horarios_w, 1, k -1))::text <> '')) then
			begin
			
				ds_hora_w		:= substr(ds_horarios_w, 1, k-1);
				ds_hora_w		:= replace(ds_hora_w, ' ','');
				ds_horarios_w		:= substr(ds_horarios_w, k + 1, 2000);
				if (ie_urgente_w = 'N') then
				
					if (position('A' in ds_hora_w) > 0) and (qt_dia_adic_w	= 0) then
						qt_dia_adic_w	:= 1;
					elsif (position('AA' in ds_hora_w) > 0) then
						qt_dia_adic_w	:= qt_dia_adic_w + 1;
					end if;
				end if;
				
				ds_hora_w	:= replace(ds_hora_w,'A','');
				ds_hora_w	:= replace(ds_hora_w,'A','');

				dt_horario_w	:= pkg_date_utils.get_time(dt_inicio_prescr_w + qt_dia_adic_w, replace(ds_hora_w, 'A', ''), 0);
				
				if (ie_solucao_p = 'N') then
					if (coalesce(dt_horario_consist_w::text, '') = '') then
						dt_horario_consist_w  := dt_horario_w;
					elsif (coalesce(dt_horario_consist_ww::text, '') = '') then
						dt_horario_consist_ww := dt_horario_w;
					end if;
				end if;
				
				qt_total_dose_adm_w	:= 0;
				
				if ((pkg_date_utils.get_DiffDate(dt_horario_consist_w, dt_horario_w, 'HOUR') < 24) or (qt_total_dose_pres_w = 0) or (ie_solucao_p = 'S')) then
					qt_total_dose_pres_w	:= qt_total_dose_pres_w + obter_conversao_unid_med_cons(cd_material_w,cd_unid_med_dose_w,qt_dose_w);
										
				elsif (ie_solucao_p = 'N') then
					qt_total_dose_pres_w	:= obter_conversao_unid_med_cons(cd_material_w,cd_unid_med_dose_w,qt_dose_w);
					dt_horario_consist_w	:= dt_horario_consist_ww;
					dt_horario_consist_ww	:= null;
				end if;
					
				if (trunc(qt_total_dose_pres_w,3) > trunc(qt_dose_limite_p,3)) then
				
					ds_retorno_w := 'NP';
					
					for for_c02_w in c02
					loop
						qt_total_dose_adm_w	:= qt_total_dose_adm_w + obter_conversao_unid_med_cons(cd_material_w,for_c02_w.cd_unidade_medida_dose,for_c02_w.qt_dose );
										
						if ((trunc(qt_total_dose_pres_w,3) + trunc(qt_total_dose_adm_w,3)) > trunc(qt_dose_limite_p,3)) then
							ds_retorno_w	:=  obter_desc_expressao(782500)/*'NA-qtd'*/
||to_char(coalesce(qt_total_dose_adm_w,0));
						end if;
					
					end loop;				

				end if;
				
				if (ds_retorno_w = 'S') then
					
					if (hr_dose_especial_ww IS NOT NULL AND hr_dose_especial_ww::text <> '') and (coalesce(qt_dose_especial_w,0) > 0) and
					   (hr_dose_especial_www between(dt_horario_w - 1) + (1/86000) and (dt_horario_w) + (1/86000))then		
						
						qt_total_dose_pres_w := qt_total_dose_pres_w + obter_conversao_unid_med_cons(cd_material_w,cd_unid_med_dose_w,qt_dose_especial_w);
						qt_dose_especial_w := 0;
					end if;
					
					for for_c02_w in c02
					loop
						qt_total_dose_adm_w	:= qt_total_dose_adm_w + obter_conversao_unid_med_cons(cd_material_w,for_c02_w.cd_unidade_medida_dose,for_c02_w.qt_dose );
										
						if ((trunc(qt_total_dose_pres_w,3) + trunc(qt_total_dose_adm_w,3)) > trunc(qt_dose_limite_p,3)) then
							ds_retorno_w	:=  obter_desc_expressao(782500)/*'NA-qtd'*/
||to_char(coalesce(qt_total_dose_adm_w,0));
						end if;
					end loop;			
				end if;
			end;
			elsif (ds_horarios_w IS NOT NULL AND ds_horarios_w::text <> '') then				
				ds_horarios_w		:= '';
			end if;
		end;
		end loop;
		
	elsif (dt_aprazamento_p IS NOT NULL AND dt_aprazamento_p::text <> '' AND ie_solucao_p = 'N')then
	
		qt_total_dose_pres_w	:= obter_conversao_unid_med_cons(cd_material_w,cd_unid_med_dose_w,qt_dose_w);
		qt_total_dose_adm_w	:= 0;
		dt_horario_w	:= dt_aprazamento_p;
		
		if (trunc(qt_total_dose_pres_w,3) > trunc(qt_dose_limite_p,3)) then
		
			ds_retorno_w := 'NP';
			
			for for_c02_w in c02
			loop
				qt_total_dose_adm_w	:= qt_total_dose_adm_w + obter_conversao_unid_med_cons(cd_material_w,for_c02_w.cd_unidade_medida_dose,for_c02_w.qt_dose );
								
				if ((trunc(qt_total_dose_pres_w,3) + trunc(qt_total_dose_adm_w,3)) > trunc(qt_dose_limite_p,3)) then
					ds_retorno_w	:=  obter_desc_expressao(782500)/*'NA-qtd'*/
||to_char(coalesce(qt_total_dose_adm_w,0));
				end if;
			end loop;	
		end if;	

		if (ds_retorno_w = 'S') then

			for for_c02_w in c02
			loop
				qt_total_dose_adm_w	:= qt_total_dose_adm_w + obter_conversao_unid_med_cons(cd_material_w,for_c02_w.cd_unidade_medida_dose,for_c02_w.qt_dose );
								
				if ((trunc(qt_total_dose_pres_w,3) + trunc(qt_total_dose_adm_w,3)) > trunc(qt_dose_limite_p,3)) then
					ds_retorno_w	:=  obter_desc_expressao(782500)/*'NA-qtd'*/
||to_char(coalesce(qt_total_dose_adm_w,0));
				end if;
			end loop;	
		end if;
	end if;
end;

begin

select	dt_inicio_prescr		
into STRICT	dt_inicio_prescr_w
from	prescr_medica
where	nr_prescricao	= nr_prescricao_p;

if (ie_solucao_p = 'N') then
	
	if (ie_delphijava_p = 'S') then
						
		qt_total_dose_pres_w	:= 0;
	
		obter_dose_extra(cd_material_p,
						qt_dose_p,
						cd_unidade_medida_dose_p,
						ds_horarios_p,
						ie_urgencia_p,
						'N',
						null,
						null);	
	else
	
		select 	max(cd_material),
				max(qt_dose),
				max(cd_unidade_medida_dose),
				max(ds_horarios),
				coalesce(max(ie_urgencia),'N'),
				max(ie_agrupador),
				max(qt_dose_especial),
				max(hr_dose_especial)
		into STRICT	cd_material_w,
				qt_dose_w,
				cd_unid_med_dose_w,
				ds_horarios_w,
				ie_urgente_w,
				ie_agrupador_w,
				qt_dose_especial_w,
				hr_dose_especial_w
		from   	prescr_material
		where  	nr_prescricao	= nr_prescricao_p
		and		nr_sequencia	= nr_seq_material_p
		and		coalesce(nr_sequencia_solucao::text, '') = '';
		
		qt_total_dose_pres_w	:= 0;
		
		obter_dose_extra(cd_material_w,
							qt_dose_w,
							cd_unid_med_dose_w,
							ds_horarios_w,
							ie_urgente_w,
							'N',
							qt_dose_especial_w,
							hr_dose_especial_w);	
	end if;					
						
	open c04;
	loop
	fetch c04 into	
		cd_material_w,
		qt_dose_w,
		cd_unid_med_dose_w,
		ds_horarios_w,
		ie_urgente_w;
	EXIT WHEN NOT FOUND; /* apply on c04 */
		begin
		
			obter_dose_extra(cd_material_w,
							qt_dose_w,
							cd_unid_med_dose_w,
							ds_horarios_w,
							ie_urgente_w,
							'S',
							null,
							null);
	    end;
	end loop;
	close c04;
	
	if ((ie_agrupador_w in (8,12)) or (ie_delphijava_p = 'S')) then
	
		open c05;
		loop
		fetch c05 into	
			cd_material_w,
			qt_dose_w,
			cd_unid_med_dose_w,
			ds_horarios_w,
			ie_urgente_w,
			nr_sequencia_solucao_w;
		EXIT WHEN NOT FOUND; /* apply on c05 */
			begin
			
				obter_dose_extra(cd_material_w,
								qt_dose_w,
								cd_unid_med_dose_w,
								ds_horarios_w,
								ie_urgente_w,
								'N',
								null,
								null);
			end;					
		end loop;
		close c05;
	end if;

else

	open c03;
	loop
	fetch c03 into	
		cd_material_w,
		qt_dose_w,
		cd_unid_med_dose_w,
		ds_horarios_w,
		ie_urgente_w;
	EXIT WHEN NOT FOUND; /* apply on c03 */
		begin
		
			qt_total_dose_pres_w	:= 0;
			
			obter_dose_extra(cd_material_w,
							qt_dose_w,
							cd_unid_med_dose_w,
							ds_horarios_w,
							ie_urgente_w,
							'S',
							null,
							null);
							
			open c05;
			loop
			fetch c05 into	
				cd_material_w,
				qt_dose_w,
				cd_unid_med_dose_w,
				ds_horarios_w,
				ie_urgente_w,
				nr_sequencia_solucao_w;
			EXIT WHEN NOT FOUND; /* apply on c05 */
				begin
				
					if (nr_sequencia_solucao_w IS NOT NULL AND nr_sequencia_solucao_w::text <> '') then
					
						select	max(ds_horarios),
								max(ie_urgencia)
						into STRICT	ds_horarios_w,
								ie_urgencia_w
						from 	prescr_solucao
						where	nr_prescricao = nr_prescricao_p
						and 	nr_seq_solucao = nr_sequencia_solucao_w;
						
						obter_dose_extra(cd_material_w,
										qt_dose_w,
										cd_unid_med_dose_w,
										ds_horarios_w,
										ie_urgente_w,
										'S',
										null,
										null);
					else
					
						obter_dose_extra(cd_material_w,
										qt_dose_w,
										cd_unid_med_dose_w,
										ds_horarios_w,
										ie_urgente_w,
										'N',
										null,
										null);
					end if;				
			    end;
			end loop;
			close c05;
		end;
	end loop;
	close c03;

end if;

return ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION consiste_dose_periodo_ant ( nr_atendimento_p bigint, nr_prescricao_p bigint, nr_seq_material_p bigint, qt_dose_limite_p bigint, ie_solucao_p text, dt_aprazamento_p timestamp, cd_material_p bigint, qt_dose_p bigint, cd_unidade_medida_dose_p text, ds_horarios_p text, ie_urgencia_p text, ie_delphijava_p text) FROM PUBLIC;

