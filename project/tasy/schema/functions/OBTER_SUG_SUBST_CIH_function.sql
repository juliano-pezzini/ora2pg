-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_sug_subst_cih ( nr_prescricao_p bigint, nr_seq_material_p bigint, nm_usuario_p text) RETURNS varchar AS $body$
DECLARE


ds_retorno_w			varchar(4000);
cd_material_w			prescr_material.cd_material%type;
cd_material_2w			prescr_material.cd_material%type;
qt_dose_w				prescr_material.qt_dose%type;
qt_dose_2w				prescr_material.qt_dose%type;
cd_unid_med_w			prescr_material.cd_unidade_medida_dose%type;
cd_unid_med_2w			prescr_material.cd_unidade_medida_dose%type;
qt_dias_solic_w			prescr_material.qt_dias_solicitado%type;
qt_dias_solic_2w		prescr_material.qt_dias_solicitado%type;
qt_dias_lib_w			prescr_material.qt_dias_liberado%type;
qt_dias_lib_2w			prescr_material.qt_dias_liberado%type;
cd_intervalo_w			intervalo_prescricao.cd_intervalo%type;
cd_intervalo_2w			intervalo_prescricao.cd_intervalo%type;
ie_via_aplicacao_w		prescr_material.ie_via_aplicacao%type;
ie_via_aplicacao_2w		prescr_material.ie_via_aplicacao%type;
ds_material_w			varchar(255);
ds_material_2w			varchar(255);
ds_usuario_w			varchar(255);


BEGIN

if (nr_prescricao_p IS NOT NULL AND nr_prescricao_p::text <> '') and (nr_seq_material_p IS NOT NULL AND nr_seq_material_p::text <> '') then

	select 	max(a.cd_material),
		obter_desc_material(max(a.cd_material)),
		max(a.cd_unidade_medida_dose),
		max(a.ie_via_aplicacao),
		max(a.cd_intervalo),
		max(a.qt_dose),
		max(a.qt_dias_liberado),
		max(a.qt_dias_solicitado)
	into STRICT	cd_material_w,
		ds_material_w,
		cd_unid_med_w,
		ie_via_aplicacao_w,
		cd_intervalo_w,
		qt_dose_w,
		qt_dias_lib_w,
		qt_dias_solic_w
	from 	prescr_material a
	where 	a.nr_prescricao  = nr_prescricao_p
	and	a.nr_sequencia    	= nr_seq_material_p;

	select 	max(a.cd_material_substituicao),
		obter_desc_material(max(a.cd_material_substituicao)),
		max(a.cd_unidade_medida_dose),
		max(a.ie_via_aplicacao),
		max(a.cd_intervalo),
		max(a.qt_dose),
		max(a.qt_dias_liberado),
		max(a.qt_dias_solicitado)
	into STRICT	cd_material_2w,
		ds_material_2w,
		cd_unid_med_2w,
		ie_via_aplicacao_2w,
		cd_intervalo_2w,
		qt_dose_2w,
		qt_dias_lib_2w,
		qt_dias_solic_2w
	from 	medicamento_cih_sug a
	where 	a.nr_prescricao  = nr_prescricao_p
	and	a.nr_seq_material    = nr_seq_material_p;

end if;

ds_usuario_w	:= obter_desc_usuario(nm_usuario_p);

ds_retorno_w	:= wheb_mensagem_pck.get_texto(817717,'DS_USUARIO='||ds_usuario_w||';DS_MATERIAL='|| ds_material_w ||
';QT_DOSE=' || qt_dose_w || ';DS_UNID_MED=' ||cd_unid_med_w || ';DS_INTERVALO='|| obter_desc_intervalo_prescr(cd_intervalo_w) || ';DS_VIA='|| obter_desc_via(ie_via_aplicacao_2w) ||
';QT_DIAS='||qt_dias_solic_w||';DS_MATERIAL_2='|| ds_material_2w || ';QT_DOSE_2='|| qt_dose_2w || ';DS_UNID_MED_2=' || cd_unid_med_2w ||
  ';DS_INTERVALO_2='|| obter_desc_intervalo_prescr(cd_intervalo_2w) || ';DS_VIA_2='|| obter_desc_via(ie_via_aplicacao_2w) || ';QT_DIAS_2='|| coalesce(qt_dias_lib_2w,qt_dias_solic_w));
  /*O Infectologista #@DS_USUARIO#@  sugere que: O item da prescrição original: #@DS_MATERIAL#@  com dose: #@QT_DOSE#@ #@DS_UNID_MED#@ #@DS_INTERVALO#@ e via #@DS_VIA#@, solicitado por #@QT_DIAS#@ dias(s)
    Deva ser substituido por:  #@DS_MATERIAL_2#@ com dose: #@QT_DOSE_2#@ #@DS_UNID_MED_2#@ #@DS_INTERVALO_2#@ e via #@DS_VIA_2#@, sendo liberado por #@QT_DIAS_2#@ dias(s) */
/*ds_retorno_w	:=  'Medicamento: ' 	  || cd_material_w 			|| ' - '  				  || ds_material_w 		 || chr(13) || chr(10)||
					'Dose: ' 			  || qt_dose_w 	            || '   ' 				  || cd_unid_med_w 		 || chr(13) || chr(10) ||
					'Via Aplicação: ' 	  || obter_desc_via(ie_via_aplicacao_w) 			  ||  chr(13) || chr(10) ||
					'Intervalo: ' 		  || obter_desc_intervalo_prescr(cd_intervalo_w) 	  ||  chr(13) || chr(10) ||
					'Dias Solicitados: '  || qt_dias_solic_w   		 						  ||  chr(13) || chr(10) ||
					'Dias Liberados: '    || qt_dias_lib_w;   */
return ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_sug_subst_cih ( nr_prescricao_p bigint, nr_seq_material_p bigint, nm_usuario_p text) FROM PUBLIC;

