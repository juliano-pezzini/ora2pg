-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_se_mostra_comunic ( nr_sequencia_p bigint, nm_usuario_p text, ie_lida_p text, ie_gerencial_p text, nr_seq_classif_p bigint) RETURNS varchar AS $body$
DECLARE


ie_mostra_w		varchar(001)	:= 'S';

nm_usuario_w		varchar(15);
nm_usuario_ww		varchar(15);
nm_usuario_www		varchar(2000);
ie_geral_w		varchar(01);
nm_usuario_dest_w		varchar(4000);
ds_setor_adicional_w	varchar(2000);
ie_gerencial_w		varchar(01);
nr_seq_classif_w		bigint;
ds_perfil_adic_w		varchar(4000);
cd_perfil_w		bigint;
qt_classif_w		integer;
qt_classif_ww		integer;
ie_tipo_classif_w		varchar(01);
ie_pessoal_w		varchar(01);
cd_setor_w		integer;
cd_estab_w		integer;
cont_w			integer;
ie_Usuario_Dest_w		varchar(01);
cd_setor_ww		integer;
cd_estab_ww		integer;
cd_posicao_w		varchar(10) := ' ';
qt_posicao_w		bigint;
ds_grupo_w		varchar(255);
nr_seq_grupo_w		bigint;
nm_usuario_oculto_w	varchar(15);
qt_controle_w		bigint;


BEGIN

/*select	cd_setor_atendimento,
	cd_estabelecimento
into	cd_setor_ww,
	cd_estab_ww
from 	Usuario
where	nm_usuario		= nm_usuario_p;*/
/*Coelho 01/04/2009 - OS133231*/

cd_setor_ww := wheb_usuario_pck.get_cd_setor_atendimento;
cd_estab_ww := wheb_usuario_pck.get_cd_estabelecimento;


select	nm_usuario,
	coalesce(ie_geral,'N'),
	nm_usuario_destino,
	coalesce(ie_gerencial,'N'),
	cd_perfil,
	coalesce(nr_seq_classif,0),
	ds_perfil_adicional,
	ds_setor_adicional,
	cd_setor_destino,
	cd_estab_destino,
	ds_grupo,
	nm_usuario_oculto
into STRICT	nm_usuario_w,
	ie_geral_w,
	nm_usuario_dest_w,
	ie_gerencial_w,
	cd_perfil_w,
	nr_seq_classif_w,
	ds_perfil_adic_w,
	ds_setor_adicional_w,
	cd_setor_w,
	cd_estab_w,
	ds_grupo_w,
	nm_usuario_oculto_w
from 	comunic_interna
where	nr_sequencia	= nr_sequencia_p;

ie_Usuario_Dest_w		:= 'N';
qt_posicao_w			:= 99999;
if (nm_usuario_dest_w IS NOT NULL AND nm_usuario_dest_w::text <> '') and (nm_usuario_dest_w like '%' || nm_usuario_p  || '%') then
	nm_usuario_dest_w	:= replace(nm_usuario_dest_w, ' ', '') || ',';
	nm_usuario_ww		:= replace(nm_usuario_p,' ', '');
	qt_controle_w		:= 0;
	while( qt_posicao_w <> 0 ) and ( ie_usuario_dest_w <> 'S' ) and ( qt_controle_w < 500 ) loop
		qt_controle_w := qt_controle_w + 1;
		qt_posicao_w := position(',' in nm_usuario_dest_w);
		if (qt_posicao_w <> 0) then
			nm_usuario_www	:= substr(nm_usuario_dest_w, 1, qt_posicao_w -1);
			nm_usuario_dest_w	:= substr(nm_usuario_dest_w, qt_posicao_w + 1, 2000);
			if (nm_usuario_www = nm_usuario_ww) then
				ie_usuario_dest_w	:= 'S';
			end if;
		end if;
	end loop;
end if;

ie_mostra_w			:= 'N';
ie_pessoal_w			:= ie_mostra_w;
if (nm_usuario_p	= nm_usuario_w) then
	ie_mostra_w		:= 'S';
	ie_pessoal_w		:= ie_mostra_w;
elsif (nm_usuario_p	= nm_usuario_oculto_w) then
	ie_mostra_w		:= 'S';
	ie_pessoal_w		:= ie_mostra_w;
elsif (ie_Usuario_Dest_w	= 'S') then
	ie_mostra_w		:= 'S';
	ie_pessoal_w		:= ie_mostra_w;
elsif (ie_geral_w		= 'S') then
	ie_mostra_w		:= 'S';
elsif	((ds_perfil_adic_w IS NOT NULL AND ds_perfil_adic_w::text <> '') or (ds_setor_adicional_w IS NOT NULL AND ds_setor_adicional_w::text <> '') or (ds_grupo_w IS NOT NULL AND ds_grupo_w::text <> '')) and (ie_mostra_w <> 'S') then

	begin
	if (ds_perfil_adic_w IS NOT NULL AND ds_perfil_adic_w::text <> '') and (ie_mostra_w <> 'S') then
		begin
		qt_controle_w		:= 0;
		while(cd_posicao_w <> '0') and (ie_mostra_w <> 'S')  and (qt_controle_w < 500) loop
			begin
			qt_controle_w 	:= qt_controle_w + 1;
			cd_posicao_w	:= position(',' in ds_perfil_adic_w);
			if (somente_numero(substr(ds_perfil_adic_w,1,250)) > 0) then
				if (coalesce(cd_posicao_w,'0') = '0') then
					cd_perfil_w	:= somente_numero(ds_perfil_adic_w);
				else
					cd_perfil_w	:= somente_numero(substr(ds_perfil_adic_w,1,cd_posicao_w-1));
				end if;
			end if;

			select	coalesce(max('S'),'N')
			into STRICT	ie_mostra_w
			from	Usuario_perfil
			where	nm_usuario	= nm_usuario_p
			and	cd_perfil	= cd_perfil_w;

			ds_perfil_adic_w	:= substr(ds_perfil_adic_w,(cd_posicao_w)::numeric  + 1,length(ds_perfil_adic_w));

			end;
		end loop;
		end;
	end if;

	if (ds_setor_adicional_w IS NOT NULL AND ds_setor_adicional_w::text <> '') and (ie_mostra_w <> 'S') then
		begin
		cd_posicao_w	:= ' ';
		qt_controle_w	:= 0;
		while(cd_posicao_w <> '0') and (ie_mostra_w <> 'S' ) and (qt_controle_w < 500 ) loop
			begin
			qt_controle_w 	:= qt_controle_w + 1;
			cd_posicao_w 	:= position(',' in ds_setor_adicional_w);
			cd_setor_w	:= campo_numerico(substr(ds_setor_adicional_w,1,cd_posicao_w-1));

			select	coalesce(max('S'),'N')
			into STRICT	ie_mostra_w
			from 	Usuario
			where	nm_usuario		= nm_usuario_p
			and	cd_setor_atendimento	= cd_setor_w;

			ds_setor_adicional_w	:= substr(ds_setor_adicional_w,(cd_posicao_w)::numeric  + 1,length(ds_setor_adicional_w));

			end;
		end loop;

		end;
	end if;

	if (ds_grupo_w IS NOT NULL AND ds_grupo_w::text <> '') and 		-- Edgar 15/02/2005, OS 15007, fiz rotina abaixo
		(ie_mostra_w <> 'S') then

		cd_posicao_w	:= ' ';
		qt_controle_w	:= 0;
		while(cd_posicao_w <> '0') and (ie_mostra_w <> 'S') and (qt_controle_w < 500) loop
			qt_controle_w := qt_controle_w + 1;
			cd_posicao_w	:= position(',' in ds_grupo_w);
			if (somente_numero(ds_grupo_w) > 0) then -- Francisco 14/08/2005 OS 39156
				if (coalesce(cd_posicao_w,'0') = '0') then	-- Edgar 11/08/2005 OS 22009 tratamento se não tiver vírgula
					nr_seq_grupo_w	:= (ds_grupo_w)::numeric;
				else
					nr_seq_grupo_w	:= (substr(ds_grupo_w,1,cd_posicao_w-1))::numeric;
				end if;
			end if;

			select	coalesce(max('S'),'N')
			into STRICT	ie_mostra_w
			from 	usuario_grupo
			where	nm_usuario_grupo	= nm_usuario_p
			and	nr_seq_grupo		= nr_seq_grupo_w;

			ds_grupo_w	:= coalesce(substr(ds_grupo_w,(cd_posicao_w)::numeric  + 1,length(ds_grupo_w)), ' ');
			select	CASE WHEN ds_grupo_w=' ' THEN '0'  ELSE ds_grupo_w END
			into STRICT	ds_grupo_w
			;
			/*Fabio OS_22072 23/08/2005*/

		end loop;
	end if;

	end;
end if;

/* Inclui este select para ver se o usuário tem o estabelecimento da mensagem liberado */

/*select	count(*)
into	cont_w
from	USUARIO_ESTABELECIMENTO
where	nm_usuario_param	= nm_usuario_p
and	cd_estabelecimento	= cd_estab_w;*/
cont_w := 0;
/*OS133235 Coelho - 01/04/2009*/

if ( wheb_usuario_pck.obter_se_estab_lib_usuario(cd_estab_w) = 'S' ) then
	cont_w := 1;
end if;

if (ie_pessoal_w	= 'N') and (ie_mostra_w	= 'S') and (cont_w = 0) and (coalesce(cd_estab_w,cd_estab_ww) <> cd_estab_ww) then
	ie_mostra_w		:= 'N';
end if;

if (ie_mostra_w	= 'S') and (ie_lida_p	= 'S') then
	select	coalesce(max('N'),'S')
	into STRICT	ie_mostra_w
	from	comunic_interna_lida
	where	nr_sequencia	= nr_sequencia_p
	and	nm_usuario	= nm_usuario_p;
end if;

if (ie_pessoal_w	= 'N') and (ie_mostra_w	= 'S') and (ie_gerencial_p	= 'S') then
	ie_mostra_w		:= ie_gerencial_w;
end if;

if (ie_pessoal_w	= 'N') and (ie_mostra_w	= 'S') and (coalesce(nr_seq_classif_p,0) > 0) and (coalesce(nr_seq_classif_w,0) > 0) and (coalesce(nr_seq_classif_w,0) <> coalesce(nr_seq_classif_p,0)) then
	ie_mostra_w		:= 'N';
end if;

if (ie_pessoal_w	= 'N') and (ie_mostra_w	= 'S') and (coalesce(nr_seq_classif_w,0) > 0) and (coalesce(nr_seq_classif_p,0) = 0) then
	begin

	select	coalesce(max(ie_tipo),'U')
	into STRICT	ie_tipo_classif_w
	from	comunic_interna_classif
	where	nr_sequencia	= nr_seq_classif_w;

	if (ie_tipo_classif_w <> 'G') and (ie_tipo_classif_w <> 'F') then

		select	count(*),
			sum(CASE WHEN nr_seq_classif_comunic=nr_seq_classif_w THEN 1  ELSE 0 END )
		into STRICT 	qt_classif_w,
			qt_classif_ww
		from	Usuario_comunic_Classif
		where	nm_usuario = nm_usuario_p;

		if (qt_classif_w > 0) and (qt_classif_ww = 0) then
			ie_mostra_w	:= 'N';
		end if;
	end if;
	end;
end if;

return	coalesce(ie_mostra_w,'N');

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_se_mostra_comunic ( nr_sequencia_p bigint, nm_usuario_p text, ie_lida_p text, ie_gerencial_p text, nr_seq_classif_p bigint) FROM PUBLIC;

