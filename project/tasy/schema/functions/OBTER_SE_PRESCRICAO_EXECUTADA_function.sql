-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_se_prescricao_executada (nr_seq_etapa_pac_p bigint) RETURNS varchar AS $body$
DECLARE


  c1 CURSOR FOR
    SELECT e.nr_prescricao
      FROM gqa_protocolo_etapa_pac e
     WHERE e.nr_seq_prot_pac =
           (SELECT te.nr_seq_prot_pac
              FROM gqa_protocolo_etapa_pac te
             WHERE te.nr_sequencia = nr_seq_etapa_pac_p)
       AND e.nr_seq_acao =
           (SELECT a.nr_sequencia
              FROM gqa_acao a
             WHERE a.nr_seq_pend_regra =
                   (SELECT ta.nr_seq_acao_protocolo
                      FROM gqa_acao ta
                     WHERE ta.nr_sequencia =
                           (SELECT te.nr_seq_acao
                              FROM gqa_protocolo_etapa_pac te
                             WHERE te.nr_sequencia = nr_seq_etapa_pac_p)));

  qt_pendente_w  bigint;
  qt_total_w     bigint;
BEGIN
  FOR r1 IN c1 LOOP
    SELECT COUNT(CASE WHEN coalesce(x.dt_fim_horario::text, '') = '' AND coalesce(x.dt_suspensao::text, '') = '' THEN 1 END) qt_pendente
          ,COUNT(1) qt_total
      INTO STRICT qt_pendente_w
          ,qt_total_w
      FROM (SELECT t.dt_fim_horario
                  ,t.dt_suspensao
              FROM prescr_mat_hor t
             WHERE t.nr_prescricao = r1.nr_prescricao
			 and t.ie_horario_especial <> 'S'

UNION ALL

            SELECT t.dt_fim_horario
                  ,t.dt_suspensao
              FROM prescr_proc_hor t
             WHERE t.nr_prescricao = r1.nr_prescricao
			 and t.ie_horario_especial <> 'S'
            
UNION ALL

            SELECT t.dt_fim_horario
                  ,t.dt_suspensao
              FROM prescr_rec_hor t
             WHERE t.nr_prescricao = r1.nr_prescricao
			 and t.ie_horario_especial <> 'S'
            
UNION ALL

            SELECT t.dt_fim_horario
                  ,t.dt_suspensao
              FROM prescr_gasoterapia_hor t
             WHERE t.nr_prescricao = r1.nr_prescricao
			 and t.ie_horario_especial <> 'S') x;

    IF qt_total_w > 0 AND qt_pendente_w = 0 THEN
      RETURN 'S';
    END IF;
  END LOOP;

  RETURN 'N';
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_se_prescricao_executada (nr_seq_etapa_pac_p bigint) FROM PUBLIC;

