-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_valores_conpaci_guia (nr_interno_conta_p bigint, cd_autorizacao_p text, cd_convenio_p bigint, ie_valor_p text) RETURNS bigint AS $body$
DECLARE

				 
/* 
VC	- Valor da guia 
VP	- Valor pago 
VG	- Valor glosado 
VM	- Valor amenor 
VA	- Valor adicional 
*/
 
 
nr_seq_ultimo_ret_w	bigint;
nr_seq_ultimo_item_w	bigint;
nr_seq_ultima_analise_w	bigint;
nr_seq_ultima_guia_w	bigint;
vl_retorno_w		double precision;
				

BEGIN 
 
if (ie_valor_p	= 'VC') then 
 
	select	coalesce(sum(a.vl_guia),0) 
	into STRICT	vl_retorno_w 
	from	conta_paciente b, 
		conta_paciente_guia a 
	where	b.cd_convenio_parametro	= coalesce(cd_convenio_p,b.cd_convenio_parametro) 
	and	a.nr_interno_conta		= b.nr_interno_conta 
	--and	(nvl(a.cd_autorizacao,'Não Informada') = nvl(cd_autorizacao_p,'Não Informada') or a.nr_interno_conta = somente_numero(cd_autorizacao_p)) 
	and (coalesce(a.cd_autorizacao,WHEB_MENSAGEM_PCK.get_texto(298671)) = coalesce(cd_autorizacao_p,WHEB_MENSAGEM_PCK.get_texto(298671)) or a.nr_interno_conta = somente_numero(cd_autorizacao_p))	 
	and	a.nr_interno_conta		= nr_interno_conta_p;
 
elsif (ie_valor_p	= 'VP') then 
 
	select	coalesce(sum(vl_pago),0) 
	into STRICT	vl_retorno_w 
	from ( 
		SELECT	a.vl_pago 
		from	convenio_retorno b, 
			convenio_retorno_item a 
		where	b.cd_convenio	= coalesce(cd_convenio_p,b.cd_convenio) 
		and	a.nr_seq_retorno	= b.nr_sequencia 
		--and	nvl(a.cd_autorizacao,'Não Informada')	= nvl(cd_autorizacao_p,nvl(a.cd_autorizacao,'Não Informada')) 
		and	coalesce(a.cd_autorizacao,WHEB_MENSAGEM_PCK.get_texto(298671))	= coalesce(cd_autorizacao_p,coalesce(a.cd_autorizacao,WHEB_MENSAGEM_PCK.get_texto(298671)))		 
		and	a.nr_interno_conta	= nr_interno_conta_p 
		
union all
 
		SELECT	d.vl_pago 
		from	lote_audit_hist_item d, 
			lote_audit_hist_guia c, 
			lote_audit_hist b, 
			lote_auditoria a 
		where	c.nr_sequencia	= d.nr_seq_guia 
		--and	nvl(c.cd_autorizacao,'Não Informada')	= nvl(cd_autorizacao_p,nvl(c.cd_autorizacao,'Não Informada')) 
		and	coalesce(c.cd_autorizacao,WHEB_MENSAGEM_PCK.get_texto(298671))	= coalesce(cd_autorizacao_p,coalesce(c.cd_autorizacao,WHEB_MENSAGEM_PCK.get_texto(298671)))		 
		and	c.nr_interno_conta	= nr_interno_conta_p 
		and	b.nr_sequencia	= c.nr_seq_lote_hist 
		and	a.nr_sequencia	= b.nr_seq_lote_audit 
		and	a.cd_convenio	= coalesce(cd_convenio_p,a.cd_convenio)) alias15;
 
elsif (ie_valor_p	= 'VG') then 
 
	select	coalesce(sum(vl_glosa),0) 
	into STRICT	vl_retorno_w 
	from ( 
		SELECT	a.vl_glosado vl_glosa 
		from	convenio_retorno b, 
			convenio_retorno_item a 
		where	b.cd_convenio	= coalesce(cd_convenio_p,b.cd_convenio) 
		and	a.nr_seq_retorno	= b.nr_sequencia 
		--and	nvl(a.cd_autorizacao,'Não Informada')	= nvl(cd_autorizacao_p,nvl(a.cd_autorizacao,'Não Informada')) 
		and	coalesce(a.cd_autorizacao,WHEB_MENSAGEM_PCK.get_texto(298671))	= coalesce(cd_autorizacao_p,coalesce(a.cd_autorizacao,WHEB_MENSAGEM_PCK.get_texto(298671)))		 
		and	a.nr_interno_conta	= nr_interno_conta_p 
		
union all
 
		SELECT	d.vl_glosa 
		from	lote_audit_hist_item d, 
			lote_audit_hist_guia c, 
			lote_audit_hist b, 
			lote_auditoria a 
		where	c.nr_sequencia	= d.nr_seq_guia 
		--and	nvl(c.cd_autorizacao,'Não Informada')	= nvl(cd_autorizacao_p,nvl(c.cd_autorizacao,'Não Informada')) 
		and	coalesce(c.cd_autorizacao,WHEB_MENSAGEM_PCK.get_texto(298671))	= coalesce(cd_autorizacao_p,coalesce(c.cd_autorizacao,WHEB_MENSAGEM_PCK.get_texto(298671)))		 
		and	c.nr_interno_conta	= nr_interno_conta_p 
		and	b.nr_sequencia	= c.nr_seq_lote_hist 
		and	a.nr_sequencia	= b.nr_seq_lote_audit 
		and	a.cd_convenio	= coalesce(cd_convenio_p,a.cd_convenio)) alias15;
 
elsif (ie_valor_p	= 'VM') then 
 
	select	max(b.nr_sequencia) 
	into STRICT	nr_seq_ultimo_ret_w 
	from	convenio_retorno b, 
		convenio_retorno_item a 
	where	b.cd_convenio	= coalesce(cd_convenio_p,b.cd_convenio) 
	and	a.nr_seq_retorno	= b.nr_sequencia 
	--and	nvl(a.cd_autorizacao,'Não Informada')	= nvl(cd_autorizacao_p,'Não Informada') 
	and	coalesce(a.cd_autorizacao,WHEB_MENSAGEM_PCK.get_texto(298671))	= coalesce(cd_autorizacao_p,WHEB_MENSAGEM_PCK.get_texto(298671))	 
	and	a.nr_interno_conta	= nr_interno_conta_p;
 
	select	max(a.nr_sequencia) 
	into STRICT	nr_seq_ultimo_item_w 
	from	convenio_retorno_item a 
	
	where	coalesce(a.cd_autorizacao,WHEB_MENSAGEM_PCK.get_texto(298671))	= coalesce(cd_autorizacao_p,WHEB_MENSAGEM_PCK.get_texto(298671))	 
	and	a.nr_interno_conta	= nr_interno_conta_p 
	and	a.nr_seq_retorno	= nr_seq_ultimo_ret_w;
 
	select	max(b.nr_sequencia) 
	into STRICT	nr_seq_ultima_analise_w 
	from	lote_audit_hist_guia c, 
		lote_audit_hist b, 
		lote_auditoria a 
	
	where	coalesce(c.cd_autorizacao,WHEB_MENSAGEM_PCK.get_texto(298671))	= coalesce(cd_autorizacao_p,WHEB_MENSAGEM_PCK.get_texto(298671))	 
	and	c.nr_interno_conta	= nr_interno_conta_p 
	and	b.nr_sequencia	= c.nr_seq_lote_hist 
	and	a.nr_sequencia	= b.nr_seq_lote_audit 
	and	a.cd_convenio	= coalesce(cd_convenio_p,a.cd_convenio);
 
	select	max(a.nr_sequencia) 
	into STRICT	nr_seq_ultima_guia_w 
	from	lote_audit_hist_guia a 
	
	where	coalesce(a.cd_autorizacao,WHEB_MENSAGEM_PCK.get_texto(298671))	= coalesce(cd_autorizacao_p,WHEB_MENSAGEM_PCK.get_texto(298671))	 
	and	a.nr_interno_conta	= nr_interno_conta_p 
	and	a.nr_seq_lote_hist	= nr_seq_ultima_analise_w;
 
	select	coalesce(sum(vl_amenor),0) 
	into STRICT	vl_retorno_w 
	from ( 
		SELECT	a.vl_amenor vl_amenor 
		from	convenio_retorno_item a 
		where	a.nr_sequencia	= nr_seq_ultimo_item_w 
		
union all
 
		SELECT	b.vl_amenor 
		from	lote_audit_hist_item b, 
			lote_audit_hist_guia a 
		where	a.nr_sequencia	= b.nr_seq_guia 
		and	a.nr_sequencia	= nr_seq_ultima_guia_w) alias2;
 
elsif (ie_valor_p	= 'VA') then 
 
	select	coalesce(sum(a.vl_adicional),0) 
	into STRICT	vl_retorno_w 
	from	convenio_retorno b, 
		convenio_retorno_item a 
	where	b.cd_convenio	= coalesce(cd_convenio_p,b.cd_convenio) 
	and	a.nr_seq_retorno	= b.nr_sequencia 
	--and	nvl(a.cd_autorizacao,'Não Informada')	= nvl(cd_autorizacao_p,'Não Informada') 
	and	coalesce(a.cd_autorizacao,WHEB_MENSAGEM_PCK.get_texto(298671))	= coalesce(cd_autorizacao_p,WHEB_MENSAGEM_PCK.get_texto(298671))	 
	and	a.nr_interno_conta	= nr_interno_conta_p;
 
end if;
 
return vl_retorno_w;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_valores_conpaci_guia (nr_interno_conta_p bigint, cd_autorizacao_p text, cd_convenio_p bigint, ie_valor_p text) FROM PUBLIC;

