-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION tax_get_ecf_classification (top_classification_p conta_contabil_classif.cd_classificacao%type, account_account_p conta_contabil_classif.cd_conta_contabil%type, effective_date_p conta_contabil_classif.dt_inicio_vigencia%type) RETURNS CONTA_CONTABIL_CLASSIF.CD_CLASSIFICACAO%TYPE AS $body$
DECLARE


classification_w conta_contabil_classif.cd_classificacao%type;


BEGIN
  select  max(cd_classificacao)
  into STRICT  classification_w
  from  conta_contabil_classif
  where cd_conta_contabil	= account_account_p
  and   dt_inicio_vigencia <= effective_date_p
  and   coalesce(dt_fim_vigencia, clock_timestamp()) >= effective_date_p;

  if (coalesce(classification_w::text, '') = '' and coalesce(top_classification_p::text, '') = '') then
    select  max(cd_classificacao_atual)
    into STRICT    classification_w
    from    conta_contabil
    where   cd_conta_contabil	= account_account_p
    and 	  ((dt_fim_vigencia >= effective_date_p)
    or (coalesce(dt_fim_vigencia::text, '') = ''))
    and     exists (  SELECT  1 
                      from    conta_contabil x 
                      where   x.cd_conta_contabil = account_account_p
                      and (x.dt_fim_vigencia >= effective_date_p or coalesce(x.dt_fim_vigencia::text, '') = ''));
  end if;

  return coalesce(classification_w, top_classification_p);
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION tax_get_ecf_classification (top_classification_p conta_contabil_classif.cd_classificacao%type, account_account_p conta_contabil_classif.cd_conta_contabil%type, effective_date_p conta_contabil_classif.dt_inicio_vigencia%type) FROM PUBLIC;

