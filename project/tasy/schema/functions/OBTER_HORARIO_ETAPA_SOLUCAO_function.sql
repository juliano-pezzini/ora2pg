-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';



CREATE TYPE Horario AS (ds_horario	varchar(4000));


CREATE OR REPLACE FUNCTION obter_horario_etapa_solucao ( nr_etapa_p bigint, nr_prescricao_p bigint, nr_seq_solucao_p bigint) RETURNS varchar AS $body$
DECLARE


nr_etapas_w		bigint := 0;
ds_valor_Horario_w	varchar(30) := '';
type VetHorario is table of Horario index by integer;
Horarios_w		VetHorario;
y			integer := 0;
ds_horarios_w		varchar(4000);
Controle_w		bigint := 0;


BEGIN


Select	ds_horarios,
		coalesce(CASE WHEN coalesce(ie_etapa_especial,'N')='N' THEN nr_etapas  ELSE nr_etapas+1 END ,0)
into STRICT	ds_horarios_w,
		nr_etapas_w
from	prescr_solucao
where	nr_prescricao	= nr_prescricao_p
and		nr_seq_solucao	= nr_seq_solucao_p;


Horarios_w[y].ds_horario := ds_horarios_w;


For i in 1.. nr_etapas_w LOOP
	begin

	select	substr(Horarios_w[y].ds_horario, 1, position(';' in Horarios_w[y].ds_horario) - 1)
	into STRICT	ds_valor_Horario_w
	;

	Horarios_w[y].ds_horario	:= substr(Horarios_w[y].ds_horario, position(';' in Horarios_w[y].ds_horario) + 2, length(Horarios_w[y].ds_horario));

	Controle_w := Controle_w + 1;

	if (Controle_w = nr_etapa_p) then
		Exit;
	end if;

	end;
END LOOP;


if (Controle_w < nr_etapa_p) then
	ds_valor_Horario_w := '';
end if;

return ds_valor_Horario_w;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_horario_etapa_solucao ( nr_etapa_p bigint, nr_prescricao_p bigint, nr_seq_solucao_p bigint) FROM PUBLIC;

