-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_se_prof_escala_plantao ( cd_dia_p text, cd_mes_p text, cd_ano_p text, cd_profissional_p text, nr_seq_escala_p text, ie_adic_p text, hr_inicio_p text, hr_fim_p text) RETURNS varchar AS $body$
DECLARE


ie_pertence_w           varchar(25);
dt_escala_w             timestamp;
cd_motivo_ausencia_w	varchar(15);
qt_existe_w		integer	:= 0;
cd_estab_w		smallint;
ie_dia_util_w		varchar(5)	:= 'S';


BEGIN

select  to_date(cd_dia_p || '/' || cd_mes_p || '/' || cd_ano_p || ' ' || hr_inicio_p || ':00', 'dd/mm/yyyy hh24:mi:ss')
into STRICT    dt_escala_w
;

select	max(cd_estabelecimento)
into STRICT	cd_estab_w
from	usuario
where 	nm_usuario	= wheb_usuario_pck.get_nm_usuario;

if (ie_adic_p = 'S') then
	select  CASE WHEN count(*)=0 THEN 'N'  ELSE 'X' END
	into STRICT    ie_pertence_w
	from    escala_diaria d,
		escala_grupo g,
		escala_classif c,
		escala  e,
		escala_diaria_adic f
	where   c.nr_sequencia = g.nr_seq_classif
	and     g.nr_sequencia = e.nr_seq_grupo
	and     e.nr_sequencia = d.nr_seq_escala
	and     f.nr_seq_escala_diaria = d.nr_sequencia
	and     coalesce(obter_tipo_classif_escala(e.nr_sequencia),'P') = 'P'
	and     dt_escala_w between d.dt_inicio and d.dt_fim
	and     ((to_char(dt_inicio, 'hh24:mi') = hr_inicio_p) or (hr_inicio_p = '0'))
	and     ((to_char(dt_fim,'hh24:mi')  = hr_fim_p) or (hr_fim_p = '0'))
	and     f.cd_pessoa_fisica = cd_profissional_p
	and     e.nr_sequencia = nr_seq_escala_p
	and	not exists (SELECT 	1
			from 	ausencia_tasy a
			where 	a.nm_usuario_ausente = OBTER_USUARIO_PESSOA(f.cd_pessoa_fisica)
			and	trunc(a.dt_inicio,'dd') = trunc(d.dt_inicio,'dd')
			and	trunc(a.dt_fim,'dd') = trunc(d.dt_fim,'dd'));
elsif (ie_adic_p = 'N') then	
	select  CASE WHEN count(*)=0 THEN 'N'  ELSE 'X' END
	into STRICT    ie_pertence_w
	from    escala_diaria d,
		escala_grupo g,
		escala_classif c,
		escala  e
	where   c.nr_sequencia = g.nr_seq_classif
	and     g.nr_sequencia = e.nr_seq_grupo
	and     e.nr_sequencia = d.nr_seq_escala
	and     coalesce(obter_tipo_classif_escala(e.nr_sequencia),'P') = 'P'
	and     dt_escala_w between d.dt_inicio and d.dt_fim
	and     ((to_char(dt_inicio, 'hh24:mi') = hr_inicio_p) or (hr_inicio_p = '0'))
	and     ((to_char(dt_fim,'hh24:mi')  = hr_fim_p) or (hr_fim_p = '0'))
	and     d.cd_pessoa_fisica = cd_profissional_p
	and     e.nr_sequencia = nr_seq_escala_p
	and	not exists (SELECT 	1
			from 	ausencia_tasy a
			where 	a.nm_usuario_ausente = obter_usuario_pessoa(d.cd_pessoa_fisica)
			and	trunc(a.dt_inicio,'dd') = trunc(d.dt_inicio,'dd')
			and	trunc(a.dt_fim,'dd') = trunc(d.dt_fim,'dd'));
end if;

select	coalesce(max(a.cd_motivo_ausencia),ie_pertence_w)
into STRICT	ie_pertence_w
from	ausencia_tasy a
where	dt_escala_w between trunc(a.dt_inicio) and trunc(a.dt_fim)
and	exists (SELECT	1
		from	escala_diaria	x,
			usuario		u
		where	u.cd_pessoa_fisica	= x.cd_pessoa_fisica
		and	u.nm_usuario		= a.nm_usuario_ausente
		and	x.nr_seq_escala		= nr_seq_escala_p
		and	x.cd_pessoa_fisica	= cd_profissional_p);

if (ie_pertence_w = 'N') then
	ie_pertence_w	:= '';
end if;

return ie_pertence_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_se_prof_escala_plantao ( cd_dia_p text, cd_mes_p text, cd_ano_p text, cd_profissional_p text, nr_seq_escala_p text, ie_adic_p text, hr_inicio_p text, hr_fim_p text) FROM PUBLIC;

