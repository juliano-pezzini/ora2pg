-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_prioridade_pep_lab (exibe_ordem_res_exame_p text, nm_usuario_p text, nr_seq_exame_p bigint) RETURNS REG_PRIOR_PROCED_EXAME.NR_SEQUENCIA%TYPE AS $body$
DECLARE


nr_seq_prioridade_w 	varchar(80);
nr_prescricao_w   numeric(20);
nr_seq_proc_interno_w   numeric(20);


BEGIN

nr_seq_prioridade_w := null;

  begin

  select max(b.ds_result1)
  into STRICT  nr_prescricao_w
  from w_result_exame_grid b
  where exibe_ordem_res_exame_p = 'S'
  and b.nm_usuario = nm_usuario_p
  and   b.ie_ordem = -4;

  select  nr_sequencia nr_seq_prescr
  into STRICT    nr_seq_proc_interno_w
  from    prescr_procedimento
  where   nr_prescricao = nr_prescricao_w
  and     nr_seq_exame = lab_obter_exame_prescrito(nr_prescricao_w,nr_seq_exame_p);

   SELECT max(c.NR_SEQ_REG_PRIOR_PROCED_EXAME)
    into STRICT	nr_seq_prioridade_w
	 FROM   prescr_procedimento a,
          cpoe_procedimento b,
          protocolo_medic_proc c,
          prescr_medica d
	 WHERE  a.nr_seq_proc_cpoe = b.nr_sequencia
	 AND    a.nr_seq_proc_interno = b.nr_seq_proc_interno
	 AND    b.nr_seq_protocolo = c.nr_sequencia
	 AND    b.cd_protocolo = c.cd_protocolo 
	 AND    b.nr_seq_proc_interno = c.nr_seq_proc_interno
	 AND    a.nr_prescricao = nr_prescricao_w
	 AND    a.nr_seq_proc_interno = (
        SELECT c.nr_seq_proc_interno
        from exame_lab_result_item a,
             exame_lab_resultado b,
            prescr_procedimento c,
            prescr_medica d
       where a.nr_seq_resultado = b.nr_seq_resultado
       and  c.nr_prescricao = b.nr_prescricao
       and  d.nr_prescricao = c.nr_prescricao
       and  a.nr_seq_prescr = c.nr_sequencia
       and  (a.nr_seq_material IS NOT NULL AND a.nr_seq_material::text <> '')
       and  d.nr_prescricao = nr_prescricao_w
       and  c.nr_sequencia = nr_seq_proc_interno_w
   )
	 AND    d.nr_prescricao = a.NR_PRESCRICAO;

   exception
    when others then
      nr_seq_prioridade_w  := null;
  end;	

return nr_seq_prioridade_w;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_prioridade_pep_lab (exibe_ordem_res_exame_p text, nm_usuario_p text, nr_seq_exame_p bigint) FROM PUBLIC;

