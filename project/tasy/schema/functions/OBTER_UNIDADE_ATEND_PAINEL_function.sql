-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_unidade_atend_painel ( nr_atendimento_p bigint ) RETURNS varchar AS $body$
DECLARE

    ds_unidade_w varchar(255);

BEGIN
    BEGIN
        SELECT
            max(apu.cd_unidade_basica)
            || ' '
            || max(apu.cd_unidade_compl) ds
        INTO STRICT ds_unidade_w
        FROM
            atend_paciente_unidade       apu,
            programacao_cirurgica_js_v   pcv
        WHERE
            1 = 1
            AND pcv.nr_sequencia IN (
                SELECT
                    x.nr_sequencia
                FROM
                    agenda_paciente   x,
                    agenda            r
                WHERE
                    coalesce(ie_exibir_painel, 'S') <> 'N'
                    AND ocultar_paciente_painel_agenda(x.nr_cirurgia, x.nr_seq_pepo) = 'N'
                    AND x.cd_agenda = r.cd_agenda
                    AND r.cd_tipo_agenda = 1
					AND x.dt_agenda BETWEEN PKG_DATE_UTILS.START_OF(clock_timestamp() - interval '15 days', 'DAY') and PKG_DATE_UTILS.END_OF(clock_timestamp() + interval '15 days', 'DAY')
            )
            AND apu.nr_seq_interno = (
                SELECT
                    y.nr_seq_interno
                FROM (
                        SELECT
                            a.nr_seq_interno
                        FROM
                            setor_atendimento        c,
                            atend_paciente_unidade   a
                        WHERE
                            a.nr_atendimento = nr_atendimento_p
                            AND c.cd_setor_atendimento = a.cd_setor_atendimento
                            AND c.cd_classif_setor IN (2,3,4,8,12)
                        ORDER BY coalesce(a.dt_saida_unidade, a.dt_entrada_unidade + 9999) DESC
                    ) y LIMIT 1);
    END;

    RETURN ds_unidade_w;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_unidade_atend_painel ( nr_atendimento_p bigint ) FROM PUBLIC;

