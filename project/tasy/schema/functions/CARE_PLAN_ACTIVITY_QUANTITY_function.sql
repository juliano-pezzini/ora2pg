-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION care_plan_activity_quantity (nr_prescricao_p text, pe_procs text) RETURNS bigint AS $body$
DECLARE


nr_retorno_w                        bigint := 0;
nr_seq_pe_procedimento_w            bigint;
qtd_w                               bigint := 0;

  item RECORD;

BEGIN
    begin
        for item in (WITH RECURSIVE cte AS (

            with temp as (
                   select nr_prescricao_p nr_prescricao
            ) SELECT trim(both regexp_substr(nr_prescricao, '[^,]+', 1, 1)) nr_prescricao
                FROM (SELECT  nr_prescricao FROM temp) t
                instr(nr_prescricao, ',', 1, level - 1) > 0 
          UNION ALL

            with temp as (
                   select nr_prescricao_p nr_prescricao  
            ) SELECT trim(both regexp_substr(nr_prescricao, '[^,]+', 1, (c.level+1))) nr_prescricao
                FROM (SELECT  nr_prescricao FROM temp) t
                instr(nr_prescricao, ',', 1, level - 1) > 0 
         JOIN cte c ON ()

) SELECT * FROM cte;
) loop

            select count(*)
            into STRICT qtd_w from 
                    CP_INTERVENTION_ITEM_ASSOC iia,
                    CP_INTERVENTION_ITEM ii,
                    CP_INTERVENTION i,
                    PE_PROCEDIMENTO p,
                    PE_PRESCR_PROC ppp

                    where iia.NR_SEQ_INTERV_ITEM = ii.NR_SEQUENCIA
                    and iia.NR_SEQ_INTERVENTION = i.NR_SEQUENCIA
                    and i.NR_SEQ_PE_PROCEDIMENTO = p.NR_SEQUENCIA
                    and i.NR_SEQ_PE_PROCEDIMENTO = nr_seq_pe_procedimento_w
                    and i.NR_SEQ_PE_PROCEDIMENTO = ppp.NR_SEQ_PROC
                    and ppp.NR_SEQ_PRESCR = item.nr_prescricao;

            nr_retorno_w := nr_retorno_w + qtd_w;

        end loop;

    exception when others then
        nr_retorno_w := 0;
    end;
return nr_retorno_w;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION care_plan_activity_quantity (nr_prescricao_p text, pe_procs text) FROM PUBLIC;

