-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_valor_item_opme_cir ( nr_sequencia_p bigint, nr_prescricao_p bigint, ie_opcao_p text) RETURNS bigint AS $body$
DECLARE

			 
cd_material_w		bigint;
cd_convenio_w		integer;
cd_categoria_w		varchar(10);		
vl_retorno_w		double precision;	
qt_material_w		double precision;
vl_unit_w		double precision;
ie_tipo_atendimento_w	smallint;
nr_cirurgia_w		bigint;
cd_fornec_consignado_w varchar(14);

 
/* U - Valor unitario 
   T - Valor unitario * quantidade do material */
 
 

BEGIN 
 
if (nr_sequencia_p IS NOT NULL AND nr_sequencia_p::text <> '') and (nr_prescricao_p IS NOT NULL AND nr_prescricao_p::text <> '') then 
	begin 
	 
	select	max(c.qt_material), 
		max(a.cd_convenio), 
		max(a.cd_categoria), 
		max(c.cd_material), 
		max(a.nr_cirurgia), 
		max(cd_fornec_consignado) 
	into STRICT	qt_material_w, 
		cd_convenio_w, 
		cd_categoria_w, 
		cd_material_w, 
		nr_cirurgia_w, 
		cd_fornec_consignado_w 
	from  cirurgia a, 
		prescr_medica b, 
		prescr_material c 
	where  a.nr_cirurgia = b.nr_cirurgia 
	and	b.nr_prescricao = c.nr_prescricao 
	and	c.nr_sequencia = nr_sequencia_p 
	and 	c.nr_prescricao = nr_prescricao_p;
	 
if (nr_cirurgia_w IS NOT NULL AND nr_cirurgia_w::text <> '') then 
	select max(a.ie_tipo_atendimento) 
	into STRICT	ie_tipo_atendimento_w 
	from  agenda_paciente a 
	where  a.nr_cirurgia = nr_cirurgia_w;
	 
end if;
	 
	if (coalesce(cd_categoria_w::text, '') = '') then 
		select	max(cd_categoria) 
		into STRICT	cd_categoria_w 
		from	categoria_convenio 
		where	cd_convenio = cd_convenio_w 
		and	coalesce(ie_situacao,'A') = 'A';	
	end if;
	 
	if (ie_opcao_p = 'U') then 
		select 	obter_preco_material(wheb_usuario_pck.get_cd_estabelecimento,cd_convenio_w,cd_categoria_w,clock_timestamp(),cd_material_w,0,ie_tipo_atendimento_w,0,cd_fornec_consignado_w,0,0) 
		into STRICT	vl_retorno_w 
		;
	end if;
	 
	if (ie_opcao_p	= 'T') then 
		select 	obter_preco_material(wheb_usuario_pck.get_cd_estabelecimento,cd_convenio_w,cd_categoria_w,clock_timestamp(),cd_material_w,0,ie_tipo_atendimento_w,0,cd_fornec_consignado_w,0,0) 
		into STRICT	vl_unit_w 
		;
		vl_retorno_w := (vl_unit_w * qt_material_w);
	end if;
	 
	end;
end if;
 
return	vl_retorno_w;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_valor_item_opme_cir ( nr_sequencia_p bigint, nr_prescricao_p bigint, ie_opcao_p text) FROM PUBLIC;

