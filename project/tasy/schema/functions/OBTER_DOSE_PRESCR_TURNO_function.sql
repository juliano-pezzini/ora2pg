-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_dose_prescr_turno (nr_prescricao_p bigint, nr_sequencia_p bigint) RETURNS varchar AS $body$
DECLARE

 
ds_retorno_w		varchar(255);
cd_setor_atendimento_w	integer;
cd_estabelecimento_w	smallint;
hr_prim_turno_w		varchar(5);
hr_seg_turno_w		varchar(5);
hr_ter_turno_w		varchar(5);
ds_horarios_w		varchar(2000);
ds_horarios_dif_w	varchar(2000);
qt_manha_w		double precision := 0;
qt_tarde_w		double precision := 0;
qt_noite_w		double precision := 0;
ds_hora_w		varchar(20);
qt_unitaria_w		double precision;
ie_agupador_w		smallint;
nr_sequencia_diluicao_w	integer;
k			integer;
qt_flag_w		integer := 0;


BEGIN 
 
select	coalesce(cd_setor_atendimento,obter_setor_atendimento(nr_atendimento)), 
	cd_estabelecimento 
into STRICT	cd_setor_atendimento_w, 
	cd_estabelecimento_w 
from	prescr_medica 
where	nr_prescricao = nr_prescricao_p;
 
begin 
select	hr_prim_turno, 
	hr_seg_turno, 
	hr_ter_turno 
into STRICT	hr_prim_turno_w, 
	hr_seg_turno_w, 
	hr_ter_turno_w 
from	regra_turno_prescr 
where	cd_estabelecimento	= cd_estabelecimento_w 
and	nr_sequencia		= (	SELECT	min(b.nr_sequencia) 
					from	regra_turno_prescr b 
					where	cd_setor_atendimento = cd_setor_atendimento_w);
exception 
	when others then 
		hr_prim_turno_w := null;
end;
 
if (coalesce(hr_prim_turno_w::text, '') = '') then 
	begin 
	select	hr_prim_turno, 
		hr_seg_turno, 
		hr_ter_turno 
	into STRICT	hr_prim_turno_w, 
		hr_seg_turno_w, 
		hr_ter_turno_w 
	from	regra_turno_prescr 
	where	cd_estabelecimento	= cd_estabelecimento_w 
	and	nr_sequencia		= (	SELECT	min(b.nr_sequencia) 
						from	regra_turno_prescr b 
						where	coalesce(cd_setor_atendimento::text, '') = '');
	exception 
		when others then 
			hr_prim_turno_w := null;
	end;	
end if;
 
if (hr_prim_turno_w IS NOT NULL AND hr_prim_turno_w::text <> '') then 
	select	padroniza_horario_prescr(ds_horarios, '00:00'), 
		ds_horarios, 
		qt_unitaria, 
		ie_agrupador, 
		nr_sequencia_diluicao 
	into STRICT	ds_horarios_w, 
		ds_horarios_dif_w, 
		qt_unitaria_w, 
		ie_agupador_w, 
		nr_sequencia_diluicao_w 
	from	prescr_material 
	where	nr_prescricao	= nr_prescricao_p 
	and	nr_sequencia	= nr_sequencia_p;
	 
	if (ie_agupador_w in (3,7,9)) then 
		select	padroniza_horario_prescr(ds_horarios, '00:00'), 
			ds_horarios 
		into STRICT	ds_horarios_w, 
			ds_horarios_dif_w 
		from	prescr_material 
		where	nr_prescricao	= nr_prescricao_p 
		and	nr_sequencia	= nr_sequencia_diluicao_w;
	end if;
	 
	if (coalesce(ds_horarios_w::text, '') = '') then	 
		ds_retorno_w	:= ds_horarios_dif_w;
	else 
		ds_horarios_w	:= replace(ds_horarios_w, 'A','');
		while	(ds_horarios_w IS NOT NULL AND ds_horarios_w::text <> '') LOOP 
			begin 
			select	position(' ' in ds_horarios_w) 
			into STRICT	k 
			;
			if (k > 1) and ((substr(ds_horarios_w, 1, k -1) IS NOT NULL AND (substr(ds_horarios_w, 1, k -1))::text <> '')) then 
				ds_hora_w		:= substr(ds_horarios_w, 1, k-1);
				ds_hora_w		:= replace(ds_hora_w, ' ','');
				ds_horarios_w		:= substr(ds_horarios_w, k + 1, 2000);
			elsif (ds_horarios_w IS NOT NULL AND ds_horarios_w::text <> '') then 
				ds_hora_w 		:= replace(ds_horarios_w,' ','');
				ds_horarios_w		:= '';
			end if;
 
			if (hr_ter_turno_w IS NOT NULL AND hr_ter_turno_w::text <> '') and 
				((ds_hora_w >= hr_ter_turno_w) or (ds_hora_w < hr_prim_turno_w)) then 
				qt_noite_w	:= qt_noite_w + qt_unitaria_w;
			elsif (hr_seg_turno_w IS NOT NULL AND hr_seg_turno_w::text <> '') and (ds_hora_w >= hr_seg_turno_w) and (ds_hora_w < hr_ter_turno_w) then 
				qt_tarde_w	:= qt_tarde_w + qt_unitaria_w;
			elsif (hr_prim_turno_w IS NOT NULL AND hr_prim_turno_w::text <> '') then 
				qt_manha_w	:= qt_manha_w + qt_unitaria_w;
			end if;
			 
			qt_flag_w	:= qt_flag_w + 1;
			if (qt_flag_w > 30) then	 
				ds_horarios_w	:= '';
			end if;
			end;
		END LOOP;
		ds_retorno_w	:= wheb_mensagem_pck.get_texto(308936) || ' '||qt_manha_w||' - ' || wheb_mensagem_pck.get_texto(308937) || ' '||qt_tarde_w||' - ' || wheb_mensagem_pck.get_texto(308938) || ' '||qt_noite_w; -- Manh√£ -- Tarde -- Noite 
	end if;	
end if;
 
return ds_retorno_w;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_dose_prescr_turno (nr_prescricao_p bigint, nr_sequencia_p bigint) FROM PUBLIC;

