-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';



CREATE TYPE ValorComplemento AS (	ds_valor	varchar(2000));


CREATE OR REPLACE FUNCTION com_obter_result_sd_avaliacao ( nr_seq_solic_p bigint, nr_seq_item_p bigint) RETURNS varchar AS $body$
DECLARE


/*
  B - Booleano
  D - Descrição
  M - Multiseleção
  S - Seleção Simples
  O - Valor Domínio
  C - Seleção Simples
  L - Cálculo
  T - Título
  V - Valor
  U - Seleção Simples (Radio Group);
*/
type Dados is table of ValorComplemento index by integer;

ds_resultado_w			varchar(4000);
qt_resultado_w			double precision;
ie_resultado_w			varchar(02);
cd_funcao_w			integer;
nr_seq_prontuario_w		integer;
cd_dominio_w			integer;
ds_complemento_w		varchar(4000);
ds_retorno_w			varchar(4000);


i				integer;
ds_texto_w			varchar(255);
pos_w				bigint;

complemento_w			Dados;
ds_comando_w			varchar(2000);


BEGIN


ds_resultado_w			:= '';

select	ie_resultado,
	cd_dominio,
	ds_complemento || ';'
into STRICT 	ie_resultado_w,
	cd_dominio_w,
	ds_complemento_w
from 	med_item_avaliar
where nr_sequencia	= nr_seq_item_p;

SELECT	qt_resultado,
	ds_resultado
INTO STRICT	qt_resultado_w,
	ds_resultado_w
FROM	com_solic_sd_result
WHERE	nr_seq_solic = nr_seq_solic_p
AND	nr_seq_item = nr_seq_item_p;

if (ie_resultado_w = 'B') then
	begin
	if (coalesce(qt_resultado_w,0) = 0) then
		ds_resultado_w	:= 'Não';
	else
		ds_resultado_w	:= 'Sim';
	end if;
	end;
elsif (ie_resultado_w = 'D') or (ie_resultado_w = 'C') then
	begin
	ds_resultado_w	:= ds_resultado_w;
	end;
elsif (ie_resultado_w = 'V') then
	ds_resultado_w	:= qt_resultado_w;
elsif (ie_resultado_w = 'U') then

	if (coalesce(cd_dominio_w::text, '') = '') then
		for i in 0..100 loop
			ds_texto_w		:= substr(ds_complemento_w, 1, position(';' in ds_complemento_w) - 1);
			ds_complemento_w        := replace(ds_complemento_w, ds_texto_w || ';', '');
			if (i = qt_resultado_w) then
				ds_resultado_w	:= ds_texto_w;
				exit;
			end if;
		end loop;
	else

		if (coalesce(ds_resultado_w::text, '') = '') then
			select	coalesce(max(ds_valor_dominio),'')
			into STRICT	ds_resultado_w
			from	med_valor_dominio
			where	nr_seq_dominio = cd_dominio_w
			and	(vl_dominio)::numeric  = qt_resultado_w;

		end if;
	end if;
	if (coalesce(ds_resultado_w,'') = '') then
		ds_resultado_w	:= qt_resultado_w;
	end if;
elsif (ie_resultado_w = 'L') then
	ds_resultado_w	:= to_char(qt_resultado_w, '999999999999999.9999');
elsif (ie_resultado_w = 'O') or (ie_resultado_w = 'S') then
	begin
	if (qt_resultado_w = 0) or (coalesce(qt_resultado_w::text, '') = '') then
		ds_resultado_w	:= ds_resultado_w;
	else
		ds_resultado_w	:= qt_resultado_w;
	end if;
	end;
elsif (ie_resultado_w	= 'Z') then
	begin


	pos_w	:= position(';' in ds_complemento_w);

	i	:= 0;
	while(pos_w	> 0) loop
		begin

		complemento_w[i].ds_valor	:= substr(ds_complemento_w,1,pos_w-1);

		ds_complemento_w		:= substr(ds_complemento_w,pos_w+1,2000);

		i	:= i+1;


		pos_w	:= position(';' in ds_complemento_w);
		end;
	end loop;



	if (complemento_w.count	>= 8)then

		ds_comando_w	:= 'select	'||complemento_w[8].ds_valor||
				    ' from	'||complemento_w[6].ds_valor||
				    ' where	'||complemento_w[7].ds_valor  ||' = :ds_result';



		ds_retorno_w	:=	Obter_select_concatenado_bv(	ds_comando_w,
									'ds_result='||ds_resultado_w||';','');



		if (ds_retorno_w IS NOT NULL AND ds_retorno_w::text <> '')then
			ds_resultado_w	:= ds_resultado_w||' - '||ds_retorno_w;

		end if;


	end if;



	end;
end if;

RETURN	ds_resultado_w;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION com_obter_result_sd_avaliacao ( nr_seq_solic_p bigint, nr_seq_item_p bigint) FROM PUBLIC;

