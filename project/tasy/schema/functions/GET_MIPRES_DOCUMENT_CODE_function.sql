-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION get_mipres_document_code ( nr_atendimento_p atendimento_paciente.nr_atendimento%type, cd_pessoa_fisica_p atendimento_paciente.cd_pessoa_fisica%type default null) RETURNS varchar AS $body$
DECLARE


	ds_result_w	varchar(255);


BEGIN
    if (coalesce(CD_PESSOA_FISICA_P::text, '') = '') then
        select max(x.cd_document_code)
        into STRICT ds_result_w
        from (
            SELECT	case
                        when nr_seq_tipo_doc_identificacao = 'CC' then nr_identidade
                        when nr_seq_tipo_doc_identificacao = 'CE' then nr_cartao_estrangeiro
                        when nr_seq_tipo_doc_identificacao = 'PA' then nr_passaporte
                        when nr_seq_tipo_doc_identificacao = 'PE' then nr_reg_geral_estrang
                        when nr_seq_tipo_doc_identificacao = 'RC' then nr_cert_nasc
                        when nr_seq_tipo_doc_identificacao = 'TI' then nr_ric
                        when nr_seq_tipo_doc_identificacao = 'CN' then cd_declaracao_nasc_vivo
                        when nr_seq_tipo_doc_identificacao = 'CD' then nr_cartao_diplomatico
                        when nr_seq_tipo_doc_identificacao = 'SC' then nr_salvo_conduto
                        when nr_seq_tipo_doc_identificacao = 'AS' then nr_adulto_sem_identificacao
                        when nr_seq_tipo_doc_identificacao = 'MS' then nr_menor_sem_identificacao
                        else null
                    end cd_document_code
              from	atendimento_paciente a,
                    pessoa_fisica b,
                    pessoa_fisica_aux c
             where	a.cd_pessoa_fisica = b.cd_pessoa_fisica
               and 	c.cd_pessoa_fisica = b.cd_pessoa_fisica
               and 	nr_atendimento = nr_atendimento_p
            ) x;
    else
        select max(x.cd_document_code)
        into STRICT ds_result_w
        from (
            SELECT	case
                        when nr_seq_tipo_doc_identificacao = 'CC' then nr_identidade
                        when nr_seq_tipo_doc_identificacao = 'CE' then nr_cartao_estrangeiro
                        when nr_seq_tipo_doc_identificacao = 'PA' then nr_passaporte
                        when nr_seq_tipo_doc_identificacao = 'PE' then nr_reg_geral_estrang
                        when nr_seq_tipo_doc_identificacao = 'RC' then nr_cert_nasc
                        when nr_seq_tipo_doc_identificacao = 'TI' then nr_ric
                        when nr_seq_tipo_doc_identificacao = 'CN' then cd_declaracao_nasc_vivo
                        when nr_seq_tipo_doc_identificacao = 'CD' then nr_cartao_diplomatico
                        when nr_seq_tipo_doc_identificacao = 'SC' then nr_salvo_conduto
                        when nr_seq_tipo_doc_identificacao = 'AS' then nr_adulto_sem_identificacao
                        when nr_seq_tipo_doc_identificacao = 'MS' then nr_menor_sem_identificacao
                        else null
                    end cd_document_code
              from	pessoa_fisica b,
                    pessoa_fisica_aux c
             where	c.cd_pessoa_fisica = b.cd_pessoa_fisica
               and 	b.cd_pessoa_fisica = cd_pessoa_fisica_p
            ) x;
    end if;

	return ds_result_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION get_mipres_document_code ( nr_atendimento_p atendimento_paciente.nr_atendimento%type, cd_pessoa_fisica_p atendimento_paciente.cd_pessoa_fisica%type default null) FROM PUBLIC;

