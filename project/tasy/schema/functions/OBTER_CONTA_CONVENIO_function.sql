-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_conta_convenio ( cd_estabelecimento_p bigint, cd_convenio_p bigint, ie_tipo_atendimento_p bigint, ie_tipo_conta_p text, dt_vigencia_p timestamp, ie_tipo_protocolo_p bigint, cd_categoria_p text, cd_plano_p text, cd_setor_atendimento_p bigint, cd_procedimento_p bigint default null, ie_origem_proced_p bigint default null, nr_seq_trans_financ_p bigint default null) RETURNS varchar AS $body$
DECLARE


cd_conta_contabil_w		varchar(40);
cd_cgc_w			varchar(14);
cd_empresa_w			integer;
cd_setor_atendimento_w		bigint;
cd_grupo_w                				bigint  := 0;
cd_especialidade_w        				bigint  := 0;
cd_area_w					bigint  := 0;
cd_procedimento_w		bigint;
ie_origem_proced_w		bigint;

c01 CURSOR FOR
SELECT	cd_conta_contabil
from	convenio_conta_contabil
where	cd_convenio		= cd_convenio_p
and (ie_tipo_atendimento	= ie_tipo_atendimento_p or coalesce(ie_tipo_atendimento::text, '') = '')
and	cd_estabelecimento		= cd_estabelecimento_p
and	ie_tipo_conta		= coalesce(ie_tipo_conta_p, ie_tipo_conta)
and (coalesce(dt_inicio_vigencia, dt_vigencia_p) <= dt_vigencia_p and coalesce(dt_fim_vigencia, dt_vigencia_p) >= dt_vigencia_p)
and (ie_tipo_protocolo		= ie_tipo_protocolo_p or coalesce(ie_tipo_protocolo::text, '') = '')
and (cd_categoria		= cd_categoria_p or coalesce(cd_categoria::text, '') = '')
and (cd_plano		= cd_plano_p or coalesce(cd_plano::text, '') = '')
and (cd_setor_atendimento	= cd_setor_atendimento_w or coalesce(cd_setor_atendimento::text, '') = '')
and	coalesce(cd_procedimento,cd_procedimento_w) 		= cd_procedimento_w
and	coalesce(CASE WHEN coalesce(cd_procedimento,0)=0 THEN null  ELSE ie_origem_proced END ,ie_origem_proced_w) = ie_origem_proced_w
and	coalesce(cd_area_procedimento,cd_area_w)			= cd_area_w
and	coalesce(cd_especialidade,cd_especialidade_w)		= cd_especialidade_w
and	coalesce(cd_grupo_proc,cd_grupo_w)			= cd_grupo_w
and	coalesce(nr_seq_trans_financ, coalesce(nr_seq_trans_financ_p,0))	= coalesce(nr_seq_trans_financ_p,0)
order by dt_inicio_vigencia,
	coalesce(cd_plano, 0),
	coalesce(cd_categoria , 0),
	coalesce(cd_setor_atendimento, 0),
	coalesce(ie_tipo_atendimento , 0),
	coalesce(cd_procedimento,0),
	coalesce(cd_grupo_proc,0),
	coalesce(cd_especialidade,0),
	coalesce(cd_area_procedimento,0),
	coalesce(nr_seq_trans_financ,0);



BEGIN

cd_setor_atendimento_w	:= cd_setor_atendimento_p;

begin
cd_procedimento_w		:= coalesce(cd_procedimento_p,0);
ie_origem_proced_w		:= coalesce(ie_origem_proced_p,0);



select	cd_grupo_proc,
	cd_especialidade,
	cd_area_procedimento
into STRICT	cd_grupo_w,
	cd_especialidade_w,
	cd_area_w
from	estrutura_procedimento_v
where	cd_procedimento 	= cd_procedimento_p
and	ie_origem_proced 	= ie_origem_proced_p;
exception when others then
	cd_grupo_w 		:= 0;
	cd_especialidade_w	:= 0;
	cd_area_w		:= 0;
end;

open c01;
loop
fetch c01 into
	cd_conta_contabil_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
end loop;
close c01;

if (coalesce(cd_conta_contabil_w::text, '') = '') then
	begin

	select	cd_cgc
	into STRICT	cd_cgc_w
	from	convenio
	where	cd_convenio	= cd_convenio_p;

	select cd_empresa
	into STRICT	cd_empresa_w
	from	estabelecimento
	where	cd_estabelecimento	= cd_estabelecimento_p;

	select obter_conta_contab_pj(cd_empresa_w, cd_estabelecimento_p, cd_cgc_w,'R', dt_vigencia_p)
	into STRICT	cd_conta_contabil_w
	;

	end;
end if;

if (coalesce(cd_conta_contabil_w::text, '') = '') then
	select	cd_conta_contabil
	into STRICT	cd_conta_contabil_w
	from	convenio
	where	cd_convenio	= cd_convenio_p;
end if;

return cd_conta_contabil_w;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_conta_convenio ( cd_estabelecimento_p bigint, cd_convenio_p bigint, ie_tipo_atendimento_p bigint, ie_tipo_conta_p text, dt_vigencia_p timestamp, ie_tipo_protocolo_p bigint, cd_categoria_p text, cd_plano_p text, cd_setor_atendimento_p bigint, cd_procedimento_p bigint default null, ie_origem_proced_p bigint default null, nr_seq_trans_financ_p bigint default null) FROM PUBLIC;

