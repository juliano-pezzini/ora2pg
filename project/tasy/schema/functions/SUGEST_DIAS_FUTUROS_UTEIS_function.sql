-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION sugest_dias_futuros_uteis (dt_inicial_p timestamp, qt_dias_p bigint, cd_estabelecimento_p bigint) RETURNS timestamp AS $body$
DECLARE


dt_aux_w			timestamp;
ie_dia_semana_w		smallint;
ie_feriado_w		smallint;
qt_dias_atend_w		smallint;
qt_limitador_w		bigint := 1;
ie_dia_util			varchar(1);


BEGIN

if (dt_inicial_p IS NOT NULL AND dt_inicial_p::text <> '') then

	dt_aux_w		:= trunc(dt_inicial_p, 'dd');	
	ie_dia_util		:= obter_se_dia_util(dt_aux_w, cd_estabelecimento_p);	
	qt_dias_atend_w := qt_dias_p;

	if qt_dias_atend_w > 0 then
		qt_dias_atend_w := qt_dias_atend_w - 1;
	end if;
	
	
	while	((qt_dias_atend_w > 0) or (ie_dia_util = 'N')) and (qt_limitador_w < 1000) loop
		begin

		ie_dia_semana_w := obter_cod_dia_semana(dt_aux_w);
		ie_feriado_w := obter_se_feriado(cd_estabelecimento_p, dt_aux_w);

		if (ie_feriado_w = 0) and (ie_dia_semana_w in (2, 3, 4, 5,6)) then
						
			qt_dias_atend_w	:= qt_dias_atend_w - 1;
			dt_aux_w		:= dt_aux_w + 1;
		
		elsif	((ie_feriado_w > 0) or (ie_dia_semana_w in (1, 7))) then
			
			if (ie_dia_semana_w = 7) then
				dt_aux_w		:= dt_aux_w + 2;
			else
				dt_aux_w		:= dt_aux_w + 1;
			end if;
			
		end if;
		
		ie_dia_util := obter_se_dia_util(dt_aux_w, cd_estabelecimento_p);
		qt_limitador_w := qt_limitador_w + 1;
		end;		
	end loop;	
else
	dt_aux_w	:= coalesce(dt_inicial_p,clock_timestamp());
end if;

return fim_dia(dt_aux_w);

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION sugest_dias_futuros_uteis (dt_inicial_p timestamp, qt_dias_p bigint, cd_estabelecimento_p bigint) FROM PUBLIC;

