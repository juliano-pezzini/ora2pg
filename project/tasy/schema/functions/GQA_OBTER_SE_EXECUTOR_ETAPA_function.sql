-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION gqa_obter_se_executor_etapa (NR_SEQ_ETAPA_P bigint ,NR_SEQ_PROT_PAC_P bigint) RETURNS varchar AS $body$
DECLARE


  nm_usuario_w        varchar(15);
  cd_pessoa_usuario_w varchar(10);
  nm_pessoa_usuario_w varchar(100);
  nr_atendimento_w    gqa_protocolo_pac.nr_atendimento%TYPE;
  cd_medico_resp_w    atendimento_paciente.cd_medico_resp%TYPE;
  nm_medico_aux_w     varchar(100);
  nm_usuario_lib_w    gqa_protocolo_pac.nm_usuario_liberacao%TYPE;
  cd_enfer_resp_w     atend_profissional.cd_pessoa_fisica%TYPE;
  cd_tec_resp_w       atend_profissional.cd_pessoa_fisica%TYPE;
  ie_medico_plan_w    varchar(5);
  prof_escala_w       varchar(10);
  cd_especialidade_w	integer;

  ConstMedicoResponsavel_w   varchar(5) := '1';
  ConstMedicoAuxiliar_w      varchar(5) := '2';
  ConstUsuarioResponsavel_w  varchar(5) := '3';
  ConstEnfermeiroTurno_w     varchar(5) := '4';
  ConstTecEnfermagemTurno_w  varchar(5) := '5';
  ConstUsuarioFixo_w         varchar(5) := '6';
  ConstMedicoPlantonista_w   varchar(5) := '7';
  ConstProfissionalPlantao_w varchar(5) := '8';
  ConstEquipe_w              varchar(5) := '9';
  ConstEspecialidade_w       varchar(5) := '10';
  ConstPerfil_w              varchar(5) := '11';

  c_executores CURSOR FOR
    SELECT c.ie_pessoa_destino
          ,c.nr_seq_equipe
          ,c.cd_especialidade
          ,c.cd_pf_destino
          ,c.cd_perfil
      FROM gqa_protocolo_etapa_pac a
          ,gqa_acao                b
          ,gqa_acao_regra_prof     c
     WHERE a.nr_seq_acao = b.nr_sequencia
       AND b.nr_sequencia = c.nr_seq_acao
       AND b.ie_situacao  = 'A'
       AND a.nr_seq_prot_pac = NR_SEQ_PROT_PAC_P
       AND a.nr_seq_etapa = NR_SEQ_ETAPA_P;

  c_prot_pac CURSOR FOR
    SELECT a.nr_atendimento
          ,a.nm_usuario_liberacao
      FROM gqa_protocolo_pac a
     WHERE a.nr_sequencia = NR_SEQ_PROT_PAC_P;
BEGIN
  nm_usuario_w := wheb_usuario_pck.get_nm_usuario;
	cd_pessoa_usuario_w := obter_pf_usuario(nm_usuario_w,'C');
  nm_pessoa_usuario_w := obter_nome_pf(cd_pessoa_usuario_w);

  OPEN c_prot_pac;
 FETCH c_prot_pac
  INTO nr_atendimento_w
      ,nm_usuario_lib_w;
 CLOSE c_prot_pac;

  BEGIN
    SELECT t.cd_medico_resp
      INTO STRICT cd_medico_resp_w
      FROM atendimento_paciente t
     WHERE t.nr_atendimento	= nr_atendimento_w;
  EXCEPTION
    WHEN no_data_found THEN
      NULL;
  END;

  BEGIN
    SELECT a.cd_pessoa_fisica
      INTO STRICT cd_enfer_resp_w
      FROM atend_profissional a
     WHERE a.nr_atendimento = nr_atendimento_w
       AND ((a.ie_profissional = 'E') OR (is_copy_base_locale('es_MX') = 'S' AND a.ie_profissional = '6'))
       AND a.nr_sequencia = (SELECT max(x.nr_sequencia)
                               FROM atend_profissional x
                              WHERE x.nr_atendimento = nr_atendimento_w
                                AND x.ie_profissional = 'E');
  EXCEPTION
    WHEN no_data_found THEN
      NULL;
  END;

  BEGIN
    SELECT obter_medico_auxiliar_atend(nr_atendimento_w, 'N')
          ,obter_enfermeiro_resp(nr_atendimento_w, 'C')
          ,obter_pessoa_escala_gqa(nr_atendimento_w)
          ,obter_se_medico(prof_escala_w, 'M')
          ,obter_especialidade_pf(cd_pessoa_usuario_w)
      INTO STRICT nm_medico_aux_w
          ,cd_tec_resp_w
          ,prof_escala_w
          ,ie_medico_plan_w
          ,cd_especialidade_w
;
  END;

  FOR r_executores IN c_executores LOOP
    IF (r_executores.ie_pessoa_destino = ConstMedicoResponsavel_w   AND cd_medico_resp_w = cd_pessoa_usuario_w) OR (r_executores.ie_pessoa_destino = ConstMedicoAuxiliar_w      AND nm_medico_aux_w = substr(nm_pessoa_usuario_w,1,99)) OR (r_executores.ie_pessoa_destino = ConstUsuarioResponsavel_w  AND nm_usuario_lib_w = nm_usuario_w) OR (r_executores.ie_pessoa_destino = ConstEnfermeiroTurno_w     AND cd_enfer_resp_w = cd_pessoa_usuario_w) OR (r_executores.ie_pessoa_destino = ConstTecEnfermagemTurno_w  AND cd_tec_resp_w = cd_pessoa_usuario_w) OR (r_executores.ie_pessoa_destino = ConstUsuarioFixo_w         AND r_executores.cd_pf_destino = cd_pessoa_usuario_w) OR (r_executores.ie_pessoa_destino = ConstMedicoPlantonista_w   AND ie_medico_plan_w = 'S' AND prof_escala_w = cd_pessoa_usuario_w) OR (r_executores.ie_pessoa_destino = ConstProfissionalPlantao_w AND prof_escala_w = cd_pessoa_usuario_w) OR (r_executores.ie_pessoa_destino = ConstEquipe_w              AND obter_se_medico_equipe(r_executores.nr_seq_equipe, cd_pessoa_usuario_w) = 'S') OR (r_executores.ie_pessoa_destino = ConstEspecialidade_w       AND r_executores.cd_especialidade = cd_especialidade_w) OR (r_executores.ie_pessoa_destino = ConstPerfil_w              AND obter_se_perfil_usuario(r_executores.cd_perfil, nm_usuario_w) = 'S') THEN
      RETURN 'S';
    END IF;
  END LOOP;

  RETURN 'N';
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION gqa_obter_se_executor_etapa (NR_SEQ_ETAPA_P bigint ,NR_SEQ_PROT_PAC_P bigint) FROM PUBLIC;

