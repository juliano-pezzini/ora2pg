-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_regra_material_conta ( cd_convenio_p bigint, cd_categoria_p text, cd_estabelecimento_p bigint, ie_evento_p text, cd_plano_conv_p text, cd_setor_atend_p bigint, cd_local_estoque_p bigint, ie_tipo_material_p text, cd_material_p bigint) RETURNS varchar AS $body$
DECLARE


/*
   ie_regra para obtenção do material para conta
	p - prescrição
	i - informado(código de barras ou digitado)
	c - comercial
	o - material da conta do cadastro de materiais
	g - generico se tiver
*/
ie_regra_w			varchar(10)	:= null;
cd_estabelecimento_w		integer;
cd_grupo_w			smallint	:= 0;
cd_subgrupo_w			smallint	:= 0;
cd_classe_w			integer	:= 0;

c01 CURSOR FOR
SELECT 	ie_regra
from 	regra_material_conta
where 	coalesce(cd_convenio, cd_convenio_p) = cd_convenio_p
and	((coalesce(cd_categoria_p::text, '') = '') or (coalesce(cd_categoria, cd_categoria_p) = cd_categoria_p))
and	coalesce(cd_estabelecimento,cd_estabelecimento_w)	= cd_estabelecimento_w
and	coalesce(cd_plano_convenio,coalesce(cd_plano_conv_p,'0'))	= coalesce(cd_plano_conv_p,'0')
and	((coalesce(cd_setor_atendimento::text, '') = '') or (coalesce(cd_setor_atendimento, coalesce(cd_setor_atend_p,0)) = coalesce(cd_setor_atend_p,0)))
and	((coalesce(cd_local_estoque::text, '') = '') or (coalesce(cd_local_estoque, coalesce(cd_local_estoque_p, 0)) = coalesce(cd_local_estoque_p,0)))
and	((coalesce(ie_tipo_material::text, '') = '') or (coalesce(ie_tipo_material, coalesce(ie_tipo_material_p, '0')) = coalesce(ie_tipo_material_p, '0')))
and 	coalesce(cd_classe_material, cd_classe_w)		= cd_classe_w
and 	coalesce(cd_subgrupo_material, cd_subgrupo_w) 	= cd_subgrupo_w
and 	coalesce(cd_grupo_material, cd_grupo_w) 	 	= cd_grupo_w
order by	coalesce(cd_convenio,0),
		coalesce(cd_estabelecimento,0),
		coalesce(cd_classe_material,0),
		coalesce(cd_subgrupo_material,0),
		coalesce(cd_grupo_material,0),
		nr_sequencia;


BEGIN

cd_estabelecimento_w := coalesce(cd_estabelecimento_p,0);


select	coalesce(max(a.cd_classe_material),0),
	coalesce(max(b.cd_subgrupo_material),0),
	coalesce(max(c.cd_grupo_material),0)
into STRICT	cd_classe_w,
	cd_subgrupo_w,
	cd_grupo_w
from	material a,
	classe_material b,
	subgrupo_material c
where	a.cd_material          = cd_material_p
and 	a.cd_classe_material   = b.cd_classe_material
and 	b.cd_subgrupo_material = c.cd_subgrupo_material;

open c01;
loop
	fetch c01 into
		ie_regra_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
		ie_regra_w := ie_regra_w;
end loop;
close c01;

if (coalesce(ie_regra_w::text, '') = '') then
	ie_regra_w	:= 'PI';
end if;
return ie_regra_w;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_regra_material_conta ( cd_convenio_p bigint, cd_categoria_p text, cd_estabelecimento_p bigint, ie_evento_p text, cd_plano_conv_p text, cd_setor_atend_p bigint, cd_local_estoque_p bigint, ie_tipo_material_p text, cd_material_p bigint) FROM PUBLIC;

