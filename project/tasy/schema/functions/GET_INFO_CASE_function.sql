-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION get_info_case (nr_case_p bigint, ie_opcao_p text) RETURNS varchar AS $body$
DECLARE


nr_atendimento_w		atendimento_paciente.nr_atendimento%type;
ie_tipo_episodio_w		tipo_episodio.ie_tipo%type;
dt_entrada_w		varchar(50);
ds_tipo_admissao_fat_w	varchar(50);
ds_departament_w		varchar(50);
ds_retorno_w		varchar(255);


BEGIN

if (nr_case_p IS NOT NULL AND nr_case_p::text <> '') and (ie_opcao_p IS NOT NULL AND ie_opcao_p::text <> '') then
	
	select	max(b.ie_tipo)
	into STRICT	ie_tipo_episodio_w
	from	episodio_paciente a,
		tipo_episodio b
	where   a.nr_seq_tipo_episodio = b.nr_sequencia
	and	a.nr_sequencia = nr_case_p;
	
	
	select  min(nr_atendimento)
	into STRICT    nr_atendimento_w
	from    atendimento_paciente a
	where   a.nr_seq_episodio 	   = nr_case_p
	and	a.ie_tipo_atendimento      = (ie_tipo_episodio_w)::numeric
	and	a.nr_atendimento  	   = (SELECT  min(x.nr_atendimento)
					      from    atendimento_paciente x
					      where   x.nr_seq_episodio 	 = a.nr_seq_episodio
					      and     x.ie_tipo_atendimento      = (ie_tipo_episodio_w)::numeric 
					      and     coalesce(x.dt_cancelamento::text, '') = '');
					
	if (nr_atendimento_w IS NOT NULL AND nr_atendimento_w::text <> '') then
	    select to_char(dt_entrada,'dd/mm/yyyy hh24:mi:ss'),
		   substr(obter_desc_visita_admissao(nr_seq_episodio, nr_seq_tipo_admissao_fat),1,50)
	    into STRICT   dt_entrada_w,
		   ds_tipo_admissao_fat_w 
            from   atendimento_paciente
	    where  nr_atendimento = nr_atendimento_w;
	
	    select substr(obter_nome_departamento_medico(a.cd_departamento, 'S'),1,50)
	    into STRICT   ds_departament_w
	    from   atend_paciente_unidade a
	    where  a.nr_atendimento = nr_atendimento_w
	    and	   a.nr_sequencia 	= (SELECT min(x.nr_sequencia) x
					   from   atend_paciente_unidade x
					   where  x.nr_atendimento = a.nr_atendimento);
	
	    if (ie_opcao_p = 'T') then 
		ds_retorno_w := ds_tipo_admissao_fat_w;
	    elsif (ie_opcao_p = 'E') then
		ds_retorno_w := dt_entrada_w;
	    elsif (ie_opcao_p = 'D') then
		ds_retorno_w := ds_departament_w;
	    end if;
	end if;				
end if;

return ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION get_info_case (nr_case_p bigint, ie_opcao_p text) FROM PUBLIC;

