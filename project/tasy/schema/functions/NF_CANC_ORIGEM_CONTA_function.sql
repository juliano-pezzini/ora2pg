-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION nf_canc_origem_conta (nr_sequencia_nf_p bigint) RETURNS varchar AS $body$
DECLARE

						
nr_sequencia_w  	 	nota_fiscal.nr_sequencia%type;
nr_nfe_imp_w     		nota_fiscal.nr_nfe_imp%type;
nr_seq_conta_origem_w    	conta_paciente.nr_interno_conta%type;
nr_seq_conta_origem_loop_w 	conta_paciente.nr_interno_conta%type;


BEGIN

if (nr_sequencia_nf_p IS NOT NULL AND nr_sequencia_nf_p::text <> '') then
  
	begin
		SELECT	coalesce(nr_sequencia,0)
		into STRICT	nr_sequencia_w	
		FROM	nota_fiscal
		WHERE	nr_sequencia = fis_get_origem_nf_cancelada_mx(nr_sequencia_nf_p)
		AND	    (nr_nfe_imp IS NOT NULL AND nr_nfe_imp::text <> '');
	exception
			when others then
		nr_sequencia_w := 0;
	end;

	if (nr_sequencia_w < 1) then
	
		select  substr(obter_nf_conta(max(cp.nr_seq_conta_origem),1),1,100),
			max(cp.nr_seq_conta_origem)
		into STRICT   	nr_sequencia_w,
			nr_seq_conta_origem_w
		from    nota_fiscal nf,
			conta_paciente cp
		where 	nf.nr_interno_conta = cp.nr_interno_conta 
		and 	nf.nr_sequencia = nr_sequencia_nf_p;
		
		if (nr_sequencia_w IS NOT NULL AND nr_sequencia_w::text <> '') then

			select 	max(a.nr_nfe_imp)
			into STRICT   	nr_nfe_imp_w
			from   	nota_fiscal a,
				conta_paciente c
			where  	a.nr_sequencia = nr_sequencia_w
			and    	c.nr_interno_conta = a.nr_interno_conta
			and     ((coalesce(c.nr_seq_conta_origem::text, '') = '') 
			or (exists (SELECT 1
			from 	fis_tipo_relacao b
			where   a.nr_sequencia_ref = b.nr_seq_nota
			and     b.cd_tipo_relacao = '04')));
					
			
			while(coalesce(nr_nfe_imp_w::text, '') = '') loop
						
				select  substr(obter_nf_conta(max(cp.nr_seq_conta_origem),1),1,100),
					max(cp.nr_seq_conta_origem)
				into STRICT   	nr_sequencia_w,
					nr_seq_conta_origem_loop_w
				from  	conta_paciente cp
				where 	cp.nr_interno_conta = nr_seq_conta_origem_w;
				
				if (nr_sequencia_w IS NOT NULL AND nr_sequencia_w::text <> '') then
				
					select 	max(a.nr_nfe_imp)
					into STRICT   	nr_nfe_imp_w
					from   	nota_fiscal a,
						conta_paciente c
					where  	a.nr_sequencia = nr_sequencia_w
					and    	c.nr_interno_conta = a.nr_interno_conta
					and     ((coalesce(c.nr_seq_conta_origem::text, '') = '')
					or (exists (SELECT 1
					from 	fis_tipo_relacao b
					where   a.nr_sequencia_ref = b.nr_seq_nota
					and     b.cd_tipo_relacao = '04')));
					
					
					if (coalesce(nr_nfe_imp_w::text, '') = '') then
						nr_seq_conta_origem_w := nr_seq_conta_origem_loop_w;
					end if;
				
				else		
					nr_nfe_imp_w := 0;
					
				end if;
			
			end loop;
		end if;

	end if;
end if;
  
return nr_sequencia_w;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION nf_canc_origem_conta (nr_sequencia_nf_p bigint) FROM PUBLIC;

