-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_composto_medic (nr_prescricao_p bigint, nr_seq_medic_p bigint, nr_agrupamento_p bigint) RETURNS varchar AS $body$
DECLARE


ds_comp_w	varchar(2000);
ds_medic_w	varchar(100);
qt_dose_w	double precision;
cd_um_w		varchar(30);
ds_obs_med_w  varchar(4000) := '';
ie_agrupador_origem_w	smallint;

c01 CURSOR FOR
SELECT	substr(obter_desc_material(cd_material),1,100) ds_medic,
	qt_dose,
	cd_unidade_medida_dose,
	ds_observacao
from	prescr_material
where	nr_prescricao	= nr_prescricao_p
and	nr_sequencia	< nr_seq_medic_p
and	nr_agrupamento	= nr_agrupamento_p
and	ie_agrupador	= 1
and	ie_agrupador	= ie_agrupador_origem_w
and	ie_origem_inf	<> 'K'
and coalesce(nr_seq_substituto::text, '') = ''
and coalesce(ie_suspenso, 'N') = 'N'
order by
	ds_medic;


BEGIN

select  max(ie_agrupador)
into STRICT 	ie_agrupador_origem_w
from	prescr_material
where	nr_prescricao = nr_prescricao_p
and	nr_sequencia  = nr_seq_medic_p;

if (nr_prescricao_p IS NOT NULL AND nr_prescricao_p::text <> '') and (nr_seq_medic_p IS NOT NULL AND nr_seq_medic_p::text <> '') and (nr_agrupamento_p IS NOT NULL AND nr_agrupamento_p::text <> '') then

	open c01;
	loop
	fetch c01 into
		ds_medic_w,
		qt_dose_w,
		cd_um_w,
		ds_obs_med_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
		begin
		if (coalesce(ds_comp_w::text, '') = '') then
			ds_comp_w := ds_medic_w || ' ' || to_char(qt_dose_w) || ' ' || cd_um_w;
		elsif (length(ds_comp_w) < 1875) then
			ds_comp_w := ds_comp_w || chr(10) || ds_medic_w || ' ' || to_char(qt_dose_w) || ' ' || cd_um_w;
		end if;

		if (ds_obs_med_w IS NOT NULL AND ds_obs_med_w::text <> '') then
		if (ds_comp_w IS NOT NULL AND ds_comp_w::text <> '') then
			ds_comp_w := substr(ds_comp_w || chr(10) || wheb_mensagem_pck.get_texto(306902, null) || ds_obs_med_w,1,1900) || ';'; --  - OBS MED:
		else
			ds_comp_w := substr(wheb_mensagem_pck.get_texto(306902, null) || ds_obs_med_w,1,1900) || ';'; --  - OBS MED:
		end if;
		end if;
		end;
	end loop;
	close c01;

end if;

if (ds_comp_w IS NOT NULL AND ds_comp_w::text <> '') then
	select	max(substr(obter_desc_material(cd_material),1,100)),
		max(qt_dose),
		max(cd_unidade_medida_dose)
	into STRICT	ds_medic_w,
		qt_dose_w,
		cd_um_w
	from	prescr_material
	where	nr_prescricao	= nr_prescricao_p
	and	nr_sequencia	= nr_seq_medic_p
	and	nr_agrupamento	= nr_agrupamento_p
	and	ie_agrupador	= 1
	and	ie_origem_inf	<> 'K';

	if (length(ds_comp_w) < 1875) then
		ds_comp_w := ds_comp_w || chr(10) || ds_medic_w || ' ' || to_char(qt_dose_w) || ' ' || cd_um_w;
	end if;
end if;

return ds_comp_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_composto_medic (nr_prescricao_p bigint, nr_seq_medic_p bigint, nr_agrupamento_p bigint) FROM PUBLIC;

