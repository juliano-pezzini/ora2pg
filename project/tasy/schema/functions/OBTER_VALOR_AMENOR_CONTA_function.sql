-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_valor_amenor_conta (nr_interno_conta_p bigint, cd_autorizacao_p text) RETURNS bigint AS $body$
DECLARE


vl_amenor_w		double precision := 0;
vl_guia_w		double precision;
vl_pago_w		double precision;
vl_glosa_aceita_w		double precision;
vl_acatado_w		lote_audit_hist_item.vl_acatado%type;

BEGIN

select	sum(a.vl_guia)
into STRICT	vl_guia_w
from	conta_paciente_guia a
where	a.nr_interno_conta	= nr_interno_conta_p
and	a.cd_autorizacao 	= coalesce(cd_autorizacao_p, a.cd_autorizacao)
and	exists (SELECT	1
	from	convenio_retorno x,
		convenio_retorno_item y
	where	y.nr_seq_retorno	= x.nr_sequencia
	and	y.nr_interno_conta	= a.nr_interno_conta
	and	y.cd_autorizacao	= coalesce(cd_autorizacao_p, y.cd_autorizacao)
	and	x.ie_status_retorno	= 'F');

select 	sum(a.vl_pago + a.vl_glosado + coalesce(a.vl_desconto,0))
into STRICT	vl_pago_w
from	convenio_retorno b,
	convenio_retorno_item a
where	a.nr_seq_retorno	= b.nr_sequencia
and	b.ie_status_retorno	= 'F'
and	a.nr_interno_conta	= nr_interno_conta_p
and	a.cd_autorizacao 	= coalesce(cd_autorizacao_p, a.cd_autorizacao);


select 	sum(b.vl_acatado)
into STRICT	vl_acatado_w
from	lote_audit_hist_guia a,
	lote_audit_hist_item b,
	lote_audit_hist c
where	a.nr_sequencia	= b.nr_seq_guia
and	c.nr_sequencia = a.nr_seq_lote_hist
and	a.nr_interno_conta	= nr_interno_conta_p
and	a.cd_autorizacao 	= coalesce(cd_autorizacao_p, a.cd_autorizacao)
and	(a.dt_baixa_glosa IS NOT NULL AND a.dt_baixa_glosa::text <> '');

select	sum(x.vl_glosa_aceita)
into STRICT	vl_glosa_aceita_w
from (
	SELECT	coalesce(sum(vl_glosa),0) as vl_glosa_aceita
	from   	titulo_receber a,
		titulo_receber_liq b 
	where  	a.nr_interno_conta = nr_interno_conta_p
	and  	a.nr_titulo = b.nr_titulo
	and	coalesce(b.nr_seq_retorno::text, '') = '' --ja traz o valor no select do retorno
	
union
 
	SELECT 	coalesce(sum(i.vl_glosa),0)
	from	titulo_receber a, 
		titulo_receber_liq b, 
		lote_audit_hist_guia g, 
		lote_audit_hist_item i,
		convenio_retorno r 
	where	a.nr_titulo 		= b.nr_titulo 
	and    	g.nr_sequencia 		= b.nr_seq_lote_hist_guia 
	and 	g.nr_seq_retorno 	= r.nr_sequencia 
	and	i.nr_seq_guia		= g.nr_sequencia
	and 	r.ie_status_retorno 	= 'F' 
	and	i.ie_acao_glosa		in ('A','P')
	and  	coalesce(a.nr_interno_conta::text, '') = ''
	and	coalesce(b.nr_seq_retorno::text, '') = '' --ja traz o valor no select do retorno
	and	g.nr_interno_conta 	= nr_interno_conta_p	
) x;

vl_amenor_w		:= coalesce(vl_guia_w,0) - coalesce(vl_pago_w,0) - coalesce(vl_glosa_aceita_w,0) - coalesce(vl_acatado_w,0);
return vl_amenor_w;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_valor_amenor_conta (nr_interno_conta_p bigint, cd_autorizacao_p text) FROM PUBLIC;

