-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_valores_consulta_tit_cp ( nr_interno_conta_p titulo_receber.nr_interno_conta%type, nr_seq_protocolo_p titulo_receber.nr_seq_protocolo%type, nm_usuario_p text, ie_opcao_p text) RETURNS bigint AS $body$
DECLARE

/*
ie_opcao_p

 VG 	- valor de glosa
 VGAUD - valor de glosa - conta paciente auditoria
 VGA 	- valor de glosa aceita - grg
 VM 	- valor a menor
 VMA 	- valor a maior
 VP 		- valor perda
 VC 		- valor da conta
 VR 		- valor recebido
 VD 	- valor desconto
 VS 		- valor de saldo

 VTT 	- valor total do titulo
 VRT 	- valor recebido do titulo
 VST 	- valor saldo do titulo
*/
vl_retorno_w		titulo_receber_liq.vl_glosa%type;
ie_param_379_w		funcao_parametro.vl_parametro%type;
cd_estab_w		conta_paciente.cd_estabelecimento%type;
ie_opcao_w		varchar(5);


BEGIN
	ie_opcao_w := upper(ie_opcao_p);

	if (ie_opcao_w = 'VG') then

		select  coalesce(sum(a.vl_glosado),0)
		into STRICT	vl_retorno_w
		from    convenio_retorno_item  a,
			convenio_retorno b 
		where   a.nr_seq_retorno     = b.nr_sequencia 
		and     b.ie_status_retorno  = 'F'
		and     a.nr_interno_conta   = nr_interno_conta_p;

		if (vl_retorno_w = 0) then
		begin
			select 	coalesce(sum(vl_glosa),0) vl_glosa
			into STRICT	vl_retorno_w
			from ( 
				SELECT 	coalesce(sum(b.vl_glosa),0) vl_glosa
				from   	titulo_receber a,  
					titulo_receber_liq b 
				where  	a.nr_interno_conta 	= nr_interno_conta_p
				and  	a.nr_titulo 		= b.nr_titulo
				and	coalesce(a.nr_seq_protocolo::text, '') = ''
				and	not exists (
					SELECT	1  
					from	lote_audit_tit_rec c,
						conta_paciente_ret_hist d, 
						conta_paciente_retorno e 
					where	c.nr_sequencia 		= b.nr_documento 
					and    	c.nr_sequencia 		= d.nr_seq_lote_audit 
					and    	d.nr_seq_conpaci_ret 	= e.nr_sequencia 
					and    	e.nr_interno_conta 	= nr_interno_conta_p 
					and	(c.dt_baixa IS NOT NULL AND c.dt_baixa::text <> '')
				)
				and	not exists (
					select 	1
					from	titulo_receber a, 
						titulo_receber_liq b, 
						lote_audit_hist_guia g, 
						lote_audit_hist_item i,
						convenio_retorno r 
					where	a.nr_titulo 		= b.nr_titulo 
					and    	g.nr_sequencia 		= b.nr_seq_lote_hist_guia 
					and 	g.nr_seq_retorno 	= r.nr_sequencia 
					and	i.nr_seq_guia		= g.nr_sequencia
					and 	r.ie_status_retorno 	= 'F' 
					and	i.ie_acao_glosa		in ('A','P')
					and	g.nr_interno_conta 	= nr_interno_conta_p
				)
				
union
 
				select 	coalesce(sum(b.vl_glosa),0) vl_glosa 
				from   	titulo_receber a,
					titulo_receber_liq b,
					lote_audit_hist_guia c
				where  	a.nr_seq_protocolo 	= nr_seq_protocolo_p
				and  	a.nr_titulo 		= b.nr_titulo 
				and  	b.nr_seq_lote_hist_guia = c.nr_sequencia
				and	c.nr_interno_conta 	= nr_interno_conta_p
				and	not exists (
					select	1  
					from	lote_audit_tit_rec c,
						conta_paciente_ret_hist d, 
						conta_paciente_retorno e 
					where	c.nr_sequencia 		= b.nr_documento 
					and    	c.nr_sequencia 		= d.nr_seq_lote_audit 
					and    	d.nr_seq_conpaci_ret 	= e.nr_sequencia 
					and    	e.nr_interno_conta 	= nr_interno_conta_p 
					and	(c.dt_baixa IS NOT NULL AND c.dt_baixa::text <> '')
				)
				and	not exists (
					select 	1
					from	titulo_receber a, 
						titulo_receber_liq b, 
						lote_audit_hist_guia g, 
						lote_audit_hist_item i,
						convenio_retorno r 
					where	a.nr_titulo 		= b.nr_titulo 
					and    	g.nr_sequencia 		= b.nr_seq_lote_hist_guia 
					and 	g.nr_seq_retorno 	= r.nr_sequencia 
					and	i.nr_seq_guia		= g.nr_sequencia
					and 	r.ie_status_retorno 	= 'F' 
					and	i.ie_acao_glosa		in ('A','P')
					and	g.nr_interno_conta 	= nr_interno_conta_p
				)
			) alias16;
		exception
		when others then
			vl_retorno_w := 0;
		end;
		end if;

		select	vl_retorno_w
		+	obter_valores_consulta_tit_cp(nr_interno_conta_p, nr_seq_protocolo_p, nm_usuario_p, 'VGA') --glosa aceita grg
		+ 	obter_valores_consulta_tit_cp(nr_interno_conta_p, nr_seq_protocolo_p, nm_usuario_p, 'VGAUD') --glosa conta paciente auditoria
		into STRICT	vl_retorno_w
		;

	elsif (ie_opcao_w = 'VGAUD') then

		begin
			select	coalesce(sum(b.vl_glosa),0)
			into STRICT	vl_retorno_w
			from	titulo_receber_liq b,
				titulo_receber a 
			where	a.nr_titulo = b.nr_titulo 
			and	((a.nr_interno_conta = nr_interno_conta_p) 
			or (a.nr_seq_protocolo = nr_seq_protocolo_p))
			and	coalesce(b.nr_seq_retorno::text, '') = '' --no VG ja traz do retorno
			and	exists (
				SELECT	1  
				from	lote_audit_tit_rec c,
					conta_paciente_ret_hist d, 
					conta_paciente_retorno e 
				where	c.nr_sequencia 		= b.nr_documento 
				and    	c.nr_sequencia 		= d.nr_seq_lote_audit 
				and    	d.nr_seq_conpaci_ret 	= e.nr_sequencia 
				and    	e.nr_interno_conta 	= nr_interno_conta_p 
				and	(c.dt_baixa IS NOT NULL AND c.dt_baixa::text <> '')
			);
		exception
		when others then
			vl_retorno_w := 0;
		end;

	elsif (ie_opcao_w = 'VGA') then

		select 	coalesce(sum(b.vl_glosa),0)
		into STRICT	vl_retorno_w
		from	titulo_receber a,
				titulo_receber_liq b, 
				lote_audit_hist_guia g,
				convenio_retorno r 
		where	a.nr_titulo 			= b.nr_titulo 
		and    	g.nr_sequencia 		= b.nr_seq_lote_hist_guia 
		and 	g.nr_seq_retorno 	= r.nr_sequencia 
		and 	r.ie_status_retorno 	= 'F' 
		and	g.nr_interno_conta 	= nr_interno_conta_p;

	elsif (ie_opcao_w = 'VMA') then

		select  coalesce(sum(a.vl_adicional),0)
		into STRICT	vl_retorno_w
		from    convenio_retorno_item  a,
			convenio_retorno b 
		where   a.nr_seq_retorno     = b.nr_sequencia 
		and     b.ie_status_retorno  = 'F'
		and     a.nr_interno_conta   = nr_interno_conta_p;

	elsif (ie_opcao_w = 'VP') then

		select  coalesce(sum(a.vl_perdas),0)
		into STRICT	vl_retorno_w
		from    convenio_retorno_item  a,
			convenio_retorno b 
		where   a.nr_seq_retorno     = b.nr_sequencia 
		and     b.ie_status_retorno  = 'F'
		and     a.nr_interno_conta   = nr_interno_conta_p;

	elsif (ie_opcao_w = 'VC') then

		select 	sum(vl_item)
		into STRICT	vl_retorno_w
		from 	conta_paciente_v
		where 	nr_interno_conta = nr_interno_conta_p
		and 	coalesce(cd_motivo_exc_conta::text, '') = ''
		and 	((ie_proc_mat = 2) or (coalesce(nr_seq_proc_pacote::text, '') = '' or nr_sequencia <> nr_seq_proc_pacote));

	elsif (ie_opcao_w = 'VR') then

		select	cd_estabelecimento
		into STRICT	cd_estab_w
		from	conta_paciente
		where	nr_interno_conta = nr_interno_conta_p;

		ie_param_379_w := obter_param_usuario(67, 379, obter_perfil_ativo, nm_usuario_p, cd_estab_w, ie_param_379_w);

		select  sum(coalesce(b.vl_recebido,0))
		into STRICT	vl_retorno_w
		from    titulo_receber_liq b,
			titulo_receber a
		where   a.nr_titulo 		= b.nr_titulo 
		and     a.nr_interno_conta 	= nr_interno_conta_p
		and	ie_param_379_w 		= 'N'
        	and 	coalesce(b.nr_seq_lote_hist_guia::text, '') = '';

		if (coalesce(vl_retorno_w,0) = 0) then

			select  coalesce(sum(a.vl_pago),0)
			into STRICT	vl_retorno_w
			from    convenio_retorno_item  a,
				convenio_retorno b 
			where   a.nr_seq_retorno     	= b.nr_sequencia 
			and     b.ie_status_retorno  	= 'F'
			and     a.nr_interno_conta   	= nr_interno_conta_p
			and	ie_param_379_w		= 'N';

			if (coalesce(vl_retorno_w,0) = 0) then

				select  sum(coalesce(a.vl_recebido,0))
				into STRICT	vl_retorno_w
				from    titulo_receber_liq a,
					convenio_retorno_item b,
					convenio_retorno c
				where   a.nr_seq_ret_item 	= b.nr_sequencia
				and	b.nr_seq_retorno     	= c.nr_sequencia
				and     c.ie_status_retorno  	= 'F'
				and	b.nr_interno_conta 	= nr_interno_conta_p
                		and 	coalesce(a.nr_seq_lote_hist_guia::text, '') = '';

				if (coalesce(vl_retorno_w,0) = 0) then

					select  sum(coalesce(b.vl_recebido,0))
					into STRICT	vl_retorno_w
					from    titulo_receber_liq b,
						titulo_receber a
					where   a.nr_titulo 		= b.nr_titulo 
					and     a.nr_seq_protocolo 	= nr_seq_protocolo_p
                    			and 	coalesce(b.nr_seq_lote_hist_guia::text, '') = '';

					if (vl_retorno_w = obter_total_protocolo(nr_seq_protocolo_p)) then
						vl_retorno_w := obter_valores_consulta_tit_cp(nr_interno_conta_p, nr_seq_protocolo_p, nm_usuario_p, 'VC');
					else
						vl_retorno_w := 0;
					end if;
				end if;
			end if;
		end if;

		--incrementando o valor acatado GRG no valor recebido
		select 	coalesce(sum(i.vl_acatado),0) + vl_retorno_w
		into STRICT	vl_retorno_w
		from   	lote_auditoria l,
				lote_audit_hist a,
				lote_audit_hist_guia g,
				lote_audit_hist_item i,
				conta_paciente c
		where  	l.cd_convenio = c.cd_convenio_parametro
		and		l.nr_sequencia = a.nr_seq_lote_audit
		and		a.nr_sequencia = g.nr_seq_lote_hist
		and		g.nr_sequencia = i.nr_seq_guia
		and		g.nr_interno_conta = c.nr_interno_conta
		and    	c.nr_interno_conta = nr_interno_conta_p;

	elsif (ie_opcao_w = 'VD') then	

		select 	coalesce(sum(vl_desconto),0)
		into STRICT	vl_retorno_w
		from 	convenio_retorno_item 
		where 	nr_interno_conta = nr_interno_conta_p;

		select 	coalesce(sum(b.vl_descontos),0)
			+ vl_retorno_w
		into STRICT	vl_retorno_w
		from   	titulo_receber a,  
			titulo_receber_liq b 
		where  	a.nr_interno_conta 	= nr_interno_conta_p
		and  	a.nr_titulo 		= b.nr_titulo;

	elsif (ie_opcao_w = 'VS') then	

		select	obter_valores_consulta_tit_cp(nr_interno_conta_p, nr_seq_protocolo_p, nm_usuario_p, 'VC') --conta
		- 	obter_valores_consulta_tit_cp(nr_interno_conta_p, nr_seq_protocolo_p, nm_usuario_p, 'VR') --recebido
		- 	obter_valores_consulta_tit_cp(nr_interno_conta_p, nr_seq_protocolo_p, nm_usuario_p, 'VG') --glosa
		- 	obter_valores_consulta_tit_cp(nr_interno_conta_p, nr_seq_protocolo_p, nm_usuario_p, 'VD') --desconto
		- 	obter_valores_consulta_tit_cp(nr_interno_conta_p, nr_seq_protocolo_p, nm_usuario_p, 'VP') --perdas
        	-   	obter_valores_consulta_tit_cp(nr_interno_conta_p, nr_seq_protocolo_p, nm_usuario_p, 'VT') --tributos
		into STRICT	vl_retorno_w
		;

	elsif (ie_opcao_w = 'VM') then	

		select	obter_valor_amenor_conta(nr_interno_conta_p, null)
		-	obter_valores_consulta_tit_cp(nr_interno_conta_p, nr_seq_protocolo_p, nm_usuario_p, 'VD') --recebido
		into STRICT	vl_retorno_w
		;

	elsif (ie_opcao_w = 'VTT') then	

		select 	coalesce(sum(vl_titulo),0)
		into STRICT	vl_retorno_w
		from (
			SELECT  coalesce(sum(obter_valor_tit_rec_desdobrado(a.nr_titulo)),0) vl_titulo 
			from    titulo_receber a
			where   a.nr_interno_conta = nr_interno_conta_p
			
union 	all

			PERFORM  coalesce(sum(obter_valor_tit_rec_desdobrado(a.nr_titulo)),0) vl_titulo 
			from    titulo_receber a
			where   a.nr_seq_protocolo = nr_seq_protocolo_p
			and     coalesce(a.nr_interno_conta::text, '') = ''
		) alias10;

	elsif (ie_opcao_w = 'VRT') then	

		select 	coalesce(sum(vl_recebido),0)
		into STRICT	vl_retorno_w
		from ( 
			SELECT 	coalesce(sum(b.vl_recebido + b.vl_glosa + b.vl_descontos),0) vl_recebido
			from   	titulo_receber a,
				titulo_receber_liq b
			where  	a.nr_interno_conta 	= nr_interno_conta_p
			and  	a.nr_titulo 		= b.nr_titulo
			and	coalesce(a.nr_seq_protocolo::text, '') = ''
			
union
 
			SELECT 	coalesce(sum(b.vl_recebido + b.vl_glosa + b.vl_descontos),0) vl_recebido 
			from   	titulo_receber a,
				titulo_receber_liq b
			where  	a.nr_seq_protocolo 	= nr_seq_protocolo_p
			and  	a.nr_titulo 		= b.nr_titulo 
			and	coalesce(a.nr_interno_conta::text, '') = ''
			
union

			select 	coalesce(sum(b.vl_recebido + b.vl_glosa + b.vl_descontos),0) vl_recebido
			from   	titulo_receber a,
				titulo_receber_liq b
			where  	a.nr_interno_conta 	= nr_interno_conta_p
			and  	a.nr_seq_protocolo 	= nr_seq_protocolo_p
			and  	a.nr_titulo 		= b.nr_titulo
		) alias11;

	elsif (ie_opcao_w = 'VST') then	

		select	obter_valores_consulta_tit_cp(nr_interno_conta_p, nr_seq_protocolo_p, nm_usuario_p, 'VTT')
		-	obter_valores_consulta_tit_cp(nr_interno_conta_p, nr_seq_protocolo_p, nm_usuario_p, 'VRT')
		into STRICT	vl_retorno_w
		;

		select 	vl_retorno_w - coalesce(sum(vl_tributo),0)
		into STRICT	vl_retorno_w
		from ( 
			SELECT  coalesce(sum(x.vl_tributo),0) vl_tributo 
			from    titulo_receber_trib x, 
				titulo_receber a 
			where   x.nr_titulo		= a.nr_titulo 
			and     a.nr_interno_conta 	= nr_interno_conta_p
			and     coalesce(x.ie_origem_tributo, 'C') in ( 'D', 'CD' )
			and     coalesce(a.nr_seq_protocolo::text, '') = '' 
			
union
 
			SELECT  coalesce(sum(x.vl_tributo),0) vl_tributo 
			from    titulo_receber_trib x, 
				titulo_receber a 
			where   x.nr_titulo		= a.nr_titulo 
			and     a.nr_seq_protocolo 	= nr_seq_protocolo_p
			and     coalesce(a.nr_interno_conta::text, '') = '' 
			and     coalesce(x.ie_origem_tributo, 'C') in ( 'D', 'CD' )
			
union
 
			select  coalesce(sum(x.vl_tributo),0) vl_tributo 
			from    titulo_receber_trib x, 
				titulo_receber a 
			where   x.nr_titulo		= a.nr_titulo 
			and     a.nr_seq_protocolo 	= nr_seq_protocolo_p
			and     a.nr_interno_conta 	= nr_interno_conta_p
			and     coalesce(x.ie_origem_tributo, 'C') in ( 'D', 'CD' )
		) alias16;

	elsif (ie_opcao_w = 'VT') then

		select 	coalesce(sum(vl_tributo),0)
		into STRICT	vl_retorno_w
		from ( 
			SELECT  coalesce(sum(x.vl_tributo),0) vl_tributo 
			from    titulo_receber_trib x, 
				titulo_receber a 
			where   x.nr_titulo		= a.nr_titulo 
			and     a.nr_interno_conta 	= nr_interno_conta_p
			and     coalesce(x.ie_origem_tributo, 'C') in ( 'D', 'CD' )
			and     coalesce(a.nr_seq_protocolo::text, '') = '' 
			
union
 
			SELECT  coalesce(sum(x.vl_tributo),0) vl_tributo 
			from    titulo_receber_trib x, 
				titulo_receber a 
			where   x.nr_titulo		= a.nr_titulo 
			and     a.nr_seq_protocolo 	= nr_seq_protocolo_p
			and     coalesce(a.nr_interno_conta::text, '') = '' 
			and     coalesce(x.ie_origem_tributo, 'C') in ( 'D', 'CD' )
			
union
 
			select  coalesce(sum(x.vl_tributo),0) vl_tributo 
			from    titulo_receber_trib x, 
				titulo_receber a 
			where   x.nr_titulo		= a.nr_titulo 
			and     a.nr_seq_protocolo 	= nr_seq_protocolo_p
			and     a.nr_interno_conta 	= nr_interno_conta_p
			and     coalesce(x.ie_origem_tributo, 'C') in ( 'D', 'CD' )
		) alias17;

	end if;

	if (vl_retorno_w < 0) then
		vl_retorno_w := 0;
	end if;

	return	coalesce(vl_retorno_w,0);

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_valores_consulta_tit_cp ( nr_interno_conta_p titulo_receber.nr_interno_conta%type, nr_seq_protocolo_p titulo_receber.nr_seq_protocolo%type, nm_usuario_p text, ie_opcao_p text) FROM PUBLIC;

