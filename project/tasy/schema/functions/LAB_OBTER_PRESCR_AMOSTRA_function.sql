-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION lab_obter_prescr_amostra (ds_amostra_p text, cd_estabelecimento_p bigint) RETURNS bigint AS $body$
DECLARE



nr_prescricao_w			bigint;
ie_padrao_amostra_w		varchar(5);


BEGIN

select 	MAX(ie_padrao_amostra)
into STRICT	ie_padrao_amostra_w
from 	lab_parametro
where	cd_estabelecimento = cd_estabelecimento_p;

if (ie_padrao_amostra_w = 'PM') then
	select 	MAX(b.nr_prescricao)
	into STRICT 	nr_prescricao_w
	from 	material_exame_lab a,
		prescr_procedimento b,
		prescr_medica c
	where 	b.nr_prescricao = c.nr_prescricao
	and	a.cd_material_exame = b.cd_material_exame
	and	a.nr_sequencia = (substr(ds_amostra_p,position('M' in ds_amostra_p)+1,length(ds_amostra_p)))::numeric
	and	lpad(b.nr_prescricao || 'M' || a.nr_sequencia,10,'0') = ds_amostra_p;
elsif (ie_padrao_amostra_w = 'PM11') then
	select 	MAX(b.nr_prescricao)
	into STRICT 	nr_prescricao_w
	from 	material_exame_lab a,
		prescr_procedimento b,
		prescr_medica c
	where 	b.nr_prescricao = c.nr_prescricao
	and	a.cd_material_exame = b.cd_material_exame
	and	a.nr_sequencia = (substr(ds_amostra_p,position('M' in ds_amostra_p)+1,length(ds_amostra_p)))::numeric
	and	lpad(b.nr_prescricao || 'M' || a.nr_sequencia,11,'0') = ds_amostra_p;
elsif (ie_padrao_amostra_w = 'PM13') then
	select 	MAX(b.nr_prescricao)
	into STRICT 	nr_prescricao_w
	from 	material_exame_lab a,
		prescr_procedimento b,
		prescr_medica c
	where 	b.nr_prescricao = c.nr_prescricao
	and	a.cd_material_exame = b.cd_material_exame
	and	a.nr_sequencia = (substr(ds_amostra_p,position('M' in ds_amostra_p)+1,length(ds_amostra_p)))::numeric
	and	lpad(b.nr_prescricao || 'M' || a.nr_sequencia,13,'0') = ds_amostra_p;
elsif (ie_padrao_amostra_w = 'PMR11') then
	select 	MAX(b.nr_prescricao)
	into STRICT 	nr_prescricao_w
	from 	exame_lab_resultado d,
		exame_lab_result_item e,
		prescr_procedimento b,
		prescr_medica c
	where 	b.nr_prescricao = c.nr_prescricao
	and	b.nr_prescricao	= d.nr_prescricao
	and	d.nr_seq_resultado 	= e.nr_seq_resultado
	and	b.nr_sequencia = e.nr_seq_prescr
	and	e.nr_seq_material = (substr(ds_amostra_p,position('M' in ds_amostra_p)+1,length(ds_amostra_p)))::numeric
	and	lpad(b.nr_prescricao || 'M' || e.nr_seq_material,11,'0') = ds_amostra_p;
elsif (ie_padrao_amostra_w = 'AMO9') then
	select 	MAX(nr_prescricao)
	into STRICT	nr_prescricao_w
	from 	prescr_proc_material
	where 	lpad(cd_barras,09,'0') = ds_amostra_p;
elsif (ie_padrao_amostra_w = 'AMO10') or (ie_padrao_amostra_w = 'AM10F') then
	select 	MAX(nr_prescricao)
	into STRICT	nr_prescricao_w
	from 	prescr_proc_material
	where 	lpad(cd_barras,10,'0') = ds_amostra_p;
elsif (ie_padrao_amostra_w = 'AMO11') or (ie_padrao_amostra_w = 'AM11F') then
	select 	MAX(nr_prescricao)
	into STRICT	nr_prescricao_w
	from 	prescr_proc_material
	where 	lpad(cd_barras,11,'0') = ds_amostra_p;
elsif (ie_padrao_amostra_w = 'AMO13') then
	select 	MAX(nr_prescricao)
	into STRICT	nr_prescricao_w
	from 	prescr_proc_material
	where 	lpad(cd_barras,13,'0') = ds_amostra_p;
elsif (ie_padrao_amostra_w = 'EAM10')	then
	select	MAX(nr_prescricao)
	into STRICT	nr_prescricao_w
	from prescr_proc_material
	where (lpad(substr(cd_estabelecimento_p, 1, 2), 2, 0)||lpad(cd_barras, 10, 0)) = ds_amostra_p;
end if;
return	nr_prescricao_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION lab_obter_prescr_amostra (ds_amostra_p text, cd_estabelecimento_p bigint) FROM PUBLIC;

