-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_inf_prot_glic (nr_atendimento_p bigint, nr_seq_glicemia_p bigint, nr_seq_protocolo_p bigint) RETURNS varchar AS $body$
DECLARE


ds_informacao_w		varchar(255);
nr_seq_inicio_w		bigint;
nr_seq_atual_w		bigint;
dt_inicio_hgt_w		timestamp;
dt_final_hgt_w		timestamp;
qt_dia_hgt_w		bigint;
qt_hora_hgt_w		bigint;


BEGIN
if (nr_atendimento_p IS NOT NULL AND nr_atendimento_p::text <> '') then
	/* obter medições cig */

	select	coalesce(min(nr_sequencia),0),
		coalesce(max(nr_sequencia),0)
	into STRICT	nr_seq_inicio_w,
		nr_seq_atual_w
	from	atendimento_glicemia
	where	nr_atendimento = nr_atendimento_p
	and	coalesce(nr_seq_glicemia,0) = coalesce(nr_seq_glicemia_p,nr_seq_glicemia)
	and	nr_seq_protocolo = nr_seq_protocolo_p;

	/* validar medições cig */

	if (nr_seq_inicio_w > 0) and (nr_seq_atual_w > 0) then
		/* obter dados primeira medição */

		select	dt_controle
		into STRICT	dt_inicio_hgt_w
		from	atendimento_glicemia
		where	nr_sequencia = nr_seq_inicio_w;

		/* obter dados medição atual */

		select	dt_controle
		into STRICT	dt_final_hgt_w
		from	atendimento_glicemia
		where	nr_sequencia = nr_seq_atual_w;

		/* calcular período medição */

		qt_dia_hgt_w	:= coalesce((trunc(dt_final_hgt_w,'dd') - trunc(dt_inicio_hgt_w,'dd')),0);
		qt_hora_hgt_w	:= coalesce(((dt_final_hgt_w - dt_inicio_hgt_w) * 24),0);
		if (qt_hora_hgt_w > 24) then
			qt_hora_hgt_w := (qt_hora_hgt_w - (qt_dia_hgt_w * 24));
		end if;

		/* montar mensagem informações */

		ds_informacao_w	:=	obter_desc_expressao(648277)/*' Início: '*/
 || to_char(dt_inicio_hgt_w,'dd/mm/yyyy hh24:mi')			|| CHR(10) ||
							' Última medição: ' || to_char(dt_final_hgt_w,'dd/mm/yyyy hh24:mi')										|| CHR(10) ||
							' Dias: ' || to_char(qt_dia_hgt_w)																		|| CHR(10) ||
							obter_desc_expressao(291453)/*' Horas: '*/
||': '|| to_char(qt_hora_hgt_w)								|| CHR(10);
	end if;
end if;

return ds_informacao_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_inf_prot_glic (nr_atendimento_p bigint, nr_seq_glicemia_p bigint, nr_seq_protocolo_p bigint) FROM PUBLIC;

