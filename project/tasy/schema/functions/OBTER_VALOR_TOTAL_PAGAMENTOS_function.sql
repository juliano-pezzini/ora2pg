-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_valor_total_pagamentos ( nm_usuario_p text, dt_inicial_p timestamp, dt_final_p timestamp, ie_tipo_data_p text, ie_status_p text, cd_estab_p bigint, ie_controla_todas_aprov_p text, ie_tipo_documento_p bigint, ie_status_docto_p bigint, ds_lista_titulos_p text) RETURNS varchar AS $body$
DECLARE

				
vl_total_bordero_w		double precision;
vl_total_escritural_w	double precision;
vl_total_titulo_w		double precision;
vl_total_recurso_w		double precision;
vl_total_w				varchar(255);


BEGIN

	/*Borderos a Pagar*/

	select  coalesce(sum((select  sum(vl_total_bordero) from titulo_pagar_bordero_v b where b.nr_bordero = a.nr_bordero)),0) vl_total_bordero
	into STRICT	vl_total_bordero_w
	from    bordero_pagamento a
	where   exists ( 
				SELECT	1 
				from	conta_pagar_lib d 
				where	d.nr_bordero		= a.nr_bordero 
				and		(((ie_controla_todas_aprov_p = 'N') and ((d.nm_usuario_lib IS NOT NULL AND d.nm_usuario_lib::text <> '' AND d.nm_usuario_lib = nm_usuario_p)
				or (d.cd_perfil = obter_perfil_ativo))) or (ie_controla_todas_aprov_p = 'S'))
				and		(('N' = ie_tipo_data_p) or ('DA' = ie_tipo_data_p and d.dt_liberacao between dt_inicial_p and fim_dia(dt_final_p)) or ('DR' = ie_tipo_data_p and d.dt_reprovacao between dt_inicial_p and fim_dia(dt_final_p)))
				and 	(('T' = ie_status_p) or ('A' = ie_status_p and (d.dt_liberacao IS NOT NULL AND d.dt_liberacao::text <> '')) or ('R' = ie_status_p and (d.dt_reprovacao IS NOT NULL AND d.dt_reprovacao::text <> '')) or ('P' = ie_status_p and coalesce(d.dt_reprovacao::text, '') = '' and coalesce(d.dt_liberacao::text, '') = ''))
				and 	ie_tipo_documento_p in (0,1)
				and		((ie_status_docto_p = 0) or (ie_status_docto_p = 1 and obter_se_pagamento_liberado(a.nr_bordero, 'B') = 'S') or (ie_status_docto_p = 2 and obter_se_pagamento_liberado(a.nr_bordero, 'B') = 'N') ) )
	and (coalesce(cd_estab_p,0) = 0 or cd_estab_p = a.cd_estabelecimento);
	
	/*Pagamento escritural*/

	
	select  sum(obter_valor_banco_escrit(a.nr_sequencia)) vl_total_escritural
	into STRICT	vl_total_escritural_w
	from    banco_escritural a 
	where   exists ( 
				SELECT  1 
				from	conta_pagar_lib d 
				where	d.nr_seq_banco_escrit	= a.nr_sequencia 
				and		(((ie_controla_todas_aprov_p = 'N') and ((d.nm_usuario_lib IS NOT NULL AND d.nm_usuario_lib::text <> '' AND d.nm_usuario_lib = nm_usuario_p)
				or (d.cd_perfil = obter_perfil_ativo))) or (ie_controla_todas_aprov_p = 'S'))
				and		(('N' = ie_tipo_data_p) or ('DA' = ie_tipo_data_p and dt_liberacao between dt_inicial_p and fim_dia(dt_final_p)) or ('DR' = ie_tipo_data_p and dt_reprovacao between dt_inicial_p and fim_dia(dt_final_p)))
				and 	(('T' = ie_status_p) or ('A' = ie_status_p and (dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')) or ('R' = ie_status_p and (dt_reprovacao IS NOT NULL AND dt_reprovacao::text <> '')) or ('P' = ie_status_p and coalesce(dt_reprovacao::text, '') = '' and coalesce(dt_liberacao::text, '') = ''))
				and 	ie_tipo_documento_p in (0,2)
				and		((ie_status_docto_p = 0) or (ie_status_docto_p = 1 and obter_se_pagamento_liberado(a.nr_sequencia, 'XX') = 'S') or (ie_status_docto_p = 2 and obter_se_pagamento_liberado(a.nr_sequencia, 'XX') = 'N') ) )
	and (coalesce(cd_estab_p,0) = 0 or cd_estab_p = a.cd_estabelecimento);

	/*Titulo Pagar*/
	
	select 	sum(vl_titulo) vl_total_titulo
	into STRICT	vl_total_titulo_w
	from 	(
	SELECT  a.nr_titulo,
			a.ds_beneficiario, 
			substr(obter_status_tit_pagamento(a.nr_titulo, a.nr_bordero, 'T', nm_usuario_p),1,255) ds_status,
			a.dt_vencimento_atual, 
			a.vl_titulo, 
			b.ie_nivel, 
			b.dt_liberacao, 
			b.dt_reprovacao, 
			c.nr_nota_fiscal, 
			substr(obter_dados_tit_pagar(a.nr_titulo,'OB'),1,255) ds_observacao
	FROM conta_pagar_lib b, titulo_pagar_v a
LEFT OUTER JOIN nota_fiscal c ON (a.nr_seq_nota_fiscal = c.nr_sequencia)
WHERE a.nr_titulo	= b.nr_titulo  and coalesce(b.nr_bordero::text, '') = '' and coalesce(b.nr_seq_banco_escrit::text, '') = '' and a.ie_situacao not in ('C','D') and (ie_controla_todas_aprov_p = 'N'
	and 	b.nm_usuario_lib = nm_usuario_p) and (substr(obter_se_regra_lib_tit(a.nr_titulo, nm_usuario_p, obter_perfil_ativo, a.cd_estabelecimento, CASE WHEN coalesce(a.cd_pessoa_fisica::text, '') = '' THEN 'J'  ELSE 'F' END , a.vl_titulo,CASE WHEN coalesce(a.cd_pessoa_fisica::text, '') = '' THEN null  ELSE (SELECT max(x.cd_tipo_pessoa) from pessoa_juridica x 		where x.cd_cgc = a.cd_cgc) END , a.nr_seq_nota_fiscal, coalesce(a.cd_cgc,0),coalesce(a.dt_emissao, clock_timestamp()), a.nr_seq_proj_rec, a.ie_tipo_titulo, a.nr_seq_classe, a.ie_origem_titulo, a.cd_operacao_nf, a.vl_total_nota, a.nr_ordem_compra_nf ),1,1) = 'S') and (('N' = ie_tipo_data_p) or ('DA' = ie_tipo_data_p and b.dt_liberacao between dt_inicial_p and fim_dia(dt_final_p)) or ('DR' = ie_tipo_data_p and b.dt_reprovacao between dt_inicial_p and fim_dia(dt_final_p))) and (('T' = ie_status_p) or ('A' = ie_status_p and (b.dt_liberacao IS NOT NULL AND b.dt_liberacao::text <> '')) or ('R' = ie_status_p and (b.dt_reprovacao IS NOT NULL AND b.dt_reprovacao::text <> '')) or ('P' = ie_status_p and coalesce(b.dt_reprovacao::text, '') = '' and coalesce(b.dt_liberacao::text, '') = '')) and ie_tipo_documento_p in (0,3) and ((obter_se_contido(a.nr_titulo,ds_lista_titulos_p) = 'S') or
			 coalesce(ds_lista_titulos_p,'X') = 'X') and ((coalesce(cd_estab_p,0) = 0 or cd_estab_p = a.cd_estabelecimento) or 
			 cd_estab_p = a.cd_estab_financeiro) and ((ie_status_docto_p = 0) or (ie_status_docto_p = 1 and obter_se_pagamento_liberado(a.nr_titulo, 'T') = 'S') or (ie_status_docto_p = 2 and obter_se_pagamento_liberado(a.nr_titulo, 'T') = 'N'))
	 
union all

	select  distinct a.nr_titulo, 
			a.ds_beneficiario, 
			substr(obter_status_tit_pagamento(a.nr_titulo, a.nr_bordero, 'T', nm_usuario_p),1,255) ds_status,
			a.dt_vencimento_atual, 
			a.vl_titulo, 
			b.ie_nivel, 
			b.dt_liberacao, 
			b.dt_reprovacao, 
			c.nr_nota_fiscal, 
			substr(obter_dados_tit_pagar(a.nr_titulo,'OB'),1,255) ds_observacao
	FROM conta_pagar_lib b, titulo_pagar_v a
LEFT OUTER JOIN nota_fiscal c ON (a.nr_seq_nota_fiscal = c.nr_sequencia)
WHERE a.nr_titulo	= b.nr_titulo  and coalesce(b.nr_bordero::text, '') = '' and coalesce(b.nr_seq_banco_escrit::text, '') = '' and a.ie_situacao not in ('C','D') and (ie_controla_todas_aprov_p = 'S') and (substr(obter_se_regra_lib_tit(a.nr_titulo, nm_usuario_p, obter_perfil_ativo ,  a.cd_estabelecimento, CASE WHEN coalesce(a.cd_pessoa_fisica::text, '') = '' THEN 'J'  ELSE 'F' END , a.vl_titulo,CASE WHEN coalesce(a.cd_pessoa_fisica::text, '') = '' THEN null  ELSE (select max(x.cd_tipo_pessoa) from pessoa_juridica x 		where x.cd_cgc = a.cd_cgc) END ,a.nr_seq_nota_fiscal, coalesce(a.cd_cgc,0), coalesce(a.dt_emissao, clock_timestamp()), a.nr_seq_proj_rec, a.ie_tipo_titulo, a.nr_seq_classe, a.ie_origem_titulo, a.cd_operacao_nf, a.vl_total_nota, a.nr_ordem_compra_nf ),1,1) = 'S') and (('N' = ie_tipo_data_p) or ('DA' = ie_tipo_data_p and b.dt_liberacao between dt_inicial_p and fim_dia(dt_final_p)) or ('DR' = ie_tipo_data_p and b.dt_reprovacao between dt_inicial_p and fim_dia(dt_final_p))) and (('T' = ie_status_p) or ('A' = ie_status_p and (b.dt_liberacao IS NOT NULL AND b.dt_liberacao::text <> '')) or ('R' = ie_status_p and (b.dt_reprovacao IS NOT NULL AND b.dt_reprovacao::text <> '')) or ('P' = ie_status_p and coalesce(b.dt_reprovacao::text, '') = '' and coalesce(b.dt_liberacao::text, '') = '')) and ie_tipo_documento_p in (0,3) and ((obter_se_contido(a.nr_titulo,ds_lista_titulos_p) = 'S') or
			 coalesce(ds_lista_titulos_p,'X') = 'X') and ((coalesce(cd_estab_p,0) = 0 or cd_estab_p = a.cd_estabelecimento) or 
			cd_estab_p = a.cd_estab_financeiro) and ((ie_status_docto_p = 0) or (ie_status_docto_p = 1 and obter_se_pagamento_liberado(a.nr_titulo, 'T') = 'S') or (ie_status_docto_p = 2 and obter_se_pagamento_liberado(a.nr_titulo, 'T') = 'N')) ) alias95;

	/* Gest√£o Recurso Glosa */

	select 	sum(CASE WHEN(select c.ie_tipo_valor from regra_lib_grg c where c.nr_sequencia = a.nr_seq_regra_lib)='A' THEN  b.vl_glosa WHEN(select c.ie_tipo_valor from regra_lib_grg c where c.nr_sequencia = a.nr_seq_regra_lib)='R' THEN  b.vl_recurso  ELSE 0 END ) vl_total_recurso
	into STRICT	vl_total_recurso_w
	from lote_audit_hist_lib a,
	lote_audit_hist b,
	lote_auditoria c
	where a.nr_seq_lote_audit_hist = b.nr_sequencia
	and	c.nr_sequencia = b.nr_seq_lote_audit
	and	ie_tipo_documento_p in (0,4)
	and (((ie_controla_todas_aprov_p = 'N') and	a.nm_usuario_lib = nm_usuario_p ) or (ie_controla_todas_aprov_p = 'S'))
	and	(('N' = ie_tipo_data_p) or ('DA' = ie_tipo_data_p and a.dt_aprovacao between dt_inicial_p and fim_dia(dt_final_p)) or ('DR' = ie_tipo_data_p and a.dt_reprovacao between dt_inicial_p and fim_dia(dt_final_p)))
	and (('T' = ie_status_p) or ('A' = ie_status_p and (a.dt_aprovacao IS NOT NULL AND a.dt_aprovacao::text <> '')) or ('R' = ie_status_p and (a.dt_reprovacao IS NOT NULL AND a.dt_reprovacao::text <> '')) or ('P' = ie_status_p and coalesce(a.dt_reprovacao::text, '') = '' and coalesce(a.dt_aprovacao::text, '') = ''));
	
	vl_total_w := coalesce(vl_total_bordero_w,0) + coalesce(vl_total_escritural_w,0) + coalesce(vl_total_titulo_w,0) + coalesce(vl_total_recurso_w,0);

return	vl_total_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_valor_total_pagamentos ( nm_usuario_p text, dt_inicial_p timestamp, dt_final_p timestamp, ie_tipo_data_p text, ie_status_p text, cd_estab_p bigint, ie_controla_todas_aprov_p text, ie_tipo_documento_p bigint, ie_status_docto_p bigint, ds_lista_titulos_p text) FROM PUBLIC;

