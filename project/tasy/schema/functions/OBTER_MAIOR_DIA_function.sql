-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';



CREATE TYPE campos AS (ds_ciclo	varchar(6));


CREATE OR REPLACE FUNCTION obter_maior_dia ( nr_sequencia_p bigint) RETURNS varchar AS $body$
DECLARE


ds_retorno_w	varchar(32000);
type vetor is table of campos index by integer;
ciclos_w			vetor;
posicao_w			smallint;
cont_w				bigint;
z 			    	integer;
Maior_w         	integer;
Maior_ds        	varchar(100);
retorno_ds      	varchar(4000);
nr_dias_setor_w	bigint;

c01 CURSOR FOR
	SELECT  CASE WHEN PM.DS_DIAS_APLICACAO='' THEN ''  ELSE PM.DS_DIAS_APLICACAO||',' END  ||
	CASE WHEN SOL.DS_DIAS_APLICACAO='' THEN ''  ELSE SOL.DS_DIAS_APLICACAO||',' END  ||
	CASE WHEN PP.DS_DIAS_APLICACAO='' THEN ''  ELSE PP.DS_DIAS_APLICACAO||',' END  ||
	CASE WHEN PR.DS_DIAS_APLICACAO='' THEN ''  ELSE PR.DS_DIAS_APLICACAO||',' END
	DS_DIAS_APLICACAO FROM paciente_setor ps
LEFT OUTER JOIN paciente_protocolo_medic pm ON (PS.NR_SEQ_PACIENTE = PM.NR_SEQ_PACIENTE)
LEFT OUTER JOIN paciente_protocolo_soluc sol ON (PS.NR_SEQ_PACIENTE = SOL.NR_SEQ_PACIENTE)
LEFT OUTER JOIN paciente_protocolo_proc pp ON (PS.NR_SEQ_PACIENTE = PP.NR_SEQ_PACIENTE)
LEFT OUTER JOIN paciente_protocolo_rec pr ON (PS.NR_SEQ_PACIENTE = PR.NR_SEQ_PACIENTE)
WHERE PS.NR_SEQ_PACIENTE = nr_sequencia_p;


BEGIN
	open c01;
	loop
	fetch c01 into
		retorno_ds;
	EXIT WHEN NOT FOUND; /* apply on c01 */
	begin
		ds_retorno_w := ds_retorno_w || retorno_ds;
	end;
	end loop;
	close C01;

	Maior_w := -999;
    ciclos_w.delete;
	z := 0;
	cont_w := 0;
	posicao_w	:= position(','  ds_retorno_w);

	while	posicao_w > 0 loop
		begin
			posicao_w	:= position(',' in ds_retorno_w);
			z := z + 1;
			ciclos_w[z].ds_ciclo	:= substr(ds_retorno_w,1,posicao_w - 1);
			ds_retorno_w		    := substr(ds_retorno_w,posicao_w + 1,length(ds_retorno_w));

			if Maior_w  <  substr(ciclos_w[z].ds_ciclo,2,3) then
			   Maior_w  :=   substr(ciclos_w[z].ds_ciclo,2,3);
			   Maior_ds :=   substr(ciclos_w[z].ds_ciclo,2,3);
			 end if;

			cont_w	:= cont_w + 1;
			if (cont_w > 100) then
				exit;
			end if;
		end;
		end loop;
	if (coalesce(Maior_ds::text, '') = '') or (Maior_ds = '') then

		select 	coalesce(somente_numero(nr_ciclos),0)
		into STRICT	nr_dias_setor_w
		from	paciente_setor
		where	nr_seq_paciente = nr_sequencia_p;

		if (nr_dias_setor_w > 0) then

			Maior_ds := to_char(nr_dias_setor_w);
		else
			Maior_ds := '99999';
		end if;
	end if;
	return 	Maior_ds;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION obter_maior_dia ( nr_sequencia_p bigint) FROM PUBLIC;

