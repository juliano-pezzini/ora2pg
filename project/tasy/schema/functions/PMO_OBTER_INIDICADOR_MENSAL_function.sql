-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION pmo_obter_inidicador_mensal (dt_inicial_p timestamp, dt_final_p timestamp, ie_tipo_indicador_p bigint) RETURNS bigint AS $body$
DECLARE



qt_horas_executadas_w			double precision;
qt_projetos_executados_w		double precision;
qt_recursos_w				double precision;
qt_resultado_w				double precision;
qt_backlog_w				double precision;
qt_total_proj_fim_mes_w			double precision;
qt_atraso_proj_fim_mes_w		double precision;
qt_proj_iniciacao_w			double precision;
pr_atraso_proj_fim_mes_w		double precision;
pr_assertividade_w			double precision;


BEGIN


/* Projetos executados no período */

if (ie_tipo_indicador_p	= 1) then
	select 	count(distinct NR_SEQ_PROJETO)
	into STRICT	qt_projetos_executados_w
	from  	w_analise_proj_dia a
	where 	a.DT_ANALISE between dt_inicial_p and dt_final_p;

	qt_resultado_w	:= qt_projetos_executados_w;

end if;

/* Projetos executados no período (em horas) */

if (ie_tipo_indicador_p	= 2) then


select	sum(qt_horas_trabalhadas)
into STRICT	qt_projetos_executados_w
from (
	SELECT sum(e.QT_MINUTO /60) qt_horas_trabalhadas
	from proj_projeto c, proj_cron_etapa b, proj_cronograma a, MAN_ORDEM_SERV_ATIV e
	where a.nr_sequencia = b.nr_seq_cronograma
	and (a.dt_aprovacao IS NOT NULL AND a.dt_aprovacao::text <> '')
	and b.nr_sequencia = e.NR_SEQ_PROJ_CRON_ETAPA
	and e.dt_atividade between dt_inicial_p  and dt_final_p
	and a.nr_seq_proj = c.nr_sequencia
	and c.nr_sequencia in (SELECT NR_SEQ_PROJETO
		from  	w_analise_proj_dia a
		where 	a.DT_ANALISE between dt_inicial_p  and dt_final_p
		group by NR_SEQ_PROJETO)
	
union all

	select sum(e.QT_MINUTO /60)
	from proj_projeto c, MAN_ORDEM_SERV_ATIV e
	where c.nr_seq_ordem_serv = e.nr_seq_ordem_serv
	and e.dt_atividade between dt_inicial_p  and dt_final_p
	and c.nr_sequencia in (select NR_SEQ_PROJETO
		from  	w_analise_proj_dia a
		where 	a.DT_ANALISE between dt_inicial_p  and dt_final_p
		group by NR_SEQ_PROJETO)) alias7;

	qt_resultado_w	:= qt_projetos_executados_w;

end if;


/* Recursos alocados no período (pessoas) */

if (ie_tipo_indicador_p	in (3,4)) then


	/*select	sum(qt_pessoas)
	into	qt_recursos_w
	from	(
	select count(distinct CD_PROGRAMADOR) qt_pessoas
	from 	proj_projeto c,
		proj_cron_etapa b,
		proj_cronograma a,
		MAN_ORDEM_SERV_ATIV e,
		PROJ_CRON_ETAPA_EQUIPE f,
		pessoa_fisica u
	where a.nr_sequencia = b.nr_seq_cronograma
	and a.dt_aprovacao is not null
	and b.nr_sequencia = e.NR_SEQ_PROJ_CRON_ETAPA
	and b.nr_sequencia = NR_SEQ_ETAPA_CRON
	and e.dt_atividade between dt_inicial_p  and dt_final_p
	and a.nr_seq_proj = c.nr_sequencia
	and f.cd_programador = u.cd_pessoa_fisica
	and u.cd_cargo in (80,69,66,73,251)
	and c.nr_sequencia in
		(select NR_SEQ_PROJETO
		from  	w_analise_proj_dia a
		where 	a.DT_ANALISE between dt_inicial_p  and dt_final_p
		group by NR_SEQ_PROJETO)); */
	select 	round(sum(qt_recurso_projeto))
	into STRICT	qt_recursos_w
	from 	w_indicador_desenv_apres
	where 	dt_referencia = dt_final_p;

	if (ie_tipo_indicador_p	= 3) then
		qt_resultado_w	:= qt_recursos_w;
	end if;


	if (ie_tipo_indicador_p	= 4) then

		select	count(*)
		into STRICT	qt_backlog_w
		from	proj_projeto
		where	ie_origem = 'D'
		and	IE_STATUS 	in ('P', 'I')
		and	NR_SEQ_CLASSIF = 11;

		qt_resultado_w	:= qt_backlog_w/qt_recursos_w;

	end if;


end if;

/* Percentual de projetos em atraso no mês (Finalizados) */

if (ie_tipo_indicador_p	= 5) then


	select 	count(distinct b.nr_seq_projeto)
	into STRICT	qt_total_proj_fim_mes_w
	from 	w_analise_proj_dia b, proj_projeto a
	where 	a.nr_sequencia = b.nr_seq_projeto
	and	(a.DT_TESTE_CLIENTE IS NOT NULL AND a.DT_TESTE_CLIENTE::text <> '')
	and not exists (
		SELECT  1
	   	from 	proj_projeto p,
			proj_cronograma o,
	    		proj_cron_etapa e
		where   p.nr_sequencia = o.nr_seq_proj
		and  	o.nr_sequencia = e.nr_seq_cronograma
		and 	e.nr_seq_sub_proj = a.nr_sequencia)
	and	b.DT_ANALISE between dt_inicial_p and dt_final_p
	and	a.DT_TESTE_CLIENTE between dt_inicial_p and dt_final_p;



	select 	count(distinct b.nr_seq_projeto)
	into STRICT	qt_atraso_proj_fim_mes_w
	from 	w_analise_proj_dia b, proj_projeto a
	where 	a.nr_sequencia = b.nr_seq_projeto
	and	trunc(a.DT_TESTE_CLIENTE,'dd') > trunc(a.dt_fim_prev, 'dd')
	and not exists (
		SELECT  1
	   	from 	proj_projeto p,
			proj_cronograma o,
	    		proj_cron_etapa e
		where   p.nr_sequencia = o.nr_seq_proj
		and  	o.nr_sequencia = e.nr_seq_cronograma
		and 	e.nr_seq_sub_proj = a.nr_sequencia)
	and	b.DT_ANALISE between dt_inicial_p and dt_final_p
	and	a.DT_TESTE_CLIENTE between dt_inicial_p and dt_final_p;


	pr_atraso_proj_fim_mes_w := (qt_atraso_proj_fim_mes_w * 100)/qt_total_proj_fim_mes_w;

	qt_resultado_w		 := pr_atraso_proj_fim_mes_w;

end if;

/* Percentual de projetos em atraso no mês (em andamento) - Operação */

if (ie_tipo_indicador_p	= 7) then

	select count( distinct nr_seq_projeto)
	into STRICT	qt_total_proj_fim_mes_w
	from (SELECT distinct b.nr_seq_projeto
		from 	w_analise_proj_dia b, proj_projeto a, gerencia_wheb c
		where 	a.nr_sequencia = b.nr_seq_projeto
		and	a.nr_seq_gerencia	= c.nr_sequencia
		and 	c.IE_AREA_GERENCIA	= 'DES'
		and 	a.nr_seq_classif <> 22
		and	(a.DT_TESTE_CLIENTE IS NOT NULL AND a.DT_TESTE_CLIENTE::text <> '')
		and not exists (
		SELECT  1
	   	from 	proj_projeto p,
			proj_cronograma o,
	    		proj_cron_etapa e
		where   p.nr_sequencia = o.nr_seq_proj
		and  	o.nr_sequencia = e.nr_seq_cronograma
		and 	e.nr_seq_sub_proj = a.nr_sequencia)
		and	b.DT_ANALISE between dt_inicial_p and dt_final_p
		and	a.DT_TESTE_CLIENTE between dt_inicial_p and dt_final_p
		
union

		select 	distinct b.nr_seq_projeto
		from 	w_analise_proj_dia b, proj_projeto a, gerencia_wheb c
		where 	a.nr_sequencia = b.nr_seq_projeto
		and	a.nr_seq_gerencia	= c.nr_sequencia
		and 	c.IE_AREA_GERENCIA	= 'DES'
		and 	a.nr_seq_classif <> 22
		and not exists (
		select  1
	   	from 	proj_projeto p,
			proj_cronograma o,
	    		proj_cron_etapa e
		where   p.nr_sequencia = o.nr_seq_proj
		and  	o.nr_sequencia = e.nr_seq_cronograma
		and	a.nr_seq_gerencia	= c.nr_sequencia
		and 	c.IE_AREA_GERENCIA	= 'DES'
		and 	a.nr_seq_classif <> 22
		and 	e.nr_seq_sub_proj = a.nr_sequencia)
		and	b.DT_ANALISE between dt_inicial_p and dt_final_p) alias5;

	select count( distinct nr_seq_projeto)
	into STRICT	qt_atraso_proj_fim_mes_w
	from (SELECT       distinct b.nr_seq_projeto
	   	from    w_analise_proj_dia b, proj_projeto a, gerencia_wheb c
  		where   a.nr_sequencia = b.nr_seq_projeto
		and	a.nr_seq_gerencia	= c.nr_sequencia
		and 	c.IE_AREA_GERENCIA	= 'DES'
   		and     trunc(a.DT_TESTE_CLIENTE,'dd') > trunc(a.dt_fim_prev, 'dd')
		and 	a.nr_seq_classif <> 22
   		and not exists (
           	SELECT  1
           	from    proj_projeto p,
                   	proj_cronograma o,
                   	proj_cron_etapa e
           	where   p.nr_sequencia = o.nr_seq_proj
           	and     o.nr_sequencia = e.nr_seq_cronograma
           	and     e.nr_seq_sub_proj = a.nr_sequencia)
   		and     b.DT_ANALISE between dt_inicial_p and dt_final_p
   		and     a.DT_TESTE_CLIENTE between dt_inicial_p and dt_final_p
		
union

		select  distinct b.nr_seq_projeto
   		from    w_analise_proj_dia b,
			proj_projeto a,
			gerencia_wheb c
   		where   a.nr_sequencia = b.nr_seq_projeto
		and	a.nr_seq_gerencia	= c.nr_sequencia
		and 	c.IE_AREA_GERENCIA	= 'DES'
		and 	a.nr_seq_classif <> 22
		and not exists (
	           	select  1
        	   	from    proj_projeto p,
                		proj_cronograma o,
                   		proj_cron_etapa e
	           	where   p.nr_sequencia = o.nr_seq_proj
        	   	and     o.nr_sequencia = e.nr_seq_cronograma
	           	and     e.nr_seq_sub_proj = a.nr_sequencia)
   		and     b.DT_ANALISE = dt_final_p
   		and     b.dt_fim_previsto < b.DT_ANALISE) alias5;

	pr_atraso_proj_fim_mes_w := (qt_atraso_proj_fim_mes_w * 100)/qt_total_proj_fim_mes_w;

	qt_resultado_w		 := pr_atraso_proj_fim_mes_w;

end if;


/* Percentual de projetos em atraso no mês (em andamento) - Tecnologia */

if (ie_tipo_indicador_p	= 9) then

	select count( distinct nr_seq_projeto)
	into STRICT	qt_total_proj_fim_mes_w
	from (SELECT distinct b.nr_seq_projeto
		from 	w_analise_proj_dia b, proj_projeto a, gerencia_wheb c
		where 	a.nr_sequencia = b.nr_seq_projeto
		and	a.nr_seq_gerencia	= c.nr_sequencia
		and 	c.IE_AREA_GERENCIA	= 'TEC'
		and 	a.nr_seq_classif <> 22
		and	(a.DT_TESTE_CLIENTE IS NOT NULL AND a.DT_TESTE_CLIENTE::text <> '')
		and not exists (
		SELECT  1
	   	from 	proj_projeto p,
			proj_cronograma o,
	    		proj_cron_etapa e
		where   p.nr_sequencia = o.nr_seq_proj
		and  	o.nr_sequencia = e.nr_seq_cronograma
		and 	e.nr_seq_sub_proj = a.nr_sequencia)
		and	b.DT_ANALISE between dt_inicial_p and dt_final_p
		and	a.DT_TESTE_CLIENTE between dt_inicial_p and dt_final_p
		
union

		select 	distinct b.nr_seq_projeto
		from 	w_analise_proj_dia b, proj_projeto a, gerencia_wheb c
		where 	a.nr_sequencia = b.nr_seq_projeto
		and	a.nr_seq_gerencia	= c.nr_sequencia
		and 	c.IE_AREA_GERENCIA	= 'TEC'
		and 	a.nr_seq_classif <> 22
		and not exists (
		select  1
	   	from 	proj_projeto p,
			proj_cronograma o,
	    		proj_cron_etapa e
		where   p.nr_sequencia = o.nr_seq_proj
		and  	o.nr_sequencia = e.nr_seq_cronograma
		and	a.nr_seq_gerencia	= c.nr_sequencia
		and 	c.IE_AREA_GERENCIA	= 'TEC'
		and 	a.nr_seq_classif <> 22
		and 	e.nr_seq_sub_proj = a.nr_sequencia)
		and	b.DT_ANALISE between dt_inicial_p and dt_final_p) alias5;


	select count( distinct nr_seq_projeto)
	into STRICT	qt_atraso_proj_fim_mes_w
	from (SELECT       distinct b.nr_seq_projeto
	   	from    w_analise_proj_dia b, proj_projeto a, gerencia_wheb c
  		where   a.nr_sequencia = b.nr_seq_projeto
		and	a.nr_seq_gerencia	= c.nr_sequencia
		and 	c.IE_AREA_GERENCIA	= 'TEC'
   		and     trunc(a.DT_TESTE_CLIENTE,'dd') > trunc(a.dt_fim_prev, 'dd')
		and 	a.nr_seq_classif <> 22
   		and not exists (
           	SELECT  1
           	from    proj_projeto p,
                   	proj_cronograma o,
                   	proj_cron_etapa e
           	where   p.nr_sequencia = o.nr_seq_proj
           	and     o.nr_sequencia = e.nr_seq_cronograma
           	and     e.nr_seq_sub_proj = a.nr_sequencia)
   		and     b.DT_ANALISE between dt_inicial_p and dt_final_p
   		and     a.DT_TESTE_CLIENTE between dt_inicial_p and dt_final_p
		
union

		select  distinct b.nr_seq_projeto
   		from    w_analise_proj_dia b,
			proj_projeto a,
			gerencia_wheb c
   		where   a.nr_sequencia = b.nr_seq_projeto
		and	a.nr_seq_gerencia	= c.nr_sequencia
		and 	c.IE_AREA_GERENCIA	= 'TEC'
		and 	a.nr_seq_classif <> 22
		and not exists (
	           	select  1
        	   	from    proj_projeto p,
                		proj_cronograma o,
                   		proj_cron_etapa e
	           	where   p.nr_sequencia = o.nr_seq_proj
        	   	and     o.nr_sequencia = e.nr_seq_cronograma
	           	and     e.nr_seq_sub_proj = a.nr_sequencia)
   		and     b.DT_ANALISE = dt_final_p
   		and     b.dt_fim_previsto < b.DT_ANALISE) alias5;

	pr_atraso_proj_fim_mes_w := (qt_atraso_proj_fim_mes_w * 100)/qt_total_proj_fim_mes_w;

	qt_resultado_w		 := pr_atraso_proj_fim_mes_w;

end if;

/* Percentual de projetos em atraso no mês (em andamento) - HTML 5*/

if (ie_tipo_indicador_p	= 10) then

	select count( distinct nr_seq_projeto)
	into STRICT	qt_total_proj_fim_mes_w
	from (SELECT distinct b.nr_seq_projeto
		from 	w_analise_proj_dia b, proj_projeto a, gerencia_wheb c
		where 	a.nr_sequencia = b.nr_seq_projeto
		and	a.nr_seq_gerencia	= c.nr_sequencia
		and 	c.IE_AREA_GERENCIA	= 'PDES'
		and 	a.nr_seq_classif <> 22
		and	(a.DT_TESTE_CLIENTE IS NOT NULL AND a.DT_TESTE_CLIENTE::text <> '')
		and not exists (
		SELECT  1
	   	from 	proj_projeto p,
			proj_cronograma o,
	    		proj_cron_etapa e
		where   p.nr_sequencia = o.nr_seq_proj
		and  	o.nr_sequencia = e.nr_seq_cronograma
		and 	e.nr_seq_sub_proj = a.nr_sequencia)
		and	b.DT_ANALISE between dt_inicial_p and dt_final_p
		and	a.DT_TESTE_CLIENTE between dt_inicial_p and dt_final_p
		
union

		select 	distinct b.nr_seq_projeto
		from 	w_analise_proj_dia b, proj_projeto a, gerencia_wheb c
		where 	a.nr_sequencia = b.nr_seq_projeto
		and	a.nr_seq_gerencia	= c.nr_sequencia
		and 	c.IE_AREA_GERENCIA	= 'PDES'
		and 	a.nr_seq_classif <> 22
		and not exists (
		select  1
	   	from 	proj_projeto p,
			proj_cronograma o,
	    		proj_cron_etapa e
		where   p.nr_sequencia = o.nr_seq_proj
		and  	o.nr_sequencia = e.nr_seq_cronograma
		and	a.nr_seq_gerencia	= c.nr_sequencia
		and 	c.IE_AREA_GERENCIA	= 'PDES'
		and 	a.nr_seq_classif <> 22
		and 	e.nr_seq_sub_proj = a.nr_sequencia)
		and	b.DT_ANALISE between dt_inicial_p and dt_final_p) alias5;


	select count( distinct nr_seq_projeto)
	into STRICT	qt_atraso_proj_fim_mes_w
	from (SELECT       distinct b.nr_seq_projeto
	   	from    w_analise_proj_dia b, proj_projeto a, gerencia_wheb c
  		where   a.nr_sequencia = b.nr_seq_projeto
		and	a.nr_seq_gerencia	= c.nr_sequencia
		and 	c.IE_AREA_GERENCIA	= 'PDES'
   		and     trunc(a.DT_TESTE_CLIENTE,'dd') > trunc(a.dt_fim_prev, 'dd')
		and 	a.nr_seq_classif <> 22
   		and not exists (
           	SELECT  1
           	from    proj_projeto p,
                   	proj_cronograma o,
                   	proj_cron_etapa e
           	where   p.nr_sequencia = o.nr_seq_proj
           	and     o.nr_sequencia = e.nr_seq_cronograma
           	and     e.nr_seq_sub_proj = a.nr_sequencia)
   		and     b.DT_ANALISE between dt_inicial_p and dt_final_p
   		and     a.DT_TESTE_CLIENTE between dt_inicial_p and dt_final_p
		
union

		select  distinct b.nr_seq_projeto
   		from    w_analise_proj_dia b,
			proj_projeto a,
			gerencia_wheb c
   		where   a.nr_sequencia = b.nr_seq_projeto
		and	a.nr_seq_gerencia	= c.nr_sequencia
		and 	c.IE_AREA_GERENCIA	= 'PDES'
		and 	a.nr_seq_classif <> 22
		and not exists (
	           	select  1
        	   	from    proj_projeto p,
                		proj_cronograma o,
                   		proj_cron_etapa e
	           	where   p.nr_sequencia = o.nr_seq_proj
        	   	and     o.nr_sequencia = e.nr_seq_cronograma
	           	and     e.nr_seq_sub_proj = a.nr_sequencia)
   		and     b.DT_ANALISE = dt_final_p
   		and     b.dt_fim_previsto < b.DT_ANALISE) alias5;

	pr_atraso_proj_fim_mes_w	:= 0;
	if (qt_atraso_proj_fim_mes_w <> 0) and (qt_total_proj_fim_mes_w <> 0) then
		pr_atraso_proj_fim_mes_w := (qt_atraso_proj_fim_mes_w * 100)/qt_total_proj_fim_mes_w;

	end if;
	qt_resultado_w		 := pr_atraso_proj_fim_mes_w;

end if;


/* Percentual de assertividade dos projetos (em horas) */

if (ie_tipo_indicador_p	= 6) then

	select 	avg(pr_assertividade)
	into STRICT	pr_assertividade_w
	from	(
	SELECT 	a.nr_sequencia, substr(ds_titulo,1,50) proj,
		b.QT_TOTAL_HORAS,
		b.QT_HORAS_REALIZADO,
		(b.QT_HORAS_REALIZADO *100)/b.QT_TOTAL_HORAS pr_assertividade
	from 	proj_projeto a, proj_cronograma b
	where 	a.ie_origem = 'D'
	and 	a.dt_teste_cliente between dt_inicial_p and dt_final_p
	and 	a.nr_sequencia = b.nr_seq_proj
	and 	a.NR_SEQ_CLASSIF <> 22
	and 	b.QT_HORAS_REALIZADO > 0
	and	b.QT_TOTAL_HORAS > 0
	and 	b.IE_TIPO_CRONOGRAMA  = 'E'
	and	b.ie_situacao = 'A') alias4;

	qt_resultado_w		 := pr_assertividade_w;
end if;


return	qt_resultado_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION pmo_obter_inidicador_mensal (dt_inicial_p timestamp, dt_final_p timestamp, ie_tipo_indicador_p bigint) FROM PUBLIC;

