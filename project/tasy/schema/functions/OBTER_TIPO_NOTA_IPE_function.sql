-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_tipo_nota_ipe ( ie_tipo_atendimento_p bigint, ie_tipo_item_p bigint, cd_item_p bigint, cd_cgc_hospital_p text, ie_origem_p bigint, nr_interno_conta_p bigint) RETURNS bigint AS $body$
DECLARE


/*
ie_tipo_item		1-Proc/Taxas/Serv	2-Mat/Med

ie_tipo_atendimento		1-Internado	3-Pronto Socorro 7-Externo(Exames) 8-Ambulatorial
*/
cd_grupo_proc_w			bigint;
cd_especialidade_w		bigint;
cd_area_procedimento_w		bigint;
tp_nota_w			smallint;
ie_origem_proced_w		bigint;


BEGIN

select 	coalesce(max(cd_grupo_proc),0),
	coalesce(max(cd_especialidade),0),
	coalesce(max(cd_area_procedimento),0),
	coalesce(max(ie_origem_proced),1)
into STRICT	cd_grupo_proc_w,
	cd_especialidade_w,
	cd_area_procedimento_w,
	ie_origem_proced_w
from	estrutura_procedimento_v
where	cd_procedimento	= cd_item_p
and	ie_origem_proced = ie_origem_p
and	ie_tipo_item_p	 = 1;

tp_nota_w := obter_tipo_nota_ipergs(ie_tipo_atendimento_p, ie_tipo_item_p, cd_area_procedimento_w, cd_especialidade_w, cd_grupo_proc_w,  cd_item_p, ie_origem_proced_w, nr_interno_conta_p);

if (coalesce(tp_nota_w,0) = 0) then

	if (ie_tipo_item_p	= 1) then
		begin
		tp_nota_w			:= 55;


		if (ie_origem_proced_w = 1) then
			begin

			if (ie_tipo_atendimento_p	= 1) then
				begin
				if (cd_area_procedimento_w		= 1) then
					tp_nota_w			:= 75;
				elsif (cd_area_procedimento_w		= 2) then
					tp_nota_w			:= 75;
				elsif (cd_area_procedimento_w		= 4) then
					tp_nota_w			:= 75;
				elsif (cd_area_procedimento_w		= 3) then
					tp_nota_w			:= 77;
				else
					tp_nota_w			:= 76;
				end if;
				end;
			end if;

			if (ie_tipo_atendimento_p	= 8) then
				begin
				if (cd_area_procedimento_w		= 1) then
					tp_nota_w			:= 85;
				elsif (cd_area_procedimento_w		= 2) then
					tp_nota_w			:= 85;
				elsif (cd_area_procedimento_w		= 4) then
					tp_nota_w			:= 85;
				elsif (cd_area_procedimento_w		= 3) then
					tp_nota_w			:= 87;
				else
					tp_nota_w			:= 86;
				end if;
				end;
			end if;

			if (ie_tipo_atendimento_p	= 3) then
				tp_nota_w			:= 55;
			end if;

			if (ie_tipo_atendimento_p	= 7) then
				tp_nota_w			:= 35;
			end if;

			/* Exceções solicitadas por Adriane HCE Ordem de Serviço 11051 */

			if (ie_tipo_atendimento_p	= 1) then
				begin
				/* 29000009-Tisiopneumologia 23000007-Endoscopia Digestiva 24000000-Endoscopia Peroral */

				if (cd_especialidade_w		in (29000009,23000007,24000000,32000006)) then
					tp_nota_w			:= 75;
				end if;
				/* 32130007-Radiologia Intervencionista 32320019-Angiografia 32300018-Neuroradiologia */

				if (cd_grupo_proc_w		in (32130007,32320019,32300018)) then
					tp_nota_w			:= 75;
				end if;
				/* Procedimentos que se iniciam com 32xxxxxx devem vir com tipo de Nota 77  OS 62961 André HDJB,
				com excessão dos que iniciam-se com 3230xxxx e 3232xxxx */
				if	(((cd_cgc_hospital_p = '95422358000119') and (length(cd_item_p) > 3)) or (cd_cgc_hospital_p <> '95422358000119')) and (substr(cd_item_p,1,2) = '32') and ((substr(cd_item_p,1,4))::numeric  not in (3230,3232)) and (length(cd_item_p) > 2) and
					((cd_cgc_hospital_p = '92815000000168' AND cd_item_p <> 329) or (cd_cgc_hospital_p <> '92815000000168')) then
					tp_nota_w			:= 77;
				end if;


				--OS 663852
				if	(((cd_cgc_hospital_p = '95422358000119') and (length(cd_item_p) > 3)) or (cd_cgc_hospital_p <> '95422358000119')) and (substr(cd_item_p,1,2) = '32') and ((substr(cd_item_p,1,4))::numeric  not in (3230,3232)) and (length(cd_item_p) > 2)  then
					tp_nota_w			:= 77;
				end if;


				/* OS 84734 Fabrício HCE */
	/*OS 107252 Fabrício HDP */

				if	((cd_cgc_hospital_p = '89428718000197') or (cd_cgc_hospital_p = '87317764001084')) then
					if (substr(cd_item_p,1,2) = '32') and ((substr(cd_item_p,1,4))::numeric  not in (3230,3232)) then
						tp_nota_w			:= 77;
					end if;
					if (cd_grupo_proc_w		in (32130007,32320019,32300018)) then
						tp_nota_w			:= 75;
					end if;
				end if;

				/* OS 147394 André (Digifull) Hosp. Pompéia Caxias do Sul*/

				if (cd_cgc_hospital_p = '88633227000115') then
					if (cd_item_p in (27040470, 28040554)) then
						tp_nota_w := 75;
					end if;

					--OS 511395
					if (cd_especialidade_w in (32000006)) then
						begin
						tp_nota_w := 77;
						end;
					end if;


					/*OS 181792 Cleber */

					if ((substr(cd_item_p,1,4))::numeric  = 3213) then
						tp_nota_w := 75;
					end if;
				end if;
				if (cd_cgc_hospital_p = '92741016000254') then /*os 275593 Ernesto Dornelles */
					if (cd_especialidade_w	in (29000009,23000007,24000000,32000006)) then
						tp_nota_w	:= 77;
					end if;
					if (cd_item_p in (23013036, 23012030, 23012021, 23013028, 23016027, 23015020, 23020091)) then
						tp_nota_w	:= 75;
					end if;
				end if;
				if (cd_cgc_hospital_p = '92815000000168') then /*Santa Casa de POA*/
					if (cd_especialidade_w in (30000009)) then
						tp_nota_w	:= 75;
					end if;
					if (cd_especialidade_w in (29000009)) then
						tp_nota_w	:= 77;
					end if;
					if (cd_grupo_proc_w = 32130007) then
						tp_nota_w	:= 75;
					end if;
					if (cd_item_p in (27040470, 100102)) then
						tp_nota_w	:= 75;
					end if;
				end if;
				if	((cd_cgc_hospital_p = '87096616004779') or (cd_cgc_hospital_p = '87701249000374')) then
					if (cd_item_p = 32130384)	then
						tp_nota_w	:= 75;
					end if;
				end if;

				if (cd_cgc_hospital_p = '87701249000374') then
					/*Unimed Missões/ RS*/

					if (cd_item_p in (91040052,91040053)) then
						tp_nota_w	:= 75;
					end if;
				end if;

				--OS 663852
				if (cd_cgc_hospital_p = '95422358000119') then

					if (cd_item_p = 35010177)	then
						tp_nota_w	:= 75;
					end if;

				end if;

				end;
			end if;

			if (ie_tipo_atendimento_p	= 8) then
				begin
				/* 29000009-Tisiopneumologia 23000007-Endoscopia Digestiva 24000000-Endoscopia Peroral */

				if (cd_especialidade_w		in (29000009,23000007,24000000,32000006)) then
					tp_nota_w			:= 85;
				end if;
				/* 32130007-Radiologia Intervencionista 32320019-Angiografia 32300018-Neuroradiologia */

				if (cd_grupo_proc_w		in (32130007,32320019,32300018)) then
					tp_nota_w			:= 85;
				end if;
				/* Procedimentos que se iniciam com 32xxxxxx devem vir com tipo de Nota 87  OS 58279 André HDJB,
				com excessão dos que iniciam-se com 3230xxxx e 3232xxxx */
				if (substr(cd_item_p,1,2) = '32') and ((substr(cd_item_p,1,4))::numeric  not in (3230,3232)) and (length(cd_item_p) > 2) then
					tp_nota_w			:= 87;
				end if;


				/* OS 84734 Fabrício HCE */
      /*OS 107252 Fabrício HDP */

				if	((cd_cgc_hospital_p = '89428718000197') or (cd_cgc_hospital_p = '87317764001084')) then
					if (substr(cd_item_p,1,2) = '32') and ((substr(cd_item_p,1,4))::numeric  not in (3230,3232)) then
						tp_nota_w		:= 87;
					end if;
					if (cd_grupo_proc_w		in (32130007,32320019,32300018)) then
						tp_nota_w		:= 85;
					end if;
				end if;

				/* OS 147394 André (Digifull) Hosp. Pompéia Caxias do Sul*/

				if	((cd_cgc_hospital_p = '88633227000115') and (cd_item_p in (27040470, 28040554, 20020015))) then
					 tp_nota_w := 85;
				end if;

				if (cd_cgc_hospital_p = '92741016000254') then /*os 275593 Ernesto Dornelles */
					if (cd_especialidade_w	in (29000009,23000007,24000000)) then
						tp_nota_w		:= 87;
					end if;
					if (cd_item_p in (23013036, 23012030, 23012021, 23013028, 23016027, 23015020, 23020091)) then
						tp_nota_w		:= 85;
					end if;
				end if;

				if (cd_cgc_hospital_p = '92815000000168') then /*Santa Casa de POA*/
					if (cd_especialidade_w = 30000009) then
						tp_nota_w	:= 85;
					end if;
					if (cd_especialidade_w = 29000009) then
						tp_nota_w	:= 87;
					end if;
					if (cd_grupo_proc_w = 32130007) then
						tp_nota_w	:= 85;
					end if;
					if (cd_item_p = 27040470) then
						tp_nota_w	:= 85;
					end if;
					if (cd_item_p = 100102) then
						tp_nota_w	:= 75;
					end if;
				end if;
				if	((cd_cgc_hospital_p = '87096616004779') or (cd_cgc_hospital_p = '87701249000374')) then
					if (cd_item_p = 32130384)	then
						tp_nota_w	:= 85;
					end if;
				end if;


				--OS 663852
				if (cd_cgc_hospital_p = '95422358000119') then

					if (cd_item_p = 35010177)	then
						tp_nota_w	:= 85;
					end if;

				end if;


				end;
			end if;

			/*OS167275 - Alan - Hops. Santa Terezinha*/

			if	(cd_cgc_hospital_p = '89421259000110' AND cd_item_p = 90050088) then
				tp_nota_w := 76;
			end if;

			/* OS 170245 Fabrício (Digifull) Hosp. Cachoeira do Sul*/

			/*OS 175887 Inclui a especialidade*/

			if (cd_cgc_hospital_p = '87768735000148') then
				begin

				if ((cd_item_p in (16000001, 16000002, 16000003, 16000004, 16000005, 16000006, 16000007, 20020015)) or (cd_especialidade_w = 30000009)) then
					begin

					if (ie_tipo_atendimento_p	= 1) then
						tp_nota_w := 75;
					elsif (ie_tipo_atendimento_p	= 8) then
						tp_nota_w := 85;
					end if;

					end;
				end if;

				--OS 511409
				if (cd_especialidade_w in (32000006)) then
					begin
					if (ie_tipo_atendimento_p = 1) then
						begin
						tp_nota_w := 77;
						if	((cd_grupo_proc_w = 32130007) or (cd_item_p 	= 27040470)) then --OS 593870
							begin
							tp_nota_w 	:= 75;
							end;
						end if;
						end;
					elsif (ie_tipo_atendimento_p = 8) then
						begin
						tp_nota_w := 87;
						if	((cd_grupo_proc_w = 32130007) or (cd_item_p 	= 27040470)) then --OS 593870
							begin
							tp_nota_w 	:= 85;
							end;
						end if;
						end;
					end if;
					end;
				end if;

				end;
			end if;

			/* OS 186515 Fabrício (Digifull)  Hosp. Pompéia Caxias do Sul*/

			if (cd_cgc_hospital_p = '88633227000115') then
				if (cd_especialidade_w = 30000009) then
					if (ie_tipo_atendimento_p	= 1) then
						tp_nota_w		:= 75;
					elsif (ie_tipo_atendimento_p	= 8) then
						tp_nota_w 		:= 85;
					end if;
				end if;
				if (cd_item_p 		= 32130040) and (ie_tipo_atendimento_p	= 8) then
					tp_nota_w 		:= 85;
				end if;
			end if;

			if (cd_cgc_hospital_p = '87096616004779') then
				if (cd_grupo_proc_w = 32130007) then
					if (ie_tipo_atendimento_p	= 1) then
						tp_nota_w		:= 75;
					elsif (ie_tipo_atendimento_p	= 8) then
						tp_nota_w 		:= 85;
					end if;
				end if;
			end if;

			end;
		elsif (ie_origem_proced_w = 5) then
			begin
			if (ie_tipo_atendimento_p	= 1) then
				begin
				if (cd_item_p in (20104189,30307147,31002390,41203038,41203054,41203062,41203135,41203143)) then
					begin
					tp_nota_w			:= 75;
					end;
				end if;
				/*if	(cd_area_procedimento_w		= 12) then
					tp_nota_w			:= 75;
				elsif	(cd_area_procedimento_w		= 13) then
					tp_nota_w			:= 75;
				elsif	(cd_area_procedimento_w		= 14) then
					tp_nota_w			:= 75;
				end if;*/
				end;
			end if;

			if (ie_tipo_atendimento_p	= 8) then
				begin
				if (cd_item_p in (20104189,30307147,31002390,41203038,41203054,41203062,41203135,41203143)) then
					begin
					tp_nota_w			:= 85;
					end;
				end if;
				/*if	(cd_area_procedimento_w		= 12) then
					tp_nota_w			:= 85;
				elsif	(cd_area_procedimento_w		= 13) then
					tp_nota_w			:= 85;
				elsif	(cd_area_procedimento_w		= 14) then
					tp_nota_w			:= 85;
				end if;*/
				end;
			end if;
			if (cd_cgc_hospital_p = '92962869002006') then
				if (cd_item_p = 50140043) then
					if (ie_tipo_atendimento_p	= 1) then
						tp_nota_w		:= 75;
					elsif (ie_tipo_atendimento_p	= 8) then
						tp_nota_w 		:= 85;
					end if;
				end if;
			end if;

			if (cd_cgc_hospital_p = '92815000000168') then
				if (cd_item_p = 31401104) then
					if (ie_tipo_atendimento_p	= 1) then
						tp_nota_w		:= 75;
					elsif (ie_tipo_atendimento_p	= 8) then
						tp_nota_w 		:= 85;
					end if;
				elsif (cd_item_p in (40403262, 40403270, 40403289, 40403297, 40708128, 40103528, 40103536, 40103544)) then /*OS 720125*/
					if (ie_tipo_atendimento_p in (1)) then
						tp_nota_w 		:= 77;
					elsif (ie_tipo_atendimento_p in (3)) then
						tp_nota_w 		:= 55;
					elsif (ie_tipo_atendimento_p in (7)) then
						tp_nota_w 		:= 35;
					elsif (ie_tipo_atendimento_p in (8)) then
						tp_nota_w 		:= 87;
					end if;
				elsif (cd_item_p in (31002390,100102)) then --OS 769471
					if (ie_tipo_atendimento_p	= 1) then
						tp_nota_w		:= 75;
					elsif (ie_tipo_atendimento_p	= 8) then
						tp_nota_w 		:= 85;
					end if;
				end if;
			end if;
			end;
		end if;

		--OS  663852
		if (cd_cgc_hospital_p = '95422358000119') then
			begin

			if ((cd_item_p in (16000001, 16000002, 16000003, 16000004, 16000005, 16000006, 16000007, 23010002, 23013036, 23012030, 23011033, 23011025, 23012021, 23013028, 23014024, 23015020, 23016027)) or (cd_especialidade_w = 30000009)) then
				begin

				if (ie_tipo_atendimento_p	= 1) then
					tp_nota_w := 75;
				elsif (ie_tipo_atendimento_p	= 8) then
					tp_nota_w := 85;
				end if;

				end;
			end if;

			if ((substr(cd_item_p,1,4))::numeric  	= 3213) then
				begin

				if (ie_tipo_atendimento_p	= 1) then
					tp_nota_w 		:= 75;
				end if;

				end;
			end if;

			--OS 778141 em 21/08/2014
			if (cd_item_p in (23021020,23022027,23023023)) then
				if (ie_tipo_atendimento_p	= 1) then
					tp_nota_w := 75;
				elsif (ie_tipo_atendimento_p	= 8) then
					tp_nota_w := 85;
				end if;
			end if;

			end;
		end if;

		--Hospital Vida e Saúde
		if (cd_cgc_hospital_p = 95815668000101) then
			--OS 838145 em 22/01/2015 - Hospital Vida e Saúde
			if (cd_especialidade_w = 30000009) then
				begin
				if (ie_tipo_atendimento_p	= 1) then
					tp_nota_w := 75;
				elsif (ie_tipo_atendimento_p	= 8) then
					tp_nota_w := 85;
				end if;

				end;
			end if;
			--OS 839890 em 13/02/2015 - Hospital Vida e Saúde
			if (cd_item_p in (56040687,56040652)) then
				if (ie_tipo_atendimento_p	= 1) then
					tp_nota_w := 75;
				elsif (ie_tipo_atendimento_p	= 8) then
					tp_nota_w := 85;
				end if;
			end if;
		end if;


		/*OS676179 - Tiago - Unimed Missões/ RS - Cooperativa Médica Ltda.*/

		if	(cd_cgc_hospital_p = '87701249000374' AND cd_item_p = 91040068) then
			tp_nota_w := 77;
		end if;

		/*OS 838679 - Diego - Irmandade Santa Casa de Misericórdia de POA*/

		if (cd_cgc_hospital_p = '92815000000168') and (cd_item_p in (40202240,30738024,30738040,30738059)) then
			if (ie_tipo_atendimento_p	= 1) then
				tp_nota_w := 75;
			elsif (ie_tipo_atendimento_p	= 8) then
				tp_nota_w := 85;
			end if;
		end if;


		end;
	end if;

	if (ie_tipo_item_p	= 2) then
		begin
		if (ie_tipo_atendimento_p	= 1) then
			tp_nota_w			:= 76;
		elsif (ie_tipo_atendimento_p	= 8) then
			tp_nota_w			:= 86;
		elsif (ie_tipo_atendimento_p	= 3) then
			tp_nota_w			:= 55;
		elsif (ie_tipo_atendimento_p	= 7) then
			tp_nota_w			:= 35;
		else
			tp_nota_w			:= 55;
		end if;
		end;
	end if;

end if;

return tp_nota_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_tipo_nota_ipe ( ie_tipo_atendimento_p bigint, ie_tipo_item_p bigint, cd_item_p bigint, cd_cgc_hospital_p text, ie_origem_p bigint, nr_interno_conta_p bigint) FROM PUBLIC;

