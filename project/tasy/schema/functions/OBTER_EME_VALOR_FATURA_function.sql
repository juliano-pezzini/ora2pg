-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_eme_valor_fatura (nr_seq_contrato_p bigint, dt_competencia_p timestamp, nr_seq_faturamento_p eme_faturamento.nr_sequencia%type, ie_opcao_p text default 'X') RETURNS bigint AS $body$
DECLARE


vl_retorno_w			double precision;
ie_base_calculo_w		varchar(1);
qt_quantidade_w			integer;
qt_maxima_w			integer;
qt_adicional_w			integer;
vl_adicional_w			double precision;
vl_fixo_w			double precision;
ie_dt_competencia_w		varchar(1);
dt_competencia_w		timestamp;
vl_km_total_w           	double precision;
ie_opcao_w			varchar(1);

/*
F- Notal fiscal
*/
BEGIN


vl_adicional_w	:= 0;
qt_adicional_w	:= 0;
ie_dt_competencia_w := obter_param_usuario(929, 25, obter_perfil_ativo, Wheb_usuario_pck.get_nm_usuario, wheb_usuario_pck.get_cd_estabelecimento, ie_dt_competencia_w);

select	b.ie_base_calculo
into STRICT	ie_base_calculo_w
from	eme_contrato a,
	eme_regra_preco b
where	a.nr_seq_regra_preco = b.nr_sequencia
and	a.nr_sequencia = nr_seq_contrato_p;

if (ie_dt_competencia_w = 'S') then
	dt_competencia_w := dt_competencia_p;
else
	dt_competencia_w := clock_timestamp();
end if;

select	coalesce(Obter_eme_quantidade_calculo(ie_base_calculo_w, nr_seq_contrato_p, dt_competencia_w, nr_seq_faturamento_p, ie_opcao_p), 0)
into STRICT	qt_quantidade_w
;

/* Busco a maior quantidade existente para a faixa */

select	coalesce(max(qt_maxima),0),
	coalesce(max(vl_fixo),0)
into STRICT	qt_maxima_w,
	vl_fixo_w
from	eme_contrato_preco
where	nr_seq_contrato = nr_seq_contrato_p
and	((coalesce(dt_fim_vigencia::text, '') = ''
		and	dt_vigencia  = (
			SELECT	max(dt_vigencia)
			from	eme_contrato_preco
			where	nr_seq_contrato	=  nr_seq_contrato_p
			and	dt_vigencia <= dt_competencia_w))
	or ((dt_fim_vigencia IS NOT NULL AND dt_fim_vigencia::text <> '')
		and	trunc(dt_competencia_w) between dt_vigencia and dt_fim_vigencia));

/* se a quantidade ultrapassar a regra, soma-se o valor do maior faixa mais (adicional * vl_fixo) */

if (qt_quantidade_w > qt_maxima_w) then
	qt_adicional_w	:= qt_quantidade_w - qt_maxima_w;
	vl_adicional_w	:= vl_fixo_w * qt_adicional_w;
	qt_quantidade_w	:= qt_maxima_w;
end if;

select	coalesce(max(vl_preco),0) + vl_adicional_w
into STRICT	vl_retorno_w
from	eme_contrato_preco
where	nr_seq_contrato	=  nr_seq_contrato_p
and	qt_minima <=	qt_quantidade_w
and	qt_maxima >= 	qt_quantidade_w
and	nr_sequencia = (
			SELECT	max(nr_sequencia)
			from	eme_contrato_preco
			where	nr_seq_contrato	=  nr_seq_contrato_p
			and	qt_minima <= qt_quantidade_w
		   	and	qt_maxima >= qt_quantidade_w
			and	((coalesce(dt_fim_vigencia::text, '') = ''
				and	dt_vigencia <= clock_timestamp())
			or ((dt_fim_vigencia IS NOT NULL AND dt_fim_vigencia::text <> '')
				and	trunc(dt_competencia_w) between dt_vigencia and dt_fim_vigencia)));

if (ie_base_calculo_w = 'I') then
	select	coalesce(sum(VL_PRECO),0) + vl_retorno_w
	into STRICT	vl_retorno_w
	from	EME_PF_CONTRATO
	where	nr_seq_contrato = nr_seq_contrato_p
	and	coalesce(dt_cancelamento::text, '') = '';
end if;


if (ie_opcao_p <> 'F') then --Se for nota fiscal não soma o valor por km, pois  é descriminao na nota
	SELECT	coalesce(max(c.vl_km_total),0)
	into STRICT	vl_km_total_w
	FROM 	eme_contrato a,
		eme_chamado c,
		eme_regra_preco d,
		eme_veiculo e,
		eme_custo_km_veiculo f
	WHERE	c.nr_seq_contrato    = a.nr_sequencia
	AND	a.nr_seq_regra_preco = d.nr_sequencia
	AND	c.nr_seq_veiculo     = e.nr_sequencia
	AND	e.nr_sequencia	     = f.nr_seq_veiculo
	AND	c.nr_seq_contrato    = nr_seq_contrato_p
	AND	d.ie_cobranca_km     = 'S'
	AND	c.qt_km_cobrar > 0;

	vl_retorno_w := vl_retorno_w + vl_km_total_w;

end if;

RETURN	vl_retorno_w;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_eme_valor_fatura (nr_seq_contrato_p bigint, dt_competencia_p timestamp, nr_seq_faturamento_p eme_faturamento.nr_sequencia%type, ie_opcao_p text default 'X') FROM PUBLIC;

