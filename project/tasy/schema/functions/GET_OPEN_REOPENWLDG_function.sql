-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION get_open_reopenwldg ( nr_seq_episodio_p bigint) RETURNS varchar AS $body$
DECLARE

				
dt_alta_w		      ATENDIMENTO_PACIENTE.DT_ALTA%type;
qt_dias_case_w		REGRA_TIPO_EP_ITEM.QT_DIAS_CASE%type;
ie_comportamento_w	regra_tipo_ep_item.ie_comportamento%type;
nr_atendimento_w  ATENDIMENTO_PACIENTE.NR_ATENDIMENTO%type;
ie_retorno_w      varchar(1);


BEGIN

select  max(nr_atendimento)
into STRICT    nr_atendimento_w
from    atendimento_paciente
where   nr_seq_episodio = nr_seq_episodio_p
and   coalesce(dt_cancelamento::text, '') = '';

select  max(DT_ALTA)
into STRICT    dt_alta_w
from    ATENDIMENTO_PACIENTE
where   nr_atendimento = nr_atendimento_w;

select    max(d.QT_DIAS_CASE),
		  max(d.ie_comportamento)
into STRICT      qt_dias_case_w,
		  ie_comportamento_w
from      EPISODIO_PACIENTE a,
          ATENDIMENTO_PACIENTE b,
          REGRA_TIPO_EPISODIO c,
          REGRA_TIPO_EP_ITEM d
where     a.nr_sequencia  = nr_seq_episodio_p
and       b.nr_atendimento = nr_atendimento_w
and       b.nr_seq_episodio = a.nr_sequencia
and       coalesce(c.NR_SEQ_TIPO_EPISODIO,  coalesce(a.NR_SEQ_TIPO_EPISODIO, 9999)) = coalesce(a.NR_SEQ_TIPO_EPISODIO, 9999)
and       coalesce(c.IE_TIPO_ATENDIMENTO,  coalesce(b.IE_TIPO_ATENDIMENTO, 9999)) =  coalesce(b.IE_TIPO_ATENDIMENTO, 9999)
and       coalesce(c.IE_TIPO_CONVENIO,  coalesce(b.IE_TIPO_CONVENIO, 9999))  =  coalesce(b.IE_TIPO_CONVENIO, 9999)
and       coalesce(c.NR_SEQ_CLASSIFICACAO,  coalesce(b.NR_SEQ_CLASSIFICACAO, 9999)) =  coalesce(b.NR_SEQ_CLASSIFICACAO, 9999)
and       coalesce(c.NR_SEQ_QUEIXA,  coalesce(b.NR_SEQ_QUEIXA, 9999)) =  coalesce(b.NR_SEQ_QUEIXA, 9999)
and       coalesce(c.NR_SEQ_TIPO_ADMISSAO_FAT,  coalesce(b.NR_SEQ_TIPO_ADMISSAO_FAT, 9999)) =  coalesce(b.NR_SEQ_TIPO_ADMISSAO_FAT, 9999)
and       d.NR_SEQ_REGRA_TIPO_EPI = c.nr_sequencia;

ie_retorno_w := 'S';

if	((dt_alta_w IS NOT NULL AND dt_alta_w::text <> '')
      and (qt_dias_case_w IS NOT NULL AND qt_dias_case_w::text <> '')
      and ((clock_timestamp() - dt_alta_w) >= qt_dias_case_w )) then
	begin
    	if (ie_comportamento_w = 'B') then
			ie_retorno_w := 'N';
		else
			ie_retorno_w := 'A';
		end if;
	end;
end if;

return	ie_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION get_open_reopenwldg ( nr_seq_episodio_p bigint) FROM PUBLIC;

