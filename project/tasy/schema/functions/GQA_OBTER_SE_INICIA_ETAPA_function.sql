-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION gqa_obter_se_inicia_etapa (nr_sequencia_p bigint) RETURNS varchar AS $body$
DECLARE


  dt_liberacao_w        gqa_protocolo_pac.dt_liberacao%TYPE;
  dt_inativacao_w       gqa_protocolo_pac.dt_inativacao%TYPE;
  dt_termino_w          gqa_protocolo_pac.dt_termino%TYPE;
  nr_atendimento_w      gqa_protocolo_pac.nr_atendimento%TYPE;
  dt_cancelar_usuario_w gqa_protocolo_etapa_pac.dt_cancelar_usuario%TYPE;
  nr_seq_prot_pac_w     gqa_protocolo_etapa_pac.nr_seq_prot_pac%TYPE;
  nr_seq_etapa_w        gqa_protocolo_etapa_pac.nr_seq_etapa%TYPE;
  return_w              varchar(1) := 'N';


BEGIN
  BEGIN
    SELECT p.dt_liberacao
          ,p.dt_inativacao
          ,p.dt_termino
          ,p.nr_atendimento
          ,e.dt_cancelar_usuario
          ,e.nr_seq_prot_pac
          ,e.nr_seq_etapa
      INTO STRICT dt_liberacao_w
          ,dt_inativacao_w
          ,dt_termino_w
          ,nr_atendimento_w
          ,dt_cancelar_usuario_w
          ,nr_seq_prot_pac_w
          ,nr_seq_etapa_w
      FROM gqa_protocolo_pac       p
          ,gqa_protocolo_etapa_pac e
     WHERE p.nr_sequencia = e.nr_seq_prot_pac
       AND e.nr_sequencia = nr_sequencia_p;
  EXCEPTION
    WHEN no_data_found THEN
      NULL;
  END;

  IF (dt_liberacao_w IS NOT NULL AND dt_liberacao_w::text <> '') AND coalesce(dt_inativacao_w::text, '') = '' AND
     coalesce(dt_termino_w::text, '') = '' AND coalesce(dt_cancelar_usuario_w::text, '') = '' THEN

    IF gqa_vinculo_etapa(nr_sequencia_p) = 'S' THEN
      IF gqa_permissao_executor_etapa(nr_seq_etapa_w, nr_seq_prot_pac_w, nr_atendimento_w) = 'S' THEN
        return_w := 'S';
      END IF;
    END IF;
  END IF;

  RETURN return_w;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION gqa_obter_se_inicia_etapa (nr_sequencia_p bigint) FROM PUBLIC;

