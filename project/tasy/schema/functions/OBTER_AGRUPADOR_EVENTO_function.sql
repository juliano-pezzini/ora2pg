-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_agrupador_evento ( nr_seq_evento_p bigint, ds_parametros_p text) RETURNS varchar AS $body$
DECLARE



ds_separador_w			varchar(10) := ';';
ds_parametros_w			varchar(2000);
ds_agrupador_w			varchar(2000) := '';
pos_partida_w			bigint;
pos_atributo_w			bigint;
ds_valor_w			varchar(2000);
nr_seq_agrupamento_w		bigint;



--Busca todos os atribtos de agrupamento
c01 CURSOR(nr_seq_agrupamento_p bigint) FOR
SELECT	a.nm_atributo
from	agrup_integracao_atrib a
where	a.nr_seq_agrupamento	= nr_seq_agrupamento_p;

BEGIN

select	max(a.nr_sequencia)
into STRICT	nr_seq_agrupamento_w
from	agrupamento_integracao a
where	exists (	SELECT	1
		from	evento_agrupamento b
		where	b.nr_seq_agrupamento	= a.nr_sequencia
		and	b.nr_seq_evento		= nr_seq_evento_p);



--Somente se possuir agrupador para este evento
if (coalesce(nr_seq_agrupamento_w, 0) <> 0) then

	ds_parametros_w				:= replace(replace(ds_parametros_p, '#@#@', ';'), 'pck_', '');
	for linha in c01(nr_seq_agrupamento_w) loop
		begin
		pos_atributo_w			:= position(linha.nm_atributo in upper(ds_parametros_w));
		if (pos_atributo_w <> 0) then
				begin
				pos_partida_w 	:= instr(upper(ds_parametros_w), ';', pos_atributo_w);
				ds_valor_w	:= substr(ds_parametros_w, pos_atributo_w, pos_partida_w - pos_atributo_w);

				if (ds_valor_w IS NOT NULL AND ds_valor_w::text <> '') then
					begin
					pos_partida_w 	:= position('=' in ds_valor_w);
					ds_valor_w	:= substr(ds_valor_w, pos_partida_w +1, instr(ds_parametros_w, ';', pos_partida_w));
					ds_agrupador_w	:= ds_agrupador_w || linha.nm_atributo || '=' || ds_valor_w || ';';
					end;
				end if;
				end;
		end if;
		end;
	end loop;
	ds_agrupador_w	:= 'NR_SEQ_AGRUPADOR=' || nr_seq_agrupamento_w || ';' || ds_agrupador_w;
end if;

return	ds_agrupador_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_agrupador_evento ( nr_seq_evento_p bigint, ds_parametros_p text) FROM PUBLIC;

