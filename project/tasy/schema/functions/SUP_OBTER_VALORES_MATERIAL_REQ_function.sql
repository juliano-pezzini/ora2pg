-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION sup_obter_valores_material_req ( nr_requisicao_p bigint, nr_item_requisicao_p bigint, ie_opcao_p text) RETURNS bigint AS $body$
DECLARE

/*
Ie opção

C = Valor Custo Médio
U = Valor da Última Compra
*/
cd_material_w			integer;
cd_estabelecimento_w		smallint;
dt_solicitacao_requisicao_w		timestamp;

vl_material_w			double precision;

cd_unidade_medida_w		varchar(30);
cd_unidade_medida_estoque_w	varchar(30);
cd_unidade_medida_compra_w	varchar(30);
cd_unidade_medida_consumo_w	varchar(30);

ie_unidade_medida_w		varchar(3);


BEGIN
select	b.cd_material,
	b.cd_unidade_medida,
	a.cd_estabelecimento,
	a.dt_solicitacao_requisicao
into STRICT	cd_material_w,
	cd_unidade_medida_w,
	cd_estabelecimento_w,
	dt_solicitacao_requisicao_w
from	requisicao_material a,
	item_Requisicao_material b
where	a.nr_requisicao = b.nr_requisicao
and	a.nr_requisicao = nr_requisicao_p
and	b.nr_sequencia  = nr_item_requisicao_p;

select	cd_unidade_medida_estoque,
	cd_unidade_medida_consumo,
	cd_unidade_medida_compra
into STRICT	cd_unidade_medida_estoque_w,
	cd_unidade_medida_consumo_w,
	cd_unidade_medida_compra_w
from	material
where	cd_material = cd_material_w;

if (cd_unidade_medida_w = cd_unidade_medida_estoque_w) then
	ie_unidade_medida_w := 'UME';
elsif (cd_unidade_medida_w = cd_unidade_medida_consumo_w) then
	ie_unidade_medida_w := 'UMC';
elsif (cd_unidade_medida_w = cd_unidade_medida_compra_w) then
	ie_unidade_medida_w := 'UMP';
else
	ie_unidade_medida_w := 'UME';
end if;

if (ie_opcao_p = 'U') then
	vl_material_w := coalesce(obter_dados_ultima_compra(cd_estabelecimento_w, cd_material_w, 'VE'),0);
elsif (ie_opcao_p = 'C') then
	vl_material_w := obter_custo_medio_material(cd_estabelecimento_w,trunc(dt_solicitacao_requisicao_w),cd_material_w);
end if;

vl_material_w := sup_obter_valor_convertido(cd_material_w, vl_material_w, cd_unidade_medida_estoque_w, ie_unidade_medida_w);

return	vl_material_w;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION sup_obter_valores_material_req ( nr_requisicao_p bigint, nr_item_requisicao_p bigint, ie_opcao_p text) FROM PUBLIC;

