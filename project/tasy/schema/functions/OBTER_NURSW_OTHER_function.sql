-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_nursw_other ( cd_pessoa_fisica_p text, dt_atualizacao_p timestamp, start_time_p timestamp, end_time_p timestamp ) RETURNS varchar AS $body$
DECLARE

    ds_others_w varchar(3900);

BEGIN
    select rtrim(XMLAGG(XMLELEMENT(name E, o_value||chr(10))).EXTRACT[ '//text()'].getclobval(), ',') o_value
     into STRICT   ds_others_w
   from ((SELECT ('['||obter_expressao_idioma(1042371)||']'||chr(10)||
 to_Char(ac.DT_AGENDA,'hh24:mi')||' '||ag.DS_AGENDA) o_value FROM agenda ag,agenda_consulta ac
WHERE ag.cd_agenda=ac.cd_agenda
and ac.CD_PESSOA_FISICA=cd_pessoa_fisica_p
and (ac.DT_CONFIRMACAO IS NOT NULL AND ac.DT_CONFIRMACAO::text <> '')
and to_date(ac.DT_CONSULTA,'dd-mm-yy')=to_date(dt_atualizacao_p,'dd-mm-yy')
and to_Char(ac.DT_AGENDA,'hh24:mi:ss') >=  to_Char(start_time_p,'hh24:mi:ss')
and to_Char(ac.DT_AGENDA,'hh24:mi:ss') <= to_Char(end_time_p,'hh24:mi:ss')
)
union all
(SELECT ( '['||obter_expressao_idioma(1042371)||']'||chr(10)||
to_Char(ac.DT_AGENDA,'hh24:mi')||' '||ag.DS_AGENDA) o_value FROM agenda ag,agenda_paciente ac
WHERE
    ag.cd_agenda = ac.cd_agenda
    AND ac.cd_pessoa_fisica = cd_pessoa_fisica_p
    AND (ac.dt_confirmacao IS NOT NULL AND ac.dt_confirmacao::text <> '')
    AND to_date(ac.dt_atendido, 'dd-mm-yy') = to_date(dt_atualizacao_p, 'dd-mm-yy')
    AND to_char(ac.dt_agenda, 'hh24:mi:ss') >= to_char(start_time_p, 'hh24:mi:ss')
    AND to_char(ac.dt_agenda, 'hh24:mi:ss') <= to_char(end_time_p, 'hh24:mi:ss')
)

union all

(select  substr(( '['||obter_expressao_idioma(756974)||']'||chr(10)||ds_horario||' ' ||
(select DS_TIPO_RECOMENDACAO from TIPO_RECOMENDACAO x where x.CD_TIPO_RECOMENDACAO=cpr.CD_RECOMENDACAO)
||chr(10)),1,100) o_value
from CLASSIFICACAO_RECOMENDACAO cr,TIPO_RECOMENDACAO tr,CPOE_RECOMENDACAO cpr,
prescr_recomendacao pr,prescr_rec_hor ph
WHERE
    (cr.ie_forma_servico IS NOT NULL AND cr.ie_forma_servico::text <> '')
    AND tr.cd_tipo_recomendacao = cpr.cd_recomendacao
    AND tr.nr_seq_classif = cr.nr_sequencia
    AND (cpr.dt_liberacao IS NOT NULL AND cpr.dt_liberacao::text <> '')
    AND coalesce(cpr.dt_suspensao::text, '') = ''
    AND ph.nr_prescricao = pr.nr_prescricao
    AND cpr.nr_sequencia = pr.nr_seq_rec_cpoe
    AND ph.ds_horario >= to_char(start_time_p, 'hh24:mi:ss')
    AND ph.ds_horario <= to_char(end_time_p, 'hh24:mi:ss')
    AND cpr.cd_pessoa_fisica = cd_pessoa_fisica_p
    AND to_date(cpr.DT_ATUALIZACAO, 'dd-mm-yy') = to_date(dt_atualizacao_p, 'dd-mm-yy')
)

union all
(select '['||obter_expressao_idioma(297224)||']'||chr(10)|| x.DS_TIPO||chr(10) o_value
from RXT_TIPO x,RXT_TUMOR rx, RXT_TRATAMENTO rt, RXT_AGENDA ra where    x.nr_sequencia=rx.nr_seq_tipo and rx.CD_PESSOA_FISICA=cd_pessoa_fisica_p
and rt.nr_seq_tumor = rx.nr_sequencia and rt.nr_sequencia = ra.nr_seq_tratamento
and to_date(rx.DT_ATUALIZACAO_NREC,'dd-mm-yy')=to_date(dt_atualizacao_p,'dd-mm-yy')
and to_Char(ra.dt_agenda,'hh24:mi:ss') >=  to_Char(start_time_p,'hh24:mi:ss')
    and to_Char(ra.dt_agenda,'hh24:mi:ss') <= to_Char(end_time_p,'hh24:mi:ss'))
    
union all
(select distinct '[RI]'||chr(10)||ds_horario||' '||DS_PROC_EXAME||chr(10) o_value
FROM
    proc_interno          pi,
    cpoe_procedimento     cp,
    prescr_procedimento   pp,
    prescr_proc_hor       ph
WHERE
    pi.nr_sequencia = cp.nr_seq_proc_interno
    AND to_date(cp.dt_atualizacao, 'dd-mm-yy') = to_date(dt_atualizacao_p, 'dd-mm-yy')
    AND cp.cd_pessoa_fisica = cd_pessoa_fisica_p
    AND pi.ie_tipo = 'O'
    AND (cp.dt_liberacao IS NOT NULL AND cp.dt_liberacao::text <> '')
    AND coalesce(pp.nr_seq_exame::text, '') = ''
    AND pp.cd_procedimento = ph.cd_procedimento
    AND pp.nr_prescricao = ph.nr_prescricao
    AND cp.nr_sequencia = pp.nr_seq_proc_cpoe
    AND coalesce(cp.dt_suspensao::text, '') = ''
    AND ph.ds_horario >= to_char(start_time_p, 'hh24:mi:ss')
    AND ph.ds_horario <= to_char(end_time_p, 'hh24:mi:ss'))
) alias63
;
 RETURN ds_others_w;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_nursw_other ( cd_pessoa_fisica_p text, dt_atualizacao_p timestamp, start_time_p timestamp, end_time_p timestamp ) FROM PUBLIC;

