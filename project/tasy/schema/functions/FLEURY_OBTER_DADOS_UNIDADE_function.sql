-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION fleury_obter_dados_unidade ( cd_unidade_p bigint, ie_opcao_p text) RETURNS varchar AS $body$
DECLARE


cd_estabelecimento_w		estabelecimento.cd_estabelecimento%type;
cd_estabelecimento_ww		estabelecimento.cd_estabelecimento%type;
ie_agrupa_ficha_fleury_w	lab_parametro.ie_agrupa_ficha_fleury%type;
ie_gera_analito_fleury_w	lab_parametro.ie_gera_analito_fleury%type;
/*
AF - Agrupa ficha
E - Estabelecimento
GA - Gera analito
*/
BEGIN

select	coalesce(max(a.cd_estabelecimento),0)
into STRICT	cd_estabelecimento_w
from	lab_param_maquina a
where	coalesce(cd_unidade_fleury,coalesce(cd_unidade_p,'0')) = coalesce(cd_unidade_p,'0');

if (cd_estabelecimento_w = 0) then
	select	coalesce(max(cd_estabelecimento),0),
		coalesce(max(ie_agrupa_ficha_fleury),'N'),
		coalesce(max(ie_gera_analito_fleury),'S')
	into STRICT	cd_estabelecimento_w,
		ie_agrupa_ficha_fleury_w,
		ie_gera_analito_fleury_w
	from	lab_parametro
	where	coalesce(cd_unidade_fleury,coalesce(cd_unidade_p,'0')) = coalesce(cd_unidade_p,'0');
else
	select	coalesce(max(ie_agrupa_ficha_fleury),'N'),
		coalesce(max(ie_gera_analito_fleury),'S')
	into STRICT	ie_agrupa_ficha_fleury_w,
		ie_gera_analito_fleury_w
	from	lab_parametro a
	where	a.cd_estabelecimento = cd_estabelecimento_w;
end if;

if (cd_estabelecimento_w IS NOT NULL AND cd_estabelecimento_w::text <> '' AND ie_opcao_p = 'E') then
	select  max(cd_estabelecimento)
	into STRICT	cd_estabelecimento_ww
	from 	lab_parametro
	where   cd_unidade_fleury = coalesce(cd_unidade_p,'0');

	if (cd_estabelecimento_ww <> cd_estabelecimento_w) then
		cd_estabelecimento_w := cd_estabelecimento_ww;
	end if;
end if;

if (ie_opcao_p = 'E') then
	return cd_estabelecimento_w;
elsif (ie_opcao_p = 'AF') then
	return ie_agrupa_ficha_fleury_w;
elsif (ie_opcao_p = 'GA') then
	return ie_gera_analito_fleury_w;
end if;

return	'';

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION fleury_obter_dados_unidade ( cd_unidade_p bigint, ie_opcao_p text) FROM PUBLIC;

