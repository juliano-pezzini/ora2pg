-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_retorno_paciente_hdm ( Cd_Estabelecimento_P bigint, Nm_Pessoa_Fisica_P text Default Null, Dt_Nascimento_P timestamp Default Null, Nm_Mae_P text Default Null, Nr_Cpf_P text Default Null, Nr_Identidade_P text Default Null, NR_TELEFONE_P text default null) RETURNS bigint AS $body$
DECLARE


Cd_Pessoa_Fisica_W double precision;
Ie_Nome_Pf_W varchar(3);
Ie_Data_Nasc_W varchar(3);
Ie_Nome_Mae_W varchar(3);
Ie_Cpf_W varchar(3);
Ie_Rg_W varchar(3);
Ie_Fone_Residencial_W varchar(3);
ds_comando_w varchar(4000);

C01 CURSOR FOR
    SELECT	Ie_Nome_Pf,
    Ie_Data_Nasc,
    Ie_Nome_Mae,
    Ie_Cpf,
    Ie_Rg,
    ie_fone_residencial
    From	Hdm_Regra_Valida_Pf LIMIT 1;


BEGIN

      OPEN c01;
       FETCH c01 INTO
            Ie_Nome_Pf_W,
            Ie_Data_Nasc_W,
            Ie_Nome_Mae_W,
            Ie_Cpf_W,
            Ie_Rg_W,
            Ie_Fone_Residencial_W;
       CLOSE c01;

      Ds_Comando_W := 'SELECT coalesce(max(a.cd_pessoa_fisica),''0'') FROM PESSOA_FISICA A WHERE 1 = 1';


      If (Ie_Nome_Pf_W = 'O' and (NM_PESSOA_FISICA_P IS NOT NULL AND NM_PESSOA_FISICA_P::text <> '')) Then
          Ds_Comando_W := Ds_Comando_W || ' AND Upper(A.NM_PESSOA_FISICA) =  Upper(''' || NM_PESSOA_FISICA_P || ''')';
      End If;

      If (Ie_Data_Nasc_W = 'O' and (Dt_Nascimento_P IS NOT NULL AND Dt_Nascimento_P::text <> '')) Then
          Ds_Comando_W := Ds_Comando_W || ' AND A.DT_NASCIMENTO = ' || Dt_Nascimento_P || '''';
      End If;
      If (Ie_Nome_Mae_W = 'O' And (Nm_Mae_P IS NOT NULL AND Nm_Mae_P::text <> '')) Then
          Ds_Comando_W := Ds_Comando_W || ' AND EXISTS (SELECT B.NM_CONTATO FROM COMPL_PESSOA_FISICA B WHERE A.CD_PESSOA_FISICA = B.CD_PESSOA_FISICA AND B.IE_TIPO_COMPLEMENTO = 5 AND UPPER(B.NM_CONTATO) = Upper(''' || NM_MAE_P || '''))';
      End If;
      If (Ie_Cpf_W = 'O' And (Nr_Cpf_P IS NOT NULL AND Nr_Cpf_P::text <> '')) Then
        Ds_Comando_W := Ds_Comando_W || ' AND A.NR_CPF = ' || NR_CPF_P;
      End If;
      If (Ie_Rg_W = 'O' And (Nr_Identidade_P IS NOT NULL AND Nr_Identidade_P::text <> '')) Then
          Ds_Comando_W := Ds_Comando_W || ' AND A.NR_IDENTIDADE = ' || NR_IDENTIDADE_P;
      End If;
      If (Ie_Fone_Residencial_W = 'O' And (Nr_Telefone_P IS NOT NULL AND Nr_Telefone_P::text <> '')) Then
        Ds_Comando_W := Ds_Comando_W || ' AND EXISTS (SELECT B.NM_CONTATO FROM COMPL_PESSOA_FISICA B WHERE A.CD_PESSOA_FISICA = B.CD_PESSOA_FISICA AND B.IE_TIPO_COMPLEMENTO = 1 AND somente_numero_char(B.NR_TELEFONE) = ''' || somente_numero_char(Nr_Telefone_P) || ''')';
      end if;


      If (Ie_Nome_Pf_W = 'D' and (NM_PESSOA_FISICA_P IS NOT NULL AND NM_PESSOA_FISICA_P::text <> '')) Then
          Ds_Comando_W := Ds_Comando_W || ' AND Upper(A.NM_PESSOA_FISICA) =  Upper(''' || NM_PESSOA_FISICA_P || ''') OR A.NM_PESSOA_FISICA IS NULL';
      End If;
      If (Ie_Data_Nasc_W = 'D' and (Dt_Nascimento_P IS NOT NULL AND Dt_Nascimento_P::text <> '')) Then
          Ds_Comando_W := Ds_Comando_W || ' AND( A.DT_NASCIMENTO = ''' || Dt_Nascimento_P  || ''') OR A.DT_NASCIMENTO IS NULL';
      End If;
      If (Ie_Nome_Mae_W = 'D' and (NM_MAE_P IS NOT NULL AND NM_MAE_P::text <> '')) Then
          Ds_Comando_W := Ds_Comando_W || ' AND EXISTS (SELECT B.NM_CONTATO FROM COMPL_PESSOA_FISICA B WHERE A.CD_PESSOA_FISICA = B.CD_PESSOA_FISICA AND B.IE_TIPO_COMPLEMENTO = 5 AND (UPPER(B.NM_CONTATO) = Upper(''' || NM_MAE_P || ''')OR B.NM_CONTATO IS NULL))';
      End If;
      If (Ie_Cpf_W = 'D' and (NR_CPF_P IS NOT NULL AND NR_CPF_P::text <> '')) Then
        Ds_Comando_W := Ds_Comando_W || ' AND (A.NR_CPF = ' || NR_CPF_P || ' OR A.NR_CPF IS NULL)';
      End If;
      If (Ie_Rg_W = 'D' and  (NR_IDENTIDADE_P IS NOT NULL AND NR_IDENTIDADE_P::text <> '')) Then
          Ds_Comando_W := Ds_Comando_W || ' AND (A.NR_IDENTIDADE = ' || NR_IDENTIDADE_P || ' OR A.NR_IDENTIDADE IS NULL)';
      End If;
      If (Ie_Fone_Residencial_W = 'D' And (Nr_Telefone_P IS NOT NULL AND Nr_Telefone_P::text <> '')) Then
          Ds_Comando_W := Ds_Comando_W || ' AND EXISTS (SELECT B.NM_CONTATO FROM COMPL_PESSOA_FISICA B WHERE A.CD_PESSOA_FISICA = B.CD_PESSOA_FISICA AND B.IE_TIPO_COMPLEMENTO = 1 AND (somente_numero_char(B.NR_TELEFONE) = ''' || somente_numero_char(Nr_Telefone_P) || ''' OR B.NR_TELEFONE IS NULL))';
      end if;


      Ds_Comando_W := Ds_Comando_W || '  AND ROWNUM = 1 ORDER BY';


      If (Ie_Nome_Pf_W = 'O' Or Ie_Nome_Pf_W = 'D') Then
          Ds_Comando_W := Ds_Comando_W || ' upper(A.NM_PESSOA_FISICA),';
      End If;
      If (Ie_Data_Nasc_W = 'O' OR Ie_Data_Nasc_W = 'D') Then
          Ds_Comando_W := Ds_Comando_W || ' A.DT_NASCIMENTO,';
      End If;
      If (Ie_Nome_Mae_W = 'O' OR Ie_Nome_Mae_W = 'D') Then
          Ds_Comando_W := Ds_Comando_W || ' A.CD_PESSOA_MAE,';
      End If;
      If (Ie_Cpf_W = 'O' OR Ie_Cpf_W = 'D') Then
        Ds_Comando_W := Ds_Comando_W || ' A.NR_CPF,';
      End If;
      If (Ie_Rg_W = 'O' OR Ie_Rg_W = 'D') Then
          Ds_Comando_W := Ds_Comando_W || ' A.NR_IDENTIDADE,';
      End If;
      Ds_Comando_W := Ds_Comando_W || ' A.CD_PESSOA_FISICA';


    EXECUTE ds_comando_w INTO STRICT Cd_Pessoa_Fisica_W;


      If (coalesce(Cd_Pessoa_Fisica_W::text, '') = '') Then
        Cd_Pessoa_Fisica_W := '0';
      end if;

      Return	Cd_Pessoa_Fisica_W;

End;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_retorno_paciente_hdm ( Cd_Estabelecimento_P bigint, Nm_Pessoa_Fisica_P text Default Null, Dt_Nascimento_P timestamp Default Null, Nm_Mae_P text Default Null, Nr_Cpf_P text Default Null, Nr_Identidade_P text Default Null, NR_TELEFONE_P text default null) FROM PUBLIC;

