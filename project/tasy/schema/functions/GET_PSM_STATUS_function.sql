-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION get_psm_status ( nr_atendimento_p atendimento_paciente.nr_atendimento%TYPE ) RETURNS varchar AS $body$
DECLARE


    psm_status_w             varchar(1) := 'I';
    psm_report_generated_w   epc_psm_data.ie_psm_generated%TYPE;
    psm_count_w              bigint := 0;
    ie_mandatory_filled_w    varchar(1);

BEGIN
    SELECT
        COUNT(*)
    INTO STRICT psm_count_w
    FROM
        epc_psm_data
    WHERE
        nr_atendimento = nr_atendimento_p;

    IF psm_count_w > 0 THEN
        SELECT
            ie_psm_generated
        INTO STRICT psm_report_generated_w
        FROM
            epc_psm_data
        WHERE
            nr_atendimento = nr_atendimento_p;

        IF psm_report_generated_w <> 'I' THEN
            psm_status_w := psm_report_generated_w;
        ELSE
            SELECT
                is_mandatory_filled(strarray(psm.qt_ph_level, psm.qt_gram, psm.qt_apgar_ten_min, psm.qt_apgar_five_min, psm.qt_apgar_one_min,
                                            psm.nm_body_weight_before_birth, psm.nm_body_weight_mother, psm.dt_ult_parto, psm.nm_live_birth,
                                            mdb.nm_mw_phone, mdb.ds_mw_email, mdb.nr_street_number, mdb.ds_street_name, mdb.ds_city,
                                            mdb.cd_postal_code, mdb.nm_mw_first_name, mdb.nm_mw_last_name, mdb.ds_department, mdb.ds_institution,
                                            get_pre_parto_value('qt_altura_cm', p.nr_atendimento), p.ie_tabagismo))
            INTO STRICT ie_mandatory_filled_w
            FROM
                epc_psm_data           psm
                INNER JOIN atendimento_paciente   ap ON psm.nr_atendimento = ap.nr_atendimento
                INNER JOIN master_data_birth      mdb ON mdb.cd_estabelecimento = ap.cd_estabelecimento
                INNER JOIN nascimento             n ON n.nr_atend_rn = psm.nr_atendimento
                INNER JOIN parto                  p ON p.nr_atendimento = n.nr_atendimento
            WHERE
                psm.nr_atendimento = nr_atendimento_p;

            IF ie_mandatory_filled_w = 'N' THEN
                psm_status_w := 'I';
            ELSE
                psm_status_w := 'U';
            END IF;

        END IF;

    END IF;

    RETURN psm_status_w;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION get_psm_status ( nr_atendimento_p atendimento_paciente.nr_atendimento%TYPE ) FROM PUBLIC;

