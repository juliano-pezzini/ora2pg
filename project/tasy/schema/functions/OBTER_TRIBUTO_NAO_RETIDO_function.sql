-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_tributo_nao_retido (nr_sequencia_p bigint, cd_tributo_p bigint, nm_usuario_p text, ie_previa_p text default 'N') RETURNS bigint AS $body$
DECLARE

-- fucntion baseada na procedure gerar_tributos_fornecedor
vl_soma_trib_nao_retido_w	double precision;
cd_tributo_w				bigint;
dt_emissao_w				timestamp;
cd_cgc_emitente_w			varchar(20);
cd_cnpj_emitente_raiz_w		varchar(20);
cd_pessoa_fisica_w			varchar(10);
cd_cgc_w					varchar(20);
ie_apuracao_piso_w			varchar(3);
cd_estabelecimento_w		smallint;
cd_empresa_regra_w			bigint;
ie_pf_pj_w					tributo.ie_pf_pj%type;
ie_acumulativo_w			varchar(1);
cd_estab_regra_w			bigint;
nr_seq_regra_w				bigint;
ie_gera_trib_geral_w		varchar(15);
nr_contrato_w				bigint;
ie_tipo_tributacao_w		varchar(255);
nr_ccm_w					bigint	:= null;
cd_beneficiario_w			varchar(20);
pr_imposto_w				double precision;
cd_cond_pagto_w				smallint;
cd_conta_financ_w			bigint;
nr_seq_trans_reg_w			bigint;
nr_seq_trans_baixa_w		bigint;
vl_minimo_base_calculo_w	double precision;
vl_minimo_tributo_w			double precision;
vl_teto_base_w				double precision;
vl_desc_dependente_w		double precision;
cd_darf_w					varchar(20);
cd_variacao_w				varchar(2);
ie_periodicidade_w			varchar(1);
cd_natureza_operacao_w		bigint;
cd_tipo_servico_w			varchar(100);
cd_material_regra_w			bigint;
qt_regra_duplicada_w		bigint	:= 0;
vl_item_nf_estrut_w			double precision;
vl_item_nf_estrut_ww		double precision;
cd_operacao_nf_w			smallint;
qt_pago_outros_w			bigint;
nr_seq_classe_w				bigint;
cd_tipo_baixa_neg_w			integer;
vl_liquido_w				double precision;
vl_liquido_original_w		double precision;
ie_corpo_item_w				varchar(5);
ie_forma_pagamento_w		smallint;
vl_base_venc_w				double precision;
ie_ordem_w					varchar(1);
ie_isento_w					tributo.ie_isento%type;
ie_desc_nf_w				varchar(255);
ie_restringe_estab_w		varchar(255);
ie_cnpj_w					varchar(20);
ie_soma_diminui_w			varchar(5);
ie_tipo_tributo_w			varchar(15);
vl_desc_nf_w				double precision;
cd_cnpj_raiz_w				varchar(20);
cd_empresa_w				smallint;
cd_condicao_pagamento_w		bigint;

C01 CURSOR FOR
	SELECT	ie_ordem,
		cd_tributo,
		ie_tipo_tributo,
		ie_apuracao_piso,
		ie_corpo_item,
		ie_soma_diminui,
		ie_cnpj,
		ie_restringe_estab,
		ie_desc_nf,
		ie_isento,
		ie_pf_pj
	from	(SELECT	CASE WHEN a.ie_tipo_tributo='IR' THEN 'Z'  ELSE 'A' END  ie_ordem,
			a.cd_tributo,
			a.ie_tipo_tributo,
			a.ie_apuracao_piso,
			a.ie_corpo_item,
			a.ie_soma_diminui,
			a.ie_cnpj,
			a.ie_restringe_estab,
			coalesce(a.ie_desc_nf,'N') ie_desc_nf,
			coalesce(a.ie_isento,'N') ie_isento,
			a.ie_pf_pj
		from	Tributo a
		where	a.ie_conta_pagar	= 'S'
		and	a.ie_situacao		= 'A'
		and	coalesce(nr_contrato_w,0) > 0
		and	((coalesce(a.ie_gera_nf_devolucao,'S') = 'S') or (coalesce(a.ie_gera_nf_devolucao,'S') = 'N' and sup_obter_se_nf_devolucao(nr_sequencia_p) = 'N'))
		and	((ie_gera_trib_geral_w = 'S') and (not exists (select	1
					from 	contrato_regra_pagto_trib d,
						contrato_regra_nf c
					where	d.nr_seq_regra_nf	= c.nr_sequencia
					and 	trunc(coalesce(c.dt_inicio_vigencia,clock_timestamp()),'dd') <= trunc(clock_timestamp(),'dd') and trunc(coalesce(c.dt_fim_vigencia,clock_timestamp()),'dd') >= trunc(clock_timestamp(),'dd')
                    and (coalesce(c.ie_situacao::text, '') = '' or c.ie_situacao = 'A')
					and	c.nr_seq_contrato	= nr_contrato_w)
			or exists (select	1
					from 	contrato_regra_pagto_trib d,
						contrato_regra_nf c
					where	d.nr_seq_regra_nf	= c.nr_sequencia
					and	d.cd_tributo		= a.cd_tributo
					and	c.nr_seq_contrato	= nr_contrato_w
					and 	trunc(coalesce(c.dt_inicio_vigencia,clock_timestamp()),'dd') <= trunc(clock_timestamp(),'dd') and trunc(coalesce(c.dt_fim_vigencia,clock_timestamp()),'dd') >= trunc(clock_timestamp(),'dd')
                    and (coalesce(c.ie_situacao::text, '') = '' or c.ie_situacao = 'A')
					and	coalesce(d.ie_regra_trib,'N') = 'S')))
		and	a.ie_corpo_item	in ('C','V')
		and (coalesce(ie_baixa_titulo,'N')	= 'N')
		and	((coalesce(ie_tipo_tributacao_w, 'X') <> '0') or (coalesce(ie_super_simples, 'S') = 'S'))
		and	coalesce(cd_tributo_p, a.cd_tributo)	= a.cd_tributo
		and	((coalesce(ie_pf_pj,'A') 	= 'A') or
			 (ie_pf_pj = 'PF' AND cd_pessoa_fisica_w IS NOT NULL AND cd_pessoa_fisica_w::text <> '') or
			 ((ie_pf_pj = 'PJ') and ((cd_cgc_w IS NOT NULL AND cd_cgc_w::text <> '') and (coalesce(cd_pessoa_fisica_w::text, '') = ''))))
		and (coalesce(nr_ccm_w::text, '') = '' or coalesce(a.ie_ccm,'S') = 'S')
		and	coalesce(cd_estabelecimento, cd_estabelecimento_w) = cd_estabelecimento_w
		
union

		select	CASE WHEN a.ie_tipo_tributo='IR' THEN 'Z'  ELSE 'A' END  ie_ordem,
			a.cd_tributo,
			a.ie_tipo_tributo,
			a.ie_apuracao_piso,
			a.ie_corpo_item,
			a.ie_soma_diminui,
			a.ie_cnpj,
			a.ie_restringe_estab,
			coalesce(a.ie_desc_nf,'N'),
			coalesce(a.ie_isento,'N') ie_isento,
			a.ie_pf_pj
		from	Tributo a
		where	a.ie_conta_pagar	= 'S'
		and	a.ie_situacao		= 'A'
		and	((coalesce(a.ie_gera_nf_devolucao,'S') = 'S') or (coalesce(a.ie_gera_nf_devolucao,'S') = 'N' and sup_obter_se_nf_devolucao(nr_sequencia_p) = 'N'))
		and	((coalesce(nr_contrato_w,0) > 0 and ie_gera_trib_geral_w = 'C') or (coalesce(nr_contrato_w,0) = 0))
		and	a.ie_corpo_item	in ('C','V')
		and (coalesce(ie_baixa_titulo,'N')	= 'N')
		and	((coalesce(ie_tipo_tributacao_w, 'X') <> '0') or (coalesce(ie_super_simples, 'S') = 'S'))
		and	coalesce(cd_tributo_p, a.cd_tributo)	= a.cd_tributo
		and	((coalesce(ie_pf_pj,'A') 	= 'A') or
			 (ie_pf_pj = 'PF' AND cd_pessoa_fisica_w IS NOT NULL AND cd_pessoa_fisica_w::text <> '') or
			 ((ie_pf_pj = 'PJ') and ((cd_cgc_w IS NOT NULL AND cd_cgc_w::text <> '') and (coalesce(cd_pessoa_fisica_w::text, '') = ''))))
		and (coalesce(nr_ccm_w::text, '') = '' or coalesce(a.ie_ccm,'S') = 'S')
		and	coalesce(cd_estabelecimento, cd_estabelecimento_w) = cd_estabelecimento_w
		
union

		select	CASE WHEN a.ie_tipo_tributo='IR' THEN 'Z'  ELSE 'A' END  ie_ordem,
			a.cd_tributo,
			a.ie_tipo_tributo,
			a.ie_apuracao_piso,
			a.ie_corpo_item,
			a.ie_soma_diminui,
			a.ie_cnpj,
			a.ie_restringe_estab,
			coalesce(a.ie_desc_nf,'N'),
			coalesce(a.ie_isento,'N') ie_isento,
			a.ie_pf_pj
		from	Tributo a
		where	a.ie_conta_pagar	= 'S'
		and	a.ie_situacao		= 'A'
		and	((coalesce(a.ie_gera_nf_devolucao,'S') = 'S') or (coalesce(a.ie_gera_nf_devolucao,'S') = 'N' and sup_obter_se_nf_devolucao(nr_sequencia_p) = 'N'))
		and	((coalesce(nr_contrato_w,0) > 0) and (ie_gera_trib_geral_w = 'N') and
			exists (select	1
				from 	CONTRATO_REGRA_PAGTO_TRIB d,
					CONTRATO_REGRA_NF c
				where	d.nr_seq_regra_nf	= c.nr_sequencia
				and	d.cd_tributo		= a.cd_tributo
				and	c.nr_seq_contrato	= nr_contrato_w
				and	coalesce(d.ie_regra_trib,'N') = 'S'))
		and	a.ie_corpo_item	in ('C','V')
		and (coalesce(ie_baixa_titulo,'N')	= 'N')
		and	((coalesce(ie_tipo_tributacao_w, 'X') <> '0') or (coalesce(ie_super_simples, 'S') = 'S'))
		and	coalesce(cd_tributo_p, a.cd_tributo)	= a.cd_tributo
		and	((coalesce(ie_pf_pj,'A') 	= 'A') or
			 (ie_pf_pj = 'PF' AND cd_pessoa_fisica_w IS NOT NULL AND cd_pessoa_fisica_w::text <> '') or
			 ((ie_pf_pj = 'PJ') and ((cd_cgc_w IS NOT NULL AND cd_cgc_w::text <> '') and (coalesce(cd_pessoa_fisica_w::text, '') = ''))))
		and (coalesce(nr_ccm_w::text, '') = '' or coalesce(a.ie_ccm,'S') = 'S')		
		and	coalesce(cd_estabelecimento, cd_estabelecimento_w) = cd_estabelecimento_w) a
	order by CASE WHEN a.ie_tipo_tributo='INSS' THEN 1  ELSE 2 END ,
		CASE WHEN a.ie_corpo_item='C' THEN  0  ELSE 1 END ,
		ie_ordem;

C02 CURSOR FOR
	SELECT	0 ie_ordem,
		a.cd_estabelecimento,
		a.cd_cgc,
		a.cd_cgc_emitente,
		a.cd_pessoa_fisica,
		a.dt_emissao dt_vencimento,
		0
	from	nota_fiscal a
	where	a.nr_sequencia	= nr_sequencia_p
	and	ie_corpo_item_w	= 'C'
	
union all

	SELECT	1 ie_ordem,
		a.cd_estabelecimento,
		a.cd_cgc,
		a.cd_cgc_emitente,
		a.cd_pessoa_fisica,
		b.dt_vencimento,
		b.vl_base_venc
	from	nota_fiscal_venc b,
		nota_fiscal a
	where	a.nr_sequencia	= nr_sequencia_p
	and	a.nr_sequencia	= b.nr_sequencia
	and	ie_corpo_item_w	= 'V'
	order	by ie_ordem,
		dt_vencimento asc;

C04 CURSOR FOR
	SELECT	a.cd_material,
		a.vl_liquido
	from	estrutura_material_v	b,
		nota_fiscal_item	a,
		tributo_conta_pagar x
	where	a.cd_material	= b.cd_material
	and	a.nr_sequencia	= nr_sequencia_p
	and	obter_se_estrutura_mat(x.cd_grupo_material, x.cd_subgrupo_material, x.cd_classe_material, x.cd_material, a.cd_material, 'S') = 'S'
	and	((x.cd_material		= a.cd_material) or (x.cd_grupo_material	= b.cd_grupo_material) or (x.cd_subgrupo_material	= b.cd_subgrupo_material) or (x.cd_classe_material	= b.cd_classe_material))
	and	((coalesce(x.cd_pessoa_juridica::text, '') = '' and coalesce(x.cd_pessoa_fisica::text, '') = '') or (x.cd_pessoa_juridica = cd_cgc_w and coalesce(x.cd_pessoa_fisica::text, '') = '') or (x.cd_pessoa_fisica = cd_pessoa_fisica_w and coalesce(x.cd_pessoa_juridica::text, '') = ''))
	and (coalesce(x.cd_estabelecimento, cd_estabelecimento_w) = cd_estabelecimento_w)
	and (coalesce(x.cd_empresa, cd_empresa_w) = cd_empresa_w)
	and	dt_emissao_w between coalesce(dt_inicio_vigencia, dt_emissao_w - 1) and coalesce(dt_fim_vigencia, dt_emissao_w + 1)
	and	x.cd_tributo	= cd_tributo_w
	and	x.pr_aliquota <> 0
	and	not exists(	SELECT	1
				from	tributo_conta_pagar y
				where	((y.cd_material		= a.cd_material) or (y.cd_grupo_material	= b.cd_grupo_material) or (y.cd_subgrupo_material	= b.cd_subgrupo_material) or (y.cd_classe_material	= b.cd_classe_material))
				  and	y.pr_aliquota = 0
				  and	y.cd_tributo = cd_tributo_w)
	order by b.cd_grupo_material,
		 b.cd_subgrupo_material,
		 b.cd_classe_material,
		 b.cd_material;

BEGIN

select	cd_estabelecimento,
	cd_cgc,
	cd_cgc_emitente,
	cd_pessoa_fisica,
	dt_emissao,
	cd_condicao_pagamento,
	obter_cnpj_raiz(cd_cgc),
	obter_cnpj_raiz(cd_cgc_emitente),
	cd_natureza_operacao,
	cd_tipo_servico,
	cd_operacao_nf,
	coalesce(vl_descontos,0),
	obter_empresa_estab(cd_estabelecimento)
into STRICT	cd_estabelecimento_w,
	cd_cgc_w,
	cd_cgc_emitente_w,
	CD_pessoa_fisica_w,
	dt_emissao_w,
	cd_condicao_pagamento_w,
	cd_cnpj_raiz_w,
	cd_cnpj_emitente_raiz_w,
	cd_natureza_operacao_w,
	cd_tipo_servico_w,
	cd_operacao_nf_w,
	vl_desc_nf_w,
	cd_empresa_w
from	nota_fiscal
where	nr_sequencia = nr_sequencia_p;

select	coalesce(max(ie_gera_tributo_geral),'N')
into STRICT	ie_gera_trib_geral_w
from	parametro_compras
where	cd_estabelecimento = cd_estabelecimento_w;

if (cd_pessoa_fisica_w IS NOT NULL AND cd_pessoa_fisica_w::text <> '') then
	select	max(nr_ccm)
	into STRICT	nr_ccm_w
	from	pessoa_fisica
	where	cd_pessoa_fisica	= cd_pessoa_fisica_w;
end if;

select	ie_forma_pagamento
into STRICT	ie_forma_pagamento_w
from	condicao_pagamento
where	cd_condicao_pagamento = cd_condicao_pagamento_w;

select	coalesce(sum(vl_liquido),0)
into STRICT	vl_liquido_original_w
from	nota_fiscal_item
where	nr_sequencia = nr_sequencia_p;

select	max(coalesce(nr_contrato,0))
into STRICT	nr_contrato_w
from	nota_fiscal_item
where	nr_sequencia = nr_sequencia_p;

-- afstringari 166959 16/10/2009
select	max(ie_tipo_tributacao)
into STRICT	ie_tipo_tributacao_w
from	pessoa_juridica
where	cd_cgc	= cd_cgc_w;

OPEN C01;
LOOP
FETCH C01 into
	ie_ordem_w,
	cd_tributo_w,
	ie_tipo_tributo_w,
	ie_apuracao_piso_w,
	ie_corpo_item_w,
	ie_soma_diminui_w,
	IE_CNPJ_w,
	ie_restringe_estab_w,
	ie_desc_nf_w,
	ie_isento_w,
	ie_pf_pj_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	open C02;
	loop
	fetch C02 into
		ie_ordem_w,
		cd_estabelecimento_w,
		cd_cgc_w,
		cd_cgc_emitente_w,
		CD_pessoa_fisica_w,
		dt_emissao_w,
		vl_base_venc_w;

	EXIT WHEN NOT FOUND; /* apply on C02 */

		vl_liquido_w				:= vl_liquido_original_w;
		if (ie_desc_nf_w = 'S') then
			vl_liquido_w			:= vl_liquido_w - vl_desc_nf_w;
		end if;

		if (ie_corpo_item_w = 'V') and (ie_forma_pagamento_w <> 10) then	/*conforme vencimentos*/
			vl_liquido_w			:= vl_base_venc_w;
		end if;

		PR_IMPOSTO_W			:= 0;

		if (coalesce(ie_previa_p,'N') = 'N') then
			select	count(*)
			into STRICT	qt_pago_outros_w
			from	nota_fiscal_trib
			where	nr_sequencia	= nr_sequencia_p
			and	cd_tributo	= cd_tributo_w
			and	ie_pago_prev	= 'P';
		else
			select	count(*)
			into STRICT	qt_pago_outros_w
			from	nota_fiscal_trib_prev
			where	nr_seq_nota	= nr_sequencia_p
			and	cd_tributo	= cd_tributo_w
			and	ie_pago_prev	= 'P';
		end if;

		cd_material_regra_w	:= null;
		vl_item_nf_estrut_w	:= null;

		select	count(distinct a.cd_material)
		into STRICT	qt_regra_duplicada_w
		from	estrutura_material_v	b,
			nota_fiscal_item	a
		where	exists
			(SELECT	1
			from	tributo_conta_pagar x
			where	obter_se_estrutura_mat(x.cd_grupo_material, x.cd_subgrupo_material, x.cd_classe_material, x.cd_material, a.cd_material, 'S') = 'S'
			and	((x.cd_material		= a.cd_material) or (x.cd_grupo_material	= b.cd_grupo_material) or (x.cd_subgrupo_material	= b.cd_subgrupo_material) or (x.cd_classe_material	= b.cd_classe_material))
			and	((coalesce(x.cd_pessoa_juridica::text, '') = '' and coalesce(x.cd_pessoa_fisica::text, '') = '') or (x.cd_pessoa_juridica = cd_cgc_w and coalesce(x.cd_pessoa_fisica::text, '') = '') or (x.cd_pessoa_fisica = cd_pessoa_fisica_w and coalesce(x.cd_pessoa_juridica::text, '') = ''))
			and (coalesce(x.cd_estabelecimento, cd_estabelecimento_w) = cd_estabelecimento_w)
			and (coalesce(x.cd_empresa, cd_empresa_w) = cd_empresa_w)
			and	dt_emissao_w between coalesce(dt_inicio_vigencia, dt_emissao_w - 1) and coalesce(dt_fim_vigencia, dt_emissao_w + 1)
			and	x.cd_tributo	= cd_tributo_w
			having	count(*) > 1)
		and	a.cd_material	= b.cd_material
		and	a.nr_sequencia	= nr_sequencia_p;

		if (qt_regra_duplicada_w = 0) then -- aqui q ta, vai pegar do maior codigo
			select	max(a.cd_material),
				sum(a.vl_liquido)
			into STRICT	cd_material_regra_w,
				vl_item_nf_estrut_w
			from	estrutura_material_v	b,
				nota_fiscal_item	a
			where	exists
				(SELECT	1
				from	tributo_conta_pagar x
				where	obter_se_estrutura_mat(x.cd_grupo_material, x.cd_subgrupo_material, x.cd_classe_material, x.cd_material, a.cd_material, 'S') = 'S'
				and	((x.cd_material		= a.cd_material) or (x.cd_grupo_material	= b.cd_grupo_material) or (x.cd_subgrupo_material	= b.cd_subgrupo_material) or (x.cd_classe_material	= b.cd_classe_material))
				and	((coalesce(x.cd_pessoa_juridica::text, '') = '' and coalesce(x.cd_pessoa_fisica::text, '') = '') or (x.cd_pessoa_juridica = cd_cgc_w and coalesce(x.cd_pessoa_fisica::text, '') = '') or (x.cd_pessoa_fisica = cd_pessoa_fisica_w and coalesce(x.cd_pessoa_juridica::text, '') = ''))
				and (coalesce(x.cd_estabelecimento, cd_estabelecimento_w) = cd_estabelecimento_w)
				and	dt_emissao_w between coalesce(dt_inicio_vigencia, dt_emissao_w - 1) and coalesce(dt_fim_vigencia, dt_emissao_w + 1)
				and	x.cd_tributo	= cd_tributo_w
				and	x.pr_aliquota <> 0)
			and	a.cd_material	= b.cd_material
			and	a.nr_sequencia	= nr_sequencia_p;
		else
			vl_item_nf_estrut_w := 0;
			open C04;
				loop
				fetch C04 into	--OS630365
					cd_material_regra_w,
					vl_item_nf_estrut_ww;
				EXIT WHEN NOT FOUND; /* apply on C04 */
					begin
					cd_material_regra_w := cd_material_regra_w;
					vl_item_nf_estrut_w := vl_item_nf_estrut_w + vl_item_nf_estrut_ww;
					end;
				end loop;
				close C04;

		end if;

		SELECT * FROM OBTER_DADOS_TRIB_TIT_PAGAR(CD_TRIBUTO_w, CD_ESTABELECIMENTO_w, CD_CGC_w, CD_pessoa_fisica_w, CD_BENEFICIARIO_w, PR_IMPOSTO_W, CD_COND_PAGTO_w, CD_CONTA_FINANC_w, NR_SEQ_TRANS_REG_w, NR_SEQ_TRANS_BAIXA_w, VL_MINIMO_BASE_CALCULO_W, vl_minimo_tributo_w, ie_acumulativo_w, vl_teto_base_w, vl_desc_dependente_w, cd_darf_w, dt_emissao_w, cd_variacao_w, ie_periodicidade_w, null, cd_natureza_operacao_w, cd_tipo_servico_w, cd_material_regra_w, null, null, nr_seq_regra_w, cd_operacao_nf_w, qt_pago_outros_w, nr_seq_classe_w, cd_tipo_baixa_neg_w, vl_liquido_w, 'N', null, null, null, null) INTO STRICT CD_BENEFICIARIO_w, PR_IMPOSTO_W, CD_COND_PAGTO_w, CD_CONTA_FINANC_w, NR_SEQ_TRANS_REG_w, NR_SEQ_TRANS_BAIXA_w, VL_MINIMO_BASE_CALCULO_W, vl_minimo_tributo_w, ie_acumulativo_w, vl_teto_base_w, vl_desc_dependente_w, cd_darf_w, cd_variacao_w, ie_periodicidade_w, nr_seq_regra_w, nr_seq_classe_w, cd_tipo_baixa_neg_w;

		select	coalesce(sum(a.vl_soma_trib_nao_retido),0)
			into STRICT	vl_soma_trib_nao_retido_w
			from	(
				SELECT	vl_soma_trib_nao_retido	vl_soma_trib_nao_retido
				from	valores_tributo_v a
				where	a.cd_tributo			= cd_tributo_w
				and (ie_acumulativo_w <> 'D')
				and	trunc(a.dt_tributo, 'month')	= trunc(dt_emissao_w, 'month')
				and	(
					  (
					    ((coalesce(a.cd_cgc_emitente, 'X') = coalesce(cd_cgc_emitente_w, 'X')) and (a.ie_origem_valores = 'NFE')) or
					    (ie_cnpj_w = 'Empresa' AND cd_cnpj_emitente_raiz = cd_cnpj_emitente_raiz_w)
					  ) or
					  (
					    (coalesce(a.cd_cgc_emitente::text, '') = '') and (a.ie_origem_valores <> 'NFE')
					  )
					)
				and	(
					  ((cd_pessoa_fisica_w IS NOT NULL AND cd_pessoa_fisica_w::text <> '') and a.cd_pessoa_fisica = cd_pessoa_fisica_w) or
					  (
					    (coalesce(cd_pessoa_fisica_w::text, '') = '') and (cd_cgc_w IS NOT NULL AND cd_cgc_w::text <> '') and (coalesce(a.cd_pessoa_fisica::text, '') = '') and
					    (
					       (a.cd_cgc 		= cd_cgc_w) or
					       (IE_CNPJ_w = 'Empresa' AND a.cd_cnpj_raiz = cd_cnpj_raiz_w)
					    )
					  )
					)
				and (a.ie_origem_valores		= 'NFE' or ie_apuracao_piso_w = 'S')
				and	((ie_restringe_estab_w		= 'N') or (a.cd_estabelecimento		= cd_estabelecimento_w) or (a.cd_estab_financeiro		= cd_estabelecimento_w) or (coalesce(cd_estab_regra_w::text, '') = '' and a.cd_empresa = cd_empresa_regra_w))
				and (ie_apuracao_piso_w		= 'N' or
					ie_apuracao_piso_w		= ie_base_calculo)
				and	ie_baixa_titulo			= 'N'
				and nr_seq_nota_fiscal != nr_sequencia_p
				
union all

				SELECT	vl_soma_trib_nao_retido	vl_soma_trib_nao_retido
				from	valores_tributo_v a
				where	a.cd_tributo			= cd_tributo_w
				and 	a.ie_tipo_tributo		= 'IR'
				and 	ie_pf_pj_w			= 'PJ'
				and 	ie_acumulativo_w		= 'D'
				and	pkg_date_utils.start_of(a.dt_tributo, 'DAY', 0)	= pkg_date_utils.start_of(dt_emissao_w, 'DAY', 0)
				and	(
					  (
					    ((coalesce(a.cd_cgc_emitente, 'X') = coalesce(cd_cgc_emitente_w, 'X')) and (a.ie_origem_valores = 'NFE')) or
					    (ie_cnpj_w = 'Empresa' AND cd_cnpj_emitente_raiz = cd_cnpj_emitente_raiz_w)
					  ) or
					  (
					    (coalesce(a.cd_cgc_emitente::text, '') = '') and (a.ie_origem_valores <> 'NFE')
					  )
					)
				and	(
					  ((cd_pessoa_fisica_w IS NOT NULL AND cd_pessoa_fisica_w::text <> '') and a.cd_pessoa_fisica = cd_pessoa_fisica_w) or
					  (
					    (coalesce(cd_pessoa_fisica_w::text, '') = '') and (cd_cgc_w IS NOT NULL AND cd_cgc_w::text <> '') and (coalesce(a.cd_pessoa_fisica::text, '') = '') and
					    (
					       (a.cd_cgc 		= cd_cgc_w) or
					       (IE_CNPJ_w = 'Empresa' AND a.cd_cnpj_raiz = cd_cnpj_raiz_w)
					    )
					  )
					)
				and (a.ie_origem_valores		= 'NFE' or cd_cgc_w = 'S')
				and	((ie_restringe_estab_w		= 'N') or (a.cd_estabelecimento		= cd_estabelecimento_w) or (a.cd_estab_financeiro		= cd_estabelecimento_w) or (coalesce(cd_estab_regra_w::text, '') = '' and a.cd_empresa = cd_empresa_regra_w))
				and (ie_apuracao_piso_w		= 'N' or
					ie_apuracao_piso_w		= ie_base_calculo)
				and	ie_baixa_titulo			= 'N'
				and nr_seq_nota_fiscal != nr_sequencia_p) a;

	end loop;
	close C02;	
end loop;
close C01;

return coalesce(vl_soma_trib_nao_retido_w,0);

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_tributo_nao_retido (nr_sequencia_p bigint, cd_tributo_p bigint, nm_usuario_p text, ie_previa_p text default 'N') FROM PUBLIC;

