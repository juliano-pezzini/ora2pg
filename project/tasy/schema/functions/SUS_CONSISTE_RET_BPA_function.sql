-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION sus_consiste_ret_bpa ( nr_atendimento_p bigint) RETURNS varchar AS $body$
DECLARE

 
ds_mensagem_w			varchar(4000);
ds_atendimentos_w		varchar(2000);
nr_atendimento_w		bigint;
quebra_w			varchar(10):= chr(13)||chr(10);
nr_atend_original_w		bigint;
ie_fim_conta_atend_orig_w	varchar(10);
DT_FIM_CONTA_w			timestamp;

C01 CURSOR FOR 
	SELECT	nr_atendimento 
	from	atendimento_paciente 
	where	nr_atend_original	= nr_atendimento_p 
	and	coalesce(dt_atend_original::text, '') = '' 
	order by nr_atendimento desc;


BEGIN 
 
open C01;
loop 
fetch C01 into	 
	nr_atendimento_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin 
	ds_atendimentos_w	:= nr_atendimento_w || ', '||ds_atendimentos_w;
	end;
end loop;
close C01;
ds_atendimentos_w	:= substr(ds_atendimentos_w ,1,length(ds_atendimentos_w)-2);
 
 
select	max(nr_atend_original), 
	max(dt_fim_conta) 
into STRICT	nr_atend_original_w, 
	dt_fim_conta_w 
from	atendimento_paciente 
where	nr_Atendimento	= nr_atendimento_p 
and	coalesce(dt_atend_original::text, '') = '';
 
select	max(ie_fim_conta) 
into STRICT	ie_fim_conta_atend_orig_w 
from	atendimento_paciente 
where	nr_atendimento	= nr_atend_original_w;
 
if (ds_atendimentos_w IS NOT NULL AND ds_atendimentos_w::text <> '') then 
	ds_mensagem_w	:= 'Existem os atendimentos: '||ds_atendimentos_w ||' , vinculados a este atendimento. ';
elsif (dt_fim_conta_w IS NOT NULL AND dt_fim_conta_w::text <> '') and (nr_atend_original_w IS NOT NULL AND nr_atend_original_w::text <> '') then 
	ds_mensagem_w	:= 'O Atendimmento '||nr_atend_original_w || ' de origem já está faturado.';
elsif (nr_atend_original_w IS NOT NULL AND nr_atend_original_w::text <> '') then 
	ds_mensagem_w	:= 'Este atendimento está vinculado ao atendimento '||nr_atend_original_w ||'.';
end if;
 
return	substr(ds_mensagem_w,1,4000);
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION sus_consiste_ret_bpa ( nr_atendimento_p bigint) FROM PUBLIC;

