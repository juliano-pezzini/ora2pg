-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_se_exibe_prescr_gpt (ie_tipo_gpt_p text, nr_prescricao_p bigint, cd_estabelecimento_p bigint, ie_motivo_prescricao_p text, ie_liberacao_enf_p bigint, ie_liberacao_farm_p bigint, ie_status_farm_p text, nr_seq_classif_transcr_p bigint, ie_intervencao_farm_p text, cd_grupo_material_p bigint, cd_subgrupo_material_p bigint, cd_classe_material_p bigint, cd_material_p bigint, ie_nao_padronizado_p text, ie_quimio_p text, ie_alto_risco_p text, ie_medic_alto_custo_p text, ie_medic_paciente_p text, ie_dispensacao_p bigint, ie_tipo_item_p bigint, ie_prescritor_p bigint, ie_urgencia_p bigint, cd_intervalo_p text, qt_minutos_agora_p bigint, ie_restrito_p text, ie_item_farm_nao_atend_p text, ie_itens_p bigint, ie_status_enf_p text, ie_sem_atendimento_p text, ie_alta_vigilancia_p text, ie_lib_farm_p text, ie_param_62_p text, ie_antibiotico_p text, ds_motivos_p text default null, ds_matmeds_p text default null) RETURNS varchar AS $body$
DECLARE


ie_exibe_w				varchar(1) := 'N';
cd_estabelecimento_w	prescr_medica.cd_estabelecimento%type;
dt_liberacao_farmacia_w		prescr_medica.dt_liberacao_farmacia%type;
nr_seq_classif_transcr_w	varchar(100);
ie_prescr_farm_w		prescr_medica.ie_prescr_farm%type;
ie_motivo_prescricao_w		prescr_medica.ie_motivo_prescricao%type;
cd_prescritor_w			prescr_medica.cd_prescritor%type;
cd_medico_w				prescr_medica.cd_medico%type;
nr_atendimento_w		prescr_medica.nr_atendimento%type;
dt_liberacao_enf_w		timestamp;
ie_lib_farm_w			prescr_medica.ie_lib_farm%type;
dt_inicio_analise_farm_w	timestamp;
dt_inicio_analise_enf_w	prescr_medica_compl.dt_inicio_analise_enf%type;
ie_medic_alto_custo_w	varchar(1);
ie_alta_vigilancia_w	varchar(1);
ie_dispensacao_w		varchar(1) := 'S';
ie_apresenta_urg_w		varchar(1) := 'S';
ie_apres_nao_atend_w	varchar(1) := 'N';
ie_antibiotico_w	varchar(1) := 'N';


BEGIN

	select	max(a.cd_estabelecimento),
			max(a.dt_liberacao_farmacia),
			max(obter_dados_transcricao(a.nr_seq_transcricao, 'CL')),
			max(a.ie_prescr_farm),
			max(a.ie_motivo_prescricao),
			max(a.cd_prescritor),
			max(a.cd_medico),
			max(a.nr_atendimento),
			max(a.dt_liberacao),
			max(a.ie_lib_farm),
			max(a.dt_inicio_analise_farm)
	into STRICT	cd_estabelecimento_w,
			dt_liberacao_farmacia_w,
			nr_seq_classif_transcr_w,
			ie_prescr_farm_w,
			ie_motivo_prescricao_w,
			cd_prescritor_w,
			cd_medico_w,
			nr_atendimento_w,
			dt_liberacao_enf_w,
			ie_lib_farm_w,
			dt_inicio_analise_farm_w		
	from	prescr_medica a
	where	a.nr_prescricao = nr_prescricao_p;

	select	max(b.dt_inicio_analise_enf)
	into STRICT	dt_inicio_analise_enf_w
	from	prescr_medica_compl b
	where	b.nr_prescricao = nr_prescricao_p;

	if (ie_medic_alto_custo_p	= 'S') then

		select	coalesce(max('S'),'N')
		into STRICT	ie_medic_alto_custo_w
		from	material a,
			prescr_material b,
			material_estab c
		where	a.cd_material = b.cd_material
		and	a.cd_material = c.cd_material
		and	c.cd_estabelecimento = cd_estabelecimento_w
		and	c.ie_classif_custo	= 'A'
		and	b.nr_prescricao = nr_prescricao_p
		and 	coalesce(b.ie_suspenso,'N') <> 'S';

	end if;

	if (ie_alta_vigilancia_p = 'S') then
		select	CASE WHEN count(*)=0 THEN 'N'  ELSE 'S' END
		into STRICT	ie_alta_vigilancia_w
		from 	material a,
			prescr_material b 
		where 	a.cd_material 	= b.cd_material
		and	b.nr_prescricao = nr_prescricao_p
		and 	a.ie_alta_vigilancia = 'S' and b.ie_suspenso <> 'S';
	end if;

	if (ie_dispensacao_p <> 2) then
		select	coalesce(max('S'),'N')
		into STRICT	ie_dispensacao_w
		from	prescr_material x
		where	x.nr_prescricao = nr_prescricao_p
		and	x.ie_regra_disp = 'U';
	end if;

	if (ie_urgencia_p	= 0) then
		if	((cd_intervalo_p IS NOT NULL AND cd_intervalo_p::text <> '') and (obter_se_prescr_agora(nr_prescricao_p,qt_minutos_agora_p,cd_intervalo_p) = 'N')) or
			((coalesce(cd_intervalo_p::text, '') = '') and (obter_se_prescr_agora(nr_prescricao_p,qt_minutos_agora_p,null) = 'N')) then
			ie_apresenta_urg_w	 := 'N';
		end if;
	elsif (ie_urgencia_p	= 1) then
		if	((cd_intervalo_p IS NOT NULL AND cd_intervalo_p::text <> '') and (obter_se_prescr_agora(nr_prescricao_p,qt_minutos_agora_p,cd_intervalo_p) = 'S')) or
			((coalesce(cd_intervalo_p::text, '') = '') and (obter_se_prescr_agora(nr_prescricao_p,qt_minutos_agora_p,null) = 'S')) then
			ie_apresenta_urg_w	 := 'N';
		end if;
	end if;

	if (ie_item_farm_nao_atend_p = 'S') then

		select	coalesce(max('S'),'N')
		into STRICT	ie_apres_nao_atend_w
		from	prescr_material
		where	nr_prescricao = nr_prescricao_p
		and	coalesce(cd_motivo_baixa, 0) = 0;

	end if;

	if (ie_antibiotico_p = 'S') then
		select	coalesce(max('S'),'N')
		into STRICT	ie_antibiotico_w
		from	cpoe_material a,
			prescr_material b
		where	b.nr_prescricao = nr_prescricao_p
		and	a.nr_sequencia = b.nr_seq_mat_cpoe
		and 	b.ie_agrupador in (1,4)
		and	coalesce(b.ie_suspenso,'N') <> 'S'
		and	coalesce(a.ie_material, 'N') = 'N'
		and	coalesce(a.ie_antibiotico, 'N') = 'S';
	end if;

	-- Restricoes por variaveis/consultas
	if (cd_estabelecimento_p = cd_estabelecimento_w) and
		((coalesce(ie_motivo_prescricao_p::text, '') = '') or (ie_motivo_prescricao_p = ie_motivo_prescricao_w)) and
        ((ie_motivo_prescricao_p IS NOT NULL AND ie_motivo_prescricao_p::text <> '') or (coalesce(ds_motivos_p::text, '') = '') or (gpt_obter_se_exibe_motivo(nr_prescricao_p, ds_motivos_p) = 'S')) and
		((ie_liberacao_farm_p  = 2) or		-- Pending pharmacy submission
			((ie_liberacao_farm_p = 1) and (coalesce(dt_liberacao_farmacia_w::text, '') = '')) or
			((ie_liberacao_farm_p = 0) and ((dt_liberacao_farmacia_w IS NOT NULL AND dt_liberacao_farmacia_w::text <> '') or coalesce(ie_param_62_p,'N') = 'S'))) and
		((ie_status_farm_p <> 'P') or (coalesce(dt_inicio_analise_farm_w::text, '') = '') and ((dt_liberacao_enf_w IS NOT NULL AND dt_liberacao_enf_w::text <> '') or ie_liberacao_enf_p in (1,2))) and -- Analysis status - pharmacy
		((ie_liberacao_enf_p = 2) or		-- Pending nursing submission
			((ie_liberacao_enf_p = 1) and (coalesce(dt_liberacao_enf_w::text, '') = '')) or
			((ie_liberacao_enf_p = 0) and ((dt_liberacao_enf_w IS NOT NULL AND dt_liberacao_enf_w::text <> '') or coalesce(ie_param_62_p,'N') = 'S'))) and
		((ie_status_enf_p <> 'P') or (coalesce(dt_inicio_analise_enf_w::text, '') = '')) and	-- Analysis status - nursing
		(((coalesce(ie_intervencao_farm_p::text, '') = '') or (ie_intervencao_farm_p = 'A')) or (ie_prescr_farm_w = ie_intervencao_farm_p)) and
		((ie_medic_alto_custo_p = 'N') or (ie_medic_alto_custo_p = ie_medic_alto_custo_w)) and
		((ie_alta_vigilancia_p = 'N') or (ie_alta_vigilancia_p = ie_alta_vigilancia_w)) and
		((ie_antibiotico_p = 'N') or (ie_antibiotico_p = ie_antibiotico_w)) and
		((ie_dispensacao_p = 2) or (ie_dispensacao_p = 1 and ie_dispensacao_w = 'N') or (ie_dispensacao_p = 0 and ie_dispensacao_w = 'S')) and
		((ie_prescritor_p = 0 AND cd_prescritor_w = cd_medico_w) or
			(ie_prescritor_p = 1 AND cd_prescritor_w <> cd_medico_w) or (ie_prescritor_p = 2)) and (ie_apresenta_urg_w = 'S') and
		((ie_item_farm_nao_atend_p = 'N') or
			(ie_apres_nao_atend_w = 'S' AND ie_item_farm_nao_atend_p = 'S')) and
		((ie_sem_atendimento_p = 'N' AND nr_atendimento_w IS NOT NULL AND nr_atendimento_w::text <> '') or (ie_sem_atendimento_p = 'S')) and
		((ie_tipo_gpt_p = 'E') or ((ie_tipo_gpt_p = 'F') and
			((coalesce(ie_lib_farm_p,'S') = 'N') or (coalesce(ie_lib_farm_w,'N') = 'S')))) and
		((coalesce(nr_seq_classif_transcr_p::text, '') = '') or (nr_seq_classif_transcr_p = (nr_seq_classif_transcr_w)::numeric )) then

		-- Restricoes por funcoes
		if ((ie_quimio_p = 'N') or (coalesce(obter_se_prescricao_quimio(nr_prescricao_p) ,'N') = 'S')) and
			((ie_medic_paciente_p = 'N') or (obter_se_medic_paciente(nr_prescricao_p) = 'S')) and
			((coalesce(cd_material_p::text, '') = '' and coalesce(ds_matmeds_p::text, '') = '') or (coalesce(obter_se_prescr_mat_gpt(nr_prescricao_p,cd_material_p,ds_matmeds_p),'S') = 'S')) and
			((ie_alto_risco_p = 'N') or (obter_se_medic_alto_risco(nr_prescricao_p) = 'S')) and
			((ie_restrito_p = 'N') or (obter_se_possui_medic_restrito(nr_prescricao_p) = 'S')) and	
			((ie_nao_padronizado_p = 'N') or (coalesce(obter_se_medic_padronizado(nr_prescricao_p),'S') = 'N')) and
			(((coalesce(cd_grupo_material_p::text, '') = '') and (coalesce(cd_subgrupo_material_p::text, '') = '') and (coalesce(cd_classe_material_p::text, '') = '')) or (coalesce(obter_se_mat_estrutura(cd_grupo_material_p, cd_subgrupo_material_p, cd_classe_material_p, nr_prescricao_p),'S') = 'S')) and
			((coalesce(ie_param_62_p,'N') <> 'S') or 
				(((ie_liberacao_enf_p = 2) or		-- Pending nursing submission
					((ie_liberacao_enf_p = 1) and (obter_se_prescr_lib_hor_gpt(nr_prescricao_p) = 'N')) or
					((ie_liberacao_enf_p = 0) and (obter_se_prescr_lib_hor_gpt(nr_prescricao_p) = 'S'))) and
				((ie_liberacao_farm_p  = 2) or		-- Pending pharmacy submission
					((ie_liberacao_farm_p = 1) and (obter_se_prescr_lib_hor_gpt(nr_prescricao_p) = 'N')) or
					((ie_liberacao_farm_p = 0) and (obter_se_prescr_lib_hor_gpt(nr_prescricao_p) = 'S')))))  then
					
			ie_exibe_w := 'S';
			
		end if;		
	end if;

	return	ie_exibe_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_se_exibe_prescr_gpt (ie_tipo_gpt_p text, nr_prescricao_p bigint, cd_estabelecimento_p bigint, ie_motivo_prescricao_p text, ie_liberacao_enf_p bigint, ie_liberacao_farm_p bigint, ie_status_farm_p text, nr_seq_classif_transcr_p bigint, ie_intervencao_farm_p text, cd_grupo_material_p bigint, cd_subgrupo_material_p bigint, cd_classe_material_p bigint, cd_material_p bigint, ie_nao_padronizado_p text, ie_quimio_p text, ie_alto_risco_p text, ie_medic_alto_custo_p text, ie_medic_paciente_p text, ie_dispensacao_p bigint, ie_tipo_item_p bigint, ie_prescritor_p bigint, ie_urgencia_p bigint, cd_intervalo_p text, qt_minutos_agora_p bigint, ie_restrito_p text, ie_item_farm_nao_atend_p text, ie_itens_p bigint, ie_status_enf_p text, ie_sem_atendimento_p text, ie_alta_vigilancia_p text, ie_lib_farm_p text, ie_param_62_p text, ie_antibiotico_p text, ds_motivos_p text default null, ds_matmeds_p text default null) FROM PUBLIC;

