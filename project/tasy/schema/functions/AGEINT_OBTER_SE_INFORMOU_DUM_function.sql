-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION ageint_obter_se_informou_dum (NR_SEQ_AGEINT_P bigint, NR_SEQ_PROC_INTERNO_P bigint, CD_ESTABELECIMENTO_P bigint, NM_USUARIO_P text) RETURNS varchar AS $body$
DECLARE


IE_OBRIGA_DUM_AGEINT_W PROC_INTERNO.IE_OBRIGA_DUM_AGEINT%type;
NR_SEQ_AGEINT_W             AGENDA_INTEGRADA.NR_SEQUENCIA%type;
QT_REGISTROS_W              integer;
DT_ULTIMA_MENSTRUACAO_W     AGENDA_INTEGRADA.DT_ULTIMA_MENSTRUACAO%type;
QT_IG_SEMANA_W              AGENDA_INTEGRADA.QT_IG_SEMANA%type;
QT_IG_DIA_W                 AGENDA_INTEGRADA.QT_IG_DIA%type;
DS_RETORNO_W                varchar(1);


BEGIN

    if (NR_SEQ_PROC_INTERNO_P IS NOT NULL AND NR_SEQ_PROC_INTERNO_P::text <> '') then
        SELECT  coalesce(IE_OBRIGA_DUM_AGEINT, 'N')
        INTO STRICT    IE_OBRIGA_DUM_AGEINT_W
        FROM    PROC_INTERNO
        WHERE   NR_SEQUENCIA = NR_SEQ_PROC_INTERNO_P;

    else
		SELECT  COUNT(*)
		INTO STRICT    QT_REGISTROS_W
		FROM    PROC_INTERNO a,
						AGENDA_INTEGRADA_ITEM b
		WHERE   a.NR_SEQUENCIA = b.NR_SEQ_PROC_INTERNO
		AND     (b.NR_SEQ_PROC_INTERNO IS NOT NULL AND b.NR_SEQ_PROC_INTERNO::text <> '')
		AND     b.NR_SEQ_AGENDA_INT = NR_SEQ_AGEINT_P
		AND     a.IE_OBRIGA_DUM_AGEINT = 'S';

        if (QT_REGISTROS_W > 0) THEN
            IE_OBRIGA_DUM_AGEINT_W := 'S';
		end if;
    end if;

    if (IE_OBRIGA_DUM_AGEINT_W = 'S') then

        select  max(DT_ULTIMA_MENSTRUACAO),
                max(QT_IG_SEMANA),
                max(QT_IG_DIA)
        into STRICT    DT_ULTIMA_MENSTRUACAO_W,
                QT_IG_SEMANA_W,
                QT_IG_DIA_W
        from    AGENDA_INTEGRADA
        where   NR_SEQUENCIA = NR_SEQ_AGEINT_P;

        if ((DT_ULTIMA_MENSTRUACAO_W IS NOT NULL AND DT_ULTIMA_MENSTRUACAO_W::text <> '')
        or (QT_IG_SEMANA_W IS NOT NULL AND QT_IG_SEMANA_W::text <> '')
        or (QT_IG_DIA_W IS NOT NULL AND QT_IG_DIA_W::text <> '')) then
            DS_RETORNO_W := 'S';
        else
            DS_RETORNO_W := 'N';
        end if;
    else
        DS_RETORNO_W := 'S';
    end if;

 return DS_RETORNO_W;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION ageint_obter_se_informou_dum (NR_SEQ_AGEINT_P bigint, NR_SEQ_PROC_INTERNO_P bigint, CD_ESTABELECIMENTO_P bigint, NM_USUARIO_P text) FROM PUBLIC;

