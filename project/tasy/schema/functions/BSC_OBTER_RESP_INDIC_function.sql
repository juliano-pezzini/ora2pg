-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION bsc_obter_resp_indic ( nr_seq_indicador_p bigint, dt_referencia_p timestamp, ie_opcao_p text) RETURNS varchar AS $body$
DECLARE

 
cd_pessoa_responsavel_w		varchar(10);
ds_retorno_w			varchar(255);
dt_referencia_w			timestamp;
nm_pessoa_responsavel_w		varchar(255);

 
/* Opção 
N -		Nome do responsável pelo indicador 
T -		Nome de todos os responsaveis pelo indicador separados por (,) vírgula. 
Outras opções -	Código da Pessoa física responsável pelo indicador. 
*/
 
 
c01 CURSOR FOR 
SELECT	cd_pessoa_fisica 
from	bsc_ind_resp 
where	nr_seq_indicador	= nr_seq_indicador_p 
and	((dt_inicio_vigencia <= dt_referencia_w ) and (coalesce(dt_fim_vigencia,dt_referencia_w) >= dt_referencia_w)) 
order by dt_inicio_vigencia;


BEGIN 
 
dt_referencia_w	:= trunc(coalesce(dt_referencia_p,clock_timestamp()),'dd');
open C01;
loop 
fetch C01 into	 
	cd_pessoa_responsavel_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin 
	 
	cd_pessoa_responsavel_w		:= cd_pessoa_responsavel_w;
	 
	if (length(nm_pessoa_responsavel_w ||', ' || obter_nome_pf(cd_pessoa_responsavel_w)) <= 255) then 
		 
		nm_pessoa_responsavel_w	:= substr(nm_pessoa_responsavel_w || obter_nome_pf(cd_pessoa_responsavel_w)||', ',1,255);
	end if;	
	end;
end loop;
close C01;
 
if (ie_opcao_p = 'N') then 
	 
	ds_retorno_w	:= substr(obter_nome_pf(cd_pessoa_responsavel_w),1,60);
elsif (ie_opcao_p = 'T') then 
	 
	ds_retorno_w	:= substr(nm_pessoa_responsavel_w, 1, length(nm_pessoa_responsavel_w)-2);
else 
	ds_retorno_w	:= cd_pessoa_responsavel_w;
end if;
 
return	ds_retorno_w;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION bsc_obter_resp_indic ( nr_seq_indicador_p bigint, dt_referencia_p timestamp, ie_opcao_p text) FROM PUBLIC;

