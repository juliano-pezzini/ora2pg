-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_seq_area_imagem_dente (nr_sequencia_p bigint) RETURNS varchar AS $body$
DECLARE

				
ds_areas_dente_w        varchar(2000);
IE_FACE_INCISAL_W       varchar(2);
IE_FACE_DISTAL_w        varchar(2);
IE_FACE_LINGUAL_w       varchar(2);
IE_FACE_MESIAL_w        varchar(2);
IE_FACE_OCLUSAL_w       varchar(2);
IE_FACE_PALATINA_w      varchar(2);
IE_FACE_VESTIBULAR_w    varchar(2);
nr_seq_dente_w          odont_historico.nr_seq_dente%type;
nr_seq_consulta_w       odont_consulta.nr_sequencia%type;


C01 CURSOR FOR
	SELECT 	a.nr_seq_dente,
		b.ie_face_distal,
		b.ie_face_incisal,
		b.ie_face_lingual,
		b.ie_face_mesial,
		b.ie_face_oclusal,
		b.ie_face_palatina,
		b.ie_face_vestibular,
		a.nr_seq_consulta
	from	odont_historico a,
		odont_historico_proced b
	where	a.nr_Sequencia = b.NR_SEQ_ODONT_HIST
	and	a.nr_sequencia = nr_sequencia_p;

c02 CURSOR FOR
	SELECT 	nr_seq_area
	from  	area_imagem_item a,
		area_imagem b,
		imagem_banco c,
		odont_consulta d
	where 	a.nr_seq_area = b.nr_sequencia
	and   	b.nr_seq_img = c.nr_sequencia
	and   	d.nr_seq_img = c.nr_sequencia
	and   	d.nr_sequencia = nr_seq_consulta_w
	and   	a.nr_seq_dente = nr_seq_dente_w
	and 	((IE_FACE_INCISAL_W = 'S' and a.nr_seq_face = 'I')
		or (IE_FACE_DISTAL_w = 'S'  and a.nr_seq_face = 'D')
		or (IE_FACE_LINGUAL_w = 'S' and a.nr_seq_face = 'L')
		or (IE_FACE_MESIAL_w = 'S' and a.nr_seq_face = 'M')
		or (IE_FACE_OCLUSAL_w = 'S' and a.nr_seq_face = 'O')
		or (IE_FACE_PALATINA_w = 'S' and a.nr_seq_face = 'P')
		or (IE_FACE_VESTIBULAR_w = 'S' and a.nr_seq_face = 'V'));
BEGIN

	for	c_01_w	in C01 loop
		IE_FACE_INCISAL_W := c_01_w.IE_FACE_INCISAL;
		IE_FACE_DISTAL_w := c_01_w.IE_FACE_DISTAL;
		IE_FACE_LINGUAL_w := c_01_w.IE_FACE_LINGUAL;
		IE_FACE_MESIAL_w := c_01_w.IE_FACE_MESIAL;
		IE_FACE_OCLUSAL_w := c_01_w.IE_FACE_OCLUSAL;
		IE_FACE_PALATINA_w := c_01_w.IE_FACE_PALATINA;
		IE_FACE_VESTIBULAR_w := c_01_w.IE_FACE_VESTIBULAR;
		nr_seq_dente_w  := c_01_w.nr_seq_dente;
		nr_seq_consulta_w := c_01_w.nr_seq_consulta;

		for c_c02_w in c02 loop
		    if (ds_areas_dente_w IS NOT NULL AND ds_areas_dente_w::text <> '') then
			ds_areas_dente_w := ds_areas_dente_w ||','||c_c02_w.nr_seq_area;
		    else
			ds_areas_dente_w := c_C02_w.nr_seq_area;
		    end if;

		end loop;
	end loop;
	
	if ( coalesce(ds_areas_dente_w::text, '') = '' ) then
		select	max(a.nr_seq_area)
			into STRICT ds_areas_dente_w
		from	area_imagem_item a,
			area_imagem b,
			imagem_banco c,
			odont_consulta d,
			odont_historico e
		where 	a.nr_seq_area = b.nr_sequencia
		and   	b.nr_seq_img = c.nr_sequencia
		and   	d.nr_seq_img = c.nr_sequencia
		and     e.nr_sequencia = nr_sequencia_p
		and   	d.nr_sequencia = e.nr_seq_consulta
		and   	a.nr_seq_dente = e.nr_seq_dente;
	end if;

return ds_areas_dente_w;			

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_seq_area_imagem_dente (nr_sequencia_p bigint) FROM PUBLIC;

