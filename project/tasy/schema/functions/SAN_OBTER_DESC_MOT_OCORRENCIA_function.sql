-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION san_obter_desc_mot_ocorrencia ( nr_seq_reserva_p bigint, nr_seq_transfusao_p bigint, ie_tipo_p text) RETURNS varchar AS $body$
DECLARE


ds_cor_w			varchar(100);
ds_tipo_ocorrencia_w	varchar(255);
ds_retorno_w		varchar(100);
nr_sequencia_w		bigint;


C01 CURSOR FOR
SELECT	b.ds_cor,
	SUBSTR(b.ie_prioridade || ' - '  ||b.ds_tipo_ocorrencia,1,255),
	 b.nr_sequencia
FROM 	san_ocorrencia_doador c,
	san_tipo_ocorrencia b
WHERE	c.nr_seq_tipo_ocoreencia = b.nr_sequencia
AND	((c.nr_seq_reserva = nr_seq_reserva_p and
	 not exists (  SELECT 1
		       from san_ocorrencia_doador x
		       where x.nr_seq_transfusao =  nr_seq_transfusao_p)) OR (c.nr_seq_transfusao = nr_seq_transfusao_p))
ORDER BY b.ie_prioridade DESC;


BEGIN

OPEN C01;
LOOP
FETCH C01 INTO
	ds_cor_w,
	ds_tipo_ocorrencia_w,
	nr_sequencia_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	IF (ie_tipo_p = 'C') THEN
		ds_retorno_w := ds_cor_w;
	ELSIF (ie_tipo_p = 'D') THEN
		ds_retorno_w := ds_tipo_ocorrencia_w;
	ELSIF (ie_tipo_p = 'SEQ') THEN
		ds_retorno_w := nr_sequencia_w;
	ELSE
		ds_retorno_w := '';
	END IF;

END LOOP;

RETURN	ds_retorno_w;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION san_obter_desc_mot_ocorrencia ( nr_seq_reserva_p bigint, nr_seq_transfusao_p bigint, ie_tipo_p text) FROM PUBLIC;

