-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_se_nao_pbs ( cd_material_p PRESCR_MATERIAL.CD_MATERIAL%type, nr_prescricao_p PRESCR_MATERIAL.NR_PRESCRICAO%type, nr_cirurgia_p CIRURGIA.NR_CIRURGIA%type, ie_tab_p text ) RETURNS varchar AS $body$
DECLARE


cd_convenio_w           ATEND_CATEGORIA_CONVENIO.CD_CONVENIO%type;
cd_plano_convenio_w     ATEND_CATEGORIA_CONVENIO.CD_PLANO_CONVENIO%type;
ie_nopbs_w              MATERIAL.IE_NOPBS%type;
ie_eps_w                CONVENIO_PLANO.IE_EPS%type;


BEGIN

--pega o codigo do conveio e do plano registrados no atendimento
IF ie_tab_p = 'P' THEN
    SELECT  MAX(c.CD_CONVENIO),
            MAX(c.CD_PLANO_CONVENIO)
    INTO STRICT    cd_convenio_w,
            cd_plano_convenio_w
    FROM    PRESCR_MATERIAL a,
            CIRURGIA b,
            ATEND_CATEGORIA_CONVENIO c
    WHERE   a.NR_PRESCRICAO = b.NR_PRESCRICAO
    AND     b.NR_ATENDIMENTO = c.NR_ATENDIMENTO
    AND     a.CD_MATERIAL = cd_material_p
    AND     a.NR_PRESCRICAO = nr_prescricao_p;
ELSIF ie_tab_p = 'E' THEN
    SELECT  MAX(d.CD_CONVENIO),
            MAX(d.CD_PLANO_CONVENIO)
    INTO STRICT    cd_convenio_w,
            cd_plano_convenio_w
    FROM    PRESCR_MATERIAL a,
            PRESCR_MEDICA b,
            CIRURGIA c,
            ATEND_CATEGORIA_CONVENIO d
    WHERE   a.NR_PRESCRICAO = b.NR_PRESCRICAO
    AND     b.NR_CIRURGIA = c.NR_CIRURGIA
    AND     c.NR_ATENDIMENTO = d.NR_ATENDIMENTO
    AND     a.CD_MATERIAL = cd_material_p
    AND     a.NR_PRESCRICAO = nr_prescricao_p;
ELSIF ie_tab_p = 'D' THEN
    SELECT  MAX(c.CD_CONVENIO),
            MAX(c.CD_PLANO_CONVENIO)
    INTO STRICT    cd_convenio_w,
            cd_plano_convenio_w
    FROM    PRESCR_MATERIAL_DEVOLUCAO a,
            CIRURGIA b,
            ATEND_CATEGORIA_CONVENIO c
    WHERE   a.NR_PRESCRICAO = b.NR_PRESCRICAO
    AND     b.NR_ATENDIMENTO = c.NR_ATENDIMENTO
    AND     a.NR_PRESCRICAO = nr_prescricao_p;
ELSIF  ie_tab_p IN ('U', 'A', 'L') THEN
    SELECT  MAX(b.CD_CONVENIO),
            MAX(b.CD_PLANO_CONVENIO)
    INTO STRICT    cd_convenio_w,
            cd_plano_convenio_w
    FROM    CIRURGIA a,
            ATEND_CATEGORIA_CONVENIO b
    WHERE   a.nr_atendimento = b.nr_atendimento
    AND     a.NR_CIRURGIA = nr_cirurgia_p;
END IF;

--pega o ie_nopbs com base no material
SELECT  coalesce(MAX(a.IE_NOPBS), 'N')
INTO STRICT    ie_nopbs_w
FROM    MATERIAL a
WHERE   a.CD_MATERIAL = cd_material_p;
--pega o ie_eps com base no codigo do plano e convenio do atendimento
SELECT  coalesce(MAX(a.IE_EPS), 'N')
INTO STRICT    ie_eps_w
FROM    CONVENIO_PLANO a
WHERE   a.CD_CONVENIO = cd_convenio_w
AND     a.CD_PLANO = cd_plano_convenio_w;

RETURN  CASE WHEN ie_nopbs_w = 'S' AND ie_eps_w = 'S' THEN 'S' ELSE 'N' END;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_se_nao_pbs ( cd_material_p PRESCR_MATERIAL.CD_MATERIAL%type, nr_prescricao_p PRESCR_MATERIAL.NR_PRESCRICAO%type, nr_cirurgia_p CIRURGIA.NR_CIRURGIA%type, ie_tab_p text ) FROM PUBLIC;

