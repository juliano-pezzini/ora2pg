-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';



--
-- dblink wrapper to call function cpoe_obter_se_item_vigente as an autonomous transaction
--
CREATE EXTENSION IF NOT EXISTS dblink;

CREATE OR REPLACE FUNCTION cpoe_obter_se_item_vigente ( nm_usuario_p text, cd_perfil_p bigint, cd_setor_atendimento_p bigint, nr_seq_item_novo_p bigint, dt_inicio_p timestamp, hr_prim_horario_p text, dt_fim_p timestamp, cd_pessoa_fisica_p text, nr_atendimento_p bigint, cd_item_p bigint default null, nm_tabela_p text default null, ie_hemodialise_p text default null, nr_seq_derivado_p bigint default null, cd_procedimento_p bigint default null) RETURNS varchar AS $body$
DECLARE
	-- Change this to reflect the dblink connection string
	v_conn_str  text := format('port=%s dbname=%s user=%s', current_setting('port'), current_database(), current_user);
	v_query     text;

	v_ret	varchar;
BEGIN
	v_query := 'SELECT * FROM cpoe_obter_se_item_vigente_atx ( ' || quote_nullable(nm_usuario_p) || ',' || quote_nullable(cd_perfil_p) || ',' || quote_nullable(cd_setor_atendimento_p) || ',' || quote_nullable(nr_seq_item_novo_p) || ',' || quote_nullable(dt_inicio_p) || ',' || quote_nullable(hr_prim_horario_p) || ',' || quote_nullable(dt_fim_p) || ',' || quote_nullable(cd_pessoa_fisica_p) || ',' || quote_nullable(nr_atendimento_p) || ',' || quote_nullable(cd_item_p) || ',' || quote_nullable(nm_tabela_p) || ',' || quote_nullable(ie_hemodialise_p) || ',' || quote_nullable(nr_seq_derivado_p) || ',' || quote_nullable(cd_procedimento_p) || ' )';
	SELECT * INTO v_ret FROM dblink(v_conn_str, v_query) AS p (ret varchar);
	RETURN v_ret;

END;
$body$ LANGUAGE plpgsql SECURITY DEFINER;




CREATE OR REPLACE FUNCTION cpoe_obter_se_item_vigente_atx ( nm_usuario_p text, cd_perfil_p bigint, cd_setor_atendimento_p bigint, nr_seq_item_novo_p bigint, dt_inicio_p timestamp, hr_prim_horario_p text, dt_fim_p timestamp, cd_pessoa_fisica_p text, nr_atendimento_p bigint, cd_item_p bigint default null, nm_tabela_p text default null, ie_hemodialise_p text default null, nr_seq_derivado_p bigint default null, cd_procedimento_p bigint default null) RETURNS varchar AS $body$
DECLARE
add_restricao_w			varchar(255):='';
nm_tabela_w				varchar(50);
ie_duplicado_w			varchar(5):='N';
ie_tipo_item_w			varchar(10);
ie_material_w			varchar(1):='N';
ie_continuo_w			varchar(1):='N';
hr_prim_horario_w		varchar(5);
nm_chave_item_cpoe_w	varchar(50);
dt_inicio_w				timestamp;
dt_fim_w				timestamp;

/*
	Restrições que se caracterizam um item vigente na cpoe
1º Restrição: Data de inicio do item anterior já prescrito, está dentro da data de inicio e fim do novo item
2º Restrição: Data de fim do item anterior já prescrito, está dentro da data de inicio e fim do novo item
3º Restrição: Data de fim do item anterior já prescrito é nula, e a data incio é menor que data de inicio do novo item
4º Restrição: Data de fim do item anterior já prescrito, é maior que a data fim do novo item e data de inicio do item
			 já prescrito for menor que do novo item.
5 Restrição: Data de inicio do item já prescrito é maior que a data de inicio do novo item e o novo item é mantido até segunda ordem
			ou se a data de fim do novo item for maior que da data de inicio do item já prescrito.
*/
procedure setDtFim(dt_inicio_aux_p 		 timestamp,
				   hr_prim_horario_aux_p text := null) is
;
BEGIN

	if (hr_prim_horario_aux_p IS NOT NULL AND hr_prim_horario_aux_p::text <> '') then

		if (coalesce(dt_fim_p::text, '') = '') then
			ie_continuo_w 	:= 'S';
			dt_fim_w 		:= to_date(to_char(dt_inicio_aux_p,'dd/mm/yyyy') || ' ' || hr_prim_horario_aux_p,'dd/mm/yyyy hh24:mi:ss') + 1;
		else
			dt_fim_w 		:= dt_fim_p;
		end if;

	else
		if (coalesce(dt_fim_p::text, '') = '') then
			ie_continuo_w 	:= 'S';
			dt_fim_w 		:= dt_inicio_w + 1;
		else
			dt_fim_w 		:= dt_fim_p;
		end if;
	end if;
end;

function getIeDuplicado return varchar2 is
	ds_sql_w		varchar2(4000);
	ds_sql_add_w	varchar2(4000):='';
begin
	ie_duplicado_w := 'N';
	begin
		if (((upper(nm_tabela_w) <> 'CPOE_HEMOTERAPIA') and (upper(nm_tabela_w) <> 'CPOE_DIALISE')) and (coalesce(cd_item_p,0) > 0)) then
			ds_sql_add_w := ' and '||nm_chave_item_cpoe_w||'  =  '||cd_item_p||
							' and ((to_date(to_char(nvl(dt_inicio, sysdate),''dd/mm/yyyy'') || '' '' || nvl(hr_prim_horario,''00:00''),''dd/mm/yyyy hh24:mi:ss'') between to_date('''||to_char(dt_inicio_w,'dd/mm/yyyy hh24:mi:ss')||''',''dd/mm/yyyy hh24:mi:ss'') and to_date('''||to_char(dt_fim_w,'dd/mm/yyyy hh24:mi:ss')||''',''dd/mm/yyyy hh24:mi:ss'')) or 	'||
							'  	   (dt_fim between to_date('''||to_char(dt_inicio_w,'dd/mm/yyyy hh24:mi:ss')||''',''dd/mm/yyyy hh24:mi:ss'') and to_date('''||to_char(dt_fim_w,'dd/mm/yyyy hh24:mi:ss')||''',''dd/mm/yyyy hh24:mi:ss'')) or 																											'||
							' 	   (dt_fim is null and to_date(to_char(nvl(dt_inicio, sysdate),''dd/mm/yyyy'')|| '' '' || nvl(hr_prim_horario,''00:00''),''dd/mm/yyyy hh24:mi:ss'') < to_date('''||to_char(dt_inicio_w,'dd/mm/yyyy hh24:mi:ss')||''',''dd/mm/yyyy hh24:mi:ss'')) or 																					'||
							'	   (dt_fim > to_date('''||to_char(dt_fim_w,'dd/mm/yyyy hh24:mi:ss')||''',''dd/mm/yyyy hh24:mi:ss'') and to_date(to_char(nvl(dt_inicio, sysdate),''dd/mm/yyyy'')|| '' '' || nvl(hr_prim_horario,''00:00''),''dd/mm/yyyy hh24:mi:ss'') < to_date('''||to_char(dt_inicio_w,'dd/mm/yyyy hh24:mi:ss')||''',''dd/mm/yyyy hh24:mi:ss'')) or 	'||
							'	   (((to_date(to_char(nvl(dt_inicio, sysdate),''dd/mm/yyyy'')|| '' '' || nvl(hr_prim_horario,''00:00''),''dd/mm/yyyy hh24:mi:ss'') >  to_date('''||to_char(dt_inicio_w,'dd/mm/yyyy hh24:mi:ss')||''',''dd/mm/yyyy hh24:mi:ss'')) and (nvl('''||ie_continuo_w||''',''N'') = ''S'')) or ((nvl('''||ie_continuo_w||''',''N'') = ''N'') and (to_date('''||to_char(dt_inicio_w,'dd/mm/yyyy hh24:mi:ss')||''',''dd/mm/yyyy hh24:mi:ss'') <= to_date(to_char(nvl(dt_inicio, sysdate),''dd/mm/yyyy'')|| '' '' || nvl(hr_prim_horario,''00:00''),''dd/mm/yyyy hh24:mi:ss'')) and to_date('''||to_char(dt_fim_w,'dd/mm/yyyy hh24:mi:ss')||''',''dd/mm/yyyy hh24:mi:ss'') > to_date(to_char(nvl(dt_inicio, sysdate),''dd/mm/yyyy'')|| '' '' || nvl(hr_prim_horario,''00:00''),''dd/mm/yyyy hh24:mi:ss''))) or '||
							'	   (ie_retrogrado = ''S'' and dt_liberacao is null))';

		elsif (upper(nm_tabela_w) = 'CPOE_HEMOTERAPIA') or (upper(nm_tabela_w) = 'CPOE_DIALISE') then

			ds_sql_add_w := ' and ((dt_inicio between to_date('''||to_char(dt_inicio_w,'dd/mm/yyyy hh24:mi:ss')||''',''dd/mm/yyyy hh24:mi:ss'') and to_date('''||to_char(dt_fim_w,'dd/mm/yyyy hh24:mi:ss')||''',''dd/mm/yyyy hh24:mi:ss'')) or 	'||
								'  	   (dt_fim between to_date('''||to_char(dt_inicio_w,'dd/mm/yyyy hh24:mi:ss')||''',''dd/mm/yyyy hh24:mi:ss'') and to_date('''||to_char(dt_fim_w,'dd/mm/yyyy hh24:mi:ss')||''',''dd/mm/yyyy hh24:mi:ss'')) or 																											'||
								' 	   (dt_fim is null and dt_inicio < to_date('''||to_char(dt_inicio_w,'dd/mm/yyyy hh24:mi:ss')||''',''dd/mm/yyyy hh24:mi:ss'')) or 																					'||
								'	   (dt_fim > to_date('''||to_char(dt_fim_w,'dd/mm/yyyy hh24:mi:ss')||''',''dd/mm/yyyy hh24:mi:ss'') and dt_inicio < to_date('''||to_char(dt_inicio_w,'dd/mm/yyyy hh24:mi:ss')||''',''dd/mm/yyyy hh24:mi:ss'')) or 	'||
								'	   (((dt_inicio >  to_date('''||to_char(dt_inicio_w,'dd/mm/yyyy hh24:mi:ss')||''',''dd/mm/yyyy hh24:mi:ss'')) and (nvl('''||ie_continuo_w||''',''N'') = ''S'')) or ((nvl('''||ie_continuo_w||''',''N'') = ''N'') and (to_date('''||to_char(dt_inicio_w,'dd/mm/yyyy hh24:mi:ss')||''',''dd/mm/yyyy hh24:mi:ss'') <= dt_inicio) and to_date('''||to_char(dt_fim_w,'dd/mm/yyyy hh24:mi:ss')||''',''dd/mm/yyyy hh24:mi:ss'') > dt_inicio)) or '||
								'	   (ie_retrogrado = ''S'' and dt_liberacao is null))';
		end if;

		ds_sql_w :=
			' select	decode(count(*), 0, ''N'', ''S'')'||
			' from '||nm_tabela_w||
			' where	nr_sequencia <> '||nr_seq_item_novo_p ||
			' and obter_se_cpoe_regra_duplic('||ie_tipo_item_w||','||cd_perfil_p||','||cd_setor_atendimento_p||') = ''S'' 						'||
			' and ((nr_atendimento = '||nr_atendimento_p||') or (cd_pessoa_fisica = '''|| cd_pessoa_fisica_p ||''' and nr_atendimento is null)) 	'||
			' and (((dt_lib_suspensao is not null) and (dt_suspensao > sysdate)) or (dt_lib_suspensao is null)) 									'||
			' and ((dt_liberacao is not null) or (nm_usuario =  '''||nm_usuario_p||''')) 															'||
			ds_sql_add_w ||
			add_restricao_w;

		if ((coalesce(cd_item_p,0) > 0) or
		   ((upper(nm_tabela_w) = 'CPOE_HEMOTERAPIA') or (upper(nm_tabela_w) = 'CPOE_DIALISE'))) then
		   RAISE NOTICE '%', ds_sql_w; --Ajudar a ver o que está sendo executado. No sqlPlus, necessário comando  SET SERVEROUTPUT ON; para habilitar console.
			EXECUTE ds_sql_w
			into STRICT	ie_duplicado_w;
		end if;

	exception when others then
		CALL gravar_log_tasy(10007, 'erro  cpoe_obter_se_item_vigente: ' || substr(dbms_utility.format_call_stack,1,2000) || ' sql : ' || ds_sql_w, nm_usuario_p);
		return 'S';
	end;

	return coalesce(ie_duplicado_w,'N');
end;

begin
if (nm_tabela_p IS NOT NULL AND nm_tabela_p::text <> '') then

	nm_tabela_w			:=	nm_tabela_p;
	hr_prim_horario_w 	:= coalesce(hr_prim_horario_p,'00:00'); --Se tiver mais de 5 caracters, ta errado o primeiro horário e não a rotina
	dt_inicio_w 		:= to_date(to_char(coalesce(dt_inicio_p,clock_timestamp()),'dd/mm/yyyy')|| ' ' ||hr_prim_horario_w,'dd/mm/yyyy hh24:mi:ss');

	setDtFim(dt_inicio_w,hr_prim_horario_w);

	if (upper(nm_tabela_w) = 'CPOE_PROCEDIMENTO') then
		nm_chave_item_cpoe_w := 'nr_seq_proc_interno';
		ie_tipo_item_w		 := '''P''';

	elsif (upper(nm_tabela_w) = 'CPOE_RECOMENDACAO') then
		nm_chave_item_cpoe_w := 'cd_recomendacao';
		ie_tipo_item_w		 := '''R''';

	elsif (upper(nm_tabela_w) = 'CPOE_GASOTERAPIA') then
		nm_chave_item_cpoe_w := 'nr_seq_gas';
		ie_tipo_item_w		 := '''G''';

	elsif (upper(nm_tabela_w) in ('CPOE_MATERIAL_MAT','CPOE_MATERIAL')) then

		if (upper(nm_tabela_w) = 'CPOE_MATERIAL_MAT') then
			add_restricao_w	 	 := ' and nvl(ie_material,''N'') = ''S''';

		elsif (upper(nm_tabela_w) = 'CPOE_MATERIAL') then
			add_restricao_w	 	 := ' and nvl(ie_material,''N'') = ''N''';
		end if;

		nm_tabela_w			 := 'CPOE_MATERIAL';
		nm_chave_item_cpoe_w := 'cd_material';
		ie_tipo_item_w		 := '''M''';

	elsif (upper(nm_tabela_w) in ('CPOE_DIETA_ENT','CPOE_DIETA_LEITE','CPOE_DIETA_ORAL','CPOE_DIETA_SUP','CPOE_DIETA_JEJUM')) then

		if (upper(nm_tabela_w) = 'CPOE_DIETA_ENT') then
			add_restricao_w	 	 := ' and ie_tipo_dieta = ''E''';
			nm_chave_item_cpoe_w := 'cd_material';
			ie_tipo_item_w		 := '''E''';

		elsif (upper(nm_tabela_w) = 'CPOE_DIETA_LEITE') then
			add_restricao_w	 	 := ' and ie_tipo_dieta = ''L''';
			nm_chave_item_cpoe_w := 'cd_mat_prod1';
			ie_tipo_item_w		 := '''L''';

		elsif (upper(nm_tabela_w) = 'CPOE_DIETA_ORAL') then
			add_restricao_w	 	 := ' and ie_tipo_dieta = ''O''';
			nm_chave_item_cpoe_w := 'cd_dieta';
			ie_tipo_item_w		 := '''O''';

		elsif (upper(nm_tabela_w) = 'CPOE_DIETA_SUP') then
			add_restricao_w	 	 := ' and ie_tipo_dieta = ''S''';
			nm_chave_item_cpoe_w := 'cd_material';
			ie_tipo_item_w		 := '''S''';

		elsif (upper(nm_tabela_w) = 'CPOE_DIETA_JEJUM') then
			add_restricao_w	 	 := ' and ie_tipo_dieta = ''J''';
			nm_chave_item_cpoe_w := 'nr_seq_tipo';
			ie_tipo_item_w		 := '''J''';
			dt_inicio_w			 := dt_inicio_p;
			setDtFim(dt_inicio_w);
		end if;

		nm_tabela_w := 'CPOE_DIETA';

	elsif (upper(nm_tabela_w) in ('CPOE_DIALISE','CPOE_PERITONEAL')) then

		if (upper(nm_tabela_w) = 'CPOE_DIALISE') then
			add_restricao_w	 	 := ' and ie_tipo_dialise = ''DI'' and ie_hemodialise = '''||ie_hemodialise_p||'''';
			ie_tipo_item_w		 := '''DI''';

		elsif (upper(nm_tabela_w) = 'CPOE_PERITONEAL') then
			add_restricao_w	 	 := ' and ie_tipo_dialise = ''DP''';
			nm_chave_item_cpoe_w := 'ie_hemodialise';
			ie_tipo_item_w		 := '''DP''';
		end if;

		dt_inicio_w			 := dt_inicio_p;
		setDtFim(dt_inicio_w);
		nm_tabela_w := 'CPOE_DIALISE';

	elsif (upper(nm_tabela_w) = 'CPOE_HEMOTERAPIA') then
		add_restricao_w		 :=	 ' and	(((ie_tipo_hemoterap = 0) and (nr_seq_derivado = '||coalesce(nr_seq_derivado_p,0)||'))  or ((ie_tipo_hemoterap = 1) and (cd_procedimento = '||coalesce(cd_procedimento_p,0)||'))) ';
		ie_tipo_item_w		 := '''HSC''';
		dt_inicio_w			 := coalesce(dt_inicio_p,clock_timestamp());
		setDtFim(dt_inicio_w);
	end if;

	return getIeDuplicado();

end if;

return	'N';

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION cpoe_obter_se_item_vigente ( nm_usuario_p text, cd_perfil_p bigint, cd_setor_atendimento_p bigint, nr_seq_item_novo_p bigint, dt_inicio_p timestamp, hr_prim_horario_p text, dt_fim_p timestamp, cd_pessoa_fisica_p text, nr_atendimento_p bigint, cd_item_p bigint default null, nm_tabela_p text default null, ie_hemodialise_p text default null, nr_seq_derivado_p bigint default null, cd_procedimento_p bigint default null) FROM PUBLIC; -- REVOKE ALL ON FUNCTION cpoe_obter_se_item_vigente_atx ( nm_usuario_p text, cd_perfil_p bigint, cd_setor_atendimento_p bigint, nr_seq_item_novo_p bigint, dt_inicio_p timestamp, hr_prim_horario_p text, dt_fim_p timestamp, cd_pessoa_fisica_p text, nr_atendimento_p bigint, cd_item_p bigint default null, nm_tabela_p text default null, ie_hemodialise_p text default null, nr_seq_derivado_p bigint default null, cd_procedimento_p bigint default null) FROM PUBLIC;

