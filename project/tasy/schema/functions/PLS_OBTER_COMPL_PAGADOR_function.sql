-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION pls_obter_compl_pagador ( nr_seq_pagador_p bigint, ie_opcao_p text) RETURNS varchar AS $body$
DECLARE


/*	ie_opcao_p
	T - Telefone
	EC	- Endereco completo (Numero + Complemento + Bairro + UF)
	ES - Endereco + numero + bairro + complemento
	EN - Endereco + numero + complemento
	E  - Endereco
	CI - Cidade
	UF - Estado
	CEP - Cep
	B - Bairro
	M - Email
	CO - Complemento
	NR - Numero
	FAX - N Fax
	CCE - Cep + Cidade + UF
	RAM - N ramal
	IBGE - Codigo municipio
	NPR - Nome pessoa contato
	EP - Endereco pagador (Completo para Correios)
	DTL - Descricao do tipo de logradouro
	DS_UF	- Nome do Estado
	TL - Tipo de logradouro
*/
ds_retorno_w			varchar(255);
ie_tipo_complemento_w		varchar(255);
nr_endereco_w			varchar(10)	:= '';
ds_email_w			varchar(255)	:= '';
nr_ramal_w			varchar(255);
nr_ramal_contato_w		varchar(255);
ds_endereco_w			varchar(100)	:= '';
ds_nome_w			varchar(80)	:= '';
ds_bairro_w			varchar(80)	:= '';
ds_municipio_w			varchar(80)	:= '';
ds_complemento_w		varchar(255)	:= '';
ds_fax_w			varchar(80);
nm_pessoa_contato_w		pessoa_juridica.nm_pessoa_contato%type;
nr_telefone_w			varchar(20)	:= '';
cd_cep_w			varchar(15)	:= '';
cd_cgc_pagador_w		varchar(14);
cd_pf_pagador_w			varchar(10);
nr_endereco_ww			varchar(15);
cd_municipio_ibge_w		varchar(6)	:= '';
ie_endereco_boleto_w		varchar(4);
sg_estado_w			compl_pessoa_fisica.sg_estado%type	:= '';
nr_seq_tipo_compl_adic_w	bigint;
ds_tipo_logradouro_w		sus_tipo_logradouro.ds_tipo_logradouro%type;
nr_seq_pessoa_endereco_w	pessoa_endereco.nr_sequencia%type;
ds_estado_w				varchar(255)	:= null;
cd_tipo_logradouro_w		varchar(3);


BEGIN
select	coalesce(cd_pessoa_fisica,'0'),
	coalesce(cd_cgc,'0'),
	ie_endereco_boleto,
	nr_seq_tipo_compl_adic
into STRICT	cd_pf_pagador_w,
	cd_cgc_pagador_w,
	ie_endereco_boleto_w,
	nr_seq_tipo_compl_adic_w
from	pls_contrato_pagador
where	nr_sequencia	= nr_seq_pagador_p;

if (coalesce(cd_pf_pagador_w,'0') <> '0') then
	select	CASE WHEN ie_endereco_boleto_w='PFR' THEN 1 WHEN ie_endereco_boleto_w='PFC' THEN 2 WHEN ie_endereco_boleto_w='PFA' THEN 9 WHEN ie_endereco_boleto_w='PFV' THEN 3 WHEN ie_endereco_boleto_w='PFP' THEN 4 WHEN ie_endereco_boleto_w='PFM' THEN 5 WHEN ie_endereco_boleto_w='PFJ' THEN 6  ELSE null END
	into STRICT	ie_tipo_complemento_w
	;
	
	select	max(c.nm_contato),
		max(c.nr_telefone),
		max(c.ds_endereco),
		max(c.nr_endereco),
		max(c.ds_bairro),
		max(c.ds_complemento),
		max(c.ds_municipio),
		max(c.sg_estado),
		max(c.cd_cep),
		max(c.ds_email),
		max(c.cd_municipio_ibge),
		max(c.nr_ramal),
		max(c.ds_fax),
		Sus_Obter_Desc_TipoLog(max(c.cd_tipo_logradouro)) ds_tipo_logradouro,
		max(nr_seq_pessoa_endereco),
		max(c.cd_tipo_logradouro)
	into STRICT	ds_nome_w,
		nr_telefone_w,
		ds_endereco_w,
		nr_endereco_w,
		ds_bairro_w,
		ds_complemento_w,
		ds_municipio_w,
		sg_estado_w,
		cd_cep_w,
		ds_email_w,
		cd_municipio_ibge_w,
		nr_ramal_w,
		ds_fax_w,
		ds_tipo_logradouro_w,
		nr_seq_pessoa_endereco_w,
		cd_tipo_logradouro_w
	from	compl_pessoa_fisica	c
	where	c.ie_tipo_complemento	= ie_tipo_complemento_w
	and	c.cd_pessoa_fisica	= cd_pf_pagador_w
	and	c.nr_sequencia		= (	SELECT	max(x.nr_sequencia)
						from	compl_pessoa_fisica x
						where	x.cd_pessoa_fisica      = cd_pf_pagador_w
						and	x.ie_tipo_complemento   = ie_tipo_complemento_w
						and	((x.nr_seq_tipo_compl_adic = nr_seq_tipo_compl_adic_w) or (coalesce(nr_seq_tipo_compl_adic_w::text, '') = '')));	
						
						
	if (address_pck.get_address_feature_enabled = 'S') and (nr_seq_pessoa_endereco_w IS NOT NULL AND nr_seq_pessoa_endereco_w::text <> '') then
			select	street,
					house_number,
					complement,
					neighborhood,
					city,
					stateName,
					postalCode,
					stateCode
			into STRICT	ds_endereco_w,
					nr_endereco_w,
					ds_complemento_w,
					ds_bairro_w,
					ds_municipio_w,
					ds_estado_w,
					cd_cep_w,
					sg_estado_w
			from	table(address_pck.get_address_fields(nr_seq_pessoa_endereco_w));
	end if;
	
	if (coalesce(nr_endereco_w::text, '') = '') then
		nr_endereco_ww  := ' ';
	else
		nr_endereco_ww  := ','|| to_char(nr_endereco_w) ||' ';
	end if;
	
	if (ie_opcao_p = 'NPR') then
		ds_retorno_w	:= ds_nome_w;
	elsif (ie_opcao_p = 'T') then
		ds_retorno_w	:= nr_telefone_w;
	elsif (ie_opcao_p = 'CI') then
		ds_retorno_w	:= ds_municipio_w;
	elsif (ie_opcao_p = 'UF') then
		ds_retorno_w	:= sg_estado_w;
	elsif (ie_opcao_p = 'CEP') then
		ds_retorno_w	:= cd_cep_w;
	elsif (ie_opcao_p = 'B') then
		ds_retorno_w	:= ds_bairro_w;
	elsif (ie_opcao_p = 'M') then
		ds_retorno_w	:= ds_email_w;
	elsif (ie_opcao_p = 'EN') then
		ds_retorno_w	:= ds_endereco_w || nr_endereco_ww || ds_complemento_w;
	elsif (ie_opcao_p = 'E') then
		ds_retorno_w	:= ds_endereco_w;
	elsif (ie_opcao_p = 'EC') then
		ds_retorno_w	:= ds_endereco_w || nr_endereco_ww || ds_complemento_w ||
									', ' || ds_bairro_w ||
									', ' || ds_municipio_w ||
									', ' || sg_estado_w;
	elsif (ie_opcao_p = 'ES') then
		ds_retorno_w	:= ds_endereco_w || nr_endereco_ww || ', ' || ds_bairro_w || ', ' || ds_complemento_w;
	elsif (ie_opcao_p = 'NR') then
		ds_retorno_w	:= to_char(nr_endereco_w);
	elsif (ie_opcao_p = 'CO') then
		ds_retorno_w	:= ds_complemento_w;
	elsif (ie_opcao_p = 'IBGE') then
		ds_retorno_w	:= cd_municipio_ibge_w;
	elsif (ie_opcao_p = 'CCE') then
		ds_retorno_w	:= cd_cep_w ||' - '||ds_municipio_w||' - '||sg_estado_w;
	elsif (ie_opcao_p = 'RAM') then
		ds_retorno_w	:= to_char(nr_ramal_w);
	elsif (ie_opcao_p = 'FAX') then
		ds_retorno_w	:= ds_fax_w;
	elsif (ie_opcao_p = 'DTL') then
		ds_retorno_w := ds_tipo_logradouro_w;
	elsif (ie_opcao_p = 'TL') then
		ds_retorno_w := cd_tipo_logradouro_w;
	end if;	
	
elsif (coalesce(cd_cgc_pagador_w,'0') <> '0') then
/*PJ		Cartao CNPJ (PJ)
PJF		Financeiro (PJ)
PJC		Correspondencia (PJ)*/
	
	select	CASE WHEN ie_endereco_boleto_w='PJC' THEN 1 WHEN ie_endereco_boleto_w='PJF' THEN 2 WHEN ie_endereco_boleto_w='PJ' THEN 3 END
	into STRICT	ie_tipo_complemento_w
	;
	
	if (ie_tipo_complemento_w <> 3) then	
		select	max(a.ds_endereco),
			max(a.nr_endereco),
			max(a.ds_complemento),
			max(a.ds_bairro),
			max(a.ds_municipio),
			max(a.sg_estado),
			max(a.cd_cep),
			max(a.nr_telefone),
			max(a.nr_fax),
			max(a.ds_email),
			max(a.nr_ramal_contato),
			max(a.nm_pessoa_contato),
			max(a.cd_municipio_ibge),
			max(a.nr_seq_pessoa_endereco),
			max(b.cd_tipo_logradouro)
		into STRICT	ds_endereco_w,
			nr_endereco_w,
			ds_complemento_w,
			ds_bairro_w,
			ds_municipio_w,
			sg_estado_w,
			cd_cep_w,
			nr_telefone_w,
			ds_fax_w,
			ds_email_w,
			nr_ramal_contato_w,
			nm_pessoa_contato_w,
			cd_municipio_ibge_w,
			nr_seq_pessoa_endereco_w,
			cd_tipo_logradouro_w
		FROM pessoa_juridica_compl a
LEFT OUTER JOIN cns_tipo_logradouro b ON (a.nr_seq_tipo_logradouro = b.nr_sequencia)
WHERE a.cd_cgc			= cd_cgc_pagador_w  and a.ie_tipo_complemento		= ie_tipo_complemento_w;
	elsif (ie_tipo_complemento_w = 3) then
		if (ie_opcao_p = 'M') then
			select	max(ds_email)
			into STRICT	ds_email_w
			from	pessoa_juridica_estab
			where	cd_cgc	= cd_cgc_pagador_w
			and	cd_estabelecimento	= wheb_usuario_pck.get_cd_estabelecimento;
		else		
			select	max(a.ds_endereco),
				max(a.nr_endereco),
				max(a.ds_complemento),
				max(a.ds_bairro),
				max(a.ds_municipio),
				max(a.sg_estado),
				max(a.cd_cep),
				max(a.nr_telefone),
				max(a.nr_fax),
				max(a.nr_ramal_contato),
				max(a.nm_pessoa_contato),
				max(a.cd_municipio_ibge),
				max(a.nr_seq_pessoa_endereco),
				max(b.cd_tipo_logradouro)
			into STRICT	ds_endereco_w,
				nr_endereco_w,
				ds_complemento_w,
				ds_bairro_w,
				ds_municipio_w,
				sg_estado_w,
				cd_cep_w,
				nr_telefone_w,
				ds_fax_w,
				nr_ramal_contato_w,
				nm_pessoa_contato_w,
				cd_municipio_ibge_w,
				nr_seq_pessoa_endereco_w,
				cd_tipo_logradouro_w
			FROM pessoa_juridica a
LEFT OUTER JOIN cns_tipo_logradouro b ON (a.nr_seq_tipo_logradouro = b.nr_sequencia)
WHERE a.cd_cgc			= cd_cgc_pagador_w;
		end if;
	end if;
	
	if (address_pck.get_address_feature_enabled = 'S') and (nr_seq_pessoa_endereco_w IS NOT NULL AND nr_seq_pessoa_endereco_w::text <> '') then
			select	street,
					house_number,
					complement,
					neighborhood,
					city,
					stateName,
					postalCode,
					stateCode
			into STRICT	ds_endereco_w,
					nr_endereco_w,
					ds_complemento_w,
					ds_bairro_w,
					ds_municipio_w,
					ds_estado_w,
					cd_cep_w,
					sg_estado_w
			from	table(address_pck.get_address_fields(nr_seq_pessoa_endereco_w));
	end if;
	
	if (ie_opcao_p = 'T') then
		ds_retorno_w	:= nr_telefone_w;
	elsif (ie_opcao_p = 'TL') then
		ds_retorno_w := cd_tipo_logradouro_w;
	elsif (ie_opcao_p = 'CI') then
		ds_retorno_w	:= ds_municipio_w;
	elsif (ie_opcao_p = 'UF') then
		ds_retorno_w	:= sg_estado_w;
	elsif (ie_opcao_p = 'CEP') then
		ds_retorno_w	:= cd_cep_w;
	elsif (ie_opcao_p = 'B') then
		ds_retorno_w	:= ds_bairro_w;
	elsif (ie_opcao_p = 'E') then
		ds_retorno_w	:= (ds_endereco_w);
	elsif (ie_opcao_p = 'EN') then
		ds_retorno_w	:= (ds_endereco_w ||', ' || nr_endereco_w || ', ' || ds_complemento_w);
	elsif (ie_opcao_p = 'EC') then
		ds_retorno_w	:= (ds_endereco_w ||', ' || nr_endereco_w || ', ' || ds_complemento_w || ', ' || ds_bairro_w || ', ' || sg_estado_w);
	elsif (ie_opcao_p = 'ES') then
		ds_retorno_w	:= (ds_endereco_w ||', ' || nr_endereco_w || ', ' || ds_bairro_w || ', ' || ds_complemento_w);
	elsif (ie_opcao_p = 'NR') then
		ds_retorno_w	:= (nr_endereco_w);
	elsif (ie_opcao_p = 'CO') then
		ds_retorno_w	:= (ds_complemento_w);
	elsif (ie_opcao_p = 'M') then
		ds_retorno_w	:= (ds_email_w);
	elsif (ie_opcao_p = 'FAX') then
		ds_retorno_w	:= ds_fax_w;
	elsif (ie_opcao_p = 'CCE') then
		ds_retorno_w	:= cd_cep_w ||' - '||ds_municipio_w||' - '||sg_estado_w;
	elsif (ie_opcao_p = 'NPR') then
		ds_retorno_w	:= nm_pessoa_contato_w;
	elsif (ie_opcao_p = 'RAM') then
		ds_retorno_w	:= nr_ramal_contato_w;
	elsif (ie_opcao_p = 'IBGE') then
		ds_retorno_w	:= cd_municipio_ibge_w;
	elsif (ie_opcao_p = 'DS_UF') then
		if (coalesce(ds_estado_w::text, '') = '') and (sg_estado_w IS NOT NULL AND sg_estado_w::text <> '') then
			ds_estado_w	:= obter_valor_dominio(50,sg_estado_w);
		end if;
	
		ds_retorno_w	:= ds_estado_w;
	elsif (ie_opcao_p = 'EP') then
		if (ds_endereco_w IS NOT NULL AND ds_endereco_w::text <> '') then
			ds_retorno_w	:= ds_retorno_w || ', '|| ds_endereco_w;
		end if;
		if (nr_endereco_w IS NOT NULL AND nr_endereco_w::text <> '') then
			ds_retorno_w	:= ds_retorno_w || ', '|| nr_endereco_w;
		end if;
		if (ds_complemento_w IS NOT NULL AND ds_complemento_w::text <> '') then
			ds_retorno_w	:= ds_retorno_w || ', ' || ds_complemento_w;
		end if;
		if (ds_bairro_w IS NOT NULL AND ds_bairro_w::text <> '') then
			ds_retorno_w	:= ds_retorno_w || ', ' || ds_bairro_w;
		end if;
		if (ds_municipio_w IS NOT NULL AND ds_municipio_w::text <> '') then
			ds_retorno_w	:= ds_retorno_w || ', ' || ds_municipio_w;
		end if;
		if (cd_cep_w IS NOT NULL AND cd_cep_w::text <> '') then
			ds_retorno_w	:= ds_retorno_w || ', ' || cd_cep_w;
		end if;
		
		ds_retorno_w	:= substr(ds_retorno_w,2,255);
		
		return ds_retorno_w;
	end if;
end if;

return	ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION pls_obter_compl_pagador ( nr_seq_pagador_p bigint, ie_opcao_p text) FROM PUBLIC;

