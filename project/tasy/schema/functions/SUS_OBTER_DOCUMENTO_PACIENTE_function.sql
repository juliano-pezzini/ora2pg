-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION sus_obter_documento_paciente ( nr_aih_p bigint, nr_sequencia_p bigint, ie_tipo_p bigint) RETURNS varchar AS $body$
DECLARE

 
/* IE_TIPO_P 
 
	1 - Documento 
	2 - Tipo documento 
*/
 
 
/* TIPO DOCUMENTO	 
 
	1- PIS/PASEP 
	2- Identidade 
	3- Nascimento 
	4- CPF 
	5- Não Informado 
*/
 
 
 
 
nr_interno_conta_w	bigint;
cd_proced_realiz_w	bigint;
nr_pis_pasep_w		varchar(11);
nr_identidade_w		varchar(15);
nr_cert_nasc_w		varchar(20);
nr_cpf_w		varchar(11);
ds_documento_w		varchar(20)	:= null;
ie_tipo_doc_w		smallint;
ds_retorno_w		varchar(20)	:= null;

 

BEGIN 
 
/* Obter os dados do documento do paciente*/
 
select	a.nr_interno_conta, 
	c.nr_pis_pasep, 
	somente_numero(c.nr_identidade), 
	c.nr_cert_nasc, 
	c.nr_cpf 
into STRICT	nr_interno_conta_w, 
	nr_pis_pasep_w, 
	nr_identidade_w, 
	nr_cert_nasc_w, 
	nr_cpf_w 
from	pessoa_fisica		c, 
	atendimento_paciente	b, 
	sus_aih			a 
where	a.nr_atendimento 	= b.nr_atendimento 
and	b.cd_pessoa_fisica	= c.cd_pessoa_fisica 
and	nr_aih			= nr_aih_p 
and	nr_sequencia		= nr_Sequencia_p;
 
select	obter_procedimento_aih(nr_interno_conta_w, 'E') 
into STRICT	cd_proced_realiz_w
;
 
/* Retorna o PIS-PASEP/Cartão SUS*/
 
if (coalesce(ds_documento_w::text, '') = '') and (nr_pis_pasep_w IS NOT NULL AND nr_pis_pasep_w::text <> '') then 
	ds_documento_w	:= nr_pis_pasep_w;
	ie_tipo_doc_w	:= 1;
/* Retorna Documento de identidade*/
 
elsif (coalesce(ds_documento_w::text, '') = '') and (nr_identidade_w <> 0) then 
	ds_documento_w	:= nr_identidade_w;
	ie_tipo_doc_w	:= 2;
/* Retorna Registro de Nascimento*/
 
elsif (coalesce(ds_documento_w::text, '') = '') and (nr_cert_nasc_w IS NOT NULL AND nr_cert_nasc_w::text <> '') then 
	ds_documento_w	:= nr_cert_nasc_w;
	ie_tipo_doc_w	:= 3;
/* Retorna o CPF*/
 
elsif (coalesce(ds_documento_w::text, '') = '') and (nr_cpf_w IS NOT NULL AND nr_cpf_w::text <> '') then 
	ds_documento_w	:= nr_cpf_w;
	ie_tipo_doc_w	:= 4;
/* Não retorna nada*/
 
else	 
	ds_documento_w	:= 0;
	ie_tipo_doc_w	:= 5;
end if;
 
/* Verificar no cadastro interno se para determinada AIH a informação do CPF é obrigatória*/
 
if (AIH_Validar_Regra(9, cd_proced_realiz_w) > 0) then 
	ds_documento_w	:= nr_cpf_w;
	ie_tipo_doc_w	:= 4;
end if;
 
if (ie_tipo_p	= 1) then 
	ds_retorno_w	:= ds_documento_w;
elsif (ie_tipo_p	= 2) then 
	ds_retorno_w	:= ie_tipo_doc_w;
end if;
 
return	ds_retorno_w;
 
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION sus_obter_documento_paciente ( nr_aih_p bigint, nr_sequencia_p bigint, ie_tipo_p bigint) FROM PUBLIC;

