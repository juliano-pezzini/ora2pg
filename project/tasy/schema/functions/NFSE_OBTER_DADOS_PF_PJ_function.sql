-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION nfse_obter_dados_pf_pj (cd_pessoa_fisica_p text, cd_cgc_p text, ie_opcao_p text) RETURNS varchar AS $body$
DECLARE


ds_razao_social_w         pessoa_juridica.ds_razao_social%type;
cd_cep_w                  pessoa_juridica.cd_cep%type;
ds_endereco_w             pessoa_juridica_compl.ds_endereco%type;
ds_bairro_w               pessoa_juridica.ds_bairro%type;
sg_estado_w               pessoa_juridica.sg_estado%type;
ds_retorno_w              varchar(255);
ds_complemento_w          pessoa_juridica.ds_complemento%type;
nr_telefone_w             pessoa_juridica.nr_telefone%type;
nr_endereco_w             pessoa_juridica.nr_endereco%type;
ds_email_w                pessoa_juridica_compl.ds_email%type;
nr_inscricao_municipal_w  pessoa_juridica.nr_inscricao_municipal%type;
nr_ddd_telefone_w         pessoa_juridica.nr_ddd_telefone%type;
cd_municipio_ibge_dv_w    varchar(255);
cd_municipio_ibge_w       pessoa_juridica.cd_municipio_ibge%type;
cd_municipio_nfe_w        sus_municipio.cd_municipio_nfe%type;
retorno_w                 varchar(255);
complement_code_w         pessoa_juridica_compl.nr_sequencia%type;

BEGIN
  if (cd_pessoa_fisica_p IS NOT NULL AND cd_pessoa_fisica_p::text <> '') then
    retorno_w:= nfse_obter_compl_pf(cd_pessoa_fisica_p,ie_opcao_p);
  else
    select  max(nr_sequencia)
    into STRICT    complement_code_w
    from    pessoa_juridica_compl
    where   ie_tipo_complemento = 7
    and     cd_cgc = cd_cgc_p;

    if (complement_code_w IS NOT NULL AND complement_code_w::text <> '') then
      select  max(a.ds_razao_social),
              max(d.cd_cep),
              max(d.ds_endereco),
              max(d.ds_bairro),
              max(d.sg_estado),
              max(d.ds_complemento),
              max(d.nr_telefone),
              max(d.nr_endereco),
              max(d.ds_email),
              max(a.nr_inscricao_municipal),
              max(d.cd_municipio_ibge),
              max(d.nr_ddd_telefone)
      into STRICT    ds_razao_social_w,
              cd_cep_w,
              ds_endereco_w,
              ds_bairro_w,
              sg_estado_w,
              ds_complemento_w,
              nr_telefone_w,
              nr_endereco_w,
              ds_email_w,
              nr_inscricao_municipal_w,
              cd_municipio_ibge_w,
              nr_ddd_telefone_w
      FROM pessoa_juridica_compl d, tipo_pessoa_juridica b, pessoa_juridica a
LEFT OUTER JOIN cns_tipo_logradouro c ON (a.nr_seq_tipo_logradouro = c.nr_sequencia)
WHERE a.cd_tipo_pessoa  = b.cd_tipo_pessoa  and a.cd_cgc = cd_cgc_p and d.cd_cgc = a.cd_cgc and d.ie_tipo_complemento = 7;
    else
      select  a.ds_razao_social,
              a.cd_cep,
              a.ds_endereco,
              a.ds_bairro,
              a.sg_estado,
              a.ds_complemento,
              a.nr_telefone,
              a.nr_endereco,
              a.ds_email_nfe,
              a.nr_inscricao_municipal,
              a.cd_municipio_ibge,
              a.nr_ddd_telefone
      into STRICT    ds_razao_social_w,
              cd_cep_w,
              ds_endereco_w,
              ds_bairro_w,
              sg_estado_w,
              ds_complemento_w,
              nr_telefone_w,
              nr_endereco_w,
              ds_email_w,
              nr_inscricao_municipal_w,
              cd_municipio_ibge_w,
              nr_ddd_telefone_w
      FROM tipo_pessoa_juridica b, pessoa_juridica a
LEFT OUTER JOIN cns_tipo_logradouro c ON (a.nr_seq_tipo_logradouro = c.nr_sequencia)
WHERE a.cd_tipo_pessoa  = b.cd_tipo_pessoa  and a.cd_cgc   = cd_cgc_p;
    end if;

    if (ie_opcao_p = 'N') then
      retorno_w:= ds_razao_social_w;
    elsif (ie_opcao_p = 'T') then
      retorno_w:= substr(somente_numero(nr_telefone_w),1,15);
    elsif (ie_opcao_p = 'UF') then
      retorno_w:= sg_estado_w;
    elsif (ie_opcao_p = 'CEP') then
            retorno_w:= substr(cd_cep_w,1,8);
    elsif (ie_opcao_p = 'B') then
      retorno_w:= ds_bairro_w;
    elsif (ie_opcao_p = 'EN') then
      retorno_w:= ds_endereco_w;
    elsif (ie_opcao_p = 'NR') then
      retorno_w:=  substr(somente_numero(nr_endereco_w),1,5);
    elsif (ie_opcao_p = 'CO') then
      retorno_w:= ds_complemento_w;
    elsif (ie_opcao_p = 'M') then
      begin
      retorno_w:= ds_email_w;
      end;
    elsif (ie_opcao_p = 'MC') then
      begin
      retorno_w:= ds_email_w;
      end;
    elsif (ie_opcao_p = 'IM') then
      retorno_w:= nr_inscricao_municipal_w;
    elsif (ie_opcao_p = 'CDM') then
      retorno_w:= cd_municipio_ibge_w;
    elsif (ie_opcao_p = 'CDMDV') then
      begin
      if (cd_municipio_ibge_w IS NOT NULL AND cd_municipio_ibge_w::text <> '') then
      cd_municipio_ibge_dv_w := substr(cd_municipio_ibge_w || substr(calcula_digito('MODULO10',cd_municipio_ibge_w),1,1),1,255);
      end if;
      retorno_w:= cd_municipio_ibge_dv_w;
      end;
    elsif (ie_opcao_p = 'CDMNF') then
      begin
      select cd_municipio_nfe
      into STRICT cd_municipio_nfe_w
      from sus_municipio
      where cd_municipio_ibge = cd_municipio_ibge_w;

      retorno_w := cd_municipio_nfe_w;
      exception
      when no_data_found then
        retorno_w := cd_municipio_ibge_w;
      when too_many_rows then raise;
      end;
    elsif (ie_opcao_p = 'DDT') then
      retorno_w:= nr_ddd_telefone_w;
    elsif (ie_opcao_p = 'DM') then
      retorno_w := obter_desc_municipio_ibge(cd_municipio_ibge_w);
    end if;
  end if;

  if (ie_opcao_p = 'CDMDV' or ie_opcao_p = 'IBGE') then
    case substr(ds_retorno_w, 6)
    when '430587' then ds_retorno_w := '4305871';
    when '220191' then ds_retorno_w := '2201919';
    when '220225' then ds_retorno_w := '2202251';
    when '220198' then ds_retorno_w := '2201988';
    when '261153' then ds_retorno_w := '2611533';
    when '311783' then ds_retorno_w := '3117836';
    when '315213' then ds_retorno_w := '3152131';
    when '520393' then ds_retorno_w := '5203939';
    when '520396' then ds_retorno_w := '5203962';
    else ds_retorno_w := ds_retorno_w;
    end case;
  end if;

  retorno_w := tiss_eliminar_caractere(elimina_acentuacao(retorno_w));
  RETURN retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION nfse_obter_dados_pf_pj (cd_pessoa_fisica_p text, cd_cgc_p text, ie_opcao_p text) FROM PUBLIC;

