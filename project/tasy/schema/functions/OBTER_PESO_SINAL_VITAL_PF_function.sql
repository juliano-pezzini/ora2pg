-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_peso_sinal_vital_pf (NR_ATENDIMENTO_P ATENDIMENTO_PACIENTE.NR_ATENDIMENTO%TYPE) RETURNS bigint AS $body$
DECLARE

    wReturn ATENDIMENTO_SINAL_VITAL.QT_PESO_ATUAL%TYPE := 0;

BEGIN
    SELECT
        coalesce(MAX( CASE
            WHEN UPPER(c.IE_UNID_MED_PESO) = 'KG' THEN c.QT_PESO_ATUAL/1000
            WHEN UPPER(c.IE_UNID_MED_PESO) = 'G'  THEN c.QT_PESO_ATUAL
            WHEN UPPER(c.IE_UNID_MED_PESO) = 'OZ' THEN c.QT_PESO_ATUAL/35.274
            WHEN UPPER(c.IE_UNID_MED_PESO) = 'LB' THEN c.QT_PESO_ATUAL/2.205
            ELSE b.QT_PESO
         END),0) QT_PESO
    INTO STRICT wReturn
    FROM ATENDIMENTO_PACIENTE a
    INNER JOIN PESSOA_FISICA b ON
        b.CD_PESSOA_FISICA = a.CD_PESSOA_FISICA
    LEFT JOIN (
        SELECT 
            IE_UNID_MED_PESO,
            QT_PESO_ATUAL,
            NR_ATENDIMENTO
        FROM ATENDIMENTO_SINAL_VITAL c
        WHERE
            c.DT_SINAL_VITAL >= clock_timestamp() - interval '30 days' AND
            c.NR_SEQUENCIA = (SELECT 
                                 MAX(d.NR_SEQUENCIA) 
                              FROM ATENDIMENTO_SINAL_VITAL d 
                              WHERE 
                                d.NR_ATENDIMENTO = c.NR_ATENDIMENTO AND
                                (d.QT_PESO_ATUAL IS NOT NULL AND d.QT_PESO_ATUAL::text <> '') AND
                                d.DT_SINAL_VITAL >= clock_timestamp() - interval '30 days')
    ) c ON
        c.NR_ATENDIMENTO = a.NR_ATENDIMENTO
    WHERE 
        a.NR_ATENDIMENTO = NR_ATENDIMENTO_P;
    RETURN wReturn;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_peso_sinal_vital_pf (NR_ATENDIMENTO_P ATENDIMENTO_PACIENTE.NR_ATENDIMENTO%TYPE) FROM PUBLIC;

