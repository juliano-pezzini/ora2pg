-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_banco_pf_pj_cobr_da ( cd_pessoa_fisica_p text, cd_cgc_p text, ie_opcao_p text) RETURNS varchar AS $body$
DECLARE


-- Função criada para atender demanda para identificar CC especifica para Débito Automático.
-- OS 1771755
cd_banco_w		integer;
cd_banco2_w		varchar(50);
ds_retorno_w		varchar(255);
cd_agencia_bancaria_w	varchar(8);
cd_agencia_bancaria2_w	varchar(50);
nr_conta_w		varchar(100);
NR_DIGITO_CONTA_w	varchar(2);
NR_DIGITO_CONTA2_w	varchar(50);
ie_digito_agencia_w	varchar(20);

ds_banco_w		varchar(20);
ds_agencia_w		varchar(20);
ds_conta_w		varchar(20);
ds_digito_w		varchar(20);

--CC,CP,CS,DJ,DA
BEGIN

if (coalesce(cd_pessoa_fisica_p, 'X') <> 'X') then

	select	max(cd_banco),
		max(cd_agencia_bancaria),
		max(ie_digito_agencia),
		max(nr_conta),
		max(nr_digito_conta)
	into STRICT	cd_banco_w,
		cd_agencia_bancaria_w,
		ie_digito_agencia_w,
		nr_conta_w,
		nr_digito_conta_w
	from	pessoa_fisica_conta a
	where	cd_pessoa_fisica	= cd_pessoa_fisica_p
	and	ie_situacao		= 'A'
	and     ie_tipo_conta 		= 'DA';

elsif (coalesce(cd_cgc_p, 'X') <> 'X') then

	select	max(cd_banco),
		max(cd_agencia_bancaria),
		max(ie_digito_agencia),
		max(nr_conta),
		max(nr_digito_conta)
	into STRICT	cd_banco_w,
		cd_agencia_bancaria_w,
		ie_digito_agencia_w,
		nr_conta_w,
		nr_digito_conta_w
	from	pessoa_juridica_conta a
	where	cd_cgc		= cd_cgc_p
	and	ie_situacao	= 'A'
	and     ie_tipo_conta 	= 'DA';

end if;

if (ie_opcao_p	= 'B') then
	ds_retorno_w	:= cd_banco_w;
end if;

if (ie_opcao_p	= 'CC') then

	if (nr_conta_w IS NOT NULL AND nr_conta_w::text <> '') then
		ds_retorno_w	:= nr_conta_w;
	end if;
	if (nr_digito_conta_w IS NOT NULL AND nr_digito_conta_w::text <> '') then
		ds_retorno_w	:= ds_retorno_w || '/' || nr_digito_conta_w;
	end if;
end if;

if (ie_opcao_p in ('C','CD','D')) then
	ds_banco_w	:= wheb_mensagem_pck.get_texto(303140);
	ds_agencia_w	:= wheb_mensagem_pck.get_texto(303141);
	ds_conta_w	:= wheb_mensagem_pck.get_texto(303142);
	ds_digito_w	:= wheb_mensagem_pck.get_texto(303143);
end if;

if (ie_opcao_p	= 'C') then

	if (cd_banco_w IS NOT NULL AND cd_banco_w::text <> '') then
		cd_banco2_w := ds_banco_w || cd_banco_w;
	end if;

	if (cd_agencia_bancaria_w IS NOT NULL AND cd_agencia_bancaria_w::text <> '') then
		cd_agencia_bancaria2_w := ds_agencia_w || cd_agencia_bancaria_w;
	end if;

	if (nr_conta_w IS NOT NULL AND nr_conta_w::text <> '') then
		nr_conta_w := ds_conta_w || nr_conta_w;
	end if;

	ds_retorno_w	:= cd_banco2_w || ' ' || cd_agencia_bancaria2_w || ' ' || nr_conta_w;
end if;

if (ie_opcao_p	= 'CD') then

	if (cd_banco_w IS NOT NULL AND cd_banco_w::text <> '') then
		cd_banco2_w := ds_banco_w || cd_banco_w;
	end if;

	if (cd_agencia_bancaria_w IS NOT NULL AND cd_agencia_bancaria_w::text <> '') then
		cd_agencia_bancaria2_w := ds_agencia_w || cd_agencia_bancaria_w || '-' || ie_digito_agencia_w;
	end if;

	if (nr_conta_w IS NOT NULL AND nr_conta_w::text <> '') then
		nr_conta_w := substr(ds_conta_w || nr_conta_w || '-' || nr_digito_conta_w,1,20);
	end if;

	ds_retorno_w	:= cd_banco2_w || ' ' || cd_agencia_bancaria2_w || ' ' || nr_conta_w;
end if;

if (ie_opcao_p	= 'D') then

	if (cd_banco_w IS NOT NULL AND cd_banco_w::text <> '') then
		cd_banco2_w := ds_banco_w || cd_banco_w;
	end if;

	if (cd_agencia_bancaria_w IS NOT NULL AND cd_agencia_bancaria_w::text <> '') then
		cd_agencia_bancaria2_w := ds_agencia_w || cd_agencia_bancaria_w;
	end if;

	if (nr_conta_w IS NOT NULL AND nr_conta_w::text <> '') then
		nr_conta_w := ds_conta_w || nr_conta_w;
	end if;

	if (nr_digito_conta_w IS NOT NULL AND nr_digito_conta_w::text <> '') then
		nr_digito_conta2_w := ds_digito_w || nr_digito_conta_w;
	end if;

	ds_retorno_w	:= cd_banco2_w || ' ' || cd_agencia_bancaria2_w || ' ' || nr_conta_w || ' ' || nr_digito_conta2_w;
end if;

if (ie_opcao_p	= 'AC') then -- Apenas Conta
	ds_retorno_w	:= nr_conta_w;
end if;

if (ie_opcao_p	= 'ADC') then -- Apenas Digito Conta
	ds_retorno_w	:= nr_digito_conta_w;
end if;

if (ie_opcao_p	= 'AG') then -- Apenas Agencia
	ds_retorno_w	:= cd_agencia_bancaria_w;
end if;



return	ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_banco_pf_pj_cobr_da ( cd_pessoa_fisica_p text, cd_cgc_p text, ie_opcao_p text) FROM PUBLIC;

