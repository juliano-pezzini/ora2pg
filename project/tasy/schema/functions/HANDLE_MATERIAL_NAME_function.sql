-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION handle_material_name ( cd_material_p material.cd_material%type, ds_material_p material.ds_general_name%type) RETURNS varchar AS $body$
DECLARE


si_general_name_type_w	cpoe_order_unit.si_general_name_type%type;
ds_general_name_w		material.ds_general_name%type;
ie_return_w				material.ds_orientacao_usuario%type :=  ds_material_p;
nr_idx_strong_w			integer;


BEGIN

if (cd_material_p IS NOT NULL AND cd_material_p::text <> '') then

    select  max(cp_uni.si_general_name_type) si_general_name_type,
            max(mat.ds_general_name) ds_general_name
    into STRICT    si_general_name_type_w,
            ds_general_name_w
    from    cpoe_order_unit cp_uni,
            cpoe_material cp_mat,
            material mat
    where   cp_mat.nr_seq_cpoe_order_unit = cp_uni.nr_sequencia
    and     mat.cd_material = cp_mat.cd_material
    and     cp_mat.cd_material = cd_material_p
    order by si_general_name_type;
	
    if ('G' = si_general_name_type_w) then
		/* Searching for first </strong> identifier. It represents the end of name */

		nr_idx_strong_w := position('</strong>' in ds_material_p) -1;
		if (nr_idx_strong_w > 0) then
			/* Insert the ds_general_name before </strong> identifier */

			ie_return_w := substr(ds_material_p, 1, nr_idx_strong_w) || ' (' || ds_general_name_w || ')' || substr(ds_material_p, nr_idx_strong_w+1, length(ds_material_p));
		end if;
    end if;

end if;

return ie_return_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION handle_material_name ( cd_material_p material.cd_material%type, ds_material_p material.ds_general_name%type) FROM PUBLIC;

