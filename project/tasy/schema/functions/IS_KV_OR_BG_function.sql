-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION is_kv_or_bg ( nr_sequencia_p bigint ) RETURNS varchar AS $body$
DECLARE


is_kv_or_bg_w smallint;

BEGIN
	select  count(1)
    into STRICT    is_kv_or_bg_w
    from    atendimento_paciente ap
    where   ap.nr_seq_episodio = nr_sequencia_p
    and     ap.nr_atendimento = (   SELECT  max(nr_atendimento)
                                    from    atendimento_paciente z
                                    where   z.nr_seq_episodio = nr_sequencia_p
                                    and     coalesce(z.dt_alta::text, '') = ''
                                    and     z.dt_entrada < clock_timestamp())
    and     exists ( SELECT  1
                    from    tipo_admissao_fat taf
                    where   taf.nr_sequencia = ap.nr_seq_tipo_admissao_fat
                     and (taf.ie_tipo_kv = 'S' or taf.ie_tipo_bg = 'S'))
;

     if (is_kv_or_bg_w > 0 ) then
         return 'S';
     else
         return 'N';
     end if;
 end;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION is_kv_or_bg ( nr_sequencia_p bigint ) FROM PUBLIC;

