-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION verify_medical_dept_match (proc_seq_p text) RETURNS varchar AS $body$
DECLARE

ret_flag_w varchar(1) := 'N';
med_dept_count_w bigint;
proc_classif_w proc_interno.NR_SEQ_CLASSIF%TYPE := null;
ie_exam_classif_med_w varchar(2);
ie_pais_w	valor_dominio.vl_dominio%type;


BEGIN
ie_pais_w	:=	coalesce(pkg_i18n.get_user_locale, 'pt_BR');

    if (ie_pais_w = 'ja_JP') then

        select nr_seq_classif
        into STRICT proc_classif_w
        from proc_interno
        where nr_sequencia = proc_seq_p;

        if (proc_classif_w IS NOT NULL AND proc_classif_w::text <> '') then

            select ie_exam_classif_med
            into STRICT ie_exam_classif_med_w
            from proc_interno_classif
            where nr_sequencia = proc_classif_w;

            if (ie_exam_classif_med_w = 'S') then

                select count(*)
                into STRICT med_dept_count_w
                from proc_interno p, exam_med_dep d
                where p.nr_sequencia = proc_seq_p
                and d.nr_exam_code = proc_seq_p
                and p.ie_situacao = 'A';

                if (med_dept_count_w > 0) then

                    select count(*)
                    into STRICT med_dept_count_w
                    from proc_interno p, exam_med_dep d
                    where p.nr_sequencia = proc_seq_p
                    and d.nr_exam_code = proc_seq_p
                    and p.ie_situacao = 'A'
                    and d.cd_med_department IN (SELECT cd_departamento
                                       from user_medical_department u
                                       where u.nm_usuario = wheb_usuario_pck.get_nm_usuario);

                    if (med_dept_count_w > 0) then
                        ret_flag_w := 'S';
                    else
                        ret_flag_w := 'N';
                    end if;
                else
                    ret_flag_w := 'S';
                end if;
            else
                ret_flag_w := 'N';
            end if;
        else
            ret_flag_w := 'S';
        end if;
    else
        ret_flag_w := 'S';
    end if;

return ret_flag_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION verify_medical_dept_match (proc_seq_p text) FROM PUBLIC;

