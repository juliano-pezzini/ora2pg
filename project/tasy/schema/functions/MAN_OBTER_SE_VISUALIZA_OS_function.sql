-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION man_obter_se_visualiza_os ( nr_seq_grupo_des_p bigint, nr_seq_grupo_sup_p bigint, nr_seq_grupo_des_os_p bigint, nr_seq_grupo_sup_os_p bigint, nr_seq_gerencia_des_os_p bigint, nr_seq_gerencia_sup_os_p bigint, ie_forma_sla_p text, nm_usuario_p text) RETURNS varchar AS $body$
DECLARE


nr_seq_gerencia_sup_w		varchar(2000);
nr_seq_gerencia_sup_aux_w	varchar(2000);
nr_seq_grupo_sup_os_w		varchar(2000);
nr_seq_grupo_sup_os_aux_w	varchar(2000);
nm_usuario_lider_w		varchar(15);
cd_pessoa_fisica_w		varchar(10);
ie_retorno_w			varchar(1)	:= 'N';
ie_contido_w			varchar(1);
nr_seq_gerencia_des_w		bigint;
nr_seq_gerencia_des_os_w	bigint;

C01 CURSOR FOR
	SELECT	to_char(a.nr_seq_gerencia_sup)
	from	grupo_suporte	a
	where	a.nr_sequencia	= nr_seq_grupo_sup_p;

C02 CURSOR FOR
	SELECT	to_char(a.nr_sequencia)
	from	grupo_suporte	a
	where	a.nm_usuario_lider	= nm_usuario_lider_w;

C03 CURSOR FOR
	SELECT	to_char(nr_seq_grupo)
	from	usuario_grupo_sup
	where 	nm_usuario_grupo = nm_usuario_p;


BEGIN
if (nr_seq_grupo_des_p IS NOT NULL AND nr_seq_grupo_des_p::text <> '') then
	select	a.nr_seq_gerencia
	into STRICT	nr_seq_gerencia_des_w
	from	grupo_desenvolvimento	a
	where	a.nr_sequencia	= nr_seq_grupo_des_p;
end if;

if (nr_seq_grupo_sup_p IS NOT NULL AND nr_seq_grupo_sup_p::text <> '') then
	select	a.nm_usuario_lider
	into STRICT	nm_usuario_lider_w
	from	grupo_suporte	a
	where	a.nr_sequencia	= nr_seq_grupo_sup_p;

	nr_seq_gerencia_sup_w := '(';
	open C01;
	loop
	fetch C01 into
		nr_seq_gerencia_sup_aux_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin
		nr_seq_gerencia_sup_w	:= nr_seq_gerencia_sup_w || nr_seq_gerencia_sup_aux_w || ',';
		end;
	end loop;
	close C01;

	nr_seq_gerencia_sup_w	:= nr_seq_gerencia_sup_w || ')';

	if (nm_usuario_lider_w = nm_usuario_p) then
		nr_seq_grupo_sup_os_w	:= '(';

		open C02;
		loop
		fetch C02 into
			nr_seq_grupo_sup_os_aux_w;
		EXIT WHEN NOT FOUND; /* apply on C02 */
			begin
			nr_seq_grupo_sup_os_w	:= nr_seq_grupo_sup_os_w || nr_seq_grupo_sup_os_aux_w || ',';
			end;
		end loop;
		close C02;

		nr_seq_grupo_sup_os_w	:= nr_seq_grupo_sup_os_w ||  ')';
	else
		begin
		nr_seq_grupo_sup_os_w	:= '(';

		open C03;
		loop
		fetch C03 into
			nr_seq_grupo_sup_os_aux_w;
		EXIT WHEN NOT FOUND; /* apply on C03 */
			begin
			nr_seq_grupo_sup_os_w := nr_seq_grupo_sup_os_w || nr_seq_grupo_sup_os_aux_w || ',';
			end;
		end loop;
		close C03;

		nr_seq_grupo_sup_os_w	:= nr_seq_grupo_sup_os_w ||  ')';
		end;
	end if;

end if;

if (ie_forma_sla_p = 'GR') then
	if (nr_seq_grupo_des_os_p = nr_seq_grupo_des_p) then
		ie_retorno_w	:= 'S';
	end if;

	select	obter_se_contido(nr_seq_grupo_sup_os_p, nr_seq_grupo_sup_os_w)
	into STRICT	ie_contido_w
	;

	if (ie_contido_w = 'S') then
		ie_retorno_w	:= 'S';
	end if;
elsif (ie_forma_sla_p = 'GE') then
	if (nr_seq_gerencia_des_os_p = nr_seq_gerencia_des_w) then
		ie_retorno_w	:= 'S';
	end if;

	select	obter_se_contido(nr_seq_gerencia_sup_os_p, nr_seq_gerencia_sup_w)
	into STRICT	ie_contido_w
	;

	if (ie_contido_w = 'S') then
		ie_retorno_w	:= 'S';
	end if;
elsif (ie_forma_sla_p = 'GRG') then
	if (nr_seq_grupo_des_p IS NOT NULL AND nr_seq_grupo_des_p::text <> '') then
		if (nr_seq_grupo_des_os_p = nr_seq_grupo_des_p) then
			ie_retorno_w	:= 'S';
		end if;

		if (ie_retorno_w = 'N') then
			select	max(b.nm_usuario_grupo)
			into STRICT	nm_usuario_lider_w
			from	grupo_desenvolvimento	a,
				usuario_grupo_des b
			where	a.nr_sequencia = b.nr_seq_grupo
			and	b.ie_funcao_usuario = 'S'
			and	a.nr_sequencia	= nr_seq_grupo_des_os_p;

			select	a.cd_pessoa_fisica
			into STRICT	cd_pessoa_fisica_w
			from	usuario	a
			where	a.nm_usuario	= nm_usuario_lider_w;

			select	CASE WHEN count(*)=0 THEN 'N'  ELSE 'S' END
			into STRICT	ie_retorno_w
			from	gerencia_wheb	a
			where	a.nr_sequencia	= nr_seq_gerencia_des_w
			and	cd_responsavel	= cd_pessoa_fisica_w;
		end if;
	end if;

	if (nr_seq_grupo_sup_p IS NOT NULL AND nr_seq_grupo_sup_p::text <> '') then
		select	obter_se_contido(nr_seq_grupo_sup_os_p, nr_seq_grupo_sup_os_w)
		into STRICT	ie_contido_w
		;

		if (ie_contido_w = 'S') then
			ie_retorno_w	:= 'S';
		end if;

		if (ie_retorno_w = 'N') then
			select	max(a.nm_usuario_lider)
			into STRICT	nm_usuario_lider_w
			from	grupo_suporte	a
			where	a.nr_sequencia	= nr_seq_grupo_sup_os_p;

			select	a.cd_pessoa_fisica
			into STRICT	cd_pessoa_fisica_w
			from	usuario	a
			where	a.nm_usuario	= nm_usuario_lider_w;

			select	CASE WHEN count(*)=0 THEN 'N'  ELSE 'S' END
			into STRICT	ie_retorno_w
			from	gerencia_wheb	a
			where	obter_se_contido(a.nr_sequencia, nr_seq_gerencia_sup_w) = 'S'
			and	cd_responsavel	= cd_pessoa_fisica_w;
		end if;
	end if;
end if;

return	ie_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION man_obter_se_visualiza_os ( nr_seq_grupo_des_p bigint, nr_seq_grupo_sup_p bigint, nr_seq_grupo_des_os_p bigint, nr_seq_grupo_sup_os_p bigint, nr_seq_gerencia_des_os_p bigint, nr_seq_gerencia_sup_os_p bigint, ie_forma_sla_p text, nm_usuario_p text) FROM PUBLIC;

