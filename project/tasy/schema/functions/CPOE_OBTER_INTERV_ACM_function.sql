-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION cpoe_obter_interv_acm ( nr_atendimento_p bigint, cd_item_p bigint, ie_modo_adm_p text, ie_tipo_item_p text, cd_estabelecimento_p bigint, cd_perfil_p bigint, nm_usuario_p text) RETURNS varchar AS $body$
DECLARE

 
cd_intervalo_w		intervalo_prescricao.cd_intervalo%type;


BEGIN 
 
if (ie_tipo_item_p = 'M') then 
	select	max(cd_intervalo) 
	into STRICT	cd_intervalo_w 
	from	intervalo_prescricao 
	where	ie_situacao = 'A' 
	and		obter_se_intervalo(cd_intervalo, '1') = 'S' 
	and		coalesce(ie_acm,'N') = 'S' 
	and		((coalesce(cd_estabelecimento::text, '') = '') or (cd_estabelecimento = cd_estabelecimento_p )) 
	and		obter_se_intervalo_estab(cd_intervalo, cd_estabelecimento_p ) = 'S' 
	and		obter_se_intervalo_sugerido(cd_item_p, cd_intervalo) = 'S';
elsif (ie_tipo_item_p = 'E') then 
	select	max(cd_intervalo) 
	into STRICT	cd_intervalo_w 
	from  intervalo_prescricao 
	where  ie_situacao = 'A' 
	and		((coalesce(ie_continuo::text, '') = '') or (ie_continuo = CASE WHEN ie_modo_adm_p='C' THEN 'S'  ELSE 'N' END )) 
	and		coalesce(ie_acm,'N') = 'S' 
	and		obter_se_intervalo(cd_intervalo, '8') = 'S' 
	and		obter_se_interv_regra(cd_intervalo, 'DE') = 'S' 
	and   ((coalesce(cd_estabelecimento::text, '') = '') or (cd_estabelecimento = cd_estabelecimento_p)) 
	and   obter_se_exibe_intervalo(0, cd_intervalo, null) = 'S' 
	and   obter_se_intervalo_estab(cd_intervalo, cd_estabelecimento_p) = 'S' 
	and   obter_se_intervalo_lib_mat(cd_item_p, cd_intervalo) = 'S' 
	and   obter_se_intervalo_material(cd_item_p, cd_intervalo) = 'S';
elsif (ie_tipo_item_p = 'S') then 
	select	max(cd_intervalo) 
	into STRICT	cd_intervalo_w 
	from	intervalo_prescricao 
	where	ie_situacao = 'A' 
	and		coalesce(ie_acm,'N') = 'S' 
	and   ((coalesce(cd_estabelecimento::text, '') = '') or (cd_estabelecimento = cd_estabelecimento_p)) 
	and   obter_se_exibe_intervalo(0, cd_intervalo, null) = 'S' 
	and   obter_se_intervalo_estab(cd_intervalo, cd_estabelecimento_p) = 'S' 
	and		obter_se_intervalo(cd_intervalo, '12') = 'S' 
	and		obter_se_interv_regra(cd_intervalo, 'DS') = 'S';
elsif (ie_tipo_item_p = 'R') then 
	select	max(cd_intervalo) 
	into STRICT	cd_intervalo_w 
	from 	intervalo_prescricao 
	where	ie_situacao = 'A' 
	and		coalesce(ie_acm,'N') = 'S' 
	and 	((coalesce(cd_estabelecimento::text, '') = '') or (cd_estabelecimento = cd_estabelecimento_p)) 
	and 	obter_se_intervalo(cd_intervalo, 'R') = 'S';
elsif (ie_tipo_item_p = 'G') then 
	select	max(cd_intervalo) 
	into STRICT	cd_intervalo_w 
	from	intervalo_prescricao 
	where	ie_situacao = 'A' 
	and		coalesce(ie_acm,'N') = 'S' 
	and		((coalesce(cd_estabelecimento::text, '') = '') or (cd_estabelecimento = cd_estabelecimento_p)) 
	and		obter_se_intervalo_estab(cd_intervalo, cd_estabelecimento_p) = 'S' 
	and		obter_se_intervalo(cd_intervalo, 'G') = 'S' 
	and		obter_se_interv_regra(cd_intervalo, 'GAS') = 'S' 
	and		coalesce(ie_continuo, 'N') = CASE WHEN ie_modo_adm_p='I' THEN  'N' WHEN ie_modo_adm_p='C' THEN  'S' END;
elsif (ie_tipo_item_p = 'P') then 
	select	max(cd_intervalo) 
	into STRICT	cd_intervalo_w 
	from 	intervalo_prescricao 
	where	ie_situacao = 'A' 
	and		coalesce(ie_acm,'N') = 'S' 
	and 	obter_se_intervalo(cd_intervalo,'P') = 'S' 
	and 	cpoe_obter_se_exibe_interv( nr_atendimento_p, cd_estabelecimento_p, cd_intervalo, cd_perfil_p, nm_usuario_p) = 'S' 
	and 	((coalesce(cd_estabelecimento::text, '') = '') or (cd_estabelecimento = cd_estabelecimento_p));
end if;
 
return cd_intervalo_w;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION cpoe_obter_interv_acm ( nr_atendimento_p bigint, cd_item_p bigint, ie_modo_adm_p text, ie_tipo_item_p text, cd_estabelecimento_p bigint, cd_perfil_p bigint, nm_usuario_p text) FROM PUBLIC;

