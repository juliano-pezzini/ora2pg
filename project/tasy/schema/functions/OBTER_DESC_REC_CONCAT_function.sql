-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_desc_rec_concat (nr_seq_cardapio_dia_01_p bigint, nr_seq_cardapio_dia_02_p bigint, nr_seq_comp_p bigint, qt_pessoa_atend_p bigint) RETURNS varchar AS $body$
DECLARE

ds_receita_concat_w	varchar(255);
ds_receita_concat2_w	varchar(255);
/*	Neste cursor vamos obter as descri√ßoes das receitas a serem concatenadas;	*/

c01 CURSOR FOR
	SELECT 	SUBSTR(obter_descricao_padrao('NUT_RECEITA','DS_RECEITA',a.nr_seq_receita),1,80) ds_receita
	FROM	nut_cardapio a,
		nut_pac_opcao_rec b
	WHERE 	1 = 1
	AND	a.nr_seq_card_dia = nr_seq_cardapio_dia_01_p
	AND 	a.nr_seq_comp = nr_seq_comp_p
	AND	a.nr_sequencia = b.nr_seq_cardapio
	AND 	b.nr_seq_cardapio_dia = nr_seq_cardapio_dia_02_p;

BEGIN
	OPEN 	c01;
	LOOP
	FETCH 	c01 INTO
		ds_receita_concat_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
	BEGIN

		IF (coalesce(ds_receita_concat2_w::text, '') = '') THEN
			IF (coalesce(qt_pessoa_atend_p::text, '') = '') THEN
				ds_receita_concat2_w := ds_receita_concat_w;
			ELSE
				ds_receita_concat2_w := ds_receita_concat_w || ' ('  || qt_pessoa_atend_p || ')';
			END IF;
		ELSE
			IF (coalesce(qt_pessoa_atend_p::text, '') = '') THEN
				ds_receita_concat2_w := SUBSTR(ds_receita_concat2_w || ', ' || chr(13) || ds_receita_concat_w, 1, 255);
			ELSE
				ds_receita_concat2_w := SUBSTR(ds_receita_concat2_w || ', ' || chr(13) || ds_receita_concat_w || ' ('  || qt_pessoa_atend_p || ')', 1, 255);
			END IF;
		END IF;
	END;
	END LOOP;
	CLOSE 	c01;

RETURN	ds_receita_concat2_w;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_desc_rec_concat (nr_seq_cardapio_dia_01_p bigint, nr_seq_cardapio_dia_02_p bigint, nr_seq_comp_p bigint, qt_pessoa_atend_p bigint) FROM PUBLIC;

