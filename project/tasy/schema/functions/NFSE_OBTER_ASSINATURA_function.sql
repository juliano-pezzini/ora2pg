-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION nfse_obter_assinatura ( nr_interface_p bigint, nr_nota_fiscal_p bigint) RETURNS varchar AS $body$
DECLARE


/* 	campo, tamanho, exemplo
	01 - Inscricao municipal do contribuinte 11 00000317330
	02 - Serie do RPS 5 NF
	03 - Numero do RPS 12 000000038663
	04 - Data de Emissao do RPS formato yyyyMMdd 8 20090905
	05 - Tributacao 2 T
	06 - Situacao do RPS 1 N
	07 - Tipo Recolhimento, se for A preenche com N senao S 1 N
	08 - Valor do servico subtraindo a deducao 15 000000000001686
	09 - Valor da Deducao 15 000000000000000
	10 - Codigo da atividade 10 0829979900
	11- CPF/CNPJ do tomador 14 08764130000102
*/
ds_retorno_v		varchar(255);
cd_assinatura_v		varchar(255);
ie_cpf_cnpj_v		varchar(2);
ie_cnpj_intermed_v              	varchar(2);
cd_inscricao_municipal_v	varchar(255);
cd_serie_rps_v		varchar(255);
nr_rps_v			varchar(255);
dt_emissao_rps_v		varchar(255);
cd_tributacao_v		varchar(255);
cd_situacao_v		varchar(255);
cd_tipo_recolhimento_v	varchar(255);
vl_servico_rps_v		varchar(255);
vl_deducao_rps_v		varchar(255);
cd_cod_atividade_v	varchar(255);
cd_cpf_cnpj_v		varchar(255);
cd_cnpj_intermed_v	varchar(255);
ISSRetidoIntermediario_v	varchar(255);
ie_intermediario_v	varchar(1);


BEGIN

if (nr_interface_p = 100210) then -- campinas
	begin

	select	lpad(coalesce(substr(obter_dados_pf_pj('', a.cd_cgc_emitente,'IM'), 1, 30), '000000000'), 11, 0),
		rpad('NF', 5, ' '),
		lpad(a.nr_nota_fiscal, 12, 0),
		to_char(a.dt_emissao, 'yyyymmdd'),
		-- rpad(decode(obter_dados_parametro_compras(a.cd_estabelecimento, 14), '3', 'C', '4', 'F', 'K'), 2, ' '),
		rpad('T', 2 , ' '),
		-- decode((select count(*) from w_nota_fiscal), 1, 'N', 'L'),
		'N',	
		CASE WHEN			CASE WHEN cd_cgc='' THEN  'A'  ELSE CASE WHEN obter_se_pj_retem_iss(a.cd_cgc, a.cd_estabelecimento)='S' THEN  'R'  ELSE 'A' END  END ='A' THEN  			'N'  ELSE 'S' END , 
		lpad(obter_dados_pf_pj_estab(a.cd_estabelecimento, null, a.cd_cgc_emitente, 'ATIV'), 10, 0),	
		--lpad(decode(cd_cgc, '', decode(obter_se_brasileiro(cd_pessoa_fisica), 'N', '77777777777', nvl(substr(obter_dados_pf(cd_pessoa_fisica, 'CPF'), 1, 11), '00000000000')), cd_cgc), 14, 0)
		lpad(CASE WHEN cd_cgc='' THEN  CASE WHEN coalesce(obter_dados_pf(cd_pessoa_fisica, 'CPF')::text, '') = '' THEN  '77777777777'  ELSE coalesce(substr(obter_dados_pf(cd_pessoa_fisica, 'CPF'), 1, 11), '00000000000') END   ELSE cd_cgc END , 14, 0)
		-- lpad(decode(a.cd_cgc,'',nvl(substr(obter_dados_pf(a.cd_pessoa_fisica, 'CPF'), 1, 11), '00000000000000'), a.cd_cgc), 14, 0)
	into STRICT	cd_inscricao_municipal_v,
		cd_serie_rps_v,
		nr_rps_v,
		dt_emissao_rps_v,
		cd_tributacao_v,
		cd_situacao_v,
		cd_tipo_recolhimento_v,
		cd_cod_atividade_v,
		cd_cpf_cnpj_v
	from	w_nota_fiscal b,
		nota_fiscal a
	where  	b.nr_seq_nota_fiscal = a.nr_sequencia
	and	a.nr_sequencia = nr_nota_fiscal_p;

	/*
	select	lpad(replace(replace(campo_mascara(sum(a.vl_mercadoria), 2), '.', ''), ',', ''), 15, 0),
		lpad(replace(replace(campo_mascara(sum(a.vl_descontos), 2), '.', ''), ',', ''), 15, 0)
	*/
	select	lpad(replace(replace(campo_mascara(
			sum(
				CASE WHEN					coalesce(a.cd_cgc::text, '') = '' THEN  					a.vl_total_nota  ELSE CASE WHEN 						obter_tipo_convenio(Obter_convenio_atendimento(obter_nr_atendimento_nota(a.nr_sequencia)))=1 THEN  						a.vl_total_nota  ELSE a.vl_mercadoria END  END 	
			), 2), '.', ''), ',', ''), 15, 0),
	 	lpad(replace(replace(campo_mascara(sum(0), 2), '.', ''), ',', ''), 15, 0)
	into STRICT	vl_servico_rps_v,
		vl_deducao_rps_v
	from 	nota_fiscal a,
		w_nota_fiscal w,
		estabelecimento_v e
	where	a.nr_sequencia = w.nr_seq_nota_fiscal
	and	a.cd_cgc_emitente = e.cd_cgc
	and	a.nr_sequencia = nr_nota_fiscal_p
	group by
		a.cd_cgc_emitente;

		cd_assinatura_v	:=
		cd_inscricao_municipal_v ||
		cd_serie_rps_v ||
		nr_rps_v ||
		dt_emissao_rps_v ||
		cd_tributacao_v ||
		cd_situacao_v ||
		cd_tipo_recolhimento_v ||
		vl_servico_rps_v ||
		vl_deducao_rps_v ||
		cd_cod_atividade_v ||
		cd_cpf_cnpj_v;

	ds_retorno_v := cd_assinatura_v;

	end;
end if;

if (nr_interface_p = 100488) then -- campinas por itens
	begin

	select	lpad(coalesce(substr(obter_dados_pf_pj('', a.cd_cgc_emitente,'IM'), 1, 30), '000000000'), 9, 0),
		rpad('NF', 5, ' '),
		lpad(a.nr_nota_fiscal, 12, 0),
		to_char(a.dt_emissao, 'yyyymmdd'),		
		rpad('T', 2 , ' '),
		'N',	
		CASE WHEN CASE WHEN cd_cgc='' THEN  'A'  ELSE CASE WHEN obter_se_pj_retem_iss(a.cd_cgc, a.cd_estabelecimento)='S' THEN  'R'  ELSE 'A' END  END ='A' THEN  'N'  ELSE 'S' END ,
		lpad(obter_dados_pf_pj_estab(a.cd_estabelecimento, null, a.cd_cgc_emitente, 'ATIV'), 10, 0),		
		lpad(CASE WHEN cd_cgc='' THEN  CASE WHEN coalesce(obter_dados_pf(cd_pessoa_fisica, 'CPF')::text, '') = '' THEN  '77777777777'  ELSE coalesce(substr(obter_dados_pf(cd_pessoa_fisica, 'CPF'), 1, 11), '00000000000') END   ELSE cd_cgc END , 14, 0)
	into STRICT	cd_inscricao_municipal_v,
		cd_serie_rps_v,
		nr_rps_v,
		dt_emissao_rps_v,
		cd_tributacao_v,
		cd_situacao_v,
		cd_tipo_recolhimento_v,
		cd_cod_atividade_v,
		cd_cpf_cnpj_v
	from	w_nota_fiscal b,
		nota_fiscal a
	where  	b.nr_seq_nota_fiscal = a.nr_sequencia
	and	a.nr_sequencia = nr_nota_fiscal_p;
	
	select	lpad(elimina_caractere_especial(sum(b.vl_liquido)), 15, '0'),
		lpad(elimina_caractere_especial(0), 15, '0')
	into STRICT	vl_servico_rps_v,
		vl_deducao_rps_v
	from 	nota_fiscal a,
		nota_fiscal_item b,
		w_nota_fiscal w,
		estabelecimento_v e
	where	a.nr_sequencia = w.nr_seq_nota_fiscal
	and	a.nr_sequencia = b.nr_sequencia
	and	a.cd_cgc_emitente = e.cd_cgc
	and	coalesce(b.cd_material::text, '') = ''
	and	a.nr_sequencia = nr_nota_fiscal_p
	and	b.cd_estabelecimento = e.cd_estabelecimento
	group by
		a.cd_cgc_emitente;

	cd_assinatura_v	:=
		cd_inscricao_municipal_v ||
		cd_serie_rps_v ||
		nr_rps_v ||
		dt_emissao_rps_v ||
		cd_tributacao_v ||
		cd_situacao_v ||
		cd_tipo_recolhimento_v ||
		vl_servico_rps_v ||
		vl_deducao_rps_v ||
		cd_cod_atividade_v ||
		cd_cpf_cnpj_v;

	ds_retorno_v := cd_assinatura_v;

	end;
end if;


if (nr_interface_p = 100468) then -- Sao Paulo
	begin

	select	lpad(coalesce(substr(obter_dados_pf_pj('', a.cd_cgc_emitente,'IM'), 1, 30), '00000000'), 8, 0),
		substr(rpad(a.cd_serie_nf, 5, ' '), 1, 5),
		lpad(a.nr_nota_fiscal, 12, 0),
		to_char(a.dt_emissao, 'yyyymmdd'),
		CASE WHEN coalesce(obter_dados_natureza_operacao(a.cd_natureza_operacao,'ISS')::text, '') = '' THEN CASE WHEN obter_dados_parametro_compras(a.cd_estabelecimento,14)='1' THEN 'T' WHEN obter_dados_parametro_compras(a.cd_estabelecimento,14)='2' THEN 'F' WHEN obter_dados_parametro_compras(a.cd_estabelecimento,14)='3' THEN 'I' WHEN obter_dados_parametro_compras(a.cd_estabelecimento,14)='5' THEN 'J'  ELSE 'I' END   ELSE obter_dados_natureza_operacao(a.cd_natureza_operacao,'ISS') END ,
		CASE WHEN a.ie_situacao=1 THEN  'N' WHEN a.ie_situacao=2 THEN  'C' WHEN a.ie_situacao=3 THEN  'C'  ELSE 'N' END ,	
		CASE WHEN substr(obter_se_nf_retem_iss(a.nr_sequencia),1,1)='S' THEN 'S'  ELSE 'N' END ,
		substr(lpad(obter_cod_grupo_ativ(a.cd_estabelecimento, a.nr_sequencia, 'C'), 5, '0'), 1, 5),
		--decode(cd_cgc, '', decode(obter_se_brasileiro(cd_pessoa_fisica), 'N', 3, 1), 2),

		--lpad(decode(cd_cgc, '', decode(obter_se_brasileiro(cd_pessoa_fisica), 'N', '0', nvl(substr(obter_dados_pf(cd_pessoa_fisica, 'CPF'), 1, 11), '00000000000000')), cd_cgc), 14, 0)
		CASE WHEN nfse_obter_se_brasileiro(cd_pessoa_fisica, cd_cgc)='N' THEN  3  ELSE CASE WHEN cd_cgc='' THEN  1  ELSE 2 END  END ,
		lpad(CASE WHEN nfse_obter_se_brasileiro(cd_pessoa_fisica, cd_cgc)='N' THEN  '0'  ELSE CASE WHEN cd_cgc='' THEN  coalesce(substr(obter_dados_pf(cd_pessoa_fisica, 'CPF'), 1, 11), '0')  ELSE cd_cgc END  END , 14, 0),
		CASE WHEN obter_cgc_convenio(obter_convenio_nf(a.nr_sequencia)) IS NULL THEN null  ELSE 2 END  ie_cnpj_intermed,	
		substr(obter_cgc_convenio(obter_convenio_nf(a.nr_sequencia)),1,14) cd_cnpj_intermed,
		CASE
		WHEN(coalesce(obter_dados_pf_pj(null,obter_cgc_convenio(obter_convenio_nf(a.nr_sequencia)),'CDM'),0) = 355030) and (CASE WHEN obter_dados_parametro_compras(a.cd_estabelecimento,14)='1' THEN 'T' WHEN obter_dados_parametro_compras(a.cd_estabelecimento,14)='2' THEN 'F' WHEN obter_dados_parametro_compras(a.cd_estabelecimento,14)='3' THEN 'I' WHEN obter_dados_parametro_compras(a.cd_estabelecimento,14)='5' THEN 'J'  ELSE 'I' END  = 'I') THEN
			'false'
		ELSE
			CASE WHEN obter_dados_pf_pj(null,obter_cgc_convenio(obter_convenio_nf(a.nr_sequencia)),'CDM')=355030 THEN  'true' WHEN obter_dados_pf_pj(null,obter_cgc_convenio(obter_convenio_nf(a.nr_sequencia)),'CDM')='' THEN  ''  ELSE 'false' END
		END AS ISSRetidoIntermediario
	into STRICT	cd_inscricao_municipal_v,
		cd_serie_rps_v,
		nr_rps_v,
		dt_emissao_rps_v,
		cd_tributacao_v,
		cd_situacao_v,
		cd_tipo_recolhimento_v,
		cd_cod_atividade_v,
		ie_cpf_cnpj_v,
		cd_cpf_cnpj_v,
		ie_cnpj_intermed_v,
		cd_cnpj_intermed_v,
		ISSRetidoIntermediario_v
	from	nota_fiscal a
	where  	a.nr_sequencia = nr_nota_fiscal_p;
	
	if (coalesce(ISSRetidoIntermediario_v,'N') = 'true')  then
		begin
		ISSRetidoIntermediario_v := 'S';
		end;
	elsif (coalesce(ISSRetidoIntermediario_v,'N') = 'false')  then
		begin
		ISSRetidoIntermediario_v := 'N';
		end;
	else
		begin
		ISSRetidoIntermediario_v := '';
		end;
	end if;
	
	/*
	select	lpad(replace(replace(campo_mascara(sum(a.vl_mercadoria), 2), '.', ''), ',', ''), 15, 0),
		lpad(replace(replace(campo_mascara(sum(a.vl_descontos), 2), '.', ''), ',', ''), 15, 0)
	*/
	select	--lpad(elimina_caractere_especial(campo_mascara(vl_total_nota,2)), 15, '0'),
		lpad(elimina_caractere_especial(campo_mascara((vl_mercadoria - vl_descontos),2)), 15, '0'),
		--lpad(elimina_caractere_especial(campo_mascara(vl_descontos, 2)), 15, '0')
		lpad(elimina_caractere_especial(campo_mascara(0, 2)), 15, '0')
	into	vl_servico_rps_v,
		vl_deducao_rps_v
	from	nota_fiscal a
	where  	a.nr_sequencia = nr_nota_fiscal_p;

	cd_assinatura_v	:=
		cd_inscricao_municipal_v ||
		substr(rpad(cd_serie_rps_v, 5, ' '), 1, 5) ||
		nr_rps_v ||
		dt_emissao_rps_v ||
		cd_tributacao_v ||
		cd_situacao_v ||
		cd_tipo_recolhimento_v ||
		vl_servico_rps_v ||
		vl_deducao_rps_v ||
		cd_cod_atividade_v ||
		ie_cpf_cnpj_v ||
		cd_cpf_cnpj_v;

		ds_retorno_v := cd_assinatura_v;

	end;
end if;

if (nr_interface_p = 101428) then
	begin
	
	select	lpad(coalesce(substr(obter_dados_pf_pj('', a.cd_cgc_emitente,'IM'), 1, 30), '00000000'), 8, 0),
		substr(rpad(a.cd_serie_nf, 5, ' '), 1, 5),
		lpad(a.nr_nota_fiscal, 12, 0),
		to_char(a.dt_emissao, 'yyyymmdd'),
		CASE WHEN coalesce(obter_dados_natureza_operacao(a.cd_natureza_operacao,'ISS')::text, '') = '' THEN CASE WHEN obter_dados_parametro_compras(a.cd_estabelecimento,14)='1' THEN 'T' WHEN obter_dados_parametro_compras(a.cd_estabelecimento,14)='2' THEN 'F' WHEN obter_dados_parametro_compras(a.cd_estabelecimento,14)='3' THEN 'I' WHEN obter_dados_parametro_compras(a.cd_estabelecimento,14)='5' THEN 'J'  ELSE 'I' END   ELSE obter_dados_natureza_operacao(a.cd_natureza_operacao,'ISS') END  ,
		CASE WHEN a.ie_situacao=1 THEN  'N' WHEN a.ie_situacao=2 THEN  'C' WHEN a.ie_situacao=3 THEN  'C'  ELSE 'N' END ,	
		CASE WHEN obter_se_tomador_intermed(a.nr_sequencia)='C' THEN 'N'  ELSE CASE WHEN substr(obter_se_nf_retem_iss(a.nr_sequencia),1,1)='S' THEN 'S'  ELSE 'N' END  END ,
		substr(lpad(obter_cod_grupo_ativ(a.cd_estabelecimento,a.nr_sequencia,'C'),5,'0'),1,5),
		--lpad(obter_dados_pf_pj_estab(a.cd_estabelecimento, null, a.cd_cgc_emitente, 'ATIV'), 5, 0),
		CASE WHEN obter_se_tomador_intermed(a.nr_sequencia)='S' THEN		CASE WHEN nfse_obter_se_brasileiro(cd_pessoa_fisica, cd_cgc)='N' THEN  3  ELSE CASE WHEN cd_cgc='' THEN  1  ELSE 2 END  END  WHEN obter_se_tomador_intermed(a.nr_sequencia)='C' THEN CASE WHEN coalesce(obter_dados_tomador_conta(a.nr_sequencia,'C','CPF')::text, '') = '' THEN 3  ELSE 1 END   ELSE 3 END ,
		CASE WHEN obter_se_tomador_intermed(a.nr_sequencia)='S' THEN 		lpad(CASE WHEN nfse_obter_se_brasileiro(cd_pessoa_fisica, cd_cgc)='N' THEN  '0'  ELSE CASE WHEN cd_cgc='' THEN  coalesce(substr(obter_dados_pf(cd_pessoa_fisica, 'CPF'), 1, 11), '0')  ELSE cd_cgc END  END , 14, 0) WHEN obter_se_tomador_intermed(a.nr_sequencia)='C' THEN lpad(CASE WHEN nfse_obter_se_brasileiro(obter_dados_tomador_conta(a.nr_sequencia,'C','CF'), null)='N' THEN  '0'  ELSE coalesce(substr(obter_dados_pf(obter_dados_tomador_conta(a.nr_sequencia,'C','CF'), 'CPF'), 1, 11), '0') END ,14,0)		  ELSE lpad(0,14,0) END ,
		CASE WHEN fis_obter_se_intermediario(a.nr_sequencia)='N' THEN ''   ELSE CASE WHEN greatest(length(fis_obter_dados_intermediario(a.nr_sequencia,'S','CI')),'13')=14 THEN  '2'  ELSE '1' END  END  ie_cnpj_intermed,	
		CASE WHEN fis_obter_se_intermediario(a.nr_sequencia)='N' THEN ''  ELSE lpad(fis_obter_dados_intermediario(a.nr_sequencia,'S','CI'),14,0) END  cd_cnpj_intermed,   
		CASE WHEN fis_obter_se_intermediario(a.nr_sequencia)='N' THEN null  ELSE coalesce(CASE WHEN fis_obter_dados_intermediario(a.nr_sequencia,'S','RI')='S' THEN 'S'  ELSE 'N' END ,'N') END  ISSRetidoIntermediario
		
	into STRICT	cd_inscricao_municipal_v,
		cd_serie_rps_v,
		nr_rps_v,
		dt_emissao_rps_v,
		cd_tributacao_v,
		cd_situacao_v,
		cd_tipo_recolhimento_v,
		cd_cod_atividade_v,
		ie_cpf_cnpj_v,
		cd_cpf_cnpj_v,
		ie_cnpj_intermed_v,
		cd_cnpj_intermed_v,
		ISSRetidoIntermediario_v
	from	nota_fiscal a
	where  	a.nr_sequencia = nr_nota_fiscal_p;
	
	select	lpad(elimina_caractere_especial(campo_mascara((a.vl_mercadoria - a.vl_descontos),2)), 15, '0'),
		lpad(elimina_caractere_especial(campo_mascara(0, 2)), 15, '0')
	into STRICT	vl_servico_rps_v,
		vl_deducao_rps_v
	from	nota_fiscal a
	where  	a.nr_sequencia = nr_nota_fiscal_p;

	cd_assinatura_v	:=
		cd_inscricao_municipal_v ||
		cd_serie_rps_v ||
		nr_rps_v ||
		dt_emissao_rps_v ||
		cd_tributacao_v ||
		cd_situacao_v ||
		cd_tipo_recolhimento_v ||
		vl_servico_rps_v ||
		vl_deducao_rps_v ||
		cd_cod_atividade_v ||
		ie_cpf_cnpj_v ||
		cd_cpf_cnpj_v ||
		ie_cnpj_intermed_v ||
		cd_cnpj_intermed_v ||
		ISSRetidoIntermediario_v;

	ds_retorno_v := cd_assinatura_v;
	
	end;
end if;

if (nr_interface_p = 100498) then -- Sao Paulo Cancelamento
	begin

	select	lpad(coalesce(substr(obter_dados_pf_pj('', a.cd_cgc_emitente,'IM'), 1, 30), '00000000'), 8, 0),
		lpad(a.nr_nfe_imp, 12, 0)
	into STRICT	cd_inscricao_municipal_v,
		nr_rps_v
	from	nota_fiscal a
	where  	a.nr_sequencia = nr_nota_fiscal_p;


	cd_assinatura_v	:=
		cd_inscricao_municipal_v ||
		nr_rps_v;

	ds_retorno_v := cd_assinatura_v;

	end;
end if;

if (nr_interface_p = 100602) then -- Blumenau
	begin

	select	lpad(coalesce(substr(obter_dados_pf_pj('', a.cd_cgc_emitente,'IM'), 1, 30), '00000000'), 8, 0),
		substr(rpad(a.cd_serie_nf, 5, ' '), 1, 5),
		lpad(a.nr_nota_fiscal, 12, 0),
		to_char(a.dt_emissao, 'yyyymmdd'),
		CASE WHEN obter_dados_parametro_compras(a.cd_estabelecimento, 14)='1' THEN  'T' WHEN obter_dados_parametro_compras(a.cd_estabelecimento, 14)='2' THEN  'F' WHEN obter_dados_parametro_compras(a.cd_estabelecimento, 14)='3' THEN  'I' WHEN obter_dados_parametro_compras(a.cd_estabelecimento, 14)='5' THEN  'J'  ELSE 'I' END ,
		CASE WHEN a.ie_situacao=1 THEN  'N' WHEN a.ie_situacao=2 THEN  'C' WHEN a.ie_situacao=3 THEN  'C'  ELSE 'N' END ,	
		CASE WHEN substr(obter_se_nf_retem_iss(a.nr_sequencia),1,1)='S' THEN 'S'  ELSE 'N' END ,
		lpad(obter_dados_pf_pj_estab(a.cd_estabelecimento, null, a.cd_cgc_emitente, 'ATIV'), 5, 0),	
		--decode(cd_cgc, '', decode(obter_se_brasileiro(cd_pessoa_fisica), 'N', 3, 1), 2),

		--lpad(decode(cd_cgc, '', decode(obter_se_brasileiro(cd_pessoa_fisica), 'N', '0', nvl(substr(obter_dados_pf(cd_pessoa_fisica, 'CPF'), 1, 11), '00000000000000')), cd_cgc), 14, 0)
		CASE WHEN nfse_obter_se_brasileiro(cd_pessoa_fisica, cd_cgc)='N' THEN  3  ELSE CASE WHEN cd_cgc='' THEN  1  ELSE 2 END  END ,
		lpad(CASE WHEN nfse_obter_se_brasileiro(cd_pessoa_fisica, cd_cgc)='N' THEN  '0'  ELSE CASE WHEN cd_cgc='' THEN  coalesce(substr(obter_dados_pf(cd_pessoa_fisica, 'CPF'), 1, 11), '0')  ELSE cd_cgc END  END , 14, 0)
	into STRICT	cd_inscricao_municipal_v,
		cd_serie_rps_v,
		nr_rps_v,
		dt_emissao_rps_v,
		cd_tributacao_v,
		cd_situacao_v,
		cd_tipo_recolhimento_v,
		cd_cod_atividade_v,
		ie_cpf_cnpj_v,
		cd_cpf_cnpj_v
	from	nota_fiscal a
	where  	a.nr_sequencia = nr_nota_fiscal_p;

	/*
	select	lpad(replace(replace(campo_mascara(sum(a.vl_mercadoria), 2), '.', ''), ',', ''), 15, 0),
		lpad(replace(replace(campo_mascara(sum(a.vl_descontos), 2), '.', ''), ',', ''), 15, 0)
	*/
	select	lpad(elimina_caractere_especial(campo_mascara(vl_total_nota,2)), 15, '0'),
		lpad(elimina_caractere_especial(campo_mascara(vl_descontos, 2)), 15, '0')
	into STRICT	vl_servico_rps_v,
		vl_deducao_rps_v
	from	nota_fiscal a
	where  	a.nr_sequencia = nr_nota_fiscal_p;

	cd_assinatura_v	:=
		cd_inscricao_municipal_v ||
		cd_serie_rps_v ||
		nr_rps_v ||
		dt_emissao_rps_v ||
		cd_tributacao_v ||
		cd_situacao_v ||
		cd_tipo_recolhimento_v ||
		vl_servico_rps_v ||
		vl_deducao_rps_v ||
		cd_cod_atividade_v ||
		ie_cpf_cnpj_v ||
		cd_cpf_cnpj_v;

	ds_retorno_v := cd_assinatura_v;

	end;
end if;

if (nr_interface_p = 100614) then -- Sao Luis por itens metodo novo.
	begin

	select	lpad(coalesce(substr(obter_dados_pf_pj('', a.cd_cgc_emitente,'IM'), 1, 30), '0000000'), 11, 0),
		rpad('NF', 5, ' '),
		lpad(a.nr_nota_fiscal, 12, 0),
		to_char(a.dt_emissao, 'yyyymmdd'),		
		--rpad(decode(obter_dados_parametro_compras(a.cd_estabelecimento,14), '1', 'T', '2', 'T', '3', 'C', '4', 'F', 'K'), 2 , ' '),
		rpad(CASE WHEN nfse_obter_regra('TP',a.cd_estabelecimento)='1' THEN  'T' WHEN nfse_obter_regra('TP',a.cd_estabelecimento)='2' THEN  'T' WHEN nfse_obter_regra('TP',a.cd_estabelecimento)='3' THEN  'C' WHEN nfse_obter_regra('TP',a.cd_estabelecimento)='4' THEN  'F' WHEN nfse_obter_regra('TP',a.cd_estabelecimento)='T' THEN  'T' WHEN nfse_obter_regra('TP',a.cd_estabelecimento)='C' THEN 'C'  WHEN nfse_obter_regra('TP',a.cd_estabelecimento)='F' THEN 'F' WHEN nfse_obter_regra('TP',a.cd_estabelecimento)='G' THEN 'G' WHEN nfse_obter_regra('TP',a.cd_estabelecimento)='H' THEN 'H' WHEN nfse_obter_regra('TP',a.cd_estabelecimento)='M' THEN 'M'  ELSE 'K' END ,2,' '),
		'N',	
		CASE WHEN CASE WHEN cd_cgc='' THEN  'A'  ELSE CASE WHEN obter_se_pj_retem_iss(a.cd_cgc, a.cd_estabelecimento)='S' THEN  'R'  ELSE 'A' END  END ='A' THEN 'N'  ELSE 'S' END ,
		lpad(obter_dados_pf_pj_estab(a.cd_estabelecimento, null, a.cd_cgc_emitente, 'ATIV'), 10, 0),	
		--lpad(decode(cd_cgc, '', decode(obter_se_brasileiro(cd_pessoa_fisica), 'N', '77777777777', nvl(substr(obter_dados_pf(cd_pessoa_fisica, 'CPF'), 1, 11), '00000000000')), cd_cgc), 14, 0)

		--lpad(decode(cd_cgc, '', decode(obter_se_brasileiro(cd_pessoa_fisica), 'N', '77777777777', nvl(substr(obter_dados_pf(cd_pessoa_fisica, 'CPF'), 1, 11), '00000000000')), decode(obter_se_pf_pj_estrangeiro(null,cd_cgc),'N',cd_cgc,'77777777777')),14,0)
		lpad(CASE WHEN cd_cgc='' THEN  CASE WHEN coalesce(obter_dados_pf(cd_pessoa_fisica, 'CPF')::text, '') = '' THEN  '77777777777'  ELSE coalesce(substr(obter_dados_pf(cd_pessoa_fisica, 'CPF'), 1, 11), '00000000000') END   ELSE cd_cgc END ,14,0)
	into STRICT	cd_inscricao_municipal_v,
		cd_serie_rps_v,
		nr_rps_v,
		dt_emissao_rps_v,
		cd_tributacao_v,
		cd_situacao_v,
		cd_tipo_recolhimento_v,
		cd_cod_atividade_v,
		cd_cpf_cnpj_v
	from	nota_fiscal a
	where  	a.nr_sequencia = nr_nota_fiscal_p;
	
	select	lpad(elimina_caractere_especial(campo_mascara(a.vl_mercadoria,2)), 15,'0'),
		lpad(elimina_caractere_especial(campo_mascara(a.vl_descontos,2)), 15, '0')
	into STRICT	vl_servico_rps_v,
		vl_deducao_rps_v
	from 	nota_fiscal a,
		nota_fiscal_item b
	where	a.nr_sequencia = b.nr_sequencia
	and	a.nr_sequencia = nr_nota_fiscal_p;

	cd_assinatura_v	:=
		cd_inscricao_municipal_v ||
		cd_serie_rps_v ||
		nr_rps_v ||
		dt_emissao_rps_v ||
		cd_tributacao_v ||
		cd_situacao_v ||
		cd_tipo_recolhimento_v ||
		vl_servico_rps_v ||
		vl_deducao_rps_v ||
		cd_cod_atividade_v ||
		cd_cpf_cnpj_v;

	ds_retorno_v := cd_assinatura_v;

	end;
end if;



if (nr_interface_p = 100716) then -- Assintatura DSFnet
	begin

	select	lpad(coalesce(substr(obter_dados_pf_pj('', a.cd_cgc_emitente,'IM'), 1, 30), '0000000'), 11, 0),
		rpad('NF', 5, ' '),
		lpad(a.nr_nota_fiscal, 12, 0),
		to_char(a.dt_emissao, 'yyyymmdd'),
		rpad(CASE WHEN nfse_obter_regra('TP',a.cd_estabelecimento)='1' THEN  'T' WHEN nfse_obter_regra('TP',a.cd_estabelecimento)='2' THEN  'T' WHEN nfse_obter_regra('TP',a.cd_estabelecimento)='3' THEN  'C' WHEN nfse_obter_regra('TP',a.cd_estabelecimento)='4' THEN  'F' WHEN nfse_obter_regra('TP',a.cd_estabelecimento)='T' THEN  'T' WHEN nfse_obter_regra('TP',a.cd_estabelecimento)='C' THEN 'C'  WHEN nfse_obter_regra('TP',a.cd_estabelecimento)='F' THEN 'F' WHEN nfse_obter_regra('TP',a.cd_estabelecimento)='G' THEN 'G' WHEN nfse_obter_regra('TP',a.cd_estabelecimento)='H' THEN 'H' WHEN nfse_obter_regra('TP',a.cd_estabelecimento)='M' THEN 'M'  ELSE 'K' END ,2,' '),			
		'N',	
		CASE WHEN CASE WHEN cd_cgc='' THEN  'A'  ELSE CASE WHEN obter_se_pj_retem_iss(a.cd_cgc, a.cd_estabelecimento)='S' THEN  'R'  ELSE 'A' END  END ='A' THEN 'N'  ELSE 'S' END ,
		lpad(obter_cod_grupo_ativ(a.cd_estabelecimento, a.nr_sequencia, 'C'),10,0),
		/*lpad(nvl(nvl(obter_dados_grupo_servico_item(obter_item_servico_proced(obter_procedimento_nfse(a.nr_sequencia,'P'), obter_procedimento_nfse(a.nr_sequencia,'O')), 'P'),
			obter_dados_grupo_servico_item(obter_item_servico_proced(obter_procedimento_nfse(a.nr_sequencia,'P'), obter_procedimento_nfse(a.nr_sequencia,'O')), 'CD')),
			obter_dados_pf_pj_estab(a.cd_estabelecimento, NULL, a.cd_cgc_emitente, 'ATIV')),10,0),*/

		--lpad(nvl(obter_dados_grupo_servico_item(obter_item_servico_proced(obter_procedimento_nfse(a.nr_sequencia,'P'), obter_procedimento_nfse(a.nr_sequencia,'O')), 'CD'), obter_dados_pf_pj_estab(a.cd_estabelecimento, NULL, a.cd_cgc_emitente, 'ATIV')),10,0),

		--lpad(obter_dados_pf_pj_estab(a.cd_estabelecimento, null, a.cd_cgc_emitente, 'ATIV'), 10, 0),	

		--lpad(decode(cd_cgc, '', decode(obter_se_brasileiro(cd_pessoa_fisica), 'N', '77777777777', nvl(substr(obter_dados_pf(cd_pessoa_fisica, 'CPF'), 1, 11), '00000000000')), cd_cgc), 14, 0)	
		lpad(CASE WHEN cd_cgc='' THEN  CASE WHEN coalesce(obter_dados_pf(cd_pessoa_fisica, 'CPF')::text, '') = '' THEN  '99999999999'  ELSE coalesce(substr(obter_dados_pf(cd_pessoa_fisica, 'CPF'), 1, 11), '00000000000') END   ELSE cd_cgc END ,14,0)
	into STRICT	cd_inscricao_municipal_v,
		cd_serie_rps_v,
		nr_rps_v,
		dt_emissao_rps_v,
		cd_tributacao_v,
		cd_situacao_v,
		cd_tipo_recolhimento_v,
		cd_cod_atividade_v,
		cd_cpf_cnpj_v
	from	nota_fiscal a
	where  	a.nr_sequencia = nr_nota_fiscal_p;
	
	select	lpad(elimina_caractere_especial(campo_mascara(obter_vl_servicos_nf(a.nr_sequencia),2)), 15,'0'),
		lpad(elimina_caractere_especial(campo_mascara(a.vl_descontos,2)), 15, '0')
	into STRICT	vl_servico_rps_v,
		vl_deducao_rps_v
	from 	nota_fiscal a
	where	a.nr_sequencia = nr_nota_fiscal_p;

	cd_assinatura_v	:=
		cd_inscricao_municipal_v ||
		cd_serie_rps_v ||
		nr_rps_v ||
		dt_emissao_rps_v ||
		cd_tributacao_v ||
		cd_situacao_v ||
		cd_tipo_recolhimento_v ||
		vl_servico_rps_v ||
		vl_deducao_rps_v ||
		cd_cod_atividade_v ||
		cd_cpf_cnpj_v;

	ds_retorno_v := cd_assinatura_v;

	end;
end if;


if (nr_interface_p = 101520) then -- Assintatura DSFnet 2.0 - Campo Grande
	begin

	select	lpad(coalesce(substr(obter_dados_pf_pj('', a.cd_cgc_emitente,'IM'), 1, 30), '00000000000'), 11, 0),
		rpad('NF', 5, ' '),
		lpad(a.nr_nota_fiscal, 12, 0),
		to_char(a.dt_emissao, 'yyyymmdd'),
		rpad(substr(nfse_obter_regra('TP',a.cd_estabelecimento),1,2),2,' '),		
		'N',	
		CASE WHEN CASE WHEN cd_cgc='' THEN  'A'  ELSE CASE WHEN obter_se_pj_retem_iss(a.cd_cgc, a.cd_estabelecimento)='S' THEN  'R'  ELSE 'A' END  END ='A' THEN 'N'  ELSE 'S' END ,
		lpad(coalesce(coalesce(obter_dados_grupo_servico_item(obter_item_servico_proced(obter_procedimento_nfse(a.nr_sequencia,'P'), obter_procedimento_nfse(a.nr_sequencia,'O')), 'P'),
			obter_dados_grupo_servico_item(obter_item_servico_proced(obter_procedimento_nfse(a.nr_sequencia,'P'), obter_procedimento_nfse(a.nr_sequencia,'O')), 'CD')),
			obter_dados_pf_pj_estab(a.cd_estabelecimento, NULL, a.cd_cgc_emitente, 'ATIV')), 10, '0'),
		lpad(CASE WHEN cd_cgc='' THEN  CASE WHEN coalesce(obter_dados_pf(cd_pessoa_fisica, 'CPF')::text, '') = '' THEN  '99999999999'  ELSE coalesce(substr(obter_dados_pf(cd_pessoa_fisica, 'CPF'), 1, 11), '00000000000') END   ELSE cd_cgc END ,14,0)
	into STRICT	cd_inscricao_municipal_v,
		cd_serie_rps_v,
		nr_rps_v,
		dt_emissao_rps_v,
		cd_tributacao_v,
		cd_situacao_v,
		cd_tipo_recolhimento_v,
		cd_cod_atividade_v,
		cd_cpf_cnpj_v
	from	nota_fiscal a
	where  	a.nr_sequencia = nr_nota_fiscal_p;
	
	select	lpad(elimina_caractere_especial(campo_mascara(a.vl_total_nota,2)), 15,'0'),
		lpad(elimina_caractere_especial(campo_mascara(a.vl_descontos,2)), 15, '0')
	into STRICT	vl_servico_rps_v,
		vl_deducao_rps_v
	from 	nota_fiscal a
	where	a.nr_sequencia = nr_nota_fiscal_p;

	cd_assinatura_v	:=
		cd_inscricao_municipal_v ||
		cd_serie_rps_v ||
		nr_rps_v ||
		dt_emissao_rps_v ||
		cd_tributacao_v ||
		cd_situacao_v ||
		cd_tipo_recolhimento_v ||
		vl_servico_rps_v ||
		vl_deducao_rps_v ||
		cd_cod_atividade_v ||
		cd_cpf_cnpj_v;

	ds_retorno_v := cd_assinatura_v;

	end;
end if;


if (nr_interface_p = 102290) then -- Assintatura DSFnet 2.0 - Uberlandia
	begin

	select	lpad(coalesce(substr(obter_dados_pf_pj('', a.cd_cgc_emitente,'IM'), 1, 30), '00000000000'), 11, 0),
		rpad('NF', 5, ' '),
		lpad(a.nr_nota_fiscal, 12, 0),
		to_char(a.dt_emissao, 'yyyymmdd'),
		rpad(substr(nfse_obter_regra('TP',a.cd_estabelecimento),1,2),2,' '),		
		'N',	
		CASE WHEN CASE WHEN cd_cgc='' THEN  'A'  ELSE CASE WHEN obter_se_pj_retem_iss(a.cd_cgc, a.cd_estabelecimento)='S' THEN  'R'  ELSE 'A' END  END ='A' THEN 'N'  ELSE 'S' END ,
		substr(lpad(obter_cod_grupo_ativ(a.cd_estabelecimento,a.nr_sequencia,'C'),10,'0'),1,10),
		lpad(CASE WHEN cd_cgc='' THEN  CASE WHEN coalesce(obter_dados_pf(cd_pessoa_fisica, 'CPF')::text, '') = '' THEN  '99999999999'  ELSE coalesce(substr(obter_dados_pf(cd_pessoa_fisica, 'CPF'), 1, 11), '00000000000') END   ELSE cd_cgc END ,14,0)
	into STRICT	cd_inscricao_municipal_v,
		cd_serie_rps_v,
		nr_rps_v,
		dt_emissao_rps_v,
		cd_tributacao_v,
		cd_situacao_v,
		cd_tipo_recolhimento_v,
		cd_cod_atividade_v,
		cd_cpf_cnpj_v
	from	nota_fiscal a
	where  	a.nr_sequencia = nr_nota_fiscal_p;
	
	select	lpad(elimina_caractere_especial(campo_mascara(a.vl_total_nota,2)), 15,'0'),
		lpad(elimina_caractere_especial(campo_mascara(a.vl_descontos,2)), 15, '0')
	into STRICT	vl_servico_rps_v,
		vl_deducao_rps_v
	from 	nota_fiscal a
	where	a.nr_sequencia = nr_nota_fiscal_p;

	cd_assinatura_v	:=
		cd_inscricao_municipal_v ||
		cd_serie_rps_v ||
		nr_rps_v ||
		dt_emissao_rps_v ||
		cd_tributacao_v ||
		cd_situacao_v ||
		cd_tipo_recolhimento_v ||
		vl_servico_rps_v ||
		vl_deducao_rps_v ||
		cd_cod_atividade_v ||
		cd_cpf_cnpj_v;

	ds_retorno_v := cd_assinatura_v;

	end;
end if;

if (nr_interface_p = 101788) then -- NFS-e Sao Paulo/SP Envio de Lote RPS (INTERMEDIARIO)
	
	begin		
		select	max(ds_assinatura)
		into STRICT	cd_assinatura_v
		from	nfse_sp_novo_modelo_v2 a
		where  	a.nr_sequencia = nr_nota_fiscal_p;

		ds_retorno_v := cd_assinatura_v;

	end;
	
end if;

return	ds_retorno_v;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION nfse_obter_assinatura ( nr_interface_p bigint, nr_nota_fiscal_p bigint) FROM PUBLIC;

