-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_valores_caixa_rec ( nr_seq_caixa_rec_p bigint, ie_opcao_p text) RETURNS bigint AS $body$
DECLARE


dt_cancelamento_receb_w		timestamp;
ie_tipo_receb_w			varchar(1);
vl_especie_w			double precision;
vl_cheques_w			double precision;
vl_cheque_vista_w			double precision;
vl_cheque_pre_w			double precision;
vl_cartao_w			double precision;
vl_pix_w			 pix_cobranca.vl_original%type;
vl_recebido_w			double precision;
vl_juros_w			double precision;
vl_multa_w			double precision;
vl_desp_bancaria_w		double precision;
vl_descontos_w			double precision;
vl_total_w			double precision;
vl_retorno_w			double precision;
vl_adiantamento_w			double precision;
vl_transacao_w			double precision;
vl_terceiro_w			double precision;
vl_tot_vinc_adiant_w		double precision;
vl_baixa_adiant_w			double precision;
vl_negociado_w			double precision;
vl_desconto_w			double precision;
vl_acrescimo_w			double precision;
vl_baixa_perda_w			double precision;
vl_glosa_w			double precision;
vl_outros_acrescimos_w		double precision;
vl_cartao_cr_w			double precision;
vl_cartao_debito_w			double precision;
vl_juros_cheque_w			double precision;
vl_multa_cheque_w			double precision;
vl_rec_maior_w			double precision;
vl_troco_informado_w		double precision;
ie_acao_w			varchar(10);
cd_tipo_receb_caixa_w		integer;
vl_desconto_negociado_w		cheque_cr_negociado.vl_desconto%type;	
/* Projeto Multimoeda - Variaveis */

vl_especie_conv_w		double precision;
ie_troca_valores_w		varchar(1) := 'N';
vl_troca_valores_w		double precision := 0;
vl_deposito_direto_w		caixa_receb.vl_deposito_direto%type;

qt_reg_w			bigint;
qt_movto_w			bigint;


BEGIN
select	coalesce(vl_especie,0),
	coalesce(ie_tipo_receb,'R'),
	dt_cancelamento,
	cd_tipo_receb_caixa,
	coalesce(vl_troco_informado,0),
	coalesce(vl_deposito_direto,0)
into STRICT	vl_especie_w,
	ie_tipo_receb_w,
	dt_cancelamento_receb_w,
	cd_tipo_receb_caixa_w,
	vl_troco_informado_w,
	vl_deposito_direto_w
from	caixa_receb
where	nr_sequencia		= nr_seq_caixa_rec_p;

select	coalesce(sum(vl_especie),0)
into STRICT	vl_especie_conv_w
from	caixa_receb_estrang
where	nr_seq_caixa_receb = nr_seq_caixa_rec_p;

/* Projeto Multimoeda - Quando houver recebimento em especie em moeda estrangeira, soma os valores recebidos convertidos ao valor
	em especie para compor os valores recebidos pelo caixa. */
if coalesce(vl_especie_conv_w,0) <> 0 then
	vl_especie_w := vl_especie_w + vl_especie_conv_w;
end if;

if (coalesce(cd_tipo_receb_caixa_w,0) <> 0) then
	select	max(ie_acao_rec_caixa)
	into STRICT	ie_acao_w
	from	tipo_recebimento
	where	cd_tipo_recebimento = cd_tipo_receb_caixa_w;
else
	select	max(a.ie_acao),
		max(a.ie_troca_valores)
	into STRICT	ie_acao_w,
		ie_troca_valores_w
	from	transacao_financeira a,
		caixa_receb b
	where	a.nr_sequencia	= b.nr_seq_trans_financ
	and	b.nr_sequencia	= nr_seq_caixa_rec_p;
end if;

if (dt_cancelamento_receb_w IS NOT NULL AND dt_cancelamento_receb_w::text <> '') then
	return 0;
end if;

if (ie_tipo_receb_w = 'P') then
	select	coalesce(sum(vl_perda),0)	
	into STRICT	vl_cheques_w
	from	CHEQUE_CR_PERDA
	where	nr_seq_caixa_rec	= nr_seq_caixa_rec_p;
else
	select	coalesce(sum(vl_cheque),0)	
	into STRICT	vl_cheques_w
	from	cheque_cr
	where	nr_seq_caixa_rec	= nr_seq_caixa_rec_p;
end if;

select	coalesce(sum(vl_cheque),0)	
into STRICT	vl_cheque_vista_w
from	transacao_financeira b,
	cheque_cr a
where	a.nr_seq_caixa_rec	= nr_seq_caixa_rec_p
and	a.nr_seq_trans_caixa 	= b.nr_sequencia
and	b.ie_cheque_cr		= 'V';

select	coalesce(sum(vl_cheque),0)	
into STRICT	vl_cheque_pre_w
from	transacao_financeira b,
	cheque_cr a
where	a.nr_seq_caixa_rec	= nr_seq_caixa_rec_p
and	a.nr_seq_trans_caixa 	= b.nr_sequencia
and	b.ie_cheque_cr		= 'P';

select	coalesce(sum(vl_transacao),0)
into STRICT	vl_cartao_w
from	movto_cartao_cr
where	nr_seq_caixa_rec	= nr_seq_caixa_rec_p
and	coalesce(dt_cancelamento::text, '') = ''
and ((dt_confirmacao_tef IS NOT NULL AND dt_confirmacao_tef::text <> '') or coalesce(dt_integracao_tef::text, '') = '');

select coalesce(sum(a.vl_recebido),0)
into STRICT vl_pix_w
FROM pix_cobranca a, pix_movimento b
LEFT OUTER JOIN pix_devolucao c ON (b.nr_sequencia = c.nr_seq_movto_pix)
WHERE a.nr_seq_caixa_rec = nr_seq_caixa_rec_p and a.nr_sequencia = b.nr_seq_cobranca  and ds_status = 'CONCLUIDA' and coalesce(c.dt_atualizacao::text, '') = ''; --devolucao

/*2160768 - Verificar se existem recebimentos de cartao cancelados neste recebimento*/

select	count(*)
into STRICT	qt_reg_w
from	movto_cartao_cr a
where	a.nr_seq_caixa_rec	= nr_seq_caixa_rec_p
and	(dt_cancelamento IS NOT NULL AND dt_cancelamento::text <> '');

/*2160768 - Verificar se existem transacoes lancadas de devolucao de adiantamento em cartao para o adiantamento e cartao do recebimento em questao */

select 	count(*)
into STRICT	qt_movto_w
from	movto_trans_financ a,
	transacao_financeira b
where	a.nr_seq_trans_financ = b.nr_sequencia
and	b.ie_acao  = 39 --Devolucao de adiantamento em cartao
and	a.nr_adiantamento in (SELECT c.nr_adiantamento from adiantamento c where c.nr_seq_caixa_rec = nr_seq_caixa_rec_p)
and	a.nr_seq_movto_cartao in (select d.nr_sequencia from movto_cartao_cr d where d.nr_seq_caixa_rec = nr_seq_caixa_rec_p);


if (qt_reg_w > 0) and (coalesce(dt_cancelamento_receb_w::text, '') = '') and (qt_movto_w > 0) then
	/*2160768  Se tiver recebimento de cartao cancelado mas o recebimento nao tiver cancelado, verificar esse valor em cartao no recebimento eh de recebimento de adiantamento e que o adiantamento esteja devolvido e que existe TF de devolucao desse adto no caixa que gerou o cancelamento do cartao*/

	select	coalesce(sum(a.vl_transacao),0)
	into STRICT	vl_cartao_w
	from	movto_cartao_cr a,
		caixa_receb b
	where	a.nr_seq_caixa_rec	= nr_seq_caixa_rec_p
	and	a.nr_seq_caixa_rec	= b.nr_sequencia
	and ((a.dt_confirmacao_tef IS NOT NULL AND a.dt_confirmacao_tef::text <> '') or coalesce(a.dt_integracao_tef::text, '') = '')
	and	exists ( SELECT 1
			 from	adiantamento c
			 where	c.nr_seq_caixa_rec = b.nr_sequencia
			 and	exists ( select 1
					 from	adiantamento_dev d
					 where	d.nr_adiantamento = c.nr_adiantamento)
			);
end if;


/* Todos valores de baixa do recebimento */

select	coalesce(sum(vl_recebido),0),
	coalesce(sum(vl_juros),0),
	coalesce(sum(vl_multa),0),
	coalesce(sum(vl_despesa_bancaria),0),
	coalesce(sum(vl_descontos),0),
	coalesce(sum(vl_glosa),0),
	coalesce(sum(vl_outros_acrescimos),0),
	coalesce(sum(vl_rec_maior),0)
into STRICT	vl_recebido_w,
	vl_juros_w,
	vl_multa_w,
	vl_desp_bancaria_w,
	vl_descontos_w,
	vl_glosa_w,
	vl_outros_acrescimos_w,
	vl_rec_maior_w
from	titulo_receber_liq a
where	a.nr_seq_caixa_rec	= nr_seq_caixa_rec_p;

/* Todos valores da negociacao de cheque */

select	coalesce(sum(vl_negociado),0),
	coalesce(sum(vl_desconto),0),
	coalesce(sum(vl_acrescimo),0),
	coalesce(sum(vl_terceiro),0),
	coalesce(sum(vl_juros),0),
	coalesce(sum(vl_multa),0),
	coalesce(sum(vl_desconto),0)
into STRICT	vl_negociado_w,
	vl_desconto_w,
	vl_acrescimo_w,
	vl_terceiro_w,
	vl_juros_cheque_w,
	vl_multa_cheque_w,
	vl_desconto_negociado_w
from	cheque_cr_negociado
where	nr_seq_caixa_rec	= nr_seq_caixa_rec_p;

select	coalesce(sum(vl_recebido),0)
into STRICT	vl_baixa_adiant_w
from	titulo_receber_liq
where	(nr_adiantamento IS NOT NULL AND nr_adiantamento::text <> '')
and	nr_seq_caixa_rec	= nr_seq_caixa_rec_p;

/* Valores de baixa com adiantamento vinculado */

select	coalesce(sum(coalesce(vl_recebido,0) +
	coalesce(vl_juros,0) +
	coalesce(vl_multa,0) +
	coalesce(vl_despesa_bancaria,0) +
	coalesce(vl_descontos,0)),0)
into STRICT	vl_tot_vinc_adiant_w
from	titulo_receber_liq
where	nr_seq_caixa_rec	= nr_seq_caixa_rec_p
and	(nr_adiantamento IS NOT NULL AND nr_adiantamento::text <> '');

select	coalesce(sum(vl_adiantamento),0)
into STRICT	vl_adiantamento_W
from	adiantamento
where	nr_seq_caixa_rec	= nr_seq_caixa_rec_p;

/* Projeto Multimoeda - Busca os valores lancados para troca de valores no caixa. A troca de valores gera um adiantamento pago como documento
	do recebimento. Posteriormente ira gerar transacao de saida no caixa. Adicionado aqui somente para a verificacao dos valores de 
	documento lancados para a consistencia com os valores monetarios.*/
if (coalesce(ie_troca_valores_w,'N') = 'S') then
	select	coalesce(sum(vl_adiantamento),0)
	into STRICT	vl_troca_valores_w
	from	adiantamento_pago
	where	nr_seq_caixa_rec	= nr_seq_caixa_rec_p;
end if;

/* Tratar valor de baixa por gratuidade */

select	coalesce(sum(coalesce(vl_recebido,0) +
	coalesce(vl_juros,0) +
	coalesce(vl_multa,0) +
	coalesce(vl_despesa_bancaria,0) +
	coalesce(vl_descontos,0) +
	coalesce(vl_glosa,0)),0)
into STRICT	vl_baixa_perda_w
from	transacao_financeira b,
	titulo_receber_liq a
where	a.nr_seq_trans_caixa	= b.nr_sequencia
and	b.ie_acao		= 18
and	a.nr_seq_caixa_rec	= nr_seq_caixa_rec_p;

select	coalesce(sum(vl_transacao),0)
into STRICT	vl_transacao_w
from	transacao_financeira b,
	movto_trans_financ a
where	a.nr_seq_trans_financ	= b.nr_sequencia
and	b.ie_caixa		= 'D'
and	coalesce(a.nr_seq_titulo_receber::text, '') = ''
and	coalesce(a.nr_adiantamento::text, '') = ''
and	nr_seq_caixa_rec	= nr_seq_caixa_rec_p;

select	coalesce(sum(a.vl_transacao),0)
into STRICT	vl_cartao_cr_w
from	transacao_financeira b,
	movto_cartao_cr a
where	a.nr_seq_caixa_rec	= nr_seq_caixa_rec_p
and	a.nr_seq_trans_caixa = b.nr_sequencia
and	b.ie_cartao_cr = 'S'
and	coalesce(a.dt_cancelamento::text, '') = ''
and ((a.dt_confirmacao_tef IS NOT NULL AND a.dt_confirmacao_tef::text <> '') or coalesce(a.dt_integracao_tef::text, '') = '');

select	coalesce(sum(a.vl_transacao),0)
into STRICT	vl_cartao_debito_w
from	transacao_financeira b,
	movto_cartao_cr a
where	a.nr_seq_caixa_rec	= nr_seq_caixa_rec_p
and	a.nr_seq_trans_caixa = b.nr_sequencia
and	b.ie_cartao_debito = 'S'
and	coalesce(a.dt_cancelamento::text, '') = ''
and ((a.dt_confirmacao_tef IS NOT NULL AND a.dt_confirmacao_tef::text <> '') or coalesce(a.dt_integracao_tef::text, '') = '');

/* Tratar pelo tipo de recebimento (Normal/Negociacao de cheque) */

if (ie_tipo_receb_w = 'R') then
	vl_total_w	:= (vl_recebido_w + vl_juros_w + vl_multa_w + vl_desp_bancaria_w +
				vl_descontos_w + vl_glosa_w + vl_outros_acrescimos_w + vl_rec_maior_w) +
		 	vl_adiantamento_w + vl_transacao_w + coalesce(vl_troca_valores_w,0);
elsif (ie_tipo_receb_w = 'C') then
	vl_total_w	:= (vl_negociado_w + vl_acrescimo_w + vl_terceiro_w + vl_juros_cheque_w + vl_multa_cheque_w + vl_desconto_negociado_w);
end if;

if (ie_acao_w = '34') then --tratado para desconsiderar o valor do adiantamento
	vl_total_w		:= (vl_recebido_w + vl_juros_w + vl_multa_w + vl_desp_bancaria_w + vl_descontos_w + vl_glosa_w + vl_outros_acrescimos_w + vl_rec_maior_w) + vl_transacao_w + coalesce(vl_troca_valores_w,0);
	vl_tot_vinc_adiant_w	:= 0;
end if;

if (ie_opcao_p	= 'VE') then /* Valor especie */
	vl_retorno_w	:= vl_especie_w;
elsif (ie_opcao_p	= 'VDD') then /* Valor Deposito Direto */
	vl_retorno_w	:= vl_deposito_direto_w;
elsif (ie_opcao_p	= 'VCH') then /* Valor cheques */
	vl_retorno_w	:= vl_cheques_w;
elsif (ie_opcao_p	= 'VCV') then /* Valor cheque a vista */
	vl_retorno_w	:= vl_cheque_vista_w;
elsif (ie_opcao_p	= 'VCP') then /* Valor cheque Pre */
	vl_retorno_w	:= vl_cheque_pre_w;
elsif (ie_opcao_p	= 'VCA') then /* Valor cartao */
	vl_retorno_w	:= vl_cartao_w;
elsif (ie_opcao_p	= 'VPIX') then /* Valor pix */
	vl_retorno_w	:= vl_pix_w;	
elsif (ie_opcao_p	= 'VDO') then /* Valor documentos */
	vl_retorno_w	:= vl_total_w;
elsif (ie_opcao_p	= 'VT') then /* Valor total */
	vl_retorno_w	:= vl_especie_w + vl_cheques_w + vl_cartao_w + vl_pix_w + vl_deposito_direto_w;
elsif (ie_opcao_p	= 'VR') then /* Valor restante */
	if (ie_tipo_receb_w = 'R') then
		vl_retorno_w	:= vl_total_w - vl_descontos_w -
				(vl_especie_w + vl_cheques_w + vl_cartao_w + vl_pix_w + vl_tot_vinc_adiant_w + vl_baixa_perda_w + vl_glosa_w + vl_deposito_direto_w);
	elsif (ie_tipo_receb_w = 'C') then
		vl_retorno_w	:= vl_total_w - vl_desconto_w - vl_terceiro_w - (vl_especie_w + vl_cheques_w + vl_cartao_w + vl_pix_w + vl_deposito_direto_w);
	end if;
	
	if (ie_acao_w = '34') then
		vl_retorno_w	:= vl_total_w - vl_descontos_w -
				(vl_especie_w + vl_cheques_w + vl_cartao_w + vl_pix_w + vl_deposito_direto_w + vl_tot_vinc_adiant_w + vl_baixa_perda_w + vl_glosa_w + vl_adiantamento_w - vl_troco_informado_w);
	end if;
elsif (ie_opcao_p	= 'VRA') then /* Valor restante  com ABS - Utilizado no Java*/
	if (ie_tipo_receb_w = 'R') then
		vl_retorno_w	:= vl_total_w - vl_descontos_w -
				(vl_especie_w + vl_cheques_w + vl_cartao_w + vl_pix_w + vl_tot_vinc_adiant_w + vl_baixa_perda_w + vl_glosa_w + vl_deposito_direto_w);
	elsif (ie_tipo_receb_w = 'C') then
		vl_retorno_w	:= vl_total_w - vl_desconto_w - vl_terceiro_w - (vl_especie_w + vl_cheques_w + vl_cartao_w + vl_pix_w + vl_deposito_direto_w);
	end if;
	
	if (ie_acao_w = '34') then
		vl_retorno_w	:= vl_total_w - vl_descontos_w -
				(vl_especie_w + vl_cheques_w + vl_cartao_w + vl_pix_w + vl_deposito_direto_w + vl_tot_vinc_adiant_w + vl_baixa_perda_w + vl_glosa_w + vl_adiantamento_w - vl_troco_informado_w);
	end if;
	if (vl_retorno_w < 0) then
		vl_retorno_w 	:= abs(vl_retorno_w);
	end if;
elsif (ie_opcao_p	= 'VDE') then /* Valor descontos */
	vl_retorno_w	:= vl_descontos_w;
elsif (ie_opcao_p	= 'VBA') then /* Valor recebido por adiantamento */
	vl_retorno_w	:= vl_baixa_adiant_w;
elsif (ie_opcao_p	= 'VCD') then /* Valor Cartao Debito */
	vl_retorno_w	:= vl_cartao_debito_w;
elsif (ie_opcao_p	= 'VCC') then /* Valor Cartao Credito */
	vl_retorno_w	:= vl_cartao_cr_w;
elsif (ie_opcao_p	= 'VREC') then
	vl_retorno_w	:= vl_recebido_w;
elsif (ie_opcao_p	= 'VTJM') then /* Valor total sem juros e multa */
	vl_retorno_w	:= vl_especie_w + vl_cheques_w + vl_cartao_w + vl_pix_w + coalesce(vl_juros_w,0) + coalesce(vl_multa_w,0) + vl_deposito_direto_w;
elsif (ie_opcao_p	= 'VRI') then /* Valor restante sem troco informado */
	if (ie_tipo_receb_w = 'R') then
		vl_retorno_w	:= vl_total_w - vl_descontos_w -
				(vl_especie_w + vl_cheques_w + vl_cartao_w + vl_deposito_direto_w + vl_tot_vinc_adiant_w + vl_baixa_perda_w + vl_glosa_w);
	elsif (ie_tipo_receb_w = 'C') then
		vl_retorno_w	:= vl_total_w - vl_desconto_w - vl_terceiro_w - (vl_especie_w + vl_cheques_w + vl_cartao_w + vl_deposito_direto_w);
	end if;
	
	if (ie_acao_w = '34') then
		vl_retorno_w	:= vl_total_w - vl_descontos_w -
				(vl_especie_w + vl_cheques_w + vl_cartao_w + vl_pix_w + vl_deposito_direto_w + vl_tot_vinc_adiant_w + vl_baixa_perda_w + vl_glosa_w + vl_adiantamento_w);
	end if;
elsif (ie_opcao_p	= 'VRO') then /*Valor recebido titulo receber liq  + valor recebido de outros recebimentos*/
	
	vl_retorno_w	:= coalesce(vl_recebido_w,0) + coalesce(vl_transacao_w,0) + coalesce(vl_adiantamento_w,0);
end if;

return	vl_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_valores_caixa_rec ( nr_seq_caixa_rec_p bigint, ie_opcao_p text) FROM PUBLIC;

