-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_valor_conversao_contrado (nr_seq_regra_p bigint, qt_material_p bigint) RETURNS bigint AS $body$
DECLARE


ie_conversao_nf_w			varchar(1);
qt_conversao_nf_w			real;
retorno				real;
vl_pgto_w			double precision;
qt_quantidade_w			bigint;
qt_material_w			bigint;



BEGIN

select	coalesce(max(ie_conversao_nf),0),
	coalesce(max(qt_conversao_nf),0),
	coalesce(max(vl_pagto),0)
into STRICT	ie_conversao_nf_w,
	qt_conversao_nf_w,
	vl_pgto_w
from	contrato_regra_nf
where	nr_sequencia = nr_seq_regra_p;

if (ie_conversao_nf_w = 'D') then
	qt_quantidade_w	:=	(qt_material_p / qt_conversao_nf_w);
	retorno		:= 	qt_quantidade_w;
end if;

if (ie_conversao_nf_w = 'M') then
	begin
	if	((trunc(qt_material_p / qt_conversao_nf_w) * qt_conversao_nf_w) = qt_material_p) then
		begin
		qt_quantidade_w		:=	(trunc(qt_material_p / qt_conversao_nf_w) * qt_conversao_nf_w);
		retorno			:= 	qt_quantidade_w;
		end;
	else
		begin
		qt_material_w	:= 	qt_material_p;
			while ((trunc(qt_material_w / qt_conversao_nf_w) * qt_conversao_nf_w) <> qt_material_w) loop
				begin
				qt_material_w	:=	qt_material_w + 1;
				if	((trunc(qt_material_w / qt_conversao_nf_w) * qt_conversao_nf_w) = qt_material_w) then
					qt_quantidade_w	:=	(trunc(qt_material_w / qt_conversao_nf_w) * qt_conversao_nf_w);
					retorno		:= 	qt_quantidade_w;
				end if;
				end;
			end loop;
		end;
	end if;
	end;
end if;

return	retorno;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_valor_conversao_contrado (nr_seq_regra_p bigint, qt_material_p bigint) FROM PUBLIC;

