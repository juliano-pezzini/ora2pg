-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_mensagem_email_fat ( nr_atendimento_p bigint) RETURNS varchar AS $body$
DECLARE
					
					 
ds_retorno_w			varchar(4000);
nm_pessoa_fisica_w		varchar(60);
ds_unidade_atendimento_w	varchar(255);
dt_nascimento_w			timestamp;
dt_entrada_w			timestamp;
cd_pessoa_fisica_w		varchar(10);


BEGIN 
 
cd_pessoa_fisica_w	:= substr(obter_pessoa_atendimento(nr_atendimento_p,'C'),1,255);
--dt_entrada_w		:= substr(obter_data_entrada(nr_atendimento_p),1,255); 
ds_unidade_atendimento_w:= substr(Obter_Unidade_Atendimento(nr_atendimento_p,'A','UB')||' '||Obter_Unidade_Atendimento(nr_atendimento_p,'A','UC'),1,255);
 
select	dt_entrada 
into STRICT	dt_entrada_w 
from	atendimento_paciente 
where	nr_atendimento = nr_atendimento_p;
 
select	SUBSTR(OBTER_NOME_PF(CD_PESSOA_FISICA),0,60), 
	dt_nascimento 
into STRICT	nm_pessoa_fisica_w, 
	dt_nascimento_w 
from	pessoa_fisica 
where	cd_pessoa_fisica = cd_pessoa_fisica_w;
			 
ds_retorno_w	:= 	wheb_mensagem_pck.get_texto(307420)||': '||nr_atendimento_p||chr(13)||chr(10)|| 
			wheb_mensagem_pck.get_texto(791350)||': '||nm_pessoa_fisica_w||chr(13)||chr(10)|| 
			wheb_mensagem_pck.get_texto(802866)||': '||to_char(dt_nascimento_w, pkg_date_formaters.localize_mask('ShortDate', pkg_date_formaters.getUserLanguageTag(wheb_usuario_pck.get_cd_estabelecimento, wheb_usuario_pck.get_nm_usuario)))||chr(13)||chr(10)|| 
			wheb_mensagem_pck.get_texto(802307)||': '||to_char(dt_entrada_w, pkg_date_formaters.localize_mask('timestamp', pkg_date_formaters.getUserLanguageTag(wheb_usuario_pck.get_cd_estabelecimento, wheb_usuario_pck.get_nm_usuario)))||chr(13)||chr(10)|| 
			wheb_mensagem_pck.get_texto(802869)||': '||ds_unidade_atendimento_w;			
 
return ds_retorno_w;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_mensagem_email_fat ( nr_atendimento_p bigint) FROM PUBLIC;

