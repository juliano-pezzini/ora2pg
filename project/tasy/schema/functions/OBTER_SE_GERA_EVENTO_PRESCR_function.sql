-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_se_gera_evento_prescr (nr_seq_evento_p bigint, nr_prescricao_p text, dt_liberacao_p timestamp) RETURNS varchar AS $body$
DECLARE

ds_retorno_w	varchar(2);				
dt_inicio_w	timestamp;
dt_fim_w	timestamp;
ie_dia_semana_w	varchar(10);


BEGIN
	
select	ESTABLISHMENT_TIMEZONE_UTILS.dateAtTime(dt_liberacao_p, coalesce(hr_inicial_geracao,dt_liberacao_p)),
		ESTABLISHMENT_TIMEZONE_UTILS.dateAtTime(dt_liberacao_p, coalesce(hr_final_geracao,dt_liberacao_p)),
	ie_dia_semana
into STRICT	dt_inicio_w,
	dt_fim_w,
	ie_dia_semana_w
from 	ev_evento
where	nr_sequencia = nr_seq_evento_p;	
	
select	CASE WHEN count(*)='0' THEN 'N'  ELSE 'S' END
into STRICT	ds_retorno_w
from	prescr_medica a
where	dt_liberacao_p between dt_inicio_w and dt_fim_w
and	a.nr_prescricao = nr_prescricao_p
and	coalesce(ie_dia_semana_w,Obter_Cod_Dia_Semana(dt_liberacao_p)) = Obter_Cod_Dia_Semana(dt_liberacao_p) 
and 	exists (SELECT 1 from prescr_procedimento w where a.nr_prescricao = w.nr_prescricao and (nr_seq_exame IS NOT NULL AND nr_seq_exame::text <> '') );

return	ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_se_gera_evento_prescr (nr_seq_evento_p bigint, nr_prescricao_p text, dt_liberacao_p timestamp) FROM PUBLIC;

