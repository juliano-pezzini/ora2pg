-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION pls_obter_se_crit_valor_exc ( nr_seq_criterio_p pls_criterio_recalculo.nr_sequencia%type, ie_carater_atendimento_p pls_criterio_recalculo_exc.ie_carater_atendimento%type, ie_carater_atendimento_princ_p pls_criterio_recalculo_exc.ie_carater_atendimento_princ%type, ie_origem_protocolo_p pls_criterio_recalculo_exc.ie_origem_protocolo%type, ie_tipo_guia_p pls_criterio_recalculo_exc.ie_tipo_guia%type, ie_tipo_guia_princ_P pls_criterio_recalculo_exc.ie_tipo_guia_princ%type, nr_seq_tipo_atendimento_p pls_criterio_recalculo_exc.nr_seq_tipo_atendimento%type, nr_seq_tipo_atendimento_prin_p pls_criterio_recalculo_exc.nr_seq_tipo_atendimento_princ%type, nr_seq_prestador_p pls_criterio_recalculo_exc.nr_seq_prestador%type, nr_seq_classificacao_p pls_prestador.nr_seq_classificacao%type, ie_regime_atendimento_p pls_criterio_recalculo_exc.ie_regime_atendimento%type default null, ie_regime_atendimento_princ_p pls_criterio_recalculo_exc.ie_regime_atendimento_princ%type default null, ie_saude_ocupacional_p pls_criterio_recalculo_exc.ie_saude_ocupacional%type default null, nr_seq_contrato_p pls_segurado.nr_seq_contrato%type default null, nr_seq_contrato_intercambio_p pls_segurado.nr_seq_intercambio%type default null) RETURNS varchar AS $body$
DECLARE

														
ie_crit_except_w	varchar(1) := 'N';
ie_grupo_contrato_w	varchar(1) := 'N';
ie_grupo_sem_contrato_w	varchar(1) := 'N';

C01 CURSOR FOR
	SELECT 	nr_sequencia,
		nr_seq_grupo_prestador,
		nr_seq_grupo_contrato
	from	pls_criterio_recalculo_exc a
	where	nr_seq_criterio_rec = nr_seq_criterio_p
	and 	(( coalesce(ie_carater_atendimento::text, '') = '') or ( ie_carater_atendimento =       	ie_carater_atendimento_p ))     
	and 	(( coalesce(ie_carater_atendimento_princ::text, '') = '') or ( ie_carater_atendimento_princ =  ie_carater_atendimento_princ_p ))
	and 	(( coalesce(ie_origem_protocolo::text, '') = '') or ( ie_origem_protocolo =           ie_origem_protocolo_p ))         
	and 	(( coalesce(ie_tipo_guia::text, '') = '') or ( ie_tipo_guia =                  ie_tipo_guia_p ))                
	and 	(( coalesce(ie_tipo_guia_princ::text, '') = '') or ( ie_tipo_guia_princ =            ie_tipo_guia_princ_p ))                                        
	and 	(( coalesce(nr_seq_tipo_atendimento::text, '') = '') or ( nr_seq_tipo_atendimento =       nr_seq_tipo_atendimento_p ))     
	and 	(( coalesce(ie_regime_atendimento::text, '') = '') or ( ie_regime_atendimento =         ie_regime_atendimento_p ))
	and 	(( coalesce(ie_regime_atendimento_princ::text, '') = '') or ( ie_regime_atendimento_princ =   ie_regime_atendimento_princ_p ))
	and 	(( coalesce(ie_saude_ocupacional::text, '') = '') or ( ie_saude_ocupacional =       	ie_saude_ocupacional_p ))
	and 	(( coalesce(nr_seq_tipo_atendimento_princ::text, '') = '') or ( nr_seq_tipo_atendimento_princ = nr_seq_tipo_atendimento_prin_p ))
	and 	(( coalesce(nr_seq_prestador::text, '') = '') or ( nr_seq_prestador = nr_seq_prestador_p ))
	and	(coalesce(nr_seq_grupo_prestador::text, '') = '' 	or
		 exists	(SELECT	1
			from	pls_preco_prestador x
			where	x.nr_seq_grupo	= a.nr_seq_grupo_prestador
			and	((coalesce(x.nr_seq_prestador::text, '') = '')	  or (x.nr_seq_prestador	= nr_seq_prestador_p))
			and	((coalesce(x.nr_seq_classificacao::text, '') = '') or (x.nr_seq_classificacao	= nr_seq_classificacao_p))
			)
		)
	order by coalesce(nr_seq_grupo_prestador, -1);										

BEGIN            
	--Se nao encontrar nada no cursor e porque nao ha excecao valida para a conta medica
	for r_c01_w in C01 loop	
		
		if (ie_crit_except_w = 'N') then
			--Se encontrou regra e nao tem grupo de contrato nela, quer dizer que a conta se encaixa sem ser necessario mais validacoes
			if (coalesce(r_c01_w.nr_seq_grupo_contrato::text, '') = '') then
				ie_crit_except_w := 'S';
			else
				if (r_c01_w.nr_seq_grupo_contrato IS NOT NULL AND r_c01_w.nr_seq_grupo_contrato::text <> '') then
					if	((coalesce(nr_seq_contrato_p,0) > 0) or (coalesce(nr_seq_contrato_intercambio_p,0) > 0)) then
						ie_grupo_contrato_w	:= pls_se_grupo_preco_contrato(r_c01_w.nr_seq_grupo_contrato, nr_seq_contrato_p, nr_seq_contrato_intercambio_p);
						ie_grupo_sem_contrato_w := 'S';
					else
						ie_grupo_contrato_w	:= 'N';
					end if;
				end if;
			end if;	
			--Se o contrato do beneficiario esta no grupo, vira excecao. Foi necessario tratar para os casos que o grupo de contratos estar sem contratos, nesse caso nao deve tratar como excecao.
			if (ie_grupo_contrato_w = 'S')  then		
				ie_crit_except_w := 'S';
			elsif (ie_grupo_sem_contrato_w = 'S' and ie_grupo_contrato_w = 'N') then
				ie_crit_except_w := 'N';
			end if;
		end if;		
	end loop;
	
return	ie_crit_except_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION pls_obter_se_crit_valor_exc ( nr_seq_criterio_p pls_criterio_recalculo.nr_sequencia%type, ie_carater_atendimento_p pls_criterio_recalculo_exc.ie_carater_atendimento%type, ie_carater_atendimento_princ_p pls_criterio_recalculo_exc.ie_carater_atendimento_princ%type, ie_origem_protocolo_p pls_criterio_recalculo_exc.ie_origem_protocolo%type, ie_tipo_guia_p pls_criterio_recalculo_exc.ie_tipo_guia%type, ie_tipo_guia_princ_P pls_criterio_recalculo_exc.ie_tipo_guia_princ%type, nr_seq_tipo_atendimento_p pls_criterio_recalculo_exc.nr_seq_tipo_atendimento%type, nr_seq_tipo_atendimento_prin_p pls_criterio_recalculo_exc.nr_seq_tipo_atendimento_princ%type, nr_seq_prestador_p pls_criterio_recalculo_exc.nr_seq_prestador%type, nr_seq_classificacao_p pls_prestador.nr_seq_classificacao%type, ie_regime_atendimento_p pls_criterio_recalculo_exc.ie_regime_atendimento%type default null, ie_regime_atendimento_princ_p pls_criterio_recalculo_exc.ie_regime_atendimento_princ%type default null, ie_saude_ocupacional_p pls_criterio_recalculo_exc.ie_saude_ocupacional%type default null, nr_seq_contrato_p pls_segurado.nr_seq_contrato%type default null, nr_seq_contrato_intercambio_p pls_segurado.nr_seq_intercambio%type default null) FROM PUBLIC;

