-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION pfcs_obter_qt_total_result ( cd_exame_p text, ds_sigla_p text, ds_resultado_p text, cd_estabelecimento_p bigint ) RETURNS bigint AS $body$
DECLARE

   qt_result_rap_estab_w bigint := 0;
   qt_result_compl_estab_w bigint := 0;

BEGIN
   SELECT
      COUNT(*) 
   INTO STRICT
      qt_result_rap_estab_w
   FROM 
      paciente_exame a,
      atendimento_paciente b
   WHERE 
      a.ie_exame_pac = cd_exame_p 
      AND (a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '') 
      AND coalesce(a.dt_inativacao::text, '') = ''
      AND (a.ds_resultado IS NOT NULL AND a.ds_resultado::text <> '')
      AND UPPER(a.ds_resultado) LIKE UPPER(CONCAT(ds_resultado_p,'%'))
      AND a.cd_pessoa_fisica = b.cd_pessoa_fisica
      AND	b.nr_atendimento	= (
         SELECT	MAX(x.nr_atendimento)
         FROM	atendimento_paciente x
         WHERE	x.cd_pessoa_fisica	= a.cd_pessoa_fisica
            AND  x.cd_estabelecimento = b.cd_estabelecimento)
      AND b.cd_estabelecimento = cd_estabelecimento_p;

   SELECT
      COUNT(*)
   INTO STRICT
      qt_result_compl_estab_w
   FROM  pessoa_fisica a,
      prescr_medica b,
      prescr_procedimento c,
      exame_lab_resultado d,
      exame_lab_result_item e,
      equipamento_lab f,
      lab_exame_equip g
   WHERE a.cd_pessoa_fisica = b.cd_pessoa_fisica
      AND b.nr_prescricao = c.nr_prescricao
      AND c.nr_sequencia = e.nr_seq_prescr
      AND b.nr_prescricao = d.nr_prescricao
      AND d.nr_seq_resultado = e.nr_seq_resultado
      AND f.cd_equipamento = g.cd_equipamento
      AND UPPER(f.ds_sigla) = ds_sigla_p
      AND g.nr_seq_exame = c.nr_seq_exame
      AND UPPER(e.ds_resultado) LIKE UPPER(CONCAT(ds_resultado_p,'%'))
      AND (b.dt_liberacao IS NOT NULL AND b.dt_liberacao::text <> '')
      AND c.ie_status_atend >= 35
      AND b.cd_estabelecimento = cd_estabelecimento_p;

   RETURN qt_result_compl_estab_w + qt_result_rap_estab_w;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION pfcs_obter_qt_total_result ( cd_exame_p text, ds_sigla_p text, ds_resultado_p text, cd_estabelecimento_p bigint ) FROM PUBLIC;

