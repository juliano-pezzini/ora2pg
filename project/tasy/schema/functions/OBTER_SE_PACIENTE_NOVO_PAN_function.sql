-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_se_paciente_novo_pan (nr_atendimento_p bigint, cd_setor_atedimento_P bigint) RETURNS varchar AS $body$
DECLARE

    cd_ult_setor_atedimento_w     bigint;
    cd_setor_atedimento_w         bigint;
    minute_admimssion_setor_w     bigint;
    minutes_admission_pac_w       bigint;
    date_admission_pac_w          timestamp;
    novo_paciente_w               varchar(1);

BEGIN
  date_admission_pac_w := TO_TIMESTAMP(obter_data_entrada_setor(nr_atendimento_p));
  minutes_admission_pac_w:= (extract(day from (CURRENT_TIMESTAMP - date_admission_pac_w )) * 24 * 60 * 60 +
                                    extract(hour from (CURRENT_TIMESTAMP - date_admission_pac_w)) * 60 +
                                    extract(minute from (CURRENT_TIMESTAMP - date_admission_pac_w)) * 60 +
                                    extract(second from (CURRENT_TIMESTAMP - date_admission_pac_w)))/60;

    BEGIN  
        SELECT ua.cd_setor_atendimento 
        INTO STRICT cd_ult_setor_atedimento_w
        FROM atend_paciente_unidade ua  
        WHERE ua.nr_atendimento = nr_atendimento_p
              AND ua.nr_sequencia=(SELECT MAX(ua1.nr_sequencia)-1 FROM atend_paciente_unidade ua1 WHERE ua1.nr_atendimento = nr_atendimento_p)
              AND ua.ie_passagem_setor='N';
    EXCEPTION
    WHEN OTHERS THEN
    cd_ult_setor_atedimento_w:=NULL;
    END;

    BEGIN  
        SELECT ua.cd_setor_atendimento 
        INTO STRICT cd_setor_atedimento_w
        FROM atend_paciente_unidade ua  
        WHERE ua.nr_atendimento = nr_atendimento_p
              AND ua.nr_sequencia=(SELECT MAX(ua1.nr_sequencia) FROM atend_paciente_unidade ua1 WHERE ua1.nr_atendimento = nr_atendimento_p)
              AND ua.ie_passagem_setor='N';
    EXCEPTION
    WHEN OTHERS THEN
    cd_setor_atedimento_w:=NULL;
    END;

    BEGIN
        SELECT pcs.ie_tempo_admissao
        INTO STRICT minute_admimssion_setor_w
        FROM pan_configuracao_setor pcs
        WHERE pcs.ie_situacao = 'A' and pcs.cd_setor_atendimento = cd_setor_atedimento_P;
    EXCEPTION
        WHEN OTHERS THEN
        novo_paciente_w := 'N';
    END;

   IF (cd_ult_setor_atedimento_w IS NOT  NULL AND cd_ult_setor_atedimento_w = cd_setor_atedimento_P OR cd_setor_atedimento_w <> cd_setor_atedimento_p ) THEN
    novo_paciente_w := 'N';
   END IF;

  IF ((minute_admimssion_setor_w IS NOT NULL AND minute_admimssion_setor_w::text <> '') and (minutes_admission_pac_w IS NOT NULL AND minutes_admission_pac_w::text <> '') and minute_admimssion_setor_w > minutes_admission_pac_w AND coalesce(novo_paciente_w::text, '') = '' ) THEN
    novo_paciente_w := 'S';
  ELSE
    novo_paciente_w := 'N';
  END IF;

  RETURN novo_paciente_w;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_se_paciente_novo_pan (nr_atendimento_p bigint, cd_setor_atedimento_P bigint) FROM PUBLIC;

