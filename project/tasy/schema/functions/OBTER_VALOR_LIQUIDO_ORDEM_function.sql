-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_valor_liquido_ordem (nr_ordem_compra_p bigint) RETURNS bigint AS $body$
DECLARE


vl_item_w				double precision := 0;
pr_desconto_w				ordem_compra.pr_desconto%type;
vl_desconto_w				double precision := 0;
vl_retorno_w				bigint := 0;
vl_frete_w					ordem_compra.vl_frete%type;
vl_despesa_acessoria_w		ordem_compra.vl_despesa_acessoria%type;
vl_seguro_w					ordem_compra.vl_seguro%type;
vl_desconto_oc_w			ordem_compra.vl_despesa_doc%type;
ie_frete_w					ordem_compra.ie_frete%type;
nr_item_oci_w				ordem_compra_item_entrega.nr_item_oci%type;
qt_prevista_entrega_w		ordem_compra_item_entrega.qt_prevista_entrega%type;
vl_liquido_unitario_w			double precision;
vl_cancelado_w				bigint := 0;
vl_cancelado_ww				bigint := 0;
cd_estabelecimento_w		ordem_compra.cd_estabelecimento%type;
ie_desconsidera_cancel_w		varchar(1);
vl_despesa_doc_w			ordem_compra.vl_despesa_doc%type;
ie_cons_frete_cif_oc_w   varchar(1);

c01 CURSOR FOR
SELECT	nr_item_oci,
	qt_prevista_entrega
from	ordem_compra_item_entrega
where	nr_ordem_compra = nr_ordem_compra_p
and	(dt_cancelamento IS NOT NULL AND dt_cancelamento::text <> '');


BEGIN

select	coalesce(max(pr_desconto),0),
	coalesce(max(ie_frete),'C'),
	coalesce(max(vl_frete),0),
	coalesce(max(vl_despesa_acessoria),0),
	coalesce(max(vl_despesa_doc),0),
	coalesce(max(vl_desconto),0),
	max(cd_estabelecimento),
	coalesce(max(vl_seguro),0)
into STRICT	pr_desconto_w,
	ie_frete_w,
	vl_frete_w,
	vl_despesa_acessoria_w,
	vl_despesa_doc_w,
	vl_desconto_oc_w,
	cd_estabelecimento_w,
	vl_seguro_w
from	ordem_compra
where	nr_ordem_compra	= nr_ordem_compra_p;

select	
	coalesce(ie_desconsidera_vl_item_cancel,'N'),
	coalesce(IE_CONS_FRETE_CIF_OC,'N')
into STRICT	ie_desconsidera_cancel_w,
		ie_cons_frete_cif_oc_w
from	parametro_compras
where	cd_estabelecimento = cd_estabelecimento_w;

select	coalesce(sum(Obter_Valor_Liquido_Oci(nr_ordem_compra, nr_item_oci)),0)
into STRICT	vl_item_w
from	ordem_compra_item
where	nr_ordem_compra = nr_ordem_compra_p
and	coalesce(dt_reprovacao::text, '') = '';

if (pr_desconto_w > 0) then
	vl_desconto_w	:= (vl_item_w * pr_desconto_w) / 100;
end if;

vl_retorno_w		:= (vl_item_w - vl_desconto_w) - coalesce(vl_desconto_oc_w,0);

if (vl_despesa_acessoria_w > 0) then
	vl_retorno_w	:= (vl_retorno_w + vl_despesa_acessoria_w);
end if;

if (vl_despesa_doc_w > 0) then
	vl_retorno_w	:= (vl_retorno_w + vl_despesa_doc_w);
end if;

if (ie_frete_w = 'F' or (ie_frete_w = 'C' and ie_cons_frete_cif_oc_w = 'S'))then
	vl_retorno_w	:= (vl_retorno_w + vl_frete_w);	
end if;

if (vl_seguro_w > 0) then
	vl_retorno_w	:= (vl_retorno_w + vl_seguro_w);
end if;

if (ie_desconsidera_cancel_w = 'S') then
	
	open C01;
	loop
	fetch C01 into	
		nr_item_oci_w,
		qt_prevista_entrega_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin
		
		select	dividir(vl_item_liquido, qt_material)
		into STRICT	vl_liquido_unitario_w
		from	ordem_compra_item
		where	nr_ordem_compra = nr_ordem_compra_p
		and	nr_item_oci = nr_item_oci_w;
		
		vl_cancelado_w 	:= qt_prevista_entrega_w * vl_liquido_unitario_w;
		vl_cancelado_ww	:= vl_cancelado_ww + vl_cancelado_w;
		
		end;
	end loop;
	close C01;
end if;

if (vl_cancelado_ww > 0) then
	vl_retorno_w	:= (vl_retorno_w - vl_cancelado_ww);
end if;


return vl_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_valor_liquido_ordem (nr_ordem_compra_p bigint) FROM PUBLIC;

