-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_desc_proc_solicitado ( nr_atendimento_p integer, nr_prescricao_p integer ) RETURNS varchar AS $body$
DECLARE

    cd_procedimento_w              prescr_procedimento.cd_procedimento%TYPE;
    ie_origem_proced_w             prescr_procedimento.ie_origem_proced%TYPE;
    nr_seq_proc_interno_w          prescr_procedimento.nr_seq_proc_interno%TYPE;
    desc_prescr_proc_exam_w        varchar(255);
    ds_proc_interno_solicitado_w   varchar(255);

BEGIN
    IF (nr_atendimento_p IS NOT NULL AND nr_atendimento_p::text <> '' AND nr_prescricao_p IS NOT NULL AND nr_prescricao_p::text <> '') THEN
        SELECT
            MAX(pp.cd_procedimento) cd_procedimento,
            MAX(pp.ie_origem_proced) ie_origem_proced,
            MAX(pp.nr_seq_proc_interno) nr_seq_proc_interno
        INTO STRICT
            cd_procedimento_w,
            ie_origem_proced_w,
            nr_seq_proc_interno_w
        FROM
            prescr_procedimento     pp
            INNER JOIN prescr_medica           pm ON pm.nr_prescricao = pp.nr_prescricao
            INNER JOIN procedimento_paciente   proc_pac ON proc_pac.nr_prescricao = pp.nr_prescricao
                                                         AND proc_pac.nr_sequencia_prescricao = pp.nr_sequencia
        WHERE
            pm.nr_atendimento = nr_atendimento_p
            AND pm.nr_prescricao = nr_prescricao_p;
    END IF;



    desc_prescr_proc_exam_w := substr(obter_desc_prescr_proc_exam(cd_procedimento_w, ie_origem_proced_w, nr_seq_proc_interno_w, NULL), 1, 255);
    ds_proc_interno_solicitado_w := substr(nr_seq_proc_interno_w || ' - ' || desc_prescr_proc_exam_w, 1, 255);



    RETURN ds_proc_interno_solicitado_w;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_desc_proc_solicitado ( nr_atendimento_p integer, nr_prescricao_p integer ) FROM PUBLIC;

