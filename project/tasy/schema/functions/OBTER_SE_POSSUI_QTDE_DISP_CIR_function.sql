-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_se_possui_qtde_disp_cir ( nr_prescricao_p bigint, cd_material_p bigint, cd_fornec_consignado_p text, qt_material_p bigint) RETURNS varchar AS $body$
DECLARE


ie_retorno_w			varchar(1)	:= 'S';
cd_local_estoque_w		smallint;
cd_estabelecimento_w		integer;
ie_consignado_w			smallint;
cd_material_estoque_w		integer;
qt_estoque_w			double precision;
qt_material_w			double precision;
qt_conv_estoque_w		double precision;
cd_local_est_mat_esp_w		smallint := null;
ie_material_estoque_w		varchar(1);


BEGIN

select	coalesce(max(a.ie_consignado),0),
	max(a.cd_material_estoque),
	coalesce(max(b.ie_material_estoque),'S')
into STRICT	ie_consignado_w,
	cd_material_estoque_w,
	ie_material_estoque_w
from	material a,
	material_estab b
where	a.cd_material 		= b.cd_material
and	b.cd_estabelecimento	= wheb_usuario_pck.get_cd_estabelecimento
and	a.cd_material 		= cd_material_p;

if (ie_material_estoque_w = 'S') then
	select	max(a.cd_local_estoque),
		max(a.cd_estabelecimento)
	into STRICT	cd_local_estoque_w,
		cd_estabelecimento_w
	from	setor_atendimento a,
		cirurgia b,
		prescr_medica c
	where	a.cd_setor_atendimento = b.cd_setor_atendimento
	and	b.nr_cirurgia = c.nr_cirurgia
	and	c.nr_prescricao = nr_prescricao_p;


	cd_local_est_mat_esp_w := obter_param_usuario(900, 128, wheb_usuario_pck.get_cd_perfil, wheb_usuario_pck.get_nm_usuario, cd_estabelecimento_w, cd_local_est_mat_esp_w);

	if (cd_local_est_mat_esp_w > 0) then
		cd_local_estoque_w := 	cd_local_est_mat_esp_w;
	end if;

	if (ie_consignado_w = 0) or
		((ie_consignado_w = 2) and (coalesce(cd_fornec_consignado_p::text, '') = '')) then
		qt_estoque_w	:=	obter_saldo_disp_estoque(cd_estabelecimento_w,cd_material_p,cd_local_estoque_w,trunc(clock_timestamp(),'mm'));
	else
		qt_estoque_w	:=	obter_saldo_disp_consig(cd_estabelecimento_w,cd_fornec_consignado_p,cd_material_p,cd_local_estoque_w);
	end if;

	select	coalesce(max(qt_conv_estoque_consumo),1)
	into STRICT	qt_conv_estoque_w
	from	material
	where	cd_material = cd_material_estoque_w;

	qt_material_w	:= dividir(qt_material_p,qt_conv_estoque_w);

	if (qt_estoque_w < qt_material_w) then
		ie_retorno_w	:= 'N';
	end if;
end if;


return	ie_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_se_possui_qtde_disp_cir ( nr_prescricao_p bigint, cd_material_p bigint, cd_fornec_consignado_p text, qt_material_p bigint) FROM PUBLIC;

