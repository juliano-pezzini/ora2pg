-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_diluicao_medic (nr_sequencia_p bigint, nr_prescricao_p bigint) RETURNS varchar AS $body$
DECLARE

				
cd_material_w		integer;
cd_medic_w		integer;
qt_dose_w		double precision;
qt_dose_ml_w		double precision;
qt_dose_ml_final_w		double precision;
cd_unid_med_dose_w	varchar(30) := '';
ds_material_w		varchar(100);
ds_material_princ_w	varchar(100);
ie_possui_diluente_w	varchar(1);
ds_material_ww		varchar(100);
ds_reduzida_w		varchar(100);
ds_diluir_w		varchar(4000) := '';
ds_rediluir_w		varchar(4000) := '';
ds_retorno_w		varchar(2000) := '';
ds_reconstituir_w		varchar(2000) := '';
ds_adm_ui_w		varchar(2000) := '';
ds_hora_w		varchar(10) := '';
ie_administrar_ui_w		varchar(10) := '';
ie_aplicar_medic_w		varchar(10) := '';
ie_aplicar_ww		varchar(10) := '';
ie_um_prescrita_w		varchar(10);
ie_mostrar_aplic_ataque_w	varchar(10);
ie_agrupador_w		smallint;
ie_agrupador_ww		smallint;
nr_casas_w		bigint;
qt_reconst_w		double precision;
qt_dose_mat_w		double precision;
cd_setor_prescr_w		double precision;
cont_ww			double precision;
qt_dose_ml_teste_w	double precision;
qt_dose_ml_ataque_w	double precision;
qt_dose_especial_w	double precision;
qt_volume_cad_w		double precision;
qt_volume_equipo_w	double precision;
qt_ret_volume_equipo_w	double precision := 0;
qt_volume_ww		double precision;
cd_mat_ww		bigint;
qt_dose_mat_str_w		varchar(20) := '';
ie_separar_w		varchar(2);
cd_unid_med_dose_mat_w	varchar(30) := '';
qt_solucao_w		double precision := 0;
qt_solucao_str_w		varchar(10) :='';
ds_dose_diferenciada_w	varchar(50);
ds_ataque_w		varchar(50);
ds_erro_w		varchar(2000);
ie_ordem_w		smallint;
qt_solucao_ww		double precision := 0;
qt_min_aplicacao_w	smallint  := 0;
qt_min_aplicacao_ant_w	smallint  := 0;
qt_hora_aplicacao_ant_w				smallint  := 0;
qt_hora_aplicacao_w					smallint  := 0;
ds_min_aplicacao_w					varchar(255) := '';
cd_volume_final_w					double precision := 0;
mascara_w							smallint := 0;
qt_dose_str_w						varchar(20) := '';
cd_volume_final_str_w				varchar(20) := '';
qt_diluicao_w						double precision := 0;
qt_conversao_w						double precision;
qt_dose_dil_w						double precision;
cd_diluente_w						integer  := 0;
ds_diluente_w						varchar(100) := '';
qt_diluicao_str_w					varchar(20) := '';
ds_intervalo_w						varchar(100) := '';
cd_unidade_medida_w					varchar(30);
ie_fator_correcao_w					varchar(3);
ds_conv_ml_w						varchar(30) := '';
qt_conv_ml_w						double precision;
qt_conv_ml_ww						double precision;
qt_conv_ml_aux_w					double precision;
cd_estabelecimento_w				smallint;
qt_registro_w						smallint := 0;
ie_descr_redu_dil_w					varchar(1);
ds_aux_diluir_w						varchar(30);
ie_via_aplicacao_w					varchar(5);
cd_intervalo_w						varchar(7);
qt_ml_diluente_w					double precision;
ds_volume_w							varchar(100);
ds_tempo_w							varchar(100);
qt_dose_medic_ml_w					double precision;
ds_aplicar_w						varchar(200);
ds_diluicao_edit_w					varchar(2000);
ie_aplicar_w						varchar(1);
ds_dose_diluicao_w					varchar(100);
qt_dose_unid_med_cons_w				double precision;
qt_vol_adic_reconst_w				double precision;
qt_dose_medic_w						double precision;
ie_indice_w							smallint;
cd_material_red_w					integer;
qt_dose_red_w						double precision;
cd_unid_med_dose_red_w				varchar(30) := '';
qt_solucao_red_w					double precision := 0;
qt_dose_ml_red_w					double precision;
ds_material_red_ww					varchar(100);
ds_reduzida_red_w					varchar(100);
ds_material_red_w					varchar(100);
cd_volume_final_red_w				double precision := 0;
qt_diluicao_aux_w					double precision;
cd_unid_med_diluente_aux_w			varchar(50);
ie_mostrar_estabilidade_w			varchar(1);
qt_estagio_armazenamento_w			bigint;
ds_estagio_armazenamento_w			varchar(255);
qt_estabilidade_w					bigint;
ds_tempo_estabilidade_w				varchar(255);
ds_inf_adic_w						varchar(2000);
ie_higroscopico_w					varchar(1);
ie_fotosensivel_w					varchar(1);	
ie_mostrar_foto_w					varchar(1);
ie_termolabil_w						varchar(1);
nr_casas_diluicao_w					bigint;
ie_ConsisteDoseConsumoMedic_w		varchar(1) := 'S';	
qt_unit_medic_w						double precision;
qt_unit_medic_div_w					double precision;
ie_mostrar_concentracao_w			varchar(1);
qt_concentracao_total_w				double precision;
cd_unid_med_concetracao_w			varchar(50);
cd_unid_med_base_conc_w				varchar(50);
ds_total_reconst_w					varchar(255);
qt_volume_adic_w					double precision;
ie_apres_vol_reconst_w				varchar(1);
ie_possui_rediluente_w  			varchar(1);
qt_total_w							double precision;
qt_dose_aux_w						double precision;
qt_administrar_w					double precision;
qt_min_aplic_dose_esp_w				prescr_material.qt_min_aplic_dose_esp%type;
ie_proporcao_w						material_diluicao.ie_proporcao%type;				
qt_volume_medic_w					material_diluicao.qt_volume_medic%type;
ds_forma_arma_w						varchar(255);
qt_conversao_ww						material_conversao_unidade.qt_conversao%type;
qt_result_conv_ml_w					double precision;
ie_possui_regra_ui_w				varchar(1);
ie_aplic_bolus_w					prescr_material.ie_aplic_bolus%type;
ie_lentamente_w 					prescr_material.ie_aplic_lenta%type;
ds_informacao_item_w 				varchar(2000);
ie_agrupador_origem_w				prescr_material.ie_agrupador%type;
nr_agrupamento_w					prescr_material.nr_agrupamento%type;
qt_dose_agrup_w						prescr_material.qt_dose%type;
cd_um_agrup_w						prescr_material.cd_unidade_medida_dose%type;	
cd_mat_agrup_w					    prescr_material.cd_material%type;	
qt_total_agrup_w					double precision	:= 0;
cd_msg_w							dic_objeto.nr_sequencia%type	:= 307111;
ie_dose_ataque_w					cpoe_material.ie_dose_ataque%type;
ie_dose_adicional_w					cpoe_material.ie_dose_adicional%type;
ds_dose_dif_dil_w					prescr_material.ds_dose_diferenciada%type;
ds_dose_dif_while_w					prescr_material.ds_dose_diferenciada%type;
ds_dose_dif_dil_while_w				prescr_material.ds_dose_diferenciada%type;
ie_dose_dif_gerada_w				varchar(1) := 'N';
qt_dil_ml_w							double precision;
nr_seq_dieta_cpoe_w					cpoe_dieta.nr_sequencia%type;
qt_kcal_nutri_w						cpoe_dieta.qt_kcal_nutri%type;
cd_funcao_w                         prescr_medica.cd_funcao_origem%type;
nr_seq_mat_cpoe_w                   cpoe_material.nr_sequencia%type;
ds_orientacao_preparo_w             cpoe_material.ds_orientacao_preparo%type;
ds_localizacao_PT_w				constant varchar(10) := 'pt_BR';
ds_localizacao_AU_w				constant varchar(10) := 'en_AU';
cd_texto_padrao_AU_w			constant dic_objeto.nr_sequencia%type := 307055;
cd_texto_padrao_pt_1_w			constant dic_objeto.nr_sequencia%type := 307023;
cd_texto_padrao_pt_2_w			constant dic_objeto.nr_sequencia%type := 307087;
cd_texto_padrao_pt_3_w			constant dic_objeto.nr_sequencia%type := 307090;
ds_texto_reconst_AU_w			constant varchar(50) := 'DS_RECONSTITUIR_W=';
ds_texto_unidade_AU_w			constant varchar(50) := ';CD_UNIDADE_MEDIDA_W=';
ds_texto_mat_princ_AU_w			constant varchar(50) := ';DS_MAT_PRINC_W=';
ds_texto_qt_dose_AU_w			constant varchar(50) := ';QT_DOSE_STR_W=';
ds_texto_unidade_dose_AU_w		constant varchar(50) := ';CD_UNID_MED_DOSE_W=';
ds_texto_material_AU_w			constant varchar(50) := ';DS_MATERIAL_W=';
ds_texto_total_reconst_AU_w		constant varchar(50) := ';DS_TOTAL_RECONST_W=';
ds_texto_espaco_w				constant varchar(5)  := ' ';
cd_num_char_13_w					constant integer := 13;
cd_num_char_10_w					constant integer := 10;

c00 CURSOR FOR
SELECT	b.qt_dose,
		b.qt_min_aplicacao,
		b.qt_hora_aplicacao,
		b.cd_unidade_medida_dose,
		b.qt_solucao,
		b.cd_unidade_medida,
		b.cd_material,
		a.cd_estabelecimento,
		b.cd_intervalo,
		b.ie_via_aplicacao,
		b.ds_dose_diferenciada,
		1 ie_indice,
		null ds_hora,
		1 ie_ordem,
		0 qt_diluicao,
		null cd_unid_med_diluente,
		a.cd_setor_atendimento,
		b.qt_unitaria,
		b.ie_agrupador,
		Obter_vol_Dispositivo_solucao(b.ie_bomba_infusao),
		coalesce(b.ie_fator_correcao,'N'),
		b.qt_dose_especial,
		b.qt_min_aplic_dose_esp,
		coalesce(b.ie_aplic_bolus,'N'),
		coalesce(b.ie_aplic_lenta,'N'),
		b.nr_seq_dieta_cpoe
from 	prescr_material b,
		prescr_medica a
where 	a.nr_prescricao	= b.nr_prescricao
and		b.nr_sequencia	= nr_sequencia_p
and		a.nr_prescricao	= nr_prescricao_p
and		b.ie_agrupador	in (1, 5, 8, 12, 14)
and		not exists (	SELECT	1
						from	prescr_mat_diluicao x
						where	x.nr_prescricao	= b.nr_prescricao
						and		x.nr_seq_material = b.nr_sequencia)

union

select	coalesce(c.qt_dose_diferenciada, b.qt_dose),
		coalesce(c.qt_min_aplicacao, b.qt_min_aplicacao),
		b.qt_hora_aplicacao,
		b.cd_unidade_medida_dose,
		b.qt_solucao,
		b.cd_unidade_medida,
		b.cd_material,
		a.cd_estabelecimento,
		b.cd_intervalo,
		b.ie_via_aplicacao,
		b.ds_dose_diferenciada,
		2 ie_indice,
		c.ds_hora,
		c.ie_ordem,
		c.qt_diluicao,
		c.cd_unid_med_diluente,
		a.cd_setor_atendimento,
		b.qt_unitaria,
		b.ie_agrupador,
		Obter_vol_Dispositivo_solucao(b.ie_bomba_infusao),
		coalesce(b.ie_fator_correcao,'N'),
		b.qt_dose_especial,
		b.qt_min_aplic_dose_esp,
		coalesce(b.ie_aplic_bolus,'N'),
		coalesce(b.ie_aplic_lenta,'N'),
		b.nr_seq_dieta_cpoe
from 	prescr_mat_diluicao c,
		prescr_material b,
		prescr_medica a
where 	a.nr_prescricao	= b.nr_prescricao
and		c.nr_prescricao	= b.nr_prescricao
and		c.nr_seq_material = b.nr_sequencia
and		b.nr_sequencia	= nr_sequencia_p
and		a.nr_prescricao	= nr_prescricao_p
and		b.ie_agrupador	in (1,5,8,12, 14)
order by ie_ordem;

c01 CURSOR FOR
SELECT	a.cd_material,
		a.qt_dose,
		coalesce(a.qt_vol_adic_reconst,0),
		a.qt_min_aplicacao,
		a.qt_hora_aplicacao,
		a.cd_unidade_medida_dose,
		a.ie_agrupador,
		a.qt_solucao,
		obter_conversao_ml(a.cd_material,a.qt_dose,a.cd_unidade_medida_dose),
		substr(b.ds_material,1,100),
		substr(b.ds_reduzida,1,100),
		ie_diluir_inteiro,
		x.qt_volume,
		x.qt_concentracao_total,
		x.cd_unid_med_concetracao,
		x.cd_unid_med_base_conc,
		x.ie_proporcao,
		x.qt_volume_medic,
		a.ds_dose_diferenciada
FROM material b, prescr_material a
LEFT OUTER JOIN material_diluicao x ON (a.nr_seq_mat_diluicao = x.nr_seq_interno)
WHERE ((a.nr_sequencia_diluicao = nr_sequencia_p) or (a.nr_sequencia = nr_sequencia_p)) and a.nr_prescricao		= nr_prescricao_p  and a.cd_material = b.cd_material and a.ie_agrupador IN (3,7,9) order by a.ie_agrupador desc;

c02 CURSOR FOR
SELECT	qt_dose,
		cd_unidade_medida_dose,
		cd_material		
from	prescr_material
where	nr_prescricao	= nr_prescricao_p
and		nr_sequencia	<> nr_sequencia_p
and		nr_agrupamento	= nr_agrupamento_w
and		ie_agrupador	= 1
and		ie_agrupador	= ie_agrupador_origem_w
and		ie_origem_inf	<> 'K'
and		coalesce(nr_seq_kit::text, '') = ''
and 	coalesce(nr_seq_substituto::text, '') = ''
and 	coalesce(ie_suspenso, 'N') = 'N';


BEGIN
		

select	max(a.ds_diluicao_edit),
		max(a.cd_material),
		max(coalesce(b.ie_aplicar,'S')),
		max(coalesce(a.ie_aplicar,'X')),
		max(coalesce(obter_conversao_ml(a.cd_material, a.qt_dose, a.cd_unidade_medida_dose), a.qt_dose)),
		coalesce(max(a.ie_aplic_bolus),'N'),
		coalesce(max(a.ie_aplic_lenta),'N'),
		max(a.ie_agrupador),
		max(a.nr_agrupamento),
		substr(max(b.ds_material),1,100) ds_material,
        max(a.nr_seq_mat_cpoe) nr_seq_mat_cpoe
into STRICT	ds_diluicao_edit_w,
		cd_mat_ww,
		ie_aplicar_medic_w,
		ie_aplicar_ww,
		qt_dose_medic_w,
		ie_aplic_bolus_w,
		ie_lentamente_w,
		ie_agrupador_origem_w,
		nr_agrupamento_w,
		ds_material_princ_w,
        nr_seq_mat_cpoe_w
from	prescr_material a,
		material b
where	a.cd_material	= b.cd_material
and		a.nr_prescricao	= nr_prescricao_p
and		a.nr_sequencia	= nr_sequencia_p;

select  max(a.cd_funcao_origem)
into STRICT    cd_funcao_w
from    prescr_medica a
where   a.nr_prescricao = nr_prescricao_p;

select	max(a.qt_dose)
into STRICT	qt_dose_dil_w
from 	prescr_material a
where 	a.nr_sequencia_diluicao = nr_sequencia_p
  and 	a.nr_prescricao			= nr_prescricao_p
  and 	a.ie_agrupador			in (3);

if (ie_aplicar_ww = 'N') then
	ie_aplicar_medic_w	:= 'N';
elsif (ie_aplicar_ww = 'S') then
	ie_aplicar_medic_w	:= 'S';
end if;

ds_informacao_item_w := null;
if (wheb_usuario_pck.get_cd_funcao = 1113) then
	if (ie_aplic_bolus_w = 'S') then
		ds_informacao_item_w := wheb_mensagem_pck.get_texto(886236, null);
	elsif (ie_lentamente_w = 'S') then
		ds_informacao_item_w :=  wheb_mensagem_pck.get_texto(886235, null);
	end if;
end if;

if	((coalesce(ds_diluicao_edit_w::text, '') = '') or (coalesce(wheb_usuario_pck.get_cd_funcao,1) = 1113)) then


	if (wheb_usuario_pck.get_cd_funcao = 1113) then

		open c02;
		loop
		fetch c02 into	
			qt_dose_agrup_w,
			cd_um_agrup_w,
			cd_mat_agrup_w;
		EXIT WHEN NOT FOUND; /* apply on c02 */
			begin
					
					
			if	((qt_dose_agrup_w > 0) and (obter_unid_med_usua('ml') <> cd_um_agrup_w)) then
				qt_total_agrup_w	:=  qt_total_agrup_w + Obter_dose_convertida(cd_mat_agrup_w, qt_dose_agrup_w, cd_um_agrup_w, obter_unid_med_usua('ml'));
			else
				qt_total_agrup_w	:= 	qt_total_agrup_w + qt_dose_agrup_w;
			end if;
		
			end;
		end loop;
		close c02;
		
	end if;
	
	ie_possui_diluente_w	:= 'N';
	ie_possui_rediluente_w  := 'N';
	
	select 	max(b.ie_agrupador)
	into STRICT	ie_agrupador_w
	from 	prescr_material b,
		prescr_medica a
	where 	a.nr_prescricao	= b.nr_prescricao
	and	b.nr_sequencia	= nr_sequencia_p
	and	a.nr_prescricao	= nr_prescricao_p;

	if (pkg_i18n.get_user_locale = 'en_AU') and (ie_agrupador_w in (1,4,8)) then
		if (ie_agrupador_w = 8) then
			select	max(ds_orientacao)
			into STRICT	ds_retorno_w
			from	cpoe_dieta
			where 	nr_sequencia = (SELECT 	max(nr_seq_dieta_cpoe)
						from 	prescr_material
						where	nr_prescricao = nr_prescricao_p
						and	nr_sequencia  = nr_sequencia_p);
		elsif (coalesce(ds_retorno_w::text, '') = '') then
			select	max(ds_orientacao_preparo)
			into STRICT	ds_retorno_w
			from	cpoe_material
			where 	nr_sequencia = (SELECT 	max(nr_seq_mat_cpoe)
						from 	prescr_material
						where	nr_prescricao = nr_prescricao_p
						and	nr_sequencia  = nr_sequencia_p);
		end if;
	else
		open C00;
		loop
		fetch C00 into	
			qt_dose_mat_w,
			qt_min_aplicacao_w,
			qt_hora_aplicacao_w,
			cd_unid_med_dose_mat_w,
			qt_solucao_ww,
			cd_unidade_medida_w,
			cd_medic_w,
			cd_estabelecimento_w,
			cd_intervalo_w,
			ie_via_aplicacao_w,
			ds_dose_diferenciada_w,
			ie_indice_w,
			ds_hora_w,
			ie_ordem_w,
			qt_diluicao_aux_w,
			cd_unid_med_diluente_aux_w,
			cd_setor_prescr_w,
			qt_unit_medic_w,
			ie_agrupador_ww,
			qt_volume_equipo_w,
			ie_fator_Correcao_w,
			qt_dose_especial_w,
			qt_min_aplic_dose_esp_w,
			ie_aplic_bolus_w,
			ie_lentamente_w,
			nr_seq_dieta_cpoe_w;
		EXIT WHEN NOT FOUND; /* apply on C00 */
		
		
			if (wheb_usuario_pck.get_cd_funcao = 1113) then
				if (ie_aplic_bolus_w = 'S') then
					ds_informacao_item_w := wheb_mensagem_pck.get_texto(886236, null);
				elsif (ie_lentamente_w = 'S') then
					ds_informacao_item_w :=  wheb_mensagem_pck.get_texto(886235, null);
				end if;
			end if;
					
			if (coalesce(ie_fator_Correcao_w,'N') = 'S') and (coalesce(qt_volume_equipo_w,0) > 0) and (coalesce(qt_dose_medic_w,0) > 0) and (coalesce(qt_dose_dil_w,0) > 0) then
				qt_total_w		:= qt_dose_medic_w + qt_dose_dil_w;
				qt_dose_aux_w	:= dividir((qt_dose_medic_w * 100), qt_total_w);	/*regra de 3 - pegar o percentual que a dose do medicamento representa em relacao a dose total somada com o diluente*/
				qt_conv_ml_w	:= dividir((qt_dose_aux_w * qt_volume_equipo_w), 100) + qt_dose_medic_w;	/* Regra de 3 para ver quanto sera repassado a dose do medicamento, de acordo com o percentual que a dose representa */
		
				qt_dose_mat_w	:= qt_conv_ml_w;		
			else
				select	obter_conversao_ml(cd_medic_w,qt_dose_mat_w,cd_unid_med_dose_mat_w)
				into STRICT	qt_conv_ml_w
				;
			end if;	

			if (coalesce(qt_conv_ml_w,0) = 0) then
				select	obter_conversao_ml(cd_medic_w,qt_dose_mat_w,cd_unid_med_dose_mat_w)
				into STRICT	qt_conv_ml_w
				;
			end if;
		
			select	coalesce(max(nr_casas_diluicao),0),
					coalesce(max(ie_separar),'S'),
					coalesce(max(ie_administrar_ui),'N'),
					coalesce(max(ie_aplicar),'N'),
					coalesce(max(ie_descr_redu_dil),'N'),
					coalesce(max(ie_mostrar_estabilidade),'N'),
					coalesce(max(ie_apres_vol_reconst),'N'),
					coalesce(max(ie_mostrar_aplic_ataque),'N'),
					coalesce(max(ie_mostrar_foto),'S'),
					coalesce(max(ie_mostrar_concentracao),'N')
			into STRICT	nr_casas_diluicao_w,
					ie_separar_w,
					ie_administrar_ui_w,
					ie_aplicar_w,
					ie_descr_redu_dil_w,
					ie_mostrar_estabilidade_w,
					ie_apres_vol_reconst_w,
					ie_mostrar_aplic_ataque_w,
					ie_mostrar_foto_w,
					ie_mostrar_concentracao_w
			from	parametro_medico
			where	cd_estabelecimento	= cd_estabelecimento_w;
			
			select	coalesce(max(qt_conversao),1)
			into STRICT	qt_conversao_ww
			from	material_conversao_unidade
			where	cd_material = cd_medic_w
			and		upper(cd_unidade_medida) = upper(cd_unid_med_dose_mat_w);
			select	max(obter_casas_diluicao(cd_mat_ww, cd_setor_prescr_w))
			into STRICT	nr_casas_w
			;
			
			if (nr_casas_w > 0) then
				nr_casas_diluicao_w	:= nr_casas_w;
			end if;
			
			
			if (cd_intervalo_w IS NOT NULL AND cd_intervalo_w::text <> '') then
				select	max(ds_prescricao)
				into STRICT	ds_intervalo_w
				from	intervalo_prescricao
				where	cd_intervalo	= cd_intervalo_w;
				
				if (ie_via_aplicacao_w IS NOT NULL AND ie_via_aplicacao_w::text <> '') then
					ds_intervalo_w	:= ds_intervalo_w ||' '|| obter_desc_via(ie_via_aplicacao_w);
				end if;
			end if;
			
			select	coalesce(max(ie_um_prescrita),'N')
			into STRICT	ie_um_prescrita_w
			from	regra_unid_med_diluente
			where	cd_setor_atendimento 	= cd_setor_prescr_w
			and		coalesce(cd_unidade_medida,cd_unid_med_dose_mat_w)	= cd_unid_med_dose_mat_w;
			
			if (ie_um_prescrita_w = 'S') then
				qt_conv_ml_w	:= 0;
			end if;
			

			if (qt_conv_ml_w > 0) then
				if (qt_conv_ml_w >= 1) or (round(qt_conv_ml_w,nr_casas_diluicao_w) >= 1) then
					if (nr_casas_diluicao_w = 0) then
						ds_conv_ml_w	:= to_char(qt_conv_ml_w) || ' ' || obter_desc_unid_med(obter_unid_med_usua('ml'));
					else
						ds_conv_ml_w	:= to_char(round(qt_conv_ml_w,nr_casas_diluicao_w))|| ' ' || obter_desc_unid_med(obter_unid_med_usua('ml'));
					end if;
				elsif (nr_casas_diluicao_w = 0) then
					ds_conv_ml_w	:= '0'||to_char(qt_conv_ml_w)||' '||obter_desc_unid_med(obter_unid_med_usua('ml'));
				else
					ds_conv_ml_w	:= '0'||to_char(round(qt_conv_ml_w,nr_casas_diluicao_w))||' '||obter_desc_unid_med(obter_unid_med_usua('ml'));
				end if;
			end if;
							
			qt_dose_mat_str_w	:= qt_dose_mat_w;
			

			open c01;
			loop
			fetch c01 into
				cd_material_w,
				qt_dose_w,
				qt_vol_adic_reconst_w,
				qt_min_aplicacao_ant_w,
				qt_hora_aplicacao_ant_w,
				cd_unid_med_dose_w,
				ie_agrupador_w,
				qt_solucao_w,
				qt_dose_ml_w,
				ds_material_ww,
				ds_reduzida_w,
				ie_ConsisteDoseConsumoMedic_w,
				qt_volume_cad_w,
				qt_concentracao_total_w,
				cd_unid_med_concetracao_w,
				cd_unid_med_base_conc_w,
				ie_proporcao_w,
				qt_volume_medic_w,
				ds_dose_dif_dil_w;
			EXIT WHEN NOT FOUND; /* apply on c01 */
				begin
				
				if (ie_ConsisteDoseConsumoMedic_w = 'N') and (coalesce(ie_proporcao_w,'F') = 'F') and (coalesce(qt_volume_medic_w,0) > 0) then
				   qt_conv_ml_w := qt_volume_medic_w;
				end if;
										

				if (ie_agrupador_w = 3) and (coalesce(ie_fator_Correcao_w,'N') = 'S') and (coalesce(qt_volume_equipo_w,0) > 0) and (coalesce(qt_dose_medic_w,0) > 0) and (coalesce(qt_dose_ml_w,0) > 0) then
					qt_total_w		:= qt_dose_medic_w + qt_dose_ml_w;
					qt_dose_aux_w	:= dividir((qt_dose_ml_w * 100), qt_total_w);	/*regra de 3 - pegar o percentual que a dose do medicamento representa em relacao a dose total somada com o diluente*/
					qt_dose_ml_w	:= dividir((qt_dose_aux_w * qt_volume_equipo_w), 100) + qt_dose_ml_w;	/* Regra de 3 para ver quanto sera repassado a dose do medicamento, de acordo com o percentual que a dose representa */
				end if;	
				
				select	CASE WHEN qt_unit_medic_w=0 THEN 1  ELSE qt_unit_medic_w END
				into STRICT	qt_unit_medic_div_w 
				;
				
				if (ie_ConsisteDoseConsumoMedic_w = 'S') then

					qt_dose_mat_w	:= obter_dose_convertida(cd_medic_w, ceil(qt_unit_medic_w),
										cd_unidade_medida_w,cd_unid_med_dose_mat_w);

					select	obter_conversao_ml(cd_medic_w,qt_dose_mat_w,cd_unid_med_dose_mat_w)
					into STRICT	qt_conv_ml_w
					;
					
					select	coalesce(max(ie_um_prescrita),'N')
					into STRICT	ie_um_prescrita_w
					from	regra_unid_med_diluente
					where	cd_setor_atendimento 	= cd_setor_prescr_w
					and		coalesce(cd_unidade_medida,cd_unid_med_dose_mat_w)	= cd_unid_med_dose_mat_w;
					
					if (ie_um_prescrita_w = 'S') then
						qt_conv_ml_w	:= 0;
					end if;

					if (qt_conv_ml_w > 0) and (upper(cd_unid_med_dose_mat_w) <> upper(obter_unid_med_usua('ML'))) then
						if (qt_conv_ml_w >= 1) then
							if (nr_casas_diluicao_w = 0) then
								ds_conv_ml_w	:= to_char(qt_conv_ml_w)||' '||obter_desc_unid_med(obter_unid_med_usua('ml'));
							else
								ds_conv_ml_w	:= to_char(round(qt_conv_ml_w,nr_casas_diluicao_w))||' '||obter_desc_unid_med(obter_unid_med_usua('ml'));
							end if;
						elsif (nr_casas_diluicao_w = 0) then
							ds_conv_ml_w	:= '0'||to_char(qt_conv_ml_w)||' '||obter_desc_unid_med(obter_unid_med_usua('ml'));
						else
							ds_conv_ml_w	:= '0'||to_char(round(qt_conv_ml_w,nr_casas_diluicao_w))||' '|| obter_desc_unid_med(obter_unid_med_usua('ml'));
						end if;
						
					end if;
				
					qt_dose_mat_str_w	:= qt_dose_mat_w;
				end if;
				
				if (cd_material_w IS NOT NULL AND cd_material_w::text <> '') and (qt_dose_w IS NOT NULL AND qt_dose_w::text <> '') and (cd_unid_med_dose_w IS NOT NULL AND cd_unid_med_dose_w::text <> '') and (ie_agrupador_w = 9) and (coalesce(qt_registro_w,0) = 0) then
					begin
					select	obter_conversao_ml(cd_material_w, qt_dose_w, cd_unid_med_dose_w) + qt_vol_adic_reconst_w
					into STRICT	qt_conv_ml_w
					;
							
					select	coalesce(max(ie_um_prescrita),'N')
					into STRICT	ie_um_prescrita_w
					from	regra_unid_med_diluente
					where	cd_setor_atendimento 	= cd_setor_prescr_w
					and	coalesce(cd_unidade_medida,cd_unid_med_dose_w)	= cd_unid_med_dose_w;
					
					if (ie_um_prescrita_w = 'S') then
						qt_conv_ml_w	:= 0;
					end if;
					
					qt_conv_ml_aux_w	:= obter_conversao_ml(cd_medic_w,qt_dose_mat_w,cd_unid_med_dose_mat_w);
					
					if (qt_conv_ml_aux_w > 0) then
						begin
							qt_conv_ml_w	:= qt_conv_ml_aux_w;
						end;
					else
						begin
							if (upper(cd_unid_med_dose_mat_w) = upper(obter_unid_med_usua('ML'))) then
								begin
								qt_conv_ml_w	:= qt_dose_mat_w;
								end;
							else
								begin
									qt_dose_unid_med_cons_w	:= obter_conversao_unid_med_cons(cd_medic_w,cd_unid_med_dose_mat_w,qt_dose_mat_w);
									qt_conv_ml_w := qt_dose_unid_med_cons_w * qt_conv_ml_w;
									qt_conv_ml_ww := qt_conv_ml_w;
								end;
							end if;
						end;
					end if;
					
					if (coalesce(ie_fator_Correcao_w,'N') = 'S') and (coalesce(qt_volume_equipo_w,0) > 0) and (coalesce(qt_dose_medic_w,0) > 0) and (coalesce(qt_dose_ml_w,0) > 0) then
						qt_conv_ml_w	:= dividir((qt_dose_aux_w * qt_volume_equipo_w), 100) + qt_conv_ml_w;	/* Regra de 3 para ver quanto sera repassado a dose do medicamento, de acordo com o percentual que a dose representa */
					end if;
					
					if (qt_conv_ml_w > 0) then
						if (qt_conv_ml_w >= 1) then
							if (nr_casas_diluicao_w = 0) then
								ds_conv_ml_w	:= to_char(qt_conv_ml_w)||' '||obter_desc_unid_med(obter_unid_med_usua('ml'));
							else
								ds_conv_ml_w	:= to_char(round(qt_conv_ml_w,nr_casas_diluicao_w))||' '||obter_desc_unid_med(obter_unid_med_usua('ml'));
							end if;
						elsif (nr_casas_diluicao_w = 0) then
							ds_conv_ml_w	:= '0'||to_char(qt_conv_ml_w)||' '||obter_desc_unid_med(obter_unid_med_usua('ml'));
						else
							ds_conv_ml_w	:= '0'||to_char(round(qt_conv_ml_w,nr_casas_diluicao_w))||' '||obter_desc_unid_med(obter_unid_med_usua('ml'));
						end if;				
					end if;
				
					select 	CASE WHEN ie_descr_redu_dil_w='S' THEN ds_reduzida_w  ELSE ds_material_ww END
					into STRICT	ds_material_w
					;
					
					if (qt_dose_w < 1) or (mod(qt_dose_w, trunc(qt_dose_w)) <> 0) then
						mascara_w	:= 0;
					else
						mascara_w	:= 1;
					end if;		

					if (nr_casas_diluicao_w > 3) then
						nr_casas_diluicao_w := 3;
					end if;				

					Select 	CASE WHEN mascara_w=0 THEN  campo_mascara(qt_dose_w, nr_casas_diluicao_w)  ELSE campo_mascara(qt_dose_w, 0) END
					into STRICT	qt_dose_str_w
					;
					
					select	max(qt_conversao)
					into STRICT	qt_conversao_w
					from	material_conversao_unidade
					where	cd_material		= cd_medic_w
					and	cd_unidade_medida	= cd_unidade_medida_w;
								
					if (ie_apres_vol_reconst_w = 'S') and (qt_vol_adic_reconst_w > 0) then
						
						select	obter_conversao_ml(cd_material_w,qt_dose_w, cd_unid_med_dose_w) + qt_vol_adic_reconst_w
						into STRICT	qt_volume_adic_w
						;
						
						ds_total_reconst_w := ' ' || Wheb_mensagem_pck.get_texto(309288, 'QT_VOLUME_ADIC_W='||qt_volume_adic_w); --' (Volume total apos reconstituicao '|| qt_volume_adic_w ||' ml).';					
					end if;
					
					if (coalesce(pkg_i18n.get_user_locale, ds_localizacao_PT_w) = ds_localizacao_AU_w) then
						if (coalesce(qt_conversao_w::text, '') = '') then
							ds_reconstituir_w := Wheb_mensagem_pck.get_texto(nr_seq_mensagem_p => cd_texto_padrao_AU_w,
										Vl_Macros_P => ds_texto_reconst_AU_w || ds_reconstituir_w ||
										ds_texto_unidade_AU_w || obter_desc_unid_med(cd_unidade_medida_w) ||
										ds_texto_mat_princ_AU_w|| ds_material_princ_w ||
										ds_texto_qt_dose_AU_w || replace_number_locale(qt_dose_str_w) ||
										ds_texto_unidade_dose_AU_w || obter_desc_unid_med(cd_unid_med_dose_w) ||
										ds_texto_material_AU_w || ds_material_w || ds_texto_espaco_w ||
										ds_texto_total_reconst_AU_w || coalesce(ds_total_reconst_w,ds_texto_espaco_w)
										) || chr(cd_num_char_13_w) || chr(cd_num_char_10_w);						
						else                  								
							ds_reconstituir_w := Wheb_mensagem_pck.get_texto(nr_seq_mensagem_p => cd_texto_padrao_AU_w,
										Vl_Macros_P => ds_texto_reconst_AU_w || ds_reconstituir_w ||
										ds_texto_unidade_AU_w || obter_desc_unid_med(cd_unidade_medida_w) ||
										ds_texto_espaco_w || qt_conversao_w ||
										ds_texto_qt_dose_AU_w || replace_number_locale(qt_dose_str_w) ||
										ds_texto_mat_princ_AU_w|| ds_material_princ_w ||
										ds_texto_unidade_dose_AU_w || obter_desc_unid_med(cd_unid_med_dose_w) ||
										ds_texto_material_AU_w || ds_material_w || ds_texto_espaco_w ||
										ds_texto_total_reconst_AU_w || coalesce(ds_total_reconst_w,ds_texto_espaco_w)
										) || chr(cd_num_char_13_w) || chr(cd_num_char_10_w);
						end if;
					else
						if (coalesce(qt_conversao_w::text, '') = '') then
							ds_reconstituir_w := 	ds_reconstituir_w ||Wheb_mensagem_pck.get_texto(cd_texto_padrao_pt_1_w) || ds_texto_espaco_w /*'Reconstituir cada '*/
 ||obter_desc_unid_med(cd_unidade_medida_w)|| 
									ds_texto_espaco_w || Wheb_mensagem_pck.get_texto(cd_texto_padrao_pt_2_w) || ds_texto_espaco_w /*' em '*/
||replace_number_locale(qt_dose_str_w)||ds_texto_espaco_w||obter_desc_unid_med(cd_unid_med_dose_w)||
									ds_texto_espaco_w || Wheb_mensagem_pck.get_texto(cd_texto_padrao_pt_3_w) || ds_texto_espaco_w /*' de '*/
||ds_material_w || coalesce(ds_total_reconst_w,ds_texto_espaco_w) || chr(cd_num_char_13_w) || chr(cd_num_char_10_w);		
						else
							ds_reconstituir_w := 	ds_reconstituir_w ||Wheb_mensagem_pck.get_texto(cd_texto_padrao_pt_1_w) || ds_texto_espaco_w /*'Reconstituir cada '*/
 || qt_conversao_w || ds_texto_espaco_w ||obter_desc_unid_med(cd_unidade_medida_w)||
									ds_texto_espaco_w ||Wheb_mensagem_pck.get_texto(cd_texto_padrao_pt_2_w) /*' em '*/
|| ds_texto_espaco_w ||replace_number_locale(qt_dose_str_w)||ds_texto_espaco_w||obter_desc_unid_med(cd_unid_med_dose_w)||
									ds_texto_espaco_w ||Wheb_mensagem_pck.get_texto(cd_texto_padrao_pt_3_w) /*' de '*/
|| ds_texto_espaco_w ||ds_material_w || coalesce(ds_total_reconst_w,ds_texto_espaco_w) || chr(cd_num_char_13_w) || chr(cd_num_char_10_w);
						end if;				
					end if;
					end;
				end if;
				
				if (ie_indice_w		= 2) and (coalesce(qt_registro_w,0)	= 0) and (coalesce(ds_rediluir_w::text, '') = '') then
					
					select	max(a.cd_material),
							max(a.qt_dose),
							max(a.cd_unidade_medida_dose),
							max(a.qt_solucao),
							max(obter_conversao_ml(a.cd_material,a.qt_dose,a.cd_unidade_medida_dose)),
							max(substr(b.ds_material,1,100)),
							max(substr(b.ds_reduzida,1,100))
					into STRICT	cd_material_red_w,
							qt_dose_red_w,
							cd_unid_med_dose_red_w,
							qt_solucao_red_w,
							qt_dose_ml_red_w,
							ds_material_red_ww,
							ds_reduzida_red_w
					from 	material b,
							prescr_material a
					where 	((a.nr_sequencia_diluicao = nr_sequencia_p) or (a.nr_sequencia = nr_sequencia_p))
					  and 	a.nr_prescricao = nr_prescricao_p
					  and	a.cd_material = b.cd_material
					  and	a.ie_agrupador = 7;

					if (cd_material_red_w IS NOT NULL AND cd_material_red_w::text <> '') and (qt_dose_red_w IS NOT NULL AND qt_dose_red_w::text <> '') and (cd_unid_med_dose_red_w IS NOT NULL AND cd_unid_med_dose_red_w::text <> '') then
				
						select 	CASE WHEN ie_descr_redu_dil_w='S' THEN ds_reduzida_red_w  ELSE ds_material_red_ww END
						into STRICT	ds_material_red_w
						;
						
						cd_volume_final_red_w := qt_dose_ml_red_w + qt_solucao_red_w;
						
						if (nr_casas_diluicao_w > 0) then
							qt_solucao_red_w	:= round(qt_solucao_red_w,nr_casas_diluicao_w);
						end if;
						
						if (nr_casas_diluicao_w > 0) then
							qt_dose_ml_red_w	:= round(qt_dose_ml_red_w,nr_casas_diluicao_w);
						end if;
						
						if (nr_casas_diluicao_w > 0) then
							qt_dose_red_w	:= round(qt_dose_red_w,nr_casas_diluicao_w);
						end if;
					
						if (qt_solucao_red_w < 1) or (mod(qt_solucao_red_w, trunc(qt_solucao_red_w)) <> 0) then
							mascara_w	:= 0;
						else
							mascara_w	:= 1;
						end if;

						ds_dose_diluicao_w	:= replace_number_locale(qt_dose_ml_red_w) ||' '||obter_desc_unid_med(obter_unid_med_usua('ml'));
						if (qt_dose_ml_red_w = 0) then
							begin
							ds_dose_diluicao_w	:= replace_number_locale(qt_dose_red_w) ||' '||obter_desc_unid_med(cd_unid_med_dose_red_w);
							end;
						end if;
						
						select 	CASE WHEN mascara_w=0 THEN  campo_mascara(qt_solucao_red_w, 2)  ELSE campo_mascara(qt_solucao_red_w, 0) END
						into STRICT	qt_solucao_str_w
						;

						if (ie_separar_w = 'S') then
							ds_rediluir_w := ds_rediluir_w||Wheb_mensagem_pck.get_texto(307089) || ' ' /*'Separar '*/||replace_number_locale(qt_solucao_str_w)||' '||obter_desc_unid_med(obter_unid_med_usua('ml'))|| ' ' || Wheb_mensagem_pck.get_texto(307105) || ' ' /*' desta solucao em '*/||
									ds_dose_diluicao_w ||' ' || Wheb_mensagem_pck.get_texto(307090) || ' ' /*' de '*/||ds_material_red_w || chr(13) || chr(10);
						else
							ds_rediluir_w := ds_rediluir_w||Wheb_mensagem_pck.get_texto(307184) || ' ' /*'Rediluir '*/||replace_number_locale(qt_solucao_str_w)||' '||obter_desc_unid_med(obter_unid_med_usua('ml'))|| ' ' || Wheb_mensagem_pck.get_texto(307105) || ' ' /*' desta solucao em '*/||
									ds_dose_diluicao_w || ' ' || Wheb_mensagem_pck.get_texto(307090) || ' ' /*' de '*/||ds_material_red_w || chr(13) || chr(10);
						end if;
					end if;
				end if;
				

				if (cd_material_w IS NOT NULL AND cd_material_w::text <> '') and (qt_dose_w IS NOT NULL AND qt_dose_w::text <> '') and (cd_unid_med_dose_w IS NOT NULL AND cd_unid_med_dose_w::text <> '') and (ie_agrupador_w = 3) then
					begin
					
					select	coalesce(max(ie_um_prescrita),'N')
					into STRICT	ie_um_prescrita_w
					from	regra_unid_med_diluente
					where	cd_setor_atendimento 	= cd_setor_prescr_w
					and		coalesce(cd_unidade_medida,cd_unid_med_dose_mat_w)	= cd_unid_med_dose_mat_w;
					
					if (ie_um_prescrita_w = 'S') then
						qt_dose_ml_w	:= 0;
					end if;
					
					qt_ml_diluente_w	:= qt_dose_ml_w;
					
					select 	CASE WHEN ie_descr_redu_dil_w='S' THEN ds_reduzida_w  ELSE ds_material_ww END
					into STRICT	ds_material_w
					;
					
					if (ie_agrupador_ww = 8) or (ie_agrupador_ww = 12) then
						ds_aux_diluir_w	:= ' ' || Wheb_mensagem_pck.get_texto(307082); --' do produto';
					else
						ds_aux_diluir_w	:= ' ' || Wheb_mensagem_pck.get_texto(307083); --' do medicamento';
					end if;
					if (ds_reconstituir_w IS NOT NULL AND ds_reconstituir_w::text <> '') then
						ds_aux_diluir_w	:= ' ' || Wheb_mensagem_pck.get_texto(307085); --' da reconstituicao';
					end if;
					
					if (nr_casas_diluicao_w = 0) then				
						ds_dose_diluicao_w	:= replace_number_locale(qt_dose_ml_w) ||' '||obter_desc_unid_med(obter_unid_med_usua('ml'));
					else
						ds_dose_diluicao_w	:= replace_number_locale(round(qt_dose_ml_w,nr_casas_diluicao_w)) ||' '||obter_desc_unid_med(obter_unid_med_usua('ml'));
					end if;
					
					if (qt_dose_ml_w = 0) then
						begin
						ds_dose_diluicao_w	:= replace_number_locale(qt_dose_w) ||' '||obter_desc_unid_med(cd_unid_med_dose_w);
						end;
					end if;
					
					if (coalesce(qt_solucao_w,0)	> 0) then
						if (qt_volume_cad_w	> 0) then /*Caldas - OS153626 13/07/2009 */
			
						
							
							select	max(obter_conversao_ml(cd_material_w,qt_dose_w,cd_unid_med_dose_w))
							into STRICT	qt_dose_ml_teste_w
							;
							
							if (qt_solucao_w >= 1) then
								if (nr_casas_diluicao_w = 0) then
									ds_dose_diluicao_w	:= to_char(qt_solucao_w)||' '||obter_desc_unid_med(obter_unid_med_usua('ml'));
									ds_conv_ml_w		:= to_char(qt_dose_ml_teste_w)||' '||obter_desc_unid_med(obter_unid_med_usua('ml'));
								else
									ds_dose_diluicao_w	:= to_char(round(qt_solucao_w,nr_casas_diluicao_w))||' '||obter_desc_unid_med(obter_unid_med_usua('ml'));
									ds_conv_ml_w		:= to_char(round(qt_dose_ml_teste_w,nr_casas_diluicao_w))||' '||obter_desc_unid_med(obter_unid_med_usua('ml'));
								end if;
							elsif (nr_casas_diluicao_w = 0) then
								ds_dose_diluicao_w	:= '0'||to_char(qt_solucao_w)||' '||obter_desc_unid_med(obter_unid_med_usua('ml'));
								ds_conv_ml_w	:= '0'||to_char(qt_dose_ml_teste_w)||' '||obter_desc_unid_med(obter_unid_med_usua('ml'));
							else
								ds_dose_diluicao_w	:= '0'||to_char(round(qt_solucao_w,nr_casas_diluicao_w))||' '||obter_desc_unid_med(obter_unid_med_usua('ml'));
								ds_conv_ml_w		:= '0'||to_char(round(qt_dose_ml_teste_w,nr_casas_diluicao_w))||' '||obter_desc_unid_med(obter_unid_med_usua('ml'));
							end if;
							
							qt_conv_ml_w	:= qt_dose_ml_teste_w;
						else
							if (qt_solucao_w >= 1) then
								if (nr_casas_diluicao_w = 0) then
									ds_conv_ml_w	:= to_char(qt_solucao_w)||' '||obter_desc_unid_med(obter_unid_med_usua('ml'));
								else
									ds_conv_ml_w	:= to_char(round(qt_solucao_w,nr_casas_diluicao_w))||' '||obter_desc_unid_med(obter_unid_med_usua('ml'));
								end if;
							elsif (nr_casas_diluicao_w = 0) then
								ds_conv_ml_w	:= '0'||to_char(qt_solucao_w)||' '||obter_desc_unid_med(obter_unid_med_usua('ml'));
							else
								ds_conv_ml_w	:= '0'||to_char(round(qt_solucao_w,nr_casas_diluicao_w))||' '||obter_desc_unid_med(obter_unid_med_usua('ml'));
							end if;
							
							qt_conv_ml_w	:= qt_solucao_w;
						end if;
					end if;
				
							

					select	coalesce(max(ie_um_prescrita),'N')
					into STRICT	ie_um_prescrita_w
					from	regra_unid_med_diluente
					where	cd_setor_atendimento 	= cd_setor_prescr_w
					and		coalesce(cd_unidade_medida,cd_unid_med_dose_mat_w)	= cd_unid_med_dose_mat_w;
					
					if (ie_um_prescrita_w = 'S') then
						qt_conv_ml_w	:= 0;
						ds_conv_ml_w	:= '';
					end if;	
					
					if (ie_indice_w = 2) then
						if (ie_agrupador_ww = 8) or (ie_agrupador_ww = 12) then
							ds_aux_diluir_w	:= ' ' || Wheb_mensagem_pck.get_texto(307082); --' do produto';
						else
							ds_aux_diluir_w	:= ' ' || Wheb_mensagem_pck.get_texto(307083); --' do medicamento';
						end if;
						if (ds_reconstituir_w IS NOT NULL AND ds_reconstituir_w::text <> '') then
							ds_aux_diluir_w	:= ' ' || Wheb_mensagem_pck.get_texto(307085); --' da reconstituicao';
						end if;
						
						if (coalesce(qt_min_aplicacao_w,0) > 0) then
							ds_tempo_w	:= ' ' || Wheb_mensagem_pck.get_texto(307087) || ' ' /*'em '*/ || to_char(qt_min_aplicacao_w) || ' ' || Wheb_mensagem_pck.get_texto(307086) || ' ' /*' min. no horario '*/ || ds_hora_w;
						end if;
						
						if (nr_casas_diluicao_w > 0) then					
							ds_volume_w	:= ' '||to_char(round(qt_conv_ml_w + qt_ml_diluente_w,nr_casas_diluicao_w)) ||' '||obter_desc_unid_med(obter_unid_med_usua('ml'));
							qt_administrar_w := round(qt_conv_ml_w + qt_ml_diluente_w,nr_casas_diluicao_w);
							if (ie_ConsisteDoseConsumoMedic_w = 'S') then
								ds_volume_w	:= ' '||to_char(round((((qt_conv_ml_w + qt_dose_ml_w) * qt_unit_medic_w) / ceil(qt_unit_medic_div_w)),nr_casas_diluicao_w)) ||' '||obter_desc_unid_med(obter_unid_med_usua('ml'));
								qt_administrar_w := round((((qt_conv_ml_w + qt_dose_ml_w) * qt_unit_medic_w) / ceil(qt_unit_medic_div_w)),nr_casas_diluicao_w);
							end if;
							
							qt_result_conv_ml_w := round(qt_conv_ml_w + qt_ml_diluente_w,nr_casas_diluicao_w);
						else
							ds_volume_w	:= ' '||to_char(qt_conv_ml_w + qt_ml_diluente_w) ||' '||obter_desc_unid_med(obter_unid_med_usua('ml'));
							qt_administrar_w := qt_conv_ml_w + qt_ml_diluente_w;
							if (ie_ConsisteDoseConsumoMedic_w = 'S') then						
								ds_volume_w	:= ' '||to_char((((qt_conv_ml_w + qt_dose_ml_w) * qt_unit_medic_w) / ceil(qt_unit_medic_div_w))) ||' '||obter_desc_unid_med(obter_unid_med_usua('ml'));
								qt_administrar_w := (((qt_conv_ml_w + qt_dose_ml_w) * qt_unit_medic_w) / ceil(qt_unit_medic_div_w));
							end if;
							
							qt_result_conv_ml_w := (qt_conv_ml_w + qt_ml_diluente_w);
						end if;
						
						if (ie_administrar_ui_w = 'S') then
						
							select	count(cd_material)
							into STRICT	cont_ww
							from	material_conversao_unidade
							where	cd_material	= cd_mat_ww
							and		upper(cd_unidade_medida) = upper(obter_unid_med_usua('UI'))  LIMIT 1;
							
							if (cont_ww > 0) then
							
								select 	count(cd_material)
								into STRICT	cont_ww
								from	regra_setor_conv_unid
								where	cd_material	= cd_mat_ww
								and		upper(cd_unidade_medida) = upper(obter_unid_med_usua('UI'))  LIMIT 1;
							
								if (cont_ww > 0) then
									select	coalesce(max('S'),'N')
									into STRICT	ie_possui_regra_ui_w
									from	regra_setor_conv_unid
									where	cd_material	= cd_mat_ww
									and		upper(cd_unidade_medida) = upper(obter_unid_med_usua('UI'))
									and		cd_setor_atendimento = cd_setor_prescr_w;
								else
									ie_possui_regra_ui_w := 'S';
								end if;
									
								if (ie_possui_regra_ui_w = 'S') then
									ds_adm_ui_w	:= ' '||to_char(Obter_dose_convertida(cd_mat_ww,qt_result_conv_ml_w,obter_unid_med_usua('ml'),upper(obter_unid_med_usua('UI')))) ||' '|| obter_desc_unid_med(obter_unid_med_usua('UI'));
								end if;
							end if;
						end if;
						
						if (ds_volume_w IS NOT NULL AND ds_volume_w::text <> '') then
							ds_aplicar_w	:= Wheb_mensagem_pck.get_texto(307088) /*'Administrar'*/
|| replace_number_locale(ds_volume_w) || ' '|| ds_tempo_w || substr(obter_vel_inf_medic(nr_sequencia_p, nr_prescricao_p, qt_administrar_w, cd_estabelecimento_w),1,255) ||' '||ds_informacao_item_w;
							if (ds_adm_ui_w IS NOT NULL AND ds_adm_ui_w::text <> '') then
								ds_aplicar_w	:= ds_aplicar_w || chr(13) || ' ' || Wheb_mensagem_pck.get_texto(307088) /*' Administrar'*/|| replace_number_locale(ds_adm_ui_w) || ' '|| ds_tempo_w||' '||ds_informacao_item_w;
							end if;
						elsif (ds_tempo_w IS NOT NULL AND ds_tempo_w::text <> '') then
							ds_aplicar_w	:= Wheb_mensagem_pck.get_texto(307088) /*'Administrar'*/
||ds_tempo_w || substr(obter_vel_inf_medic(nr_sequencia_p, nr_prescricao_p, qt_administrar_w, cd_estabelecimento_w),1,255)||' '||ds_informacao_item_w;
						end if;
						
						select	max(obter_conversao_ml(cd_material_w,qt_diluicao_aux_w,cd_unid_med_diluente_aux_w))
						into STRICT	qt_dose_ml_w
						;
						
						if (nr_casas_diluicao_w = 0) then					
							ds_dose_diluicao_w	:= replace_number_locale(qt_dose_ml_w) ||' '||obter_desc_unid_med(obter_unid_med_usua('ml'));
						else
							ds_dose_diluicao_w	:= replace_number_locale(round(qt_dose_ml_w,nr_casas_diluicao_w)) ||' '||obter_desc_unid_med(obter_unid_med_usua('ml'));
						end if;
						
						if (qt_dose_ml_w = 0) then
							ds_dose_diluicao_w	:= replace_number_locale(qt_diluicao_aux_w) ||' '||obter_desc_unid_med(cd_unid_med_diluente_aux_w);
						end if;

						if (ds_dose_diferenciada_w IS NOT NULL AND ds_dose_diferenciada_w::text <> '') then
							ds_dose_dif_while_w := ds_dose_diferenciada_w || '-';
							ds_dose_dif_dil_while_w := ds_dose_dif_dil_w || '-';
							if (coalesce(ie_dose_dif_gerada_w, 'N') = 'N') then
								while(ds_dose_dif_while_w IS NOT NULL AND ds_dose_dif_while_w::text <> '') loop
									ds_dose_diferenciada_w := substr(ds_dose_dif_while_w, 1, position('-' in ds_dose_dif_while_w) - 1);
									ds_dose_dif_while_w := substr(ds_dose_dif_while_w, position('-' in ds_dose_dif_while_w) + 1, length(ds_dose_dif_while_w));
						
									ds_dose_dif_dil_w := substr(ds_dose_dif_dil_while_w, 1, position('-' in ds_dose_dif_dil_while_w) - 1);
									ds_dose_dif_dil_while_w := substr(ds_dose_dif_dil_while_w, position('-' in ds_dose_dif_dil_while_w) + 1, length(ds_dose_dif_dil_while_w));
									qt_dil_ml_w := obter_conversao_ml(cd_material_w,(ds_dose_dif_dil_w)::numeric ,cd_unid_med_dose_w);
									if (nr_casas_diluicao_w = 0) then
										qt_dose_ml_w := replace_number_locale(qt_dil_ml_w);
									else
										qt_dose_ml_w := replace_number_locale(round(qt_dil_ml_w, nr_casas_diluicao_w));
									end if;
									ds_dose_diluicao_w := qt_dose_ml_w || ' ml';
									qt_dose_mat_str_w := obter_conversao_ml(cd_medic_w,(ds_dose_diferenciada_w)::numeric ,cd_unid_med_dose_mat_w);
									ds_aplicar_w := Wheb_mensagem_pck.get_texto(307088) || ' ' || replace((qt_dose_mat_str_w + qt_dose_ml_w),'.',',') || 'ml ';
			
									if (ie_separar_w = 'S') then
										ds_diluir_w := 	ds_diluir_w ||Wheb_mensagem_pck.get_texto(307089) || ' ' /*'Separar '*/||replace_number_locale(ds_dose_diferenciada_w)||' '||obter_desc_unid_med(cd_unid_med_dose_mat_w)|| ds_aux_diluir_w|| ' ' || Wheb_mensagem_pck.get_texto(307087) || ' ' /*' em '*/||
											ds_dose_diluicao_w || ' ' || Wheb_mensagem_pck.get_texto(307090) || ' ' /*' de '*/||ds_material_w || chr(13) || chr(10) ||
											ds_rediluir_w || ds_aplicar_w || chr(13) || chr(10);
									else
										ds_diluir_w := 	ds_diluir_w ||Wheb_mensagem_pck.get_texto(307092) || ' ' /*'Diluir '*/||replace_number_locale(ds_dose_diferenciada_w)||' '||obter_desc_unid_med(cd_unid_med_dose_mat_w)|| ds_aux_diluir_w|| ' ' || Wheb_mensagem_pck.get_texto(307087) || ' ' /*' em '*/||
											ds_dose_diluicao_w || ' ' || Wheb_mensagem_pck.get_texto(307090) || ' ' /*' de '*/||ds_material_w || chr(13) || chr(10) ||
											ds_rediluir_w || ds_aplicar_w || chr(13) || chr(10);
									end if;
								end loop;
								ie_dose_dif_gerada_w := 'S';
							end if;
						elsif (ie_separar_w = 'S') then
							ds_diluir_w := 	ds_diluir_w ||Wheb_mensagem_pck.get_texto(307089) || ' ' /*'Separar '*/||replace_number_locale(qt_dose_mat_str_w)||' '||obter_desc_unid_med(cd_unid_med_dose_mat_w)|| ds_aux_diluir_w|| ' ' || Wheb_mensagem_pck.get_texto(307087) || ' ' /*' em '*/||
									ds_dose_diluicao_w || ' ' || Wheb_mensagem_pck.get_texto(307090) || ' ' /*' de '*/||ds_material_w || chr(13) || chr(10) ||
									ds_rediluir_w || ds_aplicar_w || chr(13) || chr(10);
						else
							ds_diluir_w := 	ds_diluir_w ||Wheb_mensagem_pck.get_texto(307092) || ' ' /*'Diluir '*/||replace_number_locale(qt_dose_mat_str_w)||' '||obter_desc_unid_med(cd_unid_med_dose_mat_w)|| ds_aux_diluir_w|| ' ' || Wheb_mensagem_pck.get_texto(307087) || ' ' /*' em '*/||
									ds_dose_diluicao_w || ' ' || Wheb_mensagem_pck.get_texto(307090) || ' ' /*' de '*/||ds_material_w || chr(13) || chr(10) ||
									ds_rediluir_w || ds_aplicar_w || chr(13) || chr(10);
						end if;
						
											

					elsif (coalesce(ds_conv_ml_w::text, '') = '') and (coalesce(ds_diluir_w::text, '') = '') then

						if (ie_ConsisteDoseConsumoMedic_w = 'N') and (coalesce(ie_proporcao_w,'F') = 'F') and (coalesce(qt_volume_medic_w,0) > 0) then
							   qt_dose_mat_str_w := qt_volume_medic_w||' '||obter_unid_med_usua('ml');
						end if;
						
						if (ds_dose_diferenciada_w IS NOT NULL AND ds_dose_diferenciada_w::text <> '') then
							if (ie_agrupador_ww = 8) or (ie_agrupador_ww = 12) then
								ds_aux_diluir_w	:= lower(Wheb_mensagem_pck.get_texto(307093)); --'produto';
							else
								ds_aux_diluir_w	:= lower(Wheb_mensagem_pck.get_texto(307095)); --'medicamento';
							end if;
							
							
							if (ds_reconstituir_w IS NOT NULL AND ds_reconstituir_w::text <> '') then
								ds_aux_diluir_w	:= lower(Wheb_mensagem_pck.get_texto(307096)); --'reconstituicao';
							end if;
							if (ie_separar_w = 'S') then
								ds_diluir_w := 	ds_diluir_w ||Wheb_mensagem_pck.get_texto(307089) || ' ' /*'Separar '*/|| ds_aux_diluir_w || ' ' || Wheb_mensagem_pck.get_texto(307099) || ' (' /*' conforme dose do horario ('*/||ds_dose_diferenciada_w|| ') ' || Wheb_mensagem_pck.get_texto(307087) || ' ' /*') em '*/||
									ds_dose_diluicao_w||Wheb_mensagem_pck.get_texto(307090) /*' de '*/
||ds_material_w || chr(13) || chr(10);
							else
							ds_diluir_w := 	ds_diluir_w ||Wheb_mensagem_pck.get_texto(307092) || ' ' /*'Diluir '*/|| ds_aux_diluir_w || ' ' || Wheb_mensagem_pck.get_texto(307099) || ' (' /*' conforme dose do horario ('*/||ds_dose_diferenciada_w|| ') ' || Wheb_mensagem_pck.get_texto(307087) || ' ' /*') em '*/||
									ds_dose_diluicao_w|| ' ' || Wheb_mensagem_pck.get_texto(307090) || ' ' /*' de '*/||ds_material_w || chr(13) || chr(10);
							end if;
						elsif (ie_separar_w = 'S') then
							ds_diluir_w := 	ds_diluir_w ||Wheb_mensagem_pck.get_texto(307089) || ' ' /*'Separar '*/||replace_number_locale(qt_dose_mat_str_w)||' '||obter_desc_unid_med(cd_unid_med_dose_mat_w)|| ds_aux_diluir_w|| ' ' || Wheb_mensagem_pck.get_texto(307087) || ' ' /*' em '*/||
								ds_dose_diluicao_w|| ' ' || Wheb_mensagem_pck.get_texto(307090) || ' ' /*' de '*/||ds_material_w || chr(13) || chr(10);
						else
							ds_diluir_w := 	ds_diluir_w || Wheb_mensagem_pck.get_texto(307092) || ' ' /*'Diluir '*/||replace_number_locale(qt_dose_mat_str_w)||' '||obter_desc_unid_med(cd_unid_med_dose_mat_w)|| ds_aux_diluir_w|| ' ' || Wheb_mensagem_pck.get_texto(307087) || ' ' /*' em '*/||
								ds_dose_diluicao_w|| ' ' || Wheb_mensagem_pck.get_texto(307090) || ' ' /*' de '*/||ds_material_w || chr(13) || chr(10);					
						end if;

						
					elsif (coalesce(ds_diluir_w::text, '') = '') then
						
							if (ie_ConsisteDoseConsumoMedic_w = 'N') and (coalesce(ie_proporcao_w,'F') = 'F') and (coalesce(qt_volume_medic_w,0) > 0) then
							   ds_conv_ml_w := qt_volume_medic_w||' '||obter_desc_unid_med(obter_unid_med_usua('ml'));
							end if;
							
					
						if (ds_dose_diferenciada_w IS NOT NULL AND ds_dose_diferenciada_w::text <> '') then
							if (ie_agrupador_ww = 8) or (ie_agrupador_ww = 12) then
								ds_aux_diluir_w	:= lower(Wheb_mensagem_pck.get_texto(307093)); --'produto';
							else
								ds_aux_diluir_w	:= lower(Wheb_mensagem_pck.get_texto(307095)); --'medicamento';
							end if;
							
							if (ds_reconstituir_w IS NOT NULL AND ds_reconstituir_w::text <> '') then
								ds_aux_diluir_w	:= lower(Wheb_mensagem_pck.get_texto(307096)); --'reconstituicao';
							end if;
							
							if (ie_separar_w = 'S') then
								ds_diluir_w := 	ds_diluir_w ||Wheb_mensagem_pck.get_texto(307089) || ' ' /*'Separar '*/||ds_aux_diluir_w|| ' ' || Wheb_mensagem_pck.get_texto(307099) || ' (' /*' conforme dose do horario ('*/||ds_dose_diferenciada_w|| ') ' || Wheb_mensagem_pck.get_texto(307087) || ' ' /*') em '*/||
									ds_dose_diluicao_w|| ' ' || Wheb_mensagem_pck.get_texto(307090) || ' ' /*' de '*/||ds_material_w || chr(13) || chr(10);

								else
									ds_diluir_w := 	ds_diluir_w ||Wheb_mensagem_pck.get_texto(307092) || ' ' /*'Diluir '*/||ds_aux_diluir_w|| ' ' || Wheb_mensagem_pck.get_texto(307099) || ' (' /*' conforme dose do horario ('*/||ds_dose_diferenciada_w|| ') ' || Wheb_mensagem_pck.get_texto(307087) || ' ' /*') em '*/||
									ds_dose_diluicao_w|| ' ' || Wheb_mensagem_pck.get_texto(307090) || ' ' /*' de '*/||ds_material_w || chr(13) || chr(10);
							end if;					
						elsif (ie_separar_w = 'S') then
								ds_diluir_w := ds_diluir_w || wheb_mensagem_pck.get_texto(1090081,
												'DS_VOLUME=' || ds_conv_ml_w ||
												';DS_TIPO_DIL=' || ds_aux_diluir_w || 
												';DS_ADDITIONAL_ITEM=' || '' || 
												';DS_DOSE_DIL=' || ds_dose_diluicao_w ||
												';DS_MATERIAL=' || ds_material_w) || 
												chr(13) || chr(10);
				
						else
								ds_diluir_w := ds_diluir_w || wheb_mensagem_pck.get_texto(1090082,
												'DS_VOLUME=' ||ds_conv_ml_w || 
												';DS_TIPO_DIL=' ||ds_aux_diluir_w ||
												';DS_ADDITIONAL_ITEM=' || '' ||
												';DS_DOSE_DIL=' || ds_dose_diluicao_w || 
												';DS_MATERIAL='||ds_material_w) || 
												chr(13) || chr(10);
				
						end if;				
					elsif (ie_separar_w = 'S') then
						ds_diluir_w := 	ds_diluir_w ||Wheb_mensagem_pck.get_texto(307089) || ' ' /*'Separar '*/ || Wheb_mensagem_pck.get_texto(307104) /*'a solucao em '*/||
							ds_dose_diluicao_w || ' ' || Wheb_mensagem_pck.get_texto(307090) || ' ' /*' de '*/||ds_material_w || chr(13) || chr(10);
					else
						ds_diluir_w := 	ds_diluir_w ||Wheb_mensagem_pck.get_texto(307092) || ' ' /*'Diluir '*/ || Wheb_mensagem_pck.get_texto(307104) || ' ' /*'a solucao em '*/||
							ds_dose_diluicao_w || ' ' || Wheb_mensagem_pck.get_texto(307090) || ' ' /*' de '*/||ds_material_w || chr(13) || chr(10);
					end if;
					end;
				end if;
				

				if (cd_material_w IS NOT NULL AND cd_material_w::text <> '') and (qt_dose_w IS NOT NULL AND qt_dose_w::text <> '') and (cd_unid_med_dose_w IS NOT NULL AND cd_unid_med_dose_w::text <> '') and (ie_agrupador_w = 7) and (ie_indice_w <> 2) then
					begin
					select 	CASE WHEN ie_descr_redu_dil_w='S' THEN ds_reduzida_w  ELSE ds_material_ww END
					into STRICT	ds_material_w
					;
					
					cd_volume_final_w := qt_dose_ml_w + qt_solucao_w;
					
					if (nr_casas_diluicao_w > 0) then
						qt_solucao_w	:= round(qt_solucao_w,nr_casas_diluicao_w);
					end if;
					
					if (qt_dose_ml_w > 0) and (nr_casas_diluicao_W > 0) then
					   qt_dose_ml_w := round(qt_dose_ml_w,nr_casas_diluicao_w);
					end if;
					
					if (qt_dose_w > 0) and (nr_casas_diluicao_W > 0) then
					   qt_dose_w := round(qt_dose_w,nr_casas_diluicao_w);
					end if;
				
					if (qt_solucao_w < 1) or (mod(qt_solucao_w, trunc(qt_solucao_w)) <> 0) then
						mascara_w	:= 0;
					else
						mascara_w	:= 1;
					end if;

					ds_dose_diluicao_w	:= replace_number_locale(qt_dose_ml_w) ||' '||obter_desc_unid_med(obter_unid_med_usua('ml'));
					if (qt_dose_ml_w = 0) then
						begin
						ds_dose_diluicao_w	:= replace_number_locale(qt_dose_w) ||' '||obter_desc_unid_med(cd_unid_med_dose_w);
						end;
					end if;
					
					Select 	CASE WHEN mascara_w=0 THEN  campo_mascara(qt_solucao_w, 2)  ELSE campo_mascara(qt_solucao_w, 0) END
					into STRICT	qt_solucao_str_w
					;

					if (ie_separar_w = 'S') then
						ds_rediluir_w := ds_rediluir_w||Wheb_mensagem_pck.get_texto(307089) || ' ' /*'Separar '*/||replace_number_locale(qt_solucao_str_w)||' '||obter_desc_unid_med(obter_unid_med_usua('ml'))|| ' ' || Wheb_mensagem_pck.get_texto(307105) || ' ' /*' desta solucao em '*/||
								ds_dose_diluicao_w || ' ' || Wheb_mensagem_pck.get_texto(307090) || ' ' /*' de '*/||ds_material_w || chr(13) || chr(10);
					else
						ds_rediluir_w := ds_rediluir_w|| Wheb_mensagem_pck.get_texto(307184) || ' ' /*'Rediluir '*/||replace_number_locale(qt_solucao_str_w)||' '||obter_desc_unid_med(obter_unid_med_usua('ml'))|| ' ' || Wheb_mensagem_pck.get_texto(307105) || ' ' /*' desta solucao em '*/||
								ds_dose_diluicao_w || ' ' || Wheb_mensagem_pck.get_texto(307090) || ' ' /*' de '*/||ds_material_w || chr(13) || chr(10);
					end if;
					ie_possui_rediluente_w   := 'S';
					end;
				end if;
				end;
				ie_possui_diluente_w	:= 'S';
			end loop;
			close c01;
			qt_registro_w	:= qt_registro_w + 1;
			if (ie_mostrar_concentracao_w = 'S') then
				begin
				if (qt_concentracao_total_w IS NOT NULL AND qt_concentracao_total_w::text <> '') and (cd_unid_med_concetracao_w IS NOT NULL AND cd_unid_med_concetracao_w::text <> '') and (cd_unid_med_base_conc_w IS NOT NULL AND cd_unid_med_base_conc_w::text <> '') then				
					ds_rediluir_w := ds_rediluir_w || Wheb_mensagem_pck.get_texto(307106) || ' ' /*'Concentracao ideal: '*/ || replace_number_locale(qt_concentracao_total_w) || ' ' ||
						obter_desc_unid_med(cd_unid_med_concetracao_w) || '/' || obter_desc_unid_med(cd_unid_med_base_conc_w) || chr(13) || chr(10);				
				end if;	
				end;
			end if;
		
		end loop;
		close C00;
		
		ds_aplicar_w	:= '';

		if (cd_volume_final_w < 1) or (mod(cd_volume_final_w, trunc(cd_volume_final_w)) <> 0) then
			mascara_w	:= 0;
		else
			mascara_w	:= 1;
		end if;


				
		if	((coalesce(qt_min_aplicacao_w,0) > 0) and (coalesce(qt_hora_aplicacao_w,0) > 0))then
			ds_tempo_w	:= ' ' || Wheb_mensagem_pck.get_texto(307087) || ' ' /*' em '*/ || to_char(qt_hora_aplicacao_w) || ' ' || Wheb_mensagem_pck.get_texto(309411) || ' ' /*' h. e '*/ || Wheb_mensagem_pck.get_texto(309413) || ' ' || to_char(qt_min_aplicacao_w) || ' ' || lower(Wheb_mensagem_pck.get_texto(309401)); --' min.';
		elsif (coalesce(qt_min_aplicacao_w,0) = 0) and (coalesce(qt_hora_aplicacao_w,0) > 0) then
			ds_tempo_w	:= ' ' || Wheb_mensagem_pck.get_texto(307087) || ' ' /*' em '*/ || to_char(qt_hora_aplicacao_w) || ' ' || Wheb_mensagem_pck.get_texto(309411) || ' '; --' h.';
		elsif (coalesce(qt_min_aplicacao_w,0) > 0) and (coalesce(qt_hora_aplicacao_w,0) = 0) then
			ds_tempo_w	:= ' ' || Wheb_mensagem_pck.get_texto(307087) || ' ' /*' em '*/ || to_char(qt_min_aplicacao_w) || ' ' || lower(Wheb_mensagem_pck.get_texto(309401)); --' min.';
		end if;	
		
		ds_volume_w := null;
		qt_administrar_w := 0;
		if (coalesce(ie_fator_Correcao_w,'N') = 'S') and (coalesce(qt_volume_equipo_w,0) > 0) and (coalesce(qt_dose_medic_w,0) > 0) and (ie_um_prescrita_w <> 'S') and
			((coalesce(qt_dose_dil_w,0) > 0) or (coalesce(qt_dose_ml_w,0) > 0)) then
			 qt_ret_volume_equipo_w		:= qt_volume_equipo_w;
		end if;
		
		
		Select 	CASE WHEN mascara_w=0 THEN  campo_mascara(cd_volume_final_w - qt_ret_volume_equipo_w, 2)  ELSE campo_mascara(cd_volume_final_w - qt_ret_volume_equipo_w, 0) END
		into STRICT	cd_volume_final_str_w
		;
		
		if (qt_solucao_ww IS NOT NULL AND qt_solucao_ww::text <> '') and (qt_solucao_ww > 0) then
			if (nr_casas_diluicao_w > 0) then
				ds_volume_w	:= ' '||to_char(round(qt_solucao_ww - qt_ret_volume_equipo_w,nr_casas_diluicao_w)) ||' '||obter_desc_unid_med(obter_unid_med_usua('ml'));
				qt_administrar_w := round(qt_solucao_ww - qt_ret_volume_equipo_w,nr_casas_diluicao_w);
				qt_volume_ww	:= round(qt_solucao_ww,nr_casas_diluicao_w);
			else
				ds_volume_w	:= ' '||to_char(qt_solucao_ww - qt_ret_volume_equipo_w) ||' '||obter_desc_unid_med(obter_unid_med_usua('ml'));
				qt_administrar_w := qt_solucao_ww - qt_ret_volume_equipo_w;
				qt_volume_ww	:= qt_solucao_ww;
			end if;
		elsif (ie_aplicar_w = 'S') then
			begin		
			if (ds_rediluir_w IS NOT NULL AND ds_rediluir_w::text <> '') and (ie_possui_rediluente_w = 'S') then	
				ds_volume_w	:= ' '||to_char(cd_volume_final_str_w)  ||' '||obter_desc_unid_med(obter_unid_med_usua('ml'));
			elsif (ds_diluir_w IS NOT NULL AND ds_diluir_w::text <> '') then
				if (nr_casas_diluicao_w > 0) then
			if (cd_funcao_w in (1113, 2314)) then
			    ds_volume_w	:= ' '||to_char(round(coalesce(qt_conv_ml_ww, qt_conv_ml_w) + qt_total_agrup_w + qt_ml_diluente_w - qt_ret_volume_equipo_w,nr_casas_diluicao_w)) ||' '||obter_desc_unid_med(obter_unid_med_usua('ml'));
			else
			    ds_volume_w	:= ' '||to_char(round(qt_conv_ml_w + qt_total_agrup_w + qt_ml_diluente_w - qt_ret_volume_equipo_w,nr_casas_diluicao_w)) ||' '||obter_desc_unid_med(obter_unid_med_usua('ml'));
			end if;
					qt_administrar_w := round(qt_conv_ml_w + qt_total_agrup_w + qt_ml_diluente_w - qt_ret_volume_equipo_w,nr_casas_diluicao_w);
					qt_volume_ww	:= round(qt_conv_ml_w + qt_ml_diluente_w,nr_casas_diluicao_w);

					if (coalesce(qt_volume_medic_w,0) > 0) then
						qt_conversao_ww := Obter_dose_convertida(cd_medic_w, qt_conv_ml_w, obter_unid_med_usua('ml'), cd_unid_med_dose_mat_w);		
						if (coalesce(qt_conversao_ww,0) > 0) then
							ds_volume_w	:= ' '||to_char(round(((qt_conv_ml_w + qt_dose_ml_w ) * qt_dose_mat_w) / ceil(qt_conversao_ww),nr_casas_diluicao_w)) ||' '||obter_desc_unid_med(obter_unid_med_usua('ml'));					
						end if;
					end if;
					
					if (ie_ConsisteDoseConsumoMedic_w = 'S') then
			    if (cd_funcao_w in (1113, 2314)) then
				ds_volume_w	:= ' '||to_char(round(((qt_volume_medic_w + qt_conv_ml_w + qt_dose_ml_w ) * qt_unit_medic_w) / ceil(qt_unit_medic_div_w),nr_casas_diluicao_w)) ||' '||obter_desc_unid_med(obter_unid_med_usua('ml'));
			    else
				ds_volume_w	:= ' '||to_char(round(((qt_conv_ml_w + qt_dose_ml_w ) * qt_unit_medic_w) / ceil(qt_unit_medic_div_w),nr_casas_diluicao_w)) ||' '||obter_desc_unid_med(obter_unid_med_usua('ml'));
			    end if;
						qt_administrar_w := round(((qt_conv_ml_w + qt_dose_ml_w ) * qt_unit_medic_w) / ceil(qt_unit_medic_div_w),nr_casas_diluicao_w);
						qt_volume_ww	:= round(((qt_conv_ml_w + qt_dose_ml_w) * qt_unit_medic_w) / ceil(qt_unit_medic_div_w),nr_casas_diluicao_w);
					end if;
							
				else
					ds_volume_w	:= ' '||to_char(qt_conv_ml_w + qt_total_agrup_w + qt_ml_diluente_w - qt_ret_volume_equipo_w) ||' '||obter_desc_unid_med(obter_unid_med_usua('ml'));
					qt_administrar_w := qt_conv_ml_w + qt_total_agrup_w + qt_ml_diluente_w - qt_ret_volume_equipo_w;
					qt_volume_ww	:= qt_conv_ml_w + qt_ml_diluente_w;
					if (ie_ConsisteDoseConsumoMedic_w = 'S') then
						ds_volume_w	:= ' '||to_char((((qt_conv_ml_w + qt_dose_ml_w) * qt_unit_medic_w) / ceil(qt_unit_medic_div_w))) ||' '||obter_desc_unid_med(obter_unid_med_usua('ml'));
						qt_administrar_w := (((qt_conv_ml_w + qt_dose_ml_w) * qt_unit_medic_w) / ceil(qt_unit_medic_div_w));
						qt_volume_ww	:= (((qt_conv_ml_w + qt_dose_ml_w) * qt_unit_medic_w) / ceil(qt_unit_medic_div_w));
					end if;
					
				end if;
			elsif (ds_conv_ml_w IS NOT NULL AND ds_conv_ml_w::text <> '') then
				ds_volume_w	:= ' '||ds_conv_ml_w;					
			end if;
			
			end;
		end if;
		
		if (ie_indice_w <> 2) or (ie_possui_diluente_w = 'N') then		
					
			if (ds_volume_w IS NOT NULL AND ds_volume_w::text <> '') then
		
				ds_aplicar_w	:= Wheb_mensagem_pck.get_texto(307088) /*'Administrar'*/
|| replace_number_locale(ds_volume_w) || ' ('||ds_intervalo_w||') '|| ds_tempo_w || substr(obter_vel_inf_medic(nr_sequencia_p, nr_prescricao_p, qt_administrar_w, cd_estabelecimento_w),1,255)
								||' '||ds_informacao_item_w;
				if (ie_administrar_ui_w = 'S') then
							
					select	count(cd_material)
					into STRICT	cont_ww
					from	material_conversao_unidade
					where	cd_material	= cd_mat_ww
					and		upper(cd_unidade_medida) = upper(obter_unid_med_usua('UI'))  LIMIT 1;
					
					if (cont_ww > 0) then
						
						select 	count(cd_material)
						into STRICT	cont_ww
						from	regra_setor_conv_unid
						where	cd_material	= cd_mat_ww
						and		upper(cd_unidade_medida) = upper(obter_unid_med_usua('UI'))  LIMIT 1;
						
						if (cont_ww > 0) then
							select	coalesce(max('S'),'N')
							into STRICT	ie_possui_regra_ui_w
							from	regra_setor_conv_unid
							where	cd_material	= cd_mat_ww
							and		upper(cd_unidade_medida) = upper(obter_unid_med_usua('UI'))
							and		cd_setor_atendimento = cd_setor_prescr_w;
						else
							ie_possui_regra_ui_w := 'S';
						end if;
						
						if (ie_possui_regra_ui_w = 'S') then
							ds_adm_ui_w	:= Wheb_mensagem_pck.get_texto(307088) || ' ' /*'Administrar '*/|| to_char(Obter_dose_convertida(cd_mat_ww,coalesce(qt_volume_ww,qt_conv_ml_w), obter_unid_med_usua('ml'),upper(obter_unid_med_usua('UI')))) ||' '|| obter_desc_unid_med(obter_unid_med_usua('UI')) || ' (' || ds_intervalo_w ||') '|| ds_tempo_w || substr(obter_vel_inf_medic(nr_sequencia_p, nr_prescricao_p, qt_administrar_w, cd_estabelecimento_w),1,255);
							ds_aplicar_w	:= ds_aplicar_w || chr(13) || chr(10) ||ds_adm_ui_w;
						end if;
					end if;
				end if;
				
				
			elsif (ds_tempo_w IS NOT NULL AND ds_tempo_w::text <> '') then
				ds_aplicar_w	:= Wheb_mensagem_pck.get_texto(307088) || ' ' /*'Administrar'*/||ds_tempo_w || substr(obter_vel_inf_medic(nr_sequencia_p, nr_prescricao_p, qt_administrar_w, cd_estabelecimento_w),1,255) ||' '||ds_informacao_item_w;
			end if;
		else
			ds_rediluir_w	:= '';
		end if;
				
		if (ie_mostrar_aplic_ataque_w = 'S') and (qt_dose_especial_w	> 0) then
			select	max(obter_conversao_ml(cd_medic_w,qt_dose_especial_w,cd_unid_med_dose_mat_w))
			into STRICT	qt_dose_ml_ataque_w
			;
		
			if (qt_dose_ml_ataque_w	> 0) then
				if (qt_dose_ml_ataque_w < 1) then
					if (nr_casas_diluicao_w = 0) then
						ds_ataque_w	:= '0' || to_char(qt_dose_ml_ataque_w);
					else
						ds_ataque_w	:= to_char(round(qt_dose_ml_ataque_w,nr_casas_diluicao_w));
					end if;				
				else
					if (nr_casas_diluicao_w = 0) then
						ds_ataque_w	:= to_char(qt_dose_ml_ataque_w);
					else
						ds_ataque_w	:=  to_char(round(qt_dose_ml_ataque_w,nr_casas_diluicao_w));
					end if;
				end if;

				select	coalesce(max(a.ie_dose_ataque),'N'),
						coalesce(max(a.ie_dose_adicional), 'N')
				into STRICT    ie_dose_ataque_w,
						ie_dose_adicional_w
				from 	cpoe_material 	a
				where 	a.nr_sequencia = (SELECT max(x.nr_seq_mat_cpoe) 
										from 	prescr_material 	x
										where 	x.nr_prescricao = nr_prescricao_p 
										and 	x.nr_sequencia = nr_sequencia_p);
				
				if (ie_dose_ataque_w = 'S') then
					cd_msg_w := 307111;
				elsif (ie_dose_adicional_w = 'S') then
					cd_msg_w := 1072633;
				end if;
				
				if (coalesce(qt_min_aplic_dose_esp_w::text, '') = '') then
					ds_aplicar_w	:= ds_aplicar_w || chr(13)  || chr(10)|| ' ' || Wheb_mensagem_pck.get_texto(cd_msg_w) || ' ' /*' Administrar dose ataque '*/|| replace_number_locale(ds_ataque_w) || ' '|| obter_desc_unid_med(obter_unid_med_usua('ml')) ||' ';
				else
					ds_aplicar_w	:= ds_aplicar_w || chr(13)  || chr(10)|| ' ' || Wheb_mensagem_pck.get_texto(cd_msg_w) || ' ' /*' Administrar dose ataque '*/|| replace_number_locale(ds_ataque_w) || ' '|| obter_desc_unid_med(obter_unid_med_usua('ml')) ||' ' || Wheb_mensagem_pck.get_texto(307087) || ' ' /*' ml em '*/||qt_min_aplic_dose_esp_w|| ' ' || Wheb_mensagem_pck.get_texto(309408); --' min';
				end if;	
				
				end if;
		end if;
		
		
		
				
		if (ie_aplicar_medic_w = 'N') then
			ds_aplicar_w	:= '';
		end if;
		
		ds_retorno_w 	:= ds_reconstituir_w || ds_diluir_w || ds_rediluir_w || ds_aplicar_w;
	end if;

	ds_retorno_w	:= replace(ds_retorno_w,' ,',' 0,');
	ds_retorno_w	:= replace(ds_retorno_w,' .',' 0,');
		

	select	cd_material
	into STRICT	cd_material_w
	from	prescr_material
	where	nr_sequencia = nr_sequencia_p
	and		nr_prescricao = nr_prescricao_p;

	if (ie_mostrar_estabilidade_w = 'S') then

		select  coalesce(max(nr_seq_estagio),0),
				max(substr(obter_estagio_armazenamento(nr_seq_estagio),1,255)),
				max(qt_estabilidade),
				max(substr(obter_valor_dominio(1246,ie_tempo_estab),1,255)),
				coalesce(max(Obter_desc_forma_armazenamento(nr_seq_forma)),'')
		into STRICT	qt_estagio_armazenamento_w,
				ds_estagio_armazenamento_w,
				qt_estabilidade_w,
				ds_tempo_estabilidade_w,
				ds_forma_arma_w
		from 	mat_estagio_armaz b,
				material_armazenamento a
		where 	b.nr_sequencia	= a.nr_seq_estagio
		and		a.cd_material	= cd_material_w
		and		b.ie_estagio	= '1'
		and		coalesce(a.cd_estabelecimento,coalesce(cd_estabelecimento_w,0)) = coalesce(cd_estabelecimento_w,0);	
		
		ie_possui_diluente_w := 'S';
		if (ie_possui_diluente_w = 'S') and (qt_estagio_armazenamento_w > 0) then
			if (coalesce(ds_retorno_w::text, '') = '') then																																																		/*Wheb_mensagem_pck.get_texto(398323) Forma de armazenamento*/
				ds_retorno_w := Wheb_mensagem_pck.get_texto(307113) || ' ' /*'Estabilidade: '*/ || qt_estabilidade_w ||' '|| ds_tempo_estabilidade_w || ' '|| ds_estagio_armazenamento_w|| chr(13) ||ds_forma_arma_w;
			else	
				ds_retorno_w := ds_retorno_w || chr(13) || chr(10) ||Wheb_mensagem_pck.get_texto(307113) || ' ' /*'Estabilidade: '*/ || qt_estabilidade_w ||' '|| ds_tempo_estabilidade_w || ' '|| ds_estagio_armazenamento_w|| chr(13) || chr(10) ||ds_forma_arma_w;
			end if;
		elsif (qt_estagio_armazenamento_w = 0) and (ie_possui_diluente_w = 'S') then
				
			select  coalesce(max(nr_seq_estagio),0),
					max(substr(obter_estagio_armazenamento(nr_seq_estagio),1,255)),
					max(qt_estabilidade),
					max(substr(obter_valor_dominio(1246,ie_tempo_estab),1,255)),
					coalesce(max(Obter_desc_forma_armazenamento(nr_seq_forma)),'')
			into STRICT	qt_estagio_armazenamento_w,
					ds_estagio_armazenamento_w,
					qt_estabilidade_w,
					ds_tempo_estabilidade_w,
					ds_forma_arma_w
			from 	mat_estagio_armaz b,
					material_armazenamento a
			where 	b.nr_sequencia	= a.nr_seq_estagio
			and		a.cd_material	= cd_material_w
			and		b.ie_estagio	= '2'
			and		coalesce(a.cd_estabelecimento,coalesce(cd_estabelecimento_w,0)) = coalesce(cd_estabelecimento_w,0);
		
			if (qt_estagio_armazenamento_w > 0) then
				if (coalesce(ds_retorno_w::text, '') = '') then			
					ds_retorno_w := Wheb_mensagem_pck.get_texto(307113) || ' ' /*'Estabilidade: '*/ || qt_estabilidade_w ||' '|| ds_tempo_estabilidade_w || ' '|| ds_estagio_armazenamento_w|| chr(13) || chr(10)||ds_forma_arma_w;
				else	
					ds_retorno_w := ds_retorno_w || chr(13) || chr(10) ||Wheb_mensagem_pck.get_texto(307113) || ' ' /*'Estabilidade: '*/ || qt_estabilidade_w ||' '|| ds_tempo_estabilidade_w || ' '|| ds_estagio_armazenamento_w|| chr(13) || chr(10) ||ds_forma_arma_w;
				end if;
			end if;				
		
		end if;
	end if;

	select  coalesce(max(ie_higroscopico),'N'),
			coalesce(max(ie_fotosensivel),'N'),
			coalesce(max(ie_termolabil),'N')
	into STRICT	ie_higroscopico_w,
			ie_fotosensivel_w,
			ie_termolabil_w
	from 	material
	where 	cd_material = cd_material_w;

	ds_inf_adic_w := Wheb_mensagem_pck.get_texto(307095) || ' '; --'Medicamento ';
	if (ie_fotosensivel_w = 'S')	and (ie_mostrar_foto_w = 'S') then
		ds_inf_adic_w := ds_inf_adic_w ||lower(Wheb_mensagem_pck.get_texto(307117));--'fotossensivel';
	end if;
	if (ie_higroscopico_w = 'S') then
		if	(ds_inf_adic_w <> (Wheb_mensagem_pck.get_texto(307095) || ' ') /*'Medicamento '*/) then
			ds_inf_adic_w := ds_inf_adic_w ||', ' ||lower(Wheb_mensagem_pck.get_texto(307119)); --', higroscopico';
		else
			ds_inf_adic_w := ds_inf_adic_w ||lower(Wheb_mensagem_pck.get_texto(307119)); --'higroscopico';
		end if;	
	end if;
	if (ie_termolabil_w = 'S') then
		if	(ds_inf_adic_w <> (Wheb_mensagem_pck.get_texto(307095) || ' ') /*'Medicamento '*/) then
			ds_inf_adic_w := ds_inf_adic_w ||' ' ||Wheb_mensagem_pck.get_texto(307120); --' e termolabil';
		else
			ds_inf_adic_w := ds_inf_adic_w ||lower(Wheb_mensagem_pck.get_texto(307121)); --'termolabil';
		end if;	
	end if;
	ds_inf_adic_w := ds_inf_adic_w ||'.';
	if	(ds_inf_adic_w <> (Wheb_mensagem_pck.get_texto(307095) || ' .') /*'Medicamento .'*/) then
		if (coalesce(ds_retorno_w::text, '') = '') then
			ds_retorno_w := ds_inf_adic_w;
		else
			ds_retorno_w := ds_retorno_w || chr(13) || chr(10) ||ds_inf_adic_w;		
		end if;	
	end if;
	
	if (nr_seq_dieta_cpoe_w IS NOT NULL AND nr_seq_dieta_cpoe_w::text <> '') then
		
		select 	coalesce(max(qt_kcal_nutri),0)
		into STRICT 	qt_kcal_nutri_w
		from 	cpoe_dieta
		where 	nr_sequencia = nr_seq_dieta_cpoe_w;
		
		if (qt_kcal_nutri_w > 0) then
			ds_retorno_w := ds_retorno_w || chr(13) || chr(10) || Wheb_mensagem_pck.get_texto(1165558) || ': ' || qt_kcal_nutri_w;
		end if;
	end if;	
else
	ds_retorno_w	:= ds_diluicao_edit_w || ds_informacao_item_w;
end if;

-- para o caso da prescricao ter origem na funcao CPOE (2314)
if ((nr_seq_mat_cpoe_w IS NOT NULL AND nr_seq_mat_cpoe_w::text <> '') and cd_funcao_w = 2314) then
    select  substr(max(a.ds_orientacao_preparo),1,2000)
    into STRICT    ds_orientacao_preparo_w
    from    cpoe_material a
    where   a.nr_sequencia = nr_seq_mat_cpoe_w;

    if (ds_orientacao_preparo_w IS NOT NULL AND ds_orientacao_preparo_w::text <> '') then
        ds_retorno_w := ds_orientacao_preparo_w;
    end if;
end if;

return substr(ds_retorno_w,1,2000);

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_diluicao_medic (nr_sequencia_p bigint, nr_prescricao_p bigint) FROM PUBLIC;

