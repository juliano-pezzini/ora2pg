-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION tax_validate_withholding_tax (invoice_sequence_p nota_fiscal.nr_sequencia%type, tax_type_p tributo.ie_tipo_tributo%type, item_p nota_fiscal_item.nr_item_nf%type default 1) RETURNS varchar AS $body$
DECLARE

tax_invoice_w         nota_fiscal_trib.ie_retencao%type;
tax_w                 tributo.ie_soma_diminui%type;
tax_rule_w            regra_calculo_imposto.ie_retencao%type := null;
tax_type_w            tributo.ie_tipo_tributo%type;
tax_iss_w             tributo.ie_tipo_tributo%type := 'ISS';
is_iss_w              varchar(2);
material_code_w       nota_fiscal_item.cd_material%type;
procedure_code_w      nota_fiscal_item.cd_procedimento%type;
natural_person_w      nota_fiscal.cd_pessoa_fisica%type;
cgc_w                 nota_fiscal.cd_cgc%type;
invoice_operation_w   nota_fiscal.cd_operacao_nf%type;
nature_operation_w    nota_fiscal.cd_natureza_operacao%type;
tax_cod_w             tributo.cd_tributo%type;
establishment_w       nota_fiscal.cd_estabelecimento%type;
counter_w             bigint := 0;
counter_general_w     bigint := 0;
return_w              varchar(1) := 'N';

tax_calculation_rule CURSOR(tax_cod_w  tributo.cd_tributo%type)  FOR
    SELECT  a.ie_retencao,
            a.cd_estabelecimento,
            a.cd_pessoa_fisica,
            a.cd_cgc,
            a.cd_operacao_nf,
            a.cd_natureza_operacao,
            a.cd_procedimento,
            a.cd_material
    from    regra_calculo_imposto a
    where   a.cd_tributo = tax_cod_w
    and     coalesce(a.ie_exporta_xml, 'N') = 'S'
    and     a.dt_vigencia	< clock_timestamp();

tax_calculation_rule_vector   tax_calculation_rule%rowtype;
BEGIN

  if tax_iss_w = tax_type_p then
      is_iss_w := obter_se_nf_retem_iss(invoice_sequence_p);

      if is_iss_w = 'S' then
        return_w := 'S';
      end if;
  else
    select  max(x.establishment),
            max(x.tax_invoice),
            max(x.tax),
            max(x.tax_type),
            max(x.natural_person),
            max(x.cgc),
            max(x.invoice_operation),
            max(x.nature_operation),
            max(x.procedure_code),
            max(x.material_code),
            max(x.tax_code)
    into STRICT    establishment_w,
            tax_invoice_w,
            tax_w,
            tax_type_w,
            natural_person_w,
            cgc_w,
            invoice_operation_w,
            nature_operation_w,
            procedure_code_w,
            material_code_w,
            tax_cod_w
    from (SELECT  a.cd_estabelecimento establishment,
                    null tax_invoice,
                    d.ie_soma_diminui tax,
                    d.ie_tipo_tributo tax_type,
                    a.cd_pessoa_fisica natural_person,
                    a.cd_cgc cgc,
                    a.cd_operacao_nf invoice_operation,
                    a.cd_natureza_operacao nature_operation,
                    b.cd_procedimento procedure_code,
                    b.cd_material material_code,
                    d.cd_tributo tax_code
            from    nota_fiscal a
            inner join nota_fiscal_item b on b.nr_sequencia = a.nr_sequencia
            inner join nota_fiscal_item_trib c on c.nr_sequencia = a.nr_sequencia
            inner join tributo d on d.cd_tributo = c.cd_tributo
            where   a.nr_sequencia = invoice_sequence_p
            and     d.ie_tipo_tributo = tax_type_p
            and     b.nr_item_nf = item_p
            and     d.ie_situacao = 'A'

union

            SELECT  a.cd_estabelecimento establishment,
                    coalesce(b.ie_retencao, 'S') tax_invoice,
                    c.ie_soma_diminui tax,
                    c.ie_tipo_tributo tax_type,
                    a.cd_pessoa_fisica natural_person,
                    a.cd_cgc cgc,
                    a.cd_operacao_nf invoice_operation,
                    a.cd_natureza_operacao nature_operation,
                    0 procedure_code,
                    0 material_code,
                    c.cd_tributo tax_code
            from    nota_fiscal a
            inner join nota_fiscal_trib b on b.nr_sequencia = a.nr_sequencia
            inner join tributo c on c.cd_tributo = b.cd_tributo
            where   a.nr_sequencia = invoice_sequence_p
            and     c.ie_tipo_tributo = tax_type_p
            and     c.ie_situacao = 'A') x;

    for rule in tax_calculation_rule(tax_cod_w) loop
    begin
      if establishment_w = rule.cd_estabelecimento then
        counter_w := counter_w + 1;
      end if;

      if natural_person_w = rule.cd_pessoa_fisica then
        counter_w := counter_w + 1;
      end if;

      if cgc_w = rule.cd_cgc then
        counter_w := counter_w + 1;
      end if;

      if invoice_operation_w = rule.cd_operacao_nf then
        counter_w := counter_w + 1;
      end if;

      if nature_operation_w = rule.cd_natureza_operacao then
        counter_w := counter_w + 1;
      end if;

      if procedure_code_w = rule.cd_procedimento then
        counter_w := counter_w + 1;
      end if;

      if material_code_w = rule.cd_material then
        counter_w := counter_w + 1;
      end if;

      if counter_w > counter_general_w then
        tax_rule_w := rule.ie_retencao;
        counter_general_w := counter_w;
      end if;
      counter_w := 0;
    end;
    end loop;

    if (tax_type_w IS NOT NULL AND tax_type_w::text <> '') then
      return_w := 'S';
      if coalesce(tax_rule_w::text, '') = '' or tax_rule_w = 'P' then
        if tax_w = 'N' then
          return_w := 'N';
        end if;
      elsif tax_rule_w = 'N' then
        return_w := 'N';
      elsif tax_invoice_w = 'N' then
        return_w := 'N';
      end if;
    end if;

  end if;

  return return_w;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION tax_validate_withholding_tax (invoice_sequence_p nota_fiscal.nr_sequencia%type, tax_type_p tributo.ie_tipo_tributo%type, item_p nota_fiscal_item.nr_item_nf%type default 1) FROM PUBLIC;

