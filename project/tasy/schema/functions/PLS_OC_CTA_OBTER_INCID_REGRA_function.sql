-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION pls_oc_cta_obter_incid_regra ( dados_regra_p pls_tipos_ocor_pck.dados_regra, dados_filtro_p pls_tipos_ocor_pck.dados_filtro) RETURNS varchar AS $body$
DECLARE


/* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Finalidade: Verificar se uma regra se ocorrência combinada foi criada para gerar ocorrência
na conta ou item
-------------------------------------------------------------------------------------------------------------------
Locais de chamada direta:
[ X ]  Objetos do dicionário [ ] Tasy (Delphi/Java) [  ] Portal [  ]  Relatórios [ ] Outros:
 ------------------------------------------------------------------------------------------------------------------
Pontos de atenção:

Alterações:
 ------------------------------------------------------------------------------------------------------------------
 jjung OS 601441 06/06/2013 -

 Alteração:
	Buscar a validação da tabela PLS_OC_CTA_TIPO_VALIDACAO e verificar
	por este campo.
 Motivo:
	Devido a alteração na estrutura de cadastro é necessário fazer esta alteração
	para obter a incidencia correta da regra.
 ------------------------------------------------------------------------------------------------------------------
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */
ie_retorno_w		pls_oc_cta_tipo_validacao.ie_aplicacao_ocorrencia%type;


BEGIN
ie_retorno_w := null;
-- se foi informada a regra
if (dados_regra_p.nr_sequencia IS NOT NULL AND dados_regra_p.nr_sequencia::text <> '') then
	/* Verificar validações*/

	-- o somente filtro recebe valor 1. Se não for este, verificar se  a incidência é na conta, procedimento ou material
	if (dados_regra_p.ie_validacao > 1) then
		select	max(ie_aplicacao_ocorrencia)
		into STRICT	ie_retorno_w
		from	pls_oc_cta_tipo_validacao
		where	cd_validacao = dados_regra_p.ie_validacao;
	end if;

	/* Se não teve validação, ou se a validação for por procedimento e material ou se retornar que é por conta, verificar filtros */

	if (coalesce(ie_retorno_w::text, '') = '' or ie_retorno_w = 'PM' or ie_retorno_w = 'C') then

		/* verificar se tem algum filtro por procedimento */

		if (dados_filtro_p.ie_filtro_proc = 'S') then

			ie_retorno_w	:= 'P';
		/* Verificar se tem algum filtro por material */

		elsif (dados_filtro_p.ie_filtro_mat = 'S') then

			ie_retorno_w	:= 'M';
		-- se a verificação não tiver filtro de procedimento ou material, ficará como PM
		-- se não for nada disso, é por conta
		elsif	((ie_retorno_w != 'PM') or (coalesce(ie_retorno_w::text, '') = '')) then

			/* Caso contrário, aplica na conta */

			ie_retorno_w	:= 'C';
		end if;
	end if;

end if;

return	ie_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION pls_oc_cta_obter_incid_regra ( dados_regra_p pls_tipos_ocor_pck.dados_regra, dados_filtro_p pls_tipos_ocor_pck.dados_filtro) FROM PUBLIC;

