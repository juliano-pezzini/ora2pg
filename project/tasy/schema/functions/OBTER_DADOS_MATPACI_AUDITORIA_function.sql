-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_dados_matpaci_auditoria ( nr_sequencia_p bigint, ie_opcao_p text) RETURNS varchar AS $body$
DECLARE

ds_setor_atendimento_w		varchar(250);
ds_retorno_w			varchar(255);
cd_unidade_medida_w		varchar(30);
nr_seq_proc_pacote_w		bigint;
nr_sequencia_w			bigint;
cd_acao_w			varchar(1);
cd_cgc_prestador_w		varchar(14);
cd_material_convenio_w		varchar(20);
qt_estoque_material_w		double precision;
nr_seq_proc_princ_w		bigint;
cd_kit_material_w		bigint;
cd_setor_atendimento_w		integer;
ds_medico_autenticacao_w	varchar(100);
nr_seq_kit_estoque_w		bigint;
nr_interno_conta_w		bigint;
dt_entrada_unidade_w		timestamp;
nr_seq_atepacu_w		bigint;
nr_seq_atepacu_ajuste_w		bigint;
nr_seq_lote_ap_w		bigint;
nm_usuario_original_w		material_atend_paciente.nm_usuario_original%type;
cd_material_informado_w		bigint;
ds_material_informado_w		material.ds_material%type;
cd_material_tuss_w		material_atend_paciente.cd_material_tuss%type;
ds_material_tuss_w		material_atend_paciente.ds_material_tuss%type;
/* 
ie_opcao_p 
DS - Descrição Setor 
UN - Unidade Medida 
NP - Número sequência do pacote 
DP - Descrição do pacote 
DV - Verifica se é devolucao 
CGC - Prestador 
CMC - Código Material convênio 
QTD - Quantidade real 
PC - Proc. Principal 
CS - Código Setor 
K - Kit de material 
NMA - Médico autenticação 
KE - Kit material estoque 
NC - Número da conta 
DU - Data de entrada na unidade 
SU - Seq. Atepacu 
LAP - Lote do atendimento da prescrição 
UO - Usuário original (material_atend_paciente) 
CMI - Código do Material informado 
DMI - Descrição do Material informado 
CTUSS - Código TUSS 
DTUSS - Descrição TUSS 
*/
BEGIN 
begin 
select	coalesce(obter_setor_atepacu(a.nr_seq_atepacu_ajuste,1),obter_setor_exec_item(a.nr_seq_matpaci,1)), 
	cd_unidade_medida, 
	b.nr_seq_proc_pacote, 
	b.nr_sequencia, 
	b.cd_acao, 
	b.cd_cgc_prestador, 
	b.cd_material_convenio, 
	coalesce(qt_estoque, qt_material), 
	nr_seq_proc_princ, 
	coalesce(obter_setor_atepacu(a.nr_seq_atepacu_ajuste, 0), b.cd_setor_atendimento), 
	coalesce(Obter_Kit_prescr_mat(b.nr_prescricao, b.nr_sequencia_prescricao), b.cd_kit_material) cd_kit_material, 
	substr(obter_nome_pf(b.cd_medico_autenticacao),1,100) ds_medico_autenticacao, 
	b.nr_seq_kit_estoque, 
	b.nr_interno_conta, 
	b.dt_entrada_unidade, 
	coalesce(a.nr_seq_atepacu_ajuste, b.nr_seq_atepacu), 
	a.nr_seq_atepacu_ajuste, 
	b.nr_seq_lote_ap, 
	b.nm_usuario_original, 
	b.cd_material_exec, 
	b.cd_material_tuss, 
	b.ds_material_tuss 
into STRICT	ds_setor_atendimento_w, 
	cd_unidade_medida_w, 
	nr_seq_proc_pacote_w, 
	nr_sequencia_w, 
	cd_acao_w, 
	cd_cgc_prestador_w, 
	cd_material_convenio_w, 
	qt_estoque_material_w, 
	nr_seq_proc_princ_w, 
	cd_setor_atendimento_w, 
	cd_kit_material_w, 
	ds_medico_autenticacao_w, 
	nr_seq_kit_estoque_w, 
	nr_interno_conta_w, 
	dt_entrada_unidade_w, 
	nr_seq_atepacu_w, 
	nr_seq_atepacu_ajuste_w, 
	nr_seq_lote_ap_w, 
	nm_usuario_original_w, 
	cd_material_informado_w, 
	cd_material_tuss_w, 
	ds_material_tuss_w 
from	auditoria_matpaci a, 
	material_atend_paciente b 
where	a.nr_seq_matpaci	= b.nr_sequencia 
and	a.nr_sequencia		= nr_sequencia_p;
 
exception 
	when others then 
		ds_retorno_w	:= null;
	end;
 
if (ie_opcao_p		= 'DS') then 
	ds_retorno_w		:= ds_setor_atendimento_w;
elsif (ie_opcao_p		= 'UN') then 
	ds_retorno_w		:= cd_unidade_medida_w;
elsif (ie_opcao_p		= 'NP') then 
	ds_retorno_w		:= nr_seq_proc_pacote_w;
elsif (ie_opcao_p		= 'CGC') then 
	ds_retorno_w		:= cd_cgc_prestador_w;
elsif (ie_opcao_p		= 'CMC') then 
	ds_retorno_w		:= cd_material_convenio_w;
elsif (ie_opcao_p		= 'CS') then 
	ds_retorno_w		:= cd_setor_atendimento_w;
elsif (ie_opcao_p		= 'K') then 
	ds_retorno_w		:= cd_kit_material_w;
elsif (ie_opcao_p		= 'DP') then 
	select 	max(substr(obter_descricao_procedimento(p.cd_procedimento, p.ie_origem_proced),1,120)) 
	into STRICT	ds_retorno_w 
	from 	Pacote c, 
		atendimento_pacote a, 
		Procedimento_paciente p 
	where	c.nr_seq_pacote = a.nr_seq_pacote 
	and 	a.nr_seq_procedimento = p.nr_sequencia 
	and 	p.nr_sequencia = nr_seq_proc_pacote_w;
elsif (ie_opcao_p		= 'DV') then 
	if (cd_acao_w	= '1') then 
		ds_retorno_w	:= 'N';
	else 
		ds_retorno_w	:= 'S';
	end if;
elsif (ie_opcao_p = 'QTD') then 
	ds_retorno_w := qt_estoque_material_w;
elsif (ie_opcao_p = 'PC') then 
	select coalesce(max(substr(to_char(dt_procedimento, 'dd/mm/yyyy hh24:mi:ss') || ' - ' || b.ds_procedimento,1,250)),'') 
	into STRICT	ds_retorno_w 
	from	procedimento b, 
		procedimento_paciente a 
	where 	a.cd_procedimento = b.cd_procedimento 
	and	a.ie_origem_proced = b.ie_origem_proced 
	and	a.nr_sequencia = nr_seq_proc_princ_w;
elsif (ie_opcao_p = 'NMA') then 
	ds_retorno_w := ds_medico_autenticacao_w;
elsif (ie_opcao_p = 'KE') then 
	ds_retorno_w := nr_seq_kit_estoque_w;
elsif (ie_opcao_p = 'NC') then 
	ds_retorno_w := nr_interno_conta_w;
elsif (ie_opcao_p = 'DU') then 
	if (nr_seq_atepacu_ajuste_w IS NOT NULL AND nr_seq_atepacu_ajuste_w::text <> '') then 
		select	max(dt_entrada_unidade) 
		into STRICT	dt_entrada_unidade_w 
		from	atend_paciente_unidade 
		where	nr_seq_interno = nr_seq_atepacu_ajuste_w;
	end if;
 
	ds_retorno_w := to_char(dt_entrada_unidade_w,'dd/mm/yyyy hh24:mi:ss');	
elsif (ie_opcao_p = 'SU') then 
	ds_retorno_w := nr_seq_atepacu_w;
elsif (ie_opcao_p = 'LAP') then 
	ds_retorno_w:= nr_seq_lote_ap_w;
elsif (ie_opcao_p = 'UO') then 
	ds_retorno_w	:= nm_usuario_original_w;
elsif (ie_opcao_p = 'CMI') then 
	ds_retorno_w	:= cd_material_informado_w;
elsif (ie_opcao_p = 'CTUSS') then 
	ds_retorno_w	:= cd_material_tuss_w;
elsif (ie_opcao_p = 'DTUSS') then 
	ds_retorno_w	:= ds_material_tuss_w;	
elsif (ie_opcao_p = 'DMI') then 
	select 	max(substr(ds_material,1,250)) 
	into STRICT	ds_material_informado_w 
	from 	material 
	where 	cd_material = cd_material_informado_w;	
	 
	ds_retorno_w	:= ds_material_informado_w;
end if;
 
return	ds_retorno_w;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_dados_matpaci_auditoria ( nr_sequencia_p bigint, ie_opcao_p text) FROM PUBLIC;

