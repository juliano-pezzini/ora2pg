-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION hsc_obter_saldo_ant_atu ( mes_ini_p bigint, mes_fim_p bigint, cd_empresa_p bigint, cd_estab_p bigint, ie_encerramento_p text, cd_classif_p text, cd_contabil_p text, ie_opcao_p text) RETURNS bigint AS $body$
DECLARE


vl_saldo_w 		double precision;
vl_saldo_ant_w 	double precision;


/*  ANT = saldo anterior
	ATU = saldo atual
*/
BEGIN

	SELECT	 SUM(a.vl_saldo) vl_saldo
	into STRICT	vl_saldo_w
	FROM 	ctb_balancete_v2 a
	WHERE 	a.nr_seq_mes_ref  = mes_fim_p  --TO_DATE('01/03/2012')
	AND	a.cd_empresa	= cd_empresa_p
	AND	((cd_estab_p = '0') OR (a.cd_estabelecimento = cd_estab_p))
	AND (a.ie_normal_encerramento	= ie_encerramento_p)
	AND (SUBSTR(obter_se_conta_vigente(a.cd_conta_contabil, ctb_obter_mes_ref(a.nr_seq_mes_ref)),1,1) = 'S')
	AND a.cd_classificacao = cd_classif_p
	and	a.cd_conta_contabil = cd_contabil_p
	GROUP BY a.cd_conta_contabil;

	SELECT	SUM(a.vl_saldo_ant) vl_saldo_ant
	into STRICT 	vl_saldo_ant_w
	FROM 	ctb_balancete_v2 a
	WHERE 	a.nr_seq_mes_ref = mes_ini_p -- TO_DATE('01/01/2012')
	AND	a.cd_empresa	= cd_empresa_p
	AND	((cd_estab_p = '0') OR (a.cd_estabelecimento = cd_estab_p))
	AND (a.ie_normal_encerramento	= ie_encerramento_p)
	AND (SUBSTR(obter_se_conta_vigente(a.cd_conta_contabil, ctb_obter_mes_ref(a.nr_seq_mes_ref)),1,1) = 'S')
	AND a.cd_classificacao = cd_classif_p
	and	a.cd_conta_contabil = cd_contabil_p
	GROUP BY a.cd_conta_contabil;

		if (ie_opcao_p = 'ANT') then
			return vl_saldo_ant_w;
		end if;

		if (ie_opcao_p = 'ATU') then
			return  vl_saldo_w;
		end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION hsc_obter_saldo_ant_atu ( mes_ini_p bigint, mes_fim_p bigint, cd_empresa_p bigint, cd_estab_p bigint, ie_encerramento_p text, cd_classif_p text, cd_contabil_p text, ie_opcao_p text) FROM PUBLIC;

