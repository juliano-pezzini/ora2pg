-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_regra_filtro_atrib ( nr_seq_wfiltro_p bigint, cd_estabelecimento_p bigint, cd_perfil_p bigint, nm_usuario_regra_p text) RETURNS varchar AS $body$
DECLARE


ds_sep_w		varchar(2) := ';';
ds_colunas_w		varchar(256);
cd_perfil_w 		integer;
nr_seq_regra_w		integer;
nr_seq_regra_item_w	integer;
ds_config_w		varchar(300);
ds_configs_w		varchar(4000);
nr_seq_wfiltro_atrib_w	bigint;
nm_wfiltro_atrib_w	varchar(50);

C03 CURSOR FOR
	SELECT	f.nr_sequencia,
		f.nm_atributo
	from	wfiltro_atrib_regra r,
		dic_objeto_filtro f
	where	r.nr_seq_wfiltro = f.nr_sequencia
	and	coalesce(upper(r.nm_usuario_regra),coalesce(upper(nm_usuario_regra_p),0))	= coalesce(upper(nm_usuario_regra_p),0)
	and 	coalesce(r.cd_estabelecimento,coalesce(cd_estabelecimento_p,0))           = coalesce(cd_estabelecimento_p,0)
	and 	coalesce(r.cd_perfil,coalesce(cd_perfil_p,0))           			= coalesce(cd_perfil_p,0)
	and	f.nr_seq_objeto = nr_seq_wfiltro_p
	and	exists (	SELECT	1
			from	WFILTRO_ATRIB_REGRA_ITEM x
			where	x.nr_seq_atrib_regra	= r.nr_sequencia)
	order by f.nr_seq_apresent;


C01 CURSOR FOR
	SELECT	nr_sequencia
	FROM	wfiltro_atrib_regra
	WHERE	nr_seq_wfiltro	=  nr_seq_wfiltro_atrib_w
	AND	coalesce(UPPER(nm_usuario_regra),coalesce(UPPER(nm_usuario_regra_p),0))	= coalesce(UPPER(nm_usuario_regra_p),0)
	AND 	coalesce(cd_estabelecimento,coalesce(cd_estabelecimento_p,0))           	= coalesce(cd_estabelecimento_p,0)
	AND 	coalesce(cd_perfil,coalesce(cd_perfil_p,0))           			= coalesce(cd_perfil_p,0)
	ORDER BY
		coalesce(nm_usuario_regra,'AAAAAAAA'),
		coalesce(cd_perfil,0),
		coalesce(cd_estabelecimento,0);

C02 CURSOR FOR
	SELECT	cd_item || '@#' || ie_configuracao
	from	wfiltro_atrib_regra_item
	where 	nr_seq_atrib_regra = nr_seq_regra_item_w;


BEGIN
nr_seq_regra_item_w := 0;
ds_configs_w   := '';
open C03;
loop
fetch C03 into
	nr_seq_wfiltro_atrib_w,
	nm_wfiltro_atrib_w;
EXIT WHEN NOT FOUND; /* apply on C03 */
	begin
	if (ds_configs_w IS NOT NULL AND ds_configs_w::text <> '') then
		ds_configs_w := ds_configs_w || ';';
	end if;

	ds_configs_w := ds_configs_w || nm_wfiltro_atrib_w;

	OPEN C01;
	LOOP
	FETCH C01 INTO
		nr_seq_regra_item_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		BEGIN
		nr_seq_regra_item_w := nr_seq_regra_item_w;
		END;
	END LOOP;
	CLOSE C01;

	if (nr_seq_regra_item_w <> 0) then
		open C02;
		loop
		fetch C02 into
			ds_config_w;
		EXIT WHEN NOT FOUND; /* apply on C02 */
			begin
			if (length(ds_configs_w) > 0) then
				ds_configs_w :=  ds_configs_w || '&';
			end if;

			ds_configs_w := ds_configs_w || ds_config_w;
			end;
		end loop;
		close C02;

	end if;
	end;
end loop;
close C03;

if (ds_configs_w IS NOT NULL AND ds_configs_w::text <> '') then
	ds_configs_w := ds_configs_w || ';';
end if;

return ds_configs_w;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_regra_filtro_atrib ( nr_seq_wfiltro_p bigint, cd_estabelecimento_p bigint, cd_perfil_p bigint, nm_usuario_regra_p text) FROM PUBLIC;

