-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION buscar_qt_medic_auc (NR_SEQ_PACIENTE_P bigint default null, NR_SEQ_ATENDIMENTO_P bigint default null) RETURNS varchar AS $body$
DECLARE


  v_count_atend    bigint;
  v_count_prot     bigint;

BEGIN
  IF (NR_SEQ_PACIENTE_P IS NOT NULL AND NR_SEQ_PACIENTE_P::text <> '') THEN
    BEGIN
      select count(*)
        into STRICT v_count_prot
        from paciente_protocolo_medic
       where paciente_protocolo_medic.nr_seq_paciente = nr_seq_paciente_p
         and coalesce(paciente_protocolo_medic.nr_seq_diluicao::text, '') = ''
         and coalesce(paciente_protocolo_medic.nr_seq_solucao::text, '') = ''
         and coalesce(paciente_protocolo_medic.nr_seq_procedimento::text, '') = ''
         and coalesce(paciente_protocolo_medic.nr_seq_medic_material::text, '') = ''
         and 'mgcar' =
             (SELECT max(lower(cd_unidade_med_sec))
                from unidade_medida um
               where um.cd_unidade_medida =
                     paciente_protocolo_medic.cd_unidade_medida);
    EXCEPTION
      WHEN OTHERS THEN
        v_count_prot := 0;
    END;
    IF (coalesce(v_count_prot,0) > 0) THEN
      RETURN 'S';
    END IF;
  END IF;

  IF (NR_SEQ_ATENDIMENTO_P IS NOT NULL AND NR_SEQ_ATENDIMENTO_P::text <> '') THEN
    BEGIN
      select count(*)
        into STRICT v_count_atend
        from paciente_atend_medic
       where coalesce(paciente_atend_medic.dt_cancelamento::text, '') = ''
         and 'mgcar' =
             (SELECT max(lower(cd_unidade_med_sec))
                from unidade_medida um
               where um.cd_unidade_medida = paciente_atend_medic.cd_unid_med_dose)
         and coalesce(paciente_atend_medic.nr_seq_diluicao::text, '') = ''
         and coalesce(paciente_atend_medic.nr_seq_solucao::text, '') = ''
         and coalesce(paciente_atend_medic.nr_seq_procedimento::text, '') = ''
         and paciente_atend_medic.nr_seq_atendimento = NR_SEQ_ATENDIMENTO_P;
    EXCEPTION
      WHEN OTHERS THEN
        v_count_atend := 0;
    END;
    IF (coalesce(v_count_atend,0) > 0) THEN
      RETURN 'S';
    END IF;
  END IF;

  RETURN 'N';
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION buscar_qt_medic_auc (NR_SEQ_PACIENTE_P bigint default null, NR_SEQ_ATENDIMENTO_P bigint default null) FROM PUBLIC;

