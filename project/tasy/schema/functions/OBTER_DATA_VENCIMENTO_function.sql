-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_data_vencimento ( dt_base_p timestamp, qt_dia_p bigint, cd_estabelecimento_p bigint, ie_corrido_util_p text, ie_acao_nao_util_p text) RETURNS timestamp AS $body$
DECLARE

/*	ie_acao_nao_util_p
		A - Antecipar
		M - Manter
		P - Postergar
*/
dt_venc_w		timestamp;
qt_dia_w		integer;
qt_feriado_w		smallint;
ie_first_day     smallint;


BEGIN

qt_dia_w		:= 0;
dt_venc_w		:= pkg_date_utils.start_of(dt_base_p, 'DD', 0);
ie_first_day    := 0;

if (ie_corrido_util_p = 'U') then

	while(qt_dia_w < qt_dia_p) loop

		begin

		if (ie_first_day <> 0) then
            dt_venc_w	:= dt_venc_w + 1;
        end if;

        ie_first_day := 1;

		select	count(1)
		into STRICT 	qt_feriado_w
		from 	feriado
		where	cd_estabelecimento = cd_estabelecimento_p
		and	dt_feriado         = dt_venc_w;

		if (qt_feriado_w = 0) and (pkg_date_utils.IS_BUSINESS_DAY(dt_venc_w) <> 0)  then
			qt_dia_w	:= qt_dia_w + 1;
		end if;

		end;

	end loop;
else
	begin

	dt_venc_w 	:= dt_venc_w + qt_dia_p;
	dt_venc_w 	:= pkg_date_utils.start_of(dt_venc_w, 'DD', 0);
	qt_dia_w	:= 0;

	if (ie_acao_nao_util_p = 'P') then

		while(qt_dia_w = 0) loop

			begin

			select	count(1)
			into STRICT 	qt_feriado_w
			from 	feriado
			where	cd_estabelecimento = cd_estabelecimento_p
			and	dt_feriado         = dt_venc_w;

			if (qt_feriado_w = 0) and (pkg_date_utils.IS_BUSINESS_DAY(dt_venc_w) <> 0) then
				qt_dia_w	:= qt_dia_w + 1;
			else
				dt_venc_w	:= dt_venc_w + 1;
			end if;

			end;

		end loop;

	elsif (ie_acao_nao_util_p = 'A') then

		while(qt_dia_w = 0) loop

			begin

			select	count(1)
			into STRICT 	qt_feriado_w
			from 	feriado
			where	cd_estabelecimento = cd_estabelecimento_p
			and	dt_feriado         = dt_venc_w;

			if (qt_feriado_w = 0) and (pkg_date_utils.IS_BUSINESS_DAY(dt_venc_w) <> 0) then
				qt_dia_w	:= qt_dia_w + 1;
			else	
				dt_venc_w	:= dt_venc_w - 1;
			end if;

			end;

		end loop;
	end if;

	end;
end if;

if   	dt_venc_w < dt_base_p then
     	dt_venc_w := dt_base_p;
end if;

return dt_venc_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_data_vencimento ( dt_base_p timestamp, qt_dia_p bigint, cd_estabelecimento_p bigint, ie_corrido_util_p text, ie_acao_nao_util_p text) FROM PUBLIC;

