-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_periodo_os ( nr_seq_ordem_serv_p bigint) RETURNS varchar AS $body$
DECLARE


ie_sla_status_w varchar(1);
ie_sla_w        bigint;


BEGIN
  begin

  select count(1)
  into STRICT   ie_sla_w
  from   man_ordem_serv_sla
  where  nr_seq_ordem = nr_seq_ordem_serv_p;

  if (ie_sla_w > 0)then
    select
      case
      --sla nao estourado
      when(rel1.target_resolution > 0 and (rel1.target_resolution - rel1.so_resolution_time) > 0) then
        case
          when(rel1.target_resolution - rel1.so_resolution_time) <= 390 then 'C'  -- critical
          when(rel1.target_resolution - rel1.so_resolution_time) between 390 and 1440 then 'W' --warning
          when(rel1.target_resolution - rel1.so_resolution_time) > 1440 then 'G' -- good
        else null
      end
      --sla estourado
      when(rel1.target_resolution > 0 and (rel1.target_resolution - rel1.so_resolution_time) <= 0) then 'B'  --breached
      else null
      end
      status_sla_resolution
    into STRICT ie_sla_status_w
    from (
      SELECT 
        rel.target_response
        ,rel.target_resolution
        ,sum(rel.stage_time) so_resolution_time
      from (
        SELECT 
          mos.nr_sequencia so_number
          ,mos.dt_ordem_servico
          ,msr.qt_min_inicio target_response
          ,msr.qt_min_termino target_resolution
          ,msr.ie_tempo
          ,to_char(mose.dt_atualizacao,'dd/mm/yyyy hh24:mi:ss') dt_atualizacao
          ,mose.nr_seq_estagio
          ,mep.ds_estagio
          ,case 
           when msr.ie_tempo <> 'COR' then --se diferente de horario corrido (horario comercial)
             man_obter_tempo_com(
               ml.cd_estabelecimento
               ,mose.dt_atualizacao
               ,coalesce(
                 (select min(a.dt_atualizacao)
                  from   man_ordem_serv_estagio a
                  where  a.nr_seq_ordem  = mos.nr_sequencia
                  and    a.dt_atualizacao > mose.dt_atualizacao)
                ,clock_timestamp())
             ,'MC')
           else -- se tempo corrido
             trunc(
               (coalesce(
                 (select min(dt_atualizacao)
                  from   man_ordem_serv_estagio o1
                  where  o1.nr_seq_ordem =  mos.nr_sequencia
                  and    o1.nr_sequencia > mose.nr_sequencia
                  )
                 ,clock_timestamp()
                ) - mose.dt_atualizacao
               )*1440
             )
           end
           stage_time
        from 
          man_sla ms
          ,man_sla_regra msr
          ,man_sla_loc msl
          ,man_localizacao ml
          ,man_ordem_servico mos
          ,man_ordem_serv_estagio mose
          ,man_estagio_processo mep
        where 
          ms.ie_situacao='A'
          and ms.nr_sequencia = msr.nr_seq_sla
          and msr.nr_seq_sla = msl.nr_seq_sla
          and ml.nr_sequencia = msl.nr_seq_local
          and msr.ie_prioridade = mos.ie_prioridade /*filtro prioridade da os = prioridade do cadastro de sla*/
		  and msr.ie_classificacao = mos.ie_classificacao /*filtro classificacao da os = classificacao do cadastro de sla*/
          and mos.nr_seq_localizacao = ml.nr_sequencia
          and mos.nr_sequencia = mose.nr_seq_ordem
          and mose.nr_seq_estagio = mep.nr_sequencia
          and mos.ie_classificacao = 'E'
          and mos.nr_sequencia = nr_seq_ordem_serv_p
          /* estagios que nao contam sla
                2 cliente (teste);
              261 desenv aguardando cliente;
             1341 aguardando inf. do cliente - suporte;
             1511 cliente (teste) - ok;
             1902 tec aguardando definicao cliente;
              511 encerramento solicitado pelo cliente;
                9 ok - cliente - encerrado;
              121 aguardando conexao;
               41 aguardando informacoes do cliente
          */
          and mep.nr_sequencia not in (2,261,1511,1902, 1341,511,9, 121,41)
      ) rel
      group by rel.target_response, rel.target_resolution
    ) rel1;
  end if;

exception
  when others then
    ie_sla_status_w := '';
end;

return  ie_sla_status_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_periodo_os ( nr_seq_ordem_serv_p bigint) FROM PUBLIC;

