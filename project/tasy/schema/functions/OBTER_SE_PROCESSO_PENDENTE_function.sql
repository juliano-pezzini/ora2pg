-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_se_processo_pendente (nr_seq_processo_p bigint, nm_usuario_p text) RETURNS varchar AS $body$
DECLARE


ie_retorno_w		varchar(1) 	:= 'N';
cd_pessoa_fisica_w	varchar(10);
ie_resultado_w		varchar(1);
ie_aval_anterior_w	varchar(1)	:= 'N';
qt_etapa_w		integer	:= 0;
cd_pessoa_fisica_p	varchar(10);
i			integer	:= 0;

c01 CURSOR FOR
	SELECT	coalesce(cd_pessoa_fisica,0),
		ie_resultado
	FROM	gap_processo_etapa
	WHERE	nr_seq_processo	= nr_seq_processo_p
	ORDER BY	dt_prevista;


BEGIN

select	coalesce(cd_pessoa_fisica,0)
into STRICT	cd_pessoa_fisica_p
from	usuario
where	nm_usuario = nm_usuario_p;

SELECT	COUNT(*)
INTO STRICT	qt_etapa_w
FROM	gap_processo_etapa
WHERE	nr_seq_processo = nr_seq_processo_p;

IF (qt_etapa_w	= 0) then
	ie_retorno_w	:= 'N';
elsif (qt_etapa_w	= 1) then
	begin

	select	cd_pessoa_fisica,
		ie_resultado
	into STRICT	cd_pessoa_fisica_w,
		ie_resultado_w
	from	gap_processo_etapa
	where	nr_seq_processo		= nr_seq_processo_p;

	if (cd_pessoa_fisica_w	= cd_pessoa_fisica_p) and (ie_resultado_w		= 'N') then
		ie_retorno_w		:= 'S';
	end if;

	end;
ELSE	BEGIN

	open c01;
	loop	fetch c01 into
		cd_pessoa_fisica_w,
		ie_resultado_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
		if (cd_pessoa_fisica_w	= cd_pessoa_fisica_p)	and (ie_resultado_w		= 'N')			and (ie_aval_anterior_w	<> 'N')			then
			ie_retorno_w		:= 'S';
		elsif (cd_pessoa_fisica_w	= cd_pessoa_fisica_p)	and (ie_resultado_w		= 'N') and (i = 0)	then
			ie_retorno_w		:= 'S';
		end if;
		ie_aval_anterior_w	:= ie_resultado_w;
		i			:= i + 1;
	end loop;
	close C01;

	END;
end if;

return	ie_retorno_w;

end	;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_se_processo_pendente (nr_seq_processo_p bigint, nm_usuario_p text) FROM PUBLIC;

