-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_dados_medic_mapa (nr_seq_atendimento_p bigint, cd_pessoa_fisica_p text, nr_seq_mapa_p bigint, ie_opcao_p text) RETURNS varchar AS $body$
DECLARE

				 
/* 
	MP - Medicamento padrão 
	A  - primeiro atendimento 
	E  - Enfermagem 
	PP - Paciente Pesquisa 
	DP - Procedimento 
	N - Notório (á saber) 
	S - SAC 
	*/
 
 
ie_medica_padrao_w			varchar(1);
cd_material_w				bigint;
ds_retorno_w				varchar(255);
nr_atendimento_w			bigint;
nr_seq_paciente_w			bigint;
cd_enfermagem_w				bigint;
ie_paciente_pesquisa_w		varchar(1);
ie_padronizado_w			varchar(1);
ie_possui_prescricao_w		varchar(1);
ie_primeiro_atendimento_w	varchar(1);
ie_a_saber_w				varchar(1);
ie_sac_w					varchar(1);
cd_setor_atendimento_w		bigint;

C01 CURSOR FOR 
	SELECT	b.cd_material 
	from 	paciente_atend_medic b, 
		  paciente_atendimento a 
	where 	b.nr_seq_atendimento = a.nr_seq_atendimento 
	and 	a.nr_seq_atendimento = nr_seq_atendimento_p;


BEGIN 
if (ie_opcao_p = 'S') then 
 
	select	max(coalesce(ie_sac,'N')) 
	into STRICT	ie_sac_w 
	from	mapa_ocupacao_quimio 
	where 	nr_sequencia = nr_seq_mapa_p;
	 
		ds_retorno_w := ie_sac_w;
		 
elsif (ie_opcao_p = 'N') then 
 
	select	max(ie_a_saber) 
	into STRICT	ie_a_saber_w 
	from	mapa_ocupacao_quimio 
	where 	nr_sequencia = nr_seq_mapa_p;
 
	if (coalesce(ie_a_saber_w::text, '') = '') then 
		select (CASE WHEN nr_seq_perfil=15 THEN 'S'  ELSE 'N' END ) 
		into STRICT	ie_a_saber_w 
		from	pessoa_fisica 
		where	cd_pessoa_fisica = cd_pessoa_fisica_p;	
		if (coalesce(ie_a_saber_w::text, '') = '') then 
			ds_retorno_w := 'N';
		end if;
	else 
		ds_retorno_w := ie_a_saber_w;
	end if;
elsif (ie_opcao_p = 'DP') then 
	select	max(ds_protocolo) 
	into STRICT	ds_retorno_w 
	from	mapa_ocupacao_quimio 
	where 	nr_sequencia = nr_seq_mapa_p;
	 
	if (coalesce(ds_retorno_w::text, '') = '') then 
		select	max(nr_seq_paciente) 
		into STRICT	nr_seq_paciente_w 
		from 	paciente_atendimento 
		where 	nr_seq_atendimento = nr_seq_atendimento_p;
		 
 
		select 	substr(coalesce(substr(obter_desc_prot_medic(nr_seq_paciente_w),1,255), obter_desc_expressao(327119)/*'Não Informado'*/
),1,255) 
		into STRICT	ds_retorno_w 
		;
	end if;
elsif (ie_opcao_p = 'MP') then 
 
	select	max(ie_padronizado) 
	into STRICT	ie_medica_padrao_w 
	from	mapa_ocupacao_quimio 
	where 	nr_sequencia = nr_seq_mapa_p;
 
	if (coalesce(ie_medica_padrao_w::text, '') = '') then 
		open C01;
		loop 
		fetch C01 into	 
			cd_material_w;
		EXIT WHEN NOT FOUND; /* apply on C01 */
			begin 
			select 	ie_padronizado 
			into STRICT	ie_padronizado_w 
			from 	material_estab 
			where 	cd_material = cd_material_w 
			and		cd_estabelecimento = wheb_usuario_pck.get_cd_estabelecimento;
			 
			if (ie_padronizado_w = 'N') and 
				((ie_medica_padrao_w <> 'S') or (coalesce(ie_medica_padrao_w::text, '') = '')) then 
				ie_medica_padrao_w := 'S';
			end if;
			end;
		end loop;
		close C01;
 
		if (coalesce(ie_medica_padrao_w,'N') = 'S') then 
			ds_retorno_w := 'S';
		elsif (coalesce(ie_medica_padrao_w,'N') = 'N') then 
			ds_retorno_w := 'N';
		end if;
	else 
		ds_retorno_w := ie_medica_padrao_w;
	end if;
	 
elsif (ie_opcao_p = 'A') then 
	 
	select	max(ie_primeiro_atendimento) 
	into STRICT	ie_primeiro_atendimento_w 
	from	mapa_ocupacao_quimio 
	where 	nr_sequencia = nr_seq_mapa_p;
	 
	if (coalesce(ie_primeiro_atendimento_w::text, '') = '') then 
	 
		select	max(nr_atendimento) 
		into STRICT	nr_atendimento_w 
		from 	paciente_atendimento 
		where 	nr_seq_atendimento = nr_seq_atendimento_p;
		 
		if (coalesce(nr_atendimento_w,0) = 0) then 
			select	max(nr_atendimento) 
			into STRICT	nr_atendimento_w	 
			from	paciente_setor b, 
					paciente_atendimento a 
			where 	a.nr_seq_paciente = b.nr_seq_paciente 
			and	b.cd_pessoa_fisica = cd_pessoa_fisica_p;
		end if;
	 
		if (coalesce(nr_atendimento_w,0) > 0) then 
			ds_retorno_w := 'S';
		elsif (coalesce(nr_atendimento_w,0) > 0) then 
			select 	max(cd_setor_atendimento) 
			into STRICT	cd_setor_atendimento_w 
			from 	config_mapa_quimio;
			 
			select	coalesce(max('S'),'N') 
			into STRICT	ie_possui_prescricao_w	 
			from	prescr_medica 			 
			where 	cd_pessoa_fisica = cd_pessoa_fisica_p 
			and 	cd_setor_atendimento = coalesce(cd_setor_atendimento_w,cd_setor_atendimento);
		else 
			ds_retorno_w := 'N';
		end if;
	else 
		ds_retorno_w := ie_primeiro_atendimento_w;
	end if;
	 
	 
elsif (ie_opcao_p = 'E') then 
	cd_enfermagem_w := null;
	 
	select	max(cd_enfermagem) 
	into STRICT	cd_enfermagem_w 
	from	mapa_ocupacao_quimio 
	where 	nr_sequencia = nr_seq_mapa_p;
	 
	if (coalesce(cd_enfermagem_w,0) = 0) then 
		select	max(b.cd_pessoa_fisica) 
		into STRICT	cd_enfermagem_w 
		from 	agenda_quimio a, 
			qt_profissional b, 
			mapa_ocupacao_quimio c 
		where	a.nr_seq_prof 	= 	b.nr_sequencia 
		and	a.nr_sequencia	=	c.nr_seq_agenda_quimio 
		and	c.nr_sequencia 	=	nr_seq_mapa_p;
	end if;	
	 
	if (coalesce(cd_enfermagem_w,0) = 0) then 
		select	max(cd_enfermagem) 
		into STRICT	cd_enfermagem_w 
		from 	paciente_atendimento 
		where 	nr_seq_atendimento = nr_seq_atendimento_p;
	end if;	
	 
	ds_retorno_w := substr(obter_nome_pf(cd_enfermagem_w),1,255);
elsif (ie_opcao_p = 'C') then 
	cd_enfermagem_w := null;
	 
	select	max(cd_enfermagem) 
	into STRICT	cd_enfermagem_w 
	from	mapa_ocupacao_quimio 
	where 	nr_sequencia = nr_seq_mapa_p;
	 
	if (coalesce(cd_enfermagem_w,0) = 0) then 
		select	max(b.cd_pessoa_fisica) 
		into STRICT	cd_enfermagem_w 
		from 	agenda_quimio a, 
			qt_profissional b, 
			mapa_ocupacao_quimio c 
		where	a.nr_seq_prof 	= 	b.nr_sequencia 
		and	a.nr_sequencia	=	c.nr_seq_agenda_quimio 
		and	c.nr_sequencia 	=	nr_seq_mapa_p;
	end if;	
	 
	if (coalesce(cd_enfermagem_w,0) = 0) then 
		select	max(cd_enfermagem) 
		into STRICT	cd_enfermagem_w 
		from 	paciente_atendimento 
		where 	nr_seq_atendimento = nr_seq_atendimento_p;
	end if;	
	 
	ds_retorno_w := cd_enfermagem_w;
elsif (ie_opcao_p = 'PP') then 
 
	select	max(ie_paciente_pesquisa) 
	into STRICT	ie_paciente_pesquisa_w 
	from	mapa_ocupacao_quimio 
	where 	nr_sequencia = nr_seq_mapa_p;
	 
	if (coalesce(ie_paciente_pesquisa_w::text, '') = '') then 
	 
		select	max(nr_atendimento) 
		into STRICT	nr_atendimento_w 
		from 	paciente_atendimento 
		where 	nr_seq_atendimento = nr_seq_atendimento_p;
		 
		select 	coalesce(max('S'),'N') 
		into STRICT	ie_paciente_pesquisa_w 
		from 	config_mapa_quimio 
		where	coalesce(cd_convenio,obter_conv_cat_agenda_quimio(nr_seq_mapa_p, 'CONV')) = obter_conv_cat_agenda_quimio(nr_seq_mapa_p, 'CONV') 
		and 	coalesce(cd_categoria,obter_conv_cat_agenda_quimio(nr_seq_mapa_p, 'CAT')) = obter_conv_cat_agenda_quimio(nr_seq_mapa_p, 'CAT');
		 
		ds_retorno_w := coalesce(ie_paciente_pesquisa_w,'N');
	else 
		ds_retorno_w := ie_paciente_pesquisa_w;
	end if;
end if;
 
return	ds_retorno_w;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_dados_medic_mapa (nr_seq_atendimento_p bigint, cd_pessoa_fisica_p text, nr_seq_mapa_p bigint, ie_opcao_p text) FROM PUBLIC;

