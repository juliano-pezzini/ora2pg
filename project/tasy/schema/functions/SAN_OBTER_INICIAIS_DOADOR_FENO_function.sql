-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION san_obter_iniciais_doador_feno (nr_seq_fenotipagem_p bigint) RETURNS varchar AS $body$
DECLARE


ds_iniciais_w	varchar(10);

BEGIN
if (nr_seq_fenotipagem_p IS NOT NULL AND nr_seq_fenotipagem_p::text <> '') then
	select	max(ds)
	into STRICT	ds_iniciais_w
	from (SELECT	substr(obter_iniciais_nome(max(a.cd_pessoa_fisica), null),1,10) ds
		from	san_result_fenotipagem x,
			san_doacao a
		where	x.nr_seq_doacao	= a.nr_sequencia
		and	x.nr_sequencia	= nr_seq_fenotipagem_p
                                and (x.dt_liberacao IS NOT NULL AND x.dt_liberacao::text <> '')
                                and coalesce(x.dt_inativacao::text, '') = ''
		
union

		SELECT	substr(obter_iniciais_nome(null, max(a.nm_doador)),1,10)ds
		from	san_result_fenotipagem x,
			san_emprestimo b,
			san_producao a		
		where	x.nr_seq_producao	= a.nr_sequencia
		and	a.nr_seq_emp_ent	= b.nr_sequencia
		and	x.nr_sequencia		= nr_seq_fenotipagem_p
                                and (x.dt_liberacao IS NOT NULL AND x.dt_liberacao::text <> '')
                                and coalesce(x.dt_inativacao::text, '') = ''
		
union

		select	substr(obter_iniciais_nome(san_obter_receptor(max(x.nr_seq_transfusao), max(x.nr_seq_reserva),'C'), null),1,10) ds
		from	san_result_fenotipagem x
		where	x.nr_sequencia	= nr_seq_fenotipagem_p
                                and (x.dt_liberacao IS NOT NULL AND x.dt_liberacao::text <> '')
                                and coalesce(x.dt_inativacao::text, '') = ''
		
union

		select	substr(obter_iniciais_nome(max(x.cd_pessoa_fisica), null),1,10) ds
		from	san_result_fenotipagem x
		where	x.nr_sequencia	= nr_seq_fenotipagem_p
                               and (x.dt_liberacao IS NOT NULL AND x.dt_liberacao::text <> '')
                               and coalesce(x.dt_inativacao::text, '') = '') alias24
	where	(ds IS NOT NULL AND ds::text <> '');
end if;

return	ds_iniciais_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION san_obter_iniciais_doador_feno (nr_seq_fenotipagem_p bigint) FROM PUBLIC;

