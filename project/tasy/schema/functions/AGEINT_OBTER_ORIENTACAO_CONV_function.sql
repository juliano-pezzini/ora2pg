-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION ageint_obter_orientacao_conv (cd_convenio_p bigint, cd_plano_p text, cd_categoria_p text, nr_seq_proc_interno_p bigint, nr_seq_ageint_item_p bigint, ie_tipo_atendimento_p bigint, nr_seq_topografia_p bigint) RETURNS varchar AS $body$
DECLARE


nr_row          bigint := 0;
ds_separador_w  varchar(25) := chr(10);
ds_orientacao_w	varchar(4000) := '';

cd_estabelecimento_w ageint_orient_prep_regra.cd_estabelecimento%TYPE;

  i RECORD;

BEGIN

cd_estabelecimento_w := wheb_usuario_pck.get_cd_estabelecimento;

FOR i IN (SELECT	ds_orientacao_preparo,
					nr_sequencia AS nr_row
		  FROM (SELECT 	aop.nr_sequencia,
						aopr.nr_seq_orient_preparo,
						aop.ds_orientacao_preparo,
						aopr.nr_seq_apres
				FROM	ageint_orient_preparo aop,
						ageint_orient_prep_regra aopr
				WHERE 	aop.nr_sequencia = aopr.nr_seq_orient_preparo
				AND		coalesce(aopr.nr_seq_proc_interno, nr_seq_proc_interno_p) = nr_seq_proc_interno_p
				AND 	coalesce(aopr.cd_estabelecimento, cd_estabelecimento_w) = cd_estabelecimento_w
				and 	((aopr.cd_categoria = cd_categoria_p) OR (coalesce(aopr.cd_categoria::text, '') = ''))
				and 	((aopr.cd_plano = cd_plano_p) OR (coalesce(aopr.cd_plano::text, '') = ''))
				and 	((aopr.cd_convenio = cd_convenio_p) OR (coalesce(aopr.cd_convenio::text, '') = ''))
				AND 	coalesce(aopr.nr_seq_topografia, coalesce(nr_seq_topografia_p, 0)) = coalesce(nr_seq_topografia_p, 0)
				AND 	coalesce(aopr.ie_tipo_atendimento, coalesce(ie_tipo_atendimento_p, 0)) = coalesce(ie_tipo_atendimento_p, 0)
				and 	coalesce(aop.ie_tipo_orient, 'P') = 'C'
				AND 	aop.ie_situacao = 'A'
				
UNION ALL

				SELECT	aop.nr_sequencia,
						aopr.nr_seq_orient_preparo,
						aop.ds_orientacao_preparo,
						aopr.nr_seq_apres
				FROM 	ageint_orient_preparo aop,
						ageint_orient_prep_regra aopr,
						agenda_integrada_item aii,
						ageint_exame_adic_item aeai
				WHERE 	aop.nr_sequencia = aopr.nr_seq_orient_preparo                      
				AND 	aii.nr_sequencia = coalesce(nr_seq_ageint_item_p, 0)
				AND 	aii.nr_sequencia = aeai.nr_seq_item
				AND 	coalesce(aopr.nr_seq_proc_interno, aeai.nr_seq_proc_interno) = aeai.nr_seq_proc_interno
				AND 	coalesce(aopr.cd_estabelecimento, cd_estabelecimento_w) = cd_estabelecimento_w                      
				AND 	coalesce(aeai.nr_seq_topografia, 0) = coalesce(aopr.nr_seq_topografia, coalesce(aeai.nr_seq_topografia, 0))
				AND 	coalesce(aopr.ie_tipo_atendimento, coalesce(ie_tipo_atendimento_p, 0)) = coalesce(ie_tipo_atendimento_p, 0)
				and 	((aopr.cd_categoria = cd_categoria_p) OR (coalesce(aopr.cd_categoria::text, '') = ''))
				and 	((aopr.cd_plano = cd_plano_p) OR (coalesce(aopr.cd_plano::text, '') = ''))
				and 	((aopr.cd_convenio = cd_convenio_p) OR (coalesce(aopr.cd_convenio::text, '') = ''))
				and 	coalesce(aop.ie_tipo_orient, 'P') = 'C'
				AND 	aop.ie_situacao = 'A') alias43 
		ORDER BY coalesce(nr_seq_apres,999), nr_sequencia) LOOP
	IF (nr_row  <> i.nr_row) THEN
		ds_orientacao_w := ds_orientacao_w || obter_texto_macro_prep_ageint(i.nr_row, nr_seq_ageint_item_p, i.ds_orientacao_preparo) || ds_separador_w;
		nr_row := i.nr_row;
	END IF;

END LOOP;

RETURN ds_orientacao_w;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION ageint_obter_orientacao_conv (cd_convenio_p bigint, cd_plano_p text, cd_categoria_p text, nr_seq_proc_interno_p bigint, nr_seq_ageint_item_p bigint, ie_tipo_atendimento_p bigint, nr_seq_topografia_p bigint) FROM PUBLIC;

