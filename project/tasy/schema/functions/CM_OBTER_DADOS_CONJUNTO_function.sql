-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION cm_obter_dados_conjunto ( nr_seq_conjunto_p bigint, ie_opcao_p text) RETURNS varchar AS $body$
DECLARE


ds_retorno_w			varchar(255);
nm_conjunto_w			varchar(200);
ie_situacao_w			varchar(01);
qt_tempo_esterelizacao_w	bigint;
cd_estabelecimento_w		smallint;
ds_localizacao_conjunto_w	varchar(200);
nr_seq_conj_cont_w		cm_conjunto_cont.nr_seq_conjunto%type;
ie_status_conjunto_w		cm_conjunto_cont.ie_status_conjunto%type;
ds_status_conjunto_w		varchar(255);
nr_seq_classif_w		cm_conjunto.nr_seq_classif%type;
ds_classificacao_w		cm_classif_conjunto.ds_classificacao%type;

/*
ie_opcao_p
N - Nome do conjunto
S - Situacao do conjunto
T - Tempo esterilizacao (min)
E - Estabelecimento
L - Descricao da Localizacao do conjunto
US - Ultima sequencia do ciclo
SC - Ultimo status do conjunto
DS - Descricao do ultimo status do conjunto
C - Sequencia da classificacao
DC - Descricao da classificacao
*/
BEGIN

select	max(nm_conjunto),
	max(ie_situacao),
	max(qt_tempo_esterelizacao),
	max(cd_estabelecimento),
	max(cm_obter_desc_local_conj(nr_seq_local_conj)),
	max(nr_seq_classif)
into STRICT	nm_conjunto_w,
	ie_situacao_w,
	qt_tempo_esterelizacao_w,
	cd_estabelecimento_w,
	ds_localizacao_conjunto_w,
	nr_seq_classif_w
from	cm_conjunto
where	nr_sequencia = nr_seq_conjunto_p;

if (coalesce(nm_conjunto_w::text, '') = '' and ie_opcao_p = 'N') then
	select	coalesce(max(nr_seq_conjunto),0)
	into STRICT	nr_seq_conj_cont_w
	from	cm_conjunto_cont
	where	nr_sequencia = nr_seq_conjunto_p;

	if (nr_seq_conj_cont_w > 0) then
		select	max(nm_conjunto)
		into STRICT	nm_conjunto_w
		from	cm_conjunto
		where	nr_sequencia = nr_seq_conj_cont_w;
	end if;
end if;

if (nr_seq_classif_w IS NOT NULL AND nr_seq_classif_w::text <> '') and (ie_opcao_p = 'DC')then
	select	max(ds_classificacao)
	into STRICT	ds_classificacao_w
	from	cm_classif_conjunto
	where	nr_sequencia = nr_seq_classif_w;
end if;

if (ie_opcao_p in ('US','SC','DS')) then
	select	max(nr_sequencia)
	into STRICT	nr_seq_conj_cont_w
	from	cm_conjunto_cont
	where	nr_seq_conjunto = nr_seq_conjunto_p;
	
	if (nr_seq_conj_cont_w IS NOT NULL AND nr_seq_conj_cont_w::text <> '') and (ie_opcao_p in ('SC','DS')) then
		select	max(ie_status_conjunto)
		into STRICT	ie_status_conjunto_w
		from	cm_conjunto_cont
		where	nr_sequencia = nr_seq_conj_cont_w;
		
		if (ie_opcao_p = 'DS') then
			ds_status_conjunto_w := substr(obter_descricao_dominio( cd_dominio_p => 403, vl_dominio_p => ie_status_conjunto_w),1,255);
		end if;
	end if;
end if;

if (ie_opcao_p = 'N') then
	ds_retorno_w := nm_conjunto_w;
elsif (ie_opcao_p = 'S') then
	ds_retorno_w := ie_situacao_w;
elsif (ie_opcao_p = 'T') then
	ds_retorno_w := qt_tempo_esterelizacao_w;
elsif (ie_opcao_p = 'E') then	
	ds_retorno_w := cd_estabelecimento_w;
elsif (ie_opcao_p = 'L') then	
	ds_retorno_w := ds_localizacao_conjunto_w;
elsif (ie_opcao_p = 'US') then
	ds_retorno_w := nr_seq_conj_cont_w;
elsif (ie_opcao_p = 'SC') then
	ds_retorno_w := ie_status_conjunto_w;
elsif (ie_opcao_p = 'DS') then
	ds_retorno_w := ds_status_conjunto_w;	
elsif (ie_opcao_p = 'C') then
	ds_retorno_w := nr_seq_classif_w;
elsif (ie_opcao_p = 'DC') then
	ds_retorno_w := ds_classificacao_w;
end if;

return	ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION cm_obter_dados_conjunto ( nr_seq_conjunto_p bigint, ie_opcao_p text) FROM PUBLIC;

