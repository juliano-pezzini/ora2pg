-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION adep_obtain_acknowledged (ie_tipo_item_p text, nr_seq_cpoe_p bigint) RETURNS varchar AS $body$
DECLARE


ie_return_w		varchar(1) := 'N';
ie_anatomia_patologica_w varchar(1) := 'N';
nr_seq_inf_adic_w	cpoe_inf_adic.nr_sequencia%type;
scriptQuery_w		varchar(4000);


BEGIN

scriptQuery_w := 'select	max(nr_sequencia) 	' ||
		 'from		cpoe_inf_adic 		';
			
if (ie_tipo_item_p in ('M', 'MAT', 'SOL', 'IA')) then
	scriptQuery_w := scriptQuery_w || ' where nr_seq_mat_cpoe = :nr_seq_cpoe_p ';
elsif (ie_tipo_item_p in ('D', 'SNE', 'LD', 'NAN', 'NPN', 'NPP', 'J', 'S')) then
	scriptQuery_w := scriptQuery_w || ' where nr_seq_diet_cpoe = :nr_seq_cpoe_p ';
elsif (ie_tipo_item_p = 'R') then
	scriptQuery_w := scriptQuery_w || ' where nr_seq_rec_cpoe = :nr_seq_cpoe_p ';
elsif (ie_tipo_item_p = 'O') then
	scriptQuery_w := scriptQuery_w || ' where nr_seq_gaso_cpoe = :nr_seq_cpoe_p ';
elsif (ie_tipo_item_p in ('P', 'G', 'C', 'I')) then
	scriptQuery_w := scriptQuery_w || ' where nr_seq_exam_cpoe = :nr_seq_cpoe_p ';
elsif (ie_tipo_item_p = 'DI') then
	scriptQuery_w := scriptQuery_w || ' where nr_seq_dial_cpoe = :nr_seq_cpoe_p ';
elsif (ie_tipo_item_p = 'HM') then
	scriptQuery_w := scriptQuery_w || ' where nr_seq_hemo_cpoe = :nr_seq_cpoe_p ';
elsif (ie_tipo_item_p = 'L') then
	select	coalesce(max('S'), 'N')
	into STRICT	ie_anatomia_patologica_w
	from 	cpoe_anatomia_patologica
	where 	nr_sequencia = nr_seq_cpoe_p;
	
	if (ie_anatomia_patologica_w = 'S') then
		scriptQuery_w := scriptQuery_w || ' where nr_seq_anat_cpoe = :nr_seq_cpoe_p ';
	else
		scriptQuery_w := scriptQuery_w || ' where nr_seq_exam_cpoe = :nr_seq_cpoe_p ';
	end if;
else
	scriptQuery_w := scriptQuery_w || ' 1 = 2 ';
end if;

nr_seq_inf_adic_w := obter_valor_dinamico_bv(scriptQuery_w, 'nr_seq_cpoe_p='||nr_seq_cpoe_p||';', nr_seq_inf_adic_w);

if (coalesce(nr_seq_inf_adic_w, 0) = 0) then
	ie_return_w	:= 'X';
else
	case
	/* Suplementos orais - Medicamentos - Materiais - Solucoes */

	when ie_tipo_item_p in ('M', 'MAT', 'SOL', 'IA') then 
		select	coalesce(max('S'), 'N')
		into STRICT	ie_return_w
		from	cpoe_inf_adic
		where	nr_seq_mat_cpoe = nr_seq_cpoe_p
		and	((dt_ack_nurse IS NOT NULL AND dt_ack_nurse::text <> '' AND nm_user_ack IS NOT NULL AND nm_user_ack::text <> '') or (dt_ack_nurse_susp IS NOT NULL AND dt_ack_nurse_susp::text <> '' AND nm_user_ack_susp IS NOT NULL AND nm_user_ack_susp::text <> ''));

	/* Dieta oral - SNE - Leite - NPT - Jejum */

	when ie_tipo_item_p in ('D', 'SNE', 'LD', 'NAN', 'NPN', 'NPP', 'J', 'S') then

		select	coalesce(max('S'), 'N')
		into STRICT	ie_return_w
		from	cpoe_inf_adic
		where	nr_seq_diet_cpoe = nr_seq_cpoe_p
		and	((dt_ack_nurse IS NOT NULL AND dt_ack_nurse::text <> '' AND nm_user_ack IS NOT NULL AND nm_user_ack::text <> '') or (dt_ack_nurse_susp IS NOT NULL AND dt_ack_nurse_susp::text <> '' AND nm_user_ack_susp IS NOT NULL AND nm_user_ack_susp::text <> ''));

	/* Hemoterapia */

	when ie_tipo_item_p = 'HM' then

		select	coalesce(max('S'), 'N')
		into STRICT	ie_return_w
		from	cpoe_inf_adic
		where	nr_seq_hemo_cpoe = nr_seq_cpoe_p
		and	((dt_ack_nurse IS NOT NULL AND dt_ack_nurse::text <> '' AND nm_user_ack IS NOT NULL AND nm_user_ack::text <> '') or (dt_ack_nurse_susp IS NOT NULL AND dt_ack_nurse_susp::text <> '' AND nm_user_ack_susp IS NOT NULL AND nm_user_ack_susp::text <> ''));

	/* Procedimento - Glicemia - IVC - Coletas */

	when ie_tipo_item_p in ('P', 'G', 'C', 'I', 'L') then
		if (ie_anatomia_patologica_w = 'S') then
			select	coalesce(max('S'), 'N')
			into STRICT	ie_return_w
			from	cpoe_inf_adic
			where	nr_seq_anat_cpoe = nr_seq_cpoe_p
			and	((dt_ack_nurse IS NOT NULL AND dt_ack_nurse::text <> '' AND nm_user_ack IS NOT NULL AND nm_user_ack::text <> '') or (dt_ack_nurse_susp IS NOT NULL AND dt_ack_nurse_susp::text <> '' AND nm_user_ack_susp IS NOT NULL AND nm_user_ack_susp::text <> ''));
		else
			select	coalesce(max('S'), 'N')
			into STRICT	ie_return_w
			from	cpoe_inf_adic
			where	nr_seq_exam_cpoe = nr_seq_cpoe_p
			and	((dt_ack_nurse IS NOT NULL AND dt_ack_nurse::text <> '' AND nm_user_ack IS NOT NULL AND nm_user_ack::text <> '') or (dt_ack_nurse_susp IS NOT NULL AND dt_ack_nurse_susp::text <> '' AND nm_user_ack_susp IS NOT NULL AND nm_user_ack_susp::text <> ''));
		end if;
	/* Gasoterapia */

	when ie_tipo_item_p = 'O' then

		select	coalesce(max('S'), 'N')
		into STRICT	ie_return_w
		from	cpoe_inf_adic
		where	nr_seq_gaso_cpoe = nr_seq_cpoe_p
		and	((dt_ack_nurse IS NOT NULL AND dt_ack_nurse::text <> '' AND nm_user_ack IS NOT NULL AND nm_user_ack::text <> '') or (dt_ack_nurse_susp IS NOT NULL AND dt_ack_nurse_susp::text <> '' AND nm_user_ack_susp IS NOT NULL AND nm_user_ack_susp::text <> ''));

	/* Recomendacao */

	when ie_tipo_item_p = 'R' then

		select	coalesce(max('S'), 'N')
		into STRICT	ie_return_w
		from	cpoe_inf_adic
		where	nr_seq_rec_cpoe = nr_seq_cpoe_p
		and	((dt_ack_nurse IS NOT NULL AND dt_ack_nurse::text <> '' AND nm_user_ack IS NOT NULL AND nm_user_ack::text <> '') or (dt_ack_nurse_susp IS NOT NULL AND dt_ack_nurse_susp::text <> '' AND nm_user_ack_susp IS NOT NULL AND nm_user_ack_susp::text <> ''));

	/* Dialise */

	when ie_tipo_item_p = 'DI' then

		select	coalesce(max('S'), 'N')
		into STRICT	ie_return_w
		from	cpoe_inf_adic
		where	nr_seq_dial_cpoe = nr_seq_cpoe_p
		and	((dt_ack_nurse IS NOT NULL AND dt_ack_nurse::text <> '' AND nm_user_ack IS NOT NULL AND nm_user_ack::text <> '') or (dt_ack_nurse_susp IS NOT NULL AND dt_ack_nurse_susp::text <> '' AND nm_user_ack_susp IS NOT NULL AND nm_user_ack_susp::text <> ''));
	else

		ie_return_w	:= 'X';
	end case;
end if;

return ie_return_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION adep_obtain_acknowledged (ie_tipo_item_p text, nr_seq_cpoe_p bigint) FROM PUBLIC;

