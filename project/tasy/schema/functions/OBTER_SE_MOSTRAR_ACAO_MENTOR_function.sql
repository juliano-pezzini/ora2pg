-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_se_mostrar_acao_mentor (nr_seq_pend_regra_p bigint, nr_seq_sinal_vital_p bigint, nr_seq_curativo_p bigint, qt_hroas_retroativas_p bigint, cd_pessoa_paciente_p bigint, nr_sequencia_pend_p bigint, cd_pessoa_usuario_p bigint, nr_sequencia_p bigint) RETURNS bigint AS $body$
DECLARE


inseriu_sae_w      varchar(1) := 'N';
inseriu_saps_w     varchar(1) := 'N';
nr_sequencia_w     bigint;
nr_retorno         bigint;
ds_link_w          varchar(200);
nr_seq_protocolo_w bigint;
ie_tipo_w          varchar(200);
nr_seq_proc_saps_w bigint;
nr_seq_proc_w      bigint;

ie_tipo_acao          varchar(200);
nr_seq_proc_saps_acao bigint;
nr_seq_proc_acao      bigint;
ds_link_acao          varchar(200);
nr_seq_protocolo_acao bigint;


c01 CURSOR FOR

SELECT b.nr_sequencia,
       b.ie_tipo,
       b.nr_seq_proc_saps,
       b.nr_seq_proc,
       ds_link,
       b.nr_seq_protocolo
from   gqa_pendencia_pac a,
       gqa_pend_pac_acao b,
       gqa_pend_pac_acao_dest c,
       gqa_pendencia_regra d
where  a.nr_sequencia     = b.nr_seq_pend_pac
and    b.nr_sequencia     = c.nr_seq_pend_pac_acao
and    d.nr_sequencia     = a.nr_seq_pend_regra
and    a.cd_pessoa_fisica = cd_pessoa_paciente_p
and    a.nr_sequencia     = nr_sequencia_pend_p
and    ((nr_seq_pend_regra_p > 0 and a.nr_sequencia = nr_seq_pend_regra_p) or (coalesce(nr_seq_pend_regra_p,0) <= 0))
and    ((nr_seq_sinal_vital_p > 0 and a.nr_seq_sinal_vital = nr_seq_sinal_vital_p) or (coalesce(nr_seq_sinal_vital_p,0) <= 0))
and    ((nr_seq_curativo_p > 0 and a.nr_seq_curativo = nr_seq_curativo_p) or (coalesce(nr_seq_curativo_p,0) <= 0))
and    ((qt_hroas_retroativas_p > 0 and a.dt_atualizacao_nrec >= clock_timestamp() - qt_hroas_retroativas_p) or (coalesce(qt_hroas_retroativas_p,0) <= 0))
and     c.cd_pessoa_fisica = cd_pessoa_usuario_p
order by a.nr_sequencia, b.nr_sequencia;


BEGIN

nr_retorno := nr_sequencia_p;
inseriu_sae_w := 'N';
inseriu_saps_w := 'N';

select ds_link,
       nr_seq_protocolo,
       ie_tipo,
       nr_seq_proc,
       nr_seq_proc_saps
into STRICT   ds_link_w,
       nr_seq_protocolo_w,
       ie_tipo_w,
       nr_seq_proc_w,
       nr_seq_proc_saps_w
from   gqa_pend_pac_acao
where  nr_sequencia = nr_sequencia_p;

if (coalesce(ds_link_w::text, '') = '') and (coalesce(nr_seq_protocolo_w::text, '') = '') and
   (((nr_seq_proc_w IS NOT NULL AND nr_seq_proc_w::text <> '') or ie_tipo_w = 'INTERV')
    or ((nr_seq_proc_saps_w IS NOT NULL AND nr_seq_proc_saps_w::text <> '') or ie_tipo_w = 'SAPS')) then

  open c01;
  loop
  fetch c01 into
    nr_sequencia_w,
    ie_tipo_acao,
    nr_seq_proc_saps_acao,
    nr_seq_proc_acao,
    ds_link_acao,
    nr_seq_protocolo_acao;
  EXIT WHEN NOT FOUND; /* apply on c01 */
  begin
  if (coalesce(ds_link_acao::text, '') = '') and (coalesce(nr_seq_protocolo_acao::text, '') = '') then
     if (ie_tipo_w = 'INTERV') or (nr_seq_proc_w IS NOT NULL AND nr_seq_proc_w::text <> '') and (inseriu_sae_w = 'N') and (ie_tipo_acao = 'INTERV' or (nr_seq_proc_acao IS NOT NULL AND nr_seq_proc_acao::text <> '')) then
        nr_retorno := nr_sequencia_w;
        inseriu_sae_w := 'S';
     end if;

     if (ie_tipo_w = 'SAPS') or (nr_seq_proc_saps_w IS NOT NULL AND nr_seq_proc_saps_w::text <> '') and (inseriu_saps_w = 'N') and (ie_tipo_acao = 'SAPS' or (nr_seq_proc_saps_acao IS NOT NULL AND nr_seq_proc_saps_acao::text <> '')) then
         nr_retorno := nr_sequencia_w;
         inseriu_saps_w := 'S';
     end if;
  end if;
  end;
  end loop;
end if;

return nr_retorno;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_se_mostrar_acao_mentor (nr_seq_pend_regra_p bigint, nr_seq_sinal_vital_p bigint, nr_seq_curativo_p bigint, qt_hroas_retroativas_p bigint, cd_pessoa_paciente_p bigint, nr_sequencia_pend_p bigint, cd_pessoa_usuario_p bigint, nr_sequencia_p bigint) FROM PUBLIC;

