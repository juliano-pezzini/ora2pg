-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_valor_recebido_glosa (nr_seq_hist_guia_p bigint, ie_opcao_p bigint) RETURNS bigint AS $body$
DECLARE

			 
/*ie_opcao_p 
1 - Somente valor recebido 
2 - Valor recebido + valor da glosa 
 
*/
 
			 
vl_retorno_w		double precision;
dt_baixa_glosa_w	timestamp;	
nr_interno_conta_w	bigint;
cd_autorizacao_w	varchar(20);
vl_recebido_grg_w	double precision;
vl_recebido_ret_w	double precision;
vl_recebido_glosa_w	double precision;


BEGIN 
 
vl_retorno_w	:= 0;
 
select	max(dt_baixa_glosa), 
	max(nr_interno_conta), 
	max(cd_autorizacao) 
into STRICT	dt_baixa_glosa_w, 
	nr_interno_conta_w, 
	cd_autorizacao_w 
from	lote_audit_hist_guia 
where	nr_sequencia	= nr_seq_hist_guia_p;
 
if (nr_interno_conta_w IS NOT NULL AND nr_interno_conta_w::text <> '') then 
 
	if (ie_opcao_p = 1) then 
 
		select	sum(coalesce(y.vl_recebido,0)) 
		into STRICT	vl_recebido_grg_w 
		from	lote_audit_hist z, 
			titulo_receber_liq y, 
			lote_audit_hist_guia x 
		where	x.nr_sequencia		= y.nr_seq_lote_hist_guia	 
		and	x.nr_seq_lote_hist	= z.nr_sequencia 
		and	x.nr_interno_conta	= nr_interno_conta_w 
		and	x.cd_autorizacao	= cd_autorizacao_w;
		 
		select	sum(coalesce(y.vl_recebido,0)) 
		into STRICT	vl_recebido_ret_w 
		from	convenio_retorno x, 
			titulo_receber_liq y, 
			convenio_retorno_item z 
		where	z.nr_sequencia		= y.nr_seq_ret_item 
		and	z.nr_seq_retorno	= x.nr_sequencia 
		and	z.nr_interno_conta	= nr_interno_conta_w 
		and	z.cd_autorizacao	= cd_autorizacao_w;
		 
		vl_retorno_w	:= vl_recebido_grg_w + vl_recebido_ret_w;
	 
	elsif (ie_opcao_p = 2) then 
	 
		select	sum(coalesce(y.vl_recebido,0)), 
			sum(coalesce(y.vl_glosa,0)) 
		into STRICT	vl_recebido_grg_w, 
			vl_recebido_glosa_w 
		from	lote_audit_hist z, 
			titulo_receber_liq y, 
			lote_audit_hist_guia x 
		where	x.nr_sequencia		= y.nr_seq_lote_hist_guia	 
		and	x.nr_seq_lote_hist	= z.nr_sequencia 
		and	x.nr_interno_conta	= nr_interno_conta_w 
		and	x.cd_autorizacao	= cd_autorizacao_w;
		 
		select	sum(coalesce(y.vl_recebido,0)) 
		into STRICT	vl_recebido_ret_w 
		from	convenio_retorno x, 
			titulo_receber_liq y, 
			convenio_retorno_item z 
		where	z.nr_sequencia		= y.nr_seq_ret_item 
		and	z.nr_seq_retorno	= x.nr_sequencia 
		and	z.nr_interno_conta	= nr_interno_conta_w 
		and	z.cd_autorizacao	= cd_autorizacao_w;
		 
		vl_retorno_w	:= vl_recebido_grg_w + vl_recebido_ret_w + vl_recebido_glosa_w;
	 
	end if;
end if;
 
return	vl_retorno_w;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_valor_recebido_glosa (nr_seq_hist_guia_p bigint, ie_opcao_p bigint) FROM PUBLIC;

