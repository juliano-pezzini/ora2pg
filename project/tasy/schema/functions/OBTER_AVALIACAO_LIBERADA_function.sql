-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_avaliacao_liberada (nr_sequencia_p bigint) RETURNS varchar AS $body$
DECLARE

							 
ie_liberado_w 				varchar(1);
possui_avaliacao_w			varchar(1);


BEGIN 
/* 
N - Não possui Avaliação 
A - Possui Avaliação não liberada 
L - Possui Avaliação liberada 
*/
 
ie_liberado_w := 'N';
 
SELECT CASE WHEN coalesce(MAX(nr_sequencia)::text, '') = '' THEN  'N'  ELSE 'S' END  
INTO STRICT  possui_avaliacao_w 
FROM  cih_contato a, cih_cont_pes_result b 
WHERE a.nr_sequencia = nr_sequencia_p 
AND  a.nr_Sequencia = b.nr_seq_contato;
 
IF (possui_avaliacao_w = 'S') THEN 
	SELECT CASE WHEN coalesce(MAX(nr_sequencia)::text, '') = '' THEN  'A'  ELSE 'L' END  
	INTO STRICT  ie_liberado_w 
	FROM  cih_contato a, cih_cont_pes_result b 
	WHERE a.nr_sequencia = nr_sequencia_p 
	AND  a.nr_Sequencia = b.nr_seq_contato 
	AND  (a.dt_lib_avaliacao IS NOT NULL AND a.dt_lib_avaliacao::text <> '');
ELSE 
	select	CASE WHEN coalesce(MAX(a.nr_sequencia)::text, '') = '' THEN  'N'  ELSE 'S' END  
	into STRICT	possui_avaliacao_w 
	from	cih_contato a, 
		med_avaliacao_paciente b 
	where	a.nr_sequencia	= nr_sequencia_p 
	and	a.nr_sequencia = b.nr_seq_contato;
	 
	IF (possui_avaliacao_w = 'S') THEN 
		select 	CASE WHEN coalesce(MAX(a.nr_sequencia)::text, '') = '' THEN  'A'  ELSE 'L' END  
		into STRICT  	ie_liberado_w 
		from  	cih_contato a, 
			med_avaliacao_paciente b 
		where 	a.nr_sequencia	= nr_sequencia_p 
		and  	a.nr_sequencia	= b.nr_seq_contato 
		and  	(a.dt_lib_avaliacao IS NOT NULL AND a.dt_lib_avaliacao::text <> '');
	end if;
end if;
	 
 
RETURN ie_liberado_w;
 
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_avaliacao_liberada (nr_sequencia_p bigint) FROM PUBLIC;

