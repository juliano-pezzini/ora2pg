-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION consiste_se_ciclos_ant (nr_seq_atendimento_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint) RETURNS varchar AS $body$
DECLARE


ie_consiste_ciclo_w		varchar(1);
ie_retorno_w			varchar(1) := 'N';
qt_reg_w				bigint;


BEGIN
ie_consiste_ciclo_w  := obter_param_usuario(281, 547, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_consiste_ciclo_w );

if (ie_consiste_ciclo_w	<> 'N') then
	select 	count(*)
	into STRICT	qt_reg_w
	from 	paciente_atendimento a
	where 	a.nr_seq_atendimento = nr_seq_atendimento_p
	and 	coalesce(a.dt_cancelamento::text, '') = ''
	and 	exists ( 	SELECT 1
						from 	paciente_atendimento x
						where 	x.nr_seq_paciente = a.nr_seq_paciente
						and 	((x.nr_ciclo = a.nr_ciclo
						and 	somente_numero(x.ds_dia_ciclo) <= somente_numero(a.ds_dia_ciclo)) or (a.nr_ciclo > x.nr_ciclo))
						and 	coalesce(x.nr_prescricao::text, '') = ''
						and		x.nr_seq_atendimento	<> a.nr_seq_atendimento
						and 	coalesce(x.dt_cancelamento::text, '') = '');

	if (qt_reg_w	> 0)	then
		ie_retorno_w := ie_consiste_ciclo_w;
	else
		ie_retorno_w := 'N';
	end if;
end if;

return	ie_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION consiste_se_ciclos_ant (nr_seq_atendimento_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint) FROM PUBLIC;

