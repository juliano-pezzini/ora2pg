-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION cpoe_obter_inicio_interv_horas ( cd_intervalo_p text, dt_inicio_base_p timestamp, dt_inicio_prescr_p timestamp ) RETURNS timestamp AS $body$
DECLARE


    ie_interv_24_w     intervalo_prescricao.ie_24_h%TYPE;
    qt_operacao_w      intervalo_prescricao.qt_operacao%TYPE;
    qt_horas_interv_w  double precision;
    dt_inicio_w        timestamp := dt_inicio_base_p;
    sql_w              varchar(200);

BEGIN

    IF (cd_intervalo_p IS NOT NULL AND cd_intervalo_p::text <> '' AND dt_inicio_base_p IS NOT NULL AND dt_inicio_base_p::text <> '') THEN
        SELECT
            coalesce(MAX(ie_24_h), 'N'),
            MAX(qt_operacao)
        INTO STRICT
            ie_interv_24_w,
            qt_operacao_w
        FROM
            intervalo_prescricao
        WHERE
                cd_intervalo = cd_intervalo_p
            AND coalesce(ie_operacao, 'X') = 'H';

        qt_horas_interv_w := obter_ocorrencia_intervalo(cd_intervalo_p, 24, 'H');


        BEGIN
            sql_w := 'CALL obter_cpoe_dt_ini_int_hrs_md(:1, :2, :3, :4, :5) INTO :dt_inicio_w';
            EXECUTE sql_w
                USING IN ie_interv_24_w, IN dt_inicio_base_p, IN qt_horas_interv_w, IN qt_operacao_w, IN dt_inicio_prescr_p, OUT dt_inicio_w;
        EXCEPTION
            WHEN OTHERS THEN
                dt_inicio_w := NULL;
        END;

    END IF;

    RETURN dt_inicio_w;
EXCEPTION
    WHEN OTHERS THEN
        RETURN dt_inicio_base_p;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION cpoe_obter_inicio_interv_horas ( cd_intervalo_p text, dt_inicio_base_p timestamp, dt_inicio_prescr_p timestamp ) FROM PUBLIC;

