-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_se_item_lib_pep (cd_pessoa_fisica_p text, nr_atendimento_p bigint, nr_seq_item_pep_p bigint, ie_tipo_soap_p text default null, cd_perfil_p bigint default null) RETURNS varchar AS $body$
DECLARE



ds_retorno_w		varchar(100) := 'S';
ie_sexo_w		varchar(1);
ie_configuracao_cli_w	varchar(1) := 'N';	
ie_nivel_atencao_w	varchar(1);
nr_atendimento_mae_w	atendimento_paciente.nr_atendimento_mae%type;


BEGIN

if (ie_tipo_soap_p IS NOT NULL AND ie_tipo_soap_p::text <> '') then

	ie_nivel_atencao_w := wheb_assist_pck.get_nivel_atencao_perfil;

	select	coalesce(max('S'), 'N')
	into STRICT	ie_configuracao_cli_w
	from	perfil_item_pront a,
		prontuario_item_soap_cli b
	where	b.nr_seq_item_prontuario = a.nr_sequencia
	and	a.cd_perfil = cd_perfil_p;
	
	if (ie_configuracao_cli_w = 'S') then
	
		if ( ie_tipo_soap_p = 'X') then
	
			select	coalesce(max('N'), 'S')
			into STRICT	ds_retorno_w
			from	perfil_item_pront a,
				prontuario_item_soap_cli b
			where	b.nr_seq_item_prontuario = a.nr_sequencia
			and	a.cd_perfil = cd_perfil_p
			and	a.nr_seq_item_pront  = nr_seq_item_pep_p;
	
			if (ds_retorno_w = 'N') then
			
				select	coalesce(max('S'), 'N')
				into STRICT	ds_retorno_w
				from	perfil_item_pront a,
					prontuario_item_soap_cli b
				where	b.nr_seq_item_prontuario = a.nr_sequencia
				and	a.cd_perfil = cd_perfil_p
				and	a.nr_seq_item_pront  = nr_seq_item_pep_p
				and	b.ie_etapa_soap = 'T';
			
			end if;
	
		else
	
			select	coalesce(max('S'), 'N')
			into STRICT	ds_retorno_w
			from	perfil_item_pront a,
				prontuario_item_soap_cli b
			where	b.nr_seq_item_prontuario = a.nr_sequencia
			and	a.cd_perfil = cd_perfil_p
			and	a.nr_seq_item_pront  = nr_seq_item_pep_p
			and	b.ie_etapa_soap = ie_tipo_soap_p;
			
		end if;

	else

		if (ie_tipo_soap_p = 'X') then

			select 	coalesce(max('N'), 'S')
			into STRICT 	ds_retorno_w
			from 	prontuario_item_soap
			where 	nr_seq_item_pront = nr_seq_item_pep_p;
			
			if (ds_retorno_w = 'N') then
			
				select 	coalesce(max('S'), 'N')
				into STRICT 	ds_retorno_w
				from 	prontuario_item_soap
				where 	nr_seq_item_pront = nr_seq_item_pep_p
				and	ie_etapa_soap = 'T';
			
			end if;

		else

			select 	coalesce(max('S'), 'N')
			into STRICT 	ds_retorno_w
			from 	prontuario_item_soap
			where 	nr_seq_item_pront = nr_seq_item_pep_p
			and   	ie_etapa_soap = ie_tipo_soap_p
			and	((coalesce(ie_nivel_atencao_w,'T') = 'P' and ie_apresentar_pc  = 'S') or (coalesce(ie_nivel_atencao_w,'T') = 'S' and ie_apresentar_sc  = 'S') or (coalesce(ie_nivel_atencao_w,'T') = 'T'));

		end if;
		
	end if;

end if;

if (nr_seq_item_pep_p = 364) and (cd_pessoa_fisica_p IS NOT NULL AND cd_pessoa_fisica_p::text <> '') then

	select  obter_sexo_pf(cd_pessoa_fisica_p,'C')
	into STRICT	ie_sexo_w
	;

	if (ie_sexo_w = 'M') then
		
		select 	coalesce(nr_atendimento_mae, 0) 
		into STRICT 	nr_atendimento_mae_w
		from 	atendimento_paciente
		where	nr_atendimento = nr_atendimento_p;
		
		if (nr_atendimento_mae_w = 0) then
			ds_retorno_w := 'N';
		end if;
				
	end if;

end if;

return ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_se_item_lib_pep (cd_pessoa_fisica_p text, nr_atendimento_p bigint, nr_seq_item_pep_p bigint, ie_tipo_soap_p text default null, cd_perfil_p bigint default null) FROM PUBLIC;

