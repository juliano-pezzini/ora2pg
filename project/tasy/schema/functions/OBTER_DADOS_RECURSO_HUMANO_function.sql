-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_dados_recurso_humano ( dt_referencia_p timestamp, ie_tipo_info_p text) RETURNS bigint AS $body$
DECLARE


/*	IE_TIPO_INFO_P
	'CA' 	- Colaboradores ativos
	'TO'	- Turn Over
*/
qt_retorno_w		double precision	:= 0;
qt_admitidos_w		bigint	:= 0;
qt_demitidos_w		bigint	:= 0;
qt_colaborador_w	bigint	:= 0;
qt_colaborador_ant_w	bigint	:= 0;
qt_media_adm_dem_w	double precision	:= 0;
qt_media_colaborador_w	double precision	:= 0;
qt_turn_over_w		double precision	:= 0;

dt_ref_mes_anterior_w	timestamp;


BEGIN


/* OBTER DADOS RECURSO HUMANO */

select	sum(CASE WHEN ie_admitido=1 THEN 1  ELSE 0 END ),
	sum(CASE WHEN ie_demitido=1 THEN 1  ELSE 0 END ),
	sum(CASE WHEN ie_trabalhando=1 THEN 1  ELSE 0 END ) + sum(CASE WHEN ie_ferias=1 THEN 1  ELSE 0 END ) + sum(CASE WHEN ie_licensa_maternidade=1 THEN 1  ELSE 0 END ) + sum(CASE WHEN ie_acidente_trabalho=1 THEN 1  ELSE 0 END ) +
	sum(CASE WHEN ie_auxilio_doenca=1 THEN 1  ELSE 0 END ) + sum(CASE WHEN ie_aposentado_invalid=1 THEN 1  ELSE 0 END )
into STRICT	qt_admitidos_w,
	qt_demitidos_w,
	qt_colaborador_w
from	eis_recurso_humano
where	pkg_date_utils.start_of(dt_referencia,'MONTH',0) = pkg_date_utils.start_of(dt_referencia_p,'MONTH',0);


/* OBTER MES ANTERIOR */

select	pkg_date_utils.start_of(pkg_date_utils.add_month(dt_referencia_p,-1,0),'MONTH',0)
into STRICT	dt_ref_mes_anterior_w
;


/* OBTER COLABORADORES DO MES ANTERIOR */

select	sum(CASE WHEN ie_trabalhando=1 THEN 1  ELSE 0 END ) + sum(CASE WHEN ie_ferias=1 THEN 1  ELSE 0 END ) + sum(CASE WHEN ie_licensa_maternidade=1 THEN 1  ELSE 0 END ) + sum(CASE WHEN ie_acidente_trabalho=1 THEN 1  ELSE 0 END ) +

	sum(CASE WHEN ie_auxilio_doenca=1 THEN 1  ELSE 0 END ) + sum(CASE WHEN ie_aposentado_invalid=1 THEN 1  ELSE 0 END )
into STRICT	qt_colaborador_ant_w
from	eis_recurso_humano
where	pkg_date_utils.start_of(dt_referencia,'MONTH',0) = pkg_date_utils.start_of(dt_ref_mes_anterior_w,'MONTH',0);


/* Turn Over: ((admitidos + demitidos)/2) / ((Colaboradores mês atual + colaboradores mês anterior) /2)    (média demitidos + admitidos / média colaboradores) */

begin
select	dividir((qt_admitidos_w	+ qt_demitidos_w),2),
	dividir((qt_colaborador_w + qt_colaborador_ant_w),2)
into STRICT	qt_media_adm_dem_w,
	qt_media_colaborador_w
;

qt_turn_over_w	:= dividir(qt_media_adm_dem_w,qt_media_colaborador_w);
end;

if (ie_tipo_info_p	= 'CA') then
	qt_retorno_w	:= qt_colaborador_w;
elsif (ie_tipo_info_p	= 'TO') then
	qt_retorno_w	:= qt_turn_over_w;
end if;

return	qt_retorno_w;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_dados_recurso_humano ( dt_referencia_p timestamp, ie_tipo_info_p text) FROM PUBLIC;

