-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_seq_regra_tributo ( nr_sequencia_p bigint, cd_tributo_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) RETURNS bigint AS $body$
DECLARE
														

cd_cgc_w					nota_fiscal.cd_cgc%type;
cd_pessoa_fisica_w			nota_fiscal.cd_pessoa_fisica%type;
cd_natureza_operacao_w		nota_fiscal.cd_natureza_operacao%type;
cd_operacao_nf_w			nota_fiscal.cd_operacao_nf%type;
cd_tipo_servico_w			nota_fiscal.cd_tipo_servico%type;

cd_beneficiario_w			tributo_conta_pagar.cd_beneficiario%type;
pr_aliquota_w				tributo_conta_pagar.pr_aliquota%type;
cd_cond_pagto_w				tributo_conta_pagar.cd_cond_pagto%type;
cd_conta_financ_w			tributo_conta_pagar.cd_conta_financ%type;
nr_seq_trans_reg_w			tributo_conta_pagar.nr_seq_trans_reg%type;
nr_seq_trans_baixa_w		tributo_conta_pagar.nr_seq_trans_baixa%type;
vl_minimo_base_w			tributo_conta_pagar.vl_minimo%type;
vl_minimo_tributo_w			tributo_conta_pagar.vl_minimo_tributo%type;
ie_acumulativo_w			tributo_conta_pagar.ie_acumulativo%type;
vl_teto_base_calculo_w		tributo_conta_pagar.vl_teto_base_calculo%type;
vl_desc_dependente_w		tributo_conta_pagar.vl_desc_dependente%type;
nr_seq_regra_w				tributo_conta_pagar.nr_sequencia%type;
cd_darf_w					tributo_conta_pagar.cd_darf%type;
nr_seq_classe_tp_w			tributo_conta_pagar.nr_seq_classe_tp%type;
cd_tipo_baixa_neg_w			tributo_conta_pagar.cd_tipo_baixa_neg%type;

cd_variacao_w				tributo_dctf.cd_variacao%type;
ie_periodicidade_w			tributo_dctf.ie_periodicidade%type;

cd_material_regra_w			nota_fiscal_item.cd_material%type;
vl_base_calculo_w			nota_fiscal_trib.vl_base_calculo%type;


BEGIN
	
	if (coalesce(philips_param_pck.get_cd_pais,1) = 1) then

		select
				max(coalesce(a.cd_cgc_emitente, a.cd_cgc)),
				max(a.cd_pessoa_fisica),
				max(a.cd_natureza_operacao),
				max(a.cd_operacao_nf),
				max(a.cd_tipo_servico)
		into STRICT	cd_cgc_w,
				cd_pessoa_fisica_w,
				cd_natureza_operacao_w,
				cd_operacao_nf_w,
				cd_tipo_servico_w
		from nota_fiscal a
		where a.nr_sequencia = nr_sequencia_p;
		
		select	sum(coalesce(a.vl_base_calculo,0))
		into STRICT		vl_base_calculo_w
		from		nota_fiscal_trib a
		where	a.nr_sequencia		= nr_sequencia_p
		and		a.cd_tributo		= cd_tributo_p;
		
		SELECT * FROM obter_dados_trib_tit_pagar(cd_tributo_p, cd_estabelecimento_p, cd_cgc_w, cd_pessoa_fisica_w, cd_beneficiario_w, pr_aliquota_w, cd_cond_pagto_w, cd_conta_financ_w, nr_seq_trans_reg_w, nr_seq_trans_baixa_w, vl_minimo_base_w, vl_minimo_tributo_w, ie_acumulativo_w, vl_teto_base_calculo_w, vl_desc_dependente_w, cd_darf_w, clock_timestamp(), cd_variacao_w, ie_periodicidade_w, 'N', cd_natureza_operacao_w, cd_tipo_servico_w, cd_material_regra_w, null, null, nr_seq_regra_w, cd_operacao_nf_w, 0, nr_seq_classe_tp_w, cd_tipo_baixa_neg_w, vl_base_calculo_w, 'N', null, null, null, null) INTO STRICT cd_beneficiario_w, pr_aliquota_w, cd_cond_pagto_w, cd_conta_financ_w, nr_seq_trans_reg_w, nr_seq_trans_baixa_w, vl_minimo_base_w, vl_minimo_tributo_w, ie_acumulativo_w, vl_teto_base_calculo_w, vl_desc_dependente_w, cd_darf_w, cd_variacao_w, ie_periodicidade_w, nr_seq_regra_w, nr_seq_classe_tp_w, cd_tipo_baixa_neg_w;

	end if;

	if (coalesce(nr_seq_regra_w::text, '') = '') then
		nr_seq_regra_w := 0;
	end if;

return nr_seq_regra_w;
					
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_seq_regra_tributo ( nr_sequencia_p bigint, cd_tributo_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) FROM PUBLIC;

