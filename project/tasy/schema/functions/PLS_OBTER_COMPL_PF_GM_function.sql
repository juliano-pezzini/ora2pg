-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION pls_obter_compl_pf_gm ( cd_pessoa_fisica_p text, ie_tipo_complemento_p bigint, ie_descricao_p text) RETURNS varchar AS $body$
DECLARE

					
ds_descricao_w			compl_pessoa_fisica.ds_observacao%type;
nr_seq_pessoa_endereco_w	pessoa_endereco.nr_sequencia%type;

/*
Esta function pls_obter_compl_pf_gm foi baseada na function obter_compl_pf
Houve a necessidade de criacao desta, visto que manutencoes realizadas pelo prestador na function obter_compl_pf estavam impactando no processo do guia medico

ie_tipo_complemento_p

	1 - residencial
	2 - comercial
	3 - responsavel
	4 - pai
	5 - mae
	6 - conjuge
	7 - comercial 2

ie_descricao_p
	en - so endereco
	nr - numero
	co - complemento
	b - bairro
	cep - cep
	t - telefone
	m - email
	ws - website
	dit - numero ddi telefone
	ddt - numero ddd telefone
	ram - nr ramal
	cdm - codigo municipio
	uf - estado
	fax - nr fax
	ddf - numero ddd fax
	ci - cidade
	ta - telefone adicional
*/
BEGIN

if (cd_pessoa_fisica_p IS NOT NULL AND cd_pessoa_fisica_p::text <> '') and (ie_tipo_complemento_p > 0) then
	if (address_pck.get_address_feature_enabled = 'S') then
		select	nr_seq_pessoa_endereco
		into STRICT	nr_seq_pessoa_endereco_w
		from (	SELECT	nr_seq_pessoa_endereco
			from	compl_pessoa_fisica 	a
			where	a.cd_pessoa_fisica 	= cd_pessoa_fisica_p
			and	a.ie_tipo_complemento 	= ie_tipo_complemento_p
			order by a.nr_sequencia desc) alias3 LIMIT 1;
	end if;
	
	if (ie_descricao_p = 'EN') then
		if (address_pck.get_address_feature_enabled = 'S') and (nr_seq_pessoa_endereco_w IS NOT NULL AND nr_seq_pessoa_endereco_w::text <> '') then
			select	street
			into STRICT	ds_descricao_w
			from	table(address_pck.get_address_fields(nr_seq_pessoa_endereco_w));
		end if;
		
		if (coalesce(ds_descricao_w::text, '') = '') then
			select	endereco
			into STRICT	ds_descricao_w
			from (	SELECT	ds_endereco endereco
				from	compl_pessoa_fisica a
				where	a.cd_pessoa_fisica = cd_pessoa_fisica_p
				and	a.ie_tipo_complemento = ie_tipo_complemento_p
				order by a.nr_sequencia desc) alias2 LIMIT 1;
		end if;
		
	elsif (ie_descricao_p = 'NR') then
		if (address_pck.get_address_feature_enabled = 'S') and (nr_seq_pessoa_endereco_w IS NOT NULL AND nr_seq_pessoa_endereco_w::text <> '') then
			select	house_number
			into STRICT 	ds_descricao_w
			from	table(address_pck.get_address_fields(nr_seq_pessoa_endereco_w));
		end if;
		
		if (coalesce(ds_descricao_w::text, '') = '') then
			select	nr_endereco
			into STRICT	ds_descricao_w
			from (	SELECT	a.nr_endereco
				from	compl_pessoa_fisica	a
				where	a.cd_pessoa_fisica 	= cd_pessoa_fisica_p
				and	a.ie_tipo_complemento 	= ie_tipo_complemento_p
				order by a.nr_sequencia desc) alias2 LIMIT 1;
		end if;
		
	elsif (ie_descricao_p = 'CO') then
		if (address_pck.get_address_feature_enabled = 'S') and (nr_seq_pessoa_endereco_w IS NOT NULL AND nr_seq_pessoa_endereco_w::text <> '') then
			select	complement
			into STRICT 	ds_descricao_w
			from	table(address_pck.get_address_fields(nr_seq_pessoa_endereco_w));
		end if;
		
		if (coalesce(ds_descricao_w::text, '') = '') then
			select	ds_complemento
			into STRICT	ds_descricao_w
			from (	SELECT a.ds_complemento
				from	compl_pessoa_fisica 	a
				where	a.cd_pessoa_fisica 	= cd_pessoa_fisica_p
				and	a.ie_tipo_complemento 	= ie_tipo_complemento_p
				order by a.nr_sequencia desc) alias2 LIMIT 1;
		end if;
		
	elsif (ie_descricao_p = 'B') then
		if (address_pck.get_address_feature_enabled = 'S') and (nr_seq_pessoa_endereco_w IS NOT NULL AND nr_seq_pessoa_endereco_w::text <> '') then	
			select	neighborhood
			into STRICT	ds_descricao_w
			from	table(address_pck.get_address_fields(nr_seq_pessoa_endereco_w));
		end if;
		
		if (coalesce(ds_descricao_w::text, '') = '') then
			select	ds_bairro
			into STRICT	ds_descricao_w
			from (	SELECT	a.ds_bairro
				from	compl_pessoa_fisica	a
				where	a.cd_pessoa_fisica	= cd_pessoa_fisica_p
				and	a.ie_tipo_complemento	= ie_tipo_complemento_p
				order by a.nr_sequencia desc) alias2 LIMIT 1;
		end if;
		
	elsif (ie_descricao_p = 'CEP') then
		if (address_pck.get_address_feature_enabled = 'S') and (nr_seq_pessoa_endereco_w IS NOT NULL AND nr_seq_pessoa_endereco_w::text <> '') then
			select	postalCode
			into STRICT	ds_descricao_w
			from	table(address_pck.get_address_fields(nr_seq_pessoa_endereco_w));
		end if;
		
		if (coalesce(ds_descricao_w::text, '') = '') then
			select	cd_cep
			into STRICT	ds_descricao_w
			from (	SELECT	a.cd_cep
				from	compl_pessoa_fisica 	a
				where	a.cd_pessoa_fisica	= cd_pessoa_fisica_p
				and	a.ie_tipo_complemento 	= ie_tipo_complemento_p
				order by a.nr_sequencia desc) alias2 LIMIT 1;
		end if;
		
	elsif (ie_descricao_p = 'T') then
		select	nr_telefone
		into STRICT	ds_descricao_w
		from (	SELECT	a.nr_telefone nr_telefone
			from	compl_pessoa_fisica 	a
			where	a.cd_pessoa_fisica 	= cd_pessoa_fisica_p
			and	a.ie_tipo_complemento	= ie_tipo_complemento_p
			order by a.nr_sequencia desc) alias1 LIMIT 1;
		
	elsif (ie_descricao_p = 'M') then
		select	ds_email
		into STRICT	ds_descricao_w
		from (	SELECT	a.ds_email
			from	compl_pessoa_fisica 	a
			where	a.cd_pessoa_fisica	= cd_pessoa_fisica_p
			and	a.ie_tipo_complemento 	= ie_tipo_complemento_p
			order by a.nr_sequencia desc) alias1 LIMIT 1;
		
	elsif (ie_descricao_p = 'WS') then
		select	ds_website
		into STRICT	ds_descricao_w
		from (	SELECT	a.ds_website
			from	compl_pessoa_fisica 	a
			where	a.cd_pessoa_fisica 	= cd_pessoa_fisica_p
			and	a.ie_tipo_complemento 	= ie_tipo_complemento_p
			order by a.nr_sequencia desc) alias1 LIMIT 1;
		
	elsif (ie_descricao_p = 'DIT') then
		select	nr_ddi_telefone
		into STRICT	ds_descricao_w
		from (	SELECT	a.nr_ddi_telefone
			from	compl_pessoa_fisica 	a
			where	a.cd_pessoa_fisica 	= cd_pessoa_fisica_p
			and	a.ie_tipo_complemento 	= ie_tipo_complemento_p
			order by a.nr_sequencia desc) alias1 LIMIT 1;
		
	elsif (ie_descricao_p = 'DDT') then
		select	nr_ddd_telefone
		into STRICT	ds_descricao_w
		from (	SELECT	a.nr_ddd_telefone
			from	compl_pessoa_fisica 	a
			where	a.cd_pessoa_fisica 	= cd_pessoa_fisica_p
			and	a.ie_tipo_complemento 	= ie_tipo_complemento_p
			order by a.nr_sequencia desc) alias1 LIMIT 1;
		
	elsif (ie_descricao_p = 'RAM') then
		select	nr_ramal
		into STRICT	ds_descricao_w
		from (	SELECT	a.nr_ramal
			from	compl_pessoa_fisica 	a
			where	a.cd_pessoa_fisica 	= cd_pessoa_fisica_p
			and	a.ie_tipo_complemento 	= ie_tipo_complemento_p
			order by a.nr_sequencia desc) alias1 LIMIT 1;
		
	elsif (ie_descricao_p = 'CDM') then
		select	cd_municipio_ibge
		into STRICT	ds_descricao_w
		from (	SELECT	cd_municipio_ibge
			from	compl_pessoa_fisica 	a
			where	a.cd_pessoa_fisica 	= cd_pessoa_fisica_p
			and	a.ie_tipo_complemento 	= ie_tipo_complemento_p
			order by a.nr_sequencia desc) alias1 LIMIT 1;
		
	elsif (ie_descricao_p = 'UF') then
		if (address_pck.get_address_feature_enabled = 'S') and (nr_seq_pessoa_endereco_w IS NOT NULL AND nr_seq_pessoa_endereco_w::text <> '') then
			select	city
			into STRICT	ds_descricao_w
			from	table(address_pck.get_address_fields(nr_seq_pessoa_endereco_w));
		end if;
		
		if (coalesce(ds_descricao_w::text, '') = '') then
			select	sg_estado
			into STRICT	ds_descricao_w
			from (SELECT a.sg_estado
					 from	compl_pessoa_fisica a
					 where	a.cd_pessoa_fisica = cd_pessoa_fisica_p
					 and	a.ie_tipo_complemento = ie_tipo_complemento_p
					 order by a.nr_sequencia desc) alias2 LIMIT 1;
		end if;
		
	elsif (ie_descricao_p = 'FAX') then
		select	ds_fax
		into STRICT	ds_descricao_w
		from (	SELECT	a.ds_fax
			from	compl_pessoa_fisica 	a
			where	a.cd_pessoa_fisica 	= cd_pessoa_fisica_p
			and	a.ie_tipo_complemento 	= ie_tipo_complemento_p
			order by a.nr_sequencia desc) alias1 LIMIT 1;
		
	elsif (ie_descricao_p = 'DDF') then
		select	nr_ddd_fax
		into STRICT	ds_descricao_w
		from (	SELECT	a.nr_ddd_fax
			from	compl_pessoa_fisica 	a
			where	a.cd_pessoa_fisica 	= cd_pessoa_fisica_p
			and	a.ie_tipo_complemento 	= ie_tipo_complemento_p
			order by a.nr_sequencia desc) alias1 LIMIT 1;
		
	elsif (ie_descricao_p = 'CI') then
		if (address_pck.get_address_feature_enabled = 'S') and (nr_seq_pessoa_endereco_w IS NOT NULL AND nr_seq_pessoa_endereco_w::text <> '') then
			select	city
			into STRICT	ds_descricao_w
			from	table(address_pck.get_address_fields(nr_seq_pessoa_endereco_w));
		end if;
		
		if (coalesce(ds_descricao_w::text, '') = '') then
			select	ds_municipio
			into STRICT	ds_descricao_w
			from (	SELECT	a.ds_municipio
				from	compl_pessoa_fisica 	a
				where	a.cd_pessoa_fisica 	= cd_pessoa_fisica_p
				and	a.ie_tipo_complemento 	= ie_tipo_complemento_p
				order by a.nr_sequencia desc) alias2 LIMIT 1;
		end if;
		
	elsif (ie_descricao_p = 'TA') then
		select	ds_fone_adic
		into STRICT	ds_descricao_w
		from (	SELECT	a.ds_fone_adic
			from	compl_pessoa_fisica 	a
			where	a.cd_pessoa_fisica 	= cd_pessoa_fisica_p
			and	a.ie_tipo_complemento 	= ie_tipo_complemento_p
			order by a.nr_sequencia desc) alias1 LIMIT 1;
	end if;
end if;

return ds_descricao_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION pls_obter_compl_pf_gm ( cd_pessoa_fisica_p text, ie_tipo_complemento_p bigint, ie_descricao_p text) FROM PUBLIC;

