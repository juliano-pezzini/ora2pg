-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_dados_dirf_estab ( cd_estabelecimento_p bigint, ie_opcao_p text) RETURNS varchar AS $body$
DECLARE


ie_natureza_declarante_w		varchar(3);
ie_situacao_declaracao_w		varchar(3);
ie_tipo_rendimento_w		varchar(3);
ie_declarante_depositario_w		varchar(3);
cd_empresa_w			varchar(4);
vl_min_ano_pf_w			varchar(20);
ie_indicador_socio_w		varchar(10);
ie_ind_plano_privado_w		varchar(1);
nr_sequencia_w			bigint;
ie_desc_repasse_w		dirf_regra_geral.ie_desc_repasse%type;
ie_existe_pgto_imu_ise_w	dirf_regra_geral.ie_existe_pgto_imu_ise%type;

/* Opes:
NAT: natureza do declarante
SIT: situao da declarao
REN: tipo de rendimento
DEC: declarante depositrio
EMP: empresa
VLM: valor mnimo PF sem reteno
SOC: indicador de scio ostencivo
PRI: indicador plano privado
CDR: considerar o desconto do repasse
EII: existe pagamentos para entidades imunes/isentas
*/
BEGIN

select	max(nr_sequencia)
into STRICT	  nr_sequencia_w
from	  dirf_regra_geral
where	  cd_estabelecimento = coalesce(cd_estabelecimento_p,cd_estabelecimento);

select	coalesce(ie_natureza_declarante, 'N'),
        coalesce(ie_situacao_declaracao, 'N'),
        coalesce(ie_tipo_rendimento, 'N'),
        coalesce(ie_declarante_depositario, 'N'),
        to_char(cd_empresa),
        to_char(vl_min_ano_pf),
        coalesce(ie_indicador_socio, 'N'),
        coalesce(ie_ind_plano_privado, 'N'),
        coalesce(ie_desc_repasse, 'N'),
        coalesce(ie_existe_pgto_imu_ise, 'N')
into STRICT	  ie_natureza_declarante_w,
        ie_situacao_declaracao_w,
        ie_tipo_rendimento_w,
        ie_declarante_depositario_w,
        cd_empresa_w,
        vl_min_ano_pf_w,
        ie_indicador_socio_w,
        ie_ind_plano_privado_w,
        ie_desc_repasse_w,
        ie_existe_pgto_imu_ise_w
from	  dirf_regra_geral
where 	nr_sequencia = nr_sequencia_w;

if (ie_opcao_p = 'NAT') then
	return ie_natureza_declarante_w;
elsif (ie_opcao_p = 'SIT') then
	return ie_situacao_declaracao_w;
elsif (ie_opcao_p = 'REN') then
	return ie_tipo_rendimento_w;
elsif (ie_opcao_p = 'DEC') then
	return ie_declarante_depositario_w;
elsif (ie_opcao_p = 'EMP') then
	return cd_empresa_w;
elsif (ie_opcao_p = 'VLM') then
	return vl_min_ano_pf_w;
elsif (ie_opcao_p = 'SOC') then
	return ie_indicador_socio_w;
elsif (ie_opcao_p = 'PRI') then
	return ie_ind_plano_privado_w;
elsif (ie_opcao_p = 'CDR') then
	return ie_desc_repasse_w;	
elsif (ie_opcao_p = 'EII') then
	return ie_existe_pgto_imu_ise_w;	
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_dados_dirf_estab ( cd_estabelecimento_p bigint, ie_opcao_p text) FROM PUBLIC;

