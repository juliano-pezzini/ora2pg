-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION get_if_shift_has_free_hours ( dt_agenda_p timestamp, hr_inicial_p timestamp, hr_final_p timestamp, nr_minuto_intervalo_p bigint, cd_agenda_p bigint DEFAULT NULL) RETURNS bigint AS $body$
DECLARE


    qt_horas_liberadas_w  bigint := 0;
    hr_inicio_w           timestamp;
    hr_final_w            timestamp;
    hr_atual_w            timestamp;


BEGIN
    hr_inicio_w := get_composite_date_time(dt_agenda_p, hr_inicial_p);
    hr_final_w := get_composite_date_time(dt_agenda_p, hr_final_p);
    hr_atual_w := clock_timestamp() + ( 1 / 1440 * nr_minuto_intervalo_p );

    IF (
        coalesce(hr_inicial_p::text, '') = ''
        AND (cd_agenda_p IS NOT NULL AND cd_agenda_p::text <> '')
    ) THEN
        SELECT
            MIN(hr_inicio)
        INTO STRICT hr_inicio_w
        FROM
            agenda_paciente
        WHERE
            cd_agenda = cd_agenda_p;

    END IF;

    IF (hr_inicio_w IS NOT NULL AND hr_inicio_w::text <> '') THEN
        SELECT
            24 * ( to_date(to_char(dt_agenda_p, 'yyyy-mm-dd')
                           || to_char(hr_inicio_w, 'hh24:mi:ss'),
                           'yyyy-mm-dd hh24:mi:ss') - clock_timestamp() )
        INTO STRICT qt_horas_liberadas_w
;

    END IF;

    IF (
        qt_horas_liberadas_w < 0
        AND hr_atual_w > hr_final_w
    ) THEN
        qt_horas_liberadas_w := NULL;
    END IF;

    RETURN qt_horas_liberadas_w;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION get_if_shift_has_free_hours ( dt_agenda_p timestamp, hr_inicial_p timestamp, hr_final_p timestamp, nr_minuto_intervalo_p bigint, cd_agenda_p bigint DEFAULT NULL) FROM PUBLIC;

