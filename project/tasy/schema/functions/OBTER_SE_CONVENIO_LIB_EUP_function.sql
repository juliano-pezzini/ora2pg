-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_se_convenio_lib_eup (cd_estabelecimento_p bigint, cd_convenio_p bigint, cd_funcao_p bigint, dt_referencia_p timestamp default clock_timestamp()) RETURNS varchar AS $body$
DECLARE

 
ie_retorno_w		varchar(01)	:= 'S';
cd_perfil_w		bigint;
qt_registro_w		bigint;
ie_considera_tab_w 	varchar(1);

C01 CURSOR FOR 
	SELECT	coalesce(e.IE_PERMITE_CONVENIO,'S') 
	FROM	conveio_estab_func_lib e 
	WHERE	e.cd_convenio = cd_convenio_p 
	and	e.cd_funcao = cd_funcao_p 
	and	coalesce(e.cd_perfil, cd_perfil_w) = cd_perfil_w 
	and	e.cd_estabelecimento = cd_estabelecimento_p 
	and	((coalesce(dt_referencia_p::text, '') = '') or (coalesce(dt_inicio_regra, dt_referencia_p) <= dt_referencia_p)) 
	order by e.cd_perfil desc;


BEGIN 
cd_perfil_w	:= coalesce(obter_perfil_ativo,0);
 
open C01;
loop 
fetch C01 into	 
	ie_retorno_w;
EXIT WHEN NOT FOUND; /* apply on C01 */	
end loop;
close C01;
 
select 	count(*) 
into STRICT 	qt_registro_w 
from 	convenio_estabelecimento b 
where 	b.cd_estabelecimento = cd_estabelecimento_p 
and 	b.cd_convenio = cd_convenio_p;
 
ie_considera_tab_w := Obter_Param_Usuario(916, 669, cd_perfil_w, wheb_usuario_pck.get_nm_usuario, cd_estabelecimento_p, ie_considera_tab_w);
 
if (ie_considera_tab_w = 'S') and (qt_registro_w = 0) and (ie_retorno_w = 'S') then 
	ie_retorno_w := 'N';
end if;
 
RETURN	ie_retorno_w;
 
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_se_convenio_lib_eup (cd_estabelecimento_p bigint, cd_convenio_p bigint, cd_funcao_p bigint, dt_referencia_p timestamp default clock_timestamp()) FROM PUBLIC;

