-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_valores_guia_grc_saldo ( nr_seq_guia_p bigint, nr_interno_conta_p bigint, cd_autorizacao_p text, dt_baixa_glosa_p timestamp) RETURNS bigint AS $body$
DECLARE

  vl_retorno_w          double precision;
  ie_lotes_diferentes_w varchar(1) := Obter_valor_param_usuario(69, 46, wheb_usuario_pck.get_cd_perfil, wheb_usuario_pck.get_nm_usuario,  wheb_usuario_pck.get_cd_estabelecimento);
  ie_gera_valor_pago_w  varchar(1) := Obter_valor_param_usuario(27, 266, wheb_usuario_pck.get_cd_perfil, wheb_usuario_pck.get_nm_usuario,  wheb_usuario_pck.get_cd_estabelecimento);
  valor_outros_lotes_w  double precision := 0;

BEGIN
    IF ( ie_lotes_diferentes_w = 'S' ) THEN 
      SELECT SUM(coalesce(a.vl_amenor, 0)) 
      INTO STRICT   valor_outros_lotes_w 
      FROM   lote_audit_hist_item a, 
             lote_audit_hist_guia b 
      WHERE  a.nr_seq_guia = b.nr_sequencia 
             AND b.nr_interno_conta = nr_interno_conta_p 
             AND b.cd_autorizacao = cd_autorizacao_p 
             AND b.nr_sequencia < nr_seq_guia_p;
    END IF;

    IF ( coalesce(dt_baixa_glosa_p::text, '') = '' ) THEN 
      SELECT CASE 
               WHEN ie_gera_valor_pago_w = 'N' THEN SUM( 
               coalesce(a.vl_glosa, 0) + coalesce(a.vl_amenor, 0) 
               + coalesce(a.vl_pago, 0)) 
               ELSE SUM(coalesce(a.vl_glosa, 0) + coalesce(a.vl_amenor, 0)) 
             END AS vl 
      INTO STRICT   vl_retorno_w 
      FROM   lote_audit_hist_item a 
      WHERE  a.nr_seq_guia = nr_seq_guia_p;
    ELSE 
      SELECT SUM(coalesce(a.vl_amenor, 0)) 
      INTO STRICT   vl_retorno_w 
      FROM   lote_audit_hist_item a 
      WHERE  a.nr_seq_guia = nr_seq_guia_p;
    END IF;

    vl_retorno_w := coalesce(vl_retorno_w, 0) 
                    + coalesce(valor_outros_lotes_w, 0);

    RETURN( vl_retorno_w );
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_valores_guia_grc_saldo ( nr_seq_guia_p bigint, nr_interno_conta_p bigint, cd_autorizacao_p text, dt_baixa_glosa_p timestamp) FROM PUBLIC;

