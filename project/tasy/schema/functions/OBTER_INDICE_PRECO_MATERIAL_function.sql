-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_indice_preco_material (nr_sequencia_p bigint) RETURNS bigint AS $body$
DECLARE


tx_indice_w		        double precision;--number(15,4);
cd_estabelecimento_w	        smallint;
ie_origem_preco_w		integer;
cd_material_w		        integer;
cd_brasindice_w		        varchar(80);
cd_laboratorio_w		varchar(06);
cd_medicamento_w		varchar(06);
cd_apresentacao_w	        varchar(06);
ie_pis_cofins_w		        varchar(1);
ie_tipo_preco_w		        varchar(3);
nr_seq_regra_ajuste_w	        bigint;
ie_origem_preco_regra_w	        integer;

tx_ajuste_tabela_w		double precision;
tx_brasindice_pfb_w	        REGRA_AJUSTE_MATERIAL.TX_BRASINDICE_PFB%type;--number(15,4);
tx_brasindice_pmc_neutra_w 	CONVENIO_BRASINDICE.TX_BRASINDICE_PMC%type;--number(15,4);
tx_brasindice_pmc_pos_w	        CONVENIO_BRASINDICE.TX_PMC_POS%type;--number(15,4);
tx_brasindice_pmc_neg_w	        CONVENIO_BRASINDICE.TX_PMC_NEG%type;--number(15,4);
tx_simpro_pfb_w		        double precision;
tx_simpro_pmc_w		        double precision;

cd_simpro_w		        bigint;
cd_convenio_w		        integer;

tx_brasindice_pfb_pos_w	        CONVENIO_BRASINDICE.TX_PFB_POS%type;--number(15,4);
tx_brasindice_pfb_neg_w	        CONVENIO_BRASINDICE.TX_PFB_NEG%type;--number(15,4);
ie_tipo_material_w	        varchar(3);
ie_tipo_atendimento_w	        smallint;
nr_seq_lote_fornec_w		material_lote_fornec.nr_sequencia%type;
nr_seq_marca_w 			material_lote_fornec.nr_seq_marca%type;

nr_seq_conv_simp_w		material_atend_paciente.nr_seq_conv_simp%type;
nr_seq_simp_preco_w		material_atend_paciente.nr_seq_simp_preco%type;

/*
ie_origem_preco da MATERIAL_ATEND_PACIENTE:
 1  (Brasindice)
 2  (Tabela de Material)
 4  (Simpro)
 */
C01 CURSOR FOR
	SELECT 	ie_pis_cofins,
		ie_tipo_preco
	from 	brasindice_preco
	where 	cd_laboratorio = cd_laboratorio_w
	and 	cd_medicamento = cd_medicamento_w
	and 	cd_apresentacao = cd_apresentacao_w
	order by  dt_inicio_vigencia;

C02 CURSOR FOR
	SELECT  tx_ajuste_tabela_mat
	from    material_atend_paciente a,
		convenio_preco_mat b
	where   a.nr_sequencia 		= nr_sequencia_p
	and     a.cd_convenio 		= b.cd_convenio
	and     a.cd_categoria 		= b.cd_categoria
	and     a.ie_origem_preco 	= 2
	and 	b.ie_situacao		= 'A'
	and 	b.cd_estabelecimento 	= cd_estabelecimento_w
	and 	coalesce(a.dt_vigencia_tabela,clock_timestamp()) between coalesce(b.dt_inicio_vigencia, coalesce(a.dt_vigencia_tabela,clock_timestamp())) and
							coalesce(dt_final_vigencia, coalesce(a.dt_vigencia_tabela,clock_timestamp()))
	order by b.nr_prioridade desc;

C03 CURSOR FOR
	SELECT  CASE WHEN ie_tipo_preco_w='PMC' THEN  CASE WHEN ie_pis_cofins_w='N' THEN  coalesce(tx_brasindice_pmc_neg_w, tx_pmc_neg) WHEN ie_pis_cofins_w='S' THEN  coalesce(tx_brasindice_pmc_neutra_w, tx_pmc_pos)  ELSE coalesce(tx_brasindice_pmc_neutra_w, tx_brasindice_pmc) END  WHEN ie_tipo_preco_w='PFB' THEN  CASE WHEN ie_pis_cofins_w='N' THEN  coalesce(tx_brasindice_pfb_neg_w, tx_pfb_neg) WHEN ie_pis_cofins_w='S' THEN  coalesce(tx_brasindice_pfb_pos_w, tx_pfb_pos)  ELSE coalesce(tx_brasindice_pfb_w, tx_preco_fabrica) END   ELSE tx_preco_fabrica END
	from    material_atend_paciente a,
		convenio_brasindice b
	where   a.nr_sequencia = nr_sequencia_p
	and     a.cd_convenio = b.cd_convenio
	and 	b.ie_situacao		= 'A'
	and     a.cd_categoria = coalesce(b.cd_categoria, a.cd_categoria)
	and     ie_origem_preco = 1
	and	((coalesce(b.cd_grupo_material::text, '') = '') or (obter_estrutura_material(a.cd_material, 'G') = b.cd_grupo_material))
	and 	((coalesce(b.cd_subgrupo_material::text, '') = '') or (obter_estrutura_material(a.cd_material, 'S') = b.cd_subgrupo_material))
	and 	((coalesce(b.cd_classe_material::text, '') = '') or (obter_estrutura_material(a.cd_material, 'C') = b.cd_classe_material))
	and	((coalesce(b.nr_seq_estrutura::text, '') = '') or (consistir_se_mat_estrutura(b.nr_seq_estrutura,a.cd_material) = 'S'))
	and 	((coalesce(b.ie_tipo_material::text, '') = '') or (b.ie_tipo_material = ie_tipo_material_w))
	and	((coalesce(b.ie_tipo_atendimento::text, '') = '') or (b.ie_tipo_atendimento = coalesce(ie_tipo_atendimento_w,0)))
	and     b.cd_estabelecimento = cd_estabelecimento_w
	order by  b.dt_inicio_vigencia,
		coalesce(b.nr_seq_estrutura,0),
		coalesce(b.cd_classe_material,0),
		coalesce(b.cd_subgrupo_material,0),
		coalesce(b.cd_grupo_material,0),
		coalesce(ie_tipo_material,'0'),
		coalesce(ie_tipo_atendimento,0);

C04 CURSOR FOR
	SELECT 	ie_tipo_preco
	from 	simpro_preco
	where 	cd_simpro = cd_simpro_w
	order by dt_vigencia;

C05 CURSOR FOR
	SELECT  CASE WHEN b.ie_tipo_preco='F' THEN  coalesce(tx_simpro_pfb_w, tx_preco_fabrica) WHEN b.ie_tipo_preco='V' THEN  coalesce(tx_simpro_pmc_w, tx_pmc)  ELSE coalesce(tx_simpro_pfb_w, tx_preco_fabrica) END
	from    material_atend_paciente a,
		convenio_simpro b
	where   a.nr_sequencia = nr_sequencia_p
	and     a.cd_convenio  = b.cd_convenio
	and     a.cd_categoria = b.cd_categoria
	and 	b.ie_situacao	= 'A'
	and     ie_origem_preco = 4
	and	((coalesce(b.cd_grupo_material::text, '') = '') or (obter_estrutura_material(a.cd_material, 'G') = b.cd_grupo_material))
	and 	((coalesce(b.cd_subgrupo_material::text, '') = '') or (obter_estrutura_material(a.cd_material, 'S') = b.cd_subgrupo_material))
	and 	((coalesce(b.cd_classe_material::text, '') = '') or (obter_estrutura_material(a.cd_material, 'C') = b.cd_classe_material))
	order by b.dt_inicio_vigencia,
		coalesce(b.cd_classe_material,0),
		coalesce(b.cd_subgrupo_material,0),
		coalesce(b.cd_grupo_material,0);


BEGIN

select	max(cd_estabelecimento),
	max(b.ie_origem_preco),
	max(b.cd_material),
	max(b.nr_seq_regra_ajuste_mat),
	max(a.cd_convenio_parametro),
	max(obter_tipo_atendimento(b.nr_atendimento)),
	max(b.nr_seq_lote_fornec),
	max(b.nr_seq_conv_simp),
	max(b.nr_seq_simp_preco)
into STRICT	cd_estabelecimento_w,
	ie_origem_preco_w,
	cd_material_w,
	nr_seq_regra_ajuste_w,
	cd_convenio_w,
	ie_tipo_atendimento_w,
	nr_seq_lote_fornec_w,
	nr_seq_conv_simp_w,
	nr_seq_simp_preco_w
from 	material_atend_paciente b,
	conta_paciente a
where 	a.nr_interno_conta = b.nr_interno_conta
and 	b.nr_sequencia = nr_sequencia_p;

tx_brasindice_pfb_w		:= null;
tx_brasindice_pmc_neutra_w	:= null;
tx_brasindice_pmc_neg_w		:= null;
tx_brasindice_pmc_pos_w		:= null;
tx_simpro_pfb_w			:= null;
tx_simpro_pmc_w			:= null;
tx_ajuste_tabela_w		:= null;
tx_brasindice_pfb_pos_w		:= null;
tx_brasindice_pfb_neg_w		:= null;

if (coalesce(nr_seq_regra_ajuste_w,0) > 0) then

	select 	tx_brasindice_pfb,
		tx_brasindice_pmc,
		tx_pmc_neg,
		tx_pmc_pos,
		tx_simpro_pfb,
		tx_simpro_pmc,
		coalesce(tx_afaturar, tx_ajuste),
		tx_pfb_neg,
		tx_pfb_pos
	into STRICT	tx_brasindice_pfb_w,
		tx_brasindice_pmc_neutra_w,
		tx_brasindice_pmc_neg_w,
		tx_brasindice_pmc_pos_w,
		tx_simpro_pfb_w,
		tx_simpro_pmc_w,
		tx_ajuste_tabela_w,
		tx_brasindice_pfb_pos_w,
		tx_brasindice_pfb_neg_w
	from 	regra_ajuste_material
	where 	nr_sequencia = nr_seq_regra_ajuste_w;

end if;

if (ie_origem_preco_w = 1) then -- Brasindice
	nr_seq_marca_w := 0;
	if (coalesce(nr_seq_lote_fornec_w,0) > 0) then
		select	max(coalesce(nr_seq_marca,0))
		into STRICT	nr_seq_marca_w
		from	material_lote_fornec
		where	nr_sequencia = nr_seq_lote_fornec_w;
	end if;

	select 	obter_codigo_brasindice(cd_estabelecimento_w, cd_material_w ,clock_timestamp(), cd_convenio_w, nr_seq_marca_w)
	into STRICT	cd_brasindice_w
	;

	cd_laboratorio_w		:= substr(cd_brasindice_w,1,3);
	cd_medicamento_w		:= substr(cd_brasindice_w,5,5);
	cd_apresentacao_w		:= substr(cd_brasindice_w,11,4);

	select	max(ie_tipo_material)
	into STRICT	ie_tipo_material_w
	from	estrutura_material_v
	where	cd_material = cd_material_w;

	open C01;
	loop
	fetch C01 into
		ie_pis_cofins_w,
		ie_tipo_preco_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin
		ie_pis_cofins_w  := ie_pis_cofins_w;
		ie_tipo_preco_w	 := ie_tipo_preco_w;
		end;
	end loop;
	close C01;

	open C03;
	loop
	fetch C03 into
		tx_indice_w;
	EXIT WHEN NOT FOUND; /* apply on C03 */
		begin
		tx_indice_w:= tx_indice_w;
		end;
	end loop;
	close C03;

elsif (ie_origem_preco_w = 2) then -- Tabela Material
	open C02;
	loop
	fetch C02 into
		tx_indice_w;
	EXIT WHEN NOT FOUND; /* apply on C02 */
		begin
		tx_indice_w:= tx_indice_w;
		end;
	end loop;
	close C02;

	tx_indice_w:= coalesce(tx_ajuste_tabela_w, tx_indice_w);

elsif (ie_origem_preco_w = 4) then -- Simpro
	select 	max(cd_simpro)
	into STRICT	cd_simpro_w
	from 	material_simpro
	where 	cd_material = cd_material_w
	and	coalesce(cd_estabelecimento, cd_estabelecimento_w) = cd_estabelecimento_w;

	if (coalesce(nr_seq_simp_preco_w,0) > 0) then
		select	max(ie_tipo_preco)
		into STRICT	ie_tipo_preco_w
		from	simpro_preco
		where	nr_sequencia = nr_seq_simp_preco_w;
	else
		open C04;
		loop
		fetch C04 into
			ie_tipo_preco_w;
		EXIT WHEN NOT FOUND; /* apply on C04 */
			begin
			ie_tipo_preco_w:= ie_tipo_preco_w;
			end;
		end loop;
		close C04;
	end if;

	if (coalesce(nr_seq_conv_simp_w,0) > 0) then
		select  max(CASE WHEN ie_tipo_preco='F' THEN  coalesce(tx_simpro_pfb_w, tx_preco_fabrica) WHEN ie_tipo_preco='V' THEN  coalesce(tx_simpro_pmc_w, tx_pmc)  ELSE coalesce(tx_simpro_pfb_w, tx_preco_fabrica) END )
		into STRICT	tx_indice_w
		from	convenio_simpro
		where	nr_sequencia = nr_seq_conv_simp_w;
	else
		open C05;
		loop
		fetch C05 into
			tx_indice_w;
		EXIT WHEN NOT FOUND; /* apply on C05 */
			begin
			tx_indice_w:= tx_indice_w;
			end;
		end loop;
		close C05;
	end if;

end if;

return	tx_indice_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_indice_preco_material (nr_sequencia_p bigint) FROM PUBLIC;

