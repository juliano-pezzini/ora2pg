-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_permissao_ass_med ( nm_usuario_resp_p text, nm_usuario_assinat_p text, ie_apres_mensagem_p text default 'N') RETURNS varchar AS $body$
DECLARE


ds_retorno_w			varchar(1) := 'N';
cd_medico_w				usuario.cd_pessoa_fisica%type;
cd_medico_subst_w		usuario.cd_pessoa_fisica%type;


BEGIN

if (nm_usuario_resp_p <> nm_usuario_assinat_p) then
	cd_medico_w := obter_pessoa_fisica_usuario(nm_usuario_resp_p, 'C');
	cd_medico_subst_w := obter_pessoa_fisica_usuario(nm_usuario_assinat_p, 'C');
	
	begin
		select 	'S'
		into STRICT	ds_retorno_w
		from 	medico_carta_medica a, medico_carta_medica_permit b
		where 	a.nr_sequencia = b.nr_seq_medico_carta_medica
		and   	a.cd_medico = cd_medico_w
		and   	b.cd_medico = cd_medico_subst_w		
		and		b.ie_situacao = 'A'
		and 	(b.dt_liberacao IS NOT NULL AND b.dt_liberacao::text <> '')
		and    	(((dt_inicio IS NOT NULL AND dt_inicio::text <> '') and (dt_fim IS NOT NULL AND dt_fim::text <> '') and clock_timestamp() between dt_inicio and dt_fim) or coalesce(dt_inicio::text, '') = '' and coalesce(dt_fim::text, '') = '');
	exception
	when others then
		ds_retorno_w := 'N';
	end;

    if (ds_retorno_w <> 'S') then
        ds_retorno_w := ml_obter_permissao_ass_substit(nm_usuario_resp_p, nm_usuario_assinat_p);
    end if;
else
	ds_retorno_w := 'S';
end if;

if (ie_apres_mensagem_p = 'S' and
	ds_retorno_w = 'N') then
	CALL Wheb_mensagem_pck.exibir_mensagem_abort(1043476,'USER=' || Obter_Nome_Usuario(nm_usuario_resp_p));
end if;	

return	ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_permissao_ass_med ( nm_usuario_resp_p text, nm_usuario_assinat_p text, ie_apres_mensagem_p text default 'N') FROM PUBLIC;

