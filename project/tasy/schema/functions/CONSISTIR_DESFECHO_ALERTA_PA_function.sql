-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION consistir_desfecho_alerta_pa (nr_atendimento_p bigint) RETURNS varchar AS $body$
DECLARE


cd_estabelecimento_w smallint;
cd_setor_atendimento_w setor_atendimento.cd_setor_atendimento%type;
ie_alerta_w varchar(1) := 'S';
ie_consistencia_w varchar(1);
ie_clinica_w integer;
ie_cursor_alerta_w varchar(1);


C01 CURSOR FOR
	SELECT	coalesce(max('S'),'N')
	from	consistencia_desfecho
	where	cd_estabelecimento	= cd_estabelecimento_w
	and coalesce(ie_clinica,ie_clinica_w) =  ie_clinica_w
	and	coalesce(cd_setor_atendimento,cd_setor_atendimento_w) = cd_setor_atendimento_w
	and coalesce(cd_perfil,obter_perfil_ativo) = obter_perfil_ativo
    and obter_se_alerta_desfecho(NR_SEQUENCIA, nr_atendimento_p) = 'S';



BEGIN



    select	max(cd_estabelecimento),
    max(coalesce(Obter_Setor_Atendimento(nr_atendimento),0))
    into STRICT	cd_estabelecimento_w,
		    cd_setor_atendimento_w
    from	atendimento_paciente
    where	nr_atendimento	= nr_atendimento_p;


    select coalesce(max(ie_clinica),0)
    into STRICT    ie_clinica_w
    from    atendimento_paciente
    where	nr_atendimento = nr_atendimento_p;

    select	coalesce(max('S'),'N')
    into STRICT ie_consistencia_w
	from	consistencia_desfecho
	where	cd_estabelecimento	= cd_estabelecimento_w
	and coalesce(ie_clinica,ie_clinica_w) =  ie_clinica_w
	and	coalesce(cd_setor_atendimento,cd_setor_atendimento_w) = cd_setor_atendimento_w
	and coalesce(cd_perfil,obter_perfil_ativo) = obter_perfil_ativo;


    if (ie_consistencia_w = 'S') then 
  
    open C01;
        loop
        fetch C01 into	
            ie_cursor_alerta_w;
    EXIT WHEN NOT FOUND; /* apply on C01 */
    ie_alerta_w := ie_cursor_alerta_w;
    end loop;
    close C01;
    ie_alerta_w := ie_cursor_alerta_w;


    end if;

return ie_alerta_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION consistir_desfecho_alerta_pa (nr_atendimento_p bigint) FROM PUBLIC;

