-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION lab_obter_desc_status ( nr_seq_resultado_p bigint, nr_seq_exame_p bigint, nr_sequencia_p bigint) RETURNS varchar AS $body$
DECLARE


ds_retorno_w	varchar(255);
nr_status_w 	integer;
qt_regra_w 	integer;


BEGIN

if 	(nr_seq_resultado_p IS NOT NULL AND nr_seq_resultado_p::text <> '' AND nr_sequencia_p IS NOT NULL AND nr_sequencia_p::text <> '') then

	SELECT 	max(a.ie_status_atend)
	INTO STRICT 	nr_status_w
	FROM 	prescr_procedimento a,
			exame_lab_result_item b,
			exame_lab_resultado c
	WHERE 	a.nr_sequencia = b.nr_seq_prescr
	AND		c.nr_seq_resultado = b.nr_seq_resultado
	AND		a.nr_prescricao = c.nr_prescricao
	AND		(b.nr_seq_material IS NOT NULL AND b.nr_seq_material::text <> '')
	and 	b.nr_sequencia = nr_sequencia_p
	and 	b.nr_seq_resultado = nr_seq_resultado_p;

	if (nr_status_w IS NOT NULL AND nr_status_w::text <> '') then

		SELECT 	count(*)
		into STRICT 	qt_regra_w
		FROM 	regra_exame_status w
		WHERE 	w.ie_status_regra = nr_status_w
		and 	coalesce(w.ie_situacao, 'A') = 'A';

		if (qt_regra_w > 0) then
			select Obter_Valor_Dominio_Status_LIS(nr_status_w)
			into STRICT ds_retorno_w
			;
		else
			ds_retorno_w := 'N';
		end if;

	end if;

	if (ds_retorno_w = 'N')	then

		select 	substr(obter_status_exame_result(nr_seq_resultado_p,nr_seq_exame_p,nr_sequencia_p),1,100)
		into STRICT	ds_retorno_w
		;

	end if;

end if;

return	ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION lab_obter_desc_status ( nr_seq_resultado_p bigint, nr_seq_exame_p bigint, nr_sequencia_p bigint) FROM PUBLIC;

