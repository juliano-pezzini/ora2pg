-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_qt_solucao_diluente (ie_proporcao_dil_p text, cd_material_dil_p bigint, qt_diluente_p bigint, cd_unid_med_diluente_p text, qt_ref_diluente_p bigint, qt_dose_medic_p bigint, cd_unidade_medida_dose_p text, cd_material_p bigint, ie_via_aplicacao_p text, cd_pessoa_fisica_p text, nr_atendimento_p bigint, ie_subtrair_volume_medic_p text, ie_ConsisteDoseConsumoMedic_p text, cd_diluente_red_p bigint, qt_solucao_red_p bigint, cd_unid_med_dil_red_p text, qt_volume_medic_p bigint, cd_estabelecimento_p bigint, cd_mat_recons_p bigint, qt_dose_recons_p bigint, cd_unid_med_dose_recons_p text, ie_alterou_dose_p text) RETURNS bigint AS $body$
DECLARE


qt_diluente_w					cpoe_material.qt_dose%type;
qt_dose_medic_w					cpoe_material.qt_dose%type;
qt_dose_medic_ml_w				cpoe_material.qt_dose%type;
qt_dose_ml_item_w				cpoe_material.qt_dose%type;
qt_unitaria_medic_w				cpoe_material.qt_dose%type;
qt_ml_total_item_w				cpoe_material.qt_dose%type;
qt_dose_aux_w					cpoe_material.qt_dose%type;
qt_dose_ref_w					cpoe_material.qt_dose%type;
qt_conv_ml_w					cpoe_material.qt_dose%type;
qt_conversao_ml_w				cpoe_material.qt_dose%type;
qt_dose_mat_w					cpoe_material.qt_dose%type;
qt_conversao_ml_ret_w			cpoe_material.qt_dose%type;
qt_volume_medic_convertido_w	cpoe_material.qt_dose%type;
qt_conversao_ml_dil_w			cpoe_material.qt_dose%type;
qt_dose_dil_w					cpoe_material.qt_dose%type;
qt_solucao_dil_w				cpoe_material.qt_dose%type;
cd_unidade_medida_consumo_w		material.cd_unidade_medida_consumo%type;
qt_ref_diluente_aux_w			material_diluicao.qt_referencia%type;
qt_ref_ml_dil_w					material_diluicao.qt_referencia%type;
qt_vol_adic_reconst_w			material_diluicao.qt_volume_adic%type;
cd_unid_med_diluente_w			material_diluicao.cd_unid_med_diluente%type;
qt_conversao_w					material_conversao_unidade.qt_conversao%type;
cd_unid_med_dose_mat_w			material_conversao_unidade.cd_unidade_medida%type;
cd_estabelecimento_w			estabelecimento.cd_estabelecimento%type;
nr_seq_agrupamento_w			setor_atendimento.nr_seq_agrupamento%type;
cd_setor_atendimento_w			setor_atendimento.cd_setor_atendimento%type;
cd_setor_atendimento_ww			setor_atendimento.cd_setor_atendimento%type;
qt_idade_w						double precision;
qt_peso_w						pessoa_fisica.qt_peso%type;
ie_param_REP_42_w				varchar(1);
ie_param_REP_136_w				varchar(1);


BEGIN

	qt_diluente_w := qt_diluente_p;
	cd_unid_med_diluente_w := coalesce(cd_unid_med_diluente_p, obter_unid_med_usua('ml'));

	if (ie_proporcao_dil_p = 'F') then

		qt_diluente_w := coalesce(obter_conversao_ml(cd_material_dil_p, qt_diluente_w, cd_unid_med_diluente_w),0);

	elsif (ie_proporcao_dil_p = 'SC') or (ie_proporcao_dil_p = 'ST') and (coalesce(qt_ref_diluente_p,0) > 0) then

		qt_ref_diluente_aux_w := qt_ref_diluente_p;

		qt_dose_medic_w := qt_dose_medic_p;

		qt_dose_medic_ml_w := qt_dose_medic_w;

		qt_dose_ml_item_w := coalesce(cpoe_obter_conversao_ml(cd_material_p, qt_dose_medic_ml_w, cd_unidade_medida_dose_p, ie_via_aplicacao_p, cd_pessoa_fisica_p, nr_atendimento_p),0);

		if (upper(cd_unid_med_diluente_w) <> upper(obter_unid_med_usua('ml'))) then
			qt_ref_ml_dil_w	:= coalesce(obter_conversao_ml(cd_material_dil_p, qt_ref_diluente_aux_w, cd_unid_med_diluente_w),0);
		else
			qt_ref_ml_dil_w := qt_ref_diluente_aux_w;
		end if;

		select	coalesce(max(qt_conversao),1)
		into STRICT	qt_conversao_w
		from	material_conversao_unidade
		where	cd_unidade_medida = cd_unidade_medida_dose_p
		and		cd_material = cd_material_p;

		qt_unitaria_medic_w := dividir_sem_round(qt_dose_medic_w, qt_conversao_w);

		qt_ml_total_item_w := (qt_unitaria_medic_w * qt_ref_ml_dil_w);

		if ((qt_ml_total_item_w - qt_dose_ml_item_w) > 0) and (coalesce(ie_subtrair_volume_medic_p,'N') = 'S') then
			qt_diluente_w := qt_ml_total_item_w - qt_dose_ml_item_w;

		elsif ((qt_ml_total_item_w - qt_dose_ml_item_w) > 0) then
			qt_diluente_w := qt_ml_total_item_w;
		else
			if (ie_proporcao_dil_p in ('SC','ST')) then
				if (ie_ConsisteDoseConsumoMedic_p = 'S') then
					qt_diluente_w := ceil(qt_dose_medic_ml_w) * qt_ref_ml_dil_w;
				else
					qt_diluente_w := qt_dose_medic_ml_w * qt_ref_ml_dil_w;
				end if;

				if (ie_proporcao_dil_p = 'ST') then
					qt_dose_aux_w := obter_conversao_unid_med_cons(cd_material_p, cd_unidade_medida_dose_p, qt_dose_medic_w);
				end if;
			end if;
		end if;
	end if;

	if (ie_subtrair_volume_medic_p = 'S') and (ie_proporcao_dil_p = 'F') then

		select	max(cd_unidade_medida_consumo)
		into STRICT	cd_unidade_medida_consumo_w
		from	material
		where	cd_material = cd_material_p;

		qt_peso_w := coalesce(obter_ultimo_sinal_vital_pf(cd_pessoa_fisica_p,'PESO'),coalesce(obter_peso_pf(cd_pessoa_fisica_p),0));

		if (coalesce(nr_atendimento_p::text, '') = '') then
			qt_idade_w := obter_idade_pf(cd_pessoa_fisica_p, clock_timestamp(), 'DIA');
			cd_setor_atendimento_w := null;
			cd_estabelecimento_w := cd_estabelecimento_p;
		else
			select	max(obter_setor_atendimento(c.nr_atendimento)),
					max(c.cd_estabelecimento),
					max(substr(obter_idade(b.dt_nascimento,coalesce(b.dt_obito,clock_timestamp()),'DIA'),1,5))
			into STRICT	cd_setor_atendimento_ww,
					cd_estabelecimento_w,
					qt_idade_w
			from	pessoa_fisica b,
					atendimento_paciente c
			where	c.cd_pessoa_fisica = b.cd_pessoa_fisica
			and		c.nr_atendimento = nr_atendimento_p;

			ie_param_REP_42_w := obter_param_usuario(924, 42, obter_perfil_ativo, wheb_usuario_pck.get_nm_usuario, cd_estabelecimento_w, ie_param_REP_42_w);
			ie_param_REP_136_w := obter_param_usuario(924, 136, obter_perfil_ativo, wheb_usuario_pck.get_nm_usuario, cd_estabelecimento_w, ie_param_REP_136_w);
			cd_setor_atendimento_w := cpoe_obter_setor_prescricao(ie_param_REP_42_w, ie_param_REP_136_w, wheb_usuario_pck.get_cd_setor_atendimento, nr_atendimento_p, obter_perfil_ativo, wheb_usuario_pck.get_nm_usuario, cd_setor_atendimento_w);

			if (coalesce(cd_setor_atendimento_w::text, '') = '') then
				cd_setor_atendimento_w := cd_setor_atendimento_ww;
			end if;
		end if;

		select	max(nr_seq_agrupamento)
		into STRICT	nr_seq_agrupamento_w
		from	setor_atendimento
		where	cd_setor_atendimento = cd_setor_atendimento_w;

		select	max(qt_volume_adic)
		into STRICT	qt_vol_adic_reconst_w
		from	material_diluicao
		where	qt_idade_w between obter_idade_diluicao(cd_material,nr_sequencia,'MIN') and obter_idade_diluicao(cd_material,nr_sequencia,'MAX')
		and		qt_peso_w between coalesce(qt_peso_min,0) and coalesce(qt_peso_max,999)
		and		((ie_via_excluir <> ie_via_aplicacao_p)	or (coalesce(ie_via_excluir::text, '') = ''))
		and		((nr_seq_agrupamento = nr_seq_agrupamento_w) or (coalesce(nr_seq_agrupamento::text, '') = ''))
		and		((ie_via_aplicacao = ie_via_aplicacao_p) or (coalesce(ie_via_aplicacao::text, '') = ''))
		and		coalesce(cd_perfil,coalesce(obter_perfil_ativo,0)) = coalesce(obter_perfil_ativo,0)
		and		((cd_estabelecimento = cd_estabelecimento_w) or (coalesce(cd_estabelecimento::text, '') = ''))
		and		obter_se_material_ativo(cd_diluente) = 'A'
		and		(qt_volume IS NOT NULL AND qt_volume::text <> '')
		and		ie_reconstituicao = 'R'
		and		ie_gerar_rediluente	= 'S'
		and		cd_material	= cd_material_p
		and		cd_diluente = cd_material_dil_p
		and		coalesce(qt_diluicao,coalesce(qt_diluente_p,0)) = coalesce(qt_diluente_p,0)
		and		cd_unid_med_diluente = cd_unid_med_diluente_p;

		qt_dose_ref_w := obter_dose_convertida(cd_material_p, qt_dose_medic_w, cd_unidade_medida_dose_p, cd_unidade_medida_consumo_w);
		qt_conv_ml_w := obter_conversao_ml(cd_diluente_red_p, qt_solucao_red_p, cd_unid_med_dil_red_p) + qt_vol_adic_reconst_w;
		qt_conversao_ml_w := 0;

		if (ie_ConsisteDoseConsumoMedic_p = 'N') then
			
			if (coalesce(qt_volume_medic_p,0) > 0) then
				qt_conversao_ml_w := qt_volume_medic_p;
			else
				qt_conversao_ml_w := obter_conversao_ml(cd_material_p,qt_dose_medic_w,cd_unidade_medida_dose_p);
			end if;

			cd_unid_med_dose_mat_w := cd_unidade_medida_dose_p;
			qt_dose_mat_w := qt_dose_medic_w;
		else
			qt_conversao_ml_w := obter_conversao_ml(cd_material_p,qt_dose_medic_w, cd_unidade_medida_dose_p);
			cd_unid_med_dose_mat_w := substr(obter_dados_material_estab(cd_material_p, cd_estabelecimento_w, 'UMS'),1,30);
			qt_dose_mat_w := ceil(qt_unitaria_medic_w);
		end if;

		if (cd_mat_recons_p IS NOT NULL AND cd_mat_recons_p::text <> '') and (qt_dose_recons_p IS NOT NULL AND qt_dose_recons_p::text <> '') and (cd_unid_med_dose_recons_p IS NOT NULL AND cd_unid_med_dose_recons_p::text <> '') then

			if (upper(cd_unid_med_dose_mat_w) <> upper(obter_unid_med_usua('ml'))) then
				qt_conv_ml_w := coalesce(cpoe_obter_conversao_ml(cd_material_p, qt_dose_medic_w, cd_unidade_medida_dose_p, ie_via_aplicacao_p, cd_pessoa_fisica_p, nr_atendimento_p),0);
			else
				qt_conv_ml_w := qt_conversao_ml_w;
			end if;
		else
			qt_conv_ml_w := qt_conversao_ml_w;
		end if;

		qt_conversao_ml_ret_w := qt_conv_ml_w;

		select	coalesce(obter_dose_convertida(cd_mat_recons_p, CASE WHEN coalesce(ie_proporcao_dil_p,'F')='F' THEN  qt_diluente_w  ELSE qt_dose_ref_w * qt_ref_diluente_p END ,cd_unidade_medida_dose_p, cd_unidade_medida_dose_p),0)
		into STRICT	qt_volume_medic_convertido_w
		;

		select	coalesce(obter_conversao_ml(cd_material_dil_p, CASE WHEN coalesce(qt_volume_medic_convertido_w,0)=0 THEN qt_diluente_w  ELSE qt_volume_medic_convertido_w END , upper(obter_unid_med_usua('ml'))),0)
		into STRICT	qt_conversao_ml_dil_w
		;

		if (coalesce(ie_alterou_dose_p,'N') = 'S') and (qt_dose_ml_item_w > 0) then
			qt_conversao_ml_ret_w := qt_dose_ml_item_w;
		end if;
		
		if ((qt_conversao_ml_dil_w - qt_conversao_ml_ret_w) > 0) then							
			qt_dose_dil_w := qt_conversao_ml_dil_w - qt_conversao_ml_ret_w;
		end if;	
	end if;

	if (coalesce(qt_dose_dil_w,0) > 0) then
		qt_solucao_dil_w := qt_dose_dil_w;
	else
		qt_solucao_dil_w := qt_diluente_w;
	end if;

return qt_solucao_dil_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_qt_solucao_diluente (ie_proporcao_dil_p text, cd_material_dil_p bigint, qt_diluente_p bigint, cd_unid_med_diluente_p text, qt_ref_diluente_p bigint, qt_dose_medic_p bigint, cd_unidade_medida_dose_p text, cd_material_p bigint, ie_via_aplicacao_p text, cd_pessoa_fisica_p text, nr_atendimento_p bigint, ie_subtrair_volume_medic_p text, ie_ConsisteDoseConsumoMedic_p text, cd_diluente_red_p bigint, qt_solucao_red_p bigint, cd_unid_med_dil_red_p text, qt_volume_medic_p bigint, cd_estabelecimento_p bigint, cd_mat_recons_p bigint, qt_dose_recons_p bigint, cd_unid_med_dose_recons_p text, ie_alterou_dose_p text) FROM PUBLIC;

