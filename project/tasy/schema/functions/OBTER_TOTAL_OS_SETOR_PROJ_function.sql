-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_total_os_setor_proj ( NR_SEQ_PROJ_CRON_ETAPA_P bigint, IE_ESTAGIO_P text, NR_GRUPO_DES_P bigint, IE_COMP_GRUPO_P text, IE_ADERENCIA_P text DEFAULT '0', DT_CORTE_P timestamp DEFAULT clock_timestamp() + interval '1 days') RETURNS bigint AS $body$
DECLARE

 PR_RETORNO_W	bigint := 0;

 OS_ADERENCIA_1 bigint := -1;
 OS_ADERENCIA_2 bigint := -1;
 OS_ADERENCIA_3 bigint := -1;
 OS_ADERENCIA_4 bigint := -1;
 OS_ADERENCIA_5 bigint := -1;

BEGIN

  IF IE_ADERENCIA_P = '0' THEN
    SELECT coalesce(OBTER_OS_ADERENCIA_PROJ(NR_SEQ_PROJ_CRON_ETAPA_P, '1'), -1) INTO STRICT OS_ADERENCIA_1;
    SELECT coalesce(OBTER_OS_ADERENCIA_PROJ(NR_SEQ_PROJ_CRON_ETAPA_P, '2'), -1) INTO STRICT OS_ADERENCIA_2;
    SELECT coalesce(OBTER_OS_ADERENCIA_PROJ(NR_SEQ_PROJ_CRON_ETAPA_P, '3'), -1) INTO STRICT OS_ADERENCIA_3;
    SELECT coalesce(OBTER_OS_ADERENCIA_PROJ(NR_SEQ_PROJ_CRON_ETAPA_P, '4'), -1) INTO STRICT OS_ADERENCIA_4;
    SELECT coalesce(OBTER_OS_ADERENCIA_PROJ(NR_SEQ_PROJ_CRON_ETAPA_P, '5'), -1) INTO STRICT OS_ADERENCIA_5;
  ELSE
    SELECT coalesce(OBTER_OS_ADERENCIA_PROJ(NR_SEQ_PROJ_CRON_ETAPA_P, IE_ADERENCIA_P), -1) INTO STRICT OS_ADERENCIA_1;
  END IF;

  IF IE_ESTAGIO_P = 'D' THEN --Development
    IF (TRUNC(DT_CORTE_P) >= TRUNC(clock_timestamp())) THEN
      BEGIN
        SELECT COUNT(1)
          INTO STRICT PR_RETORNO_W
          FROM MAN_ORDEM_SERVICO OS
         WHERE OS.NR_SEQ_ORIGEM IN (OS_ADERENCIA_1, OS_ADERENCIA_2, OS_ADERENCIA_3, OS_ADERENCIA_4, OS_ADERENCIA_5)
           AND ((IE_COMP_GRUPO_P = 'I' AND OS.NR_SEQ_GRUPO_DES = NR_GRUPO_DES_P) OR (IE_COMP_GRUPO_P = 'E' AND OS.NR_SEQ_GRUPO_DES <> NR_GRUPO_DES_P))
           AND OS.NR_SEQ_ESTAGIO NOT IN (SELECT 9 NR_SEQ_ESTAGIO
UNION

                                         SELECT NR_SEQ_ESTAGIO   FROM VW_ESTAGIOS_TESTE 
UNION

                                         SELECT NR_SEQ_ESTAGIO   FROM VW_ESTAGIOS_TESTE_VERSAO);
	    EXCEPTION
	    	WHEN no_data_found THEN
	    		PR_RETORNO_W := 0;
	    	WHEN OTHERS THEN
	  	  	PR_RETORNO_W := 0;
  	  END;
    ELSE
      BEGIN
        SELECT COUNT(1)
          INTO STRICT PR_RETORNO_W
          FROM MAN_ORDEM_SERVICO OS
         WHERE OS.NR_SEQ_ORIGEM IN (OS_ADERENCIA_1, OS_ADERENCIA_2, OS_ADERENCIA_3, OS_ADERENCIA_4, OS_ADERENCIA_5)
           AND ((IE_COMP_GRUPO_P = 'I' AND OS.NR_SEQ_GRUPO_DES = NR_GRUPO_DES_P) OR (IE_COMP_GRUPO_P = 'E' AND OS.NR_SEQ_GRUPO_DES <> NR_GRUPO_DES_P))
           AND MAN_OBTER_ESTAGIO_DATA(OS.NR_SEQUENCIA, DT_CORTE_P) NOT IN (SELECT 9 NR_SEQ_ESTAGIO
UNION

                                                                           SELECT NR_SEQ_ESTAGIO   FROM VW_ESTAGIOS_TESTE 
UNION

                                                                           SELECT NR_SEQ_ESTAGIO   FROM VW_ESTAGIOS_TESTE_VERSAO)
           AND TRUNC(OS.DT_ORDEM_SERVICO) <= TRUNC(DT_CORTE_P);
	    EXCEPTION
	    	WHEN no_data_found THEN
	    		PR_RETORNO_W := 0;
	    	WHEN OTHERS THEN
	  	  	PR_RETORNO_W := 0;
  	  END;
    END IF;
  ELSIF IE_ESTAGIO_P = 'V' THEN --VeV
    IF (TRUNC(DT_CORTE_P) >= TRUNC(clock_timestamp())) THEN
      BEGIN
        SELECT COUNT(1)
          INTO STRICT PR_RETORNO_W
          FROM MAN_ORDEM_SERVICO OS
         WHERE OS.NR_SEQ_ORIGEM IN (OS_ADERENCIA_1, OS_ADERENCIA_2, OS_ADERENCIA_3, OS_ADERENCIA_4, OS_ADERENCIA_5)
           AND ((IE_COMP_GRUPO_P = 'I' AND OS.NR_SEQ_GRUPO_DES = NR_GRUPO_DES_P) OR (IE_COMP_GRUPO_P = 'E' AND OS.NR_SEQ_GRUPO_DES <> NR_GRUPO_DES_P))
           AND OS.NR_SEQ_ESTAGIO IN (SELECT NR_SEQ_ESTAGIO FROM VW_ESTAGIOS_TESTE);
	    EXCEPTION
	    	WHEN no_data_found THEN
	    		PR_RETORNO_W := 0;
	    	WHEN OTHERS THEN
	    		PR_RETORNO_W := 0;
    	END;
    ELSE
      BEGIN
        SELECT COUNT(1)
          INTO STRICT PR_RETORNO_W
          FROM MAN_ORDEM_SERVICO OS
         WHERE OS.NR_SEQ_ORIGEM IN (OS_ADERENCIA_1, OS_ADERENCIA_2, OS_ADERENCIA_3, OS_ADERENCIA_4, OS_ADERENCIA_5)
           AND ((IE_COMP_GRUPO_P = 'I' AND OS.NR_SEQ_GRUPO_DES = NR_GRUPO_DES_P) OR (IE_COMP_GRUPO_P = 'E' AND OS.NR_SEQ_GRUPO_DES <> NR_GRUPO_DES_P))
           AND MAN_OBTER_ESTAGIO_DATA(OS.NR_SEQUENCIA, DT_CORTE_P) IN (SELECT NR_SEQ_ESTAGIO FROM VW_ESTAGIOS_TESTE)
           AND ((coalesce(OBTER_DATA_ENCERRAMENTO_AUT_OS(OS.NR_SEQUENCIA)::text, '') = '') OR (OBTER_DATA_ENCERRAMENTO_AUT_OS(OS.NR_SEQUENCIA) > TRUNC(DT_CORTE_P)))
           AND TRUNC(OS.DT_ORDEM_SERVICO) <= TRUNC(DT_CORTE_P);
	    EXCEPTION
	    	WHEN no_data_found THEN
	    		PR_RETORNO_W := 0;
	    	WHEN OTHERS THEN
	    		PR_RETORNO_W := 0;
    	END;
    END IF;
  ELSIF IE_ESTAGIO_P = 'VS' THEN --VeV - Ag. Versao
    IF (TRUNC(DT_CORTE_P) >= TRUNC(clock_timestamp())) THEN
      BEGIN
        SELECT COUNT(1)
          INTO STRICT PR_RETORNO_W
          FROM MAN_ORDEM_SERVICO OS
         WHERE OS.NR_SEQ_ORIGEM IN (OS_ADERENCIA_1, OS_ADERENCIA_2, OS_ADERENCIA_3, OS_ADERENCIA_4, OS_ADERENCIA_5)
           AND ((IE_COMP_GRUPO_P = 'I' AND OS.NR_SEQ_GRUPO_DES = NR_GRUPO_DES_P) OR (IE_COMP_GRUPO_P = 'E' AND OS.NR_SEQ_GRUPO_DES <> NR_GRUPO_DES_P))
           AND OS.NR_SEQ_ESTAGIO IN (SELECT NR_SEQ_ESTAGIO FROM VW_ESTAGIOS_TESTE_VERSAO);
	    EXCEPTION
	    	WHEN no_data_found THEN
	    		PR_RETORNO_W := 0;
	    	WHEN OTHERS THEN
	    		PR_RETORNO_W := 0;
    	END;
    ELSE
      BEGIN
        SELECT COUNT(1)
          INTO STRICT PR_RETORNO_W
          FROM MAN_ORDEM_SERVICO OS
         WHERE OS.NR_SEQ_ORIGEM IN (OS_ADERENCIA_1, OS_ADERENCIA_2, OS_ADERENCIA_3, OS_ADERENCIA_4, OS_ADERENCIA_5)
           AND ((IE_COMP_GRUPO_P = 'I' AND OS.NR_SEQ_GRUPO_DES = NR_GRUPO_DES_P) OR (IE_COMP_GRUPO_P = 'E' AND OS.NR_SEQ_GRUPO_DES <> NR_GRUPO_DES_P))
           AND MAN_OBTER_ESTAGIO_DATA(OS.NR_SEQUENCIA, DT_CORTE_P) IN (SELECT NR_SEQ_ESTAGIO FROM VW_ESTAGIOS_TESTE_VERSAO)
           AND TRUNC(OS.DT_ORDEM_SERVICO) <= TRUNC(DT_CORTE_P);
	    EXCEPTION
	    	WHEN no_data_found THEN
	    		PR_RETORNO_W := 0;
	    	WHEN OTHERS THEN
	    		PR_RETORNO_W := 0;
    	END;
    END IF;
  ELSIF IE_ESTAGIO_P = 'E' THEN --Closed
    IF (TRUNC(DT_CORTE_P) >= TRUNC(clock_timestamp())) THEN
      BEGIN
        SELECT COUNT(1)
          INTO STRICT PR_RETORNO_W
          FROM MAN_ORDEM_SERVICO OS
         WHERE OS.NR_SEQ_ORIGEM IN (OS_ADERENCIA_1, OS_ADERENCIA_2, OS_ADERENCIA_3, OS_ADERENCIA_4, OS_ADERENCIA_5)
           AND ((IE_COMP_GRUPO_P = 'I' AND OS.NR_SEQ_GRUPO_DES = NR_GRUPO_DES_P) OR (IE_COMP_GRUPO_P = 'E' AND OS.NR_SEQ_GRUPO_DES <> NR_GRUPO_DES_P))
           AND OS.NR_SEQ_ESTAGIO IN (9);
	    EXCEPTION
	    	WHEN no_data_found THEN
	    		PR_RETORNO_W := 0;
	    	WHEN OTHERS THEN
	    		PR_RETORNO_W := 0;
    	END;
    ELSE
      BEGIN
        SELECT COUNT(1)
          INTO STRICT PR_RETORNO_W
          FROM MAN_ORDEM_SERVICO OS
         WHERE OS.NR_SEQ_ORIGEM IN (OS_ADERENCIA_1, OS_ADERENCIA_2, OS_ADERENCIA_3, OS_ADERENCIA_4, OS_ADERENCIA_5)
           AND ((IE_COMP_GRUPO_P = 'I' AND OS.NR_SEQ_GRUPO_DES = NR_GRUPO_DES_P) OR (IE_COMP_GRUPO_P = 'E' AND OS.NR_SEQ_GRUPO_DES <> NR_GRUPO_DES_P))
           AND ((MAN_OBTER_ESTAGIO_DATA(OS.NR_SEQUENCIA, DT_CORTE_P) IN (9)) OR
                ((MAN_OBTER_ESTAGIO_DATA(OS.NR_SEQUENCIA, DT_CORTE_P) <> 9) AND ((OBTER_DATA_ENCERRAMENTO_AUT_OS(OS.NR_SEQUENCIA) IS NOT NULL AND (OBTER_DATA_ENCERRAMENTO_AUT_OS(OS.NR_SEQUENCIA))::text <> '')) AND (TRUNC(OBTER_DATA_ENCERRAMENTO_AUT_OS(OS.NR_SEQUENCIA)) <= TRUNC(DT_CORTE_P))))
           AND TRUNC(OS.DT_ORDEM_SERVICO) <= TRUNC(DT_CORTE_P);
	    EXCEPTION
	    	WHEN no_data_found THEN
	    		PR_RETORNO_W := 0;
	    	WHEN OTHERS THEN
	    		PR_RETORNO_W := 0;
    	END;
    END IF;
  ELSIF IE_ESTAGIO_P = 'T' THEN --Total
    IF (TRUNC(DT_CORTE_P) >= TRUNC(clock_timestamp())) THEN
      BEGIN
        SELECT COUNT(1)
          INTO STRICT PR_RETORNO_W
          FROM MAN_ORDEM_SERVICO OS
         WHERE OS.NR_SEQ_ORIGEM IN (OS_ADERENCIA_1, OS_ADERENCIA_2, OS_ADERENCIA_3, OS_ADERENCIA_4, OS_ADERENCIA_5)
           AND ((IE_COMP_GRUPO_P = 'I' AND OS.NR_SEQ_GRUPO_DES = NR_GRUPO_DES_P) OR (IE_COMP_GRUPO_P = 'E' AND OS.NR_SEQ_GRUPO_DES <> NR_GRUPO_DES_P));
	    EXCEPTION
	    	WHEN no_data_found THEN
	    		PR_RETORNO_W := 0;
	    	WHEN OTHERS THEN
	    		PR_RETORNO_W := 0;
      END;
    ELSE
      BEGIN
        SELECT COUNT(1)
          INTO STRICT PR_RETORNO_W
          FROM MAN_ORDEM_SERVICO OS
         WHERE OS.NR_SEQ_ORIGEM IN (OS_ADERENCIA_1, OS_ADERENCIA_2, OS_ADERENCIA_3, OS_ADERENCIA_4, OS_ADERENCIA_5)
           AND ((IE_COMP_GRUPO_P = 'I' AND OS.NR_SEQ_GRUPO_DES = NR_GRUPO_DES_P) OR (IE_COMP_GRUPO_P = 'E' AND OS.NR_SEQ_GRUPO_DES <> NR_GRUPO_DES_P))
           AND TRUNC(OS.DT_ORDEM_SERVICO) <= TRUNC(DT_CORTE_P);
	    EXCEPTION
	    	WHEN no_data_found THEN
	    		PR_RETORNO_W := 0;
	    	WHEN OTHERS THEN
	    		PR_RETORNO_W := 0;
      END;
    END IF;
  ELSIF IE_ESTAGIO_P = 'RP' THEN --Reprovadas
    IF (TRUNC(DT_CORTE_P) >= TRUNC(clock_timestamp())) THEN
      BEGIN
        SELECT COUNT(1)
          INTO STRICT PR_RETORNO_W
          FROM MAN_ORDEM_SERVICO OS
         WHERE OS.NR_SEQ_ORIGEM IN (OS_ADERENCIA_1, OS_ADERENCIA_2, OS_ADERENCIA_3, OS_ADERENCIA_4, OS_ADERENCIA_5)
           AND ((IE_COMP_GRUPO_P = 'I' AND OS.NR_SEQ_GRUPO_DES = NR_GRUPO_DES_P) OR (IE_COMP_GRUPO_P = 'E' AND OS.NR_SEQ_GRUPO_DES <> NR_GRUPO_DES_P))
           AND (OBTER_QTD_HIST_OS_TIPO(OS.NR_SEQUENCIA,118) > 0);
	    EXCEPTION
	    	WHEN no_data_found THEN
	    		PR_RETORNO_W := 0;
	    	WHEN OTHERS THEN
	    		PR_RETORNO_W := 0;
    	END;
    ELSE
      BEGIN
        SELECT COUNT(1)
          INTO STRICT PR_RETORNO_W
          FROM MAN_ORDEM_SERVICO OS
         WHERE OS.NR_SEQ_ORIGEM IN (OS_ADERENCIA_1, OS_ADERENCIA_2, OS_ADERENCIA_3, OS_ADERENCIA_4, OS_ADERENCIA_5)
           AND ((IE_COMP_GRUPO_P = 'I' AND OS.NR_SEQ_GRUPO_DES = NR_GRUPO_DES_P) OR (IE_COMP_GRUPO_P = 'E' AND OS.NR_SEQ_GRUPO_DES <> NR_GRUPO_DES_P))
           AND (OBTER_QTD_HIST_OS_TIPO(OS.NR_SEQUENCIA,118, DT_CORTE_P) > 0)
           AND TRUNC(OS.DT_ORDEM_SERVICO) <= TRUNC(DT_CORTE_P);
	    EXCEPTION
	    	WHEN no_data_found THEN
	    		PR_RETORNO_W := 0;
	    	WHEN OTHERS THEN
	    		PR_RETORNO_W := 0;
    	END;
    END IF;
  ELSIF IE_ESTAGIO_P = 'DR' THEN --Development ReWork
    IF (TRUNC(DT_CORTE_P) >= TRUNC(clock_timestamp())) THEN
      BEGIN
        SELECT COUNT(1)
          INTO STRICT PR_RETORNO_W
          FROM MAN_ORDEM_SERVICO OS
         WHERE OS.NR_SEQ_ORIGEM IN (OS_ADERENCIA_1, OS_ADERENCIA_2, OS_ADERENCIA_3, OS_ADERENCIA_4, OS_ADERENCIA_5)
           AND ((IE_COMP_GRUPO_P = 'I' AND OS.NR_SEQ_GRUPO_DES = NR_GRUPO_DES_P) OR (IE_COMP_GRUPO_P = 'E' AND OS.NR_SEQ_GRUPO_DES <> NR_GRUPO_DES_P))
           AND OS.NR_SEQ_ESTAGIO NOT IN (SELECT 9 NR_SEQ_ESTAGIO
UNION

                                         SELECT NR_SEQ_ESTAGIO   FROM VW_ESTAGIOS_TESTE 
UNION

                                         SELECT NR_SEQ_ESTAGIO   FROM VW_ESTAGIOS_TESTE_VERSAO)
           AND (OBTER_QTD_HIST_OS_TIPO(OS.NR_SEQUENCIA,118) > 0);
      EXCEPTION
	    	WHEN no_data_found THEN
	    		PR_RETORNO_W := 0;
	    	WHEN OTHERS THEN
	    		PR_RETORNO_W := 0;
  	  END;
    ELSE
      BEGIN
        SELECT COUNT(1)
          INTO STRICT PR_RETORNO_W
          FROM MAN_ORDEM_SERVICO OS
         WHERE OS.NR_SEQ_ORIGEM IN (OS_ADERENCIA_1, OS_ADERENCIA_2, OS_ADERENCIA_3, OS_ADERENCIA_4, OS_ADERENCIA_5)
           AND ((IE_COMP_GRUPO_P = 'I' AND OS.NR_SEQ_GRUPO_DES = NR_GRUPO_DES_P) OR (IE_COMP_GRUPO_P = 'E' AND OS.NR_SEQ_GRUPO_DES <> NR_GRUPO_DES_P))
           AND MAN_OBTER_ESTAGIO_DATA(OS.NR_SEQUENCIA, DT_CORTE_P) NOT IN (SELECT 9 NR_SEQ_ESTAGIO
UNION

                                                                           SELECT NR_SEQ_ESTAGIO   FROM VW_ESTAGIOS_TESTE 
UNION

                                                                           SELECT NR_SEQ_ESTAGIO   FROM VW_ESTAGIOS_TESTE_VERSAO)
           AND TRUNC(OS.DT_ORDEM_SERVICO) <= TRUNC(DT_CORTE_P)
           AND (OBTER_QTD_HIST_OS_TIPO(OS.NR_SEQUENCIA,118, DT_CORTE_P) > 0);
      EXCEPTION
	    	WHEN no_data_found THEN
	    		PR_RETORNO_W := 0;
	    	WHEN OTHERS THEN
	    		PR_RETORNO_W := 0;
  	  END;
    END IF;
  ELSIF IE_ESTAGIO_P = 'VR' THEN --VeV ReWork
    IF (TRUNC(DT_CORTE_P) >= TRUNC(clock_timestamp())) THEN
      BEGIN
        SELECT COUNT(1)
          INTO STRICT PR_RETORNO_W
          FROM MAN_ORDEM_SERVICO OS
         WHERE OS.NR_SEQ_ORIGEM IN (OS_ADERENCIA_1, OS_ADERENCIA_2, OS_ADERENCIA_3, OS_ADERENCIA_4, OS_ADERENCIA_5)
           AND ((IE_COMP_GRUPO_P = 'I' AND OS.NR_SEQ_GRUPO_DES = NR_GRUPO_DES_P) OR (IE_COMP_GRUPO_P = 'E' AND OS.NR_SEQ_GRUPO_DES <> NR_GRUPO_DES_P))
           AND OS.NR_SEQ_ESTAGIO IN (SELECT NR_SEQ_ESTAGIO FROM VW_ESTAGIOS_TESTE)
           AND (OBTER_QTD_HIST_OS_TIPO(OS.NR_SEQUENCIA,118) > 0);
	    EXCEPTION
	    	WHEN no_data_found THEN
	    		PR_RETORNO_W := 0;
	    	WHEN OTHERS THEN
	    		PR_RETORNO_W := 0;
    	END;
    ELSE
      BEGIN
        SELECT COUNT(1)
          INTO STRICT PR_RETORNO_W
          FROM MAN_ORDEM_SERVICO OS
         WHERE OS.NR_SEQ_ORIGEM IN (OS_ADERENCIA_1, OS_ADERENCIA_2, OS_ADERENCIA_3, OS_ADERENCIA_4, OS_ADERENCIA_5)
           AND ((IE_COMP_GRUPO_P = 'I' AND OS.NR_SEQ_GRUPO_DES = NR_GRUPO_DES_P) OR (IE_COMP_GRUPO_P = 'E' AND OS.NR_SEQ_GRUPO_DES <> NR_GRUPO_DES_P))
           AND MAN_OBTER_ESTAGIO_DATA(OS.NR_SEQUENCIA, DT_CORTE_P) IN (SELECT NR_SEQ_ESTAGIO FROM VW_ESTAGIOS_TESTE)
           AND ((coalesce(OBTER_DATA_ENCERRAMENTO_AUT_OS(OS.NR_SEQUENCIA)::text, '') = '') OR (OBTER_DATA_ENCERRAMENTO_AUT_OS(OS.NR_SEQUENCIA) > TRUNC(DT_CORTE_P)))
           AND (OBTER_QTD_HIST_OS_TIPO(OS.NR_SEQUENCIA,118, DT_CORTE_P) > 0)
           AND TRUNC(OS.DT_ORDEM_SERVICO) <= TRUNC(DT_CORTE_P);
	    EXCEPTION
	    	WHEN no_data_found THEN
	    		PR_RETORNO_W := 0;
	    	WHEN OTHERS THEN
	    		PR_RETORNO_W := 0;
    	END;
    END IF;
  ELSIF IE_ESTAGIO_P = 'VSR' THEN --VeV - Ag. Versao ReWork
    IF (TRUNC(DT_CORTE_P) >= TRUNC(clock_timestamp())) THEN
      BEGIN
        SELECT COUNT(1)
          INTO STRICT PR_RETORNO_W
          FROM MAN_ORDEM_SERVICO OS
         WHERE OS.NR_SEQ_ORIGEM IN (OS_ADERENCIA_1, OS_ADERENCIA_2, OS_ADERENCIA_3, OS_ADERENCIA_4, OS_ADERENCIA_5)
           AND ((IE_COMP_GRUPO_P = 'I' AND OS.NR_SEQ_GRUPO_DES = NR_GRUPO_DES_P) OR (IE_COMP_GRUPO_P = 'E' AND OS.NR_SEQ_GRUPO_DES <> NR_GRUPO_DES_P))
           AND OS.NR_SEQ_ESTAGIO IN (SELECT NR_SEQ_ESTAGIO FROM VW_ESTAGIOS_TESTE_VERSAO)
           AND (OBTER_QTD_HIST_OS_TIPO(OS.NR_SEQUENCIA,118) > 0);
  	  EXCEPTION
  	  	WHEN no_data_found THEN
	    		PR_RETORNO_W := 0;
	    	WHEN OTHERS THEN
	    		PR_RETORNO_W := 0;
    	END;
    ELSE
      BEGIN
        SELECT COUNT(1)
          INTO STRICT PR_RETORNO_W
          FROM MAN_ORDEM_SERVICO OS
         WHERE OS.NR_SEQ_ORIGEM IN (OS_ADERENCIA_1, OS_ADERENCIA_2, OS_ADERENCIA_3, OS_ADERENCIA_4, OS_ADERENCIA_5)
           AND ((IE_COMP_GRUPO_P = 'I' AND OS.NR_SEQ_GRUPO_DES = NR_GRUPO_DES_P) OR (IE_COMP_GRUPO_P = 'E' AND OS.NR_SEQ_GRUPO_DES <> NR_GRUPO_DES_P))
           AND MAN_OBTER_ESTAGIO_DATA(OS.NR_SEQUENCIA, DT_CORTE_P) IN (SELECT NR_SEQ_ESTAGIO FROM VW_ESTAGIOS_TESTE_VERSAO)
           AND (OBTER_QTD_HIST_OS_TIPO(OS.NR_SEQUENCIA,118, DT_CORTE_P) > 0)
           AND TRUNC(OS.DT_ORDEM_SERVICO) <= TRUNC(DT_CORTE_P);
  	  EXCEPTION
  	  	WHEN no_data_found THEN
	    		PR_RETORNO_W := 0;
	    	WHEN OTHERS THEN
	    		PR_RETORNO_W := 0;
    	END;
    END IF;
  ELSIF IE_ESTAGIO_P = 'ER' THEN --Closed ReWork
    IF (TRUNC(DT_CORTE_P) >= TRUNC(clock_timestamp())) THEN
      BEGIN
        SELECT COUNT(1)
          INTO STRICT PR_RETORNO_W
          FROM MAN_ORDEM_SERVICO OS
         WHERE OS.NR_SEQ_ORIGEM IN (OS_ADERENCIA_1, OS_ADERENCIA_2, OS_ADERENCIA_3, OS_ADERENCIA_4, OS_ADERENCIA_5)
           AND ((IE_COMP_GRUPO_P = 'I' AND OS.NR_SEQ_GRUPO_DES = NR_GRUPO_DES_P) OR (IE_COMP_GRUPO_P = 'E' AND OS.NR_SEQ_GRUPO_DES <> NR_GRUPO_DES_P))
           AND OS.NR_SEQ_ESTAGIO IN (9)
           AND (OBTER_QTD_HIST_OS_TIPO(OS.NR_SEQUENCIA,118) > 0);
	    EXCEPTION
	    	WHEN no_data_found THEN
	    		PR_RETORNO_W := 0;
	    	WHEN OTHERS THEN
	    		PR_RETORNO_W := 0;
    	END;
    ELSE
      BEGIN
        SELECT COUNT(1)
          INTO STRICT PR_RETORNO_W
          FROM MAN_ORDEM_SERVICO OS
         WHERE OS.NR_SEQ_ORIGEM IN (OS_ADERENCIA_1, OS_ADERENCIA_2, OS_ADERENCIA_3, OS_ADERENCIA_4, OS_ADERENCIA_5)
           AND ((IE_COMP_GRUPO_P = 'I' AND OS.NR_SEQ_GRUPO_DES = NR_GRUPO_DES_P) OR (IE_COMP_GRUPO_P = 'E' AND OS.NR_SEQ_GRUPO_DES <> NR_GRUPO_DES_P))
           AND ((MAN_OBTER_ESTAGIO_DATA(OS.NR_SEQUENCIA, DT_CORTE_P) IN (9)) OR
                ((MAN_OBTER_ESTAGIO_DATA(OS.NR_SEQUENCIA, DT_CORTE_P) <> 9) AND ((OBTER_DATA_ENCERRAMENTO_AUT_OS(OS.NR_SEQUENCIA) IS NOT NULL AND (OBTER_DATA_ENCERRAMENTO_AUT_OS(OS.NR_SEQUENCIA))::text <> '')) AND (TRUNC(OBTER_DATA_ENCERRAMENTO_AUT_OS(OS.NR_SEQUENCIA)) <= TRUNC(DT_CORTE_P))))
           AND TRUNC(OS.DT_ORDEM_SERVICO) <= TRUNC(DT_CORTE_P)
           AND (OBTER_QTD_HIST_OS_TIPO(OS.NR_SEQUENCIA,118, DT_CORTE_P) > 0);
	    EXCEPTION
	    	WHEN no_data_found THEN
	    		PR_RETORNO_W := 0;
	    	WHEN OTHERS THEN
	    		PR_RETORNO_W := 0;
    	END;
    END IF;
  -- STAUTS DIA
  ELSIF IE_ESTAGIO_P = 'N' THEN -- New
    IF (TRUNC(DT_CORTE_P) >= TRUNC(clock_timestamp())) THEN
      BEGIN
        SELECT COUNT(1)
          INTO STRICT PR_RETORNO_W
          FROM MAN_ORDEM_SERVICO OS
         WHERE OS.NR_SEQ_ORIGEM IN (OS_ADERENCIA_1, OS_ADERENCIA_2, OS_ADERENCIA_3, OS_ADERENCIA_4, OS_ADERENCIA_5)
           AND ((IE_COMP_GRUPO_P = 'I' AND OS.NR_SEQ_GRUPO_DES = NR_GRUPO_DES_P) OR (IE_COMP_GRUPO_P = 'E' AND OS.NR_SEQ_GRUPO_DES <> NR_GRUPO_DES_P))
           AND TRUNC(OS.DT_ORDEM_SERVICO) = TRUNC(clock_timestamp());
	    EXCEPTION
	    	WHEN no_data_found THEN
	    		PR_RETORNO_W := 0;
	    	WHEN OTHERS THEN
	    		PR_RETORNO_W := 0;
  	  END;
    ELSE
      BEGIN
        SELECT COUNT(1)
          INTO STRICT PR_RETORNO_W
          FROM MAN_ORDEM_SERVICO OS
         WHERE OS.NR_SEQ_ORIGEM IN (OS_ADERENCIA_1, OS_ADERENCIA_2, OS_ADERENCIA_3, OS_ADERENCIA_4, OS_ADERENCIA_5)
           AND ((IE_COMP_GRUPO_P = 'I' AND OS.NR_SEQ_GRUPO_DES = NR_GRUPO_DES_P) OR (IE_COMP_GRUPO_P = 'E' AND OS.NR_SEQ_GRUPO_DES <> NR_GRUPO_DES_P))
           AND TRUNC(OS.DT_ORDEM_SERVICO) = TRUNC(DT_CORTE_P);
	    EXCEPTION
	    	WHEN no_data_found THEN
	    		PR_RETORNO_W := 0;
	    	WHEN OTHERS THEN
	    		PR_RETORNO_W := 0;
  	  END;
    END IF;
  ELSIF IE_ESTAGIO_P = 'VSD' THEN --VeV - Ag. Versao por data
    IF (TRUNC(DT_CORTE_P) >= TRUNC(clock_timestamp())) THEN
      BEGIN
        SELECT COUNT(1)
          INTO STRICT PR_RETORNO_W
          FROM MAN_ORDEM_SERVICO OS
         WHERE OS.NR_SEQ_ORIGEM IN (OS_ADERENCIA_1, OS_ADERENCIA_2, OS_ADERENCIA_3, OS_ADERENCIA_4, OS_ADERENCIA_5)
           AND ((IE_COMP_GRUPO_P = 'I' AND OS.NR_SEQ_GRUPO_DES = NR_GRUPO_DES_P) OR (IE_COMP_GRUPO_P = 'E' AND OS.NR_SEQ_GRUPO_DES <> NR_GRUPO_DES_P))
           AND OS.NR_SEQ_ESTAGIO IN (SELECT VW.NR_SEQ_ESTAGIO FROM VW_ESTAGIOS_TESTE_VERSAO VW)
           AND EXISTS (SELECT 1
                         FROM MAN_ORDEM_SERV_ESTAGIO ES
                        WHERE OS.NR_SEQUENCIA   = ES.NR_SEQ_ORDEM
                          AND ES.NR_SEQ_ESTAGIO = OS.NR_SEQ_ESTAGIO
                          AND TRUNC(ES.DT_ATUALIZACAO) = TRUNC(clock_timestamp()));
	    EXCEPTION
	    	WHEN no_data_found THEN
	    		PR_RETORNO_W := 0;
	    	WHEN OTHERS THEN
	    		PR_RETORNO_W := 0;
  	  END;
    ELSE
      BEGIN
        SELECT COUNT(1)
          INTO STRICT PR_RETORNO_W
          FROM MAN_ORDEM_SERVICO OS
         WHERE OS.NR_SEQ_ORIGEM IN (OS_ADERENCIA_1, OS_ADERENCIA_2, OS_ADERENCIA_3, OS_ADERENCIA_4, OS_ADERENCIA_5)
           AND ((IE_COMP_GRUPO_P = 'I' AND OS.NR_SEQ_GRUPO_DES = NR_GRUPO_DES_P) OR (IE_COMP_GRUPO_P = 'E' AND OS.NR_SEQ_GRUPO_DES <> NR_GRUPO_DES_P))
           AND MAN_OBTER_ESTAGIO_DATA(OS.NR_SEQUENCIA, DT_CORTE_P) IN (SELECT VW.NR_SEQ_ESTAGIO FROM VW_ESTAGIOS_TESTE_VERSAO VW)
           AND TRUNC(OS.DT_ORDEM_SERVICO) <= TRUNC(DT_CORTE_P)
           AND EXISTS (SELECT 1
                         FROM MAN_ORDEM_SERV_ESTAGIO ES
                        WHERE OS.NR_SEQUENCIA = ES.NR_SEQ_ORDEM
                          AND ES.NR_SEQ_ESTAGIO = MAN_OBTER_ESTAGIO_DATA(OS.NR_SEQUENCIA, DT_CORTE_P)
                          AND TRUNC(ES.DT_ATUALIZACAO) = TRUNC(DT_CORTE_P));
	    EXCEPTION
	    	WHEN no_data_found THEN
	    		PR_RETORNO_W := 0;
	    	WHEN OTHERS THEN
	    		PR_RETORNO_W := 0;
  	  END;
    END IF;
  ELSIF IE_ESTAGIO_P = 'RJ' THEN --Rejected (Doubt)
    IF (TRUNC(DT_CORTE_P) >= TRUNC(clock_timestamp())) THEN
      BEGIN
        SELECT COUNT(1)
          INTO STRICT PR_RETORNO_W
          FROM MAN_ORDEM_SERVICO OS
         WHERE OS.NR_SEQ_ORIGEM IN (OS_ADERENCIA_1, OS_ADERENCIA_2, OS_ADERENCIA_3, OS_ADERENCIA_4, OS_ADERENCIA_5)
           AND ((IE_COMP_GRUPO_P = 'I' AND OS.NR_SEQ_GRUPO_DES = NR_GRUPO_DES_P) OR (IE_COMP_GRUPO_P = 'E' AND OS.NR_SEQ_GRUPO_DES <> NR_GRUPO_DES_P))
           AND IE_CLASSIFICACAO = 'D';
	    EXCEPTION
	    	WHEN no_data_found THEN
	    		PR_RETORNO_W := 0;
	    	WHEN OTHERS THEN
	    		PR_RETORNO_W := 0;
  	  END;
    ELSE
      BEGIN
        SELECT COUNT(1)
          INTO STRICT PR_RETORNO_W
          FROM MAN_ORDEM_SERVICO OS
         WHERE OS.NR_SEQ_ORIGEM IN (OS_ADERENCIA_1, OS_ADERENCIA_2, OS_ADERENCIA_3, OS_ADERENCIA_4, OS_ADERENCIA_5)
           AND ((IE_COMP_GRUPO_P = 'I' AND OS.NR_SEQ_GRUPO_DES = NR_GRUPO_DES_P) OR (IE_COMP_GRUPO_P = 'E' AND OS.NR_SEQ_GRUPO_DES <> NR_GRUPO_DES_P))
           AND IE_CLASSIFICACAO = 'D'
           AND TRUNC(OS.DT_ORDEM_SERVICO) <= TRUNC(DT_CORTE_P);
	    EXCEPTION
	    	WHEN no_data_found THEN
	    		PR_RETORNO_W := 0;
	    	WHEN OTHERS THEN
	    		PR_RETORNO_W := 0;
  	  END;
    END IF;
  END IF;

RETURN	PR_RETORNO_W;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_total_os_setor_proj ( NR_SEQ_PROJ_CRON_ETAPA_P bigint, IE_ESTAGIO_P text, NR_GRUPO_DES_P bigint, IE_COMP_GRUPO_P text, IE_ADERENCIA_P text DEFAULT '0', DT_CORTE_P timestamp DEFAULT clock_timestamp() + interval '1 days') FROM PUBLIC;

