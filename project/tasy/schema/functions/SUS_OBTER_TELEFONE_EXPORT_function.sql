-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION sus_obter_telefone_export ( cd_pessoa_fisica_p text) RETURNS varchar AS $body$
DECLARE


ds_retorno_w		varchar(11) := '00000000000';
nr_ddd_celular_w		varchar(3);
nr_telefone_celular_w	varchar(40);
nr_ddd_telefone_w		varchar(3);
nr_telefone_w		varchar(15);
ie_ordem_telefone_pac_w	varchar(15) := 'TC';
cd_estabelecimento_w	integer := coalesce(wheb_usuario_pck.get_cd_estabelecimento,0);


BEGIN

begin
select	coalesce(max(ie_ordem_telefone_pac),'TC')
into STRICT	ie_ordem_telefone_pac_w
from	sus_parametros_aih
where	cd_estabelecimento = cd_estabelecimento_w;
exception
when others then
	ie_ordem_telefone_pac_w := 'TC';
end;

select	max(somente_numero(a.nr_ddd_celular)),
	max(somente_numero(a.nr_telefone_celular)),
	max(somente_numero(b.nr_ddd_telefone)),
	max(somente_numero(b.nr_telefone))
into STRICT	nr_ddd_celular_w,
	nr_telefone_celular_w,
	nr_ddd_telefone_w,
	nr_telefone_w
from	pessoa_fisica a,
	compl_pessoa_fisica b
where	a.cd_pessoa_fisica = b.cd_pessoa_fisica
and	b.ie_tipo_complemento = 1
and	a.cd_pessoa_fisica = cd_pessoa_fisica_p;

if (coalesce(ie_ordem_telefone_pac_w,'TC') = 'TC') then
	begin
	if (coalesce(nr_telefone_w,'0') <> '0') then
		begin
		if (length(nr_telefone_w) = 11) then
			ds_retorno_w := substr(nr_telefone_w,1,11);
		elsif (length(nr_telefone_w) = 10) then
			ds_retorno_w := substr(substr(nr_telefone_w,1,2)||'0'||substr(nr_telefone_w,3,8),1,11);
		elsif (length(nr_telefone_w) < 10) then
			ds_retorno_w := lpad(substr(substr(nr_ddd_telefone_w,1,2)||lpad(substr(nr_telefone_w,1,9),9,'0'),1,11),11,'0');
		end if;
		end;
	elsif (coalesce(nr_telefone_celular_w,'0') <> '0') then
		begin
		if (length(nr_telefone_celular_w) = 11) then
			ds_retorno_w := substr(nr_telefone_celular_w,1,11);
		elsif (length(nr_telefone_celular_w) = 10) then
			ds_retorno_w := substr(substr(nr_telefone_celular_w,1,2)||'0'||substr(nr_telefone_celular_w,3,8),1,11);
		elsif (length(nr_telefone_celular_w) < 10) then
			ds_retorno_w := lpad(substr(substr(nr_ddd_celular_w,1,2)||lpad(substr(nr_telefone_celular_w,1,9),9,'0'),1,11),11,'0');
		end if;
		end;
	end if;
	end;
elsif (coalesce(ie_ordem_telefone_pac_w,'TC') = 'CT') then
	begin
	if (coalesce(nr_telefone_celular_w,'0') <> '0') then
		begin
		if (length(nr_telefone_celular_w) = 11) then
			ds_retorno_w := substr(nr_telefone_celular_w,1,11);
		elsif (length(nr_telefone_celular_w) = 10) then
			ds_retorno_w := substr(substr(nr_telefone_celular_w,1,2)||'0'||substr(nr_telefone_celular_w,3,8),1,11);
		elsif (length(nr_telefone_celular_w) < 10) then
			ds_retorno_w := lpad(substr(substr(nr_ddd_celular_w,1,2)||lpad(substr(nr_telefone_celular_w,1,9),9,'0'),1,11),11,'0');
		end if;
		end;
	elsif (coalesce(nr_telefone_w,'0') <> '0') then
		begin
		if (length(nr_telefone_w) = 11) then
			ds_retorno_w := substr(nr_telefone_w,1,11);
		elsif (length(nr_telefone_w) = 10) then
			ds_retorno_w := substr(substr(nr_telefone_w,1,2)||'0'||substr(nr_telefone_w,3,8),1,11);
		elsif (length(nr_telefone_w) < 10) then
			ds_retorno_w := lpad(substr(substr(nr_ddd_telefone_w,1,2)||lpad(substr(nr_telefone_w,1,9),9,'0'),1,11),11,'0');
		end if;
		end;
	end if;
	end;
end if;

return	ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION sus_obter_telefone_export ( cd_pessoa_fisica_p text) FROM PUBLIC;

