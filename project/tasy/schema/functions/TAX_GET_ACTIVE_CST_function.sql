-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION tax_get_active_cst (invoice_code_p nota_fiscal_item_trib.nr_sequencia%type, item_code_p nota_fiscal_item_trib.nr_item_nf%type, establishment_code_p nota_fiscal_item_trib.cd_estabelecimento%type, response_type_p text default 'CST', request_type_p text default 'EFD') RETURNS varchar AS $body$
DECLARE


product_origin_w    varchar(10);
taxation_icms_w     varchar(10);
response_w          varchar(10);


BEGIN

/*
Response Type
CST - CST code
TIC - taxation icms
ORG - Product origin

Request Type
NFE - Invoice
EFD - EFD ICMS/IPI
*/
if (request_type_p = 'EFD') then
  select  substr(max(obter_dados_situacao_trib(b.nr_seq_classif_trib, 'CD')), 1, 1),
          substr(max(obter_dados_situacao_trib(b.nr_seq_classif_trib, 'CD')), 2, 2)
  into STRICT    product_origin_w,
          taxation_icms_w
  FROM nota_fiscal a, nota_fiscal_item b
LEFT OUTER JOIN material_fiscal c ON (b.cd_material = c.cd_material)
WHERE a.nr_sequencia = b.nr_Sequencia  and a.nr_sequencia = invoice_code_p and b.nr_item_nf = item_code_p;
end if;

if (coalesce(product_origin_w::text, '') = '' or coalesce(taxation_icms_w::text, '') = '') then
  select  max(b.ie_origem_mercadoria),
          max(b.ie_tributacao_icms)
  into STRICT    product_origin_w,
          taxation_icms_w
  from	  nota_fiscal_item_trib a,
          material_estab b,
          nota_fiscal_item c,
          tributo d
  where	c.nr_item_nf = a.nr_item_nf
  and	  c.nr_sequencia = a.nr_sequencia
  and	  a.cd_tributo = d.cd_tributo
  and	  c.cd_material = b.cd_material
  and   b.cd_estabelecimento = establishment_code_p
  and	  a.nr_sequencia = invoice_code_p
  and	  a.nr_item_nf  = item_code_p
  and	  d.ie_tipo_tributo = 'ICMS';

  if (coalesce(product_origin_w::text, '') = '' or coalesce(taxation_icms_w::text, '') = '') then
    select  max(b.ie_origem_mercadoria),
            max(b.ie_tributacao_icms)
    into STRICT    product_origin_w,
            taxation_icms_w
    from	  nota_fiscal_item_trib a,
            material_fiscal b,
            nota_fiscal_item c,
            tributo d
    where	c.nr_item_nf = a.nr_item_nf
    and	  c.nr_sequencia = a.nr_sequencia
    and	  a.cd_tributo = d.cd_tributo
    and	  c.cd_material = b.cd_material
    and	  a.nr_sequencia = invoice_code_p
    and	  a.nr_item_nf  = item_code_p
    and	  d.ie_tipo_tributo = 'ICMS';
  end if;
end if;

if (response_type_p = 'CST') then
  response_w := substr(product_origin_w || taxation_icms_w, 1, 3);
elsif (response_type_p = 'TIC') then
  response_w := substr(taxation_icms_w, 1, 2);
elsif (response_type_p = 'ORG') then
  response_w := substr(product_origin_w, 1, 1);
end if;

return response_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION tax_get_active_cst (invoice_code_p nota_fiscal_item_trib.nr_sequencia%type, item_code_p nota_fiscal_item_trib.nr_item_nf%type, establishment_code_p nota_fiscal_item_trib.cd_estabelecimento%type, response_type_p text default 'CST', request_type_p text default 'EFD') FROM PUBLIC;

