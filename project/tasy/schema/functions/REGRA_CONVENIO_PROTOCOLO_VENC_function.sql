-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION regra_convenio_protocolo_venc ( cd_convenio_p bigint, dt_entrega_p timestamp) RETURNS timestamp AS $body$
DECLARE

	 
dt_vencimento_w	timestamp;
qt_existe_w	bigint;
nr_dias_venc_w	bigint;


BEGIN 
 
select	count(*) 
into STRICT	qt_existe_w 
from	conv_regra_venc 
where	cd_convenio = cd_convenio_p;
 
if (qt_existe_w > 0) then 
 
	select	max(dt_vencimento) 
	into STRICT	dt_vencimento_w 
	from	conv_regra_venc 
	where	cd_convenio = cd_convenio_p 
	and	trunc(dt_entrega_p,'dd') between trunc(dt_entrega_inicial,'dd') and trunc(dt_entrega_final,'dd') 
	and	ie_situacao = 'A';
 
else 
	 
	select	trunc(dt_entrega_p,'dd') + coalesce(max(nr_dias_venc),0) 
	into STRICT	dt_vencimento_w 
	from	convenio_estabelecimento 
	where	cd_convenio = cd_convenio_p 
	and	cd_estabelecimento = wheb_usuario_pck.get_cd_estabelecimento;
 
end if;
 
return	dt_vencimento_w;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION regra_convenio_protocolo_venc ( cd_convenio_p bigint, dt_entrega_p timestamp) FROM PUBLIC;

