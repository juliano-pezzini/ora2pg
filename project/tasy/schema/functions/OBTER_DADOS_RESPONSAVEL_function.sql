-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_dados_responsavel ( nr_atendimento_p bigint, ie_descricao_p text) RETURNS varchar AS $body$
DECLARE


ie_responsavel_w			varchar(15);
cd_pessoa_fisica_w			varchar(10);
cd_pessoa_resp_w			varchar(10);
ds_descricao_w				varchar(255)   := '';
nr_seq_grau_parentesco_w	bigint;

/* ie_descricao_p
	N   - Nome
	T   - Telefone
	C   - Nº CPF
	I   - Nº Identidade
	EC  - Endereço Completo
	ES  - Endereço Simples
	CI  - Cidade
	UF  - Estado
	CEP - Cep
	P   - Profissão
	S   - Empresa
	B   - Bairro
	CE  - Complemento de endereco
	O   - Obs. do responsável
	CR  - Conjuge do Responsável(Somente no caso de cadastro)
	GP  - Grau de parentesco (somente responsável)
	ECV - Estado Civil
	PF - Código  PF
*/
BEGIN
select	max(ie_responsavel),
		max(cd_pessoa_fisica),
		max(cd_pessoa_responsavel),
		max(nr_seq_grau_parentesco)
into STRICT	ie_responsavel_w,
		cd_pessoa_fisica_w,
		cd_pessoa_resp_w,
		nr_seq_grau_parentesco_w
from		atendimento_paciente
where		nr_atendimento	= nr_atendimento_p;

if (ie_descricao_p = 'N') then
	begin
	if (cd_pessoa_resp_w IS NOT NULL AND cd_pessoa_resp_w::text <> '') then
		select 	max(SUBSTR(OBTER_NOME_PF(p.CD_PESSOA_FISICA),0,255))
		into STRICT	ds_descricao_w
		from    pessoa_fisica p
		where	p.cd_pessoa_fisica	= cd_pessoa_resp_w;
	else
		ds_descricao_w	:= substr(obter_compl_pf(cd_pessoa_fisica_w, ie_responsavel_w,'N'),1,40);
	end if;
	end;
elsif (ie_descricao_p = 'T') then
	begin
	if (cd_pessoa_resp_w IS NOT NULL AND cd_pessoa_resp_w::text <> '') then
		select max(coalesce(p.nr_telefone_celular, c.nr_telefone))
		into STRICT	ds_descricao_w
		from 	compl_pessoa_fisica c,
			pessoa_fisica p
		where	p.cd_pessoa_fisica	= cd_pessoa_resp_w
		and	p.cd_pessoa_fisica	= c.cd_pessoa_fisica
		and	c.ie_tipo_complemento	= 1
		and	c.nr_sequencia		=
			(SELECT	max(x.nr_sequencia)
			from		compl_pessoa_fisica x
			where		x.cd_pessoa_fisica	= cd_pessoa_resp_w
			and		x.ie_tipo_complemento	= 1);
	else
		ds_descricao_w	:= obter_compl_pf(cd_pessoa_fisica_w, ie_responsavel_w,'T');
	end if;
	end;
elsif (ie_descricao_p = 'C') then
	begin
	if (cd_pessoa_resp_w IS NOT NULL AND cd_pessoa_resp_w::text <> '') then
		select max(coalesce(p.nr_cpf, c.nr_cpf))
		into STRICT	ds_descricao_w
		from 	compl_pessoa_fisica c,
			pessoa_fisica p
		where	p.cd_pessoa_fisica	= cd_pessoa_resp_w
		and	p.cd_pessoa_fisica	= c.cd_pessoa_fisica
		and	c.ie_tipo_complemento	= 1
		and	c.nr_sequencia		=
			(SELECT	max(x.nr_sequencia)
			from		compl_pessoa_fisica x
			where		x.cd_pessoa_fisica	= cd_pessoa_resp_w
			and		x.ie_tipo_complemento	= 1);
	else
		ds_descricao_w	:= obter_compl_pf(cd_pessoa_fisica_w, ie_responsavel_w,'C');
	end if;
	end;
elsif (ie_descricao_p = 'I') then
	begin
	if (cd_pessoa_resp_w IS NOT NULL AND cd_pessoa_resp_w::text <> '') then
		select max(coalesce(p.nr_identidade, c.nr_identidade))
		into STRICT	ds_descricao_w
		from 	compl_pessoa_fisica c,
			pessoa_fisica p
		where	p.cd_pessoa_fisica	= cd_pessoa_resp_w
		  and	p.cd_pessoa_fisica	= c.cd_pessoa_fisica
		and	c.nr_sequencia		=
			(SELECT	max(x.nr_sequencia)
			from		compl_pessoa_fisica x
			where		x.cd_pessoa_fisica	= cd_pessoa_resp_w
			and		x.ie_tipo_complemento	= 1);
	else
		ds_descricao_w	:= obter_compl_pf(cd_pessoa_fisica_w, ie_responsavel_w,'I');
	end if;
	end;
elsif (ie_descricao_p = 'EC') then
	begin
	if (cd_pessoa_resp_w IS NOT NULL AND cd_pessoa_resp_w::text <> '') then
		select max(c.ds_endereco) || ',' || max(c.nr_endereco) || ',' ||
			max(c.ds_bairro)   || ',' ||max(c.ds_complemento)
		into STRICT	ds_descricao_w
		from 	compl_pessoa_fisica c,
			pessoa_fisica p
		where	p.cd_pessoa_fisica	= cd_pessoa_resp_w
		  and	p.cd_pessoa_fisica	= c.cd_pessoa_fisica
		and	c.nr_sequencia		=
			(SELECT	max(x.nr_sequencia)
			from		compl_pessoa_fisica x
			where		x.cd_pessoa_fisica	= cd_pessoa_resp_w
			and		x.ie_tipo_complemento	= 1);
	else
		ds_descricao_w	:= substr(obter_compl_pf(cd_pessoa_fisica_w, ie_responsavel_w,'EC'),1,40);
	end if;
	end;
elsif (ie_descricao_p = 'B') then
	begin
	if (cd_pessoa_resp_w IS NOT NULL AND cd_pessoa_resp_w::text <> '') then
		select max(c.ds_bairro)
		into STRICT	ds_descricao_w
		from 	compl_pessoa_fisica c,
			pessoa_fisica p
		where	p.cd_pessoa_fisica	= cd_pessoa_resp_w
		  and	p.cd_pessoa_fisica	= c.cd_pessoa_fisica
		and	c.nr_sequencia		=
			(SELECT	max(x.nr_sequencia)
			from		compl_pessoa_fisica x
			where		x.cd_pessoa_fisica	= cd_pessoa_resp_w
			and		x.ie_tipo_complemento	= 1);
	else
		ds_descricao_w	:= substr(obter_compl_pf(cd_pessoa_fisica_w, ie_responsavel_w,'B'),1,40);
	end if;
	end;
elsif (ie_descricao_p = 'CE') then
	begin
	if (cd_pessoa_resp_w IS NOT NULL AND cd_pessoa_resp_w::text <> '') then
		select max(c.ds_complemento)
		into STRICT	ds_descricao_w
		from 	compl_pessoa_fisica c,
			pessoa_fisica p
		where	p.cd_pessoa_fisica	= cd_pessoa_resp_w
		  and	p.cd_pessoa_fisica	= c.cd_pessoa_fisica
		and	c.nr_sequencia		=
			(SELECT	max(x.nr_sequencia)
			from		compl_pessoa_fisica x
			where		x.cd_pessoa_fisica	= cd_pessoa_resp_w
			and		x.ie_tipo_complemento	= 1);
	else
		ds_descricao_w	:= substr(obter_compl_pf(cd_pessoa_fisica_w, ie_responsavel_w,'CO'),1,40);
	end if;
	end;
elsif (ie_descricao_p = 'ES') then
	begin
	if (cd_pessoa_resp_w IS NOT NULL AND cd_pessoa_resp_w::text <> '') then
		select max(c.ds_endereco) || ',' || max(c.nr_endereco)
		into STRICT	ds_descricao_w
		from 	compl_pessoa_fisica c,
			pessoa_fisica p
		where	p.cd_pessoa_fisica	= cd_pessoa_resp_w
		  and	p.cd_pessoa_fisica	= c.cd_pessoa_fisica
		and	c.nr_sequencia		=
			(SELECT	max(x.nr_sequencia)
			from		compl_pessoa_fisica x
			where		x.cd_pessoa_fisica	= cd_pessoa_resp_w
			and		x.ie_tipo_complemento	= 1);
	else
		ds_descricao_w	:= substr(obter_compl_pf(cd_pessoa_fisica_w, ie_responsavel_w,'E'),1,40);
	end if;
	end;
elsif (ie_descricao_p = 'CI') then
	begin
	if (cd_pessoa_resp_w IS NOT NULL AND cd_pessoa_resp_w::text <> '') then
		select max(c.ds_municipio)
		into STRICT	ds_descricao_w
		from 	compl_pessoa_fisica c,
			pessoa_fisica p
		where	p.cd_pessoa_fisica	= cd_pessoa_resp_w
		and	p.cd_pessoa_fisica	= c.cd_pessoa_fisica
		and	c.ie_tipo_complemento	= 1
		and	c.nr_sequencia		=
			(SELECT	max(x.nr_sequencia)
			from		compl_pessoa_fisica x
			where		x.cd_pessoa_fisica	= cd_pessoa_resp_w
			and		x.ie_tipo_complemento	= 1);
	else
		ds_Descricao_w	:= substr(obter_compl_pf(cd_pessoa_fisica_w, ie_responsavel_w,'CI'),1,40);
	end if;
	end;
elsif (ie_descricao_p = 'UF') then
	begin
	if (cd_pessoa_resp_w IS NOT NULL AND cd_pessoa_resp_w::text <> '') then
		select max(c.sg_estado)
		into STRICT	ds_descricao_w
		from 	compl_pessoa_fisica c,
			pessoa_fisica p
		where	p.cd_pessoa_fisica	= cd_pessoa_resp_w
		and	p.cd_pessoa_fisica	= c.cd_pessoa_fisica
		and	c.ie_tipo_complemento	= 1
		and	c.nr_sequencia		=
			(SELECT	max(x.nr_sequencia)
			from		compl_pessoa_fisica x
			where		x.cd_pessoa_fisica	= cd_pessoa_resp_w
			and		x.ie_tipo_complemento	= 1);
	else
		ds_descricao_w	:= substr(obter_compl_pf(cd_pessoa_fisica_w, ie_responsavel_w,'UF'),1,2);
	end if;
	end;
elsif (ie_descricao_p = 'CEP') then
	begin
	if (cd_pessoa_resp_w IS NOT NULL AND cd_pessoa_resp_w::text <> '') then
		select max(c.cd_cep)
		into STRICT	ds_descricao_w
		from 	compl_pessoa_fisica c,
			pessoa_fisica p
		where	p.cd_pessoa_fisica	= cd_pessoa_resp_w
		and	p.cd_pessoa_fisica	= c.cd_pessoa_fisica
		and	c.ie_tipo_complemento	= 1
		and	c.nr_sequencia		=
			(SELECT	max(x.nr_sequencia)
			from		compl_pessoa_fisica x
			where		x.cd_pessoa_fisica	= cd_pessoa_resp_w
			and		x.ie_tipo_complemento	= 1);
	else
		ds_descricao_w	:= obter_compl_pf(cd_pessoa_fisica_w, ie_responsavel_w,'CEP');
	end if;
	end;
elsif (ie_descricao_p = 'P') then
	begin
	if (cd_pessoa_resp_w IS NOT NULL AND cd_pessoa_resp_w::text <> '') then
		select max(o.ds_profissao)
		into STRICT	ds_descricao_w
		FROM pessoa_fisica p, compl_pessoa_fisica c
LEFT OUTER JOIN profissao o ON (c.cd_profissao = o.cd_profissao)
WHERE p.cd_pessoa_fisica	= cd_pessoa_resp_w and p.cd_pessoa_fisica	= c.cd_pessoa_fisica and c.ie_tipo_complemento	= 1  and c.nr_sequencia		=
			(SELECT	max(x.nr_sequencia)
			from		compl_pessoa_fisica x
			where		x.cd_pessoa_fisica	= cd_pessoa_resp_w
			and		x.ie_tipo_complemento	= 1);
	else
		ds_descricao_w	:= substr(obter_compl_pf(cd_pessoa_fisica_w, ie_responsavel_w,'P'),1,40);
	end if;
	end;
elsif (ie_descricao_p = 'S') then
	begin
	if (cd_pessoa_resp_w IS NOT NULL AND cd_pessoa_resp_w::text <> '') then
		select max(e.nm_empresa)
		into STRICT	ds_descricao_w
		FROM pessoa_fisica p, compl_pessoa_fisica c
LEFT OUTER JOIN empresa_referencia e ON (c.cd_empresa_refer = e.cd_empresa)
WHERE p.cd_pessoa_fisica	= cd_pessoa_resp_w and p.cd_pessoa_fisica	= c.cd_pessoa_fisica and c.ie_tipo_complemento	= 1  and c.nr_sequencia		=
			(SELECT	max(x.nr_sequencia)
			from		compl_pessoa_fisica x
			where		x.cd_pessoa_fisica	= cd_pessoa_resp_w
			and		x.ie_tipo_complemento	= 1);
	else
		ds_descricao_w	:= substr(obter_compl_pf(cd_pessoa_fisica_w, ie_responsavel_w,'S'),1,40);
	end if;
	end;
elsif (ie_descricao_p = 'O') then
	begin
	if (cd_pessoa_resp_w IS NOT NULL AND cd_pessoa_resp_w::text <> '') then
		select max(c.ds_observacao)
		into STRICT	ds_descricao_w
		from 	compl_pessoa_fisica c,
			pessoa_fisica p
		where	p.cd_pessoa_fisica	= cd_pessoa_resp_w
		and	p.cd_pessoa_fisica	= c.cd_pessoa_fisica
		and	c.ie_tipo_complemento	= 1
		and	c.nr_sequencia		=
			(SELECT	max(x.nr_sequencia)
			from		compl_pessoa_fisica x
			where		x.cd_pessoa_fisica	= cd_pessoa_resp_w
			and		x.ie_tipo_complemento	= 1);
	else
		ds_descricao_w	:= substr(obter_compl_pf(cd_pessoa_fisica_w, ie_responsavel_w,'O'),1,40);
	end if;
	end;
elsif (ie_descricao_p = 'CR') then
	begin
	if (cd_pessoa_resp_w IS NOT NULL AND cd_pessoa_resp_w::text <> '') then
		ds_descricao_w	:= substr(obter_compl_pf(cd_pessoa_resp_w, 6,'N'),1,40);
	end if;
	end;
elsif (ie_descricao_p = 'ECV') then    /* Almir em 30/10/2007 OS72376 */
	begin
	if (cd_pessoa_resp_w IS NOT NULL AND cd_pessoa_resp_w::text <> '') then
		ds_descricao_w	:= substr(obter_valor_dominio(5,obter_dados_pf(cd_pessoa_resp_w,'EC')),1,40);
	end if;
	end;
elsif (ie_descricao_p = 'GP') then
	begin
	if (cd_pessoa_resp_w IS NOT NULL AND cd_pessoa_resp_w::text <> '') or ((coalesce(cd_pessoa_resp_w::text, '') = '') and (ie_responsavel_w not in (0,3))) then
		if (ie_responsavel_w = 3) then
			select	ds_parentesco
			into STRICT	ds_descricao_w
			from	grau_parentesco
			where	nr_sequencia = nr_seq_grau_parentesco_w;
		else
			select	ds_valor_dominio
			into STRICT	ds_descricao_w
			from	valor_dominio_v
			where	cd_dominio = 2077
			and		vl_dominio = ie_responsavel_w;
		end if;
	else
		ds_descricao_w	:= substr(obter_compl_pf(cd_pessoa_fisica_w, ie_responsavel_w,'GP'),1,40);
	end if;
	end;
elsif (ie_descricao_p = 'PF') then
	begin
	if (cd_pessoa_resp_w IS NOT NULL AND cd_pessoa_resp_w::text <> '') then
		ds_descricao_w	:= cd_pessoa_resp_w;
	end if;
	end;
else
	ds_descricao_w	:= substr(obter_compl_pf(cd_pessoa_fisica_w, ie_responsavel_w, ie_descricao_p),1,40);
end if;

RETURN ds_descricao_w;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_dados_responsavel ( nr_atendimento_p bigint, ie_descricao_p text) FROM PUBLIC;

