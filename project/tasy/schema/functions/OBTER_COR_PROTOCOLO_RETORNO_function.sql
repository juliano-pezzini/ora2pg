-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_cor_protocolo_retorno ( nr_seq_protocolo_p bigint) RETURNS bigint AS $body$
DECLARE

 
/* COR 1 (466) - Protocolos sem nenhum retorno vinculado 
  COR 2 (467) - Protocolos com retorno mas não fechado 
  COR 3 (468) - Protocolos com retorno e fechado 
  COR 4 (502) - Protocolos (Tipo de convênio Particular) à vista baixado (C/ título e saldo zero p/ todas as contas) 
  COR 5 (503) - Protocolos (Tipo de convênio Particular) à vista não baixado 
  COR 6 (704) - Protocolos com retorno e aguardando recurso 
  COR 7 (1807) - Protocolos com retorno parcial e fechado 
  COR 8 (4938) - Protocolo com retorno (c/ itens reapresentação) 
*/
 
 
nr_seq_cor_w		bigint := 0;
sem_retorno_w		bigint;
com_retorno_w		bigint;
ie_status_retorno_w	varchar(1);
dt_retorno_w		timestamp;
nr_sequencia_w		bigint;
ie_tipo_convenio_w	smallint;
cd_convenio_w		integer;
nr_interno_conta_w  	bigint;
nr_titulo_w		bigint;
vl_saldo_titulo_w	double precision;
ie_baixado_w		varchar(1);
qt_aguardando_w		bigint;

qt_contas_prot_w	bigint;
qt_contas_prot_ret_w	bigint;
qt_reapresentacao_w	bigint;

C01 CURSOR FOR 
	SELECT	max(coalesce(nr_interno_conta,0)) 
	from	conta_paciente 
	where	nr_seq_protocolo = nr_seq_protocolo_p 
	order by nr_interno_conta;

C02 CURSOR FOR 
	SELECT	max(coalesce(nr_titulo,0)), 
		sum(vl_saldo_titulo) 
	from	titulo_receber 
	where	nr_interno_conta = nr_interno_conta_w 
	order by nr_titulo;


BEGIN 
 
ie_baixado_w:= 'S';
 
select	cd_convenio 
into STRICT	cd_convenio_w 
from 	protocolo_convenio 
where 	nr_seq_protocolo = nr_seq_protocolo_p;
 
select 	ie_tipo_convenio 
into STRICT	ie_tipo_convenio_w 
from 	convenio 
where 	cd_convenio = cd_convenio_w;
 
if (ie_tipo_convenio_w = 1) then 
		 
	OPEN C01;
	LOOP 
	FETCH C01 into 
		nr_interno_conta_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
		begin 
		OPEN C02;
		LOOP 
		FETCH C02 into 
			nr_titulo_w, 
			vl_saldo_titulo_w;
		EXIT WHEN NOT FOUND; /* apply on c02 */
			begin 
			if (coalesce(nr_titulo_w::text, '') = '') then				 
				ie_baixado_w := 'N';
			elsif (vl_saldo_titulo_w > 0) then				 
				ie_baixado_w := 'N';	
			end if;
			end;
		END LOOP;
		CLOSE C02;				
		end;
	END LOOP;
	CLOSE C01;
	 
	if (ie_baixado_w = 'N') then 
		nr_seq_cor_w:= 503;
	else 
		nr_seq_cor_w:= 502;
	end if;
 
else 
 
	select 	count(*) 
	into STRICT	qt_contas_prot_w 
	from 	conta_paciente 
	where 	nr_seq_protocolo = nr_seq_protocolo_p 
	and 	coalesce(ie_cancelamento::text, '') = '';
	 
	/*select 	count(*) 
	into	qt_contas_prot_ret_w 
	from	convenio_retorno_item a, 
		conta_paciente b 
	where	a.nr_interno_conta = b.nr_interno_conta 
	and	nr_seq_protocolo = nr_seq_protocolo_p;*/
 
	 
	select 	count(*) 
	into STRICT	qt_contas_prot_ret_w 
	from	conta_paciente b 
	where	nr_seq_protocolo = nr_seq_protocolo_p 
	and 	exists (SELECT 	1 
			from 	convenio_retorno_item a 
			where 	a.nr_interno_conta = b.nr_interno_conta);
 
	/*begin 
	select 	nvl(max(nr_seq_protocolo),0) 
	into	sem_retorno_w 
	from	convenio_retorno_item a, 
		conta_paciente b 
	where	a.nr_interno_conta = b.nr_interno_conta 
	and	nr_seq_protocolo = nr_seq_protocolo_p; 
	exception 
		when others then 
			sem_retorno_w	:= 0; 
	end;*/
 
	 
	begin 
	select 	coalesce(max(nr_seq_protocolo),0) 
	into STRICT	sem_retorno_w 
	from	conta_paciente b 
	where	nr_seq_protocolo = nr_seq_protocolo_p 
	and 	exists (SELECT 	1 
			from 	convenio_retorno_item a 
			where 	a.nr_interno_conta = b.nr_interno_conta);
	exception 
		when others then 
			sem_retorno_w	:= 0;
	end;
 
	select	max(c.dt_retorno), 
		max(c.nr_sequencia) 
	into STRICT	dt_retorno_w, 
		nr_sequencia_w 
	from	convenio_retorno_item a, 
		convenio_retorno c, 
		conta_paciente b 
	where	a.nr_interno_conta 	= b.nr_interno_conta 
	and	c.nr_sequencia 		= nr_seq_retorno 
	and	b.nr_seq_protocolo	= nr_seq_protocolo_p;
 
	begin 
	select 	distinct 
		coalesce(b.nr_seq_protocolo,0), 
		ie_status_retorno 
	into STRICT	com_retorno_w, 
		ie_status_retorno_w 
	from	convenio_retorno_item a, 
		convenio_retorno c, 
		conta_paciente b 
	where	a.nr_interno_conta 	= b.nr_interno_conta 
	and	c.nr_sequencia 		= nr_seq_retorno 
	and	b.nr_seq_protocolo	= nr_seq_protocolo_p 
	and	c.nr_sequencia		= nr_sequencia_w;
	exception 
		when others then 
			com_retorno_w	:= 0;
	end;
	 
	if (com_retorno_w > 0) and (ie_status_retorno_w = 'F') then 
		select	count(*) 
		into STRICT	qt_reapresentacao_w 
		from	convenio_retorno_item a, 
			convenio_retorno_glosa b, 
			motivo_glosa c 
		where	a.nr_sequencia		= b.nr_seq_ret_item 
		and	c.cd_motivo_glosa	= b.cd_motivo_glosa 
		and	coalesce(b.ie_acao_glosa,c.ie_acao_glosa)	in ('R','P') 
		and	a.nr_seq_retorno	= nr_sequencia_w;		
	end if;
	 
	if	((sem_retorno_w > 0) and (coalesce(nr_sequencia_w,0) > 0)) then 
		select 	count(*) 
		into STRICT	qt_aguardando_w 
		from 	convenio_retorno_item 
		where	nr_seq_retorno = nr_sequencia_w 
		and 	ie_glosa <> 'S';
	end if;
 
	if	sem_retorno_w = 0 then 
		nr_seq_cor_w := 466;
	elsif	(com_retorno_w <> 0 AND ie_status_retorno_w <> 'F') then 
		if (qt_aguardando_w > 0) then 
			nr_seq_cor_w := 704;
		else 
			nr_seq_cor_w := 467;
		end if;
	elsif	(com_retorno_w <> 0 AND ie_status_retorno_w = 'F') then 
		if (qt_contas_prot_ret_w <> qt_contas_prot_w) then 
			nr_seq_cor_w	:= 1807;
		elsif (qt_reapresentacao_w > 0) then 
			nr_seq_cor_w	:= 4938;
		else 
			nr_seq_cor_w 	:= 468;
		end if;
	end if;
	 
	if (nr_seq_cor_w = 0) then 
		nr_seq_cor_w := 466;
	end if;
 
end if;
 
RETURN nr_seq_cor_w;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_cor_protocolo_retorno ( nr_seq_protocolo_p bigint) FROM PUBLIC;

