-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_last_round_proj ( NR_SEQ_PROJ_CRON_ETAPA_P bigint) RETURNS bigint AS $body$
DECLARE

 PR_RETORNO_W bigint := NULL;
 AUX_I        bigint := NULL;
 ADH_SO_W     bigint := NULL;
 QTD_ENC_W    bigint := NULL;

BEGIN

  PR_RETORNO_W := 0;

  FOR AUX_I IN 1..15
  LOOP
    BEGIN
      SELECT OBTER_OS_ADERENCIA_PROJ(NR_SEQ_PROJ_CRON_ETAPA_P, AUX_I)
        INTO STRICT ADH_SO_W
;
    EXCEPTION
	  	WHEN no_data_found THEN
	  		ADH_SO_W := NULL;
	  	WHEN OTHERS THEN
	  		ADH_SO_W := NULL;
    END;

    EXIT WHEN coalesce(ADH_SO_W::text, '') = '';

    BEGIN
      SELECT COUNT(1)
        INTO STRICT QTD_ENC_W
        FROM MAN_ORDEM_SERVICO OS
       WHERE OS.NR_SEQUENCIA    = ADH_SO_W
         AND OS.NR_SEQ_ESTAGIO IN (9);
    EXCEPTION
      WHEN no_data_found THEN
        QTD_ENC_W := 0;
      WHEN OTHERS THEN
        QTD_ENC_W := 0;
    END;

    IF QTD_ENC_W > 0 THEN
      PR_RETORNO_W := AUX_I;
    END IF;
  END LOOP;

  RETURN PR_RETORNO_W;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_last_round_proj ( NR_SEQ_PROJ_CRON_ETAPA_P bigint) FROM PUBLIC;

