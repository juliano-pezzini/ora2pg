-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_data_retorno_doador ( cd_pessoa_fisica_p bigint) RETURNS timestamp AS $body$
DECLARE


ie_sexo_w		varchar(1);
qt_dias_ult_dia_w	bigint;
qt_doacao_ano_regra_w	bigint;
qt_doacao_ano_doador_w	bigint;
dt_retorno_w		timestamp;
ie_tipo_coleta_w    	san_doacao.ie_tipo_coleta%type;
nr_seq_doacao_w      	san_doacao.nr_sequencia%type;
nr_seq_regra_w      	san_regra_doacao.nr_sequencia%type;
nr_seq_ultima_doacao_w 	san_doacao.nr_sequencia%type;
ie_tipo_coleta_ant_w    san_doacao.ie_tipo_coleta%type;
dt_ano_anterior_w	timestamp;
dt_ult_doacao_w		timestamp;


BEGIN

ie_sexo_w := obter_sexo_pf(cd_pessoa_fisica_p, 'C');

if (ie_sexo_w IS NOT NULL AND ie_sexo_w::text <> '') then
	
	select 	max(nr_sequencia),
		max(dt_doacao)
	into STRICT	nr_seq_doacao_w,
		dt_ult_doacao_w
	from 	san_doacao
	where 	cd_pessoa_fisica = cd_pessoa_fisica_p;

	dt_ano_anterior_w := trunc(PKG_DATE_UTILS.ADD_MONTH(dt_ult_doacao_w,-12,0));

	select 	max(nr_sequencia)
	into STRICT	nr_seq_ultima_doacao_w
	from 	san_doacao
	where 	cd_pessoa_fisica = cd_pessoa_fisica_p
	and 	(dt_fim_coleta IS NOT NULL AND dt_fim_coleta::text <> '');		
	
	select	max(ie_tipo_coleta)
	into STRICT 	ie_tipo_coleta_w
	from 	san_doacao
	where 	nr_sequencia = nr_seq_doacao_w;
		
	if (nr_seq_ultima_doacao_w IS NOT NULL AND nr_seq_ultima_doacao_w::text <> '') then
		select	max(ie_tipo_coleta)
		into STRICT 	ie_tipo_coleta_ant_w
		from 	san_doacao
		where 	nr_sequencia = nr_seq_ultima_doacao_w;
	end if;

	select 	max(nr_sequencia)
	into STRICT	nr_seq_regra_w
	from 	san_regra_doacao
	where 	ie_sexo = ie_sexo_w
	and 	nr_tipo_doacao = ie_tipo_coleta_w
	and (nr_tipo_doacao_anterior = ie_tipo_coleta_ant_w or (coalesce(nr_tipo_doacao_anterior::text, '') = '' and coalesce(ie_tipo_coleta_ant_w::text, '') = ''));
	
	if (coalesce(nr_seq_regra_w::text, '') = '') then
		select 	max(nr_sequencia)
		into STRICT	nr_seq_regra_w
		from 	san_regra_doacao
		where 	ie_sexo = ie_sexo_w
		and	coalesce(nr_tipo_doacao::text, '') = ''
		and (nr_tipo_doacao_anterior = ie_tipo_coleta_ant_w or (coalesce(nr_tipo_doacao_anterior::text, '') = '' and coalesce(ie_tipo_coleta_ant_w::text, '') = ''));
	end if;
	
	if (coalesce(nr_seq_regra_w::text, '') = '') then
		select 	max(nr_sequencia)
		into STRICT	nr_seq_regra_w
		from 	san_regra_doacao
		where 	ie_sexo = ie_sexo_w
		and 	coalesce(nr_tipo_doacao::text, '') = ''
		and	coalesce(nr_tipo_doacao_anterior::text, '') = '';
	end if;
	
	if (nr_seq_regra_w IS NOT NULL AND nr_seq_regra_w::text <> '') then
	
		select 	max(qt_dias_ult_dia),
			max(qt_doacao_ano)
		into STRICT	qt_dias_ult_dia_w,
			qt_doacao_ano_regra_w
		from 	san_regra_doacao
		where 	nr_sequencia = nr_seq_regra_w;

		/*Adicionado mais um para considerar a doacao do dia como mais uma doacao no ano*/

		select	count(1) + 1
		into STRICT	qt_doacao_ano_doador_w
		from   	san_doacao
		where  	cd_pessoa_fisica = cd_pessoa_fisica_p
		and	dt_doacao between dt_ano_anterior_w and clock_timestamp()
		and 	(dt_fim_coleta IS NOT NULL AND dt_fim_coleta::text <> '');

		if (qt_doacao_ano_doador_w < qt_doacao_ano_regra_w) then
			dt_retorno_w := trunc(dt_ult_doacao_w + qt_dias_ult_dia_w);
		else if (extract(year from (dt_ult_doacao_w+qt_dias_ult_dia_w)) < extract(year from (PKG_DATE_UTILS.ADD_MONTH(dt_ult_doacao_w, 12, 0)))) then
			dt_retorno_w := PKG_DATE_UTILS.ADD_MONTH(dt_ult_doacao_w, 13 - extract(month from (dt_ult_doacao_w)), 0);
		else
			dt_retorno_w := trunc(dt_ult_doacao_w + qt_dias_ult_dia_w);
		end if;
	end if;
  end if;
end if;

return	dt_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 IMMUTABLE;
-- REVOKE ALL ON FUNCTION obter_data_retorno_doador ( cd_pessoa_fisica_p bigint) FROM PUBLIC;

