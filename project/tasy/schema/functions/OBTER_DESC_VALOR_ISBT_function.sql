-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_desc_valor_isbt ( cd_ref_p text, cd_codigo_p text) RETURNS varchar AS $body$
DECLARE

ds_retorno_w		varchar(255);
cd_local_isbt_w		varchar(5);
nr_seq_isbt_w		integer;
ds_entidade_w		varchar(50);
ds_doacao_derivado_w	varchar(50);


BEGIN
IF (cd_ref_p IS NOT NULL AND cd_ref_p::text <> '') AND (cd_codigo_p IS NOT NULL AND cd_codigo_p::text <> '') THEN

	CASE
	WHEN(cd_ref_p = '001')	THEN
			BEGIN
			cd_local_isbt_w	:= SUBSTR(cd_codigo_p,2,5);

			SELECT	MAX(ds_entidade)
			INTO STRICT	ds_entidade_w
			FROM	san_entidade
			WHERE	cd_local_isbt = cd_local_isbt_w;

			ds_retorno_w := SUBSTR(cd_codigo_p,2,5)||' '||SUBSTR(cd_codigo_p,7,2)||' '||SUBSTR(cd_codigo_p,9,6)||' - '||ds_entidade_w;
			END;
	WHEN(cd_ref_p = '002')	THEN
			BEGIN

			SELECT	ie_tipo_sangue||ie_fator_rh|| CASE WHEN coalesce(nr_seq_tipo_doacao::text, '') = '' THEN ''  ELSE ' | '||obter_desc_tipo_doacao(nr_seq_tipo_doacao) END
			INTO STRICT	ds_retorno_w
			FROM	san_grupo_sanguineo_isbt
			WHERE	cd_sangue_isbt = SUBSTR(cd_codigo_p,3,2);

			END;
	WHEN(cd_ref_p = '003')	THEN
			BEGIN
			SELECT	MAX(ds_tipo_doacao)
			INTO STRICT	ds_doacao_derivado_w
			FROM	san_tipo_doacao
			WHERE	UPPER(cd_isbt) = UPPER(SUBSTR(cd_codigo_p,8,1));

			SELECT	b.ds_derivado|| CASE WHEN a.ie_lavado='S' THEN ' | '||obter_desc_expressao(292460) END || CASE WHEN a.ie_irradiado='S' THEN ' | '||obter_desc_expressao(292247) END
					|| CASE WHEN a.ie_filtrado='S' THEN ' | '||obter_desc_expressao(290096) END || CASE WHEN a.ie_aliquotado='S' THEN ' | '||obter_desc_expressao(309813) END 
					|| CASE WHEN coalesce(a.qt_volume_inicial::text, '') = '' THEN ''  ELSE ' | '||obter_desc_expressao(302271)||': '||a.qt_volume_inicial END 
					|| CASE WHEN coalesce(a.qt_volume_final::text, '') = '' THEN ''  ELSE ' | '||obter_desc_expressao(302265)||': '||a.qt_volume_final END 
					|| CASE WHEN coalesce(a.nr_seq_conservante::text, '') = '' THEN ''  ELSE ' | '||obter_desc_expressao(285722)||': '||san_obter_desc_conservante(a.nr_seq_conservante) END 
					|| CASE WHEN ds_doacao_derivado_w='' THEN ''  ELSE ' | '||ds_doacao_derivado_w END 
			INTO STRICT	ds_retorno_w
			FROM	san_derivado_bolsa a,
				san_derivado b
			WHERE	a.nr_seq_derivado = b.nr_sequencia
			AND	a.nr_bolsa = SUBSTR(cd_codigo_p,3,5);

			END;
	WHEN(cd_ref_p = '004') OR (cd_ref_p = '006') OR (cd_ref_p = '008') THEN
			BEGIN

			SELECT	TO_CHAR(TO_DATE(SUBSTR( cd_codigo_p,3,3)||SUBSTR( cd_codigo_p,6,3),'yyyddd'),'dd/mm')||'/'||TO_CHAR(TO_DATE(SUBSTR( cd_codigo_p,3,3),'yyy'),'yyyy')
			INTO STRICT	ds_retorno_w
			;

			END;
	WHEN(cd_ref_p = '005') OR (cd_ref_p = '007') OR (cd_ref_p = '009') THEN
			BEGIN

			SELECT	TO_CHAR(TO_DATE(SUBSTR( cd_codigo_p,3,3)||SUBSTR( cd_codigo_p,6,3),'yyyddd'),'dd/mm')||'/'||TO_CHAR(TO_DATE(SUBSTR( cd_codigo_p,3,3),'yyy'),'yyyy')
				||' '||TO_CHAR(TO_DATE(SUBSTR( cd_codigo_p,9,4),'hh24mi'),'hh24:mi')
			INTO STRICT	ds_retorno_w
			;

			END;
	WHEN(cd_ref_p = '010') THEN

		BEGIN
			ds_retorno_w := San_Gerar_Codigo_ISBT.san_obter_codGer_descri_ISBT(SUBSTR(cd_codigo_p,3));
		END;
	
	 WHEN(cd_ref_p = '012') THEN

		BEGIN
			select substr(San_Gerar_Codigo_ISBT.san_obter_fenotipagem_concat(nr_sequencia), 1, 255)
				into STRICT ds_retorno_w
			from san_doacao
			where cd_isbt_antigeno = SUBSTR(cd_codigo_p,3);
		END;
	END CASE;
END IF;

RETURN	ds_retorno_w;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_desc_valor_isbt ( cd_ref_p text, cd_codigo_p text) FROM PUBLIC;

