-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_valor_lote_audit (nr_seq_lote_p bigint, ie_opcao_p text) RETURNS bigint AS $body$
DECLARE


vl_retorno_w		double precision;
vl_lote_w		double precision;
vl_lote_receb_w		double precision;
vl_receb_lote_w		double precision;
vl_receb_sem_glosa_w	double precision;

/*
ie_opcao_p

	'L' - Valor do lote
	'S' - Valor recebido dos itens que estão no lote
	'R' - Somente valor recebido
	'G' - Somente valor de glosa devida
*/
BEGIN

select	coalesce(sum(a.vl_historico),0)
into STRICT	vl_lote_w
from	conta_paciente_ret_hist a
where	a.nr_seq_lote_recurso	= nr_seq_lote_p;

if (ie_opcao_p = 'L') then
	vl_retorno_w	:= vl_lote_w;
elsif (ie_opcao_p = 'S') then
	select	coalesce(sum(a.vl_historico),0)
	into STRICT	vl_lote_receb_w
	from	HIST_AUDIT_CONTA_PACIENTE b,
		conta_paciente_ret_hist a
	where	b.IE_ACAO		in (1,3) -- afstringari 178521 26/01/2010
	and	a.NR_SEQ_HIST_AUDIT	= b.nr_sequencia
	and	exists (SELECT	1 from	conta_paciente_ret_hist x
			 where	x.nr_seq_lote_recurso	= nr_seq_lote_p
			 and	x.NR_SEQ_CONPACI_RET	= a.NR_SEQ_CONPACI_RET);

	vl_retorno_w	:= vl_lote_w - vl_lote_receb_w;

	if (vl_retorno_w < 0) then -- afstringari 178521 26/01/2010
		vl_retorno_w	:= 0;
	end if;

elsif (ie_opcao_p = 'R') then	--Valor do historico de recebimento gerados após o lote de recurso
	select	coalesce(sum(a.vl_historico),0)
	into STRICT	vl_retorno_w
	from	hist_audit_conta_paciente b,
		conta_paciente_ret_hist a
	where	b.ie_acao		= '1' -- lhalves 521115 em 27/11/2012
	and	a.nr_seq_hist_audit	= b.nr_sequencia
	and	exists (SELECT	1
			from	conta_paciente_ret_hist x
			where	x.nr_seq_lote_recurso	= nr_seq_lote_p
			and	x.nr_seq_conpaci_ret	= a.nr_seq_conpaci_ret)
	and	a.dt_historico	>
				(select	max(dt_historico)
				from	conta_paciente_ret_hist x
				where	x.nr_seq_lote_recurso	= nr_seq_lote_p);

	if (vl_retorno_w < 0) then
		vl_retorno_w	:= 0;
	end if;

elsif	(ie_opcao_p = 'G') then	-- Se o resultado da opção 'S' for zero, diminuir o resultado da opção 'L' e o resultado da opção 'R', o que sobrar é Glosa

	select	coalesce(sum(a.vl_historico),0)
	into STRICT	vl_lote_receb_w
	from	hist_audit_conta_paciente b,
		conta_paciente_ret_hist a
	where	b.ie_acao		in (1,3)
	and	a.nr_seq_hist_audit	= b.nr_sequencia
	and	exists (SELECT	1 from	conta_paciente_ret_hist x
			 where	x.nr_seq_lote_recurso	= nr_seq_lote_p
			 and	x.nr_seq_conpaci_ret	= a.nr_seq_conpaci_ret);

	vl_receb_lote_w	:= vl_lote_w - vl_lote_receb_w;

	if (vl_receb_lote_w <= 0) then

		select	coalesce(sum(a.vl_historico),0)
		into STRICT	vl_receb_sem_glosa_w
		from	hist_audit_conta_paciente b,
			conta_paciente_ret_hist a
		where	b.ie_acao		= '1' -- lhalves 521115 em 27/11/2012
		and	a.nr_seq_hist_audit	= b.nr_sequencia
		and	exists (SELECT	1
				from	conta_paciente_ret_hist x
				where	x.nr_seq_lote_recurso	= nr_seq_lote_p
				and	x.nr_seq_conpaci_ret	= a.nr_seq_conpaci_ret)
		and	a.dt_historico	>
					(select	max(dt_historico)
					from	conta_paciente_ret_hist x
					where	x.nr_seq_lote_recurso	= nr_seq_lote_p);

		vl_retorno_w	:= vl_lote_w - vl_receb_sem_glosa_w;

	else
		vl_retorno_w	:= 0;
	end if;

	if (vl_retorno_w < 0) then
		vl_retorno_w	:= 0;
	end if;

end if;

return	vl_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_valor_lote_audit (nr_seq_lote_p bigint, ie_opcao_p text) FROM PUBLIC;

