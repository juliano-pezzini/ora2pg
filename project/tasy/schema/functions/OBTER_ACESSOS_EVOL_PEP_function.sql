-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_acessos_evol_pep (nr_atendimento_p bigint, cd_profissional_p text, ie_opcao_p text) RETURNS varchar AS $body$
DECLARE

 
ie_atualizacao_w	varchar(2);
ie_regra_w		varchar(2);

--Atualizações do ítem evolução -AT 
--Apenas acessou a evolução mas nao atualizou nenhum ítem- AC 
--Realizou prescrição - P 
 

BEGIN 
if (ie_opcao_p = 'AT') then 
		select 	coalesce(max('S'),'N') 
		into STRICT	ie_atualizacao_w 
		from 	atualizacao_pep_usuario_v 
		where 	nr_atendimento = nr_atendimento_p 
		and		cd_profissional = cd_profissional_p 
		and  	ie_item = 2;
elsif (ie_opcao_p = 'AC') then 
 
	select  coalesce(max('S'),'N') 
	into STRICT	 ie_regra_w 
	from   atualizacao_pep_usuario_v x 
	where   x.cd_profissional = cd_profissional_p 
	and    x.nr_atendimento  = nr_atendimento_p 
	and	 (x.dt_atualizacao IS NOT NULL AND x.dt_atualizacao::text <> '')  LIMIT 1;
 
	if (ie_regra_w = 'S') then 
	 
		ie_atualizacao_w := 'N';
	 
	else 
		 
		select coalesce(max('S'),'N') 
		into STRICT	ie_atualizacao_w 
		from  	usuario d, 
			pep_acesso c, 
			pep_acesso_item a 
		where 	a.nr_seq_acesso	 = c.nr_sequencia 
		and  	c.nm_usuario 	 = d.nm_usuario 
		and  	d.cd_pessoa_fisica = cd_profissional_p 
		and  	c.nr_atendimento  = nr_atendimento_p 
		and  	a.nr_seq_item 	 = 5;	
		 
	end if;
	 
elsif (ie_opcao_p = 'P') then 
		select 	coalesce(max('S'),'N') 
		into STRICT	ie_atualizacao_w 
		from 	atualizacao_pep_usuario_v 
		where 	nr_atendimento = nr_atendimento_p 
		and		cd_profissional = cd_profissional_p 
		and  	ie_item = 1  LIMIT 1;
end if;
 
return ie_atualizacao_w;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_acessos_evol_pep (nr_atendimento_p bigint, cd_profissional_p text, ie_opcao_p text) FROM PUBLIC;

