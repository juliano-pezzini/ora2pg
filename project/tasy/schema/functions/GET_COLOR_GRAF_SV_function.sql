-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION get_color_graf_sv (cd_setor_atendimento_p sinal_vital_regra.cd_setor_atendimento%type, cd_pessoa_fisica_p pessoa_fisica.cd_pessoa_fisica%type, nr_seq_inf_p w_suep_item.nr_seq_inf%type, nr_sequencia_p w_suep_item.nr_seq_inf%type, nr_atendimento_p bigint) RETURNS varchar AS $body$
DECLARE

   ds_retorno_w        varchar(200);
   qt_idade_w          bigint;
   qt_idade_dia_w      bigint;
   exec_w              varchar(300);
   ie_sexo_w           pessoa_fisica.ie_sexo%type;

   c01 CURSOR FOR
     SELECT A.NR_ALTA_MODERADA_SUEP,
      A.NR_ALTA_SEVERA_SUEP,
      A.NR_BAIXA_MODERADA_SUEP,
      A.NR_BAIXA_SEVERA_SUEP
    FROM REGRA_SEVERIDADE_PEP_INF a,
    INFORMACAO_SUEP B
    WHERE a.NR_SEQ_PEP_INFORMACAO = B.NR_SEQ_INF 
    AND nr_seq_inf_p = B.NR_SEQUENCIA
    and (qt_idade_w  between coalesce(A.QT_IDADE_MIN,0) and coalesce(A.QT_IDADE_MAX,9999999999))
		and (qt_idade_dia_w between coalesce(A.qt_idade_min_dias,0) and coalesce(A.qt_idade_max_dias,9999999999))
		and	coalesce(A.CD_SETOR_ATENDIMENTO,Obter_Setor_Atendimento(nr_atendimento_p))	= Obter_Setor_Atendimento(nr_atendimento_p)
		and	coalesce(A.CD_ESTABELECIMENTO,Wheb_usuario_pck.get_cd_estabelecimento) = wheb_usuario_pck.get_cd_estabelecimento
		and	coalesce(A.CD_PERFIL,wheb_usuario_pck.get_cd_perfil) = wheb_usuario_pck.get_cd_perfil
		and	coalesce(A.IE_SEXO,ie_sexo_w) = ie_sexo_w
		order by coalesce(a.cd_setor_atendimento,0), coalesce(A.CD_ESCALA_DOR,'0') desc, coalesce(A.CD_ESTABELECIMENTO,0);

   c02 CURSOR FOR
      SELECT nr_pontuacao
        from (SELECT c.dt_informacao dt_pontuacao,
                     c.vl_informacao nr_pontuacao
                from w_suep_item b, w_suep_item_data c
               where b.nr_sequencia = c.nr_seq_suep_item
                 and b.nr_sequencia = nr_sequencia_p
               order by c.dt_informacao desc, c.nr_sequencia) alias0 ORDER by dt_pontuacao desc LIMIT 1;
   r02 c02%rowtype;

BEGIN

   select obter_idade_pf(cd_pessoa_fisica_p, clock_timestamp(), 'A'),
           obter_idade_pf(cd_pessoa_fisica_p, clock_timestamp(), 'DIA'),
           obter_sexo_pf(cd_pessoa_fisica_p, 'C'),
           SUEP_MD_PCK.GET_DEFAULT_COLOR_MD('thirdCell')
      into STRICT qt_idade_w, qt_idade_dia_w, ie_sexo_w,  ds_retorno_w
;

   for r_c01 in c01 loop

      open c02;
      loop
         fetch c02
            into r02;
         EXIT WHEN NOT FOUND; /* apply on c02 */
         exec_w := 'CALL SUEP_MD_PCK.GET_COLOR_THIRD_CELL_MD(:1, :2, :3, :4, :5) INTO :result';
        EXECUTE exec_w
            USING IN r02.nr_pontuacao, r_c01.nr_baixa_severa_SUEP, r_c01.nr_alta_severa_SUEP, r_c01.nr_baixa_moderada_suep, r_c01.nr_alta_moderada_suep,  OUT ds_retorno_w;
      end loop;
      close c02;
   end loop;

   return ds_retorno_w;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION get_color_graf_sv (cd_setor_atendimento_p sinal_vital_regra.cd_setor_atendimento%type, cd_pessoa_fisica_p pessoa_fisica.cd_pessoa_fisica%type, nr_seq_inf_p w_suep_item.nr_seq_inf%type, nr_sequencia_p w_suep_item.nr_seq_inf%type, nr_atendimento_p bigint) FROM PUBLIC;

