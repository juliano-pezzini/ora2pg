-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION sup_obter_destinatario_email ( nr_seq_comunicado_p bigint, nr_seq_localizacao_p bigint) RETURNS varchar AS $body$
DECLARE


ds_email_ww			varchar(4000);
ds_email_w			varchar(255);
qt_registro_w		bigint;
tam_lista_w			bigint;
ie_pos_semicolon_w	smallint	:= 0;

C01 CURSOR FOR
SELECT	distinct a.ds_email
from	man_pessoa_localizacao b,
	suporte_comunicado_dest a
where	a.cd_pessoa_fisica	= b.cd_pessoa_fisica
and	a.nr_seq_comunicado	= nr_seq_comunicado_p
and	b.nr_seq_localizacao	= nr_seq_localizacao_p
and	a.ie_enviar_email	= 'S'
order by 1;

C02 CURSOR FOR
SELECT 	coalesce(a.ds_email,wheb_obter_email_estab_pj(cd_cnpj))
from	suporte_comunicado_dest a,
	pessoa_juridica b
where	a.cd_cnpj = b.cd_cgc
and	a.nr_seq_comunicado	= nr_seq_comunicado_p;





BEGIN

open C01;
loop
fetch C01 into	
	ds_email_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
		if (ds_email_w IS NOT NULL AND ds_email_w::text <> '')then
			begin
				ie_pos_semicolon_w :=  position(';' in ds_email_w);
				while(ie_pos_semicolon_w <> 0) loop
					begin
						tam_lista_w			:= length(ds_email_w);
											
						if (ie_pos_semicolon_w <> 0) then
							ds_email_ww		:= ds_email_ww || substr(ds_email_w,1,(ie_pos_semicolon_w - 1)) || ';';
							ds_email_w		:= substr(ds_email_w, (ie_pos_semicolon_w + 1), tam_lista_w);
						end if;						
						
						ie_pos_semicolon_w			:= position(';' in ds_email_w);
					end;
				end loop;
				if (ds_email_w IS NOT NULL AND ds_email_w::text <> '')then
					ds_email_ww	:= ds_email_ww || ds_email_w || ';';	
				end if;	
			end;
		end if;
	end;
end loop;
close C01;

select 	count(*)
into STRICT	qt_registro_w
from	suporte_comunicado_dest a,
	pessoa_juridica b
where	a.cd_cnpj = b.cd_cgc
and	a.nr_seq_comunicado	= nr_seq_comunicado_p
and          (a.cd_cnpj IS NOT NULL AND a.cd_cnpj::text <> '');

if qt_registro_w > 0 then
	open C02;
	loop
	fetch C02 into	
		ds_email_w;
	EXIT WHEN NOT FOUND; /* apply on C02 */
		begin
			if (ds_email_w IS NOT NULL AND ds_email_w::text <> '')then
				begin
					ie_pos_semicolon_w :=  position(';' in ds_email_w);
					while(ie_pos_semicolon_w <> 0) loop
						begin
							tam_lista_w			:= length(ds_email_w);
												
							if (ie_pos_semicolon_w <> 0) then
								ds_email_ww		:= ds_email_ww || substr(ds_email_w,1,(ie_pos_semicolon_w - 1)) || ';';
								ds_email_w		:= substr(ds_email_w, (ie_pos_semicolon_w + 1), tam_lista_w);
							end if;						
							
							ie_pos_semicolon_w			:= position(';' in ds_email_w);
						end;
					end loop;
					if (ds_email_w IS NOT NULL AND ds_email_w::text <> '')then
						ds_email_ww	:= ds_email_ww || ds_email_w || ';';	
					end if;	
				end;
			end if;
		end;
	end loop;
	close C02;

end if;

return	ds_email_ww;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION sup_obter_destinatario_email ( nr_seq_comunicado_p bigint, nr_seq_localizacao_p bigint) FROM PUBLIC;

