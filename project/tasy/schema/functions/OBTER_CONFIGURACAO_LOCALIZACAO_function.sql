-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_configuracao_localizacao ( cd_estabelecimento_p bigint, ie_option_p text) RETURNS varchar AS $body$
DECLARE

  ds_retorno_w     varchar(255);
  nr_sequencia_w   varchar(10);
  ds_grupo_estab_w varchar(255);
  ds_count_w       bigint;
  c1 CURSOR FOR
    SELECT coalesce(a.nr_sequencia,0),
      coalesce(a.ds_grupo_estab,'')
    from wsuite_grupo_localizacao a
    where a.ie_situacao = 'A'
    and a.nr_sequencia  =
      (SELECT min( b.nr_grupo_local)
      from wsuite_grupo_loc_estab b
      where b.cd_estabelecimento = cd_estabelecimento_p
      and b.ie_situacao          = 'A'
      and (b.nr_grupo_local IS NOT NULL AND b.nr_grupo_local::text <> '')
      );
  c2 CURSOR FOR
    SELECT distinct coalesce(a.nr_sequencia,0) ,
      coalesce(a.ds_grupo_estab,'')
    from wsuite_grupo_localizacao a ,
      wsuite_grupo_loc_estab b
    where a.ie_situacao = 'A'
    and b.ie_situacao   = 'A'
    and a.nr_sequencia  = b.nr_grupo_local
    order by 1 asc LIMIT 1;

BEGIN
  ds_retorno_w := '0#@#';
  select coalesce(count(*),0)
  into STRICT ds_count_w
  from wsuite_grupo_loc_estab a
  where a.ie_situacao   = 'A'
  and a.nr_grupo_local in (SELECT nr_sequencia
    from wsuite_grupo_localizacao b
    where b.ie_situacao = 'A'
    );
  if (ie_option_p    = 'C') then
    ds_retorno_w   := ds_count_w;
  elsif (ie_option_p = 'N') then
    if (ds_count_w  <>0)then
      open c1;
      fetch c1 into nr_sequencia_w , ds_grupo_estab_w;
      ds_retorno_w := ds_count_w || '#@#' || nr_sequencia_w || '#@#' || ds_grupo_estab_w;
      close c1;
    end if;
  elsif (ie_option_p = 'D') then
    if (ds_count_w  <>0)then
      open c1;
      fetch c1 into nr_sequencia_w , ds_grupo_estab_w;
      if (nr_sequencia_w <> 0)then
        ds_retorno_w    := ds_count_w || '#@#' || nr_sequencia_w || '#@#' || ds_grupo_estab_w;
      else
        open c2;
        fetch c2 into nr_sequencia_w , ds_grupo_estab_w;
        ds_retorno_w := ds_count_w || '#@#' || nr_sequencia_w || '#@#' || ds_grupo_estab_w;
        close c2;
      end if;
      close c1;
    end if;
  end if;
return ds_retorno_w;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_configuracao_localizacao ( cd_estabelecimento_p bigint, ie_option_p text) FROM PUBLIC;

