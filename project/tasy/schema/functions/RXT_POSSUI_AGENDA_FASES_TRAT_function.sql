-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION rxt_possui_agenda_fases_trat ( nr_sequencia_p bigint) RETURNS varchar AS $body$
DECLARE


/* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Finalidade: Verifica se alguma fase do tratamento não possui agendamento.
-------------------------------------------------------------------------------------------------------------------
Locais de chamada direta: Gestão de Radioterapia > Pacientes em tratamento > Pacientes
[  ]  Objetos do dicionário [ x ] Tasy (Delphi/Java) [ ] Portal [  ]  Relatórios [ x ] Outros: IE_AGENDA_FASE_TRAT (RXT_TUMOR).
 ------------------------------------------------------------------------------------------------------------------
Pontos de atenção:
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */
nr_sequencia_w           		rxt_fase_tratamento.nr_sequencia%type;
nr_seq_volume_tratamento_w		rxt_fase_tratamento.nr_seq_volume_tratamento%type;
nr_seq_tratamento_w		rxt_tratamento.nr_sequencia%type;
ds_retorno_w             		varchar(1);

c01 CURSOR FOR
SELECT	a.nr_sequencia,
        a.nr_seq_volume_tratamento,
	c.nr_sequencia
FROM	rxt_fase_tratamento a,
        rxt_tumor b,
        rxt_tratamento c
WHERE  	c.nr_seq_tumor          = nr_sequencia_p
AND	c.nr_seq_tumor		= b.nr_sequencia
AND     a.nr_seq_Tratamento	= c.nr_sequencia
and	coalesce(c.dt_cancelamento::text, '') = ''
and	coalesce(c.dt_suspensao::text, '') = '';

BEGIN
if (nr_sequencia_p IS NOT NULL AND nr_sequencia_p::text <> '') then
	select	coalesce(max('S'),'N')
	into STRICT 	ds_retorno_w
	from	rxt_tratamento c,
		rxt_fase_tratamento d
	where	nr_sequencia_p = c.nr_seq_tumor
	and	d.nr_seq_tratamento = c.nr_sequencia
	and	coalesce(c.dt_suspensao::text, '') = ''
	and	coalesce(c.dt_cancelamento::text, '') = ''
	and	exists (SELECT	1
			from	rxt_tipo x,
				rxt_tumor z
			where	ie_tipo = 'T'
			and	x.nr_sequencia = z.nr_seq_tipo
			and	c.nr_seq_tumor = z.nr_sequencia);

	if (ds_retorno_w = 'S') then
		select  coalesce(max('S'),'N')
		into STRICT 	ds_retorno_w
		from    rxt_tratamento c,
			rxt_agenda d
		where   nr_sequencia_p = c.nr_seq_tumor
		and     d.nr_seq_tratamento = c.nr_sequencia
		and     d.ie_status_agenda in ('E' ,'F' ,'B','C', 'H')
		and	coalesce(c.dt_suspensao::text, '') = ''
		and	coalesce(c.dt_cancelamento::text, '') = ''
		and	exists (SELECT	1
			from	rxt_tipo x,
				rxt_tumor z
			where	ie_tipo = 'T'
			and	x.nr_sequencia = z.nr_seq_tipo
			and	c.nr_seq_tumor = z.nr_sequencia);

		if	(ds_retorno_w = 'S' AND ds_retorno_w IS NOT NULL AND ds_retorno_w::text <> '') then
			open c01;
	        	loop
	        	fetch c01 into	nr_sequencia_w,
	                        	nr_seq_volume_tratamento_w,
					nr_seq_tratamento_w;
	        	EXIT WHEN NOT FOUND or ds_retorno_w = 'N';  /* apply on c01 */
	                	if (nr_seq_volume_tratamento_w IS NOT NULL AND nr_seq_volume_tratamento_w::text <> '') then
	                		select	coalesce(max('S'),'N')
					into STRICT	ds_retorno_w
					FROM	rxt_agenda a,
						rxt_agenda_fase b
					WHERE	b.nr_seq_agenda_rxt	= a.nr_sequencia
					AND	a.nr_seq_tratamento	= nr_seq_tratamento_w
					AND	b.nr_seq_fase		= nr_sequencia_w;
					if (ds_retorno_w = 'S') then
						select	coalesce(max('N'),'S')
						into STRICT	ds_retorno_w
						FROM	rxt_agenda a,
							rxt_agenda_fase b
						WHERE	b.nr_seq_agenda_rxt	= a.nr_sequencia
						AND	a.nr_seq_tratamento	= nr_seq_tratamento_w
						AND	b.nr_seq_fase		= nr_sequencia_w
						and     a.ie_status_agenda not in ('E' ,'F' ,'B','C', 'H');
					end if;
		                else
					select	coalesce(max('S'),'N')
					into STRICT	ds_retorno_w
					FROM	rxt_agenda b
					WHERE	b.nr_seq_fase 		= nr_sequencia_w
					AND	b.nr_seq_tratamento	= nr_seq_tratamento_w;

					if (ds_retorno_w = 'S') then
						select	coalesce(max('N'),'S')
						into STRICT	ds_retorno_w
						FROM	rxt_agenda b
						WHERE	b.nr_seq_fase 		= nr_sequencia_w
						AND	b.nr_seq_tratamento	= nr_seq_tratamento_w
						and     b.ie_status_agenda not in ('E' ,'F' ,'B','C', 'H');
					end if;
		                end if;
	        	end loop;
	        	close c01;
		end if;
	end if;
end if;

return ds_retorno_w;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION rxt_possui_agenda_fases_trat ( nr_sequencia_p bigint) FROM PUBLIC;

