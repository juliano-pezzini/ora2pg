-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_se_doc_respondido ( nr_sequencia_p bigint, nm_usuario_p text ) RETURNS varchar AS $body$
DECLARE

ie_respondido_w			varchar(1);
ie_lido_w				varchar(1) := 'N';
nm_usuario_valid_w	varchar(20);
nm_usuario_aprov_w	varchar(20);
cd_pessoa_valid_w	bigint;
cd_pessoa_aprov_w	bigint;
ie_possui_revisao_w varchar(1);
cd_pessoa_elab_revis_w bigint;
nm_usuario_elab_revis_w varchar(20);

BEGIN

select	obter_se_doc_lido_usu( nr_sequencia_p , nm_usuario_p )
into STRICT	ie_lido_w
;

if (ie_lido_w = 'S') then
	begin
	select coalesce(max(a.ie_doc_resp),'N')
	into STRICT	ie_respondido_w
	from	qua_doc_log_acesso a
	where	a.nr_sequencia = (SELECT 	max(c.nr_sequencia)
							from	qua_doc_log_acesso c
							where	c.nr_seq_doc = nr_sequencia_p
							and		c.nm_usuario = nm_usuario_p
							and		((c.dt_atualizacao > to_date(substr(qua_obter_dados_documento(nr_sequencia_p,'AR'),1,19), 'dd/mm/yyyy hh24:mi:ss'))
							or (to_date(substr(qua_obter_dados_documento(nr_sequencia_p,'AR'),1,19), 'dd/mm/yyyy hh24:mi:ss') is null))
							and		c.ie_doc_resp = 'S'
							and		c.ie_log = 'C')
	and		(a.ie_doc_resp IS NOT NULL AND a.ie_doc_resp::text <> '');

	if (ie_respondido_w = 'N') then
		begin
		
		select	CASE WHEN count(*)=0 THEN 'N'  ELSE 'S' END
		into STRICT 	ie_possui_revisao_w
		from	qua_doc_revisao
		where	nr_seq_doc = nr_sequencia_p;
		
		if (ie_possui_revisao_w = 'S') then
			select	max(cd_pessoa_validacao),
					max(cd_pessoa_aprovacao),
					max(cd_pessoa_revisao)
			into STRICT	cd_pessoa_valid_w,
					cd_pessoa_aprov_w,
					cd_pessoa_elab_revis_w
			from 	qua_doc_revisao
			where	nr_seq_doc = nr_sequencia_p
			and	    nr_sequencia = (SELECT	max(nr_sequencia)
									from	qua_doc_revisao
									where	nr_seq_doc = nr_sequencia_p);
		else
			select	max(cd_pessoa_validacao),
					max(cd_pessoa_aprov),
					max(cd_pessoa_elaboracao)
			into STRICT	cd_pessoa_valid_w,
					cd_pessoa_aprov_w,
					cd_pessoa_elab_revis_w
			from	qua_documento
			where	nr_sequencia = nr_sequencia_p;
		end if;
		
		select	max(nm_usuario)
		into STRICT	nm_usuario_valid_w
		from	usuario
		where	cd_pessoa_fisica = cd_pessoa_valid_w;

		select	max(nm_usuario)
		into STRICT	nm_usuario_aprov_w
		from	usuario
		where	cd_pessoa_fisica = cd_pessoa_aprov_w;
		
		select	max(nm_usuario)
		into STRICT	nm_usuario_elab_revis_w
		from	usuario
		where	cd_pessoa_fisica = cd_pessoa_elab_revis_w;
		
		
		if (nm_usuario_aprov_w = nm_usuario_p) or (nm_usuario_valid_w = nm_usuario_p) or (nm_usuario_elab_revis_w = nm_usuario_p) then
			ie_respondido_w := 'S';
		end if;

		if (ie_respondido_w = 'N') then
			select	CASE WHEN count(*)=0 THEN 'N'  ELSE 'S' END
			into STRICT	ie_respondido_w
			from	qua_doc_participante
			where	nr_seq_doc = nr_sequencia_p
			and		cd_participante = (	SELECT	max(cd_pessoa_fisica)
										from	usuario
										where	nm_usuario = nm_usuario_p);
		end if;
		
		end;
	end if;
	end;
else
	ie_respondido_w := 'N';
end if;

return	ie_respondido_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_se_doc_respondido ( nr_sequencia_p bigint, nm_usuario_p text ) FROM PUBLIC;

