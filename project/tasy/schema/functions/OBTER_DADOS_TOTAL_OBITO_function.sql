-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_dados_total_obito (dt_referencia_p text, ie_opcao_p text, ds_opcao_p text DEFAULT '') RETURNS varchar AS $body$
DECLARE

 
qt_obito_masculino_w		bigint;
qt_obito_feminino_w		bigint;
qt_obito_indefinido_w		bigint;
qt_obito_total_w		bigint;

qt_obito_naturalidade_w		bigint;
qt_obito_etaria_w		bigint;
qt_obito_causa_w		bigint;
qt_obito_setor_w		bigint;

dt_referencia_w			varchar(10);
qt_resultado_w			bigint;

/* 
OSM	- Quantidade óbito Masculino 
OSF	- Quantidade óbito Feminino 
OSI	- Quantidade óbito Indefinido 
OST	- Quantidade óbito Total 
 
ONA	- Óbitos por Naturalidade 
OFE	- Óbitos por Faixa Etária 
OCM	- Óbitos por Causa 
OSO	- Óbitos por Setor 
*/
 
 

BEGIN 
 
if	(dt_referencia_p IS NOT NULL AND dt_referencia_p::text <> '' AND ie_opcao_p IS NOT NULL AND ie_opcao_p::text <> '') then 
	if (length(dt_referencia_p) < 10) then 
		dt_referencia_w := substr('0' || dt_referencia_p,1,10);
	else 
		dt_referencia_w := substr(dt_referencia_p,1,10);
	end if;
	 
	if (ie_opcao_p = 'OSM') then 
	 
		select		count(*) 
		into STRICT		qt_obito_masculino_w 
		from		atendimento_paciente a, 
				pessoa_fisica b, 
				motivo_alta d 
		where		a.cd_pessoa_fisica = b.cd_pessoa_fisica 
		and		a.cd_motivo_alta = d.cd_motivo_alta 
		and		d.ie_obito = 'S' 
		and		(a.dt_alta IS NOT NULL AND a.dt_alta::text <> '') 
		and		upper(b.ie_sexo) = 'M' 
		and		to_char(a.dt_alta,'dd/mm/yyyy') = dt_referencia_w;
		 
		qt_resultado_w := qt_obito_masculino_w;
		 
	elsif (ie_opcao_p = 'OSF') then 
	 
		select		count(*) 
		into STRICT		qt_obito_feminino_w 
		from		atendimento_paciente a, 
				pessoa_fisica b, 
				motivo_alta d 
		where		a.cd_pessoa_fisica = b.cd_pessoa_fisica 
		and		a.cd_motivo_alta = d.cd_motivo_alta 
		and		d.ie_obito = 'S' 
		and		(a.dt_alta IS NOT NULL AND a.dt_alta::text <> '') 
		and		upper(b.ie_sexo) = 'F' 
		and		to_char(a.dt_alta,'dd/mm/yyyy') = dt_referencia_w;
		 
		qt_resultado_w := qt_obito_feminino_w;
		 
	elsif (ie_opcao_p = 'OSI') then 
	 
		select		count(*) 
		into STRICT		qt_obito_indefinido_w 
		from		atendimento_paciente a, 
				pessoa_fisica b, 
				motivo_alta d 
		where		a.cd_pessoa_fisica = b.cd_pessoa_fisica 
		and		a.cd_motivo_alta = d.cd_motivo_alta 
		and		d.ie_obito = 'S' 
		and		(a.dt_alta IS NOT NULL AND a.dt_alta::text <> '') 
		and		coalesce(b.ie_sexo::text, '') = '' 
		and		to_char(a.dt_alta,'dd/mm/yyyy') = dt_referencia_w;
		 
		qt_resultado_w := qt_obito_indefinido_w;
		 
	elsif (ie_opcao_p = 'OST') then 
	 
		select		count(*) 
		into STRICT		qt_obito_total_w 
		from		atendimento_paciente a, 
				pessoa_fisica b, 
				motivo_alta d 
		where		a.cd_pessoa_fisica = b.cd_pessoa_fisica 
		and		a.cd_motivo_alta = d.cd_motivo_alta 
		and		d.ie_obito = 'S' 
		and		(a.dt_alta IS NOT NULL AND a.dt_alta::text <> '') 
		and		to_char(a.dt_alta,'dd/mm/yyyy') = dt_referencia_w;
		 
		qt_resultado_w := qt_obito_total_w;
		 
	elsif (ie_opcao_p = 'ONA') then 
	 
		select		count(*) 
		into STRICT		qt_obito_naturalidade_w 
		from		eis_obitos_v a 
		where		to_char(a.dt_obito,'dd/mm/yyyy') = dt_referencia_w 
		and		substr(a.ds_naturalidade,1,255) = ds_opcao_p;
		 
		qt_resultado_w := qt_obito_naturalidade_w;
		 
	elsif (ie_opcao_p = 'OFE') then 
	 
		select		count(*) 
		into STRICT		qt_obito_etaria_w 
		from		eis_obitos_v a 
		where		to_char(a.dt_obito,'dd/mm/yyyy') = dt_referencia_w 
		and		substr(a.ie_faixa_etaria,1,255) = ds_opcao_p;
		 
		qt_resultado_w := qt_obito_etaria_w;
		 
	elsif (ie_opcao_p = 'OCM') then 
	 
		select		count(*) 
		into STRICT		qt_obito_causa_w 
		from		eis_obitos_v a 
		where		to_char(a.dt_obito,'dd/mm/yyyy') = dt_referencia_w 
		and		coalesce(substr(a.ds_causa_morte,1,255), obter_desc_expressao(327119)) = ds_opcao_p;
		 
		qt_resultado_w := qt_obito_causa_w;
		 
	elsif (ie_opcao_p = 'OSO') then 
	 
		select		count(*) 
		into STRICT		qt_obito_setor_w 
		from		eis_obitos_v a 
		where		to_char(a.dt_obito,'dd/mm/yyyy') = dt_referencia_w 
		and		coalesce(substr(a.ds_setor_obito,1,255), obter_desc_expressao(327119)) = ds_opcao_p;
		 
		qt_resultado_w := qt_obito_setor_w;
		 
	end if;
end if;
 
if (qt_resultado_w = 0) then 
	return null;
else 
	return qt_resultado_w;
end if;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_dados_total_obito (dt_referencia_p text, ie_opcao_p text, ds_opcao_p text DEFAULT '') FROM PUBLIC;

