-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION consistir_idade_paciente_proc ( cd_pessoa_fisica_p text, cd_procedimento_p bigint, ie_origem_proced_p bigint) RETURNS varchar AS $body$
DECLARE


qt_idade_w		bigint;
qt_idade_min_w		smallint;
qt_idade_max_w		smallint;

/*
	S - Idade está dentro do período min / max permitida para o Procedimento
	N - Idade está fora do período min / max permitida para o Procedimento
*/
BEGIN

if (ie_origem_proced_p = 7) then

	begin
	select 	somente_numero(SUS_CONVERTE_IDADE_ANOS(qt_idade_minima,'D')),
		somente_numero(SUS_CONVERTE_IDADE_ANOS(qt_idade_maxima,'D'))
	into STRICT	qt_idade_min_w,
		qt_idade_max_w
	from 	sus_procedimento
	where 	cd_procedimento = cd_procedimento_p
	and 	ie_origem_proced = ie_origem_proced_p;
	exception
		when others then
			qt_idade_min_w	:= null;
			qt_idade_max_w	:= null;
	end;

else

	begin
	select	qt_idade_minima_sus,
		qt_idade_maxima_sus
	into STRICT	qt_idade_min_w,
		qt_idade_max_w
	from 	procedimento
	where	cd_procedimento  = cd_procedimento_p
	and	ie_origem_proced = ie_origem_proced_p;

	exception
		when others then
			qt_idade_min_w	:= null;
			qt_idade_max_w	:= null;
	end;

end if;

if	((qt_idade_min_w IS NOT NULL AND qt_idade_min_w::text <> '') or (qt_idade_max_w IS NOT NULL AND qt_idade_max_w::text <> '')) then

	begin
	select	obter_idade(dt_nascimento,clock_timestamp(),'A')
	into STRICT	qt_idade_w
	from	pessoa_fisica
	where 	cd_pessoa_fisica = cd_pessoa_fisica_p;
	exception
	when others then
		qt_idade_w	:= null;
	end;

	if (qt_idade_w IS NOT NULL AND qt_idade_w::text <> '') then

		if	((qt_idade_w 	>  coalesce(qt_idade_min_w,0)) or (qt_idade_w = qt_idade_min_w and qt_idade_w = 0)) and (qt_idade_w	<  coalesce(qt_idade_max_w,999)) then
			return	'S';
		else
			return	'N';
		end	if;
	else
		return	'S';
	end	if;
else
	return	'S';
end	if;

end	;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION consistir_idade_paciente_proc ( cd_pessoa_fisica_p text, cd_procedimento_p bigint, ie_origem_proced_p bigint) FROM PUBLIC;

