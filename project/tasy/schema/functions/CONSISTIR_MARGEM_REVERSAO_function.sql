-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION consistir_margem_reversao ( nr_seq_horario_p bigint, ie_tipo_item_p text, qt_min_margem_p bigint, cd_perfil_p bigint, ie_opcao_p text, qt_min_margem_ant_p bigint default null) RETURNS varchar AS $body$
DECLARE

/*
ie_opcao_p
	M - Margem em miinutos
	S - Se está na margem ou não
*/
ie_margem_w		varchar(1);
ie_tipo_margem_w	varchar(1);
dt_horario_w		timestamp;
qt_min_adm_w		bigint;
qt_min_margem_apos_w	bigint;
qt_min_margem_ant_w	bigint;
cd_material_w		bigint;
ie_checagem_w		varchar(1);


BEGIN

qt_min_margem_apos_w	:= coalesce(qt_min_margem_p,0);
qt_min_margem_ant_w	:= coalesce(qt_min_margem_ant_p,0);
ie_margem_w := 'S';
if (nr_seq_horario_p IS NOT NULL AND nr_seq_horario_p::text <> '') and (ie_tipo_item_p IS NOT NULL AND ie_tipo_item_p::text <> '') and
	((qt_min_margem_apos_w > 0) or (qt_min_margem_ant_w > 0)) then

	/* obter horário */

	if (ie_tipo_item_p in ('IAH', 'M','S','LD')) then
		select	max(dt_horario),
			coalesce(max(ie_checagem),'N'),
			max(cd_material)
		into STRICT	dt_horario_w,
			ie_checagem_w,
			cd_material_w
		from	prescr_mat_hor
		where	nr_sequencia = nr_seq_horario_p
		and	Obter_se_horario_liberado(dt_lib_horario, dt_horario) = 'S';

		select	coalesce(max(qt_minutos), qt_min_margem_apos_w)
		into STRICT	qt_min_margem_apos_w
		from	adep_regra_margem_adm
		where	coalesce(cd_perfil, cd_perfil_p) = cd_perfil_p
		and	coalesce(cd_material,cd_material_w)	= cd_material_w;

	--elsif	(ie_tipo_item_p = 'P') then
	elsif (ie_tipo_item_p in ('P','G','C')) then
		select	max(dt_horario),
			coalesce(max(ie_checagem),'N')
		into STRICT	dt_horario_w,
			ie_checagem_w
		from	prescr_proc_hor
		where	nr_sequencia = nr_seq_horario_p
		and	Obter_se_horario_liberado(dt_lib_horario, dt_horario) = 'S';
	elsif (ie_tipo_item_p = 'R') then
		select	max(dt_horario),
			coalesce(max(ie_checagem),'N')
		into STRICT	dt_horario_w,
			ie_checagem_w
		from	prescr_rec_hor
		where	nr_sequencia = nr_seq_horario_p
		and	Obter_se_horario_liberado(dt_lib_horario, dt_horario) = 'S';
	elsif (ie_tipo_item_p = 'E') then
		select	max(dt_horario),
			coalesce(max(ie_checagem),'N')
		into STRICT	dt_horario_w,
			ie_checagem_w
		from	pe_prescr_proc_hor
		where	nr_sequencia = nr_seq_horario_p;
	elsif (ie_tipo_item_p = 'D') then
		select	max(dt_horario),
			coalesce(max(ie_checagem),'N')
		into STRICT	dt_horario_w,
			ie_checagem_w
		from	prescr_dieta_hor
		where	nr_sequencia = nr_seq_horario_p
		and	Obter_se_horario_liberado(dt_lib_horario, dt_horario) = 'S';
	end if;

	/* obter margem adm */

	if (ie_checagem_w <> 'L') then
		--select	trunc(abs(sysdate - dt_horario_w) * 1440)
		if	((qt_min_margem_apos_w > 0) or (qt_min_margem_ant_w > 0)) then

			if (clock_timestamp() > dt_horario_w) then

				select	trunc(abs(clock_timestamp() - dt_horario_w) * 1440)
				into STRICT	qt_min_adm_w
				;

				/* validar horário x margem */

				if (qt_min_adm_w > qt_min_margem_apos_w) then
					ie_margem_w := 'N';
					ie_tipo_margem_w := 'D';
				end if;

			elsif (dt_horario_w < clock_timestamp()) then

				select	trunc(abs(dt_horario_w - clock_timestamp()) * 1440)
				into STRICT	qt_min_adm_w
				;

				/* validar horário x margem */

				if (qt_min_adm_w > qt_min_margem_ant_w) then
					ie_margem_w := 'N';
					ie_tipo_margem_w := 'A';
				end if;
			end if;
		end if;

	else
		ie_margem_w := 'S';
	end if;
end if;

if (ie_opcao_p	= 'M') then
	if (ie_tipo_margem_w	= 'D') then
		return to_char(qt_min_margem_apos_w);
	elsif (ie_tipo_margem_w	= 'A') then
		return to_char(qt_min_margem_ant_w);
	else	return '0';
	end if;
else
	return ie_margem_w;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION consistir_margem_reversao ( nr_seq_horario_p bigint, ie_tipo_item_p text, qt_min_margem_p bigint, cd_perfil_p bigint, ie_opcao_p text, qt_min_margem_ant_p bigint default null) FROM PUBLIC;

