-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION cpoe_get_if_narcotic_allowed ( nm_usuario_p text, cd_material_p bigint, dt_reference_p timestamp) RETURNS varchar AS $body$
DECLARE

														
ie_allowed_w varchar(1)	:= 'Y';
is_narcotic_w	varchar(1)	:= 'N';
doctor_has_valid_license_w	varchar(1)	:= 'Y';

BEGIN

if (obtain_user_locale(nm_usuario_p) = 'ja_JP') then
	begin
	select	CASE WHEN ie_receita='S' THEN 'Y'  ELSE 'N' END 
	into STRICT	is_narcotic_w
	FROM	material
	WHERE  	cd_material = cd_material_p;
	exception
		when others then
		is_narcotic_w	:= 'N';
	end;
	
	begin
	select	CASE WHEN count(1)=0 THEN 'N'  ELSE 'Y' END
	into STRICT	doctor_has_valid_license_w
	FROM	pessoa_documentacao c,
			medico b,
			usuario a
	WHERE  	b.cd_pessoa_fisica = c.cd_pessoa_fisica
	and		a.cd_pessoa_fisica = b.cd_pessoa_fisica
	and		a.nm_usuario	= nm_usuario_p
	AND 	si_special_license = '1'
	AND 	dt_reference_p >= dt_start
	AND 	dt_reference_p <= dt_validade
	and		(nr_document IS NOT NULL AND nr_document::text <> '');
	exception
		when others then
		doctor_has_valid_license_w	:= 'Y';
	end;


	if (is_narcotic_w = 'Y') and (doctor_has_valid_license_w = 'N') then
		ie_allowed_w	:= 'N';
	end if;
end if;

RETURN ie_allowed_w;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION cpoe_get_if_narcotic_allowed ( nm_usuario_p text, cd_material_p bigint, dt_reference_p timestamp) FROM PUBLIC;

