-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_data_venc_amostra ( nr_seq_armazena_rack_p bigint, nr_seq_amostra_rack_p bigint, ie_acao_p text) RETURNS timestamp AS $body$
DECLARE

nr_seq_grupo_w          bigint;
qt_dias_armazenamento_w smallint;
dt_armazenamento_w      timestamp;

BEGIN
  select max(el.nr_seq_grupo)
    into STRICT nr_seq_grupo_w
    from lab_soro_exame_amostra lsar
   inner join prescr_procedimento pp on pp.nr_prescricao = lsar.nr_prescricao and pp.nr_sequencia = lsar.nr_seq_prescr
   inner join exame_laboratorio el on el.nr_seq_exame = pp.nr_seq_exame
   where lsar.nr_seq_amostra_rack = nr_seq_amostra_rack_p;

  select max(lsge.qt_dias_armazenamento)
    into STRICT qt_dias_armazenamento_w
    from LAB_SORO_ARMAZENA_RACK lsar
   inner join LAB_SORO_ARMAZENAMENTO lsa on lsa.nr_sequencia = lsar.nr_seq_armazenamento_prim
   inner join LAB_SORO_GRUPO_EXAME lsge on lsge.nr_seq_armazenamento = lsa.nr_sequencia and
                                           lsge.ie_situacao = 'A' and
                                           lsge.nr_seq_grupo = nr_seq_grupo_w
   where lsar.nr_sequencia = nr_seq_armazena_rack_p;

   if (coalesce(qt_dias_armazenamento_w::text, '') = '') then
      select coalesce(max(QT_DIAS_ARMAZENAMENTO), 0)
        into STRICT qt_dias_armazenamento_w
        from GRUPO_EXAME_LAB
       where nr_sequencia = nr_seq_grupo_w;
   end if;

   select min(dt_acao)
     into STRICT dt_armazenamento_w
     from lab_soro_processo_info
    where IE_ACAO = ie_acao_p and
          nr_seq_armazena_rack = nr_seq_armazena_rack_p and
          nr_seq_amostra_rack = nr_seq_amostra_rack_p;

return dt_armazenamento_w + qt_dias_armazenamento_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_data_venc_amostra ( nr_seq_armazena_rack_p bigint, nr_seq_amostra_rack_p bigint, ie_acao_p text) FROM PUBLIC;

