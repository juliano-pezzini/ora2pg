-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION pls_obter_mensagem_reajuste ( nr_seq_mensalidade_p bigint, qt_linha_p bigint, ie_opcao_p text) RETURNS varchar AS $body$
DECLARE


/*	ie_opcao_p
	'R' = Mensagem Reajuste
	'RP' = Mensagem Reajuste + Produto
	'RI' = Mensagem para Interface
	'RA'= Mensagem para Interface (reajuste retroativo)
*/
ds_retorno_w		varchar(4000);
ds_mensagem_reajuste_w	varchar(2000);
nr_seq_plano_w		bigint;
ds_plano_w		varchar(255);
vl_item_w		double precision;
nr_seq_reajuste_w	bigint;
dt_referencia_w		timestamp;
nr_seq_lote_reajuste_w	bigint;
ds_oficio_ans_w		varchar(255);
tx_reajuste_w		double precision;
nr_seq_pagador_w	bigint;
dt_contrato_w		timestamp;
ie_aniver_contrato_w	varchar(1) := 'N';
dt_reajuste_aux_w	varchar(7);
dt_reajuste_w		timestamp;
ie_tipo_item_w		varchar(2);
dt_periodo_inicial_w	timestamp;
dt_periodo_final_w	timestamp;

C01 CURSOR FOR
	SELECT	a.ds_mensagem_reajuste,
		max(b.nr_seq_plano),
		sum(coalesce(a.vl_item,0)),
		b.dt_mesano_referencia,
		max(b.nr_seq_reajuste),
		c.nr_seq_pagador,
		a.ie_tipo_item
	from	pls_mensalidade_seg_item	a,
		pls_mensalidade_segurado	b,
		pls_mensalidade			c
	where	a.nr_seq_mensalidade_seg	= b.nr_sequencia
	and	b.nr_seq_mensalidade		= c.nr_sequencia
	and	c.nr_sequencia			= nr_seq_mensalidade_p
	and	a.ie_tipo_item			in (25,4,5)
	and	(a.ds_mensagem_reajuste IS NOT NULL AND a.ds_mensagem_reajuste::text <> '')
	group by a.ds_mensagem_reajuste,
		b.dt_mesano_referencia,
		c.nr_seq_pagador,
		a.ie_tipo_item;


BEGIN

open C01;
loop
fetch C01 into
	ds_mensagem_reajuste_w,
	nr_seq_plano_w,
	vl_item_w,
	dt_referencia_w,
	nr_seq_reajuste_w,
	nr_seq_pagador_w,
	ie_tipo_item_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	if (ie_opcao_p	= 'R') then
		ds_retorno_w	:= ds_mensagem_reajuste_w;
	elsif (ie_opcao_p	= 'RP') then
		select	max(ds_plano)
		into STRICT	ds_plano_w
		from	pls_plano
		where	nr_sequencia	= nr_seq_plano_w;

		ds_retorno_w	:= ds_mensagem_reajuste_w || chr(13) || chr(10) || 'Produto: ' || ds_plano_w;
	elsif (ie_opcao_p	= 'RI') then
		if (qt_linha_p = 1) then
			ds_retorno_w	:= substr(ds_mensagem_reajuste_w,1,position(chr(13) in ds_mensagem_reajuste_w)-1);

		elsif (qt_linha_p = 2) then
			ds_retorno_w	:= substr(ds_mensagem_reajuste_w,position(chr(10) in ds_mensagem_reajuste_w) + 1,length(ds_mensagem_reajuste_w));

		elsif (qt_linha_p = 3) then
			select	max(ds_plano)
			into STRICT	ds_plano_w
			from	pls_plano
			where	nr_sequencia	= nr_seq_plano_w;

			ds_retorno_w := 'Produto: ' || ds_plano_w;
		end if;
	elsif (ie_opcao_p	= 'RA') then
		-- Ajuste realizado de acordo com a OS 473969
		if (ie_tipo_item_w in (25,4)) then
			begin
			select	coalesce(a.dt_reajuste,a.dt_contrato)
			into STRICT	dt_contrato_w
			from	pls_contrato_pagador	b,
				pls_contrato		a
			where	a.nr_sequencia		= b.nr_seq_contrato
			and	b.nr_sequencia		= nr_seq_pagador_w;
			exception
			when others then
				dt_contrato_w := null;
			end;

			if (to_char(trunc(dt_contrato_w,'month'),'MM') = to_char(trunc(dt_referencia_w,'month'),'MM')) then
				ie_aniver_contrato_w := 'S';
			else
				ie_aniver_contrato_w := 'N';
			end if;

			select	max(nr_seq_lote_reajuste)
			into STRICT	nr_seq_lote_reajuste_w
			from	pls_segurado_preco
			where	nr_seq_reajuste = nr_seq_reajuste_w;

			if (coalesce(nr_seq_lote_reajuste_w::text, '') = '') then
				select	max(nr_seq_reajuste)
				into STRICT	nr_seq_lote_reajuste_w
				from	pls_reajuste_preco
				where	nr_sequencia	= nr_seq_reajuste_w;
			end if;

			select	max(ds_oficio_ans),
				max(tx_reajuste),
				max(dt_reajuste_aux),
				max(dt_reajuste),
				max(dt_periodo_inicial)
			into STRICT	ds_oficio_ans_w,
				tx_reajuste_w,
				dt_reajuste_aux_w,
				dt_reajuste_w,
				dt_periodo_inicial_w
			from	pls_reajuste
			where	nr_sequencia	= nr_seq_lote_reajuste_w;

			if (qt_linha_p = 1) then
				if (ie_aniver_contrato_w = 'N') then
					ds_retorno_w	:= 'ANS autorizou '||to_char(tx_reajuste_w)||'% de reajuste, cobranca retroativa ref. mens de '
							||to_char(dt_reajuste_w,'mm/yyyy');
				else
					ds_retorno_w 	:= 'A ANS autorizou '||to_char(tx_reajuste_w)||
							'% de reajuste na MENSALIDE e CO-PART. a partir de '||to_char(dt_periodo_inicial_w,'MM/YYYY')
							||', Ind/Familiar.';
				end if;

			elsif (qt_linha_p = 2) then
				if (ie_aniver_contrato_w = 'N') then
					ds_retorno_w	:= 'Oficio autorizativo nº '||ds_oficio_ans_w;
				else
					ds_retorno_w 	:= 'Oficio autorizativo nº '||ds_oficio_ans_w;
				end if;

			elsif (qt_linha_p = 3) then
				if (ie_aniver_contrato_w = 'N') then
					ds_retorno_w	:= 'Valor cobrança retroativa: '||campo_mascara_virgula(vl_item_w);
				else
					ds_retorno_w 	:= ' ';
				end if;
			end if;
		end if;
	elsif (ie_opcao_p	= 'RS') then
		if (ie_tipo_item_w in (25,4,5)) then
			select	max(nr_seq_lote_reajuste)
			into STRICT	nr_seq_lote_reajuste_w
			from	pls_segurado_preco
			where	nr_seq_reajuste = nr_seq_reajuste_w;

			if (coalesce(nr_seq_lote_reajuste_w::text, '') = '') then
				select	max(nr_seq_reajuste)
				into STRICT	nr_seq_lote_reajuste_w
				from	pls_reajuste_preco
				where	nr_sequencia	= nr_seq_reajuste_w;
			end if;

			begin
			select	coalesce(a.dt_reajuste,a.dt_contrato)
			into STRICT	dt_contrato_w
			from	pls_contrato_pagador	b,
				pls_contrato		a
			where	a.nr_sequencia		= b.nr_seq_contrato
			and	b.nr_sequencia		= nr_seq_pagador_w;
			exception
			when others then
				dt_contrato_w := null;
			end;

			if (to_char(trunc(dt_contrato_w,'month'),'MM') = to_char(trunc(dt_referencia_w,'month'),'MM')) then
				ie_aniver_contrato_w := 'S';
			else
				ie_aniver_contrato_w := 'N';
			end if;

			select	max(ds_oficio_ans),
				max(tx_reajuste),
				max(dt_reajuste_aux),
				max(dt_reajuste),
				max(dt_periodo_inicial),
				max(dt_periodo_final)
			into STRICT	ds_oficio_ans_w,
				tx_reajuste_w,
				dt_reajuste_aux_w,
				dt_reajuste_w,
				dt_periodo_inicial_w,
				dt_periodo_final_w
			from	pls_reajuste
			where	nr_sequencia	= nr_seq_lote_reajuste_w;

			if (qt_linha_p = 1) then
				ds_retorno_w := 'Reajuste ANS de '||to_char(tx_reajuste_w)||'% conforme Ofício '||
					coalesce(ds_oficio_ans_w,'1806/2012/GGEFP/DIPRO')||', a partir de '||to_char(coalesce(dt_periodo_inicial_w,dt_reajuste_w),'mm/yyyy')||'.';
			elsif (qt_linha_p = 2) and (ie_tipo_item_w = 5) then
				ds_retorno_w := 'Reajuste mês '||elimina_caracteres_especiais(to_char(dt_reajuste_w, 'month'))||', em virtude de mudança de faixa etária do(a) beneficiário(a) ';
			elsif (qt_linha_p = 3) and (dt_contrato_w between dt_periodo_inicial_w and dt_periodo_final_w) then
				ds_retorno_w := 'Período para exercer portabilidade de ' || to_char(dt_periodo_inicial_w,'dd/mm/yyyy') || ' à ' || to_char(dt_periodo_final_w,'dd/mm/yyyy');
			end if;
		end if;
	end if;
	end;
end loop;
close C01;

return	ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION pls_obter_mensagem_reajuste ( nr_seq_mensalidade_p bigint, qt_linha_p bigint, ie_opcao_p text) FROM PUBLIC;

