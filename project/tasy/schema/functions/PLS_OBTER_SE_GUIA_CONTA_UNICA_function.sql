-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION pls_obter_se_guia_conta_unica ( cd_estabelecimento_p bigint, cd_guia_p text, nr_seq_conta_p bigint, nr_seq_protocolo_p bigint) RETURNS varchar AS $body$
DECLARE

 
ds_retorno_w			varchar(255);
ie_guia_unica_w			varchar(2);					
qt_guias_iguais_w		bigint;
ie_apresentacao_conta_w		varchar(10);

/*OS328581 - Verifica se o número de guia informado na conta já existe em outra conta*/
					 

BEGIN 
ds_retorno_w	:= '';
 
select	coalesce(max(ie_guia_unica),'N') 
into STRICT	ie_guia_unica_w 
from  	pls_parametros 
where 	cd_estabelecimento	= cd_estabelecimento_p;
 
/* Não tratar a rotina para protocolos de reapresentação */
 
select	max(ie_apresentacao) 
into STRICT	ie_apresentacao_conta_w 
from	pls_protocolo_conta a 
where	a.nr_sequencia = nr_seq_protocolo_p;
 
if (coalesce(ie_apresentacao_conta_w,'X') <> 'R') then 
	select count(1) 
	into STRICT	qt_guias_iguais_w 
	from 	pls_conta 
	where	cd_guia		= 	cd_guia_p 
	and	nr_sequencia	= 	nr_seq_conta_p;
 
	if (qt_guias_iguais_w = 1) then 
		ds_retorno_w 	:= '';
	else 
		select	count(1) 
		into STRICT	qt_guias_iguais_w 
		from	pls_protocolo_conta b, 
			pls_conta a 
		where	a.cd_guia		= cd_guia_p 
		and	((a.ie_glosa 	!= 'S')	or (coalesce(a.ie_glosa::text, '') = '')) 
		and	a.nr_seq_protocolo 	= b.nr_sequencia 
		and	b.ie_apresentacao 	!= 'R' 
		and	((a.ie_status	!= 'C') or (coalesce(a.ie_status::text, '') = '')) 
		and	exists	(	SELECT	1 
					from	pls_protocolo_conta x 
					where	x.nr_sequencia = a.nr_seq_protocolo 
					and	((x.ie_situacao != 'RE') or (coalesce(x.ie_situacao::text, '') = '')) 
					);
		 
		if	(ie_guia_unica_w = 'S' AND qt_guias_iguais_w > 0) then 
			ds_retorno_w	:= 'Guia número ''' || cd_guia_p || ''' já está cadastrada!';
		end if;	
	end if;
end if;
 
return	ds_retorno_w;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION pls_obter_se_guia_conta_unica ( cd_estabelecimento_p bigint, cd_guia_p text, nr_seq_conta_p bigint, nr_seq_protocolo_p bigint) FROM PUBLIC;

