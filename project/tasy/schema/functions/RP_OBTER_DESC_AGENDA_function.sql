-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION rp_obter_desc_agenda (cd_tipo_agenda_p bigint, cd_agenda_p bigint) RETURNS varchar AS $body$
DECLARE

ds_agenda_w		varchar(255);
nm_usuario_w		varchar(15);
cd_estabelecimento_w	smallint;
cd_pessoa_fisica_w	varchar(10);

BEGIN
nm_usuario_w := wheb_usuario_pck.get_nm_usuario;
cd_estabelecimento_w := wheb_usuario_pck.get_cd_estabelecimento;
cd_pessoa_fisica_w := Obter_Pessoa_Fisica_Usuario(nm_usuario_w, 'C');
 
if (cd_tipo_agenda_p = 1) then 
	select	max(substr(ds_agenda,1,255)) 
	into STRICT	ds_agenda_w 
	from	agenda 
	where  ie_situacao = 'A' 
	and   cd_tipo_agenda = 1 
	and	cd_agenda = cd_agenda_p 
	and   substr(Obter_Se_Perm_AgeCirur(cd_pessoa_fisica, 5621101,1939,cd_agenda),1,1) <> 'N' 
	and   coalesce(cd_setor_exclusivo::text, '') = '' 
	and   cd_estabelecimento = 1 
	order by coalesce(nr_seq_apresent,0), ds_agenda;
	 
elsif (cd_tipo_agenda_p = 3) then 
	select max(substr(obter_nome_medico_combo_agcons(a.cd_estabelecimento, a.cd_agenda, a.cd_tipo_agenda, CASE WHEN coalesce(a.ie_ordenacao::text, '') = '' THEN  'SDP'  ELSE a.ie_ordenacao END ),1,240)) ds 
	into STRICT	ds_agenda_w 
	from	agenda a 
	where  1 = 1 
	and	obter_se_usuario_perm_agenda(cd_agenda,Obter_Pessoa_Fisica_Usuario(nm_usuario_w, 'C'),obter_perfil_ativo,obter_setor_usuario(nm_usuario_w)) = 'S' 
	and   coalesce(ie_tipo_agenda_consulta,'A') <> 'T' 
	and   a.cd_tipo_agenda = 3 
	and	a.cd_agenda = cd_agenda_p 
	order by	ds, 
		a.cd_setor_exclusivo, 
		a.nr_seq_apresent;
elsif (cd_tipo_agenda_p = 4)	then 
	select	max(substr(obter_nome_medico_combo_agcons(a.cd_estabelecimento, a.cd_agenda, a.cd_tipo_agenda, CASE WHEN coalesce(a.ie_ordenacao::text, '') = '' THEN  'SDP'  ELSE a.ie_ordenacao END ),1,240)) ds 
	into STRICT	ds_agenda_w 
	from  agenda a 
	where  1 = 1 	 
	and	obter_se_usuario_perm_agenda(cd_agenda,Obter_Pessoa_Fisica_Usuario(nm_usuario_w, 'C'),obter_perfil_ativo,obter_setor_usuario(nm_usuario_w)) = 'S' 
	and   coalesce(ie_tipo_agenda_consulta,'A') <> 'T' 
	and   a.cd_tipo_agenda = 4 
	and	a.cd_agenda = cd_agenda_p 
	order by	ds, 
	    a.cd_setor_exclusivo, 
	    a.nr_seq_apresent;
elsif (cd_tipo_agenda_p = 2) then 
	select	max(substr(CASE WHEN coalesce(a.ie_desc_curta_exame, 'N')='S' THEN  coalesce(a.ds_curta,a.ds_agenda)  ELSE a.ds_agenda END ,1,255)) ds 
	into STRICT	ds_agenda_w 
	from  agenda a 
	where  a.ie_situacao = 'A' 
	and   a.cd_tipo_agenda = 2 
	and	a.cd_agenda = cd_agenda_p 
	and 	a.cd_estabelecimento = cd_estabelecimento_w 
	and 	a.cd_perfil_exclusivo in (SELECT  x.cd_perfil 
					from   usuario_perfil x 
					where  x.nm_usuario = nm_usuario_w) 
	and 	Consistir_Regra_Perfil_Agenda(obter_perfil_ativo,a.cd_agenda) = 'S' 
	and 	obter_agenda_regra_permissao(cd_pessoa_fisica_w, a.cd_agenda, 'CO', obter_perfil_ativo) = 'S' 
	order by 
	a.nr_seq_apresent, 
	a.cd_setor_exclusivo, 
	ds;
	 
elsif (cd_tipo_agenda_p = 5) then 
	SELECT	max(substr(CASE WHEN coalesce(a.ie_ordenacao::text, '') = '' THEN  a.ds_agenda  ELSE SUBSTR(obter_desc_agenda_servico(a.cd_estabelecimento, a.cd_agenda, a.ie_ordenacao),1,255) END ,1,255)) ds   
	into STRICT	ds_agenda_w 
	FROM  agenda a 
	WHERE  a.cd_tipo_agenda   = 5 
	and	a.cd_agenda = cd_agenda_p 
	AND   a.ie_situacao   = 'A' 
	AND   Obter_Se_Perm_Ageservico(A.CD_AGENDA, nm_usuario_w, obter_perfil_ativo) <> 'N' 
	AND	OBTER_SE_LIB_AGENDA_PERFIL(cd_agenda,1906) = 'S' 
	AND	obter_se_usuario_perm_agenda(cd_agenda,Obter_Pessoa_Fisica_Usuario(nm_usuario_w,'C'),obter_perfil_ativo,obter_setor_usuario(nm_usuario_w)) = 'S' 
	AND 	coalesce(cd_perfil_exclusivo::text, '') = '' 
	AND	((cd_estabelecimento = cd_estabelecimento_w 
	AND 	Obter_Valor_Param_Usuario(866,22,obter_perfil_ativo,nm_usuario_w,cd_estabelecimento_w) = 'N') OR (cd_estabelecimento IN ( SELECT x.cd_estabelecimento 
                    FROM  usuario_estabelecimento x 
                    WHERE  x.nm_usuario_param = nm_usuario_w 
                    
UNION
 
                    SELECT x.cd_estabelecimento 
                    FROM  usuario x  
                    WHERE  x.nm_usuario = nm_usuario_w) AND 
                    Obter_Valor_Param_Usuario(866,22,obter_perfil_ativo,nm_usuario_w,cd_estabelecimento_w) = 'S')) 
    AND (IE_REABILITACAO = 'S' OR Obter_Valor_Param_Usuario(9091,60,obter_perfil_ativo,nm_usuario_w,cd_estabelecimento_w) = 'N' OR 5 <> 5) 
	order by ds;
		 
end if;
 
return	ds_agenda_w;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION rp_obter_desc_agenda (cd_tipo_agenda_p bigint, cd_agenda_p bigint) FROM PUBLIC;

