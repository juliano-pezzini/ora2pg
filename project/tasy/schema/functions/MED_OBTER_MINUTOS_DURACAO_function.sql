-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION med_obter_minutos_duracao (nr_seq_agecons_p bigint, ie_tipo_min_p text) RETURNS varchar AS $body$
DECLARE


/* 'E' - Espera
   'C' - Consulta */
qt_min_espera_w		bigint;
qt_min_consulta_w	bigint;
qt_minutos_w		bigint;
ds_resultado_w		varchar(100);


BEGIN

select	to_number(CASE WHEN coalesce(f.dt_entrada::text, '') = '' THEN  null  ELSE CASE WHEN a.ie_status_agenda='N' THEN  Null  ELSE round((coalesce(f.dt_inicio_consulta, clock_timestamp()) - f.dt_entrada) *			1440) END  END ) qt_min_espera,
	to_number(CASE WHEN coalesce(f.dt_inicio_consulta::text, '') = '' THEN  null  ELSE round((coalesce(f.dt_saida,clock_timestamp()) - f.dt_inicio_consulta) * 1440) END ) 	qt_min_Consulta
into STRICT	qt_min_espera_w,
	qt_min_consulta_w
FROM agenda_consulta a
LEFT OUTER JOIN med_atendimento f ON (a.nr_sequencia = f.nr_seq_agenda)
WHERE a.nr_sequencia		= nr_seq_agecons_p;

if (ie_tipo_min_p = 'E') then
	qt_minutos_w	:= qt_min_espera_w;
else
	qt_minutos_w	:= qt_min_consulta_w;
end if;

if (qt_minutos_w >= 0) and (qt_minutos_w <= 5) then
	ds_resultado_w	:= '0 a 5 min';
elsif (qt_minutos_w > 5) and (qt_minutos_w <= 10) then
	ds_resultado_w	:= '5 a 10 min';
elsif (qt_minutos_w > 10) and (qt_minutos_w <= 15) then
	ds_resultado_w	:= '10 a 15 min';
elsif (qt_minutos_w > 15) and (qt_minutos_w <= 20) then
	ds_resultado_w	:= '15 a 20 min';
elsif (qt_minutos_w > 20) and (qt_minutos_w <= 25) then
	ds_resultado_w	:= '20 a 25 min';
elsif (qt_minutos_w > 25) and (qt_minutos_w <= 30) then
	ds_resultado_w	:= '25 a 30 min';
elsif (qt_minutos_w > 30) and (qt_minutos_w <= 35) then
	ds_resultado_w	:= '30 a 35 min';
elsif (qt_minutos_w > 35) and (qt_minutos_w <= 40) then
	ds_resultado_w	:= '35 a 40 min';
elsif (qt_minutos_w > 40) and (qt_minutos_w <= 45) then
	ds_resultado_w	:= '40 a 45 min';
elsif (qt_minutos_w > 45) and (qt_minutos_w <= 50) then
	ds_resultado_w	:= '45 a 50 min';
elsif (qt_minutos_w > 50) and (qt_minutos_w <= 55) then
	ds_resultado_w	:= '50 a 55 min';
elsif (qt_minutos_w > 55) and (qt_minutos_w <= 60) then
	ds_resultado_w	:= '55 a 60 min';
elsif (qt_minutos_w > 60) then
	ds_resultado_w	:= 'Mais que 60 min';
else
	ds_resultado_w	:= '0';
end if;

return	ds_resultado_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION med_obter_minutos_duracao (nr_seq_agecons_p bigint, ie_tipo_min_p text) FROM PUBLIC;

