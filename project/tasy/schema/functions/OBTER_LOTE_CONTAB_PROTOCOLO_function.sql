-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_lote_contab_protocolo (nr_seq_protocolo_p bigint) RETURNS varchar AS $body$
DECLARE

 
ds_retorno_w		varchar(254);
nr_lote_contabil_w	bigint;

/*cursor c01 is 
select	distinct nr_lote_contabil 
from	protocolo_convenio_item_v 
where	nr_seq_protocolo	= nr_seq_protocolo_P 
and	NVL(nr_lote_contabil,0)	<> 0 
order	by nr_lote_contabil;*/
 
 
c01 CURSOR FOR 
	SELECT	distinct nr_lote_contabil 
	from ( 	 
		SELECT	a.nr_lote_contabil 
		from  	procedimento_paciente a, 
			conta_paciente b, 
			protocolo_convenio d 
		where	d.nr_seq_protocolo	= b.nr_seq_protocolo 
		and	coalesce(a.cd_motivo_exc_conta::text, '') = '' 
		and	a.nr_interno_conta  	= b.nr_interno_conta 
		and	d.nr_seq_protocolo	= nr_seq_protocolo_p 
		and	coalesce(a.nr_lote_contabil,0) <> 0 
		
union all
 
		select	x.nr_lote_contabil 
		from  	material_atend_paciente x, 
			conta_paciente y, 
			protocolo_convenio z 
		where 	z.nr_seq_protocolo = y.nr_seq_protocolo 
		and	coalesce(x.cd_motivo_exc_conta::text, '') = '' 
		and 	x.nr_interno_conta = y.nr_interno_conta 
		and	z.nr_seq_protocolo	= nr_seq_protocolo_p 
		and	coalesce(x.nr_lote_contabil,0) <> 0) alias4 
	order by nr_lote_contabil;

 

BEGIN 
 
ds_retorno_w		:= '';
open c01;
loop 
fetch c01 into 
	nr_lote_contabil_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
 
	ds_retorno_w	:= nr_lote_contabil_w || ', ' || ds_retorno_w;
 
end loop;
close c01;
 
return substr(coalesce(ds_retorno_w, ' '), 1, length(coalesce(ds_retorno_w, ' ')) - 2);
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_lote_contab_protocolo (nr_seq_protocolo_p bigint) FROM PUBLIC;

