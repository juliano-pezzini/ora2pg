-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_volume_desconto_neo (ie_tipo_elemento_p text, nr_sequencia_p bigint, ie_opcao_p text ) RETURNS bigint AS $body$
DECLARE


qt_retorno_w		double precision;
nr_seq_fosforo_w	bigint;
nr_seq_potassio_w	bigint;
cd_material_w		bigint;
qt_volume_w			double precision;
qt_pot_clor_fosforo_w	double precision;
qt_diaria_w				double precision;
qt_diaria_2w			double precision;
qt_conversao_ml_w		double precision;
qt_volume2_w			double precision;
qt_fosforo_w			double precision;
qt_diaria_sodio_w		double precision;
qt_elem_kg_dia_calcio_w	double precision;
NR_SEQ_MATERIAL_W		bigint;
nr_seq_sodio_w			bigint;
nr_seq_zinco_w			bigint;
nr_seq_oligoelemento_w	bigint;
nr_seq_calcio_w			bigint;
EXEC_W              varchar(200);

BEGIN
  if (ie_tipo_elemento_p = 'P') then /* Potassio */
    select coalesce(max(nr_sequencia),0)
    into STRICT	nr_seq_potassio_w
    from	nut_elemento
    where	ie_tipo_elemento	= 'K';

    select coalesce(max(nr_sequencia),0)
    into STRICT	nr_seq_fosforo_w
    from	nut_elemento
    where	ie_tipo_elemento	= 'F';

    select	coalesce(max(c.cd_material),0),
        coalesce(max(b.qt_volume),0),
        coalesce(max(a.qt_diaria),0)
    into STRICT	cd_material_w,
        qt_volume_w,
        qt_diaria_w
    from	nut_elem_material c,
        nut_pac_elem_mat b,
        nut_pac_elemento a
    where	b.nr_seq_elem_mat	= c.nr_sequencia
    and		a.nr_sequencia	= b.nr_seq_pac_elem
    and		a.nr_seq_elemento	= nr_seq_fosforo_w
    and		a.nr_seq_nut_pac	= nr_sequencia_p
    and		coalesce(c.ie_tipo,'NPT')	= 'NPT';

    /* Obter dados do potassio */

    begin
    select	dividir(qt_volume_w, qt_conversao_ml)
    into STRICT	qt_pot_clor_fosforo_w
    from	nut_elem_material
    where	nr_seq_elemento	= nr_seq_potassio_w
    and		cd_material		= cd_material_w
    and		coalesce(ie_tipo,'NPT')	= 'NPT';
    exception
    when others then
      qt_pot_clor_fosforo_w:= 0;
    end;
    select	coalesce(max(a.qt_diaria),0),
        coalesce(max(b.nr_sequencia),0)
    into STRICT	qt_diaria_w,
        nr_seq_material_w
    from	nut_pac_elem_mat b,
        nut_pac_elemento a
    where	a.nr_sequencia	= b.nr_seq_pac_elem
    and		a.nr_seq_elemento	= nr_seq_potassio_w
    and		a.nr_seq_nut_pac	= nr_sequencia_p;

    select	coalesce(max(c.qt_conversao_ml),0)
    into STRICT	qt_conversao_ml_w
    from	nut_elem_material c,
        nut_pac_elem_mat b,
        nut_pac_elemento a
    where	b.nr_seq_elem_mat	= c.nr_sequencia
    and		a.nr_sequencia	= b.nr_seq_pac_elem
    and		a.nr_seq_elemento	= nr_seq_potassio_w
    and		a.nr_seq_nut_pac	= nr_sequencia_p
    and		coalesce(c.ie_tipo,'NPT')	= 'NPT';

    qt_diaria_2w	:= qt_diaria_w;

    begin
      EXEC_W := 'CALL OBTER_RESULT_VOL_DESC_NEO_MD(:1,:2,:3,:4,:5,:6,:7,:8,:9,:10) INTO :RESULT';

      EXECUTE EXEC_W USING IN ie_tipo_elemento_p,
                                     IN ie_opcao_p,
                                     IN coalesce(qt_pot_clor_fosforo_w,0),
                                     IN coalesce(qt_diaria_2w,0),
                                     IN coalesce(qt_conversao_ml_w,0),
                                     IN coalesce(qt_diaria_w,0),
                                     IN coalesce(nr_seq_material_w,0),
                                     IN coalesce(qt_fosforo_w,0),
                                     IN coalesce(qt_diaria_sodio_w,0),
                                     IN coalesce(qt_elem_kg_dia_calcio_w,0),
                                     OUT qt_retorno_w;
    exception
      when others then
        qt_retorno_w := null;
    end;

  elsif (ie_tipo_elemento_p = 'S') then
    select	coalesce(max(nr_sequencia),0)
    into STRICT	nr_seq_sodio_w
    from	nut_elemento
    where	ie_tipo_elemento	= 'N'
    and	coalesce(ie_gerar_ped,'N')	= 'S';

    select	coalesce(max(nr_sequencia),0)
    into STRICT	nr_seq_fosforo_w
    from	nut_elemento
    where	ie_tipo_elemento	= 'F';

    select	coalesce(max(c.cd_material),0),
        coalesce(max(b.qt_volume),0),
        coalesce(max(a.qt_diaria),0)
    into STRICT	cd_material_w,
        qt_volume_w,
        qt_diaria_w
    from	nut_elem_material c,
        nut_pac_elem_mat b,
        nut_pac_elemento a
    where	b.nr_seq_elem_mat	= c.nr_sequencia
    and	a.nr_sequencia		= b.nr_seq_pac_elem
    and	a.nr_seq_elemento	= nr_seq_fosforo_w
    and	a.nr_seq_nut_pac	= nr_sequencia_p
    and	coalesce(c.ie_tipo,'NPT')	= 'NPT';

    select	max(qt_diaria)
    into STRICT	qt_diaria_sodio_w
    from	nut_pac_elemento a
    where	nr_seq_elemento		= nr_seq_sodio_w
    and		a.nr_seq_nut_pac	= nr_sequencia_p;

    begin
    select	dividir(qt_volume_w, qt_conversao_ml)
    into STRICT	qt_fosforo_w
    from	nut_elem_material
    where	nr_seq_elemento		= nr_seq_sodio_w
    and		cd_material		= cd_material_w
    and		coalesce(ie_tipo,'NPT')	= 'NPT';
    exception
    when others then
      qt_fosforo_w	:= 0;
    end;

    select	coalesce(max(a.qt_diaria),0),
        coalesce(max(b.nr_sequencia),0)
    into STRICT	qt_diaria_w,
        nr_seq_material_w
    from	nut_pac_elem_mat b,
        nut_pac_elemento a
    where	a.nr_sequencia	= b.nr_seq_pac_elem
    and		a.nr_seq_elemento	= nr_seq_sodio_w
    and		a.nr_seq_nut_pac	= nr_sequencia_p;

    select	coalesce(max(c.qt_conversao_ml),0)
    into STRICT	qt_conversao_ml_w
    from	nut_elem_material c,
        nut_pac_elem_mat b,
        nut_pac_elemento a
    where	b.nr_seq_elem_mat	= c.nr_sequencia
    and		a.nr_sequencia		= b.nr_seq_pac_elem
    and		a.nr_seq_elemento	= nr_seq_sodio_w
    and		a.nr_seq_nut_pac	= nr_sequencia_p
    and		coalesce(c.ie_tipo,'NPT')	= 'NPT';

    begin
      EXEC_W := 'CALL OBTER_RESULT_VOL_DESC_NEO_MD(:1,:2,:3,:4,:5,:6,:7,:8,:9,:10) INTO :RESULT';

      EXECUTE EXEC_W USING IN ie_tipo_elemento_p,
                                     IN ie_opcao_p,
                                     IN coalesce(qt_pot_clor_fosforo_w,0),
                                     IN coalesce(qt_diaria_2w,0),
                                     IN coalesce(qt_conversao_ml_w,0),
                                     IN coalesce(qt_diaria_w,0),
                                     IN coalesce(nr_seq_material_w,0),
                                     IN coalesce(qt_fosforo_w,0),
                                     IN coalesce(qt_diaria_sodio_w,0),
                                     IN coalesce(qt_elem_kg_dia_calcio_w,0),
                                     OUT qt_retorno_w;
    exception
      when others then
        qt_retorno_w := null;
    end;

  elsif (ie_tipo_elemento_p = 'Z') then
    select	coalesce(max(nr_sequencia),0)
    into STRICT	nr_seq_zinco_w
    from	nut_elemento
    where	ie_tipo_elemento	= 'N'
    and	coalesce(ie_gerar_ped,'N')	= 'S';

    select	coalesce(max(nr_sequencia),0)
    into STRICT	nr_seq_oligoelemento_w
    from	nut_elemento
    where	ie_tipo_elemento	= 'F';

    select	coalesce(max(c.cd_material),0),
      coalesce(max(b.qt_volume),0),
      coalesce(max(a.qt_diaria),0)
    into STRICT	cd_material_w,
      qt_volume_w,
      qt_diaria_w
    from	nut_elem_material c,
      nut_pac_elem_mat b,
      nut_pac_elemento a
    where	b.nr_seq_elem_mat	= c.nr_sequencia
    and	a.nr_sequencia		= b.nr_seq_pac_elem
    and	a.nr_seq_elemento	= nr_seq_oligoelemento_w
    and	a.nr_seq_nut_pac	= nr_sequencia_p
    and	coalesce(c.ie_tipo,'NPT')	= 'NPT';

    select	max(qt_diaria)
    into STRICT	qt_diaria_sodio_w
    from	nut_pac_elemento a
    where	nr_seq_elemento		= nr_seq_sodio_w
    and	a.nr_seq_nut_pac	= nr_sequencia_p;

    begin
    select	dividir(qt_volume_w, qt_conversao_ml)
    into STRICT	qt_fosforo_w
    from	nut_elem_material
    where	nr_seq_elemento		= nr_seq_sodio_w
    and	cd_material		= cd_material_w
    and	coalesce(ie_tipo,'NPT')	= 'NPT';
    exception
    when others then
      qt_fosforo_w	:= 0;
    end;

    select	coalesce(max(a.qt_diaria),0),
      coalesce(max(b.nr_sequencia),0)
    into STRICT	qt_diaria_w,
      nr_seq_material_w
    from	nut_pac_elem_mat b,
      nut_pac_elemento a
    where	a.nr_sequencia	= b.nr_seq_pac_elem
    and	a.nr_seq_elemento	= nr_seq_sodio_w
    and	a.nr_seq_nut_pac	= nr_sequencia_p;

    select	coalesce(max(c.qt_conversao_ml),0)
    into STRICT	qt_conversao_ml_w
    from	nut_elem_material c,
      nut_pac_elem_mat b,
      nut_pac_elemento a
    where	b.nr_seq_elem_mat	= c.nr_sequencia
    and	a.nr_sequencia		= b.nr_seq_pac_elem
    and	a.nr_seq_elemento	= nr_seq_sodio_w
    and	a.nr_seq_nut_pac	= nr_sequencia_p
    and	coalesce(c.ie_tipo,'NPT')	= 'NPT';

    begin
      EXEC_W := 'CALL OBTER_RESULT_VOL_DESC_NEO_MD(:1,:2,:3,:4,:5,:6,:7,:8,:9,:10) INTO :RESULT';

      EXECUTE EXEC_W USING IN ie_tipo_elemento_p,
                                     IN ie_opcao_p,
                                     IN coalesce(qt_pot_clor_fosforo_w,0),
                                     IN coalesce(qt_diaria_2w,0),
                                     IN coalesce(qt_conversao_ml_w,0),
                                     IN coalesce(qt_diaria_w,0),
                                     IN coalesce(nr_seq_material_w,0),
                                     IN coalesce(qt_fosforo_w,0),
                                     IN coalesce(qt_diaria_sodio_w,0),
                                     IN coalesce(qt_elem_kg_dia_calcio_w,0),
                                     OUT qt_retorno_w;
    exception
      when others then
        qt_retorno_w := null;
    end;

  elsif (ie_tipo_elemento_p = 'F') then
    select	coalesce(max(nr_sequencia),0)
    into STRICT	nr_seq_fosforo_w
    from	nut_elemento
    where	ie_tipo_elemento	= 'F';

    select	coalesce(max(nr_sequencia),0)
    into STRICT	nr_seq_calcio_w
    from	nut_elemento
    where	ie_tipo_elemento	= 'I';

    select	coalesce(sum(qt_elem_kg_dia),0)
    into STRICT	qt_elem_kg_dia_calcio_w
    from	nut_elemento b,
        nut_pac_elemento a
    where	a.nr_seq_nut_pac	= nr_sequencia_p
    and		a.nr_seq_elemento	= b.nr_sequencia
    and		b.ie_tipo_elemento	= 'I';

    begin
      EXEC_W := 'CALL OBTER_RESULT_VOL_DESC_NEO_MD(:1,:2,:3,:4,:5,:6,:7,:8,:9,:10) INTO :RESULT';

      EXECUTE EXEC_W USING IN ie_tipo_elemento_p,
                                     IN ie_opcao_p,
                                     IN coalesce(qt_pot_clor_fosforo_w,0),
                                     IN coalesce(qt_diaria_2w,0),
                                     IN coalesce(qt_conversao_ml_w,0),
                                     IN coalesce(qt_diaria_w,0),
                                     IN coalesce(nr_seq_material_w,0),
                                     IN coalesce(qt_fosforo_w,0),
                                     IN coalesce(qt_diaria_sodio_w,0),
                                     IN coalesce(qt_elem_kg_dia_calcio_w,0),
                                     OUT qt_retorno_w;
    exception
      when others then
        qt_retorno_w := null;
    end;
  end if;

  return qt_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_volume_desconto_neo (ie_tipo_elemento_p text, nr_sequencia_p bigint, ie_opcao_p text ) FROM PUBLIC;

