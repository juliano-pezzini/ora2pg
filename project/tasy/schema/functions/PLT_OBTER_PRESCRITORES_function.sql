-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';



CREATE TYPE campos AS ( nr_prescricao	 	bigint, 
			nm_prescritor		varchar(255));


CREATE OR REPLACE FUNCTION plt_obter_prescritores (nr_prescricoes_p text, ie_tipo_item_p text) RETURNS varchar AS $body$
DECLARE

type Vetor is table of campos index 	by integer;
Vetor_w			Vetor;
nr_pos_virgula			bigint;
nr_prescricao_w			varchar(20);
nr_prescricoes_w		varchar(255);
nm_prescritores_w		varchar(2000);
nm_prescritor_w			varchar(255);
qt_tamanho_w			bigint;
i				bigint;
ie_lista_w			varchar(1);

procedure ordenar_vetor is 
 
x		bigint;
chave		campos;
y		bigint;

BEGIN 
for x in 2..Vetor_w.count loop 
	begin 
	y := x;
	chave := Vetor_w(x);
	while(y > 1) and (chave.nm_prescritor < Vetor_w[y-1].nm_prescritor) loop 
		begin 
		Vetor_w(y) := Vetor_w(y-1);
		y := y - 1;
		end;
	end loop;	
	Vetor_w(y) := chave;
	end;
end loop;
end;
 
begin 
nr_prescricoes_w		:= nr_prescricoes_p;
i := 0;
while(length(nr_prescricoes_w) > 0) loop 
	begin 
	i	:= i+1;
	if (position(',' in nr_prescricoes_w)	> 0) then 
		Vetor_w[i].nr_prescricao	:= somente_numero(substr(nr_prescricoes_w,1,position(',' in nr_prescricoes_w)));
		nr_prescricoes_w		:= substr(nr_prescricoes_w,position(',' in nr_prescricoes_w)+1,40000);
	else 
		Vetor_w[i].nr_prescricao	:= somente_numero(nr_prescricoes_w);
		nr_prescricoes_w		:= null;
	end if;
	 
	if (ie_tipo_item_p	= 'E') then 
		select	max(substr(obter_nome_pf(cd_prescritor),1,255)) 
		into STRICT	nm_prescritor_w 
		from	pe_prescricao 
		where	nr_sequencia = Vetor_w[i].nr_prescricao;
	else 
		select	max(substr(obter_nome_pf(cd_prescritor),1,255)) 
		into STRICT	nm_prescritor_w 
		from	prescr_medica 
		where	nr_prescricao = Vetor_w[i].nr_prescricao;
	end if;
	 
	ie_lista_w := 'N';
	 
	for x in 1..vetor_w.count loop 
		begin 
		if (vetor_w[x].nm_prescritor = nm_prescritor_w) and (x <> i) then 
			ie_lista_w := 'S';
		end if;	
		end;
	end loop;
	 
	if (ie_lista_w = 'N') then	 
		Vetor_w[i].nm_prescritor := nm_prescritor_w;
	end if;
	end;
end loop;
 
ordenar_vetor;
 
for j in 1..Vetor_w.count loop 
	begin 
	 
	if (coalesce(nm_prescritores_w,'XPTO') = 'XPTO') and (Vetor_w[j](.nm_prescritor IS NOT NULL AND .nm_prescritor::text <> '')) then 
		nm_prescritores_w := Vetor_w[j].nm_prescritor;
	elsif (Vetor_w[j](.nm_prescritor IS NOT NULL AND .nm_prescritor::text <> '')) then 
		nm_prescritores_w := nm_prescritores_w || ', ' || Vetor_w[j].nm_prescritor;
	end if;
	 
	end;
end loop;
 
return	nm_prescritores_w;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION plt_obter_prescritores (nr_prescricoes_p text, ie_tipo_item_p text) FROM PUBLIC;

