-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_dados_tit_conta_prot (NR_SEQ_PROTOCOLO_P bigint, NR_INTERNO_CONTA_P bigint, IE_OPCAO_P text) RETURNS varchar AS $body$
DECLARE


/*ie_opcao_p		'NT' Número do título,
			'VT' Vencimento do Título,
			'VL' Valor do título*/
nr_titulo_w		bigint;
dt_vencimento_w 	timestamp;
vl_titulo_w		double precision;
ds_titulo_w		varchar(2000) := '';

C01 CURSOR FOR
	SELECT /*+ index (a titrece_proconv_fk_i) */		nr_titulo,
		dt_vencimento,
		vl_titulo
	from titulo_receber a
	where (nr_seq_protocolo_p <> 0)
	  and (nr_seq_protocolo = nr_seq_protocolo_p)
	
union

	SELECT /*+ index (a titrece_conpaci_fk_i) */		nr_titulo,
		dt_vencimento,
		vl_titulo
	from titulo_receber a
	where (nr_interno_conta_p <> 0)
	  and (nr_interno_conta = nr_interno_conta_p);


BEGIN

open C01;
loop
fetch C01 into 	nr_titulo_w,
		dt_vencimento_w,
		vl_titulo_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
	if (ie_opcao_p = 'NT') then
		if (length(coalesce(ds_titulo_w, '0')) < 1980) then
			ds_titulo_w := ds_titulo_w || nr_titulo_w ||', ';
		end if;
	elsif (ie_opcao_p = 'VT') then
		if (length(coalesce(ds_titulo_w,'0')) < 1980) then
			ds_titulo_w	:= ds_titulo_w || to_char(dt_vencimento_w,'dd/mm/yyyy') || ', ';
		end if;
	elsif (ie_opcao_p = 'VL') then
		if (length(coalesce(ds_titulo_w,'0')) < 1980) then
			ds_titulo_w := ds_titulo_w || vl_titulo_w || ', ';
		end if;
	end if;
end loop;
close C01;

if (length(ds_titulo_w) > 2) then
	ds_titulo_w	:= substr(ds_titulo_w,1,length(ds_titulo_w) - 2);
end if;

RETURN ds_titulo_w;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_dados_tit_conta_prot (NR_SEQ_PROTOCOLO_P bigint, NR_INTERNO_CONTA_P bigint, IE_OPCAO_P text) FROM PUBLIC;

