-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_validade_prescr ( dt_prescricao_p timestamp, hr_prescricao_p text, nr_atendimento_p bigint, ie_estender_p text, cd_perfil_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint, ie_hemodialise_p text) RETURNS timestamp AS $body$
DECLARE

			 
ie_calcula_validade_hem_w	varchar(2);
ie_estender_w			varchar(4);
nr_atendimento_w		bigint;
nr_horas_validade_w		bigint;
dt_validade_prescr_w		timestamp;

BEGIN
 
ie_calcula_validade_hem_w := Obter_Param_Usuario(924, 1016, cd_perfil_p, nm_usuario_p, cd_estabelecimento_p, ie_calcula_validade_hem_w);
 
if (coalesce(ie_estender_p::text, '') = '') then 
	ie_estender_w := Obter_Param_Usuario(924, 249, cd_perfil_p, nm_usuario_p, cd_estabelecimento_p, ie_estender_w);
else 
	ie_estender_w := ie_estender_p;
end if;	
 
nr_horas_validade_w	:= 24;
 
if ((coalesce(nr_atendimento_p,nr_atendimento_w) IS NOT NULL AND (coalesce(nr_atendimento_p,nr_atendimento_w))::text <> '')) then 
		select	coalesce(Obter_Horas_Validade_Prescr( to_date(substr(to_char(dt_prescricao_p,'dd/mm/yyyy'),1,10) || ' ' || hr_prescricao_p || ':00','dd/mm/yyyy hh24:mi:ss'), 
								coalesce(nr_atendimento_p,nr_atendimento_w), 
								ie_estender_w, 
								'A', 
								trunc(dt_prescricao_p,'mi'), null),24) 
		into STRICT	nr_horas_validade_w 
		;		
end if;
 
 
	 
if (coalesce(ie_hemodialise_p,'N') not in ('E','S')) or (ie_calcula_validade_hem_w	= 'S') then 
	dt_validade_prescr_w := dt_prescricao_p + coalesce(nr_horas_validade_w,24) / 24;
	dt_validade_prescr_w 	:= trunc(dt_validade_prescr_w,'hh24') - 1/86400;	
end if;	
	 
 
return	dt_validade_prescr_w;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_validade_prescr ( dt_prescricao_p timestamp, hr_prescricao_p text, nr_atendimento_p bigint, ie_estender_p text, cd_perfil_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint, ie_hemodialise_p text) FROM PUBLIC;

