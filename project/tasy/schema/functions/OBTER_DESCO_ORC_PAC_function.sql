-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_desco_orc_pac ( nr_seq_orcamento_p bigint ) RETURNS bigint AS $body$
DECLARE

       vl_material_w           double precision;
       vl_mat_imposto_w        double precision;
       vl_procedimento_w       double precision;
       vl_proc_imposto_w       double precision;
       vl_orcamento_w          double precision;
       vl_desconto_w           double precision;
       vl_desconto_ww          double precision;
       vl_desconto_proced_w    double precision;
       vl_desconto_material_w  double precision;
       vl_pacote_w             double precision;
       pr_desconto_w           real;
       ie_desconto_pacote_w    varchar(1 );
       vl_desc_proced_pacote_w double precision;
       vl_desconto_return      double precision;

BEGIN
       vl_material_w           := 0;
       vl_procedimento_w       := 0;
       vl_desconto_w           := 0;
       vl_desconto_ww          := 0;
       pr_desconto_w           := 0;
       vl_pacote_w             := 0;
       vl_desc_proced_pacote_w := 0;
       select
              coalesce( max( coalesce( vl_parametro , vl_parametro_padrao ) ) , 'N' )
       into STRICT
              ie_desconto_pacote_w
       from
              funcao_parametro
       where
              cd_funcao        = 106
              and nr_sequencia = 115;
       if (nr_seq_orcamento_p IS NOT NULL AND nr_seq_orcamento_p::text <> '') then
              begin
                     vl_desc_proced_pacote_w:= 0;
                     select
                            coalesce( sum( vl_procedimento ) , 0 )
                     into STRICT
                            vl_procedimento_w
                     from
                            orcamento_paciente_proc
                     where
                            nr_sequencia_orcamento        = nr_seq_orcamento_p
                            and coalesce( ie_agendavel , 'N' ) = 'N';
                     select
                            coalesce( sum( vl_material ) , 0 )
                     into STRICT
                            vl_material_w
                     from
                            orcamento_paciente_mat
                     where
                            nr_sequencia_orcamento = nr_seq_orcamento_p;
                     select
                            coalesce( vl_desconto , 0 ) ,
                            coalesce( pr_desconto , 0 )
                     into STRICT
                            vl_desconto_w ,
                            pr_desconto_w
                     from
                            orcamento_paciente
                     where
                            nr_sequencia_orcamento = nr_seq_orcamento_p;
                     /*-- Somar o valor do procedimento pacote que está definido como agendável em seu cadastro.*/

                     select
                            coalesce( sum( a.vl_procedimento ) , 0 )
                     into STRICT
                            vl_pacote_w
                     from
                            orcamento_paciente_proc a
                     where
                            a.nr_sequencia_orcamento        = nr_seq_orcamento_p
                            and coalesce( a.ie_agendavel , 'N' ) = 'S'
                            and coalesce( ie_pacote , 'N' )      = 'S'
                            and exists (SELECT
                                   1
                            from
                                   orcamento_pac_proc_valor x
                            where
                                   x.nr_seq_orc_proced = a.nr_sequencia
                            );
                     if ( 2 = philips_param_pck.get_cd_pais ) then
                            select
                                   coalesce( sum( a.vl_procedimento ) , 0 )
                            into STRICT
                                   vl_procedimento_w
                            from
                                   orcamento_paciente_proc a
                            where
                                   a.nr_sequencia_orcamento        = nr_seq_orcamento_p
                                   and coalesce( a.ie_agendavel , 'N' ) = 'N'
                                   and not exists (SELECT
                                          1
                                   from
                                          orcamento_proc_imposto x
                                   where
                                          x.nr_seq_proc = a.nr_sequencia
                                   );
                            select
                                   coalesce( sum( a.vl_proc_imposto ) , 0 )
                            into STRICT
                                   vl_proc_imposto_w
                            from
                                   orcamento_paciente_proc b ,
                                   orcamento_proc_imposto a
                            where
                                   b.nr_sequencia_orcamento        = nr_seq_orcamento_p
                                   and a.nr_seq_proc               = b.nr_sequencia
                                   and coalesce( b.ie_agendavel , 'N' ) = 'N';
                            vl_procedimento_w                     := vl_procedimento_w + vl_proc_imposto_w;
                            select
                                   coalesce( sum( a.vl_material ) , 0 )
                            into STRICT
                                   vl_material_w
                            from
                                   orcamento_paciente_mat a
                            where
                                   a.nr_sequencia_orcamento = nr_seq_orcamento_p
                                   and not exists (SELECT
                                          1
                                   from
                                          orcamento_mat_imposto x
                                   where
                                          x.nr_seq_mat = a.nr_sequencia
                                   );
                            select
                                   coalesce( sum( a.vl_mat_imposto ) , 0 )
                            into STRICT
                                   vl_mat_imposto_w
                            from
                                   orcamento_paciente_mat b ,
                                   orcamento_mat_imposto a
                            where
                                   b.nr_sequencia_orcamento = nr_seq_orcamento_p
                                   and a.nr_seq_mat         = b.nr_sequencia;
                            vl_material_w                  := vl_material_w + vl_mat_imposto_w;
                     end if;
                     vl_procedimento_w := vl_procedimento_w + coalesce( vl_pacote_w , 0 );
                     if ( vl_desconto_w  = 0 ) then
                            select
                                   coalesce( sum( vl_desconto ) , 0 )
                            into STRICT
                                   vl_desconto_proced_w
                            from
                                   orcamento_paciente_proc
                            where
                                   nr_sequencia_orcamento              = nr_seq_orcamento_p
                                   and coalesce( ie_valor_informado , 'N' ) = 'N'
                                   and coalesce( ie_agendavel , 'N' )       = 'N';
                            vl_desc_proced_pacote_w                   := 0;
                            if ( ie_desconto_pacote_w                   = 'S' ) then
                                   select
                                          coalesce( sum( vl_desconto ) , 0 )
                                   into STRICT
                                          vl_desc_proced_pacote_w
                                   from
                                          orcamento_paciente_proc
                                   where
                                          nr_sequencia_orcamento              = nr_seq_orcamento_p
                                          and coalesce( ie_valor_informado , 'N' ) = 'S'
                                          and coalesce( ie_pacote , 'N' )          = 'S';
                            end if;
                            select
                                   coalesce( sum( vl_desconto ) , 0 )
                            into STRICT
                                   vl_desconto_material_w
                            from
                                   orcamento_paciente_mat
                            where
                                   nr_sequencia_orcamento = nr_seq_orcamento_p;
                            vl_desconto_w                := vl_desconto_proced_w + vl_desconto_material_w + vl_desc_proced_pacote_w;
                     end if;
                     if ( pr_desconto_w     <> 0 ) then
                            vl_desconto_ww :=(( vl_procedimento_w + vl_material_w )*( pr_desconto_w/100 ) );
                     end if;
              end;
       end if;
vl_desconto_return := round(( vl_desconto_w + vl_desconto_ww )::numeric, 2 );
return vl_desconto_return;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_desco_orc_pac ( nr_seq_orcamento_p bigint ) FROM PUBLIC;

