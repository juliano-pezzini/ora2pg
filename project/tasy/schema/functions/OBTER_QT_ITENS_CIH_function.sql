-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_qt_itens_cih ( nr_seq_lote_p bigint, ie_opcao_p bigint default 0, ie_tipo_atend_p bigint default 0) RETURNS bigint AS $body$
DECLARE


qt_count_w	bigint;
qt_sum_w	bigint;


BEGIN

if (ie_opcao_p = 0) then -- Todos
	if (ie_tipo_atend_p = 0) then
		select 	count(*),
			sum(coalesce(qtd_atendimento,1))
		into STRICT	qt_count_w,
			qt_sum_w
		from 	lote_cih_item
		where 	nr_seq_lote = nr_seq_lote_p
		and   	ie_tipo_reg_interface in (2,4,5);
	elsif (ie_tipo_atend_p = 1) then
		select 	count(*),
			sum(coalesce(qtd_atendimento,1))
		into STRICT	qt_count_w,
			qt_sum_w
		from 	lote_cih_item
		where 	nr_seq_lote = nr_seq_lote_p
		and   	ie_tipo_reg_interface in (2);
	elsif (ie_tipo_atend_p = 2) then
		select 	count(*),
			sum(coalesce(qtd_atendimento,1))
		into STRICT	qt_count_w,
			qt_sum_w
		from 	lote_cih_item
		where 	nr_seq_lote = nr_seq_lote_p
		and   	ie_tipo_reg_interface in (4,5);
	end if;


elsif (ie_opcao_p = 1) then -- Consolidados
	select 	count(*),
		sum(coalesce(qtd_atendimento,1))
	into STRICT	qt_count_w,
		qt_sum_w
	from 	lote_cih_item
	where 	nr_seq_lote = nr_seq_lote_p
	and   	ie_tipo_reg_interface in (5);

elsif (ie_opcao_p = 2) then -- Individuais
	if (ie_tipo_atend_p = 1) then -- Internação
		select 	count(*),
			sum(coalesce(qtd_atendimento,1))
		into STRICT	qt_count_w,
			qt_sum_w
		from 	lote_cih_item
		where 	nr_seq_lote = nr_seq_lote_p
		and   	ie_tipo_reg_interface in (2);
	else
		select 	count(*),
			sum(coalesce(qtd_atendimento,1))
		into STRICT	qt_count_w,
			qt_sum_w
		from 	lote_cih_item
		where 	nr_seq_lote = nr_seq_lote_p
		and   	ie_tipo_reg_interface in (4);
	end if;

elsif (ie_opcao_p = 3) then -- Genérico
	if (ie_tipo_atend_p = 1) then -- Internação
		select 	count(*),
			sum(coalesce(qtd_atendimento,1))
		into STRICT	qt_count_w,
			qt_sum_w
		from 	lote_cih_item a
		where 	nr_seq_lote = nr_seq_lote_p
		and   	ie_tipo_reg_interface in (2)
		and	exists (SELECT	1
				from	procedimento_conv_gen_sus b
				where	b.cd_procedimento = a.cd_procedimento);
	else
		select 	count(*),
			sum(coalesce(qtd_atendimento,1))
		into STRICT	qt_count_w,
			qt_sum_w
		from 	lote_cih_item a
		where 	nr_seq_lote = nr_seq_lote_p
		and   	ie_tipo_reg_interface in (4)
		and	exists (SELECT	1
				from	procedimento_conv_gen_sus b
				where	b.cd_procedimento = a.cd_procedimento);
	end if;

end if;

If (qt_sum_w > 0) then
	return qt_sum_w;
else
	return qt_count_w;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_qt_itens_cih ( nr_seq_lote_p bigint, ie_opcao_p bigint default 0, ie_tipo_atend_p bigint default 0) FROM PUBLIC;

