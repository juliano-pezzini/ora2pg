-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION consiste_lote_fornec ( cd_barra_material_p material_lote_fornec.cd_barra_material%type, nr_seq_processo_p adep_processo.nr_sequencia%type, cd_estabelecimento_p material_lote_fornec.cd_estabelecimento%type ) RETURNS varchar AS $body$
DECLARE


nr_seq_lote_fornec_w    material_lote_fornec.nr_sequencia%type;
nr_seq_mat_fornec_w     prescr_mat_hor.nr_seq_lote_fornec%type;
nr_atendimento_w        adep_processo.nr_atendimento%type;
nr_prescricao_w         adep_processo.nr_prescricao%type;
nr_seq_material_w       adep_processo.nr_seq_material%type;
ie_material_barra_w     varchar(1);
nr_retorno_w            varchar(1);
ie_lote_disp_w          varchar(1);


BEGIN

nr_retorno_w := 'N';

select  coalesce(max('S'), 'N')
into STRICT    ie_material_barra_w
from    material_cod_barra
where   cd_barra_material = cd_barra_material_p;

select  max(a.nr_atendimento),
        max(a.nr_prescricao),
        max(a.nr_seq_material),
        max(b.nr_seq_lote_fornec)
into STRICT    nr_atendimento_w,
        nr_prescricao_w,
        nr_seq_material_w,
        nr_seq_mat_fornec_w
from    adep_processo a,
        prescr_mat_hor b
where   a.nr_sequencia = b.nr_seq_processo
and     a.nr_prescricao = b.nr_prescricao
and     a.nr_seq_material = b.nr_seq_material
and     a.nr_sequencia = nr_seq_processo_p;

select  coalesce(max('S'), 'N')
into STRICT    ie_lote_disp_w
from    ap_lote a
where   a.nr_sequencia = cd_barra_material_p
and     a.nr_prescricao = nr_prescricao_w;

if ( (cd_barra_material_p IS NOT NULL AND cd_barra_material_p::text <> '') and
     (nr_seq_processo_p IS NOT NULL AND nr_seq_processo_p::text <> '') and
     (cd_estabelecimento_p IS NOT NULL AND cd_estabelecimento_p::text <> '') and
     (nr_atendimento_w IS NOT NULL AND nr_atendimento_w::text <> '') and
     (nr_prescricao_w IS NOT NULL AND nr_prescricao_w::text <> '') and
     (nr_seq_material_w IS NOT NULL AND nr_seq_material_w::text <> '') and
     ie_material_barra_w = 'N' and
     ie_lote_disp_w = 'N' ) then

    select  max(a.nr_sequencia)
    into STRICT    nr_seq_lote_fornec_w
    from    material_lote_fornec a
    where (a.cd_barra_material = cd_barra_material_p or
                a.nr_sequencia = substr(cd_barra_material_p,1,10))
    and     a.cd_estabelecimento = cd_estabelecimento_p;

    if (nr_seq_lote_fornec_w IS NOT NULL AND nr_seq_lote_fornec_w::text <> '') then

        select  coalesce(max('N'), 'S')
        into STRICT    nr_retorno_w
        from    material_atend_paciente a
        where   a.nr_seq_lote_fornec = nr_seq_lote_fornec_w
        and     a.nr_atendimento = nr_atendimento_w
        and     a.nr_prescricao = nr_prescricao_w
        and     a.nr_sequencia_prescricao = nr_seq_material_w;

        if ( (nr_seq_mat_fornec_w IS NOT NULL AND nr_seq_mat_fornec_w::text <> '') and
             nr_seq_mat_fornec_w <> nr_seq_lote_fornec_w ) then
            nr_retorno_w := 'S';
        end if;
    end if;
end if;

return nr_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION consiste_lote_fornec ( cd_barra_material_p material_lote_fornec.cd_barra_material%type, nr_seq_processo_p adep_processo.nr_sequencia%type, cd_estabelecimento_p material_lote_fornec.cd_estabelecimento%type ) FROM PUBLIC;

