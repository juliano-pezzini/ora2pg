-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_hist_medic_controlado ( nr_movimento_estoque_p bigint, ie_endereco_p text, ie_setor_p text, ie_movimento_estoque_p text) RETURNS varchar AS $body$
DECLARE

 
cd_pessoa_fisica_w			varchar(10)	:= '';
cd_fornecedor_w				varchar(14)	:= '';
nr_documento_w				numeric(22);
nr_sequencia_item_docto_w			numeric(22);
ie_origem_documento_w			varchar(22);
cd_operacao_estoque_w			numeric(22)	:= '';
nm_fornecedor_w				varchar(250)	:= '';
ds_endereco_w				varchar(250)	:= '';
ds_resultado_w				varchar(4000)	:= '';
cd_setor_atendimento_w			integer;
ds_setor_atendimento_w			varchar(100);

 

BEGIN 
select	coalesce(cd_fornecedor,''), 
	nr_documento, 
	nr_sequencia_item_docto, 
	ie_origem_documento, 
	cd_operacao_estoque	 
into STRICT	cd_fornecedor_w, 
	nr_documento_w, 
	nr_sequencia_item_docto_w, 
	ie_origem_documento_w, 
	cd_operacao_estoque_w 
from	movimento_estoque 
where	nr_movimento_estoque	= nr_movimento_estoque_p;
 
if (ie_origem_documento_w	= '3') and (nr_documento_w IS NOT NULL AND nr_documento_w::text <> '') then 
	begin 
	/* 03/03/2004 Fabio - inclui o max no nvl */
 
	if (coalesce(nr_sequencia_item_docto_w::text, '') = '') or (nr_sequencia_item_docto_w	= 999) then 
		begin 
		select	coalesce(max(cd_pessoa_fisica), ''), 
			coalesce(max(obter_setor_atendimento(nr_atendimento)),0) 
		into STRICT	cd_pessoa_fisica_w, 
			cd_setor_atendimento_w 
		from	atendimento_paciente 
		where	nr_atendimento	= nr_documento_w;
		if (coalesce(cd_pessoa_fisica_w::text, '') = '') then 
			select	coalesce(max(cd_pessoa_fisica), ''), 
				coalesce(max(cd_setor_atendimento), 0) 
			into STRICT	cd_pessoa_fisica_w, 
				cd_setor_atendimento_w 
			from	prescr_medica 
			where	nr_prescricao	= nr_documento_w;
		end if;
		end;
	else 
		select	coalesce(max(cd_pessoa_fisica), ''), 
			coalesce(max(cd_setor_atendimento), 0) 
		into STRICT	cd_pessoa_fisica_w, 
			cd_setor_atendimento_w 
		from	prescr_medica 
		where	nr_prescricao	= nr_documento_w;
	end if;
	 
		/* Substituição Matheus OS 49104 09/02/2007 */
 
	select	est_obter_paciente_movto(nr_movimento_estoque_p), 
		obter_dados_pf_pj(cd_pessoa_fisica_w, '', 'EC') 
	into STRICT	nm_fornecedor_w, 
		ds_endereco_w 
	;
	end;
elsif 	((ie_origem_documento_w = '1') or (ie_origem_documento_w = '11')) then 
	select	obter_razao_social(cd_fornecedor_w), 
		obter_dados_pf_pj('', cd_fornecedor_w, 'EC') 
	into STRICT	nm_fornecedor_w, 
		ds_endereco_w 
	;
end if;
 
if (coalesce(ie_movimento_Estoque_p,'N') = 'S') then 
	ds_resultado_w := wheb_mensagem_pck.get_texto(309145) || ': ' || nr_movimento_estoque_p; -- Movto 
end if;
 
/* 03/03/2004 Fabio - inclui o if abaixo */
 
if (coalesce(nm_fornecedor_w::text, '') = '') and (coalesce(ds_endereco_w::text, '') = '') then 
	select	ds_operacao 
	into STRICT	nm_fornecedor_w 
	from 	operacao_estoque 
	where	cd_operacao_estoque	= cd_operacao_estoque_w;
end if;
 
ds_resultado_w	:= ds_resultado_w || ' - ' || nm_fornecedor_w;
 
if (ie_endereco_p = 'S') then 
	ds_resultado_w	:= ds_resultado_w || ' - ' || ds_endereco_w;
end if;
 
if (ie_setor_p = 'S') and (cd_setor_atendimento_w > 0) then 
	select	ds_setor_atendimento 
	into STRICT	ds_setor_atendimento_w 
	from	setor_atendimento 
	where	cd_setor_atendimento = cd_setor_atendimento_w;
 
	ds_resultado_w	:= ds_resultado_w || ' - ' || wheb_mensagem_pck.get_texto(309146) || ': ' || ds_setor_atendimento_w; -- Setor 
end if;
 
RETURN substr(ds_resultado_w,1,250);
 
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_hist_medic_controlado ( nr_movimento_estoque_p bigint, ie_endereco_p text, ie_setor_p text, ie_movimento_estoque_p text) FROM PUBLIC;

