-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION qt_obter_regra_ger_ordem_grid ( cd_material_p bigint, ie_via_aplicacao_p text, qt_dose_p bigint, cd_inidade_medida_p text) RETURNS varchar AS $body$
DECLARE


ie_retorno_w					varchar(1) := 'N';
qt_regra_w						bigint;
cd_unidade_medida_consumo_w		varchar(30);
qt_dose_w						double precision;


BEGIN
if (cd_material_p IS NOT NULL AND cd_material_p::text <> '')	and (ie_via_aplicacao_p IS NOT NULL AND ie_via_aplicacao_p::text <> '')	and (qt_dose_p IS NOT NULL AND qt_dose_p::text <> '')	and (cd_inidade_medida_p IS NOT NULL AND cd_inidade_medida_p::text <> '') then
    qt_dose_w	:=	qt_dose_p;


    select 	max(cd_unidade_medida_consumo)
    into STRICT	cd_unidade_medida_consumo_w
    from	material
    where 	cd_material	=	cd_material_p;

    if (cd_inidade_medida_p <> cd_unidade_medida_consumo_w) then
    	qt_dose_w	:=	(Obter_dose_convertida_quimio(cd_material_p, qt_dose_p, cd_inidade_medida_p, cd_unidade_medida_consumo_w));
    end if;


    select 	count(*)
    into STRICT	qt_regra_w
    from	regra_geracao_ord_chegada;

    if (qt_regra_w > 0) then

    	select 	coalesce(max('S'),'N')
    	into STRICT	ie_retorno_w
    	from	regra_geracao_ord_chegada
    	where	cd_material = cd_material_p
    	and		coalesce(ie_via_aplicacao,ie_via_aplicacao_p) = ie_via_aplicacao_p
    	and		coalesce(qt_dose, qt_dose_w + 1) <= qt_dose_w;
    end if;
end if;

return	ie_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION qt_obter_regra_ger_ordem_grid ( cd_material_p bigint, ie_via_aplicacao_p text, qt_dose_p bigint, cd_inidade_medida_p text) FROM PUBLIC;

