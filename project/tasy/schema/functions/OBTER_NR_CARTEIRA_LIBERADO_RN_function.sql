-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_nr_carteira_liberado_rn (nr_atendimento_p bigint, cd_usuario_conv_p text, nr_atendimento_mae_p bigint, cd_convenio_p bigint) RETURNS varchar AS $body$
DECLARE

 
ie_possui_ref_w 		varchar(2) := 'N';
qt_dias_nasc_w	 		bigint;
nr_atendimento_mae_w	 	varchar(10);
cd_paciente_w			varchar(10);
ie_possui_ref_mae_w		varchar(2);

BEGIN
 
select	max(nr_atendimento_mae) 
into STRICT	nr_atendimento_mae_w 
from	atendimento_paciente 
where	nr_atendimento = nr_atendimento_p;
 
if ((coalesce(nr_atendimento_mae_w::text, '') = '') or (nr_atendimento_mae_w <> nr_atendimento_mae_p)) then 
	 
	select max(cd_pessoa_fisica) 
		into STRICT	cd_paciente_w 
		from	atendimento_paciente 
		where	nr_atendimento = nr_atendimento_p;
	 
	Select 	Trunc(obter_idade_pf(cd_paciente_w,clock_timestamp(),'DIA'),0) 
	into STRICT 	qt_dias_nasc_w 
	;
	 
	if (qt_dias_nasc_w <= 30) then 
		 
		select 	CASE WHEN count(*)=0 THEN 'N'  ELSE 'S' END  
		into STRICT	ie_possui_ref_w 
		from	pessoa_fisica a 
		where	a.cd_pessoa_fisica = cd_paciente_w 
		and	(a.cd_pessoa_mae IS NOT NULL AND a.cd_pessoa_mae::text <> '') 
		and	exists ( SELECT	1 
				from	atendimento_paciente x, 
					atend_categoria_convenio z 
				where	x.cd_pessoa_fisica 	= a.cd_pessoa_mae 
				and	x.nr_atendimento  	= z.nr_atendimento 
				and	z.cd_usuario_convenio	= cd_usuario_conv_p 
				and 	z.cd_convenio		= cd_convenio_p);
		 
		if (ie_possui_ref_w = 'N') then 
		 
			select 	CASE WHEN count(*)=0 THEN 'N'  ELSE 'S' END  
			into STRICT	ie_possui_ref_w 
			from	compl_pessoa_fisica a 
			where	a.cd_pessoa_fisica = cd_paciente_w 
			and	a.ie_tipo_complemento in ('4','5') 
			and	exists ( SELECT	1 
					from	atendimento_paciente x, 
						atend_categoria_convenio z 
					where	x.cd_pessoa_fisica 	= a.cd_pessoa_fisica_ref 
					and	x.nr_atendimento  	= z.nr_atendimento 
					and	z.cd_usuario_convenio	= cd_usuario_conv_p 
					and 	z.cd_convenio		= cd_convenio_p);
		end if;
	 
	end if;
end if;
		 
return	ie_possui_ref_w;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_nr_carteira_liberado_rn (nr_atendimento_p bigint, cd_usuario_conv_p text, nr_atendimento_mae_p bigint, cd_convenio_p bigint) FROM PUBLIC;

