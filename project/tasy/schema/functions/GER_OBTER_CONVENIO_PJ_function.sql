-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION ger_obter_convenio_pj (nr_atendimento_p bigint) RETURNS bigint AS $body$
DECLARE


cd_tipo_empresa_w	pessoa_juridica.cd_tipo_pessoa%type;
cd_pessoa_fisica_w	episodio_paciente.cd_pessoa_fisica%type;
cd_cgc_w		compl_pessoa_fisica.cd_cgc%type;
cd_convenio_w		convenio_empresa.cd_convenio%type := 0;
nr_tipo_admissao_fat_w	atendimento_paciente.nr_seq_tipo_admissao_fat%type;
residence_c		constant smallint := 1;



BEGIN

if (nr_atendimento_p IS NOT NULL AND nr_atendimento_p::text <> '') then

	select	max(ap.cd_pessoa_fisica),
		max(ap.nr_seq_tipo_admissao_fat)
	into STRICT	cd_pessoa_fisica_w,
		nr_tipo_admissao_fat_w
	from	atendimento_paciente ap
	where	ap.nr_atendimento = nr_atendimento_p;
	
	select	max(pfe.cd_cgc)
	into STRICT	cd_cgc_w
	from	pessoa_fisica_empregador pfe,
		atendimento_paciente ap
	where	pfe.cd_pessoa_fisica = cd_pessoa_fisica_w
	and	pfe.cd_pessoa_fisica = ap.cd_pessoa_fisica
	and	ap.nr_atendimento = nr_atendimento_p
	and (ap.dt_entrada between pfe.dt_inicio_trabalho and pfe.dt_fim_trabalho or (ap.dt_entrada >= pfe.dt_inicio_trabalho and coalesce(pfe.dt_fim_trabalho::text, '') = ''));

	if (cd_cgc_w IS NOT NULL AND cd_cgc_w::text <> '') then

		select	max(pj.cd_tipo_pessoa)
		into STRICT	cd_tipo_empresa_w
		from	pessoa_juridica pj
		where	pj.cd_cgc = cd_cgc_w;

		select	max(ce.cd_convenio)
		into STRICT	cd_convenio_w
		from	convenio_empresa ce
		where	ce.cd_tipo_pessoa = cd_tipo_empresa_w
		and	ce.nr_seq_tipo_admissao_fat = nr_tipo_admissao_fat_w;

	end if;
end if;

if (coalesce(cd_convenio_w::text, '') = '') then
	cd_convenio_w := 0;
end if;

return cd_convenio_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION ger_obter_convenio_pj (nr_atendimento_p bigint) FROM PUBLIC;

