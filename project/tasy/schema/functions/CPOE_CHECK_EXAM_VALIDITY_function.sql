-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION cpoe_check_exam_validity ( nr_seq_proc_interno_p cpoe_procedimento.nr_seq_proc_interno%type, dt_inicio_exame_p timestamp, dt_fim_exame_p timestamp ) RETURNS varchar AS $body$
DECLARE


ie_existe_w   integer;


BEGIN

select count(*)
into STRICT ie_existe_w
from proc_interno a, exame_laboratorio b, EXAME_LAB_VALIDADE c
where a.nr_sequencia =  nr_seq_proc_interno_p
and a.nr_seq_exame_lab = b.nr_seq_exame
and b.nr_seq_exame = c.nr_seq_exame_lab;

IF ie_existe_w > 0
THEN

	select
	count(*) into STRICT ie_existe_w
	FROM proc_interno a, exame_laboratorio b
LEFT OUTER JOIN exame_lab_validade c ON (b.nr_seq_exame = c.nr_seq_exame_lab)
WHERE a.nr_sequencia =  nr_seq_proc_interno_p and a.nr_seq_exame_lab = b.nr_seq_exame  and dt_inicio_exame_p between c.dt_inicio_vigencia and fim_dia(c.dt_fim_vigencia);
	
	IF ie_existe_w > 0
	then
		return 'S';
	else
		return 'N';
	end if;

ELSE
	return 'S';

END IF;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION cpoe_check_exam_validity ( nr_seq_proc_interno_p cpoe_procedimento.nr_seq_proc_interno%type, dt_inicio_exame_p timestamp, dt_fim_exame_p timestamp ) FROM PUBLIC;

